/******/ (() => { // webpackBootstrap
/******/ 	var __webpack_modules__ = ({

/***/ 772:
/***/ (() => {

/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
 
(function () {
  var global = this || globalThis;
  var connect = global.connect || {};
  global.connect = connect;
  global.globalConnect = {}
  global.lily = connect;

  globalConnect.Container = null;

  var FRAME_DIMENSIONS = "margin: 0; border: 0; padding: 0px; width: 0px; height: 0px";

  var LATEST_STREAMJS_BASE64_CODE = "LyoqKioqKi8gKCgpID0+IHsgLy8gd2VicGFja0Jvb3RzdHJhcAovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVzX18gPSAoewoKLyoqKi8gODIxOgovKioqLyAoKCkgPT4gewoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5hZ2VudEFwcCA9IHt9OwoKICB2YXIgQVBQID0gewogICAgQ0NQOiAnY2NwJywKICB9OwoKICBjb25uZWN0LmFnZW50QXBwLmluaXRDQ1AgPSBjb25uZWN0LmNvcmUuaW5pdENDUDsKICBjb25uZWN0LmFnZW50QXBwLmlzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoaW5zdGFuY2VBbGlhcykge307CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcENvbW11bmljYXRpb24gPSBmdW5jdGlvbiAoaWZyYW1lSWQsIGVuZHBvaW50KSB7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWZyYW1lSWQpOwogICAgdmFyIGlmcmFtZUNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KGVuZHBvaW50LCB3aW5kb3csIGlmcmFtZSk7CiAgICB2YXIgQlJPQURDQVNUX1RZUEUgPSBbCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsCiAgICAgIGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsCiAgICAgIGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVECiAgICBdOwogICAgaWZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoZSkgewogICAgICBCUk9BRENBU1RfVFlQRS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbSh0eXBlLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWZyYW1lQ29uZHVpdC5zZW5kVXBzdHJlYW0odHlwZSwgZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIGdldENvbm5lY3RVcmwgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgcG9zID0gY2NwVXJsLmluZGV4T2YoJ2NjcC12MicpOwogICAgcmV0dXJuIGNjcFVybC5zbGljZSgwLCBwb3MgLSAxKTsKICB9OwoKICB2YXIgc2lnbk91dFRocm91Z2hDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgbG9nb3V0VXJsID0gZ2V0Q29ubmVjdFVybChjY3BVcmwpICsgJy9sb2dvdXQnOwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2gobG9nb3V0VXJsLCB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGV2ZW50QnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25uZWN0CiAgICAgICAgLmdldExvZygpCiAgICAgICAgLmVycm9yKCdBbiBlcnJvciBvY2N1cmVkIG9uIGxvZ291dC4nICsgZSkKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBsb2dvdXRVcmw7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogIH07CgogIHZhciBzaWduSW5UaHJvdWdoaW5pdENDUCA9IGZ1bmN0aW9uIChjY3BVcmwsIGNvbnRhaW5lciwgY29uZmlnKSB7CiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgY2NwVXJsOiBjY3BVcmwsCiAgICAgIGNjcExvYWRUaW1lb3V0OiAxMDAwMCwKICAgICAgbG9naW5Qb3B1cDogdHJ1ZSwKICAgICAgbG9naW5Vcmw6IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9naW4nLAogICAgICBzb2Z0cGhvbmU6IHsKICAgICAgICBhbGxvd0ZyYW1lZFNvZnRwaG9uZTogdHJ1ZSwKICAgICAgICBkaXNhYmxlUmluZ3RvbmU6IGZhbHNlLAogICAgICB9CiAgICB9OwogICAgdmFyIGNjcFBhcmFtcyA9IGNvbm5lY3QubWVyZ2UoZGVmYXVsdFBhcmFtcywgY29uZmlnLmNjcFBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENDUChjb250YWluZXIsIGNjcFBhcmFtcyk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwID0gZnVuY3Rpb24gKG5hbWUsIGNvbnRhaW5lcklkLCBhcHBVcmwsIGNvbmZpZykgewogICAgY29uZmlnID0gY29uZmlnID8gY29uZmlnIDoge307CiAgICB2YXIgZW5kcG9pbnQgPSBhcHBVcmwuZW5kc1dpdGgoJy8nKSA/IGFwcFVybCA6IGFwcFVybCArICcvJzsKICAgIHZhciBvbkxvYWQgPSBjb25maWcub25Mb2FkID8gY29uZmlnLm9uTG9hZCA6IG51bGw7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSwgb25Mb2FkOiBvbkxvYWQgfTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgcmVnaXN0ZXJDb25maWcsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKSk7CiAgICBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0YXJ0KG5hbWUsIGZ1bmN0aW9uIChtb2R1bGVEYXRhKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGEuZW5kcG9pbnQ7CiAgICAgIHZhciBjb250YWluZXJET00gPSBtb2R1bGVEYXRhLmNvbnRhaW5lckRPTTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgewogICAgICAgICAgICBjb25maWcuY2NwUGFyYW1zID0gY29uZmlnLmNjcFBhcmFtcyA/IGNvbmZpZy5jY3BQYXJhbXMgOiB7fTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5zdHlsZSkgY29uZmlnLmNjcFBhcmFtcy5zdHlsZSA9IGNvbmZpZy5zdHlsZTsKICAgICAgICAgICAgcmV0dXJuIHNpZ25JblRocm91Z2hpbml0Q0NQKGVuZHBvaW50LCBjb250YWluZXJET00sIGNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbihuYW1lLCBlbmRwb2ludCk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25PdXRUaHJvdWdoQ0NQKGVuZHBvaW50KTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuc3RvcEFwcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5zdG9wKG5hbWUpOwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA1MDA6Ci8qKiovICgoKSA9PiB7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGZ1bmN0aW9uIEFwcFJlZ2lzdHJ5KCkgewogICAgdmFyIG1vZHVsZURhdGEgPSB7fTsKICAgIHZhciBtYWtlQXBwSWZyYW1lID0gZnVuY3Rpb24gKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgICBvbkxvYWQ6IGNvbmZpZy5vbkxvYWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICB2YXIgb25Mb2FkID0gbW9kdWxlRGF0YVthcHBOYW1lXS5vbkxvYWQ7CiAgICAgICAgaWYgKGFwcE5hbWUgIT09IEFQUC5DQ1ApIHsKICAgICAgICAgIHZhciBhcHAgPSBtYWtlQXBwSWZyYW1lKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTY1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0ludmFsaWRMb2NhbGUnLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcKICBdKTsKICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0dXNUeXBlID0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3Quc2V0KFsKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xECiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgICAnZGlzY29ubmVjdCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ29udGFjdFJlY29yZGluZyBWb2ljZSBUcmFjayBjb25maWcKICAgKi8KICBjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnQUxMJywKICAgICdUT19BR0VOVCcsCiAgICAnRlJPTV9BR0VOVCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgTW9uaXRvcmluZ01vZGUKICAgKi8KICBjb25uZWN0Lk1vbml0b3JpbmdNb2RlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnU0lMRU5UX01PTklUT1InLAogICAgJ0JBUkdFJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBNb25pdG9yaW5nRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuTW9uaXRvcmluZ0Vycm9yVHlwZXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbnZhbGlkX3RhcmdldF9zdGF0ZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENoYW5uZWxUeXBlCiAgKi8KICBjb25uZWN0LkNoYW5uZWxUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnVk9JQ0UnLAogICAgJ0NIQVQnLAogICAgJ1RBU0snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBNZWRpYVR5cGUKICAqLwogIGNvbm5lY3QuTWVkaWFUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnc29mdHBob25lJywKICAgICdjaGF0JywKICAgICd0YXNrJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNvZnRwaG9uZUNhbGxUeXBlCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2F1ZGlvX3ZpZGVvJywKICAgICd2aWRlb19vbmx5JywKICAgICdhdWRpb19vbmx5JywKICAgICdub25lJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBTb2Z0cGhvbmVFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndW5zdXBwb3J0ZWRfYnJvd3NlcicsCiAgICAnbWljcm9waG9uZV9ub3Rfc2hhcmVkJywKICAgICdzaWduYWxsaW5nX2hhbmRzaGFrZV9mYWlsdXJlJywKICAgICdzaWduYWxsaW5nX2Nvbm5lY3Rpb25fZmFpbHVyZScsCiAgICAnaWNlX2NvbGxlY3Rpb25fdGltZW91dCcsCiAgICAndXNlcl9idXN5X2Vycm9yJywKICAgICd3ZWJydGNfZXJyb3InLAogICAgJ3JlYWx0aW1lX2NvbW11bmljYXRpb25fZXJyb3InLAogICAgJ290aGVyJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDbGlja1R5cGUKICAgKi8KICBjb25uZWN0LkNsaWNrVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ0FjY2VwdCcsCiAgICAnUmVqZWN0JywKICAgICdIYW5ndXAnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWRFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ25vX3NwZWFrZXJfaWRfZm91bmQnLAogICAgJ3NwZWFrZXJfaWRfbm90X2Vucm9sbGVkJywKICAgICdnZXRfc3BlYWtlcl9pZF9mYWlsZWQnLAogICAgJ2dldF9zcGVha2VyX3N0YXR1c19mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9pbl9sY21zX2ZhaWxlZCcsCiAgICAnZGVsZXRlX3NwZWFrZXJfZmFpbGVkJywKICAgICdzdGFydF9zZXNzaW9uX2ZhaWxlZCcsCiAgICAnZXZhbHVhdGVfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3Nlc3Npb25fbm90X2V4aXN0cycsCiAgICAnZGVzY3JpYmVfc2Vzc2lvbl9mYWlsZWQnLAogICAgJ2Vucm9sbF9zcGVha2VyX2ZhaWxlZCcsCiAgICAndXBkYXRlX3NwZWFrZXJfaWRfZmFpbGVkJywKICAgICd1cGRhdGVfc3BlYWtlcl9pZF9pbl9sY21zX2ZhaWxlZCcsCiAgICAnbm90X3N1cHBvcnRlZF9vbl9jb25mZXJlbmNlX2NhbGxzJywKICAgICdlbnJvbGxfc3BlYWtlcl90aW1lb3V0JywKICAgICdldmFsdWF0ZV9zcGVha2VyX3RpbWVvdXQnLAogICAgJ2dldF9kb21haW5faWRfZmFpbGVkJywKICAgICdub19kb21haW5faWRfZm91bmQnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIENUSSBleGNlcHRpb25zCiAgICovCiAgY29ubmVjdC5DVElFeGNlcHRpb25zID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQWNjZXNzRGVuaWVkRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkU3RhdGVFeGNlcHRpb24iLAogICAgIkJhZEVuZHBvaW50RXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQWdlbnRBUk5FeGNlcHRpb24iLAogICAgIkludmFsaWRDb25maWd1cmF0aW9uRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQ29udGFjdFR5cGVFeGNlcHRpb24iLAogICAgIlBhZ2luYXRpb25FeGNlcHRpb24iLAogICAgIlJlZnJlc2hUb2tlbkV4cGlyZWRFeGNlcHRpb24iLAogICAgIlNlbmREYXRhRmFpbGVkRXhjZXB0aW9uIiwKICAgICJVbmF1dGhvcml6ZWRFeGNlcHRpb24iLAogICAgIlF1b3RhRXhjZWVkZWRFeGNlcHRpb24iCiAgXSk7CiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBzdHJlYW1pbmcgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiT05HT0lORyIsCiAgICAiRU5ERUQiLAogICAgIlBFTkRJTkdfQ09ORklHVVJBVElPTiIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBQ0NFUFQiLAogICAgIlJFSkVDVCIsCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIlNQRUFLRVJfTk9UX0VOUk9MTEVEIiwKICAgICJTUEVBS0VSX09QVEVEX09VVCIsCiAgICAiU1BFQUtFUl9JRF9OT1RfUFJPVklERUQiLAogICAgIlNQRUFLRVJfRVhQSVJFRCIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBmcmF1ZCBkZXRlY3Rpb24gZGVjaXNpb24KICAgKi8KICBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIkhJR0hfUklTSyIsCiAgICAiTE9XX1JJU0siCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIGNvbnRhY3QgZmxvdyBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQXV0aGVudGljYXRlZCIsCiAgICAiTm90QXV0aGVudGljYXRlZCIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbnJvbGxlZCIsCiAgICAiT3B0ZWRPdXQiLAogICAgIk5vdEVuYWJsZWQiLAogICAgIkVycm9yIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgIGZyYXVkIGRldGVjdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiSGlnaFJpc2siLAogICAgIkxvd1Jpc2siLAogICAgIkluY29uY2x1c2l2ZSIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgRW5yb2xsbWVudFJlcXVlc3QgU3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSU5fUFJPR1JFU1MiLAogICAgIkNPTVBMRVRFRCIsCiAgICAiRkFJTEVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIFNwZWFrZXIgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9QVEVEX09VVCIsCiAgICAiRU5ST0xMRUQiLAogICAgIlBFTkRJTkciCiAgXSk7CgogIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cyA9IHsKICAgIEVWQUxVQVRFX1NFU1NJT05fREVMQVk6IDEwMDAwLAogICAgRVZBTFVBVElPTl9NQVhfUE9MTF9USU1FUzogMjQsIC8vIEV2YWx1YXRlU3BlYWtlciBpcyBQb2xsaW5nIGZvciBtYXhpbXVtIDIgbWlucy4KICAgIEVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTDogNTAwMCwKICAgIEVOUk9MTE1FTlRfTUFYX1BPTExfVElNRVM6IDEyMCwgLy8gRW5yb2xsbWVudFNwZWFrZXIgaXMgUG9sbGluZyBmb3IgbWF4aW11bSAxMCBtaW5zLgogICAgRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMOiA1MDAwLAogICAgU1RBUlRfU0VTU0lPTl9ERUxBWTogODAwMAogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29uc3RhbnRzIGZvciBBZ2VudFBlcm1pc3Npb25zCiAgICovCiAgY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zID0gewogICAgT1VUQk9VTkRfQ0FMTDogJ291dGJvdW5kQ2FsbCcsCiAgICBWT0lDRV9JRDogJ3ZvaWNlSWQnLAogICAgQ09OVEFDVF9SRUNPUkRJTkc6ICdjb250YWN0UmVjb3JkaW5nJwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50CiAgICovCiAgdmFyIEFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoIlRoZSBhZ2VudCBpcyBub3QgeWV0IGluaXRpYWxpemVkISIpOwogICAgfQogIH07CgogIEFnZW50LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2NyZWF0ZUNvbnRhY3RBUEkgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUmVmcmVzaCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUm91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Ob3RSb3V0YWJsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25PZmZsaW5lID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNvZnRwaG9uZUVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25HYWluZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25BZnRlckNhbGxXb3JrID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1csIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Mb2NhbE1lZGlhU3RyZWFtQ3JlYXRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNwZWFrZXJEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbk1pY3JvcGhvbmVEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vblJpbmdlckRldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5zdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmV4dFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5uZXh0U3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEF2YWlsYWJpbGl0eVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5hZ2VudEF2YWlsYWJpbGl0eVN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc25hcHNob3Quc3RhdGUuc3RhcnRUaW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQWdlbnQucHJvdG90eXBlLmdldFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnBlcm1pc3Npb25zOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb250YWN0cyA9IGZ1bmN0aW9uIChjb250YWN0VHlwZUZpbHRlcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5jb250YWN0cy5tYXAoZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVDb250YWN0QVBJKGNvbnRhY3REYXRhKTsKICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gKCFjb250YWN0VHlwZUZpbHRlcikgfHwgY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbnRhY3RUeXBlRmlsdGVyOwogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbmZpZ3VyYXRpb247CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFnZW50U3RhdGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmFnZW50U3RhdGVzOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5ID0gZnVuY3Rpb24gKGNoYW5uZWwpIHsKICAgIHZhciBjaGFubmVsQ29uY3VycmVuY3lNYXAgPSB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuY2hhbm5lbENvbmN1cnJlbmN5TWFwOwogICAgaWYgKCFjaGFubmVsQ29uY3VycmVuY3lNYXApIHsKICAgICAgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gT2JqZWN0LmtleXMoY29ubmVjdC5DaGFubmVsVHlwZSkucmVkdWNlKGZ1bmN0aW9uIChhY2MsIGtleSkgewogICAgICAgIC8vIEV4Y2x1ZGUgVEFTSyBmcm9tIGRlZmF1bHQgY29uY3VycmVuY3kuCiAgICAgICAgaWYgKGtleSAhPT0gJ1RBU0snKSB7CiAgICAgICAgICBhY2NbY29ubmVjdC5DaGFubmVsVHlwZVtrZXldXSA9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhY2M7CiAgICAgIH0sIHt9KTsKICAgIH0KICAgIHJldHVybiBjaGFubmVsCiAgICAgID8gKGNoYW5uZWxDb25jdXJyZW5jeU1hcFtjaGFubmVsXSB8fCAwKQogICAgICA6IGNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5uYW1lOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFeHRlbnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZXh0ZW5zaW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXREaWFsYWJsZUNvdW50cmllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5kaWFsYWJsZUNvdW50cmllczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuaXNTb2Z0cGhvbmVFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUVuYWJsZWQ7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgaWYgKGNvbmZpZ3VyYXRpb24gJiYgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzICYmIGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRSAmJiAhY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSkgewogICAgICAvLyB3b3JrYXJvdW5kIGZvciB0aGUgaW5jb25zaXN0ZW5jeSBpc3N1ZSB0aGF0IGdldEFnZW50Q29uZmlndXJhdGlvbiByZXR1cm5zIGFnZW50UHJlZmVyZW5jZXMuTEFOR1VBR0UgYnV0IHVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiBleHBlY3RzIGFnZW50UHJlZmVyZW5jZXMubG9jYWxlIHRvIGJlIHNldC4KICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSA9IGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRTsKICAgIH0KCiAgICBpZiAoY29uZmlndXJhdGlvbiAmJiBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMgJiYgIWNvbm5lY3QuaXNWYWxpZExvY2FsZShjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMubG9jYWxlKSkgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzLklOVkFMSURfTE9DQUxFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OLCB7CiAgICAgICAgY29uZmlndXJhdGlvbjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmZpZ3VyYXRpb24sICdjb25maWd1cmF0aW9uJykKICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBhc2sgdGhlIHNoYXJlZCB3b3JrZXIgdG8gcmVsb2FkIGFnZW50IGNvbmZpZwogICAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjYWxsYmFja3MsIG9wdGlvbnMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUFVUX0FHRU5UX1NUQVRFLCB7CiAgICAgIHN0YXRlOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3RhdGUsICdzdGF0ZScpLAogICAgICBlbnF1ZXVlTmV4dFN0YXRlOiBvcHRpb25zICYmICEhb3B0aW9ucy5lbnF1ZXVlTmV4dFN0YXRlCiAgICB9LCBjYWxsYmFja3MpOwogIH07CiAgQWdlbnQucHJvdG90eXBlLm9uRW5xdWV1ZWROZXh0U3RhdGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVOUVVFVUVEX05FWFRfU1RBVEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5jb25uZWN0ID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIHBhcmFtcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfT1VUQk9VTkRfQ09OVEFDVCwgewogICAgICBlbmRwb2ludDogY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKSwKICAgICAgcXVldWVBUk46IChwYXJhbXMgJiYgKHBhcmFtcy5xdWV1ZUFSTiB8fCBwYXJhbXMucXVldWVJZCkpIHx8IHRoaXMuZ2V0Um91dGluZ1Byb2ZpbGUoKS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTgogICAgfSwgcGFyYW1zICYmIHsKICAgICAgICBzdWNjZXNzOiBwYXJhbXMuc3VjY2VzcywKICAgICAgICBmYWlsdXJlOiBwYXJhbXMuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWxsUXVldWVBUk5zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5tYXAoZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgIHJldHVybiBxdWV1ZS5xdWV1ZUFSTjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFbmRwb2ludHMgPSBmdW5jdGlvbiAocXVldWVBUk5zLCBjYWxsYmFja3MsIHBhZ2VJbmZvSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLCAiY2FsbGJhY2tzIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLnN1Y2Nlc3MsICJjYWxsYmFja3Muc3VjY2VzcyIpOwogICAgdmFyIHBhZ2VJbmZvID0gcGFnZUluZm9JbiB8fCB7IH07CgogICAgcGFnZUluZm8uZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzIHx8IFtdOwogICAgcGFnZUluZm8ubWF4UmVzdWx0cyA9IHBhZ2VJbmZvLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgYWxsb3dpbmcgYSBzaW5nbGUgcXVldWVBUk4gdG8gYmUgc3BlY2lmaWVkCiAgICAvLyBpbnN0ZWFkIG9mIGFuIGFycmF5LgogICAgaWYgKCFjb25uZWN0LmlzQXJyYXkocXVldWVBUk5zKSkgewogICAgICBxdWV1ZUFSTnMgPSBbcXVldWVBUk5zXTsKICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0VORFBPSU5UUywgewogICAgICBxdWV1ZUFSTnM6IHF1ZXVlQVJOcywKICAgICAgbmV4dFRva2VuOiBwYWdlSW5mby5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFnZUluZm8ubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5nZXRFbmRwb2ludHMocXVldWVBUk5zLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMsCiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5jb25jYXQoZGF0YS5lbmRwb2ludHMpOwogICAgICAgICAgICB2YXIgZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHsKICAgICAgICAgICAgICBlbmRwb2ludHM6IGVuZHBvaW50cywKICAgICAgICAgICAgICBhZGRyZXNzZXM6IGVuZHBvaW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZGRyZXNzZXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzOwoKICAvL0ludGVybmFsIGlkZW50aWZpZXIuCiAgQWdlbnQucHJvdG90eXBlLl9nZXRSZXNvdXJjZUlkID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcXVldWVBcm5zID0gdGhpcy5nZXRBbGxRdWV1ZUFSTnMoKTsKICAgIGZvciAobGV0IHF1ZXVlQXJuIG9mIHF1ZXVlQXJucykgewogICAgICBjb25zdCBhZ2VudElkTWF0Y2ggPSBxdWV1ZUFybi5tYXRjaCgvXC9hZ2VudFwvKFteL10rKS8pOwoKICAgICAgaWYgKGFnZW50SWRNYXRjaCkgewogICAgICAgIHJldHVybiBhZ2VudElkTWF0Y2hbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgRXJyb3IoIkFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZDogcXVldWVBcm5zIGRpZCBub3QgY29udGFpbiBhZ2VudFJlc291cmNlSWQ6ICIsIHF1ZXVlQXJucyk7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5BZ2VudFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRTbmFwc2hvdAogICAqLwogIHZhciBBZ2VudFNuYXBzaG90ID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgY29ubmVjdC5BZ2VudC5jYWxsKHRoaXMpOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAgfTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWdlbnQucHJvdG90eXBlKTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50U25hcHNob3Q7CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0CiAgICovCiAgdmFyIENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgdGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkluY29taW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0aW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbk1pc3NlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVuZGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKSwgZik7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BQ1cgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUiksIGYpOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsQ29udGFjdElkOwogIH07CiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbnRhY3RJZCA9IENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3REdXJhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RHVyYXRpb247CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZVRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWVUaW1lc3RhbXA7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbm5lY3Rpb25zLm1hcChmdW5jdGlvbiAoY29ubkRhdGEpIHsKICAgICAgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCk7CiAgICB9KSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFjdGl2ZUluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYWxDb25uID0gdGhpcy5nZXRJbml0aWFsQ29ubmVjdGlvbigpOwogICAgaWYgKGluaXRpYWxDb25uICE9IG51bGwgJiYgaW5pdGlhbENvbm4uaXNBY3RpdmUoKSkgewogICAgICByZXR1cm4gaW5pdGlhbENvbm47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gIWNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpICYmIGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U2luZ2xlQWN0aXZlVGhpcmRQYXJ0eUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgIH0pWzBdIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWdlbnRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHZhciBjb25uVHlwZSA9IGNvbm4uZ2V0VHlwZSgpOwogICAgICByZXR1cm4gY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgfHwgY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm5hbWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdE1ldGFkYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0TWV0YWRhdGE7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXREZXNjcmlwdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZGVzY3JpcHRpb247CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UmVmZXJlbmNlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucmVmZXJlbmNlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5hdHRyaWJ1dGVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdEZlYXR1cmVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENoYW5uZWxDb250ZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jaGFubmVsQ29udGV4dDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc1NvZnRwaG9uZUNhbGwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U29mdHBob25lTWVkaWFJbmZvKCkgIT0gbnVsbDsKICAgIH0pICE9IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuX2lzSW5ib3VuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbml0aWF0aW9uTWV0aG9kID0gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYXRpb25NZXRob2Q7CiAgICByZXR1cm4gKGluaXRpYXRpb25NZXRob2QgPT09IGNvbm5lY3QuQ29udGFjdEluaXRpYXRpb25NZXRob2QuT1VUQk9VTkQpID8gZmFsc2UgOiB0cnVlOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuaXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm4gPSB0aGlzLmdldEluaXRpYWxDb25uZWN0aW9uKCk7CgogICAgLy8gV2Ugd2lsbCBncmFkdWFsbHkgY2hhbmdlIGNoZWNraW5nIGluYm91bmQgYnkgcmVseWluZyBvbiBjb250YWN0IGluaXRpYXRpb25NZXRob2QKICAgIGlmIChjb25uLmdldE1lZGlhVHlwZSgpID09PSBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiB0aGlzLl9pc0luYm91bmQoKTsKICAgIH0KCiAgICByZXR1cm4gY29ubiA/IGNvbm4uZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLklOQk9VTkQgOiBmYWxzZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWNjZXB0ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjb250YWN0SWQgPSB0aGlzLmdldENvbnRhY3RJZCgpOwoKICAgIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2xpY2tUeXBlOiBjb25uZWN0LkNsaWNrVHlwZS5BQ0NFUFQsCiAgICAgIGNsaWNrVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICB9KTsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQUNDRVBUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIHNlbGYuZ2V0Q29udGFjdElkKCkpLAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEluIEZpcmVmb3gsIHRoZXJlJ3MgYSBicm93c2VyIHJlc3RyaWN0aW9uIHRoYXQgYW4gdW5mb2N1c2VkIGJyb3dzZXIgdGFiIGlzIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICAvLyBUaGUgcHJvYmxlbSBpcyB0aGF0IHRoZSByZXN0cmljdGlvbiBjb3VsZCBjYXVzZSBhIHdlYnJ0YyBzZXNzaW9uIGNyZWF0aW9uIHRpbWVvdXQgZXJyb3Igd2hlbiB5b3UgZ2V0IGFuIGluY29taW5nIGNhbGwgd2hpbGUgeW91IGFyZSBub3Qgb24gdGhlIHByaW1hcnkgdGFiLgogICAgICAgICAgLy8gSXQgd2FzIGhhcmQgdG8gd29ya2Fyb3VuZCB0aGUgaXNzdWUgZXNwZWNpYWxseSB3aGVuIHlvdSBoYXZlIG11bHRpcGxlIHRhYnMgb3BlbiBiZWNhdXNlIHlvdSBuZWVkZWQgdG8gZmluZCB0aGUgcmlnaHQgdGFiIGFuZCBhY2NlcHQgdGhlIGNvbnRhY3QgYmVmb3JlIHRoZSB0aW1lb3V0LgogICAgICAgICAgLy8gVG8gYXZvaWQgdGhlIGVycm9yLCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4gaW4gRmlyZWZveCwgYSB3ZWJydGMgc2Vzc2lvbiBpcyBub3QgaW1tZWRpYXRlbHkgY3JlYXRlZCBhcyBhbiBpbmNvbWluZyBzb2Z0cGhvbmUgY29udGFjdCBpcyBkZXRlY3RlZC4KICAgICAgICAgIC8vIEluc3RlYWQsIGl0IHdhaXRzIHVudGlsIGNvbnRhY3QuYWNjZXB0KCkgaXMgY2FsbGVkIG9uIGEgdGFiIGFuZCBsZXRzIHRoZSB0YWIgYmVjb21lIHRoZSBuZXcgcHJpbWFyeSB0YWIgYW5kIHN0YXJ0IHRoZSB3ZWIgcnRjIHNlc3Npb24gdGhlcmUKICAgICAgICAgIC8vIGJlY2F1c2UgdGhlIHRhYiBzaG91bGQgYmUgZm9jdXNlZCBhdCB0aGUgbW9tZW50IGFuZCBoYXZlIGFjY2VzcyB0byB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICB2YXIgY29udGFjdCA9IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKTsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcyA/IGNhbGxiYWNrcy5mYWlsdXJlIDogbnVsbAogICAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJjb250YWN0LmRlc3Ryb3koKSBoYXMgYmVlbiBkZXByZWNhdGVkLiIpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjbGlja1R5cGU6IGNvbm5lY3QuQ2xpY2tUeXBlLlJFSkVDVCwKICAgICAgY2xpY2tUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH0pOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY29tcGxldGUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DTEVBUl9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5ub3RpZnlJc3N1ZSA9IGZ1bmN0aW9uIChpc3N1ZUNvZGUsIGRlc2NyaXB0aW9uLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTk9USUZZX0NPTlRBQ1RfSVNTVUUsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBpc3N1ZUNvZGU6IGlzc3VlQ29kZSwKICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmFkZENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoZW5kcG9pbnRJbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGVuZHBvaW50ID0gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnRJbik7CiAgICAvLyBIYXZlIHRvIHJlbW92ZSB0aGUgZW5kcG9pbnRJZCBmaWVsZCBvciBBV1MgSlMgU0RLIGdldHMgbWFkLgogICAgZGVsZXRlIGVuZHBvaW50LmVuZHBvaW50SWQ7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9BRERJVElPTkFMX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBlbmRwb2ludDogZW5kcG9pbnQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUudG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB2YXIgaG9sZGluZ0Nvbm4gPSBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICAgIH0pOwoKICAgIGlmIChob2xkaW5nQ29ubiAhPSBudWxsKSB7CiAgICAgIGNvbm5lY3Rpb25JZCA9IGhvbGRpbmdDb25uLmdldENvbm5lY3Rpb25JZCgpOwoKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhY3RpdmVDb25ucyA9IHRoaXMuZ2V0Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgICByZXR1cm4gY29ubi5pc0FjdGl2ZSgpOwogICAgICB9KTsKICAgICAgaWYgKGFjdGl2ZUNvbm5zLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25uZWN0aW9uSWQgPSBhY3RpdmVDb25uc1swXS5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgfQogICAgfQoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5UT0dHTEVfQUNUSVZFX0NPTk5FQ1RJT05TLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiBjb25uZWN0aW9uSWQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuc2VuZFNvZnRwaG9uZU1ldHJpY3MgPSBmdW5jdGlvbiAoc29mdHBob25lU3RyZWFtU3RhdGlzdGljcywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX01FVFJJQ1MsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgc29mdHBob25lU3RyZWFtU3RhdGlzdGljczogc29mdHBob25lU3RyZWFtU3RhdGlzdGljcwogICAgfSwgY2FsbGJhY2tzKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVTdGF0cyh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHN0YXRzOiBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzCiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5zZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKHJlcG9ydCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfUkVQT1JULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9LCBjYWxsYmFja3MpOwoKICAgIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVJlcG9ydCh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jb25mZXJlbmNlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTkZFUkVOQ0VfQ09OTkVDVElPTlMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnRvU25hcHNob3QgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuaXNNdWx0aVBhcnR5Q29uZmVyZW5jZUVuYWJsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29udGFjdEZlYXR1cmVzID0gdGhpcy5nZXRDb250YWN0RmVhdHVyZXMoKTsKICAgIHJldHVybiAhIShjb250YWN0RmVhdHVyZXMgJiYgY29udGFjdEZlYXR1cmVzLm11bHRpUGFydHlDb25mZXJlbmNlRW5hYmxlZCk7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS51cGRhdGVNb25pdG9yUGFydGljaXBhbnRTdGF0ZSA9IGZ1bmN0aW9uICh0YXJnZXRTdGF0ZSwgY2FsbGJhY2tzKSB7CiAgICBpZighdGFyZ2V0U3RhdGUgfHwgIU9iamVjdC52YWx1ZXMoY29ubmVjdC5Nb25pdG9yaW5nTW9kZSkuaW5jbHVkZXModGFyZ2V0U3RhdGUpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoYEludmFsaWQgdGFyZ2V0IHN0YXRlIHdhcyBwcm92aWRlZDogJHt0YXJnZXRTdGF0ZX1gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5Nb25pdG9yaW5nRXJyb3JUeXBlcy5JTlZBTElEX1RBUkdFVF9TVEFURSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfTU9OSVRPUl9QQVJUSUNJUEFOVF9TVEFURSwgewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgICB0YXJnZXRNb25pdG9yTW9kZTogdGFyZ2V0U3RhdGUKICAgICAgfSwgY2FsbGJhY2tzKTsKICAgIH0KICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3RTbmFwc2hvdAogICAqLwogIHZhciBDb250YWN0U25hcHNob3QgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIGNvbm5lY3QuQ29udGFjdC5jYWxsKHRoaXMsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB0aGlzLmNvbnRhY3REYXRhID0gY29udGFjdERhdGE7CiAgfTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb250YWN0LnByb3RvdHlwZSk7CiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbnRhY3RTbmFwc2hvdDsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3REYXRhOwogIH07CgogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbm5lY3Rpb25BUEkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QoY29ubmVjdGlvbkRhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb24KICAgKi8KICB2YXIgQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgICB0aGlzLmNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25JZDsKICAgIHRoaXMuX2luaXRNZWRpYUNvbnRyb2xsZXIoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb25uZWN0aW9uRGF0YSgKICAgICAgdGhpcy5nZXRDb250YWN0SWQoKSwgdGhpcy5nZXRDb25uZWN0aW9uSWQoKSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25JZDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5FbmRwb2ludCh0aGlzLl9nZXREYXRhKCkuZW5kcG9pbnQpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEFkZHJlc3MgPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludDsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXR1cyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWw7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNBY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgdGhpcy5nZXRTdGF0dXMoKS50eXBlKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNDb25uZWN0aW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkc7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNPbkhvbGQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICAvKioKICAgKiBHZXRzIHRoZSBjdXJyZW50bHkgbW9uaXRvcmVkIGNvbnRhY3QgaW5mbywgUmV0dXJucyBudWxsIGlmIGRvZXMgbm90IGV4aXN0cy4KICAgKiBAcmV0dXJuIHt7YWdlbnROYW1lOnN0cmluZywgY3VzdG9tZXJOYW1lOnN0cmluZywgam9pblRpbWU6RGF0ZX19CiAgICovCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm1vbml0b3JpbmdJbmZvOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICBjb25uZWN0LnB1Ymxpc2hDbGlja1N0cmVhbURhdGEoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNsaWNrVHlwZTogY29ubmVjdC5DbGlja1R5cGUuSEFOR1VQLAogICAgICBjbGlja1RpbWU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgfSk7CgogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5ERVNUUk9ZX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuc2VuZERpZ2l0cyA9IGZ1bmN0aW9uIChkaWdpdHMsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0RJR0lUUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKSwKICAgICAgZGlnaXRzOiBkaWdpdHMKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaG9sZCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuSE9MRF9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVTVU1FX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmdldE1lZGlhSW5mbygpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpLmNhdGNoKGZ1bmN0aW9uICgpIHsgfSk7CiAgICB9CiAgfQoKICAvLyBNZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbgogIC8vICh0eXBlIEFHRU5UIG9yIE1PTklUT1JJTkcpCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25uZWN0aW9uVHlwZSA9IHRoaXMuZ2V0VHlwZSgpOwogICAgcmV0dXJuIGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UCiAgICAgIHx8IGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLk1PTklUT1JJTkc7CiAgfQoKICAvKioKICAgKiBVdGlsaXR5IG1ldGhvZCBmb3IgY2hlY2tpbmcgd2hldGhlciB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uCiAgICogKHR5cGUgQUdFTlQgb3IgTU9OSVRPUklORykKICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24uIEZhbHNlIG90aGVyd2lzZS4KICAgKi8KICBDb25uZWN0aW9uLnByb3RvdHlwZS5faXNBZ2VudENvbm5lY3Rpb25UeXBlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm5lY3Rpb25UeXBlID0gdGhpcy5nZXRUeXBlKCk7CiAgICByZXR1cm4gY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CiAgCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBDb250YWN0IHJlY29yZGluZwogICovCgogIHZhciBDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShjb250YWN0SWQpID8gY29udGFjdElkIDogbnVsbDsKICB9CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0YXJ0Q29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKHRyYWNrQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHZhciByZWNvcmRpbmdUcmFjayA9ICh0cmFja0NvbmZpZyAmJiBPYmplY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcpLmluY2x1ZGVzKHRyYWNrQ29uZmlnKSkgPyB0cmFja0NvbmZpZyA6IGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcuQUxMOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJ2b2ljZVJlY29yZGluZ0NvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAidm9pY2VSZWNvcmRpbmdUcmFjayI6IHJlY29yZGluZ1RyYWNrCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygic3RhcnRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdGFydENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIiwgeyBjYXVzZTogZXJyIH0pKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH07CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0b3BDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNUT1BfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJzdG9wQ29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0b3BDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdG9wQ29udGFjdFJlY29yZGluZyBmYWlsZWQiLCB7IGNhdXNlOiBlcnIgfSkpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKCiAgQ29udGFjdFJlY29yZGluZy5wcm90b3R5cGUuc3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQsIGNvbnRhY3REYXRhOwoKICAgIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1VTUEVORF9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyLAogICAgICAgICAgICAgIGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoRXJyb3IoInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIsIHsgY2F1c2U6IGVyciB9KSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5yZXN1bWVDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlJFU1VNRV9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgc3VjY2VlZGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLCB7IGNhdXNlOiBlcnIgfSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFZvaWNlIGF1dGhlbnRpY2F0b3IgVm9pY2VJZAogICovCgogIHZhciBWb2ljZUlkID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuR0VUX0NPTlRBQ1QsIHsKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgImF3c0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgaWYoZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkKSB7CiAgICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIHNwZWFrZXJJZDogZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0U3BlYWtlcklkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICByZXNvbHZlKG9iaik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5OT19TUEVBS0VSX0lEX0ZPVU5ELCAiTm8gc3BlYWtlcklkIGFzc290aWF0ZWQgd2l0aCB0aGlzIGNhbGwiKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiR2V0IFNwZWFrZXJJZCBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfU1BFQUtFUl9JRF9GQUlMRUQsICJHZXQgU3BlYWtlcklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5nZXRTcGVha2VyU3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5ERVNDUklCRV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRTcGVha2VyU3RhdHVzIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgICAgc3dpdGNoKHBhcnNlZEVyci5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gcGFyc2VkRXJyOwogICAgICAgICAgICAgICAgICAgIGRhdGEudHlwZSA9IGRhdGEudHlwZSA/IGRhdGEudHlwZSA6IGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1BFQUtFUl9JRF9OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTcGVha2VyIGlzIG5vdCBlbnJvbGxlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0U3BlYWtlclN0YXR1cyBmYWlsZWQiKQogICAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9TUEVBS0VSX1NUQVRVU19GQUlMRUQsICJHZXQgU3BlYWtlclN0YXR1cyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIGludGVybmFsIG9ubHkKICBWb2ljZUlkLnByb3RvdHlwZS5fb3B0T3V0U3BlYWtlckluTGNtcyA9IGZ1bmN0aW9uIChzcGVha2VySWQsIGdlbmVyYXRlZFNwZWFrZXJJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlVQREFURV9WT0lDRV9JRF9EQVRBLCB7CiAgICAgICAgIkNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJJbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJBV1NBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAiQ3VzdG9tZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAiVm9pY2VJZFJlc3VsdCI6IHsKICAgICAgICAgICJTcGVha2VyT3B0ZWRPdXQiOiB0cnVlLAogICAgICAgICAgImdlbmVyYXRlZFNwZWFrZXJJZCI6IGdlbmVyYXRlZFNwZWFrZXJJZAogICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXJJbkxjbXMgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigib3B0T3V0U3BlYWtlckluTGNtcyBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfSU5fTENNU19GQUlMRUQsICJvcHRPdXRTcGVha2VySW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLm9wdE91dFNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIHZhciBzcGVha2VySWQgPSBkYXRhLnNwZWFrZXJJZDsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLk9QVF9PVVRfU1BFQUtFUiwgewogICAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9vcHRPdXRTcGVha2VySW5MY21zKHNwZWFrZXJJZCwgZGF0YS5nZW5lcmF0ZWRTcGVha2VySWQpLmNhdGNoKGZ1bmN0aW9uKCl7fSk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIm9wdE91dFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfRkFJTEVELCAib3B0T3V0U3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlbGV0ZVNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFTEVURV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJkZWxldGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJkZWxldGVTcGVha2VyIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuREVMRVRFX1NQRUFLRVJfRkFJTEVELCAiZGVsZXRlU3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnN0YXJ0U2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfVk9JQ0VfSURfU0VTU0lPTiwgewogICAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgICAiY3VzdG9tZXJBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAgICJjbGllbnRUb2tlbiI6IEFXUy51dGlsLnV1aWQudjQoKSwKICAgICAgICAgICJkb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGlmKGRhdGEuc2Vzc2lvbklkKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCwgbm8gc2Vzc2lvbiBpZCByZXR1cm5lZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNUQVJUX1NFU1NJT05fRkFJTEVELCAiTm8gc2Vzc2lvbiBpZCByZXR1cm5lZCBmcm9tIHN0YXJ0IHNlc3Npb24gYXBpIik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TVEFSVF9TRVNTSU9OX0ZBSUxFRCwgInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyID0gZnVuY3Rpb24gKHN0YXJ0TmV3KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgcG9sbFRpbWVzID0gMDsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FVkFMVUFURV9TRVNTSU9OLCB7CiAgICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBpZigrK3BvbGxUaW1lcyA8IGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FVkFMVUFUSU9OX01BWF9QT0xMX1RJTUVTKSB7CiAgICAgICAgICAgICAgICBpZihkYXRhLlN0cmVhbWluZ1N0YXR1cyA9PT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLlBFTkRJTkdfQ09ORklHVVJBVElPTikgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmKCFkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIWRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlIGlmIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBhcmUgbm90IGVuYWJsZWQuCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICAhc2VsZi5pc0ZyYXVkRW5hYmxlZChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoZGF0YS5TdHJlYW1pbmdTdGF0dXMgPT09IGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cy5FTkRFRCkgewogICAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFZvaWNlIHByaW50IGlzIG5vdCBsb25nIGVub3VnaCBmb3IgYm90aCBhdXRoZW50aWNhdGlvbiBhbmQgZnJhdWQgZGV0ZWN0aW9uCiAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pc0ZyYXVkUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5BQ0NFUFQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5SRUpFQ1Q6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfQVVUSEVOVElDQVRFRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uU1BFQUtFUl9PUFRFRF9PVVQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5PUFRFRF9PVVQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlNQRUFLRVJfTk9UX0VOUk9MTEVEOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOUk9MTEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRFbmFibGVkKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkxPV19SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgICFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmUgb25seSB3aGVuIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBoYXZlIHJlc3VsdHMuIE90aGVyd2lzZSwga2VlcCBwb2xsaW5nLgogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJldmFsdWF0ZVNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfVElNRU9VVCwgImV2YWx1YXRlU3BlYWtlciB0aW1lb3V0Iik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfRkFJTEVELCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZighc3RhcnROZXcpIHsKICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGV2YWx1YXRlKCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3luY1NwZWFrZXJJZCBmYWlsZWQgd2hlbiBzZXNzaW9uIHN0YXJ0TmV3PWZhbHNlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRFX1NFU1NJT05fREVMQVkpOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN5bmNTcGVha2VySWQgZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz10cnVlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRTZXNzaW9uIGZhaWxlZCB3aGVuIHNlc3Npb24gc3RhcnROZXc9dHJ1ZSIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChlcnIpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlc2NyaWJlU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFU0NSSUJFX1NFU1NJT04sIHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkRFU0NSSUJFX1NFU1NJT05fRkFJTEVELCAiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuY2hlY2tFbnJvbGxtZW50U3RhdHVzID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBvbGxpbmdUaW1lcyA9IDA7CiAgICB2YXIgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSBmYWxzZTsKCiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBkZXNjcmliZSAoKSB7CiAgICAgICAgaWYoKytwb2xsaW5nVGltZXMgPCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRU5ST0xMTUVOVF9NQVhfUE9MTF9USU1FUykgewogICAgICAgICAgc2VsZi5kZXNjcmliZVNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICBzd2l0Y2goZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5TdGF0dXMpIHsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRDoKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLklOX1BST0dSRVNTOgogICAgICAgICAgICAgICAgaWYgKCFjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGVIYXNCZWVuSW52b2tlZCAmJiB0eXBlb2YgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0VGltZW91dChkZXNjcmliZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLk5PVF9FTk9VR0hfU1BFRUNIOgogICAgICAgICAgICAgICAgaWYoZGF0YS5TZXNzaW9uLlN0cmVhbWluZ1N0YXR1cyAhPT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZGVzY3JpYmUsY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaWJlKCk7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9LCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuU1RBUlRfU0VTU0lPTl9ERUxBWSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgPyBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgOiAiZW5yb2xsU3BlYWtlciBmYWlsZWQuIFVua25vd24gZW5yb2xsbWVudCBzdGF0dXMgaGFzIGJlZW4gcmVjZWl2ZWQiOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihtZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogIAkJICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCBtZXNzYWdlLCBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLlN0YXR1cyk7CiAgCQkgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVOUk9MTF9TUEVBS0VSX1RJTUVPVVQsICJlbnJvbGxTcGVha2VyIHRpbWVvdXQiKTsKICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlc2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5lbnJvbGxTcGVha2VyID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5nZXRTcGVha2VyU3RhdHVzKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZihkYXRhLlNwZWFrZXIgJiYgZGF0YS5TcGVha2VyLlN0YXR1cyA9PSBjb25uZWN0LlZvaWNlSWRTcGVha2VyU3RhdHVzLk9QVEVEX09VVCkgewogICAgICAgICAgICBzZWxmLmRlbGV0ZVNwZWFrZXIoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKQogICAgICB9KQogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmVucm9sbFNwZWFrZXJIZWxwZXIgPSBmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0LCBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FTlJPTExfQllfU0VTU0lPTiwgewogICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5DT01QTEVURUQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5jaGVja0Vucm9sbG1lbnRTdGF0dXMoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJlbnJvbGxTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCAiZW5yb2xsU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHJlamVjdChlcnIpOwogICAgfSk7CiAgfTsKCiAgLy8gaW50ZXJuYWwgb25seQogIFZvaWNlSWQucHJvdG90eXBlLl91cGRhdGVTcGVha2VySWRJbkxjbXMgPSBmdW5jdGlvbiAoc3BlYWtlcklkLCBnZW5lcmF0ZWRTcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5VUERBVEVfVk9JQ0VfSURfREFUQSwgewogICAgICAgICJDb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAiQVdTQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCksCiAgICAgICAgIkN1c3RvbWVySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgIlZvaWNlSWRSZXN1bHQiOiB7CiAgICAgICAgICAiZ2VuZXJhdGVkU3BlYWtlcklkIjogZ2VuZXJhdGVkU3BlYWtlcklkCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5MY21zIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJbkxjbXMgZmFpbGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0lOX0xDTVNfRkFJTEVELCAidXBkYXRlU3BlYWtlcklkSW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCA9IGZ1bmN0aW9uIChzcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1NFU1NJT04sIHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBzZWxmLl91cGRhdGVTcGVha2VySWRJbkxjbXMoc3BlYWtlcklkLCBkYXRhLmdlbmVyYXRlZFNwZWFrZXJJZCkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5zeW5jU3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYudXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkKGRhdGEuc3BlYWtlcklkKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pCiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmdldERvbWFpbklkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjb25zdCBhZ2VudCA9IG5ldyBjb25uZWN0LkFnZW50KCk7CiAgICAgIGlmICghYWdlbnQuZ2V0UGVybWlzc2lvbnMoKS5pbmNsdWRlcyhjb25uZWN0LkFnZW50UGVybWlzc2lvbnMuVk9JQ0VfSUQpKSB7CiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiQWdlbnQgZG9lc24ndCBoYXZlIHRoZSBwZXJtaXNzaW9uIGZvciBWb2ljZSBJRCIpKTsKICAgICAgfSBlbHNlIGlmIChjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkKSB7CiAgICAgICAgcmVzb2x2ZShjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkxJU1RfSU5URUdSQVRJT05fQVNTT0NJQVRJT05TLCB7CiAgICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAgICJJbnRlZ3JhdGlvblR5cGUiOiAiVk9JQ0VfSUQiCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgZG9tYWluSWQ7CiAgICAgICAgICAgICAgaWYgKGRhdGEuSW50ZWdyYXRpb25Bc3NvY2lhdGlvblN1bW1hcnlMaXN0Lmxlbmd0aCA+PSAxKSB7CiAgICAgICAgICAgICAgICB2YXIgaW50ZWdyYXRpb25Bcm4gPSBkYXRhLkludGVncmF0aW9uQXNzb2NpYXRpb25TdW1tYXJ5TGlzdFswXS5JbnRlZ3JhdGlvbkFybjsKICAgICAgICAgICAgICAgIGRvbWFpbklkID0gaW50ZWdyYXRpb25Bcm4ucmVwbGFjZSgvXi4qZG9tYWluXC8vaSwgJycpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRvbWFpbklkKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldERvbWFpbklkOiBubyBkb21haW5JZCBmb3VuZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLk5PX0RPTUFJTl9JRF9GT1VORCk7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldERvbWFpbklkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgICAgICBldmVudDogY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsCiAgICAgICAgICAgICAgICBkYXRhOiB7IGRvbWFpbklkOiBkb21haW5JZCB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVzb2x2ZShkb21haW5JZCk7CiAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0RG9tYWluSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfRE9NQUlOX0lEX0ZBSUxFRCwgImdldERvbWFpbklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0RG9tYWluSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX0RPTUFJTl9JRF9GQUlMRUQsICJnZXREb21haW5JZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmNoZWNrQ29uZmVyZW5jZUNhbGwgPSBmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGlzQ29uZmVyZW5jZUNhbGwgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCkuY29ubmVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCBjb25uLnN0YXRlLnR5cGUpOwogICAgfSkubGVuZ3RoID4gMjsKICAgIGlmKGlzQ29uZmVyZW5jZUNhbGwpewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCJWb2ljZUlkIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIGNvbmZlcmVuY2UgY2FsbHMiKTsKICAgIH0KICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzQXV0aEVuYWJsZWQgPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCAhPT0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2ggPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCA9PT0gY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5PVUdIX1NQRUVDSDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzQXV0aFJlc3VsdEluY29uY2x1c2l2ZSA9IGZ1bmN0aW9uKGF1dGhSZXN1bHQpIHsKICAgIHJldHVybiBhdXRoUmVzdWx0ID09PSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0ZyYXVkRW5hYmxlZCA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgIT09IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaCA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgPT09IGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTk9UX0VOT1VHSF9TUEVFQ0g7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0ZyYXVkUmVzdWx0SW5jb25jbHVzaXZlID0gZnVuY3Rpb24oZnJhdWRSZXN1bHQpIHsKICAgIHJldHVybiBmcmF1ZFJlc3VsdCA9PT0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogIH0KCiAgLyoqCiAgICogQGNsYXNzIFZvaWNlQ29ubmVjdGlvbgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb250YWN0SWQKICAgKiBAcGFyYW0ge251bWJlcn0gY29ubmVjdGlvbklkCiAgICogQGRlc2NyaXB0aW9uIC0gUHJvdmlkZXMgdm9pY2UgbWVkaWEgc3BlY2lmaWMgb3BlcmF0aW9ucwogICAqLwogIHZhciBWb2ljZUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yID0gbmV3IFZvaWNlSWQoY29udGFjdElkKTsKICAgIHRoaXMuX2NvbnRhY3RSZWNvcmRlciA9IG5ldyBDb250YWN0UmVjb3JkaW5nKGNvbnRhY3RJZCk7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VDb25uZWN0aW9uOwoKICAvKioKICAqIEBkZXByZWNhdGVkCiAgKiBQbGVhc2UgdXNlIGdldE1lZGlhSW5mbwogICovCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Vm9pY2VJZFNwZWFrZXJJZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJJZCgpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRWb2ljZUlkU3BlYWtlclN0YXR1cyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJTdGF0dXMoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUub3B0T3V0Vm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKCiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3Iub3B0T3V0U3BlYWtlcigpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5kZWxldGVWb2ljZUlkU3BlYWtlciA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmRlbGV0ZVNwZWFrZXIoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyV2l0aFZvaWNlSWQgPSBmdW5jdGlvbihzdGFydE5ldykgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmV2YWx1YXRlU3BlYWtlcihzdGFydE5ldyk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmVucm9sbFNwZWFrZXJJblZvaWNlSWQgPSBmdW5jdGlvbihjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5lbnJvbGxTcGVha2VyKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnVwZGF0ZVZvaWNlSWRTcGVha2VySWQgPSBmdW5jdGlvbihzcGVha2VySWQpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci51cGRhdGVTcGVha2VySWRJblZvaWNlSWQoc3BlYWtlcklkKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0UXVpY2tDb25uZWN0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVpY2tDb25uZWN0TmFtZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1vbml0b3JTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvclN0YXRlOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckNhcGFiaWxpdGllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvckNhcGFiaWxpdGllczsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzRm9yY2VkTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZm9yY2VkTXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLm11dGVQYXJ0aWNpcGFudCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTVVURV9QQVJUSUNJUEFOVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnVubXV0ZVBhcnRpY2lwYW50ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VTk1VVEVfUEFSVElDSVBBTlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdGFydENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdGFydENvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuc3RvcENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdG9wQ29udGFjdFJlY29yZGluZygpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdXNwZW5kQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5yZXN1bWVDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNoZWNrQ29uZmVyZW5jZUNhbGwgPSBmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGlzQ29uZmVyZW5jZUNhbGwgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCkuY29ubmVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCBjb25uLnN0YXRlLnR5cGUpOwogICAgfSkubGVuZ3RoID4gMjsKICAgIGlmKGlzQ29uZmVyZW5jZUNhbGwpewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCJWb2ljZUlkIGFuZCBDb250YWN0IFJlY29yZGluZyBhcmUgbm90IHN1cHBvcnRlZCBmb3IgY29uZmVyZW5jZSBjYWxscyIpOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIENoYXRDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZAogICAqIEBkZXNjcmlwdGlvbiBhZGRzIHRoZSBjaGF0IG1lZGlhIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkKICAgKi8KICB2YXIgQ2hhdENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ2hhdENvbm5lY3Rpb247CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZGF0YSA9IHRoaXMuX2dldERhdGEoKS5jaGF0TWVkaWFJbmZvOwogICAgaWYgKCFkYXRhKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgICB2YXIgbWVkaWFPYmplY3QgPSB7CiAgICAgICAgY29udGFjdElkOiB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBpbml0aWFsQ29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgIHBhcnRpY2lwYW50SWQ6IHRoaXMuY29ubmVjdGlvbklkLAogICAgICAgIGdldENvbm5lY3Rpb25Ub2tlbjogY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLmdldENvbm5lY3Rpb25Ub2tlbikKICAgICAgfTsKICAgICAgaWYgKGRhdGEuY29ubmVjdGlvbkRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IEpTT04ucGFyc2UoZGF0YS5jb25uZWN0aW9uRGF0YSkuQ29ubmVjdGlvbkF1dGhlbnRpY2F0aW9uVG9rZW47CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFULCAiQ29ubmVjdGlvbiBkYXRhIGlzIGludmFsaWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiB8fCBudWxsOwogICAgICAvKiogSnVzdCB0byBrZWVwIHRoZSBkYXRhIGFjY2Vzc2libGUgKi8KICAgICAgbWVkaWFPYmplY3Qub3JpZ2luYWxJbmZvID0gdGhpcy5fZ2V0RGF0YSgpLmNoYXRNZWRpYUluZm87CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICAgIH0KICB9OwoKICAvKioKICAqIFByb3ZpZGVzIHRoZSBjaGF0IGNvbm5lY3Rpb25Ub2tlbiB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSSBmb3IgYSBzcGVjaWZpYyBjb250YWN0IGFuZCBwYXJ0aWNpcGFudCBJZC4KICAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogICogVXNhZ2U6CiAgKiBjb25uZWN0aW9uLmdldENvbm5lY3Rpb25Ub2tlbigpCiAgKiAgLnRoZW4ocmVzcG9uc2UgPT4ge30pCiAgKiAgLmNhdGNoKGVycm9yID0+IHt9KQogICovCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25Ub2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgdHJhbnNwb3J0RGV0YWlscyA9IHsKICAgICAgdHJhbnNwb3J0VHlwZTogY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMuQ0hBVF9UT0tFTiwKICAgICAgcGFydGljaXBhbnRJZDogdGhpcy5jb25uZWN0aW9uSWQsCiAgICAgIGNvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZAogICAgfTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB0cmFuc3BvcnREZXRhaWxzLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0Q29ubmVjdGlvblRva2VuIHN1Y2NlZWRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0Q29ubmVjdGlvblRva2VuIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoRXJyb3IoImdldENvbm5lY3Rpb25Ub2tlbiBmYWlsZWQiKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5NZWRpYVR5cGUuQ0hBVDsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIE5vdGUgdGhhdCBhIGNoYXQgbWVkaWEgY29udHJvbGxlciBvbmx5IG5lZWRzIHRvIGJlIHByb2R1Y2VkIGZvciBhZ2VudCB0eXBlIGNvbm5lY3Rpb25zLgogICAgaWYgKHRoaXMuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSgpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpLmNhdGNoKGZ1bmN0aW9uICgpIHsgfSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBAY2xhc3MgVGFza0Nvbm5lY3Rpb24KICAgKiBAcGFyYW0geyp9IGNvbnRhY3RJZAogICAqIEBwYXJhbSB7Kn0gY29ubmVjdGlvbklkCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIHRhc2sgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBUYXNrQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tDb25uZWN0aW9uOwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s7CiAgfQoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgIH07CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICB9OwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb25TbmFwc2hvdAogICAqLwogIHZhciBDb25uZWN0aW9uU25hcHNob3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIGNvbm5lY3QuQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbm5lY3Rpb25EYXRhLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIHRoaXMuY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0aW9uRGF0YTsKICB9OwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29ubmVjdGlvblNuYXBzaG90OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgdmFyIEVuZHBvaW50ID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB0aGlzLmVuZHBvaW50QVJOID0gcGFyYW1zLmVuZHBvaW50SWQgfHwgcGFyYW1zLmVuZHBvaW50QVJOIHx8IG51bGw7CiAgICB0aGlzLmVuZHBvaW50SWQgPSB0aGlzLmVuZHBvaW50QVJOOwogICAgdGhpcy50eXBlID0gcGFyYW1zLnR5cGUgfHwgbnVsbDsKICAgIHRoaXMubmFtZSA9IHBhcmFtcy5uYW1lIHx8IG51bGw7CiAgICB0aGlzLnBob25lTnVtYmVyID0gcGFyYW1zLnBob25lTnVtYmVyIHx8IG51bGw7CiAgICB0aGlzLmFnZW50TG9naW4gPSBwYXJhbXMuYWdlbnRMb2dpbiB8fCBudWxsOwogICAgdGhpcy5xdWV1ZSA9IHBhcmFtcy5xdWV1ZSB8fCBudWxsOwogIH07CgogIC8qKgogICAqIFN0cmlwIHRoZSBTSVAgZW5kcG9pbnQgY29tcG9uZW50cyBmcm9tIHRoZSBwaG9uZU51bWJlciBmaWVsZC4KICAgKi8KICBFbmRwb2ludC5wcm90b3R5cGUuc3RyaXBQaG9uZU51bWJlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnBob25lTnVtYmVyID8gdGhpcy5waG9uZU51bWJlci5yZXBsYWNlKC9zaXA6KFteQF0qKUAuKi8sICIkMSIpIDogIiI7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGFuIEVuZHBvaW50IG9iamVjdCBmcm9tIHRoZSBnaXZlbiBwaG9uZSBudW1iZXIgYW5kIG5hbWUuCiAgICovCiAgRW5kcG9pbnQuYnlQaG9uZU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgRW5kcG9pbnQoewogICAgICB0eXBlOiBjb25uZWN0LkVuZHBvaW50VHlwZS5QSE9ORV9OVU1CRVIsCiAgICAgIHBob25lTnVtYmVyOiBudW1iZXIsCiAgICAgIG5hbWU6IG5hbWUgfHwgbnVsbAogICAgfSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgU29mdHBob25lRXJyb3IKICAgKi8KICB2YXIgU29mdHBob25lRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBlcnJvck1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICB0aGlzLmVycm9yVHlwZSA9IGVycm9yVHlwZTsKICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlOwogICAgdGhpcy5lbmRQb2ludFVybCA9IGVuZFBvaW50VXJsOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yVHlwZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFcnJvck1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lcnJvck1lc3NhZ2U7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RW5kUG9pbnRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lbmRQb2ludFVybDsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSb290IFN1YnNjcmlwdGlvbiBBUElzLgogICAqLwogIGNvbm5lY3QuYWdlbnQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgdmFyIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBmKTsKICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIGYobmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CiAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwoKICBjb25uZWN0LmNvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgcmV0dXJuIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIGYpOwogIH07CgogIGNvbm5lY3Qub25XZWJzb2NrZXRJbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGYpOwogICAgaWYgKGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICBmKCk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFN0YXJ0cyB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXN5bmNocm9ub3VzbHkgb25seSBpZiB0aGUgc2hhcmVkIHdvcmtlcgogICAqIHNheXMgd2UgYXJlIHRoZSBtYXN0ZXIgZm9yIHRoZSBnaXZlbiB0b3BpYy4gIElmIHRoZXJlIGlzIG5vIG1hc3RlciBmb3IKICAgKiB0aGUgZ2l2ZW4gdG9waWMsIHdlIGJlY29tZSB0aGUgbWFzdGVyIGFuZCBzdGFydCB0aGUgZnVuY3Rpb24gdW5sZXNzCiAgICogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIGlzIHRydWUuCiAgICoKICAgKiBAcGFyYW0gdG9waWMgVGhlIG1hc3RlciB0b3BpYyB3ZSBhcmUgY29uY2VybmVkIGFib3V0LgogICAqIEBwYXJhbSBmX3RydWUgVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgaWYgd2UgYXJlIHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIGZfZWxzZSBbb3B0aW9uYWxdIEEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgbm90IHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSBbb3B0aW9uYWxdIGlmIHRydWUsIHRoaXMgdGFiIHdvbid0IGJlY29tZSBtYXN0ZXIuCiAgICovCiAgY29ubmVjdC5pZk1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgZl90cnVlLCBmX2Vsc2UsIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZfdHJ1ZSwgIkEgdHJ1ZSBjYWxsYmFjayBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKGZfZWxzZSkgewogICAgICAgIGZfZWxzZSgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUiwgewogICAgICB0b3BpYzogdG9waWMsCiAgICAgIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZTogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmlzTWFzdGVyKSB7CiAgICAgICAgICAgIGZfdHJ1ZSgpOwoKICAgICAgICAgIH0gZWxzZSBpZiAoZl9lbHNlKSB7CiAgICAgICAgICAgIGZfZWxzZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgfTsKCiAgLyoqCiAgICogTm90aWZ5IHRoZSBzaGFyZWQgd29ya2VyIGFuZCBvdGhlciBDQ1AgdGFicyB0aGF0IHdlIGFyZSBub3cgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLgogICAqLwogIGNvbm5lY3QuYmVjb21lTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYyk7CiAgICAgIGlmIChmYWlsdXJlQ2FsbGJhY2spIHsKICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIG1hc3RlckNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQoKTsKICAgICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVIsIHsKICAgICAgICB0b3BpYzogdG9waWMKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChzdWNjZXNzQ2FsbGJhY2spIHsKICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0LkFnZW50ID0gQWdlbnQ7CiAgY29ubmVjdC5BZ2VudFNuYXBzaG90ID0gQWdlbnRTbmFwc2hvdDsKICBjb25uZWN0LkNvbnRhY3QgPSBDb250YWN0OwogIGNvbm5lY3QuQ29udGFjdFNuYXBzaG90ID0gQ29udGFjdFNuYXBzaG90OwogIC8qKiBEZWZhdWx0IHdpbGwgZ2V0IHRoZSBWb2ljZSBjb25uZWN0aW9uICovCiAgY29ubmVjdC5Db25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQmFzZUNvbm5lY3Rpb24gPSBDb25uZWN0aW9uOwogIGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24gPSBDaGF0Q29ubmVjdGlvbjsKICBjb25uZWN0LlRhc2tDb25uZWN0aW9uID0gVGFza0Nvbm5lY3Rpb247CiAgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QgPSBDb25uZWN0aW9uU25hcHNob3Q7CiAgY29ubmVjdC5FbmRwb2ludCA9IEVuZHBvaW50OwogIGNvbm5lY3QuQWRkcmVzcyA9IEVuZHBvaW50OwogIGNvbm5lY3QuU29mdHBob25lRXJyb3IgPSBTb2Z0cGhvbmVFcnJvcjsKICBjb25uZWN0LlZvaWNlSWQgPSBWb2ljZUlkOwogIGNvbm5lY3QuQ29udGFjdFJlY29yZGluZyA9IENvbnRhY3RSZWNvcmRpbmc7Cn0pKCk7CgoKCi8qKiovIH0pLAoKLyoqKi8gODI3OgovKioqLyAoKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgPT4gewoKdmFyIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fOy8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuMTE4OS4wCi8vIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgovLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CihmdW5jdGlvbigpe2Z1bmN0aW9uIHIoZSxuLHQpe2Z1bmN0aW9uIG8oaSxmKXtpZighbltpXSl7aWYoIWVbaV0pe3ZhciBjPXVuZGVmaW5lZDtpZighZiYmYylyZXR1cm4gcmVxdWlyZShpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK2krIiciKTt0aHJvdyBhLmNvZGU9Ik1PRFVMRV9OT1RfRk9VTkQiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT11bmRlZmluZWQsaT0wO2k8dC5sZW5ndGg7aSsrKW8odFtpXSk7cmV0dXJuIG99cmV0dXJuIHJ9KSgpKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJ2ZXJzaW9uIjogIjIuMCIsCiAgIm1ldGFkYXRhIjogewogICAgImFwaVZlcnNpb24iOiAiMjAxNC0wNi0zMCIsCiAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAianNvblZlcnNpb24iOiAiMS4xIiwKICAgICJwcm90b2NvbCI6ICJqc29uIiwKICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uIENvZ25pdG8gSWRlbnRpdHkiLAogICAgInNlcnZpY2VJZCI6ICJDb2duaXRvIElkZW50aXR5IiwKICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICJ0YXJnZXRQcmVmaXgiOiAiQVdTQ29nbml0b0lkZW50aXR5U2VydmljZSIsCiAgICAidWlkIjogImNvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMCIKICB9LAogICJvcGVyYXRpb25zIjogewogICAgIkNyZWF0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIkFsbG93Q2xhc3NpY0Zsb3ciOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlN1cHBvcnRlZExvZ2luUHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzUiCiAgICAgICAgICB9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOSIKICAgICAgICAgIH0sCiAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2IiCiAgICAgICAgICB9LAogICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZyIKICAgICAgICAgIH0sCiAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgIH0KICAgIH0sCiAgICAiRGVsZXRlSWRlbnRpdGllcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkc1RvRGVsZXRlIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiVW5wcm9jZXNzZWRJZGVudGl0eUlkcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICAgICAiRXJyb3JDb2RlIjoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiRGVsZXRlSWRlbnRpdHlQb29sIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkRlc2NyaWJlSWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgfQogICAgfSwKICAgICJEZXNjcmliZUlkZW50aXR5UG9vbCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgIH0KICAgIH0sCiAgICAiR2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzEwIgogICAgICAgICAgfSwKICAgICAgICAgICJDdXN0b21Sb2xlQXJuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9LAogICAgICAgICAgICAgICJTZWNyZXRLZXkiOiB7fSwKICAgICAgICAgICAgICAiU2Vzc2lvblRva2VuIjoge30sCiAgICAgICAgICAgICAgIkV4cGlyYXRpb24iOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiYXV0aHR5cGUiOiAibm9uZSIKICAgIH0sCiAgICAiR2V0SWQiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFjY291bnRJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzEwIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgImF1dGh0eXBlIjogIm5vbmUiCiAgICB9LAogICAgIkdldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJSb2xlcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxYyIKICAgICAgICAgIH0sCiAgICAgICAgICAiUm9sZU1hcHBpbmdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFlIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRPcGVuSWRUb2tlbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzEwIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiYXV0aHR5cGUiOiAibm9uZSIKICAgIH0sCiAgICAiR2V0T3BlbklkVG9rZW5Gb3JEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJMb2dpbnMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMTAiCiAgICAgICAgICB9LAogICAgICAgICAgIlByaW5jaXBhbFRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMXMiCiAgICAgICAgICB9LAogICAgICAgICAgIlRva2VuRHVyYXRpb24iOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIlRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0UHJpbmNpcGFsVGFnQXR0cmlidXRlTWFwIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgIklkZW50aXR5UHJvdmlkZXJOYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVByb3ZpZGVyTmFtZSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIlVzZURlZmF1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJQcmluY2lwYWxUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFzIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJMaXN0SWRlbnRpdGllcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJOZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJIaWRlRGlzYWJsZWQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0aWVzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3YiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiTGlzdElkZW50aXR5UG9vbHMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiTWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkxpc3RUYWdzRm9yUmVzb3VyY2UiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJSZXNvdXJjZUFybiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlJlc291cmNlQXJuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkxvb2t1cERldmVsb3BlcklkZW50aXR5IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciI6IHt9LAogICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyTGlzdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJNZXJnZURldmVsb3BlcklkZW50aXRpZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJTb3VyY2VVc2VySWRlbnRpZmllciIsCiAgICAgICAgICAiRGVzdGluYXRpb25Vc2VySWRlbnRpZmllciIsCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAiRGVzdGluYXRpb25Vc2VySWRlbnRpZmllciI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU2V0SWRlbnRpdHlQb29sUm9sZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAiUm9sZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIlJvbGVzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFjIgogICAgICAgICAgfSwKICAgICAgICAgICJSb2xlTWFwcGluZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMWUiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlNldFByaW5jaXBhbFRhZ0F0dHJpYnV0ZU1hcCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJJZGVudGl0eVByb3ZpZGVyTmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICJVc2VEZWZhdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiUHJpbmNpcGFsVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxcyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiVXNlRGVmYXVsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlByaW5jaXBhbFRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMXMiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlRhZ1Jlc291cmNlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiUmVzb3VyY2VBcm4iLAogICAgICAgICAgIlRhZ3MiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiVW5saW5rRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eUlkIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIiwKICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiVW5saW5rSWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eUlkIiwKICAgICAgICAgICJMb2dpbnMiLAogICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxMCIKICAgICAgICAgIH0sCiAgICAgICAgICAiTG9naW5zVG9SZW1vdmUiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTdyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJhdXRodHlwZSI6ICJub25lIgogICAgfSwKICAgICJVbnRhZ1Jlc291cmNlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiUmVzb3VyY2VBcm4iLAogICAgICAgICAgIlRhZ0tleXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgIlRhZ0tleXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiVXBkYXRlSWRlbnRpdHlQb29sIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInNoYXBlIjogIlNrIgogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgfQogICAgfQogIH0sCiAgInNoYXBlcyI6IHsKICAgICJTNSI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7fQogICAgfSwKICAgICJTOSI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7fQogICAgfSwKICAgICJTYiI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICJDbGllbnRJZCI6IHt9LAogICAgICAgICAgIlNlcnZlclNpZGVUb2tlbkNoZWNrIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTZyI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7fQogICAgfSwKICAgICJTaCI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7fQogICAgfSwKICAgICJTayI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30sCiAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgfSwKICAgICAgICAiQWxsb3dDbGFzc2ljRmxvdyI6IHsKICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgfSwKICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAic2hhcGUiOiAiUzUiCiAgICAgICAgfSwKICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAic2hhcGUiOiAiUzkiCiAgICAgICAgfSwKICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgInNoYXBlIjogIlNiIgogICAgICAgIH0sCiAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgfSwKICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU3YiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTdyIKICAgICAgICB9LAogICAgICAgICJDcmVhdGlvbkRhdGUiOiB7CiAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgfSwKICAgICAgICAiTGFzdE1vZGlmaWVkRGF0ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU3ciOiB7CiAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAibWVtYmVyIjoge30KICAgIH0sCiAgICAiUzEwIjogewogICAgICAidHlwZSI6ICJtYXAiLAogICAgICAia2V5Ijoge30sCiAgICAgICJ2YWx1ZSI6IHt9CiAgICB9LAogICAgIlMxYyI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7fQogICAgfSwKICAgICJTMWUiOiB7CiAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICJrZXkiOiB7fSwKICAgICAgInZhbHVlIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIlR5cGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJUeXBlIjoge30sCiAgICAgICAgICAiQW1iaWd1b3VzUm9sZVJlc29sdXRpb24iOiB7fSwKICAgICAgICAgICJSdWxlc0NvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAiUnVsZXMiCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJSdWxlcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICJDbGFpbSIsCiAgICAgICAgICAgICAgICAgICAgIk1hdGNoVHlwZSIsCiAgICAgICAgICAgICAgICAgICAgIlZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAiUm9sZUFSTiIKICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgIkNsYWltIjoge30sCiAgICAgICAgICAgICAgICAgICAgIk1hdGNoVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICJWYWx1ZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIjoge30KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTMXMiOiB7CiAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICJrZXkiOiB7fSwKICAgICAgInZhbHVlIjoge30KICAgIH0KICB9Cn0KfSx7fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAicGFnaW5hdGlvbiI6IHsKICAgICJMaXN0SWRlbnRpdHlQb29scyI6IHsKICAgICAgImlucHV0X3Rva2VuIjogIk5leHRUb2tlbiIsCiAgICAgICJsaW1pdF9rZXkiOiAiTWF4UmVzdWx0cyIsCiAgICAgICJvdXRwdXRfdG9rZW4iOiAiTmV4dFRva2VuIiwKICAgICAgInJlc3VsdF9rZXkiOiAiSWRlbnRpdHlQb29scyIKICAgIH0KICB9Cn0KfSx7fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAidmVyc2lvbiI6ICIyLjAiLAogICJtZXRhZGF0YSI6IHsKICAgICJhcGlWZXJzaW9uIjogIjIwMTctMDItMTUiLAogICAgImVuZHBvaW50UHJlZml4IjogImNvbm5lY3QiLAogICAgImpzb25WZXJzaW9uIjogIjEuMCIsCiAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAic2VydmljZUFiYnJldmlhdGlvbiI6ICJDb25uZWN0IiwKICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uQ29ubmVjdENUSVNlcnZpY2UiLAogICAgInNpZ25hdHVyZVZlcnNpb24iOiAiIiwKICAgICJ0YXJnZXRQcmVmaXgiOiAiQW1hem9uQ29ubmVjdENUSVNlcnZpY2UiLAogICAgInVpZCI6ICJjb25uZWN0LTIwMTctMDItMTUiCiAgfSwKICAib3BlcmF0aW9ucyI6IHsKICAgICJBY2NlcHRDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNsZWFyQ29udGFjdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNvbXBsZXRlQ29udGFjdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNvbmZlcmVuY2VDb25uZWN0aW9ucyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJDcmVhdGVBZGRpdGlvbmFsQ29ubmVjdGlvbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImVuZHBvaW50IgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiQ3JlYXRlT3V0Ym91bmRDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImVuZHBvaW50IgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgIH0sCiAgICAgICAgICAicXVldWVBUk4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJDcmVhdGVUYXNrQ29udGFjdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImVuZHBvaW50IiwKICAgICAgICAgICJuYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgIH0sCiAgICAgICAgICAicHJldmlvdXNDb250YWN0SWQiOiB7fSwKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU3IiCiAgICAgICAgICB9LAogICAgICAgICAgImlkZW1wb3RlbmN5VG9rZW4iOiB7fSwKICAgICAgICAgICJzY2hlZHVsZWRUaW1lIjogewogICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkNyZWF0ZVRyYW5zcG9ydCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInRyYW5zcG9ydFR5cGUiLAogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAidHJhbnNwb3J0VHlwZSI6IHt9LAogICAgICAgICAgInBhcnRpY2lwYW50SWQiOiB7fSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJzb2Z0cGhvbmVDbGllbnRJZCI6IHt9LAogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAid2ViU29ja2V0VHJhbnNwb3J0IjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgInVybCIsCiAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIgogICAgICAgICAgICBdLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAidXJsIjoge30sCiAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgImNoYXRUb2tlblRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJwYXJ0aWNpcGFudFRva2VuIiwKICAgICAgICAgICAgICAiZXhwaXJ5IgogICAgICAgICAgICBdLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgInNvZnRwaG9uZVRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIgogICAgICAgICAgICBdLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFDb25uZWN0aW9ucyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSIsCiAgICAgICAgICAgICAgICAgICAgImNyZWRlbnRpYWwiLAogICAgICAgICAgICAgICAgICAgICJ1cmxzIgogICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAidXNlcm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCI6IHt9LAogICAgICAgICAgICAgICAgICAgICJ1cmxzIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiRGVzdHJveUNvbm5lY3Rpb24iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJHZXRBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFoIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRBZ2VudFBlcm1pc3Npb25zIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJwZXJtaXNzaW9ucyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInBlcm1pc3Npb25zIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldEFnZW50U25hcHNob3QiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgInRpbWVvdXQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInNuYXBzaG90IiwKICAgICAgICAgICJuZXh0VG9rZW4iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJzbmFwc2hvdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgImNvbnRhY3RzIiwKICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAibmV4dFN0YXRlIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJhZ2VudEF2YWlsYWJpbGl0eVN0YXRlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAic3RhdGUiOiB7fSwKICAgICAgICAgICAgICAgICAgInRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJjb250YWN0cyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiCiAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInF1ZXVlVGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImluaXRpYWwiCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUluZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVkaWFMZWdDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb25maWdKc29uIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0TWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdEF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25EYXRhIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjdXN0b21lck5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JpbmdJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWdlbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudE5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvaW5UaW1lU3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAiZm9yY2VkTXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAicXVpY2tDb25uZWN0TmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJtb25pdG9yQ2FwYWJpbGl0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJtb25pdG9yU3RhdGUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSIKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY29udGFjdER1cmF0aW9uIjoge30sCiAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAicmVmZXJlbmNlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJpbml0aWF0aW9uTWV0aG9kIjoge30sCiAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RGZWF0dXJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgImF0dGFjaG1lbnRzRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnaW5nTWFya2Rvd25FbmFibGVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtdWx0aVBhcnR5Q29uZmVyZW5jZUVuYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNoYW5uZWxDb250ZXh0IjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAic2NoZWR1bGVkVGltZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAidGFza1RlbXBsYXRlSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgInRhc2tUZW1wbGF0ZVZlcnNpb24iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInNuYXBzaG90VGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRBZ2VudFN0YXRlcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAic3RhdGVzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAic3RhdGVzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldERpYWxhYmxlQ291bnRyeUNvZGVzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJjb3VudHJ5Q29kZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJjb3VudHJ5Q29kZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0RW5kcG9pbnRzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgInF1ZXVlQVJOcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgInF1ZXVlQVJOcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImVuZHBvaW50cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldE5ld0F1dGhUb2tlbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJyZWZyZXNoVG9rZW4iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJyZWZyZXNoVG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIm5ld0F1dGhUb2tlbiI6IHt9LAogICAgICAgICAgImV4cGlyYXRpb25EYXRlVGltZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRSb3V0aW5nUHJvZmlsZVF1ZXVlcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJyb3V0aW5nUHJvZmlsZUFSTiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAicXVldWVzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAicXVldWVzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiSG9sZENvbm5lY3Rpb24iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJNdXRlUGFydGljaXBhbnQiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJOb3RpZnlDb250YWN0SXNzdWUiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiaXNzdWVDb2RlIjoge30sCiAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICJjbGllbnRMb2dzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiUHV0QWdlbnRTdGF0ZSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJzdGF0ZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgfSwKICAgICAgICAgICJlbnF1ZXVlTmV4dFN0YXRlIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJSZWplY3RDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiY29udGFjdElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiUmVzdW1lQ29ubmVjdGlvbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlNlbmRDbGllbnRMb2dzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImxvZ0V2ZW50cyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImxvZ0V2ZW50cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY29tcG9uZW50Ijoge30sCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlNlbmREaWdpdHMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiLAogICAgICAgICAgImRpZ2l0cyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9LAogICAgICAgICAgImRpZ2l0cyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlNlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjY3BWZXJzaW9uIjoge30sCiAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMzdiIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiU2VuZFNvZnRwaG9uZUNhbGxSZXBvcnQiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJyZXBvcnQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjY3BWZXJzaW9uIjoge30sCiAgICAgICAgICAicmVwb3J0IjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAiY2FsbFN0YXJ0VGltZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJjYWxsRW5kVGltZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlMzdiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJndW1UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJpbml0aWFsaXphdGlvblRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImhhbmRzaGFrZVRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInByZVRhbGtUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJ0YWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiY2xlYW51cFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImhhbmRzaGFrZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImd1bU90aGVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiZ3VtVGltZW91dEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNyZWF0ZU9mZmVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAic2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInVzZXJCdXN5RmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgIm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAic2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiVG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJVbm11dGVQYXJ0aWNpcGFudCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb25maWd1cmF0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxaCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0KICB9LAogICJzaGFwZXMiOiB7CiAgICAiUzIiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJhZ2VudEFSTiI6IHt9LAogICAgICAgICJhdXRoVG9rZW4iOiB7fQogICAgICB9CiAgICB9LAogICAgIlNlIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgInR5cGUiCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJlbmRwb2ludEFSTiI6IHt9LAogICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAicGhvbmVOdW1iZXIiOiB7fSwKICAgICAgICAiYWdlbnRMb2dpbiI6IHt9LAogICAgICAgICJxdWV1ZSI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU2siOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJxdWV1ZUFSTiI6IHt9LAogICAgICAgICJuYW1lIjoge30KICAgICAgfQogICAgfSwKICAgICJTciI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidmFsdWUiLAogICAgICAgICAgInR5cGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJ2YWx1ZSI6IHt9LAogICAgICAgICAgInR5cGUiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTMWgiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAibmFtZSIsCiAgICAgICAgInNvZnRwaG9uZUVuYWJsZWQiLAogICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IiwKICAgICAgICAiZXh0ZW5zaW9uIiwKICAgICAgICAicm91dGluZ1Byb2ZpbGUiCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJuYW1lIjoge30sCiAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgInNvZnRwaG9uZUVuYWJsZWQiOiB7CiAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgIH0sCiAgICAgICAgInNvZnRwaG9uZUF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgIH0sCiAgICAgICAgImV4dGVuc2lvbiI6IHt9LAogICAgICAgICJyb3V0aW5nUHJvZmlsZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICJkZWZhdWx0T3V0Ym91bmRRdWV1ZSI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjaGFubmVsQ29uY3VycmVuY3lNYXAiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJhZ2VudFByZWZlcmVuY2VzIjogewogICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlMyMCI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICJ0eXBlIiwKICAgICAgICAibmFtZSIKICAgICAgXSwKICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgImFnZW50U3RhdGVBUk4iOiB7fSwKICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICJuYW1lIjoge30sCiAgICAgICAgInN0YXJ0VGltZXN0YW1wIjogewogICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTM3YiOiB7CiAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAibWVtYmVyIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9LAogICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVR5cGUiOiB7fSwKICAgICAgICAgICJwYWNrZXRDb3VudCI6IHsKICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgIH0sCiAgICAgICAgICAicGFja2V0c0xvc3QiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9LAogICAgICAgICAgImF1ZGlvTGV2ZWwiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImRvdWJsZSIKICAgICAgICAgIH0sCiAgICAgICAgICAiaml0dGVyQnVmZmVyTWlsbGlzIjogewogICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgfSwKICAgICAgICAgICJyb3VuZFRyaXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfQp9LHt9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJhY20iOiB7CiAgICAibmFtZSI6ICJBQ00iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYXBpZ2F0ZXdheSI6IHsKICAgICJuYW1lIjogIkFQSUdhdGV3YXkiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYXBwbGljYXRpb25hdXRvc2NhbGluZyI6IHsKICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24tYXV0b3NjYWxpbmciLAogICAgIm5hbWUiOiAiQXBwbGljYXRpb25BdXRvU2NhbGluZyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJhcHBzdHJlYW0iOiB7CiAgICAibmFtZSI6ICJBcHBTdHJlYW0iCiAgfSwKICAiYXV0b3NjYWxpbmciOiB7CiAgICAibmFtZSI6ICJBdXRvU2NhbGluZyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJiYXRjaCI6IHsKICAgICJuYW1lIjogIkJhdGNoIgogIH0sCiAgImJ1ZGdldHMiOiB7CiAgICAibmFtZSI6ICJCdWRnZXRzIgogIH0sCiAgImNsb3VkZGlyZWN0b3J5IjogewogICAgIm5hbWUiOiAiQ2xvdWREaXJlY3RvcnkiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxNi0wNS0xMCoiCiAgICBdCiAgfSwKICAiY2xvdWRmb3JtYXRpb24iOiB7CiAgICAibmFtZSI6ICJDbG91ZEZvcm1hdGlvbiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjbG91ZGZyb250IjogewogICAgIm5hbWUiOiAiQ2xvdWRGcm9udCIsCiAgICAidmVyc2lvbnMiOiBbCiAgICAgICIyMDEzLTA1LTEyKiIsCiAgICAgICIyMDEzLTExLTExKiIsCiAgICAgICIyMDE0LTA1LTMxKiIsCiAgICAgICIyMDE0LTEwLTIxKiIsCiAgICAgICIyMDE0LTExLTA2KiIsCiAgICAgICIyMDE1LTA0LTE3KiIsCiAgICAgICIyMDE1LTA3LTI3KiIsCiAgICAgICIyMDE1LTA5LTE3KiIsCiAgICAgICIyMDE2LTAxLTEzKiIsCiAgICAgICIyMDE2LTAxLTI4KiIsCiAgICAgICIyMDE2LTA4LTAxKiIsCiAgICAgICIyMDE2LTA4LTIwKiIsCiAgICAgICIyMDE2LTA5LTA3KiIsCiAgICAgICIyMDE2LTA5LTI5KiIsCiAgICAgICIyMDE2LTExLTI1KiIsCiAgICAgICIyMDE3LTAzLTI1KiIsCiAgICAgICIyMDE3LTEwLTMwKiIsCiAgICAgICIyMDE4LTA2LTE4KiIsCiAgICAgICIyMDE4LTExLTA1KiIsCiAgICAgICIyMDE5LTAzLTI2KiIKICAgIF0sCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjbG91ZGhzbSI6IHsKICAgICJuYW1lIjogIkNsb3VkSFNNIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNsb3Vkc2VhcmNoIjogewogICAgIm5hbWUiOiAiQ2xvdWRTZWFyY2giCiAgfSwKICAiY2xvdWRzZWFyY2hkb21haW4iOiB7CiAgICAibmFtZSI6ICJDbG91ZFNlYXJjaERvbWFpbiIKICB9LAogICJjbG91ZHRyYWlsIjogewogICAgIm5hbWUiOiAiQ2xvdWRUcmFpbCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjbG91ZHdhdGNoIjogewogICAgInByZWZpeCI6ICJtb25pdG9yaW5nIiwKICAgICJuYW1lIjogIkNsb3VkV2F0Y2giLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY2xvdWR3YXRjaGV2ZW50cyI6IHsKICAgICJwcmVmaXgiOiAiZXZlbnRzIiwKICAgICJuYW1lIjogIkNsb3VkV2F0Y2hFdmVudHMiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxNC0wMi0wMyoiCiAgICBdLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY2xvdWR3YXRjaGxvZ3MiOiB7CiAgICAicHJlZml4IjogImxvZ3MiLAogICAgIm5hbWUiOiAiQ2xvdWRXYXRjaExvZ3MiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29kZWJ1aWxkIjogewogICAgIm5hbWUiOiAiQ29kZUJ1aWxkIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvZGVjb21taXQiOiB7CiAgICAibmFtZSI6ICJDb2RlQ29tbWl0IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvZGVkZXBsb3kiOiB7CiAgICAibmFtZSI6ICJDb2RlRGVwbG95IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvZGVwaXBlbGluZSI6IHsKICAgICJuYW1lIjogIkNvZGVQaXBlbGluZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb2duaXRvaWRlbnRpdHkiOiB7CiAgICAicHJlZml4IjogImNvZ25pdG8taWRlbnRpdHkiLAogICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvZ25pdG9pZGVudGl0eXNlcnZpY2Vwcm92aWRlciI6IHsKICAgICJwcmVmaXgiOiAiY29nbml0by1pZHAiLAogICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5U2VydmljZVByb3ZpZGVyIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvZ25pdG9zeW5jIjogewogICAgInByZWZpeCI6ICJjb2duaXRvLXN5bmMiLAogICAgIm5hbWUiOiAiQ29nbml0b1N5bmMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29uZmlnc2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAiY29uZmlnIiwKICAgICJuYW1lIjogIkNvbmZpZ1NlcnZpY2UiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29ubmVjdCI6IHsKICAgICJuYW1lIjogIkNvbm5lY3QiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY3VyIjogewogICAgIm5hbWUiOiAiQ1VSIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImRhdGFwaXBlbGluZSI6IHsKICAgICJuYW1lIjogIkRhdGFQaXBlbGluZSIKICB9LAogICJkZXZpY2VmYXJtIjogewogICAgIm5hbWUiOiAiRGV2aWNlRmFybSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJkaXJlY3Rjb25uZWN0IjogewogICAgIm5hbWUiOiAiRGlyZWN0Q29ubmVjdCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJkaXJlY3RvcnlzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJkcyIsCiAgICAibmFtZSI6ICJEaXJlY3RvcnlTZXJ2aWNlIgogIH0sCiAgImRpc2NvdmVyeSI6IHsKICAgICJuYW1lIjogIkRpc2NvdmVyeSIKICB9LAogICJkbXMiOiB7CiAgICAibmFtZSI6ICJETVMiCiAgfSwKICAiZHluYW1vZGIiOiB7CiAgICAibmFtZSI6ICJEeW5hbW9EQiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJkeW5hbW9kYnN0cmVhbXMiOiB7CiAgICAicHJlZml4IjogInN0cmVhbXMuZHluYW1vZGIiLAogICAgIm5hbWUiOiAiRHluYW1vREJTdHJlYW1zIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVjMiI6IHsKICAgICJuYW1lIjogIkVDMiIsCiAgICAidmVyc2lvbnMiOiBbCiAgICAgICIyMDEzLTA2LTE1KiIsCiAgICAgICIyMDEzLTEwLTE1KiIsCiAgICAgICIyMDE0LTAyLTAxKiIsCiAgICAgICIyMDE0LTA1LTAxKiIsCiAgICAgICIyMDE0LTA2LTE1KiIsCiAgICAgICIyMDE0LTA5LTAxKiIsCiAgICAgICIyMDE0LTEwLTAxKiIsCiAgICAgICIyMDE1LTAzLTAxKiIsCiAgICAgICIyMDE1LTA0LTE1KiIsCiAgICAgICIyMDE1LTEwLTAxKiIsCiAgICAgICIyMDE2LTA0LTAxKiIsCiAgICAgICIyMDE2LTA5LTE1KiIKICAgIF0sCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlY3IiOiB7CiAgICAibmFtZSI6ICJFQ1IiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWNzIjogewogICAgIm5hbWUiOiAiRUNTIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVmcyI6IHsKICAgICJwcmVmaXgiOiAiZWxhc3RpY2ZpbGVzeXN0ZW0iLAogICAgIm5hbWUiOiAiRUZTIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVsYXN0aWNhY2hlIjogewogICAgIm5hbWUiOiAiRWxhc3RpQ2FjaGUiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxMi0xMS0xNSoiLAogICAgICAiMjAxNC0wMy0yNCoiLAogICAgICAiMjAxNC0wNy0xNSoiLAogICAgICAiMjAxNC0wOS0zMCoiCiAgICBdLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWxhc3RpY2JlYW5zdGFsayI6IHsKICAgICJuYW1lIjogIkVsYXN0aWNCZWFuc3RhbGsiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWxiIjogewogICAgInByZWZpeCI6ICJlbGFzdGljbG9hZGJhbGFuY2luZyIsCiAgICAibmFtZSI6ICJFTEIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWxidjIiOiB7CiAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5ndjIiLAogICAgIm5hbWUiOiAiRUxCdjIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZW1yIjogewogICAgInByZWZpeCI6ICJlbGFzdGljbWFwcmVkdWNlIiwKICAgICJuYW1lIjogIkVNUiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlcyI6IHsKICAgICJuYW1lIjogIkVTIgogIH0sCiAgImVsYXN0aWN0cmFuc2NvZGVyIjogewogICAgIm5hbWUiOiAiRWxhc3RpY1RyYW5zY29kZXIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZmlyZWhvc2UiOiB7CiAgICAibmFtZSI6ICJGaXJlaG9zZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJnYW1lbGlmdCI6IHsKICAgICJuYW1lIjogIkdhbWVMaWZ0IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImdsYWNpZXIiOiB7CiAgICAibmFtZSI6ICJHbGFjaWVyIgogIH0sCiAgImhlYWx0aCI6IHsKICAgICJuYW1lIjogIkhlYWx0aCIKICB9LAogICJpYW0iOiB7CiAgICAibmFtZSI6ICJJQU0iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiaW1wb3J0ZXhwb3J0IjogewogICAgIm5hbWUiOiAiSW1wb3J0RXhwb3J0IgogIH0sCiAgImluc3BlY3RvciI6IHsKICAgICJuYW1lIjogIkluc3BlY3RvciIsCiAgICAidmVyc2lvbnMiOiBbCiAgICAgICIyMDE1LTA4LTE4KiIKICAgIF0sCiAgICAiY29ycyI6IHRydWUKICB9LAogICJpb3QiOiB7CiAgICAibmFtZSI6ICJJb3QiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiaW90ZGF0YSI6IHsKICAgICJwcmVmaXgiOiAiaW90LWRhdGEiLAogICAgIm5hbWUiOiAiSW90RGF0YSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJraW5lc2lzIjogewogICAgIm5hbWUiOiAiS2luZXNpcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJraW5lc2lzYW5hbHl0aWNzIjogewogICAgIm5hbWUiOiAiS2luZXNpc0FuYWx5dGljcyIKICB9LAogICJrbXMiOiB7CiAgICAibmFtZSI6ICJLTVMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibGFtYmRhIjogewogICAgIm5hbWUiOiAiTGFtYmRhIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImxleHJ1bnRpbWUiOiB7CiAgICAicHJlZml4IjogInJ1bnRpbWUubGV4IiwKICAgICJuYW1lIjogIkxleFJ1bnRpbWUiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibGlnaHRzYWlsIjogewogICAgIm5hbWUiOiAiTGlnaHRzYWlsIgogIH0sCiAgIm1hY2hpbmVsZWFybmluZyI6IHsKICAgICJuYW1lIjogIk1hY2hpbmVMZWFybmluZyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJtYXJrZXRwbGFjZWNvbW1lcmNlYW5hbHl0aWNzIjogewogICAgIm5hbWUiOiAiTWFya2V0cGxhY2VDb21tZXJjZUFuYWx5dGljcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJtYXJrZXRwbGFjZW1ldGVyaW5nIjogewogICAgInByZWZpeCI6ICJtZXRlcmluZ21hcmtldHBsYWNlIiwKICAgICJuYW1lIjogIk1hcmtldHBsYWNlTWV0ZXJpbmciCiAgfSwKICAibXR1cmsiOiB7CiAgICAicHJlZml4IjogIm10dXJrLXJlcXVlc3RlciIsCiAgICAibmFtZSI6ICJNVHVyayIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJtb2JpbGVhbmFseXRpY3MiOiB7CiAgICAibmFtZSI6ICJNb2JpbGVBbmFseXRpY3MiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAib3Bzd29ya3MiOiB7CiAgICAibmFtZSI6ICJPcHNXb3JrcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJvcHN3b3Jrc2NtIjogewogICAgIm5hbWUiOiAiT3BzV29ya3NDTSIKICB9LAogICJvcmdhbml6YXRpb25zIjogewogICAgIm5hbWUiOiAiT3JnYW5pemF0aW9ucyIKICB9LAogICJwaW5wb2ludCI6IHsKICAgICJuYW1lIjogIlBpbnBvaW50IgogIH0sCiAgInBvbGx5IjogewogICAgIm5hbWUiOiAiUG9sbHkiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicmRzIjogewogICAgIm5hbWUiOiAiUkRTIiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTQtMDktMDEqIgogICAgXSwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInJlZHNoaWZ0IjogewogICAgIm5hbWUiOiAiUmVkc2hpZnQiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicmVrb2duaXRpb24iOiB7CiAgICAibmFtZSI6ICJSZWtvZ25pdGlvbiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJyZXNvdXJjZWdyb3Vwc3RhZ2dpbmdhcGkiOiB7CiAgICAibmFtZSI6ICJSZXNvdXJjZUdyb3Vwc1RhZ2dpbmdBUEkiCiAgfSwKICAicm91dGU1MyI6IHsKICAgICJuYW1lIjogIlJvdXRlNTMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicm91dGU1M2RvbWFpbnMiOiB7CiAgICAibmFtZSI6ICJSb3V0ZTUzRG9tYWlucyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzMyI6IHsKICAgICJuYW1lIjogIlMzIiwKICAgICJkdWFsc3RhY2tBdmFpbGFibGUiOiB0cnVlLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiczNjb250cm9sIjogewogICAgIm5hbWUiOiAiUzNDb250cm9sIiwKICAgICJkdWFsc3RhY2tBdmFpbGFibGUiOiB0cnVlLAogICAgInhtbE5vRGVmYXVsdExpc3RzIjogdHJ1ZQogIH0sCiAgInNlcnZpY2VjYXRhbG9nIjogewogICAgIm5hbWUiOiAiU2VydmljZUNhdGFsb2ciLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic2VzIjogewogICAgInByZWZpeCI6ICJlbWFpbCIsCiAgICAibmFtZSI6ICJTRVMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic2hpZWxkIjogewogICAgIm5hbWUiOiAiU2hpZWxkIgogIH0sCiAgInNpbXBsZWRiIjogewogICAgInByZWZpeCI6ICJzZGIiLAogICAgIm5hbWUiOiAiU2ltcGxlREIiCiAgfSwKICAic21zIjogewogICAgIm5hbWUiOiAiU01TIgogIH0sCiAgInNub3diYWxsIjogewogICAgIm5hbWUiOiAiU25vd2JhbGwiCiAgfSwKICAic25zIjogewogICAgIm5hbWUiOiAiU05TIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInNxcyI6IHsKICAgICJuYW1lIjogIlNRUyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzc20iOiB7CiAgICAibmFtZSI6ICJTU00iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic3RvcmFnZWdhdGV3YXkiOiB7CiAgICAibmFtZSI6ICJTdG9yYWdlR2F0ZXdheSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzdGVwZnVuY3Rpb25zIjogewogICAgInByZWZpeCI6ICJzdGF0ZXMiLAogICAgIm5hbWUiOiAiU3RlcEZ1bmN0aW9ucyIKICB9LAogICJzdHMiOiB7CiAgICAibmFtZSI6ICJTVFMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic3VwcG9ydCI6IHsKICAgICJuYW1lIjogIlN1cHBvcnQiCiAgfSwKICAic3dmIjogewogICAgIm5hbWUiOiAiU1dGIgogIH0sCiAgInhyYXkiOiB7CiAgICAibmFtZSI6ICJYUmF5IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIndhZiI6IHsKICAgICJuYW1lIjogIldBRiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJ3YWZyZWdpb25hbCI6IHsKICAgICJwcmVmaXgiOiAid2FmLXJlZ2lvbmFsIiwKICAgICJuYW1lIjogIldBRlJlZ2lvbmFsIgogIH0sCiAgIndvcmtkb2NzIjogewogICAgIm5hbWUiOiAiV29ya0RvY3MiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAid29ya3NwYWNlcyI6IHsKICAgICJuYW1lIjogIldvcmtTcGFjZXMiCiAgfSwKICAiY29kZXN0YXIiOiB7CiAgICAibmFtZSI6ICJDb2RlU3RhciIKICB9LAogICJsZXhtb2RlbGJ1aWxkaW5nc2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAibGV4LW1vZGVscyIsCiAgICAibmFtZSI6ICJMZXhNb2RlbEJ1aWxkaW5nU2VydmljZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJtYXJrZXRwbGFjZWVudGl0bGVtZW50c2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAiZW50aXRsZW1lbnQubWFya2V0cGxhY2UiLAogICAgIm5hbWUiOiAiTWFya2V0cGxhY2VFbnRpdGxlbWVudFNlcnZpY2UiCiAgfSwKICAiYXRoZW5hIjogewogICAgIm5hbWUiOiAiQXRoZW5hIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImdyZWVuZ3Jhc3MiOiB7CiAgICAibmFtZSI6ICJHcmVlbmdyYXNzIgogIH0sCiAgImRheCI6IHsKICAgICJuYW1lIjogIkRBWCIKICB9LAogICJtaWdyYXRpb25odWIiOiB7CiAgICAicHJlZml4IjogIkFXU01pZ3JhdGlvbkh1YiIsCiAgICAibmFtZSI6ICJNaWdyYXRpb25IdWIiCiAgfSwKICAiY2xvdWRoc212MiI6IHsKICAgICJuYW1lIjogIkNsb3VkSFNNVjIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZ2x1ZSI6IHsKICAgICJuYW1lIjogIkdsdWUiCiAgfSwKICAibW9iaWxlIjogewogICAgIm5hbWUiOiAiTW9iaWxlIgogIH0sCiAgInByaWNpbmciOiB7CiAgICAibmFtZSI6ICJQcmljaW5nIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvc3RleHBsb3JlciI6IHsKICAgICJwcmVmaXgiOiAiY2UiLAogICAgIm5hbWUiOiAiQ29zdEV4cGxvcmVyIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIm1lZGlhY29udmVydCI6IHsKICAgICJuYW1lIjogIk1lZGlhQ29udmVydCIKICB9LAogICJtZWRpYWxpdmUiOiB7CiAgICAibmFtZSI6ICJNZWRpYUxpdmUiCiAgfSwKICAibWVkaWFwYWNrYWdlIjogewogICAgIm5hbWUiOiAiTWVkaWFQYWNrYWdlIgogIH0sCiAgIm1lZGlhc3RvcmUiOiB7CiAgICAibmFtZSI6ICJNZWRpYVN0b3JlIgogIH0sCiAgIm1lZGlhc3RvcmVkYXRhIjogewogICAgInByZWZpeCI6ICJtZWRpYXN0b3JlLWRhdGEiLAogICAgIm5hbWUiOiAiTWVkaWFTdG9yZURhdGEiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYXBwc3luYyI6IHsKICAgICJuYW1lIjogIkFwcFN5bmMiCiAgfSwKICAiZ3VhcmRkdXR5IjogewogICAgIm5hbWUiOiAiR3VhcmREdXR5IgogIH0sCiAgIm1xIjogewogICAgIm5hbWUiOiAiTVEiCiAgfSwKICAiY29tcHJlaGVuZCI6IHsKICAgICJuYW1lIjogIkNvbXByZWhlbmQiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiaW90am9ic2RhdGFwbGFuZSI6IHsKICAgICJwcmVmaXgiOiAiaW90LWpvYnMtZGF0YSIsCiAgICAibmFtZSI6ICJJb1RKb2JzRGF0YVBsYW5lIgogIH0sCiAgImtpbmVzaXN2aWRlb2FyY2hpdmVkbWVkaWEiOiB7CiAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tYXJjaGl2ZWQtbWVkaWEiLAogICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvQXJjaGl2ZWRNZWRpYSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJraW5lc2lzdmlkZW9tZWRpYSI6IHsKICAgICJwcmVmaXgiOiAia2luZXNpcy12aWRlby1tZWRpYSIsCiAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9NZWRpYSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJraW5lc2lzdmlkZW8iOiB7CiAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW8iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic2FnZW1ha2VycnVudGltZSI6IHsKICAgICJwcmVmaXgiOiAicnVudGltZS5zYWdlbWFrZXIiLAogICAgIm5hbWUiOiAiU2FnZU1ha2VyUnVudGltZSIKICB9LAogICJzYWdlbWFrZXIiOiB7CiAgICAibmFtZSI6ICJTYWdlTWFrZXIiCiAgfSwKICAidHJhbnNsYXRlIjogewogICAgIm5hbWUiOiAiVHJhbnNsYXRlIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInJlc291cmNlZ3JvdXBzIjogewogICAgInByZWZpeCI6ICJyZXNvdXJjZS1ncm91cHMiLAogICAgIm5hbWUiOiAiUmVzb3VyY2VHcm91cHMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYWxleGFmb3JidXNpbmVzcyI6IHsKICAgICJuYW1lIjogIkFsZXhhRm9yQnVzaW5lc3MiCiAgfSwKICAiY2xvdWQ5IjogewogICAgIm5hbWUiOiAiQ2xvdWQ5IgogIH0sCiAgInNlcnZlcmxlc3NhcHBsaWNhdGlvbnJlcG9zaXRvcnkiOiB7CiAgICAicHJlZml4IjogInNlcnZlcmxlc3NyZXBvIiwKICAgICJuYW1lIjogIlNlcnZlcmxlc3NBcHBsaWNhdGlvblJlcG9zaXRvcnkiCiAgfSwKICAic2VydmljZWRpc2NvdmVyeSI6IHsKICAgICJuYW1lIjogIlNlcnZpY2VEaXNjb3ZlcnkiCiAgfSwKICAid29ya21haWwiOiB7CiAgICAibmFtZSI6ICJXb3JrTWFpbCIKICB9LAogICJhdXRvc2NhbGluZ3BsYW5zIjogewogICAgInByZWZpeCI6ICJhdXRvc2NhbGluZy1wbGFucyIsCiAgICAibmFtZSI6ICJBdXRvU2NhbGluZ1BsYW5zIgogIH0sCiAgInRyYW5zY3JpYmVzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJ0cmFuc2NyaWJlIiwKICAgICJuYW1lIjogIlRyYW5zY3JpYmVTZXJ2aWNlIgogIH0sCiAgImNvbm5lY3QiOiB7CiAgICAibmFtZSI6ICJDb25uZWN0IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImFjbXBjYSI6IHsKICAgICJwcmVmaXgiOiAiYWNtLXBjYSIsCiAgICAibmFtZSI6ICJBQ01QQ0EiCiAgfSwKICAiZm1zIjogewogICAgIm5hbWUiOiAiRk1TIgogIH0sCiAgInNlY3JldHNtYW5hZ2VyIjogewogICAgIm5hbWUiOiAiU2VjcmV0c01hbmFnZXIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiaW90YW5hbHl0aWNzIjogewogICAgIm5hbWUiOiAiSW9UQW5hbHl0aWNzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImlvdDFjbGlja2RldmljZXNzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJpb3QxY2xpY2stZGV2aWNlcyIsCiAgICAibmFtZSI6ICJJb1QxQ2xpY2tEZXZpY2VzU2VydmljZSIKICB9LAogICJpb3QxY2xpY2twcm9qZWN0cyI6IHsKICAgICJwcmVmaXgiOiAiaW90MWNsaWNrLXByb2plY3RzIiwKICAgICJuYW1lIjogIklvVDFDbGlja1Byb2plY3RzIgogIH0sCiAgInBpIjogewogICAgIm5hbWUiOiAiUEkiCiAgfSwKICAibmVwdHVuZSI6IHsKICAgICJuYW1lIjogIk5lcHR1bmUiCiAgfSwKICAibWVkaWF0YWlsb3IiOiB7CiAgICAibmFtZSI6ICJNZWRpYVRhaWxvciIKICB9LAogICJla3MiOiB7CiAgICAibmFtZSI6ICJFS1MiCiAgfSwKICAibWFjaWUiOiB7CiAgICAibmFtZSI6ICJNYWNpZSIKICB9LAogICJkbG0iOiB7CiAgICAibmFtZSI6ICJETE0iCiAgfSwKICAic2lnbmVyIjogewogICAgIm5hbWUiOiAiU2lnbmVyIgogIH0sCiAgImNoaW1lIjogewogICAgIm5hbWUiOiAiQ2hpbWUiCiAgfSwKICAicGlucG9pbnRlbWFpbCI6IHsKICAgICJwcmVmaXgiOiAicGlucG9pbnQtZW1haWwiLAogICAgIm5hbWUiOiAiUGlucG9pbnRFbWFpbCIKICB9LAogICJyYW0iOiB7CiAgICAibmFtZSI6ICJSQU0iCiAgfSwKICAicm91dGU1M3Jlc29sdmVyIjogewogICAgIm5hbWUiOiAiUm91dGU1M1Jlc29sdmVyIgogIH0sCiAgInBpbnBvaW50c21zdm9pY2UiOiB7CiAgICAicHJlZml4IjogInNtcy12b2ljZSIsCiAgICAibmFtZSI6ICJQaW5wb2ludFNNU1ZvaWNlIgogIH0sCiAgInF1aWNrc2lnaHQiOiB7CiAgICAibmFtZSI6ICJRdWlja1NpZ2h0IgogIH0sCiAgInJkc2RhdGFzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJyZHMtZGF0YSIsCiAgICAibmFtZSI6ICJSRFNEYXRhU2VydmljZSIKICB9LAogICJhbXBsaWZ5IjogewogICAgIm5hbWUiOiAiQW1wbGlmeSIKICB9LAogICJkYXRhc3luYyI6IHsKICAgICJuYW1lIjogIkRhdGFTeW5jIgogIH0sCiAgInJvYm9tYWtlciI6IHsKICAgICJuYW1lIjogIlJvYm9NYWtlciIKICB9LAogICJ0cmFuc2ZlciI6IHsKICAgICJuYW1lIjogIlRyYW5zZmVyIgogIH0sCiAgImdsb2JhbGFjY2VsZXJhdG9yIjogewogICAgIm5hbWUiOiAiR2xvYmFsQWNjZWxlcmF0b3IiCiAgfSwKICAiY29tcHJlaGVuZG1lZGljYWwiOiB7CiAgICAibmFtZSI6ICJDb21wcmVoZW5kTWVkaWNhbCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJraW5lc2lzYW5hbHl0aWNzdjIiOiB7CiAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzVjIiCiAgfSwKICAibWVkaWFjb25uZWN0IjogewogICAgIm5hbWUiOiAiTWVkaWFDb25uZWN0IgogIH0sCiAgImZzeCI6IHsKICAgICJuYW1lIjogIkZTeCIKICB9LAogICJzZWN1cml0eWh1YiI6IHsKICAgICJuYW1lIjogIlNlY3VyaXR5SHViIgogIH0sCiAgImFwcG1lc2giOiB7CiAgICAibmFtZSI6ICJBcHBNZXNoIiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTgtMTAtMDEqIgogICAgXQogIH0sCiAgImxpY2Vuc2VtYW5hZ2VyIjogewogICAgInByZWZpeCI6ICJsaWNlbnNlLW1hbmFnZXIiLAogICAgIm5hbWUiOiAiTGljZW5zZU1hbmFnZXIiCiAgfSwKICAia2Fma2EiOiB7CiAgICAibmFtZSI6ICJLYWZrYSIKICB9LAogICJhcGlnYXRld2F5bWFuYWdlbWVudGFwaSI6IHsKICAgICJuYW1lIjogIkFwaUdhdGV3YXlNYW5hZ2VtZW50QXBpIgogIH0sCiAgImFwaWdhdGV3YXl2MiI6IHsKICAgICJuYW1lIjogIkFwaUdhdGV3YXlWMiIKICB9LAogICJkb2NkYiI6IHsKICAgICJuYW1lIjogIkRvY0RCIgogIH0sCiAgImJhY2t1cCI6IHsKICAgICJuYW1lIjogIkJhY2t1cCIKICB9LAogICJ3b3JrbGluayI6IHsKICAgICJuYW1lIjogIldvcmtMaW5rIgogIH0sCiAgInRleHRyYWN0IjogewogICAgIm5hbWUiOiAiVGV4dHJhY3QiCiAgfSwKICAibWFuYWdlZGJsb2NrY2hhaW4iOiB7CiAgICAibmFtZSI6ICJNYW5hZ2VkQmxvY2tjaGFpbiIKICB9LAogICJtZWRpYXBhY2thZ2V2b2QiOiB7CiAgICAicHJlZml4IjogIm1lZGlhcGFja2FnZS12b2QiLAogICAgIm5hbWUiOiAiTWVkaWFQYWNrYWdlVm9kIgogIH0sCiAgImdyb3VuZHN0YXRpb24iOiB7CiAgICAibmFtZSI6ICJHcm91bmRTdGF0aW9uIgogIH0sCiAgImlvdHRoaW5nc2dyYXBoIjogewogICAgIm5hbWUiOiAiSW9UVGhpbmdzR3JhcGgiCiAgfSwKICAiaW90ZXZlbnRzIjogewogICAgIm5hbWUiOiAiSW9URXZlbnRzIgogIH0sCiAgImlvdGV2ZW50c2RhdGEiOiB7CiAgICAicHJlZml4IjogImlvdGV2ZW50cy1kYXRhIiwKICAgICJuYW1lIjogIklvVEV2ZW50c0RhdGEiCiAgfSwKICAicGVyc29uYWxpemUiOiB7CiAgICAibmFtZSI6ICJQZXJzb25hbGl6ZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJwZXJzb25hbGl6ZWV2ZW50cyI6IHsKICAgICJwcmVmaXgiOiAicGVyc29uYWxpemUtZXZlbnRzIiwKICAgICJuYW1lIjogIlBlcnNvbmFsaXplRXZlbnRzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInBlcnNvbmFsaXplcnVudGltZSI6IHsKICAgICJwcmVmaXgiOiAicGVyc29uYWxpemUtcnVudGltZSIsCiAgICAibmFtZSI6ICJQZXJzb25hbGl6ZVJ1bnRpbWUiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYXBwbGljYXRpb25pbnNpZ2h0cyI6IHsKICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24taW5zaWdodHMiLAogICAgIm5hbWUiOiAiQXBwbGljYXRpb25JbnNpZ2h0cyIKICB9LAogICJzZXJ2aWNlcXVvdGFzIjogewogICAgInByZWZpeCI6ICJzZXJ2aWNlLXF1b3RhcyIsCiAgICAibmFtZSI6ICJTZXJ2aWNlUXVvdGFzIgogIH0sCiAgImVjMmluc3RhbmNlY29ubmVjdCI6IHsKICAgICJwcmVmaXgiOiAiZWMyLWluc3RhbmNlLWNvbm5lY3QiLAogICAgIm5hbWUiOiAiRUMySW5zdGFuY2VDb25uZWN0IgogIH0sCiAgImV2ZW50YnJpZGdlIjogewogICAgIm5hbWUiOiAiRXZlbnRCcmlkZ2UiCiAgfSwKICAibGFrZWZvcm1hdGlvbiI6IHsKICAgICJuYW1lIjogIkxha2VGb3JtYXRpb24iCiAgfSwKICAiZm9yZWNhc3RzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJmb3JlY2FzdCIsCiAgICAibmFtZSI6ICJGb3JlY2FzdFNlcnZpY2UiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZm9yZWNhc3RxdWVyeXNlcnZpY2UiOiB7CiAgICAicHJlZml4IjogImZvcmVjYXN0cXVlcnkiLAogICAgIm5hbWUiOiAiRm9yZWNhc3RRdWVyeVNlcnZpY2UiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicWxkYiI6IHsKICAgICJuYW1lIjogIlFMREIiCiAgfSwKICAicWxkYnNlc3Npb24iOiB7CiAgICAicHJlZml4IjogInFsZGItc2Vzc2lvbiIsCiAgICAibmFtZSI6ICJRTERCU2Vzc2lvbiIKICB9LAogICJ3b3JrbWFpbG1lc3NhZ2VmbG93IjogewogICAgIm5hbWUiOiAiV29ya01haWxNZXNzYWdlRmxvdyIKICB9LAogICJjb2Rlc3Rhcm5vdGlmaWNhdGlvbnMiOiB7CiAgICAicHJlZml4IjogImNvZGVzdGFyLW5vdGlmaWNhdGlvbnMiLAogICAgIm5hbWUiOiAiQ29kZVN0YXJOb3RpZmljYXRpb25zIgogIH0sCiAgInNhdmluZ3NwbGFucyI6IHsKICAgICJuYW1lIjogIlNhdmluZ3NQbGFucyIKICB9LAogICJzc28iOiB7CiAgICAibmFtZSI6ICJTU08iCiAgfSwKICAic3Nvb2lkYyI6IHsKICAgICJwcmVmaXgiOiAic3NvLW9pZGMiLAogICAgIm5hbWUiOiAiU1NPT0lEQyIKICB9LAogICJtYXJrZXRwbGFjZWNhdGFsb2ciOiB7CiAgICAicHJlZml4IjogIm1hcmtldHBsYWNlLWNhdGFsb2ciLAogICAgIm5hbWUiOiAiTWFya2V0cGxhY2VDYXRhbG9nIgogIH0sCiAgImRhdGFleGNoYW5nZSI6IHsKICAgICJuYW1lIjogIkRhdGFFeGNoYW5nZSIKICB9LAogICJzZXN2MiI6IHsKICAgICJuYW1lIjogIlNFU1YyIgogIH0sCiAgIm1pZ3JhdGlvbmh1YmNvbmZpZyI6IHsKICAgICJwcmVmaXgiOiAibWlncmF0aW9uaHViLWNvbmZpZyIsCiAgICAibmFtZSI6ICJNaWdyYXRpb25IdWJDb25maWciCiAgfSwKICAiY29ubmVjdHBhcnRpY2lwYW50IjogewogICAgIm5hbWUiOiAiQ29ubmVjdFBhcnRpY2lwYW50IgogIH0sCiAgImFwcGNvbmZpZyI6IHsKICAgICJuYW1lIjogIkFwcENvbmZpZyIKICB9LAogICJpb3RzZWN1cmV0dW5uZWxpbmciOiB7CiAgICAibmFtZSI6ICJJb1RTZWN1cmVUdW5uZWxpbmciCiAgfSwKICAid2FmdjIiOiB7CiAgICAibmFtZSI6ICJXQUZWMiIKICB9LAogICJlbGFzdGljaW5mZXJlbmNlIjogewogICAgInByZWZpeCI6ICJlbGFzdGljLWluZmVyZW5jZSIsCiAgICAibmFtZSI6ICJFbGFzdGljSW5mZXJlbmNlIgogIH0sCiAgImltYWdlYnVpbGRlciI6IHsKICAgICJuYW1lIjogIkltYWdlYnVpbGRlciIKICB9LAogICJzY2hlbWFzIjogewogICAgIm5hbWUiOiAiU2NoZW1hcyIKICB9LAogICJhY2Nlc3NhbmFseXplciI6IHsKICAgICJuYW1lIjogIkFjY2Vzc0FuYWx5emVyIgogIH0sCiAgImNvZGVndXJ1cmV2aWV3ZXIiOiB7CiAgICAicHJlZml4IjogImNvZGVndXJ1LXJldmlld2VyIiwKICAgICJuYW1lIjogIkNvZGVHdXJ1UmV2aWV3ZXIiCiAgfSwKICAiY29kZWd1cnVwcm9maWxlciI6IHsKICAgICJuYW1lIjogIkNvZGVHdXJ1UHJvZmlsZXIiCiAgfSwKICAiY29tcHV0ZW9wdGltaXplciI6IHsKICAgICJwcmVmaXgiOiAiY29tcHV0ZS1vcHRpbWl6ZXIiLAogICAgIm5hbWUiOiAiQ29tcHV0ZU9wdGltaXplciIKICB9LAogICJmcmF1ZGRldGVjdG9yIjogewogICAgIm5hbWUiOiAiRnJhdWREZXRlY3RvciIKICB9LAogICJrZW5kcmEiOiB7CiAgICAibmFtZSI6ICJLZW5kcmEiCiAgfSwKICAibmV0d29ya21hbmFnZXIiOiB7CiAgICAibmFtZSI6ICJOZXR3b3JrTWFuYWdlciIKICB9LAogICJvdXRwb3N0cyI6IHsKICAgICJuYW1lIjogIk91dHBvc3RzIgogIH0sCiAgImF1Z21lbnRlZGFpcnVudGltZSI6IHsKICAgICJwcmVmaXgiOiAic2FnZW1ha2VyLWEyaS1ydW50aW1lIiwKICAgICJuYW1lIjogIkF1Z21lbnRlZEFJUnVudGltZSIKICB9LAogICJlYnMiOiB7CiAgICAibmFtZSI6ICJFQlMiCiAgfSwKICAia2luZXNpc3ZpZGVvc2lnbmFsaW5nY2hhbm5lbHMiOiB7CiAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tc2lnbmFsaW5nIiwKICAgICJuYW1lIjogIktpbmVzaXNWaWRlb1NpZ25hbGluZ0NoYW5uZWxzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImRldGVjdGl2ZSI6IHsKICAgICJuYW1lIjogIkRldGVjdGl2ZSIKICB9LAogICJjb2Rlc3RhcmNvbm5lY3Rpb25zIjogewogICAgInByZWZpeCI6ICJjb2Rlc3Rhci1jb25uZWN0aW9ucyIsCiAgICAibmFtZSI6ICJDb2RlU3RhcmNvbm5lY3Rpb25zIgogIH0sCiAgInN5bnRoZXRpY3MiOiB7CiAgICAibmFtZSI6ICJTeW50aGV0aWNzIgogIH0sCiAgImlvdHNpdGV3aXNlIjogewogICAgIm5hbWUiOiAiSW9UU2l0ZVdpc2UiCiAgfSwKICAibWFjaWUyIjogewogICAgIm5hbWUiOiAiTWFjaWUyIgogIH0sCiAgImNvZGVhcnRpZmFjdCI6IHsKICAgICJuYW1lIjogIkNvZGVBcnRpZmFjdCIKICB9LAogICJob25leWNvZGUiOiB7CiAgICAibmFtZSI6ICJIb25leWNvZGUiCiAgfSwKICAiaXZzIjogewogICAgIm5hbWUiOiAiSVZTIgogIH0sCiAgImJyYWtldCI6IHsKICAgICJuYW1lIjogIkJyYWtldCIKICB9LAogICJpZGVudGl0eXN0b3JlIjogewogICAgIm5hbWUiOiAiSWRlbnRpdHlTdG9yZSIKICB9LAogICJhcHBmbG93IjogewogICAgIm5hbWUiOiAiQXBwZmxvdyIKICB9LAogICJyZWRzaGlmdGRhdGEiOiB7CiAgICAicHJlZml4IjogInJlZHNoaWZ0LWRhdGEiLAogICAgIm5hbWUiOiAiUmVkc2hpZnREYXRhIgogIH0sCiAgInNzb2FkbWluIjogewogICAgInByZWZpeCI6ICJzc28tYWRtaW4iLAogICAgIm5hbWUiOiAiU1NPQWRtaW4iCiAgfSwKICAidGltZXN0cmVhbXF1ZXJ5IjogewogICAgInByZWZpeCI6ICJ0aW1lc3RyZWFtLXF1ZXJ5IiwKICAgICJuYW1lIjogIlRpbWVzdHJlYW1RdWVyeSIKICB9LAogICJ0aW1lc3RyZWFtd3JpdGUiOiB7CiAgICAicHJlZml4IjogInRpbWVzdHJlYW0td3JpdGUiLAogICAgIm5hbWUiOiAiVGltZXN0cmVhbVdyaXRlIgogIH0sCiAgInMzb3V0cG9zdHMiOiB7CiAgICAibmFtZSI6ICJTM091dHBvc3RzIgogIH0sCiAgImRhdGFicmV3IjogewogICAgIm5hbWUiOiAiRGF0YUJyZXciCiAgfSwKICAic2VydmljZWNhdGFsb2dhcHByZWdpc3RyeSI6IHsKICAgICJwcmVmaXgiOiAic2VydmljZWNhdGFsb2ctYXBwcmVnaXN0cnkiLAogICAgIm5hbWUiOiAiU2VydmljZUNhdGFsb2dBcHBSZWdpc3RyeSIKICB9LAogICJuZXR3b3JrZmlyZXdhbGwiOiB7CiAgICAicHJlZml4IjogIm5ldHdvcmstZmlyZXdhbGwiLAogICAgIm5hbWUiOiAiTmV0d29ya0ZpcmV3YWxsIgogIH0sCiAgIm13YWEiOiB7CiAgICAibmFtZSI6ICJNV0FBIgogIH0sCiAgImFtcGxpZnliYWNrZW5kIjogewogICAgIm5hbWUiOiAiQW1wbGlmeUJhY2tlbmQiCiAgfSwKICAiYXBwaW50ZWdyYXRpb25zIjogewogICAgIm5hbWUiOiAiQXBwSW50ZWdyYXRpb25zIgogIH0sCiAgImNvbm5lY3Rjb250YWN0bGVucyI6IHsKICAgICJwcmVmaXgiOiAiY29ubmVjdC1jb250YWN0LWxlbnMiLAogICAgIm5hbWUiOiAiQ29ubmVjdENvbnRhY3RMZW5zIgogIH0sCiAgImRldm9wc2d1cnUiOiB7CiAgICAicHJlZml4IjogImRldm9wcy1ndXJ1IiwKICAgICJuYW1lIjogIkRldk9wc0d1cnUiCiAgfSwKICAiZWNycHVibGljIjogewogICAgInByZWZpeCI6ICJlY3ItcHVibGljIiwKICAgICJuYW1lIjogIkVDUlBVQkxJQyIKICB9LAogICJsb29rb3V0dmlzaW9uIjogewogICAgIm5hbWUiOiAiTG9va291dFZpc2lvbiIKICB9LAogICJzYWdlbWFrZXJmZWF0dXJlc3RvcmVydW50aW1lIjogewogICAgInByZWZpeCI6ICJzYWdlbWFrZXItZmVhdHVyZXN0b3JlLXJ1bnRpbWUiLAogICAgIm5hbWUiOiAiU2FnZU1ha2VyRmVhdHVyZVN0b3JlUnVudGltZSIKICB9LAogICJjdXN0b21lcnByb2ZpbGVzIjogewogICAgInByZWZpeCI6ICJjdXN0b21lci1wcm9maWxlcyIsCiAgICAibmFtZSI6ICJDdXN0b21lclByb2ZpbGVzIgogIH0sCiAgImF1ZGl0bWFuYWdlciI6IHsKICAgICJuYW1lIjogIkF1ZGl0TWFuYWdlciIKICB9LAogICJlbXJjb250YWluZXJzIjogewogICAgInByZWZpeCI6ICJlbXItY29udGFpbmVycyIsCiAgICAibmFtZSI6ICJFTVJjb250YWluZXJzIgogIH0sCiAgImhlYWx0aGxha2UiOiB7CiAgICAibmFtZSI6ICJIZWFsdGhMYWtlIgogIH0sCiAgInNhZ2VtYWtlcmVkZ2UiOiB7CiAgICAicHJlZml4IjogInNhZ2VtYWtlci1lZGdlIiwKICAgICJuYW1lIjogIlNhZ2VtYWtlckVkZ2UiCiAgfSwKICAiYW1wIjogewogICAgIm5hbWUiOiAiQW1wIgogIH0sCiAgImdyZWVuZ3Jhc3N2MiI6IHsKICAgICJuYW1lIjogIkdyZWVuZ3Jhc3NWMiIKICB9LAogICJpb3RkZXZpY2VhZHZpc29yIjogewogICAgIm5hbWUiOiAiSW90RGV2aWNlQWR2aXNvciIKICB9LAogICJpb3RmbGVldGh1YiI6IHsKICAgICJuYW1lIjogIklvVEZsZWV0SHViIgogIH0sCiAgImlvdHdpcmVsZXNzIjogewogICAgIm5hbWUiOiAiSW9UV2lyZWxlc3MiCiAgfSwKICAibG9jYXRpb24iOiB7CiAgICAibmFtZSI6ICJMb2NhdGlvbiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJ3ZWxsYXJjaGl0ZWN0ZWQiOiB7CiAgICAibmFtZSI6ICJXZWxsQXJjaGl0ZWN0ZWQiCiAgfSwKICAibGV4bW9kZWxzdjIiOiB7CiAgICAicHJlZml4IjogIm1vZGVscy5sZXgudjIiLAogICAgIm5hbWUiOiAiTGV4TW9kZWxzVjIiCiAgfSwKICAibGV4cnVudGltZXYyIjogewogICAgInByZWZpeCI6ICJydW50aW1lLmxleC52MiIsCiAgICAibmFtZSI6ICJMZXhSdW50aW1lVjIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZmlzIjogewogICAgIm5hbWUiOiAiRmlzIgogIH0sCiAgImxvb2tvdXRtZXRyaWNzIjogewogICAgIm5hbWUiOiAiTG9va291dE1ldHJpY3MiCiAgfSwKICAibWduIjogewogICAgIm5hbWUiOiAiTWduIgogIH0sCiAgImxvb2tvdXRlcXVpcG1lbnQiOiB7CiAgICAibmFtZSI6ICJMb29rb3V0RXF1aXBtZW50IgogIH0sCiAgIm5pbWJsZSI6IHsKICAgICJuYW1lIjogIk5pbWJsZSIKICB9LAogICJmaW5zcGFjZSI6IHsKICAgICJuYW1lIjogIkZpbnNwYWNlIgogIH0sCiAgImZpbnNwYWNlZGF0YSI6IHsKICAgICJwcmVmaXgiOiAiZmluc3BhY2UtZGF0YSIsCiAgICAibmFtZSI6ICJGaW5zcGFjZWRhdGEiCiAgfSwKICAic3NtY29udGFjdHMiOiB7CiAgICAicHJlZml4IjogInNzbS1jb250YWN0cyIsCiAgICAibmFtZSI6ICJTU01Db250YWN0cyIKICB9LAogICJzc21pbmNpZGVudHMiOiB7CiAgICAicHJlZml4IjogInNzbS1pbmNpZGVudHMiLAogICAgIm5hbWUiOiAiU1NNSW5jaWRlbnRzIgogIH0sCiAgImFwcGxpY2F0aW9uY29zdHByb2ZpbGVyIjogewogICAgIm5hbWUiOiAiQXBwbGljYXRpb25Db3N0UHJvZmlsZXIiCiAgfSwKICAiYXBwcnVubmVyIjogewogICAgIm5hbWUiOiAiQXBwUnVubmVyIgogIH0sCiAgInByb3RvbiI6IHsKICAgICJuYW1lIjogIlByb3RvbiIKICB9LAogICJyb3V0ZTUzcmVjb3ZlcnljbHVzdGVyIjogewogICAgInByZWZpeCI6ICJyb3V0ZTUzLXJlY292ZXJ5LWNsdXN0ZXIiLAogICAgIm5hbWUiOiAiUm91dGU1M1JlY292ZXJ5Q2x1c3RlciIKICB9LAogICJyb3V0ZTUzcmVjb3Zlcnljb250cm9sY29uZmlnIjogewogICAgInByZWZpeCI6ICJyb3V0ZTUzLXJlY292ZXJ5LWNvbnRyb2wtY29uZmlnIiwKICAgICJuYW1lIjogIlJvdXRlNTNSZWNvdmVyeUNvbnRyb2xDb25maWciCiAgfSwKICAicm91dGU1M3JlY292ZXJ5cmVhZGluZXNzIjogewogICAgInByZWZpeCI6ICJyb3V0ZTUzLXJlY292ZXJ5LXJlYWRpbmVzcyIsCiAgICAibmFtZSI6ICJSb3V0ZTUzUmVjb3ZlcnlSZWFkaW5lc3MiCiAgfSwKICAiY2hpbWVzZGtpZGVudGl0eSI6IHsKICAgICJwcmVmaXgiOiAiY2hpbWUtc2RrLWlkZW50aXR5IiwKICAgICJuYW1lIjogIkNoaW1lU0RLSWRlbnRpdHkiCiAgfSwKICAiY2hpbWVzZGttZXNzYWdpbmciOiB7CiAgICAicHJlZml4IjogImNoaW1lLXNkay1tZXNzYWdpbmciLAogICAgIm5hbWUiOiAiQ2hpbWVTREtNZXNzYWdpbmciCiAgfSwKICAic25vd2RldmljZW1hbmFnZW1lbnQiOiB7CiAgICAicHJlZml4IjogInNub3ctZGV2aWNlLW1hbmFnZW1lbnQiLAogICAgIm5hbWUiOiAiU25vd0RldmljZU1hbmFnZW1lbnQiCiAgfSwKICAibWVtb3J5ZGIiOiB7CiAgICAibmFtZSI6ICJNZW1vcnlEQiIKICB9LAogICJvcGVuc2VhcmNoIjogewogICAgIm5hbWUiOiAiT3BlblNlYXJjaCIKICB9LAogICJrYWZrYWNvbm5lY3QiOiB7CiAgICAibmFtZSI6ICJLYWZrYUNvbm5lY3QiCiAgfSwKICAidm9pY2VpZCI6IHsKICAgICJwcmVmaXgiOiAidm9pY2UtaWQiLAogICAgIm5hbWUiOiAiVm9pY2VJRCIKICB9LAogICJ3aXNkb20iOiB7CiAgICAibmFtZSI6ICJXaXNkb20iCiAgfSwKICAiYWNjb3VudCI6IHsKICAgICJuYW1lIjogIkFjY291bnQiCiAgfSwKICAiY2xvdWRjb250cm9sIjogewogICAgIm5hbWUiOiAiQ2xvdWRDb250cm9sIgogIH0sCiAgImdyYWZhbmEiOiB7CiAgICAibmFtZSI6ICJHcmFmYW5hIgogIH0sCiAgInBhbm9yYW1hIjogewogICAgIm5hbWUiOiAiUGFub3JhbWEiCiAgfSwKICAiY2hpbWVzZGttZWV0aW5ncyI6IHsKICAgICJwcmVmaXgiOiAiY2hpbWUtc2RrLW1lZXRpbmdzIiwKICAgICJuYW1lIjogIkNoaW1lU0RLTWVldGluZ3MiCiAgfSwKICAicmVzaWxpZW5jZWh1YiI6IHsKICAgICJuYW1lIjogIlJlc2lsaWVuY2VodWIiCiAgfSwKICAibWlncmF0aW9uaHVic3RyYXRlZ3kiOiB7CiAgICAibmFtZSI6ICJNaWdyYXRpb25IdWJTdHJhdGVneSIKICB9LAogICJhcHBjb25maWdkYXRhIjogewogICAgIm5hbWUiOiAiQXBwQ29uZmlnRGF0YSIKICB9LAogICJkcnMiOiB7CiAgICAibmFtZSI6ICJEcnMiCiAgfSwKICAibWlncmF0aW9uaHVicmVmYWN0b3JzcGFjZXMiOiB7CiAgICAicHJlZml4IjogIm1pZ3JhdGlvbi1odWItcmVmYWN0b3Itc3BhY2VzIiwKICAgICJuYW1lIjogIk1pZ3JhdGlvbkh1YlJlZmFjdG9yU3BhY2VzIgogIH0sCiAgImV2aWRlbnRseSI6IHsKICAgICJuYW1lIjogIkV2aWRlbnRseSIKICB9LAogICJpbnNwZWN0b3IyIjogewogICAgIm5hbWUiOiAiSW5zcGVjdG9yMiIKICB9LAogICJyYmluIjogewogICAgIm5hbWUiOiAiUmJpbiIKICB9LAogICJydW0iOiB7CiAgICAibmFtZSI6ICJSVU0iCiAgfSwKICAiYmFja3VwZ2F0ZXdheSI6IHsKICAgICJwcmVmaXgiOiAiYmFja3VwLWdhdGV3YXkiLAogICAgIm5hbWUiOiAiQmFja3VwR2F0ZXdheSIKICB9LAogICJpb3R0d2lubWFrZXIiOiB7CiAgICAibmFtZSI6ICJJb1RUd2luTWFrZXIiCiAgfSwKICAid29ya3NwYWNlc3dlYiI6IHsKICAgICJwcmVmaXgiOiAid29ya3NwYWNlcy13ZWIiLAogICAgIm5hbWUiOiAiV29ya1NwYWNlc1dlYiIKICB9LAogICJhbXBsaWZ5dWlidWlsZGVyIjogewogICAgIm5hbWUiOiAiQW1wbGlmeVVJQnVpbGRlciIKICB9LAogICJrZXlzcGFjZXMiOiB7CiAgICAibmFtZSI6ICJLZXlzcGFjZXMiCiAgfSwKICAiYmlsbGluZ2NvbmR1Y3RvciI6IHsKICAgICJuYW1lIjogIkJpbGxpbmdjb25kdWN0b3IiCiAgfSwKICAiZ2FtZXNwYXJrcyI6IHsKICAgICJuYW1lIjogIkdhbWVTcGFya3MiCiAgfSwKICAicGlucG9pbnRzbXN2b2ljZXYyIjogewogICAgInByZWZpeCI6ICJwaW5wb2ludC1zbXMtdm9pY2UtdjIiLAogICAgIm5hbWUiOiAiUGlucG9pbnRTTVNWb2ljZVYyIgogIH0sCiAgIml2c2NoYXQiOiB7CiAgICAibmFtZSI6ICJJdnNjaGF0IgogIH0sCiAgImNoaW1lc2RrbWVkaWFwaXBlbGluZXMiOiB7CiAgICAicHJlZml4IjogImNoaW1lLXNkay1tZWRpYS1waXBlbGluZXMiLAogICAgIm5hbWUiOiAiQ2hpbWVTREtNZWRpYVBpcGVsaW5lcyIKICB9LAogICJlbXJzZXJ2ZXJsZXNzIjogewogICAgInByZWZpeCI6ICJlbXItc2VydmVybGVzcyIsCiAgICAibmFtZSI6ICJFTVJTZXJ2ZXJsZXNzIgogIH0sCiAgIm0yIjogewogICAgIm5hbWUiOiAiTTIiCiAgfSwKICAiY29ubmVjdGNhbXBhaWducyI6IHsKICAgICJuYW1lIjogIkNvbm5lY3RDYW1wYWlnbnMiCiAgfSwKICAicmVkc2hpZnRzZXJ2ZXJsZXNzIjogewogICAgInByZWZpeCI6ICJyZWRzaGlmdC1zZXJ2ZXJsZXNzIiwKICAgICJuYW1lIjogIlJlZHNoaWZ0U2VydmVybGVzcyIKICB9LAogICJyb2xlc2FueXdoZXJlIjogewogICAgIm5hbWUiOiAiUm9sZXNBbnl3aGVyZSIKICB9LAogICJsaWNlbnNlbWFuYWdlcnVzZXJzdWJzY3JpcHRpb25zIjogewogICAgInByZWZpeCI6ICJsaWNlbnNlLW1hbmFnZXItdXNlci1zdWJzY3JpcHRpb25zIiwKICAgICJuYW1lIjogIkxpY2Vuc2VNYW5hZ2VyVXNlclN1YnNjcmlwdGlvbnMiCiAgfQp9Cgp9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJ2ZXJzaW9uIjogIjIuMCIsCiAgIm1ldGFkYXRhIjogewogICAgImFwaVZlcnNpb24iOiAiMjAxMS0wNi0xNSIsCiAgICAiZW5kcG9pbnRQcmVmaXgiOiAic3RzIiwKICAgICJnbG9iYWxFbmRwb2ludCI6ICJzdHMuYW1hem9uYXdzLmNvbSIsCiAgICAicHJvdG9jb2wiOiAicXVlcnkiLAogICAgInNlcnZpY2VBYmJyZXZpYXRpb24iOiAiQVdTIFNUUyIsCiAgICAic2VydmljZUZ1bGxOYW1lIjogIkFXUyBTZWN1cml0eSBUb2tlbiBTZXJ2aWNlIiwKICAgICJzZXJ2aWNlSWQiOiAiU1RTIiwKICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICJ1aWQiOiAic3RzLTIwMTEtMDYtMTUiLAogICAgInhtbE5hbWVzcGFjZSI6ICJodHRwczovL3N0cy5hbWF6b25hd3MuY29tL2RvYy8yMDExLTA2LTE1LyIKICB9LAogICJvcGVyYXRpb25zIjogewogICAgIkFzc3VtZVJvbGUiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIjoge30sCiAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgfSwKICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgIH0sCiAgICAgICAgICAiVHJhbnNpdGl2ZVRhZ0tleXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAiRXh0ZXJuYWxJZCI6IHt9LAogICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgIlRva2VuQ29kZSI6IHt9LAogICAgICAgICAgIlNvdXJjZUlkZW50aXR5Ijoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVJlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNpIgogICAgICAgICAgfSwKICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiU291cmNlSWRlbnRpdHkiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJBc3N1bWVSb2xlV2l0aFNBTUwiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICJQcmluY2lwYWxBcm4iLAogICAgICAgICAgIlNBTUxBc3NlcnRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAiUHJpbmNpcGFsQXJuIjoge30sCiAgICAgICAgICAiU0FNTEFzc2VydGlvbiI6IHt9LAogICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgIH0sCiAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlV2l0aFNBTUxSZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaSIKICAgICAgICAgIH0sCiAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAic2hhcGUiOiAiU24iCiAgICAgICAgICB9LAogICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIlN1YmplY3QiOiB7fSwKICAgICAgICAgICJTdWJqZWN0VHlwZSI6IHt9LAogICAgICAgICAgIklzc3VlciI6IHt9LAogICAgICAgICAgIkF1ZGllbmNlIjoge30sCiAgICAgICAgICAiTmFtZVF1YWxpZmllciI6IHt9LAogICAgICAgICAgIlNvdXJjZUlkZW50aXR5Ijoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSIsCiAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICJXZWJJZGVudGl0eVRva2VuIjoge30sCiAgICAgICAgICAiUHJvdmlkZXJJZCI6IHt9LAogICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgIH0sCiAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5UmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2kiCiAgICAgICAgICB9LAogICAgICAgICAgIlN1YmplY3RGcm9tV2ViSWRlbnRpdHlUb2tlbiI6IHt9LAogICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNuIgogICAgICAgICAgfSwKICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJQcm92aWRlciI6IHt9LAogICAgICAgICAgIkF1ZGllbmNlIjoge30sCiAgICAgICAgICAiU291cmNlSWRlbnRpdHkiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkVuY29kZWRNZXNzYWdlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiRW5jb2RlZE1lc3NhZ2UiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZVJlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJEZWNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldEFjY2Vzc0tleUluZm8iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJBY2Nlc3NLZXlJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFjY2Vzc0tleUlkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0QWNjZXNzS2V5SW5mb1Jlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJBY2NvdW50Ijoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0Q2FsbGVySWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRDYWxsZXJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJVc2VySWQiOiB7fSwKICAgICAgICAgICJBY2NvdW50Ijoge30sCiAgICAgICAgICAiQXJuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0RmVkZXJhdGlvblRva2VuIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiTmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIk5hbWUiOiB7fSwKICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM4IgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRGZWRlcmF0aW9uVG9rZW5SZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaSIKICAgICAgICAgIH0sCiAgICAgICAgICAiRmVkZXJhdGVkVXNlciI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiLAogICAgICAgICAgICAgICJBcm4iCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiOiB7fSwKICAgICAgICAgICAgICAiQXJuIjoge30KICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRTZXNzaW9uVG9rZW4iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAiVG9rZW5Db2RlIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0U2Vzc2lvblRva2VuUmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2kiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwKICAic2hhcGVzIjogewogICAgIlM0IjogewogICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgIm1lbWJlciI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFybiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlM4IjogewogICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgIm1lbWJlciI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJLZXkiLAogICAgICAgICAgIlZhbHVlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiS2V5Ijoge30sCiAgICAgICAgICAiVmFsdWUiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTaSI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICJBY2Nlc3NLZXlJZCIsCiAgICAgICAgIlNlY3JldEFjY2Vzc0tleSIsCiAgICAgICAgIlNlc3Npb25Ub2tlbiIsCiAgICAgICAgIkV4cGlyYXRpb24iCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9LAogICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiOiB7fSwKICAgICAgICAiU2Vzc2lvblRva2VuIjoge30sCiAgICAgICAgIkV4cGlyYXRpb24iOiB7CiAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlNuIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgIkFzc3VtZWRSb2xlSWQiLAogICAgICAgICJBcm4iCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJBc3N1bWVkUm9sZUlkIjoge30sCiAgICAgICAgIkFybiI6IHt9CiAgICAgIH0KICAgIH0KICB9Cn0KfSx7fV0sNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAicGFnaW5hdGlvbiI6IHsKICB9Cn0KCn0se31dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpyZXF1aXJlKCcuLi9saWIvbm9kZV9sb2FkZXInKTsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CnZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CnZhciBhcGlMb2FkZXIgPSBBV1MuYXBpTG9hZGVyOwoKYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSA9IHt9OwpBV1MuQ29nbml0b0lkZW50aXR5ID0gU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdjb2duaXRvaWRlbnRpdHknLCBbJzIwMTQtMDYtMzAnXSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcGlMb2FkZXIuc2VydmljZXNbJ2NvZ25pdG9pZGVudGl0eSddLCAnMjAxNC0wNi0zMCcsIHsKICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLm1pbi5qc29uJyk7CiAgICBtb2RlbC5wYWdpbmF0b3JzID0gcmVxdWlyZSgnLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAucGFnaW5hdG9ycy5qc29uJykucGFnaW5hdGlvbjsKICAgIHJldHVybiBtb2RlbDsKICB9LAogIGVudW1lcmFibGU6IHRydWUsCiAgY29uZmlndXJhYmxlOiB0cnVlCn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBBV1MuQ29nbml0b0lkZW50aXR5OwoKfSx7Ii4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLm1pbi5qc29uIjoxLCIuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5wYWdpbmF0b3JzLmpzb24iOjIsIi4uL2xpYi9jb3JlIjoxOSwiLi4vbGliL25vZGVfbG9hZGVyIjoxNn1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpyZXF1aXJlKCcuLi9saWIvbm9kZV9sb2FkZXInKTsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CnZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CnZhciBhcGlMb2FkZXIgPSBBV1MuYXBpTG9hZGVyOwoKYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSA9IHt9OwpBV1MuU1RTID0gU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdzdHMnLCBbJzIwMTEtMDYtMTUnXSk7CnJlcXVpcmUoJy4uL2xpYi9zZXJ2aWNlcy9zdHMnKTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10sICcyMDExLTA2LTE1JywgewogIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbicpOwogICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uJykucGFnaW5hdGlvbjsKICAgIHJldHVybiBtb2RlbDsKICB9LAogIGVudW1lcmFibGU6IHRydWUsCiAgY29uZmlndXJhYmxlOiB0cnVlCn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBBV1MuU1RTOwoKfSx7Ii4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24iOjUsIi4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uIjo2LCIuLi9saWIvY29yZSI6MTksIi4uL2xpYi9ub2RlX2xvYWRlciI6MTYsIi4uL2xpYi9zZXJ2aWNlcy9zdHMiOjYyfV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmZ1bmN0aW9uIGFwaUxvYWRlcihzdmMsIHZlcnNpb24pIHsKICBpZiAoIWFwaUxvYWRlci5zZXJ2aWNlcy5oYXNPd25Qcm9wZXJ0eShzdmMpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWRTZXJ2aWNlOiBGYWlsZWQgdG8gbG9hZCBhcGkgZm9yICcgKyBzdmMpOwogIH0KICByZXR1cm4gYXBpTG9hZGVyLnNlcnZpY2VzW3N2Y11bdmVyc2lvbl07Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICoKICogVGhpcyBtZW1iZXIgb2YgQVdTLmFwaUxvYWRlciBpcyBwcml2YXRlLCBidXQgY2hhbmdpbmcgaXQgd2lsbCBuZWNlc3NpdGF0ZSBhCiAqIGNoYW5nZSB0byAuLi9zY3JpcHRzL3NlcnZpY2VzLXRhYmxlLWdlbmVyYXRvci50cwogKi8KYXBpTG9hZGVyLnNlcnZpY2VzID0ge307CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IGFwaUxvYWRlcjsKCn0se31dLDEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEhtYWMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIbWFjJyk7CnZhciBNZDUgPSByZXF1aXJlKCcuL2Jyb3dzZXJNZDUnKTsKdmFyIFNoYTEgPSByZXF1aXJlKCcuL2Jyb3dzZXJTaGExJyk7CnZhciBTaGEyNTYgPSByZXF1aXJlKCcuL2Jyb3dzZXJTaGEyNTYnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICAgIGNyZWF0ZUhhc2g6IGZ1bmN0aW9uIGNyZWF0ZUhhc2goYWxnKSB7CiAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAoYWxnID09PSAnbWQ1JykgewogICAgICAgIHJldHVybiBuZXcgTWQ1KCk7CiAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgIHJldHVybiBuZXcgU2hhMjU2KCk7CiAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMScpIHsKICAgICAgICByZXR1cm4gbmV3IFNoYTEoKTsKICAgICAgfQoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdIYXNoIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgfSwKICAgIGNyZWF0ZUhtYWM6IGZ1bmN0aW9uIGNyZWF0ZUhtYWMoYWxnLCBrZXkpIHsKICAgICAgYWxnID0gYWxnLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBIbWFjKE1kNSwga2V5KTsKICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGEyNTYnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBIbWFjKFNoYTI1Niwga2V5KTsKICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGExJykgewogICAgICAgIHJldHVybiBuZXcgSG1hYyhTaGExLCBrZXkpOwogICAgICB9CgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hNQUMgYWxnb3JpdGhtICcgKyBhbGcgKyAnIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgU0RLJyk7CiAgICB9LAogICAgY3JlYXRlU2lnbjogZnVuY3Rpb24oKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignY3JlYXRlU2lnbiBpcyBub3QgaW1wbGVtZW50ZWQgaW4gdGhlIGJyb3dzZXInKTsKICAgIH0KICB9OwoKfSx7Ii4vYnJvd3NlckhtYWMiOjEyLCIuL2Jyb3dzZXJNZDUiOjEzLCIuL2Jyb3dzZXJTaGExIjoxNCwiLi9icm93c2VyU2hhMjU2IjoxNX1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CgovKioKICogVGhpcyBpcyBhIHBvbHlmaWxsIGZvciB0aGUgc3RhdGljIG1ldGhvZCBgaXNWaWV3YCBvZiBgQXJyYXlCdWZmZXJgLCB3aGljaCBpcwogKiBlLmcuIG1pc3NpbmcgaW4gSUUgMTAuCiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KaWYgKAogICAgdHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJgogICAgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ3VuZGVmaW5lZCcKKSB7CiAgICBBcnJheUJ1ZmZlci5pc1ZpZXcgPSBmdW5jdGlvbihhcmcpIHsKICAgICAgICByZXR1cm4gdmlld1N0cmluZ3MuaW5kZXhPZihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnKSkgPiAtMTsKICAgIH07Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciB2aWV3U3RyaW5ncyA9IFsKICAgICdbb2JqZWN0IEludDhBcnJheV0nLAogICAgJ1tvYmplY3QgVWludDhBcnJheV0nLAogICAgJ1tvYmplY3QgVWludDhDbGFtcGVkQXJyYXldJywKICAgICdbb2JqZWN0IEludDE2QXJyYXldJywKICAgICdbb2JqZWN0IFVpbnQxNkFycmF5XScsCiAgICAnW29iamVjdCBJbnQzMkFycmF5XScsCiAgICAnW29iamVjdCBVaW50MzJBcnJheV0nLAogICAgJ1tvYmplY3QgRmxvYXQzMkFycmF5XScsCiAgICAnW29iamVjdCBGbG9hdDY0QXJyYXldJywKICAgICdbb2JqZWN0IERhdGFWaWV3XScsCl07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBpc0VtcHR5RGF0YShkYXRhKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGRhdGEubGVuZ3RoID09PSAwOwogICAgfQogICAgcmV0dXJuIGRhdGEuYnl0ZUxlbmd0aCA9PT0gMDsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gY29udmVydFRvQnVmZmVyKGRhdGEpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBkYXRhID0gbmV3IEJ1ZmZlcihkYXRhLCAndXRmOCcpOwogICAgfQoKICAgIGlmIChBcnJheUJ1ZmZlci5pc1ZpZXcoZGF0YSkpIHsKICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoIC8gVWludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICB9CgogICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7CiAgICBpc0VtcHR5RGF0YTogaXNFbXB0eURhdGEsCiAgICBjb252ZXJ0VG9CdWZmZXI6IGNvbnZlcnRUb0J1ZmZlciwKfTsKCn0seyJidWZmZXIvIjo4NX1dLDEyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gSG1hYyhoYXNoQ3Rvciwgc2VjcmV0KSB7CiAgICB0aGlzLmhhc2ggPSBuZXcgaGFzaEN0b3IoKTsKICAgIHRoaXMub3V0ZXIgPSBuZXcgaGFzaEN0b3IoKTsKCiAgICB2YXIgaW5uZXIgPSBidWZmZXJGcm9tU2VjcmV0KGhhc2hDdG9yLCBzZWNyZXQpOwogICAgdmFyIG91dGVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICBvdXRlci5zZXQoaW5uZXIpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFzaEN0b3IuQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgaW5uZXJbaV0gXj0gMHgzNjsKICAgICAgICBvdXRlcltpXSBePSAweDVjOwogICAgfQoKICAgIHRoaXMuaGFzaC51cGRhdGUoaW5uZXIpOwogICAgdGhpcy5vdXRlci51cGRhdGUob3V0ZXIpOwoKICAgIC8vIFplcm8gb3V0IHRoZSBjb3BpZWQga2V5IGJ1ZmZlci4KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5uZXIuYnl0ZUxlbmd0aDsgaSsrKSB7CiAgICAgICAgaW5uZXJbaV0gPSAwOwogICAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBIbWFjOwoKSG1hYy5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKHRvSGFzaCkgewogICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YSh0b0hhc2gpIHx8IHRoaXMuZXJyb3IpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICB0cnkgewogICAgICAgIHRoaXMuaGFzaC51cGRhdGUoaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcih0b0hhc2gpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0aGlzLmVycm9yID0gZTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKfTsKCkhtYWMucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgaWYgKCF0aGlzLm91dGVyLmZpbmlzaGVkKSB7CiAgICAgICAgdGhpcy5vdXRlci51cGRhdGUodGhpcy5oYXNoLmRpZ2VzdCgpKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5vdXRlci5kaWdlc3QoZW5jb2RpbmcpOwp9OwoKZnVuY3Rpb24gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KSB7CiAgICB2YXIgaW5wdXQgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNlY3JldCk7CiAgICBpZiAoaW5wdXQuYnl0ZUxlbmd0aCA+IGhhc2hDdG9yLkJMT0NLX1NJWkUpIHsKICAgICAgICB2YXIgYnVmZmVySGFzaCA9IG5ldyBoYXNoQ3RvcjsKICAgICAgICBidWZmZXJIYXNoLnVwZGF0ZShpbnB1dCk7CiAgICAgICAgaW5wdXQgPSBidWZmZXJIYXNoLmRpZ2VzdCgpOwogICAgfQogICAgdmFyIGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGhhc2hDdG9yLkJMT0NLX1NJWkUpOwogICAgYnVmZmVyLnNldChpbnB1dCk7CiAgICByZXR1cm4gYnVmZmVyOwp9Cgp9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMX1dLDEzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKCnZhciBCTE9DS19TSVpFID0gNjQ7Cgp2YXIgRElHRVNUX0xFTkdUSCA9IDE2OwoKdmFyIElOSVQgPSBbCiAgICAweDY3NDUyMzAxLAogICAgMHhlZmNkYWI4OSwKICAgIDB4OThiYWRjZmUsCiAgICAweDEwMzI1NDc2LApdOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gTWQ1KCkgewogICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAweDY3NDUyMzAxLAogICAgICAgIDB4ZWZjZGFiODksCiAgICAgICAgMHg5OGJhZGNmZSwKICAgICAgICAweDEwMzI1NDc2LAogICAgXTsKICAgIHRoaXMuYnVmZmVyID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihCTE9DS19TSVpFKSk7CiAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gTWQ1OwoKTWQ1LkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwoKTWQ1LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoc291cmNlRGF0YSkgewogICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShzb3VyY2VEYXRhKSkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgIH0KCiAgICB2YXIgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc291cmNlRGF0YSk7CiAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgdmFyIGJ5dGVMZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICB0aGlzLmJ5dGVzSGFzaGVkICs9IGJ5dGVMZW5ndGg7CiAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDApIHsKICAgICAgICB0aGlzLmJ1ZmZlci5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCBkYXRhW3Bvc2l0aW9uKytdKTsKICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwp9OwoKTWQ1LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgIGlmICghdGhpcy5maW5pc2hlZCkgewogICAgICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgdW5kZWNvcmF0ZWRMZW5ndGggPSBfYS5idWZmZXJMZW5ndGgsIGJ5dGVzSGFzaGVkID0gX2EuYnl0ZXNIYXNoZWQ7CiAgICAgICAgdmFyIGJpdHNIYXNoZWQgPSBieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgYnVmZmVyLnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIDEyOCk7CiAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFIC0gODsgaSsrKSB7CiAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICB9CiAgICAgICAgYnVmZmVyLnNldFVpbnQzMihCTE9DS19TSVpFIC0gOCwgYml0c0hhc2hlZCA+Pj4gMCwgdHJ1ZSk7CiAgICAgICAgYnVmZmVyLnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgTWF0aC5mbG9vcihiaXRzSGFzaGVkIC8gMHgxMDAwMDAwMDApLCB0cnVlKTsKICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKICAgIH0KICAgIHZhciBvdXQgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKERJR0VTVF9MRU5HVEgpKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgb3V0LnNldFVpbnQzMihpICogNCwgdGhpcy5zdGF0ZVtpXSwgdHJ1ZSk7CiAgICB9CiAgICB2YXIgYnVmZiA9IG5ldyBCdWZmZXIob3V0LmJ1ZmZlciwgb3V0LmJ5dGVPZmZzZXQsIG91dC5ieXRlTGVuZ3RoKTsKICAgIHJldHVybiBlbmNvZGluZyA/IGJ1ZmYudG9TdHJpbmcoZW5jb2RpbmcpIDogYnVmZjsKfTsKCk1kNS5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgc3RhdGUgPSBfYS5zdGF0ZTsKICAgIHZhciBhID0gc3RhdGVbMF0sIGIgPSBzdGF0ZVsxXSwgYyA9IHN0YXRlWzJdLCBkID0gc3RhdGVbM107CiAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNywgMHhkNzZhYTQ3OCk7CiAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMTIsIDB4ZThjN2I3NTYpOwogICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDE3LCAweDI0MjA3MGRiKTsKICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMjIsIDB4YzFiZGNlZWUpOwogICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA3LCAweGY1N2MwZmFmKTsKICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgMTIsIDB4NDc4N2M2MmEpOwogICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNywgMHhhODMwNDYxMyk7CiAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDIyLCAweGZkNDY5NTAxKTsKICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgNywgMHg2OTgwOThkOCk7CiAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDEyLCAweDhiNDRmN2FmKTsKICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTcsIDB4ZmZmZjViYjEpOwogICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAyMiwgMHg4OTVjZDdiZSk7CiAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDcsIDB4NmI5MDExMjIpOwogICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCAxMiwgMHhmZDk4NzE5Myk7CiAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDE3LCAweGE2Nzk0MzhlKTsKICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMjIsIDB4NDliNDA4MjEpOwogICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDUsIDB4ZjYxZTI1NjIpOwogICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCA5LCAweGMwNDBiMzQwKTsKICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTQsIDB4MjY1ZTVhNTEpOwogICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDIwLCAweGU5YjZjN2FhKTsKICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgNSwgMHhkNjJmMTA1ZCk7CiAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDksIDB4MDI0NDE0NTMpOwogICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNCwgMHhkOGExZTY4MSk7CiAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDIwLCAweGU3ZDNmYmM4KTsKICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgNSwgMHgyMWUxY2RlNik7CiAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDksIDB4YzMzNzA3ZDYpOwogICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxNCwgMHhmNGQ1MGQ4Nyk7CiAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDIwLCAweDQ1NWExNGVkKTsKICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNSwgMHhhOWUzZTkwNSk7CiAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgOSwgMHhmY2VmYTNmOCk7CiAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE0LCAweDY3NmYwMmQ5KTsKICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgMjAsIDB4OGQyYTRjOGEpOwogICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCA0LCAweGZmZmEzOTQyKTsKICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgMTEsIDB4ODc3MWY2ODEpOwogICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxNiwgMHg2ZDlkNjEyMik7CiAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDIzLCAweGZkZTUzODBjKTsKICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCA0LCAweGE0YmVlYTQ0KTsKICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMTEsIDB4NGJkZWNmYTkpOwogICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxNiwgMHhmNmJiNGI2MCk7CiAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDIzLCAweGJlYmZiYzcwKTsKICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNCwgMHgyODliN2VjNik7CiAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgMTEsIDB4ZWFhMTI3ZmEpOwogICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxNiwgMHhkNGVmMzA4NSk7CiAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDIzLCAweDA0ODgxZDA1KTsKICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgNCwgMHhkOWQ0ZDAzOSk7CiAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDExLCAweGU2ZGI5OWU1KTsKICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTYsIDB4MWZhMjdjZjgpOwogICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDIzLCAweGM0YWM1NjY1KTsKICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCA2LCAweGY0MjkyMjQ0KTsKICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTAsIDB4NDMyYWZmOTcpOwogICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAxNSwgMHhhYjk0MjNhNyk7CiAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDIxLCAweGZjOTNhMDM5KTsKICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgNiwgMHg2NTViNTljMyk7CiAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDEwLCAweDhmMGNjYzkyKTsKICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTUsIDB4ZmZlZmY0N2QpOwogICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDIxLCAweDg1ODQ1ZGQxKTsKICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgNiwgMHg2ZmE4N2U0Zik7CiAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDEwLCAweGZlMmNlNmUwKTsKICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTUsIDB4YTMwMTQzMTQpOwogICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCAyMSwgMHg0ZTA4MTFhMSk7CiAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDYsIDB4Zjc1MzdlODIpOwogICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxMCwgMHhiZDNhZjIzNSk7CiAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMTUsIDB4MmFkN2QyYmIpOwogICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAyMSwgMHhlYjg2ZDM5MSk7CiAgICBzdGF0ZVswXSA9IChhICsgc3RhdGVbMF0pICYgMHhGRkZGRkZGRjsKICAgIHN0YXRlWzFdID0gKGIgKyBzdGF0ZVsxXSkgJiAweEZGRkZGRkZGOwogICAgc3RhdGVbMl0gPSAoYyArIHN0YXRlWzJdKSAmIDB4RkZGRkZGRkY7CiAgICBzdGF0ZVszXSA9IChkICsgc3RhdGVbM10pICYgMHhGRkZGRkZGRjsKfTsKCmZ1bmN0aW9uIGNtbihxLCBhLCBiLCB4LCBzLCB0KSB7CiAgICBhID0gKCgoYSArIHEpICYgMHhGRkZGRkZGRikgKyAoKHggKyB0KSAmIDB4RkZGRkZGRkYpKSAmIDB4RkZGRkZGRkY7CiAgICByZXR1cm4gKCgoYSA8PCBzKSB8IChhID4+PiAoMzIgLSBzKSkpICsgYikgJiAweEZGRkZGRkZGOwp9CgpmdW5jdGlvbiBmZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gY21uKChiICYgYykgfCAoKH5iKSAmIGQpLCBhLCBiLCB4LCBzLCB0KTsKfQoKZnVuY3Rpb24gZ2coYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIGNtbigoYiAmIGQpIHwgKGMgJiAofmQpKSwgYSwgYiwgeCwgcywgdCk7Cn0KCmZ1bmN0aW9uIGhoKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KTsKfQoKZnVuY3Rpb24gaWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIGNtbihjIF4gKGIgfCAofmQpKSwgYSwgYiwgeCwgcywgdCk7Cn0KCn0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4NX1dLDE0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CnZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKCnZhciBCTE9DS19TSVpFID0gNjQ7Cgp2YXIgRElHRVNUX0xFTkdUSCA9IDIwOwoKdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAweDVhODI3OTk5LAogICAgMHg2ZWQ5ZWJhMSwKICAgIDB4OGYxYmJjZGMgfCAwLAogICAgMHhjYTYyYzFkNiB8IDAKXSk7Cgp2YXIgSU5JVCA9IFsKICAgIDB4NmEwOWU2NjcsCiAgICAweGJiNjdhZTg1LAogICAgMHgzYzZlZjM3MiwKICAgIDB4YTU0ZmY1M2EsCiAgICAweDUxMGU1MjdmLAogICAgMHg5YjA1Njg4YywKICAgIDB4MWY4M2Q5YWIsCiAgICAweDViZTBjZDE5LApdOwoKdmFyIE1BWF9IQVNIQUJMRV9MRU5HVEggPSBNYXRoLnBvdygyLCA1MykgLSAxOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gU2hhMSgpIHsKICAgIHRoaXMuaDAgPSAweDY3NDUyMzAxOwogICAgdGhpcy5oMSA9IDB4RUZDREFCODk7CiAgICB0aGlzLmgyID0gMHg5OEJBRENGRTsKICAgIHRoaXMuaDMgPSAweDEwMzI1NDc2OwogICAgdGhpcy5oNCA9IDB4QzNEMkUxRjA7CiAgICAvLyBUaGUgZmlyc3QgNjQgYnl0ZXMgKDE2IHdvcmRzKSBpcyB0aGUgZGF0YSBjaHVuawogICAgdGhpcy5ibG9jayA9IG5ldyBVaW50MzJBcnJheSg4MCk7CiAgICB0aGlzLm9mZnNldCA9IDA7CiAgICB0aGlzLnNoaWZ0ID0gMjQ7CiAgICB0aGlzLnRvdGFsTGVuZ3RoID0gMDsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMTsKClNoYTEuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CgpTaGExLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgfQoKICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKCiAgICB2YXIgbGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICB0aGlzLnRvdGFsTGVuZ3RoICs9IGxlbmd0aCAqIDg7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy53cml0ZShkYXRhW2ldKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKfTsKClNoYTEucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gd3JpdGUoYnl0ZSkgewogICAgdGhpcy5ibG9ja1t0aGlzLm9mZnNldF0gfD0gKGJ5dGUgJiAweGZmKSA8PCB0aGlzLnNoaWZ0OwogICAgaWYgKHRoaXMuc2hpZnQpIHsKICAgICAgICB0aGlzLnNoaWZ0IC09IDg7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMub2Zmc2V0Kys7CiAgICAgICAgdGhpcy5zaGlmdCA9IDI0OwogICAgfQoKICAgIGlmICh0aGlzLm9mZnNldCA9PT0gMTYpIHRoaXMucHJvY2Vzc0Jsb2NrKCk7Cn07CgpTaGExLnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgIC8vIFBhZAogICAgdGhpcy53cml0ZSgweDgwKTsKICAgIGlmICh0aGlzLm9mZnNldCA+IDE0IHx8ICh0aGlzLm9mZnNldCA9PT0gMTQgJiYgdGhpcy5zaGlmdCA8IDI0KSkgewogICAgICB0aGlzLnByb2Nlc3NCbG9jaygpOwogICAgfQogICAgdGhpcy5vZmZzZXQgPSAxNDsKICAgIHRoaXMuc2hpZnQgPSAyNDsKCiAgICAvLyA2NC1iaXQgbGVuZ3RoIGJpZy1lbmRpYW4KICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIG51bWJlcnMgdGhpcyBiaWcgYXJlbid0IGFjY3VyYXRlIGluIGphdmFzY3JpcHQgYW55d2F5CiAgICB0aGlzLndyaXRlKDB4MDApOyAvLyAuLlNvIGp1c3QgaGFyZC1jb2RlIHRvIHplcm8uCiAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmZmYgPyB0aGlzLnRvdGFsTGVuZ3RoIC8gMHgxMDAwMDAwMDAwMCA6IDB4MDApOwogICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZiA/IHRoaXMudG90YWxMZW5ndGggLyAweDEwMDAwMDAwMCA6IDB4MDApOwogICAgZm9yICh2YXIgcyA9IDI0OyBzID49IDA7IHMgLT0gOCkgewogICAgICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+PiBzKTsKICAgIH0KICAgIC8vIFRoZSB2YWx1ZSBpbiBzdGF0ZSBpcyBsaXR0bGUtZW5kaWFuIHJhdGhlciB0aGFuIGJpZy1lbmRpYW4sIHNvIGZsaXAKICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgIHZhciBvdXQgPSBuZXcgQnVmZmVyKERJR0VTVF9MRU5HVEgpOwogICAgdmFyIG91dFZpZXcgPSBuZXcgRGF0YVZpZXcob3V0LmJ1ZmZlcik7CiAgICBvdXRWaWV3LnNldFVpbnQzMigwLCB0aGlzLmgwLCBmYWxzZSk7CiAgICBvdXRWaWV3LnNldFVpbnQzMig0LCB0aGlzLmgxLCBmYWxzZSk7CiAgICBvdXRWaWV3LnNldFVpbnQzMig4LCB0aGlzLmgyLCBmYWxzZSk7CiAgICBvdXRWaWV3LnNldFVpbnQzMigxMiwgdGhpcy5oMywgZmFsc2UpOwogICAgb3V0Vmlldy5zZXRVaW50MzIoMTYsIHRoaXMuaDQsIGZhbHNlKTsKCiAgICByZXR1cm4gZW5jb2RpbmcgPyBvdXQudG9TdHJpbmcoZW5jb2RpbmcpIDogb3V0Owp9OwoKU2hhMS5wcm90b3R5cGUucHJvY2Vzc0Jsb2NrID0gZnVuY3Rpb24gcHJvY2Vzc0Jsb2NrKCkgewogICAgLy8gRXh0ZW5kIHRoZSBzaXh0ZWVuIDMyLWJpdCB3b3JkcyBpbnRvIGVpZ2h0eSAzMi1iaXQgd29yZHM6CiAgICBmb3IgKHZhciBpID0gMTY7IGkgPCA4MDsgaSsrKSB7CiAgICAgIHZhciB3ID0gdGhpcy5ibG9ja1tpIC0gM10gXiB0aGlzLmJsb2NrW2kgLSA4XSBeIHRoaXMuYmxvY2tbaSAtIDE0XSBeIHRoaXMuYmxvY2tbaSAtIDE2XTsKICAgICAgdGhpcy5ibG9ja1tpXSA9ICh3IDw8IDEpIHwgKHcgPj4+IDMxKTsKICAgIH0KCiAgICAvLyBJbml0aWFsaXplIGhhc2ggdmFsdWUgZm9yIHRoaXMgY2h1bms6CiAgICB2YXIgYSA9IHRoaXMuaDA7CiAgICB2YXIgYiA9IHRoaXMuaDE7CiAgICB2YXIgYyA9IHRoaXMuaDI7CiAgICB2YXIgZCA9IHRoaXMuaDM7CiAgICB2YXIgZSA9IHRoaXMuaDQ7CiAgICB2YXIgZiwgazsKCiAgICAvLyBNYWluIGxvb3A6CiAgICBmb3IgKGkgPSAwOyBpIDwgODA7IGkrKykgewogICAgICBpZiAoaSA8IDIwKSB7CiAgICAgICAgZiA9IGQgXiAoYiAmIChjIF4gZCkpOwogICAgICAgIGsgPSAweDVBODI3OTk5OwogICAgICB9CiAgICAgIGVsc2UgaWYgKGkgPCA0MCkgewogICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgayA9IDB4NkVEOUVCQTE7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaSA8IDYwKSB7CiAgICAgICAgZiA9IChiICYgYykgfCAoZCAmIChiIHwgYykpOwogICAgICAgIGsgPSAweDhGMUJCQ0RDOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgayA9IDB4Q0E2MkMxRDY7CiAgICAgIH0KICAgICAgdmFyIHRlbXAgPSAoYSA8PCA1IHwgYSA+Pj4gMjcpICsgZiArIGUgKyBrICsgKHRoaXMuYmxvY2tbaV18MCk7CiAgICAgIGUgPSBkOwogICAgICBkID0gYzsKICAgICAgYyA9IChiIDw8IDMwIHwgYiA+Pj4gMik7CiAgICAgIGIgPSBhOwogICAgICBhID0gdGVtcDsKICAgIH0KCiAgICAvLyBBZGQgdGhpcyBjaHVuaydzIGhhc2ggdG8gcmVzdWx0IHNvIGZhcjoKICAgIHRoaXMuaDAgPSAodGhpcy5oMCArIGEpIHwgMDsKICAgIHRoaXMuaDEgPSAodGhpcy5oMSArIGIpIHwgMDsKICAgIHRoaXMuaDIgPSAodGhpcy5oMiArIGMpIHwgMDsKICAgIHRoaXMuaDMgPSAodGhpcy5oMyArIGQpIHwgMDsKICAgIHRoaXMuaDQgPSAodGhpcy5oNCArIGUpIHwgMDsKCiAgICAvLyBUaGUgYmxvY2sgaXMgbm93IHJldXNhYmxlLgogICAgdGhpcy5vZmZzZXQgPSAwOwogICAgZm9yIChpID0gMDsgaSA8IDE2OyBpKyspIHsKICAgICAgICB0aGlzLmJsb2NrW2ldID0gMDsKICAgIH0KfTsKCn0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4NX1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CnZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKCnZhciBCTE9DS19TSVpFID0gNjQ7Cgp2YXIgRElHRVNUX0xFTkdUSCA9IDMyOwoKdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAweDQyOGEyZjk4LAogICAgMHg3MTM3NDQ5MSwKICAgIDB4YjVjMGZiY2YsCiAgICAweGU5YjVkYmE1LAogICAgMHgzOTU2YzI1YiwKICAgIDB4NTlmMTExZjEsCiAgICAweDkyM2Y4MmE0LAogICAgMHhhYjFjNWVkNSwKICAgIDB4ZDgwN2FhOTgsCiAgICAweDEyODM1YjAxLAogICAgMHgyNDMxODViZSwKICAgIDB4NTUwYzdkYzMsCiAgICAweDcyYmU1ZDc0LAogICAgMHg4MGRlYjFmZSwKICAgIDB4OWJkYzA2YTcsCiAgICAweGMxOWJmMTc0LAogICAgMHhlNDliNjljMSwKICAgIDB4ZWZiZTQ3ODYsCiAgICAweDBmYzE5ZGM2LAogICAgMHgyNDBjYTFjYywKICAgIDB4MmRlOTJjNmYsCiAgICAweDRhNzQ4NGFhLAogICAgMHg1Y2IwYTlkYywKICAgIDB4NzZmOTg4ZGEsCiAgICAweDk4M2U1MTUyLAogICAgMHhhODMxYzY2ZCwKICAgIDB4YjAwMzI3YzgsCiAgICAweGJmNTk3ZmM3LAogICAgMHhjNmUwMGJmMywKICAgIDB4ZDVhNzkxNDcsCiAgICAweDA2Y2E2MzUxLAogICAgMHgxNDI5Mjk2NywKICAgIDB4MjdiNzBhODUsCiAgICAweDJlMWIyMTM4LAogICAgMHg0ZDJjNmRmYywKICAgIDB4NTMzODBkMTMsCiAgICAweDY1MGE3MzU0LAogICAgMHg3NjZhMGFiYiwKICAgIDB4ODFjMmM5MmUsCiAgICAweDkyNzIyYzg1LAogICAgMHhhMmJmZThhMSwKICAgIDB4YTgxYTY2NGIsCiAgICAweGMyNGI4YjcwLAogICAgMHhjNzZjNTFhMywKICAgIDB4ZDE5MmU4MTksCiAgICAweGQ2OTkwNjI0LAogICAgMHhmNDBlMzU4NSwKICAgIDB4MTA2YWEwNzAsCiAgICAweDE5YTRjMTE2LAogICAgMHgxZTM3NmMwOCwKICAgIDB4Mjc0ODc3NGMsCiAgICAweDM0YjBiY2I1LAogICAgMHgzOTFjMGNiMywKICAgIDB4NGVkOGFhNGEsCiAgICAweDViOWNjYTRmLAogICAgMHg2ODJlNmZmMywKICAgIDB4NzQ4ZjgyZWUsCiAgICAweDc4YTU2MzZmLAogICAgMHg4NGM4NzgxNCwKICAgIDB4OGNjNzAyMDgsCiAgICAweDkwYmVmZmZhLAogICAgMHhhNDUwNmNlYiwKICAgIDB4YmVmOWEzZjcsCiAgICAweGM2NzE3OGYyCl0pOwoKdmFyIElOSVQgPSBbCiAgICAweDZhMDllNjY3LAogICAgMHhiYjY3YWU4NSwKICAgIDB4M2M2ZWYzNzIsCiAgICAweGE1NGZmNTNhLAogICAgMHg1MTBlNTI3ZiwKICAgIDB4OWIwNTY4OGMsCiAgICAweDFmODNkOWFiLAogICAgMHg1YmUwY2QxOSwKXTsKCnZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKCi8qKgogKiBAcHJpdmF0ZQogKi8KZnVuY3Rpb24gU2hhMjU2KCkgewogICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAweDZhMDllNjY3LAogICAgICAgIDB4YmI2N2FlODUsCiAgICAgICAgMHgzYzZlZjM3MiwKICAgICAgICAweGE1NGZmNTNhLAogICAgICAgIDB4NTEwZTUyN2YsCiAgICAgICAgMHg5YjA1Njg4YywKICAgICAgICAweDFmODNkOWFiLAogICAgICAgIDB4NWJlMGNkMTksCiAgICBdOwogICAgdGhpcy50ZW1wID0gbmV3IEludDMyQXJyYXkoNjQpOwogICAgdGhpcy5idWZmZXIgPSBuZXcgVWludDhBcnJheSg2NCk7CiAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgIC8qKgogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBTaGEyNTY7CgpTaGEyNTYuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CgpTaGEyNTYucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICB9CgogICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShkYXRhKSkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwoKICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgIHRoaXMuYnl0ZXNIYXNoZWQgKz0gYnl0ZUxlbmd0aDsKICAgIGlmICh0aGlzLmJ5dGVzSGFzaGVkICogOCA+IE1BWF9IQVNIQUJMRV9MRU5HVEgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNoIG1vcmUgdGhhbiAyXjUzIC0gMSBiaXRzJyk7CiAgICB9CgogICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwKSB7CiAgICAgICAgdGhpcy5idWZmZXJbdGhpcy5idWZmZXJMZW5ndGgrK10gPSBkYXRhW3Bvc2l0aW9uKytdOwogICAgICAgIGJ5dGVMZW5ndGgtLTsKICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn07CgpTaGEyNTYucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgdmFyIGJpdHNIYXNoZWQgPSB0aGlzLmJ5dGVzSGFzaGVkICogODsKICAgICAgICB2YXIgYnVmZmVyVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlci5idWZmZXIsIHRoaXMuYnVmZmVyLmJ5dGVPZmZzZXQsIHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgIHZhciB1bmRlY29yYXRlZExlbmd0aCA9IHRoaXMuYnVmZmVyTGVuZ3RoOwogICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgMHg4MCk7CiAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRSAtIDg7IGkrKykgewogICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgIH0KICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQzMihCTE9DS19TSVpFIC0gOCwgTWF0aC5mbG9vcihiaXRzSGFzaGVkIC8gMHgxMDAwMDAwMDApLCB0cnVlKTsKICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgYml0c0hhc2hlZCk7CiAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgdGhpcy5maW5pc2hlZCA9IHRydWU7CiAgICB9CiAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAvLyBlYWNoIHdvcmQgaW50byBhIG5ldyBVaW50OEFycmF5CiAgICB2YXIgb3V0ID0gbmV3IEJ1ZmZlcihESUdFU1RfTEVOR1RIKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgb3V0W2kgKiA0XSA9ICh0aGlzLnN0YXRlW2ldID4+PiAyNCkgJiAweGZmOwogICAgICAgIG91dFtpICogNCArIDFdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDE2KSAmIDB4ZmY7CiAgICAgICAgb3V0W2kgKiA0ICsgMl0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gOCkgJiAweGZmOwogICAgICAgIG91dFtpICogNCArIDNdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDApICYgMHhmZjsKICAgIH0KICAgIHJldHVybiBlbmNvZGluZyA/IG91dC50b1N0cmluZyhlbmNvZGluZykgOiBvdXQ7Cn07CgpTaGEyNTYucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgX2EgPSB0aGlzLAogICAgICAgIGJ1ZmZlciA9IF9hLmJ1ZmZlciwKICAgICAgICBzdGF0ZSA9IF9hLnN0YXRlOwogICAgdmFyIHN0YXRlMCA9IHN0YXRlWzBdLAogICAgICAgIHN0YXRlMSA9IHN0YXRlWzFdLAogICAgICAgIHN0YXRlMiA9IHN0YXRlWzJdLAogICAgICAgIHN0YXRlMyA9IHN0YXRlWzNdLAogICAgICAgIHN0YXRlNCA9IHN0YXRlWzRdLAogICAgICAgIHN0YXRlNSA9IHN0YXRlWzVdLAogICAgICAgIHN0YXRlNiA9IHN0YXRlWzZdLAogICAgICAgIHN0YXRlNyA9IHN0YXRlWzddOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICBpZiAoaSA8IDE2KSB7CiAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICgoKGJ1ZmZlcltpICogNF0gJiAweGZmKSA8PCAyNCkgfAogICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDFdICYgMHhmZikgPDwgMTYpIHwKICAgICAgICAgICAgICAgICgoYnVmZmVyWyhpICogNCkgKyAyXSAmIDB4ZmYpIDw8IDgpIHwKICAgICAgICAgICAgICAgIChidWZmZXJbKGkgKiA0KSArIDNdICYgMHhmZikpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIHUgPSB0aGlzLnRlbXBbaSAtIDJdOwogICAgICAgICAgICB2YXIgdDFfMSA9ICh1ID4+PiAxNyB8IHUgPDwgMTUpIF4KICAgICAgICAgICAgICAgICh1ID4+PiAxOSB8IHUgPDwgMTMpIF4KICAgICAgICAgICAgICAgICh1ID4+PiAxMCk7CiAgICAgICAgICAgIHUgPSB0aGlzLnRlbXBbaSAtIDE1XTsKICAgICAgICAgICAgdmFyIHQyXzEgPSAodSA+Pj4gNyB8IHUgPDwgMjUpIF4KICAgICAgICAgICAgICAgICh1ID4+PiAxOCB8IHUgPDwgMTQpIF4KICAgICAgICAgICAgICAgICh1ID4+PiAzKTsKICAgICAgICAgICAgdGhpcy50ZW1wW2ldID0gKHQxXzEgKyB0aGlzLnRlbXBbaSAtIDddIHwgMCkgKwogICAgICAgICAgICAgICAgKHQyXzEgKyB0aGlzLnRlbXBbaSAtIDE2XSB8IDApOwogICAgICAgIH0KICAgICAgICB2YXIgdDEgPSAoKCgoKHN0YXRlNCA+Pj4gNiB8IHN0YXRlNCA8PCAyNikgXgogICAgICAgICAgICAoc3RhdGU0ID4+PiAxMSB8IHN0YXRlNCA8PCAyMSkgXgogICAgICAgICAgICAoc3RhdGU0ID4+PiAyNSB8IHN0YXRlNCA8PCA3KSkKICAgICAgICAgICAgKyAoKHN0YXRlNCAmIHN0YXRlNSkgXiAofnN0YXRlNCAmIHN0YXRlNikpKSB8IDApCiAgICAgICAgICAgICsgKChzdGF0ZTcgKyAoKEtFWVtpXSArIHRoaXMudGVtcFtpXSkgfCAwKSkgfCAwKSkgfCAwOwogICAgICAgIHZhciB0MiA9ICgoKHN0YXRlMCA+Pj4gMiB8IHN0YXRlMCA8PCAzMCkgXgogICAgICAgICAgICAoc3RhdGUwID4+PiAxMyB8IHN0YXRlMCA8PCAxOSkgXgogICAgICAgICAgICAoc3RhdGUwID4+PiAyMiB8IHN0YXRlMCA8PCAxMCkpICsgKChzdGF0ZTAgJiBzdGF0ZTEpIF4gKHN0YXRlMCAmIHN0YXRlMikgXiAoc3RhdGUxICYgc3RhdGUyKSkpIHwgMDsKICAgICAgICBzdGF0ZTcgPSBzdGF0ZTY7CiAgICAgICAgc3RhdGU2ID0gc3RhdGU1OwogICAgICAgIHN0YXRlNSA9IHN0YXRlNDsKICAgICAgICBzdGF0ZTQgPSAoc3RhdGUzICsgdDEpIHwgMDsKICAgICAgICBzdGF0ZTMgPSBzdGF0ZTI7CiAgICAgICAgc3RhdGUyID0gc3RhdGUxOwogICAgICAgIHN0YXRlMSA9IHN0YXRlMDsKICAgICAgICBzdGF0ZTAgPSAodDEgKyB0MikgfCAwOwogICAgfQogICAgc3RhdGVbMF0gKz0gc3RhdGUwOwogICAgc3RhdGVbMV0gKz0gc3RhdGUxOwogICAgc3RhdGVbMl0gKz0gc3RhdGUyOwogICAgc3RhdGVbM10gKz0gc3RhdGUzOwogICAgc3RhdGVbNF0gKz0gc3RhdGU0OwogICAgc3RhdGVbNV0gKz0gc3RhdGU1OwogICAgc3RhdGVbNl0gKz0gc3RhdGU2OwogICAgc3RhdGVbN10gKz0gc3RhdGU3Owp9OwoKfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjg1fV0sMTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKCi8vIGJyb3dzZXIgc3BlY2lmaWMgbW9kdWxlcwp1dGlsLmNyeXB0by5saWIgPSByZXF1aXJlKCcuL2Jyb3dzZXJDcnlwdG9MaWInKTsKdXRpbC5CdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwp1dGlsLnVybCA9IHJlcXVpcmUoJ3VybC8nKTsKdXRpbC5xdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nLycpOwp1dGlsLnJlYWxDbG9jayA9IHJlcXVpcmUoJy4vcmVhbGNsb2NrL2Jyb3dzZXJDbG9jaycpOwp1dGlsLmVudmlyb25tZW50ID0gJ2pzJzsKdXRpbC5jcmVhdGVFdmVudFN0cmVhbSA9IHJlcXVpcmUoJy4vZXZlbnQtc3RyZWFtL2J1ZmZlcmVkLWNyZWF0ZS1ldmVudC1zdHJlYW0nKS5jcmVhdGVFdmVudFN0cmVhbTsKdXRpbC5pc0Jyb3dzZXIgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH07CnV0aWwuaXNOb2RlID0gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfTsKCnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTOwoKcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4nKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscy90ZW1wb3JhcnlfY3JlZGVudGlhbHMnKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMvd2ViX2lkZW50aXR5X2NyZWRlbnRpYWxzJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY29nbml0b19pZGVudGl0eV9jcmVkZW50aWFscycpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMnKTsKCi8vIExvYWQgdGhlIERPTVBhcnNlciBYTUwgcGFyc2VyCkFXUy5YTUwuUGFyc2VyID0gcmVxdWlyZSgnLi94bWwvYnJvd3Nlcl9wYXJzZXInKTsKCi8vIExvYWQgdGhlIFhIUiBIdHRwQ2xpZW50CnJlcXVpcmUoJy4vaHR0cC94aHInKTsKCmlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ3VuZGVmaW5lZCcpIHsKICB2YXIgcHJvY2VzcyA9IHsKICAgIGJyb3dzZXI6IHRydWUKICB9Owp9Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2Jyb3dzZXJDcnlwdG9MaWIiOjEwLCIuL2NvcmUiOjE5LCIuL2NyZWRlbnRpYWxzIjoyMCwiLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzIjoyMSwiLi9jcmVkZW50aWFscy9jb2duaXRvX2lkZW50aXR5X2NyZWRlbnRpYWxzIjoyMiwiLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluIjoyMywiLi9jcmVkZW50aWFscy9zYW1sX2NyZWRlbnRpYWxzIjoyNCwiLi9jcmVkZW50aWFscy90ZW1wb3JhcnlfY3JlZGVudGlhbHMiOjI1LCIuL2NyZWRlbnRpYWxzL3dlYl9pZGVudGl0eV9jcmVkZW50aWFscyI6MjYsIi4vZXZlbnQtc3RyZWFtL2J1ZmZlcmVkLWNyZWF0ZS1ldmVudC1zdHJlYW0iOjI4LCIuL2h0dHAveGhyIjozNiwiLi9yZWFsY2xvY2svYnJvd3NlckNsb2NrIjo1MywiLi91dGlsIjo3MiwiLi94bWwvYnJvd3Nlcl9wYXJzZXIiOjczLCJfcHJvY2VzcyI6OTAsImJ1ZmZlci8iOjg1LCJxdWVyeXN0cmluZy8iOjk2LCJ1cmwvIjo5OH1dLDE3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwp2YXIgUHJvbWlzZXNEZXBlbmRlbmN5OwoKLyoqCiAqIFRoZSBtYWluIGNvbmZpZ3VyYXRpb24gY2xhc3MgdXNlZCBieSBhbGwgc2VydmljZSBvYmplY3RzIHRvIHNldAogKiB0aGUgcmVnaW9uLCBjcmVkZW50aWFscywgYW5kIG90aGVyIG9wdGlvbnMgZm9yIHJlcXVlc3RzLgogKgogKiBCeSBkZWZhdWx0LCBjcmVkZW50aWFscyBhbmQgcmVnaW9uIHNldHRpbmdzIGFyZSBsZWZ0IHVuY29uZmlndXJlZC4KICogVGhpcyBzaG91bGQgYmUgY29uZmlndXJlZCBieSB0aGUgYXBwbGljYXRpb24gYmVmb3JlIHVzaW5nIGFueQogKiBBV1Mgc2VydmljZSBBUElzLgogKgogKiBJbiBvcmRlciB0byBzZXQgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucywgcHJvcGVydGllcyBzaG91bGQKICogYmUgYXNzaWduZWQgdG8gdGhlIGdsb2JhbCB7QVdTLmNvbmZpZ30gb2JqZWN0LgogKgogKiBAc2VlIEFXUy5jb25maWcKICoKICogQCFncm91cCBHZW5lcmFsIENvbmZpZ3VyYXRpb24gT3B0aW9ucwogKgogKiBAIWF0dHJpYnV0ZSBjcmVkZW50aWFscwogKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gdGhlIEFXUyBjcmVkZW50aWFscyB0byBzaWduIHJlcXVlc3RzIHdpdGguCiAqCiAqIEAhYXR0cmlidXRlIHJlZ2lvbgogKiAgIEBleGFtcGxlIFNldCB0aGUgZ2xvYmFsIHJlZ2lvbiBzZXR0aW5nIHRvIHVzLXdlc3QtMgogKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JlZ2lvbjogJ3VzLXdlc3QtMid9KTsKICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIFRoZSByZWdpb24gdG8gc2VuZCBzZXJ2aWNlIHJlcXVlc3RzIHRvLgogKiAgIEBzZWUgaHR0cDovL2RvY3MuYW1hem9ud2Vic2VydmljZXMuY29tL2dlbmVyYWwvbGF0ZXN0L2dyL3JhbmRlLmh0bWwKICogICAgIEEgbGlzdCBvZiBhdmFpbGFibGUgZW5kcG9pbnRzIGZvciBlYWNoIEFXUyBzZXJ2aWNlCiAqCiAqIEAhYXR0cmlidXRlIG1heFJldHJpZXMKICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0byBwZXJmb3JtIGZvciBhCiAqICAgICBzZXJ2aWNlIHJlcXVlc3QuIEJ5IGRlZmF1bHQgdGhpcyB2YWx1ZSBpcyBjYWxjdWxhdGVkIGJ5IHRoZSBzcGVjaWZpYwogKiAgICAgc2VydmljZSBvYmplY3QgdGhhdCB0aGUgcmVxdWVzdCBpcyBiZWluZyBtYWRlIHRvLgogKgogKiBAIWF0dHJpYnV0ZSBtYXhSZWRpcmVjdHMKICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmVkaXJlY3RzIHRvIGZvbGxvdyBmb3IgYQogKiAgICAgc2VydmljZSByZXF1ZXN0LiBEZWZhdWx0cyB0byAxMC4KICoKICogQCFhdHRyaWJ1dGUgcGFyYW1WYWxpZGF0aW9uCiAqICAgQHJldHVybiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QKICogICAgIHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcgdGhlIHJlcXVlc3QuIERlZmF1bHRzIHRvIHRydWUuCiAqICAgICBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlIGZvbGxvd2luZyBzcGVjaWZpYyB2YWxpZGF0aW9uIGZlYXR1cmVzOgogKgogKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogKiAgICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICogICAgICAgdG8gYHRydWVgLgogKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogKiAgICAgICBjb25zdHJhaW50LgogKiAgICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogKiAgICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogKiAgICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogKgogKiBAIWF0dHJpYnV0ZSBjb21wdXRlQ2hlY2tzdW1zCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcyBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbgogKiAgICAgdGhlIHNlcnZpY2UgYWNjZXB0cyBpdCAoY3VycmVudGx5IHN1cHBvcnRlZCBpbiBTMyBhbmQgU1FTIG9ubHkpLgogKgogKiBAIWF0dHJpYnV0ZSBjb252ZXJ0UmVzcG9uc2VUeXBlcwogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZCB3aGVuIHBhcnNpbmcgcmVzcG9uc2UgZGF0YS4KICogICAgIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBmb3IgSlNPTiBiYXNlZCBzZXJ2aWNlcy4gVHVybmluZyB0aGlzIG9mZiBtYXkKICogICAgIGltcHJvdmUgcGVyZm9ybWFuY2Ugb24gbGFyZ2UgcmVzcG9uc2UgcGF5bG9hZHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICoKICogQCFhdHRyaWJ1dGUgY29ycmVjdENsb2NrU2tldwogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gYXBwbHkgYSBjbG9jayBza2V3IGNvcnJlY3Rpb24gYW5kIHJldHJ5CiAqICAgICByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50IGNsb2NrLiBEZWZhdWx0cyB0bwogKiAgICAgYGZhbHNlYC4KICoKICogQCFhdHRyaWJ1dGUgc3NsRW5hYmxlZAogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgU1NMIGlzIGVuYWJsZWQgZm9yIHJlcXVlc3RzCiAqCiAqIEAhYXR0cmlidXRlIHMzRm9yY2VQYXRoU3R5bGUKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGZvcmNlIHBhdGggc3R5bGUgVVJMcyBmb3IgUzMgb2JqZWN0cwogKgogKiBAIWF0dHJpYnV0ZSBzM0J1Y2tldEVuZHBvaW50CiAqICAgQG5vdGUgU2V0dGluZyB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIHJlcXVpcmVzIGFuIGBlbmRwb2ludGAgdG8gYmUKICogICAgIHByb3ZpZGVkIGV4cGxpY2l0bHkgdG8gdGhlIHNlcnZpY2UgY29uc3RydWN0b3IuCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwKICogICAgIGJ1Y2tldCAoZmFsc2UgaWYgaXQgYWRkcmVzc2VzIHRoZSByb290IEFQSSBlbmRwb2ludCkuCiAqCiAqIEAhYXR0cmlidXRlIHMzRGlzYWJsZUJvZHlTaWduaW5nCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBkaXNhYmxlIFMzIGJvZHkgc2lnbmluZyB3aGVuIHVzaW5nIHNpZ25hdHVyZSB2ZXJzaW9uIGB2NGAuCiAqICAgICBCb2R5IHNpZ25pbmcgY2FuIG9ubHkgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBodHRwcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogKgogKiBAIWF0dHJpYnV0ZSBzM1VzRWFzdDFSZWdpb25hbEVuZHBvaW50CiAqICAgQHJldHVybiBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hlbiByZWdpb24gaXMgc2V0IHRvICd1cy1lYXN0LTEnLCB3aGV0aGVyIHRvIHNlbmQgczMKICogICAgIHJlcXVlc3QgdG8gZ2xvYmFsIGVuZHBvaW50cyBvciAndXMtZWFzdC0xJyByZWdpb25hbCBlbmRwb2ludHMuIFRoaXMgY29uZmlnIGlzIG9ubHkKICogICAgIGFwcGxpY2FibGUgdG8gUzMgY2xpZW50OwogKiAgICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScKICogQCFhdHRyaWJ1dGUgczNVc2VBcm5SZWdpb24KICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIG92ZXJyaWRlIHRoZSByZXF1ZXN0IHJlZ2lvbiB3aXRoIHRoZSByZWdpb24gaW5mZXJyZWQKICogICAgIGZyb20gcmVxdWVzdGVkIHJlc291cmNlJ3MgQVJOLiBPbmx5IGF2YWlsYWJsZSBmb3IgUzMgYnVja2V0cwogKiAgICAgRGVmYXVsdHMgdG8gYHRydWVgCiAqCiAqIEAhYXR0cmlidXRlIHVzZUFjY2VsZXJhdGVFbmRwb2ludAogKiAgIEBub3RlIFRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gaXMgb25seSBjb21wYXRpYmxlIHdpdGggUzMgd2hpbGUgYWNjZXNzaW5nCiAqICAgICBkbnMtY29tcGF0aWJsZSBidWNrZXRzLgogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIFdoZXRoZXIgdG8gdXNlIHRoZSBBY2NlbGVyYXRlIGVuZHBvaW50IHdpdGggdGhlIFMzIHNlcnZpY2UuCiAqICAgICBEZWZhdWx0cyB0byBgZmFsc2VgLgogKgogKiBAIWF0dHJpYnV0ZSByZXRyeURlbGF5T3B0aW9ucwogKiAgIEBleGFtcGxlIFNldCB0aGUgYmFzZSByZXRyeSBkZWxheSBmb3IgYWxsIHNlcnZpY2VzIHRvIDMwMCBtcwogKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JldHJ5RGVsYXlPcHRpb25zOiB7YmFzZTogMzAwfX0pOwogKiAgICAgLy8gRGVsYXlzIHdpdGggbWF4UmV0cmllcyA9IDM6IDMwMCwgNjAwLCAxMjAwCiAqICAgQGV4YW1wbGUgU2V0IGEgY3VzdG9tIGJhY2tvZmYgZnVuY3Rpb24gdG8gcHJvdmlkZSBkZWxheSB2YWx1ZXMgb24gcmV0cmllcwogKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JldHJ5RGVsYXlPcHRpb25zOiB7Y3VzdG9tQmFja29mZjogZnVuY3Rpb24ocmV0cnlDb3VudCwgZXJyKSB7CiAqICAgICAgIC8vIHJldHVybnMgZGVsYXkgaW4gbXMKICogICAgIH19fSk7CiAqICAgQHJldHVybiBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIGNvbmZpZ3VyZSB0aGUgcmV0cnkgZGVsYXkgb24gcmV0cnlhYmxlIGVycm9ycy4KICogICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAqCiAqICAgICAqICoqYmFzZSoqIFtJbnRlZ2VyXSAmbWRhc2g7IFRoZSBiYXNlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdXNlIGluIHRoZQogKiAgICAgICBleHBvbmVudGlhbCBiYWNrb2ZmIGZvciBvcGVyYXRpb24gcmV0cmllcy4gRGVmYXVsdHMgdG8gMTAwIG1zIGZvciBhbGwgc2VydmljZXMgZXhjZXB0CiAqICAgICAgIER5bmFtb0RCLCB3aGVyZSBpdCBkZWZhdWx0cyB0byA1MG1zLgogKgogKiAgICAgKiAqKmN1c3RvbUJhY2tvZmYgKiogW2Z1bmN0aW9uXSAmbWRhc2g7IEEgY3VzdG9tIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBhCiAqICAgICAgIHJldHJ5IGNvdW50IGFuZCBlcnJvciBhbmQgcmV0dXJucyB0aGUgYW1vdW50IG9mIHRpbWUgdG8gZGVsYXkgaW4KICogICAgICAgbWlsbGlzZWNvbmRzLiBJZiB0aGUgcmVzdWx0IGlzIGEgbm9uLXplcm8gbmVnYXRpdmUgdmFsdWUsIG5vIGZ1cnRoZXIKICogICAgICAgcmV0cnkgYXR0ZW1wdHMgd2lsbCBiZSBtYWRlLiBUaGUgYGJhc2VgIG9wdGlvbiB3aWxsIGJlIGlnbm9yZWQgaWYgdGhpcwogKiAgICAgICBvcHRpb24gaXMgc3VwcGxpZWQuIFRoZSBmdW5jdGlvbiBpcyBvbmx5IGNhbGxlZCBmb3IgcmV0cnlhYmxlIGVycm9ycy4KICoKICogQCFhdHRyaWJ1dGUgaHR0cE9wdGlvbnMKICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsIEhUVFAgcmVxdWVzdC4KICogICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAqCiAqICAgICAqICoqcHJveHkqKiBbU3RyaW5nXSAmbWRhc2g7IHRoZSBVUkwgdG8gcHJveHkgcmVxdWVzdHMgdGhyb3VnaAogKiAgICAgKiAqKmFnZW50KiogW2h0dHAuQWdlbnQsIGh0dHBzLkFnZW50XSAmbWRhc2g7IHRoZSBBZ2VudCBvYmplY3QgdG8gcGVyZm9ybQogKiAgICAgICBIVFRQIHJlcXVlc3RzIHdpdGguIFVzZWQgZm9yIGNvbm5lY3Rpb24gcG9vbGluZy4gTm90ZSB0aGF0IGZvcgogKiAgICAgICBTU0wgY29ubmVjdGlvbnMsIGEgc3BlY2lhbCBBZ2VudCBvYmplY3QgaXMgdXNlZCBpbiBvcmRlciB0byBlbmFibGUKICogICAgICAgcGVlciBjZXJ0aWZpY2F0ZSB2ZXJpZmljYXRpb24uIFRoaXMgZmVhdHVyZSBpcyBvbmx5IHN1cHBvcnRlZCBpbiB0aGUKICogICAgICAgTm9kZS5qcyBlbnZpcm9ubWVudC4KICogICAgICogKipjb25uZWN0VGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyCiAqICAgICAgIGZhaWxpbmcgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIgYWZ0ZXIKICogICAgICAgYGNvbm5lY3RUaW1lb3V0YCBtaWxsaXNlY29uZHMuIFRoaXMgdGltZW91dCBoYXMgbm8gZWZmZWN0IG9uY2UgYSBzb2NrZXQKICogICAgICAgY29ubmVjdGlvbiBoYXMgYmVlbiBlc3RhYmxpc2hlZC4KICogICAgICogKip0aW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgYSByZXF1ZXN0IGNhbgogKiAgICAgICB0YWtlIGJlZm9yZSBhdXRvbWF0aWNhbGx5IGJlaW5nIHRlcm1pbmF0ZWQuCiAqICAgICAgIERlZmF1bHRzIHRvIHR3byBtaW51dGVzICgxMjAwMDApLgogKiAgICAgKiAqKnhockFzeW5jKiogW0Jvb2xlYW5dICZtZGFzaDsgV2hldGhlciB0aGUgU0RLIHdpbGwgc2VuZCBhc3luY2hyb25vdXMKICogICAgICAgSFRUUCByZXF1ZXN0cy4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvbmx5LiBTZXQgdG8gZmFsc2UgdG8KICogICAgICAgc2VuZCByZXF1ZXN0cyBzeW5jaHJvbm91c2x5LiBEZWZhdWx0cyB0byB0cnVlIChhc3luYyBvbikuCiAqICAgICAqICoqeGhyV2l0aENyZWRlbnRpYWxzKiogW0Jvb2xlYW5dICZtZGFzaDsgU2V0cyB0aGUgIndpdGhDcmVkZW50aWFscyIKICogICAgICAgcHJvcGVydHkgb2YgYW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0LiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50CiAqICAgICAgIG9ubHkuIERlZmF1bHRzIHRvIGZhbHNlLgogKiBAIWF0dHJpYnV0ZSBsb2dnZXIKICogICBAcmV0dXJuIFsjd3JpdGUsI2xvZ10gYW4gb2JqZWN0IHRoYXQgcmVzcG9uZHMgdG8gLndyaXRlKCkgKGxpa2UgYSBzdHJlYW0pCiAqICAgICBvciAubG9nKCkgKGxpa2UgdGhlIGNvbnNvbGUgb2JqZWN0KSBpbiBvcmRlciB0byBsb2cgaW5mb3JtYXRpb24gYWJvdXQKICogICAgIHJlcXVlc3RzCiAqCiAqIEAhYXR0cmlidXRlIHN5c3RlbUNsb2NrT2Zmc2V0CiAqICAgQHJldHVybiBbTnVtYmVyXSBhbiBvZmZzZXQgdmFsdWUgaW4gbWlsbGlzZWNvbmRzIHRvIGFwcGx5IHRvIGFsbCBzaWduaW5nCiAqICAgICB0aW1lcy4gVXNlIHRoaXMgdG8gY29tcGVuc2F0ZSBmb3IgY2xvY2sgc2tldyB3aGVuIHlvdXIgc3lzdGVtIG1heSBiZQogKiAgICAgb3V0IG9mIHN5bmMgd2l0aCB0aGUgc2VydmljZSB0aW1lLiBOb3RlIHRoYXQgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbgogKiAgICAgY2FuIG9ubHkgYmUgYXBwbGllZCB0byB0aGUgZ2xvYmFsIGBBV1MuY29uZmlnYCBvYmplY3QgYW5kIGNhbm5vdCBiZQogKiAgICAgb3ZlcnJpZGRlbiBpbiBzZXJ2aWNlLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24uIERlZmF1bHRzIHRvIDAgbWlsbGlzZWNvbmRzLgogKgogKiBAIWF0dHJpYnV0ZSBzaWduYXR1cmVWZXJzaW9uCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgc2lnbmF0dXJlIHZlcnNpb24gdG8gc2lnbiByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nCiAqICAgICB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOiAndjInLCAndjMnLCAndjQnLgogKgogKiBAIWF0dHJpYnV0ZSBzaWduYXR1cmVDYWNoZQogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHNpZ25hdHVyZSB0byBzaWduIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcKICogICAgIHRoZSBBUEkgY29uZmlndXJhdGlvbikgaXMgY2FjaGVkLiBPbmx5IGFwcGxpZXMgdG8gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uICd2NCcuCiAqICAgICBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAqCiAqIEAhYXR0cmlidXRlIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZAogKiAgIEByZXR1cm4gW0Jvb2xlYW58dW5kZWZpbmVkXSB3aGV0aGVyIHRvIGNhbGwgb3BlcmF0aW9ucyB3aXRoIGVuZHBvaW50cwogKiAgICAgZ2l2ZW4gYnkgc2VydmljZSBkeW5hbWljYWxseS4gU2V0dGluZyB0aGlzIGNvbmZpZyB0byBgdHJ1ZWAgd2lsbCBlbmFibGUKICogICAgIGVuZHBvaW50IGRpc2NvdmVyeSBmb3IgYWxsIGFwcGxpY2FibGUgb3BlcmF0aW9ucy4gU2V0dGluZyBpdCB0byBgZmFsc2VgCiAqICAgICB3aWxsIGV4cGxpY2l0bHkgZGlzYWJsZSBlbmRwb2ludCBkaXNjb3ZlcnkgZXZlbiB0aG91Z2ggb3BlcmF0aW9ucyB0aGF0CiAqICAgICByZXF1aXJlIGVuZHBvaW50IGRpc2NvdmVyeSB3aWxsIHByZXN1bWFibHkgZmFpbC4gTGVhdmluZyBpdCB0bwogKiAgICAgYHVuZGVmaW5lZGAgbWVhbnMgU0RLIG9ubHkgZG8gZW5kcG9pbnQgZGlzY292ZXJ5IHdoZW4gaXQncyByZXF1aXJlZC4KICogICAgIERlZmF1bHRzIHRvIGB1bmRlZmluZWRgCiAqCiAqIEAhYXR0cmlidXRlIGVuZHBvaW50Q2FjaGVTaXplCiAqICAgQHJldHVybiBbTnVtYmVyXSB0aGUgc2l6ZSBvZiB0aGUgZ2xvYmFsIGNhY2hlIHN0b3JpbmcgZW5kcG9pbnRzIGZyb20gZW5kcG9pbnQKICogICAgIGRpc2NvdmVyeSBvcGVyYXRpb25zLiBPbmNlIGVuZHBvaW50IGNhY2hlIGlzIGNyZWF0ZWQsIHVwZGF0aW5nIHRoaXMgc2V0dGluZwogKiAgICAgY2Fubm90IGNoYW5nZSBleGlzdGluZyBjYWNoZSBzaXplLgogKiAgICAgRGVmYXVsdHMgdG8gMTAwMAogKgogKiBAIWF0dHJpYnV0ZSBob3N0UHJlZml4RW5hYmxlZAogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0IHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZgogKiAgICAgaG9zdG5hbWUuIERlZmF1bHRzIHRvIGB0cnVlYC4KICoKICogQCFhdHRyaWJ1dGUgc3RzUmVnaW9uYWxFbmRwb2ludHMKICogICBAcmV0dXJuIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGV0aGVyIHRvIHNlbmQgc3RzIHJlcXVlc3QgdG8gZ2xvYmFsIGVuZHBvaW50cyBvcgogKiAgICAgcmVnaW9uYWwgZW5kcG9pbnRzLgogKiAgICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScuCiAqCiAqIEAhYXR0cmlidXRlIHVzZUZpcHNFbmRwb2ludAogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIEVuYWJsZXMgRklQUyBjb21wYXRpYmxlIGVuZHBvaW50cy4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICoKICogQCFhdHRyaWJ1dGUgdXNlRHVhbHN0YWNrRW5kcG9pbnQKICogICBAcmV0dXJuIFtCb29sZWFuXSBFbmFibGVzIElQdjYgZHVhbHN0YWNrIGVuZHBvaW50LiBEZWZhdWx0cyB0byBgZmFsc2VgLgogKi8KQVdTLkNvbmZpZyA9IEFXUy51dGlsLmluaGVyaXQoewogIC8qKgogICAqIEAhZW5kZ3JvdXAKICAgKi8KCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBjb25maWd1cmF0aW9uIG9iamVjdC4gVGhpcyBpcyB0aGUgb2JqZWN0IHRoYXQgcGFzc2VzCiAgICogb3B0aW9uIGRhdGEgYWxvbmcgdG8gc2VydmljZSByZXF1ZXN0cywgaW5jbHVkaW5nIGNyZWRlbnRpYWxzLCBzZWN1cml0eSwKICAgKiByZWdpb24gaW5mb3JtYXRpb24sIGFuZCBzb21lIHNlcnZpY2Ugc3BlY2lmaWMgc2V0dGluZ3MuCiAgICoKICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjb25maWd1cmF0aW9uIG9iamVjdCB3aXRoIGNyZWRlbnRpYWxzIGFuZCByZWdpb24KICAgKiAgIHZhciBjb25maWcgPSBuZXcgQVdTLkNvbmZpZyh7CiAgICogICAgIGFjY2Vzc0tleUlkOiAnQUtJRCcsIHNlY3JldEFjY2Vzc0tleTogJ1NFQ1JFVCcsIHJlZ2lvbjogJ3VzLXdlc3QtMicKICAgKiAgIH0pOwogICAqIEBvcHRpb24gb3B0aW9ucyBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB5b3VyIEFXUyBhY2Nlc3Mga2V5IElELgogICAqIEBvcHRpb24gb3B0aW9ucyBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10geW91ciBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkuCiAgICogQG9wdGlvbiBvcHRpb25zIHNlc3Npb25Ub2tlbiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgb3B0aW9uYWwgQVdTCiAgICogICBzZXNzaW9uIHRva2VuIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIEFXUyBjcmVkZW50aWFscwogICAqICAgdG8gc2lnbiByZXF1ZXN0cyB3aXRoLiBZb3UgY2FuIGVpdGhlciBzcGVjaWZ5IHRoaXMgb2JqZWN0LCBvcgogICAqICAgc3BlY2lmeSB0aGUgYWNjZXNzS2V5SWQgYW5kIHNlY3JldEFjY2Vzc0tleSBvcHRpb25zIGRpcmVjdGx5LgogICAqIEBvcHRpb24gb3B0aW9ucyBjcmVkZW50aWFsUHJvdmlkZXIgW0FXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl0gdGhlCiAgICogICBwcm92aWRlciBjaGFpbiB1c2VkIHRvIHJlc29sdmUgY3JlZGVudGlhbHMgaWYgbm8gc3RhdGljIGBjcmVkZW50aWFsc2AKICAgKiAgIHByb3BlcnR5IGlzIHNldC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgcmVnaW9uIFtTdHJpbmddIHRoZSByZWdpb24gdG8gc2VuZCBzZXJ2aWNlIHJlcXVlc3RzIHRvLgogICAqICAgU2VlIHtyZWdpb259IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAqIEBvcHRpb24gb3B0aW9ucyBtYXhSZXRyaWVzIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmV0cmllcyB0bwogICAqICAgYXR0ZW1wdCB3aXRoIGEgcmVxdWVzdC4gU2VlIHttYXhSZXRyaWVzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgKiBAb3B0aW9uIG9wdGlvbnMgbWF4UmVkaXJlY3RzIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmVkaXJlY3RzIHRvCiAgICogICBmb2xsb3cgd2l0aCBhIHJlcXVlc3QuIFNlZSB7bWF4UmVkaXJlY3RzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgKiBAb3B0aW9uIG9wdGlvbnMgc3NsRW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgU1NMIGZvcgogICAqICAgcmVxdWVzdHMuCiAgICogQG9wdGlvbiBvcHRpb25zIHBhcmFtVmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycwogICAqICAgc2hvdWxkIGJlIHZhbGlkYXRlZCBhZ2FpbnN0IHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcKICAgKiAgIHRoZSByZXF1ZXN0LiBEZWZhdWx0cyB0byB0cnVlLiBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlCiAgICogICBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgKgogICAqICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAqICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgKiAgICAgdG8gYHRydWVgLgogICAqICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAqICAgICBjb25zdHJhaW50LgogICAqICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgKiAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAqICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAqICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAqIEBvcHRpb24gb3B0aW9ucyBjb21wdXRlQ2hlY2tzdW1zIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbXB1dGUgY2hlY2tzdW1zCiAgICogICBmb3IgcGF5bG9hZCBib2RpZXMgd2hlbiB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkCiAgICogICBpbiBTMyBvbmx5KQogICAqIEBvcHRpb24gb3B0aW9ucyBjb252ZXJ0UmVzcG9uc2VUeXBlcyBbQm9vbGVhbl0gd2hldGhlciB0eXBlcyBhcmUgY29udmVydGVkCiAgICogICAgIHdoZW4gcGFyc2luZyByZXNwb25zZSBkYXRhLiBDdXJyZW50bHkgb25seSBzdXBwb3J0ZWQgZm9yIEpTT04gYmFzZWQKICAgKiAgICAgc2VydmljZXMuIFR1cm5pbmcgdGhpcyBvZmYgbWF5IGltcHJvdmUgcGVyZm9ybWFuY2Ugb24gbGFyZ2UgcmVzcG9uc2UKICAgKiAgICAgcGF5bG9hZHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgY29ycmVjdENsb2NrU2tldyBbQm9vbGVhbl0gd2hldGhlciB0byBhcHBseSBhIGNsb2NrIHNrZXcKICAgKiAgICAgY29ycmVjdGlvbiBhbmQgcmV0cnkgcmVxdWVzdHMgdGhhdCBmYWlsIGJlY2F1c2Ugb2YgYW4gc2tld2VkIGNsaWVudAogICAqICAgICBjbG9jay4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgczNGb3JjZVBhdGhTdHlsZSBbQm9vbGVhbl0gd2hldGhlciB0byBmb3JjZSBwYXRoCiAgICogICBzdHlsZSBVUkxzIGZvciBTMyBvYmplY3RzLgogICAqIEBvcHRpb24gb3B0aW9ucyBzM0J1Y2tldEVuZHBvaW50IFtCb29sZWFuXSB3aGV0aGVyIHRoZSBwcm92aWRlZCBlbmRwb2ludAogICAqICAgYWRkcmVzc2VzIGFuIGluZGl2aWR1YWwgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJCiAgICogICBlbmRwb2ludCkuIE5vdGUgdGhhdCBzZXR0aW5nIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gcmVxdWlyZXMgYW4KICAgKiAgIGBlbmRwb2ludGAgdG8gYmUgcHJvdmlkZWQgZXhwbGljaXRseSB0byB0aGUgc2VydmljZSBjb25zdHJ1Y3Rvci4KICAgKiBAb3B0aW9uIG9wdGlvbnMgczNEaXNhYmxlQm9keVNpZ25pbmcgW0Jvb2xlYW5dIHdoZXRoZXIgUzMgYm9keSBzaWduaW5nCiAgICogICBzaG91bGQgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBzaWduYXR1cmUgdmVyc2lvbiBgdjRgLiBCb2R5IHNpZ25pbmcKICAgKiAgIGNhbiBvbmx5IGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgaHR0cHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgczNVc0Vhc3QxUmVnaW9uYWxFbmRwb2ludCBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hlbiByZWdpb24KICAgKiAgIGlzIHNldCB0byAndXMtZWFzdC0xJywgd2hldGhlciB0byBzZW5kIHMzIHJlcXVlc3QgdG8gZ2xvYmFsIGVuZHBvaW50cyBvcgogICAqICAgJ3VzLWVhc3QtMScgcmVnaW9uYWwgZW5kcG9pbnRzLiBUaGlzIGNvbmZpZyBpcyBvbmx5IGFwcGxpY2FibGUgdG8gUzMgY2xpZW50LgogICAqICAgRGVmYXVsdHMgdG8gYGxlZ2FjeWAKICAgKiBAb3B0aW9uIG9wdGlvbnMgczNVc2VBcm5SZWdpb24gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gb3ZlcnJpZGUgdGhlIHJlcXVlc3QgcmVnaW9uCiAgICogICB3aXRoIHRoZSByZWdpb24gaW5mZXJyZWQgZnJvbSByZXF1ZXN0ZWQgcmVzb3VyY2UncyBBUk4uIE9ubHkgYXZhaWxhYmxlIGZvciBTMyBidWNrZXRzCiAgICogICBEZWZhdWx0cyB0byBgdHJ1ZWAKICAgKgogICAqIEBvcHRpb24gb3B0aW9ucyByZXRyeURlbGF5T3B0aW9ucyBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIGNvbmZpZ3VyZQogICAqICAgdGhlIHJldHJ5IGRlbGF5IG9uIHJldHJ5YWJsZSBlcnJvcnMuIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICoKICAgKiAgICogKipiYXNlKiogW0ludGVnZXJdICZtZGFzaDsgVGhlIGJhc2UgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB1c2UgaW4gdGhlCiAgICogICAgIGV4cG9uZW50aWFsIGJhY2tvZmYgZm9yIG9wZXJhdGlvbiByZXRyaWVzLiBEZWZhdWx0cyB0byAxMDAgbXMgZm9yIGFsbAogICAqICAgICBzZXJ2aWNlcyBleGNlcHQgRHluYW1vREIsIHdoZXJlIGl0IGRlZmF1bHRzIHRvIDUwbXMuCiAgICogICAqICoqY3VzdG9tQmFja29mZiAqKiBbZnVuY3Rpb25dICZtZGFzaDsgQSBjdXN0b20gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEKICAgKiAgICAgcmV0cnkgY291bnQgYW5kIGVycm9yIGFuZCByZXR1cm5zIHRoZSBhbW91bnQgb2YgdGltZSB0byBkZWxheSBpbgogICAqICAgICBtaWxsaXNlY29uZHMuIElmIHRoZSByZXN1bHQgaXMgYSBub24temVybyBuZWdhdGl2ZSB2YWx1ZSwgbm8gZnVydGhlcgogICAqICAgICByZXRyeSBhdHRlbXB0cyB3aWxsIGJlIG1hZGUuIFRoZSBgYmFzZWAgb3B0aW9uIHdpbGwgYmUgaWdub3JlZCBpZiB0aGlzCiAgICogICAgIG9wdGlvbiBpcyBzdXBwbGllZC4gVGhlIGZ1bmN0aW9uIGlzIG9ubHkgY2FsbGVkIGZvciByZXRyeWFibGUgZXJyb3JzLgogICAqIEBvcHRpb24gb3B0aW9ucyBodHRwT3B0aW9ucyBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIHBhc3MgdG8gdGhlIGxvdy1sZXZlbAogICAqICAgSFRUUCByZXF1ZXN0LiBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAqCiAgICogICAqICoqcHJveHkqKiBbU3RyaW5nXSAmbWRhc2g7IHRoZSBVUkwgdG8gcHJveHkgcmVxdWVzdHMgdGhyb3VnaAogICAqICAgKiAqKmFnZW50KiogW2h0dHAuQWdlbnQsIGh0dHBzLkFnZW50XSAmbWRhc2g7IHRoZSBBZ2VudCBvYmplY3QgdG8gcGVyZm9ybQogICAqICAgICBIVFRQIHJlcXVlc3RzIHdpdGguIFVzZWQgZm9yIGNvbm5lY3Rpb24gcG9vbGluZy4gRGVmYXVsdHMgdG8gdGhlIGdsb2JhbAogICAqICAgICBhZ2VudCAoYGh0dHAuZ2xvYmFsQWdlbnRgKSBmb3Igbm9uLVNTTCBjb25uZWN0aW9ucy4gTm90ZSB0aGF0IGZvcgogICAqICAgICBTU0wgY29ubmVjdGlvbnMsIGEgc3BlY2lhbCBBZ2VudCBvYmplY3QgaXMgdXNlZCBpbiBvcmRlciB0byBlbmFibGUKICAgKiAgICAgcGVlciBjZXJ0aWZpY2F0ZSB2ZXJpZmljYXRpb24uIFRoaXMgZmVhdHVyZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiB0aGUKICAgKiAgICAgTm9kZS5qcyBlbnZpcm9ubWVudC4KICAgKiAgICogKipjb25uZWN0VGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyCiAgICogICAgIGZhaWxpbmcgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIgYWZ0ZXIKICAgKiAgICAgYGNvbm5lY3RUaW1lb3V0YCBtaWxsaXNlY29uZHMuIFRoaXMgdGltZW91dCBoYXMgbm8gZWZmZWN0IG9uY2UgYSBzb2NrZXQKICAgKiAgICAgY29ubmVjdGlvbiBoYXMgYmVlbiBlc3RhYmxpc2hlZC4KICAgKiAgICogKip0aW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIgdGltZW91dAogICAqICAgICBtaWxsaXNlY29uZHMgb2YgaW5hY3Rpdml0eSBvbiB0aGUgc29ja2V0LiBEZWZhdWx0cyB0byB0d28gbWludXRlcwogICAqICAgICAoMTIwMDAwKS4KICAgKiAgICogKip4aHJBc3luYyoqIFtCb29sZWFuXSAmbWRhc2g7IFdoZXRoZXIgdGhlIFNESyB3aWxsIHNlbmQgYXN5bmNocm9ub3VzCiAgICogICAgIEhUVFAgcmVxdWVzdHMuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb25seS4gU2V0IHRvIGZhbHNlIHRvCiAgICogICAgIHNlbmQgcmVxdWVzdHMgc3luY2hyb25vdXNseS4gRGVmYXVsdHMgdG8gdHJ1ZSAoYXN5bmMgb24pLgogICAqICAgKiAqKnhocldpdGhDcmVkZW50aWFscyoqIFtCb29sZWFuXSAmbWRhc2g7IFNldHMgdGhlICJ3aXRoQ3JlZGVudGlhbHMiCiAgICogICAgIHByb3BlcnR5IG9mIGFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdC4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudAogICAqICAgICBvbmx5LiBEZWZhdWx0cyB0byBmYWxzZS4KICAgKiBAb3B0aW9uIG9wdGlvbnMgYXBpVmVyc2lvbiBbU3RyaW5nLCBEYXRlXSBhIFN0cmluZyBpbiBZWVlZLU1NLUREIGZvcm1hdAogICAqICAgKG9yIGEgZGF0ZSkgdGhhdCByZXByZXNlbnRzIHRoZSBsYXRlc3QgcG9zc2libGUgQVBJIHZlcnNpb24gdGhhdCBjYW4gYmUKICAgKiAgIHVzZWQgaW4gYWxsIHNlcnZpY2VzICh1bmxlc3Mgb3ZlcnJpZGRlbiBieSBgYXBpVmVyc2lvbnNgKS4gU3BlY2lmeQogICAqICAgJ2xhdGVzdCcgdG8gdXNlIHRoZSBsYXRlc3QgcG9zc2libGUgdmVyc2lvbi4KICAgKiBAb3B0aW9uIG9wdGlvbnMgYXBpVmVyc2lvbnMgW21hcDxTdHJpbmcsIFN0cmluZ3xEYXRlPl0gYSBtYXAgb2Ygc2VydmljZQogICAqICAgaWRlbnRpZmllcnMgKHRoZSBsb3dlcmNhc2Ugc2VydmljZSBjbGFzcyBuYW1lKSB3aXRoIHRoZSBBUEkgdmVyc2lvbiB0bwogICAqICAgdXNlIHdoZW4gaW5zdGFudGlhdGluZyBhIHNlcnZpY2UuIFNwZWNpZnkgJ2xhdGVzdCcgZm9yIGVhY2ggaW5kaXZpZHVhbAogICAqICAgdGhhdCBjYW4gdXNlIHRoZSBsYXRlc3QgYXZhaWxhYmxlIHZlcnNpb24uCiAgICogQG9wdGlvbiBvcHRpb25zIGxvZ2dlciBbI3dyaXRlLCNsb2ddIGFuIG9iamVjdCB0aGF0IHJlc3BvbmRzIHRvIC53cml0ZSgpCiAgICogICAobGlrZSBhIHN0cmVhbSkgb3IgLmxvZygpIChsaWtlIHRoZSBjb25zb2xlIG9iamVjdCkgaW4gb3JkZXIgdG8gbG9nCiAgICogICBpbmZvcm1hdGlvbiBhYm91dCByZXF1ZXN0cwogICAqIEBvcHRpb24gb3B0aW9ucyBzeXN0ZW1DbG9ja09mZnNldCBbTnVtYmVyXSBhbiBvZmZzZXQgdmFsdWUgaW4gbWlsbGlzZWNvbmRzCiAgICogICB0byBhcHBseSB0byBhbGwgc2lnbmluZyB0aW1lcy4gVXNlIHRoaXMgdG8gY29tcGVuc2F0ZSBmb3IgY2xvY2sgc2tldwogICAqICAgd2hlbiB5b3VyIHN5c3RlbSBtYXkgYmUgb3V0IG9mIHN5bmMgd2l0aCB0aGUgc2VydmljZSB0aW1lLiBOb3RlIHRoYXQKICAgKiAgIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gY2FuIG9ubHkgYmUgYXBwbGllZCB0byB0aGUgZ2xvYmFsIGBBV1MuY29uZmlnYAogICAqICAgb2JqZWN0IGFuZCBjYW5ub3QgYmUgb3ZlcnJpZGRlbiBpbiBzZXJ2aWNlLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24uCiAgICogICBEZWZhdWx0cyB0byAwIG1pbGxpc2Vjb25kcy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgc2lnbmF0dXJlVmVyc2lvbiBbU3RyaW5nXSB0aGUgc2lnbmF0dXJlIHZlcnNpb24gdG8gc2lnbgogICAqICAgcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZyB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOgogICAqICAgJ3YyJywgJ3YzJywgJ3Y0Jy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgc2lnbmF0dXJlQ2FjaGUgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHNpZ25hdHVyZSB0byBzaWduCiAgICogICByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nIHRoZSBBUEkgY29uZmlndXJhdGlvbikgaXMgY2FjaGVkLiBPbmx5IGFwcGxpZXMKICAgKiAgIHRvIHRoZSBzaWduYXR1cmUgdmVyc2lvbiAndjQnLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIGR5bmFtb0RiQ3JjMzIgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gdmFsaWRhdGUgdGhlIENSQzMyCiAgICogICBjaGVja3N1bSBvZiBIVFRQIHJlc3BvbnNlIGJvZGllcyByZXR1cm5lZCBieSBEeW5hbW9EQi4gRGVmYXVsdDogYHRydWVgLgogICAqIEBvcHRpb24gb3B0aW9ucyB1c2VBY2NlbGVyYXRlRW5kcG9pbnQgW0Jvb2xlYW5dIFdoZXRoZXIgdG8gdXNlIHRoZQogICAqICAgUzMgVHJhbnNmZXIgQWNjZWxlcmF0aW9uIGVuZHBvaW50IHdpdGggdGhlIFMzIHNlcnZpY2UuIERlZmF1bHQ6IGBmYWxzZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIGNsaWVudFNpZGVNb25pdG9yaW5nIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbGxlY3QgYW5kCiAgICogICBwdWJsaXNoIHRoaXMgY2xpZW50J3MgcGVyZm9ybWFuY2UgbWV0cmljcyBvZiBhbGwgaXRzIEFQSSByZXF1ZXN0cy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkIFtCb29sZWFufHVuZGVmaW5lZF0gd2hldGhlciB0bwogICAqICAgY2FsbCBvcGVyYXRpb25zIHdpdGggZW5kcG9pbnRzIGdpdmVuIGJ5IHNlcnZpY2UgZHluYW1pY2FsbHkuIFNldHRpbmcgdGhpcwogICAqIGNvbmZpZyB0byBgdHJ1ZWAgd2lsbCBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5IGZvciBhbGwgYXBwbGljYWJsZSBvcGVyYXRpb25zLgogICAqICAgU2V0dGluZyBpdCB0byBgZmFsc2VgIHdpbGwgZXhwbGljaXRseSBkaXNhYmxlIGVuZHBvaW50IGRpc2NvdmVyeSBldmVuIHRob3VnaAogICAqICAgb3BlcmF0aW9ucyB0aGF0IHJlcXVpcmUgZW5kcG9pbnQgZGlzY292ZXJ5IHdpbGwgcHJlc3VtYWJseSBmYWlsLiBMZWF2aW5nIGl0CiAgICogICB0byBgdW5kZWZpbmVkYCBtZWFucyBTREsgd2lsbCBvbmx5IGRvIGVuZHBvaW50IGRpc2NvdmVyeSB3aGVuIGl0J3MgcmVxdWlyZWQuCiAgICogICBEZWZhdWx0cyB0byBgdW5kZWZpbmVkYAogICAqIEBvcHRpb24gb3B0aW9ucyBlbmRwb2ludENhY2hlU2l6ZSBbTnVtYmVyXSB0aGUgc2l6ZSBvZiB0aGUgZ2xvYmFsIGNhY2hlIHN0b3JpbmcKICAgKiAgIGVuZHBvaW50cyBmcm9tIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb25zLiBPbmNlIGVuZHBvaW50IGNhY2hlIGlzIGNyZWF0ZWQsCiAgICogICB1cGRhdGluZyB0aGlzIHNldHRpbmcgY2Fubm90IGNoYW5nZSBleGlzdGluZyBjYWNoZSBzaXplLgogICAqICAgRGVmYXVsdHMgdG8gMTAwMAogICAqIEBvcHRpb24gb3B0aW9ucyBob3N0UHJlZml4RW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBtYXJzaGFsIHJlcXVlc3QKICAgKiAgIHBhcmFtZXRlcnMgdG8gdGhlIHByZWZpeCBvZiBob3N0bmFtZS4KICAgKiAgIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgc3RzUmVnaW9uYWxFbmRwb2ludHMgWydsZWdhY3knfCdyZWdpb25hbCddIHdoZXRoZXIgdG8gc2VuZCBzdHMgcmVxdWVzdAogICAqICAgdG8gZ2xvYmFsIGVuZHBvaW50cyBvciByZWdpb25hbCBlbmRwb2ludHMuCiAgICogICBEZWZhdWx0cyB0byAnbGVnYWN5Jy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgdXNlRmlwc0VuZHBvaW50IFtCb29sZWFuXSBFbmFibGVzIEZJUFMgY29tcGF0aWJsZSBlbmRwb2ludHMuCiAgICogICBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAqIEBvcHRpb24gb3B0aW9ucyB1c2VEdWFsc3RhY2tFbmRwb2ludCBbQm9vbGVhbl0gRW5hYmxlcyBJUHY2IGR1YWxzdGFjayBlbmRwb2ludC4KICAgKiAgIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENvbmZpZyhvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkKSBvcHRpb25zID0ge307CiAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CgogICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMua2V5cywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgdGhpcy5zZXQoa2V5LCBvcHRpb25zW2tleV0sIHZhbHVlKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEAhZ3JvdXAgTWFuYWdpbmcgQ3JlZGVudGlhbHMKICAgKi8KCiAgLyoqCiAgICogTG9hZHMgY3JlZGVudGlhbHMgZnJvbSB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuIFRoaXMgaXMgdXNlZCBpbnRlcm5hbGx5CiAgICogYnkgdGhlIFNESyB0byBlbnN1cmUgdGhhdCByZWZyZXNoYWJsZSB7Q3JlZGVudGlhbHN9IG9iamVjdHMgYXJlIHByb3Blcmx5CiAgICogcmVmcmVzaGVkIGFuZCBsb2FkZWQgd2hlbiBzZW5kaW5nIGEgcmVxdWVzdC4gSWYgeW91IHdhbnQgdG8gZW5zdXJlIHRoYXQKICAgKiB5b3VyIGNyZWRlbnRpYWxzIGFyZSBsb2FkZWQgcHJpb3IgdG8gYSByZXF1ZXN0LCB5b3UgY2FuIHVzZSB0aGlzIG1ldGhvZAogICAqIGRpcmVjdGx5IHRvIHByb3ZpZGUgYWNjdXJhdGUgY3JlZGVudGlhbCBkYXRhIHN0b3JlZCBpbiB0aGUgb2JqZWN0LgogICAqCiAgICogQG5vdGUgSWYgeW91IGNvbmZpZ3VyZSB0aGUgU0RLIHdpdGggc3RhdGljIG9yIGVudmlyb25tZW50IGNyZWRlbnRpYWxzLAogICAqICAgdGhlIGNyZWRlbnRpYWwgZGF0YSBzaG91bGQgYWxyZWFkeSBiZSBwcmVzZW50IGluIHtjcmVkZW50aWFsc30gYXR0cmlidXRlLgogICAqICAgVGhpcyBtZXRob2QgaXMgcHJpbWFyaWx5IG5lY2Vzc2FyeSB0byBsb2FkIGNyZWRlbnRpYWxzIGZyb20gYXN5bmNocm9ub3VzCiAgICogICBzb3VyY2VzLCBvciBzb3VyY2VzIHRoYXQgY2FuIHJlZnJlc2ggY3JlZGVudGlhbHMgcGVyaW9kaWNhbGx5LgogICAqIEBleGFtcGxlIEdldHRpbmcgeW91ciBhY2Nlc3Mga2V5CiAgICogICBBV1MuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uKGVycikgewogICAqICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZyhlcnIuc3RhY2spOyAvLyBjcmVkZW50aWFscyBub3QgbG9hZGVkCiAgICogICAgIGVsc2UgY29uc29sZS5sb2coIkFjY2VzcyBLZXk6IiwgQVdTLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCk7CiAgICogICB9KQogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBDYWxsZWQgd2hlbiB0aGUge2NyZWRlbnRpYWxzfSBoYXZlIGJlZW4gcHJvcGVybHkgc2V0IG9uIHRoZSBjb25maWd1cmF0aW9uCiAgICogICBvYmplY3QuCiAgICoKICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiB0aGlzIGlzIHNldCwgY3JlZGVudGlhbHMgd2VyZSBub3Qgc3VjY2Vzc2Z1bGx5CiAgICogICAgIGxvYWRlZCBhbmQgdGhpcyBlcnJvciBwcm92aWRlcyBpbmZvcm1hdGlvbiB3aHkuCiAgICogQHNlZSBjcmVkZW50aWFscwogICAqIEBzZWUgQ3JlZGVudGlhbHMKICAgKi8KICBnZXRDcmVkZW50aWFsczogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHMoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBmdW5jdGlvbiBmaW5pc2goZXJyKSB7CiAgICAgIGNhbGxiYWNrKGVyciwgZXJyID8gbnVsbCA6IHNlbGYuY3JlZGVudGlhbHMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWRFcnJvcihtc2csIGVycikgewogICAgICByZXR1cm4gbmV3IEFXUy51dGlsLmVycm9yKGVyciB8fCBuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdDcmVkZW50aWFsc0Vycm9yJywKICAgICAgICBtZXNzYWdlOiBtc2csCiAgICAgICAgbmFtZTogJ0NyZWRlbnRpYWxzRXJyb3InCiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEFzeW5jQ3JlZGVudGlhbHMoKSB7CiAgICAgIHNlbGYuY3JlZGVudGlhbHMuZ2V0KGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHZhciBtc2cgPSAnQ291bGQgbm90IGxvYWQgY3JlZGVudGlhbHMgZnJvbSAnICsKICAgICAgICAgICAgc2VsZi5jcmVkZW50aWFscy5jb25zdHJ1Y3Rvci5uYW1lOwogICAgICAgICAgZXJyID0gY3JlZEVycm9yKG1zZywgZXJyKTsKICAgICAgICB9CiAgICAgICAgZmluaXNoKGVycik7CiAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFN0YXRpY0NyZWRlbnRpYWxzKCkgewogICAgICB2YXIgZXJyID0gbnVsbDsKICAgICAgaWYgKCFzZWxmLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkIHx8ICFzZWxmLmNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSkgewogICAgICAgIGVyciA9IGNyZWRFcnJvcignTWlzc2luZyBjcmVkZW50aWFscycpOwogICAgICB9CiAgICAgIGZpbmlzaChlcnIpOwogICAgfQoKICAgIGlmIChzZWxmLmNyZWRlbnRpYWxzKSB7CiAgICAgIGlmICh0eXBlb2Ygc2VsZi5jcmVkZW50aWFscy5nZXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBnZXRBc3luY0NyZWRlbnRpYWxzKCk7CiAgICAgIH0gZWxzZSB7IC8vIHN0YXRpYyBjcmVkZW50aWFscwogICAgICAgIGdldFN0YXRpY0NyZWRlbnRpYWxzKCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoc2VsZi5jcmVkZW50aWFsUHJvdmlkZXIpIHsKICAgICAgc2VsZi5jcmVkZW50aWFsUHJvdmlkZXIucmVzb2x2ZShmdW5jdGlvbihlcnIsIGNyZWRzKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgZXJyID0gY3JlZEVycm9yKCdDb3VsZCBub3QgbG9hZCBjcmVkZW50aWFscyBmcm9tIGFueSBwcm92aWRlcnMnLCBlcnIpOwogICAgICAgIH0KICAgICAgICBzZWxmLmNyZWRlbnRpYWxzID0gY3JlZHM7CiAgICAgICAgZmluaXNoKGVycik7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZmluaXNoKGNyZWRFcnJvcignTm8gY3JlZGVudGlhbHMgdG8gbG9hZCcpKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAIWdyb3VwIExvYWRpbmcgYW5kIFNldHRpbmcgQ29uZmlndXJhdGlvbiBPcHRpb25zCiAgICovCgogIC8qKgogICAqIEBvdmVybG9hZCB1cGRhdGUob3B0aW9ucywgYWxsb3dVbmtub3duS2V5cyA9IGZhbHNlKQogICAqICAgVXBkYXRlcyB0aGUgY3VycmVudCBjb25maWd1cmF0aW9uIG9iamVjdCB3aXRoIG5ldyBvcHRpb25zLgogICAqCiAgICogICBAZXhhbXBsZSBVcGRhdGUgbWF4UmV0cmllcyBwcm9wZXJ0eSBvZiBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICogICAgIGNvbmZpZy51cGRhdGUoe21heFJldHJpZXM6IDEwfSk7CiAgICogICBAcGFyYW0gW09iamVjdF0gb3B0aW9ucyBhIG1hcCBvZiBvcHRpb24ga2V5cyBhbmQgdmFsdWVzLgogICAqICAgQHBhcmFtIFtCb29sZWFuXSBhbGxvd1Vua25vd25LZXlzIHdoZXRoZXIgdW5rbm93biBrZXlzIGNhbiBiZSBzZXQgb24KICAgKiAgICAgdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAqICAgQHNlZSBjb25zdHJ1Y3RvcgogICAqLwogIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9wdGlvbnMsIGFsbG93VW5rbm93bktleXMpIHsKICAgIGFsbG93VW5rbm93bktleXMgPSBhbGxvd1Vua25vd25LZXlzIHx8IGZhbHNlOwogICAgb3B0aW9ucyA9IHRoaXMuZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpOwogICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIGlmIChhbGxvd1Vua25vd25LZXlzIHx8IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmtleXMsIGtleSkgfHwKICAgICAgICAgIEFXUy5TZXJ2aWNlLmhhc1NlcnZpY2Uoa2V5KSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBMb2FkcyBjb25maWd1cmF0aW9uIGRhdGEgZnJvbSBhIEpTT04gZmlsZSBpbnRvIHRoaXMgY29uZmlnIG9iamVjdC4KICAgKiBAbm90ZSBMb2FkaW5nIGNvbmZpZ3VyYXRpb24gd2lsbCByZXNldCBhbGwgZXhpc3RpbmcgY29uZmlndXJhdGlvbgogICAqICAgb24gdGhlIG9iamVjdC4KICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAqIEBwYXJhbSBwYXRoIFtTdHJpbmddIHRoZSBwYXRoIHJlbGF0aXZlIHRvIHlvdXIgcHJvY2VzcydzIGN1cnJlbnQKICAgKiAgICB3b3JraW5nIGRpcmVjdG9yeSB0byBsb2FkIGNvbmZpZ3VyYXRpb24gZnJvbS4KICAgKiBAcmV0dXJuIFtBV1MuQ29uZmlnXSB0aGUgc2FtZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAqLwogIGxvYWRGcm9tUGF0aDogZnVuY3Rpb24gbG9hZEZyb21QYXRoKHBhdGgpIHsKICAgIHRoaXMuY2xlYXIoKTsKCiAgICB2YXIgb3B0aW9ucyA9IEpTT04ucGFyc2UoQVdTLnV0aWwucmVhZEZpbGVTeW5jKHBhdGgpKTsKICAgIHZhciBmaWxlU3lzdGVtQ3JlZHMgPSBuZXcgQVdTLkZpbGVTeXN0ZW1DcmVkZW50aWFscyhwYXRoKTsKICAgIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICAgIGNoYWluLnByb3ZpZGVycy51bnNoaWZ0KGZpbGVTeXN0ZW1DcmVkcyk7CiAgICBjaGFpbi5yZXNvbHZlKGZ1bmN0aW9uIChlcnIsIGNyZWRzKSB7CiAgICAgIGlmIChlcnIpIHRocm93IGVycjsKICAgICAgZWxzZSBvcHRpb25zLmNyZWRlbnRpYWxzID0gY3JlZHM7CiAgICB9KTsKCiAgICB0aGlzLmNvbnN0cnVjdG9yKG9wdGlvbnMpOwoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIENsZWFycyBjb25maWd1cmF0aW9uIGRhdGEgb24gdGhpcyBvYmplY3QKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNsZWFyOiBmdW5jdGlvbiBjbGVhcigpIHsKICAgIC8qanNoaW50IGZvcmluOmZhbHNlICovCiAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5rZXlzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICB9KTsKCiAgICAvLyByZXNldCBjcmVkZW50aWFsIHByb3ZpZGVyCiAgICB0aGlzLnNldCgnY3JlZGVudGlhbHMnLCB1bmRlZmluZWQpOwogICAgdGhpcy5zZXQoJ2NyZWRlbnRpYWxQcm92aWRlcicsIHVuZGVmaW5lZCk7CiAgfSwKCiAgLyoqCiAgICogU2V0cyBhIHByb3BlcnR5IG9uIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCwgYWxsb3dpbmcgZm9yIGEKICAgKiBkZWZhdWx0IHZhbHVlCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2V0OiBmdW5jdGlvbiBzZXQocHJvcGVydHksIHZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGRlZmF1bHRWYWx1ZSA9IHRoaXMua2V5c1twcm9wZXJ0eV07CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkZWZhdWx0VmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZS5jYWxsKHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXNbcHJvcGVydHldID0gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHByb3BlcnR5ID09PSAnaHR0cE9wdGlvbnMnICYmIHRoaXNbcHJvcGVydHldKSB7CiAgICAgIC8vIGRlZXAgbWVyZ2UgaHR0cE9wdGlvbnMKICAgICAgdGhpc1twcm9wZXJ0eV0gPSBBV1MudXRpbC5tZXJnZSh0aGlzW3Byb3BlcnR5XSwgdmFsdWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhpc1twcm9wZXJ0eV0gPSB2YWx1ZTsKICAgIH0KICB9LAoKICAvKioKICAgKiBBbGwgb2YgdGhlIGtleXMgd2l0aCB0aGVpciBkZWZhdWx0IHZhbHVlcy4KICAgKgogICAqIEBjb25zdGFudAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGtleXM6IHsKICAgIGNyZWRlbnRpYWxzOiBudWxsLAogICAgY3JlZGVudGlhbFByb3ZpZGVyOiBudWxsLAogICAgcmVnaW9uOiBudWxsLAogICAgbG9nZ2VyOiBudWxsLAogICAgYXBpVmVyc2lvbnM6IHt9LAogICAgYXBpVmVyc2lvbjogbnVsbCwKICAgIGVuZHBvaW50OiB1bmRlZmluZWQsCiAgICBodHRwT3B0aW9uczogewogICAgICB0aW1lb3V0OiAxMjAwMDAKICAgIH0sCiAgICBtYXhSZXRyaWVzOiB1bmRlZmluZWQsCiAgICBtYXhSZWRpcmVjdHM6IDEwLAogICAgcGFyYW1WYWxpZGF0aW9uOiB0cnVlLAogICAgc3NsRW5hYmxlZDogdHJ1ZSwKICAgIHMzRm9yY2VQYXRoU3R5bGU6IGZhbHNlLAogICAgczNCdWNrZXRFbmRwb2ludDogZmFsc2UsCiAgICBzM0Rpc2FibGVCb2R5U2lnbmluZzogdHJ1ZSwKICAgIHMzVXNFYXN0MVJlZ2lvbmFsRW5kcG9pbnQ6ICdsZWdhY3knLAogICAgczNVc2VBcm5SZWdpb246IHVuZGVmaW5lZCwKICAgIGNvbXB1dGVDaGVja3N1bXM6IHRydWUsCiAgICBjb252ZXJ0UmVzcG9uc2VUeXBlczogdHJ1ZSwKICAgIGNvcnJlY3RDbG9ja1NrZXc6IGZhbHNlLAogICAgY3VzdG9tVXNlckFnZW50OiBudWxsLAogICAgZHluYW1vRGJDcmMzMjogdHJ1ZSwKICAgIHN5c3RlbUNsb2NrT2Zmc2V0OiAwLAogICAgc2lnbmF0dXJlVmVyc2lvbjogbnVsbCwKICAgIHNpZ25hdHVyZUNhY2hlOiB0cnVlLAogICAgcmV0cnlEZWxheU9wdGlvbnM6IHt9LAogICAgdXNlQWNjZWxlcmF0ZUVuZHBvaW50OiBmYWxzZSwKICAgIGNsaWVudFNpZGVNb25pdG9yaW5nOiBmYWxzZSwKICAgIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZDogdW5kZWZpbmVkLAogICAgZW5kcG9pbnRDYWNoZVNpemU6IDEwMDAsCiAgICBob3N0UHJlZml4RW5hYmxlZDogdHJ1ZSwKICAgIHN0c1JlZ2lvbmFsRW5kcG9pbnRzOiAnbGVnYWN5JywKICAgIHVzZUZpcHNFbmRwb2ludDogZmFsc2UsCiAgICB1c2VEdWFsc3RhY2tFbmRwb2ludDogZmFsc2UKICB9LAoKICAvKioKICAgKiBFeHRyYWN0cyBhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5IGFuZCBzZXNzaW9uVG9rZW4KICAgKiBmcm9tIGEgY29uZmlndXJhdGlvbiBoYXNoLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZXh0cmFjdENyZWRlbnRpYWxzOiBmdW5jdGlvbiBleHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuYWNjZXNzS2V5SWQgJiYgb3B0aW9ucy5zZWNyZXRBY2Nlc3NLZXkpIHsKICAgICAgb3B0aW9ucyA9IEFXUy51dGlsLmNvcHkob3B0aW9ucyk7CiAgICAgIG9wdGlvbnMuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKG9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnM7CiAgfSwKCiAgLyoqCiAgICogU2V0cyB0aGUgcHJvbWlzZSBkZXBlbmRlbmN5IHRoZSBTREsgd2lsbCB1c2Ugd2hlcmV2ZXIgUHJvbWlzZXMgYXJlIHJldHVybmVkLgogICAqIFBhc3NpbmcgYG51bGxgIHdpbGwgZm9yY2UgdGhlIFNESyB0byB1c2UgbmF0aXZlIFByb21pc2VzIGlmIHRoZXkgYXJlIGF2YWlsYWJsZS4KICAgKiBJZiBuYXRpdmUgUHJvbWlzZXMgYXJlIG5vdCBhdmFpbGFibGUsIHBhc3NpbmcgYG51bGxgIHdpbGwgaGF2ZSBubyBlZmZlY3QuCiAgICogQHBhcmFtIFtDb25zdHJ1Y3Rvcl0gZGVwIEEgcmVmZXJlbmNlIHRvIGEgUHJvbWlzZSBjb25zdHJ1Y3RvcgogICAqLwogIHNldFByb21pc2VzRGVwZW5kZW5jeTogZnVuY3Rpb24gc2V0UHJvbWlzZXNEZXBlbmRlbmN5KGRlcCkgewogICAgUHJvbWlzZXNEZXBlbmRlbmN5ID0gZGVwOwogICAgLy8gaWYgbnVsbCB3YXMgcGFzc2VkIGluLCB3ZSBzaG91bGQgdHJ5IHRvIHVzZSBuYXRpdmUgcHJvbWlzZXMKICAgIGlmIChkZXAgPT09IG51bGwgJiYgdHlwZW9mIFByb21pc2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgUHJvbWlzZXNEZXBlbmRlbmN5ID0gUHJvbWlzZTsKICAgIH0KICAgIHZhciBjb25zdHJ1Y3RvcnMgPSBbQVdTLlJlcXVlc3QsIEFXUy5DcmVkZW50aWFscywgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXTsKICAgIGlmIChBV1MuUzMpIHsKICAgICAgY29uc3RydWN0b3JzLnB1c2goQVdTLlMzKTsKICAgICAgaWYgKEFXUy5TMy5NYW5hZ2VkVXBsb2FkKSB7CiAgICAgICAgY29uc3RydWN0b3JzLnB1c2goQVdTLlMzLk1hbmFnZWRVcGxvYWQpOwogICAgICB9CiAgICB9CiAgICBBV1MudXRpbC5hZGRQcm9taXNlcyhjb25zdHJ1Y3RvcnMsIFByb21pc2VzRGVwZW5kZW5jeSk7CiAgfSwKCiAgLyoqCiAgICogR2V0cyB0aGUgcHJvbWlzZSBkZXBlbmRlbmN5IHNldCBieSBgQVdTLmNvbmZpZy5zZXRQcm9taXNlc0RlcGVuZGVuY3lgLgogICAqLwogIGdldFByb21pc2VzRGVwZW5kZW5jeTogZnVuY3Rpb24gZ2V0UHJvbWlzZXNEZXBlbmRlbmN5KCkgewogICAgcmV0dXJuIFByb21pc2VzRGVwZW5kZW5jeTsKICB9Cn0pOwoKLyoqCiAqIEByZXR1cm4gW0FXUy5Db25maWddIFRoZSBnbG9iYWwgY29uZmlndXJhdGlvbiBvYmplY3Qgc2luZ2xldG9uIGluc3RhbmNlCiAqIEByZWFkb25seQogKiBAc2VlIEFXUy5Db25maWcKICovCkFXUy5jb25maWcgPSBuZXcgQVdTLkNvbmZpZygpOwoKfSx7Ii4vY29yZSI6MTksIi4vY3JlZGVudGlhbHMiOjIwLCIuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4iOjIzfV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGNvbmZpZ1ZhbHVlLCBlcnJvck9wdGlvbnMpIHsKICBpZiAodHlwZW9mIGNvbmZpZ1ZhbHVlICE9PSAnc3RyaW5nJykgcmV0dXJuIHVuZGVmaW5lZDsKICBlbHNlIGlmIChbJ2xlZ2FjeScsICdyZWdpb25hbCddLmluZGV4T2YoY29uZmlnVmFsdWUudG9Mb3dlckNhc2UoKSkgPj0gMCkgewogICAgcmV0dXJuIGNvbmZpZ1ZhbHVlLnRvTG93ZXJDYXNlKCk7CiAgfSBlbHNlIHsKICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvck9wdGlvbnMpOwogIH0KfQoKLyoqCiAqIFJlc29sdmUgdGhlIGNvbmZpZ3VyYXRpb24gdmFsdWUgZm9yIHJlZ2lvbmFsIGVuZHBvaW50IGZyb20gZGlmZmVyZW5jZSBzb3VyY2VzOiBjbGllbnQKICogY29uZmlnLCBlbnZpcm9ubWVudGFsIHZhcmlhYmxlLCBzaGFyZWQgY29uZmlnIGZpbGUuIFZhbHVlIGNhbiBiZSBjYXNlLWluc2Vuc2l0aXZlCiAqICdsZWdhY3knIG9yICdyZWdpbmFsJy4KICogQHBhcmFtIG9yaWdpbmFsQ29uZmlnIHVzZXItc3VwcGxpZWQgY29uZmlnIG9iamVjdCB0byByZXNvbHZlCiAqIEBwYXJhbSBvcHRpb25zIGEgbWFwIG9mIGNvbmZpZyBwcm9wZXJ0eSBuYW1lcyBmcm9tIGluZGl2aWR1YWwgY29uZmlndXJhdGlvbiBzb3VyY2UKICogIC0gZW52OiBuYW1lIG9mIGVudmlyb25tZW50YWwgdmFyaWFibGUgdGhhdCByZWZlcnMgdG8gdGhlIGNvbmZpZwogKiAgLSBzaGFyZWRDb25maWc6IG5hbWUgb2Ygc2hhcmVkIGNvbmZpZ3VyYXRpb24gZmlsZSBwcm9wZXJ0eSB0aGF0IHJlZmVycyB0byB0aGUgY29uZmlnCiAqICAtIGNsaWVudENvbmZpZzogbmFtZSBvZiBjbGllbnQgY29uZmlndXJhdGlvbiBwcm9wZXJ0eSB0aGF0IHJlZmVycyB0byB0aGUgY29uZmlnCiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gcmVzb2x2ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZyhvcmlnaW5hbENvbmZpZywgb3B0aW9ucykgewogIG9yaWdpbmFsQ29uZmlnID0gb3JpZ2luYWxDb25maWcgfHwge307CiAgLy92YWxpZGF0ZSBjb25maWcgdmFsdWUKICB2YXIgcmVzb2x2ZWQ7CiAgaWYgKG9yaWdpbmFsQ29uZmlnW29wdGlvbnMuY2xpZW50Q29uZmlnXSkgewogICAgcmVzb2x2ZWQgPSB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKG9yaWdpbmFsQ29uZmlnW29wdGlvbnMuY2xpZW50Q29uZmlnXSwgewogICAgICBjb2RlOiAnSW52YWxpZENvbmZpZ3VyYXRpb24nLAogICAgICBtZXNzYWdlOiAnaW52YWxpZCAiJyArIG9wdGlvbnMuY2xpZW50Q29uZmlnICsgJyIgY29uZmlndXJhdGlvbi4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIG9yaWdpbmFsQ29uZmlnW29wdGlvbnMuY2xpZW50Q29uZmlnXSArICciLicKICAgIH0pOwogICAgaWYgKHJlc29sdmVkKSByZXR1cm4gcmVzb2x2ZWQ7CiAgfQogIGlmICghQVdTLnV0aWwuaXNOb2RlKCkpIHJldHVybiByZXNvbHZlZDsKICAvL3ZhbGlkYXRlIGVudmlyb25tZW50YWwgdmFyaWFibGUKICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2Nlc3MuZW52LCBvcHRpb25zLmVudikpIHsKICAgIHZhciBlbnZGbGFnID0gcHJvY2Vzcy5lbnZbb3B0aW9ucy5lbnZdOwogICAgcmVzb2x2ZWQgPSB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGVudkZsYWcsIHsKICAgICAgY29kZTogJ0ludmFsaWRFbnZpcm9ubWVudGFsVmFyaWFibGUnLAogICAgICBtZXNzYWdlOiAnaW52YWxpZCAnICsgb3B0aW9ucy5lbnYgKyAnIGVudmlyb25tZW50YWwgdmFyaWFibGUuIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9jZXNzLmVudltvcHRpb25zLmVudl0gKyAnIi4nCiAgICB9KTsKICAgIGlmIChyZXNvbHZlZCkgcmV0dXJuIHJlc29sdmVkOwogIH0KICAvL3ZhbGlkYXRlIHNoYXJlZCBjb25maWcgZmlsZQogIHZhciBwcm9maWxlID0ge307CiAgdHJ5IHsKICAgIHZhciBwcm9maWxlcyA9IEFXUy51dGlsLmdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZyhBV1MudXRpbC5pbmlMb2FkZXIpOwogICAgcHJvZmlsZSA9IHByb2ZpbGVzW3Byb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IEFXUy51dGlsLmRlZmF1bHRQcm9maWxlXTsKICB9IGNhdGNoIChlKSB7fTsKICBpZiAocHJvZmlsZSAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvZmlsZSwgb3B0aW9ucy5zaGFyZWRDb25maWcpKSB7CiAgICB2YXIgZmlsZUZsYWcgPSBwcm9maWxlW29wdGlvbnMuc2hhcmVkQ29uZmlnXTsKICAgIHJlc29sdmVkID0gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShmaWxlRmxhZywgewogICAgICBjb2RlOiAnSW52YWxpZENvbmZpZ3VyYXRpb24nLAogICAgICBtZXNzYWdlOiAnaW52YWxpZCAnICsgb3B0aW9ucy5zaGFyZWRDb25maWcgKyAnIHByb2ZpbGUgY29uZmlnLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgcHJvZmlsZVtvcHRpb25zLnNoYXJlZENvbmZpZ10gKyAnIi4nCiAgICB9KTsKICAgIGlmIChyZXNvbHZlZCkgcmV0dXJuIHJlc29sdmVkOwogIH0KICByZXR1cm4gcmVzb2x2ZWQ7Cn0KCm1vZHVsZS5leHBvcnRzID0gcmVzb2x2ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZzsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vY29yZSI6MTksIl9wcm9jZXNzIjo5MH1dLDE5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBtYWluIEFXUyBuYW1lc3BhY2UKICovCnZhciBBV1MgPSB7IHV0aWw6IHJlcXVpcmUoJy4vdXRpbCcpIH07CgovKioKICogQGFwaSBwcml2YXRlCiAqIEAhbWFjcm8gW25ld10gbm9icm93c2VyCiAqICAgQG5vdGUgVGhpcyBmZWF0dXJlIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb2YgdGhlIFNESy4KICovCnZhciBfaGlkZGVuID0ge307IF9oaWRkZW4udG9TdHJpbmcoKTsgLy8gaGFjayB0byBwYXJzZSBtYWNybwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1M7CgpBV1MudXRpbC51cGRhdGUoQVdTLCB7CgogIC8qKgogICAqIEBjb25zdGFudAogICAqLwogIFZFUlNJT046ICcyLjExODkuMCcsCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIFNpZ25lcnM6IHt9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBQcm90b2NvbDogewogICAgSnNvbjogcmVxdWlyZSgnLi9wcm90b2NvbC9qc29uJyksCiAgICBRdWVyeTogcmVxdWlyZSgnLi9wcm90b2NvbC9xdWVyeScpLAogICAgUmVzdDogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0JyksCiAgICBSZXN0SnNvbjogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X2pzb24nKSwKICAgIFJlc3RYbWw6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIFhNTDogewogICAgQnVpbGRlcjogcmVxdWlyZSgnLi94bWwvYnVpbGRlcicpLAogICAgUGFyc2VyOiBudWxsIC8vIGNvbmRpdGlvbmFsbHkgc2V0IGJhc2VkIG9uIGVudmlyb25tZW50CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgSlNPTjogewogICAgQnVpbGRlcjogcmVxdWlyZSgnLi9qc29uL2J1aWxkZXInKSwKICAgIFBhcnNlcjogcmVxdWlyZSgnLi9qc29uL3BhcnNlcicpCiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgTW9kZWw6IHsKICAgIEFwaTogcmVxdWlyZSgnLi9tb2RlbC9hcGknKSwKICAgIE9wZXJhdGlvbjogcmVxdWlyZSgnLi9tb2RlbC9vcGVyYXRpb24nKSwKICAgIFNoYXBlOiByZXF1aXJlKCcuL21vZGVsL3NoYXBlJyksCiAgICBQYWdpbmF0b3I6IHJlcXVpcmUoJy4vbW9kZWwvcGFnaW5hdG9yJyksCiAgICBSZXNvdXJjZVdhaXRlcjogcmVxdWlyZSgnLi9tb2RlbC9yZXNvdXJjZV93YWl0ZXInKQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFwaUxvYWRlcjogcmVxdWlyZSgnLi9hcGlfbG9hZGVyJyksCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEVuZHBvaW50Q2FjaGU6IHJlcXVpcmUoJy4uL3ZlbmRvci9lbmRwb2ludC1jYWNoZScpLkVuZHBvaW50Q2FjaGUKfSk7CnJlcXVpcmUoJy4vc2VxdWVudGlhbF9leGVjdXRvcicpOwpyZXF1aXJlKCcuL3NlcnZpY2UnKTsKcmVxdWlyZSgnLi9jb25maWcnKTsKcmVxdWlyZSgnLi9odHRwJyk7CnJlcXVpcmUoJy4vZXZlbnRfbGlzdGVuZXJzJyk7CnJlcXVpcmUoJy4vcmVxdWVzdCcpOwpyZXF1aXJlKCcuL3Jlc3BvbnNlJyk7CnJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CnJlcXVpcmUoJy4vc2lnbmVycy9yZXF1ZXN0X3NpZ25lcicpOwpyZXF1aXJlKCcuL3BhcmFtX3ZhbGlkYXRvcicpOwoKLyoqCiAqIEByZWFkb25seQogKiBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSBhIGNvbGxlY3Rpb24gb2YgZ2xvYmFsIGV2ZW50IGxpc3RlbmVycyB0aGF0CiAqICAgYXJlIGF0dGFjaGVkIHRvIGV2ZXJ5IHNlbnQgcmVxdWVzdC4KICogQHNlZSBBV1MuUmVxdWVzdCBBV1MuUmVxdWVzdCBmb3IgYSBsaXN0IG9mIGV2ZW50cyB0byBsaXN0ZW4gZm9yCiAqIEBleGFtcGxlIExvZ2dpbmcgdGhlIHRpbWUgdGFrZW4gdG8gc2VuZCBhIHJlcXVlc3QKICogICBBV1MuZXZlbnRzLm9uKCdzZW5kJywgZnVuY3Rpb24gc3RhcnRTZW5kKHJlc3ApIHsKICogICAgIHJlc3Auc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAqICAgfSkub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24gY2FsY3VsYXRlVGltZShyZXNwKSB7CiAqICAgICB2YXIgdGltZSA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHJlc3Auc3RhcnRUaW1lKSAvIDEwMDA7CiAqICAgICBjb25zb2xlLmxvZygnUmVxdWVzdCB0b29rICcgKyB0aW1lICsgJyBzZWNvbmRzJyk7CiAqICAgfSk7CiAqCiAqICAgbmV3IEFXUy5TMygpLmxpc3RCdWNrZXRzKCk7IC8vIHByaW50cyAnUmVxdWVzdCB0b29rIDAuMjg1IHNlY29uZHMnCiAqLwpBV1MuZXZlbnRzID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKCi8vY3JlYXRlIGVuZHBvaW50IGNhY2hlIGxhemlseQpBV1MudXRpbC5tZW1vaXplZFByb3BlcnR5KEFXUywgJ2VuZHBvaW50Q2FjaGUnLCBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IEFXUy5FbmRwb2ludENhY2hlKEFXUy5jb25maWcuZW5kcG9pbnRDYWNoZVNpemUpOwp9LCB0cnVlKTsKCn0seyIuLi92ZW5kb3IvZW5kcG9pbnQtY2FjaGUiOjEwOSwiLi9hcGlfbG9hZGVyIjo5LCIuL2NvbmZpZyI6MTcsIi4vZXZlbnRfbGlzdGVuZXJzIjozNCwiLi9odHRwIjozNSwiLi9qc29uL2J1aWxkZXIiOjM3LCIuL2pzb24vcGFyc2VyIjozOCwiLi9tb2RlbC9hcGkiOjM5LCIuL21vZGVsL29wZXJhdGlvbiI6NDEsIi4vbW9kZWwvcGFnaW5hdG9yIjo0MiwiLi9tb2RlbC9yZXNvdXJjZV93YWl0ZXIiOjQzLCIuL21vZGVsL3NoYXBlIjo0NCwiLi9wYXJhbV92YWxpZGF0b3IiOjQ1LCIuL3Byb3RvY29sL2pzb24iOjQ3LCIuL3Byb3RvY29sL3F1ZXJ5Ijo0OCwiLi9wcm90b2NvbC9yZXN0Ijo0OSwiLi9wcm90b2NvbC9yZXN0X2pzb24iOjUwLCIuL3Byb3RvY29sL3Jlc3RfeG1sIjo1MSwiLi9yZXF1ZXN0Ijo1NywiLi9yZXNvdXJjZV93YWl0ZXIiOjU4LCIuL3Jlc3BvbnNlIjo1OSwiLi9zZXF1ZW50aWFsX2V4ZWN1dG9yIjo2MCwiLi9zZXJ2aWNlIjo2MSwiLi9zaWduZXJzL3JlcXVlc3Rfc2lnbmVyIjo2NCwiLi91dGlsIjo3MiwiLi94bWwvYnVpbGRlciI6NzR9XSwyMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKCi8qKgogKiBSZXByZXNlbnRzIHlvdXIgQVdTIHNlY3VyaXR5IGNyZWRlbnRpYWxzLCBzcGVjaWZpY2FsbHkgdGhlCiAqIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9LCBhbmQgb3B0aW9uYWwge3Nlc3Npb25Ub2tlbn0uCiAqIENyZWF0aW5nIGEgYENyZWRlbnRpYWxzYCBvYmplY3QgYWxsb3dzIHlvdSB0byBwYXNzIGFyb3VuZCB5b3VyCiAqIHNlY3VyaXR5IGluZm9ybWF0aW9uIHRvIGNvbmZpZ3VyYXRpb24gYW5kIHNlcnZpY2Ugb2JqZWN0cy4KICoKICogTm90ZSB0aGF0IHRoaXMgY2xhc3MgdHlwaWNhbGx5IGRvZXMgbm90IG5lZWQgdG8gYmUgY29uc3RydWN0ZWQgbWFudWFsbHksCiAqIGFzIHRoZSB7QVdTLkNvbmZpZ30gYW5kIHtBV1MuU2VydmljZX0gY2xhc3NlcyBib3RoIGFjY2VwdCBzaW1wbGUKICogb3B0aW9ucyBoYXNoZXMgd2l0aCB0aGUgdGhyZWUga2V5cy4gVGhlc2Ugc3RydWN0dXJlcyB3aWxsIGJlIGNvbnZlcnRlZAogKiBpbnRvIENyZWRlbnRpYWxzIG9iamVjdHMgYXV0b21hdGljYWxseS4KICoKICogIyMgRXhwaXJpbmcgYW5kIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMKICoKICogT2NjYXNpb25hbGx5IGNyZWRlbnRpYWxzIGNhbiBleHBpcmUgaW4gdGhlIG1pZGRsZSBvZiBhIGxvbmctcnVubmluZwogKiBhcHBsaWNhdGlvbi4gSW4gdGhpcyBjYXNlLCB0aGUgU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvCiAqIHJlZnJlc2ggdGhlIGNyZWRlbnRpYWxzIGZyb20gdGhlIHN0b3JhZ2UgbG9jYXRpb24gaWYgdGhlIENyZWRlbnRpYWxzCiAqIGNsYXNzIGltcGxlbWVudHMgdGhlIHtyZWZyZXNofSBtZXRob2QuCiAqCiAqIElmIHlvdSBhcmUgaW1wbGVtZW50aW5nIGEgY3JlZGVudGlhbCBzdG9yYWdlIGxvY2F0aW9uLCB5b3UKICogd2lsbCB3YW50IHRvIGNyZWF0ZSBhIHN1YmNsYXNzIG9mIHRoZSBgQ3JlZGVudGlhbHNgIGNsYXNzIGFuZAogKiBvdmVycmlkZSB0aGUge3JlZnJlc2h9IG1ldGhvZC4gVGhpcyBtZXRob2QgYWxsb3dzIGNyZWRlbnRpYWxzIHRvIGJlCiAqIHJldHJpZXZlZCBmcm9tIHRoZSBiYWNraW5nIHN0b3JlLCBiZSBpdCBhIGZpbGUgc3lzdGVtLCBkYXRhYmFzZSwgb3IKICogc29tZSBuZXR3b3JrIHN0b3JhZ2UuIFRoZSBtZXRob2Qgc2hvdWxkIHJlc2V0IHRoZSBjcmVkZW50aWFsIGF0dHJpYnV0ZXMKICogb24gdGhlIG9iamVjdC4KICoKICogQCFhdHRyaWJ1dGUgZXhwaXJlZAogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGNyZWRlbnRpYWxzIGhhdmUgYmVlbiBleHBpcmVkIGFuZAogKiAgICAgcmVxdWlyZSBhIHJlZnJlc2guIFVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7ZXhwaXJlVGltZX0uCiAqIEAhYXR0cmlidXRlIGV4cGlyZVRpbWUKICogICBAcmV0dXJuIFtEYXRlXSBhIHRpbWUgd2hlbiBjcmVkZW50aWFscyBzaG91bGQgYmUgY29uc2lkZXJlZCBleHBpcmVkLiBVc2VkCiAqICAgICBpbiBjb25qdW5jdGlvbiB3aXRoIHtleHBpcmVkfS4KICogQCFhdHRyaWJ1dGUgYWNjZXNzS2V5SWQKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogKiBAIWF0dHJpYnV0ZSBzZWNyZXRBY2Nlc3NLZXkKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICogQCFhdHRyaWJ1dGUgc2Vzc2lvblRva2VuCiAqICAgQHJldHVybiBbU3RyaW5nXSBhbiBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogKi8KQVdTLkNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgLyoqCiAgICogQSBjcmVkZW50aWFscyBvYmplY3QgY2FuIGJlIGNyZWF0ZWQgdXNpbmcgcG9zaXRpb25hbCBhcmd1bWVudHMgb3IgYW4gb3B0aW9ucwogICAqIGhhc2guCiAgICoKICAgKiBAb3ZlcmxvYWQgQVdTLkNyZWRlbnRpYWxzKGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXksIHNlc3Npb25Ub2tlbj1udWxsKQogICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgKiAgIGFzIHBvc2l0aW9uYWwgYXJndW1lbnRzLgogICAqICAgQHBhcmFtIGFjY2Vzc0tleUlkIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAqICAgQHBhcmFtIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICogICBAcGFyYW0gc2Vzc2lvblRva2VuIFtTdHJpbmddIHRoZSBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAqICAgQGV4YW1wbGUgQ3JlYXRlIGEgY3JlZGVudGlhbHMgb2JqZWN0IHdpdGggQVdTIGNyZWRlbnRpYWxzCiAgICogICAgIHZhciBjcmVkcyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoJ2FraWQnLCAnc2VjcmV0JywgJ3Nlc3Npb24nKTsKICAgKiBAb3ZlcmxvYWQgQVdTLkNyZWRlbnRpYWxzKG9wdGlvbnMpCiAgICogICBDcmVhdGVzIGEgQ3JlZGVudGlhbHMgb2JqZWN0IHdpdGggYSBnaXZlbiBzZXQgb2YgY3JlZGVudGlhbCBpbmZvcm1hdGlvbgogICAqICAgYXMgYW4gb3B0aW9ucyBoYXNoLgogICAqICAgQG9wdGlvbiBvcHRpb25zIGFjY2Vzc0tleUlkIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAqICAgQG9wdGlvbiBvcHRpb25zIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICogICBAb3B0aW9uIG9wdGlvbnMgc2Vzc2lvblRva2VuIFtTdHJpbmddIHRoZSBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAqICAgQGV4YW1wbGUgQ3JlYXRlIGEgY3JlZGVudGlhbHMgb2JqZWN0IHdpdGggQVdTIGNyZWRlbnRpYWxzCiAgICogICAgIHZhciBjcmVkcyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoewogICAqICAgICAgIGFjY2Vzc0tleUlkOiAnYWtpZCcsIHNlY3JldEFjY2Vzc0tleTogJ3NlY3JldCcsIHNlc3Npb25Ub2tlbjogJ3Nlc3Npb24nCiAgICogICAgIH0pOwogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFscygpIHsKICAgIC8vIGhpZGUgc2VjcmV0QWNjZXNzS2V5IGZyb20gYmVpbmcgZGlzcGxheWVkIHdpdGggdXRpbC5pbnNwZWN0CiAgICBBV1MudXRpbC5oaWRlUHJvcGVydGllcyh0aGlzLCBbJ3NlY3JldEFjY2Vzc0tleSddKTsKCiAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKICAgIHRoaXMuZXhwaXJlVGltZSA9IG51bGw7CiAgICB0aGlzLnJlZnJlc2hDYWxsYmFja3MgPSBbXTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgIHZhciBjcmVkcyA9IGFyZ3VtZW50c1swXS5jcmVkZW50aWFscyB8fCBhcmd1bWVudHNbMF07CiAgICAgIHRoaXMuYWNjZXNzS2V5SWQgPSBjcmVkcy5hY2Nlc3NLZXlJZDsKICAgICAgdGhpcy5zZWNyZXRBY2Nlc3NLZXkgPSBjcmVkcy5zZWNyZXRBY2Nlc3NLZXk7CiAgICAgIHRoaXMuc2Vzc2lvblRva2VuID0gY3JlZHMuc2Vzc2lvblRva2VuOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5hY2Nlc3NLZXlJZCA9IGFyZ3VtZW50c1swXTsKICAgICAgdGhpcy5zZWNyZXRBY2Nlc3NLZXkgPSBhcmd1bWVudHNbMV07CiAgICAgIHRoaXMuc2Vzc2lvblRva2VuID0gYXJndW1lbnRzWzJdOwogICAgfQogIH0sCgogIC8qKgogICAqIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2Ygc2Vjb25kcyBiZWZvcmUge2V4cGlyZVRpbWV9IGR1cmluZyB3aGljaAogICAqICAgdGhlIGNyZWRlbnRpYWxzIHdpbGwgYmUgY29uc2lkZXJlZCBleHBpcmVkLgogICAqLwogIGV4cGlyeVdpbmRvdzogMTUsCgogIC8qKgogICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGNyZWRlbnRpYWxzIG9iamVjdCBzaG91bGQgY2FsbCB7cmVmcmVzaH0KICAgKiBAbm90ZSBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byBwcm92aWRlIGN1c3RvbSByZWZyZXNoCiAgICogICBsb2dpYy4KICAgKi8KICBuZWVkc1JlZnJlc2g6IGZ1bmN0aW9uIG5lZWRzUmVmcmVzaCgpIHsKICAgIHZhciBjdXJyZW50VGltZSA9IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciBhZGp1c3RlZFRpbWUgPSBuZXcgRGF0ZShjdXJyZW50VGltZSArIHRoaXMuZXhwaXJ5V2luZG93ICogMTAwMCk7CgogICAgaWYgKHRoaXMuZXhwaXJlVGltZSAmJiBhZGp1c3RlZFRpbWUgPiB0aGlzLmV4cGlyZVRpbWUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5leHBpcmVkIHx8ICF0aGlzLmFjY2Vzc0tleUlkIHx8ICF0aGlzLnNlY3JldEFjY2Vzc0tleTsKICAgIH0KICB9LAoKICAvKioKICAgKiBHZXRzIHRoZSBleGlzdGluZyBjcmVkZW50aWFscywgcmVmcmVzaGluZyB0aGVtIGlmIHRoZXkgYXJlIG5vdCB5ZXQgbG9hZGVkCiAgICogb3IgaGF2ZSBleHBpcmVkLiBVc2VycyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmUgdXNpbmcge3JlZnJlc2h9LAogICAqIGFzIHRoaXMgd2lsbCBub3QgYXR0ZW1wdCB0byByZWxvYWQgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGFyZSBhbHJlYWR5CiAgICogbG9hZGVkIGludG8gdGhlIG9iamVjdC4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIGVpdGhlciBjcmVkZW50aWFscwogICAqICAgZG8gbm90IG5lZWQgdG8gYmUgcmVmcmVzaGVkIG9yIHJlZnJlc2hlZCBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMKICAgKiAgIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLAogICAqICAgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICovCiAgZ2V0OiBmdW5jdGlvbiBnZXQoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmICh0aGlzLm5lZWRzUmVmcmVzaCgpKSB7CiAgICAgIHRoaXMucmVmcmVzaChmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoIWVycikgc2VsZi5leHBpcmVkID0gZmFsc2U7IC8vIHJlc2V0IGV4cGlyZWQgZmxhZwogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGNhbGxiYWNrKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQCFtZXRob2QgIGdldFByb21pc2UoKQogICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgKiAgIEdldHMgdGhlIGV4aXN0aW5nIGNyZWRlbnRpYWxzLCByZWZyZXNoaW5nIHRoZW0gaWYgdGhleSBhcmUgbm90IHlldCBsb2FkZWQKICAgKiAgIG9yIGhhdmUgZXhwaXJlZC4gVXNlcnMgc2hvdWxkIGNhbGwgdGhpcyBtZXRob2QgYmVmb3JlIHVzaW5nIHtyZWZyZXNofSwKICAgKiAgIGFzIHRoaXMgd2lsbCBub3QgYXR0ZW1wdCB0byByZWxvYWQgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGFyZSBhbHJlYWR5CiAgICogICBsb2FkZWQgaW50byB0aGUgb2JqZWN0LgogICAqCiAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbigpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICogICAgIG1lYW5zIGVpdGhlciBjcmVkZW50aWFscyBkbyBub3QgbmVlZCB0byBiZSByZWZyZXNoZWQgb3IgcmVmcmVzaGVkCiAgICogICAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZQogICAqICAgICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGBnZXRgIGNhbGwuCiAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgZ2V0UHJvbWlzZWAgbWV0aG9kLgogICAqICAgICB2YXIgcHJvbWlzZSA9IGNyZWRQcm92aWRlci5nZXRQcm9taXNlKCk7CiAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICovCgogIC8qKgogICAqIEAhbWV0aG9kICByZWZyZXNoUHJvbWlzZSgpCiAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAqICAgUmVmcmVzaGVzIHRoZSBjcmVkZW50aWFscy4gVXNlcnMgc2hvdWxkIGNhbGwge2dldH0gYmVmb3JlIGF0dGVtcHRpbmcKICAgKiAgIHRvIGZvcmNpYmx5IHJlZnJlc2ggY3JlZGVudGlhbHMuCiAgICoKICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKCkKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4gV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCwgaXQKICAgKiAgICAgbWVhbnMgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QKICAgKiAgICAgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGByZWZyZXNoYCBjYWxsLgogICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlZnJlc2hQcm9taXNlYCBtZXRob2QuCiAgICogICAgIHZhciBwcm9taXNlID0gY3JlZFByb3ZpZGVyLnJlZnJlc2hQcm9taXNlKCk7CiAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICovCgogIC8qKgogICAqIFJlZnJlc2hlcyB0aGUgY3JlZGVudGlhbHMuIFVzZXJzIHNob3VsZCBjYWxsIHtnZXR9IGJlZm9yZSBhdHRlbXB0aW5nCiAgICogdG8gZm9yY2libHkgcmVmcmVzaCBjcmVkZW50aWFscy4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHJlZnJlc2hlZAogICAqICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlCiAgICogICBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogQG5vdGUgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcyBjbGFzcyB0byByZXNldCB0aGUKICAgKiAgIHthY2Nlc3NLZXlJZH0sIHtzZWNyZXRBY2Nlc3NLZXl9IGFuZCBvcHRpb25hbCB7c2Vzc2lvblRva2VufQogICAqICAgb24gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCBhbmQgdGhlbiBjYWxsIHRoZSBjYWxsYmFjayB3aXRoCiAgICogICBhbnkgZXJyb3IgaW5mb3JtYXRpb24uCiAgICogQHNlZSBnZXQKICAgKi8KICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKICAgIGNhbGxiYWNrKCk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogQHBhcmFtIGNhbGxiYWNrCiAgICovCiAgY29hbGVzY2VSZWZyZXNoOiBmdW5jdGlvbiBjb2FsZXNjZVJlZnJlc2goY2FsbGJhY2ssIHN5bmMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChzZWxmLnJlZnJlc2hDYWxsYmFja3MucHVzaChjYWxsYmFjaykgPT09IDEpIHsKICAgICAgc2VsZi5sb2FkKGZ1bmN0aW9uIG9uTG9hZChlcnIpIHsKICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgaWYgKHN5bmMpIHsKICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGNhbGxiYWNrIGNvdWxkIHRocm93LCBzbyBkZWZlciB0byBlbnN1cmUgYWxsIGNhbGxiYWNrcyBhcmUgbm90aWZpZWQKICAgICAgICAgICAgQVdTLnV0aWwuZGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHNlbGYucmVmcmVzaENhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgICB9KTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgKi8KICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICBjYWxsYmFjaygpOwogIH0KfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuQ3JlZGVudGlhbHMuYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgdGhpcy5wcm90b3R5cGUuZ2V0UHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgnZ2V0JywgUHJvbWlzZURlcGVuZGVuY3kpOwogIHRoaXMucHJvdG90eXBlLnJlZnJlc2hQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdyZWZyZXNoJywgUHJvbWlzZURlcGVuZGVuY3kpOwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLkNyZWRlbnRpYWxzLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgZGVsZXRlIHRoaXMucHJvdG90eXBlLmdldFByb21pc2U7CiAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnJlZnJlc2hQcm9taXNlOwp9OwoKQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLkNyZWRlbnRpYWxzKTsKCn0seyIuL2NvcmUiOjE5fV0sMjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKCi8qKgogKiBSZXByZXNlbnRzIHRlbXBvcmFyeSBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSB7QVdTLlNUU30uIFdpdGhvdXQgYW55CiAqIGV4dHJhIHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIHRoZQogKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbi4gSWYgYW4gSUFNIHJvbGUgaXMgcHJvdmlkZWQsIHRoZQogKiB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcGVyYXRpb24gd2lsbCBiZSB1c2VkIHRvIGZldGNoIGNyZWRlbnRpYWxzIGZvciB0aGUKICogcm9sZSBpbnN0ZWFkLgogKgogKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgZGlmZmVycyBmcm9tIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBpbgogKiB0aGUgd2F5IG1hc3RlckNyZWRlbnRpYWxzIGFuZCByZWZyZXNoZXMgYXJlIGhhbmRsZWQuCiAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyByZWZyZXNoZXMgZXhwaXJlZCBjcmVkZW50aWFscyB1c2luZyB0aGUKICogbWFzdGVyQ3JlZGVudGlhbHMgcGFzc2VkIGJ5IHRoZSB1c2VyIHRvIHN1cHBvcnQgY2hhaW5pbmcgb2YgU1RTIGNyZWRlbnRpYWxzLgogKiBIb3dldmVyLCBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgcmVjdXJzaXZlbHkgY29sbGFwc2VzIHRoZSBtYXN0ZXJDcmVkZW50aWFscwogKiBkdXJpbmcgaW5zdGFudGlhdGlvbiwgcHJlY2x1ZGluZyB0aGUgYWJpbGl0eSB0byByZWZyZXNoIGNyZWRlbnRpYWxzIHdoaWNoCiAqIHJlcXVpcmUgaW50ZXJtZWRpYXRlLCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAqCiAqIEZvciBleGFtcGxlLCBpZiB0aGUgYXBwbGljYXRpb24gc2hvdWxkIHVzZSBSb2xlQSwgd2hpY2ggbXVzdCBiZSBhc3N1bWVkIGZyb20KICogUm9sZUIsIGFuZCB0aGUgZW52aXJvbm1lbnQgcHJvdmlkZXMgY3JlZGVudGlhbHMgd2hpY2ggY2FuIGFzc3VtZSBSb2xlQiwgdGhlbgogKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgbXVzdCBiZSB1c2VkIHRvIHN1cHBvcnQgcmVmcmVzaGluZyB0aGUKICogdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZvciBSb2xlQToKICoKICogYGBgamF2YXNjcmlwdAogKiB2YXIgcm9sZUFDcmVkcyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogKiAgIHBhcmFtczoge1JvbGVBcm46ICdSb2xlQSd9LAogKiAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICogICAgIHBhcmFtczoge1JvbGVBcm46ICdSb2xlQid9LAogKiAgICAgbWFzdGVyQ3JlZGVudGlhbHM6IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJykKICogICB9KQogKiB9KTsKICogYGBgCiAqCiAqIElmIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBoYWQgYmVlbiB1c2VkIGluIHRoZSBwcmV2aW91cyBleGFtcGxlLAogKiBgcm9sZUFDcmVkc2Agd291bGQgZmFpbCB0byByZWZyZXNoIGJlY2F1c2UgYHJvbGVBQ3JlZHNgIHdvdWxkCiAqIHVzZSB0aGUgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgZm9yIHRoZSBBc3N1bWVSb2xlIHJlcXVlc3QuCiAqCiAqIEFub3RoZXIgZGlmZmVyZW5jZSBpcyB0aGF0IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBjcmVhdGVzIHRoZSBTVFMKICogc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgaW5zdGFudGlhdGlvbiB3aGlsZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcwogKiB0aGUgU1RTIHNlcnZpY2UgaW5zdGFuY2UgZHVyaW5nIHRoZSBmaXJzdCByZWZyZXNoLiBDcmVhdGluZyB0aGUgc2VydmljZQogKiBpbnN0YW5jZSBkdXJpbmcgaW5zdGFudGlhdGlvbiBlZmZlY3RpdmVseSBjYXB0dXJlcyB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAqIGZyb20gdGhlIGdsb2JhbCBjb25maWcsIHNvIHRoYXQgc3Vic2VxdWVudCBjaGFuZ2VzIHRvIHRoZSBnbG9iYWwgY29uZmlnIGRvCiAqIG5vdCBhZmZlY3QgdGhlIG1hc3RlciBjcmVkZW50aWFscyB1c2VkIHRvIHJlZnJlc2ggdGhlIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICoKICogVGhpcyBhbGxvd3MgYW4gaW5zdGFuY2Ugb2YgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHRvIGJlIGFzc2lnbmVkCiAqIHRvIEFXUy5jb25maWcuY3JlZGVudGlhbHM6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogdmFyIGVudkNyZWRzID0gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IGVudkNyZWRzOwogKiAvLyBtYXN0ZXJDcmVkZW50aWFscyB3aWxsIGJlIGVudkNyZWRzCiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICogICBwYXJhbXM6IHtSb2xlQXJuOiAnLi4uJ30KICogfSk7CiAqIGBgYAogKgogKiBTaW1pbGFybHksIHRvIHVzZSB0aGUgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4ncyBkZWZhdWx0IHByb3ZpZGVycyBhcyB0aGUKICogbWFzdGVyIGNyZWRlbnRpYWxzLCBzaW1wbHkgY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mCiAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsczoKICoKICogYGBgamF2YXNjcmlwdAogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IENoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICogICBwYXJhbXM6IHtSb2xlQXJuOiAnLi4uJ30KICogfSk7CiAqIGBgYAogKgogKiBAIWF0dHJpYnV0ZSBzZXJ2aWNlCiAqICAgQHJldHVybiBbQVdTLlNUU10gdGhlIFNUUyBzZXJ2aWNlIGluc3RhbmNlIHVzZWQgdG8KICogICAgIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogKiBAbm90ZSAoc2VlIGNvbnN0cnVjdG9yKQogKi8KQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0gb3B0aW9ucyBbbWFwXSBhIHNldCBvZiBvcHRpb25zCiAgICogQG9wdGlvbiBvcHRpb25zIHBhcmFtcyBbbWFwXSAoe30pIGEgbWFwIG9mIG9wdGlvbnMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoZQogICAqICAge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3Ige0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb25zLgogICAqICAgSWYgYSBgUm9sZUFybmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwgY3JlZGVudGlhbHMgd2lsbCBiZSBiYXNlZCBvbiB0aGUKICAgKiAgIElBTSByb2xlLiBJZiBhIGBTZXJpYWxOdW1iZXJgIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIHt0b2tlbkNvZGVGbn0gbXVzdAogICAqICAgYWxzbyBiZSBwYXNzZWQgaW4gb3IgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24uCiAgICogQG9wdGlvbiBvcHRpb25zIG1hc3RlckNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiAgIHVzZWQgdG8gZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuIEJ5IGRlZmF1bHQsCiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzIG9yIEFXUy5jb25maWcuY3JlZGVudGlhbFByb3ZpZGVyIHdpbGwgYmUgdXNlZC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgdG9rZW5Db2RlRm4gW0Z1bmN0aW9uXSAobnVsbCkgRnVuY3Rpb24gdG8gcHJvdmlkZQogICAqICAgYFRva2VuQ29kZWAsIGlmIGBTZXJpYWxOdW1iZXJgIGlzIHByb3ZpZGVkIGZvciBwcm9maWxlIGluIHtwYXJhbXN9LiBGdW5jdGlvbgogICAqICAgaXMgY2FsbGVkIHdpdGggdmFsdWUgb2YgYFNlcmlhbE51bWJlcmAgYW5kIGBjYWxsYmFja2AsIGFuZCBzaG91bGQgcHJvdmlkZQogICAqICAgdGhlIGBUb2tlbkNvZGVgIG9yIGFuIGVycm9yIHRvIHRoZSBjYWxsYmFjayBpbiB0aGUgZm9ybWF0CiAgICogICBgY2FsbGJhY2soZXJyLCB0b2tlbilgLgogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBhbiBJQU0gcm9sZQogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgICBwYXJhbXM6IHsKICAgKiAgICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9UZW1wb3JhcnlDcmVkZW50aWFscycKICAgKiAgICAgfQogICAqICAgfSk7CiAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGUKICAgKiBAc2VlIEFXUy5TVFMuZ2V0U2Vzc2lvblRva2VuCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKG9wdGlvbnMpIHsKICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmVycm9yQ29kZSA9ICdDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsc1Byb3ZpZGVyRmFpbHVyZSc7CiAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgdGhpcy50b2tlbkNvZGVGbiA9IG51bGw7CgogICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkob3B0aW9ucy5wYXJhbXMpIHx8IHt9OwogICAgaWYgKHBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgIHBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPSBwYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd0ZW1wb3JhcnktY3JlZGVudGlhbHMnOwogICAgfQogICAgaWYgKHBhcmFtcy5TZXJpYWxOdW1iZXIpIHsKICAgICAgaWYgKCFvcHRpb25zLnRva2VuQ29kZUZuIHx8ICh0eXBlb2Ygb3B0aW9ucy50b2tlbkNvZGVGbiAhPT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICBuZXcgRXJyb3IoJ3Rva2VuQ29kZUZuIG11c3QgYmUgYSBmdW5jdGlvbiB3aGVuIHBhcmFtcy5TZXJpYWxOdW1iZXIgaXMgZ2l2ZW4nKSwKICAgICAgICAgIHtjb2RlOiB0aGlzLmVycm9yQ29kZX0KICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudG9rZW5Db2RlRm4gPSBvcHRpb25zLnRva2VuQ29kZUZuOwogICAgICB9CiAgICB9CiAgICB2YXIgY29uZmlnID0gQVdTLnV0aWwubWVyZ2UoCiAgICAgIHsKICAgICAgICBwYXJhbXM6IHBhcmFtcywKICAgICAgICBjcmVkZW50aWFsczogb3B0aW9ucy5tYXN0ZXJDcmVkZW50aWFscyB8fCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzCiAgICAgIH0sCiAgICAgIG9wdGlvbnMuc3RzQ29uZmlnIHx8IHt9CiAgICApOwogICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhjb25maWcpOwogIH0sCgogIC8qKgogICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcgogICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0sIGRlcGVuZGluZyBvbiB3aGV0aGVyIGFuIElBTSByb2xlIEFSTiB3YXMgcGFzc2VkCiAgICogdG8gdGhlIGNyZWRlbnRpYWxzIHtjb25zdHJ1Y3Rvcn0uCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiBAc2VlIEFXUy5DcmVkZW50aWFscy5nZXQKICAgKi8KICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogQHBhcmFtIGNhbGxiYWNrCiAgICovCiAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9wZXJhdGlvbiA9IHNlbGYuc2VydmljZS5jb25maWcucGFyYW1zLlJvbGVBcm4gPyAnYXNzdW1lUm9sZScgOiAnZ2V0U2Vzc2lvblRva2VuJzsKICAgIHRoaXMuZ2V0VG9rZW5Db2RlKGZ1bmN0aW9uIChlcnIsIHRva2VuQ29kZSkgewogICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodG9rZW5Db2RlKSB7CiAgICAgICAgcGFyYW1zLlRva2VuQ29kZSA9IHRva2VuQ29kZTsKICAgICAgfQogICAgICBzZWxmLnNlcnZpY2Vbb3BlcmF0aW9uXShwYXJhbXMsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRUb2tlbkNvZGU6IGZ1bmN0aW9uIGdldFRva2VuQ29kZShjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHRoaXMudG9rZW5Db2RlRm4pIHsKICAgICAgdGhpcy50b2tlbkNvZGVGbih0aGlzLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5TZXJpYWxOdW1iZXIsIGZ1bmN0aW9uIChlcnIsIHRva2VuKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgdmFyIG1lc3NhZ2UgPSBlcnI7CiAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgICAgbWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2soCiAgICAgICAgICAgIEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICAgIG5ldyBFcnJvcignRXJyb3IgZmV0Y2hpbmcgTUZBIHRva2VuOiAnICsgbWVzc2FnZSksCiAgICAgICAgICAgICAgeyBjb2RlOiBzZWxmLmVycm9yQ29kZX0KICAgICAgICAgICAgKQogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2sobnVsbCwgdG9rZW4pOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrKG51bGwpOwogICAgfQogIH0KfSk7Cgp9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE5fV0sMjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgQ29nbml0b0lkZW50aXR5ID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9jb2duaXRvaWRlbnRpdHknKTsKdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CgovKioKICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgV2ViIElkZW50aXR5IEZlZGVyYXRpb24gdXNpbmcKICogdGhlIEFtYXpvbiBDb2duaXRvIElkZW50aXR5IHNlcnZpY2UuCiAqCiAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogKiB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbiwgd2hpY2gKICogcmVxdWlyZXMgZWl0aGVyIGFuIGBJZGVudGl0eUlkYCBvciBhbiBgSWRlbnRpdHlQb29sSWRgIChBbWF6b24gQ29nbml0bwogKiBJZGVudGl0eSBQb29sIElEKSwgd2hpY2ggaXMgdXNlZCB0byBjYWxsIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldElkfSB0bwogKiBvYnRhaW4gYW4gYElkZW50aXR5SWRgLiBJZiB0aGUgaWRlbnRpdHkgb3IgaWRlbnRpdHkgcG9vbCBpcyBub3QgY29uZmlndXJlZCBpbgogKiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZSB0byB1c2UgSUFNIHJvbGVzIHdpdGggdGhlIGFwcHJvcHJpYXRlIHBlcm1pc3Npb25zLAogKiB0aGVuIGFkZGl0aW9uYWxseSBhIGBSb2xlQXJuYCBpcyByZXF1aXJlZCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdAogKiBwb2xpY3kgZm9yIHRoZSBBbWF6b24gQ29nbml0byByb2xlIHRoYXQgdGhlIHVzZXIgd2lsbCBsb2cgaW50by4gSWYgYSBgUm9sZUFybmAKICogaXMgcHJvdmlkZWQsIHRoZW4gdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbiwgYWZ0ZXIgZmlyc3QgZ2V0dGluZyBhbgogKiBPcGVuIElEIHRva2VuIGZyb20ge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LgogKgogKiBJbiBhZGRpdGlvbiwgaWYgdGhpcyBjcmVkZW50aWFsIHByb3ZpZGVyIGlzIHVzZWQgdG8gcHJvdmlkZSBhdXRoZW50aWNhdGVkCiAqIGxvZ2luLCB0aGUgYExvZ2luc2AgbWFwIG1heSBiZSBzZXQgdG8gdGhlIHRva2VucyBwcm92aWRlZCBieSB0aGUgcmVzcGVjdGl2ZQogKiBpZGVudGl0eSBwcm92aWRlcnMuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICogb2JqZWN0IHdpdGggcHJvcGVyIHByb3BlcnR5IHZhbHVlcy4KICoKICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICoKICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgV2ViSWRlbnRpdHlUb2tlbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuTG9naW5zWydncmFwaC5mYWNlYm9vay5jb20nXSA9IHVwZGF0ZWRUb2tlbjsKICogYGBgCiAqCiAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICoKICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldElkfSwKICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufSwgYW5kCiAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogKiAgICAgYHBhcmFtcy5XZWJJZGVudGl0eVRva2VuYCBwcm9wZXJ0eS4KICogQCFhdHRyaWJ1dGUgZGF0YQogKiAgIEByZXR1cm4gW21hcF0gdGhlIHJhdyBkYXRhIHJlc3BvbnNlIGZyb20gdGhlIGNhbGwgdG8KICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9LCBvcgogKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFVzZSB0aGlzIGlmIHlvdSB3YW50IHRvIGdldAogKiAgICAgYWNjZXNzIHRvIG90aGVyIHByb3BlcnRpZXMgZnJvbSB0aGUgcmVzcG9uc2UuCiAqIEAhYXR0cmlidXRlIGlkZW50aXR5SWQKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBDb2duaXRvIElEIHJldHVybmVkIGJ5IHRoZSBsYXN0IGNhbGwgdG8KICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufS4gVGhpcyBJRCByZXByZXNlbnRzIHRoZSBhY3R1YWwKICogICAgIGZpbmFsIHJlc29sdmVkIGlkZW50aXR5IElEIGZyb20gQW1hem9uIENvZ25pdG8uCiAqLwpBV1MuQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvY2FsU3RvcmFnZUtleTogewogICAgaWQ6ICdhd3MuY29nbml0by5pZGVudGl0eS1pZC4nLAogICAgcHJvdmlkZXJzOiAnYXdzLmNvZ25pdG8uaWRlbnRpdHktcHJvdmlkZXJzLicKICB9LAoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzKHsKICAgKgogICAqICAgICAvLyBlaXRoZXIgSWRlbnRpdHlQb29sSWQgb3IgSWRlbnRpdHlJZCBpcyByZXF1aXJlZAogICAqICAgICAvLyBTZWUgdGhlIElkZW50aXR5UG9vbElkIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldElEIChsaW5rZWQgYmVsb3cpCiAgICogICAgIC8vIFNlZSB0aGUgSWRlbnRpdHlJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5CiAgICogICAgIC8vIG9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW4gKGxpbmtlZCBiZWxvdykKICAgKiAgICAgSWRlbnRpdHlQb29sSWQ6ICd1cy1lYXN0LTE6MTY5OWViYzAtNzkwMC00MDk5LWI5MTAtMmRmOTRmNTJhMDMwJywKICAgKiAgICAgSWRlbnRpdHlJZDogJ3VzLWVhc3QtMToxMjhkMGE3NC1jODJmLTQ1NTMtOTE2ZC05MDA1M2U0YThiMGYnCiAgICoKICAgKiAgICAgLy8gb3B0aW9uYWwsIG9ubHkgbmVjZXNzYXJ5IHdoZW4gdGhlIGlkZW50aXR5IHBvb2wgaXMgbm90IGNvbmZpZ3VyZWQKICAgKiAgICAgLy8gdG8gdXNlIElBTSByb2xlcyBpbiB0aGUgQW1hem9uIENvZ25pdG8gQ29uc29sZQogICAqICAgICAvLyBTZWUgdGhlIFJvbGVBcm4gcGFyYW0gZm9yIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSAobGlua2VkIGJlbG93KQogICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9NWUFQUC1Db2duaXRvSWRlbnRpdHknLAogICAqCiAgICogICAgIC8vIG9wdGlvbmFsIHRva2VucywgdXNlZCBmb3IgYXV0aGVudGljYXRlZCBsb2dpbgogICAqICAgICAvLyBTZWUgdGhlIExvZ2lucyBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJRCAobGlua2VkIGJlbG93KQogICAqICAgICBMb2dpbnM6IHsKICAgKiAgICAgICAnZ3JhcGguZmFjZWJvb2suY29tJzogJ0ZCVE9LRU4nLAogICAqICAgICAgICd3d3cuYW1hem9uLmNvbSc6ICdBTUFaT05UT0tFTicsCiAgICogICAgICAgJ2FjY291bnRzLmdvb2dsZS5jb20nOiAnR09PR0xFVE9LRU4nLAogICAqICAgICAgICdhcGkudHdpdHRlci5jb20nOiAnVFdJVFRFUlRPS0VOJywKICAgKiAgICAgICAnd3d3LmRpZ2l0cy5jb20nOiAnRElHSVRTVE9LRU4nCiAgICogICAgIH0sCiAgICoKICAgKiAgICAgLy8gb3B0aW9uYWwgbmFtZSwgZGVmYXVsdHMgdG8gd2ViLWlkZW50aXR5CiAgICogICAgIC8vIFNlZSB0aGUgUm9sZVNlc3Npb25OYW1lIHBhcmFtIGZvciBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgKGxpbmtlZCBiZWxvdykKICAgKiAgICAgUm9sZVNlc3Npb25OYW1lOiAnd2ViJywKICAgKgogICAqICAgICAvLyBvcHRpb25hbCwgb25seSBuZWNlc3Nhcnkgd2hlbiBhcHBsaWNhdGlvbiBydW5zIGluIGEgYnJvd3NlcgogICAqICAgICAvLyBhbmQgbXVsdGlwbGUgdXNlcnMgYXJlIHNpZ25lZCBpbiBhdCBvbmNlLCB1c2VkIGZvciBjYWNoaW5nCiAgICogICAgIExvZ2luSWQ6ICdleGFtcGxlQGdtYWlsLmNvbScKICAgKgogICAqICAgfSwgewogICAqICAgICAgLy8gb3B0aW9uYWxseSBwcm92aWRlIGNvbmZpZ3VyYXRpb24gdG8gYXBwbHkgdG8gdGhlIHVuZGVybHlpbmcgc2VydmljZSBjbGllbnRzCiAgICogICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAqCiAgICogICAgICAvLyByZWdpb24gc2hvdWxkIG1hdGNoIHRoZSByZWdpb24geW91ciBpZGVudGl0eSBwb29sIGlzIGxvY2F0ZWQgaW4KICAgKiAgICAgIHJlZ2lvbjogJ3VzLWVhc3QtMScsCiAgICoKICAgKiAgICAgIC8vIHNwZWNpZnkgdGltZW91dCBvcHRpb25zCiAgICogICAgICBodHRwT3B0aW9uczogewogICAqICAgICAgICB0aW1lb3V0OiAxMDAKICAgKiAgICAgIH0KICAgKiAgIH0pOwogICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZAogICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5CiAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW4KICAgKiBAc2VlIEFXUy5Db25maWcKICAgKiBAbm90ZSBJZiBhIHJlZ2lvbiBpcyBub3QgcHJvdmlkZWQgaW4gdGhlIGdsb2JhbCBBV1MuY29uZmlnLCBvcgogICAqICAgc3BlY2lmaWVkIGluIHRoZSBgY2xpZW50Q29uZmlnYCB0byB0aGUgQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMKICAgKiAgIGNvbnN0cnVjdG9yLCB5b3UgbWF5IGVuY291bnRlciBhICdNaXNzaW5nIGNyZWRlbnRpYWxzIGluIGNvbmZpZycgZXJyb3IKICAgKiAgIHdoZW4gY2FsbGluZyBtYWtpbmcgYSBzZXJ2aWNlIGNhbGwuCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzKHBhcmFtcywgY2xpZW50Q29uZmlnKSB7CiAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICB0aGlzLl9pZGVudGl0eUlkID0gbnVsbDsKICAgIHRoaXMuX2NsaWVudENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY2xpZW50Q29uZmlnIHx8IHt9KTsKICAgIHRoaXMubG9hZENhY2hlZElkKCk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2lkZW50aXR5SWQnLCB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5sb2FkQ2FjaGVkSWQoKTsKICAgICAgICByZXR1cm4gc2VsZi5faWRlbnRpdHlJZCB8fCBzZWxmLnBhcmFtcy5JZGVudGl0eUlkOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKGlkZW50aXR5SWQpIHsKICAgICAgICBzZWxmLl9pZGVudGl0eUlkID0gaWRlbnRpdHlJZDsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9LAogICAqIG9yIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogQHNlZSBBV1MuQ3JlZGVudGlhbHMuZ2V0CiAgICovCiAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBwYXJhbSBjYWxsYmFjawogICAqLwogIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgc2VsZi5kYXRhID0gbnVsbDsKICAgIHNlbGYuX2lkZW50aXR5SWQgPSBudWxsOwogICAgc2VsZi5nZXRJZChmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKCFlcnIpIHsKICAgICAgICBpZiAoIXNlbGYucGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICAgIHNlbGYuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShjYWxsYmFjayk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuZ2V0Q3JlZGVudGlhbHNGcm9tU1RTKGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQ2xlYXJzIHRoZSBjYWNoZWQgQ29nbml0byBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIGN1cnJlbnRseSBjb25maWd1cmVkCiAgICogaWRlbnRpdHkgcG9vbCBJRC4gVXNlIHRoaXMgdG8gbWFudWFsbHkgaW52YWxpZGF0ZSB5b3VyIGNhY2hlIGlmCiAgICogdGhlIGlkZW50aXR5IHBvb2wgSUQgd2FzIGRlbGV0ZWQuCiAgICovCiAgY2xlYXJDYWNoZWRJZDogZnVuY3Rpb24gY2xlYXJDYWNoZSgpIHsKICAgIHRoaXMuX2lkZW50aXR5SWQgPSBudWxsOwogICAgZGVsZXRlIHRoaXMucGFyYW1zLklkZW50aXR5SWQ7CgogICAgdmFyIHBvb2xJZCA9IHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkOwogICAgdmFyIGxvZ2luSWQgPSB0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnOwogICAgZGVsZXRlIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleS5pZCArIHBvb2xJZCArIGxvZ2luSWRdOwogICAgZGVsZXRlIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleS5wcm92aWRlcnMgKyBwb29sSWQgKyBsb2dpbklkXTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjbGVhcklkT25Ob3RBdXRob3JpemVkOiBmdW5jdGlvbiBjbGVhcklkT25Ob3RBdXRob3JpemVkKGVycikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKGVyci5jb2RlID09ICdOb3RBdXRob3JpemVkRXhjZXB0aW9uJykgewogICAgICBzZWxmLmNsZWFyQ2FjaGVkSWQoKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBSZXRyaWV2ZXMgYSBDb2duaXRvIElELCBsb2FkaW5nIGZyb20gY2FjaGUgaWYgaXQgd2FzIGFscmVhZHkgcmV0cmlldmVkCiAgICogb24gdGhpcyBkZXZpY2UuCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBpZGVudGl0eUlkKQogICAqICAgQHBhcmFtIGVyciBbRXJyb3IsIG51bGxdIGFuIGVycm9yIG9iamVjdCBpZiB0aGUgY2FsbCBmYWlsZWQgb3IgbnVsbCBpZgogICAqICAgICBpdCBzdWNjZWVkZWQuCiAgICogICBAcGFyYW0gaWRlbnRpdHlJZCBbU3RyaW5nLCBudWxsXSBpZiBzdWNjZXNzZnVsLCB0aGUgY2FsbGJhY2sgd2lsbCByZXR1cm4KICAgKiAgICAgdGhlIENvZ25pdG8gSUQuCiAgICogQG5vdGUgSWYgbm90IGxvYWRlZCBleHBsaWNpdGx5LCB0aGUgQ29nbml0byBJRCBpcyBsb2FkZWQgYW5kIHN0b3JlZCBpbgogICAqICAgbG9jYWxTdG9yYWdlIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9mIGEgZGV2aWNlLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldElkOiBmdW5jdGlvbiBnZXRJZChjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHR5cGVvZiBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID09PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCk7CiAgICB9CgogICAgc2VsZi5jb2duaXRvLmdldElkKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICBpZiAoIWVyciAmJiBkYXRhLklkZW50aXR5SWQpIHsKICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gZGF0YS5JZGVudGl0eUlkOwogICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEuSWRlbnRpdHlJZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfQogICAgfSk7CiAgfSwKCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWRDcmVkZW50aWFsczogZnVuY3Rpb24gbG9hZENyZWRlbnRpYWxzKGRhdGEsIGNyZWRlbnRpYWxzKSB7CiAgICBpZiAoIWRhdGEgfHwgIWNyZWRlbnRpYWxzKSByZXR1cm47CiAgICBjcmVkZW50aWFscy5leHBpcmVkID0gZmFsc2U7CiAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCA9IGRhdGEuQ3JlZGVudGlhbHMuQWNjZXNzS2V5SWQ7CiAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgPSBkYXRhLkNyZWRlbnRpYWxzLlNlY3JldEtleTsKICAgIGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbiA9IGRhdGEuQ3JlZGVudGlhbHMuU2Vzc2lvblRva2VuOwogICAgY3JlZGVudGlhbHMuZXhwaXJlVGltZSA9IGRhdGEuQ3JlZGVudGlhbHMuRXhwaXJhdGlvbjsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5OiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNvZ25pdG8uZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgaWYgKCFlcnIpIHsKICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgc2VsZi5kYXRhID0gZGF0YTsKICAgICAgICBzZWxmLmxvYWRDcmVkZW50aWFscyhzZWxmLmRhdGEsIHNlbGYpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICB9CiAgICAgIGNhbGxiYWNrKGVycik7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRDcmVkZW50aWFsc0Zyb21TVFM6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRnJvbVNUUyhjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jb2duaXRvLmdldE9wZW5JZFRva2VuKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICBpZiAoIWVycikgewogICAgICAgIHNlbGYuY2FjaGVJZChkYXRhKTsKICAgICAgICBzZWxmLnBhcmFtcy5XZWJJZGVudGl0eVRva2VuID0gZGF0YS5Ub2tlbjsKICAgICAgICBzZWxmLndlYklkZW50aXR5Q3JlZGVudGlhbHMucmVmcmVzaChmdW5jdGlvbih3ZWJFcnIpIHsKICAgICAgICAgIGlmICghd2ViRXJyKSB7CiAgICAgICAgICAgIHNlbGYuZGF0YSA9IHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5kYXRhOwogICAgICAgICAgICBzZWxmLnN0cy5jcmVkZW50aWFsc0Zyb20oc2VsZi5kYXRhLCBzZWxmKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKHdlYkVycik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZENhY2hlZElkOiBmdW5jdGlvbiBsb2FkQ2FjaGVkSWQoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gaW4gdGhlIGJyb3dzZXIgd2Ugc291cmNlIGRlZmF1bHQgSWRlbnRpdHlJZCBmcm9tIGxvY2FsU3RvcmFnZQogICAgaWYgKEFXUy51dGlsLmlzQnJvd3NlcigpICYmICFzZWxmLnBhcmFtcy5JZGVudGl0eUlkKSB7CiAgICAgIHZhciBpZCA9IHNlbGYuZ2V0U3RvcmFnZSgnaWQnKTsKICAgICAgaWYgKGlkICYmIHNlbGYucGFyYW1zLkxvZ2lucykgewogICAgICAgIHZhciBhY3R1YWxQcm92aWRlcnMgPSBPYmplY3Qua2V5cyhzZWxmLnBhcmFtcy5Mb2dpbnMpOwogICAgICAgIHZhciBjYWNoZWRQcm92aWRlcnMgPQogICAgICAgICAgKHNlbGYuZ2V0U3RvcmFnZSgncHJvdmlkZXJzJykgfHwgJycpLnNwbGl0KCcsJyk7CgogICAgICAgIC8vIG9ubHkgbG9hZCBJRCBpZiBhdCBsZWFzdCBvbmUgcHJvdmlkZXIgdXNlZCB0aGlzIElEIGJlZm9yZQogICAgICAgIHZhciBpbnRlcnNlY3QgPSBjYWNoZWRQcm92aWRlcnMuZmlsdGVyKGZ1bmN0aW9uKG4pIHsKICAgICAgICAgIHJldHVybiBhY3R1YWxQcm92aWRlcnMuaW5kZXhPZihuKSAhPT0gLTE7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKGludGVyc2VjdC5sZW5ndGggIT09IDApIHsKICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBpZDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaWQpIHsKICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gaWQ7CiAgICAgIH0KICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgIHZhciBjbGllbnRDb25maWcgPSB0aGlzLl9jbGllbnRDb25maWc7CiAgICB0aGlzLndlYklkZW50aXR5Q3JlZGVudGlhbHMgPSB0aGlzLndlYklkZW50aXR5Q3JlZGVudGlhbHMgfHwKICAgICAgbmV3IEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzKHRoaXMucGFyYW1zLCBjbGllbnRDb25maWcpOwogICAgaWYgKCF0aGlzLmNvZ25pdG8pIHsKICAgICAgdmFyIGNvZ25pdG9Db25maWcgPSBBV1MudXRpbC5tZXJnZSh7fSwgY2xpZW50Q29uZmlnKTsKICAgICAgY29nbml0b0NvbmZpZy5wYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgdGhpcy5jb2duaXRvID0gbmV3IENvZ25pdG9JZGVudGl0eShjb2duaXRvQ29uZmlnKTsKICAgIH0KICAgIHRoaXMuc3RzID0gdGhpcy5zdHMgfHwgbmV3IFNUUyhjbGllbnRDb25maWcpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNhY2hlSWQ6IGZ1bmN0aW9uIGNhY2hlSWQoZGF0YSkgewogICAgdGhpcy5faWRlbnRpdHlJZCA9IGRhdGEuSWRlbnRpdHlJZDsKICAgIHRoaXMucGFyYW1zLklkZW50aXR5SWQgPSB0aGlzLl9pZGVudGl0eUlkOwoKICAgIC8vIGNhY2hlIHRoaXMgSWRlbnRpdHlJZCBpbiBicm93c2VyIGxvY2FsU3RvcmFnZSBpZiBwb3NzaWJsZQogICAgaWYgKEFXUy51dGlsLmlzQnJvd3NlcigpKSB7CiAgICAgIHRoaXMuc2V0U3RvcmFnZSgnaWQnLCBkYXRhLklkZW50aXR5SWQpOwoKICAgICAgaWYgKHRoaXMucGFyYW1zLkxvZ2lucykgewogICAgICAgIHRoaXMuc2V0U3RvcmFnZSgncHJvdmlkZXJzJywgT2JqZWN0LmtleXModGhpcy5wYXJhbXMuTG9naW5zKS5qb2luKCcsJykpOwogICAgICB9CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0U3RvcmFnZTogZnVuY3Rpb24gZ2V0U3RvcmFnZShrZXkpIHsKICAgIHJldHVybiB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXlba2V5XSArIHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkICsgKHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJycpXTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzZXRTdG9yYWdlOiBmdW5jdGlvbiBzZXRTdG9yYWdlKGtleSwgdmFsKSB7CiAgICB0cnkgewogICAgICB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXlba2V5XSArIHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkICsgKHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJycpXSA9IHZhbDsKICAgIH0gY2F0Y2ggKF8pIHt9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc3RvcmFnZTogKGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgdmFyIHN0b3JhZ2UgPSBBV1MudXRpbC5pc0Jyb3dzZXIoKSAmJiB3aW5kb3cubG9jYWxTdG9yYWdlICE9PSBudWxsICYmIHR5cGVvZiB3aW5kb3cubG9jYWxTdG9yYWdlID09PSAnb2JqZWN0JyA/CiAgICAgICAgICB3aW5kb3cubG9jYWxTdG9yYWdlIDoge307CgogICAgICAvLyBUZXN0IHNldC9yZW1vdmUgd2hpY2ggd291bGQgdGhyb3cgYW4gZXJyb3IgaW4gU2FmYXJpJ3MgcHJpdmF0ZSBicm93c2luZwogICAgICBzdG9yYWdlWydhd3MudGVzdC1zdG9yYWdlJ10gPSAnZm9vYmFyJzsKICAgICAgZGVsZXRlIHN0b3JhZ2VbJ2F3cy50ZXN0LXN0b3JhZ2UnXTsKCiAgICAgIHJldHVybiBzdG9yYWdlOwogICAgfSBjYXRjaCAoXykgewogICAgICByZXR1cm4ge307CiAgICB9CiAgfSkoKQp9KTsKCn0seyIuLi8uLi9jbGllbnRzL2NvZ25pdG9pZGVudGl0eSI6NywiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE5fV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwoKLyoqCiAqIENyZWF0ZXMgYSBjcmVkZW50aWFsIHByb3ZpZGVyIGNoYWluIHRoYXQgc2VhcmNoZXMgZm9yIEFXUyBjcmVkZW50aWFscwogKiBpbiBhIGxpc3Qgb2YgY3JlZGVudGlhbCBwcm92aWRlcnMgc3BlY2lmaWVkIGJ5IHRoZSB7cHJvdmlkZXJzfSBwcm9wZXJ0eS4KICoKICogQnkgZGVmYXVsdCwgdGhlIGNoYWluIHdpbGwgdXNlIHRoZSB7ZGVmYXVsdFByb3ZpZGVyc30gdG8gcmVzb2x2ZSBjcmVkZW50aWFscy4KICogVGhlc2UgcHJvdmlkZXJzIHdpbGwgbG9vayBpbiB0aGUgZW52aXJvbm1lbnQgdXNpbmcgdGhlCiAqIHtBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFsc30gY2xhc3Mgd2l0aCB0aGUgJ0FXUycgYW5kICdBTUFaT04nIHByZWZpeGVzLgogKgogKiAjIyBTZXR0aW5nIFByb3ZpZGVycwogKgogKiBFYWNoIHByb3ZpZGVyIGluIHRoZSB7cHJvdmlkZXJzfSBsaXN0IHNob3VsZCBiZSBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucwogKiBhIHtBV1MuQ3JlZGVudGlhbHN9IG9iamVjdCwgb3IgYSBoYXJkY29kZWQgY3JlZGVudGlhbHMgb2JqZWN0LiBUaGUgZnVuY3Rpb24KICogZm9ybSBhbGxvd3MgZm9yIGRlbGF5ZWQgZXhlY3V0aW9uIG9mIHRoZSBjcmVkZW50aWFsIGNvbnN0cnVjdGlvbi4KICoKICogIyMgUmVzb2x2aW5nIENyZWRlbnRpYWxzIGZyb20gYSBDaGFpbgogKgogKiBDYWxsIHtyZXNvbHZlfSB0byByZXR1cm4gdGhlIGZpcnN0IHZhbGlkIGNyZWRlbnRpYWwgb2JqZWN0IHRoYXQgY2FuIGJlCiAqIGxvYWRlZCBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAqCiAqIEZvciBleGFtcGxlLCB0byByZXNvbHZlIGEgY2hhaW4gd2l0aCBhIGN1c3RvbSBwcm92aWRlciB0aGF0IGNoZWNrcyBhIGZpbGUKICogb24gZGlzayBhZnRlciB0aGUgc2V0IG9mIHtkZWZhdWx0UHJvdmlkZXJzfToKICoKICogYGBgamF2YXNjcmlwdAogKiB2YXIgZGlza1Byb3ZpZGVyID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMoJy4vY3JlZHMuanNvbicpOwogKiB2YXIgY2hhaW4gPSBuZXcgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKCk7CiAqIGNoYWluLnByb3ZpZGVycy5wdXNoKGRpc2tQcm92aWRlcik7CiAqIGNoYWluLnJlc29sdmUoKTsKICogYGBgCiAqCiAqIFRoZSBhYm92ZSBjb2RlIHdpbGwgcmV0dXJuIHRoZSBgZGlza1Byb3ZpZGVyYCBvYmplY3QgaWYgdGhlCiAqIGZpbGUgY29udGFpbnMgY3JlZGVudGlhbHMgYW5kIHRoZSBgZGVmYXVsdFByb3ZpZGVyc2AgZG8gbm90IGNvbnRhaW4KICogYW55IGNyZWRlbnRpYWwgc2V0dGluZ3MuCiAqCiAqIEAhYXR0cmlidXRlIHByb3ZpZGVycwogKiAgIEByZXR1cm4gW0FycmF5PEFXUy5DcmVkZW50aWFscywgRnVuY3Rpb24+XQogKiAgICAgYSBsaXN0IG9mIGNyZWRlbnRpYWxzIG9iamVjdHMgb3IgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIGNyZWRlbnRpYWxzCiAqICAgICBvYmplY3RzLiBJZiB0aGUgcHJvdmlkZXIgaXMgYSBmdW5jdGlvbiwgdGhlIGZ1bmN0aW9uIHdpbGwgYmUKICogICAgIGV4ZWN1dGVkIGxhemlseSB3aGVuIHRoZSBwcm92aWRlciBuZWVkcyB0byBiZSBjaGVja2VkIGZvciB2YWxpZAogKiAgICAgY3JlZGVudGlhbHMuIEJ5IGRlZmF1bHQsIHRoaXMgb2JqZWN0IHdpbGwgYmUgc2V0IHRvIHRoZQogKiAgICAge2RlZmF1bHRQcm92aWRlcnN9LgogKiAgIEBzZWUgZGVmYXVsdFByb3ZpZGVycwogKi8KQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbiB3aXRoIGEgZGVmYXVsdCBzZXQgb2YgcHJvdmlkZXJzCiAgICogc3BlY2lmaWVkIGJ5IHtkZWZhdWx0UHJvdmlkZXJzfS4KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4ocHJvdmlkZXJzKSB7CiAgICBpZiAocHJvdmlkZXJzKSB7CiAgICAgIHRoaXMucHJvdmlkZXJzID0gcHJvdmlkZXJzOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wcm92aWRlcnMgPSBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycy5zbGljZSgwKTsKICAgIH0KICAgIHRoaXMucmVzb2x2ZUNhbGxiYWNrcyA9IFtdOwogIH0sCgogIC8qKgogICAqIEAhbWV0aG9kICByZXNvbHZlUHJvbWlzZSgpCiAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAqICAgUmVzb2x2ZXMgdGhlIHByb3ZpZGVyIGNoYWluIGJ5IHNlYXJjaGluZyBmb3IgdGhlIGZpcnN0IHNldCBvZgogICAqICAgY3JlZGVudGlhbHMgaW4ge3Byb3ZpZGVyc30uCiAgICoKICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKGNyZWRlbnRpYWxzKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkIGFuZCB0aGUgcHJvdmlkZXIgcmVzb2x2ZXMgdGhlIGNoYWluCiAgICogICAgIHRvIGEgY3JlZGVudGlhbHMgb2JqZWN0CiAgICogICAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHJlc29sdmVkCiAgICogICAgICAgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgaWYgbm8gY3JlZGVudGlhbHMgYXJlIGZvdW5kLgogICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGByZXNvbHZlYCBtZXRob2QgY2FsbC4KICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGByZXNvbHZlUHJvbWlzZWAgbWV0aG9kLgogICAqICAgICB2YXIgcHJvbWlzZSA9IGNoYWluLnJlc29sdmVQcm9taXNlKCk7CiAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbihjcmVkZW50aWFscykgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgKi8KCiAgLyoqCiAgICogUmVzb2x2ZXMgdGhlIHByb3ZpZGVyIGNoYWluIGJ5IHNlYXJjaGluZyBmb3IgdGhlIGZpcnN0IHNldCBvZgogICAqIGNyZWRlbnRpYWxzIGluIHtwcm92aWRlcnN9LgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgY3JlZGVudGlhbHMpCiAgICogICBDYWxsZWQgd2hlbiB0aGUgcHJvdmlkZXIgcmVzb2x2ZXMgdGhlIGNoYWluIHRvIGEgY3JlZGVudGlhbHMgb2JqZWN0CiAgICogICBvciBudWxsIGlmIG5vIGNyZWRlbnRpYWxzIGNhbiBiZSBmb3VuZC4KICAgKgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgaWYgbm8gY3JlZGVudGlhbHMgYXJlCiAgICogICAgIGZvdW5kLgogICAqICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBjcmVkZW50aWFscyBvYmplY3QgcmVzb2x2ZWQKICAgKiAgICAgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAqIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl0gdGhlIHByb3ZpZGVyLCBmb3IgY2hhaW5pbmcuCiAgICovCiAgcmVzb2x2ZTogZnVuY3Rpb24gcmVzb2x2ZShjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHNlbGYucHJvdmlkZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ05vIHByb3ZpZGVycycpKTsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9CgogICAgaWYgKHNlbGYucmVzb2x2ZUNhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICB2YXIgaW5kZXggPSAwOwogICAgICB2YXIgcHJvdmlkZXJzID0gc2VsZi5wcm92aWRlcnMuc2xpY2UoMCk7CgogICAgICBmdW5jdGlvbiByZXNvbHZlTmV4dChlcnIsIGNyZWRzKSB7CiAgICAgICAgaWYgKCghZXJyICYmIGNyZWRzKSB8fCBpbmRleCA9PT0gcHJvdmlkZXJzLmxlbmd0aCkgewogICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNlbGYucmVzb2x2ZUNhbGxiYWNrcywgZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgY3JlZHMpOwogICAgICAgICAgfSk7CiAgICAgICAgICBzZWxmLnJlc29sdmVDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVyc1tpbmRleCsrXTsKICAgICAgICBpZiAodHlwZW9mIHByb3ZpZGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBjcmVkcyA9IHByb3ZpZGVyLmNhbGwoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3JlZHMgPSBwcm92aWRlcjsKICAgICAgICB9CgogICAgICAgIGlmIChjcmVkcy5nZXQpIHsKICAgICAgICAgIGNyZWRzLmdldChmdW5jdGlvbiAoZ2V0RXJyKSB7CiAgICAgICAgICAgIHJlc29sdmVOZXh0KGdldEVyciwgZ2V0RXJyID8gbnVsbCA6IGNyZWRzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXNvbHZlTmV4dChudWxsLCBjcmVkcyk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXNvbHZlTmV4dCgpOwogICAgfQoKICAgIHJldHVybiBzZWxmOwogIH0KfSk7CgovKioKICogVGhlIGRlZmF1bHQgc2V0IG9mIHByb3ZpZGVycyB1c2VkIGJ5IGEgdmFuaWxsYSBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbi4KICoKICogSW4gdGhlIGJyb3dzZXI6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXQogKiBgYGAKICoKICogSW4gTm9kZS5qczoKICoKICogYGBgamF2YXNjcmlwdAogKiBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFsKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOyB9LAogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQU1BWk9OJyk7IH0sCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5Tc29DcmVkZW50aWFscygpOyB9LAogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzKCk7IH0sCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FQ1NDcmVkZW50aWFscygpOyB9LAogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuUHJvY2Vzc0NyZWRlbnRpYWxzKCk7IH0sCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5Ub2tlbkZpbGVXZWJJZGVudGl0eUNyZWRlbnRpYWxzKCk7IH0sCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FQzJNZXRhZGF0YUNyZWRlbnRpYWxzKCkgfQogKiBdCiAqIGBgYAogKi8KQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbXTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICB0aGlzLnByb3RvdHlwZS5yZXNvbHZlUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVzb2x2ZScsIFByb21pc2VEZXBlbmRlbmN5KTsKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5yZXNvbHZlUHJvbWlzZTsKfTsKCkFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbik7Cgp9LHsiLi4vY29yZSI6MTl9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwoKLyoqCiAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFNBTUwgc3VwcG9ydC4KICoKICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0gc2VydmljZSBvcGVyYXRpb24uIFRoaXMgb3BlcmF0aW9uCiAqIHJlcXVpcmVzIGEgYFJvbGVBcm5gIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0IHBvbGljeSBmb3IgdGhlCiAqIGFwcGxpY2F0aW9uIGZvciB3aGljaCBjcmVkZW50aWFscyB3aWxsIGJlIGdpdmVuLCBhcyB3ZWxsIGFzIGEgYFByaW5jaXBhbEFybmAKICogcmVwcmVzZW50aW5nIHRoZSBBUk4gZm9yIHRoZSBTQU1MIGlkZW50aXR5IHByb3ZpZGVyLiBJbiBhZGRpdGlvbiwgdGhlCiAqIGBTQU1MQXNzZXJ0aW9uYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAqIHByb3ZpZGVyLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAqIG9iamVjdCB3aXRoIHByb3BlciBgUm9sZUFybmAsIGBQcmluY2lwYWxBcm5gLCBhbmQgYFNBTUxBc3NlcnRpb25gIHZhbHVlcy4KICoKICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICoKICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgU0FNTEFzc2VydGlvbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuU0FNTEFzc2VydGlvbiA9IHVwZGF0ZWRUb2tlbjsKICogYGBgCiAqCiAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICoKICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICogICAgIGBwYXJhbXMuU0FNTEFzc2VydGlvbmAgcHJvcGVydHkuCiAqLwpBV1MuU0FNTENyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgKiBAcGFyYW0gKHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTCkKICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlNBTUxDcmVkZW50aWFscyh7CiAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1NBTUxSb2xlJywKICAgKiAgICAgUHJpbmNpcGFsQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9TQU1MUHJpbmNpcGFsJywKICAgKiAgICAgU0FNTEFzc2VydGlvbjogJ2Jhc2U2NC10b2tlbicsIC8vIGJhc2U2NC1lbmNvZGVkIHRva2VuIGZyb20gSWRQCiAgICogICB9KTsKICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNBTUxDcmVkZW50aWFscyhwYXJhbXMpIHsKICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogIH0sCgogIC8qKgogICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9CiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiBAc2VlIGdldAogICAqLwogIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlV2l0aFNBTUwoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICBpZiAoIWVycikgewogICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgIH0KICAgICAgY2FsbGJhY2soZXJyKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZXJ2aWNlID0gdGhpcy5zZXJ2aWNlIHx8IG5ldyBTVFMoe3BhcmFtczogdGhpcy5wYXJhbXN9KTsKICB9Cgp9KTsKCn0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTl9XSwyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwoKLyoqCiAqIFJlcHJlc2VudHMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIHtBV1MuU1RTfS4gV2l0aG91dCBhbnkKICogZXh0cmEgcGFyYW1ldGVycywgY3JlZGVudGlhbHMgd2lsbCBiZSBmZXRjaGVkIGZyb20gdGhlCiAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9uLiBJZiBhbiBJQU0gcm9sZSBpcyBwcm92aWRlZCwgdGhlCiAqIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9wZXJhdGlvbiB3aWxsIGJlIHVzZWQgdG8gZmV0Y2ggY3JlZGVudGlhbHMgZm9yIHRoZQogKiByb2xlIGluc3RlYWQuCiAqCiAqIEBub3RlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBpcyBkZXByZWNhdGVkLCBidXQgcmVtYWlucyBhdmFpbGFibGUgZm9yCiAqICAgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuIHtBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHN9IGlzIHRoZQogKiAgIHByZWZlcnJlZCBjbGFzcyBmb3IgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogKgogKiBUbyBzZXR1cCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsIGNvbmZpZ3VyZSBhIHNldCBvZiBtYXN0ZXIgY3JlZGVudGlhbHMKICogdXNpbmcgdGhlIHN0YW5kYXJkIGNyZWRlbnRpYWxzIHByb3ZpZGVycyAoZW52aXJvbm1lbnQsIEVDMiBpbnN0YW5jZSBtZXRhZGF0YSwKICogb3IgZnJvbSB0aGUgZmlsZXN5c3RlbSksIHRoZW4gc2V0IHRoZSBnbG9iYWwgY3JlZGVudGlhbHMgdG8gYSBuZXcKICogdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdDoKICoKICogYGBgamF2YXNjcmlwdAogKiAvLyBOb3RlIHRoYXQgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMgYXJlIGxvYWRlZCBieSBkZWZhdWx0LAogKiAvLyB0aGUgZm9sbG93aW5nIGxpbmUgaXMgc2hvd24gZm9yIGNsYXJpdHk6CiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOwogKgogKiAvLyBOb3cgc2V0IHRlbXBvcmFyeSBjcmVkZW50aWFscyBzZWVkZWQgZnJvbSB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAqCiAqIC8vIHN1YnNlcXVlbnQgcmVxdWVzdHMgd2lsbCBub3cgdXNlIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAqIG5ldyBBV1MuUzMoKS5saXN0QnVja2V0KGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAqIGBgYAogKgogKiBAIWF0dHJpYnV0ZSBtYXN0ZXJDcmVkZW50aWFscwogKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciAobm9uLXRlbXBvcmFyeSkgY3JlZGVudGlhbHMgdXNlZCB0bwogKiAgICAgZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAqIEBub3RlIChzZWUgY29uc3RydWN0b3IpCiAqLwpBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgKgogICAqIEBub3RlIEluIG9yZGVyIHRvIGNyZWF0ZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsIHlvdSBmaXJzdCBuZWVkIHRvIGhhdmUKICAgKiAgICJtYXN0ZXIiIGNyZWRlbnRpYWxzIGNvbmZpZ3VyZWQgaW4ge0FXUy5Db25maWcuY3JlZGVudGlhbHN9LiBUaGVzZQogICAqICAgbWFzdGVyIGNyZWRlbnRpYWxzIGFyZSBuZWNlc3NhcnkgdG8gcmV0cmlldmUgdGhlIHRlbXBvcmFyeSBjcmVkZW50aWFscywKICAgKiAgIGFzIHdlbGwgYXMgcmVmcmVzaCB0aGUgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGV4cGlyZS4KICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIG9wdGlvbnMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoZQogICAqICAge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3Ige0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb25zLgogICAqICAgSWYgYSBgUm9sZUFybmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwgY3JlZGVudGlhbHMgd2lsbCBiZSBiYXNlZCBvbiB0aGUKICAgKiAgIElBTSByb2xlLgogICAqIEBwYXJhbSBtYXN0ZXJDcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIChub24tdGVtcG9yYXJ5KSBjcmVkZW50aWFscwogICAqICB1c2VkIHRvIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgZ2VuZXJpYyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBhbiBJQU0gcm9sZQogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9UZW1wb3JhcnlDcmVkZW50aWFscycsCiAgICogICB9KTsKICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZQogICAqIEBzZWUgQVdTLlNUUy5nZXRTZXNzaW9uVG9rZW4KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gVGVtcG9yYXJ5Q3JlZGVudGlhbHMocGFyYW1zLCBtYXN0ZXJDcmVkZW50aWFscykgewogICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICB0aGlzLmxvYWRNYXN0ZXJDcmVkZW50aWFscyhtYXN0ZXJDcmVkZW50aWFscyk7CiAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwoKICAgIHRoaXMucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgaWYgKHRoaXMucGFyYW1zLlJvbGVBcm4pIHsKICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lID0KICAgICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3RlbXBvcmFyeS1jcmVkZW50aWFscyc7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yCiAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSwgZGVwZW5kaW5nIG9uIHdoZXRoZXIgYW4gSUFNIHJvbGUgQVJOIHdhcyBwYXNzZWQKICAgKiB0byB0aGUgY3JlZGVudGlhbHMge2NvbnN0cnVjdG9yfS4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqIEBzZWUgZ2V0CiAgICovCiAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaCAoY2FsbGJhY2spIHsKICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkOiBmdW5jdGlvbiBsb2FkIChjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICBzZWxmLm1hc3RlckNyZWRlbnRpYWxzLmdldChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgPSBzZWxmLm1hc3RlckNyZWRlbnRpYWxzOwogICAgICB2YXIgb3BlcmF0aW9uID0gc2VsZi5wYXJhbXMuUm9sZUFybiA/CiAgICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGUgOiBzZWxmLnNlcnZpY2UuZ2V0U2Vzc2lvblRva2VuOwogICAgICBvcGVyYXRpb24uY2FsbChzZWxmLnNlcnZpY2UsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkTWFzdGVyQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRNYXN0ZXJDcmVkZW50aWFscyAobWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSBtYXN0ZXJDcmVkZW50aWFscyB8fCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzOwogICAgd2hpbGUgKHRoaXMubWFzdGVyQ3JlZGVudGlhbHMubWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IHRoaXMubWFzdGVyQ3JlZGVudGlhbHMubWFzdGVyQ3JlZGVudGlhbHM7CiAgICB9CgogICAgaWYgKHR5cGVvZiB0aGlzLm1hc3RlckNyZWRlbnRpYWxzLmdldCAhPT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyh0aGlzLm1hc3RlckNyZWRlbnRpYWxzKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogIH0KCn0pOwoKfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOX1dLDI2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CgovKioKICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgV2ViIElkZW50aXR5IEZlZGVyYXRpb24gc3VwcG9ydC4KICoKICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLiBUaGlzIG9wZXJhdGlvbgogKiByZXF1aXJlcyBhIGBSb2xlQXJuYCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdCBwb2xpY3kgZm9yIHRoZQogKiBhcHBsaWNhdGlvbiBmb3Igd2hpY2ggY3JlZGVudGlhbHMgd2lsbCBiZSBnaXZlbi4gSW4gYWRkaXRpb24sIHRoZQogKiBgV2ViSWRlbnRpdHlUb2tlbmAgbXVzdCBiZSBzZXQgdG8gdGhlIHRva2VuIHByb3ZpZGVkIGJ5IHRoZSBpZGVudGl0eQogKiBwcm92aWRlci4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gIGFuZCBgV2ViSWRlbnRpdHlUb2tlbmAgdmFsdWVzLgogKgogKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogKgogKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICoKICogYGBgamF2YXNjcmlwdAogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5XZWJJZGVudGl0eVRva2VuID0gdXBkYXRlZFRva2VuOwogKiBgYGAKICoKICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogKgogKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICogICAgIGBwYXJhbXMuV2ViSWRlbnRpdHlUb2tlbmAgcHJvcGVydHkuCiAqIEAhYXR0cmlidXRlIGRhdGEKICogICBAcmV0dXJuIFttYXBdIHRoZSByYXcgZGF0YSByZXNwb25zZSBmcm9tIHRoZSBjYWxsIHRvCiAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAqICAgICBhY2Nlc3MgdG8gb3RoZXIgcHJvcGVydGllcyBmcm9tIHRoZSByZXNwb25zZS4KICovCkFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgKiBAcGFyYW0gKHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkpCiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzKHsKICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvV2ViSWRlbnRpdHknLAogICAqICAgICBXZWJJZGVudGl0eVRva2VuOiAnQUJDREVGR0hJSktMTU5PUCcsIC8vIHRva2VuIGZyb20gaWRlbnRpdHkgc2VydmljZQogICAqICAgICBSb2xlU2Vzc2lvbk5hbWU6ICd3ZWInIC8vIG9wdGlvbmFsIG5hbWUsIGRlZmF1bHRzIHRvIHdlYi1pZGVudGl0eQogICAqICAgfSwgewogICAqICAgICAvLyBvcHRpb25hbGx5IHByb3ZpZGUgY29uZmlndXJhdGlvbiB0byBhcHBseSB0byB0aGUgdW5kZXJseWluZyBBV1MuU1RTIHNlcnZpY2UgY2xpZW50CiAgICogICAgIC8vIGlmIGNvbmZpZ3VyYXRpb24gaXMgbm90IHByb3ZpZGVkLCB0aGVuIGNvbmZpZ3VyYXRpb24gd2lsbCBiZSBwdWxsZWQgZnJvbSBBV1MuY29uZmlnCiAgICoKICAgKiAgICAgLy8gc3BlY2lmeSB0aW1lb3V0IG9wdGlvbnMKICAgKiAgICAgaHR0cE9wdGlvbnM6IHsKICAgKiAgICAgICB0aW1lb3V0OiAxMDAKICAgKiAgICAgfQogICAqICAgfSk7CiAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkKICAgKiBAc2VlIEFXUy5Db25maWcKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gV2ViSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPSB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3dlYi1pZGVudGl0eSc7CiAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgdGhpcy5fY2xpZW50Q29uZmlnID0gQVdTLnV0aWwuY29weShjbGllbnRDb25maWcgfHwge30pOwogIH0sCgogIC8qKgogICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fQogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogQHNlZSBnZXQKICAgKi8KICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgIHNlbGYuZGF0YSA9IG51bGw7CiAgICAgIGlmICghZXJyKSB7CiAgICAgICAgc2VsZi5kYXRhID0gZGF0YTsKICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICB9CiAgICAgIGNhbGxiYWNrKGVycik7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5zZXJ2aWNlKSB7CiAgICAgIHZhciBzdHNDb25maWcgPSBBV1MudXRpbC5tZXJnZSh7fSwgdGhpcy5fY2xpZW50Q29uZmlnKTsKICAgICAgc3RzQ29uZmlnLnBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgICB0aGlzLnNlcnZpY2UgPSBuZXcgU1RTKHN0c0NvbmZpZyk7CiAgICB9CiAgfQoKfSk7Cgp9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE5fV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwp2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwp2YXIgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52cyA9IFsnQVdTX0VOQUJMRV9FTkRQT0lOVF9ESVNDT1ZFUlknLCAnQVdTX0VORFBPSU5UX0RJU0NPVkVSWV9FTkFCTEVEJ107CgovKioKICogR2VuZXJhdGUga2V5IChleGNlcHQgcmVzb3VyY2VzIGFuZCBvcGVyYXRpb24gcGFydCkgdG8gaW5kZXggdGhlIGVuZHBvaW50cyBpbiB0aGUgY2FjaGUKICogSWYgaW5wdXQgc2hhcGUgaGFzIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICogICBhY2Nlc3NLZXkgKyBvcGVyYXRpb24gKyByZXNvdXJjZXMgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogKiBJZiBpbnB1dCBzaGFwZSBkb2Vzbid0IGhhdmUgZW5kcG9pbnRkaXNjb3ZlcnlpZCB0cmFpdCB0aGVuIHVzZQogKiAgIGFjY2Vzc0tleSArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAqIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0gb2JqZWN0IHdpdGgga2V5cyB0byBpbmRleCBlbmRwb2ludHMuCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gZ2V0Q2FjaGVLZXkocmVxdWVzdCkgewogIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogIHZhciBhcGkgPSBzZXJ2aWNlLmFwaSB8fCB7fTsKICB2YXIgb3BlcmF0aW9ucyA9IGFwaS5vcGVyYXRpb25zOwogIHZhciBpZGVudGlmaWVycyA9IHt9OwogIGlmIChzZXJ2aWNlLmNvbmZpZy5yZWdpb24pIHsKICAgIGlkZW50aWZpZXJzLnJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICB9CiAgaWYgKGFwaS5zZXJ2aWNlSWQpIHsKICAgIGlkZW50aWZpZXJzLnNlcnZpY2VJZCA9IGFwaS5zZXJ2aWNlSWQ7CiAgfQogIGlmIChzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCkgewogICAgaWRlbnRpZmllcnMuYWNjZXNzS2V5SWQgPSBzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICB9CiAgcmV0dXJuIGlkZW50aWZpZXJzOwp9CgovKioKICogUmVjdXJzaXZlIGhlbHBlciBmb3IgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycygpLgogKiBMb29rcyBmb3IgcmVxdWlyZWQgc3RyaW5nIGlucHV0IG1lbWJlcnMgdGhhdCBoYXZlICdlbmRwb2ludGRpc2NvdmVyeWlkJyB0cmFpdC4KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKHJlc3VsdCwgcGFyYW1zLCBzaGFwZSkgewogIGlmICghc2hhcGUgfHwgcGFyYW1zID09PSB1bmRlZmluZWQgfHwgcGFyYW1zID09PSBudWxsKSByZXR1cm47CiAgaWYgKHNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnICYmIHNoYXBlLnJlcXVpcmVkICYmIHNoYXBlLnJlcXVpcmVkLmxlbmd0aCA+IDApIHsKICAgIHV0aWwuYXJyYXlFYWNoKHNoYXBlLnJlcXVpcmVkLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZS5lbmRwb2ludERpc2NvdmVyeUlkID09PSB0cnVlKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgICAgcmVzdWx0W2xvY2F0aW9uTmFtZV0gPSBTdHJpbmcocGFyYW1zW25hbWVdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKHJlc3VsdCwgcGFyYW1zW25hbWVdLCBtZW1iZXJTaGFwZSk7CiAgICAgIH0KICAgIH0pOwogIH0KfQoKLyoqCiAqIEdldCBjdXN0b20gaWRlbnRpZmllcnMgZm9yIGNhY2hlIGtleS4KICogSWRlbnRpZmllcyBjdXN0b20gaWRlbnRpZmllcnMgYnkgY2hlY2tpbmcgZWFjaCBzaGFwZSdzIGBlbmRwb2ludERpc2NvdmVyeUlkYCB0cmFpdC4KICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAqIEBwYXJhbSBbb2JqZWN0XSBpbnB1dCBzaGFwZSBvZiB0aGUgZ2l2ZW4gb3BlcmF0aW9uJ3MgYXBpCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBzaGFwZSkgewogIHZhciBpZGVudGlmaWVycyA9IHt9OwogIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIoaWRlbnRpZmllcnMsIHJlcXVlc3QucGFyYW1zLCBzaGFwZSk7CiAgcmV0dXJuIGlkZW50aWZpZXJzOwp9CgovKioKICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyBvcHRpb25hbC4KICogV2hlbiBlbmRwb2ludCBpcyBhdmFpbGFibGUgaW4gY2FjaGUgdGhlbiB1c2UgdGhlIGNhY2hlZCBlbmRwb2ludHMuIElmIGVuZHBvaW50cwogKiBhcmUgdW5hdmFpbGFibGUgdGhlbiB1c2UgcmVnaW9uYWwgZW5kcG9pbnRzIGFuZCBjYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24KICogYXN5bmNocm9ub3VzbHkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0LgogKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCkgewogIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9ucyA/IGFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA6IHVuZGVmaW5lZDsKICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CgogIHZhciBpZGVudGlmaWVycyA9IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgaW5wdXRTaGFwZSk7CiAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICBjYWNoZUtleSA9IHV0aWwudXBkYXRlKGNhY2hlS2V5LCBpZGVudGlmaWVycyk7CiAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgfQogIHZhciBlbmRwb2ludHMgPSBBV1MuZW5kcG9pbnRDYWNoZS5nZXQoY2FjaGVLZXkpOwogIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA9PT0gMSAmJiBlbmRwb2ludHNbMF0uQWRkcmVzcyA9PT0gJycpIHsKICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgIC8vb3IgZW5kcG9pbnQgb3BlcmF0aW9uIGp1c3QgZmFpbGVkIGluIDEgbWludXRlCiAgICByZXR1cm47CiAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgIC8vZm91bmQgZW5kcG9pbnQgcmVjb3JkIGZyb20gY2FjaGUKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogIH0gZWxzZSB7CiAgICAvL2VuZHBvaW50IHJlY29yZCBub3QgaW4gY2FjaGUgb3Igb3V0ZGF0ZWQuIG1ha2UgZGlzY292ZXJ5IG9wZXJhdGlvbgogICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgSWRlbnRpZmllcnM6IGlkZW50aWZpZXJzLAogICAgfSk7CiAgICBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCk7CiAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3JldHJ5JywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuUkVUUllfQ0hFQ0spOwogICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAvL3RvbyBtdWNoIGluLWZsaWdodCBjYWxscwogICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICBBZGRyZXNzOiAnJywKICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDEKICAgIH1dKTsKICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICBpZiAoZGF0YSAmJiBkYXRhLkVuZHBvaW50cykgewogICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgZGF0YS5FbmRwb2ludHMpOwogICAgICB9IGVsc2UgaWYgKGVycikgewogICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgW3sKICAgICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDEgLy9ub3QgdG8gbWFrZSBtb3JlIGVuZHBvaW50IG9wZXJhdGlvbiBpbiBuZXh0IDEgbWludXRlCiAgICAgICAgfV0pOwogICAgICB9CiAgICB9KTsKICB9Cn0KCnZhciByZXF1ZXN0UXVldWUgPSB7fTsKCi8qKgogKiBDYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24gd2hlbiBpdCdzIHJlcXVpcmVkLgogKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSBjYWNoZWQgb25lcy4gSWYgZW5kcG9pbnRzIGFyZQogKiB1bmF2YWlsYWJsZSB0aGVuIFNESyBzaG91bGQgY2FsbCBlbmRwb2ludCBvcGVyYXRpb24gdGhlbiB1c2UgcmV0dXJuZWQgbmV3CiAqIGVuZHBvaW50IGZvciB0aGUgYXBpIGNhbGwuIFNESyB3aWxsIGF1dG9tYXRpY2FsbHkgYXR0ZW1wdCB0byBkbyBlbmRwb2ludAogKiBkaXNjb3ZlcnkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0CiAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uTW9kZWwgPyBvcGVyYXRpb25Nb2RlbC5pbnB1dCA6IHVuZGVmaW5lZDsKCiAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgIGlmIChvcGVyYXRpb25Nb2RlbCkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uTW9kZWwubmFtZTsKICB9CiAgdmFyIGNhY2hlS2V5U3RyID0gQVdTLkVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGNhY2hlS2V5KTsKICB2YXIgZW5kcG9pbnRzID0gQVdTLmVuZHBvaW50Q2FjaGUuZ2V0KGNhY2hlS2V5U3RyKTsgLy9lbmRwb2ludCBjYWNoZSBhbHNvIGFjY2VwdHMgc3RyaW5nIGtleXMKICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAvL2VuZHBvaW50IG9wZXJhdGlvbiBpcyBiZWluZyBtYWRlIGJ1dCByZXNwb25zZSBub3QgeWV0IHJlY2VpdmVkCiAgICAvL3B1c2ggcmVxdWVzdCBvYmplY3QgdG8gYSBwZW5kaW5nIHF1ZXVlCiAgICBpZiAoIXJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0gPSBbXTsKICAgIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0ucHVzaCh7cmVxdWVzdDogcmVxdWVzdCwgY2FsbGJhY2s6IGRvbmV9KTsKICAgIHJldHVybjsKICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChlbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgICBkb25lKCk7CiAgfSBlbHNlIHsKICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICBPcGVyYXRpb246IG9wZXJhdGlvbk1vZGVsLm5hbWUsCiAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgIH0pOwogICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpOwoKICAgIC8vcHV0IGluIGEgcGxhY2Vob2xkZXIgZm9yIGVuZHBvaW50cyBhbHJlYWR5IHJlcXVlc3RlZCwgcHJldmVudAogICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleVN0ciwgW3sKICAgICAgQWRkcmVzczogJycsCiAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiA2MCAvL2xvbmctbGl2ZSBjYWNoZQogICAgfV0pOwogICAgZW5kcG9pbnRSZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICByZXF1ZXN0LnJlc3BvbnNlLmVycm9yID0gdXRpbC5lcnJvcihlcnIsIHsgcmV0cnlhYmxlOiBmYWxzZSB9KTsKICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwoKICAgICAgICAvL2ZhaWwgYWxsIHRoZSBwZW5kaW5nIHJlcXVlc3RzIGluIGJhdGNoCiAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgdXRpbC5hcnJheUVhY2gocGVuZGluZ1JlcXVlc3RzLCBmdW5jdGlvbihyZXF1ZXN0Q29udGV4dCkgewogICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0LnJlc3BvbnNlLmVycm9yID0gdXRpbC5lcnJvcihlcnIsIHsgcmV0cnlhYmxlOiBmYWxzZSB9KTsKICAgICAgICAgICAgcmVxdWVzdENvbnRleHQuY2FsbGJhY2soKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGRhdGEpIHsKICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXlTdHIsIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwoKICAgICAgICAvL3VwZGF0ZSB0aGUgZW5kcG9pbnQgZm9yIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ1JlcXVlc3RzID0gcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChkYXRhLkVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgICAgICAgICAgcmVxdWVzdENvbnRleHQuY2FsbGJhY2soKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgfQogICAgICB9CiAgICAgIGRvbmUoKTsKICAgIH0pOwogIH0KfQoKLyoqCiAqIGFkZCBhcGkgdmVyc2lvbiBoZWFkZXIgdG8gZW5kcG9pbnQgb3BlcmF0aW9uCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpIHsKICB2YXIgYXBpID0gZW5kcG9pbnRSZXF1ZXN0LnNlcnZpY2UuYXBpOwogIHZhciBhcGlWZXJzaW9uID0gYXBpLmFwaVZlcnNpb247CiAgaWYgKGFwaVZlcnNpb24gJiYgIWVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddKSB7CiAgICBlbmRwb2ludFJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotYXBpLXZlcnNpb24nXSA9IGFwaVZlcnNpb247CiAgfQp9CgovKioKICogSWYgYXBpIGNhbGwgZ2V0cyBpbnZhbGlkIGVuZHBvaW50IGV4Y2VwdGlvbiwgU0RLIHNob3VsZCBhdHRlbXB0IHRvIHJlbW92ZSB0aGUgaW52YWxpZAogKiBlbmRwb2ludCBmcm9tIGNhY2hlLgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMocmVzcG9uc2UpIHsKICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlOwogIGlmIChlcnJvciAmJgogICAgKGVycm9yLmNvZGUgPT09ICdJbnZhbGlkRW5kcG9pbnRFeGNlcHRpb24nIHx8IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MjEpCiAgKSB7CiAgICB2YXIgcmVxdWVzdCA9IHJlc3BvbnNlLnJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gPyBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXS5pbnB1dCA6IHVuZGVmaW5lZDsKICAgIHZhciBpZGVudGlmaWVycyA9IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgaW5wdXRTaGFwZSk7CiAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICAgIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgICBjYWNoZUtleSA9IHV0aWwudXBkYXRlKGNhY2hlS2V5LCBpZGVudGlmaWVycyk7CiAgICAgIGlmIChvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0ubmFtZTsKICAgIH0KICAgIEFXUy5lbmRwb2ludENhY2hlLnJlbW92ZShjYWNoZUtleSk7CiAgfQp9CgovKioKICogSWYgZW5kcG9pbnQgaXMgZXhwbGljaXRseSBjb25maWd1cmVkLCBTREsgc2hvdWxkIG5vdCBkbyBlbmRwb2ludCBkaXNjb3ZlcnkgaW4gYW55dGltZS4KICogQHBhcmFtIFtvYmplY3RdIGNsaWVudCBTZXJ2aWNlIGNsaWVudCBvYmplY3QuCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gaGFzQ3VzdG9tRW5kcG9pbnQoY2xpZW50KSB7CiAgLy9pZiBzZXQgZW5kcG9pbnQgaXMgc2V0IGZvciBzcGVjaWZpYyBjbGllbnQsIGVuYWJsZSBlbmRwb2ludCBkaXNjb3Zlcnkgd2lsbCByYWlzZSBhbiBlcnJvci4KICBpZiAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50ICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkID09PSB0cnVlKSB7CiAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgbWVzc2FnZTogJ0N1c3RvbSBlbmRwb2ludCBpcyBzdXBwbGllZDsgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkIG11c3Qgbm90IGJlIHRydWUuJwogICAgfSk7CiAgfTsKICB2YXIgc3ZjQ29uZmlnID0gQVdTLmNvbmZpZ1tjbGllbnQuc2VydmljZUlkZW50aWZpZXJdIHx8IHt9OwogIHJldHVybiBCb29sZWFuKEFXUy5jb25maWcuZW5kcG9pbnQgfHwgc3ZjQ29uZmlnLmVuZHBvaW50IHx8IChjbGllbnQuX29yaWdpbmFsQ29uZmlnICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnQpKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gaXNGYWxzeSh2YWx1ZSkgewogIHJldHVybiBbJ2ZhbHNlJywgJzAnXS5pbmRleE9mKHZhbHVlKSA+PSAwOwp9CgovKioKICogSWYgZW5kcG9pbnQgZGlzY292ZXJ5IHNob3VsZCBwZXJmb3JtIGZvciB0aGlzIHJlcXVlc3Qgd2hlbiBubyBvcGVyYXRpb24gcmVxdWlyZXMgZW5kcG9pbnQKICogZGlzY292ZXJ5IGZvciB0aGUgZ2l2ZW4gc2VydmljZS4KICogU0RLIHBlcmZvcm1zIGNvbmZpZyByZXNvbHV0aW9uIGluIG9yZGVyIGxpa2UgYmVsb3c6CiAqIDEuIElmIHNldCBpbiBjbGllbnQgY29uZmlndXJhdGlvbi4KICogMi4gSWYgc2V0IGluIGVudiBBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWS4KICogMy4gSWYgc2V0IGluIHNoYXJlZCBpbmkgY29uZmlnIGZpbGUgd2l0aCBrZXkgJ2VuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkJy4KICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3QgcmVxdWVzdCBvYmplY3QuCiAqIEByZXR1cm5zIFtib29sZWFufHVuZGVmaW5lZF0gaWYgZW5kcG9pbnQgZGlzY292ZXJ5IGNvbmZpZyBpcyBub3Qgc2V0IGluIGFueSBzb3VyY2UsIHRoaXMKICogIGZ1bmN0aW9uIHJldHVybnMgdW5kZWZpbmVkCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gcmVzb2x2ZUVuZHBvaW50RGlzY292ZXJ5Q29uZmlnKHJlcXVlc3QpIHsKICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICBpZiAoc2VydmljZS5jb25maWcuZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkICE9PSB1bmRlZmluZWQpIHsKICAgIHJldHVybiBzZXJ2aWNlLmNvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQ7CiAgfQoKICAvL3NoYXJlZCBpbmkgZmlsZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiBOb2RlCiAgLy9ub3QgdG8gY2hlY2sgZW52IGluIGJyb3dzZXIKICBpZiAodXRpbC5pc0Jyb3dzZXIoKSkgcmV0dXJuIHVuZGVmaW5lZDsKCiAgLy8gSWYgYW55IG9mIHJlY29nbml6ZWQgZW5kcG9pbnQgZGlzY292ZXJ5IGNvbmZpZyBlbnYgaXMgc2V0CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgZW52ID0gZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52c1tpXTsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvY2Vzcy5lbnYsIGVudikpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52W2Vudl0gPT09ICcnIHx8IHByb2Nlc3MuZW52W2Vudl0gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdlbnZpcm9ubWVudGFsIHZhcmlhYmxlICcgKyBlbnYgKyAnIGNhbm5vdCBiZSBzZXQgdG8gbm90aGluZycKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gIWlzRmFsc3kocHJvY2Vzcy5lbnZbZW52XSk7CiAgICB9CiAgfQoKICB2YXIgY29uZmlnRmlsZSA9IHt9OwogIHRyeSB7CiAgICBjb25maWdGaWxlID0gQVdTLnV0aWwuaW5pTG9hZGVyID8gQVdTLnV0aWwuaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgaXNDb25maWc6IHRydWUsCiAgICAgIGZpbGVuYW1lOiBwcm9jZXNzLmVudltBV1MudXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgfSkgOiB7fTsKICB9IGNhdGNoIChlKSB7fQogIHZhciBzaGFyZWRGaWxlQ29uZmlnID0gY29uZmlnRmlsZVsKICAgIHByb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IEFXUy51dGlsLmRlZmF1bHRQcm9maWxlCiAgXSB8fCB7fTsKICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNoYXJlZEZpbGVDb25maWcsICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcpKSB7CiAgICBpZiAoc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgbWVzc2FnZTogJ2NvbmZpZyBmaWxlIGVudHJ5IFwnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWRcJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuICFpc0ZhbHN5KHNoYXJlZEZpbGVDb25maWcuZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQpOwogIH0KICByZXR1cm4gdW5kZWZpbmVkOwp9CgovKioKICogYXR0YWNoIGVuZHBvaW50IGRpc2NvdmVyeSBsb2dpYyB0byByZXF1ZXN0IG9iamVjdAogKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdAogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGRpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCwgZG9uZSkgewogIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogIGlmIChoYXNDdXN0b21FbmRwb2ludChzZXJ2aWNlKSB8fCByZXF1ZXN0LmlzUHJlc2lnbmVkKCkpIHJldHVybiBkb25lKCk7CgogIHZhciBvcGVyYXRpb25zID0gc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICB2YXIgaXNFbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkID0gb3BlcmF0aW9uTW9kZWwgPyBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkIDogJ05VTEwnOwogIHZhciBpc0VuYWJsZWQgPSByZXNvbHZlRW5kcG9pbnREaXNjb3ZlcnlDb25maWcocmVxdWVzdCk7CiAgdmFyIGhhc1JlcXVpcmVkRW5kcG9pbnREaXNjb3ZlcnkgPSBzZXJ2aWNlLmFwaS5oYXNSZXF1aXJlZEVuZHBvaW50RGlzY292ZXJ5OwogIGlmIChpc0VuYWJsZWQgfHwgaGFzUmVxdWlyZWRFbmRwb2ludERpc2NvdmVyeSkgewogICAgLy8gT25jZSBhIGN1c3RvbWVyIGVuYWJsZXMgZW5kcG9pbnQgZGlzY292ZXJ5LCB0aGUgU0RLIHNob3VsZCBzdGFydCBhcHBlbmRpbmcKICAgIC8vIHRoZSBzdHJpbmcgZW5kcG9pbnQtZGlzY292ZXJ5IHRvIHRoZSB1c2VyLWFnZW50IG9uIGFsbCByZXF1ZXN0cy4KICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ2VuZHBvaW50LWRpc2NvdmVyeScpOwogIH0KICBzd2l0Y2ggKGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCkgewogICAgY2FzZSAnT1BUSU9OQUwnOgogICAgICBpZiAoaXNFbmFibGVkIHx8IGhhc1JlcXVpcmVkRW5kcG9pbnREaXNjb3ZlcnkpIHsKICAgICAgICAvLyBGb3IgYSBnaXZlbiBzZXJ2aWNlOyBpZiBhdCBsZWFzdCBvbmUgb3BlcmF0aW9uIHJlcXVpcmVzIGVuZHBvaW50IGRpc2NvdmVyeSB0aGVuIHRoZSBTREsgbXVzdCBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5CiAgICAgICAgLy8gYnkgZGVmYXVsdCBmb3IgYWxsIG9wZXJhdGlvbnMgb2YgdGhhdCBzZXJ2aWNlLCBpbmNsdWRpbmcgb3BlcmF0aW9ucyB3aGVyZSBlbmRwb2ludCBkaXNjb3ZlcnkgaXMgb3B0aW9uYWwuCiAgICAgICAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpOwogICAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICB9CiAgICAgIGRvbmUoKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdSRVFVSVJFRCc6CiAgICAgIGlmIChpc0VuYWJsZWQgPT09IGZhbHNlKSB7CiAgICAgICAgLy8gRm9yIGEgZ2l2ZW4gb3BlcmF0aW9uOyBpZiBlbmRwb2ludCBkaXNjb3ZlcnkgaXMgcmVxdWlyZWQgYW5kIGl0IGhhcyBiZWVuIGRpc2FibGVkIG9uIHRoZSBTREsgY2xpZW50LAogICAgICAgIC8vIHRoZW4gdGhlIFNESyBtdXN0IHJldHVybiBhIGNsZWFyIGFuZCBhY3Rpb25hYmxlIGV4Y2VwdGlvbi4KICAgICAgICByZXF1ZXN0LnJlc3BvbnNlLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ0VuZHBvaW50IERpc2NvdmVyeSBpcyBkaXNhYmxlZCBidXQgJyArIHNlcnZpY2UuYXBpLmNsYXNzTmFtZSArICcuJyArIHJlcXVlc3Qub3BlcmF0aW9uICsKICAgICAgICAgICAgICAgICAgICAnKCkgcmVxdWlyZXMgaXQuIFBsZWFzZSBjaGVjayB5b3VyIGNvbmZpZ3VyYXRpb25zLicKICAgICAgICB9KTsKICAgICAgICBkb25lKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdOVUxMJzoKICAgIGRlZmF1bHQ6CiAgICAgIGRvbmUoKTsKICAgICAgYnJlYWs7CiAgfQp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBkaXNjb3ZlckVuZHBvaW50OiBkaXNjb3ZlckVuZHBvaW50LAogIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludDogcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50LAogIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludDogb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50LAogIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnM6IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMsCiAgZ2V0Q2FjaGVLZXk6IGdldENhY2hlS2V5LAogIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludDogaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cywKfTsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vY29yZSI6MTksIi4vdXRpbCI6NzIsIl9wcm9jZXNzIjo5MH1dLDI4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGV2ZW50TWVzc2FnZUNodW5rZXIgPSByZXF1aXJlKCcuLi9ldmVudC1zdHJlYW0vZXZlbnQtbWVzc2FnZS1jaHVua2VyJykuZXZlbnRNZXNzYWdlQ2h1bmtlcjsKdmFyIHBhcnNlRXZlbnQgPSByZXF1aXJlKCcuL3BhcnNlLWV2ZW50JykucGFyc2VFdmVudDsKCmZ1bmN0aW9uIGNyZWF0ZUV2ZW50U3RyZWFtKGJvZHksIHBhcnNlciwgbW9kZWwpIHsKICAgIHZhciBldmVudE1lc3NhZ2VzID0gZXZlbnRNZXNzYWdlQ2h1bmtlcihib2R5KTsKCiAgICB2YXIgZXZlbnRzID0gW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudE1lc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZXZlbnRzLnB1c2gocGFyc2VFdmVudChwYXJzZXIsIGV2ZW50TWVzc2FnZXNbaV0sIG1vZGVsKSk7CiAgICB9CgogICAgcmV0dXJuIGV2ZW50czsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBjcmVhdGVFdmVudFN0cmVhbTogY3JlYXRlRXZlbnRTdHJlYW0KfTsKCn0seyIuLi9ldmVudC1zdHJlYW0vZXZlbnQtbWVzc2FnZS1jaHVua2VyIjoyOSwiLi9wYXJzZS1ldmVudCI6MzF9XSwyOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUYWtlcyBpbiBhIGJ1ZmZlciBvZiBldmVudCBtZXNzYWdlcyBhbmQgc3BsaXRzIHRoZW0gaW50byBpbmRpdmlkdWFsIG1lc3NhZ2VzLgogKiBAcGFyYW0ge0J1ZmZlcn0gYnVmZmVyCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gZXZlbnRNZXNzYWdlQ2h1bmtlcihidWZmZXIpIHsKICAgIC8qKiBAdHlwZSBCdWZmZXJbXSAqLwogICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICB2YXIgb2Zmc2V0ID0gMDsKCiAgICB3aGlsZSAob2Zmc2V0IDwgYnVmZmVyLmxlbmd0aCkgewogICAgICAgIHZhciB0b3RhbExlbmd0aCA9IGJ1ZmZlci5yZWFkSW50MzJCRShvZmZzZXQpOwoKICAgICAgICAvLyBjcmVhdGUgbmV3IGJ1ZmZlciBmb3IgaW5kaXZpZHVhbCBtZXNzYWdlIChzaGFyZXMgbWVtb3J5IHdpdGggb3JpZ2luYWwpCiAgICAgICAgdmFyIG1lc3NhZ2UgPSBidWZmZXIuc2xpY2Uob2Zmc2V0LCB0b3RhbExlbmd0aCArIG9mZnNldCk7CiAgICAgICAgLy8gaW5jcmVtZW50IG9mZnNldCB0byBpdCBzdGFydHMgYXQgdGhlIG5leHQgbWVzc2FnZQogICAgICAgIG9mZnNldCArPSB0b3RhbExlbmd0aDsKCiAgICAgICAgbWVzc2FnZXMucHVzaChtZXNzYWdlKTsKICAgIH0KCiAgICByZXR1cm4gbWVzc2FnZXM7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgZXZlbnRNZXNzYWdlQ2h1bmtlcjogZXZlbnRNZXNzYWdlQ2h1bmtlcgp9OwoKfSx7fV0sMzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL2NvcmUnKS51dGlsOwp2YXIgdG9CdWZmZXIgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcjsKCi8qKgogKiBBIGxvc3NsZXNzIHJlcHJlc2VudGF0aW9uIG9mIGEgc2lnbmVkLCA2NC1iaXQgaW50ZWdlci4gSW5zdGFuY2VzIG9mIHRoaXMKICogY2xhc3MgbWF5IGJlIHVzZWQgaW4gYXJpdGhtZXRpYyBleHByZXNzaW9ucyBhcyBpZiB0aGV5IHdlcmUgbnVtZXJpYwogKiBwcmltaXRpdmVzLCBidXQgdGhlIGJpbmFyeSByZXByZXNlbnRhdGlvbiB3aWxsIGJlIHByZXNlcnZlZCB1bmNoYW5nZWQgYXMgdGhlCiAqIGBieXRlc2AgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4gVGhlIGJ5dGVzIHNob3VsZCBiZSBlbmNvZGVkIGFzIGJpZy1lbmRpYW4sCiAqIHR3bydzIGNvbXBsZW1lbnQgaW50ZWdlcnMuCiAqIEBwYXJhbSB7QnVmZmVyfSBieXRlcwogKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIEludDY0KGJ5dGVzKSB7CiAgICBpZiAoYnl0ZXMubGVuZ3RoICE9PSA4KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnQ2NCBidWZmZXJzIG11c3QgYmUgZXhhY3RseSA4IGJ5dGVzJyk7CiAgICB9CiAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ5dGVzKSkgYnl0ZXMgPSB0b0J1ZmZlcihieXRlcyk7CgogICAgdGhpcy5ieXRlcyA9IGJ5dGVzOwp9CgovKioKICogQHBhcmFtIHtudW1iZXJ9IG51bWJlcgogKiBAcmV0dXJucyB7SW50NjR9CiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KSW50NjQuZnJvbU51bWJlciA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgaWYgKG51bWJlciA+IDkyMjMzNzIwMzY4NTQ3NzU4MDcgfHwgbnVtYmVyIDwgLTkyMjMzNzIwMzY4NTQ3NzU4MDgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgIG51bWJlciArICcgaXMgdG9vIGxhcmdlIChvciwgaWYgbmVnYXRpdmUsIHRvbyBzbWFsbCkgdG8gcmVwcmVzZW50IGFzIGFuIEludDY0JwogICAgICAgICk7CiAgICB9CgogICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICBmb3IgKAogICAgICAgIHZhciBpID0gNywgcmVtYWluaW5nID0gTWF0aC5hYnMoTWF0aC5yb3VuZChudW1iZXIpKTsKICAgICAgICBpID4gLTEgJiYgcmVtYWluaW5nID4gMDsKICAgICAgICBpLS0sIHJlbWFpbmluZyAvPSAyNTYKICAgICkgewogICAgICAgIGJ5dGVzW2ldID0gcmVtYWluaW5nOwogICAgfQoKICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgbmVnYXRlKGJ5dGVzKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IEludDY0KGJ5dGVzKTsKfTsKCi8qKgogKiBAcmV0dXJucyB7bnVtYmVyfQogKgogKiBAYXBpIHByaXZhdGUKICovCkludDY0LnByb3RvdHlwZS52YWx1ZU9mID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYnl0ZXMgPSB0aGlzLmJ5dGVzLnNsaWNlKDApOwogICAgdmFyIG5lZ2F0aXZlID0gYnl0ZXNbMF0gJiAxMjg7CiAgICBpZiAobmVnYXRpdmUpIHsKICAgICAgICBuZWdhdGUoYnl0ZXMpOwogICAgfQoKICAgIHJldHVybiBwYXJzZUludChieXRlcy50b1N0cmluZygnaGV4JyksIDE2KSAqIChuZWdhdGl2ZSA/IC0xIDogMSk7Cn07CgpJbnQ2NC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBTdHJpbmcodGhpcy52YWx1ZU9mKCkpOwp9OwoKLyoqCiAqIEBwYXJhbSB7QnVmZmVyfSBieXRlcwogKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIG5lZ2F0ZShieXRlcykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICBieXRlc1tpXSBePSAweEZGOwogICAgfQogICAgZm9yICh2YXIgaSA9IDc7IGkgPiAtMTsgaS0tKSB7CiAgICAgICAgYnl0ZXNbaV0rKzsKICAgICAgICBpZiAoYnl0ZXNbaV0gIT09IDApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIEludDY0OiBJbnQ2NAp9OwoKfSx7Ii4uL2NvcmUiOjE5fV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgcGFyc2VNZXNzYWdlID0gcmVxdWlyZSgnLi9wYXJzZS1tZXNzYWdlJykucGFyc2VNZXNzYWdlOwoKLyoqCiAqCiAqIEBwYXJhbSB7Kn0gcGFyc2VyCiAqIEBwYXJhbSB7QnVmZmVyfSBtZXNzYWdlCiAqIEBwYXJhbSB7Kn0gc2hhcGUKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBwYXJzZUV2ZW50KHBhcnNlciwgbWVzc2FnZSwgc2hhcGUpIHsKICAgIHZhciBwYXJzZWRNZXNzYWdlID0gcGFyc2VNZXNzYWdlKG1lc3NhZ2UpOwoKICAgIC8vIGNoZWNrIGlmIG1lc3NhZ2UgaXMgYW4gZXZlbnQgb3IgZXJyb3IKICAgIHZhciBtZXNzYWdlVHlwZSA9IHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1snOm1lc3NhZ2UtdHlwZSddOwogICAgaWYgKG1lc3NhZ2VUeXBlKSB7CiAgICAgICAgaWYgKG1lc3NhZ2VUeXBlLnZhbHVlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgIHRocm93IHBhcnNlRXJyb3IocGFyc2VkTWVzc2FnZSk7CiAgICAgICAgfSBlbHNlIGlmIChtZXNzYWdlVHlwZS52YWx1ZSAhPT0gJ2V2ZW50JykgewogICAgICAgICAgICAvLyBub3Qgc3VyZSBob3cgdG8gcGFyc2Ugbm9uLWV2ZW50cy9ub24tZXJyb3JzLCBpZ25vcmUgZm9yIG5vdwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIC8vIGRldGVybWluZSBldmVudCB0eXBlCiAgICB2YXIgZXZlbnRUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6ZXZlbnQtdHlwZSddOwogICAgLy8gY2hlY2sgdGhhdCB0aGUgZXZlbnQgdHlwZSBpcyBtb2RlbGVkCiAgICB2YXIgZXZlbnRNb2RlbCA9IHNoYXBlLm1lbWJlcnNbZXZlbnRUeXBlLnZhbHVlXTsKICAgIGlmICghZXZlbnRNb2RlbCkgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgcmVzdWx0ID0ge307CiAgICAvLyBjaGVjayBpZiBhbiBldmVudCBwYXlsb2FkIGV4aXN0cwogICAgdmFyIGV2ZW50UGF5bG9hZE1lbWJlck5hbWUgPSBldmVudE1vZGVsLmV2ZW50UGF5bG9hZE1lbWJlck5hbWU7CiAgICBpZiAoZXZlbnRQYXlsb2FkTWVtYmVyTmFtZSkgewogICAgICAgIHZhciBwYXlsb2FkU2hhcGUgPSBldmVudE1vZGVsLm1lbWJlcnNbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV07CiAgICAgICAgLy8gaWYgdGhlIHNoYXBlIGlzIGJpbmFyeSwgcmV0dXJuIHRoZSBieXRlIGFycmF5CiAgICAgICAgaWYgKHBheWxvYWRTaGFwZS50eXBlID09PSAnYmluYXJ5JykgewogICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZWRNZXNzYWdlLmJvZHk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0W2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdID0gcGFyc2VyLnBhcnNlKHBhcnNlZE1lc3NhZ2UuYm9keS50b1N0cmluZygpLCBwYXlsb2FkU2hhcGUpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyByZWFkIGV2ZW50IGhlYWRlcnMKICAgIHZhciBldmVudEhlYWRlck5hbWVzID0gZXZlbnRNb2RlbC5ldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudEhlYWRlck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIG5hbWUgPSBldmVudEhlYWRlck5hbWVzW2ldOwogICAgICAgIGlmIChwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgICAgLy8gcGFyc2UgdGhlIGhlYWRlciEKICAgICAgICAgICAgcmVzdWx0W25hbWVdID0gZXZlbnRNb2RlbC5tZW1iZXJzW25hbWVdLnRvVHlwZShwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0udmFsdWUpOwogICAgICAgIH0KICAgIH0KCiAgICB2YXIgb3V0cHV0ID0ge307CiAgICBvdXRwdXRbZXZlbnRUeXBlLnZhbHVlXSA9IHJlc3VsdDsKICAgIHJldHVybiBvdXRwdXQ7Cn0KCmZ1bmN0aW9uIHBhcnNlRXJyb3IobWVzc2FnZSkgewogICAgdmFyIGVycm9yQ29kZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLWNvZGUnXTsKICAgIHZhciBlcnJvck1lc3NhZ2UgPSBtZXNzYWdlLmhlYWRlcnNbJzplcnJvci1tZXNzYWdlJ107CiAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlLnZhbHVlIHx8IGVycm9yTWVzc2FnZSk7CiAgICBlcnJvci5jb2RlID0gZXJyb3IubmFtZSA9IGVycm9yQ29kZS52YWx1ZSB8fCBlcnJvckNvZGU7CiAgICByZXR1cm4gZXJyb3I7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgcGFyc2VFdmVudDogcGFyc2VFdmVudAp9OwoKfSx7Ii4vcGFyc2UtbWVzc2FnZSI6MzJ9XSwzMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBJbnQ2NCA9IHJlcXVpcmUoJy4vaW50NjQnKS5JbnQ2NDsKCnZhciBzcGxpdE1lc3NhZ2UgPSByZXF1aXJlKCcuL3NwbGl0LW1lc3NhZ2UnKS5zcGxpdE1lc3NhZ2U7Cgp2YXIgQk9PTEVBTl9UQUcgPSAnYm9vbGVhbic7CnZhciBCWVRFX1RBRyA9ICdieXRlJzsKdmFyIFNIT1JUX1RBRyA9ICdzaG9ydCc7CnZhciBJTlRfVEFHID0gJ2ludGVnZXInOwp2YXIgTE9OR19UQUcgPSAnbG9uZyc7CnZhciBCSU5BUllfVEFHID0gJ2JpbmFyeSc7CnZhciBTVFJJTkdfVEFHID0gJ3N0cmluZyc7CnZhciBUSU1FU1RBTVBfVEFHID0gJ3RpbWVzdGFtcCc7CnZhciBVVUlEX1RBRyA9ICd1dWlkJzsKCi8qKgogKiBAYXBpIHByaXZhdGUKICoKICogQHBhcmFtIHtCdWZmZXJ9IGhlYWRlcnMKICovCmZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgICB2YXIgb3V0ID0ge307CiAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgd2hpbGUgKHBvc2l0aW9uIDwgaGVhZGVycy5sZW5ndGgpIHsKICAgICAgICB2YXIgbmFtZUxlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQ4KHBvc2l0aW9uKyspOwogICAgICAgIHZhciBuYW1lID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBuYW1lTGVuZ3RoKS50b1N0cmluZygpOwogICAgICAgIHBvc2l0aW9uICs9IG5hbWVMZW5ndGg7CiAgICAgICAgc3dpdGNoIChoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKSkgewogICAgICAgICAgICBjYXNlIDAgLyogYm9vbFRydWUgKi86CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAxIC8qIGJvb2xGYWxzZSAqLzoKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBCT09MRUFOX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAyIC8qIGJ5dGUgKi86CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogQllURV9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDgocG9zaXRpb24rKykKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzIC8qIHNob3J0ICovOgogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IFNIT1JUX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MTZCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNCAvKiBpbnRlZ2VyICovOgogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IElOVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDMyQkUocG9zaXRpb24pCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gNDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDUgLyogbG9uZyAqLzoKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBMT05HX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3IEludDY0KGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgOCkpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gODsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDYgLyogYnl0ZUFycmF5ICovOgogICAgICAgICAgICAgICAgdmFyIGJpbmFyeUxlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQxNkJFKHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogQklOQVJZX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBiaW5hcnlMZW5ndGgpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gYmluYXJ5TGVuZ3RoOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNyAvKiBzdHJpbmcgKi86CiAgICAgICAgICAgICAgICB2YXIgc3RyaW5nTGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDE2QkUocG9zaXRpb24pOwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBTVFJJTkdfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnNsaWNlKAogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKyBzdHJpbmdMZW5ndGgKICAgICAgICAgICAgICAgICAgICApLnRvU3RyaW5nKCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBzdHJpbmdMZW5ndGg7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSA4IC8qIHRpbWVzdGFtcCAqLzoKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBUSU1FU1RBTVBfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgRGF0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgbmV3IEludDY0KGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgOCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudmFsdWVPZigpCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDg7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSA5IC8qIHV1aWQgKi86CiAgICAgICAgICAgICAgICB2YXIgdXVpZENoYXJzID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyAxNikKICAgICAgICAgICAgICAgICAgICAudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMTY7CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogVVVJRF9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHV1aWRDaGFycy5zdWJzdHIoMCwgOCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDgsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxMiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDE2LCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMjApCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXplZCBoZWFkZXIgdHlwZSB0YWcnKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiBwYXJzZU1lc3NhZ2UobWVzc2FnZSkgewogICAgdmFyIHBhcnNlZCA9IHNwbGl0TWVzc2FnZShtZXNzYWdlKTsKICAgIHJldHVybiB7IGhlYWRlcnM6IHBhcnNlSGVhZGVycyhwYXJzZWQuaGVhZGVycyksIGJvZHk6IHBhcnNlZC5ib2R5IH07Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgcGFyc2VNZXNzYWdlOiBwYXJzZU1lc3NhZ2UKfTsKCn0seyIuL2ludDY0IjozMCwiLi9zcGxpdC1tZXNzYWdlIjozM31dLDMzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlJykudXRpbDsKdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CgovLyBBbGwgcHJlbHVkZSBjb21wb25lbnRzIGFyZSB1bnNpZ25lZCwgMzItYml0IGludGVnZXJzCnZhciBQUkVMVURFX01FTUJFUl9MRU5HVEggPSA0OwovLyBUaGUgcHJlbHVkZSBjb25zaXN0cyBvZiB0d28gY29tcG9uZW50cwp2YXIgUFJFTFVERV9MRU5HVEggPSBQUkVMVURFX01FTUJFUl9MRU5HVEggKiAyOwovLyBDaGVja3N1bXMgYXJlIGFsd2F5cyBDUkMzMiBoYXNoZXMuCnZhciBDSEVDS1NVTV9MRU5HVEggPSA0OwovLyBNZXNzYWdlcyBtdXN0IGluY2x1ZGUgYSBmdWxsIHByZWx1ZGUsIGEgcHJlbHVkZSBjaGVja3N1bSwgYW5kIGEgbWVzc2FnZSBjaGVja3N1bQp2YXIgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCA9IFBSRUxVREVfTEVOR1RIICsgQ0hFQ0tTVU1fTEVOR1RIICogMjsKCi8qKgogKiBAYXBpIHByaXZhdGUKICoKICogQHBhcmFtIHtCdWZmZXJ9IG1lc3NhZ2UKICovCmZ1bmN0aW9uIHNwbGl0TWVzc2FnZShtZXNzYWdlKSB7CiAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKG1lc3NhZ2UpKSBtZXNzYWdlID0gdG9CdWZmZXIobWVzc2FnZSk7CgogICAgaWYgKG1lc3NhZ2UubGVuZ3RoIDwgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignUHJvdmlkZWQgbWVzc2FnZSB0b28gc2hvcnQgdG8gYWNjb21tb2RhdGUgZXZlbnQgc3RyZWFtIG1lc3NhZ2Ugb3ZlcmhlYWQnKTsKICAgIH0KCiAgICBpZiAobWVzc2FnZS5sZW5ndGggIT09IG1lc3NhZ2UucmVhZFVJbnQzMkJFKDApKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXBvcnRlZCBtZXNzYWdlIGxlbmd0aCBkb2VzIG5vdCBtYXRjaCByZWNlaXZlZCBtZXNzYWdlIGxlbmd0aCcpOwogICAgfQoKICAgIHZhciBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSA9IG1lc3NhZ2UucmVhZFVJbnQzMkJFKFBSRUxVREVfTEVOR1RIKTsKCiAgICBpZiAoCiAgICAgICAgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gIT09IHV0aWwuY3J5cHRvLmNyYzMyKAogICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIFBSRUxVREVfTEVOR1RIKQogICAgICAgICkKICAgICkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgJ1RoZSBwcmVsdWRlIGNoZWNrc3VtIHNwZWNpZmllZCBpbiB0aGUgbWVzc2FnZSAoJyArCiAgICAgICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICsKICAgICAgICAgICAgJykgZG9lcyBub3QgbWF0Y2ggdGhlIGNhbGN1bGF0ZWQgQ1JDMzIgY2hlY2tzdW0uJwogICAgICAgICk7CiAgICB9CgogICAgdmFyIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtID0gbWVzc2FnZS5yZWFkVUludDMyQkUobWVzc2FnZS5sZW5ndGggLSBDSEVDS1NVTV9MRU5HVEgpOwoKICAgIGlmICgKICAgICAgICBleHBlY3RlZE1lc3NhZ2VDaGVja3N1bSAhPT0gdXRpbC5jcnlwdG8uY3JjMzIoCiAgICAgICAgICAgIG1lc3NhZ2Uuc2xpY2UoMCwgbWVzc2FnZS5sZW5ndGggLSBDSEVDS1NVTV9MRU5HVEgpCiAgICAgICAgKQogICAgKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAnVGhlIG1lc3NhZ2UgY2hlY2tzdW0gZGlkIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWQgdmFsdWUgb2YgJyArCiAgICAgICAgICAgICAgICBleHBlY3RlZE1lc3NhZ2VDaGVja3N1bQogICAgICAgICk7CiAgICB9CgogICAgdmFyIGhlYWRlcnNTdGFydCA9IFBSRUxVREVfTEVOR1RIICsgQ0hFQ0tTVU1fTEVOR1RIOwogICAgdmFyIGhlYWRlcnNFbmQgPSBoZWFkZXJzU3RhcnQgKyBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX01FTUJFUl9MRU5HVEgpOwoKICAgIHJldHVybiB7CiAgICAgICAgaGVhZGVyczogbWVzc2FnZS5zbGljZShoZWFkZXJzU3RhcnQsIGhlYWRlcnNFbmQpLAogICAgICAgIGJvZHk6IG1lc3NhZ2Uuc2xpY2UoaGVhZGVyc0VuZCwgbWVzc2FnZS5sZW5ndGggLSBDSEVDS1NVTV9MRU5HVEgpLAogICAgfTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBzcGxpdE1lc3NhZ2U6IHNwbGl0TWVzc2FnZQp9OwoKfSx7Ii4uL2NvcmUiOjE5fV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwp2YXIgU2VxdWVudGlhbEV4ZWN1dG9yID0gcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CnZhciBESVNDT1ZFUl9FTkRQT0lOVCA9IHJlcXVpcmUoJy4vZGlzY292ZXJfZW5kcG9pbnQnKS5kaXNjb3ZlckVuZHBvaW50OwovKioKICogVGhlIG5hbWVzcGFjZSB1c2VkIHRvIHJlZ2lzdGVyIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgZm9yIHJlcXVlc3QgYnVpbGRpbmcKICogYW5kIHNlbmRpbmcuCiAqLwpBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgLyoqCiAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfQ1JFREVOVElBTFMKICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZXF1ZXN0IGlzIGJlaW5nCiAgICogICBzZW50IHdpdGggY3JlZGVudGlhbHMuCiAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIGNyZWRlbnRpYWxzCiAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTOwogICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgKiAgIEByZWFkb25seQogICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfUkVHSU9OCiAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgd2hldGhlciB0aGUgcmVnaW9uIGlzIHNldAogICAqICAgZm9yIGEgcmVxdWVzdC4KICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcmVnaW9uIGNvbmZpZ3VyYXRpb24KICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OOwogICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgKiAgIEByZWFkb25seQogICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICogQCFhdHRyaWJ1dGUgVkFMSURBVEVfUEFSQU1FVEVSUwogICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIGlucHV0IHBhcmFtZXRlcnMgaW4gYSByZXF1ZXN0LgogICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyBwYXJhbWV0ZXJzCiAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlM7CiAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgbGlzdGVuZXIpOwogICAqICAgQGV4YW1wbGUgRGlzYWJsZSBwYXJhbWV0ZXIgdmFsaWRhdGlvbiBnbG9iYWxseQogICAqICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLAogICAqICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTik7CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAqIEAhYXR0cmlidXRlIFNFTkQKICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IGluaXRpYXRlcyB0aGUgSFRUUCBjb25uZWN0aW9uIGZvciBhCiAgICogICByZXF1ZXN0IGJlaW5nIHNlbnQuIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH5zZW5kICdzZW5kJyBSZXF1ZXN0IGV2ZW50fQogICAqICAgQGV4YW1wbGUgUmVwbGFjaW5nIHRoZSBIVFRQIGhhbmRsZXIKICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORDsKICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignc2VuZCcsIGxpc3RlbmVyKTsKICAgKiAgICAgcmVxdWVzdC5vbignc2VuZCcsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgICAgY3VzdG9tSGFuZGxlci5zZW5kKHJlc3BvbnNlKTsKICAgKiAgICAgfSk7CiAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgKiAgIEByZWFkb25seQogICAqIEAhYXR0cmlidXRlIEhUVFBfREFUQQogICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgcmVhZHMgZGF0YSBmcm9tIHRoZSBIVFRQIGNvbm5lY3Rpb24gaW4gb3JkZXIKICAgKiAgIHRvIGJ1aWxkIHRoZSByZXNwb25zZSBkYXRhLgogICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fmh0dHBEYXRhICdodHRwRGF0YScgUmVxdWVzdCBldmVudH0uCiAgICogICBSZW1vdmUgdGhpcyBoYW5kbGVyIGlmIHlvdSBhcmUgb3ZlcnJpZGluZyB0aGUgJ2h0dHBEYXRhJyBldmVudCBhbmQKICAgKiAgIGRvIG5vdCB3YW50IGV4dHJhIGRhdGEgcHJvY2Vzc2luZyBhbmQgYnVmZmVyaW5nIG92ZXJoZWFkLgogICAqICAgQGV4YW1wbGUgRGlzYWJsaW5nIGRlZmF1bHQgZGF0YSBwcm9jZXNzaW5nCiAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQTsKICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignaHR0cERhdGEnLCBsaXN0ZW5lcik7CiAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgKiAgIEByZWFkb25seQogICAqLwogIENvcmU6IHt9IC8qIGRvYyBoYWNrICovCn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBnZXRPcGVyYXRpb25BdXRodHlwZShyZXEpIHsKICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICByZXR1cm4gJyc7CiAgfQogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICByZXR1cm4gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7Cn0KCkFXUy5FdmVudExpc3RlbmVycyA9IHsKICBDb3JlOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkLCBhZGRBc3luYykgewogICAgYWRkQXN5bmMoJ1ZBTElEQVRFX0NSRURFTlRJQUxTJywgJ3ZhbGlkYXRlJywKICAgICAgICBmdW5jdGlvbiBWQUxJREFURV9DUkVERU5USUFMUyhyZXEsIGRvbmUpIHsKICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgcmVxLnNlcnZpY2UuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKGVyciwKICAgICAgICAgICAge2NvZGU6ICdDcmVkZW50aWFsc0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgY3JlZGVudGlhbHMgaW4gY29uZmlnLCBpZiB1c2luZyBBV1NfQ09ORklHX0ZJTEUsIHNldCBBV1NfU0RLX0xPQURfQ09ORklHPTEnfSk7CiAgICAgICAgfQogICAgICAgIGRvbmUoKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBhZGQoJ1ZBTElEQVRFX1JFR0lPTicsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFR0lPTihyZXEpIHsKICAgICAgaWYgKCFyZXEuc2VydmljZS5pc0dsb2JhbEVuZHBvaW50KSB7CiAgICAgICAgdmFyIGRuc0hvc3RSZWdleCA9IG5ldyBSZWdFeHAoL14oW2EtekEtWjAtOV18W2EtekEtWjAtOV1bYS16QS1aMC05LV17MCw2MX1bYS16QS1aMC05XSkkLyk7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5jb25maWcucmVnaW9uKSB7CiAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdDb25maWdFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIHJlZ2lvbiBpbiBjb25maWcnfSk7CiAgICAgICAgfSBlbHNlIGlmICghZG5zSG9zdFJlZ2V4LnRlc3QocmVxLnNlcnZpY2UuY29uZmlnLnJlZ2lvbikpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ0ludmFsaWQgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnQlVJTERfSURFTVBPVEVOQ1lfVE9LRU5TJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gQlVJTERfSURFTVBPVEVOQ1lfVE9LRU5TKHJlcSkgewogICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgaWYgKCFvcGVyYXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGlkZW1wb3RlbnRNZW1iZXJzID0gb3BlcmF0aW9uLmlkZW1wb3RlbnRNZW1iZXJzOwogICAgICBpZiAoIWlkZW1wb3RlbnRNZW1iZXJzLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvLyBjcmVhdGVzIGEgY29weSBvZiBwYXJhbXMgc28gdXNlcidzIHBhcmFtIG9iamVjdCBpc24ndCBtdXRhdGVkCiAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHJlcS5wYXJhbXMpOwogICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGlkZW1wb3RlbnRNZW1iZXJzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgIGlmICghcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSkgewogICAgICAgICAgLy8gYWRkIHRoZSBtZW1iZXIKICAgICAgICAgIHBhcmFtc1tpZGVtcG90ZW50TWVtYmVyc1tpXV0gPSBBV1MudXRpbC51dWlkLnY0KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlcS5wYXJhbXMgPSBwYXJhbXM7CiAgICB9KTsKCiAgICBhZGQoJ1ZBTElEQVRFX1BBUkFNRVRFUlMnLCAndmFsaWRhdGUnLCBmdW5jdGlvbiBWQUxJREFURV9QQVJBTUVURVJTKHJlcSkgewogICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICB2YXIgdmFsaWRhdGlvbiA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5wYXJhbVZhbGlkYXRpb247CiAgICAgIG5ldyBBV1MuUGFyYW1WYWxpZGF0b3IodmFsaWRhdGlvbikudmFsaWRhdGUocnVsZXMsIHJlcS5wYXJhbXMpOwogICAgfSk7CgogICAgYWRkKCdDT01QVVRFX0NIRUNLU1VNJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBDT01QVVRFX0NIRUNLU1VNKHJlcSkgewogICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgaWYgKCFvcGVyYXRpb24pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGJvZHkgPSByZXEuaHR0cFJlcXVlc3QuYm9keTsKICAgICAgdmFyIGlzTm9uU3RyZWFtaW5nUGF5bG9hZCA9IGJvZHkgJiYgKEFXUy51dGlsLkJ1ZmZlci5pc0J1ZmZlcihib2R5KSB8fCB0eXBlb2YgYm9keSA9PT0gJ3N0cmluZycpOwogICAgICB2YXIgaGVhZGVycyA9IHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzOwogICAgICBpZiAoCiAgICAgICAgb3BlcmF0aW9uLmh0dHBDaGVja3N1bVJlcXVpcmVkICYmCiAgICAgICAgcmVxLnNlcnZpY2UuY29uZmlnLmNvbXB1dGVDaGVja3N1bXMgJiYKICAgICAgICBpc05vblN0cmVhbWluZ1BheWxvYWQgJiYKICAgICAgICAhaGVhZGVyc1snQ29udGVudC1NRDUnXQogICAgICApIHsKICAgICAgICB2YXIgbWQ1ID0gQVdTLnV0aWwuY3J5cHRvLm1kNShib2R5LCAnYmFzZTY0Jyk7CiAgICAgICAgaGVhZGVyc1snQ29udGVudC1NRDUnXSA9IG1kNTsKICAgICAgfQogICAgfSk7CgogICAgYWRkQXN5bmMoJ0NPTVBVVEVfU0hBMjU2JywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBDT01QVVRFX1NIQTI1NihyZXEsIGRvbmUpIHsKICAgICAgcmVxLmhhbHRIYW5kbGVyc09uRXJyb3IoKTsKICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgIHZhciBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFhdXRodHlwZSAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgaWYgKHJlcS5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSkgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICAgICAgdmFyIGJvZHkgPSByZXEuaHR0cFJlcXVlc3QuYm9keSB8fCAnJzsKICAgICAgICBpZiAoYXV0aHR5cGUuaW5kZXhPZigndW5zaWduZWQtYm9keScpID49IDApIHsKICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgICAgICAgcmV0dXJuIGRvbmUoKTsKICAgICAgICB9CiAgICAgICAgQVdTLnV0aWwuY29tcHV0ZVNoYTI1Nihib2R5LCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICBkb25lKGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10gPSBzaGE7CiAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb25lKCk7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnU0VUX0NPTlRFTlRfTEVOR1RIJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBTRVRfQ09OVEVOVF9MRU5HVEgocmVxKSB7CiAgICAgIHZhciBhdXRodHlwZSA9IGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSk7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gQVdTLnV0aWwuZ2V0UmVxdWVzdFBheWxvYWRTaGFwZShyZXEpOwogICAgICBpZiAocmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gQVdTLnV0aWwuc3RyaW5nLmJ5dGVMZW5ndGgocmVxLmh0dHBSZXF1ZXN0LmJvZHkpOwogICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSBsZW5ndGg7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBpZiAocGF5bG9hZE1lbWJlciAmJiBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnJlcXVpcmVzTGVuZ3RoKSB7CiAgICAgICAgICAgICAgLy9zdHJlYW1pbmcgcGF5bG9hZCByZXF1aXJlcyBsZW5ndGgoczMsIGdsYWNpZXIpCiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICB9IGVsc2UgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICAgICAgLy91bmJvdW5kZWQgc3RyZWFtaW5nIHBheWxvYWQobGV4LCBtZWRpYXN0b3JlKQogICAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydUcmFuc2Zlci1FbmNvZGluZyddID0gJ2NodW5rZWQnOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IGVycjsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnU0VUX0hUVFBfSE9TVCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0hUVFBfSE9TVChyZXEpIHsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0hvc3QnXSA9IHJlcS5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0OwogICAgfSk7CgogICAgYWRkKCdTRVRfVFJBQ0VfSUQnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIFNFVF9UUkFDRV9JRChyZXEpIHsKICAgICAgdmFyIHRyYWNlSWRIZWFkZXJOYW1lID0gJ1gtQW16bi1UcmFjZS1JZCc7CiAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSAmJiAhT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwocmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnMsIHRyYWNlSWRIZWFkZXJOYW1lKSkgewogICAgICAgIHZhciBFTlZfTEFNQkRBX0ZVTkNUSU9OX05BTUUgPSAnQVdTX0xBTUJEQV9GVU5DVElPTl9OQU1FJzsKICAgICAgICB2YXIgRU5WX1RSQUNFX0lEID0gJ19YX0FNWk5fVFJBQ0VfSUQnOwogICAgICAgIHZhciBmdW5jdGlvbk5hbWUgPSBwcm9jZXNzLmVudltFTlZfTEFNQkRBX0ZVTkNUSU9OX05BTUVdOwogICAgICAgIHZhciB0cmFjZUlkID0gcHJvY2Vzcy5lbnZbRU5WX1RSQUNFX0lEXTsKICAgICAgICBpZiAoCiAgICAgICAgICB0eXBlb2YgZnVuY3Rpb25OYW1lID09PSAnc3RyaW5nJyAmJgogICAgICAgICAgZnVuY3Rpb25OYW1lLmxlbmd0aCA+IDAgJiYKICAgICAgICAgIHR5cGVvZiB0cmFjZUlkID09PSAnc3RyaW5nJyAmJgogICAgICAgICAgdHJhY2VJZC5sZW5ndGggPiAwCiAgICAgICAgKSB7CiAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1t0cmFjZUlkSGVhZGVyTmFtZV0gPSB0cmFjZUlkOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgYWRkKCdSRVNUQVJUJywgJ3Jlc3RhcnQnLCBmdW5jdGlvbiBSRVNUQVJUKCkgewogICAgICB2YXIgZXJyID0gdGhpcy5yZXNwb25zZS5lcnJvcjsKICAgICAgaWYgKCFlcnIgfHwgIWVyci5yZXRyeWFibGUpIHJldHVybjsKCiAgICAgIHRoaXMuaHR0cFJlcXVlc3QgPSBuZXcgQVdTLkh0dHBSZXF1ZXN0KAogICAgICAgIHRoaXMuc2VydmljZS5lbmRwb2ludCwKICAgICAgICB0aGlzLnNlcnZpY2UucmVnaW9uCiAgICAgICk7CgogICAgICBpZiAodGhpcy5yZXNwb25zZS5yZXRyeUNvdW50IDwgdGhpcy5zZXJ2aWNlLmNvbmZpZy5tYXhSZXRyaWVzKSB7CiAgICAgICAgdGhpcy5yZXNwb25zZS5yZXRyeUNvdW50Kys7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IG51bGw7CiAgICAgIH0KICAgIH0pOwoKICAgIHZhciBhZGRUb0hlYWQgPSB0cnVlOwogICAgYWRkQXN5bmMoJ0RJU0NPVkVSX0VORFBPSU5UJywgJ3NpZ24nLCBESVNDT1ZFUl9FTkRQT0lOVCwgYWRkVG9IZWFkKTsKCiAgICBhZGRBc3luYygnU0lHTicsICdzaWduJywgZnVuY3Rpb24gU0lHTihyZXEsIGRvbmUpIHsKICAgICAgdmFyIHNlcnZpY2UgPSByZXEuc2VydmljZTsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgdmFyIG9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgIHZhciBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICBpZiAoIXNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24gJiYgIWF1dGh0eXBlICYmICFzZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCgogICAgICBzZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbiAoZXJyLCBjcmVkZW50aWFscykgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGRhdGUgPSBzZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCk7CiAgICAgICAgICB2YXIgU2lnbmVyQ2xhc3MgPSBzZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSk7CiAgICAgICAgICB2YXIgc2lnbmVyID0gbmV3IFNpZ25lckNsYXNzKHJlcS5odHRwUmVxdWVzdCwKICAgICAgICAgICAgc2VydmljZS5nZXRTaWduaW5nTmFtZShyZXEpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2lnbmF0dXJlQ2FjaGU6IHNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZUNhY2hlLAogICAgICAgICAgICAgIG9wZXJhdGlvbjogb3BlcmF0aW9uLAogICAgICAgICAgICAgIHNpZ25hdHVyZVZlcnNpb246IHNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24KICAgICAgICAgICAgfSk7CiAgICAgICAgICBzaWduZXIuc2V0U2VydmljZUNsaWVudElkKHNlcnZpY2UuX2NsaWVudElkKTsKCiAgICAgICAgICAvLyBjbGVhciBvbGQgYXV0aG9yaXphdGlvbiBoZWFkZXJzCiAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXTsKICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snRGF0ZSddOwogICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ107CgogICAgICAgICAgLy8gYWRkIG5ldyBhdXRob3JpemF0aW9uCiAgICAgICAgICBzaWduZXIuYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSk7CiAgICAgICAgICByZXEuc2lnbmVkQXQgPSBkYXRlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IGU7CiAgICAgICAgfQogICAgICAgIGRvbmUoKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBhZGQoJ1ZBTElEQVRFX1JFU1BPTlNFJywgJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbiBWQUxJREFURV9SRVNQT05TRShyZXNwKSB7CiAgICAgIGlmICh0aGlzLnNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIHRoaXMpKSB7CiAgICAgICAgcmVzcC5kYXRhID0ge307CiAgICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzcC5kYXRhID0gbnVsbDsKICAgICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICB7Y29kZTogJ1Vua25vd25FcnJvcicsIG1lc3NhZ2U6ICdBbiB1bmtub3duIGVycm9yIG9jY3VycmVkLid9KTsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdFUlJPUicsICdlcnJvcicsIGZ1bmN0aW9uIEVSUk9SKGVyciwgcmVzcCkgewogICAgICB2YXIgZXJyb3JDb2RlTWFwcGluZyA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmFwaS5lcnJvckNvZGVNYXBwaW5nOwogICAgICBpZiAoZXJyb3JDb2RlTWFwcGluZyAmJiBlcnIgJiYgZXJyLmNvZGUpIHsKICAgICAgICB2YXIgbWFwcGluZyA9IGVycm9yQ29kZU1hcHBpbmdbZXJyLmNvZGVdOwogICAgICAgIGlmIChtYXBwaW5nKSB7CiAgICAgICAgICByZXNwLmVycm9yLmNvZGUgPSBtYXBwaW5nLmNvZGU7CiAgICAgICAgfQogICAgICB9CiAgICB9LCB0cnVlKTsKCiAgICBhZGRBc3luYygnU0VORCcsICdzZW5kJywgZnVuY3Rpb24gU0VORChyZXNwLCBkb25lKSB7CiAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLl9hYm9ydENhbGxiYWNrID0gZG9uZTsKICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgIHJlc3AuZGF0YSA9IG51bGw7CgogICAgICBmdW5jdGlvbiBjYWxsYmFjayhodHRwUmVzcCkgewogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA9IGh0dHBSZXNwOwogICAgICAgIHZhciBzdHJlYW0gPSByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3Quc3RyZWFtOwogICAgICAgIHZhciBzZXJ2aWNlID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbjsKICAgICAgICB2YXIgb3BlcmF0aW9uID0gYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uTmFtZV0gfHwge307CgogICAgICAgIGh0dHBSZXNwLm9uKCdoZWFkZXJzJywgZnVuY3Rpb24gb25IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KAogICAgICAgICAgICAnaHR0cEhlYWRlcnMnLAogICAgICAgICAgICBbc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZV0KICAgICAgICAgICk7CgogICAgICAgICAgaWYgKCFyZXNwLmh0dHBSZXNwb25zZS5zdHJlYW1pbmcpIHsKICAgICAgICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7IC8vIHN0cmVhbXMyIEFQSSBjaGVjawogICAgICAgICAgICAgIC8vIGlmIHdlIGRldGVjdCBldmVudCBzdHJlYW1zLCB3ZSdyZSBnb2luZyB0byBoYXZlIHRvCiAgICAgICAgICAgICAgLy8gcmV0dXJuIHRoZSBzdHJlYW0gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICBpZiAob3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0ICYmIHNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApKSB7CiAgICAgICAgICAgICAgICAvLyBza2lwIHJlYWRpbmcgdGhlIEluY29taW5nU3RyZWFtCiAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdyZWFkYWJsZScsIGZ1bmN0aW9uIG9uUmVhZGFibGUoKSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGh0dHBSZXNwLnJlYWQoKTsKICAgICAgICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRGF0YScsIFtkYXRhLCByZXNwXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7IC8vIGxlZ2FjeSBzdHJlYW1zIEFQSQogICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdkYXRhJywgZnVuY3Rpb24gb25EYXRhKGRhdGEpIHsKICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRGF0YScsIFtkYXRhLCByZXNwXSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaHR0cFJlc3Aub24oJ2VuZCcsIGZ1bmN0aW9uIG9uRW5kKCkgewogICAgICAgICAgaWYgKCFzdHJlYW0gfHwgIXN0cmVhbS5kaWRDYWxsYmFjaykgewogICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgJiYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkpIHsKICAgICAgICAgICAgICAvLyBkb24ndCBjb25jYXRlbmF0ZSByZXNwb25zZSBjaHVua3Mgd2hlbiBzdHJlYW1pbmcgZXZlbnQgc3RyZWFtIGRhdGEgd2hlbiByZXNwb25zZSBpcyBzdWNjZXNzZnVsCiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG9uZScpOwogICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHByb2dyZXNzKGh0dHBSZXNwKSB7CiAgICAgICAgaHR0cFJlc3Aub24oJ3NlbmRQcm9ncmVzcycsIGZ1bmN0aW9uIG9uU2VuZFByb2dyZXNzKHZhbHVlKSB7CiAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cFVwbG9hZFByb2dyZXNzJywgW3ZhbHVlLCByZXNwXSk7CiAgICAgICAgfSk7CgogICAgICAgIGh0dHBSZXNwLm9uKCdyZWNlaXZlUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblJlY2VpdmVQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb3dubG9hZFByb2dyZXNzJywgW3ZhbHVlLCByZXNwXSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGVycm9yKGVycikgewogICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ1JlcXVlc3RBYm9ydGVkRXJyb3InKSB7CiAgICAgICAgICB2YXIgZXJyQ29kZSA9IGVyci5jb2RlID09PSAnVGltZW91dEVycm9yJyA/IGVyci5jb2RlIDogJ05ldHdvcmtpbmdFcnJvcic7CiAgICAgICAgICBlcnIgPSBBV1MudXRpbC5lcnJvcihlcnIsIHsKICAgICAgICAgICAgY29kZTogZXJyQ29kZSwKICAgICAgICAgICAgcmVnaW9uOiByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uLAogICAgICAgICAgICBob3N0bmFtZTogcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3RuYW1lLAogICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXNwLmVycm9yID0gZXJyOwogICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRXJyb3InLCBbcmVzcC5lcnJvciwgcmVzcF0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBleGVjdXRlU2VuZCgpIHsKICAgICAgICB2YXIgaHR0cCA9IEFXUy5IdHRwQ2xpZW50LmdldEluc3RhbmNlKCk7CiAgICAgICAgdmFyIGh0dHBPcHRpb25zID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmh0dHBPcHRpb25zIHx8IHt9OwogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgc3RyZWFtID0gaHR0cC5oYW5kbGVSZXF1ZXN0KHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLCBlcnJvcik7CiAgICAgICAgICBwcm9ncmVzcyhzdHJlYW0pOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgZXJyb3IoZXJyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHRpbWVEaWZmID0gKHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkgLSB0aGlzLnNpZ25lZEF0KSAvIDEwMDA7CiAgICAgIGlmICh0aW1lRGlmZiA+PSA2MCAqIDEwKSB7IC8vIGlmIHdlIHNpZ25lZCAxMG1pbiBhZ28sIHJlLXNpZ24KICAgICAgICB0aGlzLmVtaXQoJ3NpZ24nLCBbdGhpc10sIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgaWYgKGVycikgZG9uZShlcnIpOwogICAgICAgICAgZWxzZSBleGVjdXRlU2VuZCgpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGV4ZWN1dGVTZW5kKCk7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnSFRUUF9IRUFERVJTJywgJ2h0dHBIZWFkZXJzJywKICAgICAgICBmdW5jdGlvbiBIVFRQX0hFQURFUlMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZSkgewogICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgICAgcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZSA9IHN0YXR1c01lc3NhZ2U7CiAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKCcnKTsKICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyA9IFtdOwogICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyA9IDA7CiAgICAgIHZhciBkYXRlSGVhZGVyID0gaGVhZGVycy5kYXRlIHx8IGhlYWRlcnMuRGF0ZTsKICAgICAgdmFyIHNlcnZpY2UgPSByZXNwLnJlcXVlc3Quc2VydmljZTsKICAgICAgaWYgKGRhdGVIZWFkZXIpIHsKICAgICAgICB2YXIgc2VydmVyVGltZSA9IERhdGUucGFyc2UoZGF0ZUhlYWRlcik7CiAgICAgICAgaWYgKHNlcnZpY2UuY29uZmlnLmNvcnJlY3RDbG9ja1NrZXcKICAgICAgICAgICAgJiYgc2VydmljZS5pc0Nsb2NrU2tld2VkKHNlcnZlclRpbWUpKSB7CiAgICAgICAgICBzZXJ2aWNlLmFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0hUVFBfREFUQScsICdodHRwRGF0YScsIGZ1bmN0aW9uIEhUVFBfREFUQShjaHVuaywgcmVzcCkgewogICAgICBpZiAoY2h1bmspIHsKICAgICAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkpIHsKICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzICs9IGNodW5rLmxlbmd0aDsKCiAgICAgICAgICB2YXIgdG90YWwgPSByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydjb250ZW50LWxlbmd0aCddOwogICAgICAgICAgdmFyIHByb2dyZXNzID0geyBsb2FkZWQ6IHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzLCB0b3RhbDogdG90YWwgfTsKICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFtwcm9ncmVzcywgcmVzcF0pOwogICAgICAgIH0KCiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5wdXNoKEFXUy51dGlsLmJ1ZmZlci50b0J1ZmZlcihjaHVuaykpOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0hUVFBfRE9ORScsICdodHRwRG9uZScsIGZ1bmN0aW9uIEhUVFBfRE9ORShyZXNwKSB7CiAgICAgIC8vIGNvbnZlcnQgYnVmZmVycyBhcnJheSBpbnRvIHNpbmdsZSBidWZmZXIKICAgICAgaWYgKHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgJiYgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGJvZHkgPSBBV1MudXRpbC5idWZmZXIuY29uY2F0KHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMpOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkgPSBib2R5OwogICAgICB9CiAgICAgIGRlbGV0ZSByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlczsKICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnM7CiAgICB9KTsKCiAgICBhZGQoJ0ZJTkFMSVpFX0VSUk9SJywgJ3JldHJ5JywgZnVuY3Rpb24gRklOQUxJWkVfRVJST1IocmVzcCkgewogICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IucmV0cnlhYmxlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdGhpcy5zZXJ2aWNlLnJldHJ5YWJsZUVycm9yKHJlc3AuZXJyb3IsIHRoaXMpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgYWRkKCdJTlZBTElEQVRFX0NSRURFTlRJQUxTJywgJ3JldHJ5JywgZnVuY3Rpb24gSU5WQUxJREFURV9DUkVERU5USUFMUyhyZXNwKSB7CiAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICBzd2l0Y2ggKHJlc3AuZXJyb3IuY29kZSkgewogICAgICAgIGNhc2UgJ1JlcXVlc3RFeHBpcmVkJzogLy8gRUMyIG9ubHkKICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ0V4cGlyZWRUb2tlbic6CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgICByZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuZXhwaXJlZCA9IHRydWU7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnRVhQSVJFRF9TSUdOQVRVUkUnLCAncmV0cnknLCBmdW5jdGlvbiBFWFBJUkVEX1NJR05BVFVSRShyZXNwKSB7CiAgICAgIHZhciBlcnIgPSByZXNwLmVycm9yOwogICAgICBpZiAoIWVycikgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIGVyci5jb2RlID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgZXJyLm1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaWYgKGVyci5jb2RlLm1hdGNoKC9TaWduYXR1cmUvKSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvZXhwaXJlZC8pKSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0NMT0NLX1NLRVdFRCcsICdyZXRyeScsIGZ1bmN0aW9uIENMT0NLX1NLRVdFRChyZXNwKSB7CiAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICBpZiAodGhpcy5zZXJ2aWNlLmNsb2NrU2tld0Vycm9yKHJlc3AuZXJyb3IpCiAgICAgICAgICAmJiB0aGlzLnNlcnZpY2UuY29uZmlnLmNvcnJlY3RDbG9ja1NrZXcpIHsKICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnUkVESVJFQ1QnLCAncmV0cnknLCBmdW5jdGlvbiBSRURJUkVDVChyZXNwKSB7CiAgICAgIGlmIChyZXNwLmVycm9yICYmIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA+PSAzMDAgJiYKICAgICAgICAgIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA8IDQwMCAmJiByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKSB7CiAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5lbmRwb2ludCA9CiAgICAgICAgICBuZXcgQVdTLkVuZHBvaW50KHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2xvY2F0aW9uJ10pOwogICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gdGhpcy5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0OwogICAgICAgIHJlc3AuZXJyb3IucmVkaXJlY3QgPSB0cnVlOwogICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uIFJFVFJZX0NIRUNLKHJlc3ApIHsKICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICBpZiAocmVzcC5lcnJvci5yZWRpcmVjdCAmJiByZXNwLnJlZGlyZWN0Q291bnQgPCByZXNwLm1heFJlZGlyZWN0cykgewogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gMDsKICAgICAgICB9IGVsc2UgaWYgKHJlc3AucmV0cnlDb3VudCA8IHJlc3AubWF4UmV0cmllcykgewogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gdGhpcy5zZXJ2aWNlLnJldHJ5RGVsYXlzKHJlc3AucmV0cnlDb3VudCwgcmVzcC5lcnJvcikgfHwgMDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZEFzeW5jKCdSRVNFVF9SRVRSWV9TVEFURScsICdhZnRlclJldHJ5JywgZnVuY3Rpb24gUkVTRVRfUkVUUllfU1RBVEUocmVzcCwgZG9uZSkgewogICAgICB2YXIgZGVsYXksIHdpbGxSZXRyeSA9IGZhbHNlOwoKICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICBkZWxheSA9IHJlc3AuZXJyb3IucmV0cnlEZWxheSB8fCAwOwogICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSAmJiByZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgIHJlc3AucmV0cnlDb3VudCsrOwogICAgICAgICAgd2lsbFJldHJ5ID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgIHJlc3AucmVkaXJlY3RDb3VudCsrOwogICAgICAgICAgd2lsbFJldHJ5ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIGRlbGF5IDwgMCBpcyBhIHNpZ25hbCBmcm9tIGN1c3RvbUJhY2tvZmYgdG8gc2tpcCByZXRyaWVzCiAgICAgIGlmICh3aWxsUmV0cnkgJiYgZGVsYXkgPj0gMCkgewogICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgIHNldFRpbWVvdXQoZG9uZSwgZGVsYXkpOwogICAgICB9IGVsc2UgewogICAgICAgIGRvbmUoKTsKICAgICAgfQogICAgfSk7CiAgfSksCgogIENvcmVQb3N0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RGF0YScsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwogICAgYWRkKCdFWFRSQUNUX1JFUVVFU1RfSUQnLCAnZXh0cmFjdEVycm9yJywgQVdTLnV0aWwuZXh0cmFjdFJlcXVlc3RJZCk7CgogICAgYWRkKCdFTk9URk9VTkRfRVJST1InLCAnaHR0cEVycm9yJywgZnVuY3Rpb24gRU5PVEZPVU5EX0VSUk9SKGVycikgewogICAgICBmdW5jdGlvbiBpc0ROU0Vycm9yKGVycikgewogICAgICAgIHJldHVybiBlcnIuZXJybm8gPT09ICdFTk9URk9VTkQnIHx8CiAgICAgICAgICB0eXBlb2YgZXJyLmVycm5vID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgdHlwZW9mIEFXUy51dGlsLmdldFN5c3RlbUVycm9yTmFtZSA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgICAgWydFQUlfTk9OQU1FJywgJ0VBSV9OT0RBVEEnXS5pbmRleE9mKEFXUy51dGlsLmdldFN5c3RlbUVycm9yTmFtZShlcnIuZXJybm8pID49IDApOwogICAgICB9CiAgICAgIGlmIChlcnIuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcicgJiYgaXNETlNFcnJvcihlcnIpKSB7CiAgICAgICAgdmFyIG1lc3NhZ2UgPSAnSW5hY2Nlc3NpYmxlIGhvc3Q6IGAnICsgZXJyLmhvc3RuYW1lICsgJ1wnIGF0IHBvcnQgYCcgKyBlcnIucG9ydCArCiAgICAgICAgICAnXCcuIFRoaXMgc2VydmljZSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpbiB0aGUgYCcgKyBlcnIucmVnaW9uICsKICAgICAgICAgICdcJyByZWdpb24uJzsKICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpLCB7CiAgICAgICAgICBjb2RlOiAnVW5rbm93bkVuZHBvaW50JywKICAgICAgICAgIHJlZ2lvbjogZXJyLnJlZ2lvbiwKICAgICAgICAgIGhvc3RuYW1lOiBlcnIuaG9zdG5hbWUsCiAgICAgICAgICByZXRyeWFibGU6IHRydWUsCiAgICAgICAgICBvcmlnaW5hbEVycm9yOiBlcnIKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfSksCgogIExvZ2dlcjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgYWRkKCdMT0dfUkVRVUVTVCcsICdjb21wbGV0ZScsIGZ1bmN0aW9uIExPR19SRVFVRVNUKHJlc3ApIHsKICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgdmFyIGxvZ2dlciA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5sb2dnZXI7CiAgICAgIGlmICghbG9nZ2VyKSByZXR1cm47CiAgICAgIGZ1bmN0aW9uIGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCBzaGFwZSkgewogICAgICAgIGlmICghc2hhcGUpIHsKICAgICAgICAgIHJldHVybiBzaGFwZTsKICAgICAgICB9CiAgICAgICAgaWYgKGlucHV0U2hhcGUuaXNTZW5zaXRpdmUpIHsKICAgICAgICAgIHJldHVybiAnKioqU2Vuc2l0aXZlSW5mb3JtYXRpb24qKionOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKGlucHV0U2hhcGUudHlwZSkgewogICAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgICAgdmFyIHN0cnVjdCA9IHt9OwogICAgICAgICAgICBBV1MudXRpbC5lYWNoKHNoYXBlLCBmdW5jdGlvbihzdWJTaGFwZU5hbWUsIHN1YlNoYXBlKSB7CiAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpbnB1dFNoYXBlLm1lbWJlcnMsIHN1YlNoYXBlTmFtZSkpIHsKICAgICAgICAgICAgICAgIHN0cnVjdFtzdWJTaGFwZU5hbWVdID0gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUubWVtYmVyc1tzdWJTaGFwZU5hbWVdLCBzdWJTaGFwZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0cnVjdFtzdWJTaGFwZU5hbWVdID0gc3ViU2hhcGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHN0cnVjdDsKICAgICAgICAgIGNhc2UgJ2xpc3QnOgogICAgICAgICAgICB2YXIgbGlzdCA9IFtdOwogICAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2hhcGUsIGZ1bmN0aW9uKHN1YlNoYXBlLCBpbmRleCkgewogICAgICAgICAgICAgIGxpc3QucHVzaChmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS5tZW1iZXIsIHN1YlNoYXBlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgIGNhc2UgJ21hcCc6CiAgICAgICAgICAgIHZhciBtYXAgPSB7fTsKICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgIG1hcFtrZXldID0gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUudmFsdWUsIHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBidWlsZE1lc3NhZ2UoKSB7CiAgICAgICAgdmFyIHRpbWUgPSByZXNwLnJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICB2YXIgZGVsdGEgPSAodGltZSAtIHJlcS5zdGFydFRpbWUuZ2V0VGltZSgpKSAvIDEwMDA7CiAgICAgICAgdmFyIGFuc2kgPSBsb2dnZXIuaXNUVFkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgdmFyIHN0YXR1cyA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgdmFyIGNlbnNvcmVkUGFyYW1zID0gcmVxLnBhcmFtczsKICAgICAgICBpZiAoCiAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucyAmJgogICAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dICYmCiAgICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQKICAgICAgICApIHsKICAgICAgICAgIHZhciBpbnB1dFNoYXBlID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICAgICAgICBjZW5zb3JlZFBhcmFtcyA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCByZXEucGFyYW1zKTsKICAgICAgICB9CiAgICAgICAgdmFyIHBhcmFtcyA9IHJlcXVpcmUoJ3V0aWwnKS5pbnNwZWN0KGNlbnNvcmVkUGFyYW1zLCB0cnVlLCBudWxsKTsKICAgICAgICB2YXIgbWVzc2FnZSA9ICcnOwogICAgICAgIGlmIChhbnNpKSBtZXNzYWdlICs9ICdceDFCWzMzbSc7CiAgICAgICAgbWVzc2FnZSArPSAnW0FXUyAnICsgcmVxLnNlcnZpY2Uuc2VydmljZUlkZW50aWZpZXIgKyAnICcgKyBzdGF0dXM7CiAgICAgICAgbWVzc2FnZSArPSAnICcgKyBkZWx0YS50b1N0cmluZygpICsgJ3MgJyArIHJlc3AucmV0cnlDb3VudCArICcgcmV0cmllc10nOwogICAgICAgIGlmIChhbnNpKSBtZXNzYWdlICs9ICdceDFCWzA7MW0nOwogICAgICAgIG1lc3NhZ2UgKz0gJyAnICsgQVdTLnV0aWwuc3RyaW5nLmxvd2VyRmlyc3QocmVxLm9wZXJhdGlvbik7CiAgICAgICAgbWVzc2FnZSArPSAnKCcgKyBwYXJhbXMgKyAnKSc7CiAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMG0nOwogICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICB9CgogICAgICB2YXIgbGluZSA9IGJ1aWxkTWVzc2FnZSgpOwogICAgICBpZiAodHlwZW9mIGxvZ2dlci5sb2cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBsb2dnZXIubG9nKGxpbmUpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBsb2dnZXIud3JpdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBsb2dnZXIud3JpdGUobGluZSArICdcbicpOwogICAgICB9CiAgICB9KTsKICB9KSwKCiAgSnNvbjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpOwogICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogIH0pLAoKICBSZXN0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0Jyk7CiAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgfSksCgogIFJlc3RKc29uOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X2pzb24nKTsKICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICB9KSwKCiAgUmVzdFhtbDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKTsKICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICB9KSwKCiAgUXVlcnk6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3F1ZXJ5Jyk7CiAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgfSkKfTsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vY29yZSI6MTksIi4vZGlzY292ZXJfZW5kcG9pbnQiOjI3LCIuL3Byb3RvY29sL2pzb24iOjQ3LCIuL3Byb3RvY29sL3F1ZXJ5Ijo0OCwiLi9wcm90b2NvbC9yZXN0Ijo0OSwiLi9wcm90b2NvbC9yZXN0X2pzb24iOjUwLCIuL3Byb3RvY29sL3Jlc3RfeG1sIjo1MSwiLi9zZXF1ZW50aWFsX2V4ZWN1dG9yIjo2MCwiX3Byb2Nlc3MiOjkwLCJ1dGlsIjo4NH1dLDM1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgovKioKICogVGhlIGVuZHBvaW50IHRoYXQgYSBzZXJ2aWNlIHdpbGwgdGFsayB0bywgZm9yIGV4YW1wbGUsCiAqIGAnaHR0cHM6Ly9lYzIuYXAtc291dGhlYXN0LTEuYW1hem9uYXdzLmNvbSdgLiBJZgogKiB5b3UgbmVlZCB0byBvdmVycmlkZSBhbiBlbmRwb2ludCBmb3IgYSBzZXJ2aWNlLCB5b3UgY2FuCiAqIHNldCB0aGUgZW5kcG9pbnQgb24gYSBzZXJ2aWNlIGJ5IHBhc3NpbmcgdGhlIGVuZHBvaW50CiAqIG9iamVjdCB3aXRoIHRoZSBgZW5kcG9pbnRgIG9wdGlvbiBrZXk6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogdmFyIGVwID0gbmV3IEFXUy5FbmRwb2ludCgnYXdzcHJveHkuZXhhbXBsZS5jb20nKTsKICogdmFyIHMzID0gbmV3IEFXUy5TMyh7ZW5kcG9pbnQ6IGVwfSk7CiAqIHMzLnNlcnZpY2UuZW5kcG9pbnQuaG9zdG5hbWUgPT0gJ2F3c3Byb3h5LmV4YW1wbGUuY29tJwogKiBgYGAKICoKICogTm90ZSB0aGF0IGlmIHlvdSBkbyBub3Qgc3BlY2lmeSBhIHByb3RvY29sLCB0aGUgcHJvdG9jb2wgd2lsbAogKiBiZSBzZWxlY3RlZCBiYXNlZCBvbiB5b3VyIGN1cnJlbnQge0FXUy5jb25maWd9IGNvbmZpZ3VyYXRpb24uCiAqCiAqIEAhYXR0cmlidXRlIHByb3RvY29sCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpIG9mIHRoZSBlbmRwb2ludAogKiAgICAgVVJMCiAqIEAhYXR0cmlidXRlIGhvc3RuYW1lCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgaG9zdCBwb3J0aW9uIG9mIHRoZSBlbmRwb2ludCwgZS5nLiwKICogICAgIGV4YW1wbGUuY29tCiAqIEAhYXR0cmlidXRlIGhvc3QKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50IGluY2x1ZGluZwogKiAgICAgdGhlIHBvcnQsIGUuZy4sIGV4YW1wbGUuY29tOjgwCiAqIEAhYXR0cmlidXRlIHBvcnQKICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgcG9ydCBvZiB0aGUgZW5kcG9pbnQKICogQCFhdHRyaWJ1dGUgaHJlZgogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGZ1bGwgVVJMIG9mIHRoZSBlbmRwb2ludAogKi8KQVdTLkVuZHBvaW50ID0gaW5oZXJpdCh7CgogIC8qKgogICAqIEBvdmVybG9hZCBFbmRwb2ludChlbmRwb2ludCkKICAgKiAgIENvbnN0cnVjdHMgYSBuZXcgZW5kcG9pbnQgZ2l2ZW4gYW4gZW5kcG9pbnQgVVJMLiBJZiB0aGUKICAgKiAgIFVSTCBvbWl0cyBhIHByb3RvY29sIChodHRwIG9yIGh0dHBzKSwgdGhlIGRlZmF1bHQgcHJvdG9jb2wKICAgKiAgIHNldCBpbiB0aGUgZ2xvYmFsIHtBV1MuY29uZmlnfSB3aWxsIGJlIHVzZWQuCiAgICogICBAcGFyYW0gZW5kcG9pbnQgW1N0cmluZ10gdGhlIFVSTCB0byBjb25zdHJ1Y3QgYW4gZW5kcG9pbnQgZnJvbQogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBFbmRwb2ludChlbmRwb2ludCwgY29uZmlnKSB7CiAgICBBV1MudXRpbC5oaWRlUHJvcGVydGllcyh0aGlzLCBbJ3NsYXNoZXMnLCAnYXV0aCcsICdoYXNoJywgJ3NlYXJjaCcsICdxdWVyeSddKTsKCiAgICBpZiAodHlwZW9mIGVuZHBvaW50ID09PSAndW5kZWZpbmVkJyB8fCBlbmRwb2ludCA9PT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW5kcG9pbnQ6ICcgKyBlbmRwb2ludCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNvcHkoZW5kcG9pbnQpOwogICAgfQoKICAgIGlmICghZW5kcG9pbnQubWF0Y2goL15odHRwLykpIHsKICAgICAgdmFyIHVzZVNTTCA9IGNvbmZpZyAmJiBjb25maWcuc3NsRW5hYmxlZCAhPT0gdW5kZWZpbmVkID8KICAgICAgICBjb25maWcuc3NsRW5hYmxlZCA6IEFXUy5jb25maWcuc3NsRW5hYmxlZDsKICAgICAgZW5kcG9pbnQgPSAodXNlU1NMID8gJ2h0dHBzJyA6ICdodHRwJykgKyAnOi8vJyArIGVuZHBvaW50OwogICAgfQoKICAgIEFXUy51dGlsLnVwZGF0ZSh0aGlzLCBBV1MudXRpbC51cmxQYXJzZShlbmRwb2ludCkpOwoKICAgIC8vIEVuc3VyZSB0aGUgcG9ydCBwcm9wZXJ0eSBpcyBzZXQgYXMgYW4gaW50ZWdlcgogICAgaWYgKHRoaXMucG9ydCkgewogICAgICB0aGlzLnBvcnQgPSBwYXJzZUludCh0aGlzLnBvcnQsIDEwKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucG9ydCA9IHRoaXMucHJvdG9jb2wgPT09ICdodHRwczonID8gNDQzIDogODA7CiAgICB9CiAgfQoKfSk7CgovKioKICogVGhlIGxvdyBsZXZlbCBIVFRQIHJlcXVlc3Qgb2JqZWN0LCBlbmNhcHN1bGF0aW5nIGFsbCBIVFRQIGhlYWRlcgogKiBhbmQgYm9keSBkYXRhIHNlbnQgYnkgYSBzZXJ2aWNlIHJlcXVlc3QuCiAqCiAqIEAhYXR0cmlidXRlIG1ldGhvZAogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEhUVFAgbWV0aG9kIG9mIHRoZSByZXF1ZXN0CiAqIEAhYXR0cmlidXRlIHBhdGgKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXRoIHBvcnRpb24gb2YgdGhlIFVSSSwgZS5nLiwKICogICAgICIvbGlzdC8/c3RhcnQ9NSZudW09MTAiCiAqIEAhYXR0cmlidXRlIGhlYWRlcnMKICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAqICAgICBhIG1hcCBvZiBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICogQCFhdHRyaWJ1dGUgYm9keQogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlcXVlc3QgYm9keSBwYXlsb2FkCiAqIEAhYXR0cmlidXRlIGVuZHBvaW50CiAqICAgQHJldHVybiBbQVdTLkVuZHBvaW50XSB0aGUgZW5kcG9pbnQgZm9yIHRoZSByZXF1ZXN0CiAqIEAhYXR0cmlidXRlIHJlZ2lvbgogKiAgIEBhcGkgcHJpdmF0ZQogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlZ2lvbiwgZm9yIHNpZ25pbmcgcHVycG9zZXMgb25seS4KICovCkFXUy5IdHRwUmVxdWVzdCA9IGluaGVyaXQoewoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlcXVlc3QoZW5kcG9pbnQsIHJlZ2lvbikgewogICAgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgIHRoaXMubWV0aG9kID0gJ1BPU1QnOwogICAgdGhpcy5wYXRoID0gZW5kcG9pbnQucGF0aCB8fCAnLyc7CiAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgIHRoaXMuYm9keSA9ICcnOwogICAgdGhpcy5lbmRwb2ludCA9IGVuZHBvaW50OwogICAgdGhpcy5yZWdpb24gPSByZWdpb247CiAgICB0aGlzLl91c2VyQWdlbnQgPSAnJzsKICAgIHRoaXMuc2V0VXNlckFnZW50KCk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2V0VXNlckFnZW50OiBmdW5jdGlvbiBzZXRVc2VyQWdlbnQoKSB7CiAgICB0aGlzLl91c2VyQWdlbnQgPSB0aGlzLmhlYWRlcnNbdGhpcy5nZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCldID0gQVdTLnV0aWwudXNlckFnZW50KCk7CiAgfSwKCiAgZ2V0VXNlckFnZW50SGVhZGVyTmFtZTogZnVuY3Rpb24gZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpIHsKICAgIHZhciBwcmVmaXggPSBBV1MudXRpbC5pc0Jyb3dzZXIoKSA/ICdYLUFtei0nIDogJyc7CiAgICByZXR1cm4gcHJlZml4ICsgJ1VzZXItQWdlbnQnOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFwcGVuZFRvVXNlckFnZW50OiBmdW5jdGlvbiBhcHBlbmRUb1VzZXJBZ2VudChhZ2VudFBhcnRpYWwpIHsKICAgIGlmICh0eXBlb2YgYWdlbnRQYXJ0aWFsID09PSAnc3RyaW5nJyAmJiBhZ2VudFBhcnRpYWwpIHsKICAgICAgdGhpcy5fdXNlckFnZW50ICs9ICcgJyArIGFnZW50UGFydGlhbDsKICAgIH0KICAgIHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSB0aGlzLl91c2VyQWdlbnQ7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0VXNlckFnZW50OiBmdW5jdGlvbiBnZXRVc2VyQWdlbnQoKSB7CiAgICByZXR1cm4gdGhpcy5fdXNlckFnZW50OwogIH0sCgogIC8qKgogICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIHBhcnQgb2YgdGhlIHtwYXRofSBleGNsdWRpbmcgdGhlCiAgICogICBxdWVyeSBzdHJpbmcKICAgKi8KICBwYXRobmFtZTogZnVuY3Rpb24gcGF0aG5hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCc/JywgMSlbMF07CiAgfSwKCiAgLyoqCiAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgcXVlcnkgc3RyaW5nIHBvcnRpb24gb2YgdGhlIHtwYXRofQogICAqLwogIHNlYXJjaDogZnVuY3Rpb24gc2VhcmNoKCkgewogICAgdmFyIHF1ZXJ5ID0gdGhpcy5wYXRoLnNwbGl0KCc/JywgMilbMV07CiAgICBpZiAocXVlcnkpIHsKICAgICAgcXVlcnkgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHF1ZXJ5KTsKICAgICAgcmV0dXJuIEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXVlcnkpOwogICAgfQogICAgcmV0dXJuICcnOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIHVwZGF0ZSBodHRwUmVxdWVzdCBlbmRwb2ludCB3aXRoIGVuZHBvaW50IHN0cmluZwogICAqLwogIHVwZGF0ZUVuZHBvaW50OiBmdW5jdGlvbiB1cGRhdGVFbmRwb2ludChlbmRwb2ludFN0cikgewogICAgdmFyIG5ld0VuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludFN0cik7CiAgICB0aGlzLmVuZHBvaW50ID0gbmV3RW5kcG9pbnQ7CiAgICB0aGlzLnBhdGggPSBuZXdFbmRwb2ludC5wYXRoIHx8ICcvJzsKICAgIGlmICh0aGlzLmhlYWRlcnNbJ0hvc3QnXSkgewogICAgICB0aGlzLmhlYWRlcnNbJ0hvc3QnXSA9IG5ld0VuZHBvaW50Lmhvc3Q7CiAgICB9CiAgfQp9KTsKCi8qKgogKiBUaGUgbG93IGxldmVsIEhUVFAgcmVzcG9uc2Ugb2JqZWN0LCBlbmNhcHN1bGF0aW5nIGFsbCBIVFRQIGhlYWRlcgogKiBhbmQgYm9keSBkYXRhIHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAqCiAqIEAhYXR0cmlidXRlIHN0YXR1c0NvZGUKICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UgKGUuZy4sIDIwMCwgNDA0KQogKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAqICAgQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XQogKiAgICAgIGEgbWFwIG9mIHJlc3BvbnNlIGhlYWRlciBrZXlzIGFuZCB0aGVpciByZXNwZWN0aXZlIHZhbHVlcwogKiBAIWF0dHJpYnV0ZSBib2R5CiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVzcG9uc2UgYm9keSBwYXlsb2FkCiAqIEAhYXR0cmlidXRlIFtyXSBzdHJlYW1pbmcKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoaXMgcmVzcG9uc2UgaXMgYmVpbmcgc3RyZWFtZWQgYXQgYSBsb3ctbGV2ZWwuCiAqICAgICBEZWZhdWx0cyB0byBgZmFsc2VgIChidWZmZXJlZCByZWFkcykuIERvIG5vdCBtb2RpZnkgdGhpcyBtYW51YWxseSwgdXNlCiAqICAgICB7Y3JlYXRlVW5idWZmZXJlZFN0cmVhbX0gdG8gY29udmVydCB0aGUgc3RyZWFtIHRvIHVuYnVmZmVyZWQgbW9kZQogKiAgICAgaW5zdGVhZC4KICovCkFXUy5IdHRwUmVzcG9uc2UgPSBpbmhlcml0KHsKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEh0dHBSZXNwb25zZSgpIHsKICAgIHRoaXMuc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgdGhpcy5ib2R5ID0gdW5kZWZpbmVkOwogICAgdGhpcy5zdHJlYW1pbmcgPSBmYWxzZTsKICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICB9LAoKICAvKioKICAgKiBEaXNhYmxlcyBidWZmZXJpbmcgb24gdGhlIEhUVFAgcmVzcG9uc2UgYW5kIHJldHVybnMgdGhlIHN0cmVhbSBmb3IgcmVhZGluZy4KICAgKiBAcmV0dXJuIFtTdHJlYW0sIFhNTEh0dHBSZXF1ZXN0LCBudWxsXSB0aGUgdW5kZXJseWluZyBzdHJlYW0gb2JqZWN0LgogICAqICAgVXNlIHRoaXMgb2JqZWN0IHRvIGRpcmVjdGx5IHJlYWQgZGF0YSBvZmYgb2YgdGhlIHN0cmVhbS4KICAgKiBAbm90ZSBUaGlzIG9iamVjdCBpcyBvbmx5IGF2YWlsYWJsZSBhZnRlciB0aGUge0FXUy5SZXF1ZXN0fmh0dHBIZWFkZXJzfQogICAqICAgZXZlbnQgaGFzIGZpcmVkLiBUaGlzIG1ldGhvZCBtdXN0IGJlIGNhbGxlZCBwcmlvciB0bwogICAqICAge0FXUy5SZXF1ZXN0fmh0dHBEYXRhfS4KICAgKiBAZXhhbXBsZSBUYWtpbmcgY29udHJvbCBvZiBhIHN0cmVhbQogICAqICAgcmVxdWVzdC5vbignaHR0cEhlYWRlcnMnLCBmdW5jdGlvbihzdGF0dXNDb2RlLCBoZWFkZXJzKSB7CiAgICogICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICogICAgICAgaWYgKGhlYWRlcnMuZXRhZyA9PT0gJ3h5eicpIHsKICAgKiAgICAgICAgIC8vIHBpcGUgdGhlIHN0cmVhbSwgZGlzYWJsaW5nIGJ1ZmZlcmluZwogICAqICAgICAgICAgdmFyIHN0cmVhbSA9IHRoaXMucmVzcG9uc2UuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAgKiAgICAgICAgIHN0cmVhbS5waXBlKHByb2Nlc3Muc3Rkb3V0KTsKICAgKiAgICAgICB9IGVsc2UgeyAvLyBhYm9ydCB0aGlzIHJlcXVlc3QgYW5kIHNldCBhIGJldHRlciBlcnJvciBtZXNzYWdlCiAgICogICAgICAgICB0aGlzLmFib3J0KCk7CiAgICogICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gbmV3IEVycm9yKCdJbnZhbGlkIEVUYWcnKTsKICAgKiAgICAgICB9CiAgICogICAgIH0KICAgKiAgIH0pLnNlbmQoY29uc29sZS5sb2cpOwogICAqLwogIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKSB7CiAgICB0aGlzLnN0cmVhbWluZyA9IHRydWU7CiAgICByZXR1cm4gdGhpcy5zdHJlYW07CiAgfQp9KTsKCgpBV1MuSHR0cENsaWVudCA9IGluaGVyaXQoe30pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbiBnZXRJbnN0YW5jZSgpIHsKICBpZiAodGhpcy5zaW5nbGV0b24gPT09IHVuZGVmaW5lZCkgewogICAgdGhpcy5zaW5nbGV0b24gPSBuZXcgdGhpcygpOwogIH0KICByZXR1cm4gdGhpcy5zaW5nbGV0b247Cn07Cgp9LHsiLi9jb3JlIjoxOX1dLDM2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKcmVxdWlyZSgnLi4vaHR0cCcpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlhIUkNsaWVudCA9IEFXUy51dGlsLmluaGVyaXQoewogIGhhbmRsZVJlcXVlc3Q6IGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3QoaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLCBjYWxsYmFjaywgZXJyQ2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBlbmRwb2ludCA9IGh0dHBSZXF1ZXN0LmVuZHBvaW50OwogICAgdmFyIGVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7CiAgICB2YXIgaHJlZiA9IGVuZHBvaW50LnByb3RvY29sICsgJy8vJyArIGVuZHBvaW50Lmhvc3RuYW1lOwogICAgaWYgKGVuZHBvaW50LnBvcnQgIT09IDgwICYmIGVuZHBvaW50LnBvcnQgIT09IDQ0MykgewogICAgICBocmVmICs9ICc6JyArIGVuZHBvaW50LnBvcnQ7CiAgICB9CiAgICBocmVmICs9IGh0dHBSZXF1ZXN0LnBhdGg7CgogICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpLCBoZWFkZXJzRW1pdHRlZCA9IGZhbHNlOwogICAgaHR0cFJlcXVlc3Quc3RyZWFtID0geGhyOwoKICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDApIHJldHVybjsgLy8gMCBjb2RlIGlzIGludmFsaWQKICAgICAgfSBjYXRjaCAoZSkgeyByZXR1cm47IH0KCiAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPj0gdGhpcy5IRUFERVJTX1JFQ0VJVkVEICYmICFoZWFkZXJzRW1pdHRlZCkgewogICAgICAgIGVtaXR0ZXIuc3RhdHVzQ29kZSA9IHhoci5zdGF0dXM7CiAgICAgICAgZW1pdHRlci5oZWFkZXJzID0gc2VsZi5wYXJzZUhlYWRlcnMoeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKTsKICAgICAgICBlbWl0dGVyLmVtaXQoCiAgICAgICAgICAnaGVhZGVycycsCiAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUsCiAgICAgICAgICBlbWl0dGVyLmhlYWRlcnMsCiAgICAgICAgICB4aHIuc3RhdHVzVGV4dAogICAgICAgICk7CiAgICAgICAgaGVhZGVyc0VtaXR0ZWQgPSB0cnVlOwogICAgICB9CiAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IHRoaXMuRE9ORSkgewogICAgICAgIHNlbGYuZmluaXNoUmVxdWVzdCh4aHIsIGVtaXR0ZXIpOwogICAgICB9CiAgICB9LCBmYWxzZSk7CiAgICB4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2dCkgewogICAgICBlbWl0dGVyLmVtaXQoJ3NlbmRQcm9ncmVzcycsIGV2dCk7CiAgICB9KTsKICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgZW1pdHRlci5lbWl0KCdyZWNlaXZlUHJvZ3Jlc3MnLCBldnQpOwogICAgfSwgZmFsc2UpOwogICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3RpbWVvdXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignVGltZW91dCcpLCB7Y29kZTogJ1RpbWVvdXRFcnJvcid9KSk7CiAgICB9LCBmYWxzZSk7CiAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCBmdW5jdGlvbiAoKSB7CiAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignTmV0d29yayBGYWlsdXJlJyksIHsKICAgICAgICBjb2RlOiAnTmV0d29ya2luZ0Vycm9yJwogICAgICB9KSk7CiAgICB9LCBmYWxzZSk7CiAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignUmVxdWVzdCBhYm9ydGVkJyksIHsKICAgICAgICBjb2RlOiAnUmVxdWVzdEFib3J0ZWRFcnJvcicKICAgICAgfSkpOwogICAgfSwgZmFsc2UpOwoKICAgIGNhbGxiYWNrKGVtaXR0ZXIpOwogICAgeGhyLm9wZW4oaHR0cFJlcXVlc3QubWV0aG9kLCBocmVmLCBodHRwT3B0aW9ucy54aHJBc3luYyAhPT0gZmFsc2UpOwogICAgQVdTLnV0aWwuZWFjaChodHRwUmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICBpZiAoa2V5ICE9PSAnQ29udGVudC1MZW5ndGgnICYmIGtleSAhPT0gJ1VzZXItQWdlbnQnICYmIGtleSAhPT0gJ0hvc3QnKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGlmIChodHRwT3B0aW9ucy50aW1lb3V0ICYmIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSkgewogICAgICB4aHIudGltZW91dCA9IGh0dHBPcHRpb25zLnRpbWVvdXQ7CiAgICB9CgogICAgaWYgKGh0dHBPcHRpb25zLnhocldpdGhDcmVkZW50aWFscykgewogICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgIH0KICAgIHRyeSB7IHhoci5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInOyB9IGNhdGNoIChlKSB7fQoKICAgIHRyeSB7CiAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5KSB7CiAgICAgICAgeGhyLnNlbmQoaHR0cFJlcXVlc3QuYm9keSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgeGhyLnNlbmQoKTsKICAgICAgfQogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5ICYmIHR5cGVvZiBodHRwUmVxdWVzdC5ib2R5LmJ1ZmZlciA9PT0gJ29iamVjdCcpIHsKICAgICAgICB4aHIuc2VuZChodHRwUmVxdWVzdC5ib2R5LmJ1ZmZlcik7IC8vIHNlbmQgQXJyYXlCdWZmZXIgZGlyZWN0bHkKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBlcnI7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZW1pdHRlcjsKICB9LAoKICBwYXJzZUhlYWRlcnM6IGZ1bmN0aW9uIHBhcnNlSGVhZGVycyhyYXdIZWFkZXJzKSB7CiAgICB2YXIgaGVhZGVycyA9IHt9OwogICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJhd0hlYWRlcnMuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgIHZhciBrZXkgPSBsaW5lLnNwbGl0KCc6JywgMSlbMF07CiAgICAgIHZhciB2YWx1ZSA9IGxpbmUuc3Vic3RyaW5nKGtleS5sZW5ndGggKyAyKTsKICAgICAgaWYgKGtleS5sZW5ndGggPiAwKSBoZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gaGVhZGVyczsKICB9LAoKICBmaW5pc2hSZXF1ZXN0OiBmdW5jdGlvbiBmaW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcikgewogICAgdmFyIGJ1ZmZlcjsKICAgIGlmICh4aHIucmVzcG9uc2VUeXBlID09PSAnYXJyYXlidWZmZXInICYmIHhoci5yZXNwb25zZSkgewogICAgICB2YXIgYWIgPSB4aHIucmVzcG9uc2U7CiAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoYWIuYnl0ZUxlbmd0aCk7CiAgICAgIHZhciB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYWIpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7ICsraSkgewogICAgICAgIGJ1ZmZlcltpXSA9IHZpZXdbaV07CiAgICAgIH0KICAgIH0KCiAgICB0cnkgewogICAgICBpZiAoIWJ1ZmZlciAmJiB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBidWZmZXIgPSBuZXcgQVdTLnV0aWwuQnVmZmVyKHhoci5yZXNwb25zZVRleHQpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7fQoKICAgIGlmIChidWZmZXIpIGVtaXR0ZXIuZW1pdCgnZGF0YScsIGJ1ZmZlcik7CiAgICBlbWl0dGVyLmVtaXQoJ2VuZCcpOwogIH0KfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuSHR0cENsaWVudC5wcm90b3R5cGUgPSBBV1MuWEhSQ2xpZW50LnByb3RvdHlwZTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID0gMTsKCn0seyIuLi9jb3JlIjoxOSwiLi4vaHR0cCI6MzUsImV2ZW50cyI6ODZ9XSwzNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKZnVuY3Rpb24gSnNvbkJ1aWxkZXIoKSB7IH0KCkpzb25CdWlsZGVyLnByb3RvdHlwZS5idWlsZCA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogIHJldHVybiBKU09OLnN0cmluZ2lmeSh0cmFuc2xhdGUodmFsdWUsIHNoYXBlKSk7Cn07CgpmdW5jdGlvbiB0cmFuc2xhdGUodmFsdWUsIHNoYXBlKSB7CiAgaWYgKCFzaGFwZSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwoKICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiB0cmFuc2xhdGVTdHJ1Y3R1cmUodmFsdWUsIHNoYXBlKTsKICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gdHJhbnNsYXRlTGlzdCh2YWx1ZSwgc2hhcGUpOwogICAgZGVmYXVsdDogcmV0dXJuIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpOwogIH0KfQoKZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICBpZiAoc2hhcGUuaXNEb2N1bWVudCkgewogICAgcmV0dXJuIHN0cnVjdHVyZTsKICB9CiAgdmFyIHN0cnVjdCA9IHt9OwogIHV0aWwuZWFjaChzdHJ1Y3R1cmUsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW25hbWVdOwogICAgaWYgKG1lbWJlclNoYXBlKSB7CiAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W2xvY2F0aW9uTmFtZV0gPSByZXN1bHQ7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHN0cnVjdDsKfQoKZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogIHZhciBvdXQgPSBbXTsKICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgb3V0LnB1c2gocmVzdWx0KTsKICB9KTsKICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiB0cmFuc2xhdGVNYXAobWFwLCBzaGFwZSkgewogIHZhciBvdXQgPSB7fTsKICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIG91dFtrZXldID0gcmVzdWx0OwogIH0pOwogIHJldHVybiBvdXQ7Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICByZXR1cm4gc2hhcGUudG9XaXJlRm9ybWF0KHZhbHVlKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBKc29uQnVpbGRlcjsKCn0seyIuLi91dGlsIjo3Mn1dLDM4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CgpmdW5jdGlvbiBKc29uUGFyc2VyKCkgeyB9CgpKc29uUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogIHJldHVybiB0cmFuc2xhdGUoSlNPTi5wYXJzZSh2YWx1ZSksIHNoYXBlKTsKfTsKCmZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICBpZiAoIXNoYXBlIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiB1bmRlZmluZWQ7CgogIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHRyYW5zbGF0ZVN0cnVjdHVyZSh2YWx1ZSwgc2hhcGUpOwogICAgY2FzZSAnbWFwJzogcmV0dXJuIHRyYW5zbGF0ZU1hcCh2YWx1ZSwgc2hhcGUpOwogICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICBkZWZhdWx0OiByZXR1cm4gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSk7CiAgfQp9CgpmdW5jdGlvbiB0cmFuc2xhdGVTdHJ1Y3R1cmUoc3RydWN0dXJlLCBzaGFwZSkgewogIGlmIChzdHJ1Y3R1cmUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICBpZiAoc2hhcGUuaXNEb2N1bWVudCkgcmV0dXJuIHN0cnVjdHVyZTsKCiAgdmFyIHN0cnVjdCA9IHt9OwogIHZhciBzaGFwZU1lbWJlcnMgPSBzaGFwZS5tZW1iZXJzOwogIHV0aWwuZWFjaChzaGFwZU1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlclNoYXBlKSB7CiAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3RydWN0dXJlLCBsb2NhdGlvbk5hbWUpKSB7CiAgICAgIHZhciB2YWx1ZSA9IHN0cnVjdHVyZVtsb2NhdGlvbk5hbWVdOwogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W25hbWVdID0gcmVzdWx0OwogICAgfQogIH0pOwogIHJldHVybiBzdHJ1Y3Q7Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZUxpc3QobGlzdCwgc2hhcGUpIHsKICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwoKICB2YXIgb3V0ID0gW107CiAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dC5wdXNoKG51bGwpOwogICAgZWxzZSBvdXQucHVzaChyZXN1bHQpOwogIH0pOwogIHJldHVybiBvdXQ7Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgaWYgKG1hcCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwoKICB2YXIgb3V0ID0ge307CiAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IG51bGw7CiAgICBlbHNlIG91dFtrZXldID0gcmVzdWx0OwogIH0pOwogIHJldHVybiBvdXQ7Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICByZXR1cm4gc2hhcGUudG9UeXBlKHZhbHVlKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBKc29uUGFyc2VyOwoKfSx7Ii4uL3V0aWwiOjcyfV0sMzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwp2YXIgT3BlcmF0aW9uID0gcmVxdWlyZSgnLi9vcGVyYXRpb24nKTsKdmFyIFNoYXBlID0gcmVxdWlyZSgnLi9zaGFwZScpOwp2YXIgUGFnaW5hdG9yID0gcmVxdWlyZSgnLi9wYWdpbmF0b3InKTsKdmFyIFJlc291cmNlV2FpdGVyID0gcmVxdWlyZSgnLi9yZXNvdXJjZV93YWl0ZXInKTsKdmFyIG1ldGFkYXRhID0gcmVxdWlyZSgnLi4vLi4vYXBpcy9tZXRhZGF0YS5qc29uJyk7Cgp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKdmFyIG1lbW9pemVkUHJvcGVydHkgPSB1dGlsLm1lbW9pemVkUHJvcGVydHk7CgpmdW5jdGlvbiBBcGkoYXBpLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIGFwaSA9IGFwaSB8fCB7fTsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBvcHRpb25zLmFwaSA9IHRoaXM7CgogIGFwaS5tZXRhZGF0YSA9IGFwaS5tZXRhZGF0YSB8fCB7fTsKCiAgdmFyIHNlcnZpY2VJZGVudGlmaWVyID0gb3B0aW9ucy5zZXJ2aWNlSWRlbnRpZmllcjsKICBkZWxldGUgb3B0aW9ucy5zZXJ2aWNlSWRlbnRpZmllcjsKCiAgcHJvcGVydHkodGhpcywgJ2lzQXBpJywgdHJ1ZSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdhcGlWZXJzaW9uJywgYXBpLm1ldGFkYXRhLmFwaVZlcnNpb24pOwogIHByb3BlcnR5KHRoaXMsICdlbmRwb2ludFByZWZpeCcsIGFwaS5tZXRhZGF0YS5lbmRwb2ludFByZWZpeCk7CiAgcHJvcGVydHkodGhpcywgJ3NpZ25pbmdOYW1lJywgYXBpLm1ldGFkYXRhLnNpZ25pbmdOYW1lKTsKICBwcm9wZXJ0eSh0aGlzLCAnZ2xvYmFsRW5kcG9pbnQnLCBhcGkubWV0YWRhdGEuZ2xvYmFsRW5kcG9pbnQpOwogIHByb3BlcnR5KHRoaXMsICdzaWduYXR1cmVWZXJzaW9uJywgYXBpLm1ldGFkYXRhLnNpZ25hdHVyZVZlcnNpb24pOwogIHByb3BlcnR5KHRoaXMsICdqc29uVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5qc29uVmVyc2lvbik7CiAgcHJvcGVydHkodGhpcywgJ3RhcmdldFByZWZpeCcsIGFwaS5tZXRhZGF0YS50YXJnZXRQcmVmaXgpOwogIHByb3BlcnR5KHRoaXMsICdwcm90b2NvbCcsIGFwaS5tZXRhZGF0YS5wcm90b2NvbCk7CiAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIGFwaS5tZXRhZGF0YS50aW1lc3RhbXBGb3JtYXQpOwogIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBhcGkubWV0YWRhdGEueG1sTmFtZXNwYWNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnYWJicmV2aWF0aW9uJywgYXBpLm1ldGFkYXRhLnNlcnZpY2VBYmJyZXZpYXRpb24pOwogIHByb3BlcnR5KHRoaXMsICdmdWxsTmFtZScsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWUpOwogIHByb3BlcnR5KHRoaXMsICdzZXJ2aWNlSWQnLCBhcGkubWV0YWRhdGEuc2VydmljZUlkKTsKICBpZiAoc2VydmljZUlkZW50aWZpZXIgJiYgbWV0YWRhdGFbc2VydmljZUlkZW50aWZpZXJdKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOb0RlZmF1bHRMaXN0cycsIG1ldGFkYXRhW3NlcnZpY2VJZGVudGlmaWVyXS54bWxOb0RlZmF1bHRMaXN0cywgZmFsc2UpOwogIH0KCiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnY2xhc3NOYW1lJywgZnVuY3Rpb24oKSB7CiAgICB2YXIgbmFtZSA9IGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uIHx8IGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWU7CiAgICBpZiAoIW5hbWUpIHJldHVybiBudWxsOwoKICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL15BbWF6b258QVdTXHMqfFwoLip8XHMrfFxXKy9nLCAnJyk7CiAgICBpZiAobmFtZSA9PT0gJ0VsYXN0aWNMb2FkQmFsYW5jaW5nJykgbmFtZSA9ICdFTEInOwogICAgcmV0dXJuIG5hbWU7CiAgfSk7CgogIGZ1bmN0aW9uIGFkZEVuZHBvaW50T3BlcmF0aW9uKG5hbWUsIG9wZXJhdGlvbikgewogICAgaWYgKG9wZXJhdGlvbi5lbmRwb2ludG9wZXJhdGlvbiA9PT0gdHJ1ZSkgewogICAgICBwcm9wZXJ0eShzZWxmLCAnZW5kcG9pbnRPcGVyYXRpb24nLCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KG5hbWUpKTsKICAgIH0KICAgIGlmIChvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkgJiYgIXNlbGYuaGFzUmVxdWlyZWRFbmRwb2ludERpc2NvdmVyeSkgewogICAgICBwcm9wZXJ0eSgKICAgICAgICBzZWxmLAogICAgICAgICdoYXNSZXF1aXJlZEVuZHBvaW50RGlzY292ZXJ5JywKICAgICAgICBvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkucmVxdWlyZWQgPT09IHRydWUKICAgICAgKTsKICAgIH0KICB9CgogIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb25zJywgbmV3IENvbGxlY3Rpb24oYXBpLm9wZXJhdGlvbnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIG9wZXJhdGlvbikgewogICAgcmV0dXJuIG5ldyBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKTsKICB9LCB1dGlsLnN0cmluZy5sb3dlckZpcnN0LCBhZGRFbmRwb2ludE9wZXJhdGlvbikpOwoKICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGVzJywgbmV3IENvbGxlY3Rpb24oYXBpLnNoYXBlcywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgc2hhcGUpIHsKICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUsIG9wdGlvbnMpOwogIH0pKTsKCiAgcHJvcGVydHkodGhpcywgJ3BhZ2luYXRvcnMnLCBuZXcgQ29sbGVjdGlvbihhcGkucGFnaW5hdG9ycywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgcGFnaW5hdG9yKSB7CiAgICByZXR1cm4gbmV3IFBhZ2luYXRvcihuYW1lLCBwYWdpbmF0b3IsIG9wdGlvbnMpOwogIH0pKTsKCiAgcHJvcGVydHkodGhpcywgJ3dhaXRlcnMnLCBuZXcgQ29sbGVjdGlvbihhcGkud2FpdGVycywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgd2FpdGVyKSB7CiAgICByZXR1cm4gbmV3IFJlc291cmNlV2FpdGVyKG5hbWUsIHdhaXRlciwgb3B0aW9ucyk7CiAgfSwgdXRpbC5zdHJpbmcubG93ZXJGaXJzdCkpOwoKICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvbicsIGFwaS5kb2N1bWVudGF0aW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgYXBpLmRvY3VtZW50YXRpb25VcmwpOwogIH0KICBwcm9wZXJ0eSh0aGlzLCAnZXJyb3JDb2RlTWFwcGluZycsIGFwaS5hd3NRdWVyeUNvbXBhdGlibGUpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFwaTsKCn0seyIuLi8uLi9hcGlzL21ldGFkYXRhLmpzb24iOjQsIi4uL3V0aWwiOjcyLCIuL2NvbGxlY3Rpb24iOjQwLCIuL29wZXJhdGlvbiI6NDEsIi4vcGFnaW5hdG9yIjo0MiwiLi9yZXNvdXJjZV93YWl0ZXIiOjQzLCIuL3NoYXBlIjo0NH1dLDQwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIG1lbW9pemVkUHJvcGVydHkgPSByZXF1aXJlKCcuLi91dGlsJykubWVtb2l6ZWRQcm9wZXJ0eTsKCmZ1bmN0aW9uIG1lbW9pemUobmFtZSwgdmFsdWUsIGZhY3RvcnksIG5hbWVUcikgewogIG1lbW9pemVkUHJvcGVydHkodGhpcywgbmFtZVRyKG5hbWUpLCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIHZhbHVlKTsKICB9KTsKfQoKZnVuY3Rpb24gQ29sbGVjdGlvbihpdGVyYWJsZSwgb3B0aW9ucywgZmFjdG9yeSwgbmFtZVRyLCBjYWxsYmFjaykgewogIG5hbWVUciA9IG5hbWVUciB8fCBTdHJpbmc7CiAgdmFyIHNlbGYgPSB0aGlzOwoKICBmb3IgKHZhciBpZCBpbiBpdGVyYWJsZSkgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpdGVyYWJsZSwgaWQpKSB7CiAgICAgIG1lbW9pemUuY2FsbChzZWxmLCBpZCwgaXRlcmFibGVbaWRdLCBmYWN0b3J5LCBuYW1lVHIpOwogICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGlkLCBpdGVyYWJsZVtpZF0pOwogICAgfQogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uOwoKfSx7Ii4uL3V0aWwiOjcyfV0sNDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7Cgp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKdmFyIG1lbW9pemVkUHJvcGVydHkgPSB1dGlsLm1lbW9pemVkUHJvcGVydHk7CgpmdW5jdGlvbiBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICBwcm9wZXJ0eSh0aGlzLCAnbmFtZScsIG9wZXJhdGlvbi5uYW1lIHx8IG5hbWUpOwogIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwoKICBvcGVyYXRpb24uaHR0cCA9IG9wZXJhdGlvbi5odHRwIHx8IHt9OwogIHByb3BlcnR5KHRoaXMsICdlbmRwb2ludCcsIG9wZXJhdGlvbi5lbmRwb2ludCk7CiAgcHJvcGVydHkodGhpcywgJ2h0dHBNZXRob2QnLCBvcGVyYXRpb24uaHR0cC5tZXRob2QgfHwgJ1BPU1QnKTsKICBwcm9wZXJ0eSh0aGlzLCAnaHR0cFBhdGgnLCBvcGVyYXRpb24uaHR0cC5yZXF1ZXN0VXJpIHx8ICcvJyk7CiAgcHJvcGVydHkodGhpcywgJ2F1dGh0eXBlJywgb3BlcmF0aW9uLmF1dGh0eXBlIHx8ICcnKTsKICBwcm9wZXJ0eSgKICAgIHRoaXMsCiAgICAnZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCcsCiAgICBvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkgPwogICAgICAob3BlcmF0aW9uLmVuZHBvaW50ZGlzY292ZXJ5LnJlcXVpcmVkID8gJ1JFUVVJUkVEJyA6ICdPUFRJT05BTCcpIDoKICAgICdOVUxMJwogICk7CgogIC8vIGh0dHBDaGVja3N1bSByZXBsYWNlcyB1c2FnZSBvZiBodHRwQ2hlY2tzdW1SZXF1aXJlZCwgYnV0IHNvbWUgQVBJcwogIC8vIChzM2NvbnRyb2wpIHN0aWxsIHVzZXMgb2xkIHRyYWl0LgogIHZhciBodHRwQ2hlY2tzdW1SZXF1aXJlZCA9IG9wZXJhdGlvbi5odHRwQ2hlY2tzdW1SZXF1aXJlZAogICAgfHwgKG9wZXJhdGlvbi5odHRwQ2hlY2tzdW0gJiYgb3BlcmF0aW9uLmh0dHBDaGVja3N1bS5yZXF1ZXN0Q2hlY2tzdW1SZXF1aXJlZCk7CiAgcHJvcGVydHkodGhpcywgJ2h0dHBDaGVja3N1bVJlcXVpcmVkJywgaHR0cENoZWNrc3VtUmVxdWlyZWQsIGZhbHNlKTsKCiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaW5wdXQnLCBmdW5jdGlvbigpIHsKICAgIGlmICghb3BlcmF0aW9uLmlucHV0KSB7CiAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShvcGVyYXRpb24uaW5wdXQsIG9wdGlvbnMpOwogIH0pOwoKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdvdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgIGlmICghb3BlcmF0aW9uLm91dHB1dCkgewogICAgICByZXR1cm4gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cnVjdHVyZSd9LCBvcHRpb25zKTsKICAgIH0KICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLm91dHB1dCwgb3B0aW9ucyk7CiAgfSk7CgogIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2Vycm9ycycsIGZ1bmN0aW9uKCkgewogICAgdmFyIGxpc3QgPSBbXTsKICAgIGlmICghb3BlcmF0aW9uLmVycm9ycykgcmV0dXJuIG51bGw7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvcGVyYXRpb24uZXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGxpc3QucHVzaChTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmVycm9yc1tpXSwgb3B0aW9ucykpOwogICAgfQoKICAgIHJldHVybiBsaXN0OwogIH0pOwoKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdwYWdpbmF0b3InLCBmdW5jdGlvbigpIHsKICAgIHJldHVybiBvcHRpb25zLmFwaS5wYWdpbmF0b3JzW25hbWVdOwogIH0pOwoKICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvbicsIG9wZXJhdGlvbi5kb2N1bWVudGF0aW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb25VcmwpOwogIH0KCiAgLy8gaWRlbXBvdGVudE1lbWJlcnMgb25seSB0cmFja3MgdG9wLWxldmVsIGlucHV0IHNoYXBlcwogIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lkZW1wb3RlbnRNZW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICB2YXIgaWRlbXBvdGVudE1lbWJlcnMgPSBbXTsKICAgIHZhciBpbnB1dCA9IHNlbGYuaW5wdXQ7CiAgICB2YXIgbWVtYmVycyA9IGlucHV0Lm1lbWJlcnM7CiAgICBpZiAoIWlucHV0Lm1lbWJlcnMpIHsKICAgICAgcmV0dXJuIGlkZW1wb3RlbnRNZW1iZXJzOwogICAgfQogICAgZm9yICh2YXIgbmFtZSBpbiBtZW1iZXJzKSB7CiAgICAgIGlmICghbWVtYmVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmIChtZW1iZXJzW25hbWVdLmlzSWRlbXBvdGVudCA9PT0gdHJ1ZSkgewogICAgICAgIGlkZW1wb3RlbnRNZW1iZXJzLnB1c2gobmFtZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICB9KTsKCiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaGFzRXZlbnRPdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgIHZhciBvdXRwdXQgPSBzZWxmLm91dHB1dDsKICAgIHJldHVybiBoYXNFdmVudFN0cmVhbShvdXRwdXQpOwogIH0pOwp9CgpmdW5jdGlvbiBoYXNFdmVudFN0cmVhbSh0b3BMZXZlbFNoYXBlKSB7CiAgdmFyIG1lbWJlcnMgPSB0b3BMZXZlbFNoYXBlLm1lbWJlcnM7CiAgdmFyIHBheWxvYWQgPSB0b3BMZXZlbFNoYXBlLnBheWxvYWQ7CgogIGlmICghdG9wTGV2ZWxTaGFwZS5tZW1iZXJzKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBpZiAocGF5bG9hZCkgewogICAgdmFyIHBheWxvYWRNZW1iZXIgPSBtZW1iZXJzW3BheWxvYWRdOwogICAgcmV0dXJuIHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbTsKICB9CgogIC8vIGNoZWNrIGlmIGFueSBtZW1iZXIgaXMgYW4gZXZlbnQgc3RyZWFtCiAgZm9yICh2YXIgbmFtZSBpbiBtZW1iZXJzKSB7CiAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgaWYgKG1lbWJlcnNbbmFtZV0uaXNFdmVudFN0cmVhbSA9PT0gdHJ1ZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBPcGVyYXRpb247Cgp9LHsiLi4vdXRpbCI6NzIsIi4vc2hhcGUiOjQ0fV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgcHJvcGVydHkgPSByZXF1aXJlKCcuLi91dGlsJykucHJvcGVydHk7CgpmdW5jdGlvbiBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yKSB7CiAgcHJvcGVydHkodGhpcywgJ2lucHV0VG9rZW4nLCBwYWdpbmF0b3IuaW5wdXRfdG9rZW4pOwogIHByb3BlcnR5KHRoaXMsICdsaW1pdEtleScsIHBhZ2luYXRvci5saW1pdF9rZXkpOwogIHByb3BlcnR5KHRoaXMsICdtb3JlUmVzdWx0cycsIHBhZ2luYXRvci5tb3JlX3Jlc3VsdHMpOwogIHByb3BlcnR5KHRoaXMsICdvdXRwdXRUb2tlbicsIHBhZ2luYXRvci5vdXRwdXRfdG9rZW4pOwogIHByb3BlcnR5KHRoaXMsICdyZXN1bHRLZXknLCBwYWdpbmF0b3IucmVzdWx0X2tleSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gUGFnaW5hdG9yOwoKfSx7Ii4uL3V0aWwiOjcyfV0sNDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKCmZ1bmN0aW9uIFJlc291cmNlV2FpdGVyKG5hbWUsIHdhaXRlciwgb3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIHByb3BlcnR5KHRoaXMsICduYW1lJywgbmFtZSk7CiAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CgogIGlmICh3YWl0ZXIub3BlcmF0aW9uKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnb3BlcmF0aW9uJywgdXRpbC5zdHJpbmcubG93ZXJGaXJzdCh3YWl0ZXIub3BlcmF0aW9uKSk7CiAgfQoKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyIGtleXMgPSBbCiAgICAndHlwZScsCiAgICAnZGVzY3JpcHRpb24nLAogICAgJ2RlbGF5JywKICAgICdtYXhBdHRlbXB0cycsCiAgICAnYWNjZXB0b3JzJwogIF07CgogIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgIHZhciB2YWx1ZSA9IHdhaXRlcltrZXldOwogICAgaWYgKHZhbHVlKSB7CiAgICAgIHByb3BlcnR5KHNlbGYsIGtleSwgdmFsdWUpOwogICAgfQogIH0pOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IFJlc291cmNlV2FpdGVyOwoKfSx7Ii4uL3V0aWwiOjcyfV0sNDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwoKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CgpmdW5jdGlvbiBwcm9wZXJ0eShvYmosIG5hbWUsIHZhbHVlKSB7CiAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgIHV0aWwucHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Cn0KCmZ1bmN0aW9uIG1lbW9pemVkUHJvcGVydHkob2JqLCBuYW1lKSB7CiAgaWYgKCFvYmouY29uc3RydWN0b3IucHJvdG90eXBlW25hbWVdKSB7CiAgICB1dGlsLm1lbW9pemVkUHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9Cn0KCmZ1bmN0aW9uIFNoYXBlKHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIHByb3BlcnR5KHRoaXMsICdzaGFwZScsIHNoYXBlLnNoYXBlKTsKICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAndHlwZScsIHNoYXBlLnR5cGUpOwogIHByb3BlcnR5KHRoaXMsICdlbnVtJywgc2hhcGUuZW51bSk7CiAgcHJvcGVydHkodGhpcywgJ21pbicsIHNoYXBlLm1pbik7CiAgcHJvcGVydHkodGhpcywgJ21heCcsIHNoYXBlLm1heCk7CiAgcHJvcGVydHkodGhpcywgJ3BhdHRlcm4nLCBzaGFwZS5wYXR0ZXJuKTsKICBwcm9wZXJ0eSh0aGlzLCAnbG9jYXRpb24nLCBzaGFwZS5sb2NhdGlvbiB8fCB0aGlzLmxvY2F0aW9uIHx8ICdib2R5Jyk7CiAgcHJvcGVydHkodGhpcywgJ25hbWUnLCB0aGlzLm5hbWUgfHwgc2hhcGUueG1sTmFtZSB8fCBzaGFwZS5xdWVyeU5hbWUgfHwKICAgIHNoYXBlLmxvY2F0aW9uTmFtZSB8fCBtZW1iZXJOYW1lKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNTdHJlYW1pbmcnLCBzaGFwZS5zdHJlYW1pbmcgfHwgdGhpcy5pc1N0cmVhbWluZyB8fCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVzTGVuZ3RoJywgc2hhcGUucmVxdWlyZXNMZW5ndGgsIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNDb21wb3NpdGUnLCBzaGFwZS5pc0NvbXBvc2l0ZSB8fCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzU2hhcGUnLCB0cnVlLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzUXVlcnlOYW1lJywgQm9vbGVhbihzaGFwZS5xdWVyeU5hbWUpLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzTG9jYXRpb25OYW1lJywgQm9vbGVhbihzaGFwZS5sb2NhdGlvbk5hbWUpLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzSWRlbXBvdGVudCcsIHNoYXBlLmlkZW1wb3RlbmN5VG9rZW4gPT09IHRydWUpOwogIHByb3BlcnR5KHRoaXMsICdpc0pzb25WYWx1ZScsIHNoYXBlLmpzb252YWx1ZSA9PT0gdHJ1ZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzU2Vuc2l0aXZlJywgc2hhcGUuc2Vuc2l0aXZlID09PSB0cnVlIHx8IHNoYXBlLnByb3RvdHlwZSAmJiBzaGFwZS5wcm90b3R5cGUuc2Vuc2l0aXZlID09PSB0cnVlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudFN0cmVhbScsIEJvb2xlYW4oc2hhcGUuZXZlbnRzdHJlYW0pLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnQnLCBCb29sZWFuKHNoYXBlLmV2ZW50KSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50UGF5bG9hZCcsIEJvb2xlYW4oc2hhcGUuZXZlbnRwYXlsb2FkKSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50SGVhZGVyJywgQm9vbGVhbihzaGFwZS5ldmVudGhlYWRlciksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNUaW1lc3RhbXBGb3JtYXRTZXQnLCBCb29sZWFuKHNoYXBlLnRpbWVzdGFtcEZvcm1hdCkgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5pc1RpbWVzdGFtcEZvcm1hdFNldCA9PT0gdHJ1ZSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdlbmRwb2ludERpc2NvdmVyeUlkJywgQm9vbGVhbihzaGFwZS5lbmRwb2ludGRpc2NvdmVyeWlkKSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdob3N0TGFiZWwnLCBCb29sZWFuKHNoYXBlLmhvc3RMYWJlbCksIGZhbHNlKTsKCiAgaWYgKG9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBzaGFwZS5kb2N1bWVudGF0aW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgc2hhcGUuZG9jdW1lbnRhdGlvblVybCk7CiAgfQoKICBpZiAoc2hhcGUueG1sQXR0cmlidXRlKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNYbWxBdHRyaWJ1dGUnLCBzaGFwZS54bWxBdHRyaWJ1dGUgfHwgZmFsc2UpOwogIH0KCiAgLy8gdHlwZSBjb252ZXJzaW9uIGFuZCBwYXJzaW5nCiAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIG51bGwpOwogIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJyc7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7IHJldHVybiB2YWx1ZTsgfTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KU2hhcGUubm9ybWFsaXplZFR5cGVzID0gewogIGNoYXJhY3RlcjogJ3N0cmluZycsCiAgZG91YmxlOiAnZmxvYXQnLAogIGxvbmc6ICdpbnRlZ2VyJywKICBzaG9ydDogJ2ludGVnZXInLAogIGJpZ2ludGVnZXI6ICdpbnRlZ2VyJywKICBiaWdkZWNpbWFsOiAnZmxvYXQnLAogIGJsb2I6ICdiaW5hcnknCn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpTaGFwZS50eXBlcyA9IHsKICAnc3RydWN0dXJlJzogU3RydWN0dXJlU2hhcGUsCiAgJ2xpc3QnOiBMaXN0U2hhcGUsCiAgJ21hcCc6IE1hcFNoYXBlLAogICdib29sZWFuJzogQm9vbGVhblNoYXBlLAogICd0aW1lc3RhbXAnOiBUaW1lc3RhbXBTaGFwZSwKICAnZmxvYXQnOiBGbG9hdFNoYXBlLAogICdpbnRlZ2VyJzogSW50ZWdlclNoYXBlLAogICdzdHJpbmcnOiBTdHJpbmdTaGFwZSwKICAnYmFzZTY0JzogQmFzZTY0U2hhcGUsCiAgJ2JpbmFyeSc6IEJpbmFyeVNoYXBlCn07CgpTaGFwZS5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShzaGFwZSwgb3B0aW9ucykgewogIGlmIChzaGFwZS5zaGFwZSkgewogICAgdmFyIHJlZlNoYXBlID0gb3B0aW9ucy5hcGkuc2hhcGVzW3NoYXBlLnNoYXBlXTsKICAgIGlmICghcmVmU2hhcGUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzaGFwZSByZWZlcmVuY2U6ICcgKyBzaGFwZS5zaGFwZSk7CiAgICB9CgogICAgcmV0dXJuIHJlZlNoYXBlOwogIH0gZWxzZSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn07CgpTaGFwZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpIHsKICBpZiAoc2hhcGUuaXNTaGFwZSkgcmV0dXJuIHNoYXBlOwoKICB2YXIgcmVmU2hhcGUgPSBTaGFwZS5yZXNvbHZlKHNoYXBlLCBvcHRpb25zKTsKICBpZiAocmVmU2hhcGUpIHsKICAgIHZhciBmaWx0ZXJlZEtleXMgPSBPYmplY3Qua2V5cyhzaGFwZSk7CiAgICBpZiAoIW9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgICBmaWx0ZXJlZEtleXMgPSBmaWx0ZXJlZEtleXMuZmlsdGVyKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICByZXR1cm4gIW5hbWUubWF0Y2goL2RvY3VtZW50YXRpb24vKTsKICAgICAgfSk7CiAgICB9CgogICAgLy8gY3JlYXRlIGFuIGlubGluZSBzaGFwZSB3aXRoIGV4dHJhIG1lbWJlcnMKICAgIHZhciBJbmxpbmVTaGFwZSA9IGZ1bmN0aW9uKCkgewogICAgICByZWZTaGFwZS5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKTsKICAgIH07CiAgICBJbmxpbmVTaGFwZS5wcm90b3R5cGUgPSByZWZTaGFwZTsKICAgIHJldHVybiBuZXcgSW5saW5lU2hhcGUoKTsKICB9IGVsc2UgewogICAgLy8gc2V0IHR5cGUgaWYgbm90IHNldAogICAgaWYgKCFzaGFwZS50eXBlKSB7CiAgICAgIGlmIChzaGFwZS5tZW1iZXJzKSBzaGFwZS50eXBlID0gJ3N0cnVjdHVyZSc7CiAgICAgIGVsc2UgaWYgKHNoYXBlLm1lbWJlcikgc2hhcGUudHlwZSA9ICdsaXN0JzsKICAgICAgZWxzZSBpZiAoc2hhcGUua2V5KSBzaGFwZS50eXBlID0gJ21hcCc7CiAgICAgIGVsc2Ugc2hhcGUudHlwZSA9ICdzdHJpbmcnOwogICAgfQoKICAgIC8vIG5vcm1hbGl6ZSB0eXBlcwogICAgdmFyIG9yaWdUeXBlID0gc2hhcGUudHlwZTsKICAgIGlmIChTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV0pIHsKICAgICAgc2hhcGUudHlwZSA9IFNoYXBlLm5vcm1hbGl6ZWRUeXBlc1tzaGFwZS50eXBlXTsKICAgIH0KCiAgICBpZiAoU2hhcGUudHlwZXNbc2hhcGUudHlwZV0pIHsKICAgICAgcmV0dXJuIG5ldyBTaGFwZS50eXBlc1tzaGFwZS50eXBlXShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXplZCBzaGFwZSB0eXBlOiAnICsgb3JpZ1R5cGUpOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIENvbXBvc2l0ZVNoYXBlKHNoYXBlKSB7CiAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNDb21wb3NpdGUnLCB0cnVlKTsKCiAgaWYgKHNoYXBlLmZsYXR0ZW5lZCkgewogICAgcHJvcGVydHkodGhpcywgJ2ZsYXR0ZW5lZCcsIHNoYXBlLmZsYXR0ZW5lZCB8fCBmYWxzZSk7CiAgfQp9CgpmdW5jdGlvbiBTdHJ1Y3R1cmVTaGFwZShzaGFwZSwgb3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpczsKICB2YXIgcmVxdWlyZWRNYXAgPSBudWxsLCBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwoKICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICBpZiAoZmlyc3RJbml0KSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiB7fTsgfSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVycycsIHt9KTsKICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIFtdKTsKICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlZCcsIFtdKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1JlcXVpcmVkJywgZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNEb2N1bWVudCcsIEJvb2xlYW4oc2hhcGUuZG9jdW1lbnQpKTsKICB9CgogIGlmIChzaGFwZS5tZW1iZXJzKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVycycsIG5ldyBDb2xsZWN0aW9uKHNoYXBlLm1lbWJlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG1lbWJlciwgb3B0aW9ucywgbmFtZSk7CiAgICB9KSk7CiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2hhcGUueG1sT3JkZXIgfHwgT2JqZWN0LmtleXMoc2hhcGUubWVtYmVycyk7CiAgICB9KTsKCiAgICBpZiAoc2hhcGUuZXZlbnQpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXZlbnRQYXlsb2FkTWVtYmVyTmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgIHZhciBtZW1iZXJOYW1lcyA9IHNlbGYubWVtYmVyTmFtZXM7CiAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIG1lbWJlcnMgdG8gZmluZCBvbmVzIHRoYXQgYXJlIGV2ZW50IHBheWxvYWRzCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgIGlmIChtZW1iZXJzW21lbWJlck5hbWVzW2ldXS5pc0V2ZW50UGF5bG9hZCkgewogICAgICAgICAgICByZXR1cm4gbWVtYmVyTmFtZXNbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50SGVhZGVyTWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbWVtYmVycyA9IHNlbGYubWVtYmVyczsKICAgICAgICB2YXIgbWVtYmVyTmFtZXMgPSBzZWxmLm1lbWJlck5hbWVzOwogICAgICAgIHZhciBldmVudEhlYWRlck1lbWJlck5hbWVzID0gW107CiAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIG1lbWJlcnMgdG8gZmluZCBvbmVzIHRoYXQgYXJlIGV2ZW50IGhlYWRlcnMKICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG1lbWJlck5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRIZWFkZXIpIHsKICAgICAgICAgICAgZXZlbnRIZWFkZXJNZW1iZXJOYW1lcy5wdXNoKG1lbWJlck5hbWVzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXM7CiAgICAgIH0pOwogICAgfQogIH0KCiAgaWYgKHNoYXBlLnJlcXVpcmVkKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZWQnLCBzaGFwZS5yZXF1aXJlZCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgaWYgKCFyZXF1aXJlZE1hcCkgewogICAgICAgIHJlcXVpcmVkTWFwID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVxdWlyZWRNYXBbc2hhcGUucmVxdWlyZWRbaV1dID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZXF1aXJlZE1hcFtuYW1lXTsKICAgIH0sIGZhbHNlLCB0cnVlKTsKICB9CgogIHByb3BlcnR5KHRoaXMsICdyZXN1bHRXcmFwcGVyJywgc2hhcGUucmVzdWx0V3JhcHBlciB8fCBudWxsKTsKCiAgaWYgKHNoYXBlLnBheWxvYWQpIHsKICAgIHByb3BlcnR5KHRoaXMsICdwYXlsb2FkJywgc2hhcGUucGF5bG9hZCk7CiAgfQoKICBpZiAodHlwZW9mIHNoYXBlLnhtbE5hbWVzcGFjZSA9PT0gJ3N0cmluZycpIHsKICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UpOwogIH0gZWxzZSBpZiAodHlwZW9mIHNoYXBlLnhtbE5hbWVzcGFjZSA9PT0gJ29iamVjdCcpIHsKICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VQcmVmaXgnLCBzaGFwZS54bWxOYW1lc3BhY2UucHJlZml4KTsKICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UudXJpKTsKICB9Cn0KCmZ1bmN0aW9uIExpc3RTaGFwZShzaGFwZSwgb3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpcywgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICBpZiAoZmlyc3RJbml0KSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiBbXTsgfSk7CiAgfQoKICBpZiAoc2hhcGUubWVtYmVyKSB7CiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdtZW1iZXInLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5tZW1iZXIsIG9wdGlvbnMpOwogICAgfSk7CiAgfQoKICBpZiAodGhpcy5mbGF0dGVuZWQpIHsKICAgIHZhciBvbGROYW1lID0gdGhpcy5uYW1lOwogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbmFtZScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2VsZi5tZW1iZXIubmFtZSB8fCBvbGROYW1lOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBNYXBTaGFwZShzaGFwZSwgb3B0aW9ucykgewogIHZhciBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIGlmIChmaXJzdEluaXQpIHsKICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIHt9OyB9KTsKICAgIHByb3BlcnR5KHRoaXMsICdrZXknLCBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJpbmcnfSwgb3B0aW9ucykpOwogICAgcHJvcGVydHkodGhpcywgJ3ZhbHVlJywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICB9CgogIGlmIChzaGFwZS5rZXkpIHsKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2tleScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLmtleSwgb3B0aW9ucyk7CiAgICB9KTsKICB9CiAgaWYgKHNoYXBlLnZhbHVlKSB7CiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICd2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLnZhbHVlLCBvcHRpb25zKTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gVGltZXN0YW1wU2hhcGUoc2hhcGUpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgaWYgKHNoYXBlLnRpbWVzdGFtcEZvcm1hdCkgewogICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIHNoYXBlLnRpbWVzdGFtcEZvcm1hdCk7CiAgfSBlbHNlIGlmIChzZWxmLmlzVGltZXN0YW1wRm9ybWF0U2V0ICYmIHRoaXMudGltZXN0YW1wRm9ybWF0KSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgdGhpcy50aW1lc3RhbXBGb3JtYXQpOwogIH0gZWxzZSBpZiAodGhpcy5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAncmZjODIyJyk7CiAgfSBlbHNlIGlmICh0aGlzLmxvY2F0aW9uID09PSAncXVlcnlzdHJpbmcnKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICB9IGVsc2UgaWYgKHRoaXMuYXBpKSB7CiAgICBzd2l0Y2ggKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgIGNhc2UgJ2pzb24nOgogICAgICBjYXNlICdyZXN0LWpzb24nOgogICAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAndW5peFRpbWVzdGFtcCcpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdyZXN0LXhtbCc6CiAgICAgIGNhc2UgJ3F1ZXJ5JzoKICAgICAgY2FzZSAnZWMyJzoKICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICAgICAgICBicmVhazsKICAgIH0KICB9CgogIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgIGlmICh0eXBlb2YgdmFsdWUudG9VVENTdHJpbmcgPT09ICdmdW5jdGlvbicpIHJldHVybiB2YWx1ZTsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPwogICAgICAgICAgIHV0aWwuZGF0ZS5wYXJzZVRpbWVzdGFtcCh2YWx1ZSkgOiBudWxsOwogIH07CgogIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB1dGlsLmRhdGUuZm9ybWF0KHZhbHVlLCBzZWxmLnRpbWVzdGFtcEZvcm1hdCk7CiAgfTsKfQoKZnVuY3Rpb24gU3RyaW5nU2hhcGUoKSB7CiAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgdmFyIG51bGxMZXNzUHJvdG9jb2xzID0gWydyZXN0LXhtbCcsICdxdWVyeScsICdlYzInXTsKICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YWx1ZSA9IHRoaXMuYXBpICYmIG51bGxMZXNzUHJvdG9jb2xzLmluZGV4T2YodGhpcy5hcGkucHJvdG9jb2wpID4gLTEgPwogICAgICB2YWx1ZSB8fCAnJyA6IHZhbHVlOwogICAgaWYgKHRoaXMuaXNKc29uVmFsdWUpIHsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogICAgfQoKICAgIHJldHVybiB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUudG9TdHJpbmcgPT09ICdmdW5jdGlvbicgPwogICAgICB2YWx1ZS50b1N0cmluZygpIDogdmFsdWU7CiAgfTsKCiAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHRoaXMuaXNKc29uVmFsdWUgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKICB9Owp9CgpmdW5jdGlvbiBGbG9hdFNoYXBlKCkgewogIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlKTsKICB9OwogIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7Cn0KCmZ1bmN0aW9uIEludGVnZXJTaGFwZSgpIHsKICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKTsKICB9OwogIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7Cn0KCmZ1bmN0aW9uIEJpbmFyeVNoYXBlKCkgewogIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgdmFyIGJ1ZiA9IHV0aWwuYmFzZTY0LmRlY29kZSh2YWx1ZSk7CiAgICBpZiAodGhpcy5pc1NlbnNpdGl2ZSAmJiB1dGlsLmlzTm9kZSgpICYmIHR5cGVvZiB1dGlsLkJ1ZmZlci5hbGxvYyA9PT0gJ2Z1bmN0aW9uJykgewogIC8qIE5vZGUuanMgY2FuIGNyZWF0ZSBhIEJ1ZmZlciB0aGF0IGlzIG5vdCBpc29sYXRlZC4KICAgKiBpLmUuIGJ1Zi5ieXRlTGVuZ3RoICE9PSBidWYuYnVmZmVyLmJ5dGVMZW5ndGgKICAgKiBUaGlzIG1lYW5zIHRoYXQgdGhlIHNlbnNpdGl2ZSBkYXRhIGlzIGFjY2Vzc2libGUgdG8gYW55b25lIHdpdGggYWNjZXNzIHRvIGJ1Zi5idWZmZXIuCiAgICogSWYgdGhpcyBpcyB0aGUgbm9kZSBzaGFyZWQgQnVmZmVyLCB0aGVuIG90aGVyIGNvZGUgd2l0aGluIHRoaXMgcHJvY2VzcyBfY291bGRfIGZpbmQgdGhpcyBzZWNyZXQuCiAgICogQ29weSBzZW5zaXRpdmUgZGF0YSB0byBhbiBpc29sYXRlZCBCdWZmZXIgYW5kIHplcm8gdGhlIHNlbnNpdGl2ZSBkYXRhLgogICAqIFdoaWxlIHRoaXMgaXMgc2FmZSB0byBkbyBoZXJlLCBjb3B5aW5nIHRoaXMgY29kZSBzb21ld2hlcmUgZWxzZSBtYXkgcHJvZHVjZSB1bmV4cGVjdGVkIHJlc3VsdHMuCiAgICovCiAgICAgIHZhciBzZWN1cmVCdWYgPSB1dGlsLkJ1ZmZlci5hbGxvYyhidWYubGVuZ3RoLCBidWYpOwogICAgICBidWYuZmlsbCgwKTsKICAgICAgYnVmID0gc2VjdXJlQnVmOwogICAgfQogICAgcmV0dXJuIGJ1ZjsKICB9OwogIHRoaXMudG9XaXJlRm9ybWF0ID0gdXRpbC5iYXNlNjQuZW5jb2RlOwp9CgpmdW5jdGlvbiBCYXNlNjRTaGFwZSgpIHsKICBCaW5hcnlTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CgpmdW5jdGlvbiBCb29sZWFuU2hhcGUoKSB7CiAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gdmFsdWU7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gdmFsdWUgPT09ICd0cnVlJzsKICB9Owp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpTaGFwZS5zaGFwZXMgPSB7CiAgU3RydWN0dXJlU2hhcGU6IFN0cnVjdHVyZVNoYXBlLAogIExpc3RTaGFwZTogTGlzdFNoYXBlLAogIE1hcFNoYXBlOiBNYXBTaGFwZSwKICBTdHJpbmdTaGFwZTogU3RyaW5nU2hhcGUsCiAgQm9vbGVhblNoYXBlOiBCb29sZWFuU2hhcGUsCiAgQmFzZTY0U2hhcGU6IEJhc2U2NFNoYXBlCn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IFNoYXBlOwoKfSx7Ii4uL3V0aWwiOjcyLCIuL2NvbGxlY3Rpb24iOjQwfV0sNDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuUGFyYW1WYWxpZGF0b3IgPSBBV1MudXRpbC5pbmhlcml0KHsKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgdmFsaWRhdG9yIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB2YWxpZGF0aW9uIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzIHNob3VsZCBiZQogICAqICAgICB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZQogICAqICAgICByZXF1ZXN0LiBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlIGZvbGxvd2luZyBzcGVjaWZpYwogICAqICAgICB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAqCiAgICogICAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgKiAgICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgKiAgICAgICB0byBgdHJ1ZWAuCiAgICogICAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgKiAgICAgICBjb25zdHJhaW50LgogICAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAqICAgICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgKiAgICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFBhcmFtVmFsaWRhdG9yKHZhbGlkYXRpb24pIHsKICAgIGlmICh2YWxpZGF0aW9uID09PSB0cnVlIHx8IHZhbGlkYXRpb24gPT09IHVuZGVmaW5lZCkgewogICAgICB2YWxpZGF0aW9uID0geydtaW4nOiB0cnVlfTsKICAgIH0KICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgfSwKCiAgdmFsaWRhdGU6IGZ1bmN0aW9uIHZhbGlkYXRlKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgIHRoaXMuZXJyb3JzID0gW107CiAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLCBwYXJhbXMgfHwge30sIGNvbnRleHQgfHwgJ3BhcmFtcycpOwoKICAgIGlmICh0aGlzLmVycm9ycy5sZW5ndGggPiAxKSB7CiAgICAgIHZhciBtc2cgPSB0aGlzLmVycm9ycy5qb2luKCdcbiogJyk7CiAgICAgIG1zZyA9ICdUaGVyZSB3ZXJlICcgKyB0aGlzLmVycm9ycy5sZW5ndGggKwogICAgICAgICcgdmFsaWRhdGlvbiBlcnJvcnM6XG4qICcgKyBtc2c7CiAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtc2cpLAogICAgICAgIHtjb2RlOiAnTXVsdGlwbGVWYWxpZGF0aW9uRXJyb3JzJywgZXJyb3JzOiB0aGlzLmVycm9yc30pOwogICAgfSBlbHNlIGlmICh0aGlzLmVycm9ycy5sZW5ndGggPT09IDEpIHsKICAgICAgdGhyb3cgdGhpcy5lcnJvcnNbMF07CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9LAoKICBmYWlsOiBmdW5jdGlvbiBmYWlsKGNvZGUsIG1lc3NhZ2UpIHsKICAgIHRoaXMuZXJyb3JzLnB1c2goQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpLCB7Y29kZTogY29kZX0pKTsKICB9LAoKICB2YWxpZGF0ZVN0cnVjdHVyZTogZnVuY3Rpb24gdmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgaWYgKHNoYXBlLmlzRG9jdW1lbnQpIHJldHVybiB0cnVlOwoKICAgIHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgWydvYmplY3QnXSwgJ3N0cnVjdHVyZScpOwogICAgdmFyIHBhcmFtTmFtZTsKICAgIGZvciAodmFyIGkgPSAwOyBzaGFwZS5yZXF1aXJlZCAmJiBpIDwgc2hhcGUucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgcGFyYW1OYW1lID0gc2hhcGUucmVxdWlyZWRbaV07CiAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdOwogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHRoaXMuZmFpbCgnTWlzc2luZ1JlcXVpcmVkUGFyYW1ldGVyJywKICAgICAgICAgICdNaXNzaW5nIHJlcXVpcmVkIGtleSBcJycgKyBwYXJhbU5hbWUgKyAnXCcgaW4gJyArIGNvbnRleHQpOwogICAgICB9CiAgICB9CgogICAgLy8gdmFsaWRhdGUgaGFzaCBtZW1iZXJzCiAgICBmb3IgKHBhcmFtTmFtZSBpbiBwYXJhbXMpIHsKICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1zLCBwYXJhbU5hbWUpKSBjb250aW51ZTsKCiAgICAgIHZhciBwYXJhbVZhbHVlID0gcGFyYW1zW3BhcmFtTmFtZV0sCiAgICAgICAgICBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbcGFyYW1OYW1lXTsKCiAgICAgIGlmIChtZW1iZXJTaGFwZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFyIG1lbWJlckNvbnRleHQgPSBbY29udGV4dCwgcGFyYW1OYW1lXS5qb2luKCcuJyk7CiAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihtZW1iZXJTaGFwZSwgcGFyYW1WYWx1ZSwgbWVtYmVyQ29udGV4dCk7CiAgICAgIH0gZWxzZSBpZiAocGFyYW1WYWx1ZSAhPT0gdW5kZWZpbmVkICYmIHBhcmFtVmFsdWUgIT09IG51bGwpIHsKICAgICAgICB0aGlzLmZhaWwoJ1VuZXhwZWN0ZWRQYXJhbWV0ZXInLAogICAgICAgICAgJ1VuZXhwZWN0ZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBmb3VuZCBpbiAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICB2YWxpZGF0ZU1lbWJlcjogZnVuY3Rpb24gdmFsaWRhdGVNZW1iZXIoc2hhcGUsIHBhcmFtLCBjb250ZXh0KSB7CiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVN0cnVjdHVyZShzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICBjYXNlICdsaXN0JzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgY2FzZSAnbWFwJzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU2NhbGFyKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVMaXN0OiBmdW5jdGlvbiB2YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgW0FycmF5XSkpIHsKICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCBwYXJhbXMubGVuZ3RoLCBjb250ZXh0LCAnbGlzdCBtZW1iZXIgY291bnQnKTsKICAgICAgLy8gdmFsaWRhdGUgYXJyYXkgbWVtYmVycwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUubWVtYmVyLCBwYXJhbXNbaV0sIGNvbnRleHQgKyAnWycgKyBpICsgJ10nKTsKICAgICAgfQogICAgfQogIH0sCgogIHZhbGlkYXRlTWFwOiBmdW5jdGlvbiB2YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUocGFyYW1zLCBjb250ZXh0LCBbJ29iamVjdCddLCAnbWFwJykpIHsKICAgICAgLy8gQnVpbGQgdXAgYSBjb3VudCBvZiBtYXAgbWVtYmVycyB0byB2YWxpZGF0ZSByYW5nZSB0cmFpdHMuCiAgICAgIHZhciBtYXBDb3VudCA9IDA7CiAgICAgIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykgewogICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtcywgcGFyYW0pKSBjb250aW51ZTsKICAgICAgICAvLyBWYWxpZGF0ZSBhbnkgbWFwIGtleSB0cmFpdCBjb25zdHJhaW50cwogICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUua2V5LCBwYXJhbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgKyAnW2tleT1cJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLnZhbHVlLCBwYXJhbXNbcGFyYW1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCArICdbXCcnICsgcGFyYW0gKyAnXCddJyk7CiAgICAgICAgbWFwQ291bnQrKzsKICAgICAgfQogICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIG1hcENvdW50LCBjb250ZXh0LCAnbWFwIG1lbWJlciBjb3VudCcpOwogICAgfQogIH0sCgogIHZhbGlkYXRlU2NhbGFyOiBmdW5jdGlvbiB2YWxpZGF0ZVNjYWxhcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlIG51bGw6CiAgICAgIGNhc2UgdW5kZWZpbmVkOgogICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU3RyaW5nKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVQYXlsb2FkKHZhbHVlLCBjb250ZXh0KTsKICAgICAgY2FzZSAnaW50ZWdlcic6CiAgICAgIGNhc2UgJ2Zsb2F0JzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZU51bWJlcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnYm9vbGVhbiddKTsKICAgICAgY2FzZSAndGltZXN0YW1wJzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFtEYXRlLAogICAgICAgICAgL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLCAnbnVtYmVyJ10sCiAgICAgICAgICAnRGF0ZSBvYmplY3QsIElTTy04NjAxIHN0cmluZywgb3IgYSBVTklYIHRpbWVzdGFtcCcpOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiB0aGlzLmZhaWwoJ1Vua293blR5cGUnLCAnVW5oYW5kbGVkIHR5cGUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZS50eXBlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgfQogIH0sCgogIHZhbGlkYXRlU3RyaW5nOiBmdW5jdGlvbiB2YWxpZGF0ZVN0cmluZyhzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciB2YWxpZFR5cGVzID0gWydzdHJpbmcnXTsKICAgIGlmIChzaGFwZS5pc0pzb25WYWx1ZSkgewogICAgICB2YWxpZFR5cGVzID0gdmFsaWRUeXBlcy5jb25jYXQoWydudW1iZXInLCAnb2JqZWN0JywgJ2Jvb2xlYW4nXSk7CiAgICB9CiAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIHZhbGlkVHlwZXMpKSB7CiAgICAgIHRoaXMudmFsaWRhdGVFbnVtKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUubGVuZ3RoLCBjb250ZXh0LCAnc3RyaW5nIGxlbmd0aCcpOwogICAgICB0aGlzLnZhbGlkYXRlUGF0dGVybihzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICB0aGlzLnZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVVcmk6IGZ1bmN0aW9uIHZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgaWYgKHNoYXBlWydsb2NhdGlvbiddID09PSAndXJpJykgewogICAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5mYWlsKCdVcmlQYXJhbWV0ZXJFcnJvcicsICdFeHBlY3RlZCB1cmkgcGFyYW1ldGVyIHRvIGhhdmUgbGVuZ3RoID49IDEsJwogICAgICAgICAgKyAnIGJ1dCBmb3VuZCAiJyArIHZhbHVlICsnIiBmb3IgJyArIGNvbnRleHQpOwogICAgICB9CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVQYXR0ZXJuOiBmdW5jdGlvbiB2YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICBpZiAodGhpcy52YWxpZGF0aW9uWydwYXR0ZXJuJ10gJiYgc2hhcGVbJ3BhdHRlcm4nXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGlmICghKG5ldyBSZWdFeHAoc2hhcGVbJ3BhdHRlcm4nXSkpLnRlc3QodmFsdWUpKSB7CiAgICAgICAgdGhpcy5mYWlsKCdQYXR0ZXJuTWF0Y2hFcnJvcicsICdQcm92aWRlZCB2YWx1ZSAiJyArIHZhbHVlICsgJyIgJwogICAgICAgICAgKyAnZG9lcyBub3QgbWF0Y2ggcmVnZXggcGF0dGVybiAvJyArIHNoYXBlWydwYXR0ZXJuJ10gKyAnLyBmb3IgJwogICAgICAgICAgKyBjb250ZXh0KTsKICAgICAgfQogICAgfQogIH0sCgogIHZhbGlkYXRlUmFuZ2U6IGZ1bmN0aW9uIHZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLCBjb250ZXh0LCBkZXNjcmlwdG9yKSB7CiAgICBpZiAodGhpcy52YWxpZGF0aW9uWydtaW4nXSkgewogICAgICBpZiAoc2hhcGVbJ21pbiddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPCBzaGFwZVsnbWluJ10pIHsKICAgICAgICB0aGlzLmZhaWwoJ01pblJhbmdlRXJyb3InLCAnRXhwZWN0ZWQgJyArIGRlc2NyaXB0b3IgKyAnID49ICcKICAgICAgICAgICsgc2hhcGVbJ21pbiddICsgJywgYnV0IGZvdW5kICcgKyB2YWx1ZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfQogICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWF4J10pIHsKICAgICAgaWYgKHNoYXBlWydtYXgnXSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlID4gc2hhcGVbJ21heCddKSB7CiAgICAgICAgdGhpcy5mYWlsKCdNYXhSYW5nZUVycm9yJywgJ0V4cGVjdGVkICcgKyBkZXNjcmlwdG9yICsgJyA8PSAnCiAgICAgICAgICArIHNoYXBlWydtYXgnXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0KICB9LAoKICB2YWxpZGF0ZUVudW06IGZ1bmN0aW9uIHZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICBpZiAodGhpcy52YWxpZGF0aW9uWydlbnVtJ10gJiYgc2hhcGVbJ2VudW0nXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIEZhaWwgaWYgdGhlIHN0cmluZyB2YWx1ZSBpcyBub3QgcHJlc2VudCBpbiB0aGUgZW51bSBsaXN0CiAgICAgIGlmIChzaGFwZVsnZW51bSddLmluZGV4T2YodmFsdWUpID09PSAtMSkgewogICAgICAgIHRoaXMuZmFpbCgnRW51bUVycm9yJywgJ0ZvdW5kIHN0cmluZyB2YWx1ZSBvZiAnICsgdmFsdWUgKyAnLCBidXQgJwogICAgICAgICAgKyAnZXhwZWN0ZWQgJyArIHNoYXBlWydlbnVtJ10uam9pbignfCcpICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICB9CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVUeXBlOiBmdW5jdGlvbiB2YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIGFjY2VwdGVkVHlwZXMsIHR5cGUpIHsKICAgIC8vIFdlIHdpbGwgbm90IGxvZyBhbiBlcnJvciBmb3IgbnVsbCBvciB1bmRlZmluZWQsIGJ1dCB3ZSB3aWxsIHJldHVybgogICAgLy8gZmFsc2Ugc28gdGhhdCBjYWxsZXJzIGtub3cgdGhhdCB0aGUgZXhwZWN0ZWQgdHlwZSB3YXMgbm90IHN0cmljdGx5IG1ldC4KICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gZmFsc2U7CgogICAgdmFyIGZvdW5kSW52YWxpZFR5cGUgPSBmYWxzZTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYWNjZXB0ZWRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodHlwZW9mIGFjY2VwdGVkVHlwZXNbaV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gYWNjZXB0ZWRUeXBlc1tpXSkgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAoYWNjZXB0ZWRUeXBlc1tpXSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgIGlmICgodmFsdWUgfHwgJycpLnRvU3RyaW5nKCkubWF0Y2goYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGFjY2VwdGVkVHlwZXNbaV0pIHJldHVybiB0cnVlOwogICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIGFjY2VwdGVkVHlwZXNbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAoIXR5cGUgJiYgIWZvdW5kSW52YWxpZFR5cGUpIGFjY2VwdGVkVHlwZXMgPSBhY2NlcHRlZFR5cGVzLnNsaWNlKCk7CiAgICAgICAgYWNjZXB0ZWRUeXBlc1tpXSA9IEFXUy51dGlsLnR5cGVOYW1lKGFjY2VwdGVkVHlwZXNbaV0pOwogICAgICB9CiAgICAgIGZvdW5kSW52YWxpZFR5cGUgPSB0cnVlOwogICAgfQoKICAgIHZhciBhY2NlcHRlZFR5cGUgPSB0eXBlOwogICAgaWYgKCFhY2NlcHRlZFR5cGUpIHsKICAgICAgYWNjZXB0ZWRUeXBlID0gYWNjZXB0ZWRUeXBlcy5qb2luKCcsICcpLnJlcGxhY2UoLywoW14sXSspJC8sICcsIG9yJDEnKTsKICAgIH0KCiAgICB2YXIgdm93ZWwgPSBhY2NlcHRlZFR5cGUubWF0Y2goL15bYWVpb3VdL2kpID8gJ24nIDogJyc7CiAgICB0aGlzLmZhaWwoJ0ludmFsaWRQYXJhbWV0ZXJUeXBlJywgJ0V4cGVjdGVkICcgKyBjb250ZXh0ICsgJyB0byBiZSBhJyArCiAgICAgICAgICAgICAgdm93ZWwgKyAnICcgKyBhY2NlcHRlZFR5cGUpOwogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIHZhbGlkYXRlTnVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU51bWJlcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICB2YXIgY2FzdGVkVmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgICAgaWYgKGNhc3RlZFZhbHVlLnRvU3RyaW5nKCkgPT09IHZhbHVlKSB2YWx1ZSA9IGNhc3RlZFZhbHVlOwogICAgfQogICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbJ251bWJlciddKSkgewogICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLCBjb250ZXh0LCAnbnVtZXJpYyB2YWx1ZScpOwogICAgfQogIH0sCgogIHZhbGlkYXRlUGF5bG9hZDogZnVuY3Rpb24gdmFsaWRhdGVQYXlsb2FkKHZhbHVlLCBjb250ZXh0KSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHJldHVybjsKICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicpIHJldHVybjsgLy8gdHlwZWQgYXJyYXlzCiAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkpIHsgLy8gc3BlY2lhbCBjaGVjayBmb3IgYnVmZmVyL3N0cmVhbSBpbiBOb2RlLmpzCiAgICAgIHZhciBTdHJlYW0gPSBBV1MudXRpbC5zdHJlYW0uU3RyZWFtOwogICAgICBpZiAoQVdTLnV0aWwuQnVmZmVyLmlzQnVmZmVyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFN0cmVhbSkgcmV0dXJuOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHR5cGVvZiBCbG9iICE9PSB2b2lkIDAgJiYgdmFsdWUgaW5zdGFuY2VvZiBCbG9iKSByZXR1cm47CiAgICB9CgogICAgdmFyIHR5cGVzID0gWydCdWZmZXInLCAnU3RyZWFtJywgJ0ZpbGUnLCAnQmxvYicsICdBcnJheUJ1ZmZlcicsICdEYXRhVmlldyddOwogICAgaWYgKHZhbHVlKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoQVdTLnV0aWwuaXNUeXBlKHZhbHVlLCB0eXBlc1tpXSkpIHJldHVybjsKICAgICAgICBpZiAoQVdTLnV0aWwudHlwZU5hbWUodmFsdWUuY29uc3RydWN0b3IpID09PSB0eXBlc1tpXSkgcmV0dXJuOwogICAgICB9CiAgICB9CgogICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYSAnICsKICAgICAgJ3N0cmluZywgQnVmZmVyLCBTdHJlYW0sIEJsb2IsIG9yIHR5cGVkIGFycmF5IG9iamVjdCcpOwogIH0KfSk7Cgp9LHsiLi9jb3JlIjoxOX1dLDQ2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSAgcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwoKLyoqCiAqIFByZXBlbmQgcHJlZml4IGRlZmluZWQgYnkgQVBJIG1vZGVsIHRvIGVuZHBvaW50IHRoYXQncyBhbHJlYWR5CiAqIGNvbnN0cnVjdGVkLiBUaGlzIGZlYXR1cmUgZG9lcyBub3QgYXBwbHkgdG8gb3BlcmF0aW9ucyB1c2luZwogKiBlbmRwb2ludCBkaXNjb3ZlcnkgYW5kIGNhbiBiZSBkaXNhYmxlZC4KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxdWVzdCkgIHsKICB2YXIgZW5hYmxlZCA9IHJlcXVlc3Quc2VydmljZS5jb25maWcuaG9zdFByZWZpeEVuYWJsZWQ7CiAgaWYgKCFlbmFibGVkKSByZXR1cm4gcmVxdWVzdDsKICB2YXIgb3BlcmF0aW9uTW9kZWwgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogIC8vZG9uJ3QgbWFyc2hhbCBob3N0IHByZWZpeCB3aGVuIG9wZXJhdGlvbiBoYXMgZW5kcG9pbnQgZGlzY292ZXJ5IHRyYWl0cwogIGlmIChoYXNFbmRwb2ludERpc2NvdmVyKHJlcXVlc3QpKSByZXR1cm4gcmVxdWVzdDsKICBpZiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQgJiYgb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeCkgewogICAgdmFyIGhvc3RQcmVmaXhOb3RhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50Lmhvc3RQcmVmaXg7CiAgICB2YXIgaG9zdFByZWZpeCA9IGV4cGFuZEhvc3RQcmVmaXgoaG9zdFByZWZpeE5vdGF0aW9uLCByZXF1ZXN0LnBhcmFtcywgb3BlcmF0aW9uTW9kZWwuaW5wdXQpOwogICAgcHJlcGVuZEVuZHBvaW50UHJlZml4KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQsIGhvc3RQcmVmaXgpOwogICAgdmFsaWRhdGVIb3N0bmFtZShyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3RuYW1lKTsKICB9CiAgcmV0dXJuIHJlcXVlc3Q7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGhhc0VuZHBvaW50RGlzY292ZXIocmVxdWVzdCkgewogIHZhciBhcGkgPSByZXF1ZXN0LnNlcnZpY2UuYXBpOwogIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICB2YXIgaXNFbmRwb2ludE9wZXJhdGlvbiA9IGFwaS5lbmRwb2ludE9wZXJhdGlvbiAmJiAoYXBpLmVuZHBvaW50T3BlcmF0aW9uID09PSB1dGlsLnN0cmluZy5sb3dlckZpcnN0KG9wZXJhdGlvbk1vZGVsLm5hbWUpKTsKICByZXR1cm4gKG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgIT09ICdOVUxMJyB8fCBpc0VuZHBvaW50T3BlcmF0aW9uID09PSB0cnVlKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gZXhwYW5kSG9zdFByZWZpeChob3N0UHJlZml4Tm90YXRpb24sIHBhcmFtcywgc2hhcGUpIHsKICB1dGlsLmVhY2goc2hhcGUubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICBpZiAobWVtYmVyLmhvc3RMYWJlbCA9PT0gdHJ1ZSkgewogICAgICBpZiAodHlwZW9mIHBhcmFtc1tuYW1lXSAhPT0gJ3N0cmluZycgfHwgcGFyYW1zW25hbWVdID09PSAnJykgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIG1lc3NhZ2U6ICdQYXJhbWV0ZXIgJyArIG5hbWUgKyAnIHNob3VsZCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcuJywKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkUGFyYW1ldGVyJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoJ1xceycgKyBuYW1lICsgJ1xcfScsICdnJyk7CiAgICAgIGhvc3RQcmVmaXhOb3RhdGlvbiA9IGhvc3RQcmVmaXhOb3RhdGlvbi5yZXBsYWNlKHJlZ2V4LCBwYXJhbXNbbmFtZV0pOwogICAgfQogIH0pOwogIHJldHVybiBob3N0UHJlZml4Tm90YXRpb247Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHByZXBlbmRFbmRwb2ludFByZWZpeChlbmRwb2ludCwgcHJlZml4KSB7CiAgaWYgKGVuZHBvaW50Lmhvc3QpIHsKICAgIGVuZHBvaW50Lmhvc3QgPSBwcmVmaXggKyBlbmRwb2ludC5ob3N0OwogIH0KICBpZiAoZW5kcG9pbnQuaG9zdG5hbWUpIHsKICAgIGVuZHBvaW50Lmhvc3RuYW1lID0gcHJlZml4ICsgZW5kcG9pbnQuaG9zdG5hbWU7CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiB2YWxpZGF0ZUhvc3RuYW1lKGhvc3RuYW1lKSB7CiAgdmFyIGxhYmVscyA9IGhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgLy9SZWZlcmVuY2U6IGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMxMTIzI3NlY3Rpb24tMgogIHZhciBob3N0UGF0dGVybiA9IC9eW2EtekEtWjAtOV17MX0kfF5bYS16QS1aMC05XVthLXpBLVowLTlcLV0qW2EtekEtWjAtOV0kLzsKICB1dGlsLmFycmF5RWFjaChsYWJlbHMsIGZ1bmN0aW9uKGxhYmVsKSB7CiAgICBpZiAoIWxhYmVsLmxlbmd0aCB8fCBsYWJlbC5sZW5ndGggPCAxIHx8IGxhYmVsLmxlbmd0aCA+IDYzKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywKICAgICAgICBtZXNzYWdlOiAnSG9zdG5hbWUgbGFiZWwgbGVuZ3RoIHNob3VsZCBiZSBiZXR3ZWVuIDEgdG8gNjMgY2hhcmFjdGVycywgaW5jbHVzaXZlLicKICAgICAgfSk7CiAgICB9CiAgICBpZiAoIWhvc3RQYXR0ZXJuLnRlc3QobGFiZWwpKSB7CiAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgIHtjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywgbWVzc2FnZTogbGFiZWwgKyAnIGlzIG5vdCBob3N0bmFtZSBjb21wYXRpYmxlLid9KTsKICAgIH0KICB9KTsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgcG9wdWxhdGVIb3N0UHJlZml4OiBwb3B1bGF0ZUhvc3RQcmVmaXgKfTsKCn0seyIuLi9jb3JlIjoxOSwiLi4vdXRpbCI6NzJ9XSw0NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgSnNvbkJ1aWxkZXIgPSByZXF1aXJlKCcuLi9qc29uL2J1aWxkZXInKTsKdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwp2YXIgcG9wdWxhdGVIb3N0UHJlZml4ID0gcmVxdWlyZSgnLi9oZWxwZXJzJykucG9wdWxhdGVIb3N0UHJlZml4OwoKZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogIHZhciBodHRwUmVxdWVzdCA9IHJlcS5odHRwUmVxdWVzdDsKICB2YXIgYXBpID0gcmVxLnNlcnZpY2UuYXBpOwogIHZhciB0YXJnZXQgPSBhcGkudGFyZ2V0UHJlZml4ICsgJy4nICsgYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ubmFtZTsKICB2YXIgdmVyc2lvbiA9IGFwaS5qc29uVmVyc2lvbiB8fCAnMS4wJzsKICB2YXIgaW5wdXQgPSBhcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICB2YXIgYnVpbGRlciA9IG5ldyBKc29uQnVpbGRlcigpOwoKICBpZiAodmVyc2lvbiA9PT0gMSkgdmVyc2lvbiA9ICcxLjAnOwogIGh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMgfHwge30sIGlucHV0KTsKICBodHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LWFtei1qc29uLScgKyB2ZXJzaW9uOwogIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LVRhcmdldCddID0gdGFyZ2V0OwoKICBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxKTsKfQoKZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICB2YXIgZXJyb3IgPSB7fTsKICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcC5odHRwUmVzcG9uc2U7CgogIGVycm9yLmNvZGUgPSBodHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLWVycm9ydHlwZSddIHx8ICdVbmtub3duRXJyb3InOwogIGlmICh0eXBlb2YgZXJyb3IuY29kZSA9PT0gJ3N0cmluZycpIHsKICAgIGVycm9yLmNvZGUgPSBlcnJvci5jb2RlLnNwbGl0KCc6JylbMF07CiAgfQoKICBpZiAoaHR0cFJlc3BvbnNlLmJvZHkubGVuZ3RoID4gMCkgewogICAgdHJ5IHsKICAgICAgdmFyIGUgPSBKU09OLnBhcnNlKGh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkpOwogICAgICB2YXIgY29kZSA9IGUuX190eXBlIHx8IGUuY29kZSB8fCBlLkNvZGU7CiAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgZXJyb3IuY29kZSA9IGNvZGUuc3BsaXQoJyMnKS5wb3AoKTsKICAgICAgfQogICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ1JlcXVlc3RFbnRpdHlUb29MYXJnZScpIHsKICAgICAgICBlcnJvci5tZXNzYWdlID0gJ1JlcXVlc3QgYm9keSBtdXN0IGJlIGxlc3MgdGhhbiAxIE1CJzsKICAgICAgfSBlbHNlIHsKICAgICAgICBlcnJvci5tZXNzYWdlID0gKGUubWVzc2FnZSB8fCBlLk1lc3NhZ2UgfHwgbnVsbCk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICBlcnJvci5tZXNzYWdlID0gaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2U7CiAgICB9CiAgfSBlbHNlIHsKICAgIGVycm9yLnN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZS50b1N0cmluZygpOwogIH0KCiAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIGVycm9yKTsKfQoKZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpIHx8ICd7fSc7CiAgaWYgKHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jb252ZXJ0UmVzcG9uc2VUeXBlcyA9PT0gZmFsc2UpIHsKICAgIHJlc3AuZGF0YSA9IEpTT04ucGFyc2UoYm9keSk7CiAgfSBlbHNlIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXNwLnJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXNwLnJlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBzaGFwZSA9IG9wZXJhdGlvbi5vdXRwdXQgfHwge307CiAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgIHJlc3AuZGF0YSA9IHBhcnNlci5wYXJzZShib2R5LCBzaGFwZSk7CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKfTsKCn0seyIuLi9qc29uL2J1aWxkZXIiOjM3LCIuLi9qc29uL3BhcnNlciI6MzgsIi4uL3V0aWwiOjcyLCIuL2hlbHBlcnMiOjQ2fV0sNDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIFF1ZXJ5UGFyYW1TZXJpYWxpemVyID0gcmVxdWlyZSgnLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplcicpOwp2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwp2YXIgcG9wdWxhdGVIb3N0UHJlZml4ID0gcmVxdWlyZSgnLi9oZWxwZXJzJykucG9wdWxhdGVIb3N0UHJlZml4OwoKZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICB2YXIgaHR0cFJlcXVlc3QgPSByZXEuaHR0cFJlcXVlc3Q7CiAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPQogICAgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD11dGYtOCc7CiAgaHR0cFJlcXVlc3QucGFyYW1zID0gewogICAgVmVyc2lvbjogcmVxLnNlcnZpY2UuYXBpLmFwaVZlcnNpb24sCiAgICBBY3Rpb246IG9wZXJhdGlvbi5uYW1lCiAgfTsKCiAgLy8gY29udmVydCB0aGUgcmVxdWVzdCBwYXJhbWV0ZXJzIGludG8gYSBsaXN0IG9mIHF1ZXJ5IHBhcmFtcywKICAvLyBlLmcuIERlZXBseS5OZXN0ZWRQYXJhbS4wLk5hbWU9dmFsdWUKICB2YXIgYnVpbGRlciA9IG5ldyBRdWVyeVBhcmFtU2VyaWFsaXplcigpOwogIGJ1aWxkZXIuc2VyaWFsaXplKHJlcS5wYXJhbXMsIG9wZXJhdGlvbi5pbnB1dCwgZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIGh0dHBSZXF1ZXN0LnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogIH0pOwogIGh0dHBSZXF1ZXN0LmJvZHkgPSB1dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcoaHR0cFJlcXVlc3QucGFyYW1zKTsKCiAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7Cn0KCmZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgdmFyIGRhdGEsIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCk7CiAgaWYgKGJvZHkubWF0Y2goJzxVbmtub3duT3BlcmF0aW9uRXhjZXB0aW9uJykpIHsKICAgIGRhdGEgPSB7CiAgICAgIENvZGU6ICdVbmtub3duT3BlcmF0aW9uJywKICAgICAgTWVzc2FnZTogJ1Vua25vd24gb3BlcmF0aW9uICcgKyByZXNwLnJlcXVlc3Qub3BlcmF0aW9uCiAgICB9OwogIH0gZWxzZSB7CiAgICB0cnkgewogICAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UoYm9keSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBNZXNzYWdlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlCiAgICAgIH07CiAgICB9CiAgfQoKICBpZiAoZGF0YS5yZXF1ZXN0SWQgJiYgIXJlc3AucmVxdWVzdElkKSByZXNwLnJlcXVlc3RJZCA9IGRhdGEucmVxdWVzdElkOwogIGlmIChkYXRhLkVycm9ycykgZGF0YSA9IGRhdGEuRXJyb3JzOwogIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICBpZiAoZGF0YS5Db2RlKSB7CiAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgIG1lc3NhZ2U6IGRhdGEuTWVzc2FnZQogICAgfSk7CiAgfSBlbHNlIHsKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgIGNvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgIG1lc3NhZ2U6IG51bGwKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHZhciBzaGFwZSA9IG9wZXJhdGlvbi5vdXRwdXQgfHwge307CiAgdmFyIG9yaWdSdWxlcyA9IHNoYXBlOwoKICBpZiAob3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXIpIHsKICAgIHZhciB0bXAgPSBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSk7CiAgICB0bXAubWVtYmVyc1tvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0gPSBzaGFwZTsKICAgIHRtcC5tZW1iZXJOYW1lcyA9IFtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl07CiAgICB1dGlsLnByb3BlcnR5KHNoYXBlLCAnbmFtZScsIHNoYXBlLnJlc3VsdFdyYXBwZXIpOwogICAgc2hhcGUgPSB0bXA7CiAgfQoKICB2YXIgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CgogIC8vIFRPRE86IFJlZmFjdG9yIFhNTCBQYXJzZXIgdG8gcGFyc2UgUmVxdWVzdElkIGZyb20gcmVzcG9uc2UuCiAgaWYgKHNoYXBlICYmIHNoYXBlLm1lbWJlcnMgJiYgIXNoYXBlLm1lbWJlcnMuX1hBTVpSZXF1ZXN0SWQpIHsKICAgIHZhciByZXF1ZXN0SWRTaGFwZSA9IFNoYXBlLmNyZWF0ZSgKICAgICAgeyB0eXBlOiAnc3RyaW5nJyB9LAogICAgICB7IGFwaTogeyBwcm90b2NvbDogJ3F1ZXJ5JyB9IH0sCiAgICAgICdyZXF1ZXN0SWQnCiAgICApOwogICAgc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCA9IHJlcXVlc3RJZFNoYXBlOwogIH0KCiAgdmFyIGRhdGEgPSBwYXJzZXIucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpLCBzaGFwZSk7CiAgcmVzcC5yZXF1ZXN0SWQgPSBkYXRhLl9YQU1aUmVxdWVzdElkIHx8IGRhdGEucmVxdWVzdElkOwoKICBpZiAoZGF0YS5fWEFNWlJlcXVlc3RJZCkgZGVsZXRlIGRhdGEuX1hBTVpSZXF1ZXN0SWQ7CgogIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgaWYgKGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdKSB7CiAgICAgIHV0aWwudXBkYXRlKGRhdGEsIGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdKTsKICAgICAgZGVsZXRlIGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdOwogICAgfQogIH0KCiAgcmVzcC5kYXRhID0gZGF0YTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCn07Cgp9LHsiLi4vY29yZSI6MTksIi4uL21vZGVsL3NoYXBlIjo0NCwiLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplciI6NTIsIi4uL3V0aWwiOjcyLCIuL2hlbHBlcnMiOjQ2fV0sNDk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKCmZ1bmN0aW9uIHBvcHVsYXRlTWV0aG9kKHJlcSkgewogIHJlcS5odHRwUmVxdWVzdC5tZXRob2QgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5odHRwTWV0aG9kOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZVVSSShlbmRwb2ludFBhdGgsIG9wZXJhdGlvblBhdGgsIGlucHV0LCBwYXJhbXMpIHsKICB2YXIgdXJpID0gW2VuZHBvaW50UGF0aCwgb3BlcmF0aW9uUGF0aF0uam9pbignLycpOwogIHVyaSA9IHVyaS5yZXBsYWNlKC9cLysvZywgJy8nKTsKCiAgdmFyIHF1ZXJ5U3RyaW5nID0ge30sIHF1ZXJ5U3RyaW5nU2V0ID0gZmFsc2U7CiAgdXRpbC5lYWNoKGlucHV0Lm1lbWJlcnMsIGZ1bmN0aW9uIChuYW1lLCBtZW1iZXIpIHsKICAgIHZhciBwYXJhbVZhbHVlID0gcGFyYW1zW25hbWVdOwogICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwgfHwgcGFyYW1WYWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAndXJpJykgewogICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdcXHsnICsgbWVtYmVyLm5hbWUgKyAnKFxcKyk/XFx9Jyk7CiAgICAgIHVyaSA9IHVyaS5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihfLCBwbHVzKSB7CiAgICAgICAgdmFyIGZuID0gcGx1cyA/IHV0aWwudXJpRXNjYXBlUGF0aCA6IHV0aWwudXJpRXNjYXBlOwogICAgICAgIHJldHVybiBmbihTdHJpbmcocGFyYW1WYWx1ZSkpOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAncXVlcnlzdHJpbmcnKSB7CiAgICAgIHF1ZXJ5U3RyaW5nU2V0ID0gdHJ1ZTsKCiAgICAgIGlmIChtZW1iZXIudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgICAgcXVlcnlTdHJpbmdbbWVtYmVyLm5hbWVdID0gcGFyYW1WYWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUobWVtYmVyLm1lbWJlci50b1dpcmVGb3JtYXQodmFsKS50b1N0cmluZygpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICB1dGlsLmVhY2gocGFyYW1WYWx1ZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSB2YWx1ZS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHV0aWwudXJpRXNjYXBlKFN0cmluZyh2YWwpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbHVlKSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcXVlcnlTdHJpbmdbbWVtYmVyLm5hbWVdID0gdXRpbC51cmlFc2NhcGUobWVtYmVyLnRvV2lyZUZvcm1hdChwYXJhbVZhbHVlKS50b1N0cmluZygpKTsKICAgICAgfQogICAgfQogIH0pOwoKICBpZiAocXVlcnlTdHJpbmdTZXQpIHsKICAgIHVyaSArPSAodXJpLmluZGV4T2YoJz8nKSA+PSAwID8gJyYnIDogJz8nKTsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgdXRpbC5hcnJheUVhY2goT2JqZWN0LmtleXMocXVlcnlTdHJpbmcpLnNvcnQoKSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShxdWVyeVN0cmluZ1trZXldKSkgewogICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSBbcXVlcnlTdHJpbmdba2V5XV07CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWVyeVN0cmluZ1trZXldLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcGFydHMucHVzaCh1dGlsLnVyaUVzY2FwZShTdHJpbmcoa2V5KSkgKyAnPScgKyBxdWVyeVN0cmluZ1trZXldW2ldKTsKICAgICAgfQogICAgfSk7CiAgICB1cmkgKz0gcGFydHMuam9pbignJicpOwogIH0KCiAgcmV0dXJuIHVyaTsKfQoKZnVuY3Rpb24gcG9wdWxhdGVVUkkocmVxKSB7CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHZhciBpbnB1dCA9IG9wZXJhdGlvbi5pbnB1dDsKCiAgdmFyIHVyaSA9IGdlbmVyYXRlVVJJKHJlcS5odHRwUmVxdWVzdC5lbmRwb2ludC5wYXRoLCBvcGVyYXRpb24uaHR0cFBhdGgsIGlucHV0LCByZXEucGFyYW1zKTsKICByZXEuaHR0cFJlcXVlc3QucGF0aCA9IHVyaTsKfQoKZnVuY3Rpb24gcG9wdWxhdGVIZWFkZXJzKHJlcSkgewogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICB1dGlsLmVhY2gob3BlcmF0aW9uLmlucHV0Lm1lbWJlcnMsIGZ1bmN0aW9uIChuYW1lLCBtZW1iZXIpIHsKICAgIHZhciB2YWx1ZSA9IHJlcS5wYXJhbXNbbmFtZV07CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwoKICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXJzJyAmJiBtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgdXRpbC5lYWNoKHZhbHVlLCBmdW5jdGlvbihrZXksIG1lbWJlclZhbHVlKSB7CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWUgKyBrZXldID0gbWVtYmVyVmFsdWU7CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgIHZhbHVlID0gbWVtYmVyLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKTsKICAgICAgaWYgKG1lbWJlci5pc0pzb25WYWx1ZSkgewogICAgICAgIHZhbHVlID0gdXRpbC5iYXNlNjQuZW5jb2RlKHZhbHVlKTsKICAgICAgfQogICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1ttZW1iZXIubmFtZV0gPSB2YWx1ZTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogIHBvcHVsYXRlTWV0aG9kKHJlcSk7CiAgcG9wdWxhdGVVUkkocmVxKTsKICBwb3B1bGF0ZUhlYWRlcnMocmVxKTsKICBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxKTsKfQoKZnVuY3Rpb24gZXh0cmFjdEVycm9yKCkgewp9CgpmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICB2YXIgZGF0YSA9IHt9OwogIHZhciByID0gcmVzcC5odHRwUmVzcG9uc2U7CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwoKICAvLyBub3JtYWxpemUgaGVhZGVycyBuYW1lcyB0byBsb3dlci1jYXNlZCBrZXlzIGZvciBtYXRjaGluZwogIHZhciBoZWFkZXJzID0ge307CiAgdXRpbC5lYWNoKHIuaGVhZGVycywgZnVuY3Rpb24gKGssIHYpIHsKICAgIGhlYWRlcnNbay50b0xvd2VyQ2FzZSgpXSA9IHY7CiAgfSk7CgogIHV0aWwuZWFjaChvdXRwdXQubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICB2YXIgaGVhZGVyID0gKG1lbWJlci5uYW1lIHx8IG5hbWUpLnRvTG93ZXJDYXNlKCk7CiAgICBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVycycgJiYgbWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgIGRhdGFbbmFtZV0gPSB7fTsKICAgICAgdmFyIGxvY2F0aW9uID0gbWVtYmVyLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyLm5hbWUgOiAnJzsKICAgICAgdmFyIHBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeJyArIGxvY2F0aW9uICsgJyguKyknLCAnaScpOwogICAgICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgICAgIHZhciByZXN1bHQgPSBrLm1hdGNoKHBhdHRlcm4pOwogICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwpIHsKICAgICAgICAgIGRhdGFbbmFtZV1bcmVzdWx0WzFdXSA9IHY7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICBpZiAoaGVhZGVyc1toZWFkZXJdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgdmFsdWUgPSBtZW1iZXIuaXNKc29uVmFsdWUgPwogICAgICAgICAgdXRpbC5iYXNlNjQuZGVjb2RlKGhlYWRlcnNbaGVhZGVyXSkgOgogICAgICAgICAgaGVhZGVyc1toZWFkZXJdOwogICAgICAgIGRhdGFbbmFtZV0gPSBtZW1iZXIudG9UeXBlKHZhbHVlKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdzdGF0dXNDb2RlJykgewogICAgICBkYXRhW25hbWVdID0gcGFyc2VJbnQoci5zdGF0dXNDb2RlLCAxMCk7CiAgICB9CiAgfSk7CgogIHJlc3AuZGF0YSA9IGRhdGE7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YSwKICBnZW5lcmF0ZVVSSTogZ2VuZXJhdGVVUkkKfTsKCn0seyIuLi91dGlsIjo3MiwiLi9oZWxwZXJzIjo0Nn1dLDUwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CnZhciBKc29uID0gcmVxdWlyZSgnLi9qc29uJyk7CnZhciBKc29uQnVpbGRlciA9IHJlcXVpcmUoJy4uL2pzb24vYnVpbGRlcicpOwp2YXIgSnNvblBhcnNlciA9IHJlcXVpcmUoJy4uL2pzb24vcGFyc2VyJyk7CgpmdW5jdGlvbiBwb3B1bGF0ZUJvZHkocmVxKSB7CiAgdmFyIGJ1aWxkZXIgPSBuZXcgSnNvbkJ1aWxkZXIoKTsKICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKCiAgaWYgKGlucHV0LnBheWxvYWQpIHsKICAgIHZhciBwYXJhbXMgPSB7fTsKICAgIHZhciBwYXlsb2FkU2hhcGUgPSBpbnB1dC5tZW1iZXJzW2lucHV0LnBheWxvYWRdOwogICAgcGFyYW1zID0gcmVxLnBhcmFtc1tpbnB1dC5wYXlsb2FkXTsKCiAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci5idWlsZChwYXJhbXMgfHwge30sIHBheWxvYWRTaGFwZSk7CiAgICAgIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxKTsKICAgIH0gZWxzZSBpZiAocGFyYW1zICE9PSB1bmRlZmluZWQpIHsKICAgICAgLy8gbm9uLUpTT04gcGF5bG9hZAogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IHBhcmFtczsKICAgICAgaWYgKHBheWxvYWRTaGFwZS50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkU2hhcGUuaXNTdHJlYW1pbmcpIHsKICAgICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgdHJ1ZSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMsIGlucHV0KTsKICAgIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxKTsKICB9Cn0KCmZ1bmN0aW9uIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxLCBpc0JpbmFyeSkgewogIGlmICghcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICB2YXIgdHlwZSA9IGlzQmluYXJ5ID8gJ2JpbmFyeS9vY3RldC1zdHJlYW0nIDogJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gdHlwZTsKICB9Cn0KCmZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICBSZXN0LmJ1aWxkUmVxdWVzdChyZXEpOwoKICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBHRVQvSEVBRC9ERUxFVEUKICBpZiAoWydHRVQnLCAnSEVBRCcsICdERUxFVEUnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgcG9wdWxhdGVCb2R5KHJlcSk7CiAgfQp9CgpmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogIEpzb24uZXh0cmFjdEVycm9yKHJlc3ApOwp9CgpmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgUmVzdC5leHRyYWN0RGF0YShyZXNwKTsKCiAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ub3V0cHV0IHx8IHt9OwogIHZhciBwYXJzZXI7CiAgdmFyIGhhc0V2ZW50T3V0cHV0ID0gb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0OwoKICBpZiAocnVsZXMucGF5bG9hZCkgewogICAgdmFyIHBheWxvYWRNZW1iZXIgPSBydWxlcy5tZW1iZXJzW3J1bGVzLnBheWxvYWRdOwogICAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5OwogICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyID8gcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtIDogYm9keSwKICAgICAgICBwYXJzZXIsCiAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICApOwogICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnIHx8IHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgIHZhciBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXJzZXIucGFyc2UoYm9keSwgcGF5bG9hZE1lbWJlcik7CiAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBib2R5OwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcGF5bG9hZE1lbWJlci50b1R5cGUoYm9keSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBkYXRhID0gcmVzcC5kYXRhOwogICAgSnNvbi5leHRyYWN0RGF0YShyZXNwKTsKICAgIHJlc3AuZGF0YSA9IHV0aWwubWVyZ2UoZGF0YSwgcmVzcC5kYXRhKTsKICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQp9OwoKfSx7Ii4uL2pzb24vYnVpbGRlciI6MzcsIi4uL2pzb24vcGFyc2VyIjozOCwiLi4vdXRpbCI6NzIsIi4vanNvbiI6NDcsIi4vcmVzdCI6NDl9XSw1MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgUmVzdCA9IHJlcXVpcmUoJy4vcmVzdCcpOwoKZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogIHZhciBpbnB1dCA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogIHZhciBidWlsZGVyID0gbmV3IEFXUy5YTUwuQnVpbGRlcigpOwogIHZhciBwYXJhbXMgPSByZXEucGFyYW1zOwoKICB2YXIgcGF5bG9hZCA9IGlucHV0LnBheWxvYWQ7CiAgaWYgKHBheWxvYWQpIHsKICAgIHZhciBwYXlsb2FkTWVtYmVyID0gaW5wdXQubWVtYmVyc1twYXlsb2FkXTsKICAgIHBhcmFtcyA9IHBhcmFtc1twYXlsb2FkXTsKICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwoKICAgIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgIHZhciByb290RWxlbWVudCA9IHBheWxvYWRNZW1iZXIubmFtZTsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLnRvWE1MKHBhcmFtcywgcGF5bG9hZE1lbWJlciwgcm9vdEVsZW1lbnQsIHRydWUpOwogICAgfSBlbHNlIHsgLy8gbm9uLXhtbCBwYXlsb2FkCiAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgfQogIH0gZWxzZSB7CiAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBpbnB1dCwgaW5wdXQubmFtZSB8fAogICAgICBpbnB1dC5zaGFwZSB8fCB1dGlsLnN0cmluZy51cHBlckZpcnN0KHJlcS5vcGVyYXRpb24pICsgJ1JlcXVlc3QnKTsKICB9Cn0KCmZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICBSZXN0LmJ1aWxkUmVxdWVzdChyZXEpOwoKICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBHRVQvSEVBRAogIGlmIChbJ0dFVCcsICdIRUFEJ10uaW5kZXhPZihyZXEuaHR0cFJlcXVlc3QubWV0aG9kKSA8IDApIHsKICAgIHBvcHVsYXRlQm9keShyZXEpOwogIH0KfQoKZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICBSZXN0LmV4dHJhY3RFcnJvcihyZXNwKTsKCiAgdmFyIGRhdGE7CiAgdHJ5IHsKICAgIGRhdGEgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKS5wYXJzZShyZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGRhdGEgPSB7CiAgICAgIENvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgIH07CiAgfQoKICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICBpZiAoZGF0YS5FcnJvcikgZGF0YSA9IGRhdGEuRXJyb3I7CiAgaWYgKGRhdGEuQ29kZSkgewogICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgY29kZTogZGF0YS5Db2RlLAogICAgICBtZXNzYWdlOiBkYXRhLk1lc3NhZ2UKICAgIH0pOwogIH0gZWxzZSB7CiAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICBtZXNzYWdlOiBudWxsCiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICBSZXN0LmV4dHJhY3REYXRhKHJlc3ApOwoKICB2YXIgcGFyc2VyOwogIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5OwogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICB2YXIgb3V0cHV0ID0gb3BlcmF0aW9uLm91dHB1dDsKCiAgdmFyIGhhc0V2ZW50T3V0cHV0ID0gb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0OwoKICB2YXIgcGF5bG9hZCA9IG91dHB1dC5wYXlsb2FkOwogIGlmIChwYXlsb2FkKSB7CiAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG91dHB1dC5tZW1iZXJzW3BheWxvYWRdOwogICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gdXRpbC5jcmVhdGVFdmVudFN0cmVhbSgKICAgICAgICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiA/IHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA6IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHksCiAgICAgICAgcGFyc2VyLAogICAgICAgIHBheWxvYWRNZW1iZXIKICAgICAgKTsKICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGFyc2VyLnBhcnNlKGJvZHkudG9TdHJpbmcoKSwgcGF5bG9hZE1lbWJlcik7CiAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSBib2R5OwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGF5bG9hZE1lbWJlci50b1R5cGUoYm9keSk7CiAgICB9CiAgfSBlbHNlIGlmIChib2R5Lmxlbmd0aCA+IDApIHsKICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgdmFyIGRhdGEgPSBwYXJzZXIucGFyc2UoYm9keS50b1N0cmluZygpLCBvdXRwdXQpOwogICAgdXRpbC51cGRhdGUocmVzcC5kYXRhLCBkYXRhKTsKICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQp9OwoKfSx7Ii4uL2NvcmUiOjE5LCIuLi91dGlsIjo3MiwiLi9yZXN0Ijo0OX1dLDUyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CgpmdW5jdGlvbiBRdWVyeVBhcmFtU2VyaWFsaXplcigpIHsKfQoKUXVlcnlQYXJhbVNlcmlhbGl6ZXIucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIGZuKSB7CiAgc2VyaWFsaXplU3RydWN0dXJlKCcnLCBwYXJhbXMsIHNoYXBlLCBmbik7Cn07CgpmdW5jdGlvbiB1Y2ZpcnN0KHNoYXBlKSB7CiAgaWYgKHNoYXBlLmlzUXVlcnlOYW1lIHx8IHNoYXBlLmFwaS5wcm90b2NvbCAhPT0gJ2VjMicpIHsKICAgIHJldHVybiBzaGFwZS5uYW1lOwogIH0gZWxzZSB7CiAgICByZXR1cm4gc2hhcGUubmFtZVswXS50b1VwcGVyQ2FzZSgpICsgc2hhcGUubmFtZS5zdWJzdHIoMSk7CiAgfQp9CgpmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUocHJlZml4LCBzdHJ1Y3QsIHJ1bGVzLCBmbikgewogIHV0aWwuZWFjaChydWxlcy5tZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgIHZhciB2YWx1ZSA9IHN0cnVjdFtuYW1lXTsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CgogICAgdmFyIG1lbWJlck5hbWUgPSB1Y2ZpcnN0KG1lbWJlcik7CiAgICBtZW1iZXJOYW1lID0gcHJlZml4ID8gcHJlZml4ICsgJy4nICsgbWVtYmVyTmFtZSA6IG1lbWJlck5hbWU7CiAgICBzZXJpYWxpemVNZW1iZXIobWVtYmVyTmFtZSwgdmFsdWUsIG1lbWJlciwgZm4pOwogIH0pOwp9CgpmdW5jdGlvbiBzZXJpYWxpemVNYXAobmFtZSwgbWFwLCBydWxlcywgZm4pIHsKICB2YXIgaSA9IDE7CiAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgIHZhciBwcmVmaXggPSBydWxlcy5mbGF0dGVuZWQgPyAnLicgOiAnLmVudHJ5Lic7CiAgICB2YXIgcG9zaXRpb24gPSBwcmVmaXggKyAoaSsrKSArICcuJzsKICAgIHZhciBrZXlOYW1lID0gcG9zaXRpb24gKyAocnVsZXMua2V5Lm5hbWUgfHwgJ2tleScpOwogICAgdmFyIHZhbHVlTmFtZSA9IHBvc2l0aW9uICsgKHJ1bGVzLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJyk7CiAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIGtleU5hbWUsIGtleSwgcnVsZXMua2V5LCBmbik7CiAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIHZhbHVlTmFtZSwgdmFsdWUsIHJ1bGVzLnZhbHVlLCBmbik7CiAgfSk7Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZUxpc3QobmFtZSwgbGlzdCwgcnVsZXMsIGZuKSB7CiAgdmFyIG1lbWJlclJ1bGVzID0gcnVsZXMubWVtYmVyIHx8IHt9OwoKICBpZiAobGlzdC5sZW5ndGggPT09IDApIHsKICAgIGZuLmNhbGwodGhpcywgbmFtZSwgbnVsbCk7CiAgICByZXR1cm47CiAgfQoKICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbiAodiwgbikgewogICAgdmFyIHN1ZmZpeCA9ICcuJyArIChuICsgMSk7CiAgICBpZiAocnVsZXMuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICAvLyBEbyBub3RoaW5nIGZvciBFQzIKICAgICAgc3VmZml4ID0gc3VmZml4ICsgJyc7IC8vIG1ha2UgbGludGVyIGhhcHB5CiAgICB9IGVsc2UgaWYgKHJ1bGVzLmZsYXR0ZW5lZCkgewogICAgICBpZiAobWVtYmVyUnVsZXMubmFtZSkgewogICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJy4nKTsKICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICBwYXJ0cy5wdXNoKHVjZmlyc3QobWVtYmVyUnVsZXMpKTsKICAgICAgICBuYW1lID0gcGFydHMuam9pbignLicpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzdWZmaXggPSAnLicgKyAobWVtYmVyUnVsZXMubmFtZSA/IG1lbWJlclJ1bGVzLm5hbWUgOiAnbWVtYmVyJykgKyBzdWZmaXg7CiAgICB9CiAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIHN1ZmZpeCwgdiwgbWVtYmVyUnVsZXMsIGZuKTsKICB9KTsKfQoKZnVuY3Rpb24gc2VyaWFsaXplTWVtYmVyKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pIHsKICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIGlmIChydWxlcy50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgc2VyaWFsaXplU3RydWN0dXJlKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICBzZXJpYWxpemVMaXN0KG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ21hcCcpIHsKICAgIHNlcmlhbGl6ZU1hcChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICB9IGVsc2UgewogICAgZm4obmFtZSwgcnVsZXMudG9XaXJlRm9ybWF0KHZhbHVlKS50b1N0cmluZygpKTsKICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gUXVlcnlQYXJhbVNlcmlhbGl6ZXI7Cgp9LHsiLi4vdXRpbCI6NzJ9XSw1MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gewogIC8vcHJvdmlkZSByZWFsdGltZSBjbG9jayBmb3IgcGVyZm9ybWFuY2UgbWVhc3VyZW1lbnQKICBub3c6IGZ1bmN0aW9uIG5vdygpIHsKICAgIGlmICh0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLm5vdygpOwogICAgfQogICAgcmV0dXJuIERhdGUubm93KCk7CiAgfQp9OwoKfSx7fV0sNTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpmdW5jdGlvbiBpc0ZpcHNSZWdpb24ocmVnaW9uKSB7CiAgcmV0dXJuIHR5cGVvZiByZWdpb24gPT09ICdzdHJpbmcnICYmIChyZWdpb24uc3RhcnRzV2l0aCgnZmlwcy0nKSB8fCByZWdpb24uZW5kc1dpdGgoJy1maXBzJykpOwp9CgpmdW5jdGlvbiBpc0dsb2JhbFJlZ2lvbihyZWdpb24pIHsKICByZXR1cm4gdHlwZW9mIHJlZ2lvbiA9PT0gJ3N0cmluZycgJiYgWydhd3MtZ2xvYmFsJywgJ2F3cy11cy1nb3YtZ2xvYmFsJ10uaW5jbHVkZXMocmVnaW9uKTsKfQoKZnVuY3Rpb24gZ2V0UmVhbFJlZ2lvbihyZWdpb24pIHsKICByZXR1cm4gWydmaXBzLWF3cy1nbG9iYWwnLCAnYXdzLWZpcHMnLCAnYXdzLWdsb2JhbCddLmluY2x1ZGVzKHJlZ2lvbikKICAgICAgPyAndXMtZWFzdC0xJwogICAgICA6IFsnZmlwcy1hd3MtdXMtZ292LWdsb2JhbCcsICdhd3MtdXMtZ292LWdsb2JhbCddLmluY2x1ZGVzKHJlZ2lvbikKICAgICAgPyAndXMtZ292LXdlc3QtMScKICAgICAgOiByZWdpb24ucmVwbGFjZSgvZmlwcy0oZGtyLXxwcm9kLSk/fC1maXBzLywgJycpOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBpc0ZpcHNSZWdpb246IGlzRmlwc1JlZ2lvbiwKICBpc0dsb2JhbFJlZ2lvbjogaXNHbG9iYWxSZWdpb24sCiAgZ2V0UmVhbFJlZ2lvbjogZ2V0UmVhbFJlZ2lvbgp9OwoKfSx7fV0sNTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwp2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbicpOwoKZnVuY3Rpb24gZ2VuZXJhdGVSZWdpb25QcmVmaXgocmVnaW9uKSB7CiAgaWYgKCFyZWdpb24pIHJldHVybiBudWxsOwogIHZhciBwYXJ0cyA9IHJlZ2lvbi5zcGxpdCgnLScpOwogIGlmIChwYXJ0cy5sZW5ndGggPCAzKSByZXR1cm4gbnVsbDsKICByZXR1cm4gcGFydHMuc2xpY2UoMCwgcGFydHMubGVuZ3RoIC0gMikuam9pbignLScpICsgJy0qJzsKfQoKZnVuY3Rpb24gZGVyaXZlZEtleXMoc2VydmljZSkgewogIHZhciByZWdpb24gPSBzZXJ2aWNlLmNvbmZpZy5yZWdpb247CiAgdmFyIHJlZ2lvblByZWZpeCA9IGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbik7CiAgdmFyIGVuZHBvaW50UHJlZml4ID0gc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXg7CgogIHJldHVybiBbCiAgICBbcmVnaW9uLCBlbmRwb2ludFByZWZpeF0sCiAgICBbcmVnaW9uUHJlZml4LCBlbmRwb2ludFByZWZpeF0sCiAgICBbcmVnaW9uLCAnKiddLAogICAgW3JlZ2lvblByZWZpeCwgJyonXSwKICAgIFsnKicsIGVuZHBvaW50UHJlZml4XSwKICAgIFsnKicsICcqJ10KICBdLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICByZXR1cm4gaXRlbVswXSAmJiBpdGVtWzFdID8gaXRlbS5qb2luKCcvJykgOiBudWxsOwogIH0pOwp9CgpmdW5jdGlvbiBhcHBseUNvbmZpZyhzZXJ2aWNlLCBjb25maWcpIHsKICB1dGlsLmVhY2goY29uZmlnLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICBpZiAoa2V5ID09PSAnZ2xvYmFsRW5kcG9pbnQnKSByZXR1cm47CiAgICBpZiAoc2VydmljZS5jb25maWdba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHNlcnZpY2UuY29uZmlnW2tleV0gPT09IG51bGwpIHsKICAgICAgc2VydmljZS5jb25maWdba2V5XSA9IHZhbHVlOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBjb25maWd1cmVFbmRwb2ludChzZXJ2aWNlKSB7CiAgdmFyIGtleXMgPSBkZXJpdmVkS2V5cyhzZXJ2aWNlKTsKICB2YXIgdXNlRmlwc0VuZHBvaW50ID0gc2VydmljZS5jb25maWcudXNlRmlwc0VuZHBvaW50OwogIHZhciB1c2VEdWFsc3RhY2tFbmRwb2ludCA9IHNlcnZpY2UuY29uZmlnLnVzZUR1YWxzdGFja0VuZHBvaW50OwogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgdmFyIGtleSA9IGtleXNbaV07CiAgICBpZiAoIWtleSkgY29udGludWU7CgogICAgdmFyIHJ1bGVzID0gdXNlRmlwc0VuZHBvaW50CiAgICAgID8gdXNlRHVhbHN0YWNrRW5kcG9pbnQKICAgICAgICA/IHJlZ2lvbkNvbmZpZy5kdWFsc3RhY2tGaXBzUnVsZXMKICAgICAgICA6IHJlZ2lvbkNvbmZpZy5maXBzUnVsZXMKICAgICAgOiB1c2VEdWFsc3RhY2tFbmRwb2ludAogICAgICA/IHJlZ2lvbkNvbmZpZy5kdWFsc3RhY2tSdWxlcwogICAgICA6IHJlZ2lvbkNvbmZpZy5ydWxlczsKCiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJ1bGVzLCBrZXkpKSB7CiAgICAgIHZhciBjb25maWcgPSBydWxlc1trZXldOwogICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICBjb25maWcgPSByZWdpb25Db25maWcucGF0dGVybnNbY29uZmlnXTsKICAgICAgfQoKICAgICAgLy8gc2V0IGdsb2JhbCBlbmRwb2ludAogICAgICBzZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQgPSAhIWNvbmZpZy5nbG9iYWxFbmRwb2ludDsKICAgICAgaWYgKGNvbmZpZy5zaWduaW5nUmVnaW9uKSB7CiAgICAgICAgc2VydmljZS5zaWduaW5nUmVnaW9uID0gY29uZmlnLnNpZ25pbmdSZWdpb247CiAgICAgIH0KCiAgICAgIC8vIHNpZ25hdHVyZSB2ZXJzaW9uCiAgICAgIGlmICghY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIGNvbmZpZy5zaWduYXR1cmVWZXJzaW9uID0gJ3Y0JzsKCiAgICAgIC8vIG1lcmdlIGNvbmZpZwogICAgICBhcHBseUNvbmZpZyhzZXJ2aWNlLCBjb25maWcpOwogICAgICByZXR1cm47CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBnZXRFbmRwb2ludFN1ZmZpeChyZWdpb24pIHsKICB2YXIgcmVnaW9uUmVnZXhlcyA9IHsKICAgICdeKHVzfGV1fGFwfHNhfGNhfG1lKVxcLVxcdytcXC1cXGQrJCc6ICdhbWF6b25hd3MuY29tJywKICAgICdeY25cXC1cXHcrXFwtXFxkKyQnOiAnYW1hem9uYXdzLmNvbS5jbicsCiAgICAnXnVzXFwtZ292XFwtXFx3K1xcLVxcZCskJzogJ2FtYXpvbmF3cy5jb20nLAogICAgJ151c1xcLWlzb1xcLVxcdytcXC1cXGQrJCc6ICdjMnMuaWMuZ292JywKICAgICdedXNcXC1pc29iXFwtXFx3K1xcLVxcZCskJzogJ3NjMnMuc2dvdi5nb3YnCiAgfTsKICB2YXIgZGVmYXVsdFN1ZmZpeCA9ICdhbWF6b25hd3MuY29tJzsKICB2YXIgcmVnZXhlcyA9IE9iamVjdC5rZXlzKHJlZ2lvblJlZ2V4ZXMpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnZXhlcy5sZW5ndGg7IGkrKykgewogICAgdmFyIHJlZ2lvblBhdHRlcm4gPSBSZWdFeHAocmVnZXhlc1tpXSk7CiAgICB2YXIgZG5zU3VmZml4ID0gcmVnaW9uUmVnZXhlc1tyZWdleGVzW2ldXTsKICAgIGlmIChyZWdpb25QYXR0ZXJuLnRlc3QocmVnaW9uKSkgcmV0dXJuIGRuc1N1ZmZpeDsKICB9CiAgcmV0dXJuIGRlZmF1bHRTdWZmaXg7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogIGNvbmZpZ3VyZUVuZHBvaW50OiBjb25maWd1cmVFbmRwb2ludCwKICBnZXRFbmRwb2ludFN1ZmZpeDogZ2V0RW5kcG9pbnRTdWZmaXgsCn07Cgp9LHsiLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbiI6NTYsIi4vdXRpbCI6NzJ9XSw1NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAicnVsZXMiOiB7CiAgICAiKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImNuLSovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tLmNuIgogICAgfSwKICAgICJ1cy1pc28tKi8qIjogInVzSXNvIiwKICAgICJ1cy1pc29iLSovKiI6ICJ1c0lzb2IiLAogICAgIiovYnVkZ2V0cyI6ICJnbG9iYWxTU0wiLAogICAgIiovY2xvdWRmcm9udCI6ICJnbG9iYWxTU0wiLAogICAgIiovc3RzIjogImdsb2JhbFNTTCIsCiAgICAiKi9pbXBvcnRleHBvcnQiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgfSwKCiAgICAiKi9yb3V0ZTUzIjogImdsb2JhbFNTTCIsCiAgICAiY24tKi9yb3V0ZTUzIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20uY24iLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlLAogICAgICAic2lnbmluZ1JlZ2lvbiI6ICJjbi1ub3J0aHdlc3QtMSIKICAgIH0sCiAgICAidXMtZ292LSovcm91dGU1MyI6ICJnbG9iYWxHb3ZDbG91ZCIsCiAgICAidXMtaXNvLSovcm91dGU1MyI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5jMnMuaWMuZ292IiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZSwKICAgICAgInNpZ25pbmdSZWdpb24iOiAidXMtaXNvLWVhc3QtMSIKICAgIH0sCiAgICAidXMtaXNvYi0qL3JvdXRlNTMiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uc2Mycy5zZ292LmdvdiIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUsCiAgICAgICJzaWduaW5nUmVnaW9uIjogInVzLWlzb2ItZWFzdC0xIgogICAgfSwKCiAgICAiKi93YWYiOiAiZ2xvYmFsU1NMIiwKCiAgICAiKi9pYW0iOiAiZ2xvYmFsU1NMIiwKICAgICJjbi0qL2lhbSI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5jbi1ub3J0aC0xLmFtYXpvbmF3cy5jb20uY24iLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlLAogICAgICAic2lnbmluZ1JlZ2lvbiI6ICJjbi1ub3J0aC0xIgogICAgfSwKICAgICJ1cy1nb3YtKi9pYW0iOiAiZ2xvYmFsR292Q2xvdWQiLAoKICAgICJ1cy1nb3YtKi9zdHMiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAidXMtZ292LXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAidXMtd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJ1cy13ZXN0LTIvczMiOiAiczNzaWduYXR1cmUiLAogICAgImV1LXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAiYXAtc291dGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgImFwLXNvdXRoZWFzdC0yL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJhcC1ub3J0aGVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAic2EtZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJ1cy1lYXN0LTEvczMiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInMzIgogICAgfSwKICAgICJ1cy1lYXN0LTEvc2RiIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIKICAgIH0sCiAgICAiKi9zZGIiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgfQogIH0sCgogICJmaXBzUnVsZXMiOiB7CiAgICAiKi8qIjogImZpcHNTdGFuZGFyZCIsCiAgICAidXMtZ292LSovKiI6ICJmaXBzU3RhbmRhcmQiLAogICAgInVzLWlzby0qLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy57cmVnaW9ufS5jMnMuaWMuZ292IgogICAgfSwKICAgICJ1cy1pc28tKi9kbXMiOiAidXNJc28iLAogICAgInVzLWlzb2ItKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMue3JlZ2lvbn0uc2Mycy5zZ292LmdvdiIKICAgIH0sCiAgICAidXMtaXNvYi0qL2RtcyI6ICJ1c0lzb2IiLAogICAgImNuLSovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICB9LAogICAgIiovYXBpLmVjciI6ICJmaXBzLmFwaS5lY3IiLAogICAgIiovYXBpLnNhZ2VtYWtlciI6ICJmaXBzLmFwaS5zYWdlbWFrZXIiLAogICAgIiovYmF0Y2giOiAiZmlwc0RvdFByZWZpeCIsCiAgICAiKi9la3MiOiAiZmlwc0RvdFByZWZpeCIsCiAgICAiKi9tb2RlbHMubGV4IjogImZpcHMubW9kZWxzLmxleCIsCiAgICAiKi9ydW50aW1lLmxleCI6ICJmaXBzLnJ1bnRpbWUubGV4IiwKICAgICIqL3J1bnRpbWUuc2FnZW1ha2VyIjogewogICAgICAiZW5kcG9pbnQiOiAicnVudGltZS1maXBzLnNhZ2VtYWtlci57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICIqL2lhbSI6ICJmaXBzV2l0aG91dFJlZ2lvbiIsCiAgICAiKi9yb3V0ZTUzIjogImZpcHNXaXRob3V0UmVnaW9uIiwKICAgICIqL3RyYW5zY3JpYmUiOiAiZmlwc0RvdFByZWZpeCIsCiAgICAiKi93YWYiOiAiZmlwc1dpdGhvdXRSZWdpb24iLAoKICAgICJ1cy1nb3YtKi90cmFuc2NyaWJlIjogImZpcHNEb3RQcmVmaXgiLAogICAgInVzLWdvdi0qL2FwaS5lY3IiOiAiZmlwcy5hcGkuZWNyIiwKICAgICJ1cy1nb3YtKi9hcGkuc2FnZW1ha2VyIjogImZpcHMuYXBpLnNhZ2VtYWtlciIsCiAgICAidXMtZ292LSovbW9kZWxzLmxleCI6ICJmaXBzLm1vZGVscy5sZXgiLAogICAgInVzLWdvdi0qL3J1bnRpbWUubGV4IjogImZpcHMucnVudGltZS5sZXgiLAogICAgInVzLWdvdi0qL2FjbS1wY2EiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovYmF0Y2giOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovY29uZmlnIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2VrcyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9lbGFzdGljbWFwcmVkdWNlIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2lkZW50aXR5c3RvcmUiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovZHluYW1vZGIiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovZWxhc3RpY2xvYWRiYWxhbmNpbmciOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovZ3VhcmRkdXR5IjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL21vbml0b3JpbmciOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovcmVzb3VyY2UtZ3JvdXBzIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL3J1bnRpbWUuc2FnZW1ha2VyIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL3NlcnZpY2VjYXRhbG9nLWFwcHJlZ2lzdHJ5IjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL3NlcnZpY2VxdW90YXMiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovc3NtIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL3N0cyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9zdXBwb3J0IjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi13ZXN0LTEvc3RhdGVzIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWlzby1lYXN0LTEvZWxhc3RpY2ZpbGVzeXN0ZW0iOiB7CiAgICAgICJlbmRwb2ludCI6ICJlbGFzdGljZmlsZXN5c3RlbS1maXBzLntyZWdpb259LmMycy5pYy5nb3YiCiAgICB9LAogICAgInVzLWdvdi13ZXN0LTEvb3JnYW5pemF0aW9ucyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3Ytd2VzdC0xL3JvdXRlNTMiOiB7CiAgICAgICJlbmRwb2ludCI6ICJyb3V0ZTUzLnVzLWdvdi5hbWF6b25hd3MuY29tIgogICAgfQogIH0sCgogICJkdWFsc3RhY2tSdWxlcyI6IHsKICAgICIqLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYXBpLmF3cyIKICAgIH0sCiAgICAiY24tKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFwaS5hbWF6b253ZWJzZXJ2aWNlcy5jb20uY24iCiAgICB9LAoKICAgICIqL3MzIjogImR1YWxzdGFja0xlZ2FjeSIsCiAgICAiY24tKi9zMyI6ICJkdWFsc3RhY2tMZWdhY3lDbiIsCiAgICAiKi9zMy1jb250cm9sIjogImR1YWxzdGFja0xlZ2FjeSIsCiAgICAiY24tKi9zMy1jb250cm9sIjogImR1YWxzdGFja0xlZ2FjeUNuIiwKCiAgICAiYXAtc291dGgtMS9lYzIiOiAiZHVhbHN0YWNrTGVnYWN5RWMyIiwKICAgICJldS13ZXN0LTEvZWMyIjogImR1YWxzdGFja0xlZ2FjeUVjMiIsCiAgICAic2EtZWFzdC0xL2VjMiI6ICJkdWFsc3RhY2tMZWdhY3lFYzIiLAogICAgInVzLWVhc3QtMS9lYzIiOiAiZHVhbHN0YWNrTGVnYWN5RWMyIiwKICAgICJ1cy1lYXN0LTIvZWMyIjogImR1YWxzdGFja0xlZ2FjeUVjMiIsCiAgICAidXMtd2VzdC0yL2VjMiI6ICJkdWFsc3RhY2tMZWdhY3lFYzIiCiAgfSwKCiAgImR1YWxzdGFja0ZpcHNSdWxlcyI6IHsKICAgICIqLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy57cmVnaW9ufS5hcGkuYXdzIgogICAgfSwKICAgICJjbi0qLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy57cmVnaW9ufS5hcGkuYW1hem9ud2Vic2VydmljZXMuY29tLmNuIgogICAgfSwKICAgICIqL3MzIjogImR1YWxzdGFja0ZpcHNMZWdhY3kiLAogICAgImNuLSovczMiOiAiZHVhbHN0YWNrRmlwc0xlZ2FjeUNuIiwKICAgICIqL3MzLWNvbnRyb2wiOiAiZHVhbHN0YWNrRmlwc0xlZ2FjeSIsCiAgICAiY24tKi9zMy1jb250cm9sIjogImR1YWxzdGFja0ZpcHNMZWdhY3lDbiIKICB9LAoKICAicGF0dGVybnMiOiB7CiAgICAiZ2xvYmFsU1NMIjogewogICAgICAiZW5kcG9pbnQiOiAiaHR0cHM6Ly97c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUsCiAgICAgICJzaWduaW5nUmVnaW9uIjogInVzLWVhc3QtMSIKICAgIH0sCiAgICAiZ2xvYmFsR292Q2xvdWQiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0udXMtZ292LmFtYXpvbmF3cy5jb20iLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlLAogICAgICAic2lnbmluZ1JlZ2lvbiI6ICJ1cy1nb3Ytd2VzdC0xIgogICAgfSwKICAgICJzM3NpZ25hdHVyZSI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICB9LAogICAgInVzSXNvIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmMycy5pYy5nb3YiCiAgICB9LAogICAgInVzSXNvYiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5zYzJzLnNnb3YuZ292IgogICAgfSwKICAgICJmaXBzU3RhbmRhcmQiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJmaXBzRG90UHJlZml4IjogewogICAgICAiZW5kcG9pbnQiOiAiZmlwcy57c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZmlwc1dpdGhvdXRSZWdpb24iOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJmaXBzLmFwaS5lY3IiOiB7CiAgICAgICJlbmRwb2ludCI6ICJlY3ItZmlwcy57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJmaXBzLmFwaS5zYWdlbWFrZXIiOiB7CiAgICAgICJlbmRwb2ludCI6ICJhcGktZmlwcy5zYWdlbWFrZXIue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZmlwcy5tb2RlbHMubGV4IjogewogICAgICAiZW5kcG9pbnQiOiAibW9kZWxzLWZpcHMubGV4LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImZpcHMucnVudGltZS5sZXgiOiB7CiAgICAgICJlbmRwb2ludCI6ICJydW50aW1lLWZpcHMubGV4LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImZpcHNXaXRoU2VydmljZU9ubHkiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZHVhbHN0YWNrTGVnYWN5IjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmR1YWxzdGFjay57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJkdWFsc3RhY2tMZWdhY3lDbiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5kdWFsc3RhY2sue3JlZ2lvbn0uYW1hem9uYXdzLmNvbS5jbiIKICAgIH0sCiAgICAiZHVhbHN0YWNrRmlwc0xlZ2FjeSI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLmR1YWxzdGFjay57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJkdWFsc3RhY2tGaXBzTGVnYWN5Q24iOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy5kdWFsc3RhY2sue3JlZ2lvbn0uYW1hem9uYXdzLmNvbS5jbiIKICAgIH0sCiAgICAiZHVhbHN0YWNrTGVnYWN5RWMyIjogewogICAgICAiZW5kcG9pbnQiOiAiYXBpLmVjMi57cmVnaW9ufS5hd3MiCiAgICB9CiAgfQp9Cgp9LHt9XSw1NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnZhciBBY2NlcHRvclN0YXRlTWFjaGluZSA9IHJlcXVpcmUoJy4vc3RhdGVfbWFjaGluZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CnZhciBkb21haW4gPSBBV1MudXRpbC5kb21haW47CnZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgaGFyZEVycm9yU3RhdGVzID0ge3N1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMX07CgpmdW5jdGlvbiBpc1Rlcm1pbmFsU3RhdGUobWFjaGluZSkgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaGFyZEVycm9yU3RhdGVzLCBtYWNoaW5lLl9hc20uY3VycmVudFN0YXRlKTsKfQoKdmFyIGZzbSA9IG5ldyBBY2NlcHRvclN0YXRlTWFjaGluZSgpOwpmc20uc2V0dXBTdGF0ZXMgPSBmdW5jdGlvbigpIHsKICB2YXIgdHJhbnNpdGlvbiA9IGZ1bmN0aW9uKF8sIGRvbmUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSBmYWxzZTsKCiAgICBzZWxmLmVtaXQoc2VsZi5fYXNtLmN1cnJlbnRTdGF0ZSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBpZiAoaXNUZXJtaW5hbFN0YXRlKHNlbGYpKSB7CiAgICAgICAgICBpZiAoZG9tYWluICYmIHNlbGYuZG9tYWluIGluc3RhbmNlb2YgZG9tYWluLkRvbWFpbikgewogICAgICAgICAgICBlcnIuZG9tYWluRW1pdHRlciA9IHNlbGY7CiAgICAgICAgICAgIGVyci5kb21haW4gPSBzZWxmLmRvbWFpbjsKICAgICAgICAgICAgZXJyLmRvbWFpblRocm93biA9IGZhbHNlOwogICAgICAgICAgICBzZWxmLmRvbWFpbi5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICBkb25lKGVycik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGRvbmUoc2VsZi5yZXNwb25zZS5lcnJvcik7CiAgICAgIH0KICAgIH0pOwoKICB9OwoKICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZScsICdidWlsZCcsICdlcnJvcicsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ2J1aWxkJywgJ2FmdGVyQnVpbGQnLCAncmVzdGFydCcsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ2FmdGVyQnVpbGQnLCAnc2lnbicsICdyZXN0YXJ0JywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnc2lnbicsICdzZW5kJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgncmV0cnknLCAnYWZ0ZXJSZXRyeScsICdhZnRlclJldHJ5JywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnYWZ0ZXJSZXRyeScsICdzaWduJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnc2VuZCcsICd2YWxpZGF0ZVJlc3BvbnNlJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgndmFsaWRhdGVSZXNwb25zZScsICdleHRyYWN0RGF0YScsICdleHRyYWN0RXJyb3InLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdleHRyYWN0RXJyb3InLCAnZXh0cmFjdERhdGEnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdleHRyYWN0RGF0YScsICdzdWNjZXNzJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgncmVzdGFydCcsICdidWlsZCcsICdlcnJvcicsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ3N1Y2Nlc3MnLCAnY29tcGxldGUnLCAnY29tcGxldGUnLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdlcnJvcicsICdjb21wbGV0ZScsICdjb21wbGV0ZScsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ2NvbXBsZXRlJywgbnVsbCwgbnVsbCwgdHJhbnNpdGlvbik7Cn07CmZzbS5zZXR1cFN0YXRlcygpOwoKLyoqCiAqICMjIEFzeW5jaHJvbm91cyBSZXF1ZXN0cwogKgogKiBBbGwgcmVxdWVzdHMgbWFkZSB0aHJvdWdoIHRoZSBTREsgYXJlIGFzeW5jaHJvbm91cyBhbmQgdXNlIGEKICogY2FsbGJhY2sgaW50ZXJmYWNlLiBFYWNoIHNlcnZpY2UgbWV0aG9kIHRoYXQga2lja3Mgb2ZmIGEgcmVxdWVzdAogKiByZXR1cm5zIGFuIGBBV1MuUmVxdWVzdGAgb2JqZWN0IHRoYXQgeW91IGNhbiB1c2UgdG8gcmVnaXN0ZXIKICogY2FsbGJhY2tzLgogKgogKiBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBzZXJ2aWNlIG1ldGhvZCByZXR1cm5zIHRoZSByZXF1ZXN0CiAqIG9iamVjdCBhcyAicmVxdWVzdCIsIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHJlZ2lzdGVyIGNhbGxiYWNrczoKICoKICogYGBgamF2YXNjcmlwdAogKiAvLyByZXF1ZXN0IGlzIGFuIEFXUy5SZXF1ZXN0IG9iamVjdAogKiB2YXIgcmVxdWVzdCA9IGVjMi5kZXNjcmliZUluc3RhbmNlcygpOwogKgogKiAvLyByZWdpc3RlciBjYWxsYmFja3Mgb24gcmVxdWVzdCB0byByZXRyaWV2ZSByZXNwb25zZSBkYXRhCiAqIHJlcXVlc3Qub24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbihyZXNwb25zZSkgewogKiAgIGNvbnNvbGUubG9nKHJlc3BvbnNlLmRhdGEpOwogKiB9KTsKICogYGBgCiAqCiAqIFdoZW4gYSByZXF1ZXN0IGlzIHJlYWR5IHRvIGJlIHNlbnQsIHRoZSB7c2VuZH0gbWV0aG9kIHNob3VsZAogKiBiZSBjYWxsZWQ6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogcmVxdWVzdC5zZW5kKCk7CiAqIGBgYAogKgogKiBTaW5jZSByZWdpc3RlcmVkIGNhbGxiYWNrcyBtYXkgb3IgbWF5IG5vdCBiZSBpZGVtcG90ZW50LCByZXF1ZXN0cyBzaG91bGQgb25seQogKiBiZSBzZW50IG9uY2UuIFRvIHBlcmZvcm0gdGhlIHNhbWUgb3BlcmF0aW9uIG11bHRpcGxlIHRpbWVzLCB5b3Ugd2lsbCBuZWVkIHRvCiAqIGNyZWF0ZSBtdWx0aXBsZSByZXF1ZXN0IG9iamVjdHMsIGVhY2ggd2l0aCBpdHMgb3duIHJlZ2lzdGVyZWQgY2FsbGJhY2tzLgogKgogKiAjIyBSZW1vdmluZyBEZWZhdWx0IExpc3RlbmVycyBmb3IgRXZlbnRzCiAqCiAqIFJlcXVlc3Qgb2JqZWN0cyBhcmUgYnVpbHQgd2l0aCBkZWZhdWx0IGxpc3RlbmVycyBmb3IgdGhlIHZhcmlvdXMgZXZlbnRzLAogKiBkZXBlbmRpbmcgb24gdGhlIHNlcnZpY2UgdHlwZS4gSW4gc29tZSBjYXNlcywgeW91IG1heSB3YW50IHRvIHJlbW92ZQogKiBzb21lIGJ1aWx0LWluIGxpc3RlbmVycyB0byBjdXN0b21pemUgYmVoYXZpb3VyLiBEb2luZyB0aGlzIHJlcXVpcmVzCiAqIGFjY2VzcyB0byB0aGUgYnVpbHQtaW4gbGlzdGVuZXIgZnVuY3Rpb25zLCB3aGljaCBhcmUgZXhwb3NlZCB0aHJvdWdoCiAqIHRoZSB7QVdTLkV2ZW50TGlzdGVuZXJzLkNvcmV9IG5hbWVzcGFjZS4gRm9yIGluc3RhbmNlLCB5b3UgbWF5CiAqIHdhbnQgdG8gY3VzdG9taXplIHRoZSBIVFRQIGhhbmRsZXIgdXNlZCB3aGVuIHNlbmRpbmcgYSByZXF1ZXN0LiBJbiB0aGlzCiAqIGNhc2UsIHlvdSBjYW4gcmVtb3ZlIHRoZSBidWlsdC1pbiBsaXN0ZW5lciBhc3NvY2lhdGVkIHdpdGggdGhlICdzZW5kJwogKiBldmVudCwgdGhlIHtBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5EfSBsaXN0ZW5lciBhbmQgYWRkIHlvdXIgb3duLgogKgogKiAjIyBNdWx0aXBsZSBDYWxsYmFja3MgYW5kIENoYWluaW5nCiAqCiAqIFlvdSBjYW4gcmVnaXN0ZXIgbXVsdGlwbGUgY2FsbGJhY2tzIG9uIGFueSByZXF1ZXN0IG9iamVjdC4gVGhlCiAqIGNhbGxiYWNrcyBjYW4gYmUgcmVnaXN0ZXJlZCBmb3IgZGlmZmVyZW50IGV2ZW50cywgb3IgYWxsIGZvciB0aGUKICogc2FtZSBldmVudC4gSW4gYWRkaXRpb24sIHlvdSBjYW4gY2hhaW4gY2FsbGJhY2sgcmVnaXN0cmF0aW9uLCBmb3IKICogZXhhbXBsZToKICoKICogYGBgamF2YXNjcmlwdAogKiByZXF1ZXN0LgogKiAgIG9uKCdzdWNjZXNzJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICogICAgIGNvbnNvbGUubG9nKCJTdWNjZXNzISIpOwogKiAgIH0pLgogKiAgIG9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycm9yLCByZXNwb25zZSkgewogKiAgICAgY29uc29sZS5sb2coIkVycm9yISIpOwogKiAgIH0pLgogKiAgIG9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAqICAgICBjb25zb2xlLmxvZygiQWx3YXlzISIpOwogKiAgIH0pLgogKiAgIHNlbmQoKTsKICogYGBgCiAqCiAqIFRoZSBhYm92ZSBleGFtcGxlIHdpbGwgcHJpbnQgZWl0aGVyICJTdWNjZXNzISBBbHdheXMhIiwgb3IgIkVycm9yISBBbHdheXMhIiwKICogZGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhlIHJlcXVlc3Qgc3VjY2VlZGVkIG9yIG5vdC4KICoKICogQCFhdHRyaWJ1dGUgaHR0cFJlcXVlc3QKICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIEhUVFAgUHJvcGVydGllcwogKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVxdWVzdF0gdGhlIHJhdyBIVFRQIHJlcXVlc3Qgb2JqZWN0CiAqICAgICBjb250YWluaW5nIHJlcXVlc3QgaGVhZGVycyBhbmQgYm9keSBpbmZvcm1hdGlvbgogKiAgICAgc2VudCBieSB0aGUgc2VydmljZS4KICoKICogQCFhdHRyaWJ1dGUgc3RhcnRUaW1lCiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogKiAgIEByZXR1cm4gW0RhdGVdIHRoZSB0aW1lIHRoYXQgdGhlIHJlcXVlc3Qgc3RhcnRlZAogKgogKiBAIWdyb3VwIFJlcXVlc3QgQnVpbGRpbmcgRXZlbnRzCiAqCiAqIEAhZXZlbnQgdmFsaWRhdGUocmVxdWVzdCkKICogICBUcmlnZ2VyZWQgd2hlbiBhIHJlcXVlc3QgaXMgYmVpbmcgdmFsaWRhdGVkLiBMaXN0ZW5lcnMKICogICBzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgdGhlIHJlcXVlc3Qgc2hvdWxkIG5vdCBiZSBzZW50LgogKiAgIEBwYXJhbSByZXF1ZXN0IFtSZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgYmVpbmcgc2VudAogKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFMKICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTgogKiAgIEBleGFtcGxlIEVuc3VyaW5nIHRoYXQgYSBjZXJ0YWluIHBhcmFtZXRlciBpcyBzZXQgYmVmb3JlIHNlbmRpbmcgYSByZXF1ZXN0CiAqICAgICB2YXIgcmVxID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAqICAgICByZXEub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGlmICghcmVxLnBhcmFtcy5Cb2R5Lm1hdGNoKC9eSGVsbG9ccy8pKSB7CiAqICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdCb2R5IG11c3Qgc3RhcnQgd2l0aCAiSGVsbG8gIicpOwogKiAgICAgICB9CiAqICAgICB9KTsKICogICAgIHJlcS5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAqCiAqIEAhZXZlbnQgYnVpbGQocmVxdWVzdCkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBwYXlsb2FkIGlzIGJlaW5nIGJ1aWx0LiBMaXN0ZW5lcnMKICogICBzaG91bGQgZmlsbCB0aGUgbmVjZXNzYXJ5IGluZm9ybWF0aW9uIHRvIHNlbmQgdGhlIHJlcXVlc3QKICogICBvdmVyIEhUVFAuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+dmFsaWRhdGUpCiAqICAgQGV4YW1wbGUgQWRkIGEgY3VzdG9tIEhUVFAgaGVhZGVyIHRvIGEgcmVxdWVzdAogKiAgICAgdmFyIHJlcSA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogKiAgICAgcmVxLm9uKCdidWlsZCcsIGZ1bmN0aW9uKCkgewogKiAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ3VzdG9tLUhlYWRlciddID0gJ3ZhbHVlJzsKICogICAgIH0pOwogKiAgICAgcmVxLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICoKICogQCFldmVudCBzaWduKHJlcXVlc3QpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgYmVpbmcgc2lnbmVkLiBMaXN0ZW5lcnMgc2hvdWxkCiAqICAgYWRkIHRoZSBjb3JyZWN0IGF1dGhlbnRpY2F0aW9uIGhlYWRlcnMgYW5kL29yIGFkanVzdCB0aGUgYm9keSwKICogICBkZXBlbmRpbmcgb24gdGhlIGF1dGhlbnRpY2F0aW9uIG1lY2hhbmlzbSBiZWluZyB1c2VkLgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnZhbGlkYXRlKQogKgogKiBAIWdyb3VwIFJlcXVlc3QgU2VuZGluZyBFdmVudHMKICoKICogQCFldmVudCBzZW5kKHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGlzIHJlYWR5IHRvIGJlIHNlbnQuIExpc3RlbmVycwogKiAgIHNob3VsZCBjYWxsIHRoZSB1bmRlcmx5aW5nIHRyYW5zcG9ydCBsYXllciB0byBpbml0aWF0ZQogKiAgIHRoZSBzZW5kaW5nIG9mIHRoZSByZXF1ZXN0LgogKiAgIEBwYXJhbSByZXNwb25zZSBbUmVzcG9uc2VdIHRoZSByZXNwb25zZSBvYmplY3QKICogICBAY29udGV4dCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IHRoYXQgd2FzIHNlbnQKICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQKICoKICogQCFldmVudCByZXRyeShyZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiBhIHJlcXVlc3QgZmFpbGVkIGFuZCBtaWdodCBuZWVkIHRvIGJlIHJldHJpZWQgb3IgcmVkaXJlY3RlZC4KICogICBJZiB0aGUgcmVzcG9uc2UgaXMgcmV0cnlhYmxlLCB0aGUgbGlzdGVuZXIgc2hvdWxkIHNldCB0aGUKICogICBgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlYCBwcm9wZXJ0eSB0byBgdHJ1ZWAsIGFuZCBvcHRpb25hbGx5IHNldAogKiAgIGByZXNwb25zZS5lcnJvci5yZXRyeURlbGF5YCB0byB0aGUgbWlsbGlzZWNvbmQgZGVsYXkgZm9yIHRoZSBuZXh0IGF0dGVtcHQuCiAqICAgSW4gdGhlIGNhc2Ugb2YgYSByZWRpcmVjdCwgYHJlc3BvbnNlLmVycm9yLnJlZGlyZWN0YCBzaG91bGQgYmUgc2V0IHRvCiAqICAgYHRydWVgIHdpdGggYHJldHJ5RGVsYXlgIHNldCB0byBhbiBvcHRpb25hbCBkZWxheSBvbiB0aGUgbmV4dCByZXF1ZXN0LgogKgogKiAgIElmIGEgbGlzdGVuZXIgZGVjaWRlcyB0aGF0IGEgcmVxdWVzdCBzaG91bGQgbm90IGJlIHJldHJpZWQsCiAqICAgaXQgc2hvdWxkIHNldCBib3RoIGByZXRyeWFibGVgIGFuZCBgcmVkaXJlY3RgIHRvIGZhbHNlLgogKgogKiAgIE5vdGUgdGhhdCBhIHJldHJ5YWJsZSBlcnJvciB3aWxsIGJlIHJldHJpZWQgYXQgbW9zdAogKiAgIHtBV1MuQ29uZmlnLm1heFJldHJpZXN9IHRpbWVzIChiYXNlZCBvbiB0aGUgc2VydmljZSBvYmplY3QncyBjb25maWcpLgogKiAgIFNpbWlsYXJseSwgYSByZXF1ZXN0IHRoYXQgaXMgcmVkaXJlY3RlZCB3aWxsIG9ubHkgcmVkaXJlY3QgYXQgbW9zdAogKiAgIHtBV1MuQ29uZmlnLm1heFJlZGlyZWN0c30gdGltZXMuCiAqCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGV4YW1wbGUgQWRkaW5nIGEgY3VzdG9tIHJldHJ5IGZvciBhIDQwNCByZXNwb25zZQogKiAgICAgcmVxdWVzdC5vbigncmV0cnknLCBmdW5jdGlvbihyZXNwb25zZSkgewogKiAgICAgICAvLyB0aGlzIHJlc291cmNlIGlzIG5vdCB5ZXQgYXZhaWxhYmxlLCB3YWl0IDEwIHNlY29uZHMgdG8gZ2V0IGl0IGFnYWluCiAqICAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDA0ICYmIHJlc3BvbnNlLmVycm9yKSB7CiAqICAgICAgICAgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsgICAvLyByZXRyeSB0aGlzIGVycm9yCiAqICAgICAgICAgcmVzcG9uc2UuZXJyb3IucmV0cnlEZWxheSA9IDEwMDAwOyAvLyB3YWl0IDEwIHNlY29uZHMKICogICAgICAgfQogKiAgICAgfSk7CiAqCiAqIEAhZ3JvdXAgRGF0YSBQYXJzaW5nIEV2ZW50cwogKgogKiBAIWV2ZW50IGV4dHJhY3RFcnJvcihyZXNwb25zZSkKICogICBUcmlnZ2VyZWQgb24gYWxsIG5vbi0yeHggcmVxdWVzdHMgc28gdGhhdCBsaXN0ZW5lcnMgY2FuIGV4dHJhY3QKICogICBlcnJvciBkZXRhaWxzIGZyb20gdGhlIHJlc3BvbnNlIGJvZHkuIExpc3RlbmVycyB0byB0aGlzIGV2ZW50CiAqICAgc2hvdWxkIHNldCB0aGUgYHJlc3BvbnNlLmVycm9yYCBwcm9wZXJ0eS4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQCFldmVudCBleHRyYWN0RGF0YShyZXNwb25zZSkKICogICBUcmlnZ2VyZWQgaW4gc3VjY2Vzc2Z1bCByZXF1ZXN0cyB0byBhbGxvdyBsaXN0ZW5lcnMgdG8KICogICBkZS1zZXJpYWxpemUgdGhlIHJlc3BvbnNlIGJvZHkgaW50byBgcmVzcG9uc2UuZGF0YWAuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEAhZ3JvdXAgQ29tcGxldGlvbiBFdmVudHMKICoKICogQCFldmVudCBzdWNjZXNzKHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkuCiAqICAgYHJlc3BvbnNlLmRhdGFgIHdpbGwgY29udGFpbiB0aGUgcmVzcG9uc2UgZGF0YSBhbmQKICogICBgcmVzcG9uc2UuZXJyb3JgIHdpbGwgYmUgbnVsbC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQCFldmVudCBlcnJvcihlcnJvciwgcmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzIGF0IGFueSBwb2ludCBkdXJpbmcgdGhlCiAqICAgcmVxdWVzdC4gYHJlc3BvbnNlLmVycm9yYCB3aWxsIGNvbnRhaW4gZGV0YWlscyBhYm91dCB0aGUgZXJyb3IKICogICB0aGF0IG9jY3VycmVkLiBgcmVzcG9uc2UuZGF0YWAgd2lsbCBiZSBudWxsLgogKiAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgY29udGFpbmluZyBkZXRhaWxzIGFib3V0CiAqICAgICB0aGUgZXJyb3IgdGhhdCBvY2N1cnJlZC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQCFldmVudCBjb21wbGV0ZShyZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbmV2ZXIgYSByZXF1ZXN0IGN5Y2xlIGNvbXBsZXRlcy4gYHJlc3BvbnNlLmVycm9yYAogKiAgIHNob3VsZCBiZSBjaGVja2VkLCBzaW5jZSB0aGUgcmVxdWVzdCBtYXkgaGF2ZSBmYWlsZWQuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEAhZ3JvdXAgSFRUUCBFdmVudHMKICoKICogQCFldmVudCBodHRwSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwb25zZSwgc3RhdHVzTWVzc2FnZSkKICogICBUcmlnZ2VyZWQgd2hlbiBoZWFkZXJzIGFyZSBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAqICAgQHBhcmFtIHN0YXR1c0NvZGUgW0ludGVnZXJdIHRoZSBIVFRQIHJlc3BvbnNlIGNvZGUKICogICBAcGFyYW0gaGVhZGVycyBbbWFwPFN0cmluZyxTdHJpbmc+XSB0aGUgcmVzcG9uc2UgaGVhZGVycwogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQHBhcmFtIHN0YXR1c01lc3NhZ2UgW1N0cmluZ10gQSBzdGF0dXMgbWVzc2FnZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBIVFRQCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgY29kZQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQCFldmVudCBodHRwRGF0YShjaHVuaywgcmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gZGF0YSBpcyBzZW50IGJ5IHRoZSByZW1vdGUgc2VydmVyCiAqICAgQHBhcmFtIGNodW5rIFtCdWZmZXJdIHRoZSBidWZmZXIgZGF0YSBjb250YWluaW5nIHRoZSBuZXh0IGRhdGEgY2h1bmsKICogICAgIGZyb20gdGhlIHNlcnZlcgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBCiAqCiAqIEAhZXZlbnQgaHR0cFVwbG9hZFByb2dyZXNzKHByb2dyZXNzLCByZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGhhcyB1cGxvYWRlZCBtb3JlIGRhdGEKICogICBAcGFyYW0gcHJvZ3Jlc3MgW21hcF0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGBsb2FkZWRgIGFuZCBgdG90YWxgIGJ5dGVzCiAqICAgICBvZiB0aGUgcmVxdWVzdC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAbm90ZSBUaGlzIGV2ZW50IHdpbGwgbm90IGJlIGVtaXR0ZWQgaW4gTm9kZS5qcyAwLjgueC4KICoKICogQCFldmVudCBodHRwRG93bmxvYWRQcm9ncmVzcyhwcm9ncmVzcywgcmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBoYXMgZG93bmxvYWRlZCBtb3JlIGRhdGEKICogICBAcGFyYW0gcHJvZ3Jlc3MgW21hcF0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGBsb2FkZWRgIGFuZCBgdG90YWxgIGJ5dGVzCiAqICAgICBvZiB0aGUgcmVxdWVzdC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAbm90ZSBUaGlzIGV2ZW50IHdpbGwgbm90IGJlIGVtaXR0ZWQgaW4gTm9kZS5qcyAwLjgueC4KICoKICogQCFldmVudCBodHRwRXJyb3IoZXJyb3IsIHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgZmFpbGVkCiAqICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCB0aGF0IHdhcyB0aHJvd24KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQCFldmVudCBodHRwRG9uZShyZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgc2VydmVyIGlzIGZpbmlzaGVkIHNlbmRpbmcgZGF0YQogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAc2VlIEFXUy5SZXNwb25zZQogKi8KQVdTLlJlcXVlc3QgPSBpbmhlcml0KHsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIHJlcXVlc3QgZm9yIGFuIG9wZXJhdGlvbiBvbiBhIGdpdmVuIHNlcnZpY2Ugd2l0aAogICAqIGEgc2V0IG9mIGlucHV0IHBhcmFtZXRlcnMuCiAgICoKICAgKiBAcGFyYW0gc2VydmljZSBbQVdTLlNlcnZpY2VdIHRoZSBzZXJ2aWNlIHRvIHBlcmZvcm0gdGhlIG9wZXJhdGlvbiBvbgogICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG9wZXJhdGlvbiB0byBwZXJmb3JtIG9uIHRoZSBzZXJ2aWNlCiAgICogQHBhcmFtIHBhcmFtcyBbT2JqZWN0XSBwYXJhbWV0ZXJzIHRvIHNlbmQgdG8gdGhlIG9wZXJhdGlvbi4KICAgKiAgIFNlZSB0aGUgb3BlcmF0aW9uJ3MgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGZvcm1hdCBvZiB0aGUKICAgKiAgIHBhcmFtZXRlcnMuCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3Qoc2VydmljZSwgb3BlcmF0aW9uLCBwYXJhbXMpIHsKICAgIHZhciBlbmRwb2ludCA9IHNlcnZpY2UuZW5kcG9pbnQ7CiAgICB2YXIgcmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgdmFyIGN1c3RvbVVzZXJBZ2VudCA9IHNlcnZpY2UuY29uZmlnLmN1c3RvbVVzZXJBZ2VudDsKCiAgICBpZiAoc2VydmljZS5zaWduaW5nUmVnaW9uKSB7CiAgICAgIHJlZ2lvbiA9IHNlcnZpY2Uuc2lnbmluZ1JlZ2lvbjsKICAgIH0gZWxzZSBpZiAoc2VydmljZS5pc0dsb2JhbEVuZHBvaW50KSB7CiAgICAgIHJlZ2lvbiA9ICd1cy1lYXN0LTEnOwogICAgfQoKICAgIHRoaXMuZG9tYWluID0gZG9tYWluICYmIGRvbWFpbi5hY3RpdmU7CiAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlOwogICAgdGhpcy5vcGVyYXRpb24gPSBvcGVyYXRpb247CiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgIHRoaXMuaHR0cFJlcXVlc3QgPSBuZXcgQVdTLkh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pOwogICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudChjdXN0b21Vc2VyQWdlbnQpOwogICAgdGhpcy5zdGFydFRpbWUgPSBzZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCk7CgogICAgdGhpcy5yZXNwb25zZSA9IG5ldyBBV1MuUmVzcG9uc2UodGhpcyk7CiAgICB0aGlzLl9hc20gPSBuZXcgQWNjZXB0b3JTdGF0ZU1hY2hpbmUoZnNtLnN0YXRlcywgJ3ZhbGlkYXRlJyk7CiAgICB0aGlzLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gZmFsc2U7CgogICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgdGhpcy5lbWl0ID0gdGhpcy5lbWl0RXZlbnQ7CiAgfSwKCiAgLyoqCiAgICogQCFncm91cCBTZW5kaW5nIGEgUmVxdWVzdAogICAqLwoKICAvKioKICAgKiBAb3ZlcmxvYWQgc2VuZChjYWxsYmFjayA9IG51bGwpCiAgICogICBTZW5kcyB0aGUgcmVxdWVzdCBvYmplY3QuCiAgICoKICAgKiAgIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICogICAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICAgKiAgICAgQGNvbnRleHQgW0FXUy5SZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgYmVpbmcgc2VudC4KICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgKiAgICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICogICAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAqICAgICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRoIGEgY2FsbGJhY2sKICAgKiAgICAgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAqICAgICByZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IGNvbnNvbGUubG9nKGVyciwgZGF0YSk7IH0pOwogICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBubyBjYWxsYmFjayAodXNpbmcgZXZlbnQgaGFuZGxlcnMpCiAgICogICAgIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgKiAgICAgcmVxdWVzdC5vbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwb25zZSkgeyAuLi4gfSk7IC8vIHJlZ2lzdGVyIGEgY2FsbGJhY2sKICAgKiAgICAgcmVxdWVzdC5zZW5kKCk7CiAgICovCiAgc2VuZDogZnVuY3Rpb24gc2VuZChjYWxsYmFjaykgewogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIC8vIGFwcGVuZCB0byB1c2VyIGFnZW50CiAgICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ2NhbGxiYWNrJyk7CiAgICAgIHRoaXMub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24gKHJlc3ApIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3AsIHJlc3AuZXJyb3IsIHJlc3AuZGF0YSk7CiAgICAgIH0pOwogICAgfQogICAgdGhpcy5ydW5UbygpOwoKICAgIHJldHVybiB0aGlzLnJlc3BvbnNlOwogIH0sCgogIC8qKgogICAqIEAhbWV0aG9kICBwcm9taXNlKCkKICAgKiAgIFNlbmRzIHRoZSByZXF1ZXN0IGFuZCByZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAqCiAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbihkYXRhKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLgogICAqICAgICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnJvcikKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHVzaW5nIHByb21pc2VzLgogICAqICAgICB2YXIgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAqICAgICB2YXIgcmVzdWx0ID0gcmVxdWVzdC5wcm9taXNlKCk7CiAgICogICAgIHJlc3VsdC50aGVuKGZ1bmN0aW9uKGRhdGEpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycm9yKSB7IC4uLiB9KTsKICAgKi8KCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYnVpbGQ6IGZ1bmN0aW9uIGJ1aWxkKGNhbGxiYWNrKSB7CiAgICByZXR1cm4gdGhpcy5ydW5Ubygnc2VuZCcsIGNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBydW5UbzogZnVuY3Rpb24gcnVuVG8oc3RhdGUsIGRvbmUpIHsKICAgIHRoaXMuX2FzbS5ydW5UbyhzdGF0ZSwgZG9uZSwgdGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBBYm9ydHMgYSByZXF1ZXN0LCBlbWl0dGluZyB0aGUgZXJyb3IgYW5kIGNvbXBsZXRlIGV2ZW50cy4KICAgKgogICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICogQGV4YW1wbGUgQWJvcnRpbmcgYSByZXF1ZXN0IGFmdGVyIHNlbmRpbmcKICAgKiAgIHZhciBwYXJhbXMgPSB7CiAgICogICAgIEJ1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleScsCiAgICogICAgIEJvZHk6IEJ1ZmZlci5hbGxvYygxMDI0ICogMTAyNCAqIDUpIC8vIDVNQiBwYXlsb2FkCiAgICogICB9OwogICAqICAgdmFyIHJlcXVlc3QgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgKiAgIHJlcXVlc3Quc2VuZChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICogICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJFcnJvcjoiLCBlcnIuY29kZSwgZXJyLm1lc3NhZ2UpOwogICAqICAgICBlbHNlIGNvbnNvbGUubG9nKGRhdGEpOwogICAqICAgfSk7CiAgICoKICAgKiAgIC8vIGFib3J0IHJlcXVlc3QgaW4gMSBzZWNvbmQKICAgKiAgIHNldFRpbWVvdXQocmVxdWVzdC5hYm9ydC5iaW5kKHJlcXVlc3QpLCAxMDAwKTsKICAgKgogICAqICAgLy8gcHJpbnRzICJFcnJvcjogUmVxdWVzdEFib3J0ZWRFcnJvciBSZXF1ZXN0IGFib3J0ZWQgYnkgdXNlciIKICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHNhbWUgcmVxdWVzdCBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgKiBAc2luY2UgdjEuNC4wCiAgICovCiAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkgewogICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3ZhbGlkYXRlUmVzcG9uc2UnKTsKICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdleHRyYWN0RXJyb3InKTsKICAgIHRoaXMub24oJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbiBhZGRBYm9ydGVkRXJyb3IocmVzcCkgewogICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQgYnkgdXNlcicpLCB7CiAgICAgICAgIGNvZGU6ICdSZXF1ZXN0QWJvcnRlZEVycm9yJywgcmV0cnlhYmxlOiBmYWxzZQogICAgICB9KTsKICAgIH0pOwoKICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbSAmJiAhdGhpcy5odHRwUmVxdWVzdC5zdHJlYW0uZGlkQ2FsbGJhY2spIHsgLy8gYWJvcnQgSFRUUCBzdHJlYW0KICAgICAgdGhpcy5odHRwUmVxdWVzdC5zdHJlYW0uYWJvcnQoKTsKICAgICAgaWYgKHRoaXMuaHR0cFJlcXVlc3QuX2Fib3J0Q2FsbGJhY2spIHsKICAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5fYWJvcnRDYWxsYmFjaygpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdzZW5kJyk7IC8vIGhhdmVuJ3Qgc2VudCB5ZXQsIHNvIGxldCdzIG5vdAogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogSXRlcmF0ZXMgb3ZlciBlYWNoIHBhZ2Ugb2YgcmVzdWx0cyBnaXZlbiBhIHBhZ2VhYmxlIHJlcXVlc3QsIGNhbGxpbmcKICAgKiB0aGUgcHJvdmlkZWQgY2FsbGJhY2sgd2l0aCBlYWNoIHBhZ2Ugb2YgZGF0YS4gQWZ0ZXIgYWxsIHBhZ2VzIGhhdmUgYmVlbgogICAqIHJldHJpZXZlZCwgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIGBudWxsYCBkYXRhLgogICAqCiAgICogQG5vdGUgVGhpcyBvcGVyYXRpb24gY2FuIGdlbmVyYXRlIG11bHRpcGxlIHJlcXVlc3RzIHRvIGEgc2VydmljZS4KICAgKiBAZXhhbXBsZSBJdGVyYXRpbmcgb3ZlciBtdWx0aXBsZSBwYWdlcyBvZiBvYmplY3RzIGluIGFuIFMzIGJ1Y2tldAogICAqICAgdmFyIHBhZ2VzID0gMTsKICAgKiAgIHMzLmxpc3RPYmplY3RzKCkuZWFjaFBhZ2UoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICogICAgIGlmIChlcnIpIHJldHVybjsKICAgKiAgICAgY29uc29sZS5sb2coIlBhZ2UiLCBwYWdlcysrKTsKICAgKiAgICAgY29uc29sZS5sb2coZGF0YSk7CiAgICogICB9KTsKICAgKiBAZXhhbXBsZSBJdGVyYXRpbmcgb3ZlciBtdWx0aXBsZSBwYWdlcyB3aXRoIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjawogICAqICAgczMubGlzdE9iamVjdHMocGFyYW1zKS5lYWNoUGFnZShmdW5jdGlvbihlcnIsIGRhdGEsIGRvbmUpIHsKICAgKiAgICAgZG9Tb21ldGhpbmdBc3luY0FuZE9yRXhwZW5zaXZlKGZ1bmN0aW9uKCkgewogICAqICAgICAgIC8vIFRoZSBuZXh0IHBhZ2Ugb2YgcmVzdWx0cyBpc24ndCBmZXRjaGVkIHVudGlsIGRvbmUgaXMgY2FsbGVkCiAgICogICAgICAgZG9uZSgpOwogICAqICAgICB9KTsKICAgKiAgIH0pOwogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEsIFtkb25lQ2FsbGJhY2tdKQogICAqICAgQ2FsbGVkIHdpdGggZWFjaCBwYWdlIG9mIHJlc3VsdGluZyBkYXRhIGZyb20gdGhlIHJlcXVlc3QuIElmIHRoZQogICAqICAgb3B0aW9uYWwgYGRvbmVDYWxsYmFja2AgaXMgcHJvdmlkZWQgaW4gdGhlIGZ1bmN0aW9uLCBpdCBtdXN0IGJlIGNhbGxlZAogICAqICAgd2hlbiB0aGUgY2FsbGJhY2sgaXMgY29tcGxldGUuCiAgICoKICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBhbiBlcnJvciBvYmplY3QsIGlmIGFuIGVycm9yIG9jY3VycmVkLgogICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gYSBzaW5nbGUgcGFnZSBvZiByZXNwb25zZSBkYXRhLiBJZiB0aGVyZSBpcyBubwogICAqICAgICBtb3JlIGRhdGEsIHRoaXMgb2JqZWN0IHdpbGwgYmUgYG51bGxgLgogICAqICAgQHBhcmFtIGRvbmVDYWxsYmFjayBbRnVuY3Rpb25dIGFuIG9wdGlvbmFsIGRvbmUgY2FsbGJhY2suIElmIHRoaXMKICAgKiAgICAgYXJndW1lbnQgaXMgZGVmaW5lZCBpbiB0aGUgZnVuY3Rpb24gZGVjbGFyYXRpb24sIGl0IHNob3VsZCBiZSBjYWxsZWQKICAgKiAgICAgd2hlbiB0aGUgbmV4dCBwYWdlIGlzIHJlYWR5IHRvIGJlIHJldHJpZXZlZC4gVGhpcyBpcyB1c2VmdWwgZm9yCiAgICogICAgIGNvbnRyb2xsaW5nIHNlcmlhbCBwYWdpbmF0aW9uIGFjcm9zcyBhc3luY2hyb25vdXMgb3BlcmF0aW9ucy4KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIGlmIHRoZSBjYWxsYmFjayByZXR1cm5zIGBmYWxzZWAsIHBhZ2luYXRpb24gd2lsbAogICAqICAgICBzdG9wLgogICAqCiAgICogQHNlZSBBV1MuUmVxdWVzdC5lYWNoSXRlbQogICAqIEBzZWUgQVdTLlJlc3BvbnNlLm5leHRQYWdlCiAgICogQHNpbmNlIHYxLjQuMAogICAqLwogIGVhY2hQYWdlOiBmdW5jdGlvbiBlYWNoUGFnZShjYWxsYmFjaykgewogICAgLy8gTWFrZSBhbGwgY2FsbGJhY2tzIGFzeW5jLWlzaAogICAgY2FsbGJhY2sgPSBBV1MudXRpbC5mbi5tYWtlQXN5bmMoY2FsbGJhY2ssIDMpOwoKICAgIGZ1bmN0aW9uIHdyYXBwZWRDYWxsYmFjayhyZXNwb25zZSkgewogICAgICBjYWxsYmFjay5jYWxsKHJlc3BvbnNlLCByZXNwb25zZS5lcnJvciwgcmVzcG9uc2UuZGF0YSwgZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSByZXR1cm47CgogICAgICAgIGlmIChyZXNwb25zZS5oYXNOZXh0UGFnZSgpKSB7CiAgICAgICAgICByZXNwb25zZS5uZXh0UGFnZSgpLm9uKCdjb21wbGV0ZScsIHdyYXBwZWRDYWxsYmFjaykuc2VuZCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3BvbnNlLCBudWxsLCBudWxsLCBBV1MudXRpbC5mbi5ub29wKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIHRoaXMub24oJ2NvbXBsZXRlJywgd3JhcHBlZENhbGxiYWNrKS5zZW5kKCk7CiAgfSwKCiAgLyoqCiAgICogRW51bWVyYXRlcyBvdmVyIGluZGl2aWR1YWwgaXRlbXMgb2YgYSByZXF1ZXN0LCBwYWdpbmcgdGhlIHJlc3BvbnNlcyBpZgogICAqIG5lY2Vzc2FyeS4KICAgKgogICAqIEBhcGkgZXhwZXJpbWVudGFsCiAgICogQHNpbmNlIHYxLjQuMAogICAqLwogIGVhY2hJdGVtOiBmdW5jdGlvbiBlYWNoSXRlbShjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgZnVuY3Rpb24gd3JhcHBlZENhbGxiYWNrKGVyciwgZGF0YSkgewogICAgICBpZiAoZXJyKSByZXR1cm4gY2FsbGJhY2soZXJyLCBudWxsKTsKICAgICAgaWYgKGRhdGEgPT09IG51bGwpIHJldHVybiBjYWxsYmFjayhudWxsLCBudWxsKTsKCiAgICAgIHZhciBjb25maWcgPSBzZWxmLnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyhzZWxmLm9wZXJhdGlvbik7CiAgICAgIHZhciByZXN1bHRLZXkgPSBjb25maWcucmVzdWx0S2V5OwogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRLZXkpKSByZXN1bHRLZXkgPSByZXN1bHRLZXlbMF07CiAgICAgIHZhciBpdGVtcyA9IGptZXNwYXRoLnNlYXJjaChkYXRhLCByZXN1bHRLZXkpOwogICAgICB2YXIgY29udGludWVJdGVyYXRpb24gPSB0cnVlOwogICAgICBBV1MudXRpbC5hcnJheUVhY2goaXRlbXMsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICBjb250aW51ZUl0ZXJhdGlvbiA9IGNhbGxiYWNrKG51bGwsIGl0ZW0pOwogICAgICAgIGlmIChjb250aW51ZUl0ZXJhdGlvbiA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybiBBV1MudXRpbC5hYm9ydDsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gY29udGludWVJdGVyYXRpb247CiAgICB9CgogICAgdGhpcy5lYWNoUGFnZSh3cmFwcGVkQ2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIG9wZXJhdGlvbiBjYW4gcmV0dXJuIG11bHRpcGxlIHBhZ2VzIG9mCiAgICogICByZXNwb25zZSBkYXRhLgogICAqIEBzZWUgQVdTLlJlc3BvbnNlLmVhY2hQYWdlCiAgICogQHNpbmNlIHYxLjQuMAogICAqLwogIGlzUGFnZWFibGU6IGZ1bmN0aW9uIGlzUGFnZWFibGUoKSB7CiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcodGhpcy5vcGVyYXRpb24pID8gdHJ1ZSA6IGZhbHNlOwogIH0sCgogIC8qKgogICAqIFNlbmRzIHRoZSByZXF1ZXN0IGFuZCBjb252ZXJ0cyB0aGUgcmVxdWVzdCBvYmplY3QgaW50byBhIHJlYWRhYmxlIHN0cmVhbQogICAqIHRoYXQgY2FuIGJlIHJlYWQgZnJvbSBvciBwaXBlZCBpbnRvIGEgd3JpdGFibGUgc3RyZWFtLgogICAqCiAgICogQG5vdGUgVGhlIGRhdGEgcmVhZCBmcm9tIGEgcmVhZGFibGUgc3RyZWFtIGNvbnRhaW5zIG9ubHkKICAgKiAgIHRoZSByYXcgSFRUUCBib2R5IGNvbnRlbnRzLgogICAqIEBleGFtcGxlIE1hbnVhbGx5IHJlYWRpbmcgZnJvbSBhIHN0cmVhbQogICAqICAgcmVxdWVzdC5jcmVhdGVSZWFkU3RyZWFtKCkub24oJ2RhdGEnLCBmdW5jdGlvbihkYXRhKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJHb3QgZGF0YToiLCBkYXRhLnRvU3RyaW5nKCkpOwogICAqICAgfSk7CiAgICogQGV4YW1wbGUgUGlwaW5nIGEgcmVxdWVzdCBib2R5IGludG8gYSBmaWxlCiAgICogICB2YXIgb3V0ID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0oJy9wYXRoL3RvL291dGZpbGUuanBnJyk7CiAgICogICBzMy5zZXJ2aWNlLmdldE9iamVjdChwYXJhbXMpLmNyZWF0ZVJlYWRTdHJlYW0oKS5waXBlKG91dCk7CiAgICogQHJldHVybiBbU3RyZWFtXSB0aGUgcmVhZGFibGUgc3RyZWFtIG9iamVjdCB0aGF0IGNhbiBiZSBwaXBlZAogICAqICAgb3IgcmVhZCBmcm9tIChieSByZWdpc3RlcmluZyAnZGF0YScgZXZlbnQgbGlzdGVuZXJzKS4KICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAqLwogIGNyZWF0ZVJlYWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVJlYWRTdHJlYW0oKSB7CiAgICB2YXIgc3RyZWFtcyA9IEFXUy51dGlsLnN0cmVhbTsKICAgIHZhciByZXEgPSB0aGlzOwogICAgdmFyIHN0cmVhbSA9IG51bGw7CgogICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgIHN0cmVhbSA9IG5ldyBzdHJlYW1zLlBhc3NUaHJvdWdoKCk7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7IHJlcS5zZW5kKCk7IH0pOwogICAgfSBlbHNlIHsKICAgICAgc3RyZWFtID0gbmV3IHN0cmVhbXMuU3RyZWFtKCk7CiAgICAgIHN0cmVhbS5yZWFkYWJsZSA9IHRydWU7CgogICAgICBzdHJlYW0uc2VudCA9IGZhbHNlOwogICAgICBzdHJlYW0ub24oJ25ld0xpc3RlbmVyJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBpZiAoIXN0cmVhbS5zZW50ICYmIGV2ZW50ID09PSAnZGF0YScpIHsKICAgICAgICAgIHN0cmVhbS5zZW50ID0gdHJ1ZTsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7IHJlcS5zZW5kKCk7IH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgdGhpcy5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgIH0pOwoKICAgIHRoaXMub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24gc3RyZWFtSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwKSB7CiAgICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgICAgcmVxLnJlbW92ZUxpc3RlbmVyKCdodHRwRGF0YScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQSk7CiAgICAgICAgcmVxLnJlbW92ZUxpc3RlbmVyKCdodHRwRXJyb3InLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0VSUk9SKTsKICAgICAgICByZXEub24oJ2h0dHBFcnJvcicsIGZ1bmN0aW9uIHN0cmVhbUh0dHBFcnJvcihlcnJvcikgewogICAgICAgICAgcmVzcC5lcnJvciA9IGVycm9yOwogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSBmYWxzZTsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgIHZhciBleHBlY3RlZExlbjsKICAgICAgICBpZiAocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCAhPT0gJ0hFQUQnKSB7CiAgICAgICAgICBleHBlY3RlZExlbiA9IHBhcnNlSW50KGhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ10sIDEwKTsKICAgICAgICB9CiAgICAgICAgaWYgKGV4cGVjdGVkTGVuICE9PSB1bmRlZmluZWQgJiYgIWlzTmFOKGV4cGVjdGVkTGVuKSAmJiBleHBlY3RlZExlbiA+PSAwKSB7CiAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSB0cnVlOwogICAgICAgICAgdmFyIHJlY2VpdmVkTGVuID0gMDsKICAgICAgICB9CgogICAgICAgIHZhciBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0ID0gZnVuY3Rpb24gY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCgpIHsKICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggJiYgcmVjZWl2ZWRMZW4gIT09IGV4cGVjdGVkTGVuKSB7CiAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICAgIG5ldyBFcnJvcignU3RyZWFtIGNvbnRlbnQgbGVuZ3RoIG1pc21hdGNoLiBSZWNlaXZlZCAnICsKICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICsgJyBvZiAnICsgZXhwZWN0ZWRMZW4gKyAnIGJ5dGVzLicpLAogICAgICAgICAgICAgIHsgY29kZTogJ1N0cmVhbUNvbnRlbnRMZW5ndGhNaXNtYXRjaCcgfQogICAgICAgICAgICApKTsKICAgICAgICAgIH0gZWxzZSBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICAgICAgc3RyZWFtLmVuZCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2VuZCcpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBodHRwU3RyZWFtID0gcmVzcC5odHRwUmVzcG9uc2UuY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpOwoKICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGgpIHsKICAgICAgICAgICAgdmFyIGxlbmd0aEFjY3VtdWxhdG9yID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuX3dyaXRlID0gZnVuY3Rpb24oY2h1bmspIHsKICAgICAgICAgICAgICBpZiAoY2h1bmsgJiYgY2h1bmsubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBjaHVuay5sZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBzdHJlYW1zLlBhc3NUaHJvdWdoLnByb3RvdHlwZS5fd3JpdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLm9uKCdlbmQnLCBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KTsKICAgICAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgICAgIGh0dHBTdHJlYW0udW5waXBlKGxlbmd0aEFjY3VtdWxhdG9yKTsKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5lbWl0KCdlbmQnKTsKICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5lbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGh0dHBTdHJlYW0ucGlwZShsZW5ndGhBY2N1bXVsYXRvcikucGlwZShzdHJlYW0sIHsgZW5kOiBmYWxzZSB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGh0dHBTdHJlYW0ucGlwZShzdHJlYW0pOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCkgewogICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgICAgaWYgKGFyZyAmJiBhcmcubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArPSBhcmcubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgaHR0cFN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICBzdHJlYW0uZW1pdCgnZGF0YScsIGFyZyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2VuZCcsIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQpOwogICAgICAgIH0KCiAgICAgICAgaHR0cFN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIHN0cmVhbTsKICB9LAoKICAvKioKICAgKiBAcGFyYW0gW0FycmF5LFJlc3BvbnNlXSBhcmdzIFRoaXMgc2hvdWxkIGJlIHRoZSByZXNwb25zZSBvYmplY3QsCiAgICogICBvciBhbiBhcnJheSBvZiBhcmdzIHRvIHNlbmQgdG8gdGhlIGV2ZW50LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGVtaXRFdmVudDogZnVuY3Rpb24gZW1pdChldmVudE5hbWUsIGFyZ3MsIGRvbmUpIHsKICAgIGlmICh0eXBlb2YgYXJncyA9PT0gJ2Z1bmN0aW9uJykgeyBkb25lID0gYXJnczsgYXJncyA9IG51bGw7IH0KICAgIGlmICghZG9uZSkgZG9uZSA9IGZ1bmN0aW9uKCkgeyB9OwogICAgaWYgKCFhcmdzKSBhcmdzID0gdGhpcy5ldmVudFBhcmFtZXRlcnMoZXZlbnROYW1lLCB0aGlzLnJlc3BvbnNlKTsKCiAgICB2YXIgb3JpZ0VtaXQgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5lbWl0OwogICAgb3JpZ0VtaXQuY2FsbCh0aGlzLCBldmVudE5hbWUsIGFyZ3MsIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgaWYgKGVycikgdGhpcy5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgZG9uZS5jYWxsKHRoaXMsIGVycik7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBldmVudFBhcmFtZXRlcnM6IGZ1bmN0aW9uIGV2ZW50UGFyYW1ldGVycyhldmVudE5hbWUpIHsKICAgIHN3aXRjaCAoZXZlbnROYW1lKSB7CiAgICAgIGNhc2UgJ3Jlc3RhcnQnOgogICAgICBjYXNlICd2YWxpZGF0ZSc6CiAgICAgIGNhc2UgJ3NpZ24nOgogICAgICBjYXNlICdidWlsZCc6CiAgICAgIGNhc2UgJ2FmdGVyVmFsaWRhdGUnOgogICAgICBjYXNlICdhZnRlckJ1aWxkJzoKICAgICAgICByZXR1cm4gW3RoaXNdOwogICAgICBjYXNlICdlcnJvcic6CiAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlLmVycm9yLCB0aGlzLnJlc3BvbnNlXTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gW3RoaXMucmVzcG9uc2VdOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHByZXNpZ246IGZ1bmN0aW9uIHByZXNpZ24oZXhwaXJlcywgY2FsbGJhY2spIHsKICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIGV4cGlyZXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBleHBpcmVzOwogICAgICBleHBpcmVzID0gbnVsbDsKICAgIH0KICAgIHJldHVybiBuZXcgQVdTLlNpZ25lcnMuUHJlc2lnbigpLnNpZ24odGhpcy50b0dldCgpLCBleHBpcmVzLCBjYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaXNQcmVzaWduZWQ6IGZ1bmN0aW9uIGlzUHJlc2lnbmVkKCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLmh0dHBSZXF1ZXN0LmhlYWRlcnMsICdwcmVzaWduZWQtZXhwaXJlcycpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHRvVW5hdXRoZW50aWNhdGVkOiBmdW5jdGlvbiB0b1VuYXV0aGVudGljYXRlZCgpIHsKICAgIHRoaXMuX3VuQXV0aGVudGljYXRlZCA9IHRydWU7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTKTsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3NpZ24nLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TSUdOKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHRvR2V0OiBmdW5jdGlvbiB0b0dldCgpIHsKICAgIGlmICh0aGlzLnNlcnZpY2UuYXBpLnByb3RvY29sID09PSAncXVlcnknIHx8CiAgICAgICAgdGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ2VjMicpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignYnVpbGQnLCB0aGlzLmJ1aWxkQXNHZXQpOwogICAgICB0aGlzLmFkZExpc3RlbmVyKCdidWlsZCcsIHRoaXMuYnVpbGRBc0dldCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBidWlsZEFzR2V0OiBmdW5jdGlvbiBidWlsZEFzR2V0KHJlcXVlc3QpIHsKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QubWV0aG9kID0gJ0dFVCc7CiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnBhdGggPSByZXF1ZXN0LnNlcnZpY2UuZW5kcG9pbnQucGF0aCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPycgKyByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmJvZHk7CiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmJvZHkgPSAnJzsKCiAgICAvLyBkb24ndCBuZWVkIHRoZXNlIGhlYWRlcnMgb24gYSBHRVQgcmVxdWVzdAogICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXTsKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGhhbHRIYW5kbGVyc09uRXJyb3I6IGZ1bmN0aW9uIGhhbHRIYW5kbGVyc09uRXJyb3IoKSB7CiAgICB0aGlzLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gdHJ1ZTsKICB9Cn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlJlcXVlc3QuYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgdGhpcy5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uIHByb21pc2UoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAvLyBhcHBlbmQgdG8gdXNlciBhZ2VudAogICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgncHJvbWlzZScpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlRGVwZW5kZW5jeShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5vbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICAgIHJlamVjdChyZXNwLmVycm9yKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gZGVmaW5lICRyZXNwb25zZSBwcm9wZXJ0eSBzbyB0aGF0IGl0IGlzIG5vdCBlbnVtZXJhYmxlCiAgICAgICAgICAvLyB0aGlzIHByZXZlbnRzIGNpcmN1bGFyIHJlZmVyZW5jZSBlcnJvcnMgd2hlbiBzdHJpbmdpZnlpbmcgdGhlIEpTT04gb2JqZWN0CiAgICAgICAgICByZXNvbHZlKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgKICAgICAgICAgICAgcmVzcC5kYXRhIHx8IHt9LAogICAgICAgICAgICAnJHJlc3BvbnNlJywKICAgICAgICAgICAge3ZhbHVlOiByZXNwfQogICAgICAgICAgKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgc2VsZi5ydW5UbygpOwogICAgfSk7CiAgfTsKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5SZXF1ZXN0LmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnByb21pc2U7Cn07CgpBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuUmVxdWVzdCk7CgpBV1MudXRpbC5taXhpbihBV1MuUmVxdWVzdCwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcik7Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2NvcmUiOjE5LCIuL3N0YXRlX21hY2hpbmUiOjcxLCJfcHJvY2VzcyI6OTAsImptZXNwYXRoIjo4OX1dLDU4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENvcHlyaWdodCAyMDEyLTIwMTMgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIikuIFlvdQogKiBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mCiAqIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXQKICoKICogICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hcGFjaGUyLjAvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMKICogZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YKICogQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljCiAqIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CnZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBDSEVDS19BQ0NFUFRPUlMocmVzcCkgewogIHZhciB3YWl0ZXIgPSByZXNwLnJlcXVlc3QuX3dhaXRlcjsKICB2YXIgYWNjZXB0b3JzID0gd2FpdGVyLmNvbmZpZy5hY2NlcHRvcnM7CiAgdmFyIGFjY2VwdG9yTWF0Y2hlZCA9IGZhbHNlOwogIHZhciBzdGF0ZSA9ICdyZXRyeSc7CgogIGFjY2VwdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGFjY2VwdG9yKSB7CiAgICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCkgewogICAgICB2YXIgbWF0Y2hlciA9IHdhaXRlci5tYXRjaGVyc1thY2NlcHRvci5tYXRjaGVyXTsKICAgICAgaWYgKG1hdGNoZXIgJiYgbWF0Y2hlcihyZXNwLCBhY2NlcHRvci5leHBlY3RlZCwgYWNjZXB0b3IuYXJndW1lbnQpKSB7CiAgICAgICAgYWNjZXB0b3JNYXRjaGVkID0gdHJ1ZTsKICAgICAgICBzdGF0ZSA9IGFjY2VwdG9yLnN0YXRlOwogICAgICB9CiAgICB9CiAgfSk7CgogIGlmICghYWNjZXB0b3JNYXRjaGVkICYmIHJlc3AuZXJyb3IpIHN0YXRlID0gJ2ZhaWx1cmUnOwoKICBpZiAoc3RhdGUgPT09ICdzdWNjZXNzJykgewogICAgd2FpdGVyLnNldFN1Y2Nlc3MocmVzcCk7CiAgfSBlbHNlIHsKICAgIHdhaXRlci5zZXRFcnJvcihyZXNwLCBzdGF0ZSA9PT0gJ3JldHJ5Jyk7CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuUmVzb3VyY2VXYWl0ZXIgPSBpbmhlcml0KHsKICAvKioKICAgKiBXYWl0cyBmb3IgYSBnaXZlbiBzdGF0ZSBvbiBhIHNlcnZpY2Ugb2JqZWN0CiAgICogQHBhcmFtIHNlcnZpY2UgW1NlcnZpY2VdIHRoZSBzZXJ2aWNlIG9iamVjdCB0byB3YWl0IG9uCiAgICogQHBhcmFtIHN0YXRlIFtTdHJpbmddIHRoZSBzdGF0ZSAoZGVmaW5lZCBpbiB3YWl0ZXIgY29uZmlndXJhdGlvbikgdG8gd2FpdAogICAqICAgZm9yLgogICAqIEBleGFtcGxlIENyZWF0ZSBhIHdhaXRlciBmb3IgcnVubmluZyBFQzIgaW5zdGFuY2VzCiAgICogICB2YXIgZWMyID0gbmV3IEFXUy5FQzI7CiAgICogICB2YXIgd2FpdGVyID0gbmV3IEFXUy5SZXNvdXJjZVdhaXRlcihlYzIsICdpbnN0YW5jZVJ1bm5pbmcnKTsKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gY29uc3RydWN0b3Ioc2VydmljZSwgc3RhdGUpIHsKICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7CiAgICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgICB0aGlzLmxvYWRXYWl0ZXJDb25maWcodGhpcy5zdGF0ZSk7CiAgfSwKCiAgc2VydmljZTogbnVsbCwKCiAgc3RhdGU6IG51bGwsCgogIGNvbmZpZzogbnVsbCwKCiAgbWF0Y2hlcnM6IHsKICAgIHBhdGg6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICB0cnkgewogICAgICAgIHZhciByZXN1bHQgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHQsZXhwZWN0ZWQpOwogICAgfSwKCiAgICBwYXRoQWxsOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcmVzdWx0cyA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgIHZhciBudW1SZXN1bHRzID0gcmVzdWx0cy5sZW5ndGg7CiAgICAgIGlmICghbnVtUmVzdWx0cykgcmV0dXJuIGZhbHNlOwogICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICBpZiAoIWptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHRzW2luZF0sIGV4cGVjdGVkKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgcGF0aEFueTogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdHMpKSByZXN1bHRzID0gW3Jlc3VsdHNdOwogICAgICB2YXIgbnVtUmVzdWx0cyA9IHJlc3VsdHMubGVuZ3RoOwogICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICBpZiAoam1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICBzdGF0dXM6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkKSB7CiAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgcmV0dXJuICh0eXBlb2Ygc3RhdHVzQ29kZSA9PT0gJ251bWJlcicpICYmIChzdGF0dXNDb2RlID09PSBleHBlY3RlZCk7CiAgICB9LAoKICAgIGVycm9yOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICBpZiAodHlwZW9mIGV4cGVjdGVkID09PSAnc3RyaW5nJyAmJiByZXNwLmVycm9yKSB7CiAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSByZXNwLmVycm9yLmNvZGU7CiAgICAgIH0KICAgICAgLy8gaWYgZXhwZWN0ZWQgaXMgbm90IHN0cmluZywgY2FuIGJlIGJvb2xlYW4gaW5kaWNhdGluZyBwcmVzZW5jZSBvZiBlcnJvcgogICAgICByZXR1cm4gZXhwZWN0ZWQgPT09ICEhcmVzcC5lcnJvcjsKICAgIH0KICB9LAoKICBsaXN0ZW5lcnM6IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICBhZGQoJ1JFVFJZX0NIRUNLJywgJ3JldHJ5JywgZnVuY3Rpb24ocmVzcCkgewogICAgICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgICAgIGlmIChyZXNwLmVycm9yICYmIHJlc3AuZXJyb3IuY29kZSA9PT0gJ1Jlc291cmNlTm90UmVhZHknKSB7CiAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gKHdhaXRlci5jb25maWcuZGVsYXkgfHwgMCkgKiAxMDAwOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0NIRUNLX09VVFBVVCcsICdleHRyYWN0RGF0YScsIENIRUNLX0FDQ0VQVE9SUyk7CgogICAgYWRkKCdDSEVDS19FUlJPUicsICdleHRyYWN0RXJyb3InLCBDSEVDS19BQ0NFUFRPUlMpOwogIH0pLAoKICAvKioKICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0KICAgKi8KICB3YWl0OiBmdW5jdGlvbiB3YWl0KHBhcmFtcywgY2FsbGJhY2spIHsKICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gcGFyYW1zOyBwYXJhbXMgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuJHdhaXRlcikgewogICAgICBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHBhcmFtcyk7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zLiR3YWl0ZXIuZGVsYXkgPT09ICdudW1iZXInKSB7CiAgICAgICAgdGhpcy5jb25maWcuZGVsYXkgPSBwYXJhbXMuJHdhaXRlci5kZWxheTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLm1heEF0dGVtcHRzID09PSAnbnVtYmVyJykgewogICAgICAgIHRoaXMuY29uZmlnLm1heEF0dGVtcHRzID0gcGFyYW1zLiR3YWl0ZXIubWF4QXR0ZW1wdHM7CiAgICAgIH0KICAgICAgZGVsZXRlIHBhcmFtcy4kd2FpdGVyOwogICAgfQoKICAgIHZhciByZXF1ZXN0ID0gdGhpcy5zZXJ2aWNlLm1ha2VSZXF1ZXN0KHRoaXMuY29uZmlnLm9wZXJhdGlvbiwgcGFyYW1zKTsKICAgIHJlcXVlc3QuX3dhaXRlciA9IHRoaXM7CiAgICByZXF1ZXN0LnJlc3BvbnNlLm1heFJldHJpZXMgPSB0aGlzLmNvbmZpZy5tYXhBdHRlbXB0czsKICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKHRoaXMubGlzdGVuZXJzKTsKCiAgICBpZiAoY2FsbGJhY2spIHJlcXVlc3Quc2VuZChjYWxsYmFjayk7CiAgICByZXR1cm4gcmVxdWVzdDsKICB9LAoKICBzZXRTdWNjZXNzOiBmdW5jdGlvbiBzZXRTdWNjZXNzKHJlc3ApIHsKICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgcmVzcC5kYXRhID0gcmVzcC5kYXRhIHx8IHt9OwogICAgcmVzcC5yZXF1ZXN0LnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdERhdGEnKTsKICB9LAoKICBzZXRFcnJvcjogZnVuY3Rpb24gc2V0RXJyb3IocmVzcCwgcmV0cnlhYmxlKSB7CiAgICByZXNwLmRhdGEgPSBudWxsOwogICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKHJlc3AuZXJyb3IgfHwgbmV3IEVycm9yKCksIHsKICAgICAgY29kZTogJ1Jlc291cmNlTm90UmVhZHknLAogICAgICBtZXNzYWdlOiAnUmVzb3VyY2UgaXMgbm90IGluIHRoZSBzdGF0ZSAnICsgdGhpcy5zdGF0ZSwKICAgICAgcmV0cnlhYmxlOiByZXRyeWFibGUKICAgIH0pOwogIH0sCgogIC8qKgogICAqIExvYWRzIHdhaXRlciBjb25maWd1cmF0aW9uIGZyb20gQVBJIGNvbmZpZ3VyYXRpb24KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWRXYWl0ZXJDb25maWc6IGZ1bmN0aW9uIGxvYWRXYWl0ZXJDb25maWcoc3RhdGUpIHsKICAgIGlmICghdGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSkgewogICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnU3RhdGVOb3RGb3VuZEVycm9yJywKICAgICAgICBtZXNzYWdlOiAnU3RhdGUgJyArIHN0YXRlICsgJyBub3QgZm91bmQuJwogICAgICB9KTsKICAgIH0KCiAgICB0aGlzLmNvbmZpZyA9IEFXUy51dGlsLmNvcHkodGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSk7CiAgfQp9KTsKCn0seyIuL2NvcmUiOjE5LCJqbWVzcGF0aCI6ODl9XSw1OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0Owp2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwoKLyoqCiAqIFRoaXMgY2xhc3MgZW5jYXBzdWxhdGVzIHRoZSByZXNwb25zZSBpbmZvcm1hdGlvbgogKiBmcm9tIGEgc2VydmljZSByZXF1ZXN0IG9wZXJhdGlvbiBzZW50IHRocm91Z2gge0FXUy5SZXF1ZXN0fS4KICogVGhlIHJlc3BvbnNlIG9iamVjdCBoYXMgdHdvIG1haW4gcHJvcGVydGllcyBmb3IgZ2V0dGluZyBpbmZvcm1hdGlvbgogKiBiYWNrIGZyb20gYSByZXF1ZXN0OgogKgogKiAjIyBUaGUgYGRhdGFgIHByb3BlcnR5CiAqCiAqIFRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkgY29udGFpbnMgdGhlIHNlcmlhbGl6ZWQgb2JqZWN0IGRhdGEKICogcmV0cmlldmVkIGZyb20gdGhlIHNlcnZpY2UgcmVxdWVzdC4gRm9yIGluc3RhbmNlLCBmb3IgYW4KICogQW1hem9uIER5bmFtb0RCIGBsaXN0VGFibGVzYCBtZXRob2QgY2FsbCwgdGhlIHJlc3BvbnNlIGRhdGEgbWlnaHQKICogbG9vayBsaWtlOgogKgogKiBgYGAKICogPiByZXNwLmRhdGEKICogeyBUYWJsZU5hbWVzOgogKiAgICBbICd0YWJsZTEnLCAndGFibGUyJywgLi4uIF0gfQogKiBgYGAKICoKICogVGhlIGBkYXRhYCBwcm9wZXJ0eSBjYW4gYmUgbnVsbCBpZiBhbiBlcnJvciBvY2N1cnMgKHNlZSBiZWxvdykuCiAqCiAqICMjIFRoZSBgZXJyb3JgIHByb3BlcnR5CiAqCiAqIEluIHRoZSBldmVudCBvZiBhIHNlcnZpY2UgZXJyb3IgKG9yIHRyYW5zZmVyIGVycm9yKSwgdGhlCiAqIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkgd2lsbCBiZSBmaWxsZWQgd2l0aCB0aGUgZ2l2ZW4KICogZXJyb3IgZGF0YSBpbiB0aGUgZm9ybToKICoKICogYGBgCiAqIHsgY29kZTogJ1NIT1JUX1VOSVFVRV9FUlJPUl9DT0RFJywKICogICBtZXNzYWdlOiAnU29tZSBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlJyB9CiAqIGBgYAogKgogKiBJbiB0aGUgY2FzZSBvZiBhbiBlcnJvciwgdGhlIGBkYXRhYCBwcm9wZXJ0eSB3aWxsIGJlIGBudWxsYC4KICogTm90ZSB0aGF0IGlmIHlvdSBoYW5kbGUgZXZlbnRzIHRoYXQgY2FuIGJlIGluIGEgZmFpbHVyZSBzdGF0ZSwKICogeW91IHNob3VsZCBhbHdheXMgY2hlY2sgd2hldGhlciBgcmVzcG9uc2UuZXJyb3JgIGlzIHNldAogKiBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgdGhlIGByZXNwb25zZS5kYXRhYCBwcm9wZXJ0eS4KICoKICogQCFhdHRyaWJ1dGUgZGF0YQogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAqICAgQG5vdGUgSW5zaWRlIG9mIGEge0FXUy5SZXF1ZXN0fmh0dHBEYXRhfSBldmVudCwgdGhpcwogKiAgICAgcHJvcGVydHkgY29udGFpbnMgYSBzaW5nbGUgcmF3IHBhY2tldCBpbnN0ZWFkIG9mIHRoZQogKiAgICAgZnVsbCBkZS1zZXJpYWxpemVkIHNlcnZpY2UgcmVzcG9uc2UuCiAqICAgQHJldHVybiBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCByZXNwb25zZSBkYXRhCiAqICAgICBmcm9tIHRoZSBzZXJ2aWNlLgogKgogKiBAIWF0dHJpYnV0ZSBlcnJvcgogKiAgIEFuIHN0cnVjdHVyZSBjb250YWluaW5nIGluZm9ybWF0aW9uIGFib3V0IGEgc2VydmljZQogKiAgIG9yIG5ldHdvcmtpbmcgZXJyb3IuCiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICogICBAbm90ZSBUaGlzIGF0dHJpYnV0ZSBpcyBvbmx5IGZpbGxlZCBpZiBhIHNlcnZpY2Ugb3IKICogICAgIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzLgogKiAgIEByZXR1cm4gW0Vycm9yXQogKiAgICAgKiBjb2RlIFtTdHJpbmddIGEgdW5pcXVlIHNob3J0IGNvZGUgcmVwcmVzZW50aW5nIHRoZQogKiAgICAgICBlcnJvciB0aGF0IHdhcyBlbWl0dGVkLgogKiAgICAgKiBtZXNzYWdlIFtTdHJpbmddIGEgbG9uZ2VyIGh1bWFuIHJlYWRhYmxlIGVycm9yIG1lc3NhZ2UKICogICAgICogcmV0cnlhYmxlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBlcnJvciBtZXNzYWdlIGlzCiAqICAgICAgIHJldHJ5YWJsZS4KICogICAgICogc3RhdHVzQ29kZSBbTnVtZXJpY10gaW4gdGhlIGNhc2Ugb2YgYSByZXF1ZXN0IHRoYXQgcmVhY2hlZCB0aGUgc2VydmljZSwKICogICAgICAgdGhpcyB2YWx1ZSBjb250YWlucyB0aGUgcmVzcG9uc2Ugc3RhdHVzIGNvZGUuCiAqICAgICAqIHRpbWUgW0RhdGVdIHRoZSBkYXRlIHRpbWUgb2JqZWN0IHdoZW4gdGhlIGVycm9yIG9jY3VycmVkLgogKiAgICAgKiBob3N0bmFtZSBbU3RyaW5nXSBzZXQgd2hlbiBhIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzIHRvIGVhc2lseQogKiAgICAgICBpZGVudGlmeSB0aGUgZW5kcG9pbnQgb2YgdGhlIHJlcXVlc3QuCiAqICAgICAqIHJlZ2lvbiBbU3RyaW5nXSBzZXQgd2hlbiBhIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzIHRvIGVhc2lseQogKiAgICAgICBpZGVudGlmeSB0aGUgcmVnaW9uIG9mIHRoZSByZXF1ZXN0LgogKgogKiBAIWF0dHJpYnV0ZSByZXF1ZXN0SWQKICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHVuaXF1ZSByZXF1ZXN0IElEIGFzc29jaWF0ZWQgd2l0aCB0aGUgcmVzcG9uc2UuCiAqICAgICBMb2cgdGhpcyB2YWx1ZSB3aGVuIGRlYnVnZ2luZyByZXF1ZXN0cyBmb3IgQVdTIHN1cHBvcnQuCiAqCiAqIEAhYXR0cmlidXRlIHJldHJ5Q291bnQKICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiByZXRyaWVzIHRoYXQgd2VyZQogKiAgICAgYXR0ZW1wdGVkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogKgogKiBAIWF0dHJpYnV0ZSByZWRpcmVjdENvdW50CiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2YgcmVkaXJlY3RzIHRoYXQgd2VyZQogKiAgICAgZm9sbG93ZWQgYmVmb3JlIHRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQuCiAqCiAqIEAhYXR0cmlidXRlIGh0dHBSZXNwb25zZQogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgSFRUUCBQcm9wZXJ0aWVzCiAqICAgQHJldHVybiBbQVdTLkh0dHBSZXNwb25zZV0gdGhlIHJhdyBIVFRQIHJlc3BvbnNlIG9iamVjdAogKiAgICAgY29udGFpbmluZyB0aGUgcmVzcG9uc2UgaGVhZGVycyBhbmQgYm9keSBpbmZvcm1hdGlvbgogKiAgICAgZnJvbSB0aGUgc2VydmVyLgogKgogKiBAc2VlIEFXUy5SZXF1ZXN0CiAqLwpBV1MuUmVzcG9uc2UgPSBpbmhlcml0KHsKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlc3BvbnNlKHJlcXVlc3QpIHsKICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7CiAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgdGhpcy5lcnJvciA9IG51bGw7CiAgICB0aGlzLnJldHJ5Q291bnQgPSAwOwogICAgdGhpcy5yZWRpcmVjdENvdW50ID0gMDsKICAgIHRoaXMuaHR0cFJlc3BvbnNlID0gbmV3IEFXUy5IdHRwUmVzcG9uc2UoKTsKICAgIGlmIChyZXF1ZXN0KSB7CiAgICAgIHRoaXMubWF4UmV0cmllcyA9IHJlcXVlc3Quc2VydmljZS5udW1SZXRyaWVzKCk7CiAgICAgIHRoaXMubWF4UmVkaXJlY3RzID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5tYXhSZWRpcmVjdHM7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyByZXF1ZXN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIHJlc3BvbnNlIGRhdGEsIGNhbGxpbmcgdGhlCiAgICogY2FsbGJhY2sgd2l0aCB0aGUgcGFnZSBkYXRhIGlmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQuCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAqICAgQ2FsbGVkIHdoZW4gYSBwYWdlIG9mIGRhdGEgaXMgcmV0dXJuZWQgZnJvbSB0aGUgbmV4dCByZXF1ZXN0LgogICAqCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gYW4gZXJyb3Igb2JqZWN0LCBpZiBhbiBlcnJvciBvY2N1cnJlZCBpbiB0aGUgcmVxdWVzdAogICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIG5leHQgcGFnZSBvZiBkYXRhLCBvciBudWxsLCBpZiB0aGVyZSBhcmUgbm8KICAgKiAgICAgbW9yZSBwYWdlcyBsZWZ0LgogICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgZm9yIHRoZSBuZXh0IHBhZ2Ugb2YgZGF0YQogICAqIEByZXR1cm4gW251bGxdIGlmIG5vIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGFuZCB0aGVyZSBhcmUgbm8gcGFnZXMgbGVmdAogICAqICAgdG8gcmV0cmlldmUuCiAgICogQHNpbmNlIHYxLjQuMAogICAqLwogIG5leHRQYWdlOiBmdW5jdGlvbiBuZXh0UGFnZShjYWxsYmFjaykgewogICAgdmFyIGNvbmZpZzsKICAgIHZhciBzZXJ2aWNlID0gdGhpcy5yZXF1ZXN0LnNlcnZpY2U7CiAgICB2YXIgb3BlcmF0aW9uID0gdGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbjsKICAgIHRyeSB7CiAgICAgIGNvbmZpZyA9IHNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyhvcGVyYXRpb24sIHRydWUpOwogICAgfSBjYXRjaCAoZSkgeyB0aGlzLmVycm9yID0gZTsgfQoKICAgIGlmICghdGhpcy5oYXNOZXh0UGFnZSgpKSB7CiAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sodGhpcy5lcnJvciwgbnVsbCk7CiAgICAgIGVsc2UgaWYgKHRoaXMuZXJyb3IpIHRocm93IHRoaXMuZXJyb3I7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHRoaXMucmVxdWVzdC5wYXJhbXMpOwogICAgaWYgKCF0aGlzLm5leHRQYWdlVG9rZW5zKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayA/IGNhbGxiYWNrKG51bGwsIG51bGwpIDogbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBpbnB1dFRva2VucyA9IGNvbmZpZy5pbnB1dFRva2VuOwogICAgICBpZiAodHlwZW9mIGlucHV0VG9rZW5zID09PSAnc3RyaW5nJykgaW5wdXRUb2tlbnMgPSBbaW5wdXRUb2tlbnNdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlucHV0VG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcGFyYW1zW2lucHV0VG9rZW5zW2ldXSA9IHRoaXMubmV4dFBhZ2VUb2tlbnNbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIHNlcnZpY2UubWFrZVJlcXVlc3QodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBtb3JlIHBhZ2VzIG9mIGRhdGEgY2FuIGJlIHJldHVybmVkIGJ5IGZ1cnRoZXIKICAgKiAgIHJlcXVlc3RzCiAgICogQHNpbmNlIHYxLjQuMAogICAqLwogIGhhc05leHRQYWdlOiBmdW5jdGlvbiBoYXNOZXh0UGFnZSgpIHsKICAgIHRoaXMuY2FjaGVOZXh0UGFnZVRva2VucygpOwogICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMpIHJldHVybiB0cnVlOwogICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGVsc2UgcmV0dXJuIGZhbHNlOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNhY2hlTmV4dFBhZ2VUb2tlbnM6IGZ1bmN0aW9uIGNhY2hlTmV4dFBhZ2VUb2tlbnMoKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsICduZXh0UGFnZVRva2VucycpKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSB1bmRlZmluZWQ7CgogICAgdmFyIGNvbmZpZyA9IHRoaXMucmVxdWVzdC5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbik7CiAgICBpZiAoIWNvbmZpZykgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CgogICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IG51bGw7CiAgICBpZiAoY29uZmlnLm1vcmVSZXN1bHRzKSB7CiAgICAgIGlmICgham1lc3BhdGguc2VhcmNoKHRoaXMuZGF0YSwgY29uZmlnLm1vcmVSZXN1bHRzKSkgewogICAgICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgICB9CiAgICB9CgogICAgdmFyIGV4cHJzID0gY29uZmlnLm91dHB1dFRva2VuOwogICAgaWYgKHR5cGVvZiBleHBycyA9PT0gJ3N0cmluZycpIGV4cHJzID0gW2V4cHJzXTsKICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGV4cHJzLCBmdW5jdGlvbiAoZXhwcikgewogICAgICB2YXIgb3V0cHV0ID0gam1lc3BhdGguc2VhcmNoKHRoaXMuZGF0YSwgZXhwcik7CiAgICAgIGlmIChvdXRwdXQpIHsKICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gdGhpcy5uZXh0UGFnZVRva2VucyB8fCBbXTsKICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zLnB1c2gob3V0cHV0KTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgfQoKfSk7Cgp9LHsiLi9jb3JlIjoxOSwiam1lc3BhdGgiOjg5fV0sNjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqIEAhbWV0aG9kIG9uKGV2ZW50TmFtZSwgY2FsbGJhY2spCiAqICAgUmVnaXN0ZXJzIGFuIGV2ZW50IGxpc3RlbmVyIGNhbGxiYWNrIGZvciB0aGUgZXZlbnQgZ2l2ZW4gYnkgYGV2ZW50TmFtZWAuCiAqICAgUGFyYW1ldGVycyBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGRlcGVuZCBvbiB0aGUgaW5kaXZpZHVhbCBldmVudAogKiAgIGJlaW5nIHRyaWdnZXJlZC4gU2VlIHRoZSBldmVudCBkb2N1bWVudGF0aW9uIGZvciB0aG9zZSBwYXJhbWV0ZXJzLgogKgogKiAgIEBwYXJhbSBldmVudE5hbWUgW1N0cmluZ10gdGhlIGV2ZW50IG5hbWUgdG8gcmVnaXN0ZXIgdGhlIGxpc3RlbmVyIGZvcgogKiAgIEBwYXJhbSBjYWxsYmFjayBbRnVuY3Rpb25dIHRoZSBsaXN0ZW5lciBjYWxsYmFjayBmdW5jdGlvbgogKiAgIEBwYXJhbSB0b0hlYWQgW0Jvb2xlYW5dIGF0dGFjaCB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgdG8gdGhlIGhlYWQgb2YgY2FsbGJhY2sgYXJyYXkgaWYgc2V0IHRvIHRydWUuCiAqICAgICBEZWZhdWx0IHRvIGJlIGZhbHNlLgogKiAgIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBzYW1lIG9iamVjdCBmb3IgY2hhaW5pbmcKICovCkFXUy5TZXF1ZW50aWFsRXhlY3V0b3IgPSBBV1MudXRpbC5pbmhlcml0KHsKCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNlcXVlbnRpYWxFeGVjdXRvcigpIHsKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxpc3RlbmVyczogZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdID8gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0uc2xpY2UoMCkgOiBbXTsKICB9LAoKICBvbjogZnVuY3Rpb24gb24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICBpZiAodGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0pIHsKICAgICAgdG9IZWFkID8KICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS51bnNoaWZ0KGxpc3RlbmVyKSA6CiAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA9IFtsaXN0ZW5lcl07CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBvbkFzeW5jOiBmdW5jdGlvbiBvbkFzeW5jKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCkgewogICAgbGlzdGVuZXIuX2lzQXN5bmMgPSB0cnVlOwogICAgcmV0dXJuIHRoaXMub24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKTsKICB9LAoKICByZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldmVudE5hbWVdOwogICAgaWYgKGxpc3RlbmVycykgewogICAgICB2YXIgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgdmFyIHBvc2l0aW9uID0gLTE7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lcikgewogICAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocG9zaXRpb24gPiAtMSkgewogICAgICAgIGxpc3RlbmVycy5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9LAoKICByZW1vdmVBbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyhldmVudE5hbWUpIHsKICAgIGlmIChldmVudE5hbWUpIHsKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBlbWl0OiBmdW5jdGlvbiBlbWl0KGV2ZW50TmFtZSwgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spIHsKICAgIGlmICghZG9uZUNhbGxiYWNrKSBkb25lQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHsgfTsKICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLmxpc3RlbmVycyhldmVudE5hbWUpOwogICAgdmFyIGNvdW50ID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgIHRoaXMuY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKTsKICAgIHJldHVybiBjb3VudCA+IDA7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY2FsbExpc3RlbmVyczogZnVuY3Rpb24gY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGFyZ3MsIGRvbmVDYWxsYmFjaywgcHJldkVycm9yKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZXJyb3IgPSBwcmV2RXJyb3IgfHwgbnVsbDsKCiAgICBmdW5jdGlvbiBjYWxsTmV4dExpc3RlbmVyKGVycikgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwgZXJyKTsKICAgICAgICBpZiAoc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgcmV0dXJuIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc2VsZi5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBlcnJvcik7CiAgICB9CgogICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciBsaXN0ZW5lciA9IGxpc3RlbmVycy5zaGlmdCgpOwogICAgICBpZiAobGlzdGVuZXIuX2lzQXN5bmMpIHsgLy8gYXN5bmNocm9ub3VzIGxpc3RlbmVyCiAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoW2NhbGxOZXh0TGlzdGVuZXJdKSk7CiAgICAgICAgcmV0dXJuOyAvLyBzdG9wIGhlcmUsIGNhbGxOZXh0TGlzdGVuZXIgd2lsbCBjb250aW51ZQogICAgICB9IGVsc2UgeyAvLyBzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgIHRyeSB7CiAgICAgICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgfQogICAgICAgIGlmIChlcnJvciAmJiBzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yKSB7CiAgICAgICAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgfSwKCiAgLyoqCiAgICogQWRkcyBvciBjb3BpZXMgYSBzZXQgb2YgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBsaXN0IG9mCiAgICogbGlzdGVuZXJzIG9yIFNlcXVlbnRpYWxFeGVjdXRvciBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0gbGlzdGVuZXJzIFttYXA8U3RyaW5nLEFycmF5PEZ1bmN0aW9uPj4sIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3JdCiAgICogICBhIGxpc3Qgb2YgZXZlbnRzIGFuZCBjYWxsYmFja3MsIG9yIGFuIGV2ZW50IGVtaXR0ZXIgb2JqZWN0CiAgICogICBjb250YWluaW5nIGxpc3RlbmVycyB0byBhZGQgdG8gdGhpcyBlbWl0dGVyIG9iamVjdC4KICAgKiBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgZW1pdHRlciBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgKiBAZXhhbXBsZSBBZGRpbmcgbGlzdGVuZXJzIGZyb20gYSBtYXAgb2YgbGlzdGVuZXJzCiAgICogICBlbWl0dGVyLmFkZExpc3RlbmVycyh7CiAgICogICAgIGV2ZW50MTogW2Z1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oKSB7IC4uLiB9XSwKICAgKiAgICAgZXZlbnQyOiBbZnVuY3Rpb24oKSB7IC4uLiB9XQogICAqICAgfSk7CiAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyIGhhcyBldmVudDEKICAgKiAgIGVtaXR0ZXIuZW1pdCgnZXZlbnQyJyk7IC8vIGVtaXR0ZXIgaGFzIGV2ZW50MgogICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGVtaXR0ZXIgb2JqZWN0CiAgICogICB2YXIgZW1pdHRlcjEgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogICAqICAgZW1pdHRlcjEub24oJ2V2ZW50MScsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICogICBlbWl0dGVyMS5vbignZXZlbnQyJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgKiAgIHZhciBlbWl0dGVyMiA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICogICBlbWl0dGVyMi5hZGRMaXN0ZW5lcnMoZW1pdHRlcjEpOwogICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDEKICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQyCiAgICovCiAgYWRkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGRMaXN0ZW5lcnMobGlzdGVuZXJzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgLy8gZXh0cmFjdCBsaXN0ZW5lcnMgaWYgcGFyYW1ldGVyIGlzIGFuIFNlcXVlbnRpYWxFeGVjdXRvciBvYmplY3QKICAgIGlmIChsaXN0ZW5lcnMuX2V2ZW50cykgbGlzdGVuZXJzID0gbGlzdGVuZXJzLl9ldmVudHM7CgogICAgQVdTLnV0aWwuZWFjaChsaXN0ZW5lcnMsIGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFja3MpIHsKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFja3MgPT09ICdmdW5jdGlvbicpIGNhbGxiYWNrcyA9IFtjYWxsYmFja3NdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIHNlbGYub24oZXZlbnQsIGNhbGxiYWNrKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4gc2VsZjsKICB9LAoKICAvKioKICAgKiBSZWdpc3RlcnMgYW4gZXZlbnQgd2l0aCB7b259IGFuZCBzYXZlcyB0aGUgY2FsbGJhY2sgaGFuZGxlIGZ1bmN0aW9uCiAgICogYXMgYSBwcm9wZXJ0eSBvbiB0aGUgZW1pdHRlciBvYmplY3QgdXNpbmcgYSBnaXZlbiBgbmFtZWAuCiAgICoKICAgKiBAcGFyYW0gbmFtZSBbU3RyaW5nXSB0aGUgcHJvcGVydHkgbmFtZSB0byBzZXQgb24gdGhpcyBvYmplY3QgY29udGFpbmluZwogICAqICAgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGhhbmRsZSBzbyB0aGF0IHRoZSBsaXN0ZW5lciBjYW4gYmUgcmVtb3ZlZCBpbgogICAqICAgdGhlIGZ1dHVyZS4KICAgKiBAcGFyYW0gKHNlZSBvbikKICAgKiBAcmV0dXJuIChzZWUgb24pCiAgICogQGV4YW1wbGUgQWRkaW5nIGEgbmFtZWQgbGlzdGVuZXIgREFUQV9DQUxMQkFDSwogICAqICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oKSB7IGRvU29tZXRoaW5nKCk7IH07CiAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXIoJ0RBVEFfQ0FMTEJBQ0snLCAnZGF0YScsIGxpc3RlbmVyKTsKICAgKgogICAqICAgLy8gdGhlIGZvbGxvd2luZyBwcmludHM6IHRydWUKICAgKiAgIGNvbnNvbGUubG9nKGVtaXR0ZXIuREFUQV9DQUxMQkFDSyA9PSBsaXN0ZW5lcik7CiAgICovCiAgYWRkTmFtZWRMaXN0ZW5lcjogZnVuY3Rpb24gYWRkTmFtZWRMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpIHsKICAgIHRoaXNbbmFtZV0gPSBjYWxsYmFjazsKICAgIHRoaXMuYWRkTGlzdGVuZXIoZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFkZE5hbWVkQXN5bmNMaXN0ZW5lcjogZnVuY3Rpb24gYWRkTmFtZWRBc3luY0xpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCkgewogICAgY2FsbGJhY2suX2lzQXN5bmMgPSB0cnVlOwogICAgcmV0dXJuIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogIH0sCgogIC8qKgogICAqIEhlbHBlciBtZXRob2QgdG8gYWRkIGEgc2V0IG9mIG5hbWVkIGxpc3RlbmVycyB1c2luZwogICAqIHthZGROYW1lZExpc3RlbmVyfS4gVGhlIGNhbGxiYWNrIGNvbnRhaW5zIGEgcGFyYW1ldGVyCiAgICogd2l0aCBhIGhhbmRsZSB0byB0aGUgYGFkZE5hbWVkTGlzdGVuZXJgIG1ldGhvZC4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihhZGQpCiAgICogICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gaXMgY2FsbGVkIGltbWVkaWF0ZWx5IGluIG9yZGVyIHRvIHByb3ZpZGUKICAgKiAgIHRoZSBgYWRkYCBmdW5jdGlvbiB0byB0aGUgYmxvY2suIFRoaXMgc2ltcGxpZmllcyB0aGUgYWRkaXRpb24gb2YKICAgKiAgIGEgbGFyZ2UgZ3JvdXAgb2YgbmFtZWQgbGlzdGVuZXJzLgogICAqICAgQHBhcmFtIGFkZCBbRnVuY3Rpb25dIHRoZSB7YWRkTmFtZWRMaXN0ZW5lcn0gZnVuY3Rpb24gdG8gY2FsbAogICAqICAgICB3aGVuIHJlZ2lzdGVyaW5nIGxpc3RlbmVycy4KICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzCiAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAqICAgICBhZGQoJ0RBVEFfQ0FMTEJBQ0snLCAnZGF0YScsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICogICAgIGFkZCgnT1RIRVInLCAnb3RoZXJFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICogICAgIGFkZCgnTEFTVCcsICdsYXN0RXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAqICAgfSk7CiAgICoKICAgKiAgIC8vIHRoZXNlIHByb3BlcnRpZXMgYXJlIG5vdyBzZXQ6CiAgICogICBlbWl0dGVyLkRBVEFfQ0FMTEJBQ0s7CiAgICogICBlbWl0dGVyLk9USEVSOwogICAqICAgZW1pdHRlci5MQVNUOwogICAqLwogIGFkZE5hbWVkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVycyhjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY2FsbGJhY2soCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYuYWRkTmFtZWRMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICB9LAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLmFkZE5hbWVkQXN5bmNMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICB9CiAgICApOwogICAgcmV0dXJuIHRoaXM7CiAgfQp9KTsKCi8qKgogKiB7b259IGlzIHRoZSBwcmVmZXJlZCBtZXRob2QuCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5vbjsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvcjsKCn0seyIuL2NvcmUiOjE5fV0sNjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwp2YXIgQXBpID0gcmVxdWlyZSgnLi9tb2RlbC9hcGknKTsKdmFyIHJlZ2lvbkNvbmZpZyA9IHJlcXVpcmUoJy4vcmVnaW9uX2NvbmZpZycpOwoKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0Owp2YXIgY2xpZW50Q291bnQgPSAwOwp2YXIgcmVnaW9uX3V0aWxzID0gcmVxdWlyZSgnLi9yZWdpb24vdXRpbHMnKTsKCi8qKgogKiBUaGUgc2VydmljZSBjbGFzcyByZXByZXNlbnRpbmcgYW4gQVdTIHNlcnZpY2UuCiAqCiAqIEBjbGFzc19hYnN0cmFjdCBUaGlzIGNsYXNzIGlzIGFuIGFic3RyYWN0IGNsYXNzLgogKgogKiBAIWF0dHJpYnV0ZSBhcGlWZXJzaW9ucwogKiAgIEByZXR1cm4gW0FycmF5PFN0cmluZz5dIHRoZSBsaXN0IG9mIEFQSSB2ZXJzaW9ucyBzdXBwb3J0ZWQgYnkgdGhpcyBzZXJ2aWNlLgogKiAgIEByZWFkb25seQogKi8KQVdTLlNlcnZpY2UgPSBpbmhlcml0KHsKICAvKioKICAgKiBDcmVhdGUgYSBuZXcgc2VydmljZSBvYmplY3Qgd2l0aCBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICoKICAgKiBAcGFyYW0gY29uZmlnIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTZXJ2aWNlKGNvbmZpZykgewogICAgaWYgKCF0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MpIHsKICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgJ1NlcnZpY2UgbXVzdCBiZSBjb25zdHJ1Y3RlZCB3aXRoIGBuZXdcJyBvcGVyYXRvcicpOwogICAgfQoKICAgIGlmIChjb25maWcpIHsKICAgICAgaWYgKGNvbmZpZy5yZWdpb24pIHsKICAgICAgICB2YXIgcmVnaW9uID0gY29uZmlnLnJlZ2lvbjsKICAgICAgICBpZiAocmVnaW9uX3V0aWxzLmlzRmlwc1JlZ2lvbihyZWdpb24pKSB7CiAgICAgICAgICBjb25maWcucmVnaW9uID0gcmVnaW9uX3V0aWxzLmdldFJlYWxSZWdpb24ocmVnaW9uKTsKICAgICAgICAgIGNvbmZpZy51c2VGaXBzRW5kcG9pbnQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAocmVnaW9uX3V0aWxzLmlzR2xvYmFsUmVnaW9uKHJlZ2lvbikpIHsKICAgICAgICAgIGNvbmZpZy5yZWdpb24gPSByZWdpb25fdXRpbHMuZ2V0UmVhbFJlZ2lvbihyZWdpb24pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodHlwZW9mIGNvbmZpZy51c2VEdWFsc3RhY2sgPT09ICdib29sZWFuJwogICAgICAgICYmIHR5cGVvZiBjb25maWcudXNlRHVhbHN0YWNrRW5kcG9pbnQgIT09ICdib29sZWFuJykgewogICAgICAgIGNvbmZpZy51c2VEdWFsc3RhY2tFbmRwb2ludCA9IGNvbmZpZy51c2VEdWFsc3RhY2s7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgU2VydmljZUNsYXNzID0gdGhpcy5sb2FkU2VydmljZUNsYXNzKGNvbmZpZyB8fCB7fSk7CiAgICBpZiAoU2VydmljZUNsYXNzKSB7CiAgICAgIHZhciBvcmlnaW5hbENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY29uZmlnKTsKICAgICAgdmFyIHN2YyA9IG5ldyBTZXJ2aWNlQ2xhc3MoY29uZmlnKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHN2YywgJ19vcmlnaW5hbENvbmZpZycsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgeyByZXR1cm4gb3JpZ2luYWxDb25maWc7IH0sCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBzdmMuX2NsaWVudElkID0gKytjbGllbnRDb3VudDsKICAgICAgcmV0dXJuIHN2YzsKICAgIH0KICAgIHRoaXMuaW5pdGlhbGl6ZShjb25maWcpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoY29uZmlnKSB7CiAgICB2YXIgc3ZjQ29uZmlnID0gQVdTLmNvbmZpZ1t0aGlzLnNlcnZpY2VJZGVudGlmaWVyXTsKICAgIHRoaXMuY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICBpZiAoc3ZjQ29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoc3ZjQ29uZmlnLCB0cnVlKTsKICAgIGlmIChjb25maWcpIHRoaXMuY29uZmlnLnVwZGF0ZShjb25maWcsIHRydWUpOwoKICAgIHRoaXMudmFsaWRhdGVTZXJ2aWNlKCk7CiAgICBpZiAoIXRoaXMuY29uZmlnLmVuZHBvaW50KSByZWdpb25Db25maWcuY29uZmlndXJlRW5kcG9pbnQodGhpcyk7CgogICAgdGhpcy5jb25maWcuZW5kcG9pbnQgPSB0aGlzLmVuZHBvaW50RnJvbVRlbXBsYXRlKHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgIHRoaXMuc2V0RW5kcG9pbnQodGhpcy5jb25maWcuZW5kcG9pbnQpOwogICAgLy9lbmFibGUgYXR0YWNoaW5nIGxpc3RlbmVycyB0byBzZXJ2aWNlIGNsaWVudAogICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgQVdTLlNlcnZpY2UuYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnModGhpcyk7CiAgICBpZiAoKHRoaXMuY29uZmlnLmNsaWVudFNpZGVNb25pdG9yaW5nIHx8IEFXUy5TZXJ2aWNlLl9jbGllbnRTaWRlTW9uaXRvcmluZykgJiYgdGhpcy5wdWJsaXNoZXIpIHsKICAgICAgdmFyIHB1Ymxpc2hlciA9IHRoaXMucHVibGlzaGVyOwogICAgICB0aGlzLmFkZE5hbWVkTGlzdGVuZXIoJ1BVQkxJU0hfQVBJX0NBTEwnLCAnYXBpQ2FsbCcsIGZ1bmN0aW9uIFBVQkxJU0hfQVBJX0NBTEwoZXZlbnQpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICB9KTsKICAgICAgdGhpcy5hZGROYW1lZExpc3RlbmVyKCdQVUJMSVNIX0FQSV9BVFRFTVBUJywgJ2FwaUNhbGxBdHRlbXB0JywgZnVuY3Rpb24gUFVCTElTSF9BUElfQVRURU1QVChldmVudCkgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7cHVibGlzaGVyLmV2ZW50SGFuZGxlcihldmVudCk7fSk7CiAgICAgIH0pOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhbGlkYXRlU2VydmljZTogZnVuY3Rpb24gdmFsaWRhdGVTZXJ2aWNlKCkgewogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWRTZXJ2aWNlQ2xhc3M6IGZ1bmN0aW9uIGxvYWRTZXJ2aWNlQ2xhc3Moc2VydmljZUNvbmZpZykgewogICAgdmFyIGNvbmZpZyA9IHNlcnZpY2VDb25maWc7CiAgICBpZiAoIUFXUy51dGlsLmlzRW1wdHkodGhpcy5hcGkpKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIGlmIChjb25maWcuYXBpQ29uZmlnKSB7CiAgICAgIHJldHVybiBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlQXBpKHRoaXMuY29uc3RydWN0b3IsIGNvbmZpZy5hcGlDb25maWcpOwogICAgfSBlbHNlIGlmICghdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKEFXUy5jb25maWcpOwogICAgICBjb25maWcudXBkYXRlKHNlcnZpY2VDb25maWcsIHRydWUpOwogICAgICB2YXIgdmVyc2lvbiA9IGNvbmZpZy5hcGlWZXJzaW9uc1t0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyXTsKICAgICAgdmVyc2lvbiA9IHZlcnNpb24gfHwgY29uZmlnLmFwaVZlcnNpb247CiAgICAgIHJldHVybiB0aGlzLmdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRMYXRlc3RTZXJ2aWNlQ2xhc3M6IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKSB7CiAgICB2ZXJzaW9uID0gdGhpcy5nZXRMYXRlc3RTZXJ2aWNlVmVyc2lvbih2ZXJzaW9uKTsKICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzW3ZlcnNpb25dID09PSBudWxsKSB7CiAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgdmVyc2lvbik7CiAgICB9CgogICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXNbdmVyc2lvbl07CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0TGF0ZXN0U2VydmljZVZlcnNpb246IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pIHsKICAgIGlmICghdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcyB8fCB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzLmxlbmd0aCA9PT0gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNlcnZpY2VzIGRlZmluZWQgb24gJyArCiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyKTsKICAgIH0KCiAgICBpZiAoIXZlcnNpb24pIHsKICAgICAgdmVyc2lvbiA9ICdsYXRlc3QnOwogICAgfSBlbHNlIGlmIChBV1MudXRpbC5pc1R5cGUodmVyc2lvbiwgRGF0ZSkpIHsKICAgICAgdmVyc2lvbiA9IEFXUy51dGlsLmRhdGUuaXNvODYwMSh2ZXJzaW9uKS5zcGxpdCgnVCcpWzBdOwogICAgfQoKICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgcmV0dXJuIHZlcnNpb247CiAgICB9CgogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzKS5zb3J0KCk7CiAgICB2YXIgc2VsZWN0ZWRWZXJzaW9uID0gbnVsbDsKICAgIGZvciAodmFyIGkgPSBrZXlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIC8vIHZlcnNpb25zIHRoYXQgZW5kIGluICIqIiBhcmUgbm90IGF2YWlsYWJsZSBvbiBkaXNrIGFuZCBjYW4gYmUKICAgICAgLy8gc2tpcHBlZCwgc28gZG8gbm90IGNob29zZSB0aGVzZSBhcyBzZWxlY3RlZFZlcnNpb25zCiAgICAgIGlmIChrZXlzW2ldW2tleXNbaV0ubGVuZ3RoIC0gMV0gIT09ICcqJykgewogICAgICAgIHNlbGVjdGVkVmVyc2lvbiA9IGtleXNbaV07CiAgICAgIH0KICAgICAgaWYgKGtleXNbaV0uc3Vic3RyKDAsIDEwKSA8PSB2ZXJzaW9uKSB7CiAgICAgICAgcmV0dXJuIHNlbGVjdGVkVmVyc2lvbjsKICAgICAgfQogICAgfQoKICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgJyArIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXIgKwogICAgICAgICAgICAgICAgICAgICcgQVBJIHRvIHNhdGlzZnkgdmVyc2lvbiBjb25zdHJhaW50IGAnICsgdmVyc2lvbiArICdcJycpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFwaToge30sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGRlZmF1bHRSZXRyeUNvdW50OiAzLAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjdXN0b21pemVSZXF1ZXN0czogZnVuY3Rpb24gY3VzdG9taXplUmVxdWVzdHMoY2FsbGJhY2spIHsKICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IG51bGw7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID0gY2FsbGJhY2s7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY2FsbGJhY2sgdHlwZSBcJycgKyB0eXBlb2YgY2FsbGJhY2sgKyAnXCcgcHJvdmlkZWQgaW4gY3VzdG9taXplUmVxdWVzdHMnKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMuCiAgICoKICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIGlucHV0IG9wdGlvbnMgZm9yIHRoZSBvcGVyYXRpb24KICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAqICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAqLwogIG1ha2VSZXF1ZXN0OiBmdW5jdGlvbiBtYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spIHsKICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICBwYXJhbXMgPSBudWxsOwogICAgfQoKICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgIGlmICh0aGlzLmNvbmZpZy5wYXJhbXMpIHsgLy8gY29weSBvbmx5IHRvcGxldmVsIGJvdW5kIHBhcmFtcwogICAgICB2YXIgcnVsZXMgPSB0aGlzLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl07CiAgICAgIGlmIChydWxlcykgewogICAgICAgIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocGFyYW1zKTsKICAgICAgICBBV1MudXRpbC5lYWNoKHRoaXMuY29uZmlnLnBhcmFtcywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKHJ1bGVzLmlucHV0Lm1lbWJlcnNba2V5XSkgewogICAgICAgICAgICBpZiAocGFyYW1zW2tleV0gPT09IHVuZGVmaW5lZCB8fCBwYXJhbXNba2V5XSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIHZhciByZXF1ZXN0ID0gbmV3IEFXUy5SZXF1ZXN0KHRoaXMsIG9wZXJhdGlvbiwgcGFyYW1zKTsKICAgIHRoaXMuYWRkQWxsUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KTsKICAgIHRoaXMuYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXIocmVxdWVzdCk7CiAgICBpZiAoY2FsbGJhY2spIHJlcXVlc3Quc2VuZChjYWxsYmFjayk7CiAgICByZXR1cm4gcmVxdWVzdDsKICB9LAoKICAvKioKICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMsIHdpdGhvdXQKICAgKiBhbnkgYXV0aGVudGljYXRpb24gZGF0YS4gVGhpcyBtZXRob2QgaXMgdXNlZnVsIGZvciAicHVibGljIiBBUEkgb3BlcmF0aW9ucy4KICAgKgogICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG5hbWUgb2YgdGhlIG9wZXJhdGlvbiB0byBjYWxsIG9uIHRoZSBzZXJ2aWNlLgogICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICogICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgKiAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICovCiAgbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgIHBhcmFtcyA9IHt9OwogICAgfQoKICAgIHZhciByZXF1ZXN0ID0gdGhpcy5tYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcykudG9VbmF1dGhlbnRpY2F0ZWQoKTsKICAgIHJldHVybiBjYWxsYmFjayA/IHJlcXVlc3Quc2VuZChjYWxsYmFjaykgOiByZXF1ZXN0OwogIH0sCgogIC8qKgogICAqIFdhaXRzIGZvciBhIGdpdmVuIHN0YXRlCiAgICoKICAgKiBAcGFyYW0gc3RhdGUgW1N0cmluZ10gdGhlIHN0YXRlIG9uIHRoZSBzZXJ2aWNlIHRvIHdhaXQgZm9yCiAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBwYXJhbWV0ZXJzIHRvIHBhc3Mgd2l0aCBlYWNoIHJlcXVlc3QKICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHdhaXRlcgogICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIuZGVsYXkgW051bWJlcl0gVGhlIG51bWJlciBvZiBzZWNvbmRzIHRvIHdhaXQgYmV0d2VlbgogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdHMKICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLm1heEF0dGVtcHRzIFtOdW1iZXJdIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZXF1ZXN0cwogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gc2VuZCB3aGlsZSB3YWl0aW5nCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgKiAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgKi8KICB3YWl0Rm9yOiBmdW5jdGlvbiB3YWl0Rm9yKHN0YXRlLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICB2YXIgd2FpdGVyID0gbmV3IEFXUy5SZXNvdXJjZVdhaXRlcih0aGlzLCBzdGF0ZSk7CiAgICByZXR1cm4gd2FpdGVyLndhaXQocGFyYW1zLCBjYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYWRkQWxsUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gYWRkQWxsUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICB2YXIgbGlzdCA9IFtBV1MuZXZlbnRzLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZSwgdGhpcy5zZXJ2aWNlSW50ZXJmYWNlKCksCiAgICAgICAgICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZVBvc3RdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChsaXN0W2ldKSByZXF1ZXN0LmFkZExpc3RlbmVycyhsaXN0W2ldKTsKICAgIH0KCiAgICAvLyBkaXNhYmxlIHBhcmFtZXRlciB2YWxpZGF0aW9uCiAgICBpZiAoIXRoaXMuY29uZmlnLnBhcmFtVmFsaWRhdGlvbikgewogICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICB9CgogICAgaWYgKHRoaXMuY29uZmlnLmxvZ2dlcikgeyAvLyBhZGQgbG9nZ2luZyBldmVudHMKICAgICAgcmVxdWVzdC5hZGRMaXN0ZW5lcnMoQVdTLkV2ZW50TGlzdGVuZXJzLkxvZ2dlcik7CiAgICB9CgogICAgdGhpcy5zZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCk7CiAgICAvLyBjYWxsIHByb3RvdHlwZSdzIGN1c3RvbVJlcXVlc3RIYW5kbGVyCiAgICBpZiAodHlwZW9mIHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlLmN1c3RvbVJlcXVlc3RIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlLmN1c3RvbVJlcXVlc3RIYW5kbGVyKHJlcXVlc3QpOwogICAgfQogICAgLy8gY2FsbCBpbnN0YW5jZSdzIGN1c3RvbVJlcXVlc3RIYW5kbGVyCiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsICdjdXN0b21SZXF1ZXN0SGFuZGxlcicpICYmIHR5cGVvZiB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIocmVxdWVzdCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogRXZlbnQgcmVjb3JkaW5nIG1ldHJpY3MgZm9yIGEgd2hvbGUgQVBJIGNhbGwuCiAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgbWV0cmljcwogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFwaUNhbGxFdmVudDogZnVuY3Rpb24gYXBpQ2FsbEV2ZW50KHJlcXVlc3QpIHsKICAgIHZhciBhcGkgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHsKICAgICAgVHlwZTogJ0FwaUNhbGwnLAogICAgICBBcGk6IGFwaSA/IGFwaS5uYW1lIDogcmVxdWVzdC5vcGVyYXRpb24sCiAgICAgIFZlcnNpb246IDEsCiAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgIFJlZ2lvbjogcmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb24sCiAgICAgIE1heFJldHJpZXNFeGNlZWRlZDogMCwKICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgfTsKICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgbW9uaXRvcmluZ0V2ZW50LkZpbmFsSHR0cFN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgIH0KICAgIGlmIChyZXNwb25zZS5lcnJvcikgewogICAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgICAgdmFyIHN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgaWYgKHN0YXR1c0NvZGUgPiAyOTkpIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsQXdzRXhjZXB0aW9uID0gZXJyb3IuY29kZTsKICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsQXdzRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsU2RrRXhjZXB0aW9uID0gZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lOwogICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICB9LAoKICAvKioKICAgKiBFdmVudCByZWNvcmRpbmcgbWV0cmljcyBmb3IgYW4gQVBJIGNhbGwgYXR0ZW1wdC4KICAgKiBAcmV0dXJucyB7b2JqZWN0fSBhIHN1YnNldCBvZiBhcGkgY2FsbCBhdHRlbXB0IG1ldHJpY3MKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhcGlBdHRlbXB0RXZlbnQ6IGZ1bmN0aW9uIGFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KSB7CiAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgIFR5cGU6ICdBcGlDYWxsQXR0ZW1wdCcsCiAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgVmVyc2lvbjogMSwKICAgICAgU2VydmljZTogcmVxdWVzdC5zZXJ2aWNlLmFwaS5zZXJ2aWNlSWQgfHwgcmVxdWVzdC5zZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgRnFkbjogcmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgfTsKICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgbW9uaXRvcmluZ0V2ZW50Lkh0dHBTdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICB9CiAgICBpZiAoCiAgICAgICFyZXF1ZXN0Ll91bkF1dGhlbnRpY2F0ZWQgJiYKICAgICAgcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscyAmJgogICAgICByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkCiAgICApIHsKICAgICAgbW9uaXRvcmluZ0V2ZW50LkFjY2Vzc0tleSA9IHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CiAgICB9CiAgICBpZiAoIXJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzKSByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgaWYgKHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSkgewogICAgICBtb25pdG9yaW5nRXZlbnQuU2Vzc2lvblRva2VuID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddOwogICAgfQogICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ10pIHsKICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpuUmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKICAgIH0KICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddKSB7CiAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16UmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXTsKICAgIH0KICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotaWQtMiddKSB7CiAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16SWQyID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXTsKICAgIH0KICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgfSwKCiAgLyoqCiAgICogQWRkIG1ldHJpY3Mgb2YgZmFpbGVkIHJlcXVlc3QuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXR0ZW1wdEZhaWxFdmVudDogZnVuY3Rpb24gYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KSB7CiAgICB2YXIgbW9uaXRvcmluZ0V2ZW50ID0gdGhpcy5hcGlBdHRlbXB0RXZlbnQocmVxdWVzdCk7CiAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPiAyOTkgKSB7CiAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuQXdzRXhjZXB0aW9uID0gZXJyb3IuY29kZTsKICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5Bd3NFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChlcnJvci5jb2RlIHx8IGVycm9yLm5hbWUpIG1vbml0b3JpbmdFdmVudC5TZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICB9CiAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogIH0sCgogIC8qKgogICAqIEF0dGFjaCBsaXN0ZW5lcnMgdG8gcmVxdWVzdCBvYmplY3QgdG8gZmV0Y2ggbWV0cmljcyBvZiBlYWNoIHJlcXVlc3QKICAgKiBhbmQgZW1pdCBkYXRhIG9iamVjdCB0aHJvdWdoIFwnQXBpQ2FsbFwnIGFuZCBcJ0FwaUNhbGxBdHRlbXB0XCcgZXZlbnRzLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGF0dGFjaE1vbml0b3JpbmdFbWl0dGVyOiBmdW5jdGlvbiBhdHRhY2hNb25pdG9yaW5nRW1pdHRlcihyZXF1ZXN0KSB7CiAgICB2YXIgYXR0ZW1wdFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgbWFya2luZyB0aGUgYmVnaW5uaW5nIG9mIGEgcmVxdWVzdCBhdHRlbXB0CiAgICB2YXIgYXR0ZW1wdFN0YXJ0UmVhbFRpbWU7IC8vU3RhcnQgdGltZSBvZiByZXF1ZXN0IGF0dGVtcHQuIFVzZWQgdG8gY2FsY3VsYXRpbmcgYXR0ZW1wdExhdGVuY3kKICAgIHZhciBhdHRlbXB0TGF0ZW5jeTsgLy9sYXRlbmN5IGZyb20gcmVxdWVzdCBzZW50IG91dCB0byBodHRwIHJlc3BvbnNlIHJlYWNoaW5nIFNESwogICAgdmFyIGNhbGxTdGFydFJlYWxUaW1lOyAvL1N0YXJ0IHRpbWUgb2YgQVBJIGNhbGwuIFVzZWQgdG8gY2FsY3VsYXRpbmcgQVBJIGNhbGwgbGF0ZW5jeQogICAgdmFyIGF0dGVtcHRDb3VudCA9IDA7IC8vcmVxdWVzdC5yZXRyeUNvdW50IGlzIG5vdCByZWxpYWJsZSBoZXJlCiAgICB2YXIgcmVnaW9uOyAvL3JlZ2lvbiBjYWNoZSByZWdpb24gZm9yIGVhY2ggYXR0ZW1wdCBzaW5jZSBpdCBjYW4gYmUgdXBkYXRlZCBpbiBwbGFzZSAoZS5nLiBzMykKICAgIHZhciBjYWxsVGltZXN0YW1wOyAvL3RpbWVzdGFtcCB3aGVuIHRoZSByZXF1ZXN0IGlzIGNyZWF0ZWQKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBhZGRUb0hlYWQgPSB0cnVlOwoKICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24gKCkgewogICAgICBjYWxsU3RhcnRSZWFsVGltZSA9IEFXUy51dGlsLnJlYWxDbG9jay5ub3coKTsKICAgICAgY2FsbFRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICB9LCBhZGRUb0hlYWQpOwogICAgcmVxdWVzdC5vbignc2lnbicsIGZ1bmN0aW9uICgpIHsKICAgICAgYXR0ZW1wdFN0YXJ0UmVhbFRpbWUgPSBBV1MudXRpbC5yZWFsQ2xvY2subm93KCk7CiAgICAgIGF0dGVtcHRUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICByZWdpb24gPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbjsKICAgICAgYXR0ZW1wdENvdW50Kys7CiAgICB9LCBhZGRUb0hlYWQpOwogICAgcmVxdWVzdC5vbigndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uKCkgewogICAgICBhdHRlbXB0TGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgfSk7CiAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMX0FUVEVNUFQnLCAnc3VjY2VzcycsIGZ1bmN0aW9uIEFQSV9DQUxMX0FUVEVNUFQoKSB7CiAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgIGFwaUF0dGVtcHRFdmVudC5BdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5ID49IDAgPyBhdHRlbXB0TGF0ZW5jeSA6IDA7CiAgICAgIGFwaUF0dGVtcHRFdmVudC5SZWdpb24gPSByZWdpb247CiAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICB9KTsKICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVF9SRVRSWScsICdyZXRyeScsIGZ1bmN0aW9uIEFQSV9DQUxMX0FUVEVNUFRfUkVUUlkoKSB7CiAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmF0dGVtcHRGYWlsRXZlbnQocmVxdWVzdCk7CiAgICAgIGFwaUF0dGVtcHRFdmVudC5UaW1lc3RhbXAgPSBhdHRlbXB0VGltZXN0YW1wOwogICAgICAvL2F0dGVtcHRMYXRlbmN5IG1heSBub3QgYmUgYXZhaWxhYmxlIGlmIGZhaWwgYmVmb3JlIHJlc3BvbnNlCiAgICAgIGF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgfHwKICAgICAgICBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGF0dGVtcHRTdGFydFJlYWxUaW1lKTsKICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgYXBpQXR0ZW1wdEV2ZW50LlJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgc2VsZi5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFthcGlBdHRlbXB0RXZlbnRdKTsKICAgIH0pOwogICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTCcsICdjb21wbGV0ZScsIGZ1bmN0aW9uIEFQSV9DQUxMKCkgewogICAgICB2YXIgYXBpQ2FsbEV2ZW50ID0gc2VsZi5hcGlDYWxsRXZlbnQocmVxdWVzdCk7CiAgICAgIGFwaUNhbGxFdmVudC5BdHRlbXB0Q291bnQgPSBhdHRlbXB0Q291bnQ7CiAgICAgIGlmIChhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50IDw9IDApIHJldHVybjsKICAgICAgYXBpQ2FsbEV2ZW50LlRpbWVzdGFtcCA9IGNhbGxUaW1lc3RhbXA7CiAgICAgIHZhciBsYXRlbmN5ID0gTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBjYWxsU3RhcnRSZWFsVGltZSk7CiAgICAgIGFwaUNhbGxFdmVudC5MYXRlbmN5ID0gbGF0ZW5jeSA+PSAwID8gbGF0ZW5jeSA6IDA7CiAgICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICAgIGlmICgKICAgICAgICByZXNwb25zZS5lcnJvciAmJgogICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5YWJsZSAmJgogICAgICAgIHR5cGVvZiByZXNwb25zZS5yZXRyeUNvdW50ID09PSAnbnVtYmVyJyAmJgogICAgICAgIHR5cGVvZiByZXNwb25zZS5tYXhSZXRyaWVzID09PSAnbnVtYmVyJyAmJgogICAgICAgIChyZXNwb25zZS5yZXRyeUNvdW50ID49IHJlc3BvbnNlLm1heFJldHJpZXMpCiAgICAgICkgewogICAgICAgIGFwaUNhbGxFdmVudC5NYXhSZXRyaWVzRXhjZWVkZWQgPSAxOwogICAgICB9CiAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbCcsIFthcGlDYWxsRXZlbnRdKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHNldHVwIGFueSBjdXN0b20gcmVxdWVzdCBsaXN0ZW5lcnMgZm9yIGVhY2gKICAgKiBuZXcgcmVxdWVzdCB0byB0aGUgc2VydmljZS4KICAgKgogICAqIEBtZXRob2RfYWJzdHJhY3QgVGhpcyBpcyBhbiBhYnN0cmFjdCBtZXRob2QuCiAgICovCiAgc2V0dXBSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBzZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogIH0sCgogIC8qKgogICAqIEdldHMgdGhlIHNpZ25pbmcgbmFtZSBmb3IgYSBnaXZlbiByZXF1ZXN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0U2lnbmluZ05hbWU6IGZ1bmN0aW9uIGdldFNpZ25pbmdOYW1lKCkgewogICAgcmV0dXJuIHRoaXMuYXBpLnNpZ25pbmdOYW1lIHx8IHRoaXMuYXBpLmVuZHBvaW50UHJlZml4OwogIH0sCgogIC8qKgogICAqIEdldHMgdGhlIHNpZ25lciBjbGFzcyBmb3IgYSBnaXZlbiByZXF1ZXN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0U2lnbmVyQ2xhc3M6IGZ1bmN0aW9uIGdldFNpZ25lckNsYXNzKHJlcXVlc3QpIHsKICAgIHZhciB2ZXJzaW9uOwogICAgLy8gZ2V0IG9wZXJhdGlvbiBhdXRodHlwZSBpZiBwcmVzZW50CiAgICB2YXIgb3BlcmF0aW9uID0gbnVsbDsKICAgIHZhciBhdXRodHlwZSA9ICcnOwogICAgaWYgKHJlcXVlc3QpIHsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgIG9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIHx8IG51bGw7CiAgICAgIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICB9CiAgICBpZiAodGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgewogICAgICB2ZXJzaW9uID0gdGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbjsKICAgIH0gZWxzZSBpZiAoYXV0aHR5cGUgPT09ICd2NCcgfHwgYXV0aHR5cGUgPT09ICd2NC11bnNpZ25lZC1ib2R5JykgewogICAgICB2ZXJzaW9uID0gJ3Y0JzsKICAgIH0gZWxzZSB7CiAgICAgIHZlcnNpb24gPSB0aGlzLmFwaS5zaWduYXR1cmVWZXJzaW9uOwogICAgfQogICAgcmV0dXJuIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbih2ZXJzaW9uKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzZXJ2aWNlSW50ZXJmYWNlOiBmdW5jdGlvbiBzZXJ2aWNlSW50ZXJmYWNlKCkgewogICAgc3dpdGNoICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICBjYXNlICdlYzInOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlF1ZXJ5OwogICAgICBjYXNlICdxdWVyeSc6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUXVlcnk7CiAgICAgIGNhc2UgJ2pzb24nOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLkpzb247CiAgICAgIGNhc2UgJ3Jlc3QtanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUmVzdEpzb247CiAgICAgIGNhc2UgJ3Jlc3QteG1sJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5SZXN0WG1sOwogICAgfQogICAgaWYgKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzZXJ2aWNlIGBwcm90b2NvbFwnICcgKwogICAgICAgIHRoaXMuYXBpLnByb3RvY29sICsgJyBpbiBBUEkgY29uZmlnJyk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc3VjY2Vzc2Z1bFJlc3BvbnNlOiBmdW5jdGlvbiBzdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkgewogICAgcmV0dXJuIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDA7CiAgfSwKCiAgLyoqCiAgICogSG93IG1hbnkgdGltZXMgYSBmYWlsZWQgcmVxdWVzdCBzaG91bGQgYmUgcmV0cmllZCBiZWZvcmUgZ2l2aW5nIHVwLgogICAqIHRoZSBkZWZhdWx0UmV0cnlDb3VudCBjYW4gYmUgb3ZlcnJpZGVuIGJ5IHNlcnZpY2UgY2xhc3Nlcy4KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG51bVJldHJpZXM6IGZ1bmN0aW9uIG51bVJldHJpZXMoKSB7CiAgICBpZiAodGhpcy5jb25maWcubWF4UmV0cmllcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5tYXhSZXRyaWVzOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuZGVmYXVsdFJldHJ5Q291bnQ7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgcmV0cnlEZWxheXM6IGZ1bmN0aW9uIHJldHJ5RGVsYXlzKHJldHJ5Q291bnQsIGVycikgewogICAgcmV0dXJuIEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgdGhpcy5jb25maWcucmV0cnlEZWxheU9wdGlvbnMsIGVycik7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgcmV0cnlhYmxlRXJyb3I6IGZ1bmN0aW9uIHJldHJ5YWJsZUVycm9yKGVycm9yKSB7CiAgICBpZiAodGhpcy50aW1lb3V0RXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0aGlzLm5ldHdvcmtpbmdFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgaWYgKHRoaXMuZXhwaXJlZENyZWRlbnRpYWxzRXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0aGlzLnRocm90dGxlZEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA+PSA1MDApIHJldHVybiB0cnVlOwogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG5ldHdvcmtpbmdFcnJvcjogZnVuY3Rpb24gbmV0d29ya2luZ0Vycm9yKGVycm9yKSB7CiAgICByZXR1cm4gZXJyb3IuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcic7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdGltZW91dEVycm9yOiBmdW5jdGlvbiB0aW1lb3V0RXJyb3IoZXJyb3IpIHsKICAgIHJldHVybiBlcnJvci5jb2RlID09PSAnVGltZW91dEVycm9yJzsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBleHBpcmVkQ3JlZGVudGlhbHNFcnJvcjogZnVuY3Rpb24gZXhwaXJlZENyZWRlbnRpYWxzRXJyb3IoZXJyb3IpIHsKICAgIC8vIFRPRE8gOiB0aGlzIG9ubHkgaGFuZGxlcyAqb25lKiBvZiB0aGUgZXhwaXJlZCBjcmVkZW50aWFsIGNvZGVzCiAgICByZXR1cm4gKGVycm9yLmNvZGUgPT09ICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjbG9ja1NrZXdFcnJvcjogZnVuY3Rpb24gY2xvY2tTa2V3RXJyb3IoZXJyb3IpIHsKICAgIHN3aXRjaCAoZXJyb3IuY29kZSkgewogICAgICBjYXNlICdSZXF1ZXN0VGltZVRvb1NrZXdlZCc6CiAgICAgIGNhc2UgJ1JlcXVlc3RFeHBpcmVkJzoKICAgICAgY2FzZSAnSW52YWxpZFNpZ25hdHVyZUV4Y2VwdGlvbic6CiAgICAgIGNhc2UgJ1NpZ25hdHVyZURvZXNOb3RNYXRjaCc6CiAgICAgIGNhc2UgJ0F1dGhGYWlsdXJlJzoKICAgICAgY2FzZSAnUmVxdWVzdEluVGhlRnV0dXJlJzoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldFNrZXdDb3JyZWN0ZWREYXRlOiBmdW5jdGlvbiBnZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIHsKICAgIHJldHVybiBuZXcgRGF0ZShEYXRlLm5vdygpICsgdGhpcy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFwcGx5Q2xvY2tPZmZzZXQ6IGZ1bmN0aW9uIGFwcGx5Q2xvY2tPZmZzZXQobmV3U2VydmVyVGltZSkgewogICAgaWYgKG5ld1NlcnZlclRpbWUpIHsKICAgICAgdGhpcy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBuZXdTZXJ2ZXJUaW1lIC0gRGF0ZS5ub3coKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpc0Nsb2NrU2tld2VkOiBmdW5jdGlvbiBpc0Nsb2NrU2tld2VkKG5ld1NlcnZlclRpbWUpIHsKICAgIGlmIChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgIHJldHVybiBNYXRoLmFicyh0aGlzLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpIC0gbmV3U2VydmVyVGltZSkgPj0gMzAwMDAwOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHRocm90dGxlZEVycm9yOiBmdW5jdGlvbiB0aHJvdHRsZWRFcnJvcihlcnJvcikgewogICAgLy8gdGhpcyBsb2dpYyB2YXJpZXMgYmV0d2VlbiBzZXJ2aWNlcwogICAgaWYgKGVycm9yLnN0YXR1c0NvZGUgPT09IDQyOSkgcmV0dXJuIHRydWU7CiAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHsKICAgICAgY2FzZSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nOgogICAgICBjYXNlICdUaHJvdHRsaW5nJzoKICAgICAgY2FzZSAnVGhyb3R0bGluZ0V4Y2VwdGlvbic6CiAgICAgIGNhc2UgJ1JlcXVlc3RMaW1pdEV4Y2VlZGVkJzoKICAgICAgY2FzZSAnUmVxdWVzdFRocm90dGxlZCc6CiAgICAgIGNhc2UgJ1JlcXVlc3RUaHJvdHRsZWRFeGNlcHRpb24nOgogICAgICBjYXNlICdUb29NYW55UmVxdWVzdHNFeGNlcHRpb24nOgogICAgICBjYXNlICdUcmFuc2FjdGlvbkluUHJvZ3Jlc3NFeGNlcHRpb24nOiAvL2R5bmFtb2RiCiAgICAgIGNhc2UgJ0VDMlRocm90dGxlZEV4Y2VwdGlvbic6CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGVuZHBvaW50RnJvbVRlbXBsYXRlOiBmdW5jdGlvbiBlbmRwb2ludEZyb21UZW1wbGF0ZShlbmRwb2ludCkgewogICAgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHJldHVybiBlbmRwb2ludDsKCiAgICB2YXIgZSA9IGVuZHBvaW50OwogICAgZSA9IGUucmVwbGFjZSgvXHtzZXJ2aWNlXH0vZywgdGhpcy5hcGkuZW5kcG9pbnRQcmVmaXgpOwogICAgZSA9IGUucmVwbGFjZSgvXHtyZWdpb25cfS9nLCB0aGlzLmNvbmZpZy5yZWdpb24pOwogICAgZSA9IGUucmVwbGFjZSgvXHtzY2hlbWVcfS9nLCB0aGlzLmNvbmZpZy5zc2xFbmFibGVkID8gJ2h0dHBzJyA6ICdodHRwJyk7CiAgICByZXR1cm4gZTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzZXRFbmRwb2ludDogZnVuY3Rpb24gc2V0RW5kcG9pbnQoZW5kcG9pbnQpIHsKICAgIHRoaXMuZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50LCB0aGlzLmNvbmZpZyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgcGFnaW5hdGlvbkNvbmZpZzogZnVuY3Rpb24gcGFnaW5hdGlvbkNvbmZpZyhvcGVyYXRpb24sIHRocm93RXhjZXB0aW9uKSB7CiAgICB2YXIgcGFnaW5hdG9yID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dLnBhZ2luYXRvcjsKICAgIGlmICghcGFnaW5hdG9yKSB7CiAgICAgIGlmICh0aHJvd0V4Y2VwdGlvbikgewogICAgICAgIHZhciBlID0gbmV3IEVycm9yKCk7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IoZSwgJ05vIHBhZ2luYXRpb24gY29uZmlndXJhdGlvbiBmb3IgJyArIG9wZXJhdGlvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcmV0dXJuIHBhZ2luYXRvcjsKICB9Cn0pOwoKQVdTLnV0aWwudXBkYXRlKEFXUy5TZXJ2aWNlLCB7CgogIC8qKgogICAqIEFkZHMgb25lIG1ldGhvZCBmb3IgZWFjaCBvcGVyYXRpb24gZGVzY3JpYmVkIGluIHRoZSBhcGkgY29uZmlndXJhdGlvbgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZGVmaW5lTWV0aG9kczogZnVuY3Rpb24gZGVmaW5lTWV0aG9kcyhzdmMpIHsKICAgIEFXUy51dGlsLmVhY2goc3ZjLnByb3RvdHlwZS5hcGkub3BlcmF0aW9ucywgZnVuY3Rpb24gaXRlcmF0b3IobWV0aG9kKSB7CiAgICAgIGlmIChzdmMucHJvdG90eXBlW21ldGhvZF0pIHJldHVybjsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHN2Yy5wcm90b3R5cGUuYXBpLm9wZXJhdGlvbnNbbWV0aG9kXTsKICAgICAgaWYgKG9wZXJhdGlvbi5hdXRodHlwZSA9PT0gJ25vbmUnKSB7CiAgICAgICAgc3ZjLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdmMucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAocGFyYW1zLCBjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHRoaXMubWFrZVJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBEZWZpbmVzIGEgbmV3IFNlcnZpY2UgY2xhc3MgdXNpbmcgYSBzZXJ2aWNlIGlkZW50aWZpZXIgYW5kIGxpc3Qgb2YgdmVyc2lvbnMKICAgKiBpbmNsdWRpbmcgYW4gb3B0aW9uYWwgc2V0IG9mIGZlYXR1cmVzIChmdW5jdGlvbnMpIHRvIGFwcGx5IHRvIHRoZSBjbGFzcwogICAqIHByb3RvdHlwZS4KICAgKgogICAqIEBwYXJhbSBzZXJ2aWNlSWRlbnRpZmllciBbU3RyaW5nXSB0aGUgaWRlbnRpZmllciBmb3IgdGhlIHNlcnZpY2UKICAgKiBAcGFyYW0gdmVyc2lvbnMgW0FycmF5PFN0cmluZz5dIGEgbGlzdCBvZiB2ZXJzaW9ucyB0aGF0IHdvcmsgd2l0aCB0aGlzCiAgICogICBzZXJ2aWNlCiAgICogQHBhcmFtIGZlYXR1cmVzIFtPYmplY3RdIGFuIG9iamVjdCB0byBhdHRhY2ggdG8gdGhlIHByb3RvdHlwZQogICAqIEByZXR1cm4gW0NsYXNzPFNlcnZpY2U+XSB0aGUgc2VydmljZSBjbGFzcyBkZWZpbmVkIGJ5IHRoaXMgZnVuY3Rpb24uCiAgICovCiAgZGVmaW5lU2VydmljZTogZnVuY3Rpb24gZGVmaW5lU2VydmljZShzZXJ2aWNlSWRlbnRpZmllciwgdmVyc2lvbnMsIGZlYXR1cmVzKSB7CiAgICBBV1MuU2VydmljZS5fc2VydmljZU1hcFtzZXJ2aWNlSWRlbnRpZmllcl0gPSB0cnVlOwogICAgaWYgKCFBcnJheS5pc0FycmF5KHZlcnNpb25zKSkgewogICAgICBmZWF0dXJlcyA9IHZlcnNpb25zOwogICAgICB2ZXJzaW9ucyA9IFtdOwogICAgfQoKICAgIHZhciBzdmMgPSBpbmhlcml0KEFXUy5TZXJ2aWNlLCBmZWF0dXJlcyB8fCB7fSk7CgogICAgaWYgKHR5cGVvZiBzZXJ2aWNlSWRlbnRpZmllciA9PT0gJ3N0cmluZycpIHsKICAgICAgQVdTLlNlcnZpY2UuYWRkVmVyc2lvbnMoc3ZjLCB2ZXJzaW9ucyk7CgogICAgICB2YXIgaWRlbnRpZmllciA9IHN2Yy5zZXJ2aWNlSWRlbnRpZmllciB8fCBzZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgc3ZjLnNlcnZpY2VJZGVudGlmaWVyID0gaWRlbnRpZmllcjsKICAgIH0gZWxzZSB7IC8vIGRlZmluZVNlcnZpY2UgY2FsbGVkIHdpdGggYW4gQVBJCiAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gc2VydmljZUlkZW50aWZpZXI7CiAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZU1ldGhvZHMoc3ZjKTsKICAgIH0KICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzLnByb3RvdHlwZSk7CiAgICAvL3V0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcgaXMgb25seSBhdmFpbGFibGUgaW4gbm9kZQogICAgaWYgKCF0aGlzLnByb3RvdHlwZS5wdWJsaXNoZXIgJiYgQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcpIHsKICAgICAgdmFyIFB1Ymxpc2hlciA9IEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nLlB1Ymxpc2hlcjsKICAgICAgdmFyIGNvbmZpZ1Byb3ZpZGVyID0gQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcuY29uZmlnUHJvdmlkZXI7CiAgICAgIHZhciBwdWJsaXNoZXJDb25maWcgPSBjb25maWdQcm92aWRlcigpOwogICAgICB0aGlzLnByb3RvdHlwZS5wdWJsaXNoZXIgPSBuZXcgUHVibGlzaGVyKHB1Ymxpc2hlckNvbmZpZyk7CiAgICAgIGlmIChwdWJsaXNoZXJDb25maWcuZW5hYmxlZCkgewogICAgICAgIC8vaWYgY3NtIGlzIGVuYWJsZWQgaW4gZW52aXJvbm1lbnQsIFNESyBzaG91bGQgc2VuZCBhbGwgbWV0cmljcwogICAgICAgIEFXUy5TZXJ2aWNlLl9jbGllbnRTaWRlTW9uaXRvcmluZyA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbChzdmMucHJvdG90eXBlKTsKICAgIEFXUy5TZXJ2aWNlLmFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKHN2Yy5wcm90b3R5cGUpOwogICAgcmV0dXJuIHN2YzsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhZGRWZXJzaW9uczogZnVuY3Rpb24gYWRkVmVyc2lvbnMoc3ZjLCB2ZXJzaW9ucykgewogICAgaWYgKCFBcnJheS5pc0FycmF5KHZlcnNpb25zKSkgdmVyc2lvbnMgPSBbdmVyc2lvbnNdOwoKICAgIHN2Yy5zZXJ2aWNlcyA9IHN2Yy5zZXJ2aWNlcyB8fCB7fTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmVyc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHN2Yy5zZXJ2aWNlc1t2ZXJzaW9uc1tpXV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHN2Yy5zZXJ2aWNlc1t2ZXJzaW9uc1tpXV0gPSBudWxsOwogICAgICB9CiAgICB9CgogICAgc3ZjLmFwaVZlcnNpb25zID0gT2JqZWN0LmtleXMoc3ZjLnNlcnZpY2VzKS5zb3J0KCk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZGVmaW5lU2VydmljZUFwaTogZnVuY3Rpb24gZGVmaW5lU2VydmljZUFwaShzdXBlcmNsYXNzLCB2ZXJzaW9uLCBhcGlDb25maWcpIHsKICAgIHZhciBzdmMgPSBpbmhlcml0KHN1cGVyY2xhc3MsIHsKICAgICAgc2VydmljZUlkZW50aWZpZXI6IHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIKICAgIH0pOwoKICAgIGZ1bmN0aW9uIHNldEFwaShhcGkpIHsKICAgICAgaWYgKGFwaS5pc0FwaSkgewogICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gYXBpOwogICAgICB9IGVsc2UgewogICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gbmV3IEFwaShhcGksIHsKICAgICAgICAgIHNlcnZpY2VJZGVudGlmaWVyOiBzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodHlwZW9mIHZlcnNpb24gPT09ICdzdHJpbmcnKSB7CiAgICAgIGlmIChhcGlDb25maWcpIHsKICAgICAgICBzZXRBcGkoYXBpQ29uZmlnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgc2V0QXBpKEFXUy5hcGlMb2FkZXIoc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllciwgdmVyc2lvbikpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgZmluZCBBUEkgY29uZmlndXJhdGlvbiAnICsKICAgICAgICAgICAgICBzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyICsgJy0nICsgdmVyc2lvbgogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN1cGVyY2xhc3Muc2VydmljZXMsIHZlcnNpb24pKSB7CiAgICAgICAgc3VwZXJjbGFzcy5hcGlWZXJzaW9ucyA9IHN1cGVyY2xhc3MuYXBpVmVyc2lvbnMuY29uY2F0KHZlcnNpb24pLnNvcnQoKTsKICAgICAgfQogICAgICBzdXBlcmNsYXNzLnNlcnZpY2VzW3ZlcnNpb25dID0gc3ZjOwogICAgfSBlbHNlIHsKICAgICAgc2V0QXBpKHZlcnNpb24pOwogICAgfQoKICAgIEFXUy5TZXJ2aWNlLmRlZmluZU1ldGhvZHMoc3ZjKTsKICAgIHJldHVybiBzdmM7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaGFzU2VydmljZTogZnVuY3Rpb24oaWRlbnRpZmllcikgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MuU2VydmljZS5fc2VydmljZU1hcCwgaWRlbnRpZmllcik7CiAgfSwKCiAgLyoqCiAgICogQHBhcmFtIGF0dGFjaE9uIGF0dGFjaCBkZWZhdWx0IG1vbml0b3JpbmcgbGlzdGVuZXJzIHRvIG9iamVjdAogICAqCiAgICogRWFjaCBtb25pdG9yaW5nIGV2ZW50IHNob3VsZCBiZSBlbWl0dGVkIGZyb20gc2VydmljZSBjbGllbnQgdG8gc2VydmljZSBjb25zdHJ1Y3RvciBwcm90b3R5cGUgYW5kIHRoZW4KICAgKiB0byBnbG9iYWwgc2VydmljZSBwcm90b3R5cGUgbGlrZSBidWJibGluZyB1cC4gVGhlc2UgZGVmYXVsdCBtb25pdG9yaW5nIGV2ZW50cyBsaXN0ZW5lciB3aWxsIHRyYW5zZmVyCiAgICogdGhlIG1vbml0b3JpbmcgZXZlbnRzIHRvIHRoZSB1cHBlciBsYXllci4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVyczogZnVuY3Rpb24gYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnMoYXR0YWNoT24pIHsKICAgIGF0dGFjaE9uLmFkZE5hbWVkTGlzdGVuZXIoJ01PTklUT1JfRVZFTlRTX0JVQkJMRScsICdhcGlDYWxsQXR0ZW1wdCcsIGZ1bmN0aW9uIEVWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgdmFyIGJhc2VDbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihhdHRhY2hPbik7CiAgICAgIGlmIChiYXNlQ2xhc3MuX2V2ZW50cykgYmFzZUNsYXNzLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2V2ZW50XSk7CiAgICB9KTsKICAgIGF0dGFjaE9uLmFkZE5hbWVkTGlzdGVuZXIoJ0NBTExfRVZFTlRTX0JVQkJMRScsICdhcGlDYWxsJywgZnVuY3Rpb24gQ0FMTF9FVkVOVFNfQlVCQkxFKGV2ZW50KSB7CiAgICAgIHZhciBiYXNlQ2xhc3MgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXR0YWNoT24pOwogICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsJywgW2V2ZW50XSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBfc2VydmljZU1hcDoge30KfSk7CgpBV1MudXRpbC5taXhpbihBV1MuU2VydmljZSwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcik7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXJ2aWNlOwoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9jb3JlIjoxOSwiLi9tb2RlbC9hcGkiOjM5LCIuL3JlZ2lvbi91dGlscyI6NTQsIi4vcmVnaW9uX2NvbmZpZyI6NTUsIl9wcm9jZXNzIjo5MH1dLDYyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIHJlc29sdmVSZWdpb25hbEVuZHBvaW50c0ZsYWcgPSByZXF1aXJlKCcuLi9jb25maWdfcmVnaW9uYWxfZW5kcG9pbnQnKTsKdmFyIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEID0gJ0FXU19TVFNfUkVHSU9OQUxfRU5EUE9JTlRTJzsKdmFyIENPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEID0gJ3N0c19yZWdpb25hbF9lbmRwb2ludHMnOwoKQVdTLnV0aWwudXBkYXRlKEFXUy5TVFMucHJvdG90eXBlLCB7CiAgLyoqCiAgICogQG92ZXJsb2FkIGNyZWRlbnRpYWxzRnJvbShkYXRhLCBjcmVkZW50aWFscyA9IG51bGwpCiAgICogICBDcmVhdGVzIGEgY3JlZGVudGlhbHMgb2JqZWN0IGZyb20gU1RTIHJlc3BvbnNlIGRhdGEgY29udGFpbmluZwogICAqICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24uIFVzZWZ1bCBmb3IgcXVpY2tseSBzZXR0aW5nIEFXUyBjcmVkZW50aWFscy4KICAgKgogICAqICAgQG5vdGUgVGhpcyBpcyBhIGxvdy1sZXZlbCB1dGlsaXR5IGZ1bmN0aW9uLiBJZiB5b3Ugd2FudCB0byBsb2FkIHRlbXBvcmFyeQogICAqICAgICBjcmVkZW50aWFscyBpbnRvIHlvdXIgcHJvY2VzcyBmb3Igc3Vic2VxdWVudCByZXF1ZXN0cyB0byBBV1MgcmVzb3VyY2VzLAogICAqICAgICB5b3Ugc2hvdWxkIHVzZSB7QVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzfSBpbnN0ZWFkLgogICAqICAgQHBhcmFtIGRhdGEgW21hcF0gZGF0YSByZXRyaWV2ZWQgZnJvbSBhIGNhbGwgdG8ge2dldEZlZGVyYXRlZFRva2VufSwKICAgKiAgICAge2dldFNlc3Npb25Ub2tlbn0sIHthc3N1bWVSb2xlfSwgb3Ige2Fzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LgogICAqICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIGFuIG9wdGlvbmFsIGNyZWRlbnRpYWxzIG9iamVjdCB0bwogICAqICAgICBmaWxsIGluc3RlYWQgb2YgY3JlYXRpbmcgYSBuZXcgb2JqZWN0LiBVc2VmdWwgd2hlbiBtb2RpZnlpbmcgYW4KICAgKiAgICAgZXhpc3RpbmcgY3JlZGVudGlhbHMgb2JqZWN0IGZyb20gYSByZWZyZXNoIGNhbGwuCiAgICogICBAcmV0dXJuIFtBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHNdIHRoZSBzZXQgb2YgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICogICAgIGxvYWRlZCBmcm9tIGEgcmF3IFNUUyBvcGVyYXRpb24gcmVzcG9uc2UuCiAgICogICBAZXhhbXBsZSBVc2luZyBjcmVkZW50aWFsc0Zyb20gdG8gbG9hZCBnbG9iYWwgQVdTIGNyZWRlbnRpYWxzCiAgICogICAgIHZhciBzdHMgPSBuZXcgQVdTLlNUUygpOwogICAqICAgICBzdHMuZ2V0U2Vzc2lvblRva2VuKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgKiAgICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZygiRXJyb3IgZ2V0dGluZyBjcmVkZW50aWFscyIpOwogICAqICAgICAgIGVsc2UgewogICAqICAgICAgICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IHN0cy5jcmVkZW50aWFsc0Zyb20oZGF0YSk7CiAgICogICAgICAgfQogICAqICAgICB9KTsKICAgKiAgIEBzZWUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzCiAgICovCiAgY3JlZGVudGlhbHNGcm9tOiBmdW5jdGlvbiBjcmVkZW50aWFsc0Zyb20oZGF0YSwgY3JlZGVudGlhbHMpIHsKICAgIGlmICghZGF0YSkgcmV0dXJuIG51bGw7CiAgICBpZiAoIWNyZWRlbnRpYWxzKSBjcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgIGNyZWRlbnRpYWxzLmV4cGlyZWQgPSBmYWxzZTsKICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkID0gZGF0YS5DcmVkZW50aWFscy5BY2Nlc3NLZXlJZDsKICAgIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSA9IGRhdGEuQ3JlZGVudGlhbHMuU2VjcmV0QWNjZXNzS2V5OwogICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID0gZGF0YS5DcmVkZW50aWFscy5TZXNzaW9uVG9rZW47CiAgICBjcmVkZW50aWFscy5leHBpcmVUaW1lID0gZGF0YS5DcmVkZW50aWFscy5FeHBpcmF0aW9uOwogICAgcmV0dXJuIGNyZWRlbnRpYWxzOwogIH0sCgogIGFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHk6IGZ1bmN0aW9uIGFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkocGFyYW1zLCBjYWxsYmFjaykgewogICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2Fzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknLCBwYXJhbXMsIGNhbGxiYWNrKTsKICB9LAoKICBhc3N1bWVSb2xlV2l0aFNBTUw6IGZ1bmN0aW9uIGFzc3VtZVJvbGVXaXRoU0FNTChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnYXNzdW1lUm9sZVdpdGhTQU1MJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2V0dXBSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBzZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogICAgcmVxdWVzdC5hZGRMaXN0ZW5lcigndmFsaWRhdGUnLCB0aGlzLm9wdEluUmVnaW9uYWxFbmRwb2ludCwgdHJ1ZSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgb3B0SW5SZWdpb25hbEVuZHBvaW50OiBmdW5jdGlvbiBvcHRJblJlZ2lvbmFsRW5kcG9pbnQocmVxKSB7CiAgICB2YXIgc2VydmljZSA9IHJlcS5zZXJ2aWNlOwogICAgdmFyIGNvbmZpZyA9IHNlcnZpY2UuY29uZmlnOwogICAgY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzID0gcmVzb2x2ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZyhzZXJ2aWNlLl9vcmlnaW5hbENvbmZpZywgewogICAgICBlbnY6IEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVELAogICAgICBzaGFyZWRDb25maWc6IENPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVELAogICAgICBjbGllbnRDb25maWc6ICdzdHNSZWdpb25hbEVuZHBvaW50cycKICAgIH0pOwogICAgaWYgKAogICAgICBjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgPT09ICdyZWdpb25hbCcgJiYKICAgICAgc2VydmljZS5pc0dsb2JhbEVuZHBvaW50CiAgICApIHsKICAgICAgLy9jbGllbnQgd2lsbCB0aHJvdyBpZiByZWdpb24gaXMgbm90IHN1cHBsaWVkOyByZXF1ZXN0IHdpbGwgYmUgc2lnbmVkIHdpdGggc3BlY2lmaWVkIHJlZ2lvbgogICAgICBpZiAoIWNvbmZpZy5yZWdpb24pIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgIHtjb2RlOiAnQ29uZmlnRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyByZWdpb24gaW4gY29uZmlnJ30pOwogICAgICB9CiAgICAgIHZhciBpbnNlcnRQb2ludCA9IGNvbmZpZy5lbmRwb2ludC5pbmRleE9mKCcuYW1hem9uYXdzLmNvbScpOwogICAgICB2YXIgcmVnaW9uYWxFbmRwb2ludCA9IGNvbmZpZy5lbmRwb2ludC5zdWJzdHJpbmcoMCwgaW5zZXJ0UG9pbnQpICsKICAgICAgICAnLicgKyBjb25maWcucmVnaW9uICsgY29uZmlnLmVuZHBvaW50LnN1YnN0cmluZyhpbnNlcnRQb2ludCk7CiAgICAgIHJlcS5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChyZWdpb25hbEVuZHBvaW50KTsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LnJlZ2lvbiA9IGNvbmZpZy5yZWdpb247CiAgICB9CiAgfQoKfSk7Cgp9LHsiLi4vY29uZmlnX3JlZ2lvbmFsX2VuZHBvaW50IjoxOCwiLi4vY29yZSI6MTl9XSw2MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciBleHBpcmVzSGVhZGVyID0gJ3ByZXNpZ25lZC1leHBpcmVzJzsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHNpZ25lZFVybEJ1aWxkZXIocmVxdWVzdCkgewogIHZhciBleHBpcmVzID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdOwogIHZhciBzaWduZXJDbGFzcyA9IHJlcXVlc3Quc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXF1ZXN0KTsKCiAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snVXNlci1BZ2VudCddOwogIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LVVzZXItQWdlbnQnXTsKCiAgaWYgKHNpZ25lckNsYXNzID09PSBBV1MuU2lnbmVycy5WNCkgewogICAgaWYgKGV4cGlyZXMgPiA2MDQ4MDApIHsgLy8gb25lIHdlZWsgZXhwaXJ5IGlzIGludmFsaWQKICAgICAgdmFyIG1lc3NhZ2UgPSAnUHJlc2lnbmluZyBkb2VzIG5vdCBzdXBwb3J0IGV4cGlyeSB0aW1lIGdyZWF0ZXIgJyArCiAgICAgICAgICAgICAgICAgICAgJ3RoYW4gYSB3ZWVrIHdpdGggU2lnVjQgc2lnbmluZy4nOwogICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdJbnZhbGlkRXhwaXJ5VGltZScsIG1lc3NhZ2U6IG1lc3NhZ2UsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgfSk7CiAgICB9CiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBleHBpcmVzOwogIH0gZWxzZSBpZiAoc2lnbmVyQ2xhc3MgPT09IEFXUy5TaWduZXJzLlMzKSB7CiAgICB2YXIgbm93ID0gcmVxdWVzdC5zZXJ2aWNlID8gcmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkgOiBBV1MudXRpbC5kYXRlLmdldERhdGUoKTsKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IHBhcnNlSW50KAogICAgICBBV1MudXRpbC5kYXRlLnVuaXhUaW1lc3RhbXAobm93KSArIGV4cGlyZXMsIDEwKS50b1N0cmluZygpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICBtZXNzYWdlOiAnUHJlc2lnbmluZyBvbmx5IHN1cHBvcnRzIFMzIG9yIFNpZ1Y0IHNpZ25pbmcuJywKICAgICAgY29kZTogJ1Vuc3VwcG9ydGVkU2lnbmVyJywgcmV0cnlhYmxlOiBmYWxzZQogICAgfSk7CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBzaWduZWRVcmxTaWduZXIocmVxdWVzdCkgewogIHZhciBlbmRwb2ludCA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQ7CiAgdmFyIHBhcnNlZFVybCA9IEFXUy51dGlsLnVybFBhcnNlKHJlcXVlc3QuaHR0cFJlcXVlc3QucGF0aCk7CiAgdmFyIHF1ZXJ5UGFyYW1zID0ge307CgogIGlmIChwYXJzZWRVcmwuc2VhcmNoKSB7CiAgICBxdWVyeVBhcmFtcyA9IEFXUy51dGlsLnF1ZXJ5U3RyaW5nUGFyc2UocGFyc2VkVXJsLnNlYXJjaC5zdWJzdHIoMSkpOwogIH0KCiAgdmFyIGF1dGggPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXS5zcGxpdCgnICcpOwogIGlmIChhdXRoWzBdID09PSAnQVdTJykgewogICAgYXV0aCA9IGF1dGhbMV0uc3BsaXQoJzonKTsKICAgIHF1ZXJ5UGFyYW1zWydTaWduYXR1cmUnXSA9IGF1dGgucG9wKCk7CiAgICBxdWVyeVBhcmFtc1snQVdTQWNjZXNzS2V5SWQnXSA9IGF1dGguam9pbignOicpOwoKICAgIEFXUy51dGlsLmVhY2gocmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICBpZiAoa2V5ID09PSBleHBpcmVzSGVhZGVyKSBrZXkgPSAnRXhwaXJlcyc7CiAgICAgIGlmIChrZXkuaW5kZXhPZigneC1hbXotbWV0YS0nKSA9PT0gMCkgewogICAgICAgIC8vIERlbGV0ZSBleGlzdGluZywgcG90ZW50aWFsbHkgbm90IG5vcm1hbGl6ZWQga2V5CiAgICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAga2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgIH0KICAgICAgcXVlcnlQYXJhbXNba2V5XSA9IHZhbHVlOwogICAgfSk7CiAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdOwogICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydBdXRob3JpemF0aW9uJ107CiAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0hvc3QnXTsKICB9IGVsc2UgaWYgKGF1dGhbMF0gPT09ICdBV1M0LUhNQUMtU0hBMjU2JykgeyAvLyBTaWdWNCBzaWduaW5nCiAgICBhdXRoLnNoaWZ0KCk7CiAgICB2YXIgcmVzdCA9IGF1dGguam9pbignICcpOwogICAgdmFyIHNpZ25hdHVyZSA9IHJlc3QubWF0Y2goL1NpZ25hdHVyZT0oLio/KSg/Oix8XHN8XHI/XG58JCkvKVsxXTsKICAgIHF1ZXJ5UGFyYW1zWydYLUFtei1TaWduYXR1cmUnXSA9IHNpZ25hdHVyZTsKICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snRXhwaXJlcyddOwogIH0KCiAgLy8gYnVpbGQgVVJMCiAgZW5kcG9pbnQucGF0aG5hbWUgPSBwYXJzZWRVcmwucGF0aG5hbWU7CiAgZW5kcG9pbnQuc2VhcmNoID0gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeVBhcmFtcyk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TaWduZXJzLlByZXNpZ24gPSBpbmhlcml0KHsKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzaWduOiBmdW5jdGlvbiBzaWduKHJlcXVlc3QsIGV4cGlyZVRpbWUsIGNhbGxiYWNrKSB7CiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBleHBpcmVUaW1lIHx8IDM2MDA7CiAgICByZXF1ZXN0Lm9uKCdidWlsZCcsIHNpZ25lZFVybEJ1aWxkZXIpOwogICAgcmVxdWVzdC5vbignc2lnbicsIHNpZ25lZFVybFNpZ25lcik7CiAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VUX0NPTlRFTlRfTEVOR1RIKTsKICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2FmdGVyQnVpbGQnLAogICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5DT01QVVRFX1NIQTI1Nik7CgogICAgcmVxdWVzdC5lbWl0KCdiZWZvcmVQcmVzaWduJywgW3JlcXVlc3RdKTsKCiAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgcmVxdWVzdC5idWlsZChmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5yZXNwb25zZS5lcnJvcikgY2FsbGJhY2sodGhpcy5yZXNwb25zZS5lcnJvcik7CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBjYWxsYmFjayhudWxsLCBBV1MudXRpbC51cmxGb3JtYXQocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXF1ZXN0LmJ1aWxkKCk7CiAgICAgIGlmIChyZXF1ZXN0LnJlc3BvbnNlLmVycm9yKSB0aHJvdyByZXF1ZXN0LnJlc3BvbnNlLmVycm9yOwogICAgICByZXR1cm4gQVdTLnV0aWwudXJsRm9ybWF0KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQpOwogICAgfQogIH0KfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlByZXNpZ247Cgp9LHsiLi4vY29yZSI6MTl9XSw2NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7Cgp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyID0gaW5oZXJpdCh7CiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3RTaWduZXIocmVxdWVzdCkgewogICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICB9LAoKICBzZXRTZXJ2aWNlQ2xpZW50SWQ6IGZ1bmN0aW9uIHNldFNlcnZpY2VDbGllbnRJZChpZCkgewogICAgdGhpcy5zZXJ2aWNlQ2xpZW50SWQgPSBpZDsKICB9LAoKICBnZXRTZXJ2aWNlQ2xpZW50SWQ6IGZ1bmN0aW9uIGdldFNlcnZpY2VDbGllbnRJZCgpIHsKICAgIHJldHVybiB0aGlzLnNlcnZpY2VDbGllbnRJZDsKICB9Cn0pOwoKQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5nZXRWZXJzaW9uID0gZnVuY3Rpb24gZ2V0VmVyc2lvbih2ZXJzaW9uKSB7CiAgc3dpdGNoICh2ZXJzaW9uKSB7CiAgICBjYXNlICd2Mic6IHJldHVybiBBV1MuU2lnbmVycy5WMjsKICAgIGNhc2UgJ3YzJzogcmV0dXJuIEFXUy5TaWduZXJzLlYzOwogICAgY2FzZSAnczN2NCc6IHJldHVybiBBV1MuU2lnbmVycy5WNDsKICAgIGNhc2UgJ3Y0JzogcmV0dXJuIEFXUy5TaWduZXJzLlY0OwogICAgY2FzZSAnczMnOiByZXR1cm4gQVdTLlNpZ25lcnMuUzM7CiAgICBjYXNlICd2M2h0dHBzJzogcmV0dXJuIEFXUy5TaWduZXJzLlYzSHR0cHM7CiAgfQogIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduaW5nIHZlcnNpb24gJyArIHZlcnNpb24pOwp9OwoKcmVxdWlyZSgnLi92MicpOwpyZXF1aXJlKCcuL3YzJyk7CnJlcXVpcmUoJy4vdjNodHRwcycpOwpyZXF1aXJlKCcuL3Y0Jyk7CnJlcXVpcmUoJy4vczMnKTsKcmVxdWlyZSgnLi9wcmVzaWduJyk7Cgp9LHsiLi4vY29yZSI6MTksIi4vcHJlc2lnbiI6NjMsIi4vczMiOjY1LCIuL3YyIjo2NiwiLi92MyI6NjcsIi4vdjNodHRwcyI6NjgsIi4vdjQiOjY5fV0sNjU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2lnbmVycy5TMyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogIC8qKgogICAqIFdoZW4gYnVpbGRpbmcgdGhlIHN0cmluZ1RvU2lnbiwgdGhlc2Ugc3ViIHJlc291cmNlIHBhcmFtcyBzaG91bGQgYmUKICAgKiBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWRlY29kZWQgdmFsdWVzCiAgICovCiAgc3ViUmVzb3VyY2VzOiB7CiAgICAnYWNsJzogMSwKICAgICdhY2NlbGVyYXRlJzogMSwKICAgICdhbmFseXRpY3MnOiAxLAogICAgJ2NvcnMnOiAxLAogICAgJ2xpZmVjeWNsZSc6IDEsCiAgICAnZGVsZXRlJzogMSwKICAgICdpbnZlbnRvcnknOiAxLAogICAgJ2xvY2F0aW9uJzogMSwKICAgICdsb2dnaW5nJzogMSwKICAgICdtZXRyaWNzJzogMSwKICAgICdub3RpZmljYXRpb24nOiAxLAogICAgJ3BhcnROdW1iZXInOiAxLAogICAgJ3BvbGljeSc6IDEsCiAgICAncmVxdWVzdFBheW1lbnQnOiAxLAogICAgJ3JlcGxpY2F0aW9uJzogMSwKICAgICdyZXN0b3JlJzogMSwKICAgICd0YWdnaW5nJzogMSwKICAgICd0b3JyZW50JzogMSwKICAgICd1cGxvYWRJZCc6IDEsCiAgICAndXBsb2Fkcyc6IDEsCiAgICAndmVyc2lvbklkJzogMSwKICAgICd2ZXJzaW9uaW5nJzogMSwKICAgICd2ZXJzaW9ucyc6IDEsCiAgICAnd2Vic2l0ZSc6IDEKICB9LAoKICAvLyB3aGVuIGJ1aWxkaW5nIHRoZSBzdHJpbmdUb1NpZ24sIHRoZXNlIHF1ZXJ5c3RyaW5nIHBhcmFtcyBzaG91bGQgYmUKICAvLyBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWVuY29kZWQgdmFsdWVzCiAgcmVzcG9uc2VIZWFkZXJzOiB7CiAgICAncmVzcG9uc2UtY29udGVudC10eXBlJzogMSwKICAgICdyZXNwb25zZS1jb250ZW50LWxhbmd1YWdlJzogMSwKICAgICdyZXNwb25zZS1leHBpcmVzJzogMSwKICAgICdyZXNwb25zZS1jYWNoZS1jb250cm9sJzogMSwKICAgICdyZXNwb25zZS1jb250ZW50LWRpc3Bvc2l0aW9uJzogMSwKICAgICdyZXNwb25zZS1jb250ZW50LWVuY29kaW5nJzogMQogIH0sCgogIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAgIGlmICghdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3ByZXNpZ25lZC1leHBpcmVzJ10pIHsKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IEFXUy51dGlsLmRhdGUucmZjODIyKGRhdGUpOwogICAgfQoKICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgLy8gcHJlc2lnbmVkIFVSTHMgcmVxdWlyZSB0aGlzIGhlYWRlciB0byBiZSBsb3dlcmNhc2VkCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgfQoKICAgIHZhciBzaWduYXR1cmUgPSB0aGlzLnNpZ24oY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpKTsKICAgIHZhciBhdXRoID0gJ0FXUyAnICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnOicgKyBzaWduYXR1cmU7CgogICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9IGF1dGg7CiAgfSwKCiAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKCiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHBhcnRzLnB1c2goci5tZXRob2QpOwogICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10gfHwgJycpOwogICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddIHx8ICcnKTsKCiAgICAvLyBUaGlzIGlzIHRoZSAiRGF0ZSIgaGVhZGVyLCBidXQgd2UgdXNlIFgtQW16LURhdGUuCiAgICAvLyBUaGUgUzMgc2lnbmluZyBtZWNoYW5pc20gcmVxdWlyZXMgdXMgdG8gcGFzcyBhbiBlbXB0eQogICAgLy8gc3RyaW5nIGZvciB0aGlzIERhdGUgaGVhZGVyIHJlZ2FyZGxlc3MuCiAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1sncHJlc2lnbmVkLWV4cGlyZXMnXSB8fCAnJyk7CgogICAgdmFyIGhlYWRlcnMgPSB0aGlzLmNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzKCk7CiAgICBpZiAoaGVhZGVycykgcGFydHMucHVzaChoZWFkZXJzKTsKICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxpemVkUmVzb3VyY2UoKSk7CgogICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CgogIH0sCgogIGNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxpemVkQW16SGVhZGVycygpIHsKCiAgICB2YXIgYW16SGVhZGVycyA9IFtdOwoKICAgIEFXUy51dGlsLmVhY2godGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGlmIChuYW1lLm1hdGNoKC9eeC1hbXotL2kpKQogICAgICAgIGFtekhlYWRlcnMucHVzaChuYW1lKTsKICAgIH0pOwoKICAgIGFtekhlYWRlcnMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICByZXR1cm4gYS50b0xvd2VyQ2FzZSgpIDwgYi50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgfSk7CgogICAgdmFyIHBhcnRzID0gW107CiAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBhbXpIZWFkZXJzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICBwYXJ0cy5wdXNoKG5hbWUudG9Mb3dlckNhc2UoKSArICc6JyArIFN0cmluZyh0aGlzLnJlcXVlc3QuaGVhZGVyc1tuYW1lXSkpOwogICAgfSk7CgogICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CgogIH0sCgogIGNhbm9uaWNhbGl6ZWRSZXNvdXJjZTogZnVuY3Rpb24gY2Fub25pY2FsaXplZFJlc291cmNlKCkgewoKICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwoKICAgIHZhciBwYXJ0cyA9IHIucGF0aC5zcGxpdCgnPycpOwogICAgdmFyIHBhdGggPSBwYXJ0c1swXTsKICAgIHZhciBxdWVyeXN0cmluZyA9IHBhcnRzWzFdOwoKICAgIHZhciByZXNvdXJjZSA9ICcnOwoKICAgIGlmIChyLnZpcnR1YWxIb3N0ZWRCdWNrZXQpCiAgICAgIHJlc291cmNlICs9ICcvJyArIHIudmlydHVhbEhvc3RlZEJ1Y2tldDsKCiAgICByZXNvdXJjZSArPSBwYXRoOwoKICAgIGlmIChxdWVyeXN0cmluZykgewoKICAgICAgLy8gY29sbGVjdCBhIGxpc3Qgb2Ygc3ViIHJlc291cmNlcyBhbmQgcXVlcnkgcGFyYW1zIHRoYXQgbmVlZCB0byBiZSBzaWduZWQKICAgICAgdmFyIHJlc291cmNlcyA9IFtdOwoKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgcXVlcnlzdHJpbmcuc3BsaXQoJyYnKSwgZnVuY3Rpb24gKHBhcmFtKSB7CiAgICAgICAgdmFyIG5hbWUgPSBwYXJhbS5zcGxpdCgnPScpWzBdOwogICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtLnNwbGl0KCc9JylbMV07CiAgICAgICAgaWYgKHRoaXMuc3ViUmVzb3VyY2VzW25hbWVdIHx8IHRoaXMucmVzcG9uc2VIZWFkZXJzW25hbWVdKSB7CiAgICAgICAgICB2YXIgc3VicmVzb3VyY2UgPSB7IG5hbWU6IG5hbWUgfTsKICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnN1YlJlc291cmNlc1tuYW1lXSkgewogICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VicmVzb3VyY2UudmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNvdXJjZXMucHVzaChzdWJyZXNvdXJjZSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJlc291cmNlcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLm5hbWUgPCBiLm5hbWUgPyAtMSA6IDE7IH0pOwoKICAgICAgaWYgKHJlc291cmNlcy5sZW5ndGgpIHsKCiAgICAgICAgcXVlcnlzdHJpbmcgPSBbXTsKICAgICAgICBBV1MudXRpbC5hcnJheUVhY2gocmVzb3VyY2VzLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLnZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcXVlcnlzdHJpbmcucHVzaChyZXMubmFtZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lICsgJz0nICsgcmVzLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmVzb3VyY2UgKz0gJz8nICsgcXVlcnlzdHJpbmcuam9pbignJicpOwogICAgICB9CgogICAgfQoKICAgIHJldHVybiByZXNvdXJjZTsKCiAgfSwKCiAgc2lnbjogZnVuY3Rpb24gc2lnbihzZWNyZXQsIHN0cmluZykgewogICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKHNlY3JldCwgc3RyaW5nLCAnYmFzZTY0JywgJ3NoYTEnKTsKICB9Cn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5TMzsKCn0seyIuLi9jb3JlIjoxOX1dLDY2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNpZ25lcnMuVjIgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CgogICAgaWYgKCFkYXRlKSBkYXRlID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCk7CgogICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CgogICAgci5wYXJhbXMuVGltZXN0YW1wID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKGRhdGUpOwogICAgci5wYXJhbXMuU2lnbmF0dXJlVmVyc2lvbiA9ICcyJzsKICAgIHIucGFyYW1zLlNpZ25hdHVyZU1ldGhvZCA9ICdIbWFjU0hBMjU2JzsKICAgIHIucGFyYW1zLkFXU0FjY2Vzc0tleUlkID0gY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CgogICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICByLnBhcmFtcy5TZWN1cml0eVRva2VuID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgfQoKICAgIGRlbGV0ZSByLnBhcmFtcy5TaWduYXR1cmU7IC8vIGRlbGV0ZSBvbGQgU2lnbmF0dXJlIGZvciByZS1zaWduaW5nCiAgICByLnBhcmFtcy5TaWduYXR1cmUgPSB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CgogICAgci5ib2R5ID0gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhyLnBhcmFtcyk7CiAgICByLmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSByLmJvZHkubGVuZ3RoOwogIH0sCgogIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzKSB7CiAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpLCAnYmFzZTY0Jyk7CiAgfSwKCiAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5lbmRwb2ludC5ob3N0LnRvTG93ZXJDYXNlKCkpOwogICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QucGF0aG5hbWUoKSk7CiAgICBwYXJ0cy5wdXNoKEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcodGhpcy5yZXF1ZXN0LnBhcmFtcykpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgfQoKfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYyOwoKfSx7Ii4uL2NvcmUiOjE5fV0sNjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2lnbmVycy5WMyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKCiAgICB2YXIgZGF0ZXRpbWUgPSBBV1MudXRpbC5kYXRlLnJmYzgyMihkYXRlKTsKCiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gZGF0ZXRpbWU7CgogICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgIH0KCiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXpuLUF1dGhvcml6YXRpb24nXSA9CiAgICAgIHRoaXMuYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpOwoKICB9LAoKICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICByZXR1cm4gJ0FXUzMgJyArCiAgICAgICdBV1NBY2Nlc3NLZXlJZD0nICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLCcgKwogICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICdTaWduZWRIZWFkZXJzPScgKyB0aGlzLnNpZ25lZEhlYWRlcnMoKSArICcsJyArCiAgICAgICdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICB9LAoKICBzaWduZWRIZWFkZXJzOiBmdW5jdGlvbiBzaWduZWRIZWFkZXJzKCkgewogICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgIEFXUy51dGlsLmFycmF5RWFjaCh0aGlzLmhlYWRlcnNUb1NpZ24oKSwgZnVuY3Rpb24gaXRlcmF0b3IoaCkgewogICAgICBoZWFkZXJzLnB1c2goaC50b0xvd2VyQ2FzZSgpKTsKICAgIH0pOwogICAgcmV0dXJuIGhlYWRlcnMuc29ydCgpLmpvaW4oJzsnKTsKICB9LAoKICBjYW5vbmljYWxIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJzKCkgewogICAgdmFyIGhlYWRlcnMgPSB0aGlzLnJlcXVlc3QuaGVhZGVyczsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgQVdTLnV0aWwuYXJyYXlFYWNoKHRoaXMuaGVhZGVyc1RvU2lnbigpLCBmdW5jdGlvbiBpdGVyYXRvcihoKSB7CiAgICAgIHBhcnRzLnB1c2goaC50b0xvd2VyQ2FzZSgpLnRyaW0oKSArICc6JyArIFN0cmluZyhoZWFkZXJzW2hdKS50cmltKCkpOwogICAgfSk7CiAgICByZXR1cm4gcGFydHMuc29ydCgpLmpvaW4oJ1xuJykgKyAnXG4nOwogIH0sCgogIGhlYWRlcnNUb1NpZ246IGZ1bmN0aW9uIGhlYWRlcnNUb1NpZ24oKSB7CiAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgQVdTLnV0aWwuZWFjaCh0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gaXRlcmF0b3IoaykgewogICAgICBpZiAoayA9PT0gJ0hvc3QnIHx8IGsgPT09ICdDb250ZW50LUVuY29kaW5nJyB8fCBrLm1hdGNoKC9eWC1BbXovaSkpIHsKICAgICAgICBoZWFkZXJzLnB1c2goayk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGhlYWRlcnM7CiAgfSwKCiAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMpIHsKICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCksICdiYXNlNjQnKTsKICB9LAoKICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgIHBhcnRzLnB1c2goJy8nKTsKICAgIHBhcnRzLnB1c2goJycpOwogICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbEhlYWRlcnMoKSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5ib2R5KTsKICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uc2hhMjU2KHBhcnRzLmpvaW4oJ1xuJykpOwogIH0KCn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMzsKCn0seyIuLi9jb3JlIjoxOX1dLDY4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKcmVxdWlyZSgnLi92MycpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNpZ25lcnMuVjNIdHRwcyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuVjMsIHsKICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICByZXR1cm4gJ0FXUzMtSFRUUFMgJyArCiAgICAgICdBV1NBY2Nlc3NLZXlJZD0nICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLCcgKwogICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICB9LAoKICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgIHJldHVybiB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddOwogIH0KfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYzSHR0cHM7Cgp9LHsiLi4vY29yZSI6MTksIi4vdjMiOjY3fV0sNjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgdjRDcmVkZW50aWFscyA9IHJlcXVpcmUoJy4vdjRfY3JlZGVudGlhbHMnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIGV4cGlyZXNIZWFkZXIgPSAncHJlc2lnbmVkLWV4cGlyZXMnOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNpZ25lcnMuVjQgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gVjQocmVxdWVzdCwgc2VydmljZU5hbWUsIG9wdGlvbnMpIHsKICAgIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuY2FsbCh0aGlzLCByZXF1ZXN0KTsKICAgIHRoaXMuc2VydmljZU5hbWUgPSBzZXJ2aWNlTmFtZTsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5zaWduYXR1cmVDYWNoZSA9IHR5cGVvZiBvcHRpb25zLnNpZ25hdHVyZUNhY2hlID09PSAnYm9vbGVhbicgPyBvcHRpb25zLnNpZ25hdHVyZUNhY2hlIDogdHJ1ZTsKICAgIHRoaXMub3BlcmF0aW9uID0gb3B0aW9ucy5vcGVyYXRpb247CiAgICB0aGlzLnNpZ25hdHVyZVZlcnNpb24gPSBvcHRpb25zLnNpZ25hdHVyZVZlcnNpb247CiAgfSwKCiAgYWxnb3JpdGhtOiAnQVdTNC1ITUFDLVNIQTI1NicsCgogIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAgIHZhciBkYXRldGltZSA9IEFXUy51dGlsLmRhdGUuaXNvODYwMShkYXRlKS5yZXBsYWNlKC9bOlwtXXxcLlxkezN9L2csICcnKTsKCiAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpKSB7CiAgICAgIHRoaXMudXBkYXRlRm9yUHJlc2lnbmVkKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmFkZEhlYWRlcnMoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgIH0KCiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0KICAgICAgdGhpcy5hdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgfSwKCiAgYWRkSGVhZGVyczogZnVuY3Rpb24gYWRkSGVhZGVycyhjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBkYXRldGltZTsKICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICB9CiAgfSwKCiAgdXBkYXRlRm9yUHJlc2lnbmVkOiBmdW5jdGlvbiB1cGRhdGVGb3JQcmVzaWduZWQoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICB2YXIgY3JlZFN0cmluZyA9IHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSk7CiAgICB2YXIgcXMgPSB7CiAgICAgICdYLUFtei1EYXRlJzogZGF0ZXRpbWUsCiAgICAgICdYLUFtei1BbGdvcml0aG0nOiB0aGlzLmFsZ29yaXRobSwKICAgICAgJ1gtQW16LUNyZWRlbnRpYWwnOiBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcvJyArIGNyZWRTdHJpbmcsCiAgICAgICdYLUFtei1FeHBpcmVzJzogdGhpcy5yZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0sCiAgICAgICdYLUFtei1TaWduZWRIZWFkZXJzJzogdGhpcy5zaWduZWRIZWFkZXJzKCkKICAgIH07CgogICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICBxc1snWC1BbXotU2VjdXJpdHktVG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgIH0KCiAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICAgIHFzWydDb250ZW50LVR5cGUnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgIH0KICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1NRDUnXSkgewogICAgICBxc1snQ29udGVudC1NRDUnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LU1ENSddOwogICAgfQogICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDYWNoZS1Db250cm9sJ10pIHsKICAgICAgcXNbJ0NhY2hlLUNvbnRyb2wnXSA9IHRoaXMucmVxdWVzdC5oZWFkZXJzWydDYWNoZS1Db250cm9sJ107CiAgICB9CgogICAgLy8gbmVlZCB0byBwdWxsIGluIGFueSBvdGhlciBYLUFtei0qIGhlYWRlcnMKICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICBpZiAoa2V5ID09PSBleHBpcmVzSGVhZGVyKSByZXR1cm47CiAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkgewogICAgICAgIHZhciBsb3dlcktleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgIC8vIE1ldGFkYXRhIHNob3VsZCBiZSBub3JtYWxpemVkCiAgICAgICAgaWYgKGxvd2VyS2V5LmluZGV4T2YoJ3gtYW16LW1ldGEtJykgPT09IDApIHsKICAgICAgICAgIHFzW2xvd2VyS2V5XSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAobG93ZXJLZXkuaW5kZXhPZigneC1hbXotJykgPT09IDApIHsKICAgICAgICAgIHFzW2tleV0gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIHZhciBzZXAgPSB0aGlzLnJlcXVlc3QucGF0aC5pbmRleE9mKCc/JykgPj0gMCA/ICcmJyA6ICc/JzsKICAgIHRoaXMucmVxdWVzdC5wYXRoICs9IHNlcCArIEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXMpOwogIH0sCgogIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHZhciBjcmVkU3RyaW5nID0gdGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKTsKICAgIHBhcnRzLnB1c2godGhpcy5hbGdvcml0aG0gKyAnIENyZWRlbnRpYWw9JyArCiAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZyk7CiAgICBwYXJ0cy5wdXNoKCdTaWduZWRIZWFkZXJzPScgKyB0aGlzLnNpZ25lZEhlYWRlcnMoKSk7CiAgICBwYXJ0cy5wdXNoKCdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzLCBkYXRldGltZSkpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oJywgJyk7CiAgfSwKCiAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICB2YXIgc2lnbmluZ0tleSA9IHY0Q3JlZGVudGlhbHMuZ2V0U2lnbmluZ0tleSgKICAgICAgY3JlZGVudGlhbHMsCiAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgdGhpcy5yZXF1ZXN0LnJlZ2lvbiwKICAgICAgdGhpcy5zZXJ2aWNlTmFtZSwKICAgICAgdGhpcy5zaWduYXR1cmVDYWNoZQogICAgKTsKICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhzaWduaW5nS2V5LCB0aGlzLnN0cmluZ1RvU2lnbihkYXRldGltZSksICdoZXgnKTsKICB9LAoKICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbihkYXRldGltZSkgewogICAgdmFyIHBhcnRzID0gW107CiAgICBwYXJ0cy5wdXNoKCdBV1M0LUhNQUMtU0hBMjU2Jyk7CiAgICBwYXJ0cy5wdXNoKGRhdGV0aW1lKTsKICAgIHBhcnRzLnB1c2godGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuaGV4RW5jb2RlZEhhc2godGhpcy5jYW5vbmljYWxTdHJpbmcoKSkpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgfSwKCiAgY2Fub25pY2FsU3RyaW5nOiBmdW5jdGlvbiBjYW5vbmljYWxTdHJpbmcoKSB7CiAgICB2YXIgcGFydHMgPSBbXSwgcGF0aG5hbWUgPSB0aGlzLnJlcXVlc3QucGF0aG5hbWUoKTsKICAgIGlmICh0aGlzLnNlcnZpY2VOYW1lICE9PSAnczMnICYmIHRoaXMuc2lnbmF0dXJlVmVyc2lvbiAhPT0gJ3MzdjQnKSBwYXRobmFtZSA9IEFXUy51dGlsLnVyaUVzY2FwZVBhdGgocGF0aG5hbWUpOwoKICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICBwYXJ0cy5wdXNoKHBhdGhuYW1lKTsKICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LnNlYXJjaCgpKTsKICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkgKyAnXG4nKTsKICAgIHBhcnRzLnB1c2godGhpcy5zaWduZWRIZWFkZXJzKCkpOwogICAgcGFydHMucHVzaCh0aGlzLmhleEVuY29kZWRCb2R5SGFzaCgpKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIH0sCgogIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCBpdGVtKSB7CiAgICAgIGhlYWRlcnMucHVzaChba2V5LCBpdGVtXSk7CiAgICB9KTsKICAgIGhlYWRlcnMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICByZXR1cm4gYVswXS50b0xvd2VyQ2FzZSgpIDwgYlswXS50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgfSk7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGhlYWRlcnMsIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIHZhciBrZXkgPSBpdGVtWzBdLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkgewogICAgICAgIHZhciB2YWx1ZSA9IGl0ZW1bMV07CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlLnRvU3RyaW5nICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ0hlYWRlciAnICsga2V5ICsgJyBjb250YWlucyBpbnZhbGlkIHZhbHVlJyksIHsKICAgICAgICAgICAgY29kZTogJ0ludmFsaWRIZWFkZXInCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcGFydHMucHVzaChrZXkgKyAnOicgKwogICAgICAgICAgdGhpcy5jYW5vbmljYWxIZWFkZXJWYWx1ZXModmFsdWUudG9TdHJpbmcoKSkpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIH0sCgogIGNhbm9uaWNhbEhlYWRlclZhbHVlczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVyVmFsdWVzKHZhbHVlcykgewogICAgcmV0dXJuIHZhbHVlcy5yZXBsYWNlKC9ccysvZywgJyAnKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwogIH0sCgogIHNpZ25lZEhlYWRlcnM6IGZ1bmN0aW9uIHNpZ25lZEhlYWRlcnMoKSB7CiAgICB2YXIga2V5cyA9IFtdOwogICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIGtleXMucHVzaChrZXkpOwogICAgfSk7CiAgICByZXR1cm4ga2V5cy5zb3J0KCkuam9pbignOycpOwogIH0sCgogIGNyZWRlbnRpYWxTdHJpbmc6IGZ1bmN0aW9uIGNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpIHsKICAgIHJldHVybiB2NENyZWRlbnRpYWxzLmNyZWF0ZVNjb3BlKAogICAgICBkYXRldGltZS5zdWJzdHIoMCwgOCksCiAgICAgIHRoaXMucmVxdWVzdC5yZWdpb24sCiAgICAgIHRoaXMuc2VydmljZU5hbWUKICAgICk7CiAgfSwKCiAgaGV4RW5jb2RlZEhhc2g6IGZ1bmN0aW9uIGhhc2goc3RyaW5nKSB7CiAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLnNoYTI1NihzdHJpbmcsICdoZXgnKTsKICB9LAoKICBoZXhFbmNvZGVkQm9keUhhc2g6IGZ1bmN0aW9uIGhleEVuY29kZWRCb2R5SGFzaCgpIHsKICAgIHZhciByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0OwogICAgaWYgKHRoaXMuaXNQcmVzaWduZWQoKSAmJiAoWydzMycsICdzMy1vYmplY3QtbGFtYmRhJ10uaW5kZXhPZih0aGlzLnNlcnZpY2VOYW1lKSA+IC0xKSAmJiAhcmVxdWVzdC5ib2R5KSB7CiAgICAgIHJldHVybiAnVU5TSUdORUQtUEFZTE9BRCc7CiAgICB9IGVsc2UgaWYgKHJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXSkgewogICAgICByZXR1cm4gcmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuaGV4RW5jb2RlZEhhc2godGhpcy5yZXF1ZXN0LmJvZHkgfHwgJycpOwogICAgfQogIH0sCgogIHVuc2lnbmFibGVIZWFkZXJzOiBbCiAgICAnYXV0aG9yaXphdGlvbicsCiAgICAnY29udGVudC10eXBlJywKICAgICdjb250ZW50LWxlbmd0aCcsCiAgICAndXNlci1hZ2VudCcsCiAgICBleHBpcmVzSGVhZGVyLAogICAgJ2V4cGVjdCcsCiAgICAneC1hbXpuLXRyYWNlLWlkJwogIF0sCgogIGlzU2lnbmFibGVIZWFkZXI6IGZ1bmN0aW9uIGlzU2lnbmFibGVIZWFkZXIoa2V5KSB7CiAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigneC1hbXotJykgPT09IDApIHJldHVybiB0cnVlOwogICAgcmV0dXJuIHRoaXMudW5zaWduYWJsZUhlYWRlcnMuaW5kZXhPZihrZXkpIDwgMDsKICB9LAoKICBpc1ByZXNpZ25lZDogZnVuY3Rpb24gaXNQcmVzaWduZWQoKSB7CiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPyB0cnVlIDogZmFsc2U7CiAgfQoKfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlY0OwoKfSx7Ii4uL2NvcmUiOjE5LCIuL3Y0X2NyZWRlbnRpYWxzIjo3MH1dLDcwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciBjYWNoZWRTZWNyZXQgPSB7fTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciBjYWNoZVF1ZXVlID0gW107CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgbWF4Q2FjaGVFbnRyaWVzID0gNTA7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgdjRJZGVudGlmaWVyID0gJ2F3czRfcmVxdWVzdCc7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSBkYXRlIFtTdHJpbmddCiAgICogQHBhcmFtIHJlZ2lvbiBbU3RyaW5nXQogICAqIEBwYXJhbSBzZXJ2aWNlTmFtZSBbU3RyaW5nXQogICAqIEByZXR1cm4gW1N0cmluZ10KICAgKi8KICBjcmVhdGVTY29wZTogZnVuY3Rpb24gY3JlYXRlU2NvcGUoZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlTmFtZSkgewogICAgcmV0dXJuIFsKICAgICAgZGF0ZS5zdWJzdHIoMCwgOCksCiAgICAgIHJlZ2lvbiwKICAgICAgc2VydmljZU5hbWUsCiAgICAgIHY0SWRlbnRpZmllcgogICAgXS5qb2luKCcvJyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBAcGFyYW0gY3JlZGVudGlhbHMgW0NyZWRlbnRpYWxzXQogICAqIEBwYXJhbSBkYXRlIFtTdHJpbmddCiAgICogQHBhcmFtIHJlZ2lvbiBbU3RyaW5nXQogICAqIEBwYXJhbSBzZXJ2aWNlIFtTdHJpbmddCiAgICogQHBhcmFtIHNob3VsZENhY2hlIFtCb29sZWFuXQogICAqIEByZXR1cm4gW1N0cmluZ10KICAgKi8KICBnZXRTaWduaW5nS2V5OiBmdW5jdGlvbiBnZXRTaWduaW5nS2V5KAogICAgY3JlZGVudGlhbHMsCiAgICBkYXRlLAogICAgcmVnaW9uLAogICAgc2VydmljZSwKICAgIHNob3VsZENhY2hlCiAgKSB7CiAgICB2YXIgY3JlZHNJZGVudGlmaWVyID0gQVdTLnV0aWwuY3J5cHRvCiAgICAgIC5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQsICdiYXNlNjQnKTsKICAgIHZhciBjYWNoZUtleSA9IFtjcmVkc0lkZW50aWZpZXIsIGRhdGUsIHJlZ2lvbiwgc2VydmljZV0uam9pbignXycpOwogICAgc2hvdWxkQ2FjaGUgPSBzaG91bGRDYWNoZSAhPT0gZmFsc2U7CiAgICBpZiAoc2hvdWxkQ2FjaGUgJiYgKGNhY2hlS2V5IGluIGNhY2hlZFNlY3JldCkpIHsKICAgICAgcmV0dXJuIGNhY2hlZFNlY3JldFtjYWNoZUtleV07CiAgICB9CgogICAgdmFyIGtEYXRlID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoCiAgICAgICdBV1M0JyArIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwKICAgICAgZGF0ZSwKICAgICAgJ2J1ZmZlcicKICAgICk7CiAgICB2YXIga1JlZ2lvbiA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtEYXRlLCByZWdpb24sICdidWZmZXInKTsKICAgIHZhciBrU2VydmljZSA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtSZWdpb24sIHNlcnZpY2UsICdidWZmZXInKTsKCiAgICB2YXIgc2lnbmluZ0tleSA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtTZXJ2aWNlLCB2NElkZW50aWZpZXIsICdidWZmZXInKTsKICAgIGlmIChzaG91bGRDYWNoZSkgewogICAgICBjYWNoZWRTZWNyZXRbY2FjaGVLZXldID0gc2lnbmluZ0tleTsKICAgICAgY2FjaGVRdWV1ZS5wdXNoKGNhY2hlS2V5KTsKICAgICAgaWYgKGNhY2hlUXVldWUubGVuZ3RoID4gbWF4Q2FjaGVFbnRyaWVzKSB7CiAgICAgICAgLy8gcmVtb3ZlIHRoZSBvbGRlc3QgZW50cnkgKG5vdCB0aGUgbGVhc3QgcmVjZW50bHkgdXNlZCkKICAgICAgICBkZWxldGUgY2FjaGVkU2VjcmV0W2NhY2hlUXVldWUuc2hpZnQoKV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gc2lnbmluZ0tleTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEVtcHRpZXMgdGhlIGRlcml2ZWQgc2lnbmluZyBrZXkgY2FjaGUuIE1hZGUgYXZhaWxhYmxlIGZvciB0ZXN0aW5nIHB1cnBvc2VzCiAgICogb25seS4KICAgKi8KICBlbXB0eUNhY2hlOiBmdW5jdGlvbiBlbXB0eUNhY2hlKCkgewogICAgY2FjaGVkU2VjcmV0ID0ge307CiAgICBjYWNoZVF1ZXVlID0gW107CiAgfQp9OwoKfSx7Ii4uL2NvcmUiOjE5fV0sNzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpmdW5jdGlvbiBBY2NlcHRvclN0YXRlTWFjaGluZShzdGF0ZXMsIHN0YXRlKSB7CiAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZSB8fCBudWxsOwogIHRoaXMuc3RhdGVzID0gc3RhdGVzIHx8IHt9Owp9CgpBY2NlcHRvclN0YXRlTWFjaGluZS5wcm90b3R5cGUucnVuVG8gPSBmdW5jdGlvbiBydW5UbyhmaW5hbFN0YXRlLCBkb25lLCBiaW5kT2JqZWN0LCBpbnB1dEVycm9yKSB7CiAgaWYgKHR5cGVvZiBmaW5hbFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICBpbnB1dEVycm9yID0gYmluZE9iamVjdDsgYmluZE9iamVjdCA9IGRvbmU7CiAgICBkb25lID0gZmluYWxTdGF0ZTsgZmluYWxTdGF0ZSA9IG51bGw7CiAgfQoKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyIHN0YXRlID0gc2VsZi5zdGF0ZXNbc2VsZi5jdXJyZW50U3RhdGVdOwogIHN0YXRlLmZuLmNhbGwoYmluZE9iamVjdCB8fCBzZWxmLCBpbnB1dEVycm9yLCBmdW5jdGlvbihlcnIpIHsKICAgIGlmIChlcnIpIHsKICAgICAgaWYgKHN0YXRlLmZhaWwpIHNlbGYuY3VycmVudFN0YXRlID0gc3RhdGUuZmFpbDsKICAgICAgZWxzZSByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChzdGF0ZS5hY2NlcHQpIHNlbGYuY3VycmVudFN0YXRlID0gc3RhdGUuYWNjZXB0OwogICAgICBlbHNlIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QpIDogbnVsbDsKICAgIH0KICAgIGlmIChzZWxmLmN1cnJlbnRTdGF0ZSA9PT0gZmluYWxTdGF0ZSkgewogICAgICByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgIH0KCiAgICBzZWxmLnJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGVycik7CiAgfSk7Cn07CgpBY2NlcHRvclN0YXRlTWFjaGluZS5wcm90b3R5cGUuYWRkU3RhdGUgPSBmdW5jdGlvbiBhZGRTdGF0ZShuYW1lLCBhY2NlcHRTdGF0ZSwgZmFpbFN0YXRlLCBmbikgewogIGlmICh0eXBlb2YgYWNjZXB0U3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGZuID0gYWNjZXB0U3RhdGU7IGFjY2VwdFN0YXRlID0gbnVsbDsgZmFpbFN0YXRlID0gbnVsbDsKICB9IGVsc2UgaWYgKHR5cGVvZiBmYWlsU3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGZuID0gZmFpbFN0YXRlOyBmYWlsU3RhdGUgPSBudWxsOwogIH0KCiAgaWYgKCF0aGlzLmN1cnJlbnRTdGF0ZSkgdGhpcy5jdXJyZW50U3RhdGUgPSBuYW1lOwogIHRoaXMuc3RhdGVzW25hbWVdID0geyBhY2NlcHQ6IGFjY2VwdFN0YXRlLCBmYWlsOiBmYWlsU3RhdGUsIGZuOiBmbiB9OwogIHJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBY2NlcHRvclN0YXRlTWFjaGluZTsKCn0se31dLDcyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzLHNldEltbWVkaWF0ZSl7KGZ1bmN0aW9uICgpewovKiBlc2xpbnQgZ3VhcmQtZm9yLWluOjAgKi8KdmFyIEFXUzsKCi8qKgogKiBBIHNldCBvZiB1dGlsaXR5IG1ldGhvZHMgZm9yIHVzZSB3aXRoIHRoZSBBV1MgU0RLLgogKgogKiBAIWF0dHJpYnV0ZSBhYm9ydAogKiAgIFJldHVybiB0aGlzIHZhbHVlIGZyb20gYW4gaXRlcmF0b3IgZnVuY3Rpb24ge2VhY2h9IG9yIHthcnJheUVhY2h9CiAqICAgdG8gYnJlYWsgb3V0IG9mIHRoZSBpdGVyYXRpb24uCiAqICAgQGV4YW1wbGUgQnJlYWtpbmcgb3V0IG9mIGFuIGl0ZXJhdG9yIGZ1bmN0aW9uCiAqICAgICBBV1MudXRpbC5lYWNoKHthOiAxLCBiOiAyLCBjOiAzfSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogKiAgICAgICBpZiAoa2V5ID09ICdiJykgcmV0dXJuIEFXUy51dGlsLmFib3J0OwogKiAgICAgfSk7CiAqICAgQHNlZSBlYWNoCiAqICAgQHNlZSBhcnJheUVhY2gKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgdXRpbCA9IHsKICBlbnZpcm9ubWVudDogJ25vZGVqcycsCiAgZW5naW5lOiBmdW5jdGlvbiBlbmdpbmUoKSB7CiAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJykgewogICAgICByZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBlbmdpbmUgPSBwcm9jZXNzLnBsYXRmb3JtICsgJy8nICsgcHJvY2Vzcy52ZXJzaW9uOwogICAgICBpZiAocHJvY2Vzcy5lbnYuQVdTX0VYRUNVVElPTl9FTlYpIHsKICAgICAgICBlbmdpbmUgKz0gJyBleGVjLWVudi8nICsgcHJvY2Vzcy5lbnYuQVdTX0VYRUNVVElPTl9FTlY7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuZ2luZTsKICAgIH0KICB9LAoKICB1c2VyQWdlbnQ6IGZ1bmN0aW9uIHVzZXJBZ2VudCgpIHsKICAgIHZhciBuYW1lID0gdXRpbC5lbnZpcm9ubWVudDsKICAgIHZhciBhZ2VudCA9ICdhd3Mtc2RrLScgKyBuYW1lICsgJy8nICsgcmVxdWlyZSgnLi9jb3JlJykuVkVSU0lPTjsKICAgIGlmIChuYW1lID09PSAnbm9kZWpzJykgYWdlbnQgKz0gJyAnICsgdXRpbC5lbmdpbmUoKTsKICAgIHJldHVybiBhZ2VudDsKICB9LAoKICB1cmlFc2NhcGU6IGZ1bmN0aW9uIHVyaUVzY2FwZShzdHJpbmcpIHsKICAgIHZhciBvdXRwdXQgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5nKTsKICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9bXkEtWmEtejAtOV8uflwtJV0rL2csIGVzY2FwZSk7CgogICAgLy8gQVdTIHBlcmNlbnQtZW5jb2RlcyBzb21lIGV4dHJhIG5vbi1zdGFuZGFyZCBjaGFyYWN0ZXJzIGluIGEgVVJJCiAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvWypdL2csIGZ1bmN0aW9uKGNoKSB7CiAgICAgIHJldHVybiAnJScgKyBjaC5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOwogICAgfSk7CgogICAgcmV0dXJuIG91dHB1dDsKICB9LAoKICB1cmlFc2NhcGVQYXRoOiBmdW5jdGlvbiB1cmlFc2NhcGVQYXRoKHN0cmluZykgewogICAgdmFyIHBhcnRzID0gW107CiAgICB1dGlsLmFycmF5RWFjaChzdHJpbmcuc3BsaXQoJy8nKSwgZnVuY3Rpb24gKHBhcnQpIHsKICAgICAgcGFydHMucHVzaCh1dGlsLnVyaUVzY2FwZShwYXJ0KSk7CiAgICB9KTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCcvJyk7CiAgfSwKCiAgdXJsUGFyc2U6IGZ1bmN0aW9uIHVybFBhcnNlKHVybCkgewogICAgcmV0dXJuIHV0aWwudXJsLnBhcnNlKHVybCk7CiAgfSwKCiAgdXJsRm9ybWF0OiBmdW5jdGlvbiB1cmxGb3JtYXQodXJsKSB7CiAgICByZXR1cm4gdXRpbC51cmwuZm9ybWF0KHVybCk7CiAgfSwKCiAgcXVlcnlTdHJpbmdQYXJzZTogZnVuY3Rpb24gcXVlcnlTdHJpbmdQYXJzZShxcykgewogICAgcmV0dXJuIHV0aWwucXVlcnlzdHJpbmcucGFyc2UocXMpOwogIH0sCgogIHF1ZXJ5UGFyYW1zVG9TdHJpbmc6IGZ1bmN0aW9uIHF1ZXJ5UGFyYW1zVG9TdHJpbmcocGFyYW1zKSB7CiAgICB2YXIgaXRlbXMgPSBbXTsKICAgIHZhciBlc2NhcGUgPSB1dGlsLnVyaUVzY2FwZTsKICAgIHZhciBzb3J0ZWRLZXlzID0gT2JqZWN0LmtleXMocGFyYW1zKS5zb3J0KCk7CgogICAgdXRpbC5hcnJheUVhY2goc29ydGVkS2V5cywgZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbbmFtZV07CiAgICAgIHZhciBlbmFtZSA9IGVzY2FwZShuYW1lKTsKICAgICAgdmFyIHJlc3VsdCA9IGVuYW1lICsgJz0nOwogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICB2YXIgdmFscyA9IFtdOwogICAgICAgIHV0aWwuYXJyYXlFYWNoKHZhbHVlLCBmdW5jdGlvbihpdGVtKSB7IHZhbHMucHVzaChlc2NhcGUoaXRlbSkpOyB9KTsKICAgICAgICByZXN1bHQgPSBlbmFtZSArICc9JyArIHZhbHMuc29ydCgpLmpvaW4oJyYnICsgZW5hbWUgKyAnPScpOwogICAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICByZXN1bHQgPSBlbmFtZSArICc9JyArIGVzY2FwZSh2YWx1ZSk7CiAgICAgIH0KICAgICAgaXRlbXMucHVzaChyZXN1bHQpOwogICAgfSk7CgogICAgcmV0dXJuIGl0ZW1zLmpvaW4oJyYnKTsKICB9LAoKICByZWFkRmlsZVN5bmM6IGZ1bmN0aW9uIHJlYWRGaWxlU3luYyhwYXRoKSB7CiAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSkgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcmVxdWlyZSgnZnMnKS5yZWFkRmlsZVN5bmMocGF0aCwgJ3V0Zi04Jyk7CiAgfSwKCiAgYmFzZTY0OiB7CiAgICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZTY0KHN0cmluZykgewogICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ251bWJlcicpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBlbmNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgfQogICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHR5cGVvZiBzdHJpbmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgfQogICAgICB2YXIgYnVmID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAgICAgcmV0dXJuIGJ1Zi50b1N0cmluZygnYmFzZTY0Jyk7CiAgICB9LAoKICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlNjQoc3RyaW5nKSB7CiAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnbnVtYmVyJykgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgYmFzZTY0IGRlY29kZSBudW1iZXIgJyArIHN0cmluZykpOwogICAgICB9CiAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgdHlwZW9mIHN0cmluZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICB9CiAgICAgIHJldHVybiB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcsICdiYXNlNjQnKTsKICAgIH0KCiAgfSwKCiAgYnVmZmVyOiB7CiAgICAvKioKICAgICAqIEJ1ZmZlciBjb25zdHJ1Y3RvciBmb3IgTm9kZSBidWZmZXIgYW5kIGJ1ZmZlciBwb2xseWZpbGwKICAgICAqLwogICAgdG9CdWZmZXI6IGZ1bmN0aW9uKGRhdGEsIGVuY29kaW5nKSB7CiAgICAgIHJldHVybiAodHlwZW9mIHV0aWwuQnVmZmVyLmZyb20gPT09ICdmdW5jdGlvbicgJiYgdXRpbC5CdWZmZXIuZnJvbSAhPT0gVWludDhBcnJheS5mcm9tKSA/CiAgICAgICAgdXRpbC5CdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykgOiBuZXcgdXRpbC5CdWZmZXIoZGF0YSwgZW5jb2RpbmcpOwogICAgfSwKCiAgICBhbGxvYzogZnVuY3Rpb24oc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewogICAgICAgIHRocm93IG5ldyBFcnJvcignc2l6ZSBwYXNzZWQgdG8gYWxsb2MgbXVzdCBiZSBhIG51bWJlci4nKTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuQnVmZmVyLmFsbG9jKHNpemUsIGZpbGwsIGVuY29kaW5nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgYnVmID0gbmV3IHV0aWwuQnVmZmVyKHNpemUpOwogICAgICAgIGlmIChmaWxsICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGJ1Zi5maWxsID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBidWYuZmlsbChmaWxsLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZW5jb2RpbmcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmOwogICAgICB9CiAgICB9LAoKICAgIHRvU3RyZWFtOiBmdW5jdGlvbiB0b1N0cmVhbShidWZmZXIpIHsKICAgICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihidWZmZXIpKSBidWZmZXIgPSAgdXRpbC5idWZmZXIudG9CdWZmZXIoYnVmZmVyKTsKCiAgICAgIHZhciByZWFkYWJsZSA9IG5ldyAodXRpbC5zdHJlYW0uUmVhZGFibGUpKCk7CiAgICAgIHZhciBwb3MgPSAwOwogICAgICByZWFkYWJsZS5fcmVhZCA9IGZ1bmN0aW9uKHNpemUpIHsKICAgICAgICBpZiAocG9zID49IGJ1ZmZlci5sZW5ndGgpIHJldHVybiByZWFkYWJsZS5wdXNoKG51bGwpOwoKICAgICAgICB2YXIgZW5kID0gcG9zICsgc2l6ZTsKICAgICAgICBpZiAoZW5kID4gYnVmZmVyLmxlbmd0aCkgZW5kID0gYnVmZmVyLmxlbmd0aDsKICAgICAgICByZWFkYWJsZS5wdXNoKGJ1ZmZlci5zbGljZShwb3MsIGVuZCkpOwogICAgICAgIHBvcyA9IGVuZDsKICAgICAgfTsKCiAgICAgIHJldHVybiByZWFkYWJsZTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBDb25jYXRlbmF0ZXMgYSBsaXN0IG9mIEJ1ZmZlciBvYmplY3RzLgogICAgICovCiAgICBjb25jYXQ6IGZ1bmN0aW9uKGJ1ZmZlcnMpIHsKICAgICAgdmFyIGxlbmd0aCA9IDAsCiAgICAgICAgICBvZmZzZXQgPSAwLAogICAgICAgICAgYnVmZmVyID0gbnVsbCwgaTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBidWZmZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGVuZ3RoICs9IGJ1ZmZlcnNbaV0ubGVuZ3RoOwogICAgICB9CgogICAgICBidWZmZXIgPSB1dGlsLmJ1ZmZlci5hbGxvYyhsZW5ndGgpOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGJ1ZmZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBidWZmZXJzW2ldLmNvcHkoYnVmZmVyLCBvZmZzZXQpOwogICAgICAgIG9mZnNldCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgfQoKICAgICAgcmV0dXJuIGJ1ZmZlcjsKICAgIH0KICB9LAoKICBzdHJpbmc6IHsKICAgIGJ5dGVMZW5ndGg6IGZ1bmN0aW9uIGJ5dGVMZW5ndGgoc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgc3RyaW5nID09PSB1bmRlZmluZWQpIHJldHVybiAwOwogICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHN0cmluZyA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CgogICAgICBpZiAodHlwZW9mIHN0cmluZy5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiBzdHJpbmcuYnl0ZUxlbmd0aDsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLmxlbmd0aCA9PT0gJ251bWJlcicpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLmxlbmd0aDsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLnNpemUgPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZy5zaXplOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcucGF0aCA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gcmVxdWlyZSgnZnMnKS5sc3RhdFN5bmMoc3RyaW5nLnBhdGgpLnNpemU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBkZXRlcm1pbmUgbGVuZ3RoIG9mICcgKyBzdHJpbmcpLAogICAgICAgICAgeyBvYmplY3Q6IHN0cmluZyB9KTsKICAgICAgfQogICAgfSwKCiAgICB1cHBlckZpcnN0OiBmdW5jdGlvbiB1cHBlckZpcnN0KHN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nWzBdLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc3Vic3RyKDEpOwogICAgfSwKCiAgICBsb3dlckZpcnN0OiBmdW5jdGlvbiBsb3dlckZpcnN0KHN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nWzBdLnRvTG93ZXJDYXNlKCkgKyBzdHJpbmcuc3Vic3RyKDEpOwogICAgfQogIH0sCgogIGluaTogewogICAgcGFyc2U6IGZ1bmN0aW9uIHN0cmluZyhpbmkpIHsKICAgICAgdmFyIGN1cnJlbnRTZWN0aW9uLCBtYXAgPSB7fTsKICAgICAgdXRpbC5hcnJheUVhY2goaW5pLnNwbGl0KC9ccj9cbi8pLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgbGluZSA9IGxpbmUuc3BsaXQoLyhefFxzKVs7I10vKVswXS50cmltKCk7IC8vIHJlbW92ZSBjb21tZW50cyBhbmQgdHJpbQogICAgICAgIHZhciBpc1NlY3Rpb24gPSBsaW5lWzBdID09PSAnWycgJiYgbGluZVtsaW5lLmxlbmd0aCAtIDFdID09PSAnXSc7CiAgICAgICAgaWYgKGlzU2VjdGlvbikgewogICAgICAgICAgY3VycmVudFNlY3Rpb24gPSBsaW5lLnN1YnN0cmluZygxLCBsaW5lLmxlbmd0aCAtIDEpOwogICAgICAgICAgaWYgKGN1cnJlbnRTZWN0aW9uID09PSAnX19wcm90b19fJyB8fCBjdXJyZW50U2VjdGlvbi5zcGxpdCgvXHMvKVsxXSA9PT0gJ19fcHJvdG9fXycpIHsKICAgICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcigKICAgICAgICAgICAgICBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkIHByb2ZpbGUgbmFtZSBcJycgKyBjdXJyZW50U2VjdGlvbiArICdcJyBmcm9tIHNoYXJlZCBpbmkgZmlsZS4nKQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFNlY3Rpb24pIHsKICAgICAgICAgIHZhciBpbmRleE9mRXF1YWxzU2lnbiA9IGxpbmUuaW5kZXhPZignPScpOwogICAgICAgICAgdmFyIHN0YXJ0ID0gMDsKICAgICAgICAgIHZhciBlbmQgPSBsaW5lLmxlbmd0aCAtIDE7CiAgICAgICAgICB2YXIgaXNBc3NpZ25tZW50ID0KICAgICAgICAgICAgaW5kZXhPZkVxdWFsc1NpZ24gIT09IC0xICYmIGluZGV4T2ZFcXVhbHNTaWduICE9PSBzdGFydCAmJiBpbmRleE9mRXF1YWxzU2lnbiAhPT0gZW5kOwoKICAgICAgICAgIGlmIChpc0Fzc2lnbm1lbnQpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBsaW5lLnN1YnN0cmluZygwLCBpbmRleE9mRXF1YWxzU2lnbikudHJpbSgpOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBsaW5lLnN1YnN0cmluZyhpbmRleE9mRXF1YWxzU2lnbiArIDEpLnRyaW0oKTsKCiAgICAgICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl0gPSBtYXBbY3VycmVudFNlY3Rpb25dIHx8IHt9OwogICAgICAgICAgICBtYXBbY3VycmVudFNlY3Rpb25dW25hbWVdID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBtYXA7CiAgICB9CiAgfSwKCiAgZm46IHsKICAgIG5vb3A6IGZ1bmN0aW9uKCkge30sCiAgICBjYWxsYmFjazogZnVuY3Rpb24gKGVycikgeyBpZiAoZXJyKSB0aHJvdyBlcnI7IH0sCgogICAgLyoqCiAgICAgKiBUdXJuIGEgc3luY2hyb25vdXMgZnVuY3Rpb24gaW50byBhcyAiYXN5bmMiIGZ1bmN0aW9uIGJ5IG1ha2luZyBpdCBjYWxsCiAgICAgKiBhIGNhbGxiYWNrLiBUaGUgdW5kZXJseWluZyBmdW5jdGlvbiBpcyBjYWxsZWQgd2l0aCBhbGwgYnV0IHRoZSBsYXN0IGFyZ3VtZW50LAogICAgICogd2hpY2ggaXMgdHJlYXRlZCBhcyB0aGUgY2FsbGJhY2suIFRoZSBjYWxsYmFjayBpcyBwYXNzZWQgcGFzc2VkIGEgZmlyc3QgYXJndW1lbnQKICAgICAqIG9mIG51bGwgb24gc3VjY2VzcyB0byBtaW1pY2sgc3RhbmRhcmQgbm9kZSBjYWxsYmFja3MuCiAgICAgKi8KICAgIG1ha2VBc3luYzogZnVuY3Rpb24gbWFrZUFzeW5jKGZuLCBleHBlY3RlZEFyZ3MpIHsKICAgICAgaWYgKGV4cGVjdGVkQXJncyAmJiBleHBlY3RlZEFyZ3MgPD0gZm4ubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZuOwogICAgICB9CgogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgIHZhciBjYWxsYmFjayA9IGFyZ3MucG9wKCk7CiAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIGNhbGxiYWNrKHJlc3VsdCk7CiAgICAgIH07CiAgICB9CiAgfSwKCiAgLyoqCiAgICogRGF0ZSBhbmQgdGltZSB1dGlsaXR5IGZ1bmN0aW9ucy4KICAgKi8KICBkYXRlOiB7CgogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtEYXRlXSB0aGUgY3VycmVudCBKYXZhU2NyaXB0IGRhdGUgb2JqZWN0LiBTaW5jZSBhbGwKICAgICAqICAgQVdTIHNlcnZpY2VzIHJlbHkgb24gdGhpcyBkYXRlIG9iamVjdCwgeW91IGNhbiBvdmVycmlkZQogICAgICogICB0aGlzIGZ1bmN0aW9uIHRvIHByb3ZpZGUgYSBzcGVjaWFsIHRpbWUgdmFsdWUgdG8gQVdTIHNlcnZpY2UKICAgICAqICAgcmVxdWVzdHMuCiAgICAgKi8KICAgIGdldERhdGU6IGZ1bmN0aW9uIGdldERhdGUoKSB7CiAgICAgIGlmICghQVdTKSBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAgICAgaWYgKEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpIHsgLy8gdXNlIG9mZnNldCB3aGVuIG5vbi16ZXJvCiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBkYXRlIGluIElTTy04NjAxIGZvcm1hdAogICAgICovCiAgICBpc284NjAxOiBmdW5jdGlvbiBpc284NjAxKGRhdGUpIHsKICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICByZXR1cm4gZGF0ZS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1wuXGR7M31aJC8sICdaJyk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgZGF0ZSBpbiBSRkMgODIyIGZvcm1hdAogICAgICovCiAgICByZmM4MjI6IGZ1bmN0aW9uIHJmYzgyMihkYXRlKSB7CiAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgcmV0dXJuIGRhdGUudG9VVENTdHJpbmcoKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgVU5JWCB0aW1lc3RhbXAgdmFsdWUgZm9yIHRoZSBjdXJyZW50IHRpbWUKICAgICAqLwogICAgdW5peFRpbWVzdGFtcDogZnVuY3Rpb24gdW5peFRpbWVzdGFtcChkYXRlKSB7CiAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpIC8gMTAwMDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0gW1N0cmluZyxudW1iZXIsRGF0ZV0gZGF0ZQogICAgICogQHJldHVybiBbRGF0ZV0KICAgICAqLwogICAgZnJvbTogZnVuY3Rpb24gZm9ybWF0KGRhdGUpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRlID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlICogMTAwMCk7IC8vIHVuaXggdGltZXN0YW1wCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUpOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogR2l2ZW4gYSBEYXRlIG9yIGRhdGUtbGlrZSB2YWx1ZSwgdGhpcyBmdW5jdGlvbiBmb3JtYXRzIHRoZQogICAgICogZGF0ZSBpbnRvIGEgc3RyaW5nIG9mIHRoZSByZXF1ZXN0ZWQgdmFsdWUuCiAgICAgKiBAcGFyYW0gW1N0cmluZyxudW1iZXIsRGF0ZV0gZGF0ZQogICAgICogQHBhcmFtIFtTdHJpbmddIGZvcm1hdHRlciBWYWxpZCBmb3JtYXRzIGFyZToKICAgICAjICAgKiAnaXNvODYwMScKICAgICAjICAgKiAncmZjODIyJwogICAgICMgICAqICd1bml4VGltZXN0YW1wJwogICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICovCiAgICBmb3JtYXQ6IGZ1bmN0aW9uIGZvcm1hdChkYXRlLCBmb3JtYXR0ZXIpIHsKICAgICAgaWYgKCFmb3JtYXR0ZXIpIGZvcm1hdHRlciA9ICdpc284NjAxJzsKICAgICAgcmV0dXJuIHV0aWwuZGF0ZVtmb3JtYXR0ZXJdKHV0aWwuZGF0ZS5mcm9tKGRhdGUpKTsKICAgIH0sCgogICAgcGFyc2VUaW1lc3RhbXA6IGZ1bmN0aW9uIHBhcnNlVGltZXN0YW1wKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7IC8vIHVuaXggdGltZXN0YW1wIChudW1iZXIpCiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlICogMTAwMCk7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cZCskLykpIHsgLy8gdW5peCB0aW1lc3RhbXAKICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlxkezR9LykpIHsgLy8gaXNvODYwMQogICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cd3szfSwvKSkgeyAvLyByZmM4MjIKICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IoCiAgICAgICAgICBuZXcgRXJyb3IoJ3VuaGFuZGxlZCB0aW1lc3RhbXAgZm9ybWF0OiAnICsgdmFsdWUpLAogICAgICAgICAge2NvZGU6ICdUaW1lc3RhbXBQYXJzZXJFcnJvcid9KTsKICAgICAgfQogICAgfQoKICB9LAoKICBjcnlwdG86IHsKICAgIGNyYzMyVGFibGU6IFsKICAgICAweDAwMDAwMDAwLCAweDc3MDczMDk2LCAweEVFMEU2MTJDLCAweDk5MDk1MUJBLCAweDA3NkRDNDE5LAogICAgIDB4NzA2QUY0OEYsIDB4RTk2M0E1MzUsIDB4OUU2NDk1QTMsIDB4MEVEQjg4MzIsIDB4NzlEQ0I4QTQsCiAgICAgMHhFMEQ1RTkxRSwgMHg5N0QyRDk4OCwgMHgwOUI2NEMyQiwgMHg3RUIxN0NCRCwgMHhFN0I4MkQwNywKICAgICAweDkwQkYxRDkxLCAweDFEQjcxMDY0LCAweDZBQjAyMEYyLCAweEYzQjk3MTQ4LCAweDg0QkU0MURFLAogICAgIDB4MUFEQUQ0N0QsIDB4NkREREU0RUIsIDB4RjRENEI1NTEsIDB4ODNEMzg1QzcsIDB4MTM2Qzk4NTYsCiAgICAgMHg2NDZCQThDMCwgMHhGRDYyRjk3QSwgMHg4QTY1QzlFQywgMHgxNDAxNUM0RiwgMHg2MzA2NkNEOSwKICAgICAweEZBMEYzRDYzLCAweDhEMDgwREY1LCAweDNCNkUyMEM4LCAweDRDNjkxMDVFLCAweEQ1NjA0MUU0LAogICAgIDB4QTI2NzcxNzIsIDB4M0MwM0U0RDEsIDB4NEIwNEQ0NDcsIDB4RDIwRDg1RkQsIDB4QTUwQUI1NkIsCiAgICAgMHgzNUI1QThGQSwgMHg0MkIyOTg2QywgMHhEQkJCQzlENiwgMHhBQ0JDRjk0MCwgMHgzMkQ4NkNFMywKICAgICAweDQ1REY1Qzc1LCAweERDRDYwRENGLCAweEFCRDEzRDU5LCAweDI2RDkzMEFDLCAweDUxREUwMDNBLAogICAgIDB4QzhENzUxODAsIDB4QkZEMDYxMTYsIDB4MjFCNEY0QjUsIDB4NTZCM0M0MjMsIDB4Q0ZCQTk1OTksCiAgICAgMHhCOEJEQTUwRiwgMHgyODAyQjg5RSwgMHg1RjA1ODgwOCwgMHhDNjBDRDlCMiwgMHhCMTBCRTkyNCwKICAgICAweDJGNkY3Qzg3LCAweDU4Njg0QzExLCAweEMxNjExREFCLCAweEI2NjYyRDNELCAweDc2REM0MTkwLAogICAgIDB4MDFEQjcxMDYsIDB4OThEMjIwQkMsIDB4RUZENTEwMkEsIDB4NzFCMTg1ODksIDB4MDZCNkI1MUYsCiAgICAgMHg5RkJGRTRBNSwgMHhFOEI4RDQzMywgMHg3ODA3QzlBMiwgMHgwRjAwRjkzNCwgMHg5NjA5QTg4RSwKICAgICAweEUxMEU5ODE4LCAweDdGNkEwREJCLCAweDA4NkQzRDJELCAweDkxNjQ2Qzk3LCAweEU2NjM1QzAxLAogICAgIDB4NkI2QjUxRjQsIDB4MUM2QzYxNjIsIDB4ODU2NTMwRDgsIDB4RjI2MjAwNEUsIDB4NkMwNjk1RUQsCiAgICAgMHgxQjAxQTU3QiwgMHg4MjA4RjRDMSwgMHhGNTBGQzQ1NywgMHg2NUIwRDlDNiwgMHgxMkI3RTk1MCwKICAgICAweDhCQkVCOEVBLCAweEZDQjk4ODdDLCAweDYyREQxRERGLCAweDE1REEyRDQ5LCAweDhDRDM3Q0YzLAogICAgIDB4RkJENDRDNjUsIDB4NERCMjYxNTgsIDB4M0FCNTUxQ0UsIDB4QTNCQzAwNzQsIDB4RDRCQjMwRTIsCiAgICAgMHg0QURGQTU0MSwgMHgzREQ4OTVENywgMHhBNEQxQzQ2RCwgMHhEM0Q2RjRGQiwgMHg0MzY5RTk2QSwKICAgICAweDM0NkVEOUZDLCAweEFENjc4ODQ2LCAweERBNjBCOEQwLCAweDQ0MDQyRDczLCAweDMzMDMxREU1LAogICAgIDB4QUEwQTRDNUYsIDB4REQwRDdDQzksIDB4NTAwNTcxM0MsIDB4MjcwMjQxQUEsIDB4QkUwQjEwMTAsCiAgICAgMHhDOTBDMjA4NiwgMHg1NzY4QjUyNSwgMHgyMDZGODVCMywgMHhCOTY2RDQwOSwgMHhDRTYxRTQ5RiwKICAgICAweDVFREVGOTBFLCAweDI5RDlDOTk4LCAweEIwRDA5ODIyLCAweEM3RDdBOEI0LCAweDU5QjMzRDE3LAogICAgIDB4MkVCNDBEODEsIDB4QjdCRDVDM0IsIDB4QzBCQTZDQUQsIDB4RURCODgzMjAsIDB4OUFCRkIzQjYsCiAgICAgMHgwM0I2RTIwQywgMHg3NEIxRDI5QSwgMHhFQUQ1NDczOSwgMHg5REQyNzdBRiwgMHgwNERCMjYxNSwKICAgICAweDczREMxNjgzLCAweEUzNjMwQjEyLCAweDk0NjQzQjg0LCAweDBENkQ2QTNFLCAweDdBNkE1QUE4LAogICAgIDB4RTQwRUNGMEIsIDB4OTMwOUZGOUQsIDB4MEEwMEFFMjcsIDB4N0QwNzlFQjEsIDB4RjAwRjkzNDQsCiAgICAgMHg4NzA4QTNEMiwgMHgxRTAxRjI2OCwgMHg2OTA2QzJGRSwgMHhGNzYyNTc1RCwgMHg4MDY1NjdDQiwKICAgICAweDE5NkMzNjcxLCAweDZFNkIwNkU3LCAweEZFRDQxQjc2LCAweDg5RDMyQkUwLCAweDEwREE3QTVBLAogICAgIDB4NjdERDRBQ0MsIDB4RjlCOURGNkYsIDB4OEVCRUVGRjksIDB4MTdCN0JFNDMsIDB4NjBCMDhFRDUsCiAgICAgMHhENkQ2QTNFOCwgMHhBMUQxOTM3RSwgMHgzOEQ4QzJDNCwgMHg0RkRGRjI1MiwgMHhEMUJCNjdGMSwKICAgICAweEE2QkM1NzY3LCAweDNGQjUwNkRELCAweDQ4QjIzNjRCLCAweEQ4MEQyQkRBLCAweEFGMEExQjRDLAogICAgIDB4MzYwMzRBRjYsIDB4NDEwNDdBNjAsIDB4REY2MEVGQzMsIDB4QTg2N0RGNTUsIDB4MzE2RThFRUYsCiAgICAgMHg0NjY5QkU3OSwgMHhDQjYxQjM4QywgMHhCQzY2ODMxQSwgMHgyNTZGRDJBMCwgMHg1MjY4RTIzNiwKICAgICAweENDMEM3Nzk1LCAweEJCMEI0NzAzLCAweDIyMDIxNkI5LCAweDU1MDUyNjJGLCAweEM1QkEzQkJFLAogICAgIDB4QjJCRDBCMjgsIDB4MkJCNDVBOTIsIDB4NUNCMzZBMDQsIDB4QzJEN0ZGQTcsIDB4QjVEMENGMzEsCiAgICAgMHgyQ0Q5OUU4QiwgMHg1QkRFQUUxRCwgMHg5QjY0QzJCMCwgMHhFQzYzRjIyNiwgMHg3NTZBQTM5QywKICAgICAweDAyNkQ5MzBBLCAweDlDMDkwNkE5LCAweEVCMEUzNjNGLCAweDcyMDc2Nzg1LCAweDA1MDA1NzEzLAogICAgIDB4OTVCRjRBODIsIDB4RTJCODdBMTQsIDB4N0JCMTJCQUUsIDB4MENCNjFCMzgsIDB4OTJEMjhFOUIsCiAgICAgMHhFNUQ1QkUwRCwgMHg3Q0RDRUZCNywgMHgwQkRCREYyMSwgMHg4NkQzRDJENCwgMHhGMUQ0RTI0MiwKICAgICAweDY4RERCM0Y4LCAweDFGREE4MzZFLCAweDgxQkUxNkNELCAweEY2QjkyNjVCLCAweDZGQjA3N0UxLAogICAgIDB4MThCNzQ3NzcsIDB4ODgwODVBRTYsIDB4RkYwRjZBNzAsIDB4NjYwNjNCQ0EsIDB4MTEwMTBCNUMsCiAgICAgMHg4RjY1OUVGRiwgMHhGODYyQUU2OSwgMHg2MTZCRkZEMywgMHgxNjZDQ0Y0NSwgMHhBMDBBRTI3OCwKICAgICAweEQ3MEREMkVFLCAweDRFMDQ4MzU0LCAweDM5MDNCM0MyLCAweEE3NjcyNjYxLCAweEQwNjAxNkY3LAogICAgIDB4NDk2OTQ3NEQsIDB4M0U2RTc3REIsIDB4QUVEMTZBNEEsIDB4RDlENjVBREMsIDB4NDBERjBCNjYsCiAgICAgMHgzN0Q4M0JGMCwgMHhBOUJDQUU1MywgMHhERUJCOUVDNSwgMHg0N0IyQ0Y3RiwgMHgzMEI1RkZFOSwKICAgICAweEJEQkRGMjFDLCAweENBQkFDMjhBLCAweDUzQjM5MzMwLCAweDI0QjRBM0E2LCAweEJBRDAzNjA1LAogICAgIDB4Q0RENzA2OTMsIDB4NTRERTU3MjksIDB4MjNEOTY3QkYsIDB4QjM2NjdBMkUsIDB4QzQ2MTRBQjgsCiAgICAgMHg1RDY4MUIwMiwgMHgyQTZGMkI5NCwgMHhCNDBCQkUzNywgMHhDMzBDOEVBMSwgMHg1QTA1REYxQiwKICAgICAweDJEMDJFRjhEXSwKCiAgICBjcmMzMjogZnVuY3Rpb24gY3JjMzIoZGF0YSkgewogICAgICB2YXIgdGJsID0gdXRpbC5jcnlwdG8uY3JjMzJUYWJsZTsKICAgICAgdmFyIGNyYyA9IDAgXiAtMTsKCiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBkYXRhID0gdXRpbC5idWZmZXIudG9CdWZmZXIoZGF0YSk7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjb2RlID0gZGF0YS5yZWFkVUludDgoaSk7CiAgICAgICAgY3JjID0gKGNyYyA+Pj4gOCkgXiB0YmxbKGNyYyBeIGNvZGUpICYgMHhGRl07CiAgICAgIH0KICAgICAgcmV0dXJuIChjcmMgXiAtMSkgPj4+IDA7CiAgICB9LAoKICAgIGhtYWM6IGZ1bmN0aW9uIGhtYWMoa2V5LCBzdHJpbmcsIGRpZ2VzdCwgZm4pIHsKICAgICAgaWYgKCFkaWdlc3QpIGRpZ2VzdCA9ICdiaW5hcnknOwogICAgICBpZiAoZGlnZXN0ID09PSAnYnVmZmVyJykgeyBkaWdlc3QgPSB1bmRlZmluZWQ7IH0KICAgICAgaWYgKCFmbikgZm4gPSAnc2hhMjU2JzsKICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdzdHJpbmcnKSBzdHJpbmcgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogICAgICByZXR1cm4gdXRpbC5jcnlwdG8ubGliLmNyZWF0ZUhtYWMoZm4sIGtleSkudXBkYXRlKHN0cmluZykuZGlnZXN0KGRpZ2VzdCk7CiAgICB9LAoKICAgIG1kNTogZnVuY3Rpb24gbWQ1KGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ21kNScsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgfSwKCiAgICBzaGEyNTY6IGZ1bmN0aW9uIHNoYTI1NihkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB1dGlsLmNyeXB0by5oYXNoKCdzaGEyNTYnLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKTsKICAgIH0sCgogICAgaGFzaDogZnVuY3Rpb24oYWxnb3JpdGhtLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBoYXNoID0gdXRpbC5jcnlwdG8uY3JlYXRlSGFzaChhbGdvcml0aG0pOwogICAgICBpZiAoIWRpZ2VzdCkgeyBkaWdlc3QgPSAnYmluYXJ5JzsgfQogICAgICBpZiAoZGlnZXN0ID09PSAnYnVmZmVyJykgeyBkaWdlc3QgPSB1bmRlZmluZWQ7IH0KICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgZGF0YSA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKGRhdGEpOwogICAgICB2YXIgc2xpY2VGbiA9IHV0aWwuYXJyYXlTbGljZUZuKGRhdGEpOwogICAgICB2YXIgaXNCdWZmZXIgPSB1dGlsLkJ1ZmZlci5pc0J1ZmZlcihkYXRhKTsKICAgICAgLy9JZGVudGlmeWluZyBvYmplY3RzIHdpdGggYW4gQXJyYXlCdWZmZXIgYXMgYnVmZmVycwogICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIGRhdGEgJiYgZGF0YS5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgaXNCdWZmZXIgPSB0cnVlOwoKICAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJgogICAgICAgICAgdHlwZW9mIGRhdGEub24gPT09ICdmdW5jdGlvbicgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgZGF0YS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7IGhhc2gudXBkYXRlKGNodW5rKTsgfSk7CiAgICAgICAgZGF0YS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsgY2FsbGJhY2soZXJyKTsgfSk7CiAgICAgICAgZGF0YS5vbignZW5kJywgZnVuY3Rpb24oKSB7IGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOyB9KTsKICAgICAgfSBlbHNlIGlmIChjYWxsYmFjayAmJiBzbGljZUZuICYmICFpc0J1ZmZlciAmJgogICAgICAgICAgICAgICAgIHR5cGVvZiBGaWxlUmVhZGVyICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIC8vIHRoaXMgbWlnaHQgYmUgYSBGaWxlL0Jsb2IKICAgICAgICB2YXIgaW5kZXggPSAwLCBzaXplID0gMTAyNCAqIDUxMjsKICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICByZWFkZXIub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdGYWlsZWQgdG8gcmVhZCBkYXRhLicpKTsKICAgICAgICB9OwogICAgICAgIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBidWYgPSBuZXcgdXRpbC5CdWZmZXIobmV3IFVpbnQ4QXJyYXkocmVhZGVyLnJlc3VsdCkpOwogICAgICAgICAgaGFzaC51cGRhdGUoYnVmKTsKICAgICAgICAgIGluZGV4ICs9IGJ1Zi5sZW5ndGg7CiAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZygpOwogICAgICAgIH07CiAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChpbmRleCA+PSBkYXRhLnNpemUpIHsKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgaGFzaC5kaWdlc3QoZGlnZXN0KSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYmFjayA9IGluZGV4ICsgc2l6ZTsKICAgICAgICAgIGlmIChiYWNrID4gZGF0YS5zaXplKSBiYWNrID0gZGF0YS5zaXplOwogICAgICAgICAgcmVhZGVyLnJlYWRBc0FycmF5QnVmZmVyKHNsaWNlRm4uY2FsbChkYXRhLCBpbmRleCwgYmFjaykpOwogICAgICAgIH07CgogICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmICFpc0J1ZmZlcikgewogICAgICAgICAgZGF0YSA9IG5ldyB1dGlsLkJ1ZmZlcihuZXcgVWludDhBcnJheShkYXRhKSk7CiAgICAgICAgfQogICAgICAgIHZhciBvdXQgPSBoYXNoLnVwZGF0ZShkYXRhKS5kaWdlc3QoZGlnZXN0KTsKICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKG51bGwsIG91dCk7CiAgICAgICAgcmV0dXJuIG91dDsKICAgICAgfQogICAgfSwKCiAgICB0b0hleDogZnVuY3Rpb24gdG9IZXgoZGF0YSkgewogICAgICB2YXIgb3V0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgIG91dC5wdXNoKCgnMCcgKyBkYXRhLmNoYXJDb2RlQXQoaSkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTIsIDIpKTsKICAgICAgfQogICAgICByZXR1cm4gb3V0LmpvaW4oJycpOwogICAgfSwKCiAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZ29yaXRobSkgewogICAgICByZXR1cm4gdXRpbC5jcnlwdG8ubGliLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTsKICAgIH0KCiAgfSwKCiAgLyoqIEAhaWdub3JlICovCgogIC8qIEFib3J0IGNvbnN0YW50ICovCiAgYWJvcnQ6IHt9LAoKICBlYWNoOiBmdW5jdGlvbiBlYWNoKG9iamVjdCwgaXRlckZ1bmN0aW9uKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB7CiAgICAgICAgdmFyIHJldCA9IGl0ZXJGdW5jdGlvbi5jYWxsKHRoaXMsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICB9CiAgICB9CiAgfSwKCiAgYXJyYXlFYWNoOiBmdW5jdGlvbiBhcnJheUVhY2goYXJyYXksIGl0ZXJGdW5jdGlvbikgewogICAgZm9yICh2YXIgaWR4IGluIGFycmF5KSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYXJyYXksIGlkeCkpIHsKICAgICAgICB2YXIgcmV0ID0gaXRlckZ1bmN0aW9uLmNhbGwodGhpcywgYXJyYXlbaWR4XSwgcGFyc2VJbnQoaWR4LCAxMCkpOwogICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICB9CiAgICB9CiAgfSwKCiAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUob2JqMSwgb2JqMikgewogICAgdXRpbC5lYWNoKG9iajIsIGZ1bmN0aW9uIGl0ZXJhdG9yKGtleSwgaXRlbSkgewogICAgICBvYmoxW2tleV0gPSBpdGVtOwogICAgfSk7CiAgICByZXR1cm4gb2JqMTsKICB9LAoKICBtZXJnZTogZnVuY3Rpb24gbWVyZ2Uob2JqMSwgb2JqMikgewogICAgcmV0dXJuIHV0aWwudXBkYXRlKHV0aWwuY29weShvYmoxKSwgb2JqMik7CiAgfSwKCiAgY29weTogZnVuY3Rpb24gY29weShvYmplY3QpIHsKICAgIGlmIChvYmplY3QgPT09IG51bGwgfHwgb2JqZWN0ID09PSB1bmRlZmluZWQpIHJldHVybiBvYmplY3Q7CiAgICB2YXIgZHVwZSA9IHt9OwogICAgLy8ganNoaW50IGZvcmluOmZhbHNlCiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgIGR1cGVba2V5XSA9IG9iamVjdFtrZXldOwogICAgfQogICAgcmV0dXJuIGR1cGU7CiAgfSwKCiAgaXNFbXB0eTogZnVuY3Rpb24gaXNFbXB0eShvYmopIHsKICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgYXJyYXlTbGljZUZuOiBmdW5jdGlvbiBhcnJheVNsaWNlRm4ob2JqKSB7CiAgICB2YXIgZm4gPSBvYmouc2xpY2UgfHwgb2JqLndlYmtpdFNsaWNlIHx8IG9iai5tb3pTbGljZTsKICAgIHJldHVybiB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicgPyBmbiA6IG51bGw7CiAgfSwKCiAgaXNUeXBlOiBmdW5jdGlvbiBpc1R5cGUob2JqLCB0eXBlKSB7CiAgICAvLyBoYW5kbGUgY3Jvc3MtImZyYW1lIiBvYmplY3RzCiAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicpIHR5cGUgPSB1dGlsLnR5cGVOYW1lKHR5cGUpOwogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCAnICsgdHlwZSArICddJzsKICB9LAoKICB0eXBlTmFtZTogZnVuY3Rpb24gdHlwZU5hbWUodHlwZSkgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0eXBlLCAnbmFtZScpKSByZXR1cm4gdHlwZS5uYW1lOwogICAgdmFyIHN0ciA9IHR5cGUudG9TdHJpbmcoKTsKICAgIHZhciBtYXRjaCA9IHN0ci5tYXRjaCgvXlxzKmZ1bmN0aW9uICguKylcKC8pOwogICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBzdHI7CiAgfSwKCiAgZXJyb3I6IGZ1bmN0aW9uIGVycm9yKGVyciwgb3B0aW9ucykgewogICAgdmFyIG9yaWdpbmFsRXJyb3IgPSBudWxsOwogICAgaWYgKHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycgJiYgZXJyLm1lc3NhZ2UgIT09ICcnKSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgfHwgKG9wdGlvbnMgJiYgb3B0aW9ucy5tZXNzYWdlKSkgewogICAgICAgIG9yaWdpbmFsRXJyb3IgPSB1dGlsLmNvcHkoZXJyKTsKICAgICAgICBvcmlnaW5hbEVycm9yLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgfQogICAgfQogICAgZXJyLm1lc3NhZ2UgPSBlcnIubWVzc2FnZSB8fCBudWxsOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgZXJyLm1lc3NhZ2UgPSBvcHRpb25zOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcgJiYgb3B0aW9ucyAhPT0gbnVsbCkgewogICAgICB1dGlsLnVwZGF0ZShlcnIsIG9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5tZXNzYWdlKQogICAgICAgIGVyci5tZXNzYWdlID0gb3B0aW9ucy5tZXNzYWdlOwogICAgICBpZiAob3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZSkKICAgICAgICBlcnIuY29kZSA9IG9wdGlvbnMuY29kZSB8fCBvcHRpb25zLm5hbWU7CiAgICAgIGlmIChvcHRpb25zLnN0YWNrKQogICAgICAgIGVyci5zdGFjayA9IG9wdGlvbnMuc3RhY2s7CiAgICB9CgogICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVyciwgJ25hbWUnLCB7d3JpdGFibGU6IHRydWUsIGVudW1lcmFibGU6IGZhbHNlfSk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlcnIsICdtZXNzYWdlJywge2VudW1lcmFibGU6IHRydWV9KTsKICAgIH0KCiAgICBlcnIubmFtZSA9IFN0cmluZyhvcHRpb25zICYmIG9wdGlvbnMubmFtZSB8fCBlcnIubmFtZSB8fCBlcnIuY29kZSB8fCAnRXJyb3InKTsKICAgIGVyci50aW1lID0gbmV3IERhdGUoKTsKCiAgICBpZiAob3JpZ2luYWxFcnJvcikgZXJyLm9yaWdpbmFsRXJyb3IgPSBvcmlnaW5hbEVycm9yOwoKICAgIHJldHVybiBlcnI7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaW5oZXJpdDogZnVuY3Rpb24gaW5oZXJpdChrbGFzcywgZmVhdHVyZXMpIHsKICAgIHZhciBuZXdPYmplY3QgPSBudWxsOwogICAgaWYgKGZlYXR1cmVzID09PSB1bmRlZmluZWQpIHsKICAgICAgZmVhdHVyZXMgPSBrbGFzczsKICAgICAga2xhc3MgPSBPYmplY3Q7CiAgICAgIG5ld09iamVjdCA9IHt9OwogICAgfSBlbHNlIHsKICAgICAgdmFyIGN0b3IgPSBmdW5jdGlvbiBDb25zdHJ1Y3RvcldyYXBwZXIoKSB7fTsKICAgICAgY3Rvci5wcm90b3R5cGUgPSBrbGFzcy5wcm90b3R5cGU7CiAgICAgIG5ld09iamVjdCA9IG5ldyBjdG9yKCk7CiAgICB9CgogICAgLy8gY29uc3RydWN0b3Igbm90IHN1cHBsaWVkLCBjcmVhdGUgcGFzcy10aHJvdWdoIGN0b3IKICAgIGlmIChmZWF0dXJlcy5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSB7CiAgICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGtsYXNzICE9PSBPYmplY3QpIHsKICAgICAgICAgIHJldHVybiBrbGFzcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBuZXdPYmplY3Q7CiAgICB1dGlsLnVwZGF0ZShmZWF0dXJlcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsIGZlYXR1cmVzKTsKICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yLl9fc3VwZXJfXyA9IGtsYXNzOwogICAgcmV0dXJuIGZlYXR1cmVzLmNvbnN0cnVjdG9yOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1peGluOiBmdW5jdGlvbiBtaXhpbigpIHsKICAgIHZhciBrbGFzcyA9IGFyZ3VtZW50c1swXTsKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIC8vIGpzaGludCBmb3JpbjpmYWxzZQogICAgICBmb3IgKHZhciBwcm9wIGluIGFyZ3VtZW50c1tpXS5wcm90b3R5cGUpIHsKICAgICAgICB2YXIgZm4gPSBhcmd1bWVudHNbaV0ucHJvdG90eXBlW3Byb3BdOwogICAgICAgIGlmIChwcm9wICE9PSAnY29uc3RydWN0b3InKSB7CiAgICAgICAgICBrbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmbjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBrbGFzczsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBoaWRlUHJvcGVydGllczogZnVuY3Rpb24gaGlkZVByb3BlcnRpZXMob2JqLCBwcm9wcykgewogICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgIT09ICdmdW5jdGlvbicpIHJldHVybjsKCiAgICB1dGlsLmFycmF5RWFjaChwcm9wcywgZnVuY3Rpb24gKGtleSkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9KTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHByb3BlcnR5OiBmdW5jdGlvbiBwcm9wZXJ0eShvYmosIG5hbWUsIHZhbHVlLCBlbnVtZXJhYmxlLCBpc1ZhbHVlKSB7CiAgICB2YXIgb3B0cyA9IHsKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICBlbnVtZXJhYmxlOiBlbnVtZXJhYmxlICE9PSB1bmRlZmluZWQgPyBlbnVtZXJhYmxlIDogdHJ1ZQogICAgfTsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgJiYgIWlzVmFsdWUpIHsKICAgICAgb3B0cy5nZXQgPSB2YWx1ZTsKICAgIH0KICAgIGVsc2UgewogICAgICBvcHRzLnZhbHVlID0gdmFsdWU7IG9wdHMud3JpdGFibGUgPSB0cnVlOwogICAgfQoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIG5hbWUsIG9wdHMpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1lbW9pemVkUHJvcGVydHk6IGZ1bmN0aW9uIG1lbW9pemVkUHJvcGVydHkob2JqLCBuYW1lLCBnZXQsIGVudW1lcmFibGUpIHsKICAgIHZhciBjYWNoZWRWYWx1ZSA9IG51bGw7CgogICAgLy8gYnVpbGQgZW51bWVyYWJsZSBhdHRyaWJ1dGUgZm9yIGVhY2ggdmFsdWUgd2l0aCBsYXp5IGFjY2Vzc29yLgogICAgdXRpbC5wcm9wZXJ0eShvYmosIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoY2FjaGVkVmFsdWUgPT09IG51bGwpIHsKICAgICAgICBjYWNoZWRWYWx1ZSA9IGdldCgpOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZWRWYWx1ZTsKICAgIH0sIGVudW1lcmFibGUpOwogIH0sCgogIC8qKgogICAqIFRPRE8gUmVtb3ZlIGluIG1ham9yIHZlcnNpb24gcmV2aXNpb24KICAgKiBUaGlzIGJhY2tmaWxsIHBvcHVsYXRlcyByZXNwb25zZSBkYXRhIHdpdGhvdXQgdGhlCiAgICogdG9wLWxldmVsIHBheWxvYWQgbmFtZS4KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGhvaXN0UGF5bG9hZE1lbWJlcjogZnVuY3Rpb24gaG9pc3RQYXlsb2FkTWVtYmVyKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uTmFtZSA9IHJlcS5vcGVyYXRpb247CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uTmFtZV07CiAgICB2YXIgb3V0cHV0ID0gb3BlcmF0aW9uLm91dHB1dDsKICAgIGlmIChvdXRwdXQucGF5bG9hZCAmJiAhb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0KSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbb3V0cHV0LnBheWxvYWRdOwogICAgICB2YXIgcmVzcG9uc2VQYXlsb2FkID0gcmVzcC5kYXRhW291dHB1dC5wYXlsb2FkXTsKICAgICAgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgICB1dGlsLmVhY2gocmVzcG9uc2VQYXlsb2FkLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICB1dGlsLnByb3BlcnR5KHJlc3AuZGF0YSwga2V5LCB2YWx1ZSwgZmFsc2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQ29tcHV0ZSBTSEEtMjU2IGNoZWNrc3VtcyBvZiBzdHJlYW1zCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjb21wdXRlU2hhMjU2OiBmdW5jdGlvbiBjb21wdXRlU2hhMjU2KGJvZHksIGRvbmUpIHsKICAgIGlmICh1dGlsLmlzTm9kZSgpKSB7CiAgICAgIHZhciBTdHJlYW0gPSB1dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgIHZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgICAgIGlmICh0eXBlb2YgU3RyZWFtID09PSAnZnVuY3Rpb24nICYmIGJvZHkgaW5zdGFuY2VvZiBTdHJlYW0pIHsKICAgICAgICBpZiAodHlwZW9mIGJvZHkucGF0aCA9PT0gJ3N0cmluZycpIHsgLy8gYXNzdW1lIGZpbGUgb2JqZWN0CiAgICAgICAgICB2YXIgc2V0dGluZ3MgPSB7fTsKICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5zdGFydCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgc2V0dGluZ3Muc3RhcnQgPSBib2R5LnN0YXJ0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBib2R5LmVuZCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgc2V0dGluZ3MuZW5kID0gYm9keS5lbmQ7CiAgICAgICAgICB9CiAgICAgICAgICBib2R5ID0gZnMuY3JlYXRlUmVhZFN0cmVhbShib2R5LnBhdGgsIHNldHRpbmdzKTsKICAgICAgICB9IGVsc2UgeyAvLyBUT0RPIHN1cHBvcnQgb3RoZXIgc3RyZWFtIHR5cGVzCiAgICAgICAgICByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ05vbi1maWxlIHN0cmVhbSBvYmplY3RzIGFyZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbm90IHN1cHBvcnRlZCB3aXRoIFNpZ1Y0JykpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHV0aWwuY3J5cHRvLnNoYTI1Nihib2R5LCAnaGV4JywgZnVuY3Rpb24oZXJyLCBzaGEpIHsKICAgICAgaWYgKGVycikgZG9uZShlcnIpOwogICAgICBlbHNlIGRvbmUobnVsbCwgc2hhKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQoc2VydmVyVGltZSkgewogICAgaWYgKHNlcnZlclRpbWUpIHsKICAgICAgdXRpbC5wcm9wZXJ0eShBV1MuY29uZmlnLCAnaXNDbG9ja1NrZXdlZCcsCiAgICAgICAgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSBzZXJ2ZXJUaW1lKSA+PSAzMDAwMDAsIGZhbHNlKTsKICAgICAgcmV0dXJuIEFXUy5jb25maWcuaXNDbG9ja1NrZXdlZDsKICAgIH0KICB9LAoKICBhcHBseUNsb2NrT2Zmc2V0OiBmdW5jdGlvbiBhcHBseUNsb2NrT2Zmc2V0KHNlcnZlclRpbWUpIHsKICAgIGlmIChzZXJ2ZXJUaW1lKQogICAgICBBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0ID0gc2VydmVyVGltZSAtIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGV4dHJhY3RSZXF1ZXN0SWQ6IGZ1bmN0aW9uIGV4dHJhY3RSZXF1ZXN0SWQocmVzcCkgewogICAgdmFyIHJlcXVlc3RJZCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSB8fAogICAgICAgICAgICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ107CgogICAgaWYgKCFyZXF1ZXN0SWQgJiYgcmVzcC5kYXRhICYmIHJlc3AuZGF0YS5SZXNwb25zZU1ldGFkYXRhKSB7CiAgICAgIHJlcXVlc3RJZCA9IHJlc3AuZGF0YS5SZXNwb25zZU1ldGFkYXRhLlJlcXVlc3RJZDsKICAgIH0KCiAgICBpZiAocmVxdWVzdElkKSB7CiAgICAgIHJlc3AucmVxdWVzdElkID0gcmVxdWVzdElkOwogICAgfQoKICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgIHJlc3AuZXJyb3IucmVxdWVzdElkID0gcmVxdWVzdElkOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFkZFByb21pc2VzOiBmdW5jdGlvbiBhZGRQcm9taXNlcyhjb25zdHJ1Y3RvcnMsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB2YXIgZGVsZXRlUHJvbWlzZXMgPSBmYWxzZTsKICAgIGlmIChQcm9taXNlRGVwZW5kZW5jeSA9PT0gdW5kZWZpbmVkICYmIEFXUyAmJiBBV1MuY29uZmlnKSB7CiAgICAgIFByb21pc2VEZXBlbmRlbmN5ID0gQVdTLmNvbmZpZy5nZXRQcm9taXNlc0RlcGVuZGVuY3koKTsKICAgIH0KICAgIGlmIChQcm9taXNlRGVwZW5kZW5jeSA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBQcm9taXNlICE9PSAndW5kZWZpbmVkJykgewogICAgICBQcm9taXNlRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICB9CiAgICBpZiAodHlwZW9mIFByb21pc2VEZXBlbmRlbmN5ICE9PSAnZnVuY3Rpb24nKSBkZWxldGVQcm9taXNlcyA9IHRydWU7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkoY29uc3RydWN0b3JzKSkgY29uc3RydWN0b3JzID0gW2NvbnN0cnVjdG9yc107CgogICAgZm9yICh2YXIgaW5kID0gMDsgaW5kIDwgY29uc3RydWN0b3JzLmxlbmd0aDsgaW5kKyspIHsKICAgICAgdmFyIGNvbnN0cnVjdG9yID0gY29uc3RydWN0b3JzW2luZF07CiAgICAgIGlmIChkZWxldGVQcm9taXNlcykgewogICAgICAgIGlmIChjb25zdHJ1Y3Rvci5kZWxldGVQcm9taXNlc0Zyb21DbGFzcykgewogICAgICAgICAgY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoY29uc3RydWN0b3IuYWRkUHJvbWlzZXNUb0NsYXNzKSB7CiAgICAgICAgY29uc3RydWN0b3IuYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KTsKICAgICAgfQogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZXR1cm4gYSBwcm9taXNlIHdob3NlIGZhdGUgaXMgZGVjaWRlZCBieSB0aGUKICAgKiBjYWxsYmFjayBiZWhhdmlvciBvZiB0aGUgZ2l2ZW4gbWV0aG9kIHdpdGggYG1ldGhvZE5hbWVgLiBUaGUgbWV0aG9kIHRvIGJlCiAgICogcHJvbWlzaWZpZWQgc2hvdWxkIGNvbmZvcm0gdG8gbm9kZS5qcyBjb252ZW50aW9uIG9mIGFjY2VwdGluZyBhIGNhbGxiYWNrIGFzCiAgICogbGFzdCBhcmd1bWVudCBhbmQgY2FsbGluZyB0aGF0IGNhbGxiYWNrIHdpdGggZXJyb3IgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CiAgICogYW5kIHN1Y2Nlc3MgdmFsdWUgb24gdGhlIHNlY29uZCBhcmd1bWVudC4KICAgKi8KICBwcm9taXNpZnlNZXRob2Q6IGZ1bmN0aW9uIHByb21pc2lmeU1ldGhvZChtZXRob2ROYW1lLCBQcm9taXNlRGVwZW5kZW5jeSkgewogICAgcmV0dXJuIGZ1bmN0aW9uIHByb21pc2UoKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICByZXR1cm4gbmV3IFByb21pc2VEZXBlbmRlbmN5KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGFyZ3MucHVzaChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHNlbGZbbWV0aG9kTmFtZV0uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgIH0pOwogICAgfTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpc0R1YWxzdGFja0F2YWlsYWJsZTogZnVuY3Rpb24gaXNEdWFsc3RhY2tBdmFpbGFibGUoc2VydmljZSkgewogICAgaWYgKCFzZXJ2aWNlKSByZXR1cm4gZmFsc2U7CiAgICB2YXIgbWV0YWRhdGEgPSByZXF1aXJlKCcuLi9hcGlzL21ldGFkYXRhLmpzb24nKTsKICAgIGlmICh0eXBlb2Ygc2VydmljZSAhPT0gJ3N0cmluZycpIHNlcnZpY2UgPSBzZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyOwogICAgaWYgKHR5cGVvZiBzZXJ2aWNlICE9PSAnc3RyaW5nJyB8fCAhbWV0YWRhdGEuaGFzT3duUHJvcGVydHkoc2VydmljZSkpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiAhIW1ldGFkYXRhW3NlcnZpY2VdLmR1YWxzdGFja0F2YWlsYWJsZTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjYWxjdWxhdGVSZXRyeURlbGF5OiBmdW5jdGlvbiBjYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHJldHJ5RGVsYXlPcHRpb25zLCBlcnIpIHsKICAgIGlmICghcmV0cnlEZWxheU9wdGlvbnMpIHJldHJ5RGVsYXlPcHRpb25zID0ge307CiAgICB2YXIgY3VzdG9tQmFja29mZiA9IHJldHJ5RGVsYXlPcHRpb25zLmN1c3RvbUJhY2tvZmYgfHwgbnVsbDsKICAgIGlmICh0eXBlb2YgY3VzdG9tQmFja29mZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gY3VzdG9tQmFja29mZihyZXRyeUNvdW50LCBlcnIpOwogICAgfQogICAgdmFyIGJhc2UgPSB0eXBlb2YgcmV0cnlEZWxheU9wdGlvbnMuYmFzZSA9PT0gJ251bWJlcicgPyByZXRyeURlbGF5T3B0aW9ucy5iYXNlIDogMTAwOwogICAgdmFyIGRlbGF5ID0gTWF0aC5yYW5kb20oKSAqIChNYXRoLnBvdygyLCByZXRyeUNvdW50KSAqIGJhc2UpOwogICAgcmV0dXJuIGRlbGF5OwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGhhbmRsZVJlcXVlc3RXaXRoUmV0cmllczogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdFdpdGhSZXRyaWVzKGh0dHBSZXF1ZXN0LCBvcHRpb25zLCBjYikgewogICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICB2YXIgaHR0cCA9IEFXUy5IdHRwQ2xpZW50LmdldEluc3RhbmNlKCk7CiAgICB2YXIgaHR0cE9wdGlvbnMgPSBvcHRpb25zLmh0dHBPcHRpb25zIHx8IHt9OwogICAgdmFyIHJldHJ5Q291bnQgPSAwOwoKICAgIHZhciBlcnJDYWxsYmFjayA9IGZ1bmN0aW9uKGVycikgewogICAgICB2YXIgbWF4UmV0cmllcyA9IG9wdGlvbnMubWF4UmV0cmllcyB8fCAwOwogICAgICBpZiAoZXJyICYmIGVyci5jb2RlID09PSAnVGltZW91dEVycm9yJykgZXJyLnJldHJ5YWJsZSA9IHRydWU7CgogICAgICAvLyBDYWxsIGBjYWxjdWxhdGVSZXRyeURlbGF5KClgIG9ubHkgd2hlbiByZWxldmFudCwgc2VlICMzNDAxCiAgICAgIGlmIChlcnIgJiYgZXJyLnJldHJ5YWJsZSAmJiByZXRyeUNvdW50IDwgbWF4UmV0cmllcykgewogICAgICAgIHZhciBkZWxheSA9IHV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCBvcHRpb25zLnJldHJ5RGVsYXlPcHRpb25zLCBlcnIpOwogICAgICAgIGlmIChkZWxheSA+PSAwKSB7CiAgICAgICAgICByZXRyeUNvdW50Kys7CiAgICAgICAgICBzZXRUaW1lb3V0KHNlbmRSZXF1ZXN0LCBkZWxheSArIChlcnIucmV0cnlBZnRlciB8fCAwKSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgICAgIGNiKGVycik7CiAgICB9OwoKICAgIHZhciBzZW5kUmVxdWVzdCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZGF0YSA9ICcnOwogICAgICBodHRwLmhhbmRsZVJlcXVlc3QoaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLCBmdW5jdGlvbihodHRwUmVzcG9uc2UpIHsKICAgICAgICBodHRwUmVzcG9uc2Uub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgeyBkYXRhICs9IGNodW5rLnRvU3RyaW5nKCk7IH0pOwogICAgICAgIGh0dHBSZXNwb25zZS5vbignZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcmV0cnlBZnRlciA9IHBhcnNlSW50KGh0dHBSZXNwb25zZS5oZWFkZXJzWydyZXRyeS1hZnRlciddLCAxMCkgKiAxMDAwIHx8IDA7CiAgICAgICAgICAgIHZhciBlcnIgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IHN0YXR1c0NvZGUsCiAgICAgICAgICAgICAgICByZXRyeWFibGU6IHN0YXR1c0NvZGUgPj0gNTAwIHx8IHN0YXR1c0NvZGUgPT09IDQyOQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKHJldHJ5QWZ0ZXIgJiYgZXJyLnJldHJ5YWJsZSkgZXJyLnJldHJ5QWZ0ZXIgPSByZXRyeUFmdGVyOwogICAgICAgICAgICBlcnJDYWxsYmFjayhlcnIpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LCBlcnJDYWxsYmFjayk7CiAgICB9OwoKICAgIEFXUy51dGlsLmRlZmVyKHNlbmRSZXF1ZXN0KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB1dWlkOiB7CiAgICB2NDogZnVuY3Rpb24gdXVpZFY0KCkgewogICAgICByZXR1cm4gcmVxdWlyZSgndXVpZCcpLnY0KCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY29udmVydFBheWxvYWRUb1N0cmluZzogZnVuY3Rpb24gY29udmVydFBheWxvYWRUb1N0cmluZyhyZXNwKSB7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5vcGVyYXRpb247CiAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgIGlmIChydWxlcy5wYXlsb2FkICYmIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSkgewogICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0udG9TdHJpbmcoKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBkZWZlcjogZnVuY3Rpb24gZGVmZXIoY2FsbGJhY2spIHsKICAgIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHByb2Nlc3MubmV4dFRpY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYWxsYmFjayk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgc2V0SW1tZWRpYXRlKGNhbGxiYWNrKTsKICAgIH0gZWxzZSB7CiAgICAgIHNldFRpbWVvdXQoY2FsbGJhY2ssIDApOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldFJlcXVlc3RQYXlsb2FkU2hhcGU6IGZ1bmN0aW9uIGdldFJlcXVlc3RQYXlsb2FkU2hhcGUocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zOwogICAgaWYgKCFvcGVyYXRpb25zKSByZXR1cm4gdW5kZWZpbmVkOwogICAgdmFyIG9wZXJhdGlvbiA9IChvcGVyYXRpb25zIHx8IHt9KVtyZXEub3BlcmF0aW9uXTsKICAgIGlmICghb3BlcmF0aW9uIHx8ICFvcGVyYXRpb24uaW5wdXQgfHwgIW9wZXJhdGlvbi5pbnB1dC5wYXlsb2FkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgcmV0dXJuIG9wZXJhdGlvbi5pbnB1dC5tZW1iZXJzW29wZXJhdGlvbi5pbnB1dC5wYXlsb2FkXTsKICB9LAoKICBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWc6IGZ1bmN0aW9uIGdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZyhpbmlMb2FkZXIsIGZpbGVuYW1lKSB7CiAgICB2YXIgcHJvZmlsZXMgPSB7fTsKICAgIHZhciBwcm9maWxlc0Zyb21Db25maWcgPSB7fTsKICAgIGlmIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSkgewogICAgICB2YXIgcHJvZmlsZXNGcm9tQ29uZmlnID0gaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICBpc0NvbmZpZzogdHJ1ZSwKICAgICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgICB9KTsKICAgIH0KICAgIHZhciBwcm9maWxlc0Zyb21DcmVkcz0ge307CiAgICB0cnkgewogICAgICB2YXIgcHJvZmlsZXNGcm9tQ3JlZHMgPSBpbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgIGZpbGVuYW1lOiBmaWxlbmFtZSB8fAogICAgICAgICAgKHByb2Nlc3MuZW52W3V0aWwuY29uZmlnT3B0SW5FbnZdICYmIHByb2Nlc3MuZW52W3V0aWwuc2hhcmVkQ3JlZGVudGlhbHNGaWxlRW52XSkKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAvLyBpZiB1c2luZyBjb25maWcsIGFzc3VtZSBpdCBpcyBmdWxseSBkZXNjcmlwdGl2ZSB3aXRob3V0IGEgY3JlZGVudGlhbHMgZmlsZToKICAgICAgaWYgKCFwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSkgdGhyb3cgZXJyb3I7CiAgICB9CiAgICBmb3IgKHZhciBpID0gMCwgcHJvZmlsZU5hbWVzID0gT2JqZWN0LmtleXMocHJvZmlsZXNGcm9tQ29uZmlnKTsgaSA8IHByb2ZpbGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICBwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dID0gb2JqZWN0QXNzaWduKHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gfHwge30sIHByb2ZpbGVzRnJvbUNvbmZpZ1twcm9maWxlTmFtZXNbaV1dKTsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwLCBwcm9maWxlTmFtZXMgPSBPYmplY3Qua2V5cyhwcm9maWxlc0Zyb21DcmVkcyk7IGkgPCBwcm9maWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSA9IG9iamVjdEFzc2lnbihwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dIHx8IHt9LCBwcm9maWxlc0Zyb21DcmVkc1twcm9maWxlTmFtZXNbaV1dKTsKICAgIH0KICAgIHJldHVybiBwcm9maWxlczsKCiAgICAvKioKICAgICAqIFJvdWdobHkgdGhlIHNlbWFudGljcyBvZiBgT2JqZWN0LmFzc2lnbih0YXJnZXQsIHNvdXJjZSlgCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9iamVjdEFzc2lnbih0YXJnZXQsIHNvdXJjZSkgewogICAgICBmb3IgKHZhciBpID0gMCwga2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGFyZ2V0W2tleXNbaV1dID0gc291cmNlW2tleXNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVJOOiB7CiAgICB2YWxpZGF0ZTogZnVuY3Rpb24gdmFsaWRhdGVBUk4oc3RyKSB7CiAgICAgIHJldHVybiBzdHIgJiYgc3RyLmluZGV4T2YoJ2FybjonKSA9PT0gMCAmJiBzdHIuc3BsaXQoJzonKS5sZW5ndGggPj0gNjsKICAgIH0sCiAgICBwYXJzZTogZnVuY3Rpb24gcGFyc2VBUk4oYXJuKSB7CiAgICAgIHZhciBtYXRjaGVkID0gYXJuLnNwbGl0KCc6Jyk7CiAgICAgIHJldHVybiB7CiAgICAgICAgcGFydGl0aW9uOiBtYXRjaGVkWzFdLAogICAgICAgIHNlcnZpY2U6IG1hdGNoZWRbMl0sCiAgICAgICAgcmVnaW9uOiBtYXRjaGVkWzNdLAogICAgICAgIGFjY291bnRJZDogbWF0Y2hlZFs0XSwKICAgICAgICByZXNvdXJjZTogbWF0Y2hlZC5zbGljZSg1KS5qb2luKCc6JykKICAgICAgfTsKICAgIH0sCiAgICBidWlsZDogZnVuY3Rpb24gYnVpbGRBUk4oYXJuT2JqZWN0KSB7CiAgICAgIGlmICgKICAgICAgICBhcm5PYmplY3Quc2VydmljZSA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgYXJuT2JqZWN0LnJlZ2lvbiA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgYXJuT2JqZWN0LmFjY291bnRJZCA9PT0gdW5kZWZpbmVkIHx8CiAgICAgICAgYXJuT2JqZWN0LnJlc291cmNlID09PSB1bmRlZmluZWQKICAgICAgKSB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignSW5wdXQgQVJOIG9iamVjdCBpcyBpbnZhbGlkJykpOwogICAgICByZXR1cm4gJ2FybjonKyAoYXJuT2JqZWN0LnBhcnRpdGlvbiB8fCAnYXdzJykgKyAnOicgKyBhcm5PYmplY3Quc2VydmljZSArCiAgICAgICAgJzonICsgYXJuT2JqZWN0LnJlZ2lvbiArICc6JyArIGFybk9iamVjdC5hY2NvdW50SWQgKyAnOicgKyBhcm5PYmplY3QucmVzb3VyY2U7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZGVmYXVsdFByb2ZpbGU6ICdkZWZhdWx0JywKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY29uZmlnT3B0SW5FbnY6ICdBV1NfU0RLX0xPQURfQ09ORklHJywKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2hhcmVkQ3JlZGVudGlhbHNGaWxlRW52OiAnQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFJywKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2hhcmVkQ29uZmlnRmlsZUVudjogJ0FXU19DT05GSUdfRklMRScsCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGltZHNEaXNhYmxlZEVudjogJ0FXU19FQzJfTUVUQURBVEFfRElTQUJMRUQnCn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHV0aWw7Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlKQp9LHsiLi4vYXBpcy9tZXRhZGF0YS5qc29uIjo0LCIuL2NvcmUiOjE5LCJfcHJvY2VzcyI6OTAsImZzIjo4MCwidGltZXJzIjo5NywidXVpZCI6MTAwfV0sNzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIFNoYXBlID0gcmVxdWlyZSgnLi4vbW9kZWwvc2hhcGUnKTsKCmZ1bmN0aW9uIERvbVhtbFBhcnNlcigpIHsgfQoKRG9tWG1sUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHhtbCwgc2hhcGUpIHsKICBpZiAoeG1sLnJlcGxhY2UoL15ccysvLCAnJykgPT09ICcnKSByZXR1cm4ge307CgogIHZhciByZXN1bHQsIGVycm9yOwogIHRyeSB7CiAgICBpZiAod2luZG93LkRPTVBhcnNlcikgewogICAgICB0cnkgewogICAgICAgIHZhciBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgcmVzdWx0ID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh4bWwsICd0ZXh0L3htbCcpOwogICAgICB9IGNhdGNoIChzeW50YXhFcnJvcikgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdQYXJzZSBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgewogICAgICAgICAgICBvcmlnaW5hbEVycm9yOiBzeW50YXhFcnJvciwKICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaWYgKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQgPT09IG51bGwpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IHBhcnNlIGVtcHR5IGRvY3VtZW50LicpLAogICAgICAgICAgewogICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICB9CgogICAgICB2YXIgaXNFcnJvciA9IHJlc3VsdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgncGFyc2VyZXJyb3InKVswXTsKICAgICAgaWYgKGlzRXJyb3IgJiYgKGlzRXJyb3IucGFyZW50Tm9kZSA9PT0gcmVzdWx0IHx8CiAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUubm9kZU5hbWUgPT09ICdib2R5JyB8fAogICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLnBhcmVudE5vZGUgPT09IHJlc3VsdCB8fAogICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLnBhcmVudE5vZGUubm9kZU5hbWUgPT09ICdib2R5JykpIHsKICAgICAgICB2YXIgZXJyb3JFbGVtZW50ID0gaXNFcnJvci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGl2JylbMF0gfHwgaXNFcnJvcjsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcihlcnJvckVsZW1lbnQudGV4dENvbnRlbnQgfHwgJ1BhcnNlciBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgewogICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB7CiAgICAgIHJlc3VsdCA9IG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTERPTScpOwogICAgICByZXN1bHQuYXN5bmMgPSBmYWxzZTsKCiAgICAgIGlmICghcmVzdWx0LmxvYWRYTUwoeG1sKSkgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdQYXJzZSBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgewogICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkIFhNTCBwYXJzZXInKTsKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICBlcnJvciA9IGU7CiAgfQoKICBpZiAocmVzdWx0ICYmIHJlc3VsdC5kb2N1bWVudEVsZW1lbnQgJiYgIWVycm9yKSB7CiAgICB2YXIgZGF0YSA9IHBhcnNlWG1sKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQsIHNoYXBlKTsKICAgIHZhciBtZXRhZGF0YSA9IGdldEVsZW1lbnRCeVRhZ05hbWUocmVzdWx0LmRvY3VtZW50RWxlbWVudCwgJ1Jlc3BvbnNlTWV0YWRhdGEnKTsKICAgIGlmIChtZXRhZGF0YSkgewogICAgICBkYXRhLlJlc3BvbnNlTWV0YWRhdGEgPSBwYXJzZVhtbChtZXRhZGF0YSwge30pOwogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfSBlbHNlIGlmIChlcnJvcikgewogICAgdGhyb3cgdXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwge2NvZGU6ICdYTUxQYXJzZXJFcnJvcicsIHJldHJ5YWJsZTogdHJ1ZX0pOwogIH0gZWxzZSB7IC8vIGVtcHR5IHhtbCBkb2N1bWVudAogICAgcmV0dXJuIHt9OwogIH0KfTsKCmZ1bmN0aW9uIGdldEVsZW1lbnRCeVRhZ05hbWUoeG1sLCB0YWcpIHsKICB2YXIgZWxlbWVudHMgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGVsZW1lbnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgaWYgKGVsZW1lbnRzW2ldLnBhcmVudE5vZGUgPT09IHhtbCkgewogICAgICByZXR1cm4gZWxlbWVudHNbaV07CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBwYXJzZVhtbCh4bWwsIHNoYXBlKSB7CiAgaWYgKCFzaGFwZSkgc2hhcGUgPSB7fTsKICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKTsKICAgIGNhc2UgJ21hcCc6IHJldHVybiBwYXJzZU1hcCh4bWwsIHNoYXBlKTsKICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gcGFyc2VMaXN0KHhtbCwgc2hhcGUpOwogICAgY2FzZSB1bmRlZmluZWQ6IGNhc2UgbnVsbDogcmV0dXJuIHBhcnNlVW5rbm93bih4bWwpOwogICAgZGVmYXVsdDogcmV0dXJuIHBhcnNlU2NhbGFyKHhtbCwgc2hhcGUpOwogIH0KfQoKZnVuY3Rpb24gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSkgewogIHZhciBkYXRhID0ge307CiAgaWYgKHhtbCA9PT0gbnVsbCkgcmV0dXJuIGRhdGE7CgogIHV0aWwuZWFjaChzaGFwZS5tZW1iZXJzLCBmdW5jdGlvbihtZW1iZXJOYW1lLCBtZW1iZXJTaGFwZSkgewogICAgaWYgKG1lbWJlclNoYXBlLmlzWG1sQXR0cmlidXRlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoeG1sLmF0dHJpYnV0ZXMsIG1lbWJlclNoYXBlLm5hbWUpKSB7CiAgICAgICAgdmFyIHZhbHVlID0geG1sLmF0dHJpYnV0ZXNbbWVtYmVyU2hhcGUubmFtZV0udmFsdWU7CiAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IHBhcnNlWG1sKHt0ZXh0Q29udGVudDogdmFsdWV9LCBtZW1iZXJTaGFwZSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciB4bWxDaGlsZCA9IG1lbWJlclNoYXBlLmZsYXR0ZW5lZCA/IHhtbCA6CiAgICAgICAgZ2V0RWxlbWVudEJ5VGFnTmFtZSh4bWwsIG1lbWJlclNoYXBlLm5hbWUpOwogICAgICBpZiAoeG1sQ2hpbGQpIHsKICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gcGFyc2VYbWwoeG1sQ2hpbGQsIG1lbWJlclNoYXBlKTsKICAgICAgfSBlbHNlIGlmICgKICAgICAgICAhbWVtYmVyU2hhcGUuZmxhdHRlbmVkICYmCiAgICAgICAgbWVtYmVyU2hhcGUudHlwZSA9PT0gJ2xpc3QnICYmCiAgICAgICAgIXNoYXBlLmFwaS54bWxOb0RlZmF1bHRMaXN0cykgewogICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBtZW1iZXJTaGFwZS5kZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgcmV0dXJuIGRhdGE7Cn0KCmZ1bmN0aW9uIHBhcnNlTWFwKHhtbCwgc2hhcGUpIHsKICB2YXIgZGF0YSA9IHt9OwogIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICB2YXIgeG1sVmFsdWUgPSBzaGFwZS52YWx1ZS5uYW1lIHx8ICd2YWx1ZSc7CiAgdmFyIHRhZ05hbWUgPSBzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogJ2VudHJ5JzsKCiAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogIHdoaWxlIChjaGlsZCkgewogICAgaWYgKGNoaWxkLm5vZGVOYW1lID09PSB0YWdOYW1lKSB7CiAgICAgIHZhciBrZXkgPSBnZXRFbGVtZW50QnlUYWdOYW1lKGNoaWxkLCB4bWxLZXkpLnRleHRDb250ZW50OwogICAgICB2YXIgdmFsdWUgPSBnZXRFbGVtZW50QnlUYWdOYW1lKGNoaWxkLCB4bWxWYWx1ZSk7CiAgICAgIGRhdGFba2V5XSA9IHBhcnNlWG1sKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICB9CiAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICB9CiAgcmV0dXJuIGRhdGE7Cn0KCmZ1bmN0aW9uIHBhcnNlTGlzdCh4bWwsIHNoYXBlKSB7CiAgdmFyIGRhdGEgPSBbXTsKICB2YXIgdGFnTmFtZSA9IHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAoc2hhcGUubWVtYmVyLm5hbWUgfHwgJ21lbWJlcicpOwoKICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgd2hpbGUgKGNoaWxkKSB7CiAgICBpZiAoY2hpbGQubm9kZU5hbWUgPT09IHRhZ05hbWUpIHsKICAgICAgZGF0YS5wdXNoKHBhcnNlWG1sKGNoaWxkLCBzaGFwZS5tZW1iZXIpKTsKICAgIH0KICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogIH0KICByZXR1cm4gZGF0YTsKfQoKZnVuY3Rpb24gcGFyc2VTY2FsYXIoeG1sLCBzaGFwZSkgewogIGlmICh4bWwuZ2V0QXR0cmlidXRlKSB7CiAgICB2YXIgZW5jb2RpbmcgPSB4bWwuZ2V0QXR0cmlidXRlKCdlbmNvZGluZycpOwogICAgaWYgKGVuY29kaW5nID09PSAnYmFzZTY0JykgewogICAgICBzaGFwZSA9IG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6IGVuY29kaW5nfSk7CiAgICB9CiAgfQoKICB2YXIgdGV4dCA9IHhtbC50ZXh0Q29udGVudDsKICBpZiAodGV4dCA9PT0gJycpIHRleHQgPSBudWxsOwogIGlmICh0eXBlb2Ygc2hhcGUudG9UeXBlID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm4gc2hhcGUudG9UeXBlKHRleHQpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdGV4dDsKICB9Cn0KCmZ1bmN0aW9uIHBhcnNlVW5rbm93bih4bWwpIHsKICBpZiAoeG1sID09PSB1bmRlZmluZWQgfHwgeG1sID09PSBudWxsKSByZXR1cm4gJyc7CgogIC8vIGVtcHR5IG9iamVjdAogIGlmICgheG1sLmZpcnN0RWxlbWVudENoaWxkKSB7CiAgICBpZiAoeG1sLnBhcmVudE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgcmV0dXJuIHt9OwogICAgaWYgKHhtbC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuICcnOwogICAgZWxzZSByZXR1cm4geG1sLnRleHRDb250ZW50OwogIH0KCiAgLy8gb2JqZWN0LCBwYXJzZSBhcyBzdHJ1Y3R1cmUKICB2YXIgc2hhcGUgPSB7dHlwZTogJ3N0cnVjdHVyZScsIG1lbWJlcnM6IHt9fTsKICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgd2hpbGUgKGNoaWxkKSB7CiAgICB2YXIgdGFnID0gY2hpbGQubm9kZU5hbWU7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNoYXBlLm1lbWJlcnMsIHRhZykpIHsKICAgICAgLy8gbXVsdGlwbGUgdGFncyBvZiB0aGUgc2FtZSBuYW1lIG1ha2VzIGl0IGEgbGlzdAogICAgICBzaGFwZS5tZW1iZXJzW3RhZ10udHlwZSA9ICdsaXN0JzsKICAgIH0gZWxzZSB7CiAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXSA9IHtuYW1lOiB0YWd9OwogICAgfQogICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgfQogIHJldHVybiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBEb21YbWxQYXJzZXI7Cgp9LHsiLi4vbW9kZWwvc2hhcGUiOjQ0LCIuLi91dGlsIjo3Mn1dLDc0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBYbWxOb2RlID0gcmVxdWlyZSgnLi94bWwtbm9kZScpLlhtbE5vZGU7CnZhciBYbWxUZXh0ID0gcmVxdWlyZSgnLi94bWwtdGV4dCcpLlhtbFRleHQ7CgpmdW5jdGlvbiBYbWxCdWlsZGVyKCkgeyB9CgpYbWxCdWlsZGVyLnByb3RvdHlwZS50b1hNTCA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIHJvb3RFbGVtZW50LCBub0VtcHR5KSB7CiAgdmFyIHhtbCA9IG5ldyBYbWxOb2RlKHJvb3RFbGVtZW50KTsKICBhcHBseU5hbWVzcGFjZXMoeG1sLCBzaGFwZSwgdHJ1ZSk7CiAgc2VyaWFsaXplKHhtbCwgcGFyYW1zLCBzaGFwZSk7CiAgcmV0dXJuIHhtbC5jaGlsZHJlbi5sZW5ndGggPiAwIHx8IG5vRW1wdHkgPyB4bWwudG9TdHJpbmcoKSA6ICcnOwp9OwoKZnVuY3Rpb24gc2VyaWFsaXplKHhtbCwgdmFsdWUsIHNoYXBlKSB7CiAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gc2VyaWFsaXplU3RydWN0dXJlKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgIGNhc2UgJ21hcCc6IHJldHVybiBzZXJpYWxpemVNYXAoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgY2FzZSAnbGlzdCc6IHJldHVybiBzZXJpYWxpemVMaXN0KHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgIGRlZmF1bHQ6IHJldHVybiBzZXJpYWxpemVTY2FsYXIoeG1sLCB2YWx1ZSwgc2hhcGUpOwogIH0KfQoKZnVuY3Rpb24gc2VyaWFsaXplU3RydWN0dXJlKHhtbCwgcGFyYW1zLCBzaGFwZSkgewogIHV0aWwuYXJyYXlFYWNoKHNoYXBlLm1lbWJlck5hbWVzLCBmdW5jdGlvbihtZW1iZXJOYW1lKSB7CiAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW21lbWJlck5hbWVdOwogICAgaWYgKG1lbWJlclNoYXBlLmxvY2F0aW9uICE9PSAnYm9keScpIHJldHVybjsKCiAgICB2YXIgdmFsdWUgPSBwYXJhbXNbbWVtYmVyTmFtZV07CiAgICB2YXIgbmFtZSA9IG1lbWJlclNoYXBlLm5hbWU7CiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICBpZiAobWVtYmVyU2hhcGUuaXNYbWxBdHRyaWJ1dGUpIHsKICAgICAgICB4bWwuYWRkQXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXJTaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgICBzZXJpYWxpemUoeG1sLCB2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgICBhcHBseU5hbWVzcGFjZXMoZWxlbWVudCwgbWVtYmVyU2hhcGUpOwogICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICB9CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZU1hcCh4bWwsIG1hcCwgc2hhcGUpIHsKICB2YXIgeG1sS2V5ID0gc2hhcGUua2V5Lm5hbWUgfHwgJ2tleSc7CiAgdmFyIHhtbFZhbHVlID0gc2hhcGUudmFsdWUubmFtZSB8fCAndmFsdWUnOwoKICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICB2YXIgZW50cnkgPSBuZXcgWG1sTm9kZShzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogJ2VudHJ5Jyk7CiAgICB4bWwuYWRkQ2hpbGROb2RlKGVudHJ5KTsKCiAgICB2YXIgZW50cnlLZXkgPSBuZXcgWG1sTm9kZSh4bWxLZXkpOwogICAgdmFyIGVudHJ5VmFsdWUgPSBuZXcgWG1sTm9kZSh4bWxWYWx1ZSk7CiAgICBlbnRyeS5hZGRDaGlsZE5vZGUoZW50cnlLZXkpOwogICAgZW50cnkuYWRkQ2hpbGROb2RlKGVudHJ5VmFsdWUpOwoKICAgIHNlcmlhbGl6ZShlbnRyeUtleSwga2V5LCBzaGFwZS5rZXkpOwogICAgc2VyaWFsaXplKGVudHJ5VmFsdWUsIHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZUxpc3QoeG1sLCBsaXN0LCBzaGFwZSkgewogIGlmIChzaGFwZS5mbGF0dGVuZWQpIHsKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciBuYW1lID0gc2hhcGUubWVtYmVyLm5hbWUgfHwgc2hhcGUubmFtZTsKICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciBuYW1lID0gc2hhcGUubWVtYmVyLm5hbWUgfHwgJ21lbWJlcic7CiAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gc2VyaWFsaXplU2NhbGFyKHhtbCwgdmFsdWUsIHNoYXBlKSB7CiAgeG1sLmFkZENoaWxkTm9kZSgKICAgIG5ldyBYbWxUZXh0KHNoYXBlLnRvV2lyZUZvcm1hdCh2YWx1ZSkpCiAgKTsKfQoKZnVuY3Rpb24gYXBwbHlOYW1lc3BhY2VzKHhtbCwgc2hhcGUsIGlzUm9vdCkgewogIHZhciB1cmksIHByZWZpeCA9ICd4bWxucyc7CiAgaWYgKHNoYXBlLnhtbE5hbWVzcGFjZVVyaSkgewogICAgdXJpID0gc2hhcGUueG1sTmFtZXNwYWNlVXJpOwogICAgaWYgKHNoYXBlLnhtbE5hbWVzcGFjZVByZWZpeCkgcHJlZml4ICs9ICc6JyArIHNoYXBlLnhtbE5hbWVzcGFjZVByZWZpeDsKICB9IGVsc2UgaWYgKGlzUm9vdCAmJiBzaGFwZS5hcGkueG1sTmFtZXNwYWNlVXJpKSB7CiAgICB1cmkgPSBzaGFwZS5hcGkueG1sTmFtZXNwYWNlVXJpOwogIH0KCiAgaWYgKHVyaSkgeG1sLmFkZEF0dHJpYnV0ZShwcmVmaXgsIHVyaSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gWG1sQnVpbGRlcjsKCn0seyIuLi91dGlsIjo3MiwiLi94bWwtbm9kZSI6NzcsIi4veG1sLXRleHQiOjc4fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogRXNjYXBlcyBjaGFyYWN0ZXJzIHRoYXQgY2FuIG5vdCBiZSBpbiBhbiBYTUwgYXR0cmlidXRlLgogKi8KZnVuY3Rpb24gZXNjYXBlQXR0cmlidXRlKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC8nL2csICcmYXBvczsnKS5yZXBsYWNlKC88L2csICcmbHQ7JykucmVwbGFjZSgvPi9nLCAnJmd0OycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIGVzY2FwZUF0dHJpYnV0ZTogZXNjYXBlQXR0cmlidXRlCn07Cgp9LHt9XSw3NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBFc2NhcGVzIGNoYXJhY3RlcnMgdGhhdCBjYW4gbm90IGJlIGluIGFuIFhNTCBlbGVtZW50LgogKi8KZnVuY3Rpb24gZXNjYXBlRWxlbWVudCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoLyYvZywgJyZhbXA7JykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC88L2csICcmbHQ7JykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8+L2csICcmZ3Q7JykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cci9nLCAnJiN4MEQ7JykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cbi9nLCAnJiN4MEE7JykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cdTAwODUvZywgJyYjeDg1OycpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHUyMDI4LywgJyYjeDIwMjg7Jyk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgZXNjYXBlRWxlbWVudDogZXNjYXBlRWxlbWVudAp9OwoKfSx7fV0sNzc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgZXNjYXBlQXR0cmlidXRlID0gcmVxdWlyZSgnLi9lc2NhcGUtYXR0cmlidXRlJykuZXNjYXBlQXR0cmlidXRlOwoKLyoqCiAqIFJlcHJlc2VudHMgYW4gWE1MIG5vZGUuCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gWG1sTm9kZShuYW1lLCBjaGlsZHJlbikgewogICAgaWYgKGNoaWxkcmVuID09PSB2b2lkIDApIHsgY2hpbGRyZW4gPSBbXTsgfQogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9Owp9ClhtbE5vZGUucHJvdG90eXBlLmFkZEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgdGhpcy5hdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7CiAgICByZXR1cm4gdGhpczsKfTsKWG1sTm9kZS5wcm90b3R5cGUuYWRkQ2hpbGROb2RlID0gZnVuY3Rpb24gKGNoaWxkKSB7CiAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgcmV0dXJuIHRoaXM7Cn07ClhtbE5vZGUucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICBkZWxldGUgdGhpcy5hdHRyaWJ1dGVzW25hbWVdOwogICAgcmV0dXJuIHRoaXM7Cn07ClhtbE5vZGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGhhc0NoaWxkcmVuID0gQm9vbGVhbih0aGlzLmNoaWxkcmVuLmxlbmd0aCk7CiAgICB2YXIgeG1sVGV4dCA9ICc8JyArIHRoaXMubmFtZTsKICAgIC8vIGFkZCBhdHRyaWJ1dGVzCiAgICB2YXIgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKICAgIGZvciAodmFyIGkgPSAwLCBhdHRyaWJ1dGVOYW1lcyA9IE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpOyBpIDwgYXR0cmlidXRlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWVzW2ldOwogICAgICAgIHZhciBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZU5hbWVdOwogICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlICE9PSAndW5kZWZpbmVkJyAmJiBhdHRyaWJ1dGUgIT09IG51bGwpIHsKICAgICAgICAgICAgeG1sVGV4dCArPSAnICcgKyBhdHRyaWJ1dGVOYW1lICsgJz1cIicgKyBlc2NhcGVBdHRyaWJ1dGUoJycgKyBhdHRyaWJ1dGUpICsgJ1wiJzsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4geG1sVGV4dCArPSAhaGFzQ2hpbGRyZW4gPyAnLz4nIDogJz4nICsgdGhpcy5jaGlsZHJlbi5tYXAoZnVuY3Rpb24gKGMpIHsgcmV0dXJuIGMudG9TdHJpbmcoKTsgfSkuam9pbignJykgKyAnPC8nICsgdGhpcy5uYW1lICsgJz4nOwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBYbWxOb2RlOiBYbWxOb2RlCn07Cgp9LHsiLi9lc2NhcGUtYXR0cmlidXRlIjo3NX1dLDc4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGVzY2FwZUVsZW1lbnQgPSByZXF1aXJlKCcuL2VzY2FwZS1lbGVtZW50JykuZXNjYXBlRWxlbWVudDsKCi8qKgogKiBSZXByZXNlbnRzIGFuIFhNTCB0ZXh0IHZhbHVlLgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIFhtbFRleHQodmFsdWUpIHsKICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKfQoKWG1sVGV4dC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gZXNjYXBlRWxlbWVudCgnJyArIHRoaXMudmFsdWUpOwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBYbWxUZXh0OiBYbWxUZXh0Cn07Cgp9LHsiLi9lc2NhcGUtZWxlbWVudCI6NzZ9XSw3OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JwoKZXhwb3J0cy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aApleHBvcnRzLnRvQnl0ZUFycmF5ID0gdG9CeXRlQXJyYXkKZXhwb3J0cy5mcm9tQnl0ZUFycmF5ID0gZnJvbUJ5dGVBcnJheQoKdmFyIGxvb2t1cCA9IFtdCnZhciByZXZMb29rdXAgPSBbXQp2YXIgQXJyID0gdHlwZW9mIFVpbnQ4QXJyYXkgIT09ICd1bmRlZmluZWQnID8gVWludDhBcnJheSA6IEFycmF5Cgp2YXIgY29kZSA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvJwpmb3IgKHZhciBpID0gMCwgbGVuID0gY29kZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogIGxvb2t1cFtpXSA9IGNvZGVbaV0KICByZXZMb29rdXBbY29kZS5jaGFyQ29kZUF0KGkpXSA9IGkKfQoKLy8gU3VwcG9ydCBkZWNvZGluZyBVUkwtc2FmZSBiYXNlNjQgc3RyaW5ncywgYXMgTm9kZS5qcyBkb2VzLgovLyBTZWU6IGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Jhc2U2NCNVUkxfYXBwbGljYXRpb25zCnJldkxvb2t1cFsnLScuY2hhckNvZGVBdCgwKV0gPSA2MgpyZXZMb29rdXBbJ18nLmNoYXJDb2RlQXQoMCldID0gNjMKCmZ1bmN0aW9uIGdldExlbnMgKGI2NCkgewogIHZhciBsZW4gPSBiNjQubGVuZ3RoCgogIGlmIChsZW4gJSA0ID4gMCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0JykKICB9CgogIC8vIFRyaW0gb2ZmIGV4dHJhIGJ5dGVzIGFmdGVyIHBsYWNlaG9sZGVyIGJ5dGVzIGFyZSBmb3VuZAogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2JlYXRnYW1taXQvYmFzZTY0LWpzL2lzc3Vlcy80MgogIHZhciB2YWxpZExlbiA9IGI2NC5pbmRleE9mKCc9JykKICBpZiAodmFsaWRMZW4gPT09IC0xKSB2YWxpZExlbiA9IGxlbgoKICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gdmFsaWRMZW4gPT09IGxlbgogICAgPyAwCiAgICA6IDQgLSAodmFsaWRMZW4gJSA0KQoKICByZXR1cm4gW3ZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW5dCn0KCi8vIGJhc2U2NCBpcyA0LzMgKyB1cCB0byB0d28gY2hhcmFjdGVycyBvZiB0aGUgb3JpZ2luYWwgZGF0YQpmdW5jdGlvbiBieXRlTGVuZ3RoIChiNjQpIHsKICB2YXIgbGVucyA9IGdldExlbnMoYjY0KQogIHZhciB2YWxpZExlbiA9IGxlbnNbMF0KICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXQogIHJldHVybiAoKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0KSAtIHBsYWNlSG9sZGVyc0xlbgp9CgpmdW5jdGlvbiBfYnl0ZUxlbmd0aCAoYjY0LCB2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuKSB7CiAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCn0KCmZ1bmN0aW9uIHRvQnl0ZUFycmF5IChiNjQpIHsKICB2YXIgdG1wCiAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCkKICB2YXIgdmFsaWRMZW4gPSBsZW5zWzBdCiAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IGxlbnNbMV0KCiAgdmFyIGFyciA9IG5ldyBBcnIoX2J5dGVMZW5ndGgoYjY0LCB2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuKSkKCiAgdmFyIGN1ckJ5dGUgPSAwCgogIC8vIGlmIHRoZXJlIGFyZSBwbGFjZWhvbGRlcnMsIG9ubHkgZ2V0IHVwIHRvIHRoZSBsYXN0IGNvbXBsZXRlIDQgY2hhcnMKICB2YXIgbGVuID0gcGxhY2VIb2xkZXJzTGVuID4gMAogICAgPyB2YWxpZExlbiAtIDQKICAgIDogdmFsaWRMZW4KCiAgdmFyIGkKICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpICs9IDQpIHsKICAgIHRtcCA9CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDE4KSB8CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCAxMikgfAogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPDwgNikgfAogICAgICByZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDMpXQogICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDE2KSAmIDB4RkYKICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiA4KSAmIDB4RkYKICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogIH0KCiAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMikgewogICAgdG1wID0KICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMikgfAogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPj4gNCkKICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogIH0KCiAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMSkgewogICAgdG1wID0KICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMTApIHwKICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDQpIHwKICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildID4+IDIpCiAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gOCkgJiAweEZGCiAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICB9CgogIHJldHVybiBhcnIKfQoKZnVuY3Rpb24gdHJpcGxldFRvQmFzZTY0IChudW0pIHsKICByZXR1cm4gbG9va3VwW251bSA+PiAxOCAmIDB4M0ZdICsKICAgIGxvb2t1cFtudW0gPj4gMTIgJiAweDNGXSArCiAgICBsb29rdXBbbnVtID4+IDYgJiAweDNGXSArCiAgICBsb29rdXBbbnVtICYgMHgzRl0KfQoKZnVuY3Rpb24gZW5jb2RlQ2h1bmsgKHVpbnQ4LCBzdGFydCwgZW5kKSB7CiAgdmFyIHRtcAogIHZhciBvdXRwdXQgPSBbXQogIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgaSArPSAzKSB7CiAgICB0bXAgPQogICAgICAoKHVpbnQ4W2ldIDw8IDE2KSAmIDB4RkYwMDAwKSArCiAgICAgICgodWludDhbaSArIDFdIDw8IDgpICYgMHhGRjAwKSArCiAgICAgICh1aW50OFtpICsgMl0gJiAweEZGKQogICAgb3V0cHV0LnB1c2godHJpcGxldFRvQmFzZTY0KHRtcCkpCiAgfQogIHJldHVybiBvdXRwdXQuam9pbignJykKfQoKZnVuY3Rpb24gZnJvbUJ5dGVBcnJheSAodWludDgpIHsKICB2YXIgdG1wCiAgdmFyIGxlbiA9IHVpbnQ4Lmxlbmd0aAogIHZhciBleHRyYUJ5dGVzID0gbGVuICUgMyAvLyBpZiB3ZSBoYXZlIDEgYnl0ZSBsZWZ0LCBwYWQgMiBieXRlcwogIHZhciBwYXJ0cyA9IFtdCiAgdmFyIG1heENodW5rTGVuZ3RoID0gMTYzODMgLy8gbXVzdCBiZSBtdWx0aXBsZSBvZiAzCgogIC8vIGdvIHRocm91Z2ggdGhlIGFycmF5IGV2ZXJ5IHRocmVlIGJ5dGVzLCB3ZSdsbCBkZWFsIHdpdGggdHJhaWxpbmcgc3R1ZmYgbGF0ZXIKICBmb3IgKHZhciBpID0gMCwgbGVuMiA9IGxlbiAtIGV4dHJhQnl0ZXM7IGkgPCBsZW4yOyBpICs9IG1heENodW5rTGVuZ3RoKSB7CiAgICBwYXJ0cy5wdXNoKGVuY29kZUNodW5rKHVpbnQ4LCBpLCAoaSArIG1heENodW5rTGVuZ3RoKSA+IGxlbjIgPyBsZW4yIDogKGkgKyBtYXhDaHVua0xlbmd0aCkpKQogIH0KCiAgLy8gcGFkIHRoZSBlbmQgd2l0aCB6ZXJvcywgYnV0IG1ha2Ugc3VyZSB0byBub3QgZm9yZ2V0IHRoZSBleHRyYSBieXRlcwogIGlmIChleHRyYUJ5dGVzID09PSAxKSB7CiAgICB0bXAgPSB1aW50OFtsZW4gLSAxXQogICAgcGFydHMucHVzaCgKICAgICAgbG9va3VwW3RtcCA+PiAyXSArCiAgICAgIGxvb2t1cFsodG1wIDw8IDQpICYgMHgzRl0gKwogICAgICAnPT0nCiAgICApCiAgfSBlbHNlIGlmIChleHRyYUJ5dGVzID09PSAyKSB7CiAgICB0bXAgPSAodWludDhbbGVuIC0gMl0gPDwgOCkgKyB1aW50OFtsZW4gLSAxXQogICAgcGFydHMucHVzaCgKICAgICAgbG9va3VwW3RtcCA+PiAxMF0gKwogICAgICBsb29rdXBbKHRtcCA+PiA0KSAmIDB4M0ZdICsKICAgICAgbG9va3VwWyh0bXAgPDwgMikgJiAweDNGXSArCiAgICAgICc9JwogICAgKQogIH0KCiAgcmV0dXJuIHBhcnRzLmpvaW4oJycpCn0KCn0se31dLDgwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKCn0se31dLDgxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKaWYgKHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgLy8gaW1wbGVtZW50YXRpb24gZnJvbSBzdGFuZGFyZCBub2RlLmpzICd1dGlsJyBtb2R1bGUKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgIGN0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckN0b3IucHJvdG90eXBlLCB7CiAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgdmFsdWU6IGN0b3IsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0KICAgIH0pOwogIH07Cn0gZWxzZSB7CiAgLy8gb2xkIHNjaG9vbCBzaGltIGZvciBvbGQgYnJvd3NlcnMKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgIHZhciBUZW1wQ3RvciA9IGZ1bmN0aW9uICgpIHt9CiAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlCiAgICBjdG9yLnByb3RvdHlwZSA9IG5ldyBUZW1wQ3RvcigpCiAgICBjdG9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGN0b3IKICB9Cn0KCn0se31dLDgyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChnbG9iYWwpeyhmdW5jdGlvbiAoKXsKLyohIGh0dHBzOi8vbXRocy5iZS9wdW55Y29kZSB2MS4zLjIgYnkgQG1hdGhpYXMgKi8KOyhmdW5jdGlvbihyb290KSB7CgoJLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlcyAqLwoJdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0cyAmJgoJCSFleHBvcnRzLm5vZGVUeXBlICYmIGV4cG9ydHM7Cgl2YXIgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gJ29iamVjdCcgJiYgbW9kdWxlICYmCgkJIW1vZHVsZS5ub2RlVHlwZSAmJiBtb2R1bGU7Cgl2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsOwoJaWYgKAoJCWZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8CgkJZnJlZUdsb2JhbC53aW5kb3cgPT09IGZyZWVHbG9iYWwgfHwKCQlmcmVlR2xvYmFsLnNlbGYgPT09IGZyZWVHbG9iYWwKCSkgewoJCXJvb3QgPSBmcmVlR2xvYmFsOwoJfQoKCS8qKgoJICogVGhlIGBwdW55Y29kZWAgb2JqZWN0LgoJICogQG5hbWUgcHVueWNvZGUKCSAqIEB0eXBlIE9iamVjdAoJICovCgl2YXIgcHVueWNvZGUsCgoJLyoqIEhpZ2hlc3QgcG9zaXRpdmUgc2lnbmVkIDMyLWJpdCBmbG9hdCB2YWx1ZSAqLwoJbWF4SW50ID0gMjE0NzQ4MzY0NywgLy8gYWthLiAweDdGRkZGRkZGIG9yIDJeMzEtMQoKCS8qKiBCb290c3RyaW5nIHBhcmFtZXRlcnMgKi8KCWJhc2UgPSAzNiwKCXRNaW4gPSAxLAoJdE1heCA9IDI2LAoJc2tldyA9IDM4LAoJZGFtcCA9IDcwMCwKCWluaXRpYWxCaWFzID0gNzIsCglpbml0aWFsTiA9IDEyOCwgLy8gMHg4MAoJZGVsaW1pdGVyID0gJy0nLCAvLyAnXHgyRCcKCgkvKiogUmVndWxhciBleHByZXNzaW9ucyAqLwoJcmVnZXhQdW55Y29kZSA9IC9eeG4tLS8sCglyZWdleE5vbkFTQ0lJID0gL1teXHgyMC1ceDdFXS8sIC8vIHVucHJpbnRhYmxlIEFTQ0lJIGNoYXJzICsgbm9uLUFTQ0lJIGNoYXJzCglyZWdleFNlcGFyYXRvcnMgPSAvW1x4MkVcdTMwMDJcdUZGMEVcdUZGNjFdL2csIC8vIFJGQyAzNDkwIHNlcGFyYXRvcnMKCgkvKiogRXJyb3IgbWVzc2FnZXMgKi8KCWVycm9ycyA9IHsKCQknb3ZlcmZsb3cnOiAnT3ZlcmZsb3c6IGlucHV0IG5lZWRzIHdpZGVyIGludGVnZXJzIHRvIHByb2Nlc3MnLAoJCSdub3QtYmFzaWMnOiAnSWxsZWdhbCBpbnB1dCA+PSAweDgwIChub3QgYSBiYXNpYyBjb2RlIHBvaW50KScsCgkJJ2ludmFsaWQtaW5wdXQnOiAnSW52YWxpZCBpbnB1dCcKCX0sCgoJLyoqIENvbnZlbmllbmNlIHNob3J0Y3V0cyAqLwoJYmFzZU1pbnVzVE1pbiA9IGJhc2UgLSB0TWluLAoJZmxvb3IgPSBNYXRoLmZsb29yLAoJc3RyaW5nRnJvbUNoYXJDb2RlID0gU3RyaW5nLmZyb21DaGFyQ29kZSwKCgkvKiogVGVtcG9yYXJ5IHZhcmlhYmxlICovCglrZXk7CgoJLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoJLyoqCgkgKiBBIGdlbmVyaWMgZXJyb3IgdXRpbGl0eSBmdW5jdGlvbi4KCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXJyb3IgdHlwZS4KCSAqIEByZXR1cm5zIHtFcnJvcn0gVGhyb3dzIGEgYFJhbmdlRXJyb3JgIHdpdGggdGhlIGFwcGxpY2FibGUgZXJyb3IgbWVzc2FnZS4KCSAqLwoJZnVuY3Rpb24gZXJyb3IodHlwZSkgewoJCXRocm93IFJhbmdlRXJyb3IoZXJyb3JzW3R5cGVdKTsKCX0KCgkvKioKCSAqIEEgZ2VuZXJpYyBgQXJyYXkjbWFwYCB1dGlsaXR5IGZ1bmN0aW9uLgoJICogQHByaXZhdGUKCSAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkgYXJyYXkKCSAqIGl0ZW0uCgkgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IGFycmF5IG9mIHZhbHVlcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24uCgkgKi8KCWZ1bmN0aW9uIG1hcChhcnJheSwgZm4pIHsKCQl2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoJCXZhciByZXN1bHQgPSBbXTsKCQl3aGlsZSAobGVuZ3RoLS0pIHsKCQkJcmVzdWx0W2xlbmd0aF0gPSBmbihhcnJheVtsZW5ndGhdKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0KCgkvKioKCSAqIEEgc2ltcGxlIGBBcnJheSNtYXBgLWxpa2Ugd3JhcHBlciB0byB3b3JrIHdpdGggZG9tYWluIG5hbWUgc3RyaW5ncyBvciBlbWFpbAoJICogYWRkcmVzc2VzLgoJICogQHByaXZhdGUKCSAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MuCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkKCSAqIGNoYXJhY3Rlci4KCSAqIEByZXR1cm5zIHtBcnJheX0gQSBuZXcgc3RyaW5nIG9mIGNoYXJhY3RlcnMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrCgkgKiBmdW5jdGlvbi4KCSAqLwoJZnVuY3Rpb24gbWFwRG9tYWluKHN0cmluZywgZm4pIHsKCQl2YXIgcGFydHMgPSBzdHJpbmcuc3BsaXQoJ0AnKTsKCQl2YXIgcmVzdWx0ID0gJyc7CgkJaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJLy8gSW4gZW1haWwgYWRkcmVzc2VzLCBvbmx5IHRoZSBkb21haW4gbmFtZSBzaG91bGQgYmUgcHVueWNvZGVkLiBMZWF2ZQoJCQkvLyB0aGUgbG9jYWwgcGFydCAoaS5lLiBldmVyeXRoaW5nIHVwIHRvIGBAYCkgaW50YWN0LgoJCQlyZXN1bHQgPSBwYXJ0c1swXSArICdAJzsKCQkJc3RyaW5nID0gcGFydHNbMV07CgkJfQoJCS8vIEF2b2lkIGBzcGxpdChyZWdleClgIGZvciBJRTggY29tcGF0aWJpbGl0eS4gU2VlICMxNy4KCQlzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShyZWdleFNlcGFyYXRvcnMsICdceDJFJyk7CgkJdmFyIGxhYmVscyA9IHN0cmluZy5zcGxpdCgnLicpOwoJCXZhciBlbmNvZGVkID0gbWFwKGxhYmVscywgZm4pLmpvaW4oJy4nKTsKCQlyZXR1cm4gcmVzdWx0ICsgZW5jb2RlZDsKCX0KCgkvKioKCSAqIENyZWF0ZXMgYW4gYXJyYXkgY29udGFpbmluZyB0aGUgbnVtZXJpYyBjb2RlIHBvaW50cyBvZiBlYWNoIFVuaWNvZGUKCSAqIGNoYXJhY3RlciBpbiB0aGUgc3RyaW5nLiBXaGlsZSBKYXZhU2NyaXB0IHVzZXMgVUNTLTIgaW50ZXJuYWxseSwKCSAqIHRoaXMgZnVuY3Rpb24gd2lsbCBjb252ZXJ0IGEgcGFpciBvZiBzdXJyb2dhdGUgaGFsdmVzIChlYWNoIG9mIHdoaWNoCgkgKiBVQ1MtMiBleHBvc2VzIGFzIHNlcGFyYXRlIGNoYXJhY3RlcnMpIGludG8gYSBzaW5nbGUgY29kZSBwb2ludCwKCSAqIG1hdGNoaW5nIFVURi0xNi4KCSAqIEBzZWUgYHB1bnljb2RlLnVjczIuZW5jb2RlYAoJICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CgkgKiBAbWVtYmVyT2YgcHVueWNvZGUudWNzMgoJICogQG5hbWUgZGVjb2RlCgkgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBVbmljb2RlIGlucHV0IHN0cmluZyAoVUNTLTIpLgoJICogQHJldHVybnMge0FycmF5fSBUaGUgbmV3IGFycmF5IG9mIGNvZGUgcG9pbnRzLgoJICovCglmdW5jdGlvbiB1Y3MyZGVjb2RlKHN0cmluZykgewoJCXZhciBvdXRwdXQgPSBbXSwKCQkgICAgY291bnRlciA9IDAsCgkJICAgIGxlbmd0aCA9IHN0cmluZy5sZW5ndGgsCgkJICAgIHZhbHVlLAoJCSAgICBleHRyYTsKCQl3aGlsZSAoY291bnRlciA8IGxlbmd0aCkgewoJCQl2YWx1ZSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CgkJCWlmICh2YWx1ZSA+PSAweEQ4MDAgJiYgdmFsdWUgPD0gMHhEQkZGICYmIGNvdW50ZXIgPCBsZW5ndGgpIHsKCQkJCS8vIGhpZ2ggc3Vycm9nYXRlLCBhbmQgdGhlcmUgaXMgYSBuZXh0IGNoYXJhY3RlcgoJCQkJZXh0cmEgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwoJCQkJaWYgKChleHRyYSAmIDB4RkMwMCkgPT0gMHhEQzAwKSB7IC8vIGxvdyBzdXJyb2dhdGUKCQkJCQlvdXRwdXQucHVzaCgoKHZhbHVlICYgMHgzRkYpIDw8IDEwKSArIChleHRyYSAmIDB4M0ZGKSArIDB4MTAwMDApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB1bm1hdGNoZWQgc3Vycm9nYXRlOyBvbmx5IGFwcGVuZCB0aGlzIGNvZGUgdW5pdCwgaW4gY2FzZSB0aGUgbmV4dAoJCQkJCS8vIGNvZGUgdW5pdCBpcyB0aGUgaGlnaCBzdXJyb2dhdGUgb2YgYSBzdXJyb2dhdGUgcGFpcgoJCQkJCW91dHB1dC5wdXNoKHZhbHVlKTsKCQkJCQljb3VudGVyLS07CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlvdXRwdXQucHVzaCh2YWx1ZSk7CgkJCX0KCQl9CgkJcmV0dXJuIG91dHB1dDsKCX0KCgkvKioKCSAqIENyZWF0ZXMgYSBzdHJpbmcgYmFzZWQgb24gYW4gYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KCSAqIEBzZWUgYHB1bnljb2RlLnVjczIuZGVjb2RlYAoJICogQG1lbWJlck9mIHB1bnljb2RlLnVjczIKCSAqIEBuYW1lIGVuY29kZQoJICogQHBhcmFtIHtBcnJheX0gY29kZVBvaW50cyBUaGUgYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KCSAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBuZXcgVW5pY29kZSBzdHJpbmcgKFVDUy0yKS4KCSAqLwoJZnVuY3Rpb24gdWNzMmVuY29kZShhcnJheSkgewoJCXJldHVybiBtYXAoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKSB7CgkJCXZhciBvdXRwdXQgPSAnJzsKCQkJaWYgKHZhbHVlID4gMHhGRkZGKSB7CgkJCQl2YWx1ZSAtPSAweDEwMDAwOwoJCQkJb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCk7CgkJCQl2YWx1ZSA9IDB4REMwMCB8IHZhbHVlICYgMHgzRkY7CgkJCX0KCQkJb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfSkuam9pbignJyk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIGJhc2ljIGNvZGUgcG9pbnQgaW50byBhIGRpZ2l0L2ludGVnZXIuCgkgKiBAc2VlIGBkaWdpdFRvQmFzaWMoKWAKCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge051bWJlcn0gY29kZVBvaW50IFRoZSBiYXNpYyBudW1lcmljIGNvZGUgcG9pbnQgdmFsdWUuCgkgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQgKGZvciB1c2UgaW4KCSAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaW4gdGhlIHJhbmdlIGAwYCB0byBgYmFzZSAtIDFgLCBvciBgYmFzZWAgaWYKCSAqIHRoZSBjb2RlIHBvaW50IGRvZXMgbm90IHJlcHJlc2VudCBhIHZhbHVlLgoJICovCglmdW5jdGlvbiBiYXNpY1RvRGlnaXQoY29kZVBvaW50KSB7CgkJaWYgKGNvZGVQb2ludCAtIDQ4IDwgMTApIHsKCQkJcmV0dXJuIGNvZGVQb2ludCAtIDIyOwoJCX0KCQlpZiAoY29kZVBvaW50IC0gNjUgPCAyNikgewoJCQlyZXR1cm4gY29kZVBvaW50IC0gNjU7CgkJfQoJCWlmIChjb2RlUG9pbnQgLSA5NyA8IDI2KSB7CgkJCXJldHVybiBjb2RlUG9pbnQgLSA5NzsKCQl9CgkJcmV0dXJuIGJhc2U7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIGRpZ2l0L2ludGVnZXIgaW50byBhIGJhc2ljIGNvZGUgcG9pbnQuCgkgKiBAc2VlIGBiYXNpY1RvRGlnaXQoKWAKCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge051bWJlcn0gZGlnaXQgVGhlIG51bWVyaWMgdmFsdWUgb2YgYSBiYXNpYyBjb2RlIHBvaW50LgoJICogQHJldHVybnMge051bWJlcn0gVGhlIGJhc2ljIGNvZGUgcG9pbnQgd2hvc2UgdmFsdWUgKHdoZW4gdXNlZCBmb3IKCSAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaXMgYGRpZ2l0YCwgd2hpY2ggbmVlZHMgdG8gYmUgaW4gdGhlIHJhbmdlCgkgKiBgMGAgdG8gYGJhc2UgLSAxYC4gSWYgYGZsYWdgIGlzIG5vbi16ZXJvLCB0aGUgdXBwZXJjYXNlIGZvcm0gaXMKCSAqIHVzZWQ7IGVsc2UsIHRoZSBsb3dlcmNhc2UgZm9ybSBpcyB1c2VkLiBUaGUgYmVoYXZpb3IgaXMgdW5kZWZpbmVkCgkgKiBpZiBgZmxhZ2AgaXMgbm9uLXplcm8gYW5kIGBkaWdpdGAgaGFzIG5vIHVwcGVyY2FzZSBmb3JtLgoJICovCglmdW5jdGlvbiBkaWdpdFRvQmFzaWMoZGlnaXQsIGZsYWcpIHsKCQkvLyAgMC4uMjUgbWFwIHRvIEFTQ0lJIGEuLnogb3IgQS4uWgoJCS8vIDI2Li4zNSBtYXAgdG8gQVNDSUkgMC4uOQoJCXJldHVybiBkaWdpdCArIDIyICsgNzUgKiAoZGlnaXQgPCAyNikgLSAoKGZsYWcgIT0gMCkgPDwgNSk7Cgl9CgoJLyoqCgkgKiBCaWFzIGFkYXB0YXRpb24gZnVuY3Rpb24gYXMgcGVyIHNlY3Rpb24gMy40IG9mIFJGQyAzNDkyLgoJICogaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzQ5MiNzZWN0aW9uLTMuNAoJICogQHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gYWRhcHQoZGVsdGEsIG51bVBvaW50cywgZmlyc3RUaW1lKSB7CgkJdmFyIGsgPSAwOwoJCWRlbHRhID0gZmlyc3RUaW1lID8gZmxvb3IoZGVsdGEgLyBkYW1wKSA6IGRlbHRhID4+IDE7CgkJZGVsdGEgKz0gZmxvb3IoZGVsdGEgLyBudW1Qb2ludHMpOwoJCWZvciAoLyogbm8gaW5pdGlhbGl6YXRpb24gKi87IGRlbHRhID4gYmFzZU1pbnVzVE1pbiAqIHRNYXggPj4gMTsgayArPSBiYXNlKSB7CgkJCWRlbHRhID0gZmxvb3IoZGVsdGEgLyBiYXNlTWludXNUTWluKTsKCQl9CgkJcmV0dXJuIGZsb29yKGsgKyAoYmFzZU1pbnVzVE1pbiArIDEpICogZGVsdGEgLyAoZGVsdGEgKyBza2V3KSk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMgdG8gYSBzdHJpbmcgb2YgVW5pY29kZQoJICogc3ltYm9scy4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgoJICovCglmdW5jdGlvbiBkZWNvZGUoaW5wdXQpIHsKCQkvLyBEb24ndCB1c2UgVUNTLTIKCQl2YXIgb3V0cHV0ID0gW10sCgkJICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCSAgICBvdXQsCgkJICAgIGkgPSAwLAoJCSAgICBuID0gaW5pdGlhbE4sCgkJICAgIGJpYXMgPSBpbml0aWFsQmlhcywKCQkgICAgYmFzaWMsCgkJICAgIGosCgkJICAgIGluZGV4LAoJCSAgICBvbGRpLAoJCSAgICB3LAoJCSAgICBrLAoJCSAgICBkaWdpdCwKCQkgICAgdCwKCQkgICAgLyoqIENhY2hlZCBjYWxjdWxhdGlvbiByZXN1bHRzICovCgkJICAgIGJhc2VNaW51c1Q7CgoJCS8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHM6IGxldCBgYmFzaWNgIGJlIHRoZSBudW1iZXIgb2YgaW5wdXQgY29kZQoJCS8vIHBvaW50cyBiZWZvcmUgdGhlIGxhc3QgZGVsaW1pdGVyLCBvciBgMGAgaWYgdGhlcmUgaXMgbm9uZSwgdGhlbiBjb3B5CgkJLy8gdGhlIGZpcnN0IGJhc2ljIGNvZGUgcG9pbnRzIHRvIHRoZSBvdXRwdXQuCgoJCWJhc2ljID0gaW5wdXQubGFzdEluZGV4T2YoZGVsaW1pdGVyKTsKCQlpZiAoYmFzaWMgPCAwKSB7CgkJCWJhc2ljID0gMDsKCQl9CgoJCWZvciAoaiA9IDA7IGogPCBiYXNpYzsgKytqKSB7CgkJCS8vIGlmIGl0J3Mgbm90IGEgYmFzaWMgY29kZSBwb2ludAoJCQlpZiAoaW5wdXQuY2hhckNvZGVBdChqKSA+PSAweDgwKSB7CgkJCQllcnJvcignbm90LWJhc2ljJyk7CgkJCX0KCQkJb3V0cHV0LnB1c2goaW5wdXQuY2hhckNvZGVBdChqKSk7CgkJfQoKCQkvLyBNYWluIGRlY29kaW5nIGxvb3A6IHN0YXJ0IGp1c3QgYWZ0ZXIgdGhlIGxhc3QgZGVsaW1pdGVyIGlmIGFueSBiYXNpYyBjb2RlCgkJLy8gcG9pbnRzIHdlcmUgY29waWVkOyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nIG90aGVyd2lzZS4KCgkJZm9yIChpbmRleCA9IGJhc2ljID4gMCA/IGJhc2ljICsgMSA6IDA7IGluZGV4IDwgaW5wdXRMZW5ndGg7IC8qIG5vIGZpbmFsIGV4cHJlc3Npb24gKi8pIHsKCgkJCS8vIGBpbmRleGAgaXMgdGhlIGluZGV4IG9mIHRoZSBuZXh0IGNoYXJhY3RlciB0byBiZSBjb25zdW1lZC4KCQkJLy8gRGVjb2RlIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIgaW50byBgZGVsdGFgLAoJCQkvLyB3aGljaCBnZXRzIGFkZGVkIHRvIGBpYC4gVGhlIG92ZXJmbG93IGNoZWNraW5nIGlzIGVhc2llcgoJCQkvLyBpZiB3ZSBpbmNyZWFzZSBgaWAgYXMgd2UgZ28sIHRoZW4gc3VidHJhY3Qgb2ZmIGl0cyBzdGFydGluZwoJCQkvLyB2YWx1ZSBhdCB0aGUgZW5kIHRvIG9idGFpbiBgZGVsdGFgLgoJCQlmb3IgKG9sZGkgPSBpLCB3ID0gMSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CgoJCQkJaWYgKGluZGV4ID49IGlucHV0TGVuZ3RoKSB7CgkJCQkJZXJyb3IoJ2ludmFsaWQtaW5wdXQnKTsKCQkJCX0KCgkJCQlkaWdpdCA9IGJhc2ljVG9EaWdpdChpbnB1dC5jaGFyQ29kZUF0KGluZGV4KyspKTsKCgkJCQlpZiAoZGlnaXQgPj0gYmFzZSB8fCBkaWdpdCA+IGZsb29yKChtYXhJbnQgLSBpKSAvIHcpKSB7CgkJCQkJZXJyb3IoJ292ZXJmbG93Jyk7CgkJCQl9CgoJCQkJaSArPSBkaWdpdCAqIHc7CgkJCQl0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKCgkJCQlpZiAoZGlnaXQgPCB0KSB7CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwoJCQkJaWYgKHcgPiBmbG9vcihtYXhJbnQgLyBiYXNlTWludXNUKSkgewoJCQkJCWVycm9yKCdvdmVyZmxvdycpOwoJCQkJfQoKCQkJCXcgKj0gYmFzZU1pbnVzVDsKCgkJCX0KCgkJCW91dCA9IG91dHB1dC5sZW5ndGggKyAxOwoJCQliaWFzID0gYWRhcHQoaSAtIG9sZGksIG91dCwgb2xkaSA9PSAwKTsKCgkJCS8vIGBpYCB3YXMgc3VwcG9zZWQgdG8gd3JhcCBhcm91bmQgZnJvbSBgb3V0YCB0byBgMGAsCgkJCS8vIGluY3JlbWVudGluZyBgbmAgZWFjaCB0aW1lLCBzbyB3ZSdsbCBmaXggdGhhdCBub3c6CgkJCWlmIChmbG9vcihpIC8gb3V0KSA+IG1heEludCAtIG4pIHsKCQkJCWVycm9yKCdvdmVyZmxvdycpOwoJCQl9CgoJCQluICs9IGZsb29yKGkgLyBvdXQpOwoJCQlpICU9IG91dDsKCgkJCS8vIEluc2VydCBgbmAgYXQgcG9zaXRpb24gYGlgIG9mIHRoZSBvdXRwdXQKCQkJb3V0cHV0LnNwbGljZShpKyssIDAsIG4pOwoKCQl9CgoJCXJldHVybiB1Y3MyZW5jb2RlKG91dHB1dCk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMgKGUuZy4gYSBkb21haW4gbmFtZSBsYWJlbCkgdG8gYQoJICogUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgoJICovCglmdW5jdGlvbiBlbmNvZGUoaW5wdXQpIHsKCQl2YXIgbiwKCQkgICAgZGVsdGEsCgkJICAgIGhhbmRsZWRDUENvdW50LAoJCSAgICBiYXNpY0xlbmd0aCwKCQkgICAgYmlhcywKCQkgICAgaiwKCQkgICAgbSwKCQkgICAgcSwKCQkgICAgaywKCQkgICAgdCwKCQkgICAgY3VycmVudFZhbHVlLAoJCSAgICBvdXRwdXQgPSBbXSwKCQkgICAgLyoqIGBpbnB1dExlbmd0aGAgd2lsbCBob2xkIHRoZSBudW1iZXIgb2YgY29kZSBwb2ludHMgaW4gYGlucHV0YC4gKi8KCQkgICAgaW5wdXRMZW5ndGgsCgkJICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwoJCSAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsCgkJICAgIGJhc2VNaW51c1QsCgkJICAgIHFNaW51c1Q7CgoJCS8vIENvbnZlcnQgdGhlIGlucHV0IGluIFVDUy0yIHRvIFVuaWNvZGUKCQlpbnB1dCA9IHVjczJkZWNvZGUoaW5wdXQpOwoKCQkvLyBDYWNoZSB0aGUgbGVuZ3RoCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGg7CgoJCS8vIEluaXRpYWxpemUgdGhlIHN0YXRlCgkJbiA9IGluaXRpYWxOOwoJCWRlbHRhID0gMDsKCQliaWFzID0gaW5pdGlhbEJpYXM7CgoJCS8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHMKCQlmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewoJCQljdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKCQkJaWYgKGN1cnJlbnRWYWx1ZSA8IDB4ODApIHsKCQkJCW91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShjdXJyZW50VmFsdWUpKTsKCQkJfQoJCX0KCgkJaGFuZGxlZENQQ291bnQgPSBiYXNpY0xlbmd0aCA9IG91dHB1dC5sZW5ndGg7CgoJCS8vIGBoYW5kbGVkQ1BDb3VudGAgaXMgdGhlIG51bWJlciBvZiBjb2RlIHBvaW50cyB0aGF0IGhhdmUgYmVlbiBoYW5kbGVkOwoJCS8vIGBiYXNpY0xlbmd0aGAgaXMgdGhlIG51bWJlciBvZiBiYXNpYyBjb2RlIHBvaW50cy4KCgkJLy8gRmluaXNoIHRoZSBiYXNpYyBzdHJpbmcgLSBpZiBpdCBpcyBub3QgZW1wdHkgLSB3aXRoIGEgZGVsaW1pdGVyCgkJaWYgKGJhc2ljTGVuZ3RoKSB7CgkJCW91dHB1dC5wdXNoKGRlbGltaXRlcik7CgkJfQoKCQkvLyBNYWluIGVuY29kaW5nIGxvb3A6CgkJd2hpbGUgKGhhbmRsZWRDUENvdW50IDwgaW5wdXRMZW5ndGgpIHsKCgkJCS8vIEFsbCBub24tYmFzaWMgY29kZSBwb2ludHMgPCBuIGhhdmUgYmVlbiBoYW5kbGVkIGFscmVhZHkuIEZpbmQgdGhlIG5leHQKCQkJLy8gbGFyZ2VyIG9uZToKCQkJZm9yIChtID0gbWF4SW50LCBqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKCQkJCWN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwoJCQkJaWYgKGN1cnJlbnRWYWx1ZSA+PSBuICYmIGN1cnJlbnRWYWx1ZSA8IG0pIHsKCQkJCQltID0gY3VycmVudFZhbHVlOwoJCQkJfQoJCQl9CgoJCQkvLyBJbmNyZWFzZSBgZGVsdGFgIGVub3VnaCB0byBhZHZhbmNlIHRoZSBkZWNvZGVyJ3MgPG4saT4gc3RhdGUgdG8gPG0sMD4sCgkJCS8vIGJ1dCBndWFyZCBhZ2FpbnN0IG92ZXJmbG93CgkJCWhhbmRsZWRDUENvdW50UGx1c09uZSA9IGhhbmRsZWRDUENvdW50ICsgMTsKCQkJaWYgKG0gLSBuID4gZmxvb3IoKG1heEludCAtIGRlbHRhKSAvIGhhbmRsZWRDUENvdW50UGx1c09uZSkpIHsKCQkJCWVycm9yKCdvdmVyZmxvdycpOwoJCQl9CgoJCQlkZWx0YSArPSAobSAtIG4pICogaGFuZGxlZENQQ291bnRQbHVzT25lOwoJCQluID0gbTsKCgkJCWZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CgkJCQljdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKCgkJCQlpZiAoY3VycmVudFZhbHVlIDwgbiAmJiArK2RlbHRhID4gbWF4SW50KSB7CgkJCQkJZXJyb3IoJ292ZXJmbG93Jyk7CgkJCQl9CgoJCQkJaWYgKGN1cnJlbnRWYWx1ZSA9PSBuKSB7CgkJCQkJLy8gUmVwcmVzZW50IGRlbHRhIGFzIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIKCQkJCQlmb3IgKHEgPSBkZWx0YSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CgkJCQkJCXQgPSBrIDw9IGJpYXMgPyB0TWluIDogKGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXMpOwoJCQkJCQlpZiAocSA8IHQpIHsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJCXFNaW51c1QgPSBxIC0gdDsKCQkJCQkJYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwoJCQkJCQlvdXRwdXQucHVzaCgKCQkJCQkJCXN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWModCArIHFNaW51c1QgJSBiYXNlTWludXNULCAwKSkKCQkJCQkJKTsKCQkJCQkJcSA9IGZsb29yKHFNaW51c1QgLyBiYXNlTWludXNUKTsKCQkJCQl9CgoJCQkJCW91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWMocSwgMCkpKTsKCQkJCQliaWFzID0gYWRhcHQoZGVsdGEsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgaGFuZGxlZENQQ291bnQgPT0gYmFzaWNMZW5ndGgpOwoJCQkJCWRlbHRhID0gMDsKCQkJCQkrK2hhbmRsZWRDUENvdW50OwoJCQkJfQoJCQl9CgoJCQkrK2RlbHRhOwoJCQkrK247CgoJCX0KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfQoKCS8qKgoJICogQ29udmVydHMgYSBQdW55Y29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcwoJICogdG8gVW5pY29kZS4gT25seSB0aGUgUHVueWNvZGVkIHBhcnRzIG9mIHRoZSBpbnB1dCB3aWxsIGJlIGNvbnZlcnRlZCwgaS5lLgoJICogaXQgZG9lc24ndCBtYXR0ZXIgaWYgeW91IGNhbGwgaXQgb24gYSBzdHJpbmcgdGhhdCBoYXMgYWxyZWFkeSBiZWVuCgkgKiBjb252ZXJ0ZWQgdG8gVW5pY29kZS4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZWQgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcyB0bwoJICogY29udmVydCB0byBVbmljb2RlLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIFVuaWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIFB1bnljb2RlCgkgKiBzdHJpbmcuCgkgKi8KCWZ1bmN0aW9uIHRvVW5pY29kZShpbnB1dCkgewoJCXJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewoJCQlyZXR1cm4gcmVnZXhQdW55Y29kZS50ZXN0KHN0cmluZykKCQkJCT8gZGVjb2RlKHN0cmluZy5zbGljZSg0KS50b0xvd2VyQ2FzZSgpKQoJCQkJOiBzdHJpbmc7CgkJfSk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIFVuaWNvZGUgc3RyaW5nIHJlcHJlc2VudGluZyBhIGRvbWFpbiBuYW1lIG9yIGFuIGVtYWlsIGFkZHJlc3MgdG8KCSAqIFB1bnljb2RlLiBPbmx5IHRoZSBub24tQVNDSUkgcGFydHMgb2YgdGhlIGRvbWFpbiBuYW1lIHdpbGwgYmUgY29udmVydGVkLAoJICogaS5lLiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQncyBhbHJlYWR5IGluCgkgKiBBU0NJSS4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvIGNvbnZlcnQsIGFzIGEKCSAqIFVuaWNvZGUgc3RyaW5nLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIFB1bnljb2RlIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBkb21haW4gbmFtZSBvcgoJICogZW1haWwgYWRkcmVzcy4KCSAqLwoJZnVuY3Rpb24gdG9BU0NJSShpbnB1dCkgewoJCXJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewoJCQlyZXR1cm4gcmVnZXhOb25BU0NJSS50ZXN0KHN0cmluZykKCQkJCT8gJ3huLS0nICsgZW5jb2RlKHN0cmluZykKCQkJCTogc3RyaW5nOwoJCX0pOwoJfQoKCS8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCS8qKiBEZWZpbmUgdGhlIHB1YmxpYyBBUEkgKi8KCXB1bnljb2RlID0gewoJCS8qKgoJCSAqIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBQdW55Y29kZS5qcyB2ZXJzaW9uIG51bWJlci4KCQkgKiBAbWVtYmVyT2YgcHVueWNvZGUKCQkgKiBAdHlwZSBTdHJpbmcKCQkgKi8KCQkndmVyc2lvbic6ICcxLjMuMicsCgkJLyoqCgkJICogQW4gb2JqZWN0IG9mIG1ldGhvZHMgdG8gY29udmVydCBmcm9tIEphdmFTY3JpcHQncyBpbnRlcm5hbCBjaGFyYWN0ZXIKCQkgKiByZXByZXNlbnRhdGlvbiAoVUNTLTIpIHRvIFVuaWNvZGUgY29kZSBwb2ludHMsIGFuZCBiYWNrLgoJCSAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgoJCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJCSAqIEB0eXBlIE9iamVjdAoJCSAqLwoJCSd1Y3MyJzogewoJCQknZGVjb2RlJzogdWNzMmRlY29kZSwKCQkJJ2VuY29kZSc6IHVjczJlbmNvZGUKCQl9LAoJCSdkZWNvZGUnOiBkZWNvZGUsCgkJJ2VuY29kZSc6IGVuY29kZSwKCQkndG9BU0NJSSc6IHRvQVNDSUksCgkJJ3RvVW5pY29kZSc6IHRvVW5pY29kZQoJfTsKCgkvKiogRXhwb3NlIGBwdW55Y29kZWAgKi8KCS8vIFNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucwoJLy8gbGlrZSB0aGUgZm9sbG93aW5nOgoJaWYgKAoJCXRydWUKCSkgewoJCSEoX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gPSAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBwdW55Y29kZTsKCQl9KS5jYWxsKGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18sIGV4cG9ydHMsIG1vZHVsZSksCgkJX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gIT09IHVuZGVmaW5lZCAmJiAobW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXykpOwoJfSBlbHNlIHt9Cgp9KHRoaXMpKTsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMsdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKfSx7fV0sODM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGlzQnVmZmVyKGFyZykgewogIHJldHVybiBhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcKICAgICYmIHR5cGVvZiBhcmcuY29weSA9PT0gJ2Z1bmN0aW9uJwogICAgJiYgdHlwZW9mIGFyZy5maWxsID09PSAnZnVuY3Rpb24nCiAgICAmJiB0eXBlb2YgYXJnLnJlYWRVSW50OCA9PT0gJ2Z1bmN0aW9uJzsKfQp9LHt9XSw4NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2VzcyxnbG9iYWwpeyhmdW5jdGlvbiAoKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKdmFyIGZvcm1hdFJlZ0V4cCA9IC8lW3NkaiVdL2c7CmV4cG9ydHMuZm9ybWF0ID0gZnVuY3Rpb24oZikgewogIGlmICghaXNTdHJpbmcoZikpIHsKICAgIHZhciBvYmplY3RzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBvYmplY3RzLnB1c2goaW5zcGVjdChhcmd1bWVudHNbaV0pKTsKICAgIH0KICAgIHJldHVybiBvYmplY3RzLmpvaW4oJyAnKTsKICB9CgogIHZhciBpID0gMTsKICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICB2YXIgbGVuID0gYXJncy5sZW5ndGg7CiAgdmFyIHN0ciA9IFN0cmluZyhmKS5yZXBsYWNlKGZvcm1hdFJlZ0V4cCwgZnVuY3Rpb24oeCkgewogICAgaWYgKHggPT09ICclJScpIHJldHVybiAnJSc7CiAgICBpZiAoaSA+PSBsZW4pIHJldHVybiB4OwogICAgc3dpdGNoICh4KSB7CiAgICAgIGNhc2UgJyVzJzogcmV0dXJuIFN0cmluZyhhcmdzW2krK10pOwogICAgICBjYXNlICclZCc6IHJldHVybiBOdW1iZXIoYXJnc1tpKytdKTsKICAgICAgY2FzZSAnJWonOgogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYXJnc1tpKytdKTsKICAgICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgICByZXR1cm4gJ1tDaXJjdWxhcl0nOwogICAgICAgIH0KICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4geDsKICAgIH0KICB9KTsKICBmb3IgKHZhciB4ID0gYXJnc1tpXTsgaSA8IGxlbjsgeCA9IGFyZ3NbKytpXSkgewogICAgaWYgKGlzTnVsbCh4KSB8fCAhaXNPYmplY3QoeCkpIHsKICAgICAgc3RyICs9ICcgJyArIHg7CiAgICB9IGVsc2UgewogICAgICBzdHIgKz0gJyAnICsgaW5zcGVjdCh4KTsKICAgIH0KICAgIHRoYXQubGVuZ3RoID0gbGVuZ3RoCiAgfQogIHJldHVybiBzdHI7Cn07CgoKLy8gTWFyayB0aGF0IGEgbWV0aG9kIHNob3VsZCBub3QgYmUgdXNlZC4KLy8gUmV0dXJucyBhIG1vZGlmaWVkIGZ1bmN0aW9uIHdoaWNoIHdhcm5zIG9uY2UgYnkgZGVmYXVsdC4KLy8gSWYgLS1uby1kZXByZWNhdGlvbiBpcyBzZXQsIHRoZW4gaXQgaXMgYSBuby1vcC4KZXhwb3J0cy5kZXByZWNhdGUgPSBmdW5jdGlvbihmbiwgbXNnKSB7CiAgLy8gQWxsb3cgZm9yIGRlcHJlY2F0aW5nIHRoaW5ncyBpbiB0aGUgcHJvY2VzcyBvZiBzdGFydGluZyB1cC4KICBpZiAoaXNVbmRlZmluZWQoZ2xvYmFsLnByb2Nlc3MpKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBleHBvcnRzLmRlcHJlY2F0ZShmbiwgbXNnKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICB9CgogIGlmIChwcm9jZXNzLm5vRGVwcmVjYXRpb24gPT09IHRydWUpIHsKICAgIHJldHVybiBmbjsKICB9CgogIHZhciB3YXJuZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBkZXByZWNhdGVkKCkgewogICAgaWYgKCF3YXJuZWQpIHsKICAgICAgaWYgKHByb2Nlc3MudGhyb3dEZXByZWNhdGlvbikgewogICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgICB9IGVsc2UgaWYgKHByb2Nlc3MudHJhY2VEZXByZWNhdGlvbikgewogICAgICAgIGNvbnNvbGUudHJhY2UobXNnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKG1zZyk7CiAgICAgIH0KICAgICAgd2FybmVkID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KCiAgcmV0dXJuIGRlcHJlY2F0ZWQ7Cn07CgoKdmFyIGRlYnVncyA9IHt9Owp2YXIgZGVidWdFbnZpcm9uOwpleHBvcnRzLmRlYnVnbG9nID0gZnVuY3Rpb24oc2V0KSB7CiAgaWYgKGlzVW5kZWZpbmVkKGRlYnVnRW52aXJvbikpCiAgICBkZWJ1Z0Vudmlyb24gPSBwcm9jZXNzLmVudi5OT0RFX0RFQlVHIHx8ICcnOwogIHNldCA9IHNldC50b1VwcGVyQ2FzZSgpOwogIGlmICghZGVidWdzW3NldF0pIHsKICAgIGlmIChuZXcgUmVnRXhwKCdcXGInICsgc2V0ICsgJ1xcYicsICdpJykudGVzdChkZWJ1Z0Vudmlyb24pKSB7CiAgICAgIHZhciBwaWQgPSBwcm9jZXNzLnBpZDsKICAgICAgZGVidWdzW3NldF0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbXNnID0gZXhwb3J0cy5mb3JtYXQuYXBwbHkoZXhwb3J0cywgYXJndW1lbnRzKTsKICAgICAgICBjb25zb2xlLmVycm9yKCclcyAlZDogJXMnLCBzZXQsIHBpZCwgbXNnKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIGRlYnVnc1tzZXRdID0gZnVuY3Rpb24oKSB7fTsKICAgIH0KICB9CiAgcmV0dXJuIGRlYnVnc1tzZXRdOwp9OwoKCi8qKgogKiBFY2hvcyB0aGUgdmFsdWUgb2YgYSB2YWx1ZS4gVHJ5cyB0byBwcmludCB0aGUgdmFsdWUgb3V0CiAqIGluIHRoZSBiZXN0IHdheSBwb3NzaWJsZSBnaXZlbiB0aGUgZGlmZmVyZW50IHR5cGVzLgogKgogKiBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gcHJpbnQgb3V0LgogKiBAcGFyYW0ge09iamVjdH0gb3B0cyBPcHRpb25hbCBvcHRpb25zIG9iamVjdCB0aGF0IGFsdGVycyB0aGUgb3V0cHV0LgogKi8KLyogbGVnYWN5OiBvYmosIHNob3dIaWRkZW4sIGRlcHRoLCBjb2xvcnMqLwpmdW5jdGlvbiBpbnNwZWN0KG9iaiwgb3B0cykgewogIC8vIGRlZmF1bHQgb3B0aW9ucwogIHZhciBjdHggPSB7CiAgICBzZWVuOiBbXSwKICAgIHN0eWxpemU6IHN0eWxpemVOb0NvbG9yCiAgfTsKICAvLyBsZWdhY3kuLi4KICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSAzKSBjdHguZGVwdGggPSBhcmd1bWVudHNbMl07CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gNCkgY3R4LmNvbG9ycyA9IGFyZ3VtZW50c1szXTsKICBpZiAoaXNCb29sZWFuKG9wdHMpKSB7CiAgICAvLyBsZWdhY3kuLi4KICAgIGN0eC5zaG93SGlkZGVuID0gb3B0czsKICB9IGVsc2UgaWYgKG9wdHMpIHsKICAgIC8vIGdvdCBhbiAib3B0aW9ucyIgb2JqZWN0CiAgICBleHBvcnRzLl9leHRlbmQoY3R4LCBvcHRzKTsKICB9CiAgLy8gc2V0IGRlZmF1bHQgb3B0aW9ucwogIGlmIChpc1VuZGVmaW5lZChjdHguc2hvd0hpZGRlbikpIGN0eC5zaG93SGlkZGVuID0gZmFsc2U7CiAgaWYgKGlzVW5kZWZpbmVkKGN0eC5kZXB0aCkpIGN0eC5kZXB0aCA9IDI7CiAgaWYgKGlzVW5kZWZpbmVkKGN0eC5jb2xvcnMpKSBjdHguY29sb3JzID0gZmFsc2U7CiAgaWYgKGlzVW5kZWZpbmVkKGN0eC5jdXN0b21JbnNwZWN0KSkgY3R4LmN1c3RvbUluc3BlY3QgPSB0cnVlOwogIGlmIChjdHguY29sb3JzKSBjdHguc3R5bGl6ZSA9IHN0eWxpemVXaXRoQ29sb3I7CiAgcmV0dXJuIGZvcm1hdFZhbHVlKGN0eCwgb2JqLCBjdHguZGVwdGgpOwp9CmV4cG9ydHMuaW5zcGVjdCA9IGluc3BlY3Q7CgoKLy8gaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9BTlNJX2VzY2FwZV9jb2RlI2dyYXBoaWNzCmluc3BlY3QuY29sb3JzID0gewogICdib2xkJyA6IFsxLCAyMl0sCiAgJ2l0YWxpYycgOiBbMywgMjNdLAogICd1bmRlcmxpbmUnIDogWzQsIDI0XSwKICAnaW52ZXJzZScgOiBbNywgMjddLAogICd3aGl0ZScgOiBbMzcsIDM5XSwKICAnZ3JleScgOiBbOTAsIDM5XSwKICAnYmxhY2snIDogWzMwLCAzOV0sCiAgJ2JsdWUnIDogWzM0LCAzOV0sCiAgJ2N5YW4nIDogWzM2LCAzOV0sCiAgJ2dyZWVuJyA6IFszMiwgMzldLAogICdtYWdlbnRhJyA6IFszNSwgMzldLAogICdyZWQnIDogWzMxLCAzOV0sCiAgJ3llbGxvdycgOiBbMzMsIDM5XQp9OwoKLy8gRG9uJ3QgdXNlICdibHVlJyBub3QgdmlzaWJsZSBvbiBjbWQuZXhlCmluc3BlY3Quc3R5bGVzID0gewogICdzcGVjaWFsJzogJ2N5YW4nLAogICdudW1iZXInOiAneWVsbG93JywKICAnYm9vbGVhbic6ICd5ZWxsb3cnLAogICd1bmRlZmluZWQnOiAnZ3JleScsCiAgJ251bGwnOiAnYm9sZCcsCiAgJ3N0cmluZyc6ICdncmVlbicsCiAgJ2RhdGUnOiAnbWFnZW50YScsCiAgLy8gIm5hbWUiOiBpbnRlbnRpb25hbGx5IG5vdCBzdHlsaW5nCiAgJ3JlZ2V4cCc6ICdyZWQnCn07CgoKZnVuY3Rpb24gc3R5bGl6ZVdpdGhDb2xvcihzdHIsIHN0eWxlVHlwZSkgewogIHZhciBzdHlsZSA9IGluc3BlY3Quc3R5bGVzW3N0eWxlVHlwZV07CgogIGlmIChzdHlsZSkgewogICAgcmV0dXJuICdcdTAwMWJbJyArIGluc3BlY3QuY29sb3JzW3N0eWxlXVswXSArICdtJyArIHN0ciArCiAgICAgICAgICAgJ1x1MDAxYlsnICsgaW5zcGVjdC5jb2xvcnNbc3R5bGVdWzFdICsgJ20nOwogIH0gZWxzZSB7CiAgICByZXR1cm4gc3RyOwogIH0KfQoKCmZ1bmN0aW9uIHN0eWxpemVOb0NvbG9yKHN0ciwgc3R5bGVUeXBlKSB7CiAgcmV0dXJuIHN0cjsKfQoKCmZ1bmN0aW9uIGFycmF5VG9IYXNoKGFycmF5KSB7CiAgdmFyIGhhc2ggPSB7fTsKCiAgYXJyYXkuZm9yRWFjaChmdW5jdGlvbih2YWwsIGlkeCkgewogICAgaGFzaFt2YWxdID0gdHJ1ZTsKICB9KTsKCiAgcmV0dXJuIGhhc2g7Cn0KCgpmdW5jdGlvbiBmb3JtYXRWYWx1ZShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMpIHsKICAvLyBQcm92aWRlIGEgaG9vayBmb3IgdXNlci1zcGVjaWZpZWQgaW5zcGVjdCBmdW5jdGlvbnMuCiAgLy8gQ2hlY2sgdGhhdCB2YWx1ZSBpcyBhbiBvYmplY3Qgd2l0aCBhbiBpbnNwZWN0IGZ1bmN0aW9uIG9uIGl0CiAgaWYgKGN0eC5jdXN0b21JbnNwZWN0ICYmCiAgICAgIHZhbHVlICYmCiAgICAgIGlzRnVuY3Rpb24odmFsdWUuaW5zcGVjdCkgJiYKICAgICAgLy8gRmlsdGVyIG91dCB0aGUgdXRpbCBtb2R1bGUsIGl0J3MgaW5zcGVjdCBmdW5jdGlvbiBpcyBzcGVjaWFsCiAgICAgIHZhbHVlLmluc3BlY3QgIT09IGV4cG9ydHMuaW5zcGVjdCAmJgogICAgICAvLyBBbHNvIGZpbHRlciBvdXQgYW55IHByb3RvdHlwZSBvYmplY3RzIHVzaW5nIHRoZSBjaXJjdWxhciBjaGVjay4KICAgICAgISh2YWx1ZS5jb25zdHJ1Y3RvciAmJiB2YWx1ZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPT09IHZhbHVlKSkgewogICAgdmFyIHJldCA9IHZhbHVlLmluc3BlY3QocmVjdXJzZVRpbWVzLCBjdHgpOwogICAgaWYgKCFpc1N0cmluZyhyZXQpKSB7CiAgICAgIHJldCA9IGZvcm1hdFZhbHVlKGN0eCwgcmV0LCByZWN1cnNlVGltZXMpOwogICAgfQogICAgcmV0dXJuIHJldDsKICB9CgogIC8vIFByaW1pdGl2ZSB0eXBlcyBjYW5ub3QgaGF2ZSBwcm9wZXJ0aWVzCiAgdmFyIHByaW1pdGl2ZSA9IGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKTsKICBpZiAocHJpbWl0aXZlKSB7CiAgICByZXR1cm4gcHJpbWl0aXZlOwogIH0KCiAgLy8gTG9vayB1cCB0aGUga2V5cyBvZiB0aGUgb2JqZWN0LgogIHZhciBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpOwogIHZhciB2aXNpYmxlS2V5cyA9IGFycmF5VG9IYXNoKGtleXMpOwoKICBpZiAoY3R4LnNob3dIaWRkZW4pIHsKICAgIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh2YWx1ZSk7CiAgfQoKICAvLyBJRSBkb2Vzbid0IG1ha2UgZXJyb3IgZmllbGRzIG5vbi1lbnVtZXJhYmxlCiAgLy8gaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2R3dzUyc2J0KHY9dnMuOTQpLmFzcHgKICBpZiAoaXNFcnJvcih2YWx1ZSkKICAgICAgJiYgKGtleXMuaW5kZXhPZignbWVzc2FnZScpID49IDAgfHwga2V5cy5pbmRleE9mKCdkZXNjcmlwdGlvbicpID49IDApKSB7CiAgICByZXR1cm4gZm9ybWF0RXJyb3IodmFsdWUpOwogIH0KCiAgLy8gU29tZSB0eXBlIG9mIG9iamVjdCB3aXRob3V0IHByb3BlcnRpZXMgY2FuIGJlIHNob3J0Y3V0dGVkLgogIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgIHZhciBuYW1lID0gdmFsdWUubmFtZSA/ICc6ICcgKyB2YWx1ZS5uYW1lIDogJyc7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW0Z1bmN0aW9uJyArIG5hbWUgKyAnXScsICdzcGVjaWFsJyk7CiAgICB9CiAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICB9CiAgICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgICByZXR1cm4gY3R4LnN0eWxpemUoRGF0ZS5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdkYXRlJyk7CiAgICB9CiAgICBpZiAoaXNFcnJvcih2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgIH0KICB9CgogIHZhciBiYXNlID0gJycsIGFycmF5ID0gZmFsc2UsIGJyYWNlcyA9IFsneycsICd9J107CgogIC8vIE1ha2UgQXJyYXkgc2F5IHRoYXQgdGhleSBhcmUgQXJyYXkKICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgIGFycmF5ID0gdHJ1ZTsKICAgIGJyYWNlcyA9IFsnWycsICddJ107CiAgfQoKICAvLyBNYWtlIGZ1bmN0aW9ucyBzYXkgdGhhdCB0aGV5IGFyZSBmdW5jdGlvbnMKICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgIHZhciBuID0gdmFsdWUubmFtZSA/ICc6ICcgKyB2YWx1ZS5uYW1lIDogJyc7CiAgICBiYXNlID0gJyBbRnVuY3Rpb24nICsgbiArICddJzsKICB9CgogIC8vIE1ha2UgUmVnRXhwcyBzYXkgdGhhdCB0aGV5IGFyZSBSZWdFeHBzCiAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgYmFzZSA9ICcgJyArIFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgfQoKICAvLyBNYWtlIGRhdGVzIHdpdGggcHJvcGVydGllcyBmaXJzdCBzYXkgdGhlIGRhdGUKICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgYmFzZSA9ICcgJyArIERhdGUucHJvdG90eXBlLnRvVVRDU3RyaW5nLmNhbGwodmFsdWUpOwogIH0KCiAgLy8gTWFrZSBlcnJvciB3aXRoIG1lc3NhZ2UgZmlyc3Qgc2F5IHRoZSBlcnJvcgogIGlmIChpc0Vycm9yKHZhbHVlKSkgewogICAgYmFzZSA9ICcgJyArIGZvcm1hdEVycm9yKHZhbHVlKTsKICB9CgogIGlmIChrZXlzLmxlbmd0aCA9PT0gMCAmJiAoIWFycmF5IHx8IHZhbHVlLmxlbmd0aCA9PSAwKSkgewogICAgcmV0dXJuIGJyYWNlc1swXSArIGJhc2UgKyBicmFjZXNbMV07CiAgfQoKICBpZiAocmVjdXJzZVRpbWVzIDwgMCkgewogICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICByZXR1cm4gY3R4LnN0eWxpemUoUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ3JlZ2V4cCcpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdbT2JqZWN0XScsICdzcGVjaWFsJyk7CiAgICB9CiAgfQoKICBjdHguc2Vlbi5wdXNoKHZhbHVlKTsKCiAgdmFyIG91dHB1dDsKICBpZiAoYXJyYXkpIHsKICAgIG91dHB1dCA9IGZvcm1hdEFycmF5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleXMpOwogIH0gZWxzZSB7CiAgICBvdXRwdXQgPSBrZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgcmV0dXJuIGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleSwgYXJyYXkpOwogICAgfSk7CiAgfQoKICBjdHguc2Vlbi5wb3AoKTsKCiAgcmV0dXJuIHJlZHVjZVRvU2luZ2xlU3RyaW5nKG91dHB1dCwgYmFzZSwgYnJhY2VzKTsKfQoKCmZ1bmN0aW9uIGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKSB7CiAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgIHJldHVybiBjdHguc3R5bGl6ZSgndW5kZWZpbmVkJywgJ3VuZGVmaW5lZCcpOwogIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgIHZhciBzaW1wbGUgPSAnXCcnICsgSlNPTi5zdHJpbmdpZnkodmFsdWUpLnJlcGxhY2UoL14ifCIkL2csICcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAiXFwnIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnIicpICsgJ1wnJzsKICAgIHJldHVybiBjdHguc3R5bGl6ZShzaW1wbGUsICdzdHJpbmcnKTsKICB9CiAgaWYgKGlzTnVtYmVyKHZhbHVlKSkKICAgIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnbnVtYmVyJyk7CiAgaWYgKGlzQm9vbGVhbih2YWx1ZSkpCiAgICByZXR1cm4gY3R4LnN0eWxpemUoJycgKyB2YWx1ZSwgJ2Jvb2xlYW4nKTsKICAvLyBGb3Igc29tZSByZWFzb24gdHlwZW9mIG51bGwgaXMgIm9iamVjdCIsIHNvIHNwZWNpYWwgY2FzZSBoZXJlLgogIGlmIChpc051bGwodmFsdWUpKQogICAgcmV0dXJuIGN0eC5zdHlsaXplKCdudWxsJywgJ251bGwnKTsKfQoKCmZ1bmN0aW9uIGZvcm1hdEVycm9yKHZhbHVlKSB7CiAgcmV0dXJuICdbJyArIEVycm9yLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSArICddJzsKfQoKCmZ1bmN0aW9uIGZvcm1hdEFycmF5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleXMpIHsKICB2YXIgb3V0cHV0ID0gW107CiAgZm9yICh2YXIgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgIGlmIChoYXNPd25Qcm9wZXJ0eSh2YWx1ZSwgU3RyaW5nKGkpKSkgewogICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAgU3RyaW5nKGkpLCB0cnVlKSk7CiAgICB9IGVsc2UgewogICAgICBvdXRwdXQucHVzaCgnJyk7CiAgICB9CiAgfQogIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgIGlmICgha2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgIG91dHB1dC5wdXNoKGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsCiAgICAgICAgICBrZXksIHRydWUpKTsKICAgIH0KICB9KTsKICByZXR1cm4gb3V0cHV0Owp9CgoKZnVuY3Rpb24gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSkgewogIHZhciBuYW1lLCBzdHIsIGRlc2M7CiAgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodmFsdWUsIGtleSkgfHwgeyB2YWx1ZTogdmFsdWVba2V5XSB9OwogIGlmIChkZXNjLmdldCkgewogICAgaWYgKGRlc2Muc2V0KSB7CiAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyL1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgfSBlbHNlIHsKICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tHZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgIH0KICB9IGVsc2UgewogICAgaWYgKGRlc2Muc2V0KSB7CiAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICB9CiAgfQogIGlmICghaGFzT3duUHJvcGVydHkodmlzaWJsZUtleXMsIGtleSkpIHsKICAgIG5hbWUgPSAnWycgKyBrZXkgKyAnXSc7CiAgfQogIGlmICghc3RyKSB7CiAgICBpZiAoY3R4LnNlZW4uaW5kZXhPZihkZXNjLnZhbHVlKSA8IDApIHsKICAgICAgaWYgKGlzTnVsbChyZWN1cnNlVGltZXMpKSB7CiAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCBudWxsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHIgPSBmb3JtYXRWYWx1ZShjdHgsIGRlc2MudmFsdWUsIHJlY3Vyc2VUaW1lcyAtIDEpOwogICAgICB9CiAgICAgIGlmIChzdHIuaW5kZXhPZignXG4nKSA+IC0xKSB7CiAgICAgICAgaWYgKGFycmF5KSB7CiAgICAgICAgICBzdHIgPSBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgcmV0dXJuICcgICcgKyBsaW5lOwogICAgICAgICAgfSkuam9pbignXG4nKS5zdWJzdHIoMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0ciA9ICdcbicgKyBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgcmV0dXJuICcgICAnICsgbGluZTsKICAgICAgICAgIH0pLmpvaW4oJ1xuJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0NpcmN1bGFyXScsICdzcGVjaWFsJyk7CiAgICB9CiAgfQogIGlmIChpc1VuZGVmaW5lZChuYW1lKSkgewogICAgaWYgKGFycmF5ICYmIGtleS5tYXRjaCgvXlxkKyQvKSkgewogICAgICByZXR1cm4gc3RyOwogICAgfQogICAgbmFtZSA9IEpTT04uc3RyaW5naWZ5KCcnICsga2V5KTsKICAgIGlmIChuYW1lLm1hdGNoKC9eIihbYS16QS1aX11bYS16QS1aXzAtOV0qKSIkLykpIHsKICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDEsIG5hbWUubGVuZ3RoIC0gMik7CiAgICAgIG5hbWUgPSBjdHguc3R5bGl6ZShuYW1lLCAnbmFtZScpOwogICAgfSBlbHNlIHsKICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvJy9nLCAiXFwnIikKICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICciJykKICAgICAgICAgICAgICAgICAucmVwbGFjZSgvKF4ifCIkKS9nLCAiJyIpOwogICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ3N0cmluZycpOwogICAgfQogIH0KCiAgcmV0dXJuIG5hbWUgKyAnOiAnICsgc3RyOwp9CgoKZnVuY3Rpb24gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpIHsKICB2YXIgbnVtTGluZXNFc3QgPSAwOwogIHZhciBsZW5ndGggPSBvdXRwdXQucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGN1cikgewogICAgbnVtTGluZXNFc3QrKzsKICAgIGlmIChjdXIuaW5kZXhPZignXG4nKSA+PSAwKSBudW1MaW5lc0VzdCsrOwogICAgcmV0dXJuIHByZXYgKyBjdXIucmVwbGFjZSgvXHUwMDFiXFtcZFxkP20vZywgJycpLmxlbmd0aCArIDE7CiAgfSwgMCk7CgogIGlmIChsZW5ndGggPiA2MCkgewogICAgcmV0dXJuIGJyYWNlc1swXSArCiAgICAgICAgICAgKGJhc2UgPT09ICcnID8gJycgOiBiYXNlICsgJ1xuICcpICsKICAgICAgICAgICAnICcgKwogICAgICAgICAgIG91dHB1dC5qb2luKCcsXG4gICcpICsKICAgICAgICAgICAnICcgKwogICAgICAgICAgIGJyYWNlc1sxXTsKICB9CgogIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgJyAnICsgb3V0cHV0LmpvaW4oJywgJykgKyAnICcgKyBicmFjZXNbMV07Cn0KCgovLyBOT1RFOiBUaGVzZSB0eXBlIGNoZWNraW5nIGZ1bmN0aW9ucyBpbnRlbnRpb25hbGx5IGRvbid0IHVzZSBgaW5zdGFuY2VvZmAKLy8gYmVjYXVzZSBpdCBpcyBmcmFnaWxlIGFuZCBjYW4gYmUgZWFzaWx5IGZha2VkIHdpdGggYE9iamVjdC5jcmVhdGUoKWAuCmZ1bmN0aW9uIGlzQXJyYXkoYXIpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShhcik7Cn0KZXhwb3J0cy5pc0FycmF5ID0gaXNBcnJheTsKCmZ1bmN0aW9uIGlzQm9vbGVhbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nOwp9CmV4cG9ydHMuaXNCb29sZWFuID0gaXNCb29sZWFuOwoKZnVuY3Rpb24gaXNOdWxsKGFyZykgewogIHJldHVybiBhcmcgPT09IG51bGw7Cn0KZXhwb3J0cy5pc051bGwgPSBpc051bGw7CgpmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gYXJnID09IG51bGw7Cn0KZXhwb3J0cy5pc051bGxPclVuZGVmaW5lZCA9IGlzTnVsbE9yVW5kZWZpbmVkOwoKZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwp9CmV4cG9ydHMuaXNOdW1iZXIgPSBpc051bWJlcjsKCmZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJzsKfQpleHBvcnRzLmlzU3RyaW5nID0gaXNTdHJpbmc7CgpmdW5jdGlvbiBpc1N5bWJvbChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCc7Cn0KZXhwb3J0cy5pc1N5bWJvbCA9IGlzU3ltYm9sOwoKZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwp9CmV4cG9ydHMuaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKCmZ1bmN0aW9uIGlzUmVnRXhwKHJlKSB7CiAgcmV0dXJuIGlzT2JqZWN0KHJlKSAmJiBvYmplY3RUb1N0cmluZyhyZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwp9CmV4cG9ydHMuaXNSZWdFeHAgPSBpc1JlZ0V4cDsKCmZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7Cn0KZXhwb3J0cy5pc09iamVjdCA9IGlzT2JqZWN0OwoKZnVuY3Rpb24gaXNEYXRlKGQpIHsKICByZXR1cm4gaXNPYmplY3QoZCkgJiYgb2JqZWN0VG9TdHJpbmcoZCkgPT09ICdbb2JqZWN0IERhdGVdJzsKfQpleHBvcnRzLmlzRGF0ZSA9IGlzRGF0ZTsKCmZ1bmN0aW9uIGlzRXJyb3IoZSkgewogIHJldHVybiBpc09iamVjdChlKSAmJgogICAgICAob2JqZWN0VG9TdHJpbmcoZSkgPT09ICdbb2JqZWN0IEVycm9yXScgfHwgZSBpbnN0YW5jZW9mIEVycm9yKTsKfQpleHBvcnRzLmlzRXJyb3IgPSBpc0Vycm9yOwoKZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKfQpleHBvcnRzLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwoKZnVuY3Rpb24gaXNQcmltaXRpdmUoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gbnVsbCB8fAogICAgICAgICB0eXBlb2YgYXJnID09PSAnYm9vbGVhbicgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ251bWJlcicgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCcgfHwgIC8vIEVTNiBzeW1ib2wKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCc7Cn0KZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwoKZXhwb3J0cy5pc0J1ZmZlciA9IHJlcXVpcmUoJy4vc3VwcG9ydC9pc0J1ZmZlcicpOwoKZnVuY3Rpb24gb2JqZWN0VG9TdHJpbmcobykgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobyk7Cn0KCgpmdW5jdGlvbiBwYWQobikgewogIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuLnRvU3RyaW5nKDEwKSA6IG4udG9TdHJpbmcoMTApOwp9CgoKdmFyIG1vbnRocyA9IFsnSmFuJywgJ0ZlYicsICdNYXInLCAnQXByJywgJ01heScsICdKdW4nLCAnSnVsJywgJ0F1ZycsICdTZXAnLAogICAgICAgICAgICAgICdPY3QnLCAnTm92JywgJ0RlYyddOwoKLy8gMjYgRmViIDE2OjE5OjM0CmZ1bmN0aW9uIHRpbWVzdGFtcCgpIHsKICB2YXIgZCA9IG5ldyBEYXRlKCk7CiAgdmFyIHRpbWUgPSBbcGFkKGQuZ2V0SG91cnMoKSksCiAgICAgICAgICAgICAgcGFkKGQuZ2V0TWludXRlcygpKSwKICAgICAgICAgICAgICBwYWQoZC5nZXRTZWNvbmRzKCkpXS5qb2luKCc6Jyk7CiAgcmV0dXJuIFtkLmdldERhdGUoKSwgbW9udGhzW2QuZ2V0TW9udGgoKV0sIHRpbWVdLmpvaW4oJyAnKTsKfQoKCi8vIGxvZyBpcyBqdXN0IGEgdGhpbiB3cmFwcGVyIHRvIGNvbnNvbGUubG9nIHRoYXQgcHJlcGVuZHMgYSB0aW1lc3RhbXAKZXhwb3J0cy5sb2cgPSBmdW5jdGlvbigpIHsKICBjb25zb2xlLmxvZygnJXMgLSAlcycsIHRpbWVzdGFtcCgpLCBleHBvcnRzLmZvcm1hdC5hcHBseShleHBvcnRzLCBhcmd1bWVudHMpKTsKfTsKCgovKioKICogSW5oZXJpdCB0aGUgcHJvdG90eXBlIG1ldGhvZHMgZnJvbSBvbmUgY29uc3RydWN0b3IgaW50byBhbm90aGVyLgogKgogKiBUaGUgRnVuY3Rpb24ucHJvdG90eXBlLmluaGVyaXRzIGZyb20gbGFuZy5qcyByZXdyaXR0ZW4gYXMgYSBzdGFuZGFsb25lCiAqIGZ1bmN0aW9uIChub3Qgb24gRnVuY3Rpb24ucHJvdG90eXBlKS4gTk9URTogSWYgdGhpcyBmaWxlIGlzIHRvIGJlIGxvYWRlZAogKiBkdXJpbmcgYm9vdHN0cmFwcGluZyB0aGlzIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIHJld3JpdHRlbiB1c2luZyBzb21lIG5hdGl2ZQogKiBmdW5jdGlvbnMgYXMgcHJvdG90eXBlIHNldHVwIHVzaW5nIG5vcm1hbCBKYXZhU2NyaXB0IGRvZXMgbm90IHdvcmsgYXMKICogZXhwZWN0ZWQgZHVyaW5nIGJvb3RzdHJhcHBpbmcgKHNlZSBtaXJyb3IuanMgaW4gcjExNDkwMykuCiAqCiAqIEBwYXJhbSB7ZnVuY3Rpb259IGN0b3IgQ29uc3RydWN0b3IgZnVuY3Rpb24gd2hpY2ggbmVlZHMgdG8gaW5oZXJpdCB0aGUKICogICAgIHByb3RvdHlwZS4KICogQHBhcmFtIHtmdW5jdGlvbn0gc3VwZXJDdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIHRvIGluaGVyaXQgcHJvdG90eXBlIGZyb20uCiAqLwpleHBvcnRzLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCmV4cG9ydHMuX2V4dGVuZCA9IGZ1bmN0aW9uKG9yaWdpbiwgYWRkKSB7CiAgLy8gRG9uJ3QgZG8gYW55dGhpbmcgaWYgYWRkIGlzbid0IGFuIG9iamVjdAogIGlmICghYWRkIHx8ICFpc09iamVjdChhZGQpKSByZXR1cm4gb3JpZ2luOwoKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGFkZCk7CiAgdmFyIGkgPSBrZXlzLmxlbmd0aDsKICB3aGlsZSAoaS0tKSB7CiAgICBvcmlnaW5ba2V5c1tpXV0gPSBhZGRba2V5c1tpXV07CiAgfQogIHJldHVybiBvcmlnaW47Cn07CgpmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7Cn0KCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSx0eXBlb2YgX193ZWJwYWNrX3JlcXVpcmVfXy5nICE9PSAidW5kZWZpbmVkIiA/IF9fd2VicGFja19yZXF1aXJlX18uZyA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQp9LHsiLi9zdXBwb3J0L2lzQnVmZmVyIjo4MywiX3Byb2Nlc3MiOjkwLCJpbmhlcml0cyI6ODF9XSw4NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAoZ2xvYmFsLEJ1ZmZlcil7KGZ1bmN0aW9uICgpewovKiEKICogVGhlIGJ1ZmZlciBtb2R1bGUgZnJvbSBub2RlLmpzLCBmb3IgdGhlIGJyb3dzZXIuCiAqCiAqIEBhdXRob3IgICBGZXJvc3MgQWJvdWtoYWRpamVoIDxodHRwOi8vZmVyb3NzLm9yZz4KICogQGxpY2Vuc2UgIE1JVAogKi8KLyogZXNsaW50LWRpc2FibGUgbm8tcHJvdG8gKi8KCid1c2Ugc3RyaWN0JwoKdmFyIGJhc2U2NCA9IHJlcXVpcmUoJ2Jhc2U2NC1qcycpCnZhciBpZWVlNzU0ID0gcmVxdWlyZSgnaWVlZTc1NCcpCnZhciBpc0FycmF5ID0gcmVxdWlyZSgnaXNhcnJheScpCgpleHBvcnRzLkJ1ZmZlciA9IEJ1ZmZlcgpleHBvcnRzLlNsb3dCdWZmZXIgPSBTbG93QnVmZmVyCmV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMgPSA1MAoKLyoqCiAqIElmIGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGA6CiAqICAgPT09IHRydWUgICAgVXNlIFVpbnQ4QXJyYXkgaW1wbGVtZW50YXRpb24gKGZhc3Rlc3QpCiAqICAgPT09IGZhbHNlICAgVXNlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiAobW9zdCBjb21wYXRpYmxlLCBldmVuIElFNikKICoKICogQnJvd3NlcnMgdGhhdCBzdXBwb3J0IHR5cGVkIGFycmF5cyBhcmUgSUUgMTArLCBGaXJlZm94IDQrLCBDaHJvbWUgNyssIFNhZmFyaSA1LjErLAogKiBPcGVyYSAxMS42KywgaU9TIDQuMisuCiAqCiAqIER1ZSB0byB2YXJpb3VzIGJyb3dzZXIgYnVncywgc29tZXRpbWVzIHRoZSBPYmplY3QgaW1wbGVtZW50YXRpb24gd2lsbCBiZSB1c2VkIGV2ZW4KICogd2hlbiB0aGUgYnJvd3NlciBzdXBwb3J0cyB0eXBlZCBhcnJheXMuCiAqCiAqIE5vdGU6CiAqCiAqICAgLSBGaXJlZm94IDQtMjkgbGFja3Mgc3VwcG9ydCBmb3IgYWRkaW5nIG5ldyBwcm9wZXJ0aWVzIHRvIGBVaW50OEFycmF5YCBpbnN0YW5jZXMsCiAqICAgICBTZWU6IGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY5NTQzOC4KICoKICogICAtIENocm9tZSA5LTEwIGlzIG1pc3NpbmcgdGhlIGBUeXBlZEFycmF5LnByb3RvdHlwZS5zdWJhcnJheWAgZnVuY3Rpb24uCiAqCiAqICAgLSBJRTEwIGhhcyBhIGJyb2tlbiBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYXJyYXlzIG9mCiAqICAgICBpbmNvcnJlY3QgbGVuZ3RoIGluIHNvbWUgc2l0dWF0aW9ucy4KCiAqIFdlIGRldGVjdCB0aGVzZSBidWdneSBicm93c2VycyBhbmQgc2V0IGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGAgdG8gYGZhbHNlYCBzbyB0aGV5CiAqIGdldCB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uLCB3aGljaCBpcyBzbG93ZXIgYnV0IGJlaGF2ZXMgY29ycmVjdGx5LgogKi8KQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgPSBnbG9iYWwuVFlQRURfQVJSQVlfU1VQUE9SVCAhPT0gdW5kZWZpbmVkCiAgPyBnbG9iYWwuVFlQRURfQVJSQVlfU1VQUE9SVAogIDogdHlwZWRBcnJheVN1cHBvcnQoKQoKLyoKICogRXhwb3J0IGtNYXhMZW5ndGggYWZ0ZXIgdHlwZWQgYXJyYXkgc3VwcG9ydCBpcyBkZXRlcm1pbmVkLgogKi8KZXhwb3J0cy5rTWF4TGVuZ3RoID0ga01heExlbmd0aCgpCgpmdW5jdGlvbiB0eXBlZEFycmF5U3VwcG9ydCAoKSB7CiAgdHJ5IHsKICAgIHZhciBhcnIgPSBuZXcgVWludDhBcnJheSgxKQogICAgYXJyLl9fcHJvdG9fXyA9IHtfX3Byb3RvX186IFVpbnQ4QXJyYXkucHJvdG90eXBlLCBmb286IGZ1bmN0aW9uICgpIHsgcmV0dXJuIDQyIH19CiAgICByZXR1cm4gYXJyLmZvbygpID09PSA0MiAmJiAvLyB0eXBlZCBhcnJheSBpbnN0YW5jZXMgY2FuIGJlIGF1Z21lbnRlZAogICAgICAgIHR5cGVvZiBhcnIuc3ViYXJyYXkgPT09ICdmdW5jdGlvbicgJiYgLy8gY2hyb21lIDktMTAgbGFjayBgc3ViYXJyYXlgCiAgICAgICAgYXJyLnN1YmFycmF5KDEsIDEpLmJ5dGVMZW5ndGggPT09IDAgLy8gaWUxMCBoYXMgYnJva2VuIGBzdWJhcnJheWAKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gZmFsc2UKICB9Cn0KCmZ1bmN0aW9uIGtNYXhMZW5ndGggKCkgewogIHJldHVybiBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVAogICAgPyAweDdmZmZmZmZmCiAgICA6IDB4M2ZmZmZmZmYKfQoKZnVuY3Rpb24gY3JlYXRlQnVmZmVyICh0aGF0LCBsZW5ndGgpIHsKICBpZiAoa01heExlbmd0aCgpIDwgbGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCB0eXBlZCBhcnJheSBsZW5ndGgnKQogIH0KICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlLCBmb3IgYmVzdCBwZXJmb3JtYW5jZQogICAgdGhhdCA9IG5ldyBVaW50OEFycmF5KGxlbmd0aCkKICAgIHRoYXQuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogIH0gZWxzZSB7CiAgICAvLyBGYWxsYmFjazogUmV0dXJuIGFuIG9iamVjdCBpbnN0YW5jZSBvZiB0aGUgQnVmZmVyIGNsYXNzCiAgICBpZiAodGhhdCA9PT0gbnVsbCkgewogICAgICB0aGF0ID0gbmV3IEJ1ZmZlcihsZW5ndGgpCiAgICB9CiAgICB0aGF0Lmxlbmd0aCA9IGxlbmd0aAogIH0KCiAgcmV0dXJuIHRoYXQKfQoKLyoqCiAqIFRoZSBCdWZmZXIgY29uc3RydWN0b3IgcmV0dXJucyBpbnN0YW5jZXMgb2YgYFVpbnQ4QXJyYXlgIHRoYXQgaGF2ZSB0aGVpcgogKiBwcm90b3R5cGUgY2hhbmdlZCB0byBgQnVmZmVyLnByb3RvdHlwZWAuIEZ1cnRoZXJtb3JlLCBgQnVmZmVyYCBpcyBhIHN1YmNsYXNzIG9mCiAqIGBVaW50OEFycmF5YCwgc28gdGhlIHJldHVybmVkIGluc3RhbmNlcyB3aWxsIGhhdmUgYWxsIHRoZSBub2RlIGBCdWZmZXJgIG1ldGhvZHMKICogYW5kIHRoZSBgVWludDhBcnJheWAgbWV0aG9kcy4gU3F1YXJlIGJyYWNrZXQgbm90YXRpb24gd29ya3MgYXMgZXhwZWN0ZWQgLS0gaXQKICogcmV0dXJucyBhIHNpbmdsZSBvY3RldC4KICoKICogVGhlIGBVaW50OEFycmF5YCBwcm90b3R5cGUgcmVtYWlucyB1bm1vZGlmaWVkLgogKi8KCmZ1bmN0aW9uIEJ1ZmZlciAoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmICEodGhpcyBpbnN0YW5jZW9mIEJ1ZmZlcikpIHsKICAgIHJldHVybiBuZXcgQnVmZmVyKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KCiAgLy8gQ29tbW9uIGNhc2UuCiAgaWYgKHR5cGVvZiBhcmcgPT09ICdudW1iZXInKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nT3JPZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAnSWYgZW5jb2RpbmcgaXMgc3BlY2lmaWVkIHRoZW4gdGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnCiAgICAgICkKICAgIH0KICAgIHJldHVybiBhbGxvY1Vuc2FmZSh0aGlzLCBhcmcpCiAgfQogIHJldHVybiBmcm9tKHRoaXMsIGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQp9CgpCdWZmZXIucG9vbFNpemUgPSA4MTkyIC8vIG5vdCB1c2VkIGJ5IHRoaXMgaW1wbGVtZW50YXRpb24KCi8vIFRPRE86IExlZ2FjeSwgbm90IG5lZWRlZCBhbnltb3JlLiBSZW1vdmUgaW4gbmV4dCBtYWpvciB2ZXJzaW9uLgpCdWZmZXIuX2F1Z21lbnQgPSBmdW5jdGlvbiAoYXJyKSB7CiAgYXJyLl9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICByZXR1cm4gYXJyCn0KCmZ1bmN0aW9uIGZyb20gKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignInZhbHVlIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBhIG51bWJlcicpCiAgfQoKICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICByZXR1cm4gZnJvbUFycmF5QnVmZmVyKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgfQoKICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIGZyb21TdHJpbmcodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQpCiAgfQoKICByZXR1cm4gZnJvbU9iamVjdCh0aGF0LCB2YWx1ZSkKfQoKLyoqCiAqIEZ1bmN0aW9uYWxseSBlcXVpdmFsZW50IHRvIEJ1ZmZlcihhcmcsIGVuY29kaW5nKSBidXQgdGhyb3dzIGEgVHlwZUVycm9yCiAqIGlmIHZhbHVlIGlzIGEgbnVtYmVyLgogKiBCdWZmZXIuZnJvbShzdHJbLCBlbmNvZGluZ10pCiAqIEJ1ZmZlci5mcm9tKGFycmF5KQogKiBCdWZmZXIuZnJvbShidWZmZXIpCiAqIEJ1ZmZlci5mcm9tKGFycmF5QnVmZmVyWywgYnl0ZU9mZnNldFssIGxlbmd0aF1dKQogKiovCkJ1ZmZlci5mcm9tID0gZnVuY3Rpb24gKHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICByZXR1cm4gZnJvbShudWxsLCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQp9CgppZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICBCdWZmZXIucHJvdG90eXBlLl9fcHJvdG9fXyA9IFVpbnQ4QXJyYXkucHJvdG90eXBlCiAgQnVmZmVyLl9fcHJvdG9fXyA9IFVpbnQ4QXJyYXkKICBpZiAodHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcgJiYgU3ltYm9sLnNwZWNpZXMgJiYKICAgICAgQnVmZmVyW1N5bWJvbC5zcGVjaWVzXSA9PT0gQnVmZmVyKSB7CiAgICAvLyBGaXggc3ViYXJyYXkoKSBpbiBFUzIwMTYuIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2Zlcm9zcy9idWZmZXIvcHVsbC85NwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEJ1ZmZlciwgU3ltYm9sLnNwZWNpZXMsIHsKICAgICAgdmFsdWU6IG51bGwsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSkKICB9Cn0KCmZ1bmN0aW9uIGFzc2VydFNpemUgKHNpemUpIHsKICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpCiAgfSBlbHNlIGlmIChzaXplIDwgMCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBuZWdhdGl2ZScpCiAgfQp9CgpmdW5jdGlvbiBhbGxvYyAodGhhdCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICBhc3NlcnRTaXplKHNpemUpCiAgaWYgKHNpemUgPD0gMCkgewogICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKQogIH0KICBpZiAoZmlsbCAhPT0gdW5kZWZpbmVkKSB7CiAgICAvLyBPbmx5IHBheSBhdHRlbnRpb24gdG8gZW5jb2RpbmcgaWYgaXQncyBhIHN0cmluZy4gVGhpcwogICAgLy8gcHJldmVudHMgYWNjaWRlbnRhbGx5IHNlbmRpbmcgaW4gYSBudW1iZXIgdGhhdCB3b3VsZAogICAgLy8gYmUgaW50ZXJwcmV0dGVkIGFzIGEgc3RhcnQgb2Zmc2V0LgogICAgcmV0dXJuIHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycKICAgICAgPyBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkuZmlsbChmaWxsLCBlbmNvZGluZykKICAgICAgOiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkuZmlsbChmaWxsKQogIH0KICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpCn0KCi8qKgogKiBDcmVhdGVzIGEgbmV3IGZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAqIGFsbG9jKHNpemVbLCBmaWxsWywgZW5jb2RpbmddXSkKICoqLwpCdWZmZXIuYWxsb2MgPSBmdW5jdGlvbiAoc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICByZXR1cm4gYWxsb2MobnVsbCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpCn0KCmZ1bmN0aW9uIGFsbG9jVW5zYWZlICh0aGF0LCBzaXplKSB7CiAgYXNzZXJ0U2l6ZShzaXplKQogIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSA8IDAgPyAwIDogY2hlY2tlZChzaXplKSB8IDApCiAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaXplOyArK2kpIHsKICAgICAgdGhhdFtpXSA9IDAKICAgIH0KICB9CiAgcmV0dXJuIHRoYXQKfQoKLyoqCiAqIEVxdWl2YWxlbnQgdG8gQnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAqICovCkJ1ZmZlci5hbGxvY1Vuc2FmZSA9IGZ1bmN0aW9uIChzaXplKSB7CiAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCn0KLyoqCiAqIEVxdWl2YWxlbnQgdG8gU2xvd0J1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgogKi8KQnVmZmVyLmFsbG9jVW5zYWZlU2xvdyA9IGZ1bmN0aW9uIChzaXplKSB7CiAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCn0KCmZ1bmN0aW9uIGZyb21TdHJpbmcgKHRoYXQsIHN0cmluZywgZW5jb2RpbmcpIHsKICBpZiAodHlwZW9mIGVuY29kaW5nICE9PSAnc3RyaW5nJyB8fCBlbmNvZGluZyA9PT0gJycpIHsKICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgfQoKICBpZiAoIUJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImVuY29kaW5nIiBtdXN0IGJlIGEgdmFsaWQgc3RyaW5nIGVuY29kaW5nJykKICB9CgogIHZhciBsZW5ndGggPSBieXRlTGVuZ3RoKHN0cmluZywgZW5jb2RpbmcpIHwgMAogIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuZ3RoKQoKICB2YXIgYWN0dWFsID0gdGhhdC53cml0ZShzdHJpbmcsIGVuY29kaW5nKQoKICBpZiAoYWN0dWFsICE9PSBsZW5ndGgpIHsKICAgIC8vIFdyaXRpbmcgYSBoZXggc3RyaW5nLCBmb3IgZXhhbXBsZSwgdGhhdCBjb250YWlucyBpbnZhbGlkIGNoYXJhY3RlcnMgd2lsbAogICAgLy8gY2F1c2UgZXZlcnl0aGluZyBhZnRlciB0aGUgZmlyc3QgaW52YWxpZCBjaGFyYWN0ZXIgdG8gYmUgaWdub3JlZC4gKGUuZy4KICAgIC8vICdhYnh4Y2QnIHdpbGwgYmUgdHJlYXRlZCBhcyAnYWInKQogICAgdGhhdCA9IHRoYXQuc2xpY2UoMCwgYWN0dWFsKQogIH0KCiAgcmV0dXJuIHRoYXQKfQoKZnVuY3Rpb24gZnJvbUFycmF5TGlrZSAodGhhdCwgYXJyYXkpIHsKICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoIDwgMCA/IDAgOiBjaGVja2VkKGFycmF5Lmxlbmd0aCkgfCAwCiAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW5ndGgpCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgdGhhdFtpXSA9IGFycmF5W2ldICYgMjU1CiAgfQogIHJldHVybiB0aGF0Cn0KCmZ1bmN0aW9uIGZyb21BcnJheUJ1ZmZlciAodGhhdCwgYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkgewogIGFycmF5LmJ5dGVMZW5ndGggLy8gdGhpcyB0aHJvd3MgaWYgYGFycmF5YCBpcyBub3QgYSB2YWxpZCBBcnJheUJ1ZmZlcgoKICBpZiAoYnl0ZU9mZnNldCA8IDAgfHwgYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdcJ29mZnNldFwnIGlzIG91dCBvZiBib3VuZHMnKQogIH0KCiAgaWYgKGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0ICsgKGxlbmd0aCB8fCAwKSkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1wnbGVuZ3RoXCcgaXMgb3V0IG9mIGJvdW5kcycpCiAgfQoKICBpZiAoYnl0ZU9mZnNldCA9PT0gdW5kZWZpbmVkICYmIGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5KQogIH0gZWxzZSBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXksIGJ5dGVPZmZzZXQpCiAgfSBlbHNlIHsKICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkKICB9CgogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgLy8gUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UsIGZvciBiZXN0IHBlcmZvcm1hbmNlCiAgICB0aGF0ID0gYXJyYXkKICAgIHRoYXQuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogIH0gZWxzZSB7CiAgICAvLyBGYWxsYmFjazogUmV0dXJuIGFuIG9iamVjdCBpbnN0YW5jZSBvZiB0aGUgQnVmZmVyIGNsYXNzCiAgICB0aGF0ID0gZnJvbUFycmF5TGlrZSh0aGF0LCBhcnJheSkKICB9CiAgcmV0dXJuIHRoYXQKfQoKZnVuY3Rpb24gZnJvbU9iamVjdCAodGhhdCwgb2JqKSB7CiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihvYmopKSB7CiAgICB2YXIgbGVuID0gY2hlY2tlZChvYmoubGVuZ3RoKSB8IDAKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuKQoKICAgIGlmICh0aGF0Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdGhhdAogICAgfQoKICAgIG9iai5jb3B5KHRoYXQsIDAsIDAsIGxlbikKICAgIHJldHVybiB0aGF0CiAgfQoKICBpZiAob2JqKSB7CiAgICBpZiAoKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgICBvYmouYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHx8ICdsZW5ndGgnIGluIG9iaikgewogICAgICBpZiAodHlwZW9mIG9iai5sZW5ndGggIT09ICdudW1iZXInIHx8IGlzbmFuKG9iai5sZW5ndGgpKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCAwKQogICAgICB9CiAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKHRoYXQsIG9iaikKICAgIH0KCiAgICBpZiAob2JqLnR5cGUgPT09ICdCdWZmZXInICYmIGlzQXJyYXkob2JqLmRhdGEpKSB7CiAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKHRoYXQsIG9iai5kYXRhKQogICAgfQogIH0KCiAgdGhyb3cgbmV3IFR5cGVFcnJvcignRmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZywgQnVmZmVyLCBBcnJheUJ1ZmZlciwgQXJyYXksIG9yIGFycmF5LWxpa2Ugb2JqZWN0LicpCn0KCmZ1bmN0aW9uIGNoZWNrZWQgKGxlbmd0aCkgewogIC8vIE5vdGU6IGNhbm5vdCB1c2UgYGxlbmd0aCA8IGtNYXhMZW5ndGgoKWAgaGVyZSBiZWNhdXNlIHRoYXQgZmFpbHMgd2hlbgogIC8vIGxlbmd0aCBpcyBOYU4gKHdoaWNoIGlzIG90aGVyd2lzZSBjb2VyY2VkIHRvIHplcm8uKQogIGlmIChsZW5ndGggPj0ga01heExlbmd0aCgpKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byBhbGxvY2F0ZSBCdWZmZXIgbGFyZ2VyIHRoYW4gbWF4aW11bSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICdzaXplOiAweCcgKyBrTWF4TGVuZ3RoKCkudG9TdHJpbmcoMTYpICsgJyBieXRlcycpCiAgfQogIHJldHVybiBsZW5ndGggfCAwCn0KCmZ1bmN0aW9uIFNsb3dCdWZmZXIgKGxlbmd0aCkgewogIGlmICgrbGVuZ3RoICE9IGxlbmd0aCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGVxZXFlcQogICAgbGVuZ3RoID0gMAogIH0KICByZXR1cm4gQnVmZmVyLmFsbG9jKCtsZW5ndGgpCn0KCkJ1ZmZlci5pc0J1ZmZlciA9IGZ1bmN0aW9uIGlzQnVmZmVyIChiKSB7CiAgcmV0dXJuICEhKGIgIT0gbnVsbCAmJiBiLl9pc0J1ZmZlcikKfQoKQnVmZmVyLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlIChhLCBiKSB7CiAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYSkgfHwgIUJ1ZmZlci5pc0J1ZmZlcihiKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnRzIG11c3QgYmUgQnVmZmVycycpCiAgfQoKICBpZiAoYSA9PT0gYikgcmV0dXJuIDAKCiAgdmFyIHggPSBhLmxlbmd0aAogIHZhciB5ID0gYi5sZW5ndGgKCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IE1hdGgubWluKHgsIHkpOyBpIDwgbGVuOyArK2kpIHsKICAgIGlmIChhW2ldICE9PSBiW2ldKSB7CiAgICAgIHggPSBhW2ldCiAgICAgIHkgPSBiW2ldCiAgICAgIGJyZWFrCiAgICB9CiAgfQoKICBpZiAoeCA8IHkpIHJldHVybiAtMQogIGlmICh5IDwgeCkgcmV0dXJuIDEKICByZXR1cm4gMAp9CgpCdWZmZXIuaXNFbmNvZGluZyA9IGZ1bmN0aW9uIGlzRW5jb2RpbmcgKGVuY29kaW5nKSB7CiAgc3dpdGNoIChTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkpIHsKICAgIGNhc2UgJ2hleCc6CiAgICBjYXNlICd1dGY4JzoKICAgIGNhc2UgJ3V0Zi04JzoKICAgIGNhc2UgJ2FzY2lpJzoKICAgIGNhc2UgJ2xhdGluMSc6CiAgICBjYXNlICdiaW5hcnknOgogICAgY2FzZSAnYmFzZTY0JzoKICAgIGNhc2UgJ3VjczInOgogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndXRmMTZsZSc6CiAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgIHJldHVybiB0cnVlCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gZmFsc2UKICB9Cn0KCkJ1ZmZlci5jb25jYXQgPSBmdW5jdGlvbiBjb25jYXQgKGxpc3QsIGxlbmd0aCkgewogIGlmICghaXNBcnJheShsaXN0KSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCiAgfQoKICBpZiAobGlzdC5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBCdWZmZXIuYWxsb2MoMCkKICB9CgogIHZhciBpCiAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICBsZW5ndGggPSAwCiAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgICBsZW5ndGggKz0gbGlzdFtpXS5sZW5ndGgKICAgIH0KICB9CgogIHZhciBidWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUobGVuZ3RoKQogIHZhciBwb3MgPSAwCiAgZm9yIChpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyArK2kpIHsKICAgIHZhciBidWYgPSBsaXN0W2ldCiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihidWYpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKQogICAgfQogICAgYnVmLmNvcHkoYnVmZmVyLCBwb3MpCiAgICBwb3MgKz0gYnVmLmxlbmd0aAogIH0KICByZXR1cm4gYnVmZmVyCn0KCmZ1bmN0aW9uIGJ5dGVMZW5ndGggKHN0cmluZywgZW5jb2RpbmcpIHsKICBpZiAoQnVmZmVyLmlzQnVmZmVyKHN0cmluZykpIHsKICAgIHJldHVybiBzdHJpbmcubGVuZ3RoCiAgfQogIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBBcnJheUJ1ZmZlci5pc1ZpZXcgPT09ICdmdW5jdGlvbicgJiYKICAgICAgKEFycmF5QnVmZmVyLmlzVmlldyhzdHJpbmcpIHx8IHN0cmluZyBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSkgewogICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoCiAgfQogIGlmICh0eXBlb2Ygc3RyaW5nICE9PSAnc3RyaW5nJykgewogICAgc3RyaW5nID0gJycgKyBzdHJpbmcKICB9CgogIHZhciBsZW4gPSBzdHJpbmcubGVuZ3RoCiAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIDAKCiAgLy8gVXNlIGEgZm9yIGxvb3AgdG8gYXZvaWQgcmVjdXJzaW9uCiAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICBmb3IgKDs7KSB7CiAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICByZXR1cm4gbGVuCiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICBjYXNlICd1dGYtOCc6CiAgICAgIGNhc2UgdW5kZWZpbmVkOgogICAgICAgIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAogICAgICBjYXNlICd1Y3MyJzoKICAgICAgY2FzZSAndWNzLTInOgogICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgIHJldHVybiBsZW4gKiAyCiAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgcmV0dXJuIGxlbiA+Pj4gMQogICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIHJldHVybiBiYXNlNjRUb0J5dGVzKHN0cmluZykubGVuZ3RoCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSByZXR1cm4gdXRmOFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGggLy8gYXNzdW1lIHV0ZjgKICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICB9CiAgfQp9CkJ1ZmZlci5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAoKZnVuY3Rpb24gc2xvd1RvU3RyaW5nIChlbmNvZGluZywgc3RhcnQsIGVuZCkgewogIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCgogIC8vIE5vIG5lZWQgdG8gdmVyaWZ5IHRoYXQgInRoaXMubGVuZ3RoIDw9IE1BWF9VSU5UMzIiIHNpbmNlIGl0J3MgYSByZWFkLW9ubHkKICAvLyBwcm9wZXJ0eSBvZiBhIHR5cGVkIGFycmF5LgoKICAvLyBUaGlzIGJlaGF2ZXMgbmVpdGhlciBsaWtlIFN0cmluZyBub3IgVWludDhBcnJheSBpbiB0aGF0IHdlIHNldCBzdGFydC9lbmQKICAvLyB0byB0aGVpciB1cHBlci9sb3dlciBib3VuZHMgaWYgdGhlIHZhbHVlIHBhc3NlZCBpcyBvdXQgb2YgcmFuZ2UuCiAgLy8gdW5kZWZpbmVkIGlzIGhhbmRsZWQgc3BlY2lhbGx5IGFzIHBlciBFQ01BLTI2MiA2dGggRWRpdGlvbiwKICAvLyBTZWN0aW9uIDEzLjMuMy43IFJ1bnRpbWUgU2VtYW50aWNzOiBLZXllZEJpbmRpbmdJbml0aWFsaXphdGlvbi4KICBpZiAoc3RhcnQgPT09IHVuZGVmaW5lZCB8fCBzdGFydCA8IDApIHsKICAgIHN0YXJ0ID0gMAogIH0KICAvLyBSZXR1cm4gZWFybHkgaWYgc3RhcnQgPiB0aGlzLmxlbmd0aC4gRG9uZSBoZXJlIHRvIHByZXZlbnQgcG90ZW50aWFsIHVpbnQzMgogIC8vIGNvZXJjaW9uIGZhaWwgYmVsb3cuCiAgaWYgKHN0YXJ0ID4gdGhpcy5sZW5ndGgpIHsKICAgIHJldHVybiAnJwogIH0KCiAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkIHx8IGVuZCA+IHRoaXMubGVuZ3RoKSB7CiAgICBlbmQgPSB0aGlzLmxlbmd0aAogIH0KCiAgaWYgKGVuZCA8PSAwKSB7CiAgICByZXR1cm4gJycKICB9CgogIC8vIEZvcmNlIGNvZXJzaW9uIHRvIHVpbnQzMi4gVGhpcyB3aWxsIGFsc28gY29lcmNlIGZhbHNleS9OYU4gdmFsdWVzIHRvIDAuCiAgZW5kID4+Pj0gMAogIHN0YXJ0ID4+Pj0gMAoKICBpZiAoZW5kIDw9IHN0YXJ0KSB7CiAgICByZXR1cm4gJycKICB9CgogIGlmICghZW5jb2RpbmcpIGVuY29kaW5nID0gJ3V0ZjgnCgogIHdoaWxlICh0cnVlKSB7CiAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgcmV0dXJuIGhleFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBjYXNlICd1dGY4JzoKICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgIHJldHVybiB1dGY4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICByZXR1cm4gYXNjaWlTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICByZXR1cm4gbGF0aW4xU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgcmV0dXJuIGJhc2U2NFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBjYXNlICd1Y3MyJzoKICAgICAgY2FzZSAndWNzLTInOgogICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgIHJldHVybiB1dGYxNmxlU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgZW5jb2RpbmcgPSAoZW5jb2RpbmcgKyAnJykudG9Mb3dlckNhc2UoKQogICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgfQogIH0KfQoKLy8gVGhlIHByb3BlcnR5IGlzIHVzZWQgYnkgYEJ1ZmZlci5pc0J1ZmZlcmAgYW5kIGBpcy1idWZmZXJgIChpbiBTYWZhcmkgNS03KSB0byBkZXRlY3QKLy8gQnVmZmVyIGluc3RhbmNlcy4KQnVmZmVyLnByb3RvdHlwZS5faXNCdWZmZXIgPSB0cnVlCgpmdW5jdGlvbiBzd2FwIChiLCBuLCBtKSB7CiAgdmFyIGkgPSBiW25dCiAgYltuXSA9IGJbbV0KICBiW21dID0gaQp9CgpCdWZmZXIucHJvdG90eXBlLnN3YXAxNiA9IGZ1bmN0aW9uIHN3YXAxNiAoKSB7CiAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgaWYgKGxlbiAlIDIgIT09IDApIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMTYtYml0cycpCiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDIpIHsKICAgIHN3YXAodGhpcywgaSwgaSArIDEpCiAgfQogIHJldHVybiB0aGlzCn0KCkJ1ZmZlci5wcm90b3R5cGUuc3dhcDMyID0gZnVuY3Rpb24gc3dhcDMyICgpIHsKICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICBpZiAobGVuICUgNCAhPT0gMCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzJykKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewogICAgc3dhcCh0aGlzLCBpLCBpICsgMykKICAgIHN3YXAodGhpcywgaSArIDEsIGkgKyAyKQogIH0KICByZXR1cm4gdGhpcwp9CgpCdWZmZXIucHJvdG90eXBlLnN3YXA2NCA9IGZ1bmN0aW9uIHN3YXA2NCAoKSB7CiAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgaWYgKGxlbiAlIDggIT09IDApIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNjQtYml0cycpCiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDgpIHsKICAgIHN3YXAodGhpcywgaSwgaSArIDcpCiAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgNikKICAgIHN3YXAodGhpcywgaSArIDIsIGkgKyA1KQogICAgc3dhcCh0aGlzLCBpICsgMywgaSArIDQpCiAgfQogIHJldHVybiB0aGlzCn0KCkJ1ZmZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZyAoKSB7CiAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoIHwgMAogIGlmIChsZW5ndGggPT09IDApIHJldHVybiAnJwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIDAsIGxlbmd0aCkKICByZXR1cm4gc2xvd1RvU3RyaW5nLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKfQoKQnVmZmVyLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbiBlcXVhbHMgKGIpIHsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihiKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlcicpCiAgaWYgKHRoaXMgPT09IGIpIHJldHVybiB0cnVlCiAgcmV0dXJuIEJ1ZmZlci5jb21wYXJlKHRoaXMsIGIpID09PSAwCn0KCkJ1ZmZlci5wcm90b3R5cGUuaW5zcGVjdCA9IGZ1bmN0aW9uIGluc3BlY3QgKCkgewogIHZhciBzdHIgPSAnJwogIHZhciBtYXggPSBleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTCiAgaWYgKHRoaXMubGVuZ3RoID4gMCkgewogICAgc3RyID0gdGhpcy50b1N0cmluZygnaGV4JywgMCwgbWF4KS5tYXRjaCgvLnsyfS9nKS5qb2luKCcgJykKICAgIGlmICh0aGlzLmxlbmd0aCA+IG1heCkgc3RyICs9ICcgLi4uICcKICB9CiAgcmV0dXJuICc8QnVmZmVyICcgKyBzdHIgKyAnPicKfQoKQnVmZmVyLnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSAodGFyZ2V0LCBzdGFydCwgZW5kLCB0aGlzU3RhcnQsIHRoaXNFbmQpIHsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcih0YXJnZXQpKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICB9CgogIGlmIChzdGFydCA9PT0gdW5kZWZpbmVkKSB7CiAgICBzdGFydCA9IDAKICB9CiAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICBlbmQgPSB0YXJnZXQgPyB0YXJnZXQubGVuZ3RoIDogMAogIH0KICBpZiAodGhpc1N0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNTdGFydCA9IDAKICB9CiAgaWYgKHRoaXNFbmQgPT09IHVuZGVmaW5lZCkgewogICAgdGhpc0VuZCA9IHRoaXMubGVuZ3RoCiAgfQoKICBpZiAoc3RhcnQgPCAwIHx8IGVuZCA+IHRhcmdldC5sZW5ndGggfHwgdGhpc1N0YXJ0IDwgMCB8fCB0aGlzRW5kID4gdGhpcy5sZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvdXQgb2YgcmFuZ2UgaW5kZXgnKQogIH0KCiAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kICYmIHN0YXJ0ID49IGVuZCkgewogICAgcmV0dXJuIDAKICB9CiAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kKSB7CiAgICByZXR1cm4gLTEKICB9CiAgaWYgKHN0YXJ0ID49IGVuZCkgewogICAgcmV0dXJuIDEKICB9CgogIHN0YXJ0ID4+Pj0gMAogIGVuZCA+Pj49IDAKICB0aGlzU3RhcnQgPj4+PSAwCiAgdGhpc0VuZCA+Pj49IDAKCiAgaWYgKHRoaXMgPT09IHRhcmdldCkgcmV0dXJuIDAKCiAgdmFyIHggPSB0aGlzRW5kIC0gdGhpc1N0YXJ0CiAgdmFyIHkgPSBlbmQgLSBzdGFydAogIHZhciBsZW4gPSBNYXRoLm1pbih4LCB5KQoKICB2YXIgdGhpc0NvcHkgPSB0aGlzLnNsaWNlKHRoaXNTdGFydCwgdGhpc0VuZCkKICB2YXIgdGFyZ2V0Q29weSA9IHRhcmdldC5zbGljZShzdGFydCwgZW5kKQoKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICBpZiAodGhpc0NvcHlbaV0gIT09IHRhcmdldENvcHlbaV0pIHsKICAgICAgeCA9IHRoaXNDb3B5W2ldCiAgICAgIHkgPSB0YXJnZXRDb3B5W2ldCiAgICAgIGJyZWFrCiAgICB9CiAgfQoKICBpZiAoeCA8IHkpIHJldHVybiAtMQogIGlmICh5IDwgeCkgcmV0dXJuIDEKICByZXR1cm4gMAp9CgovLyBGaW5kcyBlaXRoZXIgdGhlIGZpcnN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA+PSBgYnl0ZU9mZnNldGAsCi8vIE9SIHRoZSBsYXN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA8PSBgYnl0ZU9mZnNldGAuCi8vCi8vIEFyZ3VtZW50czoKLy8gLSBidWZmZXIgLSBhIEJ1ZmZlciB0byBzZWFyY2gKLy8gLSB2YWwgLSBhIHN0cmluZywgQnVmZmVyLCBvciBudW1iZXIKLy8gLSBieXRlT2Zmc2V0IC0gYW4gaW5kZXggaW50byBgYnVmZmVyYDsgd2lsbCBiZSBjbGFtcGVkIHRvIGFuIGludDMyCi8vIC0gZW5jb2RpbmcgLSBhbiBvcHRpb25hbCBlbmNvZGluZywgcmVsZXZhbnQgaXMgdmFsIGlzIGEgc3RyaW5nCi8vIC0gZGlyIC0gdHJ1ZSBmb3IgaW5kZXhPZiwgZmFsc2UgZm9yIGxhc3RJbmRleE9mCmZ1bmN0aW9uIGJpZGlyZWN0aW9uYWxJbmRleE9mIChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewogIC8vIEVtcHR5IGJ1ZmZlciBtZWFucyBubyBtYXRjaAogIGlmIChidWZmZXIubGVuZ3RoID09PSAwKSByZXR1cm4gLTEKCiAgLy8gTm9ybWFsaXplIGJ5dGVPZmZzZXQKICBpZiAodHlwZW9mIGJ5dGVPZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICBlbmNvZGluZyA9IGJ5dGVPZmZzZXQKICAgIGJ5dGVPZmZzZXQgPSAwCiAgfSBlbHNlIGlmIChieXRlT2Zmc2V0ID4gMHg3ZmZmZmZmZikgewogICAgYnl0ZU9mZnNldCA9IDB4N2ZmZmZmZmYKICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPCAtMHg4MDAwMDAwMCkgewogICAgYnl0ZU9mZnNldCA9IC0weDgwMDAwMDAwCiAgfQogIGJ5dGVPZmZzZXQgPSArYnl0ZU9mZnNldCAgLy8gQ29lcmNlIHRvIE51bWJlci4KICBpZiAoaXNOYU4oYnl0ZU9mZnNldCkpIHsKICAgIC8vIGJ5dGVPZmZzZXQ6IGl0IGl0J3MgdW5kZWZpbmVkLCBudWxsLCBOYU4sICJmb28iLCBldGMsIHNlYXJjaCB3aG9sZSBidWZmZXIKICAgIGJ5dGVPZmZzZXQgPSBkaXIgPyAwIDogKGJ1ZmZlci5sZW5ndGggLSAxKQogIH0KCiAgLy8gTm9ybWFsaXplIGJ5dGVPZmZzZXQ6IG5lZ2F0aXZlIG9mZnNldHMgc3RhcnQgZnJvbSB0aGUgZW5kIG9mIHRoZSBidWZmZXIKICBpZiAoYnl0ZU9mZnNldCA8IDApIGJ5dGVPZmZzZXQgPSBidWZmZXIubGVuZ3RoICsgYnl0ZU9mZnNldAogIGlmIChieXRlT2Zmc2V0ID49IGJ1ZmZlci5sZW5ndGgpIHsKICAgIGlmIChkaXIpIHJldHVybiAtMQogICAgZWxzZSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCAtIDEKICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPCAwKSB7CiAgICBpZiAoZGlyKSBieXRlT2Zmc2V0ID0gMAogICAgZWxzZSByZXR1cm4gLTEKICB9CgogIC8vIE5vcm1hbGl6ZSB2YWwKICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIHZhbCA9IEJ1ZmZlci5mcm9tKHZhbCwgZW5jb2RpbmcpCiAgfQoKICAvLyBGaW5hbGx5LCBzZWFyY2ggZWl0aGVyIGluZGV4T2YgKGlmIGRpciBpcyB0cnVlKSBvciBsYXN0SW5kZXhPZgogIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsKSkgewogICAgLy8gU3BlY2lhbCBjYXNlOiBsb29raW5nIGZvciBlbXB0eSBzdHJpbmcvYnVmZmVyIGFsd2F5cyBmYWlscwogICAgaWYgKHZhbC5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIC0xCiAgICB9CiAgICByZXR1cm4gYXJyYXlJbmRleE9mKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQogIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgIHZhbCA9IHZhbCAmIDB4RkYgLy8gU2VhcmNoIGZvciBhIGJ5dGUgdmFsdWUgWzAtMjU1XQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmCiAgICAgICAgdHlwZW9mIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT09ICdmdW5jdGlvbicpIHsKICAgICAgaWYgKGRpcikgewogICAgICAgIHJldHVybiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQpCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmxhc3RJbmRleE9mLmNhbGwoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQpCiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhcnJheUluZGV4T2YoYnVmZmVyLCBbIHZhbCBdLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQogIH0KCiAgdGhyb3cgbmV3IFR5cGVFcnJvcigndmFsIG11c3QgYmUgc3RyaW5nLCBudW1iZXIgb3IgQnVmZmVyJykKfQoKZnVuY3Rpb24gYXJyYXlJbmRleE9mIChhcnIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewogIHZhciBpbmRleFNpemUgPSAxCiAgdmFyIGFyckxlbmd0aCA9IGFyci5sZW5ndGgKICB2YXIgdmFsTGVuZ3RoID0gdmFsLmxlbmd0aAoKICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCkgewogICAgZW5jb2RpbmcgPSBTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgIGlmIChlbmNvZGluZyA9PT0gJ3VjczInIHx8IGVuY29kaW5nID09PSAndWNzLTInIHx8CiAgICAgICAgZW5jb2RpbmcgPT09ICd1dGYxNmxlJyB8fCBlbmNvZGluZyA9PT0gJ3V0Zi0xNmxlJykgewogICAgICBpZiAoYXJyLmxlbmd0aCA8IDIgfHwgdmFsLmxlbmd0aCA8IDIpIHsKICAgICAgICByZXR1cm4gLTEKICAgICAgfQogICAgICBpbmRleFNpemUgPSAyCiAgICAgIGFyckxlbmd0aCAvPSAyCiAgICAgIHZhbExlbmd0aCAvPSAyCiAgICAgIGJ5dGVPZmZzZXQgLz0gMgogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVhZCAoYnVmLCBpKSB7CiAgICBpZiAoaW5kZXhTaXplID09PSAxKSB7CiAgICAgIHJldHVybiBidWZbaV0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBidWYucmVhZFVJbnQxNkJFKGkgKiBpbmRleFNpemUpCiAgICB9CiAgfQoKICB2YXIgaQogIGlmIChkaXIpIHsKICAgIHZhciBmb3VuZEluZGV4ID0gLTEKICAgIGZvciAoaSA9IGJ5dGVPZmZzZXQ7IGkgPCBhcnJMZW5ndGg7IGkrKykgewogICAgICBpZiAocmVhZChhcnIsIGkpID09PSByZWFkKHZhbCwgZm91bmRJbmRleCA9PT0gLTEgPyAwIDogaSAtIGZvdW5kSW5kZXgpKSB7CiAgICAgICAgaWYgKGZvdW5kSW5kZXggPT09IC0xKSBmb3VuZEluZGV4ID0gaQogICAgICAgIGlmIChpIC0gZm91bmRJbmRleCArIDEgPT09IHZhbExlbmd0aCkgcmV0dXJuIGZvdW5kSW5kZXggKiBpbmRleFNpemUKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZm91bmRJbmRleCAhPT0gLTEpIGkgLT0gaSAtIGZvdW5kSW5kZXgKICAgICAgICBmb3VuZEluZGV4ID0gLTEKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoYnl0ZU9mZnNldCArIHZhbExlbmd0aCA+IGFyckxlbmd0aCkgYnl0ZU9mZnNldCA9IGFyckxlbmd0aCAtIHZhbExlbmd0aAogICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA+PSAwOyBpLS0pIHsKICAgICAgdmFyIGZvdW5kID0gdHJ1ZQogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHZhbExlbmd0aDsgaisrKSB7CiAgICAgICAgaWYgKHJlYWQoYXJyLCBpICsgaikgIT09IHJlYWQodmFsLCBqKSkgewogICAgICAgICAgZm91bmQgPSBmYWxzZQogICAgICAgICAgYnJlYWsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGZvdW5kKSByZXR1cm4gaQogICAgfQogIH0KCiAgcmV0dXJuIC0xCn0KCkJ1ZmZlci5wcm90b3R5cGUuaW5jbHVkZXMgPSBmdW5jdGlvbiBpbmNsdWRlcyAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiB0aGlzLmluZGV4T2YodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgIT09IC0xCn0KCkJ1ZmZlci5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uIGluZGV4T2YgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICByZXR1cm4gYmlkaXJlY3Rpb25hbEluZGV4T2YodGhpcywgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgdHJ1ZSkKfQoKQnVmZmVyLnByb3RvdHlwZS5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uIGxhc3RJbmRleE9mICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGZhbHNlKQp9CgpmdW5jdGlvbiBoZXhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgb2Zmc2V0ID0gTnVtYmVyKG9mZnNldCkgfHwgMAogIHZhciByZW1haW5pbmcgPSBidWYubGVuZ3RoIC0gb2Zmc2V0CiAgaWYgKCFsZW5ndGgpIHsKICAgIGxlbmd0aCA9IHJlbWFpbmluZwogIH0gZWxzZSB7CiAgICBsZW5ndGggPSBOdW1iZXIobGVuZ3RoKQogICAgaWYgKGxlbmd0aCA+IHJlbWFpbmluZykgewogICAgICBsZW5ndGggPSByZW1haW5pbmcKICAgIH0KICB9CgogIC8vIG11c3QgYmUgYW4gZXZlbiBudW1iZXIgb2YgZGlnaXRzCiAgdmFyIHN0ckxlbiA9IHN0cmluZy5sZW5ndGgKICBpZiAoc3RyTGVuICUgMiAhPT0gMCkgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBoZXggc3RyaW5nJykKCiAgaWYgKGxlbmd0aCA+IHN0ckxlbiAvIDIpIHsKICAgIGxlbmd0aCA9IHN0ckxlbiAvIDIKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgdmFyIHBhcnNlZCA9IHBhcnNlSW50KHN0cmluZy5zdWJzdHIoaSAqIDIsIDIpLCAxNikKICAgIGlmIChpc05hTihwYXJzZWQpKSByZXR1cm4gaQogICAgYnVmW29mZnNldCArIGldID0gcGFyc2VkCiAgfQogIHJldHVybiBpCn0KCmZ1bmN0aW9uIHV0ZjhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgcmV0dXJuIGJsaXRCdWZmZXIodXRmOFRvQnl0ZXMoc3RyaW5nLCBidWYubGVuZ3RoIC0gb2Zmc2V0KSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKfQoKZnVuY3Rpb24gYXNjaWlXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgcmV0dXJuIGJsaXRCdWZmZXIoYXNjaWlUb0J5dGVzKHN0cmluZyksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCn0KCmZ1bmN0aW9uIGxhdGluMVdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICByZXR1cm4gYXNjaWlXcml0ZShidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCn0KCmZ1bmN0aW9uIGJhc2U2NFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICByZXR1cm4gYmxpdEJ1ZmZlcihiYXNlNjRUb0J5dGVzKHN0cmluZyksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCn0KCmZ1bmN0aW9uIHVjczJXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgcmV0dXJuIGJsaXRCdWZmZXIodXRmMTZsZVRvQnl0ZXMoc3RyaW5nLCBidWYubGVuZ3RoIC0gb2Zmc2V0KSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlIChzdHJpbmcsIG9mZnNldCwgbGVuZ3RoLCBlbmNvZGluZykgewogIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcpCiAgaWYgKG9mZnNldCA9PT0gdW5kZWZpbmVkKSB7CiAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgIG9mZnNldCA9IDAKICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nLCBlbmNvZGluZykKICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICBlbmNvZGluZyA9IG9mZnNldAogICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgIG9mZnNldCA9IDAKICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nLCBvZmZzZXRbLCBsZW5ndGhdWywgZW5jb2RpbmddKQogIH0gZWxzZSBpZiAoaXNGaW5pdGUob2Zmc2V0KSkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKGlzRmluaXRlKGxlbmd0aCkpIHsKICAgICAgbGVuZ3RoID0gbGVuZ3RoIHwgMAogICAgICBpZiAoZW5jb2RpbmcgPT09IHVuZGVmaW5lZCkgZW5jb2RpbmcgPSAndXRmOCcKICAgIH0gZWxzZSB7CiAgICAgIGVuY29kaW5nID0gbGVuZ3RoCiAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZAogICAgfQogIC8vIGxlZ2FjeSB3cml0ZShzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXQsIGxlbmd0aCkgLSByZW1vdmUgaW4gdjAuMTMKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAnQnVmZmVyLndyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldFssIGxlbmd0aF0pIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQnCiAgICApCiAgfQoKICB2YXIgcmVtYWluaW5nID0gdGhpcy5sZW5ndGggLSBvZmZzZXQKICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgfHwgbGVuZ3RoID4gcmVtYWluaW5nKSBsZW5ndGggPSByZW1haW5pbmcKCiAgaWYgKChzdHJpbmcubGVuZ3RoID4gMCAmJiAobGVuZ3RoIDwgMCB8fCBvZmZzZXQgPCAwKSkgfHwgb2Zmc2V0ID4gdGhpcy5sZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIHdyaXRlIG91dHNpZGUgYnVmZmVyIGJvdW5kcycpCiAgfQoKICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwoKICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogIGZvciAoOzspIHsKICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgY2FzZSAnaGV4JzoKICAgICAgICByZXR1cm4gaGV4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgcmV0dXJuIHV0ZjhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQoKICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgIHJldHVybiBhc2NpaVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgogICAgICBjYXNlICdsYXRpbjEnOgogICAgICBjYXNlICdiaW5hcnknOgogICAgICAgIHJldHVybiBsYXRpbjFXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQoKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICAvLyBXYXJuaW5nOiBtYXhMZW5ndGggbm90IHRha2VuIGludG8gYWNjb3VudCBpbiBiYXNlNjRXcml0ZQogICAgICAgIHJldHVybiBiYXNlNjRXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQoKICAgICAgY2FzZSAndWNzMic6CiAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICByZXR1cm4gdWNzMldyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgogICAgICBkZWZhdWx0OgogICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICAgIGVuY29kaW5nID0gKCcnICsgZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgIH0KICB9Cn0KCkJ1ZmZlci5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OICgpIHsKICByZXR1cm4gewogICAgdHlwZTogJ0J1ZmZlcicsCiAgICBkYXRhOiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9hcnIgfHwgdGhpcywgMCkKICB9Cn0KCmZ1bmN0aW9uIGJhc2U2NFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICBpZiAoc3RhcnQgPT09IDAgJiYgZW5kID09PSBidWYubGVuZ3RoKSB7CiAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmKQogIH0gZWxzZSB7CiAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmLnNsaWNlKHN0YXJ0LCBlbmQpKQogIH0KfQoKZnVuY3Rpb24gdXRmOFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgdmFyIHJlcyA9IFtdCgogIHZhciBpID0gc3RhcnQKICB3aGlsZSAoaSA8IGVuZCkgewogICAgdmFyIGZpcnN0Qnl0ZSA9IGJ1ZltpXQogICAgdmFyIGNvZGVQb2ludCA9IG51bGwKICAgIHZhciBieXRlc1BlclNlcXVlbmNlID0gKGZpcnN0Qnl0ZSA+IDB4RUYpID8gNAogICAgICA6IChmaXJzdEJ5dGUgPiAweERGKSA/IDMKICAgICAgOiAoZmlyc3RCeXRlID4gMHhCRikgPyAyCiAgICAgIDogMQoKICAgIGlmIChpICsgYnl0ZXNQZXJTZXF1ZW5jZSA8PSBlbmQpIHsKICAgICAgdmFyIHNlY29uZEJ5dGUsIHRoaXJkQnl0ZSwgZm91cnRoQnl0ZSwgdGVtcENvZGVQb2ludAoKICAgICAgc3dpdGNoIChieXRlc1BlclNlcXVlbmNlKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgaWYgKGZpcnN0Qnl0ZSA8IDB4ODApIHsKICAgICAgICAgICAgY29kZVBvaW50ID0gZmlyc3RCeXRlCiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgMjoKICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4MUYpIDw8IDB4NiB8IChzZWNvbmRCeXRlICYgMHgzRikKICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweDdGKSB7CiAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgMzoKICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICB0aGlyZEJ5dGUgPSBidWZbaSArIDJdCiAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAodGhpcmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweEYpIDw8IDB4QyB8IChzZWNvbmRCeXRlICYgMHgzRikgPDwgMHg2IHwgKHRoaXJkQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHg3RkYgJiYgKHRlbXBDb2RlUG9pbnQgPCAweEQ4MDAgfHwgdGVtcENvZGVQb2ludCA+IDB4REZGRikpIHsKICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSA0OgogICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl0KICAgICAgICAgIGZvdXJ0aEJ5dGUgPSBidWZbaSArIDNdCiAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAodGhpcmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKGZvdXJ0aEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHgxMiB8IChzZWNvbmRCeXRlICYgMHgzRikgPDwgMHhDIHwgKHRoaXJkQnl0ZSAmIDB4M0YpIDw8IDB4NiB8IChmb3VydGhCeXRlICYgMHgzRikKICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweEZGRkYgJiYgdGVtcENvZGVQb2ludCA8IDB4MTEwMDAwKSB7CiAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAoY29kZVBvaW50ID09PSBudWxsKSB7CiAgICAgIC8vIHdlIGRpZCBub3QgZ2VuZXJhdGUgYSB2YWxpZCBjb2RlUG9pbnQgc28gaW5zZXJ0IGEKICAgICAgLy8gcmVwbGFjZW1lbnQgY2hhciAoVStGRkZEKSBhbmQgYWR2YW5jZSBvbmx5IDEgYnl0ZQogICAgICBjb2RlUG9pbnQgPSAweEZGRkQKICAgICAgYnl0ZXNQZXJTZXF1ZW5jZSA9IDEKICAgIH0gZWxzZSBpZiAoY29kZVBvaW50ID4gMHhGRkZGKSB7CiAgICAgIC8vIGVuY29kZSB0byB1dGYxNiAoc3Vycm9nYXRlIHBhaXIgZGFuY2UpCiAgICAgIGNvZGVQb2ludCAtPSAweDEwMDAwCiAgICAgIHJlcy5wdXNoKGNvZGVQb2ludCA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCkKICAgICAgY29kZVBvaW50ID0gMHhEQzAwIHwgY29kZVBvaW50ICYgMHgzRkYKICAgIH0KCiAgICByZXMucHVzaChjb2RlUG9pbnQpCiAgICBpICs9IGJ5dGVzUGVyU2VxdWVuY2UKICB9CgogIHJldHVybiBkZWNvZGVDb2RlUG9pbnRzQXJyYXkocmVzKQp9CgovLyBCYXNlZCBvbiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8yMjc0NzI3Mi82ODA3NDIsIHRoZSBicm93c2VyIHdpdGgKLy8gdGhlIGxvd2VzdCBsaW1pdCBpcyBDaHJvbWUsIHdpdGggMHgxMDAwMCBhcmdzLgovLyBXZSBnbyAxIG1hZ25pdHVkZSBsZXNzLCBmb3Igc2FmZXR5CnZhciBNQVhfQVJHVU1FTlRTX0xFTkdUSCA9IDB4MTAwMAoKZnVuY3Rpb24gZGVjb2RlQ29kZVBvaW50c0FycmF5IChjb2RlUG9pbnRzKSB7CiAgdmFyIGxlbiA9IGNvZGVQb2ludHMubGVuZ3RoCiAgaWYgKGxlbiA8PSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkgewogICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBjb2RlUG9pbnRzKSAvLyBhdm9pZCBleHRyYSBzbGljZSgpCiAgfQoKICAvLyBEZWNvZGUgaW4gY2h1bmtzIHRvIGF2b2lkICJjYWxsIHN0YWNrIHNpemUgZXhjZWVkZWQiLgogIHZhciByZXMgPSAnJwogIHZhciBpID0gMAogIHdoaWxlIChpIDwgbGVuKSB7CiAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseSgKICAgICAgU3RyaW5nLAogICAgICBjb2RlUG9pbnRzLnNsaWNlKGksIGkgKz0gTUFYX0FSR1VNRU5UU19MRU5HVEgpCiAgICApCiAgfQogIHJldHVybiByZXMKfQoKZnVuY3Rpb24gYXNjaWlTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJldCA9ICcnCiAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQoKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldICYgMHg3RikKICB9CiAgcmV0dXJuIHJldAp9CgpmdW5jdGlvbiBsYXRpbjFTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJldCA9ICcnCiAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQoKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldKQogIH0KICByZXR1cm4gcmV0Cn0KCmZ1bmN0aW9uIGhleFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICB2YXIgbGVuID0gYnVmLmxlbmd0aAoKICBpZiAoIXN0YXJ0IHx8IHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgaWYgKCFlbmQgfHwgZW5kIDwgMCB8fCBlbmQgPiBsZW4pIGVuZCA9IGxlbgoKICB2YXIgb3V0ID0gJycKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgb3V0ICs9IHRvSGV4KGJ1ZltpXSkKICB9CiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiB1dGYxNmxlU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIHZhciBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKQogIHZhciByZXMgPSAnJwogIGZvciAodmFyIGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoOyBpICs9IDIpIHsKICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldICsgYnl0ZXNbaSArIDFdICogMjU2KQogIH0KICByZXR1cm4gcmVzCn0KCkJ1ZmZlci5wcm90b3R5cGUuc2xpY2UgPSBmdW5jdGlvbiBzbGljZSAoc3RhcnQsIGVuZCkgewogIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogIHN0YXJ0ID0gfn5zdGFydAogIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gbGVuIDogfn5lbmQKCiAgaWYgKHN0YXJ0IDwgMCkgewogICAgc3RhcnQgKz0gbGVuCiAgICBpZiAoc3RhcnQgPCAwKSBzdGFydCA9IDAKICB9IGVsc2UgaWYgKHN0YXJ0ID4gbGVuKSB7CiAgICBzdGFydCA9IGxlbgogIH0KCiAgaWYgKGVuZCA8IDApIHsKICAgIGVuZCArPSBsZW4KICAgIGlmIChlbmQgPCAwKSBlbmQgPSAwCiAgfSBlbHNlIGlmIChlbmQgPiBsZW4pIHsKICAgIGVuZCA9IGxlbgogIH0KCiAgaWYgKGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydAoKICB2YXIgbmV3QnVmCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICBuZXdCdWYgPSB0aGlzLnN1YmFycmF5KHN0YXJ0LCBlbmQpCiAgICBuZXdCdWYuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogIH0gZWxzZSB7CiAgICB2YXIgc2xpY2VMZW4gPSBlbmQgLSBzdGFydAogICAgbmV3QnVmID0gbmV3IEJ1ZmZlcihzbGljZUxlbiwgdW5kZWZpbmVkKQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzbGljZUxlbjsgKytpKSB7CiAgICAgIG5ld0J1ZltpXSA9IHRoaXNbaSArIHN0YXJ0XQogICAgfQogIH0KCiAgcmV0dXJuIG5ld0J1Zgp9CgovKgogKiBOZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IGJ1ZmZlciBpc24ndCB0cnlpbmcgdG8gd3JpdGUgb3V0IG9mIGJvdW5kcy4KICovCmZ1bmN0aW9uIGNoZWNrT2Zmc2V0IChvZmZzZXQsIGV4dCwgbGVuZ3RoKSB7CiAgaWYgKChvZmZzZXQgJSAxKSAhPT0gMCB8fCBvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG5vdCB1aW50JykKICBpZiAob2Zmc2V0ICsgZXh0ID4gbGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignVHJ5aW5nIHRvIGFjY2VzcyBiZXlvbmQgYnVmZmVyIGxlbmd0aCcpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRMRSA9IGZ1bmN0aW9uIHJlYWRVSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XQogIHZhciBtdWwgPSAxCiAgdmFyIGkgPSAwCiAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsCiAgfQoKICByZXR1cm4gdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRCRSA9IGZ1bmN0aW9uIHJlYWRVSW50QkUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgaWYgKCFub0Fzc2VydCkgewogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICB9CgogIHZhciB2YWwgPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aF0KICB2YXIgbXVsID0gMQogIHdoaWxlIChieXRlTGVuZ3RoID4gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoXSAqIG11bAogIH0KCiAgcmV0dXJuIHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50OCA9IGZ1bmN0aW9uIHJlYWRVSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIHRoaXNbb2Zmc2V0XQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MTZMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkJFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCA4KSB8IHRoaXNbb2Zmc2V0ICsgMV0KfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyTEUgPSBmdW5jdGlvbiByZWFkVUludDMyTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKCh0aGlzW29mZnNldF0pIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikpICsKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gKiAweDEwMDAwMDApCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkJFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICh0aGlzW29mZnNldF0gKiAweDEwMDAwMDApICsKICAgICgodGhpc1tvZmZzZXQgKyAxXSA8PCAxNikgfAogICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgdGhpc1tvZmZzZXQgKyAzXSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50TEUgPSBmdW5jdGlvbiByZWFkSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XQogIHZhciBtdWwgPSAxCiAgdmFyIGkgPSAwCiAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsCiAgfQogIG11bCAqPSAweDgwCgogIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCgogIHJldHVybiB2YWwKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50QkUgPSBmdW5jdGlvbiByZWFkSW50QkUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKCiAgdmFyIGkgPSBieXRlTGVuZ3RoCiAgdmFyIG11bCA9IDEKICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWldCiAgd2hpbGUgKGkgPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWldICogbXVsCiAgfQogIG11bCAqPSAweDgwCgogIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCgogIHJldHVybiB2YWwKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50OCA9IGZ1bmN0aW9uIHJlYWRJbnQ4IChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCkKICBpZiAoISh0aGlzW29mZnNldF0gJiAweDgwKSkgcmV0dXJuICh0aGlzW29mZnNldF0pCiAgcmV0dXJuICgoMHhmZiAtIHRoaXNbb2Zmc2V0XSArIDEpICogLTEpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludDE2TEUgPSBmdW5jdGlvbiByZWFkSW50MTZMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkJFID0gZnVuY3Rpb24gcmVhZEludDE2QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogIHZhciB2YWwgPSB0aGlzW29mZnNldCArIDFdIHwgKHRoaXNbb2Zmc2V0XSA8PCA4KQogIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICh0aGlzW29mZnNldF0pIHwKICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSB8CiAgICAodGhpc1tvZmZzZXQgKyAzXSA8PCAyNCkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MzJCRSA9IGZ1bmN0aW9uIHJlYWRJbnQzMkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgMjQpIHwKICAgICh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CiAgICAodGhpc1tvZmZzZXQgKyAzXSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRMRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdExFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgMjMsIDQpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0QkUgPSBmdW5jdGlvbiByZWFkRmxvYXRCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCAyMywgNCkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlTEUgPSBmdW5jdGlvbiByZWFkRG91YmxlTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKQogIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCB0cnVlLCA1MiwgOCkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlQkUgPSBmdW5jdGlvbiByZWFkRG91YmxlQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKQogIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgNTIsIDgpCn0KCmZ1bmN0aW9uIGNoZWNrSW50IChidWYsIHZhbHVlLCBvZmZzZXQsIGV4dCwgbWF4LCBtaW4pIHsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihidWYpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCciYnVmZmVyIiBhcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyIGluc3RhbmNlJykKICBpZiAodmFsdWUgPiBtYXggfHwgdmFsdWUgPCBtaW4pIHRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKQogIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlVUludExFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogIGlmICghbm9Bc3NlcnQpIHsKICAgIHZhciBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDEKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG1heEJ5dGVzLCAwKQogIH0KCiAgdmFyIG11bCA9IDEKICB2YXIgaSA9IDAKICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkYKICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCkgJiAweEZGCiAgfQoKICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludEJFID0gZnVuY3Rpb24gd3JpdGVVSW50QkUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgaWYgKCFub0Fzc2VydCkgewogICAgdmFyIG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpIC0gMQogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApCiAgfQoKICB2YXIgaSA9IGJ5dGVMZW5ndGggLSAxCiAgdmFyIG11bCA9IDEKICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAweEZGCiAgd2hpbGUgKC0taSA+PSAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkYKICB9CgogIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50OCA9IGZ1bmN0aW9uIHdyaXRlVUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMHhmZiwgMCkKICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpCiAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICByZXR1cm4gb2Zmc2V0ICsgMQp9CgpmdW5jdGlvbiBvYmplY3RXcml0ZVVJbnQxNiAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4pIHsKICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZiArIHZhbHVlICsgMQogIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4oYnVmLmxlbmd0aCAtIG9mZnNldCwgMik7IGkgPCBqOyArK2kpIHsKICAgIGJ1ZltvZmZzZXQgKyBpXSA9ICh2YWx1ZSAmICgweGZmIDw8ICg4ICogKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkpKSkgPj4+CiAgICAgIChsaXR0bGVFbmRpYW4gPyBpIDogMSAtIGkpICogOAogIH0KfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQxNkxFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDIKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZikKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgfQogIHJldHVybiBvZmZzZXQgKyAyCn0KCmZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDMyIChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4oYnVmLmxlbmd0aCAtIG9mZnNldCwgNCk7IGkgPCBqOyArK2kpIHsKICAgIGJ1ZltvZmZzZXQgKyBpXSA9ICh2YWx1ZSA+Pj4gKGxpdHRsZUVuZGlhbiA/IGkgOiAzIC0gaSkgKiA4KSAmIDB4ZmYKICB9Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDMyTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDQKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MzJCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgJiAweGZmKQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDQKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludExFID0gZnVuY3Rpb24gd3JpdGVJbnRMRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSB7CiAgICB2YXIgbGltaXQgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCAtIDEpCgogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbGltaXQgLSAxLCAtbGltaXQpCiAgfQoKICB2YXIgaSA9IDAKICB2YXIgbXVsID0gMQogIHZhciBzdWIgPSAwCiAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAweEZGCiAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSAtIDFdICE9PSAwKSB7CiAgICAgIHN1YiA9IDEKICAgIH0KICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAoKHZhbHVlIC8gbXVsKSA+PiAwKSAtIHN1YiAmIDB4RkYKICB9CgogIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlSW50QkUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgewogICAgdmFyIGxpbWl0ID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGggLSAxKQoKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KQogIH0KCiAgdmFyIGkgPSBieXRlTGVuZ3RoIC0gMQogIHZhciBtdWwgPSAxCiAgdmFyIHN1YiA9IDAKICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAweEZGCiAgd2hpbGUgKC0taSA+PSAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgKyAxXSAhPT0gMCkgewogICAgICBzdWIgPSAxCiAgICB9CiAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGCiAgfQoKICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50OCA9IGZ1bmN0aW9uIHdyaXRlSW50OCAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweDdmLCAtMHg4MCkKICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpCiAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmICsgdmFsdWUgKyAxCiAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICByZXR1cm4gb2Zmc2V0ICsgMQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MTZMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDIKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZUludDE2QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgMgp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDQKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHg3ZmZmZmZmZiwgLTB4ODAwMDAwMDApCiAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpmdW5jdGlvbiBjaGVja0lFRUU3NTQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKICBpZiAob2Zmc2V0IDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCn0KCmZ1bmN0aW9uIHdyaXRlRmxvYXQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIHsKICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDQsIDMuNDAyODIzNDY2Mzg1Mjg4NmUrMzgsIC0zLjQwMjgyMzQ2NjM4NTI4ODZlKzM4KQogIH0KICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCAyMywgNCkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRMRSA9IGZ1bmN0aW9uIHdyaXRlRmxvYXRMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0QkUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgcmV0dXJuIHdyaXRlRmxvYXQodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UsIG5vQXNzZXJ0KQp9CgpmdW5jdGlvbiB3cml0ZURvdWJsZSAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgewogICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgOCwgMS43OTc2OTMxMzQ4NjIzMTU3RSszMDgsIC0xLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCkKICB9CiAgaWVlZTc1NC53cml0ZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgNTIsIDgpCiAgcmV0dXJuIG9mZnNldCArIDgKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUxFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVCRSA9IGZ1bmN0aW9uIHdyaXRlRG91YmxlQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKfQoKLy8gY29weSh0YXJnZXRCdWZmZXIsIHRhcmdldFN0YXJ0PTAsIHNvdXJjZVN0YXJ0PTAsIHNvdXJjZUVuZD1idWZmZXIubGVuZ3RoKQpCdWZmZXIucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiBjb3B5ICh0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKSB7CiAgaWYgKCFzdGFydCkgc3RhcnQgPSAwCiAgaWYgKCFlbmQgJiYgZW5kICE9PSAwKSBlbmQgPSB0aGlzLmxlbmd0aAogIGlmICh0YXJnZXRTdGFydCA+PSB0YXJnZXQubGVuZ3RoKSB0YXJnZXRTdGFydCA9IHRhcmdldC5sZW5ndGgKICBpZiAoIXRhcmdldFN0YXJ0KSB0YXJnZXRTdGFydCA9IDAKICBpZiAoZW5kID4gMCAmJiBlbmQgPCBzdGFydCkgZW5kID0gc3RhcnQKCiAgLy8gQ29weSAwIGJ5dGVzOyB3ZSdyZSBkb25lCiAgaWYgKGVuZCA9PT0gc3RhcnQpIHJldHVybiAwCiAgaWYgKHRhcmdldC5sZW5ndGggPT09IDAgfHwgdGhpcy5sZW5ndGggPT09IDApIHJldHVybiAwCgogIC8vIEZhdGFsIGVycm9yIGNvbmRpdGlvbnMKICBpZiAodGFyZ2V0U3RhcnQgPCAwKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigndGFyZ2V0U3RhcnQgb3V0IG9mIGJvdW5kcycpCiAgfQogIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gdGhpcy5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdzb3VyY2VTdGFydCBvdXQgb2YgYm91bmRzJykKICBpZiAoZW5kIDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NvdXJjZUVuZCBvdXQgb2YgYm91bmRzJykKCiAgLy8gQXJlIHdlIG9vYj8KICBpZiAoZW5kID4gdGhpcy5sZW5ndGgpIGVuZCA9IHRoaXMubGVuZ3RoCiAgaWYgKHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCA8IGVuZCAtIHN0YXJ0KSB7CiAgICBlbmQgPSB0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgKyBzdGFydAogIH0KCiAgdmFyIGxlbiA9IGVuZCAtIHN0YXJ0CiAgdmFyIGkKCiAgaWYgKHRoaXMgPT09IHRhcmdldCAmJiBzdGFydCA8IHRhcmdldFN0YXJ0ICYmIHRhcmdldFN0YXJ0IDwgZW5kKSB7CiAgICAvLyBkZXNjZW5kaW5nIGNvcHkgZnJvbSBlbmQKICAgIGZvciAoaSA9IGxlbiAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgIHRhcmdldFtpICsgdGFyZ2V0U3RhcnRdID0gdGhpc1tpICsgc3RhcnRdCiAgICB9CiAgfSBlbHNlIGlmIChsZW4gPCAxMDAwIHx8ICFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgLy8gYXNjZW5kaW5nIGNvcHkgZnJvbSBzdGFydAogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHRhcmdldFtpICsgdGFyZ2V0U3RhcnRdID0gdGhpc1tpICsgc3RhcnRdCiAgICB9CiAgfSBlbHNlIHsKICAgIFVpbnQ4QXJyYXkucHJvdG90eXBlLnNldC5jYWxsKAogICAgICB0YXJnZXQsCiAgICAgIHRoaXMuc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ICsgbGVuKSwKICAgICAgdGFyZ2V0U3RhcnQKICAgICkKICB9CgogIHJldHVybiBsZW4KfQoKLy8gVXNhZ2U6Ci8vICAgIGJ1ZmZlci5maWxsKG51bWJlclssIG9mZnNldFssIGVuZF1dKQovLyAgICBidWZmZXIuZmlsbChidWZmZXJbLCBvZmZzZXRbLCBlbmRdXSkKLy8gICAgYnVmZmVyLmZpbGwoc3RyaW5nWywgb2Zmc2V0WywgZW5kXV1bLCBlbmNvZGluZ10pCkJ1ZmZlci5wcm90b3R5cGUuZmlsbCA9IGZ1bmN0aW9uIGZpbGwgKHZhbCwgc3RhcnQsIGVuZCwgZW5jb2RpbmcpIHsKICAvLyBIYW5kbGUgc3RyaW5nIGNhc2VzOgogIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBzdGFydAogICAgICBzdGFydCA9IDAKICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuZCA9PT0gJ3N0cmluZycpIHsKICAgICAgZW5jb2RpbmcgPSBlbmQKICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgIH0KICAgIGlmICh2YWwubGVuZ3RoID09PSAxKSB7CiAgICAgIHZhciBjb2RlID0gdmFsLmNoYXJDb2RlQXQoMCkKICAgICAgaWYgKGNvZGUgPCAyNTYpIHsKICAgICAgICB2YWwgPSBjb2RlCiAgICAgIH0KICAgIH0KICAgIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZycpCiAgICB9CiAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJyAmJiAhQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgIH0KICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICB2YWwgPSB2YWwgJiAyNTUKICB9CgogIC8vIEludmFsaWQgcmFuZ2VzIGFyZSBub3Qgc2V0IHRvIGEgZGVmYXVsdCwgc28gY2FuIHJhbmdlIGNoZWNrIGVhcmx5LgogIGlmIChzdGFydCA8IDAgfHwgdGhpcy5sZW5ndGggPCBzdGFydCB8fCB0aGlzLmxlbmd0aCA8IGVuZCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ091dCBvZiByYW5nZSBpbmRleCcpCiAgfQoKICBpZiAoZW5kIDw9IHN0YXJ0KSB7CiAgICByZXR1cm4gdGhpcwogIH0KCiAgc3RhcnQgPSBzdGFydCA+Pj4gMAogIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gdGhpcy5sZW5ndGggOiBlbmQgPj4+IDAKCiAgaWYgKCF2YWwpIHZhbCA9IDAKCiAgdmFyIGkKICBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgdGhpc1tpXSA9IHZhbAogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgYnl0ZXMgPSBCdWZmZXIuaXNCdWZmZXIodmFsKQogICAgICA/IHZhbAogICAgICA6IHV0ZjhUb0J5dGVzKG5ldyBCdWZmZXIodmFsLCBlbmNvZGluZykudG9TdHJpbmcoKSkKICAgIHZhciBsZW4gPSBieXRlcy5sZW5ndGgKICAgIGZvciAoaSA9IDA7IGkgPCBlbmQgLSBzdGFydDsgKytpKSB7CiAgICAgIHRoaXNbaSArIHN0YXJ0XSA9IGJ5dGVzW2kgJSBsZW5dCiAgICB9CiAgfQoKICByZXR1cm4gdGhpcwp9CgovLyBIRUxQRVIgRlVOQ1RJT05TCi8vID09PT09PT09PT09PT09PT0KCnZhciBJTlZBTElEX0JBU0U2NF9SRSA9IC9bXitcLzAtOUEtWmEtei1fXS9nCgpmdW5jdGlvbiBiYXNlNjRjbGVhbiAoc3RyKSB7CiAgLy8gTm9kZSBzdHJpcHMgb3V0IGludmFsaWQgY2hhcmFjdGVycyBsaWtlIFxuIGFuZCBcdCBmcm9tIHRoZSBzdHJpbmcsIGJhc2U2NC1qcyBkb2VzIG5vdAogIHN0ciA9IHN0cmluZ3RyaW0oc3RyKS5yZXBsYWNlKElOVkFMSURfQkFTRTY0X1JFLCAnJykKICAvLyBOb2RlIGNvbnZlcnRzIHN0cmluZ3Mgd2l0aCBsZW5ndGggPCAyIHRvICcnCiAgaWYgKHN0ci5sZW5ndGggPCAyKSByZXR1cm4gJycKICAvLyBOb2RlIGFsbG93cyBmb3Igbm9uLXBhZGRlZCBiYXNlNjQgc3RyaW5ncyAobWlzc2luZyB0cmFpbGluZyA9PT0pLCBiYXNlNjQtanMgZG9lcyBub3QKICB3aGlsZSAoc3RyLmxlbmd0aCAlIDQgIT09IDApIHsKICAgIHN0ciA9IHN0ciArICc9JwogIH0KICByZXR1cm4gc3RyCn0KCmZ1bmN0aW9uIHN0cmluZ3RyaW0gKHN0cikgewogIGlmIChzdHIudHJpbSkgcmV0dXJuIHN0ci50cmltKCkKICByZXR1cm4gc3RyLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykKfQoKZnVuY3Rpb24gdG9IZXggKG4pIHsKICBpZiAobiA8IDE2KSByZXR1cm4gJzAnICsgbi50b1N0cmluZygxNikKICByZXR1cm4gbi50b1N0cmluZygxNikKfQoKZnVuY3Rpb24gdXRmOFRvQnl0ZXMgKHN0cmluZywgdW5pdHMpIHsKICB1bml0cyA9IHVuaXRzIHx8IEluZmluaXR5CiAgdmFyIGNvZGVQb2ludAogIHZhciBsZW5ndGggPSBzdHJpbmcubGVuZ3RoCiAgdmFyIGxlYWRTdXJyb2dhdGUgPSBudWxsCiAgdmFyIGJ5dGVzID0gW10KCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgY29kZVBvaW50ID0gc3RyaW5nLmNoYXJDb2RlQXQoaSkKCiAgICAvLyBpcyBzdXJyb2dhdGUgY29tcG9uZW50CiAgICBpZiAoY29kZVBvaW50ID4gMHhEN0ZGICYmIGNvZGVQb2ludCA8IDB4RTAwMCkgewogICAgICAvLyBsYXN0IGNoYXIgd2FzIGEgbGVhZAogICAgICBpZiAoIWxlYWRTdXJyb2dhdGUpIHsKICAgICAgICAvLyBubyBsZWFkIHlldAogICAgICAgIGlmIChjb2RlUG9pbnQgPiAweERCRkYpIHsKICAgICAgICAgIC8vIHVuZXhwZWN0ZWQgdHJhaWwKICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgY29udGludWUKICAgICAgICB9IGVsc2UgaWYgKGkgKyAxID09PSBsZW5ndGgpIHsKICAgICAgICAgIC8vIHVucGFpcmVkIGxlYWQKICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIC8vIHZhbGlkIGxlYWQKICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50CgogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIDIgbGVhZHMgaW4gYSByb3cKICAgICAgaWYgKGNvZGVQb2ludCA8IDB4REMwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICAvLyB2YWxpZCBzdXJyb2dhdGUgcGFpcgogICAgICBjb2RlUG9pbnQgPSAobGVhZFN1cnJvZ2F0ZSAtIDB4RDgwMCA8PCAxMCB8IGNvZGVQb2ludCAtIDB4REMwMCkgKyAweDEwMDAwCiAgICB9IGVsc2UgaWYgKGxlYWRTdXJyb2dhdGUpIHsKICAgICAgLy8gdmFsaWQgYm1wIGNoYXIsIGJ1dCBsYXN0IGNoYXIgd2FzIGEgbGVhZAogICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgIH0KCiAgICBsZWFkU3Vycm9nYXRlID0gbnVsbAoKICAgIC8vIGVuY29kZSB1dGY4CiAgICBpZiAoY29kZVBvaW50IDwgMHg4MCkgewogICAgICBpZiAoKHVuaXRzIC09IDEpIDwgMCkgYnJlYWsKICAgICAgYnl0ZXMucHVzaChjb2RlUG9pbnQpCiAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4ODAwKSB7CiAgICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawogICAgICBieXRlcy5wdXNoKAogICAgICAgIGNvZGVQb2ludCA+PiAweDYgfCAweEMwLAogICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICkKICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHgxMDAwMCkgewogICAgICBpZiAoKHVuaXRzIC09IDMpIDwgMCkgYnJlYWsKICAgICAgYnl0ZXMucHVzaCgKICAgICAgICBjb2RlUG9pbnQgPj4gMHhDIHwgMHhFMCwKICAgICAgICBjb2RlUG9pbnQgPj4gMHg2ICYgMHgzRiB8IDB4ODAsCiAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgKQogICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDExMDAwMCkgewogICAgICBpZiAoKHVuaXRzIC09IDQpIDwgMCkgYnJlYWsKICAgICAgYnl0ZXMucHVzaCgKICAgICAgICBjb2RlUG9pbnQgPj4gMHgxMiB8IDB4RjAsCiAgICAgICAgY29kZVBvaW50ID4+IDB4QyAmIDB4M0YgfCAweDgwLAogICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICApCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29kZSBwb2ludCcpCiAgICB9CiAgfQoKICByZXR1cm4gYnl0ZXMKfQoKZnVuY3Rpb24gYXNjaWlUb0J5dGVzIChzdHIpIHsKICB2YXIgYnl0ZUFycmF5ID0gW10KICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgLy8gTm9kZSdzIGNvZGUgc2VlbXMgdG8gYmUgZG9pbmcgdGhpcyBhbmQgbm90ICYgMHg3Ri4uCiAgICBieXRlQXJyYXkucHVzaChzdHIuY2hhckNvZGVBdChpKSAmIDB4RkYpCiAgfQogIHJldHVybiBieXRlQXJyYXkKfQoKZnVuY3Rpb24gdXRmMTZsZVRvQnl0ZXMgKHN0ciwgdW5pdHMpIHsKICB2YXIgYywgaGksIGxvCiAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawoKICAgIGMgPSBzdHIuY2hhckNvZGVBdChpKQogICAgaGkgPSBjID4+IDgKICAgIGxvID0gYyAlIDI1NgogICAgYnl0ZUFycmF5LnB1c2gobG8pCiAgICBieXRlQXJyYXkucHVzaChoaSkKICB9CgogIHJldHVybiBieXRlQXJyYXkKfQoKZnVuY3Rpb24gYmFzZTY0VG9CeXRlcyAoc3RyKSB7CiAgcmV0dXJuIGJhc2U2NC50b0J5dGVBcnJheShiYXNlNjRjbGVhbihzdHIpKQp9CgpmdW5jdGlvbiBibGl0QnVmZmVyIChzcmMsIGRzdCwgb2Zmc2V0LCBsZW5ndGgpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICBpZiAoKGkgKyBvZmZzZXQgPj0gZHN0Lmxlbmd0aCkgfHwgKGkgPj0gc3JjLmxlbmd0aCkpIGJyZWFrCiAgICBkc3RbaSArIG9mZnNldF0gPSBzcmNbaV0KICB9CiAgcmV0dXJuIGkKfQoKZnVuY3Rpb24gaXNuYW4gKHZhbCkgewogIHJldHVybiB2YWwgIT09IHZhbCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXNlbGYtY29tcGFyZQp9Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHR5cGVvZiBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgIT09ICJ1bmRlZmluZWQiID8gX193ZWJwYWNrX3JlcXVpcmVfXy5nIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30scmVxdWlyZSgiYnVmZmVyIikuQnVmZmVyKQp9LHsiYmFzZTY0LWpzIjo3OSwiYnVmZmVyIjo4NSwiaWVlZTc1NCI6ODcsImlzYXJyYXkiOjg4fV0sODY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgpmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwogIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB1bmRlZmluZWQ7Cn0KbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7CgovLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuX2V2ZW50cyA9IHVuZGVmaW5lZDsKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdW5kZWZpbmVkOwoKLy8gQnkgZGVmYXVsdCBFdmVudEVtaXR0ZXJzIHdpbGwgcHJpbnQgYSB3YXJuaW5nIGlmIG1vcmUgdGhhbiAxMCBsaXN0ZW5lcnMgYXJlCi8vIGFkZGVkIHRvIGl0LiBUaGlzIGlzIGEgdXNlZnVsIGRlZmF1bHQgd2hpY2ggaGVscHMgZmluZGluZyBtZW1vcnkgbGVha3MuCkV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTA7CgovLyBPYnZpb3VzbHkgbm90IGFsbCBFbWl0dGVycyBzaG91bGQgYmUgbGltaXRlZCB0byAxMC4gVGhpcyBmdW5jdGlvbiBhbGxvd3MKLy8gdGhhdCB0byBiZSBpbmNyZWFzZWQuIFNldCB0byB6ZXJvIGZvciB1bmxpbWl0ZWQuCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewogIGlmICghaXNOdW1iZXIobikgfHwgbiA8IDAgfHwgaXNOYU4obikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ24gbXVzdCBiZSBhIHBvc2l0aXZlIG51bWJlcicpOwogIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIGVyLCBoYW5kbGVyLCBsZW4sIGFyZ3MsIGksIGxpc3RlbmVyczsKCiAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICB0aGlzLl9ldmVudHMgPSB7fTsKCiAgLy8gSWYgdGhlcmUgaXMgbm8gJ2Vycm9yJyBldmVudCBsaXN0ZW5lciB0aGVuIHRocm93LgogIGlmICh0eXBlID09PSAnZXJyb3InKSB7CiAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAogICAgICAgIChpc09iamVjdCh0aGlzLl9ldmVudHMuZXJyb3IpICYmICF0aGlzLl9ldmVudHMuZXJyb3IubGVuZ3RoKSkgewogICAgICBlciA9IGFyZ3VtZW50c1sxXTsKICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICB0aHJvdyBlcjsgLy8gVW5oYW5kbGVkICdlcnJvcicgZXZlbnQKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBBdCBsZWFzdCBnaXZlIHNvbWUga2luZCBvZiBjb250ZXh0IHRvIHRoZSB1c2VyCiAgICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcignVW5jYXVnaHQsIHVuc3BlY2lmaWVkICJlcnJvciIgZXZlbnQuICgnICsgZXIgKyAnKScpOwogICAgICAgIGVyci5jb250ZXh0ID0gZXI7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9CiAgICB9CiAgfQoKICBoYW5kbGVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwoKICBpZiAoaXNVbmRlZmluZWQoaGFuZGxlcikpCiAgICByZXR1cm4gZmFsc2U7CgogIGlmIChpc0Z1bmN0aW9uKGhhbmRsZXIpKSB7CiAgICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgLy8gZmFzdCBjYXNlcwogICAgICBjYXNlIDE6CiAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pOwogICAgICAgIGJyZWFrOwogICAgICAvLyBzbG93ZXIKICAgICAgZGVmYXVsdDoKICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBoYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfQogIH0gZWxzZSBpZiAoaXNPYmplY3QoaGFuZGxlcikpIHsKICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgbGlzdGVuZXJzID0gaGFuZGxlci5zbGljZSgpOwogICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykKICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOwogIH0KCiAgcmV0dXJuIHRydWU7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICB2YXIgbTsKCiAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogIGlmICghdGhpcy5fZXZlbnRzKQogICAgdGhpcy5fZXZlbnRzID0ge307CgogIC8vIFRvIGF2b2lkIHJlY3Vyc2lvbiBpbiB0aGUgY2FzZSB0aGF0IHR5cGUgPT09ICJuZXdMaXN0ZW5lciIhIEJlZm9yZQogIC8vIGFkZGluZyBpdCB0byB0aGUgbGlzdGVuZXJzLCBmaXJzdCBlbWl0ICJuZXdMaXN0ZW5lciIuCiAgaWYgKHRoaXMuX2V2ZW50cy5uZXdMaXN0ZW5lcikKICAgIHRoaXMuZW1pdCgnbmV3TGlzdGVuZXInLCB0eXBlLAogICAgICAgICAgICAgIGlzRnVuY3Rpb24obGlzdGVuZXIubGlzdGVuZXIpID8KICAgICAgICAgICAgICBsaXN0ZW5lci5saXN0ZW5lciA6IGxpc3RlbmVyKTsKCiAgaWYgKCF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAvLyBPcHRpbWl6ZSB0aGUgY2FzZSBvZiBvbmUgbGlzdGVuZXIuIERvbid0IG5lZWQgdGhlIGV4dHJhIGFycmF5IG9iamVjdC4KICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IGxpc3RlbmVyOwogIGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICAvLyBJZiB3ZSd2ZSBhbHJlYWR5IGdvdCBhbiBhcnJheSwganVzdCBhcHBlbmQuCiAgICB0aGlzLl9ldmVudHNbdHlwZV0ucHVzaChsaXN0ZW5lcik7CiAgZWxzZQogICAgLy8gQWRkaW5nIHRoZSBzZWNvbmQgZWxlbWVudCwgbmVlZCB0byBjaGFuZ2UgdG8gYXJyYXkuCiAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBbdGhpcy5fZXZlbnRzW3R5cGVdLCBsaXN0ZW5lcl07CgogIC8vIENoZWNrIGZvciBsaXN0ZW5lciBsZWFrCiAgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkgJiYgIXRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQpIHsKICAgIGlmICghaXNVbmRlZmluZWQodGhpcy5fbWF4TGlzdGVuZXJzKSkgewogICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOwogICAgfSBlbHNlIHsKICAgICAgbSA9IEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzOwogICAgfQoKICAgIGlmIChtICYmIG0gPiAwICYmIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGggPiBtKSB7CiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQgPSB0cnVlOwogICAgICBjb25zb2xlLmVycm9yKCcobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSAnICsKICAgICAgICAgICAgICAgICAgICAnbGVhayBkZXRlY3RlZC4gJWQgbGlzdGVuZXJzIGFkZGVkLiAnICsKICAgICAgICAgICAgICAgICAgICAnVXNlIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzKCkgdG8gaW5jcmVhc2UgbGltaXQuJywKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoKTsKICAgICAgaWYgKHR5cGVvZiBjb25zb2xlLnRyYWNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gbm90IHN1cHBvcnRlZCBpbiBJRSAxMAogICAgICAgIGNvbnNvbGUudHJhY2UoKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogIHZhciBmaXJlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiBnKCkgewogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsKCiAgICBpZiAoIWZpcmVkKSB7CiAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CgogIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKICB0aGlzLm9uKHR5cGUsIGcpOwoKICByZXR1cm4gdGhpczsKfTsKCi8vIGVtaXRzIGEgJ3JlbW92ZUxpc3RlbmVyJyBldmVudCBpZmYgdGhlIGxpc3RlbmVyIHdhcyByZW1vdmVkCkV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogIHZhciBsaXN0LCBwb3NpdGlvbiwgbGVuZ3RoLCBpOwoKICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgIHJldHVybiB0aGlzOwoKICBsaXN0ID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwogIHBvc2l0aW9uID0gLTE7CgogIGlmIChsaXN0ID09PSBsaXN0ZW5lciB8fAogICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwoKICB9IGVsc2UgaWYgKGlzT2JqZWN0KGxpc3QpKSB7CiAgICBmb3IgKGkgPSBsZW5ndGg7IGktLSA+IDA7KSB7CiAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fAogICAgICAgICAgKGxpc3RbaV0ubGlzdGVuZXIgJiYgbGlzdFtpXS5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaWYgKHBvc2l0aW9uIDwgMCkKICAgICAgcmV0dXJuIHRoaXM7CgogICAgaWYgKGxpc3QubGVuZ3RoID09PSAxKSB7CiAgICAgIGxpc3QubGVuZ3RoID0gMDsKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIH0gZWxzZSB7CiAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgIH0KCiAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICB2YXIga2V5LCBsaXN0ZW5lcnM7CgogIGlmICghdGhpcy5fZXZlbnRzKQogICAgcmV0dXJuIHRoaXM7CgogIC8vIG5vdCBsaXN0ZW5pbmcgZm9yIHJlbW92ZUxpc3RlbmVyLCBubyBuZWVkIHRvIGVtaXQKICBpZiAoIXRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgZWxzZSBpZiAodGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBlbWl0IHJlbW92ZUxpc3RlbmVyIGZvciBhbGwgbGlzdGVuZXJzIG9uIGFsbCBldmVudHMKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CiAgICAgIGlmIChrZXkgPT09ICdyZW1vdmVMaXN0ZW5lcicpIGNvbnRpbnVlOwogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhrZXkpOwogICAgfQogICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3JlbW92ZUxpc3RlbmVyJyk7CiAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW3R5cGVdOwoKICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7CiAgfSBlbHNlIGlmIChsaXN0ZW5lcnMpIHsKICAgIC8vIExJRk8gb3JkZXIKICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoKQogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVyc1tsaXN0ZW5lcnMubGVuZ3RoIC0gMV0pOwogIH0KICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwoKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogIHZhciByZXQ7CiAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgIHJldCA9IFtdOwogIGVsc2UgaWYgKGlzRnVuY3Rpb24odGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOwogIGVsc2UKICAgIHJldCA9IHRoaXMuX2V2ZW50c1t0eXBlXS5zbGljZSgpOwogIHJldHVybiByZXQ7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbih0eXBlKSB7CiAgaWYgKHRoaXMuX2V2ZW50cykgewogICAgdmFyIGV2bGlzdGVuZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07CgogICAgaWYgKGlzRnVuY3Rpb24oZXZsaXN0ZW5lcikpCiAgICAgIHJldHVybiAxOwogICAgZWxzZSBpZiAoZXZsaXN0ZW5lcikKICAgICAgcmV0dXJuIGV2bGlzdGVuZXIubGVuZ3RoOwogIH0KICByZXR1cm4gMDsKfTsKCkV2ZW50RW1pdHRlci5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSkgewogIHJldHVybiBlbWl0dGVyLmxpc3RlbmVyQ291bnQodHlwZSk7Cn07CgpmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwp9CgpmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7Cn0KCmZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogIHJldHVybiBhcmcgPT09IHZvaWQgMDsKfQoKfSx7fV0sODc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpleHBvcnRzLnJlYWQgPSBmdW5jdGlvbiAoYnVmZmVyLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogIHZhciBlLCBtCiAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMQogIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxCiAgdmFyIGVCaWFzID0gZU1heCA+PiAxCiAgdmFyIG5CaXRzID0gLTcKICB2YXIgaSA9IGlzTEUgPyAobkJ5dGVzIC0gMSkgOiAwCiAgdmFyIGQgPSBpc0xFID8gLTEgOiAxCiAgdmFyIHMgPSBidWZmZXJbb2Zmc2V0ICsgaV0KCiAgaSArPSBkCgogIGUgPSBzICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpCiAgcyA+Pj0gKC1uQml0cykKICBuQml0cyArPSBlTGVuCiAgZm9yICg7IG5CaXRzID4gMDsgZSA9IChlICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQoKICBtID0gZSAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKQogIGUgPj49ICgtbkJpdHMpCiAgbkJpdHMgKz0gbUxlbgogIGZvciAoOyBuQml0cyA+IDA7IG0gPSAobSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KCiAgaWYgKGUgPT09IDApIHsKICAgIGUgPSAxIC0gZUJpYXMKICB9IGVsc2UgaWYgKGUgPT09IGVNYXgpIHsKICAgIHJldHVybiBtID8gTmFOIDogKChzID8gLTEgOiAxKSAqIEluZmluaXR5KQogIH0gZWxzZSB7CiAgICBtID0gbSArIE1hdGgucG93KDIsIG1MZW4pCiAgICBlID0gZSAtIGVCaWFzCiAgfQogIHJldHVybiAocyA/IC0xIDogMSkgKiBtICogTWF0aC5wb3coMiwgZSAtIG1MZW4pCn0KCmV4cG9ydHMud3JpdGUgPSBmdW5jdGlvbiAoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICB2YXIgZSwgbSwgYwogIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDEKICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMQogIHZhciBlQmlhcyA9IGVNYXggPj4gMQogIHZhciBydCA9IChtTGVuID09PSAyMyA/IE1hdGgucG93KDIsIC0yNCkgLSBNYXRoLnBvdygyLCAtNzcpIDogMCkKICB2YXIgaSA9IGlzTEUgPyAwIDogKG5CeXRlcyAtIDEpCiAgdmFyIGQgPSBpc0xFID8gMSA6IC0xCiAgdmFyIHMgPSB2YWx1ZSA8IDAgfHwgKHZhbHVlID09PSAwICYmIDEgLyB2YWx1ZSA8IDApID8gMSA6IDAKCiAgdmFsdWUgPSBNYXRoLmFicyh2YWx1ZSkKCiAgaWYgKGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA9PT0gSW5maW5pdHkpIHsKICAgIG0gPSBpc05hTih2YWx1ZSkgPyAxIDogMAogICAgZSA9IGVNYXgKICB9IGVsc2UgewogICAgZSA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjIpCiAgICBpZiAodmFsdWUgKiAoYyA9IE1hdGgucG93KDIsIC1lKSkgPCAxKSB7CiAgICAgIGUtLQogICAgICBjICo9IDIKICAgIH0KICAgIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICB2YWx1ZSArPSBydCAvIGMKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlICs9IHJ0ICogTWF0aC5wb3coMiwgMSAtIGVCaWFzKQogICAgfQogICAgaWYgKHZhbHVlICogYyA+PSAyKSB7CiAgICAgIGUrKwogICAgICBjIC89IDIKICAgIH0KCiAgICBpZiAoZSArIGVCaWFzID49IGVNYXgpIHsKICAgICAgbSA9IDAKICAgICAgZSA9IGVNYXgKICAgIH0gZWxzZSBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgbSA9ICgodmFsdWUgKiBjKSAtIDEpICogTWF0aC5wb3coMiwgbUxlbikKICAgICAgZSA9IGUgKyBlQmlhcwogICAgfSBlbHNlIHsKICAgICAgbSA9IHZhbHVlICogTWF0aC5wb3coMiwgZUJpYXMgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pCiAgICAgIGUgPSAwCiAgICB9CiAgfQoKICBmb3IgKDsgbUxlbiA+PSA4OyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBtICYgMHhmZiwgaSArPSBkLCBtIC89IDI1NiwgbUxlbiAtPSA4KSB7fQoKICBlID0gKGUgPDwgbUxlbikgfCBtCiAgZUxlbiArPSBtTGVuCiAgZm9yICg7IGVMZW4gPiAwOyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBlICYgMHhmZiwgaSArPSBkLCBlIC89IDI1NiwgZUxlbiAtPSA4KSB7fQoKICBidWZmZXJbb2Zmc2V0ICsgaSAtIGRdIHw9IHMgKiAxMjgKfQoKfSx7fV0sODg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdG9TdHJpbmcgPSB7fS50b1N0cmluZzsKCm1vZHVsZS5leHBvcnRzID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoYXJyKSB7CiAgcmV0dXJuIHRvU3RyaW5nLmNhbGwoYXJyKSA9PSAnW29iamVjdCBBcnJheV0nOwp9OwoKfSx7fV0sODk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24oZXhwb3J0cykgewogICJ1c2Ugc3RyaWN0IjsKCiAgZnVuY3Rpb24gaXNBcnJheShvYmopIHsKICAgIGlmIChvYmogIT09IG51bGwpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBBcnJheV0iOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgICBpZiAob2JqICE9PSBudWxsKSB7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgT2JqZWN0XSI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCkgewogICAgLy8gQ2hlY2sgdGhlIHNjYWxhciBjYXNlIGZpcnN0LgogICAgaWYgKGZpcnN0ID09PSBzZWNvbmQpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgdGhleSBhcmUgdGhlIHNhbWUgdHlwZS4KICAgIHZhciBmaXJzdFR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZmlyc3QpOwogICAgaWYgKGZpcnN0VHlwZSAhPT0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHNlY29uZCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gV2Uga25vdyB0aGF0IGZpcnN0IGFuZCBzZWNvbmQgaGF2ZSB0aGUgc2FtZSB0eXBlIHNvIHdlIGNhbiBqdXN0IGNoZWNrIHRoZQogICAgLy8gZmlyc3QgdHlwZSBmcm9tIG5vdyBvbi4KICAgIGlmIChpc0FycmF5KGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIHRoZXkncmUgbm90IHRoZSBzYW1lIGxlbmd0aDsKICAgICAgaWYgKGZpcnN0Lmxlbmd0aCAhPT0gc2Vjb25kLmxlbmd0aCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpcnN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHN0cmljdERlZXBFcXVhbChmaXJzdFtpXSwgc2Vjb25kW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoaXNPYmplY3QoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgIC8vIEFuIG9iamVjdCBpcyBlcXVhbCBpZiBpdCBoYXMgdGhlIHNhbWUga2V5L3ZhbHVlIHBhaXJzLgogICAgICB2YXIga2V5c1NlZW4gPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIGZpcnN0KSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoZmlyc3QsIGtleSkpIHsKICAgICAgICAgIGlmIChzdHJpY3REZWVwRXF1YWwoZmlyc3Rba2V5XSwgc2Vjb25kW2tleV0pID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBrZXlzU2VlbltrZXldID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gTm93IGNoZWNrIHRoYXQgdGhlcmUgYXJlbid0IGFueSBrZXlzIGluIHNlY29uZCB0aGF0IHdlcmVuJ3QKICAgICAgLy8gaW4gZmlyc3QuCiAgICAgIGZvciAodmFyIGtleTIgaW4gc2Vjb25kKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc2Vjb25kLCBrZXkyKSkgewogICAgICAgICAgaWYgKGtleXNTZWVuW2tleTJdICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBpc0ZhbHNlKG9iaikgewogICAgLy8gRnJvbSB0aGUgc3BlYzoKICAgIC8vIEEgZmFsc2UgdmFsdWUgY29ycmVzcG9uZHMgdG8gdGhlIGZvbGxvd2luZyB2YWx1ZXM6CiAgICAvLyBFbXB0eSBsaXN0CiAgICAvLyBFbXB0eSBvYmplY3QKICAgIC8vIEVtcHR5IHN0cmluZwogICAgLy8gRmFsc2UgYm9vbGVhbgogICAgLy8gbnVsbCB2YWx1ZQoKICAgIC8vIEZpcnN0IGNoZWNrIHRoZSBzY2FsYXIgdmFsdWVzLgogICAgaWYgKG9iaiA9PT0gIiIgfHwgb2JqID09PSBmYWxzZSB8fCBvYmogPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoaXNBcnJheShvYmopICYmIG9iai5sZW5ndGggPT09IDApIHsKICAgICAgICAvLyBDaGVjayBmb3IgYW4gZW1wdHkgYXJyYXkuCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgICAgICAvLyBDaGVjayBmb3IgYW4gZW1wdHkgb2JqZWN0LgogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIGFueSBrZXlzLCB0aGVuCiAgICAgICAgICAgIC8vIHRoZSBvYmplY3QgaXMgbm90IGVtcHR5IHNvIHRoZSBvYmplY3QKICAgICAgICAgICAgLy8gaXMgbm90IGZhbHNlLgogICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9ialZhbHVlcyhvYmopIHsKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YWx1ZXMucHVzaChvYmpba2V5c1tpXV0pOwogICAgfQogICAgcmV0dXJuIHZhbHVlczsKICB9CgogIGZ1bmN0aW9uIG1lcmdlKGEsIGIpIHsKICAgICAgdmFyIG1lcmdlZCA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgICAgbWVyZ2VkW2tleV0gPSBhW2tleV07CiAgICAgIH0KICAgICAgZm9yICh2YXIga2V5MiBpbiBiKSB7CiAgICAgICAgICBtZXJnZWRba2V5Ml0gPSBiW2tleTJdOwogICAgICB9CiAgICAgIHJldHVybiBtZXJnZWQ7CiAgfQoKICB2YXIgdHJpbUxlZnQ7CiAgaWYgKHR5cGVvZiBTdHJpbmcucHJvdG90eXBlLnRyaW1MZWZ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICB0cmltTGVmdCA9IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gc3RyLnRyaW1MZWZ0KCk7CiAgICB9OwogIH0gZWxzZSB7CiAgICB0cmltTGVmdCA9IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gc3RyLm1hdGNoKC9eXHMqKC4qKS8pWzFdOwogICAgfTsKICB9CgogIC8vIFR5cGUgY29uc3RhbnRzIHVzZWQgdG8gZGVmaW5lIGZ1bmN0aW9ucy4KICB2YXIgVFlQRV9OVU1CRVIgPSAwOwogIHZhciBUWVBFX0FOWSA9IDE7CiAgdmFyIFRZUEVfU1RSSU5HID0gMjsKICB2YXIgVFlQRV9BUlJBWSA9IDM7CiAgdmFyIFRZUEVfT0JKRUNUID0gNDsKICB2YXIgVFlQRV9CT09MRUFOID0gNTsKICB2YXIgVFlQRV9FWFBSRUYgPSA2OwogIHZhciBUWVBFX05VTEwgPSA3OwogIHZhciBUWVBFX0FSUkFZX05VTUJFUiA9IDg7CiAgdmFyIFRZUEVfQVJSQVlfU1RSSU5HID0gOTsKICB2YXIgVFlQRV9OQU1FX1RBQkxFID0gewogICAgMDogJ251bWJlcicsCiAgICAxOiAnYW55JywKICAgIDI6ICdzdHJpbmcnLAogICAgMzogJ2FycmF5JywKICAgIDQ6ICdvYmplY3QnLAogICAgNTogJ2Jvb2xlYW4nLAogICAgNjogJ2V4cHJlc3Npb24nLAogICAgNzogJ251bGwnLAogICAgODogJ0FycmF5PG51bWJlcj4nLAogICAgOTogJ0FycmF5PHN0cmluZz4nCiAgfTsKCiAgdmFyIFRPS19FT0YgPSAiRU9GIjsKICB2YXIgVE9LX1VOUVVPVEVESURFTlRJRklFUiA9ICJVbnF1b3RlZElkZW50aWZpZXIiOwogIHZhciBUT0tfUVVPVEVESURFTlRJRklFUiA9ICJRdW90ZWRJZGVudGlmaWVyIjsKICB2YXIgVE9LX1JCUkFDS0VUID0gIlJicmFja2V0IjsKICB2YXIgVE9LX1JQQVJFTiA9ICJScGFyZW4iOwogIHZhciBUT0tfQ09NTUEgPSAiQ29tbWEiOwogIHZhciBUT0tfQ09MT04gPSAiQ29sb24iOwogIHZhciBUT0tfUkJSQUNFID0gIlJicmFjZSI7CiAgdmFyIFRPS19OVU1CRVIgPSAiTnVtYmVyIjsKICB2YXIgVE9LX0NVUlJFTlQgPSAiQ3VycmVudCI7CiAgdmFyIFRPS19FWFBSRUYgPSAiRXhwcmVmIjsKICB2YXIgVE9LX1BJUEUgPSAiUGlwZSI7CiAgdmFyIFRPS19PUiA9ICJPciI7CiAgdmFyIFRPS19BTkQgPSAiQW5kIjsKICB2YXIgVE9LX0VRID0gIkVRIjsKICB2YXIgVE9LX0dUID0gIkdUIjsKICB2YXIgVE9LX0xUID0gIkxUIjsKICB2YXIgVE9LX0dURSA9ICJHVEUiOwogIHZhciBUT0tfTFRFID0gIkxURSI7CiAgdmFyIFRPS19ORSA9ICJORSI7CiAgdmFyIFRPS19GTEFUVEVOID0gIkZsYXR0ZW4iOwogIHZhciBUT0tfU1RBUiA9ICJTdGFyIjsKICB2YXIgVE9LX0ZJTFRFUiA9ICJGaWx0ZXIiOwogIHZhciBUT0tfRE9UID0gIkRvdCI7CiAgdmFyIFRPS19OT1QgPSAiTm90IjsKICB2YXIgVE9LX0xCUkFDRSA9ICJMYnJhY2UiOwogIHZhciBUT0tfTEJSQUNLRVQgPSAiTGJyYWNrZXQiOwogIHZhciBUT0tfTFBBUkVOPSAiTHBhcmVuIjsKICB2YXIgVE9LX0xJVEVSQUw9ICJMaXRlcmFsIjsKCiAgLy8gVGhlICImIiwgIlsiLCAiPCIsICI+IiB0b2tlbnMKICAvLyBhcmUgbm90IGluIGJhc2ljVG9rZW4gYmVjYXVzZQogIC8vIHRoZXJlIGFyZSB0d28gdG9rZW4gdmFyaWFudHMKICAvLyAoIiYmIiwgIls/IiwgIjw9IiwgIj49IikuICBUaGlzIGlzIHNwZWNpYWxseSBoYW5kbGVkCiAgLy8gYmVsb3cuCgogIHZhciBiYXNpY1Rva2VucyA9IHsKICAgICIuIjogVE9LX0RPVCwKICAgICIqIjogVE9LX1NUQVIsCiAgICAiLCI6IFRPS19DT01NQSwKICAgICI6IjogVE9LX0NPTE9OLAogICAgInsiOiBUT0tfTEJSQUNFLAogICAgIn0iOiBUT0tfUkJSQUNFLAogICAgIl0iOiBUT0tfUkJSQUNLRVQsCiAgICAiKCI6IFRPS19MUEFSRU4sCiAgICAiKSI6IFRPS19SUEFSRU4sCiAgICAiQCI6IFRPS19DVVJSRU5UCiAgfTsKCiAgdmFyIG9wZXJhdG9yU3RhcnRUb2tlbiA9IHsKICAgICAgIjwiOiB0cnVlLAogICAgICAiPiI6IHRydWUsCiAgICAgICI9IjogdHJ1ZSwKICAgICAgIiEiOiB0cnVlCiAgfTsKCiAgdmFyIHNraXBDaGFycyA9IHsKICAgICAgIiAiOiB0cnVlLAogICAgICAiXHQiOiB0cnVlLAogICAgICAiXG4iOiB0cnVlCiAgfTsKCgogIGZ1bmN0aW9uIGlzQWxwaGEoY2gpIHsKICAgICAgcmV0dXJuIChjaCA+PSAiYSIgJiYgY2ggPD0gInoiKSB8fAogICAgICAgICAgICAgKGNoID49ICJBIiAmJiBjaCA8PSAiWiIpIHx8CiAgICAgICAgICAgICBjaCA9PT0gIl8iOwogIH0KCiAgZnVuY3Rpb24gaXNOdW0oY2gpIHsKICAgICAgcmV0dXJuIChjaCA+PSAiMCIgJiYgY2ggPD0gIjkiKSB8fAogICAgICAgICAgICAgY2ggPT09ICItIjsKICB9CiAgZnVuY3Rpb24gaXNBbHBoYU51bShjaCkgewogICAgICByZXR1cm4gKGNoID49ICJhIiAmJiBjaCA8PSAieiIpIHx8CiAgICAgICAgICAgICAoY2ggPj0gIkEiICYmIGNoIDw9ICJaIikgfHwKICAgICAgICAgICAgIChjaCA+PSAiMCIgJiYgY2ggPD0gIjkiKSB8fAogICAgICAgICAgICAgY2ggPT09ICJfIjsKICB9CgogIGZ1bmN0aW9uIExleGVyKCkgewogIH0KICBMZXhlci5wcm90b3R5cGUgPSB7CiAgICAgIHRva2VuaXplOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHZhciB0b2tlbnMgPSBbXTsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSAwOwogICAgICAgICAgdmFyIHN0YXJ0OwogICAgICAgICAgdmFyIGlkZW50aWZpZXI7CiAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICB3aGlsZSAodGhpcy5fY3VycmVudCA8IHN0cmVhbS5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAoaXNBbHBoYShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVVbnF1b3RlZElkZW50aWZpZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19VTlFVT1RFRElERU5USUZJRVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFzaWNUb2tlbnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBiYXNpY1Rva2Vuc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc3RyZWFtW3RoaXMuX2N1cnJlbnRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogdGhpcy5fY3VycmVudH0pOwogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc051bShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZU51bWJlcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJbIikgewogICAgICAgICAgICAgICAgICAvLyBObyBuZWVkIHRvIGluY3JlbWVudCB0aGlzLl9jdXJyZW50LiAgVGhpcyBoYXBwZW5zCiAgICAgICAgICAgICAgICAgIC8vIGluIF9jb25zdW1lTEJyYWNrZXQKICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9jb25zdW1lTEJyYWNrZXQoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiXCIiKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVRdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfUVVPVEVESURFTlRJRklFUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICInIikgewogICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lUmF3U3RyaW5nTGl0ZXJhbChzdHJlYW0pOwogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0xJVEVSQUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiYCIpIHsKICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICB2YXIgbGl0ZXJhbCA9IHRoaXMuX2NvbnN1bWVMaXRlcmFsKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfTElURVJBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBsaXRlcmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvclN0YXJ0VG9rZW5bc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRoaXMuX2NvbnN1bWVPcGVyYXRvcihzdHJlYW0pKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNraXBDaGFyc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHdoaXRlc3BhY2UuCiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfQU5ELCB2YWx1ZTogIiYmIiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0VYUFJFRiwgdmFsdWU6ICImIiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gInwiKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAifCIpIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfT1IsIHZhbHVlOiAifHwiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfUElQRSwgdmFsdWU6ICJ8Iiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlVua25vd24gY2hhcmFjdGVyOiIgKyBzdHJlYW1bdGhpcy5fY3VycmVudF0pOwogICAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIkxleGVyRXJyb3IiOwogICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdG9rZW5zOwogICAgICB9LAoKICAgICAgX2NvbnN1bWVVbnF1b3RlZElkZW50aWZpZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHdoaWxlICh0aGlzLl9jdXJyZW50IDwgc3RyZWFtLmxlbmd0aCAmJiBpc0FscGhhTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KTsKICAgICAgfSwKCiAgICAgIF9jb25zdW1lUXVvdGVkSWRlbnRpZmllcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiXCIiICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIGRvdWJsZSBxdW90ZSBhbmQgeW91IGNhbiBlc2NhcGUgYW4gZXNjYXBlLgogICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlwiIikpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgfSwKCiAgICAgIF9jb25zdW1lUmF3U3RyaW5nTGl0ZXJhbDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiJyIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgc2luZ2xlIHF1b3RlIGFuZCB5b3UgY2FuIGVzY2FwZSBhbiBlc2NhcGUuCiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiJyIpKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgdmFyIGxpdGVyYWwgPSBzdHJlYW0uc2xpY2Uoc3RhcnQgKyAxLCB0aGlzLl9jdXJyZW50IC0gMSk7CiAgICAgICAgICByZXR1cm4gbGl0ZXJhbC5yZXBsYWNlKCJcXCciLCAiJyIpOwogICAgICB9LAoKICAgICAgX2NvbnN1bWVOdW1iZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKGlzTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlSW50KHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTlVNQkVSLCB2YWx1ZTogdmFsdWUsIHN0YXJ0OiBzdGFydH07CiAgICAgIH0sCgogICAgICBfY29uc3VtZUxCcmFja2V0OiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPyIpIHsKICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRklMVEVSLCB2YWx1ZTogIls/Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiXSIpIHsKICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRkxBVFRFTiwgdmFsdWU6ICJbXSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xCUkFDS0VULCB2YWx1ZTogIlsiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgX2NvbnN1bWVPcGVyYXRvcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgdmFyIHN0YXJ0aW5nQ2hhciA9IHN0cmVhbVtzdGFydF07CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICBpZiAoc3RhcnRpbmdDaGFyID09PSAiISIpIHsKICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19ORSwgdmFsdWU6ICIhPSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05PVCwgdmFsdWU6ICIhIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFRFLCB2YWx1ZTogIjw9Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MVCwgdmFsdWU6ICI8Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfR1RFLCB2YWx1ZTogIj49Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVCwgdmFsdWU6ICI+Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRVEsIHZhbHVlOiAiPT0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9jb25zdW1lTGl0ZXJhbDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICB2YXIgbGl0ZXJhbDsKICAgICAgICAgIHdoaWxlKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gImAiICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIGxpdGVyYWwgY2hhciBvciB5b3UgY2FuIGVzY2FwZSB0aGUgZXNjYXBlLgogICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gImAiKSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXRlcmFsU3RyaW5nID0gdHJpbUxlZnQoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgICBsaXRlcmFsU3RyaW5nID0gbGl0ZXJhbFN0cmluZy5yZXBsYWNlKCJcXGAiLCAiYCIpOwogICAgICAgICAgaWYgKHRoaXMuX2xvb2tzTGlrZUpTT04obGl0ZXJhbFN0cmluZykpIHsKICAgICAgICAgICAgICBsaXRlcmFsID0gSlNPTi5wYXJzZShsaXRlcmFsU3RyaW5nKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gVHJ5IHRvIEpTT04gcGFyc2UgaXQgYXMgIjxsaXRlcmFsPiIKICAgICAgICAgICAgICBsaXRlcmFsID0gSlNPTi5wYXJzZSgiXCIiICsgbGl0ZXJhbFN0cmluZyArICJcIiIpOwogICAgICAgICAgfQogICAgICAgICAgLy8gKzEgZ2V0cyB1cyB0byB0aGUgZW5kaW5nICJgIiwgKzEgdG8gbW92ZSBvbiB0byB0aGUgbmV4dCBjaGFyLgogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgcmV0dXJuIGxpdGVyYWw7CiAgICAgIH0sCgogICAgICBfbG9va3NMaWtlSlNPTjogZnVuY3Rpb24obGl0ZXJhbFN0cmluZykgewogICAgICAgICAgdmFyIHN0YXJ0aW5nQ2hhcnMgPSAiW3tcIiI7CiAgICAgICAgICB2YXIganNvbkxpdGVyYWxzID0gWyJ0cnVlIiwgImZhbHNlIiwgIm51bGwiXTsKICAgICAgICAgIHZhciBudW1iZXJMb29raW5nID0gIi0wMTIzNDU2Nzg5IjsKCiAgICAgICAgICBpZiAobGl0ZXJhbFN0cmluZyA9PT0gIiIpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhcnMuaW5kZXhPZihsaXRlcmFsU3RyaW5nWzBdKSA+PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGpzb25MaXRlcmFscy5pbmRleE9mKGxpdGVyYWxTdHJpbmcpID49IDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAobnVtYmVyTG9va2luZy5pbmRleE9mKGxpdGVyYWxTdHJpbmdbMF0pID49IDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBKU09OLnBhcnNlKGxpdGVyYWxTdHJpbmcpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgIH0KICB9OwoKICAgICAgdmFyIGJpbmRpbmdQb3dlciA9IHt9OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0VPRl0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX1VOUVVPVEVESURFTlRJRklFUl0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX1FVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19SQlJBQ0tFVF0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX1JQQVJFTl0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0NPTU1BXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfUkJSQUNFXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTlVNQkVSXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfQ1VSUkVOVF0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0VYUFJFRl0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX1BJUEVdID0gMTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19PUl0gPSAyOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0FORF0gPSAzOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0VRXSA9IDU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfR1RdID0gNTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19MVF0gPSA1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0dURV0gPSA1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0xURV0gPSA1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX05FXSA9IDU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfRkxBVFRFTl0gPSA5OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX1NUQVJdID0gMjA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfRklMVEVSXSA9IDIxOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0RPVF0gPSA0MDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19OT1RdID0gNDU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTEJSQUNFXSA9IDUwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0xCUkFDS0VUXSA9IDU1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0xQQVJFTl0gPSA2MDsKCiAgZnVuY3Rpb24gUGFyc2VyKCkgewogIH0KCiAgUGFyc2VyLnByb3RvdHlwZSA9IHsKICAgICAgcGFyc2U6IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgICAgIHRoaXMuX2xvYWRUb2tlbnMoZXhwcmVzc2lvbik7CiAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgIHZhciBhc3QgPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfRU9GKSB7CiAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICJVbmV4cGVjdGVkIHRva2VuIHR5cGU6ICIgKyB0LnR5cGUgKyAiLCB2YWx1ZTogIiArIHQudmFsdWUpOwogICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFzdDsKICAgICAgfSwKCiAgICAgIF9sb2FkVG9rZW5zOiBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgICAgIHZhciB0b2tlbnMgPSBsZXhlci50b2tlbml6ZShleHByZXNzaW9uKTsKICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfRU9GLCB2YWx1ZTogIiIsIHN0YXJ0OiBleHByZXNzaW9uLmxlbmd0aH0pOwogICAgICAgICAgdGhpcy50b2tlbnMgPSB0b2tlbnM7CiAgICAgIH0sCgogICAgICBleHByZXNzaW9uOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgIHZhciBsZWZ0VG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgIHZhciBsZWZ0ID0gdGhpcy5udWQobGVmdFRva2VuKTsKICAgICAgICAgIHZhciBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICB3aGlsZSAocmJwIDwgYmluZGluZ1Bvd2VyW2N1cnJlbnRUb2tlbl0pIHsKICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgbGVmdCA9IHRoaXMubGVkKGN1cnJlbnRUb2tlbiwgbGVmdCk7CiAgICAgICAgICAgICAgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgIH0sCgogICAgICBfbG9va2FoZWFkOiBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnRva2Vuc1t0aGlzLmluZGV4ICsgbnVtYmVyXS50eXBlOwogICAgICB9LAoKICAgICAgX2xvb2thaGVhZFRva2VuOiBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnRva2Vuc1t0aGlzLmluZGV4ICsgbnVtYmVyXTsKICAgICAgfSwKCiAgICAgIF9hZHZhbmNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgfSwKCiAgICAgIG51ZDogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICB2YXIgbGVmdDsKICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgdmFyIGV4cHJlc3Npb247CiAgICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7CiAgICAgICAgICBjYXNlIFRPS19MSVRFUkFMOgogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJMaXRlcmFsIiwgdmFsdWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgIGNhc2UgVE9LX1VOUVVPVEVESURFTlRJRklFUjoKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmllbGQiLCBuYW1lOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICBjYXNlIFRPS19RVU9URURJREVOVElGSUVSOgogICAgICAgICAgICB2YXIgbm9kZSA9IHt0eXBlOiAiRmllbGQiLCBuYW1lOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19MUEFSRU4pIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUXVvdGVkIGlkZW50aWZpZXIgbm90IGFsbG93ZWQgZm9yIGZ1bmN0aW9uIG5hbWVzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgY2FzZSBUT0tfTk9UOgogICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuTm90KTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTm90RXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbcmlnaHRdfTsKICAgICAgICAgIGNhc2UgVE9LX1NUQVI6CiAgICAgICAgICAgIGxlZnQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgIHJpZ2h0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAvLyBUaGlzIGNhbiBoYXBwZW4gaW4gYSBtdWx0aXNlbGVjdCwKICAgICAgICAgICAgICAgIC8vIFthLCBiLCAqXQogICAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiVmFsdWVQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgY2FzZSBUT0tfRklMVEVSOgogICAgICAgICAgICByZXR1cm4gdGhpcy5sZWQodG9rZW4udHlwZSwge3R5cGU6ICJJZGVudGl0eSJ9KTsKICAgICAgICAgIGNhc2UgVE9LX0xCUkFDRToKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RIYXNoKCk7CiAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICBsZWZ0ID0ge3R5cGU6IFRPS19GTEFUVEVOLCBjaGlsZHJlbjogW3t0eXBlOiAiSWRlbnRpdHkifV19OwogICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBjYXNlIFRPS19MQlJBQ0tFVDoKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX05VTUJFUiB8fCB0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZUluZGV4RXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3RJZlNsaWNlKHt0eXBlOiAiSWRlbnRpdHkifSwgcmlnaHQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1NUQVIgJiYKICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb29rYWhlYWQoMSkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbe3R5cGU6ICJJZGVudGl0eSJ9LCByaWdodF19OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICBjYXNlIFRPS19FWFBSRUY6CiAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkV4cHJlZik7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkV4cHJlc3Npb25SZWZlcmVuY2UiLCBjaGlsZHJlbjogW2V4cHJlc3Npb25dfTsKICAgICAgICAgIGNhc2UgVE9LX0xQQVJFTjoKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JQQVJFTikgewogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DVVJSRU5UKSB7CiAgICAgICAgICAgICAgICBleHByZXNzaW9uID0ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJncy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SUEFSRU4pOwogICAgICAgICAgICByZXR1cm4gYXJnc1swXTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRoaXMuX2Vycm9yVG9rZW4odG9rZW4pOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGxlZDogZnVuY3Rpb24odG9rZW5OYW1lLCBsZWZ0KSB7CiAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgIHN3aXRjaCh0b2tlbk5hbWUpIHsKICAgICAgICAgIGNhc2UgVE9LX0RPVDoKICAgICAgICAgICAgdmFyIHJicCA9IGJpbmRpbmdQb3dlci5Eb3Q7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19TVEFSKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlRG90UkhTKHJicCk7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJTdWJleHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIENyZWF0aW5nIGEgcHJvamVjdGlvbi4KICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhyYnApOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJWYWx1ZVByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuUGlwZSk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX1BJUEUsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGNhc2UgVE9LX09SOgogICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuT3IpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJPckV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBjYXNlIFRPS19BTkQ6CiAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5BbmQpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJBbmRFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgY2FzZSBUT0tfTFBBUkVOOgogICAgICAgICAgICB2YXIgbmFtZSA9IGxlZnQubmFtZTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24sIG5vZGU7CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SUEFSRU4pIHsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ1VSUkVOVCkgewogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJncy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SUEFSRU4pOwogICAgICAgICAgICBub2RlID0ge3R5cGU6ICJGdW5jdGlvbiIsIG5hbWU6IG5hbWUsIGNoaWxkcmVuOiBhcmdzfTsKICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICBjYXNlIFRPS19GSUxURVI6CiAgICAgICAgICAgIHZhciBjb25kaXRpb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19GTEFUVEVOKSB7CiAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZpbHRlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmlsdGVyUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHQsIGNvbmRpdGlvbl19OwogICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgdmFyIGxlZnROb2RlID0ge3R5cGU6IFRPS19GTEFUVEVOLCBjaGlsZHJlbjogW2xlZnRdfTsKICAgICAgICAgICAgdmFyIHJpZ2h0Tm9kZSA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnROb2RlLCByaWdodE5vZGVdfTsKICAgICAgICAgIGNhc2UgVE9LX0VROgogICAgICAgICAgY2FzZSBUT0tfTkU6CiAgICAgICAgICBjYXNlIFRPS19HVDoKICAgICAgICAgIGNhc2UgVE9LX0dURToKICAgICAgICAgIGNhc2UgVE9LX0xUOgogICAgICAgICAgY2FzZSBUT0tfTFRFOgogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VDb21wYXJhdG9yKGxlZnQsIHRva2VuTmFtZSk7CiAgICAgICAgICBjYXNlIFRPS19MQlJBQ0tFVDoKICAgICAgICAgICAgdmFyIHRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09PSBUT0tfTlVNQkVSIHx8IHRva2VuLnR5cGUgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZUluZGV4RXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3RJZlNsaWNlKGxlZnQsIHJpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfU1RBUik7CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRoaXMuX2Vycm9yVG9rZW4odGhpcy5fbG9va2FoZWFkVG9rZW4oMCkpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9tYXRjaDogZnVuY3Rpb24odG9rZW5UeXBlKSB7CiAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSB0b2tlblR5cGUpIHsKICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJFeHBlY3RlZCAiICsgdG9rZW5UeXBlICsgIiwgZ290OiAiICsgdC50eXBlKTsKICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9lcnJvclRva2VuOiBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJJbnZhbGlkIHRva2VuICgiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi50eXBlICsgIik6IFwiIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgKyAiXCIiKTsKICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0sCgoKICAgICAgX3BhcnNlSW5kZXhFeHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTiB8fCB0aGlzLl9sb29rYWhlYWQoMSkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZVNsaWNlRXhwcmVzc2lvbigpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHsKICAgICAgICAgICAgICAgICAgdHlwZTogIkluZGV4IiwKICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuX2xvb2thaGVhZFRva2VuKDApLnZhbHVlfTsKICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9wcm9qZWN0SWZTbGljZTogZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICAgIHZhciBpbmRleEV4cHIgPSB7dHlwZTogIkluZGV4RXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGlmIChyaWdodC50eXBlID09PSAiU2xpY2UiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgdHlwZTogIlByb2plY3Rpb24iLAogICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW2luZGV4RXhwciwgdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKV0KICAgICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gaW5kZXhFeHByOwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgX3BhcnNlU2xpY2VFeHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIFtzdGFydDplbmQ6c3RlcF0gd2hlcmUgZWFjaCBwYXJ0IGlzIG9wdGlvbmFsLCBhcyB3ZWxsIGFzIHRoZSBsYXN0CiAgICAgICAgICAvLyBjb2xvbi4KICAgICAgICAgIHZhciBwYXJ0cyA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgICB2YXIgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRUb2tlbiAhPT0gVE9LX1JCUkFDS0VUICYmIGluZGV4IDwgMykgewogICAgICAgICAgICAgIGlmIChjdXJyZW50VG9rZW4gPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50VG9rZW4gPT09IFRPS19OVU1CRVIpIHsKICAgICAgICAgICAgICAgICAgcGFydHNbaW5kZXhdID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCkudmFsdWU7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJTeW50YXggZXJyb3IsIHVuZXhwZWN0ZWQgdG9rZW46ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC52YWx1ZSArICIoIiArIHQudHlwZSArICIpIik7CiAgICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyZXJyb3IiOwogICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgdHlwZTogIlNsaWNlIiwKICAgICAgICAgICAgICBjaGlsZHJlbjogcGFydHMKICAgICAgICAgIH07CiAgICAgIH0sCgogICAgICBfcGFyc2VDb21wYXJhdG9yOiBmdW5jdGlvbihsZWZ0LCBjb21wYXJhdG9yKSB7CiAgICAgICAgdmFyIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlcltjb21wYXJhdG9yXSk7CiAgICAgICAgcmV0dXJuIHt0eXBlOiAiQ29tcGFyYXRvciIsIG5hbWU6IGNvbXBhcmF0b3IsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgfSwKCiAgICAgIF9wYXJzZURvdFJIUzogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICB2YXIgbG9va2FoZWFkID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgdmFyIGV4cHJUb2tlbnMgPSBbVE9LX1VOUVVPVEVESURFTlRJRklFUiwgVE9LX1FVT1RFRElERU5USUZJRVIsIFRPS19TVEFSXTsKICAgICAgICAgIGlmIChleHByVG9rZW5zLmluZGV4T2YobG9va2FoZWFkKSA+PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgfSBlbHNlIGlmIChsb29rYWhlYWQgPT09IFRPS19MQlJBQ0tFVCkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19MQlJBQ0tFVCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RMaXN0KCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxvb2thaGVhZCA9PT0gVE9LX0xCUkFDRSkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19MQlJBQ0UpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0SGFzaCgpOwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgX3BhcnNlUHJvamVjdGlvblJIUzogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICBpZiAoYmluZGluZ1Bvd2VyW3RoaXMuX2xvb2thaGVhZCgwKV0gPCAxMCkgewogICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19MQlJBQ0tFVCkgewogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZJTFRFUikgewogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0RPVCkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19ET1QpOwogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VEb3RSSFMocmJwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlN5dGFueCBlcnJvciwgdW5leHBlY3RlZCB0b2tlbjogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudmFsdWUgKyAiKCIgKyB0LnR5cGUgKyAiKSIpOwogICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJpZ2h0OwogICAgICB9LAoKICAgICAgX3BhcnNlTXVsdGlzZWxlY3RMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBleHByZXNzaW9ucyA9IFtdOwogICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbnMucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIHRva2VuIFJicmFja2V0Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTXVsdGlTZWxlY3RMaXN0IiwgY2hpbGRyZW46IGV4cHJlc3Npb25zfTsKICAgICAgfSwKCiAgICAgIF9wYXJzZU11bHRpc2VsZWN0SGFzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHBhaXJzID0gW107CiAgICAgICAgdmFyIGlkZW50aWZpZXJUeXBlcyA9IFtUT0tfVU5RVU9URURJREVOVElGSUVSLCBUT0tfUVVPVEVESURFTlRJRklFUl07CiAgICAgICAgdmFyIGtleVRva2VuLCBrZXlOYW1lLCB2YWx1ZSwgbm9kZTsKICAgICAgICBmb3IgKDs7KSB7CiAgICAgICAgICBrZXlUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgaWYgKGlkZW50aWZpZXJUeXBlcy5pbmRleE9mKGtleVRva2VuLnR5cGUpIDwgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGluZyBhbiBpZGVudGlmaWVyIHRva2VuLCBnb3Q6ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5VG9rZW4udHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBrZXlOYW1lID0ga2V5VG9rZW4udmFsdWU7CiAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09MT04pOwogICAgICAgICAgdmFsdWUgPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICBub2RlID0ge3R5cGU6ICJLZXlWYWx1ZVBhaXIiLCBuYW1lOiBrZXlOYW1lLCB2YWx1ZTogdmFsdWV9OwogICAgICAgICAgcGFpcnMucHVzaChub2RlKTsKICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0UpIHsKICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDRSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdEhhc2giLCBjaGlsZHJlbjogcGFpcnN9OwogICAgICB9CiAgfTsKCgogIGZ1bmN0aW9uIFRyZWVJbnRlcnByZXRlcihydW50aW1lKSB7CiAgICB0aGlzLnJ1bnRpbWUgPSBydW50aW1lOwogIH0KCiAgVHJlZUludGVycHJldGVyLnByb3RvdHlwZSA9IHsKICAgICAgc2VhcmNoOiBmdW5jdGlvbihub2RlLCB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZSwgdmFsdWUpOwogICAgICB9LAoKICAgICAgdmlzaXQ6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgbWF0Y2hlZCwgY3VycmVudCwgcmVzdWx0LCBmaXJzdCwgc2Vjb25kLCBmaWVsZCwgbGVmdCwgcmlnaHQsIGNvbGxlY3RlZCwgaTsKICAgICAgICAgIHN3aXRjaCAobm9kZS50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgIkZpZWxkIjoKICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIGZpZWxkID0gdmFsdWVbbm9kZS5uYW1lXTsKICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJTdWJleHByZXNzaW9uIjoKICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIGNhc2UgIkluZGV4RXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgbGVmdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBsZWZ0KTsKICAgICAgICAgICAgICByZXR1cm4gcmlnaHQ7CiAgICAgICAgICAgIGNhc2UgIkluZGV4IjoKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGluZGV4ID0gbm9kZS52YWx1ZTsKICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICBpbmRleCA9IHZhbHVlLmxlbmd0aCArIGluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXN1bHQgPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICBjYXNlICJTbGljZSI6CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzbGljZVBhcmFtcyA9IG5vZGUuY2hpbGRyZW4uc2xpY2UoMCk7CiAgICAgICAgICAgICAgdmFyIGNvbXB1dGVkID0gdGhpcy5jb21wdXRlU2xpY2VQYXJhbXModmFsdWUubGVuZ3RoLCBzbGljZVBhcmFtcyk7CiAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gY29tcHV0ZWRbMF07CiAgICAgICAgICAgICAgdmFyIHN0b3AgPSBjb21wdXRlZFsxXTsKICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNvbXB1dGVkWzJdOwogICAgICAgICAgICAgIHJlc3VsdCA9IFtdOwogICAgICAgICAgICAgIGlmIChzdGVwID4gMCkgewogICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IHN0b3A7IGkgKz0gc3RlcCkgewogICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPiBzdG9wOyBpICs9IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICBjYXNlICJQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSBsZWZ0IGNoaWxkLgogICAgICAgICAgICAgIHZhciBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGJhc2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJhc2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGJhc2VbaV0pOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgIGNhc2UgIlZhbHVlUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKCFpc09iamVjdChiYXNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBvYmpWYWx1ZXMoYmFzZSk7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWVzW2ldKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICBjYXNlICJGaWx0ZXJQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGJhc2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgICAgICAgICAgdmFyIGZpbmFsUmVzdWx0cyA9IFtdOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYXNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzJdLCBiYXNlW2ldKTsKICAgICAgICAgICAgICAgIGlmICghaXNGYWxzZShtYXRjaGVkKSkgewogICAgICAgICAgICAgICAgICBmaWx0ZXJlZC5wdXNoKGJhc2VbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpbHRlcmVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBmaWx0ZXJlZFtqXSk7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmaW5hbFJlc3VsdHMucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0czsKICAgICAgICAgICAgY2FzZSAiQ29tcGFyYXRvciI6CiAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICBzZWNvbmQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICBzd2l0Y2gobm9kZS5uYW1lKSB7CiAgICAgICAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgVE9LX05FOgogICAgICAgICAgICAgICAgICByZXN1bHQgPSAhc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA+IHNlY29uZDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0ID49IHNlY29uZDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRPS19MVDoKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPCBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBUT0tfTFRFOgogICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA8PSBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGNvbXBhcmF0b3I6ICIgKyBub2RlLm5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgIHZhciBvcmlnaW5hbCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIGlmICghaXNBcnJheShvcmlnaW5hbCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbWVyZ2VkID0gW107CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9yaWdpbmFsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gb3JpZ2luYWxbaV07CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjdXJyZW50KSkgewogICAgICAgICAgICAgICAgICBtZXJnZWQucHVzaC5hcHBseShtZXJnZWQsIGN1cnJlbnQpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbWVyZ2VkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICAgICAgICAgIGNhc2UgIklkZW50aXR5IjoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIk11bHRpU2VsZWN0TGlzdCI6CiAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2godGhpcy52aXNpdChub2RlLmNoaWxkcmVuW2ldLCB2YWx1ZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICBjYXNlICJNdWx0aVNlbGVjdEhhc2giOgogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbGxlY3RlZCA9IHt9OwogICAgICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY2hpbGQgPSBub2RlLmNoaWxkcmVuW2ldOwogICAgICAgICAgICAgICAgY29sbGVjdGVkW2NoaWxkLm5hbWVdID0gdGhpcy52aXNpdChjaGlsZC52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICBjYXNlICJPckV4cHJlc3Npb24iOgogICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoaXNGYWxzZShtYXRjaGVkKSkgewogICAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBtYXRjaGVkOwogICAgICAgICAgICBjYXNlICJBbmRFeHByZXNzaW9uIjoKICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwoKICAgICAgICAgICAgICBpZiAoaXNGYWxzZShmaXJzdCkgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICBjYXNlICJOb3RFeHByZXNzaW9uIjoKICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBpc0ZhbHNlKGZpcnN0KTsKICAgICAgICAgICAgY2FzZSAiTGl0ZXJhbCI6CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWU7CiAgICAgICAgICAgIGNhc2UgVE9LX1BJUEU6CiAgICAgICAgICAgICAgbGVmdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGxlZnQpOwogICAgICAgICAgICBjYXNlIFRPS19DVVJSRU5UOgogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgY2FzZSAiRnVuY3Rpb24iOgogICAgICAgICAgICAgIHZhciByZXNvbHZlZEFyZ3MgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICByZXNvbHZlZEFyZ3MucHVzaCh0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5baV0sIHZhbHVlKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1bnRpbWUuY2FsbEZ1bmN0aW9uKG5vZGUubmFtZSwgcmVzb2x2ZWRBcmdzKTsKICAgICAgICAgICAgY2FzZSAiRXhwcmVzc2lvblJlZmVyZW5jZSI6CiAgICAgICAgICAgICAgdmFyIHJlZk5vZGUgPSBub2RlLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgIC8vIFRhZyB0aGUgbm9kZSB3aXRoIGEgc3BlY2lmaWMgYXR0cmlidXRlIHNvIHRoZSB0eXBlCiAgICAgICAgICAgICAgLy8gY2hlY2tlciB2ZXJpZnkgdGhlIHR5cGUuCiAgICAgICAgICAgICAgcmVmTm9kZS5qbWVzcGF0aFR5cGUgPSBUT0tfRVhQUkVGOwogICAgICAgICAgICAgIHJldHVybiByZWZOb2RlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBub2RlIHR5cGU6ICIgKyBub2RlLnR5cGUpOwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgY29tcHV0ZVNsaWNlUGFyYW1zOiBmdW5jdGlvbihhcnJheUxlbmd0aCwgc2xpY2VQYXJhbXMpIHsKICAgICAgICB2YXIgc3RhcnQgPSBzbGljZVBhcmFtc1swXTsKICAgICAgICB2YXIgc3RvcCA9IHNsaWNlUGFyYW1zWzFdOwogICAgICAgIHZhciBzdGVwID0gc2xpY2VQYXJhbXNbMl07CiAgICAgICAgdmFyIGNvbXB1dGVkID0gW251bGwsIG51bGwsIG51bGxdOwogICAgICAgIGlmIChzdGVwID09PSBudWxsKSB7CiAgICAgICAgICBzdGVwID0gMTsKICAgICAgICB9IGVsc2UgaWYgKHN0ZXAgPT09IDApIHsKICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiSW52YWxpZCBzbGljZSwgc3RlcCBjYW5ub3QgYmUgMCIpOwogICAgICAgICAgZXJyb3IubmFtZSA9ICJSdW50aW1lRXJyb3IiOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfQogICAgICAgIHZhciBzdGVwVmFsdWVOZWdhdGl2ZSA9IHN0ZXAgPCAwID8gdHJ1ZSA6IGZhbHNlOwoKICAgICAgICBpZiAoc3RhcnQgPT09IG51bGwpIHsKICAgICAgICAgICAgc3RhcnQgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IGFycmF5TGVuZ3RoIC0gMSA6IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnQgPSB0aGlzLmNhcFNsaWNlUmFuZ2UoYXJyYXlMZW5ndGgsIHN0YXJ0LCBzdGVwKTsKICAgICAgICB9CgogICAgICAgIGlmIChzdG9wID09PSBudWxsKSB7CiAgICAgICAgICAgIHN0b3AgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IC0xIDogYXJyYXlMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RvcCA9IHRoaXMuY2FwU2xpY2VSYW5nZShhcnJheUxlbmd0aCwgc3RvcCwgc3RlcCk7CiAgICAgICAgfQogICAgICAgIGNvbXB1dGVkWzBdID0gc3RhcnQ7CiAgICAgICAgY29tcHV0ZWRbMV0gPSBzdG9wOwogICAgICAgIGNvbXB1dGVkWzJdID0gc3RlcDsKICAgICAgICByZXR1cm4gY29tcHV0ZWQ7CiAgICAgIH0sCgogICAgICBjYXBTbGljZVJhbmdlOiBmdW5jdGlvbihhcnJheUxlbmd0aCwgYWN0dWFsVmFsdWUsIHN0ZXApIHsKICAgICAgICAgIGlmIChhY3R1YWxWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSArPSBhcnJheUxlbmd0aDsKICAgICAgICAgICAgICBpZiAoYWN0dWFsVmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgICAgIGFjdHVhbFZhbHVlID0gc3RlcCA8IDAgPyAtMSA6IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChhY3R1YWxWYWx1ZSA+PSBhcnJheUxlbmd0aCkgewogICAgICAgICAgICAgIGFjdHVhbFZhbHVlID0gc3RlcCA8IDAgPyBhcnJheUxlbmd0aCAtIDEgOiBhcnJheUxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBhY3R1YWxWYWx1ZTsKICAgICAgfQoKICB9OwoKICBmdW5jdGlvbiBSdW50aW1lKGludGVycHJldGVyKSB7CiAgICB0aGlzLl9pbnRlcnByZXRlciA9IGludGVycHJldGVyOwogICAgdGhpcy5mdW5jdGlvblRhYmxlID0gewogICAgICAgIC8vIG5hbWU6IFtmdW5jdGlvbiwgPHNpZ25hdHVyZT5dCiAgICAgICAgLy8gVGhlIDxzaWduYXR1cmU+IGNhbiBiZToKICAgICAgICAvLwogICAgICAgIC8vIHsKICAgICAgICAvLyAgIGFyZ3M6IFtbdHlwZTEsIHR5cGUyXSwgW3R5cGUxLCB0eXBlMl1dLAogICAgICAgIC8vICAgdmFyaWFkaWM6IHRydWV8ZmFsc2UKICAgICAgICAvLyB9CiAgICAgICAgLy8KICAgICAgICAvLyBFYWNoIGFyZyBpbiB0aGUgYXJnIGxpc3QgaXMgYSBsaXN0IG9mIHZhbGlkIHR5cGVzCiAgICAgICAgLy8gKGlmIHRoZSBmdW5jdGlvbiBpcyBvdmVybG9hZGVkIGFuZCBzdXBwb3J0cyBtdWx0aXBsZQogICAgICAgIC8vIHR5cGVzLiAgSWYgdGhlIHR5cGUgaXMgImFueSIgdGhlbiBubyB0eXBlIGNoZWNraW5nCiAgICAgICAgLy8gb2NjdXJzIG9uIHRoZSBhcmd1bWVudC4gIFZhcmlhZGljIGlzIG9wdGlvbmFsCiAgICAgICAgLy8gYW5kIGlmIG5vdCBwcm92aWRlZCBpcyBhc3N1bWVkIHRvIGJlIGZhbHNlLgogICAgICAgIGFiczoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkFicywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICBhdmc6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25BdmcsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgY2VpbDoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkNlaWwsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgY29udGFpbnM6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQ29udGFpbnMsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19LAogICAgICAgICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgImVuZHNfd2l0aCI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRW5kc1dpdGgsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklOR119LCB7dHlwZXM6IFtUWVBFX1NUUklOR119XX0sCiAgICAgICAgZmxvb3I6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25GbG9vciwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTGVuZ3RoLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVksIFRZUEVfT0JKRUNUXX1dfSwKICAgICAgICBtYXA6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWFwLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9FWFBSRUZdfSwge3R5cGVzOiBbVFlQRV9BUlJBWV19XX0sCiAgICAgICAgbWF4OiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1heCwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSLCBUWVBFX0FSUkFZX1NUUklOR119XX0sCiAgICAgICAgIm1lcmdlIjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NZXJnZSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXSwgdmFyaWFkaWM6IHRydWV9XQogICAgICAgIH0sCiAgICAgICAgIm1heF9ieSI6IHsKICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1heEJ5LAogICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICB9LAogICAgICAgIHN1bToge19mdW5jOiB0aGlzLl9mdW5jdGlvblN1bSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAic3RhcnRzX3dpdGgiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblN0YXJ0c1dpdGgsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklOR119LCB7dHlwZXM6IFtUWVBFX1NUUklOR119XX0sCiAgICAgICAgbWluOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1pbiwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSLCBUWVBFX0FSUkFZX1NUUklOR119XX0sCiAgICAgICAgIm1pbl9ieSI6IHsKICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1pbkJ5LAogICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICB9LAogICAgICAgIHR5cGU6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25UeXBlLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgIGtleXM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25LZXlzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdfV19LAogICAgICAgIHZhbHVlczoge19mdW5jOiB0aGlzLl9mdW5jdGlvblZhbHVlcywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICBzb3J0OiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU29ydCwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfU1RSSU5HLCBUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgInNvcnRfYnkiOiB7CiAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0QnksCiAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgIH0sCiAgICAgICAgam9pbjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Kb2luLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbCiAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX1NUUklOR119LAogICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9BUlJBWV9TVFJJTkddfQogICAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICByZXZlcnNlOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblJldmVyc2UsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19XX0sCiAgICAgICAgInRvX2FycmF5Ijoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvQXJyYXksIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgInRvX3N0cmluZyI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub1N0cmluZywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAidG9fbnVtYmVyIjoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvTnVtYmVyLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICJub3RfbnVsbCI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTm90TnVsbCwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXSwgdmFyaWFkaWM6IHRydWV9XQogICAgICAgIH0KICAgIH07CiAgfQoKICBSdW50aW1lLnByb3RvdHlwZSA9IHsKICAgIGNhbGxGdW5jdGlvbjogZnVuY3Rpb24obmFtZSwgcmVzb2x2ZWRBcmdzKSB7CiAgICAgIHZhciBmdW5jdGlvbkVudHJ5ID0gdGhpcy5mdW5jdGlvblRhYmxlW25hbWVdOwogICAgICBpZiAoZnVuY3Rpb25FbnRyeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZnVuY3Rpb246ICIgKyBuYW1lICsgIigpIik7CiAgICAgIH0KICAgICAgdGhpcy5fdmFsaWRhdGVBcmdzKG5hbWUsIHJlc29sdmVkQXJncywgZnVuY3Rpb25FbnRyeS5fc2lnbmF0dXJlKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uRW50cnkuX2Z1bmMuY2FsbCh0aGlzLCByZXNvbHZlZEFyZ3MpOwogICAgfSwKCiAgICBfdmFsaWRhdGVBcmdzOiBmdW5jdGlvbihuYW1lLCBhcmdzLCBzaWduYXR1cmUpIHsKICAgICAgICAvLyBWYWxpZGF0aW5nIHRoZSBhcmdzIHJlcXVpcmVzIHZhbGlkYXRpbmcKICAgICAgICAvLyB0aGUgY29ycmVjdCBhcml0eSBhbmQgdGhlIGNvcnJlY3QgdHlwZSBvZiBlYWNoIGFyZy4KICAgICAgICAvLyBJZiB0aGUgbGFzdCBhcmd1bWVudCBpcyBkZWNsYXJlZCBhcyB2YXJpYWRpYywgdGhlbiB3ZSBuZWVkCiAgICAgICAgLy8gYSBtaW5pbXVtIG51bWJlciBvZiBhcmdzIHRvIGJlIHJlcXVpcmVkLiAgT3RoZXJ3aXNlIGl0IGhhcyB0bwogICAgICAgIC8vIGJlIGFuIGV4YWN0IGFtb3VudC4KICAgICAgICB2YXIgcGx1cmFsaXplZDsKICAgICAgICBpZiAoc2lnbmF0dXJlW3NpZ25hdHVyZS5sZW5ndGggLSAxXS52YXJpYWRpYykgewogICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPCBzaWduYXR1cmUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBwbHVyYWxpemVkID0gc2lnbmF0dXJlLmxlbmd0aCA9PT0gMSA/ICIgYXJndW1lbnQiIDogIiBhcmd1bWVudHMiOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudEVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGFrZXMgYXQgbGVhc3QiICsgc2lnbmF0dXJlLmxlbmd0aCArIHBsdXJhbGl6ZWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoICE9PSBzaWduYXR1cmUubGVuZ3RoKSB7CiAgICAgICAgICAgIHBsdXJhbGl6ZWQgPSBzaWduYXR1cmUubGVuZ3RoID09PSAxID8gIiBhcmd1bWVudCIgOiAiIGFyZ3VtZW50cyI7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnRFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGFrZXMgIiArIHNpZ25hdHVyZS5sZW5ndGggKyBwbHVyYWxpemVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50U3BlYzsKICAgICAgICB2YXIgYWN0dWFsVHlwZTsKICAgICAgICB2YXIgdHlwZU1hdGNoZWQ7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaWduYXR1cmUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdHlwZU1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgY3VycmVudFNwZWMgPSBzaWduYXR1cmVbaV0udHlwZXM7CiAgICAgICAgICAgIGFjdHVhbFR5cGUgPSB0aGlzLl9nZXRUeXBlTmFtZShhcmdzW2ldKTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjdXJyZW50U3BlYy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3R5cGVNYXRjaGVzKGFjdHVhbFR5cGUsIGN1cnJlbnRTcGVjW2pdLCBhcmdzW2ldKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGVNYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXR5cGVNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWQgPSBjdXJyZW50U3BlYwogICAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odHlwZUlkZW50aWZpZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfTkFNRV9UQUJMRVt0eXBlSWRlbnRpZmllcl07CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAuam9pbignLCcpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUeXBlRXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJleHBlY3RlZCBhcmd1bWVudCAiICsgKGkgKyAxKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiB0byBiZSB0eXBlICIgKyBleHBlY3RlZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgdHlwZSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUWVBFX05BTUVfVEFCTEVbYWN0dWFsVHlwZV0gKyAiIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIF90eXBlTWF0Y2hlczogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgYXJnVmFsdWUpIHsKICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQU5ZKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfU1RSSU5HIHx8CiAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUiB8fAogICAgICAgICAgICBleHBlY3RlZCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAvLyBUaGUgZXhwZWN0ZWQgdHlwZSBjYW4gZWl0aGVyIGp1c3QgYmUgYXJyYXksCiAgICAgICAgICAgIC8vIG9yIGl0IGNhbiByZXF1aXJlIGEgc3BlY2lmaWMgc3VidHlwZSAoYXJyYXkgb2YgbnVtYmVycykuCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIFRoZSBzaW1wbGVzdCBjYXNlIGlzIGlmICJhcnJheSIgd2l0aCBubyBzdWJ0eXBlIGlzIHNwZWNpZmllZC4KICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsID09PSBUWVBFX0FSUkFZOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdHVhbCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG5lZWQgdG8gY2hlY2sgc3VidHlwZXMuCiAgICAgICAgICAgICAgICAvLyBJIHRoaW5rIHRoaXMgaGFzIHBvdGVudGlhbCB0byBiZSBpbXByb3ZlZC4KICAgICAgICAgICAgICAgIHZhciBzdWJ0eXBlOwogICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUikgewogICAgICAgICAgICAgICAgICBzdWJ0eXBlID0gVFlQRV9OVU1CRVI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX1NUUklORykgewogICAgICAgICAgICAgICAgICBzdWJ0eXBlID0gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ1ZhbHVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl90eXBlTWF0Y2hlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2dldFR5cGVOYW1lKGFyZ1ZhbHVlW2ldKSwgc3VidHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnVmFsdWVbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IGV4cGVjdGVkOwogICAgICAgIH0KICAgIH0sCiAgICBfZ2V0VHlwZU5hbWU6IGZ1bmN0aW9uKG9iaikgewogICAgICAgIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpIHsKICAgICAgICAgICAgY2FzZSAiW29iamVjdCBTdHJpbmddIjoKICAgICAgICAgICAgICByZXR1cm4gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgIGNhc2UgIltvYmplY3QgTnVtYmVyXSI6CiAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfTlVNQkVSOwogICAgICAgICAgICBjYXNlICJbb2JqZWN0IEFycmF5XSI6CiAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfQVJSQVk7CiAgICAgICAgICAgIGNhc2UgIltvYmplY3QgQm9vbGVhbl0iOgogICAgICAgICAgICAgIHJldHVybiBUWVBFX0JPT0xFQU47CiAgICAgICAgICAgIGNhc2UgIltvYmplY3QgTnVsbF0iOgogICAgICAgICAgICAgIHJldHVybiBUWVBFX05VTEw7CiAgICAgICAgICAgIGNhc2UgIltvYmplY3QgT2JqZWN0XSI6CiAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhbiBleHByZWYuICBJZiBpdCBoYXMsIGl0J3MgYmVlbgogICAgICAgICAgICAgIC8vIHRhZ2dlZCB3aXRoIGEgam1lc3BhdGhUeXBlIGF0dHIgb2YgJ0V4cHJlZic7CiAgICAgICAgICAgICAgaWYgKG9iai5qbWVzcGF0aFR5cGUgPT09IFRPS19FWFBSRUYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0VYUFJFRjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfT0JKRUNUOwogICAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvblN0YXJ0c1dpdGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGFzdEluZGV4T2YocmVzb2x2ZWRBcmdzWzFdKSA9PT0gMDsKICAgIH0sCgogICAgX2Z1bmN0aW9uRW5kc1dpdGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBzZWFyY2hTdHIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIHN1ZmZpeCA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICByZXR1cm4gc2VhcmNoU3RyLmluZGV4T2Yoc3VmZml4LCBzZWFyY2hTdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCkgIT09IC0xOwogICAgfSwKCiAgICBfZnVuY3Rpb25SZXZlcnNlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgIHZhciBvcmlnaW5hbFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciByZXZlcnNlZFN0ciA9ICIiOwogICAgICAgICAgZm9yICh2YXIgaSA9IG9yaWdpbmFsU3RyLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgcmV2ZXJzZWRTdHIgKz0gb3JpZ2luYWxTdHJbaV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmV2ZXJzZWRTdHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciByZXZlcnNlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgICAgcmV2ZXJzZWRBcnJheS5yZXZlcnNlKCk7CiAgICAgICAgICByZXR1cm4gcmV2ZXJzZWRBcnJheTsKICAgICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvbkFiczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIHJldHVybiBNYXRoLmFicyhyZXNvbHZlZEFyZ3NbMF0pOwogICAgfSwKCiAgICBfZnVuY3Rpb25DZWlsOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHJlc29sdmVkQXJnc1swXSk7CiAgICB9LAoKICAgIF9mdW5jdGlvbkF2ZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgdmFyIGlucHV0QXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnB1dEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHN1bSArPSBpbnB1dEFycmF5W2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VtIC8gaW5wdXRBcnJheS5sZW5ndGg7CiAgICB9LAoKICAgIF9mdW5jdGlvbkNvbnRhaW5zOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmluZGV4T2YocmVzb2x2ZWRBcmdzWzFdKSA+PSAwOwogICAgfSwKCiAgICBfZnVuY3Rpb25GbG9vcjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IocmVzb2x2ZWRBcmdzWzBdKTsKICAgIH0sCgogICAgX2Z1bmN0aW9uTGVuZ3RoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgIGlmICghaXNPYmplY3QocmVzb2x2ZWRBcmdzWzBdKSkgewogICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmxlbmd0aDsKICAgICAgIH0gZWxzZSB7CiAgICAgICAgIC8vIEFzIGZhciBhcyBJIGNhbiB0ZWxsLCB0aGVyZSdzIG5vIHdheSB0byBnZXQgdGhlIGxlbmd0aAogICAgICAgICAvLyBvZiBhbiBvYmplY3Qgd2l0aG91dCBPKG4pIGl0ZXJhdGlvbiB0aHJvdWdoIHRoZSBvYmplY3QuCiAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXNvbHZlZEFyZ3NbMF0pLmxlbmd0aDsKICAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uTWFwOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgdmFyIG1hcHBlZCA9IFtdOwogICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgbWFwcGVkLnB1c2goaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgZWxlbWVudHNbaV0pKTsKICAgICAgfQogICAgICByZXR1cm4gbWFwcGVkOwogICAgfSwKCiAgICBfZnVuY3Rpb25NZXJnZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIHZhciBtZXJnZWQgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgY3VycmVudCA9IHJlc29sdmVkQXJnc1tpXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gY3VycmVudCkgewogICAgICAgICAgbWVyZ2VkW2tleV0gPSBjdXJyZW50W2tleV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtZXJnZWQ7CiAgICB9LAoKICAgIF9mdW5jdGlvbk1heDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIGlmIChyZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoID4gMCkgewogICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXVswXSk7CiAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KE1hdGgsIHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBtYXhFbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKG1heEVsZW1lbnQubG9jYWxlQ29tcGFyZShlbGVtZW50c1tpXSkgPCAwKSB7CiAgICAgICAgICAgICAgICAgIG1heEVsZW1lbnQgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF4RWxlbWVudDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25NaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICBpZiAocmVzb2x2ZWRBcmdzWzBdLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF1bMF0pOwogICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCByZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIgbWluRWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmIChlbGVtZW50c1tpXS5sb2NhbGVDb21wYXJlKG1pbkVsZW1lbnQpIDwgMCkgewogICAgICAgICAgICAgICAgICBtaW5FbGVtZW50ID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1pbkVsZW1lbnQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvblN1bTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIHZhciBzdW0gPSAwOwogICAgICB2YXIgbGlzdFRvU3VtID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3RUb1N1bS5sZW5ndGg7IGkrKykgewogICAgICAgIHN1bSArPSBsaXN0VG9TdW1baV07CiAgICAgIH0KICAgICAgcmV0dXJuIHN1bTsKICAgIH0sCgogICAgX2Z1bmN0aW9uVHlwZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgc3dpdGNoICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pKSB7CiAgICAgICAgICBjYXNlIFRZUEVfTlVNQkVSOgogICAgICAgICAgICByZXR1cm4gIm51bWJlciI7CiAgICAgICAgICBjYXNlIFRZUEVfU1RSSU5HOgogICAgICAgICAgICByZXR1cm4gInN0cmluZyI7CiAgICAgICAgICBjYXNlIFRZUEVfQVJSQVk6CiAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgICAgY2FzZSBUWVBFX09CSkVDVDoKICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwogICAgICAgICAgY2FzZSBUWVBFX0JPT0xFQU46CiAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7CiAgICAgICAgICBjYXNlIFRZUEVfRVhQUkVGOgogICAgICAgICAgICByZXR1cm4gImV4cHJlZiI7CiAgICAgICAgICBjYXNlIFRZUEVfTlVMTDoKICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKICAgICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvbktleXM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXNvbHZlZEFyZ3NbMF0pOwogICAgfSwKCiAgICBfZnVuY3Rpb25WYWx1ZXM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBvYmogPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsdWVzLnB1c2gob2JqW2tleXNbaV1dKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0sCgogICAgX2Z1bmN0aW9uSm9pbjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGpvaW5DaGFyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBsaXN0Sm9pbiA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICByZXR1cm4gbGlzdEpvaW4uam9pbihqb2luQ2hhcik7CiAgICB9LAoKICAgIF9mdW5jdGlvblRvQXJyYXk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFtyZXNvbHZlZEFyZ3NbMF1dOwogICAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uVG9TdHJpbmc6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uVG9OdW1iZXI6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgdmFyIGNvbnZlcnRlZFZhbHVlOwogICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVOYW1lID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICtyZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIGlmICghaXNOYU4oY29udmVydGVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY29udmVydGVkVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIF9mdW5jdGlvbk5vdE51bGw6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbaV0pICE9PSBUWVBFX05VTEwpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIF9mdW5jdGlvblNvcnQ6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICBzb3J0ZWRBcnJheS5zb3J0KCk7CiAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgfSwKCiAgICBfZnVuY3Rpb25Tb3J0Qnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICBpZiAoc29ydGVkQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgICB9CiAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgdmFyIHJlcXVpcmVkVHlwZSA9IHRoaXMuX2dldFR5cGVOYW1lKAogICAgICAgICAgICBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBzb3J0ZWRBcnJheVswXSkpOwogICAgICAgIGlmIChbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXS5pbmRleE9mKHJlcXVpcmVkVHlwZSkgPCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yIik7CiAgICAgICAgfQogICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICAvLyBJbiBvcmRlciB0byBnZXQgYSBzdGFibGUgc29ydCBvdXQgb2YgYW4gdW5zdGFibGUKICAgICAgICAvLyBzb3J0IGFsZ29yaXRobSwgd2UgZGVjb3JhdGUvc29ydC91bmRlY29yYXRlIChEU1UpCiAgICAgICAgLy8gYnkgY3JlYXRpbmcgYSBuZXcgbGlzdCBvZiBbaW5kZXgsIGVsZW1lbnRdIHBhaXJzLgogICAgICAgIC8vIEluIHRoZSBjbXAgZnVuY3Rpb24sIGlmIHRoZSBldmFsdWF0ZWQgZWxlbWVudHMgYXJlCiAgICAgICAgLy8gZXF1YWwsIHRoZW4gdGhlIGluZGV4IHdpbGwgYmUgdXNlZCBhcyB0aGUgdGllYnJlYWtlci4KICAgICAgICAvLyBBZnRlciB0aGUgZGVjb3JhdGVkIGxpc3QgaGFzIGJlZW4gc29ydGVkLCBpdCB3aWxsIGJlCiAgICAgICAgLy8gdW5kZWNvcmF0ZWQgdG8gZXh0cmFjdCB0aGUgb3JpZ2luYWwgZWxlbWVudHMuCiAgICAgICAgdmFyIGRlY29yYXRlZCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGRlY29yYXRlZC5wdXNoKFtpLCBzb3J0ZWRBcnJheVtpXV0pOwogICAgICAgIH0KICAgICAgICBkZWNvcmF0ZWQuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICB2YXIgZXhwckEgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBhWzFdKTsKICAgICAgICAgIHZhciBleHByQiA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGJbMV0pOwogICAgICAgICAgaWYgKHRoYXQuX2dldFR5cGVOYW1lKGV4cHJBKSAhPT0gcmVxdWlyZWRUeXBlKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAiVHlwZUVycm9yOiBleHBlY3RlZCAiICsgcmVxdWlyZWRUeXBlICsgIiwgcmVjZWl2ZWQgIiArCiAgICAgICAgICAgICAgICAgIHRoYXQuX2dldFR5cGVOYW1lKGV4cHJBKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSAhPT0gcmVxdWlyZWRUeXBlKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAiVHlwZUVycm9yOiBleHBlY3RlZCAiICsgcmVxdWlyZWRUeXBlICsgIiwgcmVjZWl2ZWQgIiArCiAgICAgICAgICAgICAgICAgIHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhwckEgPiBleHByQikgewogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0gZWxzZSBpZiAoZXhwckEgPCBleHByQikgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiB0aGV5J3JlIGVxdWFsIGNvbXBhcmUgdGhlIGl0ZW1zIGJ5IHRoZWlyCiAgICAgICAgICAgIC8vIG9yZGVyIHRvIG1haW50YWluIHJlbGF0aXZlIG9yZGVyIG9mIGVxdWFsIGtleXMKICAgICAgICAgICAgLy8gKGkuZS4gdG8gZ2V0IGEgc3RhYmxlIHNvcnQpLgogICAgICAgICAgICByZXR1cm4gYVswXSAtIGJbMF07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgLy8gVW5kZWNvcmF0ZTogZXh0cmFjdCBvdXQgdGhlIG9yaWdpbmFsIGxpc3QgZWxlbWVudHMuCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBkZWNvcmF0ZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHNvcnRlZEFycmF5W2pdID0gZGVjb3JhdGVkW2pdWzFdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICB9LAoKICAgIF9mdW5jdGlvbk1heEJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgIHZhciByZXNvbHZlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICB2YXIga2V5RnVuY3Rpb24gPSB0aGlzLmNyZWF0ZUtleUZ1bmN0aW9uKGV4cHJlZk5vZGUsIFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddKTsKICAgICAgdmFyIG1heE51bWJlciA9IC1JbmZpbml0eTsKICAgICAgdmFyIG1heFJlY29yZDsKICAgICAgdmFyIGN1cnJlbnQ7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgIGN1cnJlbnQgPSBrZXlGdW5jdGlvbihyZXNvbHZlZEFycmF5W2ldKTsKICAgICAgICBpZiAoY3VycmVudCA+IG1heE51bWJlcikgewogICAgICAgICAgbWF4TnVtYmVyID0gY3VycmVudDsKICAgICAgICAgIG1heFJlY29yZCA9IHJlc29sdmVkQXJyYXlbaV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtYXhSZWNvcmQ7CiAgICB9LAoKICAgIF9mdW5jdGlvbk1pbkJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgIHZhciByZXNvbHZlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICB2YXIga2V5RnVuY3Rpb24gPSB0aGlzLmNyZWF0ZUtleUZ1bmN0aW9uKGV4cHJlZk5vZGUsIFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddKTsKICAgICAgdmFyIG1pbk51bWJlciA9IEluZmluaXR5OwogICAgICB2YXIgbWluUmVjb3JkOwogICAgICB2YXIgY3VycmVudDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgIGlmIChjdXJyZW50IDwgbWluTnVtYmVyKSB7CiAgICAgICAgICBtaW5OdW1iZXIgPSBjdXJyZW50OwogICAgICAgICAgbWluUmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1pblJlY29yZDsKICAgIH0sCgogICAgY3JlYXRlS2V5RnVuY3Rpb246IGZ1bmN0aW9uKGV4cHJlZk5vZGUsIGFsbG93ZWRUeXBlcykgewogICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICB2YXIga2V5RnVuYyA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICB2YXIgY3VycmVudCA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIHgpOwogICAgICAgIGlmIChhbGxvd2VkVHlwZXMuaW5kZXhPZih0aGF0Ll9nZXRUeXBlTmFtZShjdXJyZW50KSkgPCAwKSB7CiAgICAgICAgICB2YXIgbXNnID0gIlR5cGVFcnJvcjogZXhwZWN0ZWQgb25lIG9mICIgKyBhbGxvd2VkVHlwZXMgKwogICAgICAgICAgICAgICAgICAgICIsIHJlY2VpdmVkICIgKyB0aGF0Ll9nZXRUeXBlTmFtZShjdXJyZW50KTsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY3VycmVudDsKICAgICAgfTsKICAgICAgcmV0dXJuIGtleUZ1bmM7CiAgICB9CgogIH07CgogIGZ1bmN0aW9uIGNvbXBpbGUoc3RyZWFtKSB7CiAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcigpOwogICAgdmFyIGFzdCA9IHBhcnNlci5wYXJzZShzdHJlYW0pOwogICAgcmV0dXJuIGFzdDsKICB9CgogIGZ1bmN0aW9uIHRva2VuaXplKHN0cmVhbSkgewogICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgcmV0dXJuIGxleGVyLnRva2VuaXplKHN0cmVhbSk7CiAgfQoKICBmdW5jdGlvbiBzZWFyY2goZGF0YSwgZXhwcmVzc2lvbikgewogICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcigpOwogICAgICAvLyBUaGlzIG5lZWRzIHRvIGJlIGltcHJvdmVkLiAgQm90aCB0aGUgaW50ZXJwcmV0ZXIgYW5kIHJ1bnRpbWUgZGVwZW5kIG9uCiAgICAgIC8vIGVhY2ggb3RoZXIuICBUaGUgcnVudGltZSBuZWVkcyB0aGUgaW50ZXJwcmV0ZXIgdG8gc3VwcG9ydCBleHByZWZzLgogICAgICAvLyBUaGVyZSdzIGxpa2VseSBhIGNsZWFuIHdheSB0byBhdm9pZCB0aGUgY3ljbGljIGRlcGVuZGVuY3kuCiAgICAgIHZhciBydW50aW1lID0gbmV3IFJ1bnRpbWUoKTsKICAgICAgdmFyIGludGVycHJldGVyID0gbmV3IFRyZWVJbnRlcnByZXRlcihydW50aW1lKTsKICAgICAgcnVudGltZS5faW50ZXJwcmV0ZXIgPSBpbnRlcnByZXRlcjsKICAgICAgdmFyIG5vZGUgPSBwYXJzZXIucGFyc2UoZXhwcmVzc2lvbik7CiAgICAgIHJldHVybiBpbnRlcnByZXRlci5zZWFyY2gobm9kZSwgZGF0YSk7CiAgfQoKICBleHBvcnRzLnRva2VuaXplID0gdG9rZW5pemU7CiAgZXhwb3J0cy5jb21waWxlID0gY29tcGlsZTsKICBleHBvcnRzLnNlYXJjaCA9IHNlYXJjaDsKICBleHBvcnRzLnN0cmljdERlZXBFcXVhbCA9IHN0cmljdERlZXBFcXVhbDsKfSkodHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiID8gdGhpcy5qbWVzcGF0aCA9IHt9IDogZXhwb3J0cyk7Cgp9LHt9XSw5MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIHNoaW0gZm9yIHVzaW5nIHByb2Nlc3MgaW4gYnJvd3Nlcgp2YXIgcHJvY2VzcyA9IG1vZHVsZS5leHBvcnRzID0ge307CgovLyBjYWNoZWQgZnJvbSB3aGF0ZXZlciBnbG9iYWwgaXMgcHJlc2VudCBzbyB0aGF0IHRlc3QgcnVubmVycyB0aGF0IHN0dWIgaXQKLy8gZG9uJ3QgYnJlYWsgdGhpbmdzLiAgQnV0IHdlIG5lZWQgdG8gd3JhcCBpdCBpbiBhIHRyeSBjYXRjaCBpbiBjYXNlIGl0IGlzCi8vIHdyYXBwZWQgaW4gc3RyaWN0IG1vZGUgY29kZSB3aGljaCBkb2Vzbid0IGRlZmluZSBhbnkgZ2xvYmFscy4gIEl0J3MgaW5zaWRlIGEKLy8gZnVuY3Rpb24gYmVjYXVzZSB0cnkvY2F0Y2hlcyBkZW9wdGltaXplIGluIGNlcnRhaW4gZW5naW5lcy4KCnZhciBjYWNoZWRTZXRUaW1lb3V0Owp2YXIgY2FjaGVkQ2xlYXJUaW1lb3V0OwoKZnVuY3Rpb24gZGVmYXVsdFNldFRpbW91dCgpIHsKICAgIHRocm93IG5ldyBFcnJvcignc2V0VGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCcpOwp9CmZ1bmN0aW9uIGRlZmF1bHRDbGVhclRpbWVvdXQgKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQnKTsKfQooZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgICBpZiAodHlwZW9mIHNldFRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0OwogICAgfQogICAgdHJ5IHsKICAgICAgICBpZiAodHlwZW9mIGNsZWFyVGltZW91dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgIH0KfSAoKSkKZnVuY3Rpb24gcnVuVGltZW91dChmdW4pIHsKICAgIGlmIChjYWNoZWRTZXRUaW1lb3V0ID09PSBzZXRUaW1lb3V0KSB7CiAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zCiAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgIH0KICAgIC8vIGlmIHNldFRpbWVvdXQgd2Fzbid0IGF2YWlsYWJsZSBidXQgd2FzIGxhdHRlciBkZWZpbmVkCiAgICBpZiAoKGNhY2hlZFNldFRpbWVvdXQgPT09IGRlZmF1bHRTZXRUaW1vdXQgfHwgIWNhY2hlZFNldFRpbWVvdXQpICYmIHNldFRpbWVvdXQpIHsKICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICByZXR1cm4gc2V0VGltZW91dChmdW4sIDApOwogICAgfQogICAgdHJ5IHsKICAgICAgICAvLyB3aGVuIHdoZW4gc29tZWJvZHkgaGFzIHNjcmV3ZWQgd2l0aCBzZXRUaW1lb3V0IGJ1dCBubyBJLkUuIG1hZGRuZXNzCiAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQoZnVuLCAwKTsKICAgIH0gY2F0Y2goZSl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0IHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5CiAgICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwobnVsbCwgZnVuLCAwKTsKICAgICAgICB9IGNhdGNoKGUpewogICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvcgogICAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dC5jYWxsKHRoaXMsIGZ1biwgMCk7CiAgICAgICAgfQogICAgfQoKCn0KZnVuY3Rpb24gcnVuQ2xlYXJUaW1lb3V0KG1hcmtlcikgewogICAgaWYgKGNhY2hlZENsZWFyVGltZW91dCA9PT0gY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zCiAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dChtYXJrZXIpOwogICAgfQogICAgLy8gaWYgY2xlYXJUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgaWYgKChjYWNoZWRDbGVhclRpbWVvdXQgPT09IGRlZmF1bHRDbGVhclRpbWVvdXQgfHwgIWNhY2hlZENsZWFyVGltZW91dCkgJiYgY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0OwogICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTsKICAgIH0KICAgIHRyeSB7CiAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQobWFya2VyKTsKICAgIH0gY2F0Y2ggKGUpewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIFdoZW4gd2UgYXJlIGluIEkuRS4gYnV0IHRoZSBzY3JpcHQgaGFzIGJlZW4gZXZhbGVkIHNvIEkuRS4gZG9lc24ndCAgdHJ1c3QgdGhlIGdsb2JhbCBvYmplY3Qgd2hlbiBjYWxsZWQgbm9ybWFsbHkKICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKG51bGwsIG1hcmtlcik7CiAgICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUgYnV0IHdoZW4gaXQncyBhIHZlcnNpb24gb2YgSS5FLiB0aGF0IG11c3QgaGF2ZSB0aGUgZ2xvYmFsIG9iamVjdCBmb3IgJ3RoaXMnLCBob3BmdWxseSBvdXIgY29udGV4dCBjb3JyZWN0IG90aGVyd2lzZSBpdCB3aWxsIHRocm93IGEgZ2xvYmFsIGVycm9yLgogICAgICAgICAgICAvLyBTb21lIHZlcnNpb25zIG9mIEkuRS4gaGF2ZSBkaWZmZXJlbnQgcnVsZXMgZm9yIGNsZWFyVGltZW91dCB2cyBzZXRUaW1lb3V0CiAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbCh0aGlzLCBtYXJrZXIpOwogICAgICAgIH0KICAgIH0KCgoKfQp2YXIgcXVldWUgPSBbXTsKdmFyIGRyYWluaW5nID0gZmFsc2U7CnZhciBjdXJyZW50UXVldWU7CnZhciBxdWV1ZUluZGV4ID0gLTE7CgpmdW5jdGlvbiBjbGVhblVwTmV4dFRpY2soKSB7CiAgICBpZiAoIWRyYWluaW5nIHx8ICFjdXJyZW50UXVldWUpIHsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgaWYgKGN1cnJlbnRRdWV1ZS5sZW5ndGgpIHsKICAgICAgICBxdWV1ZSA9IGN1cnJlbnRRdWV1ZS5jb25jYXQocXVldWUpOwogICAgfSBlbHNlIHsKICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICB9CiAgICBpZiAocXVldWUubGVuZ3RoKSB7CiAgICAgICAgZHJhaW5RdWV1ZSgpOwogICAgfQp9CgpmdW5jdGlvbiBkcmFpblF1ZXVlKCkgewogICAgaWYgKGRyYWluaW5nKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHRpbWVvdXQgPSBydW5UaW1lb3V0KGNsZWFuVXBOZXh0VGljayk7CiAgICBkcmFpbmluZyA9IHRydWU7CgogICAgdmFyIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgIHdoaWxlKGxlbikgewogICAgICAgIGN1cnJlbnRRdWV1ZSA9IHF1ZXVlOwogICAgICAgIHF1ZXVlID0gW107CiAgICAgICAgd2hpbGUgKCsrcXVldWVJbmRleCA8IGxlbikgewogICAgICAgICAgICBpZiAoY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50UXVldWVbcXVldWVJbmRleF0ucnVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICAgIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgIH0KICAgIGN1cnJlbnRRdWV1ZSA9IG51bGw7CiAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgcnVuQ2xlYXJUaW1lb3V0KHRpbWVvdXQpOwp9Cgpwcm9jZXNzLm5leHRUaWNrID0gZnVuY3Rpb24gKGZ1bikgewogICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCAtIDEpOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgfQogICAgfQogICAgcXVldWUucHVzaChuZXcgSXRlbShmdW4sIGFyZ3MpKTsKICAgIGlmIChxdWV1ZS5sZW5ndGggPT09IDEgJiYgIWRyYWluaW5nKSB7CiAgICAgICAgcnVuVGltZW91dChkcmFpblF1ZXVlKTsKICAgIH0KfTsKCi8vIHY4IGxpa2VzIHByZWRpY3RpYmxlIG9iamVjdHMKZnVuY3Rpb24gSXRlbShmdW4sIGFycmF5KSB7CiAgICB0aGlzLmZ1biA9IGZ1bjsKICAgIHRoaXMuYXJyYXkgPSBhcnJheTsKfQpJdGVtLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmZ1bi5hcHBseShudWxsLCB0aGlzLmFycmF5KTsKfTsKcHJvY2Vzcy50aXRsZSA9ICdicm93c2VyJzsKcHJvY2Vzcy5icm93c2VyID0gdHJ1ZTsKcHJvY2Vzcy5lbnYgPSB7fTsKcHJvY2Vzcy5hcmd2ID0gW107CnByb2Nlc3MudmVyc2lvbiA9ICcnOyAvLyBlbXB0eSBzdHJpbmcgdG8gYXZvaWQgcmVnZXhwIGlzc3Vlcwpwcm9jZXNzLnZlcnNpb25zID0ge307CgpmdW5jdGlvbiBub29wKCkge30KCnByb2Nlc3Mub24gPSBub29wOwpwcm9jZXNzLmFkZExpc3RlbmVyID0gbm9vcDsKcHJvY2Vzcy5vbmNlID0gbm9vcDsKcHJvY2Vzcy5vZmYgPSBub29wOwpwcm9jZXNzLnJlbW92ZUxpc3RlbmVyID0gbm9vcDsKcHJvY2Vzcy5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBub29wOwpwcm9jZXNzLmVtaXQgPSBub29wOwpwcm9jZXNzLnByZXBlbmRMaXN0ZW5lciA9IG5vb3A7CnByb2Nlc3MucHJlcGVuZE9uY2VMaXN0ZW5lciA9IG5vb3A7Cgpwcm9jZXNzLmxpc3RlbmVycyA9IGZ1bmN0aW9uIChuYW1lKSB7IHJldHVybiBbXSB9Cgpwcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmJpbmRpbmcgaXMgbm90IHN1cHBvcnRlZCcpOwp9OwoKcHJvY2Vzcy5jd2QgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAnLycgfTsKcHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7Cn07CnByb2Nlc3MudW1hc2sgPSBmdW5jdGlvbigpIHsgcmV0dXJuIDA7IH07Cgp9LHt9XSw5MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCid1c2Ugc3RyaWN0JzsKCi8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCi8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CmZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogIHNlcCA9IHNlcCB8fCAnJic7CiAgZXEgPSBlcSB8fCAnPSc7CiAgdmFyIG9iaiA9IHt9OwoKICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgcXMgPSBxcy5zcGxpdChzZXApOwoKICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgfQoKICB2YXIgbGVuID0gcXMubGVuZ3RoOwogIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICBsZW4gPSBtYXhLZXlzOwogIH0KCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKCiAgICBpZiAoaWR4ID49IDApIHsKICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgIH0gZWxzZSB7CiAgICAgIGtzdHIgPSB4OwogICAgICB2c3RyID0gJyc7CiAgICB9CgogICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CgogICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgIG9ialtrXSA9IHY7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICBvYmpba10ucHVzaCh2KTsKICAgIH0gZWxzZSB7CiAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgfQogIH0KCiAgcmV0dXJuIG9iajsKfTsKCnZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCn0se31dLDkyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKJ3VzZSBzdHJpY3QnOwoKdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICBjYXNlICdzdHJpbmcnOgogICAgICByZXR1cm4gdjsKCiAgICBjYXNlICdib29sZWFuJzoKICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwoKICAgIGNhc2UgJ251bWJlcic6CiAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gJyc7CiAgfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICBzZXAgPSBzZXAgfHwgJyYnOwogIGVxID0gZXEgfHwgJz0nOwogIGlmIChvYmogPT09IG51bGwpIHsKICAgIG9iaiA9IHVuZGVmaW5lZDsKICB9CgogIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgcmV0dXJuIG1hcChvYmplY3RLZXlzKG9iaiksIGZ1bmN0aW9uKGspIHsKICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIHJldHVybiBtYXAob2JqW2tdLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICB9KS5qb2luKHNlcCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgfQogICAgfSkuam9pbihzZXApOwoKICB9CgogIGlmICghbmFtZSkgcmV0dXJuICcnOwogIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG5hbWUpKSArIGVxICsKICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKfTsKCnZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCmZ1bmN0aW9uIG1hcCAoeHMsIGYpIHsKICBpZiAoeHMubWFwKSByZXR1cm4geHMubWFwKGYpOwogIHZhciByZXMgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSB7CiAgICByZXMucHVzaChmKHhzW2ldLCBpKSk7CiAgfQogIHJldHVybiByZXM7Cn0KCnZhciBvYmplY3RLZXlzID0gT2JqZWN0LmtleXMgfHwgZnVuY3Rpb24gKG9iaikgewogIHZhciByZXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgcmVzLnB1c2goa2V5KTsKICB9CiAgcmV0dXJuIHJlczsKfTsKCn0se31dLDkzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKZXhwb3J0cy5kZWNvZGUgPSBleHBvcnRzLnBhcnNlID0gcmVxdWlyZSgnLi9kZWNvZGUnKTsKZXhwb3J0cy5lbmNvZGUgPSBleHBvcnRzLnN0cmluZ2lmeSA9IHJlcXVpcmUoJy4vZW5jb2RlJyk7Cgp9LHsiLi9kZWNvZGUiOjkxLCIuL2VuY29kZSI6OTJ9XSw5NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCid1c2Ugc3RyaWN0JzsKCi8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCi8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CmZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogIHNlcCA9IHNlcCB8fCAnJic7CiAgZXEgPSBlcSB8fCAnPSc7CiAgdmFyIG9iaiA9IHt9OwoKICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgcXMgPSBxcy5zcGxpdChzZXApOwoKICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgfQoKICB2YXIgbGVuID0gcXMubGVuZ3RoOwogIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICBsZW4gPSBtYXhLZXlzOwogIH0KCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKCiAgICBpZiAoaWR4ID49IDApIHsKICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgIH0gZWxzZSB7CiAgICAgIGtzdHIgPSB4OwogICAgICB2c3RyID0gJyc7CiAgICB9CgogICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CgogICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgIG9ialtrXSA9IHY7CiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICBvYmpba10ucHVzaCh2KTsKICAgIH0gZWxzZSB7CiAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgfQogIH0KCiAgcmV0dXJuIG9iajsKfTsKCn0se31dLDk1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKJ3VzZSBzdHJpY3QnOwoKdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICBjYXNlICdzdHJpbmcnOgogICAgICByZXR1cm4gdjsKCiAgICBjYXNlICdib29sZWFuJzoKICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwoKICAgIGNhc2UgJ251bWJlcic6CiAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gJyc7CiAgfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICBzZXAgPSBzZXAgfHwgJyYnOwogIGVxID0gZXEgfHwgJz0nOwogIGlmIChvYmogPT09IG51bGwpIHsKICAgIG9iaiA9IHVuZGVmaW5lZDsKICB9CgogIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iaikubWFwKGZ1bmN0aW9uKGspIHsKICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIHJldHVybiBvYmpba10ubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUodikpOwogICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9ialtrXSkpOwogICAgICB9CiAgICB9KS5qb2luKHNlcCk7CgogIH0KCiAgaWYgKCFuYW1lKSByZXR1cm4gJyc7CiAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUobmFtZSkpICsgZXEgKwogICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9iaikpOwp9OwoKfSx7fV0sOTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewphcmd1bWVudHNbNF1bOTNdWzBdLmFwcGx5KGV4cG9ydHMsYXJndW1lbnRzKQp9LHsiLi9kZWNvZGUiOjk0LCIuL2VuY29kZSI6OTUsImR1cCI6OTN9XSw5NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAoc2V0SW1tZWRpYXRlLGNsZWFySW1tZWRpYXRlKXsoZnVuY3Rpb24gKCl7CnZhciBuZXh0VGljayA9IHJlcXVpcmUoJ3Byb2Nlc3MvYnJvd3Nlci5qcycpLm5leHRUaWNrOwp2YXIgYXBwbHkgPSBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHk7CnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKdmFyIGltbWVkaWF0ZUlkcyA9IHt9Owp2YXIgbmV4dEltbWVkaWF0ZUlkID0gMDsKCi8vIERPTSBBUElzLCBmb3IgY29tcGxldGVuZXNzCgpleHBvcnRzLnNldFRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRUaW1lb3V0LCB3aW5kb3csIGFyZ3VtZW50cyksIGNsZWFyVGltZW91dCk7Cn07CmV4cG9ydHMuc2V0SW50ZXJ2YWwgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRJbnRlcnZhbCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhckludGVydmFsKTsKfTsKZXhwb3J0cy5jbGVhclRpbWVvdXQgPQpleHBvcnRzLmNsZWFySW50ZXJ2YWwgPSBmdW5jdGlvbih0aW1lb3V0KSB7IHRpbWVvdXQuY2xvc2UoKTsgfTsKCmZ1bmN0aW9uIFRpbWVvdXQoaWQsIGNsZWFyRm4pIHsKICB0aGlzLl9pZCA9IGlkOwogIHRoaXMuX2NsZWFyRm4gPSBjbGVhckZuOwp9ClRpbWVvdXQucHJvdG90eXBlLnVucmVmID0gVGltZW91dC5wcm90b3R5cGUucmVmID0gZnVuY3Rpb24oKSB7fTsKVGltZW91dC5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9jbGVhckZuLmNhbGwod2luZG93LCB0aGlzLl9pZCk7Cn07CgovLyBEb2VzIG5vdCBzdGFydCB0aGUgdGltZSwganVzdCBzZXRzIHVwIHRoZSBtZW1iZXJzIG5lZWRlZC4KZXhwb3J0cy5lbnJvbGwgPSBmdW5jdGlvbihpdGVtLCBtc2VjcykgewogIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICBpdGVtLl9pZGxlVGltZW91dCA9IG1zZWNzOwp9OwoKZXhwb3J0cy51bmVucm9sbCA9IGZ1bmN0aW9uKGl0ZW0pIHsKICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgaXRlbS5faWRsZVRpbWVvdXQgPSAtMTsKfTsKCmV4cG9ydHMuX3VucmVmQWN0aXZlID0gZXhwb3J0cy5hY3RpdmUgPSBmdW5jdGlvbihpdGVtKSB7CiAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwoKICB2YXIgbXNlY3MgPSBpdGVtLl9pZGxlVGltZW91dDsKICBpZiAobXNlY3MgPj0gMCkgewogICAgaXRlbS5faWRsZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gb25UaW1lb3V0KCkgewogICAgICBpZiAoaXRlbS5fb25UaW1lb3V0KQogICAgICAgIGl0ZW0uX29uVGltZW91dCgpOwogICAgfSwgbXNlY3MpOwogIH0KfTsKCi8vIFRoYXQncyBub3QgaG93IG5vZGUuanMgaW1wbGVtZW50cyBpdCBidXQgdGhlIGV4cG9zZWQgYXBpIGlzIHRoZSBzYW1lLgpleHBvcnRzLnNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBzZXRJbW1lZGlhdGUgOiBmdW5jdGlvbihmbikgewogIHZhciBpZCA9IG5leHRJbW1lZGlhdGVJZCsrOwogIHZhciBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA8IDIgPyBmYWxzZSA6IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgaW1tZWRpYXRlSWRzW2lkXSA9IHRydWU7CgogIG5leHRUaWNrKGZ1bmN0aW9uIG9uTmV4dFRpY2soKSB7CiAgICBpZiAoaW1tZWRpYXRlSWRzW2lkXSkgewogICAgICAvLyBmbi5jYWxsKCkgaXMgZmFzdGVyIHNvIHdlIG9wdGltaXplIGZvciB0aGUgY29tbW9uIHVzZS1jYXNlCiAgICAgIC8vIEBzZWUgaHR0cDovL2pzcGVyZi5jb20vY2FsbC1hcHBseS1zZWd1CiAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm4uY2FsbChudWxsKTsKICAgICAgfQogICAgICAvLyBQcmV2ZW50IGlkcyBmcm9tIGxlYWtpbmcKICAgICAgZXhwb3J0cy5jbGVhckltbWVkaWF0ZShpZCk7CiAgICB9CiAgfSk7CgogIHJldHVybiBpZDsKfTsKCmV4cG9ydHMuY2xlYXJJbW1lZGlhdGUgPSB0eXBlb2YgY2xlYXJJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBjbGVhckltbWVkaWF0ZSA6IGZ1bmN0aW9uKGlkKSB7CiAgZGVsZXRlIGltbWVkaWF0ZUlkc1tpZF07Cn07Cn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlLHJlcXVpcmUoInRpbWVycyIpLmNsZWFySW1tZWRpYXRlKQp9LHsicHJvY2Vzcy9icm93c2VyLmpzIjo5MCwidGltZXJzIjo5N31dLDk4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKdmFyIHB1bnljb2RlID0gcmVxdWlyZSgncHVueWNvZGUnKTsKCmV4cG9ydHMucGFyc2UgPSB1cmxQYXJzZTsKZXhwb3J0cy5yZXNvbHZlID0gdXJsUmVzb2x2ZTsKZXhwb3J0cy5yZXNvbHZlT2JqZWN0ID0gdXJsUmVzb2x2ZU9iamVjdDsKZXhwb3J0cy5mb3JtYXQgPSB1cmxGb3JtYXQ7CgpleHBvcnRzLlVybCA9IFVybDsKCmZ1bmN0aW9uIFVybCgpIHsKICB0aGlzLnByb3RvY29sID0gbnVsbDsKICB0aGlzLnNsYXNoZXMgPSBudWxsOwogIHRoaXMuYXV0aCA9IG51bGw7CiAgdGhpcy5ob3N0ID0gbnVsbDsKICB0aGlzLnBvcnQgPSBudWxsOwogIHRoaXMuaG9zdG5hbWUgPSBudWxsOwogIHRoaXMuaGFzaCA9IG51bGw7CiAgdGhpcy5zZWFyY2ggPSBudWxsOwogIHRoaXMucXVlcnkgPSBudWxsOwogIHRoaXMucGF0aG5hbWUgPSBudWxsOwogIHRoaXMucGF0aCA9IG51bGw7CiAgdGhpcy5ocmVmID0gbnVsbDsKfQoKLy8gUmVmZXJlbmNlOiBSRkMgMzk4NiwgUkZDIDE4MDgsIFJGQyAyMzk2CgovLyBkZWZpbmUgdGhlc2UgaGVyZSBzbyBhdCBsZWFzdCB0aGV5IG9ubHkgaGF2ZSB0byBiZQovLyBjb21waWxlZCBvbmNlIG9uIHRoZSBmaXJzdCBtb2R1bGUgbG9hZC4KdmFyIHByb3RvY29sUGF0dGVybiA9IC9eKFthLXowLTkuKy1dKzopL2ksCiAgICBwb3J0UGF0dGVybiA9IC86WzAtOV0qJC8sCgogICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgcmVzZXJ2ZWQgZm9yIGRlbGltaXRpbmcgVVJMcy4KICAgIC8vIFdlIGFjdHVhbGx5IGp1c3QgYXV0by1lc2NhcGUgdGhlc2UuCiAgICBkZWxpbXMgPSBbJzwnLCAnPicsICciJywgJ2AnLCAnICcsICdccicsICdcbicsICdcdCddLAoKICAgIC8vIFJGQyAyMzk2OiBjaGFyYWN0ZXJzIG5vdCBhbGxvd2VkIGZvciB2YXJpb3VzIHJlYXNvbnMuCiAgICB1bndpc2UgPSBbJ3snLCAnfScsICd8JywgJ1xcJywgJ14nLCAnYCddLmNvbmNhdChkZWxpbXMpLAoKICAgIC8vIEFsbG93ZWQgYnkgUkZDcywgYnV0IGNhdXNlIG9mIFhTUyBhdHRhY2tzLiAgQWx3YXlzIGVzY2FwZSB0aGVzZS4KICAgIGF1dG9Fc2NhcGUgPSBbJ1wnJ10uY29uY2F0KHVud2lzZSksCiAgICAvLyBDaGFyYWN0ZXJzIHRoYXQgYXJlIG5ldmVyIGV2ZXIgYWxsb3dlZCBpbiBhIGhvc3RuYW1lLgogICAgLy8gTm90ZSB0aGF0IGFueSBpbnZhbGlkIGNoYXJzIGFyZSBhbHNvIGhhbmRsZWQsIGJ1dCB0aGVzZQogICAgLy8gYXJlIHRoZSBvbmVzIHRoYXQgYXJlICpleHBlY3RlZCogdG8gYmUgc2Vlbiwgc28gd2UgZmFzdC1wYXRoCiAgICAvLyB0aGVtLgogICAgbm9uSG9zdENoYXJzID0gWyclJywgJy8nLCAnPycsICc7JywgJyMnXS5jb25jYXQoYXV0b0VzY2FwZSksCiAgICBob3N0RW5kaW5nQ2hhcnMgPSBbJy8nLCAnPycsICcjJ10sCiAgICBob3N0bmFtZU1heExlbiA9IDI1NSwKICAgIGhvc3RuYW1lUGFydFBhdHRlcm4gPSAvXlthLXowLTlBLVpfLV17MCw2M30kLywKICAgIGhvc3RuYW1lUGFydFN0YXJ0ID0gL14oW2EtejAtOUEtWl8tXXswLDYzfSkoLiopJC8sCiAgICAvLyBwcm90b2NvbHMgdGhhdCBjYW4gYWxsb3cgInVuc2FmZSIgYW5kICJ1bndpc2UiIGNoYXJzLgogICAgdW5zYWZlUHJvdG9jb2wgPSB7CiAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgfSwKICAgIC8vIHByb3RvY29scyB0aGF0IG5ldmVyIGhhdmUgYSBob3N0bmFtZS4KICAgIGhvc3RsZXNzUHJvdG9jb2wgPSB7CiAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgfSwKICAgIC8vIHByb3RvY29scyB0aGF0IGFsd2F5cyBjb250YWluIGEgLy8gYml0LgogICAgc2xhc2hlZFByb3RvY29sID0gewogICAgICAnaHR0cCc6IHRydWUsCiAgICAgICdodHRwcyc6IHRydWUsCiAgICAgICdmdHAnOiB0cnVlLAogICAgICAnZ29waGVyJzogdHJ1ZSwKICAgICAgJ2ZpbGUnOiB0cnVlLAogICAgICAnaHR0cDonOiB0cnVlLAogICAgICAnaHR0cHM6JzogdHJ1ZSwKICAgICAgJ2Z0cDonOiB0cnVlLAogICAgICAnZ29waGVyOic6IHRydWUsCiAgICAgICdmaWxlOic6IHRydWUKICAgIH0sCiAgICBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7CgpmdW5jdGlvbiB1cmxQYXJzZSh1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgaWYgKHVybCAmJiBpc09iamVjdCh1cmwpICYmIHVybCBpbnN0YW5jZW9mIFVybCkgcmV0dXJuIHVybDsKCiAgdmFyIHUgPSBuZXcgVXJsOwogIHUucGFyc2UodXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCk7CiAgcmV0dXJuIHU7Cn0KClVybC5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgaWYgKCFpc1N0cmluZyh1cmwpKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJQYXJhbWV0ZXIgJ3VybCcgbXVzdCBiZSBhIHN0cmluZywgbm90ICIgKyB0eXBlb2YgdXJsKTsKICB9CgogIHZhciByZXN0ID0gdXJsOwoKICAvLyB0cmltIGJlZm9yZSBwcm9jZWVkaW5nLgogIC8vIFRoaXMgaXMgdG8gc3VwcG9ydCBwYXJzZSBzdHVmZiBsaWtlICIgIGh0dHA6Ly9mb28uY29tICBcbiIKICByZXN0ID0gcmVzdC50cmltKCk7CgogIHZhciBwcm90byA9IHByb3RvY29sUGF0dGVybi5leGVjKHJlc3QpOwogIGlmIChwcm90bykgewogICAgcHJvdG8gPSBwcm90b1swXTsKICAgIHZhciBsb3dlclByb3RvID0gcHJvdG8udG9Mb3dlckNhc2UoKTsKICAgIHRoaXMucHJvdG9jb2wgPSBsb3dlclByb3RvOwogICAgcmVzdCA9IHJlc3Quc3Vic3RyKHByb3RvLmxlbmd0aCk7CiAgfQoKICAvLyBmaWd1cmUgb3V0IGlmIGl0J3MgZ290IGEgaG9zdAogIC8vIHVzZXJAc2VydmVyIGlzICphbHdheXMqIGludGVycHJldGVkIGFzIGEgaG9zdG5hbWUsIGFuZCB1cmwKICAvLyByZXNvbHV0aW9uIHdpbGwgdHJlYXQgLy9mb28vYmFyIGFzIGhvc3Q9Zm9vLHBhdGg9YmFyIGJlY2F1c2UgdGhhdCdzCiAgLy8gaG93IHRoZSBicm93c2VyIHJlc29sdmVzIHJlbGF0aXZlIFVSTHMuCiAgaWYgKHNsYXNoZXNEZW5vdGVIb3N0IHx8IHByb3RvIHx8IHJlc3QubWF0Y2goL15cL1wvW15AXC9dK0BbXkBcL10rLykpIHsKICAgIHZhciBzbGFzaGVzID0gcmVzdC5zdWJzdHIoMCwgMikgPT09ICcvLyc7CiAgICBpZiAoc2xhc2hlcyAmJiAhKHByb3RvICYmIGhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dKSkgewogICAgICByZXN0ID0gcmVzdC5zdWJzdHIoMik7CiAgICAgIHRoaXMuc2xhc2hlcyA9IHRydWU7CiAgICB9CiAgfQoKICBpZiAoIWhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dICYmCiAgICAgIChzbGFzaGVzIHx8IChwcm90byAmJiAhc2xhc2hlZFByb3RvY29sW3Byb3RvXSkpKSB7CgogICAgLy8gdGhlcmUncyBhIGhvc3RuYW1lLgogICAgLy8gdGhlIGZpcnN0IGluc3RhbmNlIG9mIC8sID8sIDssIG9yICMgZW5kcyB0aGUgaG9zdC4KICAgIC8vCiAgICAvLyBJZiB0aGVyZSBpcyBhbiBAIGluIHRoZSBob3N0bmFtZSwgdGhlbiBub24taG9zdCBjaGFycyAqYXJlKiBhbGxvd2VkCiAgICAvLyB0byB0aGUgbGVmdCBvZiB0aGUgbGFzdCBAIHNpZ24sIHVubGVzcyBzb21lIGhvc3QtZW5kaW5nIGNoYXJhY3RlcgogICAgLy8gY29tZXMgKmJlZm9yZSogdGhlIEAtc2lnbi4KICAgIC8vIFVSTHMgYXJlIG9ibm94aW91cy4KICAgIC8vCiAgICAvLyBleDoKICAgIC8vIGh0dHA6Ly9hQGJAYy8gPT4gdXNlcjphQGIgaG9zdDpjCiAgICAvLyBodHRwOi8vYUBiP0BjID0+IHVzZXI6YSBob3N0OmMgcGF0aDovP0BjCgogICAgLy8gdjAuMTIgVE9ETyhpc2FhY3MpOiBUaGlzIGlzIG5vdCBxdWl0ZSBob3cgQ2hyb21lIGRvZXMgdGhpbmdzLgogICAgLy8gUmV2aWV3IG91ciB0ZXN0IGNhc2UgYWdhaW5zdCBicm93c2VycyBtb3JlIGNvbXByZWhlbnNpdmVseS4KCiAgICAvLyBmaW5kIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiBhbnkgaG9zdEVuZGluZ0NoYXJzCiAgICB2YXIgaG9zdEVuZCA9IC0xOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob3N0RW5kaW5nQ2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGhlYyA9IHJlc3QuaW5kZXhPZihob3N0RW5kaW5nQ2hhcnNbaV0pOwogICAgICBpZiAoaGVjICE9PSAtMSAmJiAoaG9zdEVuZCA9PT0gLTEgfHwgaGVjIDwgaG9zdEVuZCkpCiAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgIH0KCiAgICAvLyBhdCB0aGlzIHBvaW50LCBlaXRoZXIgd2UgaGF2ZSBhbiBleHBsaWNpdCBwb2ludCB3aGVyZSB0aGUKICAgIC8vIGF1dGggcG9ydGlvbiBjYW5ub3QgZ28gcGFzdCwgb3IgdGhlIGxhc3QgQCBjaGFyIGlzIHRoZSBkZWNpZGVyLgogICAgdmFyIGF1dGgsIGF0U2lnbjsKICAgIGlmIChob3N0RW5kID09PSAtMSkgewogICAgICAvLyBhdFNpZ24gY2FuIGJlIGFueXdoZXJlLgogICAgICBhdFNpZ24gPSByZXN0Lmxhc3RJbmRleE9mKCdAJyk7CiAgICB9IGVsc2UgewogICAgICAvLyBhdFNpZ24gbXVzdCBiZSBpbiBhdXRoIHBvcnRpb24uCiAgICAgIC8vIGh0dHA6Ly9hQGIvY0BkID0+IGhvc3Q6YiBhdXRoOmEgcGF0aDovY0BkCiAgICAgIGF0U2lnbiA9IHJlc3QubGFzdEluZGV4T2YoJ0AnLCBob3N0RW5kKTsKICAgIH0KCiAgICAvLyBOb3cgd2UgaGF2ZSBhIHBvcnRpb24gd2hpY2ggaXMgZGVmaW5pdGVseSB0aGUgYXV0aC4KICAgIC8vIFB1bGwgdGhhdCBvZmYuCiAgICBpZiAoYXRTaWduICE9PSAtMSkgewogICAgICBhdXRoID0gcmVzdC5zbGljZSgwLCBhdFNpZ24pOwogICAgICByZXN0ID0gcmVzdC5zbGljZShhdFNpZ24gKyAxKTsKICAgICAgdGhpcy5hdXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgfQoKICAgIC8vIHRoZSBob3N0IGlzIHRoZSByZW1haW5pbmcgdG8gdGhlIGxlZnQgb2YgdGhlIGZpcnN0IG5vbi1ob3N0IGNoYXIKICAgIGhvc3RFbmQgPSAtMTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9uSG9zdENoYXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBoZWMgPSByZXN0LmluZGV4T2Yobm9uSG9zdENoYXJzW2ldKTsKICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgIGhvc3RFbmQgPSBoZWM7CiAgICB9CiAgICAvLyBpZiB3ZSBzdGlsbCBoYXZlIG5vdCBoaXQgaXQsIHRoZW4gdGhlIGVudGlyZSB0aGluZyBpcyBhIGhvc3QuCiAgICBpZiAoaG9zdEVuZCA9PT0gLTEpCiAgICAgIGhvc3RFbmQgPSByZXN0Lmxlbmd0aDsKCiAgICB0aGlzLmhvc3QgPSByZXN0LnNsaWNlKDAsIGhvc3RFbmQpOwogICAgcmVzdCA9IHJlc3Quc2xpY2UoaG9zdEVuZCk7CgogICAgLy8gcHVsbCBvdXQgcG9ydC4KICAgIHRoaXMucGFyc2VIb3N0KCk7CgogICAgLy8gd2UndmUgaW5kaWNhdGVkIHRoYXQgdGhlcmUgaXMgYSBob3N0bmFtZSwKICAgIC8vIHNvIGV2ZW4gaWYgaXQncyBlbXB0eSwgaXQgaGFzIHRvIGJlIHByZXNlbnQuCiAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKCiAgICAvLyBpZiBob3N0bmFtZSBiZWdpbnMgd2l0aCBbIGFuZCBlbmRzIHdpdGggXQogICAgLy8gYXNzdW1lIHRoYXQgaXQncyBhbiBJUHY2IGFkZHJlc3MuCiAgICB2YXIgaXB2Nkhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZVswXSA9PT0gJ1snICYmCiAgICAgICAgdGhpcy5ob3N0bmFtZVt0aGlzLmhvc3RuYW1lLmxlbmd0aCAtIDFdID09PSAnXSc7CgogICAgLy8gdmFsaWRhdGUgYSBsaXR0bGUuCiAgICBpZiAoIWlwdjZIb3N0bmFtZSkgewogICAgICB2YXIgaG9zdHBhcnRzID0gdGhpcy5ob3N0bmFtZS5zcGxpdCgvXC4vKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBob3N0cGFydHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdmFyIHBhcnQgPSBob3N0cGFydHNbaV07CiAgICAgICAgaWYgKCFwYXJ0KSBjb250aW51ZTsKICAgICAgICBpZiAoIXBhcnQubWF0Y2goaG9zdG5hbWVQYXJ0UGF0dGVybikpIHsKICAgICAgICAgIHZhciBuZXdwYXJ0ID0gJyc7CiAgICAgICAgICBmb3IgKHZhciBqID0gMCwgayA9IHBhcnQubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgIGlmIChwYXJ0LmNoYXJDb2RlQXQoaikgPiAxMjcpIHsKICAgICAgICAgICAgICAvLyB3ZSByZXBsYWNlIG5vbi1BU0NJSSBjaGFyIHdpdGggYSB0ZW1wb3JhcnkgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRoaXMgdG8gbWFrZSBzdXJlIHNpemUgb2YgaG9zdG5hbWUgaXMgbm90CiAgICAgICAgICAgICAgLy8gYnJva2VuIGJ5IHJlcGxhY2luZyBub24tQVNDSUkgYnkgbm90aGluZwogICAgICAgICAgICAgIG5ld3BhcnQgKz0gJ3gnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld3BhcnQgKz0gcGFydFtqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gd2UgdGVzdCBhZ2FpbiB3aXRoIEFTQ0lJIGNoYXIgb25seQogICAgICAgICAgaWYgKCFuZXdwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFBhdHRlcm4pKSB7CiAgICAgICAgICAgIHZhciB2YWxpZFBhcnRzID0gaG9zdHBhcnRzLnNsaWNlKDAsIGkpOwogICAgICAgICAgICB2YXIgbm90SG9zdCA9IGhvc3RwYXJ0cy5zbGljZShpICsgMSk7CiAgICAgICAgICAgIHZhciBiaXQgPSBwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFN0YXJ0KTsKICAgICAgICAgICAgaWYgKGJpdCkgewogICAgICAgICAgICAgIHZhbGlkUGFydHMucHVzaChiaXRbMV0pOwogICAgICAgICAgICAgIG5vdEhvc3QudW5zaGlmdChiaXRbMl0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub3RIb3N0Lmxlbmd0aCkgewogICAgICAgICAgICAgIHJlc3QgPSAnLycgKyBub3RIb3N0LmpvaW4oJy4nKSArIHJlc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHZhbGlkUGFydHMuam9pbignLicpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5ob3N0bmFtZS5sZW5ndGggPiBob3N0bmFtZU1heExlbikgewogICAgICB0aGlzLmhvc3RuYW1lID0gJyc7CiAgICB9IGVsc2UgewogICAgICAvLyBob3N0bmFtZXMgYXJlIGFsd2F5cyBsb3dlciBjYXNlLgogICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgfQoKICAgIGlmICghaXB2Nkhvc3RuYW1lKSB7CiAgICAgIC8vIElETkEgU3VwcG9ydDogUmV0dXJucyBhIHB1bnkgY29kZWQgcmVwcmVzZW50YXRpb24gb2YgImRvbWFpbiIuCiAgICAgIC8vIEl0IG9ubHkgY29udmVydHMgdGhlIHBhcnQgb2YgdGhlIGRvbWFpbiBuYW1lIHRoYXQKICAgICAgLy8gaGFzIG5vbiBBU0NJSSBjaGFyYWN0ZXJzLiBJLmUuIGl0IGRvc2VudCBtYXR0ZXIgaWYKICAgICAgLy8geW91IGNhbGwgaXQgd2l0aCBhIGRvbWFpbiB0aGF0IGFscmVhZHkgaXMgaW4gQVNDSUkuCiAgICAgIHZhciBkb21haW5BcnJheSA9IHRoaXMuaG9zdG5hbWUuc3BsaXQoJy4nKTsKICAgICAgdmFyIG5ld091dCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvbWFpbkFycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHMgPSBkb21haW5BcnJheVtpXTsKICAgICAgICBuZXdPdXQucHVzaChzLm1hdGNoKC9bXkEtWmEtejAtOV8tXS8pID8KICAgICAgICAgICAgJ3huLS0nICsgcHVueWNvZGUuZW5jb2RlKHMpIDogcyk7CiAgICAgIH0KICAgICAgdGhpcy5ob3N0bmFtZSA9IG5ld091dC5qb2luKCcuJyk7CiAgICB9CgogICAgdmFyIHAgPSB0aGlzLnBvcnQgPyAnOicgKyB0aGlzLnBvcnQgOiAnJzsKICAgIHZhciBoID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKICAgIHRoaXMuaG9zdCA9IGggKyBwOwogICAgdGhpcy5ocmVmICs9IHRoaXMuaG9zdDsKCiAgICAvLyBzdHJpcCBbIGFuZCBdIGZyb20gdGhlIGhvc3RuYW1lCiAgICAvLyB0aGUgaG9zdCBmaWVsZCBzdGlsbCByZXRhaW5zIHRoZW0sIHRob3VnaAogICAgaWYgKGlwdjZIb3N0bmFtZSkgewogICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS5zdWJzdHIoMSwgdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAyKTsKICAgICAgaWYgKHJlc3RbMF0gIT09ICcvJykgewogICAgICAgIHJlc3QgPSAnLycgKyByZXN0OwogICAgICB9CiAgICB9CiAgfQoKICAvLyBub3cgcmVzdCBpcyBzZXQgdG8gdGhlIHBvc3QtaG9zdCBzdHVmZi4KICAvLyBjaG9wIG9mZiBhbnkgZGVsaW0gY2hhcnMuCiAgaWYgKCF1bnNhZmVQcm90b2NvbFtsb3dlclByb3RvXSkgewoKICAgIC8vIEZpcnN0LCBtYWtlIDEwMCUgc3VyZSB0aGF0IGFueSAiYXV0b0VzY2FwZSIgY2hhcnMgZ2V0CiAgICAvLyBlc2NhcGVkLCBldmVuIGlmIGVuY29kZVVSSUNvbXBvbmVudCBkb2Vzbid0IHRoaW5rIHRoZXkKICAgIC8vIG5lZWQgdG8gYmUuCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGF1dG9Fc2NhcGUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBhZSA9IGF1dG9Fc2NhcGVbaV07CiAgICAgIHZhciBlc2MgPSBlbmNvZGVVUklDb21wb25lbnQoYWUpOwogICAgICBpZiAoZXNjID09PSBhZSkgewogICAgICAgIGVzYyA9IGVzY2FwZShhZSk7CiAgICAgIH0KICAgICAgcmVzdCA9IHJlc3Quc3BsaXQoYWUpLmpvaW4oZXNjKTsKICAgIH0KICB9CgoKICAvLyBjaG9wIG9mZiBmcm9tIHRoZSB0YWlsIGZpcnN0LgogIHZhciBoYXNoID0gcmVzdC5pbmRleE9mKCcjJyk7CiAgaWYgKGhhc2ggIT09IC0xKSB7CiAgICAvLyBnb3QgYSBmcmFnbWVudCBzdHJpbmcuCiAgICB0aGlzLmhhc2ggPSByZXN0LnN1YnN0cihoYXNoKTsKICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIGhhc2gpOwogIH0KICB2YXIgcW0gPSByZXN0LmluZGV4T2YoJz8nKTsKICBpZiAocW0gIT09IC0xKSB7CiAgICB0aGlzLnNlYXJjaCA9IHJlc3Quc3Vic3RyKHFtKTsKICAgIHRoaXMucXVlcnkgPSByZXN0LnN1YnN0cihxbSArIDEpOwogICAgaWYgKHBhcnNlUXVlcnlTdHJpbmcpIHsKICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHRoaXMucXVlcnkpOwogICAgfQogICAgcmVzdCA9IHJlc3Quc2xpY2UoMCwgcW0pOwogIH0gZWxzZSBpZiAocGFyc2VRdWVyeVN0cmluZykgewogICAgLy8gbm8gcXVlcnkgc3RyaW5nLCBidXQgcGFyc2VRdWVyeVN0cmluZyBzdGlsbCByZXF1ZXN0ZWQKICAgIHRoaXMuc2VhcmNoID0gJyc7CiAgICB0aGlzLnF1ZXJ5ID0ge307CiAgfQogIGlmIChyZXN0KSB0aGlzLnBhdGhuYW1lID0gcmVzdDsKICBpZiAoc2xhc2hlZFByb3RvY29sW2xvd2VyUHJvdG9dICYmCiAgICAgIHRoaXMuaG9zdG5hbWUgJiYgIXRoaXMucGF0aG5hbWUpIHsKICAgIHRoaXMucGF0aG5hbWUgPSAnLyc7CiAgfQoKICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgaWYgKHRoaXMucGF0aG5hbWUgfHwgdGhpcy5zZWFyY2gpIHsKICAgIHZhciBwID0gdGhpcy5wYXRobmFtZSB8fCAnJzsKICAgIHZhciBzID0gdGhpcy5zZWFyY2ggfHwgJyc7CiAgICB0aGlzLnBhdGggPSBwICsgczsKICB9CgogIC8vIGZpbmFsbHksIHJlY29uc3RydWN0IHRoZSBocmVmIGJhc2VkIG9uIHdoYXQgaGFzIGJlZW4gdmFsaWRhdGVkLgogIHRoaXMuaHJlZiA9IHRoaXMuZm9ybWF0KCk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBmb3JtYXQgYSBwYXJzZWQgb2JqZWN0IGludG8gYSB1cmwgc3RyaW5nCmZ1bmN0aW9uIHVybEZvcm1hdChvYmopIHsKICAvLyBlbnN1cmUgaXQncyBhbiBvYmplY3QsIGFuZCBub3QgYSBzdHJpbmcgdXJsLgogIC8vIElmIGl0J3MgYW4gb2JqLCB0aGlzIGlzIGEgbm8tb3AuCiAgLy8gdGhpcyB3YXksIHlvdSBjYW4gY2FsbCB1cmxfZm9ybWF0KCkgb24gc3RyaW5ncwogIC8vIHRvIGNsZWFuIHVwIHBvdGVudGlhbGx5IHdvbmt5IHVybHMuCiAgaWYgKGlzU3RyaW5nKG9iaikpIG9iaiA9IHVybFBhcnNlKG9iaik7CiAgaWYgKCEob2JqIGluc3RhbmNlb2YgVXJsKSkgcmV0dXJuIFVybC5wcm90b3R5cGUuZm9ybWF0LmNhbGwob2JqKTsKICByZXR1cm4gb2JqLmZvcm1hdCgpOwp9CgpVcmwucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKCkgewogIHZhciBhdXRoID0gdGhpcy5hdXRoIHx8ICcnOwogIGlmIChhdXRoKSB7CiAgICBhdXRoID0gZW5jb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgYXV0aCA9IGF1dGgucmVwbGFjZSgvJTNBL2ksICc6Jyk7CiAgICBhdXRoICs9ICdAJzsKICB9CgogIHZhciBwcm90b2NvbCA9IHRoaXMucHJvdG9jb2wgfHwgJycsCiAgICAgIHBhdGhuYW1lID0gdGhpcy5wYXRobmFtZSB8fCAnJywKICAgICAgaGFzaCA9IHRoaXMuaGFzaCB8fCAnJywKICAgICAgaG9zdCA9IGZhbHNlLAogICAgICBxdWVyeSA9ICcnOwoKICBpZiAodGhpcy5ob3N0KSB7CiAgICBob3N0ID0gYXV0aCArIHRoaXMuaG9zdDsKICB9IGVsc2UgaWYgKHRoaXMuaG9zdG5hbWUpIHsKICAgIGhvc3QgPSBhdXRoICsgKHRoaXMuaG9zdG5hbWUuaW5kZXhPZignOicpID09PSAtMSA/CiAgICAgICAgdGhpcy5ob3N0bmFtZSA6CiAgICAgICAgJ1snICsgdGhpcy5ob3N0bmFtZSArICddJyk7CiAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgIGhvc3QgKz0gJzonICsgdGhpcy5wb3J0OwogICAgfQogIH0KCiAgaWYgKHRoaXMucXVlcnkgJiYKICAgICAgaXNPYmplY3QodGhpcy5xdWVyeSkgJiYKICAgICAgT2JqZWN0LmtleXModGhpcy5xdWVyeSkubGVuZ3RoKSB7CiAgICBxdWVyeSA9IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeSh0aGlzLnF1ZXJ5KTsKICB9CgogIHZhciBzZWFyY2ggPSB0aGlzLnNlYXJjaCB8fCAocXVlcnkgJiYgKCc/JyArIHF1ZXJ5KSkgfHwgJyc7CgogIGlmIChwcm90b2NvbCAmJiBwcm90b2NvbC5zdWJzdHIoLTEpICE9PSAnOicpIHByb3RvY29sICs9ICc6JzsKCiAgLy8gb25seSB0aGUgc2xhc2hlZFByb3RvY29scyBnZXQgdGhlIC8vLiAgTm90IG1haWx0bzosIHhtcHA6LCBldGMuCiAgLy8gdW5sZXNzIHRoZXkgaGFkIHRoZW0gdG8gYmVnaW4gd2l0aC4KICBpZiAodGhpcy5zbGFzaGVzIHx8CiAgICAgICghcHJvdG9jb2wgfHwgc2xhc2hlZFByb3RvY29sW3Byb3RvY29sXSkgJiYgaG9zdCAhPT0gZmFsc2UpIHsKICAgIGhvc3QgPSAnLy8nICsgKGhvc3QgfHwgJycpOwogICAgaWYgKHBhdGhuYW1lICYmIHBhdGhuYW1lLmNoYXJBdCgwKSAhPT0gJy8nKSBwYXRobmFtZSA9ICcvJyArIHBhdGhuYW1lOwogIH0gZWxzZSBpZiAoIWhvc3QpIHsKICAgIGhvc3QgPSAnJzsKICB9CgogIGlmIChoYXNoICYmIGhhc2guY2hhckF0KDApICE9PSAnIycpIGhhc2ggPSAnIycgKyBoYXNoOwogIGlmIChzZWFyY2ggJiYgc2VhcmNoLmNoYXJBdCgwKSAhPT0gJz8nKSBzZWFyY2ggPSAnPycgKyBzZWFyY2g7CgogIHBhdGhuYW1lID0gcGF0aG5hbWUucmVwbGFjZSgvWz8jXS9nLCBmdW5jdGlvbihtYXRjaCkgewogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChtYXRjaCk7CiAgfSk7CiAgc2VhcmNoID0gc2VhcmNoLnJlcGxhY2UoJyMnLCAnJTIzJyk7CgogIHJldHVybiBwcm90b2NvbCArIGhvc3QgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7Cn07CgpmdW5jdGlvbiB1cmxSZXNvbHZlKHNvdXJjZSwgcmVsYXRpdmUpIHsKICByZXR1cm4gdXJsUGFyc2Uoc291cmNlLCBmYWxzZSwgdHJ1ZSkucmVzb2x2ZShyZWxhdGl2ZSk7Cn0KClVybC5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKHJlbGF0aXZlKSB7CiAgcmV0dXJuIHRoaXMucmVzb2x2ZU9iamVjdCh1cmxQYXJzZShyZWxhdGl2ZSwgZmFsc2UsIHRydWUpKS5mb3JtYXQoKTsKfTsKCmZ1bmN0aW9uIHVybFJlc29sdmVPYmplY3Qoc291cmNlLCByZWxhdGl2ZSkgewogIGlmICghc291cmNlKSByZXR1cm4gcmVsYXRpdmU7CiAgcmV0dXJuIHVybFBhcnNlKHNvdXJjZSwgZmFsc2UsIHRydWUpLnJlc29sdmVPYmplY3QocmVsYXRpdmUpOwp9CgpVcmwucHJvdG90eXBlLnJlc29sdmVPYmplY3QgPSBmdW5jdGlvbihyZWxhdGl2ZSkgewogIGlmIChpc1N0cmluZyhyZWxhdGl2ZSkpIHsKICAgIHZhciByZWwgPSBuZXcgVXJsKCk7CiAgICByZWwucGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKTsKICAgIHJlbGF0aXZlID0gcmVsOwogIH0KCiAgdmFyIHJlc3VsdCA9IG5ldyBVcmwoKTsKICBPYmplY3Qua2V5cyh0aGlzKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgIHJlc3VsdFtrXSA9IHRoaXNba107CiAgfSwgdGhpcyk7CgogIC8vIGhhc2ggaXMgYWx3YXlzIG92ZXJyaWRkZW4sIG5vIG1hdHRlciB3aGF0LgogIC8vIGV2ZW4gaHJlZj0iIiB3aWxsIHJlbW92ZSBpdC4KICByZXN1bHQuaGFzaCA9IHJlbGF0aXZlLmhhc2g7CgogIC8vIGlmIHRoZSByZWxhdGl2ZSB1cmwgaXMgZW1wdHksIHRoZW4gdGhlcmUncyBub3RoaW5nIGxlZnQgdG8gZG8gaGVyZS4KICBpZiAocmVsYXRpdmUuaHJlZiA9PT0gJycpIHsKICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8vIGhyZWZzIGxpa2UgLy9mb28vYmFyIGFsd2F5cyBjdXQgdG8gdGhlIHByb3RvY29sLgogIGlmIChyZWxhdGl2ZS5zbGFzaGVzICYmICFyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgLy8gdGFrZSBldmVyeXRoaW5nIGV4Y2VwdCB0aGUgcHJvdG9jb2wgZnJvbSByZWxhdGl2ZQogICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICBpZiAoayAhPT0gJ3Byb3RvY29sJykKICAgICAgICByZXN1bHRba10gPSByZWxhdGl2ZVtrXTsKICAgIH0pOwoKICAgIC8vdXJsUGFyc2UgYXBwZW5kcyB0cmFpbGluZyAvIHRvIHVybHMgbGlrZSBodHRwOi8vd3d3LmV4YW1wbGUuY29tCiAgICBpZiAoc2xhc2hlZFByb3RvY29sW3Jlc3VsdC5wcm90b2NvbF0gJiYKICAgICAgICByZXN1bHQuaG9zdG5hbWUgJiYgIXJlc3VsdC5wYXRobmFtZSkgewogICAgICByZXN1bHQucGF0aCA9IHJlc3VsdC5wYXRobmFtZSA9ICcvJzsKICAgIH0KCiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBpZiAocmVsYXRpdmUucHJvdG9jb2wgJiYgcmVsYXRpdmUucHJvdG9jb2wgIT09IHJlc3VsdC5wcm90b2NvbCkgewogICAgLy8gaWYgaXQncyBhIGtub3duIHVybCBwcm90b2NvbCwgdGhlbiBjaGFuZ2luZwogICAgLy8gdGhlIHByb3RvY29sIGRvZXMgd2VpcmQgdGhpbmdzCiAgICAvLyBmaXJzdCwgaWYgaXQncyBub3QgZmlsZTosIHRoZW4gd2UgTVVTVCBoYXZlIGEgaG9zdCwKICAgIC8vIGFuZCBpZiB0aGVyZSB3YXMgYSBwYXRoCiAgICAvLyB0byBiZWdpbiB3aXRoLCB0aGVuIHdlIE1VU1QgaGF2ZSBhIHBhdGguCiAgICAvLyBpZiBpdCBpcyBmaWxlOiwgdGhlbiB0aGUgaG9zdCBpcyBkcm9wcGVkLAogICAgLy8gYmVjYXVzZSB0aGF0J3Mga25vd24gdG8gYmUgaG9zdGxlc3MuCiAgICAvLyBhbnl0aGluZyBlbHNlIGlzIGFzc3VtZWQgdG8gYmUgYWJzb2x1dGUuCiAgICBpZiAoIXNsYXNoZWRQcm90b2NvbFtyZWxhdGl2ZS5wcm90b2NvbF0pIHsKICAgICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgIHJlc3VsdFtrXSA9IHJlbGF0aXZlW2tdOwogICAgICB9KTsKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgcmVzdWx0LnByb3RvY29sID0gcmVsYXRpdmUucHJvdG9jb2w7CiAgICBpZiAoIXJlbGF0aXZlLmhvc3QgJiYgIWhvc3RsZXNzUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgIHZhciByZWxQYXRoID0gKHJlbGF0aXZlLnBhdGhuYW1lIHx8ICcnKS5zcGxpdCgnLycpOwogICAgICB3aGlsZSAocmVsUGF0aC5sZW5ndGggJiYgIShyZWxhdGl2ZS5ob3N0ID0gcmVsUGF0aC5zaGlmdCgpKSk7CiAgICAgIGlmICghcmVsYXRpdmUuaG9zdCkgcmVsYXRpdmUuaG9zdCA9ICcnOwogICAgICBpZiAoIXJlbGF0aXZlLmhvc3RuYW1lKSByZWxhdGl2ZS5ob3N0bmFtZSA9ICcnOwogICAgICBpZiAocmVsUGF0aFswXSAhPT0gJycpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgIGlmIChyZWxQYXRoLmxlbmd0aCA8IDIpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbFBhdGguam9pbignLycpOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0LnBhdGhuYW1lID0gcmVsYXRpdmUucGF0aG5hbWU7CiAgICB9CiAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICByZXN1bHQuaG9zdCA9IHJlbGF0aXZlLmhvc3QgfHwgJyc7CiAgICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGg7CiAgICByZXN1bHQuaG9zdG5hbWUgPSByZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0OwogICAgcmVzdWx0LnBvcnQgPSByZWxhdGl2ZS5wb3J0OwogICAgLy8gdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgIGlmIChyZXN1bHQucGF0aG5hbWUgfHwgcmVzdWx0LnNlYXJjaCkgewogICAgICB2YXIgcCA9IHJlc3VsdC5wYXRobmFtZSB8fCAnJzsKICAgICAgdmFyIHMgPSByZXN1bHQuc2VhcmNoIHx8ICcnOwogICAgICByZXN1bHQucGF0aCA9IHAgKyBzOwogICAgfQogICAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgdmFyIGlzU291cmNlQWJzID0gKHJlc3VsdC5wYXRobmFtZSAmJiByZXN1bHQucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycpLAogICAgICBpc1JlbEFicyA9ICgKICAgICAgICAgIHJlbGF0aXZlLmhvc3QgfHwKICAgICAgICAgIHJlbGF0aXZlLnBhdGhuYW1lICYmIHJlbGF0aXZlLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nCiAgICAgICksCiAgICAgIG11c3RFbmRBYnMgPSAoaXNSZWxBYnMgfHwgaXNTb3VyY2VBYnMgfHwKICAgICAgICAgICAgICAgICAgICAocmVzdWx0Lmhvc3QgJiYgcmVsYXRpdmUucGF0aG5hbWUpKSwKICAgICAgcmVtb3ZlQWxsRG90cyA9IG11c3RFbmRBYnMsCiAgICAgIHNyY1BhdGggPSByZXN1bHQucGF0aG5hbWUgJiYgcmVzdWx0LnBhdGhuYW1lLnNwbGl0KCcvJykgfHwgW10sCiAgICAgIHJlbFBhdGggPSByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICBwc3ljaG90aWMgPSByZXN1bHQucHJvdG9jb2wgJiYgIXNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdOwoKICAvLyBpZiB0aGUgdXJsIGlzIGEgbm9uLXNsYXNoZWQgdXJsLCB0aGVuIHJlbGF0aXZlCiAgLy8gbGlua3MgbGlrZSAuLi8uLiBzaG91bGQgYmUgYWJsZQogIC8vIHRvIGNyYXdsIHVwIHRvIHRoZSBob3N0bmFtZSwgYXMgd2VsbC4gIFRoaXMgaXMgc3RyYW5nZS4KICAvLyByZXN1bHQucHJvdG9jb2wgaGFzIGFscmVhZHkgYmVlbiBzZXQgYnkgbm93LgogIC8vIExhdGVyIG9uLCBwdXQgdGhlIGZpcnN0IHBhdGggcGFydCBpbnRvIHRoZSBob3N0IGZpZWxkLgogIGlmIChwc3ljaG90aWMpIHsKICAgIHJlc3VsdC5ob3N0bmFtZSA9ICcnOwogICAgcmVzdWx0LnBvcnQgPSBudWxsOwogICAgaWYgKHJlc3VsdC5ob3N0KSB7CiAgICAgIGlmIChzcmNQYXRoWzBdID09PSAnJykgc3JjUGF0aFswXSA9IHJlc3VsdC5ob3N0OwogICAgICBlbHNlIHNyY1BhdGgudW5zaGlmdChyZXN1bHQuaG9zdCk7CiAgICB9CiAgICByZXN1bHQuaG9zdCA9ICcnOwogICAgaWYgKHJlbGF0aXZlLnByb3RvY29sKSB7CiAgICAgIHJlbGF0aXZlLmhvc3RuYW1lID0gbnVsbDsKICAgICAgcmVsYXRpdmUucG9ydCA9IG51bGw7CiAgICAgIGlmIChyZWxhdGl2ZS5ob3N0KSB7CiAgICAgICAgaWYgKHJlbFBhdGhbMF0gPT09ICcnKSByZWxQYXRoWzBdID0gcmVsYXRpdmUuaG9zdDsKICAgICAgICBlbHNlIHJlbFBhdGgudW5zaGlmdChyZWxhdGl2ZS5ob3N0KTsKICAgICAgfQogICAgICByZWxhdGl2ZS5ob3N0ID0gbnVsbDsKICAgIH0KICAgIG11c3RFbmRBYnMgPSBtdXN0RW5kQWJzICYmIChyZWxQYXRoWzBdID09PSAnJyB8fCBzcmNQYXRoWzBdID09PSAnJyk7CiAgfQoKICBpZiAoaXNSZWxBYnMpIHsKICAgIC8vIGl0J3MgYWJzb2x1dGUuCiAgICByZXN1bHQuaG9zdCA9IChyZWxhdGl2ZS5ob3N0IHx8IHJlbGF0aXZlLmhvc3QgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3QgOiByZXN1bHQuaG9zdDsKICAgIHJlc3VsdC5ob3N0bmFtZSA9IChyZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0bmFtZSA9PT0gJycpID8KICAgICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3RuYW1lIDogcmVzdWx0Lmhvc3RuYW1lOwogICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgc3JjUGF0aCA9IHJlbFBhdGg7CiAgICAvLyBmYWxsIHRocm91Z2ggdG8gdGhlIGRvdC1oYW5kbGluZyBiZWxvdy4KICB9IGVsc2UgaWYgKHJlbFBhdGgubGVuZ3RoKSB7CiAgICAvLyBpdCdzIHJlbGF0aXZlCiAgICAvLyB0aHJvdyBhd2F5IHRoZSBleGlzdGluZyBmaWxlLCBhbmQgdGFrZSB0aGUgbmV3IHBhdGggaW5zdGVhZC4KICAgIGlmICghc3JjUGF0aCkgc3JjUGF0aCA9IFtdOwogICAgc3JjUGF0aC5wb3AoKTsKICAgIHNyY1BhdGggPSBzcmNQYXRoLmNvbmNhdChyZWxQYXRoKTsKICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICB9IGVsc2UgaWYgKCFpc051bGxPclVuZGVmaW5lZChyZWxhdGl2ZS5zZWFyY2gpKSB7CiAgICAvLyBqdXN0IHB1bGwgb3V0IHRoZSBzZWFyY2guCiAgICAvLyBsaWtlIGhyZWY9Jz9mb28nLgogICAgLy8gUHV0IHRoaXMgYWZ0ZXIgdGhlIG90aGVyIHR3byBjYXNlcyBiZWNhdXNlIGl0IHNpbXBsaWZpZXMgdGhlIGJvb2xlYW5zCiAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gc3JjUGF0aC5zaGlmdCgpOwogICAgICAvL29jY2F0aW9uYWx5IHRoZSBhdXRoIGNhbiBnZXQgc3R1Y2sgb25seSBpbiBob3N0CiAgICAgIC8vdGhpcyBlc3BlY2lhbHkgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICAgIHZhciBhdXRoSW5Ib3N0ID0gcmVzdWx0Lmhvc3QgJiYgcmVzdWx0Lmhvc3QuaW5kZXhPZignQCcpID4gMCA/CiAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmhvc3Quc3BsaXQoJ0AnKSA6IGZhbHNlOwogICAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICAgIHJlc3VsdC5hdXRoID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgIHJlc3VsdC5ob3N0ID0gcmVzdWx0Lmhvc3RuYW1lID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICB9CiAgICB9CiAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICBpZiAoIWlzTnVsbChyZXN1bHQucGF0aG5hbWUpIHx8ICFpc051bGwocmVzdWx0LnNlYXJjaCkpIHsKICAgICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgICAocmVzdWx0LnNlYXJjaCA/IHJlc3VsdC5zZWFyY2ggOiAnJyk7CiAgICB9CiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBpZiAoIXNyY1BhdGgubGVuZ3RoKSB7CiAgICAvLyBubyBwYXRoIGF0IGFsbC4gIGVhc3kuCiAgICAvLyB3ZSd2ZSBhbHJlYWR5IGhhbmRsZWQgdGhlIG90aGVyIHN0dWZmIGFib3ZlLgogICAgcmVzdWx0LnBhdGhuYW1lID0gbnVsbDsKICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgIGlmIChyZXN1bHQuc2VhcmNoKSB7CiAgICAgIHJlc3VsdC5wYXRoID0gJy8nICsgcmVzdWx0LnNlYXJjaDsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5wYXRoID0gbnVsbDsKICAgIH0KICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8vIGlmIGEgdXJsIEVORHMgaW4gLiBvciAuLiwgdGhlbiBpdCBtdXN0IGdldCBhIHRyYWlsaW5nIHNsYXNoLgogIC8vIGhvd2V2ZXIsIGlmIGl0IGVuZHMgaW4gYW55dGhpbmcgZWxzZSBub24tc2xhc2h5LAogIC8vIHRoZW4gaXQgbXVzdCBOT1QgZ2V0IGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIGxhc3QgPSBzcmNQYXRoLnNsaWNlKC0xKVswXTsKICB2YXIgaGFzVHJhaWxpbmdTbGFzaCA9ICgKICAgICAgKHJlc3VsdC5ob3N0IHx8IHJlbGF0aXZlLmhvc3QpICYmIChsYXN0ID09PSAnLicgfHwgbGFzdCA9PT0gJy4uJykgfHwKICAgICAgbGFzdCA9PT0gJycpOwoKICAvLyBzdHJpcCBzaW5nbGUgZG90cywgcmVzb2x2ZSBkb3VibGUgZG90cyB0byBwYXJlbnQgZGlyCiAgLy8gaWYgdGhlIHBhdGggdHJpZXMgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIGB1cGAgZW5kcyB1cCA+IDAKICB2YXIgdXAgPSAwOwogIGZvciAodmFyIGkgPSBzcmNQYXRoLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHsKICAgIGxhc3QgPSBzcmNQYXRoW2ldOwogICAgaWYgKGxhc3QgPT0gJy4nKSB7CiAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgfSBlbHNlIGlmIChsYXN0ID09PSAnLi4nKSB7CiAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICB1cCsrOwogICAgfSBlbHNlIGlmICh1cCkgewogICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgdXAtLTsKICAgIH0KICB9CgogIC8vIGlmIHRoZSBwYXRoIGlzIGFsbG93ZWQgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIHJlc3RvcmUgbGVhZGluZyAuLnMKICBpZiAoIW11c3RFbmRBYnMgJiYgIXJlbW92ZUFsbERvdHMpIHsKICAgIGZvciAoOyB1cC0tOyB1cCkgewogICAgICBzcmNQYXRoLnVuc2hpZnQoJy4uJyk7CiAgICB9CiAgfQoKICBpZiAobXVzdEVuZEFicyAmJiBzcmNQYXRoWzBdICE9PSAnJyAmJgogICAgICAoIXNyY1BhdGhbMF0gfHwgc3JjUGF0aFswXS5jaGFyQXQoMCkgIT09ICcvJykpIHsKICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgfQoKICBpZiAoaGFzVHJhaWxpbmdTbGFzaCAmJiAoc3JjUGF0aC5qb2luKCcvJykuc3Vic3RyKC0xKSAhPT0gJy8nKSkgewogICAgc3JjUGF0aC5wdXNoKCcnKTsKICB9CgogIHZhciBpc0Fic29sdXRlID0gc3JjUGF0aFswXSA9PT0gJycgfHwKICAgICAgKHNyY1BhdGhbMF0gJiYgc3JjUGF0aFswXS5jaGFyQXQoMCkgPT09ICcvJyk7CgogIC8vIHB1dCB0aGUgaG9zdCBiYWNrCiAgaWYgKHBzeWNob3RpYykgewogICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVzdWx0Lmhvc3QgPSBpc0Fic29sdXRlID8gJycgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmNQYXRoLmxlbmd0aCA/IHNyY1BhdGguc2hpZnQoKSA6ICcnOwogICAgLy9vY2NhdGlvbmFseSB0aGUgYXV0aCBjYW4gZ2V0IHN0dWNrIG9ubHkgaW4gaG9zdAogICAgLy90aGlzIGVzcGVjaWFseSBoYXBwZW5zIGluIGNhc2VzIGxpa2UKICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICB2YXIgYXV0aEluSG9zdCA9IHJlc3VsdC5ob3N0ICYmIHJlc3VsdC5ob3N0LmluZGV4T2YoJ0AnKSA+IDAgPwogICAgICAgICAgICAgICAgICAgICByZXN1bHQuaG9zdC5zcGxpdCgnQCcpIDogZmFsc2U7CiAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICByZXN1bHQuYXV0aCA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgcmVzdWx0Lmhvc3QgPSByZXN1bHQuaG9zdG5hbWUgPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICB9CiAgfQoKICBtdXN0RW5kQWJzID0gbXVzdEVuZEFicyB8fCAocmVzdWx0Lmhvc3QgJiYgc3JjUGF0aC5sZW5ndGgpOwoKICBpZiAobXVzdEVuZEFicyAmJiAhaXNBYnNvbHV0ZSkgewogICAgc3JjUGF0aC51bnNoaWZ0KCcnKTsKICB9CgogIGlmICghc3JjUGF0aC5sZW5ndGgpIHsKICAgIHJlc3VsdC5wYXRobmFtZSA9IG51bGw7CiAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgfSBlbHNlIHsKICAgIHJlc3VsdC5wYXRobmFtZSA9IHNyY1BhdGguam9pbignLycpOwogIH0KCiAgLy90byBzdXBwb3J0IHJlcXVlc3QuaHR0cAogIGlmICghaXNOdWxsKHJlc3VsdC5wYXRobmFtZSkgfHwgIWlzTnVsbChyZXN1bHQuc2VhcmNoKSkgewogICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgKHJlc3VsdC5zZWFyY2ggPyByZXN1bHQuc2VhcmNoIDogJycpOwogIH0KICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGggfHwgcmVzdWx0LmF1dGg7CiAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogIHJldHVybiByZXN1bHQ7Cn07CgpVcmwucHJvdG90eXBlLnBhcnNlSG9zdCA9IGZ1bmN0aW9uKCkgewogIHZhciBob3N0ID0gdGhpcy5ob3N0OwogIHZhciBwb3J0ID0gcG9ydFBhdHRlcm4uZXhlYyhob3N0KTsKICBpZiAocG9ydCkgewogICAgcG9ydCA9IHBvcnRbMF07CiAgICBpZiAocG9ydCAhPT0gJzonKSB7CiAgICAgIHRoaXMucG9ydCA9IHBvcnQuc3Vic3RyKDEpOwogICAgfQogICAgaG9zdCA9IGhvc3Quc3Vic3RyKDAsIGhvc3QubGVuZ3RoIC0gcG9ydC5sZW5ndGgpOwogIH0KICBpZiAoaG9zdCkgdGhpcy5ob3N0bmFtZSA9IGhvc3Q7Cn07CgpmdW5jdGlvbiBpc1N0cmluZyhhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gInN0cmluZyI7Cn0KCmZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICByZXR1cm4gYXJnID09PSBudWxsOwp9CmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKGFyZykgewogIHJldHVybiAgYXJnID09IG51bGw7Cn0KCn0seyJwdW55Y29kZSI6ODIsInF1ZXJ5c3RyaW5nIjo5M31dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgovKioKICogQ29udmVydCBhcnJheSBvZiAxNiBieXRlIHZhbHVlcyB0byBVVUlEIHN0cmluZyBmb3JtYXQgb2YgdGhlIGZvcm06CiAqIFhYWFhYWFhYLVhYWFgtWFhYWC1YWFhYLVhYWFhYWFhYWFhYWAogKi8KdmFyIGJ5dGVUb0hleCA9IFtdOwoKZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogIGJ5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7Cn0KCmZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ1Ziwgb2Zmc2V0KSB7CiAgdmFyIGkgPSBvZmZzZXQgfHwgMDsKICB2YXIgYnRoID0gYnl0ZVRvSGV4OyAvLyBqb2luIHVzZWQgdG8gZml4IG1lbW9yeSBpc3N1ZSBjYXVzZWQgYnkgY29uY2F0ZW5hdGlvbjogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MzE3NSNjNAoKICByZXR1cm4gW2J0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLCBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXV0uam9pbignJyk7Cn0KCnZhciBfZGVmYXVsdCA9IGJ5dGVzVG9VdWlkOwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7fV0sMTAwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInYxIiwgewogIGVudW1lcmFibGU6IHRydWUsCiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gX3YuZGVmYXVsdDsKICB9Cn0pOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInYzIiwgewogIGVudW1lcmFibGU6IHRydWUsCiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gX3YyLmRlZmF1bHQ7CiAgfQp9KTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ2NCIsIHsKICBlbnVtZXJhYmxlOiB0cnVlLAogIGdldDogZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIF92My5kZWZhdWx0OwogIH0KfSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidjUiLCB7CiAgZW51bWVyYWJsZTogdHJ1ZSwKICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBfdjQuZGVmYXVsdDsKICB9Cn0pOwoKdmFyIF92ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3YxLmpzIikpOwoKdmFyIF92MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi92My5qcyIpKTsKCnZhciBfdjMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vdjQuanMiKSk7Cgp2YXIgX3Y0ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3Y1LmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KfSx7Ii4vdjEuanMiOjEwNCwiLi92My5qcyI6MTA1LCIuL3Y0LmpzIjoxMDcsIi4vdjUuanMiOjEwOH1dLDEwMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKLyoKICogQnJvd3Nlci1jb21wYXRpYmxlIEphdmFTY3JpcHQgTUQ1CiAqCiAqIE1vZGlmaWNhdGlvbiBvZiBKYXZhU2NyaXB0IE1ENQogKiBodHRwczovL2dpdGh1Yi5jb20vYmx1ZWltcC9KYXZhU2NyaXB0LU1ENQogKgogKiBDb3B5cmlnaHQgMjAxMSwgU2ViYXN0aWFuIFRzY2hhbgogKiBodHRwczovL2JsdWVpbXAubmV0CiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZToKICogaHR0cHM6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQKICoKICogQmFzZWQgb24KICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBSU0EgRGF0YSBTZWN1cml0eSwgSW5jLiBNRDUgTWVzc2FnZQogKiBEaWdlc3QgQWxnb3JpdGhtLCBhcyBkZWZpbmVkIGluIFJGQyAxMzIxLgogKiBWZXJzaW9uIDIuMiBDb3B5cmlnaHQgKEMpIFBhdWwgSm9obnN0b24gMTk5OSAtIDIwMDkKICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIG1vcmUgaW5mby4KICovCmZ1bmN0aW9uIG1kNShieXRlcykgewogIGlmICh0eXBlb2YgYnl0ZXMgPT0gJ3N0cmluZycpIHsKICAgIHZhciBtc2cgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYnl0ZXMpKTsgLy8gVVRGOCBlc2NhcGUKCiAgICBieXRlcyA9IG5ldyBBcnJheShtc2cubGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1zZy5sZW5ndGg7IGkrKykgYnl0ZXNbaV0gPSBtc2cuY2hhckNvZGVBdChpKTsKICB9CgogIHJldHVybiBtZDVUb0hleEVuY29kZWRBcnJheSh3b3Jkc1RvTWQ1KGJ5dGVzVG9Xb3JkcyhieXRlcyksIGJ5dGVzLmxlbmd0aCAqIDgpKTsKfQovKgogKiBDb252ZXJ0IGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMgdG8gYW4gYXJyYXkgb2YgYnl0ZXMKICovCgoKZnVuY3Rpb24gbWQ1VG9IZXhFbmNvZGVkQXJyYXkoaW5wdXQpIHsKICB2YXIgaTsKICB2YXIgeDsKICB2YXIgb3V0cHV0ID0gW107CiAgdmFyIGxlbmd0aDMyID0gaW5wdXQubGVuZ3RoICogMzI7CiAgdmFyIGhleFRhYiA9ICcwMTIzNDU2Nzg5YWJjZGVmJzsKICB2YXIgaGV4OwoKICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoMzI7IGkgKz0gOCkgewogICAgeCA9IGlucHV0W2kgPj4gNV0gPj4+IGkgJSAzMiAmIDB4ZmY7CiAgICBoZXggPSBwYXJzZUludChoZXhUYWIuY2hhckF0KHggPj4+IDQgJiAweDBmKSArIGhleFRhYi5jaGFyQXQoeCAmIDB4MGYpLCAxNik7CiAgICBvdXRwdXQucHVzaChoZXgpOwogIH0KCiAgcmV0dXJuIG91dHB1dDsKfQovKgogKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzLCBhbmQgYSBiaXQgbGVuZ3RoLgogKi8KCgpmdW5jdGlvbiB3b3Jkc1RvTWQ1KHgsIGxlbikgewogIC8qIGFwcGVuZCBwYWRkaW5nICovCiAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCBsZW4gJSAzMjsKICB4WyhsZW4gKyA2NCA+Pj4gOSA8PCA0KSArIDE0XSA9IGxlbjsKICB2YXIgaTsKICB2YXIgb2xkYTsKICB2YXIgb2xkYjsKICB2YXIgb2xkYzsKICB2YXIgb2xkZDsKICB2YXIgYSA9IDE3MzI1ODQxOTM7CiAgdmFyIGIgPSAtMjcxNzMzODc5OwogIHZhciBjID0gLTE3MzI1ODQxOTQ7CiAgdmFyIGQgPSAyNzE3MzM4Nzg7CgogIGZvciAoaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikgewogICAgb2xkYSA9IGE7CiAgICBvbGRiID0gYjsKICAgIG9sZGMgPSBjOwogICAgb2xkZCA9IGQ7CiAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpXSwgNywgLTY4MDg3NjkzNik7CiAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgMV0sIDEyLCAtMzg5NTY0NTg2KTsKICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAyXSwgMTcsIDYwNjEwNTgxOSk7CiAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgM10sIDIyLCAtMTA0NDUyNTMzMCk7CiAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpICsgNF0sIDcsIC0xNzY0MTg4OTcpOwogICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDVdLCAxMiwgMTIwMDA4MDQyNik7CiAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgNl0sIDE3LCAtMTQ3MzIzMTM0MSk7CiAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgN10sIDIyLCAtNDU3MDU5ODMpOwogICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaSArIDhdLCA3LCAxNzcwMDM1NDE2KTsKICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyA5XSwgMTIsIC0xOTU4NDE0NDE3KTsKICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAxMF0sIDE3LCAtNDIwNjMpOwogICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDExXSwgMjIsIC0xOTkwNDA0MTYyKTsKICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2kgKyAxMl0sIDcsIDE4MDQ2MDM2ODIpOwogICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDEzXSwgMTIsIC00MDM0MTEwMSk7CiAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMTRdLCAxNywgLTE1MDIwMDIyOTApOwogICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDE1XSwgMjIsIDEyMzY1MzUzMjkpOwogICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDFdLCA1LCAtMTY1Nzk2NTEwKTsKICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyA2XSwgOSwgLTEwNjk1MDE2MzIpOwogICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDExXSwgMTQsIDY0MzcxNzcxMyk7CiAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpXSwgMjAsIC0zNzM4OTczMDIpOwogICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDVdLCA1LCAtNzAxNTU4NjkxKTsKICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAxMF0sIDksIDM4MDE2MDgzKTsKICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE0LCAtNjYwNDc4MzM1KTsKICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2kgKyA0XSwgMjAsIC00MDU1Mzc4NDgpOwogICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDldLCA1LCA1Njg0NDY0MzgpOwogICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDE0XSwgOSwgLTEwMTk4MDM2OTApOwogICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDNdLCAxNCwgLTE4NzM2Mzk2MSk7CiAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpICsgOF0sIDIwLCAxMTYzNTMxNTAxKTsKICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyAxM10sIDUsIC0xNDQ0NjgxNDY3KTsKICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAyXSwgOSwgLTUxNDAzNzg0KTsKICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyA3XSwgMTQsIDE3MzUzMjg0NzMpOwogICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaSArIDEyXSwgMjAsIC0xOTI2NjA3NzM0KTsKICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyA1XSwgNCwgLTM3ODU1OCk7CiAgICBkID0gbWQ1aGgoZCwgYSwgYiwgYywgeFtpICsgOF0sIDExLCAtMjAyMjU3NDQ2Myk7CiAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgMTFdLCAxNiwgMTgzOTAzMDU2Mik7CiAgICBiID0gbWQ1aGgoYiwgYywgZCwgYSwgeFtpICsgMTRdLCAyMywgLTM1MzA5NTU2KTsKICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyAxXSwgNCwgLTE1MzA5OTIwNjApOwogICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDRdLCAxMSwgMTI3Mjg5MzM1Myk7CiAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgN10sIDE2LCAtMTU1NDk3NjMyKTsKICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyAxMF0sIDIzLCAtMTA5NDczMDY0MCk7CiAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgMTNdLCA0LCA2ODEyNzkxNzQpOwogICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaV0sIDExLCAtMzU4NTM3MjIyKTsKICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAzXSwgMTYsIC03MjI1MjE5NzkpOwogICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDZdLCAyMywgNzYwMjkxODkpOwogICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDldLCA0LCAtNjQwMzY0NDg3KTsKICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2kgKyAxMl0sIDExLCAtNDIxODE1ODM1KTsKICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE2LCA1MzA3NDI1MjApOwogICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDJdLCAyMywgLTk5NTMzODY1MSk7CiAgICBhID0gbWQ1aWkoYSwgYiwgYywgZCwgeFtpXSwgNiwgLTE5ODYzMDg0NCk7CiAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgN10sIDEwLCAxMTI2ODkxNDE1KTsKICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyAxNF0sIDE1LCAtMTQxNjM1NDkwNSk7CiAgICBiID0gbWQ1aWkoYiwgYywgZCwgYSwgeFtpICsgNV0sIDIxLCAtNTc0MzQwNTUpOwogICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgNiwgMTcwMDQ4NTU3MSk7CiAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgM10sIDEwLCAtMTg5NDk4NjYwNik7CiAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMTBdLCAxNSwgLTEwNTE1MjMpOwogICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDFdLCAyMSwgLTIwNTQ5MjI3OTkpOwogICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDhdLCA2LCAxODczMzEzMzU5KTsKICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAxNV0sIDEwLCAtMzA2MTE3NDQpOwogICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDZdLCAxNSwgLTE1NjAxOTgzODApOwogICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDEzXSwgMjEsIDEzMDkxNTE2NDkpOwogICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDRdLCA2LCAtMTQ1NTIzMDcwKTsKICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAxMV0sIDEwLCAtMTEyMDIxMDM3OSk7CiAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMl0sIDE1LCA3MTg3ODcyNTkpOwogICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDldLCAyMSwgLTM0MzQ4NTU1MSk7CiAgICBhID0gc2FmZUFkZChhLCBvbGRhKTsKICAgIGIgPSBzYWZlQWRkKGIsIG9sZGIpOwogICAgYyA9IHNhZmVBZGQoYywgb2xkYyk7CiAgICBkID0gc2FmZUFkZChkLCBvbGRkKTsKICB9CgogIHJldHVybiBbYSwgYiwgYywgZF07Cn0KLyoKICogQ29udmVydCBhbiBhcnJheSBieXRlcyB0byBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAqIENoYXJhY3RlcnMgPjI1NSBoYXZlIHRoZWlyIGhpZ2gtYnl0ZSBzaWxlbnRseSBpZ25vcmVkLgogKi8KCgpmdW5jdGlvbiBieXRlc1RvV29yZHMoaW5wdXQpIHsKICB2YXIgaTsKICB2YXIgb3V0cHV0ID0gW107CiAgb3V0cHV0WyhpbnB1dC5sZW5ndGggPj4gMikgLSAxXSA9IHVuZGVmaW5lZDsKCiAgZm9yIChpID0gMDsgaSA8IG91dHB1dC5sZW5ndGg7IGkgKz0gMSkgewogICAgb3V0cHV0W2ldID0gMDsKICB9CgogIHZhciBsZW5ndGg4ID0gaW5wdXQubGVuZ3RoICogODsKCiAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDg7IGkgKz0gOCkgewogICAgb3V0cHV0W2kgPj4gNV0gfD0gKGlucHV0W2kgLyA4XSAmIDB4ZmYpIDw8IGkgJSAzMjsKICB9CgogIHJldHVybiBvdXRwdXQ7Cn0KLyoKICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseQogKiB0byB3b3JrIGFyb3VuZCBidWdzIGluIHNvbWUgSlMgaW50ZXJwcmV0ZXJzLgogKi8KCgpmdW5jdGlvbiBzYWZlQWRkKHgsIHkpIHsKICB2YXIgbHN3ID0gKHggJiAweGZmZmYpICsgKHkgJiAweGZmZmYpOwogIHZhciBtc3cgPSAoeCA+PiAxNikgKyAoeSA+PiAxNikgKyAobHN3ID4+IDE2KTsKICByZXR1cm4gbXN3IDw8IDE2IHwgbHN3ICYgMHhmZmZmOwp9Ci8qCiAqIEJpdHdpc2Ugcm90YXRlIGEgMzItYml0IG51bWJlciB0byB0aGUgbGVmdC4KICovCgoKZnVuY3Rpb24gYml0Um90YXRlTGVmdChudW0sIGNudCkgewogIHJldHVybiBudW0gPDwgY250IHwgbnVtID4+PiAzMiAtIGNudDsKfQovKgogKiBUaGVzZSBmdW5jdGlvbnMgaW1wbGVtZW50IHRoZSBmb3VyIGJhc2ljIG9wZXJhdGlvbnMgdGhlIGFsZ29yaXRobSB1c2VzLgogKi8KCgpmdW5jdGlvbiBtZDVjbW4ocSwgYSwgYiwgeCwgcywgdCkgewogIHJldHVybiBzYWZlQWRkKGJpdFJvdGF0ZUxlZnQoc2FmZUFkZChzYWZlQWRkKGEsIHEpLCBzYWZlQWRkKHgsIHQpKSwgcyksIGIpOwp9CgpmdW5jdGlvbiBtZDVmZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgcmV0dXJuIG1kNWNtbihiICYgYyB8IH5iICYgZCwgYSwgYiwgeCwgcywgdCk7Cn0KCmZ1bmN0aW9uIG1kNWdnKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICByZXR1cm4gbWQ1Y21uKGIgJiBkIHwgYyAmIH5kLCBhLCBiLCB4LCBzLCB0KTsKfQoKZnVuY3Rpb24gbWQ1aGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogIHJldHVybiBtZDVjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KTsKfQoKZnVuY3Rpb24gbWQ1aWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogIHJldHVybiBtZDVjbW4oYyBeIChiIHwgfmQpLCBhLCBiLCB4LCBzLCB0KTsKfQoKdmFyIF9kZWZhdWx0ID0gbWQ1OwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7fV0sMTAyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSBybmc7Ci8vIFVuaXF1ZSBJRCBjcmVhdGlvbiByZXF1aXJlcyBhIGhpZ2ggcXVhbGl0eSByYW5kb20gIyBnZW5lcmF0b3IuIEluIHRoZSBicm93c2VyIHdlIHRoZXJlZm9yZQovLyByZXF1aXJlIHRoZSBjcnlwdG8gQVBJIGFuZCBkbyBub3Qgc3VwcG9ydCBidWlsdC1pbiBmYWxsYmFjayB0byBsb3dlciBxdWFsaXR5IHJhbmRvbSBudW1iZXIKLy8gZ2VuZXJhdG9ycyAobGlrZSBNYXRoLnJhbmRvbSgpKS4KLy8gZ2V0UmFuZG9tVmFsdWVzIG5lZWRzIHRvIGJlIGludm9rZWQgaW4gYSBjb250ZXh0IHdoZXJlICJ0aGlzIiBpcyBhIENyeXB0byBpbXBsZW1lbnRhdGlvbi4gQWxzbywKLy8gZmluZCB0aGUgY29tcGxldGUgaW1wbGVtZW50YXRpb24gb2YgY3J5cHRvIChtc0NyeXB0bykgb24gSUUxMS4KdmFyIGdldFJhbmRvbVZhbHVlcyA9IHR5cGVvZiBjcnlwdG8gIT0gJ3VuZGVmaW5lZCcgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQoY3J5cHRvKSB8fCB0eXBlb2YgbXNDcnlwdG8gIT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcyA9PSAnZnVuY3Rpb24nICYmIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKG1zQ3J5cHRvKTsKdmFyIHJuZHM4ID0gbmV3IFVpbnQ4QXJyYXkoMTYpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmCgpmdW5jdGlvbiBybmcoKSB7CiAgaWYgKCFnZXRSYW5kb21WYWx1ZXMpIHsKICAgIHRocm93IG5ldyBFcnJvcignY3J5cHRvLmdldFJhbmRvbVZhbHVlcygpIG5vdCBzdXBwb3J0ZWQuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vdXVpZGpzL3V1aWQjZ2V0cmFuZG9tdmFsdWVzLW5vdC1zdXBwb3J0ZWQnKTsKICB9CgogIHJldHVybiBnZXRSYW5kb21WYWx1ZXMocm5kczgpOwp9Cn0se31dLDEwMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKLy8gQWRhcHRlZCBmcm9tIENocmlzIFZlbmVzcycgU0hBMSBjb2RlIGF0Ci8vIGh0dHA6Ly93d3cubW92YWJsZS10eXBlLmNvLnVrL3NjcmlwdHMvc2hhMS5odG1sCmZ1bmN0aW9uIGYocywgeCwgeSwgeikgewogIHN3aXRjaCAocykgewogICAgY2FzZSAwOgogICAgICByZXR1cm4geCAmIHkgXiB+eCAmIHo7CgogICAgY2FzZSAxOgogICAgICByZXR1cm4geCBeIHkgXiB6OwoKICAgIGNhc2UgMjoKICAgICAgcmV0dXJuIHggJiB5IF4geCAmIHogXiB5ICYgejsKCiAgICBjYXNlIDM6CiAgICAgIHJldHVybiB4IF4geSBeIHo7CiAgfQp9CgpmdW5jdGlvbiBST1RMKHgsIG4pIHsKICByZXR1cm4geCA8PCBuIHwgeCA+Pj4gMzIgLSBuOwp9CgpmdW5jdGlvbiBzaGExKGJ5dGVzKSB7CiAgdmFyIEsgPSBbMHg1YTgyNzk5OSwgMHg2ZWQ5ZWJhMSwgMHg4ZjFiYmNkYywgMHhjYTYyYzFkNl07CiAgdmFyIEggPSBbMHg2NzQ1MjMwMSwgMHhlZmNkYWI4OSwgMHg5OGJhZGNmZSwgMHgxMDMyNTQ3NiwgMHhjM2QyZTFmMF07CgogIGlmICh0eXBlb2YgYnl0ZXMgPT0gJ3N0cmluZycpIHsKICAgIHZhciBtc2cgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYnl0ZXMpKTsgLy8gVVRGOCBlc2NhcGUKCiAgICBieXRlcyA9IG5ldyBBcnJheShtc2cubGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1zZy5sZW5ndGg7IGkrKykgYnl0ZXNbaV0gPSBtc2cuY2hhckNvZGVBdChpKTsKICB9CgogIGJ5dGVzLnB1c2goMHg4MCk7CiAgdmFyIGwgPSBieXRlcy5sZW5ndGggLyA0ICsgMjsKICB2YXIgTiA9IE1hdGguY2VpbChsIC8gMTYpOwogIHZhciBNID0gbmV3IEFycmF5KE4pOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IE47IGkrKykgewogICAgTVtpXSA9IG5ldyBBcnJheSgxNik7CgogICAgZm9yICh2YXIgaiA9IDA7IGogPCAxNjsgaisrKSB7CiAgICAgIE1baV1bal0gPSBieXRlc1tpICogNjQgKyBqICogNF0gPDwgMjQgfCBieXRlc1tpICogNjQgKyBqICogNCArIDFdIDw8IDE2IHwgYnl0ZXNbaSAqIDY0ICsgaiAqIDQgKyAyXSA8PCA4IHwgYnl0ZXNbaSAqIDY0ICsgaiAqIDQgKyAzXTsKICAgIH0KICB9CgogIE1bTiAtIDFdWzE0XSA9IChieXRlcy5sZW5ndGggLSAxKSAqIDggLyBNYXRoLnBvdygyLCAzMik7CiAgTVtOIC0gMV1bMTRdID0gTWF0aC5mbG9vcihNW04gLSAxXVsxNF0pOwogIE1bTiAtIDFdWzE1XSA9IChieXRlcy5sZW5ndGggLSAxKSAqIDggJiAweGZmZmZmZmZmOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IE47IGkrKykgewogICAgdmFyIFcgPSBuZXcgQXJyYXkoODApOwoKICAgIGZvciAodmFyIHQgPSAwOyB0IDwgMTY7IHQrKykgV1t0XSA9IE1baV1bdF07CgogICAgZm9yICh2YXIgdCA9IDE2OyB0IDwgODA7IHQrKykgewogICAgICBXW3RdID0gUk9UTChXW3QgLSAzXSBeIFdbdCAtIDhdIF4gV1t0IC0gMTRdIF4gV1t0IC0gMTZdLCAxKTsKICAgIH0KCiAgICB2YXIgYSA9IEhbMF07CiAgICB2YXIgYiA9IEhbMV07CiAgICB2YXIgYyA9IEhbMl07CiAgICB2YXIgZCA9IEhbM107CiAgICB2YXIgZSA9IEhbNF07CgogICAgZm9yICh2YXIgdCA9IDA7IHQgPCA4MDsgdCsrKSB7CiAgICAgIHZhciBzID0gTWF0aC5mbG9vcih0IC8gMjApOwogICAgICB2YXIgVCA9IFJPVEwoYSwgNSkgKyBmKHMsIGIsIGMsIGQpICsgZSArIEtbc10gKyBXW3RdID4+PiAwOwogICAgICBlID0gZDsKICAgICAgZCA9IGM7CiAgICAgIGMgPSBST1RMKGIsIDMwKSA+Pj4gMDsKICAgICAgYiA9IGE7CiAgICAgIGEgPSBUOwogICAgfQoKICAgIEhbMF0gPSBIWzBdICsgYSA+Pj4gMDsKICAgIEhbMV0gPSBIWzFdICsgYiA+Pj4gMDsKICAgIEhbMl0gPSBIWzJdICsgYyA+Pj4gMDsKICAgIEhbM10gPSBIWzNdICsgZCA+Pj4gMDsKICAgIEhbNF0gPSBIWzRdICsgZSA+Pj4gMDsKICB9CgogIHJldHVybiBbSFswXSA+PiAyNCAmIDB4ZmYsIEhbMF0gPj4gMTYgJiAweGZmLCBIWzBdID4+IDggJiAweGZmLCBIWzBdICYgMHhmZiwgSFsxXSA+PiAyNCAmIDB4ZmYsIEhbMV0gPj4gMTYgJiAweGZmLCBIWzFdID4+IDggJiAweGZmLCBIWzFdICYgMHhmZiwgSFsyXSA+PiAyNCAmIDB4ZmYsIEhbMl0gPj4gMTYgJiAweGZmLCBIWzJdID4+IDggJiAweGZmLCBIWzJdICYgMHhmZiwgSFszXSA+PiAyNCAmIDB4ZmYsIEhbM10gPj4gMTYgJiAweGZmLCBIWzNdID4+IDggJiAweGZmLCBIWzNdICYgMHhmZiwgSFs0XSA+PiAyNCAmIDB4ZmYsIEhbNF0gPj4gMTYgJiAweGZmLCBIWzRdID4+IDggJiAweGZmLCBIWzRdICYgMHhmZl07Cn0KCnZhciBfZGVmYXVsdCA9IHNoYTE7CmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9LHt9XSwxMDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCnZhciBfcm5nID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3JuZy5qcyIpKTsKCnZhciBfYnl0ZXNUb1V1aWQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vYnl0ZXNUb1V1aWQuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKLy8gKipgdjEoKWAgLSBHZW5lcmF0ZSB0aW1lLWJhc2VkIFVVSUQqKgovLwovLyBJbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vTGlvc0svVVVJRC5qcwovLyBhbmQgaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L3V1aWQuaHRtbAp2YXIgX25vZGVJZDsKCnZhciBfY2xvY2tzZXE7IC8vIFByZXZpb3VzIHV1aWQgY3JlYXRpb24gdGltZQoKCnZhciBfbGFzdE1TZWNzID0gMDsKdmFyIF9sYXN0TlNlY3MgPSAwOyAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3V1aWRqcy91dWlkIGZvciBBUEkgZGV0YWlscwoKZnVuY3Rpb24gdjEob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICB2YXIgYiA9IGJ1ZiB8fCBbXTsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICB2YXIgbm9kZSA9IG9wdGlvbnMubm9kZSB8fCBfbm9kZUlkOwogIHZhciBjbG9ja3NlcSA9IG9wdGlvbnMuY2xvY2tzZXEgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY2xvY2tzZXEgOiBfY2xvY2tzZXE7IC8vIG5vZGUgYW5kIGNsb2Nrc2VxIG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgdG8gcmFuZG9tIHZhbHVlcyBpZiB0aGV5J3JlIG5vdAogIC8vIHNwZWNpZmllZC4gIFdlIGRvIHRoaXMgbGF6aWx5IHRvIG1pbmltaXplIGlzc3VlcyByZWxhdGVkIHRvIGluc3VmZmljaWVudAogIC8vIHN5c3RlbSBlbnRyb3B5LiAgU2VlICMxODkKCiAgaWYgKG5vZGUgPT0gbnVsbCB8fCBjbG9ja3NlcSA9PSBudWxsKSB7CiAgICB2YXIgc2VlZEJ5dGVzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IF9ybmcuZGVmYXVsdCkoKTsKCiAgICBpZiAobm9kZSA9PSBudWxsKSB7CiAgICAgIC8vIFBlciA0LjUsIGNyZWF0ZSBhbmQgNDgtYml0IG5vZGUgaWQsICg0NyByYW5kb20gYml0cyArIG11bHRpY2FzdCBiaXQgPSAxKQogICAgICBub2RlID0gX25vZGVJZCA9IFtzZWVkQnl0ZXNbMF0gfCAweDAxLCBzZWVkQnl0ZXNbMV0sIHNlZWRCeXRlc1syXSwgc2VlZEJ5dGVzWzNdLCBzZWVkQnl0ZXNbNF0sIHNlZWRCeXRlc1s1XV07CiAgICB9CgogICAgaWYgKGNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgLy8gUGVyIDQuMi4yLCByYW5kb21pemUgKDE0IGJpdCkgY2xvY2tzZXEKICAgICAgY2xvY2tzZXEgPSBfY2xvY2tzZXEgPSAoc2VlZEJ5dGVzWzZdIDw8IDggfCBzZWVkQnl0ZXNbN10pICYgMHgzZmZmOwogICAgfQogIH0gLy8gVVVJRCB0aW1lc3RhbXBzIGFyZSAxMDAgbmFuby1zZWNvbmQgdW5pdHMgc2luY2UgdGhlIEdyZWdvcmlhbiBlcG9jaCwKICAvLyAoMTU4Mi0xMC0xNSAwMDowMCkuICBKU051bWJlcnMgYXJlbid0IHByZWNpc2UgZW5vdWdoIGZvciB0aGlzLCBzbwogIC8vIHRpbWUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5IGFzICdtc2VjcycgKGludGVnZXIgbWlsbGlzZWNvbmRzKSBhbmQgJ25zZWNzJwogIC8vICgxMDAtbmFub3NlY29uZHMgb2Zmc2V0IGZyb20gbXNlY3MpIHNpbmNlIHVuaXggZXBvY2gsIDE5NzAtMDEtMDEgMDA6MDAuCgoKICB2YXIgbXNlY3MgPSBvcHRpb25zLm1zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1zZWNzIDogbmV3IERhdGUoKS5nZXRUaW1lKCk7IC8vIFBlciA0LjIuMS4yLCB1c2UgY291bnQgb2YgdXVpZCdzIGdlbmVyYXRlZCBkdXJpbmcgdGhlIGN1cnJlbnQgY2xvY2sKICAvLyBjeWNsZSB0byBzaW11bGF0ZSBoaWdoZXIgcmVzb2x1dGlvbiBjbG9jawoKICB2YXIgbnNlY3MgPSBvcHRpb25zLm5zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm5zZWNzIDogX2xhc3ROU2VjcyArIDE7IC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKCiAgdmFyIGR0ID0gbXNlY3MgLSBfbGFzdE1TZWNzICsgKG5zZWNzIC0gX2xhc3ROU2VjcykgLyAxMDAwMDsgLy8gUGVyIDQuMi4xLjIsIEJ1bXAgY2xvY2tzZXEgb24gY2xvY2sgcmVncmVzc2lvbgoKICBpZiAoZHQgPCAwICYmIG9wdGlvbnMuY2xvY2tzZXEgPT09IHVuZGVmaW5lZCkgewogICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CiAgfSAvLyBSZXNldCBuc2VjcyBpZiBjbG9jayByZWdyZXNzZXMgKG5ldyBjbG9ja3NlcSkgb3Igd2UndmUgbW92ZWQgb250byBhIG5ldwogIC8vIHRpbWUgaW50ZXJ2YWwKCgogIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PT0gdW5kZWZpbmVkKSB7CiAgICBuc2VjcyA9IDA7CiAgfSAvLyBQZXIgNC4yLjEuMiBUaHJvdyBlcnJvciBpZiB0b28gbWFueSB1dWlkcyBhcmUgcmVxdWVzdGVkCgoKICBpZiAobnNlY3MgPj0gMTAwMDApIHsKICAgIHRocm93IG5ldyBFcnJvcigidXVpZC52MSgpOiBDYW4ndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMiKTsKICB9CgogIF9sYXN0TVNlY3MgPSBtc2VjczsKICBfbGFzdE5TZWNzID0gbnNlY3M7CiAgX2Nsb2Nrc2VxID0gY2xvY2tzZXE7IC8vIFBlciA0LjEuNCAtIENvbnZlcnQgZnJvbSB1bml4IGVwb2NoIHRvIEdyZWdvcmlhbiBlcG9jaAoKICBtc2VjcyArPSAxMjIxOTI5MjgwMDAwMDsgLy8gYHRpbWVfbG93YAoKICB2YXIgdGwgPSAoKG1zZWNzICYgMHhmZmZmZmZmKSAqIDEwMDAwICsgbnNlY3MpICUgMHgxMDAwMDAwMDA7CiAgYltpKytdID0gdGwgPj4+IDI0ICYgMHhmZjsKICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwogIGJbaSsrXSA9IHRsID4+PiA4ICYgMHhmZjsKICBiW2krK10gPSB0bCAmIDB4ZmY7IC8vIGB0aW1lX21pZGAKCiAgdmFyIHRtaCA9IG1zZWNzIC8gMHgxMDAwMDAwMDAgKiAxMDAwMCAmIDB4ZmZmZmZmZjsKICBiW2krK10gPSB0bWggPj4+IDggJiAweGZmOwogIGJbaSsrXSA9IHRtaCAmIDB4ZmY7IC8vIGB0aW1lX2hpZ2hfYW5kX3ZlcnNpb25gCgogIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOyAvLyBpbmNsdWRlIHZlcnNpb24KCiAgYltpKytdID0gdG1oID4+PiAxNiAmIDB4ZmY7IC8vIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYCAoUGVyIDQuMi4yIC0gaW5jbHVkZSB2YXJpYW50KQoKICBiW2krK10gPSBjbG9ja3NlcSA+Pj4gOCB8IDB4ODA7IC8vIGBjbG9ja19zZXFfbG93YAoKICBiW2krK10gPSBjbG9ja3NlcSAmIDB4ZmY7IC8vIGBub2RlYAoKICBmb3IgKHZhciBuID0gMDsgbiA8IDY7ICsrbikgewogICAgYltpICsgbl0gPSBub2RlW25dOwogIH0KCiAgcmV0dXJuIGJ1ZiA/IGJ1ZiA6ICgwLCBfYnl0ZXNUb1V1aWQuZGVmYXVsdCkoYik7Cn0KCnZhciBfZGVmYXVsdCA9IHYxOwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7Ii4vYnl0ZXNUb1V1aWQuanMiOjk5LCIuL3JuZy5qcyI6MTAyfV0sMTA1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7Cgp2YXIgX3YgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vdjM1LmpzIikpOwoKdmFyIF9tZCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9tZDUuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKY29uc3QgdjMgPSAoMCwgX3YuZGVmYXVsdCkoJ3YzJywgMHgzMCwgX21kLmRlZmF1bHQpOwp2YXIgX2RlZmF1bHQgPSB2MzsKZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0seyIuL21kNS5qcyI6MTAxLCIuL3YzNS5qcyI6MTA2fV0sMTA2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKZXhwb3J0cy5VUkwgPSBleHBvcnRzLkROUyA9IHZvaWQgMDsKCnZhciBfYnl0ZXNUb1V1aWQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vYnl0ZXNUb1V1aWQuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKZnVuY3Rpb24gdXVpZFRvQnl0ZXModXVpZCkgewogIC8vIE5vdGU6IFdlIGFzc3VtZSB3ZSdyZSBiZWluZyBwYXNzZWQgYSB2YWxpZCB1dWlkIHN0cmluZwogIHZhciBieXRlcyA9IFtdOwogIHV1aWQucmVwbGFjZSgvW2EtZkEtRjAtOV17Mn0vZywgZnVuY3Rpb24gKGhleCkgewogICAgYnl0ZXMucHVzaChwYXJzZUludChoZXgsIDE2KSk7CiAgfSk7CiAgcmV0dXJuIGJ5dGVzOwp9CgpmdW5jdGlvbiBzdHJpbmdUb0J5dGVzKHN0cikgewogIHN0ciA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzdHIpKTsgLy8gVVRGOCBlc2NhcGUKCiAgdmFyIGJ5dGVzID0gbmV3IEFycmF5KHN0ci5sZW5ndGgpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgYnl0ZXNbaV0gPSBzdHIuY2hhckNvZGVBdChpKTsKICB9CgogIHJldHVybiBieXRlczsKfQoKY29uc3QgRE5TID0gJzZiYTdiODEwLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCc7CmV4cG9ydHMuRE5TID0gRE5TOwpjb25zdCBVUkwgPSAnNmJhN2I4MTEtOWRhZC0xMWQxLTgwYjQtMDBjMDRmZDQzMGM4JzsKZXhwb3J0cy5VUkwgPSBVUkw7CgpmdW5jdGlvbiBfZGVmYXVsdChuYW1lLCB2ZXJzaW9uLCBoYXNoZnVuYykgewogIHZhciBnZW5lcmF0ZVVVSUQgPSBmdW5jdGlvbiAodmFsdWUsIG5hbWVzcGFjZSwgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBvZmYgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgICBpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSB2YWx1ZSA9IHN0cmluZ1RvQnl0ZXModmFsdWUpOwogICAgaWYgKHR5cGVvZiBuYW1lc3BhY2UgPT0gJ3N0cmluZycpIG5hbWVzcGFjZSA9IHV1aWRUb0J5dGVzKG5hbWVzcGFjZSk7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB0aHJvdyBUeXBlRXJyb3IoJ3ZhbHVlIG11c3QgYmUgYW4gYXJyYXkgb2YgYnl0ZXMnKTsKICAgIGlmICghQXJyYXkuaXNBcnJheShuYW1lc3BhY2UpIHx8IG5hbWVzcGFjZS5sZW5ndGggIT09IDE2KSB0aHJvdyBUeXBlRXJyb3IoJ25hbWVzcGFjZSBtdXN0IGJlIHV1aWQgc3RyaW5nIG9yIGFuIEFycmF5IG9mIDE2IGJ5dGUgdmFsdWVzJyk7IC8vIFBlciA0LjMKCiAgICB2YXIgYnl0ZXMgPSBoYXNoZnVuYyhuYW1lc3BhY2UuY29uY2F0KHZhbHVlKSk7CiAgICBieXRlc1s2XSA9IGJ5dGVzWzZdICYgMHgwZiB8IHZlcnNpb247CiAgICBieXRlc1s4XSA9IGJ5dGVzWzhdICYgMHgzZiB8IDB4ODA7CgogICAgaWYgKGJ1ZikgewogICAgICBmb3IgKHZhciBpZHggPSAwOyBpZHggPCAxNjsgKytpZHgpIHsKICAgICAgICBidWZbb2ZmICsgaWR4XSA9IGJ5dGVzW2lkeF07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmIHx8ICgwLCBfYnl0ZXNUb1V1aWQuZGVmYXVsdCkoYnl0ZXMpOwogIH07IC8vIEZ1bmN0aW9uI25hbWUgaXMgbm90IHNldHRhYmxlIG9uIHNvbWUgcGxhdGZvcm1zICgjMjcwKQoKCiAgdHJ5IHsKICAgIGdlbmVyYXRlVVVJRC5uYW1lID0gbmFtZTsKICB9IGNhdGNoIChlcnIpIHt9IC8vIEZvciBDb21tb25KUyBkZWZhdWx0IGV4cG9ydCBzdXBwb3J0CgoKICBnZW5lcmF0ZVVVSUQuRE5TID0gRE5TOwogIGdlbmVyYXRlVVVJRC5VUkwgPSBVUkw7CiAgcmV0dXJuIGdlbmVyYXRlVVVJRDsKfQp9LHsiLi9ieXRlc1RvVXVpZC5qcyI6OTl9XSwxMDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCnZhciBfcm5nID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3JuZy5qcyIpKTsKCnZhciBfYnl0ZXNUb1V1aWQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vYnl0ZXNUb1V1aWQuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKZnVuY3Rpb24gdjQob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCiAgaWYgKHR5cGVvZiBvcHRpb25zID09ICdzdHJpbmcnKSB7CiAgICBidWYgPSBvcHRpb25zID09PSAnYmluYXJ5JyA/IG5ldyBBcnJheSgxNikgOiBudWxsOwogICAgb3B0aW9ucyA9IG51bGw7CiAgfQoKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIHJuZHMgPSBvcHRpb25zLnJhbmRvbSB8fCAob3B0aW9ucy5ybmcgfHwgX3JuZy5kZWZhdWx0KSgpOyAvLyBQZXIgNC40LCBzZXQgYml0cyBmb3IgdmVyc2lvbiBhbmQgYGNsb2NrX3NlcV9oaV9hbmRfcmVzZXJ2ZWRgCgoKICBybmRzWzZdID0gcm5kc1s2XSAmIDB4MGYgfCAweDQwOwogIHJuZHNbOF0gPSBybmRzWzhdICYgMHgzZiB8IDB4ODA7IC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAoKICBpZiAoYnVmKSB7CiAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgMTY7ICsraWkpIHsKICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgIH0KICB9CgogIHJldHVybiBidWYgfHwgKDAsIF9ieXRlc1RvVXVpZC5kZWZhdWx0KShybmRzKTsKfQoKdmFyIF9kZWZhdWx0ID0gdjQ7CmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9LHsiLi9ieXRlc1RvVXVpZC5qcyI6OTksIi4vcm5nLmpzIjoxMDJ9XSwxMDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCnZhciBfdiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi92MzUuanMiKSk7Cgp2YXIgX3NoYSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9zaGExLmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmNvbnN0IHY1ID0gKDAsIF92LmRlZmF1bHQpKCd2NScsIDB4NTAsIF9zaGEuZGVmYXVsdCk7CnZhciBfZGVmYXVsdCA9IHY1OwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7Ii4vc2hhMS5qcyI6MTAzLCIuL3YzNS5qcyI6MTA2fV0sMTA5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwp2YXIgTFJVXzEgPSByZXF1aXJlKCIuL3V0aWxzL0xSVSIpOwp2YXIgQ0FDSEVfU0laRSA9IDEwMDA7Ci8qKgogKiBJbnNwaXJlZCBub2RlLWxydS1jYWNoZVtodHRwczovL2dpdGh1Yi5jb20vaXNhYWNzL25vZGUtbHJ1LWNhY2hlXQogKi8KdmFyIEVuZHBvaW50Q2FjaGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFbmRwb2ludENhY2hlKG1heFNpemUpIHsKICAgICAgICBpZiAobWF4U2l6ZSA9PT0gdm9pZCAwKSB7IG1heFNpemUgPSBDQUNIRV9TSVpFOyB9CiAgICAgICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZTsKICAgICAgICB0aGlzLmNhY2hlID0gbmV3IExSVV8xLkxSVUNhY2hlKG1heFNpemUpOwogICAgfQogICAgOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLCAic2l6ZSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGUubGVuZ3RoOwogICAgICAgIH0sCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICB2YXIgZW5kcG9pbnRSZWNvcmQgPSB0aGlzLnBvcHVsYXRlVmFsdWUodmFsdWUpOwogICAgICAgIHRoaXMuY2FjaGUucHV0KGtleVN0cmluZywgZW5kcG9pbnRSZWNvcmQpOwogICAgfTsKICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuY2FjaGUuZ2V0KGtleVN0cmluZyk7CiAgICAgICAgaWYgKHJlY29yZHMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHJlY29yZHMubGVuZ3RoLTE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVjb3JkID0gcmVjb3Jkc1tpXTsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuRXhwaXJlIDwgbm93KSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3Jkcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlY29yZHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnJlbW92ZShrZXlTdHJpbmcpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVjb3JkczsKICAgIH07CiAgICBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgaWRlbnRpZmllcnMgPSBbXTsKICAgICAgICB2YXIgaWRlbnRpZmllck5hbWVzID0gT2JqZWN0LmtleXMoa2V5KS5zb3J0KCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpZGVudGlmaWVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGlkZW50aWZpZXJOYW1lID0gaWRlbnRpZmllck5hbWVzW2ldOwogICAgICAgICAgICBpZiAoa2V5W2lkZW50aWZpZXJOYW1lXSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGlkZW50aWZpZXJzLnB1c2goa2V5W2lkZW50aWZpZXJOYW1lXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpZGVudGlmaWVycy5qb2luKCcgJyk7CiAgICB9OwogICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucG9wdWxhdGVWYWx1ZSA9IGZ1bmN0aW9uIChlbmRwb2ludHMpIHsKICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICByZXR1cm4gZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsgcmV0dXJuICh7CiAgICAgICAgICAgIEFkZHJlc3M6IGVuZHBvaW50LkFkZHJlc3MgfHwgJycsCiAgICAgICAgICAgIEV4cGlyZTogbm93ICsgKGVuZHBvaW50LkNhY2hlUGVyaW9kSW5NaW51dGVzIHx8IDEpICogNjAgKiAxMDAwCiAgICAgICAgfSk7IH0pOwogICAgfTsKICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuY2FjaGUuZW1wdHkoKTsKICAgIH07CiAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgIH07CiAgICByZXR1cm4gRW5kcG9pbnRDYWNoZTsKfSgpKTsKZXhwb3J0cy5FbmRwb2ludENhY2hlID0gRW5kcG9pbnRDYWNoZTsKfSx7Ii4vdXRpbHMvTFJVIjoxMTB9XSwxMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CnZhciBMaW5rZWRMaXN0Tm9kZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpIHsKICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICByZXR1cm4gTGlua2VkTGlzdE5vZGU7Cn0oKSk7CnZhciBMUlVDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIExSVUNhY2hlKHNpemUpIHsKICAgICAgICB0aGlzLm5vZGVNYXAgPSB7fTsKICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicgfHwgc2l6ZSA8IDEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWNoZSBzaXplIGNhbiBvbmx5IGJlIHBvc2l0aXZlIG51bWJlcicpOwogICAgICAgIH0KICAgICAgICB0aGlzLnNpemVMaW1pdCA9IHNpemU7CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTFJVQ2FjaGUucHJvdG90eXBlLCAibGVuZ3RoIiwgewogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zaXplOwogICAgICAgIH0sCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogICAgTFJVQ2FjaGUucHJvdG90eXBlLnByZXBlbmRUb0xpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgIGlmICghdGhpcy5oZWFkZXJOb2RlKSB7CiAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlLnByZXYgPSBub2RlOwogICAgICAgICAgICBub2RlLm5leHQgPSB0aGlzLmhlYWRlck5vZGU7CiAgICAgICAgfQogICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGU7CiAgICAgICAgdGhpcy5zaXplKys7CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZUZyb21UYWlsID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghdGhpcy50YWlsTm9kZSkgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICB2YXIgbm9kZSA9IHRoaXMudGFpbE5vZGU7CiAgICAgICAgdmFyIHByZXZOb2RlID0gbm9kZS5wcmV2OwogICAgICAgIGlmIChwcmV2Tm9kZSkgewogICAgICAgICAgICBwcmV2Tm9kZS5uZXh0ID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy50YWlsTm9kZSA9IHByZXZOb2RlOwogICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICAgIHJldHVybiBub2RlOwogICAgfTsKICAgIExSVUNhY2hlLnByb3RvdHlwZS5kZXRhY2hGcm9tTGlzdCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgaWYgKHRoaXMuaGVhZGVyTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICB0aGlzLmhlYWRlck5vZGUgPSBub2RlLm5leHQ7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnRhaWxOb2RlID09PSBub2RlKSB7CiAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlLnByZXY7CiAgICAgICAgfQogICAgICAgIGlmIChub2RlLnByZXYpIHsKICAgICAgICAgICAgbm9kZS5wcmV2Lm5leHQgPSBub2RlLm5leHQ7CiAgICAgICAgfQogICAgICAgIGlmIChub2RlLm5leHQpIHsKICAgICAgICAgICAgbm9kZS5uZXh0LnByZXYgPSBub2RlLnByZXY7CiAgICAgICAgfQogICAgICAgIG5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5zaXplLS07CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgdGhpcy5wcmVwZW5kVG9MaXN0KG5vZGUpOwogICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICB9CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgIH0KICAgIH07CiAgICBMUlVDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5zaXplID09PSB0aGlzLnNpemVMaW1pdCkgewogICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSB0aGlzLnJlbW92ZUZyb21UYWlsKCk7CiAgICAgICAgICAgIHZhciBrZXlfMSA9IHRhaWxOb2RlLmtleTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXlfMV07CiAgICAgICAgfQogICAgICAgIHZhciBuZXdOb2RlID0gbmV3IExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpOwogICAgICAgIHRoaXMubm9kZU1hcFtrZXldID0gbmV3Tm9kZTsKICAgICAgICB0aGlzLnByZXBlbmRUb0xpc3QobmV3Tm9kZSk7CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5ub2RlTWFwKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICB9CiAgICB9OwogICAgcmV0dXJuIExSVUNhY2hlOwp9KCkpOwpleHBvcnRzLkxSVUNhY2hlID0gTFJVQ2FjaGU7Cn0se31dLDExMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuMTE4OS4wCi8vIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgovLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CnJlcXVpcmUoJy4vYnJvd3Nlcl9sb2FkZXInKTsKCnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKCmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgd2luZG93LkFXUyA9IEFXUzsKaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKfQppZiAodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnKSBzZWxmLkFXUyA9IEFXUzsKCi8qKgogKiBAcHJpdmF0ZQogKiBETyBOT1QgUkVNT1ZFCiAqIGJyb3dzZXIgYnVpbGRlciB3aWxsIHN0cmlwIG91dCB0aGlzIGxpbmUgaWYgc2VydmljZXMgYXJlIHN1cHBsaWVkIG9uIHRoZSBjb21tYW5kIGxpbmUuCiAqL2lmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUywgJ0Nvbm5lY3QnKSkgewogIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXSA9IHt9OwogIEFXUy5Db25uZWN0ID0gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29ubmVjdCcsIFsgJzIwMTctMDItMTUnIF0pOwp9CkFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXVsnMjAxNy0wMi0xNSddID0gcmVxdWlyZSgnLi4vYXBpcy9jb25uZWN0LTIwMTctMDItMTUubWluJyk7CgoKfSx7Ii4uL2FwaXMvY29ubmVjdC0yMDE3LTAyLTE1Lm1pbiI6MywiLi9icm93c2VyX2xvYWRlciI6MTYsIi4vY29yZSI6MTl9XX0se30sWzExMV0pOwoKCgovKioqLyB9KSwKCi8qKiovIDc1NDoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LkNsaWVudE1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2dldEFnZW50U25hcHNob3QnLAogICAgICAgICAncHV0QWdlbnRTdGF0ZScsCiAgICAgICAgICdnZXRBZ2VudFN0YXRlcycsCiAgICAgICAgICdnZXREaWFsYWJsZUNvdW50cnlDb2RlcycsCiAgICAgICAgICdnZXRSb3V0aW5nUHJvZmlsZVF1ZXVlcycsCiAgICAgICAgICdnZXRBZ2VudFBlcm1pc3Npb25zJywKICAgICAgICAgJ2dldEFnZW50Q29uZmlndXJhdGlvbicsCiAgICAgICAgICd1cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24nLAogICAgICAgICAnYWNjZXB0Q29udGFjdCcsCiAgICAgICAgICdjcmVhdGVPdXRib3VuZENvbnRhY3QnLAogICAgICAgICAnY3JlYXRlVGFza0NvbnRhY3QnLAogICAgICAgICAnY2xlYXJDb250YWN0JywKICAgICAgICAgJ2NvbXBsZXRlQ29udGFjdCcsCiAgICAgICAgICdkZXN0cm95Q29udGFjdCcsCiAgICAgICAgICdyZWplY3RDb250YWN0JywKICAgICAgICAgJ25vdGlmeUNvbnRhY3RJc3N1ZScsCiAgICAgICAgICd1cGRhdGVDb250YWN0QXR0cmlidXRlcycsCiAgICAgICAgICdjcmVhdGVBZGRpdGlvbmFsQ29ubmVjdGlvbicsCiAgICAgICAgICdkZXN0cm95Q29ubmVjdGlvbicsCiAgICAgICAgICdob2xkQ29ubmVjdGlvbicsCiAgICAgICAgICdyZXN1bWVDb25uZWN0aW9uJywKICAgICAgICAgJ3RvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zJywKICAgICAgICAgJ2NvbmZlcmVuY2VDb25uZWN0aW9ucycsCiAgICAgICAgICdzZW5kQ2xpZW50TG9ncycsCiAgICAgICAgICdzZW5kRGlnaXRzJywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsUmVwb3J0JywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcycsCiAgICAgICAgICdnZXRFbmRwb2ludHMnLAogICAgICAgICAnZ2V0TmV3QXV0aFRva2VuJywKICAgICAgICAgJ2NyZWF0ZVRyYW5zcG9ydCcsCiAgICAgICAgICdtdXRlUGFydGljaXBhbnQnLAogICAgICAgICAndW5tdXRlUGFydGljaXBhbnQnLAogICAgICAgICAndXBkYXRlTW9uaXRvclBhcnRpY2lwYW50U3RhdGUnCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQWdlbnRBcHBDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcyA9IHsKICAgICAgR0VUX0NPTlRBQ1Q6ICJBZ2VudEFwcFNlcnZpY2UuTGNtcy5nZXRDb250YWN0IiwKICAgICAgREVMRVRFX1NQRUFLRVI6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5kZWxldGVTcGVha2VyIiwKICAgICAgRU5ST0xMX0JZX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5lbnJvbGxCeVNlc3Npb24iLAogICAgICBFVkFMVUFURV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZXZhbHVhdGVTZXNzaW9uIiwKICAgICAgREVTQ1JJQkVfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU3BlYWtlciIsCiAgICAgIE9QVF9PVVRfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLm9wdE91dFNwZWFrZXIiLAogICAgICBVUERBVEVfVk9JQ0VfSURfREFUQTogIkFnZW50QXBwU2VydmljZS5MY21zLnVwZGF0ZVZvaWNlSWREYXRhIiwKICAgICAgREVTQ1JJQkVfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU2Vzc2lvbiIsCiAgICAgIFVQREFURV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQudXBkYXRlU2Vzc2lvbiIsCiAgICAgIFNUQVJUX1ZPSUNFX0lEX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuTmFzYS5zdGFydFZvaWNlSWRTZXNzaW9uIiwKICAgICAgTElTVF9JTlRFR1JBVElPTl9BU1NPQ0lBVElPTlM6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLmxpc3RJbnRlZ3JhdGlvbkFzc29jaWF0aW9ucyIsCiAgICAgIFNUQVJUX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5TdGFydENvbnRhY3RSZWNvcmRpbmciLAogICAgICBTVE9QX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5TdG9wQ29udGFjdFJlY29yZGluZyIsCiAgICAgIFNVU1BFTkRfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlN1c3BlbmRDb250YWN0UmVjb3JkaW5nIiwKICAgICAgUkVTVU1FX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5SZXN1bWVDb250YWN0UmVjb3JkaW5nIgogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gTWFzdGVyTWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5NYXN0ZXJNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICAgICdiZWNvbWVNYXN0ZXInLAogICAgICAgICAnY2hlY2tNYXN0ZXInCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgJ2xpc3RUYXNrVGVtcGxhdGVzJywKICAgICAgJ2dldFRhc2tUZW1wbGF0ZScsCiAgICAgICdjcmVhdGVUZW1wbGF0ZWRUYXNrJywKICAgICAgJ3VwZGF0ZUNvbnRhY3QnCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBDbGllbnRCYXNlID0gZnVuY3Rpb24oKSB7fTsKICAgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1MgPSB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgeyB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHsgfQogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuY2FsbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zSW4sIGNhbGxiYWNrc0luKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1M7CiAgICAgIHRoaXMuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpOwogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgTnVsbENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBOdWxsQ2xpZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgfTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsQ2xpZW50OwoKICAgTnVsbENsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIHZhciBtZXNzYWdlID0gY29ubmVjdC5zcHJpbnRmKCdObyBzdWNoIG1ldGhvZCBleGlzdHMgb24gTlVMTCBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKICAgICAgfQogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSA9IGZ1bmN0aW9uKGNvbmR1aXQsIHJlcXVlc3RFdmVudCwgcmVzcG9uc2VFdmVudCkgewogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICAgIHRoaXMucmVxdWVzdEV2ZW50ID0gcmVxdWVzdEV2ZW50OwogICAgICB0aGlzLnJlc3BvbnNlRXZlbnQgPSByZXNwb25zZUV2ZW50OwogICAgICB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXAgPSB7fTsKCiAgICAgIHRoaXMuY29uZHVpdC5vblVwc3RyZWFtKHJlc3BvbnNlRXZlbnQsIGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5faGFuZGxlUmVzcG9uc2UpKTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHJlcXVlc3QgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXF1ZXN0KHRoaXMucmVxdWVzdEV2ZW50LCBtZXRob2QsIHBhcmFtcyk7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0LnJlcXVlc3RJZF0gPSBjYWxsYmFja3M7CiAgICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0ocmVxdWVzdC5ldmVudCwgcmVxdWVzdCk7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5fZ2V0Q2FsbGJhY2tzRm9yUmVxdWVzdCA9IGZ1bmN0aW9uKHJlcXVlc3RJZCkgewogICAgICB2YXIgY2FsbGJhY2tzID0gdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF0gfHwgbnVsbDsKCiAgICAgIGlmIChjYWxsYmFja3MgIT0gbnVsbCkgewogICAgICAgICBkZWxldGUgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF07CiAgICAgIH0KCiAgICAgIHJldHVybiBjYWxsYmFja3M7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5faGFuZGxlUmVzcG9uc2UgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0KGRhdGEucmVxdWVzdElkKTsKICAgICAgaWYgKGNhbGxiYWNrcyA9PSBudWxsKSB7CiAgICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGRhdGEuZXJyICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGRhdGEuZXJyLCBkYXRhLmRhdGEpOwoKICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhLmRhdGEpOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdENsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQ7CiAgIAogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudEFwcENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgKi8KICAgdmFyIEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24oYXV0aENvb2tpZU5hbWUsIGF1dGhUb2tlbiwgZW5kcG9pbnQpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGF1dGhDb29raWVOYW1lLCAnYXV0aENvb2tpZU5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGF1dGhUb2tlbiwgJ2F1dGhUb2tlbicpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZW5kcG9pbnQsICdlbmRwb2ludCcpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbChlbmRwb2ludCk7CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB0aGlzLmF1dGhDb29raWVOYW1lID0gYXV0aENvb2tpZU5hbWUKICAgfTsKCiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBBZ2VudEFwcENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBZ2VudEFwcENsaWVudDsKCiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGJlYXIgPSB7fTsKICAgICAgYmVhcltzZWxmLmF1dGhDb29raWVOYW1lXSA9IHNlbGYuYXV0aFRva2VuOwogICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgbWV0aG9kOiAncG9zdCcsCiAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHBhcmFtcyB8fCB7fSksCiAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgJ1gtQW16LXRhcmdldCc6IG1ldGhvZCwKICAgICAgICAgICAgICAgJ1gtQW16LUJlYXJlcic6IEpTT04uc3RyaW5naWZ5KGJlYXIpCiAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29ubmVjdC5mZXRjaChzZWxmLmVuZHBvaW50VXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHJlcyk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgIGNvbnN0IHJlYWRlciA9IGVyci5ib2R5LmdldFJlYWRlcigpOwogICAgICAgICBsZXQgYm9keSA9ICcnOwogICAgICAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7CiAgICAgICAgIHJlYWRlci5yZWFkKCkudGhlbihmdW5jdGlvbiBwcm9jZXNzVGV4dCh7IGRvbmUsIHZhbHVlIH0pIHsKICAgICAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgICAgICAgdmFyIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTsKICAgICAgICAgICAgICAgZXJyb3Iuc3RhdHVzID0gZXJyLnN0YXR1czsKICAgICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYm9keSArPSBkZWNvZGVyLmRlY29kZSh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiByZWFkZXIucmVhZCgpLnRoZW4ocHJvY2Vzc1RleHQpOwogICAgICAgICB9KTsKICAgICAgfSkKICAgfTsKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIEFXU0NsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBBV1NDbGllbnQgPSBmdW5jdGlvbihhdXRoVG9rZW4sIHJlZ2lvbiwgZW5kcG9pbnRJbikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWdpb24sICdyZWdpb24nKTsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyh7fSk7CiAgICAgIEFXUy5jb25maWcucmVnaW9uID0gcmVnaW9uOwogICAgICB0aGlzLmF1dGhUb2tlbiA9IGF1dGhUb2tlbjsKICAgICAgdmFyIGJhc2VVcmwgPSBjb25uZWN0LmdldEJhc2VVcmwoKTsKICAgICAgdmFyIGVuZHBvaW50VXJsID0gZW5kcG9pbnRJbiB8fCAoIAogICAgICAgICBiYXNlVXJsLmluY2x1ZGVzKCIuYXdzYXBwcy5jb20iKQogICAgICAgICAgICA/IGJhc2VVcmwgKyAnL2Nvbm5lY3QvYXBpJwogICAgICAgICAgICA6IGJhc2VVcmwgKyAnL2FwaScKICAgICAgKTsKICAgICAgdmFyIGVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludFVybCk7CiAgICAgIHRoaXMuY2xpZW50ID0gbmV3IEFXUy5Db25uZWN0KHtlbmRwb2ludDogZW5kcG9pbnR9KTsKICAgfTsKICAgQVdTQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBBV1NDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQVdTQ2xpZW50OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CgogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwoKICAgICAgaWYgKCEgY29ubmVjdC5jb250YWlucyh0aGlzLmNsaWVudCwgbWV0aG9kKSkgewogICAgICAgICB2YXIgbWVzc2FnZSA9IGNvbm5lY3Quc3ByaW50ZignTm8gc3VjaCBtZXRob2QgZXhpc3RzIG9uIEFXUyBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgIHBhcmFtcyA9IHRoaXMuX3RyYW5zbGF0ZVBhcmFtcyhtZXRob2QsIHBhcmFtcyk7CgogICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogLS0+IENhbGxpbmcgb3BlcmF0aW9uICclcyciLCBtZXRob2QpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAgICB0aGlzLmNsaWVudFttZXRob2RdKHBhcmFtcykKICAgICAgICAgICAgLm9uKCdidWlsZCcsIGZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgICAgICAgICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1CZWFyZXInXSA9IHNlbGYuYXV0aFRva2VuOwogICAgICAgICAgICB9KQogICAgICAgICAgICAuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09IGNvbm5lY3QuQ1RJRXhjZXB0aW9ucy5VTkFVVEhPUklaRURfRVhDRVBUSU9OKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5hdXRoRmFpbHVyZSgpOwogICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQgJiYgKGVyci5jb2RlID09PSBjb25uZWN0LkNUSUV4Y2VwdGlvbnMuQUNDRVNTX0RFTklFRF9FWENFUFRJT04gfHwgZXJyLnN0YXR1c0NvZGUgPT09IDQwMykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCgpOwogICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW4ndCBwYXNzIGVyciBkaXJlY3RseSB0byBwb3N0TWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBwb3N0TWVzc2FnZSgpIHRyaWVzIHRvIGNsb25lIHRoZSBlcnIgb2JqZWN0IGFuZCBmYWlsZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZmVyIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS9nb2F0c2xhY2tlci9hbHQtZGV2dG9vbC9pc3N1ZXMvNQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IudHlwZSA9IGVyci5jb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5tZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIuc3RhY2spewogICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXJyLnN0YWNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gZXJyLnN0YWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyLnN0YWNrID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gW0pTT04uc3RyaW5naWZ5KGVyci5zdGFjayldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyLnN0YWNrID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gZXJyLnN0YWNrLnNwbGl0KCdcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHt9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IDwtLSBPcGVyYXRpb24gJyVzJyBmYWlsZWQ6ICVzIiwgbWV0aG9kLCBKU09OLnN0cmluZ2lmeShlcnIpKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IDwtLSBPcGVyYXRpb24gJyVzJyBzdWNjZWVkZWQuIiwgbWV0aG9kKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGhhbmRsZSBBV1MgQVBJIHJlcXVlc3QgZm9yIG1ldGhvZCAlcyIsIG1ldGhvZCkKICAgICAgICAgICAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgfQogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fcmVxdWlyZXNBdXRoZW50aWNhdGlvblBhcmFtID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICByZXR1cm4gbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09NUExFVEVfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DTEVBUl9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLlJFSkVDVF9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UQVNLX0NPTlRBQ1Q7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVQYXJhbXMgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcykgewogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfQUdFTlRfQ09ORklHVVJBVElPTjoKICAgICAgICAgICAgcGFyYW1zLmNvbmZpZ3VyYXRpb24gPSB0aGlzLl90cmFuc2xhdGVBZ2VudENvbmZpZ3VyYXRpb24ocGFyYW1zLmNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfTUVUUklDUzoKICAgICAgICAgICAgcGFyYW1zLnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKAogICAgICAgICAgICAgICAgICBwYXJhbXMuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9SRVBPUlQ6CiAgICAgICAgICAgIHBhcmFtcy5yZXBvcnQgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVDYWxsUmVwb3J0KHBhcmFtcy5yZXBvcnQpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBpZiAodGhpcy5fcmVxdWlyZXNBdXRoZW50aWNhdGlvblBhcmFtKG1ldGhvZCkpIHsKICAgICAgICAgcGFyYW1zLmF1dGhlbnRpY2F0aW9uID0gewogICAgICAgICAgICBhdXRoVG9rZW46IHRoaXMuYXV0aFRva2VuCiAgICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXJhbXM7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgbmFtZTogY29uZmlnLm5hbWUsCiAgICAgICAgIHNvZnRwaG9uZUVuYWJsZWQ6IGNvbmZpZy5zb2Z0cGhvbmVFbmFibGVkLAogICAgICAgICBzb2Z0cGhvbmVBdXRvQWNjZXB0OiBjb25maWcuc29mdHBob25lQXV0b0FjY2VwdCwKICAgICAgICAgZXh0ZW5zaW9uOiBjb25maWcuZXh0ZW5zaW9uLAogICAgICAgICByb3V0aW5nUHJvZmlsZTogdGhpcy5fdHJhbnNsYXRlUm91dGluZ1Byb2ZpbGUoY29uZmlnLnJvdXRpbmdQcm9maWxlKSwKICAgICAgICAgYWdlbnRQcmVmZXJlbmNlczogY29uZmlnLmFnZW50UHJlZmVyZW5jZXMKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVJvdXRpbmdQcm9maWxlID0gZnVuY3Rpb24ocHJvZmlsZSkgewogICAgICByZXR1cm4gewogICAgICAgICBuYW1lOiBwcm9maWxlLm5hbWUsCiAgICAgICAgIHJvdXRpbmdQcm9maWxlQVJOOiBwcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOLAogICAgICAgICBkZWZhdWx0T3V0Ym91bmRRdWV1ZTogdGhpcy5fdHJhbnNsYXRlUXVldWUocHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZSkKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVF1ZXVlID0gZnVuY3Rpb24ocXVldWUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgcXVldWVBUk46ICAgcXVldWUucXVldWVBUk4sCiAgICAgICAgIG5hbWU6ICAgICAgIHF1ZXVlLm5hbWUKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSBmdW5jdGlvbihzdGF0cykgewogICAgICBzdGF0cy5mb3JFYWNoKGZ1bmN0aW9uKHN0YXQpIHsKICAgICAgICAgaWYgKCdwYWNrZXRzQ291bnQnIGluIHN0YXQpIHsKICAgICAgICAgICAgc3RhdC5wYWNrZXRDb3VudCA9IHN0YXQucGFja2V0c0NvdW50OwogICAgICAgICAgICBkZWxldGUgc3RhdC5wYWNrZXRzQ291bnQ7CiAgICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gc3RhdHM7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVTb2Z0cGhvbmVDYWxsUmVwb3J0ID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICAgIGlmICgnaGFuZHNoYWtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LmhhbmRzaGFrZVRpbWVNaWxsaXMgPSByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgaWYgKCdwcmVUYWxraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5wcmVUYWxrVGltZU1pbGxpcyA9IHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgaWYgKCdoYW5kc2hha2luZ0ZhaWx1cmUnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQuaGFuZHNoYWtlRmFpbHVyZSA9IHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmU7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlOwogICAgICB9CgogICAgICBpZiAoJ3RhbGtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LnRhbGtUaW1lTWlsbGlzID0gcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICByZXBvcnQuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MoCiAgICAgICAgICAgIHJlcG9ydC5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKTsKCiAgICAgIHJldHVybiByZXBvcnQ7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBUYXNrVGVtcGxhdGVzQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogICB2YXIgVGFza1RlbXBsYXRlc0NsaWVudCA9IGZ1bmN0aW9uKGVuZHBvaW50KSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50Jyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgaWYgKGVuZHBvaW50LmluY2x1ZGVzKCcvdGFzay10ZW1wbGF0ZXMnKSkgewogICAgICAgICB0aGlzLmVuZHBvaW50VXJsID0gY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2woZW5kcG9pbnQpOwogICAgICB9IGVsc2UgewogICAgICAgICB2YXIgQVdTRW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgICAgdmFyIENGUHJlZml4ID0gZW5kcG9pbnQuaW5jbHVkZXMoJy5hd3NhcHBzLmNvbScpID8gJy9jb25uZWN0JyA6ICcnOwogICAgICAgICB0aGlzLmVuZHBvaW50VXJsID0gY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2woYCR7QVdTRW5kcG9pbnQuaG9zdH0ke0NGUHJlZml4fS90YXNrLXRlbXBsYXRlcy9hcGkvY2NwYCk7CiAgICAgIH0KICAgfTsKCiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1RlbXBsYXRlc0NsaWVudDsKCiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLAogICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICd4LWNzcmYtdG9rZW4nOiAnY3NyZicgICAgICAgICAKICAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgaW5zdGFuY2VJZCA9IHBhcmFtcy5pbnN0YW5jZUlkOwogICAgICB2YXIgdXJsID0gdGhpcy5lbmRwb2ludFVybDsKICAgICAgdmFyIG1ldGhvZHMgPSBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnRNZXRob2RzOwogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICAgICBjYXNlIG1ldGhvZHMuTElTVF9UQVNLX1RFTVBMQVRFUzogCiAgICAgICAgICAgIHVybCArPSBgL3Byb3h5L2luc3RhbmNlLyR7aW5zdGFuY2VJZH0vdGFzay90ZW1wbGF0ZWA7CiAgICAgICAgICAgIGlmIChwYXJhbXMucXVlcnlQYXJhbXMpIHsKICAgICAgICAgICAgICAgY29uc3QgcXVlcnlTdHJpbmcgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHBhcmFtcy5xdWVyeVBhcmFtcykudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgaWYgKHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgIHVybCArPSBgPyR7cXVlcnlTdHJpbmd9YDsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuR0VUX1RBU0tfVEVNUExBVEU6IAogICAgICAgICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnRlbXBsYXRlUGFyYW1zLCAncGFyYW1zLnRlbXBsYXRlUGFyYW1zJyk7CiAgICAgICAgICAgIGNvbnN0IGlkID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy50ZW1wbGF0ZVBhcmFtcy5pZCwgJ3BhcmFtcy50ZW1wbGF0ZVBhcmFtcy5pZCcpOwogICAgICAgICAgICBjb25zdCB2ZXJzaW9uID0gcGFyYW1zLnRlbXBsYXRlUGFyYW1zLnZlcnNpb247CiAgICAgICAgICAgIHVybCArPSBgL3Byb3h5L2luc3RhbmNlLyR7aW5zdGFuY2VJZH0vdGFzay90ZW1wbGF0ZS8ke2lkfWA7CiAgICAgICAgICAgIGlmICh2ZXJzaW9uKSB7CiAgICAgICAgICAgICAgIHVybCArPSBgP3NuYXBzaG90VmVyc2lvbj0ke3ZlcnNpb259YDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgY2FzZSBtZXRob2RzLkNSRUFURV9URU1QTEFURURfVEFTSzogCiAgICAgICAgICAgIHVybCArPSBgLyR7bWV0aG9kfWA7CiAgICAgICAgICAgIG9wdGlvbnMuYm9keSA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7CiAgICAgICAgICAgIG9wdGlvbnMubWV0aG9kID0gJ1BVVCc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuVVBEQVRFX0NPTlRBQ1Q6IAogICAgICAgICAgICB1cmwgKz0gYC8ke21ldGhvZH1gOwogICAgICAgICAgICBvcHRpb25zLmJvZHkgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpOwogICAgICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICdQT1NUJzsKICAgICAgfQogICAgICBjb25uZWN0LmZldGNoKHVybCwgb3B0aW9ucykKICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocmVzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgY29uc3QgcmVhZGVyID0gZXJyLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgICAgIGxldCBib2R5ID0gJyc7CiAgICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHsgZG9uZSwgdmFsdWUgfSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBlcnIuc3RhdHVzOwogICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkKCkudGhlbihwcm9jZXNzVGV4dCk7CiAgICAgICAgIH0pOwogICAgICB9KQogICB9OwoKICAgY29ubmVjdC5DbGllbnRCYXNlID0gQ2xpZW50QmFzZTsKICAgY29ubmVjdC5OdWxsQ2xpZW50ID0gTnVsbENsaWVudDsKICAgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50OwogICBjb25uZWN0LkFXU0NsaWVudCA9IEFXU0NsaWVudDsKICAgY29ubmVjdC5BZ2VudEFwcENsaWVudCA9IEFnZW50QXBwQ2xpZW50OwogICBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnQgPSBUYXNrVGVtcGxhdGVzQ2xpZW50Owp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gODk1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5jb3JlID0ge307CiAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgY29ubmVjdC52ZXJzaW9uID0gIjEuNy40IjsKICBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRSA9IDUwMDsKIAogIHZhciBDQ1BfU1lOX1RJTUVPVVQgPSAxMDAwOyAvLyAxIHNlYwogIHZhciBDQ1BfQUNLX1RJTUVPVVQgPSAzMDAwOyAvLyAzIHNlYwogIHZhciBDQ1BfTE9BRF9USU1FT1VUID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gMTAwMDA7IC8vMTAgcwogIHZhciBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQgPSA2OyAvLyA2IGF0dGVtcHRzCiAgdmFyIENDUF9JRlJBTUVfTkFNRSA9ICdBbWF6b24gQ29ubmVjdCBDQ1AnOwogCiAgdmFyIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTiA9ICJodHRwczovL3thbGlhc30uYXdzYXBwcy5jb20vYXV0aC8/Y2xpZW50X2lkPXtjbGllbnRfaWR9JnJlZGlyZWN0X3VyaT17cmVkaXJlY3R9IjsKICB2YXIgQ0xJRU5UX0lEX01BUCA9IHsKICAgICJ1cy1lYXN0LTEiOiAiMDY5MTlmNGZkOGVkMzI0ZSIKICB9OwogCiAgdmFyIEFVVEhPUklaRV9FTkRQT0lOVCA9ICIvYXV0aC9hdXRob3JpemUiOwogIHZhciBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UID0gIi9jb25uZWN0L2F1dGgvYXV0aG9yaXplIjsKICB2YXIgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgQVVUSE9SSVpFX01BWF9SRVRSWSA9IDU7CiAKICB2YXIgTEVHQUNZX1dISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL2Nvbm5lY3Qvd2hpdGVsaXN0ZWQtb3JpZ2lucyI7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkgPSA1OwoKICB2YXIgQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTID0gJ0lmcmFtZVJlZnJlc2hBdHRlbXB0cyc7CiAgdmFyIENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUyA9ICdJZnJhbWVJbml0aWFsaXphdGlvblN1Y2Nlc3MnOwogIHZhciBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1RJTUUgPSAnSWZyYW1lSW5pdGlhbGl6YXRpb25UaW1lJzsKCiAgdmFyIENPTk5FQ1RFRF9DQ1BTX1NJTkdMRV9UQUIgPSAnQ29ubmVjdGVkQ0NQU2luZ2xlVGFiQ291bnQnOwogIHZhciBDQ1BfVEFCU19BQ1JPU1NfQlJPV1NFUl9DT1VOVCA9ICdDQ1BUYWJzQWNyb3NzQnJvd3NlckNvdW50JzsKCiAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSAwOwogIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID0gMDsKCiAgY29ubmVjdC5jb3JlLk1BWF9BVVRIT1JJWkVfUkVUUllfQ09VTlRfRk9SX1NFU1NJT04gPSAzOwogIGNvbm5lY3QuY29yZS5NQVhfQ1RJX0FVVEhfUkVUUllfQ09VTlQgPSAxMDsKICBjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgPSAwOwogIGNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQgPSBudWxsOwogIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBudWxsOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNlc3Npb25TdG9yYWdlS2V5cwogICAqLwogIGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndGFiX2lkJywKICAgICdhdXRob3JpemVfcmV0cnlfY291bnQnLAogIF0pOwoKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFRoaXMgZnVuY3Rpb24gd2FzIG9ubHkgbWVhbnQgZm9yIGludGVybmFsIHVzZS4gCiAgICogVGhlIG5hbWUgaXMgbWlzbGVhZGluZyBmb3Igd2hhdCBpdCBzaG91bGQgZG8uCiAgICogSW50ZXJuYWxseSB3ZSBoYXZlIHJlcGxhY2VkIGl0cyB1c2FnZSB3aXRoIGBnZXRMb2dpblVybGAuCiAgICovCiAgdmFyIGNyZWF0ZUxvZ2luVXJsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIHJlZGlyZWN0ID0gImh0dHBzOi8vbGlseS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS90YXcvYXV0aC9jb2RlIjsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWRpcmVjdCk7CiAKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgbG9nLndhcm4oIlRoZSBgYWxpYXNgIHBhcmFtIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZXhwZWN0ZWQgdG8gZnVuY3Rpb24gcHJvcGVybHkuIFBsZWFzZSB1c2UgYGNjcFVybGAgb3IgYGxvZ2luVXJsYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWF6b24tY29ubmVjdC9hbWF6b24tY29ubmVjdC1zdHJlYW1zL2Jsb2IvbWFzdGVyL1JFQURNRS5tZCNjb25uZWN0Y29yZWluaXRjY3AgZm9yIHZhbGlkIHBhcmFtZXRlcnMuIik7CiAgICAgIHJldHVybiBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVwbGFjZXMgYGNyZWF0ZUxvZ2luVXJsYCwgYXMgdGhhdCBmdW5jdGlvbidzIG5hbWUgd2FzIG1pc2xlYWRpbmcuCiAgICogVGhlIGBwYXJhbXMuYWxpYXNgIHBhcmFtZXRlciBpcyBkZXByZWNhdGVkLiBQbGVhc2UgcmVmcmFpbiBmcm9tIHVzaW5nIGl0LgogICAqLwogIHZhciBnZXRMb2dpblVybCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciByZWRpcmVjdCA9ICJodHRwczovL2xpbHkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGF3L2F1dGgvY29kZSI7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVkaXJlY3QpOwogICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICByZXR1cm4gcGFyYW1zLmxvZ2luVXJsCiAgICB9IGVsc2UgaWYgKHBhcmFtcy5hbGlhcykgewogICAgICBsb2cud2FybigiVGhlIGBhbGlhc2AgcGFyYW0gaXMgZGVwcmVjYXRlZCBhbmQgc2hvdWxkIG5vdCBiZSBleHBlY3RlZCB0byBmdW5jdGlvbiBwcm9wZXJseS4gUGxlYXNlIHVzZSBgY2NwVXJsYCBvciBgbG9naW5VcmxgLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FtYXpvbi1jb25uZWN0L2FtYXpvbi1jb25uZWN0LXN0cmVhbXMvYmxvYi9tYXN0ZXIvUkVBRE1FLm1kI2Nvbm5lY3Rjb3JlaW5pdGNjcCBmb3IgdmFsaWQgcGFyYW1ldGVycy4iKTsKICAgICAgcmV0dXJuIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTgogICAgICAgIC5yZXBsYWNlKCJ7YWxpYXN9IiwgcGFyYW1zLmFsaWFzKQogICAgICAgIC5yZXBsYWNlKCJ7Y2xpZW50X2lkfSIsIENMSUVOVF9JRF9NQVBbInVzLWVhc3QtMSJdKQogICAgICAgIC5yZXBsYWNlKCJ7cmVkaXJlY3R9IiwgZ2xvYmFsLmVuY29kZVVSSUNvbXBvbmVudCgKICAgICAgICAgIHJlZGlyZWN0KSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcGFyYW1zLmNjcFVybDsKICAgIH0KICB9OwoKICAvKioKICAgKiBzb2Z0cGhvbmVQYXJhbXNTdG9yYWdlIG1vZHVsZSB0byBzdG9yZSBuZWNlc3Nhcnkgc29mdHBob25lIHBhcmFtcyBpbiBsb2NhbCBzdG9yYWdlCiAgICogVXNlZCBtYWlubHkgZm9yIGNhc2VzIHdoZXJlIGVtYmVkZGVkIENDUCBnZXRzIHJlZnJlc2hlZC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fQogICAqLwoKICB2YXIgc29mdHBob25lUGFyYW1zU3RvcmFnZSA9IChmdW5jdGlvbiAoKSB7CiAgICBsZXQga2V5ID0gYFNvZnRwaG9uZVBhcmFtc1N0b3JhZ2U6OiR7Z2xvYmFsLmxvY2F0aW9uLm9yaWdpbn1gOwogICAgcmV0dXJuIHsKICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFsdWUgJiYgZ2xvYmFsLmxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJTb2Z0cGhvbmVQYXJhbXNTdG9yYWdlOjogRmFpbGVkIHRvIHNldCBzb2Z0cGhvbmUgcGFyYW1zIHRvIGxvY2FsIHN0b3JhZ2UhIikKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbGV0IGl0ZW0gPSBnbG9iYWwubG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTsKICAgICAgICAgIHJldHVybiBpdGVtICYmIEpTT04ucGFyc2UoaXRlbSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiU29mdHBob25lUGFyYW1zU3RvcmFnZTo6IEZhaWxlZCB0byBnZXQgc29mdHBob25lIHBhcmFtcyBmcm9tIGxvY2FsIHN0b3JhZ2UhIikKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCgogICAgICBjbGVhbjogZnVuY3Rpb24gKCkgewogICAgICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogICAgICB9CiAgICB9CiAgfSkoKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogUmV0dXJucyBzY2hlbWU6Ly9ob3N0OnBvcnQgZm9yIGEgZ2l2ZW4gdXJsCiAgKi8KICBmdW5jdGlvbiBzYW5pdGl6ZURvbWFpbih1cmwpIHsKICAgIHZhciBkb21haW4gPSB1cmwubWF0Y2goL14oPzpodHRwcz86XC9cLyk/KD86W15AXG5dK0ApPyg/Ond3d1wuKT8oW146XC9cbj9dKykvaWcpOwogICAgcmV0dXJuIGRvbWFpbi5sZW5ndGggPyBkb21haW5bMF0gOiAiIjsKICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIFByaW50IGEgd2FybmluZyBtZXNzYWdlIGlmIHRoZSBDb25uZWN0IGNvcmUgaXMgbm90IGluaXRpYWxpemVkLgogICAgKi8KICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICAgIGxvZy53YXJuKCJDb25uZWN0IGNvcmUgYWxyZWFkeSBpbml0aWFsaXplZCwgb25seSBuZWVkcyB0byBiZSBpbml0aWFsaXplZCBvbmNlLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogRElTQVNURVIgUkVDT1ZFUlkgCiAgKi8KICAKICAgdmFyIG1ha2VBZ2VudE9mZmxpbmUgPSBmdW5jdGlvbihhZ2VudCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgb2ZmbGluZVN0YXRlID0gYWdlbnQuZ2V0QWdlbnRTdGF0ZXMoKS5maW5kKGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGUudHlwZSA9PT0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5PRkZMSU5FOwogICAgfSk7CiAgICBhZ2VudC5zZXRTdGF0ZShvZmZsaW5lU3RhdGUsIGNhbGxiYWNrcyk7ICAgCiAgfQogCiAgLy8gU3VwcHJlc3MgQ29udGFjdHMgZnVuY3Rpb24gCiAgLy8gVGhpcyBpcyB1c2VkIGJ5IERpc2FzdGVyIFJlY292ZXJ5IGFzIGEgc2FmZWd1YXJkIHRvIG5vdCBzdXJmYWNlIGluY29taW5nIGNhbGxzL2NoYXRzIHRvIFVJCiAgLy8gCiAgdmFyIHN1cHByZXNzQ29udGFjdHMgPSBmdW5jdGlvbiAoaXNTdXBwcmVzc2VkKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgY29udGFjdHMgc3VwcHJlc3NvciB0byAlcyBmb3IgaW5zdGFuY2UgJXMuIiwgCiAgICAgIGlzU3VwcHJlc3NlZCwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgewogICAgICBzdXBwcmVzczogaXNTdXBwcmVzc2VkCiAgICB9KTsKICB9CiAKICB2YXIgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0gPSBmdW5jdGlvbihvZmZsaW5lKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltESVNBU1RFUiBSRUNPVkVSWV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgZm9yY2VPZmZsaW5lIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgb2ZmbGluZSwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCB7CiAgICAgIG9mZmxpbmU6IG9mZmxpbmUKICAgIH0pOwogIH0KIAogIC8vIEZvcmNlIHRoZSBpbnN0YW5jZSB0byBiZSBvZmZsaW5lLiAKICAvLyBUaGlzIHRyaWVzIHRvIGRpc2Nvbm5lY3QgYWxsIGNvbnRhY3RzIChIYXJkIHN0b3ApCiAgLy8gaWYgZHVlIHRvIGEgZmFpbHVyZSAodGhlIGJhY2tlbmQgaXMgbm90IHJlYWNoYWJsZSksIHNpZ25hbCB0aGUgc2hhcmVkIHdvcmtlciB0byBmb3JjZV9vZmZsaW5lIHdoZW4gaXQgd2FrZXMgdXAgYWdhaW4KICAvLyBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIHJhbiBmcm9tIG5hdGl2ZSBDQ1AgZm9yIGRpc2Nvbm5lY3RpbmcgY2hhdHMuCiAgdmFyIGZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBBdHRlbXB0aW5nIHRvIGZvcmNlIGluc3RhbmNlICVzIG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbihhZ2VudCkgewogICAgICB2YXIgY29udGFjdENsb3NlZCA9IDA7CiAgICAgIHZhciBjb250YWN0cyA9IGFnZW50LmdldENvbnRhY3RzKCk7CiAgICAgIGlmIChjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICBjb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnRhY3QpIAogICAgICAgICAgewogICAgICAgICAgICBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmRlc3Ryb3koewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgYWxsIGFjdGl2ZSBjb250YWN0cyBhcmUgY2xvc2VkCiAgICAgICAgICAgICAgICBpZiAoKytjb250YWN0Q2xvc2VkID09PSBjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgICAgICAgICAgICAvLyBJdCdzIG9rIGlmIHdlJ3JlIG5vdCBhYmxlIHRvIHB1dCB0aGUgYWdlbnQgb2ZmbGluZS4gCiAgICAgICAgICAgICAgICAgIC8vIHNpbmNlIHdlJ3JlIHN1cHByZXNzaW5nIHRoZSBhZ2VudHMgY29udGFjdHMgYWxyZWFkeS4gCiAgICAgICAgICAgICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgICAgICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbnN0YW5jZSAlcyBpcyBub3cgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIGxvZy53YXJuKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEFuIGVycm9yIG9jY3VyZWQgd2hpbGUgYXR0ZW1wdGluZyB0byBmb3JjZSB0aGlzIGluc3RhbmNlIHRvIG9mZmxpbmUgaW4gcmVnaW9uICVzIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIGxvZy53YXJuKGVycikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIC8vIHNpZ25hbCB0aGUgc2hhcmVkd29ya2VyIHRvIGNhbGwgZm9yY2VPZmZsaW5lIGFnYWluIHdoZW4gbmV0d29yayBjb25uZWN0aW9uIAogICAgICAgICAgICAgICAgLy8gaGFzIGJlZW4gcmUtZXN0YWJsaXNoZWQgKHRoaXMgaGFwcGVucyBpbiBjYXNlIG9mIG5ldHdvcmsgb3IgYmFja2VuZCBmYWlsdXJlcykKICAgICAgICAgICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKHRydWUpOwogICAgICAgICAgICB9fSk7CiAgICAgICAgICB9CiAgICAgICAgKSAgICAgICAgCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluc3RhbmNlICVzIGlzIG5vdyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfQogCiAgLy9Jbml0aWF0ZSBEaXNhc3RlciBSZWNvdmVyeSAoVGhpcyBzaG91bGQgb25seSBiZSBjYWxsZWQgZnJvbSBjdXN0b21DQ1AgdGhhdCBhcmUgRFIgZW5hYmxlZCkKICBjb25uZWN0LmNvcmUuaW5pdERpc2FzdGVyUmVjb3ZlcnkgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgY29ubmVjdC5jb3JlLnJlZ2lvbiA9IHBhcmFtcy5yZWdpb247CiAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7ICAKICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUgPSBmb3JjZU9mZmxpbmU7CgogICAgLy9SZWdpc3RlciBpZnJhbWUgbGlzdG5lciB0byBzZXQgbmF0aXZlIENDUCBvZmZsaW5lCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CiAKICAgIC8vIFJlZ2lzdGVyIEV2ZW50IGxpc3RuZXIgdG8gRm9yY2UgdGhlIEFnZW50IHRvIGJlIG9mZmxpbmUgd2hlbiBzaGFyZWQgd29ya2VyIHJlY292ZXJzIGZyb20gbmV0d29yayBmYWlsdXJlCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CgogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbml0aWFsaXppbmcgcmVnaW9uICVzIGFzIHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBhbHJlYWR5IHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwoKICAgIGlmICghcGFyYW1zLmlzUHJpbWFyeSkgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyh0cnVlKTsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gc3RhbmQtYnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMoZmFsc2UpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gcHJpbWFyeSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEJhc2ljIENvbm5lY3QgY2xpZW50IGluaXRpYWxpemF0aW9uLgogICAqIFNob3VsZCBiZSB1c2VkIG9ubHkgYnkgdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRUYXNrVGVtcGxhdGVzQ2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgQVdTIGNsaWVudAogICAqIFNob3VsZCBiZSB1c2VkIGJ5IFNoYXJlZCBXb3JrZXIgdG8gdXBkYXRlIEFXUyBjbGllbnQgd2l0aCBuZXcgY3JlZGVudGlhbHMKICAgKiBhZnRlciByZWZyZXNoZWQgYXV0aGVudGljYXRpb24uCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICAKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogCiAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuQVdTQ2xpZW50KGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludCk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVkIEFnZW50QXBwIGNsaWVudAogICAqIFNob3VsZCBiZSB1c2VkIGJ5IFNoYXJlZCBXb3JrZXIgdG8gdXBkYXRlIEFnZW50QXBwIGNsaWVudCB3aXRoIG5ldyBjcmVkZW50aWFscwogICAqIGFmdGVyIHJlZnJlc2hlZCBhdXRoZW50aWNhdGlvbi4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOyAgICAKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciBhdXRoQ29va2llTmFtZSA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aENvb2tpZU5hbWUsICdwYXJhbXMuYXV0aENvb2tpZU5hbWUnKTsKICAgIHZhciBlbmRwb2ludCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYWdlbnRBcHBFbmRwb2ludCwgJ3BhcmFtcy5hZ2VudEFwcEVuZHBvaW50Jyk7CiAgICAKICAgIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG5ldyBjb25uZWN0LkFnZW50QXBwQ2xpZW50KGF1dGhDb29raWVOYW1lLCBhdXRoVG9rZW4sIGVuZHBvaW50KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgVGFza1RlbXBsYXRlcyBjbGllbnQKICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdFRhc2tUZW1wbGF0ZXNDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMudGFza1RlbXBsYXRlc0VuZHBvaW50IHx8IHBhcmFtcy5lbmRwb2ludDsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ3Rhc2tUZW1wbGF0ZXNFbmRwb2ludCcpOwogICAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBuZXcgY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50KGVuZHBvaW50KTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFVuaW5pdGlhbGl6ZSBDb25uZWN0LgogICAqLwogIGNvbm5lY3QuY29yZS50ZXJtaW5hdGUgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgaWYgKGJ1cykgYnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICBjb25uZWN0LmNvcmUuYnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBudWxsOwogICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBTZXR1cCB0aGUgU29mdHBob25lTWFuYWdlciB0byBiZSBpbml0aWFsaXplZCB3aGVuIHRoZSBhZ2VudAogICAqIGlzIGRldGVybWluZWQgdG8gaGF2ZSBzb2Z0cGhvbmUgZW5hYmxlZC4KICAgKi8KICBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gbnVsbDsKIAogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBzdHJlYW07CiAgfTsKIAogIGNvbm5lY3QuY29yZS5pbml0UmluZ3RvbmVFbmdpbmVzID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogCiAgICB2YXIgc2V0dXBSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocmluZ3RvbmVTZXR0aW5ncykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncywgInJpbmd0b25lU2V0dGluZ3MiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2ssICJyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2suZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKIAogICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzID0ge307CiAKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnZvaWNlID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy52b2ljZSk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJWb2ljZVJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MuY2hhdC5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0KSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0ID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLmNoYXQpOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdFJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MudGFzay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlRhc2tSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnRhc2spOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJUYXNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjaykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMucXVldWVfY2FsbGJhY2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2spOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIGhhbmRsZVJpbmdlckRldmljZUNoYW5nZSgpOwogICAgfTsKIAogICAgdmFyIG1lcmdlUGFyYW1zID0gZnVuY3Rpb24gKHBhcmFtcywgb3RoZXJQYXJhbXMpIHsKICAgICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5OiBzdXBwb3J0IHB1bGxpbmcgZGlzYWJsZWQgZmxhZyBhbmQgcmluZ3RvbmVVcmwKICAgICAgLy8gZnJvbSBzb2Z0cGhvbmUgY29uZmlnIGlmIGl0IGV4aXN0cyBmcm9tIGRvd25zdHJlYW0gaW50byB0aGUgcmluZ3RvbmUgY29uZmlnLgogICAgICBwYXJhbXMucmluZ3RvbmUgPSBwYXJhbXMucmluZ3RvbmUgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZSA9IHBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IHBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnRhc2sgPSBwYXJhbXMucmluZ3RvbmUudGFzayB8fCB7IGRpc2FibGVkOiB0cnVlIH07CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZSkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUuZGlzYWJsZVJpbmd0b25lKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQpIHsKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0LmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5yaW5ndG9uZVVybCkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsOwogICAgICAgIH0KICAgICAgfQogCiAgICAgIC8vIE1lcmdlIGluIHJpbmd0b25lIHNldHRpbmdzIGZyb20gZG93bnN0cmVhbS4KICAgICAgaWYgKG90aGVyUGFyYW1zLnJpbmd0b25lKSB7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUudm9pY2UsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2ssCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5jaGF0LAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUuY2hhdCB8fCB7fSk7CiAgICAgIH0KICAgIH07CiAKICAgIC8vIE1lcmdlIHBhcmFtcyBmcm9tIHBhcmFtcy5zb2Z0cGhvbmUgYW5kIHBhcmFtcy5jaGF0IGludG8gcGFyYW1zLnJpbmd0b25lCiAgICAvLyBmb3IgZW1iZWRkZWQgYW5kIG5vbi1lbWJlZGRlZCB1c2UgY2FzZXMgc28gdGhhdCBkZWZhdWx0cyBhcmUgcGlja2VkIHVwLgogICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBwYXJhbXMpOwogCiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIC8vIElmIHRoZSBDQ1AgaXMgaW4gYSBmcmFtZSwgd2FpdCBmb3IgY29uZmlndXJhdGlvbiBmcm9tIGRvd25zdHJlYW0uCiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgIC8vIE1lcmdlIGFsbCBwYXJhbXMgZnJvbSBkYXRhIGludG8gcGFyYW1zIGZvciBhbnkgb3ZlcnJpZGRlbgogICAgICAgIC8vIHZhbHVlcyBpbiBlaXRoZXIgbGVnYWN5ICJzb2Z0cGhvbmUiIG9yICJyaW5ndG9uZSIgc2V0dGluZ3MuCiAgICAgICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBkYXRhKTsKICAgICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgICB9KTsKIAogICAgfSBlbHNlIHsKICAgICAgc2V0dXBSaW5ndG9uZUVuZ2luZXMocGFyYW1zLnJpbmd0b25lKTsKICAgIH0KICB9OwoKICB2YXIgaGFuZGxlUmluZ2VyRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwgc2V0UmluZ2VyRGV2aWNlKTsKICB9CgogIHZhciBzZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSl7CiAgICBpZihjb25uZWN0LmtleXMoY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcykubGVuZ3RoID09PSAwIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKXsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIGZvciAodmFyIHJpbmd0b25lVHlwZSBpbiBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzKSB7CiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXNbcmluZ3RvbmVUeXBlXS5zZXRPdXRwdXREZXZpY2UoZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5SSU5HRVJfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgY29ubmVjdC5jb3JlLmluaXRTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gaW5pdFNvZnRwaG9uZU1hbmFnZXIgc3RhcnRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgdmFyIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlID0gZnVuY3Rpb24gKHNvZnRwaG9uZVBhcmFtc0luKSB7CiAgICAgIHZhciBzb2Z0cGhvbmVQYXJhbXMgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5zb2Z0cGhvbmUgfHwge30sIHNvZnRwaG9uZVBhcmFtc0luKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBpZiAoIWFnZW50LmdldENoYW5uZWxDb25jdXJyZW5jeShjb25uZWN0LkNoYW5uZWxUeXBlLlZPSUNFKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIHN1YiA9IHRoaXM7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gYWdlbnQgcmVmcmVzaCBoYW5kbGVyIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKIAogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGNvbmZpcm1lZCBhcyBzb2Z0cGhvbmUgbWFzdGVyIHRvcGljIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgaWYgKCFjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciAmJiBhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgIC8vIEJlY29tZSBtYXN0ZXIgdG8gc2VuZCBsb2dzLCBzaW5jZSB3ZSBuZWVkIGxvZ3MgZnJvbSBzb2Z0cGhvbmUgdGFiLgogICAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyKHNvZnRwaG9uZVBhcmFtcyk7CiAgICAgICAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH07CgogICAgLyoqCiAgICAgICogSWYgdGhlIHdpbmRvdyBpcyBmcmFtZWQgYW5kIGlmIGl0J3MgdGhlIENDUCBhcHAgdGhlbiB3ZSBuZWVkIHRvIHdhaXQgZm9yIGEgQ09ORklHVVJFIG1lc3NhZ2UgZnJvbSBkb3duc3RyZWFtIGJlZm9yZSB3ZSBpbml0aWFsaXplIHNvZnRwaG9uZSBtYW5hZ2VyLgogICAgICAqIEFsbCBtZWRpYWxlc3Mgc29mdHBob25lIGluaXRpYWxpemF0aW9uIGNhc2VzIGdvZXMgdG8gZWxzZSBjaGVjayBhbmQgZG9lc24ndCB3YWl0IGZvciBDT05GSUdVUkUgbWVzc2FnZQogICAgICovCgoKICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgY29ubmVjdC5pc0NDUCgpKSB7CgogICAgICBsZXQgY29uZmlndXJlTWVzc2FnZVRpbWVyOyAgLy8gdXNlZCBmb3IgcmUtaW5pdGluZyB0aGUgc29mdHBob25lIG1hbmFnZXIKICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwoKICAgICAgLy8gQ29uZmlndXJlIGhhbmRsZXIgdHJpZ2dlcnMgdGhlIHNvZnRwaG9uZSBtYW5hZ2VyIGluaXRpYXRpb24uCiAgICAgIC8vIFRoaXMgZXZlbnQgaXMgcHJvcGFndGVkIGJ5IGluaXRDQ1AgY2FsbCBmcm9tIHRoZSBlbmQgY3VzdG9tZXJzIAogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbmZpZ3VyZU1lc3NhZ2VUaW1lcik7IC8vIHdlIGRvbid0IG5lZWQgdG8gcmUtaW5pdCBzb2Z0cGhvbmUgbWFuYWdlciBhcyB3ZSByZWNpZXZlZCBjb25maWd1cmUgZXZlbnQKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gQ29uZmlndXJlIGV2ZW50IGhhbmRsZXIgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIC8vIGFsd2F5cyBvdmVyd3JpdGUvc3RvcmUgdGhlIHNvZnRwaG9uZSBwYXJhbXMgdmFsdWUgaWYgdGhlcmUgaXMgYSBjb25maWd1cmUgZXZlbnQKICAgICAgICBzb2Z0cGhvbmVQYXJhbXNTdG9yYWdlLnNldChkYXRhLnNvZnRwaG9uZSk7CiAgICAgICAgaWYgKGRhdGEuc29mdHBob25lICYmIGRhdGEuc29mdHBob25lLmFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZShkYXRhLnNvZnRwaG9uZSk7CiAgICAgICAgfQogICAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChkYXRhLnNvZnRwaG9uZSk7CiAgICAgIH0pOwoKICAgICAgLyoqCiAgICAgICAqIFRoaXMgaXMgdGhlIGNhc2Ugd2hlcmUgQ0NQIGlzIGp1c3QgcmVmcmVzaGVkIGFmdGVyIGl0IGdldHMgaW5pdGlsYWl6ZWQgdmlhIGluaXRDQ1AKICAgICAgICogVGhpcyBzbmlwcGV0IG5lZWRzIGF0bGVhc3Qgb25lIGluaXRDQ1AgaW52b2NhdGlvbiB3aGljaCBzZXRzIHRoZSBwYXJhbXMgdG8gdGhlIHN0b3JlCiAgICAgICAqIGFuZCB3YWl0cyBmb3IgQ0NQIHRvIGxvYWQgc3VjY2Vzc2Z1bGx5IHRvIGFwcGx5IHRoZSBzYW1lIHRvIGluaXQgU29mdHBob25lIG1hbmFnZXIKICAgICAgICovCgogICAgICBsZXQgc29mdHBob25lUGFyYW1zRnJvbUxvY2FsU3RvcmFnZSA9IHNvZnRwaG9uZVBhcmFtc1N0b3JhZ2UuZ2V0KCk7CgogICAgICBpZiAoc29mdHBob25lUGFyYW1zRnJvbUxvY2FsU3RvcmFnZSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgICAgICAvLyBvbmx5IGNhcmUgYWJvdXQgc2hhcmVkIHdvcmtlciBBQ0sgd2hpY2ggaW5kaWNhdGVzIENDUCBzdWNjZXNzZnVsbCBsb2FkCiAgICAgICAgICBsZXQgYWNrRnJvbVNoYXJlZFdvcmtlciA9ICBhcmdzICYmIGFyZ3MuaWQ7CiAgICAgICAgICBpZiAoYWNrRnJvbVNoYXJlZFdvcmtlcikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gRW1iZWRkZWQgQ0NQIGlzIHJlZnJlc2hlZCBzdWNjZXNzZnVsbHkgYW5kIHdhaXRpbmcgZm9yIGNvbmZpZ3VyZSBNZXNzYWdlIGhhbmRsZXIgdG8gZXhlY3V0ZSIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgY29uZmlndXJlTWVzc2FnZVRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBFbWJlZGRlZCBDQ1AgaXMgcmVmcmVzaGVkIHdpdGhvdXQgY29uZmlndXJlIG1lc3NhZ2UgaGFuZGxlciBleGVjdXRpb24iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgICAgICBuYW1lOiAiRW1iZWRkZWRDQ1BSZWZyZXNoZWRXaXRob3V0SW5pdENDUCIsCiAgICAgICAgICAgICAgICBkYXRhOiB7IGNvdW50OiAxIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KHNvZnRwaG9uZVBhcmFtc0Zyb21Mb2NhbFN0b3JhZ2UpOwoKICAgICAgICAgICAgICBpZiAoc29mdHBob25lUGFyYW1zRnJvbUxvY2FsU3RvcmFnZS5hbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIEVtYmVkZGVkIENDUCBpcyByZWZyZXNoZWQgJiBJbml0aWFsaXppbmcgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUgKFNvZnRwaG9uZSBtYW5hZ2VyKSBmcm9tIGxvY2FsU3RvcmFnZSBzb2Z0cGhvbmUgcGFyYW1zIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKHNvZnRwaG9uZVBhcmFtc0Zyb21Mb2NhbFN0b3JhZ2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyAxMDAgbXMgaXMgZnJvbSB0aGUgdGltZSBpdCB0YWtlcyB0byBleGVjdXRlIGZldyBsaW5lcyBvZiBKUyBjb2RlIHRvIHRyaWdnZXIgdGhlIGNvbmZpZ3VyZSBldmVudCAodGhpcyBpcyBkb25lIGluIGluaXRDQ1ApIAogICAgICAgICAgICAgIC8vIHdoaWNoIGlzIGluIGZyYWN0aW9uIG9mIG1pbGlzZWNvbmQuICBzbyB0byBiZSBvbiB0aGUgc2FmZXIgc2lkZSB3ZSBhcmUga2VlcGluZyBpdCB0byBiZSAxMDAKICAgICAgICAgICAgICAvLyB0aGlzIG51bWJlciBpcyBwdWxsZWQgZnJvbSBwZXJmb3JtYW5jZS5ub3coKSBjYWxjdWxhdGlvbnMuCiAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKHBhcmFtcyk7CiAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChwYXJhbXMpOwogICAgfQoKICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgIC8vIFN5bmMgbXV0ZSBhY3Jvc3MgYWxsIHRhYnMgCiAgICAgIGlmIChhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSAmJiBhZ2VudC5nZXRDaGFubmVsQ29uY3VycmVuY3koY29ubmVjdC5DaGFubmVsVHlwZS5WT0lDRSkpIHsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULAogICAgICAgICAgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURQogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChzb2Z0cGhvbmVQYXJhbXNJbikgewogICAgICB2YXIgc29mdHBob25lUGFyYW1zID0gY29ubmVjdC5tZXJnZShwYXJhbXMuc29mdHBob25lIHx8IHt9LCBzb2Z0cGhvbmVQYXJhbXNJbik7CgogICAgICAvLyBrZWVwIHRoZSBzb2Z0cGhvbmUgcGFyYW1zIGZvciBleHRlcm5hbCB1c2UKICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyA9IHNvZnRwaG9uZVBhcmFtczsKCiAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSkgewogICAgICAgIC8vIEluIEZpcmVmb3gsIHdoZW4gYSB0YWIgdGFrZXMgb3ZlciBhbm90aGVyIHRhYidzIHNvZnRwaG9uZSBwcmltYXJ5LAogICAgICAgIC8vIHRoZSBwcmV2aW91cyBwcmltYXJ5IHRhYiBzaG91bGQgZGVsZXRlIHNvZnBob25lIG1hbmFnZXIgYW5kIHN0b3AgbWljcm9waG9uZQogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLmRhdGEgJiYgcmVzLmRhdGEudG9waWMgPT09IGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSAmJiByZXMuZGF0YS50YWtlT3ZlciAmJiAocmVzLmRhdGEubWFzdGVySWQgIT09IGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQpKSB7CiAgICAgICAgICAgIGlmIChjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcikgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLm9uSW5pdENvbnRhY3RTdWIudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgICBkZWxldGUgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVzZXJNZWRpYVN0cmVhbSA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKTsKICAgICAgICAgICAgaWYgKHVzZXJNZWRpYVN0cmVhbSkgewogICAgICAgICAgICAgIHVzZXJNZWRpYVN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKGZ1bmN0aW9uKHRyYWNrKSB7IHRyYWNrLnN0b3AoKTsgfSk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBJbiBGaXJlZm94LCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4sCiAgICAgICAgLy8gd2VicnRjIHNlc3Npb24gaXMgbm90IHN0YXJ0ZWQgdW50aWwgUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiBldmVudCBpcyB0cmlnZ2VyZWQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcikgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLnN0YXJ0U2Vzc2lvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyICYmIGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWFuYWdlcihzb2Z0cGhvbmVQYXJhbXMpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5zdGFydFNlc3Npb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZGxpbmcgb3V0Ym91bmQtY2FsbCBhbmQgYXV0by1hY2NlcHQgY2FzZXMgZm9yIHBlbmRpbmcgc2Vzc2lvbgogICAgICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoYykgewogICAgICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICAgICAgYy5vblJlZnJlc2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICBjb25uZWN0Lmhhc090aGVyQ29ubmVjdGVkQ0NQcygpICYmCiAgICAgICAgICAgICAgICBkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgPT09ICd2aXNpYmxlJyAmJgogICAgICAgICAgICAgICAgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HIHx8IGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBpc091dEJvdW5kQ2FsbCA9IGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgIWNvbnRhY3QuaXNJbmJvdW5kKCk7CiAgICAgICAgICAgICAgICB2YXIgaXNBdXRvQWNjZXB0RW5hYmxlZCA9IGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgYWdlbnQuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUF1dG9BY2NlcHQ7CiAgICAgICAgICAgICAgICB2YXIgaXNRdWV1ZWRDYWxsYmFjayA9IGNvbnRhY3QuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLOwogICAgICAgICAgICAgICAgaWYgKGlzT3V0Qm91bmRDYWxsIHx8IGlzQXV0b0FjY2VwdEVuYWJsZWQgfHwgaXNRdWV1ZWRDYWxsYmFjaykgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUudHJpZ2dlclJlYWR5VG9TdGFydFNlc3Npb25FdmVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CgogIC8vIHRyaWdnZXIgUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiBldmVudCBpbiBhIGNvbnRleHQgd2l0aCBTb2Z0cGhvbmUgTWFuYWdlcgogIC8vIGludGVybmFsIHVzZSBvbmx5CiAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYWxsb3dGcmFtZWRTb2Z0cGhvbmUgPSBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zICYmIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmU7CiAgICBpZiAoY29ubmVjdC5pc0NDUCgpKSB7CiAgICAgIGlmIChhbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgIC8vIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgaW4gdGhpcyBpZnJhbWVkIENDUCBjb250ZXh0CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiBpZnJhbWVkIENDUCwgdGhlIGV2ZW50IGlzIHNlbmQgdG8gZG93bnN0cmVhbSAoQ1JNKQogICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZERvd25zdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBpZiB0aGlzIGlzIGEgc3RhbmRhbG9uZSBDQ1AsIHRyaWdnZXIgdGhpcyBldmVudCBpbiB0aGlzIENDUCBjb250ZXh0CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChhbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgIC8vIHRoZSBldmVudCBpcyBzZW5kIHRvIHRoZSB1cHN0cmVhbSAoaWZyYW1lZCBDQ1ApCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIGluIHRoaXMgQ1JNIGNvbnRleHQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfQogICAgfQogIH07CgogIGNvbm5lY3QuY29yZS5pbml0UGFnZU9wdGlvbnMgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAicGFyYW1zIik7CiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIC8vIElmIHRoZSBDQ1AgaXMgaW4gYSBmcmFtZSwgd2FpdCBmb3IgY29uZmlndXJhdGlvbiBmcm9tIGRvd25zdHJlYW0uCiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgICAgIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5DT05GSUdVUkUsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pOwogICAgICB9KTsKICAgICAgLy8gTGlzdGVuIGZvciBpZnJhbWUgbWVkaWEgZGV2aWNlcyByZXF1ZXN0IGZyb20gQ1JNCiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFUVVFU1QsIGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBzZW5kRGV2aWNlcyhkZXZpY2VzKSB7CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVTUE9OU0UsIGRldmljZXMpOwogICAgICAgIH0KICAgICAgICBpZiAobmF2aWdhdG9yICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpCiAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGV2aWNlc0luKSB7CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzSW4gfHwgW107CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzLm1hcChmdW5jdGlvbihkKSB7IHJldHVybiBkLnRvSlNPTigpIH0pOwogICAgICAgICAgICBzZW5kRGV2aWNlcyhkZXZpY2VzKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBzZW5kRGV2aWNlcyh7ZXJyb3I6IGVyci5tZXNzYWdlfSk7CiAgICAgICAgICB9KTsgCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbmREZXZpY2VzKHtlcnJvcjogIk5vIG5hdmlnYXRvciBvciBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzIG9iamVjdCBmb3VuZCJ9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBHZXQgdGhlIGxpc3Qgb2YgbWVkaWEgZGV2aWNlcyBmcm9tIGlmcmFtZWQgQ0NQCiAgICogVGltZW91dCBmb3IgdGhlIHJlcXVlc3QgaXMgcGFzc2VkIG9uIGFuIG9wdGlvbmFsIGFyZ3VtZW50CiAgICogVGhlIGRlZmF1bHQgdGltZW91dCBpcyAxMDAwbXMKICAgKi8KICBjb25uZWN0LmNvcmUuZ2V0RnJhbWVNZWRpYURldmljZXMgPSBmdW5jdGlvbiAodGltZW91dEluKSB7CiAgICB2YXIgc3ViID0gbnVsbDsKICAgIHZhciB0aW1lb3V0ID0gdGltZW91dEluIHx8IDEwMDA7CiAgICB2YXIgdGltZW91dFByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyAKICAgICAgICByZWplY3QobmV3IEVycm9yKCJUaW1lb3V0IGV4Y2VlZGVkIikpOyAKICAgICAgfSwgdGltZW91dCk7CiAgICB9KTsKICAgIHZhciBtZWRpYURldmljZXNQcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgeyAKICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSB8fCBjb25uZWN0LmlzQ0NQKCkpIHsKICAgICAgICBpZiAobmF2aWdhdG9yICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpCiAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGV2aWNlc0luKSB7CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzSW4gfHwgW107CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzLm1hcChmdW5jdGlvbiAoZCkgeyByZXR1cm4gZC50b0pTT04oKSB9KTsKICAgICAgICAgICAgcmVzb2x2ZShkZXZpY2VzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWplY3QobmV3IEVycm9yKCJObyBuYXZpZ2F0b3Igb3IgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBvYmplY3QgZm91bmQiKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgICBzdWIgPSBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVNQT05TRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoZGF0YS5lcnJvcikpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFUVVFU1QpOwogICAgICB9CiAgICB9KQogICAgcmV0dXJuIFByb21pc2UucmFjZShbbWVkaWFEZXZpY2VzUHJvbWlzZSwgdGltZW91dFByb21pc2VdKQogICAgLmZpbmFsbHkoZnVuY3Rpb24gKCkgewogICAgICBpZiAoc3ViKSB7CiAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLy9JbnRlcm5hbCB1c2Ugb25seS4KICBjb25uZWN0LmNvcmUuYXV0aG9yaXplID0gZnVuY3Rpb24gKGVuZHBvaW50KSB7CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJwogICAgfTsKCiAgICB2YXIgYXV0aG9yaXplRW5kcG9pbnQgPSBlbmRwb2ludDsKICAgIGlmICghYXV0aG9yaXplRW5kcG9pbnQpIHsKICAgICAgYXV0aG9yaXplRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKQogICAgICAgID8gTEVHQUNZX0FVVEhPUklaRV9FTkRQT0lOVAogICAgICAgIDogQVVUSE9SSVpFX0VORFBPSU5UOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2goYXV0aG9yaXplRW5kcG9pbnQsIG9wdGlvbnMsIEFVVEhPUklaRV9SRVRSWV9JTlRFUlZBTCwgQVVUSE9SSVpFX01BWF9SRVRSWSk7CiAgfTsKIAogIC8qKgogICAqIEBkZXByZWNhdGVkCiAgICogVGhpcyB1c2VkIHRvIGJlIHVzZWQgaW50ZXJuYWxseSwgYnV0IGlzIG5vIGxvbmdlciBuZWVkZWQuCiAgICovCiAgY29ubmVjdC5jb3JlLnZlcmlmeURvbWFpbkFjY2VzcyA9IGZ1bmN0aW9uIChhdXRoVG9rZW4sIGVuZHBvaW50KSB7CiAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoaXMgQVBJIHdpbGwgYmUgZGVwcmVjYXRlZCBpbiB0aGUgbmV4dCBtYWpvciB2ZXJzaW9uIHJlbGVhc2UiKTsKICAgIGlmICghY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICAgIH0KICAgIHZhciBvcHRpb25zID0gewogICAgICBoZWFkZXJzOiB7CiAgICAgICAgJ1gtQW16LUJlYXJlcic6IGF1dGhUb2tlbgogICAgICB9CiAgICB9OwogICAgdmFyIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gbnVsbDsKICAgIGlmIChlbmRwb2ludCl7CiAgICAgIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICB9CiAgICBlbHNlIHsKICAgICAgd2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKSAKICAgICAgICA/IExFR0FDWV9XSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UCiAgICAgICAgOiBXSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UOwogICAgfQogICAgCiAgICByZXR1cm4gY29ubmVjdC5mZXRjaCh3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCwgb3B0aW9ucywgV0hJVEVMSVNURURfT1JJR0lOU19SRVRSWV9JTlRFUlZBTCwgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciB0b3BEb21haW4gPSBzYW5pdGl6ZURvbWFpbih3aW5kb3cuZG9jdW1lbnQucmVmZXJyZXIpOwogICAgICB2YXIgaXNBbGxvd2VkID0gcmVzcG9uc2Uud2hpdGVsaXN0ZWRPcmlnaW5zLnNvbWUoZnVuY3Rpb24gKG9yaWdpbikgewogICAgICAgIHJldHVybiB0b3BEb21haW4gPT09IHNhbml0aXplRG9tYWluKG9yaWdpbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gaXNBbGxvd2VkID8gUHJvbWlzZS5yZXNvbHZlKCkgOiBQcm9taXNlLnJlamVjdCgpOwogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGlzIHdpbmRvdydzIGhyZWYgaXMgb24gdGhlIGxlZ2FjeSBjb25uZWN0IGRvbWFpbi4gCiAgICogT25seSB1c2VmdWwgZm9yIGludGVybmFsIHVzZS4gCiAgICovCiAgY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluID0gZnVuY3Rpb24odXJsKSB7CiAgICB1cmwgPSB1cmwgfHwgd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gdXJsLmluY2x1ZGVzKCcuYXdzYXBwcy5jb20nKTsKICB9CiAKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgY3JlYXRpbmcgb3IgY29ubmVjdGluZyB0byB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICogVXNlZCBvbmx5IGJ5IHRoZSBDQ1AKICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdFNoYXJlZFdvcmtlciA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkKCk7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKIAogICAgdmFyIHNoYXJlZFdvcmtlclVybCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuc2hhcmVkV29ya2VyVXJsLCAncGFyYW1zLnNoYXJlZFdvcmtlclVybCcpOwogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIHJlZnJlc2hUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVmcmVzaFRva2VuLCAncGFyYW1zLnJlZnJlc2hUb2tlbicpOwogICAgdmFyIGF1dGhUb2tlbkV4cGlyYXRpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24sICdwYXJhbXMuYXV0aFRva2VuRXhwaXJhdGlvbicpOwogICAgdmFyIHJlZ2lvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVnaW9uLCAncGFyYW1zLnJlZ2lvbicpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLmVuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgYXV0aG9yaXplRW5kcG9pbnQgPSBwYXJhbXMuYXV0aG9yaXplRW5kcG9pbnQ7CiAgICBpZiAoIWF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICAgIGF1dGhvcml6ZUVuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkKICAgICAgICA/IExFR0FDWV9BVVRIT1JJWkVfRU5EUE9JTlQKICAgICAgICA6IEFVVEhPUklaRV9FTkRQT0lOVDsKICAgIH0KICAgIHZhciBhZ2VudEFwcEVuZHBvaW50ID0gcGFyYW1zLmFnZW50QXBwRW5kcG9pbnQgfHwgbnVsbDsKICAgIHZhciB0YXNrVGVtcGxhdGVzRW5kcG9pbnQgPSBwYXJhbXMudGFza1RlbXBsYXRlc0VuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgYXV0aENvb2tpZU5hbWUgPSBwYXJhbXMuYXV0aENvb2tpZU5hbWUgfHwgbnVsbDsKIAogICAgdHJ5IHsKICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXZlbnQgYnVzIGFuZCBhZ2VudCBkYXRhIHByb3ZpZGVycy4KICAgICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IHRydWUgfSk7CiAgICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKICAgICAgCiAgICAgIC8vIENyZWF0ZSB0aGUgc2hhcmVkIHdvcmtlciBhbmQgdXBzdHJlYW0gY29uZHVpdC4KICAgICAgdmFyIHdvcmtlciA9IG5ldyBTaGFyZWRXb3JrZXIoc2hhcmVkV29ya2VyVXJsLCAiQ29ubmVjdFNoYXJlZFdvcmtlciIpOwogICAgICB2YXIgY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkNvbm5lY3RTaGFyZWRXb3JrZXJDb25kdWl0IiwKICAgICAgICBuZXcgY29ubmVjdC5Qb3J0U3RyZWFtKHdvcmtlci5wb3J0KSwKICAgICAgICBuZXcgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSh3aW5kb3csIHBhcmVudCkpOwogCiAgICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gY29uZHVpdDsKICAgICAgY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyID0gbmV3IFdlYlNvY2tldFByb3ZpZGVyKCk7CiAKICAgICAgLy8gQ2xvc2Ugb3VyIHBvcnQgdG8gdGhlIHNoYXJlZCB3b3JrZXIgYmVmb3JlIHRoZSB3aW5kb3cgY2xvc2VzLgogICAgICBnbG9iYWwub251bmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ0xPU0UpOwogICAgICAgIHdvcmtlci5wb3J0LmNsb3NlKCk7CiAgICAgIH07CiAKICAgICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtTG9nUHVzaChjb25kdWl0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZURvd25zdHJlYW1DbGllbnRTaWRlTG9nc1B1c2goKTsKICAgICAgLy8gQnJpZGdlIGFsbCB1cHN0cmVhbSBtZXNzYWdlcyBpbnRvIHRoZSBldmVudCBidXMuCiAgICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAgICAgIC8vIFBhc3MgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIChmcm9tIHNoYXJlZCB3b3JrZXIpIGRvd25zdHJlYW0gKHRvIENDUCBjb25zdW1lcikuCiAgICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25kdWl0LnBhc3NEb3duc3RyZWFtKCkpOwoKICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAgIC8vIEJyaWRnZSBhbGwgZG93bnN0cmVhbSBtZXNzYWdlcyBpbnRvIHRoZSBldmVudCBidXMuCiAgICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogICAgICAgIC8vIFBhc3MgYWxsIGRvd25zdHJlYW0gbWVzc2FnZXMgKGZyb20gQ0NQIGNvbnN1bWVyKSB1cHN0cmVhbSAodG8gc2hhcmVkIHdvcmtlcikuCiAgICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAgICAgIH0KCiAgICAgIC8vIFNlbmQgY29uZmlndXJhdGlvbiB1cCB0byB0aGUgc2hhcmVkIHdvcmtlci4KICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCB7CiAgICAgICAgYXV0aFRva2VuOiBhdXRoVG9rZW4sCiAgICAgICAgYXV0aFRva2VuRXhwaXJhdGlvbjogYXV0aFRva2VuRXhwaXJhdGlvbiwKICAgICAgICBlbmRwb2ludDogZW5kcG9pbnQsCiAgICAgICAgcmVmcmVzaFRva2VuOiByZWZyZXNoVG9rZW4sCiAgICAgICAgcmVnaW9uOiByZWdpb24sCiAgICAgICAgYXV0aG9yaXplRW5kcG9pbnQ6IGF1dGhvcml6ZUVuZHBvaW50LAogICAgICAgIGFnZW50QXBwRW5kcG9pbnQ6IGFnZW50QXBwRW5kcG9pbnQsCiAgICAgICAgdGFza1RlbXBsYXRlc0VuZHBvaW50OiB0YXNrVGVtcGxhdGVzRW5kcG9pbnQsCiAgICAgICAgYXV0aENvb2tpZU5hbWU6IGF1dGhDb29raWVOYW1lLAogICAgICAgIGxvbmdQb2xsaW5nT3B0aW9uczogcGFyYW1zLmxvbmdQb2xsaW5nT3B0aW9ucyB8fCB1bmRlZmluZWQKICAgICAgfSk7CiAKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQWNrbm93bGVkZ2VkIGJ5IHRoZSBDb25uZWN0U2hhcmVkV29ya2VyISIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICBjb25uZWN0LmNvcmUuX3NldFRhYklkKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLnBvcnRTdHJlYW1JZCA9IGRhdGEuaWQ7CiAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICB9KTsKICAgICAgLy8gQWRkIGFsbCB1cHN0cmVhbSBsb2cgZW50cmllcyB0byBvdXIgb3duIGxvZ2dlci4KICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgICAgaWYgKGxvZ0VudHJ5LmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy8gR2V0IHdvcmtlciBsb2dzCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLnNlbmRJbnRlcm5hbExvZ0VudHJ5VG9TZXJ2ZXIoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgIH0pOwogICAgICAvLyBHZXQgb3V0ZXIgY29udGV4dCBsb2dzCiAgICAgIGNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIGZ1bmN0aW9uIChsb2dzKSB7CiAgICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiBBcnJheS5pc0FycmF5KGxvZ3MpKSB7CiAgICAgICAgICBsb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLnNlbmRJbnRlcm5hbExvZ0VudHJ5VG9TZXJ2ZXIoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZykpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy8gR2V0IGxvZyBmcm9tIG91dGVyIGNvbnRleHQKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nKSB7CiAgICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiBsb2cubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgeyAKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZykpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBjb25uZWN0LmNvcmUub25BdXRoRmFpbChjb25uZWN0LmhpdGNoKGNvbm5lY3QuY29yZSwgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRoRmFpbCwgcGFyYW1zLmxvZ2luRW5kcG9pbnQgfHwgbnVsbCwgYXV0aG9yaXplRW5kcG9pbnQpKTsgLy8gRm9yIGF1dGggcmV0cnkgbG9naWMgb24gNDAxcy4KICAgICAgY29ubmVjdC5jb3JlLm9uQXV0aG9yaXplU3VjY2Vzcyhjb25uZWN0LmhpdGNoKGNvbm5lY3QuY29yZSwgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVTdWNjZXNzKSk7IC8vIEZvciBhdXRoIHJldHJ5IGxvZ2ljIG9uIDQwMXMuCgogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlVzZXIgQWdlbnQ6ICIgKyBuYXZpZ2F0b3IudXNlckFnZW50KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImlzQ0NQdjI6ICIgKyB0cnVlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImlzRnJhbWVkOiAiICsgY29ubmVjdC5pc0ZyYW1lZCgpKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0ub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk9VVEVSX0NPTlRFWFRfSU5GTywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgc3RyZWFtc1ZlcnNpb24gPSBkYXRhLnN0cmVhbXNWZXJzaW9uOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiU3RyZWFtc0pTIFZlcnNpb246ICIgKyBzdHJlYW1zVmVyc2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiTnVtYmVyIG9mIGNvbm5lY3RlZCBDQ1BzIHVwZGF0ZWQ6ICIgKyBkYXRhLmxlbmd0aCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA9IGRhdGEubGVuZ3RoOwogICAgICAgIGlmIChkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0gJiYgIWlzTmFOKGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXS5sZW5ndGgpKXsKICAgICAgICAgIGlmIChjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiAhPT0gZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdLmxlbmd0aCkgewogICAgICAgICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiA9IGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXS5sZW5ndGg7CiAgICAgICAgICAgIGlmIChjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiA+IDEpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoZXJlIGFyZSAiICsgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgKyAiIGNvbm5lY3RlZCBDQ1BzIGluIHRoaXMgdGFiLiBQbGVhc2UgYWRqdXN0IHlvdXIgaW1wbGVtZW50YXRpb24gdG8gYXZvaWQgY29tcGxpY2F0aW9ucy4gSWYgeW91IGFyZSBlbWJlZGRpbmcgQ0NQLCBwbGVhc2UgZG8gc28gZXhjbHVzaXZlbHkgd2l0aCBpbml0Q0NQLiBJbml0Q0NQIHdpbGwgbm90IGxldCB5b3UgZW1iZWQgbW9yZSB0aGFuIG9uZSBDQ1AuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICAgIG5hbWU6IENPTk5FQ1RFRF9DQ1BTX1NJTkdMRV9UQUIsCiAgICAgICAgICAgICAgZGF0YTogeyBjb3VudDogY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWJ9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGF0YS50YWJJZCAmJiBkYXRhLnN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlcikgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5NRVRSSUNTLCAoKSA9PgogICAgICAgICAgICBjb25uZWN0LmFnZW50KCgpID0+IGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgICAgbmFtZTogQ0NQX1RBQlNfQUNST1NTX0JST1dTRVJfQ09VTlQsCiAgICAgICAgICAgICAgZGF0YTogeyB0YWJJZDogZGF0YS50YWJJZCwgY291bnQ6IGRhdGEuc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyIH0KICAgICAgICAgICAgfSkpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogCiAgICAgIC8vIFBhc3MgdGhlIFRFUk1JTkFURSByZXF1ZXN0IHVwc3RyZWFtIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFLAogICAgICAgIGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogCiAgICAgIC8vIFJlZnJlc2ggdGhlIHBhZ2Ugd2hlbiB3ZSByZWNlaXZlIHRoZSBURVJNSU5BVEVEIHJlc3BvbnNlIGZyb20gdGhlCiAgICAgIC8vIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVELCBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCh0cnVlKTsKICAgICAgfSk7CiAKICAgICAgd29ya2VyLnBvcnQuc3RhcnQoKTsKCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LlZvaWNlSWRFdmVudHMuVVBEQVRFX0RPTUFJTl9JRCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmRvbWFpbklkKSB7CiAgICAgICAgICBjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkID0gZGF0YS5kb21haW5JZDsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gdHJ5IGZldGNoaW5nIHZvaWNlSWQncyBkb21haW5JZCBvbmNlIHRoZSBhZ2VudCBpcyBpbml0aWFsaXplZAogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdm9pY2VJZCA9IG5ldyBjb25uZWN0LlZvaWNlSWQoKTsKICAgICAgICB2b2ljZUlkLmdldERvbWFpbklkKCkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidm9pY2VJZCBkb21haW5JZCBzdWNjZXNzZnVsbHkgZmV0Y2hlZCBhdCBhZ2VudCBpbml0aWFsaXphdGlvbjogIiArIGRvbWFpbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJ2b2ljZUlkIGRvbWFpbklkIG5vdCBmZXRjaGVkIGF0IGFnZW50IGluaXRpYWxpemF0aW9uIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9KTsKICAgICAgfSk7CiAKICAgICAgLy8gQXR0ZW1wdCB0byBnZXQgcGVybWlzc2lvbiB0byBzaG93IG5vdGlmaWNhdGlvbnMuCiAgICAgIHZhciBubSA9IGNvbm5lY3QuY29yZS5nZXROb3RpZmljYXRpb25NYW5hZ2VyKCk7CiAgICAgIG5tLnJlcXVlc3RQZXJtaXNzaW9uKCk7CgogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5KHBhcmFtcyk7CiAgICAgIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBpbml0aWFsaXplIHRoZSBBUEkgc2hhcmVkIHdvcmtlciwgd2UncmUgZGVhZCEiKQogICAgICAgIC53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb3JlLl9zZXRUYWJJZCA9IGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgY29ubmVjdC5jb3JlLnRhYklkID0gd2luZG93LnNlc3Npb25TdG9yYWdlLmdldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuVEFCX0lEKTsKICAgICAgaWYgKCFjb25uZWN0LmNvcmUudGFiSWQpewogICAgICAgIGNvbm5lY3QuY29yZS50YWJJZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5UQUJfSUQsIGNvbm5lY3QuY29yZS50YWJJZCk7CiAgICAgIH0KICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5UQUJfSUQsIHt0YWJJZDogY29ubmVjdC5jb3JlLnRhYklkfSk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiW1RhYiBJZF0gVGhlcmUgd2FzIGFuIGlzc3VlIHNldHRpbmcgdGhlIHRhYiBJZCIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZXMgQ29ubmVjdCBieSBjcmVhdGluZyBvciBjb25uZWN0aW5nIHRvIHRoZSBBUEkgU2hhcmVkIFdvcmtlci4KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGxvYWRpbmcgdGhlIENDUCBpbiBhbiBpZnJhbWUgYW5kIGNvbm5lY3RpbmcgdG8gaXQuCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRDQ1AgPSBmdW5jdGlvbiAoY29udGFpbmVyRGl2LCBwYXJhbXNJbikgewogICAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQoKTsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJJZnJhbWUgaW5pdGlhbGl6YXRpb24gc3RhcnRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgaW5pdFN0YXJ0VGltZSA9IERhdGUubm93KCk7CiAgICAvLyBDaGVjayBpZiBDQ1AgaWZyYW1lIGhhcyBhbHJlYWR5IGJlZW4gaW5pdGlhbGl6ZWQgdGhyb3VnaCBpbml0Q0NQCiAgICB0cnkgewogICAgICBpZiAoY29ubmVjdC5jb3JlLl9nZXRDQ1BJZnJhbWUoKSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignQXR0ZW1wdGVkIHRvIGNhbGwgaW5pdENDUCB3aGVuIGFuIGlmcmFtZSBnZW5lcmF0ZWQgYnkgaW5pdENDUCBhbHJlYWR5IGV4aXN0cycpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoJ0Vycm9yIHdoaWxlIGNoZWNraW5nIGlmIGluaXRDQ1AgaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQnKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAKICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgd2hlbiBpbnN0ZWFkIG9mIHRha2luZyBhIHBhcmFtcyBvYmplY3QKICAgIC8vIGFzIGlucHV0IHdlIG9ubHkgYWNjZXB0ZWQgY2NwVXJsLgogICAgdmFyIHBhcmFtcyA9IHt9OwogICAgaWYgKHR5cGVvZiAocGFyYW1zSW4pID09PSAnc3RyaW5nJykgewogICAgICBwYXJhbXMuY2NwVXJsID0gcGFyYW1zSW47CiAgICB9IGVsc2UgewogICAgICBwYXJhbXMgPSBwYXJhbXNJbjsKICAgIH0KIAogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5jY3BVcmwsICdwYXJhbXMuY2NwVXJsJyk7CgogICAgLy8gQ2xlYW4gdXAgdGhlIFNvZnRwaG9uZSBwYXJhbXMgc3RvcmUgdG8gbWFrZSBzdXJlIHdlIGFsd2F5cyBwdWxsIHRoZSBsYXRlc3QgcGFyYW1zCiAgICBzb2Z0cGhvbmVQYXJhbXNTdG9yYWdlLmNsZWFuKCk7CiAKICAgIC8vIENyZWF0ZSB0aGUgQ0NQIGlmcmFtZSBhbmQgYXBwZW5kIGl0IHRvIHRoZSBjb250YWluZXIgZGl2LgogICAgdmFyIGlmcmFtZSA9IGNvbm5lY3QuY29yZS5fY3JlYXRlQ0NQSWZyYW1lKGNvbnRhaW5lckRpdiwgcGFyYW1zKTsKCiAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgLy8gTk9URTogU2V0dGluZyBsb2dFdmVudHMgaGVyZSB0byBGQUxTRSBpbiBvcmRlciB0byBhdm9pZCBkdXBsaWNhdGluZwogICAgLy8gZXZlbnRzIHdoaWNoIGFyZSBsb2dnZWQgaW4gQ0NQLgogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IGZhbHNlIH0pOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKIAogICAgLy8gQnVpbGQgdGhlIHVwc3RyZWFtIGNvbmR1aXQgY29tbXVuaWNhdGluZyB3aXRoIHRoZSBDQ1AgaWZyYW1lLgogICAgdmFyIGNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KHBhcmFtcy5jY3BVcmwsIHdpbmRvdywgaWZyYW1lKTsKIAogICAgLy8gTGV0IENDUCBrbm93IGlmIGlmcmFtZSBpcyB2aXNpYmxlCiAgICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lKGlmcmFtZSwgY29uZHVpdCk7CiAKICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IGNvbmR1aXQ7CiAKICAgIC8vIEluaXQgd2ViU29ja2V0UHJvdmlkZXIKICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogCiAgICAvLyBJbml0aWFsaXplIHRoZSBrZWVwYWxpdmUgbWFuYWdlci4KICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyID0gbmV3IEtlZXBhbGl2ZU1hbmFnZXIoY29uZHVpdCwKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCksCiAgICAgIHBhcmFtcy5jY3BTeW5UaW1lb3V0IHx8IENDUF9TWU5fVElNRU9VVCwKICAgICAgcGFyYW1zLmNjcEFja1RpbWVvdXQgfHwgQ0NQX0FDS19USU1FT1VUKQogICAgICA7CiAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPSBudWxsOwogCiAgICAvLyBBbGxvdyA1IHNlYyAoZGVmYXVsdCkgYmVmb3JlIHJlY2VpdmluZyB0aGUgZmlyc3QgQUNLIGZyb20gdGhlIENDUC4KICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNDUCBMb2FkVGltZW91dCB0cmlnZ2VyZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfSwgcGFyYW1zLmNjcExvYWRUaW1lb3V0IHx8IENDUF9MT0FEX1RJTUVPVVQpOwoKICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUExvZ3NQdXNoKGNvbmR1aXQpOwogICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzUHVzaChjb25kdWl0KTsKIAogICAgLy8gT25jZSB3ZSByZWNlaXZlIHRoZSBmaXJzdCBBQ0ssIHNldHVwIG91ciB1cHN0cmVhbSBBUEkgY2xpZW50IGFuZCBlc3RhYmxpc2gKICAgIC8vIHRoZSBTWU4vQUNLIHJlZnJlc2ggZmxvdy4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENDUCEiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkID0gZGF0YS5pZDsKCiAgICAgIGlmIChwYXJhbXMuc29mdHBob25lIHx8IHBhcmFtcy5jaGF0IHx8IHBhcmFtcy5wYWdlT3B0aW9ucyB8fCBwYXJhbXMuc2hvdWxkQWRkTmFtZXNwYWNlVG9Mb2dzKSB7CiAgICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBDQ1AuCiAgICAgICAgLy9zZXQgaXQgdG8gZmFsc2UgaWYgc2Vjb25kYXJ5CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCB7CiAgICAgICAgICBzb2Z0cGhvbmU6IHBhcmFtcy5zb2Z0cGhvbmUsCiAgICAgICAgICBjaGF0OiBwYXJhbXMuY2hhdCwKICAgICAgICAgIHBhZ2VPcHRpb25zOiBwYXJhbXMucGFnZU9wdGlvbnMsCiAgICAgICAgICBzaG91bGRBZGROYW1lc3BhY2VUb0xvZ3M6IHBhcmFtcy5zaG91bGRBZGROYW1lc3BhY2VUb0xvZ3MsCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIC8vIElmIERSIGVuYWJsZWQsIHNldCB0aGlzIENDUCBpbnN0YW5jZSBhcyBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQKICAgICAgaWYgKHBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pIHsKICAgICAgICBjb25uZWN0LmNvcmUucmVnaW9uID0gcGFyYW1zLnJlZ2lvbjsKICAgICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7CiAgICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FKTsKICAgICAgICB9ICAgICAgIAogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5JTklUX0RJU0FTVEVSX1JFQ09WRVJZLCBwYXJhbXMpOwogICAgICB9CiAKICAgICAgaWYgKGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICB9CgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5PVVRFUl9DT05URVhUX0lORk8sIHsgc3RyZWFtc1ZlcnNpb246IGNvbm5lY3QudmVyc2lvbiB9KTsKIAogICAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlci5zdGFydCgpOwogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CgogICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLklOSVQpOwogICAgICBpZiAoaW5pdFN0YXJ0VGltZSkgewogICAgICAgIHZhciBpbml0VGltZSA9IERhdGUubm93KCkgLSBpbml0U3RhcnRUaW1lOwogICAgICAgIHZhciByZWZyZXNoQXR0ZW1wdHMgPSBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgfHwgMDsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oJ0lmcmFtZSBpbml0aWFsaXphdGlvbiBzdWNjZWVkZWQnKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgSWZyYW1lIGluaXRpYWxpemF0aW9uIHRpbWUgJHtpbml0VGltZX1gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgSWZyYW1lIHJlZnJlc2ggYXR0ZW1wdHMgJHtyZWZyZXNoQXR0ZW1wdHN9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfUkVGUkVTSF9BVFRFTVBUUywKICAgICAgICAgICAgZGF0YTogeyBjb3VudDogcmVmcmVzaEF0dGVtcHRzfSAKICAgICAgICAgIH0pOwogICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9TVUNDRVNTLAogICAgICAgICAgICBkYXRhOiB7IGNvdW50OiAxfSAKICAgICAgICAgIH0pOwogICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9USU1FLAogICAgICAgICAgICBkYXRhOiB7IGNvdW50OiBpbml0VGltZX0gCiAgICAgICAgICB9KTsKICAgICAgICAgIC8vdG8gYXZvaWQgbWV0cmljIGVtaXNzaW9uIGFmdGVyIGluaXRpYWxpemF0aW9uCiAgICAgICAgICBpbml0U3RhcnRUaW1lID0gbnVsbDsKICAgICAgICB9LDEwMDApCiAgICAgIH0KICAgIH0pOwogCiAgICAvLyBBZGQgYW55IGxvZ3MgZnJvbSB0aGUgdXBzdHJlYW0gdG8gb3VyIG93biBsb2dnZXIuCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgaWYgKGxvZ0VudHJ5LmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICB9CiAgICB9KTsKIAogICAgLy8gUG9wIGEgbG9naW4gcGFnZSB3aGVuIHdlIGVuY291bnRlciBhbiBBQ0sgdGltZW91dC4KICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCwgZnVuY3Rpb24gKCkgewogICAgICAvLyBsb2dpblBvcHVwIGlzIHRydWUgYnkgZGVmYXVsdCwgb25seSBmYWxzZSBpZiBleHBsaWNpdGx5IHNldCB0byBmYWxzZS4KICAgICAgaWYgKHBhcmFtcy5sb2dpblBvcHVwICE9PSBmYWxzZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbG9naW5VcmwgPSBnZXRMb2dpblVybChwYXJhbXMpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJBQ0tfVElNRU9VVCBvY2N1cnJlZCwgYXR0ZW1wdGluZyB0byBwb3AgdGhlIGxvZ2luIHBhZ2UgaWYgbm90IGFscmVhZHkgb3Blbi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgLy8gY2xlYXIgb3V0IGxhc3Qgb3BlbmVkIHRpbWVzdGFtcCBmb3IgU0FNTCBhdXRoZW50aWNhdGlvbiB3aGVuIHRoZXJlIGlzIEFDS19USU1FT1VUCiAgICAgICAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkub3Blbihsb2dpblVybCwgY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVAsIHBhcmFtcy5sb2dpbk9wdGlvbnMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkFDS19USU1FT1VUIG9jY3VycmVkIGJ1dCB3ZSBhcmUgdW5hYmxlIHRvIG9wZW4gdGhlIGxvZ2luIHBvcHVwLiIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPT0gbnVsbCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCk7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICAgIGlmICgocGFyYW1zLmxvZ2luUG9wdXBBdXRvQ2xvc2UgfHwgKHBhcmFtcy5sb2dpbk9wdGlvbnMgJiYgcGFyYW1zLmxvZ2luT3B0aW9ucy5hdXRvQ2xvc2UpKSAmJiBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cuY2xvc2UoKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbm5lY3QuY29yZS5fcmVmcmVzaElmcmFtZU9uVGltZW91dChwYXJhbXMsIGNvbnRhaW5lckRpdik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRXJyb3Igb2NjdXJyZWQgd2hpbGUgcmVmcmVzaGluZyBpZnJhbWUiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKIAogICAgaWYgKHBhcmFtcy5vblZpZXdDb250YWN0KSB7CiAgICAgIGNvbm5lY3QuY29yZS5vblZpZXdDb250YWN0KHBhcmFtcy5vblZpZXdDb250YWN0KTsKICAgIH0KCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA9IGRhdGEubGVuZ3RoOwogICAgfSk7CgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAoZGF0YSAmJiBkYXRhLmRvbWFpbklkKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCA9IGRhdGEuZG9tYWluSWQ7CiAgICAgIH0KICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfUkVUUklFU19FWEhBVVNURUQsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGluaXRTdGFydFRpbWUpIHsKICAgICAgICB2YXIgcmVmcmVzaEF0dGVtcHRzID0gY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IC0gMTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oJ0lmcmFtZSBpbml0aWFsaXphdGlvbiBmYWlsZWQnKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgVGltZSBhZnRlciBpZnJhbWUgaW5pdGlhbGl6YXRpb24gc3RhcnRlZCAke0RhdGUubm93KCkgLSBpbml0U3RhcnRUaW1lfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBJZnJhbWUgcmVmcmVzaCBhdHRlbXB0cyAke3JlZnJlc2hBdHRlbXB0c31gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX1JFRlJFU0hfQVRURU1QVFMsCiAgICAgICAgICBkYXRhOiB7IGNvdW50OiByZWZyZXNoQXR0ZW1wdHN9CiAgICAgICAgfSk7CiAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUywKICAgICAgICAgIGRhdGE6IHsgY291bnQ6IDB9CiAgICAgICAgfSk7CiAgICAgICAgaW5pdFN0YXJ0VGltZSA9IG51bGw7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIGtlZXAgdGhlIHNvZnRwaG9uZSBwYXJhbXMgZm9yIGV4dGVybmFsIHVzZQogICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyA9IHBhcmFtcy5zb2Z0cGhvbmU7CiAgfTsKCiAgY29ubmVjdC5jb3JlLm9uSWZyYW1lUmV0cmllc0V4aGF1c3RlZCA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfUkVUUklFU19FWEhBVVNURUQsIGYpOwogIH0KCiAgY29ubmVjdC5jb3JlLl9yZWZyZXNoSWZyYW1lT25UaW1lb3V0ID0gZnVuY3Rpb24oaW5pdENDUFBhcmFtcywgY29udGFpbmVyRGl2KSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaW5pdENDUFBhcmFtcywgJ2luaXRDQ1BQYXJhbXMnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWluZXJEaXYsICdjb250YWluZXJEaXYnKTsKICAgIHZhciBjY3BJZnJhbWVSZWZyZXNoSW50ZXJ2YWwgPSAoaW5pdENDUFBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pID8gQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMIDogQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMOwogICAgdmFyIHJldHJ5RGVsYXkgPSBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgLSAxIHx8IDApLCB7IGJhc2U6IDIwMDAgfSk7CiAgICAvLyBFdmFsdWF0ZXMgdG8gMCBmb3IgMHRoIGF0dGVtcHQgYW5kIDEgZm9yIHJlc3QgKD4wKSBvZiB0aGUgcmVmcmVzaCBhdHRlbXB0cwogICAgdmFyIHRpbWVvdXRGYWN0b3IgPSBNYXRoLmNlaWwoKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCB8fCAwKSAvIENDUF9JRlJBTUVfUkVGUkVTSF9MSU1JVCk7CiAgICB2YXIgdGltZW91dCA9IChjY3BJZnJhbWVSZWZyZXNoSW50ZXJ2YWwgKyByZXRyeURlbGF5KSAqIHRpbWVvdXRGYWN0b3I7CiAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCk7CiAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0ID0gKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCB8fCAwKSArIDE7CiAgICAgIGlmIChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgPD0gQ0NQX0lGUkFNRV9SRUZSRVNIX0xJTUlUKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBpZnJhbWUgPSBjb25uZWN0LmNvcmUuX2dldENDUElmcmFtZSgpOwogICAgICAgICAgaWYgKGlmcmFtZSkgewogICAgICAgICAgICBpZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChpZnJhbWUpOyAvLyBUaGUgb25seSB3YXkgdG8gZm9yY2UgYSBzeW5jaHJvbm91cyByZWxvYWQgb2YgdGhlIGlmcmFtZSB3aXRob3V0IHRoZSBvbGQgaWZyYW1lIGNvbnRpbnVpbmcgdG8gZnVuY3Rpb24gaXMgdG8gcmVtb3ZlIHRoZSBvbGQgaWZyYW1lIGVudGlyZWx5LgogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0lmcmFtZSA9IGNvbm5lY3QuY29yZS5fY3JlYXRlQ0NQSWZyYW1lKGNvbnRhaW5lckRpdiwgaW5pdENDUFBhcmFtcyk7CiAgICAgICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0udXBzdHJlYW0ub3V0cHV0ID0gbmV3SWZyYW1lLmNvbnRlbnRXaW5kb3c7IC8vcmVwbGFjZXMgdGhlIG91dHB1dCB3aW5kb3cgKG9sZCBpZnJhbWUncyBjb250ZW50V2luZG93KSBvZiB0aGUgV2luZG93SU9TdHJlYW0gKHdpdGhpbiB0aGUgSUZyYW1lQ29uZHVpdCkgd2l0aCB0aGUgbmV3IGlmcmFtZSdzIGNvbnRlbnRXaW5kb3cuCiAgICAgICAgICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lKG5ld0lmcmFtZSwgY29ubmVjdC5jb3JlLnVwc3RyZWFtKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoJ0Vycm9yIHdoaWxlIGNoZWNraW5nIGZvciwgYW5kIHJlY3JlYXRpbmcsIHRoZSBDQ1AgSUZyYW1lJykud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgICBjb25uZWN0LmNvcmUuX3JlZnJlc2hJZnJhbWVPblRpbWVvdXQoaW5pdENDUFBhcmFtcywgY29udGFpbmVyRGl2KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9SRVRSSUVTX0VYSEFVU1RFRCk7CiAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQpOwogICAgICB9CiAgICB9LCB0aW1lb3V0KTsKICB9CgoKICBjb25uZWN0LmNvcmUuX2dldENDUElmcmFtZSA9IGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgaWZyYW1lIG9mIHdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaWZyYW1lJykpIHsKICAgICAgaWYgKGlmcmFtZS5uYW1lID09PSBDQ1BfSUZSQU1FX05BTUUpIHsKICAgICAgICByZXR1cm4gaWZyYW1lOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIGNvbm5lY3QuY29yZS5fY3JlYXRlQ0NQSWZyYW1lID0gZnVuY3Rpb24oY29udGFpbmVyRGl2LCBpbml0Q0NQUGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaW5pdENDUFBhcmFtcywgJ2luaXRDQ1BQYXJhbXMnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWluZXJEaXYsICdjb250YWluZXJEaXYnKTsKICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgIGlmcmFtZS5zcmMgPSBpbml0Q0NQUGFyYW1zLmNjcFVybDsKICAgIGlmcmFtZS5hbGxvdyA9ICJtaWNyb3Bob25lOyBhdXRvcGxheSI7CiAgICBpZnJhbWUuc3R5bGUgPSBpbml0Q0NQUGFyYW1zLnN0eWxlIHx8ICJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlIjsKICAgIGlmcmFtZS50aXRsZSA9IGluaXRDQ1BQYXJhbXMuaWZyYW1lVGl0bGUgfHwgQ0NQX0lGUkFNRV9OQU1FOwogICAgaWZyYW1lLm5hbWUgPSBDQ1BfSUZSQU1FX05BTUU7CiAgICBjb250YWluZXJEaXYuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgIHJldHVybiBpZnJhbWU7CiAgfQoKICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lID0gZnVuY3Rpb24oaWZyYW1lLCBjb25kdWl0KSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWZyYW1lLCAnaWZyYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29uZHVpdCwgJ2NvbmR1aXQnKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGlmcmFtZSwgbnVsbCk7CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIGRpc3BsYXk6IHN0eWxlLmRpc3BsYXksCiAgICAgICAgb2Zmc2V0V2lkdGg6IGlmcmFtZS5vZmZzZXRXaWR0aCwKICAgICAgICBvZmZzZXRIZWlnaHQ6IGlmcmFtZS5vZmZzZXRIZWlnaHQsCiAgICAgICAgY2xpZW50UmVjdHNMZW5ndGg6IGlmcmFtZS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aAogICAgICB9OwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfU1RZTEUsIGRhdGEpOwogICAgfSwgMTAwMDApOwogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgS2VlcGFsaXZlTWFuYWdlciA9IGZ1bmN0aW9uIChjb25kdWl0LCBldmVudEJ1cywgc3luVGltZW91dCwgYWNrVGltZW91dCkgewogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMuc3luVGltZW91dCA9IHN5blRpbWVvdXQ7CiAgICB0aGlzLmFja1RpbWVvdXQgPSBhY2tUaW1lb3V0OwogICAgdGhpcy5hY2tUaW1lciA9IG51bGw7CiAgICB0aGlzLnN5blRpbWVyID0gbnVsbDsKICAgIHRoaXMuYWNrU3ViID0gbnVsbDsKICB9OwogCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAKICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUpOwogICAgdGhpcy5hY2tTdWIgPSB0aGlzLmNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoc2VsZi5hY2tUaW1lcik7CiAgICAgIHNlbGYuX2RlZmVyU3RhcnQoKTsKICAgIH0pOwogICAgdGhpcy5hY2tUaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5hY2tTdWIudW5zdWJzY3JpYmUoKTsKICAgICAgc2VsZi5ldmVudEJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VUKTsKICAgICAgc2VsZi5fZGVmZXJTdGFydCgpOwogICAgfSwgdGhpcy5hY2tUaW1lb3V0KTsKICB9OwogCiAgLy9GaXhlcyB0aGUga2VlcGFsaXZlbWFuYWdlci4KICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5fZGVmZXJTdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3luVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuc3RhcnQpLCB0aGlzLnN5blRpbWVvdXQpOwogIH07CgogIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBvbmx5LCBpbiBjYXNlIGN1c3RvbWVycyBhcmUgdXNpbmcgdGhpcyB0byBzdGFydCB0aGUga2VlcGFsaXZlbWFuYWdlciBmb3Igc29tZSByZWFzb24uCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuZGVmZXJTdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLnN5blRpbWVyID09IG51bGwpIHsKICAgICAgdGhpcy5zeW5UaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5zdGFydCksIHRoaXMuc3luVGltZW91dCk7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KIAogIHZhciBXZWJTb2NrZXRQcm92aWRlciA9IGZ1bmN0aW9uICgpIHsKIAogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaW5pdEZhaWx1cmU6IG5ldyBTZXQoKSwKICAgICAgc3Vic2NyaXB0aW9uVXBkYXRlOiBuZXcgU2V0KCksCiAgICAgIHN1YnNjcmlwdGlvbkZhaWx1cmU6IG5ldyBTZXQoKSwKICAgICAgdG9waWM6IG5ldyBNYXAoKSwKICAgICAgYWxsTWVzc2FnZTogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uR2FpbjogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uTG9zdDogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uT3BlbjogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uQ2xvc2U6IG5ldyBTZXQoKQogICAgfTsKIAogICAgdmFyIGludm9rZUNhbGxiYWNrcyA9IGZ1bmN0aW9uIChjYWxsYmFja3MsIHJlc3BvbnNlKSB7CiAgICAgIGNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKHJlc3BvbnNlKTsKICAgICAgfSk7CiAgICB9OwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSwgZnVuY3Rpb24gKCkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmluaXRGYWlsdXJlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9PUEVOLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uT3BlbiwgcmVzcG9uc2UpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UsIHJlc3BvbnNlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOLCBmdW5jdGlvbiAoKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4pOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0xPU1QsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fVVBEQVRFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9GQUlMVVJFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuYWxsTWVzc2FnZSwgcmVzcG9uc2UpOwogICAgICBpZiAoY2FsbGJhY2tzLnRvcGljLmhhcyhyZXNwb25zZS50b3BpYykpIHsKICAgICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnRvcGljLmdldChyZXNwb25zZS50b3BpYyksIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSk7CiAKICAgIHRoaXMuc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAod2ViU29ja2V0UGF5bG9hZCkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU0VORCwgd2ViU29ja2V0UGF5bG9hZCk7CiAgICB9OwogCiAgICB0aGlzLm9uSW5pdEZhaWx1cmUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5pbml0RmFpbHVyZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuaW5pdEZhaWx1cmUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25PcGVuID0gZnVuY3Rpb24oY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uT3Blbi5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4uZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25DbG9zZSA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25HYWluID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4uYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uQ29ubmVjdGlvbkxvc3QgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdC5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25TdWJzY3JpcHRpb25VcGRhdGUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vblN1YnNjcmlwdGlvbkZhaWx1cmUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLnN1YnNjcmliZVRvcGljcyA9IGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljcywgJ3RvcGljcycpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0FycmF5KHRvcGljcyksICd0b3BpY3MgbXVzdCBiZSBhIGFycmF5Jyk7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIHRvcGljcyk7CiAgICB9OwogCiAgICB0aGlzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uICh0b3BpY05hbWUsIGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpY05hbWUsICd0b3BpY05hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGlmIChjYWxsYmFja3MudG9waWMuaGFzKHRvcGljTmFtZSkpIHsKICAgICAgICBjYWxsYmFja3MudG9waWMuZ2V0KHRvcGljTmFtZSkuYWRkKGNiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MudG9waWMuc2V0KHRvcGljTmFtZSwgbmV3IFNldChbY2JdKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnRvcGljLmdldCh0b3BpY05hbWUpLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uQWxsTWVzc2FnZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmFsbE1lc3NhZ2UuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmFsbE1lc3NhZ2UuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBBZ2VudERhdGFQcm92aWRlciA9IGZ1bmN0aW9uIChidXMpIHsKICAgIHZhciBhZ2VudERhdGEgPSBudWxsOwogICAgdGhpcy5idXMgPSBidXM7CiAgICB0aGlzLmJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5VUERBVEUsIGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy51cGRhdGVBZ2VudERhdGEpKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLnVwZGF0ZUFnZW50RGF0YSA9IGZ1bmN0aW9uIChhZ2VudERhdGEpIHsKICAgIHZhciBvbGRBZ2VudERhdGEgPSB0aGlzLmFnZW50RGF0YTsKICAgIHRoaXMuYWdlbnREYXRhID0gYWdlbnREYXRhOwogCiAgICBpZiAob2xkQWdlbnREYXRhID09IG51bGwpIHsKICAgICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KIAogICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLlJFRlJFU0gsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogCiAgICB0aGlzLl9maXJlQWdlbnRVcGRhdGVFdmVudHMob2xkQWdlbnREYXRhKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEFnZW50RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmFnZW50RGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ05vIGFnZW50IGRhdGEgaXMgYXZhaWxhYmxlIHlldCEnKTsKICAgIH0KIAogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0Q29udGFjdERhdGEgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB2YXIgYWdlbnREYXRhID0gdGhpcy5nZXRBZ2VudERhdGEoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuZmluZChhZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjdGRhdGEpIHsKICAgICAgcmV0dXJuIGN0ZGF0YS5jb250YWN0SWQgPT09IGNvbnRhY3RJZDsKICAgIH0pOwogCiAgICBpZiAoY29udGFjdERhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdDb250YWN0ICVzIG5vIGxvbmdlciBleGlzdHMuJywgY29udGFjdElkKTsKICAgIH0KIAogICAgcmV0dXJuIGNvbnRhY3REYXRhOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbkRhdGEgPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHZhciBjb250YWN0RGF0YSA9IHRoaXMuZ2V0Q29udGFjdERhdGEoY29udGFjdElkKTsKICAgIHZhciBjb25uZWN0aW9uRGF0YSA9IGNvbm5lY3QuZmluZChjb250YWN0RGF0YS5jb25uZWN0aW9ucywgZnVuY3Rpb24gKGNkYXRhKSB7CiAgICAgIHJldHVybiBjZGF0YS5jb25uZWN0aW9uSWQgPT09IGNvbm5lY3Rpb25JZDsKICAgIH0pOwogCiAgICBpZiAoY29ubmVjdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdDb25uZWN0aW9uICVzIGZvciBjb250YWN0ICVzIG5vIGxvbmdlciBleGlzdHMuJywgY29ubmVjdGlvbklkLCBjb250YWN0SWQpOwogICAgfQogCiAgICByZXR1cm4gY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEluc3RhbmNlSWQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuZ2V0QWdlbnREYXRhKCkuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkLm1hdGNoKC9pbnN0YW5jZVwvKFswLTlhLWZBLUZ8LV0rKVwvLylbMV07CiAgfQoKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0QVdTQWNjb3VudElkID0gZnVuY3Rpb24oKXsKICAgIHJldHVybiB0aGlzLmdldEFnZW50RGF0YSgpLmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZC5tYXRjaCgvOihbMC05XSspOmluc3RhbmNlLylbMV07CiAgfQogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9kaWZmQ29udGFjdHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgZGlmZiA9IHsKICAgICAgYWRkZWQ6IHt9LAogICAgICByZW1vdmVkOiB7fSwKICAgICAgY29tbW9uOiB7fSwKICAgICAgb2xkTWFwOiBjb25uZWN0LmluZGV4KG9sZEFnZW50RGF0YSA9PSBudWxsID8gW10gOiBvbGRBZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSksCiAgICAgIG5ld01hcDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KQogICAgfTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYub2xkTWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgaWYgKGNvbm5lY3QuY29udGFpbnMoZGlmZi5uZXdNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmNvbW1vbltjb250YWN0SWRdID0gZGlmZi5uZXdNYXBbY29udGFjdElkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkaWZmLnJlbW92ZWRbY29udGFjdElkXSA9IGRpZmYub2xkTWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5uZXdNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoIWNvbm5lY3QuY29udGFpbnMoZGlmZi5vbGRNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmFkZGVkW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9CiAgICB9KTsKIAogICAgcmV0dXJuIGRpZmY7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUFnZW50VXBkYXRlRXZlbnRzID0gZnVuY3Rpb24gKG9sZEFnZW50RGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGRpZmYgPSBudWxsOwogICAgdmFyIG9sZEFnZW50U3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcy5JTklUIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgbmV3QWdlbnRTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgb2xkUm91dGluZ1N0YXRlID0gb2xkQWdlbnREYXRhID09IG51bGwgPyBjb25uZWN0LkFnZW50U3RhdGVUeXBlLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUudHlwZTsKICAgIHZhciBuZXdSb3V0aW5nU3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogCiAgICBpZiAob2xkUm91dGluZ1N0YXRlICE9PSBuZXdSb3V0aW5nU3RhdGUpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkUm91dGluZ1N0YXRlLCBuZXdSb3V0aW5nU3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQogCiAgICBpZiAob2xkQWdlbnRTdGF0ZSAhPT0gbmV3QWdlbnRTdGF0ZSkgewogICAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuU1RBVEVfQ0hBTkdFLCB7CiAgICAgICAgYWdlbnQ6IG5ldyBjb25uZWN0LkFnZW50KCksCiAgICAgICAgb2xkU3RhdGU6IG9sZEFnZW50U3RhdGUsCiAgICAgICAgbmV3U3RhdGU6IG5ld0FnZW50U3RhdGUKIAogICAgICB9KTsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50U3RhdGVFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZEFnZW50U3RhdGUsIG5ld0FnZW50U3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQoKICAgIHZhciBvbGROZXh0U3RhdGUgPSBvbGRBZ2VudERhdGEgJiYgb2xkQWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZSA/IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUubmFtZSA6IG51bGw7CiAgICB2YXIgbmV3TmV4dFN0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlID8gdGhpcy5hZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlLm5hbWUgOiBudWxsOwogICAgaWYgKG9sZE5leHRTdGF0ZSAhPT0gbmV3TmV4dFN0YXRlICYmIG5ld05leHRTdGF0ZSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuRU5RVUVVRURfTkVYVF9TVEFURSwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CgogICAgaWYgKG9sZEFnZW50RGF0YSAhPT0gbnVsbCkgewogICAgICBkaWZmID0gdGhpcy5fZGlmZkNvbnRhY3RzKG9sZEFnZW50RGF0YSk7CiAKICAgIH0gZWxzZSB7CiAgICAgIGRpZmYgPSB7CiAgICAgICAgYWRkZWQ6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSksCiAgICAgICAgcmVtb3ZlZDoge30sCiAgICAgICAgY29tbW9uOiB7fSwKICAgICAgICBvbGRNYXA6IHt9LAogICAgICAgIG5ld01hcDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KQogICAgICB9OwogICAgfQogCiAgICBjb25uZWN0LnZhbHVlcyhkaWZmLmFkZGVkKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTklULCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCkpOwogICAgICBzZWxmLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyhjb250YWN0RGF0YS5jb250YWN0SWQsIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTklULCBjb250YWN0RGF0YS5zdGF0ZS50eXBlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LnZhbHVlcyhkaWZmLnJlbW92ZWQpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCwgbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKSk7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCwgY29udGFjdERhdGEuY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKSk7CiAgICAgIHNlbGYuX3Vuc3ViQWxsQ29udGFjdEV2ZW50c0ZvckNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5jb21tb24pLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBzZWxmLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyhjb250YWN0SWQsIGRpZmYub2xkTWFwW2NvbnRhY3RJZF0uc3RhdGUudHlwZSwgZGlmZi5uZXdNYXBbY29udGFjdElkXS5zdGF0ZS50eXBlKTsKICAgIH0pOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgb2xkQ29udGFjdFN0YXRlLCBuZXdDb250YWN0U3RhdGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChvbGRDb250YWN0U3RhdGUgIT09IG5ld0NvbnRhY3RTdGF0ZSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkQ29udGFjdFN0YXRlLCBuZXdDb250YWN0U3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50LCBjb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgICB9KTsKICAgIH0KCiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCwgY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl91bnN1YkFsbENvbnRhY3RFdmVudHNGb3JDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5Db250YWN0RXZlbnRzKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgc2VsZi5idXMuZ2V0U3Vic2NyaXB0aW9ucyhjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudE5hbWUsIGNvbnRhY3RJZCkpCiAgICAgICAgLm1hcChmdW5jdGlvbiAoc3ViKSB7IHN1Yi51bnN1YnNjcmliZSgpOyB9KTsKICAgIH0pOwogIH07CiAKICAvKiogLS0tLS0gbWluaW1hbCB2aWV3IGxheWVyIGV2ZW50IGhhbmRsaW5nICoqLwogCiAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywgZik7CiAgfTsKIAogIC8qKgogICAqIFVzZWQgb2YgYWdlbnQgaW50ZXJmYWNlIGNvbnRyb2wuIAogICAqIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCgiY29udGFjdElkIikgLT4gIHRoaXMgaXMgY3VycmVudGx5IHByb2dyYW1tZWQgdG8gZ2V0IHRoZSBjb250YWN0IGludG8gdmlldy4KICAgKi8KICBjb25uZWN0LmNvcmUudmlld0NvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgZGF0YTogewogICAgICAgIGNvbnRhY3RJZDogY29udGFjdElkCiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKiAtLS0tLSBtaW5pbWFsIHZpZXcgbGF5ZXIgZXZlbnQgaGFuZGxpbmcgKiovCiAKICBjb25uZWN0LmNvcmUub25BY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNoYW5uZWxWaWV3RXZlbnRzLkFDVElWQVRFX0NIQU5ORUxfV0lUSF9WSUVXX1RZUEUsIGYpOwogIH07CiAKICAvKioKICAgKiBVc2VkIG9mIGFnZW50IGludGVyZmFjZSBjb250cm9sLiAKICAgKiBjb25uZWN0LmNvcmUuYWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlKCkgLT4gIHRoaXMgaXMgY3VycmVudGx5IHByb2dyYW1tZWQgdG8gZ2V0IGVpdGhlciB0aGUgbnVtYmVyIHBhZCwgcXVpY2sgY29ubmVjdHMsIG9yIGNyZWF0ZSB0YXNrIGludG8gdmlldy4KICAgKiB0aGUgdmFsaWQgY29tYmluYXRpb25zIGFyZSAoImNyZWF0ZV90YXNrIiwgInRhc2siKSwgKCJudW1iZXJfcGFkIiwgInNvZnRwaG9uZSIpLCAoImNyZWF0ZV90YXNrIiwgInNvZnRwaG9uZSIpLCAoInF1aWNrX2Nvbm5lY3RzIiwgInNvZnRwaG9uZSIpCiAgICogdGhlIHNvZnRwaG9uZSB3aXRoIGNyZWF0ZV90YXNrIGNvbWJvIGlzIGEgc3BlY2lhbCBjYXNlIGluIHRoZSBjaGFubmVsIHZpZXcgdG8gYWxsb3cgYWxsIHRocmVlIHZpZXcgdHlwZSBidXR0b25zIHRvIGFwcGVhciBvbiB0aGUgc29mdHBob25lIHNjcmVlbgogICAqCiAgICogVGhlICdzb3VyY2UnIGlzIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB3aGljaCBpbmRpY2F0ZXMgdGhlIHJlcXVlc3Rlci4gRm9yIGV4YW1wbGUsIGlmIGludm9rZWQgd2l0aCAoImNyZWF0ZV90YXNrIiwgInRhc2siLCAiYWdlbnRhcHAiKSB3ZSB3b3VsZCBrbm93IGFnZW50YXBwIHJlcXVlc3RlZCBvcGVuIHRhc2sgdmlldy4KICAgKiAKICAgKiAiY2FzZUlkIiBpcyBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgd2hpY2ggaXMgcGFzc2VkIHdoZW4gYSB0YXNrIGlzIGNyZWF0ZWQgZnJvbSBhIEtlc3l0b25lIGNhc2UKICAgKi8KICAgY29ubmVjdC5jb3JlLmFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSA9IGZ1bmN0aW9uICh2aWV3VHlwZSwgbWVkaWFUeXBlLCBzb3VyY2UsIGNhc2VJZCkgewogICAgY29uc3QgZGF0YSA9IHsgdmlld1R5cGUsIG1lZGlhVHlwZSB9OwogICAgaWYgKHNvdXJjZSkgewogICAgICBkYXRhLnNvdXJjZSA9IHNvdXJjZTsKICAgIH0KICAgIGlmIChjYXNlSWQpIHsKICAgICAgZGF0YS5jYXNlSWQgPSBjYXNlSWQ7CiAgICB9CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNoYW5uZWxWaWV3RXZlbnRzLkFDVElWQVRFX0NIQU5ORUxfV0lUSF9WSUVXX1RZUEUsCiAgICAgIGRhdGEKICAgIH0pOwogIH07CgogIC8qKgogICAqIFVzZWQgdG8gcHVibGlzaCAndGFzayBjcmVhdGVkJyBldmVudAogICAqLwogIGNvbm5lY3QuY29yZS50cmlnZ2VyVGFza0NyZWF0ZWQgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkudXBzdHJlYW1CdXMudHJpZ2dlcihjb25uZWN0LlRhc2tFdmVudHMuQ1JFQVRFRCwgZGF0YSk7CiAgfTsKCiAgLyoqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KIAogIC8qKgogICogVGhpcyB3aWxsIGJlIGhlbHBmdWwgZm9yIHRoZSBjdXN0b20gYW5kIGVtYmVkZGVkIENDUHMgCiAgKiB0byBoYW5kbGUgdGhlIGFjY2VzcyBkZW5pZWQgdXNlIGNhc2UuIAogICovCiAgY29ubmVjdC5jb3JlLm9uQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNDRVNTX0RFTklFRCwgZik7CiAgfTsKIAogIC8qKgogICogVGhpcyB3aWxsIGJlIGhlbHBmdWwgZm9yIFNBTUwgdXNlIGNhc2VzIHRvIGhhbmRsZSB0aGUgY3VzdG9tIGxvZ2lucy4gCiAgKi8KICBjb25uZWN0LmNvcmUub25BdXRoRmFpbCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZik7CiAgfTsKCiAgY29ubmVjdC5jb3JlLm9uQXV0aG9yaXplU3VjY2VzcyA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9TVUNDRVNTLCBmKTsKICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplU3VjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5ULCAwKTsKICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aEZhaWwgPSBmdW5jdGlvbihsb2dpblVybCwgYXV0aG9yaXplRW5kcG9pbnQsIGF1dGhGYWlsRGF0YSkgewogICAgaWYgKGF1dGhGYWlsRGF0YSAmJiBhdXRoRmFpbERhdGEuYXV0aG9yaXplKSB7CiAgICAgIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplRmFpbChsb2dpblVybCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLl9oYW5kbGVDVElBdXRoRmFpbChhdXRob3JpemVFbmRwb2ludCk7CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZUZhaWwgPSBmdW5jdGlvbihsb2dpblVybCkgewogICAgbGV0IGF1dGhSZXRyeUNvdW50ID0gY29ubmVjdC5jb3JlLl9nZXRBdXRoUmV0cnlDb3VudCgpCiAgICBpZiAoIWNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQpIHsKICAgICAgaWYgKGF1dGhSZXRyeUNvdW50IDwgY29ubmVjdC5jb3JlLk1BWF9BVVRIT1JJWkVfUkVUUllfQ09VTlRfRk9SX1NFU1NJT04pIHsKICAgICAgICBjb25uZWN0LmNvcmUuX2luY3JlbWVudEF1dGhSZXRyeUNvdW50KCk7CiAgICAgICAgbGV0IHJldHJ5RGVsYXkgPSBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KGF1dGhSZXRyeUNvdW50ICsgMSB8fCAwLCB7IGJhc2U6IDIwMDAgfSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgY29ubmVjdC5jb3JlLl9yZWRpcmVjdFRvTG9naW4obG9naW5VcmwpOwogICAgICAgIH0sIHJldHJ5RGVsYXkpOyAvL1dlIGRvbid0IGhhdmUgdG8gY2xlYXIgdGhlIHRpbWVvdXRJZCBiZWNhdXNlIHdlIGFyZSByZWRpcmVjdGluZyBhd2F5IGZyb20gdGhpcyBvcmlnaW4gb25jZSB0aGUgdGltZW91dCBjb21wbGV0ZXMuCiAgICAgIH0KICAgICAgZWxzZSAgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiV2UgaGF2ZSBleGhhdXN0ZWQgb3VyIGF1dGhvcml6YXRpb24gcmV0cmllcyBkdWUgdG8gNDAxcyBmcm9tIHRoZSBhdXRob3JpemUgYXBpLiBObyBtb3JlIHJldHJpZXMgd2lsbCBiZSBhdHRlbXB0ZWQgaW4gdGhpcyBzZXNzaW9uIHVudGlsIHRoZSBhdXRob3JpemUgYXBpIHJldHVybnMgMjAwLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQpOwogICAgICB9CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX3JlZGlyZWN0VG9Mb2dpbiA9IGZ1bmN0aW9uKGxvZ2luVXJsKSB7CiAgICBpZiAodHlwZW9mKGxvZ2luVXJsKSA9PT0gJ3N0cmluZycpIHsKICAgICAgbG9jYXRpb24uYXNzaWduKGxvZ2luVXJsKTsKICAgIH0gZWxzZSB7CiAgICAgIGxvY2F0aW9uLnJlbG9hZCgpOwogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVDVElBdXRoRmFpbCA9IGZ1bmN0aW9uKGF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQpIHsKICAgICAgaWYgKGNvbm5lY3QuY29yZS5jdGlBdXRoUmV0cnlDb3VudCA8IGNvbm5lY3QuY29yZS5NQVhfQ1RJX0FVVEhfUkVUUllfQ09VTlQpIHsKICAgICAgICBjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQrKzsKICAgICAgICBsZXQgcmV0cnlEZWxheSA9IEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkoY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50IHx8IDAsIHsgYmFzZTogNTAwIH0pOwogICAgICAgIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGNvbm5lY3QuY29yZS5hdXRob3JpemUoYXV0aG9yaXplRW5kcG9pbnQpLnRoZW4oY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aG9yaXplU3VjY2Vzcy5iaW5kKGNvbm5lY3QuY29yZSkpLmNhdGNoKGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhGYWlsLmJpbmQoY29ubmVjdC5jb3JlLCB7YXV0aG9yaXplOiB0cnVlfSkpOwogICAgICAgICAgY29ubmVjdC5jb3JlLmN0aVRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgfSwgcmV0cnlEZWxheSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBoYXZlIGV4aGF1c3RlZCBvdXIgYXV0aG9yaXphdGlvbiByZXRyaWVzIGR1ZSB0byA0MDFzIGZyb20gdGhlIENUSSBzZXJ2aWNlLiBObyBtb3JlIHJldHJpZXMgd2lsbCBiZSBhdHRlbXB0ZWQgdW50aWwgdGhlIHBhZ2UgaXMgcmVmcmVzaGVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5DVElfQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVEKTsKICAgICAgfQogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aG9yaXplU3VjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkudXBzdHJlYW1CdXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfU1VDQ0VTUyk7CiAgfQoKICBjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRoRmFpbCA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnVwc3RyZWFtQnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBkYXRhKTsKICB9CgogIGNvbm5lY3QuY29yZS5fZ2V0QXV0aFJldHJ5Q291bnQgPSBmdW5jdGlvbigpIHsKICAgIGxldCBpdGVtID0gd2luZG93LnNlc3Npb25TdG9yYWdlLmdldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5UKTsKICAgIGlmIChpdGVtICE9PSBudWxsKSB7CiAgICAgIGlmICghaXNOYU4ocGFyc2VJbnQoaXRlbSkpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlSW50KGl0ZW0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoIlRoZSBzZXNzaW9uIHN0b3JhZ2UgdmFsdWUgZm9yIGF1dGggcmV0cnkgY291bnQgd2FzIE5hTiIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQsIDApOwogICAgICByZXR1cm4gMDsKICAgIH0gCiAgfQoKICBjb25uZWN0LmNvcmUuX2luY3JlbWVudEF1dGhSZXRyeUNvdW50ID0gZnVuY3Rpb24oKSB7CiAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQsIChjb25uZWN0LmNvcmUuX2dldEF1dGhSZXRyeUNvdW50KCkrMSkudG9TdHJpbmcoKSk7CiAgfQoKICBjb25uZWN0LmNvcmUub25BdXRob3JpemVSZXRyaWVzRXhoYXVzdGVkID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCwgZik7CiAgfQoKICBjb25uZWN0LmNvcmUub25DVElBdXRob3JpemVSZXRyaWVzRXhoYXVzdGVkID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNUSV9BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQsIGYpOwogIH0KIAogIC8qKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAKICAvKioKICAgKiBVc2VkIGZvciBoYW5kbGluZyB0aGUgcnRjIHNlc3Npb24gc3RhdHMuCiAgICogVXNhZ2UKICAgKiBjb25uZWN0LmNvcmUub25Tb2Z0cGhvbmVTZXNzaW9uSW5pdChmdW5jdGlvbih7IGNvbm5lY3Rpb25JZCB9KSB7CiAgICogICAgIHZhciBzb2Z0cGhvbmVNYW5hZ2VyID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIoKTsKICAgKiAgICAgaWYoc29mdHBob25lTWFuYWdlcil7CiAgICogICAgICAgIC8vIGFjY2VzcyBzZXNzaW9uCiAgICogICAgICAgIHZhciBzZXNzaW9uID0gc29mdHBob25lTWFuYWdlci5nZXRTZXNzaW9uKGNvbm5lY3Rpb25JZCk7IAogICAqICAgICAgfQogICAqIH0pOwogICAqLwogCiAgY29ubmVjdC5jb3JlLm9uU29mdHBob25lU2Vzc2lvbkluaXQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuU0VTU0lPTl9JTklULCBmKTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5vbkNvbmZpZ3VyZSA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLkNPTkZJR1VSRSwgZik7CiAgfQoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICBjb25uZWN0LmNvcmUub25Jbml0aWFsaXplZCA9IGZ1bmN0aW9uKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuSU5JVCwgZik7CiAgfQoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWN0SWQsICdjb250YWN0SWQnKTsKICAgIGlmICghY29ubmVjdC5jb250YWlucyhjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RFdmVudHMpLCBldmVudE5hbWUpKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlZhbHVlRXJyb3IoJyVzIGlzIG5vdCBhIHZhbGlkIGNvbnRhY3QgZXZlbnQuJywgZXZlbnROYW1lKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoJyVzOjolcycsIGV2ZW50TmFtZSwgY29udGFjdElkKTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZXZlbnRCdXM7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXI7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldExvY2FsVGltZXN0YW1wID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpLnNuYXBzaG90LmxvY2FsVGltZXN0YW1wOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFNrZXcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCkuc25hcHNob3Quc2tldzsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudFJvdXRpbmdFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudFJvdXRpbmdFdmVudEdyYXBoOwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50Um91dGluZ0V2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLlJPVVRBQkxFLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuTk9UX1JPVVRBQkxFLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLk5PVF9ST1VUQUJMRSkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk9GRkxJTkUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuT0ZGTElORSk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50U3RhdGVFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudFN0YXRlRXZlbnRHcmFwaDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudFN0YXRlRXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQWdlbnRFcnJvclN0YXRlcyksCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzLkFGVEVSX0NBTExfV09SSywKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1cpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuY29udGFjdEV2ZW50R3JhcGg7CiAgfTsKIAogIGNvbm5lY3QuY29yZS5jb250YWN0RXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTkNPTUlORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5QRU5ESU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RFRCkKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTkNPTUlORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FTkRFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkFDVykKICAgIC5hc3NvYyhjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNPTlRBQ1RfQUNUSVZFX1NUQVRFUyksCiAgICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QucmVsYXRpdmVDb21wbGVtZW50KGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTLCBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUpKSwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkVSUk9SKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuTUlTU0VELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5jbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgY29yZSBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmNsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5jbGllbnQgPSBudWxsOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgQWdlbnRBcHAgQ2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRUYXNrVGVtcGxhdGVzQ2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBUYXNrVGVtcGxhdGVzIENsaWVudCBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCA9IG51bGw7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0TWFzdGVyQ2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IG1hc3RlciBjbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Tm90aWZpY2F0aW9uTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIpIHsKICAgICAgY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIgPSBuZXcgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyKCk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlciA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUucG9wdXBNYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLnBvcHVwTWFuYWdlciA9IG5ldyBjb25uZWN0LlBvcHVwTWFuYWdlcigpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLnVwc3RyZWFtKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZXJlIGlzIG5vIHVwc3RyZWFtIGNvbmR1aXQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnVwc3RyZWFtOwogIH07CiAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuQWdlbnREYXRhUHJvdmlkZXIgPSBBZ2VudERhdGFQcm92aWRlcjsKIAp9KSgpOwoKLyoqKi8gfSksCgovKioqLyA1OTI6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBTExfRVZFTlRTID0gJzw8YWxsPj4nOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEV2ZW50VHlwZQogICAqLwogIHZhciBFdmVudFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdhY2tub3dsZWRnZScsCiAgICAnYWNrX3RpbWVvdXQnLAogICAgJ2luaXQnLAogICAgJ2FwaV9yZXF1ZXN0JywKICAgICdhcGlfcmVzcG9uc2UnLAogICAgJ2F1dGhfZmFpbCcsCiAgICAnYWNjZXNzX2RlbmllZCcsCiAgICAnY2xvc2UnLAogICAgJ2NvbmZpZ3VyZScsCiAgICAnbG9nJywKICAgICdtYXN0ZXJfcmVxdWVzdCcsCiAgICAnbWFzdGVyX3Jlc3BvbnNlJywKICAgICdzeW5jaHJvbml6ZScsCiAgICAndGVybWluYXRlJywKICAgICd0ZXJtaW5hdGVkJywKICAgICdzZW5kX2xvZ3MnLAogICAgJ3JlbG9hZF9hZ2VudF9jb25maWd1cmF0aW9uJywKICAgICdicm9hZGNhc3QnLAogICAgJ2FwaV9tZXRyaWMnLAogICAgJ2NsaWVudF9tZXRyaWMnLAogICAgJ3NvZnRwaG9uZV9zdGF0cycsCiAgICAnc29mdHBob25lX3JlcG9ydCcsCiAgICAnY2xpZW50X3NpZGVfbG9ncycsCiAgICAnc2VydmVyX2JvdW5kX2ludGVybmFsX2xvZycsCiAgICAnbXV0ZScsCiAgICAiaWZyYW1lX3N0eWxlIiwKICAgICJpZnJhbWVfcmV0cmllc19leGhhdXN0ZWQiLAogICAgInVwZGF0ZV9jb25uZWN0ZWRfY2NwcyIsCiAgICAib3V0ZXJfY29udGV4dF9pbmZvIiwKICAgICJtZWRpYV9kZXZpY2VfcmVxdWVzdCIsCiAgICAibWVkaWFfZGV2aWNlX3Jlc3BvbnNlIiwKICAgICJ0YWJfaWQiLAogICAgJ2F1dGhvcml6ZV9zdWNjZXNzJywKICAgICdhdXRob3JpemVfcmV0cmllc19leGhhdXN0ZWQnLAogICAgJ2N0aV9hdXRob3JpemVfcmV0cmllc19leGhhdXN0ZWQnLAogICAgJ2NsaWNrX3N0cmVhbV9kYXRhJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIE1hc3RlclRvcGljcwogICAqLwogIHZhciBNYXN0ZXJUb3BpY3MgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29ubmVjdCcsIFsKICAgICdsb2dpblBvcHVwJywKICAgICdzZW5kTG9ncycsCiAgICAnc29mdHBob25lJywKICAgICdyaW5ndG9uZScsCiAgICAnbWV0cmljcycKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudEV2ZW50cwogICAqLwogIHZhciBBZ2VudEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdhZ2VudCcsIFsKICAgICdpbml0JywKICAgICd1cGRhdGUnLAogICAgJ3JlZnJlc2gnLAogICAgJ3JvdXRhYmxlJywKICAgICdub3Rfcm91dGFibGUnLAogICAgJ3BlbmRpbmcnLAogICAgJ2NvbnRhY3RfcGVuZGluZycsCiAgICAnb2ZmbGluZScsCiAgICAnZXJyb3InLAogICAgJ3NvZnRwaG9uZV9lcnJvcicsCiAgICAnd2Vic29ja2V0X2Nvbm5lY3Rpb25fbG9zdCcsCiAgICAnd2Vic29ja2V0X2Nvbm5lY3Rpb25fZ2FpbmVkJywKICAgICdzdGF0ZV9jaGFuZ2UnLAogICAgJ2FjdycsCiAgICAnbXV0ZV90b2dnbGUnLAogICAgJ2xvY2FsX21lZGlhX3N0cmVhbV9jcmVhdGVkJywKICAgICdlbnF1ZXVlZF9uZXh0X3N0YXRlJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gV2ViU29ja2V0RXZlbnRzCiAgKi8KICB2YXIgV2ViU29ja2V0RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3dlYlNvY2tldCcsIFsKICAgICdpbml0X2ZhaWx1cmUnLAogICAgJ2Nvbm5lY3Rpb25fb3BlbicsCiAgICAnY29ubmVjdGlvbl9jbG9zZScsCiAgICAnY29ubmVjdGlvbl9lcnJvcicsCiAgICAnY29ubmVjdGlvbl9nYWluJywKICAgICdjb25uZWN0aW9uX2xvc3QnLAogICAgJ3N1YnNjcmlwdGlvbl91cGRhdGUnLAogICAgJ3N1YnNjcmlwdGlvbl9mYWlsdXJlJywKICAgICdhbGxfbWVzc2FnZScsCiAgICAnc2VuZCcsCiAgICAnc3Vic2NyaWJlJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBDb250YWN0RXZlbnRzCiAgICAqLwogIHZhciBDb250YWN0RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbnRhY3QnLCBbCiAgICAnaW5pdCcsCiAgICAncmVmcmVzaCcsCiAgICAnZGVzdHJveWVkJywKICAgICdpbmNvbWluZycsCiAgICAncGVuZGluZycsCiAgICAnY29ubmVjdGluZycsCiAgICAnY29ubmVjdGVkJywKICAgICdtaXNzZWQnLAogICAgJ2FjdycsCiAgICAndmlldycsCiAgICAnZW5kZWQnLAogICAgJ2Vycm9yJywKICAgICdhY2NlcHRlZCcKICBdKTsKCiAgdmFyIENoYW5uZWxWaWV3RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3Rhc2tMaXN0JywgWwogICAgJ2FjdGl2YXRlX2NoYW5uZWxfd2l0aF92aWV3X3R5cGUnCiAgXSk7CiAgCiAgdmFyIFRhc2tFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgndGFzaycsIFsKICAgICAgJ2NyZWF0ZWQnCiAgXSk7CgoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gQ29ubmVjdGlvbkV2ZW50cwogICovCiAgdmFyIENvbm5lY3Rpb25FdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29ubmVjdGlvbicsIFsKICAgICdzZXNzaW9uX2luaXQnLAogICAgJ3JlYWR5X3RvX3N0YXJ0X3Nlc3Npb24nCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29uZmlndXJhdGlvbiBFdmVudHMKICAgKi8KICB2YXIgQ29uZmlndXJhdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25maWd1cmF0aW9uJywgWwogICAgJ2NvbmZpZ3VyZScsCiAgICAnc2V0X3NwZWFrZXJfZGV2aWNlJywKICAgICdzZXRfbWljcm9waG9uZV9kZXZpY2UnLAogICAgJ3NldF9yaW5nZXJfZGV2aWNlJywKICAgICdzcGVha2VyX2RldmljZV9jaGFuZ2VkJywKICAgICdtaWNyb3Bob25lX2RldmljZV9jaGFuZ2VkJywKICAgICdyaW5nZXJfZGV2aWNlX2NoYW5nZWQnCiAgXSk7CgogIHZhciBEaXNhc3RlclJlY292ZXJ5RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Rpc2FzdGVyUmVjb3ZlcnknLCBbCiAgICAnc3VwcHJlc3MnLAogICAgJ2ZvcmNlX29mZmxpbmUnLCAvLyBsZXR0aW5nIHRoZSBzaGFyZWR3b3JrZXIga25vdyB0byBmb3JjZSBvZmZsaW5lIAogICAgJ3NldF9vZmZsaW5lJywgLy8gaWZyYW1lIGxldHRpbmcgdGhlIG5hdGl2ZSBjY3AgdG8gc2V0IG9mZmxpbmUKICAgICdpbml0X2Rpc2FzdGVyX3JlY292ZXJ5JywKICAgICdmYWlsb3ZlcicgLy8gdXNlZCB0byBwcm9wYWdhdGUgZmFpbG92ZXIgc3RhdGUgdG8gb3RoZXIgd2luZG93cwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFZvaWNlSWQgRXZlbnRzCiAgICovCiAgIHZhciBWb2ljZUlkRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3ZvaWNlSWQnLCBbCiAgICAndXBkYXRlX2RvbWFpbl9pZCcKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgRXZlbnRGYWN0b3J5CiAgICovCiAgdmFyIEV2ZW50RmFjdG9yeSA9IGZ1bmN0aW9uICgpIHsgfTsKICBFdmVudEZhY3RvcnkuY3JlYXRlUmVxdWVzdCA9IGZ1bmN0aW9uICh0eXBlLCBtZXRob2QsIHBhcmFtcykgewogICAgcmV0dXJuIHsKICAgICAgZXZlbnQ6IHR5cGUsCiAgICAgIHJlcXVlc3RJZDogY29ubmVjdC5yYW5kb21JZCgpLAogICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgcGFyYW1zOiBwYXJhbXMKICAgIH07CiAgfTsKCiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlID0gZnVuY3Rpb24gKHR5cGUsIHJlcXVlc3QsIGRhdGEsIGVycikgewogICAgcmV0dXJuIHsKICAgICAgZXZlbnQ6IHR5cGUsCiAgICAgIHJlcXVlc3RJZDogcmVxdWVzdC5yZXF1ZXN0SWQsCiAgICAgIGRhdGE6IGRhdGEsCiAgICAgIGVycjogZXJyIHx8IG51bGwKICAgIH07CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHJlcHJlc2VudGluZyBhbiBldmVudCBzdWJzY3JpcHRpb24gaW4gYW4gRXZlbnRCdXMuCiAgICovCiAgdmFyIFN1YnNjcmlwdGlvbiA9IGZ1bmN0aW9uIChzdWJNYXAsIGV2ZW50TmFtZSwgZikgewogICAgdGhpcy5zdWJNYXAgPSBzdWJNYXA7CiAgICB0aGlzLmlkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICB0aGlzLmYgPSBmOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIHRoZSBoYW5kbGVyIG9mIHRoaXMgc3Vic2NyaXB0aW9uIGZyb20gdGhlIEV2ZW50QnVzCiAgICogZnJvbSB3aGljaCBpdCB3YXMgY3JlYXRlZC4KICAgKi8KICBTdWJzY3JpcHRpb24ucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJNYXAudW5zdWJzY3JpYmUodGhpcy5ldmVudE5hbWUsIHRoaXMuaWQpOwogIH07CgogIC8qKgogICAqIEEgbWFwIG9mIGV2ZW50IHN1YnNjcmlwdGlvbnMsIHVzZWQgYnkgdGhlIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb25NYXAgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1YklkTWFwID0ge307CiAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcCA9IHt9OwogIH07CgogIC8qKgogICAqIEFkZCBhIHN1YnNjcmlwdGlvbiBmb3IgdGhlIG5hbWVkIGV2ZW50LiAgQ3JlYXRlcyBhIG5ldyBTdWJzY3JpcHRpb24KICAgKiBvYmplY3QgYW5kIHJldHVybnMgaXQuICBUaGlzIG9iamVjdCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGYpIHsKICAgIHZhciBzdWIgPSBuZXcgU3Vic2NyaXB0aW9uKHRoaXMsIGV2ZW50TmFtZSwgZik7CgogICAgdGhpcy5zdWJJZE1hcFtzdWIuaWRdID0gc3ViOwogICAgdmFyIHN1Ykxpc3QgPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdIHx8IFtdOwogICAgc3ViTGlzdC5wdXNoKHN1Yik7CiAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdID0gc3ViTGlzdDsKICAgIHJldHVybiBzdWI7CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgYSBzdWJzY3JpcHRpb24gbWF0Y2hpbmcgdGhlIGdpdmVuIGV2ZW50IG5hbWUgYW5kIGlkLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBzdWJJZCkgewogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJFdmVudE5hbWVNYXAsIGV2ZW50TmFtZSkpIHsKICAgICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0uZmlsdGVyKGZ1bmN0aW9uIChzKSB7IHJldHVybiBzLmlkICE9PSBzdWJJZDsgfSk7CgogICAgICBpZiAodGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXS5sZW5ndGggPCAxKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV07CiAgICAgIH0KICAgIH0KCiAgICBpZiAoY29ubmVjdC5jb250YWlucyh0aGlzLnN1YklkTWFwLCBzdWJJZCkpIHsKICAgICAgZGVsZXRlIHRoaXMuc3ViSWRNYXBbc3ViSWRdOwogICAgfQogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2YgYWxsIHN1YnNjcmlwdGlvbnMgaW4gdGhlIHN1YnNjcmlwdGlvbiBtYXAuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRBbGxTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QudmFsdWVzKHRoaXMuc3ViRXZlbnROYW1lTWFwKS5yZWR1Y2UoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEuY29uY2F0KGIpOwogICAgfSwgW10pOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLmdldFN1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICB9OwoKICAvKioKICAgKiBBbiBvYmplY3Qgd2hpY2ggbWFpbnRhaW5zIGEgbWFwIG9mIHN1YnNjcmlwdGlvbnMgYW5kIHNlcnZlcyBhcyB0aGUKICAgKiBtZWNoYW5pc20gZm9yIHRyaWdnZXJpbmcgZXZlbnRzIHRvIGJlIGhhbmRsZWQgYnkgc3Vic2NyaWJlcnMuCiAgICovCiAgdmFyIEV2ZW50QnVzID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CgogICAgdGhpcy5zdWJNYXAgPSBuZXcgU3Vic2NyaXB0aW9uTWFwKCk7CiAgICB0aGlzLmxvZ0V2ZW50cyA9IHBhcmFtcy5sb2dFdmVudHMgfHwgZmFsc2U7CiAgfTsKCiAgLyoqCiAgICogU3Vic2NyaWJlIHRvIHRoZSBuYW1lZCBldmVudC4gIFJldHVybnMgYSBuZXcgU3Vic2NyaXB0aW9uIG9iamVjdAogICAqIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgcmV0dXJuIHRoaXMuc3ViTWFwLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBhbGwgZXZlbnRzLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5zdWJzY3JpYmVBbGwgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoQUxMX0VWRU5UUywgZik7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGZvciB0aGUgZ2l2ZW4gZXZlbnQgbmFtZSwgb3IgYW4gZW1wdHkKICAgKiBsaXN0IGlmIHRoZXJlIGFyZSBubyBzdWJzY3JpcHRpb25zLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKICB9OwoKICAvKioKICAgKiBUcmlnZ2VyIHRoZSBnaXZlbiBldmVudCB3aXRoIHRoZSBnaXZlbiBkYXRhLiAgQWxsIG1ldGhvZHMgc3Vic2NyaWJlZAogICAqIHRvIHRoaXMgZXZlbnQgd2lsbCBiZSBjYWxsZWQgYW5kIGFyZSBwcm92aWRlZCB3aXRoIHRoZSBnaXZlbiBhcmJpdHJhcnkKICAgKiBkYXRhIG9iamVjdCBhbmQgdGhlIG5hbWUgb2YgdGhlIGV2ZW50LCBpbiB0aGF0IG9yZGVyLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS50cmlnZ2VyID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGFsbEV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoQUxMX0VWRU5UUyk7CiAgICB2YXIgZXZlbnRTdWJzID0gdGhpcy5zdWJNYXAuZ2V0U3Vic2NyaXB0aW9ucyhldmVudE5hbWUpOwoKICAgIGlmICh0aGlzLmxvZ0V2ZW50cyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTE9HICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9NRVRSSUMgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0cKICAgICkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJQdWJsaXNoaW5nIGV2ZW50OiAlcyIsIGV2ZW50TmFtZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KCiAgICBpZiAoCiAgICAgIGV2ZW50TmFtZS5zdGFydHNXaXRoKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCkgJiYKICAgICAgZGF0YSAmJgogICAgICBkYXRhLmNvbnRhY3RJZCAmJgogICAgICAhKGRhdGEgaW5zdGFuY2VvZiBjb25uZWN0LkNvbnRhY3QpCiAgICApIHsKICAgICAgZGF0YSA9IG5ldyBjb25uZWN0LkNvbnRhY3QoZGF0YS5jb250YWN0SWQpOwogICAgfQoKICAgIGFsbEV2ZW50U3Vicy5jb25jYXQoZXZlbnRTdWJzKS5mb3JFYWNoKGZ1bmN0aW9uIChzdWIpIHsKICAgICAgdHJ5IHsKICAgICAgICBzdWIuZihkYXRhIHx8IG51bGwsIGV2ZW50TmFtZSwgc2VsZik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCInJXMnIGV2ZW50IGhhbmRsZXIgZmFpbGVkLiIsIGV2ZW50TmFtZSkud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBicmlkZ2VzIGFuIGV2ZW50IGZyb20gYW5vdGhlciBFdmVudEJ1cyB0byB0aGlzIGJ1cy4KICAgKgogICAqIFVzYWdlOgogICAqIGNvbmR1aXQub25VcHN0cmVhbSgiTXlFdmVudCIsIGJ1cy5icmlkZ2UoKSk7CiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLmJyaWRnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBmdW5jdGlvbiAoZGF0YSwgZXZlbnQpIHsKICAgICAgc2VsZi50cmlnZ2VyKGV2ZW50LCBkYXRhKTsKICAgIH07CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgYWxsIGV2ZW50cyBpbiB0aGUgZXZlbnQgYnVzLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS51bnN1YnNjcmliZUFsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLmdldEFsbFN1YnNjcmlwdGlvbnMoKS5mb3JFYWNoKGZ1bmN0aW9uIChzdWIpIHsKICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBjb25uZWN0LkV2ZW50QnVzID0gRXZlbnRCdXM7CiAgY29ubmVjdC5FdmVudEZhY3RvcnkgPSBFdmVudEZhY3Rvcnk7CiAgY29ubmVjdC5FdmVudFR5cGUgPSBFdmVudFR5cGU7CiAgY29ubmVjdC5BZ2VudEV2ZW50cyA9IEFnZW50RXZlbnRzOwogIGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cyA9IENvbmZpZ3VyYXRpb25FdmVudHM7CiAgY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzID0gQ29ubmVjdGlvbkV2ZW50czsKICBjb25uZWN0LkNvbm5uZWN0aW9uRXZlbnRzID0gQ29ubmVjdGlvbkV2ZW50czsgLy9kZXByZWNhdGUgb24gbmV4dCBtYWpvciB2ZXJzaW9uIHJlbGVhc2UuCiAgY29ubmVjdC5Db250YWN0RXZlbnRzID0gQ29udGFjdEV2ZW50czsKICBjb25uZWN0LkNoYW5uZWxWaWV3RXZlbnRzID0gQ2hhbm5lbFZpZXdFdmVudHM7CiAgY29ubmVjdC5UYXNrRXZlbnRzID0gVGFza0V2ZW50czsKICBjb25uZWN0LlZvaWNlSWRFdmVudHMgPSBWb2ljZUlkRXZlbnRzOwogIGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzID0gV2ViU29ja2V0RXZlbnRzOwogIGNvbm5lY3QuTWFzdGVyVG9waWNzID0gTWFzdGVyVG9waWNzOwogIGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cyA9IERpc2FzdGVyUmVjb3ZlcnlFdmVudHM7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAyODY6Ci8qKiovICgoKSA9PiB7CgohZnVuY3Rpb24oZSl7dmFyIG49e307ZnVuY3Rpb24gdChvKXtpZihuW29dKXJldHVybiBuW29dLmV4cG9ydHM7dmFyIHI9bltvXT17aTpvLGw6ITEsZXhwb3J0czp7fX07cmV0dXJuIGVbb10uY2FsbChyLmV4cG9ydHMscixyLmV4cG9ydHMsdCksci5sPSEwLHIuZXhwb3J0c310Lm09ZSx0LmM9bix0LmQ9ZnVuY3Rpb24oZSxuLG8pe3QubyhlLG4pfHxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxuLHtlbnVtZXJhYmxlOiEwLGdldDpvfSl9LHQucj1mdW5jdGlvbihlKXsidW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmU3ltYm9sLnRvU3RyaW5nVGFnJiZPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxTeW1ib2wudG9TdHJpbmdUYWcse3ZhbHVlOiJNb2R1bGUifSksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pfSx0LnQ9ZnVuY3Rpb24oZSxuKXtpZigxJm4mJihlPXQoZSkpLDgmbilyZXR1cm4gZTtpZig0Jm4mJiJvYmplY3QiPT10eXBlb2YgZSYmZSYmZS5fX2VzTW9kdWxlKXJldHVybiBlO3ZhciBvPU9iamVjdC5jcmVhdGUobnVsbCk7aWYodC5yKG8pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCJkZWZhdWx0Iix7ZW51bWVyYWJsZTohMCx2YWx1ZTplfSksMiZuJiYic3RyaW5nIiE9dHlwZW9mIGUpZm9yKHZhciByIGluIGUpdC5kKG8scixmdW5jdGlvbihuKXtyZXR1cm4gZVtuXX0uYmluZChudWxsLHIpKTtyZXR1cm4gb30sdC5uPWZ1bmN0aW9uKGUpe3ZhciBuPWUmJmUuX19lc01vZHVsZT9mdW5jdGlvbigpe3JldHVybiBlLmRlZmF1bHR9OmZ1bmN0aW9uKCl7cmV0dXJuIGV9O3JldHVybiB0LmQobiwiYSIsbiksbn0sdC5vPWZ1bmN0aW9uKGUsbil7cmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChlLG4pfSx0LnA9IiIsdCh0LnM9Mil9KFtmdW5jdGlvbihlLG4sdCl7InVzZSBzdHJpY3QiO3ZhciBvPXQoMSkscj0iTlVMTCIsaT0iQ0xJRU5UX0xPR0dFUiIsYz0iREVCVUciLGE9MmUzLHM9IkFNWl9XRUJfU09DS0VUX01BTkFHRVI6Iix1PSJOZXR3b3JrIG9mZmxpbmUiLGw9Ik5ldHdvcmsgb25saW5lLCBjb25uZWN0aW5nIHRvIFdlYlNvY2tldCBzZXJ2ZXIiLGY9Ik5ldHdvcmsgb2ZmbGluZSwgaWdub3JpbmcgdGhpcyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QiLGQ9IkhlYXJ0YmVhdCByZXNwb25zZSBub3QgcmVjZWl2ZWQiLHA9IkhlYXJ0YmVhdCByZXNwb25zZSByZWNlaXZlZCIsZz0iU2VuZGluZyBoZWFydGJlYXQiLGI9IkZhaWxlZCB0byBzZW5kIGhlYXJ0YmVhdCBzaW5jZSBXZWJTb2NrZXQgaXMgbm90IG9wZW4iLHk9IldlYlNvY2tldCBjb25uZWN0aW9uIGVzdGFibGlzaGVkISIsbT0iV2ViU29ja2V0IGNvbm5lY3Rpb24gaXMgY2xvc2VkIix2PSJXZWJTb2NrZXRNYW5hZ2VyIEVycm9yLCBlcnJvcl9ldmVudDogIixTPSJTY2hlZHVsaW5nIFdlYlNvY2tldCByZWluaXRpYWxpemF0aW9uLCBhZnRlciBkZWxheSAiLGg9IldlYlNvY2tldCBVUkwgY2Fubm90IGJlIHVzZWQgdG8gZXN0YWJsaXNoIGNvbm5lY3Rpb24iLGs9IldlYlNvY2tldCBJbml0aWFsaXphdGlvbiBmYWlsZWQgLSBUZXJtaW5hdGluZyBhbmQgY2xlYW5pbmcgc3Vic2NyaXB0aW9ucyIsdz0iVGVybWluYXRpbmcgV2ViU29ja2V0IE1hbmFnZXIiLEM9IkZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixMPSJTdWNjZXNzZnVsbHkgZmV0Y2hlZCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixUPSJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsTz0iUmV0cnlpbmcgZmV0Y2hpbmcgbmV3IFdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLFc9IkluaXRpYWxpemluZyBXZWJzb2NrZXQgTWFuYWdlciIsST0iSW5pdGlhbGl6aW5nIFdlYnNvY2tldCBNYW5hZ2VyIEZhaWxlZCEiLE49IldlYnNvY2tldCBjb25uZWN0aW9uIG9wZW4iLF89IldlYnNvY2tldCBjb25uZWN0aW9uIGNsb3NlIixFPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBnYWluIixGPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBsb3N0IixBPSJXZWJzb2NrZXQgc3Vic2NyaXB0aW9uIGZhaWx1cmUiLFI9IlJlc2V0IFdlYnNvY2tldCBzdGF0ZSIseD0iV2ViU29ja2V0TWFuYWdlciBNZXNzYWdlIEVycm9yIixEPSJNZXNzYWdlIHJlY2VpdmVkIGZvciB0b3BpYyAiLGo9IkludmFsaWQgaW5jb21pbmcgbWVzc2FnZSIsTT0iV2Vic29ja2V0TWFuYWdlciBpbnZva2UgY2FsbGJhY2tzIGZvciB0b3BpYyBzdWNjZXNzICIsRz0iYXdzL3N1YnNjcmliZSIsej0iYXdzL3Vuc3Vic2NyaWJlIixQPSJhd3MvaGVhcnRiZWF0IixIPSJjb25uZWN0ZWQiLFU9ImRpc2Nvbm5lY3RlZCI7ZnVuY3Rpb24gcShlKXtyZXR1cm4ocT0iZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiYic3ltYm9sIj09dHlwZW9mIFN5bWJvbC5pdGVyYXRvcj9mdW5jdGlvbihlKXtyZXR1cm4gdHlwZW9mIGV9OmZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiZlLmNvbnN0cnVjdG9yPT09U3ltYm9sJiZlIT09U3ltYm9sLnByb3RvdHlwZT8ic3ltYm9sIjp0eXBlb2YgZX0pKGUpfXZhciBKPXthc3NlcnRUcnVlOmZ1bmN0aW9uKGUsbil7aWYoIWUpdGhyb3cgbmV3IEVycm9yKG4pfSxhc3NlcnROb3ROdWxsOmZ1bmN0aW9uKGUsbil7cmV0dXJuIEouYXNzZXJ0VHJ1ZShudWxsIT09ZSYmdm9pZCAwIT09cShlKSxPYmplY3Qoby5zcHJpbnRmKSgiJXMgbXVzdCBiZSBwcm92aWRlZCIsbnx8IkEgdmFsdWUiKSksZX0saXNOb25FbXB0eVN0cmluZzpmdW5jdGlvbihlKXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIGUmJmUubGVuZ3RoPjB9LGFzc2VydElzTGlzdDpmdW5jdGlvbihlLG4pe2lmKCFBcnJheS5pc0FycmF5KGUpKXRocm93IG5ldyBFcnJvcihuKyIgaXMgbm90IGFuIGFycmF5Iil9LGlzRnVuY3Rpb246ZnVuY3Rpb24oZSl7cmV0dXJuISEoZSYmZS5jb25zdHJ1Y3RvciYmZS5jYWxsJiZlLmFwcGx5KX0saXNPYmplY3Q6ZnVuY3Rpb24oZSl7cmV0dXJuISgib2JqZWN0IiE9PXEoZSl8fG51bGw9PT1lKX0saXNTdHJpbmc6ZnVuY3Rpb24oZSl7cmV0dXJuInN0cmluZyI9PXR5cGVvZiBlfSxpc051bWJlcjpmdW5jdGlvbihlKXtyZXR1cm4ibnVtYmVyIj09dHlwZW9mIGV9fSxCPW5ldyBSZWdFeHAoIl4od3NzOi8vKVxcdyoiKTtKLnZhbGlkV1NVcmw9ZnVuY3Rpb24oZSl7cmV0dXJuIEIudGVzdChlKX0sSi5nZXRTdWJzY3JpcHRpb25SZXNwb25zZT1mdW5jdGlvbihlLG4sdCl7cmV0dXJue3RvcGljOmUsY29udGVudDp7c3RhdHVzOm4/InN1Y2Nlc3MiOiJmYWlsdXJlIix0b3BpY3M6dH19fSxKLmFzc2VydElzT2JqZWN0PWZ1bmN0aW9uKGUsbil7aWYoIUouaXNPYmplY3QoZSkpdGhyb3cgbmV3IEVycm9yKG4rIiBpcyBub3QgYW4gb2JqZWN0ISIpfSxKLmFkZEppdHRlcj1mdW5jdGlvbihlKXt2YXIgbj1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06MTtuPU1hdGgubWluKG4sMSk7dmFyIHQ9TWF0aC5yYW5kb20oKT4uNT8xOi0xO3JldHVybiBNYXRoLmZsb29yKGUrdCplKk1hdGgucmFuZG9tKCkqbil9LEouaXNOZXR3b3JrT25saW5lPWZ1bmN0aW9uKCl7cmV0dXJuIG5hdmlnYXRvci5vbkxpbmV9LEouaXNOZXR3b3JrRmFpbHVyZT1mdW5jdGlvbihlKXtyZXR1cm4hKCFlLl9kZWJ1Z3x8IWUuX2RlYnVnLnR5cGUpJiYiTmV0d29ya2luZ0Vycm9yIj09PWUuX2RlYnVnLnR5cGV9O3ZhciBWPUo7ZnVuY3Rpb24gWChlLG4pe3JldHVybiFufHwib2JqZWN0IiE9PVoobikmJiJmdW5jdGlvbiIhPXR5cGVvZiBuP2Z1bmN0aW9uKGUpe2lmKHZvaWQgMD09PWUpdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTtyZXR1cm4gZX0oZSk6bn1mdW5jdGlvbiAkKGUpe3JldHVybigkPU9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3QuZ2V0UHJvdG90eXBlT2Y6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoZSl9KShlKX1mdW5jdGlvbiBLKGUsbil7cmV0dXJuKEs9T2JqZWN0LnNldFByb3RvdHlwZU9mfHxmdW5jdGlvbihlLG4pe3JldHVybiBlLl9fcHJvdG9fXz1uLGV9KShlLG4pfWZ1bmN0aW9uIFooZSl7cmV0dXJuKFo9ImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3I/ZnVuY3Rpb24oZSl7cmV0dXJuIHR5cGVvZiBlfTpmdW5jdGlvbihlKXtyZXR1cm4gZSYmImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmZS5jb25zdHJ1Y3Rvcj09PVN5bWJvbCYmZSE9PVN5bWJvbC5wcm90b3R5cGU/InN5bWJvbCI6dHlwZW9mIGV9KShlKX1mdW5jdGlvbiBRKGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9ZnVuY3Rpb24gWShlLG4pe2Zvcih2YXIgdD0wO3Q8bi5sZW5ndGg7dCsrKXt2YXIgbz1uW3RdO28uZW51bWVyYWJsZT1vLmVudW1lcmFibGV8fCExLG8uY29uZmlndXJhYmxlPSEwLCJ2YWx1ZSJpbiBvJiYoby53cml0YWJsZT0hMCksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsby5rZXksbyl9fWZ1bmN0aW9uIGVlKGUsbix0KXtyZXR1cm4gbiYmWShlLnByb3RvdHlwZSxuKSx0JiZZKGUsdCksZX12YXIgbmU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7USh0aGlzLGUpfXJldHVybiBlZShlLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6ImFkdmFuY2VkTG9nIix2YWx1ZTpmdW5jdGlvbihlKXt9fV0pLGV9KCksdGU9cyxvZT17REVCVUc6MTAsSU5GTzoyMCxXQVJOOjMwLEVSUk9SOjQwLEFEVkFOQ0VEX0xPRzo1MH0scmU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7USh0aGlzLGUpLHRoaXMudXBkYXRlTG9nZ2VyQ29uZmlnKCksdGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcj1hZSgpfXJldHVybiBlZShlLFt7a2V5OiJ3cml0ZVRvQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuaGFzQ2xpZW50TG9nZ2VyKCkpc3dpdGNoKGUpe2Nhc2Ugb2UuREVCVUc6cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5kZWJ1ZyhuKXx8bjtjYXNlIG9lLklORk86cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5pbmZvKG4pfHxuO2Nhc2Ugb2UuV0FSTjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLndhcm4obil8fG47Y2FzZSBvZS5FUlJPUjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmVycm9yKG4pfHxuO2Nhc2Ugb2UuQURWQU5DRURfTE9HOnJldHVybiB0aGlzLl9hZHZhbmNlZExvZ1dyaXRlcj90aGlzLl9jbGllbnRMb2dnZXJbdGhpcy5fYWR2YW5jZWRMb2dXcml0ZXJdKG4pfHxuOiIifX19LHtrZXk6ImlzTGV2ZWxFbmFibGVkIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gZT49dGhpcy5fbGV2ZWx9fSx7a2V5OiJoYXNDbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJuIG51bGwhPT10aGlzLl9jbGllbnRMb2dnZXJ9fSx7a2V5OiJnZXRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWUucHJlZml4fHx0ZTtyZXR1cm4gdGhpcy5fbG9nc0Rlc3RpbmF0aW9uPT09Yz90aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyOm5ldyBjZShuKX19LHtrZXk6InVwZGF0ZUxvZ2dlckNvbmZpZyIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49ZXx8e307dGhpcy5fbGV2ZWw9bi5sZXZlbHx8b2UuSU5GTyx0aGlzLl9hZHZhbmNlZExvZ1dyaXRlcj0id2FybiIsbi5hZHZhbmNlZExvZ1dyaXRlciYmKHRoaXMuX2FkdmFuY2VkTG9nV3JpdGVyPW4uYWR2YW5jZWRMb2dXcml0ZXIpLG4uY3VzdG9taXplZExvZ2dlciYmIm9iamVjdCI9PT1aKG4uY3VzdG9taXplZExvZ2dlcikmJih0aGlzLnVzZUNsaWVudExvZ2dlcj0hMCksdGhpcy5fY2xpZW50TG9nZ2VyPW4ubG9nZ2VyfHx0aGlzLnNlbGVjdExvZ2dlcihuKSx0aGlzLl9sb2dzRGVzdGluYXRpb249cixuLmRlYnVnJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPWMpLG4ubG9nZ2VyJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPWkpfX0se2tleToic2VsZWN0TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gZS5jdXN0b21pemVkTG9nZ2VyJiYib2JqZWN0Ij09PVooZS5jdXN0b21pemVkTG9nZ2VyKT9lLmN1c3RvbWl6ZWRMb2dnZXI6ZS51c2VEZWZhdWx0TG9nZ2VyPyh0aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyPWFlKCksdGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcik6bnVsbH19XSksZX0oKSxpZT1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXtRKHRoaXMsZSl9cmV0dXJuIGVlKGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJhZHZhbmNlZExvZyIsdmFsdWU6ZnVuY3Rpb24oKXt9fV0pLGV9KCksY2U9ZnVuY3Rpb24oZSl7ZnVuY3Rpb24gbihlKXt2YXIgdDtyZXR1cm4gUSh0aGlzLG4pLCh0PVgodGhpcywkKG4pLmNhbGwodGhpcykpKS5wcmVmaXg9ZXx8dGUsdH1yZXR1cm4gZnVuY3Rpb24oZSxuKXtpZigiZnVuY3Rpb24iIT10eXBlb2YgbiYmbnVsbCE9PW4pdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24iKTtlLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKG4mJm4ucHJvdG90eXBlLHtjb25zdHJ1Y3Rvcjp7dmFsdWU6ZSx3cml0YWJsZTohMCxjb25maWd1cmFibGU6ITB9fSksbiYmSyhlLG4pfShuLGllKSxlZShuLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLkRFQlVHLG4pfX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLklORk8sbil9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2cob2UuV0FSTixuKX19LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2cob2UuRVJST1Isbil9fSx7a2V5OiJhZHZhbmNlZExvZyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLkFEVkFOQ0VEX0xPRyxuKX19LHtrZXk6Il9zaG91bGRMb2ciLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBzZS5oYXNDbGllbnRMb2dnZXIoKSYmc2UuaXNMZXZlbEVuYWJsZWQoZSl9fSx7a2V5OiJfd3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gc2Uud3JpdGVUb0NsaWVudExvZ2dlcihlLG4pfX0se2tleToiX2xvZyIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLl9zaG91bGRMb2coZSkpe3ZhciB0PXNlLnVzZUNsaWVudExvZ2dlcj9uOnRoaXMuX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudChuLGUpO3JldHVybiB0aGlzLl93cml0ZVRvQ2xpZW50TG9nZ2VyKGUsdCl9fX0se2tleToiX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudCIsdmFsdWU6ZnVuY3Rpb24oZSxuKXt2YXIgdD1uZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpLG89dGhpcy5fZ2V0TG9nTGV2ZWxCeVZhbHVlKG4pLHI9IlsiLmNvbmNhdCh0LCJdWyIpLmNvbmNhdChvLCJdIik7dGhpcy5wcmVmaXgmJihyKz10aGlzLnByZWZpeCsiICIpLHRoaXMub3B0aW9ucyYmKHRoaXMub3B0aW9ucy5wcmVmaXg/cis9IiAiK3RoaXMub3B0aW9ucy5wcmVmaXgrIjoiOnIrPSIiLHRoaXMub3B0aW9ucy5sb2dNZXRhRGF0YT9yKz0iIE1ldGEgZGF0YTogIitKU09OLnN0cmluZ2lmeSh0aGlzLm9wdGlvbnMubG9nTWV0YURhdGEpOnIrPSIiKTtmb3IodmFyIGk9MDtpPGUubGVuZ3RoO2krKyl7dmFyIGM9ZVtpXTtyKz10aGlzLl9jb252ZXJ0VG9TdHJpbmcoYykrIiAifXJldHVybiByfX0se2tleToiX2dldExvZ0xldmVsQnlWYWx1ZSIsdmFsdWU6ZnVuY3Rpb24oZSl7c3dpdGNoKGUpe2Nhc2UgMTA6cmV0dXJuIkRFQlVHIjtjYXNlIDIwOnJldHVybiJJTkZPIjtjYXNlIDMwOnJldHVybiJXQVJOIjtjYXNlIDQwOnJldHVybiJFUlJPUiI7Y2FzZSA1MDpyZXR1cm4iQURWQU5DRURfTE9HIn19fSx7a2V5OiJfY29udmVydFRvU3RyaW5nIix2YWx1ZTpmdW5jdGlvbihlKXt0cnl7aWYoIWUpcmV0dXJuIiI7aWYoVi5pc1N0cmluZyhlKSlyZXR1cm4gZTtpZihWLmlzT2JqZWN0KGUpJiZWLmlzRnVuY3Rpb24oZS50b1N0cmluZykpe3ZhciBuPWUudG9TdHJpbmcoKTtpZigiW29iamVjdCBPYmplY3RdIiE9PW4pcmV0dXJuIG59cmV0dXJuIEpTT04uc3RyaW5naWZ5KGUpfWNhdGNoKG4pe3JldHVybiBjb25zb2xlLmVycm9yKCJFcnJvciB3aGlsZSBjb252ZXJ0aW5nIGFyZ3VtZW50IHRvIHN0cmluZyIsZSxuKSwiIn19fV0pLG59KCksYWU9ZnVuY3Rpb24oKXt2YXIgZT1uZXcgaWU7cmV0dXJuIGUuZGVidWc9ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS5kZWJ1Zy5hcHBseSh3aW5kb3cuY29uc29sZSxbXS5jb25jYXQobikpfSxlLmluZm89ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS5pbmZvLmFwcGx5KHdpbmRvdy5jb25zb2xlLFtdLmNvbmNhdChuKSl9LGUud2Fybj1mdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiBjb25zb2xlLndhcm4uYXBwbHkod2luZG93LmNvbnNvbGUsW10uY29uY2F0KG4pKX0sZS5lcnJvcj1mdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiBjb25zb2xlLmVycm9yLmFwcGx5KHdpbmRvdy5jb25zb2xlLFtdLmNvbmNhdChuKSl9LGV9LHNlPW5ldyByZTtmdW5jdGlvbiB1ZShlLG4pe2Zvcih2YXIgdD0wO3Q8bi5sZW5ndGg7dCsrKXt2YXIgbz1uW3RdO28uZW51bWVyYWJsZT1vLmVudW1lcmFibGV8fCExLG8uY29uZmlndXJhYmxlPSEwLCJ2YWx1ZSJpbiBvJiYoby53cml0YWJsZT0hMCksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsby5rZXksbyl9fXZhciBsZT1mdW5jdGlvbigpe2Z1bmN0aW9uIGUobil7dmFyIHQ9YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOmE7IWZ1bmN0aW9uKGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9KHRoaXMsZSksdGhpcy5udW1BdHRlbXB0cz0wLHRoaXMuZXhlY3V0b3I9bix0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbj0hMSx0aGlzLmRlZmF1bHRSZXRyeT10fXZhciBuLHQsbztyZXR1cm4gbj1lLCh0PVt7a2V5OiJyZXRyeSIsdmFsdWU6ZnVuY3Rpb24oKXt2YXIgZT10aGlzO3RoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9ufHwodGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITAsc2V0VGltZW91dChmdW5jdGlvbigpe2UuX2V4ZWN1dGUoKX0sdGhpcy5fZ2V0RGVsYXkoKSkpfX0se2tleToiX2V4ZWN1dGUiLHZhbHVlOmZ1bmN0aW9uKCl7dGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITEsdGhpcy5leGVjdXRvcigpLHRoaXMubnVtQXR0ZW1wdHMrK319LHtrZXk6ImNvbm5lY3RlZCIsdmFsdWU6ZnVuY3Rpb24oKXt0aGlzLm51bUF0dGVtcHRzPTB9fSx7a2V5OiJfZ2V0RGVsYXkiLHZhbHVlOmZ1bmN0aW9uKCl7dmFyIGU9TWF0aC5wb3coMix0aGlzLm51bUF0dGVtcHRzKSp0aGlzLmRlZmF1bHRSZXRyeTtyZXR1cm4gZTw9M2U0P2U6M2U0fX0se2tleToiZ2V0SXNDb25uZWN0ZWQiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJuIXRoaXMubnVtQXR0ZW1wdHN9fV0pJiZ1ZShuLnByb3RvdHlwZSx0KSxvJiZ1ZShuLG8pLGV9KCk7dC5kKG4sImEiLGZ1bmN0aW9uKCl7cmV0dXJuIGRlfSk7dmFyIGZlPWZ1bmN0aW9uKCl7dmFyIGU9c2UuZ2V0TG9nZ2VyKHtwcmVmaXg6c30pLG49Vi5pc05ldHdvcmtPbmxpbmUoKSx0PXtwcmltYXJ5Om51bGwsc2Vjb25kYXJ5Om51bGx9LG89e3JlY29ubmVjdFdlYlNvY2tldDohMCx3ZWJzb2NrZXRJbml0RmFpbGVkOiExLGV4cG9uZW50aWFsQmFja09mZlRpbWU6MWUzLGV4cG9uZW50aWFsVGltZW91dEhhbmRsZTpudWxsLGxpZmVUaW1lVGltZW91dEhhbmRsZTpudWxsLHdlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkOm51bGwsY29ublN0YXRlOm51bGx9LHI9e2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OjAsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6bnVsbCxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSxpPXtwZW5kaW5nUmVzcG9uc2U6ITEsaW50ZXJ2YWxIYW5kbGU6bnVsbH0sYz17aW5pdEZhaWx1cmU6bmV3IFNldCxnZXRXZWJTb2NrZXRUcmFuc3BvcnQ6bnVsbCxzdWJzY3JpcHRpb25VcGRhdGU6bmV3IFNldCxzdWJzY3JpcHRpb25GYWlsdXJlOm5ldyBTZXQsdG9waWM6bmV3IE1hcCxhbGxNZXNzYWdlOm5ldyBTZXQsY29ubmVjdGlvbkdhaW46bmV3IFNldCxjb25uZWN0aW9uTG9zdDpuZXcgU2V0LGNvbm5lY3Rpb25PcGVuOm5ldyBTZXQsY29ubmVjdGlvbkNsb3NlOm5ldyBTZXR9LGE9e2Nvbm5Db25maWc6bnVsbCxwcm9taXNlSGFuZGxlOm51bGwscHJvbWlzZUNvbXBsZXRlZDohMH0scT17c3Vic2NyaWJlZDpuZXcgU2V0LHBlbmRpbmc6bmV3IFNldCxzdWJzY3JpcHRpb25IaXN0b3J5Om5ldyBTZXR9LEo9e3Jlc3BvbnNlQ2hlY2tJbnRlcnZhbElkOm51bGwscmVxdWVzdENvbXBsZXRlZDohMCxyZVN1YnNjcmliZUludGVydmFsSWQ6bnVsbCxjb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzOjAsY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdDowfSxCPW5ldyBsZShmdW5jdGlvbigpe2hlKCl9KSxYPW5ldyBTZXQoW0cseixQXSksJD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe2lmKG4hPT1WLmlzTmV0d29ya09ubGluZSgpKXtpZighKG49Vi5pc05ldHdvcmtPbmxpbmUoKSkpcmV0dXJuIGUuYWR2YW5jZWRMb2codSksdm9pZCBDZShlLmluZm8odSkpO3ZhciB0PXRlKCk7biYmKCF0fHxZKHQsV2ViU29ja2V0LkNMT1NJTkcpfHxZKHQsV2ViU29ja2V0LkNMT1NFRCkpJiYoZS5hZHZhbmNlZExvZyhsKSxDZShlLmluZm8obCkpLGhlKCkpfX0sMjUwKSxLPWZ1bmN0aW9uKG4sdCl7bi5mb3JFYWNoKGZ1bmN0aW9uKG4pe3RyeXtuKHQpfWNhdGNoKG4pe0NlKGUuZXJyb3IoIkVycm9yIGV4ZWN1dGluZyBjYWxsYmFjayIsbikpfX0pfSxaPWZ1bmN0aW9uKGUpe2lmKG51bGw9PT1lKXJldHVybiJOVUxMIjtzd2l0Y2goZS5yZWFkeVN0YXRlKXtjYXNlIFdlYlNvY2tldC5DT05ORUNUSU5HOnJldHVybiJDT05ORUNUSU5HIjtjYXNlIFdlYlNvY2tldC5PUEVOOnJldHVybiJPUEVOIjtjYXNlIFdlYlNvY2tldC5DTE9TSU5HOnJldHVybiJDTE9TSU5HIjtjYXNlIFdlYlNvY2tldC5DTE9TRUQ6cmV0dXJuIkNMT1NFRCI7ZGVmYXVsdDpyZXR1cm4iVU5ERUZJTkVEIn19LFE9ZnVuY3Rpb24oKXt2YXIgbj1hcmd1bWVudHMubGVuZ3RoPjAmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT9hcmd1bWVudHNbMF06IiI7Q2UoZS5kZWJ1ZygiWyIrbisiXSBQcmltYXJ5IFdlYlNvY2tldDogIitaKHQucHJpbWFyeSkrIiB8IFNlY29uZGFyeSBXZWJTb2NrZXQ6ICIrWih0LnNlY29uZGFyeSkpKX0sWT1mdW5jdGlvbihlLG4pe3JldHVybiBlJiZlLnJlYWR5U3RhdGU9PT1ufSxlZT1mdW5jdGlvbihlKXtyZXR1cm4gWShlLFdlYlNvY2tldC5PUEVOKX0sbmU9ZnVuY3Rpb24oZSl7cmV0dXJuIG51bGw9PT1lfHx2b2lkIDA9PT1lLnJlYWR5U3RhdGV8fFkoZSxXZWJTb2NrZXQuQ0xPU0VEKX0sdGU9ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXQuc2Vjb25kYXJ5P3Quc2Vjb25kYXJ5OnQucHJpbWFyeX0sb2U9ZnVuY3Rpb24oKXtyZXR1cm4gZWUodGUoKSl9LHJlPWZ1bmN0aW9uKCl7aWYoaS5wZW5kaW5nUmVzcG9uc2UpcmV0dXJuIGUuYWR2YW5jZWRMb2coZCksQ2UoZS53YXJuKGQpKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGkucGVuZGluZ1Jlc3BvbnNlPSExLHZvaWQgaGUoKTtvZSgpPyhDZShlLmRlYnVnKGcpKSx0ZSgpLnNlbmQodmUoUCkpLGkucGVuZGluZ1Jlc3BvbnNlPSEwKTooZS5hZHZhbmNlZExvZyhiKSxDZShlLndhcm4oYikpLFEoInNlbmRIZWFydEJlYXQiKSxoZSgpKX0saWU9ZnVuY3Rpb24oKXtlLmFkdmFuY2VkTG9nKFIpLG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZT0xZTMsaS5wZW5kaW5nUmVzcG9uc2U9ITEsby5yZWNvbm5lY3RXZWJTb2NrZXQ9ITAsY2xlYXJUaW1lb3V0KG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGNsZWFyVGltZW91dChvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZSksY2xlYXJUaW1lb3V0KG8ud2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQpfSxjZT1mdW5jdGlvbigpe0ouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wLEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLGNsZWFySW50ZXJ2YWwoSi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZCksY2xlYXJJbnRlcnZhbChKLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZCl9LGFlPWZ1bmN0aW9uKCl7ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudD0wLHIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU9bnVsbCxyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wPW51bGx9LHVlPWZ1bmN0aW9uKCl7Qi5jb25uZWN0ZWQoKTt0cnl7ZS5hZHZhbmNlZExvZyh5KSxDZShlLmluZm8oeSkpLFEoIndlYlNvY2tldE9uT3BlbiIpLG51bGwhPT1vLmNvbm5TdGF0ZSYmby5jb25uU3RhdGUhPT1VfHxLKGMuY29ubmVjdGlvbkdhaW4pLG8uY29ublN0YXRlPUg7dmFyIG49RGF0ZS5ub3coKTtLKGMuY29ubmVjdGlvbk9wZW4se2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OnIuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wLGNvbm5lY3Rpb25Fc3RhYmxpc2hlZFRpbWU6bix0aW1lVG9Db25uZWN0Om4tci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSx0aW1lV2l0aG91dENvbm5lY3Rpb246ci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD9uLXIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6bnVsbH0pLGFlKCksaWUoKSx0ZSgpLm9wZW5UaW1lc3RhbXA9RGF0ZS5ub3coKSwwPT09cS5zdWJzY3JpYmVkLnNpemUmJmVlKHQuc2Vjb25kYXJ5KSYmZ2UodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IiksKHEuc3Vic2NyaWJlZC5zaXplPjB8fHEucGVuZGluZy5zaXplPjApJiYoZWUodC5zZWNvbmRhcnkpJiZDZShlLmluZm8oIlN1YnNjcmliaW5nIHNlY29uZGFyeSB3ZWJzb2NrZXQgdG8gdG9waWNzIG9mIHByaW1hcnkgd2Vic29ja2V0IikpLHEuc3Vic2NyaWJlZC5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Euc3Vic2NyaXB0aW9uSGlzdG9yeS5hZGQoZSkscS5wZW5kaW5nLmFkZChlKX0pLHEuc3Vic2NyaWJlZC5jbGVhcigpLHBlKCkpLHJlKCksaS5pbnRlcnZhbEhhbmRsZT1zZXRJbnRlcnZhbChyZSwxZTQpO3ZhciBzPTFlMyphLmNvbm5Db25maWcud2ViU29ja2V0VHJhbnNwb3J0LnRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzO0NlKGUuZGVidWcoIlNjaGVkdWxpbmcgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uLCBhZnRlciBkZWxheSAiK3MrIiBtcyIpKSxvLmxpZmVUaW1lVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7Q2UoZS5kZWJ1ZygiU3RhcnRpbmcgc2NoZWR1bGVkIFdlYlNvY2tldCBtYW5hZ2VyIHJlY29ubmVjdGlvbiIpKSxoZSgpfSxzKX1jYXRjaChuKXtDZShlLmVycm9yKCJFcnJvciBhZnRlciBlc3RhYmxpc2hpbmcgV2ViU29ja2V0IGNvbm5lY3Rpb24iLG4pKX19LGZlPWZ1bmN0aW9uKG4pe1EoIndlYlNvY2tldE9uRXJyb3IiKSxlLmFkdmFuY2VkTG9nKHYsSlNPTi5zdHJpbmdpZnkobikpLENlKGUuZXJyb3IodixKU09OLnN0cmluZ2lmeShuKSkpLEIuZ2V0SXNDb25uZWN0ZWQoKT9oZSgpOkIucmV0cnkoKX0sZGU9ZnVuY3Rpb24obil7dmFyIG89SlNPTi5wYXJzZShuLmRhdGEpO3N3aXRjaChvLnRvcGljKXtjYXNlIEc6aWYoQ2UoZS5kZWJ1ZygiU3Vic2NyaXB0aW9uIE1lc3NhZ2UgcmVjZWl2ZWQgZnJvbSB3ZWJTb2NrZXQgc2VydmVyIixuLmRhdGEpKSxKLnJlcXVlc3RDb21wbGV0ZWQ9ITAsSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsInN1Y2Nlc3MiPT09by5jb250ZW50LnN0YXR1cylKLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCxvLmNvbnRlbnQudG9waWNzLmZvckVhY2goZnVuY3Rpb24oZSl7cS5zdWJzY3JpcHRpb25IaXN0b3J5LmRlbGV0ZShlKSxxLnBlbmRpbmcuZGVsZXRlKGUpLHEuc3Vic2NyaWJlZC5hZGQoZSl9KSwwPT09cS5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemU/ZWUodC5zZWNvbmRhcnkpJiYoQ2UoZS5pbmZvKCJTdWNjZXNzZnVsbHkgc3Vic2NyaWJlZCBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIGFsbCB0b3BpY3Mgb2YgcHJpbWFyeSB3ZWJzb2NrZXQiKSksZ2UodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IikpOnBlKCksSyhjLnN1YnNjcmlwdGlvblVwZGF0ZSxvKTtlbHNle2lmKGNsZWFySW50ZXJ2YWwoSi5yZVN1YnNjcmliZUludGVydmFsSWQpLCsrSi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzLDU9PT1KLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHMpcmV0dXJuIEsoYy5zdWJzY3JpcHRpb25GYWlsdXJlLG8pLHZvaWQoSi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTApO0oucmVTdWJzY3JpYmVJbnRlcnZhbElkPXNldEludGVydmFsKGZ1bmN0aW9uKCl7cGUoKX0sNTAwKX1icmVhaztjYXNlIFA6Q2UoZS5kZWJ1ZyhwKSksaS5wZW5kaW5nUmVzcG9uc2U9ITE7YnJlYWs7ZGVmYXVsdDppZihvLnRvcGljKXtpZihlLmFkdmFuY2VkTG9nKEQsby50b3BpYyksQ2UoZS5kZWJ1ZyhEK28udG9waWMpKSxlZSh0LnByaW1hcnkpJiZlZSh0LnNlY29uZGFyeSkmJjA9PT1xLnN1YnNjcmlwdGlvbkhpc3Rvcnkuc2l6ZSYmdGhpcz09PXQucHJpbWFyeSlyZXR1cm4gdm9pZCBDZShlLndhcm4oIklnbm9yaW5nIE1lc3NhZ2UgZm9yIFRvcGljICIrby50b3BpYysiLCB0byBhdm9pZCBkdXBsaWNhdGVzIikpO2lmKDA9PT1jLmFsbE1lc3NhZ2Uuc2l6ZSYmMD09PWMudG9waWMuc2l6ZSlyZXR1cm4gdm9pZCBDZShlLndhcm4oIk5vIHJlZ2lzdGVyZWQgY2FsbGJhY2sgbGlzdGVuZXIgZm9yIFRvcGljIixvLnRvcGljKSk7ZS5hZHZhbmNlZExvZyhNLG8udG9waWMpLEsoYy5hbGxNZXNzYWdlLG8pLGMudG9waWMuaGFzKG8udG9waWMpJiZLKGMudG9waWMuZ2V0KG8udG9waWMpLG8pfWVsc2Ugby5tZXNzYWdlPyhlLmFkdmFuY2VkTG9nKHgsbyksQ2UoZS53YXJuKHgsbykpKTooZS5hZHZhbmNlZExvZyhqLG8pLENlKGUud2FybihqLG8pKSl9fSxwZT1mdW5jdGlvbiBuKCl7aWYoSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PjMpcmV0dXJuIENlKGUud2FybigiSWdub3Jpbmcgc3Vic2NyaWJlUGVuZGluZ1RvcGljcyBzaW5jZSB3ZSBoYXZlIGV4aGF1c3RlZCBtYXggc3Vic2NyaXB0aW9uIHJldHJpZXMgd2l0aCBubyByZXNwb25zZSIpKSx2b2lkIEsoYy5zdWJzY3JpcHRpb25GYWlsdXJlLFYuZ2V0U3Vic2NyaXB0aW9uUmVzcG9uc2UoRywhMSxBcnJheS5mcm9tKHEucGVuZGluZykpKTtvZSgpPzAhPT1BcnJheS5mcm9tKHEucGVuZGluZykubGVuZ3RoJiYoY2xlYXJJbnRlcnZhbChKLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkKSx0ZSgpLnNlbmQodmUoRyx7dG9waWNzOkFycmF5LmZyb20ocS5wZW5kaW5nKX0pKSxKLnJlcXVlc3RDb21wbGV0ZWQ9ITEsSi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe0oucmVxdWVzdENvbXBsZXRlZHx8KCsrSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0LG4oKSl9LDFlMykpOkNlKGUud2FybigiSWdub3Jpbmcgc3Vic2NyaWJlUGVuZGluZ1RvcGljcyBjYWxsIHNpbmNlIERlZmF1bHQgV2ViU29ja2V0IGlzIG5vdCBvcGVuIikpfSxnZT1mdW5jdGlvbihuLHQpe1kobixXZWJTb2NrZXQuQ09OTkVDVElORyl8fFkobixXZWJTb2NrZXQuT1BFTik/bi5jbG9zZSgxZTMsdCk6Q2UoZS53YXJuKCJJZ25vcmluZyBXZWJTb2NrZXQgQ2xvc2UgcmVxdWVzdCwgV2ViU29ja2V0IFN0YXRlOiAiK1oobikpKX0sYmU9ZnVuY3Rpb24oZSl7Z2UodC5wcmltYXJ5LCJbUHJpbWFyeV0gV2ViU29ja2V0ICIrZSksZ2UodC5zZWNvbmRhcnksIltTZWNvbmRhcnldIFdlYlNvY2tldCAiK2UpfSx5ZT1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQrKzt2YXIgbj1WLmFkZEppdHRlcihvLmV4cG9uZW50aWFsQmFja09mZlRpbWUsLjMpO0RhdGUubm93KCkrbjw9YS5jb25uQ29uZmlnLnVybENvbm5WYWxpZFRpbWU/KGUuYWR2YW5jZWRMb2coUyksQ2UoZS5kZWJ1ZyhTK24rIiBtcyIpKSxvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7cmV0dXJuIGtlKCl9LG4pLG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZSo9Mik6KGUuYWR2YW5jZWRMb2coaCksQ2UoZS53YXJuKGgpKSxoZSgpKX0sbWU9ZnVuY3Rpb24obil7aWUoKSxjZSgpLGUuYWR2YW5jZWRMb2coayxuKSxDZShlLmVycm9yKGspKSxvLndlYnNvY2tldEluaXRGYWlsZWQ9ITAsYmUodyksY2xlYXJJbnRlcnZhbCgkKSxLKGMuaW5pdEZhaWx1cmUse2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OnIuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSxyZWFzb246bn0pLGFlKCl9LHZlPWZ1bmN0aW9uKGUsbil7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHt0b3BpYzplLGNvbnRlbnQ6bn0pfSxTZT1mdW5jdGlvbihuKXtyZXR1cm4hIShWLmlzT2JqZWN0KG4pJiZWLmlzT2JqZWN0KG4ud2ViU29ja2V0VHJhbnNwb3J0KSYmVi5pc05vbkVtcHR5U3RyaW5nKG4ud2ViU29ja2V0VHJhbnNwb3J0LnVybCkmJlYudmFsaWRXU1VybChuLndlYlNvY2tldFRyYW5zcG9ydC51cmwpJiYxZTMqbi53ZWJTb2NrZXRUcmFuc3BvcnQudHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHM+PTNlNSl8fChDZShlLmVycm9yKCJJbnZhbGlkIFdlYlNvY2tldCBDb25uZWN0aW9uIENvbmZpZ3VyYXRpb24iLG4pKSwhMSl9LGhlPWZ1bmN0aW9uKCl7aWYoIVYuaXNOZXR3b3JrT25saW5lKCkpcmV0dXJuIGUuYWR2YW5jZWRMb2coZiksdm9pZCBDZShlLmluZm8oZikpO2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClDZShlLmRlYnVnKCJXZWJTb2NrZXQgSW5pdCBoYWQgZmFpbGVkLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpKTtlbHNle2lmKGEucHJvbWlzZUNvbXBsZXRlZClyZXR1cm4gaWUoKSxlLmFkdmFuY2VkTG9nKEMpLENlKGUuaW5mbyhDKSksci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZT1yLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lfHxEYXRlLm5vdygpLGEucHJvbWlzZUNvbXBsZXRlZD0hMSxhLnByb21pc2VIYW5kbGU9Yy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQoKSxhLnByb21pc2VIYW5kbGUudGhlbihmdW5jdGlvbihuKXtyZXR1cm4gYS5wcm9taXNlQ29tcGxldGVkPSEwLGUuYWR2YW5jZWRMb2coTCksQ2UoZS5kZWJ1ZyhMLG4pKSxTZShuKT8oYS5jb25uQ29uZmlnPW4sYS5jb25uQ29uZmlnLnVybENvbm5WYWxpZFRpbWU9RGF0ZS5ub3coKSs4NWUzLGtlKCkpOihtZSgiSW52YWxpZCBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK24pLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfSl9LGZ1bmN0aW9uKG4pe3JldHVybiBhLnByb21pc2VDb21wbGV0ZWQ9ITAsZS5hZHZhbmNlZExvZyhUKSxDZShlLmVycm9yKFQsbikpLFYuaXNOZXR3b3JrRmFpbHVyZShuKT8oZS5hZHZhbmNlZExvZyhPK0pTT04uc3RyaW5naWZ5KG4pKSxDZShlLmluZm8oTytKU09OLnN0cmluZ2lmeShuKSkpLEIucmV0cnkoKSk6bWUoIkZhaWxlZCB0byBmZXRjaCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK0pTT04uc3RyaW5naWZ5KG4pKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH19KTtDZShlLmRlYnVnKCJUaGVyZSBpcyBhbiBvbmdvaW5nIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCwgdGhpcyByZXF1ZXN0IHdpbGwgYmUgaWdub3JlZCIpKX19LGtlPWZ1bmN0aW9uKCl7aWYoby53ZWJzb2NrZXRJbml0RmFpbGVkKXJldHVybiBDZShlLmluZm8oIndlYi1zb2NrZXQgaW5pdGlhbGl6aW5nIGhhZCBmYWlsZWQsIGFib3J0aW5nIHJlLWluaXQiKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2lmKCFWLmlzTmV0d29ya09ubGluZSgpKXJldHVybiBDZShlLndhcm4oIlN5c3RlbSBpcyBvZmZsaW5lIGFib3J0aW5nIHdlYi1zb2NrZXQgaW5pdCIpKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH07ZS5hZHZhbmNlZExvZyhXKSxDZShlLmluZm8oVykpLFEoImluaXRXZWJTb2NrZXQiKTt0cnl7aWYoU2UoYS5jb25uQ29uZmlnKSl7dmFyIG49bnVsbDtyZXR1cm4gZWUodC5wcmltYXJ5KT8oQ2UoZS5kZWJ1ZygiUHJpbWFyeSBTb2NrZXQgY29ubmVjdGlvbiBpcyBhbHJlYWR5IG9wZW4iKSksWSh0LnNlY29uZGFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChDZShlLmRlYnVnKCJFc3RhYmxpc2hpbmcgYSBzZWNvbmRhcnkgd2ViLXNvY2tldCBjb25uZWN0aW9uIikpLEIubnVtQXR0ZW1wdHM9MCx0LnNlY29uZGFyeT13ZSgpKSxuPXQuc2Vjb25kYXJ5KTooWSh0LnByaW1hcnksV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHwoQ2UoZS5kZWJ1ZygiRXN0YWJsaXNoaW5nIGEgcHJpbWFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSksdC5wcmltYXJ5PXdlKCkpLG49dC5wcmltYXJ5KSxvLndlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtlZShuKXx8eWUoKX0sMWUzKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMX19fWNhdGNoKG4pe3JldHVybiBDZShlLmVycm9yKCJFcnJvciBJbml0aWFsaXppbmcgd2ViLXNvY2tldC1tYW5hZ2VyIixuKSksbWUoIkZhaWxlZCB0byBpbml0aWFsaXplIG5ldyBXZWJTb2NrZXQ6ICIrbi5tZXNzYWdlKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH19fSx3ZT1mdW5jdGlvbigpe3ZhciBuPW5ldyBXZWJTb2NrZXQoYS5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC51cmwpO3JldHVybiBuLmFkZEV2ZW50TGlzdGVuZXIoIm9wZW4iLHVlKSxuLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLGRlKSxuLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIixmZSksbi5hZGRFdmVudExpc3RlbmVyKCJjbG9zZSIsZnVuY3Rpb24oaSl7cmV0dXJuIGZ1bmN0aW9uKG4saSl7ZS5hZHZhbmNlZExvZyhtLEpTT04uc3RyaW5naWZ5KG4pKSxDZShlLmluZm8obSxKU09OLnN0cmluZ2lmeShuKSkpLFEoIndlYlNvY2tldE9uQ2xvc2UgYmVmb3JlLWNsZWFudXAiKSxLKGMuY29ubmVjdGlvbkNsb3NlLHtvcGVuVGltZXN0YW1wOmkub3BlblRpbWVzdGFtcCxjbG9zZVRpbWVzdGFtcDpEYXRlLm5vdygpLGNvbm5lY3Rpb25EdXJhdGlvbjpEYXRlLm5vdygpLWkub3BlblRpbWVzdGFtcCxjb2RlOm4uY29kZSxyZWFzb246bi5yZWFzb259KSxuZSh0LnByaW1hcnkpJiYodC5wcmltYXJ5PW51bGwpLG5lKHQuc2Vjb25kYXJ5KSYmKHQuc2Vjb25kYXJ5PW51bGwpLG8ucmVjb25uZWN0V2ViU29ja2V0JiYoZWUodC5wcmltYXJ5KXx8ZWUodC5zZWNvbmRhcnkpP25lKHQucHJpbWFyeSkmJmVlKHQuc2Vjb25kYXJ5KSYmKENlKGUuaW5mbygiW1ByaW1hcnldIFdlYlNvY2tldCBDbGVhbmx5IENsb3NlZCIpKSx0LnByaW1hcnk9dC5zZWNvbmRhcnksdC5zZWNvbmRhcnk9bnVsbCk6KENlKGUud2FybigiTmVpdGhlciBwcmltYXJ5IHdlYnNvY2tldCBhbmQgbm9yIHNlY29uZGFyeSB3ZWJzb2NrZXQgaGF2ZSBvcGVuIGNvbm5lY3Rpb25zLCBhdHRlbXB0aW5nIHRvIHJlLWVzdGFibGlzaCBjb25uZWN0aW9uIikpLG8uY29ublN0YXRlPT09VT9DZShlLmluZm8oIklnbm9yaW5nIGNvbm5lY3Rpb25Mb3N0IGNhbGxiYWNrIGludm9jYXRpb24iKSk6KEsoYy5jb25uZWN0aW9uTG9zdCx7b3BlblRpbWVzdGFtcDppLm9wZW5UaW1lc3RhbXAsY2xvc2VUaW1lc3RhbXA6RGF0ZS5ub3coKSxjb25uZWN0aW9uRHVyYXRpb246RGF0ZS5ub3coKS1pLm9wZW5UaW1lc3RhbXAsY29kZTpuLmNvZGUscmVhc29uOm4ucmVhc29ufSksci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD1EYXRlLm5vdygpKSxvLmNvbm5TdGF0ZT1VLGhlKCkpLFEoIndlYlNvY2tldE9uQ2xvc2UgYWZ0ZXItY2xlYW51cCIpKX0oaSxuKX0pLG59LENlPWZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlciYmZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpLGV9O3RoaXMuaW5pdD1mdW5jdGlvbihuKXtpZihWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJ0cmFuc3BvcnRIYW5kbGUgbXVzdCBiZSBhIGZ1bmN0aW9uIiksbnVsbD09PWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KXJldHVybiBjLmdldFdlYlNvY2tldFRyYW5zcG9ydD1uLGhlKCk7Q2UoZS53YXJuKCJXZWIgU29ja2V0IE1hbmFnZXIgd2FzIGFscmVhZHkgaW5pdGlhbGl6ZWQiKSl9LHRoaXMub25Jbml0RmFpbHVyZT1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhJKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmluaXRGYWlsdXJlLmFkZChuKSxvLndlYnNvY2tldEluaXRGYWlsZWQmJm4oKSxmdW5jdGlvbigpe3JldHVybiBjLmluaXRGYWlsdXJlLmRlbGV0ZShuKX19LHRoaXMub25Db25uZWN0aW9uT3Blbj1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhOKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25PcGVuLmFkZChuKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShuKX19LHRoaXMub25Db25uZWN0aW9uQ2xvc2U9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coXyksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uQ2xvc2UuYWRkKG4pLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkNsb3NlLmRlbGV0ZShuKX19LHRoaXMub25Db25uZWN0aW9uR2Fpbj1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhFKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25HYWluLmFkZChuKSxvZSgpJiZuKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uR2Fpbi5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbkxvc3Q9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coRiksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uTG9zdC5hZGQobiksby5jb25uU3RhdGU9PT1VJiZuKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uTG9zdC5kZWxldGUobil9fSx0aGlzLm9uU3Vic2NyaXB0aW9uVXBkYXRlPWZ1bmN0aW9uKGUpe3JldHVybiBWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnN1YnNjcmlwdGlvblVwZGF0ZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5zdWJzY3JpcHRpb25VcGRhdGUuZGVsZXRlKGUpfX0sdGhpcy5vblN1YnNjcmlwdGlvbkZhaWx1cmU9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coQSksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChuKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKG4pfX0sdGhpcy5vbk1lc3NhZ2U9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gVi5hc3NlcnROb3ROdWxsKGUsInRvcGljTmFtZSIpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMudG9waWMuaGFzKGUpP2MudG9waWMuZ2V0KGUpLmFkZChuKTpjLnRvcGljLnNldChlLG5ldyBTZXQoW25dKSksZnVuY3Rpb24oKXtyZXR1cm4gYy50b3BpYy5nZXQoZSkuZGVsZXRlKG4pfX0sdGhpcy5vbkFsbE1lc3NhZ2U9ZnVuY3Rpb24oZSl7cmV0dXJuIFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuYWxsTWVzc2FnZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5hbGxNZXNzYWdlLmRlbGV0ZShlKX19LHRoaXMuc3Vic2NyaWJlVG9waWNzPWZ1bmN0aW9uKGUpe1YuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY3MiKSxWLmFzc2VydElzTGlzdChlKSxlLmZvckVhY2goZnVuY3Rpb24oZSl7cS5zdWJzY3JpYmVkLmhhcyhlKXx8cS5wZW5kaW5nLmFkZChlKX0pLEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLHBlKCl9LHRoaXMuc2VuZE1lc3NhZ2U9ZnVuY3Rpb24obil7aWYoVi5hc3NlcnRJc09iamVjdChuLCJwYXlsb2FkIiksdm9pZCAwPT09bi50b3BpY3x8WC5oYXMobi50b3BpYykpQ2UoZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCBJbnZhbGlkIHRvcGljIixuKSk7ZWxzZXt0cnl7bj1KU09OLnN0cmluZ2lmeShuKX1jYXRjaCh0KXtyZXR1cm4gdm9pZCBDZShlLndhcm4oIkVycm9yIHN0cmluZ2lmeSBtZXNzYWdlIixuKSl9b2UoKT90ZSgpLnNlbmQobik6Q2UoZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gaXMgbm90IG9wZW4iKSl9fSx0aGlzLmNsb3NlV2ViU29ja2V0PWZ1bmN0aW9uKCl7aWUoKSxjZSgpLG8ucmVjb25uZWN0V2ViU29ja2V0PSExLGNsZWFySW50ZXJ2YWwoJCksYmUoIlVzZXIgcmVxdWVzdCB0byBjbG9zZSBXZWJTb2NrZXQiKX0sdGhpcy50ZXJtaW5hdGVXZWJTb2NrZXRNYW5hZ2VyPW1lfSxkZT17Y3JlYXRlOmZ1bmN0aW9uKCl7cmV0dXJuIG5ldyBmZX0sc2V0R2xvYmFsQ29uZmlnOmZ1bmN0aW9uKGUpe3ZhciBuPWUmJmUubG9nZ2VyQ29uZmlnO3NlLnVwZGF0ZUxvZ2dlckNvbmZpZyhuKX0sTG9nTGV2ZWw6b2UsTG9nZ2VyOm5lfX0sZnVuY3Rpb24oZSxuLHQpe3ZhciBvOyFmdW5jdGlvbigpeyJ1c2Ugc3RyaWN0Ijt2YXIgcj17bm90X3N0cmluZzovW15zXS8sbm90X2Jvb2w6L1tedF0vLG5vdF90eXBlOi9bXlRdLyxub3RfcHJpbWl0aXZlOi9bXnZdLyxudW1iZXI6L1tkaWVmZ10vLG51bWVyaWNfYXJnOi9bYmNkaWVmZ3V4WF0vLGpzb246L1tqXS8sbm90X2pzb246L1teal0vLHRleHQ6L15bXlx4MjVdKy8sbW9kdWxvOi9eXHgyNXsyfS8scGxhY2Vob2xkZXI6L15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWdpam9zdFR1dnhYXSkvLGtleTovXihbYS16X11bYS16X1xkXSopL2ksa2V5X2FjY2VzczovXlwuKFthLXpfXVthLXpfXGRdKikvaSxpbmRleF9hY2Nlc3M6L15cWyhcZCspXF0vLHNpZ246L15bKy1dL307ZnVuY3Rpb24gaShlKXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgdCxvLGMsYSxzLHUsbCxmLGQscD0xLGc9ZS5sZW5ndGgsYj0iIjtmb3Iobz0wO288ZztvKyspaWYoInN0cmluZyI9PXR5cGVvZiBlW29dKWIrPWVbb107ZWxzZSBpZigib2JqZWN0Ij09dHlwZW9mIGVbb10pe2lmKChhPWVbb10pLmtleXMpZm9yKHQ9bltwXSxjPTA7YzxhLmtleXMubGVuZ3RoO2MrKyl7aWYobnVsbD09dCl0aHJvdyBuZXcgRXJyb3IoaSgnW3NwcmludGZdIENhbm5vdCBhY2Nlc3MgcHJvcGVydHkgIiVzIiBvZiB1bmRlZmluZWQgdmFsdWUgIiVzIicsYS5rZXlzW2NdLGEua2V5c1tjLTFdKSk7dD10W2Eua2V5c1tjXV19ZWxzZSB0PWEucGFyYW1fbm8/blthLnBhcmFtX25vXTpuW3ArK107aWYoci5ub3RfdHlwZS50ZXN0KGEudHlwZSkmJnIubm90X3ByaW1pdGl2ZS50ZXN0KGEudHlwZSkmJnQgaW5zdGFuY2VvZiBGdW5jdGlvbiYmKHQ9dCgpKSxyLm51bWVyaWNfYXJnLnRlc3QoYS50eXBlKSYmIm51bWJlciIhPXR5cGVvZiB0JiZpc05hTih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKGkoIltzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlVCIsdCkpO3N3aXRjaChyLm51bWJlci50ZXN0KGEudHlwZSkmJihmPXQ+PTApLGEudHlwZSl7Y2FzZSJiIjp0PXBhcnNlSW50KHQsMTApLnRvU3RyaW5nKDIpO2JyZWFrO2Nhc2UiYyI6dD1TdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KHQsMTApKTticmVhaztjYXNlImQiOmNhc2UiaSI6dD1wYXJzZUludCh0LDEwKTticmVhaztjYXNlImoiOnQ9SlNPTi5zdHJpbmdpZnkodCxudWxsLGEud2lkdGg/cGFyc2VJbnQoYS53aWR0aCk6MCk7YnJlYWs7Y2FzZSJlIjp0PWEucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbChhLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KS50b0V4cG9uZW50aWFsKCk7YnJlYWs7Y2FzZSJmIjp0PWEucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9GaXhlZChhLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KTticmVhaztjYXNlImciOnQ9YS5wcmVjaXNpb24/U3RyaW5nKE51bWJlcih0LnRvUHJlY2lzaW9uKGEucHJlY2lzaW9uKSkpOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJvIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDgpO2JyZWFrO2Nhc2UicyI6dD1TdHJpbmcodCksdD1hLnByZWNpc2lvbj90LnN1YnN0cmluZygwLGEucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UidCI6dD1TdHJpbmcoISF0KSx0PWEucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAsYS5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJUIjp0PU9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0KS5zbGljZSg4LC0xKS50b0xvd2VyQ2FzZSgpLHQ9YS5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxhLnByZWNpc2lvbik6dDticmVhaztjYXNlInUiOnQ9cGFyc2VJbnQodCwxMCk+Pj4wO2JyZWFrO2Nhc2UidiI6dD10LnZhbHVlT2YoKSx0PWEucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAsYS5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ4Ijp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KTticmVhaztjYXNlIlgiOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCl9ci5qc29uLnRlc3QoYS50eXBlKT9iKz10Oighci5udW1iZXIudGVzdChhLnR5cGUpfHxmJiYhYS5zaWduP2Q9IiI6KGQ9Zj8iKyI6Ii0iLHQ9dC50b1N0cmluZygpLnJlcGxhY2Uoci5zaWduLCIiKSksdT1hLnBhZF9jaGFyPyIwIj09PWEucGFkX2NoYXI/IjAiOmEucGFkX2NoYXIuY2hhckF0KDEpOiIgIixsPWEud2lkdGgtKGQrdCkubGVuZ3RoLHM9YS53aWR0aCYmbD4wP3UucmVwZWF0KGwpOiIiLGIrPWEuYWxpZ24/ZCt0K3M6IjAiPT09dT9kK3MrdDpzK2QrdCl9cmV0dXJuIGJ9KGZ1bmN0aW9uKGUpe2lmKGFbZV0pcmV0dXJuIGFbZV07dmFyIG4sdD1lLG89W10saT0wO2Zvcig7dDspe2lmKG51bGwhPT0obj1yLnRleHQuZXhlYyh0KSkpby5wdXNoKG5bMF0pO2Vsc2UgaWYobnVsbCE9PShuPXIubW9kdWxvLmV4ZWModCkpKW8ucHVzaCgiJSIpO2Vsc2V7aWYobnVsbD09PShuPXIucGxhY2Vob2xkZXIuZXhlYyh0KSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gdW5leHBlY3RlZCBwbGFjZWhvbGRlciIpO2lmKG5bMl0pe2l8PTE7dmFyIGM9W10scz1uWzJdLHU9W107aWYobnVsbD09PSh1PXIua2V5LmV4ZWMocykpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtmb3IoYy5wdXNoKHVbMV0pOyIiIT09KHM9cy5zdWJzdHJpbmcodVswXS5sZW5ndGgpKTspaWYobnVsbCE9PSh1PXIua2V5X2FjY2Vzcy5leGVjKHMpKSljLnB1c2godVsxXSk7ZWxzZXtpZihudWxsPT09KHU9ci5pbmRleF9hY2Nlc3MuZXhlYyhzKSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gZmFpbGVkIHRvIHBhcnNlIG5hbWVkIGFyZ3VtZW50IGtleSIpO2MucHVzaCh1WzFdKX1uWzJdPWN9ZWxzZSBpfD0yO2lmKDM9PT1pKXRocm93IG5ldyBFcnJvcigiW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCIpO28ucHVzaCh7cGxhY2Vob2xkZXI6blswXSxwYXJhbV9ubzpuWzFdLGtleXM6blsyXSxzaWduOm5bM10scGFkX2NoYXI6bls0XSxhbGlnbjpuWzVdLHdpZHRoOm5bNl0scHJlY2lzaW9uOm5bN10sdHlwZTpuWzhdfSl9dD10LnN1YnN0cmluZyhuWzBdLmxlbmd0aCl9cmV0dXJuIGFbZV09b30oZSksYXJndW1lbnRzKX1mdW5jdGlvbiBjKGUsbil7cmV0dXJuIGkuYXBwbHkobnVsbCxbZV0uY29uY2F0KG58fFtdKSl9dmFyIGE9T2JqZWN0LmNyZWF0ZShudWxsKTtuLnNwcmludGY9aSxuLnZzcHJpbnRmPWMsInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJih3aW5kb3cuc3ByaW50Zj1pLHdpbmRvdy52c3ByaW50Zj1jLHZvaWQgMD09PShvPWZ1bmN0aW9uKCl7cmV0dXJue3NwcmludGY6aSx2c3ByaW50ZjpjfX0uY2FsbChuLHQsbixlKSl8fChlLmV4cG9ydHM9bykpfSgpfSxmdW5jdGlvbihlLG4sdCl7InVzZSBzdHJpY3QiO3QucihuKSxmdW5jdGlvbihlKXt0LmQobiwiV2ViU29ja2V0TWFuYWdlciIsZnVuY3Rpb24oKXtyZXR1cm4gcn0pO3ZhciBvPXQoMCk7ZS5jb25uZWN0PWUuY29ubmVjdHx8e30sY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyPW8uYTt2YXIgcj1vLmF9LmNhbGwodGhpcyx0KDMpKX0sZnVuY3Rpb24oZSxuKXt2YXIgdDt0PWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3Q9dHx8bmV3IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCl9Y2F0Y2goZSl7Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJih0PXdpbmRvdyl9ZS5leHBvcnRzPXR9XSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWFtYXpvbi1jb25uZWN0LXdlYnNvY2tldC1tYW5hZ2VyLmpzLm1hcAoKCi8qKiovIH0pLAoKLyoqKi8gMTUxOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgc29mdHBob25lIGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgcmVwb3J0ZWQgdG8gc2hhcmVkIHdvcmtlci4KICB2YXIgU09GVFBIT05FX0xPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCBzZW50IGRvd25zdHJlYW0KICB2YXIgTE9HU19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gVGhlIGRlZmF1bHQgbG9nIHJvbGwgaW50ZXJ2YWwgKDMwbWluKQogIHZhciBERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMID0gMTgwMDAwMDsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgbGV2ZWxzLgogICAqLwogIHZhciBMb2dMZXZlbCA9IHsKICAgIFRFU1Q6ICJURVNUIiwKICAgIFRSQUNFOiAiVFJBQ0UiLAogICAgREVCVUc6ICJERUJVRyIsCiAgICBJTkZPOiAiSU5GTyIsCiAgICBMT0c6ICJMT0ciLAogICAgV0FSTjogIldBUk4iLAogICAgRVJST1I6ICJFUlJPUiIsCiAgICBDUklUSUNBTDogIkNSSVRJQ0FMIgogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIGNvbW1vbiBsb2dnaW5nIGNvbXBvbmVudHMuCiAgICovCiAgdmFyIExvZ0NvbXBvbmVudCA9IHsKICAgIENDUDogImNjcCIsCiAgICBTT0ZUUEhPTkU6ICJzb2Z0cGhvbmUiLAogICAgQ0hBVDogImNoYXQiLAogICAgVEFTSzogInRhc2siCiAgfTsKCiAgLyoqCiAgICogVGhlIG51bWVyaWMgb3JkZXIgb2YgdGhlIGxvZ2dpbmcgbGV2ZWxzIGFib3ZlLgogICAqIFRoZXkgYXJlIHNwYWNlZCB0byBhbGxvdyB0aGUgYWRkaXRpb24gb2Ygb3RoZXIgbG9nCiAgICogbGV2ZWxzIGF0IGEgbGF0ZXIgdGltZS4KICAgKi8KICB2YXIgTG9nTGV2ZWxPcmRlciA9IHsKICAgIFRFU1Q6IDAsCiAgICBUUkFDRTogMTAsCiAgICBERUJVRzogMjAsCiAgICBJTkZPOiAzMCwKICAgIExPRzogNDAsCiAgICBXQVJOOiA1MCwKICAgIEVSUk9SOiAxMDAsCiAgICBDUklUSUNBTDogMjAwCgogIH07CgogIC8qKgogICAqIEEgbWFwIGZyb20gbG9nIGxldmVsIHRvIGNvbnNvbGUgbG9nZ2VyIGZ1bmN0aW9uLgogICAqLwogIHZhciBDT05TT0xFX0xPR0dFUl9NQVAgPSB7CiAgICBUUkFDRTogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgREVCVUc6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIElORk86IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIExPRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5sb2codGV4dCk7IH0sCiAgICBURVNUOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFdBUk46IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUud2Fybih0ZXh0KTsgfSwKICAgIEVSUk9SOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmVycm9yKHRleHQpOyB9LAogICAgQ1JJVElDQUw6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0KICB9OwoKICAvKioKICAqIENoZWNrcyBpZiBpdCBpcyBhIHZhbGlkIGxvZyBjb21wb25lbnQgZW51bQogICovCgogIHZhciBpc1ZhbGlkTG9nQ29tcG9uZW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgewogICAgcmV0dXJuIE9iamVjdC52YWx1ZXMoTG9nQ29tcG9uZW50KS5pbmRleE9mKGNvbXBvbmVudCkgIT09IC0xOwogIH07CgogIC8qKgogICogRXh0cmFjdCB0aGUgY3VzdG9tIGFyZ3VtZW50cyBhcyByZXF1aXJlZCBieSB0aGUgbG9nZ2VyCiAgKi8KICB2YXIgZXh0cmFjdExvZ2dlckFyZ3MgPSBmdW5jdGlvbiAobG9nZ2VyQXJncykgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsb2dnZXJBcmdzLCAwKTsKICAgIHZhciBmaXJzdEFyZyA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBmb3JtYXQ7CiAgICB2YXIgY29tcG9uZW50OwoKICAgIGlmIChpc1ZhbGlkTG9nQ29tcG9uZW50KGZpcnN0QXJnKSkgewogICAgICBjb21wb25lbnQgPSBmaXJzdEFyZzsKICAgICAgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgLy9kZWZhdWx0IHRvIENDUCBjb21wb25lbnQKICAgICAgZm9ybWF0ID0gZmlyc3RBcmc7CiAgICAgIGNvbXBvbmVudCA9IExvZ0NvbXBvbmVudC5DQ1A7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZm9ybWF0OiBmb3JtYXQsCiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50LAogICAgICBhcmdzOiBhcmdzCiAgICB9OwogIH07CgogIC8qKgogICAqIEEgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGNvbXBvbmVudCBUaGUgbG9nZ2luZyBjb21wb25lbnQuCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2cgbGV2ZWwgb2YgdGhpcyBsb2cgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGFpbmVkIGluIHRoZSBsb2cgZW50cnkuCiAgICogQHBhcmFtIGxvZ2dlcklkIFRoZSByb290IGxvZ2dlciBpZC4KICAgKgogICAqIExvZyBlbnRyaWVzIGFyZSBhd2FyZSBvZiB0aGVpciB0aW1lc3RhbXAsIG9yZGVyLAogICAqIGFuZCBjYW4gY29udGFpbiBvYmplY3RzIGFuZCBleGNlcHRpb24gc3RhY2sgdHJhY2VzLgogICAqLwogIHZhciBMb2dFbnRyeSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0LCBsb2dnZXJJZCkgewogICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICB0aGlzLmxldmVsID0gbGV2ZWw7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy50aW1lID0gbmV3IERhdGUoKTsKICAgIHRoaXMuZXhjZXB0aW9uID0gbnVsbDsKICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgdGhpcy5saW5lID0gMDsKICAgIHRoaXMuYWdlbnRSZXNvdXJjZUlkID0gbnVsbDsKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKXsKICAgICAgICB0aGlzLmFnZW50UmVzb3VyY2VJZCA9IG5ldyBjb25uZWN0LkFnZW50KCkuX2dldFJlc291cmNlSWQoKTsKICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbnNvbGUubG9nKCJJc3N1ZSBmaW5kaW5nIGFnZW50UmVzb3VyY2VJZDogIiwgZSk7IC8vY2FuJ3QgdXNlIG91ciBsb2dnZXIgaGVyZSBhcyB3ZSBtaWdodCBpbmZpbml0ZWx5IGF0dGVtcHQgdG8gbG9nIHRoaXMgZXJyb3IuCiAgICB9CiAgICB0aGlzLmxvZ2dlcklkID0gbG9nZ2VySWQ7CiAgfTsKCiAgTG9nRW50cnkuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBlbnRyeSA9IG5ldyBMb2dFbnRyeShMb2dDb21wb25lbnQuQ0NQLCBvYmoubGV2ZWwsIG9iai50ZXh0LCBvYmoubG9nZ2VySWQpOwoKICAgIC8vIFJlcXVpcmVkIHRvIGNoZWNrIGZvciBEYXRlIG9iamVjdHMgc2VudCBhY3Jvc3MgZnJhbWUgYm91bmRhcmllcwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmoudGltZSkgPT09ICdbb2JqZWN0IERhdGVdJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUuZ2V0VGltZSgpKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai50aW1lID09PSAnbnVtYmVyJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBEYXRlLnBhcnNlKG9iai50aW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZSgpOwogICAgfQogICAgZW50cnkuZXhjZXB0aW9uID0gb2JqLmV4Y2VwdGlvbjsKICAgIGVudHJ5Lm9iamVjdHMgPSBvYmoub2JqZWN0czsKICAgIHJldHVybiBlbnRyeTsKICB9OwoKICAvKioKICAgKiBQcml2YXRlIG1ldGhvZCB0byByZW1vdmUgc2Vuc2l0aXZlIGluZm8gZnJvbSBjbGllbnQgbG9nCiAgICovCiAgdmFyIHJlZGFjdFNlbnNpdGl2ZUluZm8gPSBmdW5jdGlvbihkYXRhKSB7CiAgICB2YXIgYXV0aFRva2VuUmVnZXggPSAvQXV0aFRva2VuLipcPS9nOwogICAgaWYoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHsKICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZiAodHlwZW9mIGRhdGFba2V5XSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oZGF0YVtrZXldKQogICAgICAgIH0gZWxzZSBpZih0eXBlb2YgZGF0YVtrZXldID09PSAnc3RyaW5nJykgewogICAgICAgICAgaWYgKGtleSA9PT0gInVybCIgfHwga2V5ID09PSAidGV4dCIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gZGF0YVtrZXldLnJlcGxhY2UoYXV0aFRva2VuUmVnZXgsICJbcmVkYWN0ZWRdIik7CiAgICAgICAgICB9IGVsc2UgaWYgKFsicXVpY2tDb25uZWN0TmFtZSJdLmluY2x1ZGVzKGtleSkpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gIltyZWRhY3RlZF0iOwogICAgICAgICAgfSBlbHNlIGlmIChbImN1c3RvbWVySWQiLCAiQ3VzdG9tZXJJZCIsICJTcGVha2VySWQiLCAiQ3VzdG9tZXJTcGVha2VySWQiXS5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgICAgIGRhdGFba2V5XSA9IG1kNShkYXRhW2tleV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBQdWxscyB0aGUgdHlwZSwgbWVzc2FnZSwgYW5kIHN0YWNrIHRyYWNlCiAgICogb3V0IG9mIHRoZSBnaXZlbiBleGNlcHRpb24gZm9yIEpTT04gc2VyaWFsaXphdGlvbi4KICAgKi8KICB2YXIgTG9nZ2VkRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMudHlwZSA9IChlIGluc3RhbmNlb2YgRXJyb3IpID8gZS5uYW1lIDogZS5jb2RlIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlKTsKICAgIHRoaXMubWVzc2FnZSA9IGUubWVzc2FnZTsKICAgIHRoaXMuc3RhY2sgPSBbXTsKICAgIGlmIChlLnN0YWNrKXsKICAgICAgdHJ5IHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGUuc3RhY2spKSB7CiAgICAgICAgICAgICAgdGhpcy5zdGFjayA9IGUuc3RhY2s7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlLnN0YWNrID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBbSlNPTi5zdHJpbmdpZnkoZS5zdGFjayldOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZS5zdGFjayA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gZS5zdGFjay5zcGxpdCgnXG4nKTsKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCB7fQogICAgfQogIH07CgogIC8qKgogICAqIE1pbmltYWxseSBzdHJpbmdpZnkgdGhpcyBsb2cgZW50cnkgZm9yIHByaW50aW5nCiAgICogdG8gdGhlIGNvbnNvbGUuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiWyVzXSBbJXNdIFslc106ICVzIiwKICAgICAgdGhpcy5nZXRUaW1lKCkgJiYgdGhpcy5nZXRUaW1lKCkudG9JU09TdHJpbmcgPyB0aGlzLmdldFRpbWUoKS50b0lTT1N0cmluZygpIDogIj8/PyIsCiAgICAgIHRoaXMuZ2V0TGV2ZWwoKSwKICAgICAgdGhpcy5nZXRBZ2VudFJlc291cmNlSWQoKSwKICAgICAgdGhpcy5nZXRUZXh0KCkpOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRpbWVzdGFtcC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0VGltZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnRpbWU7CiAgfTsKCiAgTG9nRW50cnkucHJvdG90eXBlLmdldEFnZW50UmVzb3VyY2VJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmFnZW50UmVzb3VyY2VJZDsKICB9CgogIC8qKgogICAqIEdldCB0aGUgbGV2ZWwgb2YgdGhlIGxvZyBlbnRyeS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0TGV2ZWwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5sZXZlbDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSB0ZXh0LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRUZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudGV4dDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSBjb21wb25lbnQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldENvbXBvbmVudCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbXBvbmVudDsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gZXhjZXB0aW9uIHN0YWNrIHRyYWNlIHRvIHRoaXMgbG9nIGVudHJ5LgogICAqIEEgbG9nIGVudHJ5IG1heSBjb250YWluIG9ubHkgb25lIGV4Y2VwdGlvbiBzdGFjayB0cmFjZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aEV4Y2VwdGlvbiA9IGZ1bmN0aW9uIChlKSB7CiAgICB0aGlzLmV4Y2VwdGlvbiA9IG5ldyBMb2dnZWRFeGNlcHRpb24oZSk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gYXJiaXRyYXJ5IG9iamVjdCB0byB0aGUgbG9nIGVudHJ5LiAgQSBsb2cgZW50cnkKICAgKiBtYXkgY29udGFpbiBhbnkgbnVtYmVyIG9mIG9iamVjdHMuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLndpdGhPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgY29waWVkT2JqID0gY29ubmVjdC5kZWVwY29weShvYmopOwogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhjb3BpZWRPYmopOwogICAgdGhpcy5vYmplY3RzLnB1c2goY29waWVkT2JqKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEFkZCBhIGNyb3NzIG9yaWdpbiBldmVudCBvYmplY3QgdG8gdGhlIGxvZyBlbnRyeS4gIEEgbG9nIGVudHJ5CiAgICogbWF5IGNvbnRhaW4gYW55IG51bWJlciBvZiBvYmplY3RzLgogICAqLwogICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aENyb3NzT3JpZ2luRXZlbnRPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgY29waWVkT2JqID0gY29ubmVjdC5kZWVwY29weUNyb3NzT3JpZ2luRXZlbnQob2JqKTsKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oY29waWVkT2JqKTsKICAgIHRoaXMub2JqZWN0cy5wdXNoKGNvcGllZE9iaik7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBJbmRpY2F0ZSB0aGF0IHRoaXMgbG9nIGVudHJ5IHNob3VsZCBiZSBzZW50IHRvIHRoZSBzZXJ2ZXIKICAgKiBOT1RFOiBUaGlzIHNob3VsZCBiZSB1c2VkIGZvciBpbnRlcm5hbCBsb2dzIG9ubHkKICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmdldExvZygpLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5wdXNoKHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogVGhlIGxvZ2dlciBpbnN0YW5jZS4KICAgKi8KICB2YXIgTG9nZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fbG9ncyA9IFtdOwogICAgdGhpcy5fcm9sbGVkTG9ncyA9IFtdOwogICAgdGhpcy5fbG9nc1RvUHVzaCA9IFtdOwogICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICAgIHRoaXMuX2VjaG9MZXZlbCA9IExvZ0xldmVsT3JkZXIuSU5GTzsKICAgIHRoaXMuX2xvZ0xldmVsID0gTG9nTGV2ZWxPcmRlci5JTkZPOwogICAgdGhpcy5fbGluZUNvdW50ID0gMDsKICAgIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCA9IDA7CiAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBudWxsOwogICAgdGhpcy5fbG9nZ2VySWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICItIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgdGhpcy5zZXRMb2dSb2xsSW50ZXJ2YWwoREVGQVVMVF9MT0dfUk9MTF9JTlRFUlZBTCk7CiAgICB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoID0gMDsKICB9OwoKICAvKioKICAgKiBTZXRzIHRoZSBpbnRlcnZhbCBpbiBtaWxsaXNlY29uZHMgdGhhdCB0aGUgbG9ncyB3aWxsIGJlIHJvdGF0ZWQuCiAgICogTG9ncyBhcmUgcm90YXRlZCBvdXQgY29tcGxldGVseSBhdCB0aGUgZW5kIG9mIHRoZSBzZWNvbmQgcm9sbAogICAqIGFuZCB3aWxsIGV2ZW50dWFsbHkgYmUgZ2FyYmFnZSBjb2xsZWN0ZWQuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRMb2dSb2xsSW50ZXJ2YWwgPSBmdW5jdGlvbiAoaW50ZXJ2YWwpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBpZiAoISh0aGlzLl9sb2dSb2xsVGltZXIpIHx8IGludGVydmFsICE9PSB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpIHsKICAgICAgaWYgKHRoaXMuX2xvZ1JvbGxUaW1lcikgewogICAgICAgIGdsb2JhbC5jbGVhckludGVydmFsKHRoaXMuX2xvZ1JvbGxUaW1lcik7CiAgICAgIH0KICAgICAgdGhpcy5fbG9nUm9sbEludGVydmFsID0gaW50ZXJ2YWw7CiAgICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IGdsb2JhbC5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5fcm9sbGVkTG9ncyA9IHNlbGYuX2xvZ3M7CiAgICAgICAgc2VsZi5fbG9ncyA9IFtdOwogICAgICAgIHNlbGYuX3N0YXJ0TG9nSW5kZXhUb1B1c2ggPSAwOwogICAgICAgIHNlbGYuaW5mbygiTG9nIHJvbGwgaW50ZXJ2YWwgb2NjdXJyZWQuIik7CiAgICAgIH0sIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLndhcm4oIkxvZ2dlciBpcyBhbHJlYWR5IHNldCB0byB0aGUgZ2l2ZW4gaW50ZXJ2YWw6ICVkIiwgdGhpcy5fbG9nUm9sbEludGVydmFsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTZXQgdGhlIGxvZyBsZXZlbC4gIFRoaXMgaXMgdGhlIG1pbmltdW0gbGV2ZWwgYXQgd2hpY2ggbG9ncyB3aWxsCiAgICogYmUga2VwdCBmb3IgbGF0ZXIgYXJjaGl2aW5nLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0TG9nTGV2ZWwgPSBmdW5jdGlvbiAobGV2ZWwpIHsKICAgIGlmIChsZXZlbCBpbiBMb2dMZXZlbE9yZGVyKSB7CiAgICAgIHRoaXMuX2xvZ0xldmVsID0gTG9nTGV2ZWxPcmRlcltsZXZlbF07CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbG9nZ2luZyBsZXZlbDogIiArIGxldmVsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTZXQgdGhlIGVjaG8gbGV2ZWwuICBUaGlzIGlzIHRoZSBtaW5pbXVtIGxldmVsIGF0IHdoaWNoIGxvZ3Mgd2lsbAogICAqIGJlIHByaW50ZWQgdG8gdGhlIGphdmFzY3JpcHQgY29uc29sZS4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldEVjaG9MZXZlbCA9IGZ1bmN0aW9uIChsZXZlbCkgewogICAgaWYgKGxldmVsIGluIExvZ0xldmVsT3JkZXIpIHsKICAgICAgdGhpcy5fZWNob0xldmVsID0gTG9nTGV2ZWxPcmRlcltsZXZlbF07CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbG9nZ2luZyBsZXZlbDogIiArIGxldmVsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBXcml0ZSBhIHBhcnRpY3VsYXIgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2dnaW5nIGxldmVsIG9mIHRoZSBlbnRyeS4KICAgKiBAcGFyYW0gdGV4dCBUaGUgdGV4dCBjb250ZW50cyBvZiB0aGUgZW50cnkuCiAgICoKICAgKiBAcmV0dXJucyBUaGUgbmV3IGxvZyBlbnRyeS4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gKGNvbXBvbmVudCwgbGV2ZWwsIHRleHQpIHsKICAgIHZhciBsb2dFbnRyeSA9IG5ldyBMb2dFbnRyeShjb21wb25lbnQsIGxldmVsLCB0ZXh0LCB0aGlzLmdldExvZ2dlcklkKCkpOwogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhsb2dFbnRyeSk7CiAgICB0aGlzLmFkZExvZ0VudHJ5KGxvZ0VudHJ5KTsKICAgIHJldHVybiBsb2dFbnRyeTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmFkZExvZ0VudHJ5ID0gZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAvLyBDYWxsIHRoaXMgc2Vjb25kIHRpbWUgYXMgaW4gc29tZSBwbGFjZXMgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgZGlyZWN0bHkKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8obG9nRW50cnkpOwogICAgdGhpcy5fbG9ncy5wdXNoKGxvZ0VudHJ5KTsKCiAgICAvL0ZvciBub3cgb25seSBzZW5kIHNvZnRwaG9uZSBsb2dzIG9ubHkuCiAgICAvL1RPRE8gYWRkIENDUCBsb2dzIG9uY2Ugd2UgYXJlIHN1cmUgdGhhdCBubyBzZW5zaXRpdmUgZGF0YSBpcyBiZWluZyBsb2dnZWQuCiAgICBpZiAoTG9nQ29tcG9uZW50LlNPRlRQSE9ORSA9PT0gbG9nRW50cnkuY29tcG9uZW50KSB7CiAgICAgIHRoaXMuX2xvZ3NUb1B1c2gucHVzaChsb2dFbnRyeSk7CiAgICB9CgogICAgaWYgKGxvZ0VudHJ5LmxldmVsIGluIExvZ0xldmVsT3JkZXIgJiYKICAgICAgTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fbG9nTGV2ZWwpIHsKCiAgICAgIGlmIChMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9lY2hvTGV2ZWwpIHsKICAgICAgICBDT05TT0xFX0xPR0dFUl9NQVBbbG9nRW50cnkuZ2V0TGV2ZWwoKV0obG9nRW50cnkudG9TdHJpbmcoKSk7CiAgICAgIH0KCiAgICAgIGxvZ0VudHJ5LmxpbmUgPSB0aGlzLl9saW5lQ291bnQrKzsKICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNlbmRJbnRlcm5hbExvZ0VudHJ5VG9TZXJ2ZXIgPSBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnB1c2gobG9nRW50cnkpOwoKICAgIGlmIChsb2dFbnRyeS5sZXZlbCBpbiBMb2dMZXZlbE9yZGVyICYmCiAgICAgIExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2xvZ0xldmVsKSB7CgogICAgICBpZiAoTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fZWNob0xldmVsKSB7CiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQW2xvZ0VudHJ5LmdldExldmVsKCldKGxvZ0VudHJ5LnRvU3RyaW5nKCkpOwogICAgICB9CgogICAgICBsb2dFbnRyeS5saW5lID0gdGhpcy5fbGluZUNvdW50Kys7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVtb3ZlIGFsbCBvYmplY3RzIGZyb20gYWxsIGxvZyBlbnRyaWVzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuY2xlYXJPYmplY3RzID0gZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW3hdLm9iamVjdHMpIHsKICAgICAgICBkZWxldGUgdGhpcy5fbG9nc1t4XS5vYmplY3RzOwogICAgICB9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVtb3ZlIGFsbCBleGNlcHRpb24gc3RhY2sgdHJhY2VzIGZyb20gdGhlIGxvZyBlbnRyaWVzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuY2xlYXJFeGNlcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW3hdLmV4Y2VwdGlvbikgewogICAgICAgIGRlbGV0ZSB0aGlzLl9sb2dzW3hdLmV4Y2VwdGlvbjsKICAgICAgfQogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUudHJhY2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuVFJBQ0UsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuREVCVUcsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5JTkZPLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmxvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5MT0csIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUudGVzdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5URVNULCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuV0FSTiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5FUlJPUiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5jcml0aWNhbCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5FUlJPUiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBsb2dnZXIgY29udGVudHMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsaW5lcyA9IFtdOwogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGxpbmVzLnB1c2godGhpcy5fbG9nc1t4XS50b1N0cmluZygpKTsKICAgIH0KCiAgICByZXR1cm4gbGluZXMuam9pbigiXG4iKTsKICB9OwogIAogIC8qKgogICAqIERvd25sb2FkL0FyY2hpdmUgbG9ncyB0byBhIGZpbGUsIAogICAqIEJ5IGRlZmF1bHQsIGl0IHJldHVybnMgYWxsIGxvZ3MuCiAgICogVG8gZmlsdGVyIGxvZ3MgYnkgdGhlIG1pbmltdW0gbG9nIGxldmVsIHNldCBieSBzZXRMb2dMZXZlbCBvciB0aGUgZGVmYXVsdCBzZXQgaW4gX2xvZ0xldmVsLCAKICAgKiBwYXNzIGluIGZpbHRlckJ5TG9nTGV2ZWwgdG8gdHJ1ZSBpbiBvcHRpb25zCiAgICogCiAgICogQHBhcmFtIG9wdGlvbnMgZG93bmxvYWQgb3B0aW9ucyBbT2JqZWN0fFN0cmluZ10uIAogICAqIC0gb2YgdHlwZSBPYmplY3Q6IAogICAqICAgeyBsb2dOYW1lOiAnbXktbG9nLW5hbWUnLAogICAqICAgICBmaWx0ZXJCeUxvZ0xldmVsOiBmYWxzZSwgLy9kb3dubG9hZCBhbGwgbG9ncwogICAqICAgfQogICAqIC0gb2YgdHlwZSBTdHJpbmcgKGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KSwgdGhlIGZpbGUncyBuYW1lCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5kb3dubG9hZCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBsb2dOYW1lID0gJ2FnZW50LWxvZyc7CiAgICB2YXIgZmlsdGVyQnlMb2dMZXZlbCA9IGZhbHNlOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcpIHsKICAgICAgbG9nTmFtZSA9IG9wdGlvbnMubG9nTmFtZSB8fCBsb2dOYW1lOwogICAgICBmaWx0ZXJCeUxvZ0xldmVsID0gb3B0aW9ucy5maWx0ZXJCeUxvZ0xldmVsIHx8IGZpbHRlckJ5TG9nTGV2ZWw7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgbG9nTmFtZSA9IG9wdGlvbnMgfHwgbG9nTmFtZTsKICAgIH0KCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgbG9ncyA9IHRoaXMuX3JvbGxlZExvZ3MuY29uY2F0KHRoaXMuX2xvZ3MpOwogICAgaWYgKGZpbHRlckJ5TG9nTGV2ZWwpIHsKICAgICAgbG9ncyA9IGxvZ3MuZmlsdGVyKGZ1bmN0aW9uKGVudHJ5KSB7CiAgICAgICAgcmV0dXJuIExvZ0xldmVsT3JkZXJbZW50cnkubGV2ZWxdID49IHNlbGYuX2xvZ0xldmVsOwogICAgICB9KTsKICAgIH0KCiAgICB2YXIgbG9nQmxvYiA9IG5ldyBnbG9iYWwuQmxvYihbSlNPTi5zdHJpbmdpZnkobG9ncywgdW5kZWZpbmVkLCA0KV0sIFsndGV4dC9wbGFpbiddKTsKICAgIHZhciBkb3dubG9hZExpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICB2YXIgbG9nTmFtZSA9IGxvZ05hbWUgfHwgJ2FnZW50LWxvZyc7CiAgICBkb3dubG9hZExpbmsuaHJlZiA9IGdsb2JhbC5VUkwuY3JlYXRlT2JqZWN0VVJMKGxvZ0Jsb2IpOwogICAgZG93bmxvYWRMaW5rLmRvd25sb2FkID0gbG9nTmFtZSArICcudHh0JzsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZG93bmxvYWRMaW5rKTsKICAgIGRvd25sb2FkTGluay5jbGljaygpOwogICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkb3dubG9hZExpbmspOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVVcHN0cmVhbUxvZ1B1c2ggPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgaWYgKCFjb25uZWN0LnVwc3RyZWFtTG9nUHVzaFNjaGVkdWxlZCkgewogICAgICBjb25uZWN0LnVwc3RyZWFtTG9nUHVzaFNjaGVkdWxlZCA9IHRydWU7CiAgICAgIC8qKiBTY2hlZHVsZSBwdXNoaW5nIGxvZ3MgZnJlcXVlbnRseSB0byBzaGFyZWR3b3JrZXIgdXBzdHJlYW0sIHNoYXJlZHdvcmtlciB3aWxsIHJlcG9ydCB0byB0aGUgQ1RJIGJhY2tlbmQqLwogICAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSwgY29uZHVpdCksIFNPRlRQSE9ORV9MT0dfUkVQT1JUX0lOVEVSVkFMX01JTExJUyk7CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5yZXBvcnRNYXN0ZXJMb2dzVXBTdHJlYW0gPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgdmFyIGxvZ3NUb1B1c2ggPSB0aGlzLl9sb2dzVG9QdXNoLnNsaWNlKCk7CiAgICB0aGlzLl9sb2dzVG9QdXNoID0gW107CiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUywgZnVuY3Rpb24gKCkgewogICAgICBpZiAobG9nc1RvUHVzaC5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VORF9MT0dTLCBsb2dzVG9QdXNoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzUHVzaCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaE91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1Vwc3RyZWFtLCBjb25kdWl0KSwgMTAwMCk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BMb2dzUHVzaCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaE91dGVyQ29udGV4dENDUExvZ3NVcHN0cmVhbSwgY29uZHVpdCksIDEwMDApOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzVXBzdHJlYW0gPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoID4gMCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0udGV4dCA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldLnRleHQ7CiAgICAgIH0KCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzKTsKICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICAgIH0KICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaE91dGVyQ29udGV4dENDUExvZ3NVcHN0cmVhbSA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGZvciAodmFyIGkgPSB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoOyBpIDwgdGhpcy5fbG9ncy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5fbG9nc1tpXS5sb2dnZXJJZCAhPT0gdGhpcy5fbG9nZ2VySWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIHRoaXMuX2xvZ3NbaV0pOwogICAgfQogICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IHRoaXMuX2xvZ3MubGVuZ3RoOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5nZXRMb2dnZXJJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9sb2dnZXJJZDsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlRG93bnN0cmVhbUNsaWVudFNpZGVMb2dzUHVzaCA9IGZ1bmN0aW9uICgpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaENsaWVudFNpZGVMb2dzRG93bnN0cmVhbSksIExPR1NfUkVQT1JUX0lOVEVSVkFMX01JTExJUyk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hDbGllbnRTaWRlTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9ncyA9IFtdOwoKICAgIC8vIFdlIGRvIG5vdCBzZW5kIGEgcmVxdWVzdCBpZiB3ZSBoYXZlIGxlc3MgdGhhbiA1MCByZWNvcmRzIHNvIHRoYXQgd2UgbWluaW1pemUgdGhlIG51bWJlciBvZgogICAgLy8gcmVxdWVzdHMgcGVyIHNlY29uZC4gCiAgICAvLyA1MDAgaXMgdGhlIG1heCB3ZSBhY2NlcHQgb24gdGhlIHNlcnZlci4gCiAgICAvLyBXZSBjaG9zZSA1MDAgYmVjYXVzZSB0aGlzIGlzIHRoZSBsaW1pdCBpbXBvc2VkIGJ5IEZpcmVob3NlIGZvciBhIHB1dCBiYXRjaCByZXF1ZXN0CiAgICBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoIDwgNTApIHsKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPiA1MDApIHsKICAgICAgbG9ncyA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnNwbGljZSgwLCA1MDApOwogICAgfSBlbHNlIHsKICAgICAgbG9ncyA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzOwogICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgfQoKICAgIGNvbm5lY3QucHVibGlzaENsaWVudFNpZGVMb2dzKGxvZ3MpOwogIH0KCiAgdmFyIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIExvZ2dlci5jYWxsKHRoaXMpOwogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIAogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fcHVzaExvZ3NEb3duc3RyZWFtKSwKICAgICAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIuTE9HX1BVU0hfSU5URVJWQUwpOwoKICAgIC8vIERpc2FibGUgbG9nIHJvbGxpbmcsIHdlIHdpbGwgcHVyZ2Ugb3VyIG93biBsb2dzIG9uY2UgdGhleSBoYXZlCiAgICAvLyBiZWVuIHB1c2hlZCBkb3duc3RyZWFtLgogICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwodGhpcy5fbG9nUm9sbFRpbWVyKTsKICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IG51bGw7CiAgfTsKICAvLyBIb3cgZnJlcXVlbnRseSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIGRlbGl2ZXJlZCBkb3duc3RyZWFtLgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLkxPR19QVVNIX0lOVEVSVkFMID0gMTAwMDsKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKExvZ2dlci5wcm90b3R5cGUpOwogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IERvd25zdHJlYW1Db25kdWl0TG9nZ2VyOwoKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUucHVzaExvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKGxvZ3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGxvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGxvZyk7CiAgICB9KTsKICB9OwoKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUuX3B1c2hMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIAogICAgdGhpcy5fbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogICAgdGhpcy5fbG9ncyA9IFtdOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldKTsKICAgIH0KCiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogIH07CgogIC8qKgogICAqIFdyYXAgYSBmdW5jdGlvbiB3aXRoIHRyeSBjYXRjaCBibG9jawogICAqLwogIHZhciB0cnlDYXRjaFdyYXBwZXJNZXRob2QgPSBmdW5jdGlvbiAoZm4pIHsKICAgIHZhciB3cmFwcGVkZnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFNpbmNlIHRoaXMgd3JhcHMgTG9nZ2VyIGNsYXNzLCB3ZSBjYW4gb25seSBwcmludCBpdCBpbiB0aGUgY29uc29sZSBhbmQgZWF0IGl0LgogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUC5FUlJPUihlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHdyYXBwZWRmdW5jdGlvbjsKICB9CiAgLyoqCiAgICogVGhpcyBpcyBhIHdyYXBwZXIgbWV0aG9kIHRvIHdyYXAgZWFjaCBmdW5jdGlvbgogICAqIGluIGFuIG9iamVjdCB3aXRoIHRyeSBjYXRjaCBibG9jay4KICAgKi8KICB2YXIgdHJ5Q2F0Y2hXcmFwcGVyT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgZm9yICh2YXIgbWV0aG9kIGluIG9iaikgewogICAgICBpZiAodHlwZW9mKG9ialttZXRob2RdKSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIG9ialttZXRob2RdID0gdHJ5Q2F0Y2hXcmFwcGVyTWV0aG9kKG9ialttZXRob2RdKTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqIENyZWF0ZSB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICBjb25uZWN0LnJvb3RMb2dnZXIgPSBuZXcgTG9nZ2VyKCk7CiAgdHJ5Q2F0Y2hXcmFwcGVyT2JqZWN0KGNvbm5lY3Qucm9vdExvZ2dlcik7CgoKICAvKiogRmV0Y2ggdGhlIHNpbmdsZXRvbiBsb2dnZXIgaW5zdGFuY2UuICovCiAgdmFyIGdldExvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnJvb3RMb2dnZXI7CiAgfTsKCiAgY29ubmVjdCA9IGNvbm5lY3QgfHwge307CiAgY29ubmVjdC5nZXRMb2cgPSBnZXRMb2c7CiAgY29ubmVjdC5Mb2dFbnRyeSA9IExvZ0VudHJ5OwogIGNvbm5lY3QuTG9nZ2VyID0gTG9nZ2VyOwogIGNvbm5lY3QuTG9nTGV2ZWwgPSBMb2dMZXZlbDsKICBjb25uZWN0LkxvZ0NvbXBvbmVudCA9IExvZ0NvbXBvbmVudDsKICBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAxNjM6Ci8qKiovIChmdW5jdGlvbigpIHsKCi8qCiAqIEphdmFTY3JpcHQgTUQ1CiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9ibHVlaW1wL0phdmFTY3JpcHQtTUQ1CiAqCiAqIENvcHlyaWdodCAyMDExLCBTZWJhc3RpYW4gVHNjaGFuCiAqIGh0dHBzOi8vYmx1ZWltcC5uZXQKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlOgogKiBodHRwczovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVAogKgogKiBCYXNlZCBvbgogKiBBIEphdmFTY3JpcHQgaW1wbGVtZW50YXRpb24gb2YgdGhlIFJTQSBEYXRhIFNlY3VyaXR5LCBJbmMuIE1ENSBNZXNzYWdlCiAqIERpZ2VzdCBBbGdvcml0aG0sIGFzIGRlZmluZWQgaW4gUkZDIDEzMjEuCiAqIFZlcnNpb24gMi4yIENvcHlyaWdodCAoQykgUGF1bCBKb2huc3RvbiAxOTk5IC0gMjAwOQogKiBPdGhlciBjb250cmlidXRvcnM6IEdyZWcgSG9sdCwgQW5kcmV3IEtlcGVydCwgWWRuYXIsIExvc3RpbmV0CiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgTGljZW5zZQogKiBTZWUgaHR0cDovL3BhamhvbWUub3JnLnVrL2NyeXB0L21kNSBmb3IgbW9yZSBpbmZvLgogKi8KCi8qIGdsb2JhbCBkZWZpbmUgKi8KCi8qIGVzbGludC1kaXNhYmxlIHN0cmljdCAqLwoKOyhmdW5jdGlvbiAoJCkgewogICd1c2Ugc3RyaWN0JwoJdmFyIGN0eCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKCiAgLyoqCiAgICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLgogICAqIFRoaXMgdXNlcyAxNi1iaXQgb3BlcmF0aW9ucyBpbnRlcm5hbGx5IHRvIHdvcmsgYXJvdW5kIGJ1Z3MgaW4gaW50ZXJwcmV0ZXJzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHggRmlyc3QgaW50ZWdlcgogICAqIEBwYXJhbSB7bnVtYmVyfSB5IFNlY29uZCBpbnRlZ2VyCiAgICogQHJldHVybnMge251bWJlcn0gU3VtCiAgICovCiAgZnVuY3Rpb24gc2FmZUFkZCh4LCB5KSB7CiAgICB2YXIgbHN3ID0gKHggJiAweGZmZmYpICsgKHkgJiAweGZmZmYpCiAgICB2YXIgbXN3ID0gKHggPj4gMTYpICsgKHkgPj4gMTYpICsgKGxzdyA+PiAxNikKICAgIHJldHVybiAobXN3IDw8IDE2KSB8IChsc3cgJiAweGZmZmYpCiAgfQoKICAvKioKICAgKiBCaXR3aXNlIHJvdGF0ZSBhIDMyLWJpdCBudW1iZXIgdG8gdGhlIGxlZnQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gbnVtIDMyLWJpdCBudW1iZXIKICAgKiBAcGFyYW0ge251bWJlcn0gY250IFJvdGF0aW9uIGNvdW50CiAgICogQHJldHVybnMge251bWJlcn0gUm90YXRlZCBudW1iZXIKICAgKi8KICBmdW5jdGlvbiBiaXRSb3RhdGVMZWZ0KG51bSwgY250KSB7CiAgICByZXR1cm4gKG51bSA8PCBjbnQpIHwgKG51bSA+Pj4gKDMyIC0gY250KSkKICB9CgogIC8qKgogICAqIEJhc2ljIG9wZXJhdGlvbiB0aGUgYWxnb3JpdGhtIHVzZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gcSBxCiAgICogQHBhcmFtIHtudW1iZXJ9IGEgYQogICAqIEBwYXJhbSB7bnVtYmVyfSBiIGIKICAgKiBAcGFyYW0ge251bWJlcn0geCB4CiAgICogQHBhcmFtIHtudW1iZXJ9IHMgcwogICAqIEBwYXJhbSB7bnVtYmVyfSB0IHQKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXN1bHQKICAgKi8KICBmdW5jdGlvbiBtZDVjbW4ocSwgYSwgYiwgeCwgcywgdCkgewogICAgcmV0dXJuIHNhZmVBZGQoYml0Um90YXRlTGVmdChzYWZlQWRkKHNhZmVBZGQoYSwgcSksIHNhZmVBZGQoeCwgdCkpLCBzKSwgYikKICB9CiAgLyoqCiAgICogQmFzaWMgb3BlcmF0aW9uIHRoZSBhbGdvcml0aG0gdXNlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhIGEKICAgKiBAcGFyYW0ge251bWJlcn0gYiBiCiAgICogQHBhcmFtIHtudW1iZXJ9IGMgYwogICAqIEBwYXJhbSB7bnVtYmVyfSBkIGQKICAgKiBAcGFyYW0ge251bWJlcn0geCB4CiAgICogQHBhcmFtIHtudW1iZXJ9IHMgcwogICAqIEBwYXJhbSB7bnVtYmVyfSB0IHQKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXN1bHQKICAgKi8KICBmdW5jdGlvbiBtZDVmZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gbWQ1Y21uKChiICYgYykgfCAofmIgJiBkKSwgYSwgYiwgeCwgcywgdCkKICB9CiAgLyoqCiAgICogQmFzaWMgb3BlcmF0aW9uIHRoZSBhbGdvcml0aG0gdXNlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhIGEKICAgKiBAcGFyYW0ge251bWJlcn0gYiBiCiAgICogQHBhcmFtIHtudW1iZXJ9IGMgYwogICAqIEBwYXJhbSB7bnVtYmVyfSBkIGQKICAgKiBAcGFyYW0ge251bWJlcn0geCB4CiAgICogQHBhcmFtIHtudW1iZXJ9IHMgcwogICAqIEBwYXJhbSB7bnVtYmVyfSB0IHQKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXN1bHQKICAgKi8KICBmdW5jdGlvbiBtZDVnZyhhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gbWQ1Y21uKChiICYgZCkgfCAoYyAmIH5kKSwgYSwgYiwgeCwgcywgdCkKICB9CiAgLyoqCiAgICogQmFzaWMgb3BlcmF0aW9uIHRoZSBhbGdvcml0aG0gdXNlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhIGEKICAgKiBAcGFyYW0ge251bWJlcn0gYiBiCiAgICogQHBhcmFtIHtudW1iZXJ9IGMgYwogICAqIEBwYXJhbSB7bnVtYmVyfSBkIGQKICAgKiBAcGFyYW0ge251bWJlcn0geCB4CiAgICogQHBhcmFtIHtudW1iZXJ9IHMgcwogICAqIEBwYXJhbSB7bnVtYmVyfSB0IHQKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXN1bHQKICAgKi8KICBmdW5jdGlvbiBtZDVoaChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gbWQ1Y21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCkKICB9CiAgLyoqCiAgICogQmFzaWMgb3BlcmF0aW9uIHRoZSBhbGdvcml0aG0gdXNlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBhIGEKICAgKiBAcGFyYW0ge251bWJlcn0gYiBiCiAgICogQHBhcmFtIHtudW1iZXJ9IGMgYwogICAqIEBwYXJhbSB7bnVtYmVyfSBkIGQKICAgKiBAcGFyYW0ge251bWJlcn0geCB4CiAgICogQHBhcmFtIHtudW1iZXJ9IHMgcwogICAqIEBwYXJhbSB7bnVtYmVyfSB0IHQKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXN1bHQKICAgKi8KICBmdW5jdGlvbiBtZDVpaShhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gbWQ1Y21uKGMgXiAoYiB8IH5kKSwgYSwgYiwgeCwgcywgdCkKICB9CgogIC8qKgogICAqIENhbGN1bGF0ZSB0aGUgTUQ1IG9mIGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMsIGFuZCBhIGJpdCBsZW5ndGguCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSB4IEFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMKICAgKiBAcGFyYW0ge251bWJlcn0gbGVuIEJpdCBsZW5ndGgKICAgKiBAcmV0dXJucyB7QXJyYXk8bnVtYmVyPn0gTUQ1IEFycmF5CiAgICovCiAgZnVuY3Rpb24gYmlubE1ENSh4LCBsZW4pIHsKICAgIC8qIGFwcGVuZCBwYWRkaW5nICovCiAgICB4W2xlbiA+PiA1XSB8PSAweDgwIDw8IGxlbiAlIDMyCiAgICB4WygoKGxlbiArIDY0KSA+Pj4gOSkgPDwgNCkgKyAxNF0gPSBsZW4KCiAgICB2YXIgaQogICAgdmFyIG9sZGEKICAgIHZhciBvbGRiCiAgICB2YXIgb2xkYwogICAgdmFyIG9sZGQKICAgIHZhciBhID0gMTczMjU4NDE5MwogICAgdmFyIGIgPSAtMjcxNzMzODc5CiAgICB2YXIgYyA9IC0xNzMyNTg0MTk0CiAgICB2YXIgZCA9IDI3MTczMzg3OAoKICAgIGZvciAoaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikgewogICAgICBvbGRhID0gYQogICAgICBvbGRiID0gYgogICAgICBvbGRjID0gYwogICAgICBvbGRkID0gZAoKICAgICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaV0sIDcsIC02ODA4NzY5MzYpCiAgICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyAxXSwgMTIsIC0zODk1NjQ1ODYpCiAgICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAyXSwgMTcsIDYwNjEwNTgxOSkKICAgICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDNdLCAyMiwgLTEwNDQ1MjUzMzApCiAgICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2kgKyA0XSwgNywgLTE3NjQxODg5NykKICAgICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDVdLCAxMiwgMTIwMDA4MDQyNikKICAgICAgYyA9IG1kNWZmKGMsIGQsIGEsIGIsIHhbaSArIDZdLCAxNywgLTE0NzMyMzEzNDEpCiAgICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyA3XSwgMjIsIC00NTcwNTk4MykKICAgICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaSArIDhdLCA3LCAxNzcwMDM1NDE2KQogICAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgOV0sIDEyLCAtMTk1ODQxNDQxNykKICAgICAgYyA9IG1kNWZmKGMsIGQsIGEsIGIsIHhbaSArIDEwXSwgMTcsIC00MjA2MykKICAgICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDExXSwgMjIsIC0xOTkwNDA0MTYyKQogICAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpICsgMTJdLCA3LCAxODA0NjAzNjgyKQogICAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgMTNdLCAxMiwgLTQwMzQxMTAxKQogICAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMTRdLCAxNywgLTE1MDIwMDIyOTApCiAgICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyAxNV0sIDIyLCAxMjM2NTM1MzI5KQoKICAgICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDFdLCA1LCAtMTY1Nzk2NTEwKQogICAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgNl0sIDksIC0xMDY5NTAxNjMyKQogICAgICBjID0gbWQ1Z2coYywgZCwgYSwgYiwgeFtpICsgMTFdLCAxNCwgNjQzNzE3NzEzKQogICAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpXSwgMjAsIC0zNzM4OTczMDIpCiAgICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyA1XSwgNSwgLTcwMTU1ODY5MSkKICAgICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDEwXSwgOSwgMzgwMTYwODMpCiAgICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE0LCAtNjYwNDc4MzM1KQogICAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpICsgNF0sIDIwLCAtNDA1NTM3ODQ4KQogICAgICBhID0gbWQ1Z2coYSwgYiwgYywgZCwgeFtpICsgOV0sIDUsIDU2ODQ0NjQzOCkKICAgICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDE0XSwgOSwgLTEwMTk4MDM2OTApCiAgICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAzXSwgMTQsIC0xODczNjM5NjEpCiAgICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2kgKyA4XSwgMjAsIDExNjM1MzE1MDEpCiAgICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyAxM10sIDUsIC0xNDQ0NjgxNDY3KQogICAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgMl0sIDksIC01MTQwMzc4NCkKICAgICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDddLCAxNCwgMTczNTMyODQ3MykKICAgICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaSArIDEyXSwgMjAsIC0xOTI2NjA3NzM0KQoKICAgICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDVdLCA0LCAtMzc4NTU4KQogICAgICBkID0gbWQ1aGgoZCwgYSwgYiwgYywgeFtpICsgOF0sIDExLCAtMjAyMjU3NDQ2MykKICAgICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDExXSwgMTYsIDE4MzkwMzA1NjIpCiAgICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyAxNF0sIDIzLCAtMzUzMDk1NTYpCiAgICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyAxXSwgNCwgLTE1MzA5OTIwNjApCiAgICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2kgKyA0XSwgMTEsIDEyNzI4OTMzNTMpCiAgICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyA3XSwgMTYsIC0xNTU0OTc2MzIpCiAgICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyAxMF0sIDIzLCAtMTA5NDczMDY0MCkKICAgICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDEzXSwgNCwgNjgxMjc5MTc0KQogICAgICBkID0gbWQ1aGgoZCwgYSwgYiwgYywgeFtpXSwgMTEsIC0zNTg1MzcyMjIpCiAgICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAzXSwgMTYsIC03MjI1MjE5NzkpCiAgICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyA2XSwgMjMsIDc2MDI5MTg5KQogICAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgOV0sIDQsIC02NDAzNjQ0ODcpCiAgICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2kgKyAxMl0sIDExLCAtNDIxODE1ODM1KQogICAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgMTVdLCAxNiwgNTMwNzQyNTIwKQogICAgICBiID0gbWQ1aGgoYiwgYywgZCwgYSwgeFtpICsgMl0sIDIzLCAtOTk1MzM4NjUxKQoKICAgICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaV0sIDYsIC0xOTg2MzA4NDQpCiAgICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyA3XSwgMTAsIDExMjY4OTE0MTUpCiAgICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyAxNF0sIDE1LCAtMTQxNjM1NDkwNSkKICAgICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDVdLCAyMSwgLTU3NDM0MDU1KQogICAgICBhID0gbWQ1aWkoYSwgYiwgYywgZCwgeFtpICsgMTJdLCA2LCAxNzAwNDg1NTcxKQogICAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgM10sIDEwLCAtMTg5NDk4NjYwNikKICAgICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDEwXSwgMTUsIC0xMDUxNTIzKQogICAgICBiID0gbWQ1aWkoYiwgYywgZCwgYSwgeFtpICsgMV0sIDIxLCAtMjA1NDkyMjc5OSkKICAgICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDhdLCA2LCAxODczMzEzMzU5KQogICAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgMTVdLCAxMCwgLTMwNjExNzQ0KQogICAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgNl0sIDE1LCAtMTU2MDE5ODM4MCkKICAgICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDEzXSwgMjEsIDEzMDkxNTE2NDkpCiAgICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2kgKyA0XSwgNiwgLTE0NTUyMzA3MCkKICAgICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDExXSwgMTAsIC0xMTIwMjEwMzc5KQogICAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMl0sIDE1LCA3MTg3ODcyNTkpCiAgICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyA5XSwgMjEsIC0zNDM0ODU1NTEpCgogICAgICBhID0gc2FmZUFkZChhLCBvbGRhKQogICAgICBiID0gc2FmZUFkZChiLCBvbGRiKQogICAgICBjID0gc2FmZUFkZChjLCBvbGRjKQogICAgICBkID0gc2FmZUFkZChkLCBvbGRkKQogICAgfQogICAgcmV0dXJuIFthLCBiLCBjLCBkXQogIH0KCiAgLyoqCiAgICogQ29udmVydCBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzIHRvIGEgc3RyaW5nCiAgICoKICAgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGlucHV0IE1ENSBBcnJheQogICAqIEByZXR1cm5zIHtzdHJpbmd9IE1ENSBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiBiaW5sMnJzdHIoaW5wdXQpIHsKICAgIHZhciBpCiAgICB2YXIgb3V0cHV0ID0gJycKICAgIHZhciBsZW5ndGgzMiA9IGlucHV0Lmxlbmd0aCAqIDMyCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoMzI7IGkgKz0gOCkgewogICAgICBvdXRwdXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSgoaW5wdXRbaSA+PiA1XSA+Pj4gaSAlIDMyKSAmIDB4ZmYpCiAgICB9CiAgICByZXR1cm4gb3V0cHV0CiAgfQoKICAvKioKICAgKiBDb252ZXJ0IGEgcmF3IHN0cmluZyB0byBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAgICogQ2hhcmFjdGVycyA+MjU1IGhhdmUgdGhlaXIgaGlnaC1ieXRlIHNpbGVudGx5IGlnbm9yZWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaW5wdXQgUmF3IGlucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtBcnJheTxudW1iZXI+fSBBcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAgICovCiAgZnVuY3Rpb24gcnN0cjJiaW5sKGlucHV0KSB7CiAgICB2YXIgaQogICAgdmFyIG91dHB1dCA9IFtdCiAgICBvdXRwdXRbKGlucHV0Lmxlbmd0aCA+PiAyKSAtIDFdID0gdW5kZWZpbmVkCiAgICBmb3IgKGkgPSAwOyBpIDwgb3V0cHV0Lmxlbmd0aDsgaSArPSAxKSB7CiAgICAgIG91dHB1dFtpXSA9IDAKICAgIH0KICAgIHZhciBsZW5ndGg4ID0gaW5wdXQubGVuZ3RoICogOAogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDg7IGkgKz0gOCkgewogICAgICBvdXRwdXRbaSA+PiA1XSB8PSAoaW5wdXQuY2hhckNvZGVBdChpIC8gOCkgJiAweGZmKSA8PCBpICUgMzIKICAgIH0KICAgIHJldHVybiBvdXRwdXQKICB9CgogIC8qKgogICAqIENhbGN1bGF0ZSB0aGUgTUQ1IG9mIGEgcmF3IHN0cmluZwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHMgSW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gUmF3IE1ENSBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiByc3RyTUQ1KHMpIHsKICAgIHJldHVybiBiaW5sMnJzdHIoYmlubE1ENShyc3RyMmJpbmwocyksIHMubGVuZ3RoICogOCkpCiAgfQoKICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSBITUFDLU1ENSBvZiBhIGtleSBhbmQgc29tZSBkYXRhIChyYXcgc3RyaW5ncykKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgSE1BQyBrZXkKICAgKiBAcGFyYW0ge3N0cmluZ30gZGF0YSBSYXcgaW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gUmF3IE1ENSBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiByc3RySE1BQ01ENShrZXksIGRhdGEpIHsKICAgIHZhciBpCiAgICB2YXIgYmtleSA9IHJzdHIyYmlubChrZXkpCiAgICB2YXIgaXBhZCA9IFtdCiAgICB2YXIgb3BhZCA9IFtdCiAgICB2YXIgaGFzaAogICAgaXBhZFsxNV0gPSBvcGFkWzE1XSA9IHVuZGVmaW5lZAogICAgaWYgKGJrZXkubGVuZ3RoID4gMTYpIHsKICAgICAgYmtleSA9IGJpbmxNRDUoYmtleSwga2V5Lmxlbmd0aCAqIDgpCiAgICB9CiAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkgKz0gMSkgewogICAgICBpcGFkW2ldID0gYmtleVtpXSBeIDB4MzYzNjM2MzYKICAgICAgb3BhZFtpXSA9IGJrZXlbaV0gXiAweDVjNWM1YzVjCiAgICB9CiAgICBoYXNoID0gYmlubE1ENShpcGFkLmNvbmNhdChyc3RyMmJpbmwoZGF0YSkpLCA1MTIgKyBkYXRhLmxlbmd0aCAqIDgpCiAgICByZXR1cm4gYmlubDJyc3RyKGJpbmxNRDUob3BhZC5jb25jYXQoaGFzaCksIDUxMiArIDEyOCkpCiAgfQoKICAvKioKICAgKiBDb252ZXJ0IGEgcmF3IHN0cmluZyB0byBhIGhleCBzdHJpbmcKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBpbnB1dCBSYXcgaW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gSGV4IGVuY29kZWQgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gcnN0cjJoZXgoaW5wdXQpIHsKICAgIHZhciBoZXhUYWIgPSAnMDEyMzQ1Njc4OWFiY2RlZicKICAgIHZhciBvdXRwdXQgPSAnJwogICAgdmFyIHgKICAgIHZhciBpCiAgICBmb3IgKGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgeCA9IGlucHV0LmNoYXJDb2RlQXQoaSkKICAgICAgb3V0cHV0ICs9IGhleFRhYi5jaGFyQXQoKHggPj4+IDQpICYgMHgwZikgKyBoZXhUYWIuY2hhckF0KHggJiAweDBmKQogICAgfQogICAgcmV0dXJuIG91dHB1dAogIH0KCiAgLyoqCiAgICogRW5jb2RlIGEgc3RyaW5nIGFzIFVURi04CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaW5wdXQgSW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gVVRGOCBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiBzdHIycnN0clVURjgoaW5wdXQpIHsKICAgIHJldHVybiB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoaW5wdXQpKQogIH0KCiAgLyoqCiAgICogRW5jb2RlcyBpbnB1dCBzdHJpbmcgYXMgcmF3IE1ENSBzdHJpbmcKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBzIElucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJhdyBNRDUgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gcmF3TUQ1KHMpIHsKICAgIHJldHVybiByc3RyTUQ1KHN0cjJyc3RyVVRGOChzKSkKICB9CiAgLyoqCiAgICogRW5jb2RlcyBpbnB1dCBzdHJpbmcgYXMgSGV4IGVuY29kZWQgc3RyaW5nCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcyBJbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBIZXggZW5jb2RlZCBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiBoZXhNRDUocykgewogICAgcmV0dXJuIHJzdHIyaGV4KHJhd01ENShzKSkKICB9CiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgcmF3IEhNQUMtTUQ1IGZvciB0aGUgZ2l2ZW4ga2V5IGFuZCBkYXRhCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gayBITUFDIGtleQogICAqIEBwYXJhbSB7c3RyaW5nfSBkIElucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJhdyBNRDUgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gcmF3SE1BQ01ENShrLCBkKSB7CiAgICByZXR1cm4gcnN0ckhNQUNNRDUoc3RyMnJzdHJVVEY4KGspLCBzdHIycnN0clVURjgoZCkpCiAgfQogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIEhleCBlbmNvZGVkIEhNQUMtTUQ1IGZvciB0aGUgZ2l2ZW4ga2V5IGFuZCBkYXRhCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gayBITUFDIGtleQogICAqIEBwYXJhbSB7c3RyaW5nfSBkIElucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJhdyBNRDUgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gaGV4SE1BQ01ENShrLCBkKSB7CiAgICByZXR1cm4gcnN0cjJoZXgocmF3SE1BQ01ENShrLCBkKSkKICB9CgogIC8qKgogICAqIENhbGN1bGF0ZXMgTUQ1IHZhbHVlIGZvciBhIGdpdmVuIHN0cmluZy4KICAgKiBJZiBhIGtleSBpcyBwcm92aWRlZCwgY2FsY3VsYXRlcyB0aGUgSE1BQy1NRDUgdmFsdWUuCiAgICogUmV0dXJucyBhIEhleCBlbmNvZGVkIHN0cmluZyB1bmxlc3MgdGhlIHJhdyBhcmd1bWVudCBpcyBnaXZlbi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgSW5wdXQgc3RyaW5nCiAgICogQHBhcmFtIHtzdHJpbmd9IFtrZXldIEhNQUMga2V5CiAgICogQHBhcmFtIHtib29sZWFufSBbcmF3XSBSYXcgb3V0cHV0IHN3aXRjaAogICAqIEByZXR1cm5zIHtzdHJpbmd9IE1ENSBvdXRwdXQKICAgKi8KICBmdW5jdGlvbiBtZDUoc3RyaW5nLCBrZXksIHJhdykgewogICAgaWYgKCFrZXkpIHsKICAgICAgaWYgKCFyYXcpIHsKICAgICAgICByZXR1cm4gaGV4TUQ1KHN0cmluZykKICAgICAgfQogICAgICByZXR1cm4gcmF3TUQ1KHN0cmluZykKICAgIH0KICAgIGlmICghcmF3KSB7CiAgICAgIHJldHVybiBoZXhITUFDTUQ1KGtleSwgc3RyaW5nKQogICAgfQogICAgcmV0dXJuIHJhd0hNQUNNRDUoa2V5LCBzdHJpbmcpCiAgfQoKCWN0eC5tZDUgPSBtZDUKfSkodGhpcykKCi8qKiovIH0pLAoKLyoqKi8gNDM5OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuQ2hhdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8sIG1ldGFkYXRhKSB7CiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBjcmVhdGVNZWRpYUluc3RhbmNlID0gZnVuY3Rpb24gKCkgewogICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgbWVkaWEgY29udHJvbGxlciBpbml0IiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgbWVkaWEgY29udHJvbGxlciBpbml0IikKICAgICAgICAud2l0aE9iamVjdChtZWRpYUluZm8pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICBjb25uZWN0LkNoYXRTZXNzaW9uLnNldEdsb2JhbENvbmZpZyh7CiAgICAgICAgbG9nZ2VyQ29uZmlnOiB7CiAgICAgICAgICBsb2dnZXI6IGxvZ2dlcgogICAgICAgIH0sCiAgICAgICAgcmVnaW9uOiBtZXRhZGF0YS5yZWdpb24KICAgICAgfSk7CgogICAgICAvKiogQ291bGQgYmUgYWxzbyBDVVNUT01FUiAtICBGb3Igbm93IHdlIGFyZSBjcmVhdGluZyBvbmx5IEFnZW50IGNvbm5lY3Rpb24gbWVkaWEgb2JqZWN0ICovCiAgICAgIHZhciBjb250cm9sbGVyID0gY29ubmVjdC5DaGF0U2Vzc2lvbi5jcmVhdGUoewogICAgICAgIGNoYXREZXRhaWxzOiBtZWRpYUluZm8sCiAgICAgICAgdHlwZTogIkFHRU5UIiwKICAgICAgICB3ZWJzb2NrZXRNYW5hZ2VyOiBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpCiAgICAgIH0pOwogICAgICAKICAgICAgdHJhY2tDaGF0Q29ubmVjdGlvblN0YXR1cyhjb250cm9sbGVyKTsKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsIG1lZGlhSW5mby5jb250YWN0SWQpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgICAgICByZXR1cm4gY29udHJvbGxlcjsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIGZvciBjb250YWN0ICVzIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCkKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZXJyb3IpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQiLCBtZWRpYUluZm8uY29udGFjdElkLCBlcnJvcik7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvCiAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgdHJhY2tDaGF0Q29ubmVjdGlvblN0YXR1cyA9IGZ1bmN0aW9uIChjb250cm9sbGVyKSB7CiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uQnJva2VuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIiwgZGF0YSk7CiAgICAgIH0pOwoKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Fc3RhYmxpc2hlZChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIsIGRhdGEpOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY3JlYXRlTWVkaWFJbnN0YW5jZSgpOwogICAgICB9CiAgICB9CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMjc5OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuTWVkaWFGYWN0b3J5ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgLyoqIGNvbnRyb2xsZXIgaG9sZGVyICovCiAgICB2YXIgbWVkaWFDb250cm9sbGVycyA9IHt9OwogICAgdmFyIHRvQmVEZXN0cm95ZWQgPSBuZXcgU2V0KCk7CgogICAgdmFyIGxvZ2dlciA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICB2YXIgbG9nQ29tcG9uZW50ID0gY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVDsKCiAgICB2YXIgbWV0YWRhdGEgPSBjb25uZWN0Lm1lcmdlKHt9LCBwYXJhbXMpIHx8IHt9OwogICAgbWV0YWRhdGEucmVnaW9uID0gIG1ldGFkYXRhLnJlZ2lvbiB8fCAidXMtd2VzdC0yIjsgLy8gRGVmYXVsdCBpdCB0byB1cy13ZXN0LTIKCiAgICB2YXIgZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgdmFyIGNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25PYmouZ2V0Q29ubmVjdGlvbklkKCk7CiAgICAgIHZhciBtZWRpYUluZm8gPSBjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpOwogICAgICAvKiogaWYgd2UgZG8gbm90IGhhdmUgdGhlIG1lZGlhIGluZm8gdGhlbiBqdXN0IHJlamVjdCB0aGUgcmVxdWVzdCAqLwogICAgICBpZiAoIW1lZGlhSW5mbykgewogICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJNZWRpYSBpbmZvIGRvZXMgbm90IGV4aXN0IGZvciBhIG1lZGlhIHR5cGUgJXMiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk1lZGlhIGluZm8gZG9lcyBub3QgZXhpc3QgZm9yIHRoaXMgY29ubmVjdGlvbiIpOwogICAgICB9CgogICAgICBpZiAoIW1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSkgewogICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIm1lZGlhIGNvbnRyb2xsZXIgb2YgdHlwZSAlcyBpbml0IiwgY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkKICAgICAgICAgIC53aXRoT2JqZWN0KGNvbm5lY3Rpb25PYmopLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgc3dpdGNoIChjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKSB7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLkNIQVQ6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5DaGF0TWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCksIG1ldGFkYXRhKS5nZXQoKTsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuU09GVFBIT05FOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCkpLmdldCgpOwogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuVGFza01lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpKS5nZXQoKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJVbnJlY29nbml6ZWQgbWVkaWEgdHlwZSAlcyAiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXTsKICAgICAgfQogICAgfTsKCiAgICAvKiogQ2hlY2sgYWxsIHRoZSBhY3RpdmUgc3RhdGVzIGZvciB0aGUgY29ubmVjdGlvbiAqLwogICAgdmFyIGlmQ29ubmVjdGlvbkFjdGl2ZSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIHJldHVybiBjb25uZWN0aW9uT2JqLmlzQWN0aXZlKCk7CiAgICB9OwoKICAgIHZhciBnZXQgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICBpZiAoaWZDb25uZWN0aW9uQWN0aXZlKGNvbm5lY3Rpb25PYmopKSB7CiAgICAgICAgcmV0dXJuIGdldE1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZXN0cm95KGNvbm5lY3Rpb25PYmouZ2V0Q29ubmVjdGlvbklkKCkpOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTWVkaWEgQ29udHJvbGxlciBpcyBubyBsb25nZXIgYXZhaWxhYmxlIGZvciB0aGlzIGNvbm5lY3Rpb24iKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSAmJiAhdG9CZURlc3Ryb3llZC5oYXMoY29ubmVjdGlvbklkKSkgewogICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgbG9nQ29tcG9uZW50LAogICAgICAgICAgIkRlc3Ryb3lpbmcgbWVkaWFDb250cm9sbGVyIGZvciAlcyIsCiAgICAgICAgICBjb25uZWN0aW9uSWQKICAgICAgICApOwogICAgICAgIHRvQmVEZXN0cm95ZWQuYWRkKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdCiAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250cm9sbGVyLmNsZWFuVXAgPT09ICJmdW5jdGlvbiIpIGNvbnRyb2xsZXIuY2xlYW5VcCgpOwogICAgICAgICAgICBkZWxldGUgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICAgICAgICB0b0JlRGVzdHJveWVkLmRlbGV0ZShjb25uZWN0aW9uSWQpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGVsZXRlIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXTsKICAgICAgICAgICAgdG9CZURlc3Ryb3llZC5kZWxldGUoY29ubmVjdGlvbklkKTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGdldDogZ2V0LAogICAgICBkZXN0cm95OiBkZXN0cm95CiAgICB9OwogIH0KfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDQxODoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICAvLyBUT0RPIG1vdmUgc29mdHBob25lIGltcGxlbWVudGF0aW9ucyBoZXJlIC0gV2lsIGRvIHRoaXMgZm9yIEdBCiAgY29ubmVjdC5Tb2Z0cGhvbmVNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAobWVkaWFJbmZvKSB7CiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1lZGlhSW5mbykKICAgICAgfQogICAgfQogIH0KfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDE4NzoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICBjb25uZWN0LlRhc2tNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAobWVkaWFJbmZvKSB7CiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5UQVNLOwoKICAgIHZhciBjcmVhdGVNZWRpYUluc3RhbmNlID0gZnVuY3Rpb24gKCkgewogICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgbWVkaWEgY29udHJvbGxlciBpbml0IiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgIGxvZ2dlcgogICAgICAgIC5pbmZvKGxvZ0NvbXBvbmVudCwgIlRhc2sgbWVkaWEgY29udHJvbGxlciBpbml0IikKICAgICAgICAud2l0aE9iamVjdChtZWRpYUluZm8pOwoKICAgICAgdmFyIGNvbnRyb2xsZXIgPSBjb25uZWN0LlRhc2tTZXNzaW9uLmNyZWF0ZSh7CiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IG1lZGlhSW5mby5pbml0aWFsQ29udGFjdElkLAogICAgICAgIHdlYnNvY2tldE1hbmFnZXI6IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCksCiAgICAgIH0pOwoKICAgICAgdHJhY2tUYXNrQ29ubmVjdGlvblN0YXR1cyhjb250cm9sbGVyKTsKCiAgICAgIHJldHVybiBjb250cm9sbGVyCiAgICAgICAgLmNvbm5lY3QoKQogICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAgICJUYXNrIFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIGZvciBjb250YWN0SWQgJXMiLAogICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkCiAgICAgICAgICApOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KAogICAgICAgICAgICAiVGFzayBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm4gY29udHJvbGxlcjsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIGxvZ2dlcgogICAgICAgICAgICAuZXJyb3IoCiAgICAgICAgICAgICAgbG9nQ29tcG9uZW50LAogICAgICAgICAgICAgICJUYXNrIFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIGZvciBjb250YWN0ICVzIiwKICAgICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkCiAgICAgICAgICAgICkKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZXJyb3IpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KAogICAgICAgICAgICAiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgICAgIGVycm9yCiAgICAgICAgICApOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICBkYXRhOiBkYXRhIHx8IG1lZGlhSW5mbywKICAgICAgfSk7CiAgICB9OwoKICAgIHZhciB0cmFja1Rhc2tDb25uZWN0aW9uU3RhdHVzID0gZnVuY3Rpb24gKGNvbnRyb2xsZXIpIHsKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Ccm9rZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIKICAgICAgICAgIC5lcnJvcihsb2dDb21wb25lbnQsICJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iKQogICAgICAgICAgLndpdGhFeGNlcHRpb24oZGF0YSk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iLCBkYXRhKTsKICAgICAgfSk7CgogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkVzdGFibGlzaGVkKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyCiAgICAgICAgICAuaW5mbyhsb2dDb21wb25lbnQsICJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIiwgZGF0YSk7CiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY3JlYXRlTWVkaWFJbnN0YW5jZSgpOwogICAgICB9LAogICAgfTsKICB9Owp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNzQzOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgdmFyIFJpbmd0b25lRW5naW5lQmFzZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fcHJldkNvbnRhY3RJZCA9IG51bGw7CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lQ29uZmlnLCAicmluZ3RvbmVDb25maWciKTsKICAgIGlmICghcmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJyaW5ndG9uZVVybCBpcyByZXF1aXJlZCEiKTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLkF1ZGlvICYmIHR5cGVvZiBnbG9iYWwuUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgc2VsZi5fYXVkaW8gPSBuZXcgQXVkaW8ocmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpOwogICAgICAgIHNlbGYuX2F1ZGlvLmxvb3AgPSB0cnVlOwogICAgICAgIHNlbGYuX2F1ZGlvLmFkZEV2ZW50TGlzdGVuZXIoImNhbnBsYXkiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9hdWRpb1BsYXlhYmxlID0gdHJ1ZTsKICAgICAgICAgIHJlc29sdmUoc2VsZi5fYXVkaW8pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9hdWRpbyA9IG51bGw7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlVuYWJsZSB0byBwcm92aWRlIGEgcmluZ3RvbmUuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KCiAgICBzZWxmLl9kcml2ZVJpbmd0b25lKCk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiTm90IGltcGxlbWVudGVkLiIpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3N0YXJ0UmluZ3RvbmUgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHRoaXMuX2F1ZGlvKSB7CiAgICAgIHRoaXMuX2F1ZGlvLnBsYXkoKQogICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFBsYXliYWNrIEZhaWx1cmUiLCBjb250YWN0KTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlJpbmd0b25lIFBsYXliYWNrIEZhaWx1cmUiKS53aXRoRXhjZXB0aW9uKGUpLndpdGhPYmplY3Qoe2N1cnJlbnRTcmM6IHNlbGYuX2F1ZGlvLmN1cnJlbnRTcmMsIHNpbmtJZDogc2VsZi5fYXVkaW8uc2lua0lkLCB2b2x1bWU6IHNlbGYuX2F1ZGlvLnZvbHVtZX0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSk7CiAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RhcnQiLCBjb250YWN0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBTdGFydCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fc3RvcFJpbmd0b25lID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIGlmICh0aGlzLl9hdWRpbykgewogICAgICB0aGlzLl9hdWRpby5wYXVzZSgpOwogICAgICB0aGlzLl9hdWRpby5jdXJyZW50VGltZSA9IDA7CiAgICAgIHRoaXMuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RvcCIsIGNvbnRhY3QpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIFN0b3AiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIC8qKgogICAqIFN0b3AgcmluZ3RvbmUuCiAgICovCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5zdG9wUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9zdG9wUmluZ3RvbmUoKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9yaW5ndG9uZVNldHVwID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuUklOR1RPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5fc3RhcnRSaW5ndG9uZShjb250YWN0KTsKICAgICAgc2VsZi5fcHJldkNvbnRhY3RJZCA9IGNvbnRhY3QuZ2V0Q29udGFjdElkKCk7CgogICAgICBjb250YWN0Lm9uQ29ubmVjdGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIGNvbnRhY3Qub25BY2NlcHRlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICBjb250YWN0Lm9uRW5kZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgLy8gSnVzdCB0byBtYWtlIHN1cmUgdG8gc3RvcCB0aGUgcmluZ3RvbmUgaW4gY2FzZSBvZiB0aGUgZmFpbHVyZXMgb2Ygc3BlY2lmaWMgY2FsbGJhY2tzKG9uQWNjZXB0ZWQsb25Db25uZWN0ZWQpOwogICAgICBjb250YWN0Lm9uUmVmcmVzaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgIT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyAmJgogICAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlICE9PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSB7CiAgICAgICAgICBzZWxmLl9zdG9wUmluZ3RvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdCkgewogICAgaWYgKGNvbnRhY3QgJiYgY29udGFjdC5nZXRDb250YWN0SWQoKSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3QuZ2V0Q29udGFjdElkKCkKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ2hhbmdlIHRoZSBhdWRpbyBkZXZpY2UgdXNlZCB0byBwbGF5IHJpbmd0b25lLgogICAqIElmIGF1ZGlvIGVsZW1lbnQgaXMgbm90IGZ1bGx5IGluaXRpYWxpemVkLCB0aGUgQVBJIHdpbGwgd2FpdCBfYXVkaW9QbGF5YWJsZVByb21pc2UgZm9yIDMgc2Vjb25kcyBhbmQgZmFpbCBvbiB0aW1lb3V0LgogICAqIFRoaXMgQVBJIGlzIHN1cHBvcnRlZCBvbmx5IGJ5IGJyb3dzZXJzIHRoYXQgaW1wbGVtZW50ZWQgRVM2IFByb21pc2UgYW5kIGh0dHA6Ly93d3cudzMub3JnL1RSL2F1ZGlvLW91dHB1dC8KICAgKiBSZXR1cm4gYSBQcm9taXNlIHRoYXQgaW5kaWNhdGVzIHRoZSByZXN1bHQgb2YgY2hhbmdpbmcgb3V0cHV0IGRldmljZS4KICAgKi8KICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLnNldE91dHB1dERldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgaWYgKHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlKSB7CiAgICAgIHZhciBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQgPSBQcm9taXNlLnJhY2UoWwogICAgICAgIHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlLAogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmVqZWN0KCJUaW1lZCBvdXQgd2FpdGluZyBmb3IgcGxheWFibGUgYXVkaW8iKTsgfSwgMzAwMC8qbXMqLyk7CiAgICAgICAgfSkKICAgICAgXSk7CiAgICAgIHJldHVybiBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQudGhlbihmdW5jdGlvbiAoYXVkaW8pIHsKICAgICAgICBpZiAoYXVkaW8pIHsKICAgICAgICAgIGlmIChhdWRpby5zZXRTaW5rSWQpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhdWRpby5zZXRTaW5rSWQoZGV2aWNlSWQpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vIGF1ZGlvIGZvdW5kIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLlByb21pc2UpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3QgZWxpZ2libGUgcmluZ3RvbmUgb3duZXIiKTsKICAgIH0KICB9OwoKICB2YXIgVm9pY2VSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKCiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuVk9JQ0UgJiYKICAgICAgICBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CgogICAgbmV3IGNvbm5lY3QuQWdlbnQoKS5nZXRDb250YWN0cygpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgb25Db250YWN0Q29ubmVjdChjb250YWN0KTsKICAgICAgfQogICAgfSk7CiAgfTsKCgogIHZhciBDaGF0UmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CgogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuQ0hBVCAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdCBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKICB2YXIgVGFza1Jpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1Jpbmd0b25lRW5naW5lOwoKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlRBU0sgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2sgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCgogIHZhciBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7CgogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25JbmNvbWluZyhmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLKSB7CiAgICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDYWxsYmFjayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNhbGxiYWNrIFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvKiBleHBvcnQgY29ubmVjdC5SaW5ndG9uZUVuZ2luZSAqLwogIGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZSA9IFZvaWNlUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5DaGF0UmluZ3RvbmVFbmdpbmUgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5UYXNrUmluZ3RvbmVFbmdpbmUgPSBUYXNrUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA2NDI6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwogIGdsb2JhbC5jY3BWZXJzaW9uID0gIlYyIjsKCiAgdmFyIFJUUEpvYkludGVydmFsTXMgPSAxMDAwOwogIHZhciBzdGF0c1JlcG9ydGluZ0pvYkludGVydmFsTXMgPSAzMDAwMDsKICB2YXIgc3RyZWFtQnVmZmVyU2l6ZSA9IDUwMDsKICB2YXIgQ2FsbFR5cGVNYXAgPSB7fTsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLkFVRElPX09OTFldID0gJ0F1ZGlvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLlZJREVPX09OTFldID0gJ1ZpZGVvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLkFVRElPX1ZJREVPXSA9ICdBdWRpb1ZpZGVvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLk5PTkVdID0gJ05vbmUnOwogIHZhciBBVURJT19JTlBVVCA9ICdhdWRpb19pbnB1dCc7CiAgdmFyIEFVRElPX09VVFBVVCA9ICdhdWRpb19vdXRwdXQnOwoKICB2YXIgTWVkaWFUeXBlTWFwID0ge307CiAgTWVkaWFUeXBlTWFwW2Nvbm5lY3QuQ29udGFjdFR5cGUuVk9JQ0VdID0gIlZvaWNlIjsKICB2YXIgVU5LTk9XTl9NRURJQV9UWVBFID0gIlVua25vd24iOwoKICB2YXIgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgdmFyIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IHt9OwogIHZhciBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IHt9OwogIHZhciBydHBTdGF0c0pvYiA9IG51bGw7CiAgdmFyIHJlcG9ydFN0YXRzSm9iID0gbnVsbDsKICAvL0xvZ2dlciBzcGVjaWZpYyB0byBzb2Z0cGhvbmUuCiAgdmFyIGxvZ2dlciA9IG51bGw7CiAgdmFyIFNvZnRwaG9uZUVycm9yVHlwZXMgPSBjb25uZWN0LlNvZnRwaG9uZUVycm9yVHlwZXM7CiAgdmFyIEhBTkdfVVBfTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQgPSAiTXVsdGlTZXNzaW9uSGFuZ1VwIjsKICB2YXIgTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQgPSAiTXVsdGlTZXNzaW9ucyI7CgogIHZhciBsb2NhbE1lZGlhU3RyZWFtID0ge307CgogIHZhciBzb2Z0cGhvbmVDbGllbnRJZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKCiAgdmFyIHJlcXVlc3RJY2VBY2Nlc3MgPSBmdW5jdGlvbiAodHJhbnNwb3J0KSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCkuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgdHJhbnNwb3J0LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHJlc29sdmUoZGF0YS5zb2Z0cGhvbmVUcmFuc3BvcnQuc29mdHBob25lTWVkaWFDb25uZWN0aW9ucyk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBpZiAocmVhc29uLm1lc3NhZ2UgJiYgcmVhc29uLm1lc3NhZ2UuaW5jbHVkZXMoIlNvZnRwaG9uZUNvbm5lY3Rpb25MaW1pdEJyZWFjaGVkRXhjZXB0aW9uIikpIHsKICAgICAgICAgICAgcHVibGlzaEVycm9yKCJtdWx0aXBsZV9zb2Z0cGhvbmVfYWN0aXZlX3Nlc3Npb25zIiwgIk51bWJlciBvZiBhY3RpdmUgc2Vzc2lvbnMgYXJlIG1vcmUgdGhlbiBhbGxvd2VkIGxpbWl0LiIsICIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlamVjdChFcnJvcigicmVxdWVzdEljZUFjY2VzcyBmYWlsZWQiKSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmVqZWN0KEVycm9yKCJBdXRoZW50aWNhdGlvbiBmYWlsZWQgd2hpbGUgcmVxdWVzdEljZUFjY2VzcyIpKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmVqZWN0KEVycm9yKCJBY2Nlc3MgRGVuaWVkIHdoaWxlIHJlcXVlc3RJY2VBY2Nlc3MiKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIHZhciBTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKHNvZnRwaG9uZVBhcmFtcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9nZ2VyID0gbmV3IFNvZnRwaG9uZUxvZ2dlcihjb25uZWN0LmdldExvZygpKTsKICAgIGxvZ2dlci5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIHNvZnRwaG9uZSBtYW5hZ2VyIGluaXRpYWxpemF0aW9uIGhhcyBiZWd1biIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgcnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5OwogICAgaWYgKGNvbm5lY3QuUnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSA9IG5ldyBjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeShsb2dnZXIsCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgICBzb2Z0cGhvbmVDbGllbnRJZCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHJlcXVlc3RJY2VBY2Nlc3MsIHsKICAgICAgICAgIHRyYW5zcG9ydFR5cGU6ICJzb2Z0cGhvbmUiLAogICAgICAgICAgc29mdHBob25lQ2xpZW50SWQ6IHNvZnRwaG9uZUNsaWVudElkCiAgICAgICAgfSksCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBwdWJsaXNoRXJyb3IpKTsKICAgIH0KICAgIGlmICghaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkKCkpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUiwKICAgICAgICAiQ29ubmVjdCBkb2VzIG5vdCBzdXBwb3J0IHRoaXMgYnJvd3Nlci4gU29tZSBmdW5jdGlvbmFsaXR5IG1heSBub3Qgd29yay4gIiwKICAgICAgICAiIik7CiAgICB9CiAgICB2YXIgZ3VtUHJvbWlzZSA9IGZldGNoVXNlck1lZGlhKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICB7CiAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNaWNyb3Bob25lUGVybWlzc2lvbiIsCiAgICAgICAgICBzdGF0dXM6ICJncmFudGVkIgogICAgICAgIH0pOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgcHVibGlzaEVycm9yKGVyciwgIllvdXIgbWljcm9waG9uZSBpcyBub3QgZW5hYmxlZCBpbiB5b3VyIGJyb3dzZXIuICIsICIiKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0IiwgbnVsbCwgCiAgICAgICAgewogICAgICAgICAgY29ubmVjdGl2aXR5Q2hlY2tUeXBlOiAiTWljcm9waG9uZVBlcm1pc3Npb24iLAogICAgICAgICAgc3RhdHVzOiAiZGVuaWVkIgogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIAogICAgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSgpOwogICAgaGFuZGxlU3BlYWtlckRldmljZUNoYW5nZSgpOwogICAgaGFuZGxlTWljcm9waG9uZURldmljZUNoYW5nZSgpOwogICAgbW9uaXRvck1pY3JvcGhvbmVQZXJtaXNzaW9uKCk7CgogICAgdGhpcy5yaW5ndG9uZUVuZ2luZSA9IG51bGw7CiAgICB2YXIgcnRjU2Vzc2lvbnMgPSB7fTsKICAgIC8vIFRyYWNrcyB0aGUgYWdlbnQgY29ubmVjdGlvbiBJRCwgc28gdGhhdCBpZiB0aGUgc2FtZSBjb250YWN0IGdldHMgcmUtcm91dGVkIHRvIHRoZSBzYW1lIGFnZW50LCBpdCdsbCBzdGlsbCBzZXQgdXAgc29mdHBob25lCiAgICB2YXIgY2FsbHNEZXRlY3RlZCA9IHt9OwogICAgdGhpcy5vbkluaXRDb250YWN0U3ViID0ge307CiAgICB0aGlzLm9uSW5pdENvbnRhY3RTdWIudW5zdWJzY3JpYmUgPSBmdW5jdGlvbigpIHt9OwoKICAgIC8vIHZhcmlhYmxlcyBmb3IgZmlyZWZveCBtdWx0aXRhYgogICAgdmFyIGlzU2Vzc2lvblBlbmRpbmcgPSBmYWxzZTsKICAgIHZhciBwZW5kaW5nQ29udGFjdCA9IG51bGw7CiAgICB2YXIgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gbnVsbDsKICAgIHZhciBwb3N0cG9uZVN0YXJ0aW5nU2Vzc2lvbiA9IGZ1bmN0aW9uIChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpc1Nlc3Npb25QZW5kaW5nID0gdHJ1ZTsKICAgICAgcGVuZGluZ0NvbnRhY3QgPSBjb250YWN0OwogICAgICBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBhZ2VudENvbm5lY3Rpb25JZDsKICAgIH0KICAgIHZhciBjYW5jZWxQZW5kaW5nU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgaXNTZXNzaW9uUGVuZGluZyA9IGZhbHNlOwogICAgICBwZW5kaW5nQ29udGFjdCA9IG51bGw7CiAgICAgIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB9CgogICAgLy8gaGVscGVyIG1ldGhvZCB0byBwcm92aWRlIGFjY2VzcyB0byBydGMgc2Vzc2lvbnMKICAgIHRoaXMuZ2V0U2Vzc2lvbiA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQpIHsKICAgICAgcmV0dXJuIHJ0Y1Nlc3Npb25zW2Nvbm5lY3Rpb25JZF07CiAgICB9CgogICAgdGhpcy5yZXBsYWNlTG9jYWxNZWRpYVRyYWNrID0gZnVuY3Rpb24oY29ubmVjdGlvbklkLCB0cmFjaykgewogICAgICB2YXIgc3RyZWFtID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgaWYoc3RyZWFtKXsKICAgICAgICB2YXIgb2xkVHJhY2sgPSBzdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXTsKICAgICAgICB0cmFjay5lbmFibGVkID0gb2xkVHJhY2suZW5hYmxlZDsKICAgICAgICBvbGRUcmFjay5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgc3RyZWFtLnJlbW92ZVRyYWNrKG9sZFRyYWNrKTsKICAgICAgICBzdHJlYW0uYWRkVHJhY2sodHJhY2spOwogICAgICB9CiAgICB9OwoKICAgIHZhciBpc0NvbnRhY3RUZXJtaW5hdGVkID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgcmV0dXJuIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5FTkRFRCB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5FUlJPUiB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5NSVNTRUQ7CiAgICB9OwoKICAgIHZhciBkZXN0cm95U2Vzc2lvbiA9IGZ1bmN0aW9uIChhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnMuaGFzT3duUHJvcGVydHkoYWdlbnRDb25uZWN0aW9uSWQpKSB7CiAgICAgICAgdmFyIHNlc3Npb24gPSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgLy8gQ3VycmVudGx5IHRoZSBhc3N1bXB0aW9uIGlzIGl0IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uIG9ubHkgYW5kIGlmIG9ubHkgaXQgYWxyZWFkeSBoYXMgYmVlbiBodW5nIHVwLgogICAgICAgIC8vIFRPRE86IFVwZGF0ZSBvbmNlIHRoZSBoYW5ndXAgQVBJIGRvZXMgbm90IHRocm93IGV4Y2VwdGlvbnMKICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgICAgc2Vzc2lvbi5oYW5ndXAoKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBsaWx5LmdldExvZygpLndhcm4oIkNsZWFuIHVwIHRoZSBzZXNzaW9uIGxvY2FsbHkgIiArIGFnZW50Q29ubmVjdGlvbklkLCBlcnIubWVzc2FnZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICAvLyBXaGVuIG11bHRpcGxlIFJUQyBzZXNzaW9ucyBkZXRlY3RlZCwgaWdub3JlIHRoZSBuZXcgY2FsbCBhbmQgaGFuZyB1cCB0aGUgcHJldmlvdXMgc2Vzc2lvbnMuCiAgICAvLyBUT0RPOiBVcGRhdGUgd2hlbiBjb25uZWN0LXJ0YyBleHBvc2VzIGFuIEFQSSB0byBkZXRlY3Qgc2Vzc2lvbiBzdGF0dXMuCiAgICB2YXIgc2FuaXR5Q2hlY2tBY3RpdmVTZXNzaW9ucyA9IGZ1bmN0aW9uIChydGNTZXNzaW9ucykgewogICAgICBpZiAoT2JqZWN0LmtleXMocnRjU2Vzc2lvbnMpLmxlbmd0aCA+IDApIHsKICAgICAgICAvLyBFcnJvciEgb3VyIHN0YXRlIGRvZXNuJ3QgbWF0Y2gsIHRlYXIgaXQgYWxsIGRvd24uCiAgICAgICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIHJ0Y1Nlc3Npb25zKSB7CiAgICAgICAgICBpZiAocnRjU2Vzc2lvbnMuaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAvLyBMb2cgYW4gZXJyb3IgZm9yIHRoZSBzZXNzaW9uIHdlIGFyZSBhYm91dCB0byBlbmQuCiAgICAgICAgICAgIHB1Ymxpc2hNdWx0aXBsZVNlc3Npb25zRXZlbnQoSEFOR19VUF9NVUxUSVBMRV9TRVNTSU9OU19FVkVOVCwgcnRjU2Vzc2lvbnNbY29ubmVjdGlvbklkXS5jYWxsSWQsIGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICAgIGRlc3Ryb3lTZXNzaW9uKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiZHVwbGljYXRlIHNlc3Npb24gZGV0ZWN0ZWQsIHJlZnVzaW5nIHRvIHNldHVwIG5ldyBjb25uZWN0aW9uIik7CiAgICAgIH0KICAgIH07CgogICAgdGhpcy5zdGFydFNlc3Npb24gPSBmdW5jdGlvbiAoX2NvbnRhY3QsIF9hZ2VudENvbm5lY3Rpb25JZCkgewogICAgICB2YXIgY29udGFjdCA9IGlzU2Vzc2lvblBlbmRpbmcgPyBwZW5kaW5nQ29udGFjdCA6IF9jb250YWN0OwogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBpc1Nlc3Npb25QZW5kaW5nID8gcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkIDogX2FnZW50Q29ubmVjdGlvbklkOwogICAgICBpZiAoIWNvbnRhY3QgfHwgIWFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNhbmNlbFBlbmRpbmdTZXNzaW9uKCk7CiAgICAgIAogICAgICAvLyBTZXQgdG8gdHJ1ZSwgdGhpcyB3aWxsIGJsb2NrIHN1YnNlcXVlbnQgaW52b2tlcyBmcm9tIGVudGVyaW5nLgogICAgICBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSA9IHRydWU7CiAgICAgIGxvZ2dlci5pbmZvKCJTb2Z0cGhvbmUgY2FsbCBkZXRlY3RlZDoiLCAiY29udGFjdElkICIgKyBjb250YWN0LmdldENvbnRhY3RJZCgpLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIC8vIEVuc3VyZSBvdXIgc2Vzc2lvbiBzdGF0ZSBtYXRjaGVzIG91ciBjb250YWN0IHN0YXRlIHRvIHByZXZlbnQgaXNzdWVzIHNob3VsZCB3ZSBsb3NlIHRyYWNrIG9mIGEgY29udGFjdC4KICAgICAgc2FuaXR5Q2hlY2tBY3RpdmVTZXNzaW9ucyhydGNTZXNzaW9ucyk7CgogICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcpIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBDb25uZWN0aW5nIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CiAgICAgIH0KCiAgICAgIGluaXRpYWxpemVQYXJhbXMoKTsKICAgICAgdmFyIHNvZnRwaG9uZUluZm8gPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmdldFNvZnRwaG9uZU1lZGlhSW5mbygpOwogICAgICB2YXIgY2FsbENvbmZpZyA9IHBhcnNlQ2FsbENvbmZpZyhzb2Z0cGhvbmVJbmZvLmNhbGxDb25maWdKc29uKTsKICAgICAgdmFyIHdlYlNvY2tldFByb3ZpZGVyOwogICAgICBpZiAoY2FsbENvbmZpZy51c2VXZWJTb2NrZXRQcm92aWRlcikgewogICAgICAgIHdlYlNvY2tldFByb3ZpZGVyID0gY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKTsKICAgICAgfQogICAgICB2YXIgc2Vzc2lvbiA9IG5ldyBjb25uZWN0LlJUQ1Nlc3Npb24oCiAgICAgICAgY2FsbENvbmZpZy5zaWduYWxpbmdFbmRwb2ludCwKICAgICAgICBjYWxsQ29uZmlnLmljZVNlcnZlcnMsCiAgICAgICAgc29mdHBob25lSW5mby5jYWxsQ29udGV4dFRva2VuLAogICAgICAgIGxvZ2dlciwKICAgICAgICBjb250YWN0LmdldENvbnRhY3RJZCgpLAogICAgICAgIGFnZW50Q29ubmVjdGlvbklkLAogICAgICAgIHdlYlNvY2tldFByb3ZpZGVyKTsKCiAgICAgIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXSA9IHNlc3Npb247CgogICAgICBpZiAoY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpKSB7CiAgICAgICAgc2Vzc2lvbi5tZWRpYVN0cmVhbSA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKTsKICAgICAgfQoKICAgICAgLy8gQ3VzdG9tIEV2ZW50IHRvIGluZGljYXRlIHRoZSBzZXNzaW9uIGluaXQgb3BlcmF0aW9ucwogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5TRVNTSU9OX0lOSVQsCiAgICAgICAgZGF0YTogewogICAgICAgICAgY29ubmVjdGlvbklkOiBhZ2VudENvbm5lY3Rpb25JZAogICAgICAgIH0KICAgICAgfSk7CgogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkZhaWxlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uLCByZWFzb24pIHsKICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBwdWJsaXNoU29mdHBob25lRmFpbHVyZUxvZ3MocnRjU2Vzc2lvbiwgcmVhc29uKTsKICAgICAgICBwdWJsaXNoU2Vzc2lvbkZhaWx1cmVUZWxlbWV0cnlFdmVudChjb250YWN0LmdldENvbnRhY3RJZCgpLCByZWFzb24pOwogICAgICAgIHN0b3BKb2JzQW5kUmVwb3J0KGNvbnRhY3QsIHJ0Y1Nlc3Npb24uc2Vzc2lvblJlcG9ydCk7CiAgICAgIH07CiAgICAgIHNlc3Npb24ub25TZXNzaW9uQ29ubmVjdGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIENvbm5lY3RlZCIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwogICAgICAgIC8vIEJlY29tZSBtYXN0ZXIgdG8gc2VuZCBsb2dzLCBzaW5jZSB3ZSBuZWVkIGxvZ3MgZnJvbSBzb2Z0cGhvbmUgdGFiLgogICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgLy9zdGFydCBzdGF0cyBjb2xsZWN0aW9uIGFuZCByZXBvcnRpbmcgam9icwogICAgICAgIHN0YXJ0U3RhdHNDb2xsZWN0aW9uSm9iKHJ0Y1Nlc3Npb24pOwogICAgICAgIHN0YXJ0U3RhdHNSZXBvcnRpbmdKb2IoY29udGFjdCk7CiAgICAgICAgZmlyZUNvbnRhY3RBY2NlcHRlZEV2ZW50KGNvbnRhY3QpOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5vblNlc3Npb25Db21wbGV0ZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gQ29tcGxldGVkIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CgogICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIC8vIFN0b3AgYWxsIGpvYnMgYW5kIHBlcmZvcm0gb25lIGxhc3Qgam9iLgogICAgICAgIHN0b3BKb2JzQW5kUmVwb3J0KGNvbnRhY3QsIHJ0Y1Nlc3Npb24uc2Vzc2lvblJlcG9ydCk7CgogICAgICAgIC8vIENsZWFudXAgdGhlIGNhY2hlZCBzdHJlYW1zCiAgICAgICAgZGVsZXRlTG9jYWxNZWRpYVN0cmVhbShhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgIH07CgogICAgICBzZXNzaW9uLm9uTG9jYWxTdHJlYW1BZGRlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uLCBzdHJlYW0pIHsKICAgICAgICAvLyBDYWNoZSB0aGUgc3RyZWFtcyBmb3IgbXV0ZS91bm11dGUKICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2FnZW50Q29ubmVjdGlvbklkXSA9IHsKICAgICAgICAgIHN0cmVhbTogc3RyZWFtCiAgICAgICAgfTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5MT0NBTF9NRURJQV9TVFJFQU1fQ1JFQVRFRCwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgY29ubmVjdGlvbklkOiBhZ2VudENvbm5lY3Rpb25JZAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5yZW1vdGVBdWRpb0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtb3RlLWF1ZGlvJyk7CiAgICAgIGlmIChydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkpIHsKICAgICAgICBzZXNzaW9uLmNvbm5lY3QocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5LmdldChjYWxsQ29uZmlnLmljZVNlcnZlcnMpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXNzaW9uLmNvbm5lY3QoKTsKICAgICAgfQogICAgfQoKICAgIHZhciBvblJlZnJlc2hDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF0gJiYgaXNDb250YWN0VGVybWluYXRlZChjb250YWN0KSkgewogICAgICAgIGRlc3Ryb3lTZXNzaW9uKGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICBjYW5jZWxQZW5kaW5nU2Vzc2lvbigpOwogICAgICB9CiAgICAgIGlmIChjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmICFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSAmJiAoCiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpKSB7CiAgICAgICAgICBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkgJiYgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMoKSkgewogICAgICAgICAgICBwb3N0cG9uZVN0YXJ0aW5nU2Vzc2lvbihjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLnN0YXJ0U2Vzc2lvbihjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgdmFyIG9uSW5pdENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmNvbm5lY3Rpb25JZDsKICAgICAgbG9nZ2VyLmluZm8oIkNvbnRhY3QgZGV0ZWN0ZWQ6IiwgImNvbnRhY3RJZCAiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICBpZiAoIWNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdKSB7CiAgICAgICAgY29udGFjdC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgb25SZWZyZXNoQ29udGFjdChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgc2VsZi5vbkluaXRDb250YWN0U3ViID0gY29ubmVjdC5jb250YWN0KG9uSW5pdENvbnRhY3QpOwoKICAgIC8vIENvbnRhY3QgYWxyZWFkeSBpbiBjb25uZWN0aW5nIHN0YXRlIHNjZW5hcmlvIC0gSW4gdGhpcyBjYXNlIGNvbnRhY3QgSU5JVCBpcyBtaXNzZWQgaGVuY2UgdGhlIE9uUmVmcmVzaCBjYWxsYmFjayBpcyBtaXNzZWQuIAogICAgbmV3IGNvbm5lY3QuQWdlbnQoKS5nZXRDb250YWN0cygpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5jb25uZWN0aW9uSWQ7CiAgICAgIGxvZ2dlci5pbmZvKCJDb250YWN0IGV4aXN0IGluIHRoZSBzbmFwc2hvdC4gUmVpbml0aWF0ZSB0aGUgQ29udGFjdCBhbmQgUlRDIHNlc3Npb24gY3JlYXRpb24gZm9yIGNvbnRhY3RJZCIgKyBjb250YWN0LmdldENvbnRhY3RJZCgpLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgb25Jbml0Q29udGFjdChjb250YWN0KTsKICAgICAgb25SZWZyZXNoQ29udGFjdChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICB9KTsKICB9OwoKICB2YXIgZmlyZUNvbnRhY3RBY2NlcHRlZEV2ZW50ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICB2YXIgYWdlbnRDb25uZWN0aW9uID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKTsKICAgIGlmICghYWdlbnRDb25uZWN0aW9uKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgQWdlbnRDb25uZWN0aW9uLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc29mdHBob25lTWVkaWFJbmZvID0gYWdlbnRDb25uZWN0aW9uLmdldFNvZnRwaG9uZU1lZGlhSW5mbygpOwogICAgaWYgKCFzb2Z0cGhvbmVNZWRpYUluZm8pIHsKICAgICAgbG9nZ2VyLmluZm8oIk5vdCBhYmxlIHRvIHJldHJpZXZlIHRoZSBhdXRvLWFjY2VwdCBzZXR0aW5nIGZyb20gbnVsbCBTb2Z0cGhvbmVNZWRpYUluZm8sIGlnbm9yaW5nIGV2ZW50IHB1Ymxpc2guLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzb2Z0cGhvbmVNZWRpYUluZm8uYXV0b0FjY2VwdCA9PT0gdHJ1ZSkgewogICAgICBsb2dnZXIuaW5mbygiQXV0by1hY2NlcHQgaXMgZW5hYmxlZCwgc2VuZGluZyBvdXQgQWNjZXB0ZWQgZXZlbnQgdG8gc3RvcCByaW5ndG9uZS4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwKICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3QuY29udGFjdElkKQogICAgICB9KTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwgY29udGFjdC5jb250YWN0SWQpLAogICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdC5jb250YWN0SWQpCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGRpc2FibGVkLCByaW5ndG9uZSB3aWxsIGJlIHN0b3BwZWQgYnkgdXNlciBhY3Rpb24uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICAvLyBCaW5kIGV2ZW50cyBmb3IgbXV0ZQogIHZhciBoYW5kbGVTb2Z0UGhvbmVNdXRlVG9nZ2xlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NVVRFLCBtdXRlVG9nZ2xlKTsKICB9OwoKICB2YXIgaGFuZGxlU3BlYWtlckRldmljZUNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX1NQRUFLRVJfREVWSUNFLCBzZXRTcGVha2VyRGV2aWNlKTsKICB9CgogIHZhciBoYW5kbGVNaWNyb3Bob25lRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX01JQ1JPUEhPTkVfREVWSUNFLCBzZXRNaWNyb3Bob25lRGV2aWNlKTsKICB9CgogIHZhciBtb25pdG9yTWljcm9waG9uZVBlcm1pc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICBpZiAoY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uKCkgPiA0Myl7CiAgICAgICAgbmF2aWdhdG9yLnBlcm1pc3Npb25zLnF1ZXJ5KHtuYW1lOiAnbWljcm9waG9uZSd9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHBlcm1pc3Npb25TdGF0dXMpewogICAgICAgICAgcGVybWlzc2lvblN0YXR1cy5vbmNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNaWNyb3Bob25lIFBlcm1pc3Npb246ICIgKyBwZXJtaXNzaW9uU3RhdHVzLnN0YXRlKTsKICAgICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDb25uZWN0aXZpdHlDaGVja1Jlc3VsdCIsIG51bGwsIAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29ubmVjdGl2aXR5Q2hlY2tUeXBlOiAiTWljcm9waG9uZVBlcm1pc3Npb24iLAogICAgICAgICAgICAgIHN0YXR1czogcGVybWlzc2lvblN0YXR1cy5zdGF0ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYocGVybWlzc2lvblN0YXR1cy5zdGF0ZSA9PT0gJ2RlbmllZCcpewogICAgICAgICAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCwKICAgICAgICAgICAgICAgICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLAogICAgICAgICAgICAgICAgIiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCBpbiBkZXRlY3RpbmcgbWljcm9waG9uZSBwZXJtaXNzaW9uIHN0YXR1czogIiArIGUpOwogICAgfQogIH0KCiAgLy8gTWFrZSBzdXJlIG9uY2Ugd2UgZGlzY29ubmVjdGVkIHdlIGdldCB0aGUgbXV0ZSBzdGF0ZSBiYWNrIHRvIG5vcm1hbAogIHZhciBkZWxldGVMb2NhbE1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgZGVsZXRlIGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IGZhbHNlIH0KICAgIH0pOwogIH07CgogIC8vIENoZWNrIGZvciB0aGUgbG9jYWwgc3RyZWFtcyBpZiBleGlzdHMgIC0gIHJldmVydCBpdAogIC8vIEFuZCBpbmZvcm0gb3RoZXIgY2xpZW50cyBhYm91dCB0aGUgY2hhbmdlIAogIHZhciBtdXRlVG9nZ2xlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIHZhciBzdGF0dXM7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGRhdGEgJiYgZGF0YS5tdXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgc3RhdHVzID0gZGF0YS5tdXRlOwogICAgfQoKICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBsb2NhbE1lZGlhU3RyZWFtKSB7CiAgICAgIGlmIChsb2NhbE1lZGlhU3RyZWFtLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICB2YXIgbG9jYWxNZWRpYSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgICAgaWYgKGxvY2FsTWVkaWEpIHsKICAgICAgICAgIHZhciBhdWRpb1RyYWNrcyA9IGxvY2FsTWVkaWEuZ2V0QXVkaW9UcmFja3MoKVswXTsKICAgICAgICAgIGlmIChzdGF0dXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBhdWRpb1RyYWNrcy5lbmFibGVkID0gIXN0YXR1czsKICAgICAgICAgICAgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkID0gc3RhdHVzOwoKICAgICAgICAgICAgaWYgKHN0YXR1cykgewogICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJBZ2VudCBoYXMgbXV0ZWQgdGhlIGNvbnRhY3QsIGNvbm5lY3Rpb25JZCAtICAiICsgY29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJBZ2VudCBoYXMgdW5tdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gIiArIGNvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXR1cyA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5tdXRlZCB8fCBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLAogICAgICBkYXRhOiB7IG11dGVkOiBzdGF0dXMgfQogICAgfSk7CiAgfTsKCiAgdmFyIHNldFNwZWFrZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgaWYgKGNvbm5lY3Qua2V5cyhsb2NhbE1lZGlhU3RyZWFtKS5sZW5ndGggPT09IDAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIHZhciByZW1vdGVBdWRpb0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtb3RlLWF1ZGlvJyk7CiAgICB0cnkgewogICAgICBsb2dnZXIuaW5mbygiVHJ5aW5nIHRvIHNldCBzcGVha2VyIHRvIGRldmljZSAiICsgZGV2aWNlSWQpOwogICAgICBpZiAocmVtb3RlQXVkaW9FbGVtZW50ICYmIHR5cGVvZiByZW1vdGVBdWRpb0VsZW1lbnQuc2V0U2lua0lkID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmVtb3RlQXVkaW9FbGVtZW50LnNldFNpbmtJZChkZXZpY2VJZCk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgdG8gc2V0IHNwZWFrZXIgdG8gZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNQRUFLRVJfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgdmFyIHNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgaWYgKGNvbm5lY3Qua2V5cyhsb2NhbE1lZGlhU3RyZWFtKS5sZW5ndGggPT09IDAgIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkZXZpY2VJZCA9IGRhdGEuZGV2aWNlSWQ7CiAgICB2YXIgc29mdHBob25lTWFuYWdlciA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyKCk7CiAgICB0cnkgewogICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh7IGF1ZGlvOiB7IGRldmljZUlkOiB7IGV4YWN0OiBkZXZpY2VJZCB9IH0gfSkKICAgICAgICAudGhlbihmdW5jdGlvbiAobmV3TWljcm9waG9uZVN0cmVhbSkgewogICAgICAgICAgdmFyIG5ld01pY3JvcGhvbmVUcmFjayA9IG5ld01pY3JvcGhvbmVTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXTsKICAgICAgICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBsb2NhbE1lZGlhU3RyZWFtKSB7CiAgICAgICAgICAgIGlmIChsb2NhbE1lZGlhU3RyZWFtLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICAgICAgICB2YXIgbG9jYWxNZWRpYSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgICAgICAgICAgdmFyIHNlc3Npb24gPSBzb2Z0cGhvbmVNYW5hZ2VyLmdldFNlc3Npb24oY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgICAvL1JlcGxhY2UgdGhlIGF1ZGlvIHRyYWNrIGluIHRoZSBSdGNQZWVyQ29ubmVjdGlvbgogICAgICAgICAgICAgIHNlc3Npb24uX3BjLmdldFNlbmRlcnMoKVswXS5yZXBsYWNlVHJhY2sobmV3TWljcm9waG9uZVRyYWNrKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vUmVwbGFjZSB0aGUgYXVkaW8gdHJhY2sgaW4gdGhlIGxvY2FsIG1lZGlhIHN0cmVhbSAoZm9yIG11dGUgLyB1bm11dGUpCiAgICAgICAgICAgICAgICBzb2Z0cGhvbmVNYW5hZ2VyLnJlcGxhY2VMb2NhbE1lZGlhVHJhY2soY29ubmVjdGlvbklkLCBuZXdNaWNyb3Bob25lVHJhY2spOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgdG8gc2V0IG1pY3JvcGhvbmUgZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLk1JQ1JPUEhPTkVfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgdmFyIHB1Ymxpc2hTb2Z0cGhvbmVGYWlsdXJlTG9ncyA9IGZ1bmN0aW9uIChydGNTZXNzaW9uLCByZWFzb24pIHsKICAgIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLklDRV9DT0xMRUNUSU9OX1RJTUVPVVQpIHsKICAgICAgdmFyIGVuZFBvaW50VXJsID0gIlxuIjsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBydGNTZXNzaW9uLl9pY2VTZXJ2ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBydGNTZXNzaW9uLl9pY2VTZXJ2ZXJzW2ldLnVybHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGVuZFBvaW50VXJsID0gZW5kUG9pbnRVcmwgKyBydGNTZXNzaW9uLl9pY2VTZXJ2ZXJzW2ldLnVybHNbal0gKyAiXG4iOwogICAgICAgIH0KICAgICAgfQogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5JQ0VfQ09MTEVDVElPTl9USU1FT1VULCAiSWNlIGNvbGxlY3Rpb24gdGltZWRvdXQuICIsIGVuZFBvaW50VXJsKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5VU0VSX0JVU1kpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuVVNFUl9CVVNZX0VSUk9SLAogICAgICAgICJTb2Z0cGhvbmUgY2FsbCBVc2VyQnVzeSBlcnJvci4gIiwKICAgICAgICAiIik7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuU0lHTkFMTElOR19IQU5EU0hBS0VfRkFJTFVSRSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5TSUdOQUxMSU5HX0hBTkRTSEFLRV9GQUlMVVJFLAogICAgICAgICJIYW5kc2hha2luZyB3aXRoIFNpZ25hbGxpbmcgU2VydmVyICIgKyBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkgKyAiIGZhaWxlZC4gIiwKICAgICAgICBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkdVTV9USU1FT1VUX0ZBSUxVUkUgfHwgcmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5HVU1fT1RIRVJfRkFJTFVSRSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQsCiAgICAgICAgIllvdXIgbWljcm9waG9uZSBpcyBub3QgZW5hYmxlZCBpbiB5b3VyIGJyb3dzZXIuICIsCiAgICAgICAgIiIpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlNJR05BTExJTkdfQ09OTkVDVElPTl9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlNJR05BTExJTkdfQ09OTkVDVElPTl9GQUlMVVJFLAogICAgICAgICJVUkwgIiArIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSArICIgY2Fubm90IGJlIHJlYWNoZWQuICIsCiAgICAgICAgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5DQUxMX05PVF9GT1VORCkgewogICAgICAvLyBObyBuZWVkIHRvIHB1Ymxpc2ggYW55IHNvZnRwaG9uZSBlcnJvciBmb3IgdGhpcyBjYXNlLiBDQ1AgVVggd2lsbCBoYW5kbGUgdGhpcyBjYXNlLgogICAgICBsb2dnZXIuZXJyb3IoIlNvZnRwaG9uZSBjYWxsIGZhaWxlZCBkdWUgdG8gQ2FsbE5vdEZvdW5kRXhjZXB0aW9uLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9IGVsc2UgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5XRUJSVENfRVJST1IsCiAgICAgICAgIndlYnJ0YyBzeXN0ZW0gZXJyb3IuICIsCiAgICAgICAgIiIpOwogICAgfQogIH07CgogIC8qKiBQYXJzZSB0aGUgSlNPTiBlbmNvZGVkIHdlYiBjYWxsIGNvbmZpZyBpbnRvIHRoZSBkYXRhIGl0IHJlcHJlc2VudHMuICovCiAgdmFyIHBhcnNlQ2FsbENvbmZpZyA9IGZ1bmN0aW9uIChzZXJpYWxpemVkQ29uZmlnKSB7CiAgICAvLyBPdXIgdW5kZXJzY29yZSBpcyB0b28gb2xkIGZvciB1bmVzY2FwZQogICAgLy8gaHR0cHM6Ly9pc3N1ZXMuYW1hem9uLmNvbS9pc3N1ZXMvQ1NXRi0xNDY3CiAgICB2YXIgZGVjb2RlZEpTT04gPSBzZXJpYWxpemVkQ29uZmlnLnJlcGxhY2UoLyZxdW90Oy9nLCAnIicpOwogICAgcmV0dXJuIEpTT04ucGFyc2UoZGVjb2RlZEpTT04pOwogIH07CgogIHZhciBmZXRjaFVzZXJNZWRpYSA9IGZ1bmN0aW9uIChjYWxsYmFja3NJbikgewogICAgdmFyIGNhbGxiYWNrcyA9IGNhbGxiYWNrc0luIHx8IHt9OwogICAgY2FsbGJhY2tzLnN1Y2Nlc3MgPSBjYWxsYmFja3Muc3VjY2VzcyB8fCBmdW5jdGlvbiAoKSB7IH07CiAgICBjYWxsYmFja3MuZmFpbHVyZSA9IGNhbGxiYWNrcy5mYWlsdXJlIHx8IGZ1bmN0aW9uICgpIHsgfTsKCiAgICB2YXIgQ09OU1RSQUlOVCA9IHsKICAgICAgYXVkaW86IHRydWUKICAgIH07CgogICAgdmFyIHByb21pc2UgPSBudWxsOwoKICAgIGlmICh0eXBlb2YgUHJvbWlzZSAhPT0gImZ1bmN0aW9uIikgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzID09PSAib2JqZWN0IiAmJiB0eXBlb2YgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcHJvbWlzZSA9IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKENPTlNUUkFJTlQpOwoKICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhKENPTlNUUkFJTlQsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICB2YXIgYXVkaW9UcmFja3MgPSBzdHJlYW0uZ2V0QXVkaW9UcmFja3MoKTsKICAgICAgaWYgKGF1ZGlvVHJhY2tzICYmIGF1ZGlvVHJhY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhzdHJlYW0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCk7CiAgICB9KTsKICAgIHJldHVybiBwcm9taXNlOwogIH07CgogIHZhciBwdWJsaXNoRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBtZXNzYWdlLCBlbmRQb2ludFVybCkgewogICAgbG9nZ2VyLmVycm9yKCJTb2Z0cGhvbmUgZXJyb3Igb2NjdXJyZWQgOiAiLCBlcnJvclR5cGUsCiAgICAgIG1lc3NhZ2UgfHwgIiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsCiAgICAgIGRhdGE6IG5ldyBjb25uZWN0LlNvZnRwaG9uZUVycm9yKGVycm9yVHlwZSwgbWVzc2FnZSwgZW5kUG9pbnRVcmwpCiAgICB9KTsKICB9OwoKICB2YXIgcHVibGlzaFNlc3Npb25GYWlsdXJlVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoY29udGFjdElkLCByZWFzb24pIHsKICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gRmFpbGVkIiwgY29udGFjdElkLCB7CiAgICAgIGZhaWxlZFJlYXNvbjogcmVhc29uCiAgICB9KTsKICB9OwoKICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkLCBkYXRhKSB7CiAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgIGNvbnRhY3RJZDogY29udGFjdElkLAogICAgICBkYXRhOiBkYXRhCiAgICB9KTsKICB9OwoKICAvLyBQdWJsaXNoIHRoZSBjb250YWN0IGFuZCBhZ2VudCBpbmZvcm1hdGlvbiBpbiBhIG11bHRpcGxlIHNlc3Npb25zIHNjZW5hcmlvcwogIHZhciBwdWJsaXNoTXVsdGlwbGVTZXNzaW9uc0V2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkLCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KGV2ZW50TmFtZSwgY29udGFjdElkLCBbewogICAgICBuYW1lOiAiQWdlbnRDb25uZWN0aW9uSWQiLAogICAgICB2YWx1ZTogYWdlbnRDb25uZWN0aW9uSWQKICAgIH1dKTsKICAgIGxvZ2dlci5pbmZvKCJQdWJsaXNoIG11bHRpcGxlIHNlc3Npb24gZXJyb3IgbWV0cmljcyIsIGV2ZW50TmFtZSwgImNvbnRhY3RJZCAiICsgY29udGFjdElkLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkKICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgfTsKCiAgdmFyIGlzQnJvd3NlclNvZnRQaG9uZVN1cHBvcnRlZCA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIEluIE9wZXJhLCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJPcGVyYSIgb3IgYWZ0ZXIgIlZlcnNpb24iCiAgICBpZiAoY29ubmVjdC5pc09wZXJhQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0T3BlcmFCcm93c2VyVmVyc2lvbigpID4gMTcpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBJbiBDaHJvbWUsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIkNocm9tZSIKICAgIGVsc2UgaWYgKGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbigpID4gMjIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBJbiBGaXJlZm94LCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJGaXJlZm94IgogICAgZWxzZSBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRGaXJlZm94QnJvd3NlclZlcnNpb24oKSA+IDIxKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07CgogIHZhciBzZW5kU29mdHBob25lTWV0cmljcyA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc3RyZWFtU3RhdHMgPSB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIuc2xpY2UoKTsKICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogICAgaWYgKHN0cmVhbVN0YXRzLmxlbmd0aCA+IDApIHsKICAgICAgY29udGFjdC5zZW5kU29mdHBob25lTWV0cmljcyhzdHJlYW1TdGF0cywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKCJzZW5kU29mdHBob25lTWV0cmljcyBzdWNjZXNzIiArIEpTT04uc3RyaW5naWZ5KHN0cmVhbVN0YXRzKSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgbG9nZ2VyLmVycm9yKCJzZW5kU29mdHBob25lTWV0cmljcyBmYWlsZWQuIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICB2YXIgc2VuZFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uIChjb250YWN0LCByZXBvcnQsIHVzZXJBdWRpb1N0YXRzLCByZW1vdGVBdWRpb1N0YXRzKSB7CiAgICByZXBvcnQuc3RyZWFtU3RhdHMgPSBbYWRkU3RyZWFtVHlwZVRvU3RhdHModXNlckF1ZGlvU3RhdHMsIEFVRElPX0lOUFVUKSwKICAgIGFkZFN0cmVhbVR5cGVUb1N0YXRzKHJlbW90ZUF1ZGlvU3RhdHMsIEFVRElPX09VVFBVVCldOwogICAgdmFyIGNhbGxSZXBvcnQgPSB7CiAgICAgIGNhbGxTdGFydFRpbWU6IHJlcG9ydC5zZXNzaW9uU3RhcnRUaW1lLAogICAgICBjYWxsRW5kVGltZTogcmVwb3J0LnNlc3Npb25FbmRUaW1lLAogICAgICBndW1UaW1lTWlsbGlzOiByZXBvcnQuZ3VtVGltZU1pbGxpcywKICAgICAgaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzOiByZXBvcnQuaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzLAogICAgICBpY2VDb2xsZWN0aW9uVGltZU1pbGxpczogcmVwb3J0LmljZUNvbGxlY3Rpb25UaW1lTWlsbGlzLAogICAgICBzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXM6IHJlcG9ydC5zaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMsCiAgICAgIGhhbmRzaGFraW5nVGltZU1pbGxpczogcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpcywKICAgICAgcHJlVGFsa2luZ1RpbWVNaWxsaXM6IHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpcywKICAgICAgdGFsa2luZ1RpbWVNaWxsaXM6IHJlcG9ydC50YWxraW5nVGltZU1pbGxpcywKICAgICAgY2xlYW51cFRpbWVNaWxsaXM6IHJlcG9ydC5jbGVhbnVwVGltZU1pbGxpcywKICAgICAgaWNlQ29sbGVjdGlvbkZhaWx1cmU6IHJlcG9ydC5pY2VDb2xsZWN0aW9uRmFpbHVyZSwKICAgICAgc2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlOiByZXBvcnQuc2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlLAogICAgICBoYW5kc2hha2luZ0ZhaWx1cmU6IHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmUsCiAgICAgIGd1bU90aGVyRmFpbHVyZTogcmVwb3J0Lmd1bU90aGVyRmFpbHVyZSwKICAgICAgZ3VtVGltZW91dEZhaWx1cmU6IHJlcG9ydC5ndW1UaW1lb3V0RmFpbHVyZSwKICAgICAgY3JlYXRlT2ZmZXJGYWlsdXJlOiByZXBvcnQuY3JlYXRlT2ZmZXJGYWlsdXJlLAogICAgICBzZXRMb2NhbERlc2NyaXB0aW9uRmFpbHVyZTogcmVwb3J0LnNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlLAogICAgICB1c2VyQnVzeUZhaWx1cmU6IHJlcG9ydC51c2VyQnVzeUZhaWx1cmUsCiAgICAgIGludmFsaWRSZW1vdGVTRFBGYWlsdXJlOiByZXBvcnQuaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUsCiAgICAgIG5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZTogcmVwb3J0Lm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSwKICAgICAgc2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlOiByZXBvcnQuc2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlLAogICAgICBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzOiByZXBvcnQuc3RyZWFtU3RhdHMKICAgIH07CiAgICBjb250YWN0LnNlbmRTb2Z0cGhvbmVSZXBvcnQoY2FsbFJlcG9ydCwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oInNlbmRTb2Z0cGhvbmVSZXBvcnQgc3VjY2VzcyIgKyBKU09OLnN0cmluZ2lmeShjYWxsUmVwb3J0KSkKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5lcnJvcigic2VuZFNvZnRwaG9uZVJlcG9ydCBmYWlsZWQuIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgdmFyIHN0YXJ0U3RhdHNDb2xsZWN0aW9uSm9iID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgIHJ0cFN0YXRzSm9iID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgcnRjU2Vzc2lvbi5nZXRVc2VyQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzVXNlclN0YXRzID0gYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzOwogICAgICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMsIHByZXZpb3VzVXNlclN0YXRzLCBBVURJT19JTlBVVCkpOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBsb2dnZXIuZGVidWcoIkZhaWxlZCB0byBnZXQgdXNlciBhdWRpbyBzdGF0cy4iLCBlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CiAgICAgIHJ0Y1Nlc3Npb24uZ2V0UmVtb3RlQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzUmVtb3RlU3RhdHMgPSBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0czsKICAgICAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgcHJldmlvdXNSZW1vdGVTdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCByZW1vdGUgYXVkaW8gc3RhdHMuIiwgZXJyb3IpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwogICAgfSwgMTAwMCk7CiAgfTsKCiAgdmFyIHN0YXJ0U3RhdHNSZXBvcnRpbmdKb2IgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgcmVwb3J0U3RhdHNKb2IgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICBzZW5kU29mdHBob25lTWV0cmljcyhjb250YWN0KTsKICAgIH0sIHN0YXRzUmVwb3J0aW5nSm9iSW50ZXJ2YWxNcyk7CiAgfTsKCiAgdmFyIGluaXRpYWxpemVQYXJhbXMgPSBmdW5jdGlvbiAoKSB7CiAgICBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSBudWxsOwogICAgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSBudWxsOwogICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgICBydHBTdGF0c0pvYiA9IG51bGw7CiAgICByZXBvcnRTdGF0c0pvYiA9IG51bGw7CiAgfTsKCiAgdmFyIGdldFRpbWVTZXJpZXNTdGF0cyA9IGZ1bmN0aW9uIChjdXJyZW50U3RhdHMsIHByZXZpb3VzU3RhdHMsIHN0cmVhbVR5cGUpIHsKICAgIGlmIChwcmV2aW91c1N0YXRzICYmIGN1cnJlbnRTdGF0cykgewogICAgICB2YXIgcGFja2V0c0xvc3QgPSBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QgPiBwcmV2aW91c1N0YXRzLnBhY2tldHNMb3N0ID8gY3VycmVudFN0YXRzLnBhY2tldHNMb3N0IC0gcHJldmlvdXNTdGF0cy5wYWNrZXRzTG9zdCA6IDA7CiAgICAgIHZhciBwYWNrZXRzQ291bnQgPSBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50ID4gcHJldmlvdXNTdGF0cy5wYWNrZXRzQ291bnQgPyBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50IC0gcHJldmlvdXNTdGF0cy5wYWNrZXRzQ291bnQgOiAwOwogICAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKGN1cnJlbnRTdGF0cy50aW1lc3RhbXAsCiAgICAgICAgcGFja2V0c0xvc3QsCiAgICAgICAgcGFja2V0c0NvdW50LAogICAgICAgIHN0cmVhbVR5cGUsCiAgICAgICAgY3VycmVudFN0YXRzLmF1ZGlvTGV2ZWwsCiAgICAgICAgY3VycmVudFN0YXRzLmpiTWlsbGlzZWNvbmRzLAogICAgICAgIGN1cnJlbnRTdGF0cy5ydHRNaWxsaXNlY29uZHMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhjdXJyZW50U3RhdHMudGltZXN0YW1wLAogICAgICAgIGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCwKICAgICAgICBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50LAogICAgICAgIHN0cmVhbVR5cGUsCiAgICAgICAgY3VycmVudFN0YXRzLmF1ZGlvTGV2ZWwsCiAgICAgICAgY3VycmVudFN0YXRzLmpiTWlsbGlzZWNvbmRzLAogICAgICAgIGN1cnJlbnRTdGF0cy5ydHRNaWxsaXNlY29uZHMpOwogICAgfQogIH07CgogIHZhciBzdG9wSm9iID0gZnVuY3Rpb24gKHRhc2spIHsKICAgIGlmICh0YXNrICE9PSBudWxsKSB7CiAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRhc2spOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgdmFyIHN0b3BKb2JzQW5kUmVwb3J0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIHNlc3Npb25SZXBvcnQpIHsKICAgIHJ0cFN0YXRzSm9iID0gc3RvcEpvYihydHBTdGF0c0pvYik7CiAgICByZXBvcnRTdGF0c0pvYiA9IHN0b3BKb2IocmVwb3J0U3RhdHNKb2IpOwogICAgc2VuZFNvZnRwaG9uZVJlcG9ydChjb250YWN0LCBzZXNzaW9uUmVwb3J0LCBhZGRTdHJlYW1UeXBlVG9TdGF0cyhhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMsIEFVRElPX0lOUFVUKSwgYWRkU3RyZWFtVHlwZVRvU3RhdHMoYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMsIEFVRElPX09VVFBVVCkpOwogICAgc2VuZFNvZnRwaG9uZU1ldHJpY3MoY29udGFjdCk7CiAgfTsKCiAgLyoqCiAgKiAgIEFkZGluZyBzdHJlYW10eXBlIHBhcmFtZXRlciBvbiB0b3Agb2YgUlRDSlMgUlRTdGF0cyBvYmplY3QuCiAgKi8KICB2YXIgUlRQU3RyZWFtU3RhdHMgPSBmdW5jdGlvbiAodGltZXN0YW1wLCBwYWNrZXRzTG9zdCwgcGFja2V0c0NvdW50LCBzdHJlYW1UeXBlLCBhdWRpb0xldmVsLCBqaXR0ZXJCdWZmZXJNaWxsaXMsIHJvdW5kVHJpcFRpbWVNaWxsaXMpIHsKICAgIHRoaXMuc29mdHBob25lU3RyZWFtVHlwZSA9IHN0cmVhbVR5cGU7CiAgICB0aGlzLnRpbWVzdGFtcCA9IHRpbWVzdGFtcDsKICAgIHRoaXMucGFja2V0c0xvc3QgPSBwYWNrZXRzTG9zdDsKICAgIHRoaXMucGFja2V0c0NvdW50ID0gcGFja2V0c0NvdW50OwogICAgdGhpcy5hdWRpb0xldmVsID0gYXVkaW9MZXZlbDsKICAgIHRoaXMuaml0dGVyQnVmZmVyTWlsbGlzID0gaml0dGVyQnVmZmVyTWlsbGlzOwogICAgdGhpcy5yb3VuZFRyaXBUaW1lTWlsbGlzID0gcm91bmRUcmlwVGltZU1pbGxpczsKICB9OwoKICB2YXIgYWRkU3RyZWFtVHlwZVRvU3RhdHMgPSBmdW5jdGlvbiAoc3RhdHMsIHN0cmVhbVR5cGUpIHsKICAgIHN0YXRzID0gc3RhdHMgfHwge307CiAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKHN0YXRzLnRpbWVzdGFtcCwgc3RhdHMucGFja2V0c0xvc3QsIHN0YXRzLnBhY2tldHNDb3VudCwgc3RyZWFtVHlwZSwgc3RhdHMuYXVkaW9MZXZlbCk7CiAgfTsKCiAgdmFyIFNvZnRwaG9uZUxvZ2dlciA9IGZ1bmN0aW9uIChsb2dnZXIpIHsKICAgIHRoaXMuX29yaWdpbmFsTG9nZ2VyID0gbG9nZ2VyOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fdGVlID0gZnVuY3Rpb24gKGxldmVsLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBjYWxsIHRoZSBvcmlnaW5hbCBsb2dnZXIgb2JqZWN0IHRvIG91dHB1dCB0byBicm93c2VyCiAgICAgICAgLy9Db25uZWN0IGxvZ2dlciBmb2xsb3dzICVzIGZvcm1hdCB0byBwcmludCBvYmplY3RzIHRvIGNvbnNvbGUuCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHNbMF0pOwogICAgICAgIHZhciBmb3JtYXQgPSAiIjsKICAgICAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgZm9ybWF0ID0gZm9ybWF0ICsgIiAlcyI7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseShzZWxmLl9vcmlnaW5hbExvZ2dlciwgW2Nvbm5lY3QuTG9nQ29tcG9uZW50LlNPRlRQSE9ORSwgZm9ybWF0XS5jb25jYXQoYXJncykpOwogICAgICB9OwogICAgfTsKICB9OwoKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgxLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5kZWJ1ZykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoMiwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuaW5mbykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgzLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5sb2cpKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDQsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLndhcm4pKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSg1LCB0aGlzLl9vcmlnaW5hbExvZ2dlci5lcnJvcikoYXJndW1lbnRzKTsKICB9OwoKICBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIgPSBTb2Z0cGhvbmVNYW5hZ2VyOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTQ0OgovKioqLyAoKCkgPT4gewoKLyohIEBsaWNlbnNlIHNwcmludGYuanMgfCBDb3B5cmlnaHQgKGMpIDIwMDctMjAxMyBBbGV4YW5kcnUgTWFyYXN0ZWFudSA8aGVsbG8gYXQgYWxleGVpIGRvdCBybz4gfCAzIGNsYXVzZSBCU0QgbGljZW5zZSAqLwoKKGZ1bmN0aW9uKCkgewogICB2YXIgY3R4ID0gdGhpcyB8fCBnbG9iYWxUaGlzOwoKCXZhciBzcHJpbnRmID0gZnVuY3Rpb24oKSB7CgkJaWYgKCFzcHJpbnRmLmNhY2hlLmhhc093blByb3BlcnR5KGFyZ3VtZW50c1swXSkpIHsKCQkJc3ByaW50Zi5jYWNoZVthcmd1bWVudHNbMF1dID0gc3ByaW50Zi5wYXJzZShhcmd1bWVudHNbMF0pOwoJCX0KCQlyZXR1cm4gc3ByaW50Zi5mb3JtYXQuY2FsbChudWxsLCBzcHJpbnRmLmNhY2hlW2FyZ3VtZW50c1swXV0sIGFyZ3VtZW50cyk7Cgl9OwoKCXNwcmludGYuZm9ybWF0ID0gZnVuY3Rpb24ocGFyc2VfdHJlZSwgYXJndikgewoJCXZhciBjdXJzb3IgPSAxLCB0cmVlX2xlbmd0aCA9IHBhcnNlX3RyZWUubGVuZ3RoLCBub2RlX3R5cGUgPSAnJywgYXJnLCBvdXRwdXQgPSBbXSwgaSwgaywgbWF0Y2gsIHBhZCwgcGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aDsKCQlmb3IgKGkgPSAwOyBpIDwgdHJlZV9sZW5ndGg7IGkrKykgewoJCQlub2RlX3R5cGUgPSBnZXRfdHlwZShwYXJzZV90cmVlW2ldKTsKCQkJaWYgKG5vZGVfdHlwZSA9PT0gJ3N0cmluZycpIHsKCQkJCW91dHB1dC5wdXNoKHBhcnNlX3RyZWVbaV0pOwoJCQl9CgkJCWVsc2UgaWYgKG5vZGVfdHlwZSA9PT0gJ2FycmF5JykgewoJCQkJbWF0Y2ggPSBwYXJzZV90cmVlW2ldOyAvLyBjb252ZW5pZW5jZSBwdXJwb3NlcyBvbmx5CgkJCQlpZiAobWF0Y2hbMl0pIHsgLy8ga2V5d29yZCBhcmd1bWVudAoJCQkJCWFyZyA9IGFyZ3ZbY3Vyc29yXTsKCQkJCQlmb3IgKGsgPSAwOyBrIDwgbWF0Y2hbMl0ubGVuZ3RoOyBrKyspIHsKCQkJCQkJaWYgKCFhcmcuaGFzT3duUHJvcGVydHkobWF0Y2hbMl1ba10pKSB7CgkJCQkJCQl0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gcHJvcGVydHkgIiVzIiBkb2VzIG5vdCBleGlzdCcsIG1hdGNoWzJdW2tdKSk7CgkJCQkJCX0KCQkJCQkJYXJnID0gYXJnW21hdGNoWzJdW2tdXTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChtYXRjaFsxXSkgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChleHBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W21hdGNoWzFdXTsKCQkJCX0KCQkJCWVsc2UgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChpbXBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W2N1cnNvcisrXTsKCQkJCX0KCgkJCQlpZiAoL1tec10vLnRlc3QobWF0Y2hbOF0pICYmIChnZXRfdHlwZShhcmcpICE9ICdudW1iZXInKSkgewoJCQkJCXRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlcycsIGdldF90eXBlKGFyZykpKTsKCQkJCX0KCQkJCXN3aXRjaCAobWF0Y2hbOF0pIHsKCQkJCQljYXNlICdiJzogYXJnID0gYXJnLnRvU3RyaW5nKDIpOyBicmVhazsKCQkJCQljYXNlICdjJzogYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShhcmcpOyBicmVhazsKCQkJCQljYXNlICdkJzogYXJnID0gcGFyc2VJbnQoYXJnLCAxMCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2UnOiBhcmcgPSBtYXRjaFs3XSA/IGFyZy50b0V4cG9uZW50aWFsKG1hdGNoWzddKSA6IGFyZy50b0V4cG9uZW50aWFsKCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2YnOiBhcmcgPSBtYXRjaFs3XSA/IHBhcnNlRmxvYXQoYXJnKS50b0ZpeGVkKG1hdGNoWzddKSA6IHBhcnNlRmxvYXQoYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAnbyc6IGFyZyA9IGFyZy50b1N0cmluZyg4KTsgYnJlYWs7CgkJCQkJY2FzZSAncyc6IGFyZyA9ICgoYXJnID0gU3RyaW5nKGFyZykpICYmIG1hdGNoWzddID8gYXJnLnN1YnN0cmluZygwLCBtYXRjaFs3XSkgOiBhcmcpOyBicmVhazsKCQkJCQljYXNlICd1JzogYXJnID0gYXJnID4+PiAwOyBicmVhazsKCQkJCQljYXNlICd4JzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KTsgYnJlYWs7CgkJCQkJY2FzZSAnWCc6IGFyZyA9IGFyZy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsgYnJlYWs7CgkJCQl9CgkJCQlhcmcgPSAoL1tkZWZdLy50ZXN0KG1hdGNoWzhdKSAmJiBtYXRjaFszXSAmJiBhcmcgPj0gMCA/ICcrJysgYXJnIDogYXJnKTsKCQkJCXBhZF9jaGFyYWN0ZXIgPSBtYXRjaFs0XSA/IG1hdGNoWzRdID09ICcwJyA/ICcwJyA6IG1hdGNoWzRdLmNoYXJBdCgxKSA6ICcgJzsKCQkJCXBhZF9sZW5ndGggPSBtYXRjaFs2XSAtIFN0cmluZyhhcmcpLmxlbmd0aDsKCQkJCXBhZCA9IG1hdGNoWzZdID8gc3RyX3JlcGVhdChwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoKSA6ICcnOwoJCQkJb3V0cHV0LnB1c2gobWF0Y2hbNV0gPyBhcmcgKyBwYWQgOiBwYWQgKyBhcmcpOwoJCQl9CgkJfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9OwoKCXNwcmludGYuY2FjaGUgPSB7fTsKCglzcHJpbnRmLnBhcnNlID0gZnVuY3Rpb24oZm10KSB7CgkJdmFyIF9mbXQgPSBmbXQsIG1hdGNoID0gW10sIHBhcnNlX3RyZWUgPSBbXSwgYXJnX25hbWVzID0gMDsKCQl3aGlsZSAoX2ZtdCkgewoJCQlpZiAoKG1hdGNoID0gL15bXlx4MjVdKy8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCXBhcnNlX3RyZWUucHVzaChtYXRjaFswXSk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1ezJ9Ly5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJcGFyc2VfdHJlZS5wdXNoKCclJyk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteXCldKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1mb3N1eFhdKS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCWlmIChtYXRjaFsyXSkgewoJCQkJCWFyZ19uYW1lcyB8PSAxOwoJCQkJCXZhciBmaWVsZF9saXN0ID0gW10sIHJlcGxhY2VtZW50X2ZpZWxkID0gbWF0Y2hbMl0sIGZpZWxkX21hdGNoID0gW107CgkJCQkJaWYgKChmaWVsZF9tYXRjaCA9IC9eKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJd2hpbGUgKChyZXBsYWNlbWVudF9maWVsZCA9IHJlcGxhY2VtZW50X2ZpZWxkLnN1YnN0cmluZyhmaWVsZF9tYXRjaFswXS5sZW5ndGgpKSAhPT0gJycpIHsKCQkJCQkJCWlmICgoZmllbGRfbWF0Y2ggPSAvXlwuKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSBpZiAoKGZpZWxkX21hdGNoID0gL15cWyhcZCspXF0vLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCQkJfQoJCQkJCW1hdGNoWzJdID0gZmllbGRfbGlzdDsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWFyZ19uYW1lcyB8PSAyOwoJCQkJfQoJCQkJaWYgKGFyZ19uYW1lcyA9PT0gMykgewoJCQkJCXRocm93KCdbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CgkJCQl9CgkJCQlwYXJzZV90cmVlLnB1c2gobWF0Y2gpOwoJCQl9CgkJCWVsc2UgewoJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCX0KCQkJX2ZtdCA9IF9mbXQuc3Vic3RyaW5nKG1hdGNoWzBdLmxlbmd0aCk7CgkJfQoJCXJldHVybiBwYXJzZV90cmVlOwoJfTsKCgl2YXIgdnNwcmludGYgPSBmdW5jdGlvbihmbXQsIGFyZ3YsIF9hcmd2KSB7CgkJX2FyZ3YgPSBhcmd2LnNsaWNlKDApOwoJCV9hcmd2LnNwbGljZSgwLCAwLCBmbXQpOwoJCXJldHVybiBzcHJpbnRmLmFwcGx5KG51bGwsIF9hcmd2KTsKCX07CgoJLyoqCgkgKiBoZWxwZXJzCgkgKi8KCWZ1bmN0aW9uIGdldF90eXBlKHZhcmlhYmxlKSB7CgkJcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YXJpYWJsZSkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCk7Cgl9CgoJZnVuY3Rpb24gc3RyX3JlcGVhdChpbnB1dCwgbXVsdGlwbGllcikgewoJCWZvciAodmFyIG91dHB1dCA9IFtdOyBtdWx0aXBsaWVyID4gMDsgb3V0cHV0Wy0tbXVsdGlwbGllcl0gPSBpbnB1dCkgey8qIGRvIG5vdGhpbmcgKi99CgkJcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKCX0KCgkvKioKCSAqIGV4cG9ydCB0byBlaXRoZXIgYnJvd3NlciBvciBub2RlLmpzCgkgKi8KCWN0eC5zcHJpbnRmID0gc3ByaW50ZjsKCWN0eC52c3ByaW50ZiA9IHZzcHJpbnRmOwp9KSgpOwoKCgovKioqLyB9KSwKCi8qKiovIDgyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW0KICAgICoKICAgICogUmVwcmVzZW50cyBhbiBvYmplY3QgZnJvbSB3aGljaCBtZXNzYWdlcyBjYW4gYmUgcmVhZCBhbmQgdG8gd2hpY2gKICAgICogbWVzc2FnZXMgY2FuIGJlIHNlbnQuCiAgICAqLwogICB2YXIgU3RyZWFtID0gZnVuY3Rpb24oKSB7fTsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byB0aGUgc3RyZWFtLiAgVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKioKICAgICogUHJvdmlkZSBhIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiBtZXNzYWdlcyBhcmUgcmVjZWl2ZWQgZnJvbSB0aGlzIHN0cmVhbS4KICAgICogVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgbnVsbCBzdHJlYW0gd2hpY2ggcHJvdmlkZXMgbm8gbWVzc2FnZSBzZW5kaW5nIG9yIHJlY2VpdmluZyBmYWNpbGl0aWVzLgogICAgKi8KICAgdmFyIE51bGxTdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgIH07CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsU3RyZWFtOwoKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikge307CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7fTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBXaW5kb3dTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gZm9yIGNvbW11bmljYXRpbmcgd2l0aCBhIHdpbmRvdyBvYmplY3QuICBUaGUgZG9tYWluIHByb3ZpZGVkCiAgICAqIG11c3QgbWF0Y2ggdGhlIGFsbG93ZWQgbWVzc2FnZSBkb21haW5zIG9mIHRoZSBkb3duc3RyZWFtIHJlY2VpdmVyCiAgICAqIG9yIG1lc3NhZ2VzIHdpbGwgYmUgcmVqZWN0ZWQsIHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV2luZG93L3Bvc3RNZXNzYWdlCiAgICAqIGZvciBtb3JlIGluZm8uCiAgICAqLwogICB2YXIgV2luZG93U3RyZWFtID0gZnVuY3Rpb24od2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMud2luZG93ID0gd2luOwogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiB8fCAnKic7CiAgIH07CiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93U3RyZWFtOwoKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLndpbmRvdy5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLmRvbWFpbik7CiAgIH07CgogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFdpbmRvd0lPU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIHVzZWQgYnkgSUZyYW1lL3BvcHVwIHdpbmRvd3MgdG8gY29tbXVuaWNhdGUgd2l0aCB0aGVpciBwYXJlbnRzCiAgICAqIGFuZCB2aXNlIHZlcnNhLgogICAgKgogICAgKiBUaGlzIG9iamVjdCBlbmNhcHN1bGF0ZXMgdGhlIGZhY3QgdGhhdCBpbmNvbWluZyBhbmQgb3V0Z29pbmcgbWVzc2FnZXMKICAgICogYXJyaXZlIG9uIGRpZmZlcmVudCB3aW5kb3dzIGFuZCBhbGxvd3MgdGhpcyB0byBiZSBtYW5hZ2VkIGFzIGEgc2luZ2xlCiAgICAqIFN0cmVhbSBvYmplY3QuCiAgICAqLwogICB2YXIgV2luZG93SU9TdHJlYW0gPSBmdW5jdGlvbihpbnB1dHdpbiwgb3V0cHV0d2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dHdpbjsKICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXR3aW47CiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluIHx8ICcqJzsKICAgfTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93SU9TdHJlYW07CgogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5vdXRwdXQucG9zdE1lc3NhZ2UobWVzc2FnZSwgdGhpcy5kb21haW4pOwogICB9OwoKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKG1lc3NhZ2UpID0+IHsKICAgICAgICAgaWYgKG1lc3NhZ2Uuc291cmNlID09PSB0aGlzLm91dHB1dCkgewogICAgICAgICAgICBmKG1lc3NhZ2UpOwogICAgICAgICB9CiAgICAgIH0pOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFBvcnRTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gd3JhcHBpbmcgYW4gSFRNTDUgV29ya2VyIHBvcnQuICBUaGlzIGNvdWxkIGJlIHRoZSBwb3J0CiAgICAqIHVzZWQgdG8gY29ubmVjdCB0byBhIFdvcmtlciBvciBvbmUgb2YgdGhlIG11bHRpdHVkZSBvZiBwb3J0cwogICAgKiBtYWRlIGF2YWlsYWJsZSB0byBhIFNoYXJlZFdvcmtlciBmb3IgY29tbXVuaWNhdGlvbiBiYWNrIHRvCiAgICAqIGl0cyBjb25uZWN0ZWQgY2xpZW50cy4KICAgICovCiAgIHZhciBQb3J0U3RyZWFtID0gZnVuY3Rpb24ocG9ydCkgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5wb3J0ID0gcG9ydDsKICAgICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgfTsKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBvcnRTdHJlYW07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UobWVzc2FnZSk7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMucG9ydC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5nZXRJZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZDsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW1NdWx0aXBsZXhlciBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHdyYXBwZXIgZm9yIG11bHRpcGxleGVkIGRvd25zdHJlYW0gY29tbXVuaWNhdGlvbiB3aXRoCiAgICAqIG11bHRpcGxlIHN0cmVhbXMgYXQgb25jZS4gIE1haW5seSB1c2VmdWwgZm9yIHRoZSBTaGFyZWRXb3JrZXIgdG8KICAgICogYnJvYWRjYXN0IGV2ZW50cyB0byBtYW55IFBvcnRTdHJlYW0gb2JqZWN0cyBhdCBvbmNlLgogICAgKi8KICAgdmFyIFN0cmVhbU11bHRpcGxleGVyID0gZnVuY3Rpb24oc3RyZWFtcykgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5zdHJlYW1NYXAgPSBzdHJlYW1zID8KICAgICAgICAgY29ubmVjdC5pbmRleChzdHJlYW1zLCBmdW5jdGlvbihzKSB7IHJldHVybiBzLmdldElkKCk7IH0pIDoge307CiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycyA9IFtdOwogICB9OwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTdHJlYW1NdWx0aXBsZXhlcjsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byBhbGwgcG9ydHMgaW4gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMuZ2V0U3RyZWFtcygpLmZvckVhY2goZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHN0cmVhbS5zZW5kKG1lc3NhZ2UpOwoKICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBDb3VsZG4ndCBzZW5kIG1lc3NhZ2UgdG8gb25lIG9mIHRoZSBkb3duc3RyZWFtcyBmb3Igc29tZSByZWFzb24uLi4KICAgICAgICAgICAgLy8gTm8gcmVsaWFibGUgbG9nZ2luZyBwb3NzaWJsZSB3aXRob3V0IGZ1cnRoZXIgZmFpbHVyZXMsCiAgICAgICAgICAgIC8vIG5vIHJlY292ZXJ5LCBqdXN0IGVhdCBpdC4KICAgICAgICAgfQogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZWdpc3RlciBhIG1ldGhvZCB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aGVuIGEgbWVzc2FnZSBpcyByZWNlaXZlZCBmcm9tCiAgICAqIGFueSBvZiB0aGUgZG93bnN0cmVhbXMuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMucHVzaChmKTsKCiAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyBzdHJlYW1zIHdpdGggdGhlIG5ldyBsaXN0ZW5lci4KICAgICAgdGhpcy5nZXRTdHJlYW1zKCkuZm9yRWFjaChmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShmKTsKICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogQWRkIGEgc3RyZWFtIHRvIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5hZGRTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB0aGlzLnN0cmVhbU1hcFtzdHJlYW0uZ2V0SWQoKV0gPSBzdHJlYW07CgogICAgICAvLyBVcGRhdGUgc3RyZWFtIHdpdGggZXhpc3RpbmcgbGlzdGVuZXJzLgogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihtZXNzYWdlTGlzdGVuZXIpIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShtZXNzYWdlTGlzdGVuZXIpOwogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZW1vdmUgdGhlIGdpdmVuIGRvd25zdHJlYW0uICBUaGlzIGlzIHR5cGljYWxseSB1c2VkIGluIHJlc3BvbnNlCiAgICAqIHRvIHRoZSBTaGFyZWRXb3JrZXIncyBvbmNsb3NlIGV2ZW50LCBpbmRpY2F0aW5nIHRoYXQgYSBjb25zdW1lcgogICAgKiB0YWIgaGFzIGJlZW4gY2xvc2VkLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnJlbW92ZVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICBkZWxldGUgdGhpcy5zdHJlYW1NYXBbc3RyZWFtLmdldElkKCldOwogICB9OwoKICAgLyoqCiAgICAqIEdldCBhIGxpc3Qgb2Ygc3RyZWFtcyBpbiB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuZ2V0U3RyZWFtcyA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICByZXR1cm4gY29ubmVjdC52YWx1ZXModGhpcy5zdHJlYW1NYXApOwogICB9OwoKICAgLyoqCiAgICAqIEdldCB0aGUgc3RyZWFtIG1hdGNoaW5nIHRoZSBnaXZlbiBwb3J0LgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmdldFN0cmVhbUZvclBvcnQgPSBmdW5jdGlvbihwb3J0KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRTdHJlYW1zKCksIGZ1bmN0aW9uKHMpIHsKICAgICAgICAgcmV0dXJuIHMucG9ydCA9PT0gcG9ydDsKICAgICAgfSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQ29uZHVpdAogICAgKgogICAgKiBBbiBvYmplY3Qgd2hpY2ggYnJpZGdlcyBhbiB1cHN0cmVhbSBhbmQgYSBkb3duc3RyZWFtLCBhbGxvd2luZyBtZXNzYWdlcwogICAgKiB0byBiZSBwYXNzZWQgdG8gYW5kIGZyb20gZWFjaCBhbmQgcHJvdmlkaW5nIGFuIGV2ZW50IGJ1cyBmb3IgZXZlbnQKICAgICogc3Vic2NyaXB0aW9ucyB0byBiZSBtYWRlIHVwc3RyZWFtIGFuZCBkb3duc3RyZWFtLgogICAgKi8KICAgdmFyIENvbmR1aXQgPSBmdW5jdGlvbihuYW1lLCB1cHN0cmVhbSwgZG93bnN0cmVhbSkgewogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnVwc3RyZWFtID0gdXBzdHJlYW0gfHwgbmV3IE51bGxTdHJlYW0oKTsKICAgICAgdGhpcy5kb3duc3RyZWFtID0gZG93bnN0cmVhbSB8fCBuZXcgTnVsbFN0cmVhbSgpOwogICAgICB0aGlzLmRvd25zdHJlYW1CdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgICB0aGlzLnVwc3RyZWFtQnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKCiAgICAgIHRoaXMudXBzdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy51cHN0cmVhbUJ1cykpOwogICAgICB0aGlzLmRvd25zdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy5kb3duc3RyZWFtQnVzKSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vblVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy51cHN0cmVhbUJ1cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uQWxsVXBzdHJlYW0gPSBmdW5jdGlvbihmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMudXBzdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25Eb3duc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy5kb3duc3RyZWFtQnVzLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25BbGxEb3duc3RyZWFtID0gZnVuY3Rpb24oZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLmRvd25zdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuc2VuZFVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgdGhpcy51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5zZW5kRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIHRoaXMuZG93bnN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5fZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uKGJ1cywgbWVzc2FnZUV2ZW50KSB7CiAgICAgIHZhciBtZXNzYWdlID0gbWVzc2FnZUV2ZW50LmRhdGE7CiAgICAgIGlmIChtZXNzYWdlLmV2ZW50KSB7CiAgICAgICAgIGJ1cy50cmlnZ2VyKG1lc3NhZ2UuZXZlbnQsIG1lc3NhZ2UuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKgogICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBwYXNzZXMgZXZlbnRzIHVwc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vbkRvd25zdHJlYW0oIk15RXZlbnQiLCBjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NVcHN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhLCBldmVudE5hbWUpIHsKICAgICAgICAgc2VsZi51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgICAgIH07CiAgIH07CgogICAvKioKICAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggcGFzc2VzIGV2ZW50cyBkb3duc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgY29uZHVpdC5wYXNzRG93bnN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NEb3duc3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEsIGV2ZW50TmFtZSkgewogICAgICAgICBzZWxmLmRvd25zdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICAgICB9OwogICB9OwoKICAgLyoqCiAgICAqIFNodXRkb3duIHRoZSBjb25kdWl0J3MgZXZlbnQgYnVzc2VzIGFuZCByZW1vdmUgYWxsIHN1YnNjcmlwdGlvbnMuCiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnVwc3RyZWFtQnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbUJ1cy51bnN1YnNjcmliZUFsbCgpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIElGcmFtZUNvbmR1aXQgZXh0ZW5kcyBDb25kdWl0CiAgICAqCiAgICAqIENyZWF0ZXMgYSBjb25kdWl0IGZvciB0aGUgZ2l2ZW4gSUZyYW1lIGVsZW1lbnQuCiAgICAqLwogICB2YXIgSUZyYW1lQ29uZHVpdCA9IGZ1bmN0aW9uKG5hbWUsIHdpbmRvdywgaWZyYW1lLCBkb21haW4pIHsKICAgICAgQ29uZHVpdC5jYWxsKHRoaXMsIG5hbWUsIG5ldyBXaW5kb3dJT1N0cmVhbSh3aW5kb3csIGlmcmFtZS5jb250ZW50V2luZG93LCBkb21haW4gfHwgJyonKSwgbnVsbCk7CiAgIH07CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25kdWl0LnByb3RvdHlwZSk7CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSUZyYW1lQ29uZHVpdDsKCiAgIGNvbm5lY3QuU3RyZWFtID0gU3RyZWFtOwogICBjb25uZWN0Lk51bGxTdHJlYW0gPSBOdWxsU3RyZWFtOwogICBjb25uZWN0LldpbmRvd1N0cmVhbSA9IFdpbmRvd1N0cmVhbTsKICAgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSA9IFdpbmRvd0lPU3RyZWFtOwogICBjb25uZWN0LlBvcnRTdHJlYW0gPSBQb3J0U3RyZWFtOwogICBjb25uZWN0LlN0cmVhbU11bHRpcGxleGVyID0gU3RyZWFtTXVsdGlwbGV4ZXI7CiAgIGNvbm5lY3QuQ29uZHVpdCA9IENvbmR1aXQ7CiAgIGNvbm5lY3QuSUZyYW1lQ29uZHVpdCA9IElGcmFtZUNvbmR1aXQ7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4MzM6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBHcmFwaExpbmsgPDxhYnN0cmFjdCBjbGFzcz4+CiAgICAqCiAgICAqIFJlcHJlc2VudHMgdGhlIGFzc29jaWF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYSBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICB0aGlzLmZyb21TdGF0ZSA9IGZyb21TdGF0ZTsKICAgICAgdGhpcy50b1N0YXRlID0gdG9TdGF0ZTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICB0aHJvdyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0RnJvbVN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmZyb21TdGF0ZTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0VG9TdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy50b1N0YXRlOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBEaXJlY3RHcmFwaExpbmsgPDxjb25jcmV0ZSBjbGFzcz4+IGV4dGVuZHMgR3JhcGhMaW5rCiAgICAqCiAgICAqIFJlcHJlc2VudHMgdGhlIGJ5LXZhbHVlIHJlcHJlc2VudGF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYQogICAgKiBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIERpcmVjdEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSwgYXNzb2NpYXRpb25zKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhc3NvY2lhdGlvbnMsICdhc3NvY2lhdGlvbnMnKTsKICAgICAgR3JhcGhMaW5rLmNhbGwodGhpcywgZnJvbVN0YXRlLCB0b1N0YXRlKTsKICAgICAgdGhpcy5hc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnM7CiAgIH07CiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEdyYXBoTGluay5wcm90b3R5cGUpOwogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGlyZWN0R3JhcGhMaW5rOwoKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLmFzc29jaWF0aW9uczsKICAgfTsKCiAgIC8qKgogICAgKiBGdW5jdGlvbmFsR3JhcGhMaW5rIDw8Y29uY3JldGUgY2xhc3M+PiBleHRlbmRzIEdyYXBoTGluawogICAgKgogICAgKiBSZXByZXNlbnRzIGEgZnVuY3Rpb25hbCBhc3NvY2lhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEKICAgICogc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBGdW5jdGlvbmFsR3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlLCBjbG9zdXJlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjbG9zdXJlLCAnY2xvc3VyZScpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNsb3N1cmUpLCAnY2xvc3VyZSBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgR3JhcGhMaW5rLmNhbGwodGhpcywgZnJvbVN0YXRlLCB0b1N0YXRlKTsKICAgICAgdGhpcy5jbG9zdXJlID0gY2xvc3VyZTsKICAgfTsKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEdyYXBoTGluay5wcm90b3R5cGUpOwogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEZ1bmN0aW9uYWxHcmFwaExpbms7CgogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLmNsb3N1cmUoY29udGV4dCwgdGhpcy5nZXRGcm9tU3RhdGUoKSwgdGhpcy5nZXRUb1N0YXRlKCkpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBFdmVudEdyYXBoIDw8Y2xhc3M+PgogICAgKgogICAgKiBCdWlsZHMgYSBtYXAgb2YgYXNzb2NpYXRpb25zIGZyb20gb25lIHN0YXRlIHRvIGFub3RoZXIgaW4gY29udGV4dCBvZiBhCiAgICAqIHBhcnRpY3VsYXIgb2JqZWN0LiAgVGhlIGFzc29jaWF0aW9ucyBjYW4gYmUgZGlyZWN0IChvbmUgb3IgbW9yZSB2YWx1ZXMpCiAgICAqIG9yIGZ1bmN0aW9uYWwgKGEgbWV0aG9kIHJldHVybmluZyBvbmUgb3IgbW9yZSB2YWx1ZXMpLCBhbmQgYXJlIHVzZWQgdG8KICAgICogcHJvdmlkZSBhZGRpdGlvbmFsIGNvbnRleHR1YWwgZXZlbnQgaG9va3MgZm9yIHRoZSBVSSB0byBjb25zdW1lLgogICAgKi8KICAgdmFyIEV2ZW50R3JhcGggPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5mcm9tTWFwID0ge307CiAgIH07CiAgIEV2ZW50R3JhcGguQU5ZID0gIjw8YW55Pj4iOwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuYXNzb2MgPSBmdW5jdGlvbihmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIGlmICghIGZyb21TdGF0ZU9iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImZyb21TdGF0ZU9iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKCEgdG9TdGF0ZU9iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRvU3RhdGVPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmICghIGFzc29jT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXNzb2NPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmIChmcm9tU3RhdGVPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICBmcm9tU3RhdGVPYmouZm9yRWFjaChmdW5jdGlvbihmcm9tU3RhdGUpIHsKICAgICAgICAgICAgc2VsZi5hc3NvYyhmcm9tU3RhdGUsIHRvU3RhdGVPYmosIGFzc29jT2JqKTsKICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodG9TdGF0ZU9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgIHRvU3RhdGVPYmouZm9yRWFjaChmdW5jdGlvbih0b1N0YXRlKSB7CiAgICAgICAgICAgIHNlbGYuYXNzb2MoZnJvbVN0YXRlT2JqLCB0b1N0YXRlLCBhc3NvY09iaik7CiAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgICBpZiAodHlwZW9mIGFzc29jT2JqID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBGdW5jdGlvbmFsR3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopKTsKICAgICAgICAgfSBlbHNlIGlmIChhc3NvY09iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBEaXJlY3RHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikpOwogICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRGlyZWN0R3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgW2Fzc29jT2JqXSkpOwogICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgdmFyIGFzc29jaWF0aW9ucyA9IFtdOwoKICAgICAgdmFyIHRvTWFwRnJvbUFueSA9IHRoaXMuZnJvbU1hcFtFdmVudEdyYXBoLkFOWV0gfHwge307CiAgICAgIHZhciB0b01hcCA9IHRoaXMuZnJvbU1hcFtmcm9tU3RhdGVdIHx8IHt9OwoKICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCh0aGlzLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwKAogICAgICAgICAgICAgICB0b01hcEZyb21BbnksIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkpOwogICAgICBhc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnMuY29uY2F0KHRoaXMuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAoCiAgICAgICAgICAgICAgIHRvTWFwLCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpKTsKCiAgICAgIHJldHVybiBhc3NvY2lhdGlvbnM7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5fYWRkQXNzb2NpYXRpb24gPSBmdW5jdGlvbihhc3NvYykgewogICAgICB2YXIgdG9NYXAgPSB0aGlzLmZyb21NYXBbYXNzb2MuZ2V0RnJvbVN0YXRlKCldOwoKICAgICAgaWYgKCEgdG9NYXApIHsKICAgICAgICAgdG9NYXAgPSB0aGlzLmZyb21NYXBbYXNzb2MuZ2V0RnJvbVN0YXRlKCldID0ge307CiAgICAgIH0KCiAgICAgIHZhciBhc3NvY0xpc3QgPSB0b01hcFthc3NvYy5nZXRUb1N0YXRlKCldOwoKICAgICAgaWYgKCEgYXNzb2NMaXN0KSB7CiAgICAgICAgIGFzc29jTGlzdCA9IHRvTWFwW2Fzc29jLmdldFRvU3RhdGUoKV0gPSBbXTsKICAgICAgfQoKICAgICAgYXNzb2NMaXN0LnB1c2goYXNzb2MpOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAgPSBmdW5jdGlvbihtYXAsIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICB2YXIgYXNzb2NMaXN0ID0gKG1hcFtFdmVudEdyYXBoLkFOWV0gfHwgW10pLmNvbmNhdChtYXBbdG9TdGF0ZV0gfHwgW10pOwogICAgICByZXR1cm4gYXNzb2NMaXN0LnJlZHVjZShmdW5jdGlvbihwcmV2LCBhc3NvYykgewogICAgICAgICByZXR1cm4gcHJldi5jb25jYXQoYXNzb2MuZ2V0QXNzb2NpYXRpb25zKGNvbnRleHQpKTsKICAgICAgfSwgW10pOwogICB9OwoKICAgY29ubmVjdC5FdmVudEdyYXBoID0gRXZlbnRHcmFwaDsKCn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4OTE6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICB2YXIgT05FX0RBWV9NSUxMSVMgPSAyNCAqIDYwICogNjAgKiAxMDAwOwogIHZhciBERUZBVUxUX1BPUFVQX0hFSUdIVCA9IDU3ODsKICB2YXIgREVGQVVMVF9QT1BVUF9XSURUSCA9IDQzMzsKICB2YXIgQ09QWUFCTEVfRVZFTlRfRklFTERTID0gWyJidWJibGVzIiwgImNhbmNlbEJ1YmJsZSIsICJjYW5jZWxhYmxlIiwgImNvbXBvc2VkIiwgImRhdGEiLCAiZGVmYXVsdFByZXZlbnRlZCIsICJldmVudFBoYXNlIiwgImlzVHJ1c3RlZCIsICJsYXN0RXZlbnRJZCIsICJvcmlnaW4iLCAicmV0dXJuVmFsdWUiLCAidGltZVN0YW1wIiwgInR5cGUiXTsKCiAgLyoqCiAgICogVW5wb2xsdXRlIHNwcmludGYgZnVuY3Rpb25zIGZyb20gdGhlIGdsb2JhbCBuYW1lc3BhY2UuCiAgICovCiAgY29ubmVjdC5zcHJpbnRmID0gZ2xvYmFsLnNwcmludGY7CiAgY29ubmVjdC52c3ByaW50ZiA9IGdsb2JhbC52c3ByaW50ZjsKICBkZWxldGUgZ2xvYmFsLnNwcmludGY7CiAgZGVsZXRlIGdsb2JhbC52c3ByaW50ZjsKCiAgY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUyA9IHsKICAgIFNVQ0NFU1M6IDIwMCwKICAgIFRPT19NQU5ZX1JFUVVFU1RTOiA0MjksCiAgICBJTlRFUk5BTF9TRVJWRVJfRVJST1I6IDUwMAogIH07CgogIGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTID0gewogICAgQ0hBVF9UT0tFTjogImNoYXRfdG9rZW4iLAogICAgV0VCX1NPQ0tFVDogIndlYl9zb2NrZXQiCiAgfTsKCiAgLyoqCiAgICogQmluZHMgdGhlIGdpdmVuIGluc3RhbmNlIG9iamVjdCBhcyB0aGUgY29udGV4dCBmb3IKICAgKiB0aGUgbWV0aG9kIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIHNjb3BlIFRoZSBpbnN0YW5jZSBvYmplY3QgdG8gYmUgc2V0IGFzIHRoZSBzY29wZQogICAqICAgIG9mIHRoZSBmdW5jdGlvbi4KICAgKiBAcGFyYW0gbWV0aG9kIFRoZSBtZXRob2QgdG8gYmUgZW5jYXBzdWxhdGVkLgogICAqCiAgICogQWxsIG90aGVyIGFyZ3VtZW50cywgaWYgYW55LCBhcmUgYm91bmQgdG8gdGhlIG1ldGhvZAogICAqIGludm9jYXRpb24gaW5zaWRlIHRoZSBjbG9zdXJlLgogICAqCiAgICogQHJldHVybiBBIGNsb3N1cmUgZW5jYXBzdWxhdGluZyB0aGUgaW52b2NhdGlvbiBvZiB0aGUKICAgKiAgICBtZXRob2QgcHJvdmlkZWQgaW4gY29udGV4dCBvZiB0aGUgZ2l2ZW4gaW5zdGFuY2UuCiAgICovCiAgY29ubmVjdC5oaXRjaCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIHZhciBzY29wZSA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBtZXRob2QgPSBhcmdzLnNoaWZ0KCk7CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHNjb3BlLCAnc2NvcGUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24obWV0aG9kKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2xvc3VyZUFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHNjb3BlLCBhcmdzLmNvbmNhdChjbG9zdXJlQXJncykpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGEgY2FsbGFibGUgZnVuY3Rpb24gdHlwZS4KICAgKiBCb3Jyb3dlZCBmcm9tIFVuZGVyc2NvcmUuanMuCiAgICovCiAgY29ubmVjdC5pc0Z1bmN0aW9uID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmouY29uc3RydWN0b3IgJiYgb2JqLmNhbGwgJiYgb2JqLmFwcGx5KTsKICB9OwoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGFuIGFycmF5LgogICAqLwogIGNvbm5lY3QuaXNBcnJheSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGtleXMgZnJvbSBhIEphdmFzY3JpcHQgb2JqZWN0IHVzZWQKICAgKiBhcyBhIGhhc2ggbWFwLgogICAqLwogIGNvbm5lY3Qua2V5cyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciBrZXlzID0gW107CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1hcCwgJ21hcCcpOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIGtleXMucHVzaChrKTsKICAgIH0KCiAgICByZXR1cm4ga2V5czsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHZhbHVlcyBmcm9tIGEgSmF2YXNjcmlwdCBvYmplY3QgdXNlZAogICAqIGFzIGEgaGFzaCBtYXAuCiAgICovCiAgY29ubmVjdC52YWx1ZXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIgdmFsdWVzID0gW107CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1hcCwgJ21hcCcpOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIHZhbHVlcy5wdXNoKG1hcFtrXSk7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGtleS92YWx1ZSBwYWlycyBmcm9tIHRoZSBnaXZlbiBtYXAuCiAgICovCiAgY29ubmVjdC5lbnRyaWVzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIGVudHJpZXMgPSBbXTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICBlbnRyaWVzLnB1c2goeyBrZXk6IGssIHZhbHVlOiBtYXBba10gfSk7CiAgICB9CgogICAgcmV0dXJuIGVudHJpZXM7CiAgfTsKCiAgLyoqCiAgICogTWVyZ2UgdHdvIG9yIG1vcmUgbWFwcyB0b2dldGhlciBpbnRvIGEgbmV3IG1hcCwKICAgKiBvciBzaW1wbHkgY29weSBhIHNpbmdsZSBtYXAuCiAgICovCiAgY29ubmVjdC5tZXJnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdNYXBzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciByZXN1bHRNYXAgPSB7fTsKCiAgICBhcmdNYXBzLmZvckVhY2goZnVuY3Rpb24gKG1hcCkgewogICAgICBjb25uZWN0LmVudHJpZXMobWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChrdikgewogICAgICAgIHJlc3VsdE1hcFtrdi5rZXldID0ga3YudmFsdWU7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHJlc3VsdE1hcDsKICB9OwoKICBjb25uZWN0Lm5vdyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICB9OwoKICBjb25uZWN0LmZpbmQgPSBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCBhcnJheS5sZW5ndGg7IHgrKykgewogICAgICBpZiAocHJlZGljYXRlKGFycmF5W3hdKSkgewogICAgICAgIHJldHVybiBhcnJheVt4XTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CgogIGNvbm5lY3QuY29udGFpbnMgPSBmdW5jdGlvbiAob2JqLCB2YWx1ZSkgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQob2JqLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICh2YWx1ZSBpbiBvYmopOwogICAgfQogIH07CgogIGNvbm5lY3QuY29udGFpbnNWYWx1ZSA9IGZ1bmN0aW9uIChvYmosIHZhbHVlKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChvYmosIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKGNvbm5lY3QudmFsdWVzKG9iaiksIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZW5lcmF0ZSBhIHJhbmRvbSBJRCBjb25zaXN0aW5nIG9mIHRoZSBjdXJyZW50IHRpbWVzdGFtcAogICAqIGFuZCBhIHJhbmRvbSBiYXNlLTM2IG51bWJlciBiYXNlZCBvbiBNYXRoLnJhbmRvbSgpLgogICAqLwogIGNvbm5lY3QucmFuZG9tSWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy0lcyIsIGNvbm5lY3Qubm93KCksIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpKTsKICB9OwoKICAvKioKICAgKiBHZW5lcmF0ZSBhbiBlbnVtIGZyb20gdGhlIGdpdmVuIGxpc3Qgb2YgbG93ZXItY2FzZSBlbnVtIHZhbHVlcywKICAgKiB3aGVyZSB0aGUgZW51bSBrZXlzIHdpbGwgYmUgdXBwZXIgY2FzZS4KICAgKgogICAqIENvbnZlcnNpb24gZnJvbSBwYXNjYWwgY2FzZSBiYXNlZCBvbiBjb2RlIGZyb20gaGVyZToKICAgKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMwNTIxMjI0CiAgICovCiAgY29ubmVjdC5tYWtlRW51bSA9IGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgIHZhciBlbnVtT2JqID0ge307CgogICAgdmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBrZXkgPSB2YWx1ZS5yZXBsYWNlKC9cLj8oW2Etel0rKV8/L2csIGZ1bmN0aW9uICh4LCB5KSB7IHJldHVybiB5LnRvVXBwZXJDYXNlKCkgKyAiXyI7IH0pCiAgICAgICAgLnJlcGxhY2UoL18kLywgIiIpOwoKICAgICAgZW51bU9ialtrZXldID0gdmFsdWU7CiAgICB9KTsKCiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSA9IGZ1bmN0aW9uIChwcmVmaXgsIHZhbHVlcykgewogICAgdmFyIGVudW1PYmogPSBjb25uZWN0Lm1ha2VFbnVtKHZhbHVlcyk7CiAgICBjb25uZWN0LmtleXMoZW51bU9iaikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGVudW1PYmpba2V5XSA9IGNvbm5lY3Quc3ByaW50ZigiJXM6OiVzIiwgcHJlZml4LCBlbnVtT2JqW2tleV0pOwogICAgfSk7CiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICBjb25uZWN0Lm1ha2VHZW5lcmljTmFtZXNwYWNlZEVudW0gPSBmdW5jdGlvbiAocHJlZml4LCB2YWx1ZXMsIGRlbGltaXRlcikgewogICAgdmFyIGVudW1PYmogPSBjb25uZWN0Lm1ha2VFbnVtKHZhbHVlcyk7CiAgICBjb25uZWN0LmtleXMoZW51bU9iaikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGVudW1PYmpba2V5XSA9IGNvbm5lY3Quc3ByaW50ZigiJXMiK2RlbGltaXRlcisiJXMiLCBwcmVmaXgsIGVudW1PYmpba2V5XSk7CiAgICB9KTsKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIC8qKgogICogTWV0aG9kcyB0byBkZXRlcm1pbmUgYnJvd3NlciB0eXBlIGFuZCB2ZXJzaW9ucywgdXNlZCBmb3Igc29mdHBob25lIGluaXRpYWxpemF0aW9uLgogICovCiAgY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5pc09wZXJhQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjaHJvbWVWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgKyA3KTsKICAgIGlmIChjaHJvbWVWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KGNocm9tZVZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuZ2V0RmlyZWZveEJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGZpcmVmb3hWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICsgOCk7CiAgICBpZiAoZmlyZWZveFZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoZmlyZWZveFZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuaXNWYWxpZExvY2FsZSA9IGZ1bmN0aW9uIChsb2NhbGUpIHsKICAgIHZhciBsYW5ndWFnZXMgPSBbCiAgICAgIHsKICAgICAgICBpZDogJ2VuX1VTJywKICAgICAgICBsYWJlbDogJ0VuZ2xpc2gnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2RlX0RFJywKICAgICAgICBsYWJlbDogJ0RldXRzY2gnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2VzX0VTJywKICAgICAgICBsYWJlbDogJ0VzcGHDsW9sJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdmcl9GUicsCiAgICAgICAgbGFiZWw6ICdGcmFuw6dhaXMnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2phX0pQJywKICAgICAgICBsYWJlbDogJ+aXpeacrOiqnicKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnaXRfSVQnLAogICAgICAgIGxhYmVsOiAnSXRhbGlhbm8nCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2tvX0tSJywKICAgICAgICBsYWJlbDogJ+2VnOq1reyWtCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAncHRfQlInLAogICAgICAgIGxhYmVsOiAnUG9ydHVndcOqcycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnemhfQ04nLAogICAgICAgIGxhYmVsOiAn5Lit5paHKOeugOS9kyknCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ3poX1RXJywKICAgICAgICBsYWJlbDogJ+S4reaWhyjnuYHpq5QpJwogICAgICB9CiAgICBdOwogICAgcmV0dXJuIGxhbmd1YWdlcy5tYXAoZnVuY3Rpb24obGFuZ3VhZ2UpeyByZXR1cm4gbGFuZ3VhZ2UuaWR9KS5pbmNsdWRlcyhsb2NhbGUpOwogIH0KCiAgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZlcnNpb25PZmZzZXQgPSB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKTsKICAgIHZhciBvcGVyYVZlcnNpb24gPSAodXNlckFnZW50LmluZGV4T2YoIlZlcnNpb24iKSAhPT0gLTEpID8gdXNlckFnZW50LnN1YnN0cmluZyh2ZXJzaW9uT2Zmc2V0ICsgOCkgOiB1c2VyQWdlbnQuc3Vic3RyaW5nKHZlcnNpb25PZmZzZXQgKyA2KTsKICAgIGlmIChvcGVyYVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQob3BlcmFWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZXR1cm4gYSBtYXAgb2YgaXRlbXMgaW4gdGhlIGdpdmVuIGxpc3QgaW5kZXhlZCBieQogICAqIGtleXMgZGV0ZXJtaW5lZCBieSB0aGUgY2xvc3VyZSBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSBpdGVyYWJsZSBBIGxpc3QtbGlrZSBvYmplY3QuCiAgICogQHBhcmFtIGNsb3N1cmUgQSBjbG9zdXJlIHRvIGRldGVybWluZSB0aGUgaW5kZXggZm9yIHRoZQogICAqICAgIGl0ZW1zIGluIHRoZSBpdGVyYWJsZS4KICAgKiBAcmV0dXJuIEEgbWFwIGZyb20gaW5kZXggdG8gaXRlbSBmb3IgZWFjaCBpdGVtIGluIHRoZSBpdGVyYWJsZS4KICAgKi8KICBjb25uZWN0LmluZGV4ID0gZnVuY3Rpb24gKGl0ZXJhYmxlLCBjbG9zdXJlKSB7CiAgICB2YXIgbWFwID0ge307CgogICAgaXRlcmFibGUuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICBtYXBbY2xvc3VyZShpdGVtKV0gPSBpdGVtOwogICAgfSk7CgogICAgcmV0dXJuIG1hcDsKICB9OwoKICAvKioKICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gYXJyYXkgaW50byBhIG1hcCBhcyBhIHNldCwKICAgKiB3aGVyZSBlbGVtZW50cyBpbiB0aGUgYXJyYXkgYXJlIG1hcHBlZCB0byAxLgogICAqLwogIGNvbm5lY3Quc2V0ID0gZnVuY3Rpb24gKGFycmF5SW4pIHsKICAgIHZhciBzZXRNYXAgPSB7fTsKCiAgICBhcnJheUluLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBzZXRNYXBba2V5XSA9IDE7CiAgICB9KTsKCiAgICByZXR1cm4gc2V0TWFwOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBtYXAgZm9yIGVhY2gga2V5IGluIG1hcEIgd2hpY2gKICAgKiBpcyBOT1QgaW4gbWFwQS4KICAgKi8KICBjb25uZWN0LnJlbGF0aXZlQ29tcGxlbWVudCA9IGZ1bmN0aW9uIChtYXBBLCBtYXBCKSB7CiAgICB2YXIgY29tcE1hcCA9IHt9OwoKICAgIGNvbm5lY3Qua2V5cyhtYXBCKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKCEoa2V5IGluIG1hcEEpKSB7CiAgICAgICAgY29tcE1hcFtrZXldID0gbWFwQltrZXldOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gY29tcE1hcDsKICB9OwoKICAvKioKICAgKiBBc3NlcnRzIHRoYXQgYSBwcmVtaXNlIGlzIHRydWUuCiAgICovCiAgY29ubmVjdC5hc3NlcnRUcnVlID0gZnVuY3Rpb24gKHByZW1pc2UsIG1lc3NhZ2UpIHsKICAgIGlmICghcHJlbWlzZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpOwogICAgfQogIH07CgogIC8qKgogICAqIEFzc2VydHMgdGhhdCBhIHZhbHVlIGlzIG5vdCBudWxsIG9yIHVuZGVmaW5lZC4KICAgKi8KICBjb25uZWN0LmFzc2VydE5vdE51bGwgPSBmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZSh2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSAhPT0gdW5kZWZpbmVkLAogICAgICBjb25uZWN0LnNwcmludGYoIiVzIG11c3QgYmUgcHJvdmlkZWQiLCBuYW1lIHx8ICdBIHZhbHVlJykpOwogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIGNvbm5lY3QuZGVlcGNvcHkgPSBmdW5jdGlvbiAoc3JjKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShzcmMpKTsKICB9OwoKICBjb25uZWN0LmRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICBjb25zdCBvYmogPSB7fTsKICAgIGNvbnN0IGxpc3RPZkFjY2VwdGFibGVLZXlzID0gQ09QWUFCTEVfRVZFTlRfRklFTERTOwogICAgbGlzdE9mQWNjZXB0YWJsZUtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgb2JqW2tleV0gPSBldmVudFtrZXldOwogICAgICB9CiAgICAgIGNhdGNoKGUpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudCBmYWlsZWQgb24ga2V5OiAiLCBrZXkpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNvbm5lY3QuZGVlcGNvcHkob2JqKTsKICB9CgogIC8qKgogICAqIEdldCB0aGUgY3VycmVudCBiYXNlIHVybCBvZiB0aGUgb3BlbiBwYWdlLCBlLmcuIGlmIHRoZSBwYWdlIGlzCiAgICogaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0L29yYW5nZXMsIHRoaXMgd2lsbCBiZSAiaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0Ii4KICAgKi8KICBjb25uZWN0LmdldEJhc2VVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9jYXRpb24gPSBnbG9iYWwubG9jYXRpb247CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXM6JXMiLCBsb2NhdGlvbi5wcm90b2NvbCwgbG9jYXRpb24uaG9zdG5hbWUsIGxvY2F0aW9uLnBvcnQpOwogIH07CgogIGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgcHJvdG9jb2wgPSBnbG9iYWwubG9jYXRpb24ucHJvdG9jb2w7CiAgICBpZiAodXJsLnN1YnN0cigwLCBwcm90b2NvbC5sZW5ndGgpICE9PSBwcm90b2NvbCkgewogICAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXMiLCBwcm90b2NvbCwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfQoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGN1cnJlbnQgd2luZG93IGlzIGluIGFuIGlmcmFtZS4KICAgKiBDb3VydGVzeTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMjYwNjkvCiAgICovCiAgY29ubmVjdC5pc0ZyYW1lZCA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiB3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPiAxOwogIH0KCiAgY29ubmVjdC5mZXRjaCA9IGZ1bmN0aW9uIChlbmRwb2ludCwgb3B0aW9ucywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnkpIHsKICAgIG1heFJldHJ5ID0gbWF4UmV0cnkgfHwgNTsKICAgIG1pbGxpSW50ZXJ2YWwgPSBtaWxsaUludGVydmFsIHx8IDEwMDA7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGZldGNoRGF0YShtYXhSZXRyeSkgewogICAgICAgIGZldGNoKGVuZHBvaW50LCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlNVQ0NFU1MpIHsKICAgICAgICAgICAgcmVzLmpzb24oKS50aGVuKGpzb24gPT4gcmVzb2x2ZShqc29uKSkuY2F0Y2goKCkgPT4gcmVzb2x2ZSh7fSkpOwogICAgICAgICAgfSBlbHNlIGlmIChtYXhSZXRyeSAhPT0gMSAmJiAocmVzLnN0YXR1cyA+PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUiB8fCByZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlRPT19NQU5ZX1JFUVVFU1RTKSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBmZXRjaERhdGEoLS1tYXhSZXRyeSk7CiAgICAgICAgICAgIH0sIG1pbGxpSW50ZXJ2YWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVqZWN0KHJlcyk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBmZXRjaERhdGEobWF4UmV0cnkpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQ2FsbGluZyBhIGZ1bmN0aW9uIHdpdGggZXhwb25lbnRpYWwgYmFja29mZiB3aXRoIGZ1bGwgaml0dGVyIHJldHJ5IHN0cmF0ZWd5CiAgICogSXQgd2lsbCByZXRyeSBjYWxsaW5nIHRoZSBmdW5jdGlvbiBmb3IgbWF4aW11bSBtYXhSZXRyeSB0aW1lcyBpZiBpdCBmYWlscy4KICAgKiBTdWNjZXNzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBmdW5jdGlvbiBzdWNjZWVkZWQuCiAgICogRmFpbHVyZSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBvbmx5IGlmIHRoZSBsYXN0IHRyeSBmYWlsZWQuCiAgICovCiAgY29ubmVjdC5iYWNrb2ZmID0gZnVuY3Rpb24gKGZ1bmMsIG1pbGxpSW50ZXJ2YWwsIG1heFJldHJ5LCBjYWxsYmFja3MpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZnVuYyksICJmdW5jIG11c3QgYmUgYSBGdW5jdGlvbiIpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJhdGlvID0gMjsKCiAgICBmdW5jKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAobWF4UmV0cnkgPiAwKSB7CiAgICAgICAgICB2YXIgaW50ZXJ2YWwgPSBtaWxsaUludGVydmFsICogMiAqIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuYmFja29mZihmdW5jLCBpbnRlcnZhbCAqIHJhdGlvLCAtLW1heFJldHJ5LCBjYWxsYmFja3MpOwogICAgICAgICAgfSwgaW50ZXJ2YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVyciwgZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMgPSBmdW5jdGlvbiAobWV0cmljRGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX01FVFJJQywKICAgICAgZGF0YTogbWV0cmljRGF0YQogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lU3RhdHMgPSBmdW5jdGlvbihzdGF0cykgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuU09GVFBIT05FX1NUQVRTLAogICAgICBkYXRhOiBzdGF0cwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5TT0ZUUEhPTkVfUkVQT1JULAogICAgICBkYXRhOiByZXBvcnQKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuQ0xJQ0tfU1RSRUFNX0RBVEEsCiAgICAgIGRhdGE6IHJlcG9ydAogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoQ2xpZW50U2lkZUxvZ3MgPSBmdW5jdGlvbihsb2dzKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5DTElFTlRfU0lERV9MT0dTLCBsb2dzKTsKICB9OwoKICBjb25uZWN0LmFkZE5hbWVzcGFjZVRvTG9ncyA9IGZ1bmN0aW9uKG5hbWVzcGFjZSkgewogICAgY29uc3QgbWV0aG9kcyA9IFsnbG9nJywgJ2Vycm9yJywgJ3dhcm4nLCAnaW5mbycsICdkZWJ1ZyddOwoKICAgIG1ldGhvZHMuZm9yRWFjaCgobWV0aG9kKSA9PiB7CiAgICAgIGNvbnN0IGNvbnNvbGVNZXRob2QgPSB3aW5kb3cuY29uc29sZVttZXRob2RdOwogICAgICB3aW5kb3cuY29uc29sZVttZXRob2RdID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNvbnN0IGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3VtZW50cyk7CiAgICAgICAgYXJncy51bnNoaWZ0KGBbJHtuYW1lc3BhY2V9XWApOwogICAgICAgIGNvbnNvbGVNZXRob2QuYXBwbHkod2luZG93LmNvbnNvbGUsIGFyZ3MpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQSB3cmFwcGVyIGFyb3VuZCBXaW5kb3cub3BlbigpIGZvciBtYW5hZ2luZyBzaW5nbGUgaW5zdGFuY2UgcG9wdXBzLgogICAqLwogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgeyB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUub3BlbiA9IGZ1bmN0aW9uICh1cmwsIG5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciB0aGVuID0gdGhpcy5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lKTsKICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciB3aW4gPSBudWxsOwogICAgaWYgKG5vdyAtIHRoZW4gPiBPTkVfREFZX01JTExJUykgewogICAgICBpZiAob3B0aW9ucykgewogICAgICAgIC8vIGRlZmF1bHQgdmFsdWVzIGFyZSBjaG9zZW4gdG8gcHJvdmlkZSBhIG1pbmltdW0gaGVpZ2h0IHdpdGhvdXQgc2Nyb2xsaW5nCiAgICAgICAgLy8gYW5kIGEgdW5pZm9ybSBtYXJnaW4gYmFzZWQgb24gdGhlIGNzcyBvZiB0aGUgY2NwIGxvZ2luIHBhZ2UKICAgICAgICB2YXIgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgREVGQVVMVF9QT1BVUF9IRUlHSFQ7CiAgICAgICAgdmFyIHdpZHRoID0gb3B0aW9ucy53aWR0aCB8fCBERUZBVUxUX1BPUFVQX1dJRFRIOwogICAgICAgIHZhciB0b3AgPSBvcHRpb25zLnRvcCB8fCAwOwogICAgICAgIHZhciBsZWZ0ID0gb3B0aW9ucy5sZWZ0IHx8IDA7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUsICJ3aWR0aD0iK3dpZHRoKyIsIGhlaWdodD0iK2hlaWdodCsiLCB0b3A9Iit0b3ArIiwgbGVmdD0iK2xlZnQpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lLCAid2lkdGg9Iit3aWR0aCsiLCBoZWlnaHQ9IitoZWlnaHQrIiwgdG9wPSIrdG9wKyIsIGxlZnQ9IitsZWZ0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lLCBub3cpOwogICAgfQogICAgcmV0dXJuIHdpbjsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgdmFyIHZhbHVlID0gZ2xvYmFsLmxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAwOwogICAgfQogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lLCB0cykgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksICcnICsgdHMpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TG9jYWxTdG9yYWdlS2V5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHJldHVybiAiY29ubmVjdFBvcHVwTWFuYWdlcjo6IiArIG5hbWU7CiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgdGhlIEhUTUw1IG5vdGlmaWNhdGlvbiBwZXJtaXNzaW9uIHZhbHVlcy4KICAgKi8KICB2YXIgTm90aWZpY2F0aW9uUGVybWlzc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2dyYW50ZWQnLAogICAgJ2RlbmllZCcsCiAgICAnZGVmYXVsdCcKICBdKTsKCiAgLyoqCiAgICogQSBzaW1wbGUgZW5naW5lIGZvciBzaG93aW5nIG5vdGlmaWNhdGlvbiBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERUZBVUxUOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUucmVxdWVzdFBlcm1pc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoISgiTm90aWZpY2F0aW9uIiBpbiBnbG9iYWwpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhpcyBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBub3RpZmljYXRpb25zLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEOwoKICAgIH0gZWxzZSBpZiAoZ2xvYmFsLk5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRCkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgdG8gbm90IHJlY2VpdmUgbm90aWZpY2F0aW9ucy4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiAhPT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIGdsb2JhbC5Ob3RpZmljYXRpb24ucmVxdWVzdFBlcm1pc3Npb24oKS50aGVuKGZ1bmN0aW9uIChwZXJtaXNzaW9uKSB7CiAgICAgICAgc2VsZi5wZXJtaXNzaW9uID0gcGVybWlzc2lvbjsKICAgICAgICBpZiAocGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgICAgICBzZWxmLl9zaG93UXVldWVkKCk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnF1ZXVlID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnNob3cgPSBmdW5jdGlvbiAodGl0bGUsIG9wdGlvbnMpIHsKICAgIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICByZXR1cm4gdGhpcy5fc2hvd0ltcGwoeyB0aXRsZTogdGl0bGUsIG9wdGlvbnM6IG9wdGlvbnMgfSk7CgogICAgfSBlbHNlIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVW5hYmxlIHRvIHNob3cgbm90aWZpY2F0aW9uLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICB0aXRsZTogdGl0bGUsCiAgICAgICAgICBvcHRpb25zOiBvcHRpb25zCiAgICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIHBhcmFtcyA9IHsgdGl0bGU6IHRpdGxlLCBvcHRpb25zOiBvcHRpb25zIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiRGVmZXJyaW5nIG5vdGlmaWNhdGlvbiB1bnRpbCB1c2VyIGRlY2lkZXMgdG8gYWxsb3cgb3IgZGVueS4iKQogICAgICAgIC53aXRoT2JqZWN0KHBhcmFtcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5xdWV1ZS5wdXNoKHBhcmFtcyk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd1F1ZXVlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBub3RpZmljYXRpb25zID0gdGhpcy5xdWV1ZS5tYXAoZnVuY3Rpb24gKHBhcmFtcykgewogICAgICByZXR1cm4gc2VsZi5fc2hvd0ltcGwocGFyYW1zKTsKICAgIH0pOwogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgcmV0dXJuIG5vdGlmaWNhdGlvbnM7CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd0ltcGwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgbm90aWZpY2F0aW9uID0gbmV3IGdsb2JhbC5Ob3RpZmljYXRpb24ocGFyYW1zLnRpdGxlLCBwYXJhbXMub3B0aW9ucyk7CiAgICBpZiAocGFyYW1zLm9wdGlvbnMuY2xpY2tlZCkgewogICAgICBub3RpZmljYXRpb24ub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBwYXJhbXMub3B0aW9ucy5jbGlja2VkLmNhbGwobm90aWZpY2F0aW9uKTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBub3RpZmljYXRpb247CiAgfTsKCiAgY29ubmVjdC5WYWx1ZUVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBpbnN0YW5jZSA9IG5ldyBFcnJvcihjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlKTsKICAgIHJldHVybiBpbnN0YW5jZTsgCiAgfTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZSwgRXJyb3IucHJvdG90eXBlKTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5WYWx1ZUVycm9yLCBFcnJvcik7CiAgY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZS5uYW1lID0gJ1ZhbHVlRXJyb3InOwoKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGluc3RhbmNlID0gbmV3IEVycm9yKGNvbm5lY3QudnNwcmludGYoZm9ybWF0LCBhcmdzKSk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoaW5zdGFuY2UsIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUpOwogICAgcmV0dXJuIGluc3RhbmNlOyAKICB9OwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlLCBFcnJvci5wcm90b3R5cGUpOwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IsIEVycm9yKTsKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnTm90SW1wbGVtZW50ZWRFcnJvcic7CgogIGNvbm5lY3QuU3RhdGVFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgaW5zdGFuY2UgPSBuZXcgRXJyb3IoY29ubmVjdC52c3ByaW50Zihmb3JtYXQsIGFyZ3MpKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihpbnN0YW5jZSwgY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZSk7CiAgICByZXR1cm4gaW5zdGFuY2U7IAogIH0KICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZSwgRXJyb3IucHJvdG90eXBlKTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5TdGF0ZUVycm9yLCBFcnJvcik7CiAgY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZS5uYW1lID0gJ1N0YXRlRXJyb3InOwoKCgogIGNvbm5lY3QuVm9pY2VJZEVycm9yID0gZnVuY3Rpb24odHlwZSwgbWVzc2FnZSwgZXJyKXsKICAgIHZhciBlcnJvciA9IHt9OwogICAgZXJyb3IudHlwZSA9IHR5cGU7CiAgICBlcnJvci5tZXNzYWdlID0gbWVzc2FnZTsKICAgIGVycm9yLnN0YWNrID0gRXJyb3IobWVzc2FnZSkuc3RhY2s7CiAgICBlcnJvci5lcnIgPSBlcnI7CiAgICByZXR1cm4gZXJyb3I7CiAgfQoKICAvLyBpbnRlcm5hbCB1c2Ugb25seQogIGNvbm5lY3QuaXNDQ1AgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgcmV0dXJuIGNvbmR1aXQubmFtZSA9PT0gJ0Nvbm5lY3RTaGFyZWRXb3JrZXJDb25kdWl0JzsKICB9Cgp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNzM2OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC53b3JrZXIgPSB7fTsKCiAgdmFyIEdFVF9BR0VOVF9USU1FT1VUX01TID0gMzAwMDA7CiAgdmFyIEdFVF9BR0VOVF9SRUNPVkVSWV9USU1FT1VUX01TID0gNTAwMDsKICB2YXIgR0VUX0FHRU5UX1NVQ0NFU1NfVElNRU9VVF9NUyA9IDEwMDsKICB2YXIgTE9HX0JVRkZFUl9DQVBfU0laRSA9IDQwMDsKCiAgdmFyIENIRUNLX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMgPSAzMDAwMDA7IC8vIDUgbWludXRlcwogIHZhciBSRUZSRVNIX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMgPSAxMDAwMDsgLy8gMTAgc2Vjb25kcwogIHZhciBSRUZSRVNIX0FVVEhfVE9LRU5fTUFYX1RSWSA9IDQ7CgogIHZhciBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUyA9IDMwMDAwOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIE1hc3RlclRvcGljQ29vcmRpbmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnRvcGljTWFzdGVyTWFwID0ge307CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUuZ2V0TWFzdGVyID0gZnVuY3Rpb24gKHRvcGljKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICd0b3BpYycpOwogICAgcmV0dXJuIHRoaXMudG9waWNNYXN0ZXJNYXBbdG9waWNdIHx8IG51bGw7CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUuc2V0TWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBpZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAndG9waWMnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZCwgJ2lkJyk7CiAgICB0aGlzLnRvcGljTWFzdGVyTWFwW3RvcGljXSA9IGlkOwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLnJlbW92ZU1hc3RlciA9IGZ1bmN0aW9uIChpZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlkLCAnaWQnKTsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjb25uZWN0LmVudHJpZXModGhpcy50b3BpY01hc3Rlck1hcCkuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkgewogICAgICByZXR1cm4gZW50cnkudmFsdWUgPT09IGlkOwogICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgZGVsZXRlIHNlbGYudG9waWNNYXN0ZXJNYXBbZW50cnkua2V5XTsKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIFdvcmtlckNsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgKi8KICB2YXIgV29ya2VyQ2xpZW50ID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIGNvbm5lY3QuQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICB9OwogIFdvcmtlckNsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGNvbm5lY3QuQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXb3JrZXJDbGllbnQ7CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24gKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciByZXF1ZXN0X3N0YXJ0ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICBpZihjb25uZWN0LmNvbnRhaW5zVmFsdWUoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMsIG1ldGhvZCkpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50QXBwQ2xpZW50KCkuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyb3IpOwogICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0gZWxzZSBpZihjb25uZWN0LmNvbnRhaW5zVmFsdWUoY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50TWV0aG9kcywgbWV0aG9kKSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0VGFza1RlbXBsYXRlc0NsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCkuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycm9yLCBkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyb3IpOwogICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IsIGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5hdXRoRmFpbHVyZSgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjYWxsYmFja3MuYWNjZXNzRGVuaWVkICYmIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgCiAgfTsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fcmVjb3JkQVBJTGF0ZW5jeSA9IGZ1bmN0aW9uIChtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycikgewogICAgdmFyIHJlcXVlc3RfZW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgcmVxdWVzdF90aW1lID0gcmVxdWVzdF9lbmQgLSByZXF1ZXN0X3N0YXJ0OwogICAgdGhpcy5fc2VuZEFQSU1ldHJpY3MobWV0aG9kLCByZXF1ZXN0X3RpbWUsIGVycik7CiAgfTsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fc2VuZEFQSU1ldHJpY3MgPSBmdW5jdGlvbiAobWV0aG9kLCB0aW1lLCBlcnIpIHsKICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDLCB7CiAgICAgIG5hbWU6IG1ldGhvZCwKICAgICAgdGltZTogdGltZSwKICAgICAgZGltZW5zaW9uczogWwogICAgICAgIHsKICAgICAgICAgIG5hbWU6ICJDYXRlZ29yeSIsCiAgICAgICAgICB2YWx1ZTogIkFQSSIKICAgICAgICB9CiAgICAgIF0sCiAgICAgIGVycm9yOiBlcnIKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBUaGUgb2JqZWN0IHJlc3BvbnNpYmxlIGZvciBwb2xsaW5nIGFuZCBwYXNzaW5nIGRhdGEgZG93bnN0cmVhbSB0byBhbGwKICAgKiBjb25zdW1lciBwb3J0cy4KICAgKi8KICB2YXIgQ2xpZW50RW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMubXVsdGlwbGV4ZXIgPSBuZXcgY29ubmVjdC5TdHJlYW1NdWx0aXBsZXhlcigpOwogICAgdGhpcy5jb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdCgiQW1hem9uQ29ubmVjdFNoYXJlZFdvcmtlciIsIG51bGwsIHRoaXMubXVsdGlwbGV4ZXIpOwogICAgdGhpcy5jbGllbnQgPSBuZXcgV29ya2VyQ2xpZW50KHRoaXMuY29uZHVpdCk7CiAgICB0aGlzLnRpbWVvdXQgPSBudWxsOwogICAgdGhpcy5hZ2VudCA9IG51bGw7CiAgICB0aGlzLm5leHRUb2tlbiA9IG51bGw7CiAgICB0aGlzLmluaXREYXRhID0ge307CiAgICB0aGlzLnBvcnRDb25kdWl0TWFwID0ge307CiAgICB0aGlzLnN0cmVhbU1hcEJ5VGFiSWQgPSB7fTsKICAgIHRoaXMubWFzdGVyQ29vcmQgPSBuZXcgTWFzdGVyVG9waWNDb29yZGluYXRvcigpOwogICAgdGhpcy5sb2dzQnVmZmVyID0gW107CiAgICB0aGlzLnN1cHByZXNzID0gZmFsc2U7CiAgICB0aGlzLmZvcmNlT2ZmbGluZSA9IGZhbHNlOwogICAgdGhpcy5sb25nUG9sbGluZ09wdGlvbnMgPSB7CiAgICAgIGFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlOiBmYWxzZSwgCiAgICAgIGFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZTogZmFsc2UsCiAgICB9CgogICAgdmFyIHdlYlNvY2tldE1hbmFnZXIgPSBudWxsOwoKICAgIGNvbm5lY3Qucm9vdExvZ2dlciA9IG5ldyBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyKHRoaXMuY29uZHVpdCk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGZ1bmN0aW9uIChsb2dzVG9VcGxvYWQpIHsKICAgICAgLy8gQWRkIHNvZnRwaG9uZSBsb2dzIGRvd25zdHJlYW0KICAgICAgY29ubmVjdC5nZXRMb2coKS5wdXNoTG9nc0Rvd25zdHJlYW0obG9nc1RvVXBsb2FkKTsKCiAgICAgIHNlbGYubG9nc0J1ZmZlciA9IHNlbGYubG9nc0J1ZmZlci5jb25jYXQobG9nc1RvVXBsb2FkKTsKICAgICAgLy9vbmx5IGNhbGwgQVBJIHRvIHNlbmQgbG9ncyBpZiBidWZmZXIgcmVhY2hlZCBjYXAKICAgICAgaWYgKHNlbGYubG9nc0J1ZmZlci5sZW5ndGggPiBMT0dfQlVGRkVSX0NBUF9TSVpFKSB7CiAgICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU1VQUFJFU1MsIGZ1bmN0aW9uIChkYXRhKXsKICAgICAgY29ubmVjdC5nZXRMb2coKS5kZWJ1ZygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTZXR0aW5nIFN1cHByZXNzIHRvICVzIiwgZGF0YS5zdXBwcmVzcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5zdXBwcmVzcyA9IGRhdGEuc3VwcHJlc3MgfHwgZmFsc2U7CiAgICAgIC8vc2lnbmFsIG90aGVyIHdpbmRvd3MgdGhhdCBhIGZhaWxvdmVyIGhhcHBlbmVkCiAgICAgIGlmIChzZWxmLm1hc3RlckNvb3JkLmdldE1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUpKSB7CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GQUlMT1ZFUiwgewogICAgICAgICAgaXNQcmltYXJ5OiAhc2VsZi5zdXBwcmVzcwogICAgICAgIH0pOyAgICAgIAogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgRk9SQ0VfT0ZGTElORSB0byAlcyIsIGRhdGEub2ZmbGluZSkKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5mb3JjZU9mZmxpbmUgPSBkYXRhLm9mZmxpbmUgfHwgZmFsc2U7CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKGRhdGEuYXV0aFRva2VuICYmIGRhdGEuYXV0aFRva2VuICE9PSBzZWxmLmluaXREYXRhLmF1dGhUb2tlbikgewogICAgICAgIHNlbGYuaW5pdERhdGEgPSBkYXRhOwogICAgICAgIGNvbm5lY3QuY29yZS5pbml0KGRhdGEpOwogICAgICAgIGlmIChkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucykgewogICAgICAgICAgaWYgKHR5cGVvZiBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZSA9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgc2VsZi5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGUgPSBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlID09ICJib29sZWFuIikgewogICAgICAgICAgICBzZWxmLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGUgPSBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIGluaXQgb25seSBvbmNlLgogICAgICAgIGlmICghd2ViU29ja2V0TWFuYWdlcikgewoKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ3JlYXRpbmcgYSBuZXcgV2Vic29ja2V0IGNvbm5lY3Rpb24gZm9yIENDUCIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgIGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlci5zZXRHbG9iYWxDb25maWcoewogICAgICAgICAgICBsb2dnZXJDb25maWc6IHsgbG9nZ2VyOiBjb25uZWN0LmdldExvZygpIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIgPSBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuY3JlYXRlKCk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkluaXRGYWlsdXJlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbk9wZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uQ2xvc2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkdhaW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uTG9zdChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uU3Vic2NyaXB0aW9uVXBkYXRlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvbkZhaWx1cmUoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkFsbE1lc3NhZ2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLnNlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zdWJzY3JpYmVUb3BpY3ModG9waWNzKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuaW5pdChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuZ2V0V2ViU29ja2V0VXJsKSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChyZXNwb25zZSAmJiAhcmVzcG9uc2Uud2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZCkgewogICAgICAgICAgICAgICAgLy8gU3RhcnQgcG9sbGluZyBmb3IgYWdlbnQgZGF0YS4KICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYWdlbnQgcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnQoKTsKICAKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgY29uZmlnIHBvbGxpbmciKQogICAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbih7IHJlcGVhdEZvcmV2ZXI6IHRydWUgfSk7CiAgCiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGF1dGggdG9rZW4gcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5jaGVja0F1dGhUb2tlbiksIENIRUNLX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICAgICAgICAgICAgICBjb25zdCBldmVudCA9IGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRTsKICAgICAgICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGV2ZW50KTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJXZWJTb2NrZXQgZmFpbGVkIHRvIGluaXRpYWxpemUiKQogICAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJOb3QgSW5pdGlhbGl6aW5nIGEgbmV3IFdlYnNvY2tldE1hbmFnZXIgaW5zdGFuY2UsIHNpbmNlIG9uZSBhbHJlYWR5IGV4aXN0cyIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURSwgZnVuY3Rpb24gKCkgewogICAgICAvL3VwbG9hZCBwZW5kaW5nIGxvZ3MgYmVmb3JlIHRlcm1pbmF0aW5nLgogICAgICBzZWxmLmhhbmRsZVNlbmRMb2dzUmVxdWVzdChzZWxmLmxvZ3NCdWZmZXIpOwogICAgICBjb25uZWN0LmNvcmUudGVybWluYXRlKCk7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVEKTsKICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TWU5DSFJPTklaRSwgZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UpOwogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGRhdGEuZXZlbnQsIGRhdGEuZGF0YSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENhbGxlZCB3aGVuIGEgY29uc3VtZXIgcG9ydCBjb25uZWN0cyB0byB0aGlzIFNoYXJlZFdvcmtlci4KICAgICAqIExldCdzIGFkZCB0aGVtIHRvIG91ciBtdWx0aXBsZXhlci4KICAgICAqLwogICAgZ2xvYmFsLm9uY29ubmVjdCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICB2YXIgcG9ydCA9IGV2ZW50LnBvcnRzWzBdOwogICAgICB2YXIgc3RyZWFtID0gbmV3IGNvbm5lY3QuUG9ydFN0cmVhbShwb3J0KTsKICAgICAgc2VsZi5tdWx0aXBsZXhlci5hZGRTdHJlYW0oc3RyZWFtKTsKICAgICAgcG9ydC5zdGFydCgpOwoKICAgICAgdmFyIHBvcnRDb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdChzdHJlYW0uZ2V0SWQoKSwgbnVsbCwgc3RyZWFtKTsKICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIHsgaWQ6IHN0cmVhbS5nZXRJZCgpIH0pOwoKICAgICAgc2VsZi5wb3J0Q29uZHVpdE1hcFtzdHJlYW0uZ2V0SWQoKV0gPSBwb3J0Q29uZHVpdDsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgeyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCB9KTsKCiAgICAgIGlmIChzZWxmLmFnZW50ICE9PSBudWxsKSB7CiAgICAgICAgc2VsZi51cGRhdGVBZ2VudCgpOwogICAgICB9CgogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFUVVFU1QsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFQSVJlcXVlc3QsIHBvcnRDb25kdWl0KSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVRVUVTVCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlTWFzdGVyUmVxdWVzdCwgcG9ydENvbmR1aXQsIHN0cmVhbS5nZXRJZCgpKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5SRUxPQURfQUdFTlRfQ09ORklHVVJBVElPTiwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbikpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEFCX0lELAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVUYWJJZEV2ZW50LCBzdHJlYW0pKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNMT1NFLCAKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQ2xvc2VFdmVudCwgc3RyZWFtKSk7CiAgICB9OwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TTkFQU0hPVCwgewogICAgICBuZXh0VG9rZW46IHNlbGYubmV4dFRva2VuLAogICAgICB0aW1lb3V0OiBHRVRfQUdFTlRfVElNRU9VVF9NUwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmLmFnZW50ID0gc2VsZi5hZ2VudCB8fCB7fTsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdCA9IGRhdGEuc25hcHNob3Q7CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3QubG9jYWxUaW1lc3RhbXAgPSBjb25uZWN0Lm5vdygpOwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90LnNrZXcgPSBzZWxmLmFnZW50LnNuYXBzaG90LnNuYXBzaG90VGltZXN0YW1wIC0gc2VsZi5hZ2VudC5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcDsKICAgICAgICAgICAgc2VsZi5uZXh0VG9rZW4gPSBkYXRhLm5leHRUb2tlbjsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiR0VUX0FHRU5UX1NOQVBTSE9UIHN1Y2NlZWRlZC4iKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiTG9uZyBwb2xsIGZhaWxlZCB0byB1cGRhdGUgYWdlbnQuIikKICAgICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50KSwgR0VUX0FHRU5UX1NVQ0NFU1NfVElNRU9VVF9NUyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZ2V0IGFnZW50IGRhdGEuIikKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnQpLCBHRVRfQUdFTlRfUkVDT1ZFUllfVElNRU9VVF9NUyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQoKICAgICAgfSk7CgogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9DT05GSUdVUkFUSU9OLCB7fSwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciBjb25maWd1cmF0aW9uID0gZGF0YS5jb25maWd1cmF0aW9uOwogICAgICAgIHNlbGYucG9sbEZvckFnZW50UGVybWlzc2lvbnMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgaWYgKHBhcmFtcy5yZXBlYXRGb3JldmVyKSB7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiwgcGFyYW1zKSwKICAgICAgICAgICAgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgY29uZmlndXJhdGlvbiBkYXRhLiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAocGFyYW1zLnJlcGVhdEZvcmV2ZXIpIHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pLAogICAgICAgICAgICAgIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TLCBwYXJhbXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgIH0sCiAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50U3RhdGVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TVEFURVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCgogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIHN0YXRlczogKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLmFnZW50U3RhdGVzID0gKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IHN0YXRlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9QRVJNSVNTSU9OUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBwZXJtaXNzaW9uczogKHBhcmFtcy5wZXJtaXNzaW9ucyB8fCBbXSkuY29uY2F0KGRhdGEucGVybWlzc2lvbnMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyA9IChwYXJhbXMucGVybWlzc2lvbnMgfHwgW10pLmNvbmNhdChkYXRhLnBlcm1pc3Npb25zKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgcGVybWlzc2lvbnMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0RJQUxBQkxFX0NPVU5UUllfQ09ERVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2Rlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uZGlhbGFibGVDb3VudHJpZXMgPSAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggZGlhbGFibGUgY291bnRyeSBjb2RlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfUk9VVElOR19QUk9GSUxFX1FVRVVFUywgewogICAgICByb3V0aW5nUHJvZmlsZUFSTjogY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTiwKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLnF1ZXVlcyB8fCBbXSkuY29uY2F0KGRhdGEucXVldWVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzID0gKHBhcmFtcy5xdWV1ZXMgfHwgW10pLmNvbmNhdChkYXRhLnF1ZXVlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIHJvdXRpbmcgcHJvZmlsZSBxdWV1ZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBUElSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCByZXF1ZXN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5jbGllbnQuY2FsbChyZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXJhbXMsIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEsIEpTT04uc3RyaW5naWZ5KGVycikpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBBUEkgcmVxdWVzdCBmYWlsZWQiLCByZXF1ZXN0Lm1ldGhvZCkKICAgICAgICAgIC53aXRoT2JqZWN0KHsgcmVxdWVzdDogc2VsZi5maWx0ZXJBdXRoVG9rZW4ocmVxdWVzdCksIHJlc3BvbnNlOiByZXNwb25zZSB9KQogICAgICAgICAgLndpdGhFeGNlcHRpb24oZXJyKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwsIHthdXRob3JpemU6IHRydWV9KQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogSGFuZGxlIGluY29taW5nIG1hc3RlciBxdWVyeSBvciBtb2RpZmljYXRpb24gcmVxdWVzdHMgZnJvbSBjb25uZWN0ZWQgdGFiIHBvcnRzLgogICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlTWFzdGVyUmVxdWVzdCA9IGZ1bmN0aW9uIChwb3J0Q29uZHVpdCwgcG9ydElkLCByZXF1ZXN0KSB7CiAgICB2YXIgbXVsdGlwbGV4ZXJDb25kdWl0ID0gdGhpcy5jb25kdWl0OwogICAgdmFyIHJlc3BvbnNlID0gbnVsbDsKCiAgICBzd2l0Y2ggKHJlcXVlc3QubWV0aG9kKSB7CiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVI6CiAgICAgICAgdmFyIG1hc3RlcklkID0gdGhpcy5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMpOwogICAgICAgIHZhciB0YWtlT3ZlciA9IEJvb2xlYW4obWFzdGVySWQpICYmIG1hc3RlcklkICE9PSBwb3J0SWQ7CiAgICAgICAgdGhpcy5tYXN0ZXJDb29yZC5zZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMsIHBvcnRJZCk7CiAgICAgICAgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIHJlcXVlc3QsIHsKICAgICAgICAgIG1hc3RlcklkOiBwb3J0SWQsCiAgICAgICAgICB0YWtlT3ZlcjogdGFrZU92ZXIsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKICAgICAgICBpZiAodGFrZU92ZXIpIHsKICAgICAgICAgIG11bHRpcGxleGVyQ29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUjoKICAgICAgICB2YXIgbWFzdGVySWQgPSB0aGlzLm1hc3RlckNvb3JkLmdldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYyk7CiAgICAgICAgaWYgKCFtYXN0ZXJJZCAmJiAhcmVxdWVzdC5wYXJhbXMuc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lKSB7CiAgICAgICAgICB0aGlzLm1hc3RlckNvb3JkLnNldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYywgcG9ydElkKTsKICAgICAgICAgIG1hc3RlcklkID0gcG9ydElkOwogICAgICAgIH0KICAgICAgICByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgcmVxdWVzdCwgewogICAgICAgICAgbWFzdGVySWQ6IG1hc3RlcklkLAogICAgICAgICAgaXNNYXN0ZXI6IHBvcnRJZCA9PT0gbWFzdGVySWQsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIG1hc3RlciBtZXRob2Q6ICIgKyByZXF1ZXN0Lm1ldGhvZCk7CiAgICB9CgogICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZVRhYklkRXZlbnQgPSBmdW5jdGlvbiAoc3RyZWFtLCBkYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0cnkgewogICAgICBsZXQgdGFiSWQgPSBkYXRhLnRhYklkOwogICAgICBsZXQgc3RyZWFtc0luVGhpc1RhYiA9IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF07CiAgICAgIGxldCBjdXJyZW50U3RyZWFtSWQgPSBzdHJlYW0uZ2V0SWQoKTsKICAgICAgbGV0IHRhYklkcyA9IE9iamVjdC5rZXlzKHNlbGYuc3RyZWFtTWFwQnlUYWJJZCk7CiAgICAgIGxldCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgPSB0YWJJZHMuZmlsdGVyKHRhYklkID0+IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoID4gMCkubGVuZ3RoOwogICAgICBpZiAoc3RyZWFtc0luVGhpc1RhYiAmJiBzdHJlYW1zSW5UaGlzVGFiLmxlbmd0aCA+IDApewogICAgICAgIGlmICghc3RyZWFtc0luVGhpc1RhYi5pbmNsdWRlcyhjdXJyZW50U3RyZWFtSWQpKSB7CiAgICAgICAgICBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLnB1c2goY3VycmVudFN0cmVhbUlkKTsKICAgICAgICAgIGxldCB1cGRhdGVPYmplY3QgPSB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoLCB0YWJJZCwgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyIH07CiAgICAgICAgICB1cGRhdGVPYmplY3RbdGFiSWRdID0geyBsZW5ndGg6IHN0cmVhbXNJblRoaXNUYWIubGVuZ3RoIH07CiAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB1cGRhdGVPYmplY3QpOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdID0gW3N0cmVhbS5nZXRJZCgpXTsKICAgICAgICBsZXQgdXBkYXRlT2JqZWN0ID0geyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCwgdGFiSWQsIHN0cmVhbXNUYWJzQWNyb3NzQnJvd3Nlcjogc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyICsgMSB9OwogICAgICAgIHVwZGF0ZU9iamVjdFt0YWJJZF0gPSB7IGxlbmd0aDogc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggfTsKICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB1cGRhdGVPYmplY3QpOwogICAgICB9CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiW1RhYiBJZHNdIElzc3VlIHVwZGF0aW5nIGNvbm5lY3RlZCBDQ1BzIHdpdGhpbiB0aGUgc2FtZSB0YWIiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVDbG9zZUV2ZW50ID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLm11bHRpcGxleGVyLnJlbW92ZVN0cmVhbShzdHJlYW0pOwogICAgZGVsZXRlIHNlbGYucG9ydENvbmR1aXRNYXBbc3RyZWFtLmdldElkKCldOwogICAgc2VsZi5tYXN0ZXJDb29yZC5yZW1vdmVNYXN0ZXIoc3RyZWFtLmdldElkKCkpOwogICAgbGV0IHVwZGF0ZU9iamVjdCA9IHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGggfTsKICAgIGxldCB0YWJJZHMgPSBPYmplY3Qua2V5cyhzZWxmLnN0cmVhbU1hcEJ5VGFiSWQpOwogICAgdHJ5IHsKICAgICAgbGV0IHRhYklkID0gdGFiSWRzLmZpbmQoa2V5ID0+IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFtrZXldLmluY2x1ZGVzKHN0cmVhbS5nZXRJZCgpKSk7CiAgICAgIGlmICh0YWJJZCkgewogICAgICAgIGxldCBzdHJlYW1JbmRleEluTWFwID0gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5maW5kSW5kZXgoKHZhbHVlKSA9PiBzdHJlYW0uZ2V0SWQoKSA9PT0gdmFsdWUpOwogICAgICAgIHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0uc3BsaWNlKHN0cmVhbUluZGV4SW5NYXAsIDEpOwogICAgICAgIGxldCB0YWJMZW5ndGggPSBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdID8gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggOiAwOwogICAgICAgIHVwZGF0ZU9iamVjdFt0YWJJZF0gPSB7IGxlbmd0aDogdGFiTGVuZ3RoIH07CiAgICAgICAgdXBkYXRlT2JqZWN0LnRhYklkID0gdGFiSWQ7CiAgICAgIH0KICAgICAgbGV0IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciA9IHRhYklkcy5maWx0ZXIodGFiSWQgPT4gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggPiAwKS5sZW5ndGg7CiAgICAgIHVwZGF0ZU9iamVjdC5zdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgPSBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXI7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiW1RhYiBJZHNdIElzc3VlIHVwZGF0aW5nIHRhYklkLXNwZWNpZmljIHN0cmVhbSBkYXRhIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgdXBkYXRlT2JqZWN0KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uKSB7CiAgICBpZiAoY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyAmJgogICAgICBjb25maWd1cmF0aW9uLmRpYWxhYmxlQ291bnRyaWVzICYmCiAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRTdGF0ZXMgJiYKICAgICAgY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMpIHsKCiAgICAgIHRoaXMuYWdlbnQgPSB0aGlzLmFnZW50IHx8IHt9OwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uOwogICAgICB0aGlzLnVwZGF0ZUFnZW50KCk7CgogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgY29uZmlndXJhdGlvbiB1bnRpbCBhbGwgY29uZmlnIGRhdGEgaGFzIGJlZW4gZmV0Y2hlZC4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUudXBkYXRlQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXRoaXMuYWdlbnQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IGhhcyBiZWVuIGZ1bGx5IGNvbnN0cnVjdGVkLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5zbmFwc2hvdCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgc25hcHNob3QgaXMgYXZhaWxhYmxlLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBjb25maWd1cmF0aW9uIGlzIGF2YWlsYWJsZS4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIH0gZWxzZSB7CiAgICAgIC8vIEFsaWFzIHNvbWUgb2YgdGhlIHByb3BlcnRpZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LnN0YXR1cyA9IHRoaXMuYWdlbnQuc3RhdGU7CgogICAgICAvLyBTb3J0IHRoZSBjb250YWN0cyBvbiB0aGUgdGltZXN0YW1wCiAgICAgIGlmICh0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzICYmIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMubGVuZ3RoID4gMSkgewogICAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuc29ydChmdW5jdGlvbiAoY29udGFjdEEsIGNvbnRhY3RCKSB7CiAgICAgICAgICByZXR1cm4gY29udGFjdEEuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSAtIGNvbnRhY3RCLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIGNvbnRhY3Quc3RhdHVzID0gY29udGFjdC5zdGF0ZTsKCiAgICAgICAgY29udGFjdC5jb25uZWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChjb25uZWN0aW9uKSB7CiAgICAgICAgICBjb25uZWN0aW9uLmFkZHJlc3MgPSBjb25uZWN0aW9uLmVuZHBvaW50OwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUlkID0KICAgICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk47CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMuZm9yRWFjaChmdW5jdGlvbiAocXVldWUpIHsKICAgICAgICBxdWV1ZS5xdWV1ZUlkID0gcXVldWUucXVldWVBUk47CiAgICAgIH0pOwogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAvL2NvbnRhY3QucXVldWUgaXMgbnVsbCB3aGVuIG1vbml0b3JpbmcKICAgICAgICBpZiAoY29udGFjdC5xdWV1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjb250YWN0LnF1ZXVlLnF1ZXVlSWQgPSBjb250YWN0LnF1ZXVlLnF1ZXVlQVJOOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkID0KICAgICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk47CiAgICAgIAogICAgICBpZiAodGhpcy5zdXBwcmVzcykgewogICAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMgPSB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZpbHRlcihmdW5jdGlvbihjb250YWN0KXsKICAgICAgICAgIHJldHVybiAoY29udGFjdC5zdGF0ZS50eXBlID09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEIHx8IGNvbnRhY3Quc3RhdGUudHlwZSA9PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVEKTsKICAgICAgICB9KTsKICAgICAgICBpZiAodGhpcy5mb3JjZU9mZmxpbmUpIHsKICAgICAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSk7CiAgICAgICAgfQogICAgICB9IAogICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5VUERBVEUsIHRoaXMuYWdlbnQpOwogICAgfQogIH07CgovKioKICogUHJvdmlkZXMgYSB3ZWJzb2NrZXQgdXJsIHRocm91Z2ggdGhlIGNyZWF0ZV90cmFuc3BvcnQgQVBJLgogKiBAcmV0dXJucyBhIHByb21pc2Ugd2hpY2gsIHVwb24gc3VjY2VzcywgcmV0dXJucyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgY3JlYXRlVHJhbnNwb3J0IEFQSS4KICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5nZXRXZWJTb2NrZXRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwogICAgdmFyIG9uQWNjZXNzRGVuaWVkID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgeyB0cmFuc3BvcnRUeXBlOiBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUy5XRUJfU09DS0VUIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRXZWJTb2NrZXRVcmwgc3VjY2VlZGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgZmFpbGVkIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoewogICAgICAgICAgICByZWFzb246ICdnZXRXZWJTb2NrZXRVcmwgZmFpbGVkJywgCiAgICAgICAgICAgIF9kZWJ1ZzogZXJyCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgQXV0aCBGYWlsdXJlIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChFcnJvcigiQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIGdldHRpbmcgZ2V0V2ViU29ja2V0VXJsIikpOwogICAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgQWNjZXNzIERlbmllZCBGYWlsdXJlIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCBGYWlsdXJlIHdoaWxlIGdldHRpbmcgZ2V0V2ViU29ja2V0VXJsIikpOwogICAgICAgICAgb25BY2Nlc3NEZW5pZWQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCgogIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSBkb3duc3RyZWFtIHRvIGFsbCBjb25zdW1lcnMgd2hlbiB3ZSBkZXRlY3QgdGhhdCBhdXRoZW50aWNhdGlvbgogICAgKiBhZ2FpbnN0IG9uZSBvZiBvdXIgQVBJcyBoYXMgZmFpbGVkLgogICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZVNlbmRMb2dzUmVxdWVzdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dFdmVudHMgPSBbXTsKICAgIHZhciBsb2dzVG9TZW5kID0gc2VsZi5sb2dzQnVmZmVyLnNsaWNlKCk7CiAgICBzZWxmLmxvZ3NCdWZmZXIgPSBbXTsKICAgIGxvZ3NUb1NlbmQuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIGxvZ0V2ZW50cy5wdXNoKHsKICAgICAgICB0aW1lc3RhbXA6IGxvZy50aW1lLAogICAgICAgIGNvbXBvbmVudDogbG9nLmNvbXBvbmVudCwKICAgICAgICBtZXNzYWdlOiBsb2cudGV4dAogICAgICB9KTsKICAgIH0pOwogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9DTElFTlRfTE9HUywgeyBsb2dFdmVudHM6IGxvZ0V2ZW50cyB9LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTZW5kTG9ncyByZXF1ZXN0IHN1Y2NlZWRlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiU2VuZExvZ3MgcmVxdWVzdCBmYWlsZWQuIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLndpdGhFeGNlcHRpb24oZXJyKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpCiAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUF1dGhGYWlsID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChkYXRhKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGRhdGEpOwogICAgfQogICAgZWxzZSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwpOwogICAgfQogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDQ0VTU19ERU5JRUQpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuY2hlY2tBdXRoVG9rZW4gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZXhwaXJhdGlvbkRhdGUgPSBuZXcgRGF0ZShzZWxmLmluaXREYXRhLmF1dGhUb2tlbkV4cGlyYXRpb24pOwogICAgdmFyIGN1cnJlbnRUaW1lU3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciB0aGlydHlNaW5zID0gMzAgKiA2MCAqIDEwMDA7CgogICAgLy8gcmVmcmVzaCB0b2tlbiAzMCBtaW51dGVzIGJlZm9yZSBleHBpcmF0aW9uCiAgICBpZiAoZXhwaXJhdGlvbkRhdGUuZ2V0VGltZSgpIDwgKGN1cnJlbnRUaW1lU3RhbXAgKyB0aGlydHlNaW5zKSkgewogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkF1dGggdG9rZW4gZXhwaXJlcyBhdCAiICsgZXhwaXJhdGlvbkRhdGUgKyAiIFN0YXJ0IHJlZnJlc2hpbmcgdG9rZW4gd2l0aCByZXRyeS4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmJhY2tvZmYoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmF1dGhvcml6ZSksIFJFRlJFU0hfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUywgUkVGUkVTSF9BVVRIX1RPS0VOX01BWF9UUlkpOwogICAgfQogIH07CgoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmF1dGhvcml6ZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QuY29yZS5hdXRob3JpemUodGhpcy5pbml0RGF0YS5hdXRob3JpemVFbmRwb2ludCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgdmFyIGV4cGlyYXRpb24gPSBuZXcgRGF0ZShyZXNwb25zZS5leHBpcmF0aW9uKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBdXRob3JpemF0aW9uIHN1Y2NlZWRlZCBhbmQgdGhlIHRva2VuIGV4cGlyZXMgYXQgJXMiLCBleHBpcmF0aW9uKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBzZWxmLmluaXREYXRhLmF1dGhUb2tlbiA9IHJlc3BvbnNlLmFjY2Vzc1Rva2VuOwogICAgICBzZWxmLmluaXREYXRhLmF1dGhUb2tlbkV4cGlyYXRpb24gPSBleHBpcmF0aW9uOwogICAgICBjb25uZWN0LmNvcmUuaW5pdENsaWVudChzZWxmLmluaXREYXRhKTsKICAgICAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudChzZWxmLmluaXREYXRhKTsKICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoKTsKICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJBdXRob3JpemF0aW9uIGZhaWxlZCB3aXRoIGNvZGUgJXMiLCByZXNwb25zZS5zdGF0dXMpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwMSkgewogICAgICAgIHNlbGYuaGFuZGxlQXV0aEZhaWwoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZSgpOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBGaWx0ZXIgdGhlICdhdXRoZW50aWNhdGlvbicgZmllbGQgb2YgdGhlIHJlcXVlc3QgcGFyYW1zIGZyb20gdGhlIGdpdmVuIEFQSV9SRVFVRVNUIGV2ZW50LgogICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuZmlsdGVyQXV0aFRva2VuID0gZnVuY3Rpb24gKHJlcXVlc3QpIHsKICAgIHZhciBuZXdfcmVxdWVzdCA9IHt9OwoKICAgIGZvciAodmFyIGtleUEgaW4gcmVxdWVzdCkgewogICAgICBpZiAoa2V5QSA9PT0gJ3BhcmFtcycpIHsKICAgICAgICB2YXIgbmV3X3BhcmFtcyA9IHt9OwogICAgICAgIGZvciAodmFyIGtleUIgaW4gcmVxdWVzdC5wYXJhbXMpIHsKICAgICAgICAgIGlmIChrZXlCICE9PSAnYXV0aGVudGljYXRpb24nKSB7CiAgICAgICAgICAgIG5ld19wYXJhbXNba2V5Ql0gPSByZXF1ZXN0LnBhcmFtc1trZXlCXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG5ld19yZXF1ZXN0LnBhcmFtcyA9IG5ld19wYXJhbXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmV3X3JlcXVlc3Rba2V5QV0gPSByZXF1ZXN0W2tleUFdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG5ld19yZXF1ZXN0OwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0Lndvcmtlci5tYWluID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC53b3JrZXIuY2xpZW50RW5naW5lID0gbmV3IENsaWVudEVuZ2luZSgpOwogIH07Cgp9KSgpOwoKLyoqKi8gfSkKCi8qKioqKiovIAl9KTsKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18gPSB7fTsKLyoqKioqKi8gCQovKioqKioqLyAJLy8gVGhlIHJlcXVpcmUgZnVuY3Rpb24KLyoqKioqKi8gCWZ1bmN0aW9uIF9fd2VicGFja19yZXF1aXJlX18obW9kdWxlSWQpIHsKLyoqKioqKi8gCQkvLyBDaGVjayBpZiBtb2R1bGUgaXMgaW4gY2FjaGUKLyoqKioqKi8gCQl2YXIgY2FjaGVkTW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXTsKLyoqKioqKi8gCQlpZiAoY2FjaGVkTW9kdWxlICE9PSB1bmRlZmluZWQpIHsKLyoqKioqKi8gCQkJcmV0dXJuIGNhY2hlZE1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJCX0KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdID0gewovKioqKioqLyAJCQkvLyBubyBtb2R1bGUuaWQgbmVlZGVkCi8qKioqKiovIAkJCS8vIG5vIG1vZHVsZS5sb2FkZWQgbmVlZGVkCi8qKioqKiovIAkJCWV4cG9ydHM6IHt9Ci8qKioqKiovIAkJfTsKLyoqKioqKi8gCQovKioqKioqLyAJCS8vIEV4ZWN1dGUgdGhlIG1vZHVsZSBmdW5jdGlvbgovKioqKioqLyAJCV9fd2VicGFja19tb2R1bGVzX19bbW9kdWxlSWRdLmNhbGwobW9kdWxlLmV4cG9ydHMsIG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pOwovKioqKioqLyAJCi8qKioqKiovIAkJLy8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGUKLyoqKioqKi8gCQlyZXR1cm4gbW9kdWxlLmV4cG9ydHM7Ci8qKioqKiovIAl9Ci8qKioqKiovIAkKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gCS8qIHdlYnBhY2svcnVudGltZS9nbG9iYWwgKi8KLyoqKioqKi8gCSgoKSA9PiB7Ci8qKioqKiovIAkJX193ZWJwYWNrX3JlcXVpcmVfXy5nID0gKGZ1bmN0aW9uKCkgewovKioqKioqLyAJCQlpZiAodHlwZW9mIGdsb2JhbFRoaXMgPT09ICdvYmplY3QnKSByZXR1cm4gZ2xvYmFsVGhpczsKLyoqKioqKi8gCQkJdHJ5IHsKLyoqKioqKi8gCQkJCXJldHVybiB0aGlzIHx8IG5ldyBGdW5jdGlvbigncmV0dXJuIHRoaXMnKSgpOwovKioqKioqLyAJCQl9IGNhdGNoIChlKSB7Ci8qKioqKiovIAkJCQlpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ29iamVjdCcpIHJldHVybiB3aW5kb3c7Ci8qKioqKiovIAkJCX0KLyoqKioqKi8gCQl9KSgpOwovKioqKioqLyAJfSkoKTsKLyoqKioqKi8gCQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqLyAJCi8qKioqKiovIAkvLyBzdGFydHVwCi8qKioqKiovIAkvLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHMKLyoqKioqKi8gCS8vIFRoaXMgZW50cnkgbW9kdWxlIHVzZWQgJ21vZHVsZScgc28gaXQgY2FuJ3QgYmUgaW5saW5lZAovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MjcpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygxNjMpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg5NDQpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygxNTEpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4OTEpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg1OTIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4Mik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDc1NCk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgzMyk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDk2NSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDI4Nik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDg5NSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDc0Myk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDY0Mik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDczNik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDQzOSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDI3OSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDQxOCk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDE4Nyk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgyMSk7Ci8qKioqKiovIAl2YXIgX193ZWJwYWNrX2V4cG9ydHNfXyA9IF9fd2VicGFja19yZXF1aXJlX18oNTAwKTsKLyoqKioqKi8gCQovKioqKioqLyB9KSgpCjs=";

  var LATEST_STREAMJS_CODE = window.atob(LATEST_STREAMJS_BASE64_CODE);


  /**
   Connect instance container
   It holds the connect api context within an iframe window.

   usage:
   var newContainer = new Container({ccpUrl: "bla", ...})
   */
  var Container = function(resource) {
      this.region = resource.region;
      this.id = this.region.replace(/-/g, '_');
      this.height = resource.height;
      this.style = resource.iframe_style; 
      this.ccp = this._createFramedCcp(JSON.stringify(resource));
  };

  Container.prototype._createFramedCcp = function (resource) {
    var permission = permission || "microphone; autoplay";
    var style = this.style || FRAME_DIMENSIONS;
    var iframe = document.createElement('iframe');
    iframe.srcdoc = this.getContent(resource);
    iframe.allow = permission;
    iframe.id = this.id;
    iframe.style = style;
    iframe.scrolling = "no";
    return iframe; 
  };

  Container.prototype.getContent = function(resource){
     return [
       "<!DOCTYPE html>",
       "<meta charset='UTF-8'>",
       "<html>",
         "<head>",
           "<script type='text/javascript'>",
             LATEST_STREAMJS_CODE,
           "</script>",
         "</head>",
         "<body onload='init()'>",
           "<div id=containerDiv style='width: 100%;height: " + this.height + "'></div>",
           "<script type='text/javascript'>",
             "function init() {",
               "connect.core.initCCP(containerDiv," + resource + ");",
            "}",
           "</script>",
         "</body>",
       "</html>"
     ].join('');
   };

  globalConnect.Container = Container;
})();

/***/ }),

/***/ 341:
/***/ (() => {

/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Note: load utils before core.js
 */

(function () {
  var global = this || globalThis;
  var connect = global.connect || {};
  var globalConnect = global.globalConnect || {};
  global.connect = connect;
  global.globalConnect = globalConnect;
  global.lily = connect;

  connect.core = {};
  globalConnect.core = { regions: {} };

  var IFRAME_STYLE = "margin: 0; border: 0; padding:0px;width: 0px;height: 0px";
  var GLOBALIFRAME_STYLE =
    "margin: 0; border: 0; padding:0px;width: 100%;height: 100%";
  var DIV_DEFAULT_HEIGHT = {
    height: "465px",
  };
  var uiFailoverEnabled = true;

  var extractCcpRegionParams = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.standByRegion, "ccpBackupResource");
    connect.assertNotNull(paramsIn.standByRegion.ccpUrl, "ccpUrl");
    connect.assertNotNull(paramsIn.standByRegion.loginUrl, "loginUrl");
    connect.assertNotNull(paramsIn.standByRegion.region, "region");

    var regionAParams = paramsIn;
    var regionBParams = Object.assign({}, paramsIn, {
      ccpUrl: paramsIn.standByRegion.ccpUrl,
      loginUrl: paramsIn.standByRegion.loginUrl,
      region: paramsIn.standByRegion.region,
    });

    var divStyle = extractDivStyle(globalContainerDiv);

    if (divStyle.display == "none") {
      uiFailoverEnabled = false;
    }

    if (parseInt(divStyle.height) <= 0) {
      globalContainerDiv.style.height = DIV_DEFAULT_HEIGHT.height; // populating ccp
      divStyle.height = DIV_DEFAULT_HEIGHT.height;
    }

    return [regionAParams, regionBParams].map(function (params) {
      connect.assertNotNull(params.ccpUrl, "ccpUrl");
      connect.assertNotNull(params.loginUrl, "loginUrl");
      connect.assertNotNull(params.region, "region");
      delete params.standByRegion;
      params.loginPopup = false;
      //signal CCP as part of a disaster recovery fleet
      params.disasterRecoveryOn = true;
      params.iframe_style = IFRAME_STYLE;
      params.height = divStyle.height;
      return params;
    });
  };

  var extractDivStyle = function (globalContainerDiv) {
    var style = window.getComputedStyle(globalContainerDiv);
    return {
      height: style.getPropertyValue("height"),
      width: style.getPropertyValue("width"),
      display: style.getPropertyValue("display"),
    };
  };

  var validateRegion = function (region, availableRegions) {
    connect.assertTrue(
      typeof region == "string",
      "Region provided " + region + " is not a valid string"
    );
    var regions = availableRegions || globalConnect.core.regions;
    if (!regions.hasOwnProperty(region)) {
      var message = "Region provided " + region + " is not found!";
      throw new connect.ValueError(message);
    }
  };

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it successfully gets the primary region.
   * 
   * @callback getPrimaryRegionSuccessCallback
   * @param {string} region -- A string representing an AWS region (e.g. "us-west-2") that is serving as the primary region in the disaster recovery setup.
   */

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it fails to get the primary region.
   * 
   * @callback getPrimaryRegionFailureCallback
   *
   */

  /**
   * Callback for fetching the primary region in a disaster recovery setup.
   * 
   * @callback getPrimaryRegionCallback
   * @param {getPrimaryRegionSuccessCallback} success -- A success callback that getPrimaryRegionCallback should call upon successfully fetching the primary region string.
   * @param {getPrimaryRegionFailureCallback} failure -- A failure callback that getPrimaryRegionCalllback should call upon unsuccessfully fetching the primary region string.
   */


  /**
   * Particular to DR, the getPrimaryRegion paramsIn field is new, and required. It returns a promise that is resolved once the CCP and namespace are successfully initialized. 
   * It is recommended that you do not attempt to use the connect object before this promise is resolved.
   * @param {object} globalContainerDiv -- The container div for the active and secondary CCPs for use with DR.
   * @param {object} paramsIn -- Identical to connect.core.initCCP's paramsIn, save for one additional param.
   * @param {getPrimaryRegionCallback} paramsIn.getPrimaryRegion -- Required. A callback function that fetches the primary region for DR as a string (like "us-west-2") and feeds it into the success callback.
   */
  globalConnect.core.initCCP = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.getPrimaryRegion, "getPrimaryRegion");
    connect.assertTrue(
      connect.isFunction(paramsIn.getPrimaryRegion),
      "getPrimaryRegion must be a function"
    );
    var getPrimaryRegionFunc = paramsIn.getPrimaryRegion;
    delete paramsIn.getPrimaryRegion;

    var dualCcpResources = extractCcpRegionParams(globalContainerDiv, paramsIn);
    getPrimaryRegionFunc(
      function (primaryRegion) {
        return new Promise(resolve => {
          var regions = dualCcpResources.reduce(function (obj, resource) {
            obj[resource.region] = null;
            return obj;
          }, {});
          validateRegion(primaryRegion, regions);

          var containers = dualCcpResources.map(function (resource) {
            if (resource.region === primaryRegion) {
              resource.isPrimary = true;
            }
            return new globalConnect.Container(resource);
          });

          //Create global Iframe and attach ccp containers
          var ccpIframes = containers.map(function (container) {
            return container.ccp.outerHTML;
          });
          var globalIframe = document.createElement("iframe");
          globalIframe.style = GLOBALIFRAME_STYLE;
          globalIframe.id = "globalCCP";
          globalIframe.scrolling = "no";

          // surface single instance connect api in main window
          globalIframe.onload = function () {
            if (uiFailoverEnabled) {
              var secondaryRegion = Object.keys(regions).find(function (
                region
              ) {
                return region != primaryRegion;
              });

              activateUI(primaryRegion, globalIframe.id);
              deactivateUI(secondaryRegion, globalIframe.id);
            }
            containers.map(function (container) {
              globalConnect.core.regions[container.region] =
                globalIframe.contentDocument.getElementById(
                  container.id
                ).contentWindow.connect;
              //listen to failover state change from other window
              var regionalConnect =
                globalConnect.core.regions[container.region];
              regionalConnect.core
                .getUpstream()
                .onUpstream(
                  regionalConnect.DisasterRecoveryEvents.FAILOVER,
                  function (data) {
                    if (data.isPrimary) {
                      connect = regionalConnect;
                      primaryRegion = connect.core.region;
                      if (uiFailoverEnabled) {
                        activateUI(primaryRegion, globalIframe.id);
                      }
                    } else if (uiFailoverEnabled) {
                      secondaryRegion = regionalConnect.core.region;
                      deactivateUI(secondaryRegion, globalIframe.id);
                    }
                  }
                );
            });
            connect = globalConnect.core.regions[primaryRegion];
            resolve();
          };
          globalIframe.srcdoc = ccpIframes.join("");
          globalContainerDiv.appendChild(globalIframe);
        });
      },
      function (callback) {
        console.error(
          "[Disaster Recovery] An error occured, while attempting to retrieve your primary region;"
        );
        callback();
      }
    );
  };

  var deactivateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height: 0; width: 0; border: 0px";
  };

  var activateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height:800px;width:100%;border:0px";
  };

  var getFailoverRegion = function (primaryRegion) {
    var primaryRegion = primaryRegion || connect.core.region;
    return Object.keys(globalConnect.core.regions).find(function (r) {
      return r !== primaryRegion;
    });
  };

  globalConnect.core.failover = function () {
    globalConnect.core.failoverTo(getFailoverRegion());
  };

  globalConnect.core.failoverTo = function (electedNewPrimaryRegion) {
      validateRegion(electedNewPrimaryRegion);
      var currentPrimaryRegion = getFailoverRegion(electedNewPrimaryRegion);
      deactivate(currentPrimaryRegion);
      activate(electedNewPrimaryRegion);
      connect = globalConnect.core.regions[electedNewPrimaryRegion];
  };

  /**-------------------------------------------------------------------------
   * Deactivates a region
   */
  var deactivate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Deactivating %s region.", connect.core.region)
      .sendInternalLogToServer();
    // call this to suppress contacts
    connect.core.suppressContacts(true);
    connect.core.forceOffline();
  };

  /**-------------------------------------------------------------------------
   * Activates Stand-by region on failover using suppress==false event
   */
  var activate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Activating %s region.", connect.core.region)
      .sendInternalLogToServer();
    connect.core.suppressContacts(false);
  };

  //reference to globalConnect initCCP. This is to mimic the single initialization CCP behavior
  connect.core.initCCP = globalConnect.core.initCCP;
})();


/***/ }),

/***/ 163:
/***/ (function() {

/*
 * JavaScript MD5
 * https://github.com/blueimp/JavaScript-MD5
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * https://opensource.org/licenses/MIT
 *
 * Based on
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */

/* global define */

/* eslint-disable strict */

;(function ($) {
  'use strict'
	var ctx = this || globalThis;

  /**
   * Add integers, wrapping at 2^32.
   * This uses 16-bit operations internally to work around bugs in interpreters.
   *
   * @param {number} x First integer
   * @param {number} y Second integer
   * @returns {number} Sum
   */
  function safeAdd(x, y) {
    var lsw = (x & 0xffff) + (y & 0xffff)
    var msw = (x >> 16) + (y >> 16) + (lsw >> 16)
    return (msw << 16) | (lsw & 0xffff)
  }

  /**
   * Bitwise rotate a 32-bit number to the left.
   *
   * @param {number} num 32-bit number
   * @param {number} cnt Rotation count
   * @returns {number} Rotated number
   */
  function bitRotateLeft(num, cnt) {
    return (num << cnt) | (num >>> (32 - cnt))
  }

  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} q q
   * @param {number} a a
   * @param {number} b b
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5cmn(q, a, b, x, s, t) {
    return safeAdd(bitRotateLeft(safeAdd(safeAdd(a, q), safeAdd(x, t)), s), b)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5ff(a, b, c, d, x, s, t) {
    return md5cmn((b & c) | (~b & d), a, b, x, s, t)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5gg(a, b, c, d, x, s, t) {
    return md5cmn((b & d) | (c & ~d), a, b, x, s, t)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5hh(a, b, c, d, x, s, t) {
    return md5cmn(b ^ c ^ d, a, b, x, s, t)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5ii(a, b, c, d, x, s, t) {
    return md5cmn(c ^ (b | ~d), a, b, x, s, t)
  }

  /**
   * Calculate the MD5 of an array of little-endian words, and a bit length.
   *
   * @param {Array} x Array of little-endian words
   * @param {number} len Bit length
   * @returns {Array<number>} MD5 Array
   */
  function binlMD5(x, len) {
    /* append padding */
    x[len >> 5] |= 0x80 << len % 32
    x[(((len + 64) >>> 9) << 4) + 14] = len

    var i
    var olda
    var oldb
    var oldc
    var oldd
    var a = 1732584193
    var b = -271733879
    var c = -1732584194
    var d = 271733878

    for (i = 0; i < x.length; i += 16) {
      olda = a
      oldb = b
      oldc = c
      oldd = d

      a = md5ff(a, b, c, d, x[i], 7, -680876936)
      d = md5ff(d, a, b, c, x[i + 1], 12, -389564586)
      c = md5ff(c, d, a, b, x[i + 2], 17, 606105819)
      b = md5ff(b, c, d, a, x[i + 3], 22, -1044525330)
      a = md5ff(a, b, c, d, x[i + 4], 7, -176418897)
      d = md5ff(d, a, b, c, x[i + 5], 12, 1200080426)
      c = md5ff(c, d, a, b, x[i + 6], 17, -1473231341)
      b = md5ff(b, c, d, a, x[i + 7], 22, -45705983)
      a = md5ff(a, b, c, d, x[i + 8], 7, 1770035416)
      d = md5ff(d, a, b, c, x[i + 9], 12, -1958414417)
      c = md5ff(c, d, a, b, x[i + 10], 17, -42063)
      b = md5ff(b, c, d, a, x[i + 11], 22, -1990404162)
      a = md5ff(a, b, c, d, x[i + 12], 7, 1804603682)
      d = md5ff(d, a, b, c, x[i + 13], 12, -40341101)
      c = md5ff(c, d, a, b, x[i + 14], 17, -1502002290)
      b = md5ff(b, c, d, a, x[i + 15], 22, 1236535329)

      a = md5gg(a, b, c, d, x[i + 1], 5, -165796510)
      d = md5gg(d, a, b, c, x[i + 6], 9, -1069501632)
      c = md5gg(c, d, a, b, x[i + 11], 14, 643717713)
      b = md5gg(b, c, d, a, x[i], 20, -373897302)
      a = md5gg(a, b, c, d, x[i + 5], 5, -701558691)
      d = md5gg(d, a, b, c, x[i + 10], 9, 38016083)
      c = md5gg(c, d, a, b, x[i + 15], 14, -660478335)
      b = md5gg(b, c, d, a, x[i + 4], 20, -405537848)
      a = md5gg(a, b, c, d, x[i + 9], 5, 568446438)
      d = md5gg(d, a, b, c, x[i + 14], 9, -1019803690)
      c = md5gg(c, d, a, b, x[i + 3], 14, -187363961)
      b = md5gg(b, c, d, a, x[i + 8], 20, 1163531501)
      a = md5gg(a, b, c, d, x[i + 13], 5, -1444681467)
      d = md5gg(d, a, b, c, x[i + 2], 9, -51403784)
      c = md5gg(c, d, a, b, x[i + 7], 14, 1735328473)
      b = md5gg(b, c, d, a, x[i + 12], 20, -1926607734)

      a = md5hh(a, b, c, d, x[i + 5], 4, -378558)
      d = md5hh(d, a, b, c, x[i + 8], 11, -2022574463)
      c = md5hh(c, d, a, b, x[i + 11], 16, 1839030562)
      b = md5hh(b, c, d, a, x[i + 14], 23, -35309556)
      a = md5hh(a, b, c, d, x[i + 1], 4, -1530992060)
      d = md5hh(d, a, b, c, x[i + 4], 11, 1272893353)
      c = md5hh(c, d, a, b, x[i + 7], 16, -155497632)
      b = md5hh(b, c, d, a, x[i + 10], 23, -1094730640)
      a = md5hh(a, b, c, d, x[i + 13], 4, 681279174)
      d = md5hh(d, a, b, c, x[i], 11, -358537222)
      c = md5hh(c, d, a, b, x[i + 3], 16, -722521979)
      b = md5hh(b, c, d, a, x[i + 6], 23, 76029189)
      a = md5hh(a, b, c, d, x[i + 9], 4, -640364487)
      d = md5hh(d, a, b, c, x[i + 12], 11, -421815835)
      c = md5hh(c, d, a, b, x[i + 15], 16, 530742520)
      b = md5hh(b, c, d, a, x[i + 2], 23, -995338651)

      a = md5ii(a, b, c, d, x[i], 6, -198630844)
      d = md5ii(d, a, b, c, x[i + 7], 10, 1126891415)
      c = md5ii(c, d, a, b, x[i + 14], 15, -1416354905)
      b = md5ii(b, c, d, a, x[i + 5], 21, -57434055)
      a = md5ii(a, b, c, d, x[i + 12], 6, 1700485571)
      d = md5ii(d, a, b, c, x[i + 3], 10, -1894986606)
      c = md5ii(c, d, a, b, x[i + 10], 15, -1051523)
      b = md5ii(b, c, d, a, x[i + 1], 21, -2054922799)
      a = md5ii(a, b, c, d, x[i + 8], 6, 1873313359)
      d = md5ii(d, a, b, c, x[i + 15], 10, -30611744)
      c = md5ii(c, d, a, b, x[i + 6], 15, -1560198380)
      b = md5ii(b, c, d, a, x[i + 13], 21, 1309151649)
      a = md5ii(a, b, c, d, x[i + 4], 6, -145523070)
      d = md5ii(d, a, b, c, x[i + 11], 10, -1120210379)
      c = md5ii(c, d, a, b, x[i + 2], 15, 718787259)
      b = md5ii(b, c, d, a, x[i + 9], 21, -343485551)

      a = safeAdd(a, olda)
      b = safeAdd(b, oldb)
      c = safeAdd(c, oldc)
      d = safeAdd(d, oldd)
    }
    return [a, b, c, d]
  }

  /**
   * Convert an array of little-endian words to a string
   *
   * @param {Array<number>} input MD5 Array
   * @returns {string} MD5 string
   */
  function binl2rstr(input) {
    var i
    var output = ''
    var length32 = input.length * 32
    for (i = 0; i < length32; i += 8) {
      output += String.fromCharCode((input[i >> 5] >>> i % 32) & 0xff)
    }
    return output
  }

  /**
   * Convert a raw string to an array of little-endian words
   * Characters >255 have their high-byte silently ignored.
   *
   * @param {string} input Raw input string
   * @returns {Array<number>} Array of little-endian words
   */
  function rstr2binl(input) {
    var i
    var output = []
    output[(input.length >> 2) - 1] = undefined
    for (i = 0; i < output.length; i += 1) {
      output[i] = 0
    }
    var length8 = input.length * 8
    for (i = 0; i < length8; i += 8) {
      output[i >> 5] |= (input.charCodeAt(i / 8) & 0xff) << i % 32
    }
    return output
  }

  /**
   * Calculate the MD5 of a raw string
   *
   * @param {string} s Input string
   * @returns {string} Raw MD5 string
   */
  function rstrMD5(s) {
    return binl2rstr(binlMD5(rstr2binl(s), s.length * 8))
  }

  /**
   * Calculates the HMAC-MD5 of a key and some data (raw strings)
   *
   * @param {string} key HMAC key
   * @param {string} data Raw input string
   * @returns {string} Raw MD5 string
   */
  function rstrHMACMD5(key, data) {
    var i
    var bkey = rstr2binl(key)
    var ipad = []
    var opad = []
    var hash
    ipad[15] = opad[15] = undefined
    if (bkey.length > 16) {
      bkey = binlMD5(bkey, key.length * 8)
    }
    for (i = 0; i < 16; i += 1) {
      ipad[i] = bkey[i] ^ 0x36363636
      opad[i] = bkey[i] ^ 0x5c5c5c5c
    }
    hash = binlMD5(ipad.concat(rstr2binl(data)), 512 + data.length * 8)
    return binl2rstr(binlMD5(opad.concat(hash), 512 + 128))
  }

  /**
   * Convert a raw string to a hex string
   *
   * @param {string} input Raw input string
   * @returns {string} Hex encoded string
   */
  function rstr2hex(input) {
    var hexTab = '0123456789abcdef'
    var output = ''
    var x
    var i
    for (i = 0; i < input.length; i += 1) {
      x = input.charCodeAt(i)
      output += hexTab.charAt((x >>> 4) & 0x0f) + hexTab.charAt(x & 0x0f)
    }
    return output
  }

  /**
   * Encode a string as UTF-8
   *
   * @param {string} input Input string
   * @returns {string} UTF8 string
   */
  function str2rstrUTF8(input) {
    return unescape(encodeURIComponent(input))
  }

  /**
   * Encodes input string as raw MD5 string
   *
   * @param {string} s Input string
   * @returns {string} Raw MD5 string
   */
  function rawMD5(s) {
    return rstrMD5(str2rstrUTF8(s))
  }
  /**
   * Encodes input string as Hex encoded string
   *
   * @param {string} s Input string
   * @returns {string} Hex encoded string
   */
  function hexMD5(s) {
    return rstr2hex(rawMD5(s))
  }
  /**
   * Calculates the raw HMAC-MD5 for the given key and data
   *
   * @param {string} k HMAC key
   * @param {string} d Input string
   * @returns {string} Raw MD5 string
   */
  function rawHMACMD5(k, d) {
    return rstrHMACMD5(str2rstrUTF8(k), str2rstrUTF8(d))
  }
  /**
   * Calculates the Hex encoded HMAC-MD5 for the given key and data
   *
   * @param {string} k HMAC key
   * @param {string} d Input string
   * @returns {string} Raw MD5 string
   */
  function hexHMACMD5(k, d) {
    return rstr2hex(rawHMACMD5(k, d))
  }

  /**
   * Calculates MD5 value for a given string.
   * If a key is provided, calculates the HMAC-MD5 value.
   * Returns a Hex encoded string unless the raw argument is given.
   *
   * @param {string} string Input string
   * @param {string} [key] HMAC key
   * @param {boolean} [raw] Raw output switch
   * @returns {string} MD5 output
   */
  function md5(string, key, raw) {
    if (!key) {
      if (!raw) {
        return hexMD5(string)
      }
      return rawMD5(string)
    }
    if (!raw) {
      return hexHMACMD5(key, string)
    }
    return rawHMACMD5(key, string)
  }

	ctx.md5 = md5
})(this)

/***/ }),

/***/ 944:
/***/ (() => {

/*! @license sprintf.js | Copyright (c) 2007-2013 Alexandru Marasteanu <hello at alexei dot ro> | 3 clause BSD license */

(function() {
   var ctx = this || globalThis;

	var sprintf = function() {
		if (!sprintf.cache.hasOwnProperty(arguments[0])) {
			sprintf.cache[arguments[0]] = sprintf.parse(arguments[0]);
		}
		return sprintf.format.call(null, sprintf.cache[arguments[0]], arguments);
	};

	sprintf.format = function(parse_tree, argv) {
		var cursor = 1, tree_length = parse_tree.length, node_type = '', arg, output = [], i, k, match, pad, pad_character, pad_length;
		for (i = 0; i < tree_length; i++) {
			node_type = get_type(parse_tree[i]);
			if (node_type === 'string') {
				output.push(parse_tree[i]);
			}
			else if (node_type === 'array') {
				match = parse_tree[i]; // convenience purposes only
				if (match[2]) { // keyword argument
					arg = argv[cursor];
					for (k = 0; k < match[2].length; k++) {
						if (!arg.hasOwnProperty(match[2][k])) {
							throw(sprintf('[sprintf] property "%s" does not exist', match[2][k]));
						}
						arg = arg[match[2][k]];
					}
				}
				else if (match[1]) { // positional argument (explicit)
					arg = argv[match[1]];
				}
				else { // positional argument (implicit)
					arg = argv[cursor++];
				}

				if (/[^s]/.test(match[8]) && (get_type(arg) != 'number')) {
					throw(sprintf('[sprintf] expecting number but found %s', get_type(arg)));
				}
				switch (match[8]) {
					case 'b': arg = arg.toString(2); break;
					case 'c': arg = String.fromCharCode(arg); break;
					case 'd': arg = parseInt(arg, 10); break;
					case 'e': arg = match[7] ? arg.toExponential(match[7]) : arg.toExponential(); break;
					case 'f': arg = match[7] ? parseFloat(arg).toFixed(match[7]) : parseFloat(arg); break;
					case 'o': arg = arg.toString(8); break;
					case 's': arg = ((arg = String(arg)) && match[7] ? arg.substring(0, match[7]) : arg); break;
					case 'u': arg = arg >>> 0; break;
					case 'x': arg = arg.toString(16); break;
					case 'X': arg = arg.toString(16).toUpperCase(); break;
				}
				arg = (/[def]/.test(match[8]) && match[3] && arg >= 0 ? '+'+ arg : arg);
				pad_character = match[4] ? match[4] == '0' ? '0' : match[4].charAt(1) : ' ';
				pad_length = match[6] - String(arg).length;
				pad = match[6] ? str_repeat(pad_character, pad_length) : '';
				output.push(match[5] ? arg + pad : pad + arg);
			}
		}
		return output.join('');
	};

	sprintf.cache = {};

	sprintf.parse = function(fmt) {
		var _fmt = fmt, match = [], parse_tree = [], arg_names = 0;
		while (_fmt) {
			if ((match = /^[^\x25]+/.exec(_fmt)) !== null) {
				parse_tree.push(match[0]);
			}
			else if ((match = /^\x25{2}/.exec(_fmt)) !== null) {
				parse_tree.push('%');
			}
			else if ((match = /^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt)) !== null) {
				if (match[2]) {
					arg_names |= 1;
					var field_list = [], replacement_field = match[2], field_match = [];
					if ((field_match = /^([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
						field_list.push(field_match[1]);
						while ((replacement_field = replacement_field.substring(field_match[0].length)) !== '') {
							if ((field_match = /^\.([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else if ((field_match = /^\[(\d+)\]/.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else {
								throw('[sprintf] huh?');
							}
						}
					}
					else {
						throw('[sprintf] huh?');
					}
					match[2] = field_list;
				}
				else {
					arg_names |= 2;
				}
				if (arg_names === 3) {
					throw('[sprintf] mixing positional and named placeholders is not (yet) supported');
				}
				parse_tree.push(match);
			}
			else {
				throw('[sprintf] huh?');
			}
			_fmt = _fmt.substring(match[0].length);
		}
		return parse_tree;
	};

	var vsprintf = function(fmt, argv, _argv) {
		_argv = argv.slice(0);
		_argv.splice(0, 0, fmt);
		return sprintf.apply(null, _argv);
	};

	/**
	 * helpers
	 */
	function get_type(variable) {
		return Object.prototype.toString.call(variable).slice(8, -1).toLowerCase();
	}

	function str_repeat(input, multiplier) {
		for (var output = []; multiplier > 0; output[--multiplier] = input) {/* do nothing */}
		return output.join('');
	}

	/**
	 * export to either browser or node.js
	 */
	ctx.sprintf = sprintf;
	ctx.vsprintf = vsprintf;
})();



/***/ }),

/***/ 891:
/***/ (() => {

/*
 * Copyright 2014-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
(function () {
  var global = this || globalThis;
  var connect = global.connect || {};
  global.connect = connect;
  global.lily = connect;

  var userAgent = navigator.userAgent;
  var ONE_DAY_MILLIS = 24 * 60 * 60 * 1000;
  var DEFAULT_POPUP_HEIGHT = 578;
  var DEFAULT_POPUP_WIDTH = 433;
  var COPYABLE_EVENT_FIELDS = ["bubbles", "cancelBubble", "cancelable", "composed", "data", "defaultPrevented", "eventPhase", "isTrusted", "lastEventId", "origin", "returnValue", "timeStamp", "type"];

  /**
   * Unpollute sprintf functions from the global namespace.
   */
  connect.sprintf = global.sprintf;
  connect.vsprintf = global.vsprintf;
  delete global.sprintf;
  delete global.vsprintf;

  connect.HTTP_STATUS_CODES = {
    SUCCESS: 200,
    TOO_MANY_REQUESTS: 429,
    INTERNAL_SERVER_ERROR: 500
  };

  connect.TRANSPORT_TYPES = {
    CHAT_TOKEN: "chat_token",
    WEB_SOCKET: "web_socket"
  };

  /**
   * Binds the given instance object as the context for
   * the method provided.
   *
   * @param scope The instance object to be set as the scope
   *    of the function.
   * @param method The method to be encapsulated.
   *
   * All other arguments, if any, are bound to the method
   * invocation inside the closure.
   *
   * @return A closure encapsulating the invocation of the
   *    method provided in context of the given instance.
   */
  connect.hitch = function () {
    var args = Array.prototype.slice.call(arguments);
    var scope = args.shift();
    var method = args.shift();

    connect.assertNotNull(scope, 'scope');
    connect.assertNotNull(method, 'method');
    connect.assertTrue(connect.isFunction(method), 'method must be a function');

    return function () {
      var closureArgs = Array.prototype.slice.call(arguments);
      return method.apply(scope, args.concat(closureArgs));
    };
  };

  /**
   * Determine if the given value is a callable function type.
   * Borrowed from Underscore.js.
   */
  connect.isFunction = function (obj) {
    return !!(obj && obj.constructor && obj.call && obj.apply);
  };

  /**
   * Determine if the given value is an array.
   */
  connect.isArray = function (obj) {
    return Object.prototype.toString.call(obj) === '[object Array]';
  };

  /**
   * Get a list of keys from a Javascript object used
   * as a hash map.
   */
  connect.keys = function (map) {
    var keys = [];

    connect.assertNotNull(map, 'map');

    for (var k in map) {
      keys.push(k);
    }

    return keys;
  };

  /**
   * Get a list of values from a Javascript object used
   * as a hash map.
   */
  connect.values = function (map) {
    var values = [];

    connect.assertNotNull(map, 'map');

    for (var k in map) {
      values.push(map[k]);
    }

    return values;
  };

  /**
   * Get a list of key/value pairs from the given map.
   */
  connect.entries = function (map) {
    var entries = [];

    for (var k in map) {
      entries.push({ key: k, value: map[k] });
    }

    return entries;
  };

  /**
   * Merge two or more maps together into a new map,
   * or simply copy a single map.
   */
  connect.merge = function () {
    var argMaps = Array.prototype.slice.call(arguments, 0);
    var resultMap = {};

    argMaps.forEach(function (map) {
      connect.entries(map).forEach(function (kv) {
        resultMap[kv.key] = kv.value;
      });
    });

    return resultMap;
  };

  connect.now = function () {
    return new Date().getTime();
  };

  connect.find = function (array, predicate) {
    for (var x = 0; x < array.length; x++) {
      if (predicate(array[x])) {
        return array[x];
      }
    }

    return null;
  };

  connect.contains = function (obj, value) {
    if (obj instanceof Array) {
      return connect.find(obj, function (v) { return v === value; }) != null;

    } else {
      return (value in obj);
    }
  };

  connect.containsValue = function (obj, value) {
    if (obj instanceof Array) {
      return connect.find(obj, function (v) { return v === value; }) != null;

    } else {
      return connect.find(connect.values(obj), function (v) { return v === value; }) != null;
    }
  };

  /**
   * Generate a random ID consisting of the current timestamp
   * and a random base-36 number based on Math.random().
   */
  connect.randomId = function () {
    return connect.sprintf("%s-%s", connect.now(), Math.random().toString(36).slice(2));
  };

  /**
   * Generate an enum from the given list of lower-case enum values,
   * where the enum keys will be upper case.
   *
   * Conversion from pascal case based on code from here:
   * http://stackoverflow.com/questions/30521224
   */
  connect.makeEnum = function (values) {
    var enumObj = {};

    values.forEach(function (value) {
      var key = value.replace(/\.?([a-z]+)_?/g, function (x, y) { return y.toUpperCase() + "_"; })
        .replace(/_$/, "");

      enumObj[key] = value;
    });

    return enumObj;
  };

  connect.makeNamespacedEnum = function (prefix, values) {
    var enumObj = connect.makeEnum(values);
    connect.keys(enumObj).forEach(function (key) {
      enumObj[key] = connect.sprintf("%s::%s", prefix, enumObj[key]);
    });
    return enumObj;
  };

  connect.makeGenericNamespacedEnum = function (prefix, values, delimiter) {
    var enumObj = connect.makeEnum(values);
    connect.keys(enumObj).forEach(function (key) {
      enumObj[key] = connect.sprintf("%s"+delimiter+"%s", prefix, enumObj[key]);
    });
    return enumObj;
  };

  /**
  * Methods to determine browser type and versions, used for softphone initialization.
  */
  connect.isChromeBrowser = function () {
    return userAgent.indexOf("Chrome") !== -1;
  };

  connect.isFirefoxBrowser = function () {
    return userAgent.indexOf("Firefox") !== -1;
  };

  connect.isOperaBrowser = function () {
    return userAgent.indexOf("Opera") !== -1;
  };

  connect.getChromeBrowserVersion = function () {
    var chromeVersion = userAgent.substring(userAgent.indexOf("Chrome") + 7);
    if (chromeVersion) {
      return parseFloat(chromeVersion);
    } else {
      return -1;
    }
  };

  connect.getFirefoxBrowserVersion = function () {
    var firefoxVersion = userAgent.substring(userAgent.indexOf("Firefox") + 8);
    if (firefoxVersion) {
      return parseFloat(firefoxVersion);
    } else {
      return -1;
    }
  };

  connect.isValidLocale = function (locale) {
    var languages = [
      {
        id: 'en_US',
        label: 'English'
      },
      {
        id: 'de_DE',
        label: 'Deutsch'
      },
      {
        id: 'es_ES',
        label: 'Español'
      },
      {
        id: 'fr_FR',
        label: 'Français'
      },
      {
        id: 'ja_JP',
        label: '日本語'
      },
      {
        id: 'it_IT',
        label: 'Italiano'
      },
      {
        id: 'ko_KR',
        label: '한국어'
      },
      {
        id: 'pt_BR',
        label: 'Português'
      },
      {
        id: 'zh_CN',
        label: '中文(简体)'
      },
      {
        id: 'zh_TW',
        label: '中文(繁體)'
      }
    ];
    return languages.map(function(language){ return language.id}).includes(locale);
  }

  connect.getOperaBrowserVersion = function () {
    var versionOffset = userAgent.indexOf("Opera");
    var operaVersion = (userAgent.indexOf("Version") !== -1) ? userAgent.substring(versionOffset + 8) : userAgent.substring(versionOffset + 6);
    if (operaVersion) {
      return parseFloat(operaVersion);
    } else {
      return -1;
    }
  };

  /**
   * Return a map of items in the given list indexed by
   * keys determined by the closure provided.
   *
   * @param iterable A list-like object.
   * @param closure A closure to determine the index for the
   *    items in the iterable.
   * @return A map from index to item for each item in the iterable.
   */
  connect.index = function (iterable, closure) {
    var map = {};

    iterable.forEach(function (item) {
      map[closure(item)] = item;
    });

    return map;
  };

  /**
   * Converts the given array into a map as a set,
   * where elements in the array are mapped to 1.
   */
  connect.set = function (arrayIn) {
    var setMap = {};

    arrayIn.forEach(function (key) {
      setMap[key] = 1;
    });

    return setMap;
  };

  /**
   * Returns a map for each key in mapB which
   * is NOT in mapA.
   */
  connect.relativeComplement = function (mapA, mapB) {
    var compMap = {};

    connect.keys(mapB).forEach(function (key) {
      if (!(key in mapA)) {
        compMap[key] = mapB[key];
      }
    });

    return compMap;
  };

  /**
   * Asserts that a premise is true.
   */
  connect.assertTrue = function (premise, message) {
    if (!premise) {
      throw new connect.ValueError(message);
    }
  };

  /**
   * Asserts that a value is not null or undefined.
   */
  connect.assertNotNull = function (value, name) {
    connect.assertTrue(value != null && typeof value !== undefined,
      connect.sprintf("%s must be provided", name || 'A value'));
    return value;
  };

  connect.deepcopy = function (src) {
    return JSON.parse(JSON.stringify(src));
  };

  connect.deepcopyCrossOriginEvent = function(event) {
    const obj = {};
    const listOfAcceptableKeys = COPYABLE_EVENT_FIELDS;
    listOfAcceptableKeys.forEach((key) => {
      try {
        obj[key] = event[key];
      }
      catch(e) {
        connect.getLog().info("deepcopyCrossOriginEvent failed on key: ", key).sendInternalLogToServer();
      }
    });
    return connect.deepcopy(obj);
  }

  /**
   * Get the current base url of the open page, e.g. if the page is
   * https://example.com:9494/oranges, this will be "https://example.com:9494".
   */
  connect.getBaseUrl = function () {
    var location = global.location;
    return connect.sprintf("%s//%s:%s", location.protocol, location.hostname, location.port);
  };

  connect.getUrlWithProtocol = function(url) {
    var protocol = global.location.protocol;
    if (url.substr(0, protocol.length) !== protocol) {
      return connect.sprintf("%s//%s", protocol, url);
    }
    return url;
  }

  /**
   * Determine if the current window is in an iframe.
   * Courtesy: http://stackoverflow.com/questions/326069/
   */
  connect.isFramed = function () {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  };

  connect.hasOtherConnectedCCPs = function () {
    return connect.numberOfConnectedCCPs > 1;
  }

  connect.fetch = function (endpoint, options, milliInterval, maxRetry) {
    maxRetry = maxRetry || 5;
    milliInterval = milliInterval || 1000;
    options = options || {};
    return new Promise(function (resolve, reject) {
      function fetchData(maxRetry) {
        fetch(endpoint, options).then(function (res) {
          if (res.status === connect.HTTP_STATUS_CODES.SUCCESS) {
            res.json().then(json => resolve(json)).catch(() => resolve({}));
          } else if (maxRetry !== 1 && (res.status >= connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR || res.status === connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)) {
            setTimeout(function () {
              fetchData(--maxRetry);
            }, milliInterval);
          } else {
            reject(res);
          }
        }).catch(function (e) {
          reject(e);
        });
      }
      fetchData(maxRetry);
    });
  };

  /**
   * Calling a function with exponential backoff with full jitter retry strategy
   * It will retry calling the function for maximum maxRetry times if it fails.
   * Success callback will be called if the function succeeded.
   * Failure callback will be called only if the last try failed.
   */
  connect.backoff = function (func, milliInterval, maxRetry, callbacks) {
    connect.assertTrue(connect.isFunction(func), "func must be a Function");
    var self = this;
    var ratio = 2;

    func({
      success: function (data) {
        if (callbacks && callbacks.success) {
          callbacks.success(data);
        }
      },
      failure: function (err, data) {
        if (maxRetry > 0) {
          var interval = milliInterval * 2 * Math.random();
          global.setTimeout(function () {
            self.backoff(func, interval * ratio, --maxRetry, callbacks);
          }, interval);
        } else {
          if (callbacks && callbacks.failure) {
            callbacks.failure(err, data);
          }
        }
      }
    });
  };

  connect.publishMetric = function (metricData) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.CLIENT_METRIC,
      data: metricData
    });
  };

  connect.publishSoftphoneStats = function(stats) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.SOFTPHONE_STATS,
      data: stats
    });
  };

  connect.publishSoftphoneReport = function(report) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.SOFTPHONE_REPORT,
      data: report
    });
  };

  connect.publishClickStreamData = function(report) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.CLICK_STREAM_DATA,
      data: report
    });
  };

  connect.publishClientSideLogs = function(logs) {
    var bus = connect.core.getEventBus();
    bus.trigger(connect.EventType.CLIENT_SIDE_LOGS, logs);
  };

  connect.addNamespaceToLogs = function(namespace) {
    const methods = ['log', 'error', 'warn', 'info', 'debug'];

    methods.forEach((method) => {
      const consoleMethod = window.console[method];
      window.console[method] = function () {
        const args = Array.from(arguments);
        args.unshift(`[${namespace}]`);
        consoleMethod.apply(window.console, args);
      };
    });
  };

  /**
   * A wrapper around Window.open() for managing single instance popups.
   */
  connect.PopupManager = function () { };

  connect.PopupManager.prototype.open = function (url, name, options) {
    var then = this._getLastOpenedTimestamp(name);
    var now = new Date().getTime();
    var win = null;
    if (now - then > ONE_DAY_MILLIS) {
      if (options) {
        // default values are chosen to provide a minimum height without scrolling
        // and a uniform margin based on the css of the ccp login page
        var height = options.height || DEFAULT_POPUP_HEIGHT;
        var width = options.width || DEFAULT_POPUP_WIDTH;
        var top = options.top || 0;
        var left = options.left || 0;
        win = window.open('', name, "width="+width+", height="+height+", top="+top+", left="+left);
        if (win.location !== url) {
          win = window.open(url, name, "width="+width+", height="+height+", top="+top+", left="+left);
        }
      } else {
        win = window.open('', name);
        if (win.location !== url) {
          win = window.open(url, name);
        }
      }
      this._setLastOpenedTimestamp(name, now);
    }
    return win;
  };

  connect.PopupManager.prototype.clear = function (name) {
    var key = this._getLocalStorageKey(name);
    global.localStorage.removeItem(key);
  };

  connect.PopupManager.prototype._getLastOpenedTimestamp = function (name) {
    var key = this._getLocalStorageKey(name);
    var value = global.localStorage.getItem(key);

    if (value) {
      return parseInt(value, 10);

    } else {
      return 0;
    }
  };

  connect.PopupManager.prototype._setLastOpenedTimestamp = function (name, ts) {
    var key = this._getLocalStorageKey(name);
    global.localStorage.setItem(key, '' + ts);
  };

  connect.PopupManager.prototype._getLocalStorageKey = function (name) {
    return "connectPopupManager::" + name;
  };

  /**
   * An enumeration of the HTML5 notification permission values.
   */
  var NotificationPermission = connect.makeEnum([
    'granted',
    'denied',
    'default'
  ]);

  /**
   * A simple engine for showing notification popups.
   */
  connect.NotificationManager = function () {
    this.queue = [];
    this.permission = NotificationPermission.DEFAULT;
  };

  connect.NotificationManager.prototype.requestPermission = function () {
    var self = this;
    if (!("Notification" in global)) {
      connect.getLog().warn("This browser doesn't support notifications.").sendInternalLogToServer();
      this.permission = NotificationPermission.DENIED;

    } else if (global.Notification.permission === NotificationPermission.DENIED) {
      connect.getLog().warn("The user has requested to not receive notifications.").sendInternalLogToServer();
      this.permission = NotificationPermission.DENIED;

    } else if (this.permission !== NotificationPermission.GRANTED) {
      global.Notification.requestPermission().then(function (permission) {
        self.permission = permission;
        if (permission === NotificationPermission.GRANTED) {
          self._showQueued();

        } else {
          self.queue = [];
        }
      });
    }
  };

  connect.NotificationManager.prototype.show = function (title, options) {
    if (this.permission === NotificationPermission.GRANTED) {
      return this._showImpl({ title: title, options: options });

    } else if (this.permission === NotificationPermission.DENIED) {
      connect.getLog().warn("Unable to show notification.")
        .sendInternalLogToServer()
        .withObject({
          title: title,
          options: options
        });

    } else {
      var params = { title: title, options: options };
      connect.getLog().warn("Deferring notification until user decides to allow or deny.")
        .withObject(params)
        .sendInternalLogToServer();
      this.queue.push(params);
    }
  };

  connect.NotificationManager.prototype._showQueued = function () {
    var self = this;
    var notifications = this.queue.map(function (params) {
      return self._showImpl(params);
    });
    this.queue = [];
    return notifications;
  };

  connect.NotificationManager.prototype._showImpl = function (params) {
    var notification = new global.Notification(params.title, params.options);
    if (params.options.clicked) {
      notification.onclick = function () {
        params.options.clicked.call(notification);
      };
    }
    return notification;
  };

  connect.ValueError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.ValueError.prototype);
    return instance; 
  };
  Object.setPrototypeOf(connect.ValueError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.ValueError, Error);
  connect.ValueError.prototype.name = 'ValueError';

  connect.NotImplementedError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.NotImplementedError.prototype);
    return instance; 
  };
  Object.setPrototypeOf(connect.NotImplementedError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.NotImplementedError, Error);
  connect.NotImplementedError.prototype.name = 'NotImplementedError';

  connect.StateError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.StateError.prototype);
    return instance; 
  }
  Object.setPrototypeOf(connect.StateError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.StateError, Error);
  connect.StateError.prototype.name = 'StateError';



  connect.VoiceIdError = function(type, message, err){
    var error = {};
    error.type = type;
    error.message = message;
    error.stack = Error(message).stack;
    error.err = err;
    return error;
  }

  // internal use only
  connect.isCCP = function () {
    var conduit = connect.core.getUpstream();
    return conduit.name === 'ConnectSharedWorkerConduit';
  }

})();


<<<<<<< HEAD
/***/ })
=======
// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
(() => {
/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
 
(function () {
  var global = this;
  connect = global.connect || {};
  global.connect = connect;
  global.globalConnect = {}
  global.lily = connect;

  globalConnect.Container = null;

  var FRAME_DIMENSIONS = "margin: 0; border: 0; padding: 0px; width: 0px; height: 0px";

  var LATEST_STREAMJS_BASE64_CODE = "LyoqKioqKi8gKCgpID0+IHsgLy8gd2VicGFja0Jvb3RzdHJhcAovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVzX18gPSAoewoKLyoqKi8gODIxOgovKioqLyAoKCkgPT4gewoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5hZ2VudEFwcCA9IHt9OwoKICB2YXIgQVBQID0gewogICAgQ0NQOiAnY2NwJywKICB9OwoKICBjb25uZWN0LmFnZW50QXBwLmluaXRDQ1AgPSBjb25uZWN0LmNvcmUuaW5pdENDUDsKICBjb25uZWN0LmFnZW50QXBwLmlzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoaW5zdGFuY2VBbGlhcykge307CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcENvbW11bmljYXRpb24gPSBmdW5jdGlvbiAoaWZyYW1lSWQsIGVuZHBvaW50KSB7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWZyYW1lSWQpOwogICAgdmFyIGlmcmFtZUNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KGVuZHBvaW50LCB3aW5kb3csIGlmcmFtZSk7CiAgICB2YXIgQlJPQURDQVNUX1RZUEUgPSBbCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsCiAgICAgIGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsCiAgICAgIGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVECiAgICBdOwogICAgaWZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoZSkgewogICAgICBCUk9BRENBU1RfVFlQRS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbSh0eXBlLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWZyYW1lQ29uZHVpdC5zZW5kVXBzdHJlYW0odHlwZSwgZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIGdldENvbm5lY3RVcmwgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgcG9zID0gY2NwVXJsLmluZGV4T2YoJ2NjcC12MicpOwogICAgcmV0dXJuIGNjcFVybC5zbGljZSgwLCBwb3MgLSAxKTsKICB9OwoKICB2YXIgc2lnbk91dFRocm91Z2hDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgbG9nb3V0VXJsID0gZ2V0Q29ubmVjdFVybChjY3BVcmwpICsgJy9sb2dvdXQnOwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2gobG9nb3V0VXJsLCB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGV2ZW50QnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25uZWN0CiAgICAgICAgLmdldExvZygpCiAgICAgICAgLmVycm9yKCdBbiBlcnJvciBvY2N1cmVkIG9uIGxvZ291dC4nICsgZSkKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBsb2dvdXRVcmw7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogIH07CgogIHZhciBzaWduSW5UaHJvdWdoaW5pdENDUCA9IGZ1bmN0aW9uIChjY3BVcmwsIGNvbnRhaW5lciwgY29uZmlnKSB7CiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgY2NwVXJsOiBjY3BVcmwsCiAgICAgIGNjcExvYWRUaW1lb3V0OiAxMDAwMCwKICAgICAgbG9naW5Qb3B1cDogdHJ1ZSwKICAgICAgbG9naW5Vcmw6IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9naW4nLAogICAgICBzb2Z0cGhvbmU6IHsKICAgICAgICBhbGxvd0ZyYW1lZFNvZnRwaG9uZTogdHJ1ZSwKICAgICAgICBkaXNhYmxlUmluZ3RvbmU6IGZhbHNlLAogICAgICB9CiAgICB9OwogICAgdmFyIGNjcFBhcmFtcyA9IGNvbm5lY3QubWVyZ2UoZGVmYXVsdFBhcmFtcywgY29uZmlnLmNjcFBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENDUChjb250YWluZXIsIGNjcFBhcmFtcyk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwID0gZnVuY3Rpb24gKG5hbWUsIGNvbnRhaW5lcklkLCBhcHBVcmwsIGNvbmZpZykgewogICAgY29uZmlnID0gY29uZmlnID8gY29uZmlnIDoge307CiAgICB2YXIgZW5kcG9pbnQgPSBhcHBVcmwuZW5kc1dpdGgoJy8nKSA/IGFwcFVybCA6IGFwcFVybCArICcvJzsKICAgIHZhciBvbkxvYWQgPSBjb25maWcub25Mb2FkID8gY29uZmlnLm9uTG9hZCA6IG51bGw7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSwgb25Mb2FkOiBvbkxvYWQgfTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgcmVnaXN0ZXJDb25maWcsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKSk7CiAgICBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0YXJ0KG5hbWUsIGZ1bmN0aW9uIChtb2R1bGVEYXRhKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGEuZW5kcG9pbnQ7CiAgICAgIHZhciBjb250YWluZXJET00gPSBtb2R1bGVEYXRhLmNvbnRhaW5lckRPTTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgewogICAgICAgICAgICBjb25maWcuY2NwUGFyYW1zID0gY29uZmlnLmNjcFBhcmFtcyA/IGNvbmZpZy5jY3BQYXJhbXMgOiB7fTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5zdHlsZSkgY29uZmlnLmNjcFBhcmFtcy5zdHlsZSA9IGNvbmZpZy5zdHlsZTsKICAgICAgICAgICAgcmV0dXJuIHNpZ25JblRocm91Z2hpbml0Q0NQKGVuZHBvaW50LCBjb250YWluZXJET00sIGNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbihuYW1lLCBlbmRwb2ludCk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25PdXRUaHJvdWdoQ0NQKGVuZHBvaW50KTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuc3RvcEFwcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5zdG9wKG5hbWUpOwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA1MDA6Ci8qKiovICgoKSA9PiB7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGZ1bmN0aW9uIEFwcFJlZ2lzdHJ5KCkgewogICAgdmFyIG1vZHVsZURhdGEgPSB7fTsKICAgIHZhciBtYWtlQXBwSWZyYW1lID0gZnVuY3Rpb24gKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgICBvbkxvYWQ6IGNvbmZpZy5vbkxvYWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICB2YXIgb25Mb2FkID0gbW9kdWxlRGF0YVthcHBOYW1lXS5vbkxvYWQ7CiAgICAgICAgaWYgKGFwcE5hbWUgIT09IEFQUC5DQ1ApIHsKICAgICAgICAgIHZhciBhcHAgPSBtYWtlQXBwSWZyYW1lKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTY1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0ludmFsaWRMb2NhbGUnLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcKICBdKTsKICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0dXNUeXBlID0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3Quc2V0KFsKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xECiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgICAnZGlzY29ubmVjdCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ29udGFjdFJlY29yZGluZyBWb2ljZSBUcmFjayBjb25maWcKICAgKi8KICBjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnQUxMJywKICAgICdUT19BR0VOVCcsCiAgICAnRlJPTV9BR0VOVCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgTW9uaXRvcmluZ01vZGUKICAgKi8KICBjb25uZWN0Lk1vbml0b3JpbmdNb2RlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnU0lMRU5UX01PTklUT1InLAogICAgJ0JBUkdFJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBNb25pdG9yaW5nRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuTW9uaXRvcmluZ0Vycm9yVHlwZXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbnZhbGlkX3RhcmdldF9zdGF0ZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENoYW5uZWxUeXBlCiAgKi8KICBjb25uZWN0LkNoYW5uZWxUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnVk9JQ0UnLAogICAgJ0NIQVQnLAogICAgJ1RBU0snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBNZWRpYVR5cGUKICAqLwogIGNvbm5lY3QuTWVkaWFUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnc29mdHBob25lJywKICAgICdjaGF0JywKICAgICd0YXNrJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNvZnRwaG9uZUNhbGxUeXBlCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2F1ZGlvX3ZpZGVvJywKICAgICd2aWRlb19vbmx5JywKICAgICdhdWRpb19vbmx5JywKICAgICdub25lJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBTb2Z0cGhvbmVFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndW5zdXBwb3J0ZWRfYnJvd3NlcicsCiAgICAnbWljcm9waG9uZV9ub3Rfc2hhcmVkJywKICAgICdzaWduYWxsaW5nX2hhbmRzaGFrZV9mYWlsdXJlJywKICAgICdzaWduYWxsaW5nX2Nvbm5lY3Rpb25fZmFpbHVyZScsCiAgICAnaWNlX2NvbGxlY3Rpb25fdGltZW91dCcsCiAgICAndXNlcl9idXN5X2Vycm9yJywKICAgICd3ZWJydGNfZXJyb3InLAogICAgJ3JlYWx0aW1lX2NvbW11bmljYXRpb25fZXJyb3InLAogICAgJ290aGVyJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDbGlja1R5cGUKICAgKi8KICBjb25uZWN0LkNsaWNrVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ0FjY2VwdCcsCiAgICAnUmVqZWN0JywKICAgICdIYW5ndXAnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWRFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ25vX3NwZWFrZXJfaWRfZm91bmQnLAogICAgJ3NwZWFrZXJfaWRfbm90X2Vucm9sbGVkJywKICAgICdnZXRfc3BlYWtlcl9pZF9mYWlsZWQnLAogICAgJ2dldF9zcGVha2VyX3N0YXR1c19mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9pbl9sY21zX2ZhaWxlZCcsCiAgICAnZGVsZXRlX3NwZWFrZXJfZmFpbGVkJywKICAgICdzdGFydF9zZXNzaW9uX2ZhaWxlZCcsCiAgICAnZXZhbHVhdGVfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3Nlc3Npb25fbm90X2V4aXN0cycsCiAgICAnZGVzY3JpYmVfc2Vzc2lvbl9mYWlsZWQnLAogICAgJ2Vucm9sbF9zcGVha2VyX2ZhaWxlZCcsCiAgICAndXBkYXRlX3NwZWFrZXJfaWRfZmFpbGVkJywKICAgICd1cGRhdGVfc3BlYWtlcl9pZF9pbl9sY21zX2ZhaWxlZCcsCiAgICAnbm90X3N1cHBvcnRlZF9vbl9jb25mZXJlbmNlX2NhbGxzJywKICAgICdlbnJvbGxfc3BlYWtlcl90aW1lb3V0JywKICAgICdldmFsdWF0ZV9zcGVha2VyX3RpbWVvdXQnLAogICAgJ2dldF9kb21haW5faWRfZmFpbGVkJywKICAgICdub19kb21haW5faWRfZm91bmQnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIENUSSBleGNlcHRpb25zCiAgICovCiAgY29ubmVjdC5DVElFeGNlcHRpb25zID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQWNjZXNzRGVuaWVkRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkU3RhdGVFeGNlcHRpb24iLAogICAgIkJhZEVuZHBvaW50RXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQWdlbnRBUk5FeGNlcHRpb24iLAogICAgIkludmFsaWRDb25maWd1cmF0aW9uRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQ29udGFjdFR5cGVFeGNlcHRpb24iLAogICAgIlBhZ2luYXRpb25FeGNlcHRpb24iLAogICAgIlJlZnJlc2hUb2tlbkV4cGlyZWRFeGNlcHRpb24iLAogICAgIlNlbmREYXRhRmFpbGVkRXhjZXB0aW9uIiwKICAgICJVbmF1dGhvcml6ZWRFeGNlcHRpb24iLAogICAgIlF1b3RhRXhjZWVkZWRFeGNlcHRpb24iCiAgXSk7CiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBzdHJlYW1pbmcgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiT05HT0lORyIsCiAgICAiRU5ERUQiLAogICAgIlBFTkRJTkdfQ09ORklHVVJBVElPTiIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBQ0NFUFQiLAogICAgIlJFSkVDVCIsCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIlNQRUFLRVJfTk9UX0VOUk9MTEVEIiwKICAgICJTUEVBS0VSX09QVEVEX09VVCIsCiAgICAiU1BFQUtFUl9JRF9OT1RfUFJPVklERUQiLAogICAgIlNQRUFLRVJfRVhQSVJFRCIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBmcmF1ZCBkZXRlY3Rpb24gZGVjaXNpb24KICAgKi8KICBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIkhJR0hfUklTSyIsCiAgICAiTE9XX1JJU0siCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIGNvbnRhY3QgZmxvdyBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQXV0aGVudGljYXRlZCIsCiAgICAiTm90QXV0aGVudGljYXRlZCIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbnJvbGxlZCIsCiAgICAiT3B0ZWRPdXQiLAogICAgIk5vdEVuYWJsZWQiLAogICAgIkVycm9yIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgIGZyYXVkIGRldGVjdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiSGlnaFJpc2siLAogICAgIkxvd1Jpc2siLAogICAgIkluY29uY2x1c2l2ZSIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgRW5yb2xsbWVudFJlcXVlc3QgU3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSU5fUFJPR1JFU1MiLAogICAgIkNPTVBMRVRFRCIsCiAgICAiRkFJTEVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIFNwZWFrZXIgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9QVEVEX09VVCIsCiAgICAiRU5ST0xMRUQiLAogICAgIlBFTkRJTkciCiAgXSk7CgogIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cyA9IHsKICAgIEVWQUxVQVRFX1NFU1NJT05fREVMQVk6IDEwMDAwLAogICAgRVZBTFVBVElPTl9NQVhfUE9MTF9USU1FUzogMjQsIC8vIEV2YWx1YXRlU3BlYWtlciBpcyBQb2xsaW5nIGZvciBtYXhpbXVtIDIgbWlucy4KICAgIEVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTDogNTAwMCwKICAgIEVOUk9MTE1FTlRfTUFYX1BPTExfVElNRVM6IDEyMCwgLy8gRW5yb2xsbWVudFNwZWFrZXIgaXMgUG9sbGluZyBmb3IgbWF4aW11bSAxMCBtaW5zLgogICAgRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMOiA1MDAwLAogICAgU1RBUlRfU0VTU0lPTl9ERUxBWTogODAwMAogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29uc3RhbnRzIGZvciBBZ2VudFBlcm1pc3Npb25zCiAgICovCiAgY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zID0gewogICAgT1VUQk9VTkRfQ0FMTDogJ291dGJvdW5kQ2FsbCcsCiAgICBWT0lDRV9JRDogJ3ZvaWNlSWQnLAogICAgQ09OVEFDVF9SRUNPUkRJTkc6ICdjb250YWN0UmVjb3JkaW5nJwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50CiAgICovCiAgdmFyIEFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoIlRoZSBhZ2VudCBpcyBub3QgeWV0IGluaXRpYWxpemVkISIpOwogICAgfQogIH07CgogIEFnZW50LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2NyZWF0ZUNvbnRhY3RBUEkgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUmVmcmVzaCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUm91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Ob3RSb3V0YWJsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25PZmZsaW5lID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNvZnRwaG9uZUVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25HYWluZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25BZnRlckNhbGxXb3JrID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1csIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Mb2NhbE1lZGlhU3RyZWFtQ3JlYXRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNwZWFrZXJEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbk1pY3JvcGhvbmVEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vblJpbmdlckRldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5zdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmV4dFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5uZXh0U3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEF2YWlsYWJpbGl0eVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5hZ2VudEF2YWlsYWJpbGl0eVN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc25hcHNob3Quc3RhdGUuc3RhcnRUaW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQWdlbnQucHJvdG90eXBlLmdldFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnBlcm1pc3Npb25zOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb250YWN0cyA9IGZ1bmN0aW9uIChjb250YWN0VHlwZUZpbHRlcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5jb250YWN0cy5tYXAoZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVDb250YWN0QVBJKGNvbnRhY3REYXRhKTsKICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gKCFjb250YWN0VHlwZUZpbHRlcikgfHwgY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbnRhY3RUeXBlRmlsdGVyOwogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbmZpZ3VyYXRpb247CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFnZW50U3RhdGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmFnZW50U3RhdGVzOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5ID0gZnVuY3Rpb24gKGNoYW5uZWwpIHsKICAgIHZhciBjaGFubmVsQ29uY3VycmVuY3lNYXAgPSB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuY2hhbm5lbENvbmN1cnJlbmN5TWFwOwogICAgaWYgKCFjaGFubmVsQ29uY3VycmVuY3lNYXApIHsKICAgICAgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gT2JqZWN0LmtleXMoY29ubmVjdC5DaGFubmVsVHlwZSkucmVkdWNlKGZ1bmN0aW9uIChhY2MsIGtleSkgewogICAgICAgIC8vIEV4Y2x1ZGUgVEFTSyBmcm9tIGRlZmF1bHQgY29uY3VycmVuY3kuCiAgICAgICAgaWYgKGtleSAhPT0gJ1RBU0snKSB7CiAgICAgICAgICBhY2NbY29ubmVjdC5DaGFubmVsVHlwZVtrZXldXSA9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhY2M7CiAgICAgIH0sIHt9KTsKICAgIH0KICAgIHJldHVybiBjaGFubmVsCiAgICAgID8gKGNoYW5uZWxDb25jdXJyZW5jeU1hcFtjaGFubmVsXSB8fCAwKQogICAgICA6IGNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5uYW1lOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFeHRlbnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZXh0ZW5zaW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXREaWFsYWJsZUNvdW50cmllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5kaWFsYWJsZUNvdW50cmllczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuaXNTb2Z0cGhvbmVFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUVuYWJsZWQ7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgaWYgKGNvbmZpZ3VyYXRpb24gJiYgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzICYmIGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRSAmJiAhY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSkgewogICAgICAvLyB3b3JrYXJvdW5kIGZvciB0aGUgaW5jb25zaXN0ZW5jeSBpc3N1ZSB0aGF0IGdldEFnZW50Q29uZmlndXJhdGlvbiByZXR1cm5zIGFnZW50UHJlZmVyZW5jZXMuTEFOR1VBR0UgYnV0IHVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiBleHBlY3RzIGFnZW50UHJlZmVyZW5jZXMubG9jYWxlIHRvIGJlIHNldC4KICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSA9IGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRTsKICAgIH0KCiAgICBpZiAoY29uZmlndXJhdGlvbiAmJiBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMgJiYgIWNvbm5lY3QuaXNWYWxpZExvY2FsZShjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMubG9jYWxlKSkgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzLklOVkFMSURfTE9DQUxFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OLCB7CiAgICAgICAgY29uZmlndXJhdGlvbjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmZpZ3VyYXRpb24sICdjb25maWd1cmF0aW9uJykKICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBhc2sgdGhlIHNoYXJlZCB3b3JrZXIgdG8gcmVsb2FkIGFnZW50IGNvbmZpZwogICAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjYWxsYmFja3MsIG9wdGlvbnMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUFVUX0FHRU5UX1NUQVRFLCB7CiAgICAgIHN0YXRlOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3RhdGUsICdzdGF0ZScpLAogICAgICBlbnF1ZXVlTmV4dFN0YXRlOiBvcHRpb25zICYmICEhb3B0aW9ucy5lbnF1ZXVlTmV4dFN0YXRlCiAgICB9LCBjYWxsYmFja3MpOwogIH07CiAgQWdlbnQucHJvdG90eXBlLm9uRW5xdWV1ZWROZXh0U3RhdGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVOUVVFVUVEX05FWFRfU1RBVEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5jb25uZWN0ID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIHBhcmFtcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfT1VUQk9VTkRfQ09OVEFDVCwgewogICAgICBlbmRwb2ludDogY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKSwKICAgICAgcXVldWVBUk46IChwYXJhbXMgJiYgKHBhcmFtcy5xdWV1ZUFSTiB8fCBwYXJhbXMucXVldWVJZCkpIHx8IHRoaXMuZ2V0Um91dGluZ1Byb2ZpbGUoKS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTgogICAgfSwgcGFyYW1zICYmIHsKICAgICAgICBzdWNjZXNzOiBwYXJhbXMuc3VjY2VzcywKICAgICAgICBmYWlsdXJlOiBwYXJhbXMuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWxsUXVldWVBUk5zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5tYXAoZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgIHJldHVybiBxdWV1ZS5xdWV1ZUFSTjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFbmRwb2ludHMgPSBmdW5jdGlvbiAocXVldWVBUk5zLCBjYWxsYmFja3MsIHBhZ2VJbmZvSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLCAiY2FsbGJhY2tzIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLnN1Y2Nlc3MsICJjYWxsYmFja3Muc3VjY2VzcyIpOwogICAgdmFyIHBhZ2VJbmZvID0gcGFnZUluZm9JbiB8fCB7IH07CgogICAgcGFnZUluZm8uZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzIHx8IFtdOwogICAgcGFnZUluZm8ubWF4UmVzdWx0cyA9IHBhZ2VJbmZvLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgYWxsb3dpbmcgYSBzaW5nbGUgcXVldWVBUk4gdG8gYmUgc3BlY2lmaWVkCiAgICAvLyBpbnN0ZWFkIG9mIGFuIGFycmF5LgogICAgaWYgKCFjb25uZWN0LmlzQXJyYXkocXVldWVBUk5zKSkgewogICAgICBxdWV1ZUFSTnMgPSBbcXVldWVBUk5zXTsKICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0VORFBPSU5UUywgewogICAgICBxdWV1ZUFSTnM6IHF1ZXVlQVJOcywKICAgICAgbmV4dFRva2VuOiBwYWdlSW5mby5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFnZUluZm8ubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5nZXRFbmRwb2ludHMocXVldWVBUk5zLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMsCiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5jb25jYXQoZGF0YS5lbmRwb2ludHMpOwogICAgICAgICAgICB2YXIgZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHsKICAgICAgICAgICAgICBlbmRwb2ludHM6IGVuZHBvaW50cywKICAgICAgICAgICAgICBhZGRyZXNzZXM6IGVuZHBvaW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZGRyZXNzZXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzOwoKICAvL0ludGVybmFsIGlkZW50aWZpZXIuCiAgQWdlbnQucHJvdG90eXBlLl9nZXRSZXNvdXJjZUlkID0gZnVuY3Rpb24oKSB7CiAgICBxdWV1ZUFybnMgPSB0aGlzLmdldEFsbFF1ZXVlQVJOcygpOwogICAgZm9yIChsZXQgcXVldWVBcm4gb2YgcXVldWVBcm5zKSB7CiAgICAgIGNvbnN0IGFnZW50SWRNYXRjaCA9IHF1ZXVlQXJuLm1hdGNoKC9cL2FnZW50XC8oW14vXSspLyk7CgogICAgICBpZiAoYWdlbnRJZE1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGFnZW50SWRNYXRjaFsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBFcnJvcigiQWdlbnQucHJvdG90eXBlLl9nZXRSZXNvdXJjZUlkOiBxdWV1ZUFybnMgZGlkIG5vdCBjb250YWluIGFnZW50UmVzb3VyY2VJZDogIiwgcXVldWVBcm5zKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkFnZW50U25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudFNuYXBzaG90CiAgICovCiAgdmFyIEFnZW50U25hcHNob3QgPSBmdW5jdGlvbiAoYWdlbnREYXRhKSB7CiAgICBjb25uZWN0LkFnZW50LmNhbGwodGhpcyk7CiAgICB0aGlzLmFnZW50RGF0YSA9IGFnZW50RGF0YTsKICB9OwogIEFnZW50U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBZ2VudC5wcm90b3R5cGUpOwogIEFnZW50U25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQWdlbnRTbmFwc2hvdDsKCiAgQWdlbnRTbmFwc2hvdC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5hZ2VudERhdGE7CiAgfTsKCiAgQWdlbnRTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbnRhY3RBUEkgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3QKICAgKi8KICB2YXIgQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHRoaXMuY29udGFjdElkID0gY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuZ2V0Q29udGFjdElkKCkpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLl9jcmVhdGVDb25uZWN0aW9uQVBJID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25EYXRhKSB7CiAgICBpZiAodGhpcy5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuQ0hBVCkgewogICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9IGVsc2UgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLlRBU0spIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LlRhc2tDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LlZvaWNlQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRFdmVudE5hbWUgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnROYW1lLCB0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblJlZnJlc2ggPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uSW5jb21pbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5DT01JTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkNvbm5lY3RpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uUGVuZGluZyA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5QRU5ESU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BY2NlcHRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uTWlzc2VkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uRW5kZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuRU5ERUQpLCBmKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uRGVzdHJveSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkFDVyA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ1cpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkNvbm5lY3RlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVSUk9SKSwgZik7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRDb250YWN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb250YWN0SWQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0T3JpZ2luYWxDb250YWN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWxDb250YWN0SWQ7CiAgfTsKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29udGFjdElkID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0T3JpZ2luYWxDb250YWN0SWQ7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnR5cGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdER1cmF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbnRhY3REdXJhdGlvbjsKICB9CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zdGF0ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm5vdygpIC0gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCkgKyBjb25uZWN0LmNvcmUuZ2V0U2tldygpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXR1c0R1cmF0aW9uID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UXVldWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnF1ZXVlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlVGltZXN0YW1wID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZVRpbWVzdGFtcDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRDb25uZWN0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29ubmVjdGlvbnMubWFwKGZ1bmN0aW9uIChjb25uRGF0YSkgewogICAgICBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuQ0hBVCkgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5DaGF0Q29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIGlmIChzZWxmLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LlRhc2tDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uLmlzSW5pdGlhbENvbm5lY3Rpb24oKTsKICAgIH0pIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWN0aXZlSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaW5pdGlhbENvbm4gPSB0aGlzLmdldEluaXRpYWxDb25uZWN0aW9uKCk7CiAgICBpZiAoaW5pdGlhbENvbm4gIT0gbnVsbCAmJiBpbml0aWFsQ29ubi5pc0FjdGl2ZSgpKSB7CiAgICAgIHJldHVybiBpbml0aWFsQ29ubjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFRoaXJkUGFydHlDb25uZWN0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbm5lY3Rpb25zKCkuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiAhY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCkgJiYgY29ubi5nZXRUeXBlKCkgIT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQ7CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTaW5nbGVBY3RpdmVUaGlyZFBhcnR5Q29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFRoaXJkUGFydHlDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0FjdGl2ZSgpOwogICAgfSlbMF0gfHwgbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBZ2VudENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgdmFyIGNvbm5UeXBlID0gY29ubi5nZXRUeXBlKCk7CiAgICAgIHJldHVybiBjb25uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCB8fCBjb25uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubmFtZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRDb250YWN0TWV0YWRhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbnRhY3RNZXRhZGF0YTsKICB9CgogIENvbnRhY3QucHJvdG90eXBlLmdldERlc2NyaXB0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5kZXNjcmlwdGlvbjsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRSZWZlcmVuY2VzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5yZWZlcmVuY2VzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmF0dHJpYnV0ZXM7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdEZlYXR1cmVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RmVhdHVyZXM7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbnRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNoYW5uZWxDb250ZXh0OwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzU29mdHBob25lQ2FsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKSAhPSBudWxsOwogICAgfSkgIT0gbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5faXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYXRpb25NZXRob2QgPSB0aGlzLl9nZXREYXRhKCkuaW5pdGlhdGlvbk1ldGhvZDsKICAgIHJldHVybiAoaW5pdGlhdGlvbk1ldGhvZCA9PT0gY29ubmVjdC5Db250YWN0SW5pdGlhdGlvbk1ldGhvZC5PVVRCT1VORCkgPyBmYWxzZSA6IHRydWU7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5pc0luYm91bmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubiA9IHRoaXMuZ2V0SW5pdGlhbENvbm5lY3Rpb24oKTsKCiAgICAvLyBXZSB3aWxsIGdyYWR1YWxseSBjaGFuZ2UgY2hlY2tpbmcgaW5ib3VuZCBieSByZWx5aW5nIG9uIGNvbnRhY3QgaW5pdGlhdGlvbk1ldGhvZAogICAgaWYgKGNvbm4uZ2V0TWVkaWFUeXBlKCkgPT09IGNvbm5lY3QuTWVkaWFUeXBlLlRBU0spIHsKICAgICAgcmV0dXJuIHRoaXMuX2lzSW5ib3VuZCgpOwogICAgfQoKICAgIHJldHVybiBjb25uID8gY29ubi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuSU5CT1VORCA6IGZhbHNlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hY2NlcHQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNvbnRhY3RJZCA9IHRoaXMuZ2V0Q29udGFjdElkKCk7CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjbGlja1R5cGU6IGNvbm5lY3QuQ2xpY2tUeXBlLkFDQ0VQVCwKICAgICAgY2xpY2tUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH0pOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5BQ0NFUFRfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZAogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsCiAgICAgICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKQogICAgICAgICAgfSk7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwgc2VsZi5nZXRDb250YWN0SWQoKSksCiAgICAgICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKQogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gSW4gRmlyZWZveCwgdGhlcmUncyBhIGJyb3dzZXIgcmVzdHJpY3Rpb24gdGhhdCBhbiB1bmZvY3VzZWQgYnJvd3NlciB0YWIgaXMgbm90IGFsbG93ZWQgdG8gYWNjZXNzIHRoZSB1c2VyJ3MgbWljcm9waG9uZS4KICAgICAgICAgIC8vIFRoZSBwcm9ibGVtIGlzIHRoYXQgdGhlIHJlc3RyaWN0aW9uIGNvdWxkIGNhdXNlIGEgd2VicnRjIHNlc3Npb24gY3JlYXRpb24gdGltZW91dCBlcnJvciB3aGVuIHlvdSBnZXQgYW4gaW5jb21pbmcgY2FsbCB3aGlsZSB5b3UgYXJlIG5vdCBvbiB0aGUgcHJpbWFyeSB0YWIuCiAgICAgICAgICAvLyBJdCB3YXMgaGFyZCB0byB3b3JrYXJvdW5kIHRoZSBpc3N1ZSBlc3BlY2lhbGx5IHdoZW4geW91IGhhdmUgbXVsdGlwbGUgdGFicyBvcGVuIGJlY2F1c2UgeW91IG5lZWRlZCB0byBmaW5kIHRoZSByaWdodCB0YWIgYW5kIGFjY2VwdCB0aGUgY29udGFjdCBiZWZvcmUgdGhlIHRpbWVvdXQuCiAgICAgICAgICAvLyBUbyBhdm9pZCB0aGUgZXJyb3IsIHdoZW4gbXVsdGlwbGUgdGFicyBhcmUgb3BlbiBpbiBGaXJlZm94LCBhIHdlYnJ0YyBzZXNzaW9uIGlzIG5vdCBpbW1lZGlhdGVseSBjcmVhdGVkIGFzIGFuIGluY29taW5nIHNvZnRwaG9uZSBjb250YWN0IGlzIGRldGVjdGVkLgogICAgICAgICAgLy8gSW5zdGVhZCwgaXQgd2FpdHMgdW50aWwgY29udGFjdC5hY2NlcHQoKSBpcyBjYWxsZWQgb24gYSB0YWIgYW5kIGxldHMgdGhlIHRhYiBiZWNvbWUgdGhlIG5ldyBwcmltYXJ5IHRhYiBhbmQgc3RhcnQgdGhlIHdlYiBydGMgc2Vzc2lvbiB0aGVyZQogICAgICAgICAgLy8gYmVjYXVzZSB0aGUgdGFiIHNob3VsZCBiZSBmb2N1c2VkIGF0IHRoZSBtb21lbnQgYW5kIGhhdmUgYWNjZXNzIHRvIHRoZSB1c2VyJ3MgbWljcm9waG9uZS4KICAgICAgICAgIHZhciBjb250YWN0ID0gbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpOwogICAgICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkpIHsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogY2FsbGJhY2tzID8gY2FsbGJhY2tzLmZhaWx1cmUgOiBudWxsCiAgICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmdldExvZygpLndhcm4oImNvbnRhY3QuZGVzdHJveSgpIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hDbGlja1N0cmVhbURhdGEoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNsaWNrVHlwZTogY29ubmVjdC5DbGlja1R5cGUuUkVKRUNULAogICAgICBjbGlja1RpbWU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgfSk7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlJFSkVDVF9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jb21wbGV0ZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09NUExFVEVfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNMRUFSX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm5vdGlmeUlzc3VlID0gZnVuY3Rpb24gKGlzc3VlQ29kZSwgZGVzY3JpcHRpb24sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5OT1RJRllfQ09OVEFDVF9JU1NVRSwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGlzc3VlQ29kZTogaXNzdWVDb2RlLAogICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24KICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWRkQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX0FERElUSU9OQUxfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGVuZHBvaW50OiBlbmRwb2ludAogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS50b2dnbGVBY3RpdmVDb25uZWN0aW9ucyA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29ubmVjdGlvbklkID0gbnVsbDsKICAgIHZhciBob2xkaW5nQ29ubiA9IGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEOwogICAgfSk7CgogICAgaWYgKGhvbGRpbmdDb25uICE9IG51bGwpIHsKICAgICAgY29ubmVjdGlvbklkID0gaG9sZGluZ0Nvbm4uZ2V0Q29ubmVjdGlvbklkKCk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIGFjdGl2ZUNvbm5zID0gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICAgIHJldHVybiBjb25uLmlzQWN0aXZlKCk7CiAgICAgIH0pOwogICAgICBpZiAoYWN0aXZlQ29ubnMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbm5lY3Rpb25JZCA9IGFjdGl2ZUNvbm5zWzBdLmdldENvbm5lY3Rpb25JZCgpOwogICAgICB9CiAgICB9CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlRPR0dMRV9BQ1RJVkVfQ09OTkVDVElPTlMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZAogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5zZW5kU29mdHBob25lTWV0cmljcyA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfTUVUUklDUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzOiBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzCiAgICB9LCBjYWxsYmFja3MpOwoKICAgIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVN0YXRzKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgc3RhdHM6IHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnNlbmRTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbiAocmVwb3J0LCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9SRVBPUlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgcmVwb3J0OiByZXBvcnQKICAgIH0sIGNhbGxiYWNrcyk7CgogICAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lUmVwb3J0KHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgcmVwb3J0OiByZXBvcnQKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNvbmZlcmVuY2VDb25uZWN0aW9ucyA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09ORkVSRU5DRV9DT05ORUNUSU9OUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc011bHRpUGFydHlDb25mZXJlbmNlRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb250YWN0RmVhdHVyZXMgPSB0aGlzLmdldENvbnRhY3RGZWF0dXJlcygpOwogICAgcmV0dXJuICEhKGNvbnRhY3RGZWF0dXJlcyAmJiBjb250YWN0RmVhdHVyZXMubXVsdGlQYXJ0eUNvbmZlcmVuY2VFbmFibGVkKTsKICB9CgogIENvbnRhY3QucHJvdG90eXBlLnVwZGF0ZU1vbml0b3JQYXJ0aWNpcGFudFN0YXRlID0gZnVuY3Rpb24gKHRhcmdldFN0YXRlLCBjYWxsYmFja3MpIHsKICAgIGlmKCF0YXJnZXRTdGF0ZSB8fCAhT2JqZWN0LnZhbHVlcyhjb25uZWN0Lk1vbml0b3JpbmdNb2RlKS5pbmNsdWRlcyh0YXJnZXRTdGF0ZSkpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihgSW52YWxpZCB0YXJnZXQgc3RhdGUgd2FzIHByb3ZpZGVkOiAke3RhcmdldFN0YXRlfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShjb25uZWN0Lk1vbml0b3JpbmdFcnJvclR5cGVzLklOVkFMSURfVEFSR0VUX1NUQVRFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9NT05JVE9SX1BBUlRJQ0lQQU5UX1NUQVRFLCB7CiAgICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICAgIHRhcmdldE1vbml0b3JNb2RlOiB0YXJnZXRTdGF0ZQogICAgICB9LCBjYWxsYmFja3MpOwogICAgfQogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29udGFjdFNuYXBzaG90CiAgICovCiAgdmFyIENvbnRhY3RTbmFwc2hvdCA9IGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgY29ubmVjdC5Db250YWN0LmNhbGwodGhpcywgY29udGFjdERhdGEuY29udGFjdElkKTsKICAgIHRoaXMuY29udGFjdERhdGEgPSBjb250YWN0RGF0YTsKICB9OwogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbnRhY3QucHJvdG90eXBlKTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29udGFjdFNuYXBzaG90OwoKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdERhdGE7CiAgfTsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdChjb25uZWN0aW9uRGF0YSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29ubmVjdGlvbgogICAqLwogIHZhciBDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICAgIHRoaXMuY29ubmVjdGlvbklkID0gY29ubmVjdGlvbklkOwogICAgdGhpcy5faW5pdE1lZGlhQ29udHJvbGxlcigpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbm5lY3Rpb25EYXRhKAogICAgICB0aGlzLmdldENvbnRhY3RJZCgpLCB0aGlzLmdldENvbm5lY3Rpb25JZCgpKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRDb250YWN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb250YWN0SWQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbklkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEVuZHBvaW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkVuZHBvaW50KHRoaXMuX2dldERhdGEoKS5lbmRwb2ludCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0QWRkcmVzcyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEVuZHBvaW50OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnR5cGU7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuaW5pdGlhbDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0FjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCB0aGlzLmdldFN0YXR1cygpLnR5cGUpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVElORzsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc09uSG9sZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFNvZnRwaG9uZU1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIC8qKgogICAqIEdldHMgdGhlIGN1cnJlbnRseSBtb25pdG9yZWQgY29udGFjdCBpbmZvLCBSZXR1cm5zIG51bGwgaWYgZG9lcyBub3QgZXhpc3RzLgogICAqIEByZXR1cm4ge3thZ2VudE5hbWU6c3RyaW5nLCBjdXN0b21lck5hbWU6c3RyaW5nLCBqb2luVGltZTpEYXRlfX0KICAgKi8KICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNb25pdG9ySW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvcmluZ0luZm87CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2xpY2tUeXBlOiBjb25uZWN0LkNsaWNrVHlwZS5IQU5HVVAsCiAgICAgIGNsaWNrVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICB9KTsKCiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkRFU1RST1lfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5zZW5kRGlnaXRzID0gZnVuY3Rpb24gKGRpZ2l0cywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfRElHSVRTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpLAogICAgICBkaWdpdHM6IGRpZ2l0cwogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5ob2xkID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5IT0xEX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRVNVTUVfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuZ2V0TWVkaWFJbmZvKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8vIE1ldGhvZCBmb3IgY2hlY2tpbmcgd2hldGhlciB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uCiAgLy8gKHR5cGUgQUdFTlQgb3IgTU9OSVRPUklORykKICBDb25uZWN0aW9uLnByb3RvdHlwZS5faXNBZ2VudENvbm5lY3Rpb25UeXBlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm5lY3Rpb25UeXBlID0gdGhpcy5nZXRUeXBlKCk7CiAgICByZXR1cm4gY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CgogIC8qKgogICAqIFV0aWxpdHkgbWV0aG9kIGZvciBjaGVja2luZyB3aGV0aGVyIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24KICAgKiAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbi4gRmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVAogICAgICB8fCBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBDb250YWN0IHJlY29yZGluZwogICovCgogIHZhciBDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShjb250YWN0SWQpID8gY29udGFjdElkIDogbnVsbDsKICB9CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0YXJ0Q29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKHRyYWNrQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHZhciByZWNvcmRpbmdUcmFjayA9ICh0cmFja0NvbmZpZyAmJiBPYmplY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcpLmluY2x1ZGVzKHRyYWNrQ29uZmlnKSkgPyB0cmFja0NvbmZpZyA6IGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcuQUxMOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJ2b2ljZVJlY29yZGluZ0NvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAidm9pY2VSZWNvcmRpbmdUcmFjayI6IHJlY29yZGluZ1RyYWNrCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygic3RhcnRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdGFydENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIiwgeyBjYXVzZTogZXJyIH0pKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH07CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0b3BDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNUT1BfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJzdG9wQ29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0b3BDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdG9wQ29udGFjdFJlY29yZGluZyBmYWlsZWQiLCB7IGNhdXNlOiBlcnIgfSkpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKCiAgQ29udGFjdFJlY29yZGluZy5wcm90b3R5cGUuc3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQsIGNvbnRhY3REYXRhOwoKICAgIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1VTUEVORF9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyLAogICAgICAgICAgICAgIGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoRXJyb3IoInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIsIHsgY2F1c2U6IGVyciB9KSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5yZXN1bWVDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlJFU1VNRV9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgc3VjY2VlZGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLCB7IGNhdXNlOiBlcnIgfSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFZvaWNlIGF1dGhlbnRpY2F0b3IgVm9pY2VJZAogICovCgogIHZhciBWb2ljZUlkID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuR0VUX0NPTlRBQ1QsIHsKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgImF3c0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgaWYoZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkKSB7CiAgICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIHNwZWFrZXJJZDogZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0U3BlYWtlcklkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICByZXNvbHZlKG9iaik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5OT19TUEVBS0VSX0lEX0ZPVU5ELCAiTm8gc3BlYWtlcklkIGFzc290aWF0ZWQgd2l0aCB0aGlzIGNhbGwiKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiR2V0IFNwZWFrZXJJZCBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfU1BFQUtFUl9JRF9GQUlMRUQsICJHZXQgU3BlYWtlcklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5nZXRTcGVha2VyU3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5ERVNDUklCRV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRTcGVha2VyU3RhdHVzIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgICAgc3dpdGNoKHBhcnNlZEVyci5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gcGFyc2VkRXJyOwogICAgICAgICAgICAgICAgICAgIGRhdGEudHlwZSA9IGRhdGEudHlwZSA/IGRhdGEudHlwZSA6IGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1BFQUtFUl9JRF9OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTcGVha2VyIGlzIG5vdCBlbnJvbGxlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0U3BlYWtlclN0YXR1cyBmYWlsZWQiKQogICAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9TUEVBS0VSX1NUQVRVU19GQUlMRUQsICJHZXQgU3BlYWtlclN0YXR1cyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIGludGVybmFsIG9ubHkKICBWb2ljZUlkLnByb3RvdHlwZS5fb3B0T3V0U3BlYWtlckluTGNtcyA9IGZ1bmN0aW9uIChzcGVha2VySWQsIGdlbmVyYXRlZFNwZWFrZXJJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlVQREFURV9WT0lDRV9JRF9EQVRBLCB7CiAgICAgICAgIkNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJJbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJBV1NBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAiQ3VzdG9tZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAiVm9pY2VJZFJlc3VsdCI6IHsKICAgICAgICAgICJTcGVha2VyT3B0ZWRPdXQiOiB0cnVlLAogICAgICAgICAgImdlbmVyYXRlZFNwZWFrZXJJZCI6IGdlbmVyYXRlZFNwZWFrZXJJZAogICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXJJbkxjbXMgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigib3B0T3V0U3BlYWtlckluTGNtcyBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfSU5fTENNU19GQUlMRUQsICJvcHRPdXRTcGVha2VySW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLm9wdE91dFNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIHZhciBzcGVha2VySWQgPSBkYXRhLnNwZWFrZXJJZDsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLk9QVF9PVVRfU1BFQUtFUiwgewogICAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9vcHRPdXRTcGVha2VySW5MY21zKHNwZWFrZXJJZCwgZGF0YS5nZW5lcmF0ZWRTcGVha2VySWQpLmNhdGNoKGZ1bmN0aW9uKCl7fSk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIm9wdE91dFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfRkFJTEVELCAib3B0T3V0U3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlbGV0ZVNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFTEVURV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJkZWxldGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJkZWxldGVTcGVha2VyIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuREVMRVRFX1NQRUFLRVJfRkFJTEVELCAiZGVsZXRlU3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnN0YXJ0U2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfVk9JQ0VfSURfU0VTU0lPTiwgewogICAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgICAiY3VzdG9tZXJBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAgICJjbGllbnRUb2tlbiI6IEFXUy51dGlsLnV1aWQudjQoKSwKICAgICAgICAgICJkb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGlmKGRhdGEuc2Vzc2lvbklkKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCwgbm8gc2Vzc2lvbiBpZCByZXR1cm5lZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNUQVJUX1NFU1NJT05fRkFJTEVELCAiTm8gc2Vzc2lvbiBpZCByZXR1cm5lZCBmcm9tIHN0YXJ0IHNlc3Npb24gYXBpIik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TVEFSVF9TRVNTSU9OX0ZBSUxFRCwgInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyID0gZnVuY3Rpb24gKHN0YXJ0TmV3KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgcG9sbFRpbWVzID0gMDsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FVkFMVUFURV9TRVNTSU9OLCB7CiAgICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBpZigrK3BvbGxUaW1lcyA8IGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FVkFMVUFUSU9OX01BWF9QT0xMX1RJTUVTKSB7CiAgICAgICAgICAgICAgICBpZihkYXRhLlN0cmVhbWluZ1N0YXR1cyA9PT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLlBFTkRJTkdfQ09ORklHVVJBVElPTikgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmKCFkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIWRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlIGlmIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBhcmUgbm90IGVuYWJsZWQuCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICAhc2VsZi5pc0ZyYXVkRW5hYmxlZChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoZGF0YS5TdHJlYW1pbmdTdGF0dXMgPT09IGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cy5FTkRFRCkgewogICAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFZvaWNlIHByaW50IGlzIG5vdCBsb25nIGVub3VnaCBmb3IgYm90aCBhdXRoZW50aWNhdGlvbiBhbmQgZnJhdWQgZGV0ZWN0aW9uCiAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pc0ZyYXVkUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5BQ0NFUFQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5SRUpFQ1Q6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfQVVUSEVOVElDQVRFRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uU1BFQUtFUl9PUFRFRF9PVVQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5PUFRFRF9PVVQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlNQRUFLRVJfTk9UX0VOUk9MTEVEOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOUk9MTEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRFbmFibGVkKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkxPV19SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgICFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmUgb25seSB3aGVuIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBoYXZlIHJlc3VsdHMuIE90aGVyd2lzZSwga2VlcCBwb2xsaW5nLgogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJldmFsdWF0ZVNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfVElNRU9VVCwgImV2YWx1YXRlU3BlYWtlciB0aW1lb3V0Iik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfRkFJTEVELCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZighc3RhcnROZXcpIHsKICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGV2YWx1YXRlKCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3luY1NwZWFrZXJJZCBmYWlsZWQgd2hlbiBzZXNzaW9uIHN0YXJ0TmV3PWZhbHNlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRFX1NFU1NJT05fREVMQVkpOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN5bmNTcGVha2VySWQgZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz10cnVlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRTZXNzaW9uIGZhaWxlZCB3aGVuIHNlc3Npb24gc3RhcnROZXc9dHJ1ZSIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChlcnIpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlc2NyaWJlU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFU0NSSUJFX1NFU1NJT04sIHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkRFU0NSSUJFX1NFU1NJT05fRkFJTEVELCAiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuY2hlY2tFbnJvbGxtZW50U3RhdHVzID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBvbGxpbmdUaW1lcyA9IDA7CiAgICB2YXIgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSBmYWxzZTsKCiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBkZXNjcmliZSAoKSB7CiAgICAgICAgaWYoKytwb2xsaW5nVGltZXMgPCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRU5ST0xMTUVOVF9NQVhfUE9MTF9USU1FUykgewogICAgICAgICAgc2VsZi5kZXNjcmliZVNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICBzd2l0Y2goZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5TdGF0dXMpIHsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRDoKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLklOX1BST0dSRVNTOgogICAgICAgICAgICAgICAgaWYgKCFjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGVIYXNCZWVuSW52b2tlZCAmJiB0eXBlb2YgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0VGltZW91dChkZXNjcmliZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLk5PVF9FTk9VR0hfU1BFRUNIOgogICAgICAgICAgICAgICAgaWYoZGF0YS5TZXNzaW9uLlN0cmVhbWluZ1N0YXR1cyAhPT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZGVzY3JpYmUsY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaWJlKCk7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9LCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuU1RBUlRfU0VTU0lPTl9ERUxBWSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgPyBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgOiAiZW5yb2xsU3BlYWtlciBmYWlsZWQuIFVua25vd24gZW5yb2xsbWVudCBzdGF0dXMgaGFzIGJlZW4gcmVjZWl2ZWQiOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihtZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogIAkJICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCBtZXNzYWdlLCBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLlN0YXR1cyk7CiAgCQkgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVOUk9MTF9TUEVBS0VSX1RJTUVPVVQsICJlbnJvbGxTcGVha2VyIHRpbWVvdXQiKTsKICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlc2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5lbnJvbGxTcGVha2VyID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5nZXRTcGVha2VyU3RhdHVzKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZihkYXRhLlNwZWFrZXIgJiYgZGF0YS5TcGVha2VyLlN0YXR1cyA9PSBjb25uZWN0LlZvaWNlSWRTcGVha2VyU3RhdHVzLk9QVEVEX09VVCkgewogICAgICAgICAgICBzZWxmLmRlbGV0ZVNwZWFrZXIoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKQogICAgICB9KQogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmVucm9sbFNwZWFrZXJIZWxwZXIgPSBmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0LCBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FTlJPTExfQllfU0VTU0lPTiwgewogICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5DT01QTEVURUQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5jaGVja0Vucm9sbG1lbnRTdGF0dXMoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJlbnJvbGxTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCAiZW5yb2xsU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHJlamVjdChlcnIpOwogICAgfSk7CiAgfTsKCiAgLy8gaW50ZXJuYWwgb25seQogIFZvaWNlSWQucHJvdG90eXBlLl91cGRhdGVTcGVha2VySWRJbkxjbXMgPSBmdW5jdGlvbiAoc3BlYWtlcklkLCBnZW5lcmF0ZWRTcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5VUERBVEVfVk9JQ0VfSURfREFUQSwgewogICAgICAgICJDb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAiQVdTQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCksCiAgICAgICAgIkN1c3RvbWVySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgIlZvaWNlSWRSZXN1bHQiOiB7CiAgICAgICAgICAiZ2VuZXJhdGVkU3BlYWtlcklkIjogZ2VuZXJhdGVkU3BlYWtlcklkCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5MY21zIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJbkxjbXMgZmFpbGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0lOX0xDTVNfRkFJTEVELCAidXBkYXRlU3BlYWtlcklkSW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCA9IGZ1bmN0aW9uIChzcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1NFU1NJT04sIHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBzZWxmLl91cGRhdGVTcGVha2VySWRJbkxjbXMoc3BlYWtlcklkLCBkYXRhLmdlbmVyYXRlZFNwZWFrZXJJZCkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5zeW5jU3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYudXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkKGRhdGEuc3BlYWtlcklkKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pCiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmdldERvbWFpbklkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjb25zdCBhZ2VudCA9IG5ldyBjb25uZWN0LkFnZW50KCk7CiAgICAgIGlmICghYWdlbnQuZ2V0UGVybWlzc2lvbnMoKS5pbmNsdWRlcyhjb25uZWN0LkFnZW50UGVybWlzc2lvbnMuVk9JQ0VfSUQpKSB7CiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiQWdlbnQgZG9lc24ndCBoYXZlIHRoZSBwZXJtaXNzaW9uIGZvciBWb2ljZSBJRCIpKTsKICAgICAgfSBlbHNlIGlmIChjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkKSB7CiAgICAgICAgcmVzb2x2ZShjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkxJU1RfSU5URUdSQVRJT05fQVNTT0NJQVRJT05TLCB7CiAgICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAgICJJbnRlZ3JhdGlvblR5cGUiOiAiVk9JQ0VfSUQiCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgZG9tYWluSWQ7CiAgICAgICAgICAgICAgaWYgKGRhdGEuSW50ZWdyYXRpb25Bc3NvY2lhdGlvblN1bW1hcnlMaXN0Lmxlbmd0aCA+PSAxKSB7CiAgICAgICAgICAgICAgICB2YXIgaW50ZWdyYXRpb25Bcm4gPSBkYXRhLkludGVncmF0aW9uQXNzb2NpYXRpb25TdW1tYXJ5TGlzdFswXS5JbnRlZ3JhdGlvbkFybjsKICAgICAgICAgICAgICAgIGRvbWFpbklkID0gaW50ZWdyYXRpb25Bcm4ucmVwbGFjZSgvXi4qZG9tYWluXC8vaSwgJycpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRvbWFpbklkKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldERvbWFpbklkOiBubyBkb21haW5JZCBmb3VuZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLk5PX0RPTUFJTl9JRF9GT1VORCk7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldERvbWFpbklkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgICAgICBldmVudDogY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsCiAgICAgICAgICAgICAgICBkYXRhOiB7IGRvbWFpbklkOiBkb21haW5JZCB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVzb2x2ZShkb21haW5JZCk7CiAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0RG9tYWluSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfRE9NQUlOX0lEX0ZBSUxFRCwgImdldERvbWFpbklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0RG9tYWluSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX0RPTUFJTl9JRF9GQUlMRUQsICJnZXREb21haW5JZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmNoZWNrQ29uZmVyZW5jZUNhbGwgPSBmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGlzQ29uZmVyZW5jZUNhbGwgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCkuY29ubmVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCBjb25uLnN0YXRlLnR5cGUpOwogICAgfSkubGVuZ3RoID4gMjsKICAgIGlmKGlzQ29uZmVyZW5jZUNhbGwpewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCJWb2ljZUlkIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIGNvbmZlcmVuY2UgY2FsbHMiKTsKICAgIH0KICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzQXV0aEVuYWJsZWQgPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCAhPT0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2ggPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCA9PT0gY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5PVUdIX1NQRUVDSDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzQXV0aFJlc3VsdEluY29uY2x1c2l2ZSA9IGZ1bmN0aW9uKGF1dGhSZXN1bHQpIHsKICAgIHJldHVybiBhdXRoUmVzdWx0ID09PSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0ZyYXVkRW5hYmxlZCA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgIT09IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaCA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgPT09IGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTk9UX0VOT1VHSF9TUEVFQ0g7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0ZyYXVkUmVzdWx0SW5jb25jbHVzaXZlID0gZnVuY3Rpb24oZnJhdWRSZXN1bHQpIHsKICAgIHJldHVybiBmcmF1ZFJlc3VsdCA9PT0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogIH0KCiAgLyoqCiAgICogQGNsYXNzIFZvaWNlQ29ubmVjdGlvbgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb250YWN0SWQKICAgKiBAcGFyYW0ge251bWJlcn0gY29ubmVjdGlvbklkCiAgICogQGRlc2NyaXB0aW9uIC0gUHJvdmlkZXMgdm9pY2UgbWVkaWEgc3BlY2lmaWMgb3BlcmF0aW9ucwogICAqLwogIHZhciBWb2ljZUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yID0gbmV3IFZvaWNlSWQoY29udGFjdElkKTsKICAgIHRoaXMuX2NvbnRhY3RSZWNvcmRlciA9IG5ldyBDb250YWN0UmVjb3JkaW5nKGNvbnRhY3RJZCk7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VDb25uZWN0aW9uOwoKICAvKioKICAqIEBkZXByZWNhdGVkCiAgKiBQbGVhc2UgdXNlIGdldE1lZGlhSW5mbwogICovCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Vm9pY2VJZFNwZWFrZXJJZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJJZCgpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRWb2ljZUlkU3BlYWtlclN0YXR1cyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJTdGF0dXMoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUub3B0T3V0Vm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKCiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3Iub3B0T3V0U3BlYWtlcigpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5kZWxldGVWb2ljZUlkU3BlYWtlciA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmRlbGV0ZVNwZWFrZXIoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyV2l0aFZvaWNlSWQgPSBmdW5jdGlvbihzdGFydE5ldykgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmV2YWx1YXRlU3BlYWtlcihzdGFydE5ldyk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmVucm9sbFNwZWFrZXJJblZvaWNlSWQgPSBmdW5jdGlvbihjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5lbnJvbGxTcGVha2VyKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnVwZGF0ZVZvaWNlSWRTcGVha2VySWQgPSBmdW5jdGlvbihzcGVha2VySWQpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci51cGRhdGVTcGVha2VySWRJblZvaWNlSWQoc3BlYWtlcklkKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0UXVpY2tDb25uZWN0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVpY2tDb25uZWN0TmFtZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1vbml0b3JTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvclN0YXRlOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckNhcGFiaWxpdGllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvckNhcGFiaWxpdGllczsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzRm9yY2VkTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZm9yY2VkTXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLm11dGVQYXJ0aWNpcGFudCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTVVURV9QQVJUSUNJUEFOVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnVubXV0ZVBhcnRpY2lwYW50ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VTk1VVEVfUEFSVElDSVBBTlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdGFydENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdGFydENvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuc3RvcENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdG9wQ29udGFjdFJlY29yZGluZygpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdXNwZW5kQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5yZXN1bWVDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNoZWNrQ29uZmVyZW5jZUNhbGwgPSBmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGlzQ29uZmVyZW5jZUNhbGwgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCkuY29ubmVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCBjb25uLnN0YXRlLnR5cGUpOwogICAgfSkubGVuZ3RoID4gMjsKICAgIGlmKGlzQ29uZmVyZW5jZUNhbGwpewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCJWb2ljZUlkIGFuZCBDb250YWN0IFJlY29yZGluZyBhcmUgbm90IHN1cHBvcnRlZCBmb3IgY29uZmVyZW5jZSBjYWxscyIpOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIENoYXRDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZAogICAqIEBkZXNjcmlwdGlvbiBhZGRzIHRoZSBjaGF0IG1lZGlhIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkKICAgKi8KICB2YXIgQ2hhdENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ2hhdENvbm5lY3Rpb247CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZGF0YSA9IHRoaXMuX2dldERhdGEoKS5jaGF0TWVkaWFJbmZvOwogICAgaWYgKCFkYXRhKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgICB2YXIgbWVkaWFPYmplY3QgPSB7CiAgICAgICAgY29udGFjdElkOiB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBpbml0aWFsQ29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgIHBhcnRpY2lwYW50SWQ6IHRoaXMuY29ubmVjdGlvbklkLAogICAgICAgIGdldENvbm5lY3Rpb25Ub2tlbjogY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLmdldENvbm5lY3Rpb25Ub2tlbikKICAgICAgfTsKICAgICAgaWYgKGRhdGEuY29ubmVjdGlvbkRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IEpTT04ucGFyc2UoZGF0YS5jb25uZWN0aW9uRGF0YSkuQ29ubmVjdGlvbkF1dGhlbnRpY2F0aW9uVG9rZW47CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFULCAiQ29ubmVjdGlvbiBkYXRhIGlzIGludmFsaWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiB8fCBudWxsOwogICAgICAvKiogSnVzdCB0byBrZWVwIHRoZSBkYXRhIGFjY2Vzc2libGUgKi8KICAgICAgbWVkaWFPYmplY3Qub3JpZ2luYWxJbmZvID0gdGhpcy5fZ2V0RGF0YSgpLmNoYXRNZWRpYUluZm87CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICAgIH0KICB9OwoKICAvKioKICAqIFByb3ZpZGVzIHRoZSBjaGF0IGNvbm5lY3Rpb25Ub2tlbiB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSSBmb3IgYSBzcGVjaWZpYyBjb250YWN0IGFuZCBwYXJ0aWNpcGFudCBJZC4KICAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogICogVXNhZ2U6CiAgKiBjb25uZWN0aW9uLmdldENvbm5lY3Rpb25Ub2tlbigpCiAgKiAgLnRoZW4ocmVzcG9uc2UgPT4ge30pCiAgKiAgLmNhdGNoKGVycm9yID0+IHt9KQogICovCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25Ub2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHZhciB0cmFuc3BvcnREZXRhaWxzID0gewogICAgICB0cmFuc3BvcnRUeXBlOiBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUy5DSEFUX1RPS0VOLAogICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgY29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkCiAgICB9OwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHRyYW5zcG9ydERldGFpbHMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRDb25uZWN0aW9uVG9rZW4gc3VjY2VlZGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRDb25uZWN0aW9uVG9rZW4gZmFpbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigiZ2V0Q29ubmVjdGlvblRva2VuIGZhaWxlZCIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgLy8gTm90ZSB0aGF0IGEgY2hhdCBtZWRpYSBjb250cm9sbGVyIG9ubHkgbmVlZHMgdG8gYmUgcHJvZHVjZWQgZm9yIGFnZW50IHR5cGUgY29ubmVjdGlvbnMuCiAgICBpZiAodGhpcy5faXNBZ2VudENvbm5lY3Rpb25UeXBlKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIEBjbGFzcyBUYXNrQ29ubmVjdGlvbgogICAqIEBwYXJhbSB7Kn0gY29udGFjdElkCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQKICAgKiBAZGVzY3JpcHRpb24gYWRkcyB0aGUgdGFzayBtZWRpYSBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5CiAgICovCiAgdmFyIFRhc2tDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza0Nvbm5lY3Rpb247CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5NZWRpYVR5cGUuVEFTSzsKICB9CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgICAgdmFyIG1lZGlhT2JqZWN0ID0gewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgfTsKICAgICAgcmV0dXJuIG1lZGlhT2JqZWN0OwogIH07CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29ubmVjdGlvblNuYXBzaG90CiAgICovCiAgdmFyIENvbm5lY3Rpb25TbmFwc2hvdCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgY29ubmVjdC5Db25uZWN0aW9uLmNhbGwodGhpcywgY29ubmVjdGlvbkRhdGEuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgdGhpcy5jb25uZWN0aW9uRGF0YSA9IGNvbm5lY3Rpb25EYXRhOwogIH07CiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDb25uZWN0aW9uU25hcHNob3Q7CgogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uRGF0YTsKICB9OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgeyB9OwoKICB2YXIgRW5kcG9pbnQgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHRoaXMuZW5kcG9pbnRBUk4gPSBwYXJhbXMuZW5kcG9pbnRJZCB8fCBwYXJhbXMuZW5kcG9pbnRBUk4gfHwgbnVsbDsKICAgIHRoaXMuZW5kcG9pbnRJZCA9IHRoaXMuZW5kcG9pbnRBUk47CiAgICB0aGlzLnR5cGUgPSBwYXJhbXMudHlwZSB8fCBudWxsOwogICAgdGhpcy5uYW1lID0gcGFyYW1zLm5hbWUgfHwgbnVsbDsKICAgIHRoaXMucGhvbmVOdW1iZXIgPSBwYXJhbXMucGhvbmVOdW1iZXIgfHwgbnVsbDsKICAgIHRoaXMuYWdlbnRMb2dpbiA9IHBhcmFtcy5hZ2VudExvZ2luIHx8IG51bGw7CiAgICB0aGlzLnF1ZXVlID0gcGFyYW1zLnF1ZXVlIHx8IG51bGw7CiAgfTsKCiAgLyoqCiAgICogU3RyaXAgdGhlIFNJUCBlbmRwb2ludCBjb21wb25lbnRzIGZyb20gdGhlIHBob25lTnVtYmVyIGZpZWxkLgogICAqLwogIEVuZHBvaW50LnByb3RvdHlwZS5zdHJpcFBob25lTnVtYmVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMucGhvbmVOdW1iZXIgPyB0aGlzLnBob25lTnVtYmVyLnJlcGxhY2UoL3NpcDooW15AXSopQC4qLywgIiQxIikgOiAiIjsKICB9OwoKICAvKioKICAgKiBDcmVhdGUgYW4gRW5kcG9pbnQgb2JqZWN0IGZyb20gdGhlIGdpdmVuIHBob25lIG51bWJlciBhbmQgbmFtZS4KICAgKi8KICBFbmRwb2ludC5ieVBob25lTnVtYmVyID0gZnVuY3Rpb24gKG51bWJlciwgbmFtZSkgewogICAgcmV0dXJuIG5ldyBFbmRwb2ludCh7CiAgICAgIHR5cGU6IGNvbm5lY3QuRW5kcG9pbnRUeXBlLlBIT05FX05VTUJFUiwKICAgICAgcGhvbmVOdW1iZXI6IG51bWJlciwKICAgICAgbmFtZTogbmFtZSB8fCBudWxsCiAgICB9KTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBTb2Z0cGhvbmVFcnJvcgogICAqLwogIHZhciBTb2Z0cGhvbmVFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIGVycm9yTWVzc2FnZSwgZW5kUG9pbnRVcmwpIHsKICAgIHRoaXMuZXJyb3JUeXBlID0gZXJyb3JUeXBlOwogICAgdGhpcy5lcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2U7CiAgICB0aGlzLmVuZFBvaW50VXJsID0gZW5kUG9pbnRVcmw7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RXJyb3JUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZXJyb3JUeXBlOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yTWVzc2FnZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFbmRQb2ludFVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVuZFBvaW50VXJsOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFJvb3QgU3Vic2NyaXB0aW9uIEFQSXMuCiAgICovCiAgY29ubmVjdC5hZ2VudCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLklOSVQsIGYpOwogICAgaWYgKGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQpIHsKICAgICAgZihuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KICAgIHJldHVybiBzdWI7CiAgfTsKICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gZmFsc2U7CgogIGNvbm5lY3QuY29udGFjdCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICByZXR1cm4gYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5JVCwgZik7CiAgfTsKCiAgY29ubmVjdC5vbldlYnNvY2tldEluaXRGYWlsdXJlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIHZhciBzdWIgPSBidXMuc3Vic2NyaWJlKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSwgZik7CiAgICBpZiAoY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkKSB7CiAgICAgIGYoKTsKICAgIH0KICAgIHJldHVybiBzdWI7CiAgfTsKCiAgLyoqCiAgICogU3RhcnRzIHRoZSBnaXZlbiBmdW5jdGlvbiBhc3luY2hyb25vdXNseSBvbmx5IGlmIHRoZSBzaGFyZWQgd29ya2VyCiAgICogc2F5cyB3ZSBhcmUgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLiAgSWYgdGhlcmUgaXMgbm8gbWFzdGVyIGZvcgogICAqIHRoZSBnaXZlbiB0b3BpYywgd2UgYmVjb21lIHRoZSBtYXN0ZXIgYW5kIHN0YXJ0IHRoZSBmdW5jdGlvbiB1bmxlc3MKICAgKiBzaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUgaXMgdHJ1ZS4KICAgKgogICAqIEBwYXJhbSB0b3BpYyBUaGUgbWFzdGVyIHRvcGljIHdlIGFyZSBjb25jZXJuZWQgYWJvdXQuCiAgICogQHBhcmFtIGZfdHJ1ZSBUaGUgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgdGhlIG1hc3Rlci4KICAgKiBAcGFyYW0gZl9lbHNlIFtvcHRpb25hbF0gQSBjYWxsYmFjayB0byBiZSBpbnZva2VkIGlmIHdlIGFyZSBub3QgdGhlIG1hc3Rlci4KICAgKiBAcGFyYW0gc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIFtvcHRpb25hbF0gaWYgdHJ1ZSwgdGhpcyB0YWIgd29uJ3QgYmVjb21lIG1hc3Rlci4KICAgKi8KICBjb25uZWN0LmlmTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBmX3RydWUsIGZfZWxzZSwgc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZl90cnVlLCAiQSB0cnVlIGNhbGxiYWNrIG11c3QgYmUgcHJvdmlkZWQuIik7CgogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIC8vIFdlIGNhbid0IGJlIHRoZSBtYXN0ZXIgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50IQogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGNhbid0IGJlIHRoZSBtYXN0ZXIgZm9yIHRvcGljICclcycgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50ISIsIHRvcGljKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAoZl9lbHNlKSB7CiAgICAgICAgZl9lbHNlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBtYXN0ZXJDbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0TWFzdGVyQ2xpZW50KCk7CiAgICBtYXN0ZXJDbGllbnQuY2FsbChjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQ0hFQ0tfTUFTVEVSLCB7CiAgICAgIHRvcGljOiB0b3BpYywKICAgICAgc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lOiBzaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEuaXNNYXN0ZXIpIHsKICAgICAgICAgICAgZl90cnVlKCk7CgogICAgICAgICAgfSBlbHNlIGlmIChmX2Vsc2UpIHsKICAgICAgICAgICAgZl9lbHNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICB9OwoKICAvKioKICAgKiBOb3RpZnkgdGhlIHNoYXJlZCB3b3JrZXIgYW5kIG90aGVyIENDUCB0YWJzIHRoYXQgd2UgYXJlIG5vdyB0aGUgbWFzdGVyIGZvciB0aGUgZ2l2ZW4gdG9waWMuCiAgICovCiAgY29ubmVjdC5iZWNvbWVNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CgogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIC8vIFdlIGNhbid0IGJlIHRoZSBtYXN0ZXIgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50IQogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGNhbid0IGJlIHRoZSBtYXN0ZXIgZm9yIHRvcGljICclcycgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50ISIsIHRvcGljKTsKICAgICAgaWYgKGZhaWx1cmVDYWxsYmFjaykgewogICAgICAgIGZhaWx1cmVDYWxsYmFjaygpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgICBtYXN0ZXJDbGllbnQuY2FsbChjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQkVDT01FX01BU1RFUiwgewogICAgICAgIHRvcGljOiB0b3BpYwogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHN1Y2Nlc3NDYWxsYmFjaykgewogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2soKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbm5lY3QuQWdlbnQgPSBBZ2VudDsKICBjb25uZWN0LkFnZW50U25hcHNob3QgPSBBZ2VudFNuYXBzaG90OwogIGNvbm5lY3QuQ29udGFjdCA9IENvbnRhY3Q7CiAgY29ubmVjdC5Db250YWN0U25hcHNob3QgPSBDb250YWN0U25hcHNob3Q7CiAgLyoqIERlZmF1bHQgd2lsbCBnZXQgdGhlIFZvaWNlIGNvbm5lY3Rpb24gKi8KICBjb25uZWN0LkNvbm5lY3Rpb24gPSBWb2ljZUNvbm5lY3Rpb247CiAgY29ubmVjdC5CYXNlQ29ubmVjdGlvbiA9IENvbm5lY3Rpb247CiAgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24gPSBWb2ljZUNvbm5lY3Rpb247CiAgY29ubmVjdC5DaGF0Q29ubmVjdGlvbiA9IENoYXRDb25uZWN0aW9uOwogIGNvbm5lY3QuVGFza0Nvbm5lY3Rpb24gPSBUYXNrQ29ubmVjdGlvbjsKICBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCA9IENvbm5lY3Rpb25TbmFwc2hvdDsKICBjb25uZWN0LkVuZHBvaW50ID0gRW5kcG9pbnQ7CiAgY29ubmVjdC5BZGRyZXNzID0gRW5kcG9pbnQ7CiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvciA9IFNvZnRwaG9uZUVycm9yOwogIGNvbm5lY3QuVm9pY2VJZCA9IFZvaWNlSWQ7CiAgY29ubmVjdC5Db250YWN0UmVjb3JkaW5nID0gQ29udGFjdFJlY29yZGluZzsKfSkoKTsKCgoKLyoqKi8gfSksCgovKioqLyA4Mjc6Ci8qKiovICgobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSA9PiB7Cgp2YXIgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX187Ly8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi41NTMuMAovLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dAooZnVuY3Rpb24oKXtmdW5jdGlvbiByKGUsbix0KXtmdW5jdGlvbiBvKGksZil7aWYoIW5baV0pe2lmKCFlW2ldKXt2YXIgYz11bmRlZmluZWQ7aWYoIWYmJmMpcmV0dXJuIHJlcXVpcmUoaSwhMCk7aWYodSlyZXR1cm4gdShpLCEwKTt2YXIgYT1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitpKyInIik7dGhyb3cgYS5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixhfXZhciBwPW5baV09e2V4cG9ydHM6e319O2VbaV1bMF0uY2FsbChwLmV4cG9ydHMsZnVuY3Rpb24ocil7dmFyIG49ZVtpXVsxXVtyXTtyZXR1cm4gbyhufHxyKX0scCxwLmV4cG9ydHMscixlLG4sdCl9cmV0dXJuIG5baV0uZXhwb3J0c31mb3IodmFyIHU9dW5kZWZpbmVkLGk9MDtpPHQubGVuZ3RoO2krKylvKHRbaV0pO3JldHVybiBvfXJldHVybiByfSkoKSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInZlcnNpb24iOiAiMi4wIiwKICAgICJtZXRhZGF0YSI6IHsKICAgICAgImFwaVZlcnNpb24iOiAiMjAxNC0wNi0zMCIsCiAgICAgICJlbmRwb2ludFByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICAgImpzb25WZXJzaW9uIjogIjEuMSIsCiAgICAgICJwcm90b2NvbCI6ICJqc29uIiwKICAgICAgInNlcnZpY2VGdWxsTmFtZSI6ICJBbWF6b24gQ29nbml0byBJZGVudGl0eSIsCiAgICAgICJzZXJ2aWNlSWQiOiAiQ29nbml0byBJZGVudGl0eSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICAgInRhcmdldFByZWZpeCI6ICJBV1NDb2duaXRvSWRlbnRpdHlTZXJ2aWNlIiwKICAgICAgInVpZCI6ICJjb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAiCiAgICB9LAogICAgIm9wZXJhdGlvbnMiOiB7CiAgICAgICJDcmVhdGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9LAogICAgICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdXBwb3J0ZWRMb2dpblByb3ZpZGVycyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM4IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNmIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVsZXRlSWRlbnRpdGllcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZHNUb0RlbGV0ZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJVbnByb2Nlc3NlZElkZW50aXR5SWRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICAgICAgICJFcnJvckNvZGUiOiB7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlbGV0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzY3JpYmVJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTdSIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZXNjcmliZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQ3VzdG9tUm9sZUFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9LAogICAgICAgICAgICAgICAgIlNlY3JldEtleSI6IHt9LAogICAgICAgICAgICAgICAgIlNlc3Npb25Ub2tlbiI6IHt9LAogICAgICAgICAgICAgICAgIkV4cGlyYXRpb24iOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRJZCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2NvdW50SWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0SWRlbnRpdHlQb29sUm9sZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJSb2xlcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFiIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUm9sZU1hcHBpbmdzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWQiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRPcGVuSWRUb2tlbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3oiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0T3BlbklkVG9rZW5Gb3JEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiTG9naW5zIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3oiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJUb2tlbkR1cmF0aW9uIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdElkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiTWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJIaWRlRGlzYWJsZWQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0aWVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU3UiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJMaXN0SWRlbnRpdHlQb29scyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiTWF4UmVzdWx0cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29scyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdFRhZ3NGb3JSZXNvdXJjZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUmVzb3VyY2VBcm4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVGFncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJMb29rdXBEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiOiB7fSwKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXJMaXN0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJNZXJnZURldmVsb3BlcklkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICAgIkRlc3RpbmF0aW9uVXNlcklkZW50aWZpZXIiLAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIiwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiU291cmNlVXNlcklkZW50aWZpZXIiOiB7fSwKICAgICAgICAgICAgIkRlc3RpbmF0aW9uVXNlcklkZW50aWZpZXIiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJSb2xlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJSb2xlcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFiIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUm9sZU1hcHBpbmdzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWQiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJUYWdSZXNvdXJjZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUmVzb3VyY2VBcm4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgICAiVGFncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVubGlua0RldmVsb3BlcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIiwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSIsCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbmxpbmtJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIsCiAgICAgICAgICAgICJMb2dpbnMiLAogICAgICAgICAgICAiTG9naW5zVG9SZW1vdmUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiTG9naW5zVG9SZW1vdmUiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN2IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW50YWdSZXNvdXJjZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUmVzb3VyY2VBcm4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgICAiVGFnS2V5cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVXBkYXRlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgInNoYXBlcyI6IHsKICAgICAgIlM0IjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgIH0sCiAgICAgICJTOCI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjoge30KICAgICAgfSwKICAgICAgIlNhIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIkNsaWVudElkIjoge30sCiAgICAgICAgICAgICJTZXJ2ZXJTaWRlVG9rZW5DaGVjayI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2YiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTZyI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiU2oiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9LAogICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgIH0sCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiT3BlbklkQ29ubmVjdFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM4IgogICAgICAgICAgfSwKICAgICAgICAgICJDb2duaXRvSWRlbnRpdHlQcm92aWRlcnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTYSIKICAgICAgICAgIH0sCiAgICAgICAgICAiU2FtbFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNmIgogICAgICAgICAgfSwKICAgICAgICAgICJJZGVudGl0eVBvb2xUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU3UiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiU3YiCiAgICAgICAgICB9LAogICAgICAgICAgIkNyZWF0aW9uRGF0ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfSwKICAgICAgICAgICJMYXN0TW9kaWZpZWREYXRlIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU3YiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTeiI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzFiIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgIH0sCiAgICAgICJTMWQiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlR5cGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJUeXBlIjoge30sCiAgICAgICAgICAgICJBbWJpZ3VvdXNSb2xlUmVzb2x1dGlvbiI6IHt9LAogICAgICAgICAgICAiUnVsZXNDb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgIlJ1bGVzIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiUnVsZXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgIkNsYWltIiwKICAgICAgICAgICAgICAgICAgICAgICJNYXRjaFR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgIlZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIgogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAiQ2xhaW0iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJNYXRjaFR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJWYWx1ZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIlJvbGVBUk4iOiB7fQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB9LHt9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAicGFnaW5hdGlvbiI6IHsKICAgIH0KICB9CiAgCiAgfSx7fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInZlcnNpb24iOiAiMi4wIiwKICAgICJtZXRhZGF0YSI6IHsKICAgICAgImFwaVZlcnNpb24iOiAiMjAxNy0wMi0xNSIsCiAgICAgICJlbmRwb2ludFByZWZpeCI6ICJjb25uZWN0IiwKICAgICAgImpzb25WZXJzaW9uIjogIjEuMCIsCiAgICAgICJwcm90b2NvbCI6ICJqc29uIiwKICAgICAgInNlcnZpY2VBYmJyZXZpYXRpb24iOiAiQ29ubmVjdCIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uQ29ubmVjdENUSVNlcnZpY2UiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICIiLAogICAgICAidGFyZ2V0UHJlZml4IjogIkFtYXpvbkNvbm5lY3RDVElTZXJ2aWNlIiwKICAgICAgInVpZCI6ICJjb25uZWN0LTIwMTctMDItMTUiCiAgICB9LAogICAgIm9wZXJhdGlvbnMiOiB7CiAgICAgICJBY2NlcHRDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ2xlYXJDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ29tcGxldGVDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ29uZmVyZW5jZUNvbm5lY3Rpb25zIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlQWRkaXRpb25hbENvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJlbmRwb2ludCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDcmVhdGVPdXRib3VuZENvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImVuZHBvaW50IgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicXVldWVBUk4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlVGFza0NvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImVuZHBvaW50IiwKICAgICAgICAgICAgIm5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJwcmV2aW91c0NvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiaWRlbXBvdGVuY3lUb2tlbiI6IHt9LAogICAgICAgICAgICAic2NoZWR1bGVkVGltZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDcmVhdGVUcmFuc3BvcnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInRyYW5zcG9ydFR5cGUiLAogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ0cmFuc3BvcnRUeXBlIjoge30sCiAgICAgICAgICAgICJwYXJ0aWNpcGFudElkIjoge30sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgInNvZnRwaG9uZUNsaWVudElkIjoge30sCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ3ZWJTb2NrZXRUcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAidXJsIiwKICAgICAgICAgICAgICAgICJ0cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInVybCI6IHt9LAogICAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNoYXRUb2tlblRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJwYXJ0aWNpcGFudFRva2VuIiwKICAgICAgICAgICAgICAgICJleHBpcnkiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJwYXJ0aWNpcGFudFRva2VuIjoge30sCiAgICAgICAgICAgICAgICAiZXhwaXJ5Ijoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzb2Z0cGhvbmVUcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFDb25uZWN0aW9ucyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIiwKICAgICAgICAgICAgICAgICAgICAgICJjcmVkZW50aWFsIiwKICAgICAgICAgICAgICAgICAgICAgICJ1cmxzIgogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidXNlcm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJjcmVkZW50aWFsIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAidXJscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlc3Ryb3lDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRDb25maWd1cmF0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFoIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRQZXJtaXNzaW9ucyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJwZXJtaXNzaW9ucyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInBlcm1pc3Npb25zIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRBZ2VudFNuYXBzaG90IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAidGltZW91dCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInNuYXBzaG90IiwKICAgICAgICAgICAgIm5leHRUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInNuYXBzaG90IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICJjb250YWN0cyIsCiAgICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibmV4dFN0YXRlIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJhZ2VudEF2YWlsYWJpbGl0eVN0YXRlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAidGltZVN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjb250YWN0cyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbnMiLAogICAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsQ29udGFjdElkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAicXVldWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAicXVldWVUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImluaXRpYWwiCiAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUluZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhdXRvQWNjZXB0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZWRpYUxlZ0NvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsQ29udGV4dFRva2VuIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb25maWdKc29uIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0TWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdEF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25EYXRhIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImN1c3RvbWVyTmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9uaXRvcmluZ0luZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFnZW50TmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9pblRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZm9yY2VkTXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAicXVpY2tDb25uZWN0TmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JDYXBhYmlsaXRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9uaXRvclN0YXRlIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSIKICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3REdXJhdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhdGlvbk1ldGhvZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RGZWF0dXJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgImF0dGFjaG1lbnRzRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnaW5nTWFya2Rvd25FbmFibGVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJtdWx0aVBhcnR5Q29uZmVyZW5jZUVuYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJjaGFubmVsQ29udGV4dCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInNjaGVkdWxlZFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRhc2tUZW1wbGF0ZUlkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRhc2tUZW1wbGF0ZVZlcnNpb24iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRTdGF0ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAic3RhdGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAic3RhdGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RGlhbGFibGVDb3VudHJ5Q29kZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY291bnRyeUNvZGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY291bnRyeUNvZGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRFbmRwb2ludHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInF1ZXVlQVJOcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiZW5kcG9pbnRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXROZXdBdXRoVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAibmV3QXV0aFRva2VuIjoge30sCiAgICAgICAgICAgICJleHBpcmF0aW9uRGF0ZVRpbWUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iOiB7fSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInF1ZXVlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInF1ZXVlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiSG9sZENvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJNdXRlUGFydGljaXBhbnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJOb3RpZnlDb250YWN0SXNzdWUiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiaXNzdWVDb2RlIjoge30sCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAiY2xpZW50TG9ncyI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJQdXRBZ2VudFN0YXRlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJzdGF0ZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJlbnF1ZXVlTmV4dFN0YXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlJlamVjdENvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJSZXN1bWVDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZENsaWVudExvZ3MiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImxvZ0V2ZW50cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImxvZ0V2ZW50cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgImNvbXBvbmVudCI6IHt9LAogICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kRGlnaXRzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIiwKICAgICAgICAgICAgImRpZ2l0cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAgICJkaWdpdHMiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzN2IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kU29mdHBob25lQ2FsbFJlcG9ydCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgInJlcG9ydCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAicmVwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiY2FsbFN0YXJ0VGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjYWxsRW5kVGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzN2IgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJndW1UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpbml0aWFsaXphdGlvblRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZVRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInByZVRhbGtUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ0YWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY2xlYW51cFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImd1bU90aGVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZ3VtVGltZW91dEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNyZWF0ZU9mZmVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInVzZXJCdXN5RmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbm11dGVQYXJ0aWNpcGFudCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29uZmlndXJhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxaCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgInNoYXBlcyI6IHsKICAgICAgIlMyIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYWdlbnRBUk4iOiB7fSwKICAgICAgICAgICJhdXRoVG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInR5cGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJlbmRwb2ludEFSTiI6IHt9LAogICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAicGhvbmVOdW1iZXIiOiB7fSwKICAgICAgICAgICJhZ2VudExvZ2luIjoge30sCiAgICAgICAgICAicXVldWUiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTayI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInF1ZXVlQVJOIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU3IiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInZhbHVlIiwKICAgICAgICAgICAgInR5cGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ2YWx1ZSI6IHt9LAogICAgICAgICAgICAidHlwZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUzFoIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIm5hbWUiLAogICAgICAgICAgInNvZnRwaG9uZUVuYWJsZWQiLAogICAgICAgICAgInNvZnRwaG9uZUF1dG9BY2NlcHQiLAogICAgICAgICAgImV4dGVuc2lvbiIsCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAidXNlcm5hbWUiOiB7fSwKICAgICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJleHRlbnNpb24iOiB7fSwKICAgICAgICAgICJyb3V0aW5nUHJvZmlsZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iOiB7fSwKICAgICAgICAgICAgICAiZGVmYXVsdE91dGJvdW5kUXVldWUiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiY2hhbm5lbENvbmN1cnJlbmN5TWFwIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAiYWdlbnRQcmVmZXJlbmNlcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlMyMCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICJuYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYWdlbnRTdGF0ZUFSTiI6IHt9LAogICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAic3RhcnRUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTM3YiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1UeXBlIjoge30sCiAgICAgICAgICAgICJwYWNrZXRDb3VudCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicGFja2V0c0xvc3QiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImF1ZGlvTGV2ZWwiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiZG91YmxlIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiaml0dGVyQnVmZmVyTWlsbGlzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJyb3VuZFRyaXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgfSx7fV0sNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgImFjbSI6IHsKICAgICAgIm5hbWUiOiAiQUNNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwaWdhdGV3YXkiOiB7CiAgICAgICJuYW1lIjogIkFQSUdhdGV3YXkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwbGljYXRpb25hdXRvc2NhbGluZyI6IHsKICAgICAgInByZWZpeCI6ICJhcHBsaWNhdGlvbi1hdXRvc2NhbGluZyIsCiAgICAgICJuYW1lIjogIkFwcGxpY2F0aW9uQXV0b1NjYWxpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwc3RyZWFtIjogewogICAgICAibmFtZSI6ICJBcHBTdHJlYW0iCiAgICB9LAogICAgImF1dG9zY2FsaW5nIjogewogICAgICAibmFtZSI6ICJBdXRvU2NhbGluZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJiYXRjaCI6IHsKICAgICAgIm5hbWUiOiAiQmF0Y2giCiAgICB9LAogICAgImJ1ZGdldHMiOiB7CiAgICAgICJuYW1lIjogIkJ1ZGdldHMiCiAgICB9LAogICAgImNsb3VkZGlyZWN0b3J5IjogewogICAgICAibmFtZSI6ICJDbG91ZERpcmVjdG9yeSIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNi0wNS0xMCoiCiAgICAgIF0KICAgIH0sCiAgICAiY2xvdWRmb3JtYXRpb24iOiB7CiAgICAgICJuYW1lIjogIkNsb3VkRm9ybWF0aW9uIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3VkZnJvbnQiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkRnJvbnQiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTMtMDUtMTIqIiwKICAgICAgICAiMjAxMy0xMS0xMSoiLAogICAgICAgICIyMDE0LTA1LTMxKiIsCiAgICAgICAgIjIwMTQtMTAtMjEqIiwKICAgICAgICAiMjAxNC0xMS0wNioiLAogICAgICAgICIyMDE1LTA0LTE3KiIsCiAgICAgICAgIjIwMTUtMDctMjcqIiwKICAgICAgICAiMjAxNS0wOS0xNyoiLAogICAgICAgICIyMDE2LTAxLTEzKiIsCiAgICAgICAgIjIwMTYtMDEtMjgqIiwKICAgICAgICAiMjAxNi0wOC0wMSoiLAogICAgICAgICIyMDE2LTA4LTIwKiIsCiAgICAgICAgIjIwMTYtMDktMDcqIiwKICAgICAgICAiMjAxNi0wOS0yOSoiLAogICAgICAgICIyMDE2LTExLTI1KiIsCiAgICAgICAgIjIwMTctMDMtMjUqIiwKICAgICAgICAiMjAxNy0xMC0zMCoiLAogICAgICAgICIyMDE4LTA2LTE4KiIsCiAgICAgICAgIjIwMTgtMTEtMDUqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWRoc20iOiB7CiAgICAgICJuYW1lIjogIkNsb3VkSFNNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkc2VhcmNoIjogewogICAgICAibmFtZSI6ICJDbG91ZFNlYXJjaCIKICAgIH0sCiAgICAiY2xvdWRzZWFyY2hkb21haW4iOiB7CiAgICAgICJuYW1lIjogIkNsb3VkU2VhcmNoRG9tYWluIgogICAgfSwKICAgICJjbG91ZHRyYWlsIjogewogICAgICAibmFtZSI6ICJDbG91ZFRyYWlsIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2giOiB7CiAgICAgICJwcmVmaXgiOiAibW9uaXRvcmluZyIsCiAgICAgICJuYW1lIjogIkNsb3VkV2F0Y2giLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWR3YXRjaGV2ZW50cyI6IHsKICAgICAgInByZWZpeCI6ICJldmVudHMiLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoRXZlbnRzIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE0LTAyLTAzKiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2hsb2dzIjogewogICAgICAicHJlZml4IjogImxvZ3MiLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoTG9ncyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlYnVpbGQiOiB7CiAgICAgICJuYW1lIjogIkNvZGVCdWlsZCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlY29tbWl0IjogewogICAgICAibmFtZSI6ICJDb2RlQ29tbWl0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVkZXBsb3kiOiB7CiAgICAgICJuYW1lIjogIkNvZGVEZXBsb3kiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZXBpcGVsaW5lIjogewogICAgICAibmFtZSI6ICJDb2RlUGlwZWxpbmUiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29nbml0b2lkZW50aXR5IjogewogICAgICAicHJlZml4IjogImNvZ25pdG8taWRlbnRpdHkiLAogICAgICAibmFtZSI6ICJDb2duaXRvSWRlbnRpdHkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29nbml0b2lkZW50aXR5c2VydmljZXByb3ZpZGVyIjogewogICAgICAicHJlZml4IjogImNvZ25pdG8taWRwIiwKICAgICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5U2VydmljZVByb3ZpZGVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9zeW5jIjogewogICAgICAicHJlZml4IjogImNvZ25pdG8tc3luYyIsCiAgICAgICJuYW1lIjogIkNvZ25pdG9TeW5jIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvbmZpZ3NlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiY29uZmlnIiwKICAgICAgIm5hbWUiOiAiQ29uZmlnU2VydmljZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb25uZWN0IjogewogICAgICAibmFtZSI6ICJDb25uZWN0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImN1ciI6IHsKICAgICAgIm5hbWUiOiAiQ1VSIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImRhdGFwaXBlbGluZSI6IHsKICAgICAgIm5hbWUiOiAiRGF0YVBpcGVsaW5lIgogICAgfSwKICAgICJkZXZpY2VmYXJtIjogewogICAgICAibmFtZSI6ICJEZXZpY2VGYXJtIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImRpcmVjdGNvbm5lY3QiOiB7CiAgICAgICJuYW1lIjogIkRpcmVjdENvbm5lY3QiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGlyZWN0b3J5c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJkcyIsCiAgICAgICJuYW1lIjogIkRpcmVjdG9yeVNlcnZpY2UiCiAgICB9LAogICAgImRpc2NvdmVyeSI6IHsKICAgICAgIm5hbWUiOiAiRGlzY292ZXJ5IgogICAgfSwKICAgICJkbXMiOiB7CiAgICAgICJuYW1lIjogIkRNUyIKICAgIH0sCiAgICAiZHluYW1vZGIiOiB7CiAgICAgICJuYW1lIjogIkR5bmFtb0RCIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImR5bmFtb2Ric3RyZWFtcyI6IHsKICAgICAgInByZWZpeCI6ICJzdHJlYW1zLmR5bmFtb2RiIiwKICAgICAgIm5hbWUiOiAiRHluYW1vREJTdHJlYW1zIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjMiI6IHsKICAgICAgIm5hbWUiOiAiRUMyIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEzLTA2LTE1KiIsCiAgICAgICAgIjIwMTMtMTAtMTUqIiwKICAgICAgICAiMjAxNC0wMi0wMSoiLAogICAgICAgICIyMDE0LTA1LTAxKiIsCiAgICAgICAgIjIwMTQtMDYtMTUqIiwKICAgICAgICAiMjAxNC0wOS0wMSoiLAogICAgICAgICIyMDE0LTEwLTAxKiIsCiAgICAgICAgIjIwMTUtMDMtMDEqIiwKICAgICAgICAiMjAxNS0wNC0xNSoiLAogICAgICAgICIyMDE1LTEwLTAxKiIsCiAgICAgICAgIjIwMTYtMDQtMDEqIiwKICAgICAgICAiMjAxNi0wOS0xNSoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlY3IiOiB7CiAgICAgICJuYW1lIjogIkVDUiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlY3MiOiB7CiAgICAgICJuYW1lIjogIkVDUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlZnMiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2ZpbGVzeXN0ZW0iLAogICAgICAibmFtZSI6ICJFRlMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxhc3RpY2FjaGUiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aUNhY2hlIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEyLTExLTE1KiIsCiAgICAgICAgIjIwMTQtMDMtMjQqIiwKICAgICAgICAiMjAxNC0wNy0xNSoiLAogICAgICAgICIyMDE0LTA5LTMwKiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYXN0aWNiZWFuc3RhbGsiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aWNCZWFuc3RhbGsiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxiIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5nIiwKICAgICAgIm5hbWUiOiAiRUxCIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYnYyIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5ndjIiLAogICAgICAibmFtZSI6ICJFTEJ2MiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbXIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY21hcHJlZHVjZSIsCiAgICAgICJuYW1lIjogIkVNUiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlcyI6IHsKICAgICAgIm5hbWUiOiAiRVMiCiAgICB9LAogICAgImVsYXN0aWN0cmFuc2NvZGVyIjogewogICAgICAibmFtZSI6ICJFbGFzdGljVHJhbnNjb2RlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJmaXJlaG9zZSI6IHsKICAgICAgIm5hbWUiOiAiRmlyZWhvc2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZ2FtZWxpZnQiOiB7CiAgICAgICJuYW1lIjogIkdhbWVMaWZ0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImdsYWNpZXIiOiB7CiAgICAgICJuYW1lIjogIkdsYWNpZXIiCiAgICB9LAogICAgImhlYWx0aCI6IHsKICAgICAgIm5hbWUiOiAiSGVhbHRoIgogICAgfSwKICAgICJpYW0iOiB7CiAgICAgICJuYW1lIjogIklBTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpbXBvcnRleHBvcnQiOiB7CiAgICAgICJuYW1lIjogIkltcG9ydEV4cG9ydCIKICAgIH0sCiAgICAiaW5zcGVjdG9yIjogewogICAgICAibmFtZSI6ICJJbnNwZWN0b3IiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTUtMDgtMTgqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90IjogewogICAgICAibmFtZSI6ICJJb3QiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90ZGF0YSI6IHsKICAgICAgInByZWZpeCI6ICJpb3QtZGF0YSIsCiAgICAgICJuYW1lIjogIklvdERhdGEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpcyI6IHsKICAgICAgIm5hbWUiOiAiS2luZXNpcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzYW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzIgogICAgfSwKICAgICJrbXMiOiB7CiAgICAgICJuYW1lIjogIktNUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsYW1iZGEiOiB7CiAgICAgICJuYW1lIjogIkxhbWJkYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsZXhydW50aW1lIjogewogICAgICAicHJlZml4IjogInJ1bnRpbWUubGV4IiwKICAgICAgIm5hbWUiOiAiTGV4UnVudGltZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsaWdodHNhaWwiOiB7CiAgICAgICJuYW1lIjogIkxpZ2h0c2FpbCIKICAgIH0sCiAgICAibWFjaGluZWxlYXJuaW5nIjogewogICAgICAibmFtZSI6ICJNYWNoaW5lTGVhcm5pbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWFya2V0cGxhY2Vjb21tZXJjZWFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiTWFya2V0cGxhY2VDb21tZXJjZUFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtYXJrZXRwbGFjZW1ldGVyaW5nIjogewogICAgICAicHJlZml4IjogIm1ldGVyaW5nbWFya2V0cGxhY2UiLAogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZU1ldGVyaW5nIgogICAgfSwKICAgICJtdHVyayI6IHsKICAgICAgInByZWZpeCI6ICJtdHVyay1yZXF1ZXN0ZXIiLAogICAgICAibmFtZSI6ICJNVHVyayIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtb2JpbGVhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIk1vYmlsZUFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJvcHN3b3JrcyI6IHsKICAgICAgIm5hbWUiOiAiT3BzV29ya3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAib3Bzd29ya3NjbSI6IHsKICAgICAgIm5hbWUiOiAiT3BzV29ya3NDTSIKICAgIH0sCiAgICAib3JnYW5pemF0aW9ucyI6IHsKICAgICAgIm5hbWUiOiAiT3JnYW5pemF0aW9ucyIKICAgIH0sCiAgICAicGlucG9pbnQiOiB7CiAgICAgICJuYW1lIjogIlBpbnBvaW50IgogICAgfSwKICAgICJwb2xseSI6IHsKICAgICAgIm5hbWUiOiAiUG9sbHkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmRzIjogewogICAgICAibmFtZSI6ICJSRFMiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTQtMDktMDEqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVkc2hpZnQiOiB7CiAgICAgICJuYW1lIjogIlJlZHNoaWZ0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJla29nbml0aW9uIjogewogICAgICAibmFtZSI6ICJSZWtvZ25pdGlvbiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZXNvdXJjZWdyb3Vwc3RhZ2dpbmdhcGkiOiB7CiAgICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzVGFnZ2luZ0FQSSIKICAgIH0sCiAgICAicm91dGU1MyI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1MyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyb3V0ZTUzZG9tYWlucyI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1M0RvbWFpbnMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiczMiOiB7CiAgICAgICJuYW1lIjogIlMzIiwKICAgICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzM2NvbnRyb2wiOiB7CiAgICAgICJuYW1lIjogIlMzQ29udHJvbCIsCiAgICAgICJkdWFsc3RhY2tBdmFpbGFibGUiOiB0cnVlCiAgICB9LAogICAgInNlcnZpY2VjYXRhbG9nIjogewogICAgICAibmFtZSI6ICJTZXJ2aWNlQ2F0YWxvZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzZXMiOiB7CiAgICAgICJwcmVmaXgiOiAiZW1haWwiLAogICAgICAibmFtZSI6ICJTRVMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic2hpZWxkIjogewogICAgICAibmFtZSI6ICJTaGllbGQiCiAgICB9LAogICAgInNpbXBsZWRiIjogewogICAgICAicHJlZml4IjogInNkYiIsCiAgICAgICJuYW1lIjogIlNpbXBsZURCIgogICAgfSwKICAgICJzbXMiOiB7CiAgICAgICJuYW1lIjogIlNNUyIKICAgIH0sCiAgICAic25vd2JhbGwiOiB7CiAgICAgICJuYW1lIjogIlNub3diYWxsIgogICAgfSwKICAgICJzbnMiOiB7CiAgICAgICJuYW1lIjogIlNOUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzcXMiOiB7CiAgICAgICJuYW1lIjogIlNRUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzc20iOiB7CiAgICAgICJuYW1lIjogIlNTTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdG9yYWdlZ2F0ZXdheSI6IHsKICAgICAgIm5hbWUiOiAiU3RvcmFnZUdhdGV3YXkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic3RlcGZ1bmN0aW9ucyI6IHsKICAgICAgInByZWZpeCI6ICJzdGF0ZXMiLAogICAgICAibmFtZSI6ICJTdGVwRnVuY3Rpb25zIgogICAgfSwKICAgICJzdHMiOiB7CiAgICAgICJuYW1lIjogIlNUUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdXBwb3J0IjogewogICAgICAibmFtZSI6ICJTdXBwb3J0IgogICAgfSwKICAgICJzd2YiOiB7CiAgICAgICJuYW1lIjogIlNXRiIKICAgIH0sCiAgICAieHJheSI6IHsKICAgICAgIm5hbWUiOiAiWFJheSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJ3YWYiOiB7CiAgICAgICJuYW1lIjogIldBRiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJ3YWZyZWdpb25hbCI6IHsKICAgICAgInByZWZpeCI6ICJ3YWYtcmVnaW9uYWwiLAogICAgICAibmFtZSI6ICJXQUZSZWdpb25hbCIKICAgIH0sCiAgICAid29ya2RvY3MiOiB7CiAgICAgICJuYW1lIjogIldvcmtEb2NzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndvcmtzcGFjZXMiOiB7CiAgICAgICJuYW1lIjogIldvcmtTcGFjZXMiCiAgICB9LAogICAgImNvZGVzdGFyIjogewogICAgICAibmFtZSI6ICJDb2RlU3RhciIKICAgIH0sCiAgICAibGV4bW9kZWxidWlsZGluZ3NlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAibGV4LW1vZGVscyIsCiAgICAgICJuYW1lIjogIkxleE1vZGVsQnVpbGRpbmdTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1hcmtldHBsYWNlZW50aXRsZW1lbnRzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImVudGl0bGVtZW50Lm1hcmtldHBsYWNlIiwKICAgICAgIm5hbWUiOiAiTWFya2V0cGxhY2VFbnRpdGxlbWVudFNlcnZpY2UiCiAgICB9LAogICAgImF0aGVuYSI6IHsKICAgICAgIm5hbWUiOiAiQXRoZW5hIgogICAgfSwKICAgICJncmVlbmdyYXNzIjogewogICAgICAibmFtZSI6ICJHcmVlbmdyYXNzIgogICAgfSwKICAgICJkYXgiOiB7CiAgICAgICJuYW1lIjogIkRBWCIKICAgIH0sCiAgICAibWlncmF0aW9uaHViIjogewogICAgICAicHJlZml4IjogIkFXU01pZ3JhdGlvbkh1YiIsCiAgICAgICJuYW1lIjogIk1pZ3JhdGlvbkh1YiIKICAgIH0sCiAgICAiY2xvdWRoc212MiI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRIU01WMiIKICAgIH0sCiAgICAiZ2x1ZSI6IHsKICAgICAgIm5hbWUiOiAiR2x1ZSIKICAgIH0sCiAgICAibW9iaWxlIjogewogICAgICAibmFtZSI6ICJNb2JpbGUiCiAgICB9LAogICAgInByaWNpbmciOiB7CiAgICAgICJuYW1lIjogIlByaWNpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29zdGV4cGxvcmVyIjogewogICAgICAicHJlZml4IjogImNlIiwKICAgICAgIm5hbWUiOiAiQ29zdEV4cGxvcmVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1lZGlhY29udmVydCI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFDb252ZXJ0IgogICAgfSwKICAgICJtZWRpYWxpdmUiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhTGl2ZSIKICAgIH0sCiAgICAibWVkaWFwYWNrYWdlIjogewogICAgICAibmFtZSI6ICJNZWRpYVBhY2thZ2UiCiAgICB9LAogICAgIm1lZGlhc3RvcmUiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhU3RvcmUiCiAgICB9LAogICAgIm1lZGlhc3RvcmVkYXRhIjogewogICAgICAicHJlZml4IjogIm1lZGlhc3RvcmUtZGF0YSIsCiAgICAgICJuYW1lIjogIk1lZGlhU3RvcmVEYXRhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcHN5bmMiOiB7CiAgICAgICJuYW1lIjogIkFwcFN5bmMiCiAgICB9LAogICAgImd1YXJkZHV0eSI6IHsKICAgICAgIm5hbWUiOiAiR3VhcmREdXR5IgogICAgfSwKICAgICJtcSI6IHsKICAgICAgIm5hbWUiOiAiTVEiCiAgICB9LAogICAgImNvbXByZWhlbmQiOiB7CiAgICAgICJuYW1lIjogIkNvbXByZWhlbmQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90am9ic2RhdGFwbGFuZSI6IHsKICAgICAgInByZWZpeCI6ICJpb3Qtam9icy1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW9USm9ic0RhdGFQbGFuZSIKICAgIH0sCiAgICAia2luZXNpc3ZpZGVvYXJjaGl2ZWRtZWRpYSI6IHsKICAgICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLWFyY2hpdmVkLW1lZGlhIiwKICAgICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvQXJjaGl2ZWRNZWRpYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzdmlkZW9tZWRpYSI6IHsKICAgICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLW1lZGlhIiwKICAgICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvTWVkaWEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc3ZpZGVvIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW8iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic2FnZW1ha2VycnVudGltZSI6IHsKICAgICAgInByZWZpeCI6ICJydW50aW1lLnNhZ2VtYWtlciIsCiAgICAgICJuYW1lIjogIlNhZ2VNYWtlclJ1bnRpbWUiCiAgICB9LAogICAgInNhZ2VtYWtlciI6IHsKICAgICAgIm5hbWUiOiAiU2FnZU1ha2VyIgogICAgfSwKICAgICJ0cmFuc2xhdGUiOiB7CiAgICAgICJuYW1lIjogIlRyYW5zbGF0ZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZXNvdXJjZWdyb3VwcyI6IHsKICAgICAgInByZWZpeCI6ICJyZXNvdXJjZS1ncm91cHMiLAogICAgICAibmFtZSI6ICJSZXNvdXJjZUdyb3VwcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhbGV4YWZvcmJ1c2luZXNzIjogewogICAgICAibmFtZSI6ICJBbGV4YUZvckJ1c2luZXNzIgogICAgfSwKICAgICJjbG91ZDkiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkOSIKICAgIH0sCiAgICAic2VydmVybGVzc2FwcGxpY2F0aW9ucmVwb3NpdG9yeSI6IHsKICAgICAgInByZWZpeCI6ICJzZXJ2ZXJsZXNzcmVwbyIsCiAgICAgICJuYW1lIjogIlNlcnZlcmxlc3NBcHBsaWNhdGlvblJlcG9zaXRvcnkiCiAgICB9LAogICAgInNlcnZpY2VkaXNjb3ZlcnkiOiB7CiAgICAgICJuYW1lIjogIlNlcnZpY2VEaXNjb3ZlcnkiCiAgICB9LAogICAgIndvcmttYWlsIjogewogICAgICAibmFtZSI6ICJXb3JrTWFpbCIKICAgIH0sCiAgICAiYXV0b3NjYWxpbmdwbGFucyI6IHsKICAgICAgInByZWZpeCI6ICJhdXRvc2NhbGluZy1wbGFucyIsCiAgICAgICJuYW1lIjogIkF1dG9TY2FsaW5nUGxhbnMiCiAgICB9LAogICAgInRyYW5zY3JpYmVzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogInRyYW5zY3JpYmUiLAogICAgICAibmFtZSI6ICJUcmFuc2NyaWJlU2VydmljZSIKICAgIH0sCiAgICAiY29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiQ29ubmVjdCIKICAgIH0sCiAgICAiYWNtcGNhIjogewogICAgICAicHJlZml4IjogImFjbS1wY2EiLAogICAgICAibmFtZSI6ICJBQ01QQ0EiCiAgICB9LAogICAgImZtcyI6IHsKICAgICAgIm5hbWUiOiAiRk1TIgogICAgfSwKICAgICJzZWNyZXRzbWFuYWdlciI6IHsKICAgICAgIm5hbWUiOiAiU2VjcmV0c01hbmFnZXIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90YW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJJb1RBbmFseXRpY3MiLAogICAgICAiY29ycyI6IHRydWUJCiAgICB9LAogICAgImlvdDFjbGlja2RldmljZXNzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImlvdDFjbGljay1kZXZpY2VzIiwKICAgICAgIm5hbWUiOiAiSW9UMUNsaWNrRGV2aWNlc1NlcnZpY2UiCiAgICB9LAogICAgImlvdDFjbGlja3Byb2plY3RzIjogewogICAgICAicHJlZml4IjogImlvdDFjbGljay1wcm9qZWN0cyIsCiAgICAgICJuYW1lIjogIklvVDFDbGlja1Byb2plY3RzIgogICAgfSwKICAgICJwaSI6IHsKICAgICAgIm5hbWUiOiAiUEkiCiAgICB9LAogICAgIm5lcHR1bmUiOiB7CiAgICAgICJuYW1lIjogIk5lcHR1bmUiCiAgICB9LAogICAgIm1lZGlhdGFpbG9yIjogewogICAgICAibmFtZSI6ICJNZWRpYVRhaWxvciIKICAgIH0sCiAgICAiZWtzIjogewogICAgICAibmFtZSI6ICJFS1MiCiAgICB9LAogICAgIm1hY2llIjogewogICAgICAibmFtZSI6ICJNYWNpZSIKICAgIH0sCiAgICAiZGxtIjogewogICAgICAibmFtZSI6ICJETE0iCiAgICB9LAogICAgInNpZ25lciI6IHsKICAgICAgIm5hbWUiOiAiU2lnbmVyIgogICAgfSwKICAgICJjaGltZSI6IHsKICAgICAgIm5hbWUiOiAiQ2hpbWUiCiAgICB9LAogICAgInBpbnBvaW50ZW1haWwiOiB7CiAgICAgICJwcmVmaXgiOiAicGlucG9pbnQtZW1haWwiLAogICAgICAibmFtZSI6ICJQaW5wb2ludEVtYWlsIgogICAgfSwKICAgICJyYW0iOiB7CiAgICAgICJuYW1lIjogIlJBTSIKICAgIH0sCiAgICAicm91dGU1M3Jlc29sdmVyIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzUmVzb2x2ZXIiCiAgICB9LAogICAgInBpbnBvaW50c21zdm9pY2UiOiB7CiAgICAgICJwcmVmaXgiOiAic21zLXZvaWNlIiwKICAgICAgIm5hbWUiOiAiUGlucG9pbnRTTVNWb2ljZSIKICAgIH0sCiAgICAicXVpY2tzaWdodCI6IHsKICAgICAgIm5hbWUiOiAiUXVpY2tTaWdodCIKICAgIH0sCiAgICAicmRzZGF0YXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAicmRzLWRhdGEiLAogICAgICAibmFtZSI6ICJSRFNEYXRhU2VydmljZSIKICAgIH0sCiAgICAiYW1wbGlmeSI6IHsKICAgICAgIm5hbWUiOiAiQW1wbGlmeSIKICAgIH0sCiAgICAiZGF0YXN5bmMiOiB7CiAgICAgICJuYW1lIjogIkRhdGFTeW5jIgogICAgfSwKICAgICJyb2JvbWFrZXIiOiB7CiAgICAgICJuYW1lIjogIlJvYm9NYWtlciIKICAgIH0sCiAgICAidHJhbnNmZXIiOiB7CiAgICAgICJuYW1lIjogIlRyYW5zZmVyIgogICAgfSwKICAgICJnbG9iYWxhY2NlbGVyYXRvciI6IHsKICAgICAgIm5hbWUiOiAiR2xvYmFsQWNjZWxlcmF0b3IiCiAgICB9LAogICAgImNvbXByZWhlbmRtZWRpY2FsIjogewogICAgICAibmFtZSI6ICJDb21wcmVoZW5kTWVkaWNhbCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzYW5hbHl0aWNzdjIiOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3NWMiIKICAgIH0sCiAgICAibWVkaWFjb25uZWN0IjogewogICAgICAibmFtZSI6ICJNZWRpYUNvbm5lY3QiCiAgICB9LAogICAgImZzeCI6IHsKICAgICAgIm5hbWUiOiAiRlN4IgogICAgfSwKICAgICJzZWN1cml0eWh1YiI6IHsKICAgICAgIm5hbWUiOiAiU2VjdXJpdHlIdWIiCiAgICB9LAogICAgImFwcG1lc2giOiB7CiAgICAgICJuYW1lIjogIkFwcE1lc2giLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTgtMTAtMDEqIgogICAgICBdCiAgICB9LAogICAgImxpY2Vuc2VtYW5hZ2VyIjogewogICAgICAicHJlZml4IjogImxpY2Vuc2UtbWFuYWdlciIsCiAgICAgICJuYW1lIjogIkxpY2Vuc2VNYW5hZ2VyIgogICAgfSwKICAgICJrYWZrYSI6IHsKICAgICAgIm5hbWUiOiAiS2Fma2EiCiAgICB9LAogICAgImFwaWdhdGV3YXltYW5hZ2VtZW50YXBpIjogewogICAgICAibmFtZSI6ICJBcGlHYXRld2F5TWFuYWdlbWVudEFwaSIKICAgIH0sCiAgICAiYXBpZ2F0ZXdheXYyIjogewogICAgICAibmFtZSI6ICJBcGlHYXRld2F5VjIiCiAgICB9LAogICAgImRvY2RiIjogewogICAgICAibmFtZSI6ICJEb2NEQiIKICAgIH0sCiAgICAiYmFja3VwIjogewogICAgICAibmFtZSI6ICJCYWNrdXAiCiAgICB9LAogICAgIndvcmtsaW5rIjogewogICAgICAibmFtZSI6ICJXb3JrTGluayIKICAgIH0sCiAgICAidGV4dHJhY3QiOiB7CiAgICAgICJuYW1lIjogIlRleHRyYWN0IgogICAgfSwKICAgICJtYW5hZ2VkYmxvY2tjaGFpbiI6IHsKICAgICAgIm5hbWUiOiAiTWFuYWdlZEJsb2NrY2hhaW4iCiAgICB9LAogICAgIm1lZGlhcGFja2FnZXZvZCI6IHsKICAgICAgInByZWZpeCI6ICJtZWRpYXBhY2thZ2Utdm9kIiwKICAgICAgIm5hbWUiOiAiTWVkaWFQYWNrYWdlVm9kIgogICAgfSwKICAgICJncm91bmRzdGF0aW9uIjogewogICAgICAibmFtZSI6ICJHcm91bmRTdGF0aW9uIgogICAgfSwKICAgICJpb3R0aGluZ3NncmFwaCI6IHsKICAgICAgIm5hbWUiOiAiSW9UVGhpbmdzR3JhcGgiCiAgICB9LAogICAgImlvdGV2ZW50cyI6IHsKICAgICAgIm5hbWUiOiAiSW9URXZlbnRzIgogICAgfSwKICAgICJpb3RldmVudHNkYXRhIjogewogICAgICAicHJlZml4IjogImlvdGV2ZW50cy1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW9URXZlbnRzRGF0YSIKICAgIH0sCiAgICAicGVyc29uYWxpemUiOiB7CiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInBlcnNvbmFsaXplZXZlbnRzIjogewogICAgICAicHJlZml4IjogInBlcnNvbmFsaXplLWV2ZW50cyIsCiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplRXZlbnRzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInBlcnNvbmFsaXplcnVudGltZSI6IHsKICAgICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ydW50aW1lIiwKICAgICAgIm5hbWUiOiAiUGVyc29uYWxpemVSdW50aW1lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcGxpY2F0aW9uaW5zaWdodHMiOiB7CiAgICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24taW5zaWdodHMiLAogICAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkluc2lnaHRzIgogICAgfSwKICAgICJzZXJ2aWNlcXVvdGFzIjogewogICAgICAicHJlZml4IjogInNlcnZpY2UtcXVvdGFzIiwKICAgICAgIm5hbWUiOiAiU2VydmljZVF1b3RhcyIKICAgIH0sCiAgICAiZWMyaW5zdGFuY2Vjb25uZWN0IjogewogICAgICAicHJlZml4IjogImVjMi1pbnN0YW5jZS1jb25uZWN0IiwKICAgICAgIm5hbWUiOiAiRUMySW5zdGFuY2VDb25uZWN0IgogICAgfSwKICAgICJldmVudGJyaWRnZSI6IHsKICAgICAgIm5hbWUiOiAiRXZlbnRCcmlkZ2UiCiAgICB9LAogICAgImxha2Vmb3JtYXRpb24iOiB7CiAgICAgICJuYW1lIjogIkxha2VGb3JtYXRpb24iCiAgICB9LAogICAgImZvcmVjYXN0c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJmb3JlY2FzdCIsCiAgICAgICJuYW1lIjogIkZvcmVjYXN0U2VydmljZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJmb3JlY2FzdHF1ZXJ5c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJmb3JlY2FzdHF1ZXJ5IiwKICAgICAgIm5hbWUiOiAiRm9yZWNhc3RRdWVyeVNlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicWxkYiI6IHsKICAgICAgIm5hbWUiOiAiUUxEQiIKICAgIH0sCiAgICAicWxkYnNlc3Npb24iOiB7CiAgICAgICJwcmVmaXgiOiAicWxkYi1zZXNzaW9uIiwKICAgICAgIm5hbWUiOiAiUUxEQlNlc3Npb24iCiAgICB9LAogICAgIndvcmttYWlsbWVzc2FnZWZsb3ciOiB7CiAgICAgICJuYW1lIjogIldvcmtNYWlsTWVzc2FnZUZsb3ciCiAgICB9CiAgfQogIAogIH0se31dLDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTEtMDYtMTUiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAic3RzIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogInN0cy5hbWF6b25hd3MuY29tIiwKICAgICAgInByb3RvY29sIjogInF1ZXJ5IiwKICAgICAgInNlcnZpY2VBYmJyZXZpYXRpb24iOiAiQVdTIFNUUyIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQVdTIFNlY3VyaXR5IFRva2VuIFNlcnZpY2UiLAogICAgICAic2VydmljZUlkIjogIlNUUyIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICAgInVpZCI6ICJzdHMtMjAxMS0wNi0xNSIsCiAgICAgICJ4bWxOYW1lc3BhY2UiOiAiaHR0cHM6Ly9zdHMuYW1hem9uYXdzLmNvbS9kb2MvMjAxMS0wNi0xNS8iCiAgICB9LAogICAgIm9wZXJhdGlvbnMiOiB7CiAgICAgICJBc3N1bWVSb2xlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRXh0ZXJuYWxJZCI6IHt9LAogICAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAgICJUb2tlbkNvZGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkFzc3VtZVJvbGVXaXRoU0FNTCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJQcmluY2lwYWxBcm4iLAogICAgICAgICAgICAiU0FNTEFzc2VydGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlByaW5jaXBhbEFybiI6IHt9LAogICAgICAgICAgICAiU0FNTEFzc2VydGlvbiI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhTQU1MUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdWJqZWN0Ijoge30sCiAgICAgICAgICAgICJTdWJqZWN0VHlwZSI6IHt9LAogICAgICAgICAgICAiSXNzdWVyIjoge30sCiAgICAgICAgICAgICJBdWRpZW5jZSI6IHt9LAogICAgICAgICAgICAiTmFtZVF1YWxpZmllciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiLAogICAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiI6IHt9LAogICAgICAgICAgICAiUHJvdmlkZXJJZCI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdWJqZWN0RnJvbVdlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQcm92aWRlciI6IHt9LAogICAgICAgICAgICAiQXVkaWVuY2UiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlY29kZUF1dGhvcml6YXRpb25NZXNzYWdlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkVuY29kZWRNZXNzYWdlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJEZWNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWNjZXNzS2V5SW5mbyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiQWNjZXNzS2V5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0QWNjZXNzS2V5SW5mb1Jlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2NvdW50Ijoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRDYWxsZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldENhbGxlcklkZW50aXR5UmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlVzZXJJZCI6IHt9LAogICAgICAgICAgICAiQWNjb3VudCI6IHt9LAogICAgICAgICAgICAiQXJuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRGZWRlcmF0aW9uVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIk5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJOYW1lIjoge30sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRGZWRlcmF0aW9uVG9rZW5SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRmVkZXJhdGVkVXNlciI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiLAogICAgICAgICAgICAgICAgIkFybiIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXJJZCI6IHt9LAogICAgICAgICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0U2Vzc2lvblRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAgICJUb2tlbkNvZGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldFNlc3Npb25Ub2tlblJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAic2hhcGVzIjogewogICAgICAiUzQiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2MiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiQWNjZXNzS2V5SWQiLAogICAgICAgICAgIlNlY3JldEFjY2Vzc0tleSIsCiAgICAgICAgICAiU2Vzc2lvblRva2VuIiwKICAgICAgICAgICJFeHBpcmF0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiOiB7fSwKICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2giOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiQXNzdW1lZFJvbGVJZCIsCiAgICAgICAgICAiQXJuIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQXNzdW1lZFJvbGVJZCI6IHt9LAogICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGFyZ3VtZW50c1s0XVsyXVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKICB9LHsiZHVwIjoyfV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CiAgdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKICB2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKICAKICBhcGlMb2FkZXIuc2VydmljZXNbJ2NvZ25pdG9pZGVudGl0eSddID0ge307CiAgQVdTLkNvZ25pdG9JZGVudGl0eSA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29nbml0b2lkZW50aXR5JywgWycyMDE0LTA2LTMwJ10pOwogIHJlcXVpcmUoJy4uL2xpYi9zZXJ2aWNlcy9jb2duaXRvaWRlbnRpdHknKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSwgJzIwMTQtMDYtMzAnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24nKTsKICAgICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbicpLnBhZ2luYXRpb247CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuQ29nbml0b0lkZW50aXR5OwogIAogIH0seyIuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5taW4uanNvbiI6MSwiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAucGFnaW5hdG9ycy5qc29uIjoyLCIuLi9saWIvY29yZSI6MTgsIi4uL2xpYi9ub2RlX2xvYWRlciI6MTYsIi4uL2xpYi9zZXJ2aWNlcy9jb2duaXRvaWRlbnRpdHkiOjYwfV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CiAgdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKICB2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKICAKICBhcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddID0ge307CiAgQVdTLlNUUyA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnc3RzJywgWycyMDExLTA2LTE1J10pOwogIHJlcXVpcmUoJy4uL2xpYi9zZXJ2aWNlcy9zdHMnKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSwgJzIwMTEtMDYtMTUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbicpOwogICAgICBtb2RlbC5wYWdpbmF0b3JzID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwogIAogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNUUzsKICAKICB9LHsiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbiI6NSwiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24iOjYsIi4uL2xpYi9jb3JlIjoxOCwiLi4vbGliL25vZGVfbG9hZGVyIjoxNiwiLi4vbGliL3NlcnZpY2VzL3N0cyI6NjF9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBmdW5jdGlvbiBhcGlMb2FkZXIoc3ZjLCB2ZXJzaW9uKSB7CiAgICBpZiAoIWFwaUxvYWRlci5zZXJ2aWNlcy5oYXNPd25Qcm9wZXJ0eShzdmMpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZFNlcnZpY2U6IEZhaWxlZCB0byBsb2FkIGFwaSBmb3IgJyArIHN2Yyk7CiAgICB9CiAgICByZXR1cm4gYXBpTG9hZGVyLnNlcnZpY2VzW3N2Y11bdmVyc2lvbl07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogVGhpcyBtZW1iZXIgb2YgQVdTLmFwaUxvYWRlciBpcyBwcml2YXRlLCBidXQgY2hhbmdpbmcgaXQgd2lsbCBuZWNlc3NpdGF0ZSBhCiAgICogY2hhbmdlIHRvIC4uL3NjcmlwdHMvc2VydmljZXMtdGFibGUtZ2VuZXJhdG9yLnRzCiAgICovCiAgYXBpTG9hZGVyLnNlcnZpY2VzID0ge307CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBhcGlMb2FkZXI7CiAgCiAgfSx7fV0sMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBIbWFjID0gcmVxdWlyZSgnLi9icm93c2VySG1hYycpOwogIHZhciBNZDUgPSByZXF1aXJlKCcuL2Jyb3dzZXJNZDUnKTsKICB2YXIgU2hhMSA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTEnKTsKICB2YXIgU2hhMjU2ID0gcmVxdWlyZSgnLi9icm93c2VyU2hhMjU2Jyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZykgewogICAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1kNSgpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgICAgcmV0dXJuIG5ldyBTaGEyNTYoKTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFNoYTEoKTsKICAgICAgICB9CiAgCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIYXNoIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgICB9LAogICAgICBjcmVhdGVIbWFjOiBmdW5jdGlvbiBjcmVhdGVIbWFjKGFsZywga2V5KSB7CiAgICAgICAgYWxnID0gYWxnLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGFsZyA9PT0gJ21kNScpIHsKICAgICAgICAgIHJldHVybiBuZXcgSG1hYyhNZDUsIGtleSk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGEyNTYnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMjU2LCBrZXkpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMScpIHsKICAgICAgICAgIHJldHVybiBuZXcgSG1hYyhTaGExLCBrZXkpOwogICAgICAgIH0KICAKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hNQUMgYWxnb3JpdGhtICcgKyBhbGcgKyAnIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgU0RLJyk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZVNpZ246IGZ1bmN0aW9uKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignY3JlYXRlU2lnbiBpcyBub3QgaW1wbGVtZW50ZWQgaW4gdGhlIGJyb3dzZXInKTsKICAgICAgfQogICAgfTsKICAKICB9LHsiLi9icm93c2VySG1hYyI6MTIsIi4vYnJvd3Nlck1kNSI6MTMsIi4vYnJvd3NlclNoYTEiOjE0LCIuL2Jyb3dzZXJTaGEyNTYiOjE1fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIAogIC8qKgogICAqIFRoaXMgaXMgYSBwb2x5ZmlsbCBmb3IgdGhlIHN0YXRpYyBtZXRob2QgYGlzVmlld2Agb2YgYEFycmF5QnVmZmVyYCwgd2hpY2ggaXMKICAgKiBlLmcuIG1pc3NpbmcgaW4gSUUgMTAuCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpZiAoCiAgICAgIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ3VuZGVmaW5lZCcKICApIHsKICAgICAgQXJyYXlCdWZmZXIuaXNWaWV3ID0gZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICByZXR1cm4gdmlld1N0cmluZ3MuaW5kZXhPZihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnKSkgPiAtMTsKICAgICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIHZpZXdTdHJpbmdzID0gWwogICAgICAnW29iamVjdCBJbnQ4QXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDhBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0nLAogICAgICAnW29iamVjdCBJbnQxNkFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQxNkFycmF5XScsCiAgICAgICdbb2JqZWN0IEludDMyQXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDMyQXJyYXldJywKICAgICAgJ1tvYmplY3QgRmxvYXQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IEZsb2F0NjRBcnJheV0nLAogICAgICAnW29iamVjdCBEYXRhVmlld10nLAogIF07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaXNFbXB0eURhdGEoZGF0YSkgewogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gZGF0YS5sZW5ndGggPT09IDA7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGEuYnl0ZUxlbmd0aCA9PT0gMDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gY29udmVydFRvQnVmZmVyKGRhdGEpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgZGF0YSA9IG5ldyBCdWZmZXIoZGF0YSwgJ3V0ZjgnKTsKICAgICAgfQogIAogICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoIC8gVWludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7CiAgICAgIGlzRW1wdHlEYXRhOiBpc0VtcHR5RGF0YSwKICAgICAgY29udmVydFRvQnVmZmVyOiBjb252ZXJ0VG9CdWZmZXIsCiAgfTsKICAKICB9LHsiYnVmZmVyLyI6ODF9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIEhtYWMoaGFzaEN0b3IsIHNlY3JldCkgewogICAgICB0aGlzLmhhc2ggPSBuZXcgaGFzaEN0b3IoKTsKICAgICAgdGhpcy5vdXRlciA9IG5ldyBoYXNoQ3RvcigpOwogIAogICAgICB2YXIgaW5uZXIgPSBidWZmZXJGcm9tU2VjcmV0KGhhc2hDdG9yLCBzZWNyZXQpOwogICAgICB2YXIgb3V0ZXIgPSBuZXcgVWludDhBcnJheShoYXNoQ3Rvci5CTE9DS19TSVpFKTsKICAgICAgb3V0ZXIuc2V0KGlubmVyKTsKICAKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYXNoQ3Rvci5CTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgIGlubmVyW2ldIF49IDB4MzY7CiAgICAgICAgICBvdXRlcltpXSBePSAweDVjOwogICAgICB9CiAgCiAgICAgIHRoaXMuaGFzaC51cGRhdGUoaW5uZXIpOwogICAgICB0aGlzLm91dGVyLnVwZGF0ZShvdXRlcik7CiAgCiAgICAgIC8vIFplcm8gb3V0IHRoZSBjb3BpZWQga2V5IGJ1ZmZlci4KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbm5lci5ieXRlTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlubmVyW2ldID0gMDsKICAgICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBIbWFjOwogIAogIEhtYWMucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICh0b0hhc2gpIHsKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YSh0b0hhc2gpIHx8IHRoaXMuZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLmhhc2gudXBkYXRlKGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIodG9IYXNoKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRoaXMuZXJyb3IgPSBlOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgSG1hYy5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIGlmICghdGhpcy5vdXRlci5maW5pc2hlZCkgewogICAgICAgICAgdGhpcy5vdXRlci51cGRhdGUodGhpcy5oYXNoLmRpZ2VzdCgpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpcy5vdXRlci5kaWdlc3QoZW5jb2RpbmcpOwogIH07CiAgCiAgZnVuY3Rpb24gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KSB7CiAgICAgIHZhciBpbnB1dCA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc2VjcmV0KTsKICAgICAgaWYgKGlucHV0LmJ5dGVMZW5ndGggPiBoYXNoQ3Rvci5CTE9DS19TSVpFKSB7CiAgICAgICAgICB2YXIgYnVmZmVySGFzaCA9IG5ldyBoYXNoQ3RvcjsKICAgICAgICAgIGJ1ZmZlckhhc2gudXBkYXRlKGlucHV0KTsKICAgICAgICAgIGlucHV0ID0gYnVmZmVySGFzaC5kaWdlc3QoKTsKICAgICAgfQogICAgICB2YXIgYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICAgIGJ1ZmZlci5zZXQoaW5wdXQpOwogICAgICByZXR1cm4gYnVmZmVyOwogIH0KICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMX1dLDEzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDE2OwogIAogIHZhciBJTklUID0gWwogICAgICAweDY3NDUyMzAxLAogICAgICAweGVmY2RhYjg5LAogICAgICAweDk4YmFkY2ZlLAogICAgICAweDEwMzI1NDc2LAogIF07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gTWQ1KCkgewogICAgICB0aGlzLnN0YXRlID0gWwogICAgICAgICAgMHg2NzQ1MjMwMSwKICAgICAgICAgIDB4ZWZjZGFiODksCiAgICAgICAgICAweDk4YmFkY2ZlLAogICAgICAgICAgMHgxMDMyNTQ3NiwKICAgICAgXTsKICAgICAgdGhpcy5idWZmZXIgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKEJMT0NLX1NJWkUpKTsKICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgICAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBNZDU7CiAgCiAgTWQ1LkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwogIAogIE1kNS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKHNvdXJjZURhdGEpIHsKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShzb3VyY2VEYXRhKSkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICB2YXIgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc291cmNlRGF0YSk7CiAgICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICAgIHZhciBieXRlTGVuZ3RoID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkICs9IGJ5dGVMZW5ndGg7CiAgICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgICAgdGhpcy5idWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgZGF0YVtwb3NpdGlvbisrXSk7CiAgICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBNZDUucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgdW5kZWNvcmF0ZWRMZW5ndGggPSBfYS5idWZmZXJMZW5ndGgsIGJ5dGVzSGFzaGVkID0gX2EuYnl0ZXNIYXNoZWQ7CiAgICAgICAgICB2YXIgYml0c0hhc2hlZCA9IGJ5dGVzSGFzaGVkICogODsKICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAxMjgpOwogICAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRSAtIDg7IGkrKykgewogICAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIGJpdHNIYXNoZWQgPj4+IDAsIHRydWUpOwogICAgICAgICAgYnVmZmVyLnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgTWF0aC5mbG9vcihiaXRzSGFzaGVkIC8gMHgxMDAwMDAwMDApLCB0cnVlKTsKICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgdGhpcy5maW5pc2hlZCA9IHRydWU7CiAgICAgIH0KICAgICAgdmFyIG91dCA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoRElHRVNUX0xFTkdUSCkpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgb3V0LnNldFVpbnQzMihpICogNCwgdGhpcy5zdGF0ZVtpXSwgdHJ1ZSk7CiAgICAgIH0KICAgICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKG91dC5idWZmZXIsIG91dC5ieXRlT2Zmc2V0LCBvdXQuYnl0ZUxlbmd0aCk7CiAgICAgIHJldHVybiBlbmNvZGluZyA/IGJ1ZmYudG9TdHJpbmcoZW5jb2RpbmcpIDogYnVmZjsKICB9OwogIAogIE1kNS5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9hID0gdGhpcywgYnVmZmVyID0gX2EuYnVmZmVyLCBzdGF0ZSA9IF9hLnN0YXRlOwogICAgICB2YXIgYSA9IHN0YXRlWzBdLCBiID0gc3RhdGVbMV0sIGMgPSBzdGF0ZVsyXSwgZCA9IHN0YXRlWzNdOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNywgMHhkNzZhYTQ3OCk7CiAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCAxMiwgMHhlOGM3Yjc1Nik7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNywgMHgyNDIwNzBkYik7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMjIsIDB4YzFiZGNlZWUpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDcsIDB4ZjU3YzBmYWYpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDEyLCAweDQ3ODdjNjJhKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNywgMHhhODMwNDYxMyk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMjIsIDB4ZmQ0Njk1MDEpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDcsIDB4Njk4MDk4ZDgpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDEyLCAweDhiNDRmN2FmKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAxNywgMHhmZmZmNWJiMSk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMjIsIDB4ODk1Y2Q3YmUpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDcsIDB4NmI5MDExMjIpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDEyLCAweGZkOTg3MTkzKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAxNywgMHhhNjc5NDM4ZSk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMjIsIDB4NDliNDA4MjEpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNSwgMHhmNjFlMjU2Mik7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgOSwgMHhjMDQwYjM0MCk7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTQsIDB4MjY1ZTVhNTEpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgMjAsIDB4ZTliNmM3YWEpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDUsIDB4ZDYyZjEwNWQpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDksIDB4MDI0NDE0NTMpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDE0LCAweGQ4YTFlNjgxKTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAyMCwgMHhlN2QzZmJjOCk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgNSwgMHgyMWUxY2RlNik7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgOSwgMHhjMzM3MDdkNik7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTQsIDB4ZjRkNTBkODcpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDIwLCAweDQ1NWExNGVkKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA1LCAweGE5ZTNlOTA1KTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDksIDB4ZmNlZmEzZjgpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE0LCAweDY3NmYwMmQ5KTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAyMCwgMHg4ZDJhNGM4YSk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgNCwgMHhmZmZhMzk0Mik7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgMTEsIDB4ODc3MWY2ODEpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE2LCAweDZkOWQ2MTIyKTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAyMywgMHhmZGU1MzgwYyk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCA0LCAweGE0YmVlYTQ0KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAxMSwgMHg0YmRlY2ZhOSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTYsIDB4ZjZiYjRiNjApOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDIzLCAweGJlYmZiYzcwKTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA0LCAweDI4OWI3ZWM2KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDExLCAweGVhYTEyN2ZhKTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxNiwgMHhkNGVmMzA4NSk7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMjMsIDB4MDQ4ODFkMDUpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDQsIDB4ZDlkNGQwMzkpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDExLCAweGU2ZGI5OWU1KTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNiwgMHgxZmEyN2NmOCk7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAyMywgMHhjNGFjNTY2NSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCA2LCAweGY0MjkyMjQ0KTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxMCwgMHg0MzJhZmY5Nyk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTUsIDB4YWI5NDIzYTcpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDIxLCAweGZjOTNhMDM5KTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA2LCAweDY1NWI1OWMzKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxMCwgMHg4ZjBjY2M5Mik7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTUsIDB4ZmZlZmY0N2QpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMjEsIDB4ODU4NDVkZDEpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDYsIDB4NmZhODdlNGYpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDEwLCAweGZlMmNlNmUwKTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNSwgMHhhMzAxNDMxNCk7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgMjEsIDB4NGUwODExYTEpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDYsIDB4Zjc1MzdlODIpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDEwLCAweGJkM2FmMjM1KTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDE1LCAweDJhZDdkMmJiKTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAyMSwgMHhlYjg2ZDM5MSk7CiAgICAgIHN0YXRlWzBdID0gKGEgKyBzdGF0ZVswXSkgJiAweEZGRkZGRkZGOwogICAgICBzdGF0ZVsxXSA9IChiICsgc3RhdGVbMV0pICYgMHhGRkZGRkZGRjsKICAgICAgc3RhdGVbMl0gPSAoYyArIHN0YXRlWzJdKSAmIDB4RkZGRkZGRkY7CiAgICAgIHN0YXRlWzNdID0gKGQgKyBzdGF0ZVszXSkgJiAweEZGRkZGRkZGOwogIH07CiAgCiAgZnVuY3Rpb24gY21uKHEsIGEsIGIsIHgsIHMsIHQpIHsKICAgICAgYSA9ICgoKGEgKyBxKSAmIDB4RkZGRkZGRkYpICsgKCh4ICsgdCkgJiAweEZGRkZGRkZGKSkgJiAweEZGRkZGRkZGOwogICAgICByZXR1cm4gKCgoYSA8PCBzKSB8IChhID4+PiAoMzIgLSBzKSkpICsgYikgJiAweEZGRkZGRkZGOwogIH0KICAKICBmdW5jdGlvbiBmZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oKGIgJiBjKSB8ICgofmIpICYgZCksIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICBmdW5jdGlvbiBnZyhhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oKGIgJiBkKSB8IChjICYgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICBmdW5jdGlvbiBoaChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gaWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKGMgXiAoYiB8ICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjgxfV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICB2YXIgQkxPQ0tfU0laRSA9IDY0OwogIAogIHZhciBESUdFU1RfTEVOR1RIID0gMjA7CiAgCiAgdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAgIDB4NWE4Mjc5OTksCiAgICAgIDB4NmVkOWViYTEsCiAgICAgIDB4OGYxYmJjZGMgfCAwLAogICAgICAweGNhNjJjMWQ2IHwgMAogIF0pOwogIAogIHZhciBJTklUID0gWwogICAgICAweDZhMDllNjY3LAogICAgICAweGJiNjdhZTg1LAogICAgICAweDNjNmVmMzcyLAogICAgICAweGE1NGZmNTNhLAogICAgICAweDUxMGU1MjdmLAogICAgICAweDliMDU2ODhjLAogICAgICAweDFmODNkOWFiLAogICAgICAweDViZTBjZDE5LAogIF07CiAgCiAgdmFyIE1BWF9IQVNIQUJMRV9MRU5HVEggPSBNYXRoLnBvdygyLCA1MykgLSAxOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFNoYTEoKSB7CiAgICAgIHRoaXMuaDAgPSAweDY3NDUyMzAxOwogICAgICB0aGlzLmgxID0gMHhFRkNEQUI4OTsKICAgICAgdGhpcy5oMiA9IDB4OThCQURDRkU7CiAgICAgIHRoaXMuaDMgPSAweDEwMzI1NDc2OwogICAgICB0aGlzLmg0ID0gMHhDM0QyRTFGMDsKICAgICAgLy8gVGhlIGZpcnN0IDY0IGJ5dGVzICgxNiB3b3JkcykgaXMgdGhlIGRhdGEgY2h1bmsKICAgICAgdGhpcy5ibG9jayA9IG5ldyBVaW50MzJBcnJheSg4MCk7CiAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgdGhpcy5zaGlmdCA9IDI0OwogICAgICB0aGlzLnRvdGFsTGVuZ3RoID0gMDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMTsKICAKICBTaGExLkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwogIAogIFNoYTEucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgICB9CiAgCiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwogIAogICAgICB2YXIgbGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICAgIHRoaXMudG90YWxMZW5ndGggKz0gbGVuZ3RoICogODsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy53cml0ZShkYXRhW2ldKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIFNoYTEucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gd3JpdGUoYnl0ZSkgewogICAgICB0aGlzLmJsb2NrW3RoaXMub2Zmc2V0XSB8PSAoYnl0ZSAmIDB4ZmYpIDw8IHRoaXMuc2hpZnQ7CiAgICAgIGlmICh0aGlzLnNoaWZ0KSB7CiAgICAgICAgICB0aGlzLnNoaWZ0IC09IDg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLm9mZnNldCsrOwogICAgICAgICAgdGhpcy5zaGlmdCA9IDI0OwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLm9mZnNldCA9PT0gMTYpIHRoaXMucHJvY2Vzc0Jsb2NrKCk7CiAgfTsKICAKICBTaGExLnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgLy8gUGFkCiAgICAgIHRoaXMud3JpdGUoMHg4MCk7CiAgICAgIGlmICh0aGlzLm9mZnNldCA+IDE0IHx8ICh0aGlzLm9mZnNldCA9PT0gMTQgJiYgdGhpcy5zaGlmdCA8IDI0KSkgewogICAgICAgIHRoaXMucHJvY2Vzc0Jsb2NrKCk7CiAgICAgIH0KICAgICAgdGhpcy5vZmZzZXQgPSAxNDsKICAgICAgdGhpcy5zaGlmdCA9IDI0OwogIAogICAgICAvLyA2NC1iaXQgbGVuZ3RoIGJpZy1lbmRpYW4KICAgICAgdGhpcy53cml0ZSgweDAwKTsgLy8gbnVtYmVycyB0aGlzIGJpZyBhcmVuJ3QgYWNjdXJhdGUgaW4gamF2YXNjcmlwdCBhbnl3YXkKICAgICAgdGhpcy53cml0ZSgweDAwKTsgLy8gLi5TbyBqdXN0IGhhcmQtY29kZSB0byB6ZXJvLgogICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmZmYgPyB0aGlzLnRvdGFsTGVuZ3RoIC8gMHgxMDAwMDAwMDAwMCA6IDB4MDApOwogICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwIDogMHgwMCk7CiAgICAgIGZvciAodmFyIHMgPSAyNDsgcyA+PSAwOyBzIC09IDgpIHsKICAgICAgICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+PiBzKTsKICAgICAgfQogICAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICAgIHZhciBvdXRWaWV3ID0gbmV3IERhdGFWaWV3KG91dC5idWZmZXIpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigwLCB0aGlzLmgwLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDQsIHRoaXMuaDEsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoOCwgdGhpcy5oMiwgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigxMiwgdGhpcy5oMywgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigxNiwgdGhpcy5oNCwgZmFsc2UpOwogIAogICAgICByZXR1cm4gZW5jb2RpbmcgPyBvdXQudG9TdHJpbmcoZW5jb2RpbmcpIDogb3V0OwogIH07CiAgCiAgU2hhMS5wcm90b3R5cGUucHJvY2Vzc0Jsb2NrID0gZnVuY3Rpb24gcHJvY2Vzc0Jsb2NrKCkgewogICAgICAvLyBFeHRlbmQgdGhlIHNpeHRlZW4gMzItYml0IHdvcmRzIGludG8gZWlnaHR5IDMyLWJpdCB3b3JkczoKICAgICAgZm9yICh2YXIgaSA9IDE2OyBpIDwgODA7IGkrKykgewogICAgICAgIHZhciB3ID0gdGhpcy5ibG9ja1tpIC0gM10gXiB0aGlzLmJsb2NrW2kgLSA4XSBeIHRoaXMuYmxvY2tbaSAtIDE0XSBeIHRoaXMuYmxvY2tbaSAtIDE2XTsKICAgICAgICB0aGlzLmJsb2NrW2ldID0gKHcgPDwgMSkgfCAodyA+Pj4gMzEpOwogICAgICB9CiAgCiAgICAgIC8vIEluaXRpYWxpemUgaGFzaCB2YWx1ZSBmb3IgdGhpcyBjaHVuazoKICAgICAgdmFyIGEgPSB0aGlzLmgwOwogICAgICB2YXIgYiA9IHRoaXMuaDE7CiAgICAgIHZhciBjID0gdGhpcy5oMjsKICAgICAgdmFyIGQgPSB0aGlzLmgzOwogICAgICB2YXIgZSA9IHRoaXMuaDQ7CiAgICAgIHZhciBmLCBrOwogIAogICAgICAvLyBNYWluIGxvb3A6CiAgICAgIGZvciAoaSA9IDA7IGkgPCA4MDsgaSsrKSB7CiAgICAgICAgaWYgKGkgPCAyMCkgewogICAgICAgICAgZiA9IGQgXiAoYiAmIChjIF4gZCkpOwogICAgICAgICAgayA9IDB4NUE4Mjc5OTk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGkgPCA0MCkgewogICAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICAgIGsgPSAweDZFRDlFQkExOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpIDwgNjApIHsKICAgICAgICAgIGYgPSAoYiAmIGMpIHwgKGQgJiAoYiB8IGMpKTsKICAgICAgICAgIGsgPSAweDhGMUJCQ0RDOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgICBrID0gMHhDQTYyQzFENjsKICAgICAgICB9CiAgICAgICAgdmFyIHRlbXAgPSAoYSA8PCA1IHwgYSA+Pj4gMjcpICsgZiArIGUgKyBrICsgKHRoaXMuYmxvY2tbaV18MCk7CiAgICAgICAgZSA9IGQ7CiAgICAgICAgZCA9IGM7CiAgICAgICAgYyA9IChiIDw8IDMwIHwgYiA+Pj4gMik7CiAgICAgICAgYiA9IGE7CiAgICAgICAgYSA9IHRlbXA7CiAgICAgIH0KICAKICAgICAgLy8gQWRkIHRoaXMgY2h1bmsncyBoYXNoIHRvIHJlc3VsdCBzbyBmYXI6CiAgICAgIHRoaXMuaDAgPSAodGhpcy5oMCArIGEpIHwgMDsKICAgICAgdGhpcy5oMSA9ICh0aGlzLmgxICsgYikgfCAwOwogICAgICB0aGlzLmgyID0gKHRoaXMuaDIgKyBjKSB8IDA7CiAgICAgIHRoaXMuaDMgPSAodGhpcy5oMyArIGQpIHwgMDsKICAgICAgdGhpcy5oNCA9ICh0aGlzLmg0ICsgZSkgfCAwOwogIAogICAgICAvLyBUaGUgYmxvY2sgaXMgbm93IHJldXNhYmxlLgogICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSsrKSB7CiAgICAgICAgICB0aGlzLmJsb2NrW2ldID0gMDsKICAgICAgfQogIH07CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjgxfV0sMTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICB2YXIgQkxPQ0tfU0laRSA9IDY0OwogIAogIHZhciBESUdFU1RfTEVOR1RIID0gMzI7CiAgCiAgdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAgIDB4NDI4YTJmOTgsCiAgICAgIDB4NzEzNzQ0OTEsCiAgICAgIDB4YjVjMGZiY2YsCiAgICAgIDB4ZTliNWRiYTUsCiAgICAgIDB4Mzk1NmMyNWIsCiAgICAgIDB4NTlmMTExZjEsCiAgICAgIDB4OTIzZjgyYTQsCiAgICAgIDB4YWIxYzVlZDUsCiAgICAgIDB4ZDgwN2FhOTgsCiAgICAgIDB4MTI4MzViMDEsCiAgICAgIDB4MjQzMTg1YmUsCiAgICAgIDB4NTUwYzdkYzMsCiAgICAgIDB4NzJiZTVkNzQsCiAgICAgIDB4ODBkZWIxZmUsCiAgICAgIDB4OWJkYzA2YTcsCiAgICAgIDB4YzE5YmYxNzQsCiAgICAgIDB4ZTQ5YjY5YzEsCiAgICAgIDB4ZWZiZTQ3ODYsCiAgICAgIDB4MGZjMTlkYzYsCiAgICAgIDB4MjQwY2ExY2MsCiAgICAgIDB4MmRlOTJjNmYsCiAgICAgIDB4NGE3NDg0YWEsCiAgICAgIDB4NWNiMGE5ZGMsCiAgICAgIDB4NzZmOTg4ZGEsCiAgICAgIDB4OTgzZTUxNTIsCiAgICAgIDB4YTgzMWM2NmQsCiAgICAgIDB4YjAwMzI3YzgsCiAgICAgIDB4YmY1OTdmYzcsCiAgICAgIDB4YzZlMDBiZjMsCiAgICAgIDB4ZDVhNzkxNDcsCiAgICAgIDB4MDZjYTYzNTEsCiAgICAgIDB4MTQyOTI5NjcsCiAgICAgIDB4MjdiNzBhODUsCiAgICAgIDB4MmUxYjIxMzgsCiAgICAgIDB4NGQyYzZkZmMsCiAgICAgIDB4NTMzODBkMTMsCiAgICAgIDB4NjUwYTczNTQsCiAgICAgIDB4NzY2YTBhYmIsCiAgICAgIDB4ODFjMmM5MmUsCiAgICAgIDB4OTI3MjJjODUsCiAgICAgIDB4YTJiZmU4YTEsCiAgICAgIDB4YTgxYTY2NGIsCiAgICAgIDB4YzI0YjhiNzAsCiAgICAgIDB4Yzc2YzUxYTMsCiAgICAgIDB4ZDE5MmU4MTksCiAgICAgIDB4ZDY5OTA2MjQsCiAgICAgIDB4ZjQwZTM1ODUsCiAgICAgIDB4MTA2YWEwNzAsCiAgICAgIDB4MTlhNGMxMTYsCiAgICAgIDB4MWUzNzZjMDgsCiAgICAgIDB4Mjc0ODc3NGMsCiAgICAgIDB4MzRiMGJjYjUsCiAgICAgIDB4MzkxYzBjYjMsCiAgICAgIDB4NGVkOGFhNGEsCiAgICAgIDB4NWI5Y2NhNGYsCiAgICAgIDB4NjgyZTZmZjMsCiAgICAgIDB4NzQ4ZjgyZWUsCiAgICAgIDB4NzhhNTYzNmYsCiAgICAgIDB4ODRjODc4MTQsCiAgICAgIDB4OGNjNzAyMDgsCiAgICAgIDB4OTBiZWZmZmEsCiAgICAgIDB4YTQ1MDZjZWIsCiAgICAgIDB4YmVmOWEzZjcsCiAgICAgIDB4YzY3MTc4ZjIKICBdKTsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2YTA5ZTY2NywKICAgICAgMHhiYjY3YWU4NSwKICAgICAgMHgzYzZlZjM3MiwKICAgICAgMHhhNTRmZjUzYSwKICAgICAgMHg1MTBlNTI3ZiwKICAgICAgMHg5YjA1Njg4YywKICAgICAgMHgxZjgzZDlhYiwKICAgICAgMHg1YmUwY2QxOSwKICBdOwogIAogIHZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKICAKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFNoYTI1NigpIHsKICAgICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAgIDB4NmEwOWU2NjcsCiAgICAgICAgICAweGJiNjdhZTg1LAogICAgICAgICAgMHgzYzZlZjM3MiwKICAgICAgICAgIDB4YTU0ZmY1M2EsCiAgICAgICAgICAweDUxMGU1MjdmLAogICAgICAgICAgMHg5YjA1Njg4YywKICAgICAgICAgIDB4MWY4M2Q5YWIsCiAgICAgICAgICAweDViZTBjZDE5LAogICAgICBdOwogICAgICB0aGlzLnRlbXAgPSBuZXcgSW50MzJBcnJheSg2NCk7CiAgICAgIHRoaXMuYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoNjQpOwogICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgPSAwOwogICAgICAvKioKICAgICAgICogQHByaXZhdGUKICAgICAgICovCiAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMjU2OwogIAogIFNoYTI1Ni5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBTaGEyNTYucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgICB9CiAgCiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwogIAogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgICBpZiAodGhpcy5ieXRlc0hhc2hlZCAqIDggPiBNQVhfSEFTSEFCTEVfTEVOR1RIKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNoIG1vcmUgdGhhbiAyXjUzIC0gMSBiaXRzJyk7CiAgICAgIH0KICAKICAgICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlclt0aGlzLmJ1ZmZlckxlbmd0aCsrXSA9IGRhdGFbcG9zaXRpb24rK107CiAgICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBTaGEyNTYucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHZhciBiaXRzSGFzaGVkID0gdGhpcy5ieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgICB2YXIgYnVmZmVyVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlci5idWZmZXIsIHRoaXMuYnVmZmVyLmJ5dGVPZmZzZXQsIHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgICAgdmFyIHVuZGVjb3JhdGVkTGVuZ3RoID0gdGhpcy5idWZmZXJMZW5ndGg7CiAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIDB4ODApOwogICAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgICAgfQogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgYml0c0hhc2hlZCk7CiAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgICB9CiAgICAgIC8vIFRoZSB2YWx1ZSBpbiBzdGF0ZSBpcyBsaXR0bGUtZW5kaWFuIHJhdGhlciB0aGFuIGJpZy1lbmRpYW4sIHNvIGZsaXAKICAgICAgLy8gZWFjaCB3b3JkIGludG8gYSBuZXcgVWludDhBcnJheQogICAgICB2YXIgb3V0ID0gbmV3IEJ1ZmZlcihESUdFU1RfTEVOR1RIKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgIG91dFtpICogNF0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMjQpICYgMHhmZjsKICAgICAgICAgIG91dFtpICogNCArIDFdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDE2KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAyXSA9ICh0aGlzLnN0YXRlW2ldID4+PiA4KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAzXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAwKSAmIDB4ZmY7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKICB9OwogIAogIFNoYTI1Ni5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9hID0gdGhpcywKICAgICAgICAgIGJ1ZmZlciA9IF9hLmJ1ZmZlciwKICAgICAgICAgIHN0YXRlID0gX2Euc3RhdGU7CiAgICAgIHZhciBzdGF0ZTAgPSBzdGF0ZVswXSwKICAgICAgICAgIHN0YXRlMSA9IHN0YXRlWzFdLAogICAgICAgICAgc3RhdGUyID0gc3RhdGVbMl0sCiAgICAgICAgICBzdGF0ZTMgPSBzdGF0ZVszXSwKICAgICAgICAgIHN0YXRlNCA9IHN0YXRlWzRdLAogICAgICAgICAgc3RhdGU1ID0gc3RhdGVbNV0sCiAgICAgICAgICBzdGF0ZTYgPSBzdGF0ZVs2XSwKICAgICAgICAgIHN0YXRlNyA9IHN0YXRlWzddOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgaWYgKGkgPCAxNikgewogICAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICgoKGJ1ZmZlcltpICogNF0gJiAweGZmKSA8PCAyNCkgfAogICAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMV0gJiAweGZmKSA8PCAxNikgfAogICAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMl0gJiAweGZmKSA8PCA4KSB8CiAgICAgICAgICAgICAgICAgIChidWZmZXJbKGkgKiA0KSArIDNdICYgMHhmZikpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHUgPSB0aGlzLnRlbXBbaSAtIDJdOwogICAgICAgICAgICAgIHZhciB0MV8xID0gKHUgPj4+IDE3IHwgdSA8PCAxNSkgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTkgfCB1IDw8IDEzKSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAxMCk7CiAgICAgICAgICAgICAgdSA9IHRoaXMudGVtcFtpIC0gMTVdOwogICAgICAgICAgICAgIHZhciB0Ml8xID0gKHUgPj4+IDcgfCB1IDw8IDI1KSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAxOCB8IHUgPDwgMTQpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDMpOwogICAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICh0MV8xICsgdGhpcy50ZW1wW2kgLSA3XSB8IDApICsKICAgICAgICAgICAgICAgICAgKHQyXzEgKyB0aGlzLnRlbXBbaSAtIDE2XSB8IDApOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHQxID0gKCgoKChzdGF0ZTQgPj4+IDYgfCBzdGF0ZTQgPDwgMjYpIF4KICAgICAgICAgICAgICAoc3RhdGU0ID4+PiAxMSB8IHN0YXRlNCA8PCAyMSkgXgogICAgICAgICAgICAgIChzdGF0ZTQgPj4+IDI1IHwgc3RhdGU0IDw8IDcpKQogICAgICAgICAgICAgICsgKChzdGF0ZTQgJiBzdGF0ZTUpIF4gKH5zdGF0ZTQgJiBzdGF0ZTYpKSkgfCAwKQogICAgICAgICAgICAgICsgKChzdGF0ZTcgKyAoKEtFWVtpXSArIHRoaXMudGVtcFtpXSkgfCAwKSkgfCAwKSkgfCAwOwogICAgICAgICAgdmFyIHQyID0gKCgoc3RhdGUwID4+PiAyIHwgc3RhdGUwIDw8IDMwKSBeCiAgICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMTMgfCBzdGF0ZTAgPDwgMTkpIF4KICAgICAgICAgICAgICAoc3RhdGUwID4+PiAyMiB8IHN0YXRlMCA8PCAxMCkpICsgKChzdGF0ZTAgJiBzdGF0ZTEpIF4gKHN0YXRlMCAmIHN0YXRlMikgXiAoc3RhdGUxICYgc3RhdGUyKSkpIHwgMDsKICAgICAgICAgIHN0YXRlNyA9IHN0YXRlNjsKICAgICAgICAgIHN0YXRlNiA9IHN0YXRlNTsKICAgICAgICAgIHN0YXRlNSA9IHN0YXRlNDsKICAgICAgICAgIHN0YXRlNCA9IChzdGF0ZTMgKyB0MSkgfCAwOwogICAgICAgICAgc3RhdGUzID0gc3RhdGUyOwogICAgICAgICAgc3RhdGUyID0gc3RhdGUxOwogICAgICAgICAgc3RhdGUxID0gc3RhdGUwOwogICAgICAgICAgc3RhdGUwID0gKHQxICsgdDIpIHwgMDsKICAgICAgfQogICAgICBzdGF0ZVswXSArPSBzdGF0ZTA7CiAgICAgIHN0YXRlWzFdICs9IHN0YXRlMTsKICAgICAgc3RhdGVbMl0gKz0gc3RhdGUyOwogICAgICBzdGF0ZVszXSArPSBzdGF0ZTM7CiAgICAgIHN0YXRlWzRdICs9IHN0YXRlNDsKICAgICAgc3RhdGVbNV0gKz0gc3RhdGU1OwogICAgICBzdGF0ZVs2XSArPSBzdGF0ZTY7CiAgICAgIHN0YXRlWzddICs9IHN0YXRlNzsKICB9OwogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MX1dLDE2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIAogIC8vIGJyb3dzZXIgc3BlY2lmaWMgbW9kdWxlcwogIHV0aWwuY3J5cHRvLmxpYiA9IHJlcXVpcmUoJy4vYnJvd3NlckNyeXB0b0xpYicpOwogIHV0aWwuQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB1dGlsLnVybCA9IHJlcXVpcmUoJ3VybC8nKTsKICB1dGlsLnF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcvJyk7CiAgdXRpbC5yZWFsQ2xvY2sgPSByZXF1aXJlKCcuL3JlYWxjbG9jay9icm93c2VyQ2xvY2snKTsKICB1dGlsLmVudmlyb25tZW50ID0gJ2pzJzsKICB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtID0gcmVxdWlyZSgnLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbScpLmNyZWF0ZUV2ZW50U3RyZWFtOwogIHV0aWwuaXNCcm93c2VyID0gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9OwogIHV0aWwuaXNOb2RlID0gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfTsKICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgCiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMnKTsKICAKICAvLyBMb2FkIHRoZSBET01QYXJzZXIgWE1MIHBhcnNlcgogIEFXUy5YTUwuUGFyc2VyID0gcmVxdWlyZSgnLi94bWwvYnJvd3Nlcl9wYXJzZXInKTsKICAKICAvLyBMb2FkIHRoZSBYSFIgSHR0cENsaWVudAogIHJlcXVpcmUoJy4vaHR0cC94aHInKTsKICAKICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgcHJvY2VzcyA9IHsKICAgICAgYnJvd3NlcjogdHJ1ZQogICAgfTsKICB9CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2Jyb3dzZXJDcnlwdG9MaWIiOjEwLCIuL2NvcmUiOjE4LCIuL2NyZWRlbnRpYWxzIjoxOSwiLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzIjoyMCwiLi9jcmVkZW50aWFscy9jb2duaXRvX2lkZW50aXR5X2NyZWRlbnRpYWxzIjoyMSwiLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluIjoyMiwiLi9jcmVkZW50aWFscy9zYW1sX2NyZWRlbnRpYWxzIjoyMywiLi9jcmVkZW50aWFscy90ZW1wb3JhcnlfY3JlZGVudGlhbHMiOjI0LCIuL2NyZWRlbnRpYWxzL3dlYl9pZGVudGl0eV9jcmVkZW50aWFscyI6MjUsIi4vZXZlbnQtc3RyZWFtL2J1ZmZlcmVkLWNyZWF0ZS1ldmVudC1zdHJlYW0iOjI3LCIuL2h0dHAveGhyIjozNSwiLi9yZWFsY2xvY2svYnJvd3NlckNsb2NrIjo1MiwiLi91dGlsIjo3MSwiLi94bWwvYnJvd3Nlcl9wYXJzZXIiOjcyLCJfcHJvY2VzcyI6ODYsImJ1ZmZlci8iOjgxLCJxdWVyeXN0cmluZy8iOjkyLCJ1cmwvIjo5NH1dLDE3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwogIHZhciBQcm9taXNlc0RlcGVuZGVuY3k7CiAgCiAgLyoqCiAgICogVGhlIG1haW4gY29uZmlndXJhdGlvbiBjbGFzcyB1c2VkIGJ5IGFsbCBzZXJ2aWNlIG9iamVjdHMgdG8gc2V0CiAgICogdGhlIHJlZ2lvbiwgY3JlZGVudGlhbHMsIGFuZCBvdGhlciBvcHRpb25zIGZvciByZXF1ZXN0cy4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGNyZWRlbnRpYWxzIGFuZCByZWdpb24gc2V0dGluZ3MgYXJlIGxlZnQgdW5jb25maWd1cmVkLgogICAqIFRoaXMgc2hvdWxkIGJlIGNvbmZpZ3VyZWQgYnkgdGhlIGFwcGxpY2F0aW9uIGJlZm9yZSB1c2luZyBhbnkKICAgKiBBV1Mgc2VydmljZSBBUElzLgogICAqCiAgICogSW4gb3JkZXIgdG8gc2V0IGdsb2JhbCBjb25maWd1cmF0aW9uIG9wdGlvbnMsIHByb3BlcnRpZXMgc2hvdWxkCiAgICogYmUgYXNzaWduZWQgdG8gdGhlIGdsb2JhbCB7QVdTLmNvbmZpZ30gb2JqZWN0LgogICAqCiAgICogQHNlZSBBV1MuY29uZmlnCiAgICoKICAgKiBAIWdyb3VwIEdlbmVyYWwgQ29uZmlndXJhdGlvbiBPcHRpb25zCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjcmVkZW50aWFscwogICAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgQVdTIGNyZWRlbnRpYWxzIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlZ2lvbgogICAqICAgQGV4YW1wbGUgU2V0IHRoZSBnbG9iYWwgcmVnaW9uIHNldHRpbmcgdG8gdXMtd2VzdC0yCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZWdpb246ICd1cy13ZXN0LTInfSk7CiAgICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIFRoZSByZWdpb24gdG8gc2VuZCBzZXJ2aWNlIHJlcXVlc3RzIHRvLgogICAqICAgQHNlZSBodHRwOi8vZG9jcy5hbWF6b253ZWJzZXJ2aWNlcy5jb20vZ2VuZXJhbC9sYXRlc3QvZ3IvcmFuZGUuaHRtbAogICAqICAgICBBIGxpc3Qgb2YgYXZhaWxhYmxlIGVuZHBvaW50cyBmb3IgZWFjaCBBV1Mgc2VydmljZQogICAqCiAgICogQCFhdHRyaWJ1dGUgbWF4UmV0cmllcwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJldHJpZXMgdG8gcGVyZm9ybSBmb3IgYQogICAqICAgICBzZXJ2aWNlIHJlcXVlc3QuIEJ5IGRlZmF1bHQgdGhpcyB2YWx1ZSBpcyBjYWxjdWxhdGVkIGJ5IHRoZSBzcGVjaWZpYwogICAqICAgICBzZXJ2aWNlIG9iamVjdCB0aGF0IHRoZSByZXF1ZXN0IGlzIGJlaW5nIG1hZGUgdG8uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtYXhSZWRpcmVjdHMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZWRpcmVjdHMgdG8gZm9sbG93IGZvciBhCiAgICogICAgIHNlcnZpY2UgcmVxdWVzdC4gRGVmYXVsdHMgdG8gMTAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbVZhbGlkYXRpb24KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMgc2hvdWxkIGJlIHZhbGlkYXRlZCBhZ2FpbnN0CiAgICogICAgIHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcgdGhlIHJlcXVlc3QuIERlZmF1bHRzIHRvIHRydWUuCiAgICogICAgIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAgICoKICAgKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAqICAgICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogICAqICAgICAgIHRvIGB0cnVlYC4KICAgKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAqICAgICAgIGNvbnN0cmFpbnQuCiAgICogICAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAqICAgICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAgICogICAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgKgogICAqIEAhYXR0cmlidXRlIGNvbXB1dGVDaGVja3N1bXMKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29tcHV0ZSBjaGVja3N1bXMgZm9yIHBheWxvYWQgYm9kaWVzIHdoZW4KICAgKiAgICAgdGhlIHNlcnZpY2UgYWNjZXB0cyBpdCAoY3VycmVudGx5IHN1cHBvcnRlZCBpbiBTMyBvbmx5KS4KICAgKgogICAqIEAhYXR0cmlidXRlIGNvbnZlcnRSZXNwb25zZVR5cGVzCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHR5cGVzIGFyZSBjb252ZXJ0ZWQgd2hlbiBwYXJzaW5nIHJlc3BvbnNlIGRhdGEuCiAgICogICAgIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBmb3IgSlNPTiBiYXNlZCBzZXJ2aWNlcy4gVHVybmluZyB0aGlzIG9mZiBtYXkKICAgKiAgICAgaW1wcm92ZSBwZXJmb3JtYW5jZSBvbiBsYXJnZSByZXNwb25zZSBwYXlsb2Fkcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29ycmVjdENsb2NrU2tldwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBhcHBseSBhIGNsb2NrIHNrZXcgY29ycmVjdGlvbiBhbmQgcmV0cnkKICAgKiAgICAgcmVxdWVzdHMgdGhhdCBmYWlsIGJlY2F1c2Ugb2YgYW4gc2tld2VkIGNsaWVudCBjbG9jay4gRGVmYXVsdHMgdG8KICAgKiAgICAgYGZhbHNlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHNzbEVuYWJsZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgU1NMIGlzIGVuYWJsZWQgZm9yIHJlcXVlc3RzCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzM0ZvcmNlUGF0aFN0eWxlCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGZvcmNlIHBhdGggc3R5bGUgVVJMcyBmb3IgUzMgb2JqZWN0cwogICAqCiAgICogQCFhdHRyaWJ1dGUgczNCdWNrZXRFbmRwb2ludAogICAqICAgQG5vdGUgU2V0dGluZyB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIHJlcXVpcmVzIGFuIGBlbmRwb2ludGAgdG8gYmUKICAgKiAgICAgcHJvdmlkZWQgZXhwbGljaXRseSB0byB0aGUgc2VydmljZSBjb25zdHJ1Y3Rvci4KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGVuZHBvaW50IGFkZHJlc3NlcyBhbiBpbmRpdmlkdWFsCiAgICogICAgIGJ1Y2tldCAoZmFsc2UgaWYgaXQgYWRkcmVzc2VzIHRoZSByb290IEFQSSBlbmRwb2ludCkuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzM0Rpc2FibGVCb2R5U2lnbmluZwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBkaXNhYmxlIFMzIGJvZHkgc2lnbmluZyB3aGVuIHVzaW5nIHNpZ25hdHVyZSB2ZXJzaW9uIGB2NGAuCiAgICogICAgIEJvZHkgc2lnbmluZyBjYW4gb25seSBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIGh0dHBzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSB1c2VBY2NlbGVyYXRlRW5kcG9pbnQKICAgKiAgIEBub3RlIFRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gaXMgb25seSBjb21wYXRpYmxlIHdpdGggUzMgd2hpbGUgYWNjZXNzaW5nCiAgICogICAgIGRucy1jb21wYXRpYmxlIGJ1Y2tldHMuCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSBXaGV0aGVyIHRvIHVzZSB0aGUgQWNjZWxlcmF0ZSBlbmRwb2ludCB3aXRoIHRoZSBTMyBzZXJ2aWNlLgogICAqICAgICBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmV0cnlEZWxheU9wdGlvbnMKICAgKiAgIEBleGFtcGxlIFNldCB0aGUgYmFzZSByZXRyeSBkZWxheSBmb3IgYWxsIHNlcnZpY2VzIHRvIDMwMCBtcwogICAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmV0cnlEZWxheU9wdGlvbnM6IHtiYXNlOiAzMDB9fSk7CiAgICogICAgIC8vIERlbGF5cyB3aXRoIG1heFJldHJpZXMgPSAzOiAzMDAsIDYwMCwgMTIwMAogICAqICAgQGV4YW1wbGUgU2V0IGEgY3VzdG9tIGJhY2tvZmYgZnVuY3Rpb24gdG8gcHJvdmlkZSBkZWxheSB2YWx1ZXMgb24gcmV0cmllcwogICAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmV0cnlEZWxheU9wdGlvbnM6IHtjdXN0b21CYWNrb2ZmOiBmdW5jdGlvbihyZXRyeUNvdW50KSB7CiAgICogICAgICAgLy8gcmV0dXJucyBkZWxheSBpbiBtcwogICAqICAgICB9fX0pOwogICAqICAgQHJldHVybiBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIGNvbmZpZ3VyZSB0aGUgcmV0cnkgZGVsYXkgb24gcmV0cnlhYmxlIGVycm9ycy4KICAgKiAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgKgogICAqICAgICAqICoqYmFzZSoqIFtJbnRlZ2VyXSAmbWRhc2g7IFRoZSBiYXNlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdXNlIGluIHRoZQogICAqICAgICAgIGV4cG9uZW50aWFsIGJhY2tvZmYgZm9yIG9wZXJhdGlvbiByZXRyaWVzLiBEZWZhdWx0cyB0byAxMDAgbXMgZm9yIGFsbCBzZXJ2aWNlcyBleGNlcHQKICAgKiAgICAgICBEeW5hbW9EQiwgd2hlcmUgaXQgZGVmYXVsdHMgdG8gNTBtcy4KICAgKiAgICAgKiAqKmN1c3RvbUJhY2tvZmYgKiogW2Z1bmN0aW9uXSAmbWRhc2g7IEEgY3VzdG9tIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBhIHJldHJ5IGNvdW50CiAgICogICAgICAgYW5kIHJldHVybnMgdGhlIGFtb3VudCBvZiB0aW1lIHRvIGRlbGF5IGluIG1pbGxpc2Vjb25kcy4gVGhlIGBiYXNlYCBvcHRpb24gd2lsbCBiZQogICAqICAgICAgIGlnbm9yZWQgaWYgdGhpcyBvcHRpb24gaXMgc3VwcGxpZWQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBodHRwT3B0aW9ucwogICAqICAgQHJldHVybiBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIHBhc3MgdG8gdGhlIGxvdy1sZXZlbCBIVFRQIHJlcXVlc3QuCiAgICogICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICoKICAgKiAgICAgKiAqKnByb3h5KiogW1N0cmluZ10gJm1kYXNoOyB0aGUgVVJMIHRvIHByb3h5IHJlcXVlc3RzIHRocm91Z2gKICAgKiAgICAgKiAqKmFnZW50KiogW2h0dHAuQWdlbnQsIGh0dHBzLkFnZW50XSAmbWRhc2g7IHRoZSBBZ2VudCBvYmplY3QgdG8gcGVyZm9ybQogICAqICAgICAgIEhUVFAgcmVxdWVzdHMgd2l0aC4gVXNlZCBmb3IgY29ubmVjdGlvbiBwb29saW5nLiBOb3RlIHRoYXQgZm9yCiAgICogICAgICAgU1NMIGNvbm5lY3Rpb25zLCBhIHNwZWNpYWwgQWdlbnQgb2JqZWN0IGlzIHVzZWQgaW4gb3JkZXIgdG8gZW5hYmxlCiAgICogICAgICAgcGVlciBjZXJ0aWZpY2F0ZSB2ZXJpZmljYXRpb24uIFRoaXMgZmVhdHVyZSBpcyBvbmx5IHN1cHBvcnRlZCBpbiB0aGUKICAgKiAgICAgICBOb2RlLmpzIGVudmlyb25tZW50LgogICAqICAgICAqICoqY29ubmVjdFRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlcgogICAqICAgICAgIGZhaWxpbmcgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIgYWZ0ZXIKICAgKiAgICAgICBgY29ubmVjdFRpbWVvdXRgIG1pbGxpc2Vjb25kcy4gVGhpcyB0aW1lb3V0IGhhcyBubyBlZmZlY3Qgb25jZSBhIHNvY2tldAogICAqICAgICAgIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQuCiAgICogICAgICogKip0aW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIgdGltZW91dAogICAqICAgICAgIG1pbGxpc2Vjb25kcyBvZiBpbmFjdGl2aXR5IG9uIHRoZSBzb2NrZXQuIERlZmF1bHRzIHRvIHR3byBtaW51dGVzCiAgICogICAgICAgKDEyMDAwMCkKICAgKiAgICAgKiAqKnhockFzeW5jKiogW0Jvb2xlYW5dICZtZGFzaDsgV2hldGhlciB0aGUgU0RLIHdpbGwgc2VuZCBhc3luY2hyb25vdXMKICAgKiAgICAgICBIVFRQIHJlcXVlc3RzLiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9ubHkuIFNldCB0byBmYWxzZSB0bwogICAqICAgICAgIHNlbmQgcmVxdWVzdHMgc3luY2hyb25vdXNseS4gRGVmYXVsdHMgdG8gdHJ1ZSAoYXN5bmMgb24pLgogICAqICAgICAqICoqeGhyV2l0aENyZWRlbnRpYWxzKiogW0Jvb2xlYW5dICZtZGFzaDsgU2V0cyB0aGUgIndpdGhDcmVkZW50aWFscyIKICAgKiAgICAgICBwcm9wZXJ0eSBvZiBhbiBYTUxIdHRwUmVxdWVzdCBvYmplY3QuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQKICAgKiAgICAgICBvbmx5LiBEZWZhdWx0cyB0byBmYWxzZS4KICAgKiBAIWF0dHJpYnV0ZSBsb2dnZXIKICAgKiAgIEByZXR1cm4gWyN3cml0ZSwjbG9nXSBhbiBvYmplY3QgdGhhdCByZXNwb25kcyB0byAud3JpdGUoKSAobGlrZSBhIHN0cmVhbSkKICAgKiAgICAgb3IgLmxvZygpIChsaWtlIHRoZSBjb25zb2xlIG9iamVjdCkgaW4gb3JkZXIgdG8gbG9nIGluZm9ybWF0aW9uIGFib3V0CiAgICogICAgIHJlcXVlc3RzCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzeXN0ZW1DbG9ja09mZnNldAogICAqICAgQHJldHVybiBbTnVtYmVyXSBhbiBvZmZzZXQgdmFsdWUgaW4gbWlsbGlzZWNvbmRzIHRvIGFwcGx5IHRvIGFsbCBzaWduaW5nCiAgICogICAgIHRpbWVzLiBVc2UgdGhpcyB0byBjb21wZW5zYXRlIGZvciBjbG9jayBza2V3IHdoZW4geW91ciBzeXN0ZW0gbWF5IGJlCiAgICogICAgIG91dCBvZiBzeW5jIHdpdGggdGhlIHNlcnZpY2UgdGltZS4gTm90ZSB0aGF0IHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24KICAgKiAgICAgY2FuIG9ubHkgYmUgYXBwbGllZCB0byB0aGUgZ2xvYmFsIGBBV1MuY29uZmlnYCBvYmplY3QgYW5kIGNhbm5vdCBiZQogICAqICAgICBvdmVycmlkZGVuIGluIHNlcnZpY2Utc3BlY2lmaWMgY29uZmlndXJhdGlvbi4gRGVmYXVsdHMgdG8gMCBtaWxsaXNlY29uZHMuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzaWduYXR1cmVWZXJzaW9uCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBzaWduYXR1cmUgdmVyc2lvbiB0byBzaWduIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcKICAgKiAgICAgdGhlIEFQSSBjb25maWd1cmF0aW9uKS4gUG9zc2libGUgdmFsdWVzIGFyZTogJ3YyJywgJ3YzJywgJ3Y0Jy4KICAgKgogICAqIEAhYXR0cmlidXRlIHNpZ25hdHVyZUNhY2hlCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBzaWduYXR1cmUgdG8gc2lnbiByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nCiAgICogICAgIHRoZSBBUEkgY29uZmlndXJhdGlvbikgaXMgY2FjaGVkLiBPbmx5IGFwcGxpZXMgdG8gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uICd2NCcuCiAgICogICAgIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5IGZvciBvcGVyYXRpb25zIHRoYXQKICAgKiAgICAgYWxsb3cgb3B0aW9uYWxseSB1c2luZyBhbiBlbmRwb2ludCByZXR1cm5lZCBieSB0aGUgc2VydmljZS4KICAgKiAgICAgRGVmYXVsdHMgdG8gJ2ZhbHNlJwogICAqCiAgICogQCFhdHRyaWJ1dGUgZW5kcG9pbnRDYWNoZVNpemUKICAgKiAgIEByZXR1cm4gW051bWJlcl0gdGhlIHNpemUgb2YgdGhlIGdsb2JhbCBjYWNoZSBzdG9yaW5nIGVuZHBvaW50cyBmcm9tIGVuZHBvaW50CiAgICogICAgIGRpc2NvdmVyeSBvcGVyYXRpb25zLiBPbmNlIGVuZHBvaW50IGNhY2hlIGlzIGNyZWF0ZWQsIHVwZGF0aW5nIHRoaXMgc2V0dGluZwogICAqICAgICBjYW5ub3QgY2hhbmdlIGV4aXN0aW5nIGNhY2hlIHNpemUuCiAgICogICAgIERlZmF1bHRzIHRvIDEwMDAKICAgKgogICAqIEAhYXR0cmlidXRlIGhvc3RQcmVmaXhFbmFibGVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIG1hcnNoYWwgcmVxdWVzdCBwYXJhbWV0ZXJzIHRvIHRoZSBwcmVmaXggb2YKICAgKiAgICAgaG9zdG5hbWUuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHN0c1JlZ2lvbmFsRW5kcG9pbnRzCiAgICogICBAcmV0dXJuIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGV0aGVyIHRvIHNlbmQgc3RzIHJlcXVlc3QgdG8gZ2xvYmFsIGVuZHBvaW50cyBvcgogICAqICAgICByZWdpb25hbCBlbmRwb2ludHMuCiAgICogICAgIERlZmF1bHRzIHRvICdsZWdhY3knCiAgICovCiAgQVdTLkNvbmZpZyA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBAIWVuZGdyb3VwCiAgICAgKi8KICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjb25maWd1cmF0aW9uIG9iamVjdC4gVGhpcyBpcyB0aGUgb2JqZWN0IHRoYXQgcGFzc2VzCiAgICAgKiBvcHRpb24gZGF0YSBhbG9uZyB0byBzZXJ2aWNlIHJlcXVlc3RzLCBpbmNsdWRpbmcgY3JlZGVudGlhbHMsIHNlY3VyaXR5LAogICAgICogcmVnaW9uIGluZm9ybWF0aW9uLCBhbmQgc29tZSBzZXJ2aWNlIHNwZWNpZmljIHNldHRpbmdzLgogICAgICoKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggY3JlZGVudGlhbHMgYW5kIHJlZ2lvbgogICAgICogICB2YXIgY29uZmlnID0gbmV3IEFXUy5Db25maWcoewogICAgICogICAgIGFjY2Vzc0tleUlkOiAnQUtJRCcsIHNlY3JldEFjY2Vzc0tleTogJ1NFQ1JFVCcsIHJlZ2lvbjogJ3VzLXdlc3QtMicKICAgICAqICAgfSk7CiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgYWNjZXNzS2V5SWQgW1N0cmluZ10geW91ciBBV1MgYWNjZXNzIGtleSBJRC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10geW91ciBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2Vzc2lvblRva2VuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBvcHRpb25hbCBBV1MKICAgICAqICAgc2Vzc2lvbiB0b2tlbiB0byBzaWduIHJlcXVlc3RzIHdpdGguCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIEFXUyBjcmVkZW50aWFscwogICAgICogICB0byBzaWduIHJlcXVlc3RzIHdpdGguIFlvdSBjYW4gZWl0aGVyIHNwZWNpZnkgdGhpcyBvYmplY3QsIG9yCiAgICAgKiAgIHNwZWNpZnkgdGhlIGFjY2Vzc0tleUlkIGFuZCBzZWNyZXRBY2Nlc3NLZXkgb3B0aW9ucyBkaXJlY3RseS4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjcmVkZW50aWFsUHJvdmlkZXIgW0FXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl0gdGhlCiAgICAgKiAgIHByb3ZpZGVyIGNoYWluIHVzZWQgdG8gcmVzb2x2ZSBjcmVkZW50aWFscyBpZiBubyBzdGF0aWMgYGNyZWRlbnRpYWxzYAogICAgICogICBwcm9wZXJ0eSBpcyBzZXQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcmVnaW9uIFtTdHJpbmddIHRoZSByZWdpb24gdG8gc2VuZCBzZXJ2aWNlIHJlcXVlc3RzIHRvLgogICAgICogICBTZWUge3JlZ2lvbn0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbWF4UmV0cmllcyBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJldHJpZXMgdG8KICAgICAqICAgYXR0ZW1wdCB3aXRoIGEgcmVxdWVzdC4gU2VlIHttYXhSZXRyaWVzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBtYXhSZWRpcmVjdHMgW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZWRpcmVjdHMgdG8KICAgICAqICAgZm9sbG93IHdpdGggYSByZXF1ZXN0LiBTZWUge21heFJlZGlyZWN0c30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc3NsRW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgU1NMIGZvcgogICAgICogICByZXF1ZXN0cy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBwYXJhbVZhbGlkYXRpb24gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMKICAgICAqICAgc2hvdWxkIGJlIHZhbGlkYXRlZCBhZ2FpbnN0IHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcKICAgICAqICAgdGhlIHJlcXVlc3QuIERlZmF1bHRzIHRvIHRydWUuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUKICAgICAqICAgZm9sbG93aW5nIHNwZWNpZmljIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAgICAgKgogICAgICogICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICAgKiAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICAgKiAgICAgdG8gYHRydWVgLgogICAgICogICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICAgKiAgICAgY29uc3RyYWludC4KICAgICAqICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgICAqICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKiAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgICAqICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNvbXB1dGVDaGVja3N1bXMgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29tcHV0ZSBjaGVja3N1bXMKICAgICAqICAgZm9yIHBheWxvYWQgYm9kaWVzIHdoZW4gdGhlIHNlcnZpY2UgYWNjZXB0cyBpdCAoY3VycmVudGx5IHN1cHBvcnRlZAogICAgICogICBpbiBTMyBvbmx5KQogICAgICogQG9wdGlvbiBvcHRpb25zIGNvbnZlcnRSZXNwb25zZVR5cGVzIFtCb29sZWFuXSB3aGV0aGVyIHR5cGVzIGFyZSBjb252ZXJ0ZWQKICAgICAqICAgICB3aGVuIHBhcnNpbmcgcmVzcG9uc2UgZGF0YS4gQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGZvciBKU09OIGJhc2VkCiAgICAgKiAgICAgc2VydmljZXMuIFR1cm5pbmcgdGhpcyBvZmYgbWF5IGltcHJvdmUgcGVyZm9ybWFuY2Ugb24gbGFyZ2UgcmVzcG9uc2UKICAgICAqICAgICBwYXlsb2Fkcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNvcnJlY3RDbG9ja1NrZXcgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gYXBwbHkgYSBjbG9jayBza2V3CiAgICAgKiAgICAgY29ycmVjdGlvbiBhbmQgcmV0cnkgcmVxdWVzdHMgdGhhdCBmYWlsIGJlY2F1c2Ugb2YgYW4gc2tld2VkIGNsaWVudAogICAgICogICAgIGNsb2NrLiBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHMzRm9yY2VQYXRoU3R5bGUgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZm9yY2UgcGF0aAogICAgICogICBzdHlsZSBVUkxzIGZvciBTMyBvYmplY3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHMzQnVja2V0RW5kcG9pbnQgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGVuZHBvaW50CiAgICAgKiAgIGFkZHJlc3NlcyBhbiBpbmRpdmlkdWFsIGJ1Y2tldCAoZmFsc2UgaWYgaXQgYWRkcmVzc2VzIHRoZSByb290IEFQSQogICAgICogICBlbmRwb2ludCkuIE5vdGUgdGhhdCBzZXR0aW5nIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gcmVxdWlyZXMgYW4KICAgICAqICAgYGVuZHBvaW50YCB0byBiZSBwcm92aWRlZCBleHBsaWNpdGx5IHRvIHRoZSBzZXJ2aWNlIGNvbnN0cnVjdG9yLgogICAgICogQG9wdGlvbiBvcHRpb25zIHMzRGlzYWJsZUJvZHlTaWduaW5nIFtCb29sZWFuXSB3aGV0aGVyIFMzIGJvZHkgc2lnbmluZwogICAgICogICBzaG91bGQgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBzaWduYXR1cmUgdmVyc2lvbiBgdjRgLiBCb2R5IHNpZ25pbmcKICAgICAqICAgY2FuIG9ubHkgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBodHRwcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICoKICAgICAqIEBvcHRpb24gb3B0aW9ucyByZXRyeURlbGF5T3B0aW9ucyBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIGNvbmZpZ3VyZQogICAgICogICB0aGUgcmV0cnkgZGVsYXkgb24gcmV0cnlhYmxlIGVycm9ycy4gQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgICAqCiAgICAgKiAgICogKipiYXNlKiogW0ludGVnZXJdICZtZGFzaDsgVGhlIGJhc2UgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB1c2UgaW4gdGhlCiAgICAgKiAgICAgZXhwb25lbnRpYWwgYmFja29mZiBmb3Igb3BlcmF0aW9uIHJldHJpZXMuIERlZmF1bHRzIHRvIDEwMCBtcyBmb3IgYWxsCiAgICAgKiAgICAgc2VydmljZXMgZXhjZXB0IER5bmFtb0RCLCB3aGVyZSBpdCBkZWZhdWx0cyB0byA1MG1zLgogICAgICogICAqICoqY3VzdG9tQmFja29mZiAqKiBbZnVuY3Rpb25dICZtZGFzaDsgQSBjdXN0b20gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgcmV0cnkgY291bnQKICAgICAqICAgICBhbmQgcmV0dXJucyB0aGUgYW1vdW50IG9mIHRpbWUgdG8gZGVsYXkgaW4gbWlsbGlzZWNvbmRzLiBUaGUgYGJhc2VgIG9wdGlvbiB3aWxsIGJlCiAgICAgKiAgICAgaWdub3JlZCBpZiB0aGlzIG9wdGlvbiBpcyBzdXBwbGllZC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBodHRwT3B0aW9ucyBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIHBhc3MgdG8gdGhlIGxvdy1sZXZlbAogICAgICogICBIVFRQIHJlcXVlc3QuIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICAgKgogICAgICogICAqICoqcHJveHkqKiBbU3RyaW5nXSAmbWRhc2g7IHRoZSBVUkwgdG8gcHJveHkgcmVxdWVzdHMgdGhyb3VnaAogICAgICogICAqICoqYWdlbnQqKiBbaHR0cC5BZ2VudCwgaHR0cHMuQWdlbnRdICZtZGFzaDsgdGhlIEFnZW50IG9iamVjdCB0byBwZXJmb3JtCiAgICAgKiAgICAgSFRUUCByZXF1ZXN0cyB3aXRoLiBVc2VkIGZvciBjb25uZWN0aW9uIHBvb2xpbmcuIERlZmF1bHRzIHRvIHRoZSBnbG9iYWwKICAgICAqICAgICBhZ2VudCAoYGh0dHAuZ2xvYmFsQWdlbnRgKSBmb3Igbm9uLVNTTCBjb25uZWN0aW9ucy4gTm90ZSB0aGF0IGZvcgogICAgICogICAgIFNTTCBjb25uZWN0aW9ucywgYSBzcGVjaWFsIEFnZW50IG9iamVjdCBpcyB1c2VkIGluIG9yZGVyIHRvIGVuYWJsZQogICAgICogICAgIHBlZXIgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uLiBUaGlzIGZlYXR1cmUgaXMgb25seSBhdmFpbGFibGUgaW4gdGhlCiAgICAgKiAgICAgTm9kZS5qcyBlbnZpcm9ubWVudC4KICAgICAqICAgKiAqKmNvbm5lY3RUaW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIKICAgICAqICAgICBmYWlsaW5nIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyIGFmdGVyCiAgICAgKiAgICAgYGNvbm5lY3RUaW1lb3V0YCBtaWxsaXNlY29uZHMuIFRoaXMgdGltZW91dCBoYXMgbm8gZWZmZWN0IG9uY2UgYSBzb2NrZXQKICAgICAqICAgICBjb25uZWN0aW9uIGhhcyBiZWVuIGVzdGFibGlzaGVkLgogICAgICogICAqICoqdGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyIHRpbWVvdXQKICAgICAqICAgICBtaWxsaXNlY29uZHMgb2YgaW5hY3Rpdml0eSBvbiB0aGUgc29ja2V0LiBEZWZhdWx0cyB0byB0d28gbWludXRlcwogICAgICogICAgICgxMjAwMDApLgogICAgICogICAqICoqeGhyQXN5bmMqKiBbQm9vbGVhbl0gJm1kYXNoOyBXaGV0aGVyIHRoZSBTREsgd2lsbCBzZW5kIGFzeW5jaHJvbm91cwogICAgICogICAgIEhUVFAgcmVxdWVzdHMuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb25seS4gU2V0IHRvIGZhbHNlIHRvCiAgICAgKiAgICAgc2VuZCByZXF1ZXN0cyBzeW5jaHJvbm91c2x5LiBEZWZhdWx0cyB0byB0cnVlIChhc3luYyBvbikuCiAgICAgKiAgICogKip4aHJXaXRoQ3JlZGVudGlhbHMqKiBbQm9vbGVhbl0gJm1kYXNoOyBTZXRzIHRoZSAid2l0aENyZWRlbnRpYWxzIgogICAgICogICAgIHByb3BlcnR5IG9mIGFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdC4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudAogICAgICogICAgIG9ubHkuIERlZmF1bHRzIHRvIGZhbHNlLgogICAgICogQG9wdGlvbiBvcHRpb25zIGFwaVZlcnNpb24gW1N0cmluZywgRGF0ZV0gYSBTdHJpbmcgaW4gWVlZWS1NTS1ERCBmb3JtYXQKICAgICAqICAgKG9yIGEgZGF0ZSkgdGhhdCByZXByZXNlbnRzIHRoZSBsYXRlc3QgcG9zc2libGUgQVBJIHZlcnNpb24gdGhhdCBjYW4gYmUKICAgICAqICAgdXNlZCBpbiBhbGwgc2VydmljZXMgKHVubGVzcyBvdmVycmlkZGVuIGJ5IGBhcGlWZXJzaW9uc2ApLiBTcGVjaWZ5CiAgICAgKiAgICdsYXRlc3QnIHRvIHVzZSB0aGUgbGF0ZXN0IHBvc3NpYmxlIHZlcnNpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgYXBpVmVyc2lvbnMgW21hcDxTdHJpbmcsIFN0cmluZ3xEYXRlPl0gYSBtYXAgb2Ygc2VydmljZQogICAgICogICBpZGVudGlmaWVycyAodGhlIGxvd2VyY2FzZSBzZXJ2aWNlIGNsYXNzIG5hbWUpIHdpdGggdGhlIEFQSSB2ZXJzaW9uIHRvCiAgICAgKiAgIHVzZSB3aGVuIGluc3RhbnRpYXRpbmcgYSBzZXJ2aWNlLiBTcGVjaWZ5ICdsYXRlc3QnIGZvciBlYWNoIGluZGl2aWR1YWwKICAgICAqICAgdGhhdCBjYW4gdXNlIHRoZSBsYXRlc3QgYXZhaWxhYmxlIHZlcnNpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbG9nZ2VyIFsjd3JpdGUsI2xvZ10gYW4gb2JqZWN0IHRoYXQgcmVzcG9uZHMgdG8gLndyaXRlKCkKICAgICAqICAgKGxpa2UgYSBzdHJlYW0pIG9yIC5sb2coKSAobGlrZSB0aGUgY29uc29sZSBvYmplY3QpIGluIG9yZGVyIHRvIGxvZwogICAgICogICBpbmZvcm1hdGlvbiBhYm91dCByZXF1ZXN0cwogICAgICogQG9wdGlvbiBvcHRpb25zIHN5c3RlbUNsb2NrT2Zmc2V0IFtOdW1iZXJdIGFuIG9mZnNldCB2YWx1ZSBpbiBtaWxsaXNlY29uZHMKICAgICAqICAgdG8gYXBwbHkgdG8gYWxsIHNpZ25pbmcgdGltZXMuIFVzZSB0aGlzIHRvIGNvbXBlbnNhdGUgZm9yIGNsb2NrIHNrZXcKICAgICAqICAgd2hlbiB5b3VyIHN5c3RlbSBtYXkgYmUgb3V0IG9mIHN5bmMgd2l0aCB0aGUgc2VydmljZSB0aW1lLiBOb3RlIHRoYXQKICAgICAqICAgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiBjYW4gb25seSBiZSBhcHBsaWVkIHRvIHRoZSBnbG9iYWwgYEFXUy5jb25maWdgCiAgICAgKiAgIG9iamVjdCBhbmQgY2Fubm90IGJlIG92ZXJyaWRkZW4gaW4gc2VydmljZS1zcGVjaWZpYyBjb25maWd1cmF0aW9uLgogICAgICogICBEZWZhdWx0cyB0byAwIG1pbGxpc2Vjb25kcy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzaWduYXR1cmVWZXJzaW9uIFtTdHJpbmddIHRoZSBzaWduYXR1cmUgdmVyc2lvbiB0byBzaWduCiAgICAgKiAgIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcgdGhlIEFQSSBjb25maWd1cmF0aW9uKS4gUG9zc2libGUgdmFsdWVzIGFyZToKICAgICAqICAgJ3YyJywgJ3YzJywgJ3Y0Jy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzaWduYXR1cmVDYWNoZSBbQm9vbGVhbl0gd2hldGhlciB0aGUgc2lnbmF0dXJlIHRvIHNpZ24KICAgICAqICAgcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZyB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pIGlzIGNhY2hlZC4gT25seSBhcHBsaWVzCiAgICAgKiAgIHRvIHRoZSBzaWduYXR1cmUgdmVyc2lvbiAndjQnLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgZHluYW1vRGJDcmMzMiBbQm9vbGVhbl0gd2hldGhlciB0byB2YWxpZGF0ZSB0aGUgQ1JDMzIKICAgICAqICAgY2hlY2tzdW0gb2YgSFRUUCByZXNwb25zZSBib2RpZXMgcmV0dXJuZWQgYnkgRHluYW1vREIuIERlZmF1bHQ6IGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyB1c2VBY2NlbGVyYXRlRW5kcG9pbnQgW0Jvb2xlYW5dIFdoZXRoZXIgdG8gdXNlIHRoZQogICAgICogICBTMyBUcmFuc2ZlciBBY2NlbGVyYXRpb24gZW5kcG9pbnQgd2l0aCB0aGUgUzMgc2VydmljZS4gRGVmYXVsdDogYGZhbHNlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjbGllbnRTaWRlTW9uaXRvcmluZyBbQm9vbGVhbl0gd2hldGhlciB0byBjb2xsZWN0IGFuZAogICAgICogICBwdWJsaXNoIHRoaXMgY2xpZW50J3MgcGVyZm9ybWFuY2UgbWV0cmljcyBvZiBhbGwgaXRzIEFQSSByZXF1ZXN0cy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZW5hYmxlIGVuZHBvaW50CiAgICAgKiAgIGRpc2NvdmVyeSBmb3Igb3BlcmF0aW9ucyB0aGF0IGFsbG93IG9wdGlvbmFsbHkgdXNpbmcgYW4gZW5kcG9pbnQgcmV0dXJuZWQgYnkKICAgICAqICAgdGhlIHNlcnZpY2UuCiAgICAgKiAgIERlZmF1bHRzIHRvICdmYWxzZScKICAgICAqIEBvcHRpb24gb3B0aW9ucyBlbmRwb2ludENhY2hlU2l6ZSBbTnVtYmVyXSB0aGUgc2l6ZSBvZiB0aGUgZ2xvYmFsIGNhY2hlIHN0b3JpbmcKICAgICAqICAgZW5kcG9pbnRzIGZyb20gZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbnMuIE9uY2UgZW5kcG9pbnQgY2FjaGUgaXMgY3JlYXRlZCwKICAgICAqICAgdXBkYXRpbmcgdGhpcyBzZXR0aW5nIGNhbm5vdCBjaGFuZ2UgZXhpc3RpbmcgY2FjaGUgc2l6ZS4KICAgICAqICAgRGVmYXVsdHMgdG8gMTAwMAogICAgICogQG9wdGlvbiBvcHRpb25zIGhvc3RQcmVmaXhFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIG1hcnNoYWwgcmVxdWVzdAogICAgICogICBwYXJhbWV0ZXJzIHRvIHRoZSBwcmVmaXggb2YgaG9zdG5hbWUuCiAgICAgKiAgIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzdHNSZWdpb25hbEVuZHBvaW50cyBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hldGhlciB0byBzZW5kIHN0cyByZXF1ZXN0CiAgICAgKiAgIHRvIGdsb2JhbCBlbmRwb2ludHMgb3IgcmVnaW9uYWwgZW5kcG9pbnRzLgogICAgICogICBEZWZhdWx0cyB0byAnbGVnYWN5Jy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENvbmZpZyhvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB1bmRlZmluZWQpIG9wdGlvbnMgPSB7fTsKICAgICAgb3B0aW9ucyA9IHRoaXMuZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpOwogIAogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5rZXlzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgb3B0aW9uc1trZXldLCB2YWx1ZSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFncm91cCBNYW5hZ2luZyBDcmVkZW50aWFscwogICAgICovCiAgCiAgICAvKioKICAgICAqIExvYWRzIGNyZWRlbnRpYWxzIGZyb20gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBUaGlzIGlzIHVzZWQgaW50ZXJuYWxseQogICAgICogYnkgdGhlIFNESyB0byBlbnN1cmUgdGhhdCByZWZyZXNoYWJsZSB7Q3JlZGVudGlhbHN9IG9iamVjdHMgYXJlIHByb3Blcmx5CiAgICAgKiByZWZyZXNoZWQgYW5kIGxvYWRlZCB3aGVuIHNlbmRpbmcgYSByZXF1ZXN0LiBJZiB5b3Ugd2FudCB0byBlbnN1cmUgdGhhdAogICAgICogeW91ciBjcmVkZW50aWFscyBhcmUgbG9hZGVkIHByaW9yIHRvIGEgcmVxdWVzdCwgeW91IGNhbiB1c2UgdGhpcyBtZXRob2QKICAgICAqIGRpcmVjdGx5IHRvIHByb3ZpZGUgYWNjdXJhdGUgY3JlZGVudGlhbCBkYXRhIHN0b3JlZCBpbiB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBub3RlIElmIHlvdSBjb25maWd1cmUgdGhlIFNESyB3aXRoIHN0YXRpYyBvciBlbnZpcm9ubWVudCBjcmVkZW50aWFscywKICAgICAqICAgdGhlIGNyZWRlbnRpYWwgZGF0YSBzaG91bGQgYWxyZWFkeSBiZSBwcmVzZW50IGluIHtjcmVkZW50aWFsc30gYXR0cmlidXRlLgogICAgICogICBUaGlzIG1ldGhvZCBpcyBwcmltYXJpbHkgbmVjZXNzYXJ5IHRvIGxvYWQgY3JlZGVudGlhbHMgZnJvbSBhc3luY2hyb25vdXMKICAgICAqICAgc291cmNlcywgb3Igc291cmNlcyB0aGF0IGNhbiByZWZyZXNoIGNyZWRlbnRpYWxzIHBlcmlvZGljYWxseS4KICAgICAqIEBleGFtcGxlIEdldHRpbmcgeW91ciBhY2Nlc3Mga2V5CiAgICAgKiAgIEFXUy5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICAgKiAgICAgaWYgKGVycikgY29uc29sZS5sb2coZXJyLnN0YWNrKTsgLy8gY3JlZGVudGlhbHMgbm90IGxvYWRlZAogICAgICogICAgIGVsc2UgY29uc29sZS5sb2coIkFjY2VzcyBLZXk6IiwgQVdTLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCk7CiAgICAgKiAgIH0pCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUge2NyZWRlbnRpYWxzfSBoYXZlIGJlZW4gcHJvcGVybHkgc2V0IG9uIHRoZSBjb25maWd1cmF0aW9uCiAgICAgKiAgIG9iamVjdC4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiB0aGlzIGlzIHNldCwgY3JlZGVudGlhbHMgd2VyZSBub3Qgc3VjY2Vzc2Z1bGx5CiAgICAgKiAgICAgbG9hZGVkIGFuZCB0aGlzIGVycm9yIHByb3ZpZGVzIGluZm9ybWF0aW9uIHdoeS4KICAgICAqIEBzZWUgY3JlZGVudGlhbHMKICAgICAqIEBzZWUgQ3JlZGVudGlhbHMKICAgICAqLwogICAgZ2V0Q3JlZGVudGlhbHM6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgZnVuY3Rpb24gZmluaXNoKGVycikgewogICAgICAgIGNhbGxiYWNrKGVyciwgZXJyID8gbnVsbCA6IHNlbGYuY3JlZGVudGlhbHMpOwogICAgICB9CiAgCiAgICAgIGZ1bmN0aW9uIGNyZWRFcnJvcihtc2csIGVycikgewogICAgICAgIHJldHVybiBuZXcgQVdTLnV0aWwuZXJyb3IoZXJyIHx8IG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnQ3JlZGVudGlhbHNFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiBtc2csCiAgICAgICAgICBuYW1lOiAnQ3JlZGVudGlhbHNFcnJvcicKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICBmdW5jdGlvbiBnZXRBc3luY0NyZWRlbnRpYWxzKCkgewogICAgICAgIHNlbGYuY3JlZGVudGlhbHMuZ2V0KGZ1bmN0aW9uKGVycikgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICB2YXIgbXNnID0gJ0NvdWxkIG5vdCBsb2FkIGNyZWRlbnRpYWxzIGZyb20gJyArCiAgICAgICAgICAgICAgc2VsZi5jcmVkZW50aWFscy5jb25zdHJ1Y3Rvci5uYW1lOwogICAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IobXNnLCBlcnIpOwogICAgICAgICAgfQogICAgICAgICAgZmluaXNoKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgZnVuY3Rpb24gZ2V0U3RhdGljQ3JlZGVudGlhbHMoKSB7CiAgICAgICAgdmFyIGVyciA9IG51bGw7CiAgICAgICAgaWYgKCFzZWxmLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkIHx8ICFzZWxmLmNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSkgewogICAgICAgICAgZXJyID0gY3JlZEVycm9yKCdNaXNzaW5nIGNyZWRlbnRpYWxzJyk7CiAgICAgICAgfQogICAgICAgIGZpbmlzaChlcnIpOwogICAgICB9CiAgCiAgICAgIGlmIChzZWxmLmNyZWRlbnRpYWxzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzZWxmLmNyZWRlbnRpYWxzLmdldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgZ2V0QXN5bmNDcmVkZW50aWFscygpOwogICAgICAgIH0gZWxzZSB7IC8vIHN0YXRpYyBjcmVkZW50aWFscwogICAgICAgICAgZ2V0U3RhdGljQ3JlZGVudGlhbHMoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5jcmVkZW50aWFsUHJvdmlkZXIpIHsKICAgICAgICBzZWxmLmNyZWRlbnRpYWxQcm92aWRlci5yZXNvbHZlKGZ1bmN0aW9uKGVyciwgY3JlZHMpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgZXJyID0gY3JlZEVycm9yKCdDb3VsZCBub3QgbG9hZCBjcmVkZW50aWFscyBmcm9tIGFueSBwcm92aWRlcnMnLCBlcnIpOwogICAgICAgICAgfQogICAgICAgICAgc2VsZi5jcmVkZW50aWFscyA9IGNyZWRzOwogICAgICAgICAgZmluaXNoKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZmluaXNoKGNyZWRFcnJvcignTm8gY3JlZGVudGlhbHMgdG8gbG9hZCcpKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQCFncm91cCBMb2FkaW5nIGFuZCBTZXR0aW5nIENvbmZpZ3VyYXRpb24gT3B0aW9ucwogICAgICovCiAgCiAgICAvKioKICAgICAqIEBvdmVybG9hZCB1cGRhdGUob3B0aW9ucywgYWxsb3dVbmtub3duS2V5cyA9IGZhbHNlKQogICAgICogICBVcGRhdGVzIHRoZSBjdXJyZW50IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggbmV3IG9wdGlvbnMuCiAgICAgKgogICAgICogICBAZXhhbXBsZSBVcGRhdGUgbWF4UmV0cmllcyBwcm9wZXJ0eSBvZiBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiAgICAgY29uZmlnLnVwZGF0ZSh7bWF4UmV0cmllczogMTB9KTsKICAgICAqICAgQHBhcmFtIFtPYmplY3RdIG9wdGlvbnMgYSBtYXAgb2Ygb3B0aW9uIGtleXMgYW5kIHZhbHVlcy4KICAgICAqICAgQHBhcmFtIFtCb29sZWFuXSBhbGxvd1Vua25vd25LZXlzIHdoZXRoZXIgdW5rbm93biBrZXlzIGNhbiBiZSBzZXQgb24KICAgICAqICAgICB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICAgKiAgIEBzZWUgY29uc3RydWN0b3IKICAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUob3B0aW9ucywgYWxsb3dVbmtub3duS2V5cykgewogICAgICBhbGxvd1Vua25vd25LZXlzID0gYWxsb3dVbmtub3duS2V5cyB8fCBmYWxzZTsKICAgICAgb3B0aW9ucyA9IHRoaXMuZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpOwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoYWxsb3dVbmtub3duS2V5cyB8fCBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5rZXlzLCBrZXkpIHx8CiAgICAgICAgICAgIEFXUy5TZXJ2aWNlLmhhc1NlcnZpY2Uoa2V5KSkgewogICAgICAgICAgdGhpcy5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIExvYWRzIGNvbmZpZ3VyYXRpb24gZGF0YSBmcm9tIGEgSlNPTiBmaWxlIGludG8gdGhpcyBjb25maWcgb2JqZWN0LgogICAgICogQG5vdGUgTG9hZGluZyBjb25maWd1cmF0aW9uIHdpbGwgcmVzZXQgYWxsIGV4aXN0aW5nIGNvbmZpZ3VyYXRpb24KICAgICAqICAgb24gdGhlIG9iamVjdC4KICAgICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICAgKiBAcGFyYW0gcGF0aCBbU3RyaW5nXSB0aGUgcGF0aCByZWxhdGl2ZSB0byB5b3VyIHByb2Nlc3MncyBjdXJyZW50CiAgICAgKiAgICB3b3JraW5nIGRpcmVjdG9yeSB0byBsb2FkIGNvbmZpZ3VyYXRpb24gZnJvbS4KICAgICAqIEByZXR1cm4gW0FXUy5Db25maWddIHRoZSBzYW1lIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKi8KICAgIGxvYWRGcm9tUGF0aDogZnVuY3Rpb24gbG9hZEZyb21QYXRoKHBhdGgpIHsKICAgICAgdGhpcy5jbGVhcigpOwogIAogICAgICB2YXIgb3B0aW9ucyA9IEpTT04ucGFyc2UoQVdTLnV0aWwucmVhZEZpbGVTeW5jKHBhdGgpKTsKICAgICAgdmFyIGZpbGVTeXN0ZW1DcmVkcyA9IG5ldyBBV1MuRmlsZVN5c3RlbUNyZWRlbnRpYWxzKHBhdGgpOwogICAgICB2YXIgY2hhaW4gPSBuZXcgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKCk7CiAgICAgIGNoYWluLnByb3ZpZGVycy51bnNoaWZ0KGZpbGVTeXN0ZW1DcmVkcyk7CiAgICAgIGNoYWluLnJlc29sdmUoZnVuY3Rpb24gKGVyciwgY3JlZHMpIHsKICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAgICAgZWxzZSBvcHRpb25zLmNyZWRlbnRpYWxzID0gY3JlZHM7CiAgICAgIH0pOwogIAogICAgICB0aGlzLmNvbnN0cnVjdG9yKG9wdGlvbnMpOwogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENsZWFycyBjb25maWd1cmF0aW9uIGRhdGEgb24gdGhpcyBvYmplY3QKICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAvKmpzaGludCBmb3JpbjpmYWxzZSAqLwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5rZXlzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgICAgfSk7CiAgCiAgICAgIC8vIHJlc2V0IGNyZWRlbnRpYWwgcHJvdmlkZXIKICAgICAgdGhpcy5zZXQoJ2NyZWRlbnRpYWxzJywgdW5kZWZpbmVkKTsKICAgICAgdGhpcy5zZXQoJ2NyZWRlbnRpYWxQcm92aWRlcicsIHVuZGVmaW5lZCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBTZXRzIGEgcHJvcGVydHkgb24gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LCBhbGxvd2luZyBmb3IgYQogICAgICogZGVmYXVsdCB2YWx1ZQogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldDogZnVuY3Rpb24gc2V0KHByb3BlcnR5LCB2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBkZWZhdWx0VmFsdWUgPSB0aGlzLmtleXNbcHJvcGVydHldOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGRlZmF1bHRWYWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBkZWZhdWx0VmFsdWUuY2FsbCh0aGlzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHByb3BlcnR5ID09PSAnaHR0cE9wdGlvbnMnICYmIHRoaXNbcHJvcGVydHldKSB7CiAgICAgICAgLy8gZGVlcCBtZXJnZSBodHRwT3B0aW9ucwogICAgICAgIHRoaXNbcHJvcGVydHldID0gQVdTLnV0aWwubWVyZ2UodGhpc1twcm9wZXJ0eV0sIHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBbGwgb2YgdGhlIGtleXMgd2l0aCB0aGVpciBkZWZhdWx0IHZhbHVlcy4KICAgICAqCiAgICAgKiBAY29uc3RhbnQKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBrZXlzOiB7CiAgICAgIGNyZWRlbnRpYWxzOiBudWxsLAogICAgICBjcmVkZW50aWFsUHJvdmlkZXI6IG51bGwsCiAgICAgIHJlZ2lvbjogbnVsbCwKICAgICAgbG9nZ2VyOiBudWxsLAogICAgICBhcGlWZXJzaW9uczoge30sCiAgICAgIGFwaVZlcnNpb246IG51bGwsCiAgICAgIGVuZHBvaW50OiB1bmRlZmluZWQsCiAgICAgIGh0dHBPcHRpb25zOiB7CiAgICAgICAgdGltZW91dDogMTIwMDAwCiAgICAgIH0sCiAgICAgIG1heFJldHJpZXM6IHVuZGVmaW5lZCwKICAgICAgbWF4UmVkaXJlY3RzOiAxMCwKICAgICAgcGFyYW1WYWxpZGF0aW9uOiB0cnVlLAogICAgICBzc2xFbmFibGVkOiB0cnVlLAogICAgICBzM0ZvcmNlUGF0aFN0eWxlOiBmYWxzZSwKICAgICAgczNCdWNrZXRFbmRwb2ludDogZmFsc2UsCiAgICAgIHMzRGlzYWJsZUJvZHlTaWduaW5nOiB0cnVlLAogICAgICBjb21wdXRlQ2hlY2tzdW1zOiB0cnVlLAogICAgICBjb252ZXJ0UmVzcG9uc2VUeXBlczogdHJ1ZSwKICAgICAgY29ycmVjdENsb2NrU2tldzogZmFsc2UsCiAgICAgIGN1c3RvbVVzZXJBZ2VudDogbnVsbCwKICAgICAgZHluYW1vRGJDcmMzMjogdHJ1ZSwKICAgICAgc3lzdGVtQ2xvY2tPZmZzZXQ6IDAsCiAgICAgIHNpZ25hdHVyZVZlcnNpb246IG51bGwsCiAgICAgIHNpZ25hdHVyZUNhY2hlOiB0cnVlLAogICAgICByZXRyeURlbGF5T3B0aW9uczoge30sCiAgICAgIHVzZUFjY2VsZXJhdGVFbmRwb2ludDogZmFsc2UsCiAgICAgIGNsaWVudFNpZGVNb25pdG9yaW5nOiBmYWxzZSwKICAgICAgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkOiBmYWxzZSwKICAgICAgZW5kcG9pbnRDYWNoZVNpemU6IDEwMDAsCiAgICAgIGhvc3RQcmVmaXhFbmFibGVkOiB0cnVlLAogICAgICBzdHNSZWdpb25hbEVuZHBvaW50czogbnVsbAogICAgfSwKICAKICAgIC8qKgogICAgICogRXh0cmFjdHMgYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleSBhbmQgc2Vzc2lvblRva2VuCiAgICAgKiBmcm9tIGEgY29uZmlndXJhdGlvbiBoYXNoLgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBleHRyYWN0Q3JlZGVudGlhbHM6IGZ1bmN0aW9uIGV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zLmFjY2Vzc0tleUlkICYmIG9wdGlvbnMuc2VjcmV0QWNjZXNzS2V5KSB7CiAgICAgICAgb3B0aW9ucyA9IEFXUy51dGlsLmNvcHkob3B0aW9ucyk7CiAgICAgICAgb3B0aW9ucy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMob3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBwcm9taXNlIGRlcGVuZGVuY3kgdGhlIFNESyB3aWxsIHVzZSB3aGVyZXZlciBQcm9taXNlcyBhcmUgcmV0dXJuZWQuCiAgICAgKiBQYXNzaW5nIGBudWxsYCB3aWxsIGZvcmNlIHRoZSBTREsgdG8gdXNlIG5hdGl2ZSBQcm9taXNlcyBpZiB0aGV5IGFyZSBhdmFpbGFibGUuCiAgICAgKiBJZiBuYXRpdmUgUHJvbWlzZXMgYXJlIG5vdCBhdmFpbGFibGUsIHBhc3NpbmcgYG51bGxgIHdpbGwgaGF2ZSBubyBlZmZlY3QuCiAgICAgKiBAcGFyYW0gW0NvbnN0cnVjdG9yXSBkZXAgQSByZWZlcmVuY2UgdG8gYSBQcm9taXNlIGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIHNldFByb21pc2VzRGVwZW5kZW5jeTogZnVuY3Rpb24gc2V0UHJvbWlzZXNEZXBlbmRlbmN5KGRlcCkgewogICAgICBQcm9taXNlc0RlcGVuZGVuY3kgPSBkZXA7CiAgICAgIC8vIGlmIG51bGwgd2FzIHBhc3NlZCBpbiwgd2Ugc2hvdWxkIHRyeSB0byB1c2UgbmF0aXZlIHByb21pc2VzCiAgICAgIGlmIChkZXAgPT09IG51bGwgJiYgdHlwZW9mIFByb21pc2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBQcm9taXNlc0RlcGVuZGVuY3kgPSBQcm9taXNlOwogICAgICB9CiAgICAgIHZhciBjb25zdHJ1Y3RvcnMgPSBbQVdTLlJlcXVlc3QsIEFXUy5DcmVkZW50aWFscywgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXTsKICAgICAgaWYgKEFXUy5TMykgewogICAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKEFXUy5TMyk7CiAgICAgICAgaWYgKEFXUy5TMy5NYW5hZ2VkVXBsb2FkKSB7CiAgICAgICAgICBjb25zdHJ1Y3RvcnMucHVzaChBV1MuUzMuTWFuYWdlZFVwbG9hZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIEFXUy51dGlsLmFkZFByb21pc2VzKGNvbnN0cnVjdG9ycywgUHJvbWlzZXNEZXBlbmRlbmN5KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEdldHMgdGhlIHByb21pc2UgZGVwZW5kZW5jeSBzZXQgYnkgYEFXUy5jb25maWcuc2V0UHJvbWlzZXNEZXBlbmRlbmN5YC4KICAgICAqLwogICAgZ2V0UHJvbWlzZXNEZXBlbmRlbmN5OiBmdW5jdGlvbiBnZXRQcm9taXNlc0RlcGVuZGVuY3koKSB7CiAgICAgIHJldHVybiBQcm9taXNlc0RlcGVuZGVuY3k7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQHJldHVybiBbQVdTLkNvbmZpZ10gVGhlIGdsb2JhbCBjb25maWd1cmF0aW9uIG9iamVjdCBzaW5nbGV0b24gaW5zdGFuY2UKICAgKiBAcmVhZG9ubHkKICAgKiBAc2VlIEFXUy5Db25maWcKICAgKi8KICBBV1MuY29uZmlnID0gbmV3IEFXUy5Db25maWcoKTsKICAKICB9LHsiLi9jb3JlIjoxOCwiLi9jcmVkZW50aWFscyI6MTksIi4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbiI6MjJ9XSwxODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogVGhlIG1haW4gQVdTIG5hbWVzcGFjZQogICAqLwogIHZhciBBV1MgPSB7IHV0aWw6IHJlcXVpcmUoJy4vdXRpbCcpIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogQCFtYWNybyBbbmV3XSBub2Jyb3dzZXIKICAgKiAgIEBub3RlIFRoaXMgZmVhdHVyZSBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9mIHRoZSBTREsuCiAgICovCiAgdmFyIF9oaWRkZW4gPSB7fTsgX2hpZGRlbi50b1N0cmluZygpOyAvLyBoYWNrIHRvIHBhcnNlIG1hY3JvCiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUywgewogIAogICAgLyoqCiAgICAgKiBAY29uc3RhbnQKICAgICAqLwogICAgVkVSU0lPTjogJzIuNTUzLjAnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgU2lnbmVyczoge30sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBQcm90b2NvbDogewogICAgICBKc29uOiByZXF1aXJlKCcuL3Byb3RvY29sL2pzb24nKSwKICAgICAgUXVlcnk6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKSwKICAgICAgUmVzdDogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0JyksCiAgICAgIFJlc3RKc29uOiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfanNvbicpLAogICAgICBSZXN0WG1sOiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfeG1sJykKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBYTUw6IHsKICAgICAgQnVpbGRlcjogcmVxdWlyZSgnLi94bWwvYnVpbGRlcicpLAogICAgICBQYXJzZXI6IG51bGwgLy8gY29uZGl0aW9uYWxseSBzZXQgYmFzZWQgb24gZW52aXJvbm1lbnQKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBKU09OOiB7CiAgICAgIEJ1aWxkZXI6IHJlcXVpcmUoJy4vanNvbi9idWlsZGVyJyksCiAgICAgIFBhcnNlcjogcmVxdWlyZSgnLi9qc29uL3BhcnNlcicpCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgTW9kZWw6IHsKICAgICAgQXBpOiByZXF1aXJlKCcuL21vZGVsL2FwaScpLAogICAgICBPcGVyYXRpb246IHJlcXVpcmUoJy4vbW9kZWwvb3BlcmF0aW9uJyksCiAgICAgIFNoYXBlOiByZXF1aXJlKCcuL21vZGVsL3NoYXBlJyksCiAgICAgIFBhZ2luYXRvcjogcmVxdWlyZSgnLi9tb2RlbC9wYWdpbmF0b3InKSwKICAgICAgUmVzb3VyY2VXYWl0ZXI6IHJlcXVpcmUoJy4vbW9kZWwvcmVzb3VyY2Vfd2FpdGVyJykKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcGlMb2FkZXI6IHJlcXVpcmUoJy4vYXBpX2xvYWRlcicpLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgRW5kcG9pbnRDYWNoZTogcmVxdWlyZSgnLi4vdmVuZG9yL2VuZHBvaW50LWNhY2hlJykuRW5kcG9pbnRDYWNoZQogIH0pOwogIHJlcXVpcmUoJy4vc2VxdWVudGlhbF9leGVjdXRvcicpOwogIHJlcXVpcmUoJy4vc2VydmljZScpOwogIHJlcXVpcmUoJy4vY29uZmlnJyk7CiAgcmVxdWlyZSgnLi9odHRwJyk7CiAgcmVxdWlyZSgnLi9ldmVudF9saXN0ZW5lcnMnKTsKICByZXF1aXJlKCcuL3JlcXVlc3QnKTsKICByZXF1aXJlKCcuL3Jlc3BvbnNlJyk7CiAgcmVxdWlyZSgnLi9yZXNvdXJjZV93YWl0ZXInKTsKICByZXF1aXJlKCcuL3NpZ25lcnMvcmVxdWVzdF9zaWduZXInKTsKICByZXF1aXJlKCcuL3BhcmFtX3ZhbGlkYXRvcicpOwogIAogIC8qKgogICAqIEByZWFkb25seQogICAqIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIGEgY29sbGVjdGlvbiBvZiBnbG9iYWwgZXZlbnQgbGlzdGVuZXJzIHRoYXQKICAgKiAgIGFyZSBhdHRhY2hlZCB0byBldmVyeSBzZW50IHJlcXVlc3QuCiAgICogQHNlZSBBV1MuUmVxdWVzdCBBV1MuUmVxdWVzdCBmb3IgYSBsaXN0IG9mIGV2ZW50cyB0byBsaXN0ZW4gZm9yCiAgICogQGV4YW1wbGUgTG9nZ2luZyB0aGUgdGltZSB0YWtlbiB0byBzZW5kIGEgcmVxdWVzdAogICAqICAgQVdTLmV2ZW50cy5vbignc2VuZCcsIGZ1bmN0aW9uIHN0YXJ0U2VuZChyZXNwKSB7CiAgICogICAgIHJlc3Auc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICogICB9KS5vbignY29tcGxldGUnLCBmdW5jdGlvbiBjYWxjdWxhdGVUaW1lKHJlc3ApIHsKICAgKiAgICAgdmFyIHRpbWUgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkgLSByZXNwLnN0YXJ0VGltZSkgLyAxMDAwOwogICAqICAgICBjb25zb2xlLmxvZygnUmVxdWVzdCB0b29rICcgKyB0aW1lICsgJyBzZWNvbmRzJyk7CiAgICogICB9KTsKICAgKgogICAqICAgbmV3IEFXUy5TMygpLmxpc3RCdWNrZXRzKCk7IC8vIHByaW50cyAnUmVxdWVzdCB0b29rIDAuMjg1IHNlY29uZHMnCiAgICovCiAgQVdTLmV2ZW50cyA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgCiAgLy9jcmVhdGUgZW5kcG9pbnQgY2FjaGUgbGF6aWx5CiAgQVdTLnV0aWwubWVtb2l6ZWRQcm9wZXJ0eShBV1MsICdlbmRwb2ludENhY2hlJywgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IEFXUy5FbmRwb2ludENhY2hlKEFXUy5jb25maWcuZW5kcG9pbnRDYWNoZVNpemUpOwogIH0sIHRydWUpOwogIAogIH0seyIuLi92ZW5kb3IvZW5kcG9pbnQtY2FjaGUiOjEwMywiLi9hcGlfbG9hZGVyIjo5LCIuL2NvbmZpZyI6MTcsIi4vZXZlbnRfbGlzdGVuZXJzIjozMywiLi9odHRwIjozNCwiLi9qc29uL2J1aWxkZXIiOjM2LCIuL2pzb24vcGFyc2VyIjozNywiLi9tb2RlbC9hcGkiOjM4LCIuL21vZGVsL29wZXJhdGlvbiI6NDAsIi4vbW9kZWwvcGFnaW5hdG9yIjo0MSwiLi9tb2RlbC9yZXNvdXJjZV93YWl0ZXIiOjQyLCIuL21vZGVsL3NoYXBlIjo0MywiLi9wYXJhbV92YWxpZGF0b3IiOjQ0LCIuL3Byb3RvY29sL2pzb24iOjQ2LCIuL3Byb3RvY29sL3F1ZXJ5Ijo0NywiLi9wcm90b2NvbC9yZXN0Ijo0OCwiLi9wcm90b2NvbC9yZXN0X2pzb24iOjQ5LCIuL3Byb3RvY29sL3Jlc3RfeG1sIjo1MCwiLi9yZXF1ZXN0Ijo1NSwiLi9yZXNvdXJjZV93YWl0ZXIiOjU2LCIuL3Jlc3BvbnNlIjo1NywiLi9zZXF1ZW50aWFsX2V4ZWN1dG9yIjo1OCwiLi9zZXJ2aWNlIjo1OSwiLi9zaWduZXJzL3JlcXVlc3Rfc2lnbmVyIjo2MywiLi91dGlsIjo3MSwiLi94bWwvYnVpbGRlciI6NzN9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgeW91ciBBV1Mgc2VjdXJpdHkgY3JlZGVudGlhbHMsIHNwZWNpZmljYWxseSB0aGUKICAgKiB7YWNjZXNzS2V5SWR9LCB7c2VjcmV0QWNjZXNzS2V5fSwgYW5kIG9wdGlvbmFsIHtzZXNzaW9uVG9rZW59LgogICAqIENyZWF0aW5nIGEgYENyZWRlbnRpYWxzYCBvYmplY3QgYWxsb3dzIHlvdSB0byBwYXNzIGFyb3VuZCB5b3VyCiAgICogc2VjdXJpdHkgaW5mb3JtYXRpb24gdG8gY29uZmlndXJhdGlvbiBhbmQgc2VydmljZSBvYmplY3RzLgogICAqCiAgICogTm90ZSB0aGF0IHRoaXMgY2xhc3MgdHlwaWNhbGx5IGRvZXMgbm90IG5lZWQgdG8gYmUgY29uc3RydWN0ZWQgbWFudWFsbHksCiAgICogYXMgdGhlIHtBV1MuQ29uZmlnfSBhbmQge0FXUy5TZXJ2aWNlfSBjbGFzc2VzIGJvdGggYWNjZXB0IHNpbXBsZQogICAqIG9wdGlvbnMgaGFzaGVzIHdpdGggdGhlIHRocmVlIGtleXMuIFRoZXNlIHN0cnVjdHVyZXMgd2lsbCBiZSBjb252ZXJ0ZWQKICAgKiBpbnRvIENyZWRlbnRpYWxzIG9iamVjdHMgYXV0b21hdGljYWxseS4KICAgKgogICAqICMjIEV4cGlyaW5nIGFuZCBSZWZyZXNoaW5nIENyZWRlbnRpYWxzCiAgICoKICAgKiBPY2Nhc2lvbmFsbHkgY3JlZGVudGlhbHMgY2FuIGV4cGlyZSBpbiB0aGUgbWlkZGxlIG9mIGEgbG9uZy1ydW5uaW5nCiAgICogYXBwbGljYXRpb24uIEluIHRoaXMgY2FzZSwgdGhlIFNESyB3aWxsIGF1dG9tYXRpY2FsbHkgYXR0ZW1wdCB0bwogICAqIHJlZnJlc2ggdGhlIGNyZWRlbnRpYWxzIGZyb20gdGhlIHN0b3JhZ2UgbG9jYXRpb24gaWYgdGhlIENyZWRlbnRpYWxzCiAgICogY2xhc3MgaW1wbGVtZW50cyB0aGUge3JlZnJlc2h9IG1ldGhvZC4KICAgKgogICAqIElmIHlvdSBhcmUgaW1wbGVtZW50aW5nIGEgY3JlZGVudGlhbCBzdG9yYWdlIGxvY2F0aW9uLCB5b3UKICAgKiB3aWxsIHdhbnQgdG8gY3JlYXRlIGEgc3ViY2xhc3Mgb2YgdGhlIGBDcmVkZW50aWFsc2AgY2xhc3MgYW5kCiAgICogb3ZlcnJpZGUgdGhlIHtyZWZyZXNofSBtZXRob2QuIFRoaXMgbWV0aG9kIGFsbG93cyBjcmVkZW50aWFscyB0byBiZQogICAqIHJldHJpZXZlZCBmcm9tIHRoZSBiYWNraW5nIHN0b3JlLCBiZSBpdCBhIGZpbGUgc3lzdGVtLCBkYXRhYmFzZSwgb3IKICAgKiBzb21lIG5ldHdvcmsgc3RvcmFnZS4gVGhlIG1ldGhvZCBzaG91bGQgcmVzZXQgdGhlIGNyZWRlbnRpYWwgYXR0cmlidXRlcwogICAqIG9uIHRoZSBvYmplY3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBleHBpcmVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBjcmVkZW50aWFscyBoYXZlIGJlZW4gZXhwaXJlZCBhbmQKICAgKiAgICAgcmVxdWlyZSBhIHJlZnJlc2guIFVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7ZXhwaXJlVGltZX0uCiAgICogQCFhdHRyaWJ1dGUgZXhwaXJlVGltZQogICAqICAgQHJldHVybiBbRGF0ZV0gYSB0aW1lIHdoZW4gY3JlZGVudGlhbHMgc2hvdWxkIGJlIGNvbnNpZGVyZWQgZXhwaXJlZC4gVXNlZAogICAqICAgICBpbiBjb25qdW5jdGlvbiB3aXRoIHtleHBpcmVkfS4KICAgKiBAIWF0dHJpYnV0ZSBhY2Nlc3NLZXlJZAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgKiBAIWF0dHJpYnV0ZSBzZWNyZXRBY2Nlc3NLZXkKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAqIEAhYXR0cmlidXRlIHNlc3Npb25Ub2tlbgogICAqICAgQHJldHVybiBbU3RyaW5nXSBhbiBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAqLwogIEFXUy5DcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBBIGNyZWRlbnRpYWxzIG9iamVjdCBjYW4gYmUgY3JlYXRlZCB1c2luZyBwb3NpdGlvbmFsIGFyZ3VtZW50cyBvciBhbiBvcHRpb25zCiAgICAgKiBoYXNoLgogICAgICoKICAgICAqIEBvdmVybG9hZCBBV1MuQ3JlZGVudGlhbHMoYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleSwgc2Vzc2lvblRva2VuPW51bGwpCiAgICAgKiAgIENyZWF0ZXMgYSBDcmVkZW50aWFscyBvYmplY3Qgd2l0aCBhIGdpdmVuIHNldCBvZiBjcmVkZW50aWFsIGluZm9ybWF0aW9uCiAgICAgKiAgIGFzIHBvc2l0aW9uYWwgYXJndW1lbnRzLgogICAgICogICBAcGFyYW0gYWNjZXNzS2V5SWQgW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICAgKiAgIEBwYXJhbSBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAgICogICBAcGFyYW0gc2Vzc2lvblRva2VuIFtTdHJpbmddIHRoZSBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAgICogICBAZXhhbXBsZSBDcmVhdGUgYSBjcmVkZW50aWFscyBvYmplY3Qgd2l0aCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgY3JlZHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKCdha2lkJywgJ3NlY3JldCcsICdzZXNzaW9uJyk7CiAgICAgKiBAb3ZlcmxvYWQgQVdTLkNyZWRlbnRpYWxzKG9wdGlvbnMpCiAgICAgKiAgIENyZWF0ZXMgYSBDcmVkZW50aWFscyBvYmplY3Qgd2l0aCBhIGdpdmVuIHNldCBvZiBjcmVkZW50aWFsIGluZm9ybWF0aW9uCiAgICAgKiAgIGFzIGFuIG9wdGlvbnMgaGFzaC4KICAgICAqICAgQG9wdGlvbiBvcHRpb25zIGFjY2Vzc0tleUlkIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAgICogICBAb3B0aW9uIG9wdGlvbnMgc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgICAqICAgQG9wdGlvbiBvcHRpb25zIHNlc3Npb25Ub2tlbiBbU3RyaW5nXSB0aGUgb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgICAqICAgQGV4YW1wbGUgQ3JlYXRlIGEgY3JlZGVudGlhbHMgb2JqZWN0IHdpdGggQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGNyZWRzID0gbmV3IEFXUy5DcmVkZW50aWFscyh7CiAgICAgKiAgICAgICBhY2Nlc3NLZXlJZDogJ2FraWQnLCBzZWNyZXRBY2Nlc3NLZXk6ICdzZWNyZXQnLCBzZXNzaW9uVG9rZW46ICdzZXNzaW9uJwogICAgICogICAgIH0pOwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ3JlZGVudGlhbHMoKSB7CiAgICAgIC8vIGhpZGUgc2VjcmV0QWNjZXNzS2V5IGZyb20gYmVpbmcgZGlzcGxheWVkIHdpdGggdXRpbC5pbnNwZWN0CiAgICAgIEFXUy51dGlsLmhpZGVQcm9wZXJ0aWVzKHRoaXMsIFsnc2VjcmV0QWNjZXNzS2V5J10pOwogIAogICAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgdGhpcy5leHBpcmVUaW1lID0gbnVsbDsKICAgICAgdGhpcy5yZWZyZXNoQ2FsbGJhY2tzID0gW107CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgdmFyIGNyZWRzID0gYXJndW1lbnRzWzBdLmNyZWRlbnRpYWxzIHx8IGFyZ3VtZW50c1swXTsKICAgICAgICB0aGlzLmFjY2Vzc0tleUlkID0gY3JlZHMuYWNjZXNzS2V5SWQ7CiAgICAgICAgdGhpcy5zZWNyZXRBY2Nlc3NLZXkgPSBjcmVkcy5zZWNyZXRBY2Nlc3NLZXk7CiAgICAgICAgdGhpcy5zZXNzaW9uVG9rZW4gPSBjcmVkcy5zZXNzaW9uVG9rZW47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hY2Nlc3NLZXlJZCA9IGFyZ3VtZW50c1swXTsKICAgICAgICB0aGlzLnNlY3JldEFjY2Vzc0tleSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICB0aGlzLnNlc3Npb25Ub2tlbiA9IGFyZ3VtZW50c1syXTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiBzZWNvbmRzIGJlZm9yZSB7ZXhwaXJlVGltZX0gZHVyaW5nIHdoaWNoCiAgICAgKiAgIHRoZSBjcmVkZW50aWFscyB3aWxsIGJlIGNvbnNpZGVyZWQgZXhwaXJlZC4KICAgICAqLwogICAgZXhwaXJ5V2luZG93OiAxNSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHNob3VsZCBjYWxsIHtyZWZyZXNofQogICAgICogQG5vdGUgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gcHJvdmlkZSBjdXN0b20gcmVmcmVzaAogICAgICogICBsb2dpYy4KICAgICAqLwogICAgbmVlZHNSZWZyZXNoOiBmdW5jdGlvbiBuZWVkc1JlZnJlc2goKSB7CiAgICAgIHZhciBjdXJyZW50VGltZSA9IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpLmdldFRpbWUoKTsKICAgICAgdmFyIGFkanVzdGVkVGltZSA9IG5ldyBEYXRlKGN1cnJlbnRUaW1lICsgdGhpcy5leHBpcnlXaW5kb3cgKiAxMDAwKTsKICAKICAgICAgaWYgKHRoaXMuZXhwaXJlVGltZSAmJiBhZGp1c3RlZFRpbWUgPiB0aGlzLmV4cGlyZVRpbWUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5leHBpcmVkIHx8ICF0aGlzLmFjY2Vzc0tleUlkIHx8ICF0aGlzLnNlY3JldEFjY2Vzc0tleTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgZXhpc3RpbmcgY3JlZGVudGlhbHMsIHJlZnJlc2hpbmcgdGhlbSBpZiB0aGV5IGFyZSBub3QgeWV0IGxvYWRlZAogICAgICogb3IgaGF2ZSBleHBpcmVkLiBVc2VycyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmUgdXNpbmcge3JlZnJlc2h9LAogICAgICogYXMgdGhpcyB3aWxsIG5vdCBhdHRlbXB0IHRvIHJlbG9hZCBjcmVkZW50aWFscyB3aGVuIHRoZXkgYXJlIGFscmVhZHkKICAgICAqIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyBlaXRoZXIgY3JlZGVudGlhbHMKICAgICAqICAgZG8gbm90IG5lZWQgdG8gYmUgcmVmcmVzaGVkIG9yIHJlZnJlc2hlZCBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMKICAgICAqICAgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsCiAgICAgKiAgIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKi8KICAgIGdldDogZnVuY3Rpb24gZ2V0KGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHRoaXMubmVlZHNSZWZyZXNoKCkpIHsKICAgICAgICB0aGlzLnJlZnJlc2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoIWVycikgc2VsZi5leHBpcmVkID0gZmFsc2U7IC8vIHJlc2V0IGV4cGlyZWQgZmxhZwogICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIGdldFByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBHZXRzIHRoZSBleGlzdGluZyBjcmVkZW50aWFscywgcmVmcmVzaGluZyB0aGVtIGlmIHRoZXkgYXJlIG5vdCB5ZXQgbG9hZGVkCiAgICAgKiAgIG9yIGhhdmUgZXhwaXJlZC4gVXNlcnMgc2hvdWxkIGNhbGwgdGhpcyBtZXRob2QgYmVmb3JlIHVzaW5nIHtyZWZyZXNofSwKICAgICAqICAgYXMgdGhpcyB3aWxsIG5vdCBhdHRlbXB0IHRvIHJlbG9hZCBjcmVkZW50aWFscyB3aGVuIHRoZXkgYXJlIGFscmVhZHkKICAgICAqICAgbG9hZGVkIGludG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKCkKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLiBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkLCBpdAogICAgICogICAgIG1lYW5zIGVpdGhlciBjcmVkZW50aWFscyBkbyBub3QgbmVlZCB0byBiZSByZWZyZXNoZWQgb3IgcmVmcmVzaGVkCiAgICAgKiAgICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlCiAgICAgKiAgICAgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGBnZXRgIGNhbGwuCiAgICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGBnZXRQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjcmVkUHJvdmlkZXIuZ2V0UHJvbWlzZSgpOwogICAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIHJlZnJlc2hQcm9taXNlKCkKICAgICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqICAgUmVmcmVzaGVzIHRoZSBjcmVkZW50aWFscy4gVXNlcnMgc2hvdWxkIGNhbGwge2dldH0gYmVmb3JlIGF0dGVtcHRpbmcKICAgICAqICAgdG8gZm9yY2libHkgcmVmcmVzaCBjcmVkZW50aWFscy4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKCkKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLiBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkLCBpdAogICAgICogICAgIG1lYW5zIHJlZnJlc2hlZCBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0CiAgICAgKiAgICAgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYHJlZnJlc2hgIGNhbGwuCiAgICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGByZWZyZXNoUHJvbWlzZWAgbWV0aG9kLgogICAgICogICAgIHZhciBwcm9taXNlID0gY3JlZFByb3ZpZGVyLnJlZnJlc2hQcm9taXNlKCk7CiAgICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgdGhlIGNyZWRlbnRpYWxzLiBVc2VycyBzaG91bGQgY2FsbCB7Z2V0fSBiZWZvcmUgYXR0ZW1wdGluZwogICAgICogdG8gZm9yY2libHkgcmVmcmVzaCBjcmVkZW50aWFscy4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHJlZnJlc2hlZAogICAgICogICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUKICAgICAqICAgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAbm90ZSBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzIGNsYXNzIHRvIHJlc2V0IHRoZQogICAgICogICB7YWNjZXNzS2V5SWR9LCB7c2VjcmV0QWNjZXNzS2V5fSBhbmQgb3B0aW9uYWwge3Nlc3Npb25Ub2tlbn0KICAgICAqICAgb24gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCBhbmQgdGhlbiBjYWxsIHRoZSBjYWxsYmFjayB3aXRoCiAgICAgKiAgIGFueSBlcnJvciBpbmZvcm1hdGlvbi4KICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5leHBpcmVkID0gZmFsc2U7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBjb2FsZXNjZVJlZnJlc2g6IGZ1bmN0aW9uIGNvYWxlc2NlUmVmcmVzaChjYWxsYmFjaywgc3luYykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChzZWxmLnJlZnJlc2hDYWxsYmFja3MucHVzaChjYWxsYmFjaykgPT09IDEpIHsKICAgICAgICBzZWxmLmxvYWQoZnVuY3Rpb24gb25Mb2FkKGVycikgewogICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNlbGYucmVmcmVzaENhbGxiYWNrcywgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHN5bmMpIHsKICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGNhbGxiYWNrIGNvdWxkIHRocm93LCBzbyBkZWZlciB0byBlbnN1cmUgYWxsIGNhbGxiYWNrcyBhcmUgbm90aWZpZWQKICAgICAgICAgICAgICBBV1MudXRpbC5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHNlbGYucmVmcmVzaENhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxzLmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdGhpcy5wcm90b3R5cGUuZ2V0UHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgnZ2V0JywgUHJvbWlzZURlcGVuZGVuY3kpOwogICAgdGhpcy5wcm90b3R5cGUucmVmcmVzaFByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ3JlZnJlc2gnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbHMuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5nZXRQcm9taXNlOwogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnJlZnJlc2hQcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLkNyZWRlbnRpYWxzKTsKICAKICB9LHsiLi9jb3JlIjoxOH1dLDIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIHtBV1MuU1RTfS4gV2l0aG91dCBhbnkKICAgKiBleHRyYSBwYXJhbWV0ZXJzLCBjcmVkZW50aWFscyB3aWxsIGJlIGZldGNoZWQgZnJvbSB0aGUKICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbi4gSWYgYW4gSUFNIHJvbGUgaXMgcHJvdmlkZWQsIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9wZXJhdGlvbiB3aWxsIGJlIHVzZWQgdG8gZmV0Y2ggY3JlZGVudGlhbHMgZm9yIHRoZQogICAqIHJvbGUgaW5zdGVhZC4KICAgKgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBkaWZmZXJzIGZyb20gQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGluCiAgICogdGhlIHdheSBtYXN0ZXJDcmVkZW50aWFscyBhbmQgcmVmcmVzaGVzIGFyZSBoYW5kbGVkLgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyByZWZyZXNoZXMgZXhwaXJlZCBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiBtYXN0ZXJDcmVkZW50aWFscyBwYXNzZWQgYnkgdGhlIHVzZXIgdG8gc3VwcG9ydCBjaGFpbmluZyBvZiBTVFMgY3JlZGVudGlhbHMuCiAgICogSG93ZXZlciwgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIHJlY3Vyc2l2ZWx5IGNvbGxhcHNlcyB0aGUgbWFzdGVyQ3JlZGVudGlhbHMKICAgKiBkdXJpbmcgaW5zdGFudGlhdGlvbiwgcHJlY2x1ZGluZyB0aGUgYWJpbGl0eSB0byByZWZyZXNoIGNyZWRlbnRpYWxzIHdoaWNoCiAgICogcmVxdWlyZSBpbnRlcm1lZGlhdGUsIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICAgKgogICAqIEZvciBleGFtcGxlLCBpZiB0aGUgYXBwbGljYXRpb24gc2hvdWxkIHVzZSBSb2xlQSwgd2hpY2ggbXVzdCBiZSBhc3N1bWVkIGZyb20KICAgKiBSb2xlQiwgYW5kIHRoZSBlbnZpcm9ubWVudCBwcm92aWRlcyBjcmVkZW50aWFscyB3aGljaCBjYW4gYXNzdW1lIFJvbGVCLCB0aGVuCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIG11c3QgYmUgdXNlZCB0byBzdXBwb3J0IHJlZnJlc2hpbmcgdGhlCiAgICogdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZvciBSb2xlQToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgcm9sZUFDcmVkcyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgcGFyYW1zOiB7Um9sZUFybjogJ1JvbGVBJ30sCiAgICogICBtYXN0ZXJDcmVkZW50aWFsczogbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICAgIHBhcmFtczoge1JvbGVBcm46ICdSb2xlQid9LAogICAqICAgICBtYXN0ZXJDcmVkZW50aWFsczogbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKQogICAqICAgfSkKICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIElmIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBoYWQgYmVlbiB1c2VkIGluIHRoZSBwcmV2aW91cyBleGFtcGxlLAogICAqIGByb2xlQUNyZWRzYCB3b3VsZCBmYWlsIHRvIHJlZnJlc2ggYmVjYXVzZSBgcm9sZUFDcmVkc2Agd291bGQKICAgKiB1c2UgdGhlIGVudmlyb25tZW50IGNyZWRlbnRpYWxzIGZvciB0aGUgQXNzdW1lUm9sZSByZXF1ZXN0LgogICAqCiAgICogQW5vdGhlciBkaWZmZXJlbmNlIGlzIHRoYXQgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIGNyZWF0ZXMgdGhlIFNUUwogICAqIHNlcnZpY2UgaW5zdGFuY2UgZHVyaW5nIGluc3RhbnRpYXRpb24gd2hpbGUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGNyZWF0ZXMKICAgKiB0aGUgU1RTIHNlcnZpY2UgaW5zdGFuY2UgZHVyaW5nIHRoZSBmaXJzdCByZWZyZXNoLiBDcmVhdGluZyB0aGUgc2VydmljZQogICAqIGluc3RhbmNlIGR1cmluZyBpbnN0YW50aWF0aW9uIGVmZmVjdGl2ZWx5IGNhcHR1cmVzIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiBmcm9tIHRoZSBnbG9iYWwgY29uZmlnLCBzbyB0aGF0IHN1YnNlcXVlbnQgY2hhbmdlcyB0byB0aGUgZ2xvYmFsIGNvbmZpZyBkbwogICAqIG5vdCBhZmZlY3QgdGhlIG1hc3RlciBjcmVkZW50aWFscyB1c2VkIHRvIHJlZnJlc2ggdGhlIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICAgKgogICAqIFRoaXMgYWxsb3dzIGFuIGluc3RhbmNlIG9mIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyB0byBiZSBhc3NpZ25lZAogICAqIHRvIEFXUy5jb25maWcuY3JlZGVudGlhbHM6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGVudkNyZWRzID0gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gZW52Q3JlZHM7CiAgICogLy8gbWFzdGVyQ3JlZGVudGlhbHMgd2lsbCBiZSBlbnZDcmVkcwogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgIHBhcmFtczoge1JvbGVBcm46ICcuLi4nfQogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogU2ltaWxhcmx5LCB0byB1c2UgdGhlIENyZWRlbnRpYWxQcm92aWRlckNoYWluJ3MgZGVmYXVsdCBwcm92aWRlcnMgYXMgdGhlCiAgICogbWFzdGVyIGNyZWRlbnRpYWxzLCBzaW1wbHkgY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgcGFyYW1zOiB7Um9sZUFybjogJy4uLid9CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzZXJ2aWNlCiAgICogICBAcmV0dXJuIFtBV1MuU1RTXSB0aGUgU1RTIHNlcnZpY2UgaW5zdGFuY2UgdXNlZCB0bwogICAqICAgICBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBAbm90ZSAoc2VlIGNvbnN0cnVjdG9yKQogICAqLwogIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucyBbbWFwXSBhIHNldCBvZiBvcHRpb25zCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcGFyYW1zIFttYXBdICh7fSkgYSBtYXAgb2Ygb3B0aW9ucyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhlCiAgICAgKiAgIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9ucy4KICAgICAqICAgSWYgYSBgUm9sZUFybmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwgY3JlZGVudGlhbHMgd2lsbCBiZSBiYXNlZCBvbiB0aGUKICAgICAqICAgSUFNIHJvbGUuIElmIGEgYFNlcmlhbE51bWJlcmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwge3Rva2VuQ29kZUZufSBtdXN0CiAgICAgKiAgIGFsc28gYmUgcGFzc2VkIGluIG9yIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duLgogICAgICogQG9wdGlvbiBvcHRpb25zIG1hc3RlckNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgICAqICAgdXNlZCB0byBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4gQnkgZGVmYXVsdCwKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyBvciBBV1MuY29uZmlnLmNyZWRlbnRpYWxQcm92aWRlciB3aWxsIGJlIHVzZWQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgdG9rZW5Db2RlRm4gW0Z1bmN0aW9uXSAobnVsbCkgRnVuY3Rpb24gdG8gcHJvdmlkZQogICAgICogICBgVG9rZW5Db2RlYCwgaWYgYFNlcmlhbE51bWJlcmAgaXMgcHJvdmlkZWQgZm9yIHByb2ZpbGUgaW4ge3BhcmFtc30uIEZ1bmN0aW9uCiAgICAgKiAgIGlzIGNhbGxlZCB3aXRoIHZhbHVlIG9mIGBTZXJpYWxOdW1iZXJgIGFuZCBgY2FsbGJhY2tgLCBhbmQgc2hvdWxkIHByb3ZpZGUKICAgICAqICAgdGhlIGBUb2tlbkNvZGVgIG9yIGFuIGVycm9yIHRvIHRoZSBjYWxsYmFjayBpbiB0aGUgZm9ybWF0CiAgICAgKiAgIGBjYWxsYmFjayhlcnIsIHRva2VuKWAuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGdlbmVyaWMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGFuIElBTSByb2xlCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgICAqICAgICBwYXJhbXM6IHsKICAgICAqICAgICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1RlbXBvcmFyeUNyZWRlbnRpYWxzJwogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZQogICAgICogQHNlZSBBV1MuU1RTLmdldFNlc3Npb25Ub2tlbgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMob3B0aW9ucykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHRoaXMuZXJyb3JDb2RlID0gJ0NoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJzsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy50b2tlbkNvZGVGbiA9IG51bGw7CiAgCiAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KG9wdGlvbnMucGFyYW1zKSB8fCB7fTsKICAgICAgaWYgKHBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgICAgcGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9IHBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3RlbXBvcmFyeS1jcmVkZW50aWFscyc7CiAgICAgIH0KICAgICAgaWYgKHBhcmFtcy5TZXJpYWxOdW1iZXIpIHsKICAgICAgICBpZiAoIW9wdGlvbnMudG9rZW5Db2RlRm4gfHwgKHR5cGVvZiBvcHRpb25zLnRva2VuQ29kZUZuICE9PSAnZnVuY3Rpb24nKSkgewogICAgICAgICAgdGhyb3cgbmV3IEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICBuZXcgRXJyb3IoJ3Rva2VuQ29kZUZuIG11c3QgYmUgYSBmdW5jdGlvbiB3aGVuIHBhcmFtcy5TZXJpYWxOdW1iZXIgaXMgZ2l2ZW4nKSwKICAgICAgICAgICAge2NvZGU6IHRoaXMuZXJyb3JDb2RlfQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50b2tlbkNvZGVGbiA9IG9wdGlvbnMudG9rZW5Db2RlRm47CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBjb25maWcgPSBBV1MudXRpbC5tZXJnZSgKICAgICAgICB7CiAgICAgICAgICBwYXJhbXM6IHBhcmFtcywKICAgICAgICAgIGNyZWRlbnRpYWxzOiBvcHRpb25zLm1hc3RlckNyZWRlbnRpYWxzIHx8IEFXUy5jb25maWcuY3JlZGVudGlhbHMKICAgICAgICB9LAogICAgICAgIG9wdGlvbnMuc3RzQ29uZmlnIHx8IHt9CiAgICAgICk7CiAgICAgIHRoaXMuc2VydmljZSA9IG5ldyBTVFMoY29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcgogICAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSwgZGVwZW5kaW5nIG9uIHdoZXRoZXIgYW4gSUFNIHJvbGUgQVJOIHdhcyBwYXNzZWQKICAgICAqIHRvIHRoZSBjcmVkZW50aWFscyB7Y29uc3RydWN0b3J9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgQVdTLkNyZWRlbnRpYWxzLmdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb3BlcmF0aW9uID0gc2VsZi5zZXJ2aWNlLmNvbmZpZy5wYXJhbXMuUm9sZUFybiA/ICdhc3N1bWVSb2xlJyA6ICdnZXRTZXNzaW9uVG9rZW4nOwogICAgICB0aGlzLmdldFRva2VuQ29kZShmdW5jdGlvbiAoZXJyLCB0b2tlbkNvZGUpIHsKICAgICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuQ29kZSkgewogICAgICAgICAgcGFyYW1zLlRva2VuQ29kZSA9IHRva2VuQ29kZTsKICAgICAgICB9CiAgICAgICAgc2VsZi5zZXJ2aWNlW29wZXJhdGlvbl0ocGFyYW1zLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0VG9rZW5Db2RlOiBmdW5jdGlvbiBnZXRUb2tlbkNvZGUoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodGhpcy50b2tlbkNvZGVGbikgewogICAgICAgIHRoaXMudG9rZW5Db2RlRm4odGhpcy5zZXJ2aWNlLmNvbmZpZy5wYXJhbXMuU2VyaWFsTnVtYmVyLCBmdW5jdGlvbiAoZXJyLCB0b2tlbikgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGVycjsKICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKAogICAgICAgICAgICAgIEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICAgICAgbmV3IEVycm9yKCdFcnJvciBmZXRjaGluZyBNRkEgdG9rZW46ICcgKyBtZXNzYWdlKSwKICAgICAgICAgICAgICAgIHsgY29kZTogc2VsZi5lcnJvckNvZGV9CiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhudWxsLCB0b2tlbik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sobnVsbCk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIENvZ25pdG9JZGVudGl0eSA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvY29nbml0b2lkZW50aXR5Jyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgV2ViIElkZW50aXR5IEZlZGVyYXRpb24gdXNpbmcKICAgKiB0aGUgQW1hem9uIENvZ25pdG8gSWRlbnRpdHkgc2VydmljZS4KICAgKgogICAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLCB3aGljaAogICAqIHJlcXVpcmVzIGVpdGhlciBhbiBgSWRlbnRpdHlJZGAgb3IgYW4gYElkZW50aXR5UG9vbElkYCAoQW1hem9uIENvZ25pdG8KICAgKiBJZGVudGl0eSBQb29sIElEKSwgd2hpY2ggaXMgdXNlZCB0byBjYWxsIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldElkfSB0bwogICAqIG9idGFpbiBhbiBgSWRlbnRpdHlJZGAuIElmIHRoZSBpZGVudGl0eSBvciBpZGVudGl0eSBwb29sIGlzIG5vdCBjb25maWd1cmVkIGluCiAgICogdGhlIEFtYXpvbiBDb2duaXRvIENvbnNvbGUgdG8gdXNlIElBTSByb2xlcyB3aXRoIHRoZSBhcHByb3ByaWF0ZSBwZXJtaXNzaW9ucywKICAgKiB0aGVuIGFkZGl0aW9uYWxseSBhIGBSb2xlQXJuYCBpcyByZXF1aXJlZCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdAogICAqIHBvbGljeSBmb3IgdGhlIEFtYXpvbiBDb2duaXRvIHJvbGUgdGhhdCB0aGUgdXNlciB3aWxsIGxvZyBpbnRvLiBJZiBhIGBSb2xlQXJuYAogICAqIGlzIHByb3ZpZGVkLCB0aGVuIHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbiwgYWZ0ZXIgZmlyc3QgZ2V0dGluZyBhbgogICAqIE9wZW4gSUQgdG9rZW4gZnJvbSB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0uCiAgICoKICAgKiBJbiBhZGRpdGlvbiwgaWYgdGhpcyBjcmVkZW50aWFsIHByb3ZpZGVyIGlzIHVzZWQgdG8gcHJvdmlkZSBhdXRoZW50aWNhdGVkCiAgICogbG9naW4sIHRoZSBgTG9naW5zYCBtYXAgbWF5IGJlIHNldCB0byB0aGUgdG9rZW5zIHByb3ZpZGVkIGJ5IHRoZSByZXNwZWN0aXZlCiAgICogaWRlbnRpdHkgcHJvdmlkZXJzLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAgICogb2JqZWN0IHdpdGggcHJvcGVyIHByb3BlcnR5IHZhbHVlcy4KICAgKgogICAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAgICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAgICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogICAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICAgKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAgICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICAgKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAgICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAgICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgV2ViSWRlbnRpdHlUb2tlbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICAgKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5Mb2dpbnNbJ2dyYXBoLmZhY2Vib29rLmNvbSddID0gdXBkYXRlZFRva2VuOwogICAqIGBgYAogICAqCiAgICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZH0sCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufSwgYW5kCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAgICogICAgIGBwYXJhbXMuV2ViSWRlbnRpdHlUb2tlbmAgcHJvcGVydHkuCiAgICogQCFhdHRyaWJ1dGUgZGF0YQogICAqICAgQHJldHVybiBbbWFwXSB0aGUgcmF3IGRhdGEgcmVzcG9uc2UgZnJvbSB0aGUgY2FsbCB0bwogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSwgb3IKICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFVzZSB0aGlzIGlmIHlvdSB3YW50IHRvIGdldAogICAqICAgICBhY2Nlc3MgdG8gb3RoZXIgcHJvcGVydGllcyBmcm9tIHRoZSByZXNwb25zZS4KICAgKiBAIWF0dHJpYnV0ZSBpZGVudGl0eUlkCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBDb2duaXRvIElEIHJldHVybmVkIGJ5IHRoZSBsYXN0IGNhbGwgdG8KICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LiBUaGlzIElEIHJlcHJlc2VudHMgdGhlIGFjdHVhbAogICAqICAgICBmaW5hbCByZXNvbHZlZCBpZGVudGl0eSBJRCBmcm9tIEFtYXpvbiBDb2duaXRvLgogICAqLwogIEFXUy5Db2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2NhbFN0b3JhZ2VLZXk6IHsKICAgICAgaWQ6ICdhd3MuY29nbml0by5pZGVudGl0eS1pZC4nLAogICAgICBwcm92aWRlcnM6ICdhd3MuY29nbml0by5pZGVudGl0eS1wcm92aWRlcnMuJwogICAgfSwKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMoewogICAgICoKICAgICAqICAgICAvLyBlaXRoZXIgSWRlbnRpdHlQb29sSWQgb3IgSWRlbnRpdHlJZCBpcyByZXF1aXJlZAogICAgICogICAgIC8vIFNlZSB0aGUgSWRlbnRpdHlQb29sSWQgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SUQgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICAvLyBTZWUgdGhlIElkZW50aXR5SWQgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eQogICAgICogICAgIC8vIG9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW4gKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBJZGVudGl0eVBvb2xJZDogJ3VzLWVhc3QtMToxNjk5ZWJjMC03OTAwLTQwOTktYjkxMC0yZGY5NGY1MmEwMzAnLAogICAgICogICAgIElkZW50aXR5SWQ6ICd1cy1lYXN0LTE6MTI4ZDBhNzQtYzgyZi00NTUzLTkxNmQtOTAwNTNlNGE4YjBmJwogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCwgb25seSBuZWNlc3Nhcnkgd2hlbiB0aGUgaWRlbnRpdHkgcG9vbCBpcyBub3QgY29uZmlndXJlZAogICAgICogICAgIC8vIHRvIHVzZSBJQU0gcm9sZXMgaW4gdGhlIEFtYXpvbiBDb2duaXRvIENvbnNvbGUKICAgICAqICAgICAvLyBTZWUgdGhlIFJvbGVBcm4gcGFyYW0gZm9yIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSAobGlua2VkIGJlbG93KQogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL01ZQVBQLUNvZ25pdG9JZGVudGl0eScsCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsIHRva2VucywgdXNlZCBmb3IgYXV0aGVudGljYXRlZCBsb2dpbgogICAgICogICAgIC8vIFNlZSB0aGUgTG9naW5zIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldElEIChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgTG9naW5zOiB7CiAgICAgKiAgICAgICAnZ3JhcGguZmFjZWJvb2suY29tJzogJ0ZCVE9LRU4nLAogICAgICogICAgICAgJ3d3dy5hbWF6b24uY29tJzogJ0FNQVpPTlRPS0VOJywKICAgICAqICAgICAgICdhY2NvdW50cy5nb29nbGUuY29tJzogJ0dPT0dMRVRPS0VOJywKICAgICAqICAgICAgICdhcGkudHdpdHRlci5jb20nOiAnVFdJVFRFUlRPS0VOJywKICAgICAqICAgICAgICd3d3cuZGlnaXRzLmNvbSc6ICdESUdJVFNUT0tFTicKICAgICAqICAgICB9LAogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCBuYW1lLCBkZWZhdWx0cyB0byB3ZWItaWRlbnRpdHkKICAgICAqICAgICAvLyBTZWUgdGhlIFJvbGVTZXNzaW9uTmFtZSBwYXJhbSBmb3IgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgUm9sZVNlc3Npb25OYW1lOiAnd2ViJywKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwsIG9ubHkgbmVjZXNzYXJ5IHdoZW4gYXBwbGljYXRpb24gcnVucyBpbiBhIGJyb3dzZXIKICAgICAqICAgICAvLyBhbmQgbXVsdGlwbGUgdXNlcnMgYXJlIHNpZ25lZCBpbiBhdCBvbmNlLCB1c2VkIGZvciBjYWNoaW5nCiAgICAgKiAgICAgTG9naW5JZDogJ2V4YW1wbGVAZ21haWwuY29tJwogICAgICoKICAgICAqICAgfSwgewogICAgICogICAgICAvLyBvcHRpb25hbGx5IHByb3ZpZGUgY29uZmlndXJhdGlvbiB0byBhcHBseSB0byB0aGUgdW5kZXJseWluZyBzZXJ2aWNlIGNsaWVudHMKICAgICAqICAgICAgLy8gaWYgY29uZmlndXJhdGlvbiBpcyBub3QgcHJvdmlkZWQsIHRoZW4gY29uZmlndXJhdGlvbiB3aWxsIGJlIHB1bGxlZCBmcm9tIEFXUy5jb25maWcKICAgICAqCiAgICAgKiAgICAgIC8vIHJlZ2lvbiBzaG91bGQgbWF0Y2ggdGhlIHJlZ2lvbiB5b3VyIGlkZW50aXR5IHBvb2wgaXMgbG9jYXRlZCBpbgogICAgICogICAgICByZWdpb246ICd1cy1lYXN0LTEnLAogICAgICoKICAgICAqICAgICAgLy8gc3BlY2lmeSB0aW1lb3V0IG9wdGlvbnMKICAgICAqICAgICAgaHR0cE9wdGlvbnM6IHsKICAgICAqICAgICAgICB0aW1lb3V0OiAxMDAKICAgICAqICAgICAgfQogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZAogICAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5CiAgICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW4KICAgICAqIEBzZWUgQVdTLkNvbmZpZwogICAgICogQG5vdGUgSWYgYSByZWdpb24gaXMgbm90IHByb3ZpZGVkIGluIHRoZSBnbG9iYWwgQVdTLmNvbmZpZywgb3IKICAgICAqICAgc3BlY2lmaWVkIGluIHRoZSBgY2xpZW50Q29uZmlnYCB0byB0aGUgQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMKICAgICAqICAgY29uc3RydWN0b3IsIHlvdSBtYXkgZW5jb3VudGVyIGEgJ01pc3NpbmcgY3JlZGVudGlhbHMgaW4gY29uZmlnJyBlcnJvcgogICAgICogICB3aGVuIGNhbGxpbmcgbWFraW5nIGEgc2VydmljZSBjYWxsLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMocGFyYW1zLCBjbGllbnRDb25maWcpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgICB0aGlzLl9pZGVudGl0eUlkID0gbnVsbDsKICAgICAgdGhpcy5fY2xpZW50Q29uZmlnID0gQVdTLnV0aWwuY29weShjbGllbnRDb25maWcgfHwge30pOwogICAgICB0aGlzLmxvYWRDYWNoZWRJZCgpOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnaWRlbnRpdHlJZCcsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5sb2FkQ2FjaGVkSWQoKTsKICAgICAgICAgIHJldHVybiBzZWxmLl9pZGVudGl0eUlkIHx8IHNlbGYucGFyYW1zLklkZW50aXR5SWQ7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKGlkZW50aXR5SWQpIHsKICAgICAgICAgIHNlbGYuX2lkZW50aXR5SWQgPSBpZGVudGl0eUlkOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0sCiAgICAgKiBvciB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIEFXUy5DcmVkZW50aWFscy5nZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYuZGF0YSA9IG51bGw7CiAgICAgIHNlbGYuX2lkZW50aXR5SWQgPSBudWxsOwogICAgICBzZWxmLmdldElkKGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBpZiAoIXNlbGYucGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICAgICAgc2VsZi5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGNhbGxiYWNrKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuZ2V0Q3JlZGVudGlhbHNGcm9tU1RTKGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDbGVhcnMgdGhlIGNhY2hlZCBDb2duaXRvIElEIGFzc29jaWF0ZWQgd2l0aCB0aGUgY3VycmVudGx5IGNvbmZpZ3VyZWQKICAgICAqIGlkZW50aXR5IHBvb2wgSUQuIFVzZSB0aGlzIHRvIG1hbnVhbGx5IGludmFsaWRhdGUgeW91ciBjYWNoZSBpZgogICAgICogdGhlIGlkZW50aXR5IHBvb2wgSUQgd2FzIGRlbGV0ZWQuCiAgICAgKi8KICAgIGNsZWFyQ2FjaGVkSWQ6IGZ1bmN0aW9uIGNsZWFyQ2FjaGUoKSB7CiAgICAgIHRoaXMuX2lkZW50aXR5SWQgPSBudWxsOwogICAgICBkZWxldGUgdGhpcy5wYXJhbXMuSWRlbnRpdHlJZDsKICAKICAgICAgdmFyIHBvb2xJZCA9IHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkOwogICAgICB2YXIgbG9naW5JZCA9IHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJyc7CiAgICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXkuaWQgKyBwb29sSWQgKyBsb2dpbklkXTsKICAgICAgZGVsZXRlIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleS5wcm92aWRlcnMgKyBwb29sSWQgKyBsb2dpbklkXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjbGVhcklkT25Ob3RBdXRob3JpemVkOiBmdW5jdGlvbiBjbGVhcklkT25Ob3RBdXRob3JpemVkKGVycikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChlcnIuY29kZSA9PSAnTm90QXV0aG9yaXplZEV4Y2VwdGlvbicpIHsKICAgICAgICBzZWxmLmNsZWFyQ2FjaGVkSWQoKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogUmV0cmlldmVzIGEgQ29nbml0byBJRCwgbG9hZGluZyBmcm9tIGNhY2hlIGlmIGl0IHdhcyBhbHJlYWR5IHJldHJpZXZlZAogICAgICogb24gdGhpcyBkZXZpY2UuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgaWRlbnRpdHlJZCkKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3IsIG51bGxdIGFuIGVycm9yIG9iamVjdCBpZiB0aGUgY2FsbCBmYWlsZWQgb3IgbnVsbCBpZgogICAgICogICAgIGl0IHN1Y2NlZWRlZC4KICAgICAqICAgQHBhcmFtIGlkZW50aXR5SWQgW1N0cmluZywgbnVsbF0gaWYgc3VjY2Vzc2Z1bCwgdGhlIGNhbGxiYWNrIHdpbGwgcmV0dXJuCiAgICAgKiAgICAgdGhlIENvZ25pdG8gSUQuCiAgICAgKiBAbm90ZSBJZiBub3QgbG9hZGVkIGV4cGxpY2l0bHksIHRoZSBDb2duaXRvIElEIGlzIGxvYWRlZCBhbmQgc3RvcmVkIGluCiAgICAgKiAgIGxvY2FsU3RvcmFnZSBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvZiBhIGRldmljZS4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRJZDogZnVuY3Rpb24gZ2V0SWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodHlwZW9mIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHNlbGYucGFyYW1zLklkZW50aXR5SWQpOwogICAgICB9CiAgCiAgICAgIHNlbGYuY29nbml0by5nZXRJZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVyciAmJiBkYXRhLklkZW50aXR5SWQpIHsKICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBkYXRhLklkZW50aXR5SWQ7CiAgICAgICAgICBjYWxsYmFjayhudWxsLCBkYXRhLklkZW50aXR5SWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZENyZWRlbnRpYWxzOiBmdW5jdGlvbiBsb2FkQ3JlZGVudGlhbHMoZGF0YSwgY3JlZGVudGlhbHMpIHsKICAgICAgaWYgKCFkYXRhIHx8ICFjcmVkZW50aWFscykgcmV0dXJuOwogICAgICBjcmVkZW50aWFscy5leHBpcmVkID0gZmFsc2U7CiAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkID0gZGF0YS5DcmVkZW50aWFscy5BY2Nlc3NLZXlJZDsKICAgICAgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ID0gZGF0YS5DcmVkZW50aWFscy5TZWNyZXRLZXk7CiAgICAgIGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbiA9IGRhdGEuQ3JlZGVudGlhbHMuU2Vzc2lvblRva2VuOwogICAgICBjcmVkZW50aWFscy5leHBpcmVUaW1lID0gZGF0YS5DcmVkZW50aWFscy5FeHBpcmF0aW9uOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHk6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNvZ25pdG8uZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5jYWNoZUlkKGRhdGEpOwogICAgICAgICAgc2VsZi5kYXRhID0gZGF0YTsKICAgICAgICAgIHNlbGYubG9hZENyZWRlbnRpYWxzKHNlbGYuZGF0YSwgc2VsZik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRDcmVkZW50aWFsc0Zyb21TVFM6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRnJvbVNUUyhjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY29nbml0by5nZXRPcGVuSWRUb2tlbihmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5jYWNoZUlkKGRhdGEpOwogICAgICAgICAgc2VsZi5wYXJhbXMuV2ViSWRlbnRpdHlUb2tlbiA9IGRhdGEuVG9rZW47CiAgICAgICAgICBzZWxmLndlYklkZW50aXR5Q3JlZGVudGlhbHMucmVmcmVzaChmdW5jdGlvbih3ZWJFcnIpIHsKICAgICAgICAgICAgaWYgKCF3ZWJFcnIpIHsKICAgICAgICAgICAgICBzZWxmLmRhdGEgPSBzZWxmLndlYklkZW50aXR5Q3JlZGVudGlhbHMuZGF0YTsKICAgICAgICAgICAgICBzZWxmLnN0cy5jcmVkZW50aWFsc0Zyb20oc2VsZi5kYXRhLCBzZWxmKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjayh3ZWJFcnIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRDYWNoZWRJZDogZnVuY3Rpb24gbG9hZENhY2hlZElkKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICAgIC8vIGluIHRoZSBicm93c2VyIHdlIHNvdXJjZSBkZWZhdWx0IElkZW50aXR5SWQgZnJvbSBsb2NhbFN0b3JhZ2UKICAgICAgaWYgKEFXUy51dGlsLmlzQnJvd3NlcigpICYmICFzZWxmLnBhcmFtcy5JZGVudGl0eUlkKSB7CiAgICAgICAgdmFyIGlkID0gc2VsZi5nZXRTdG9yYWdlKCdpZCcpOwogICAgICAgIGlmIChpZCAmJiBzZWxmLnBhcmFtcy5Mb2dpbnMpIHsKICAgICAgICAgIHZhciBhY3R1YWxQcm92aWRlcnMgPSBPYmplY3Qua2V5cyhzZWxmLnBhcmFtcy5Mb2dpbnMpOwogICAgICAgICAgdmFyIGNhY2hlZFByb3ZpZGVycyA9CiAgICAgICAgICAgIChzZWxmLmdldFN0b3JhZ2UoJ3Byb3ZpZGVycycpIHx8ICcnKS5zcGxpdCgnLCcpOwogIAogICAgICAgICAgLy8gb25seSBsb2FkIElEIGlmIGF0IGxlYXN0IG9uZSBwcm92aWRlciB1c2VkIHRoaXMgSUQgYmVmb3JlCiAgICAgICAgICB2YXIgaW50ZXJzZWN0ID0gY2FjaGVkUHJvdmlkZXJzLmZpbHRlcihmdW5jdGlvbihuKSB7CiAgICAgICAgICAgIHJldHVybiBhY3R1YWxQcm92aWRlcnMuaW5kZXhPZihuKSAhPT0gLTE7CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChpbnRlcnNlY3QubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBpZDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlkKSB7CiAgICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gaWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjbGllbnRDb25maWcgPSB0aGlzLl9jbGllbnRDb25maWc7CiAgICAgIHRoaXMud2ViSWRlbnRpdHlDcmVkZW50aWFscyA9IHRoaXMud2ViSWRlbnRpdHlDcmVkZW50aWFscyB8fAogICAgICAgIG5ldyBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyh0aGlzLnBhcmFtcywgY2xpZW50Q29uZmlnKTsKICAgICAgaWYgKCF0aGlzLmNvZ25pdG8pIHsKICAgICAgICB2YXIgY29nbml0b0NvbmZpZyA9IEFXUy51dGlsLm1lcmdlKHt9LCBjbGllbnRDb25maWcpOwogICAgICAgIGNvZ25pdG9Db25maWcucGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICAgICAgdGhpcy5jb2duaXRvID0gbmV3IENvZ25pdG9JZGVudGl0eShjb2duaXRvQ29uZmlnKTsKICAgICAgfQogICAgICB0aGlzLnN0cyA9IHRoaXMuc3RzIHx8IG5ldyBTVFMoY2xpZW50Q29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWNoZUlkOiBmdW5jdGlvbiBjYWNoZUlkKGRhdGEpIHsKICAgICAgdGhpcy5faWRlbnRpdHlJZCA9IGRhdGEuSWRlbnRpdHlJZDsKICAgICAgdGhpcy5wYXJhbXMuSWRlbnRpdHlJZCA9IHRoaXMuX2lkZW50aXR5SWQ7CiAgCiAgICAgIC8vIGNhY2hlIHRoaXMgSWRlbnRpdHlJZCBpbiBicm93c2VyIGxvY2FsU3RvcmFnZSBpZiBwb3NzaWJsZQogICAgICBpZiAoQVdTLnV0aWwuaXNCcm93c2VyKCkpIHsKICAgICAgICB0aGlzLnNldFN0b3JhZ2UoJ2lkJywgZGF0YS5JZGVudGl0eUlkKTsKICAKICAgICAgICBpZiAodGhpcy5wYXJhbXMuTG9naW5zKSB7CiAgICAgICAgICB0aGlzLnNldFN0b3JhZ2UoJ3Byb3ZpZGVycycsIE9iamVjdC5rZXlzKHRoaXMucGFyYW1zLkxvZ2lucykuam9pbignLCcpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTdG9yYWdlOiBmdW5jdGlvbiBnZXRTdG9yYWdlKGtleSkgewogICAgICByZXR1cm4gdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5W2tleV0gKyB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZCArICh0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnKV07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0U3RvcmFnZTogZnVuY3Rpb24gc2V0U3RvcmFnZShrZXksIHZhbCkgewogICAgICB0cnkgewogICAgICAgIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleVtrZXldICsgdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQgKyAodGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJyldID0gdmFsOwogICAgICB9IGNhdGNoIChfKSB7fQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHN0b3JhZ2U6IChmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgc3RvcmFnZSA9IEFXUy51dGlsLmlzQnJvd3NlcigpICYmIHdpbmRvdy5sb2NhbFN0b3JhZ2UgIT09IG51bGwgJiYgdHlwZW9mIHdpbmRvdy5sb2NhbFN0b3JhZ2UgPT09ICdvYmplY3QnID8KICAgICAgICAgICAgd2luZG93LmxvY2FsU3RvcmFnZSA6IHt9OwogIAogICAgICAgIC8vIFRlc3Qgc2V0L3JlbW92ZSB3aGljaCB3b3VsZCB0aHJvdyBhbiBlcnJvciBpbiBTYWZhcmkncyBwcml2YXRlIGJyb3dzaW5nCiAgICAgICAgc3RvcmFnZVsnYXdzLnRlc3Qtc3RvcmFnZSddID0gJ2Zvb2Jhcic7CiAgICAgICAgZGVsZXRlIHN0b3JhZ2VbJ2F3cy50ZXN0LXN0b3JhZ2UnXTsKICAKICAgICAgICByZXR1cm4gc3RvcmFnZTsKICAgICAgfSBjYXRjaCAoXykgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgfSkoKQogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL2NvZ25pdG9pZGVudGl0eSI6NywiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQ3JlYXRlcyBhIGNyZWRlbnRpYWwgcHJvdmlkZXIgY2hhaW4gdGhhdCBzZWFyY2hlcyBmb3IgQVdTIGNyZWRlbnRpYWxzCiAgICogaW4gYSBsaXN0IG9mIGNyZWRlbnRpYWwgcHJvdmlkZXJzIHNwZWNpZmllZCBieSB0aGUge3Byb3ZpZGVyc30gcHJvcGVydHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCB0aGUgY2hhaW4gd2lsbCB1c2UgdGhlIHtkZWZhdWx0UHJvdmlkZXJzfSB0byByZXNvbHZlIGNyZWRlbnRpYWxzLgogICAqIFRoZXNlIHByb3ZpZGVycyB3aWxsIGxvb2sgaW4gdGhlIGVudmlyb25tZW50IHVzaW5nIHRoZQogICAqIHtBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFsc30gY2xhc3Mgd2l0aCB0aGUgJ0FXUycgYW5kICdBTUFaT04nIHByZWZpeGVzLgogICAqCiAgICogIyMgU2V0dGluZyBQcm92aWRlcnMKICAgKgogICAqIEVhY2ggcHJvdmlkZXIgaW4gdGhlIHtwcm92aWRlcnN9IGxpc3Qgc2hvdWxkIGJlIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAgICogYSB7QVdTLkNyZWRlbnRpYWxzfSBvYmplY3QsIG9yIGEgaGFyZGNvZGVkIGNyZWRlbnRpYWxzIG9iamVjdC4gVGhlIGZ1bmN0aW9uCiAgICogZm9ybSBhbGxvd3MgZm9yIGRlbGF5ZWQgZXhlY3V0aW9uIG9mIHRoZSBjcmVkZW50aWFsIGNvbnN0cnVjdGlvbi4KICAgKgogICAqICMjIFJlc29sdmluZyBDcmVkZW50aWFscyBmcm9tIGEgQ2hhaW4KICAgKgogICAqIENhbGwge3Jlc29sdmV9IHRvIHJldHVybiB0aGUgZmlyc3QgdmFsaWQgY3JlZGVudGlhbCBvYmplY3QgdGhhdCBjYW4gYmUKICAgKiBsb2FkZWQgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAqCiAgICogRm9yIGV4YW1wbGUsIHRvIHJlc29sdmUgYSBjaGFpbiB3aXRoIGEgY3VzdG9tIHByb3ZpZGVyIHRoYXQgY2hlY2tzIGEgZmlsZQogICAqIG9uIGRpc2sgYWZ0ZXIgdGhlIHNldCBvZiB7ZGVmYXVsdFByb3ZpZGVyc306CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGRpc2tQcm92aWRlciA9IG5ldyBBV1MuRmlsZVN5c3RlbUNyZWRlbnRpYWxzKCcuL2NyZWRzLmpzb24nKTsKICAgKiB2YXIgY2hhaW4gPSBuZXcgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKCk7CiAgICogY2hhaW4ucHJvdmlkZXJzLnB1c2goZGlza1Byb3ZpZGVyKTsKICAgKiBjaGFpbi5yZXNvbHZlKCk7CiAgICogYGBgCiAgICoKICAgKiBUaGUgYWJvdmUgY29kZSB3aWxsIHJldHVybiB0aGUgYGRpc2tQcm92aWRlcmAgb2JqZWN0IGlmIHRoZQogICAqIGZpbGUgY29udGFpbnMgY3JlZGVudGlhbHMgYW5kIHRoZSBgZGVmYXVsdFByb3ZpZGVyc2AgZG8gbm90IGNvbnRhaW4KICAgKiBhbnkgY3JlZGVudGlhbCBzZXR0aW5ncy4KICAgKgogICAqIEAhYXR0cmlidXRlIHByb3ZpZGVycwogICAqICAgQHJldHVybiBbQXJyYXk8QVdTLkNyZWRlbnRpYWxzLCBGdW5jdGlvbj5dCiAgICogICAgIGEgbGlzdCBvZiBjcmVkZW50aWFscyBvYmplY3RzIG9yIGZ1bmN0aW9ucyB0aGF0IHJldHVybiBjcmVkZW50aWFscwogICAqICAgICBvYmplY3RzLiBJZiB0aGUgcHJvdmlkZXIgaXMgYSBmdW5jdGlvbiwgdGhlIGZ1bmN0aW9uIHdpbGwgYmUKICAgKiAgICAgZXhlY3V0ZWQgbGF6aWx5IHdoZW4gdGhlIHByb3ZpZGVyIG5lZWRzIHRvIGJlIGNoZWNrZWQgZm9yIHZhbGlkCiAgICogICAgIGNyZWRlbnRpYWxzLiBCeSBkZWZhdWx0LCB0aGlzIG9iamVjdCB3aWxsIGJlIHNldCB0byB0aGUKICAgKiAgICAge2RlZmF1bHRQcm92aWRlcnN9LgogICAqICAgQHNlZSBkZWZhdWx0UHJvdmlkZXJzCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbiB3aXRoIGEgZGVmYXVsdCBzZXQgb2YgcHJvdmlkZXJzCiAgICAgKiBzcGVjaWZpZWQgYnkge2RlZmF1bHRQcm92aWRlcnN9LgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4ocHJvdmlkZXJzKSB7CiAgICAgIGlmIChwcm92aWRlcnMpIHsKICAgICAgICB0aGlzLnByb3ZpZGVycyA9IHByb3ZpZGVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnByb3ZpZGVycyA9IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzLnNsaWNlKDApOwogICAgICB9CiAgICAgIHRoaXMucmVzb2x2ZUNhbGxiYWNrcyA9IFtdOwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIHJlc29sdmVQcm9taXNlKCkKICAgICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqICAgUmVzb2x2ZXMgdGhlIHByb3ZpZGVyIGNoYWluIGJ5IHNlYXJjaGluZyBmb3IgdGhlIGZpcnN0IHNldCBvZgogICAgICogICBjcmVkZW50aWFscyBpbiB7cHJvdmlkZXJzfS4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKGNyZWRlbnRpYWxzKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQgYW5kIHRoZSBwcm92aWRlciByZXNvbHZlcyB0aGUgY2hhaW4KICAgICAqICAgICB0byBhIGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHJlc29sdmVkCiAgICAgKiAgICAgICBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBpZiBubyBjcmVkZW50aWFscyBhcmUgZm91bmQuCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgcmVzb2x2ZWAgbWV0aG9kIGNhbGwuCiAgICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGByZXNvbHZlUHJvbWlzZWAgbWV0aG9kLgogICAgICogICAgIHZhciBwcm9taXNlID0gY2hhaW4ucmVzb2x2ZVByb21pc2UoKTsKICAgICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oY3JlZGVudGlhbHMpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogUmVzb2x2ZXMgdGhlIHByb3ZpZGVyIGNoYWluIGJ5IHNlYXJjaGluZyBmb3IgdGhlIGZpcnN0IHNldCBvZgogICAgICogY3JlZGVudGlhbHMgaW4ge3Byb3ZpZGVyc30uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgY3JlZGVudGlhbHMpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBwcm92aWRlciByZXNvbHZlcyB0aGUgY2hhaW4gdG8gYSBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgb3IgbnVsbCBpZiBubyBjcmVkZW50aWFscyBjYW4gYmUgZm91bmQuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBpZiBubyBjcmVkZW50aWFscyBhcmUKICAgICAqICAgICBmb3VuZC4KICAgICAqICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBjcmVkZW50aWFscyBvYmplY3QgcmVzb2x2ZWQKICAgICAqICAgICBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICAgKiBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dIHRoZSBwcm92aWRlciwgZm9yIGNoYWluaW5nLgogICAgICovCiAgICByZXNvbHZlOiBmdW5jdGlvbiByZXNvbHZlKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHNlbGYucHJvdmlkZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignTm8gcHJvdmlkZXJzJykpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgICB9CiAgCiAgICAgIGlmIChzZWxmLnJlc29sdmVDYWxsYmFja3MucHVzaChjYWxsYmFjaykgPT09IDEpIHsKICAgICAgICB2YXIgaW5kZXggPSAwOwogICAgICAgIHZhciBwcm92aWRlcnMgPSBzZWxmLnByb3ZpZGVycy5zbGljZSgwKTsKICAKICAgICAgICBmdW5jdGlvbiByZXNvbHZlTmV4dChlcnIsIGNyZWRzKSB7CiAgICAgICAgICBpZiAoKCFlcnIgJiYgY3JlZHMpIHx8IGluZGV4ID09PSBwcm92aWRlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzZWxmLnJlc29sdmVDYWxsYmFja3MsIGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgY3JlZHMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAKICAgICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVyc1tpbmRleCsrXTsKICAgICAgICAgIGlmICh0eXBlb2YgcHJvdmlkZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY3JlZHMgPSBwcm92aWRlci5jYWxsKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjcmVkcyA9IHByb3ZpZGVyOwogICAgICAgICAgfQogIAogICAgICAgICAgaWYgKGNyZWRzLmdldCkgewogICAgICAgICAgICBjcmVkcy5nZXQoZnVuY3Rpb24gKGdldEVycikgewogICAgICAgICAgICAgIHJlc29sdmVOZXh0KGdldEVyciwgZ2V0RXJyID8gbnVsbCA6IGNyZWRzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlTmV4dChudWxsLCBjcmVkcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIHJlc29sdmVOZXh0KCk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogVGhlIGRlZmF1bHQgc2V0IG9mIHByb3ZpZGVycyB1c2VkIGJ5IGEgdmFuaWxsYSBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbi4KICAgKgogICAqIEluIHRoZSBicm93c2VyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gW10KICAgKiBgYGAKICAgKgogICAqIEluIE5vZGUuanM6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBTUFaT04nKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVDU0NyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlByb2Nlc3NDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5Ub2tlbkZpbGVXZWJJZGVudGl0eUNyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVDMk1ldGFkYXRhQ3JlZGVudGlhbHMoKSB9CiAgICogXQogICAqIGBgYAogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gW107CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdGhpcy5wcm90b3R5cGUucmVzb2x2ZVByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ3Jlc29sdmUnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5yZXNvbHZlUHJvbWlzZTsKICB9OwogIAogIEFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbik7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgU0FNTCBzdXBwb3J0LgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfSBzZXJ2aWNlIG9wZXJhdGlvbi4gVGhpcyBvcGVyYXRpb24KICAgKiByZXF1aXJlcyBhIGBSb2xlQXJuYCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdCBwb2xpY3kgZm9yIHRoZQogICAqIGFwcGxpY2F0aW9uIGZvciB3aGljaCBjcmVkZW50aWFscyB3aWxsIGJlIGdpdmVuLCBhcyB3ZWxsIGFzIGEgYFByaW5jaXBhbEFybmAKICAgKiByZXByZXNlbnRpbmcgdGhlIEFSTiBmb3IgdGhlIFNBTUwgaWRlbnRpdHkgcHJvdmlkZXIuIEluIGFkZGl0aW9uLCB0aGUKICAgKiBgU0FNTEFzc2VydGlvbmAgbXVzdCBiZSBzZXQgdG8gdGhlIHRva2VuIHByb3ZpZGVkIGJ5IHRoZSBpZGVudGl0eQogICAqIHByb3ZpZGVyLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAgICogb2JqZWN0IHdpdGggcHJvcGVyIGBSb2xlQXJuYCwgYFByaW5jaXBhbEFybmAsIGFuZCBgU0FNTEFzc2VydGlvbmAgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBTQU1MQXNzZXJ0aW9uLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLlNBTUxBc3NlcnRpb24gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICAgKiAgICAgYHBhcmFtcy5TQU1MQXNzZXJ0aW9uYCBwcm9wZXJ0eS4KICAgKi8KICBBV1MuU0FNTENyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKiBAcGFyYW0gKHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTCkKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5TQU1MQ3JlZGVudGlhbHMoewogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1NBTUxSb2xlJywKICAgICAqICAgICBQcmluY2lwYWxBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1NBTUxQcmluY2lwYWwnLAogICAgICogICAgIFNBTUxBc3NlcnRpb246ICdiYXNlNjQtdG9rZW4nLCAvLyBiYXNlNjQtZW5jb2RlZCB0b2tlbiBmcm9tIElkUAogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUwKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNBTUxDcmVkZW50aWFscyhwYXJhbXMpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlV2l0aFNBTUwoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5zZXJ2aWNlID0gdGhpcy5zZXJ2aWNlIHx8IG5ldyBTVFMoe3BhcmFtczogdGhpcy5wYXJhbXN9KTsKICAgIH0KICAKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20ge0FXUy5TVFN9LiBXaXRob3V0IGFueQogICAqIGV4dHJhIHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIHRoZQogICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9uLiBJZiBhbiBJQU0gcm9sZSBpcyBwcm92aWRlZCwgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3BlcmF0aW9uIHdpbGwgYmUgdXNlZCB0byBmZXRjaCBjcmVkZW50aWFscyBmb3IgdGhlCiAgICogcm9sZSBpbnN0ZWFkLgogICAqCiAgICogQG5vdGUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGlzIGRlcHJlY2F0ZWQsIGJ1dCByZW1haW5zIGF2YWlsYWJsZSBmb3IKICAgKiAgIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LiB7QVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzfSBpcyB0aGUKICAgKiAgIHByZWZlcnJlZCBjbGFzcyBmb3IgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogVG8gc2V0dXAgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLCBjb25maWd1cmUgYSBzZXQgb2YgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICogdXNpbmcgdGhlIHN0YW5kYXJkIGNyZWRlbnRpYWxzIHByb3ZpZGVycyAoZW52aXJvbm1lbnQsIEVDMiBpbnN0YW5jZSBtZXRhZGF0YSwKICAgKiBvciBmcm9tIHRoZSBmaWxlc3lzdGVtKSwgdGhlbiBzZXQgdGhlIGdsb2JhbCBjcmVkZW50aWFscyB0byBhIG5ldwogICAqIHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3Q6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogLy8gTm90ZSB0aGF0IGVudmlyb25tZW50IGNyZWRlbnRpYWxzIGFyZSBsb2FkZWQgYnkgZGVmYXVsdCwKICAgKiAvLyB0aGUgZm9sbG93aW5nIGxpbmUgaXMgc2hvd24gZm9yIGNsYXJpdHk6CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7CiAgICoKICAgKiAvLyBOb3cgc2V0IHRlbXBvcmFyeSBjcmVkZW50aWFscyBzZWVkZWQgZnJvbSB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgKgogICAqIC8vIHN1YnNlcXVlbnQgcmVxdWVzdHMgd2lsbCBub3cgdXNlIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICogbmV3IEFXUy5TMygpLmxpc3RCdWNrZXQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICAgKiBgYGAKICAgKgogICAqIEAhYXR0cmlidXRlIG1hc3RlckNyZWRlbnRpYWxzCiAgICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgKG5vbi10ZW1wb3JhcnkpIGNyZWRlbnRpYWxzIHVzZWQgdG8KICAgKiAgICAgZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICogQG5vdGUgKHNlZSBjb25zdHJ1Y3RvcikKICAgKi8KICBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKgogICAgICogQG5vdGUgSW4gb3JkZXIgdG8gY3JlYXRlIHRlbXBvcmFyeSBjcmVkZW50aWFscywgeW91IGZpcnN0IG5lZWQgdG8gaGF2ZQogICAgICogICAibWFzdGVyIiBjcmVkZW50aWFscyBjb25maWd1cmVkIGluIHtBV1MuQ29uZmlnLmNyZWRlbnRpYWxzfS4gVGhlc2UKICAgICAqICAgbWFzdGVyIGNyZWRlbnRpYWxzIGFyZSBuZWNlc3NhcnkgdG8gcmV0cmlldmUgdGhlIHRlbXBvcmFyeSBjcmVkZW50aWFscywKICAgICAqICAgYXMgd2VsbCBhcyByZWZyZXNoIHRoZSBjcmVkZW50aWFscyB3aGVuIHRoZXkgZXhwaXJlLgogICAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUKICAgICAqICAge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3Ige0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb25zLgogICAgICogICBJZiBhIGBSb2xlQXJuYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCBjcmVkZW50aWFscyB3aWxsIGJlIGJhc2VkIG9uIHRoZQogICAgICogICBJQU0gcm9sZS4KICAgICAqIEBwYXJhbSBtYXN0ZXJDcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIChub24tdGVtcG9yYXJ5KSBjcmVkZW50aWFscwogICAgICogIHVzZWQgdG8gZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGdlbmVyaWMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGFuIElBTSByb2xlCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9UZW1wb3JhcnlDcmVkZW50aWFscycsCiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGUKICAgICAqIEBzZWUgQVdTLlNUUy5nZXRTZXNzaW9uVG9rZW4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFRlbXBvcmFyeUNyZWRlbnRpYWxzKHBhcmFtcywgbWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMubG9hZE1hc3RlckNyZWRlbnRpYWxzKG1hc3RlckNyZWRlbnRpYWxzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICAgIGlmICh0aGlzLnBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lID0KICAgICAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAndGVtcG9yYXJ5LWNyZWRlbnRpYWxzJzsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yCiAgICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59LCBkZXBlbmRpbmcgb24gd2hldGhlciBhbiBJQU0gcm9sZSBBUk4gd2FzIHBhc3NlZAogICAgICogdG8gdGhlIGNyZWRlbnRpYWxzIHtjb25zdHJ1Y3Rvcn0uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaCAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQgKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYubWFzdGVyQ3JlZGVudGlhbHMuZ2V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzID0gc2VsZi5tYXN0ZXJDcmVkZW50aWFsczsKICAgICAgICB2YXIgb3BlcmF0aW9uID0gc2VsZi5wYXJhbXMuUm9sZUFybiA/CiAgICAgICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZSA6IHNlbGYuc2VydmljZS5nZXRTZXNzaW9uVG9rZW47CiAgICAgICAgb3BlcmF0aW9uLmNhbGwoc2VsZi5zZXJ2aWNlLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZE1hc3RlckNyZWRlbnRpYWxzOiBmdW5jdGlvbiBsb2FkTWFzdGVyQ3JlZGVudGlhbHMgKG1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSBtYXN0ZXJDcmVkZW50aWFscyB8fCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzOwogICAgICB3aGlsZSAodGhpcy5tYXN0ZXJDcmVkZW50aWFscy5tYXN0ZXJDcmVkZW50aWFscykgewogICAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSB0aGlzLm1hc3RlckNyZWRlbnRpYWxzLm1hc3RlckNyZWRlbnRpYWxzOwogICAgICB9CiAgCiAgICAgIGlmICh0eXBlb2YgdGhpcy5tYXN0ZXJDcmVkZW50aWFscy5nZXQgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyh0aGlzLm1hc3RlckNyZWRlbnRpYWxzKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5zZXJ2aWNlID0gdGhpcy5zZXJ2aWNlIHx8IG5ldyBTVFMoe3BhcmFtczogdGhpcy5wYXJhbXN9KTsKICAgIH0KICAKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgV2ViIElkZW50aXR5IEZlZGVyYXRpb24gc3VwcG9ydC4KICAgKgogICAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLiBUaGlzIG9wZXJhdGlvbgogICAqIHJlcXVpcmVzIGEgYFJvbGVBcm5gIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0IHBvbGljeSBmb3IgdGhlCiAgICogYXBwbGljYXRpb24gZm9yIHdoaWNoIGNyZWRlbnRpYWxzIHdpbGwgYmUgZ2l2ZW4uIEluIGFkZGl0aW9uLCB0aGUKICAgKiBgV2ViSWRlbnRpdHlUb2tlbmAgbXVzdCBiZSBzZXQgdG8gdGhlIHRva2VuIHByb3ZpZGVkIGJ5IHRoZSBpZGVudGl0eQogICAqIHByb3ZpZGVyLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAgICogb2JqZWN0IHdpdGggcHJvcGVyIGBSb2xlQXJuYCBhbmQgYFdlYklkZW50aXR5VG9rZW5gIHZhbHVlcy4KICAgKgogICAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAgICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAgICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogICAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICAgKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAgICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICAgKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAgICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAgICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgV2ViSWRlbnRpdHlUb2tlbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICAgKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5XZWJJZGVudGl0eVRva2VuID0gdXBkYXRlZFRva2VuOwogICAqIGBgYAogICAqCiAgICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogICAqICAgICBgcGFyYW1zLldlYklkZW50aXR5VG9rZW5gIHByb3BlcnR5LgogICAqIEAhYXR0cmlidXRlIGRhdGEKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIHJhdyBkYXRhIHJlc3BvbnNlIGZyb20gdGhlIGNhbGwgdG8KICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFVzZSB0aGlzIGlmIHlvdSB3YW50IHRvIGdldAogICAqICAgICBhY2Nlc3MgdG8gb3RoZXIgcHJvcGVydGllcyBmcm9tIHRoZSByZXNwb25zZS4KICAgKi8KICBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICogQHBhcmFtIChzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KQogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHMoewogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1dlYklkZW50aXR5JywKICAgICAqICAgICBXZWJJZGVudGl0eVRva2VuOiAnQUJDREVGR0hJSktMTU5PUCcsIC8vIHRva2VuIGZyb20gaWRlbnRpdHkgc2VydmljZQogICAgICogICAgIFJvbGVTZXNzaW9uTmFtZTogJ3dlYicgLy8gb3B0aW9uYWwgbmFtZSwgZGVmYXVsdHMgdG8gd2ViLWlkZW50aXR5CiAgICAgKiAgIH0sIHsKICAgICAqICAgICAvLyBvcHRpb25hbGx5IHByb3ZpZGUgY29uZmlndXJhdGlvbiB0byBhcHBseSB0byB0aGUgdW5kZXJseWluZyBBV1MuU1RTIHNlcnZpY2UgY2xpZW50CiAgICAgKiAgICAgLy8gaWYgY29uZmlndXJhdGlvbiBpcyBub3QgcHJvdmlkZWQsIHRoZW4gY29uZmlndXJhdGlvbiB3aWxsIGJlIHB1bGxlZCBmcm9tIEFXUy5jb25maWcKICAgICAqCiAgICAgKiAgICAgLy8gc3BlY2lmeSB0aW1lb3V0IG9wdGlvbnMKICAgICAqICAgICBodHRwT3B0aW9uczogewogICAgICogICAgICAgdGltZW91dDogMTAwCiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5CiAgICAgKiBAc2VlIEFXUy5Db25maWcKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFdlYklkZW50aXR5Q3JlZGVudGlhbHMocGFyYW1zLCBjbGllbnRDb25maWcpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPSB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3dlYi1pZGVudGl0eSc7CiAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuX2NsaWVudENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY2xpZW50Q29uZmlnIHx8IHt9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fQogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHNlbGYuZGF0YSA9IG51bGw7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuZGF0YSA9IGRhdGE7CiAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnNlcnZpY2UpIHsKICAgICAgICB2YXIgc3RzQ29uZmlnID0gQVdTLnV0aWwubWVyZ2Uoe30sIHRoaXMuX2NsaWVudENvbmZpZyk7CiAgICAgICAgc3RzQ29uZmlnLnBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgICAgIHRoaXMuc2VydmljZSA9IG5ldyBTVFMoc3RzQ29uZmlnKTsKICAgICAgfQogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CiAgdmFyIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMgPSBbJ0FXU19FTkFCTEVfRU5EUE9JTlRfRElTQ09WRVJZJywgJ0FXU19FTkRQT0lOVF9ESVNDT1ZFUllfRU5BQkxFRCddOwogIAogIC8qKgogICAqIEdlbmVyYXRlIGtleSAoZXhjZXB0IHJlc291cmNlcyBhbmQgb3BlcmF0aW9uIHBhcnQpIHRvIGluZGV4IHRoZSBlbmRwb2ludHMgaW4gdGhlIGNhY2hlCiAgICogSWYgaW5wdXQgc2hhcGUgaGFzIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICAgKiAgIGFjY2Vzc0tleSArIG9wZXJhdGlvbiArIHJlc291cmNlcyArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAgICogSWYgaW5wdXQgc2hhcGUgZG9lc24ndCBoYXZlIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICAgKiAgIGFjY2Vzc0tleSArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAgICogQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XSBvYmplY3Qgd2l0aCBrZXlzIHRvIGluZGV4IGVuZHBvaW50cy4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBnZXRDYWNoZUtleShyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaSB8fCB7fTsKICAgIHZhciBvcGVyYXRpb25zID0gYXBpLm9wZXJhdGlvbnM7CiAgICB2YXIgaWRlbnRpZmllcnMgPSB7fTsKICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5yZWdpb24pIHsKICAgICAgaWRlbnRpZmllcnMucmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgfQogICAgaWYgKGFwaS5zZXJ2aWNlSWQpIHsKICAgICAgaWRlbnRpZmllcnMuc2VydmljZUlkID0gYXBpLnNlcnZpY2VJZDsKICAgIH0KICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCkgewogICAgICBpZGVudGlmaWVycy5hY2Nlc3NLZXlJZCA9IHNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgfQogICAgcmV0dXJuIGlkZW50aWZpZXJzOwogIH0KICAKICAvKioKICAgKiBSZWN1cnNpdmUgaGVscGVyIGZvciBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKCkuCiAgICogTG9va3MgZm9yIHJlcXVpcmVkIHN0cmluZyBpbnB1dCBtZW1iZXJzIHRoYXQgaGF2ZSAnZW5kcG9pbnRkaXNjb3ZlcnlpZCcgdHJhaXQuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtcywgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgcGFyYW1zID09PSB1bmRlZmluZWQgfHwgcGFyYW1zID09PSBudWxsKSByZXR1cm47CiAgICBpZiAoc2hhcGUudHlwZSA9PT0gJ3N0cnVjdHVyZScgJiYgc2hhcGUucmVxdWlyZWQgJiYgc2hhcGUucmVxdWlyZWQubGVuZ3RoID4gMCkgewogICAgICB1dGlsLmFycmF5RWFjaChzaGFwZS5yZXF1aXJlZCwgZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgICAgaWYgKG1lbWJlclNoYXBlLmVuZHBvaW50RGlzY292ZXJ5SWQgPT09IHRydWUpIHsKICAgICAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgICAgICAgcmVzdWx0W2xvY2F0aW9uTmFtZV0gPSBTdHJpbmcocGFyYW1zW25hbWVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtc1tuYW1lXSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEdldCBjdXN0b20gaWRlbnRpZmllcnMgZm9yIGNhY2hlIGtleS4KICAgKiBJZGVudGlmaWVzIGN1c3RvbSBpZGVudGlmaWVycyBieSBjaGVja2luZyBlYWNoIHNoYXBlJ3MgYGVuZHBvaW50RGlzY292ZXJ5SWRgIHRyYWl0LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBwYXJhbSBbb2JqZWN0XSBpbnB1dCBzaGFwZSBvZiB0aGUgZ2l2ZW4gb3BlcmF0aW9uJ3MgYXBpCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBzaGFwZSkgewogICAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKGlkZW50aWZpZXJzLCByZXF1ZXN0LnBhcmFtcywgc2hhcGUpOwogICAgcmV0dXJuIGlkZW50aWZpZXJzOwogIH0KICAKICAvKioKICAgKiBDYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24gd2hlbiBpdCdzIG9wdGlvbmFsLgogICAqIFdoZW4gZW5kcG9pbnQgaXMgYXZhaWxhYmxlIGluIGNhY2hlIHRoZW4gdXNlIHRoZSBjYWNoZWQgZW5kcG9pbnRzLiBJZiBlbmRwb2ludHMKICAgKiBhcmUgdW5hdmFpbGFibGUgdGhlbiB1c2UgcmVnaW9uYWwgZW5kcG9pbnRzIGFuZCBjYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24KICAgKiBhc3luY2hyb25vdXNseS4gVGhpcyBpcyB0dXJuZWQgb2ZmIGJ5IGRlZmF1bHQuCiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgICB9CiAgICB2YXIgZW5kcG9pbnRzID0gQVdTLmVuZHBvaW50Q2FjaGUuZ2V0KGNhY2hlS2V5KTsKICAgIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA9PT0gMSAmJiBlbmRwb2ludHNbMF0uQWRkcmVzcyA9PT0gJycpIHsKICAgICAgLy9lbmRwb2ludCBvcGVyYXRpb24gaXMgYmVpbmcgbWFkZSBidXQgcmVzcG9uc2Ugbm90IHlldCByZWNlaXZlZAogICAgICAvL29yIGVuZHBvaW50IG9wZXJhdGlvbiBqdXN0IGZhaWxlZCBpbiAxIG1pbnV0ZQogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgICAvL2ZvdW5kIGVuZHBvaW50IHJlY29yZCBmcm9tIGNhY2hlCiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgfSBlbHNlIHsKICAgICAgLy9lbmRwb2ludCByZWNvcmQgbm90IGluIGNhY2hlIG9yIG91dGRhdGVkLiBtYWtlIGRpc2NvdmVyeSBvcGVyYXRpb24KICAgICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgICAgfSk7CiAgICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3JldHJ5JywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuUkVUUllfQ0hFQ0spOwogICAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiAxCiAgICAgIH1dKTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5FbmRwb2ludHMpIHsKICAgICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgZGF0YS5FbmRwb2ludHMpOwogICAgICAgIH0gZWxzZSBpZiAoZXJyKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIFt7CiAgICAgICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMSAvL25vdCB0byBtYWtlIG1vcmUgZW5kcG9pbnQgb3BlcmF0aW9uIGluIG5leHQgMSBtaW51dGUKICAgICAgICAgIH1dKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAKICB2YXIgcmVxdWVzdFF1ZXVlID0ge307CiAgCiAgLyoqCiAgICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyByZXF1aXJlZC4KICAgKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSBjYWNoZWQgb25lcy4gSWYgZW5kcG9pbnRzIGFyZQogICAqIHVuYXZhaWxhYmxlIHRoZW4gU0RLIHNob3VsZCBjYWxsIGVuZHBvaW50IG9wZXJhdGlvbiB0aGVuIHVzZSByZXR1cm5lZCBuZXcKICAgKiBlbmRwb2ludCBmb3IgdGhlIGFwaSBjYWxsLiBTREsgd2lsbCBhdXRvbWF0aWNhbGx5IGF0dGVtcHQgdG8gZG8gZW5kcG9pbnQKICAgKiBkaXNjb3ZlcnkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0CiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgICB9CiAgICB2YXIgY2FjaGVLZXlTdHIgPSBBV1MuRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoY2FjaGVLZXkpOwogICAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleVN0cik7IC8vZW5kcG9pbnQgY2FjaGUgYWxzbyBhY2NlcHRzIHN0cmluZyBrZXlzCiAgICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgICAgLy9wdXNoIHJlcXVlc3Qgb2JqZWN0IHRvIGEgcGVuZGluZyBxdWV1ZQogICAgICBpZiAoIXJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0gPSBbXTsKICAgICAgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXS5wdXNoKHtyZXF1ZXN0OiByZXF1ZXN0LCBjYWxsYmFjazogZG9uZX0pOwogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgICAgZG9uZSgpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgICAgfSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpOwogIAogICAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBbewogICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiA2MCAvL2xvbmctbGl2ZSBjYWNoZQogICAgICB9XSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHZhciBlcnJvclBhcmFtcyA9IHsKICAgICAgICAgICAgY29kZTogJ0VuZHBvaW50RGlzY292ZXJ5RXhjZXB0aW9uJywKICAgICAgICAgICAgbWVzc2FnZTogJ1JlcXVlc3QgY2Fubm90IGJlIGZ1bGZpbGxlZCB3aXRob3V0IHNwZWNpZnlpbmcgYW4gZW5kcG9pbnQnLAogICAgICAgICAgICByZXRyeWFibGU6IGZhbHNlCiAgICAgICAgICB9OwogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCBlcnJvclBhcmFtcyk7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwogIAogICAgICAgICAgLy9mYWlsIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0LnJlc3BvbnNlLmVycm9yID0gdXRpbC5lcnJvcihlcnIsIGVycm9yUGFyYW1zKTsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChkYXRhKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXlTdHIsIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZGF0YS5FbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgCiAgICAgICAgICAvL3VwZGF0ZSB0aGUgZW5kcG9pbnQgZm9yIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LmNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZG9uZSgpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogYWRkIGFwaSB2ZXJzaW9uIGhlYWRlciB0byBlbmRwb2ludCBvcGVyYXRpb24KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCkgewogICAgdmFyIGFwaSA9IGVuZHBvaW50UmVxdWVzdC5zZXJ2aWNlLmFwaTsKICAgIHZhciBhcGlWZXJzaW9uID0gYXBpLmFwaVZlcnNpb247CiAgICBpZiAoYXBpVmVyc2lvbiAmJiAhZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10pIHsKICAgICAgZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10gPSBhcGlWZXJzaW9uOwogICAgfQogIH0KICAKICAvKioKICAgKiBJZiBhcGkgY2FsbCBnZXRzIGludmFsaWQgZW5kcG9pbnQgZXhjZXB0aW9uLCBTREsgc2hvdWxkIGF0dGVtcHQgdG8gcmVtb3ZlIHRoZSBpbnZhbGlkCiAgICogZW5kcG9pbnQgZnJvbSBjYWNoZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKHJlc3BvbnNlKSB7CiAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgIHZhciBodHRwUmVzcG9uc2UgPSByZXNwb25zZS5odHRwUmVzcG9uc2U7CiAgICBpZiAoZXJyb3IgJiYKICAgICAgKGVycm9yLmNvZGUgPT09ICdJbnZhbGlkRW5kcG9pbnRFeGNlcHRpb24nIHx8IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MjEpCiAgICApIHsKICAgICAgdmFyIHJlcXVlc3QgPSByZXNwb25zZS5yZXF1ZXN0OwogICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA/IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLmlucHV0IDogdW5kZWZpbmVkOwogICAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICAgICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICAgIGlmIChvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0ubmFtZTsKICAgICAgfQogICAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwogICAgfQogIH0KICAKICAvKioKICAgKiBJZiBlbmRwb2ludCBpcyBleHBsaWNpdGx5IGNvbmZpZ3VyZWQsIFNESyBzaG91bGQgbm90IGRvIGVuZHBvaW50IGRpc2NvdmVyeSBpbiBhbnl0aW1lLgogICAqIEBwYXJhbSBbb2JqZWN0XSBjbGllbnQgU2VydmljZSBjbGllbnQgb2JqZWN0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGhhc0N1c3RvbUVuZHBvaW50KGNsaWVudCkgewogICAgLy9pZiBzZXQgZW5kcG9pbnQgaXMgc2V0IGZvciBzcGVjaWZpYyBjbGllbnQsIGVuYWJsZSBlbmRwb2ludCBkaXNjb3Zlcnkgd2lsbCByYWlzZSBhbiBlcnJvci4KICAgIGlmIChjbGllbnQuX29yaWdpbmFsQ29uZmlnICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnQgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgPT09IHRydWUpIHsKICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICBtZXNzYWdlOiAnQ3VzdG9tIGVuZHBvaW50IGlzIHN1cHBsaWVkOyBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgbXVzdCBub3QgYmUgdHJ1ZS4nCiAgICAgIH0pOwogICAgfTsKICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW2NsaWVudC5zZXJ2aWNlSWRlbnRpZmllcl0gfHwge307CiAgICByZXR1cm4gQm9vbGVhbihBV1MuY29uZmlnLmVuZHBvaW50IHx8IHN2Y0NvbmZpZy5lbmRwb2ludCB8fCAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50KSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRmFsc3kodmFsdWUpIHsKICAgIHJldHVybiBbJ2ZhbHNlJywgJzAnXS5pbmRleE9mKHZhbHVlKSA+PSAwOwogIH0KICAKICAvKioKICAgKiBJZiBlbmRwb2ludCBkaXNjb3Zlcnkgc2hvdWxkIHBlcmZvcm0gZm9yIHRoaXMgcmVxdWVzdCB3aGVuIGVuZHBvaW50IGRpc2NvdmVyeSBpcyBvcHRpb25hbC4KICAgKiBTREsgcGVyZm9ybXMgY29uZmlnIHJlc29sdXRpb24gaW4gb3JkZXIgbGlrZSBiZWxvdzoKICAgKiAxLiBJZiB0dXJuZWQgb24gY2xpZW50IGNvbmZpZ3VyYXRpb24oZGVmYXVsdCB0byBvZmYpIHRoZW4gdHVybiBvbiBlbmRwb2ludCBkaXNjb3ZlcnkuCiAgICogMi4gSWYgdHVybmVkIG9uIGluIGVudiBBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWSB0aGVuIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIDMuIElmIHR1cm5lZCBvbiBpbiBzaGFyZWQgaW5pIGNvbmZpZyBmaWxlIHdpdGgga2V5ICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcsIHRoZW4KICAgKiAgIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IHJlcXVlc3Qgb2JqZWN0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRW5kcG9pbnREaXNjb3ZlcnlBcHBsaWNhYmxlKHJlcXVlc3QpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogICAgaWYgKHNlcnZpY2UuY29uZmlnLmVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCA9PT0gdHJ1ZSkgcmV0dXJuIHRydWU7CiAgCiAgICAvL3NoYXJlZCBpbmkgZmlsZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiBOb2RlCiAgICAvL25vdCB0byBjaGVjayBlbnYgaW4gYnJvd3NlcgogICAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiBmYWxzZTsKICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgZW52ID0gZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52c1tpXTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgZW52KSkgewogICAgICAgIGlmIChwcm9jZXNzLmVudltlbnZdID09PSAnJyB8fCBwcm9jZXNzLmVudltlbnZdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgICBtZXNzYWdlOiAnZW52aXJvbm1lbnRhbCB2YXJpYWJsZSAnICsgZW52ICsgJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0ZhbHN5KHByb2Nlc3MuZW52W2Vudl0pKSByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIAogICAgdmFyIGNvbmZpZ0ZpbGUgPSB7fTsKICAgIHRyeSB7CiAgICAgIGNvbmZpZ0ZpbGUgPSBBV1MudXRpbC5pbmlMb2FkZXIgPyBBV1MudXRpbC5pbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgIGlzQ29uZmlnOiB0cnVlLAogICAgICAgIGZpbGVuYW1lOiBwcm9jZXNzLmVudltBV1MudXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgICB9KSA6IHt9OwogICAgfSBjYXRjaCAoZSkge30KICAgIHZhciBzaGFyZWRGaWxlQ29uZmlnID0gY29uZmlnRmlsZVsKICAgICAgcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGUKICAgIF0gfHwge307CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNoYXJlZEZpbGVDb25maWcsICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcpKSB7CiAgICAgIGlmIChzaGFyZWRGaWxlQ29uZmlnLmVuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnY29uZmlnIGZpbGUgZW50cnkgXCdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZFwnIGNhbm5vdCBiZSBzZXQgdG8gbm90aGluZycKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIWlzRmFsc3koc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCkpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICAKICAvKioKICAgKiBhdHRhY2ggZW5kcG9pbnQgZGlzY292ZXJ5IGxvZ2ljIHRvIHJlcXVlc3Qgb2JqZWN0CiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3QKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBkaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogICAgaWYgKGhhc0N1c3RvbUVuZHBvaW50KHNlcnZpY2UpIHx8IHJlcXVlc3QuaXNQcmVzaWduZWQoKSkgcmV0dXJuIGRvbmUoKTsKICAKICAgIGlmICghaXNFbmRwb2ludERpc2NvdmVyeUFwcGxpY2FibGUocmVxdWVzdCkpIHJldHVybiBkb25lKCk7CiAgCiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdlbmRwb2ludC1kaXNjb3ZlcnknKTsKICAKICAgIHZhciBvcGVyYXRpb25zID0gc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgdmFyIGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA6ICdOVUxMJzsKICAgIHN3aXRjaCAoaXNFbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkKSB7CiAgICAgIGNhc2UgJ09QVElPTkFMJzoKICAgICAgICBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCk7CiAgICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgICAgZG9uZSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdSRVFVSVJFRCc6CiAgICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgICAgcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdOVUxMJzoKICAgICAgZGVmYXVsdDoKICAgICAgICBkb25lKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gewogICAgZGlzY292ZXJFbmRwb2ludDogZGlzY292ZXJFbmRwb2ludCwKICAgIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludDogcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50LAogICAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50OiBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQsCiAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzOiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzLAogICAgZ2V0Q2FjaGVLZXk6IGdldENhY2hlS2V5LAogICAgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50OiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzLAogIH07CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL3V0aWwiOjcxLCJfcHJvY2VzcyI6ODZ9XSwyNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGV2ZW50TWVzc2FnZUNodW5rZXIgPSByZXF1aXJlKCcuLi9ldmVudC1zdHJlYW0vZXZlbnQtbWVzc2FnZS1jaHVua2VyJykuZXZlbnRNZXNzYWdlQ2h1bmtlcjsKICB2YXIgcGFyc2VFdmVudCA9IHJlcXVpcmUoJy4vcGFyc2UtZXZlbnQnKS5wYXJzZUV2ZW50OwogIAogIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50U3RyZWFtKGJvZHksIHBhcnNlciwgbW9kZWwpIHsKICAgICAgdmFyIGV2ZW50TWVzc2FnZXMgPSBldmVudE1lc3NhZ2VDaHVua2VyKGJvZHkpOwogIAogICAgICB2YXIgZXZlbnRzID0gW107CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRNZXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZXZlbnRzLnB1c2gocGFyc2VFdmVudChwYXJzZXIsIGV2ZW50TWVzc2FnZXNbaV0sIG1vZGVsKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGV2ZW50czsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZUV2ZW50U3RyZWFtOiBjcmVhdGVFdmVudFN0cmVhbQogIH07CiAgCiAgfSx7Ii4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXIiOjI4LCIuL3BhcnNlLWV2ZW50IjozMH1dLDI4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBUYWtlcyBpbiBhIGJ1ZmZlciBvZiBldmVudCBtZXNzYWdlcyBhbmQgc3BsaXRzIHRoZW0gaW50byBpbmRpdmlkdWFsIG1lc3NhZ2VzLgogICAqIEBwYXJhbSB7QnVmZmVyfSBidWZmZXIKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBldmVudE1lc3NhZ2VDaHVua2VyKGJ1ZmZlcikgewogICAgICAvKiogQHR5cGUgQnVmZmVyW10gKi8KICAgICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICAgIHZhciBvZmZzZXQgPSAwOwogIAogICAgICB3aGlsZSAob2Zmc2V0IDwgYnVmZmVyLmxlbmd0aCkgewogICAgICAgICAgdmFyIHRvdGFsTGVuZ3RoID0gYnVmZmVyLnJlYWRJbnQzMkJFKG9mZnNldCk7CiAgCiAgICAgICAgICAvLyBjcmVhdGUgbmV3IGJ1ZmZlciBmb3IgaW5kaXZpZHVhbCBtZXNzYWdlIChzaGFyZXMgbWVtb3J5IHdpdGggb3JpZ2luYWwpCiAgICAgICAgICB2YXIgbWVzc2FnZSA9IGJ1ZmZlci5zbGljZShvZmZzZXQsIHRvdGFsTGVuZ3RoICsgb2Zmc2V0KTsKICAgICAgICAgIC8vIGluY3JlbWVudCBvZmZzZXQgdG8gaXQgc3RhcnRzIGF0IHRoZSBuZXh0IG1lc3NhZ2UKICAgICAgICAgIG9mZnNldCArPSB0b3RhbExlbmd0aDsKICAKICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobWVzc2FnZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG1lc3NhZ2VzOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXZlbnRNZXNzYWdlQ2h1bmtlcjogZXZlbnRNZXNzYWdlQ2h1bmtlcgogIH07CiAgCiAgfSx7fV0sMjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CiAgdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CiAgCiAgLyoqCiAgICogQSBsb3NzbGVzcyByZXByZXNlbnRhdGlvbiBvZiBhIHNpZ25lZCwgNjQtYml0IGludGVnZXIuIEluc3RhbmNlcyBvZiB0aGlzCiAgICogY2xhc3MgbWF5IGJlIHVzZWQgaW4gYXJpdGhtZXRpYyBleHByZXNzaW9ucyBhcyBpZiB0aGV5IHdlcmUgbnVtZXJpYwogICAqIHByaW1pdGl2ZXMsIGJ1dCB0aGUgYmluYXJ5IHJlcHJlc2VudGF0aW9uIHdpbGwgYmUgcHJlc2VydmVkIHVuY2hhbmdlZCBhcyB0aGUKICAgKiBgYnl0ZXNgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoZSBieXRlcyBzaG91bGQgYmUgZW5jb2RlZCBhcyBiaWctZW5kaWFuLAogICAqIHR3bydzIGNvbXBsZW1lbnQgaW50ZWdlcnMuCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBJbnQ2NChieXRlcykgewogICAgICBpZiAoYnl0ZXMubGVuZ3RoICE9PSA4KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludDY0IGJ1ZmZlcnMgbXVzdCBiZSBleGFjdGx5IDggYnl0ZXMnKTsKICAgICAgfQogICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ5dGVzKSkgYnl0ZXMgPSB0b0J1ZmZlcihieXRlcyk7CiAgCiAgICAgIHRoaXMuYnl0ZXMgPSBieXRlczsKICB9CiAgCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IG51bWJlcgogICAqIEByZXR1cm5zIHtJbnQ2NH0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LmZyb21OdW1iZXIgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgaWYgKG51bWJlciA+IDkyMjMzNzIwMzY4NTQ3NzU4MDcgfHwgbnVtYmVyIDwgLTkyMjMzNzIwMzY4NTQ3NzU4MDgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICBudW1iZXIgKyAnIGlzIHRvbyBsYXJnZSAob3IsIGlmIG5lZ2F0aXZlLCB0b28gc21hbGwpIHRvIHJlcHJlc2VudCBhcyBhbiBJbnQ2NCcKICAgICAgICAgICk7CiAgICAgIH0KICAKICAgICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICAgIGZvciAoCiAgICAgICAgICB2YXIgaSA9IDcsIHJlbWFpbmluZyA9IE1hdGguYWJzKE1hdGgucm91bmQobnVtYmVyKSk7CiAgICAgICAgICBpID4gLTEgJiYgcmVtYWluaW5nID4gMDsKICAgICAgICAgIGktLSwgcmVtYWluaW5nIC89IDI1NgogICAgICApIHsKICAgICAgICAgIGJ5dGVzW2ldID0gcmVtYWluaW5nOwogICAgICB9CiAgCiAgICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgICBuZWdhdGUoYnl0ZXMpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBuZXcgSW50NjQoYnl0ZXMpOwogIH07CiAgCiAgLyoqCiAgICogQHJldHVybnMge251bWJlcn0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LnByb3RvdHlwZS52YWx1ZU9mID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBieXRlcyA9IHRoaXMuYnl0ZXMuc2xpY2UoMCk7CiAgICAgIHZhciBuZWdhdGl2ZSA9IGJ5dGVzWzBdICYgMTI4OwogICAgICBpZiAobmVnYXRpdmUpIHsKICAgICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHBhcnNlSW50KGJ5dGVzLnRvU3RyaW5nKCdoZXgnKSwgMTYpICogKG5lZ2F0aXZlID8gLTEgOiAxKTsKICB9OwogIAogIEludDY0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXMudmFsdWVPZigpKTsKICB9OwogIAogIC8qKgogICAqIEBwYXJhbSB7QnVmZmVyfSBieXRlcwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbmVnYXRlKGJ5dGVzKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICBieXRlc1tpXSBePSAweEZGOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSA3OyBpID4gLTE7IGktLSkgewogICAgICAgICAgYnl0ZXNbaV0rKzsKICAgICAgICAgIGlmIChieXRlc1tpXSAhPT0gMCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbnQ2NDogSW50NjQKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDMwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcGFyc2VNZXNzYWdlID0gcmVxdWlyZSgnLi9wYXJzZS1tZXNzYWdlJykucGFyc2VNZXNzYWdlOwogIAogIC8qKgogICAqCiAgICogQHBhcmFtIHsqfSBwYXJzZXIKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqIEBwYXJhbSB7Kn0gc2hhcGUKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwYXJzZUV2ZW50KHBhcnNlciwgbWVzc2FnZSwgc2hhcGUpIHsKICAgICAgdmFyIHBhcnNlZE1lc3NhZ2UgPSBwYXJzZU1lc3NhZ2UobWVzc2FnZSk7CiAgCiAgICAgIC8vIGNoZWNrIGlmIG1lc3NhZ2UgaXMgYW4gZXZlbnQgb3IgZXJyb3IKICAgICAgdmFyIG1lc3NhZ2VUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6bWVzc2FnZS10eXBlJ107CiAgICAgIGlmIChtZXNzYWdlVHlwZSkgewogICAgICAgICAgaWYgKG1lc3NhZ2VUeXBlLnZhbHVlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihwYXJzZWRNZXNzYWdlKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZVR5cGUudmFsdWUgIT09ICdldmVudCcpIHsKICAgICAgICAgICAgICAvLyBub3Qgc3VyZSBob3cgdG8gcGFyc2Ugbm9uLWV2ZW50cy9ub24tZXJyb3JzLCBpZ25vcmUgZm9yIG5vdwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyBkZXRlcm1pbmUgZXZlbnQgdHlwZQogICAgICB2YXIgZXZlbnRUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6ZXZlbnQtdHlwZSddOwogICAgICAvLyBjaGVjayB0aGF0IHRoZSBldmVudCB0eXBlIGlzIG1vZGVsZWQKICAgICAgdmFyIGV2ZW50TW9kZWwgPSBzaGFwZS5tZW1iZXJzW2V2ZW50VHlwZS52YWx1ZV07CiAgICAgIGlmICghZXZlbnRNb2RlbCkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgCiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgLy8gY2hlY2sgaWYgYW4gZXZlbnQgcGF5bG9hZCBleGlzdHMKICAgICAgdmFyIGV2ZW50UGF5bG9hZE1lbWJlck5hbWUgPSBldmVudE1vZGVsLmV2ZW50UGF5bG9hZE1lbWJlck5hbWU7CiAgICAgIGlmIChldmVudFBheWxvYWRNZW1iZXJOYW1lKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZFNoYXBlID0gZXZlbnRNb2RlbC5tZW1iZXJzW2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdOwogICAgICAgICAgLy8gaWYgdGhlIHNoYXBlIGlzIGJpbmFyeSwgcmV0dXJuIHRoZSBieXRlIGFycmF5CiAgICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknKSB7CiAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdID0gcGFyc2VkTWVzc2FnZS5ib2R5OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZXIucGFyc2UocGFyc2VkTWVzc2FnZS5ib2R5LnRvU3RyaW5nKCksIHBheWxvYWRTaGFwZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgLy8gcmVhZCBldmVudCBoZWFkZXJzCiAgICAgIHZhciBldmVudEhlYWRlck5hbWVzID0gZXZlbnRNb2RlbC5ldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50SGVhZGVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBuYW1lID0gZXZlbnRIZWFkZXJOYW1lc1tpXTsKICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgICAgICAvLyBwYXJzZSB0aGUgaGVhZGVyIQogICAgICAgICAgICAgIHJlc3VsdFtuYW1lXSA9IGV2ZW50TW9kZWwubWVtYmVyc1tuYW1lXS50b1R5cGUocGFyc2VkTWVzc2FnZS5oZWFkZXJzW25hbWVdLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgb3V0cHV0ID0ge307CiAgICAgIG91dHB1dFtldmVudFR5cGUudmFsdWVdID0gcmVzdWx0OwogICAgICByZXR1cm4gb3V0cHV0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZUVycm9yKG1lc3NhZ2UpIHsKICAgICAgdmFyIGVycm9yQ29kZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLWNvZGUnXTsKICAgICAgdmFyIGVycm9yTWVzc2FnZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLW1lc3NhZ2UnXTsKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKGVycm9yTWVzc2FnZS52YWx1ZSB8fCBlcnJvck1lc3NhZ2UpOwogICAgICBlcnJvci5jb2RlID0gZXJyb3IubmFtZSA9IGVycm9yQ29kZS52YWx1ZSB8fCBlcnJvckNvZGU7CiAgICAgIHJldHVybiBlcnJvcjsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHBhcnNlRXZlbnQ6IHBhcnNlRXZlbnQKICB9OwogIAogIH0seyIuL3BhcnNlLW1lc3NhZ2UiOjMxfV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBJbnQ2NCA9IHJlcXVpcmUoJy4vaW50NjQnKS5JbnQ2NDsKICAKICB2YXIgc3BsaXRNZXNzYWdlID0gcmVxdWlyZSgnLi9zcGxpdC1tZXNzYWdlJykuc3BsaXRNZXNzYWdlOwogIAogIHZhciBCT09MRUFOX1RBRyA9ICdib29sZWFuJzsKICB2YXIgQllURV9UQUcgPSAnYnl0ZSc7CiAgdmFyIFNIT1JUX1RBRyA9ICdzaG9ydCc7CiAgdmFyIElOVF9UQUcgPSAnaW50ZWdlcic7CiAgdmFyIExPTkdfVEFHID0gJ2xvbmcnOwogIHZhciBCSU5BUllfVEFHID0gJ2JpbmFyeSc7CiAgdmFyIFNUUklOR19UQUcgPSAnc3RyaW5nJzsKICB2YXIgVElNRVNUQU1QX1RBRyA9ICd0aW1lc3RhbXAnOwogIHZhciBVVUlEX1RBRyA9ICd1dWlkJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBoZWFkZXJzCiAgICovCiAgZnVuY3Rpb24gcGFyc2VIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgdmFyIG91dCA9IHt9OwogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB3aGlsZSAocG9zaXRpb24gPCBoZWFkZXJzLmxlbmd0aCkgewogICAgICAgICAgdmFyIG5hbWVMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKTsKICAgICAgICAgIHZhciBuYW1lID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBuYW1lTGVuZ3RoKS50b1N0cmluZygpOwogICAgICAgICAgcG9zaXRpb24gKz0gbmFtZUxlbmd0aDsKICAgICAgICAgIHN3aXRjaCAoaGVhZGVycy5yZWFkVUludDgocG9zaXRpb24rKykpIHsKICAgICAgICAgICAgICBjYXNlIDAgLyogYm9vbFRydWUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJPT0xFQU5fVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAxIC8qIGJvb2xGYWxzZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAyIC8qIGJ5dGUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJZVEVfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDgocG9zaXRpb24rKykKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAzIC8qIHNob3J0ICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBTSE9SVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MTZCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA0IC8qIGludGVnZXIgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IElOVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MzJCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA1IC8qIGxvbmcgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IExPTkdfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDYgLyogYnl0ZUFycmF5ICovOgogICAgICAgICAgICAgICAgICB2YXIgYmluYXJ5TGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDE2QkUocG9zaXRpb24pOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCSU5BUllfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgYmluYXJ5TGVuZ3RoKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBiaW5hcnlMZW5ndGg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNyAvKiBzdHJpbmcgKi86CiAgICAgICAgICAgICAgICAgIHZhciBzdHJpbmdMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFNUUklOR19UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiArIHN0cmluZ0xlbmd0aAogICAgICAgICAgICAgICAgICAgICAgKS50b1N0cmluZygpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IHN0cmluZ0xlbmd0aDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4IC8qIHRpbWVzdGFtcCAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVElNRVNUQU1QX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgRGF0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgSW50NjQoaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyA4KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlT2YoKQogICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDkgLyogdXVpZCAqLzoKICAgICAgICAgICAgICAgICAgdmFyIHV1aWRDaGFycyA9IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgMTYpCiAgICAgICAgICAgICAgICAgICAgICAudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAxNjsKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVVVJRF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdXVpZENoYXJzLnN1YnN0cigwLCA4KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cig4LCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxMiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMTYsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDIwKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXplZCBoZWFkZXIgdHlwZSB0YWcnKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZU1lc3NhZ2UobWVzc2FnZSkgewogICAgICB2YXIgcGFyc2VkID0gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICByZXR1cm4geyBoZWFkZXJzOiBwYXJzZUhlYWRlcnMocGFyc2VkLmhlYWRlcnMpLCBib2R5OiBwYXJzZWQuYm9keSB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgcGFyc2VNZXNzYWdlOiBwYXJzZU1lc3NhZ2UKICB9OwogIAogIH0seyIuL2ludDY0IjoyOSwiLi9zcGxpdC1tZXNzYWdlIjozMn1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL2NvcmUnKS51dGlsOwogIHZhciB0b0J1ZmZlciA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyOwogIAogIC8vIEFsbCBwcmVsdWRlIGNvbXBvbmVudHMgYXJlIHVuc2lnbmVkLCAzMi1iaXQgaW50ZWdlcnMKICB2YXIgUFJFTFVERV9NRU1CRVJfTEVOR1RIID0gNDsKICAvLyBUaGUgcHJlbHVkZSBjb25zaXN0cyBvZiB0d28gY29tcG9uZW50cwogIHZhciBQUkVMVURFX0xFTkdUSCA9IFBSRUxVREVfTUVNQkVSX0xFTkdUSCAqIDI7CiAgLy8gQ2hlY2tzdW1zIGFyZSBhbHdheXMgQ1JDMzIgaGFzaGVzLgogIHZhciBDSEVDS1NVTV9MRU5HVEggPSA0OwogIC8vIE1lc3NhZ2VzIG11c3QgaW5jbHVkZSBhIGZ1bGwgcHJlbHVkZSwgYSBwcmVsdWRlIGNoZWNrc3VtLCBhbmQgYSBtZXNzYWdlIGNoZWNrc3VtCiAgdmFyIE1JTklNVU1fTUVTU0FHRV9MRU5HVEggPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSCAqIDI7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqLwogIGZ1bmN0aW9uIHNwbGl0TWVzc2FnZShtZXNzYWdlKSB7CiAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIobWVzc2FnZSkpIG1lc3NhZ2UgPSB0b0J1ZmZlcihtZXNzYWdlKTsKICAKICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoIDwgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlZCBtZXNzYWdlIHRvbyBzaG9ydCB0byBhY2NvbW1vZGF0ZSBldmVudCBzdHJlYW0gbWVzc2FnZSBvdmVyaGVhZCcpOwogICAgICB9CiAgCiAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCAhPT0gbWVzc2FnZS5yZWFkVUludDMyQkUoMCkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVwb3J0ZWQgbWVzc2FnZSBsZW5ndGggZG9lcyBub3QgbWF0Y2ggcmVjZWl2ZWQgbWVzc2FnZSBsZW5ndGgnKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIFBSRUxVREVfTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIHByZWx1ZGUgY2hlY2tzdW0gc3BlY2lmaWVkIGluIHRoZSBtZXNzYWdlICgnICsKICAgICAgICAgICAgICBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSArCiAgICAgICAgICAgICAgJykgZG9lcyBub3QgbWF0Y2ggdGhlIGNhbGN1bGF0ZWQgQ1JDMzIgY2hlY2tzdW0uJwogICAgICAgICAgKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIG1lc3NhZ2UgY2hlY2tzdW0gZGlkIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWQgdmFsdWUgb2YgJyArCiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtCiAgICAgICAgICApOwogICAgICB9CiAgCiAgICAgIHZhciBoZWFkZXJzU3RhcnQgPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSDsKICAgICAgdmFyIGhlYWRlcnNFbmQgPSBoZWFkZXJzU3RhcnQgKyBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX01FTUJFUl9MRU5HVEgpOwogIAogICAgICByZXR1cm4gewogICAgICAgICAgaGVhZGVyczogbWVzc2FnZS5zbGljZShoZWFkZXJzU3RhcnQsIGhlYWRlcnNFbmQpLAogICAgICAgICAgYm9keTogbWVzc2FnZS5zbGljZShoZWFkZXJzRW5kLCBtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCksCiAgICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBzcGxpdE1lc3NhZ2U6IHNwbGl0TWVzc2FnZQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgU2VxdWVudGlhbEV4ZWN1dG9yID0gcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CiAgdmFyIERJU0NPVkVSX0VORFBPSU5UID0gcmVxdWlyZSgnLi9kaXNjb3Zlcl9lbmRwb2ludCcpLmRpc2NvdmVyRW5kcG9pbnQ7CiAgLyoqCiAgICogVGhlIG5hbWVzcGFjZSB1c2VkIHRvIHJlZ2lzdGVyIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgZm9yIHJlcXVlc3QgYnVpbGRpbmcKICAgKiBhbmQgc2VuZGluZy4KICAgKi8KICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICAvKioKICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX0NSRURFTlRJQUxTCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZXF1ZXN0IGlzIGJlaW5nCiAgICAgKiAgIHNlbnQgd2l0aCBjcmVkZW50aWFscy4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1JFR0lPTgogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgd2hldGhlciB0aGUgcmVnaW9uIGlzIHNldAogICAgICogICBmb3IgYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcmVnaW9uIGNvbmZpZ3VyYXRpb24KICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT047CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1BBUkFNRVRFUlMKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIGlucHV0IHBhcmFtZXRlcnMgaW4gYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcGFyYW1ldGVycwogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEBleGFtcGxlIERpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24gZ2xvYmFsbHkKICAgICAqICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLAogICAgICogICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgU0VORAogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCBpbml0aWF0ZXMgdGhlIEhUVFAgY29ubmVjdGlvbiBmb3IgYQogICAgICogICByZXF1ZXN0IGJlaW5nIHNlbnQuIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH5zZW5kICdzZW5kJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBSZXBsYWNpbmcgdGhlIEhUVFAgaGFuZGxlcgogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQ7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignc2VuZCcsIGxpc3RlbmVyKTsKICAgICAqICAgICByZXF1ZXN0Lm9uKCdzZW5kJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgIGN1c3RvbUhhbmRsZXIuc2VuZChyZXNwb25zZSk7CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogICBAcmVhZG9ubHkKICAgICAqIEAhYXR0cmlidXRlIEhUVFBfREFUQQogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCByZWFkcyBkYXRhIGZyb20gdGhlIEhUVFAgY29ubmVjdGlvbiBpbiBvcmRlcgogICAgICogICB0byBidWlsZCB0aGUgcmVzcG9uc2UgZGF0YS4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fmh0dHBEYXRhICdodHRwRGF0YScgUmVxdWVzdCBldmVudH0uCiAgICAgKiAgIFJlbW92ZSB0aGlzIGhhbmRsZXIgaWYgeW91IGFyZSBvdmVycmlkaW5nIHRoZSAnaHR0cERhdGEnIGV2ZW50IGFuZAogICAgICogICBkbyBub3Qgd2FudCBleHRyYSBkYXRhIHByb2Nlc3NpbmcgYW5kIGJ1ZmZlcmluZyBvdmVyaGVhZC4KICAgICAqICAgQGV4YW1wbGUgRGlzYWJsaW5nIGRlZmF1bHQgZGF0YSBwcm9jZXNzaW5nCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgbGlzdGVuZXIpOwogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqICAgQHJlYWRvbmx5CiAgICAgKi8KICAgIENvcmU6IHt9IC8qIGRvYyBoYWNrICovCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBnZXRPcGVyYXRpb25BdXRodHlwZShyZXEpIHsKICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgcmV0dXJuIG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogIH0KICAKICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICBDb3JlOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkLCBhZGRBc3luYykgewogICAgICBhZGRBc3luYygnVkFMSURBVEVfQ1JFREVOVElBTFMnLCAndmFsaWRhdGUnLAogICAgICAgICAgZnVuY3Rpb24gVkFMSURBVEVfQ1JFREVOVElBTFMocmVxLCBkb25lKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgICByZXEuc2VydmljZS5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKGVyciwKICAgICAgICAgICAgICB7Y29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnfSk7CiAgICAgICAgICB9CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1ZBTElEQVRFX1JFR0lPTicsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFR0lPTihyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmNvbmZpZy5yZWdpb24gJiYgIXJlcS5zZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0JVSUxEX0lERU1QT1RFTkNZX1RPS0VOUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIEJVSUxEX0lERU1QT1RFTkNZX1RPS0VOUyhyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgICBpZiAoIW9wZXJhdGlvbikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaWRlbXBvdGVudE1lbWJlcnMgPSBvcGVyYXRpb24uaWRlbXBvdGVudE1lbWJlcnM7CiAgICAgICAgaWYgKCFpZGVtcG90ZW50TWVtYmVycy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gY3JlYXRlcyBhIGNvcHkgb2YgcGFyYW1zIHNvIHVzZXIncyBwYXJhbSBvYmplY3QgaXNuJ3QgbXV0YXRlZAogICAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHJlcS5wYXJhbXMpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gaWRlbXBvdGVudE1lbWJlcnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAoIXBhcmFtc1tpZGVtcG90ZW50TWVtYmVyc1tpXV0pIHsKICAgICAgICAgICAgLy8gYWRkIHRoZSBtZW1iZXIKICAgICAgICAgICAgcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSA9IEFXUy51dGlsLnV1aWQudjQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVxLnBhcmFtcyA9IHBhcmFtczsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUEFSQU1FVEVSUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1BBUkFNRVRFUlMocmVxKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgICAgICB2YXIgdmFsaWRhdGlvbiA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5wYXJhbVZhbGlkYXRpb247CiAgICAgICAgbmV3IEFXUy5QYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKS52YWxpZGF0ZShydWxlcywgcmVxLnBhcmFtcyk7CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnQ09NUFVURV9TSEEyNTYnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIENPTVBVVEVfU0hBMjU2KHJlcSwgZG9uZSkgewogICAgICAgIHJlcS5oYWx0SGFuZGxlcnNPbkVycm9yKCk7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXJlcS5zZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgICAgICAgaWYgKHJlcS5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSkgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICAgICAgICB2YXIgYm9keSA9IHJlcS5odHRwUmVxdWVzdC5ib2R5IHx8ICcnOwogICAgICAgICAgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgICAgfQogICAgICAgICAgQVdTLnV0aWwuY29tcHV0ZVNoYTI1Nihib2R5LCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgZG9uZShlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gc2hhOwogICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1NFVF9DT05URU5UX0xFTkdUSCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0NPTlRFTlRfTEVOR1RIKHJlcSkgewogICAgICAgIHZhciBhdXRodHlwZSA9IGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSk7CiAgICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBBV1MudXRpbC5nZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSk7CiAgICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBBV1MudXRpbC5zdHJpbmcuYnl0ZUxlbmd0aChyZXEuaHR0cFJlcXVlc3QuYm9keSk7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gbGVuZ3RoOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyICYmIHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZE1lbWJlci5yZXF1aXJlc0xlbmd0aCkgewogICAgICAgICAgICAgICAgLy9zdHJlYW1pbmcgcGF5bG9hZCByZXF1aXJlcyBsZW5ndGgoczMsIGdsYWNpZXIpCiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdXRodHlwZS5pbmRleE9mKCd1bnNpZ25lZC1ib2R5JykgPj0gMCkgewogICAgICAgICAgICAgICAgLy91bmJvdW5kZWQgc3RyZWFtaW5nIHBheWxvYWQobGV4LCBtZWRpYXN0b3JlKQogICAgICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1RyYW5zZmVyLUVuY29kaW5nJ10gPSAnY2h1bmtlZCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnU0VUX0hUVFBfSE9TVCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0hUVFBfSE9TVChyZXEpIHsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gcmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFU1RBUlQnLCAncmVzdGFydCcsIGZ1bmN0aW9uIFJFU1RBUlQoKSB7CiAgICAgICAgdmFyIGVyciA9IHRoaXMucmVzcG9uc2UuZXJyb3I7CiAgICAgICAgaWYgKCFlcnIgfHwgIWVyci5yZXRyeWFibGUpIHJldHVybjsKICAKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdCgKICAgICAgICAgIHRoaXMuc2VydmljZS5lbmRwb2ludCwKICAgICAgICAgIHRoaXMuc2VydmljZS5yZWdpb24KICAgICAgICApOwogIAogICAgICAgIGlmICh0aGlzLnJlc3BvbnNlLnJldHJ5Q291bnQgPCB0aGlzLnNlcnZpY2UuY29uZmlnLm1heFJldHJpZXMpIHsKICAgICAgICAgIHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCsrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKICAgICAgYWRkQXN5bmMoJ0RJU0NPVkVSX0VORFBPSU5UJywgJ3NpZ24nLCBESVNDT1ZFUl9FTkRQT0lOVCwgYWRkVG9IZWFkKTsKICAKICAgICAgYWRkQXN5bmMoJ1NJR04nLCAnc2lnbicsIGZ1bmN0aW9uIFNJR04ocmVxLCBkb25lKSB7CiAgICAgICAgdmFyIHNlcnZpY2UgPSByZXEuc2VydmljZTsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICAgIHZhciBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICAgIHZhciBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICAgIGlmICghc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAKICAgICAgICBzZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbiAoZXJyLCBjcmVkZW50aWFscykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgZGF0ZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAgICAgICAgICAgdmFyIFNpZ25lckNsYXNzID0gc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXEpOwogICAgICAgICAgICB2YXIgc2lnbmVyID0gbmV3IFNpZ25lckNsYXNzKHJlcS5odHRwUmVxdWVzdCwKICAgICAgICAgICAgICBzZXJ2aWNlLmFwaS5zaWduaW5nTmFtZSB8fCBzZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzaWduYXR1cmVDYWNoZTogc2VydmljZS5jb25maWcuc2lnbmF0dXJlQ2FjaGUsCiAgICAgICAgICAgICAgICBvcGVyYXRpb246IG9wZXJhdGlvbiwKICAgICAgICAgICAgICAgIHNpZ25hdHVyZVZlcnNpb246IHNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2lnbmVyLnNldFNlcnZpY2VDbGllbnRJZChzZXJ2aWNlLl9jbGllbnRJZCk7CiAgCiAgICAgICAgICAgIC8vIGNsZWFyIG9sZCBhdXRob3JpemF0aW9uIGhlYWRlcnMKICAgICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ107CiAgICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snRGF0ZSddOwogICAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICAKICAgICAgICAgICAgLy8gYWRkIG5ldyBhdXRob3JpemF0aW9uCiAgICAgICAgICAgIHNpZ25lci5hZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKTsKICAgICAgICAgICAgcmVxLnNpZ25lZEF0ID0gZGF0ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gZTsKICAgICAgICAgIH0KICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUkVTUE9OU0UnLCAndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFU1BPTlNFKHJlc3ApIHsKICAgICAgICBpZiAodGhpcy5zZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCB0aGlzKSkgewogICAgICAgICAgcmVzcC5kYXRhID0ge307CiAgICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzcC5kYXRhID0gbnVsbDsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdVbmtub3duRXJyb3InLCBtZXNzYWdlOiAnQW4gdW5rbm93biBlcnJvciBvY2N1cnJlZC4nfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1NFTkQnLCAnc2VuZCcsIGZ1bmN0aW9uIFNFTkQocmVzcCwgZG9uZSkgewogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLl9hYm9ydENhbGxiYWNrID0gZG9uZTsKICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICByZXNwLmRhdGEgPSBudWxsOwogIAogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGh0dHBSZXNwKSB7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gPSBodHRwUmVzcDsKICAgICAgICAgIHZhciBzdHJlYW0gPSByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3Quc3RyZWFtOwogICAgICAgICAgdmFyIHNlcnZpY2UgPSByZXNwLnJlcXVlc3Quc2VydmljZTsKICAgICAgICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgICAgICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbjsKICAgICAgICAgIHZhciBvcGVyYXRpb24gPSBhcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXSB8fCB7fTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdoZWFkZXJzJywgZnVuY3Rpb24gb25IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoCiAgICAgICAgICAgICAgJ2h0dHBIZWFkZXJzJywKICAgICAgICAgICAgICBbc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZV0KICAgICAgICAgICAgKTsKICAKICAgICAgICAgICAgaWYgKCFyZXNwLmh0dHBSZXNwb25zZS5zdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsgLy8gc3RyZWFtczIgQVBJIGNoZWNrCiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkZXRlY3QgZXZlbnQgc3RyZWFtcywgd2UncmUgZ29pbmcgdG8gaGF2ZSB0bwogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRoZSBzdHJlYW0gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmIChvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQgJiYgc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkpIHsKICAgICAgICAgICAgICAgICAgLy8gc2tpcCByZWFkaW5nIHRoZSBJbmNvbWluZ1N0cmVhbQogICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgCiAgICAgICAgICAgICAgICBodHRwUmVzcC5vbigncmVhZGFibGUnLCBmdW5jdGlvbiBvblJlYWRhYmxlKCkgewogICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGh0dHBSZXNwLnJlYWQoKTsKICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBsZWdhY3kgc3RyZWFtcyBBUEkKICAgICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdkYXRhJywgZnVuY3Rpb24gb25EYXRhKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEYXRhJywgW2RhdGEsIHJlc3BdKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgCiAgICAgICAgICBodHRwUmVzcC5vbignZW5kJywgZnVuY3Rpb24gb25FbmQoKSB7CiAgICAgICAgICAgIGlmICghc3RyZWFtIHx8ICFzdHJlYW0uZGlkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgJiYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkpIHsKICAgICAgICAgICAgICAgIC8vIGRvbid0IGNvbmNhdGVuYXRlIHJlc3BvbnNlIGNodW5rcyB3aGVuIHN0cmVhbWluZyBldmVudCBzdHJlYW0gZGF0YSB3aGVuIHJlc3BvbnNlIGlzIHN1Y2Nlc3NmdWwKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb25lJyk7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgZnVuY3Rpb24gcHJvZ3Jlc3MoaHR0cFJlc3ApIHsKICAgICAgICAgIGh0dHBSZXNwLm9uKCdzZW5kUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblNlbmRQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cFVwbG9hZFByb2dyZXNzJywgW3ZhbHVlLCByZXNwXSk7CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdyZWNlaXZlUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblJlY2VpdmVQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvd25sb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ1JlcXVlc3RBYm9ydGVkRXJyb3InKSB7CiAgICAgICAgICAgIHZhciBlcnJDb2RlID0gZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InID8gZXJyLmNvZGUgOiAnTmV0d29ya2luZ0Vycm9yJzsKICAgICAgICAgICAgZXJyID0gQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgICAgY29kZTogZXJyQ29kZSwKICAgICAgICAgICAgICByZWdpb246IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb24sCiAgICAgICAgICAgICAgaG9zdG5hbWU6IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNwLmVycm9yID0gZXJyOwogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBFcnJvcicsIFtyZXNwLmVycm9yLCByZXNwXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBleGVjdXRlU2VuZCgpIHsKICAgICAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgICAgIHZhciBodHRwT3B0aW9ucyA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBzdHJlYW0gPSBodHRwLmhhbmRsZVJlcXVlc3QocmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaywgZXJyb3IpOwogICAgICAgICAgICBwcm9ncmVzcyhzdHJlYW0pOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB0aW1lRGlmZiA9IChyZXNwLnJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIC0gdGhpcy5zaWduZWRBdCkgLyAxMDAwOwogICAgICAgIGlmICh0aW1lRGlmZiA+PSA2MCAqIDEwKSB7IC8vIGlmIHdlIHNpZ25lZCAxMG1pbiBhZ28sIHJlLXNpZ24KICAgICAgICAgIHRoaXMuZW1pdCgnc2lnbicsIFt0aGlzXSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgICAgICAgZWxzZSBleGVjdXRlU2VuZCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4ZWN1dGVTZW5kKCk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0hFQURFUlMnLCAnaHR0cEhlYWRlcnMnLAogICAgICAgICAgZnVuY3Rpb24gSFRUUF9IRUFERVJTKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3AsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlID0gc3RhdHVzTWVzc2FnZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzID0gaGVhZGVyczsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKCcnKTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzID0gW107CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMgPSAwOwogICAgICAgIHZhciBkYXRlSGVhZGVyID0gaGVhZGVycy5kYXRlIHx8IGhlYWRlcnMuRGF0ZTsKICAgICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICAgIGlmIChkYXRlSGVhZGVyKSB7CiAgICAgICAgICB2YXIgc2VydmVyVGltZSA9IERhdGUucGFyc2UoZGF0ZUhlYWRlcik7CiAgICAgICAgICBpZiAoc2VydmljZS5jb25maWcuY29ycmVjdENsb2NrU2tldwogICAgICAgICAgICAgICYmIHNlcnZpY2UuaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSkgewogICAgICAgICAgICBzZXJ2aWNlLmFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0RBVEEnLCAnaHR0cERhdGEnLCBmdW5jdGlvbiBIVFRQX0RBVEEoY2h1bmssIHJlc3ApIHsKICAgICAgICBpZiAoY2h1bmspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgewogICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyArPSBjaHVuay5sZW5ndGg7CiAgCiAgICAgICAgICAgIHZhciB0b3RhbCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ107CiAgICAgICAgICAgIHZhciBwcm9ncmVzcyA9IHsgbG9hZGVkOiByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcywgdG90YWw6IHRvdGFsIH07CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFtwcm9ncmVzcywgcmVzcF0pOwogICAgICAgICAgfQogIAogICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5wdXNoKEFXUy51dGlsLmJ1ZmZlci50b0J1ZmZlcihjaHVuaykpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSFRUUF9ET05FJywgJ2h0dHBEb25lJywgZnVuY3Rpb24gSFRUUF9ET05FKHJlc3ApIHsKICAgICAgICAvLyBjb252ZXJ0IGJ1ZmZlcnMgYXJyYXkgaW50byBzaW5nbGUgYnVmZmVyCiAgICAgICAgaWYgKHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgJiYgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgYm9keSA9IEFXUy51dGlsLmJ1ZmZlci5jb25jYXQocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyk7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gYm9keTsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzOwogICAgICAgIGRlbGV0ZSByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzOwogICAgICB9KTsKICAKICAgICAgYWRkKCdGSU5BTElaRV9FUlJPUicsICdyZXRyeScsIGZ1bmN0aW9uIEZJTkFMSVpFX0VSUk9SKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdGhpcy5zZXJ2aWNlLnJldHJ5YWJsZUVycm9yKHJlc3AuZXJyb3IsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSU5WQUxJREFURV9DUkVERU5USUFMUycsICdyZXRyeScsIGZ1bmN0aW9uIElOVkFMSURBVEVfQ1JFREVOVElBTFMocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIHN3aXRjaCAocmVzcC5lcnJvci5jb2RlKSB7CiAgICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6IC8vIEVDMiBvbmx5CiAgICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nOgogICAgICAgICAgY2FzZSAnRXhwaXJlZFRva2VuJzoKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgICAgICByZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuZXhwaXJlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdFWFBJUkVEX1NJR05BVFVSRScsICdyZXRyeScsIGZ1bmN0aW9uIEVYUElSRURfU0lHTkFUVVJFKHJlc3ApIHsKICAgICAgICB2YXIgZXJyID0gcmVzcC5lcnJvcjsKICAgICAgICBpZiAoIWVycikgcmV0dXJuOwogICAgICAgIGlmICh0eXBlb2YgZXJyLmNvZGUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmIChlcnIuY29kZS5tYXRjaCgvU2lnbmF0dXJlLykgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL2V4cGlyZWQvKSkgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdDTE9DS19TS0VXRUQnLCAncmV0cnknLCBmdW5jdGlvbiBDTE9DS19TS0VXRUQocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIGlmICh0aGlzLnNlcnZpY2UuY2xvY2tTa2V3RXJyb3IocmVzcC5lcnJvcikKICAgICAgICAgICAgJiYgdGhpcy5zZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3KSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRURJUkVDVCcsICdyZXRyeScsIGZ1bmN0aW9uIFJFRElSRUNUKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvciAmJiByZXNwLmVycm9yLnN0YXR1c0NvZGUgPj0gMzAwICYmCiAgICAgICAgICAgIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA8IDQwMCAmJiByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKSB7CiAgICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50ID0KICAgICAgICAgICAgbmV3IEFXUy5FbmRwb2ludChyZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKTsKICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gdGhpcy5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0OwogICAgICAgICAgcmVzcC5lcnJvci5yZWRpcmVjdCA9IHRydWU7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uIFJFVFJZX0NIRUNLKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gMDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcC5yZXRyeUNvdW50IDwgcmVzcC5tYXhSZXRyaWVzKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9IHRoaXMuc2VydmljZS5yZXRyeURlbGF5cyhyZXNwLnJldHJ5Q291bnQpIHx8IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1JFU0VUX1JFVFJZX1NUQVRFJywgJ2FmdGVyUmV0cnknLCBmdW5jdGlvbiBSRVNFVF9SRVRSWV9TVEFURShyZXNwLCBkb25lKSB7CiAgICAgICAgdmFyIGRlbGF5LCB3aWxsUmV0cnkgPSBmYWxzZTsKICAKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgZGVsYXkgPSByZXNwLmVycm9yLnJldHJ5RGVsYXkgfHwgMDsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSAmJiByZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgICAgcmVzcC5yZXRyeUNvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5yZWRpcmVjdENvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIGlmICh3aWxsUmV0cnkpIHsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgICAgc2V0VGltZW91dChkb25lLCBkZWxheSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSksCiAgCiAgICBDb3JlUG9zdDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RGF0YScsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RXJyb3InLCBBV1MudXRpbC5leHRyYWN0UmVxdWVzdElkKTsKICAKICAgICAgYWRkKCdFTk9URk9VTkRfRVJST1InLCAnaHR0cEVycm9yJywgZnVuY3Rpb24gRU5PVEZPVU5EX0VSUk9SKGVycikgewogICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcicgJiYgZXJyLmVycm5vID09PSAnRU5PVEZPVU5EJykgewogICAgICAgICAgdmFyIG1lc3NhZ2UgPSAnSW5hY2Nlc3NpYmxlIGhvc3Q6IGAnICsgZXJyLmhvc3RuYW1lICsKICAgICAgICAgICAgJ1wnLiBUaGlzIHNlcnZpY2UgbWF5IG5vdCBiZSBhdmFpbGFibGUgaW4gdGhlIGAnICsgZXJyLnJlZ2lvbiArCiAgICAgICAgICAgICdcJyByZWdpb24uJzsKICAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHsKICAgICAgICAgICAgY29kZTogJ1Vua25vd25FbmRwb2ludCcsCiAgICAgICAgICAgIHJlZ2lvbjogZXJyLnJlZ2lvbiwKICAgICAgICAgICAgaG9zdG5hbWU6IGVyci5ob3N0bmFtZSwKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlLAogICAgICAgICAgICBvcmlnaW5hbEVycm9yOiBlcnIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIExvZ2dlcjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0xPR19SRVFVRVNUJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gTE9HX1JFUVVFU1QocmVzcCkgewogICAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgICAgdmFyIGxvZ2dlciA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5sb2dnZXI7CiAgICAgICAgaWYgKCFsb2dnZXIpIHJldHVybjsKICAgICAgICBmdW5jdGlvbiBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZSwgc2hhcGUpIHsKICAgICAgICAgIGlmICghc2hhcGUpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChpbnB1dFNoYXBlLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgICAgICB2YXIgc3RydWN0ID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGVOYW1lLCBzdWJTaGFwZSkgewogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpbnB1dFNoYXBlLm1lbWJlcnMsIHN1YlNoYXBlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS5tZW1iZXJzW3N1YlNoYXBlTmFtZV0sIHN1YlNoYXBlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHN0cnVjdFtzdWJTaGFwZU5hbWVdID0gc3ViU2hhcGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cnVjdDsKICAgICAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2hhcGUsIGZ1bmN0aW9uKHN1YlNoYXBlLCBpbmRleCkgewogICAgICAgICAgICAgICAgbGlzdC5wdXNoKGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlciwgc3ViU2hhcGUpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgY2FzZSAnbWFwJzoKICAgICAgICAgICAgICB2YXIgbWFwID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgbWFwW2tleV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKGlucHV0U2hhcGUuaXNTZW5zaXRpdmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnKioqU2Vuc2l0aXZlSW5mb3JtYXRpb24qKionOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBidWlsZE1lc3NhZ2UoKSB7CiAgICAgICAgICB2YXIgdGltZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgdmFyIGRlbHRhID0gKHRpbWUgLSByZXEuc3RhcnRUaW1lLmdldFRpbWUoKSkgLyAxMDAwOwogICAgICAgICAgdmFyIGFuc2kgPSBsb2dnZXIuaXNUVFkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICB2YXIgc3RhdHVzID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIHZhciBjZW5zb3JlZFBhcmFtcyA9IHJlcS5wYXJhbXM7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zICYmCiAgICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXSAmJgogICAgICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQKICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgaW5wdXRTaGFwZSA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICAgICAgICBjZW5zb3JlZFBhcmFtcyA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCByZXEucGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJhbXMgPSByZXF1aXJlKCd1dGlsJykuaW5zcGVjdChjZW5zb3JlZFBhcmFtcywgdHJ1ZSwgbnVsbCk7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICcnOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMzNtJzsKICAgICAgICAgIG1lc3NhZ2UgKz0gJ1tBV1MgJyArIHJlcS5zZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyICsgJyAnICsgc3RhdHVzOwogICAgICAgICAgbWVzc2FnZSArPSAnICcgKyBkZWx0YS50b1N0cmluZygpICsgJ3MgJyArIHJlc3AucmV0cnlDb3VudCArICcgcmV0cmllc10nOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMDsxbSc7CiAgICAgICAgICBtZXNzYWdlICs9ICcgJyArIEFXUy51dGlsLnN0cmluZy5sb3dlckZpcnN0KHJlcS5vcGVyYXRpb24pOwogICAgICAgICAgbWVzc2FnZSArPSAnKCcgKyBwYXJhbXMgKyAnKSc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswbSc7CiAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICB9CiAgCiAgICAgICAgdmFyIGxpbmUgPSBidWlsZE1lc3NhZ2UoKTsKICAgICAgICBpZiAodHlwZW9mIGxvZ2dlci5sb2cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvZ2dlci5sb2cobGluZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbG9nZ2VyLndyaXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBsb2dnZXIud3JpdGUobGluZSArICdcbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBSZXN0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUmVzdEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFJlc3RYbWw6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUXVlcnk6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pCiAgfTsKICAKICB9LHsiLi9jb3JlIjoxOCwiLi9kaXNjb3Zlcl9lbmRwb2ludCI6MjYsIi4vcHJvdG9jb2wvanNvbiI6NDYsIi4vcHJvdG9jb2wvcXVlcnkiOjQ3LCIuL3Byb3RvY29sL3Jlc3QiOjQ4LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NDksIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUwLCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjU4LCJ1dGlsIjo5N31dLDM0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIFRoZSBlbmRwb2ludCB0aGF0IGEgc2VydmljZSB3aWxsIHRhbGsgdG8sIGZvciBleGFtcGxlLAogICAqIGAnaHR0cHM6Ly9lYzIuYXAtc291dGhlYXN0LTEuYW1hem9uYXdzLmNvbSdgLiBJZgogICAqIHlvdSBuZWVkIHRvIG92ZXJyaWRlIGFuIGVuZHBvaW50IGZvciBhIHNlcnZpY2UsIHlvdSBjYW4KICAgKiBzZXQgdGhlIGVuZHBvaW50IG9uIGEgc2VydmljZSBieSBwYXNzaW5nIHRoZSBlbmRwb2ludAogICAqIG9iamVjdCB3aXRoIHRoZSBgZW5kcG9pbnRgIG9wdGlvbiBrZXk6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGVwID0gbmV3IEFXUy5FbmRwb2ludCgnYXdzcHJveHkuZXhhbXBsZS5jb20nKTsKICAgKiB2YXIgczMgPSBuZXcgQVdTLlMzKHtlbmRwb2ludDogZXB9KTsKICAgKiBzMy5zZXJ2aWNlLmVuZHBvaW50Lmhvc3RuYW1lID09ICdhd3Nwcm94eS5leGFtcGxlLmNvbScKICAgKiBgYGAKICAgKgogICAqIE5vdGUgdGhhdCBpZiB5b3UgZG8gbm90IHNwZWNpZnkgYSBwcm90b2NvbCwgdGhlIHByb3RvY29sIHdpbGwKICAgKiBiZSBzZWxlY3RlZCBiYXNlZCBvbiB5b3VyIGN1cnJlbnQge0FXUy5jb25maWd9IGNvbmZpZ3VyYXRpb24uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwcm90b2NvbAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpIG9mIHRoZSBlbmRwb2ludAogICAqICAgICBVUkwKICAgKiBAIWF0dHJpYnV0ZSBob3N0bmFtZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgaG9zdCBwb3J0aW9uIG9mIHRoZSBlbmRwb2ludCwgZS5nLiwKICAgKiAgICAgZXhhbXBsZS5jb20KICAgKiBAIWF0dHJpYnV0ZSBob3N0CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50IGluY2x1ZGluZwogICAqICAgICB0aGUgcG9ydCwgZS5nLiwgZXhhbXBsZS5jb206ODAKICAgKiBAIWF0dHJpYnV0ZSBwb3J0CiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgcG9ydCBvZiB0aGUgZW5kcG9pbnQKICAgKiBAIWF0dHJpYnV0ZSBocmVmCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBmdWxsIFVSTCBvZiB0aGUgZW5kcG9pbnQKICAgKi8KICBBV1MuRW5kcG9pbnQgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIEVuZHBvaW50KGVuZHBvaW50KQogICAgICogICBDb25zdHJ1Y3RzIGEgbmV3IGVuZHBvaW50IGdpdmVuIGFuIGVuZHBvaW50IFVSTC4gSWYgdGhlCiAgICAgKiAgIFVSTCBvbWl0cyBhIHByb3RvY29sIChodHRwIG9yIGh0dHBzKSwgdGhlIGRlZmF1bHQgcHJvdG9jb2wKICAgICAqICAgc2V0IGluIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IHdpbGwgYmUgdXNlZC4KICAgICAqICAgQHBhcmFtIGVuZHBvaW50IFtTdHJpbmddIHRoZSBVUkwgdG8gY29uc3RydWN0IGFuIGVuZHBvaW50IGZyb20KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEVuZHBvaW50KGVuZHBvaW50LCBjb25maWcpIHsKICAgICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzbGFzaGVzJywgJ2F1dGgnLCAnaGFzaCcsICdzZWFyY2gnLCAncXVlcnknXSk7CiAgCiAgICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgPT09ICd1bmRlZmluZWQnIHx8IGVuZHBvaW50ID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGVuZHBvaW50OiAnICsgZW5kcG9pbnQpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gQVdTLnV0aWwuY29weShlbmRwb2ludCk7CiAgICAgIH0KICAKICAgICAgaWYgKCFlbmRwb2ludC5tYXRjaCgvXmh0dHAvKSkgewogICAgICAgIHZhciB1c2VTU0wgPSBjb25maWcgJiYgY29uZmlnLnNzbEVuYWJsZWQgIT09IHVuZGVmaW5lZCA/CiAgICAgICAgICBjb25maWcuc3NsRW5hYmxlZCA6IEFXUy5jb25maWcuc3NsRW5hYmxlZDsKICAgICAgICBlbmRwb2ludCA9ICh1c2VTU0wgPyAnaHR0cHMnIDogJ2h0dHAnKSArICc6Ly8nICsgZW5kcG9pbnQ7CiAgICAgIH0KICAKICAgICAgQVdTLnV0aWwudXBkYXRlKHRoaXMsIEFXUy51dGlsLnVybFBhcnNlKGVuZHBvaW50KSk7CiAgCiAgICAgIC8vIEVuc3VyZSB0aGUgcG9ydCBwcm9wZXJ0eSBpcyBzZXQgYXMgYW4gaW50ZWdlcgogICAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgICAgdGhpcy5wb3J0ID0gcGFyc2VJbnQodGhpcy5wb3J0LCAxMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyA0NDMgOiA4MDsKICAgICAgfQogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXF1ZXN0IG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICAgKiBhbmQgYm9keSBkYXRhIHNlbnQgYnkgYSBzZXJ2aWNlIHJlcXVlc3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtZXRob2QKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEhUVFAgbWV0aG9kIG9mIHRoZSByZXF1ZXN0CiAgICogQCFhdHRyaWJ1dGUgcGF0aAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcGF0aCBwb3J0aW9uIG9mIHRoZSBVUkksIGUuZy4sCiAgICogICAgICIvbGlzdC8/c3RhcnQ9NSZudW09MTAiCiAgICogQCFhdHRyaWJ1dGUgaGVhZGVycwogICAqICAgQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XQogICAqICAgICBhIG1hcCBvZiBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXF1ZXN0IGJvZHkgcGF5bG9hZAogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50CiAgICogICBAcmV0dXJuIFtBV1MuRW5kcG9pbnRdIHRoZSBlbmRwb2ludCBmb3IgdGhlIHJlcXVlc3QKICAgKiBAIWF0dHJpYnV0ZSByZWdpb24KICAgKiAgIEBhcGkgcHJpdmF0ZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVnaW9uLCBmb3Igc2lnbmluZyBwdXJwb3NlcyBvbmx5LgogICAqLwogIEFXUy5IdHRwUmVxdWVzdCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pIHsKICAgICAgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgdGhpcy5tZXRob2QgPSAnUE9TVCc7CiAgICAgIHRoaXMucGF0aCA9IGVuZHBvaW50LnBhdGggfHwgJy8nOwogICAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgICAgdGhpcy5ib2R5ID0gJyc7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludDsKICAgICAgdGhpcy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuX3VzZXJBZ2VudCA9ICcnOwogICAgICB0aGlzLnNldFVzZXJBZ2VudCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldFVzZXJBZ2VudDogZnVuY3Rpb24gc2V0VXNlckFnZW50KCkgewogICAgICB0aGlzLl91c2VyQWdlbnQgPSB0aGlzLmhlYWRlcnNbdGhpcy5nZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCldID0gQVdTLnV0aWwudXNlckFnZW50KCk7CiAgICB9LAogIAogICAgZ2V0VXNlckFnZW50SGVhZGVyTmFtZTogZnVuY3Rpb24gZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpIHsKICAgICAgdmFyIHByZWZpeCA9IEFXUy51dGlsLmlzQnJvd3NlcigpID8gJ1gtQW16LScgOiAnJzsKICAgICAgcmV0dXJuIHByZWZpeCArICdVc2VyLUFnZW50JzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcHBlbmRUb1VzZXJBZ2VudDogZnVuY3Rpb24gYXBwZW5kVG9Vc2VyQWdlbnQoYWdlbnRQYXJ0aWFsKSB7CiAgICAgIGlmICh0eXBlb2YgYWdlbnRQYXJ0aWFsID09PSAnc3RyaW5nJyAmJiBhZ2VudFBhcnRpYWwpIHsKICAgICAgICB0aGlzLl91c2VyQWdlbnQgKz0gJyAnICsgYWdlbnRQYXJ0aWFsOwogICAgICB9CiAgICAgIHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0VXNlckFnZW50OiBmdW5jdGlvbiBnZXRVc2VyQWdlbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXJ0IG9mIHRoZSB7cGF0aH0gZXhjbHVkaW5nIHRoZQogICAgICogICBxdWVyeSBzdHJpbmcKICAgICAqLwogICAgcGF0aG5hbWU6IGZ1bmN0aW9uIHBhdGhuYW1lKCkgewogICAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCc/JywgMSlbMF07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBxdWVyeSBzdHJpbmcgcG9ydGlvbiBvZiB0aGUge3BhdGh9CiAgICAgKi8KICAgIHNlYXJjaDogZnVuY3Rpb24gc2VhcmNoKCkgewogICAgICB2YXIgcXVlcnkgPSB0aGlzLnBhdGguc3BsaXQoJz8nLCAyKVsxXTsKICAgICAgaWYgKHF1ZXJ5KSB7CiAgICAgICAgcXVlcnkgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHF1ZXJ5KTsKICAgICAgICByZXR1cm4gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeSk7CiAgICAgIH0KICAgICAgcmV0dXJuICcnOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiB1cGRhdGUgaHR0cFJlcXVlc3QgZW5kcG9pbnQgd2l0aCBlbmRwb2ludCBzdHJpbmcKICAgICAqLwogICAgdXBkYXRlRW5kcG9pbnQ6IGZ1bmN0aW9uIHVwZGF0ZUVuZHBvaW50KGVuZHBvaW50U3RyKSB7CiAgICAgIHZhciBuZXdFbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnRTdHIpOwogICAgICB0aGlzLmVuZHBvaW50ID0gbmV3RW5kcG9pbnQ7CiAgICAgIHRoaXMucGF0aCA9IG5ld0VuZHBvaW50LnBhdGggfHwgJy8nOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXNwb25zZSBvYmplY3QsIGVuY2Fwc3VsYXRpbmcgYWxsIEhUVFAgaGVhZGVyCiAgICogYW5kIGJvZHkgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RhdHVzQ29kZQogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIEhUVFAgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3BvbnNlIChlLmcuLCAyMDAsIDQwNCkKICAgKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAgICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAgICogICAgICBhIG1hcCBvZiByZXNwb25zZSBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXNwb25zZSBib2R5IHBheWxvYWQKICAgKiBAIWF0dHJpYnV0ZSBbcl0gc3RyZWFtaW5nCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoaXMgcmVzcG9uc2UgaXMgYmVpbmcgc3RyZWFtZWQgYXQgYSBsb3ctbGV2ZWwuCiAgICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAgKGJ1ZmZlcmVkIHJlYWRzKS4gRG8gbm90IG1vZGlmeSB0aGlzIG1hbnVhbGx5LCB1c2UKICAgKiAgICAge2NyZWF0ZVVuYnVmZmVyZWRTdHJlYW19IHRvIGNvbnZlcnQgdGhlIHN0cmVhbSB0byB1bmJ1ZmZlcmVkIG1vZGUKICAgKiAgICAgaW5zdGVhZC4KICAgKi8KICBBV1MuSHR0cFJlc3BvbnNlID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlc3BvbnNlKCkgewogICAgICB0aGlzLnN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgICB0aGlzLmJvZHkgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIERpc2FibGVzIGJ1ZmZlcmluZyBvbiB0aGUgSFRUUCByZXNwb25zZSBhbmQgcmV0dXJucyB0aGUgc3RyZWFtIGZvciByZWFkaW5nLgogICAgICogQHJldHVybiBbU3RyZWFtLCBYTUxIdHRwUmVxdWVzdCwgbnVsbF0gdGhlIHVuZGVybHlpbmcgc3RyZWFtIG9iamVjdC4KICAgICAqICAgVXNlIHRoaXMgb2JqZWN0IHRvIGRpcmVjdGx5IHJlYWQgZGF0YSBvZmYgb2YgdGhlIHN0cmVhbS4KICAgICAqIEBub3RlIFRoaXMgb2JqZWN0IGlzIG9ubHkgYXZhaWxhYmxlIGFmdGVyIHRoZSB7QVdTLlJlcXVlc3R+aHR0cEhlYWRlcnN9CiAgICAgKiAgIGV2ZW50IGhhcyBmaXJlZC4gVGhpcyBtZXRob2QgbXVzdCBiZSBjYWxsZWQgcHJpb3IgdG8KICAgICAqICAge0FXUy5SZXF1ZXN0fmh0dHBEYXRhfS4KICAgICAqIEBleGFtcGxlIFRha2luZyBjb250cm9sIG9mIGEgc3RyZWFtCiAgICAgKiAgIHJlcXVlc3Qub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24oc3RhdHVzQ29kZSwgaGVhZGVycykgewogICAgICogICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgKiAgICAgICBpZiAoaGVhZGVycy5ldGFnID09PSAneHl6JykgewogICAgICogICAgICAgICAvLyBwaXBlIHRoZSBzdHJlYW0sIGRpc2FibGluZyBidWZmZXJpbmcKICAgICAqICAgICAgICAgdmFyIHN0cmVhbSA9IHRoaXMucmVzcG9uc2UuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAgICAqICAgICAgICAgc3RyZWFtLnBpcGUocHJvY2Vzcy5zdGRvdXQpOwogICAgICogICAgICAgfSBlbHNlIHsgLy8gYWJvcnQgdGhpcyByZXF1ZXN0IGFuZCBzZXQgYSBiZXR0ZXIgZXJyb3IgbWVzc2FnZQogICAgICogICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgKiAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBuZXcgRXJyb3IoJ0ludmFsaWQgRVRhZycpOwogICAgICogICAgICAgfQogICAgICogICAgIH0KICAgICAqICAgfSkuc2VuZChjb25zb2xlLmxvZyk7CiAgICAgKi8KICAgIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKSB7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuc3RyZWFtOwogICAgfQogIH0pOwogIAogIAogIEFXUy5IdHRwQ2xpZW50ID0gaW5oZXJpdCh7fSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbiBnZXRJbnN0YW5jZSgpIHsKICAgIGlmICh0aGlzLnNpbmdsZXRvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMuc2luZ2xldG9uID0gbmV3IHRoaXMoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnNpbmdsZXRvbjsKICB9OwogIAogIH0seyIuL2NvcmUiOjE4fV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKICByZXF1aXJlKCcuLi9odHRwJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlhIUkNsaWVudCA9IEFXUy51dGlsLmluaGVyaXQoewogICAgaGFuZGxlUmVxdWVzdDogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGNhbGxiYWNrLCBlcnJDYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBlbmRwb2ludCA9IGh0dHBSZXF1ZXN0LmVuZHBvaW50OwogICAgICB2YXIgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKICAgICAgdmFyIGhyZWYgPSBlbmRwb2ludC5wcm90b2NvbCArICcvLycgKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgICAgaWYgKGVuZHBvaW50LnBvcnQgIT09IDgwICYmIGVuZHBvaW50LnBvcnQgIT09IDQ0MykgewogICAgICAgIGhyZWYgKz0gJzonICsgZW5kcG9pbnQucG9ydDsKICAgICAgfQogICAgICBocmVmICs9IGh0dHBSZXF1ZXN0LnBhdGg7CiAgCiAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKSwgaGVhZGVyc0VtaXR0ZWQgPSBmYWxzZTsKICAgICAgaHR0cFJlcXVlc3Quc3RyZWFtID0geGhyOwogIAogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMCkgcmV0dXJuOyAvLyAwIGNvZGUgaXMgaW52YWxpZAogICAgICAgIH0gY2F0Y2ggKGUpIHsgcmV0dXJuOyB9CiAgCiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA+PSB0aGlzLkhFQURFUlNfUkVDRUlWRUQgJiYgIWhlYWRlcnNFbWl0dGVkKSB7CiAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUgPSB4aHIuc3RhdHVzOwogICAgICAgICAgZW1pdHRlci5oZWFkZXJzID0gc2VsZi5wYXJzZUhlYWRlcnMoeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKTsKICAgICAgICAgIGVtaXR0ZXIuZW1pdCgKICAgICAgICAgICAgJ2hlYWRlcnMnLAogICAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUsCiAgICAgICAgICAgIGVtaXR0ZXIuaGVhZGVycywKICAgICAgICAgICAgeGhyLnN0YXR1c1RleHQKICAgICAgICAgICk7CiAgICAgICAgICBoZWFkZXJzRW1pdHRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IHRoaXMuRE9ORSkgewogICAgICAgICAgc2VsZi5maW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcik7CiAgICAgICAgfQogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgZW1pdHRlci5lbWl0KCdzZW5kUHJvZ3Jlc3MnLCBldnQpOwogICAgICB9KTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgIGVtaXR0ZXIuZW1pdCgncmVjZWl2ZVByb2dyZXNzJywgZXZ0KTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigndGltZW91dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1RpbWVvdXQnKSwge2NvZGU6ICdUaW1lb3V0RXJyb3InfSkpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ05ldHdvcmsgRmFpbHVyZScpLCB7CiAgICAgICAgICBjb2RlOiAnTmV0d29ya2luZ0Vycm9yJwogICAgICAgIH0pKTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQnKSwgewogICAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InCiAgICAgICAgfSkpOwogICAgICB9LCBmYWxzZSk7CiAgCiAgICAgIGNhbGxiYWNrKGVtaXR0ZXIpOwogICAgICB4aHIub3BlbihodHRwUmVxdWVzdC5tZXRob2QsIGhyZWYsIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSk7CiAgICAgIEFXUy51dGlsLmVhY2goaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ICE9PSAnQ29udGVudC1MZW5ndGgnICYmIGtleSAhPT0gJ1VzZXItQWdlbnQnICYmIGtleSAhPT0gJ0hvc3QnKSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBpZiAoaHR0cE9wdGlvbnMudGltZW91dCAmJiBodHRwT3B0aW9ucy54aHJBc3luYyAhPT0gZmFsc2UpIHsKICAgICAgICB4aHIudGltZW91dCA9IGh0dHBPcHRpb25zLnRpbWVvdXQ7CiAgICAgIH0KICAKICAgICAgaWYgKGh0dHBPcHRpb25zLnhocldpdGhDcmVkZW50aWFscykgewogICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICB9CiAgICAgIHRyeSB7IHhoci5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInOyB9IGNhdGNoIChlKSB7fQogIAogICAgICB0cnkgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5KSB7CiAgICAgICAgICB4aHIuc2VuZChodHRwUmVxdWVzdC5ib2R5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGhyLnNlbmQoKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5ICYmIHR5cGVvZiBodHRwUmVxdWVzdC5ib2R5LmJ1ZmZlciA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyKTsgLy8gc2VuZCBBcnJheUJ1ZmZlciBkaXJlY3RseQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiBlbWl0dGVyOwogICAgfSwKICAKICAgIHBhcnNlSGVhZGVyczogZnVuY3Rpb24gcGFyc2VIZWFkZXJzKHJhd0hlYWRlcnMpIHsKICAgICAgdmFyIGhlYWRlcnMgPSB7fTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJhd0hlYWRlcnMuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIGtleSA9IGxpbmUuc3BsaXQoJzonLCAxKVswXTsKICAgICAgICB2YXIgdmFsdWUgPSBsaW5lLnN1YnN0cmluZyhrZXkubGVuZ3RoICsgMik7CiAgICAgICAgaWYgKGtleS5sZW5ndGggPiAwKSBoZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpXSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9LAogIAogICAgZmluaXNoUmVxdWVzdDogZnVuY3Rpb24gZmluaXNoUmVxdWVzdCh4aHIsIGVtaXR0ZXIpIHsKICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgaWYgKHhoci5yZXNwb25zZVR5cGUgPT09ICdhcnJheWJ1ZmZlcicgJiYgeGhyLnJlc3BvbnNlKSB7CiAgICAgICAgdmFyIGFiID0geGhyLnJlc3BvbnNlOwogICAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoYWIuYnl0ZUxlbmd0aCk7CiAgICAgICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShhYik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGJ1ZmZlcltpXSA9IHZpZXdbaV07CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKCFidWZmZXIgJiYgdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBidWZmZXIgPSBuZXcgQVdTLnV0aWwuQnVmZmVyKHhoci5yZXNwb25zZVRleHQpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAKICAgICAgaWYgKGJ1ZmZlcikgZW1pdHRlci5lbWl0KCdkYXRhJywgYnVmZmVyKTsKICAgICAgZW1pdHRlci5lbWl0KCdlbmQnKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5wcm90b3R5cGUgPSBBV1MuWEhSQ2xpZW50LnByb3RvdHlwZTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9IDE7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi9odHRwIjozNCwiZXZlbnRzIjo4Mn1dLDM2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uQnVpbGRlcigpIHsgfQogIAogIEpzb25CdWlsZGVyLnByb3RvdHlwZS5idWlsZCA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHV0aWwuZWFjaChzdHJ1Y3R1cmUsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZSkgewogICAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W2xvY2F0aW9uTmFtZV0gPSByZXN1bHQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHN0cnVjdDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogICAgdmFyIG91dCA9IFtdOwogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXQucHVzaChyZXN1bHQpOwogICAgfSk7CiAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVNYXAobWFwLCBzaGFwZSkgewogICAgdmFyIG91dCA9IHt9OwogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25CdWlsZGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uUGFyc2VyKCkgeyB9CiAgCiAgSnNvblBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiB0cmFuc2xhdGUoSlNPTi5wYXJzZSh2YWx1ZSksIHNoYXBlKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIGlmIChzdHJ1Y3R1cmUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHZhciBzaGFwZU1lbWJlcnMgPSBzaGFwZS5tZW1iZXJzOwogICAgdXRpbC5lYWNoKHNoYXBlTWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3RydWN0dXJlLCBsb2NhdGlvbk5hbWUpKSB7CiAgICAgICAgdmFyIHZhbHVlID0gc3RydWN0dXJlW2xvY2F0aW9uTmFtZV07CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W25hbWVdID0gcmVzdWx0OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBzdHJ1Y3Q7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZUxpc3QobGlzdCwgc2hhcGUpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0gW107CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dC5wdXNoKG51bGwpOwogICAgICBlbHNlIG91dC5wdXNoKHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgICBpZiAobWFwID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0ge307CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IG51bGw7CiAgICAgIGVsc2Ugb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1R5cGUodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25QYXJzZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sMzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7CiAgdmFyIE9wZXJhdGlvbiA9IHJlcXVpcmUoJy4vb3BlcmF0aW9uJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi9zaGFwZScpOwogIHZhciBQYWdpbmF0b3IgPSByZXF1aXJlKCcuL3BhZ2luYXRvcicpOwogIHZhciBSZXNvdXJjZVdhaXRlciA9IHJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBBcGkoYXBpLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBhcGkgPSBhcGkgfHwge307CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIG9wdGlvbnMuYXBpID0gdGhpczsKICAKICAgIGFwaS5tZXRhZGF0YSA9IGFwaS5tZXRhZGF0YSB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdpc0FwaScsIHRydWUsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGlWZXJzaW9uJywgYXBpLm1ldGFkYXRhLmFwaVZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50UHJlZml4JywgYXBpLm1ldGFkYXRhLmVuZHBvaW50UHJlZml4KTsKICAgIHByb3BlcnR5KHRoaXMsICdzaWduaW5nTmFtZScsIGFwaS5tZXRhZGF0YS5zaWduaW5nTmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZ2xvYmFsRW5kcG9pbnQnLCBhcGkubWV0YWRhdGEuZ2xvYmFsRW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ3NpZ25hdHVyZVZlcnNpb24nLCBhcGkubWV0YWRhdGEuc2lnbmF0dXJlVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnanNvblZlcnNpb24nLCBhcGkubWV0YWRhdGEuanNvblZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ3RhcmdldFByZWZpeCcsIGFwaS5tZXRhZGF0YS50YXJnZXRQcmVmaXgpOwogICAgcHJvcGVydHkodGhpcywgJ3Byb3RvY29sJywgYXBpLm1ldGFkYXRhLnByb3RvY29sKTsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBhcGkubWV0YWRhdGEudGltZXN0YW1wRm9ybWF0KTsKICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBhcGkubWV0YWRhdGEueG1sTmFtZXNwYWNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhYmJyZXZpYXRpb24nLCBhcGkubWV0YWRhdGEuc2VydmljZUFiYnJldmlhdGlvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZnVsbE5hbWUnLCBhcGkubWV0YWRhdGEuc2VydmljZUZ1bGxOYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdzZXJ2aWNlSWQnLCBhcGkubWV0YWRhdGEuc2VydmljZUlkKTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2NsYXNzTmFtZScsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbmFtZSA9IGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uIHx8IGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWU7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIG51bGw7CiAgCiAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL15BbWF6b258QVdTXHMqfFwoLip8XHMrfFxXKy9nLCAnJyk7CiAgICAgIGlmIChuYW1lID09PSAnRWxhc3RpY0xvYWRCYWxhbmNpbmcnKSBuYW1lID0gJ0VMQic7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSk7CiAgCiAgICBmdW5jdGlvbiBhZGRFbmRwb2ludE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgaWYgKG9wZXJhdGlvbi5lbmRwb2ludG9wZXJhdGlvbiA9PT0gdHJ1ZSkgewogICAgICAgIHByb3BlcnR5KHNlbGYsICdlbmRwb2ludE9wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QobmFtZSkpOwogICAgICB9CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnb3BlcmF0aW9ucycsIG5ldyBDb2xsZWN0aW9uKGFwaS5vcGVyYXRpb25zLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgcmV0dXJuIG5ldyBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKTsKICAgIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QsIGFkZEVuZHBvaW50T3BlcmF0aW9uKSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGVzJywgbmV3IENvbGxlY3Rpb24oYXBpLnNoYXBlcywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgc2hhcGUpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZSwgb3B0aW9ucyk7CiAgICB9KSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9ycycsIG5ldyBDb2xsZWN0aW9uKGFwaS5wYWdpbmF0b3JzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBwYWdpbmF0b3IpIHsKICAgICAgcmV0dXJuIG5ldyBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yLCBvcHRpb25zKTsKICAgIH0pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICd3YWl0ZXJzJywgbmV3IENvbGxlY3Rpb24oYXBpLndhaXRlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHdhaXRlcikgewogICAgICByZXR1cm4gbmV3IFJlc291cmNlV2FpdGVyKG5hbWUsIHdhaXRlciwgb3B0aW9ucyk7CiAgICB9LCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgYXBpLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIGFwaS5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBcGk7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL2NvbGxlY3Rpb24iOjM5LCIuL29wZXJhdGlvbiI6NDAsIi4vcGFnaW5hdG9yIjo0MSwiLi9yZXNvdXJjZV93YWl0ZXIiOjQyLCIuL3NoYXBlIjo0M31dLDM5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIG1lbW9pemUobmFtZSwgdmFsdWUsIGZhY3RvcnksIG5hbWVUcikgewogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCBuYW1lVHIobmFtZSksIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZSk7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gQ29sbGVjdGlvbihpdGVyYWJsZSwgb3B0aW9ucywgZmFjdG9yeSwgbmFtZVRyLCBjYWxsYmFjaykgewogICAgbmFtZVRyID0gbmFtZVRyIHx8IFN0cmluZzsKICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgIGZvciAodmFyIGlkIGluIGl0ZXJhYmxlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGlkKSkgewogICAgICAgIG1lbW9pemUuY2FsbChzZWxmLCBpZCwgaXRlcmFibGVbaWRdLCBmYWN0b3J5LCBuYW1lVHIpOwogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soaWQsIGl0ZXJhYmxlW2lkXSk7CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgb3BlcmF0aW9uLm5hbWUgfHwgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIG9wZXJhdGlvbi5odHRwID0gb3BlcmF0aW9uLmh0dHAgfHwge307CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnQnLCBvcGVyYXRpb24uZW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ2h0dHBNZXRob2QnLCBvcGVyYXRpb24uaHR0cC5tZXRob2QgfHwgJ1BPU1QnKTsKICAgIHByb3BlcnR5KHRoaXMsICdodHRwUGF0aCcsIG9wZXJhdGlvbi5odHRwLnJlcXVlc3RVcmkgfHwgJy8nKTsKICAgIHByb3BlcnR5KHRoaXMsICdhdXRodHlwZScsIG9wZXJhdGlvbi5hdXRodHlwZSB8fCAnJyk7CiAgICBwcm9wZXJ0eSgKICAgICAgdGhpcywKICAgICAgJ2VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQnLAogICAgICBvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkgPwogICAgICAgIChvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkucmVxdWlyZWQgPyAnUkVRVUlSRUQnIDogJ09QVElPTkFMJykgOgogICAgICAnTlVMTCcKICAgICk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdpbnB1dCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIW9wZXJhdGlvbi5pbnB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmlucHV0LCBvcHRpb25zKTsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnb3V0cHV0JywgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghb3BlcmF0aW9uLm91dHB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLm91dHB1dCwgb3B0aW9ucyk7CiAgICB9KTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2Vycm9ycycsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGlzdCA9IFtdOwogICAgICBpZiAoIW9wZXJhdGlvbi5lcnJvcnMpIHJldHVybiBudWxsOwogIAogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wZXJhdGlvbi5lcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsaXN0LnB1c2goU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5lcnJvcnNbaV0sIG9wdGlvbnMpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbGlzdDsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9yJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBvcHRpb25zLmFwaS5wYWdpbmF0b3JzW25hbWVdOwogICAgfSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIG9wZXJhdGlvbi5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICAKICAgIC8vIGlkZW1wb3RlbnRNZW1iZXJzIG9ubHkgdHJhY2tzIHRvcC1sZXZlbCBpbnB1dCBzaGFwZXMKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lkZW1wb3RlbnRNZW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IFtdOwogICAgICB2YXIgaW5wdXQgPSBzZWxmLmlucHV0OwogICAgICB2YXIgbWVtYmVycyA9IGlucHV0Lm1lbWJlcnM7CiAgICAgIGlmICghaW5wdXQubWVtYmVycykgewogICAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgICAgfQogICAgICBmb3IgKHZhciBuYW1lIGluIG1lbWJlcnMpIHsKICAgICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0lkZW1wb3RlbnQgPT09IHRydWUpIHsKICAgICAgICAgIGlkZW1wb3RlbnRNZW1iZXJzLnB1c2gobmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaGFzRXZlbnRPdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIG91dHB1dCA9IHNlbGYub3V0cHV0OwogICAgICByZXR1cm4gaGFzRXZlbnRTdHJlYW0ob3V0cHV0KTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBoYXNFdmVudFN0cmVhbSh0b3BMZXZlbFNoYXBlKSB7CiAgICB2YXIgbWVtYmVycyA9IHRvcExldmVsU2hhcGUubWVtYmVyczsKICAgIHZhciBwYXlsb2FkID0gdG9wTGV2ZWxTaGFwZS5wYXlsb2FkOwogIAogICAgaWYgKCF0b3BMZXZlbFNoYXBlLm1lbWJlcnMpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIAogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBtZW1iZXJzW3BheWxvYWRdOwogICAgICByZXR1cm4gcGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtOwogICAgfQogIAogICAgLy8gY2hlY2sgaWYgYW55IG1lbWJlciBpcyBhbiBldmVudCBzdHJlYW0KICAgIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0V2ZW50U3RyZWFtID09PSB0cnVlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBPcGVyYXRpb247CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL3NoYXBlIjo0M31dLDQxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcHJvcGVydHkgPSByZXF1aXJlKCcuLi91dGlsJykucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUGFnaW5hdG9yKG5hbWUsIHBhZ2luYXRvcikgewogICAgcHJvcGVydHkodGhpcywgJ2lucHV0VG9rZW4nLCBwYWdpbmF0b3IuaW5wdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ2xpbWl0S2V5JywgcGFnaW5hdG9yLmxpbWl0X2tleSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbW9yZVJlc3VsdHMnLCBwYWdpbmF0b3IubW9yZV9yZXN1bHRzKTsKICAgIHByb3BlcnR5KHRoaXMsICdvdXRwdXRUb2tlbicsIHBhZ2luYXRvci5vdXRwdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ3Jlc3VsdEtleScsIHBhZ2luYXRvci5yZXN1bHRfa2V5KTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBQYWdpbmF0b3I7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIGlmICh3YWl0ZXIub3BlcmF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb24nLCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KHdhaXRlci5vcGVyYXRpb24pKTsKICAgIH0KICAKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBrZXlzID0gWwogICAgICAndHlwZScsCiAgICAgICdkZXNjcmlwdGlvbicsCiAgICAgICdkZWxheScsCiAgICAgICdtYXhBdHRlbXB0cycsCiAgICAgICdhY2NlcHRvcnMnCiAgICBdOwogIAogICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgdmFsdWUgPSB3YWl0ZXJba2V5XTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgcHJvcGVydHkoc2VsZiwga2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFJlc291cmNlV2FpdGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwogIAogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHV0aWwucHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUpIHsKICAgIGlmICghb2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZVtuYW1lXSkgewogICAgICB1dGlsLm1lbW9pemVkUHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gU2hhcGUoc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ3NoYXBlJywgc2hhcGUuc2hhcGUpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAndHlwZScsIHNoYXBlLnR5cGUpOwogICAgcHJvcGVydHkodGhpcywgJ2VudW0nLCBzaGFwZS5lbnVtKTsKICAgIHByb3BlcnR5KHRoaXMsICdtaW4nLCBzaGFwZS5taW4pOwogICAgcHJvcGVydHkodGhpcywgJ21heCcsIHNoYXBlLm1heCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncGF0dGVybicsIHNoYXBlLnBhdHRlcm4pOwogICAgcHJvcGVydHkodGhpcywgJ2xvY2F0aW9uJywgc2hhcGUubG9jYXRpb24gfHwgdGhpcy5sb2NhdGlvbiB8fCAnYm9keScpOwogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCB0aGlzLm5hbWUgfHwgc2hhcGUueG1sTmFtZSB8fCBzaGFwZS5xdWVyeU5hbWUgfHwKICAgICAgc2hhcGUubG9jYXRpb25OYW1lIHx8IG1lbWJlck5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzU3RyZWFtaW5nJywgc2hhcGUuc3RyZWFtaW5nIHx8IHRoaXMuaXNTdHJlYW1pbmcgfHwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVzTGVuZ3RoJywgc2hhcGUucmVxdWlyZXNMZW5ndGgsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0NvbXBvc2l0ZScsIHNoYXBlLmlzQ29tcG9zaXRlIHx8IGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1NoYXBlJywgdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzUXVlcnlOYW1lJywgQm9vbGVhbihzaGFwZS5xdWVyeU5hbWUpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNMb2NhdGlvbk5hbWUnLCBCb29sZWFuKHNoYXBlLmxvY2F0aW9uTmFtZSksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0lkZW1wb3RlbnQnLCBzaGFwZS5pZGVtcG90ZW5jeVRva2VuID09PSB0cnVlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0pzb25WYWx1ZScsIHNoYXBlLmpzb252YWx1ZSA9PT0gdHJ1ZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNTZW5zaXRpdmUnLCBzaGFwZS5zZW5zaXRpdmUgPT09IHRydWUgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5zZW5zaXRpdmUgPT09IHRydWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRTdHJlYW0nLCBCb29sZWFuKHNoYXBlLmV2ZW50c3RyZWFtKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnQnLCBCb29sZWFuKHNoYXBlLmV2ZW50KSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRQYXlsb2FkJywgQm9vbGVhbihzaGFwZS5ldmVudHBheWxvYWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudEhlYWRlcicsIEJvb2xlYW4oc2hhcGUuZXZlbnRoZWFkZXIpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNUaW1lc3RhbXBGb3JtYXRTZXQnLCBCb29sZWFuKHNoYXBlLnRpbWVzdGFtcEZvcm1hdCkgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5pc1RpbWVzdGFtcEZvcm1hdFNldCA9PT0gdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50RGlzY292ZXJ5SWQnLCBCb29sZWFuKHNoYXBlLmVuZHBvaW50ZGlzY292ZXJ5aWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaG9zdExhYmVsJywgQm9vbGVhbihzaGFwZS5ob3N0TGFiZWwpLCBmYWxzZSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgc2hhcGUuZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgc2hhcGUuZG9jdW1lbnRhdGlvblVybCk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUueG1sQXR0cmlidXRlKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdpc1htbEF0dHJpYnV0ZScsIHNoYXBlLnhtbEF0dHJpYnV0ZSB8fCBmYWxzZSk7CiAgICB9CiAgCiAgICAvLyB0eXBlIGNvbnZlcnNpb24gYW5kIHBhcnNpbmcKICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBudWxsKTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS5ub3JtYWxpemVkVHlwZXMgPSB7CiAgICBjaGFyYWN0ZXI6ICdzdHJpbmcnLAogICAgZG91YmxlOiAnZmxvYXQnLAogICAgbG9uZzogJ2ludGVnZXInLAogICAgc2hvcnQ6ICdpbnRlZ2VyJywKICAgIGJpZ2ludGVnZXI6ICdpbnRlZ2VyJywKICAgIGJpZ2RlY2ltYWw6ICdmbG9hdCcsCiAgICBibG9iOiAnYmluYXJ5JwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUudHlwZXMgPSB7CiAgICAnc3RydWN0dXJlJzogU3RydWN0dXJlU2hhcGUsCiAgICAnbGlzdCc6IExpc3RTaGFwZSwKICAgICdtYXAnOiBNYXBTaGFwZSwKICAgICdib29sZWFuJzogQm9vbGVhblNoYXBlLAogICAgJ3RpbWVzdGFtcCc6IFRpbWVzdGFtcFNoYXBlLAogICAgJ2Zsb2F0JzogRmxvYXRTaGFwZSwKICAgICdpbnRlZ2VyJzogSW50ZWdlclNoYXBlLAogICAgJ3N0cmluZyc6IFN0cmluZ1NoYXBlLAogICAgJ2Jhc2U2NCc6IEJhc2U2NFNoYXBlLAogICAgJ2JpbmFyeSc6IEJpbmFyeVNoYXBlCiAgfTsKICAKICBTaGFwZS5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShzaGFwZSwgb3B0aW9ucykgewogICAgaWYgKHNoYXBlLnNoYXBlKSB7CiAgICAgIHZhciByZWZTaGFwZSA9IG9wdGlvbnMuYXBpLnNoYXBlc1tzaGFwZS5zaGFwZV07CiAgICAgIGlmICghcmVmU2hhcGUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHNoYXBlIHJlZmVyZW5jZTogJyArIHNoYXBlLnNoYXBlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gcmVmU2hhcGU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwogIAogIFNoYXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogICAgaWYgKHNoYXBlLmlzU2hhcGUpIHJldHVybiBzaGFwZTsKICAKICAgIHZhciByZWZTaGFwZSA9IFNoYXBlLnJlc29sdmUoc2hhcGUsIG9wdGlvbnMpOwogICAgaWYgKHJlZlNoYXBlKSB7CiAgICAgIHZhciBmaWx0ZXJlZEtleXMgPSBPYmplY3Qua2V5cyhzaGFwZSk7CiAgICAgIGlmICghb3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgICAgZmlsdGVyZWRLZXlzID0gZmlsdGVyZWRLZXlzLmZpbHRlcihmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICByZXR1cm4gIW5hbWUubWF0Y2goL2RvY3VtZW50YXRpb24vKTsKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICAvLyBjcmVhdGUgYW4gaW5saW5lIHNoYXBlIHdpdGggZXh0cmEgbWVtYmVycwogICAgICB2YXIgSW5saW5lU2hhcGUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZWZTaGFwZS5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKTsKICAgICAgfTsKICAgICAgSW5saW5lU2hhcGUucHJvdG90eXBlID0gcmVmU2hhcGU7CiAgICAgIHJldHVybiBuZXcgSW5saW5lU2hhcGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHNldCB0eXBlIGlmIG5vdCBzZXQKICAgICAgaWYgKCFzaGFwZS50eXBlKSB7CiAgICAgICAgaWYgKHNoYXBlLm1lbWJlcnMpIHNoYXBlLnR5cGUgPSAnc3RydWN0dXJlJzsKICAgICAgICBlbHNlIGlmIChzaGFwZS5tZW1iZXIpIHNoYXBlLnR5cGUgPSAnbGlzdCc7CiAgICAgICAgZWxzZSBpZiAoc2hhcGUua2V5KSBzaGFwZS50eXBlID0gJ21hcCc7CiAgICAgICAgZWxzZSBzaGFwZS50eXBlID0gJ3N0cmluZyc7CiAgICAgIH0KICAKICAgICAgLy8gbm9ybWFsaXplIHR5cGVzCiAgICAgIHZhciBvcmlnVHlwZSA9IHNoYXBlLnR5cGU7CiAgICAgIGlmIChTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV0pIHsKICAgICAgICBzaGFwZS50eXBlID0gU2hhcGUubm9ybWFsaXplZFR5cGVzW3NoYXBlLnR5cGVdOwogICAgICB9CiAgCiAgICAgIGlmIChTaGFwZS50eXBlc1tzaGFwZS50eXBlXSkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUudHlwZXNbc2hhcGUudHlwZV0oc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIHNoYXBlIHR5cGU6ICcgKyBvcmlnVHlwZSk7CiAgICAgIH0KICAgIH0KICB9OwogIAogIGZ1bmN0aW9uIENvbXBvc2l0ZVNoYXBlKHNoYXBlKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgdHJ1ZSk7CiAgCiAgICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdmbGF0dGVuZWQnLCBzaGFwZS5mbGF0dGVuZWQgfHwgZmFsc2UpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBTdHJ1Y3R1cmVTaGFwZShzaGFwZSwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVpcmVkTWFwID0gbnVsbCwgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICAKICAgIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoZmlyc3RJbml0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIHt9OyB9KTsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCB7fSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIFtdKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgW10pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0pOwogICAgfQogIAogICAgaWYgKHNoYXBlLm1lbWJlcnMpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCBuZXcgQ29sbGVjdGlvbihzaGFwZS5tZW1iZXJzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG1lbWJlciwgb3B0aW9ucywgbmFtZSk7CiAgICAgIH0pKTsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2hhcGUueG1sT3JkZXIgfHwgT2JqZWN0LmtleXMoc2hhcGUubWVtYmVycyk7CiAgICAgIH0pOwogIAogICAgICBpZiAoc2hhcGUuZXZlbnQpIHsKICAgICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdldmVudFBheWxvYWRNZW1iZXJOYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbWVtYmVycyA9IHNlbGYubWVtYmVyczsKICAgICAgICAgIHZhciBtZW1iZXJOYW1lcyA9IHNlbGYubWVtYmVyTmFtZXM7CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgcGF5bG9hZHMKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbWVtYmVyTmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtZW1iZXJzW21lbWJlck5hbWVzW2ldXS5pc0V2ZW50UGF5bG9hZCkgewogICAgICAgICAgICAgIHJldHVybiBtZW1iZXJOYW1lc1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50SGVhZGVyTWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICAgIHZhciBldmVudEhlYWRlck1lbWJlck5hbWVzID0gW107CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgaGVhZGVycwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRIZWFkZXIpIHsKICAgICAgICAgICAgICBldmVudEhlYWRlck1lbWJlck5hbWVzLnB1c2gobWVtYmVyTmFtZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnRIZWFkZXJNZW1iZXJOYW1lczsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIAogICAgaWYgKHNoYXBlLnJlcXVpcmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlZCcsIHNoYXBlLnJlcXVpcmVkKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2lzUmVxdWlyZWQnLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgaWYgKCFyZXF1aXJlZE1hcCkgewogICAgICAgICAgcmVxdWlyZWRNYXAgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hhcGUucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVxdWlyZWRNYXBbc2hhcGUucmVxdWlyZWRbaV1dID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIHJlcXVpcmVkTWFwW25hbWVdOwogICAgICB9LCBmYWxzZSwgdHJ1ZSk7CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0V3JhcHBlcicsIHNoYXBlLnJlc3VsdFdyYXBwZXIgfHwgbnVsbCk7CiAgCiAgICBpZiAoc2hhcGUucGF5bG9hZCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAncGF5bG9hZCcsIHNoYXBlLnBheWxvYWQpOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygc2hhcGUueG1sTmFtZXNwYWNlID09PSAnb2JqZWN0JykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlUHJlZml4Jywgc2hhcGUueG1sTmFtZXNwYWNlLnByZWZpeCk7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UudXJpKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTGlzdFNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKGZpcnN0SW5pdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiBbXTsgfSk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUubWVtYmVyKSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ21lbWJlcicsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUubWVtYmVyLCBvcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgCiAgICBpZiAodGhpcy5mbGF0dGVuZWQpIHsKICAgICAgdmFyIG9sZE5hbWUgPSB0aGlzLm5hbWU7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ25hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2VsZi5tZW1iZXIubmFtZSB8fCBvbGROYW1lOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTWFwU2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIHZhciBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogICAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChmaXJzdEluaXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAna2V5JywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3ZhbHVlJywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgIH0KICAKICAgIGlmIChzaGFwZS5rZXkpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAna2V5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5rZXksIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFwZS52YWx1ZSkgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICd2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUudmFsdWUsIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gVGltZXN0YW1wU2hhcGUoc2hhcGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoc2hhcGUudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBzaGFwZS50aW1lc3RhbXBGb3JtYXQpOwogICAgfSBlbHNlIGlmIChzZWxmLmlzVGltZXN0YW1wRm9ybWF0U2V0ICYmIHRoaXMudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCB0aGlzLnRpbWVzdGFtcEZvcm1hdCk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAncmZjODIyJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdpc284NjAxJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMuYXBpKSB7CiAgICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgICBjYXNlICdqc29uJzoKICAgICAgICBjYXNlICdyZXN0LWpzb24nOgogICAgICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICd1bml4VGltZXN0YW1wJyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdyZXN0LXhtbCc6CiAgICAgICAgY2FzZSAncXVlcnknOgogICAgICAgIGNhc2UgJ2VjMic6CiAgICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZS50b1VUQ1N0cmluZyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHZhbHVlOwogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8KICAgICAgICAgICAgIHV0aWwuZGF0ZS5wYXJzZVRpbWVzdGFtcCh2YWx1ZSkgOiBudWxsOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHV0aWwuZGF0ZS5mb3JtYXQodmFsdWUsIHNlbGYudGltZXN0YW1wRm9ybWF0KTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIFN0cmluZ1NoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHZhciBudWxsTGVzc1Byb3RvY29scyA9IFsncmVzdC14bWwnLCAncXVlcnknLCAnZWMyJ107CiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdGhpcy5hcGkgJiYgbnVsbExlc3NQcm90b2NvbHMuaW5kZXhPZih0aGlzLmFwaS5wcm90b2NvbCkgPiAtMSA/CiAgICAgICAgdmFsdWUgfHwgJycgOiB2YWx1ZTsKICAgICAgaWYgKHRoaXMuaXNKc29uVmFsdWUpIHsKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZS50b1N0cmluZyA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXMuaXNKc29uVmFsdWUgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIEZsb2F0U2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlKTsKICAgIH07CiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IHRoaXMudG9UeXBlOwogIH0KICAKICBmdW5jdGlvbiBJbnRlZ2VyU2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7CiAgfQogIAogIGZ1bmN0aW9uIEJpbmFyeVNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIGJ1ZiA9IHV0aWwuYmFzZTY0LmRlY29kZSh2YWx1ZSk7CiAgICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlICYmIHV0aWwuaXNOb2RlKCkgJiYgdHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgICAvKiBOb2RlLmpzIGNhbiBjcmVhdGUgYSBCdWZmZXIgdGhhdCBpcyBub3QgaXNvbGF0ZWQuCiAgICAgKiBpLmUuIGJ1Zi5ieXRlTGVuZ3RoICE9PSBidWYuYnVmZmVyLmJ5dGVMZW5ndGgKICAgICAqIFRoaXMgbWVhbnMgdGhhdCB0aGUgc2Vuc2l0aXZlIGRhdGEgaXMgYWNjZXNzaWJsZSB0byBhbnlvbmUgd2l0aCBhY2Nlc3MgdG8gYnVmLmJ1ZmZlci4KICAgICAqIElmIHRoaXMgaXMgdGhlIG5vZGUgc2hhcmVkIEJ1ZmZlciwgdGhlbiBvdGhlciBjb2RlIHdpdGhpbiB0aGlzIHByb2Nlc3MgX2NvdWxkXyBmaW5kIHRoaXMgc2VjcmV0LgogICAgICogQ29weSBzZW5zaXRpdmUgZGF0YSB0byBhbiBpc29sYXRlZCBCdWZmZXIgYW5kIHplcm8gdGhlIHNlbnNpdGl2ZSBkYXRhLgogICAgICogV2hpbGUgdGhpcyBpcyBzYWZlIHRvIGRvIGhlcmUsIGNvcHlpbmcgdGhpcyBjb2RlIHNvbWV3aGVyZSBlbHNlIG1heSBwcm9kdWNlIHVuZXhwZWN0ZWQgcmVzdWx0cy4KICAgICAqLwogICAgICAgIHZhciBzZWN1cmVCdWYgPSB1dGlsLkJ1ZmZlci5hbGxvYyhidWYubGVuZ3RoLCBidWYpOwogICAgICAgIGJ1Zi5maWxsKDApOwogICAgICAgIGJ1ZiA9IHNlY3VyZUJ1ZjsKICAgICAgfQogICAgICByZXR1cm4gYnVmOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdXRpbC5iYXNlNjQuZW5jb2RlOwogIH0KICAKICBmdW5jdGlvbiBCYXNlNjRTaGFwZSgpIHsKICAgIEJpbmFyeVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQogIAogIGZ1bmN0aW9uIEJvb2xlYW5TaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlOwogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gJ3RydWUnOwogICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUuc2hhcGVzID0gewogICAgU3RydWN0dXJlU2hhcGU6IFN0cnVjdHVyZVNoYXBlLAogICAgTGlzdFNoYXBlOiBMaXN0U2hhcGUsCiAgICBNYXBTaGFwZTogTWFwU2hhcGUsCiAgICBTdHJpbmdTaGFwZTogU3RyaW5nU2hhcGUsCiAgICBCb29sZWFuU2hhcGU6IEJvb2xlYW5TaGFwZSwKICAgIEJhc2U2NFNoYXBlOiBCYXNlNjRTaGFwZQogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBTaGFwZTsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vY29sbGVjdGlvbiI6Mzl9XSw0NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5QYXJhbVZhbGlkYXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgdmFsaWRhdG9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUKICAgICAqICAgICB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZQogICAgICogICAgIHJlcXVlc3QuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljCiAgICAgKiAgICAgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgICAqCiAgICAgKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICAgKiAgICAgICB0byBgdHJ1ZWAuCiAgICAgKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAgICogICAgICAgY29uc3RyYWludC4KICAgICAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAgICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgICAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBQYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKSB7CiAgICAgIGlmICh2YWxpZGF0aW9uID09PSB0cnVlIHx8IHZhbGlkYXRpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhbGlkYXRpb24gPSB7J21pbic6IHRydWV9OwogICAgICB9CiAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgICB9LAogIAogICAgdmFsaWRhdGU6IGZ1bmN0aW9uIHZhbGlkYXRlKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgdGhpcy5lcnJvcnMgPSBbXTsKICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW1zIHx8IHt9LCBjb250ZXh0IHx8ICdwYXJhbXMnKTsKICAKICAgICAgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA+IDEpIHsKICAgICAgICB2YXIgbXNnID0gdGhpcy5lcnJvcnMuam9pbignXG4qICcpOwogICAgICAgIG1zZyA9ICdUaGVyZSB3ZXJlICcgKyB0aGlzLmVycm9ycy5sZW5ndGggKwogICAgICAgICAgJyB2YWxpZGF0aW9uIGVycm9yczpcbiogJyArIG1zZzsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobXNnKSwKICAgICAgICAgIHtjb2RlOiAnTXVsdGlwbGVWYWxpZGF0aW9uRXJyb3JzJywgZXJyb3JzOiB0aGlzLmVycm9yc30pOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRocm93IHRoaXMuZXJyb3JzWzBdOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9LAogIAogICAgZmFpbDogZnVuY3Rpb24gZmFpbChjb2RlLCBtZXNzYWdlKSB7CiAgICAgIHRoaXMuZXJyb3JzLnB1c2goQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpLCB7Y29kZTogY29kZX0pKTsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cnVjdHVyZTogZnVuY3Rpb24gdmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICB0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdzdHJ1Y3R1cmUnKTsKICAKICAgICAgdmFyIHBhcmFtTmFtZTsKICAgICAgZm9yICh2YXIgaSA9IDA7IHNoYXBlLnJlcXVpcmVkICYmIGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICAgIHBhcmFtTmFtZSA9IHNoYXBlLnJlcXVpcmVkW2ldOwogICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdOwogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01pc3NpbmdSZXF1aXJlZFBhcmFtZXRlcicsCiAgICAgICAgICAgICdNaXNzaW5nIHJlcXVpcmVkIGtleSBcJycgKyBwYXJhbU5hbWUgKyAnXCcgaW4gJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyB2YWxpZGF0ZSBoYXNoIG1lbWJlcnMKICAgICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1zKSB7CiAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1zLCBwYXJhbU5hbWUpKSBjb250aW51ZTsKICAKICAgICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdLAogICAgICAgICAgICBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbcGFyYW1OYW1lXTsKICAKICAgICAgICBpZiAobWVtYmVyU2hhcGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIG1lbWJlckNvbnRleHQgPSBbY29udGV4dCwgcGFyYW1OYW1lXS5qb2luKCcuJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKG1lbWJlclNoYXBlLCBwYXJhbVZhbHVlLCBtZW1iZXJDb250ZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5mYWlsKCdVbmV4cGVjdGVkUGFyYW1ldGVyJywKICAgICAgICAgICAgJ1VuZXhwZWN0ZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBmb3VuZCBpbiAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTWVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpIHsKICAgICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU3RydWN0dXJlKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdtYXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVNYXAoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTY2FsYXIoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTGlzdDogZnVuY3Rpb24gdmFsaWRhdGVMaXN0KHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgW0FycmF5XSkpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHBhcmFtcy5sZW5ndGgsIGNvbnRleHQsICdsaXN0IG1lbWJlciBjb3VudCcpOwogICAgICAgIC8vIHZhbGlkYXRlIGFycmF5IG1lbWJlcnMKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5tZW1iZXIsIHBhcmFtc1tpXSwgY29udGV4dCArICdbJyArIGkgKyAnXScpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTWFwOiBmdW5jdGlvbiB2YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdtYXAnKSkgewogICAgICAgIC8vIEJ1aWxkIHVwIGEgY291bnQgb2YgbWFwIG1lbWJlcnMgdG8gdmFsaWRhdGUgcmFuZ2UgdHJhaXRzLgogICAgICAgIHZhciBtYXBDb3VudCA9IDA7CiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7CiAgICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtKSkgY29udGludWU7CiAgICAgICAgICAvLyBWYWxpZGF0ZSBhbnkgbWFwIGtleSB0cmFpdCBjb25zdHJhaW50cwogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5rZXksIHBhcmFtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1trZXk9XCcnICsgcGFyYW0gKyAnXCddJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLnZhbHVlLCBwYXJhbXNbcGFyYW1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1tcJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICAgIG1hcENvdW50Kys7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgbWFwQ291bnQsIGNvbnRleHQsICdtYXAgbWVtYmVyIGNvdW50Jyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVNjYWxhcjogZnVuY3Rpb24gdmFsaWRhdGVTY2FsYXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICAgIGNhc2UgbnVsbDoKICAgICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVBheWxvYWQodmFsdWUsIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2ludGVnZXInOgogICAgICAgIGNhc2UgJ2Zsb2F0JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnYm9vbGVhbiddKTsKICAgICAgICBjYXNlICd0aW1lc3RhbXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbRGF0ZSwKICAgICAgICAgICAgL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLCAnbnVtYmVyJ10sCiAgICAgICAgICAgICdEYXRlIG9iamVjdCwgSVNPLTg2MDEgc3RyaW5nLCBvciBhIFVOSVggdGltZXN0YW1wJyk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB0aGlzLmZhaWwoJ1Vua293blR5cGUnLCAnVW5oYW5kbGVkIHR5cGUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLnR5cGUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cmluZzogZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciB2YWxpZFR5cGVzID0gWydzdHJpbmcnXTsKICAgICAgaWYgKHNoYXBlLmlzSnNvblZhbHVlKSB7CiAgICAgICAgdmFsaWRUeXBlcyA9IHZhbGlkVHlwZXMuY29uY2F0KFsnbnVtYmVyJywgJ29iamVjdCcsICdib29sZWFuJ10pOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgdmFsaWRUeXBlcykpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlRW51bShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUubGVuZ3RoLCBjb250ZXh0LCAnc3RyaW5nIGxlbmd0aCcpOwogICAgICAgIHRoaXMudmFsaWRhdGVQYXR0ZXJuKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVVyaShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVVcmk6IGZ1bmN0aW9uIHZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAoc2hhcGVbJ2xvY2F0aW9uJ10gPT09ICd1cmknKSB7CiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5mYWlsKCdVcmlQYXJhbWV0ZXJFcnJvcicsICdFeHBlY3RlZCB1cmkgcGFyYW1ldGVyIHRvIGhhdmUgbGVuZ3RoID49IDEsJwogICAgICAgICAgICArICcgYnV0IGZvdW5kICInICsgdmFsdWUgKyciIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVQYXR0ZXJuOiBmdW5jdGlvbiB2YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ3BhdHRlcm4nXSAmJiBzaGFwZVsncGF0dGVybiddICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIShuZXcgUmVnRXhwKHNoYXBlWydwYXR0ZXJuJ10pKS50ZXN0KHZhbHVlKSkgewogICAgICAgICAgdGhpcy5mYWlsKCdQYXR0ZXJuTWF0Y2hFcnJvcicsICdQcm92aWRlZCB2YWx1ZSAiJyArIHZhbHVlICsgJyIgJwogICAgICAgICAgICArICdkb2VzIG5vdCBtYXRjaCByZWdleCBwYXR0ZXJuIC8nICsgc2hhcGVbJ3BhdHRlcm4nXSArICcvIGZvciAnCiAgICAgICAgICAgICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVSYW5nZTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsIGRlc2NyaXB0b3IpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWluJ10pIHsKICAgICAgICBpZiAoc2hhcGVbJ21pbiddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPCBzaGFwZVsnbWluJ10pIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWluUmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPj0gJwogICAgICAgICAgICArIHNoYXBlWydtaW4nXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ21heCddKSB7CiAgICAgICAgaWYgKHNoYXBlWydtYXgnXSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlID4gc2hhcGVbJ21heCddKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01heFJhbmdlRXJyb3InLCAnRXhwZWN0ZWQgJyArIGRlc2NyaXB0b3IgKyAnIDw9ICcKICAgICAgICAgICAgKyBzaGFwZVsnbWF4J10gKyAnLCBidXQgZm91bmQgJyArIHZhbHVlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlRW51bTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnZW51bSddICYmIHNoYXBlWydlbnVtJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIEZhaWwgaWYgdGhlIHN0cmluZyB2YWx1ZSBpcyBub3QgcHJlc2VudCBpbiB0aGUgZW51bSBsaXN0CiAgICAgICAgaWYgKHNoYXBlWydlbnVtJ10uaW5kZXhPZih2YWx1ZSkgPT09IC0xKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ0VudW1FcnJvcicsICdGb3VuZCBzdHJpbmcgdmFsdWUgb2YgJyArIHZhbHVlICsgJywgYnV0ICcKICAgICAgICAgICAgKyAnZXhwZWN0ZWQgJyArIHNoYXBlWydlbnVtJ10uam9pbignfCcpICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlVHlwZTogZnVuY3Rpb24gdmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBhY2NlcHRlZFR5cGVzLCB0eXBlKSB7CiAgICAgIC8vIFdlIHdpbGwgbm90IGxvZyBhbiBlcnJvciBmb3IgbnVsbCBvciB1bmRlZmluZWQsIGJ1dCB3ZSB3aWxsIHJldHVybgogICAgICAvLyBmYWxzZSBzbyB0aGF0IGNhbGxlcnMga25vdyB0aGF0IHRoZSBleHBlY3RlZCB0eXBlIHdhcyBub3Qgc3RyaWN0bHkgbWV0LgogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwogIAogICAgICB2YXIgZm91bmRJbnZhbGlkVHlwZSA9IGZhbHNlOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjY2VwdGVkVHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodHlwZW9mIGFjY2VwdGVkVHlwZXNbaV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGFjY2VwdGVkVHlwZXNbaV0gaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIGlmICgodmFsdWUgfHwgJycpLnRvU3RyaW5nKCkubWF0Y2goYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIGFjY2VwdGVkVHlwZXNbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmICghdHlwZSAmJiAhZm91bmRJbnZhbGlkVHlwZSkgYWNjZXB0ZWRUeXBlcyA9IGFjY2VwdGVkVHlwZXMuc2xpY2UoKTsKICAgICAgICAgIGFjY2VwdGVkVHlwZXNbaV0gPSBBV1MudXRpbC50eXBlTmFtZShhY2NlcHRlZFR5cGVzW2ldKTsKICAgICAgICB9CiAgICAgICAgZm91bmRJbnZhbGlkVHlwZSA9IHRydWU7CiAgICAgIH0KICAKICAgICAgdmFyIGFjY2VwdGVkVHlwZSA9IHR5cGU7CiAgICAgIGlmICghYWNjZXB0ZWRUeXBlKSB7CiAgICAgICAgYWNjZXB0ZWRUeXBlID0gYWNjZXB0ZWRUeXBlcy5qb2luKCcsICcpLnJlcGxhY2UoLywoW14sXSspJC8sICcsIG9yJDEnKTsKICAgICAgfQogIAogICAgICB2YXIgdm93ZWwgPSBhY2NlcHRlZFR5cGUubWF0Y2goL15bYWVpb3VdL2kpID8gJ24nIDogJyc7CiAgICAgIHRoaXMuZmFpbCgnSW52YWxpZFBhcmFtZXRlclR5cGUnLCAnRXhwZWN0ZWQgJyArIGNvbnRleHQgKyAnIHRvIGJlIGEnICsKICAgICAgICAgICAgICAgIHZvd2VsICsgJyAnICsgYWNjZXB0ZWRUeXBlKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTnVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU51bWJlcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICB2YXIgY2FzdGVkVmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgICAgICBpZiAoY2FzdGVkVmFsdWUudG9TdHJpbmcoKSA9PT0gdmFsdWUpIHZhbHVlID0gY2FzdGVkVmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbJ251bWJlciddKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsICdudW1lcmljIHZhbHVlJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVBheWxvYWQ6IGZ1bmN0aW9uIHZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuOwogICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSByZXR1cm47IC8vIHR5cGVkIGFycmF5cwogICAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkpIHsgLy8gc3BlY2lhbCBjaGVjayBmb3IgYnVmZmVyL3N0cmVhbSBpbiBOb2RlLmpzCiAgICAgICAgdmFyIFN0cmVhbSA9IEFXUy51dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgICAgaWYgKEFXUy51dGlsLkJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJlYW0pIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIEJsb2IgIT09IHZvaWQgMCAmJiB2YWx1ZSBpbnN0YW5jZW9mIEJsb2IpIHJldHVybjsKICAgICAgfQogIAogICAgICB2YXIgdHlwZXMgPSBbJ0J1ZmZlcicsICdTdHJlYW0nLCAnRmlsZScsICdCbG9iJywgJ0FycmF5QnVmZmVyJywgJ0RhdGFWaWV3J107CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIHR5cGVzW2ldKSkgcmV0dXJuOwogICAgICAgICAgaWYgKEFXUy51dGlsLnR5cGVOYW1lKHZhbHVlLmNvbnN0cnVjdG9yKSA9PT0gdHlwZXNbaV0pIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYSAnICsKICAgICAgICAnc3RyaW5nLCBCdWZmZXIsIFN0cmVhbSwgQmxvYiwgb3IgdHlwZWQgYXJyYXkgb2JqZWN0Jyk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSw0NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSAgcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogUHJlcGVuZCBwcmVmaXggZGVmaW5lZCBieSBBUEkgbW9kZWwgdG8gZW5kcG9pbnQgdGhhdCdzIGFscmVhZHkKICAgKiBjb25zdHJ1Y3RlZC4gVGhpcyBmZWF0dXJlIGRvZXMgbm90IGFwcGx5IHRvIG9wZXJhdGlvbnMgdXNpbmcKICAgKiBlbmRwb2ludCBkaXNjb3ZlcnkgYW5kIGNhbiBiZSBkaXNhYmxlZC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxdWVzdCkgIHsKICAgIHZhciBlbmFibGVkID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5ob3N0UHJlZml4RW5hYmxlZDsKICAgIGlmICghZW5hYmxlZCkgcmV0dXJuIHJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgLy9kb24ndCBtYXJzaGFsIGhvc3QgcHJlZml4IHdoZW4gb3BlcmF0aW9uIGhhcyBlbmRwb2ludCBkaXNjb3ZlcnkgdHJhaXRzCiAgICBpZiAoaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSkgcmV0dXJuIHJlcXVlc3Q7CiAgICBpZiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQgJiYgb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeCkgewogICAgICB2YXIgaG9zdFByZWZpeE5vdGF0aW9uID0gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeDsKICAgICAgdmFyIGhvc3RQcmVmaXggPSBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcmVxdWVzdC5wYXJhbXMsIG9wZXJhdGlvbk1vZGVsLmlucHV0KTsKICAgICAgcHJlcGVuZEVuZHBvaW50UHJlZml4KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQsIGhvc3RQcmVmaXgpOwogICAgICB2YWxpZGF0ZUhvc3RuYW1lKHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUpOwogICAgfQogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGhhc0VuZHBvaW50RGlzY292ZXIocmVxdWVzdCkgewogICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGk7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgaXNFbmRwb2ludE9wZXJhdGlvbiA9IGFwaS5lbmRwb2ludE9wZXJhdGlvbiAmJiAoYXBpLmVuZHBvaW50T3BlcmF0aW9uID09PSB1dGlsLnN0cmluZy5sb3dlckZpcnN0KG9wZXJhdGlvbk1vZGVsLm5hbWUpKTsKICAgIHJldHVybiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCAhPT0gJ05VTEwnIHx8IGlzRW5kcG9pbnRPcGVyYXRpb24gPT09IHRydWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcGFyYW1zLCBzaGFwZSkgewogICAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICBpZiAobWVtYmVyLmhvc3RMYWJlbCA9PT0gdHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW25hbWVdICE9PSAnc3RyaW5nJyB8fCBwYXJhbXNbbmFtZV0gPT09ICcnKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdQYXJhbWV0ZXIgJyArIG5hbWUgKyAnIHNob3VsZCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcuJywKICAgICAgICAgICAgY29kZTogJ0ludmFsaWRQYXJhbWV0ZXInCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG5hbWUgKyAnXFx9JywgJ2cnKTsKICAgICAgICBob3N0UHJlZml4Tm90YXRpb24gPSBob3N0UHJlZml4Tm90YXRpb24ucmVwbGFjZShyZWdleCwgcGFyYW1zW25hbWVdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaG9zdFByZWZpeE5vdGF0aW9uOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwcmVwZW5kRW5kcG9pbnRQcmVmaXgoZW5kcG9pbnQsIHByZWZpeCkgewogICAgaWYgKGVuZHBvaW50Lmhvc3QpIHsKICAgICAgZW5kcG9pbnQuaG9zdCA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3Q7CiAgICB9CiAgICBpZiAoZW5kcG9pbnQuaG9zdG5hbWUpIHsKICAgICAgZW5kcG9pbnQuaG9zdG5hbWUgPSBwcmVmaXggKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVIb3N0bmFtZShob3N0bmFtZSkgewogICAgdmFyIGxhYmVscyA9IGhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAvL1JlZmVyZW5jZTogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzExMjMjc2VjdGlvbi0yCiAgICB2YXIgaG9zdFBhdHRlcm4gPSAvXlthLXpBLVowLTldezF9JHxeW2EtekEtWjAtOV1bYS16QS1aMC05XC1dKlthLXpBLVowLTldJC87CiAgICB1dGlsLmFycmF5RWFjaChsYWJlbHMsIGZ1bmN0aW9uKGxhYmVsKSB7CiAgICAgIGlmICghbGFiZWwubGVuZ3RoIHx8IGxhYmVsLmxlbmd0aCA8IDEgfHwgbGFiZWwubGVuZ3RoID4gNjMpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdIb3N0bmFtZSBsYWJlbCBsZW5ndGggc2hvdWxkIGJlIGJldHdlZW4gMSB0byA2MyBjaGFyYWN0ZXJzLCBpbmNsdXNpdmUuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghaG9zdFBhdHRlcm4udGVzdChsYWJlbCkpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgIHtjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywgbWVzc2FnZTogbGFiZWwgKyAnIGlzIG5vdCBob3N0bmFtZSBjb21wYXRpYmxlLid9KTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gewogICAgcG9wdWxhdGVIb3N0UHJlZml4OiBwb3B1bGF0ZUhvc3RQcmVmaXgKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vdXRpbCI6NzF9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgdmFyIGFwaSA9IHJlcS5zZXJ2aWNlLmFwaTsKICAgIHZhciB0YXJnZXQgPSBhcGkudGFyZ2V0UHJlZml4ICsgJy4nICsgYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ubmFtZTsKICAgIHZhciB2ZXJzaW9uID0gYXBpLmpzb25WZXJzaW9uIHx8ICcxLjAnOwogICAgdmFyIGlucHV0ID0gYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBKc29uQnVpbGRlcigpOwogIAogICAgaWYgKHZlcnNpb24gPT09IDEpIHZlcnNpb24gPSAnMS4wJzsKICAgIGh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMgfHwge30sIGlucHV0KTsKICAgIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtYW16LWpzb24tJyArIHZlcnNpb247CiAgICBodHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1UYXJnZXQnXSA9IHRhcmdldDsKICAKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgdmFyIGVycm9yID0ge307CiAgICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcC5odHRwUmVzcG9uc2U7CiAgCiAgICBlcnJvci5jb2RlID0gaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1lcnJvcnR5cGUnXSB8fCAnVW5rbm93bkVycm9yJzsKICAgIGlmICh0eXBlb2YgZXJyb3IuY29kZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZXJyb3IuY29kZSA9IGVycm9yLmNvZGUuc3BsaXQoJzonKVswXTsKICAgIH0KICAKICAgIGlmIChodHRwUmVzcG9uc2UuYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIGUgPSBKU09OLnBhcnNlKGh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkpOwogICAgICAgIGlmIChlLl9fdHlwZSB8fCBlLmNvZGUpIHsKICAgICAgICAgIGVycm9yLmNvZGUgPSAoZS5fX3R5cGUgfHwgZS5jb2RlKS5zcGxpdCgnIycpLnBvcCgpOwogICAgICAgIH0KICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ1JlcXVlc3RFbnRpdHlUb29MYXJnZScpIHsKICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSAnUmVxdWVzdCBib2R5IG11c3QgYmUgbGVzcyB0aGFuIDEgTUInOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJvci5tZXNzYWdlID0gKGUubWVzc2FnZSB8fCBlLk1lc3NhZ2UgfHwgbnVsbCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICBlcnJvci5tZXNzYWdlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUudG9TdHJpbmcoKTsKICAgIH0KICAKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvcik7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpIHx8ICd7fSc7CiAgICBpZiAocmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNvbnZlcnRSZXNwb25zZVR5cGVzID09PSBmYWxzZSkgewogICAgICByZXNwLmRhdGEgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3Jlc3AucmVxdWVzdC5vcGVyYXRpb25dOwogICAgICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhID0gcGFyc2VyLnBhcnNlKGJvZHksIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBRdWVyeVBhcmFtU2VyaWFsaXplciA9IHJlcXVpcmUoJy4uL3F1ZXJ5L3F1ZXJ5X3BhcmFtX3NlcmlhbGl6ZXInKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPQogICAgICAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PXV0Zi04JzsKICAgIGh0dHBSZXF1ZXN0LnBhcmFtcyA9IHsKICAgICAgVmVyc2lvbjogcmVxLnNlcnZpY2UuYXBpLmFwaVZlcnNpb24sCiAgICAgIEFjdGlvbjogb3BlcmF0aW9uLm5hbWUKICAgIH07CiAgCiAgICAvLyBjb252ZXJ0IHRoZSByZXF1ZXN0IHBhcmFtZXRlcnMgaW50byBhIGxpc3Qgb2YgcXVlcnkgcGFyYW1zLAogICAgLy8gZS5nLiBEZWVwbHkuTmVzdGVkUGFyYW0uMC5OYW1lPXZhbHVlCiAgICB2YXIgYnVpbGRlciA9IG5ldyBRdWVyeVBhcmFtU2VyaWFsaXplcigpOwogICAgYnVpbGRlci5zZXJpYWxpemUocmVxLnBhcmFtcywgb3BlcmF0aW9uLmlucHV0LCBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICBodHRwUmVxdWVzdC5wYXJhbXNbbmFtZV0gPSB2YWx1ZTsKICAgIH0pOwogICAgaHR0cFJlcXVlc3QuYm9keSA9IHV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhodHRwUmVxdWVzdC5wYXJhbXMpOwogIAogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICB2YXIgZGF0YSwgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKTsKICAgIGlmIChib2R5Lm1hdGNoKCc8VW5rbm93bk9wZXJhdGlvbkV4Y2VwdGlvbicpKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogJ1Vua25vd25PcGVyYXRpb24nLAogICAgICAgIE1lc3NhZ2U6ICdVbmtub3duIG9wZXJhdGlvbiAnICsgcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbgogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UoYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkYXRhID0gewogICAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoZGF0YS5yZXF1ZXN0SWQgJiYgIXJlc3AucmVxdWVzdElkKSByZXNwLnJlcXVlc3RJZCA9IGRhdGEucmVxdWVzdElkOwogICAgaWYgKGRhdGEuRXJyb3JzKSBkYXRhID0gZGF0YS5FcnJvcnM7CiAgICBpZiAoZGF0YS5FcnJvcikgZGF0YSA9IGRhdGEuRXJyb3I7CiAgICBpZiAoZGF0YS5Db2RlKSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogZGF0YS5Db2RlLAogICAgICAgIG1lc3NhZ2U6IGRhdGEuTWVzc2FnZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBtZXNzYWdlOiBudWxsCiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIHNoYXBlID0gb3BlcmF0aW9uLm91dHB1dCB8fCB7fTsKICAgIHZhciBvcmlnUnVsZXMgPSBzaGFwZTsKICAKICAgIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgICB2YXIgdG1wID0gU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30pOwogICAgICB0bXAubWVtYmVyc1tvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0gPSBzaGFwZTsKICAgICAgdG1wLm1lbWJlck5hbWVzID0gW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgdXRpbC5wcm9wZXJ0eShzaGFwZSwgJ25hbWUnLCBzaGFwZS5yZXN1bHRXcmFwcGVyKTsKICAgICAgc2hhcGUgPSB0bXA7CiAgICB9CiAgCiAgICB2YXIgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgCiAgICAvLyBUT0RPOiBSZWZhY3RvciBYTUwgUGFyc2VyIHRvIHBhcnNlIFJlcXVlc3RJZCBmcm9tIHJlc3BvbnNlLgogICAgaWYgKHNoYXBlICYmIHNoYXBlLm1lbWJlcnMgJiYgIXNoYXBlLm1lbWJlcnMuX1hBTVpSZXF1ZXN0SWQpIHsKICAgICAgdmFyIHJlcXVlc3RJZFNoYXBlID0gU2hhcGUuY3JlYXRlKAogICAgICAgIHsgdHlwZTogJ3N0cmluZycgfSwKICAgICAgICB7IGFwaTogeyBwcm90b2NvbDogJ3F1ZXJ5JyB9IH0sCiAgICAgICAgJ3JlcXVlc3RJZCcKICAgICAgKTsKICAgICAgc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCA9IHJlcXVlc3RJZFNoYXBlOwogICAgfQogIAogICAgdmFyIGRhdGEgPSBwYXJzZXIucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpLCBzaGFwZSk7CiAgICByZXNwLnJlcXVlc3RJZCA9IGRhdGEuX1hBTVpSZXF1ZXN0SWQgfHwgZGF0YS5yZXF1ZXN0SWQ7CiAgCiAgICBpZiAoZGF0YS5fWEFNWlJlcXVlc3RJZCkgZGVsZXRlIGRhdGEuX1hBTVpSZXF1ZXN0SWQ7CiAgCiAgICBpZiAob3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXIpIHsKICAgICAgaWYgKGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdKSB7CiAgICAgICAgdXRpbC51cGRhdGUoZGF0YSwgZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pOwogICAgICAgIGRlbGV0ZSBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgfQogICAgfQogIAogICAgcmVzcC5kYXRhID0gZGF0YTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL21vZGVsL3NoYXBlIjo0MywiLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplciI6NTEsIi4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVNZXRob2QocmVxKSB7CiAgICByZXEuaHR0cFJlcXVlc3QubWV0aG9kID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaHR0cE1ldGhvZDsKICB9CiAgCiAgZnVuY3Rpb24gZ2VuZXJhdGVVUkkoZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoLCBpbnB1dCwgcGFyYW1zKSB7CiAgICB2YXIgdXJpID0gW2VuZHBvaW50UGF0aCwgb3BlcmF0aW9uUGF0aF0uam9pbignLycpOwogICAgdXJpID0gdXJpLnJlcGxhY2UoL1wvKy9nLCAnLycpOwogIAogICAgdmFyIHF1ZXJ5U3RyaW5nID0ge30sIHF1ZXJ5U3RyaW5nU2V0ID0gZmFsc2U7CiAgICB1dGlsLmVhY2goaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwgfHwgcGFyYW1WYWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICd1cmknKSB7CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG1lbWJlci5uYW1lICsgJyhcXCspP1xcfScpOwogICAgICAgIHVyaSA9IHVyaS5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihfLCBwbHVzKSB7CiAgICAgICAgICB2YXIgZm4gPSBwbHVzID8gdXRpbC51cmlFc2NhcGVQYXRoIDogdXRpbC51cmlFc2NhcGU7CiAgICAgICAgICByZXR1cm4gZm4oU3RyaW5nKHBhcmFtVmFsdWUpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgICBxdWVyeVN0cmluZ1NldCA9IHRydWU7CiAgCiAgICAgICAgaWYgKG1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHBhcmFtVmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUobWVtYmVyLm1lbWJlci50b1dpcmVGb3JtYXQodmFsKS50b1N0cmluZygpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAobWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgICB1dGlsLmVhY2gocGFyYW1WYWx1ZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwudXJpRXNjYXBlKFN0cmluZyh2YWwpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1ttZW1iZXIubmFtZV0gPSB1dGlsLnVyaUVzY2FwZShtZW1iZXIudG9XaXJlRm9ybWF0KHBhcmFtVmFsdWUpLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBpZiAocXVlcnlTdHJpbmdTZXQpIHsKICAgICAgdXJpICs9ICh1cmkuaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPycpOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdXRpbC5hcnJheUVhY2goT2JqZWN0LmtleXMocXVlcnlTdHJpbmcpLnNvcnQoKSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHF1ZXJ5U3RyaW5nW2tleV0pKSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gW3F1ZXJ5U3RyaW5nW2tleV1dOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5U3RyaW5nW2tleV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUoU3RyaW5nKGtleSkpICsgJz0nICsgcXVlcnlTdHJpbmdba2V5XVtpXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdXJpICs9IHBhcnRzLmpvaW4oJyYnKTsKICAgIH0KICAKICAgIHJldHVybiB1cmk7CiAgfQogIAogIGZ1bmN0aW9uIHBvcHVsYXRlVVJJKHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGlucHV0ID0gb3BlcmF0aW9uLmlucHV0OwogIAogICAgdmFyIHVyaSA9IGdlbmVyYXRlVVJJKHJlcS5odHRwUmVxdWVzdC5lbmRwb2ludC5wYXRoLCBvcGVyYXRpb24uaHR0cFBhdGgsIGlucHV0LCByZXEucGFyYW1zKTsKICAgIHJlcS5odHRwUmVxdWVzdC5wYXRoID0gdXJpOwogIH0KICAKICBmdW5jdGlvbiBwb3B1bGF0ZUhlYWRlcnMocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB1dGlsLmVhY2gob3BlcmF0aW9uLmlucHV0Lm1lbWJlcnMsIGZ1bmN0aW9uIChuYW1lLCBtZW1iZXIpIHsKICAgICAgdmFyIHZhbHVlID0gcmVxLnBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgIHV0aWwuZWFjaCh2YWx1ZSwgZnVuY3Rpb24oa2V5LCBtZW1iZXJWYWx1ZSkgewogICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWUgKyBrZXldID0gbWVtYmVyVmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICAgIHZhbHVlID0gbWVtYmVyLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKTsKICAgICAgICBpZiAobWVtYmVyLmlzSnNvblZhbHVlKSB7CiAgICAgICAgICB2YWx1ZSA9IHV0aWwuYmFzZTY0LmVuY29kZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW21lbWJlci5uYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgcG9wdWxhdGVNZXRob2QocmVxKTsKICAgIHBvcHVsYXRlVVJJKHJlcSk7CiAgICBwb3B1bGF0ZUhlYWRlcnMocmVxKTsKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IoKSB7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHIgPSByZXNwLmh0dHBSZXNwb25zZTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgLy8gbm9ybWFsaXplIGhlYWRlcnMgbmFtZXMgdG8gbG93ZXItY2FzZWQga2V5cyBmb3IgbWF0Y2hpbmcKICAgIHZhciBoZWFkZXJzID0ge307CiAgICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgICBoZWFkZXJzW2sudG9Mb3dlckNhc2UoKV0gPSB2OwogICAgfSk7CiAgCiAgICB1dGlsLmVhY2gob3V0cHV0Lm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgaGVhZGVyID0gKG1lbWJlci5uYW1lIHx8IG5hbWUpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXJzJyAmJiBtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICBkYXRhW25hbWVdID0ge307CiAgICAgICAgdmFyIGxvY2F0aW9uID0gbWVtYmVyLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyLm5hbWUgOiAnJzsKICAgICAgICB2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14nICsgbG9jYXRpb24gKyAnKC4rKScsICdpJyk7CiAgICAgICAgdXRpbC5lYWNoKHIuaGVhZGVycywgZnVuY3Rpb24gKGssIHYpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBrLm1hdGNoKHBhdHRlcm4pOwogICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgICBkYXRhW25hbWVdW3Jlc3VsdFsxXV0gPSB2OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgICBpZiAoaGVhZGVyc1toZWFkZXJdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IG1lbWJlci5pc0pzb25WYWx1ZSA/CiAgICAgICAgICAgIHV0aWwuYmFzZTY0LmRlY29kZShoZWFkZXJzW2hlYWRlcl0pIDoKICAgICAgICAgICAgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgZGF0YVtuYW1lXSA9IG1lbWJlci50b1R5cGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdzdGF0dXNDb2RlJykgewogICAgICAgIGRhdGFbbmFtZV0gPSBwYXJzZUludChyLnN0YXR1c0NvZGUsIDEwKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXNwLmRhdGEgPSBkYXRhOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEsCiAgICBnZW5lcmF0ZVVSSTogZ2VuZXJhdGVVUkkKICB9OwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgUmVzdCA9IHJlcXVpcmUoJy4vcmVzdCcpOwogIHZhciBKc29uID0gcmVxdWlyZSgnLi9qc29uJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIAogIGZ1bmN0aW9uIHBvcHVsYXRlQm9keShyZXEpIHsKICAgIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CiAgICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAKICAgIGlmIChpbnB1dC5wYXlsb2FkKSB7CiAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgdmFyIHBheWxvYWRTaGFwZSA9IGlucHV0Lm1lbWJlcnNbaW5wdXQucGF5bG9hZF07CiAgICAgIHBhcmFtcyA9IHJlcS5wYXJhbXNbaW5wdXQucGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHBhcmFtcywgcGF5bG9hZFNoYXBlKTsKICAgICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi1KU09OIHBheWxvYWQKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IHBhcmFtczsKICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRTaGFwZS5pc1N0cmVhbWluZykgewogICAgICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEsIHRydWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMsIGlucHV0KTsKICAgICAgaWYgKGJvZHkgIT09ICd7fScgfHwgcmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCAhPT0gJ0dFVCcpIHsgLy9kb24ndCBzZW5kIGVtcHR5IGJvZHkgZm9yIEdFVCBtZXRob2QKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJvZHk7CiAgICAgIH0KICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgaXNCaW5hcnkpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBpbnB1dCA9IG9wZXJhdGlvbi5pbnB1dDsKICAKICAgIGlmICghcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICAgIHZhciB0eXBlID0gaXNCaW5hcnkgPyAnYmluYXJ5L29jdGV0LXN0cmVhbScgOiAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9IHR5cGU7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CiAgCiAgICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBIRUFEL0RFTEVURQogICAgaWYgKFsnSEVBRCcsICdERUxFVEUnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIEpzb24uZXh0cmFjdEVycm9yKHJlc3ApOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3REYXRhKHJlc3ApOwogIAogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgIHZhciBwYXJzZXI7CiAgICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CiAgCiAgICBpZiAocnVsZXMucGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IHJ1bGVzLm1lbWJlcnNbcnVsZXMucGF5bG9hZF07CiAgICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICAgIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gdXRpbC5jcmVhdGVFdmVudFN0cmVhbSgKICAgICAgICAgIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyID8gcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtIDogYm9keSwKICAgICAgICAgIHBhcnNlciwKICAgICAgICAgIHBheWxvYWRNZW1iZXIKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScgfHwgcGF5bG9hZE1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXJzZXIucGFyc2UoYm9keSwgcGF5bG9hZE1lbWJlcik7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gYm9keTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGRhdGEgPSByZXNwLmRhdGE7CiAgICAgIEpzb24uZXh0cmFjdERhdGEocmVzcCk7CiAgICAgIHJlc3AuZGF0YSA9IHV0aWwubWVyZ2UoZGF0YSwgcmVzcC5kYXRhKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9qc29uIjo0NiwiLi9yZXN0Ijo0OH1dLDUwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogICAgdmFyIGlucHV0ID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBBV1MuWE1MLkJ1aWxkZXIoKTsKICAgIHZhciBwYXJhbXMgPSByZXEucGFyYW1zOwogIAogICAgdmFyIHBheWxvYWQgPSBpbnB1dC5wYXlsb2FkOwogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBpbnB1dC5tZW1iZXJzW3BheWxvYWRdOwogICAgICBwYXJhbXMgPSBwYXJhbXNbcGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHZhciByb290RWxlbWVudCA9IHBheWxvYWRNZW1iZXIubmFtZTsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBwYXlsb2FkTWVtYmVyLCByb290RWxlbWVudCwgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi14bWwgcGF5bG9hZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBpbnB1dCwgaW5wdXQubmFtZSB8fAogICAgICAgIGlucHV0LnNoYXBlIHx8IHV0aWwuc3RyaW5nLnVwcGVyRmlyc3QocmVxLm9wZXJhdGlvbikgKyAnUmVxdWVzdCcpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICBSZXN0LmJ1aWxkUmVxdWVzdChyZXEpOwogIAogICAgLy8gbmV2ZXIgc2VuZCBib2R5IHBheWxvYWQgb24gR0VUL0hFQUQKICAgIGlmIChbJ0dFVCcsICdIRUFEJ10uaW5kZXhPZihyZXEuaHR0cFJlcXVlc3QubWV0aG9kKSA8IDApIHsKICAgICAgcG9wdWxhdGVCb2R5KHJlcSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3RFcnJvcihyZXNwKTsKICAKICAgIHZhciBkYXRhOwogICAgdHJ5IHsKICAgICAgZGF0YSA9IG5ldyBBV1MuWE1MLlBhcnNlcigpLnBhcnNlKHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBNZXNzYWdlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlCiAgICAgIH07CiAgICB9CiAgCiAgICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICAgIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICAgIGlmIChkYXRhLkNvZGUpIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIG1lc3NhZ2U6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CiAgCiAgICB2YXIgcGFyc2VyOwogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgdmFyIGhhc0V2ZW50T3V0cHV0ID0gb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0OwogIAogICAgdmFyIHBheWxvYWQgPSBvdXRwdXQucGF5bG9hZDsKICAgIGlmIChwYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW0pIHsKICAgICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiByZXNwLmh0dHBSZXNwb25zZS5ib2R5LAogICAgICAgICAgcGFyc2VyLAogICAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIHBheWxvYWRNZW1iZXIpOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IGJvZHk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGF5bG9hZE1lbWJlci50b1R5cGUoYm9keSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIG91dHB1dCk7CiAgICAgIHV0aWwudXBkYXRlKHJlc3AuZGF0YSwgZGF0YSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi91dGlsIjo3MSwiLi9yZXN0Ijo0OH1dLDUxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBRdWVyeVBhcmFtU2VyaWFsaXplcigpIHsKICB9CiAgCiAgUXVlcnlQYXJhbVNlcmlhbGl6ZXIucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIGZuKSB7CiAgICBzZXJpYWxpemVTdHJ1Y3R1cmUoJycsIHBhcmFtcywgc2hhcGUsIGZuKTsKICB9OwogIAogIGZ1bmN0aW9uIHVjZmlyc3Qoc2hhcGUpIHsKICAgIGlmIChzaGFwZS5pc1F1ZXJ5TmFtZSB8fCBzaGFwZS5hcGkucHJvdG9jb2wgIT09ICdlYzInKSB7CiAgICAgIHJldHVybiBzaGFwZS5uYW1lOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNoYXBlLm5hbWVbMF0udG9VcHBlckNhc2UoKSArIHNoYXBlLm5hbWUuc3Vic3RyKDEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUocHJlZml4LCBzdHJ1Y3QsIHJ1bGVzLCBmbikgewogICAgdXRpbC5lYWNoKHJ1bGVzLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgdmFsdWUgPSBzdHJ1Y3RbbmFtZV07CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIHZhciBtZW1iZXJOYW1lID0gdWNmaXJzdChtZW1iZXIpOwogICAgICBtZW1iZXJOYW1lID0gcHJlZml4ID8gcHJlZml4ICsgJy4nICsgbWVtYmVyTmFtZSA6IG1lbWJlck5hbWU7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihtZW1iZXJOYW1lLCB2YWx1ZSwgbWVtYmVyLCBmbik7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWFwKG5hbWUsIG1hcCwgcnVsZXMsIGZuKSB7CiAgICB2YXIgaSA9IDE7CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcHJlZml4ID0gcnVsZXMuZmxhdHRlbmVkID8gJy4nIDogJy5lbnRyeS4nOwogICAgICB2YXIgcG9zaXRpb24gPSBwcmVmaXggKyAoaSsrKSArICcuJzsKICAgICAgdmFyIGtleU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy5rZXkubmFtZSB8fCAna2V5Jyk7CiAgICAgIHZhciB2YWx1ZU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy52YWx1ZS5uYW1lIHx8ICd2YWx1ZScpOwogICAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIGtleU5hbWUsIGtleSwgcnVsZXMua2V5LCBmbik7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgdmFsdWVOYW1lLCB2YWx1ZSwgcnVsZXMudmFsdWUsIGZuKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVMaXN0KG5hbWUsIGxpc3QsIHJ1bGVzLCBmbikgewogICAgdmFyIG1lbWJlclJ1bGVzID0gcnVsZXMubWVtYmVyIHx8IHt9OwogIAogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgIGZuLmNhbGwodGhpcywgbmFtZSwgbnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uICh2LCBuKSB7CiAgICAgIHZhciBzdWZmaXggPSAnLicgKyAobiArIDEpOwogICAgICBpZiAocnVsZXMuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICAgIC8vIERvIG5vdGhpbmcgZm9yIEVDMgogICAgICAgIHN1ZmZpeCA9IHN1ZmZpeCArICcnOyAvLyBtYWtlIGxpbnRlciBoYXBweQogICAgICB9IGVsc2UgaWYgKHJ1bGVzLmZsYXR0ZW5lZCkgewogICAgICAgIGlmIChtZW1iZXJSdWxlcy5uYW1lKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgIHBhcnRzLnB1c2godWNmaXJzdChtZW1iZXJSdWxlcykpOwogICAgICAgICAgbmFtZSA9IHBhcnRzLmpvaW4oJy4nKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3VmZml4ID0gJy4nICsgKG1lbWJlclJ1bGVzLm5hbWUgPyBtZW1iZXJSdWxlcy5uYW1lIDogJ21lbWJlcicpICsgc3VmZml4OwogICAgICB9CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgc3VmZml4LCB2LCBtZW1iZXJSdWxlcywgZm4pOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1lbWJlcihuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgaWYgKHJ1bGVzLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgIHNlcmlhbGl6ZVN0cnVjdHVyZShuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgIHNlcmlhbGl6ZUxpc3QobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgICB9IGVsc2UgaWYgKHJ1bGVzLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgIHNlcmlhbGl6ZU1hcChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSB7CiAgICAgIGZuKG5hbWUsIHJ1bGVzLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gUXVlcnlQYXJhbVNlcmlhbGl6ZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gewogICAgLy9wcm92aWRlIHJlYWx0aW1lIGNsb2NrIGZvciBwZXJmb3JtYW5jZSBtZWFzdXJlbWVudAogICAgbm93OiBmdW5jdGlvbiBub3coKSB7CiAgICAgIGlmICh0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIERhdGUubm93KCk7CiAgICB9CiAgfTsKICAKICB9LHt9XSw1MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKICB2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbicpOwogIAogIGZ1bmN0aW9uIGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbikgewogICAgaWYgKCFyZWdpb24pIHJldHVybiBudWxsOwogIAogICAgdmFyIHBhcnRzID0gcmVnaW9uLnNwbGl0KCctJyk7CiAgICBpZiAocGFydHMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcGFydHMuc2xpY2UoMCwgcGFydHMubGVuZ3RoIC0gMikuam9pbignLScpICsgJy0qJzsKICB9CiAgCiAgZnVuY3Rpb24gZGVyaXZlZEtleXMoc2VydmljZSkgewogICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIHZhciByZWdpb25QcmVmaXggPSBnZW5lcmF0ZVJlZ2lvblByZWZpeChyZWdpb24pOwogICAgdmFyIGVuZHBvaW50UHJlZml4ID0gc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXg7CiAgCiAgICByZXR1cm4gWwogICAgICBbcmVnaW9uLCBlbmRwb2ludFByZWZpeF0sCiAgICAgIFtyZWdpb25QcmVmaXgsIGVuZHBvaW50UHJlZml4XSwKICAgICAgW3JlZ2lvbiwgJyonXSwKICAgICAgW3JlZ2lvblByZWZpeCwgJyonXSwKICAgICAgWycqJywgZW5kcG9pbnRQcmVmaXhdLAogICAgICBbJyonLCAnKiddCiAgICBdLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtWzBdICYmIGl0ZW1bMV0gPyBpdGVtLmpvaW4oJy8nKSA6IG51bGw7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKSB7CiAgICB1dGlsLmVhY2goY29uZmlnLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgPT09ICdnbG9iYWxFbmRwb2ludCcpIHJldHVybjsKICAgICAgaWYgKHNlcnZpY2UuY29uZmlnW2tleV0gPT09IHVuZGVmaW5lZCB8fCBzZXJ2aWNlLmNvbmZpZ1trZXldID09PSBudWxsKSB7CiAgICAgICAgc2VydmljZS5jb25maWdba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gY29uZmlndXJlRW5kcG9pbnQoc2VydmljZSkgewogICAgdmFyIGtleXMgPSBkZXJpdmVkS2V5cyhzZXJ2aWNlKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgaWYgKCFrZXkpIGNvbnRpbnVlOwogIAogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJlZ2lvbkNvbmZpZy5ydWxlcywga2V5KSkgewogICAgICAgIHZhciBjb25maWcgPSByZWdpb25Db25maWcucnVsZXNba2V5XTsKICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGNvbmZpZyA9IHJlZ2lvbkNvbmZpZy5wYXR0ZXJuc1tjb25maWddOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZHVhbHN0YWNrIGVuZHBvaW50CiAgICAgICAgaWYgKHNlcnZpY2UuY29uZmlnLnVzZUR1YWxzdGFjayAmJiB1dGlsLmlzRHVhbHN0YWNrQXZhaWxhYmxlKHNlcnZpY2UpKSB7CiAgICAgICAgICBjb25maWcgPSB1dGlsLmNvcHkoY29uZmlnKTsKICAgICAgICAgIGNvbmZpZy5lbmRwb2ludCA9ICd7c2VydmljZX0uZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20nOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZ2xvYmFsIGVuZHBvaW50CiAgICAgICAgc2VydmljZS5pc0dsb2JhbEVuZHBvaW50ID0gISFjb25maWcuZ2xvYmFsRW5kcG9pbnQ7CiAgCiAgICAgICAgLy8gc2lnbmF0dXJlIHZlcnNpb24KICAgICAgICBpZiAoIWNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSBjb25maWcuc2lnbmF0dXJlVmVyc2lvbiA9ICd2NCc7CiAgCiAgICAgICAgLy8gbWVyZ2UgY29uZmlnCiAgICAgICAgYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBjb25maWd1cmVFbmRwb2ludDsKICAKICB9LHsiLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbiI6NTQsIi4vdXRpbCI6NzF9XSw1NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInJ1bGVzIjogewogICAgICAiKi8qIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgImNuLSovKiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICAgIH0sCiAgICAgICIqL2J1ZGdldHMiOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovY2xvdWRmcm9udCI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9pYW0iOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovc3RzIjogImdsb2JhbFNTTCIsCiAgICAgICIqL2ltcG9ydGV4cG9ydCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIiwKICAgICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICAgIH0sCiAgICAgICIqL3JvdXRlNTMiOiB7CiAgICAgICAgImVuZHBvaW50IjogImh0dHBzOi8ve3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYzaHR0cHMiLAogICAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgICAgfSwKICAgICAgIiovd2FmIjogImdsb2JhbFNTTCIsCiAgICAgICJ1cy1nb3YtKi9pYW0iOiAiZ2xvYmFsR292Q2xvdWQiLAogICAgICAidXMtZ292LSovc3RzIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInVzLWdvdi13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLXdlc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJldS13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTIvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtbm9ydGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAic2EtZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLWVhc3QtMS9zMyI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInMzIgogICAgICB9LAogICAgICAidXMtZWFzdC0xL3NkYiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgICB9LAogICAgICAiKi9zZGIiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIKICAgICAgfQogICAgfSwKICAKICAgICJwYXR0ZXJucyI6IHsKICAgICAgImdsb2JhbFNTTCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAiaHR0cHM6Ly97c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgICB9LAogICAgICAiZ2xvYmFsR292Q2xvdWQiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS51cy1nb3YuYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInMzc2lnbmF0dXJlIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICAgIH0KICAgIH0KICB9CiAgCiAgfSx7fV0sNTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgQWNjZXB0b3JTdGF0ZU1hY2hpbmUgPSByZXF1aXJlKCcuL3N0YXRlX21hY2hpbmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGRvbWFpbiA9IEFXUy51dGlsLmRvbWFpbjsKICB2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBoYXJkRXJyb3JTdGF0ZXMgPSB7c3VjY2VzczogMSwgZXJyb3I6IDEsIGNvbXBsZXRlOiAxfTsKICAKICBmdW5jdGlvbiBpc1Rlcm1pbmFsU3RhdGUobWFjaGluZSkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChoYXJkRXJyb3JTdGF0ZXMsIG1hY2hpbmUuX2FzbS5jdXJyZW50U3RhdGUpOwogIH0KICAKICB2YXIgZnNtID0gbmV3IEFjY2VwdG9yU3RhdGVNYWNoaW5lKCk7CiAgZnNtLnNldHVwU3RhdGVzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgdHJhbnNpdGlvbiA9IGZ1bmN0aW9uKF8sIGRvbmUpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gZmFsc2U7CiAgCiAgICAgIHNlbGYuZW1pdChzZWxmLl9hc20uY3VycmVudFN0YXRlLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBpZiAoaXNUZXJtaW5hbFN0YXRlKHNlbGYpKSB7CiAgICAgICAgICAgIGlmIChkb21haW4gJiYgc2VsZi5kb21haW4gaW5zdGFuY2VvZiBkb21haW4uRG9tYWluKSB7CiAgICAgICAgICAgICAgZXJyLmRvbWFpbkVtaXR0ZXIgPSBzZWxmOwogICAgICAgICAgICAgIGVyci5kb21haW4gPSBzZWxmLmRvbWFpbjsKICAgICAgICAgICAgICBlcnIuZG9tYWluVGhyb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgc2VsZi5kb21haW4uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICAgICAgZG9uZShlcnIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkb25lKHNlbGYucmVzcG9uc2UuZXJyb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICB9OwogIAogICAgdGhpcy5hZGRTdGF0ZSgndmFsaWRhdGUnLCAnYnVpbGQnLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2J1aWxkJywgJ2FmdGVyQnVpbGQnLCAncmVzdGFydCcsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnYWZ0ZXJCdWlsZCcsICdzaWduJywgJ3Jlc3RhcnQnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3NpZ24nLCAnc2VuZCcsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgncmV0cnknLCAnYWZ0ZXJSZXRyeScsICdhZnRlclJldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdhZnRlclJldHJ5JywgJ3NpZ24nLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3NlbmQnLCAndmFsaWRhdGVSZXNwb25zZScsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgndmFsaWRhdGVSZXNwb25zZScsICdleHRyYWN0RGF0YScsICdleHRyYWN0RXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2V4dHJhY3RFcnJvcicsICdleHRyYWN0RGF0YScsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnZXh0cmFjdERhdGEnLCAnc3VjY2VzcycsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgncmVzdGFydCcsICdidWlsZCcsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc3VjY2VzcycsICdjb21wbGV0ZScsICdjb21wbGV0ZScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnZXJyb3InLCAnY29tcGxldGUnLCAnY29tcGxldGUnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2NvbXBsZXRlJywgbnVsbCwgbnVsbCwgdHJhbnNpdGlvbik7CiAgfTsKICBmc20uc2V0dXBTdGF0ZXMoKTsKICAKICAvKioKICAgKiAjIyBBc3luY2hyb25vdXMgUmVxdWVzdHMKICAgKgogICAqIEFsbCByZXF1ZXN0cyBtYWRlIHRocm91Z2ggdGhlIFNESyBhcmUgYXN5bmNocm9ub3VzIGFuZCB1c2UgYQogICAqIGNhbGxiYWNrIGludGVyZmFjZS4gRWFjaCBzZXJ2aWNlIG1ldGhvZCB0aGF0IGtpY2tzIG9mZiBhIHJlcXVlc3QKICAgKiByZXR1cm5zIGFuIGBBV1MuUmVxdWVzdGAgb2JqZWN0IHRoYXQgeW91IGNhbiB1c2UgdG8gcmVnaXN0ZXIKICAgKiBjYWxsYmFja3MuCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBzZXJ2aWNlIG1ldGhvZCByZXR1cm5zIHRoZSByZXF1ZXN0CiAgICogb2JqZWN0IGFzICJyZXF1ZXN0Iiwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIC8vIHJlcXVlc3QgaXMgYW4gQVdTLlJlcXVlc3Qgb2JqZWN0CiAgICogdmFyIHJlcXVlc3QgPSBlYzIuZGVzY3JpYmVJbnN0YW5jZXMoKTsKICAgKgogICAqIC8vIHJlZ2lzdGVyIGNhbGxiYWNrcyBvbiByZXF1ZXN0IHRvIHJldHJpZXZlIHJlc3BvbnNlIGRhdGEKICAgKiByZXF1ZXN0Lm9uKCdzdWNjZXNzJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgIGNvbnNvbGUubG9nKHJlc3BvbnNlLmRhdGEpOwogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogV2hlbiBhIHJlcXVlc3QgaXMgcmVhZHkgdG8gYmUgc2VudCwgdGhlIHtzZW5kfSBtZXRob2Qgc2hvdWxkCiAgICogYmUgY2FsbGVkOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHJlcXVlc3Quc2VuZCgpOwogICAqIGBgYAogICAqCiAgICogU2luY2UgcmVnaXN0ZXJlZCBjYWxsYmFja3MgbWF5IG9yIG1heSBub3QgYmUgaWRlbXBvdGVudCwgcmVxdWVzdHMgc2hvdWxkIG9ubHkKICAgKiBiZSBzZW50IG9uY2UuIFRvIHBlcmZvcm0gdGhlIHNhbWUgb3BlcmF0aW9uIG11bHRpcGxlIHRpbWVzLCB5b3Ugd2lsbCBuZWVkIHRvCiAgICogY3JlYXRlIG11bHRpcGxlIHJlcXVlc3Qgb2JqZWN0cywgZWFjaCB3aXRoIGl0cyBvd24gcmVnaXN0ZXJlZCBjYWxsYmFja3MuCiAgICoKICAgKiAjIyBSZW1vdmluZyBEZWZhdWx0IExpc3RlbmVycyBmb3IgRXZlbnRzCiAgICoKICAgKiBSZXF1ZXN0IG9iamVjdHMgYXJlIGJ1aWx0IHdpdGggZGVmYXVsdCBsaXN0ZW5lcnMgZm9yIHRoZSB2YXJpb3VzIGV2ZW50cywKICAgKiBkZXBlbmRpbmcgb24gdGhlIHNlcnZpY2UgdHlwZS4gSW4gc29tZSBjYXNlcywgeW91IG1heSB3YW50IHRvIHJlbW92ZQogICAqIHNvbWUgYnVpbHQtaW4gbGlzdGVuZXJzIHRvIGN1c3RvbWl6ZSBiZWhhdmlvdXIuIERvaW5nIHRoaXMgcmVxdWlyZXMKICAgKiBhY2Nlc3MgdG8gdGhlIGJ1aWx0LWluIGxpc3RlbmVyIGZ1bmN0aW9ucywgd2hpY2ggYXJlIGV4cG9zZWQgdGhyb3VnaAogICAqIHRoZSB7QVdTLkV2ZW50TGlzdGVuZXJzLkNvcmV9IG5hbWVzcGFjZS4gRm9yIGluc3RhbmNlLCB5b3UgbWF5CiAgICogd2FudCB0byBjdXN0b21pemUgdGhlIEhUVFAgaGFuZGxlciB1c2VkIHdoZW4gc2VuZGluZyBhIHJlcXVlc3QuIEluIHRoaXMKICAgKiBjYXNlLCB5b3UgY2FuIHJlbW92ZSB0aGUgYnVpbHQtaW4gbGlzdGVuZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSAnc2VuZCcKICAgKiBldmVudCwgdGhlIHtBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5EfSBsaXN0ZW5lciBhbmQgYWRkIHlvdXIgb3duLgogICAqCiAgICogIyMgTXVsdGlwbGUgQ2FsbGJhY2tzIGFuZCBDaGFpbmluZwogICAqCiAgICogWW91IGNhbiByZWdpc3RlciBtdWx0aXBsZSBjYWxsYmFja3Mgb24gYW55IHJlcXVlc3Qgb2JqZWN0LiBUaGUKICAgKiBjYWxsYmFja3MgY2FuIGJlIHJlZ2lzdGVyZWQgZm9yIGRpZmZlcmVudCBldmVudHMsIG9yIGFsbCBmb3IgdGhlCiAgICogc2FtZSBldmVudC4gSW4gYWRkaXRpb24sIHlvdSBjYW4gY2hhaW4gY2FsbGJhY2sgcmVnaXN0cmF0aW9uLCBmb3IKICAgKiBleGFtcGxlOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHJlcXVlc3QuCiAgICogICBvbignc3VjY2VzcycsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJTdWNjZXNzISIpOwogICAqICAgfSkuCiAgICogICBvbignZXJyb3InLCBmdW5jdGlvbihlcnJvciwgcmVzcG9uc2UpIHsKICAgKiAgICAgY29uc29sZS5sb2coIkVycm9yISIpOwogICAqICAgfSkuCiAgICogICBvbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgICBjb25zb2xlLmxvZygiQWx3YXlzISIpOwogICAqICAgfSkuCiAgICogICBzZW5kKCk7CiAgICogYGBgCiAgICoKICAgKiBUaGUgYWJvdmUgZXhhbXBsZSB3aWxsIHByaW50IGVpdGhlciAiU3VjY2VzcyEgQWx3YXlzISIsIG9yICJFcnJvciEgQWx3YXlzISIsCiAgICogZGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhlIHJlcXVlc3Qgc3VjY2VlZGVkIG9yIG5vdC4KICAgKgogICAqIEAhYXR0cmlidXRlIGh0dHBSZXF1ZXN0CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgSFRUUCBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtBV1MuSHR0cFJlcXVlc3RdIHRoZSByYXcgSFRUUCByZXF1ZXN0IG9iamVjdAogICAqICAgICBjb250YWluaW5nIHJlcXVlc3QgaGVhZGVycyBhbmQgYm9keSBpbmZvcm1hdGlvbgogICAqICAgICBzZW50IGJ5IHRoZSBzZXJ2aWNlLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RhcnRUaW1lCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0RhdGVdIHRoZSB0aW1lIHRoYXQgdGhlIHJlcXVlc3Qgc3RhcnRlZAogICAqCiAgICogQCFncm91cCBSZXF1ZXN0IEJ1aWxkaW5nIEV2ZW50cwogICAqCiAgICogQCFldmVudCB2YWxpZGF0ZShyZXF1ZXN0KQogICAqICAgVHJpZ2dlcmVkIHdoZW4gYSByZXF1ZXN0IGlzIGJlaW5nIHZhbGlkYXRlZC4gTGlzdGVuZXJzCiAgICogICBzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgdGhlIHJlcXVlc3Qgc2hvdWxkIG5vdCBiZSBzZW50LgogICAqICAgQHBhcmFtIHJlcXVlc3QgW1JlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBiZWluZyBzZW50CiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTCiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTgogICAqICAgQGV4YW1wbGUgRW5zdXJpbmcgdGhhdCBhIGNlcnRhaW4gcGFyYW1ldGVyIGlzIHNldCBiZWZvcmUgc2VuZGluZyBhIHJlcXVlc3QKICAgKiAgICAgdmFyIHJlcSA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogICAqICAgICByZXEub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24oKSB7CiAgICogICAgICAgaWYgKCFyZXEucGFyYW1zLkJvZHkubWF0Y2goL15IZWxsb1xzLykpIHsKICAgKiAgICAgICAgIHRocm93IG5ldyBFcnJvcignQm9keSBtdXN0IHN0YXJ0IHdpdGggIkhlbGxvICInKTsKICAgKiAgICAgICB9CiAgICogICAgIH0pOwogICAqICAgICByZXEuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogICAqCiAgICogQCFldmVudCBidWlsZChyZXF1ZXN0KQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgcGF5bG9hZCBpcyBiZWluZyBidWlsdC4gTGlzdGVuZXJzCiAgICogICBzaG91bGQgZmlsbCB0aGUgbmVjZXNzYXJ5IGluZm9ybWF0aW9uIHRvIHNlbmQgdGhlIHJlcXVlc3QKICAgKiAgIG92ZXIgSFRUUC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnZhbGlkYXRlKQogICAqICAgQGV4YW1wbGUgQWRkIGEgY3VzdG9tIEhUVFAgaGVhZGVyIHRvIGEgcmVxdWVzdAogICAqICAgICB2YXIgcmVxID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICogICAgIHJlcS5vbignYnVpbGQnLCBmdW5jdGlvbigpIHsKICAgKiAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ3VzdG9tLUhlYWRlciddID0gJ3ZhbHVlJzsKICAgKiAgICAgfSk7CiAgICogICAgIHJlcS5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAgICoKICAgKiBAIWV2ZW50IHNpZ24ocmVxdWVzdCkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGlzIGJlaW5nIHNpZ25lZC4gTGlzdGVuZXJzIHNob3VsZAogICAqICAgYWRkIHRoZSBjb3JyZWN0IGF1dGhlbnRpY2F0aW9uIGhlYWRlcnMgYW5kL29yIGFkanVzdCB0aGUgYm9keSwKICAgKiAgIGRlcGVuZGluZyBvbiB0aGUgYXV0aGVudGljYXRpb24gbWVjaGFuaXNtIGJlaW5nIHVzZWQuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH52YWxpZGF0ZSkKICAgKgogICAqIEAhZ3JvdXAgUmVxdWVzdCBTZW5kaW5nIEV2ZW50cwogICAqCiAgICogQCFldmVudCBzZW5kKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgcmVhZHkgdG8gYmUgc2VudC4gTGlzdGVuZXJzCiAgICogICBzaG91bGQgY2FsbCB0aGUgdW5kZXJseWluZyB0cmFuc3BvcnQgbGF5ZXIgdG8gaW5pdGlhdGUKICAgKiAgIHRoZSBzZW5kaW5nIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQHBhcmFtIHJlc3BvbnNlIFtSZXNwb25zZV0gdGhlIHJlc3BvbnNlIG9iamVjdAogICAqICAgQGNvbnRleHQgW1JlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCB0aGF0IHdhcyBzZW50CiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQKICAgKgogICAqIEAhZXZlbnQgcmV0cnkocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhIHJlcXVlc3QgZmFpbGVkIGFuZCBtaWdodCBuZWVkIHRvIGJlIHJldHJpZWQgb3IgcmVkaXJlY3RlZC4KICAgKiAgIElmIHRoZSByZXNwb25zZSBpcyByZXRyeWFibGUsIHRoZSBsaXN0ZW5lciBzaG91bGQgc2V0IHRoZQogICAqICAgYHJlc3BvbnNlLmVycm9yLnJldHJ5YWJsZWAgcHJvcGVydHkgdG8gYHRydWVgLCBhbmQgb3B0aW9uYWxseSBzZXQKICAgKiAgIGByZXNwb25zZS5lcnJvci5yZXRyeURlbGF5YCB0byB0aGUgbWlsbGlzZWNvbmQgZGVsYXkgZm9yIHRoZSBuZXh0IGF0dGVtcHQuCiAgICogICBJbiB0aGUgY2FzZSBvZiBhIHJlZGlyZWN0LCBgcmVzcG9uc2UuZXJyb3IucmVkaXJlY3RgIHNob3VsZCBiZSBzZXQgdG8KICAgKiAgIGB0cnVlYCB3aXRoIGByZXRyeURlbGF5YCBzZXQgdG8gYW4gb3B0aW9uYWwgZGVsYXkgb24gdGhlIG5leHQgcmVxdWVzdC4KICAgKgogICAqICAgSWYgYSBsaXN0ZW5lciBkZWNpZGVzIHRoYXQgYSByZXF1ZXN0IHNob3VsZCBub3QgYmUgcmV0cmllZCwKICAgKiAgIGl0IHNob3VsZCBzZXQgYm90aCBgcmV0cnlhYmxlYCBhbmQgYHJlZGlyZWN0YCB0byBmYWxzZS4KICAgKgogICAqICAgTm90ZSB0aGF0IGEgcmV0cnlhYmxlIGVycm9yIHdpbGwgYmUgcmV0cmllZCBhdCBtb3N0CiAgICogICB7QVdTLkNvbmZpZy5tYXhSZXRyaWVzfSB0aW1lcyAoYmFzZWQgb24gdGhlIHNlcnZpY2Ugb2JqZWN0J3MgY29uZmlnKS4KICAgKiAgIFNpbWlsYXJseSwgYSByZXF1ZXN0IHRoYXQgaXMgcmVkaXJlY3RlZCB3aWxsIG9ubHkgcmVkaXJlY3QgYXQgbW9zdAogICAqICAge0FXUy5Db25maWcubWF4UmVkaXJlY3RzfSB0aW1lcy4KICAgKgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBleGFtcGxlIEFkZGluZyBhIGN1c3RvbSByZXRyeSBmb3IgYSA0MDQgcmVzcG9uc2UKICAgKiAgICAgcmVxdWVzdC5vbigncmV0cnknLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgICAgIC8vIHRoaXMgcmVzb3VyY2UgaXMgbm90IHlldCBhdmFpbGFibGUsIHdhaXQgMTAgc2Vjb25kcyB0byBnZXQgaXQgYWdhaW4KICAgKiAgICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDQwNCAmJiByZXNwb25zZS5lcnJvcikgewogICAqICAgICAgICAgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsgICAvLyByZXRyeSB0aGlzIGVycm9yCiAgICogICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeURlbGF5ID0gMTAwMDA7IC8vIHdhaXQgMTAgc2Vjb25kcwogICAqICAgICAgIH0KICAgKiAgICAgfSk7CiAgICoKICAgKiBAIWdyb3VwIERhdGEgUGFyc2luZyBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgZXh0cmFjdEVycm9yKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIG9uIGFsbCBub24tMnh4IHJlcXVlc3RzIHNvIHRoYXQgbGlzdGVuZXJzIGNhbiBleHRyYWN0CiAgICogICBlcnJvciBkZXRhaWxzIGZyb20gdGhlIHJlc3BvbnNlIGJvZHkuIExpc3RlbmVycyB0byB0aGlzIGV2ZW50CiAgICogICBzaG91bGQgc2V0IHRoZSBgcmVzcG9uc2UuZXJyb3JgIHByb3BlcnR5LgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgZXh0cmFjdERhdGEocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgaW4gc3VjY2Vzc2Z1bCByZXF1ZXN0cyB0byBhbGxvdyBsaXN0ZW5lcnMgdG8KICAgKiAgIGRlLXNlcmlhbGl6ZSB0aGUgcmVzcG9uc2UgYm9keSBpbnRvIGByZXNwb25zZS5kYXRhYC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWdyb3VwIENvbXBsZXRpb24gRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHN1Y2Nlc3MocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5LgogICAqICAgYHJlc3BvbnNlLmRhdGFgIHdpbGwgY29udGFpbiB0aGUgcmVzcG9uc2UgZGF0YSBhbmQKICAgKiAgIGByZXNwb25zZS5lcnJvcmAgd2lsbCBiZSBudWxsLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgZXJyb3IoZXJyb3IsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzIGF0IGFueSBwb2ludCBkdXJpbmcgdGhlCiAgICogICByZXF1ZXN0LiBgcmVzcG9uc2UuZXJyb3JgIHdpbGwgY29udGFpbiBkZXRhaWxzIGFib3V0IHRoZSBlcnJvcgogICAqICAgdGhhdCBvY2N1cnJlZC4gYHJlc3BvbnNlLmRhdGFgIHdpbGwgYmUgbnVsbC4KICAgKiAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgY29udGFpbmluZyBkZXRhaWxzIGFib3V0CiAgICogICAgIHRoZSBlcnJvciB0aGF0IG9jY3VycmVkLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgY29tcGxldGUocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbmV2ZXIgYSByZXF1ZXN0IGN5Y2xlIGNvbXBsZXRlcy4gYHJlc3BvbnNlLmVycm9yYAogICAqICAgc2hvdWxkIGJlIGNoZWNrZWQsIHNpbmNlIHRoZSByZXF1ZXN0IG1heSBoYXZlIGZhaWxlZC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWdyb3VwIEhUVFAgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IGh0dHBIZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3BvbnNlLCBzdGF0dXNNZXNzYWdlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gaGVhZGVycyBhcmUgc2VudCBieSB0aGUgcmVtb3RlIHNlcnZlcgogICAqICAgQHBhcmFtIHN0YXR1c0NvZGUgW0ludGVnZXJdIHRoZSBIVFRQIHJlc3BvbnNlIGNvZGUKICAgKiAgIEBwYXJhbSBoZWFkZXJzIFttYXA8U3RyaW5nLFN0cmluZz5dIHRoZSByZXNwb25zZSBoZWFkZXJzCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQHBhcmFtIHN0YXR1c01lc3NhZ2UgW1N0cmluZ10gQSBzdGF0dXMgbWVzc2FnZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBIVFRQCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZSBjb2RlCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGh0dHBEYXRhKGNodW5rLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGRhdGEgaXMgc2VudCBieSB0aGUgcmVtb3RlIHNlcnZlcgogICAqICAgQHBhcmFtIGNodW5rIFtCdWZmZXJdIHRoZSBidWZmZXIgZGF0YSBjb250YWluaW5nIHRoZSBuZXh0IGRhdGEgY2h1bmsKICAgKiAgICAgZnJvbSB0aGUgc2VydmVyCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEEKICAgKgogICAqIEAhZXZlbnQgaHR0cFVwbG9hZFByb2dyZXNzKHByb2dyZXNzLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgaGFzIHVwbG9hZGVkIG1vcmUgZGF0YQogICAqICAgQHBhcmFtIHByb2dyZXNzIFttYXBdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgbG9hZGVkYCBhbmQgYHRvdGFsYCBieXRlcwogICAqICAgICBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAbm90ZSBUaGlzIGV2ZW50IHdpbGwgbm90IGJlIGVtaXR0ZWQgaW4gTm9kZS5qcyAwLjgueC4KICAgKgogICAqIEAhZXZlbnQgaHR0cERvd25sb2FkUHJvZ3Jlc3MocHJvZ3Jlc3MsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBoYXMgZG93bmxvYWRlZCBtb3JlIGRhdGEKICAgKiAgIEBwYXJhbSBwcm9ncmVzcyBbbWFwXSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYGxvYWRlZGAgYW5kIGB0b3RhbGAgYnl0ZXMKICAgKiAgICAgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQG5vdGUgVGhpcyBldmVudCB3aWxsIG5vdCBiZSBlbWl0dGVkIGluIE5vZGUuanMgMC44LnguCiAgICoKICAgKiBAIWV2ZW50IGh0dHBFcnJvcihlcnJvciwgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGZhaWxlZAogICAqICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCB0aGF0IHdhcyB0aHJvd24KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGh0dHBEb25lKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHNlcnZlciBpcyBmaW5pc2hlZCBzZW5kaW5nIGRhdGEKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAc2VlIEFXUy5SZXNwb25zZQogICAqLwogIEFXUy5SZXF1ZXN0ID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSByZXF1ZXN0IGZvciBhbiBvcGVyYXRpb24gb24gYSBnaXZlbiBzZXJ2aWNlIHdpdGgKICAgICAqIGEgc2V0IG9mIGlucHV0IHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQHBhcmFtIHNlcnZpY2UgW0FXUy5TZXJ2aWNlXSB0aGUgc2VydmljZSB0byBwZXJmb3JtIHRoZSBvcGVyYXRpb24gb24KICAgICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG9wZXJhdGlvbiB0byBwZXJmb3JtIG9uIHRoZSBzZXJ2aWNlCiAgICAgKiBAcGFyYW0gcGFyYW1zIFtPYmplY3RdIHBhcmFtZXRlcnMgdG8gc2VuZCB0byB0aGUgb3BlcmF0aW9uLgogICAgICogICBTZWUgdGhlIG9wZXJhdGlvbidzIGRvY3VtZW50YXRpb24gZm9yIHRoZSBmb3JtYXQgb2YgdGhlCiAgICAgKiAgIHBhcmFtZXRlcnMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXF1ZXN0KHNlcnZpY2UsIG9wZXJhdGlvbiwgcGFyYW1zKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IHNlcnZpY2UuZW5kcG9pbnQ7CiAgICAgIHZhciByZWdpb24gPSBzZXJ2aWNlLmNvbmZpZy5yZWdpb247CiAgICAgIHZhciBjdXN0b21Vc2VyQWdlbnQgPSBzZXJ2aWNlLmNvbmZpZy5jdXN0b21Vc2VyQWdlbnQ7CiAgCiAgICAgIC8vIGdsb2JhbCBlbmRwb2ludHMgc2lnbiBhcyB1cy1lYXN0LTEKICAgICAgaWYgKHNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCkgcmVnaW9uID0gJ3VzLWVhc3QtMSc7CiAgCiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluICYmIGRvbWFpbi5hY3RpdmU7CiAgICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7CiAgICAgIHRoaXMub3BlcmF0aW9uID0gb3BlcmF0aW9uOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgdGhpcy5odHRwUmVxdWVzdCA9IG5ldyBBV1MuSHR0cFJlcXVlc3QoZW5kcG9pbnQsIHJlZ2lvbik7CiAgICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoY3VzdG9tVXNlckFnZW50KTsKICAgICAgdGhpcy5zdGFydFRpbWUgPSBzZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCk7CiAgCiAgICAgIHRoaXMucmVzcG9uc2UgPSBuZXcgQVdTLlJlc3BvbnNlKHRoaXMpOwogICAgICB0aGlzLl9hc20gPSBuZXcgQWNjZXB0b3JTdGF0ZU1hY2hpbmUoZnNtLnN0YXRlcywgJ3ZhbGlkYXRlJyk7CiAgICAgIHRoaXMuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSBmYWxzZTsKICAKICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgICB0aGlzLmVtaXQgPSB0aGlzLmVtaXRFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhZ3JvdXAgU2VuZGluZyBhIFJlcXVlc3QKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgc2VuZChjYWxsYmFjayA9IG51bGwpCiAgICAgKiAgIFNlbmRzIHRoZSByZXF1ZXN0IG9iamVjdC4KICAgICAqCiAgICAgKiAgIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICAgKiAgICAgQGNvbnRleHQgW0FXUy5SZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgYmVpbmcgc2VudC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAgICogICAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBhIGNhbGxiYWNrCiAgICAgKiAgICAgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgY29uc29sZS5sb2coZXJyLCBkYXRhKTsgfSk7CiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGggbm8gY2FsbGJhY2sgKHVzaW5nIGV2ZW50IGhhbmRsZXJzKQogICAgICogICAgIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgICAqICAgICByZXF1ZXN0Lm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7IC4uLiB9KTsgLy8gcmVnaXN0ZXIgYSBjYWxsYmFjawogICAgICogICAgIHJlcXVlc3Quc2VuZCgpOwogICAgICovCiAgICBzZW5kOiBmdW5jdGlvbiBzZW5kKGNhbGxiYWNrKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIC8vIGFwcGVuZCB0byB1c2VyIGFnZW50CiAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgnY2FsbGJhY2snKTsKICAgICAgICB0aGlzLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3AsIHJlc3AuZXJyb3IsIHJlc3AuZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhpcy5ydW5UbygpOwogIAogICAgICByZXR1cm4gdGhpcy5yZXNwb25zZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICBwcm9taXNlKCkKICAgICAqICAgU2VuZHMgdGhlIHJlcXVlc3QgYW5kIHJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbihkYXRhKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuCiAgICAgKiAgICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnJvcikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgcmVxdWVzdC4KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3QgdXNpbmcgcHJvbWlzZXMuCiAgICAgKiAgICAgdmFyIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgICAqICAgICB2YXIgcmVzdWx0ID0gcmVxdWVzdC5wcm9taXNlKCk7CiAgICAgKiAgICAgcmVzdWx0LnRoZW4oZnVuY3Rpb24oZGF0YSkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyb3IpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBidWlsZDogZnVuY3Rpb24gYnVpbGQoY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMucnVuVG8oJ3NlbmQnLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcnVuVG86IGZ1bmN0aW9uIHJ1blRvKHN0YXRlLCBkb25lKSB7CiAgICAgIHRoaXMuX2FzbS5ydW5UbyhzdGF0ZSwgZG9uZSwgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQWJvcnRzIGEgcmVxdWVzdCwgZW1pdHRpbmcgdGhlIGVycm9yIGFuZCBjb21wbGV0ZSBldmVudHMuCiAgICAgKgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqIEBleGFtcGxlIEFib3J0aW5nIGEgcmVxdWVzdCBhZnRlciBzZW5kaW5nCiAgICAgKiAgIHZhciBwYXJhbXMgPSB7CiAgICAgKiAgICAgQnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5JywKICAgICAqICAgICBCb2R5OiBCdWZmZXIuYWxsb2MoMTAyNCAqIDEwMjQgKiA1KSAvLyA1TUIgcGF5bG9hZAogICAgICogICB9OwogICAgICogICB2YXIgcmVxdWVzdCA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogICAgICogICByZXF1ZXN0LnNlbmQoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICogICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJFcnJvcjoiLCBlcnIuY29kZSwgZXJyLm1lc3NhZ2UpOwogICAgICogICAgIGVsc2UgY29uc29sZS5sb2coZGF0YSk7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gYWJvcnQgcmVxdWVzdCBpbiAxIHNlY29uZAogICAgICogICBzZXRUaW1lb3V0KHJlcXVlc3QuYWJvcnQuYmluZChyZXF1ZXN0KSwgMTAwMCk7CiAgICAgKgogICAgICogICAvLyBwcmludHMgIkVycm9yOiBSZXF1ZXN0QWJvcnRlZEVycm9yIFJlcXVlc3QgYWJvcnRlZCBieSB1c2VyIgogICAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdIHRoZSBzYW1lIHJlcXVlc3Qgb2JqZWN0LCBmb3IgY2hhaW5pbmcuCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGFib3J0OiBmdW5jdGlvbiBhYm9ydCgpIHsKICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3ZhbGlkYXRlUmVzcG9uc2UnKTsKICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4dHJhY3RFcnJvcicpOwogICAgICB0aGlzLm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24gYWRkQWJvcnRlZEVycm9yKHJlc3ApIHsKICAgICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQgYnkgdXNlcicpLCB7CiAgICAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InLCByZXRyeWFibGU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICBpZiAodGhpcy5odHRwUmVxdWVzdC5zdHJlYW0gJiYgIXRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtLmRpZENhbGxiYWNrKSB7IC8vIGFib3J0IEhUVFAgc3RyZWFtCiAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5zdHJlYW0uYWJvcnQoKTsKICAgICAgICBpZiAodGhpcy5odHRwUmVxdWVzdC5fYWJvcnRDYWxsYmFjaykgewogICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuX2Fib3J0Q2FsbGJhY2soKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3NlbmQnKTsgLy8gaGF2ZW4ndCBzZW50IHlldCwgc28gbGV0J3Mgbm90CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlYWNoIHBhZ2Ugb2YgcmVzdWx0cyBnaXZlbiBhIHBhZ2VhYmxlIHJlcXVlc3QsIGNhbGxpbmcKICAgICAqIHRoZSBwcm92aWRlZCBjYWxsYmFjayB3aXRoIGVhY2ggcGFnZSBvZiBkYXRhLiBBZnRlciBhbGwgcGFnZXMgaGF2ZSBiZWVuCiAgICAgKiByZXRyaWV2ZWQsIHRoZSBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBgbnVsbGAgZGF0YS4KICAgICAqCiAgICAgKiBAbm90ZSBUaGlzIG9wZXJhdGlvbiBjYW4gZ2VuZXJhdGUgbXVsdGlwbGUgcmVxdWVzdHMgdG8gYSBzZXJ2aWNlLgogICAgICogQGV4YW1wbGUgSXRlcmF0aW5nIG92ZXIgbXVsdGlwbGUgcGFnZXMgb2Ygb2JqZWN0cyBpbiBhbiBTMyBidWNrZXQKICAgICAqICAgdmFyIHBhZ2VzID0gMTsKICAgICAqICAgczMubGlzdE9iamVjdHMoKS5lYWNoUGFnZShmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAqICAgICBpZiAoZXJyKSByZXR1cm47CiAgICAgKiAgICAgY29uc29sZS5sb2coIlBhZ2UiLCBwYWdlcysrKTsKICAgICAqICAgICBjb25zb2xlLmxvZyhkYXRhKTsKICAgICAqICAgfSk7CiAgICAgKiBAZXhhbXBsZSBJdGVyYXRpbmcgb3ZlciBtdWx0aXBsZSBwYWdlcyB3aXRoIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjawogICAgICogICBzMy5saXN0T2JqZWN0cyhwYXJhbXMpLmVhY2hQYWdlKGZ1bmN0aW9uKGVyciwgZGF0YSwgZG9uZSkgewogICAgICogICAgIGRvU29tZXRoaW5nQXN5bmNBbmRPckV4cGVuc2l2ZShmdW5jdGlvbigpIHsKICAgICAqICAgICAgIC8vIFRoZSBuZXh0IHBhZ2Ugb2YgcmVzdWx0cyBpc24ndCBmZXRjaGVkIHVudGlsIGRvbmUgaXMgY2FsbGVkCiAgICAgKiAgICAgICBkb25lKCk7CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIH0pOwogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSwgW2RvbmVDYWxsYmFja10pCiAgICAgKiAgIENhbGxlZCB3aXRoIGVhY2ggcGFnZSBvZiByZXN1bHRpbmcgZGF0YSBmcm9tIHRoZSByZXF1ZXN0LiBJZiB0aGUKICAgICAqICAgb3B0aW9uYWwgYGRvbmVDYWxsYmFja2AgaXMgcHJvdmlkZWQgaW4gdGhlIGZ1bmN0aW9uLCBpdCBtdXN0IGJlIGNhbGxlZAogICAgICogICB3aGVuIHRoZSBjYWxsYmFjayBpcyBjb21wbGV0ZS4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBhbiBlcnJvciBvYmplY3QsIGlmIGFuIGVycm9yIG9jY3VycmVkLgogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSBhIHNpbmdsZSBwYWdlIG9mIHJlc3BvbnNlIGRhdGEuIElmIHRoZXJlIGlzIG5vCiAgICAgKiAgICAgbW9yZSBkYXRhLCB0aGlzIG9iamVjdCB3aWxsIGJlIGBudWxsYC4KICAgICAqICAgQHBhcmFtIGRvbmVDYWxsYmFjayBbRnVuY3Rpb25dIGFuIG9wdGlvbmFsIGRvbmUgY2FsbGJhY2suIElmIHRoaXMKICAgICAqICAgICBhcmd1bWVudCBpcyBkZWZpbmVkIGluIHRoZSBmdW5jdGlvbiBkZWNsYXJhdGlvbiwgaXQgc2hvdWxkIGJlIGNhbGxlZAogICAgICogICAgIHdoZW4gdGhlIG5leHQgcGFnZSBpcyByZWFkeSB0byBiZSByZXRyaWV2ZWQuIFRoaXMgaXMgdXNlZnVsIGZvcgogICAgICogICAgIGNvbnRyb2xsaW5nIHNlcmlhbCBwYWdpbmF0aW9uIGFjcm9zcyBhc3luY2hyb25vdXMgb3BlcmF0aW9ucy4KICAgICAqICAgQHJldHVybiBbQm9vbGVhbl0gaWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYGZhbHNlYCwgcGFnaW5hdGlvbiB3aWxsCiAgICAgKiAgICAgc3RvcC4KICAgICAqCiAgICAgKiBAc2VlIEFXUy5SZXF1ZXN0LmVhY2hJdGVtCiAgICAgKiBAc2VlIEFXUy5SZXNwb25zZS5uZXh0UGFnZQogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBlYWNoUGFnZTogZnVuY3Rpb24gZWFjaFBhZ2UoY2FsbGJhY2spIHsKICAgICAgLy8gTWFrZSBhbGwgY2FsbGJhY2tzIGFzeW5jLWlzaAogICAgICBjYWxsYmFjayA9IEFXUy51dGlsLmZuLm1ha2VBc3luYyhjYWxsYmFjaywgMyk7CiAgCiAgICAgIGZ1bmN0aW9uIHdyYXBwZWRDYWxsYmFjayhyZXNwb25zZSkgewogICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcG9uc2UsIHJlc3BvbnNlLmVycm9yLCByZXNwb25zZS5kYXRhLCBmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkgcmV0dXJuOwogIAogICAgICAgICAgaWYgKHJlc3BvbnNlLmhhc05leHRQYWdlKCkpIHsKICAgICAgICAgICAgcmVzcG9uc2UubmV4dFBhZ2UoKS5vbignY29tcGxldGUnLCB3cmFwcGVkQ2FsbGJhY2spLnNlbmQoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcG9uc2UsIG51bGwsIG51bGwsIEFXUy51dGlsLmZuLm5vb3ApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHRoaXMub24oJ2NvbXBsZXRlJywgd3JhcHBlZENhbGxiYWNrKS5zZW5kKCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFbnVtZXJhdGVzIG92ZXIgaW5kaXZpZHVhbCBpdGVtcyBvZiBhIHJlcXVlc3QsIHBhZ2luZyB0aGUgcmVzcG9uc2VzIGlmCiAgICAgKiBuZWNlc3NhcnkuCiAgICAgKgogICAgICogQGFwaSBleHBlcmltZW50YWwKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgZWFjaEl0ZW06IGZ1bmN0aW9uIGVhY2hJdGVtKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgZnVuY3Rpb24gd3JhcHBlZENhbGxiYWNrKGVyciwgZGF0YSkgewogICAgICAgIGlmIChlcnIpIHJldHVybiBjYWxsYmFjayhlcnIsIG51bGwpOwogICAgICAgIGlmIChkYXRhID09PSBudWxsKSByZXR1cm4gY2FsbGJhY2sobnVsbCwgbnVsbCk7CiAgCiAgICAgICAgdmFyIGNvbmZpZyA9IHNlbGYuc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHNlbGYub3BlcmF0aW9uKTsKICAgICAgICB2YXIgcmVzdWx0S2V5ID0gY29uZmlnLnJlc3VsdEtleTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRLZXkpKSByZXN1bHRLZXkgPSByZXN1bHRLZXlbMF07CiAgICAgICAgdmFyIGl0ZW1zID0gam1lc3BhdGguc2VhcmNoKGRhdGEsIHJlc3VsdEtleSk7CiAgICAgICAgdmFyIGNvbnRpbnVlSXRlcmF0aW9uID0gdHJ1ZTsKICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goaXRlbXMsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgIGNvbnRpbnVlSXRlcmF0aW9uID0gY2FsbGJhY2sobnVsbCwgaXRlbSk7CiAgICAgICAgICBpZiAoY29udGludWVJdGVyYXRpb24gPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBBV1MudXRpbC5hYm9ydDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY29udGludWVJdGVyYXRpb247CiAgICAgIH0KICAKICAgICAgdGhpcy5lYWNoUGFnZSh3cmFwcGVkQ2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgb3BlcmF0aW9uIGNhbiByZXR1cm4gbXVsdGlwbGUgcGFnZXMgb2YKICAgICAqICAgcmVzcG9uc2UgZGF0YS4KICAgICAqIEBzZWUgQVdTLlJlc3BvbnNlLmVhY2hQYWdlCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGlzUGFnZWFibGU6IGZ1bmN0aW9uIGlzUGFnZWFibGUoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyh0aGlzLm9wZXJhdGlvbikgPyB0cnVlIDogZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBTZW5kcyB0aGUgcmVxdWVzdCBhbmQgY29udmVydHMgdGhlIHJlcXVlc3Qgb2JqZWN0IGludG8gYSByZWFkYWJsZSBzdHJlYW0KICAgICAqIHRoYXQgY2FuIGJlIHJlYWQgZnJvbSBvciBwaXBlZCBpbnRvIGEgd3JpdGFibGUgc3RyZWFtLgogICAgICoKICAgICAqIEBub3RlIFRoZSBkYXRhIHJlYWQgZnJvbSBhIHJlYWRhYmxlIHN0cmVhbSBjb250YWlucyBvbmx5CiAgICAgKiAgIHRoZSByYXcgSFRUUCBib2R5IGNvbnRlbnRzLgogICAgICogQGV4YW1wbGUgTWFudWFsbHkgcmVhZGluZyBmcm9tIGEgc3RyZWFtCiAgICAgKiAgIHJlcXVlc3QuY3JlYXRlUmVhZFN0cmVhbSgpLm9uKCdkYXRhJywgZnVuY3Rpb24oZGF0YSkgewogICAgICogICAgIGNvbnNvbGUubG9nKCJHb3QgZGF0YToiLCBkYXRhLnRvU3RyaW5nKCkpOwogICAgICogICB9KTsKICAgICAqIEBleGFtcGxlIFBpcGluZyBhIHJlcXVlc3QgYm9keSBpbnRvIGEgZmlsZQogICAgICogICB2YXIgb3V0ID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0oJy9wYXRoL3RvL291dGZpbGUuanBnJyk7CiAgICAgKiAgIHMzLnNlcnZpY2UuZ2V0T2JqZWN0KHBhcmFtcykuY3JlYXRlUmVhZFN0cmVhbSgpLnBpcGUob3V0KTsKICAgICAqIEByZXR1cm4gW1N0cmVhbV0gdGhlIHJlYWRhYmxlIHN0cmVhbSBvYmplY3QgdGhhdCBjYW4gYmUgcGlwZWQKICAgICAqICAgb3IgcmVhZCBmcm9tIChieSByZWdpc3RlcmluZyAnZGF0YScgZXZlbnQgbGlzdGVuZXJzKS4KICAgICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICAgKi8KICAgIGNyZWF0ZVJlYWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVJlYWRTdHJlYW0oKSB7CiAgICAgIHZhciBzdHJlYW1zID0gQVdTLnV0aWwuc3RyZWFtOwogICAgICB2YXIgcmVxID0gdGhpczsKICAgICAgdmFyIHN0cmVhbSA9IG51bGw7CiAgCiAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgIHN0cmVhbSA9IG5ldyBzdHJlYW1zLlBhc3NUaHJvdWdoKCk7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsgcmVxLnNlbmQoKTsgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyZWFtID0gbmV3IHN0cmVhbXMuU3RyZWFtKCk7CiAgICAgICAgc3RyZWFtLnJlYWRhYmxlID0gdHJ1ZTsKICAKICAgICAgICBzdHJlYW0uc2VudCA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5vbignbmV3TGlzdGVuZXInLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgaWYgKCFzdHJlYW0uc2VudCAmJiBldmVudCA9PT0gJ2RhdGEnKSB7CiAgICAgICAgICAgIHN0cmVhbS5zZW50ID0gdHJ1ZTsKICAgICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsgcmVxLnNlbmQoKTsgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICB9KTsKICAKICAgICAgdGhpcy5vbignaHR0cEhlYWRlcnMnLCBmdW5jdGlvbiBzdHJlYW1IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3ApIHsKICAgICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICAgICAgcmVxLnJlbW92ZUxpc3RlbmVyKCdodHRwRGF0YScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQSk7CiAgICAgICAgICByZXEucmVtb3ZlTGlzdGVuZXIoJ2h0dHBFcnJvcicsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfRVJST1IpOwogICAgICAgICAgcmVxLm9uKCdodHRwRXJyb3InLCBmdW5jdGlvbiBzdHJlYW1IdHRwRXJyb3IoZXJyb3IpIHsKICAgICAgICAgICAgcmVzcC5lcnJvciA9IGVycm9yOwogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IGZhbHNlOwogICAgICAgICAgfSk7CiAgCiAgICAgICAgICB2YXIgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICB2YXIgZXhwZWN0ZWRMZW47CiAgICAgICAgICBpZiAocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCAhPT0gJ0hFQUQnKSB7CiAgICAgICAgICAgIGV4cGVjdGVkTGVuID0gcGFyc2VJbnQoaGVhZGVyc1snY29udGVudC1sZW5ndGgnXSwgMTApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4cGVjdGVkTGVuICE9PSB1bmRlZmluZWQgJiYgIWlzTmFOKGV4cGVjdGVkTGVuKSAmJiBleHBlY3RlZExlbiA+PSAwKSB7CiAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IHRydWU7CiAgICAgICAgICAgIHZhciByZWNlaXZlZExlbiA9IDA7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB2YXIgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCA9IGZ1bmN0aW9uIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQoKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggJiYgcmVjZWl2ZWRMZW4gIT09IGV4cGVjdGVkTGVuKSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgICBuZXcgRXJyb3IoJ1N0cmVhbSBjb250ZW50IGxlbmd0aCBtaXNtYXRjaC4gUmVjZWl2ZWQgJyArCiAgICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICsgJyBvZiAnICsgZXhwZWN0ZWRMZW4gKyAnIGJ5dGVzLicpLAogICAgICAgICAgICAgICAgeyBjb2RlOiAnU3RyZWFtQ29udGVudExlbmd0aE1pc21hdGNoJyB9CiAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICAgICAgICBzdHJlYW0uZW5kKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2VuZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogIAogICAgICAgICAgdmFyIGh0dHBTdHJlYW0gPSByZXNwLmh0dHBSZXNwb25zZS5jcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtKCk7CiAgCiAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCkgewogICAgICAgICAgICAgIHZhciBsZW5ndGhBY2N1bXVsYXRvciA9IG5ldyBzdHJlYW1zLlBhc3NUaHJvdWdoKCk7CiAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuX3dyaXRlID0gZnVuY3Rpb24oY2h1bmspIHsKICAgICAgICAgICAgICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKz0gY2h1bmsubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmVhbXMuUGFzc1Rocm91Z2gucHJvdG90eXBlLl93cml0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH07CiAgCiAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3Iub24oJ2VuZCcsIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQpOwogICAgICAgICAgICAgIHN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaHR0cFN0cmVhbS51bnBpcGUobGVuZ3RoQWNjdW11bGF0b3IpOwogICAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuZW1pdCgnZW5kJyk7CiAgICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5lbmQoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBodHRwU3RyZWFtLnBpcGUobGVuZ3RoQWNjdW11bGF0b3IpLnBpcGUoc3RyZWFtLCB7IGVuZDogZmFsc2UgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaHR0cFN0cmVhbS5waXBlKHN0cmVhbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgCiAgICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGgpIHsKICAgICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJnICYmIGFyZy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKz0gYXJnLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2RhdGEnLCBhcmcpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaHR0cFN0cmVhbS5vbignZW5kJywgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBodHRwU3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBzdHJlYW07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcGFyYW0gW0FycmF5LFJlc3BvbnNlXSBhcmdzIFRoaXMgc2hvdWxkIGJlIHRoZSByZXNwb25zZSBvYmplY3QsCiAgICAgKiAgIG9yIGFuIGFycmF5IG9mIGFyZ3MgdG8gc2VuZCB0byB0aGUgZXZlbnQuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZW1pdEV2ZW50OiBmdW5jdGlvbiBlbWl0KGV2ZW50TmFtZSwgYXJncywgZG9uZSkgewogICAgICBpZiAodHlwZW9mIGFyZ3MgPT09ICdmdW5jdGlvbicpIHsgZG9uZSA9IGFyZ3M7IGFyZ3MgPSBudWxsOyB9CiAgICAgIGlmICghZG9uZSkgZG9uZSA9IGZ1bmN0aW9uKCkgeyB9OwogICAgICBpZiAoIWFyZ3MpIGFyZ3MgPSB0aGlzLmV2ZW50UGFyYW1ldGVycyhldmVudE5hbWUsIHRoaXMucmVzcG9uc2UpOwogIAogICAgICB2YXIgb3JpZ0VtaXQgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5lbWl0OwogICAgICBvcmlnRW1pdC5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgYXJncywgZnVuY3Rpb24gKGVycikgewogICAgICAgIGlmIChlcnIpIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgZG9uZS5jYWxsKHRoaXMsIGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV2ZW50UGFyYW1ldGVyczogZnVuY3Rpb24gZXZlbnRQYXJhbWV0ZXJzKGV2ZW50TmFtZSkgewogICAgICBzd2l0Y2ggKGV2ZW50TmFtZSkgewogICAgICAgIGNhc2UgJ3Jlc3RhcnQnOgogICAgICAgIGNhc2UgJ3ZhbGlkYXRlJzoKICAgICAgICBjYXNlICdzaWduJzoKICAgICAgICBjYXNlICdidWlsZCc6CiAgICAgICAgY2FzZSAnYWZ0ZXJWYWxpZGF0ZSc6CiAgICAgICAgY2FzZSAnYWZ0ZXJCdWlsZCc6CiAgICAgICAgICByZXR1cm4gW3RoaXNdOwogICAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICAgIHJldHVybiBbdGhpcy5yZXNwb25zZS5lcnJvciwgdGhpcy5yZXNwb25zZV07CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBbdGhpcy5yZXNwb25zZV07CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwcmVzaWduOiBmdW5jdGlvbiBwcmVzaWduKGV4cGlyZXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIGV4cGlyZXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IGV4cGlyZXM7CiAgICAgICAgZXhwaXJlcyA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBBV1MuU2lnbmVycy5QcmVzaWduKCkuc2lnbih0aGlzLnRvR2V0KCksIGV4cGlyZXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc1ByZXNpZ25lZDogZnVuY3Rpb24gaXNQcmVzaWduZWQoKSB7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5odHRwUmVxdWVzdC5oZWFkZXJzLCAncHJlc2lnbmVkLWV4cGlyZXMnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0b1VuYXV0aGVudGljYXRlZDogZnVuY3Rpb24gdG9VbmF1dGhlbnRpY2F0ZWQoKSB7CiAgICAgIHRoaXMuX3VuQXV0aGVudGljYXRlZCA9IHRydWU7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFMpOwogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdzaWduJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0lHTik7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRvR2V0OiBmdW5jdGlvbiB0b0dldCgpIHsKICAgICAgaWYgKHRoaXMuc2VydmljZS5hcGkucHJvdG9jb2wgPT09ICdxdWVyeScgfHwKICAgICAgICAgIHRoaXMuc2VydmljZS5hcGkucHJvdG9jb2wgPT09ICdlYzInKSB7CiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignYnVpbGQnLCB0aGlzLmJ1aWxkQXNHZXQpOwogICAgICAgIHRoaXMuYWRkTGlzdGVuZXIoJ2J1aWxkJywgdGhpcy5idWlsZEFzR2V0KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBidWlsZEFzR2V0OiBmdW5jdGlvbiBidWlsZEFzR2V0KHJlcXVlc3QpIHsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5tZXRob2QgPSAnR0VUJzsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5wYXRoID0gcmVxdWVzdC5zZXJ2aWNlLmVuZHBvaW50LnBhdGggKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPycgKyByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmJvZHk7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuYm9keSA9ICcnOwogIAogICAgICAvLyBkb24ndCBuZWVkIHRoZXNlIGhlYWRlcnMgb24gYSBHRVQgcmVxdWVzdAogICAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddOwogICAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoYWx0SGFuZGxlcnNPbkVycm9yOiBmdW5jdGlvbiBoYWx0SGFuZGxlcnNPbkVycm9yKCkgewogICAgICB0aGlzLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gdHJ1ZTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUmVxdWVzdC5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHRoaXMucHJvdG90eXBlLnByb21pc2UgPSBmdW5jdGlvbiBwcm9taXNlKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIC8vIGFwcGVuZCB0byB1c2VyIGFnZW50CiAgICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ3Byb21pc2UnKTsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlRGVwZW5kZW5jeShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBzZWxmLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChyZXNwLmVycm9yKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGRlZmluZSAkcmVzcG9uc2UgcHJvcGVydHkgc28gdGhhdCBpdCBpcyBub3QgZW51bWJlcmFibGUKICAgICAgICAgICAgLy8gdGhpcyBwcmV2ZW50cyBjaXJjdWxhciByZWZlcmVuY2UgZXJyb3JzIHdoZW4gc3RyaW5naWZ5aW5nIHRoZSBKU09OIG9iamVjdAogICAgICAgICAgICByZXNvbHZlKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgKICAgICAgICAgICAgICByZXNwLmRhdGEgfHwge30sCiAgICAgICAgICAgICAgJyRyZXNwb25zZScsCiAgICAgICAgICAgICAge3ZhbHVlOiByZXNwfQogICAgICAgICAgICApKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBzZWxmLnJ1blRvKCk7CiAgICAgIH0pOwogICAgfTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5SZXF1ZXN0LmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUucHJvbWlzZTsKICB9OwogIAogIEFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5SZXF1ZXN0KTsKICAKICBBV1MudXRpbC5taXhpbihBV1MuUmVxdWVzdCwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcik7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL3N0YXRlX21hY2hpbmUiOjcwLCJfcHJvY2VzcyI6ODYsImptZXNwYXRoIjo4NX1dLDU2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBDb3B5cmlnaHQgMjAxMi0yMDEzIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAgICoKICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKS4gWW91CiAgICogbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZgogICAqIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXQKICAgKgogICAqICAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXBhY2hlMi4wLwogICAqCiAgICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcwogICAqIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GCiAgICogQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljCiAgICogbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICAgKi8KICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gQ0hFQ0tfQUNDRVBUT1JTKHJlc3ApIHsKICAgIHZhciB3YWl0ZXIgPSByZXNwLnJlcXVlc3QuX3dhaXRlcjsKICAgIHZhciBhY2NlcHRvcnMgPSB3YWl0ZXIuY29uZmlnLmFjY2VwdG9yczsKICAgIHZhciBhY2NlcHRvck1hdGNoZWQgPSBmYWxzZTsKICAgIHZhciBzdGF0ZSA9ICdyZXRyeSc7CiAgCiAgICBhY2NlcHRvcnMuZm9yRWFjaChmdW5jdGlvbihhY2NlcHRvcikgewogICAgICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCkgewogICAgICAgIHZhciBtYXRjaGVyID0gd2FpdGVyLm1hdGNoZXJzW2FjY2VwdG9yLm1hdGNoZXJdOwogICAgICAgIGlmIChtYXRjaGVyICYmIG1hdGNoZXIocmVzcCwgYWNjZXB0b3IuZXhwZWN0ZWQsIGFjY2VwdG9yLmFyZ3VtZW50KSkgewogICAgICAgICAgYWNjZXB0b3JNYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgIHN0YXRlID0gYWNjZXB0b3Iuc3RhdGU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAKICAgIGlmICghYWNjZXB0b3JNYXRjaGVkICYmIHJlc3AuZXJyb3IpIHN0YXRlID0gJ2ZhaWx1cmUnOwogIAogICAgaWYgKHN0YXRlID09PSAnc3VjY2VzcycpIHsKICAgICAgd2FpdGVyLnNldFN1Y2Nlc3MocmVzcCk7CiAgICB9IGVsc2UgewogICAgICB3YWl0ZXIuc2V0RXJyb3IocmVzcCwgc3RhdGUgPT09ICdyZXRyeScpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUmVzb3VyY2VXYWl0ZXIgPSBpbmhlcml0KHsKICAgIC8qKgogICAgICogV2FpdHMgZm9yIGEgZ2l2ZW4gc3RhdGUgb24gYSBzZXJ2aWNlIG9iamVjdAogICAgICogQHBhcmFtIHNlcnZpY2UgW1NlcnZpY2VdIHRoZSBzZXJ2aWNlIG9iamVjdCB0byB3YWl0IG9uCiAgICAgKiBAcGFyYW0gc3RhdGUgW1N0cmluZ10gdGhlIHN0YXRlIChkZWZpbmVkIGluIHdhaXRlciBjb25maWd1cmF0aW9uKSB0byB3YWl0CiAgICAgKiAgIGZvci4KICAgICAqIEBleGFtcGxlIENyZWF0ZSBhIHdhaXRlciBmb3IgcnVubmluZyBFQzIgaW5zdGFuY2VzCiAgICAgKiAgIHZhciBlYzIgPSBuZXcgQVdTLkVDMjsKICAgICAqICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIoZWMyLCAnaW5zdGFuY2VSdW5uaW5nJyk7CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBjb25zdHJ1Y3RvcihzZXJ2aWNlLCBzdGF0ZSkgewogICAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlOwogICAgICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgICAgIHRoaXMubG9hZFdhaXRlckNvbmZpZyh0aGlzLnN0YXRlKTsKICAgIH0sCiAgCiAgICBzZXJ2aWNlOiBudWxsLAogIAogICAgc3RhdGU6IG51bGwsCiAgCiAgICBjb25maWc6IG51bGwsCiAgCiAgICBtYXRjaGVyczogewogICAgICBwYXRoOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHQsZXhwZWN0ZWQpOwogICAgICB9LAogIAogICAgICBwYXRoQWxsOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlc3VsdHMgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHRzKSkgcmVzdWx0cyA9IFtyZXN1bHRzXTsKICAgICAgICB2YXIgbnVtUmVzdWx0cyA9IHJlc3VsdHMubGVuZ3RoOwogICAgICAgIGlmICghbnVtUmVzdWx0cykgcmV0dXJuIGZhbHNlOwogICAgICAgIGZvciAodmFyIGluZCA9IDAgOyBpbmQgPCBudW1SZXN1bHRzOyBpbmQrKykgewogICAgICAgICAgaWYgKCFqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAKICAgICAgcGF0aEFueTogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICAgIGlmIChqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAKICAgICAgc3RhdHVzOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICByZXR1cm4gKHR5cGVvZiBzdGF0dXNDb2RlID09PSAnbnVtYmVyJykgJiYgKHN0YXR1c0NvZGUgPT09IGV4cGVjdGVkKTsKICAgICAgfSwKICAKICAgICAgZXJyb3I6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBleHBlY3RlZCA9PT0gJ3N0cmluZycgJiYgcmVzcC5lcnJvcikgewogICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSByZXNwLmVycm9yLmNvZGU7CiAgICAgICAgfQogICAgICAgIC8vIGlmIGV4cGVjdGVkIGlzIG5vdCBzdHJpbmcsIGNhbiBiZSBib29sZWFuIGluZGljYXRpbmcgcHJlc2VuY2Ugb2YgZXJyb3IKICAgICAgICByZXR1cm4gZXhwZWN0ZWQgPT09ICEhcmVzcC5lcnJvcjsKICAgICAgfQogICAgfSwKICAKICAgIGxpc3RlbmVyczogbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IgJiYgcmVzcC5lcnJvci5jb2RlID09PSAnUmVzb3VyY2VOb3RSZWFkeScpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9ICh3YWl0ZXIuY29uZmlnLmRlbGF5IHx8IDApICogMTAwMDsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0NIRUNLX09VVFBVVCcsICdleHRyYWN0RGF0YScsIENIRUNLX0FDQ0VQVE9SUyk7CiAgCiAgICAgIGFkZCgnQ0hFQ0tfRVJST1InLCAnZXh0cmFjdEVycm9yJywgQ0hFQ0tfQUNDRVBUT1JTKTsKICAgIH0pLAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0KICAgICAqLwogICAgd2FpdDogZnVuY3Rpb24gd2FpdChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7IHBhcmFtcyA9IHVuZGVmaW5lZDsKICAgICAgfQogIAogICAgICBpZiAocGFyYW1zICYmIHBhcmFtcy4kd2FpdGVyKSB7CiAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLiR3YWl0ZXIuZGVsYXkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aGlzLmNvbmZpZy5kZWxheSA9IHBhcmFtcy4kd2FpdGVyLmRlbGF5OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLm1heEF0dGVtcHRzID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhpcy5jb25maWcubWF4QXR0ZW1wdHMgPSBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0czsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHBhcmFtcy4kd2FpdGVyOwogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5zZXJ2aWNlLm1ha2VSZXF1ZXN0KHRoaXMuY29uZmlnLm9wZXJhdGlvbiwgcGFyYW1zKTsKICAgICAgcmVxdWVzdC5fd2FpdGVyID0gdGhpczsKICAgICAgcmVxdWVzdC5yZXNwb25zZS5tYXhSZXRyaWVzID0gdGhpcy5jb25maWcubWF4QXR0ZW1wdHM7CiAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKHRoaXMubGlzdGVuZXJzKTsKICAKICAgICAgaWYgKGNhbGxiYWNrKSByZXF1ZXN0LnNlbmQoY2FsbGJhY2spOwogICAgICByZXR1cm4gcmVxdWVzdDsKICAgIH0sCiAgCiAgICBzZXRTdWNjZXNzOiBmdW5jdGlvbiBzZXRTdWNjZXNzKHJlc3ApIHsKICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgIHJlc3AuZGF0YSA9IHJlc3AuZGF0YSB8fCB7fTsKICAgICAgcmVzcC5yZXF1ZXN0LnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdERhdGEnKTsKICAgIH0sCiAgCiAgICBzZXRFcnJvcjogZnVuY3Rpb24gc2V0RXJyb3IocmVzcCwgcmV0cnlhYmxlKSB7CiAgICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihyZXNwLmVycm9yIHx8IG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ1Jlc291cmNlTm90UmVhZHknLAogICAgICAgIG1lc3NhZ2U6ICdSZXNvdXJjZSBpcyBub3QgaW4gdGhlIHN0YXRlICcgKyB0aGlzLnN0YXRlLAogICAgICAgIHJldHJ5YWJsZTogcmV0cnlhYmxlCiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogTG9hZHMgd2FpdGVyIGNvbmZpZ3VyYXRpb24gZnJvbSBBUEkgY29uZmlndXJhdGlvbgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkV2FpdGVyQ29uZmlnOiBmdW5jdGlvbiBsb2FkV2FpdGVyQ29uZmlnKHN0YXRlKSB7CiAgICAgIGlmICghdGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSkgewogICAgICAgIHRocm93IG5ldyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ1N0YXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnU3RhdGUgJyArIHN0YXRlICsgJyBub3QgZm91bmQuJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHRoaXMuY29uZmlnID0gQVdTLnV0aWwuY29weSh0aGlzLnNlcnZpY2UuYXBpLndhaXRlcnNbc3RhdGVdKTsKICAgIH0KICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOCwiam1lc3BhdGgiOjg1fV0sNTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKICAKICAvKioKICAgKiBUaGlzIGNsYXNzIGVuY2Fwc3VsYXRlcyB0aGUgcmVzcG9uc2UgaW5mb3JtYXRpb24KICAgKiBmcm9tIGEgc2VydmljZSByZXF1ZXN0IG9wZXJhdGlvbiBzZW50IHRocm91Z2gge0FXUy5SZXF1ZXN0fS4KICAgKiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0d28gbWFpbiBwcm9wZXJ0aWVzIGZvciBnZXR0aW5nIGluZm9ybWF0aW9uCiAgICogYmFjayBmcm9tIGEgcmVxdWVzdDoKICAgKgogICAqICMjIFRoZSBgZGF0YWAgcHJvcGVydHkKICAgKgogICAqIFRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkgY29udGFpbnMgdGhlIHNlcmlhbGl6ZWQgb2JqZWN0IGRhdGEKICAgKiByZXRyaWV2ZWQgZnJvbSB0aGUgc2VydmljZSByZXF1ZXN0LiBGb3IgaW5zdGFuY2UsIGZvciBhbgogICAqIEFtYXpvbiBEeW5hbW9EQiBgbGlzdFRhYmxlc2AgbWV0aG9kIGNhbGwsIHRoZSByZXNwb25zZSBkYXRhIG1pZ2h0CiAgICogbG9vayBsaWtlOgogICAqCiAgICogYGBgCiAgICogPiByZXNwLmRhdGEKICAgKiB7IFRhYmxlTmFtZXM6CiAgICogICAgWyAndGFibGUxJywgJ3RhYmxlMicsIC4uLiBdIH0KICAgKiBgYGAKICAgKgogICAqIFRoZSBgZGF0YWAgcHJvcGVydHkgY2FuIGJlIG51bGwgaWYgYW4gZXJyb3Igb2NjdXJzIChzZWUgYmVsb3cpLgogICAqCiAgICogIyMgVGhlIGBlcnJvcmAgcHJvcGVydHkKICAgKgogICAqIEluIHRoZSBldmVudCBvZiBhIHNlcnZpY2UgZXJyb3IgKG9yIHRyYW5zZmVyIGVycm9yKSwgdGhlCiAgICogYHJlc3BvbnNlLmVycm9yYCBwcm9wZXJ0eSB3aWxsIGJlIGZpbGxlZCB3aXRoIHRoZSBnaXZlbgogICAqIGVycm9yIGRhdGEgaW4gdGhlIGZvcm06CiAgICoKICAgKiBgYGAKICAgKiB7IGNvZGU6ICdTSE9SVF9VTklRVUVfRVJST1JfQ09ERScsCiAgICogICBtZXNzYWdlOiAnU29tZSBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlJyB9CiAgICogYGBgCiAgICoKICAgKiBJbiB0aGUgY2FzZSBvZiBhbiBlcnJvciwgdGhlIGBkYXRhYCBwcm9wZXJ0eSB3aWxsIGJlIGBudWxsYC4KICAgKiBOb3RlIHRoYXQgaWYgeW91IGhhbmRsZSBldmVudHMgdGhhdCBjYW4gYmUgaW4gYSBmYWlsdXJlIHN0YXRlLAogICAqIHlvdSBzaG91bGQgYWx3YXlzIGNoZWNrIHdoZXRoZXIgYHJlc3BvbnNlLmVycm9yYCBpcyBzZXQKICAgKiBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgdGhlIGByZXNwb25zZS5kYXRhYCBwcm9wZXJ0eS4KICAgKgogICAqIEAhYXR0cmlidXRlIGRhdGEKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICAgKiAgIEBub3RlIEluc2lkZSBvZiBhIHtBV1MuUmVxdWVzdH5odHRwRGF0YX0gZXZlbnQsIHRoaXMKICAgKiAgICAgcHJvcGVydHkgY29udGFpbnMgYSBzaW5nbGUgcmF3IHBhY2tldCBpbnN0ZWFkIG9mIHRoZQogICAqICAgICBmdWxsIGRlLXNlcmlhbGl6ZWQgc2VydmljZSByZXNwb25zZS4KICAgKiAgIEByZXR1cm4gW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgcmVzcG9uc2UgZGF0YQogICAqICAgICBmcm9tIHRoZSBzZXJ2aWNlLgogICAqCiAgICogQCFhdHRyaWJ1dGUgZXJyb3IKICAgKiAgIEFuIHN0cnVjdHVyZSBjb250YWluaW5nIGluZm9ybWF0aW9uIGFib3V0IGEgc2VydmljZQogICAqICAgb3IgbmV0d29ya2luZyBlcnJvci4KICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICAgKiAgIEBub3RlIFRoaXMgYXR0cmlidXRlIGlzIG9ubHkgZmlsbGVkIGlmIGEgc2VydmljZSBvcgogICAqICAgICBuZXR3b3JraW5nIGVycm9yIG9jY3Vycy4KICAgKiAgIEByZXR1cm4gW0Vycm9yXQogICAqICAgICAqIGNvZGUgW1N0cmluZ10gYSB1bmlxdWUgc2hvcnQgY29kZSByZXByZXNlbnRpbmcgdGhlCiAgICogICAgICAgZXJyb3IgdGhhdCB3YXMgZW1pdHRlZC4KICAgKiAgICAgKiBtZXNzYWdlIFtTdHJpbmddIGEgbG9uZ2VyIGh1bWFuIHJlYWRhYmxlIGVycm9yIG1lc3NhZ2UKICAgKiAgICAgKiByZXRyeWFibGUgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGVycm9yIG1lc3NhZ2UgaXMKICAgKiAgICAgICByZXRyeWFibGUuCiAgICogICAgICogc3RhdHVzQ29kZSBbTnVtZXJpY10gaW4gdGhlIGNhc2Ugb2YgYSByZXF1ZXN0IHRoYXQgcmVhY2hlZCB0aGUgc2VydmljZSwKICAgKiAgICAgICB0aGlzIHZhbHVlIGNvbnRhaW5zIHRoZSByZXNwb25zZSBzdGF0dXMgY29kZS4KICAgKiAgICAgKiB0aW1lIFtEYXRlXSB0aGUgZGF0ZSB0aW1lIG9iamVjdCB3aGVuIHRoZSBlcnJvciBvY2N1cnJlZC4KICAgKiAgICAgKiBob3N0bmFtZSBbU3RyaW5nXSBzZXQgd2hlbiBhIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzIHRvIGVhc2lseQogICAqICAgICAgIGlkZW50aWZ5IHRoZSBlbmRwb2ludCBvZiB0aGUgcmVxdWVzdC4KICAgKiAgICAgKiByZWdpb24gW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICAgKiAgICAgICBpZGVudGlmeSB0aGUgcmVnaW9uIG9mIHRoZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVxdWVzdElkCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSB1bmlxdWUgcmVxdWVzdCBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIHJlc3BvbnNlLgogICAqICAgICBMb2cgdGhpcyB2YWx1ZSB3aGVuIGRlYnVnZ2luZyByZXF1ZXN0cyBmb3IgQVdTIHN1cHBvcnQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZXRyeUNvdW50CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2YgcmV0cmllcyB0aGF0IHdlcmUKICAgKiAgICAgYXR0ZW1wdGVkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVkaXJlY3RDb3VudAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJlZGlyZWN0cyB0aGF0IHdlcmUKICAgKiAgICAgZm9sbG93ZWQgYmVmb3JlIHRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBodHRwUmVzcG9uc2UKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVzcG9uc2VdIHRoZSByYXcgSFRUUCByZXNwb25zZSBvYmplY3QKICAgKiAgICAgY29udGFpbmluZyB0aGUgcmVzcG9uc2UgaGVhZGVycyBhbmQgYm9keSBpbmZvcm1hdGlvbgogICAqICAgICBmcm9tIHRoZSBzZXJ2ZXIuCiAgICoKICAgKiBAc2VlIEFXUy5SZXF1ZXN0CiAgICovCiAgQVdTLlJlc3BvbnNlID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVzcG9uc2UocmVxdWVzdCkgewogICAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgICB0aGlzLmVycm9yID0gbnVsbDsKICAgICAgdGhpcy5yZXRyeUNvdW50ID0gMDsKICAgICAgdGhpcy5yZWRpcmVjdENvdW50ID0gMDsKICAgICAgdGhpcy5odHRwUmVzcG9uc2UgPSBuZXcgQVdTLkh0dHBSZXNwb25zZSgpOwogICAgICBpZiAocmVxdWVzdCkgewogICAgICAgIHRoaXMubWF4UmV0cmllcyA9IHJlcXVlc3Quc2VydmljZS5udW1SZXRyaWVzKCk7CiAgICAgICAgdGhpcy5tYXhSZWRpcmVjdHMgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLm1heFJlZGlyZWN0czsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyByZXF1ZXN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIHJlc3BvbnNlIGRhdGEsIGNhbGxpbmcgdGhlCiAgICAgKiBjYWxsYmFjayB3aXRoIHRoZSBwYWdlIGRhdGEgaWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICBDYWxsZWQgd2hlbiBhIHBhZ2Ugb2YgZGF0YSBpcyByZXR1cm5lZCBmcm9tIHRoZSBuZXh0IHJlcXVlc3QuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gYW4gZXJyb3Igb2JqZWN0LCBpZiBhbiBlcnJvciBvY2N1cnJlZCBpbiB0aGUgcmVxdWVzdAogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgbmV4dCBwYWdlIG9mIGRhdGEsIG9yIG51bGwsIGlmIHRoZXJlIGFyZSBubwogICAgICogICAgIG1vcmUgcGFnZXMgbGVmdC4KICAgICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgZm9yIHRoZSBuZXh0IHBhZ2Ugb2YgZGF0YQogICAgICogQHJldHVybiBbbnVsbF0gaWYgbm8gY2FsbGJhY2sgaXMgcHJvdmlkZWQgYW5kIHRoZXJlIGFyZSBubyBwYWdlcyBsZWZ0CiAgICAgKiAgIHRvIHJldHJpZXZlLgogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBuZXh0UGFnZTogZnVuY3Rpb24gbmV4dFBhZ2UoY2FsbGJhY2spIHsKICAgICAgdmFyIGNvbmZpZzsKICAgICAgdmFyIHNlcnZpY2UgPSB0aGlzLnJlcXVlc3Quc2VydmljZTsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHRoaXMucmVxdWVzdC5vcGVyYXRpb247CiAgICAgIHRyeSB7CiAgICAgICAgY29uZmlnID0gc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdHJ1ZSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsgdGhpcy5lcnJvciA9IGU7IH0KICAKICAgICAgaWYgKCF0aGlzLmhhc05leHRQYWdlKCkpIHsKICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMuZXJyb3IsIG51bGwpOwogICAgICAgIGVsc2UgaWYgKHRoaXMuZXJyb3IpIHRocm93IHRoaXMuZXJyb3I7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAKICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkodGhpcy5yZXF1ZXN0LnBhcmFtcyk7CiAgICAgIGlmICghdGhpcy5uZXh0UGFnZVRva2VucykgewogICAgICAgIHJldHVybiBjYWxsYmFjayA/IGNhbGxiYWNrKG51bGwsIG51bGwpIDogbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaW5wdXRUb2tlbnMgPSBjb25maWcuaW5wdXRUb2tlbjsKICAgICAgICBpZiAodHlwZW9mIGlucHV0VG9rZW5zID09PSAnc3RyaW5nJykgaW5wdXRUb2tlbnMgPSBbaW5wdXRUb2tlbnNdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXRUb2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBhcmFtc1tpbnB1dFRva2Vuc1tpXV0gPSB0aGlzLm5leHRQYWdlVG9rZW5zW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLnJlcXVlc3Qub3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBtb3JlIHBhZ2VzIG9mIGRhdGEgY2FuIGJlIHJldHVybmVkIGJ5IGZ1cnRoZXIKICAgICAqICAgcmVxdWVzdHMKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgaGFzTmV4dFBhZ2U6IGZ1bmN0aW9uIGhhc05leHRQYWdlKCkgewogICAgICB0aGlzLmNhY2hlTmV4dFBhZ2VUb2tlbnMoKTsKICAgICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5uZXh0UGFnZVRva2VucyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICBlbHNlIHJldHVybiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWNoZU5leHRQYWdlVG9rZW5zOiBmdW5jdGlvbiBjYWNoZU5leHRQYWdlVG9rZW5zKCkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsICduZXh0UGFnZVRva2VucycpKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHVuZGVmaW5lZDsKICAKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMucmVxdWVzdC5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbik7CiAgICAgIGlmICghY29uZmlnKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAKICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IG51bGw7CiAgICAgIGlmIChjb25maWcubW9yZVJlc3VsdHMpIHsKICAgICAgICBpZiAoIWptZXNwYXRoLnNlYXJjaCh0aGlzLmRhdGEsIGNvbmZpZy5tb3JlUmVzdWx0cykpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgZXhwcnMgPSBjb25maWcub3V0cHV0VG9rZW47CiAgICAgIGlmICh0eXBlb2YgZXhwcnMgPT09ICdzdHJpbmcnKSBleHBycyA9IFtleHByc107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGV4cHJzLCBmdW5jdGlvbiAoZXhwcikgewogICAgICAgIHZhciBvdXRwdXQgPSBqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBleHByKTsKICAgICAgICBpZiAob3V0cHV0KSB7CiAgICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gdGhpcy5uZXh0UGFnZVRva2VucyB8fCBbXTsKICAgICAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMucHVzaChvdXRwdXQpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgfQogIAogIH0pOwogIAogIH0seyIuL2NvcmUiOjE4LCJqbWVzcGF0aCI6ODV9XSw1ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEAhbWV0aG9kIG9uKGV2ZW50TmFtZSwgY2FsbGJhY2spCiAgICogICBSZWdpc3RlcnMgYW4gZXZlbnQgbGlzdGVuZXIgY2FsbGJhY2sgZm9yIHRoZSBldmVudCBnaXZlbiBieSBgZXZlbnROYW1lYC4KICAgKiAgIFBhcmFtZXRlcnMgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBkZXBlbmQgb24gdGhlIGluZGl2aWR1YWwgZXZlbnQKICAgKiAgIGJlaW5nIHRyaWdnZXJlZC4gU2VlIHRoZSBldmVudCBkb2N1bWVudGF0aW9uIGZvciB0aG9zZSBwYXJhbWV0ZXJzLgogICAqCiAgICogICBAcGFyYW0gZXZlbnROYW1lIFtTdHJpbmddIHRoZSBldmVudCBuYW1lIHRvIHJlZ2lzdGVyIHRoZSBsaXN0ZW5lciBmb3IKICAgKiAgIEBwYXJhbSBjYWxsYmFjayBbRnVuY3Rpb25dIHRoZSBsaXN0ZW5lciBjYWxsYmFjayBmdW5jdGlvbgogICAqICAgQHBhcmFtIHRvSGVhZCBbQm9vbGVhbl0gYXR0YWNoIHRoZSBsaXN0ZW5lciBjYWxsYmFjayB0byB0aGUgaGVhZCBvZiBjYWxsYmFjayBhcnJheSBpZiBzZXQgdG8gdHJ1ZS4KICAgKiAgICAgRGVmYXVsdCB0byBiZSBmYWxzZS4KICAgKiAgIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBzYW1lIG9iamVjdCBmb3IgY2hhaW5pbmcKICAgKi8KICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VxdWVudGlhbEV4ZWN1dG9yKCkgewogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsaXN0ZW5lcnM6IGZ1bmN0aW9uIGxpc3RlbmVycyhldmVudE5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdID8gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0uc2xpY2UoMCkgOiBbXTsKICAgIH0sCiAgCiAgICBvbjogZnVuY3Rpb24gb24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICAgIGlmICh0aGlzLl9ldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgIHRvSGVhZCA/CiAgICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS51bnNoaWZ0KGxpc3RlbmVyKSA6CiAgICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA9IFtsaXN0ZW5lcl07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgb25Bc3luYzogZnVuY3Rpb24gb25Bc3luYyhldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpIHsKICAgICAgbGlzdGVuZXIuX2lzQXN5bmMgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5vbihldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpOwogICAgfSwKICAKICAgIHJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgaWYgKGxpc3RlbmVycykgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICAgIHZhciBwb3NpdGlvbiA9IC0xOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaV0gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBvc2l0aW9uID4gLTEpIHsKICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICByZW1vdmVBbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyhldmVudE5hbWUpIHsKICAgICAgaWYgKGV2ZW50TmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbWl0OiBmdW5jdGlvbiBlbWl0KGV2ZW50TmFtZSwgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spIHsKICAgICAgaWYgKCFkb25lQ2FsbGJhY2spIGRvbmVDYWxsYmFjayA9IGZ1bmN0aW9uKCkgeyB9OwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnMoZXZlbnROYW1lKTsKICAgICAgdmFyIGNvdW50ID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgdGhpcy5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spOwogICAgICByZXR1cm4gY291bnQgPiAwOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIGNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIHByZXZFcnJvcikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBlcnJvciA9IHByZXZFcnJvciB8fCBudWxsOwogIAogICAgICBmdW5jdGlvbiBjYWxsTmV4dExpc3RlbmVyKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgICBpZiAoc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgICByZXR1cm4gZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZWxmLmNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIGVycm9yKTsKICAgICAgfQogIAogICAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgbGlzdGVuZXIgPSBsaXN0ZW5lcnMuc2hpZnQoKTsKICAgICAgICBpZiAobGlzdGVuZXIuX2lzQXN5bmMpIHsgLy8gYXN5bmNocm9ub3VzIGxpc3RlbmVyCiAgICAgICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChbY2FsbE5leHRMaXN0ZW5lcl0pKTsKICAgICAgICAgIHJldHVybjsgLy8gc3RvcCBoZXJlLCBjYWxsTmV4dExpc3RlbmVyIHdpbGwgY29udGludWUKICAgICAgICB9IGVsc2UgeyAvLyBzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwgZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlcnJvciAmJiBzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yKSB7CiAgICAgICAgICAgIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBZGRzIG9yIGNvcGllcyBhIHNldCBvZiBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGxpc3Qgb2YKICAgICAqIGxpc3RlbmVycyBvciBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSBsaXN0ZW5lcnMgW21hcDxTdHJpbmcsQXJyYXk8RnVuY3Rpb24+PiwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0KICAgICAqICAgYSBsaXN0IG9mIGV2ZW50cyBhbmQgY2FsbGJhY2tzLCBvciBhbiBldmVudCBlbWl0dGVyIG9iamVjdAogICAgICogICBjb250YWluaW5nIGxpc3RlbmVycyB0byBhZGQgdG8gdGhpcyBlbWl0dGVyIG9iamVjdC4KICAgICAqIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBlbWl0dGVyIG9iamVjdCwgZm9yIGNoYWluaW5nLgogICAgICogQGV4YW1wbGUgQWRkaW5nIGxpc3RlbmVycyBmcm9tIGEgbWFwIG9mIGxpc3RlbmVycwogICAgICogICBlbWl0dGVyLmFkZExpc3RlbmVycyh7CiAgICAgKiAgICAgZXZlbnQxOiBbZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbigpIHsgLi4uIH1dLAogICAgICogICAgIGV2ZW50MjogW2Z1bmN0aW9uKCkgeyAuLi4gfV0KICAgICAqICAgfSk7CiAgICAgKiAgIGVtaXR0ZXIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIgaGFzIGV2ZW50MQogICAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyIGhhcyBldmVudDIKICAgICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGVtaXR0ZXIgb2JqZWN0CiAgICAgKiAgIHZhciBlbWl0dGVyMSA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICAgKiAgIGVtaXR0ZXIxLm9uKCdldmVudDEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICBlbWl0dGVyMS5vbignZXZlbnQyJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgdmFyIGVtaXR0ZXIyID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAgICAqICAgZW1pdHRlcjIuYWRkTGlzdGVuZXJzKGVtaXR0ZXIxKTsKICAgICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDEKICAgICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQyJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDIKICAgICAqLwogICAgYWRkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGRMaXN0ZW5lcnMobGlzdGVuZXJzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgLy8gZXh0cmFjdCBsaXN0ZW5lcnMgaWYgcGFyYW1ldGVyIGlzIGFuIFNlcXVlbnRpYWxFeGVjdXRvciBvYmplY3QKICAgICAgaWYgKGxpc3RlbmVycy5fZXZlbnRzKSBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuX2V2ZW50czsKICAKICAgICAgQVdTLnV0aWwuZWFjaChsaXN0ZW5lcnMsIGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFja3MpIHsKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrcyA9PT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2tzID0gW2NhbGxiYWNrc107CiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKGNhbGxiYWNrcywgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHNlbGYub24oZXZlbnQsIGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBzZWxmOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVnaXN0ZXJzIGFuIGV2ZW50IHdpdGgge29ufSBhbmQgc2F2ZXMgdGhlIGNhbGxiYWNrIGhhbmRsZSBmdW5jdGlvbgogICAgICogYXMgYSBwcm9wZXJ0eSBvbiB0aGUgZW1pdHRlciBvYmplY3QgdXNpbmcgYSBnaXZlbiBgbmFtZWAuCiAgICAgKgogICAgICogQHBhcmFtIG5hbWUgW1N0cmluZ10gdGhlIHByb3BlcnR5IG5hbWUgdG8gc2V0IG9uIHRoaXMgb2JqZWN0IGNvbnRhaW5pbmcKICAgICAqICAgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGhhbmRsZSBzbyB0aGF0IHRoZSBsaXN0ZW5lciBjYW4gYmUgcmVtb3ZlZCBpbgogICAgICogICB0aGUgZnV0dXJlLgogICAgICogQHBhcmFtIChzZWUgb24pCiAgICAgKiBAcmV0dXJuIChzZWUgb24pCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBuYW1lZCBsaXN0ZW5lciBEQVRBX0NBTExCQUNLCiAgICAgKiAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKCkgeyBkb1NvbWV0aGluZygpOyB9OwogICAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXIoJ0RBVEFfQ0FMTEJBQ0snLCAnZGF0YScsIGxpc3RlbmVyKTsKICAgICAqCiAgICAgKiAgIC8vIHRoZSBmb2xsb3dpbmcgcHJpbnRzOiB0cnVlCiAgICAgKiAgIGNvbnNvbGUubG9nKGVtaXR0ZXIuREFUQV9DQUxMQkFDSyA9PSBsaXN0ZW5lcik7CiAgICAgKi8KICAgIGFkZE5hbWVkTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICAgIHRoaXNbbmFtZV0gPSBjYWxsYmFjazsKICAgICAgdGhpcy5hZGRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGROYW1lZEFzeW5jTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkQXN5bmNMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpIHsKICAgICAgY2FsbGJhY2suX2lzQXN5bmMgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5hZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBIZWxwZXIgbWV0aG9kIHRvIGFkZCBhIHNldCBvZiBuYW1lZCBsaXN0ZW5lcnMgdXNpbmcKICAgICAqIHthZGROYW1lZExpc3RlbmVyfS4gVGhlIGNhbGxiYWNrIGNvbnRhaW5zIGEgcGFyYW1ldGVyCiAgICAgKiB3aXRoIGEgaGFuZGxlIHRvIHRoZSBgYWRkTmFtZWRMaXN0ZW5lcmAgbWV0aG9kLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihhZGQpCiAgICAgKiAgIFRoZSBjYWxsYmFjayBmdW5jdGlvbiBpcyBjYWxsZWQgaW1tZWRpYXRlbHkgaW4gb3JkZXIgdG8gcHJvdmlkZQogICAgICogICB0aGUgYGFkZGAgZnVuY3Rpb24gdG8gdGhlIGJsb2NrLiBUaGlzIHNpbXBsaWZpZXMgdGhlIGFkZGl0aW9uIG9mCiAgICAgKiAgIGEgbGFyZ2UgZ3JvdXAgb2YgbmFtZWQgbGlzdGVuZXJzLgogICAgICogICBAcGFyYW0gYWRkIFtGdW5jdGlvbl0gdGhlIHthZGROYW1lZExpc3RlbmVyfSBmdW5jdGlvbiB0byBjYWxsCiAgICAgKiAgICAgd2hlbiByZWdpc3RlcmluZyBsaXN0ZW5lcnMuCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzCiAgICAgKiAgIGVtaXR0ZXIuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgKiAgICAgYWRkKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICAgIGFkZCgnT1RIRVInLCAnb3RoZXJFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgICAgYWRkKCdMQVNUJywgJ2xhc3RFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gdGhlc2UgcHJvcGVydGllcyBhcmUgbm93IHNldDoKICAgICAqICAgZW1pdHRlci5EQVRBX0NBTExCQUNLOwogICAgICogICBlbWl0dGVyLk9USEVSOwogICAgICogICBlbWl0dGVyLkxBU1Q7CiAgICAgKi8KICAgIGFkZE5hbWVkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVycyhjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGNhbGxiYWNrKAogICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5hZGROYW1lZExpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuYWRkTmFtZWRBc3luY0xpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiB7b259IGlzIHRoZSBwcmVmZXJlZCBtZXRob2QuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5vbjsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3I7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSw1OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBBcGkgPSByZXF1aXJlKCcuL21vZGVsL2FwaScpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWcnKTsKICAKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGNsaWVudENvdW50ID0gMDsKICAKICAvKioKICAgKiBUaGUgc2VydmljZSBjbGFzcyByZXByZXNlbnRpbmcgYW4gQVdTIHNlcnZpY2UuCiAgICoKICAgKiBAY2xhc3NfYWJzdHJhY3QgVGhpcyBjbGFzcyBpcyBhbiBhYnN0cmFjdCBjbGFzcy4KICAgKgogICAqIEAhYXR0cmlidXRlIGFwaVZlcnNpb25zCiAgICogICBAcmV0dXJuIFtBcnJheTxTdHJpbmc+XSB0aGUgbGlzdCBvZiBBUEkgdmVyc2lvbnMgc3VwcG9ydGVkIGJ5IHRoaXMgc2VydmljZS4KICAgKiAgIEByZWFkb25seQogICAqLwogIEFXUy5TZXJ2aWNlID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIENyZWF0ZSBhIG5ldyBzZXJ2aWNlIG9iamVjdCB3aXRoIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0gY29uZmlnIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VydmljZShjb25maWcpIHsKICAgICAgaWYgKCF0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICdTZXJ2aWNlIG11c3QgYmUgY29uc3RydWN0ZWQgd2l0aCBgbmV3XCcgb3BlcmF0b3InKTsKICAgICAgfQogICAgICB2YXIgU2VydmljZUNsYXNzID0gdGhpcy5sb2FkU2VydmljZUNsYXNzKGNvbmZpZyB8fCB7fSk7CiAgICAgIGlmIChTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB2YXIgb3JpZ2luYWxDb25maWcgPSBBV1MudXRpbC5jb3B5KGNvbmZpZyk7CiAgICAgICAgdmFyIHN2YyA9IG5ldyBTZXJ2aWNlQ2xhc3MoY29uZmlnKTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc3ZjLCAnX29yaWdpbmFsQ29uZmlnJywgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG9yaWdpbmFsQ29uZmlnOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9KTsKICAgICAgICBzdmMuX2NsaWVudElkID0gKytjbGllbnRDb3VudDsKICAgICAgICByZXR1cm4gc3ZjOwogICAgICB9CiAgICAgIHRoaXMuaW5pdGlhbGl6ZShjb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoY29uZmlnKSB7CiAgICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW3RoaXMuc2VydmljZUlkZW50aWZpZXJdOwogICAgICB0aGlzLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKEFXUy5jb25maWcpOwogICAgICBpZiAoc3ZjQ29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoc3ZjQ29uZmlnLCB0cnVlKTsKICAgICAgaWYgKGNvbmZpZykgdGhpcy5jb25maWcudXBkYXRlKGNvbmZpZywgdHJ1ZSk7CiAgCiAgICAgIHRoaXMudmFsaWRhdGVTZXJ2aWNlKCk7CiAgICAgIGlmICghdGhpcy5jb25maWcuZW5kcG9pbnQpIHJlZ2lvbkNvbmZpZyh0aGlzKTsKICAKICAgICAgdGhpcy5jb25maWcuZW5kcG9pbnQgPSB0aGlzLmVuZHBvaW50RnJvbVRlbXBsYXRlKHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgICAgdGhpcy5zZXRFbmRwb2ludCh0aGlzLmNvbmZpZy5lbmRwb2ludCk7CiAgICAgIC8vZW5hYmxlIGF0dGFjaGluZyBsaXN0ZW5lcnMgdG8gc2VydmljZSBjbGllbnQKICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyh0aGlzKTsKICAgICAgaWYgKCh0aGlzLmNvbmZpZy5jbGllbnRTaWRlTW9uaXRvcmluZyB8fCBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcpICYmIHRoaXMucHVibGlzaGVyKSB7CiAgICAgICAgdmFyIHB1Ymxpc2hlciA9IHRoaXMucHVibGlzaGVyOwogICAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQ0FMTCcsICdhcGlDYWxsJywgZnVuY3Rpb24gUFVCTElTSF9BUElfQ0FMTChldmVudCkgewogICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtwdWJsaXNoZXIuZXZlbnRIYW5kbGVyKGV2ZW50KTt9KTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmFkZE5hbWVkTGlzdGVuZXIoJ1BVQkxJU0hfQVBJX0FUVEVNUFQnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9BVFRFTVBUKGV2ZW50KSB7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZFNlcnZpY2VDbGFzczogZnVuY3Rpb24gbG9hZFNlcnZpY2VDbGFzcyhzZXJ2aWNlQ29uZmlnKSB7CiAgICAgIHZhciBjb25maWcgPSBzZXJ2aWNlQ29uZmlnOwogICAgICBpZiAoIUFXUy51dGlsLmlzRW1wdHkodGhpcy5hcGkpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLmFwaUNvbmZpZykgewogICAgICAgIHJldHVybiBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlQXBpKHRoaXMuY29uc3RydWN0b3IsIGNvbmZpZy5hcGlDb25maWcpOwogICAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICAgICAgY29uZmlnLnVwZGF0ZShzZXJ2aWNlQ29uZmlnLCB0cnVlKTsKICAgICAgICB2YXIgdmVyc2lvbiA9IGNvbmZpZy5hcGlWZXJzaW9uc1t0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyXTsKICAgICAgICB2ZXJzaW9uID0gdmVyc2lvbiB8fCBjb25maWcuYXBpVmVyc2lvbjsKICAgICAgICByZXR1cm4gdGhpcy5nZXRMYXRlc3RTZXJ2aWNlQ2xhc3ModmVyc2lvbik7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRMYXRlc3RTZXJ2aWNlQ2xhc3M6IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKSB7CiAgICAgIHZlcnNpb24gPSB0aGlzLmdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pOwogICAgICBpZiAodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXSA9PT0gbnVsbCkgewogICAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgdmVyc2lvbik7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXNbdmVyc2lvbl07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0TGF0ZXN0U2VydmljZVZlcnNpb246IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pIHsKICAgICAgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzIHx8IHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzZXJ2aWNlcyBkZWZpbmVkIG9uICcgKwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyKTsKICAgICAgfQogIAogICAgICBpZiAoIXZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gJ2xhdGVzdCc7CiAgICAgIH0gZWxzZSBpZiAoQVdTLnV0aWwuaXNUeXBlKHZlcnNpb24sIERhdGUpKSB7CiAgICAgICAgdmVyc2lvbiA9IEFXUy51dGlsLmRhdGUuaXNvODYwMSh2ZXJzaW9uKS5zcGxpdCgnVCcpWzBdOwogICAgICB9CiAgCiAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgICByZXR1cm4gdmVyc2lvbjsKICAgICAgfQogIAogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpLnNvcnQoKTsKICAgICAgdmFyIHNlbGVjdGVkVmVyc2lvbiA9IG51bGw7CiAgICAgIGZvciAodmFyIGkgPSBrZXlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgLy8gdmVyc2lvbnMgdGhhdCBlbmQgaW4gIioiIGFyZSBub3QgYXZhaWxhYmxlIG9uIGRpc2sgYW5kIGNhbiBiZQogICAgICAgIC8vIHNraXBwZWQsIHNvIGRvIG5vdCBjaG9vc2UgdGhlc2UgYXMgc2VsZWN0ZWRWZXJzaW9ucwogICAgICAgIGlmIChrZXlzW2ldW2tleXNbaV0ubGVuZ3RoIC0gMV0gIT09ICcqJykgewogICAgICAgICAgc2VsZWN0ZWRWZXJzaW9uID0ga2V5c1tpXTsKICAgICAgICB9CiAgICAgICAgaWYgKGtleXNbaV0uc3Vic3RyKDAsIDEwKSA8PSB2ZXJzaW9uKSB7CiAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRWZXJzaW9uOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kICcgKyB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyICsKICAgICAgICAgICAgICAgICAgICAgICcgQVBJIHRvIHNhdGlzZnkgdmVyc2lvbiBjb25zdHJhaW50IGAnICsgdmVyc2lvbiArICdcJycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaToge30sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZhdWx0UmV0cnlDb3VudDogMywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGN1c3RvbWl6ZVJlcXVlc3RzOiBmdW5jdGlvbiBjdXN0b21pemVSZXF1ZXN0cyhjYWxsYmFjaykgewogICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IGNhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjYWxsYmFjayB0eXBlIFwnJyArIHR5cGVvZiBjYWxsYmFjayArICdcJyBwcm92aWRlZCBpbiBjdXN0b21pemVSZXF1ZXN0cycpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgbmFtZSBvZiB0aGUgb3BlcmF0aW9uIHRvIGNhbGwgb24gdGhlIHNlcnZpY2UuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIGlucHV0IG9wdGlvbnMgZm9yIHRoZSBvcGVyYXRpb24KICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIG1ha2VSZXF1ZXN0OiBmdW5jdGlvbiBtYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgICBwYXJhbXMgPSBudWxsOwogICAgICB9CiAgCiAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgaWYgKHRoaXMuY29uZmlnLnBhcmFtcykgeyAvLyBjb3B5IG9ubHkgdG9wbGV2ZWwgYm91bmQgcGFyYW1zCiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dOwogICAgICAgIGlmIChydWxlcykgewogICAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLmNvbmZpZy5wYXJhbXMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHJ1bGVzLmlucHV0Lm1lbWJlcnNba2V5XSkgewogICAgICAgICAgICAgIGlmIChwYXJhbXNba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtc1trZXldID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gbmV3IEFXUy5SZXF1ZXN0KHRoaXMsIG9wZXJhdGlvbiwgcGFyYW1zKTsKICAgICAgdGhpcy5hZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICB0aGlzLmF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpOwogICAgICBpZiAoY2FsbGJhY2spIHJlcXVlc3Quc2VuZChjYWxsYmFjayk7CiAgICAgIHJldHVybiByZXF1ZXN0OwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2FsbHMgYW4gb3BlcmF0aW9uIG9uIGEgc2VydmljZSB3aXRoIHRoZSBnaXZlbiBpbnB1dCBwYXJhbWV0ZXJzLCB3aXRob3V0CiAgICAgKiBhbnkgYXV0aGVudGljYXRpb24gZGF0YS4gVGhpcyBtZXRob2QgaXMgdXNlZnVsIGZvciAicHVibGljIiBBUEkgb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICAgIHBhcmFtcyA9IHt9OwogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5tYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcykudG9VbmF1dGhlbnRpY2F0ZWQoKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrID8gcmVxdWVzdC5zZW5kKGNhbGxiYWNrKSA6IHJlcXVlc3Q7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBXYWl0cyBmb3IgYSBnaXZlbiBzdGF0ZQogICAgICoKICAgICAqIEBwYXJhbSBzdGF0ZSBbU3RyaW5nXSB0aGUgc3RhdGUgb24gdGhlIHNlcnZpY2UgdG8gd2FpdCBmb3IKICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgcGFyYW1ldGVycyB0byBwYXNzIHdpdGggZWFjaCByZXF1ZXN0CiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHdhaXRlcgogICAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlci5kZWxheSBbTnVtYmVyXSBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdG8gd2FpdCBiZXR3ZWVuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzCiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLm1heEF0dGVtcHRzIFtOdW1iZXJdIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZXF1ZXN0cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBzZW5kIHdoaWxlIHdhaXRpbmcKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIHdhaXRGb3I6IGZ1bmN0aW9uIHdhaXRGb3Ioc3RhdGUsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIodGhpcywgc3RhdGUpOwogICAgICByZXR1cm4gd2FpdGVyLndhaXQocGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkQWxsUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gYWRkQWxsUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICAgIHZhciBsaXN0ID0gW0FXUy5ldmVudHMsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLCB0aGlzLnNlcnZpY2VJbnRlcmZhY2UoKSwKICAgICAgICAgICAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmVQb3N0XTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGxpc3RbaV0pIHJlcXVlc3QuYWRkTGlzdGVuZXJzKGxpc3RbaV0pOwogICAgICB9CiAgCiAgICAgIC8vIGRpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24KICAgICAgaWYgKCF0aGlzLmNvbmZpZy5wYXJhbVZhbGlkYXRpb24pIHsKICAgICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5jb25maWcubG9nZ2VyKSB7IC8vIGFkZCBsb2dnaW5nIGV2ZW50cwogICAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKEFXUy5FdmVudExpc3RlbmVycy5Mb2dnZXIpOwogICAgICB9CiAgCiAgICAgIHRoaXMuc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICAvLyBjYWxsIHByb3RvdHlwZSdzIGN1c3RvbVJlcXVlc3RIYW5kbGVyCiAgICAgIGlmICh0eXBlb2YgdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgICAgfQogICAgICAvLyBjYWxsIGluc3RhbmNlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnY3VzdG9tUmVxdWVzdEhhbmRsZXInKSAmJiB0eXBlb2YgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIocmVxdWVzdCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhIHdob2xlIEFQSSBjYWxsLgogICAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUNhbGxFdmVudDogZnVuY3Rpb24gYXBpQ2FsbEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGwnLAogICAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgICBWZXJzaW9uOiAxLAogICAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgICAgUmVnaW9uOiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgICBNYXhSZXRyaWVzRXhjZWVkZWQ6IDAsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuRmluYWxIdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5lcnJvcikgewogICAgICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgaWYgKHN0YXR1c0NvZGUgPiAyOTkpIHsKICAgICAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxBd3NFeGNlcHRpb24gPSBlcnJvci5jb2RlOwogICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFdmVudCByZWNvcmRpbmcgbWV0cmljcyBmb3IgYW4gQVBJIGNhbGwgYXR0ZW1wdC4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGEgc3Vic2V0IG9mIGFwaSBjYWxsIGF0dGVtcHQgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUF0dGVtcHRFdmVudDogZnVuY3Rpb24gYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGxBdHRlbXB0JywKICAgICAgICBBcGk6IGFwaSA/IGFwaS5uYW1lIDogcmVxdWVzdC5vcGVyYXRpb24sCiAgICAgICAgVmVyc2lvbjogMSwKICAgICAgICBTZXJ2aWNlOiByZXF1ZXN0LnNlcnZpY2UuYXBpLnNlcnZpY2VJZCB8fCByZXF1ZXN0LnNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICAgIEZxZG46IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuSHR0cFN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgfQogICAgICBpZiAoCiAgICAgICAgIXJlcXVlc3QuX3VuQXV0aGVudGljYXRlZCAmJgogICAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgJiYKICAgICAgICByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkCiAgICAgICkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5BY2Nlc3NLZXkgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgICB9CiAgICAgIGlmICghcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnMpIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICAgIGlmIChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuU2Vzc2lvblRva2VuID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpuUmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16UmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16SWQyID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXTsKICAgICAgfQogICAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQWRkIG1ldHJpY3Mgb2YgZmFpbGVkIHJlcXVlc3QuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0ZW1wdEZhaWxFdmVudDogZnVuY3Rpb24gYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KSB7CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB0aGlzLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA+IDI5OSApIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5Bd3NFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uID0gZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lOwogICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEF0dGFjaCBsaXN0ZW5lcnMgdG8gcmVxdWVzdCBvYmplY3QgdG8gZmV0Y2ggbWV0cmljcyBvZiBlYWNoIHJlcXVlc3QKICAgICAqIGFuZCBlbWl0IGRhdGEgb2JqZWN0IHRocm91Z2ggXCdBcGlDYWxsXCcgYW5kIFwnQXBpQ2FsbEF0dGVtcHRcJyBldmVudHMuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXI6IGZ1bmN0aW9uIGF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpIHsKICAgICAgdmFyIGF0dGVtcHRUaW1lc3RhbXA7IC8vdGltZXN0YW1wIG1hcmtpbmcgdGhlIGJlZ2lubmluZyBvZiBhIHJlcXVlc3QgYXR0ZW1wdAogICAgICB2YXIgYXR0ZW1wdFN0YXJ0UmVhbFRpbWU7IC8vU3RhcnQgdGltZSBvZiByZXF1ZXN0IGF0dGVtcHQuIFVzZWQgdG8gY2FsY3VsYXRpbmcgYXR0ZW1wdExhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRMYXRlbmN5OyAvL2xhdGVuY3kgZnJvbSByZXF1ZXN0IHNlbnQgb3V0IHRvIGh0dHAgcmVzcG9uc2UgcmVhY2hpbmcgU0RLCiAgICAgIHZhciBjYWxsU3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIEFQSSBjYWxsLiBVc2VkIHRvIGNhbGN1bGF0aW5nIEFQSSBjYWxsIGxhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRDb3VudCA9IDA7IC8vcmVxdWVzdC5yZXRyeUNvdW50IGlzIG5vdCByZWxpYWJsZSBoZXJlCiAgICAgIHZhciByZWdpb247IC8vcmVnaW9uIGNhY2hlIHJlZ2lvbiBmb3IgZWFjaCBhdHRlbXB0IHNpbmNlIGl0IGNhbiBiZSB1cGRhdGVkIGluIHBsYXNlIChlLmcuIHMzKQogICAgICB2YXIgY2FsbFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgd2hlbiB0aGUgcmVxdWVzdCBpcyBjcmVhdGVkCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGFkZFRvSGVhZCA9IHRydWU7CiAgCiAgICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGNhbGxUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCdzaWduJywgZnVuY3Rpb24gKCkgewogICAgICAgIGF0dGVtcHRTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGF0dGVtcHRUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICAgIHJlZ2lvbiA9IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uOwogICAgICAgIGF0dGVtcHRDb3VudCsrOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgYXR0ZW1wdExhdGVuY3kgPSBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGF0dGVtcHRTdGFydFJlYWxUaW1lKTsKICAgICAgfSk7CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVCcsICdzdWNjZXNzJywgZnVuY3Rpb24gQVBJX0NBTExfQVRURU1QVCgpIHsKICAgICAgICB2YXIgYXBpQXR0ZW1wdEV2ZW50ID0gc2VsZi5hcGlBdHRlbXB0RXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICAgIH0pOwogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMX0FUVEVNUFRfUkVUUlknLCAncmV0cnknLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUX1JFVFJZKCkgewogICAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmF0dGVtcHRGYWlsRXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgLy9hdHRlbXB0TGF0ZW5jeSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpZiBmYWlsIGJlZm9yZSByZXNwb25zZQogICAgICAgIGF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgfHwKICAgICAgICAgIE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5BdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5ID49IDAgPyBhdHRlbXB0TGF0ZW5jeSA6IDA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2FwaUF0dGVtcHRFdmVudF0pOwogICAgICB9KTsKICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTCcsICdjb21wbGV0ZScsIGZ1bmN0aW9uIEFQSV9DQUxMKCkgewogICAgICAgIHZhciBhcGlDYWxsRXZlbnQgPSBzZWxmLmFwaUNhbGxFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50ID0gYXR0ZW1wdENvdW50OwogICAgICAgIGlmIChhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50IDw9IDApIHJldHVybjsKICAgICAgICBhcGlDYWxsRXZlbnQuVGltZXN0YW1wID0gY2FsbFRpbWVzdGFtcDsKICAgICAgICB2YXIgbGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gY2FsbFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUNhbGxFdmVudC5MYXRlbmN5ID0gbGF0ZW5jeSA+PSAwID8gbGF0ZW5jeSA6IDA7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgICBpZiAoCiAgICAgICAgICB0eXBlb2YgcmVzcG9uc2UucmV0cnlDb3VudCA9PT0gJ251bWJlcicgJiYKICAgICAgICAgIHR5cGVvZiByZXNwb25zZS5tYXhSZXRyaWVzID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgKHJlc3BvbnNlLnJldHJ5Q291bnQgPj0gcmVzcG9uc2UubWF4UmV0cmllcykKICAgICAgICApIHsKICAgICAgICAgIGFwaUNhbGxFdmVudC5NYXhSZXRyaWVzRXhjZWVkZWQgPSAxOwogICAgICAgIH0KICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGwnLCBbYXBpQ2FsbEV2ZW50XSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gc2V0dXAgYW55IGN1c3RvbSByZXF1ZXN0IGxpc3RlbmVycyBmb3IgZWFjaAogICAgICogbmV3IHJlcXVlc3QgdG8gdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQG1ldGhvZF9hYnN0cmFjdCBUaGlzIGlzIGFuIGFic3RyYWN0IG1ldGhvZC4KICAgICAqLwogICAgc2V0dXBSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBzZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgc2lnbmVyIGNsYXNzIGZvciBhIGdpdmVuIHJlcXVlc3QKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTaWduZXJDbGFzczogZnVuY3Rpb24gZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCkgewogICAgICB2YXIgdmVyc2lvbjsKICAgICAgLy8gZ2V0IG9wZXJhdGlvbiBhdXRodHlwZSBpZiBwcmVzZW50CiAgICAgIHZhciBvcGVyYXRpb24gPSBudWxsOwogICAgICB2YXIgYXV0aHR5cGUgPSAnJzsKICAgICAgaWYgKHJlcXVlc3QpIHsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgICBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSB8fCBudWxsOwogICAgICAgIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gdGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbjsKICAgICAgfSBlbHNlIGlmIChhdXRodHlwZSA9PT0gJ3Y0JyB8fCBhdXRodHlwZSA9PT0gJ3Y0LXVuc2lnbmVkLWJvZHknKSB7CiAgICAgICAgdmVyc2lvbiA9ICd2NCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmVyc2lvbiA9IHRoaXMuYXBpLnNpZ25hdHVyZVZlcnNpb247CiAgICAgIH0KICAgICAgcmV0dXJuIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbih2ZXJzaW9uKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXJ2aWNlSW50ZXJmYWNlOiBmdW5jdGlvbiBzZXJ2aWNlSW50ZXJmYWNlKCkgewogICAgICBzd2l0Y2ggKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgICAgY2FzZSAnZWMyJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgICBjYXNlICdxdWVyeSc6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUXVlcnk7CiAgICAgICAgY2FzZSAnanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuSnNvbjsKICAgICAgICBjYXNlICdyZXN0LWpzb24nOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RKc29uOwogICAgICAgIGNhc2UgJ3Jlc3QteG1sJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5SZXN0WG1sOwogICAgICB9CiAgICAgIGlmICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzZXJ2aWNlIGBwcm90b2NvbFwnICcgKwogICAgICAgICAgdGhpcy5hcGkucHJvdG9jb2wgKyAnIGluIEFQSSBjb25maWcnKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHN1Y2Nlc3NmdWxSZXNwb25zZTogZnVuY3Rpb24gc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDA7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBIb3cgbWFueSB0aW1lcyBhIGZhaWxlZCByZXF1ZXN0IHNob3VsZCBiZSByZXRyaWVkIGJlZm9yZSBnaXZpbmcgdXAuCiAgICAgKiB0aGUgZGVmYXVsdFJldHJ5Q291bnQgY2FuIGJlIG92ZXJyaWRlbiBieSBzZXJ2aWNlIGNsYXNzZXMuCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG51bVJldHJpZXM6IGZ1bmN0aW9uIG51bVJldHJpZXMoKSB7CiAgICAgIGlmICh0aGlzLmNvbmZpZy5tYXhSZXRyaWVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25maWcubWF4UmV0cmllczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWZhdWx0UmV0cnlDb3VudDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJldHJ5RGVsYXlzOiBmdW5jdGlvbiByZXRyeURlbGF5cyhyZXRyeUNvdW50KSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHRoaXMuY29uZmlnLnJldHJ5RGVsYXlPcHRpb25zKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICByZXRyeWFibGVFcnJvcjogZnVuY3Rpb24gcmV0cnlhYmxlRXJyb3IoZXJyb3IpIHsKICAgICAgaWYgKHRoaXMudGltZW91dEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLm5ldHdvcmtpbmdFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5leHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy50aHJvdHRsZWRFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA+PSA1MDApIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbmV0d29ya2luZ0Vycm9yOiBmdW5jdGlvbiBuZXR3b3JraW5nRXJyb3IoZXJyb3IpIHsKICAgICAgcmV0dXJuIGVycm9yLmNvZGUgPT09ICdOZXR3b3JraW5nRXJyb3InOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRpbWVvdXRFcnJvcjogZnVuY3Rpb24gdGltZW91dEVycm9yKGVycm9yKSB7CiAgICAgIHJldHVybiBlcnJvci5jb2RlID09PSAnVGltZW91dEVycm9yJzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBleHBpcmVkQ3JlZGVudGlhbHNFcnJvcjogZnVuY3Rpb24gZXhwaXJlZENyZWRlbnRpYWxzRXJyb3IoZXJyb3IpIHsKICAgICAgLy8gVE9ETyA6IHRoaXMgb25seSBoYW5kbGVzICpvbmUqIG9mIHRoZSBleHBpcmVkIGNyZWRlbnRpYWwgY29kZXMKICAgICAgcmV0dXJuIChlcnJvci5jb2RlID09PSAnRXhwaXJlZFRva2VuRXhjZXB0aW9uJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2xvY2tTa2V3RXJyb3I6IGZ1bmN0aW9uIGNsb2NrU2tld0Vycm9yKGVycm9yKSB7CiAgICAgIHN3aXRjaCAoZXJyb3IuY29kZSkgewogICAgICAgIGNhc2UgJ1JlcXVlc3RUaW1lVG9vU2tld2VkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6CiAgICAgICAgY2FzZSAnSW52YWxpZFNpZ25hdHVyZUV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnU2lnbmF0dXJlRG9lc05vdE1hdGNoJzoKICAgICAgICBjYXNlICdBdXRoRmFpbHVyZSc6CiAgICAgICAgY2FzZSAnUmVxdWVzdEluVGhlRnV0dXJlJzoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFNrZXdDb3JyZWN0ZWREYXRlOiBmdW5jdGlvbiBnZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIHsKICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgICAgdGhpcy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBuZXdTZXJ2ZXJUaW1lIC0gRGF0ZS5ub3coKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQobmV3U2VydmVyVGltZSkgewogICAgICBpZiAobmV3U2VydmVyVGltZSkgewogICAgICAgIHJldHVybiBNYXRoLmFicyh0aGlzLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpIC0gbmV3U2VydmVyVGltZSkgPj0gMzAwMDA7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0aHJvdHRsZWRFcnJvcjogZnVuY3Rpb24gdGhyb3R0bGVkRXJyb3IoZXJyb3IpIHsKICAgICAgLy8gdGhpcyBsb2dpYyB2YXJpZXMgYmV0d2VlbiBzZXJ2aWNlcwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA9PT0gNDI5KSByZXR1cm4gdHJ1ZTsKICAgICAgc3dpdGNoIChlcnJvci5jb2RlKSB7CiAgICAgICAgY2FzZSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1Rocm90dGxpbmcnOgogICAgICAgIGNhc2UgJ1Rocm90dGxpbmdFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1JlcXVlc3RMaW1pdEV4Y2VlZGVkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdUb29NYW55UmVxdWVzdHNFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1RyYW5zYWN0aW9uSW5Qcm9ncmVzc0V4Y2VwdGlvbic6IC8vZHluYW1vZGIKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbmRwb2ludEZyb21UZW1wbGF0ZTogZnVuY3Rpb24gZW5kcG9pbnRGcm9tVGVtcGxhdGUoZW5kcG9pbnQpIHsKICAgICAgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHJldHVybiBlbmRwb2ludDsKICAKICAgICAgdmFyIGUgPSBlbmRwb2ludDsKICAgICAgZSA9IGUucmVwbGFjZSgvXHtzZXJ2aWNlXH0vZywgdGhpcy5hcGkuZW5kcG9pbnRQcmVmaXgpOwogICAgICBlID0gZS5yZXBsYWNlKC9ce3JlZ2lvblx9L2csIHRoaXMuY29uZmlnLnJlZ2lvbik7CiAgICAgIGUgPSBlLnJlcGxhY2UoL1x7c2NoZW1lXH0vZywgdGhpcy5jb25maWcuc3NsRW5hYmxlZCA/ICdodHRwcycgOiAnaHR0cCcpOwogICAgICByZXR1cm4gZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXRFbmRwb2ludDogZnVuY3Rpb24gc2V0RW5kcG9pbnQoZW5kcG9pbnQpIHsKICAgICAgdGhpcy5lbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQsIHRoaXMuY29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwYWdpbmF0aW9uQ29uZmlnOiBmdW5jdGlvbiBwYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdGhyb3dFeGNlcHRpb24pIHsKICAgICAgdmFyIHBhZ2luYXRvciA9IHRoaXMuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXS5wYWdpbmF0b3I7CiAgICAgIGlmICghcGFnaW5hdG9yKSB7CiAgICAgICAgaWYgKHRocm93RXhjZXB0aW9uKSB7CiAgICAgICAgICB2YXIgZSA9IG5ldyBFcnJvcigpOwogICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IoZSwgJ05vIHBhZ2luYXRpb24gY29uZmlndXJhdGlvbiBmb3IgJyArIG9wZXJhdGlvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgCiAgICAgIHJldHVybiBwYWdpbmF0b3I7CiAgICB9CiAgfSk7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5TZXJ2aWNlLCB7CiAgCiAgICAvKioKICAgICAqIEFkZHMgb25lIG1ldGhvZCBmb3IgZWFjaCBvcGVyYXRpb24gZGVzY3JpYmVkIGluIHRoZSBhcGkgY29uZmlndXJhdGlvbgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZpbmVNZXRob2RzOiBmdW5jdGlvbiBkZWZpbmVNZXRob2RzKHN2YykgewogICAgICBBV1MudXRpbC5lYWNoKHN2Yy5wcm90b3R5cGUuYXBpLm9wZXJhdGlvbnMsIGZ1bmN0aW9uIGl0ZXJhdG9yKG1ldGhvZCkgewogICAgICAgIGlmIChzdmMucHJvdG90eXBlW21ldGhvZF0pIHJldHVybjsKICAgICAgICB2YXIgb3BlcmF0aW9uID0gc3ZjLnByb3RvdHlwZS5hcGkub3BlcmF0aW9uc1ttZXRob2RdOwogICAgICAgIGlmIChvcGVyYXRpb24uYXV0aHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgc3ZjLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1ha2VSZXF1ZXN0KG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgbmV3IFNlcnZpY2UgY2xhc3MgdXNpbmcgYSBzZXJ2aWNlIGlkZW50aWZpZXIgYW5kIGxpc3Qgb2YgdmVyc2lvbnMKICAgICAqIGluY2x1ZGluZyBhbiBvcHRpb25hbCBzZXQgb2YgZmVhdHVyZXMgKGZ1bmN0aW9ucykgdG8gYXBwbHkgdG8gdGhlIGNsYXNzCiAgICAgKiBwcm90b3R5cGUuCiAgICAgKgogICAgICogQHBhcmFtIHNlcnZpY2VJZGVudGlmaWVyIFtTdHJpbmddIHRoZSBpZGVudGlmaWVyIGZvciB0aGUgc2VydmljZQogICAgICogQHBhcmFtIHZlcnNpb25zIFtBcnJheTxTdHJpbmc+XSBhIGxpc3Qgb2YgdmVyc2lvbnMgdGhhdCB3b3JrIHdpdGggdGhpcwogICAgICogICBzZXJ2aWNlCiAgICAgKiBAcGFyYW0gZmVhdHVyZXMgW09iamVjdF0gYW4gb2JqZWN0IHRvIGF0dGFjaCB0byB0aGUgcHJvdG90eXBlCiAgICAgKiBAcmV0dXJuIFtDbGFzczxTZXJ2aWNlPl0gdGhlIHNlcnZpY2UgY2xhc3MgZGVmaW5lZCBieSB0aGlzIGZ1bmN0aW9uLgogICAgICovCiAgICBkZWZpbmVTZXJ2aWNlOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlKHNlcnZpY2VJZGVudGlmaWVyLCB2ZXJzaW9ucywgZmVhdHVyZXMpIHsKICAgICAgQVdTLlNlcnZpY2UuX3NlcnZpY2VNYXBbc2VydmljZUlkZW50aWZpZXJdID0gdHJ1ZTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZlcnNpb25zKSkgewogICAgICAgIGZlYXR1cmVzID0gdmVyc2lvbnM7CiAgICAgICAgdmVyc2lvbnMgPSBbXTsKICAgICAgfQogIAogICAgICB2YXIgc3ZjID0gaW5oZXJpdChBV1MuU2VydmljZSwgZmVhdHVyZXMgfHwge30pOwogIAogICAgICBpZiAodHlwZW9mIHNlcnZpY2VJZGVudGlmaWVyID09PSAnc3RyaW5nJykgewogICAgICAgIEFXUy5TZXJ2aWNlLmFkZFZlcnNpb25zKHN2YywgdmVyc2lvbnMpOwogIAogICAgICAgIHZhciBpZGVudGlmaWVyID0gc3ZjLnNlcnZpY2VJZGVudGlmaWVyIHx8IHNlcnZpY2VJZGVudGlmaWVyOwogICAgICAgIHN2Yy5zZXJ2aWNlSWRlbnRpZmllciA9IGlkZW50aWZpZXI7CiAgICAgIH0gZWxzZSB7IC8vIGRlZmluZVNlcnZpY2UgY2FsbGVkIHdpdGggYW4gQVBJCiAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBzZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgICBBV1MuU2VydmljZS5kZWZpbmVNZXRob2RzKHN2Yyk7CiAgICAgIH0KICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMucHJvdG90eXBlKTsKICAgICAgLy91dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nIGlzIG9ubHkgYXZhaWxhYmxlIGluIG5vZGUKICAgICAgaWYgKCF0aGlzLnByb3RvdHlwZS5wdWJsaXNoZXIgJiYgQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcpIHsKICAgICAgICB2YXIgUHVibGlzaGVyID0gQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcuUHVibGlzaGVyOwogICAgICAgIHZhciBjb25maWdQcm92aWRlciA9IEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nLmNvbmZpZ1Byb3ZpZGVyOwogICAgICAgIHZhciBwdWJsaXNoZXJDb25maWcgPSBjb25maWdQcm92aWRlcigpOwogICAgICAgIHRoaXMucHJvdG90eXBlLnB1Ymxpc2hlciA9IG5ldyBQdWJsaXNoZXIocHVibGlzaGVyQ29uZmlnKTsKICAgICAgICBpZiAocHVibGlzaGVyQ29uZmlnLmVuYWJsZWQpIHsKICAgICAgICAgIC8vaWYgY3NtIGlzIGVuYWJsZWQgaW4gZW52aXJvbm1lbnQsIFNESyBzaG91bGQgc2VuZCBhbGwgbWV0cmljcwogICAgICAgICAgQVdTLlNlcnZpY2UuX2NsaWVudFNpZGVNb25pdG9yaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHN2Yy5wcm90b3R5cGUpOwogICAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyhzdmMucHJvdG90eXBlKTsKICAgICAgcmV0dXJuIHN2YzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGRWZXJzaW9uczogZnVuY3Rpb24gYWRkVmVyc2lvbnMoc3ZjLCB2ZXJzaW9ucykgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmVyc2lvbnMpKSB2ZXJzaW9ucyA9IFt2ZXJzaW9uc107CiAgCiAgICAgIHN2Yy5zZXJ2aWNlcyA9IHN2Yy5zZXJ2aWNlcyB8fCB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2ZXJzaW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChzdmMuc2VydmljZXNbdmVyc2lvbnNbaV1dID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHN2Yy5zZXJ2aWNlc1t2ZXJzaW9uc1tpXV0gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBzdmMuYXBpVmVyc2lvbnMgPSBPYmplY3Qua2V5cyhzdmMuc2VydmljZXMpLnNvcnQoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZpbmVTZXJ2aWNlQXBpOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlQXBpKHN1cGVyY2xhc3MsIHZlcnNpb24sIGFwaUNvbmZpZykgewogICAgICB2YXIgc3ZjID0gaW5oZXJpdChzdXBlcmNsYXNzLCB7CiAgICAgICAgc2VydmljZUlkZW50aWZpZXI6IHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIKICAgICAgfSk7CiAgCiAgICAgIGZ1bmN0aW9uIHNldEFwaShhcGkpIHsKICAgICAgICBpZiAoYXBpLmlzQXBpKSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IGFwaTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBuZXcgQXBpKGFwaSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoYXBpQ29uZmlnKSB7CiAgICAgICAgICBzZXRBcGkoYXBpQ29uZmlnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0QXBpKEFXUy5hcGlMb2FkZXIoc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllciwgdmVyc2lvbikpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKGVyciwgewogICAgICAgICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgZmluZCBBUEkgY29uZmlndXJhdGlvbiAnICsKICAgICAgICAgICAgICAgIHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIgKyAnLScgKyB2ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdXBlcmNsYXNzLnNlcnZpY2VzLCB2ZXJzaW9uKSkgewogICAgICAgICAgc3VwZXJjbGFzcy5hcGlWZXJzaW9ucyA9IHN1cGVyY2xhc3MuYXBpVmVyc2lvbnMuY29uY2F0KHZlcnNpb24pLnNvcnQoKTsKICAgICAgICB9CiAgICAgICAgc3VwZXJjbGFzcy5zZXJ2aWNlc1t2ZXJzaW9uXSA9IHN2YzsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRBcGkodmVyc2lvbik7CiAgICAgIH0KICAKICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lTWV0aG9kcyhzdmMpOwogICAgICByZXR1cm4gc3ZjOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhc1NlcnZpY2U6IGZ1bmN0aW9uKGlkZW50aWZpZXIpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MuU2VydmljZS5fc2VydmljZU1hcCwgaWRlbnRpZmllcik7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcGFyYW0gYXR0YWNoT24gYXR0YWNoIGRlZmF1bHQgbW9uaXRvcmluZyBsaXN0ZW5lcnMgdG8gb2JqZWN0CiAgICAgKgogICAgICogRWFjaCBtb25pdG9yaW5nIGV2ZW50IHNob3VsZCBiZSBlbWl0dGVkIGZyb20gc2VydmljZSBjbGllbnQgdG8gc2VydmljZSBjb25zdHJ1Y3RvciBwcm90b3R5cGUgYW5kIHRoZW4KICAgICAqIHRvIGdsb2JhbCBzZXJ2aWNlIHByb3RvdHlwZSBsaWtlIGJ1YmJsaW5nIHVwLiBUaGVzZSBkZWZhdWx0IG1vbml0b3JpbmcgZXZlbnRzIGxpc3RlbmVyIHdpbGwgdHJhbnNmZXIKICAgICAqIHRoZSBtb25pdG9yaW5nIGV2ZW50cyB0byB0aGUgdXBwZXIgbGF5ZXIuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKGF0dGFjaE9uKSB7CiAgICAgIGF0dGFjaE9uLmFkZE5hbWVkTGlzdGVuZXIoJ01PTklUT1JfRVZFTlRTX0JVQkJMRScsICdhcGlDYWxsQXR0ZW1wdCcsIGZ1bmN0aW9uIEVWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFtldmVudF0pOwogICAgICB9KTsKICAgICAgYXR0YWNoT24uYWRkTmFtZWRMaXN0ZW5lcignQ0FMTF9FVkVOVFNfQlVCQkxFJywgJ2FwaUNhbGwnLCBmdW5jdGlvbiBDQUxMX0VWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsJywgW2V2ZW50XSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIF9zZXJ2aWNlTWFwOiB7fQogIH0pOwogIAogIEFXUy51dGlsLm1peGluKEFXUy5TZXJ2aWNlLCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXJ2aWNlOwogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9jb3JlIjoxOCwiLi9tb2RlbC9hcGkiOjM4LCIuL3JlZ2lvbl9jb25maWciOjUzLCJfcHJvY2VzcyI6ODZ9XSw2MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLkNvZ25pdG9JZGVudGl0eS5wcm90b3R5cGUsIHsKICAgIGdldE9wZW5JZFRva2VuOiBmdW5jdGlvbiBnZXRPcGVuSWRUb2tlbihwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRPcGVuSWRUb2tlbicsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGdldElkOiBmdW5jdGlvbiBnZXRJZChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRJZCcsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHk6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eScsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfQogIH0pOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDYxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuLi9yZWdpb25fY29uZmlnJyk7CiAgdmFyIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEID0gJ0FXU19TVFNfUkVHSU9OQUxfRU5EUE9JTlRTJzsKICB2YXIgQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgPSAnc3RzX3JlZ2lvbmFsX2VuZHBvaW50cyc7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5TVFMucHJvdG90eXBlLCB7CiAgICAvKioKICAgICAqIEBvdmVybG9hZCBjcmVkZW50aWFsc0Zyb20oZGF0YSwgY3JlZGVudGlhbHMgPSBudWxsKQogICAgICogICBDcmVhdGVzIGEgY3JlZGVudGlhbHMgb2JqZWN0IGZyb20gU1RTIHJlc3BvbnNlIGRhdGEgY29udGFpbmluZwogICAgICogICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbi4gVXNlZnVsIGZvciBxdWlja2x5IHNldHRpbmcgQVdTIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqICAgQG5vdGUgVGhpcyBpcyBhIGxvdy1sZXZlbCB1dGlsaXR5IGZ1bmN0aW9uLiBJZiB5b3Ugd2FudCB0byBsb2FkIHRlbXBvcmFyeQogICAgICogICAgIGNyZWRlbnRpYWxzIGludG8geW91ciBwcm9jZXNzIGZvciBzdWJzZXF1ZW50IHJlcXVlc3RzIHRvIEFXUyByZXNvdXJjZXMsCiAgICAgKiAgICAgeW91IHNob3VsZCB1c2Uge0FXUy5UZW1wb3JhcnlDcmVkZW50aWFsc30gaW5zdGVhZC4KICAgICAqICAgQHBhcmFtIGRhdGEgW21hcF0gZGF0YSByZXRyaWV2ZWQgZnJvbSBhIGNhbGwgdG8ge2dldEZlZGVyYXRlZFRva2VufSwKICAgICAqICAgICB7Z2V0U2Vzc2lvblRva2VufSwge2Fzc3VtZVJvbGV9LCBvciB7YXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uCiAgICAgKiAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSBhbiBvcHRpb25hbCBjcmVkZW50aWFscyBvYmplY3QgdG8KICAgICAqICAgICBmaWxsIGluc3RlYWQgb2YgY3JlYXRpbmcgYSBuZXcgb2JqZWN0LiBVc2VmdWwgd2hlbiBtb2RpZnlpbmcgYW4KICAgICAqICAgICBleGlzdGluZyBjcmVkZW50aWFscyBvYmplY3QgZnJvbSBhIHJlZnJlc2ggY2FsbC4KICAgICAqICAgQHJldHVybiBbQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzXSB0aGUgc2V0IG9mIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAgICogICAgIGxvYWRlZCBmcm9tIGEgcmF3IFNUUyBvcGVyYXRpb24gcmVzcG9uc2UuCiAgICAgKiAgIEBleGFtcGxlIFVzaW5nIGNyZWRlbnRpYWxzRnJvbSB0byBsb2FkIGdsb2JhbCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgc3RzID0gbmV3IEFXUy5TVFMoKTsKICAgICAqICAgICBzdHMuZ2V0U2Vzc2lvblRva2VuKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAqICAgICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJFcnJvciBnZXR0aW5nIGNyZWRlbnRpYWxzIik7CiAgICAgKiAgICAgICBlbHNlIHsKICAgICAqICAgICAgICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IHN0cy5jcmVkZW50aWFsc0Zyb20oZGF0YSk7CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIEBzZWUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzCiAgICAgKi8KICAgIGNyZWRlbnRpYWxzRnJvbTogZnVuY3Rpb24gY3JlZGVudGlhbHNGcm9tKGRhdGEsIGNyZWRlbnRpYWxzKSB7CiAgICAgIGlmICghZGF0YSkgcmV0dXJuIG51bGw7CiAgICAgIGlmICghY3JlZGVudGlhbHMpIGNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgICBjcmVkZW50aWFscy5leHBpcmVkID0gZmFsc2U7CiAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkID0gZGF0YS5DcmVkZW50aWFscy5BY2Nlc3NLZXlJZDsKICAgICAgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ID0gZGF0YS5DcmVkZW50aWFscy5TZWNyZXRBY2Nlc3NLZXk7CiAgICAgIGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbiA9IGRhdGEuQ3JlZGVudGlhbHMuU2Vzc2lvblRva2VuOwogICAgICBjcmVkZW50aWFscy5leHBpcmVUaW1lID0gZGF0YS5DcmVkZW50aWFscy5FeHBpcmF0aW9uOwogICAgICByZXR1cm4gY3JlZGVudGlhbHM7CiAgICB9LAogIAogICAgYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eTogZnVuY3Rpb24gYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5JywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgYXNzdW1lUm9sZVdpdGhTQU1MOiBmdW5jdGlvbiBhc3N1bWVSb2xlV2l0aFNBTUwocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnYXNzdW1lUm9sZVdpdGhTQU1MJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZTogZnVuY3Rpb24gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShjb25maWdWYWx1ZSwgZXJyb3JPcHRpb25zKSB7CiAgICAgIGlmICh0eXBlb2YgY29uZmlnVmFsdWUgPT09ICdzdHJpbmcnICYmIFsnbGVnYWN5JywgJ3JlZ2lvbmFsJ10uaW5kZXhPZihjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpKSA+PSAwKSB7CiAgICAgICAgdGhpcy5jb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgPSBjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgZXJyb3JPcHRpb25zKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnOiBmdW5jdGlvbiB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZygpIHsKICAgICAgLy92YWxpZGF0ZSBjb25maWcgdmFsdWUKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnOwogICAgICBpZiAoY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICJzdHNSZWdpb25hbEVuZHBvaW50cyIgY29uZmlndXJhdGlvbi4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFBV1MudXRpbC5pc05vZGUoKSkgcmV0dXJuOwogICAgICAvL3ZhbGlkYXRlIGVudmlyb25tZW50YWwgdmFyaWFibGUKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQpKSB7CiAgICAgICAgdmFyIGVudkZsYWcgPSBwcm9jZXNzLmVudltFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF07CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGVudkZsYWcsIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkRW52aXJvbm1lbnRhbFZhcmlhYmxlJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcgKyBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCArICcgZW52aXJvbm1lbnRhbCB2YXJpYWJsZS4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9jZXNzLmVudltFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF0gKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLy92YWxpZGF0ZSBzaGFyZWQgY29uZmlnIGZpbGUKICAgICAgdmFyIHByb2ZpbGUgPSB7fTsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcHJvZmlsZXMgPSBBV1MudXRpbC5nZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWcoQVdTLnV0aWwuaW5pTG9hZGVyKTsKICAgICAgICBwcm9maWxlID0gcHJvZmlsZXNbcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGVdOwogICAgICB9IGNhdGNoIChlKSB7fTsKICAgICAgaWYgKHByb2ZpbGUgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2ZpbGUsIENPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEKSkgewogICAgICAgIHZhciBmaWxlRmxhZyA9IHByb2ZpbGVbQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdOwogICAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShmaWxlRmxhZywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcrQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQrJyBwcm9maWxlIGNvbmZpZy4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9maWxlW0NPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXSArICciLicKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG9wdEluUmVnaW9uYWxFbmRwb2ludDogZnVuY3Rpb24gb3B0SW5SZWdpb25hbEVuZHBvaW50KCkgewogICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnKCk7CiAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZzsKICAgICAgaWYgKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyA9PT0gJ3JlZ2lvbmFsJykgewogICAgICAgIHJlZ2lvbkNvbmZpZyh0aGlzKTsKICAgICAgICBpZiAoIXRoaXMuaXNHbG9iYWxFbmRwb2ludCkgcmV0dXJuOwogICAgICAgIHRoaXMuaXNHbG9iYWxFbmRwb2ludCA9IGZhbHNlOwogICAgICAgIC8vY2xpZW50IHdpbGwgdGhyb3cgaWYgcmVnaW9uIGlzIG5vdCBzdXBwbGllZDsgcmVxdWVzdCB3aWxsIGJlIHNpZ25lZCB3aXRoIHNwZWNpZmllZCByZWdpb24KICAgICAgICBpZiAoIWNvbmZpZy5yZWdpb24pIHsKICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgICAgdmFyIGluc2VydFBvaW50ID0gY29uZmlnLmVuZHBvaW50LmluZGV4T2YoJy5hbWF6b25hd3MuY29tJyk7CiAgICAgICAgY29uZmlnLmVuZHBvaW50ID0gY29uZmlnLmVuZHBvaW50LnN1YnN0cmluZygwLCBpbnNlcnRQb2ludCkgKwogICAgICAgICAgJy4nICsgY29uZmlnLnJlZ2lvbiArIGNvbmZpZy5lbmRwb2ludC5zdWJzdHJpbmcoaW5zZXJ0UG9pbnQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgICAgIHRoaXMub3B0SW5SZWdpb25hbEVuZHBvaW50KCk7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuLi9jb3JlIjoxOCwiLi4vcmVnaW9uX2NvbmZpZyI6NTMsIl9wcm9jZXNzIjo4Nn1dLDYyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gc2lnbmVkVXJsQnVpbGRlcihyZXF1ZXN0KSB7CiAgICB2YXIgZXhwaXJlcyA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXTsKICAgIHZhciBzaWduZXJDbGFzcyA9IHJlcXVlc3Quc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXF1ZXN0KTsKICAKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1VzZXItQWdlbnQnXTsKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LVVzZXItQWdlbnQnXTsKICAKICAgIGlmIChzaWduZXJDbGFzcyA9PT0gQVdTLlNpZ25lcnMuVjQpIHsKICAgICAgaWYgKGV4cGlyZXMgPiA2MDQ4MDApIHsgLy8gb25lIHdlZWsgZXhwaXJ5IGlzIGludmFsaWQKICAgICAgICB2YXIgbWVzc2FnZSA9ICdQcmVzaWduaW5nIGRvZXMgbm90IHN1cHBvcnQgZXhwaXJ5IHRpbWUgZ3JlYXRlciAnICsKICAgICAgICAgICAgICAgICAgICAgICd0aGFuIGEgd2VlayB3aXRoIFNpZ1Y0IHNpZ25pbmcuJzsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0ludmFsaWRFeHBpcnlUaW1lJywgbWVzc2FnZTogbWVzc2FnZSwgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IGV4cGlyZXM7CiAgICB9IGVsc2UgaWYgKHNpZ25lckNsYXNzID09PSBBV1MuU2lnbmVycy5TMykgewogICAgICB2YXIgbm93ID0gcmVxdWVzdC5zZXJ2aWNlID8gcmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkgOiBBV1MudXRpbC5kYXRlLmdldERhdGUoKTsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gcGFyc2VJbnQoCiAgICAgICAgQVdTLnV0aWwuZGF0ZS51bml4VGltZXN0YW1wKG5vdykgKyBleHBpcmVzLCAxMCkudG9TdHJpbmcoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgbWVzc2FnZTogJ1ByZXNpZ25pbmcgb25seSBzdXBwb3J0cyBTMyBvciBTaWdWNCBzaWduaW5nLicsCiAgICAgICAgY29kZTogJ1Vuc3VwcG9ydGVkU2lnbmVyJywgcmV0cnlhYmxlOiBmYWxzZQogICAgICB9KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gc2lnbmVkVXJsU2lnbmVyKHJlcXVlc3QpIHsKICAgIHZhciBlbmRwb2ludCA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQ7CiAgICB2YXIgcGFyc2VkVXJsID0gQVdTLnV0aWwudXJsUGFyc2UocmVxdWVzdC5odHRwUmVxdWVzdC5wYXRoKTsKICAgIHZhciBxdWVyeVBhcmFtcyA9IHt9OwogIAogICAgaWYgKHBhcnNlZFVybC5zZWFyY2gpIHsKICAgICAgcXVlcnlQYXJhbXMgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHBhcnNlZFVybC5zZWFyY2guc3Vic3RyKDEpKTsKICAgIH0KICAKICAgIHZhciBhdXRoID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10uc3BsaXQoJyAnKTsKICAgIGlmIChhdXRoWzBdID09PSAnQVdTJykgewogICAgICBhdXRoID0gYXV0aFsxXS5zcGxpdCgnOicpOwogICAgICBxdWVyeVBhcmFtc1snQVdTQWNjZXNzS2V5SWQnXSA9IGF1dGhbMF07CiAgICAgIHF1ZXJ5UGFyYW1zWydTaWduYXR1cmUnXSA9IGF1dGhbMV07CiAgCiAgICAgIEFXUy51dGlsLmVhY2gocmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIGtleSA9ICdFeHBpcmVzJzsKICAgICAgICBpZiAoa2V5LmluZGV4T2YoJ3gtYW16LW1ldGEtJykgPT09IDApIHsKICAgICAgICAgIC8vIERlbGV0ZSBleGlzdGluZywgcG90ZW50aWFsbHkgbm90IG5vcm1hbGl6ZWQga2V5CiAgICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNba2V5XTsKICAgICAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0KICAgICAgICBxdWVyeVBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0F1dGhvcml6YXRpb24nXTsKICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydIb3N0J107CiAgICB9IGVsc2UgaWYgKGF1dGhbMF0gPT09ICdBV1M0LUhNQUMtU0hBMjU2JykgeyAvLyBTaWdWNCBzaWduaW5nCiAgICAgIGF1dGguc2hpZnQoKTsKICAgICAgdmFyIHJlc3QgPSBhdXRoLmpvaW4oJyAnKTsKICAgICAgdmFyIHNpZ25hdHVyZSA9IHJlc3QubWF0Y2goL1NpZ25hdHVyZT0oLio/KSg/Oix8XHN8XHI/XG58JCkvKVsxXTsKICAgICAgcXVlcnlQYXJhbXNbJ1gtQW16LVNpZ25hdHVyZSddID0gc2lnbmF0dXJlOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0V4cGlyZXMnXTsKICAgIH0KICAKICAgIC8vIGJ1aWxkIFVSTAogICAgZW5kcG9pbnQucGF0aG5hbWUgPSBwYXJzZWRVcmwucGF0aG5hbWU7CiAgICBlbmRwb2ludC5zZWFyY2ggPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5UGFyYW1zKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUHJlc2lnbiA9IGluaGVyaXQoewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2lnbjogZnVuY3Rpb24gc2lnbihyZXF1ZXN0LCBleHBpcmVUaW1lLCBjYWxsYmFjaykgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBleHBpcmVUaW1lIHx8IDM2MDA7CiAgICAgIHJlcXVlc3Qub24oJ2J1aWxkJywgc2lnbmVkVXJsQnVpbGRlcik7CiAgICAgIHJlcXVlc3Qub24oJ3NpZ24nLCBzaWduZWRVcmxTaWduZXIpOwogICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRVRfQ09OVEVOVF9MRU5HVEgpOwogICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5DT01QVVRFX1NIQTI1Nik7CiAgCiAgICAgIHJlcXVlc3QuZW1pdCgnYmVmb3JlUHJlc2lnbicsIFtyZXF1ZXN0XSk7CiAgCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHJlcXVlc3QuYnVpbGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5yZXNwb25zZS5lcnJvcikgY2FsbGJhY2sodGhpcy5yZXNwb25zZS5lcnJvcik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgQVdTLnV0aWwudXJsRm9ybWF0KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXF1ZXN0LmJ1aWxkKCk7CiAgICAgICAgaWYgKHJlcXVlc3QucmVzcG9uc2UuZXJyb3IpIHRocm93IHJlcXVlc3QucmVzcG9uc2UuZXJyb3I7CiAgICAgICAgcmV0dXJuIEFXUy51dGlsLnVybEZvcm1hdChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50KTsKICAgICAgfQogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuUHJlc2lnbjsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciA9IGluaGVyaXQoewogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3RTaWduZXIocmVxdWVzdCkgewogICAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgfSwKICAKICAgIHNldFNlcnZpY2VDbGllbnRJZDogZnVuY3Rpb24gc2V0U2VydmljZUNsaWVudElkKGlkKSB7CiAgICAgIHRoaXMuc2VydmljZUNsaWVudElkID0gaWQ7CiAgICB9LAogIAogICAgZ2V0U2VydmljZUNsaWVudElkOiBmdW5jdGlvbiBnZXRTZXJ2aWNlQ2xpZW50SWQoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VDbGllbnRJZDsKICAgIH0KICB9KTsKICAKICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmdldFZlcnNpb24gPSBmdW5jdGlvbiBnZXRWZXJzaW9uKHZlcnNpb24pIHsKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlICd2Mic6IHJldHVybiBBV1MuU2lnbmVycy5WMjsKICAgICAgY2FzZSAndjMnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjM7CiAgICAgIGNhc2UgJ3MzdjQnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjQ7CiAgICAgIGNhc2UgJ3Y0JzogcmV0dXJuIEFXUy5TaWduZXJzLlY0OwogICAgICBjYXNlICdzMyc6IHJldHVybiBBV1MuU2lnbmVycy5TMzsKICAgICAgY2FzZSAndjNodHRwcyc6IHJldHVybiBBV1MuU2lnbmVycy5WM0h0dHBzOwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25pbmcgdmVyc2lvbiAnICsgdmVyc2lvbik7CiAgfTsKICAKICByZXF1aXJlKCcuL3YyJyk7CiAgcmVxdWlyZSgnLi92MycpOwogIHJlcXVpcmUoJy4vdjNodHRwcycpOwogIHJlcXVpcmUoJy4vdjQnKTsKICByZXF1aXJlKCcuL3MzJyk7CiAgcmVxdWlyZSgnLi9wcmVzaWduJyk7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3ByZXNpZ24iOjYyLCIuL3MzIjo2NCwiLi92MiI6NjUsIi4vdjMiOjY2LCIuL3YzaHR0cHMiOjY3LCIuL3Y0Ijo2OH1dLDY0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5TMyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgLyoqCiAgICAgKiBXaGVuIGJ1aWxkaW5nIHRoZSBzdHJpbmdUb1NpZ24sIHRoZXNlIHN1YiByZXNvdXJjZSBwYXJhbXMgc2hvdWxkIGJlCiAgICAgKiBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWRlY29kZWQgdmFsdWVzCiAgICAgKi8KICAgIHN1YlJlc291cmNlczogewogICAgICAnYWNsJzogMSwKICAgICAgJ2FjY2VsZXJhdGUnOiAxLAogICAgICAnYW5hbHl0aWNzJzogMSwKICAgICAgJ2NvcnMnOiAxLAogICAgICAnbGlmZWN5Y2xlJzogMSwKICAgICAgJ2RlbGV0ZSc6IDEsCiAgICAgICdpbnZlbnRvcnknOiAxLAogICAgICAnbG9jYXRpb24nOiAxLAogICAgICAnbG9nZ2luZyc6IDEsCiAgICAgICdtZXRyaWNzJzogMSwKICAgICAgJ25vdGlmaWNhdGlvbic6IDEsCiAgICAgICdwYXJ0TnVtYmVyJzogMSwKICAgICAgJ3BvbGljeSc6IDEsCiAgICAgICdyZXF1ZXN0UGF5bWVudCc6IDEsCiAgICAgICdyZXBsaWNhdGlvbic6IDEsCiAgICAgICdyZXN0b3JlJzogMSwKICAgICAgJ3RhZ2dpbmcnOiAxLAogICAgICAndG9ycmVudCc6IDEsCiAgICAgICd1cGxvYWRJZCc6IDEsCiAgICAgICd1cGxvYWRzJzogMSwKICAgICAgJ3ZlcnNpb25JZCc6IDEsCiAgICAgICd2ZXJzaW9uaW5nJzogMSwKICAgICAgJ3ZlcnNpb25zJzogMSwKICAgICAgJ3dlYnNpdGUnOiAxCiAgICB9LAogIAogICAgLy8gd2hlbiBidWlsZGluZyB0aGUgc3RyaW5nVG9TaWduLCB0aGVzZSBxdWVyeXN0cmluZyBwYXJhbXMgc2hvdWxkIGJlCiAgICAvLyBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWVuY29kZWQgdmFsdWVzCiAgICByZXNwb25zZUhlYWRlcnM6IHsKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtdHlwZSc6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWxhbmd1YWdlJzogMSwKICAgICAgJ3Jlc3BvbnNlLWV4cGlyZXMnOiAxLAogICAgICAncmVzcG9uc2UtY2FjaGUtY29udHJvbCc6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWRpc3Bvc2l0aW9uJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtZW5jb2RpbmcnOiAxCiAgICB9LAogIAogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogICAgICBpZiAoIXRoaXMucmVxdWVzdC5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IEFXUy51dGlsLmRhdGUucmZjODIyKGRhdGUpOwogICAgICB9CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICAvLyBwcmVzaWduZWQgVVJMcyByZXF1aXJlIHRoaXMgaGVhZGVyIHRvIGJlIGxvd2VyY2FzZWQKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICB2YXIgc2lnbmF0dXJlID0gdGhpcy5zaWduKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSk7CiAgICAgIHZhciBhdXRoID0gJ0FXUyAnICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnOicgKyBzaWduYXR1cmU7CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBhdXRoOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2goci5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1snQ29udGVudC1NRDUnXSB8fCAnJyk7CiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydDb250ZW50LVR5cGUnXSB8fCAnJyk7CiAgCiAgICAgIC8vIFRoaXMgaXMgdGhlICJEYXRlIiBoZWFkZXIsIGJ1dCB3ZSB1c2UgWC1BbXotRGF0ZS4KICAgICAgLy8gVGhlIFMzIHNpZ25pbmcgbWVjaGFuaXNtIHJlcXVpcmVzIHVzIHRvIHBhc3MgYW4gZW1wdHkKICAgICAgLy8gc3RyaW5nIGZvciB0aGlzIERhdGUgaGVhZGVyIHJlZ2FyZGxlc3MuCiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddIHx8ICcnKTsKICAKICAgICAgdmFyIGhlYWRlcnMgPSB0aGlzLmNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzKCk7CiAgICAgIGlmIChoZWFkZXJzKSBwYXJ0cy5wdXNoKGhlYWRlcnMpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsaXplZFJlc291cmNlKCkpOwogIAogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAKICAgIH0sCiAgCiAgICBjYW5vbmljYWxpemVkQW16SGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsaXplZEFtekhlYWRlcnMoKSB7CiAgCiAgICAgIHZhciBhbXpIZWFkZXJzID0gW107CiAgCiAgICAgIEFXUy51dGlsLmVhY2godGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgaWYgKG5hbWUubWF0Y2goL154LWFtei0vaSkpCiAgICAgICAgICBhbXpIZWFkZXJzLnB1c2gobmFtZSk7CiAgICAgIH0pOwogIAogICAgICBhbXpIZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYS50b0xvd2VyQ2FzZSgpIDwgYi50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgICB9KTsKICAKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGFtekhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcGFydHMucHVzaChuYW1lLnRvTG93ZXJDYXNlKCkgKyAnOicgKyBTdHJpbmcodGhpcy5yZXF1ZXN0LmhlYWRlcnNbbmFtZV0pKTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIAogICAgfSwKICAKICAgIGNhbm9uaWNhbGl6ZWRSZXNvdXJjZTogZnVuY3Rpb24gY2Fub25pY2FsaXplZFJlc291cmNlKCkgewogIAogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgdmFyIHBhcnRzID0gci5wYXRoLnNwbGl0KCc/Jyk7CiAgICAgIHZhciBwYXRoID0gcGFydHNbMF07CiAgICAgIHZhciBxdWVyeXN0cmluZyA9IHBhcnRzWzFdOwogIAogICAgICB2YXIgcmVzb3VyY2UgPSAnJzsKICAKICAgICAgaWYgKHIudmlydHVhbEhvc3RlZEJ1Y2tldCkKICAgICAgICByZXNvdXJjZSArPSAnLycgKyByLnZpcnR1YWxIb3N0ZWRCdWNrZXQ7CiAgCiAgICAgIHJlc291cmNlICs9IHBhdGg7CiAgCiAgICAgIGlmIChxdWVyeXN0cmluZykgewogIAogICAgICAgIC8vIGNvbGxlY3QgYSBsaXN0IG9mIHN1YiByZXNvdXJjZXMgYW5kIHF1ZXJ5IHBhcmFtcyB0aGF0IG5lZWQgdG8gYmUgc2lnbmVkCiAgICAgICAgdmFyIHJlc291cmNlcyA9IFtdOwogIAogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIHF1ZXJ5c3RyaW5nLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChwYXJhbSkgewogICAgICAgICAgdmFyIG5hbWUgPSBwYXJhbS5zcGxpdCgnPScpWzBdOwogICAgICAgICAgdmFyIHZhbHVlID0gcGFyYW0uc3BsaXQoJz0nKVsxXTsKICAgICAgICAgIGlmICh0aGlzLnN1YlJlc291cmNlc1tuYW1lXSB8fCB0aGlzLnJlc3BvbnNlSGVhZGVyc1tuYW1lXSkgewogICAgICAgICAgICB2YXIgc3VicmVzb3VyY2UgPSB7IG5hbWU6IG5hbWUgfTsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5zdWJSZXNvdXJjZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb3VyY2VzLnB1c2goc3VicmVzb3VyY2UpOwogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIHJlc291cmNlcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLm5hbWUgPCBiLm5hbWUgPyAtMSA6IDE7IH0pOwogIAogICAgICAgIGlmIChyZXNvdXJjZXMubGVuZ3RoKSB7CiAgCiAgICAgICAgICBxdWVyeXN0cmluZyA9IFtdOwogICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJlc291cmNlcywgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgICBpZiAocmVzLnZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lICsgJz0nICsgcmVzLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgCiAgICAgICAgICByZXNvdXJjZSArPSAnPycgKyBxdWVyeXN0cmluZy5qb2luKCcmJyk7CiAgICAgICAgfQogIAogICAgICB9CiAgCiAgICAgIHJldHVybiByZXNvdXJjZTsKICAKICAgIH0sCiAgCiAgICBzaWduOiBmdW5jdGlvbiBzaWduKHNlY3JldCwgc3RyaW5nKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhzZWNyZXQsIHN0cmluZywgJ2Jhc2U2NCcsICdzaGExJyk7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5TMzsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjIgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAKICAgICAgaWYgKCFkYXRlKSBkYXRlID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCk7CiAgCiAgICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwogIAogICAgICByLnBhcmFtcy5UaW1lc3RhbXAgPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEoZGF0ZSk7CiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZVZlcnNpb24gPSAnMic7CiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZU1ldGhvZCA9ICdIbWFjU0hBMjU2JzsKICAgICAgci5wYXJhbXMuQVdTQWNjZXNzS2V5SWQgPSBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHIucGFyYW1zLlNlY3VyaXR5VG9rZW4gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgZGVsZXRlIHIucGFyYW1zLlNpZ25hdHVyZTsgLy8gZGVsZXRlIG9sZCBTaWduYXR1cmUgZm9yIHJlLXNpZ25pbmcKICAgICAgci5wYXJhbXMuU2lnbmF0dXJlID0gdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogIAogICAgICByLmJvZHkgPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHIucGFyYW1zKTsKICAgICAgci5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gci5ib2R5Lmxlbmd0aDsKICAgIH0sCiAgCiAgICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpLCAnYmFzZTY0Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5lbmRwb2ludC5ob3N0LnRvTG93ZXJDYXNlKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5wYXRobmFtZSgpKTsKICAgICAgcGFydHMucHVzaChBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHRoaXMucmVxdWVzdC5wYXJhbXMpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMjsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAKICAgICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5yZmM4MjIoZGF0ZSk7CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBkYXRldGltZTsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtem4tQXV0aG9yaXphdGlvbiddID0KICAgICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAKICAgIH0sCiAgCiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiAnQVdTMyAnICsKICAgICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICAgJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpICsgJywnICsKICAgICAgICAnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgICB9LAogIAogICAgc2lnbmVkSGVhZGVyczogZnVuY3Rpb24gc2lnbmVkSGVhZGVycygpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHRoaXMuaGVhZGVyc1RvU2lnbigpLCBmdW5jdGlvbiBpdGVyYXRvcihoKSB7CiAgICAgICAgaGVhZGVycy5wdXNoKGgudG9Mb3dlckNhc2UoKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gaGVhZGVycy5zb3J0KCkuam9pbignOycpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnM7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2godGhpcy5oZWFkZXJzVG9TaWduKCksIGZ1bmN0aW9uIGl0ZXJhdG9yKGgpIHsKICAgICAgICBwYXJ0cy5wdXNoKGgudG9Mb3dlckNhc2UoKS50cmltKCkgKyAnOicgKyBTdHJpbmcoaGVhZGVyc1toXSkudHJpbSgpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5zb3J0KCkuam9pbignXG4nKSArICdcbic7CiAgICB9LAogIAogICAgaGVhZGVyc1RvU2lnbjogZnVuY3Rpb24gaGVhZGVyc1RvU2lnbigpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gaXRlcmF0b3IoaykgewogICAgICAgIGlmIChrID09PSAnSG9zdCcgfHwgayA9PT0gJ0NvbnRlbnQtRW5jb2RpbmcnIHx8IGsubWF0Y2goL15YLUFtei9pKSkgewogICAgICAgICAgaGVhZGVycy5wdXNoKGspOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfSwKICAKICAgIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCksICdiYXNlNjQnKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2goJy8nKTsKICAgICAgcGFydHMucHVzaCgnJyk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5ib2R5KTsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYocGFydHMuam9pbignXG4nKSk7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMzsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgcmVxdWlyZSgnLi92MycpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlYzSHR0cHMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlYzLCB7CiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiAnQVdTMy1IVFRQUyAnICsKICAgICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICAgJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYzSHR0cHM7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3YzIjo2Nn1dLDY4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB2NENyZWRlbnRpYWxzID0gcmVxdWlyZSgnLi92NF9jcmVkZW50aWFscycpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjQgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBWNChyZXF1ZXN0LCBzZXJ2aWNlTmFtZSwgb3B0aW9ucykgewogICAgICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmNhbGwodGhpcywgcmVxdWVzdCk7CiAgICAgIHRoaXMuc2VydmljZU5hbWUgPSBzZXJ2aWNlTmFtZTsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHRoaXMuc2lnbmF0dXJlQ2FjaGUgPSB0eXBlb2Ygb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA9PT0gJ2Jvb2xlYW4nID8gb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA6IHRydWU7CiAgICAgIHRoaXMub3BlcmF0aW9uID0gb3B0aW9ucy5vcGVyYXRpb247CiAgICAgIHRoaXMuc2lnbmF0dXJlVmVyc2lvbiA9IG9wdGlvbnMuc2lnbmF0dXJlVmVyc2lvbjsKICAgIH0sCiAgCiAgICBhbGdvcml0aG06ICdBV1M0LUhNQUMtU0hBMjU2JywKICAKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAgICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKGRhdGUpLnJlcGxhY2UoL1s6XC1dfFwuXGR7M30vZywgJycpOwogIAogICAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpKSB7CiAgICAgICAgdGhpcy51cGRhdGVGb3JQcmVzaWduZWQoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFkZEhlYWRlcnMoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgICAgfQogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0KICAgICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgIH0sCiAgCiAgICBhZGRIZWFkZXJzOiBmdW5jdGlvbiBhZGRIZWFkZXJzKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gZGF0ZXRpbWU7CiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogICAgfSwKICAKICAgIHVwZGF0ZUZvclByZXNpZ25lZDogZnVuY3Rpb24gdXBkYXRlRm9yUHJlc2lnbmVkKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgY3JlZFN0cmluZyA9IHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSk7CiAgICAgIHZhciBxcyA9IHsKICAgICAgICAnWC1BbXotRGF0ZSc6IGRhdGV0aW1lLAogICAgICAgICdYLUFtei1BbGdvcml0aG0nOiB0aGlzLmFsZ29yaXRobSwKICAgICAgICAnWC1BbXotQ3JlZGVudGlhbCc6IGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZywKICAgICAgICAnWC1BbXotRXhwaXJlcyc6IHRoaXMucmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdLAogICAgICAgICdYLUFtei1TaWduZWRIZWFkZXJzJzogdGhpcy5zaWduZWRIZWFkZXJzKCkKICAgICAgfTsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHFzWydYLUFtei1TZWN1cml0eS1Ub2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10pIHsKICAgICAgICBxc1snQ29udGVudC1UeXBlJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgICAgIH0KICAgICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LU1ENSddKSB7CiAgICAgICAgcXNbJ0NvbnRlbnQtTUQ1J10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1NRDUnXTsKICAgICAgfQogICAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXSkgewogICAgICAgIHFzWydDYWNoZS1Db250cm9sJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ2FjaGUtQ29udHJvbCddOwogICAgICB9CiAgCiAgICAgIC8vIG5lZWQgdG8gcHVsbCBpbiBhbnkgb3RoZXIgWC1BbXotKiBoZWFkZXJzCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIHJldHVybjsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICAgIHZhciBsb3dlcktleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgLy8gTWV0YWRhdGEgc2hvdWxkIGJlIG5vcm1hbGl6ZWQKICAgICAgICAgIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei1tZXRhLScpID09PSAwKSB7CiAgICAgICAgICAgIHFzW2xvd2VyS2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgewogICAgICAgICAgICBxc1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgdmFyIHNlcCA9IHRoaXMucmVxdWVzdC5wYXRoLmluZGV4T2YoJz8nKSA+PSAwID8gJyYnIDogJz8nOwogICAgICB0aGlzLnJlcXVlc3QucGF0aCArPSBzZXAgKyBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHFzKTsKICAgIH0sCiAgCiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdmFyIGNyZWRTdHJpbmcgPSB0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuYWxnb3JpdGhtICsgJyBDcmVkZW50aWFsPScgKwogICAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZyk7CiAgICAgIHBhcnRzLnB1c2goJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpKTsKICAgICAgcGFydHMucHVzaCgnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscywgZGF0ZXRpbWUpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJywgJyk7CiAgICB9LAogIAogICAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHZhciBzaWduaW5nS2V5ID0gdjRDcmVkZW50aWFscy5nZXRTaWduaW5nS2V5KAogICAgICAgIGNyZWRlbnRpYWxzLAogICAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICAgIHRoaXMuc2VydmljZU5hbWUsCiAgICAgICAgdGhpcy5zaWduYXR1cmVDYWNoZQogICAgICApOwogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoc2lnbmluZ0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oZGF0ZXRpbWUpLCAnaGV4Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oZGF0ZXRpbWUpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2goJ0FXUzQtSE1BQy1TSEEyNTYnKTsKICAgICAgcGFydHMucHVzaChkYXRldGltZSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLmNhbm9uaWNhbFN0cmluZygpKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbFN0cmluZzogZnVuY3Rpb24gY2Fub25pY2FsU3RyaW5nKCkgewogICAgICB2YXIgcGFydHMgPSBbXSwgcGF0aG5hbWUgPSB0aGlzLnJlcXVlc3QucGF0aG5hbWUoKTsKICAgICAgaWYgKHRoaXMuc2VydmljZU5hbWUgIT09ICdzMycgJiYgdGhpcy5zaWduYXR1cmVWZXJzaW9uICE9PSAnczN2NCcpIHBhdGhuYW1lID0gQVdTLnV0aWwudXJpRXNjYXBlUGF0aChwYXRobmFtZSk7CiAgCiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2gocGF0aG5hbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5zZWFyY2goKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkgKyAnXG4nKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnNpZ25lZEhlYWRlcnMoKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkQm9keUhhc2goKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgaXRlbSkgewogICAgICAgIGhlYWRlcnMucHVzaChba2V5LCBpdGVtXSk7CiAgICAgIH0pOwogICAgICBoZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYVswXS50b0xvd2VyQ2FzZSgpIDwgYlswXS50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgICB9KTsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGhlYWRlcnMsIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZW1bMF0udG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGl0ZW1bMV07CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdIZWFkZXIgJyArIGtleSArICcgY29udGFpbnMgaW52YWxpZCB2YWx1ZScpLCB7CiAgICAgICAgICAgICAgY29kZTogJ0ludmFsaWRIZWFkZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcGFydHMucHVzaChrZXkgKyAnOicgKwogICAgICAgICAgICB0aGlzLmNhbm9uaWNhbEhlYWRlclZhbHVlcyh2YWx1ZS50b1N0cmluZygpKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsSGVhZGVyVmFsdWVzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJWYWx1ZXModmFsdWVzKSB7CiAgICAgIHJldHVybiB2YWx1ZXMucmVwbGFjZSgvXHMrL2csICcgJykucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKICAgIH0sCiAgCiAgICBzaWduZWRIZWFkZXJzOiBmdW5jdGlvbiBzaWduZWRIZWFkZXJzKCkgewogICAgICB2YXIga2V5cyA9IFtdOwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIGtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGtleXMuc29ydCgpLmpvaW4oJzsnKTsKICAgIH0sCiAgCiAgICBjcmVkZW50aWFsU3RyaW5nOiBmdW5jdGlvbiBjcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSB7CiAgICAgIHJldHVybiB2NENyZWRlbnRpYWxzLmNyZWF0ZVNjb3BlKAogICAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICAgIHRoaXMuc2VydmljZU5hbWUKICAgICAgKTsKICAgIH0sCiAgCiAgICBoZXhFbmNvZGVkSGFzaDogZnVuY3Rpb24gaGFzaChzdHJpbmcpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYoc3RyaW5nLCAnaGV4Jyk7CiAgICB9LAogIAogICAgaGV4RW5jb2RlZEJvZHlIYXNoOiBmdW5jdGlvbiBoZXhFbmNvZGVkQm9keUhhc2goKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0OwogICAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpICYmIHRoaXMuc2VydmljZU5hbWUgPT09ICdzMycgJiYgIXJlcXVlc3QuYm9keSkgewogICAgICAgIHJldHVybiAnVU5TSUdORUQtUEFZTE9BRCc7CiAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddKSB7CiAgICAgICAgcmV0dXJuIHJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLnJlcXVlc3QuYm9keSB8fCAnJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB1bnNpZ25hYmxlSGVhZGVyczogWwogICAgICAnYXV0aG9yaXphdGlvbicsCiAgICAgICdjb250ZW50LXR5cGUnLAogICAgICAnY29udGVudC1sZW5ndGgnLAogICAgICAndXNlci1hZ2VudCcsCiAgICAgIGV4cGlyZXNIZWFkZXIsCiAgICAgICdleHBlY3QnLAogICAgICAneC1hbXpuLXRyYWNlLWlkJwogICAgXSwKICAKICAgIGlzU2lnbmFibGVIZWFkZXI6IGZ1bmN0aW9uIGlzU2lnbmFibGVIZWFkZXIoa2V5KSB7CiAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiB0aGlzLnVuc2lnbmFibGVIZWFkZXJzLmluZGV4T2Yoa2V5KSA8IDA7CiAgICB9LAogIAogICAgaXNQcmVzaWduZWQ6IGZ1bmN0aW9uIGlzUHJlc2lnbmVkKCkgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPyB0cnVlIDogZmFsc2U7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WNDsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4vdjRfY3JlZGVudGlhbHMiOjY5fV0sNjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGNhY2hlZFNlY3JldCA9IHt9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBjYWNoZVF1ZXVlID0gW107CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIG1heENhY2hlRW50cmllcyA9IDUwOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB2NElkZW50aWZpZXIgPSAnYXdzNF9yZXF1ZXN0JzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgICAqIEBwYXJhbSBzZXJ2aWNlTmFtZSBbU3RyaW5nXQogICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICovCiAgICBjcmVhdGVTY29wZTogZnVuY3Rpb24gY3JlYXRlU2NvcGUoZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlTmFtZSkgewogICAgICByZXR1cm4gWwogICAgICAgIGRhdGUuc3Vic3RyKDAsIDgpLAogICAgICAgIHJlZ2lvbiwKICAgICAgICBzZXJ2aWNlTmFtZSwKICAgICAgICB2NElkZW50aWZpZXIKICAgICAgXS5qb2luKCcvJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gY3JlZGVudGlhbHMgW0NyZWRlbnRpYWxzXQogICAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gc2hvdWxkQ2FjaGUgW0Jvb2xlYW5dCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgKi8KICAgIGdldFNpZ25pbmdLZXk6IGZ1bmN0aW9uIGdldFNpZ25pbmdLZXkoCiAgICAgIGNyZWRlbnRpYWxzLAogICAgICBkYXRlLAogICAgICByZWdpb24sCiAgICAgIHNlcnZpY2UsCiAgICAgIHNob3VsZENhY2hlCiAgICApIHsKICAgICAgdmFyIGNyZWRzSWRlbnRpZmllciA9IEFXUy51dGlsLmNyeXB0bwogICAgICAgIC5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQsICdiYXNlNjQnKTsKICAgICAgdmFyIGNhY2hlS2V5ID0gW2NyZWRzSWRlbnRpZmllciwgZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlXS5qb2luKCdfJyk7CiAgICAgIHNob3VsZENhY2hlID0gc2hvdWxkQ2FjaGUgIT09IGZhbHNlOwogICAgICBpZiAoc2hvdWxkQ2FjaGUgJiYgKGNhY2hlS2V5IGluIGNhY2hlZFNlY3JldCkpIHsKICAgICAgICByZXR1cm4gY2FjaGVkU2VjcmV0W2NhY2hlS2V5XTsKICAgICAgfQogIAogICAgICB2YXIga0RhdGUgPSBBV1MudXRpbC5jcnlwdG8uaG1hYygKICAgICAgICAnQVdTNCcgKyBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksCiAgICAgICAgZGF0ZSwKICAgICAgICAnYnVmZmVyJwogICAgICApOwogICAgICB2YXIga1JlZ2lvbiA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtEYXRlLCByZWdpb24sICdidWZmZXInKTsKICAgICAgdmFyIGtTZXJ2aWNlID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa1JlZ2lvbiwgc2VydmljZSwgJ2J1ZmZlcicpOwogIAogICAgICB2YXIgc2lnbmluZ0tleSA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtTZXJ2aWNlLCB2NElkZW50aWZpZXIsICdidWZmZXInKTsKICAgICAgaWYgKHNob3VsZENhY2hlKSB7CiAgICAgICAgY2FjaGVkU2VjcmV0W2NhY2hlS2V5XSA9IHNpZ25pbmdLZXk7CiAgICAgICAgY2FjaGVRdWV1ZS5wdXNoKGNhY2hlS2V5KTsKICAgICAgICBpZiAoY2FjaGVRdWV1ZS5sZW5ndGggPiBtYXhDYWNoZUVudHJpZXMpIHsKICAgICAgICAgIC8vIHJlbW92ZSB0aGUgb2xkZXN0IGVudHJ5IChub3QgdGhlIGxlYXN0IHJlY2VudGx5IHVzZWQpCiAgICAgICAgICBkZWxldGUgY2FjaGVkU2VjcmV0W2NhY2hlUXVldWUuc2hpZnQoKV07CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiBzaWduaW5nS2V5OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogRW1wdGllcyB0aGUgZGVyaXZlZCBzaWduaW5nIGtleSBjYWNoZS4gTWFkZSBhdmFpbGFibGUgZm9yIHRlc3RpbmcgcHVycG9zZXMKICAgICAqIG9ubHkuCiAgICAgKi8KICAgIGVtcHR5Q2FjaGU6IGZ1bmN0aW9uIGVtcHR5Q2FjaGUoKSB7CiAgICAgIGNhY2hlZFNlY3JldCA9IHt9OwogICAgICBjYWNoZVF1ZXVlID0gW107CiAgICB9CiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw3MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZnVuY3Rpb24gQWNjZXB0b3JTdGF0ZU1hY2hpbmUoc3RhdGVzLCBzdGF0ZSkgewogICAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZSB8fCBudWxsOwogICAgdGhpcy5zdGF0ZXMgPSBzdGF0ZXMgfHwge307CiAgfQogIAogIEFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5ydW5UbyA9IGZ1bmN0aW9uIHJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGlucHV0RXJyb3IpIHsKICAgIGlmICh0eXBlb2YgZmluYWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBpbnB1dEVycm9yID0gYmluZE9iamVjdDsgYmluZE9iamVjdCA9IGRvbmU7CiAgICAgIGRvbmUgPSBmaW5hbFN0YXRlOyBmaW5hbFN0YXRlID0gbnVsbDsKICAgIH0KICAKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBzdGF0ZSA9IHNlbGYuc3RhdGVzW3NlbGYuY3VycmVudFN0YXRlXTsKICAgIHN0YXRlLmZuLmNhbGwoYmluZE9iamVjdCB8fCBzZWxmLCBpbnB1dEVycm9yLCBmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKGVycikgewogICAgICAgIGlmIChzdGF0ZS5mYWlsKSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmZhaWw7CiAgICAgICAgZWxzZSByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoc3RhdGUuYWNjZXB0KSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmFjY2VwdDsKICAgICAgICBlbHNlIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QpIDogbnVsbDsKICAgICAgfQogICAgICBpZiAoc2VsZi5jdXJyZW50U3RhdGUgPT09IGZpbmFsU3RhdGUpIHsKICAgICAgICByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgICAgfQogIAogICAgICBzZWxmLnJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGVycik7CiAgICB9KTsKICB9OwogIAogIEFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5hZGRTdGF0ZSA9IGZ1bmN0aW9uIGFkZFN0YXRlKG5hbWUsIGFjY2VwdFN0YXRlLCBmYWlsU3RhdGUsIGZuKSB7CiAgICBpZiAodHlwZW9mIGFjY2VwdFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGZuID0gYWNjZXB0U3RhdGU7IGFjY2VwdFN0YXRlID0gbnVsbDsgZmFpbFN0YXRlID0gbnVsbDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGZhaWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBmbiA9IGZhaWxTdGF0ZTsgZmFpbFN0YXRlID0gbnVsbDsKICAgIH0KICAKICAgIGlmICghdGhpcy5jdXJyZW50U3RhdGUpIHRoaXMuY3VycmVudFN0YXRlID0gbmFtZTsKICAgIHRoaXMuc3RhdGVzW25hbWVdID0geyBhY2NlcHQ6IGFjY2VwdFN0YXRlLCBmYWlsOiBmYWlsU3RhdGUsIGZuOiBmbiB9OwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFjY2VwdG9yU3RhdGVNYWNoaW5lOwogIAogIH0se31dLDcxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3Msc2V0SW1tZWRpYXRlKXsoZnVuY3Rpb24gKCl7CiAgLyogZXNsaW50IGd1YXJkLWZvci1pbjowICovCiAgdmFyIEFXUzsKICAKICAvKioKICAgKiBBIHNldCBvZiB1dGlsaXR5IG1ldGhvZHMgZm9yIHVzZSB3aXRoIHRoZSBBV1MgU0RLLgogICAqCiAgICogQCFhdHRyaWJ1dGUgYWJvcnQKICAgKiAgIFJldHVybiB0aGlzIHZhbHVlIGZyb20gYW4gaXRlcmF0b3IgZnVuY3Rpb24ge2VhY2h9IG9yIHthcnJheUVhY2h9CiAgICogICB0byBicmVhayBvdXQgb2YgdGhlIGl0ZXJhdGlvbi4KICAgKiAgIEBleGFtcGxlIEJyZWFraW5nIG91dCBvZiBhbiBpdGVyYXRvciBmdW5jdGlvbgogICAqICAgICBBV1MudXRpbC5lYWNoKHthOiAxLCBiOiAyLCBjOiAzfSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAqICAgICAgIGlmIChrZXkgPT0gJ2InKSByZXR1cm4gQVdTLnV0aWwuYWJvcnQ7CiAgICogICAgIH0pOwogICAqICAgQHNlZSBlYWNoCiAgICogICBAc2VlIGFycmF5RWFjaAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB1dGlsID0gewogICAgZW52aXJvbm1lbnQ6ICdub2RlanMnLAogICAgZW5naW5lOiBmdW5jdGlvbiBlbmdpbmUoKSB7CiAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGVuZ2luZSA9IHByb2Nlc3MucGxhdGZvcm0gKyAnLycgKyBwcm9jZXNzLnZlcnNpb247CiAgICAgICAgaWYgKHByb2Nlc3MuZW52LkFXU19FWEVDVVRJT05fRU5WKSB7CiAgICAgICAgICBlbmdpbmUgKz0gJyBleGVjLWVudi8nICsgcHJvY2Vzcy5lbnYuQVdTX0VYRUNVVElPTl9FTlY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbmdpbmU7CiAgICAgIH0KICAgIH0sCiAgCiAgICB1c2VyQWdlbnQ6IGZ1bmN0aW9uIHVzZXJBZ2VudCgpIHsKICAgICAgdmFyIG5hbWUgPSB1dGlsLmVudmlyb25tZW50OwogICAgICB2YXIgYWdlbnQgPSAnYXdzLXNkay0nICsgbmFtZSArICcvJyArIHJlcXVpcmUoJy4vY29yZScpLlZFUlNJT047CiAgICAgIGlmIChuYW1lID09PSAnbm9kZWpzJykgYWdlbnQgKz0gJyAnICsgdXRpbC5lbmdpbmUoKTsKICAgICAgcmV0dXJuIGFnZW50OwogICAgfSwKICAKICAgIHVyaUVzY2FwZTogZnVuY3Rpb24gdXJpRXNjYXBlKHN0cmluZykgewogICAgICB2YXIgb3V0cHV0ID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZyk7CiAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9bXkEtWmEtejAtOV8uflwtJV0rL2csIGVzY2FwZSk7CiAgCiAgICAgIC8vIEFXUyBwZXJjZW50LWVuY29kZXMgc29tZSBleHRyYSBub24tc3RhbmRhcmQgY2hhcmFjdGVycyBpbiBhIFVSSQogICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvWypdL2csIGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgcmV0dXJuICclJyArIGNoLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gb3V0cHV0OwogICAgfSwKICAKICAgIHVyaUVzY2FwZVBhdGg6IGZ1bmN0aW9uIHVyaUVzY2FwZVBhdGgoc3RyaW5nKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICB1dGlsLmFycmF5RWFjaChzdHJpbmcuc3BsaXQoJy8nKSwgZnVuY3Rpb24gKHBhcnQpIHsKICAgICAgICBwYXJ0cy5wdXNoKHV0aWwudXJpRXNjYXBlKHBhcnQpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcvJyk7CiAgICB9LAogIAogICAgdXJsUGFyc2U6IGZ1bmN0aW9uIHVybFBhcnNlKHVybCkgewogICAgICByZXR1cm4gdXRpbC51cmwucGFyc2UodXJsKTsKICAgIH0sCiAgCiAgICB1cmxGb3JtYXQ6IGZ1bmN0aW9uIHVybEZvcm1hdCh1cmwpIHsKICAgICAgcmV0dXJuIHV0aWwudXJsLmZvcm1hdCh1cmwpOwogICAgfSwKICAKICAgIHF1ZXJ5U3RyaW5nUGFyc2U6IGZ1bmN0aW9uIHF1ZXJ5U3RyaW5nUGFyc2UocXMpIHsKICAgICAgcmV0dXJuIHV0aWwucXVlcnlzdHJpbmcucGFyc2UocXMpOwogICAgfSwKICAKICAgIHF1ZXJ5UGFyYW1zVG9TdHJpbmc6IGZ1bmN0aW9uIHF1ZXJ5UGFyYW1zVG9TdHJpbmcocGFyYW1zKSB7CiAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICB2YXIgZXNjYXBlID0gdXRpbC51cmlFc2NhcGU7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gT2JqZWN0LmtleXMocGFyYW1zKS5zb3J0KCk7CiAgCiAgICAgIHV0aWwuYXJyYXlFYWNoKHNvcnRlZEtleXMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbbmFtZV07CiAgICAgICAgdmFyIGVuYW1lID0gZXNjYXBlKG5hbWUpOwogICAgICAgIHZhciByZXN1bHQgPSBlbmFtZSArICc9JzsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHZhciB2YWxzID0gW107CiAgICAgICAgICB1dGlsLmFycmF5RWFjaCh2YWx1ZSwgZnVuY3Rpb24oaXRlbSkgeyB2YWxzLnB1c2goZXNjYXBlKGl0ZW0pKTsgfSk7CiAgICAgICAgICByZXN1bHQgPSBlbmFtZSArICc9JyArIHZhbHMuc29ydCgpLmpvaW4oJyYnICsgZW5hbWUgKyAnPScpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0ID0gZW5hbWUgKyAnPScgKyBlc2NhcGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBpdGVtcy5wdXNoKHJlc3VsdCk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gaXRlbXMuam9pbignJicpOwogICAgfSwKICAKICAgIHJlYWRGaWxlU3luYzogZnVuY3Rpb24gcmVhZEZpbGVTeW5jKHBhdGgpIHsKICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gcmVxdWlyZSgnZnMnKS5yZWFkRmlsZVN5bmMocGF0aCwgJ3V0Zi04Jyk7CiAgICB9LAogIAogICAgYmFzZTY0OiB7CiAgICAgIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlNjQoc3RyaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBlbmNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGJ1ZiA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgICAgcmV0dXJuIGJ1Zi50b1N0cmluZygnYmFzZTY0Jyk7CiAgICAgIH0sCiAgCiAgICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlNjQoc3RyaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBkZWNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZywgJ2Jhc2U2NCcpOwogICAgICB9CiAgCiAgICB9LAogIAogICAgYnVmZmVyOiB7CiAgICAgIC8qKgogICAgICAgKiBCdWZmZXIgY29uc3RydWN0b3IgZm9yIE5vZGUgYnVmZmVyIGFuZCBidWZmZXIgcG9sbHlmaWxsCiAgICAgICAqLwogICAgICB0b0J1ZmZlcjogZnVuY3Rpb24oZGF0YSwgZW5jb2RpbmcpIHsKICAgICAgICByZXR1cm4gKHR5cGVvZiB1dGlsLkJ1ZmZlci5mcm9tID09PSAnZnVuY3Rpb24nICYmIHV0aWwuQnVmZmVyLmZyb20gIT09IFVpbnQ4QXJyYXkuZnJvbSkgPwogICAgICAgICAgdXRpbC5CdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykgOiBuZXcgdXRpbC5CdWZmZXIoZGF0YSwgZW5jb2RpbmcpOwogICAgICB9LAogIAogICAgICBhbGxvYzogZnVuY3Rpb24oc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NpemUgcGFzc2VkIHRvIGFsbG9jIG11c3QgYmUgYSBudW1iZXIuJyk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgdXRpbC5CdWZmZXIuYWxsb2MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldHVybiB1dGlsLkJ1ZmZlci5hbGxvYyhzaXplLCBmaWxsLCBlbmNvZGluZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBidWYgPSBuZXcgdXRpbC5CdWZmZXIoc2l6ZSk7CiAgICAgICAgICBpZiAoZmlsbCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBidWYuZmlsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBidWYuZmlsbChmaWxsLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZW5jb2RpbmcpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJ1ZjsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHRvU3RyZWFtOiBmdW5jdGlvbiB0b1N0cmVhbShidWZmZXIpIHsKICAgICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ1ZmZlcikpIGJ1ZmZlciA9ICB1dGlsLmJ1ZmZlci50b0J1ZmZlcihidWZmZXIpOwogIAogICAgICAgIHZhciByZWFkYWJsZSA9IG5ldyAodXRpbC5zdHJlYW0uUmVhZGFibGUpKCk7CiAgICAgICAgdmFyIHBvcyA9IDA7CiAgICAgICAgcmVhZGFibGUuX3JlYWQgPSBmdW5jdGlvbihzaXplKSB7CiAgICAgICAgICBpZiAocG9zID49IGJ1ZmZlci5sZW5ndGgpIHJldHVybiByZWFkYWJsZS5wdXNoKG51bGwpOwogIAogICAgICAgICAgdmFyIGVuZCA9IHBvcyArIHNpemU7CiAgICAgICAgICBpZiAoZW5kID4gYnVmZmVyLmxlbmd0aCkgZW5kID0gYnVmZmVyLmxlbmd0aDsKICAgICAgICAgIHJlYWRhYmxlLnB1c2goYnVmZmVyLnNsaWNlKHBvcywgZW5kKSk7CiAgICAgICAgICBwb3MgPSBlbmQ7CiAgICAgICAgfTsKICAKICAgICAgICByZXR1cm4gcmVhZGFibGU7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBDb25jYXRlbmF0ZXMgYSBsaXN0IG9mIEJ1ZmZlciBvYmplY3RzLgogICAgICAgKi8KICAgICAgY29uY2F0OiBmdW5jdGlvbihidWZmZXJzKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IDAsCiAgICAgICAgICAgIG9mZnNldCA9IDAsCiAgICAgICAgICAgIGJ1ZmZlciA9IG51bGwsIGk7CiAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1ZmZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGxlbmd0aCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgCiAgICAgICAgYnVmZmVyID0gdXRpbC5idWZmZXIuYWxsb2MobGVuZ3RoKTsKICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgYnVmZmVyc1tpXS5jb3B5KGJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgICAgIG9mZnNldCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGJ1ZmZlcjsKICAgICAgfQogICAgfSwKICAKICAgIHN0cmluZzogewogICAgICBieXRlTGVuZ3RoOiBmdW5jdGlvbiBieXRlTGVuZ3RoKHN0cmluZykgewogICAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgc3RyaW5nID09PSB1bmRlZmluZWQpIHJldHVybiAwOwogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJykgc3RyaW5nID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAKICAgICAgICBpZiAodHlwZW9mIHN0cmluZy5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5sZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nLmxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcuc2l6ZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcuc2l6ZTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcucGF0aCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiByZXF1aXJlKCdmcycpLmxzdGF0U3luYyhzdHJpbmcucGF0aCkuc2l6ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBkZXRlcm1pbmUgbGVuZ3RoIG9mICcgKyBzdHJpbmcpLAogICAgICAgICAgICB7IG9iamVjdDogc3RyaW5nIH0pOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgdXBwZXJGaXJzdDogZnVuY3Rpb24gdXBwZXJGaXJzdChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nWzBdLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc3Vic3RyKDEpOwogICAgICB9LAogIAogICAgICBsb3dlckZpcnN0OiBmdW5jdGlvbiBsb3dlckZpcnN0KHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmdbMF0udG9Mb3dlckNhc2UoKSArIHN0cmluZy5zdWJzdHIoMSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICBpbmk6IHsKICAgICAgcGFyc2U6IGZ1bmN0aW9uIHN0cmluZyhpbmkpIHsKICAgICAgICB2YXIgY3VycmVudFNlY3Rpb24sIG1hcCA9IHt9OwogICAgICAgIHV0aWwuYXJyYXlFYWNoKGluaS5zcGxpdCgvXHI/XG4vKSwgZnVuY3Rpb24obGluZSkgewogICAgICAgICAgbGluZSA9IGxpbmUuc3BsaXQoLyhefFxzKVs7I10vKVswXTsgLy8gcmVtb3ZlIGNvbW1lbnRzCiAgICAgICAgICB2YXIgc2VjdGlvbiA9IGxpbmUubWF0Y2goL15ccypcWyhbXlxbXF1dKylcXVxzKiQvKTsKICAgICAgICAgIGlmIChzZWN0aW9uKSB7CiAgICAgICAgICAgIGN1cnJlbnRTZWN0aW9uID0gc2VjdGlvblsxXTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFNlY3Rpb24pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBsaW5lLm1hdGNoKC9eXHMqKC4rPylccyo9XHMqKC4rPylccyokLyk7CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXSA9IG1hcFtjdXJyZW50U2VjdGlvbl0gfHwge307CiAgICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXVtpdGVtWzFdXSA9IGl0ZW1bMl07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAKICAgICAgICByZXR1cm4gbWFwOwogICAgICB9CiAgICB9LAogIAogICAgZm46IHsKICAgICAgbm9vcDogZnVuY3Rpb24oKSB7fSwKICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIChlcnIpIHsgaWYgKGVycikgdGhyb3cgZXJyOyB9LAogIAogICAgICAvKioKICAgICAgICogVHVybiBhIHN5bmNocm9ub3VzIGZ1bmN0aW9uIGludG8gYXMgImFzeW5jIiBmdW5jdGlvbiBieSBtYWtpbmcgaXQgY2FsbAogICAgICAgKiBhIGNhbGxiYWNrLiBUaGUgdW5kZXJseWluZyBmdW5jdGlvbiBpcyBjYWxsZWQgd2l0aCBhbGwgYnV0IHRoZSBsYXN0IGFyZ3VtZW50LAogICAgICAgKiB3aGljaCBpcyB0cmVhdGVkIGFzIHRoZSBjYWxsYmFjay4gVGhlIGNhbGxiYWNrIGlzIHBhc3NlZCBwYXNzZWQgYSBmaXJzdCBhcmd1bWVudAogICAgICAgKiBvZiBudWxsIG9uIHN1Y2Nlc3MgdG8gbWltaWNrIHN0YW5kYXJkIG5vZGUgY2FsbGJhY2tzLgogICAgICAgKi8KICAgICAgbWFrZUFzeW5jOiBmdW5jdGlvbiBtYWtlQXN5bmMoZm4sIGV4cGVjdGVkQXJncykgewogICAgICAgIGlmIChleHBlY3RlZEFyZ3MgJiYgZXhwZWN0ZWRBcmdzIDw9IGZuLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKICAgICAgICB9OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBEYXRlIGFuZCB0aW1lIHV0aWxpdHkgZnVuY3Rpb25zLgogICAgICovCiAgICBkYXRlOiB7CiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtEYXRlXSB0aGUgY3VycmVudCBKYXZhU2NyaXB0IGRhdGUgb2JqZWN0LiBTaW5jZSBhbGwKICAgICAgICogICBBV1Mgc2VydmljZXMgcmVseSBvbiB0aGlzIGRhdGUgb2JqZWN0LCB5b3UgY2FuIG92ZXJyaWRlCiAgICAgICAqICAgdGhpcyBmdW5jdGlvbiB0byBwcm92aWRlIGEgc3BlY2lhbCB0aW1lIHZhbHVlIHRvIEFXUyBzZXJ2aWNlCiAgICAgICAqICAgcmVxdWVzdHMuCiAgICAgICAqLwogICAgICBnZXREYXRlOiBmdW5jdGlvbiBnZXREYXRlKCkgewogICAgICAgIGlmICghQVdTKSBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAgICAgICBpZiAoQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCkgeyAvLyB1c2Ugb2Zmc2V0IHdoZW4gbm9uLXplcm8KICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBkYXRlIGluIElTTy04NjAxIGZvcm1hdAogICAgICAgKi8KICAgICAgaXNvODYwMTogZnVuY3Rpb24gaXNvODYwMShkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvXC5cZHszfVokLywgJ1onKTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIGRhdGUgaW4gUkZDIDgyMiBmb3JtYXQKICAgICAgICovCiAgICAgIHJmYzgyMjogZnVuY3Rpb24gcmZjODIyKGRhdGUpIHsKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgICAgcmV0dXJuIGRhdGUudG9VVENTdHJpbmcoKTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW0ludGVnZXJdIHRoZSBVTklYIHRpbWVzdGFtcCB2YWx1ZSBmb3IgdGhlIGN1cnJlbnQgdGltZQogICAgICAgKi8KICAgICAgdW5peFRpbWVzdGFtcDogZnVuY3Rpb24gdW5peFRpbWVzdGFtcChkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKSAvIDEwMDA7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcGFyYW0gW1N0cmluZyxudW1iZXIsRGF0ZV0gZGF0ZQogICAgICAgKiBAcmV0dXJuIFtEYXRlXQogICAgICAgKi8KICAgICAgZnJvbTogZnVuY3Rpb24gZm9ybWF0KGRhdGUpIHsKICAgICAgICBpZiAodHlwZW9mIGRhdGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSAqIDEwMDApOyAvLyB1bml4IHRpbWVzdGFtcAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogR2l2ZW4gYSBEYXRlIG9yIGRhdGUtbGlrZSB2YWx1ZSwgdGhpcyBmdW5jdGlvbiBmb3JtYXRzIHRoZQogICAgICAgKiBkYXRlIGludG8gYSBzdHJpbmcgb2YgdGhlIHJlcXVlc3RlZCB2YWx1ZS4KICAgICAgICogQHBhcmFtIFtTdHJpbmcsbnVtYmVyLERhdGVdIGRhdGUKICAgICAgICogQHBhcmFtIFtTdHJpbmddIGZvcm1hdHRlciBWYWxpZCBmb3JtYXRzIGFyZToKICAgICAgICMgICAqICdpc284NjAxJwogICAgICAgIyAgICogJ3JmYzgyMicKICAgICAgICMgICAqICd1bml4VGltZXN0YW1wJwogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgICAqLwogICAgICBmb3JtYXQ6IGZ1bmN0aW9uIGZvcm1hdChkYXRlLCBmb3JtYXR0ZXIpIHsKICAgICAgICBpZiAoIWZvcm1hdHRlcikgZm9ybWF0dGVyID0gJ2lzbzg2MDEnOwogICAgICAgIHJldHVybiB1dGlsLmRhdGVbZm9ybWF0dGVyXSh1dGlsLmRhdGUuZnJvbShkYXRlKSk7CiAgICAgIH0sCiAgCiAgICAgIHBhcnNlVGltZXN0YW1wOiBmdW5jdGlvbiBwYXJzZVRpbWVzdGFtcCh2YWx1ZSkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7IC8vIHVuaXggdGltZXN0YW1wIChudW1iZXIpCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGQrJC8pKSB7IC8vIHVuaXggdGltZXN0YW1wCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGR7NH0vKSkgeyAvLyBpc284NjAxCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cd3szfSwvKSkgeyAvLyByZmM4MjIKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IoCiAgICAgICAgICAgIG5ldyBFcnJvcigndW5oYW5kbGVkIHRpbWVzdGFtcCBmb3JtYXQ6ICcgKyB2YWx1ZSksCiAgICAgICAgICAgIHtjb2RlOiAnVGltZXN0YW1wUGFyc2VyRXJyb3InfSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICB9LAogIAogICAgY3J5cHRvOiB7CiAgICAgIGNyYzMyVGFibGU6IFsKICAgICAgIDB4MDAwMDAwMDAsIDB4NzcwNzMwOTYsIDB4RUUwRTYxMkMsIDB4OTkwOTUxQkEsIDB4MDc2REM0MTksCiAgICAgICAweDcwNkFGNDhGLCAweEU5NjNBNTM1LCAweDlFNjQ5NUEzLCAweDBFREI4ODMyLCAweDc5RENCOEE0LAogICAgICAgMHhFMEQ1RTkxRSwgMHg5N0QyRDk4OCwgMHgwOUI2NEMyQiwgMHg3RUIxN0NCRCwgMHhFN0I4MkQwNywKICAgICAgIDB4OTBCRjFEOTEsIDB4MURCNzEwNjQsIDB4NkFCMDIwRjIsIDB4RjNCOTcxNDgsIDB4ODRCRTQxREUsCiAgICAgICAweDFBREFENDdELCAweDZERERFNEVCLCAweEY0RDRCNTUxLCAweDgzRDM4NUM3LCAweDEzNkM5ODU2LAogICAgICAgMHg2NDZCQThDMCwgMHhGRDYyRjk3QSwgMHg4QTY1QzlFQywgMHgxNDAxNUM0RiwgMHg2MzA2NkNEOSwKICAgICAgIDB4RkEwRjNENjMsIDB4OEQwODBERjUsIDB4M0I2RTIwQzgsIDB4NEM2OTEwNUUsIDB4RDU2MDQxRTQsCiAgICAgICAweEEyNjc3MTcyLCAweDNDMDNFNEQxLCAweDRCMDRENDQ3LCAweEQyMEQ4NUZELCAweEE1MEFCNTZCLAogICAgICAgMHgzNUI1QThGQSwgMHg0MkIyOTg2QywgMHhEQkJCQzlENiwgMHhBQ0JDRjk0MCwgMHgzMkQ4NkNFMywKICAgICAgIDB4NDVERjVDNzUsIDB4RENENjBEQ0YsIDB4QUJEMTNENTksIDB4MjZEOTMwQUMsIDB4NTFERTAwM0EsCiAgICAgICAweEM4RDc1MTgwLCAweEJGRDA2MTE2LCAweDIxQjRGNEI1LCAweDU2QjNDNDIzLCAweENGQkE5NTk5LAogICAgICAgMHhCOEJEQTUwRiwgMHgyODAyQjg5RSwgMHg1RjA1ODgwOCwgMHhDNjBDRDlCMiwgMHhCMTBCRTkyNCwKICAgICAgIDB4MkY2RjdDODcsIDB4NTg2ODRDMTEsIDB4QzE2MTFEQUIsIDB4QjY2NjJEM0QsIDB4NzZEQzQxOTAsCiAgICAgICAweDAxREI3MTA2LCAweDk4RDIyMEJDLCAweEVGRDUxMDJBLCAweDcxQjE4NTg5LCAweDA2QjZCNTFGLAogICAgICAgMHg5RkJGRTRBNSwgMHhFOEI4RDQzMywgMHg3ODA3QzlBMiwgMHgwRjAwRjkzNCwgMHg5NjA5QTg4RSwKICAgICAgIDB4RTEwRTk4MTgsIDB4N0Y2QTBEQkIsIDB4MDg2RDNEMkQsIDB4OTE2NDZDOTcsIDB4RTY2MzVDMDEsCiAgICAgICAweDZCNkI1MUY0LCAweDFDNkM2MTYyLCAweDg1NjUzMEQ4LCAweEYyNjIwMDRFLCAweDZDMDY5NUVELAogICAgICAgMHgxQjAxQTU3QiwgMHg4MjA4RjRDMSwgMHhGNTBGQzQ1NywgMHg2NUIwRDlDNiwgMHgxMkI3RTk1MCwKICAgICAgIDB4OEJCRUI4RUEsIDB4RkNCOTg4N0MsIDB4NjJERDFEREYsIDB4MTVEQTJENDksIDB4OENEMzdDRjMsCiAgICAgICAweEZCRDQ0QzY1LCAweDREQjI2MTU4LCAweDNBQjU1MUNFLCAweEEzQkMwMDc0LCAweEQ0QkIzMEUyLAogICAgICAgMHg0QURGQTU0MSwgMHgzREQ4OTVENywgMHhBNEQxQzQ2RCwgMHhEM0Q2RjRGQiwgMHg0MzY5RTk2QSwKICAgICAgIDB4MzQ2RUQ5RkMsIDB4QUQ2Nzg4NDYsIDB4REE2MEI4RDAsIDB4NDQwNDJENzMsIDB4MzMwMzFERTUsCiAgICAgICAweEFBMEE0QzVGLCAweEREMEQ3Q0M5LCAweDUwMDU3MTNDLCAweDI3MDI0MUFBLCAweEJFMEIxMDEwLAogICAgICAgMHhDOTBDMjA4NiwgMHg1NzY4QjUyNSwgMHgyMDZGODVCMywgMHhCOTY2RDQwOSwgMHhDRTYxRTQ5RiwKICAgICAgIDB4NUVERUY5MEUsIDB4MjlEOUM5OTgsIDB4QjBEMDk4MjIsIDB4QzdEN0E4QjQsIDB4NTlCMzNEMTcsCiAgICAgICAweDJFQjQwRDgxLCAweEI3QkQ1QzNCLCAweEMwQkE2Q0FELCAweEVEQjg4MzIwLCAweDlBQkZCM0I2LAogICAgICAgMHgwM0I2RTIwQywgMHg3NEIxRDI5QSwgMHhFQUQ1NDczOSwgMHg5REQyNzdBRiwgMHgwNERCMjYxNSwKICAgICAgIDB4NzNEQzE2ODMsIDB4RTM2MzBCMTIsIDB4OTQ2NDNCODQsIDB4MEQ2RDZBM0UsIDB4N0E2QTVBQTgsCiAgICAgICAweEU0MEVDRjBCLCAweDkzMDlGRjlELCAweDBBMDBBRTI3LCAweDdEMDc5RUIxLCAweEYwMEY5MzQ0LAogICAgICAgMHg4NzA4QTNEMiwgMHgxRTAxRjI2OCwgMHg2OTA2QzJGRSwgMHhGNzYyNTc1RCwgMHg4MDY1NjdDQiwKICAgICAgIDB4MTk2QzM2NzEsIDB4NkU2QjA2RTcsIDB4RkVENDFCNzYsIDB4ODlEMzJCRTAsIDB4MTBEQTdBNUEsCiAgICAgICAweDY3REQ0QUNDLCAweEY5QjlERjZGLCAweDhFQkVFRkY5LCAweDE3QjdCRTQzLCAweDYwQjA4RUQ1LAogICAgICAgMHhENkQ2QTNFOCwgMHhBMUQxOTM3RSwgMHgzOEQ4QzJDNCwgMHg0RkRGRjI1MiwgMHhEMUJCNjdGMSwKICAgICAgIDB4QTZCQzU3NjcsIDB4M0ZCNTA2REQsIDB4NDhCMjM2NEIsIDB4RDgwRDJCREEsIDB4QUYwQTFCNEMsCiAgICAgICAweDM2MDM0QUY2LCAweDQxMDQ3QTYwLCAweERGNjBFRkMzLCAweEE4NjdERjU1LCAweDMxNkU4RUVGLAogICAgICAgMHg0NjY5QkU3OSwgMHhDQjYxQjM4QywgMHhCQzY2ODMxQSwgMHgyNTZGRDJBMCwgMHg1MjY4RTIzNiwKICAgICAgIDB4Q0MwQzc3OTUsIDB4QkIwQjQ3MDMsIDB4MjIwMjE2QjksIDB4NTUwNTI2MkYsIDB4QzVCQTNCQkUsCiAgICAgICAweEIyQkQwQjI4LCAweDJCQjQ1QTkyLCAweDVDQjM2QTA0LCAweEMyRDdGRkE3LCAweEI1RDBDRjMxLAogICAgICAgMHgyQ0Q5OUU4QiwgMHg1QkRFQUUxRCwgMHg5QjY0QzJCMCwgMHhFQzYzRjIyNiwgMHg3NTZBQTM5QywKICAgICAgIDB4MDI2RDkzMEEsIDB4OUMwOTA2QTksIDB4RUIwRTM2M0YsIDB4NzIwNzY3ODUsIDB4MDUwMDU3MTMsCiAgICAgICAweDk1QkY0QTgyLCAweEUyQjg3QTE0LCAweDdCQjEyQkFFLCAweDBDQjYxQjM4LCAweDkyRDI4RTlCLAogICAgICAgMHhFNUQ1QkUwRCwgMHg3Q0RDRUZCNywgMHgwQkRCREYyMSwgMHg4NkQzRDJENCwgMHhGMUQ0RTI0MiwKICAgICAgIDB4NjhEREIzRjgsIDB4MUZEQTgzNkUsIDB4ODFCRTE2Q0QsIDB4RjZCOTI2NUIsIDB4NkZCMDc3RTEsCiAgICAgICAweDE4Qjc0Nzc3LCAweDg4MDg1QUU2LCAweEZGMEY2QTcwLCAweDY2MDYzQkNBLCAweDExMDEwQjVDLAogICAgICAgMHg4RjY1OUVGRiwgMHhGODYyQUU2OSwgMHg2MTZCRkZEMywgMHgxNjZDQ0Y0NSwgMHhBMDBBRTI3OCwKICAgICAgIDB4RDcwREQyRUUsIDB4NEUwNDgzNTQsIDB4MzkwM0IzQzIsIDB4QTc2NzI2NjEsIDB4RDA2MDE2RjcsCiAgICAgICAweDQ5Njk0NzRELCAweDNFNkU3N0RCLCAweEFFRDE2QTRBLCAweEQ5RDY1QURDLCAweDQwREYwQjY2LAogICAgICAgMHgzN0Q4M0JGMCwgMHhBOUJDQUU1MywgMHhERUJCOUVDNSwgMHg0N0IyQ0Y3RiwgMHgzMEI1RkZFOSwKICAgICAgIDB4QkRCREYyMUMsIDB4Q0FCQUMyOEEsIDB4NTNCMzkzMzAsIDB4MjRCNEEzQTYsIDB4QkFEMDM2MDUsCiAgICAgICAweENERDcwNjkzLCAweDU0REU1NzI5LCAweDIzRDk2N0JGLCAweEIzNjY3QTJFLCAweEM0NjE0QUI4LAogICAgICAgMHg1RDY4MUIwMiwgMHgyQTZGMkI5NCwgMHhCNDBCQkUzNywgMHhDMzBDOEVBMSwgMHg1QTA1REYxQiwKICAgICAgIDB4MkQwMkVGOERdLAogIAogICAgICBjcmMzMjogZnVuY3Rpb24gY3JjMzIoZGF0YSkgewogICAgICAgIHZhciB0YmwgPSB1dGlsLmNyeXB0by5jcmMzMlRhYmxlOwogICAgICAgIHZhciBjcmMgPSAwIF4gLTE7CiAgCiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgZGF0YSA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKGRhdGEpOwogICAgICAgIH0KICAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBjb2RlID0gZGF0YS5yZWFkVUludDgoaSk7CiAgICAgICAgICBjcmMgPSAoY3JjID4+PiA4KSBeIHRibFsoY3JjIF4gY29kZSkgJiAweEZGXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChjcmMgXiAtMSkgPj4+IDA7CiAgICAgIH0sCiAgCiAgICAgIGhtYWM6IGZ1bmN0aW9uIGhtYWMoa2V5LCBzdHJpbmcsIGRpZ2VzdCwgZm4pIHsKICAgICAgICBpZiAoIWRpZ2VzdCkgZGlnZXN0ID0gJ2JpbmFyeSc7CiAgICAgICAgaWYgKGRpZ2VzdCA9PT0gJ2J1ZmZlcicpIHsgZGlnZXN0ID0gdW5kZWZpbmVkOyB9CiAgICAgICAgaWYgKCFmbikgZm4gPSAnc2hhMjU2JzsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHN0cmluZyA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmxpYi5jcmVhdGVIbWFjKGZuLCBrZXkpLnVwZGF0ZShzdHJpbmcpLmRpZ2VzdChkaWdlc3QpOwogICAgICB9LAogIAogICAgICBtZDU6IGZ1bmN0aW9uIG1kNShkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ21kNScsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgICB9LAogIAogICAgICBzaGEyNTY6IGZ1bmN0aW9uIHNoYTI1NihkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ3NoYTI1NicsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgICB9LAogIAogICAgICBoYXNoOiBmdW5jdGlvbihhbGdvcml0aG0sIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgaGFzaCA9IHV0aWwuY3J5cHRvLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTsKICAgICAgICBpZiAoIWRpZ2VzdCkgeyBkaWdlc3QgPSAnYmluYXJ5JzsgfQogICAgICAgIGlmIChkaWdlc3QgPT09ICdidWZmZXInKSB7IGRpZ2VzdCA9IHVuZGVmaW5lZDsgfQogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihkYXRhKTsKICAgICAgICB2YXIgc2xpY2VGbiA9IHV0aWwuYXJyYXlTbGljZUZuKGRhdGEpOwogICAgICAgIHZhciBpc0J1ZmZlciA9IHV0aWwuQnVmZmVyLmlzQnVmZmVyKGRhdGEpOwogICAgICAgIC8vSWRlbnRpZnlpbmcgb2JqZWN0cyB3aXRoIGFuIEFycmF5QnVmZmVyIGFzIGJ1ZmZlcnMKICAgICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIGRhdGEgJiYgZGF0YS5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgaXNCdWZmZXIgPSB0cnVlOwogIAogICAgICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgdHlwZW9mIGRhdGEub24gPT09ICdmdW5jdGlvbicgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgICBkYXRhLm9uKCdkYXRhJywgZnVuY3Rpb24oY2h1bmspIHsgaGFzaC51cGRhdGUoY2h1bmspOyB9KTsKICAgICAgICAgIGRhdGEub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7IGNhbGxiYWNrKGVycik7IH0pOwogICAgICAgICAgZGF0YS5vbignZW5kJywgZnVuY3Rpb24oKSB7IGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOyB9KTsKICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrICYmIHNsaWNlRm4gJiYgIWlzQnVmZmVyICYmCiAgICAgICAgICAgICAgICAgICB0eXBlb2YgRmlsZVJlYWRlciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIC8vIHRoaXMgbWlnaHQgYmUgYSBGaWxlL0Jsb2IKICAgICAgICAgIHZhciBpbmRleCA9IDAsIHNpemUgPSAxMDI0ICogNTEyOwogICAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgICByZWFkZXIub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZWFkIGRhdGEuJykpOwogICAgICAgICAgfTsKICAgICAgICAgIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJ1ZiA9IG5ldyB1dGlsLkJ1ZmZlcihuZXcgVWludDhBcnJheShyZWFkZXIucmVzdWx0KSk7CiAgICAgICAgICAgIGhhc2gudXBkYXRlKGJ1Zik7CiAgICAgICAgICAgIGluZGV4ICs9IGJ1Zi5sZW5ndGg7CiAgICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nKCk7CiAgICAgICAgICB9OwogICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGluZGV4ID49IGRhdGEuc2l6ZSkgewogICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICB2YXIgYmFjayA9IGluZGV4ICsgc2l6ZTsKICAgICAgICAgICAgaWYgKGJhY2sgPiBkYXRhLnNpemUpIGJhY2sgPSBkYXRhLnNpemU7CiAgICAgICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihzbGljZUZuLmNhbGwoZGF0YSwgaW5kZXgsIGJhY2spKTsKICAgICAgICAgIH07CiAgCiAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgICAgIGRhdGEgPSBuZXcgdXRpbC5CdWZmZXIobmV3IFVpbnQ4QXJyYXkoZGF0YSkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG91dCA9IGhhc2gudXBkYXRlKGRhdGEpLmRpZ2VzdChkaWdlc3QpOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsLCBvdXQpOwogICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHRvSGV4OiBmdW5jdGlvbiB0b0hleChkYXRhKSB7CiAgICAgICAgdmFyIG91dCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgb3V0LnB1c2goKCcwJyArIGRhdGEuY2hhckNvZGVBdChpKS50b1N0cmluZygxNikpLnN1YnN0cigtMiwgMikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0LmpvaW4oJycpOwogICAgICB9LAogIAogICAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZ29yaXRobSkgewogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5saWIuY3JlYXRlSGFzaChhbGdvcml0aG0pOwogICAgICB9CiAgCiAgICB9LAogIAogICAgLyoqIEAhaWdub3JlICovCiAgCiAgICAvKiBBYm9ydCBjb25zdGFudCAqLwogICAgYWJvcnQ6IHt9LAogIAogICAgZWFjaDogZnVuY3Rpb24gZWFjaChvYmplY3QsIGl0ZXJGdW5jdGlvbikgewogICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHsKICAgICAgICAgIHZhciByZXQgPSBpdGVyRnVuY3Rpb24uY2FsbCh0aGlzLCBrZXksIG9iamVjdFtrZXldKTsKICAgICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIGFycmF5RWFjaDogZnVuY3Rpb24gYXJyYXlFYWNoKGFycmF5LCBpdGVyRnVuY3Rpb24pIHsKICAgICAgZm9yICh2YXIgaWR4IGluIGFycmF5KSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChhcnJheSwgaWR4KSkgewogICAgICAgICAgdmFyIHJldCA9IGl0ZXJGdW5jdGlvbi5jYWxsKHRoaXMsIGFycmF5W2lkeF0sIHBhcnNlSW50KGlkeCwgMTApKTsKICAgICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9iajEsIG9iajIpIHsKICAgICAgdXRpbC5lYWNoKG9iajIsIGZ1bmN0aW9uIGl0ZXJhdG9yKGtleSwgaXRlbSkgewogICAgICAgIG9iajFba2V5XSA9IGl0ZW07CiAgICAgIH0pOwogICAgICByZXR1cm4gb2JqMTsKICAgIH0sCiAgCiAgICBtZXJnZTogZnVuY3Rpb24gbWVyZ2Uob2JqMSwgb2JqMikgewogICAgICByZXR1cm4gdXRpbC51cGRhdGUodXRpbC5jb3B5KG9iajEpLCBvYmoyKTsKICAgIH0sCiAgCiAgICBjb3B5OiBmdW5jdGlvbiBjb3B5KG9iamVjdCkgewogICAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IG9iamVjdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gb2JqZWN0OwogICAgICB2YXIgZHVwZSA9IHt9OwogICAgICAvLyBqc2hpbnQgZm9yaW46ZmFsc2UKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgIGR1cGVba2V5XSA9IG9iamVjdFtrZXldOwogICAgICB9CiAgICAgIHJldHVybiBkdXBlOwogICAgfSwKICAKICAgIGlzRW1wdHk6IGZ1bmN0aW9uIGlzRW1wdHkob2JqKSB7CiAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAKICAgIGFycmF5U2xpY2VGbjogZnVuY3Rpb24gYXJyYXlTbGljZUZuKG9iaikgewogICAgICB2YXIgZm4gPSBvYmouc2xpY2UgfHwgb2JqLndlYmtpdFNsaWNlIHx8IG9iai5tb3pTbGljZTsKICAgICAgcmV0dXJuIHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJyA/IGZuIDogbnVsbDsKICAgIH0sCiAgCiAgICBpc1R5cGU6IGZ1bmN0aW9uIGlzVHlwZShvYmosIHR5cGUpIHsKICAgICAgLy8gaGFuZGxlIGNyb3NzLSJmcmFtZSIgb2JqZWN0cwogICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicpIHR5cGUgPSB1dGlsLnR5cGVOYW1lKHR5cGUpOwogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyB0eXBlICsgJ10nOwogICAgfSwKICAKICAgIHR5cGVOYW1lOiBmdW5jdGlvbiB0eXBlTmFtZSh0eXBlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodHlwZSwgJ25hbWUnKSkgcmV0dXJuIHR5cGUubmFtZTsKICAgICAgdmFyIHN0ciA9IHR5cGUudG9TdHJpbmcoKTsKICAgICAgdmFyIG1hdGNoID0gc3RyLm1hdGNoKC9eXHMqZnVuY3Rpb24gKC4rKVwoLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogc3RyOwogICAgfSwKICAKICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihlcnIsIG9wdGlvbnMpIHsKICAgICAgdmFyIG9yaWdpbmFsRXJyb3IgPSBudWxsOwogICAgICBpZiAodHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJyAmJiBlcnIubWVzc2FnZSAhPT0gJycpIHsKICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnIHx8IChvcHRpb25zICYmIG9wdGlvbnMubWVzc2FnZSkpIHsKICAgICAgICAgIG9yaWdpbmFsRXJyb3IgPSB1dGlsLmNvcHkoZXJyKTsKICAgICAgICAgIG9yaWdpbmFsRXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgIH0KICAgICAgfQogICAgICBlcnIubWVzc2FnZSA9IGVyci5tZXNzYWdlIHx8IG51bGw7CiAgCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnM7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmIG9wdGlvbnMgIT09IG51bGwpIHsKICAgICAgICB1dGlsLnVwZGF0ZShlcnIsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UpCiAgICAgICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnMubWVzc2FnZTsKICAgICAgICBpZiAob3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZSkKICAgICAgICAgIGVyci5jb2RlID0gb3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZTsKICAgICAgICBpZiAob3B0aW9ucy5zdGFjaykKICAgICAgICAgIGVyci5zdGFjayA9IG9wdGlvbnMuc3RhY2s7CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbmFtZScsIHt3cml0YWJsZTogdHJ1ZSwgZW51bWVyYWJsZTogZmFsc2V9KTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbWVzc2FnZScsIHtlbnVtZXJhYmxlOiB0cnVlfSk7CiAgICAgIH0KICAKICAgICAgZXJyLm5hbWUgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZSB8fCBlcnIubmFtZSB8fCBlcnIuY29kZSB8fCAnRXJyb3InOwogICAgICBlcnIudGltZSA9IG5ldyBEYXRlKCk7CiAgCiAgICAgIGlmIChvcmlnaW5hbEVycm9yKSBlcnIub3JpZ2luYWxFcnJvciA9IG9yaWdpbmFsRXJyb3I7CiAgCiAgICAgIHJldHVybiBlcnI7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaW5oZXJpdDogZnVuY3Rpb24gaW5oZXJpdChrbGFzcywgZmVhdHVyZXMpIHsKICAgICAgdmFyIG5ld09iamVjdCA9IG51bGw7CiAgICAgIGlmIChmZWF0dXJlcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZmVhdHVyZXMgPSBrbGFzczsKICAgICAgICBrbGFzcyA9IE9iamVjdDsKICAgICAgICBuZXdPYmplY3QgPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY3RvciA9IGZ1bmN0aW9uIENvbnN0cnVjdG9yV3JhcHBlcigpIHt9OwogICAgICAgIGN0b3IucHJvdG90eXBlID0ga2xhc3MucHJvdG90eXBlOwogICAgICAgIG5ld09iamVjdCA9IG5ldyBjdG9yKCk7CiAgICAgIH0KICAKICAgICAgLy8gY29uc3RydWN0b3Igbm90IHN1cHBsaWVkLCBjcmVhdGUgcGFzcy10aHJvdWdoIGN0b3IKICAgICAgaWYgKGZlYXR1cmVzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICBmZWF0dXJlcy5jb25zdHJ1Y3RvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGtsYXNzICE9PSBPYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIGtsYXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogIAogICAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBuZXdPYmplY3Q7CiAgICAgIHV0aWwudXBkYXRlKGZlYXR1cmVzLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgZmVhdHVyZXMpOwogICAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5fX3N1cGVyX18gPSBrbGFzczsKICAgICAgcmV0dXJuIGZlYXR1cmVzLmNvbnN0cnVjdG9yOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG1peGluOiBmdW5jdGlvbiBtaXhpbigpIHsKICAgICAgdmFyIGtsYXNzID0gYXJndW1lbnRzWzBdOwogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIGpzaGludCBmb3JpbjpmYWxzZQogICAgICAgIGZvciAodmFyIHByb3AgaW4gYXJndW1lbnRzW2ldLnByb3RvdHlwZSkgewogICAgICAgICAgdmFyIGZuID0gYXJndW1lbnRzW2ldLnByb3RvdHlwZVtwcm9wXTsKICAgICAgICAgIGlmIChwcm9wICE9PSAnY29uc3RydWN0b3InKSB7CiAgICAgICAgICAgIGtsYXNzLnByb3RvdHlwZVtwcm9wXSA9IGZuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4ga2xhc3M7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGlkZVByb3BlcnRpZXM6IGZ1bmN0aW9uIGhpZGVQcm9wZXJ0aWVzKG9iaiwgcHJvcHMpIHsKICAgICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgIT09ICdmdW5jdGlvbicpIHJldHVybjsKICAKICAgICAgdXRpbC5hcnJheUVhY2gocHJvcHMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwcm9wZXJ0eTogZnVuY3Rpb24gcHJvcGVydHkob2JqLCBuYW1lLCB2YWx1ZSwgZW51bWVyYWJsZSwgaXNWYWx1ZSkgewogICAgICB2YXIgb3B0cyA9IHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSAhPT0gdW5kZWZpbmVkID8gZW51bWVyYWJsZSA6IHRydWUKICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNWYWx1ZSkgewogICAgICAgIG9wdHMuZ2V0ID0gdmFsdWU7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgb3B0cy52YWx1ZSA9IHZhbHVlOyBvcHRzLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgfQogIAogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBuYW1lLCBvcHRzKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBtZW1vaXplZFByb3BlcnR5OiBmdW5jdGlvbiBtZW1vaXplZFByb3BlcnR5KG9iaiwgbmFtZSwgZ2V0LCBlbnVtZXJhYmxlKSB7CiAgICAgIHZhciBjYWNoZWRWYWx1ZSA9IG51bGw7CiAgCiAgICAgIC8vIGJ1aWxkIGVudW1lcmFibGUgYXR0cmlidXRlIGZvciBlYWNoIHZhbHVlIHdpdGggbGF6eSBhY2Nlc3Nvci4KICAgICAgdXRpbC5wcm9wZXJ0eShvYmosIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChjYWNoZWRWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgY2FjaGVkVmFsdWUgPSBnZXQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlZFZhbHVlOwogICAgICB9LCBlbnVtZXJhYmxlKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFRPRE8gUmVtb3ZlIGluIG1ham9yIHZlcnNpb24gcmV2aXNpb24KICAgICAqIFRoaXMgYmFja2ZpbGwgcG9wdWxhdGVzIHJlc3BvbnNlIGRhdGEgd2l0aG91dCB0aGUKICAgICAqIHRvcC1sZXZlbCBwYXlsb2FkIG5hbWUuCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhvaXN0UGF5bG9hZE1lbWJlcjogZnVuY3Rpb24gaG9pc3RQYXlsb2FkTWVtYmVyKHJlc3ApIHsKICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbk5hbWUgPSByZXEub3BlcmF0aW9uOwogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uTmFtZV07CiAgICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogICAgICBpZiAob3V0cHV0LnBheWxvYWQgJiYgIW9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCkgewogICAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbb3V0cHV0LnBheWxvYWRdOwogICAgICAgIHZhciByZXNwb25zZVBheWxvYWQgPSByZXNwLmRhdGFbb3V0cHV0LnBheWxvYWRdOwogICAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgICB1dGlsLmVhY2gocmVzcG9uc2VQYXlsb2FkLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHV0aWwucHJvcGVydHkocmVzcC5kYXRhLCBrZXksIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENvbXB1dGUgU0hBLTI1NiBjaGVja3N1bXMgb2Ygc3RyZWFtcwogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb21wdXRlU2hhMjU2OiBmdW5jdGlvbiBjb21wdXRlU2hhMjU2KGJvZHksIGRvbmUpIHsKICAgICAgaWYgKHV0aWwuaXNOb2RlKCkpIHsKICAgICAgICB2YXIgU3RyZWFtID0gdXRpbC5zdHJlYW0uU3RyZWFtOwogICAgICAgIHZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgICAgICAgaWYgKHR5cGVvZiBTdHJlYW0gPT09ICdmdW5jdGlvbicgJiYgYm9keSBpbnN0YW5jZW9mIFN0cmVhbSkgewogICAgICAgICAgaWYgKHR5cGVvZiBib2R5LnBhdGggPT09ICdzdHJpbmcnKSB7IC8vIGFzc3VtZSBmaWxlIG9iamVjdAogICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSB7fTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBib2R5LnN0YXJ0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHNldHRpbmdzLnN0YXJ0ID0gYm9keS5zdGFydDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGJvZHkuZW5kID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHNldHRpbmdzLmVuZCA9IGJvZHkuZW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGJvZHkucGF0aCwgc2V0dGluZ3MpOwogICAgICAgICAgfSBlbHNlIHsgLy8gVE9ETyBzdXBwb3J0IG90aGVyIHN0cmVhbSB0eXBlcwogICAgICAgICAgICByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ05vbi1maWxlIHN0cmVhbSBvYmplY3RzIGFyZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdub3Qgc3VwcG9ydGVkIHdpdGggU2lnVjQnKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHV0aWwuY3J5cHRvLnNoYTI1Nihib2R5LCAnaGV4JywgZnVuY3Rpb24oZXJyLCBzaGEpIHsKICAgICAgICBpZiAoZXJyKSBkb25lKGVycik7CiAgICAgICAgZWxzZSBkb25lKG51bGwsIHNoYSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQoc2VydmVyVGltZSkgewogICAgICBpZiAoc2VydmVyVGltZSkgewogICAgICAgIHV0aWwucHJvcGVydHkoQVdTLmNvbmZpZywgJ2lzQ2xvY2tTa2V3ZWQnLAogICAgICAgICAgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSBzZXJ2ZXJUaW1lKSA+PSAzMDAwMDAsIGZhbHNlKTsKICAgICAgICByZXR1cm4gQVdTLmNvbmZpZy5pc0Nsb2NrU2tld2VkOwogICAgICB9CiAgICB9LAogIAogICAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChzZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChzZXJ2ZXJUaW1lKQogICAgICAgIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBzZXJ2ZXJUaW1lIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXh0cmFjdFJlcXVlc3RJZDogZnVuY3Rpb24gZXh0cmFjdFJlcXVlc3RJZChyZXNwKSB7CiAgICAgIHZhciByZXF1ZXN0SWQgPSByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ10gfHwKICAgICAgICAgICAgICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ107CiAgCiAgICAgIGlmICghcmVxdWVzdElkICYmIHJlc3AuZGF0YSAmJiByZXNwLmRhdGEuUmVzcG9uc2VNZXRhZGF0YSkgewogICAgICAgIHJlcXVlc3RJZCA9IHJlc3AuZGF0YS5SZXNwb25zZU1ldGFkYXRhLlJlcXVlc3RJZDsKICAgICAgfQogIAogICAgICBpZiAocmVxdWVzdElkKSB7CiAgICAgICAgcmVzcC5yZXF1ZXN0SWQgPSByZXF1ZXN0SWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICByZXNwLmVycm9yLnJlcXVlc3RJZCA9IHJlcXVlc3RJZDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZFByb21pc2VzOiBmdW5jdGlvbiBhZGRQcm9taXNlcyhjb25zdHJ1Y3RvcnMsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICAgIHZhciBkZWxldGVQcm9taXNlcyA9IGZhbHNlOwogICAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiBBV1MgJiYgQVdTLmNvbmZpZykgewogICAgICAgIFByb21pc2VEZXBlbmRlbmN5ID0gQVdTLmNvbmZpZy5nZXRQcm9taXNlc0RlcGVuZGVuY3koKTsKICAgICAgfQogICAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBQcm9taXNlRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBQcm9taXNlRGVwZW5kZW5jeSAhPT0gJ2Z1bmN0aW9uJykgZGVsZXRlUHJvbWlzZXMgPSB0cnVlOwogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY29uc3RydWN0b3JzKSkgY29uc3RydWN0b3JzID0gW2NvbnN0cnVjdG9yc107CiAgCiAgICAgIGZvciAodmFyIGluZCA9IDA7IGluZCA8IGNvbnN0cnVjdG9ycy5sZW5ndGg7IGluZCsrKSB7CiAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gY29uc3RydWN0b3JzW2luZF07CiAgICAgICAgaWYgKGRlbGV0ZVByb21pc2VzKSB7CiAgICAgICAgICBpZiAoY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MpIHsKICAgICAgICAgICAgY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNvbnN0cnVjdG9yLmFkZFByb21pc2VzVG9DbGFzcykgewogICAgICAgICAgY29uc3RydWN0b3IuYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogUmV0dXJuIGEgZnVuY3Rpb24gdGhhdCB3aWxsIHJldHVybiBhIHByb21pc2Ugd2hvc2UgZmF0ZSBpcyBkZWNpZGVkIGJ5IHRoZQogICAgICogY2FsbGJhY2sgYmVoYXZpb3Igb2YgdGhlIGdpdmVuIG1ldGhvZCB3aXRoIGBtZXRob2ROYW1lYC4gVGhlIG1ldGhvZCB0byBiZQogICAgICogcHJvbWlzaWZpZWQgc2hvdWxkIGNvbmZvcm0gdG8gbm9kZS5qcyBjb252ZW50aW9uIG9mIGFjY2VwdGluZyBhIGNhbGxiYWNrIGFzCiAgICAgKiBsYXN0IGFyZ3VtZW50IGFuZCBjYWxsaW5nIHRoYXQgY2FsbGJhY2sgd2l0aCBlcnJvciBhcyB0aGUgZmlyc3QgYXJndW1lbnQKICAgICAqIGFuZCBzdWNjZXNzIHZhbHVlIG9uIHRoZSBzZWNvbmQgYXJndW1lbnQuCiAgICAgKi8KICAgIHByb21pc2lmeU1ldGhvZDogZnVuY3Rpb24gcHJvbWlzaWZ5TWV0aG9kKG1ldGhvZE5hbWUsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBwcm9taXNlKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlRGVwZW5kZW5jeShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGFyZ3MucHVzaChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZlttZXRob2ROYW1lXS5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc0R1YWxzdGFja0F2YWlsYWJsZTogZnVuY3Rpb24gaXNEdWFsc3RhY2tBdmFpbGFibGUoc2VydmljZSkgewogICAgICBpZiAoIXNlcnZpY2UpIHJldHVybiBmYWxzZTsKICAgICAgdmFyIG1ldGFkYXRhID0gcmVxdWlyZSgnLi4vYXBpcy9tZXRhZGF0YS5qc29uJyk7CiAgICAgIGlmICh0eXBlb2Ygc2VydmljZSAhPT0gJ3N0cmluZycpIHNlcnZpY2UgPSBzZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyOwogICAgICBpZiAodHlwZW9mIHNlcnZpY2UgIT09ICdzdHJpbmcnIHx8ICFtZXRhZGF0YS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gISFtZXRhZGF0YVtzZXJ2aWNlXS5kdWFsc3RhY2tBdmFpbGFibGU7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FsY3VsYXRlUmV0cnlEZWxheTogZnVuY3Rpb24gY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCByZXRyeURlbGF5T3B0aW9ucykgewogICAgICBpZiAoIXJldHJ5RGVsYXlPcHRpb25zKSByZXRyeURlbGF5T3B0aW9ucyA9IHt9OwogICAgICB2YXIgY3VzdG9tQmFja29mZiA9IHJldHJ5RGVsYXlPcHRpb25zLmN1c3RvbUJhY2tvZmYgfHwgbnVsbDsKICAgICAgaWYgKHR5cGVvZiBjdXN0b21CYWNrb2ZmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGN1c3RvbUJhY2tvZmYocmV0cnlDb3VudCk7CiAgICAgIH0KICAgICAgdmFyIGJhc2UgPSB0eXBlb2YgcmV0cnlEZWxheU9wdGlvbnMuYmFzZSA9PT0gJ251bWJlcicgPyByZXRyeURlbGF5T3B0aW9ucy5iYXNlIDogMTAwOwogICAgICB2YXIgZGVsYXkgPSBNYXRoLnJhbmRvbSgpICogKE1hdGgucG93KDIsIHJldHJ5Q291bnQpICogYmFzZSk7CiAgICAgIHJldHVybiBkZWxheTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoYW5kbGVSZXF1ZXN0V2l0aFJldHJpZXM6IGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3RXaXRoUmV0cmllcyhodHRwUmVxdWVzdCwgb3B0aW9ucywgY2IpIHsKICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgdmFyIGh0dHBPcHRpb25zID0gb3B0aW9ucy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIHJldHJ5Q291bnQgPSAwOwogIAogICAgICB2YXIgZXJyQ2FsbGJhY2sgPSBmdW5jdGlvbihlcnIpIHsKICAgICAgICB2YXIgbWF4UmV0cmllcyA9IG9wdGlvbnMubWF4UmV0cmllcyB8fCAwOwogICAgICAgIGlmIChlcnIgJiYgZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InKSBlcnIucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICBpZiAoZXJyICYmIGVyci5yZXRyeWFibGUgJiYgcmV0cnlDb3VudCA8IG1heFJldHJpZXMpIHsKICAgICAgICAgIHJldHJ5Q291bnQrKzsKICAgICAgICAgIHZhciBkZWxheSA9IHV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCBvcHRpb25zLnJldHJ5RGVsYXlPcHRpb25zKTsKICAgICAgICAgIHNldFRpbWVvdXQoc2VuZFJlcXVlc3QsIGRlbGF5ICsgKGVyci5yZXRyeUFmdGVyIHx8IDApKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2IoZXJyKTsKICAgICAgICB9CiAgICAgIH07CiAgCiAgICAgIHZhciBzZW5kUmVxdWVzdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkYXRhID0gJyc7CiAgICAgICAgaHR0cC5oYW5kbGVSZXF1ZXN0KGh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywgZnVuY3Rpb24oaHR0cFJlc3BvbnNlKSB7CiAgICAgICAgICBodHRwUmVzcG9uc2Uub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgeyBkYXRhICs9IGNodW5rLnRvU3RyaW5nKCk7IH0pOwogICAgICAgICAgaHR0cFJlc3BvbnNlLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmV0cnlBZnRlciA9IHBhcnNlSW50KGh0dHBSZXNwb25zZS5oZWFkZXJzWydyZXRyeS1hZnRlciddLCAxMCkgKiAxMDAwIHx8IDA7CiAgICAgICAgICAgICAgdmFyIGVyciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgICAgICB7IHJldHJ5YWJsZTogc3RhdHVzQ29kZSA+PSA1MDAgfHwgc3RhdHVzQ29kZSA9PT0gNDI5IH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChyZXRyeUFmdGVyICYmIGVyci5yZXRyeWFibGUpIGVyci5yZXRyeUFmdGVyID0gcmV0cnlBZnRlcjsKICAgICAgICAgICAgICBlcnJDYWxsYmFjayhlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCBlcnJDYWxsYmFjayk7CiAgICAgIH07CiAgCiAgICAgIEFXUy51dGlsLmRlZmVyKHNlbmRSZXF1ZXN0KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB1dWlkOiB7CiAgICAgIHY0OiBmdW5jdGlvbiB1dWlkVjQoKSB7CiAgICAgICAgcmV0dXJuIHJlcXVpcmUoJ3V1aWQnKS52NCgpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29udmVydFBheWxvYWRUb1N0cmluZzogZnVuY3Rpb24gY29udmVydFBheWxvYWRUb1N0cmluZyhyZXNwKSB7CiAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEub3BlcmF0aW9uOwogICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgICAgaWYgKHJ1bGVzLnBheWxvYWQgJiYgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdKSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdLnRvU3RyaW5nKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZlcjogZnVuY3Rpb24gZGVmZXIoY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm9jZXNzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2FsbGJhY2spOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBzZXRJbW1lZGlhdGUoY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFRpbWVvdXQoY2FsbGJhY2ssIDApOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0UmVxdWVzdFBheWxvYWRTaGFwZTogZnVuY3Rpb24gZ2V0UmVxdWVzdFBheWxvYWRTaGFwZShyZXEpIHsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uczsKICAgICAgaWYgKCFvcGVyYXRpb25zKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICB2YXIgb3BlcmF0aW9uID0gKG9wZXJhdGlvbnMgfHwge30pW3JlcS5vcGVyYXRpb25dOwogICAgICBpZiAoIW9wZXJhdGlvbiB8fCAhb3BlcmF0aW9uLmlucHV0IHx8ICFvcGVyYXRpb24uaW5wdXQucGF5bG9hZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIG9wZXJhdGlvbi5pbnB1dC5tZW1iZXJzW29wZXJhdGlvbi5pbnB1dC5wYXlsb2FkXTsKICAgIH0sCiAgCiAgICBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWc6IGZ1bmN0aW9uIGdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZyhpbmlMb2FkZXIsIGZpbGVuYW1lKSB7CiAgICAgIHZhciBwcm9maWxlcyA9IHt9OwogICAgICB2YXIgcHJvZmlsZXNGcm9tQ29uZmlnID0ge307CiAgICAgIGlmIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSkgewogICAgICAgIHZhciBwcm9maWxlc0Zyb21Db25maWcgPSBpbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgICAgaXNDb25maWc6IHRydWUsCiAgICAgICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciBwcm9maWxlc0Zyb21DcmVkcyA9IGluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lIHx8CiAgICAgICAgICAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0gJiYgcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDcmVkZW50aWFsc0ZpbGVFbnZdKQogICAgICB9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNvbmZpZyk7IGkgPCBwcm9maWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dID0gcHJvZmlsZXNGcm9tQ29uZmlnW3Byb2ZpbGVOYW1lc1tpXV07CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNyZWRzKTsgaSA8IHByb2ZpbGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gPSBwcm9maWxlc0Zyb21DcmVkc1twcm9maWxlTmFtZXNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiBwcm9maWxlczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZhdWx0UHJvZmlsZTogJ2RlZmF1bHQnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uZmlnT3B0SW5FbnY6ICdBV1NfU0RLX0xPQURfQ09ORklHJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNoYXJlZENyZWRlbnRpYWxzRmlsZUVudjogJ0FXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRScsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzaGFyZWRDb25maWdGaWxlRW52OiAnQVdTX0NPTkZJR19GSUxFJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGltZHNEaXNhYmxlZEVudjogJ0FXU19FQzJfTUVUQURBVEFfRElTQUJMRUQnCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHV0aWw7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpLHJlcXVpcmUoInRpbWVycyIpLnNldEltbWVkaWF0ZSkKICB9LHsiLi4vYXBpcy9tZXRhZGF0YS5qc29uIjo0LCIuL2NvcmUiOjE4LCJfcHJvY2VzcyI6ODYsImZzIjo3OSwidGltZXJzIjo5MywidXVpZCI6OTh9XSw3MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi4vbW9kZWwvc2hhcGUnKTsKICAKICBmdW5jdGlvbiBEb21YbWxQYXJzZXIoKSB7IH0KICAKICBEb21YbWxQYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24oeG1sLCBzaGFwZSkgewogICAgaWYgKHhtbC5yZXBsYWNlKC9eXHMrLywgJycpID09PSAnJykgcmV0dXJuIHt9OwogIAogICAgdmFyIHJlc3VsdCwgZXJyb3I7CiAgICB0cnkgewogICAgICBpZiAod2luZG93LkRPTVBhcnNlcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgICAgcmVzdWx0ID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh4bWwsICd0ZXh0L3htbCcpOwogICAgICAgIH0gY2F0Y2ggKHN5bnRheEVycm9yKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3I6IHN5bnRheEVycm9yLAogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBpZiAocmVzdWx0LmRvY3VtZW50RWxlbWVudCA9PT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSBlbXB0eSBkb2N1bWVudC4nKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICB2YXIgaXNFcnJvciA9IHJlc3VsdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgncGFyc2VyZXJyb3InKVswXTsKICAgICAgICBpZiAoaXNFcnJvciAmJiAoaXNFcnJvci5wYXJlbnROb2RlID09PSByZXN1bHQgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLm5vZGVOYW1lID09PSAnYm9keScgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLnBhcmVudE5vZGUgPT09IHJlc3VsdCB8fAogICAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ2JvZHknKSkgewogICAgICAgICAgdmFyIGVycm9yRWxlbWVudCA9IGlzRXJyb3IuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2RpdicpWzBdIHx8IGlzRXJyb3I7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcihlcnJvckVsZW1lbnQudGV4dENvbnRlbnQgfHwgJ1BhcnNlciBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MRE9NJyk7CiAgICAgICAgcmVzdWx0LmFzeW5jID0gZmFsc2U7CiAgCiAgICAgICAgaWYgKCFyZXN1bHQubG9hZFhNTCh4bWwpKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkIFhNTCBwYXJzZXInKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnJvciA9IGU7CiAgICB9CiAgCiAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5kb2N1bWVudEVsZW1lbnQgJiYgIWVycm9yKSB7CiAgICAgIHZhciBkYXRhID0gcGFyc2VYbWwocmVzdWx0LmRvY3VtZW50RWxlbWVudCwgc2hhcGUpOwogICAgICB2YXIgbWV0YWRhdGEgPSBnZXRFbGVtZW50QnlUYWdOYW1lKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQsICdSZXNwb25zZU1ldGFkYXRhJyk7CiAgICAgIGlmIChtZXRhZGF0YSkgewogICAgICAgIGRhdGEuUmVzcG9uc2VNZXRhZGF0YSA9IHBhcnNlWG1sKG1ldGFkYXRhLCB7fSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9IGVsc2UgaWYgKGVycm9yKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIHtjb2RlOiAnWE1MUGFyc2VyRXJyb3InLCByZXRyeWFibGU6IHRydWV9KTsKICAgIH0gZWxzZSB7IC8vIGVtcHR5IHhtbCBkb2N1bWVudAogICAgICByZXR1cm4ge307CiAgICB9CiAgfTsKICAKICBmdW5jdGlvbiBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgdGFnKSB7CiAgICB2YXIgZWxlbWVudHMgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgIGlmIChlbGVtZW50c1tpXS5wYXJlbnROb2RlID09PSB4bWwpIHsKICAgICAgICByZXR1cm4gZWxlbWVudHNbaV07CiAgICAgIH0KICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VYbWwoeG1sLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSkgc2hhcGUgPSB7fTsKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiBwYXJzZU1hcCh4bWwsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiBwYXJzZUxpc3QoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgdW5kZWZpbmVkOiBjYXNlIG51bGw6IHJldHVybiBwYXJzZVVua25vd24oeG1sKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHBhcnNlU2NhbGFyKHhtbCwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgaWYgKHhtbCA9PT0gbnVsbCkgcmV0dXJuIGRhdGE7CiAgCiAgICB1dGlsLmVhY2goc2hhcGUubWVtYmVycywgZnVuY3Rpb24obWVtYmVyTmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgICAgaWYgKG1lbWJlclNoYXBlLmlzWG1sQXR0cmlidXRlKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh4bWwuYXR0cmlidXRlcywgbWVtYmVyU2hhcGUubmFtZSkpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHhtbC5hdHRyaWJ1dGVzW21lbWJlclNoYXBlLm5hbWVdLnZhbHVlOwogICAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IHBhcnNlWG1sKHt0ZXh0Q29udGVudDogdmFsdWV9LCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciB4bWxDaGlsZCA9IG1lbWJlclNoYXBlLmZsYXR0ZW5lZCA/IHhtbCA6CiAgICAgICAgICBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgbWVtYmVyU2hhcGUubmFtZSk7CiAgICAgICAgaWYgKHhtbENoaWxkKSB7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gcGFyc2VYbWwoeG1sQ2hpbGQsIG1lbWJlclNoYXBlKTsKICAgICAgICB9IGVsc2UgaWYgKCFtZW1iZXJTaGFwZS5mbGF0dGVuZWQgJiYgbWVtYmVyU2hhcGUudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gbWVtYmVyU2hhcGUuZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VNYXAoeG1sLCBzaGFwZSkgewogICAgdmFyIGRhdGEgPSB7fTsKICAgIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICAgIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKICAgIHZhciB0YWdOYW1lID0gc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeSc7CiAgCiAgICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgaWYgKGNoaWxkLm5vZGVOYW1lID09PSB0YWdOYW1lKSB7CiAgICAgICAgdmFyIGtleSA9IGdldEVsZW1lbnRCeVRhZ05hbWUoY2hpbGQsIHhtbEtleSkudGV4dENvbnRlbnQ7CiAgICAgICAgdmFyIHZhbHVlID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShjaGlsZCwgeG1sVmFsdWUpOwogICAgICAgIGRhdGFba2V5XSA9IHBhcnNlWG1sKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VMaXN0KHhtbCwgc2hhcGUpIHsKICAgIHZhciBkYXRhID0gW107CiAgICB2YXIgdGFnTmFtZSA9IHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAoc2hhcGUubWVtYmVyLm5hbWUgfHwgJ21lbWJlcicpOwogIAogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PT0gdGFnTmFtZSkgewogICAgICAgIGRhdGEucHVzaChwYXJzZVhtbChjaGlsZCwgc2hhcGUubWVtYmVyKSk7CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VTY2FsYXIoeG1sLCBzaGFwZSkgewogICAgaWYgKHhtbC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgdmFyIGVuY29kaW5nID0geG1sLmdldEF0dHJpYnV0ZSgnZW5jb2RpbmcnKTsKICAgICAgaWYgKGVuY29kaW5nID09PSAnYmFzZTY0JykgewogICAgICAgIHNoYXBlID0gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogZW5jb2Rpbmd9KTsKICAgICAgfQogICAgfQogIAogICAgdmFyIHRleHQgPSB4bWwudGV4dENvbnRlbnQ7CiAgICBpZiAodGV4dCA9PT0gJycpIHRleHQgPSBudWxsOwogICAgaWYgKHR5cGVvZiBzaGFwZS50b1R5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIHNoYXBlLnRvVHlwZSh0ZXh0KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZXh0OwogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVVua25vd24oeG1sKSB7CiAgICBpZiAoeG1sID09PSB1bmRlZmluZWQgfHwgeG1sID09PSBudWxsKSByZXR1cm4gJyc7CiAgCiAgICAvLyBlbXB0eSBvYmplY3QKICAgIGlmICgheG1sLmZpcnN0RWxlbWVudENoaWxkKSB7CiAgICAgIGlmICh4bWwucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSBudWxsKSByZXR1cm4ge307CiAgICAgIGlmICh4bWwuY2hpbGROb2Rlcy5sZW5ndGggPT09IDApIHJldHVybiAnJzsKICAgICAgZWxzZSByZXR1cm4geG1sLnRleHRDb250ZW50OwogICAgfQogIAogICAgLy8gb2JqZWN0LCBwYXJzZSBhcyBzdHJ1Y3R1cmUKICAgIHZhciBzaGFwZSA9IHt0eXBlOiAnc3RydWN0dXJlJywgbWVtYmVyczoge319OwogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIHZhciB0YWcgPSBjaGlsZC5ub2RlTmFtZTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFwZS5tZW1iZXJzLCB0YWcpKSB7CiAgICAgICAgLy8gbXVsdGlwbGUgdGFncyBvZiB0aGUgc2FtZSBuYW1lIG1ha2VzIGl0IGEgbGlzdAogICAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXS50eXBlID0gJ2xpc3QnOwogICAgICB9IGVsc2UgewogICAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXSA9IHtuYW1lOiB0YWd9OwogICAgICB9CiAgICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IERvbVhtbFBhcnNlcjsKICAKICB9LHsiLi4vbW9kZWwvc2hhcGUiOjQzLCIuLi91dGlsIjo3MX1dLDczOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgWG1sTm9kZSA9IHJlcXVpcmUoJy4veG1sLW5vZGUnKS5YbWxOb2RlOwogIHZhciBYbWxUZXh0ID0gcmVxdWlyZSgnLi94bWwtdGV4dCcpLlhtbFRleHQ7CiAgCiAgZnVuY3Rpb24gWG1sQnVpbGRlcigpIHsgfQogIAogIFhtbEJ1aWxkZXIucHJvdG90eXBlLnRvWE1MID0gZnVuY3Rpb24ocGFyYW1zLCBzaGFwZSwgcm9vdEVsZW1lbnQsIG5vRW1wdHkpIHsKICAgIHZhciB4bWwgPSBuZXcgWG1sTm9kZShyb290RWxlbWVudCk7CiAgICBhcHBseU5hbWVzcGFjZXMoeG1sLCBzaGFwZSwgdHJ1ZSk7CiAgICBzZXJpYWxpemUoeG1sLCBwYXJhbXMsIHNoYXBlKTsKICAgIHJldHVybiB4bWwuY2hpbGRyZW4ubGVuZ3RoID4gMCB8fCBub0VtcHR5ID8geG1sLnRvU3RyaW5nKCkgOiAnJzsKICB9OwogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBzaGFwZSkgewogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiBzZXJpYWxpemVTdHJ1Y3R1cmUoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdtYXAnOiByZXR1cm4gc2VyaWFsaXplTWFwKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiBzZXJpYWxpemVMaXN0KHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHNlcmlhbGl6ZVNjYWxhcih4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZVN0cnVjdHVyZSh4bWwsIHBhcmFtcywgc2hhcGUpIHsKICAgIHV0aWwuYXJyYXlFYWNoKHNoYXBlLm1lbWJlck5hbWVzLCBmdW5jdGlvbihtZW1iZXJOYW1lKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbWVtYmVyTmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgCiAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1ttZW1iZXJOYW1lXTsKICAgICAgdmFyIG5hbWUgPSBtZW1iZXJTaGFwZS5uYW1lOwogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgIGlmIChtZW1iZXJTaGFwZS5pc1htbEF0dHJpYnV0ZSkgewogICAgICAgICAgeG1sLmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmIChtZW1iZXJTaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgICAgIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgICAgYXBwbHlOYW1lc3BhY2VzKGVsZW1lbnQsIG1lbWJlclNoYXBlKTsKICAgICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1hcCh4bWwsIG1hcCwgc2hhcGUpIHsKICAgIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICAgIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKICAKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGVudHJ5ID0gbmV3IFhtbE5vZGUoc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeScpOwogICAgICB4bWwuYWRkQ2hpbGROb2RlKGVudHJ5KTsKICAKICAgICAgdmFyIGVudHJ5S2V5ID0gbmV3IFhtbE5vZGUoeG1sS2V5KTsKICAgICAgdmFyIGVudHJ5VmFsdWUgPSBuZXcgWG1sTm9kZSh4bWxWYWx1ZSk7CiAgICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeUtleSk7CiAgICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeVZhbHVlKTsKICAKICAgICAgc2VyaWFsaXplKGVudHJ5S2V5LCBrZXksIHNoYXBlLmtleSk7CiAgICAgIHNlcmlhbGl6ZShlbnRyeVZhbHVlLCB2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZUxpc3QoeG1sLCBsaXN0LCBzaGFwZSkgewogICAgaWYgKHNoYXBlLmZsYXR0ZW5lZCkgewogICAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBuYW1lID0gc2hhcGUubWVtYmVyLm5hbWUgfHwgc2hhcGUubmFtZTsKICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG5hbWUgPSBzaGFwZS5tZW1iZXIubmFtZSB8fCAnbWVtYmVyJzsKICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplU2NhbGFyKHhtbCwgdmFsdWUsIHNoYXBlKSB7CiAgICB4bWwuYWRkQ2hpbGROb2RlKAogICAgICBuZXcgWG1sVGV4dChzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpKQogICAgKTsKICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlOYW1lc3BhY2VzKHhtbCwgc2hhcGUsIGlzUm9vdCkgewogICAgdmFyIHVyaSwgcHJlZml4ID0gJ3htbG5zJzsKICAgIGlmIChzaGFwZS54bWxOYW1lc3BhY2VVcmkpIHsKICAgICAgdXJpID0gc2hhcGUueG1sTmFtZXNwYWNlVXJpOwogICAgICBpZiAoc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4KSBwcmVmaXggKz0gJzonICsgc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4OwogICAgfSBlbHNlIGlmIChpc1Jvb3QgJiYgc2hhcGUuYXBpLnhtbE5hbWVzcGFjZVVyaSkgewogICAgICB1cmkgPSBzaGFwZS5hcGkueG1sTmFtZXNwYWNlVXJpOwogICAgfQogIAogICAgaWYgKHVyaSkgeG1sLmFkZEF0dHJpYnV0ZShwcmVmaXgsIHVyaSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gWG1sQnVpbGRlcjsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4veG1sLW5vZGUiOjc2LCIuL3htbC10ZXh0Ijo3N31dLDc0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBFc2NhcGVzIGNoYXJhY3RlcnMgdGhhdCBjYW4gbm90IGJlIGluIGFuIFhNTCBhdHRyaWJ1dGUuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlQXR0cmlidXRlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLycvZywgJyZhcG9zOycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7JykucmVwbGFjZSgvIi9nLCAnJnF1b3Q7Jyk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBlc2NhcGVBdHRyaWJ1dGU6IGVzY2FwZUF0dHJpYnV0ZQogIH07CiAgCiAgfSx7fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIEVzY2FwZXMgY2hhcmFjdGVycyB0aGF0IGNhbiBub3QgYmUgaW4gYW4gWE1MIGVsZW1lbnQuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlRWxlbWVudCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC88L2csICcmbHQ7JykucmVwbGFjZSgvPi9nLCAnJmd0OycpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXNjYXBlRWxlbWVudDogZXNjYXBlRWxlbWVudAogIH07CiAgCiAgfSx7fV0sNzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBlc2NhcGVBdHRyaWJ1dGUgPSByZXF1aXJlKCcuL2VzY2FwZS1hdHRyaWJ1dGUnKS5lc2NhcGVBdHRyaWJ1dGU7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBhbiBYTUwgbm9kZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBYbWxOb2RlKG5hbWUsIGNoaWxkcmVuKSB7CiAgICAgIGlmIChjaGlsZHJlbiA9PT0gdm9pZCAwKSB7IGNoaWxkcmVuID0gW107IH0KICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICB9CiAgWG1sTm9kZS5wcm90b3R5cGUuYWRkQXR0cmlidXRlID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMuYXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLmFkZENoaWxkTm9kZSA9IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGRlbGV0ZSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgWG1sTm9kZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBoYXNDaGlsZHJlbiA9IEJvb2xlYW4odGhpcy5jaGlsZHJlbi5sZW5ndGgpOwogICAgICB2YXIgeG1sVGV4dCA9ICc8JyArIHRoaXMubmFtZTsKICAgICAgLy8gYWRkIGF0dHJpYnV0ZXMKICAgICAgdmFyIGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRyaWJ1dGVOYW1lcyA9IE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpOyBpIDwgYXR0cmlidXRlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZXNbaV07CiAgICAgICAgICB2YXIgYXR0cmlidXRlID0gYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlICE9PSAndW5kZWZpbmVkJyAmJiBhdHRyaWJ1dGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB4bWxUZXh0ICs9ICcgJyArIGF0dHJpYnV0ZU5hbWUgKyAnPVwiJyArIGVzY2FwZUF0dHJpYnV0ZSgnJyArIGF0dHJpYnV0ZSkgKyAnXCInOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB4bWxUZXh0ICs9ICFoYXNDaGlsZHJlbiA/ICcvPicgOiAnPicgKyB0aGlzLmNoaWxkcmVuLm1hcChmdW5jdGlvbiAoYykgeyByZXR1cm4gYy50b1N0cmluZygpOyB9KS5qb2luKCcnKSArICc8LycgKyB0aGlzLm5hbWUgKyAnPic7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgWG1sTm9kZTogWG1sTm9kZQogIH07CiAgCiAgfSx7Ii4vZXNjYXBlLWF0dHJpYnV0ZSI6NzR9XSw3NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGVzY2FwZUVsZW1lbnQgPSByZXF1aXJlKCcuL2VzY2FwZS1lbGVtZW50JykuZXNjYXBlRWxlbWVudDsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGFuIFhNTCB0ZXh0IHZhbHVlLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFhtbFRleHQodmFsdWUpIHsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH0KICAKICBYbWxUZXh0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGVzY2FwZUVsZW1lbnQoJycgKyB0aGlzLnZhbHVlKTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBYbWxUZXh0OiBYbWxUZXh0CiAgfTsKICAKICB9LHsiLi9lc2NhcGUtZWxlbWVudCI6NzV9XSw3ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgJ3VzZSBzdHJpY3QnCiAgCiAgZXhwb3J0cy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAogIGV4cG9ydHMudG9CeXRlQXJyYXkgPSB0b0J5dGVBcnJheQogIGV4cG9ydHMuZnJvbUJ5dGVBcnJheSA9IGZyb21CeXRlQXJyYXkKICAKICB2YXIgbG9va3VwID0gW10KICB2YXIgcmV2TG9va3VwID0gW10KICB2YXIgQXJyID0gdHlwZW9mIFVpbnQ4QXJyYXkgIT09ICd1bmRlZmluZWQnID8gVWludDhBcnJheSA6IEFycmF5CiAgCiAgdmFyIGNvZGUgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLycKICBmb3IgKHZhciBpID0gMCwgbGVuID0gY29kZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgbG9va3VwW2ldID0gY29kZVtpXQogICAgcmV2TG9va3VwW2NvZGUuY2hhckNvZGVBdChpKV0gPSBpCiAgfQogIAogIC8vIFN1cHBvcnQgZGVjb2RpbmcgVVJMLXNhZmUgYmFzZTY0IHN0cmluZ3MsIGFzIE5vZGUuanMgZG9lcy4KICAvLyBTZWU6IGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Jhc2U2NCNVUkxfYXBwbGljYXRpb25zCiAgcmV2TG9va3VwWyctJy5jaGFyQ29kZUF0KDApXSA9IDYyCiAgcmV2TG9va3VwWydfJy5jaGFyQ29kZUF0KDApXSA9IDYzCiAgCiAgZnVuY3Rpb24gZ2V0TGVucyAoYjY0KSB7CiAgICB2YXIgbGVuID0gYjY0Lmxlbmd0aAogIAogICAgaWYgKGxlbiAlIDQgPiAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzdHJpbmcuIExlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNCcpCiAgICB9CiAgCiAgICAvLyBUcmltIG9mZiBleHRyYSBieXRlcyBhZnRlciBwbGFjZWhvbGRlciBieXRlcyBhcmUgZm91bmQKICAgIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2JlYXRnYW1taXQvYmFzZTY0LWpzL2lzc3Vlcy80MgogICAgdmFyIHZhbGlkTGVuID0gYjY0LmluZGV4T2YoJz0nKQogICAgaWYgKHZhbGlkTGVuID09PSAtMSkgdmFsaWRMZW4gPSBsZW4KICAKICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSB2YWxpZExlbiA9PT0gbGVuCiAgICAgID8gMAogICAgICA6IDQgLSAodmFsaWRMZW4gJSA0KQogIAogICAgcmV0dXJuIFt2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuXQogIH0KICAKICAvLyBiYXNlNjQgaXMgNC8zICsgdXAgdG8gdHdvIGNoYXJhY3RlcnMgb2YgdGhlIG9yaWdpbmFsIGRhdGEKICBmdW5jdGlvbiBieXRlTGVuZ3RoIChiNjQpIHsKICAgIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpCiAgICB2YXIgdmFsaWRMZW4gPSBsZW5zWzBdCiAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXQogICAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCiAgfQogIAogIGZ1bmN0aW9uIF9ieXRlTGVuZ3RoIChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pIHsKICAgIHJldHVybiAoKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0KSAtIHBsYWNlSG9sZGVyc0xlbgogIH0KICAKICBmdW5jdGlvbiB0b0J5dGVBcnJheSAoYjY0KSB7CiAgICB2YXIgdG1wCiAgICB2YXIgbGVucyA9IGdldExlbnMoYjY0KQogICAgdmFyIHZhbGlkTGVuID0gbGVuc1swXQogICAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IGxlbnNbMV0KICAKICAgIHZhciBhcnIgPSBuZXcgQXJyKF9ieXRlTGVuZ3RoKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikpCiAgCiAgICB2YXIgY3VyQnl0ZSA9IDAKICAKICAgIC8vIGlmIHRoZXJlIGFyZSBwbGFjZWhvbGRlcnMsIG9ubHkgZ2V0IHVwIHRvIHRoZSBsYXN0IGNvbXBsZXRlIDQgY2hhcnMKICAgIHZhciBsZW4gPSBwbGFjZUhvbGRlcnNMZW4gPiAwCiAgICAgID8gdmFsaWRMZW4gLSA0CiAgICAgIDogdmFsaWRMZW4KICAKICAgIHZhciBpCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpICs9IDQpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxOCkgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCAxMikgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA8PCA2KSB8CiAgICAgICAgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAzKV0KICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDE2KSAmIDB4RkYKICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDIpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAyKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldID4+IDQpCiAgICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogICAgfQogIAogICAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMSkgewogICAgICB0bXAgPQogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDEwKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDQpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPj4gMikKICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBhcnIKICB9CiAgCiAgZnVuY3Rpb24gdHJpcGxldFRvQmFzZTY0IChudW0pIHsKICAgIHJldHVybiBsb29rdXBbbnVtID4+IDE4ICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtID4+IDEyICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtID4+IDYgJiAweDNGXSArCiAgICAgIGxvb2t1cFtudW0gJiAweDNGXQogIH0KICAKICBmdW5jdGlvbiBlbmNvZGVDaHVuayAodWludDgsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciB0bXAKICAgIHZhciBvdXRwdXQgPSBbXQogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpICs9IDMpIHsKICAgICAgdG1wID0KICAgICAgICAoKHVpbnQ4W2ldIDw8IDE2KSAmIDB4RkYwMDAwKSArCiAgICAgICAgKCh1aW50OFtpICsgMV0gPDwgOCkgJiAweEZGMDApICsKICAgICAgICAodWludDhbaSArIDJdICYgMHhGRikKICAgICAgb3V0cHV0LnB1c2godHJpcGxldFRvQmFzZTY0KHRtcCkpCiAgICB9CiAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpCiAgfQogIAogIGZ1bmN0aW9uIGZyb21CeXRlQXJyYXkgKHVpbnQ4KSB7CiAgICB2YXIgdG1wCiAgICB2YXIgbGVuID0gdWludDgubGVuZ3RoCiAgICB2YXIgZXh0cmFCeXRlcyA9IGxlbiAlIDMgLy8gaWYgd2UgaGF2ZSAxIGJ5dGUgbGVmdCwgcGFkIDIgYnl0ZXMKICAgIHZhciBwYXJ0cyA9IFtdCiAgICB2YXIgbWF4Q2h1bmtMZW5ndGggPSAxNjM4MyAvLyBtdXN0IGJlIG11bHRpcGxlIG9mIDMKICAKICAgIC8vIGdvIHRocm91Z2ggdGhlIGFycmF5IGV2ZXJ5IHRocmVlIGJ5dGVzLCB3ZSdsbCBkZWFsIHdpdGggdHJhaWxpbmcgc3R1ZmYgbGF0ZXIKICAgIGZvciAodmFyIGkgPSAwLCBsZW4yID0gbGVuIC0gZXh0cmFCeXRlczsgaSA8IGxlbjI7IGkgKz0gbWF4Q2h1bmtMZW5ndGgpIHsKICAgICAgcGFydHMucHVzaChlbmNvZGVDaHVuayh1aW50OCwgaSwgKGkgKyBtYXhDaHVua0xlbmd0aCkgPiBsZW4yID8gbGVuMiA6IChpICsgbWF4Q2h1bmtMZW5ndGgpKSkKICAgIH0KICAKICAgIC8vIHBhZCB0aGUgZW5kIHdpdGggemVyb3MsIGJ1dCBtYWtlIHN1cmUgdG8gbm90IGZvcmdldCB0aGUgZXh0cmEgYnl0ZXMKICAgIGlmIChleHRyYUJ5dGVzID09PSAxKSB7CiAgICAgIHRtcCA9IHVpbnQ4W2xlbiAtIDFdCiAgICAgIHBhcnRzLnB1c2goCiAgICAgICAgbG9va3VwW3RtcCA+PiAyXSArCiAgICAgICAgbG9va3VwWyh0bXAgPDwgNCkgJiAweDNGXSArCiAgICAgICAgJz09JwogICAgICApCiAgICB9IGVsc2UgaWYgKGV4dHJhQnl0ZXMgPT09IDIpIHsKICAgICAgdG1wID0gKHVpbnQ4W2xlbiAtIDJdIDw8IDgpICsgdWludDhbbGVuIC0gMV0KICAgICAgcGFydHMucHVzaCgKICAgICAgICBsb29rdXBbdG1wID4+IDEwXSArCiAgICAgICAgbG9va3VwWyh0bXAgPj4gNCkgJiAweDNGXSArCiAgICAgICAgbG9va3VwWyh0bXAgPDwgMikgJiAweDNGXSArCiAgICAgICAgJz0nCiAgICAgICkKICAgIH0KICAKICAgIHJldHVybiBwYXJ0cy5qb2luKCcnKQogIH0KICAKICB9LHt9XSw3OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgCiAgfSx7fV0sODA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoZ2xvYmFsKXsoZnVuY3Rpb24gKCl7CiAgLyohIGh0dHBzOi8vbXRocy5iZS9wdW55Y29kZSB2MS4zLjIgYnkgQG1hdGhpYXMgKi8KICA7KGZ1bmN0aW9uKHJvb3QpIHsKICAKICAgIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZXMgKi8KICAgIHZhciBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnICYmIGV4cG9ydHMgJiYKICAgICAgIWV4cG9ydHMubm9kZVR5cGUgJiYgZXhwb3J0czsKICAgIHZhciBmcmVlTW9kdWxlID0gdHlwZW9mIG1vZHVsZSA9PSAnb2JqZWN0JyAmJiBtb2R1bGUgJiYKICAgICAgIW1vZHVsZS5ub2RlVHlwZSAmJiBtb2R1bGU7CiAgICB2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsOwogICAgaWYgKAogICAgICBmcmVlR2xvYmFsLmdsb2JhbCA9PT0gZnJlZUdsb2JhbCB8fAogICAgICBmcmVlR2xvYmFsLndpbmRvdyA9PT0gZnJlZUdsb2JhbCB8fAogICAgICBmcmVlR2xvYmFsLnNlbGYgPT09IGZyZWVHbG9iYWwKICAgICkgewogICAgICByb290ID0gZnJlZUdsb2JhbDsKICAgIH0KICAKICAgIC8qKgogICAgICogVGhlIGBwdW55Y29kZWAgb2JqZWN0LgogICAgICogQG5hbWUgcHVueWNvZGUKICAgICAqIEB0eXBlIE9iamVjdAogICAgICovCiAgICB2YXIgcHVueWNvZGUsCiAgCiAgICAvKiogSGlnaGVzdCBwb3NpdGl2ZSBzaWduZWQgMzItYml0IGZsb2F0IHZhbHVlICovCiAgICBtYXhJbnQgPSAyMTQ3NDgzNjQ3LCAvLyBha2EuIDB4N0ZGRkZGRkYgb3IgMl4zMS0xCiAgCiAgICAvKiogQm9vdHN0cmluZyBwYXJhbWV0ZXJzICovCiAgICBiYXNlID0gMzYsCiAgICB0TWluID0gMSwKICAgIHRNYXggPSAyNiwKICAgIHNrZXcgPSAzOCwKICAgIGRhbXAgPSA3MDAsCiAgICBpbml0aWFsQmlhcyA9IDcyLAogICAgaW5pdGlhbE4gPSAxMjgsIC8vIDB4ODAKICAgIGRlbGltaXRlciA9ICctJywgLy8gJ1x4MkQnCiAgCiAgICAvKiogUmVndWxhciBleHByZXNzaW9ucyAqLwogICAgcmVnZXhQdW55Y29kZSA9IC9eeG4tLS8sCiAgICByZWdleE5vbkFTQ0lJID0gL1teXHgyMC1ceDdFXS8sIC8vIHVucHJpbnRhYmxlIEFTQ0lJIGNoYXJzICsgbm9uLUFTQ0lJIGNoYXJzCiAgICByZWdleFNlcGFyYXRvcnMgPSAvW1x4MkVcdTMwMDJcdUZGMEVcdUZGNjFdL2csIC8vIFJGQyAzNDkwIHNlcGFyYXRvcnMKICAKICAgIC8qKiBFcnJvciBtZXNzYWdlcyAqLwogICAgZXJyb3JzID0gewogICAgICAnb3ZlcmZsb3cnOiAnT3ZlcmZsb3c6IGlucHV0IG5lZWRzIHdpZGVyIGludGVnZXJzIHRvIHByb2Nlc3MnLAogICAgICAnbm90LWJhc2ljJzogJ0lsbGVnYWwgaW5wdXQgPj0gMHg4MCAobm90IGEgYmFzaWMgY29kZSBwb2ludCknLAogICAgICAnaW52YWxpZC1pbnB1dCc6ICdJbnZhbGlkIGlucHV0JwogICAgfSwKICAKICAgIC8qKiBDb252ZW5pZW5jZSBzaG9ydGN1dHMgKi8KICAgIGJhc2VNaW51c1RNaW4gPSBiYXNlIC0gdE1pbiwKICAgIGZsb29yID0gTWF0aC5mbG9vciwKICAgIHN0cmluZ0Zyb21DaGFyQ29kZSA9IFN0cmluZy5mcm9tQ2hhckNvZGUsCiAgCiAgICAvKiogVGVtcG9yYXJ5IHZhcmlhYmxlICovCiAgICBrZXk7CiAgCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAKICAgIC8qKgogICAgICogQSBnZW5lcmljIGVycm9yIHV0aWxpdHkgZnVuY3Rpb24uCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIGVycm9yIHR5cGUuCiAgICAgKiBAcmV0dXJucyB7RXJyb3J9IFRocm93cyBhIGBSYW5nZUVycm9yYCB3aXRoIHRoZSBhcHBsaWNhYmxlIGVycm9yIG1lc3NhZ2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVycm9yKHR5cGUpIHsKICAgICAgdGhyb3cgUmFuZ2VFcnJvcihlcnJvcnNbdHlwZV0pOwogICAgfQogIAogICAgLyoqCiAgICAgKiBBIGdlbmVyaWMgYEFycmF5I21hcGAgdXRpbGl0eSBmdW5jdGlvbi4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgZm9yIGV2ZXJ5IGFycmF5CiAgICAgKiBpdGVtLgogICAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBhcnJheSBvZiB2YWx1ZXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBtYXAoYXJyYXksIGZuKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBmbihhcnJheVtsZW5ndGhdKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgLyoqCiAgICAgKiBBIHNpbXBsZSBgQXJyYXkjbWFwYC1saWtlIHdyYXBwZXIgdG8gd29yayB3aXRoIGRvbWFpbiBuYW1lIHN0cmluZ3Mgb3IgZW1haWwKICAgICAqIGFkZHJlc3Nlcy4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZG9tYWluIFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgZm9yIGV2ZXJ5CiAgICAgKiBjaGFyYWN0ZXIuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN0cmluZyBvZiBjaGFyYWN0ZXJzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjawogICAgICogZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcERvbWFpbihzdHJpbmcsIGZuKSB7CiAgICAgIHZhciBwYXJ0cyA9IHN0cmluZy5zcGxpdCgnQCcpOwogICAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgLy8gSW4gZW1haWwgYWRkcmVzc2VzLCBvbmx5IHRoZSBkb21haW4gbmFtZSBzaG91bGQgYmUgcHVueWNvZGVkLiBMZWF2ZQogICAgICAgIC8vIHRoZSBsb2NhbCBwYXJ0IChpLmUuIGV2ZXJ5dGhpbmcgdXAgdG8gYEBgKSBpbnRhY3QuCiAgICAgICAgcmVzdWx0ID0gcGFydHNbMF0gKyAnQCc7CiAgICAgICAgc3RyaW5nID0gcGFydHNbMV07CiAgICAgIH0KICAgICAgLy8gQXZvaWQgYHNwbGl0KHJlZ2V4KWAgZm9yIElFOCBjb21wYXRpYmlsaXR5LiBTZWUgIzE3LgogICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShyZWdleFNlcGFyYXRvcnMsICdceDJFJyk7CiAgICAgIHZhciBsYWJlbHMgPSBzdHJpbmcuc3BsaXQoJy4nKTsKICAgICAgdmFyIGVuY29kZWQgPSBtYXAobGFiZWxzLCBmbikuam9pbignLicpOwogICAgICByZXR1cm4gcmVzdWx0ICsgZW5jb2RlZDsKICAgIH0KICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjb250YWluaW5nIHRoZSBudW1lcmljIGNvZGUgcG9pbnRzIG9mIGVhY2ggVW5pY29kZQogICAgICogY2hhcmFjdGVyIGluIHRoZSBzdHJpbmcuIFdoaWxlIEphdmFTY3JpcHQgdXNlcyBVQ1MtMiBpbnRlcm5hbGx5LAogICAgICogdGhpcyBmdW5jdGlvbiB3aWxsIGNvbnZlcnQgYSBwYWlyIG9mIHN1cnJvZ2F0ZSBoYWx2ZXMgKGVhY2ggb2Ygd2hpY2gKICAgICAqIFVDUy0yIGV4cG9zZXMgYXMgc2VwYXJhdGUgY2hhcmFjdGVycykgaW50byBhIHNpbmdsZSBjb2RlIHBvaW50LAogICAgICogbWF0Y2hpbmcgVVRGLTE2LgogICAgICogQHNlZSBgcHVueWNvZGUudWNzMi5lbmNvZGVgCiAgICAgKiBAc2VlIDxodHRwczovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZz4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZS51Y3MyCiAgICAgKiBAbmFtZSBkZWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIFVuaWNvZGUgaW5wdXQgc3RyaW5nIChVQ1MtMikuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFRoZSBuZXcgYXJyYXkgb2YgY29kZSBwb2ludHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVjczJkZWNvZGUoc3RyaW5nKSB7CiAgICAgIHZhciBvdXRwdXQgPSBbXSwKICAgICAgICAgIGNvdW50ZXIgPSAwLAogICAgICAgICAgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgZXh0cmE7CiAgICAgIHdoaWxlIChjb3VudGVyIDwgbGVuZ3RoKSB7CiAgICAgICAgdmFsdWUgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgIGlmICh2YWx1ZSA+PSAweEQ4MDAgJiYgdmFsdWUgPD0gMHhEQkZGICYmIGNvdW50ZXIgPCBsZW5ndGgpIHsKICAgICAgICAgIC8vIGhpZ2ggc3Vycm9nYXRlLCBhbmQgdGhlcmUgaXMgYSBuZXh0IGNoYXJhY3RlcgogICAgICAgICAgZXh0cmEgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgICAgaWYgKChleHRyYSAmIDB4RkMwMCkgPT0gMHhEQzAwKSB7IC8vIGxvdyBzdXJyb2dhdGUKICAgICAgICAgICAgb3V0cHV0LnB1c2goKCh2YWx1ZSAmIDB4M0ZGKSA8PCAxMCkgKyAoZXh0cmEgJiAweDNGRikgKyAweDEwMDAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHVubWF0Y2hlZCBzdXJyb2dhdGU7IG9ubHkgYXBwZW5kIHRoaXMgY29kZSB1bml0LCBpbiBjYXNlIHRoZSBuZXh0CiAgICAgICAgICAgIC8vIGNvZGUgdW5pdCBpcyB0aGUgaGlnaCBzdXJyb2dhdGUgb2YgYSBzdXJyb2dhdGUgcGFpcgogICAgICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIGNvdW50ZXItLTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0OwogICAgfQogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc3RyaW5nIGJhc2VkIG9uIGFuIGFycmF5IG9mIG51bWVyaWMgY29kZSBwb2ludHMuCiAgICAgKiBAc2VlIGBwdW55Y29kZS51Y3MyLmRlY29kZWAKICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZS51Y3MyCiAgICAgKiBAbmFtZSBlbmNvZGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGNvZGVQb2ludHMgVGhlIGFycmF5IG9mIG51bWVyaWMgY29kZSBwb2ludHMuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgbmV3IFVuaWNvZGUgc3RyaW5nIChVQ1MtMikuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVjczJlbmNvZGUoYXJyYXkpIHsKICAgICAgcmV0dXJuIG1hcChhcnJheSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgb3V0cHV0ID0gJyc7CiAgICAgICAgaWYgKHZhbHVlID4gMHhGRkZGKSB7CiAgICAgICAgICB2YWx1ZSAtPSAweDEwMDAwOwogICAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCk7CiAgICAgICAgICB2YWx1ZSA9IDB4REMwMCB8IHZhbHVlICYgMHgzRkY7CiAgICAgICAgfQogICAgICAgIG91dHB1dCArPSBzdHJpbmdGcm9tQ2hhckNvZGUodmFsdWUpOwogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgIH0pLmpvaW4oJycpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIGJhc2ljIGNvZGUgcG9pbnQgaW50byBhIGRpZ2l0L2ludGVnZXIuCiAgICAgKiBAc2VlIGBkaWdpdFRvQmFzaWMoKWAKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gY29kZVBvaW50IFRoZSBiYXNpYyBudW1lcmljIGNvZGUgcG9pbnQgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQgKGZvciB1c2UgaW4KICAgICAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaW4gdGhlIHJhbmdlIGAwYCB0byBgYmFzZSAtIDFgLCBvciBgYmFzZWAgaWYKICAgICAqIHRoZSBjb2RlIHBvaW50IGRvZXMgbm90IHJlcHJlc2VudCBhIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNpY1RvRGlnaXQoY29kZVBvaW50KSB7CiAgICAgIGlmIChjb2RlUG9pbnQgLSA0OCA8IDEwKSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDIyOwogICAgICB9CiAgICAgIGlmIChjb2RlUG9pbnQgLSA2NSA8IDI2KSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDY1OwogICAgICB9CiAgICAgIGlmIChjb2RlUG9pbnQgLSA5NyA8IDI2KSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDk3OwogICAgICB9CiAgICAgIHJldHVybiBiYXNlOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIGRpZ2l0L2ludGVnZXIgaW50byBhIGJhc2ljIGNvZGUgcG9pbnQuCiAgICAgKiBAc2VlIGBiYXNpY1RvRGlnaXQoKWAKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gZGlnaXQgVGhlIG51bWVyaWMgdmFsdWUgb2YgYSBiYXNpYyBjb2RlIHBvaW50LgogICAgICogQHJldHVybnMge051bWJlcn0gVGhlIGJhc2ljIGNvZGUgcG9pbnQgd2hvc2UgdmFsdWUgKHdoZW4gdXNlZCBmb3IKICAgICAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaXMgYGRpZ2l0YCwgd2hpY2ggbmVlZHMgdG8gYmUgaW4gdGhlIHJhbmdlCiAgICAgKiBgMGAgdG8gYGJhc2UgLSAxYC4gSWYgYGZsYWdgIGlzIG5vbi16ZXJvLCB0aGUgdXBwZXJjYXNlIGZvcm0gaXMKICAgICAqIHVzZWQ7IGVsc2UsIHRoZSBsb3dlcmNhc2UgZm9ybSBpcyB1c2VkLiBUaGUgYmVoYXZpb3IgaXMgdW5kZWZpbmVkCiAgICAgKiBpZiBgZmxhZ2AgaXMgbm9uLXplcm8gYW5kIGBkaWdpdGAgaGFzIG5vIHVwcGVyY2FzZSBmb3JtLgogICAgICovCiAgICBmdW5jdGlvbiBkaWdpdFRvQmFzaWMoZGlnaXQsIGZsYWcpIHsKICAgICAgLy8gIDAuLjI1IG1hcCB0byBBU0NJSSBhLi56IG9yIEEuLloKICAgICAgLy8gMjYuLjM1IG1hcCB0byBBU0NJSSAwLi45CiAgICAgIHJldHVybiBkaWdpdCArIDIyICsgNzUgKiAoZGlnaXQgPCAyNikgLSAoKGZsYWcgIT0gMCkgPDwgNSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIEJpYXMgYWRhcHRhdGlvbiBmdW5jdGlvbiBhcyBwZXIgc2VjdGlvbiAzLjQgb2YgUkZDIDM0OTIuCiAgICAgKiBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzNDkyI3NlY3Rpb24tMy40CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBmdW5jdGlvbiBhZGFwdChkZWx0YSwgbnVtUG9pbnRzLCBmaXJzdFRpbWUpIHsKICAgICAgdmFyIGsgPSAwOwogICAgICBkZWx0YSA9IGZpcnN0VGltZSA/IGZsb29yKGRlbHRhIC8gZGFtcCkgOiBkZWx0YSA+PiAxOwogICAgICBkZWx0YSArPSBmbG9vcihkZWx0YSAvIG51bVBvaW50cyk7CiAgICAgIGZvciAoLyogbm8gaW5pdGlhbGl6YXRpb24gKi87IGRlbHRhID4gYmFzZU1pbnVzVE1pbiAqIHRNYXggPj4gMTsgayArPSBiYXNlKSB7CiAgICAgICAgZGVsdGEgPSBmbG9vcihkZWx0YSAvIGJhc2VNaW51c1RNaW4pOwogICAgICB9CiAgICAgIHJldHVybiBmbG9vcihrICsgKGJhc2VNaW51c1RNaW4gKyAxKSAqIGRlbHRhIC8gKGRlbHRhICsgc2tldykpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMgdG8gYSBzdHJpbmcgb2YgVW5pY29kZQogICAgICogc3ltYm9scy4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgogICAgICovCiAgICBmdW5jdGlvbiBkZWNvZGUoaW5wdXQpIHsKICAgICAgLy8gRG9uJ3QgdXNlIFVDUy0yCiAgICAgIHZhciBvdXRwdXQgPSBbXSwKICAgICAgICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAogICAgICAgICAgb3V0LAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICBuID0gaW5pdGlhbE4sCiAgICAgICAgICBiaWFzID0gaW5pdGlhbEJpYXMsCiAgICAgICAgICBiYXNpYywKICAgICAgICAgIGosCiAgICAgICAgICBpbmRleCwKICAgICAgICAgIG9sZGksCiAgICAgICAgICB3LAogICAgICAgICAgaywKICAgICAgICAgIGRpZ2l0LAogICAgICAgICAgdCwKICAgICAgICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwogICAgICAgICAgYmFzZU1pbnVzVDsKICAKICAgICAgLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50czogbGV0IGBiYXNpY2AgYmUgdGhlIG51bWJlciBvZiBpbnB1dCBjb2RlCiAgICAgIC8vIHBvaW50cyBiZWZvcmUgdGhlIGxhc3QgZGVsaW1pdGVyLCBvciBgMGAgaWYgdGhlcmUgaXMgbm9uZSwgdGhlbiBjb3B5CiAgICAgIC8vIHRoZSBmaXJzdCBiYXNpYyBjb2RlIHBvaW50cyB0byB0aGUgb3V0cHV0LgogIAogICAgICBiYXNpYyA9IGlucHV0Lmxhc3RJbmRleE9mKGRlbGltaXRlcik7CiAgICAgIGlmIChiYXNpYyA8IDApIHsKICAgICAgICBiYXNpYyA9IDA7CiAgICAgIH0KICAKICAgICAgZm9yIChqID0gMDsgaiA8IGJhc2ljOyArK2opIHsKICAgICAgICAvLyBpZiBpdCdzIG5vdCBhIGJhc2ljIGNvZGUgcG9pbnQKICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChqKSA+PSAweDgwKSB7CiAgICAgICAgICBlcnJvcignbm90LWJhc2ljJyk7CiAgICAgICAgfQogICAgICAgIG91dHB1dC5wdXNoKGlucHV0LmNoYXJDb2RlQXQoaikpOwogICAgICB9CiAgCiAgICAgIC8vIE1haW4gZGVjb2RpbmcgbG9vcDogc3RhcnQganVzdCBhZnRlciB0aGUgbGFzdCBkZWxpbWl0ZXIgaWYgYW55IGJhc2ljIGNvZGUKICAgICAgLy8gcG9pbnRzIHdlcmUgY29waWVkOyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nIG90aGVyd2lzZS4KICAKICAgICAgZm9yIChpbmRleCA9IGJhc2ljID4gMCA/IGJhc2ljICsgMSA6IDA7IGluZGV4IDwgaW5wdXRMZW5ndGg7IC8qIG5vIGZpbmFsIGV4cHJlc3Npb24gKi8pIHsKICAKICAgICAgICAvLyBgaW5kZXhgIGlzIHRoZSBpbmRleCBvZiB0aGUgbmV4dCBjaGFyYWN0ZXIgdG8gYmUgY29uc3VtZWQuCiAgICAgICAgLy8gRGVjb2RlIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIgaW50byBgZGVsdGFgLAogICAgICAgIC8vIHdoaWNoIGdldHMgYWRkZWQgdG8gYGlgLiBUaGUgb3ZlcmZsb3cgY2hlY2tpbmcgaXMgZWFzaWVyCiAgICAgICAgLy8gaWYgd2UgaW5jcmVhc2UgYGlgIGFzIHdlIGdvLCB0aGVuIHN1YnRyYWN0IG9mZiBpdHMgc3RhcnRpbmcKICAgICAgICAvLyB2YWx1ZSBhdCB0aGUgZW5kIHRvIG9idGFpbiBgZGVsdGFgLgogICAgICAgIGZvciAob2xkaSA9IGksIHcgPSAxLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKICAKICAgICAgICAgIGlmIChpbmRleCA+PSBpbnB1dExlbmd0aCkgewogICAgICAgICAgICBlcnJvcignaW52YWxpZC1pbnB1dCcpOwogICAgICAgICAgfQogIAogICAgICAgICAgZGlnaXQgPSBiYXNpY1RvRGlnaXQoaW5wdXQuY2hhckNvZGVBdChpbmRleCsrKSk7CiAgCiAgICAgICAgICBpZiAoZGlnaXQgPj0gYmFzZSB8fCBkaWdpdCA+IGZsb29yKChtYXhJbnQgLSBpKSAvIHcpKSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgaSArPSBkaWdpdCAqIHc7CiAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKICAKICAgICAgICAgIGlmIChkaWdpdCA8IHQpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBiYXNlTWludXNUID0gYmFzZSAtIHQ7CiAgICAgICAgICBpZiAodyA+IGZsb29yKG1heEludCAvIGJhc2VNaW51c1QpKSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgdyAqPSBiYXNlTWludXNUOwogIAogICAgICAgIH0KICAKICAgICAgICBvdXQgPSBvdXRwdXQubGVuZ3RoICsgMTsKICAgICAgICBiaWFzID0gYWRhcHQoaSAtIG9sZGksIG91dCwgb2xkaSA9PSAwKTsKICAKICAgICAgICAvLyBgaWAgd2FzIHN1cHBvc2VkIHRvIHdyYXAgYXJvdW5kIGZyb20gYG91dGAgdG8gYDBgLAogICAgICAgIC8vIGluY3JlbWVudGluZyBgbmAgZWFjaCB0aW1lLCBzbyB3ZSdsbCBmaXggdGhhdCBub3c6CiAgICAgICAgaWYgKGZsb29yKGkgLyBvdXQpID4gbWF4SW50IC0gbikgewogICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgfQogIAogICAgICAgIG4gKz0gZmxvb3IoaSAvIG91dCk7CiAgICAgICAgaSAlPSBvdXQ7CiAgCiAgICAgICAgLy8gSW5zZXJ0IGBuYCBhdCBwb3NpdGlvbiBgaWAgb2YgdGhlIG91dHB1dAogICAgICAgIG91dHB1dC5zcGxpY2UoaSsrLCAwLCBuKTsKICAKICAgICAgfQogIAogICAgICByZXR1cm4gdWNzMmVuY29kZShvdXRwdXQpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMgKGUuZy4gYSBkb21haW4gbmFtZSBsYWJlbCkgdG8gYQogICAgICogUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGUoaW5wdXQpIHsKICAgICAgdmFyIG4sCiAgICAgICAgICBkZWx0YSwKICAgICAgICAgIGhhbmRsZWRDUENvdW50LAogICAgICAgICAgYmFzaWNMZW5ndGgsCiAgICAgICAgICBiaWFzLAogICAgICAgICAgaiwKICAgICAgICAgIG0sCiAgICAgICAgICBxLAogICAgICAgICAgaywKICAgICAgICAgIHQsCiAgICAgICAgICBjdXJyZW50VmFsdWUsCiAgICAgICAgICBvdXRwdXQgPSBbXSwKICAgICAgICAgIC8qKiBgaW5wdXRMZW5ndGhgIHdpbGwgaG9sZCB0aGUgbnVtYmVyIG9mIGNvZGUgcG9pbnRzIGluIGBpbnB1dGAuICovCiAgICAgICAgICBpbnB1dExlbmd0aCwKICAgICAgICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwogICAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lLAogICAgICAgICAgYmFzZU1pbnVzVCwKICAgICAgICAgIHFNaW51c1Q7CiAgCiAgICAgIC8vIENvbnZlcnQgdGhlIGlucHV0IGluIFVDUy0yIHRvIFVuaWNvZGUKICAgICAgaW5wdXQgPSB1Y3MyZGVjb2RlKGlucHV0KTsKICAKICAgICAgLy8gQ2FjaGUgdGhlIGxlbmd0aAogICAgICBpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aDsKICAKICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgc3RhdGUKICAgICAgbiA9IGluaXRpYWxOOwogICAgICBkZWx0YSA9IDA7CiAgICAgIGJpYXMgPSBpbml0aWFsQmlhczsKICAKICAgICAgLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50cwogICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCAweDgwKSB7CiAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoY3VycmVudFZhbHVlKSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGhhbmRsZWRDUENvdW50ID0gYmFzaWNMZW5ndGggPSBvdXRwdXQubGVuZ3RoOwogIAogICAgICAvLyBgaGFuZGxlZENQQ291bnRgIGlzIHRoZSBudW1iZXIgb2YgY29kZSBwb2ludHMgdGhhdCBoYXZlIGJlZW4gaGFuZGxlZDsKICAgICAgLy8gYGJhc2ljTGVuZ3RoYCBpcyB0aGUgbnVtYmVyIG9mIGJhc2ljIGNvZGUgcG9pbnRzLgogIAogICAgICAvLyBGaW5pc2ggdGhlIGJhc2ljIHN0cmluZyAtIGlmIGl0IGlzIG5vdCBlbXB0eSAtIHdpdGggYSBkZWxpbWl0ZXIKICAgICAgaWYgKGJhc2ljTGVuZ3RoKSB7CiAgICAgICAgb3V0cHV0LnB1c2goZGVsaW1pdGVyKTsKICAgICAgfQogIAogICAgICAvLyBNYWluIGVuY29kaW5nIGxvb3A6CiAgICAgIHdoaWxlIChoYW5kbGVkQ1BDb3VudCA8IGlucHV0TGVuZ3RoKSB7CiAgCiAgICAgICAgLy8gQWxsIG5vbi1iYXNpYyBjb2RlIHBvaW50cyA8IG4gaGF2ZSBiZWVuIGhhbmRsZWQgYWxyZWFkeS4gRmluZCB0aGUgbmV4dAogICAgICAgIC8vIGxhcmdlciBvbmU6CiAgICAgICAgZm9yIChtID0gbWF4SW50LCBqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA+PSBuICYmIGN1cnJlbnRWYWx1ZSA8IG0pIHsKICAgICAgICAgICAgbSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgLy8gSW5jcmVhc2UgYGRlbHRhYCBlbm91Z2ggdG8gYWR2YW5jZSB0aGUgZGVjb2RlcidzIDxuLGk+IHN0YXRlIHRvIDxtLDA+LAogICAgICAgIC8vIGJ1dCBndWFyZCBhZ2FpbnN0IG92ZXJmbG93CiAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lID0gaGFuZGxlZENQQ291bnQgKyAxOwogICAgICAgIGlmIChtIC0gbiA+IGZsb29yKChtYXhJbnQgLSBkZWx0YSkgLyBoYW5kbGVkQ1BDb3VudFBsdXNPbmUpKSB7CiAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICB9CiAgCiAgICAgICAgZGVsdGEgKz0gKG0gLSBuKSAqIGhhbmRsZWRDUENvdW50UGx1c09uZTsKICAgICAgICBuID0gbTsKICAKICAgICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgCiAgICAgICAgICBpZiAoY3VycmVudFZhbHVlIDwgbiAmJiArK2RlbHRhID4gbWF4SW50KSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PSBuKSB7CiAgICAgICAgICAgIC8vIFJlcHJlc2VudCBkZWx0YSBhcyBhIGdlbmVyYWxpemVkIHZhcmlhYmxlLWxlbmd0aCBpbnRlZ2VyCiAgICAgICAgICAgIGZvciAocSA9IGRlbHRhLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKICAgICAgICAgICAgICBpZiAocSA8IHQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxTWludXNUID0gcSAtIHQ7CiAgICAgICAgICAgICAgYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwogICAgICAgICAgICAgIG91dHB1dC5wdXNoKAogICAgICAgICAgICAgICAgc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyh0ICsgcU1pbnVzVCAlIGJhc2VNaW51c1QsIDApKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcSA9IGZsb29yKHFNaW51c1QgLyBiYXNlTWludXNUKTsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHEsIDApKSk7CiAgICAgICAgICAgIGJpYXMgPSBhZGFwdChkZWx0YSwgaGFuZGxlZENQQ291bnRQbHVzT25lLCBoYW5kbGVkQ1BDb3VudCA9PSBiYXNpY0xlbmd0aCk7CiAgICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgICAgKytoYW5kbGVkQ1BDb3VudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgKytkZWx0YTsKICAgICAgICArK247CiAgCiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBQdW55Y29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcwogICAgICogdG8gVW5pY29kZS4gT25seSB0aGUgUHVueWNvZGVkIHBhcnRzIG9mIHRoZSBpbnB1dCB3aWxsIGJlIGNvbnZlcnRlZCwgaS5lLgogICAgICogaXQgZG9lc24ndCBtYXR0ZXIgaWYgeW91IGNhbGwgaXQgb24gYSBzdHJpbmcgdGhhdCBoYXMgYWxyZWFkeSBiZWVuCiAgICAgKiBjb252ZXJ0ZWQgdG8gVW5pY29kZS4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZWQgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcyB0bwogICAgICogY29udmVydCB0byBVbmljb2RlLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIFVuaWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIFB1bnljb2RlCiAgICAgKiBzdHJpbmcuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvVW5pY29kZShpbnB1dCkgewogICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICByZXR1cm4gcmVnZXhQdW55Y29kZS50ZXN0KHN0cmluZykKICAgICAgICAgID8gZGVjb2RlKHN0cmluZy5zbGljZSg0KS50b0xvd2VyQ2FzZSgpKQogICAgICAgICAgOiBzdHJpbmc7CiAgICAgIH0pOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFVuaWNvZGUgc3RyaW5nIHJlcHJlc2VudGluZyBhIGRvbWFpbiBuYW1lIG9yIGFuIGVtYWlsIGFkZHJlc3MgdG8KICAgICAqIFB1bnljb2RlLiBPbmx5IHRoZSBub24tQVNDSUkgcGFydHMgb2YgdGhlIGRvbWFpbiBuYW1lIHdpbGwgYmUgY29udmVydGVkLAogICAgICogaS5lLiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQncyBhbHJlYWR5IGluCiAgICAgKiBBU0NJSS4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvIGNvbnZlcnQsIGFzIGEKICAgICAqIFVuaWNvZGUgc3RyaW5nLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIFB1bnljb2RlIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBkb21haW4gbmFtZSBvcgogICAgICogZW1haWwgYWRkcmVzcy4KICAgICAqLwogICAgZnVuY3Rpb24gdG9BU0NJSShpbnB1dCkgewogICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICByZXR1cm4gcmVnZXhOb25BU0NJSS50ZXN0KHN0cmluZykKICAgICAgICAgID8gJ3huLS0nICsgZW5jb2RlKHN0cmluZykKICAgICAgICAgIDogc3RyaW5nOwogICAgICB9KTsKICAgIH0KICAKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIAogICAgLyoqIERlZmluZSB0aGUgcHVibGljIEFQSSAqLwogICAgcHVueWNvZGUgPSB7CiAgICAgIC8qKgogICAgICAgKiBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgUHVueWNvZGUuanMgdmVyc2lvbiBudW1iZXIuCiAgICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgICd2ZXJzaW9uJzogJzEuMy4yJywKICAgICAgLyoqCiAgICAgICAqIEFuIG9iamVjdCBvZiBtZXRob2RzIHRvIGNvbnZlcnQgZnJvbSBKYXZhU2NyaXB0J3MgaW50ZXJuYWwgY2hhcmFjdGVyCiAgICAgICAqIHJlcHJlc2VudGF0aW9uIChVQ1MtMikgdG8gVW5pY29kZSBjb2RlIHBvaW50cywgYW5kIGJhY2suCiAgICAgICAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgogICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICAndWNzMic6IHsKICAgICAgICAnZGVjb2RlJzogdWNzMmRlY29kZSwKICAgICAgICAnZW5jb2RlJzogdWNzMmVuY29kZQogICAgICB9LAogICAgICAnZGVjb2RlJzogZGVjb2RlLAogICAgICAnZW5jb2RlJzogZW5jb2RlLAogICAgICAndG9BU0NJSSc6IHRvQVNDSUksCiAgICAgICd0b1VuaWNvZGUnOiB0b1VuaWNvZGUKICAgIH07CiAgCiAgICAvKiogRXhwb3NlIGBwdW55Y29kZWAgKi8KICAgIC8vIFNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucwogICAgLy8gbGlrZSB0aGUgZm9sbG93aW5nOgogICAgaWYgKAogICAgICB0cnVlCiAgICApIHsKICAgICAgIShfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyA9IChmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gcHVueWNvZGU7CiAgICAgIH0pLmNhbGwoZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXywgZXhwb3J0cywgbW9kdWxlKSwKCQlfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyAhPT0gdW5kZWZpbmVkICYmIChtb2R1bGUuZXhwb3J0cyA9IF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fKSk7CiAgICB9IGVsc2Uge30KICAKICB9KHRoaXMpKTsKICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHR5cGVvZiBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgIT09ICJ1bmRlZmluZWQiID8gX193ZWJwYWNrX3JlcXVpcmVfXy5nIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCiAgfSx7fV0sODE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoZ2xvYmFsLEJ1ZmZlcil7KGZ1bmN0aW9uICgpewogIC8qIQogICAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogICAqCiAgICogQGF1dGhvciAgIEZlcm9zcyBBYm91a2hhZGlqZWggPGZlcm9zc0BmZXJvc3Mub3JnPiA8aHR0cDovL2Zlcm9zcy5vcmc+CiAgICogQGxpY2Vuc2UgIE1JVAogICAqLwogIC8qIGVzbGludC1kaXNhYmxlIG5vLXByb3RvICovCiAgCiAgJ3VzZSBzdHJpY3QnCiAgCiAgdmFyIGJhc2U2NCA9IHJlcXVpcmUoJ2Jhc2U2NC1qcycpCiAgdmFyIGllZWU3NTQgPSByZXF1aXJlKCdpZWVlNzU0JykKICB2YXIgaXNBcnJheSA9IHJlcXVpcmUoJ2lzYXJyYXknKQogIAogIGV4cG9ydHMuQnVmZmVyID0gQnVmZmVyCiAgZXhwb3J0cy5TbG93QnVmZmVyID0gU2xvd0J1ZmZlcgogIGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMgPSA1MAogIAogIC8qKgogICAqIElmIGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGA6CiAgICogICA9PT0gdHJ1ZSAgICBVc2UgVWludDhBcnJheSBpbXBsZW1lbnRhdGlvbiAoZmFzdGVzdCkKICAgKiAgID09PSBmYWxzZSAgIFVzZSBPYmplY3QgaW1wbGVtZW50YXRpb24gKG1vc3QgY29tcGF0aWJsZSwgZXZlbiBJRTYpCiAgICoKICAgKiBCcm93c2VycyB0aGF0IHN1cHBvcnQgdHlwZWQgYXJyYXlzIGFyZSBJRSAxMCssIEZpcmVmb3ggNCssIENocm9tZSA3KywgU2FmYXJpIDUuMSssCiAgICogT3BlcmEgMTEuNissIGlPUyA0LjIrLgogICAqCiAgICogRHVlIHRvIHZhcmlvdXMgYnJvd3NlciBidWdzLCBzb21ldGltZXMgdGhlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiB3aWxsIGJlIHVzZWQgZXZlbgogICAqIHdoZW4gdGhlIGJyb3dzZXIgc3VwcG9ydHMgdHlwZWQgYXJyYXlzLgogICAqCiAgICogTm90ZToKICAgKgogICAqICAgLSBGaXJlZm94IDQtMjkgbGFja3Mgc3VwcG9ydCBmb3IgYWRkaW5nIG5ldyBwcm9wZXJ0aWVzIHRvIGBVaW50OEFycmF5YCBpbnN0YW5jZXMsCiAgICogICAgIFNlZTogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njk1NDM4LgogICAqCiAgICogICAtIENocm9tZSA5LTEwIGlzIG1pc3NpbmcgdGhlIGBUeXBlZEFycmF5LnByb3RvdHlwZS5zdWJhcnJheWAgZnVuY3Rpb24uCiAgICoKICAgKiAgIC0gSUUxMCBoYXMgYSBicm9rZW4gYFR5cGVkQXJyYXkucHJvdG90eXBlLnN1YmFycmF5YCBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFycmF5cyBvZgogICAqICAgICBpbmNvcnJlY3QgbGVuZ3RoIGluIHNvbWUgc2l0dWF0aW9ucy4KICAKICAgKiBXZSBkZXRlY3QgdGhlc2UgYnVnZ3kgYnJvd3NlcnMgYW5kIHNldCBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgIHRvIGBmYWxzZWAgc28gdGhleQogICAqIGdldCB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uLCB3aGljaCBpcyBzbG93ZXIgYnV0IGJlaGF2ZXMgY29ycmVjdGx5LgogICAqLwogIEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUID0gZ2xvYmFsLlRZUEVEX0FSUkFZX1NVUFBPUlQgIT09IHVuZGVmaW5lZAogICAgPyBnbG9iYWwuVFlQRURfQVJSQVlfU1VQUE9SVAogICAgOiB0eXBlZEFycmF5U3VwcG9ydCgpCiAgCiAgLyoKICAgKiBFeHBvcnQga01heExlbmd0aCBhZnRlciB0eXBlZCBhcnJheSBzdXBwb3J0IGlzIGRldGVybWluZWQuCiAgICovCiAgZXhwb3J0cy5rTWF4TGVuZ3RoID0ga01heExlbmd0aCgpCiAgCiAgZnVuY3Rpb24gdHlwZWRBcnJheVN1cHBvcnQgKCkgewogICAgdHJ5IHsKICAgICAgdmFyIGFyciA9IG5ldyBVaW50OEFycmF5KDEpCiAgICAgIGFyci5fX3Byb3RvX18gPSB7X19wcm90b19fOiBVaW50OEFycmF5LnByb3RvdHlwZSwgZm9vOiBmdW5jdGlvbiAoKSB7IHJldHVybiA0MiB9fQogICAgICByZXR1cm4gYXJyLmZvbygpID09PSA0MiAmJiAvLyB0eXBlZCBhcnJheSBpbnN0YW5jZXMgY2FuIGJlIGF1Z21lbnRlZAogICAgICAgICAgdHlwZW9mIGFyci5zdWJhcnJheSA9PT0gJ2Z1bmN0aW9uJyAmJiAvLyBjaHJvbWUgOS0xMCBsYWNrIGBzdWJhcnJheWAKICAgICAgICAgIGFyci5zdWJhcnJheSgxLCAxKS5ieXRlTGVuZ3RoID09PSAwIC8vIGllMTAgaGFzIGJyb2tlbiBgc3ViYXJyYXlgCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KICAKICBmdW5jdGlvbiBrTWF4TGVuZ3RoICgpIHsKICAgIHJldHVybiBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVAogICAgICA/IDB4N2ZmZmZmZmYKICAgICAgOiAweDNmZmZmZmZmCiAgfQogIAogIGZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlciAodGhhdCwgbGVuZ3RoKSB7CiAgICBpZiAoa01heExlbmd0aCgpIDwgbGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIHR5cGVkIGFycmF5IGxlbmd0aCcpCiAgICB9CiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UsIGZvciBiZXN0IHBlcmZvcm1hbmNlCiAgICAgIHRoYXQgPSBuZXcgVWludDhBcnJheShsZW5ndGgpCiAgICAgIHRoYXQuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgfSBlbHNlIHsKICAgICAgLy8gRmFsbGJhY2s6IFJldHVybiBhbiBvYmplY3QgaW5zdGFuY2Ugb2YgdGhlIEJ1ZmZlciBjbGFzcwogICAgICBpZiAodGhhdCA9PT0gbnVsbCkgewogICAgICAgIHRoYXQgPSBuZXcgQnVmZmVyKGxlbmd0aCkKICAgICAgfQogICAgICB0aGF0Lmxlbmd0aCA9IGxlbmd0aAogICAgfQogIAogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgLyoqCiAgICogVGhlIEJ1ZmZlciBjb25zdHJ1Y3RvciByZXR1cm5zIGluc3RhbmNlcyBvZiBgVWludDhBcnJheWAgdGhhdCBoYXZlIHRoZWlyCiAgICogcHJvdG90eXBlIGNoYW5nZWQgdG8gYEJ1ZmZlci5wcm90b3R5cGVgLiBGdXJ0aGVybW9yZSwgYEJ1ZmZlcmAgaXMgYSBzdWJjbGFzcyBvZgogICAqIGBVaW50OEFycmF5YCwgc28gdGhlIHJldHVybmVkIGluc3RhbmNlcyB3aWxsIGhhdmUgYWxsIHRoZSBub2RlIGBCdWZmZXJgIG1ldGhvZHMKICAgKiBhbmQgdGhlIGBVaW50OEFycmF5YCBtZXRob2RzLiBTcXVhcmUgYnJhY2tldCBub3RhdGlvbiB3b3JrcyBhcyBleHBlY3RlZCAtLSBpdAogICAqIHJldHVybnMgYSBzaW5nbGUgb2N0ZXQuCiAgICoKICAgKiBUaGUgYFVpbnQ4QXJyYXlgIHByb3RvdHlwZSByZW1haW5zIHVubW9kaWZpZWQuCiAgICovCiAgCiAgZnVuY3Rpb24gQnVmZmVyIChhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJiAhKHRoaXMgaW5zdGFuY2VvZiBCdWZmZXIpKSB7CiAgICAgIHJldHVybiBuZXcgQnVmZmVyKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgLy8gQ29tbW9uIGNhc2UuCiAgICBpZiAodHlwZW9mIGFyZyA9PT0gJ251bWJlcicpIHsKICAgICAgaWYgKHR5cGVvZiBlbmNvZGluZ09yT2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICdJZiBlbmNvZGluZyBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycKICAgICAgICApCiAgICAgIH0KICAgICAgcmV0dXJuIGFsbG9jVW5zYWZlKHRoaXMsIGFyZykKICAgIH0KICAgIHJldHVybiBmcm9tKHRoaXMsIGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBCdWZmZXIucG9vbFNpemUgPSA4MTkyIC8vIG5vdCB1c2VkIGJ5IHRoaXMgaW1wbGVtZW50YXRpb24KICAKICAvLyBUT0RPOiBMZWdhY3ksIG5vdCBuZWVkZWQgYW55bW9yZS4gUmVtb3ZlIGluIG5leHQgbWFqb3IgdmVyc2lvbi4KICBCdWZmZXIuX2F1Z21lbnQgPSBmdW5jdGlvbiAoYXJyKSB7CiAgICBhcnIuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgcmV0dXJuIGFycgogIH0KICAKICBmdW5jdGlvbiBmcm9tICh0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIGEgbnVtYmVyJykKICAgIH0KICAKICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgICAgcmV0dXJuIGZyb21BcnJheUJ1ZmZlcih0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIGZyb21TdHJpbmcodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQpCiAgICB9CiAgCiAgICByZXR1cm4gZnJvbU9iamVjdCh0aGF0LCB2YWx1ZSkKICB9CiAgCiAgLyoqCiAgICogRnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG8gQnVmZmVyKGFyZywgZW5jb2RpbmcpIGJ1dCB0aHJvd3MgYSBUeXBlRXJyb3IKICAgKiBpZiB2YWx1ZSBpcyBhIG51bWJlci4KICAgKiBCdWZmZXIuZnJvbShzdHJbLCBlbmNvZGluZ10pCiAgICogQnVmZmVyLmZyb20oYXJyYXkpCiAgICogQnVmZmVyLmZyb20oYnVmZmVyKQogICAqIEJ1ZmZlci5mcm9tKGFycmF5QnVmZmVyWywgYnl0ZU9mZnNldFssIGxlbmd0aF1dKQogICAqKi8KICBCdWZmZXIuZnJvbSA9IGZ1bmN0aW9uICh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gZnJvbShudWxsLCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIEJ1ZmZlci5wcm90b3R5cGUuX19wcm90b19fID0gVWludDhBcnJheS5wcm90b3R5cGUKICAgIEJ1ZmZlci5fX3Byb3RvX18gPSBVaW50OEFycmF5CiAgICBpZiAodHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcgJiYgU3ltYm9sLnNwZWNpZXMgJiYKICAgICAgICBCdWZmZXJbU3ltYm9sLnNwZWNpZXNdID09PSBCdWZmZXIpIHsKICAgICAgLy8gRml4IHN1YmFycmF5KCkgaW4gRVMyMDE2LiBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyL3B1bGwvOTcKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEJ1ZmZlciwgU3ltYm9sLnNwZWNpZXMsIHsKICAgICAgICB2YWx1ZTogbnVsbCwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSkKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYXNzZXJ0U2l6ZSAoc2l6ZSkgewogICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpCiAgICB9IGVsc2UgaWYgKHNpemUgPCAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgbmVnYXRpdmUnKQogICAgfQogIH0KICAKICBmdW5jdGlvbiBhbGxvYyAodGhhdCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgIGFzc2VydFNpemUoc2l6ZSkKICAgIGlmIChzaXplIDw9IDApIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKQogICAgfQogICAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBPbmx5IHBheSBhdHRlbnRpb24gdG8gZW5jb2RpbmcgaWYgaXQncyBhIHN0cmluZy4gVGhpcwogICAgICAvLyBwcmV2ZW50cyBhY2NpZGVudGFsbHkgc2VuZGluZyBpbiBhIG51bWJlciB0aGF0IHdvdWxkCiAgICAgIC8vIGJlIGludGVycHJldHRlZCBhcyBhIHN0YXJ0IG9mZnNldC4KICAgICAgcmV0dXJuIHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycKICAgICAgICA/IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKS5maWxsKGZpbGwsIGVuY29kaW5nKQogICAgICAgIDogY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpLmZpbGwoZmlsbCkKICAgIH0KICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkKICB9CiAgCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmaWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqIGFsbG9jKHNpemVbLCBmaWxsWywgZW5jb2RpbmddXSkKICAgKiovCiAgQnVmZmVyLmFsbG9jID0gZnVuY3Rpb24gKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYWxsb2MobnVsbCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpCiAgfQogIAogIGZ1bmN0aW9uIGFsbG9jVW5zYWZlICh0aGF0LCBzaXplKSB7CiAgICBhc3NlcnRTaXplKHNpemUpCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUgPCAwID8gMCA6IGNoZWNrZWQoc2l6ZSkgfCAwKQogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpemU7ICsraSkgewogICAgICAgIHRoYXRbaV0gPSAwCiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIC8qKgogICAqIEVxdWl2YWxlbnQgdG8gQnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAgICogKi8KICBCdWZmZXIuYWxsb2NVbnNhZmUgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCiAgfQogIC8qKgogICAqIEVxdWl2YWxlbnQgdG8gU2xvd0J1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqLwogIEJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCiAgfQogIAogIGZ1bmN0aW9uIGZyb21TdHJpbmcgKHRoYXQsIHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgIT09ICdzdHJpbmcnIHx8IGVuY29kaW5nID09PSAnJykgewogICAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgfQogIAogICAgaWYgKCFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImVuY29kaW5nIiBtdXN0IGJlIGEgdmFsaWQgc3RyaW5nIGVuY29kaW5nJykKICAgIH0KICAKICAgIHZhciBsZW5ndGggPSBieXRlTGVuZ3RoKHN0cmluZywgZW5jb2RpbmcpIHwgMAogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW5ndGgpCiAgCiAgICB2YXIgYWN0dWFsID0gdGhhdC53cml0ZShzdHJpbmcsIGVuY29kaW5nKQogIAogICAgaWYgKGFjdHVhbCAhPT0gbGVuZ3RoKSB7CiAgICAgIC8vIFdyaXRpbmcgYSBoZXggc3RyaW5nLCBmb3IgZXhhbXBsZSwgdGhhdCBjb250YWlucyBpbnZhbGlkIGNoYXJhY3RlcnMgd2lsbAogICAgICAvLyBjYXVzZSBldmVyeXRoaW5nIGFmdGVyIHRoZSBmaXJzdCBpbnZhbGlkIGNoYXJhY3RlciB0byBiZSBpZ25vcmVkLiAoZS5nLgogICAgICAvLyAnYWJ4eGNkJyB3aWxsIGJlIHRyZWF0ZWQgYXMgJ2FiJykKICAgICAgdGhhdCA9IHRoYXQuc2xpY2UoMCwgYWN0dWFsKQogICAgfQogIAogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbUFycmF5TGlrZSAodGhhdCwgYXJyYXkpIHsKICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGggPCAwID8gMCA6IGNoZWNrZWQoYXJyYXkubGVuZ3RoKSB8IDAKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuZ3RoKQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICB0aGF0W2ldID0gYXJyYXlbaV0gJiAyNTUKICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIGZ1bmN0aW9uIGZyb21BcnJheUJ1ZmZlciAodGhhdCwgYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkgewogICAgYXJyYXkuYnl0ZUxlbmd0aCAvLyB0aGlzIHRocm93cyBpZiBgYXJyYXlgIGlzIG5vdCBhIHZhbGlkIEFycmF5QnVmZmVyCiAgCiAgICBpZiAoYnl0ZU9mZnNldCA8IDAgfHwgYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1wnb2Zmc2V0XCcgaXMgb3V0IG9mIGJvdW5kcycpCiAgICB9CiAgCiAgICBpZiAoYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQgKyAobGVuZ3RoIHx8IDApKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdcJ2xlbmd0aFwnIGlzIG91dCBvZiBib3VuZHMnKQogICAgfQogIAogICAgaWYgKGJ5dGVPZmZzZXQgPT09IHVuZGVmaW5lZCAmJiBsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5KQogICAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5LCBieXRlT2Zmc2V0KQogICAgfSBlbHNlIHsKICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlLCBmb3IgYmVzdCBwZXJmb3JtYW5jZQogICAgICB0aGF0ID0gYXJyYXkKICAgICAgdGhhdC5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICB9IGVsc2UgewogICAgICAvLyBGYWxsYmFjazogUmV0dXJuIGFuIG9iamVjdCBpbnN0YW5jZSBvZiB0aGUgQnVmZmVyIGNsYXNzCiAgICAgIHRoYXQgPSBmcm9tQXJyYXlMaWtlKHRoYXQsIGFycmF5KQogICAgfQogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbU9iamVjdCAodGhhdCwgb2JqKSB7CiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKG9iaikpIHsKICAgICAgdmFyIGxlbiA9IGNoZWNrZWQob2JqLmxlbmd0aCkgfCAwCiAgICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuKQogIAogICAgICBpZiAodGhhdC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdGhhdAogICAgICB9CiAgCiAgICAgIG9iai5jb3B5KHRoYXQsIDAsIDAsIGxlbikKICAgICAgcmV0dXJuIHRoYXQKICAgIH0KICAKICAgIGlmIChvYmopIHsKICAgICAgaWYgKCh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICAgICAgICBvYmouYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHx8ICdsZW5ndGgnIGluIG9iaikgewogICAgICAgIGlmICh0eXBlb2Ygb2JqLmxlbmd0aCAhPT0gJ251bWJlcicgfHwgaXNuYW4ob2JqLmxlbmd0aCkpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgMCkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyb21BcnJheUxpa2UodGhhdCwgb2JqKQogICAgICB9CiAgCiAgICAgIGlmIChvYmoudHlwZSA9PT0gJ0J1ZmZlcicgJiYgaXNBcnJheShvYmouZGF0YSkpIHsKICAgICAgICByZXR1cm4gZnJvbUFycmF5TGlrZSh0aGF0LCBvYmouZGF0YSkKICAgICAgfQogICAgfQogIAogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZywgQnVmZmVyLCBBcnJheUJ1ZmZlciwgQXJyYXksIG9yIGFycmF5LWxpa2Ugb2JqZWN0LicpCiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrZWQgKGxlbmd0aCkgewogICAgLy8gTm90ZTogY2Fubm90IHVzZSBgbGVuZ3RoIDwga01heExlbmd0aCgpYCBoZXJlIGJlY2F1c2UgdGhhdCBmYWlscyB3aGVuCiAgICAvLyBsZW5ndGggaXMgTmFOICh3aGljaCBpcyBvdGhlcndpc2UgY29lcmNlZCB0byB6ZXJvLikKICAgIGlmIChsZW5ndGggPj0ga01heExlbmd0aCgpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnc2l6ZTogMHgnICsga01heExlbmd0aCgpLnRvU3RyaW5nKDE2KSArICcgYnl0ZXMnKQogICAgfQogICAgcmV0dXJuIGxlbmd0aCB8IDAKICB9CiAgCiAgZnVuY3Rpb24gU2xvd0J1ZmZlciAobGVuZ3RoKSB7CiAgICBpZiAoK2xlbmd0aCAhPSBsZW5ndGgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBlcWVxZXEKICAgICAgbGVuZ3RoID0gMAogICAgfQogICAgcmV0dXJuIEJ1ZmZlci5hbGxvYygrbGVuZ3RoKQogIH0KICAKICBCdWZmZXIuaXNCdWZmZXIgPSBmdW5jdGlvbiBpc0J1ZmZlciAoYikgewogICAgcmV0dXJuICEhKGIgIT0gbnVsbCAmJiBiLl9pc0J1ZmZlcikKICB9CiAgCiAgQnVmZmVyLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlIChhLCBiKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihhKSB8fCAhQnVmZmVyLmlzQnVmZmVyKGIpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50cyBtdXN0IGJlIEJ1ZmZlcnMnKQogICAgfQogIAogICAgaWYgKGEgPT09IGIpIHJldHVybiAwCiAgCiAgICB2YXIgeCA9IGEubGVuZ3RoCiAgICB2YXIgeSA9IGIubGVuZ3RoCiAgCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gTWF0aC5taW4oeCwgeSk7IGkgPCBsZW47ICsraSkgewogICAgICBpZiAoYVtpXSAhPT0gYltpXSkgewogICAgICAgIHggPSBhW2ldCiAgICAgICAgeSA9IGJbaV0KICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgCiAgICBpZiAoeCA8IHkpIHJldHVybiAtMQogICAgaWYgKHkgPCB4KSByZXR1cm4gMQogICAgcmV0dXJuIDAKICB9CiAgCiAgQnVmZmVyLmlzRW5jb2RpbmcgPSBmdW5jdGlvbiBpc0VuY29kaW5nIChlbmNvZGluZykgewogICAgc3dpdGNoIChTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaGV4JzoKICAgICAgY2FzZSAndXRmOCc6CiAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgY2FzZSAnYXNjaWknOgogICAgICBjYXNlICdsYXRpbjEnOgogICAgICBjYXNlICdiaW5hcnknOgogICAgICBjYXNlICdiYXNlNjQnOgogICAgICBjYXNlICd1Y3MyJzoKICAgICAgY2FzZSAndWNzLTInOgogICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgIHJldHVybiB0cnVlCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQogIAogIEJ1ZmZlci5jb25jYXQgPSBmdW5jdGlvbiBjb25jYXQgKGxpc3QsIGxlbmd0aCkgewogICAgaWYgKCFpc0FycmF5KGxpc3QpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKQogICAgfQogIAogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBCdWZmZXIuYWxsb2MoMCkKICAgIH0KICAKICAgIHZhciBpCiAgICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgICAgbGVuZ3RoID0gMAogICAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgICAgIGxlbmd0aCArPSBsaXN0W2ldLmxlbmd0aAogICAgICB9CiAgICB9CiAgCiAgICB2YXIgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCkKICAgIHZhciBwb3MgPSAwCiAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgICB2YXIgYnVmID0gbGlzdFtpXQogICAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihidWYpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCiAgICAgIH0KICAgICAgYnVmLmNvcHkoYnVmZmVyLCBwb3MpCiAgICAgIHBvcyArPSBidWYubGVuZ3RoCiAgICB9CiAgICByZXR1cm4gYnVmZmVyCiAgfQogIAogIGZ1bmN0aW9uIGJ5dGVMZW5ndGggKHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIoc3RyaW5nKSkgewogICAgICByZXR1cm4gc3RyaW5nLmxlbmd0aAogICAgfQogICAgaWYgKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgIChBcnJheUJ1ZmZlci5pc1ZpZXcoc3RyaW5nKSB8fCBzdHJpbmcgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikpIHsKICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoCiAgICB9CiAgICBpZiAodHlwZW9mIHN0cmluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgc3RyaW5nID0gJycgKyBzdHJpbmcKICAgIH0KICAKICAgIHZhciBsZW4gPSBzdHJpbmcubGVuZ3RoCiAgICBpZiAobGVuID09PSAwKSByZXR1cm4gMAogIAogICAgLy8gVXNlIGEgZm9yIGxvb3AgdG8gYXZvaWQgcmVjdXJzaW9uCiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogICAgZm9yICg7OykgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsZW4KICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgICAgICByZXR1cm4gdXRmOFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGgKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuIGxlbiAqIDIKICAgICAgICBjYXNlICdoZXgnOgogICAgICAgICAgcmV0dXJuIGxlbiA+Pj4gMQogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICByZXR1cm4gYmFzZTY0VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobG93ZXJlZENhc2UpIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aCAvLyBhc3N1bWUgdXRmOAogICAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CiAgQnVmZmVyLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgCiAgZnVuY3Rpb24gc2xvd1RvU3RyaW5nIChlbmNvZGluZywgc3RhcnQsIGVuZCkgewogICAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICAKICAgIC8vIE5vIG5lZWQgdG8gdmVyaWZ5IHRoYXQgInRoaXMubGVuZ3RoIDw9IE1BWF9VSU5UMzIiIHNpbmNlIGl0J3MgYSByZWFkLW9ubHkKICAgIC8vIHByb3BlcnR5IG9mIGEgdHlwZWQgYXJyYXkuCiAgCiAgICAvLyBUaGlzIGJlaGF2ZXMgbmVpdGhlciBsaWtlIFN0cmluZyBub3IgVWludDhBcnJheSBpbiB0aGF0IHdlIHNldCBzdGFydC9lbmQKICAgIC8vIHRvIHRoZWlyIHVwcGVyL2xvd2VyIGJvdW5kcyBpZiB0aGUgdmFsdWUgcGFzc2VkIGlzIG91dCBvZiByYW5nZS4KICAgIC8vIHVuZGVmaW5lZCBpcyBoYW5kbGVkIHNwZWNpYWxseSBhcyBwZXIgRUNNQS0yNjIgNnRoIEVkaXRpb24sCiAgICAvLyBTZWN0aW9uIDEzLjMuMy43IFJ1bnRpbWUgU2VtYW50aWNzOiBLZXllZEJpbmRpbmdJbml0aWFsaXphdGlvbi4KICAgIGlmIChzdGFydCA9PT0gdW5kZWZpbmVkIHx8IHN0YXJ0IDwgMCkgewogICAgICBzdGFydCA9IDAKICAgIH0KICAgIC8vIFJldHVybiBlYXJseSBpZiBzdGFydCA+IHRoaXMubGVuZ3RoLiBEb25lIGhlcmUgdG8gcHJldmVudCBwb3RlbnRpYWwgdWludDMyCiAgICAvLyBjb2VyY2lvbiBmYWlsIGJlbG93LgogICAgaWYgKHN0YXJ0ID4gdGhpcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICBpZiAoZW5kID09PSB1bmRlZmluZWQgfHwgZW5kID4gdGhpcy5sZW5ndGgpIHsKICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgIH0KICAKICAgIGlmIChlbmQgPD0gMCkgewogICAgICByZXR1cm4gJycKICAgIH0KICAKICAgIC8vIEZvcmNlIGNvZXJzaW9uIHRvIHVpbnQzMi4gVGhpcyB3aWxsIGFsc28gY29lcmNlIGZhbHNleS9OYU4gdmFsdWVzIHRvIDAuCiAgICBlbmQgPj4+PSAwCiAgICBzdGFydCA+Pj49IDAKICAKICAgIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwogIAogICAgd2hpbGUgKHRydWUpIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgICByZXR1cm4gaGV4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgICByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgICAgcmV0dXJuIGFzY2lpU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gbGF0aW4xU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgICAgcmV0dXJuIGJhc2U2NFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiB1dGYxNmxlU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgICBlbmNvZGluZyA9IChlbmNvZGluZyArICcnKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICAKICAvLyBUaGUgcHJvcGVydHkgaXMgdXNlZCBieSBgQnVmZmVyLmlzQnVmZmVyYCBhbmQgYGlzLWJ1ZmZlcmAgKGluIFNhZmFyaSA1LTcpIHRvIGRldGVjdAogIC8vIEJ1ZmZlciBpbnN0YW5jZXMuCiAgQnVmZmVyLnByb3RvdHlwZS5faXNCdWZmZXIgPSB0cnVlCiAgCiAgZnVuY3Rpb24gc3dhcCAoYiwgbiwgbSkgewogICAgdmFyIGkgPSBiW25dCiAgICBiW25dID0gYlttXQogICAgYlttXSA9IGkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwMTYgPSBmdW5jdGlvbiBzd2FwMTYgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgMiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyAxKQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwMzIgPSBmdW5jdGlvbiBzd2FwMzIgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgNCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDMyLWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyAzKQogICAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgMikKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc3dhcDY0ID0gZnVuY3Rpb24gc3dhcDY0ICgpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgaWYgKGxlbiAlIDggIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA2NC1iaXRzJykKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDgpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgNykKICAgICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDYpCiAgICAgIHN3YXAodGhpcywgaSArIDIsIGkgKyA1KQogICAgICBzd2FwKHRoaXMsIGkgKyAzLCBpICsgNCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZyAoKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggfCAwCiAgICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gJycKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIDAsIGxlbmd0aCkKICAgIHJldHVybiBzbG93VG9TdHJpbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uIGVxdWFscyAoYikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogICAgaWYgKHRoaXMgPT09IGIpIHJldHVybiB0cnVlCiAgICByZXR1cm4gQnVmZmVyLmNvbXBhcmUodGhpcywgYikgPT09IDAKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbnNwZWN0ID0gZnVuY3Rpb24gaW5zcGVjdCAoKSB7CiAgICB2YXIgc3RyID0gJycKICAgIHZhciBtYXggPSBleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTCiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHN0ciA9IHRoaXMudG9TdHJpbmcoJ2hleCcsIDAsIG1heCkubWF0Y2goLy57Mn0vZykuam9pbignICcpCiAgICAgIGlmICh0aGlzLmxlbmd0aCA+IG1heCkgc3RyICs9ICcgLi4uICcKICAgIH0KICAgIHJldHVybiAnPEJ1ZmZlciAnICsgc3RyICsgJz4nCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuY29tcGFyZSA9IGZ1bmN0aW9uIGNvbXBhcmUgKHRhcmdldCwgc3RhcnQsIGVuZCwgdGhpc1N0YXJ0LCB0aGlzRW5kKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcih0YXJnZXQpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogICAgfQogIAogICAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgICAgc3RhcnQgPSAwCiAgICB9CiAgICBpZiAoZW5kID09PSB1bmRlZmluZWQpIHsKICAgICAgZW5kID0gdGFyZ2V0ID8gdGFyZ2V0Lmxlbmd0aCA6IDAKICAgIH0KICAgIGlmICh0aGlzU3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzU3RhcnQgPSAwCiAgICB9CiAgICBpZiAodGhpc0VuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXNFbmQgPSB0aGlzLmxlbmd0aAogICAgfQogIAogICAgaWYgKHN0YXJ0IDwgMCB8fCBlbmQgPiB0YXJnZXQubGVuZ3RoIHx8IHRoaXNTdGFydCA8IDAgfHwgdGhpc0VuZCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvdXQgb2YgcmFuZ2UgaW5kZXgnKQogICAgfQogIAogICAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kICYmIHN0YXJ0ID49IGVuZCkgewogICAgICByZXR1cm4gMAogICAgfQogICAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kKSB7CiAgICAgIHJldHVybiAtMQogICAgfQogICAgaWYgKHN0YXJ0ID49IGVuZCkgewogICAgICByZXR1cm4gMQogICAgfQogIAogICAgc3RhcnQgPj4+PSAwCiAgICBlbmQgPj4+PSAwCiAgICB0aGlzU3RhcnQgPj4+PSAwCiAgICB0aGlzRW5kID4+Pj0gMAogIAogICAgaWYgKHRoaXMgPT09IHRhcmdldCkgcmV0dXJuIDAKICAKICAgIHZhciB4ID0gdGhpc0VuZCAtIHRoaXNTdGFydAogICAgdmFyIHkgPSBlbmQgLSBzdGFydAogICAgdmFyIGxlbiA9IE1hdGgubWluKHgsIHkpCiAgCiAgICB2YXIgdGhpc0NvcHkgPSB0aGlzLnNsaWNlKHRoaXNTdGFydCwgdGhpc0VuZCkKICAgIHZhciB0YXJnZXRDb3B5ID0gdGFyZ2V0LnNsaWNlKHN0YXJ0LCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmICh0aGlzQ29weVtpXSAhPT0gdGFyZ2V0Q29weVtpXSkgewogICAgICAgIHggPSB0aGlzQ29weVtpXQogICAgICAgIHkgPSB0YXJnZXRDb3B5W2ldCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIAogICAgaWYgKHggPCB5KSByZXR1cm4gLTEKICAgIGlmICh5IDwgeCkgcmV0dXJuIDEKICAgIHJldHVybiAwCiAgfQogIAogIC8vIEZpbmRzIGVpdGhlciB0aGUgZmlyc3QgaW5kZXggb2YgYHZhbGAgaW4gYGJ1ZmZlcmAgYXQgb2Zmc2V0ID49IGBieXRlT2Zmc2V0YCwKICAvLyBPUiB0aGUgbGFzdCBpbmRleCBvZiBgdmFsYCBpbiBgYnVmZmVyYCBhdCBvZmZzZXQgPD0gYGJ5dGVPZmZzZXRgLgogIC8vCiAgLy8gQXJndW1lbnRzOgogIC8vIC0gYnVmZmVyIC0gYSBCdWZmZXIgdG8gc2VhcmNoCiAgLy8gLSB2YWwgLSBhIHN0cmluZywgQnVmZmVyLCBvciBudW1iZXIKICAvLyAtIGJ5dGVPZmZzZXQgLSBhbiBpbmRleCBpbnRvIGBidWZmZXJgOyB3aWxsIGJlIGNsYW1wZWQgdG8gYW4gaW50MzIKICAvLyAtIGVuY29kaW5nIC0gYW4gb3B0aW9uYWwgZW5jb2RpbmcsIHJlbGV2YW50IGlzIHZhbCBpcyBhIHN0cmluZwogIC8vIC0gZGlyIC0gdHJ1ZSBmb3IgaW5kZXhPZiwgZmFsc2UgZm9yIGxhc3RJbmRleE9mCiAgZnVuY3Rpb24gYmlkaXJlY3Rpb25hbEluZGV4T2YgKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgICAvLyBFbXB0eSBidWZmZXIgbWVhbnMgbm8gbWF0Y2gKICAgIGlmIChidWZmZXIubGVuZ3RoID09PSAwKSByZXR1cm4gLTEKICAKICAgIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0CiAgICBpZiAodHlwZW9mIGJ5dGVPZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gYnl0ZU9mZnNldAogICAgICBieXRlT2Zmc2V0ID0gMAogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0ID4gMHg3ZmZmZmZmZikgewogICAgICBieXRlT2Zmc2V0ID0gMHg3ZmZmZmZmZgogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgLTB4ODAwMDAwMDApIHsKICAgICAgYnl0ZU9mZnNldCA9IC0weDgwMDAwMDAwCiAgICB9CiAgICBieXRlT2Zmc2V0ID0gK2J5dGVPZmZzZXQgIC8vIENvZXJjZSB0byBOdW1iZXIuCiAgICBpZiAoaXNOYU4oYnl0ZU9mZnNldCkpIHsKICAgICAgLy8gYnl0ZU9mZnNldDogaXQgaXQncyB1bmRlZmluZWQsIG51bGwsIE5hTiwgImZvbyIsIGV0Yywgc2VhcmNoIHdob2xlIGJ1ZmZlcgogICAgICBieXRlT2Zmc2V0ID0gZGlyID8gMCA6IChidWZmZXIubGVuZ3RoIC0gMSkKICAgIH0KICAKICAgIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0OiBuZWdhdGl2ZSBvZmZzZXRzIHN0YXJ0IGZyb20gdGhlIGVuZCBvZiB0aGUgYnVmZmVyCiAgICBpZiAoYnl0ZU9mZnNldCA8IDApIGJ5dGVPZmZzZXQgPSBidWZmZXIubGVuZ3RoICsgYnl0ZU9mZnNldAogICAgaWYgKGJ5dGVPZmZzZXQgPj0gYnVmZmVyLmxlbmd0aCkgewogICAgICBpZiAoZGlyKSByZXR1cm4gLTEKICAgICAgZWxzZSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCAtIDEKICAgIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA8IDApIHsKICAgICAgaWYgKGRpcikgYnl0ZU9mZnNldCA9IDAKICAgICAgZWxzZSByZXR1cm4gLTEKICAgIH0KICAKICAgIC8vIE5vcm1hbGl6ZSB2YWwKICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICB2YWwgPSBCdWZmZXIuZnJvbSh2YWwsIGVuY29kaW5nKQogICAgfQogIAogICAgLy8gRmluYWxseSwgc2VhcmNoIGVpdGhlciBpbmRleE9mIChpZiBkaXIgaXMgdHJ1ZSkgb3IgbGFzdEluZGV4T2YKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsKSkgewogICAgICAvLyBTcGVjaWFsIGNhc2U6IGxvb2tpbmcgZm9yIGVtcHR5IHN0cmluZy9idWZmZXIgYWx3YXlzIGZhaWxzCiAgICAgIGlmICh2YWwubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIC0xCiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgdmFsID0gdmFsICYgMHhGRiAvLyBTZWFyY2ggZm9yIGEgYnl0ZSB2YWx1ZSBbMC0yNTVdCiAgICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJgogICAgICAgICAgdHlwZW9mIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBpZiAoZGlyKSB7CiAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUubGFzdEluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIFsgdmFsIF0sIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpCiAgICB9CiAgCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd2YWwgbXVzdCBiZSBzdHJpbmcsIG51bWJlciBvciBCdWZmZXInKQogIH0KICAKICBmdW5jdGlvbiBhcnJheUluZGV4T2YgKGFyciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgICB2YXIgaW5kZXhTaXplID0gMQogICAgdmFyIGFyckxlbmd0aCA9IGFyci5sZW5ndGgKICAgIHZhciB2YWxMZW5ndGggPSB2YWwubGVuZ3RoCiAgCiAgICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCkgewogICAgICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICBpZiAoZW5jb2RpbmcgPT09ICd1Y3MyJyB8fCBlbmNvZGluZyA9PT0gJ3Vjcy0yJyB8fAogICAgICAgICAgZW5jb2RpbmcgPT09ICd1dGYxNmxlJyB8fCBlbmNvZGluZyA9PT0gJ3V0Zi0xNmxlJykgewogICAgICAgIGlmIChhcnIubGVuZ3RoIDwgMiB8fCB2YWwubGVuZ3RoIDwgMikgewogICAgICAgICAgcmV0dXJuIC0xCiAgICAgICAgfQogICAgICAgIGluZGV4U2l6ZSA9IDIKICAgICAgICBhcnJMZW5ndGggLz0gMgogICAgICAgIHZhbExlbmd0aCAvPSAyCiAgICAgICAgYnl0ZU9mZnNldCAvPSAyCiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIHJlYWQgKGJ1ZiwgaSkgewogICAgICBpZiAoaW5kZXhTaXplID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGJ1ZltpXQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBidWYucmVhZFVJbnQxNkJFKGkgKiBpbmRleFNpemUpCiAgICAgIH0KICAgIH0KICAKICAgIHZhciBpCiAgICBpZiAoZGlyKSB7CiAgICAgIHZhciBmb3VuZEluZGV4ID0gLTEKICAgICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA8IGFyckxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJlYWQoYXJyLCBpKSA9PT0gcmVhZCh2YWwsIGZvdW5kSW5kZXggPT09IC0xID8gMCA6IGkgLSBmb3VuZEluZGV4KSkgewogICAgICAgICAgaWYgKGZvdW5kSW5kZXggPT09IC0xKSBmb3VuZEluZGV4ID0gaQogICAgICAgICAgaWYgKGkgLSBmb3VuZEluZGV4ICsgMSA9PT0gdmFsTGVuZ3RoKSByZXR1cm4gZm91bmRJbmRleCAqIGluZGV4U2l6ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZm91bmRJbmRleCAhPT0gLTEpIGkgLT0gaSAtIGZvdW5kSW5kZXgKICAgICAgICAgIGZvdW5kSW5kZXggPSAtMQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGJ5dGVPZmZzZXQgKyB2YWxMZW5ndGggPiBhcnJMZW5ndGgpIGJ5dGVPZmZzZXQgPSBhcnJMZW5ndGggLSB2YWxMZW5ndGgKICAgICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB2YXIgZm91bmQgPSB0cnVlCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB2YWxMZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHJlYWQoYXJyLCBpICsgaikgIT09IHJlYWQodmFsLCBqKSkgewogICAgICAgICAgICBmb3VuZCA9IGZhbHNlCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChmb3VuZCkgcmV0dXJuIGkKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIC0xCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuaW5jbHVkZXMgPSBmdW5jdGlvbiBpbmNsdWRlcyAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuaW5kZXhPZih2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSAhPT0gLTEKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24gaW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIHRydWUpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUubGFzdEluZGV4T2YgPSBmdW5jdGlvbiBsYXN0SW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGZhbHNlKQogIH0KICAKICBmdW5jdGlvbiBoZXhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICBvZmZzZXQgPSBOdW1iZXIob2Zmc2V0KSB8fCAwCiAgICB2YXIgcmVtYWluaW5nID0gYnVmLmxlbmd0aCAtIG9mZnNldAogICAgaWYgKCFsZW5ndGgpIHsKICAgICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgICB9IGVsc2UgewogICAgICBsZW5ndGggPSBOdW1iZXIobGVuZ3RoKQogICAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgICAgIH0KICAgIH0KICAKICAgIC8vIG11c3QgYmUgYW4gZXZlbiBudW1iZXIgb2YgZGlnaXRzCiAgICB2YXIgc3RyTGVuID0gc3RyaW5nLmxlbmd0aAogICAgaWYgKHN0ckxlbiAlIDIgIT09IDApIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCiAgCiAgICBpZiAobGVuZ3RoID4gc3RyTGVuIC8gMikgewogICAgICBsZW5ndGggPSBzdHJMZW4gLyAyCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBwYXJzZWQgPSBwYXJzZUludChzdHJpbmcuc3Vic3RyKGkgKiAyLCAyKSwgMTYpCiAgICAgIGlmIChpc05hTihwYXJzZWQpKSByZXR1cm4gaQogICAgICBidWZbb2Zmc2V0ICsgaV0gPSBwYXJzZWQKICAgIH0KICAgIHJldHVybiBpCiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcih1dGY4VG9CeXRlcyhzdHJpbmcsIGJ1Zi5sZW5ndGggLSBvZmZzZXQpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBhc2NpaVdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKGFzY2lpVG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBsYXRpbjFXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYXNjaWlXcml0ZShidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKGJhc2U2NFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gdWNzMldyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKHV0ZjE2bGVUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiB3cml0ZSAoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcpCiAgICBpZiAob2Zmc2V0ID09PSB1bmRlZmluZWQpIHsKICAgICAgZW5jb2RpbmcgPSAndXRmOCcKICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgICAgb2Zmc2V0ID0gMAogICAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgZW5jb2RpbmcpCiAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gb2Zmc2V0CiAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICAgIG9mZnNldCA9IDAKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcsIG9mZnNldFssIGxlbmd0aF1bLCBlbmNvZGluZ10pCiAgICB9IGVsc2UgaWYgKGlzRmluaXRlKG9mZnNldCkpIHsKICAgICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgICBpZiAoaXNGaW5pdGUobGVuZ3RoKSkgewogICAgICAgIGxlbmd0aCA9IGxlbmd0aCB8IDAKICAgICAgICBpZiAoZW5jb2RpbmcgPT09IHVuZGVmaW5lZCkgZW5jb2RpbmcgPSAndXRmOCcKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmNvZGluZyA9IGxlbmd0aAogICAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZAogICAgICB9CiAgICAvLyBsZWdhY3kgd3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0LCBsZW5ndGgpIC0gcmVtb3ZlIGluIHYwLjEzCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ0J1ZmZlci53cml0ZShzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXRbLCBsZW5ndGhdKSBpcyBubyBsb25nZXIgc3VwcG9ydGVkJwogICAgICApCiAgICB9CiAgCiAgICB2YXIgcmVtYWluaW5nID0gdGhpcy5sZW5ndGggLSBvZmZzZXQKICAgIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCB8fCBsZW5ndGggPiByZW1haW5pbmcpIGxlbmd0aCA9IHJlbWFpbmluZwogIAogICAgaWYgKChzdHJpbmcubGVuZ3RoID4gMCAmJiAobGVuZ3RoIDwgMCB8fCBvZmZzZXQgPCAwKSkgfHwgb2Zmc2V0ID4gdGhpcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0F0dGVtcHQgdG8gd3JpdGUgb3V0c2lkZSBidWZmZXIgYm91bmRzJykKICAgIH0KICAKICAgIGlmICghZW5jb2RpbmcpIGVuY29kaW5nID0gJ3V0ZjgnCiAgCiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogICAgZm9yICg7OykgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBoZXhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICAgIHJldHVybiB1dGY4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgICByZXR1cm4gYXNjaWlXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsYXRpbjFXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICAvLyBXYXJuaW5nOiBtYXhMZW5ndGggbm90IHRha2VuIGludG8gYWNjb3VudCBpbiBiYXNlNjRXcml0ZQogICAgICAgICAgcmV0dXJuIGJhc2U2NFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiB1Y3MyV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTiAoKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAnQnVmZmVyJywKICAgICAgZGF0YTogQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fYXJyIHx8IHRoaXMsIDApCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIGlmIChzdGFydCA9PT0gMCAmJiBlbmQgPT09IGJ1Zi5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1ZikKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYuc2xpY2Uoc3RhcnQsIGVuZCkpCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgICB2YXIgcmVzID0gW10KICAKICAgIHZhciBpID0gc3RhcnQKICAgIHdoaWxlIChpIDwgZW5kKSB7CiAgICAgIHZhciBmaXJzdEJ5dGUgPSBidWZbaV0KICAgICAgdmFyIGNvZGVQb2ludCA9IG51bGwKICAgICAgdmFyIGJ5dGVzUGVyU2VxdWVuY2UgPSAoZmlyc3RCeXRlID4gMHhFRikgPyA0CiAgICAgICAgOiAoZmlyc3RCeXRlID4gMHhERikgPyAzCiAgICAgICAgOiAoZmlyc3RCeXRlID4gMHhCRikgPyAyCiAgICAgICAgOiAxCiAgCiAgICAgIGlmIChpICsgYnl0ZXNQZXJTZXF1ZW5jZSA8PSBlbmQpIHsKICAgICAgICB2YXIgc2Vjb25kQnl0ZSwgdGhpcmRCeXRlLCBmb3VydGhCeXRlLCB0ZW1wQ29kZVBvaW50CiAgCiAgICAgICAgc3dpdGNoIChieXRlc1BlclNlcXVlbmNlKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGlmIChmaXJzdEJ5dGUgPCAweDgwKSB7CiAgICAgICAgICAgICAgY29kZVBvaW50ID0gZmlyc3RCeXRlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4MUYpIDw8IDB4NiB8IChzZWNvbmRCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0YpIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXQogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAodGhpcmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHhDIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAodGhpcmRCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0ZGICYmICh0ZW1wQ29kZVBvaW50IDwgMHhEODAwIHx8IHRlbXBDb2RlUG9pbnQgPiAweERGRkYpKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl0KICAgICAgICAgICAgZm91cnRoQnl0ZSA9IGJ1ZltpICsgM10KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwICYmIChmb3VydGhCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHgxMiB8IChzZWNvbmRCeXRlICYgMHgzRikgPDwgMHhDIHwgKHRoaXJkQnl0ZSAmIDB4M0YpIDw8IDB4NiB8IChmb3VydGhCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4RkZGRiAmJiB0ZW1wQ29kZVBvaW50IDwgMHgxMTAwMDApIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKGNvZGVQb2ludCA9PT0gbnVsbCkgewogICAgICAgIC8vIHdlIGRpZCBub3QgZ2VuZXJhdGUgYSB2YWxpZCBjb2RlUG9pbnQgc28gaW5zZXJ0IGEKICAgICAgICAvLyByZXBsYWNlbWVudCBjaGFyIChVK0ZGRkQpIGFuZCBhZHZhbmNlIG9ubHkgMSBieXRlCiAgICAgICAgY29kZVBvaW50ID0gMHhGRkZECiAgICAgICAgYnl0ZXNQZXJTZXF1ZW5jZSA9IDEKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPiAweEZGRkYpIHsKICAgICAgICAvLyBlbmNvZGUgdG8gdXRmMTYgKHN1cnJvZ2F0ZSBwYWlyIGRhbmNlKQogICAgICAgIGNvZGVQb2ludCAtPSAweDEwMDAwCiAgICAgICAgcmVzLnB1c2goY29kZVBvaW50ID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKQogICAgICAgIGNvZGVQb2ludCA9IDB4REMwMCB8IGNvZGVQb2ludCAmIDB4M0ZGCiAgICAgIH0KICAKICAgICAgcmVzLnB1c2goY29kZVBvaW50KQogICAgICBpICs9IGJ5dGVzUGVyU2VxdWVuY2UKICAgIH0KICAKICAgIHJldHVybiBkZWNvZGVDb2RlUG9pbnRzQXJyYXkocmVzKQogIH0KICAKICAvLyBCYXNlZCBvbiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8yMjc0NzI3Mi82ODA3NDIsIHRoZSBicm93c2VyIHdpdGgKICAvLyB0aGUgbG93ZXN0IGxpbWl0IGlzIENocm9tZSwgd2l0aCAweDEwMDAwIGFyZ3MuCiAgLy8gV2UgZ28gMSBtYWduaXR1ZGUgbGVzcywgZm9yIHNhZmV0eQogIHZhciBNQVhfQVJHVU1FTlRTX0xFTkdUSCA9IDB4MTAwMAogIAogIGZ1bmN0aW9uIGRlY29kZUNvZGVQb2ludHNBcnJheSAoY29kZVBvaW50cykgewogICAgdmFyIGxlbiA9IGNvZGVQb2ludHMubGVuZ3RoCiAgICBpZiAobGVuIDw9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKSB7CiAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY29kZVBvaW50cykgLy8gYXZvaWQgZXh0cmEgc2xpY2UoKQogICAgfQogIAogICAgLy8gRGVjb2RlIGluIGNodW5rcyB0byBhdm9pZCAiY2FsbCBzdGFjayBzaXplIGV4Y2VlZGVkIi4KICAgIHZhciByZXMgPSAnJwogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoaSA8IGxlbikgewogICAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseSgKICAgICAgICBTdHJpbmcsCiAgICAgICAgY29kZVBvaW50cy5zbGljZShpLCBpICs9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKQogICAgICApCiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIHJldCA9ICcnCiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0gJiAweDdGKQogICAgfQogICAgcmV0dXJuIHJldAogIH0KICAKICBmdW5jdGlvbiBsYXRpbjFTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgcmV0ID0gJycKICAgIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICAKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSkKICAgIH0KICAgIHJldHVybiByZXQKICB9CiAgCiAgZnVuY3Rpb24gaGV4U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIGxlbiA9IGJ1Zi5sZW5ndGgKICAKICAgIGlmICghc3RhcnQgfHwgc3RhcnQgPCAwKSBzdGFydCA9IDAKICAgIGlmICghZW5kIHx8IGVuZCA8IDAgfHwgZW5kID4gbGVuKSBlbmQgPSBsZW4KICAKICAgIHZhciBvdXQgPSAnJwogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgb3V0ICs9IHRvSGV4KGJ1ZltpXSkKICAgIH0KICAgIHJldHVybiBvdXQKICB9CiAgCiAgZnVuY3Rpb24gdXRmMTZsZVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKQogICAgdmFyIHJlcyA9ICcnCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldICsgYnl0ZXNbaSArIDFdICogMjU2KQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2UgKHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgc3RhcnQgPSB+fnN0YXJ0CiAgICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IGxlbiA6IH5+ZW5kCiAgCiAgICBpZiAoc3RhcnQgPCAwKSB7CiAgICAgIHN0YXJ0ICs9IGxlbgogICAgICBpZiAoc3RhcnQgPCAwKSBzdGFydCA9IDAKICAgIH0gZWxzZSBpZiAoc3RhcnQgPiBsZW4pIHsKICAgICAgc3RhcnQgPSBsZW4KICAgIH0KICAKICAgIGlmIChlbmQgPCAwKSB7CiAgICAgIGVuZCArPSBsZW4KICAgICAgaWYgKGVuZCA8IDApIGVuZCA9IDAKICAgIH0gZWxzZSBpZiAoZW5kID4gbGVuKSB7CiAgICAgIGVuZCA9IGxlbgogICAgfQogIAogICAgaWYgKGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydAogIAogICAgdmFyIG5ld0J1ZgogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIG5ld0J1ZiA9IHRoaXMuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICAgICAgbmV3QnVmLl9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIH0gZWxzZSB7CiAgICAgIHZhciBzbGljZUxlbiA9IGVuZCAtIHN0YXJ0CiAgICAgIG5ld0J1ZiA9IG5ldyBCdWZmZXIoc2xpY2VMZW4sIHVuZGVmaW5lZCkKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzbGljZUxlbjsgKytpKSB7CiAgICAgICAgbmV3QnVmW2ldID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBuZXdCdWYKICB9CiAgCiAgLyoKICAgKiBOZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IGJ1ZmZlciBpc24ndCB0cnlpbmcgdG8gd3JpdGUgb3V0IG9mIGJvdW5kcy4KICAgKi8KICBmdW5jdGlvbiBjaGVja09mZnNldCAob2Zmc2V0LCBleHQsIGxlbmd0aCkgewogICAgaWYgKChvZmZzZXQgJSAxKSAhPT0gMCB8fCBvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG5vdCB1aW50JykKICAgIGlmIChvZmZzZXQgKyBleHQgPiBsZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoJykKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludExFID0gZnVuY3Rpb24gcmVhZFVJbnRMRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIAogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XQogICAgdmFyIG11bCA9IDEKICAgIHZhciBpID0gMAogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgaV0gKiBtdWwKICAgIH0KICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludEJFID0gZnVuY3Rpb24gcmVhZFVJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgICB9CiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdCiAgICB2YXIgbXVsID0gMQogICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aF0gKiBtdWwKICAgIH0KICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDggPSBmdW5jdGlvbiByZWFkVUludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gdGhpc1tvZmZzZXRdCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkxFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkJFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgOCkgfCB0aGlzW29mZnNldCArIDFdCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkxFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICgodGhpc1tvZmZzZXRdKSB8CiAgICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSkgKwogICAgICAgICh0aGlzW29mZnNldCArIDNdICogMHgxMDAwMDAwKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJCRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdICogMHgxMDAwMDAwKSArCiAgICAgICgodGhpc1tvZmZzZXQgKyAxXSA8PCAxNikgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CiAgICAgIHRoaXNbb2Zmc2V0ICsgM10pCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludExFID0gZnVuY3Rpb24gcmVhZEludExFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bAogICAgfQogICAgbXVsICo9IDB4ODAKICAKICAgIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludEJFID0gZnVuY3Rpb24gcmVhZEludEJFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGgKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWldCiAgICB3aGlsZSAoaSA+IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1pXSAqIG11bAogICAgfQogICAgbXVsICo9IDB4ODAKICAKICAgIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDggPSBmdW5jdGlvbiByZWFkSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCkKICAgIGlmICghKHRoaXNbb2Zmc2V0XSAmIDB4ODApKSByZXR1cm4gKHRoaXNbb2Zmc2V0XSkKICAgIHJldHVybiAoKDB4ZmYgLSB0aGlzW29mZnNldF0gKyAxKSAqIC0xKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkxFID0gZnVuY3Rpb24gcmVhZEludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKICAgIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgMV0gfCAodGhpc1tvZmZzZXRdIDw8IDgpCiAgICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUgPSBmdW5jdGlvbiByZWFkSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdKSB8CiAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gPDwgMjQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyQkUgPSBmdW5jdGlvbiByZWFkSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdIDw8IDI0KSB8CiAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10pCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0TEUgPSBmdW5jdGlvbiByZWFkRmxvYXRMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCB0cnVlLCAyMywgNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRCRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdEJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCAyMywgNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlTEUgPSBmdW5jdGlvbiByZWFkRG91YmxlTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgNTIsIDgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZERvdWJsZUJFID0gZnVuY3Rpb24gcmVhZERvdWJsZUJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCA1MiwgOCkKICB9CiAgCiAgZnVuY3Rpb24gY2hlY2tJbnQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpCiAgICBpZiAodmFsdWUgPiBtYXggfHwgdmFsdWUgPCBtaW4pIHRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKQogICAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludExFID0gZnVuY3Rpb24gd3JpdGVVSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDEKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApCiAgICB9CiAgCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAodmFsdWUgLyBtdWwpICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlVUludEJFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG1heEJ5dGVzLCAwKQogICAgfQogIAogICAgdmFyIGkgPSBieXRlTGVuZ3RoIC0gMQogICAgdmFyIG11bCA9IDEKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50OCA9IGZ1bmN0aW9uIHdyaXRlVUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMHhmZiwgMCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICByZXR1cm4gb2Zmc2V0ICsgMQogIH0KICAKICBmdW5jdGlvbiBvYmplY3RXcml0ZVVJbnQxNiAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4pIHsKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmICsgdmFsdWUgKyAxCiAgICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKGJ1Zi5sZW5ndGggLSBvZmZzZXQsIDIpOyBpIDwgajsgKytpKSB7CiAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9ICh2YWx1ZSAmICgweGZmIDw8ICg4ICogKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkpKSkgPj4+CiAgICAgICAgKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkgKiA4CiAgICB9CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHhmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MzIgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICAgIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4oYnVmLmxlbmd0aCAtIG9mZnNldCwgNCk7IGkgPCBqOyArK2kpIHsKICAgICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlID4+PiAobGl0dGxlRW5kaWFuID8gaSA6IDMgLSBpKSAqIDgpICYgMHhmZgogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4ZmZmZmZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJCRSA9IGZ1bmN0aW9uIHdyaXRlVUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbGltaXQgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCAtIDEpCiAgCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KQogICAgfQogIAogICAgdmFyIGkgPSAwCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHN1YiA9IDAKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgaWYgKHZhbHVlIDwgMCAmJiBzdWIgPT09IDAgJiYgdGhpc1tvZmZzZXQgKyBpIC0gMV0gIT09IDApIHsKICAgICAgICBzdWIgPSAxCiAgICAgIH0KICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICgodmFsdWUgLyBtdWwpID4+IDApIC0gc3ViICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludEJFID0gZnVuY3Rpb24gd3JpdGVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoIC0gMSkKICAKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbGltaXQgLSAxLCAtbGltaXQpCiAgICB9CiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGggLSAxCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHN1YiA9IDAKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgKyAxXSAhPT0gMCkgewogICAgICAgIHN1YiA9IDEKICAgICAgfQogICAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50OCA9IGZ1bmN0aW9uIHdyaXRlSW50OCAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweDdmLCAtMHg4MCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZiArIHZhbHVlICsgMQogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHJldHVybiBvZmZzZXQgKyAxCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkxFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHg3ZmZmZmZmZiwgLTB4ODAwMDAwMDApCiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrSUVFRTc1NCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgICBpZiAob2Zmc2V0IDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgfQogIAogIGZ1bmN0aW9uIHdyaXRlRmxvYXQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA0LCAzLjQwMjgyMzQ2NjM4NTI4ODZlKzM4LCAtMy40MDI4MjM0NjYzODUyODg2ZSszOCkKICAgIH0KICAgIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDIzLCA0KQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0TEUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0QkUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCiAgfQogIAogIGZ1bmN0aW9uIHdyaXRlRG91YmxlIChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgOCwgMS43OTc2OTMxMzQ4NjIzMTU3RSszMDgsIC0xLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCkKICAgIH0KICAgIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDUyLCA4KQogICAgcmV0dXJuIG9mZnNldCArIDgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUxFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUJFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCiAgfQogIAogIC8vIGNvcHkodGFyZ2V0QnVmZmVyLCB0YXJnZXRTdGFydD0wLCBzb3VyY2VTdGFydD0wLCBzb3VyY2VFbmQ9YnVmZmVyLmxlbmd0aCkKICBCdWZmZXIucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiBjb3B5ICh0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKSB7CiAgICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICAgIGlmICghZW5kICYmIGVuZCAhPT0gMCkgZW5kID0gdGhpcy5sZW5ndGgKICAgIGlmICh0YXJnZXRTdGFydCA+PSB0YXJnZXQubGVuZ3RoKSB0YXJnZXRTdGFydCA9IHRhcmdldC5sZW5ndGgKICAgIGlmICghdGFyZ2V0U3RhcnQpIHRhcmdldFN0YXJ0ID0gMAogICAgaWYgKGVuZCA+IDAgJiYgZW5kIDwgc3RhcnQpIGVuZCA9IHN0YXJ0CiAgCiAgICAvLyBDb3B5IDAgYnl0ZXM7IHdlJ3JlIGRvbmUKICAgIGlmIChlbmQgPT09IHN0YXJ0KSByZXR1cm4gMAogICAgaWYgKHRhcmdldC5sZW5ndGggPT09IDAgfHwgdGhpcy5sZW5ndGggPT09IDApIHJldHVybiAwCiAgCiAgICAvLyBGYXRhbCBlcnJvciBjb25kaXRpb25zCiAgICBpZiAodGFyZ2V0U3RhcnQgPCAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCd0YXJnZXRTdGFydCBvdXQgb2YgYm91bmRzJykKICAgIH0KICAgIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gdGhpcy5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdzb3VyY2VTdGFydCBvdXQgb2YgYm91bmRzJykKICAgIGlmIChlbmQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlRW5kIG91dCBvZiBib3VuZHMnKQogIAogICAgLy8gQXJlIHdlIG9vYj8KICAgIGlmIChlbmQgPiB0aGlzLmxlbmd0aCkgZW5kID0gdGhpcy5sZW5ndGgKICAgIGlmICh0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgPCBlbmQgLSBzdGFydCkgewogICAgICBlbmQgPSB0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgKyBzdGFydAogICAgfQogIAogICAgdmFyIGxlbiA9IGVuZCAtIHN0YXJ0CiAgICB2YXIgaQogIAogICAgaWYgKHRoaXMgPT09IHRhcmdldCAmJiBzdGFydCA8IHRhcmdldFN0YXJ0ICYmIHRhcmdldFN0YXJ0IDwgZW5kKSB7CiAgICAgIC8vIGRlc2NlbmRpbmcgY29weSBmcm9tIGVuZAogICAgICBmb3IgKGkgPSBsZW4gLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHRhcmdldFtpICsgdGFyZ2V0U3RhcnRdID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0gZWxzZSBpZiAobGVuIDwgMTAwMCB8fCAhQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gYXNjZW5kaW5nIGNvcHkgZnJvbSBzdGFydAogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB0YXJnZXRbaSArIHRhcmdldFN0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbCgKICAgICAgICB0YXJnZXQsCiAgICAgICAgdGhpcy5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBsZW4pLAogICAgICAgIHRhcmdldFN0YXJ0CiAgICAgICkKICAgIH0KICAKICAgIHJldHVybiBsZW4KICB9CiAgCiAgLy8gVXNhZ2U6CiAgLy8gICAgYnVmZmVyLmZpbGwobnVtYmVyWywgb2Zmc2V0WywgZW5kXV0pCiAgLy8gICAgYnVmZmVyLmZpbGwoYnVmZmVyWywgb2Zmc2V0WywgZW5kXV0pCiAgLy8gICAgYnVmZmVyLmZpbGwoc3RyaW5nWywgb2Zmc2V0WywgZW5kXV1bLCBlbmNvZGluZ10pCiAgQnVmZmVyLnByb3RvdHlwZS5maWxsID0gZnVuY3Rpb24gZmlsbCAodmFsLCBzdGFydCwgZW5kLCBlbmNvZGluZykgewogICAgLy8gSGFuZGxlIHN0cmluZyBjYXNlczoKICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAnc3RyaW5nJykgewogICAgICAgIGVuY29kaW5nID0gc3RhcnQKICAgICAgICBzdGFydCA9IDAKICAgICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZW5jb2RpbmcgPSBlbmQKICAgICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgICB9CiAgICAgIGlmICh2YWwubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmFyIGNvZGUgPSB2YWwuY2hhckNvZGVBdCgwKQogICAgICAgIGlmIChjb2RlIDwgMjU2KSB7CiAgICAgICAgICB2YWwgPSBjb2RlCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdlbmNvZGluZyBtdXN0IGJlIGEgc3RyaW5nJykKICAgICAgfQogICAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJyAmJiAhQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICAgIHZhbCA9IHZhbCAmIDI1NQogICAgfQogIAogICAgLy8gSW52YWxpZCByYW5nZXMgYXJlIG5vdCBzZXQgdG8gYSBkZWZhdWx0LCBzbyBjYW4gcmFuZ2UgY2hlY2sgZWFybHkuCiAgICBpZiAoc3RhcnQgPCAwIHx8IHRoaXMubGVuZ3RoIDwgc3RhcnQgfHwgdGhpcy5sZW5ndGggPCBlbmQpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ091dCBvZiByYW5nZSBpbmRleCcpCiAgICB9CiAgCiAgICBpZiAoZW5kIDw9IHN0YXJ0KSB7CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgCiAgICBzdGFydCA9IHN0YXJ0ID4+PiAwCiAgICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IHRoaXMubGVuZ3RoIDogZW5kID4+PiAwCiAgCiAgICBpZiAoIXZhbCkgdmFsID0gMAogIAogICAgdmFyIGkKICAgIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgICAgdGhpc1tpXSA9IHZhbAogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgYnl0ZXMgPSBCdWZmZXIuaXNCdWZmZXIodmFsKQogICAgICAgID8gdmFsCiAgICAgICAgOiB1dGY4VG9CeXRlcyhuZXcgQnVmZmVyKHZhbCwgZW5jb2RpbmcpLnRvU3RyaW5nKCkpCiAgICAgIHZhciBsZW4gPSBieXRlcy5sZW5ndGgKICAgICAgZm9yIChpID0gMDsgaSA8IGVuZCAtIHN0YXJ0OyArK2kpIHsKICAgICAgICB0aGlzW2kgKyBzdGFydF0gPSBieXRlc1tpICUgbGVuXQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gdGhpcwogIH0KICAKICAvLyBIRUxQRVIgRlVOQ1RJT05TCiAgLy8gPT09PT09PT09PT09PT09PQogIAogIHZhciBJTlZBTElEX0JBU0U2NF9SRSA9IC9bXitcLzAtOUEtWmEtei1fXS9nCiAgCiAgZnVuY3Rpb24gYmFzZTY0Y2xlYW4gKHN0cikgewogICAgLy8gTm9kZSBzdHJpcHMgb3V0IGludmFsaWQgY2hhcmFjdGVycyBsaWtlIFxuIGFuZCBcdCBmcm9tIHRoZSBzdHJpbmcsIGJhc2U2NC1qcyBkb2VzIG5vdAogICAgc3RyID0gc3RyaW5ndHJpbShzdHIpLnJlcGxhY2UoSU5WQUxJRF9CQVNFNjRfUkUsICcnKQogICAgLy8gTm9kZSBjb252ZXJ0cyBzdHJpbmdzIHdpdGggbGVuZ3RoIDwgMiB0byAnJwogICAgaWYgKHN0ci5sZW5ndGggPCAyKSByZXR1cm4gJycKICAgIC8vIE5vZGUgYWxsb3dzIGZvciBub24tcGFkZGVkIGJhc2U2NCBzdHJpbmdzIChtaXNzaW5nIHRyYWlsaW5nID09PSksIGJhc2U2NC1qcyBkb2VzIG5vdAogICAgd2hpbGUgKHN0ci5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgIHN0ciA9IHN0ciArICc9JwogICAgfQogICAgcmV0dXJuIHN0cgogIH0KICAKICBmdW5jdGlvbiBzdHJpbmd0cmltIChzdHIpIHsKICAgIGlmIChzdHIudHJpbSkgcmV0dXJuIHN0ci50cmltKCkKICAgIHJldHVybiBzdHIucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQogIH0KICAKICBmdW5jdGlvbiB0b0hleCAobikgewogICAgaWYgKG4gPCAxNikgcmV0dXJuICcwJyArIG4udG9TdHJpbmcoMTYpCiAgICByZXR1cm4gbi50b1N0cmluZygxNikKICB9CiAgCiAgZnVuY3Rpb24gdXRmOFRvQnl0ZXMgKHN0cmluZywgdW5pdHMpIHsKICAgIHVuaXRzID0gdW5pdHMgfHwgSW5maW5pdHkKICAgIHZhciBjb2RlUG9pbnQKICAgIHZhciBsZW5ndGggPSBzdHJpbmcubGVuZ3RoCiAgICB2YXIgbGVhZFN1cnJvZ2F0ZSA9IG51bGwKICAgIHZhciBieXRlcyA9IFtdCiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvZGVQb2ludCA9IHN0cmluZy5jaGFyQ29kZUF0KGkpCiAgCiAgICAgIC8vIGlzIHN1cnJvZ2F0ZSBjb21wb25lbnQKICAgICAgaWYgKGNvZGVQb2ludCA+IDB4RDdGRiAmJiBjb2RlUG9pbnQgPCAweEUwMDApIHsKICAgICAgICAvLyBsYXN0IGNoYXIgd2FzIGEgbGVhZAogICAgICAgIGlmICghbGVhZFN1cnJvZ2F0ZSkgewogICAgICAgICAgLy8gbm8gbGVhZCB5ZXQKICAgICAgICAgIGlmIChjb2RlUG9pbnQgPiAweERCRkYpIHsKICAgICAgICAgICAgLy8gdW5leHBlY3RlZCB0cmFpbAogICAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0gZWxzZSBpZiAoaSArIDEgPT09IGxlbmd0aCkgewogICAgICAgICAgICAvLyB1bnBhaXJlZCBsZWFkCiAgICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfQogIAogICAgICAgICAgLy8gdmFsaWQgbGVhZAogICAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAogIAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgCiAgICAgICAgLy8gMiBsZWFkcyBpbiBhIHJvdwogICAgICAgIGlmIChjb2RlUG9pbnQgPCAweERDMDApIHsKICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgCiAgICAgICAgLy8gdmFsaWQgc3Vycm9nYXRlIHBhaXIKICAgICAgICBjb2RlUG9pbnQgPSAobGVhZFN1cnJvZ2F0ZSAtIDB4RDgwMCA8PCAxMCB8IGNvZGVQb2ludCAtIDB4REMwMCkgKyAweDEwMDAwCiAgICAgIH0gZWxzZSBpZiAobGVhZFN1cnJvZ2F0ZSkgewogICAgICAgIC8vIHZhbGlkIGJtcCBjaGFyLCBidXQgbGFzdCBjaGFyIHdhcyBhIGxlYWQKICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgfQogIAogICAgICBsZWFkU3Vycm9nYXRlID0gbnVsbAogIAogICAgICAvLyBlbmNvZGUgdXRmOAogICAgICBpZiAoY29kZVBvaW50IDwgMHg4MCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMSkgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goY29kZVBvaW50KQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4ODAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgfCAweEMwLAogICAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgICApCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHgxMDAwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMykgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHhDIHwgMHhFMCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTEwMDAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSA0KSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDEyIHwgMHhGMCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweEMgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb2RlIHBvaW50JykKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIGJ5dGVzCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpVG9CeXRlcyAoc3RyKSB7CiAgICB2YXIgYnl0ZUFycmF5ID0gW10KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgIC8vIE5vZGUncyBjb2RlIHNlZW1zIHRvIGJlIGRvaW5nIHRoaXMgYW5kIG5vdCAmIDB4N0YuLgogICAgICBieXRlQXJyYXkucHVzaChzdHIuY2hhckNvZGVBdChpKSAmIDB4RkYpCiAgICB9CiAgICByZXR1cm4gYnl0ZUFycmF5CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjE2bGVUb0J5dGVzIChzdHIsIHVuaXRzKSB7CiAgICB2YXIgYywgaGksIGxvCiAgICB2YXIgYnl0ZUFycmF5ID0gW10KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawogIAogICAgICBjID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgICAgaGkgPSBjID4+IDgKICAgICAgbG8gPSBjICUgMjU2CiAgICAgIGJ5dGVBcnJheS5wdXNoKGxvKQogICAgICBieXRlQXJyYXkucHVzaChoaSkKICAgIH0KICAKICAgIHJldHVybiBieXRlQXJyYXkKICB9CiAgCiAgZnVuY3Rpb24gYmFzZTY0VG9CeXRlcyAoc3RyKSB7CiAgICByZXR1cm4gYmFzZTY0LnRvQnl0ZUFycmF5KGJhc2U2NGNsZWFuKHN0cikpCiAgfQogIAogIGZ1bmN0aW9uIGJsaXRCdWZmZXIgKHNyYywgZHN0LCBvZmZzZXQsIGxlbmd0aCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpZiAoKGkgKyBvZmZzZXQgPj0gZHN0Lmxlbmd0aCkgfHwgKGkgPj0gc3JjLmxlbmd0aCkpIGJyZWFrCiAgICAgIGRzdFtpICsgb2Zmc2V0XSA9IHNyY1tpXQogICAgfQogICAgcmV0dXJuIGkKICB9CiAgCiAgZnVuY3Rpb24gaXNuYW4gKHZhbCkgewogICAgcmV0dXJuIHZhbCAhPT0gdmFsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tc2VsZi1jb21wYXJlCiAgfQogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMsdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSxyZXF1aXJlKCJidWZmZXIiKS5CdWZmZXIpCiAgfSx7ImJhc2U2NC1qcyI6NzgsImJ1ZmZlciI6ODEsImllZWU3NTQiOjgzLCJpc2FycmF5Ijo4NH1dLDgyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICBmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgICB0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CiAgICB0aGlzLl9tYXhMaXN0ZW5lcnMgPSB0aGlzLl9tYXhMaXN0ZW5lcnMgfHwgdW5kZWZpbmVkOwogIH0KICBtb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKICAKICAvLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKICBFdmVudEVtaXR0ZXIuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX2V2ZW50cyA9IHVuZGVmaW5lZDsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9tYXhMaXN0ZW5lcnMgPSB1bmRlZmluZWQ7CiAgCiAgLy8gQnkgZGVmYXVsdCBFdmVudEVtaXR0ZXJzIHdpbGwgcHJpbnQgYSB3YXJuaW5nIGlmIG1vcmUgdGhhbiAxMCBsaXN0ZW5lcnMgYXJlCiAgLy8gYWRkZWQgdG8gaXQuIFRoaXMgaXMgYSB1c2VmdWwgZGVmYXVsdCB3aGljaCBoZWxwcyBmaW5kaW5nIG1lbW9yeSBsZWFrcy4KICBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVycyA9IDEwOwogIAogIC8vIE9idmlvdXNseSBub3QgYWxsIEVtaXR0ZXJzIHNob3VsZCBiZSBsaW1pdGVkIHRvIDEwLiBUaGlzIGZ1bmN0aW9uIGFsbG93cwogIC8vIHRoYXQgdG8gYmUgaW5jcmVhc2VkLiBTZXQgdG8gemVybyBmb3IgdW5saW1pdGVkLgogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewogICAgaWYgKCFpc051bWJlcihuKSB8fCBuIDwgMCB8fCBpc05hTihuKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCduIG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXInKTsKICAgIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciBlciwgaGFuZGxlciwgbGVuLCBhcmdzLCBpLCBsaXN0ZW5lcnM7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgCiAgICAvLyBJZiB0aGVyZSBpcyBubyAnZXJyb3InIGV2ZW50IGxpc3RlbmVyIHRoZW4gdGhyb3cuCiAgICBpZiAodHlwZSA9PT0gJ2Vycm9yJykgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAogICAgICAgICAgKGlzT2JqZWN0KHRoaXMuX2V2ZW50cy5lcnJvcikgJiYgIXRoaXMuX2V2ZW50cy5lcnJvci5sZW5ndGgpKSB7CiAgICAgICAgZXIgPSBhcmd1bWVudHNbMV07CiAgICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgIHRocm93IGVyOyAvLyBVbmhhbmRsZWQgJ2Vycm9yJyBldmVudAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBBdCBsZWFzdCBnaXZlIHNvbWUga2luZCBvZiBjb250ZXh0IHRvIHRoZSB1c2VyCiAgICAgICAgICB2YXIgZXJyID0gbmV3IEVycm9yKCdVbmNhdWdodCwgdW5zcGVjaWZpZWQgImVycm9yIiBldmVudC4gKCcgKyBlciArICcpJyk7CiAgICAgICAgICBlcnIuY29udGV4dCA9IGVyOwogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgIGlmIChpc1VuZGVmaW5lZChoYW5kbGVyKSkKICAgICAgcmV0dXJuIGZhbHNlOwogIAogICAgaWYgKGlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgLy8gZmFzdCBjYXNlcwogICAgICAgIGNhc2UgMToKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIHNsb3dlcgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgIGhhbmRsZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoaGFuZGxlcikpIHsKICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGxpc3RlbmVycyA9IGhhbmRsZXIuc2xpY2UoKTsKICAgICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAKICAgIHJldHVybiB0cnVlOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgbTsKICAKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgCiAgICAvLyBUbyBhdm9pZCByZWN1cnNpb24gaW4gdGhlIGNhc2UgdGhhdCB0eXBlID09PSAibmV3TGlzdGVuZXIiISBCZWZvcmUKICAgIC8vIGFkZGluZyBpdCB0byB0aGUgbGlzdGVuZXJzLCBmaXJzdCBlbWl0ICJuZXdMaXN0ZW5lciIuCiAgICBpZiAodGhpcy5fZXZlbnRzLm5ld0xpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ25ld0xpc3RlbmVyJywgdHlwZSwKICAgICAgICAgICAgICAgIGlzRnVuY3Rpb24obGlzdGVuZXIubGlzdGVuZXIpID8KICAgICAgICAgICAgICAgIGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIpOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIC8vIE9wdGltaXplIHRoZSBjYXNlIG9mIG9uZSBsaXN0ZW5lci4gRG9uJ3QgbmVlZCB0aGUgZXh0cmEgYXJyYXkgb2JqZWN0LgogICAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBsaXN0ZW5lcjsKICAgIGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgZ290IGFuIGFycmF5LCBqdXN0IGFwcGVuZC4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogICAgZWxzZQogICAgICAvLyBBZGRpbmcgdGhlIHNlY29uZCBlbGVtZW50LCBuZWVkIHRvIGNoYW5nZSB0byBhcnJheS4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gW3RoaXMuX2V2ZW50c1t0eXBlXSwgbGlzdGVuZXJdOwogIAogICAgLy8gQ2hlY2sgZm9yIGxpc3RlbmVyIGxlYWsKICAgIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CiAgICAgIGlmICghaXNVbmRlZmluZWQodGhpcy5fbWF4TGlzdGVuZXJzKSkgewogICAgICAgIG0gPSB0aGlzLl9tYXhMaXN0ZW5lcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbSA9IEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzOwogICAgICB9CiAgCiAgICAgIGlmIChtICYmIG0gPiAwICYmIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGggPiBtKSB7CiAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7CiAgICAgICAgY29uc29sZS5lcnJvcignKG5vZGUpIHdhcm5pbmc6IHBvc3NpYmxlIEV2ZW50RW1pdHRlciBtZW1vcnkgJyArCiAgICAgICAgICAgICAgICAgICAgICAnbGVhayBkZXRlY3RlZC4gJWQgbGlzdGVuZXJzIGFkZGVkLiAnICsKICAgICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLAogICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCk7CiAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlLnRyYWNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwCiAgICAgICAgICBjb25zb2xlLnRyYWNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub24gPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyOwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwogIAogICAgdmFyIGZpcmVkID0gZmFsc2U7CiAgCiAgICBmdW5jdGlvbiBnKCkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGcpOwogIAogICAgICBpZiAoIWZpcmVkKSB7CiAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgIGxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0KICAKICAgIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKICAgIHRoaXMub24odHlwZSwgZyk7CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIC8vIGVtaXRzIGEgJ3JlbW92ZUxpc3RlbmVyJyBldmVudCBpZmYgdGhlIGxpc3RlbmVyIHdhcyByZW1vdmVkCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgbGlzdCwgcG9zaXRpb24sIGxlbmd0aCwgaTsKICAKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICByZXR1cm4gdGhpczsKICAKICAgIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICBsZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgIHBvc2l0aW9uID0gLTE7CiAgCiAgICBpZiAobGlzdCA9PT0gbGlzdGVuZXIgfHwKICAgICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikKICAgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogIAogICAgfSBlbHNlIGlmIChpc09iamVjdChsaXN0KSkgewogICAgICBmb3IgKGkgPSBsZW5ndGg7IGktLSA+IDA7KSB7CiAgICAgICAgaWYgKGxpc3RbaV0gPT09IGxpc3RlbmVyIHx8CiAgICAgICAgICAgIChsaXN0W2ldLmxpc3RlbmVyICYmIGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmIChwb3NpdGlvbiA8IDApCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgCiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMSkgewogICAgICAgIGxpc3QubGVuZ3RoID0gMDsKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICB9IGVsc2UgewogICAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CiAgICB9CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGtleSwgbGlzdGVuZXJzOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgIHJldHVybiB0aGlzOwogIAogICAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdAogICAgaWYgKCF0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIGVsc2UgaWYgKHRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAKICAgIC8vIGVtaXQgcmVtb3ZlTGlzdGVuZXIgZm9yIGFsbCBsaXN0ZW5lcnMgb24gYWxsIGV2ZW50cwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlbW92ZUxpc3RlbmVyJykgY29udGludWU7CiAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoa2V5KTsKICAgICAgfQogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygncmVtb3ZlTGlzdGVuZXInKTsKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIAogICAgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgaWYgKGlzRnVuY3Rpb24obGlzdGVuZXJzKSkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7CiAgICB9IGVsc2UgaWYgKGxpc3RlbmVycykgewogICAgICAvLyBMSUZPIG9yZGVyCiAgICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoKQogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7CiAgICB9CiAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciByZXQ7CiAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICByZXQgPSBbXTsKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24odGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgICAgcmV0ID0gW3RoaXMuX2V2ZW50c1t0eXBlXV07CiAgICBlbHNlCiAgICAgIHJldCA9IHRoaXMuX2V2ZW50c1t0eXBlXS5zbGljZSgpOwogICAgcmV0dXJuIHJldDsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIGlmICh0aGlzLl9ldmVudHMpIHsKICAgICAgdmFyIGV2bGlzdGVuZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICAgIGlmIChpc0Z1bmN0aW9uKGV2bGlzdGVuZXIpKQogICAgICAgIHJldHVybiAxOwogICAgICBlbHNlIGlmIChldmxpc3RlbmVyKQogICAgICAgIHJldHVybiBldmxpc3RlbmVyLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiAwOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgICByZXR1cm4gZW1pdHRlci5saXN0ZW5lckNvdW50KHR5cGUpOwogIH07CiAgCiAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwogIH0KICAKICBmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKICB9CiAgCiAgZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogIH0KICAKICBmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IHZvaWQgMDsKICB9CiAgCiAgfSx7fV0sODM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGV4cG9ydHMucmVhZCA9IGZ1bmN0aW9uIChidWZmZXIsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CiAgICB2YXIgZSwgbQogICAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMQogICAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDEKICAgIHZhciBlQmlhcyA9IGVNYXggPj4gMQogICAgdmFyIG5CaXRzID0gLTcKICAgIHZhciBpID0gaXNMRSA/IChuQnl0ZXMgLSAxKSA6IDAKICAgIHZhciBkID0gaXNMRSA/IC0xIDogMQogICAgdmFyIHMgPSBidWZmZXJbb2Zmc2V0ICsgaV0KICAKICAgIGkgKz0gZAogIAogICAgZSA9IHMgJiAoKDEgPDwgKC1uQml0cykpIC0gMSkKICAgIHMgPj49ICgtbkJpdHMpCiAgICBuQml0cyArPSBlTGVuCiAgICBmb3IgKDsgbkJpdHMgPiAwOyBlID0gKGUgKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CiAgCiAgICBtID0gZSAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKQogICAgZSA+Pj0gKC1uQml0cykKICAgIG5CaXRzICs9IG1MZW4KICAgIGZvciAoOyBuQml0cyA+IDA7IG0gPSAobSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KICAKICAgIGlmIChlID09PSAwKSB7CiAgICAgIGUgPSAxIC0gZUJpYXMKICAgIH0gZWxzZSBpZiAoZSA9PT0gZU1heCkgewogICAgICByZXR1cm4gbSA/IE5hTiA6ICgocyA/IC0xIDogMSkgKiBJbmZpbml0eSkKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBtICsgTWF0aC5wb3coMiwgbUxlbikKICAgICAgZSA9IGUgLSBlQmlhcwogICAgfQogICAgcmV0dXJuIChzID8gLTEgOiAxKSAqIG0gKiBNYXRoLnBvdygyLCBlIC0gbUxlbikKICB9CiAgCiAgZXhwb3J0cy53cml0ZSA9IGZ1bmN0aW9uIChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogICAgdmFyIGUsIG0sIGMKICAgIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDEKICAgIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxCiAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDEKICAgIHZhciBydCA9IChtTGVuID09PSAyMyA/IE1hdGgucG93KDIsIC0yNCkgLSBNYXRoLnBvdygyLCAtNzcpIDogMCkKICAgIHZhciBpID0gaXNMRSA/IDAgOiAobkJ5dGVzIC0gMSkKICAgIHZhciBkID0gaXNMRSA/IDEgOiAtMQogICAgdmFyIHMgPSB2YWx1ZSA8IDAgfHwgKHZhbHVlID09PSAwICYmIDEgLyB2YWx1ZSA8IDApID8gMSA6IDAKICAKICAgIHZhbHVlID0gTWF0aC5hYnModmFsdWUpCiAgCiAgICBpZiAoaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBJbmZpbml0eSkgewogICAgICBtID0gaXNOYU4odmFsdWUpID8gMSA6IDAKICAgICAgZSA9IGVNYXgKICAgIH0gZWxzZSB7CiAgICAgIGUgPSBNYXRoLmZsb29yKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4yKQogICAgICBpZiAodmFsdWUgKiAoYyA9IE1hdGgucG93KDIsIC1lKSkgPCAxKSB7CiAgICAgICAgZS0tCiAgICAgICAgYyAqPSAyCiAgICAgIH0KICAgICAgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgICAgdmFsdWUgKz0gcnQgLyBjCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgKz0gcnQgKiBNYXRoLnBvdygyLCAxIC0gZUJpYXMpCiAgICAgIH0KICAgICAgaWYgKHZhbHVlICogYyA+PSAyKSB7CiAgICAgICAgZSsrCiAgICAgICAgYyAvPSAyCiAgICAgIH0KICAKICAgICAgaWYgKGUgKyBlQmlhcyA+PSBlTWF4KSB7CiAgICAgICAgbSA9IDAKICAgICAgICBlID0gZU1heAogICAgICB9IGVsc2UgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgICAgbSA9ICgodmFsdWUgKiBjKSAtIDEpICogTWF0aC5wb3coMiwgbUxlbikKICAgICAgICBlID0gZSArIGVCaWFzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgbSA9IHZhbHVlICogTWF0aC5wb3coMiwgZUJpYXMgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pCiAgICAgICAgZSA9IDAKICAgICAgfQogICAgfQogIAogICAgZm9yICg7IG1MZW4gPj0gODsgYnVmZmVyW29mZnNldCArIGldID0gbSAmIDB4ZmYsIGkgKz0gZCwgbSAvPSAyNTYsIG1MZW4gLT0gOCkge30KICAKICAgIGUgPSAoZSA8PCBtTGVuKSB8IG0KICAgIGVMZW4gKz0gbUxlbgogICAgZm9yICg7IGVMZW4gPiAwOyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBlICYgMHhmZiwgaSArPSBkLCBlIC89IDI1NiwgZUxlbiAtPSA4KSB7fQogIAogICAgYnVmZmVyW29mZnNldCArIGkgLSBkXSB8PSBzICogMTI4CiAgfQogIAogIH0se31dLDg0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdG9TdHJpbmcgPSB7fS50b1N0cmluZzsKICAKICBtb2R1bGUuZXhwb3J0cyA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKGFycikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwoYXJyKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgfSx7fV0sODU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgCiAgICBmdW5jdGlvbiBpc0FycmF5KG9iaikgewogICAgICBpZiAob2JqICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBBcnJheV0iOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgICAgIGlmIChvYmogIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IE9iamVjdF0iOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgLy8gQ2hlY2sgdGhlIHNjYWxhciBjYXNlIGZpcnN0LgogICAgICBpZiAoZmlyc3QgPT09IHNlY29uZCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgCiAgICAgIC8vIENoZWNrIGlmIHRoZXkgYXJlIHRoZSBzYW1lIHR5cGUuCiAgICAgIHZhciBmaXJzdFR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZmlyc3QpOwogICAgICBpZiAoZmlyc3RUeXBlICE9PSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc2Vjb25kKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBXZSBrbm93IHRoYXQgZmlyc3QgYW5kIHNlY29uZCBoYXZlIHRoZSBzYW1lIHR5cGUgc28gd2UgY2FuIGp1c3QgY2hlY2sgdGhlCiAgICAgIC8vIGZpcnN0IHR5cGUgZnJvbSBub3cgb24uCiAgICAgIGlmIChpc0FycmF5KGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgdGhleSdyZSBub3QgdGhlIHNhbWUgbGVuZ3RoOwogICAgICAgIGlmIChmaXJzdC5sZW5ndGggIT09IHNlY29uZC5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaXJzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHN0cmljdERlZXBFcXVhbChmaXJzdFtpXSwgc2Vjb25kW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXNPYmplY3QoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgLy8gQW4gb2JqZWN0IGlzIGVxdWFsIGlmIGl0IGhhcyB0aGUgc2FtZSBrZXkvdmFsdWUgcGFpcnMuCiAgICAgICAgdmFyIGtleXNTZWVuID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZpcnN0KSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChmaXJzdCwga2V5KSkgewogICAgICAgICAgICBpZiAoc3RyaWN0RGVlcEVxdWFsKGZpcnN0W2tleV0sIHNlY29uZFtrZXldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5c1NlZW5ba2V5XSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIE5vdyBjaGVjayB0aGF0IHRoZXJlIGFyZW4ndCBhbnkga2V5cyBpbiBzZWNvbmQgdGhhdCB3ZXJlbid0CiAgICAgICAgLy8gaW4gZmlyc3QuCiAgICAgICAgZm9yICh2YXIga2V5MiBpbiBzZWNvbmQpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNlY29uZCwga2V5MikpIHsKICAgICAgICAgICAgaWYgKGtleXNTZWVuW2tleTJdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAKICAgIGZ1bmN0aW9uIGlzRmFsc2Uob2JqKSB7CiAgICAgIC8vIEZyb20gdGhlIHNwZWM6CiAgICAgIC8vIEEgZmFsc2UgdmFsdWUgY29ycmVzcG9uZHMgdG8gdGhlIGZvbGxvd2luZyB2YWx1ZXM6CiAgICAgIC8vIEVtcHR5IGxpc3QKICAgICAgLy8gRW1wdHkgb2JqZWN0CiAgICAgIC8vIEVtcHR5IHN0cmluZwogICAgICAvLyBGYWxzZSBib29sZWFuCiAgICAgIC8vIG51bGwgdmFsdWUKICAKICAgICAgLy8gRmlyc3QgY2hlY2sgdGhlIHNjYWxhciB2YWx1ZXMuCiAgICAgIGlmIChvYmogPT09ICIiIHx8IG9iaiA9PT0gZmFsc2UgfHwgb2JqID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5KG9iaikgJiYgb2JqLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IGFycmF5LgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IG9iamVjdC4KICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgYW55IGtleXMsIHRoZW4KICAgICAgICAgICAgICAvLyB0aGUgb2JqZWN0IGlzIG5vdCBlbXB0eSBzbyB0aGUgb2JqZWN0CiAgICAgICAgICAgICAgLy8gaXMgbm90IGZhbHNlLgogICAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiBvYmpWYWx1ZXMob2JqKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWx1ZXMucHVzaChvYmpba2V5c1tpXV0pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBtZXJnZShhLCBiKSB7CiAgICAgICAgdmFyIG1lcmdlZCA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgICAgIG1lcmdlZFtrZXldID0gYVtrZXldOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkyIGluIGIpIHsKICAgICAgICAgICAgbWVyZ2VkW2tleTJdID0gYltrZXkyXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgIH0KICAKICAgIHZhciB0cmltTGVmdDsKICAgIGlmICh0eXBlb2YgU3RyaW5nLnByb3RvdHlwZS50cmltTGVmdCA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cmltTGVmdCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBzdHIudHJpbUxlZnQoKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRyaW1MZWZ0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci5tYXRjaCgvXlxzKiguKikvKVsxXTsKICAgICAgfTsKICAgIH0KICAKICAgIC8vIFR5cGUgY29uc3RhbnRzIHVzZWQgdG8gZGVmaW5lIGZ1bmN0aW9ucy4KICAgIHZhciBUWVBFX05VTUJFUiA9IDA7CiAgICB2YXIgVFlQRV9BTlkgPSAxOwogICAgdmFyIFRZUEVfU1RSSU5HID0gMjsKICAgIHZhciBUWVBFX0FSUkFZID0gMzsKICAgIHZhciBUWVBFX09CSkVDVCA9IDQ7CiAgICB2YXIgVFlQRV9CT09MRUFOID0gNTsKICAgIHZhciBUWVBFX0VYUFJFRiA9IDY7CiAgICB2YXIgVFlQRV9OVUxMID0gNzsKICAgIHZhciBUWVBFX0FSUkFZX05VTUJFUiA9IDg7CiAgICB2YXIgVFlQRV9BUlJBWV9TVFJJTkcgPSA5OwogIAogICAgdmFyIFRPS19FT0YgPSAiRU9GIjsKICAgIHZhciBUT0tfVU5RVU9URURJREVOVElGSUVSID0gIlVucXVvdGVkSWRlbnRpZmllciI7CiAgICB2YXIgVE9LX1FVT1RFRElERU5USUZJRVIgPSAiUXVvdGVkSWRlbnRpZmllciI7CiAgICB2YXIgVE9LX1JCUkFDS0VUID0gIlJicmFja2V0IjsKICAgIHZhciBUT0tfUlBBUkVOID0gIlJwYXJlbiI7CiAgICB2YXIgVE9LX0NPTU1BID0gIkNvbW1hIjsKICAgIHZhciBUT0tfQ09MT04gPSAiQ29sb24iOwogICAgdmFyIFRPS19SQlJBQ0UgPSAiUmJyYWNlIjsKICAgIHZhciBUT0tfTlVNQkVSID0gIk51bWJlciI7CiAgICB2YXIgVE9LX0NVUlJFTlQgPSAiQ3VycmVudCI7CiAgICB2YXIgVE9LX0VYUFJFRiA9ICJFeHByZWYiOwogICAgdmFyIFRPS19QSVBFID0gIlBpcGUiOwogICAgdmFyIFRPS19PUiA9ICJPciI7CiAgICB2YXIgVE9LX0FORCA9ICJBbmQiOwogICAgdmFyIFRPS19FUSA9ICJFUSI7CiAgICB2YXIgVE9LX0dUID0gIkdUIjsKICAgIHZhciBUT0tfTFQgPSAiTFQiOwogICAgdmFyIFRPS19HVEUgPSAiR1RFIjsKICAgIHZhciBUT0tfTFRFID0gIkxURSI7CiAgICB2YXIgVE9LX05FID0gIk5FIjsKICAgIHZhciBUT0tfRkxBVFRFTiA9ICJGbGF0dGVuIjsKICAgIHZhciBUT0tfU1RBUiA9ICJTdGFyIjsKICAgIHZhciBUT0tfRklMVEVSID0gIkZpbHRlciI7CiAgICB2YXIgVE9LX0RPVCA9ICJEb3QiOwogICAgdmFyIFRPS19OT1QgPSAiTm90IjsKICAgIHZhciBUT0tfTEJSQUNFID0gIkxicmFjZSI7CiAgICB2YXIgVE9LX0xCUkFDS0VUID0gIkxicmFja2V0IjsKICAgIHZhciBUT0tfTFBBUkVOPSAiTHBhcmVuIjsKICAgIHZhciBUT0tfTElURVJBTD0gIkxpdGVyYWwiOwogIAogICAgLy8gVGhlICImIiwgIlsiLCAiPCIsICI+IiB0b2tlbnMKICAgIC8vIGFyZSBub3QgaW4gYmFzaWNUb2tlbiBiZWNhdXNlCiAgICAvLyB0aGVyZSBhcmUgdHdvIHRva2VuIHZhcmlhbnRzCiAgICAvLyAoIiYmIiwgIls/IiwgIjw9IiwgIj49IikuICBUaGlzIGlzIHNwZWNpYWxseSBoYW5kbGVkCiAgICAvLyBiZWxvdy4KICAKICAgIHZhciBiYXNpY1Rva2VucyA9IHsKICAgICAgIi4iOiBUT0tfRE9ULAogICAgICAiKiI6IFRPS19TVEFSLAogICAgICAiLCI6IFRPS19DT01NQSwKICAgICAgIjoiOiBUT0tfQ09MT04sCiAgICAgICJ7IjogVE9LX0xCUkFDRSwKICAgICAgIn0iOiBUT0tfUkJSQUNFLAogICAgICAiXSI6IFRPS19SQlJBQ0tFVCwKICAgICAgIigiOiBUT0tfTFBBUkVOLAogICAgICAiKSI6IFRPS19SUEFSRU4sCiAgICAgICJAIjogVE9LX0NVUlJFTlQKICAgIH07CiAgCiAgICB2YXIgb3BlcmF0b3JTdGFydFRva2VuID0gewogICAgICAgICI8IjogdHJ1ZSwKICAgICAgICAiPiI6IHRydWUsCiAgICAgICAgIj0iOiB0cnVlLAogICAgICAgICIhIjogdHJ1ZQogICAgfTsKICAKICAgIHZhciBza2lwQ2hhcnMgPSB7CiAgICAgICAgIiAiOiB0cnVlLAogICAgICAgICJcdCI6IHRydWUsCiAgICAgICAgIlxuIjogdHJ1ZQogICAgfTsKICAKICAKICAgIGZ1bmN0aW9uIGlzQWxwaGEoY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICJhIiAmJiBjaCA8PSAieiIpIHx8CiAgICAgICAgICAgICAgIChjaCA+PSAiQSIgJiYgY2ggPD0gIloiKSB8fAogICAgICAgICAgICAgICBjaCA9PT0gIl8iOwogICAgfQogIAogICAgZnVuY3Rpb24gaXNOdW0oY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiLSI7CiAgICB9CiAgICBmdW5jdGlvbiBpc0FscGhhTnVtKGNoKSB7CiAgICAgICAgcmV0dXJuIChjaCA+PSAiYSIgJiYgY2ggPD0gInoiKSB8fAogICAgICAgICAgICAgICAoY2ggPj0gIkEiICYmIGNoIDw9ICJaIikgfHwKICAgICAgICAgICAgICAgKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiXyI7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBMZXhlcigpIHsKICAgIH0KICAgIExleGVyLnByb3RvdHlwZSA9IHsKICAgICAgICB0b2tlbml6ZTogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciB0b2tlbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IDA7CiAgICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgICAgdmFyIGlkZW50aWZpZXI7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2N1cnJlbnQgPCBzdHJlYW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNBbHBoYShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lVW5xdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19VTlFVT1RFRElERU5USUZJRVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFzaWNUb2tlbnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IGJhc2ljVG9rZW5zW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN0cmVhbVt0aGlzLl9jdXJyZW50XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogdGhpcy5fY3VycmVudH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZU51bWJlcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiWyIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBObyBuZWVkIHRvIGluY3JlbWVudCB0aGlzLl9jdXJyZW50LiAgVGhpcyBoYXBwZW5zCiAgICAgICAgICAgICAgICAgICAgLy8gaW4gX2NvbnN1bWVMQnJhY2tldAogICAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZUxCcmFja2V0KHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJcIiIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVRdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19RVU9URURJREVOVElGSUVSLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiciKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lUmF3U3RyaW5nTGl0ZXJhbChzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfTElURVJBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJgIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB2YXIgbGl0ZXJhbCA9IHRoaXMuX2NvbnN1bWVMaXRlcmFsKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19MSVRFUkFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbGl0ZXJhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yU3RhcnRUb2tlbltzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0aGlzLl9jb25zdW1lT3BlcmF0b3Ioc3RyZWFtKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNraXBDaGFyc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgd2hpdGVzcGFjZS4KICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0FORCwgdmFsdWU6ICImJiIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfRVhQUkVGLCB2YWx1ZTogIiYiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gInwiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAifCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX09SLCB2YWx1ZTogInx8Iiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19QSVBFLCB2YWx1ZTogInwiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiVW5rbm93biBjaGFyYWN0ZXI6IiArIHN0cmVhbVt0aGlzLl9jdXJyZW50XSk7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJMZXhlckVycm9yIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdG9rZW5zOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVVbnF1b3RlZElkZW50aWZpZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jdXJyZW50IDwgc3RyZWFtLmxlbmd0aCAmJiBpc0FscGhhTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lUXVvdGVkSWRlbnRpZmllcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICJcIiIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBkb3VibGUgcXVvdGUgYW5kIHlvdSBjYW4gZXNjYXBlIGFuIGVzY2FwZS4KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcIiIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVSYXdTdHJpbmdMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gIiciICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgc2luZ2xlIHF1b3RlIGFuZCB5b3UgY2FuIGVzY2FwZSBhbiBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiJyIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBsaXRlcmFsID0gc3RyZWFtLnNsaWNlKHN0YXJ0ICsgMSwgdGhpcy5fY3VycmVudCAtIDEpOwogICAgICAgICAgICByZXR1cm4gbGl0ZXJhbC5yZXBsYWNlKCJcXCciLCAiJyIpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVOdW1iZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VJbnQoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05VTUJFUiwgdmFsdWU6IHZhbHVlLCBzdGFydDogc3RhcnR9OwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVMQnJhY2tldDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GSUxURVIsIHZhbHVlOiAiWz8iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIl0iKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GTEFUVEVOLCB2YWx1ZTogIltdIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xCUkFDS0VULCB2YWx1ZTogIlsiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZU9wZXJhdG9yOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdmFyIHN0YXJ0aW5nQ2hhciA9IHN0cmVhbVtzdGFydF07CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTkUsIHZhbHVlOiAiIT0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTk9ULCB2YWx1ZTogIiEiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFRFLCB2YWx1ZTogIjw9Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFQsIHZhbHVlOiAiPCIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVEUsIHZhbHVlOiAiPj0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVCwgdmFsdWU6ICI+Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI9IikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0VRLCB2YWx1ZTogIj09Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGxpdGVyYWw7CiAgICAgICAgICAgIHdoaWxlKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gImAiICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgbGl0ZXJhbCBjaGFyIG9yIHlvdSBjYW4gZXNjYXBlIHRoZSBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiYCIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGl0ZXJhbFN0cmluZyA9IHRyaW1MZWZ0KHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgICAgICBsaXRlcmFsU3RyaW5nID0gbGl0ZXJhbFN0cmluZy5yZXBsYWNlKCJcXGAiLCAiYCIpOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va3NMaWtlSlNPTihsaXRlcmFsU3RyaW5nKSkgewogICAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gSlNPTiBwYXJzZSBpdCBhcyAiPGxpdGVyYWw+IgogICAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UoIlwiIiArIGxpdGVyYWxTdHJpbmcgKyAiXCIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyArMSBnZXRzIHVzIHRvIHRoZSBlbmRpbmcgImAiLCArMSB0byBtb3ZlIG9uIHRvIHRoZSBuZXh0IGNoYXIuCiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgcmV0dXJuIGxpdGVyYWw7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9va3NMaWtlSlNPTjogZnVuY3Rpb24obGl0ZXJhbFN0cmluZykgewogICAgICAgICAgICB2YXIgc3RhcnRpbmdDaGFycyA9ICJbe1wiIjsKICAgICAgICAgICAgdmFyIGpzb25MaXRlcmFscyA9IFsidHJ1ZSIsICJmYWxzZSIsICJudWxsIl07CiAgICAgICAgICAgIHZhciBudW1iZXJMb29raW5nID0gIi0wMTIzNDU2Nzg5IjsKICAKICAgICAgICAgICAgaWYgKGxpdGVyYWxTdHJpbmcgPT09ICIiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFycy5pbmRleE9mKGxpdGVyYWxTdHJpbmdbMF0pID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGpzb25MaXRlcmFscy5pbmRleE9mKGxpdGVyYWxTdHJpbmcpID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKG51bWJlckxvb2tpbmcuaW5kZXhPZihsaXRlcmFsU3RyaW5nWzBdKSA+PSAwKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgCiAgICAgICAgdmFyIGJpbmRpbmdQb3dlciA9IHt9OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRU9GXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19VTlFVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1FVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1JCUkFDS0VUXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SUEFSRU5dID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0NPTU1BXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SQlJBQ0VdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX05VTUJFUl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQ1VSUkVOVF0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRVhQUkVGXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19QSVBFXSA9IDE7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19PUl0gPSAyOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQU5EXSA9IDM7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19FUV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfR1RdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xUXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19HVEVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xURV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTkVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0ZMQVRURU5dID0gOTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1NUQVJdID0gMjA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19GSUxURVJdID0gMjE7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19ET1RdID0gNDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19OT1RdID0gNDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0VdID0gNTA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0tFVF0gPSA1NTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xQQVJFTl0gPSA2MDsKICAKICAgIGZ1bmN0aW9uIFBhcnNlcigpIHsKICAgIH0KICAKICAgIFBhcnNlci5wcm90b3R5cGUgPSB7CiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgdGhpcy5fbG9hZFRva2VucyhleHByZXNzaW9uKTsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBhc3QgPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19FT0YpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlVuZXhwZWN0ZWQgdG9rZW4gdHlwZTogIiArIHQudHlwZSArICIsIHZhbHVlOiAiICsgdC52YWx1ZSk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3Q7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9hZFRva2VuczogZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgICAgICAgdmFyIHRva2VucyA9IGxleGVyLnRva2VuaXplKGV4cHJlc3Npb24pOwogICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0VPRiwgdmFsdWU6ICIiLCBzdGFydDogZXhwcmVzc2lvbi5sZW5ndGh9KTsKICAgICAgICAgICAgdGhpcy50b2tlbnMgPSB0b2tlbnM7CiAgICAgICAgfSwKICAKICAgICAgICBleHByZXNzaW9uOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIGxlZnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gdGhpcy5udWQobGVmdFRva2VuKTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgd2hpbGUgKHJicCA8IGJpbmRpbmdQb3dlcltjdXJyZW50VG9rZW5dKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy5sZWQoY3VycmVudFRva2VuLCBsZWZ0KTsKICAgICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rYWhlYWQ6IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b2tlbnNbdGhpcy5pbmRleCArIG51bWJlcl0udHlwZTsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rYWhlYWRUb2tlbjogZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRva2Vuc1t0aGlzLmluZGV4ICsgbnVtYmVyXTsKICAgICAgICB9LAogIAogICAgICAgIF9hZHZhbmNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgIH0sCiAgCiAgICAgICAgbnVkOiBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgdmFyIGxlZnQ7CiAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICB2YXIgZXhwcmVzc2lvbjsKICAgICAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgewogICAgICAgICAgICBjYXNlIFRPS19MSVRFUkFMOgogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkxpdGVyYWwiLCB2YWx1ZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICBjYXNlIFRPS19VTlFVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmllbGQiLCBuYW1lOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgIGNhc2UgVE9LX1FVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB7dHlwZTogIkZpZWxkIiwgbmFtZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19MUEFSRU4pIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJRdW90ZWQgaWRlbnRpZmllciBub3QgYWxsb3dlZCBmb3IgZnVuY3Rpb24gbmFtZXMuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19OT1Q6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLk5vdCk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTm90RXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfU1RBUjoKICAgICAgICAgICAgICBsZWZ0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIHJpZ2h0ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIGluIGEgbXVsdGlzZWxlY3QsCiAgICAgICAgICAgICAgICAgIC8vIFthLCBiLCAqXQogICAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlZhbHVlUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfRklMVEVSOgogICAgICAgICAgICAgIHJldHVybiB0aGlzLmxlZCh0b2tlbi50eXBlLCB7dHlwZTogIklkZW50aXR5In0pOwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0U6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RIYXNoKCk7CiAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgbGVmdCA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFt7dHlwZTogIklkZW50aXR5In1dfTsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfTEJSQUNLRVQ6CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX05VTUJFUiB8fCB0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlSW5kZXhFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0SWZTbGljZSh7dHlwZTogIklkZW50aXR5In0sIHJpZ2h0KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1NUQVIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvb2thaGVhZCgxKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbe3R5cGU6ICJJZGVudGl0eSJ9LCByaWdodF19OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgY2FzZSBUT0tfRVhQUkVGOgogICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkV4cHJlZik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRXhwcmVzc2lvblJlZmVyZW5jZSIsIGNoaWxkcmVuOiBbZXhwcmVzc2lvbl19OwogICAgICAgICAgICBjYXNlIFRPS19MUEFSRU46CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUlBBUkVOKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ1VSUkVOVCkgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhpcy5fZXJyb3JUb2tlbih0b2tlbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBsZWQ6IGZ1bmN0aW9uKHRva2VuTmFtZSwgbGVmdCkgewogICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgc3dpdGNoKHRva2VuTmFtZSkgewogICAgICAgICAgICBjYXNlIFRPS19ET1Q6CiAgICAgICAgICAgICAgdmFyIHJicCA9IGJpbmRpbmdQb3dlci5Eb3Q7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1NUQVIpIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJTdWJleHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIENyZWF0aW5nIGEgcHJvamVjdGlvbi4KICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhyYnApOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJWYWx1ZVByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5QaXBlKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19QSVBFLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX09SOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5Pcik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiT3JFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19BTkQ6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkFuZCk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiQW5kRXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfTFBBUkVOOgogICAgICAgICAgICAgIHZhciBuYW1lID0gbGVmdC5uYW1lOwogICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24sIG5vZGU7CiAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JQQVJFTikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NVUlJFTlQpIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgICAgbm9kZSA9IHt0eXBlOiAiRnVuY3Rpb24iLCBuYW1lOiBuYW1lLCBjaGlsZHJlbjogYXJnc307CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIGNhc2UgVE9LX0ZJTFRFUjoKICAgICAgICAgICAgICB2YXIgY29uZGl0aW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZMQVRURU4pIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmlsdGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmlsdGVyUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHQsIGNvbmRpdGlvbl19OwogICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgIHZhciBsZWZ0Tm9kZSA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFtsZWZ0XX07CiAgICAgICAgICAgICAgdmFyIHJpZ2h0Tm9kZSA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdE5vZGUsIHJpZ2h0Tm9kZV19OwogICAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgICAgY2FzZSBUT0tfTkU6CiAgICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICAgIGNhc2UgVE9LX0xUOgogICAgICAgICAgICBjYXNlIFRPS19MVEU6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlQ29tcGFyYXRvcihsZWZ0LCB0b2tlbk5hbWUpOwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0tFVDoKICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVE9LX05VTUJFUiB8fCB0b2tlbi50eXBlID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZUluZGV4RXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdElmU2xpY2UobGVmdCwgcmlnaHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19TVEFSKTsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aGlzLl9lcnJvclRva2VuKHRoaXMuX2xvb2thaGVhZFRva2VuKDApKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9tYXRjaDogZnVuY3Rpb24odG9rZW5UeXBlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IHRva2VuVHlwZSkgewogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiRXhwZWN0ZWQgIiArIHRva2VuVHlwZSArICIsIGdvdDogIiArIHQudHlwZSk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfZXJyb3JUb2tlbjogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJJbnZhbGlkIHRva2VuICgiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnR5cGUgKyAiKTogXCIiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlICsgIlwiIik7CiAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9LAogIAogIAogICAgICAgIF9wYXJzZUluZGV4RXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTiB8fCB0aGlzLl9sb29rYWhlYWQoMSkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlU2xpY2VFeHByZXNzaW9uKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiSW5kZXgiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLl9sb29rYWhlYWRUb2tlbigwKS52YWx1ZX07CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9wcm9qZWN0SWZTbGljZTogZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICAgICAgdmFyIGluZGV4RXhwciA9IHt0eXBlOiAiSW5kZXhFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBpZiAocmlnaHQudHlwZSA9PT0gIlNsaWNlIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiUHJvamVjdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFtpbmRleEV4cHIsIHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3RhcildCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4RXhwcjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlU2xpY2VFeHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gW3N0YXJ0OmVuZDpzdGVwXSB3aGVyZSBlYWNoIHBhcnQgaXMgb3B0aW9uYWwsIGFzIHdlbGwgYXMgdGhlIGxhc3QKICAgICAgICAgICAgLy8gY29sb24uCiAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRUb2tlbiAhPT0gVE9LX1JCUkFDS0VUICYmIGluZGV4IDwgMykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX05VTUJFUikgewogICAgICAgICAgICAgICAgICAgIHBhcnRzW2luZGV4XSA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJTeW50YXggZXJyb3IsIHVuZXhwZWN0ZWQgdG9rZW46ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlcmVycm9yIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogIlNsaWNlIiwKICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBwYXJ0cwogICAgICAgICAgICB9OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlQ29tcGFyYXRvcjogZnVuY3Rpb24obGVmdCwgY29tcGFyYXRvcikgewogICAgICAgICAgdmFyIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlcltjb21wYXJhdG9yXSk7CiAgICAgICAgICByZXR1cm4ge3R5cGU6ICJDb21wYXJhdG9yIiwgbmFtZTogY29tcGFyYXRvciwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlRG90UkhTOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIGxvb2thaGVhZCA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgdmFyIGV4cHJUb2tlbnMgPSBbVE9LX1VOUVVPVEVESURFTlRJRklFUiwgVE9LX1FVT1RFRElERU5USUZJRVIsIFRPS19TVEFSXTsKICAgICAgICAgICAgaWYgKGV4cHJUb2tlbnMuaW5kZXhPZihsb29rYWhlYWQpID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsb29rYWhlYWQgPT09IFRPS19MQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDS0VUKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxvb2thaGVhZCA9PT0gVE9LX0xCUkFDRSkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDRSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdEhhc2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlUHJvamVjdGlvblJIUzogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgICAgaWYgKGJpbmRpbmdQb3dlclt0aGlzLl9sb29rYWhlYWQoMCldIDwgMTApIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0xCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZJTFRFUikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19ET1QpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19ET1QpOwogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiU3l0YW54IGVycm9yLCB1bmV4cGVjdGVkIHRva2VuOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJpZ2h0OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlTXVsdGlzZWxlY3RMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGV4cHJlc3Npb25zID0gW107CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICBleHByZXNzaW9ucy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCB0b2tlbiBSYnJhY2tldCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdExpc3QiLCBjaGlsZHJlbjogZXhwcmVzc2lvbnN9OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlTXVsdGlzZWxlY3RIYXNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBwYWlycyA9IFtdOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJUeXBlcyA9IFtUT0tfVU5RVU9URURJREVOVElGSUVSLCBUT0tfUVVPVEVESURFTlRJRklFUl07CiAgICAgICAgICB2YXIga2V5VG9rZW4sIGtleU5hbWUsIHZhbHVlLCBub2RlOwogICAgICAgICAgZm9yICg7OykgewogICAgICAgICAgICBrZXlUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICBpZiAoaWRlbnRpZmllclR5cGVzLmluZGV4T2Yoa2V5VG9rZW4udHlwZSkgPCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RpbmcgYW4gaWRlbnRpZmllciB0b2tlbiwgZ290OiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5VG9rZW4udHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5TmFtZSA9IGtleVRva2VuLnZhbHVlOwogICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT0xPTik7CiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICBub2RlID0ge3R5cGU6ICJLZXlWYWx1ZVBhaXIiLCBuYW1lOiBrZXlOYW1lLCB2YWx1ZTogdmFsdWV9OwogICAgICAgICAgICBwYWlycy5wdXNoKG5vZGUpOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDRSkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdEhhc2giLCBjaGlsZHJlbjogcGFpcnN9OwogICAgICAgIH0KICAgIH07CiAgCiAgCiAgICBmdW5jdGlvbiBUcmVlSW50ZXJwcmV0ZXIocnVudGltZSkgewogICAgICB0aGlzLnJ1bnRpbWUgPSBydW50aW1lOwogICAgfQogIAogICAgVHJlZUludGVycHJldGVyLnByb3RvdHlwZSA9IHsKICAgICAgICBzZWFyY2g6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUsIHZhbHVlKTsKICAgICAgICB9LAogIAogICAgICAgIHZpc2l0OiBmdW5jdGlvbihub2RlLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgbWF0Y2hlZCwgY3VycmVudCwgcmVzdWx0LCBmaXJzdCwgc2Vjb25kLCBmaWVsZCwgbGVmdCwgcmlnaHQsIGNvbGxlY3RlZCwgaTsKICAgICAgICAgICAgc3dpdGNoIChub2RlLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlICJGaWVsZCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGZpZWxkID0gdmFsdWVbbm9kZS5uYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmllbGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJTdWJleHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIkluZGV4RXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmlnaHQ7CiAgICAgICAgICAgICAgY2FzZSAiSW5kZXgiOgogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IG5vZGUudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gdmFsdWUubGVuZ3RoICsgaW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQgPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSAiU2xpY2UiOgogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzbGljZVBhcmFtcyA9IG5vZGUuY2hpbGRyZW4uc2xpY2UoMCk7CiAgICAgICAgICAgICAgICB2YXIgY29tcHV0ZWQgPSB0aGlzLmNvbXB1dGVTbGljZVBhcmFtcyh2YWx1ZS5sZW5ndGgsIHNsaWNlUGFyYW1zKTsKICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IGNvbXB1dGVkWzBdOwogICAgICAgICAgICAgICAgdmFyIHN0b3AgPSBjb21wdXRlZFsxXTsKICAgICAgICAgICAgICAgIHZhciBzdGVwID0gY29tcHV0ZWRbMl07CiAgICAgICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChzdGVwID4gMCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpID4gc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIlByb2plY3Rpb24iOgogICAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICAgIHZhciBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoYmFzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYXNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGJhc2VbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIlZhbHVlUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSBsZWZ0IGNoaWxkLgogICAgICAgICAgICAgICAgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc09iamVjdChiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IG9ialZhbHVlcyhiYXNlKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWVzW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJGaWx0ZXJQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAgIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IFtdOwogICAgICAgICAgICAgICAgdmFyIGZpbmFsUmVzdWx0cyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJhc2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsyXSwgYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIGlmICghaXNGYWxzZShtYXRjaGVkKSkgewogICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnB1c2goYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmlsdGVyZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgZmlsdGVyZWRbal0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsUmVzdWx0cy5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmluYWxSZXN1bHRzOwogICAgICAgICAgICAgIGNhc2UgIkNvbXBhcmF0b3IiOgogICAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHNlY29uZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgc3dpdGNoKG5vZGUubmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX05FOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9ICFzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0ID4gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPj0gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19MVDoKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA8IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfTFRFOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0IDw9IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gY29tcGFyYXRvcjogIiArIG5vZGUubmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWwgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShvcmlnaW5hbCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbWVyZ2VkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3JpZ2luYWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG9yaWdpbmFsW2ldOwogICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjdXJyZW50KSkgewogICAgICAgICAgICAgICAgICAgIG1lcmdlZC5wdXNoLmFwcGx5KG1lcmdlZCwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICAgICAgICAgICAgY2FzZSAiSWRlbnRpdHkiOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIGNhc2UgIk11bHRpU2VsZWN0TGlzdCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2godGhpcy52aXNpdChub2RlLmNoaWxkcmVuW2ldLCB2YWx1ZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJNdWx0aVNlbGVjdEhhc2giOgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0ge307CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjaGlsZCA9IG5vZGUuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZFtjaGlsZC5uYW1lXSA9IHRoaXMudmlzaXQoY2hpbGQudmFsdWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiT3JFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChpc0ZhbHNlKG1hdGNoZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICAgICAgICAgICAgY2FzZSAiQW5kRXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogIAogICAgICAgICAgICAgICAgaWYgKGlzRmFsc2UoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICBjYXNlICJOb3RFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNGYWxzZShmaXJzdCk7CiAgICAgICAgICAgICAgY2FzZSAiTGl0ZXJhbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICBjYXNlICJGdW5jdGlvbiI6CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRBcmdzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmVkQXJncy5wdXNoKHRoaXMudmlzaXQobm9kZS5jaGlsZHJlbltpXSwgdmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1bnRpbWUuY2FsbEZ1bmN0aW9uKG5vZGUubmFtZSwgcmVzb2x2ZWRBcmdzKTsKICAgICAgICAgICAgICBjYXNlICJFeHByZXNzaW9uUmVmZXJlbmNlIjoKICAgICAgICAgICAgICAgIHZhciByZWZOb2RlID0gbm9kZS5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIC8vIFRhZyB0aGUgbm9kZSB3aXRoIGEgc3BlY2lmaWMgYXR0cmlidXRlIHNvIHRoZSB0eXBlCiAgICAgICAgICAgICAgICAvLyBjaGVja2VyIHZlcmlmeSB0aGUgdHlwZS4KICAgICAgICAgICAgICAgIHJlZk5vZGUuam1lc3BhdGhUeXBlID0gVE9LX0VYUFJFRjsKICAgICAgICAgICAgICAgIHJldHVybiByZWZOb2RlOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbm9kZSB0eXBlOiAiICsgbm9kZS50eXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgY29tcHV0ZVNsaWNlUGFyYW1zOiBmdW5jdGlvbihhcnJheUxlbmd0aCwgc2xpY2VQYXJhbXMpIHsKICAgICAgICAgIHZhciBzdGFydCA9IHNsaWNlUGFyYW1zWzBdOwogICAgICAgICAgdmFyIHN0b3AgPSBzbGljZVBhcmFtc1sxXTsKICAgICAgICAgIHZhciBzdGVwID0gc2xpY2VQYXJhbXNbMl07CiAgICAgICAgICB2YXIgY29tcHV0ZWQgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgICBpZiAoc3RlcCA9PT0gbnVsbCkgewogICAgICAgICAgICBzdGVwID0gMTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RlcCA9PT0gMCkgewogICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkludmFsaWQgc2xpY2UsIHN0ZXAgY2Fubm90IGJlIDAiKTsKICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJSdW50aW1lRXJyb3IiOwogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGVwVmFsdWVOZWdhdGl2ZSA9IHN0ZXAgPCAwID8gdHJ1ZSA6IGZhbHNlOwogIAogICAgICAgICAgaWYgKHN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgc3RhcnQgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IGFycmF5TGVuZ3RoIC0gMSA6IDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5jYXBTbGljZVJhbmdlKGFycmF5TGVuZ3RoLCBzdGFydCwgc3RlcCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoc3RvcCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHN0b3AgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IC0xIDogYXJyYXlMZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3AgPSB0aGlzLmNhcFNsaWNlUmFuZ2UoYXJyYXlMZW5ndGgsIHN0b3AsIHN0ZXApOwogICAgICAgICAgfQogICAgICAgICAgY29tcHV0ZWRbMF0gPSBzdGFydDsKICAgICAgICAgIGNvbXB1dGVkWzFdID0gc3RvcDsKICAgICAgICAgIGNvbXB1dGVkWzJdID0gc3RlcDsKICAgICAgICAgIHJldHVybiBjb21wdXRlZDsKICAgICAgICB9LAogIAogICAgICAgIGNhcFNsaWNlUmFuZ2U6IGZ1bmN0aW9uKGFycmF5TGVuZ3RoLCBhY3R1YWxWYWx1ZSwgc3RlcCkgewogICAgICAgICAgICBpZiAoYWN0dWFsVmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSArPSBhcnJheUxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChhY3R1YWxWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gLTEgOiAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdHVhbFZhbHVlID49IGFycmF5TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gYXJyYXlMZW5ndGggLSAxIDogYXJyYXlMZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFjdHVhbFZhbHVlOwogICAgICAgIH0KICAKICAgIH07CiAgCiAgICBmdW5jdGlvbiBSdW50aW1lKGludGVycHJldGVyKSB7CiAgICAgIHRoaXMuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICAgIHRoaXMuZnVuY3Rpb25UYWJsZSA9IHsKICAgICAgICAgIC8vIG5hbWU6IFtmdW5jdGlvbiwgPHNpZ25hdHVyZT5dCiAgICAgICAgICAvLyBUaGUgPHNpZ25hdHVyZT4gY2FuIGJlOgogICAgICAgICAgLy8KICAgICAgICAgIC8vIHsKICAgICAgICAgIC8vICAgYXJnczogW1t0eXBlMSwgdHlwZTJdLCBbdHlwZTEsIHR5cGUyXV0sCiAgICAgICAgICAvLyAgIHZhcmlhZGljOiB0cnVlfGZhbHNlCiAgICAgICAgICAvLyB9CiAgICAgICAgICAvLwogICAgICAgICAgLy8gRWFjaCBhcmcgaW4gdGhlIGFyZyBsaXN0IGlzIGEgbGlzdCBvZiB2YWxpZCB0eXBlcwogICAgICAgICAgLy8gKGlmIHRoZSBmdW5jdGlvbiBpcyBvdmVybG9hZGVkIGFuZCBzdXBwb3J0cyBtdWx0aXBsZQogICAgICAgICAgLy8gdHlwZXMuICBJZiB0aGUgdHlwZSBpcyAiYW55IiB0aGVuIG5vIHR5cGUgY2hlY2tpbmcKICAgICAgICAgIC8vIG9jY3VycyBvbiB0aGUgYXJndW1lbnQuICBWYXJpYWRpYyBpcyBvcHRpb25hbAogICAgICAgICAgLy8gYW5kIGlmIG5vdCBwcm92aWRlZCBpcyBhc3N1bWVkIHRvIGJlIGZhbHNlLgogICAgICAgICAgYWJzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQWJzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgICAgYXZnOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQXZnLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICAgY2VpbDoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkNlaWwsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBjb250YWluczogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkNvbnRhaW5zLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19LAogICAgICAgICAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJlbmRzX3dpdGgiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRW5kc1dpdGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HXX0sIHt0eXBlczogW1RZUEVfU1RSSU5HXX1dfSwKICAgICAgICAgIGZsb29yOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRmxvb3IsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25MZW5ndGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZLCBUWVBFX09CSkVDVF19XX0sCiAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXAsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfRVhQUkVGXX0sIHt0eXBlczogW1RZUEVfQVJSQVldfV19LAogICAgICAgICAgbWF4OiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWF4LAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICAgIm1lcmdlIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1lcmdlLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF0sIHZhcmlhZGljOiB0cnVlfV0KICAgICAgICAgIH0sCiAgICAgICAgICAibWF4X2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXhCeSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICAgIH0sCiAgICAgICAgICBzdW06IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25TdW0sIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgICAic3RhcnRzX3dpdGgiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU3RhcnRzV2l0aCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkddfSwge3R5cGVzOiBbVFlQRV9TVFJJTkddfV19LAogICAgICAgICAgbWluOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICAgIm1pbl9ieSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluQnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgdHlwZToge19mdW5jOiB0aGlzLl9mdW5jdGlvblR5cGUsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICBrZXlzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uS2V5cywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIHZhbHVlczoge19mdW5jOiB0aGlzLl9mdW5jdGlvblZhbHVlcywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIHNvcnQ6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0LCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9TVFJJTkcsIFRZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAgICJzb3J0X2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0QnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgam9pbjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkpvaW4sCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogWwogICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX1NUUklOR119LAogICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX0FSUkFZX1NUUklOR119CiAgICAgICAgICAgICAgXQogICAgICAgICAgfSwKICAgICAgICAgIHJldmVyc2U6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25SZXZlcnNlLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19XX0sCiAgICAgICAgICAidG9fYXJyYXkiOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9BcnJheSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJ0b19zdHJpbmciOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9TdHJpbmcsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAidG9fbnVtYmVyIjoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvTnVtYmVyLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgIm5vdF9udWxsIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk5vdE51bGwsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXSwgdmFyaWFkaWM6IHRydWV9XQogICAgICAgICAgfQogICAgICB9OwogICAgfQogIAogICAgUnVudGltZS5wcm90b3R5cGUgPSB7CiAgICAgIGNhbGxGdW5jdGlvbjogZnVuY3Rpb24obmFtZSwgcmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uRW50cnkgPSB0aGlzLmZ1bmN0aW9uVGFibGVbbmFtZV07CiAgICAgICAgaWYgKGZ1bmN0aW9uRW50cnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZnVuY3Rpb246ICIgKyBuYW1lICsgIigpIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3ZhbGlkYXRlQXJncyhuYW1lLCByZXNvbHZlZEFyZ3MsIGZ1bmN0aW9uRW50cnkuX3NpZ25hdHVyZSk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uRW50cnkuX2Z1bmMuY2FsbCh0aGlzLCByZXNvbHZlZEFyZ3MpOwogICAgICB9LAogIAogICAgICBfdmFsaWRhdGVBcmdzOiBmdW5jdGlvbihuYW1lLCBhcmdzLCBzaWduYXR1cmUpIHsKICAgICAgICAgIC8vIFZhbGlkYXRpbmcgdGhlIGFyZ3MgcmVxdWlyZXMgdmFsaWRhdGluZwogICAgICAgICAgLy8gdGhlIGNvcnJlY3QgYXJpdHkgYW5kIHRoZSBjb3JyZWN0IHR5cGUgb2YgZWFjaCBhcmcuCiAgICAgICAgICAvLyBJZiB0aGUgbGFzdCBhcmd1bWVudCBpcyBkZWNsYXJlZCBhcyB2YXJpYWRpYywgdGhlbiB3ZSBuZWVkCiAgICAgICAgICAvLyBhIG1pbmltdW0gbnVtYmVyIG9mIGFyZ3MgdG8gYmUgcmVxdWlyZWQuICBPdGhlcndpc2UgaXQgaGFzIHRvCiAgICAgICAgICAvLyBiZSBhbiBleGFjdCBhbW91bnQuCiAgICAgICAgICB2YXIgcGx1cmFsaXplZDsKICAgICAgICAgIGlmIChzaWduYXR1cmVbc2lnbmF0dXJlLmxlbmd0aCAtIDFdLnZhcmlhZGljKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBwbHVyYWxpemVkID0gc2lnbmF0dXJlLmxlbmd0aCA9PT0gMSA/ICIgYXJndW1lbnQiIDogIiBhcmd1bWVudHMiOwogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50RXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzIGF0IGxlYXN0IiArIHNpZ25hdHVyZS5sZW5ndGggKyBwbHVyYWxpemVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCAhPT0gc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICAgIHBsdXJhbGl6ZWQgPSBzaWduYXR1cmUubGVuZ3RoID09PSAxID8gIiBhcmd1bWVudCIgOiAiIGFyZ3VtZW50cyI7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudEVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzICIgKyBzaWduYXR1cmUubGVuZ3RoICsgcGx1cmFsaXplZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNwZWM7CiAgICAgICAgICB2YXIgYWN0dWFsVHlwZTsKICAgICAgICAgIHZhciB0eXBlTWF0Y2hlZDsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2lnbmF0dXJlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdHlwZU1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBjdXJyZW50U3BlYyA9IHNpZ25hdHVyZVtpXS50eXBlczsKICAgICAgICAgICAgICBhY3R1YWxUeXBlID0gdGhpcy5fZ2V0VHlwZU5hbWUoYXJnc1tpXSk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjdXJyZW50U3BlYy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdHlwZU1hdGNoZXMoYWN0dWFsVHlwZSwgY3VycmVudFNwZWNbal0sIGFyZ3NbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXR5cGVNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJleHBlY3RlZCBhcmd1bWVudCAiICsgKGkgKyAxKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIHRvIGJlIHR5cGUgIiArIGN1cnJlbnRTcGVjICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkIHR5cGUgIiArIGFjdHVhbFR5cGUgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX3R5cGVNYXRjaGVzOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBhcmdWYWx1ZSkgewogICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FOWSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX1NUUklORyB8fAogICAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUiB8fAogICAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgLy8gVGhlIGV4cGVjdGVkIHR5cGUgY2FuIGVpdGhlciBqdXN0IGJlIGFycmF5LAogICAgICAgICAgICAgIC8vIG9yIGl0IGNhbiByZXF1aXJlIGEgc3BlY2lmaWMgc3VidHlwZSAoYXJyYXkgb2YgbnVtYmVycykuCiAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAvLyBUaGUgc2ltcGxlc3QgY2FzZSBpcyBpZiAiYXJyYXkiIHdpdGggbm8gc3VidHlwZSBpcyBzcGVjaWZpZWQuCiAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IFRZUEVfQVJSQVk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhY3R1YWwgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG5lZWQgdG8gY2hlY2sgc3VidHlwZXMuCiAgICAgICAgICAgICAgICAgIC8vIEkgdGhpbmsgdGhpcyBoYXMgcG90ZW50aWFsIHRvIGJlIGltcHJvdmVkLgogICAgICAgICAgICAgICAgICB2YXIgc3VidHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUikgewogICAgICAgICAgICAgICAgICAgIHN1YnR5cGUgPSBUWVBFX05VTUJFUjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9TVFJJTkcpIHsKICAgICAgICAgICAgICAgICAgICBzdWJ0eXBlID0gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdWYWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl90eXBlTWF0Y2hlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2V0VHlwZU5hbWUoYXJnVmFsdWVbaV0pLCBzdWJ0eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ1ZhbHVlW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IGV4cGVjdGVkOwogICAgICAgICAgfQogICAgICB9LAogICAgICBfZ2V0VHlwZU5hbWU6IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgc3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSkgewogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgU3RyaW5nXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdW1iZXJdIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX05VTUJFUjsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IEFycmF5XSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9BUlJBWTsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IEJvb2xlYW5dIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0JPT0xFQU47CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdWxsXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OVUxMOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgT2JqZWN0XSI6CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGFuIGV4cHJlZi4gIElmIGl0IGhhcywgaXQncyBiZWVuCiAgICAgICAgICAgICAgICAvLyB0YWdnZWQgd2l0aCBhIGptZXNwYXRoVHlwZSBhdHRyIG9mICdFeHByZWYnOwogICAgICAgICAgICAgICAgaWYgKG9iai5qbWVzcGF0aFR5cGUgPT09IFRPS19FWFBSRUYpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfRVhQUkVGOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfT0JKRUNUOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25TdGFydHNXaXRoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGFzdEluZGV4T2YocmVzb2x2ZWRBcmdzWzFdKSA9PT0gMDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uRW5kc1dpdGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHNlYXJjaFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBzdWZmaXggPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgICByZXR1cm4gc2VhcmNoU3RyLmluZGV4T2Yoc3VmZml4LCBzZWFyY2hTdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCkgIT09IC0xOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25SZXZlcnNlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgdmFyIHJldmVyc2VkU3RyID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBvcmlnaW5hbFN0ci5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgcmV2ZXJzZWRTdHIgKz0gb3JpZ2luYWxTdHJbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VkU3RyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJldmVyc2VkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICAgIHJldmVyc2VkQXJyYXkucmV2ZXJzZSgpOwogICAgICAgICAgICByZXR1cm4gcmV2ZXJzZWRBcnJheTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQWJzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gTWF0aC5hYnMocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQ2VpbDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkF2ZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc3VtID0gMDsKICAgICAgICAgIHZhciBpbnB1dEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnB1dEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgc3VtICs9IGlucHV0QXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3VtIC8gaW5wdXRBcnJheS5sZW5ndGg7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkNvbnRhaW5zOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0uaW5kZXhPZihyZXNvbHZlZEFyZ3NbMV0pID49IDA7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkZsb29yOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkxlbmd0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgIGlmICghaXNPYmplY3QocmVzb2x2ZWRBcmdzWzBdKSkgewogICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoOwogICAgICAgICB9IGVsc2UgewogICAgICAgICAgIC8vIEFzIGZhciBhcyBJIGNhbiB0ZWxsLCB0aGVyZSdzIG5vIHdheSB0byBnZXQgdGhlIGxlbmd0aAogICAgICAgICAgIC8vIG9mIGFuIG9iamVjdCB3aXRob3V0IE8obikgaXRlcmF0aW9uIHRocm91Z2ggdGhlIG9iamVjdC4KICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVzb2x2ZWRBcmdzWzBdKS5sZW5ndGg7CiAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWFwOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgbWFwcGVkID0gW107CiAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbWFwcGVkLnB1c2goaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgZWxlbWVudHNbaV0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hcHBlZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWVyZ2U6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBtZXJnZWQgPSB7fTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGN1cnJlbnQgPSByZXNvbHZlZEFyZ3NbaV07CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY3VycmVudCkgewogICAgICAgICAgICBtZXJnZWRba2V5XSA9IGN1cnJlbnRba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWF4OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBpZiAocmVzb2x2ZWRBcmdzWzBdLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXVswXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCByZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICB2YXIgbWF4RWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWF4RWxlbWVudC5sb2NhbGVDb21wYXJlKGVsZW1lbnRzW2ldKSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBtYXhFbGVtZW50ID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heEVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGlmIChyZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdWzBdKTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIHZhciBtaW5FbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50c1tpXS5sb2NhbGVDb21wYXJlKG1pbkVsZW1lbnQpIDwgMCkgewogICAgICAgICAgICAgICAgICAgIG1pbkVsZW1lbnQgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWluRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25TdW06IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBzdW0gPSAwOwogICAgICAgIHZhciBsaXN0VG9TdW0gPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0VG9TdW0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHN1bSArPSBsaXN0VG9TdW1baV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdW07CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblR5cGU6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgc3dpdGNoICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9OVU1CRVI6CiAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgICBjYXNlIFRZUEVfU1RSSU5HOgogICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgICAgY2FzZSBUWVBFX0FSUkFZOgogICAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgICAgICBjYXNlIFRZUEVfT0JKRUNUOgogICAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKICAgICAgICAgICAgY2FzZSBUWVBFX0JPT0xFQU46CiAgICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsKICAgICAgICAgICAgY2FzZSBUWVBFX0VYUFJFRjoKICAgICAgICAgICAgICByZXR1cm4gImV4cHJlZiI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9OVUxMOgogICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbktleXM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblZhbHVlczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgb2JqID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsdWVzLnB1c2gob2JqW2tleXNbaV1dKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkpvaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIGpvaW5DaGFyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIGxpc3RKb2luID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgcmV0dXJuIGxpc3RKb2luLmpvaW4oam9pbkNoYXIpOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub0FycmF5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyZXNvbHZlZEFyZ3NbMF1dOwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub1N0cmluZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVG9OdW1iZXI6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIHZhciBjb252ZXJ0ZWRWYWx1ZTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICtyZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgICAgaWYgKCFpc05hTihjb252ZXJ0ZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnRlZFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ob3ROdWxsOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1tpXSkgIT09IFRZUEVfTlVMTCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Tb3J0OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgIHNvcnRlZEFycmF5LnNvcnQoKTsKICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU29ydEJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgIGlmIChzb3J0ZWRBcnJheS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgdmFyIHJlcXVpcmVkVHlwZSA9IHRoaXMuX2dldFR5cGVOYW1lKAogICAgICAgICAgICAgIGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIHNvcnRlZEFycmF5WzBdKSk7CiAgICAgICAgICBpZiAoW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10uaW5kZXhPZihyZXF1aXJlZFR5cGUpIDwgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAvLyBJbiBvcmRlciB0byBnZXQgYSBzdGFibGUgc29ydCBvdXQgb2YgYW4gdW5zdGFibGUKICAgICAgICAgIC8vIHNvcnQgYWxnb3JpdGhtLCB3ZSBkZWNvcmF0ZS9zb3J0L3VuZGVjb3JhdGUgKERTVSkKICAgICAgICAgIC8vIGJ5IGNyZWF0aW5nIGEgbmV3IGxpc3Qgb2YgW2luZGV4LCBlbGVtZW50XSBwYWlycy4KICAgICAgICAgIC8vIEluIHRoZSBjbXAgZnVuY3Rpb24sIGlmIHRoZSBldmFsdWF0ZWQgZWxlbWVudHMgYXJlCiAgICAgICAgICAvLyBlcXVhbCwgdGhlbiB0aGUgaW5kZXggd2lsbCBiZSB1c2VkIGFzIHRoZSB0aWVicmVha2VyLgogICAgICAgICAgLy8gQWZ0ZXIgdGhlIGRlY29yYXRlZCBsaXN0IGhhcyBiZWVuIHNvcnRlZCwgaXQgd2lsbCBiZQogICAgICAgICAgLy8gdW5kZWNvcmF0ZWQgdG8gZXh0cmFjdCB0aGUgb3JpZ2luYWwgZWxlbWVudHMuCiAgICAgICAgICB2YXIgZGVjb3JhdGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGRlY29yYXRlZC5wdXNoKFtpLCBzb3J0ZWRBcnJheVtpXV0pOwogICAgICAgICAgfQogICAgICAgICAgZGVjb3JhdGVkLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICB2YXIgZXhwckEgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBhWzFdKTsKICAgICAgICAgICAgdmFyIGV4cHJCID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgYlsxXSk7CiAgICAgICAgICAgIGlmICh0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkgIT09IHJlcXVpcmVkVHlwZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAgICJUeXBlRXJyb3I6IGV4cGVjdGVkICIgKyByZXF1aXJlZFR5cGUgKyAiLCByZWNlaXZlZCAiICsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSAhPT0gcmVxdWlyZWRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlR5cGVFcnJvcjogZXhwZWN0ZWQgIiArIHJlcXVpcmVkVHlwZSArICIsIHJlY2VpdmVkICIgKwogICAgICAgICAgICAgICAgICAgIHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4cHJBID4gZXhwckIpIHsKICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChleHByQSA8IGV4cHJCKSB7CiAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIHRoZXkncmUgZXF1YWwgY29tcGFyZSB0aGUgaXRlbXMgYnkgdGhlaXIKICAgICAgICAgICAgICAvLyBvcmRlciB0byBtYWludGFpbiByZWxhdGl2ZSBvcmRlciBvZiBlcXVhbCBrZXlzCiAgICAgICAgICAgICAgLy8gKGkuZS4gdG8gZ2V0IGEgc3RhYmxlIHNvcnQpLgogICAgICAgICAgICAgIHJldHVybiBhWzBdIC0gYlswXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICAvLyBVbmRlY29yYXRlOiBleHRyYWN0IG91dCB0aGUgb3JpZ2luYWwgbGlzdCBlbGVtZW50cy4KICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGVjb3JhdGVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHNvcnRlZEFycmF5W2pdID0gZGVjb3JhdGVkW2pdWzFdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NYXhCeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgdmFyIHJlc29sdmVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGtleUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVLZXlGdW5jdGlvbihleHByZWZOb2RlLCBbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXSk7CiAgICAgICAgdmFyIG1heE51bWJlciA9IC1JbmZpbml0eTsKICAgICAgICB2YXIgbWF4UmVjb3JkOwogICAgICAgIHZhciBjdXJyZW50OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgICAgaWYgKGN1cnJlbnQgPiBtYXhOdW1iZXIpIHsKICAgICAgICAgICAgbWF4TnVtYmVyID0gY3VycmVudDsKICAgICAgICAgICAgbWF4UmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1heFJlY29yZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWluQnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHZhciByZXNvbHZlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBrZXlGdW5jdGlvbiA9IHRoaXMuY3JlYXRlS2V5RnVuY3Rpb24oZXhwcmVmTm9kZSwgW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10pOwogICAgICAgIHZhciBtaW5OdW1iZXIgPSBJbmZpbml0eTsKICAgICAgICB2YXIgbWluUmVjb3JkOwogICAgICAgIHZhciBjdXJyZW50OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgICAgaWYgKGN1cnJlbnQgPCBtaW5OdW1iZXIpIHsKICAgICAgICAgICAgbWluTnVtYmVyID0gY3VycmVudDsKICAgICAgICAgICAgbWluUmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1pblJlY29yZDsKICAgICAgfSwKICAKICAgICAgY3JlYXRlS2V5RnVuY3Rpb246IGZ1bmN0aW9uKGV4cHJlZk5vZGUsIGFsbG93ZWRUeXBlcykgewogICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICB2YXIga2V5RnVuYyA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgeCk7CiAgICAgICAgICBpZiAoYWxsb3dlZFR5cGVzLmluZGV4T2YodGhhdC5fZ2V0VHlwZU5hbWUoY3VycmVudCkpIDwgMCkgewogICAgICAgICAgICB2YXIgbXNnID0gIlR5cGVFcnJvcjogZXhwZWN0ZWQgb25lIG9mICIgKyBhbGxvd2VkVHlwZXMgKwogICAgICAgICAgICAgICAgICAgICAgIiwgcmVjZWl2ZWQgIiArIHRoYXQuX2dldFR5cGVOYW1lKGN1cnJlbnQpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGtleUZ1bmM7CiAgICAgIH0KICAKICAgIH07CiAgCiAgICBmdW5jdGlvbiBjb21waWxlKHN0cmVhbSkgewogICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcigpOwogICAgICB2YXIgYXN0ID0gcGFyc2VyLnBhcnNlKHN0cmVhbSk7CiAgICAgIHJldHVybiBhc3Q7CiAgICB9CiAgCiAgICBmdW5jdGlvbiB0b2tlbml6ZShzdHJlYW0pIHsKICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgICByZXR1cm4gbGV4ZXIudG9rZW5pemUoc3RyZWFtKTsKICAgIH0KICAKICAgIGZ1bmN0aW9uIHNlYXJjaChkYXRhLCBleHByZXNzaW9uKSB7CiAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIoKTsKICAgICAgICAvLyBUaGlzIG5lZWRzIHRvIGJlIGltcHJvdmVkLiAgQm90aCB0aGUgaW50ZXJwcmV0ZXIgYW5kIHJ1bnRpbWUgZGVwZW5kIG9uCiAgICAgICAgLy8gZWFjaCBvdGhlci4gIFRoZSBydW50aW1lIG5lZWRzIHRoZSBpbnRlcnByZXRlciB0byBzdXBwb3J0IGV4cHJlZnMuCiAgICAgICAgLy8gVGhlcmUncyBsaWtlbHkgYSBjbGVhbiB3YXkgdG8gYXZvaWQgdGhlIGN5Y2xpYyBkZXBlbmRlbmN5LgogICAgICAgIHZhciBydW50aW1lID0gbmV3IFJ1bnRpbWUoKTsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSBuZXcgVHJlZUludGVycHJldGVyKHJ1bnRpbWUpOwogICAgICAgIHJ1bnRpbWUuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIG5vZGUgPSBwYXJzZXIucGFyc2UoZXhwcmVzc2lvbik7CiAgICAgICAgcmV0dXJuIGludGVycHJldGVyLnNlYXJjaChub2RlLCBkYXRhKTsKICAgIH0KICAKICAgIGV4cG9ydHMudG9rZW5pemUgPSB0b2tlbml6ZTsKICAgIGV4cG9ydHMuY29tcGlsZSA9IGNvbXBpbGU7CiAgICBleHBvcnRzLnNlYXJjaCA9IHNlYXJjaDsKICAgIGV4cG9ydHMuc3RyaWN0RGVlcEVxdWFsID0gc3RyaWN0RGVlcEVxdWFsOwogIH0pKHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiA/IHRoaXMuam1lc3BhdGggPSB7fSA6IGV4cG9ydHMpOwogIAogIH0se31dLDg2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBzaGltIGZvciB1c2luZyBwcm9jZXNzIGluIGJyb3dzZXIKICB2YXIgcHJvY2VzcyA9IG1vZHVsZS5leHBvcnRzID0ge307CiAgCiAgLy8gY2FjaGVkIGZyb20gd2hhdGV2ZXIgZ2xvYmFsIGlzIHByZXNlbnQgc28gdGhhdCB0ZXN0IHJ1bm5lcnMgdGhhdCBzdHViIGl0CiAgLy8gZG9uJ3QgYnJlYWsgdGhpbmdzLiAgQnV0IHdlIG5lZWQgdG8gd3JhcCBpdCBpbiBhIHRyeSBjYXRjaCBpbiBjYXNlIGl0IGlzCiAgLy8gd3JhcHBlZCBpbiBzdHJpY3QgbW9kZSBjb2RlIHdoaWNoIGRvZXNuJ3QgZGVmaW5lIGFueSBnbG9iYWxzLiAgSXQncyBpbnNpZGUgYQogIC8vIGZ1bmN0aW9uIGJlY2F1c2UgdHJ5L2NhdGNoZXMgZGVvcHRpbWl6ZSBpbiBjZXJ0YWluIGVuZ2luZXMuCiAgCiAgdmFyIGNhY2hlZFNldFRpbWVvdXQ7CiAgdmFyIGNhY2hlZENsZWFyVGltZW91dDsKICAKICBmdW5jdGlvbiBkZWZhdWx0U2V0VGltb3V0KCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQnKTsKICB9CiAgZnVuY3Rpb24gZGVmYXVsdENsZWFyVGltZW91dCAoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignY2xlYXJUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7CiAgfQogIChmdW5jdGlvbiAoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodHlwZW9mIHNldFRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0OwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNsZWFyVGltZW91dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgICAgfQogIH0gKCkpCiAgZnVuY3Rpb24gcnVuVGltZW91dChmdW4pIHsKICAgICAgaWYgKGNhY2hlZFNldFRpbWVvdXQgPT09IHNldFRpbWVvdXQpIHsKICAgICAgICAgIC8vbm9ybWFsIGVudmlyb21lbnRzIGluIHNhbmUgc2l0dWF0aW9ucwogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfQogICAgICAvLyBpZiBzZXRUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgICBpZiAoKGNhY2hlZFNldFRpbWVvdXQgPT09IGRlZmF1bHRTZXRUaW1vdXQgfHwgIWNhY2hlZFNldFRpbWVvdXQpICYmIHNldFRpbWVvdXQpIHsKICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0IHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5CiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbChudWxsLCBmdW4sIDApOwogICAgICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvcgogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwodGhpcywgZnVuLCAwKTsKICAgICAgICAgIH0KICAgICAgfQogIAogIAogIH0KICBmdW5jdGlvbiBydW5DbGVhclRpbWVvdXQobWFya2VyKSB7CiAgICAgIGlmIChjYWNoZWRDbGVhclRpbWVvdXQgPT09IGNsZWFyVGltZW91dCkgewogICAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zCiAgICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0KICAgICAgLy8gaWYgY2xlYXJUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgICBpZiAoKGNhY2hlZENsZWFyVGltZW91dCA9PT0gZGVmYXVsdENsZWFyVGltZW91dCB8fCAhY2FjaGVkQ2xlYXJUaW1lb3V0KSAmJiBjbGVhclRpbWVvdXQpIHsKICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0ICB0cnVzdCB0aGUgZ2xvYmFsIG9iamVjdCB3aGVuIGNhbGxlZCBub3JtYWxseQogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbChudWxsLCBtYXJrZXIpOwogICAgICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2hlbiBpdCdzIGEgdmVyc2lvbiBvZiBJLkUuIHRoYXQgbXVzdCBoYXZlIHRoZSBnbG9iYWwgb2JqZWN0IGZvciAndGhpcycsIGhvcGZ1bGx5IG91ciBjb250ZXh0IGNvcnJlY3Qgb3RoZXJ3aXNlIGl0IHdpbGwgdGhyb3cgYSBnbG9iYWwgZXJyb3IuCiAgICAgICAgICAgICAgLy8gU29tZSB2ZXJzaW9ucyBvZiBJLkUuIGhhdmUgZGlmZmVyZW50IHJ1bGVzIGZvciBjbGVhclRpbWVvdXQgdnMgc2V0VGltZW91dAogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbCh0aGlzLCBtYXJrZXIpOwogICAgICAgICAgfQogICAgICB9CiAgCiAgCiAgCiAgfQogIHZhciBxdWV1ZSA9IFtdOwogIHZhciBkcmFpbmluZyA9IGZhbHNlOwogIHZhciBjdXJyZW50UXVldWU7CiAgdmFyIHF1ZXVlSW5kZXggPSAtMTsKICAKICBmdW5jdGlvbiBjbGVhblVwTmV4dFRpY2soKSB7CiAgICAgIGlmICghZHJhaW5pbmcgfHwgIWN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGRyYWluaW5nID0gZmFsc2U7CiAgICAgIGlmIChjdXJyZW50UXVldWUubGVuZ3RoKSB7CiAgICAgICAgICBxdWV1ZSA9IGN1cnJlbnRRdWV1ZS5jb25jYXQocXVldWUpOwogICAgICB9IGVsc2UgewogICAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICB9CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgIGRyYWluUXVldWUoKTsKICAgICAgfQogIH0KICAKICBmdW5jdGlvbiBkcmFpblF1ZXVlKCkgewogICAgICBpZiAoZHJhaW5pbmcpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGltZW91dCA9IHJ1blRpbWVvdXQoY2xlYW5VcE5leHRUaWNrKTsKICAgICAgZHJhaW5pbmcgPSB0cnVlOwogIAogICAgICB2YXIgbGVuID0gcXVldWUubGVuZ3RoOwogICAgICB3aGlsZShsZW4pIHsKICAgICAgICAgIGN1cnJlbnRRdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgcXVldWUgPSBbXTsKICAgICAgICAgIHdoaWxlICgrK3F1ZXVlSW5kZXggPCBsZW4pIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZVtxdWV1ZUluZGV4XS5ydW4oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICAgICAgICBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICAgIH0KICAgICAgY3VycmVudFF1ZXVlID0gbnVsbDsKICAgICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgICAgcnVuQ2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogIH0KICAKICBwcm9jZXNzLm5leHRUaWNrID0gZnVuY3Rpb24gKGZ1bikgewogICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoIC0gMSk7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBxdWV1ZS5wdXNoKG5ldyBJdGVtKGZ1biwgYXJncykpOwogICAgICBpZiAocXVldWUubGVuZ3RoID09PSAxICYmICFkcmFpbmluZykgewogICAgICAgICAgcnVuVGltZW91dChkcmFpblF1ZXVlKTsKICAgICAgfQogIH07CiAgCiAgLy8gdjggbGlrZXMgcHJlZGljdGlibGUgb2JqZWN0cwogIGZ1bmN0aW9uIEl0ZW0oZnVuLCBhcnJheSkgewogICAgICB0aGlzLmZ1biA9IGZ1bjsKICAgICAgdGhpcy5hcnJheSA9IGFycmF5OwogIH0KICBJdGVtLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZnVuLmFwcGx5KG51bGwsIHRoaXMuYXJyYXkpOwogIH07CiAgcHJvY2Vzcy50aXRsZSA9ICdicm93c2VyJzsKICBwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwogIHByb2Nlc3MuZW52ID0ge307CiAgcHJvY2Vzcy5hcmd2ID0gW107CiAgcHJvY2Vzcy52ZXJzaW9uID0gJyc7IC8vIGVtcHR5IHN0cmluZyB0byBhdm9pZCByZWdleHAgaXNzdWVzCiAgcHJvY2Vzcy52ZXJzaW9ucyA9IHt9OwogIAogIGZ1bmN0aW9uIG5vb3AoKSB7fQogIAogIHByb2Nlc3Mub24gPSBub29wOwogIHByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3Mub25jZSA9IG5vb3A7CiAgcHJvY2Vzcy5vZmYgPSBub29wOwogIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3MucmVtb3ZlQWxsTGlzdGVuZXJzID0gbm9vcDsKICBwcm9jZXNzLmVtaXQgPSBub29wOwogIHByb2Nlc3MucHJlcGVuZExpc3RlbmVyID0gbm9vcDsKICBwcm9jZXNzLnByZXBlbmRPbmNlTGlzdGVuZXIgPSBub29wOwogIAogIHByb2Nlc3MubGlzdGVuZXJzID0gZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuIFtdIH0KICAKICBwcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfTsKICAKICBwcm9jZXNzLmN3ZCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICcvJyB9OwogIHByb2Nlc3MuY2hkaXIgPSBmdW5jdGlvbiAoZGlyKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfTsKICBwcm9jZXNzLnVtYXNrID0gZnVuY3Rpb24oKSB7IHJldHVybiAwOyB9OwogIAogIH0se31dLDg3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgLy8gSWYgb2JqLmhhc093blByb3BlcnR5IGhhcyBiZWVuIG92ZXJyaWRkZW4sIHRoZW4gY2FsbGluZwogIC8vIG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSB3aWxsIGJyZWFrLgogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocXMsIHNlcCwgZXEsIG9wdGlvbnMpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIHZhciBvYmogPSB7fTsKICAKICAgIGlmICh0eXBlb2YgcXMgIT09ICdzdHJpbmcnIHx8IHFzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gb2JqOwogICAgfQogIAogICAgdmFyIHJlZ2V4cCA9IC9cKy9nOwogICAgcXMgPSBxcy5zcGxpdChzZXApOwogIAogICAgdmFyIG1heEtleXMgPSAxMDAwOwogICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgICAgbWF4S2V5cyA9IG9wdGlvbnMubWF4S2V5czsKICAgIH0KICAKICAgIHZhciBsZW4gPSBxcy5sZW5ndGg7CiAgICAvLyBtYXhLZXlzIDw9IDAgbWVhbnMgdGhhdCB3ZSBzaG91bGQgbm90IGxpbWl0IGtleXMgY291bnQKICAgIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICAgIGxlbiA9IG1heEtleXM7CiAgICB9CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciB4ID0gcXNbaV0ucmVwbGFjZShyZWdleHAsICclMjAnKSwKICAgICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAgICBrc3RyLCB2c3RyLCBrLCB2OwogIAogICAgICBpZiAoaWR4ID49IDApIHsKICAgICAgICBrc3RyID0geC5zdWJzdHIoMCwgaWR4KTsKICAgICAgICB2c3RyID0geC5zdWJzdHIoaWR4ICsgMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAga3N0ciA9IHg7CiAgICAgICAgdnN0ciA9ICcnOwogICAgICB9CiAgCiAgICAgIGsgPSBkZWNvZGVVUklDb21wb25lbnQoa3N0cik7CiAgICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CiAgCiAgICAgIGlmICghaGFzT3duUHJvcGVydHkob2JqLCBrKSkgewogICAgICAgIG9ialtrXSA9IHY7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgb2JqW2tdLnB1c2godik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqW2tdID0gW29ialtrXSwgdl07CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBvYmo7CiAgfTsKICAKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKHhzKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIAogIH0se31dLDg4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICAgIHN3aXRjaCAodHlwZW9mIHYpIHsKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gdjsKICAKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwogIAogICAgICBjYXNlICdudW1iZXInOgogICAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKICAKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gJyc7CiAgICB9CiAgfTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9iaiwgc2VwLCBlcSwgbmFtZSkgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICBvYmogPSB1bmRlZmluZWQ7CiAgICB9CiAgCiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIG1hcChvYmplY3RLZXlzKG9iaiksIGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIga3MgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKGspKSArIGVxOwogICAgICAgIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgICAgIHJldHVybiBtYXAob2JqW2tdLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUodikpOwogICAgICAgICAgfSkuam9pbihzZXApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9ialtrXSkpOwogICAgICAgIH0KICAgICAgfSkuam9pbihzZXApOwogIAogICAgfQogIAogICAgaWYgKCFuYW1lKSByZXR1cm4gJyc7CiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShuYW1lKSkgKyBlcSArCiAgICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKICB9OwogIAogIHZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeHMpID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgZnVuY3Rpb24gbWFwICh4cywgZikgewogICAgaWYgKHhzLm1hcCkgcmV0dXJuIHhzLm1hcChmKTsKICAgIHZhciByZXMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgeHMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzLnB1c2goZih4c1tpXSwgaSkpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9CiAgCiAgdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSByZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9OwogIAogIH0se31dLDg5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAndXNlIHN0cmljdCc7CiAgCiAgZXhwb3J0cy5kZWNvZGUgPSBleHBvcnRzLnBhcnNlID0gcmVxdWlyZSgnLi9kZWNvZGUnKTsKICBleHBvcnRzLmVuY29kZSA9IGV4cG9ydHMuc3RyaW5naWZ5ID0gcmVxdWlyZSgnLi9lbmNvZGUnKTsKICAKICB9LHsiLi9kZWNvZGUiOjg3LCIuL2VuY29kZSI6ODh9XSw5MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIC8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKICAvLyBvYmouaGFzT3duUHJvcGVydHkocHJvcCkgd2lsbCBicmVhay4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb3llbnQvbm9kZS9pc3N1ZXMvMTcwNwogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKHFzLCBzZXAsIGVxLCBvcHRpb25zKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICB2YXIgb2JqID0ge307CiAgCiAgICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICAKICAgIHZhciByZWdleHAgPSAvXCsvZzsKICAgIHFzID0gcXMuc3BsaXQoc2VwKTsKICAKICAgIHZhciBtYXhLZXlzID0gMTAwMDsKICAgIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLm1heEtleXMgPT09ICdudW1iZXInKSB7CiAgICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgICB9CiAgCiAgICB2YXIgbGVuID0gcXMubGVuZ3RoOwogICAgLy8gbWF4S2V5cyA8PSAwIG1lYW5zIHRoYXQgd2Ugc2hvdWxkIG5vdCBsaW1pdCBrZXlzIGNvdW50CiAgICBpZiAobWF4S2V5cyA+IDAgJiYgbGVuID4gbWF4S2V5cykgewogICAgICBsZW4gPSBtYXhLZXlzOwogICAgfQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICB2YXIgeCA9IHFzW2ldLnJlcGxhY2UocmVnZXhwLCAnJTIwJyksCiAgICAgICAgICBpZHggPSB4LmluZGV4T2YoZXEpLAogICAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKICAKICAgICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgICAgdnN0ciA9IHguc3Vic3RyKGlkeCArIDEpOwogICAgICB9IGVsc2UgewogICAgICAgIGtzdHIgPSB4OwogICAgICAgIHZzdHIgPSAnJzsKICAgICAgfQogIAogICAgICBrID0gZGVjb2RlVVJJQ29tcG9uZW50KGtzdHIpOwogICAgICB2ID0gZGVjb2RlVVJJQ29tcG9uZW50KHZzdHIpOwogIAogICAgICBpZiAoIWhhc093blByb3BlcnR5KG9iaiwgaykpIHsKICAgICAgICBvYmpba10gPSB2OwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIG9ialtrXS5wdXNoKHYpOwogICAgICB9IGVsc2UgewogICAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gb2JqOwogIH07CiAgCiAgfSx7fV0sOTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICB2YXIgc3RyaW5naWZ5UHJpbWl0aXZlID0gZnVuY3Rpb24odikgewogICAgc3dpdGNoICh0eXBlb2YgdikgewogICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgIHJldHVybiB2OwogIAogICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICByZXR1cm4gdiA/ICd0cnVlJyA6ICdmYWxzZSc7CiAgCiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIGlzRmluaXRlKHYpID8gdiA6ICcnOwogIAogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAnJzsKICAgIH0KICB9OwogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICBpZiAob2JqID09PSBudWxsKSB7CiAgICAgIG9iaiA9IHVuZGVmaW5lZDsKICAgIH0KICAKICAgIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5tYXAoZnVuY3Rpb24oaykgewogICAgICAgIHZhciBrcyA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUoaykpICsgZXE7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgICAgcmV0dXJuIG9ialtrXS5tYXAoZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgICB9CiAgICAgIH0pLmpvaW4oc2VwKTsKICAKICAgIH0KICAKICAgIGlmICghbmFtZSkgcmV0dXJuICcnOwogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUobmFtZSkpICsgZXEgKwogICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqKSk7CiAgfTsKICAKICB9LHt9XSw5MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgYXJndW1lbnRzWzRdWzg5XVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKICB9LHsiLi9kZWNvZGUiOjkwLCIuL2VuY29kZSI6OTEsImR1cCI6ODl9XSw5MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChzZXRJbW1lZGlhdGUsY2xlYXJJbW1lZGlhdGUpeyhmdW5jdGlvbiAoKXsKICB2YXIgbmV4dFRpY2sgPSByZXF1aXJlKCdwcm9jZXNzL2Jyb3dzZXIuanMnKS5uZXh0VGljazsKICB2YXIgYXBwbHkgPSBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHk7CiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogIHZhciBpbW1lZGlhdGVJZHMgPSB7fTsKICB2YXIgbmV4dEltbWVkaWF0ZUlkID0gMDsKICAKICAvLyBET00gQVBJcywgZm9yIGNvbXBsZXRlbmVzcwogIAogIGV4cG9ydHMuc2V0VGltZW91dCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0VGltZW91dCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhclRpbWVvdXQpOwogIH07CiAgZXhwb3J0cy5zZXRJbnRlcnZhbCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0SW50ZXJ2YWwsIHdpbmRvdywgYXJndW1lbnRzKSwgY2xlYXJJbnRlcnZhbCk7CiAgfTsKICBleHBvcnRzLmNsZWFyVGltZW91dCA9CiAgZXhwb3J0cy5jbGVhckludGVydmFsID0gZnVuY3Rpb24odGltZW91dCkgeyB0aW1lb3V0LmNsb3NlKCk7IH07CiAgCiAgZnVuY3Rpb24gVGltZW91dChpZCwgY2xlYXJGbikgewogICAgdGhpcy5faWQgPSBpZDsKICAgIHRoaXMuX2NsZWFyRm4gPSBjbGVhckZuOwogIH0KICBUaW1lb3V0LnByb3RvdHlwZS51bnJlZiA9IFRpbWVvdXQucHJvdG90eXBlLnJlZiA9IGZ1bmN0aW9uKCkge307CiAgVGltZW91dC5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NsZWFyRm4uY2FsbCh3aW5kb3csIHRoaXMuX2lkKTsKICB9OwogIAogIC8vIERvZXMgbm90IHN0YXJ0IHRoZSB0aW1lLCBqdXN0IHNldHMgdXAgdGhlIG1lbWJlcnMgbmVlZGVkLgogIGV4cG9ydHMuZW5yb2xsID0gZnVuY3Rpb24oaXRlbSwgbXNlY3MpIHsKICAgIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICAgIGl0ZW0uX2lkbGVUaW1lb3V0ID0gbXNlY3M7CiAgfTsKICAKICBleHBvcnRzLnVuZW5yb2xsID0gZnVuY3Rpb24oaXRlbSkgewogICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogICAgaXRlbS5faWRsZVRpbWVvdXQgPSAtMTsKICB9OwogIAogIGV4cG9ydHMuX3VucmVmQWN0aXZlID0gZXhwb3J0cy5hY3RpdmUgPSBmdW5jdGlvbihpdGVtKSB7CiAgICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgCiAgICB2YXIgbXNlY3MgPSBpdGVtLl9pZGxlVGltZW91dDsKICAgIGlmIChtc2VjcyA+PSAwKSB7CiAgICAgIGl0ZW0uX2lkbGVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uIG9uVGltZW91dCgpIHsKICAgICAgICBpZiAoaXRlbS5fb25UaW1lb3V0KQogICAgICAgICAgaXRlbS5fb25UaW1lb3V0KCk7CiAgICAgIH0sIG1zZWNzKTsKICAgIH0KICB9OwogIAogIC8vIFRoYXQncyBub3QgaG93IG5vZGUuanMgaW1wbGVtZW50cyBpdCBidXQgdGhlIGV4cG9zZWQgYXBpIGlzIHRoZSBzYW1lLgogIGV4cG9ydHMuc2V0SW1tZWRpYXRlID0gdHlwZW9mIHNldEltbWVkaWF0ZSA9PT0gImZ1bmN0aW9uIiA/IHNldEltbWVkaWF0ZSA6IGZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgaWQgPSBuZXh0SW1tZWRpYXRlSWQrKzsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA8IDIgPyBmYWxzZSA6IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAKICAgIGltbWVkaWF0ZUlkc1tpZF0gPSB0cnVlOwogIAogICAgbmV4dFRpY2soZnVuY3Rpb24gb25OZXh0VGljaygpIHsKICAgICAgaWYgKGltbWVkaWF0ZUlkc1tpZF0pIHsKICAgICAgICAvLyBmbi5jYWxsKCkgaXMgZmFzdGVyIHNvIHdlIG9wdGltaXplIGZvciB0aGUgY29tbW9uIHVzZS1jYXNlCiAgICAgICAgLy8gQHNlZSBodHRwOi8vanNwZXJmLmNvbS9jYWxsLWFwcGx5LXNlZ3UKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZuLmNhbGwobnVsbCk7CiAgICAgICAgfQogICAgICAgIC8vIFByZXZlbnQgaWRzIGZyb20gbGVha2luZwogICAgICAgIGV4cG9ydHMuY2xlYXJJbW1lZGlhdGUoaWQpOwogICAgICB9CiAgICB9KTsKICAKICAgIHJldHVybiBpZDsKICB9OwogIAogIGV4cG9ydHMuY2xlYXJJbW1lZGlhdGUgPSB0eXBlb2YgY2xlYXJJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBjbGVhckltbWVkaWF0ZSA6IGZ1bmN0aW9uKGlkKSB7CiAgICBkZWxldGUgaW1tZWRpYXRlSWRzW2lkXTsKICB9OwogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlLHJlcXVpcmUoInRpbWVycyIpLmNsZWFySW1tZWRpYXRlKQogIH0seyJwcm9jZXNzL2Jyb3dzZXIuanMiOjg2LCJ0aW1lcnMiOjkzfV0sOTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIHZhciBwdW55Y29kZSA9IHJlcXVpcmUoJ3B1bnljb2RlJyk7CiAgCiAgZXhwb3J0cy5wYXJzZSA9IHVybFBhcnNlOwogIGV4cG9ydHMucmVzb2x2ZSA9IHVybFJlc29sdmU7CiAgZXhwb3J0cy5yZXNvbHZlT2JqZWN0ID0gdXJsUmVzb2x2ZU9iamVjdDsKICBleHBvcnRzLmZvcm1hdCA9IHVybEZvcm1hdDsKICAKICBleHBvcnRzLlVybCA9IFVybDsKICAKICBmdW5jdGlvbiBVcmwoKSB7CiAgICB0aGlzLnByb3RvY29sID0gbnVsbDsKICAgIHRoaXMuc2xhc2hlcyA9IG51bGw7CiAgICB0aGlzLmF1dGggPSBudWxsOwogICAgdGhpcy5ob3N0ID0gbnVsbDsKICAgIHRoaXMucG9ydCA9IG51bGw7CiAgICB0aGlzLmhvc3RuYW1lID0gbnVsbDsKICAgIHRoaXMuaGFzaCA9IG51bGw7CiAgICB0aGlzLnNlYXJjaCA9IG51bGw7CiAgICB0aGlzLnF1ZXJ5ID0gbnVsbDsKICAgIHRoaXMucGF0aG5hbWUgPSBudWxsOwogICAgdGhpcy5wYXRoID0gbnVsbDsKICAgIHRoaXMuaHJlZiA9IG51bGw7CiAgfQogIAogIC8vIFJlZmVyZW5jZTogUkZDIDM5ODYsIFJGQyAxODA4LCBSRkMgMjM5NgogIAogIC8vIGRlZmluZSB0aGVzZSBoZXJlIHNvIGF0IGxlYXN0IHRoZXkgb25seSBoYXZlIHRvIGJlCiAgLy8gY29tcGlsZWQgb25jZSBvbiB0aGUgZmlyc3QgbW9kdWxlIGxvYWQuCiAgdmFyIHByb3RvY29sUGF0dGVybiA9IC9eKFthLXowLTkuKy1dKzopL2ksCiAgICAgIHBvcnRQYXR0ZXJuID0gLzpbMC05XSokLywKICAKICAgICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgcmVzZXJ2ZWQgZm9yIGRlbGltaXRpbmcgVVJMcy4KICAgICAgLy8gV2UgYWN0dWFsbHkganVzdCBhdXRvLWVzY2FwZSB0aGVzZS4KICAgICAgZGVsaW1zID0gWyc8JywgJz4nLCAnIicsICdgJywgJyAnLCAnXHInLCAnXG4nLCAnXHQnXSwKICAKICAgICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgbm90IGFsbG93ZWQgZm9yIHZhcmlvdXMgcmVhc29ucy4KICAgICAgdW53aXNlID0gWyd7JywgJ30nLCAnfCcsICdcXCcsICdeJywgJ2AnXS5jb25jYXQoZGVsaW1zKSwKICAKICAgICAgLy8gQWxsb3dlZCBieSBSRkNzLCBidXQgY2F1c2Ugb2YgWFNTIGF0dGFja3MuICBBbHdheXMgZXNjYXBlIHRoZXNlLgogICAgICBhdXRvRXNjYXBlID0gWydcJyddLmNvbmNhdCh1bndpc2UpLAogICAgICAvLyBDaGFyYWN0ZXJzIHRoYXQgYXJlIG5ldmVyIGV2ZXIgYWxsb3dlZCBpbiBhIGhvc3RuYW1lLgogICAgICAvLyBOb3RlIHRoYXQgYW55IGludmFsaWQgY2hhcnMgYXJlIGFsc28gaGFuZGxlZCwgYnV0IHRoZXNlCiAgICAgIC8vIGFyZSB0aGUgb25lcyB0aGF0IGFyZSAqZXhwZWN0ZWQqIHRvIGJlIHNlZW4sIHNvIHdlIGZhc3QtcGF0aAogICAgICAvLyB0aGVtLgogICAgICBub25Ib3N0Q2hhcnMgPSBbJyUnLCAnLycsICc/JywgJzsnLCAnIyddLmNvbmNhdChhdXRvRXNjYXBlKSwKICAgICAgaG9zdEVuZGluZ0NoYXJzID0gWycvJywgJz8nLCAnIyddLAogICAgICBob3N0bmFtZU1heExlbiA9IDI1NSwKICAgICAgaG9zdG5hbWVQYXJ0UGF0dGVybiA9IC9eW2EtejAtOUEtWl8tXXswLDYzfSQvLAogICAgICBob3N0bmFtZVBhcnRTdGFydCA9IC9eKFthLXowLTlBLVpfLV17MCw2M30pKC4qKSQvLAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBjYW4gYWxsb3cgInVuc2FmZSIgYW5kICJ1bndpc2UiIGNoYXJzLgogICAgICB1bnNhZmVQcm90b2NvbCA9IHsKICAgICAgICAnamF2YXNjcmlwdCc6IHRydWUsCiAgICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgICB9LAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBuZXZlciBoYXZlIGEgaG9zdG5hbWUuCiAgICAgIGhvc3RsZXNzUHJvdG9jb2wgPSB7CiAgICAgICAgJ2phdmFzY3JpcHQnOiB0cnVlLAogICAgICAgICdqYXZhc2NyaXB0Oic6IHRydWUKICAgICAgfSwKICAgICAgLy8gcHJvdG9jb2xzIHRoYXQgYWx3YXlzIGNvbnRhaW4gYSAvLyBiaXQuCiAgICAgIHNsYXNoZWRQcm90b2NvbCA9IHsKICAgICAgICAnaHR0cCc6IHRydWUsCiAgICAgICAgJ2h0dHBzJzogdHJ1ZSwKICAgICAgICAnZnRwJzogdHJ1ZSwKICAgICAgICAnZ29waGVyJzogdHJ1ZSwKICAgICAgICAnZmlsZSc6IHRydWUsCiAgICAgICAgJ2h0dHA6JzogdHJ1ZSwKICAgICAgICAnaHR0cHM6JzogdHJ1ZSwKICAgICAgICAnZnRwOic6IHRydWUsCiAgICAgICAgJ2dvcGhlcjonOiB0cnVlLAogICAgICAgICdmaWxlOic6IHRydWUKICAgICAgfSwKICAgICAgcXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZycpOwogIAogIGZ1bmN0aW9uIHVybFBhcnNlKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpIHsKICAgIGlmICh1cmwgJiYgaXNPYmplY3QodXJsKSAmJiB1cmwgaW5zdGFuY2VvZiBVcmwpIHJldHVybiB1cmw7CiAgCiAgICB2YXIgdSA9IG5ldyBVcmw7CiAgICB1LnBhcnNlKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpOwogICAgcmV0dXJuIHU7CiAgfQogIAogIFVybC5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgICBpZiAoIWlzU3RyaW5nKHVybCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiUGFyYW1ldGVyICd1cmwnIG11c3QgYmUgYSBzdHJpbmcsIG5vdCAiICsgdHlwZW9mIHVybCk7CiAgICB9CiAgCiAgICB2YXIgcmVzdCA9IHVybDsKICAKICAgIC8vIHRyaW0gYmVmb3JlIHByb2NlZWRpbmcuCiAgICAvLyBUaGlzIGlzIHRvIHN1cHBvcnQgcGFyc2Ugc3R1ZmYgbGlrZSAiICBodHRwOi8vZm9vLmNvbSAgXG4iCiAgICByZXN0ID0gcmVzdC50cmltKCk7CiAgCiAgICB2YXIgcHJvdG8gPSBwcm90b2NvbFBhdHRlcm4uZXhlYyhyZXN0KTsKICAgIGlmIChwcm90bykgewogICAgICBwcm90byA9IHByb3RvWzBdOwogICAgICB2YXIgbG93ZXJQcm90byA9IHByb3RvLnRvTG93ZXJDYXNlKCk7CiAgICAgIHRoaXMucHJvdG9jb2wgPSBsb3dlclByb3RvOwogICAgICByZXN0ID0gcmVzdC5zdWJzdHIocHJvdG8ubGVuZ3RoKTsKICAgIH0KICAKICAgIC8vIGZpZ3VyZSBvdXQgaWYgaXQncyBnb3QgYSBob3N0CiAgICAvLyB1c2VyQHNlcnZlciBpcyAqYWx3YXlzKiBpbnRlcnByZXRlZCBhcyBhIGhvc3RuYW1lLCBhbmQgdXJsCiAgICAvLyByZXNvbHV0aW9uIHdpbGwgdHJlYXQgLy9mb28vYmFyIGFzIGhvc3Q9Zm9vLHBhdGg9YmFyIGJlY2F1c2UgdGhhdCdzCiAgICAvLyBob3cgdGhlIGJyb3dzZXIgcmVzb2x2ZXMgcmVsYXRpdmUgVVJMcy4KICAgIGlmIChzbGFzaGVzRGVub3RlSG9zdCB8fCBwcm90byB8fCByZXN0Lm1hdGNoKC9eXC9cL1teQFwvXStAW15AXC9dKy8pKSB7CiAgICAgIHZhciBzbGFzaGVzID0gcmVzdC5zdWJzdHIoMCwgMikgPT09ICcvLyc7CiAgICAgIGlmIChzbGFzaGVzICYmICEocHJvdG8gJiYgaG9zdGxlc3NQcm90b2NvbFtwcm90b10pKSB7CiAgICAgICAgcmVzdCA9IHJlc3Quc3Vic3RyKDIpOwogICAgICAgIHRoaXMuc2xhc2hlcyA9IHRydWU7CiAgICAgIH0KICAgIH0KICAKICAgIGlmICghaG9zdGxlc3NQcm90b2NvbFtwcm90b10gJiYKICAgICAgICAoc2xhc2hlcyB8fCAocHJvdG8gJiYgIXNsYXNoZWRQcm90b2NvbFtwcm90b10pKSkgewogIAogICAgICAvLyB0aGVyZSdzIGEgaG9zdG5hbWUuCiAgICAgIC8vIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiAvLCA/LCA7LCBvciAjIGVuZHMgdGhlIGhvc3QuCiAgICAgIC8vCiAgICAgIC8vIElmIHRoZXJlIGlzIGFuIEAgaW4gdGhlIGhvc3RuYW1lLCB0aGVuIG5vbi1ob3N0IGNoYXJzICphcmUqIGFsbG93ZWQKICAgICAgLy8gdG8gdGhlIGxlZnQgb2YgdGhlIGxhc3QgQCBzaWduLCB1bmxlc3Mgc29tZSBob3N0LWVuZGluZyBjaGFyYWN0ZXIKICAgICAgLy8gY29tZXMgKmJlZm9yZSogdGhlIEAtc2lnbi4KICAgICAgLy8gVVJMcyBhcmUgb2Jub3hpb3VzLgogICAgICAvLwogICAgICAvLyBleDoKICAgICAgLy8gaHR0cDovL2FAYkBjLyA9PiB1c2VyOmFAYiBob3N0OmMKICAgICAgLy8gaHR0cDovL2FAYj9AYyA9PiB1c2VyOmEgaG9zdDpjIHBhdGg6Lz9AYwogIAogICAgICAvLyB2MC4xMiBUT0RPKGlzYWFjcyk6IFRoaXMgaXMgbm90IHF1aXRlIGhvdyBDaHJvbWUgZG9lcyB0aGluZ3MuCiAgICAgIC8vIFJldmlldyBvdXIgdGVzdCBjYXNlIGFnYWluc3QgYnJvd3NlcnMgbW9yZSBjb21wcmVoZW5zaXZlbHkuCiAgCiAgICAgIC8vIGZpbmQgdGhlIGZpcnN0IGluc3RhbmNlIG9mIGFueSBob3N0RW5kaW5nQ2hhcnMKICAgICAgdmFyIGhvc3RFbmQgPSAtMTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob3N0RW5kaW5nQ2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaGVjID0gcmVzdC5pbmRleE9mKGhvc3RFbmRpbmdDaGFyc1tpXSk7CiAgICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgICAgfQogIAogICAgICAvLyBhdCB0aGlzIHBvaW50LCBlaXRoZXIgd2UgaGF2ZSBhbiBleHBsaWNpdCBwb2ludCB3aGVyZSB0aGUKICAgICAgLy8gYXV0aCBwb3J0aW9uIGNhbm5vdCBnbyBwYXN0LCBvciB0aGUgbGFzdCBAIGNoYXIgaXMgdGhlIGRlY2lkZXIuCiAgICAgIHZhciBhdXRoLCBhdFNpZ247CiAgICAgIGlmIChob3N0RW5kID09PSAtMSkgewogICAgICAgIC8vIGF0U2lnbiBjYW4gYmUgYW55d2hlcmUuCiAgICAgICAgYXRTaWduID0gcmVzdC5sYXN0SW5kZXhPZignQCcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGF0U2lnbiBtdXN0IGJlIGluIGF1dGggcG9ydGlvbi4KICAgICAgICAvLyBodHRwOi8vYUBiL2NAZCA9PiBob3N0OmIgYXV0aDphIHBhdGg6L2NAZAogICAgICAgIGF0U2lnbiA9IHJlc3QubGFzdEluZGV4T2YoJ0AnLCBob3N0RW5kKTsKICAgICAgfQogIAogICAgICAvLyBOb3cgd2UgaGF2ZSBhIHBvcnRpb24gd2hpY2ggaXMgZGVmaW5pdGVseSB0aGUgYXV0aC4KICAgICAgLy8gUHVsbCB0aGF0IG9mZi4KICAgICAgaWYgKGF0U2lnbiAhPT0gLTEpIHsKICAgICAgICBhdXRoID0gcmVzdC5zbGljZSgwLCBhdFNpZ24pOwogICAgICAgIHJlc3QgPSByZXN0LnNsaWNlKGF0U2lnbiArIDEpOwogICAgICAgIHRoaXMuYXV0aCA9IGRlY29kZVVSSUNvbXBvbmVudChhdXRoKTsKICAgICAgfQogIAogICAgICAvLyB0aGUgaG9zdCBpcyB0aGUgcmVtYWluaW5nIHRvIHRoZSBsZWZ0IG9mIHRoZSBmaXJzdCBub24taG9zdCBjaGFyCiAgICAgIGhvc3RFbmQgPSAtMTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub25Ib3N0Q2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaGVjID0gcmVzdC5pbmRleE9mKG5vbkhvc3RDaGFyc1tpXSk7CiAgICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgICAgfQogICAgICAvLyBpZiB3ZSBzdGlsbCBoYXZlIG5vdCBoaXQgaXQsIHRoZW4gdGhlIGVudGlyZSB0aGluZyBpcyBhIGhvc3QuCiAgICAgIGlmIChob3N0RW5kID09PSAtMSkKICAgICAgICBob3N0RW5kID0gcmVzdC5sZW5ndGg7CiAgCiAgICAgIHRoaXMuaG9zdCA9IHJlc3Quc2xpY2UoMCwgaG9zdEVuZCk7CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKGhvc3RFbmQpOwogIAogICAgICAvLyBwdWxsIG91dCBwb3J0LgogICAgICB0aGlzLnBhcnNlSG9zdCgpOwogIAogICAgICAvLyB3ZSd2ZSBpbmRpY2F0ZWQgdGhhdCB0aGVyZSBpcyBhIGhvc3RuYW1lLAogICAgICAvLyBzbyBldmVuIGlmIGl0J3MgZW1wdHksIGl0IGhhcyB0byBiZSBwcmVzZW50LgogICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKICAKICAgICAgLy8gaWYgaG9zdG5hbWUgYmVnaW5zIHdpdGggWyBhbmQgZW5kcyB3aXRoIF0KICAgICAgLy8gYXNzdW1lIHRoYXQgaXQncyBhbiBJUHY2IGFkZHJlc3MuCiAgICAgIHZhciBpcHY2SG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lWzBdID09PSAnWycgJiYKICAgICAgICAgIHRoaXMuaG9zdG5hbWVbdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAxXSA9PT0gJ10nOwogIAogICAgICAvLyB2YWxpZGF0ZSBhIGxpdHRsZS4KICAgICAgaWYgKCFpcHY2SG9zdG5hbWUpIHsKICAgICAgICB2YXIgaG9zdHBhcnRzID0gdGhpcy5ob3N0bmFtZS5zcGxpdCgvXC4vKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGhvc3RwYXJ0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZhciBwYXJ0ID0gaG9zdHBhcnRzW2ldOwogICAgICAgICAgaWYgKCFwYXJ0KSBjb250aW51ZTsKICAgICAgICAgIGlmICghcGFydC5tYXRjaChob3N0bmFtZVBhcnRQYXR0ZXJuKSkgewogICAgICAgICAgICB2YXIgbmV3cGFydCA9ICcnOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgayA9IHBhcnQubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKHBhcnQuY2hhckNvZGVBdChqKSA+IDEyNykgewogICAgICAgICAgICAgICAgLy8gd2UgcmVwbGFjZSBub24tQVNDSUkgY2hhciB3aXRoIGEgdGVtcG9yYXJ5IHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRoaXMgdG8gbWFrZSBzdXJlIHNpemUgb2YgaG9zdG5hbWUgaXMgbm90CiAgICAgICAgICAgICAgICAvLyBicm9rZW4gYnkgcmVwbGFjaW5nIG5vbi1BU0NJSSBieSBub3RoaW5nCiAgICAgICAgICAgICAgICBuZXdwYXJ0ICs9ICd4JzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3cGFydCArPSBwYXJ0W2pdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB3ZSB0ZXN0IGFnYWluIHdpdGggQVNDSUkgY2hhciBvbmx5CiAgICAgICAgICAgIGlmICghbmV3cGFydC5tYXRjaChob3N0bmFtZVBhcnRQYXR0ZXJuKSkgewogICAgICAgICAgICAgIHZhciB2YWxpZFBhcnRzID0gaG9zdHBhcnRzLnNsaWNlKDAsIGkpOwogICAgICAgICAgICAgIHZhciBub3RIb3N0ID0gaG9zdHBhcnRzLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICB2YXIgYml0ID0gcGFydC5tYXRjaChob3N0bmFtZVBhcnRTdGFydCk7CiAgICAgICAgICAgICAgaWYgKGJpdCkgewogICAgICAgICAgICAgICAgdmFsaWRQYXJ0cy5wdXNoKGJpdFsxXSk7CiAgICAgICAgICAgICAgICBub3RIb3N0LnVuc2hpZnQoYml0WzJdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vdEhvc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXN0ID0gJy8nICsgbm90SG9zdC5qb2luKCcuJykgKyByZXN0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmhvc3RuYW1lID0gdmFsaWRQYXJ0cy5qb2luKCcuJyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMuaG9zdG5hbWUubGVuZ3RoID4gaG9zdG5hbWVNYXhMZW4pIHsKICAgICAgICB0aGlzLmhvc3RuYW1lID0gJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaG9zdG5hbWVzIGFyZSBhbHdheXMgbG93ZXIgY2FzZS4KICAgICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICB9CiAgCiAgICAgIGlmICghaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgLy8gSUROQSBTdXBwb3J0OiBSZXR1cm5zIGEgcHVueSBjb2RlZCByZXByZXNlbnRhdGlvbiBvZiAiZG9tYWluIi4KICAgICAgICAvLyBJdCBvbmx5IGNvbnZlcnRzIHRoZSBwYXJ0IG9mIHRoZSBkb21haW4gbmFtZSB0aGF0CiAgICAgICAgLy8gaGFzIG5vbiBBU0NJSSBjaGFyYWN0ZXJzLiBJLmUuIGl0IGRvc2VudCBtYXR0ZXIgaWYKICAgICAgICAvLyB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQgYWxyZWFkeSBpcyBpbiBBU0NJSS4KICAgICAgICB2YXIgZG9tYWluQXJyYXkgPSB0aGlzLmhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgdmFyIG5ld091dCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZG9tYWluQXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciBzID0gZG9tYWluQXJyYXlbaV07CiAgICAgICAgICBuZXdPdXQucHVzaChzLm1hdGNoKC9bXkEtWmEtejAtOV8tXS8pID8KICAgICAgICAgICAgICAneG4tLScgKyBwdW55Y29kZS5lbmNvZGUocykgOiBzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IG5ld091dC5qb2luKCcuJyk7CiAgICAgIH0KICAKICAgICAgdmFyIHAgPSB0aGlzLnBvcnQgPyAnOicgKyB0aGlzLnBvcnQgOiAnJzsKICAgICAgdmFyIGggPSB0aGlzLmhvc3RuYW1lIHx8ICcnOwogICAgICB0aGlzLmhvc3QgPSBoICsgcDsKICAgICAgdGhpcy5ocmVmICs9IHRoaXMuaG9zdDsKICAKICAgICAgLy8gc3RyaXAgWyBhbmQgXSBmcm9tIHRoZSBob3N0bmFtZQogICAgICAvLyB0aGUgaG9zdCBmaWVsZCBzdGlsbCByZXRhaW5zIHRoZW0sIHRob3VnaAogICAgICBpZiAoaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUuc3Vic3RyKDEsIHRoaXMuaG9zdG5hbWUubGVuZ3RoIC0gMik7CiAgICAgICAgaWYgKHJlc3RbMF0gIT09ICcvJykgewogICAgICAgICAgcmVzdCA9ICcvJyArIHJlc3Q7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICAvLyBub3cgcmVzdCBpcyBzZXQgdG8gdGhlIHBvc3QtaG9zdCBzdHVmZi4KICAgIC8vIGNob3Agb2ZmIGFueSBkZWxpbSBjaGFycy4KICAgIGlmICghdW5zYWZlUHJvdG9jb2xbbG93ZXJQcm90b10pIHsKICAKICAgICAgLy8gRmlyc3QsIG1ha2UgMTAwJSBzdXJlIHRoYXQgYW55ICJhdXRvRXNjYXBlIiBjaGFycyBnZXQKICAgICAgLy8gZXNjYXBlZCwgZXZlbiBpZiBlbmNvZGVVUklDb21wb25lbnQgZG9lc24ndCB0aGluayB0aGV5CiAgICAgIC8vIG5lZWQgdG8gYmUuCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXV0b0VzY2FwZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgYWUgPSBhdXRvRXNjYXBlW2ldOwogICAgICAgIHZhciBlc2MgPSBlbmNvZGVVUklDb21wb25lbnQoYWUpOwogICAgICAgIGlmIChlc2MgPT09IGFlKSB7CiAgICAgICAgICBlc2MgPSBlc2NhcGUoYWUpOwogICAgICAgIH0KICAgICAgICByZXN0ID0gcmVzdC5zcGxpdChhZSkuam9pbihlc2MpOwogICAgICB9CiAgICB9CiAgCiAgCiAgICAvLyBjaG9wIG9mZiBmcm9tIHRoZSB0YWlsIGZpcnN0LgogICAgdmFyIGhhc2ggPSByZXN0LmluZGV4T2YoJyMnKTsKICAgIGlmIChoYXNoICE9PSAtMSkgewogICAgICAvLyBnb3QgYSBmcmFnbWVudCBzdHJpbmcuCiAgICAgIHRoaXMuaGFzaCA9IHJlc3Quc3Vic3RyKGhhc2gpOwogICAgICByZXN0ID0gcmVzdC5zbGljZSgwLCBoYXNoKTsKICAgIH0KICAgIHZhciBxbSA9IHJlc3QuaW5kZXhPZignPycpOwogICAgaWYgKHFtICE9PSAtMSkgewogICAgICB0aGlzLnNlYXJjaCA9IHJlc3Quc3Vic3RyKHFtKTsKICAgICAgdGhpcy5xdWVyeSA9IHJlc3Quc3Vic3RyKHFtICsgMSk7CiAgICAgIGlmIChwYXJzZVF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHRoaXMucXVlcnkpOwogICAgICB9CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIHFtKTsKICAgIH0gZWxzZSBpZiAocGFyc2VRdWVyeVN0cmluZykgewogICAgICAvLyBubyBxdWVyeSBzdHJpbmcsIGJ1dCBwYXJzZVF1ZXJ5U3RyaW5nIHN0aWxsIHJlcXVlc3RlZAogICAgICB0aGlzLnNlYXJjaCA9ICcnOwogICAgICB0aGlzLnF1ZXJ5ID0ge307CiAgICB9CiAgICBpZiAocmVzdCkgdGhpcy5wYXRobmFtZSA9IHJlc3Q7CiAgICBpZiAoc2xhc2hlZFByb3RvY29sW2xvd2VyUHJvdG9dICYmCiAgICAgICAgdGhpcy5ob3N0bmFtZSAmJiAhdGhpcy5wYXRobmFtZSkgewogICAgICB0aGlzLnBhdGhuYW1lID0gJy8nOwogICAgfQogIAogICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgaWYgKHRoaXMucGF0aG5hbWUgfHwgdGhpcy5zZWFyY2gpIHsKICAgICAgdmFyIHAgPSB0aGlzLnBhdGhuYW1lIHx8ICcnOwogICAgICB2YXIgcyA9IHRoaXMuc2VhcmNoIHx8ICcnOwogICAgICB0aGlzLnBhdGggPSBwICsgczsKICAgIH0KICAKICAgIC8vIGZpbmFsbHksIHJlY29uc3RydWN0IHRoZSBocmVmIGJhc2VkIG9uIHdoYXQgaGFzIGJlZW4gdmFsaWRhdGVkLgogICAgdGhpcy5ocmVmID0gdGhpcy5mb3JtYXQoKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgLy8gZm9ybWF0IGEgcGFyc2VkIG9iamVjdCBpbnRvIGEgdXJsIHN0cmluZwogIGZ1bmN0aW9uIHVybEZvcm1hdChvYmopIHsKICAgIC8vIGVuc3VyZSBpdCdzIGFuIG9iamVjdCwgYW5kIG5vdCBhIHN0cmluZyB1cmwuCiAgICAvLyBJZiBpdCdzIGFuIG9iaiwgdGhpcyBpcyBhIG5vLW9wLgogICAgLy8gdGhpcyB3YXksIHlvdSBjYW4gY2FsbCB1cmxfZm9ybWF0KCkgb24gc3RyaW5ncwogICAgLy8gdG8gY2xlYW4gdXAgcG90ZW50aWFsbHkgd29ua3kgdXJscy4KICAgIGlmIChpc1N0cmluZyhvYmopKSBvYmogPSB1cmxQYXJzZShvYmopOwogICAgaWYgKCEob2JqIGluc3RhbmNlb2YgVXJsKSkgcmV0dXJuIFVybC5wcm90b3R5cGUuZm9ybWF0LmNhbGwob2JqKTsKICAgIHJldHVybiBvYmouZm9ybWF0KCk7CiAgfQogIAogIFVybC5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXV0aCA9IHRoaXMuYXV0aCB8fCAnJzsKICAgIGlmIChhdXRoKSB7CiAgICAgIGF1dGggPSBlbmNvZGVVUklDb21wb25lbnQoYXV0aCk7CiAgICAgIGF1dGggPSBhdXRoLnJlcGxhY2UoLyUzQS9pLCAnOicpOwogICAgICBhdXRoICs9ICdAJzsKICAgIH0KICAKICAgIHZhciBwcm90b2NvbCA9IHRoaXMucHJvdG9jb2wgfHwgJycsCiAgICAgICAgcGF0aG5hbWUgPSB0aGlzLnBhdGhuYW1lIHx8ICcnLAogICAgICAgIGhhc2ggPSB0aGlzLmhhc2ggfHwgJycsCiAgICAgICAgaG9zdCA9IGZhbHNlLAogICAgICAgIHF1ZXJ5ID0gJyc7CiAgCiAgICBpZiAodGhpcy5ob3N0KSB7CiAgICAgIGhvc3QgPSBhdXRoICsgdGhpcy5ob3N0OwogICAgfSBlbHNlIGlmICh0aGlzLmhvc3RuYW1lKSB7CiAgICAgIGhvc3QgPSBhdXRoICsgKHRoaXMuaG9zdG5hbWUuaW5kZXhPZignOicpID09PSAtMSA/CiAgICAgICAgICB0aGlzLmhvc3RuYW1lIDoKICAgICAgICAgICdbJyArIHRoaXMuaG9zdG5hbWUgKyAnXScpOwogICAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgICAgaG9zdCArPSAnOicgKyB0aGlzLnBvcnQ7CiAgICAgIH0KICAgIH0KICAKICAgIGlmICh0aGlzLnF1ZXJ5ICYmCiAgICAgICAgaXNPYmplY3QodGhpcy5xdWVyeSkgJiYKICAgICAgICBPYmplY3Qua2V5cyh0aGlzLnF1ZXJ5KS5sZW5ndGgpIHsKICAgICAgcXVlcnkgPSBxdWVyeXN0cmluZy5zdHJpbmdpZnkodGhpcy5xdWVyeSk7CiAgICB9CiAgCiAgICB2YXIgc2VhcmNoID0gdGhpcy5zZWFyY2ggfHwgKHF1ZXJ5ICYmICgnPycgKyBxdWVyeSkpIHx8ICcnOwogIAogICAgaWYgKHByb3RvY29sICYmIHByb3RvY29sLnN1YnN0cigtMSkgIT09ICc6JykgcHJvdG9jb2wgKz0gJzonOwogIAogICAgLy8gb25seSB0aGUgc2xhc2hlZFByb3RvY29scyBnZXQgdGhlIC8vLiAgTm90IG1haWx0bzosIHhtcHA6LCBldGMuCiAgICAvLyB1bmxlc3MgdGhleSBoYWQgdGhlbSB0byBiZWdpbiB3aXRoLgogICAgaWYgKHRoaXMuc2xhc2hlcyB8fAogICAgICAgICghcHJvdG9jb2wgfHwgc2xhc2hlZFByb3RvY29sW3Byb3RvY29sXSkgJiYgaG9zdCAhPT0gZmFsc2UpIHsKICAgICAgaG9zdCA9ICcvLycgKyAoaG9zdCB8fCAnJyk7CiAgICAgIGlmIChwYXRobmFtZSAmJiBwYXRobmFtZS5jaGFyQXQoMCkgIT09ICcvJykgcGF0aG5hbWUgPSAnLycgKyBwYXRobmFtZTsKICAgIH0gZWxzZSBpZiAoIWhvc3QpIHsKICAgICAgaG9zdCA9ICcnOwogICAgfQogIAogICAgaWYgKGhhc2ggJiYgaGFzaC5jaGFyQXQoMCkgIT09ICcjJykgaGFzaCA9ICcjJyArIGhhc2g7CiAgICBpZiAoc2VhcmNoICYmIHNlYXJjaC5jaGFyQXQoMCkgIT09ICc/Jykgc2VhcmNoID0gJz8nICsgc2VhcmNoOwogIAogICAgcGF0aG5hbWUgPSBwYXRobmFtZS5yZXBsYWNlKC9bPyNdL2csIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQobWF0Y2gpOwogICAgfSk7CiAgICBzZWFyY2ggPSBzZWFyY2gucmVwbGFjZSgnIycsICclMjMnKTsKICAKICAgIHJldHVybiBwcm90b2NvbCArIGhvc3QgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CiAgfTsKICAKICBmdW5jdGlvbiB1cmxSZXNvbHZlKHNvdXJjZSwgcmVsYXRpdmUpIHsKICAgIHJldHVybiB1cmxQYXJzZShzb3VyY2UsIGZhbHNlLCB0cnVlKS5yZXNvbHZlKHJlbGF0aXZlKTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24ocmVsYXRpdmUpIHsKICAgIHJldHVybiB0aGlzLnJlc29sdmVPYmplY3QodXJsUGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKSkuZm9ybWF0KCk7CiAgfTsKICAKICBmdW5jdGlvbiB1cmxSZXNvbHZlT2JqZWN0KHNvdXJjZSwgcmVsYXRpdmUpIHsKICAgIGlmICghc291cmNlKSByZXR1cm4gcmVsYXRpdmU7CiAgICByZXR1cm4gdXJsUGFyc2Uoc291cmNlLCBmYWxzZSwgdHJ1ZSkucmVzb2x2ZU9iamVjdChyZWxhdGl2ZSk7CiAgfQogIAogIFVybC5wcm90b3R5cGUucmVzb2x2ZU9iamVjdCA9IGZ1bmN0aW9uKHJlbGF0aXZlKSB7CiAgICBpZiAoaXNTdHJpbmcocmVsYXRpdmUpKSB7CiAgICAgIHZhciByZWwgPSBuZXcgVXJsKCk7CiAgICAgIHJlbC5wYXJzZShyZWxhdGl2ZSwgZmFsc2UsIHRydWUpOwogICAgICByZWxhdGl2ZSA9IHJlbDsKICAgIH0KICAKICAgIHZhciByZXN1bHQgPSBuZXcgVXJsKCk7CiAgICBPYmplY3Qua2V5cyh0aGlzKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgcmVzdWx0W2tdID0gdGhpc1trXTsKICAgIH0sIHRoaXMpOwogIAogICAgLy8gaGFzaCBpcyBhbHdheXMgb3ZlcnJpZGRlbiwgbm8gbWF0dGVyIHdoYXQuCiAgICAvLyBldmVuIGhyZWY9IiIgd2lsbCByZW1vdmUgaXQuCiAgICByZXN1bHQuaGFzaCA9IHJlbGF0aXZlLmhhc2g7CiAgCiAgICAvLyBpZiB0aGUgcmVsYXRpdmUgdXJsIGlzIGVtcHR5LCB0aGVuIHRoZXJlJ3Mgbm90aGluZyBsZWZ0IHRvIGRvIGhlcmUuCiAgICBpZiAocmVsYXRpdmUuaHJlZiA9PT0gJycpIHsKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICAvLyBocmVmcyBsaWtlIC8vZm9vL2JhciBhbHdheXMgY3V0IHRvIHRoZSBwcm90b2NvbC4KICAgIGlmIChyZWxhdGl2ZS5zbGFzaGVzICYmICFyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgICAvLyB0YWtlIGV2ZXJ5dGhpbmcgZXhjZXB0IHRoZSBwcm90b2NvbCBmcm9tIHJlbGF0aXZlCiAgICAgIE9iamVjdC5rZXlzKHJlbGF0aXZlKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgICBpZiAoayAhPT0gJ3Byb3RvY29sJykKICAgICAgICAgIHJlc3VsdFtrXSA9IHJlbGF0aXZlW2tdOwogICAgICB9KTsKICAKICAgICAgLy91cmxQYXJzZSBhcHBlbmRzIHRyYWlsaW5nIC8gdG8gdXJscyBsaWtlIGh0dHA6Ly93d3cuZXhhbXBsZS5jb20KICAgICAgaWYgKHNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdICYmCiAgICAgICAgICByZXN1bHQuaG9zdG5hbWUgJiYgIXJlc3VsdC5wYXRobmFtZSkgewogICAgICAgIHJlc3VsdC5wYXRoID0gcmVzdWx0LnBhdGhuYW1lID0gJy8nOwogICAgICB9CiAgCiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgaWYgKHJlbGF0aXZlLnByb3RvY29sICYmIHJlbGF0aXZlLnByb3RvY29sICE9PSByZXN1bHQucHJvdG9jb2wpIHsKICAgICAgLy8gaWYgaXQncyBhIGtub3duIHVybCBwcm90b2NvbCwgdGhlbiBjaGFuZ2luZwogICAgICAvLyB0aGUgcHJvdG9jb2wgZG9lcyB3ZWlyZCB0aGluZ3MKICAgICAgLy8gZmlyc3QsIGlmIGl0J3Mgbm90IGZpbGU6LCB0aGVuIHdlIE1VU1QgaGF2ZSBhIGhvc3QsCiAgICAgIC8vIGFuZCBpZiB0aGVyZSB3YXMgYSBwYXRoCiAgICAgIC8vIHRvIGJlZ2luIHdpdGgsIHRoZW4gd2UgTVVTVCBoYXZlIGEgcGF0aC4KICAgICAgLy8gaWYgaXQgaXMgZmlsZTosIHRoZW4gdGhlIGhvc3QgaXMgZHJvcHBlZCwKICAgICAgLy8gYmVjYXVzZSB0aGF0J3Mga25vd24gdG8gYmUgaG9zdGxlc3MuCiAgICAgIC8vIGFueXRoaW5nIGVsc2UgaXMgYXNzdW1lZCB0byBiZSBhYnNvbHV0ZS4KICAgICAgaWYgKCFzbGFzaGVkUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgICAgcmVzdWx0W2tdID0gcmVsYXRpdmVba107CiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogIAogICAgICByZXN1bHQucHJvdG9jb2wgPSByZWxhdGl2ZS5wcm90b2NvbDsKICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0ICYmICFob3N0bGVzc1Byb3RvY29sW3JlbGF0aXZlLnByb3RvY29sXSkgewogICAgICAgIHZhciByZWxQYXRoID0gKHJlbGF0aXZlLnBhdGhuYW1lIHx8ICcnKS5zcGxpdCgnLycpOwogICAgICAgIHdoaWxlIChyZWxQYXRoLmxlbmd0aCAmJiAhKHJlbGF0aXZlLmhvc3QgPSByZWxQYXRoLnNoaWZ0KCkpKTsKICAgICAgICBpZiAoIXJlbGF0aXZlLmhvc3QpIHJlbGF0aXZlLmhvc3QgPSAnJzsKICAgICAgICBpZiAoIXJlbGF0aXZlLmhvc3RuYW1lKSByZWxhdGl2ZS5ob3N0bmFtZSA9ICcnOwogICAgICAgIGlmIChyZWxQYXRoWzBdICE9PSAnJykgcmVsUGF0aC51bnNoaWZ0KCcnKTsKICAgICAgICBpZiAocmVsUGF0aC5sZW5ndGggPCAyKSByZWxQYXRoLnVuc2hpZnQoJycpOwogICAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbFBhdGguam9pbignLycpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbGF0aXZlLnBhdGhuYW1lOwogICAgICB9CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgICByZXN1bHQuaG9zdCA9IHJlbGF0aXZlLmhvc3QgfHwgJyc7CiAgICAgIHJlc3VsdC5hdXRoID0gcmVsYXRpdmUuYXV0aDsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdDsKICAgICAgcmVzdWx0LnBvcnQgPSByZWxhdGl2ZS5wb3J0OwogICAgICAvLyB0byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgICBpZiAocmVzdWx0LnBhdGhuYW1lIHx8IHJlc3VsdC5zZWFyY2gpIHsKICAgICAgICB2YXIgcCA9IHJlc3VsdC5wYXRobmFtZSB8fCAnJzsKICAgICAgICB2YXIgcyA9IHJlc3VsdC5zZWFyY2ggfHwgJyc7CiAgICAgICAgcmVzdWx0LnBhdGggPSBwICsgczsKICAgICAgfQogICAgICByZXN1bHQuc2xhc2hlcyA9IHJlc3VsdC5zbGFzaGVzIHx8IHJlbGF0aXZlLnNsYXNoZXM7CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgdmFyIGlzU291cmNlQWJzID0gKHJlc3VsdC5wYXRobmFtZSAmJiByZXN1bHQucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycpLAogICAgICAgIGlzUmVsQWJzID0gKAogICAgICAgICAgICByZWxhdGl2ZS5ob3N0IHx8CiAgICAgICAgICAgIHJlbGF0aXZlLnBhdGhuYW1lICYmIHJlbGF0aXZlLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nCiAgICAgICAgKSwKICAgICAgICBtdXN0RW5kQWJzID0gKGlzUmVsQWJzIHx8IGlzU291cmNlQWJzIHx8CiAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0Lmhvc3QgJiYgcmVsYXRpdmUucGF0aG5hbWUpKSwKICAgICAgICByZW1vdmVBbGxEb3RzID0gbXVzdEVuZEFicywKICAgICAgICBzcmNQYXRoID0gcmVzdWx0LnBhdGhuYW1lICYmIHJlc3VsdC5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICAgIHJlbFBhdGggPSByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICAgIHBzeWNob3RpYyA9IHJlc3VsdC5wcm90b2NvbCAmJiAhc2xhc2hlZFByb3RvY29sW3Jlc3VsdC5wcm90b2NvbF07CiAgCiAgICAvLyBpZiB0aGUgdXJsIGlzIGEgbm9uLXNsYXNoZWQgdXJsLCB0aGVuIHJlbGF0aXZlCiAgICAvLyBsaW5rcyBsaWtlIC4uLy4uIHNob3VsZCBiZSBhYmxlCiAgICAvLyB0byBjcmF3bCB1cCB0byB0aGUgaG9zdG5hbWUsIGFzIHdlbGwuICBUaGlzIGlzIHN0cmFuZ2UuCiAgICAvLyByZXN1bHQucHJvdG9jb2wgaGFzIGFscmVhZHkgYmVlbiBzZXQgYnkgbm93LgogICAgLy8gTGF0ZXIgb24sIHB1dCB0aGUgZmlyc3QgcGF0aCBwYXJ0IGludG8gdGhlIGhvc3QgZmllbGQuCiAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9ICcnOwogICAgICByZXN1bHQucG9ydCA9IG51bGw7CiAgICAgIGlmIChyZXN1bHQuaG9zdCkgewogICAgICAgIGlmIChzcmNQYXRoWzBdID09PSAnJykgc3JjUGF0aFswXSA9IHJlc3VsdC5ob3N0OwogICAgICAgIGVsc2Ugc3JjUGF0aC51bnNoaWZ0KHJlc3VsdC5ob3N0KTsKICAgICAgfQogICAgICByZXN1bHQuaG9zdCA9ICcnOwogICAgICBpZiAocmVsYXRpdmUucHJvdG9jb2wpIHsKICAgICAgICByZWxhdGl2ZS5ob3N0bmFtZSA9IG51bGw7CiAgICAgICAgcmVsYXRpdmUucG9ydCA9IG51bGw7CiAgICAgICAgaWYgKHJlbGF0aXZlLmhvc3QpIHsKICAgICAgICAgIGlmIChyZWxQYXRoWzBdID09PSAnJykgcmVsUGF0aFswXSA9IHJlbGF0aXZlLmhvc3Q7CiAgICAgICAgICBlbHNlIHJlbFBhdGgudW5zaGlmdChyZWxhdGl2ZS5ob3N0KTsKICAgICAgICB9CiAgICAgICAgcmVsYXRpdmUuaG9zdCA9IG51bGw7CiAgICAgIH0KICAgICAgbXVzdEVuZEFicyA9IG11c3RFbmRBYnMgJiYgKHJlbFBhdGhbMF0gPT09ICcnIHx8IHNyY1BhdGhbMF0gPT09ICcnKTsKICAgIH0KICAKICAgIGlmIChpc1JlbEFicykgewogICAgICAvLyBpdCdzIGFic29sdXRlLgogICAgICByZXN1bHQuaG9zdCA9IChyZWxhdGl2ZS5ob3N0IHx8IHJlbGF0aXZlLmhvc3QgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmUuaG9zdCA6IHJlc3VsdC5ob3N0OwogICAgICByZXN1bHQuaG9zdG5hbWUgPSAocmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdG5hbWUgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3RuYW1lIDogcmVzdWx0Lmhvc3RuYW1lOwogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgICAgc3JjUGF0aCA9IHJlbFBhdGg7CiAgICAgIC8vIGZhbGwgdGhyb3VnaCB0byB0aGUgZG90LWhhbmRsaW5nIGJlbG93LgogICAgfSBlbHNlIGlmIChyZWxQYXRoLmxlbmd0aCkgewogICAgICAvLyBpdCdzIHJlbGF0aXZlCiAgICAgIC8vIHRocm93IGF3YXkgdGhlIGV4aXN0aW5nIGZpbGUsIGFuZCB0YWtlIHRoZSBuZXcgcGF0aCBpbnN0ZWFkLgogICAgICBpZiAoIXNyY1BhdGgpIHNyY1BhdGggPSBbXTsKICAgICAgc3JjUGF0aC5wb3AoKTsKICAgICAgc3JjUGF0aCA9IHNyY1BhdGguY29uY2F0KHJlbFBhdGgpOwogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgIH0gZWxzZSBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKHJlbGF0aXZlLnNlYXJjaCkpIHsKICAgICAgLy8ganVzdCBwdWxsIG91dCB0aGUgc2VhcmNoLgogICAgICAvLyBsaWtlIGhyZWY9Jz9mb28nLgogICAgICAvLyBQdXQgdGhpcyBhZnRlciB0aGUgb3RoZXIgdHdvIGNhc2VzIGJlY2F1c2UgaXQgc2ltcGxpZmllcyB0aGUgYm9vbGVhbnMKICAgICAgaWYgKHBzeWNob3RpYykgewogICAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gc3JjUGF0aC5zaGlmdCgpOwogICAgICAgIC8vb2NjYXRpb25hbHkgdGhlIGF1dGggY2FuIGdldCBzdHVjayBvbmx5IGluIGhvc3QKICAgICAgICAvL3RoaXMgZXNwZWNpYWx5IGhhcHBlbnMgaW4gY2FzZXMgbGlrZQogICAgICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICAgICAgdmFyIGF1dGhJbkhvc3QgPSByZXN1bHQuaG9zdCAmJiByZXN1bHQuaG9zdC5pbmRleE9mKCdAJykgPiAwID8KICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ob3N0LnNwbGl0KCdAJykgOiBmYWxzZTsKICAgICAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICAgICAgcmVzdWx0LmF1dGggPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgICByZXN1bHQuaG9zdCA9IHJlc3VsdC5ob3N0bmFtZSA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgICAgaWYgKCFpc051bGwocmVzdWx0LnBhdGhuYW1lKSB8fCAhaXNOdWxsKHJlc3VsdC5zZWFyY2gpKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgICAgIChyZXN1bHQuc2VhcmNoID8gcmVzdWx0LnNlYXJjaCA6ICcnKTsKICAgICAgfQogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIGlmICghc3JjUGF0aC5sZW5ndGgpIHsKICAgICAgLy8gbm8gcGF0aCBhdCBhbGwuICBlYXN5LgogICAgICAvLyB3ZSd2ZSBhbHJlYWR5IGhhbmRsZWQgdGhlIG90aGVyIHN0dWZmIGFib3ZlLgogICAgICByZXN1bHQucGF0aG5hbWUgPSBudWxsOwogICAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICAgIGlmIChyZXN1bHQuc2VhcmNoKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSAnLycgKyByZXN1bHQuc2VhcmNoOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wYXRoID0gbnVsbDsKICAgICAgfQogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIC8vIGlmIGEgdXJsIEVORHMgaW4gLiBvciAuLiwgdGhlbiBpdCBtdXN0IGdldCBhIHRyYWlsaW5nIHNsYXNoLgogICAgLy8gaG93ZXZlciwgaWYgaXQgZW5kcyBpbiBhbnl0aGluZyBlbHNlIG5vbi1zbGFzaHksCiAgICAvLyB0aGVuIGl0IG11c3QgTk9UIGdldCBhIHRyYWlsaW5nIHNsYXNoLgogICAgdmFyIGxhc3QgPSBzcmNQYXRoLnNsaWNlKC0xKVswXTsKICAgIHZhciBoYXNUcmFpbGluZ1NsYXNoID0gKAogICAgICAgIChyZXN1bHQuaG9zdCB8fCByZWxhdGl2ZS5ob3N0KSAmJiAobGFzdCA9PT0gJy4nIHx8IGxhc3QgPT09ICcuLicpIHx8CiAgICAgICAgbGFzdCA9PT0gJycpOwogIAogICAgLy8gc3RyaXAgc2luZ2xlIGRvdHMsIHJlc29sdmUgZG91YmxlIGRvdHMgdG8gcGFyZW50IGRpcgogICAgLy8gaWYgdGhlIHBhdGggdHJpZXMgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIGB1cGAgZW5kcyB1cCA+IDAKICAgIHZhciB1cCA9IDA7CiAgICBmb3IgKHZhciBpID0gc3JjUGF0aC5sZW5ndGg7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGxhc3QgPSBzcmNQYXRoW2ldOwogICAgICBpZiAobGFzdCA9PSAnLicpIHsKICAgICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgfSBlbHNlIGlmIChsYXN0ID09PSAnLi4nKSB7CiAgICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgICAgdXArKzsKICAgICAgfSBlbHNlIGlmICh1cCkgewogICAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICAgIHVwLS07CiAgICAgIH0KICAgIH0KICAKICAgIC8vIGlmIHRoZSBwYXRoIGlzIGFsbG93ZWQgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIHJlc3RvcmUgbGVhZGluZyAuLnMKICAgIGlmICghbXVzdEVuZEFicyAmJiAhcmVtb3ZlQWxsRG90cykgewogICAgICBmb3IgKDsgdXAtLTsgdXApIHsKICAgICAgICBzcmNQYXRoLnVuc2hpZnQoJy4uJyk7CiAgICAgIH0KICAgIH0KICAKICAgIGlmIChtdXN0RW5kQWJzICYmIHNyY1BhdGhbMF0gIT09ICcnICYmCiAgICAgICAgKCFzcmNQYXRoWzBdIHx8IHNyY1BhdGhbMF0uY2hhckF0KDApICE9PSAnLycpKSB7CiAgICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgICB9CiAgCiAgICBpZiAoaGFzVHJhaWxpbmdTbGFzaCAmJiAoc3JjUGF0aC5qb2luKCcvJykuc3Vic3RyKC0xKSAhPT0gJy8nKSkgewogICAgICBzcmNQYXRoLnB1c2goJycpOwogICAgfQogIAogICAgdmFyIGlzQWJzb2x1dGUgPSBzcmNQYXRoWzBdID09PSAnJyB8fAogICAgICAgIChzcmNQYXRoWzBdICYmIHNyY1BhdGhbMF0uY2hhckF0KDApID09PSAnLycpOwogIAogICAgLy8gcHV0IHRoZSBob3N0IGJhY2sKICAgIGlmIChwc3ljaG90aWMpIHsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVzdWx0Lmhvc3QgPSBpc0Fic29sdXRlID8gJycgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyY1BhdGgubGVuZ3RoID8gc3JjUGF0aC5zaGlmdCgpIDogJyc7CiAgICAgIC8vb2NjYXRpb25hbHkgdGhlIGF1dGggY2FuIGdldCBzdHVjayBvbmx5IGluIGhvc3QKICAgICAgLy90aGlzIGVzcGVjaWFseSBoYXBwZW5zIGluIGNhc2VzIGxpa2UKICAgICAgLy91cmwucmVzb2x2ZU9iamVjdCgnbWFpbHRvOmxvY2FsMUBkb21haW4xJywgJ2xvY2FsMkBkb21haW4yJykKICAgICAgdmFyIGF1dGhJbkhvc3QgPSByZXN1bHQuaG9zdCAmJiByZXN1bHQuaG9zdC5pbmRleE9mKCdAJykgPiAwID8KICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuaG9zdC5zcGxpdCgnQCcpIDogZmFsc2U7CiAgICAgIGlmIChhdXRoSW5Ib3N0KSB7CiAgICAgICAgcmVzdWx0LmF1dGggPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgcmVzdWx0Lmhvc3QgPSByZXN1bHQuaG9zdG5hbWUgPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgIH0KICAgIH0KICAKICAgIG11c3RFbmRBYnMgPSBtdXN0RW5kQWJzIHx8IChyZXN1bHQuaG9zdCAmJiBzcmNQYXRoLmxlbmd0aCk7CiAgCiAgICBpZiAobXVzdEVuZEFicyAmJiAhaXNBYnNvbHV0ZSkgewogICAgICBzcmNQYXRoLnVuc2hpZnQoJycpOwogICAgfQogIAogICAgaWYgKCFzcmNQYXRoLmxlbmd0aCkgewogICAgICByZXN1bHQucGF0aG5hbWUgPSBudWxsOwogICAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQucGF0aG5hbWUgPSBzcmNQYXRoLmpvaW4oJy8nKTsKICAgIH0KICAKICAgIC8vdG8gc3VwcG9ydCByZXF1ZXN0Lmh0dHAKICAgIGlmICghaXNOdWxsKHJlc3VsdC5wYXRobmFtZSkgfHwgIWlzTnVsbChyZXN1bHQuc2VhcmNoKSkgewogICAgICByZXN1bHQucGF0aCA9IChyZXN1bHQucGF0aG5hbWUgPyByZXN1bHQucGF0aG5hbWUgOiAnJykgKwogICAgICAgICAgICAgICAgICAgIChyZXN1bHQuc2VhcmNoID8gcmVzdWx0LnNlYXJjaCA6ICcnKTsKICAgIH0KICAgIHJlc3VsdC5hdXRoID0gcmVsYXRpdmUuYXV0aCB8fCByZXN1bHQuYXV0aDsKICAgIHJlc3VsdC5zbGFzaGVzID0gcmVzdWx0LnNsYXNoZXMgfHwgcmVsYXRpdmUuc2xhc2hlczsKICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIAogIFVybC5wcm90b3R5cGUucGFyc2VIb3N0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgaG9zdCA9IHRoaXMuaG9zdDsKICAgIHZhciBwb3J0ID0gcG9ydFBhdHRlcm4uZXhlYyhob3N0KTsKICAgIGlmIChwb3J0KSB7CiAgICAgIHBvcnQgPSBwb3J0WzBdOwogICAgICBpZiAocG9ydCAhPT0gJzonKSB7CiAgICAgICAgdGhpcy5wb3J0ID0gcG9ydC5zdWJzdHIoMSk7CiAgICAgIH0KICAgICAgaG9zdCA9IGhvc3Quc3Vic3RyKDAsIGhvc3QubGVuZ3RoIC0gcG9ydC5sZW5ndGgpOwogICAgfQogICAgaWYgKGhvc3QpIHRoaXMuaG9zdG5hbWUgPSBob3N0OwogIH07CiAgCiAgZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gInN0cmluZyI7CiAgfQogIAogIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKICB9CiAgCiAgZnVuY3Rpb24gaXNOdWxsKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKICB9CiAgZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gIGFyZyA9PSBudWxsOwogIH0KICAKICB9LHsicHVueWNvZGUiOjgwLCJxdWVyeXN0cmluZyI6ODl9XSw5NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgaWYgKHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAvLyBpbXBsZW1lbnRhdGlvbiBmcm9tIHN0YW5kYXJkIG5vZGUuanMgJ3V0aWwnIG1vZHVsZQogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgICAgY3Rvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ3Rvci5wcm90b3R5cGUsIHsKICAgICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgICAgdmFsdWU6IGN0b3IsCiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIG9sZCBzY2hvb2wgc2hpbSBmb3Igb2xkIGJyb3dzZXJzCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcgogICAgICB2YXIgVGVtcEN0b3IgPSBmdW5jdGlvbiAoKSB7fQogICAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlCiAgICAgIGN0b3IucHJvdG90eXBlID0gbmV3IFRlbXBDdG9yKCkKICAgICAgY3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yCiAgICB9CiAgfQogIAogIH0se31dLDk2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGlzQnVmZmVyKGFyZykgewogICAgcmV0dXJuIGFyZyAmJiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JwogICAgICAmJiB0eXBlb2YgYXJnLmNvcHkgPT09ICdmdW5jdGlvbicKICAgICAgJiYgdHlwZW9mIGFyZy5maWxsID09PSAnZnVuY3Rpb24nCiAgICAgICYmIHR5cGVvZiBhcmcucmVhZFVJbnQ4ID09PSAnZnVuY3Rpb24nOwogIH0KICB9LHt9XSw5NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzLGdsb2JhbCl7KGZ1bmN0aW9uICgpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIHZhciBmb3JtYXRSZWdFeHAgPSAvJVtzZGolXS9nOwogIGV4cG9ydHMuZm9ybWF0ID0gZnVuY3Rpb24oZikgewogICAgaWYgKCFpc1N0cmluZyhmKSkgewogICAgICB2YXIgb2JqZWN0cyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIG9iamVjdHMucHVzaChpbnNwZWN0KGFyZ3VtZW50c1tpXSkpOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3RzLmpvaW4oJyAnKTsKICAgIH0KICAKICAgIHZhciBpID0gMTsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgdmFyIGxlbiA9IGFyZ3MubGVuZ3RoOwogICAgdmFyIHN0ciA9IFN0cmluZyhmKS5yZXBsYWNlKGZvcm1hdFJlZ0V4cCwgZnVuY3Rpb24oeCkgewogICAgICBpZiAoeCA9PT0gJyUlJykgcmV0dXJuICclJzsKICAgICAgaWYgKGkgPj0gbGVuKSByZXR1cm4geDsKICAgICAgc3dpdGNoICh4KSB7CiAgICAgICAgY2FzZSAnJXMnOiByZXR1cm4gU3RyaW5nKGFyZ3NbaSsrXSk7CiAgICAgICAgY2FzZSAnJWQnOiByZXR1cm4gTnVtYmVyKGFyZ3NbaSsrXSk7CiAgICAgICAgY2FzZSAnJWonOgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGFyZ3NbaSsrXSk7CiAgICAgICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgICAgIHJldHVybiAnW0NpcmN1bGFyXSc7CiAgICAgICAgICB9CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB4OwogICAgICB9CiAgICB9KTsKICAgIGZvciAodmFyIHggPSBhcmdzW2ldOyBpIDwgbGVuOyB4ID0gYXJnc1srK2ldKSB7CiAgICAgIGlmIChpc051bGwoeCkgfHwgIWlzT2JqZWN0KHgpKSB7CiAgICAgICAgc3RyICs9ICcgJyArIHg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyICs9ICcgJyArIGluc3BlY3QoeCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzdHI7CiAgfTsKICAKICAKICAvLyBNYXJrIHRoYXQgYSBtZXRob2Qgc2hvdWxkIG5vdCBiZSB1c2VkLgogIC8vIFJldHVybnMgYSBtb2RpZmllZCBmdW5jdGlvbiB3aGljaCB3YXJucyBvbmNlIGJ5IGRlZmF1bHQuCiAgLy8gSWYgLS1uby1kZXByZWNhdGlvbiBpcyBzZXQsIHRoZW4gaXQgaXMgYSBuby1vcC4KICBleHBvcnRzLmRlcHJlY2F0ZSA9IGZ1bmN0aW9uKGZuLCBtc2cpIHsKICAgIC8vIEFsbG93IGZvciBkZXByZWNhdGluZyB0aGluZ3MgaW4gdGhlIHByb2Nlc3Mgb2Ygc3RhcnRpbmcgdXAuCiAgICBpZiAoaXNVbmRlZmluZWQoZ2xvYmFsLnByb2Nlc3MpKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5kZXByZWNhdGUoZm4sIG1zZykuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAKICAgIGlmIChwcm9jZXNzLm5vRGVwcmVjYXRpb24gPT09IHRydWUpIHsKICAgICAgcmV0dXJuIGZuOwogICAgfQogIAogICAgdmFyIHdhcm5lZCA9IGZhbHNlOwogICAgZnVuY3Rpb24gZGVwcmVjYXRlZCgpIHsKICAgICAgaWYgKCF3YXJuZWQpIHsKICAgICAgICBpZiAocHJvY2Vzcy50aHJvd0RlcHJlY2F0aW9uKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MudHJhY2VEZXByZWNhdGlvbikgewogICAgICAgICAgY29uc29sZS50cmFjZShtc2cpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKG1zZyk7CiAgICAgICAgfQogICAgICAgIHdhcm5lZCA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgCiAgICByZXR1cm4gZGVwcmVjYXRlZDsKICB9OwogIAogIAogIHZhciBkZWJ1Z3MgPSB7fTsKICB2YXIgZGVidWdFbnZpcm9uOwogIGV4cG9ydHMuZGVidWdsb2cgPSBmdW5jdGlvbihzZXQpIHsKICAgIGlmIChpc1VuZGVmaW5lZChkZWJ1Z0Vudmlyb24pKQogICAgICBkZWJ1Z0Vudmlyb24gPSBwcm9jZXNzLmVudi5OT0RFX0RFQlVHIHx8ICcnOwogICAgc2V0ID0gc2V0LnRvVXBwZXJDYXNlKCk7CiAgICBpZiAoIWRlYnVnc1tzZXRdKSB7CiAgICAgIGlmIChuZXcgUmVnRXhwKCdcXGInICsgc2V0ICsgJ1xcYicsICdpJykudGVzdChkZWJ1Z0Vudmlyb24pKSB7CiAgICAgICAgdmFyIHBpZCA9IHByb2Nlc3MucGlkOwogICAgICAgIGRlYnVnc1tzZXRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbXNnID0gZXhwb3J0cy5mb3JtYXQuYXBwbHkoZXhwb3J0cywgYXJndW1lbnRzKTsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzICVkOiAlcycsIHNldCwgcGlkLCBtc2cpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVidWdzW3NldF0gPSBmdW5jdGlvbigpIHt9OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZGVidWdzW3NldF07CiAgfTsKICAKICAKICAvKioKICAgKiBFY2hvcyB0aGUgdmFsdWUgb2YgYSB2YWx1ZS4gVHJ5cyB0byBwcmludCB0aGUgdmFsdWUgb3V0CiAgICogaW4gdGhlIGJlc3Qgd2F5IHBvc3NpYmxlIGdpdmVuIHRoZSBkaWZmZXJlbnQgdHlwZXMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gcHJpbnQgb3V0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIE9wdGlvbmFsIG9wdGlvbnMgb2JqZWN0IHRoYXQgYWx0ZXJzIHRoZSBvdXRwdXQuCiAgICovCiAgLyogbGVnYWN5OiBvYmosIHNob3dIaWRkZW4sIGRlcHRoLCBjb2xvcnMqLwogIGZ1bmN0aW9uIGluc3BlY3Qob2JqLCBvcHRzKSB7CiAgICAvLyBkZWZhdWx0IG9wdGlvbnMKICAgIHZhciBjdHggPSB7CiAgICAgIHNlZW46IFtdLAogICAgICBzdHlsaXplOiBzdHlsaXplTm9Db2xvcgogICAgfTsKICAgIC8vIGxlZ2FjeS4uLgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gMykgY3R4LmRlcHRoID0gYXJndW1lbnRzWzJdOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gNCkgY3R4LmNvbG9ycyA9IGFyZ3VtZW50c1szXTsKICAgIGlmIChpc0Jvb2xlYW4ob3B0cykpIHsKICAgICAgLy8gbGVnYWN5Li4uCiAgICAgIGN0eC5zaG93SGlkZGVuID0gb3B0czsKICAgIH0gZWxzZSBpZiAob3B0cykgewogICAgICAvLyBnb3QgYW4gIm9wdGlvbnMiIG9iamVjdAogICAgICBleHBvcnRzLl9leHRlbmQoY3R4LCBvcHRzKTsKICAgIH0KICAgIC8vIHNldCBkZWZhdWx0IG9wdGlvbnMKICAgIGlmIChpc1VuZGVmaW5lZChjdHguc2hvd0hpZGRlbikpIGN0eC5zaG93SGlkZGVuID0gZmFsc2U7CiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LmRlcHRoKSkgY3R4LmRlcHRoID0gMjsKICAgIGlmIChpc1VuZGVmaW5lZChjdHguY29sb3JzKSkgY3R4LmNvbG9ycyA9IGZhbHNlOwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5jdXN0b21JbnNwZWN0KSkgY3R4LmN1c3RvbUluc3BlY3QgPSB0cnVlOwogICAgaWYgKGN0eC5jb2xvcnMpIGN0eC5zdHlsaXplID0gc3R5bGl6ZVdpdGhDb2xvcjsKICAgIHJldHVybiBmb3JtYXRWYWx1ZShjdHgsIG9iaiwgY3R4LmRlcHRoKTsKICB9CiAgZXhwb3J0cy5pbnNwZWN0ID0gaW5zcGVjdDsKICAKICAKICAvLyBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0FOU0lfZXNjYXBlX2NvZGUjZ3JhcGhpY3MKICBpbnNwZWN0LmNvbG9ycyA9IHsKICAgICdib2xkJyA6IFsxLCAyMl0sCiAgICAnaXRhbGljJyA6IFszLCAyM10sCiAgICAndW5kZXJsaW5lJyA6IFs0LCAyNF0sCiAgICAnaW52ZXJzZScgOiBbNywgMjddLAogICAgJ3doaXRlJyA6IFszNywgMzldLAogICAgJ2dyZXknIDogWzkwLCAzOV0sCiAgICAnYmxhY2snIDogWzMwLCAzOV0sCiAgICAnYmx1ZScgOiBbMzQsIDM5XSwKICAgICdjeWFuJyA6IFszNiwgMzldLAogICAgJ2dyZWVuJyA6IFszMiwgMzldLAogICAgJ21hZ2VudGEnIDogWzM1LCAzOV0sCiAgICAncmVkJyA6IFszMSwgMzldLAogICAgJ3llbGxvdycgOiBbMzMsIDM5XQogIH07CiAgCiAgLy8gRG9uJ3QgdXNlICdibHVlJyBub3QgdmlzaWJsZSBvbiBjbWQuZXhlCiAgaW5zcGVjdC5zdHlsZXMgPSB7CiAgICAnc3BlY2lhbCc6ICdjeWFuJywKICAgICdudW1iZXInOiAneWVsbG93JywKICAgICdib29sZWFuJzogJ3llbGxvdycsCiAgICAndW5kZWZpbmVkJzogJ2dyZXknLAogICAgJ251bGwnOiAnYm9sZCcsCiAgICAnc3RyaW5nJzogJ2dyZWVuJywKICAgICdkYXRlJzogJ21hZ2VudGEnLAogICAgLy8gIm5hbWUiOiBpbnRlbnRpb25hbGx5IG5vdCBzdHlsaW5nCiAgICAncmVnZXhwJzogJ3JlZCcKICB9OwogIAogIAogIGZ1bmN0aW9uIHN0eWxpemVXaXRoQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICAgIHZhciBzdHlsZSA9IGluc3BlY3Quc3R5bGVzW3N0eWxlVHlwZV07CiAgCiAgICBpZiAoc3R5bGUpIHsKICAgICAgcmV0dXJuICdcdTAwMWJbJyArIGluc3BlY3QuY29sb3JzW3N0eWxlXVswXSArICdtJyArIHN0ciArCiAgICAgICAgICAgICAnXHUwMDFiWycgKyBpbnNwZWN0LmNvbG9yc1tzdHlsZV1bMV0gKyAnbSc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc3RyOwogICAgfQogIH0KICAKICAKICBmdW5jdGlvbiBzdHlsaXplTm9Db2xvcihzdHIsIHN0eWxlVHlwZSkgewogICAgcmV0dXJuIHN0cjsKICB9CiAgCiAgCiAgZnVuY3Rpb24gYXJyYXlUb0hhc2goYXJyYXkpIHsKICAgIHZhciBoYXNoID0ge307CiAgCiAgICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uKHZhbCwgaWR4KSB7CiAgICAgIGhhc2hbdmFsXSA9IHRydWU7CiAgICB9KTsKICAKICAgIHJldHVybiBoYXNoOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRWYWx1ZShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMpIHsKICAgIC8vIFByb3ZpZGUgYSBob29rIGZvciB1c2VyLXNwZWNpZmllZCBpbnNwZWN0IGZ1bmN0aW9ucy4KICAgIC8vIENoZWNrIHRoYXQgdmFsdWUgaXMgYW4gb2JqZWN0IHdpdGggYW4gaW5zcGVjdCBmdW5jdGlvbiBvbiBpdAogICAgaWYgKGN0eC5jdXN0b21JbnNwZWN0ICYmCiAgICAgICAgdmFsdWUgJiYKICAgICAgICBpc0Z1bmN0aW9uKHZhbHVlLmluc3BlY3QpICYmCiAgICAgICAgLy8gRmlsdGVyIG91dCB0aGUgdXRpbCBtb2R1bGUsIGl0J3MgaW5zcGVjdCBmdW5jdGlvbiBpcyBzcGVjaWFsCiAgICAgICAgdmFsdWUuaW5zcGVjdCAhPT0gZXhwb3J0cy5pbnNwZWN0ICYmCiAgICAgICAgLy8gQWxzbyBmaWx0ZXIgb3V0IGFueSBwcm90b3R5cGUgb2JqZWN0cyB1c2luZyB0aGUgY2lyY3VsYXIgY2hlY2suCiAgICAgICAgISh2YWx1ZS5jb25zdHJ1Y3RvciAmJiB2YWx1ZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPT09IHZhbHVlKSkgewogICAgICB2YXIgcmV0ID0gdmFsdWUuaW5zcGVjdChyZWN1cnNlVGltZXMsIGN0eCk7CiAgICAgIGlmICghaXNTdHJpbmcocmV0KSkgewogICAgICAgIHJldCA9IGZvcm1hdFZhbHVlKGN0eCwgcmV0LCByZWN1cnNlVGltZXMpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9CiAgCiAgICAvLyBQcmltaXRpdmUgdHlwZXMgY2Fubm90IGhhdmUgcHJvcGVydGllcwogICAgdmFyIHByaW1pdGl2ZSA9IGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKTsKICAgIGlmIChwcmltaXRpdmUpIHsKICAgICAgcmV0dXJuIHByaW1pdGl2ZTsKICAgIH0KICAKICAgIC8vIExvb2sgdXAgdGhlIGtleXMgb2YgdGhlIG9iamVjdC4KICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgdmFyIHZpc2libGVLZXlzID0gYXJyYXlUb0hhc2goa2V5cyk7CiAgCiAgICBpZiAoY3R4LnNob3dIaWRkZW4pIHsKICAgICAga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIElFIGRvZXNuJ3QgbWFrZSBlcnJvciBmaWVsZHMgbm9uLWVudW1lcmFibGUKICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9kd3c1MnNidCh2PXZzLjk0KS5hc3B4CiAgICBpZiAoaXNFcnJvcih2YWx1ZSkKICAgICAgICAmJiAoa2V5cy5pbmRleE9mKCdtZXNzYWdlJykgPj0gMCB8fCBrZXlzLmluZGV4T2YoJ2Rlc2NyaXB0aW9uJykgPj0gMCkpIHsKICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIFNvbWUgdHlwZSBvZiBvYmplY3Qgd2l0aG91dCBwcm9wZXJ0aWVzIGNhbiBiZSBzaG9ydGN1dHRlZC4KICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICB2YXIgbmFtZSA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW0Z1bmN0aW9uJyArIG5hbWUgKyAnXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICAgIH0KICAgICAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoRGF0ZS5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdkYXRlJyk7CiAgICAgIH0KICAgICAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgICAgfQogICAgfQogIAogICAgdmFyIGJhc2UgPSAnJywgYXJyYXkgPSBmYWxzZSwgYnJhY2VzID0gWyd7JywgJ30nXTsKICAKICAgIC8vIE1ha2UgQXJyYXkgc2F5IHRoYXQgdGhleSBhcmUgQXJyYXkKICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICBhcnJheSA9IHRydWU7CiAgICAgIGJyYWNlcyA9IFsnWycsICddJ107CiAgICB9CiAgCiAgICAvLyBNYWtlIGZ1bmN0aW9ucyBzYXkgdGhhdCB0aGV5IGFyZSBmdW5jdGlvbnMKICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICB2YXIgbiA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICBiYXNlID0gJyBbRnVuY3Rpb24nICsgbiArICddJzsKICAgIH0KICAKICAgIC8vIE1ha2UgUmVnRXhwcyBzYXkgdGhhdCB0aGV5IGFyZSBSZWdFeHBzCiAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgIGJhc2UgPSAnICcgKyBSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgfQogIAogICAgLy8gTWFrZSBkYXRlcyB3aXRoIHByb3BlcnRpZXMgZmlyc3Qgc2F5IHRoZSBkYXRlCiAgICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgICBiYXNlID0gJyAnICsgRGF0ZS5wcm90b3R5cGUudG9VVENTdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBNYWtlIGVycm9yIHdpdGggbWVzc2FnZSBmaXJzdCBzYXkgdGhlIGVycm9yCiAgICBpZiAoaXNFcnJvcih2YWx1ZSkpIHsKICAgICAgYmFzZSA9ICcgJyArIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgIH0KICAKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCAmJiAoIWFycmF5IHx8IHZhbHVlLmxlbmd0aCA9PSAwKSkgewogICAgICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArIGJyYWNlc1sxXTsKICAgIH0KICAKICAgIGlmIChyZWN1cnNlVGltZXMgPCAwKSB7CiAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ3JlZ2V4cCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW09iamVjdF0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9CiAgCiAgICBjdHguc2Vlbi5wdXNoKHZhbHVlKTsKICAKICAgIHZhciBvdXRwdXQ7CiAgICBpZiAoYXJyYXkpIHsKICAgICAgb3V0cHV0ID0gZm9ybWF0QXJyYXkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5cyk7CiAgICB9IGVsc2UgewogICAgICBvdXRwdXQgPSBrZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSk7CiAgICAgIH0pOwogICAgfQogIAogICAgY3R4LnNlZW4ucG9wKCk7CiAgCiAgICByZXR1cm4gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRQcmltaXRpdmUoY3R4LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCd1bmRlZmluZWQnLCAndW5kZWZpbmVkJyk7CiAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgIHZhciBzaW1wbGUgPSAnXCcnICsgSlNPTi5zdHJpbmdpZnkodmFsdWUpLnJlcGxhY2UoL14ifCIkL2csICcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJyInKSArICdcJyc7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZShzaW1wbGUsICdzdHJpbmcnKTsKICAgIH0KICAgIGlmIChpc051bWJlcih2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnbnVtYmVyJyk7CiAgICBpZiAoaXNCb29sZWFuKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdib29sZWFuJyk7CiAgICAvLyBGb3Igc29tZSByZWFzb24gdHlwZW9mIG51bGwgaXMgIm9iamVjdCIsIHNvIHNwZWNpYWwgY2FzZSBoZXJlLgogICAgaWYgKGlzTnVsbCh2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnbnVsbCcsICdudWxsJyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdEVycm9yKHZhbHVlKSB7CiAgICByZXR1cm4gJ1snICsgRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpICsgJ10nOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKSB7CiAgICB2YXIgb3V0cHV0ID0gW107CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkodmFsdWUsIFN0cmluZyhpKSkpIHsKICAgICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAgICBTdHJpbmcoaSksIHRydWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCgnJyk7CiAgICAgIH0KICAgIH0KICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgaWYgKCFrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAgICBrZXksIHRydWUpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIGFycmF5KSB7CiAgICB2YXIgbmFtZSwgc3RyLCBkZXNjOwogICAgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodmFsdWUsIGtleSkgfHwgeyB2YWx1ZTogdmFsdWVba2V5XSB9OwogICAgaWYgKGRlc2MuZ2V0KSB7CiAgICAgIGlmIChkZXNjLnNldCkgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyL1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChkZXNjLnNldCkgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0KICAgIGlmICghaGFzT3duUHJvcGVydHkodmlzaWJsZUtleXMsIGtleSkpIHsKICAgICAgbmFtZSA9ICdbJyArIGtleSArICddJzsKICAgIH0KICAgIGlmICghc3RyKSB7CiAgICAgIGlmIChjdHguc2Vlbi5pbmRleE9mKGRlc2MudmFsdWUpIDwgMCkgewogICAgICAgIGlmIChpc051bGwocmVjdXJzZVRpbWVzKSkgewogICAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCBudWxsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCByZWN1cnNlVGltZXMgLSAxKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0ci5pbmRleE9mKCdcbicpID4gLTEpIHsKICAgICAgICAgIGlmIChhcnJheSkgewogICAgICAgICAgICBzdHIgPSBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gJyAgJyArIGxpbmU7CiAgICAgICAgICAgIH0pLmpvaW4oJ1xuJykuc3Vic3RyKDIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RyID0gJ1xuJyArIHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIHJldHVybiAnICAgJyArIGxpbmU7CiAgICAgICAgICAgIH0pLmpvaW4oJ1xuJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbQ2lyY3VsYXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfQogICAgaWYgKGlzVW5kZWZpbmVkKG5hbWUpKSB7CiAgICAgIGlmIChhcnJheSAmJiBrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgICByZXR1cm4gc3RyOwogICAgICB9CiAgICAgIG5hbWUgPSBKU09OLnN0cmluZ2lmeSgnJyArIGtleSk7CiAgICAgIGlmIChuYW1lLm1hdGNoKC9eIihbYS16QS1aX11bYS16QS1aXzAtOV0qKSIkLykpIHsKICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHIoMSwgbmFtZS5sZW5ndGggLSAyKTsKICAgICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ25hbWUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnIicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvKF4ifCIkKS9nLCAiJyIpOwogICAgICAgIG5hbWUgPSBjdHguc3R5bGl6ZShuYW1lLCAnc3RyaW5nJyk7CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBuYW1lICsgJzogJyArIHN0cjsKICB9CiAgCiAgCiAgZnVuY3Rpb24gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpIHsKICAgIHZhciBudW1MaW5lc0VzdCA9IDA7CiAgICB2YXIgbGVuZ3RoID0gb3V0cHV0LnJlZHVjZShmdW5jdGlvbihwcmV2LCBjdXIpIHsKICAgICAgbnVtTGluZXNFc3QrKzsKICAgICAgaWYgKGN1ci5pbmRleE9mKCdcbicpID49IDApIG51bUxpbmVzRXN0Kys7CiAgICAgIHJldHVybiBwcmV2ICsgY3VyLnJlcGxhY2UoL1x1MDAxYlxbXGRcZD9tL2csICcnKS5sZW5ndGggKyAxOwogICAgfSwgMCk7CiAgCiAgICBpZiAobGVuZ3RoID4gNjApIHsKICAgICAgcmV0dXJuIGJyYWNlc1swXSArCiAgICAgICAgICAgICAoYmFzZSA9PT0gJycgPyAnJyA6IGJhc2UgKyAnXG4gJykgKwogICAgICAgICAgICAgJyAnICsKICAgICAgICAgICAgIG91dHB1dC5qb2luKCcsXG4gICcpICsKICAgICAgICAgICAgICcgJyArCiAgICAgICAgICAgICBicmFjZXNbMV07CiAgICB9CiAgCiAgICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArICcgJyArIG91dHB1dC5qb2luKCcsICcpICsgJyAnICsgYnJhY2VzWzFdOwogIH0KICAKICAKICAvLyBOT1RFOiBUaGVzZSB0eXBlIGNoZWNraW5nIGZ1bmN0aW9ucyBpbnRlbnRpb25hbGx5IGRvbid0IHVzZSBgaW5zdGFuY2VvZmAKICAvLyBiZWNhdXNlIGl0IGlzIGZyYWdpbGUgYW5kIGNhbiBiZSBlYXNpbHkgZmFrZWQgd2l0aCBgT2JqZWN0LmNyZWF0ZSgpYC4KICBmdW5jdGlvbiBpc0FycmF5KGFyKSB7CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShhcik7CiAgfQogIGV4cG9ydHMuaXNBcnJheSA9IGlzQXJyYXk7CiAgCiAgZnVuY3Rpb24gaXNCb29sZWFuKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJzsKICB9CiAgZXhwb3J0cy5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CiAgCiAgZnVuY3Rpb24gaXNOdWxsKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKICB9CiAgZXhwb3J0cy5pc051bGwgPSBpc051bGw7CiAgCiAgZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gYXJnID09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNOdWxsT3JVbmRlZmluZWQgPSBpc051bGxPclVuZGVmaW5lZDsKICAKICBmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKICB9CiAgZXhwb3J0cy5pc051bWJlciA9IGlzTnVtYmVyOwogIAogIGZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnOwogIH0KICBleHBvcnRzLmlzU3RyaW5nID0gaXNTdHJpbmc7CiAgCiAgZnVuY3Rpb24gaXNTeW1ib2woYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCc7CiAgfQogIGV4cG9ydHMuaXNTeW1ib2wgPSBpc1N5bWJvbDsKICAKICBmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IHZvaWQgMDsKICB9CiAgZXhwb3J0cy5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogIAogIGZ1bmN0aW9uIGlzUmVnRXhwKHJlKSB7CiAgICByZXR1cm4gaXNPYmplY3QocmUpICYmIG9iamVjdFRvU3RyaW5nKHJlKSA9PT0gJ1tvYmplY3QgUmVnRXhwXSc7CiAgfQogIGV4cG9ydHMuaXNSZWdFeHAgPSBpc1JlZ0V4cDsKICAKICBmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKICAKICBmdW5jdGlvbiBpc0RhdGUoZCkgewogICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmIG9iamVjdFRvU3RyaW5nKGQpID09PSAnW29iamVjdCBEYXRlXSc7CiAgfQogIGV4cG9ydHMuaXNEYXRlID0gaXNEYXRlOwogIAogIGZ1bmN0aW9uIGlzRXJyb3IoZSkgewogICAgcmV0dXJuIGlzT2JqZWN0KGUpICYmCiAgICAgICAgKG9iamVjdFRvU3RyaW5nKGUpID09PSAnW29iamVjdCBFcnJvcl0nIHx8IGUgaW5zdGFuY2VvZiBFcnJvcik7CiAgfQogIGV4cG9ydHMuaXNFcnJvciA9IGlzRXJyb3I7CiAgCiAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwogIH0KICBleHBvcnRzLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogIAogIGZ1bmN0aW9uIGlzUHJpbWl0aXZlKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbCB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJyB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdudW1iZXInIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnc3ltYm9sJyB8fCAgLy8gRVM2IHN5bWJvbAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnOwogIH0KICBleHBvcnRzLmlzUHJpbWl0aXZlID0gaXNQcmltaXRpdmU7CiAgCiAgZXhwb3J0cy5pc0J1ZmZlciA9IHJlcXVpcmUoJy4vc3VwcG9ydC9pc0J1ZmZlcicpOwogIAogIGZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKG8pIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIHBhZChuKSB7CiAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbi50b1N0cmluZygxMCkgOiBuLnRvU3RyaW5nKDEwKTsKICB9CiAgCiAgCiAgdmFyIG1vbnRocyA9IFsnSmFuJywgJ0ZlYicsICdNYXInLCAnQXByJywgJ01heScsICdKdW4nLCAnSnVsJywgJ0F1ZycsICdTZXAnLAogICAgICAgICAgICAgICAgJ09jdCcsICdOb3YnLCAnRGVjJ107CiAgCiAgLy8gMjYgRmViIDE2OjE5OjM0CiAgZnVuY3Rpb24gdGltZXN0YW1wKCkgewogICAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogICAgdmFyIHRpbWUgPSBbcGFkKGQuZ2V0SG91cnMoKSksCiAgICAgICAgICAgICAgICBwYWQoZC5nZXRNaW51dGVzKCkpLAogICAgICAgICAgICAgICAgcGFkKGQuZ2V0U2Vjb25kcygpKV0uam9pbignOicpOwogICAgcmV0dXJuIFtkLmdldERhdGUoKSwgbW9udGhzW2QuZ2V0TW9udGgoKV0sIHRpbWVdLmpvaW4oJyAnKTsKICB9CiAgCiAgCiAgLy8gbG9nIGlzIGp1c3QgYSB0aGluIHdyYXBwZXIgdG8gY29uc29sZS5sb2cgdGhhdCBwcmVwZW5kcyBhIHRpbWVzdGFtcAogIGV4cG9ydHMubG9nID0gZnVuY3Rpb24oKSB7CiAgICBjb25zb2xlLmxvZygnJXMgLSAlcycsIHRpbWVzdGFtcCgpLCBleHBvcnRzLmZvcm1hdC5hcHBseShleHBvcnRzLCBhcmd1bWVudHMpKTsKICB9OwogIAogIAogIC8qKgogICAqIEluaGVyaXQgdGhlIHByb3RvdHlwZSBtZXRob2RzIGZyb20gb25lIGNvbnN0cnVjdG9yIGludG8gYW5vdGhlci4KICAgKgogICAqIFRoZSBGdW5jdGlvbi5wcm90b3R5cGUuaW5oZXJpdHMgZnJvbSBsYW5nLmpzIHJld3JpdHRlbiBhcyBhIHN0YW5kYWxvbmUKICAgKiBmdW5jdGlvbiAobm90IG9uIEZ1bmN0aW9uLnByb3RvdHlwZSkuIE5PVEU6IElmIHRoaXMgZmlsZSBpcyB0byBiZSBsb2FkZWQKICAgKiBkdXJpbmcgYm9vdHN0cmFwcGluZyB0aGlzIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIHJld3JpdHRlbiB1c2luZyBzb21lIG5hdGl2ZQogICAqIGZ1bmN0aW9ucyBhcyBwcm90b3R5cGUgc2V0dXAgdXNpbmcgbm9ybWFsIEphdmFTY3JpcHQgZG9lcyBub3Qgd29yayBhcwogICAqIGV4cGVjdGVkIGR1cmluZyBib290c3RyYXBwaW5nIChzZWUgbWlycm9yLmpzIGluIHIxMTQ5MDMpLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbn0gY3RvciBDb25zdHJ1Y3RvciBmdW5jdGlvbiB3aGljaCBuZWVkcyB0byBpbmhlcml0IHRoZQogICAqICAgICBwcm90b3R5cGUuCiAgICogQHBhcmFtIHtmdW5jdGlvbn0gc3VwZXJDdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIHRvIGluaGVyaXQgcHJvdG90eXBlIGZyb20uCiAgICovCiAgZXhwb3J0cy5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CiAgCiAgZXhwb3J0cy5fZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luLCBhZGQpIHsKICAgIC8vIERvbid0IGRvIGFueXRoaW5nIGlmIGFkZCBpc24ndCBhbiBvYmplY3QKICAgIGlmICghYWRkIHx8ICFpc09iamVjdChhZGQpKSByZXR1cm4gb3JpZ2luOwogIAogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhhZGQpOwogICAgdmFyIGkgPSBrZXlzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgb3JpZ2luW2tleXNbaV1dID0gYWRkW2tleXNbaV1dOwogICAgfQogICAgcmV0dXJuIG9yaWdpbjsKICB9OwogIAogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJyksdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKICB9LHsiLi9zdXBwb3J0L2lzQnVmZmVyIjo5NiwiX3Byb2Nlc3MiOjg2LCJpbmhlcml0cyI6OTV9XSw5ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHYxID0gcmVxdWlyZSgnLi92MScpOwogIHZhciB2NCA9IHJlcXVpcmUoJy4vdjQnKTsKICAKICB2YXIgdXVpZCA9IHY0OwogIHV1aWQudjEgPSB2MTsKICB1dWlkLnY0ID0gdjQ7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB1dWlkOwogIAogIH0seyIuL3YxIjoxMDEsIi4vdjQiOjEwMn1dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBDb252ZXJ0IGFycmF5IG9mIDE2IGJ5dGUgdmFsdWVzIHRvIFVVSUQgc3RyaW5nIGZvcm1hdCBvZiB0aGUgZm9ybToKICAgKiBYWFhYWFhYWC1YWFhYLVhYWFgtWFhYWC1YWFhYWFhYWFhYWFgKICAgKi8KICB2YXIgYnl0ZVRvSGV4ID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogICAgYnl0ZVRvSGV4W2ldID0gKGkgKyAweDEwMCkudG9TdHJpbmcoMTYpLnN1YnN0cigxKTsKICB9CiAgCiAgZnVuY3Rpb24gYnl0ZXNUb1V1aWQoYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gb2Zmc2V0IHx8IDA7CiAgICB2YXIgYnRoID0gYnl0ZVRvSGV4OwogICAgLy8gam9pbiB1c2VkIHRvIGZpeCBtZW1vcnkgaXNzdWUgY2F1c2VkIGJ5IGNvbmNhdGVuYXRpb246IGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTMxNzUjYzQKICAgIHJldHVybiAoW2J0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dXSkuam9pbignJyk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gYnl0ZXNUb1V1aWQ7CiAgCiAgfSx7fV0sMTAwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLiAgSW4gdGhlCiAgLy8gYnJvd3NlciB0aGlzIGlzIGEgbGl0dGxlIGNvbXBsaWNhdGVkIGR1ZSB0byB1bmtub3duIHF1YWxpdHkgb2YgTWF0aC5yYW5kb20oKQogIC8vIGFuZCBpbmNvbnNpc3RlbnQgc3VwcG9ydCBmb3IgdGhlIGBjcnlwdG9gIEFQSS4gIFdlIGRvIHRoZSBiZXN0IHdlIGNhbiB2aWEKICAvLyBmZWF0dXJlLWRldGVjdGlvbgogIAogIC8vIGdldFJhbmRvbVZhbHVlcyBuZWVkcyB0byBiZSBpbnZva2VkIGluIGEgY29udGV4dCB3aGVyZSAidGhpcyIgaXMgYSBDcnlwdG8KICAvLyBpbXBsZW1lbnRhdGlvbi4gQWxzbywgZmluZCB0aGUgY29tcGxldGUgaW1wbGVtZW50YXRpb24gb2YgY3J5cHRvIG9uIElFMTEuCiAgdmFyIGdldFJhbmRvbVZhbHVlcyA9ICh0eXBlb2YoY3J5cHRvKSAhPSAndW5kZWZpbmVkJyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChjcnlwdG8pKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZW9mKG1zQ3J5cHRvKSAhPSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygd2luZG93Lm1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcyA9PSAnZnVuY3Rpb24nICYmIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKG1zQ3J5cHRvKSk7CiAgCiAgaWYgKGdldFJhbmRvbVZhbHVlcykgewogICAgLy8gV0hBVFdHIGNyeXB0byBSTkcgLSBodHRwOi8vd2lraS53aGF0d2cub3JnL3dpa2kvQ3J5cHRvCiAgICB2YXIgcm5kczggPSBuZXcgVWludDhBcnJheSgxNik7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW5kZWYKICAKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gd2hhdHdnUk5HKCkgewogICAgICBnZXRSYW5kb21WYWx1ZXMocm5kczgpOwogICAgICByZXR1cm4gcm5kczg7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBNYXRoLnJhbmRvbSgpLWJhc2VkIChSTkcpCiAgICAvLwogICAgLy8gSWYgYWxsIGVsc2UgZmFpbHMsIHVzZSBNYXRoLnJhbmRvbSgpLiAgSXQncyBmYXN0LCBidXQgaXMgb2YgdW5zcGVjaWZpZWQKICAgIC8vIHF1YWxpdHkuCiAgICB2YXIgcm5kcyA9IG5ldyBBcnJheSgxNik7CiAgCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIG1hdGhSTkcoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCByOyBpIDwgMTY7IGkrKykgewogICAgICAgIGlmICgoaSAmIDB4MDMpID09PSAwKSByID0gTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwOwogICAgICAgIHJuZHNbaV0gPSByID4+PiAoKGkgJiAweDAzKSA8PCAzKSAmIDB4ZmY7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJuZHM7CiAgICB9OwogIH0KICAKICB9LHt9XSwxMDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBybmcgPSByZXF1aXJlKCcuL2xpYi9ybmcnKTsKICB2YXIgYnl0ZXNUb1V1aWQgPSByZXF1aXJlKCcuL2xpYi9ieXRlc1RvVXVpZCcpOwogIAogIC8vICoqYHYxKClgIC0gR2VuZXJhdGUgdGltZS1iYXNlZCBVVUlEKioKICAvLwogIC8vIEluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9MaW9zSy9VVUlELmpzCiAgLy8gYW5kIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS91dWlkLmh0bWwKICAKICB2YXIgX25vZGVJZDsKICB2YXIgX2Nsb2Nrc2VxOwogIAogIC8vIFByZXZpb3VzIHV1aWQgY3JlYXRpb24gdGltZQogIHZhciBfbGFzdE1TZWNzID0gMDsKICB2YXIgX2xhc3ROU2VjcyA9IDA7CiAgCiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkIGZvciBBUEkgZGV0YWlscwogIGZ1bmN0aW9uIHYxKG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICAgIHZhciBiID0gYnVmIHx8IFtdOwogIAogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgbm9kZSA9IG9wdGlvbnMubm9kZSB8fCBfbm9kZUlkOwogICAgdmFyIGNsb2Nrc2VxID0gb3B0aW9ucy5jbG9ja3NlcSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jbG9ja3NlcSA6IF9jbG9ja3NlcTsKICAKICAgIC8vIG5vZGUgYW5kIGNsb2Nrc2VxIG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgdG8gcmFuZG9tIHZhbHVlcyBpZiB0aGV5J3JlIG5vdAogICAgLy8gc3BlY2lmaWVkLiAgV2UgZG8gdGhpcyBsYXppbHkgdG8gbWluaW1pemUgaXNzdWVzIHJlbGF0ZWQgdG8gaW5zdWZmaWNpZW50CiAgICAvLyBzeXN0ZW0gZW50cm9weS4gIFNlZSAjMTg5CiAgICBpZiAobm9kZSA9PSBudWxsIHx8IGNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgdmFyIHNlZWRCeXRlcyA9IHJuZygpOwogICAgICBpZiAobm9kZSA9PSBudWxsKSB7CiAgICAgICAgLy8gUGVyIDQuNSwgY3JlYXRlIGFuZCA0OC1iaXQgbm9kZSBpZCwgKDQ3IHJhbmRvbSBiaXRzICsgbXVsdGljYXN0IGJpdCA9IDEpCiAgICAgICAgbm9kZSA9IF9ub2RlSWQgPSBbCiAgICAgICAgICBzZWVkQnl0ZXNbMF0gfCAweDAxLAogICAgICAgICAgc2VlZEJ5dGVzWzFdLCBzZWVkQnl0ZXNbMl0sIHNlZWRCeXRlc1szXSwgc2VlZEJ5dGVzWzRdLCBzZWVkQnl0ZXNbNV0KICAgICAgICBdOwogICAgICB9CiAgICAgIGlmIChjbG9ja3NlcSA9PSBudWxsKSB7CiAgICAgICAgLy8gUGVyIDQuMi4yLCByYW5kb21pemUgKDE0IGJpdCkgY2xvY2tzZXEKICAgICAgICBjbG9ja3NlcSA9IF9jbG9ja3NlcSA9IChzZWVkQnl0ZXNbNl0gPDwgOCB8IHNlZWRCeXRlc1s3XSkgJiAweDNmZmY7CiAgICAgIH0KICAgIH0KICAKICAgIC8vIFVVSUQgdGltZXN0YW1wcyBhcmUgMTAwIG5hbm8tc2Vjb25kIHVuaXRzIHNpbmNlIHRoZSBHcmVnb3JpYW4gZXBvY2gsCiAgICAvLyAoMTU4Mi0xMC0xNSAwMDowMCkuICBKU051bWJlcnMgYXJlbid0IHByZWNpc2UgZW5vdWdoIGZvciB0aGlzLCBzbwogICAgLy8gdGltZSBpcyBoYW5kbGVkIGludGVybmFsbHkgYXMgJ21zZWNzJyAoaW50ZWdlciBtaWxsaXNlY29uZHMpIGFuZCAnbnNlY3MnCiAgICAvLyAoMTAwLW5hbm9zZWNvbmRzIG9mZnNldCBmcm9tIG1zZWNzKSBzaW5jZSB1bml4IGVwb2NoLCAxOTcwLTAxLTAxIDAwOjAwLgogICAgdmFyIG1zZWNzID0gb3B0aW9ucy5tc2VjcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5tc2VjcyA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIAogICAgLy8gUGVyIDQuMi4xLjIsIHVzZSBjb3VudCBvZiB1dWlkJ3MgZ2VuZXJhdGVkIGR1cmluZyB0aGUgY3VycmVudCBjbG9jawogICAgLy8gY3ljbGUgdG8gc2ltdWxhdGUgaGlnaGVyIHJlc29sdXRpb24gY2xvY2sKICAgIHZhciBuc2VjcyA9IG9wdGlvbnMubnNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubnNlY3MgOiBfbGFzdE5TZWNzICsgMTsKICAKICAgIC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKICAgIHZhciBkdCA9IChtc2VjcyAtIF9sYXN0TVNlY3MpICsgKG5zZWNzIC0gX2xhc3ROU2VjcykvMTAwMDA7CiAgCiAgICAvLyBQZXIgNC4yLjEuMiwgQnVtcCBjbG9ja3NlcSBvbiBjbG9jayByZWdyZXNzaW9uCiAgICBpZiAoZHQgPCAwICYmIG9wdGlvbnMuY2xvY2tzZXEgPT09IHVuZGVmaW5lZCkgewogICAgICBjbG9ja3NlcSA9IGNsb2Nrc2VxICsgMSAmIDB4M2ZmZjsKICAgIH0KICAKICAgIC8vIFJlc2V0IG5zZWNzIGlmIGNsb2NrIHJlZ3Jlc3NlcyAobmV3IGNsb2Nrc2VxKSBvciB3ZSd2ZSBtb3ZlZCBvbnRvIGEgbmV3CiAgICAvLyB0aW1lIGludGVydmFsCiAgICBpZiAoKGR0IDwgMCB8fCBtc2VjcyA+IF9sYXN0TVNlY3MpICYmIG9wdGlvbnMubnNlY3MgPT09IHVuZGVmaW5lZCkgewogICAgICBuc2VjcyA9IDA7CiAgICB9CiAgCiAgICAvLyBQZXIgNC4yLjEuMiBUaHJvdyBlcnJvciBpZiB0b28gbWFueSB1dWlkcyBhcmUgcmVxdWVzdGVkCiAgICBpZiAobnNlY3MgPj0gMTAwMDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCd1dWlkLnYxKCk6IENhblwndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMnKTsKICAgIH0KICAKICAgIF9sYXN0TVNlY3MgPSBtc2VjczsKICAgIF9sYXN0TlNlY3MgPSBuc2VjczsKICAgIF9jbG9ja3NlcSA9IGNsb2Nrc2VxOwogIAogICAgLy8gUGVyIDQuMS40IC0gQ29udmVydCBmcm9tIHVuaXggZXBvY2ggdG8gR3JlZ29yaWFuIGVwb2NoCiAgICBtc2VjcyArPSAxMjIxOTI5MjgwMDAwMDsKICAKICAgIC8vIGB0aW1lX2xvd2AKICAgIHZhciB0bCA9ICgobXNlY3MgJiAweGZmZmZmZmYpICogMTAwMDAgKyBuc2VjcykgJSAweDEwMDAwMDAwMDsKICAgIGJbaSsrXSA9IHRsID4+PiAyNCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdGwgJiAweGZmOwogIAogICAgLy8gYHRpbWVfbWlkYAogICAgdmFyIHRtaCA9IChtc2VjcyAvIDB4MTAwMDAwMDAwICogMTAwMDApICYgMHhmZmZmZmZmOwogICAgYltpKytdID0gdG1oID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRtaCAmIDB4ZmY7CiAgCiAgICAvLyBgdGltZV9oaWdoX2FuZF92ZXJzaW9uYAogICAgYltpKytdID0gdG1oID4+PiAyNCAmIDB4ZiB8IDB4MTA7IC8vIGluY2x1ZGUgdmVyc2lvbgogICAgYltpKytdID0gdG1oID4+PiAxNiAmIDB4ZmY7CiAgCiAgICAvLyBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAgKFBlciA0LjIuMiAtIGluY2x1ZGUgdmFyaWFudCkKICAgIGJbaSsrXSA9IGNsb2Nrc2VxID4+PiA4IHwgMHg4MDsKICAKICAgIC8vIGBjbG9ja19zZXFfbG93YAogICAgYltpKytdID0gY2xvY2tzZXEgJiAweGZmOwogIAogICAgLy8gYG5vZGVgCiAgICBmb3IgKHZhciBuID0gMDsgbiA8IDY7ICsrbikgewogICAgICBiW2kgKyBuXSA9IG5vZGVbbl07CiAgICB9CiAgCiAgICByZXR1cm4gYnVmID8gYnVmIDogYnl0ZXNUb1V1aWQoYik7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gdjE7CiAgCiAgfSx7Ii4vbGliL2J5dGVzVG9VdWlkIjo5OSwiLi9saWIvcm5nIjoxMDB9XSwxMDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBybmcgPSByZXF1aXJlKCcuL2xpYi9ybmcnKTsKICB2YXIgYnl0ZXNUb1V1aWQgPSByZXF1aXJlKCcuL2xpYi9ieXRlc1RvVXVpZCcpOwogIAogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICAKICAgIGlmICh0eXBlb2Yob3B0aW9ucykgPT0gJ3N0cmluZycpIHsKICAgICAgYnVmID0gb3B0aW9ucyA9PT0gJ2JpbmFyeScgPyBuZXcgQXJyYXkoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHZhciBybmRzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IHJuZykoKTsKICAKICAgIC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKICAgIHJuZHNbNl0gPSAocm5kc1s2XSAmIDB4MGYpIHwgMHg0MDsKICAgIHJuZHNbOF0gPSAocm5kc1s4XSAmIDB4M2YpIHwgMHg4MDsKICAKICAgIC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAogICAgaWYgKGJ1ZikgewogICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgMTY7ICsraWkpIHsKICAgICAgICBidWZbaSArIGlpXSA9IHJuZHNbaWldOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gYnVmIHx8IGJ5dGVzVG9VdWlkKHJuZHMpOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHY0OwogIAogIH0seyIuL2xpYi9ieXRlc1RvVXVpZCI6OTksIi4vbGliL3JuZyI6MTAwfV0sMTAzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAidXNlIHN0cmljdCI7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICB2YXIgTFJVXzEgPSByZXF1aXJlKCIuL3V0aWxzL0xSVSIpOwogIHZhciBDQUNIRV9TSVpFID0gMTAwMDsKICAvKioKICAgKiBJbnNwaXJlZCBub2RlLWxydS1jYWNoZVtodHRwczovL2dpdGh1Yi5jb20vaXNhYWNzL25vZGUtbHJ1LWNhY2hlXQogICAqLwogIHZhciBFbmRwb2ludENhY2hlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBFbmRwb2ludENhY2hlKG1heFNpemUpIHsKICAgICAgICAgIGlmIChtYXhTaXplID09PSB2b2lkIDApIHsgbWF4U2l6ZSA9IENBQ0hFX1NJWkU7IH0KICAgICAgICAgIHRoaXMubWF4U2l6ZSA9IG1heFNpemU7CiAgICAgICAgICB0aGlzLmNhY2hlID0gbmV3IExSVV8xLkxSVUNhY2hlKG1heFNpemUpOwogICAgICB9CiAgICAgIDsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLCAic2l6ZSIsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlLmxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5wdXQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgICB2YXIgZW5kcG9pbnRSZWNvcmQgPSB0aGlzLnBvcHVsYXRlVmFsdWUodmFsdWUpOwogICAgICAgICAgdGhpcy5jYWNoZS5wdXQoa2V5U3RyaW5nLCBlbmRwb2ludFJlY29yZCk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuY2FjaGUuZ2V0KGtleVN0cmluZyk7CiAgICAgICAgICBpZiAocmVjb3JkcykgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgcmVjb3JkID0gcmVjb3Jkc1tpXTsKICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5FeHBpcmUgPCBub3cpIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FjaGUucmVtb3ZlKGtleVN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlY29yZHM7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgdmFyIGlkZW50aWZpZXJzID0gW107CiAgICAgICAgICB2YXIgaWRlbnRpZmllck5hbWVzID0gT2JqZWN0LmtleXMoa2V5KS5zb3J0KCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlkZW50aWZpZXJOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpZGVudGlmaWVyTmFtZSA9IGlkZW50aWZpZXJOYW1lc1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5W2lkZW50aWZpZXJOYW1lXSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICBpZGVudGlmaWVycy5wdXNoKGtleVtpZGVudGlmaWVyTmFtZV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlkZW50aWZpZXJzLmpvaW4oJyAnKTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucG9wdWxhdGVWYWx1ZSA9IGZ1bmN0aW9uIChlbmRwb2ludHMpIHsKICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpOwogICAgICAgICAgcmV0dXJuIGVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7IHJldHVybiAoewogICAgICAgICAgICAgIEFkZHJlc3M6IGVuZHBvaW50LkFkZHJlc3MgfHwgJycsCiAgICAgICAgICAgICAgRXhwaXJlOiBub3cgKyAoZW5kcG9pbnQuQ2FjaGVQZXJpb2RJbk1pbnV0ZXMgfHwgMSkgKiA2MCAqIDEwMDAKICAgICAgICAgIH0pOyB9KTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0aGlzLmNhY2hlLmVtcHR5KCk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgICAgfTsKICAgICAgcmV0dXJuIEVuZHBvaW50Q2FjaGU7CiAgfSgpKTsKICBleHBvcnRzLkVuZHBvaW50Q2FjaGUgPSBFbmRwb2ludENhY2hlOwogIH0seyIuL3V0aWxzL0xSVSI6MTA0fV0sMTA0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAidXNlIHN0cmljdCI7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICB2YXIgTGlua2VkTGlzdE5vZGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpIHsKICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBMaW5rZWRMaXN0Tm9kZTsKICB9KCkpOwogIHZhciBMUlVDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gTFJVQ2FjaGUoc2l6ZSkgewogICAgICAgICAgdGhpcy5ub2RlTWFwID0ge307CiAgICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJyB8fCBzaXplIDwgMSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FjaGUgc2l6ZSBjYW4gb25seSBiZSBwb3NpdGl2ZSBudW1iZXInKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc2l6ZUxpbWl0ID0gc2l6ZTsKICAgICAgfQogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTFJVQ2FjaGUucHJvdG90eXBlLCAibGVuZ3RoIiwgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2l6ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucHJlcGVuZFRvTGlzdCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICBpZiAoIXRoaXMuaGVhZGVyTm9kZSkgewogICAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlLnByZXYgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUubmV4dCA9IHRoaXMuaGVhZGVyTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGU7CiAgICAgICAgICB0aGlzLnNpemUrKzsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZUZyb21UYWlsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCF0aGlzLnRhaWxOb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlID0gdGhpcy50YWlsTm9kZTsKICAgICAgICAgIHZhciBwcmV2Tm9kZSA9IG5vZGUucHJldjsKICAgICAgICAgIGlmIChwcmV2Tm9kZSkgewogICAgICAgICAgICAgIHByZXZOb2RlLm5leHQgPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gcHJldk5vZGU7CiAgICAgICAgICB0aGlzLnNpemUtLTsKICAgICAgICAgIHJldHVybiBub2RlOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZGV0YWNoRnJvbUxpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgaWYgKHRoaXMuaGVhZGVyTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGUubmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnRhaWxOb2RlID09PSBub2RlKSB7CiAgICAgICAgICAgICAgdGhpcy50YWlsTm9kZSA9IG5vZGUucHJldjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnByZXYpIHsKICAgICAgICAgICAgICBub2RlLnByZXYubmV4dCA9IG5vZGUubmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLm5leHQpIHsKICAgICAgICAgICAgICBub2RlLm5leHQucHJldiA9IG5vZGUucHJldjsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICAgIG5vZGUucHJldiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICAgIHRoaXMucHJlcGVuZFRvTGlzdChub2RlKTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVNYXBba2V5XSkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5wdXQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHRoaXMuc2l6ZSA9PT0gdGhpcy5zaXplTGltaXQpIHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSB0aGlzLnJlbW92ZUZyb21UYWlsKCk7CiAgICAgICAgICAgICAgdmFyIGtleV8xID0gdGFpbE5vZGUua2V5OwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XzFdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld05vZGUgPSBuZXcgTGlua2VkTGlzdE5vZGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLm5vZGVNYXBba2V5XSA9IG5ld05vZGU7CiAgICAgICAgICB0aGlzLnByZXBlbmRUb0xpc3QobmV3Tm9kZSk7CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5ub2RlTWFwKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBMUlVDYWNoZTsKICB9KCkpOwogIGV4cG9ydHMuTFJVQ2FjaGUgPSBMUlVDYWNoZTsKICB9LHt9XSwxMDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuNTUzLjAKICAvLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICAvLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CiAgcmVxdWlyZSgnLi9icm93c2VyX2xvYWRlcicpOwogIAogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHdpbmRvdy5BV1MgPSBBV1M7CiAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8qKgogICAgICAgKiBAYXBpIHByaXZhdGUKICAgICAgICovCiAgICAgIG1vZHVsZS5leHBvcnRzID0gQVdTOwogIH0KICBpZiAodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnKSBzZWxmLkFXUyA9IEFXUzsKICAKICAvKioKICAgKiBAcHJpdmF0ZQogICAqIERPIE5PVCBSRU1PVkUKICAgKiBicm93c2VyIGJ1aWxkZXIgd2lsbCBzdHJpcCBvdXQgdGhpcyBsaW5lIGlmIHNlcnZpY2VzIGFyZSBzdXBwbGllZCBvbiB0aGUgY29tbWFuZCBsaW5lLgogICAqL2lmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUywgJ0Nvbm5lY3QnKSkgewogICAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snY29ubmVjdCddID0ge307CiAgICBBV1MuQ29ubmVjdCA9IEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2Nvbm5lY3QnLCBbICcyMDE3LTAyLTE1JyBdKTsKICB9CiAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snY29ubmVjdCddWycyMDE3LTAyLTE1J10gPSByZXF1aXJlKCcuLi9hcGlzL2Nvbm5lY3QtMjAxNy0wMi0xNS5taW4nKTsKICAKICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MsICdTVFMnKSkgewogICAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10gPSB7fTsKICAgIEFXUy5TVFMgPSBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdzdHMnLCBbICcyMDExLTA2LTE1JyBdKTsKICAgIHJlcXVpcmUoJy4vc2VydmljZXMvc3RzJyk7CiAgfQogIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddWycyMDExLTA2LTE1J10gPSByZXF1aXJlKCcuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbicpOwogIAogIAogIH0seyIuLi9hcGlzL2Nvbm5lY3QtMjAxNy0wMi0xNS5taW4iOjMsIi4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluIjo1LCIuL2Jyb3dzZXJfbG9hZGVyIjoxNiwiLi9jb3JlIjoxOCwiLi9zZXJ2aWNlcy9zdHMiOjYxfV19LHt9LFsxMDVdKTsKCi8qKiovIH0pLAoKLyoqKi8gNzU0OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIENsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuQ2xpZW50TWV0aG9kcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgICAgICAnZ2V0QWdlbnRTbmFwc2hvdCcsCiAgICAgICAgICdwdXRBZ2VudFN0YXRlJywKICAgICAgICAgJ2dldEFnZW50U3RhdGVzJywKICAgICAgICAgJ2dldERpYWxhYmxlQ291bnRyeUNvZGVzJywKICAgICAgICAgJ2dldFJvdXRpbmdQcm9maWxlUXVldWVzJywKICAgICAgICAgJ2dldEFnZW50UGVybWlzc2lvbnMnLAogICAgICAgICAnZ2V0QWdlbnRDb25maWd1cmF0aW9uJywKICAgICAgICAgJ3VwZGF0ZUFnZW50Q29uZmlndXJhdGlvbicsCiAgICAgICAgICdhY2NlcHRDb250YWN0JywKICAgICAgICAgJ2NyZWF0ZU91dGJvdW5kQ29udGFjdCcsCiAgICAgICAgICdjcmVhdGVUYXNrQ29udGFjdCcsCiAgICAgICAgICdjbGVhckNvbnRhY3QnLAogICAgICAgICAnY29tcGxldGVDb250YWN0JywKICAgICAgICAgJ2Rlc3Ryb3lDb250YWN0JywKICAgICAgICAgJ3JlamVjdENvbnRhY3QnLAogICAgICAgICAnbm90aWZ5Q29udGFjdElzc3VlJywKICAgICAgICAgJ3VwZGF0ZUNvbnRhY3RBdHRyaWJ1dGVzJywKICAgICAgICAgJ2NyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uJywKICAgICAgICAgJ2Rlc3Ryb3lDb25uZWN0aW9uJywKICAgICAgICAgJ2hvbGRDb25uZWN0aW9uJywKICAgICAgICAgJ3Jlc3VtZUNvbm5lY3Rpb24nLAogICAgICAgICAndG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMnLAogICAgICAgICAnY29uZmVyZW5jZUNvbm5lY3Rpb25zJywKICAgICAgICAgJ3NlbmRDbGllbnRMb2dzJywKICAgICAgICAgJ3NlbmREaWdpdHMnLAogICAgICAgICAnc2VuZFNvZnRwaG9uZUNhbGxSZXBvcnQnLAogICAgICAgICAnc2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzJywKICAgICAgICAgJ2dldEVuZHBvaW50cycsCiAgICAgICAgICdnZXROZXdBdXRoVG9rZW4nLAogICAgICAgICAnY3JlYXRlVHJhbnNwb3J0JywKICAgICAgICAgJ211dGVQYXJ0aWNpcGFudCcsCiAgICAgICAgICd1bm11dGVQYXJ0aWNpcGFudCcsCiAgICAgICAgICd1cGRhdGVNb25pdG9yUGFydGljaXBhbnRTdGF0ZScKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBBZ2VudEFwcENsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzID0gewogICAgICBHRVRfQ09OVEFDVDogIkFnZW50QXBwU2VydmljZS5MY21zLmdldENvbnRhY3QiLAogICAgICBERUxFVEVfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlbGV0ZVNwZWFrZXIiLAogICAgICBFTlJPTExfQllfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmVucm9sbEJ5U2Vzc2lvbiIsCiAgICAgIEVWQUxVQVRFX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5ldmFsdWF0ZVNlc3Npb24iLAogICAgICBERVNDUklCRV9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZGVzY3JpYmVTcGVha2VyIiwKICAgICAgT1BUX09VVF9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQub3B0T3V0U3BlYWtlciIsCiAgICAgIFVQREFURV9WT0lDRV9JRF9EQVRBOiAiQWdlbnRBcHBTZXJ2aWNlLkxjbXMudXBkYXRlVm9pY2VJZERhdGEiLAogICAgICBERVNDUklCRV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZGVzY3JpYmVTZXNzaW9uIiwKICAgICAgVVBEQVRFX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC51cGRhdGVTZXNzaW9uIiwKICAgICAgU1RBUlRfVk9JQ0VfSURfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5OYXNhLnN0YXJ0Vm9pY2VJZFNlc3Npb24iLAogICAgICBMSVNUX0lOVEVHUkFUSU9OX0FTU09DSUFUSU9OUzogIkFnZW50QXBwU2VydmljZS5BY3MubGlzdEludGVncmF0aW9uQXNzb2NpYXRpb25zIiwKICAgICAgU1RBUlRfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlN0YXJ0Q29udGFjdFJlY29yZGluZyIsCiAgICAgIFNUT1BfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlN0b3BDb250YWN0UmVjb3JkaW5nIiwKICAgICAgU1VTUEVORF9DT05UQUNUX1JFQ09SRElORzogIkFnZW50QXBwU2VydmljZS5BY3MuU3VzcGVuZENvbnRhY3RSZWNvcmRpbmciLAogICAgICBSRVNVTUVfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlJlc3VtZUNvbnRhY3RSZWNvcmRpbmciCiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBNYXN0ZXJNZXRob2RzCiAgICAqLwogICBjb25uZWN0Lk1hc3Rlck1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2JlY29tZU1hc3RlcicsCiAgICAgICAgICdjaGVja01hc3RlcicKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBUYXNrVGVtcGxhdGVzQ2xpZW50TWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50TWV0aG9kcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgICAnbGlzdFRhc2tUZW1wbGF0ZXMnLAogICAgICAnZ2V0VGFza1RlbXBsYXRlJywKICAgICAgJ2NyZWF0ZVRlbXBsYXRlZFRhc2snLAogICAgICAndXBkYXRlQ29udGFjdCcKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIENsaWVudEJhc2UgPSBmdW5jdGlvbigpIHt9OwogICBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUyA9IHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7IH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKCkgeyB9CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5jYWxsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXNJbiwgY2FsbGJhY2tzSW4pIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICAgIHZhciBjYWxsYmFja3MgPSBjYWxsYmFja3NJbiB8fCBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUzsKICAgICAgdGhpcy5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcyk7CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIE51bGxDbGllbnQgPSBmdW5jdGlvbigpIHsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICB9OwogICBOdWxsQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE51bGxDbGllbnQ7CgogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBOVUxMIGNsaWVudDogJXMnLCBtZXRob2QpOwogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpLCB7bWVzc2FnZTogbWVzc2FnZX0pOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlID0gZnVuY3Rpb24oY29uZHVpdCwgcmVxdWVzdEV2ZW50LCByZXNwb25zZUV2ZW50KSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgICAgdGhpcy5yZXF1ZXN0RXZlbnQgPSByZXF1ZXN0RXZlbnQ7CiAgICAgIHRoaXMucmVzcG9uc2VFdmVudCA9IHJlc3BvbnNlRXZlbnQ7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcCA9IHt9OwoKICAgICAgdGhpcy5jb25kdWl0Lm9uVXBzdHJlYW0ocmVzcG9uc2VFdmVudCwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9oYW5kbGVSZXNwb25zZSkpOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlOwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB2YXIgcmVxdWVzdCA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QodGhpcy5yZXF1ZXN0RXZlbnQsIG1ldGhvZCwgcGFyYW1zKTsKICAgICAgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3QucmVxdWVzdElkXSA9IGNhbGxiYWNrczsKICAgICAgdGhpcy5jb25kdWl0LnNlbmRVcHN0cmVhbShyZXF1ZXN0LmV2ZW50LCByZXF1ZXN0KTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0ID0gZnVuY3Rpb24ocmVxdWVzdElkKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXSB8fCBudWxsOwoKICAgICAgaWYgKGNhbGxiYWNrcyAhPSBudWxsKSB7CiAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGxiYWNrczsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9oYW5kbGVSZXNwb25zZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2dldENhbGxiYWNrc0ZvclJlcXVlc3QoZGF0YS5yZXF1ZXN0SWQpOwogICAgICBpZiAoY2FsbGJhY2tzID09IG51bGwpIHsKICAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoZGF0YS5lcnIgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZGF0YS5lcnIsIGRhdGEuZGF0YSk7CgogICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdENsaWVudDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudDsKICAgCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50QXBwQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogICB2YXIgQWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbihhdXRoQ29va2llTmFtZSwgYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aENvb2tpZU5hbWUsICdhdXRoQ29va2llTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50Jyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5lbmRwb2ludFVybCA9IGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sKGVuZHBvaW50KTsKICAgICAgdGhpcy5hdXRoVG9rZW4gPSBhdXRoVG9rZW47CiAgICAgIHRoaXMuYXV0aENvb2tpZU5hbWUgPSBhdXRoQ29va2llTmFtZQogICB9OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50QXBwQ2xpZW50OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYmVhciA9IHt9OwogICAgICBiZWFyW3NlbGYuYXV0aENvb2tpZU5hbWVdID0gc2VsZi5hdXRoVG9rZW47CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICBtZXRob2Q6ICdwb3N0JywKICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGFyYW1zIHx8IHt9KSwKICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnWC1BbXotdGFyZ2V0JzogbWV0aG9kLAogICAgICAgICAgICAgICAnWC1BbXotQmVhcmVyJzogSlNPTi5zdHJpbmdpZnkoYmVhcikKICAgICAgICAgfQogICAgICB9OwogICAgICBjb25uZWN0LmZldGNoKHNlbGYuZW5kcG9pbnRVcmwsIG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocmVzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgY29uc3QgcmVhZGVyID0gZXJyLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgICAgIGxldCBib2R5ID0gJyc7CiAgICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHsgZG9uZSwgdmFsdWUgfSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBlcnIuc3RhdHVzOwogICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkKCkudGhlbihwcm9jZXNzVGV4dCk7CiAgICAgICAgIH0pOwogICAgICB9KQogICB9OwogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQVdTQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIEFXU0NsaWVudCA9IGZ1bmN0aW9uKGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludEluKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhdXRoVG9rZW4sICdhdXRoVG9rZW4nKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZ2lvbiwgJ3JlZ2lvbicpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHt9KTsKICAgICAgQVdTLmNvbmZpZy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB2YXIgYmFzZVVybCA9IGNvbm5lY3QuZ2V0QmFzZVVybCgpOwogICAgICB2YXIgZW5kcG9pbnRVcmwgPSBlbmRwb2ludEluIHx8ICggCiAgICAgICAgIGJhc2VVcmwuaW5jbHVkZXMoIi5hd3NhcHBzLmNvbSIpCiAgICAgICAgICAgID8gYmFzZVVybCArICcvY29ubmVjdC9hcGknCiAgICAgICAgICAgIDogYmFzZVVybCArICcvYXBpJwogICAgICApOwogICAgICB2YXIgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50VXJsKTsKICAgICAgdGhpcy5jbGllbnQgPSBuZXcgQVdTLkNvbm5lY3Qoe2VuZHBvaW50OiBlbmRwb2ludH0pOwogICB9OwogICBBV1NDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFXU0NsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBV1NDbGllbnQ7CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CgogICAgICBpZiAoISBjb25uZWN0LmNvbnRhaW5zKHRoaXMuY2xpZW50LCBtZXRob2QpKSB7CiAgICAgICAgIHZhciBtZXNzYWdlID0gY29ubmVjdC5zcHJpbnRmKCdObyBzdWNoIG1ldGhvZCBleGlzdHMgb24gQVdTIGNsaWVudDogJXMnLCBtZXRob2QpOwogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpLCB7bWVzc2FnZTogbWVzc2FnZX0pOwoKICAgICAgfSBlbHNlIHsKICAgICAgICAgcGFyYW1zID0gdGhpcy5fdHJhbnNsYXRlUGFyYW1zKG1ldGhvZCwgcGFyYW1zKTsKCiAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiAtLT4gQ2FsbGluZyBvcGVyYXRpb24gJyVzJyIsIG1ldGhvZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgICAgIHRoaXMuY2xpZW50W21ldGhvZF0ocGFyYW1zKQogICAgICAgICAgICAub24oJ2J1aWxkJywgZnVuY3Rpb24ocmVxdWVzdCkgewogICAgICAgICAgICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUJlYXJlciddID0gc2VsZi5hdXRoVG9rZW47CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gY29ubmVjdC5DVElFeGNlcHRpb25zLlVOQVVUSE9SSVpFRF9FWENFUFRJT04pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmF1dGhGYWlsdXJlKCk7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCAmJiAoZXJyLmNvZGUgPT09IGNvbm5lY3QuQ1RJRXhjZXB0aW9ucy5BQ0NFU1NfREVOSUVEX0VYQ0VQVElPTiB8fCBlcnIuc3RhdHVzQ29kZSA9PT0gNDAzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuYWNjZXNzRGVuaWVkKCk7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbid0IHBhc3MgZXJyIGRpcmVjdGx5IHRvIHBvc3RNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBvc3RNZXNzYWdlKCkgdHJpZXMgdG8gY2xvbmUgdGhlIGVyciBvYmplY3QgYW5kIGZhaWxlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8gaHR0cHM6Ly9naXRodWIuY29tL2dvYXRzbGFja2VyL2FsdC1kZXZ0b29sL2lzc3Vlcy81CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci50eXBlID0gZXJyLmNvZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5zdGFjayl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlcnIuc3RhY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBlcnIuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnIuc3RhY2sgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBbSlNPTi5zdHJpbmdpZnkoZXJyLnN0YWNrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnIuc3RhY2sgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBlcnIuc3RhY2suc3BsaXQoJ1xuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2gge30KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogPC0tIE9wZXJhdGlvbiAnJXMnIGZhaWxlZDogJXMiLCBtZXRob2QsIEpTT04uc3RyaW5naWZ5KGVycikpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogPC0tIE9wZXJhdGlvbiAnJXMnIHN1Y2NlZWRlZC4iLCBtZXRob2QpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gaGFuZGxlIEFXUyBBUEkgcmVxdWVzdCBmb3IgbWV0aG9kICVzIiwgbWV0aG9kKQogICAgICAgICAgICAgICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICB9CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9yZXF1aXJlc0F1dGhlbnRpY2F0aW9uUGFyYW0gPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgIHJldHVybiBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT01QTEVURV9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNMRUFSX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVKRUNUX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RBU0tfQ09OVEFDVDsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVBhcmFtcyA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zKSB7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OOgogICAgICAgICAgICBwYXJhbXMuY29uZmlndXJhdGlvbiA9IHRoaXMuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbihwYXJhbXMuY29uZmlndXJhdGlvbik7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9NRVRSSUNTOgogICAgICAgICAgICBwYXJhbXMuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MoCiAgICAgICAgICAgICAgICAgIHBhcmFtcy5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX1JFUE9SVDoKICAgICAgICAgICAgcGFyYW1zLnJlcG9ydCA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQocGFyYW1zLnJlcG9ydCk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9yZXF1aXJlc0F1dGhlbnRpY2F0aW9uUGFyYW0obWV0aG9kKSkgewogICAgICAgICBwYXJhbXMuYXV0aGVudGljYXRpb24gPSB7CiAgICAgICAgICAgIGF1dGhUb2tlbjogdGhpcy5hdXRoVG9rZW4KICAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICByZXR1cm4gewogICAgICAgICBuYW1lOiBjb25maWcubmFtZSwKICAgICAgICAgc29mdHBob25lRW5hYmxlZDogY29uZmlnLnNvZnRwaG9uZUVuYWJsZWQsCiAgICAgICAgIHNvZnRwaG9uZUF1dG9BY2NlcHQ6IGNvbmZpZy5zb2Z0cGhvbmVBdXRvQWNjZXB0LAogICAgICAgICBleHRlbnNpb246IGNvbmZpZy5leHRlbnNpb24sCiAgICAgICAgIHJvdXRpbmdQcm9maWxlOiB0aGlzLl90cmFuc2xhdGVSb3V0aW5nUHJvZmlsZShjb25maWcucm91dGluZ1Byb2ZpbGUpLAogICAgICAgICBhZ2VudFByZWZlcmVuY2VzOiBjb25maWcuYWdlbnRQcmVmZXJlbmNlcwogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUm91dGluZ1Byb2ZpbGUgPSBmdW5jdGlvbihwcm9maWxlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIG5hbWU6IHByb2ZpbGUubmFtZSwKICAgICAgICAgcm91dGluZ1Byb2ZpbGVBUk46IHByb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk4sCiAgICAgICAgIGRlZmF1bHRPdXRib3VuZFF1ZXVlOiB0aGlzLl90cmFuc2xhdGVRdWV1ZShwcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlKQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUXVldWUgPSBmdW5jdGlvbihxdWV1ZSkgewogICAgICByZXR1cm4gewogICAgICAgICBxdWV1ZUFSTjogICBxdWV1ZS5xdWV1ZUFSTiwKICAgICAgICAgbmFtZTogICAgICAgcXVldWUubmFtZQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgIHN0YXRzLmZvckVhY2goZnVuY3Rpb24oc3RhdCkgewogICAgICAgICBpZiAoJ3BhY2tldHNDb3VudCcgaW4gc3RhdCkgewogICAgICAgICAgICBzdGF0LnBhY2tldENvdW50ID0gc3RhdC5wYWNrZXRzQ291bnQ7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0LnBhY2tldHNDb3VudDsKICAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBzdGF0czsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgICAgaWYgKCdoYW5kc2hha2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQuaGFuZHNoYWtlVGltZU1pbGxpcyA9IHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ3ByZVRhbGtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LnByZVRhbGtUaW1lTWlsbGlzID0gcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ2hhbmRzaGFraW5nRmFpbHVyZScgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5oYW5kc2hha2VGYWlsdXJlID0gcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZTsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmU7CiAgICAgIH0KCiAgICAgIGlmICgndGFsa2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQudGFsa1RpbWVNaWxsaXMgPSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIHJlcG9ydC5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcygKICAgICAgICAgICAgcmVwb3J0LnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MpOwoKICAgICAgcmV0dXJuIHJlcG9ydDsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIFRhc2tUZW1wbGF0ZXNDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICovCiAgIHZhciBUYXNrVGVtcGxhdGVzQ2xpZW50ID0gZnVuY3Rpb24oZW5kcG9pbnQpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKTsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICBpZiAoZW5kcG9pbnQuaW5jbHVkZXMoJy90YXNrLXRlbXBsYXRlcycpKSB7CiAgICAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbChlbmRwb2ludCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgIHZhciBBV1NFbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICB2YXIgQ0ZQcmVmaXggPSBlbmRwb2ludC5pbmNsdWRlcygnLmF3c2FwcHMuY29tJykgPyAnL2Nvbm5lY3QnIDogJyc7CiAgICAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbChgJHtBV1NFbmRwb2ludC5ob3N0fSR7Q0ZQcmVmaXh9L3Rhc2stdGVtcGxhdGVzL2FwaS9jY3BgKTsKICAgICAgfQogICB9OwoKICAgVGFza1RlbXBsYXRlc0NsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVGFza1RlbXBsYXRlc0NsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUYXNrVGVtcGxhdGVzQ2xpZW50OwoKICAgVGFza1RlbXBsYXRlc0NsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWV0aG9kLCAnbWV0aG9kJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgJ3gtY3NyZi10b2tlbic6ICdjc3JmJyAgICAgICAgIAogICAgICAgICB9CiAgICAgIH07CiAgICAgIHZhciBpbnN0YW5jZUlkID0gcGFyYW1zLmluc3RhbmNlSWQ7CiAgICAgIHZhciB1cmwgPSB0aGlzLmVuZHBvaW50VXJsOwogICAgICB2YXIgbWV0aG9kcyA9IGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHM7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgICAgIGNhc2UgbWV0aG9kcy5MSVNUX1RBU0tfVEVNUExBVEVTOiAKICAgICAgICAgICAgdXJsICs9IGAvcHJveHkvaW5zdGFuY2UvJHtpbnN0YW5jZUlkfS90YXNrL3RlbXBsYXRlYDsKICAgICAgICAgICAgaWYgKHBhcmFtcy5xdWVyeVBhcmFtcykgewogICAgICAgICAgICAgICBjb25zdCBxdWVyeVN0cmluZyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMocGFyYW1zLnF1ZXJ5UGFyYW1zKS50b1N0cmluZygpOwogICAgICAgICAgICAgICBpZiAocXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgdXJsICs9IGA/JHtxdWVyeVN0cmluZ31gOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIGNhc2UgbWV0aG9kcy5HRVRfVEFTS19URU1QTEFURTogCiAgICAgICAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMudGVtcGxhdGVQYXJhbXMsICdwYXJhbXMudGVtcGxhdGVQYXJhbXMnKTsKICAgICAgICAgICAgY29uc3QgaWQgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnRlbXBsYXRlUGFyYW1zLmlkLCAncGFyYW1zLnRlbXBsYXRlUGFyYW1zLmlkJyk7CiAgICAgICAgICAgIGNvbnN0IHZlcnNpb24gPSBwYXJhbXMudGVtcGxhdGVQYXJhbXMudmVyc2lvbjsKICAgICAgICAgICAgdXJsICs9IGAvcHJveHkvaW5zdGFuY2UvJHtpbnN0YW5jZUlkfS90YXNrL3RlbXBsYXRlLyR7aWR9YDsKICAgICAgICAgICAgaWYgKHZlcnNpb24pIHsKICAgICAgICAgICAgICAgdXJsICs9IGA/c25hcHNob3RWZXJzaW9uPSR7dmVyc2lvbn1gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuQ1JFQVRFX1RFTVBMQVRFRF9UQVNLOiAKICAgICAgICAgICAgdXJsICs9IGAvJHttZXRob2R9YDsKICAgICAgICAgICAgb3B0aW9ucy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTsKICAgICAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAnUFVUJzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIGNhc2UgbWV0aG9kcy5VUERBVEVfQ09OVEFDVDogCiAgICAgICAgICAgIHVybCArPSBgLyR7bWV0aG9kfWA7CiAgICAgICAgICAgIG9wdGlvbnMuYm9keSA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7CiAgICAgICAgICAgIG9wdGlvbnMubWV0aG9kID0gJ1BPU1QnOwogICAgICB9CiAgICAgIGNvbm5lY3QuZmV0Y2godXJsLCBvcHRpb25zKQogICAgICAudGhlbihmdW5jdGlvbihyZXMpewogICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhyZXMpOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgICBjb25zdCByZWFkZXIgPSBlcnIuYm9keS5nZXRSZWFkZXIoKTsKICAgICAgICAgbGV0IGJvZHkgPSAnJzsKICAgICAgICAgY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpOwogICAgICAgICByZWFkZXIucmVhZCgpLnRoZW4oZnVuY3Rpb24gcHJvY2Vzc1RleHQoeyBkb25lLCB2YWx1ZSB9KSB7CiAgICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgICAgIHZhciBlcnJvciA9IEpTT04ucGFyc2UoYm9keSk7CiAgICAgICAgICAgICAgIGVycm9yLnN0YXR1cyA9IGVyci5zdGF0dXM7CiAgICAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yKTsKICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkgKz0gZGVjb2Rlci5kZWNvZGUodmFsdWUpOwogICAgICAgICAgICByZXR1cm4gcmVhZGVyLnJlYWQoKS50aGVuKHByb2Nlc3NUZXh0KTsKICAgICAgICAgfSk7CiAgICAgIH0pCiAgIH07CgogICBjb25uZWN0LkNsaWVudEJhc2UgPSBDbGllbnRCYXNlOwogICBjb25uZWN0Lk51bGxDbGllbnQgPSBOdWxsQ2xpZW50OwogICBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudCA9IFVwc3RyZWFtQ29uZHVpdENsaWVudDsKICAgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgPSBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQ7CiAgIGNvbm5lY3QuQVdTQ2xpZW50ID0gQVdTQ2xpZW50OwogICBjb25uZWN0LkFnZW50QXBwQ2xpZW50ID0gQWdlbnRBcHBDbGllbnQ7CiAgIGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudCA9IFRhc2tUZW1wbGF0ZXNDbGllbnQ7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4OTU6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICBjb25uZWN0LmNvcmUgPSB7fTsKICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICBjb25uZWN0LnZlcnNpb24gPSAiU1RSRUFNU19WRVJTSU9OIjsKICBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRSA9IDUwMDsKIAogIHZhciBDQ1BfU1lOX1RJTUVPVVQgPSAxMDAwOyAvLyAxIHNlYwogIHZhciBDQ1BfQUNLX1RJTUVPVVQgPSAzMDAwOyAvLyAzIHNlYwogIHZhciBDQ1BfTE9BRF9USU1FT1VUID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gMTAwMDA7IC8vMTAgcwogIHZhciBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQgPSA2OyAvLyA2IGF0dGVtcHRzCiAgdmFyIENDUF9JRlJBTUVfTkFNRSA9ICdBbWF6b24gQ29ubmVjdCBDQ1AnOwogCiAgdmFyIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTiA9ICJodHRwczovL3thbGlhc30uYXdzYXBwcy5jb20vYXV0aC8/Y2xpZW50X2lkPXtjbGllbnRfaWR9JnJlZGlyZWN0X3VyaT17cmVkaXJlY3R9IjsKICB2YXIgQ0xJRU5UX0lEX01BUCA9IHsKICAgICJ1cy1lYXN0LTEiOiAiMDY5MTlmNGZkOGVkMzI0ZSIKICB9OwogCiAgdmFyIEFVVEhPUklaRV9FTkRQT0lOVCA9ICIvYXV0aC9hdXRob3JpemUiOwogIHZhciBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UID0gIi9jb25uZWN0L2F1dGgvYXV0aG9yaXplIjsKICB2YXIgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgQVVUSE9SSVpFX01BWF9SRVRSWSA9IDU7CiAKICB2YXIgTEVHQUNZX1dISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL2Nvbm5lY3Qvd2hpdGVsaXN0ZWQtb3JpZ2lucyI7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkgPSA1OwoKICB2YXIgQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTID0gJ0lmcmFtZVJlZnJlc2hBdHRlbXB0cyc7CiAgdmFyIENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUyA9ICdJZnJhbWVJbml0aWFsaXphdGlvblN1Y2Nlc3MnOwogIHZhciBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1RJTUUgPSAnSWZyYW1lSW5pdGlhbGl6YXRpb25UaW1lJzsKCiAgdmFyIENPTk5FQ1RFRF9DQ1BTX1NJTkdMRV9UQUIgPSAnQ29ubmVjdGVkQ0NQU2luZ2xlVGFiQ291bnQnOwogIHZhciBDQ1BfVEFCU19BQ1JPU1NfQlJPV1NFUl9DT1VOVCA9ICdDQ1BUYWJzQWNyb3NzQnJvd3NlckNvdW50JzsKCiAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSAwOwogIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID0gMDsKCiAgY29ubmVjdC5jb3JlLk1BWF9BVVRIT1JJWkVfUkVUUllfQ09VTlRfRk9SX1NFU1NJT04gPSAzOwogIGNvbm5lY3QuY29yZS5NQVhfQ1RJX0FVVEhfUkVUUllfQ09VTlQgPSAxMDsKICBjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgPSAwOwogIGNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQgPSBudWxsOwogIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBudWxsOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNlc3Npb25TdG9yYWdlS2V5cwogICAqLwogIGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndGFiX2lkJywKICAgICdhdXRob3JpemVfcmV0cnlfY291bnQnLAogIF0pOwoKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFRoaXMgZnVuY3Rpb24gd2FzIG9ubHkgbWVhbnQgZm9yIGludGVybmFsIHVzZS4gCiAgICogVGhlIG5hbWUgaXMgbWlzbGVhZGluZyBmb3Igd2hhdCBpdCBzaG91bGQgZG8uCiAgICogSW50ZXJuYWxseSB3ZSBoYXZlIHJlcGxhY2VkIGl0cyB1c2FnZSB3aXRoIGBnZXRMb2dpblVybGAuCiAgICovCiAgdmFyIGNyZWF0ZUxvZ2luVXJsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIHJlZGlyZWN0ID0gImh0dHBzOi8vbGlseS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS90YXcvYXV0aC9jb2RlIjsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWRpcmVjdCk7CiAKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgbG9nLndhcm4oIlRoZSBgYWxpYXNgIHBhcmFtIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZXhwZWN0ZWQgdG8gZnVuY3Rpb24gcHJvcGVybHkuIFBsZWFzZSB1c2UgYGNjcFVybGAgb3IgYGxvZ2luVXJsYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWF6b24tY29ubmVjdC9hbWF6b24tY29ubmVjdC1zdHJlYW1zL2Jsb2IvbWFzdGVyL1JFQURNRS5tZCNjb25uZWN0Y29yZWluaXRjY3AgZm9yIHZhbGlkIHBhcmFtZXRlcnMuIik7CiAgICAgIHJldHVybiBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVwbGFjZXMgYGNyZWF0ZUxvZ2luVXJsYCwgYXMgdGhhdCBmdW5jdGlvbidzIG5hbWUgd2FzIG1pc2xlYWRpbmcuCiAgICogVGhlIGBwYXJhbXMuYWxpYXNgIHBhcmFtZXRlciBpcyBkZXByZWNhdGVkLiBQbGVhc2UgcmVmcmFpbiBmcm9tIHVzaW5nIGl0LgogICAqLwogIHZhciBnZXRMb2dpblVybCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciByZWRpcmVjdCA9ICJodHRwczovL2xpbHkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGF3L2F1dGgvY29kZSI7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVkaXJlY3QpOwogICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICByZXR1cm4gcGFyYW1zLmxvZ2luVXJsCiAgICB9IGVsc2UgaWYgKHBhcmFtcy5hbGlhcykgewogICAgICBsb2cud2FybigiVGhlIGBhbGlhc2AgcGFyYW0gaXMgZGVwcmVjYXRlZCBhbmQgc2hvdWxkIG5vdCBiZSBleHBlY3RlZCB0byBmdW5jdGlvbiBwcm9wZXJseS4gUGxlYXNlIHVzZSBgY2NwVXJsYCBvciBgbG9naW5VcmxgLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FtYXpvbi1jb25uZWN0L2FtYXpvbi1jb25uZWN0LXN0cmVhbXMvYmxvYi9tYXN0ZXIvUkVBRE1FLm1kI2Nvbm5lY3Rjb3JlaW5pdGNjcCBmb3IgdmFsaWQgcGFyYW1ldGVycy4iKTsKICAgICAgcmV0dXJuIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTgogICAgICAgIC5yZXBsYWNlKCJ7YWxpYXN9IiwgcGFyYW1zLmFsaWFzKQogICAgICAgIC5yZXBsYWNlKCJ7Y2xpZW50X2lkfSIsIENMSUVOVF9JRF9NQVBbInVzLWVhc3QtMSJdKQogICAgICAgIC5yZXBsYWNlKCJ7cmVkaXJlY3R9IiwgZ2xvYmFsLmVuY29kZVVSSUNvbXBvbmVudCgKICAgICAgICAgIHJlZGlyZWN0KSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcGFyYW1zLmNjcFVybDsKICAgIH0KICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogUmV0dXJucyBzY2hlbWU6Ly9ob3N0OnBvcnQgZm9yIGEgZ2l2ZW4gdXJsCiAgKi8KICBmdW5jdGlvbiBzYW5pdGl6ZURvbWFpbih1cmwpIHsKICAgIHZhciBkb21haW4gPSB1cmwubWF0Y2goL14oPzpodHRwcz86XC9cLyk/KD86W15AXG5dK0ApPyg/Ond3d1wuKT8oW146XC9cbj9dKykvaWcpOwogICAgcmV0dXJuIGRvbWFpbi5sZW5ndGggPyBkb21haW5bMF0gOiAiIjsKICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIFByaW50IGEgd2FybmluZyBtZXNzYWdlIGlmIHRoZSBDb25uZWN0IGNvcmUgaXMgbm90IGluaXRpYWxpemVkLgogICAgKi8KICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICAgIGxvZy53YXJuKCJDb25uZWN0IGNvcmUgYWxyZWFkeSBpbml0aWFsaXplZCwgb25seSBuZWVkcyB0byBiZSBpbml0aWFsaXplZCBvbmNlLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKIAogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogRElTQVNURVIgUkVDT1ZFUlkgCiAgKi8KICAKICB2YXIgbWFrZUFnZW50T2ZmbGluZSA9IGZ1bmN0aW9uKGFnZW50LCBjYWxsYmFja3MpIHsKICAgIHZhciBvZmZsaW5lU3RhdGUgPSBhZ2VudC5nZXRBZ2VudFN0YXRlcygpLmZpbmQoZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgIHJldHVybiBzdGF0ZS50eXBlID09PSBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk9GRkxJTkU7CiAgICB9KTsKICAgIGFnZW50LnNldFN0YXRlKG9mZmxpbmVTdGF0ZSwgY2FsbGJhY2tzKTsgICAKICB9CiAKICAvLyBTdXBwcmVzcyBDb250YWN0cyBmdW5jdGlvbiAKICAvLyBUaGlzIGlzIHVzZWQgYnkgRGlzYXN0ZXIgUmVjb3ZlcnkgYXMgYSBzYWZlZ3VhcmQgdG8gbm90IHN1cmZhY2UgaW5jb21pbmcgY2FsbHMvY2hhdHMgdG8gVUkKICAvLyAKICB2YXIgc3VwcHJlc3NDb250YWN0cyA9IGZ1bmN0aW9uIChpc1N1cHByZXNzZWQpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTaWduYWwgc2hhcmVkd29ya2VyIHRvIHNldCBjb250YWN0cyBzdXBwcmVzc29yIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgaXNTdXBwcmVzc2VkLCBjb25uZWN0LmNvcmUucmVnaW9uCiAgICApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNVUFBSRVNTLCB7CiAgICAgIHN1cHByZXNzOiBpc1N1cHByZXNzZWQKICAgIH0pOwogIH0KIAogIHZhciBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbSA9IGZ1bmN0aW9uKG9mZmxpbmUpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW0RJU0FTVEVSIFJFQ09WRVJZXSBTaWduYWwgc2hhcmVkd29ya2VyIHRvIHNldCBmb3JjZU9mZmxpbmUgdG8gJXMgZm9yIGluc3RhbmNlICVzLiIsIAogICAgICBvZmZsaW5lLCBjb25uZWN0LmNvcmUucmVnaW9uCiAgICApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIHsKICAgICAgb2ZmbGluZTogb2ZmbGluZQogICAgfSk7CiAgfQogCiAgLy8gRm9yY2UgdGhlIGluc3RhbmNlIHRvIGJlIG9mZmxpbmUuIAogIC8vIFRoaXMgdHJpZXMgdG8gZGlzY29ubmVjdCBhbGwgY29udGFjdHMgKEhhcmQgc3RvcCkKICAvLyBpZiBkdWUgdG8gYSBmYWlsdXJlICh0aGUgYmFja2VuZCBpcyBub3QgcmVhY2hhYmxlKSwgc2lnbmFsIHRoZSBzaGFyZWQgd29ya2VyIHRvIGZvcmNlX29mZmxpbmUgd2hlbiBpdCB3YWtlcyB1cCBhZ2FpbgogIC8vIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgcmFuIGZyb20gbmF0aXZlIENDUCBmb3IgZGlzY29ubmVjdGluZyBjaGF0cy4KICB2YXIgZm9yY2VPZmZsaW5lID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEF0dGVtcHRpbmcgdG8gZm9yY2UgaW5zdGFuY2UgJXMgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uKGFnZW50KSB7CiAgICAgIHZhciBjb250YWN0Q2xvc2VkID0gMDsKICAgICAgdmFyIGNvbnRhY3RzID0gYWdlbnQuZ2V0Q29udGFjdHMoKTsKICAgICAgaWYgKGNvbnRhY3RzLmxlbmd0aCkgewogICAgICAgIGNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24oY29udGFjdCkgCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuZGVzdHJveSh7CiAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiBhbGwgYWN0aXZlIGNvbnRhY3RzIGFyZSBjbG9zZWQKICAgICAgICAgICAgICAgIGlmICgrK2NvbnRhY3RDbG9zZWQgPT09IGNvbnRhY3RzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbShmYWxzZSk7CiAgICAgICAgICAgICAgICAgIC8vIEl0J3Mgb2sgaWYgd2UncmUgbm90IGFibGUgdG8gcHV0IHRoZSBhZ2VudCBvZmZsaW5lLiAKICAgICAgICAgICAgICAgICAgLy8gc2luY2Ugd2UncmUgc3VwcHJlc3NpbmcgdGhlIGFnZW50cyBjb250YWN0cyBhbHJlYWR5LiAKICAgICAgICAgICAgICAgICAgbWFrZUFnZW50T2ZmbGluZShhZ2VudCk7CiAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluc3RhbmNlICVzIGlzIG5vdyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgbG9nLndhcm4oIltEaXNhc3RlciBSZWNvdmVyeV0gQW4gZXJyb3Igb2NjdXJlZCB3aGlsZSBhdHRlbXB0aW5nIHRvIGZvcmNlIHRoaXMgaW5zdGFuY2UgdG8gb2ZmbGluZSBpbiByZWdpb24gJXMiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgbG9nLndhcm4oZXJyKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgLy8gc2lnbmFsIHRoZSBzaGFyZWR3b3JrZXIgdG8gY2FsbCBmb3JjZU9mZmxpbmUgYWdhaW4gd2hlbiBuZXR3b3JrIGNvbm5lY3Rpb24gCiAgICAgICAgICAgICAgICAvLyBoYXMgYmVlbiByZS1lc3RhYmxpc2hlZCAodGhpcyBoYXBwZW5zIGluIGNhc2Ugb2YgbmV0d29yayBvciBiYWNrZW5kIGZhaWx1cmVzKQogICAgICAgICAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0odHJ1ZSk7CiAgICAgICAgICAgIH19KTsKICAgICAgICAgIH0KICAgICAgICApICAgICAgICAKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbShmYWxzZSk7CiAgICAgICAgbWFrZUFnZW50T2ZmbGluZShhZ2VudCk7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5zdGFuY2UgJXMgaXMgbm93IG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICB9CiAKICAvL0luaXRpYXRlIERpc2FzdGVyIFJlY292ZXJ5IChUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBmcm9tIGN1c3RvbUNDUCB0aGF0IGFyZSBEUiBlbmFibGVkKQogIGNvbm5lY3QuY29yZS5pbml0RGlzYXN0ZXJSZWNvdmVyeSA9IGZ1bmN0aW9uKHBhcmFtcykgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBjb25uZWN0LmNvcmUucmVnaW9uID0gcGFyYW1zLnJlZ2lvbjsKICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzID0gc3VwcHJlc3NDb250YWN0czsgIAogICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSA9IGZvcmNlT2ZmbGluZTsKCiAgICAvL1JlZ2lzdGVyIGlmcmFtZSBsaXN0bmVyIHRvIHNldCBuYXRpdmUgQ0NQIG9mZmxpbmUKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU0VUX09GRkxJTkUsIGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICB9KTsKIAogICAgLy8gUmVnaXN0ZXIgRXZlbnQgbGlzdG5lciB0byBGb3JjZSB0aGUgQWdlbnQgdG8gYmUgb2ZmbGluZSB3aGVuIHNoYXJlZCB3b3JrZXIgcmVjb3ZlcnMgZnJvbSBuZXR3b3JrIGZhaWx1cmUKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICB9KTsKCiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluaXRpYWxpemluZyByZWdpb24gJXMgYXMgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwgCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGFscmVhZHkgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CgogICAgaWYgKCFwYXJhbXMuaXNQcmltYXJ5KSB7CiAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzKHRydWUpOwogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGluc3RhbmNlIGlzIHNldCB0byBzdGFuZC1ieSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyhmYWxzZSk7CiAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGluc3RhbmNlIGlzIHNldCB0byBwcmltYXJ5IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogQmFzaWMgQ29ubmVjdCBjbGllbnQgaW5pdGlhbGl6YXRpb24uCiAgICogU2hvdWxkIGJlIHVzZWQgb25seSBieSB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdFRhc2tUZW1wbGF0ZXNDbGllbnQocGFyYW1zKTsKICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IHRydWU7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplZCBBV1MgY2xpZW50CiAgICogU2hvdWxkIGJlIHVzZWQgYnkgU2hhcmVkIFdvcmtlciB0byB1cGRhdGUgQVdTIGNsaWVudCB3aXRoIG5ldyBjcmVkZW50aWFscwogICAqIGFmdGVyIHJlZnJlc2hlZCBhdXRoZW50aWNhdGlvbi4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENsaWVudCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKICAgIAogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIHJlZ2lvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVnaW9uLCAncGFyYW1zLnJlZ2lvbicpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLmVuZHBvaW50IHx8IG51bGw7CiAKICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5BV1NDbGllbnQoYXV0aFRva2VuLCByZWdpb24sIGVuZHBvaW50KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgQWdlbnRBcHAgY2xpZW50CiAgICogU2hvdWxkIGJlIHVzZWQgYnkgU2hhcmVkIFdvcmtlciB0byB1cGRhdGUgQWdlbnRBcHAgY2xpZW50IHdpdGggbmV3IGNyZWRlbnRpYWxzCiAgICogYWZ0ZXIgcmVmcmVzaGVkIGF1dGhlbnRpY2F0aW9uLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7ICAgIAogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIGF1dGhDb29raWVOYW1lID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoQ29va2llTmFtZSwgJ3BhcmFtcy5hdXRoQ29va2llTmFtZScpOwogICAgdmFyIGVuZHBvaW50ID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hZ2VudEFwcEVuZHBvaW50LCAncGFyYW1zLmFnZW50QXBwRW5kcG9pbnQnKTsKICAgIAogICAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbmV3IGNvbm5lY3QuQWdlbnRBcHBDbGllbnQoYXV0aENvb2tpZU5hbWUsIGF1dGhUb2tlbiwgZW5kcG9pbnQpOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplZCBUYXNrVGVtcGxhdGVzIGNsaWVudAogICAqLwogIGNvbm5lY3QuY29yZS5pbml0VGFza1RlbXBsYXRlc0NsaWVudCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy50YXNrVGVtcGxhdGVzRW5kcG9pbnQgfHwgcGFyYW1zLmVuZHBvaW50OwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAndGFza1RlbXBsYXRlc0VuZHBvaW50Jyk7CiAgICBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCA9IG5ldyBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnQoZW5kcG9pbnQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVW5pbml0aWFsaXplIENvbm5lY3QuCiAgICovCiAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBpZiAoYnVzKSBidXMudW5zdWJzY3JpYmVBbGwoKTsKICAgIGNvbm5lY3QuY29yZS5idXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gZmFsc2U7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFNldHVwIHRoZSBTb2Z0cGhvbmVNYW5hZ2VyIHRvIGJlIGluaXRpYWxpemVkIHdoZW4gdGhlIGFnZW50CiAgICogaXMgZGV0ZXJtaW5lZCB0byBoYXZlIHNvZnRwaG9uZSBlbmFibGVkLgogICAqLwogIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBudWxsOwogCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtOwogIH07CiAKICBjb25uZWN0LmNvcmUuc2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKHN0cmVhbSkgewogICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IHN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLmluaXRSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAicGFyYW1zIik7CiAKICAgIHZhciBzZXR1cFJpbmd0b25lRW5naW5lcyA9IGZ1bmN0aW9uIChyaW5ndG9uZVNldHRpbmdzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZVNldHRpbmdzLCAicmluZ3RvbmVTZXR0aW5ncyIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy52b2ljZSwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UiKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnZvaWNlLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjaywgInJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2siKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogCiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMgPSB7fTsKIAogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgIGFnZW50Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlJJTkdUT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy52b2ljZSkgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlKTsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlZvaWNlUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5jaGF0LmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLmNoYXQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLmNoYXQgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuQ2hhdFJpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MuY2hhdCk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDaGF0UmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy50YXNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2spIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVGFza1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MudGFzayk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2tSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnF1ZXVlX2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjayA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjayk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgaGFuZGxlUmluZ2VyRGV2aWNlQ2hhbmdlKCk7CiAgICB9OwogCiAgICB2YXIgbWVyZ2VQYXJhbXMgPSBmdW5jdGlvbiAocGFyYW1zLCBvdGhlclBhcmFtcykgewogICAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHk6IHN1cHBvcnQgcHVsbGluZyBkaXNhYmxlZCBmbGFnIGFuZCByaW5ndG9uZVVybAogICAgICAvLyBmcm9tIHNvZnRwaG9uZSBjb25maWcgaWYgaXQgZXhpc3RzIGZyb20gZG93bnN0cmVhbSBpbnRvIHRoZSByaW5ndG9uZSBjb25maWcuCiAgICAgIHBhcmFtcy5yaW5ndG9uZSA9IHBhcmFtcy5yaW5ndG9uZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gcGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0ID0gcGFyYW1zLnJpbmd0b25lLmNoYXQgfHwgeyBkaXNhYmxlZDogdHJ1ZSB9OwogICAgICBwYXJhbXMucmluZ3RvbmUudGFzayA9IHBhcmFtcy5yaW5ndG9uZS50YXNrIHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKIAogICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lKSB7CiAgICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZS5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2suZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmwpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjay5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICB9CiAgICAgIH0KIAogICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdCkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LmRpc2FibGVSaW5ndG9uZSkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdC5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLmNoYXQucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgLy8gTWVyZ2UgaW4gcmluZ3RvbmUgc2V0dGluZ3MgZnJvbSBkb3duc3RyZWFtLgogICAgICBpZiAob3RoZXJQYXJhbXMucmluZ3RvbmUpIHsKICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS52b2ljZSwKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjaywKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLmNoYXQsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHt9KTsKICAgICAgfQogICAgfTsKIAogICAgLy8gTWVyZ2UgcGFyYW1zIGZyb20gcGFyYW1zLnNvZnRwaG9uZSBhbmQgcGFyYW1zLmNoYXQgaW50byBwYXJhbXMucmluZ3RvbmUKICAgIC8vIGZvciBlbWJlZGRlZCBhbmQgbm9uLWVtYmVkZGVkIHVzZSBjYXNlcyBzbyB0aGF0IGRlZmF1bHRzIGFyZSBwaWNrZWQgdXAuCiAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIHBhcmFtcyk7CiAKICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgLy8gSWYgdGhlIENDUCBpcyBpbiBhIGZyYW1lLCB3YWl0IGZvciBjb25maWd1cmF0aW9uIGZyb20gZG93bnN0cmVhbS4KICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgLy8gTWVyZ2UgYWxsIHBhcmFtcyBmcm9tIGRhdGEgaW50byBwYXJhbXMgZm9yIGFueSBvdmVycmlkZGVuCiAgICAgICAgLy8gdmFsdWVzIGluIGVpdGhlciBsZWdhY3kgInNvZnRwaG9uZSIgb3IgInJpbmd0b25lIiBzZXR0aW5ncy4KICAgICAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIGRhdGEpOwogICAgICAgIHNldHVwUmluZ3RvbmVFbmdpbmVzKHBhcmFtcy5yaW5ndG9uZSk7CiAgICAgIH0pOwogCiAgICB9IGVsc2UgewogICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgfQogIH07CgogIHZhciBoYW5kbGVSaW5nZXJEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9SSU5HRVJfREVWSUNFLCBzZXRSaW5nZXJEZXZpY2UpOwogIH0KCiAgdmFyIHNldFJpbmdlckRldmljZSA9IGZ1bmN0aW9uIChkYXRhKXsKICAgIGlmKGNvbm5lY3Qua2V5cyhjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzKS5sZW5ndGggPT09IDAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgZm9yICh2YXIgcmluZ3RvbmVUeXBlIGluIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMpIHsKICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lc1tyaW5ndG9uZVR5cGVdLnNldE91dHB1dERldmljZShkZXZpY2VJZCk7CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICBjb25uZWN0LmNvcmUuaW5pdFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBpbml0U29mdHBob25lTWFuYWdlciBzdGFydGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKIAogICAgdmFyIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlID0gZnVuY3Rpb24gKHNvZnRwaG9uZVBhcmFtc0luKSB7CiAgICAgIHZhciBzb2Z0cGhvbmVQYXJhbXMgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5zb2Z0cGhvbmUgfHwge30sIHNvZnRwaG9uZVBhcmFtc0luKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBpZiAoIWFnZW50LmdldENoYW5uZWxDb25jdXJyZW5jeShjb25uZWN0LkNoYW5uZWxUeXBlLlZPSUNFKSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIHN1YiA9IHRoaXM7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gYWdlbnQgcmVmcmVzaCBoYW5kbGVyIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKIAogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGNvbmZpcm1lZCBhcyBzb2Z0cGhvbmUgbWFzdGVyIHRvcGljIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgaWYgKCFjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciAmJiBhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgIC8vIEJlY29tZSBtYXN0ZXIgdG8gc2VuZCBsb2dzLCBzaW5jZSB3ZSBuZWVkIGxvZ3MgZnJvbSBzb2Z0cGhvbmUgdGFiLgogICAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyKHNvZnRwaG9uZVBhcmFtcyk7CiAgICAgICAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH07CiAKICAgIC8qKgogICAgICogSWYgdGhlIHdpbmRvdyBpcyBmcmFtZWQsIHdlIG5lZWQgdG8gd2FpdCBmb3IgYSBDT05GSUdVUkUgbWVzc2FnZSBmcm9tCiAgICAgKiBkb3duc3RyZWFtIGJlZm9yZSB3ZSB0cnkgdG8gaW5pdGlhbGl6ZSwgdW5sZXNzIHBhcmFtcy5hbGxvd0ZyYW1lZFNvZnRwaG9uZSBpcyB0cnVlLgogICAgICovCiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmICFwYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gQ29uZmlndXJlIGV2ZW50IGhhbmRsZXIgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGlmIChkYXRhLnNvZnRwaG9uZSAmJiBkYXRhLnNvZnRwaG9uZS5hbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgICAgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUoZGF0YS5zb2Z0cGhvbmUpOwogICAgICAgICAgCiAgICAgICAgfQogICAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChkYXRhLnNvZnRwaG9uZSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUocGFyYW1zKTsKICAgICAgc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KHBhcmFtcyk7CiAgICB9CiAKICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgIC8vIFN5bmMgbXV0ZSBhY3Jvc3MgYWxsIHRhYnMgCiAgICAgIGlmIChhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSAmJiBhZ2VudC5nZXRDaGFubmVsQ29uY3VycmVuY3koY29ubmVjdC5DaGFubmVsVHlwZS5WT0lDRSkpIHsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULAogICAgICAgICAgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURQogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChzb2Z0cGhvbmVQYXJhbXNJbikgewogICAgICB2YXIgc29mdHBob25lUGFyYW1zID0gY29ubmVjdC5tZXJnZShwYXJhbXMuc29mdHBob25lIHx8IHt9LCBzb2Z0cGhvbmVQYXJhbXNJbik7CgogICAgICAvLyBrZWVwIHRoZSBzb2Z0cGhvbmUgcGFyYW1zIGZvciBleHRlcm5hbCB1c2UKICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyA9IHNvZnRwaG9uZVBhcmFtczsKCiAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSkgewogICAgICAgIC8vIEluIEZpcmVmb3gsIHdoZW4gYSB0YWIgdGFrZXMgb3ZlciBhbm90aGVyIHRhYidzIHNvZnRwaG9uZSBwcmltYXJ5LAogICAgICAgIC8vIHRoZSBwcmV2aW91cyBwcmltYXJ5IHRhYiBzaG91bGQgZGVsZXRlIHNvZnBob25lIG1hbmFnZXIgYW5kIHN0b3AgbWljcm9waG9uZQogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCBmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLmRhdGEgJiYgcmVzLmRhdGEudG9waWMgPT09IGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSAmJiByZXMuZGF0YS50YWtlT3ZlciAmJiAocmVzLmRhdGEubWFzdGVySWQgIT09IGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQpKSB7CiAgICAgICAgICAgIGlmIChjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcikgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLm9uSW5pdENvbnRhY3RTdWIudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgICBkZWxldGUgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVzZXJNZWRpYVN0cmVhbSA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKTsKICAgICAgICAgICAgaWYgKHVzZXJNZWRpYVN0cmVhbSkgewogICAgICAgICAgICAgIHVzZXJNZWRpYVN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKGZ1bmN0aW9uKHRyYWNrKSB7IHRyYWNrLnN0b3AoKTsgfSk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBJbiBGaXJlZm94LCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4sCiAgICAgICAgLy8gd2VicnRjIHNlc3Npb24gaXMgbm90IHN0YXJ0ZWQgdW50aWwgUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiBldmVudCBpcyB0cmlnZ2VyZWQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmIChjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcikgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLnN0YXJ0U2Vzc2lvbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyICYmIGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWFuYWdlcihzb2Z0cGhvbmVQYXJhbXMpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5zdGFydFNlc3Npb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gaGFuZGxpbmcgb3V0Ym91bmQtY2FsbCBhbmQgYXV0by1hY2NlcHQgY2FzZXMgZm9yIHBlbmRpbmcgc2Vzc2lvbgogICAgICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoYykgewogICAgICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICAgICAgYy5vblJlZnJlc2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICBjb25uZWN0Lmhhc090aGVyQ29ubmVjdGVkQ0NQcygpICYmCiAgICAgICAgICAgICAgICBkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgPT09ICd2aXNpYmxlJyAmJgogICAgICAgICAgICAgICAgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HIHx8IGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBpc091dEJvdW5kQ2FsbCA9IGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgIWNvbnRhY3QuaXNJbmJvdW5kKCk7CiAgICAgICAgICAgICAgICB2YXIgaXNBdXRvQWNjZXB0RW5hYmxlZCA9IGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgYWdlbnQuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUF1dG9BY2NlcHQ7CiAgICAgICAgICAgICAgICB2YXIgaXNRdWV1ZWRDYWxsYmFjayA9IGNvbnRhY3QuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLOwogICAgICAgICAgICAgICAgaWYgKGlzT3V0Qm91bmRDYWxsIHx8IGlzQXV0b0FjY2VwdEVuYWJsZWQgfHwgaXNRdWV1ZWRDYWxsYmFjaykgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUudHJpZ2dlclJlYWR5VG9TdGFydFNlc3Npb25FdmVudCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CgogIC8vIHRyaWdnZXIgUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiBldmVudCBpbiBhIGNvbnRleHQgd2l0aCBTb2Z0cGhvbmUgTWFuYWdlcgogIC8vIGludGVybmFsIHVzZSBvbmx5CiAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYWxsb3dGcmFtZWRTb2Z0cGhvbmUgPSBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zICYmIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmU7CiAgICBpZiAoY29ubmVjdC5pc0NDUCgpKSB7CiAgICAgIGlmIChhbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgIC8vIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgaW4gdGhpcyBpZnJhbWVkIENDUCBjb250ZXh0CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyBhbiBpZnJhbWVkIENDUCwgdGhlIGV2ZW50IGlzIHNlbmQgdG8gZG93bnN0cmVhbSAoQ1JNKQogICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZERvd25zdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBpZiB0aGlzIGlzIGEgc3RhbmRhbG9uZSBDQ1AsIHRyaWdnZXIgdGhpcyBldmVudCBpbiB0aGlzIENDUCBjb250ZXh0CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChhbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICAgIC8vIHRoZSBldmVudCBpcyBzZW5kIHRvIHRoZSB1cHN0cmVhbSAoaWZyYW1lZCBDQ1ApCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIGluIHRoaXMgQ1JNIGNvbnRleHQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfQogICAgfQogIH07CgogIGNvbm5lY3QuY29yZS5pbml0UGFnZU9wdGlvbnMgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAicGFyYW1zIik7CiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIC8vIElmIHRoZSBDQ1AgaXMgaW4gYSBmcmFtZSwgd2FpdCBmb3IgY29uZmlndXJhdGlvbiBmcm9tIGRvd25zdHJlYW0uCiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgICAgIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5DT05GSUdVUkUsCiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgIH0pOwogICAgICB9KTsKICAgICAgLy8gTGlzdGVuIGZvciBpZnJhbWUgbWVkaWEgZGV2aWNlcyByZXF1ZXN0IGZyb20gQ1JNCiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFUVVFU1QsIGZ1bmN0aW9uICgpIHsKICAgICAgICBmdW5jdGlvbiBzZW5kRGV2aWNlcyhkZXZpY2VzKSB7CiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVTUE9OU0UsIGRldmljZXMpOwogICAgICAgIH0KICAgICAgICBpZiAobmF2aWdhdG9yICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpCiAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGV2aWNlc0luKSB7CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzSW4gfHwgW107CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzLm1hcChmdW5jdGlvbihkKSB7IHJldHVybiBkLnRvSlNPTigpIH0pOwogICAgICAgICAgICBzZW5kRGV2aWNlcyhkZXZpY2VzKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBzZW5kRGV2aWNlcyh7ZXJyb3I6IGVyci5tZXNzYWdlfSk7CiAgICAgICAgICB9KTsgCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbmREZXZpY2VzKHtlcnJvcjogIk5vIG5hdmlnYXRvciBvciBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzIG9iamVjdCBmb3VuZCJ9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBHZXQgdGhlIGxpc3Qgb2YgbWVkaWEgZGV2aWNlcyBmcm9tIGlmcmFtZWQgQ0NQCiAgICogVGltZW91dCBmb3IgdGhlIHJlcXVlc3QgaXMgcGFzc2VkIGFuIGFuIG9wdGlvbmFsIGFyZ3VtZW50CiAgICogVGhlIGRlZmF1bHQgdGltZW91dCBpcyAxMDAwbXMKICAgKi8KICBjb25uZWN0LmNvcmUuZ2V0RnJhbWVNZWRpYURldmljZXMgPSBmdW5jdGlvbiAodGltZW91dEluKSB7CiAgICB2YXIgc3ViID0gbnVsbDsKICAgIHZhciB0aW1lb3V0ID0gdGltZW91dEluIHx8IDEwMDA7CiAgICB2YXIgdGltZW91dFByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyAKICAgICAgICByZWplY3QobmV3IEVycm9yKCJUaW1lb3V0IGV4Y2VlZGVkIikpOyAKICAgICAgfSwgdGltZW91dCk7CiAgICB9KTsKICAgIHZhciBtZWRpYURldmljZXNQcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgeyAKICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSB8fCBjb25uZWN0LmlzQ0NQKCkpIHsKICAgICAgICBpZiAobmF2aWdhdG9yICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMpIHsKICAgICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpCiAgICAgICAgICAudGhlbihmdW5jdGlvbiAoZGV2aWNlc0luKSB7CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzSW4gfHwgW107CiAgICAgICAgICAgIGRldmljZXMgPSBkZXZpY2VzLm1hcChmdW5jdGlvbiAoZCkgeyByZXR1cm4gZC50b0pTT04oKSB9KTsKICAgICAgICAgICAgcmVzb2x2ZShkZXZpY2VzKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWplY3QobmV3IEVycm9yKCJObyBuYXZpZ2F0b3Igb3IgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBvYmplY3QgZm91bmQiKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgICBzdWIgPSBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVNQT05TRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoZGF0YS5lcnJvcikpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFUVVFU1QpOwogICAgICB9CiAgICB9KQogICAgcmV0dXJuIFByb21pc2UucmFjZShbbWVkaWFEZXZpY2VzUHJvbWlzZSwgdGltZW91dFByb21pc2VdKQogICAgLmZpbmFsbHkoZnVuY3Rpb24gKCkgewogICAgICBpZiAoc3ViKSB7CiAgICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgLy9JbnRlcm5hbCB1c2Ugb25seS4KICBjb25uZWN0LmNvcmUuYXV0aG9yaXplID0gZnVuY3Rpb24gKGVuZHBvaW50KSB7CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJwogICAgfTsKCiAgICB2YXIgYXV0aG9yaXplRW5kcG9pbnQgPSBlbmRwb2ludDsKICAgIGlmICghYXV0aG9yaXplRW5kcG9pbnQpIHsKICAgICAgYXV0aG9yaXplRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKQogICAgICAgID8gTEVHQUNZX0FVVEhPUklaRV9FTkRQT0lOVAogICAgICAgIDogQVVUSE9SSVpFX0VORFBPSU5UOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2goYXV0aG9yaXplRW5kcG9pbnQsIG9wdGlvbnMsIEFVVEhPUklaRV9SRVRSWV9JTlRFUlZBTCwgQVVUSE9SSVpFX01BWF9SRVRSWSk7CiAgfTsKIAogIC8qKgogICAqIEBkZXByZWNhdGVkCiAgICogVGhpcyB1c2VkIHRvIGJlIHVzZWQgaW50ZXJuYWxseSwgYnV0IGlzIG5vIGxvbmdlciBuZWVkZWQuCiAgICovCiAgY29ubmVjdC5jb3JlLnZlcmlmeURvbWFpbkFjY2VzcyA9IGZ1bmN0aW9uIChhdXRoVG9rZW4sIGVuZHBvaW50KSB7CiAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoaXMgQVBJIHdpbGwgYmUgZGVwcmVjYXRlZCBpbiB0aGUgbmV4dCBtYWpvciB2ZXJzaW9uIHJlbGVhc2UiKTsKICAgIGlmICghY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICAgIH0KICAgIHZhciBvcHRpb25zID0gewogICAgICBoZWFkZXJzOiB7CiAgICAgICAgJ1gtQW16LUJlYXJlcic6IGF1dGhUb2tlbgogICAgICB9CiAgICB9OwogICAgdmFyIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gbnVsbDsKICAgIGlmIChlbmRwb2ludCl7CiAgICAgIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICB9CiAgICBlbHNlIHsKICAgICAgd2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKSAKICAgICAgICA/IExFR0FDWV9XSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UCiAgICAgICAgOiBXSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UOwogICAgfQogICAgCiAgICByZXR1cm4gY29ubmVjdC5mZXRjaCh3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCwgb3B0aW9ucywgV0hJVEVMSVNURURfT1JJR0lOU19SRVRSWV9JTlRFUlZBTCwgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciB0b3BEb21haW4gPSBzYW5pdGl6ZURvbWFpbih3aW5kb3cuZG9jdW1lbnQucmVmZXJyZXIpOwogICAgICB2YXIgaXNBbGxvd2VkID0gcmVzcG9uc2Uud2hpdGVsaXN0ZWRPcmlnaW5zLnNvbWUoZnVuY3Rpb24gKG9yaWdpbikgewogICAgICAgIHJldHVybiB0b3BEb21haW4gPT09IHNhbml0aXplRG9tYWluKG9yaWdpbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gaXNBbGxvd2VkID8gUHJvbWlzZS5yZXNvbHZlKCkgOiBQcm9taXNlLnJlamVjdCgpOwogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGlzIHdpbmRvdydzIGhyZWYgaXMgb24gdGhlIGxlZ2FjeSBjb25uZWN0IGRvbWFpbi4gCiAgICogT25seSB1c2VmdWwgZm9yIGludGVybmFsIHVzZS4gCiAgICovCiAgY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluID0gZnVuY3Rpb24odXJsKSB7CiAgICB1cmwgPSB1cmwgfHwgd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gdXJsLmluY2x1ZGVzKCcuYXdzYXBwcy5jb20nKTsKICB9CiAKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgY3JlYXRpbmcgb3IgY29ubmVjdGluZyB0byB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICogVXNlZCBvbmx5IGJ5IHRoZSBDQ1AKICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdFNoYXJlZFdvcmtlciA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkKCk7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKIAogICAgdmFyIHNoYXJlZFdvcmtlclVybCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuc2hhcmVkV29ya2VyVXJsLCAncGFyYW1zLnNoYXJlZFdvcmtlclVybCcpOwogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIHJlZnJlc2hUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVmcmVzaFRva2VuLCAncGFyYW1zLnJlZnJlc2hUb2tlbicpOwogICAgdmFyIGF1dGhUb2tlbkV4cGlyYXRpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24sICdwYXJhbXMuYXV0aFRva2VuRXhwaXJhdGlvbicpOwogICAgdmFyIHJlZ2lvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVnaW9uLCAncGFyYW1zLnJlZ2lvbicpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLmVuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgYXV0aG9yaXplRW5kcG9pbnQgPSBwYXJhbXMuYXV0aG9yaXplRW5kcG9pbnQ7CiAgICBpZiAoIWF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICAgIGF1dGhvcml6ZUVuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkKICAgICAgICA/IExFR0FDWV9BVVRIT1JJWkVfRU5EUE9JTlQKICAgICAgICA6IEFVVEhPUklaRV9FTkRQT0lOVDsKICAgIH0KICAgIHZhciBhZ2VudEFwcEVuZHBvaW50ID0gcGFyYW1zLmFnZW50QXBwRW5kcG9pbnQgfHwgbnVsbDsKICAgIHZhciB0YXNrVGVtcGxhdGVzRW5kcG9pbnQgPSBwYXJhbXMudGFza1RlbXBsYXRlc0VuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgYXV0aENvb2tpZU5hbWUgPSBwYXJhbXMuYXV0aENvb2tpZU5hbWUgfHwgbnVsbDsKIAogICAgdHJ5IHsKICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXZlbnQgYnVzIGFuZCBhZ2VudCBkYXRhIHByb3ZpZGVycy4KICAgICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IHRydWUgfSk7CiAgICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKICAgICAgCiAgICAgIC8vIENyZWF0ZSB0aGUgc2hhcmVkIHdvcmtlciBhbmQgdXBzdHJlYW0gY29uZHVpdC4KICAgICAgdmFyIHdvcmtlciA9IG5ldyBTaGFyZWRXb3JrZXIoc2hhcmVkV29ya2VyVXJsLCAiQ29ubmVjdFNoYXJlZFdvcmtlciIpOwogICAgICB2YXIgY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkNvbm5lY3RTaGFyZWRXb3JrZXJDb25kdWl0IiwKICAgICAgICBuZXcgY29ubmVjdC5Qb3J0U3RyZWFtKHdvcmtlci5wb3J0KSwKICAgICAgICBuZXcgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSh3aW5kb3csIHBhcmVudCkpOwogCiAgICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gY29uZHVpdDsKICAgICAgY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyID0gbmV3IFdlYlNvY2tldFByb3ZpZGVyKCk7CiAKICAgICAgLy8gQ2xvc2Ugb3VyIHBvcnQgdG8gdGhlIHNoYXJlZCB3b3JrZXIgYmVmb3JlIHRoZSB3aW5kb3cgY2xvc2VzLgogICAgICBnbG9iYWwub251bmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ0xPU0UpOwogICAgICAgIHdvcmtlci5wb3J0LmNsb3NlKCk7CiAgICAgIH07CiAKICAgICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtTG9nUHVzaChjb25kdWl0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZURvd25zdHJlYW1DbGllbnRTaWRlTG9nc1B1c2goKTsKICAgICAgLy8gQnJpZGdlIGFsbCB1cHN0cmVhbSBtZXNzYWdlcyBpbnRvIHRoZSBldmVudCBidXMuCiAgICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAgICAgIC8vIFBhc3MgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIChmcm9tIHNoYXJlZCB3b3JrZXIpIGRvd25zdHJlYW0gKHRvIENDUCBjb25zdW1lcikuCiAgICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25kdWl0LnBhc3NEb3duc3RyZWFtKCkpOwoKICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAgIC8vIEJyaWRnZSBhbGwgZG93bnN0cmVhbSBtZXNzYWdlcyBpbnRvIHRoZSBldmVudCBidXMuCiAgICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogICAgICAgIC8vIFBhc3MgYWxsIGRvd25zdHJlYW0gbWVzc2FnZXMgKGZyb20gQ0NQIGNvbnN1bWVyKSB1cHN0cmVhbSAodG8gc2hhcmVkIHdvcmtlcikuCiAgICAgICAgY29uZHVpdC5vbkFsbERvd25zdHJlYW0oY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAgICAgIH0KCiAgICAgIC8vIFNlbmQgY29uZmlndXJhdGlvbiB1cCB0byB0aGUgc2hhcmVkIHdvcmtlci4KICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCB7CiAgICAgICAgYXV0aFRva2VuOiBhdXRoVG9rZW4sCiAgICAgICAgYXV0aFRva2VuRXhwaXJhdGlvbjogYXV0aFRva2VuRXhwaXJhdGlvbiwKICAgICAgICBlbmRwb2ludDogZW5kcG9pbnQsCiAgICAgICAgcmVmcmVzaFRva2VuOiByZWZyZXNoVG9rZW4sCiAgICAgICAgcmVnaW9uOiByZWdpb24sCiAgICAgICAgYXV0aG9yaXplRW5kcG9pbnQ6IGF1dGhvcml6ZUVuZHBvaW50LAogICAgICAgIGFnZW50QXBwRW5kcG9pbnQ6IGFnZW50QXBwRW5kcG9pbnQsCiAgICAgICAgdGFza1RlbXBsYXRlc0VuZHBvaW50OiB0YXNrVGVtcGxhdGVzRW5kcG9pbnQsCiAgICAgICAgYXV0aENvb2tpZU5hbWU6IGF1dGhDb29raWVOYW1lLAogICAgICAgIGxvbmdQb2xsaW5nT3B0aW9uczogcGFyYW1zLmxvbmdQb2xsaW5nT3B0aW9ucyB8fCB1bmRlZmluZWQKICAgICAgfSk7CiAKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQWNrbm93bGVkZ2VkIGJ5IHRoZSBDb25uZWN0U2hhcmVkV29ya2VyISIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICBjb25uZWN0LmNvcmUuX3NldFRhYklkKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLnBvcnRTdHJlYW1JZCA9IGRhdGEuaWQ7CiAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICB9KTsKICAgICAgLy8gQWRkIGFsbCB1cHN0cmVhbSBsb2cgZW50cmllcyB0byBvdXIgb3duIGxvZ2dlci4KICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgICAgaWYgKGxvZ0VudHJ5LmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy8gR2V0IHdvcmtlciBsb2dzCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLnNlbmRJbnRlcm5hbExvZ0VudHJ5VG9TZXJ2ZXIoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgIH0pOwogICAgICAvLyBHZXQgb3V0ZXIgY29udGV4dCBsb2dzCiAgICAgIGNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIGZ1bmN0aW9uIChsb2dzKSB7CiAgICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiBBcnJheS5pc0FycmF5KGxvZ3MpKSB7CiAgICAgICAgICBsb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLnNlbmRJbnRlcm5hbExvZ0VudHJ5VG9TZXJ2ZXIoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZykpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgLy8gR2V0IGxvZyBmcm9tIG91dGVyIGNvbnRleHQKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nKSB7CiAgICAgICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiBsb2cubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgeyAKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZykpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBjb25uZWN0LmNvcmUub25BdXRoRmFpbChjb25uZWN0LmhpdGNoKGNvbm5lY3QuY29yZSwgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRoRmFpbCwgcGFyYW1zLmxvZ2luRW5kcG9pbnQgfHwgbnVsbCwgYXV0aG9yaXplRW5kcG9pbnQpKTsgLy8gRm9yIGF1dGggcmV0cnkgbG9naWMgb24gNDAxcy4KICAgICAgY29ubmVjdC5jb3JlLm9uQXV0aG9yaXplU3VjY2Vzcyhjb25uZWN0LmhpdGNoKGNvbm5lY3QuY29yZSwgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVTdWNjZXNzKSk7IC8vIEZvciBhdXRoIHJldHJ5IGxvZ2ljIG9uIDQwMXMuCgogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlVzZXIgQWdlbnQ6ICIgKyBuYXZpZ2F0b3IudXNlckFnZW50KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImlzQ0NQdjI6ICIgKyB0cnVlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImlzRnJhbWVkOiAiICsgY29ubmVjdC5pc0ZyYW1lZCgpKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0ub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk9VVEVSX0NPTlRFWFRfSU5GTywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgc3RyZWFtc1ZlcnNpb24gPSBkYXRhLnN0cmVhbXNWZXJzaW9uOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiU3RyZWFtc0pTIFZlcnNpb246ICIgKyBzdHJlYW1zVmVyc2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiTnVtYmVyIG9mIGNvbm5lY3RlZCBDQ1BzIHVwZGF0ZWQ6ICIgKyBkYXRhLmxlbmd0aCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA9IGRhdGEubGVuZ3RoOwogICAgICAgIGlmIChkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0gJiYgIWlzTmFOKGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXS5sZW5ndGgpKXsKICAgICAgICAgIGlmIChjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiAhPT0gZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdLmxlbmd0aCkgewogICAgICAgICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiA9IGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXS5sZW5ndGg7CiAgICAgICAgICAgIGlmIChjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiA+IDEpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoZXJlIGFyZSAiICsgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgKyAiIGNvbm5lY3RlZCBDQ1BzIGluIHRoaXMgdGFiLiBQbGVhc2UgYWRqdXN0IHlvdXIgaW1wbGVtZW50YXRpb24gdG8gYXZvaWQgY29tcGxpY2F0aW9ucy4gSWYgeW91IGFyZSBlbWJlZGRpbmcgQ0NQLCBwbGVhc2UgZG8gc28gZXhjbHVzaXZlbHkgd2l0aCBpbml0Q0NQLiBJbml0Q0NQIHdpbGwgbm90IGxldCB5b3UgZW1iZWQgbW9yZSB0aGFuIG9uZSBDQ1AuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICAgIG5hbWU6IENPTk5FQ1RFRF9DQ1BTX1NJTkdMRV9UQUIsCiAgICAgICAgICAgICAgZGF0YTogeyBjb3VudDogY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWJ9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGF0YS50YWJJZCAmJiBkYXRhLnN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlcikgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5NRVRSSUNTLCAoKSA9PgogICAgICAgICAgICBjb25uZWN0LmFnZW50KCgpID0+IGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgICAgbmFtZTogQ0NQX1RBQlNfQUNST1NTX0JST1dTRVJfQ09VTlQsCiAgICAgICAgICAgICAgZGF0YTogeyB0YWJJZDogZGF0YS50YWJJZCwgY291bnQ6IGRhdGEuc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyIH0KICAgICAgICAgICAgfSkpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogCiAgICAgIC8vIFBhc3MgdGhlIFRFUk1JTkFURSByZXF1ZXN0IHVwc3RyZWFtIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFLAogICAgICAgIGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogCiAgICAgIC8vIFJlZnJlc2ggdGhlIHBhZ2Ugd2hlbiB3ZSByZWNlaXZlIHRoZSBURVJNSU5BVEVEIHJlc3BvbnNlIGZyb20gdGhlCiAgICAgIC8vIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVELCBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCh0cnVlKTsKICAgICAgfSk7CiAKICAgICAgd29ya2VyLnBvcnQuc3RhcnQoKTsKCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LlZvaWNlSWRFdmVudHMuVVBEQVRFX0RPTUFJTl9JRCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmRvbWFpbklkKSB7CiAgICAgICAgICBjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkID0gZGF0YS5kb21haW5JZDsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gdHJ5IGZldGNoaW5nIHZvaWNlSWQncyBkb21haW5JZCBvbmNlIHRoZSBhZ2VudCBpcyBpbml0aWFsaXplZAogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgdm9pY2VJZCA9IG5ldyBjb25uZWN0LlZvaWNlSWQoKTsKICAgICAgICB2b2ljZUlkLmdldERvbWFpbklkKCkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidm9pY2VJZCBkb21haW5JZCBzdWNjZXNzZnVsbHkgZmV0Y2hlZCBhdCBhZ2VudCBpbml0aWFsaXphdGlvbjogIiArIGRvbWFpbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJ2b2ljZUlkIGRvbWFpbklkIG5vdCBmZXRjaGVkIGF0IGFnZW50IGluaXRpYWxpemF0aW9uIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9KTsKICAgICAgfSk7CiAKICAgICAgLy8gQXR0ZW1wdCB0byBnZXQgcGVybWlzc2lvbiB0byBzaG93IG5vdGlmaWNhdGlvbnMuCiAgICAgIHZhciBubSA9IGNvbm5lY3QuY29yZS5nZXROb3RpZmljYXRpb25NYW5hZ2VyKCk7CiAgICAgIG5tLnJlcXVlc3RQZXJtaXNzaW9uKCk7CiAKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLklOSVRfRElTQVNURVJfUkVDT1ZFUlksIGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIGNvbm5lY3QuY29yZS5pbml0RGlzYXN0ZXJSZWNvdmVyeShwYXJhbXMpOwogICAgICB9KQogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gaW5pdGlhbGl6ZSB0aGUgQVBJIHNoYXJlZCB3b3JrZXIsIHdlJ3JlIGRlYWQhIikKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIGNvbm5lY3QuY29yZS5fc2V0VGFiSWQgPSBmdW5jdGlvbigpIHsKICAgIHRyeSB7CiAgICAgIGNvbm5lY3QuY29yZS50YWJJZCA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLlRBQl9JRCk7CiAgICAgIGlmICghY29ubmVjdC5jb3JlLnRhYklkKXsKICAgICAgICBjb25uZWN0LmNvcmUudGFiSWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CiAgICAgICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuVEFCX0lELCBjb25uZWN0LmNvcmUudGFiSWQpOwogICAgICB9CiAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEFCX0lELCB7dGFiSWQ6IGNvbm5lY3QuY29yZS50YWJJZH0pOwogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIltUYWIgSWRdIFRoZXJlIHdhcyBhbiBpc3N1ZSBzZXR0aW5nIHRoZSB0YWIgSWQiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgY3JlYXRpbmcgb3IgY29ubmVjdGluZyB0byB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICogSW5pdGlhbGl6ZXMgQ29ubmVjdCBieSBsb2FkaW5nIHRoZSBDQ1AgaW4gYW4gaWZyYW1lIGFuZCBjb25uZWN0aW5nIHRvIGl0LgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0Q0NQID0gZnVuY3Rpb24gKGNvbnRhaW5lckRpdiwgcGFyYW1zSW4pIHsKICAgIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkKCk7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiSWZyYW1lIGluaXRpYWxpemF0aW9uIHN0YXJ0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgdmFyIGluaXRTdGFydFRpbWUgPSBEYXRlLm5vdygpOwogICAgLy8gQ2hlY2sgaWYgQ0NQIGlmcmFtZSBoYXMgYWxyZWFkeSBiZWVuIGluaXRpYWxpemVkIHRocm91Z2ggaW5pdENDUAogICAgdHJ5IHsKICAgICAgaWYgKGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lKCkpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoJ0F0dGVtcHRlZCB0byBjYWxsIGluaXRDQ1Agd2hlbiBhbiBpZnJhbWUgZ2VuZXJhdGVkIGJ5IGluaXRDQ1AgYWxyZWFkeSBleGlzdHMnKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCdFcnJvciB3aGlsZSBjaGVja2luZyBpZiBpbml0Q0NQIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkJykud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogCiAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHdoZW4gaW5zdGVhZCBvZiB0YWtpbmcgYSBwYXJhbXMgb2JqZWN0CiAgICAvLyBhcyBpbnB1dCB3ZSBvbmx5IGFjY2VwdGVkIGNjcFVybC4KICAgIHZhciBwYXJhbXMgPSB7fTsKICAgIGlmICh0eXBlb2YgKHBhcmFtc0luKSA9PT0gJ3N0cmluZycpIHsKICAgICAgcGFyYW1zLmNjcFVybCA9IHBhcmFtc0luOwogICAgfSBlbHNlIHsKICAgICAgcGFyYW1zID0gcGFyYW1zSW47CiAgICB9CiAKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWluZXJEaXYsICdjb250YWluZXJEaXYnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuY2NwVXJsLCAncGFyYW1zLmNjcFVybCcpOwogCiAgICAvLyBDcmVhdGUgdGhlIENDUCBpZnJhbWUgYW5kIGFwcGVuZCBpdCB0byB0aGUgY29udGFpbmVyIGRpdi4KICAgIHZhciBpZnJhbWUgPSBjb25uZWN0LmNvcmUuX2NyZWF0ZUNDUElmcmFtZShjb250YWluZXJEaXYsIHBhcmFtcyk7CgogICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXZlbnQgYnVzIGFuZCBhZ2VudCBkYXRhIHByb3ZpZGVycy4KICAgIC8vIE5PVEU6IFNldHRpbmcgbG9nRXZlbnRzIGhlcmUgdG8gRkFMU0UgaW4gb3JkZXIgdG8gYXZvaWQgZHVwbGljYXRpbmcKICAgIC8vIGV2ZW50cyB3aGljaCBhcmUgbG9nZ2VkIGluIENDUC4KICAgIGNvbm5lY3QuY29yZS5ldmVudEJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKHsgbG9nRXZlbnRzOiBmYWxzZSB9KTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5ID0gbmV3IGNvbm5lY3QuTWVkaWFGYWN0b3J5KHBhcmFtcyk7CiAKICAgIC8vIEJ1aWxkIHRoZSB1cHN0cmVhbSBjb25kdWl0IGNvbW11bmljYXRpbmcgd2l0aCB0aGUgQ0NQIGlmcmFtZS4KICAgIHZhciBjb25kdWl0ID0gbmV3IGNvbm5lY3QuSUZyYW1lQ29uZHVpdChwYXJhbXMuY2NwVXJsLCB3aW5kb3csIGlmcmFtZSk7CiAKICAgIC8vIExldCBDQ1Aga25vdyBpZiBpZnJhbWUgaXMgdmlzaWJsZQogICAgY29ubmVjdC5jb3JlLl9zZW5kSWZyYW1lU3R5bGVEYXRhVXBzdHJlYW1BZnRlclJlYXNvbmFibGVXYWl0VGltZShpZnJhbWUsIGNvbmR1aXQpOwogCiAgICAvLyBTZXQgdGhlIGdsb2JhbCB1cHN0cmVhbSBjb25kdWl0IGZvciBleHRlcm5hbCB1c2UuCiAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBjb25kdWl0OwogCiAgICAvLyBJbml0IHdlYlNvY2tldFByb3ZpZGVyCiAgICBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXIgPSBuZXcgV2ViU29ja2V0UHJvdmlkZXIoKTsKIAogICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKIAogICAgLy8gSW5pdGlhbGl6ZSB0aGUga2VlcGFsaXZlIG1hbmFnZXIuCiAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlciA9IG5ldyBLZWVwYWxpdmVNYW5hZ2VyKGNvbmR1aXQsCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLAogICAgICBwYXJhbXMuY2NwU3luVGltZW91dCB8fCBDQ1BfU1lOX1RJTUVPVVQsCiAgICAgIHBhcmFtcy5jY3BBY2tUaW1lb3V0IHx8IENDUF9BQ0tfVElNRU9VVCkKICAgICAgOwogICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID0gbnVsbDsKIAogICAgLy8gQWxsb3cgNSBzZWMgKGRlZmF1bHQpIGJlZm9yZSByZWNlaXZpbmcgdGhlIGZpcnN0IEFDSyBmcm9tIHRoZSBDQ1AuCiAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VUKTsKICAgIH0sIHBhcmFtcy5jY3BMb2FkVGltZW91dCB8fCBDQ1BfTE9BRF9USU1FT1VUKTsKCiAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BMb2dzUHVzaChjb25kdWl0KTsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1B1c2goY29uZHVpdCk7CiAKICAgIC8vIE9uY2Ugd2UgcmVjZWl2ZSB0aGUgZmlyc3QgQUNLLCBzZXR1cCBvdXIgdXBzdHJlYW0gQVBJIGNsaWVudCBhbmQgZXN0YWJsaXNoCiAgICAvLyB0aGUgU1lOL0FDSyByZWZyZXNoIGZsb3cuCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQWNrbm93bGVkZ2VkIGJ5IHRoZSBDQ1AhIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLnBvcnRTdHJlYW1JZCA9IGRhdGEuaWQ7CgogICAgICBpZiAocGFyYW1zLnNvZnRwaG9uZSB8fCBwYXJhbXMuY2hhdCB8fCBwYXJhbXMucGFnZU9wdGlvbnMgfHwgcGFyYW1zLnNob3VsZEFkZE5hbWVzcGFjZVRvTG9ncykgewogICAgICAgIC8vIFNlbmQgY29uZmlndXJhdGlvbiB1cCB0byB0aGUgQ0NQLgogICAgICAgIC8vc2V0IGl0IHRvIGZhbHNlIGlmIHNlY29uZGFyeQogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgICAgc29mdHBob25lOiBwYXJhbXMuc29mdHBob25lLAogICAgICAgICAgY2hhdDogcGFyYW1zLmNoYXQsCiAgICAgICAgICBwYWdlT3B0aW9uczogcGFyYW1zLnBhZ2VPcHRpb25zLAogICAgICAgICAgc2hvdWxkQWRkTmFtZXNwYWNlVG9Mb2dzOiBwYXJhbXMuc2hvdWxkQWRkTmFtZXNwYWNlVG9Mb2dzLAogICAgICAgIH0pOwogICAgICB9CiAKICAgICAgLy8gSWYgRFIgZW5hYmxlZCwgc2V0IHRoaXMgQ0NQIGluc3RhbmNlIGFzIHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldAogICAgICBpZiAocGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgewogICAgICAgIGNvbm5lY3QuY29yZS5yZWdpb24gPSBwYXJhbXMucmVnaW9uOwogICAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzID0gc3VwcHJlc3NDb250YWN0czsKICAgICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU0VUX09GRkxJTkUpOwogICAgICAgIH0gICAgICAgCiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLklOSVRfRElTQVNURVJfUkVDT1ZFUlksIHBhcmFtcyk7CiAgICAgIH0KIAogICAgICBpZiAoY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UpIHsKICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlKTsKICAgICAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICAgIH0KCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk9VVEVSX0NPTlRFWFRfSU5GTywgeyBzdHJlYW1zVmVyc2lvbjogY29ubmVjdC52ZXJzaW9uIH0pOwogCiAgICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKCiAgICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuSU5JVCk7CiAgICAgIGlmIChpbml0U3RhcnRUaW1lKSB7CiAgICAgICAgdmFyIGluaXRUaW1lID0gRGF0ZS5ub3coKSAtIGluaXRTdGFydFRpbWU7CiAgICAgICAgdmFyIHJlZnJlc2hBdHRlbXB0cyA9IGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCB8fCAwOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygnSWZyYW1lIGluaXRpYWxpemF0aW9uIHN1Y2NlZWRlZCcpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBJZnJhbWUgaW5pdGlhbGl6YXRpb24gdGltZSAke2luaXRUaW1lfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBJZnJhbWUgcmVmcmVzaCBhdHRlbXB0cyAke3JlZnJlc2hBdHRlbXB0c31gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTLAogICAgICAgICAgICBkYXRhOiB7IGNvdW50OiByZWZyZXNoQXR0ZW1wdHN9IAogICAgICAgICAgfSk7CiAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1NVQ0NFU1MsCiAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IDF9IAogICAgICAgICAgfSk7CiAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1RJTUUsCiAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IGluaXRUaW1lfSAKICAgICAgICAgIH0pOwogICAgICAgICAgLy90byBhdm9pZCBtZXRyaWMgZW1pc3Npb24gYWZ0ZXIgaW5pdGlhbGl6YXRpb24KICAgICAgICAgIGluaXRTdGFydFRpbWUgPSBudWxsOwogICAgICAgIH0sMTAwMCkKICAgICAgfQogICAgfSk7CiAKICAgIC8vIEFkZCBhbnkgbG9ncyBmcm9tIHRoZSB1cHN0cmVhbSB0byBvdXIgb3duIGxvZ2dlci4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgIH0KICAgIH0pOwogCiAgICAvLyBQb3AgYSBsb2dpbiBwYWdlIHdoZW4gd2UgZW5jb3VudGVyIGFuIEFDSyB0aW1lb3V0LgogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VULCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGxvZ2luUG9wdXAgaXMgdHJ1ZSBieSBkZWZhdWx0LCBvbmx5IGZhbHNlIGlmIGV4cGxpY2l0bHkgc2V0IHRvIGZhbHNlLgogICAgICBpZiAocGFyYW1zLmxvZ2luUG9wdXAgIT09IGZhbHNlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBsb2dpblVybCA9IGdldExvZ2luVXJsKHBhcmFtcyk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIkFDS19USU1FT1VUIG9jY3VycmVkLCBhdHRlbXB0aW5nIHRvIHBvcCB0aGUgbG9naW4gcGFnZSBpZiBub3QgYWxyZWFkeSBvcGVuLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAvLyBjbGVhciBvdXQgbGFzdCBvcGVuZWQgdGltZXN0YW1wIGZvciBTQU1MIGF1dGhlbnRpY2F0aW9uIHdoZW4gdGhlcmUgaXMgQUNLX1RJTUVPVVQKICAgICAgICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLmNsZWFyKGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdyA9IGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5vcGVuKGxvZ2luVXJsLCBjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCwgcGFyYW1zLmxvZ2luT3B0aW9ucyk7CiAKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJBQ0tfVElNRU9VVCBvY2N1cnJlZCBidXQgd2UgYXJlIHVuYWJsZSB0byBvcGVuIHRoZSBsb2dpbiBwb3B1cC4iKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID09IG51bGwpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQpOwogICAgICAgICAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkuY2xlYXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogICAgICAgICAgICBpZiAoKHBhcmFtcy5sb2dpblBvcHVwQXV0b0Nsb3NlIHx8IChwYXJhbXMubG9naW5PcHRpb25zICYmIHBhcmFtcy5sb2dpbk9wdGlvbnMuYXV0b0Nsb3NlKSkgJiYgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93KSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93LmNsb3NlKCk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBjb25uZWN0LmNvcmUuX3JlZnJlc2hJZnJhbWVPblRpbWVvdXQocGFyYW1zLCBjb250YWluZXJEaXYpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkVycm9yIG9jY3VycmVkIHdoaWxlIHJlZnJlc2hpbmcgaWZyYW1lIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAKICAgIGlmIChwYXJhbXMub25WaWV3Q29udGFjdCkgewogICAgICBjb25uZWN0LmNvcmUub25WaWV3Q29udGFjdChwYXJhbXMub25WaWV3Q29udGFjdCk7CiAgICB9CgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSBkYXRhLmxlbmd0aDsKICAgIH0pOwoKICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LlZvaWNlSWRFdmVudHMuVVBEQVRFX0RPTUFJTl9JRCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKGRhdGEgJiYgZGF0YS5kb21haW5JZCkgewogICAgICAgIGNvbm5lY3QuY29yZS52b2ljZUlkRG9tYWluSWQgPSBkYXRhLmRvbWFpbklkOwogICAgICB9CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1JFVFJJRVNfRVhIQVVTVEVELCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChpbml0U3RhcnRUaW1lKSB7CiAgICAgICAgdmFyIHJlZnJlc2hBdHRlbXB0cyA9IGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCAtIDE7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCdJZnJhbWUgaW5pdGlhbGl6YXRpb24gZmFpbGVkJykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYFRpbWUgYWZ0ZXIgaWZyYW1lIGluaXRpYWxpemF0aW9uIHN0YXJ0ZWQgJHtEYXRlLm5vdygpIC0gaW5pdFN0YXJ0VGltZX1gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgSWZyYW1lIHJlZnJlc2ggYXR0ZW1wdHMgJHtyZWZyZXNoQXR0ZW1wdHN9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTLAogICAgICAgICAgZGF0YTogeyBjb3VudDogcmVmcmVzaEF0dGVtcHRzfQogICAgICAgIH0pOwogICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1NVQ0NFU1MsCiAgICAgICAgICBkYXRhOiB7IGNvdW50OiAwfQogICAgICAgIH0pOwogICAgICAgIGluaXRTdGFydFRpbWUgPSBudWxsOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBrZWVwIHRoZSBzb2Z0cGhvbmUgcGFyYW1zIGZvciBleHRlcm5hbCB1c2UKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMgPSBwYXJhbXMuc29mdHBob25lOwogIH07CgogIGNvbm5lY3QuY29yZS5vbklmcmFtZVJldHJpZXNFeGhhdXN0ZWQgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1JFVFJJRVNfRVhIQVVTVEVELCBmKTsKICB9CgogIGNvbm5lY3QuY29yZS5fcmVmcmVzaElmcmFtZU9uVGltZW91dCA9IGZ1bmN0aW9uKGluaXRDQ1BQYXJhbXMsIGNvbnRhaW5lckRpdikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGluaXRDQ1BQYXJhbXMsICdpbml0Q0NQUGFyYW1zJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFpbmVyRGl2LCAnY29udGFpbmVyRGl2Jyk7CiAgICB2YXIgY2NwSWZyYW1lUmVmcmVzaEludGVydmFsID0gKGluaXRDQ1BQYXJhbXMuZGlzYXN0ZXJSZWNvdmVyeU9uKSA/IENDUF9EUl9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTCA6IENDUF9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTDsKICAgIHZhciByZXRyeURlbGF5ID0gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgfHwgMCwgeyBiYXNlOiAyMDAwIH0pOwogICAgdmFyIHRpbWVvdXQgPSBjY3BJZnJhbWVSZWZyZXNoSW50ZXJ2YWwgKyByZXRyeURlbGF5OwogICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQpOwogICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCA9IChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgfHwgMCkgKyAxOwogICAgICBpZiAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IDw9IENDUF9JRlJBTUVfUkVGUkVTSF9MSU1JVCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgaWZyYW1lID0gY29ubmVjdC5jb3JlLl9nZXRDQ1BJZnJhbWUoKTsKICAgICAgICAgIGlmIChpZnJhbWUpIHsKICAgICAgICAgICAgaWZyYW1lLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaWZyYW1lKTsgLy8gVGhlIG9ubHkgd2F5IHRvIGZvcmNlIGEgc3luY2hyb25vdXMgcmVsb2FkIG9mIHRoZSBpZnJhbWUgd2l0aG91dCB0aGUgb2xkIGlmcmFtZSBjb250aW51aW5nIHRvIGZ1bmN0aW9uIGlzIHRvIHJlbW92ZSB0aGUgb2xkIGlmcmFtZSBlbnRpcmVseS4KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdJZnJhbWUgPSBjb25uZWN0LmNvcmUuX2NyZWF0ZUNDUElmcmFtZShjb250YWluZXJEaXYsIGluaXRDQ1BQYXJhbXMpOwogICAgICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtLnVwc3RyZWFtLm91dHB1dCA9IG5ld0lmcmFtZS5jb250ZW50V2luZG93OyAvL3JlcGxhY2VzIHRoZSBvdXRwdXQgd2luZG93IChvbGQgaWZyYW1lJ3MgY29udGVudFdpbmRvdykgb2YgdGhlIFdpbmRvd0lPU3RyZWFtICh3aXRoaW4gdGhlIElGcmFtZUNvbmR1aXQpIHdpdGggdGhlIG5ldyBpZnJhbWUncyBjb250ZW50V2luZG93LgogICAgICAgICAgY29ubmVjdC5jb3JlLl9zZW5kSWZyYW1lU3R5bGVEYXRhVXBzdHJlYW1BZnRlclJlYXNvbmFibGVXYWl0VGltZShuZXdJZnJhbWUsIGNvbm5lY3QuY29yZS51cHN0cmVhbSk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCdFcnJvciB3aGlsZSBjaGVja2luZyBmb3IsIGFuZCByZWNyZWF0aW5nLCB0aGUgQ0NQIElGcmFtZScpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgICAgY29ubmVjdC5jb3JlLl9yZWZyZXNoSWZyYW1lT25UaW1lb3V0KGluaXRDQ1BQYXJhbXMsIGNvbnRhaW5lckRpdik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfUkVUUklFU19FWEhBVVNURUQpOwogICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgICAgfQogICAgfSwgdGltZW91dCk7CiAgfQoKCiAgY29ubmVjdC5jb3JlLl9nZXRDQ1BJZnJhbWUgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGlmcmFtZSBvZiB3aW5kb3cuZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lmcmFtZScpKSB7CiAgICAgIGlmIChpZnJhbWUubmFtZSA9PT0gQ0NQX0lGUkFNRV9OQU1FKSB7CiAgICAgICAgcmV0dXJuIGlmcmFtZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQoKICBjb25uZWN0LmNvcmUuX2NyZWF0ZUNDUElmcmFtZSA9IGZ1bmN0aW9uKGNvbnRhaW5lckRpdiwgaW5pdENDUFBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGluaXRDQ1BQYXJhbXMsICdpbml0Q0NQUGFyYW1zJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFpbmVyRGl2LCAnY29udGFpbmVyRGl2Jyk7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICBpZnJhbWUuc3JjID0gaW5pdENDUFBhcmFtcy5jY3BVcmw7CiAgICBpZnJhbWUuYWxsb3cgPSAibWljcm9waG9uZTsgYXV0b3BsYXkiOwogICAgaWZyYW1lLnN0eWxlID0gaW5pdENDUFBhcmFtcy5zdHlsZSB8fCAid2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJSI7CiAgICBpZnJhbWUudGl0bGUgPSBpbml0Q0NQUGFyYW1zLmlmcmFtZVRpdGxlIHx8IENDUF9JRlJBTUVfTkFNRTsKICAgIGlmcmFtZS5uYW1lID0gQ0NQX0lGUkFNRV9OQU1FOwogICAgY29udGFpbmVyRGl2LmFwcGVuZENoaWxkKGlmcmFtZSk7CiAgICByZXR1cm4gaWZyYW1lOwogIH0KCiAgY29ubmVjdC5jb3JlLl9zZW5kSWZyYW1lU3R5bGVEYXRhVXBzdHJlYW1BZnRlclJlYXNvbmFibGVXYWl0VGltZSA9IGZ1bmN0aW9uKGlmcmFtZSwgY29uZHVpdCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlmcmFtZSwgJ2lmcmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmR1aXQsICdjb25kdWl0Jyk7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICB2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShpZnJhbWUsIG51bGwpOwogICAgICB2YXIgZGF0YSA9IHsKICAgICAgICBkaXNwbGF5OiBzdHlsZS5kaXNwbGF5LAogICAgICAgIG9mZnNldFdpZHRoOiBpZnJhbWUub2Zmc2V0V2lkdGgsCiAgICAgICAgb2Zmc2V0SGVpZ2h0OiBpZnJhbWUub2Zmc2V0SGVpZ2h0LAogICAgICAgIGNsaWVudFJlY3RzTGVuZ3RoOiBpZnJhbWUuZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgKICAgICAgfTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1NUWUxFLCBkYXRhKTsKICAgIH0sIDEwMDAwKTsKICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIEtlZXBhbGl2ZU1hbmFnZXIgPSBmdW5jdGlvbiAoY29uZHVpdCwgZXZlbnRCdXMsIHN5blRpbWVvdXQsIGFja1RpbWVvdXQpIHsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXM7CiAgICB0aGlzLnN5blRpbWVvdXQgPSBzeW5UaW1lb3V0OwogICAgdGhpcy5hY2tUaW1lb3V0ID0gYWNrVGltZW91dDsKICAgIHRoaXMuYWNrVGltZXIgPSBudWxsOwogICAgdGhpcy5zeW5UaW1lciA9IG51bGw7CiAgICB0aGlzLmFja1N1YiA9IG51bGw7CiAgfTsKIAogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogCiAgICB0aGlzLmNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNZTkNIUk9OSVpFKTsKICAgIHRoaXMuYWNrU3ViID0gdGhpcy5jb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KHNlbGYuYWNrVGltZXIpOwogICAgICBzZWxmLl9kZWZlclN0YXJ0KCk7CiAgICB9KTsKICAgIHRoaXMuYWNrVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuYWNrU3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgIHNlbGYuZXZlbnRCdXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCk7CiAgICAgIHNlbGYuX2RlZmVyU3RhcnQoKTsKICAgIH0sIHRoaXMuYWNrVGltZW91dCk7CiAgfTsKCiAgLy9GaXhlcyB0aGUga2VlcGFsaXZlbWFuYWdlci4KICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5fZGVmZXJTdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3luVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuc3RhcnQpLCB0aGlzLnN5blRpbWVvdXQpOwogIH07CgogIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBvbmx5LCBpbiBjYXNlIGN1c3RvbWVycyBhcmUgdXNpbmcgdGhpcyB0byBzdGFydCB0aGUga2VlcGFsaXZlbWFuYWdlciBmb3Igc29tZSByZWFzb24uCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuZGVmZXJTdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLnN5blRpbWVyID09IG51bGwpIHsKICAgICAgdGhpcy5zeW5UaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5zdGFydCksIHRoaXMuc3luVGltZW91dCk7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KIAogIHZhciBXZWJTb2NrZXRQcm92aWRlciA9IGZ1bmN0aW9uICgpIHsKIAogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaW5pdEZhaWx1cmU6IG5ldyBTZXQoKSwKICAgICAgc3Vic2NyaXB0aW9uVXBkYXRlOiBuZXcgU2V0KCksCiAgICAgIHN1YnNjcmlwdGlvbkZhaWx1cmU6IG5ldyBTZXQoKSwKICAgICAgdG9waWM6IG5ldyBNYXAoKSwKICAgICAgYWxsTWVzc2FnZTogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uR2FpbjogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uTG9zdDogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uT3BlbjogbmV3IFNldCgpLAogICAgICBjb25uZWN0aW9uQ2xvc2U6IG5ldyBTZXQoKQogICAgfTsKIAogICAgdmFyIGludm9rZUNhbGxiYWNrcyA9IGZ1bmN0aW9uIChjYWxsYmFja3MsIHJlc3BvbnNlKSB7CiAgICAgIGNhbGxiYWNrcy5mb3JFYWNoKGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKHJlc3BvbnNlKTsKICAgICAgfSk7CiAgICB9OwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSwgZnVuY3Rpb24gKCkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmluaXRGYWlsdXJlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9PUEVOLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uT3BlbiwgcmVzcG9uc2UpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UsIHJlc3BvbnNlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOLCBmdW5jdGlvbiAoKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4pOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0xPU1QsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fVVBEQVRFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9GQUlMVVJFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuYWxsTWVzc2FnZSwgcmVzcG9uc2UpOwogICAgICBpZiAoY2FsbGJhY2tzLnRvcGljLmhhcyhyZXNwb25zZS50b3BpYykpIHsKICAgICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnRvcGljLmdldChyZXNwb25zZS50b3BpYyksIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSk7CiAKICAgIHRoaXMuc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAod2ViU29ja2V0UGF5bG9hZCkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU0VORCwgd2ViU29ja2V0UGF5bG9hZCk7CiAgICB9OwogCiAgICB0aGlzLm9uSW5pdEZhaWx1cmUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5pbml0RmFpbHVyZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuaW5pdEZhaWx1cmUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25PcGVuID0gZnVuY3Rpb24oY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uT3Blbi5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4uZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25DbG9zZSA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CgogICAgdGhpcy5vbkNvbm5lY3Rpb25HYWluID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4uYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uQ29ubmVjdGlvbkxvc3QgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdC5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25TdWJzY3JpcHRpb25VcGRhdGUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vblN1YnNjcmlwdGlvbkZhaWx1cmUgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25GYWlsdXJlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLnN1YnNjcmliZVRvcGljcyA9IGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljcywgJ3RvcGljcycpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0FycmF5KHRvcGljcyksICd0b3BpY3MgbXVzdCBiZSBhIGFycmF5Jyk7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIHRvcGljcyk7CiAgICB9OwogCiAgICB0aGlzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uICh0b3BpY05hbWUsIGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpY05hbWUsICd0b3BpY05hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGlmIChjYWxsYmFja3MudG9waWMuaGFzKHRvcGljTmFtZSkpIHsKICAgICAgICBjYWxsYmFja3MudG9waWMuZ2V0KHRvcGljTmFtZSkuYWRkKGNiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MudG9waWMuc2V0KHRvcGljTmFtZSwgbmV3IFNldChbY2JdKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnRvcGljLmdldCh0b3BpY05hbWUpLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uQWxsTWVzc2FnZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmFsbE1lc3NhZ2UuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmFsbE1lc3NhZ2UuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBBZ2VudERhdGFQcm92aWRlciA9IGZ1bmN0aW9uIChidXMpIHsKICAgIHZhciBhZ2VudERhdGEgPSBudWxsOwogICAgdGhpcy5idXMgPSBidXM7CiAgICB0aGlzLmJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5VUERBVEUsIGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy51cGRhdGVBZ2VudERhdGEpKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLnVwZGF0ZUFnZW50RGF0YSA9IGZ1bmN0aW9uIChhZ2VudERhdGEpIHsKICAgIHZhciBvbGRBZ2VudERhdGEgPSB0aGlzLmFnZW50RGF0YTsKICAgIHRoaXMuYWdlbnREYXRhID0gYWdlbnREYXRhOwogCiAgICBpZiAob2xkQWdlbnREYXRhID09IG51bGwpIHsKICAgICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KIAogICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLlJFRlJFU0gsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogCiAgICB0aGlzLl9maXJlQWdlbnRVcGRhdGVFdmVudHMob2xkQWdlbnREYXRhKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEFnZW50RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmFnZW50RGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ05vIGFnZW50IGRhdGEgaXMgYXZhaWxhYmxlIHlldCEnKTsKICAgIH0KIAogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0Q29udGFjdERhdGEgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB2YXIgYWdlbnREYXRhID0gdGhpcy5nZXRBZ2VudERhdGEoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuZmluZChhZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjdGRhdGEpIHsKICAgICAgcmV0dXJuIGN0ZGF0YS5jb250YWN0SWQgPT09IGNvbnRhY3RJZDsKICAgIH0pOwogCiAgICBpZiAoY29udGFjdERhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdDb250YWN0ICVzIG5vIGxvbmdlciBleGlzdHMuJywgY29udGFjdElkKTsKICAgIH0KIAogICAgcmV0dXJuIGNvbnRhY3REYXRhOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbkRhdGEgPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHZhciBjb250YWN0RGF0YSA9IHRoaXMuZ2V0Q29udGFjdERhdGEoY29udGFjdElkKTsKICAgIHZhciBjb25uZWN0aW9uRGF0YSA9IGNvbm5lY3QuZmluZChjb250YWN0RGF0YS5jb25uZWN0aW9ucywgZnVuY3Rpb24gKGNkYXRhKSB7CiAgICAgIHJldHVybiBjZGF0YS5jb25uZWN0aW9uSWQgPT09IGNvbm5lY3Rpb25JZDsKICAgIH0pOwogCiAgICBpZiAoY29ubmVjdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdDb25uZWN0aW9uICVzIGZvciBjb250YWN0ICVzIG5vIGxvbmdlciBleGlzdHMuJywgY29ubmVjdGlvbklkLCBjb250YWN0SWQpOwogICAgfQogCiAgICByZXR1cm4gY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEluc3RhbmNlSWQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuZ2V0QWdlbnREYXRhKCkuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkLm1hdGNoKC9pbnN0YW5jZVwvKFswLTlhLWZBLUZ8LV0rKVwvLylbMV07CiAgfQoKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0QVdTQWNjb3VudElkID0gZnVuY3Rpb24oKXsKICAgIHJldHVybiB0aGlzLmdldEFnZW50RGF0YSgpLmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZC5tYXRjaCgvOihbMC05XSspOmluc3RhbmNlLylbMV07CiAgfQogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9kaWZmQ29udGFjdHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgZGlmZiA9IHsKICAgICAgYWRkZWQ6IHt9LAogICAgICByZW1vdmVkOiB7fSwKICAgICAgY29tbW9uOiB7fSwKICAgICAgb2xkTWFwOiBjb25uZWN0LmluZGV4KG9sZEFnZW50RGF0YSA9PSBudWxsID8gW10gOiBvbGRBZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSksCiAgICAgIG5ld01hcDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KQogICAgfTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYub2xkTWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgaWYgKGNvbm5lY3QuY29udGFpbnMoZGlmZi5uZXdNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmNvbW1vbltjb250YWN0SWRdID0gZGlmZi5uZXdNYXBbY29udGFjdElkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkaWZmLnJlbW92ZWRbY29udGFjdElkXSA9IGRpZmYub2xkTWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5uZXdNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoIWNvbm5lY3QuY29udGFpbnMoZGlmZi5vbGRNYXAsIGNvbnRhY3RJZCkpIHsKICAgICAgICBkaWZmLmFkZGVkW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9CiAgICB9KTsKIAogICAgcmV0dXJuIGRpZmY7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUFnZW50VXBkYXRlRXZlbnRzID0gZnVuY3Rpb24gKG9sZEFnZW50RGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGRpZmYgPSBudWxsOwogICAgdmFyIG9sZEFnZW50U3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcy5JTklUIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgbmV3QWdlbnRTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLm5hbWU7CiAgICB2YXIgb2xkUm91dGluZ1N0YXRlID0gb2xkQWdlbnREYXRhID09IG51bGwgPyBjb25uZWN0LkFnZW50U3RhdGVUeXBlLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUudHlwZTsKICAgIHZhciBuZXdSb3V0aW5nU3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogCiAgICBpZiAob2xkUm91dGluZ1N0YXRlICE9PSBuZXdSb3V0aW5nU3RhdGUpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkUm91dGluZ1N0YXRlLCBuZXdSb3V0aW5nU3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQogCiAgICBpZiAob2xkQWdlbnRTdGF0ZSAhPT0gbmV3QWdlbnRTdGF0ZSkgewogICAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuU1RBVEVfQ0hBTkdFLCB7CiAgICAgICAgYWdlbnQ6IG5ldyBjb25uZWN0LkFnZW50KCksCiAgICAgICAgb2xkU3RhdGU6IG9sZEFnZW50U3RhdGUsCiAgICAgICAgbmV3U3RhdGU6IG5ld0FnZW50U3RhdGUKIAogICAgICB9KTsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50U3RhdGVFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZEFnZW50U3RhdGUsIG5ld0FnZW50U3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICAgIH0pOwogICAgfQoKICAgIHZhciBvbGROZXh0U3RhdGUgPSBvbGRBZ2VudERhdGEgJiYgb2xkQWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZSA/IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUubmFtZSA6IG51bGw7CiAgICB2YXIgbmV3TmV4dFN0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlID8gdGhpcy5hZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlLm5hbWUgOiBudWxsOwogICAgaWYgKG9sZE5leHRTdGF0ZSAhPT0gbmV3TmV4dFN0YXRlICYmIG5ld05leHRTdGF0ZSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuRU5RVUVVRURfTkVYVF9TVEFURSwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CgogICAgaWYgKG9sZEFnZW50RGF0YSAhPT0gbnVsbCkgewogICAgICBkaWZmID0gdGhpcy5fZGlmZkNvbnRhY3RzKG9sZEFnZW50RGF0YSk7CiAKICAgIH0gZWxzZSB7CiAgICAgIGRpZmYgPSB7CiAgICAgICAgYWRkZWQ6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSksCiAgICAgICAgcmVtb3ZlZDoge30sCiAgICAgICAgY29tbW9uOiB7fSwKICAgICAgICBvbGRNYXA6IHt9LAogICAgICAgIG5ld01hcDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KQogICAgICB9OwogICAgfQogCiAgICBjb25uZWN0LnZhbHVlcyhkaWZmLmFkZGVkKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTklULCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCkpOwogICAgICBzZWxmLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyhjb250YWN0RGF0YS5jb250YWN0SWQsIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTklULCBjb250YWN0RGF0YS5zdGF0ZS50eXBlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LnZhbHVlcyhkaWZmLnJlbW92ZWQpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCwgbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKSk7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCwgY29udGFjdERhdGEuY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKSk7CiAgICAgIHNlbGYuX3Vuc3ViQWxsQ29udGFjdEV2ZW50c0ZvckNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5jb21tb24pLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBzZWxmLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyhjb250YWN0SWQsIGRpZmYub2xkTWFwW2NvbnRhY3RJZF0uc3RhdGUudHlwZSwgZGlmZi5uZXdNYXBbY29udGFjdElkXS5zdGF0ZS50eXBlKTsKICAgIH0pOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgb2xkQ29udGFjdFN0YXRlLCBuZXdDb250YWN0U3RhdGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChvbGRDb250YWN0U3RhdGUgIT09IG5ld0NvbnRhY3RTdGF0ZSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkQ29udGFjdFN0YXRlLCBuZXdDb250YWN0U3RhdGUpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihldmVudCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50LCBjb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgICB9KTsKICAgIH0KCiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCwgY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl91bnN1YkFsbENvbnRhY3RFdmVudHNGb3JDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5Db250YWN0RXZlbnRzKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgICAgc2VsZi5idXMuZ2V0U3Vic2NyaXB0aW9ucyhjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudE5hbWUsIGNvbnRhY3RJZCkpCiAgICAgICAgLm1hcChmdW5jdGlvbiAoc3ViKSB7IHN1Yi51bnN1YnNjcmliZSgpOyB9KTsKICAgIH0pOwogIH07CiAKICAvKiogLS0tLS0gbWluaW1hbCB2aWV3IGxheWVyIGV2ZW50IGhhbmRsaW5nICoqLwogCiAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywgZik7CiAgfTsKIAogIC8qKgogICAqIFVzZWQgb2YgYWdlbnQgaW50ZXJmYWNlIGNvbnRyb2wuIAogICAqIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCgiY29udGFjdElkIikgLT4gIHRoaXMgaXMgY3VyZW50bHkgcHJvZ3JhbW1lZCB0byBnZXQgdGhlIGNvbnRhY3QgaW50byB2aWV3LgogICAqLwogIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLAogICAgICBkYXRhOiB7CiAgICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqIC0tLS0tIG1pbmltYWwgdmlldyBsYXllciBldmVudCBoYW5kbGluZyAqKi8KIAogIGNvbm5lY3QuY29yZS5vbkFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ2hhbm5lbFZpZXdFdmVudHMuQUNUSVZBVEVfQ0hBTk5FTF9XSVRIX1ZJRVdfVFlQRSwgZik7CiAgfTsKIAogIC8qKgogICAqIFVzZWQgb2YgYWdlbnQgaW50ZXJmYWNlIGNvbnRyb2wuIAogICAqIGNvbm5lY3QuY29yZS5hY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUoKSAtPiAgdGhpcyBpcyBjdXJlbnRseSBwcm9ncmFtbWVkIHRvIGdldCBlaXRoZXIgdGhlIG51bWJlciBwYWQsIHF1aWNrIGNvbm5lY3RzLCBvciBjcmVhdGUgdGFzayBpbnRvIHZpZXcuCiAgICogdGhlIHZhbGlkIGNvbWJpbmF0aW9ucyBhcmUgKCJjcmVhdGVfdGFzayIsICJ0YXNrIiksICgibnVtYmVyX3BhZCIsICJzb2Z0cGhvbmUiKSwgKCJjcmVhdGVfdGFzayIsICJzb2Z0cGhvbmUiKSwgKCJxdWlja19jb25uZWN0cyIsICJzb2Z0cGhvbmUiKQogICAqIHRoZSBzb2Z0cGhvbmUgd2l0aCBjcmVhdGVfdGFzayBjb21ibyBpcyBhIHNwZWNpYWwgY2FzZSBpbiB0aGUgY2hhbm5lbCB2aWV3IHRvIGFsbG93IGFsbCB0aHJlZSB2aWV3IHR5cGUgYnV0dG9ucyB0byBhcHBlYXIgb24gdGhlIHNvZnRwaG9uZSBzY3JlZW4KICAgKgogICAqIFRoZSAnc291cmNlJyBpcyBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgd2hpY2ggaW5kaWNhdGVzIHRoZSByZXF1ZXN0ZXIuIEZvciBleGFtcGxlLCBpZiBpbnZva2VkIHdpdGggKCJjcmVhdGVfdGFzayIsICJ0YXNrIiwgImFnZW50YXBwIikgd2Ugd291bGQga25vdyBhZ2VudGFwcCByZXF1ZXN0ZWQgb3BlbiB0YXNrIHZpZXcuCiAgICogCiAgICogImNhc2VJZCIgaXMgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHdoaWNoIGlzIHBhc3NlZCB3aGVuIGEgdGFzayBpcyBjcmVhdGVkIGZyb20gYSBLZXN5dG9uZSBjYXNlCiAgICovCiAgIGNvbm5lY3QuY29yZS5hY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUgPSBmdW5jdGlvbiAodmlld1R5cGUsIG1lZGlhVHlwZSwgc291cmNlLCBjYXNlSWQpIHsKICAgIGNvbnN0IGRhdGEgPSB7IHZpZXdUeXBlLCBtZWRpYVR5cGUgfTsKICAgIGlmIChzb3VyY2UpIHsKICAgICAgZGF0YS5zb3VyY2UgPSBzb3VyY2U7CiAgICB9CiAgICBpZiAoY2FzZUlkKSB7CiAgICAgIGRhdGEuY2FzZUlkID0gY2FzZUlkOwogICAgfQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cy5BQ1RJVkFURV9DSEFOTkVMX1dJVEhfVklFV19UWVBFLAogICAgICBkYXRhCiAgICB9KTsKICB9OwoKICAvKioKICAgKiBVc2VkIHRvIHB1Ymxpc2ggJ3Rhc2sgY3JlYXRlZCcgZXZlbnQKICAgKi8KICBjb25uZWN0LmNvcmUudHJpZ2dlclRhc2tDcmVhdGVkID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnVwc3RyZWFtQnVzLnRyaWdnZXIoY29ubmVjdC5UYXNrRXZlbnRzLkNSRUFURUQsIGRhdGEpOwogIH07CgogIC8qKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciB0aGUgY3VzdG9tIGFuZCBlbWJlZGRlZCBDQ1BzIAogICogdG8gaGFuZGxlIHRoZSBhY2Nlc3MgZGVuaWVkIHVzZSBjYXNlLiAKICAqLwogIGNvbm5lY3QuY29yZS5vbkFjY2Vzc0RlbmllZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDQ0VTU19ERU5JRUQsIGYpOwogIH07CiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciBTQU1MIHVzZSBjYXNlcyB0byBoYW5kbGUgdGhlIGN1c3RvbSBsb2dpbnMuIAogICovCiAgY29ubmVjdC5jb3JlLm9uQXV0aEZhaWwgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGYpOwogIH07CgogIGNvbm5lY3QuY29yZS5vbkF1dGhvcml6ZVN1Y2Nlc3MgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfU1VDQ0VTUywgZik7CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZVN1Y2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCwgMCk7CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhGYWlsID0gZnVuY3Rpb24obG9naW5VcmwsIGF1dGhvcml6ZUVuZHBvaW50LCBhdXRoRmFpbERhdGEpIHsKICAgIGlmIChhdXRoRmFpbERhdGEgJiYgYXV0aEZhaWxEYXRhLmF1dGhvcml6ZSkgewogICAgICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZUZhaWwobG9naW5VcmwpOwogICAgfQogICAgZWxzZSB7CiAgICAgIGNvbm5lY3QuY29yZS5faGFuZGxlQ1RJQXV0aEZhaWwoYXV0aG9yaXplRW5kcG9pbnQpOwogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVGYWlsID0gZnVuY3Rpb24obG9naW5VcmwpIHsKICAgIGxldCBhdXRoUmV0cnlDb3VudCA9IGNvbm5lY3QuY29yZS5fZ2V0QXV0aFJldHJ5Q291bnQoKQogICAgaWYgKCFjb25uZWN0LmNvcmUuYXV0aG9yaXplVGltZW91dElkKSB7CiAgICAgIGlmIChhdXRoUmV0cnlDb3VudCA8IGNvbm5lY3QuY29yZS5NQVhfQVVUSE9SSVpFX1JFVFJZX0NPVU5UX0ZPUl9TRVNTSU9OKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLl9pbmNyZW1lbnRBdXRoUmV0cnlDb3VudCgpOwogICAgICAgIGxldCByZXRyeURlbGF5ID0gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShhdXRoUmV0cnlDb3VudCArIDEgfHwgMCwgeyBiYXNlOiAyMDAwIH0pOwogICAgICAgIGNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGNvbm5lY3QuY29yZS5fcmVkaXJlY3RUb0xvZ2luKGxvZ2luVXJsKTsKICAgICAgICB9LCByZXRyeURlbGF5KTsgLy9XZSBkb24ndCBoYXZlIHRvIGNsZWFyIHRoZSB0aW1lb3V0SWQgYmVjYXVzZSB3ZSBhcmUgcmVkaXJlY3RpbmcgYXdheSBmcm9tIHRoaXMgb3JpZ2luIG9uY2UgdGhlIHRpbWVvdXQgY29tcGxldGVzLgogICAgICB9CiAgICAgIGVsc2UgIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGhhdmUgZXhoYXVzdGVkIG91ciBhdXRob3JpemF0aW9uIHJldHJpZXMgZHVlIHRvIDQwMXMgZnJvbSB0aGUgYXV0aG9yaXplIGFwaS4gTm8gbW9yZSByZXRyaWVzIHdpbGwgYmUgYXR0ZW1wdGVkIGluIHRoaXMgc2Vzc2lvbiB1bnRpbCB0aGUgYXV0aG9yaXplIGFwaSByZXR1cm5zIDIwMC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVEKTsKICAgICAgfQogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl9yZWRpcmVjdFRvTG9naW4gPSBmdW5jdGlvbihsb2dpblVybCkgewogICAgaWYgKHR5cGVvZihsb2dpblVybCkgPT09ICdzdHJpbmcnKSB7CiAgICAgIGxvY2F0aW9uLmFzc2lnbihsb2dpblVybCk7CiAgICB9IGVsc2UgewogICAgICBsb2NhdGlvbi5yZWxvYWQoKTsKICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQ1RJQXV0aEZhaWwgPSBmdW5jdGlvbihhdXRob3JpemVFbmRwb2ludCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUuY3RpVGltZW91dElkKSB7CiAgICAgIGlmIChjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgPCBjb25uZWN0LmNvcmUuTUFYX0NUSV9BVVRIX1JFVFJZX0NPVU5UKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50Kys7CiAgICAgICAgbGV0IHJldHJ5RGVsYXkgPSBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KGNvbm5lY3QuY29yZS5jdGlBdXRoUmV0cnlDb3VudCB8fCAwLCB7IGJhc2U6IDUwMCB9KTsKICAgICAgICBjb25uZWN0LmNvcmUuY3RpVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplKGF1dGhvcml6ZUVuZHBvaW50KS50aGVuKGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhvcml6ZVN1Y2Nlc3MuYmluZChjb25uZWN0LmNvcmUpKS5jYXRjaChjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRoRmFpbC5iaW5kKGNvbm5lY3QuY29yZSwge2F1dGhvcml6ZTogdHJ1ZX0pKTsKICAgICAgICAgIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBudWxsOwogICAgICAgIH0sIHJldHJ5RGVsYXkpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiV2UgaGF2ZSBleGhhdXN0ZWQgb3VyIGF1dGhvcml6YXRpb24gcmV0cmllcyBkdWUgdG8gNDAxcyBmcm9tIHRoZSBDVEkgc2VydmljZS4gTm8gbW9yZSByZXRyaWVzIHdpbGwgYmUgYXR0ZW1wdGVkIHVudGlsIHRoZSBwYWdlIGlzIHJlZnJlc2hlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQ1RJX0FVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCk7CiAgICAgIH0KICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhvcml6ZVN1Y2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnVwc3RyZWFtQnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1NVQ0NFU1MpOwogIH0KCiAgY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aEZhaWwgPSBmdW5jdGlvbihkYXRhKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS51cHN0cmVhbUJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZGF0YSk7CiAgfQoKICBjb25uZWN0LmNvcmUuX2dldEF1dGhSZXRyeUNvdW50ID0gZnVuY3Rpb24oKSB7CiAgICBsZXQgaXRlbSA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCk7CiAgICBpZiAoaXRlbSAhPT0gbnVsbCkgewogICAgICBpZiAoIWlzTmFOKHBhcnNlSW50KGl0ZW0pKSkgewogICAgICAgIHJldHVybiBwYXJzZUludChpdGVtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCJUaGUgc2Vzc2lvbiBzdG9yYWdlIHZhbHVlIGZvciBhdXRoIHJldHJ5IGNvdW50IHdhcyBOYU4iKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5ULCAwKTsKICAgICAgcmV0dXJuIDA7CiAgICB9IAogIH0KCiAgY29ubmVjdC5jb3JlLl9pbmNyZW1lbnRBdXRoUmV0cnlDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5ULCAoY29ubmVjdC5jb3JlLl9nZXRBdXRoUmV0cnlDb3VudCgpKzEpLnRvU3RyaW5nKCkpOwogIH0KCiAgY29ubmVjdC5jb3JlLm9uQXV0aG9yaXplUmV0cmllc0V4aGF1c3RlZCA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQsIGYpOwogIH0KCiAgY29ubmVjdC5jb3JlLm9uQ1RJQXV0aG9yaXplUmV0cmllc0V4aGF1c3RlZCA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DVElfQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVELCBmKTsKICB9CiAKICAvKiogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogCiAgLyoqCiAgICogVXNlZCBmb3IgaGFuZGxpbmcgdGhlIHJ0YyBzZXNzaW9uIHN0YXRzLgogICAqIFVzYWdlCiAgICogY29ubmVjdC5jb3JlLm9uU29mdHBob25lU2Vzc2lvbkluaXQoZnVuY3Rpb24oeyBjb25uZWN0aW9uSWQgfSkgewogICAqICAgICB2YXIgc29mdHBob25lTWFuYWdlciA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyKCk7CiAgICogICAgIGlmKHNvZnRwaG9uZU1hbmFnZXIpewogICAqICAgICAgICAvLyBhY2Nlc3Mgc2Vzc2lvbgogICAqICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOyAKICAgKiAgICAgIH0KICAgKiB9KTsKICAgKi8KIAogIGNvbm5lY3QuY29yZS5vblNvZnRwaG9uZVNlc3Npb25Jbml0ID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwgZik7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUub25Db25maWd1cmUgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5DT05GSUdVUkUsIGYpOwogIH0KCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgY29ubmVjdC5jb3JlLm9uSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbihmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklOSVQsIGYpOwogIH0KCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFjdElkLCAnY29udGFjdElkJyk7CiAgICBpZiAoIWNvbm5lY3QuY29udGFpbnMoY29ubmVjdC52YWx1ZXMoY29ubmVjdC5Db250YWN0RXZlbnRzKSwgZXZlbnROYW1lKSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5WYWx1ZUVycm9yKCclcyBpcyBub3QgYSB2YWxpZCBjb250YWN0IGV2ZW50LicsIGV2ZW50TmFtZSk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCclczo6JXMnLCBldmVudE5hbWUsIGNvbnRhY3RJZCk7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmV2ZW50QnVzOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlcjsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRMb2NhbFRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKS5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcDsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRTa2V3ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpLnNuYXBzaG90LnNrZXc7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRSb3V0aW5nRXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRSb3V0aW5nRXZlbnRHcmFwaDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudFJvdXRpbmdFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5ST1VUQUJMRSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5ST1VUQUJMRSkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk5PVF9ST1VUQUJMRSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5OT1RfUk9VVEFCTEUpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5PRkZMSU5FLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLk9GRkxJTkUpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudFN0YXRlRXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRTdGF0ZUV2ZW50R3JhcGg7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRTdGF0ZUV2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkFnZW50RXJyb3JTdGF0ZXMpLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLkVSUk9SKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcy5BRlRFUl9DQUxMX1dPUkssCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuQUNXKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmNvbnRhY3RFdmVudEdyYXBoOwogIH07CiAKICBjb25uZWN0LmNvcmUuY29udGFjdEV2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5DT01JTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTkNPTUlORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuUEVORElORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLlBFTkRJTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNUSU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNURUQpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCkKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5DT01JTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRU5ERUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ1cpCiAgICAuYXNzb2MoY29ubmVjdC52YWx1ZXMoY29ubmVjdC5DT05UQUNUX0FDVElWRV9TVEFURVMpLAogICAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LnJlbGF0aXZlQ29tcGxlbWVudChjb25uZWN0LkNPTlRBQ1RfQUNUSVZFX1NUQVRFUywgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlKSksCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FTkRFRCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUikKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLk1JU1NFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUuY2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IGNvcmUgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5jbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbnVsbDsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudEFwcENsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IEFnZW50QXBwIENsaWVudCBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0VGFza1RlbXBsYXRlc0NsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgVGFza1RlbXBsYXRlcyBDbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBudWxsOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBtYXN0ZXIgY2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyKSB7CiAgICAgIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyID0gbmV3IGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlcigpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnBvcHVwTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5wb3B1cE1hbmFnZXIgPSBuZXcgY29ubmVjdC5Qb3B1cE1hbmFnZXIoKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS51cHN0cmVhbSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGVyZSBpcyBubyB1cHN0cmVhbSBjb25kdWl0IScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS51cHN0cmVhbTsKICB9OwogIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLkFnZW50RGF0YVByb3ZpZGVyID0gQWdlbnREYXRhUHJvdmlkZXI7CiAKfSkoKTsKCi8qKiovIH0pLAoKLyoqKi8gNTkyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICB2YXIgQUxMX0VWRU5UUyA9ICc8PGFsbD4+JzsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBFdmVudFR5cGUKICAgKi8KICB2YXIgRXZlbnRUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWNrbm93bGVkZ2UnLAogICAgJ2Fja190aW1lb3V0JywKICAgICdpbml0JywKICAgICdhcGlfcmVxdWVzdCcsCiAgICAnYXBpX3Jlc3BvbnNlJywKICAgICdhdXRoX2ZhaWwnLAogICAgJ2FjY2Vzc19kZW5pZWQnLAogICAgJ2Nsb3NlJywKICAgICdjb25maWd1cmUnLAogICAgJ2xvZycsCiAgICAnbWFzdGVyX3JlcXVlc3QnLAogICAgJ21hc3Rlcl9yZXNwb25zZScsCiAgICAnc3luY2hyb25pemUnLAogICAgJ3Rlcm1pbmF0ZScsCiAgICAndGVybWluYXRlZCcsCiAgICAnc2VuZF9sb2dzJywKICAgICdyZWxvYWRfYWdlbnRfY29uZmlndXJhdGlvbicsCiAgICAnYnJvYWRjYXN0JywKICAgICdhcGlfbWV0cmljJywKICAgICdjbGllbnRfbWV0cmljJywKICAgICdzb2Z0cGhvbmVfc3RhdHMnLAogICAgJ3NvZnRwaG9uZV9yZXBvcnQnLAogICAgJ2NsaWVudF9zaWRlX2xvZ3MnLAogICAgJ3NlcnZlcl9ib3VuZF9pbnRlcm5hbF9sb2cnLAogICAgJ211dGUnLAogICAgImlmcmFtZV9zdHlsZSIsCiAgICAiaWZyYW1lX3JldHJpZXNfZXhoYXVzdGVkIiwKICAgICJ1cGRhdGVfY29ubmVjdGVkX2NjcHMiLAogICAgIm91dGVyX2NvbnRleHRfaW5mbyIsCiAgICAibWVkaWFfZGV2aWNlX3JlcXVlc3QiLAogICAgIm1lZGlhX2RldmljZV9yZXNwb25zZSIsCiAgICAidGFiX2lkIiwKICAgICdhdXRob3JpemVfc3VjY2VzcycsCiAgICAnYXV0aG9yaXplX3JldHJpZXNfZXhoYXVzdGVkJywKICAgICdjdGlfYXV0aG9yaXplX3JldHJpZXNfZXhoYXVzdGVkJywKICAgICdjbGlja19zdHJlYW1fZGF0YScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBNYXN0ZXJUb3BpY3MKICAgKi8KICB2YXIgTWFzdGVyVG9waWNzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3QnLCBbCiAgICAnbG9naW5Qb3B1cCcsCiAgICAnc2VuZExvZ3MnLAogICAgJ3NvZnRwaG9uZScsCiAgICAncmluZ3RvbmUnLAogICAgJ21ldHJpY3MnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQWdlbnRFdmVudHMKICAgKi8KICB2YXIgQWdlbnRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnYWdlbnQnLCBbCiAgICAnaW5pdCcsCiAgICAndXBkYXRlJywKICAgICdyZWZyZXNoJywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdwZW5kaW5nJywKICAgICdjb250YWN0X3BlbmRpbmcnLAogICAgJ29mZmxpbmUnLAogICAgJ2Vycm9yJywKICAgICdzb2Z0cGhvbmVfZXJyb3InLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2xvc3QnLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2dhaW5lZCcsCiAgICAnc3RhdGVfY2hhbmdlJywKICAgICdhY3cnLAogICAgJ211dGVfdG9nZ2xlJywKICAgICdsb2NhbF9tZWRpYV9zdHJlYW1fY3JlYXRlZCcsCiAgICAnZW5xdWV1ZWRfbmV4dF9zdGF0ZScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIFdlYlNvY2tldEV2ZW50cwogICovCiAgdmFyIFdlYlNvY2tldEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd3ZWJTb2NrZXQnLCBbCiAgICAnaW5pdF9mYWlsdXJlJywKICAgICdjb25uZWN0aW9uX29wZW4nLAogICAgJ2Nvbm5lY3Rpb25fY2xvc2UnLAogICAgJ2Nvbm5lY3Rpb25fZXJyb3InLAogICAgJ2Nvbm5lY3Rpb25fZ2FpbicsCiAgICAnY29ubmVjdGlvbl9sb3N0JywKICAgICdzdWJzY3JpcHRpb25fdXBkYXRlJywKICAgICdzdWJzY3JpcHRpb25fZmFpbHVyZScsCiAgICAnYWxsX21lc3NhZ2UnLAogICAgJ3NlbmQnLAogICAgJ3N1YnNjcmliZScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQ29udGFjdEV2ZW50cwogICAgKi8KICB2YXIgQ29udGFjdEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb250YWN0JywgWwogICAgJ2luaXQnLAogICAgJ3JlZnJlc2gnLAogICAgJ2Rlc3Ryb3llZCcsCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcsCiAgICAnbWlzc2VkJywKICAgICdhY3cnLAogICAgJ3ZpZXcnLAogICAgJ2VuZGVkJywKICAgICdlcnJvcicsCiAgICAnYWNjZXB0ZWQnCiAgXSk7CgogIHZhciBDaGFubmVsVmlld0V2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd0YXNrTGlzdCcsIFsKICAgICdhY3RpdmF0ZV9jaGFubmVsX3dpdGhfdmlld190eXBlJwogIF0pOwogIAogIHZhciBUYXNrRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3Rhc2snLCBbCiAgICAgICdjcmVhdGVkJwogIF0pOwoKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENvbm5lY3Rpb25FdmVudHMKICAqLwogIHZhciBDb25uZWN0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3Rpb24nLCBbCiAgICAnc2Vzc2lvbl9pbml0JywKICAgICdyZWFkeV90b19zdGFydF9zZXNzaW9uJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbmZpZ3VyYXRpb24gRXZlbnRzCiAgICovCiAgdmFyIENvbmZpZ3VyYXRpb25FdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29uZmlndXJhdGlvbicsIFsKICAgICdjb25maWd1cmUnLAogICAgJ3NldF9zcGVha2VyX2RldmljZScsCiAgICAnc2V0X21pY3JvcGhvbmVfZGV2aWNlJywKICAgICdzZXRfcmluZ2VyX2RldmljZScsCiAgICAnc3BlYWtlcl9kZXZpY2VfY2hhbmdlZCcsCiAgICAnbWljcm9waG9uZV9kZXZpY2VfY2hhbmdlZCcsCiAgICAncmluZ2VyX2RldmljZV9jaGFuZ2VkJwogIF0pOwoKICB2YXIgRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdkaXNhc3RlclJlY292ZXJ5JywgWwogICAgJ3N1cHByZXNzJywKICAgICdmb3JjZV9vZmZsaW5lJywgLy8gbGV0dGluZyB0aGUgc2hhcmVkd29ya2VyIGtub3cgdG8gZm9yY2Ugb2ZmbGluZSAKICAgICdzZXRfb2ZmbGluZScsIC8vIGlmcmFtZSBsZXR0aW5nIHRoZSBuYXRpdmUgY2NwIHRvIHNldCBvZmZsaW5lCiAgICAnaW5pdF9kaXNhc3Rlcl9yZWNvdmVyeScsCiAgICAnZmFpbG92ZXInIC8vIHVzZWQgdG8gcHJvcGFnYXRlIGZhaWxvdmVyIHN0YXRlIHRvIG90aGVyIHdpbmRvd3MKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb25maWd1cmF0aW9uIEV2ZW50cwogICAqLwogIHZhciBDb25maWd1cmF0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbmZpZ3VyYXRpb24nLCBbCiAgICAnY29uZmlndXJlJywKICAgICdzZXRfc3BlYWtlcl9kZXZpY2UnLAogICAgJ3NldF9taWNyb3Bob25lX2RldmljZScsCiAgICAnc2V0X3Jpbmdlcl9kZXZpY2UnLAogICAgJ3NwZWFrZXJfZGV2aWNlX2NoYW5nZWQnLAogICAgJ21pY3JvcGhvbmVfZGV2aWNlX2NoYW5nZWQnLAogICAgJ3Jpbmdlcl9kZXZpY2VfY2hhbmdlZCcKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBWb2ljZUlkIEV2ZW50cwogICAqLwogICB2YXIgVm9pY2VJZEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd2b2ljZUlkJywgWwogICAgJ3VwZGF0ZV9kb21haW5faWQnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEV2ZW50RmFjdG9yeQogICAqLwogIHZhciBFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoKSB7IH07CiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QgPSBmdW5jdGlvbiAodHlwZSwgbWV0aG9kLCBwYXJhbXMpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IGNvbm5lY3QucmFuZG9tSWQoKSwKICAgICAgbWV0aG9kOiBtZXRob2QsCiAgICAgIHBhcmFtczogcGFyYW1zCiAgICB9OwogIH07CgogIEV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZSA9IGZ1bmN0aW9uICh0eXBlLCByZXF1ZXN0LCBkYXRhLCBlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QucmVxdWVzdElkLAogICAgICBkYXRhOiBkYXRhLAogICAgICBlcnI6IGVyciB8fCBudWxsCiAgICB9OwogIH07CgogIC8qKgogICAqIEFuIG9iamVjdCByZXByZXNlbnRpbmcgYW4gZXZlbnQgc3Vic2NyaXB0aW9uIGluIGFuIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAoc3ViTWFwLCBldmVudE5hbWUsIGYpIHsKICAgIHRoaXMuc3ViTWFwID0gc3ViTWFwOwogICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgdGhpcy5mID0gZjsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSB0aGUgaGFuZGxlciBvZiB0aGlzIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBFdmVudEJ1cwogICAqIGZyb20gd2hpY2ggaXQgd2FzIGNyZWF0ZWQuCiAgICovCiAgU3Vic2NyaXB0aW9uLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLnVuc3Vic2NyaWJlKHRoaXMuZXZlbnROYW1lLCB0aGlzLmlkKTsKICB9OwoKICAvKioKICAgKiBBIG1hcCBvZiBldmVudCBzdWJzY3JpcHRpb25zLCB1c2VkIGJ5IHRoZSBFdmVudEJ1cy4KICAgKi8KICB2YXIgU3Vic2NyaXB0aW9uTWFwID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJJZE1hcCA9IHt9OwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXAgPSB7fTsKICB9OwoKICAvKioKICAgKiBBZGQgYSBzdWJzY3JpcHRpb24gZm9yIHRoZSBuYW1lZCBldmVudC4gIENyZWF0ZXMgYSBuZXcgU3Vic2NyaXB0aW9uCiAgICogb2JqZWN0IGFuZCByZXR1cm5zIGl0LiAgVGhpcyBvYmplY3QgY2FuIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICB2YXIgc3ViID0gbmV3IFN1YnNjcmlwdGlvbih0aGlzLCBldmVudE5hbWUsIGYpOwoKICAgIHRoaXMuc3ViSWRNYXBbc3ViLmlkXSA9IHN1YjsKICAgIHZhciBzdWJMaXN0ID0gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICAgIHN1Ykxpc3QucHVzaChzdWIpOwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHN1Ykxpc3Q7CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGEgc3Vic2NyaXB0aW9uIG1hdGNoaW5nIHRoZSBnaXZlbiBldmVudCBuYW1lIGFuZCBpZC4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgc3ViSWQpIHsKICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKHRoaXMuc3ViRXZlbnROYW1lTWFwLCBldmVudE5hbWUpKSB7CiAgICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdLmZpbHRlcihmdW5jdGlvbiAocykgeyByZXR1cm4gcy5pZCAhPT0gc3ViSWQ7IH0pOwoKICAgICAgaWYgKHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0ubGVuZ3RoIDwgMSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdOwogICAgICB9CiAgICB9CgogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJJZE1hcCwgc3ViSWQpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN1YklkTWFwW3N1YklkXTsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGFsbCBzdWJzY3JpcHRpb25zIGluIHRoZSBzdWJzY3JpcHRpb24gbWFwLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuZ2V0QWxsU3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN1YkV2ZW50TmFtZU1hcCkucmVkdWNlKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhLmNvbmNhdChiKTsKICAgIH0sIFtdKTsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHRoZSBnaXZlbiBldmVudCBuYW1lLCBvciBhbiBlbXB0eQogICAqIGxpc3QgaWYgdGhlcmUgYXJlIG5vIHN1YnNjcmlwdGlvbnMuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gfHwgW107CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHdoaWNoIG1haW50YWlucyBhIG1hcCBvZiBzdWJzY3JpcHRpb25zIGFuZCBzZXJ2ZXMgYXMgdGhlCiAgICogbWVjaGFuaXNtIGZvciB0cmlnZ2VyaW5nIGV2ZW50cyB0byBiZSBoYW5kbGVkIGJ5IHN1YnNjcmliZXJzLgogICAqLwogIHZhciBFdmVudEJ1cyA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwoKICAgIHRoaXMuc3ViTWFwID0gbmV3IFN1YnNjcmlwdGlvbk1hcCgpOwogICAgdGhpcy5sb2dFdmVudHMgPSBwYXJhbXMubG9nRXZlbnRzIHx8IGZhbHNlOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSB0byB0aGUgbmFtZWQgZXZlbnQuICBSZXR1cm5zIGEgbmV3IFN1YnNjcmlwdGlvbiBvYmplY3QKICAgKiB3aGljaCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmUgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYWxsIGV2ZW50cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuc3Vic2NyaWJlKEFMTF9FVkVOVFMsIGYpOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuZ2V0U3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKGV2ZW50TmFtZSk7CiAgfTsKCiAgLyoqCiAgICogVHJpZ2dlciB0aGUgZ2l2ZW4gZXZlbnQgd2l0aCB0aGUgZ2l2ZW4gZGF0YS4gIEFsbCBtZXRob2RzIHN1YnNjcmliZWQKICAgKiB0byB0aGlzIGV2ZW50IHdpbGwgYmUgY2FsbGVkIGFuZCBhcmUgcHJvdmlkZWQgd2l0aCB0aGUgZ2l2ZW4gYXJiaXRyYXJ5CiAgICogZGF0YSBvYmplY3QgYW5kIHRoZSBuYW1lIG9mIHRoZSBldmVudCwgaW4gdGhhdCBvcmRlci4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBhbGxFdmVudFN1YnMgPSB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKEFMTF9FVkVOVFMpOwogICAgdmFyIGV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKCiAgICBpZiAodGhpcy5sb2dFdmVudHMgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLkxPRyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HCiAgICApIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiUHVibGlzaGluZyBldmVudDogJXMiLCBldmVudE5hbWUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CgogICAgaWYgKAogICAgICBldmVudE5hbWUuc3RhcnRzV2l0aChjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpICYmCiAgICAgIGRhdGEgJiYKICAgICAgZGF0YS5jb250YWN0SWQgJiYKICAgICAgIShkYXRhIGluc3RhbmNlb2YgY29ubmVjdC5Db250YWN0KQogICAgKSB7CiAgICAgIGRhdGEgPSBuZXcgY29ubmVjdC5Db250YWN0KGRhdGEuY29udGFjdElkKTsKICAgIH0KCiAgICBhbGxFdmVudFN1YnMuY29uY2F0KGV2ZW50U3VicykuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc3ViLmYoZGF0YSB8fCBudWxsLCBldmVudE5hbWUsIHNlbGYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBldmVudCBoYW5kbGVyIGZhaWxlZC4iLCBldmVudE5hbWUpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggYnJpZGdlcyBhbiBldmVudCBmcm9tIGFub3RoZXIgRXZlbnRCdXMgdG8gdGhpcyBidXMuCiAgICoKICAgKiBVc2FnZToKICAgKiBjb25kdWl0Lm9uVXBzdHJlYW0oIk15RXZlbnQiLCBidXMuYnJpZGdlKCkpOwogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5icmlkZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGEsIGV2ZW50KSB7CiAgICAgIHNlbGYudHJpZ2dlcihldmVudCwgZGF0YSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGFsbCBldmVudHMgaW4gdGhlIGV2ZW50IGJ1cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudW5zdWJzY3JpYmVBbGwgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1Yk1hcC5nZXRBbGxTdWJzY3JpcHRpb25zKCkuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5FdmVudEJ1cyA9IEV2ZW50QnVzOwogIGNvbm5lY3QuRXZlbnRGYWN0b3J5ID0gRXZlbnRGYWN0b3J5OwogIGNvbm5lY3QuRXZlbnRUeXBlID0gRXZlbnRUeXBlOwogIGNvbm5lY3QuQWdlbnRFdmVudHMgPSBBZ2VudEV2ZW50czsKICBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMgPSBDb25maWd1cmF0aW9uRXZlbnRzOwogIGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cyA9IENvbm5lY3Rpb25FdmVudHM7CiAgY29ubmVjdC5Db25ubmVjdGlvbkV2ZW50cyA9IENvbm5lY3Rpb25FdmVudHM7IC8vZGVwcmVjYXRlIG9uIG5leHQgbWFqb3IgdmVyc2lvbiByZWxlYXNlLgogIGNvbm5lY3QuQ29udGFjdEV2ZW50cyA9IENvbnRhY3RFdmVudHM7CiAgY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cyA9IENoYW5uZWxWaWV3RXZlbnRzOwogIGNvbm5lY3QuVGFza0V2ZW50cyA9IFRhc2tFdmVudHM7CiAgY29ubmVjdC5Wb2ljZUlkRXZlbnRzID0gVm9pY2VJZEV2ZW50czsKICBjb25uZWN0LldlYlNvY2tldEV2ZW50cyA9IFdlYlNvY2tldEV2ZW50czsKICBjb25uZWN0Lk1hc3RlclRvcGljcyA9IE1hc3RlclRvcGljczsKICBjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBEaXNhc3RlclJlY292ZXJ5RXZlbnRzOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMjg2OgovKioqLyAoKCkgPT4gewoKIWZ1bmN0aW9uKGUpe3ZhciBuPXt9O2Z1bmN0aW9uIHQobyl7aWYobltvXSlyZXR1cm4gbltvXS5leHBvcnRzO3ZhciByPW5bb109e2k6byxsOiExLGV4cG9ydHM6e319O3JldHVybiBlW29dLmNhbGwoci5leHBvcnRzLHIsci5leHBvcnRzLHQpLHIubD0hMCxyLmV4cG9ydHN9dC5tPWUsdC5jPW4sdC5kPWZ1bmN0aW9uKGUsbixvKXt0Lm8oZSxuKXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsbix7ZW51bWVyYWJsZTohMCxnZXQ6b30pfSx0LnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sdC50PWZ1bmN0aW9uKGUsbil7aWYoMSZuJiYoZT10KGUpKSw4Jm4pcmV0dXJuIGU7aWYoNCZuJiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbz1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHQucihvKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobywiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImbiYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgciBpbiBlKXQuZChvLHIsZnVuY3Rpb24obil7cmV0dXJuIGVbbl19LmJpbmQobnVsbCxyKSk7cmV0dXJuIG99LHQubj1mdW5jdGlvbihlKXt2YXIgbj1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gdC5kKG4sImEiLG4pLG59LHQubz1mdW5jdGlvbihlLG4pe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSxuKX0sdC5wPSIiLHQodC5zPTIpfShbZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt2YXIgbz10KDEpLHI9Ik5VTEwiLGk9IkNMSUVOVF9MT0dHRVIiLGM9IkRFQlVHIixhPTJlMyxzPSJBTVpfV0VCX1NPQ0tFVF9NQU5BR0VSOiIsdT0iTmV0d29yayBvZmZsaW5lIixsPSJOZXR3b3JrIG9ubGluZSwgY29ubmVjdGluZyB0byBXZWJTb2NrZXQgc2VydmVyIixmPSJOZXR3b3JrIG9mZmxpbmUsIGlnbm9yaW5nIHRoaXMgZ2V0V2ViU29ja2V0Q29ubkNvbmZpZyByZXF1ZXN0IixkPSJIZWFydGJlYXQgcmVzcG9uc2Ugbm90IHJlY2VpdmVkIixwPSJIZWFydGJlYXQgcmVzcG9uc2UgcmVjZWl2ZWQiLGc9IlNlbmRpbmcgaGVhcnRiZWF0IixiPSJGYWlsZWQgdG8gc2VuZCBoZWFydGJlYXQgc2luY2UgV2ViU29ja2V0IGlzIG5vdCBvcGVuIix5PSJXZWJTb2NrZXQgY29ubmVjdGlvbiBlc3RhYmxpc2hlZCEiLG09IldlYlNvY2tldCBjb25uZWN0aW9uIGlzIGNsb3NlZCIsdj0iV2ViU29ja2V0TWFuYWdlciBFcnJvciwgZXJyb3JfZXZlbnQ6ICIsUz0iU2NoZWR1bGluZyBXZWJTb2NrZXQgcmVpbml0aWFsaXphdGlvbiwgYWZ0ZXIgZGVsYXkgIixoPSJXZWJTb2NrZXQgVVJMIGNhbm5vdCBiZSB1c2VkIHRvIGVzdGFibGlzaCBjb25uZWN0aW9uIixrPSJXZWJTb2NrZXQgSW5pdGlhbGl6YXRpb24gZmFpbGVkIC0gVGVybWluYXRpbmcgYW5kIGNsZWFuaW5nIHN1YnNjcmlwdGlvbnMiLHc9IlRlcm1pbmF0aW5nIFdlYlNvY2tldCBNYW5hZ2VyIixDPSJGZXRjaGluZyBuZXcgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsTD0iU3VjY2Vzc2Z1bGx5IGZldGNoZWQgd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsVD0iRmFpbGVkIHRvIGZldGNoIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLE89IlJldHJ5aW5nIGZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixXPSJJbml0aWFsaXppbmcgV2Vic29ja2V0IE1hbmFnZXIiLEk9IkluaXRpYWxpemluZyBXZWJzb2NrZXQgTWFuYWdlciBGYWlsZWQhIixOPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBvcGVuIixfPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBjbG9zZSIsRT0iV2Vic29ja2V0IGNvbm5lY3Rpb24gZ2FpbiIsRj0iV2Vic29ja2V0IGNvbm5lY3Rpb24gbG9zdCIsQT0iV2Vic29ja2V0IHN1YnNjcmlwdGlvbiBmYWlsdXJlIixSPSJSZXNldCBXZWJzb2NrZXQgc3RhdGUiLHg9IldlYlNvY2tldE1hbmFnZXIgTWVzc2FnZSBFcnJvciIsRD0iTWVzc2FnZSByZWNlaXZlZCBmb3IgdG9waWMgIixqPSJJbnZhbGlkIGluY29taW5nIG1lc3NhZ2UiLE09IldlYnNvY2tldE1hbmFnZXIgaW52b2tlIGNhbGxiYWNrcyBmb3IgdG9waWMgc3VjY2VzcyAiLEc9ImF3cy9zdWJzY3JpYmUiLHo9ImF3cy91bnN1YnNjcmliZSIsUD0iYXdzL2hlYXJ0YmVhdCIsSD0iY29ubmVjdGVkIixVPSJkaXNjb25uZWN0ZWQiO2Z1bmN0aW9uIHEoZSl7cmV0dXJuKHE9ImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3I/ZnVuY3Rpb24oZSl7cmV0dXJuIHR5cGVvZiBlfTpmdW5jdGlvbihlKXtyZXR1cm4gZSYmImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmZS5jb25zdHJ1Y3Rvcj09PVN5bWJvbCYmZSE9PVN5bWJvbC5wcm90b3R5cGU/InN5bWJvbCI6dHlwZW9mIGV9KShlKX12YXIgSj17YXNzZXJ0VHJ1ZTpmdW5jdGlvbihlLG4pe2lmKCFlKXRocm93IG5ldyBFcnJvcihuKX0sYXNzZXJ0Tm90TnVsbDpmdW5jdGlvbihlLG4pe3JldHVybiBKLmFzc2VydFRydWUobnVsbCE9PWUmJnZvaWQgMCE9PXEoZSksT2JqZWN0KG8uc3ByaW50ZikoIiVzIG11c3QgYmUgcHJvdmlkZWQiLG58fCJBIHZhbHVlIikpLGV9LGlzTm9uRW1wdHlTdHJpbmc6ZnVuY3Rpb24oZSl7cmV0dXJuInN0cmluZyI9PXR5cGVvZiBlJiZlLmxlbmd0aD4wfSxhc3NlcnRJc0xpc3Q6ZnVuY3Rpb24oZSxuKXtpZighQXJyYXkuaXNBcnJheShlKSl0aHJvdyBuZXcgRXJyb3IobisiIGlzIG5vdCBhbiBhcnJheSIpfSxpc0Z1bmN0aW9uOmZ1bmN0aW9uKGUpe3JldHVybiEhKGUmJmUuY29uc3RydWN0b3ImJmUuY2FsbCYmZS5hcHBseSl9LGlzT2JqZWN0OmZ1bmN0aW9uKGUpe3JldHVybiEoIm9iamVjdCIhPT1xKGUpfHxudWxsPT09ZSl9LGlzU3RyaW5nOmZ1bmN0aW9uKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZX0saXNOdW1iZXI6ZnVuY3Rpb24oZSl7cmV0dXJuIm51bWJlciI9PXR5cGVvZiBlfX0sQj1uZXcgUmVnRXhwKCJeKHdzczovLylcXHcqIik7Si52YWxpZFdTVXJsPWZ1bmN0aW9uKGUpe3JldHVybiBCLnRlc3QoZSl9LEouZ2V0U3Vic2NyaXB0aW9uUmVzcG9uc2U9ZnVuY3Rpb24oZSxuLHQpe3JldHVybnt0b3BpYzplLGNvbnRlbnQ6e3N0YXR1czpuPyJzdWNjZXNzIjoiZmFpbHVyZSIsdG9waWNzOnR9fX0sSi5hc3NlcnRJc09iamVjdD1mdW5jdGlvbihlLG4pe2lmKCFKLmlzT2JqZWN0KGUpKXRocm93IG5ldyBFcnJvcihuKyIgaXMgbm90IGFuIG9iamVjdCEiKX0sSi5hZGRKaXR0ZXI9ZnVuY3Rpb24oZSl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOjE7bj1NYXRoLm1pbihuLDEpO3ZhciB0PU1hdGgucmFuZG9tKCk+LjU/MTotMTtyZXR1cm4gTWF0aC5mbG9vcihlK3QqZSpNYXRoLnJhbmRvbSgpKm4pfSxKLmlzTmV0d29ya09ubGluZT1mdW5jdGlvbigpe3JldHVybiBuYXZpZ2F0b3Iub25MaW5lfSxKLmlzTmV0d29ya0ZhaWx1cmU9ZnVuY3Rpb24oZSl7cmV0dXJuISghZS5fZGVidWd8fCFlLl9kZWJ1Zy50eXBlKSYmIk5ldHdvcmtpbmdFcnJvciI9PT1lLl9kZWJ1Zy50eXBlfTt2YXIgVj1KO2Z1bmN0aW9uIFgoZSxuKXtyZXR1cm4hbnx8Im9iamVjdCIhPT1aKG4pJiYiZnVuY3Rpb24iIT10eXBlb2Ygbj9mdW5jdGlvbihlKXtpZih2b2lkIDA9PT1lKXRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7cmV0dXJuIGV9KGUpOm59ZnVuY3Rpb24gJChlKXtyZXR1cm4oJD1PYmplY3Quc2V0UHJvdG90eXBlT2Y/T2JqZWN0LmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKGUpe3JldHVybiBlLl9fcHJvdG9fX3x8T2JqZWN0LmdldFByb3RvdHlwZU9mKGUpfSkoZSl9ZnVuY3Rpb24gSyhlLG4pe3JldHVybihLPU9iamVjdC5zZXRQcm90b3R5cGVPZnx8ZnVuY3Rpb24oZSxuKXtyZXR1cm4gZS5fX3Byb3RvX189bixlfSkoZSxuKX1mdW5jdGlvbiBaKGUpe3JldHVybihaPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9ZnVuY3Rpb24gUShlLG4pe2lmKCEoZSBpbnN0YW5jZW9mIG4pKXRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpfWZ1bmN0aW9uIFkoZSxuKXtmb3IodmFyIHQ9MDt0PG4ubGVuZ3RoO3QrKyl7dmFyIG89blt0XTtvLmVudW1lcmFibGU9by5lbnVtZXJhYmxlfHwhMSxvLmNvbmZpZ3VyYWJsZT0hMCwidmFsdWUiaW4gbyYmKG8ud3JpdGFibGU9ITApLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG8ua2V5LG8pfX1mdW5jdGlvbiBlZShlLG4sdCl7cmV0dXJuIG4mJlkoZS5wcm90b3R5cGUsbiksdCYmWShlLHQpLGV9dmFyIG5lPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZSgpe1EodGhpcyxlKX1yZXR1cm4gZWUoZSxbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6Indhcm4iLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJhZHZhbmNlZExvZyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX1dKSxlfSgpLHRlPXMsb2U9e0RFQlVHOjEwLElORk86MjAsV0FSTjozMCxFUlJPUjo0MCxBRFZBTkNFRF9MT0c6NTB9LHJlPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZSgpe1EodGhpcyxlKSx0aGlzLnVwZGF0ZUxvZ2dlckNvbmZpZygpLHRoaXMuY29uc29sZUxvZ2dlcldyYXBwZXI9YWUoKX1yZXR1cm4gZWUoZSxbe2tleToid3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLmhhc0NsaWVudExvZ2dlcigpKXN3aXRjaChlKXtjYXNlIG9lLkRFQlVHOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuZGVidWcobil8fG47Y2FzZSBvZS5JTkZPOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuaW5mbyhuKXx8bjtjYXNlIG9lLldBUk46cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci53YXJuKG4pfHxuO2Nhc2Ugb2UuRVJST1I6cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5lcnJvcihuKXx8bjtjYXNlIG9lLkFEVkFOQ0VEX0xPRzpyZXR1cm4gdGhpcy5fYWR2YW5jZWRMb2dXcml0ZXI/dGhpcy5fY2xpZW50TG9nZ2VyW3RoaXMuX2FkdmFuY2VkTG9nV3JpdGVyXShuKXx8bjoiIn19fSx7a2V5OiJpc0xldmVsRW5hYmxlZCIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIGU+PXRoaXMuX2xldmVsfX0se2tleToiaGFzQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbigpe3JldHVybiBudWxsIT09dGhpcy5fY2xpZW50TG9nZ2VyfX0se2tleToiZ2V0TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlKXt2YXIgbj1lLnByZWZpeHx8dGU7cmV0dXJuIHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj09PWM/dGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcjpuZXcgY2Uobil9fSx7a2V5OiJ1cGRhdGVMb2dnZXJDb25maWciLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWV8fHt9O3RoaXMuX2xldmVsPW4ubGV2ZWx8fG9lLklORk8sdGhpcy5fYWR2YW5jZWRMb2dXcml0ZXI9Indhcm4iLG4uYWR2YW5jZWRMb2dXcml0ZXImJih0aGlzLl9hZHZhbmNlZExvZ1dyaXRlcj1uLmFkdmFuY2VkTG9nV3JpdGVyKSxuLmN1c3RvbWl6ZWRMb2dnZXImJiJvYmplY3QiPT09WihuLmN1c3RvbWl6ZWRMb2dnZXIpJiYodGhpcy51c2VDbGllbnRMb2dnZXI9ITApLHRoaXMuX2NsaWVudExvZ2dlcj1uLmxvZ2dlcnx8dGhpcy5zZWxlY3RMb2dnZXIobiksdGhpcy5fbG9nc0Rlc3RpbmF0aW9uPXIsbi5kZWJ1ZyYmKHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1jKSxuLmxvZ2dlciYmKHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1pKX19LHtrZXk6InNlbGVjdExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuY3VzdG9taXplZExvZ2dlciYmIm9iamVjdCI9PT1aKGUuY3VzdG9taXplZExvZ2dlcik/ZS5jdXN0b21pemVkTG9nZ2VyOmUudXNlRGVmYXVsdExvZ2dlcj8odGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcj1hZSgpLHRoaXMuY29uc29sZUxvZ2dlcldyYXBwZXIpOm51bGx9fV0pLGV9KCksaWU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7USh0aGlzLGUpfXJldHVybiBlZShlLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6Indhcm4iLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiYWR2YW5jZWRMb2ciLHZhbHVlOmZ1bmN0aW9uKCl7fX1dKSxlfSgpLGNlPWZ1bmN0aW9uKGUpe2Z1bmN0aW9uIG4oZSl7dmFyIHQ7cmV0dXJuIFEodGhpcyxuKSwodD1YKHRoaXMsJChuKS5jYWxsKHRoaXMpKSkucHJlZml4PWV8fHRlLHR9cmV0dXJuIGZ1bmN0aW9uKGUsbil7aWYoImZ1bmN0aW9uIiE9dHlwZW9mIG4mJm51bGwhPT1uKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uIik7ZS5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShuJiZuLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmUsd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfX0pLG4mJksoZSxuKX0obixpZSksZWUobixbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5ERUJVRyxuKX19LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5JTkZPLG4pfX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLldBUk4sbil9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLkVSUk9SLG4pfX0se2tleToiYWR2YW5jZWRMb2ciLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5BRFZBTkNFRF9MT0csbil9fSx7a2V5OiJfc2hvdWxkTG9nIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gc2UuaGFzQ2xpZW50TG9nZ2VyKCkmJnNlLmlzTGV2ZWxFbmFibGVkKGUpfX0se2tleToiX3dyaXRlVG9DbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUsbil7cmV0dXJuIHNlLndyaXRlVG9DbGllbnRMb2dnZXIoZSxuKX19LHtrZXk6Il9sb2ciLHZhbHVlOmZ1bmN0aW9uKGUsbil7aWYodGhpcy5fc2hvdWxkTG9nKGUpKXt2YXIgdD1zZS51c2VDbGllbnRMb2dnZXI/bjp0aGlzLl9jb252ZXJ0VG9TaW5nbGVTdGF0ZW1lbnQobixlKTtyZXR1cm4gdGhpcy5fd3JpdGVUb0NsaWVudExvZ2dlcihlLHQpfX19LHtrZXk6Il9jb252ZXJ0VG9TaW5nbGVTdGF0ZW1lbnQiLHZhbHVlOmZ1bmN0aW9uKGUsbil7dmFyIHQ9bmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSxvPXRoaXMuX2dldExvZ0xldmVsQnlWYWx1ZShuKSxyPSJbIi5jb25jYXQodCwiXVsiKS5jb25jYXQobywiXSIpO3RoaXMucHJlZml4JiYocis9dGhpcy5wcmVmaXgrIiAiKSx0aGlzLm9wdGlvbnMmJih0aGlzLm9wdGlvbnMucHJlZml4P3IrPSIgIit0aGlzLm9wdGlvbnMucHJlZml4KyI6IjpyKz0iIix0aGlzLm9wdGlvbnMubG9nTWV0YURhdGE/cis9IiBNZXRhIGRhdGE6ICIrSlNPTi5zdHJpbmdpZnkodGhpcy5vcHRpb25zLmxvZ01ldGFEYXRhKTpyKz0iIik7Zm9yKHZhciBpPTA7aTxlLmxlbmd0aDtpKyspe3ZhciBjPWVbaV07cis9dGhpcy5fY29udmVydFRvU3RyaW5nKGMpKyIgIn1yZXR1cm4gcn19LHtrZXk6Il9nZXRMb2dMZXZlbEJ5VmFsdWUiLHZhbHVlOmZ1bmN0aW9uKGUpe3N3aXRjaChlKXtjYXNlIDEwOnJldHVybiJERUJVRyI7Y2FzZSAyMDpyZXR1cm4iSU5GTyI7Y2FzZSAzMDpyZXR1cm4iV0FSTiI7Y2FzZSA0MDpyZXR1cm4iRVJST1IiO2Nhc2UgNTA6cmV0dXJuIkFEVkFOQ0VEX0xPRyJ9fX0se2tleToiX2NvbnZlcnRUb1N0cmluZyIsdmFsdWU6ZnVuY3Rpb24oZSl7dHJ5e2lmKCFlKXJldHVybiIiO2lmKFYuaXNTdHJpbmcoZSkpcmV0dXJuIGU7aWYoVi5pc09iamVjdChlKSYmVi5pc0Z1bmN0aW9uKGUudG9TdHJpbmcpKXt2YXIgbj1lLnRvU3RyaW5nKCk7aWYoIltvYmplY3QgT2JqZWN0XSIhPT1uKXJldHVybiBufXJldHVybiBKU09OLnN0cmluZ2lmeShlKX1jYXRjaChuKXtyZXR1cm4gY29uc29sZS5lcnJvcigiRXJyb3Igd2hpbGUgY29udmVydGluZyBhcmd1bWVudCB0byBzdHJpbmciLGUsbiksIiJ9fX1dKSxufSgpLGFlPWZ1bmN0aW9uKCl7dmFyIGU9bmV3IGllO3JldHVybiBlLmRlYnVnPWZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIGNvbnNvbGUuZGVidWcuYXBwbHkod2luZG93LmNvbnNvbGUsW10uY29uY2F0KG4pKX0sZS5pbmZvPWZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIGNvbnNvbGUuaW5mby5hcHBseSh3aW5kb3cuY29uc29sZSxbXS5jb25jYXQobikpfSxlLndhcm49ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS53YXJuLmFwcGx5KHdpbmRvdy5jb25zb2xlLFtdLmNvbmNhdChuKSl9LGUuZXJyb3I9ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS5lcnJvci5hcHBseSh3aW5kb3cuY29uc29sZSxbXS5jb25jYXQobikpfSxlfSxzZT1uZXcgcmU7ZnVuY3Rpb24gdWUoZSxuKXtmb3IodmFyIHQ9MDt0PG4ubGVuZ3RoO3QrKyl7dmFyIG89blt0XTtvLmVudW1lcmFibGU9by5lbnVtZXJhYmxlfHwhMSxvLmNvbmZpZ3VyYWJsZT0hMCwidmFsdWUiaW4gbyYmKG8ud3JpdGFibGU9ITApLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG8ua2V5LG8pfX12YXIgbGU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKG4pe3ZhciB0PWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXTphOyFmdW5jdGlvbihlLG4pe2lmKCEoZSBpbnN0YW5jZW9mIG4pKXRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpfSh0aGlzLGUpLHRoaXMubnVtQXR0ZW1wdHM9MCx0aGlzLmV4ZWN1dG9yPW4sdGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITEsdGhpcy5kZWZhdWx0UmV0cnk9dH12YXIgbix0LG87cmV0dXJuIG49ZSwodD1be2tleToicmV0cnkiLHZhbHVlOmZ1bmN0aW9uKCl7dmFyIGU9dGhpczt0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbnx8KHRoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9uPSEwLHNldFRpbWVvdXQoZnVuY3Rpb24oKXtlLl9leGVjdXRlKCl9LHRoaXMuX2dldERlbGF5KCkpKX19LHtrZXk6Il9leGVjdXRlIix2YWx1ZTpmdW5jdGlvbigpe3RoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9uPSExLHRoaXMuZXhlY3V0b3IoKSx0aGlzLm51bUF0dGVtcHRzKyt9fSx7a2V5OiJjb25uZWN0ZWQiLHZhbHVlOmZ1bmN0aW9uKCl7dGhpcy5udW1BdHRlbXB0cz0wfX0se2tleToiX2dldERlbGF5Iix2YWx1ZTpmdW5jdGlvbigpe3ZhciBlPU1hdGgucG93KDIsdGhpcy5udW1BdHRlbXB0cykqdGhpcy5kZWZhdWx0UmV0cnk7cmV0dXJuIGU8PTNlND9lOjNlNH19LHtrZXk6ImdldElzQ29ubmVjdGVkIix2YWx1ZTpmdW5jdGlvbigpe3JldHVybiF0aGlzLm51bUF0dGVtcHRzfX1dKSYmdWUobi5wcm90b3R5cGUsdCksbyYmdWUobixvKSxlfSgpO3QuZChuLCJhIixmdW5jdGlvbigpe3JldHVybiBkZX0pO3ZhciBmZT1mdW5jdGlvbigpe3ZhciBlPXNlLmdldExvZ2dlcih7cHJlZml4OnN9KSxuPVYuaXNOZXR3b3JrT25saW5lKCksdD17cHJpbWFyeTpudWxsLHNlY29uZGFyeTpudWxsfSxvPXtyZWNvbm5lY3RXZWJTb2NrZXQ6ITAsd2Vic29ja2V0SW5pdEZhaWxlZDohMSxleHBvbmVudGlhbEJhY2tPZmZUaW1lOjFlMyxleHBvbmVudGlhbFRpbWVvdXRIYW5kbGU6bnVsbCxsaWZlVGltZVRpbWVvdXRIYW5kbGU6bnVsbCx3ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZDpudWxsLGNvbm5TdGF0ZTpudWxsfSxyPXtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDowLGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOm51bGwsbm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6bnVsbH0saT17cGVuZGluZ1Jlc3BvbnNlOiExLGludGVydmFsSGFuZGxlOm51bGx9LGM9e2luaXRGYWlsdXJlOm5ldyBTZXQsZ2V0V2ViU29ja2V0VHJhbnNwb3J0Om51bGwsc3Vic2NyaXB0aW9uVXBkYXRlOm5ldyBTZXQsc3Vic2NyaXB0aW9uRmFpbHVyZTpuZXcgU2V0LHRvcGljOm5ldyBNYXAsYWxsTWVzc2FnZTpuZXcgU2V0LGNvbm5lY3Rpb25HYWluOm5ldyBTZXQsY29ubmVjdGlvbkxvc3Q6bmV3IFNldCxjb25uZWN0aW9uT3BlbjpuZXcgU2V0LGNvbm5lY3Rpb25DbG9zZTpuZXcgU2V0fSxhPXtjb25uQ29uZmlnOm51bGwscHJvbWlzZUhhbmRsZTpudWxsLHByb21pc2VDb21wbGV0ZWQ6ITB9LHE9e3N1YnNjcmliZWQ6bmV3IFNldCxwZW5kaW5nOm5ldyBTZXQsc3Vic2NyaXB0aW9uSGlzdG9yeTpuZXcgU2V0fSxKPXtyZXNwb25zZUNoZWNrSW50ZXJ2YWxJZDpudWxsLHJlcXVlc3RDb21wbGV0ZWQ6ITAscmVTdWJzY3JpYmVJbnRlcnZhbElkOm51bGwsY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0czowLGNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q6MH0sQj1uZXcgbGUoZnVuY3Rpb24oKXtoZSgpfSksWD1uZXcgU2V0KFtHLHosUF0pLCQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtpZihuIT09Vi5pc05ldHdvcmtPbmxpbmUoKSl7aWYoIShuPVYuaXNOZXR3b3JrT25saW5lKCkpKXJldHVybiBlLmFkdmFuY2VkTG9nKHUpLHZvaWQgQ2UoZS5pbmZvKHUpKTt2YXIgdD10ZSgpO24mJighdHx8WSh0LFdlYlNvY2tldC5DTE9TSU5HKXx8WSh0LFdlYlNvY2tldC5DTE9TRUQpKSYmKGUuYWR2YW5jZWRMb2cobCksQ2UoZS5pbmZvKGwpKSxoZSgpKX19LDI1MCksSz1mdW5jdGlvbihuLHQpe24uZm9yRWFjaChmdW5jdGlvbihuKXt0cnl7bih0KX1jYXRjaChuKXtDZShlLmVycm9yKCJFcnJvciBleGVjdXRpbmcgY2FsbGJhY2siLG4pKX19KX0sWj1mdW5jdGlvbihlKXtpZihudWxsPT09ZSlyZXR1cm4iTlVMTCI7c3dpdGNoKGUucmVhZHlTdGF0ZSl7Y2FzZSBXZWJTb2NrZXQuQ09OTkVDVElORzpyZXR1cm4iQ09OTkVDVElORyI7Y2FzZSBXZWJTb2NrZXQuT1BFTjpyZXR1cm4iT1BFTiI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0lORzpyZXR1cm4iQ0xPU0lORyI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0VEOnJldHVybiJDTE9TRUQiO2RlZmF1bHQ6cmV0dXJuIlVOREVGSU5FRCJ9fSxRPWZ1bmN0aW9uKCl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOiIiO0NlKGUuZGVidWcoIlsiK24rIl0gUHJpbWFyeSBXZWJTb2NrZXQ6ICIrWih0LnByaW1hcnkpKyIgfCBTZWNvbmRhcnkgV2ViU29ja2V0OiAiK1oodC5zZWNvbmRhcnkpKSl9LFk9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gZSYmZS5yZWFkeVN0YXRlPT09bn0sZWU9ZnVuY3Rpb24oZSl7cmV0dXJuIFkoZSxXZWJTb2NrZXQuT1BFTil9LG5lPWZ1bmN0aW9uKGUpe3JldHVybiBudWxsPT09ZXx8dm9pZCAwPT09ZS5yZWFkeVN0YXRlfHxZKGUsV2ViU29ja2V0LkNMT1NFRCl9LHRlPWZ1bmN0aW9uKCl7cmV0dXJuIG51bGwhPT10LnNlY29uZGFyeT90LnNlY29uZGFyeTp0LnByaW1hcnl9LG9lPWZ1bmN0aW9uKCl7cmV0dXJuIGVlKHRlKCkpfSxyZT1mdW5jdGlvbigpe2lmKGkucGVuZGluZ1Jlc3BvbnNlKXJldHVybiBlLmFkdmFuY2VkTG9nKGQpLENlKGUud2FybihkKSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxpLnBlbmRpbmdSZXNwb25zZT0hMSx2b2lkIGhlKCk7b2UoKT8oQ2UoZS5kZWJ1ZyhnKSksdGUoKS5zZW5kKHZlKFApKSxpLnBlbmRpbmdSZXNwb25zZT0hMCk6KGUuYWR2YW5jZWRMb2coYiksQ2UoZS53YXJuKGIpKSxRKCJzZW5kSGVhcnRCZWF0IiksaGUoKSl9LGllPWZ1bmN0aW9uKCl7ZS5hZHZhbmNlZExvZyhSKSxvLmV4cG9uZW50aWFsQmFja09mZlRpbWU9MWUzLGkucGVuZGluZ1Jlc3BvbnNlPSExLG8ucmVjb25uZWN0V2ViU29ja2V0PSEwLGNsZWFyVGltZW91dChvLmxpZmVUaW1lVGltZW91dEhhbmRsZSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxjbGVhclRpbWVvdXQoby5leHBvbmVudGlhbFRpbWVvdXRIYW5kbGUpLGNsZWFyVGltZW91dChvLndlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkKX0sY2U9ZnVuY3Rpb24oKXtKLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCxKLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCxjbGVhckludGVydmFsKEoucmVzcG9uc2VDaGVja0ludGVydmFsSWQpLGNsZWFySW50ZXJ2YWwoSi5yZVN1YnNjcmliZUludGVydmFsSWQpfSxhZT1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ9MCxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPW51bGwsci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD1udWxsfSx1ZT1mdW5jdGlvbigpe0IuY29ubmVjdGVkKCk7dHJ5e2UuYWR2YW5jZWRMb2coeSksQ2UoZS5pbmZvKHkpKSxRKCJ3ZWJTb2NrZXRPbk9wZW4iKSxudWxsIT09by5jb25uU3RhdGUmJm8uY29ublN0YXRlIT09VXx8SyhjLmNvbm5lY3Rpb25HYWluKSxvLmNvbm5TdGF0ZT1IO3ZhciBuPURhdGUubm93KCk7SyhjLmNvbm5lY3Rpb25PcGVuLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsbm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6ci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcCxjb25uZWN0aW9uRXN0YWJsaXNoZWRUaW1lOm4sdGltZVRvQ29ubmVjdDpuLXIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsdGltZVdpdGhvdXRDb25uZWN0aW9uOnIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA/bi1yLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOm51bGx9KSxhZSgpLGllKCksdGUoKS5vcGVuVGltZXN0YW1wPURhdGUubm93KCksMD09PXEuc3Vic2NyaWJlZC5zaXplJiZlZSh0LnNlY29uZGFyeSkmJmdlKHQucHJpbWFyeSwiW1ByaW1hcnkgV2ViU29ja2V0XSBDbG9zaW5nIFdlYlNvY2tldCIpLChxLnN1YnNjcmliZWQuc2l6ZT4wfHxxLnBlbmRpbmcuc2l6ZT4wKSYmKGVlKHQuc2Vjb25kYXJ5KSYmQ2UoZS5pbmZvKCJTdWJzY3JpYmluZyBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIHRvcGljcyBvZiBwcmltYXJ5IHdlYnNvY2tldCIpKSxxLnN1YnNjcmliZWQuZm9yRWFjaChmdW5jdGlvbihlKXtxLnN1YnNjcmlwdGlvbkhpc3RvcnkuYWRkKGUpLHEucGVuZGluZy5hZGQoZSl9KSxxLnN1YnNjcmliZWQuY2xlYXIoKSxwZSgpKSxyZSgpLGkuaW50ZXJ2YWxIYW5kbGU9c2V0SW50ZXJ2YWwocmUsMWU0KTt2YXIgcz0xZTMqYS5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcztDZShlLmRlYnVnKCJTY2hlZHVsaW5nIFdlYlNvY2tldCBtYW5hZ2VyIHJlY29ubmVjdGlvbiwgYWZ0ZXIgZGVsYXkgIitzKyIgbXMiKSksby5saWZlVGltZVRpbWVvdXRIYW5kbGU9c2V0VGltZW91dChmdW5jdGlvbigpe0NlKGUuZGVidWcoIlN0YXJ0aW5nIHNjaGVkdWxlZCBXZWJTb2NrZXQgbWFuYWdlciByZWNvbm5lY3Rpb24iKSksaGUoKX0scyl9Y2F0Y2gobil7Q2UoZS5lcnJvcigiRXJyb3IgYWZ0ZXIgZXN0YWJsaXNoaW5nIFdlYlNvY2tldCBjb25uZWN0aW9uIixuKSl9fSxmZT1mdW5jdGlvbihuKXtRKCJ3ZWJTb2NrZXRPbkVycm9yIiksZS5hZHZhbmNlZExvZyh2LEpTT04uc3RyaW5naWZ5KG4pKSxDZShlLmVycm9yKHYsSlNPTi5zdHJpbmdpZnkobikpKSxCLmdldElzQ29ubmVjdGVkKCk/aGUoKTpCLnJldHJ5KCl9LGRlPWZ1bmN0aW9uKG4pe3ZhciBvPUpTT04ucGFyc2Uobi5kYXRhKTtzd2l0Y2goby50b3BpYyl7Y2FzZSBHOmlmKENlKGUuZGVidWcoIlN1YnNjcmlwdGlvbiBNZXNzYWdlIHJlY2VpdmVkIGZyb20gd2ViU29ja2V0IHNlcnZlciIsbi5kYXRhKSksSi5yZXF1ZXN0Q29tcGxldGVkPSEwLEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLCJzdWNjZXNzIj09PW8uY29udGVudC5zdGF0dXMpSi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTAsby5jb250ZW50LnRvcGljcy5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Euc3Vic2NyaXB0aW9uSGlzdG9yeS5kZWxldGUoZSkscS5wZW5kaW5nLmRlbGV0ZShlKSxxLnN1YnNjcmliZWQuYWRkKGUpfSksMD09PXEuc3Vic2NyaXB0aW9uSGlzdG9yeS5zaXplP2VlKHQuc2Vjb25kYXJ5KSYmKENlKGUuaW5mbygiU3VjY2Vzc2Z1bGx5IHN1YnNjcmliZWQgc2Vjb25kYXJ5IHdlYnNvY2tldCB0byBhbGwgdG9waWNzIG9mIHByaW1hcnkgd2Vic29ja2V0IikpLGdlKHQucHJpbWFyeSwiW1ByaW1hcnkgV2ViU29ja2V0XSBDbG9zaW5nIFdlYlNvY2tldCIpKTpwZSgpLEsoYy5zdWJzY3JpcHRpb25VcGRhdGUsbyk7ZWxzZXtpZihjbGVhckludGVydmFsKEoucmVTdWJzY3JpYmVJbnRlcnZhbElkKSwrK0ouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cyw1PT09Si5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzKXJldHVybiBLKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSxvKSx2b2lkKEouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wKTtKLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe3BlKCl9LDUwMCl9YnJlYWs7Y2FzZSBQOkNlKGUuZGVidWcocCkpLGkucGVuZGluZ1Jlc3BvbnNlPSExO2JyZWFrO2RlZmF1bHQ6aWYoby50b3BpYyl7aWYoZS5hZHZhbmNlZExvZyhELG8udG9waWMpLENlKGUuZGVidWcoRCtvLnRvcGljKSksZWUodC5wcmltYXJ5KSYmZWUodC5zZWNvbmRhcnkpJiYwPT09cS5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemUmJnRoaXM9PT10LnByaW1hcnkpcmV0dXJuIHZvaWQgQ2UoZS53YXJuKCJJZ25vcmluZyBNZXNzYWdlIGZvciBUb3BpYyAiK28udG9waWMrIiwgdG8gYXZvaWQgZHVwbGljYXRlcyIpKTtpZigwPT09Yy5hbGxNZXNzYWdlLnNpemUmJjA9PT1jLnRvcGljLnNpemUpcmV0dXJuIHZvaWQgQ2UoZS53YXJuKCJObyByZWdpc3RlcmVkIGNhbGxiYWNrIGxpc3RlbmVyIGZvciBUb3BpYyIsby50b3BpYykpO2UuYWR2YW5jZWRMb2coTSxvLnRvcGljKSxLKGMuYWxsTWVzc2FnZSxvKSxjLnRvcGljLmhhcyhvLnRvcGljKSYmSyhjLnRvcGljLmdldChvLnRvcGljKSxvKX1lbHNlIG8ubWVzc2FnZT8oZS5hZHZhbmNlZExvZyh4LG8pLENlKGUud2Fybih4LG8pKSk6KGUuYWR2YW5jZWRMb2coaixvKSxDZShlLndhcm4oaixvKSkpfX0scGU9ZnVuY3Rpb24gbigpe2lmKEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD4zKXJldHVybiBDZShlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3Mgc2luY2Ugd2UgaGF2ZSBleGhhdXN0ZWQgbWF4IHN1YnNjcmlwdGlvbiByZXRyaWVzIHdpdGggbm8gcmVzcG9uc2UiKSksdm9pZCBLKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSxWLmdldFN1YnNjcmlwdGlvblJlc3BvbnNlKEcsITEsQXJyYXkuZnJvbShxLnBlbmRpbmcpKSk7b2UoKT8wIT09QXJyYXkuZnJvbShxLnBlbmRpbmcpLmxlbmd0aCYmKGNsZWFySW50ZXJ2YWwoSi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZCksdGUoKS5zZW5kKHZlKEcse3RvcGljczpBcnJheS5mcm9tKHEucGVuZGluZyl9KSksSi5yZXF1ZXN0Q29tcGxldGVkPSExLEoucmVzcG9uc2VDaGVja0ludGVydmFsSWQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtKLnJlcXVlc3RDb21wbGV0ZWR8fCgrK0ouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdCxuKCkpfSwxZTMpKTpDZShlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3MgY2FsbCBzaW5jZSBEZWZhdWx0IFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpKX0sZ2U9ZnVuY3Rpb24obix0KXtZKG4sV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHxZKG4sV2ViU29ja2V0Lk9QRU4pP24uY2xvc2UoMWUzLHQpOkNlKGUud2FybigiSWdub3JpbmcgV2ViU29ja2V0IENsb3NlIHJlcXVlc3QsIFdlYlNvY2tldCBTdGF0ZTogIitaKG4pKSl9LGJlPWZ1bmN0aW9uKGUpe2dlKHQucHJpbWFyeSwiW1ByaW1hcnldIFdlYlNvY2tldCAiK2UpLGdlKHQuc2Vjb25kYXJ5LCJbU2Vjb25kYXJ5XSBXZWJTb2NrZXQgIitlKX0seWU9ZnVuY3Rpb24oKXtyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50Kys7dmFyIG49Vi5hZGRKaXR0ZXIoby5leHBvbmVudGlhbEJhY2tPZmZUaW1lLC4zKTtEYXRlLm5vdygpK248PWEuY29ubkNvbmZpZy51cmxDb25uVmFsaWRUaW1lPyhlLmFkdmFuY2VkTG9nKFMpLENlKGUuZGVidWcoUytuKyIgbXMiKSksby5leHBvbmVudGlhbFRpbWVvdXRIYW5kbGU9c2V0VGltZW91dChmdW5jdGlvbigpe3JldHVybiBrZSgpfSxuKSxvLmV4cG9uZW50aWFsQmFja09mZlRpbWUqPTIpOihlLmFkdmFuY2VkTG9nKGgpLENlKGUud2FybihoKSksaGUoKSl9LG1lPWZ1bmN0aW9uKG4pe2llKCksY2UoKSxlLmFkdmFuY2VkTG9nKGssbiksQ2UoZS5lcnJvcihrKSksby53ZWJzb2NrZXRJbml0RmFpbGVkPSEwLGJlKHcpLGNsZWFySW50ZXJ2YWwoJCksSyhjLmluaXRGYWlsdXJlLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUscmVhc29uOm59KSxhZSgpfSx2ZT1mdW5jdGlvbihlLG4pe3JldHVybiBKU09OLnN0cmluZ2lmeSh7dG9waWM6ZSxjb250ZW50Om59KX0sU2U9ZnVuY3Rpb24obil7cmV0dXJuISEoVi5pc09iamVjdChuKSYmVi5pc09iamVjdChuLndlYlNvY2tldFRyYW5zcG9ydCkmJlYuaXNOb25FbXB0eVN0cmluZyhuLndlYlNvY2tldFRyYW5zcG9ydC51cmwpJiZWLnZhbGlkV1NVcmwobi53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKSYmMWUzKm4ud2ViU29ja2V0VHJhbnNwb3J0LnRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzPj0zZTUpfHwoQ2UoZS5lcnJvcigiSW52YWxpZCBXZWJTb2NrZXQgQ29ubmVjdGlvbiBDb25maWd1cmF0aW9uIixuKSksITEpfSxoZT1mdW5jdGlvbigpe2lmKCFWLmlzTmV0d29ya09ubGluZSgpKXJldHVybiBlLmFkdmFuY2VkTG9nKGYpLHZvaWQgQ2UoZS5pbmZvKGYpKTtpZihvLndlYnNvY2tldEluaXRGYWlsZWQpQ2UoZS5kZWJ1ZygiV2ViU29ja2V0IEluaXQgaGFkIGZhaWxlZCwgaWdub3JpbmcgdGhpcyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QiKSk7ZWxzZXtpZihhLnByb21pc2VDb21wbGV0ZWQpcmV0dXJuIGllKCksZS5hZHZhbmNlZExvZyhDKSxDZShlLmluZm8oQykpLHIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU9ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZXx8RGF0ZS5ub3coKSxhLnByb21pc2VDb21wbGV0ZWQ9ITEsYS5wcm9taXNlSGFuZGxlPWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KCksYS5wcm9taXNlSGFuZGxlLnRoZW4oZnVuY3Rpb24obil7cmV0dXJuIGEucHJvbWlzZUNvbXBsZXRlZD0hMCxlLmFkdmFuY2VkTG9nKEwpLENlKGUuZGVidWcoTCxuKSksU2Uobik/KGEuY29ubkNvbmZpZz1uLGEuY29ubkNvbmZpZy51cmxDb25uVmFsaWRUaW1lPURhdGUubm93KCkrODVlMyxrZSgpKToobWUoIkludmFsaWQgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbjogIituKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH0pfSxmdW5jdGlvbihuKXtyZXR1cm4gYS5wcm9taXNlQ29tcGxldGVkPSEwLGUuYWR2YW5jZWRMb2coVCksQ2UoZS5lcnJvcihULG4pKSxWLmlzTmV0d29ya0ZhaWx1cmUobik/KGUuYWR2YW5jZWRMb2coTytKU09OLnN0cmluZ2lmeShuKSksQ2UoZS5pbmZvKE8rSlNPTi5zdHJpbmdpZnkobikpKSxCLnJldHJ5KCkpOm1lKCJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbjogIitKU09OLnN0cmluZ2lmeShuKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9fSk7Q2UoZS5kZWJ1ZygiVGhlcmUgaXMgYW4gb25nb2luZyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QsIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQiKSl9fSxrZT1mdW5jdGlvbigpe2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClyZXR1cm4gQ2UoZS5pbmZvKCJ3ZWItc29ja2V0IGluaXRpYWxpemluZyBoYWQgZmFpbGVkLCBhYm9ydGluZyByZS1pbml0IikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfTtpZighVi5pc05ldHdvcmtPbmxpbmUoKSlyZXR1cm4gQ2UoZS53YXJuKCJTeXN0ZW0gaXMgb2ZmbGluZSBhYm9ydGluZyB3ZWItc29ja2V0IGluaXQiKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2UuYWR2YW5jZWRMb2coVyksQ2UoZS5pbmZvKFcpKSxRKCJpbml0V2ViU29ja2V0Iik7dHJ5e2lmKFNlKGEuY29ubkNvbmZpZykpe3ZhciBuPW51bGw7cmV0dXJuIGVlKHQucHJpbWFyeSk/KENlKGUuZGVidWcoIlByaW1hcnkgU29ja2V0IGNvbm5lY3Rpb24gaXMgYWxyZWFkeSBvcGVuIikpLFkodC5zZWNvbmRhcnksV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHwoQ2UoZS5kZWJ1ZygiRXN0YWJsaXNoaW5nIGEgc2Vjb25kYXJ5IHdlYi1zb2NrZXQgY29ubmVjdGlvbiIpKSxCLm51bUF0dGVtcHRzPTAsdC5zZWNvbmRhcnk9d2UoKSksbj10LnNlY29uZGFyeSk6KFkodC5wcmltYXJ5LFdlYlNvY2tldC5DT05ORUNUSU5HKXx8KENlKGUuZGVidWcoIkVzdGFibGlzaGluZyBhIHByaW1hcnkgd2ViLXNvY2tldCBjb25uZWN0aW9uIikpLHQucHJpbWFyeT13ZSgpKSxuPXQucHJpbWFyeSksby53ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZD1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7ZWUobil8fHllKCl9LDFlMykse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITF9fX1jYXRjaChuKXtyZXR1cm4gQ2UoZS5lcnJvcigiRXJyb3IgSW5pdGlhbGl6aW5nIHdlYi1zb2NrZXQtbWFuYWdlciIsbikpLG1lKCJGYWlsZWQgdG8gaW5pdGlhbGl6ZSBuZXcgV2ViU29ja2V0OiAiK24ubWVzc2FnZSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9fX0sd2U9ZnVuY3Rpb24oKXt2YXIgbj1uZXcgV2ViU29ja2V0KGEuY29ubkNvbmZpZy53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKTtyZXR1cm4gbi5hZGRFdmVudExpc3RlbmVyKCJvcGVuIix1ZSksbi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIixkZSksbi5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsZmUpLG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xvc2UiLGZ1bmN0aW9uKGkpe3JldHVybiBmdW5jdGlvbihuLGkpe2UuYWR2YW5jZWRMb2cobSxKU09OLnN0cmluZ2lmeShuKSksQ2UoZS5pbmZvKG0sSlNPTi5zdHJpbmdpZnkobikpKSxRKCJ3ZWJTb2NrZXRPbkNsb3NlIGJlZm9yZS1jbGVhbnVwIiksSyhjLmNvbm5lY3Rpb25DbG9zZSx7b3BlblRpbWVzdGFtcDppLm9wZW5UaW1lc3RhbXAsY2xvc2VUaW1lc3RhbXA6RGF0ZS5ub3coKSxjb25uZWN0aW9uRHVyYXRpb246RGF0ZS5ub3coKS1pLm9wZW5UaW1lc3RhbXAsY29kZTpuLmNvZGUscmVhc29uOm4ucmVhc29ufSksbmUodC5wcmltYXJ5KSYmKHQucHJpbWFyeT1udWxsKSxuZSh0LnNlY29uZGFyeSkmJih0LnNlY29uZGFyeT1udWxsKSxvLnJlY29ubmVjdFdlYlNvY2tldCYmKGVlKHQucHJpbWFyeSl8fGVlKHQuc2Vjb25kYXJ5KT9uZSh0LnByaW1hcnkpJiZlZSh0LnNlY29uZGFyeSkmJihDZShlLmluZm8oIltQcmltYXJ5XSBXZWJTb2NrZXQgQ2xlYW5seSBDbG9zZWQiKSksdC5wcmltYXJ5PXQuc2Vjb25kYXJ5LHQuc2Vjb25kYXJ5PW51bGwpOihDZShlLndhcm4oIk5laXRoZXIgcHJpbWFyeSB3ZWJzb2NrZXQgYW5kIG5vciBzZWNvbmRhcnkgd2Vic29ja2V0IGhhdmUgb3BlbiBjb25uZWN0aW9ucywgYXR0ZW1wdGluZyB0byByZS1lc3RhYmxpc2ggY29ubmVjdGlvbiIpKSxvLmNvbm5TdGF0ZT09PVU/Q2UoZS5pbmZvKCJJZ25vcmluZyBjb25uZWN0aW9uTG9zdCBjYWxsYmFjayBpbnZvY2F0aW9uIikpOihLKGMuY29ubmVjdGlvbkxvc3Qse29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLHIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA9RGF0ZS5ub3coKSksby5jb25uU3RhdGU9VSxoZSgpKSxRKCJ3ZWJTb2NrZXRPbkNsb3NlIGFmdGVyLWNsZWFudXAiKSl9KGksbil9KSxufSxDZT1mdW5jdGlvbihlKXtyZXR1cm4gZSYmImZ1bmN0aW9uIj09dHlwZW9mIGUuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXImJmUuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKSxlfTt0aGlzLmluaXQ9ZnVuY3Rpb24obil7aWYoVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwidHJhbnNwb3J0SGFuZGxlIG11c3QgYmUgYSBmdW5jdGlvbiIpLG51bGw9PT1jLmdldFdlYlNvY2tldFRyYW5zcG9ydClyZXR1cm4gYy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQ9bixoZSgpO0NlKGUud2FybigiV2ViIFNvY2tldCBNYW5hZ2VyIHdhcyBhbHJlYWR5IGluaXRpYWxpemVkIikpfSx0aGlzLm9uSW5pdEZhaWx1cmU9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coSSksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5pbml0RmFpbHVyZS5hZGQobiksby53ZWJzb2NrZXRJbml0RmFpbGVkJiZuKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5pbml0RmFpbHVyZS5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbk9wZW49ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coTiksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uT3Blbi5hZGQobiksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uT3Blbi5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbkNsb3NlPWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKF8pLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkNsb3NlLmFkZChuKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbkdhaW49ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coRSksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uR2Fpbi5hZGQobiksb2UoKSYmbigpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkdhaW4uZGVsZXRlKG4pfX0sdGhpcy5vbkNvbm5lY3Rpb25Mb3N0PWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKEYpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkxvc3QuYWRkKG4pLG8uY29ublN0YXRlPT09VSYmbigpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkxvc3QuZGVsZXRlKG4pfX0sdGhpcy5vblN1YnNjcmlwdGlvblVwZGF0ZT1mdW5jdGlvbihlKXtyZXR1cm4gVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25VcGRhdGUuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuc3Vic2NyaXB0aW9uVXBkYXRlLmRlbGV0ZShlKX19LHRoaXMub25TdWJzY3JpcHRpb25GYWlsdXJlPWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKEEpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuc3Vic2NyaXB0aW9uRmFpbHVyZS5hZGQobiksZnVuY3Rpb24oKXtyZXR1cm4gYy5zdWJzY3JpcHRpb25GYWlsdXJlLmRlbGV0ZShuKX19LHRoaXMub25NZXNzYWdlPWZ1bmN0aW9uKGUsbil7cmV0dXJuIFYuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY05hbWUiKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnRvcGljLmhhcyhlKT9jLnRvcGljLmdldChlKS5hZGQobik6Yy50b3BpYy5zZXQoZSxuZXcgU2V0KFtuXSkpLGZ1bmN0aW9uKCl7cmV0dXJuIGMudG9waWMuZ2V0KGUpLmRlbGV0ZShuKX19LHRoaXMub25BbGxNZXNzYWdlPWZ1bmN0aW9uKGUpe3JldHVybiBWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmFsbE1lc3NhZ2UuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuYWxsTWVzc2FnZS5kZWxldGUoZSl9fSx0aGlzLnN1YnNjcmliZVRvcGljcz1mdW5jdGlvbihlKXtWLmFzc2VydE5vdE51bGwoZSwidG9waWNzIiksVi5hc3NlcnRJc0xpc3QoZSksZS5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Euc3Vic2NyaWJlZC5oYXMoZSl8fHEucGVuZGluZy5hZGQoZSl9KSxKLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCxwZSgpfSx0aGlzLnNlbmRNZXNzYWdlPWZ1bmN0aW9uKG4pe2lmKFYuYXNzZXJ0SXNPYmplY3QobiwicGF5bG9hZCIpLHZvaWQgMD09PW4udG9waWN8fFguaGFzKG4udG9waWMpKUNlKGUud2FybigiQ2Fubm90IHNlbmQgbWVzc2FnZSwgSW52YWxpZCB0b3BpYyIsbikpO2Vsc2V7dHJ5e249SlNPTi5zdHJpbmdpZnkobil9Y2F0Y2godCl7cmV0dXJuIHZvaWQgQ2UoZS53YXJuKCJFcnJvciBzdHJpbmdpZnkgbWVzc2FnZSIsbikpfW9lKCk/dGUoKS5zZW5kKG4pOkNlKGUud2FybigiQ2Fubm90IHNlbmQgbWVzc2FnZSwgd2ViIHNvY2tldCBjb25uZWN0aW9uIGlzIG5vdCBvcGVuIikpfX0sdGhpcy5jbG9zZVdlYlNvY2tldD1mdW5jdGlvbigpe2llKCksY2UoKSxvLnJlY29ubmVjdFdlYlNvY2tldD0hMSxjbGVhckludGVydmFsKCQpLGJlKCJVc2VyIHJlcXVlc3QgdG8gY2xvc2UgV2ViU29ja2V0Iil9LHRoaXMudGVybWluYXRlV2ViU29ja2V0TWFuYWdlcj1tZX0sZGU9e2NyZWF0ZTpmdW5jdGlvbigpe3JldHVybiBuZXcgZmV9LHNldEdsb2JhbENvbmZpZzpmdW5jdGlvbihlKXt2YXIgbj1lJiZlLmxvZ2dlckNvbmZpZztzZS51cGRhdGVMb2dnZXJDb25maWcobil9LExvZ0xldmVsOm9lLExvZ2dlcjpuZX19LGZ1bmN0aW9uKGUsbix0KXt2YXIgbzshZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7dmFyIHI9e25vdF9zdHJpbmc6L1tec10vLG5vdF9ib29sOi9bXnRdLyxub3RfdHlwZTovW15UXS8sbm90X3ByaW1pdGl2ZTovW152XS8sbnVtYmVyOi9bZGllZmddLyxudW1lcmljX2FyZzovW2JjZGllZmd1eFhdLyxqc29uOi9bal0vLG5vdF9qc29uOi9bXmpdLyx0ZXh0Oi9eW15ceDI1XSsvLG1vZHVsbzovXlx4MjV7Mn0vLHBsYWNlaG9sZGVyOi9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXildKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1naWpvc3RUdXZ4WF0pLyxrZXk6L14oW2Etel9dW2Etel9cZF0qKS9pLGtleV9hY2Nlc3M6L15cLihbYS16X11bYS16X1xkXSopL2ksaW5kZXhfYWNjZXNzOi9eXFsoXGQrKVxdLyxzaWduOi9eWystXS99O2Z1bmN0aW9uIGkoZSl7cmV0dXJuIGZ1bmN0aW9uKGUsbil7dmFyIHQsbyxjLGEscyx1LGwsZixkLHA9MSxnPWUubGVuZ3RoLGI9IiI7Zm9yKG89MDtvPGc7bysrKWlmKCJzdHJpbmciPT10eXBlb2YgZVtvXSliKz1lW29dO2Vsc2UgaWYoIm9iamVjdCI9PXR5cGVvZiBlW29dKXtpZigoYT1lW29dKS5rZXlzKWZvcih0PW5bcF0sYz0wO2M8YS5rZXlzLmxlbmd0aDtjKyspe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKGkoJ1tzcHJpbnRmXSBDYW5ub3QgYWNjZXNzIHByb3BlcnR5ICIlcyIgb2YgdW5kZWZpbmVkIHZhbHVlICIlcyInLGEua2V5c1tjXSxhLmtleXNbYy0xXSkpO3Q9dFthLmtleXNbY11dfWVsc2UgdD1hLnBhcmFtX25vP25bYS5wYXJhbV9ub106bltwKytdO2lmKHIubm90X3R5cGUudGVzdChhLnR5cGUpJiZyLm5vdF9wcmltaXRpdmUudGVzdChhLnR5cGUpJiZ0IGluc3RhbmNlb2YgRnVuY3Rpb24mJih0PXQoKSksci5udW1lcmljX2FyZy50ZXN0KGEudHlwZSkmJiJudW1iZXIiIT10eXBlb2YgdCYmaXNOYU4odCkpdGhyb3cgbmV3IFR5cGVFcnJvcihpKCJbc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJVQiLHQpKTtzd2l0Y2goci5udW1iZXIudGVzdChhLnR5cGUpJiYoZj10Pj0wKSxhLnR5cGUpe2Nhc2UiYiI6dD1wYXJzZUludCh0LDEwKS50b1N0cmluZygyKTticmVhaztjYXNlImMiOnQ9U3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludCh0LDEwKSk7YnJlYWs7Y2FzZSJkIjpjYXNlImkiOnQ9cGFyc2VJbnQodCwxMCk7YnJlYWs7Y2FzZSJqIjp0PUpTT04uc3RyaW5naWZ5KHQsbnVsbCxhLndpZHRoP3BhcnNlSW50KGEud2lkdGgpOjApO2JyZWFrO2Nhc2UiZSI6dD1hLnByZWNpc2lvbj9wYXJzZUZsb2F0KHQpLnRvRXhwb25lbnRpYWwoYS5wcmVjaXNpb24pOnBhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbCgpO2JyZWFrO2Nhc2UiZiI6dD1hLnByZWNpc2lvbj9wYXJzZUZsb2F0KHQpLnRvRml4ZWQoYS5wcmVjaXNpb24pOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJnIjp0PWEucHJlY2lzaW9uP1N0cmluZyhOdW1iZXIodC50b1ByZWNpc2lvbihhLnByZWNpc2lvbikpKTpwYXJzZUZsb2F0KHQpO2JyZWFrO2Nhc2UibyI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZyg4KTticmVhaztjYXNlInMiOnQ9U3RyaW5nKHQpLHQ9YS5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxhLnByZWNpc2lvbik6dDticmVhaztjYXNlInQiOnQ9U3RyaW5nKCEhdCksdD1hLnByZWNpc2lvbj90LnN1YnN0cmluZygwLGEucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UiVCI6dD1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodCkuc2xpY2UoOCwtMSkudG9Mb3dlckNhc2UoKSx0PWEucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAsYS5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ1Ijp0PXBhcnNlSW50KHQsMTApPj4+MDticmVhaztjYXNlInYiOnQ9dC52YWx1ZU9mKCksdD1hLnByZWNpc2lvbj90LnN1YnN0cmluZygwLGEucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UieCI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZygxNik7YnJlYWs7Y2FzZSJYIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpfXIuanNvbi50ZXN0KGEudHlwZSk/Yis9dDooIXIubnVtYmVyLnRlc3QoYS50eXBlKXx8ZiYmIWEuc2lnbj9kPSIiOihkPWY/IisiOiItIix0PXQudG9TdHJpbmcoKS5yZXBsYWNlKHIuc2lnbiwiIikpLHU9YS5wYWRfY2hhcj8iMCI9PT1hLnBhZF9jaGFyPyIwIjphLnBhZF9jaGFyLmNoYXJBdCgxKToiICIsbD1hLndpZHRoLShkK3QpLmxlbmd0aCxzPWEud2lkdGgmJmw+MD91LnJlcGVhdChsKToiIixiKz1hLmFsaWduP2QrdCtzOiIwIj09PXU/ZCtzK3Q6cytkK3QpfXJldHVybiBifShmdW5jdGlvbihlKXtpZihhW2VdKXJldHVybiBhW2VdO3ZhciBuLHQ9ZSxvPVtdLGk9MDtmb3IoO3Q7KXtpZihudWxsIT09KG49ci50ZXh0LmV4ZWModCkpKW8ucHVzaChuWzBdKTtlbHNlIGlmKG51bGwhPT0obj1yLm1vZHVsby5leGVjKHQpKSlvLnB1c2goIiUiKTtlbHNle2lmKG51bGw9PT0obj1yLnBsYWNlaG9sZGVyLmV4ZWModCkpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIHVuZXhwZWN0ZWQgcGxhY2Vob2xkZXIiKTtpZihuWzJdKXtpfD0xO3ZhciBjPVtdLHM9blsyXSx1PVtdO2lmKG51bGw9PT0odT1yLmtleS5leGVjKHMpKSl0aHJvdyBuZXcgU3ludGF4RXJyb3IoIltzcHJpbnRmXSBmYWlsZWQgdG8gcGFyc2UgbmFtZWQgYXJndW1lbnQga2V5Iik7Zm9yKGMucHVzaCh1WzFdKTsiIiE9PShzPXMuc3Vic3RyaW5nKHVbMF0ubGVuZ3RoKSk7KWlmKG51bGwhPT0odT1yLmtleV9hY2Nlc3MuZXhlYyhzKSkpYy5wdXNoKHVbMV0pO2Vsc2V7aWYobnVsbD09PSh1PXIuaW5kZXhfYWNjZXNzLmV4ZWMocykpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtjLnB1c2godVsxXSl9blsyXT1jfWVsc2UgaXw9MjtpZigzPT09aSl0aHJvdyBuZXcgRXJyb3IoIltzcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQiKTtvLnB1c2goe3BsYWNlaG9sZGVyOm5bMF0scGFyYW1fbm86blsxXSxrZXlzOm5bMl0sc2lnbjpuWzNdLHBhZF9jaGFyOm5bNF0sYWxpZ246bls1XSx3aWR0aDpuWzZdLHByZWNpc2lvbjpuWzddLHR5cGU6bls4XX0pfXQ9dC5zdWJzdHJpbmcoblswXS5sZW5ndGgpfXJldHVybiBhW2VdPW99KGUpLGFyZ3VtZW50cyl9ZnVuY3Rpb24gYyhlLG4pe3JldHVybiBpLmFwcGx5KG51bGwsW2VdLmNvbmNhdChufHxbXSkpfXZhciBhPU9iamVjdC5jcmVhdGUobnVsbCk7bi5zcHJpbnRmPWksbi52c3ByaW50Zj1jLCJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93JiYod2luZG93LnNwcmludGY9aSx3aW5kb3cudnNwcmludGY9Yyx2b2lkIDA9PT0obz1mdW5jdGlvbigpe3JldHVybntzcHJpbnRmOmksdnNwcmludGY6Y319LmNhbGwobix0LG4sZSkpfHwoZS5leHBvcnRzPW8pKX0oKX0sZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt0LnIobiksZnVuY3Rpb24oZSl7dC5kKG4sIldlYlNvY2tldE1hbmFnZXIiLGZ1bmN0aW9uKCl7cmV0dXJuIHJ9KTt2YXIgbz10KDApO2UuY29ubmVjdD1lLmNvbm5lY3R8fHt9LGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlcj1vLmE7dmFyIHI9by5hfS5jYWxsKHRoaXMsdCgzKSl9LGZ1bmN0aW9uKGUsbil7dmFyIHQ7dD1mdW5jdGlvbigpe3JldHVybiB0aGlzfSgpO3RyeXt0PXR8fG5ldyBGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpfWNhdGNoKGUpeyJvYmplY3QiPT10eXBlb2Ygd2luZG93JiYodD13aW5kb3cpfWUuZXhwb3J0cz10fV0pOwovLyMgc291cmNlTWFwcGluZ1VSTD1hbWF6b24tY29ubmVjdC13ZWJzb2NrZXQtbWFuYWdlci5qcy5tYXAKCgovKioqLyB9KSwKCi8qKiovIDE1MToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIC8vIEhvdyBmcmVxdWVudGx5IHNvZnRwaG9uZSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIHJlcG9ydGVkIHRvIHNoYXJlZCB3b3JrZXIuCiAgdmFyIFNPRlRQSE9ORV9MT0dfUkVQT1JUX0lOVEVSVkFMX01JTExJUyA9IDUwMDA7CgogIC8vIEhvdyBmcmVxdWVudGx5IGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgc2VudCBkb3duc3RyZWFtCiAgdmFyIExPR1NfUkVQT1JUX0lOVEVSVkFMX01JTExJUyA9IDUwMDA7CgogIC8vIFRoZSBkZWZhdWx0IGxvZyByb2xsIGludGVydmFsICgzMG1pbikKICB2YXIgREVGQVVMVF9MT0dfUk9MTF9JTlRFUlZBTCA9IDE4MDAwMDA7CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIGNvbW1vbiBsb2dnaW5nIGxldmVscy4KICAgKi8KICB2YXIgTG9nTGV2ZWwgPSB7CiAgICBURVNUOiAiVEVTVCIsCiAgICBUUkFDRTogIlRSQUNFIiwKICAgIERFQlVHOiAiREVCVUciLAogICAgSU5GTzogIklORk8iLAogICAgTE9HOiAiTE9HIiwKICAgIFdBUk46ICJXQVJOIiwKICAgIEVSUk9SOiAiRVJST1IiLAogICAgQ1JJVElDQUw6ICJDUklUSUNBTCIKICB9OwoKICAvKioKICAgKiBBbiBlbnVtZXJhdGlvbiBvZiBjb21tb24gbG9nZ2luZyBjb21wb25lbnRzLgogICAqLwogIHZhciBMb2dDb21wb25lbnQgPSB7CiAgICBDQ1A6ICJjY3AiLAogICAgU09GVFBIT05FOiAic29mdHBob25lIiwKICAgIENIQVQ6ICJjaGF0IiwKICAgIFRBU0s6ICJ0YXNrIgogIH07CgogIC8qKgogICAqIFRoZSBudW1lcmljIG9yZGVyIG9mIHRoZSBsb2dnaW5nIGxldmVscyBhYm92ZS4KICAgKiBUaGV5IGFyZSBzcGFjZWQgdG8gYWxsb3cgdGhlIGFkZGl0aW9uIG9mIG90aGVyIGxvZwogICAqIGxldmVscyBhdCBhIGxhdGVyIHRpbWUuCiAgICovCiAgdmFyIExvZ0xldmVsT3JkZXIgPSB7CiAgICBURVNUOiAwLAogICAgVFJBQ0U6IDEwLAogICAgREVCVUc6IDIwLAogICAgSU5GTzogMzAsCiAgICBMT0c6IDQwLAogICAgV0FSTjogNTAsCiAgICBFUlJPUjogMTAwLAogICAgQ1JJVElDQUw6IDIwMAoKICB9OwoKICAvKioKICAgKiBBIG1hcCBmcm9tIGxvZyBsZXZlbCB0byBjb25zb2xlIGxvZ2dlciBmdW5jdGlvbi4KICAgKi8KICB2YXIgQ09OU09MRV9MT0dHRVJfTUFQID0gewogICAgVFJBQ0U6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIERFQlVHOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmluZm8odGV4dCk7IH0sCiAgICBJTkZPOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmluZm8odGV4dCk7IH0sCiAgICBMT0c6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUubG9nKHRleHQpOyB9LAogICAgVEVTVDogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5sb2codGV4dCk7IH0sCiAgICBXQVJOOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLndhcm4odGV4dCk7IH0sCiAgICBFUlJPUjogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5lcnJvcih0ZXh0KTsgfSwKICAgIENSSVRJQ0FMOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmVycm9yKHRleHQpOyB9CiAgfTsKCiAgLyoqCiAgKiBDaGVja3MgaWYgaXQgaXMgYSB2YWxpZCBsb2cgY29tcG9uZW50IGVudW0KICAqLwoKICB2YXIgaXNWYWxpZExvZ0NvbXBvbmVudCA9IGZ1bmN0aW9uIChjb21wb25lbnQpIHsKICAgIHJldHVybiBPYmplY3QudmFsdWVzKExvZ0NvbXBvbmVudCkuaW5kZXhPZihjb21wb25lbnQpICE9PSAtMTsKICB9OwoKICAvKioKICAqIEV4dHJhY3QgdGhlIGN1c3RvbSBhcmd1bWVudHMgYXMgcmVxdWlyZWQgYnkgdGhlIGxvZ2dlcgogICovCiAgdmFyIGV4dHJhY3RMb2dnZXJBcmdzID0gZnVuY3Rpb24gKGxvZ2dlckFyZ3MpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobG9nZ2VyQXJncywgMCk7CiAgICB2YXIgZmlyc3RBcmcgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgZm9ybWF0OwogICAgdmFyIGNvbXBvbmVudDsKCiAgICBpZiAoaXNWYWxpZExvZ0NvbXBvbmVudChmaXJzdEFyZykpIHsKICAgICAgY29tcG9uZW50ID0gZmlyc3RBcmc7CiAgICAgIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vZGVmYXVsdCB0byBDQ1AgY29tcG9uZW50CiAgICAgIGZvcm1hdCA9IGZpcnN0QXJnOwogICAgICBjb21wb25lbnQgPSBMb2dDb21wb25lbnQuQ0NQOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGZvcm1hdDogZm9ybWF0LAogICAgICBjb21wb25lbnQ6IGNvbXBvbmVudCwKICAgICAgYXJnczogYXJncwogICAgfTsKICB9OwoKICAvKioKICAgKiBBIGxvZyBlbnRyeS4KICAgKgogICAqIEBwYXJhbSBjb21wb25lbnQgVGhlIGxvZ2dpbmcgY29tcG9uZW50LgogICAqIEBwYXJhbSBsZXZlbCBUaGUgbG9nIGxldmVsIG9mIHRoaXMgbG9nIGVudHJ5LgogICAqIEBwYXJhbSB0ZXh0IFRoZSB0ZXh0IGNvbnRhaW5lZCBpbiB0aGUgbG9nIGVudHJ5LgogICAqIEBwYXJhbSBsb2dnZXJJZCBUaGUgcm9vdCBsb2dnZXIgaWQuCiAgICoKICAgKiBMb2cgZW50cmllcyBhcmUgYXdhcmUgb2YgdGhlaXIgdGltZXN0YW1wLCBvcmRlciwKICAgKiBhbmQgY2FuIGNvbnRhaW4gb2JqZWN0cyBhbmQgZXhjZXB0aW9uIHN0YWNrIHRyYWNlcy4KICAgKi8KICB2YXIgTG9nRW50cnkgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBsZXZlbCwgdGV4dCwgbG9nZ2VySWQpIHsKICAgIHRoaXMuY29tcG9uZW50ID0gY29tcG9uZW50OwogICAgdGhpcy5sZXZlbCA9IGxldmVsOwogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIHRoaXMudGltZSA9IG5ldyBEYXRlKCk7CiAgICB0aGlzLmV4Y2VwdGlvbiA9IG51bGw7CiAgICB0aGlzLm9iamVjdHMgPSBbXTsKICAgIHRoaXMubGluZSA9IDA7CiAgICB0aGlzLmFnZW50UmVzb3VyY2VJZCA9IG51bGw7CiAgICB0cnkgewogICAgICBpZiAoY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCl7CiAgICAgICAgdGhpcy5hZ2VudFJlc291cmNlSWQgPSBuZXcgY29ubmVjdC5BZ2VudCgpLl9nZXRSZXNvdXJjZUlkKCk7CiAgICAgIH0KICAgIH0gY2F0Y2goZSkgewogICAgICBjb25zb2xlLmxvZygiSXNzdWUgZmluZGluZyBhZ2VudFJlc291cmNlSWQ6ICIsIGUpOyAvL2Nhbid0IHVzZSBvdXIgbG9nZ2VyIGhlcmUgYXMgd2UgbWlnaHQgaW5maW5pdGVseSBhdHRlbXB0IHRvIGxvZyB0aGlzIGVycm9yLgogICAgfQogICAgdGhpcy5sb2dnZXJJZCA9IGxvZ2dlcklkOwogIH07CgogIExvZ0VudHJ5LmZyb21PYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgZW50cnkgPSBuZXcgTG9nRW50cnkoTG9nQ29tcG9uZW50LkNDUCwgb2JqLmxldmVsLCBvYmoudGV4dCwgb2JqLmxvZ2dlcklkKTsKCiAgICAvLyBSZXF1aXJlZCB0byBjaGVjayBmb3IgRGF0ZSBvYmplY3RzIHNlbnQgYWNyb3NzIGZyYW1lIGJvdW5kYXJpZXMKICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqLnRpbWUpID09PSAnW29iamVjdCBEYXRlXScpIHsKICAgICAgZW50cnkudGltZSA9IG5ldyBEYXRlKG9iai50aW1lLmdldFRpbWUoKSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmoudGltZSA9PT0gJ251bWJlcicpIHsKICAgICAgZW50cnkudGltZSA9IG5ldyBEYXRlKG9iai50aW1lKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai50aW1lID09PSAnc3RyaW5nJykgewogICAgICBlbnRyeS50aW1lID0gRGF0ZS5wYXJzZShvYmoudGltZSk7CiAgICB9IGVsc2UgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUoKTsKICAgIH0KICAgIGVudHJ5LmV4Y2VwdGlvbiA9IG9iai5leGNlcHRpb247CiAgICBlbnRyeS5vYmplY3RzID0gb2JqLm9iamVjdHM7CiAgICByZXR1cm4gZW50cnk7CiAgfTsKCiAgLyoqCiAgICogUHJpdmF0ZSBtZXRob2QgdG8gcmVtb3ZlIHNlbnNpdGl2ZSBpbmZvIGZyb20gY2xpZW50IGxvZwogICAqLwogIHZhciByZWRhY3RTZW5zaXRpdmVJbmZvID0gZnVuY3Rpb24oZGF0YSkgewogICAgdmFyIHJlZ2V4ID0gL0F1dGhUb2tlbi4qXD0vZzsKICAgIGlmKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7CiAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhW2tleV0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGRhdGFba2V5XSkKICAgICAgICB9IGVsc2UgaWYodHlwZW9mIGRhdGFba2V5XSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmIChrZXkgPT09ICJ1cmwiIHx8IGtleSA9PT0gInRleHQiKSB7CiAgICAgICAgICAgIGRhdGFba2V5XSA9IGRhdGFba2V5XS5yZXBsYWNlKHJlZ2V4LCAiW3JlZGFjdGVkXSIpOwogICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICJxdWlja0Nvbm5lY3ROYW1lIikgewogICAgICAgICAgICBkYXRhW2tleV0gPSAiW3JlZGFjdGVkXSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsgCiAgICB9CiAgfQoKICAvKioKICAgKiBQdWxscyB0aGUgdHlwZSwgbWVzc2FnZSwgYW5kIHN0YWNrIHRyYWNlCiAgICogb3V0IG9mIHRoZSBnaXZlbiBleGNlcHRpb24gZm9yIEpTT04gc2VyaWFsaXphdGlvbi4KICAgKi8KICB2YXIgTG9nZ2VkRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMudHlwZSA9IChlIGluc3RhbmNlb2YgRXJyb3IpID8gZS5uYW1lIDogZS5jb2RlIHx8IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlKTsKICAgIHRoaXMubWVzc2FnZSA9IGUubWVzc2FnZTsKICAgIHRoaXMuc3RhY2sgPSBbXTsKICAgIGlmIChlLnN0YWNrKXsKICAgICAgdHJ5IHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGUuc3RhY2spKSB7CiAgICAgICAgICAgICAgdGhpcy5zdGFjayA9IGUuc3RhY2s7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlLnN0YWNrID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBbSlNPTi5zdHJpbmdpZnkoZS5zdGFjayldOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZS5zdGFjayA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gZS5zdGFjay5zcGxpdCgnXG4nKTsKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCB7fQogICAgfQogIH07CgogIC8qKgogICAqIE1pbmltYWxseSBzdHJpbmdpZnkgdGhpcyBsb2cgZW50cnkgZm9yIHByaW50aW5nCiAgICogdG8gdGhlIGNvbnNvbGUuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiWyVzXSBbJXNdIFslc106ICVzIiwKICAgICAgdGhpcy5nZXRUaW1lKCkgJiYgdGhpcy5nZXRUaW1lKCkudG9JU09TdHJpbmcgPyB0aGlzLmdldFRpbWUoKS50b0lTT1N0cmluZygpIDogIj8/PyIsCiAgICAgIHRoaXMuZ2V0TGV2ZWwoKSwKICAgICAgdGhpcy5nZXRBZ2VudFJlc291cmNlSWQoKSwKICAgICAgdGhpcy5nZXRUZXh0KCkpOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRpbWVzdGFtcC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0VGltZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnRpbWU7CiAgfTsKCiAgTG9nRW50cnkucHJvdG90eXBlLmdldEFnZW50UmVzb3VyY2VJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmFnZW50UmVzb3VyY2VJZDsKICB9CgogIC8qKgogICAqIEdldCB0aGUgbGV2ZWwgb2YgdGhlIGxvZyBlbnRyeS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0TGV2ZWwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5sZXZlbDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSB0ZXh0LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRUZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudGV4dDsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSBjb21wb25lbnQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldENvbXBvbmVudCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbXBvbmVudDsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gZXhjZXB0aW9uIHN0YWNrIHRyYWNlIHRvIHRoaXMgbG9nIGVudHJ5LgogICAqIEEgbG9nIGVudHJ5IG1heSBjb250YWluIG9ubHkgb25lIGV4Y2VwdGlvbiBzdGFjayB0cmFjZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aEV4Y2VwdGlvbiA9IGZ1bmN0aW9uIChlKSB7CiAgICB0aGlzLmV4Y2VwdGlvbiA9IG5ldyBMb2dnZWRFeGNlcHRpb24oZSk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBBZGQgYW4gYXJiaXRyYXJ5IG9iamVjdCB0byB0aGUgbG9nIGVudHJ5LiAgQSBsb2cgZW50cnkKICAgKiBtYXkgY29udGFpbiBhbnkgbnVtYmVyIG9mIG9iamVjdHMuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLndpdGhPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgY29waWVkT2JqID0gY29ubmVjdC5kZWVwY29weShvYmopOwogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhjb3BpZWRPYmopOwogICAgdGhpcy5vYmplY3RzLnB1c2goY29waWVkT2JqKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEFkZCBhIGNyb3NzIG9yaWdpbiBldmVudCBvYmplY3QgdG8gdGhlIGxvZyBlbnRyeS4gIEEgbG9nIGVudHJ5CiAgICogbWF5IGNvbnRhaW4gYW55IG51bWJlciBvZiBvYmplY3RzLgogICAqLwogICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aENyb3NzT3JpZ2luRXZlbnRPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgY29waWVkT2JqID0gY29ubmVjdC5kZWVwY29weUNyb3NzT3JpZ2luRXZlbnQob2JqKTsKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oY29waWVkT2JqKTsKICAgIHRoaXMub2JqZWN0cy5wdXNoKGNvcGllZE9iaik7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBJbmRpY2F0ZSB0aGF0IHRoaXMgbG9nIGVudHJ5IHNob3VsZCBiZSBzZW50IHRvIHRoZSBzZXJ2ZXIKICAgKiBOT1RFOiBUaGlzIHNob3VsZCBiZSB1c2VkIGZvciBpbnRlcm5hbCBsb2dzIG9ubHkKICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmdldExvZygpLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5wdXNoKHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogVGhlIGxvZ2dlciBpbnN0YW5jZS4KICAgKi8KICB2YXIgTG9nZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fbG9ncyA9IFtdOwogICAgdGhpcy5fcm9sbGVkTG9ncyA9IFtdOwogICAgdGhpcy5fbG9nc1RvUHVzaCA9IFtdOwogICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICAgIHRoaXMuX2VjaG9MZXZlbCA9IExvZ0xldmVsT3JkZXIuSU5GTzsKICAgIHRoaXMuX2xvZ0xldmVsID0gTG9nTGV2ZWxPcmRlci5JTkZPOwogICAgdGhpcy5fbGluZUNvdW50ID0gMDsKICAgIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCA9IDA7CiAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBudWxsOwogICAgdGhpcy5fbG9nZ2VySWQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSArICItIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgdGhpcy5zZXRMb2dSb2xsSW50ZXJ2YWwoREVGQVVMVF9MT0dfUk9MTF9JTlRFUlZBTCk7CiAgICB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoID0gMDsKICB9OwoKICAvKioKICAgKiBTZXRzIHRoZSBpbnRlcnZhbCBpbiBtaWxsaXNlY29uZHMgdGhhdCB0aGUgbG9ncyB3aWxsIGJlIHJvdGF0ZWQuCiAgICogTG9ncyBhcmUgcm90YXRlZCBvdXQgY29tcGxldGVseSBhdCB0aGUgZW5kIG9mIHRoZSBzZWNvbmQgcm9sbAogICAqIGFuZCB3aWxsIGV2ZW50dWFsbHkgYmUgZ2FyYmFnZSBjb2xsZWN0ZWQuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRMb2dSb2xsSW50ZXJ2YWwgPSBmdW5jdGlvbiAoaW50ZXJ2YWwpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBpZiAoISh0aGlzLl9sb2dSb2xsVGltZXIpIHx8IGludGVydmFsICE9PSB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpIHsKICAgICAgaWYgKHRoaXMuX2xvZ1JvbGxUaW1lcikgewogICAgICAgIGdsb2JhbC5jbGVhckludGVydmFsKHRoaXMuX2xvZ1JvbGxUaW1lcik7CiAgICAgIH0KICAgICAgdGhpcy5fbG9nUm9sbEludGVydmFsID0gaW50ZXJ2YWw7CiAgICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IGdsb2JhbC5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fcm9sbGVkTG9ncyA9IHRoaXMuX2xvZ3M7CiAgICAgICAgdGhpcy5fbG9ncyA9IFtdOwogICAgICAgIHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2ggPSAwOwogICAgICAgIHNlbGYuaW5mbygiTG9nIHJvbGwgaW50ZXJ2YWwgb2NjdXJyZWQuIik7CiAgICAgIH0sIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLndhcm4oIkxvZ2dlciBpcyBhbHJlYWR5IHNldCB0byB0aGUgZ2l2ZW4gaW50ZXJ2YWw6ICVkIiwgdGhpcy5fbG9nUm9sbEludGVydmFsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTZXQgdGhlIGxvZyBsZXZlbC4gIFRoaXMgaXMgdGhlIG1pbmltdW0gbGV2ZWwgYXQgd2hpY2ggbG9ncyB3aWxsCiAgICogYmUga2VwdCBmb3IgbGF0ZXIgYXJjaGl2aW5nLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0TG9nTGV2ZWwgPSBmdW5jdGlvbiAobGV2ZWwpIHsKICAgIGlmIChsZXZlbCBpbiBMb2dMZXZlbE9yZGVyKSB7CiAgICAgIHRoaXMuX2xvZ0xldmVsID0gTG9nTGV2ZWxPcmRlcltsZXZlbF07CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbG9nZ2luZyBsZXZlbDogIiArIGxldmVsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTZXQgdGhlIGVjaG8gbGV2ZWwuICBUaGlzIGlzIHRoZSBtaW5pbXVtIGxldmVsIGF0IHdoaWNoIGxvZ3Mgd2lsbAogICAqIGJlIHByaW50ZWQgdG8gdGhlIGphdmFzY3JpcHQgY29uc29sZS4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldEVjaG9MZXZlbCA9IGZ1bmN0aW9uIChsZXZlbCkgewogICAgaWYgKGxldmVsIGluIExvZ0xldmVsT3JkZXIpIHsKICAgICAgdGhpcy5fZWNob0xldmVsID0gTG9nTGV2ZWxPcmRlcltsZXZlbF07CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbG9nZ2luZyBsZXZlbDogIiArIGxldmVsKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBXcml0ZSBhIHBhcnRpY3VsYXIgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2dnaW5nIGxldmVsIG9mIHRoZSBlbnRyeS4KICAgKiBAcGFyYW0gdGV4dCBUaGUgdGV4dCBjb250ZW50cyBvZiB0aGUgZW50cnkuCiAgICoKICAgKiBAcmV0dXJucyBUaGUgbmV3IGxvZyBlbnRyeS4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gKGNvbXBvbmVudCwgbGV2ZWwsIHRleHQpIHsKICAgIHZhciBsb2dFbnRyeSA9IG5ldyBMb2dFbnRyeShjb21wb25lbnQsIGxldmVsLCB0ZXh0LCB0aGlzLmdldExvZ2dlcklkKCkpOwogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhsb2dFbnRyeSk7CiAgICB0aGlzLmFkZExvZ0VudHJ5KGxvZ0VudHJ5KTsKICAgIHJldHVybiBsb2dFbnRyeTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmFkZExvZ0VudHJ5ID0gZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAvLyBDYWxsIHRoaXMgc2Vjb25kIHRpbWUgYXMgaW4gc29tZSBwbGFjZXMgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgZGlyZWN0bHkKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8obG9nRW50cnkpOwogICAgdGhpcy5fbG9ncy5wdXNoKGxvZ0VudHJ5KTsKCiAgICAvL0ZvciBub3cgb25seSBzZW5kIHNvZnRwaG9uZSBsb2dzIG9ubHkuCiAgICAvL1RPRE8gYWRkIENDUCBsb2dzIG9uY2Ugd2UgYXJlIHN1cmUgdGhhdCBubyBzZW5zaXRpdmUgZGF0YSBpcyBiZWluZyBsb2dnZWQuCiAgICBpZiAoTG9nQ29tcG9uZW50LlNPRlRQSE9ORSA9PT0gbG9nRW50cnkuY29tcG9uZW50KSB7CiAgICAgIHRoaXMuX2xvZ3NUb1B1c2gucHVzaChsb2dFbnRyeSk7CiAgICB9CgogICAgaWYgKGxvZ0VudHJ5LmxldmVsIGluIExvZ0xldmVsT3JkZXIgJiYKICAgICAgTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fbG9nTGV2ZWwpIHsKCiAgICAgIGlmIChMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9lY2hvTGV2ZWwpIHsKICAgICAgICBDT05TT0xFX0xPR0dFUl9NQVBbbG9nRW50cnkuZ2V0TGV2ZWwoKV0obG9nRW50cnkudG9TdHJpbmcoKSk7CiAgICAgIH0KCiAgICAgIGxvZ0VudHJ5LmxpbmUgPSB0aGlzLl9saW5lQ291bnQrKzsKICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNlbmRJbnRlcm5hbExvZ0VudHJ5VG9TZXJ2ZXIgPSBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnB1c2gobG9nRW50cnkpOwoKICAgIGlmIChsb2dFbnRyeS5sZXZlbCBpbiBMb2dMZXZlbE9yZGVyICYmCiAgICAgIExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2xvZ0xldmVsKSB7CgogICAgICBpZiAoTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fZWNob0xldmVsKSB7CiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQW2xvZ0VudHJ5LmdldExldmVsKCldKGxvZ0VudHJ5LnRvU3RyaW5nKCkpOwogICAgICB9CgogICAgICBsb2dFbnRyeS5saW5lID0gdGhpcy5fbGluZUNvdW50Kys7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVtb3ZlIGFsbCBvYmplY3RzIGZyb20gYWxsIGxvZyBlbnRyaWVzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuY2xlYXJPYmplY3RzID0gZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW3hdLm9iamVjdHMpIHsKICAgICAgICBkZWxldGUgdGhpcy5fbG9nc1t4XS5vYmplY3RzOwogICAgICB9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVtb3ZlIGFsbCBleGNlcHRpb24gc3RhY2sgdHJhY2VzIGZyb20gdGhlIGxvZyBlbnRyaWVzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuY2xlYXJFeGNlcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW3hdLmV4Y2VwdGlvbikgewogICAgICAgIGRlbGV0ZSB0aGlzLl9sb2dzW3hdLmV4Y2VwdGlvbjsKICAgICAgfQogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUudHJhY2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuVFJBQ0UsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuREVCVUcsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5JTkZPLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmxvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5MT0csIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUudGVzdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5URVNULCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuV0FSTiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5FUlJPUiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5jcml0aWNhbCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5FUlJPUiwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBsb2dnZXIgY29udGVudHMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsaW5lcyA9IFtdOwogICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLl9sb2dzLmxlbmd0aDsgeCsrKSB7CiAgICAgIGxpbmVzLnB1c2godGhpcy5fbG9nc1t4XS50b1N0cmluZygpKTsKICAgIH0KCiAgICByZXR1cm4gbGluZXMuam9pbigiXG4iKTsKICB9OwogIAogIC8qKgogICAqIERvd25sb2FkL0FyY2hpdmUgbG9ncyB0byBhIGZpbGUsIAogICAqIEJ5IGRlZmF1bHQsIGl0IHJldHVybnMgYWxsIGxvZ3MuCiAgICogVG8gZmlsdGVyIGxvZ3MgYnkgdGhlIG1pbmltdW0gbG9nIGxldmVsIHNldCBieSBzZXRMb2dMZXZlbCBvciB0aGUgZGVmYXVsdCBzZXQgaW4gX2xvZ0xldmVsLCAKICAgKiBwYXNzIGluIGZpbHRlckJ5TG9nTGV2ZWwgdG8gdHJ1ZSBpbiBvcHRpb25zCiAgICogCiAgICogQHBhcmFtIG9wdGlvbnMgZG93bmxvYWQgb3B0aW9ucyBbT2JqZWN0fFN0cmluZ10uIAogICAqIC0gb2YgdHlwZSBPYmplY3Q6IAogICAqICAgeyBsb2dOYW1lOiAnbXktbG9nLW5hbWUnLAogICAqICAgICBmaWx0ZXJCeUxvZ0xldmVsOiBmYWxzZSwgLy9kb3dubG9hZCBhbGwgbG9ncwogICAqICAgfQogICAqIC0gb2YgdHlwZSBTdHJpbmcgKGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KSwgdGhlIGZpbGUncyBuYW1lCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5kb3dubG9hZCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciBsb2dOYW1lID0gJ2FnZW50LWxvZyc7CiAgICB2YXIgZmlsdGVyQnlMb2dMZXZlbCA9IGZhbHNlOwoKICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ29iamVjdCcpIHsKICAgICAgbG9nTmFtZSA9IG9wdGlvbnMubG9nTmFtZSB8fCBsb2dOYW1lOwogICAgICBmaWx0ZXJCeUxvZ0xldmVsID0gb3B0aW9ucy5maWx0ZXJCeUxvZ0xldmVsIHx8IGZpbHRlckJ5TG9nTGV2ZWw7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgbG9nTmFtZSA9IG9wdGlvbnMgfHwgbG9nTmFtZTsKICAgIH0KCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgbG9ncyA9IHRoaXMuX3JvbGxlZExvZ3MuY29uY2F0KHRoaXMuX2xvZ3MpOwogICAgaWYgKGZpbHRlckJ5TG9nTGV2ZWwpIHsKICAgICAgbG9ncyA9IGxvZ3MuZmlsdGVyKGZ1bmN0aW9uKGVudHJ5KSB7CiAgICAgICAgcmV0dXJuIExvZ0xldmVsT3JkZXJbZW50cnkubGV2ZWxdID49IHNlbGYuX2xvZ0xldmVsOwogICAgICB9KTsKICAgIH0KCiAgICB2YXIgbG9nQmxvYiA9IG5ldyBnbG9iYWwuQmxvYihbSlNPTi5zdHJpbmdpZnkobG9ncywgdW5kZWZpbmVkLCA0KV0sIFsndGV4dC9wbGFpbiddKTsKICAgIHZhciBkb3dubG9hZExpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICB2YXIgbG9nTmFtZSA9IGxvZ05hbWUgfHwgJ2FnZW50LWxvZyc7CiAgICBkb3dubG9hZExpbmsuaHJlZiA9IGdsb2JhbC5VUkwuY3JlYXRlT2JqZWN0VVJMKGxvZ0Jsb2IpOwogICAgZG93bmxvYWRMaW5rLmRvd25sb2FkID0gbG9nTmFtZSArICcudHh0JzsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZG93bmxvYWRMaW5rKTsKICAgIGRvd25sb2FkTGluay5jbGljaygpOwogICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChkb3dubG9hZExpbmspOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVVcHN0cmVhbUxvZ1B1c2ggPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgaWYgKCFjb25uZWN0LnVwc3RyZWFtTG9nUHVzaFNjaGVkdWxlZCkgewogICAgICBjb25uZWN0LnVwc3RyZWFtTG9nUHVzaFNjaGVkdWxlZCA9IHRydWU7CiAgICAgIC8qKiBTY2hlZHVsZSBwdXNoaW5nIGxvZ3MgZnJlcXVlbnRseSB0byBzaGFyZWR3b3JrZXIgdXBzdHJlYW0sIHNoYXJlZHdvcmtlciB3aWxsIHJlcG9ydCB0byB0aGUgQ1RJIGJhY2tlbmQqLwogICAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSwgY29uZHVpdCksIFNPRlRQSE9ORV9MT0dfUkVQT1JUX0lOVEVSVkFMX01JTExJUyk7CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5yZXBvcnRNYXN0ZXJMb2dzVXBTdHJlYW0gPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgdmFyIGxvZ3NUb1B1c2ggPSB0aGlzLl9sb2dzVG9QdXNoLnNsaWNlKCk7CiAgICB0aGlzLl9sb2dzVG9QdXNoID0gW107CiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUywgZnVuY3Rpb24gKCkgewogICAgICBpZiAobG9nc1RvUHVzaC5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VORF9MT0dTLCBsb2dzVG9QdXNoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzUHVzaCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaE91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1Vwc3RyZWFtLCBjb25kdWl0KSwgMTAwMCk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BMb2dzUHVzaCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaE91dGVyQ29udGV4dENDUExvZ3NVcHN0cmVhbSwgY29uZHVpdCksIDEwMDApOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzVXBzdHJlYW0gPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoID4gMCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0udGV4dCA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldLnRleHQ7CiAgICAgIH0KCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzKTsKICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICAgIH0KICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaE91dGVyQ29udGV4dENDUExvZ3NVcHN0cmVhbSA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGZvciAodmFyIGkgPSB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoOyBpIDwgdGhpcy5fbG9ncy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5fbG9nc1tpXS5sb2dnZXJJZCAhPT0gdGhpcy5fbG9nZ2VySWQpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIHRoaXMuX2xvZ3NbaV0pOwogICAgfQogICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IHRoaXMuX2xvZ3MubGVuZ3RoOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5nZXRMb2dnZXJJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9sb2dnZXJJZDsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlRG93bnN0cmVhbUNsaWVudFNpZGVMb2dzUHVzaCA9IGZ1bmN0aW9uICgpIHsKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucHVzaENsaWVudFNpZGVMb2dzRG93bnN0cmVhbSksIExPR1NfUkVQT1JUX0lOVEVSVkFMX01JTExJUyk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hDbGllbnRTaWRlTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9ncyA9IFtdOwoKICAgIC8vIFdlIGRvIG5vdCBzZW5kIGEgcmVxdWVzdCBpZiB3ZSBoYXZlIGxlc3MgdGhhbiA1MCByZWNvcmRzIHNvIHRoYXQgd2UgbWluaW1pemUgdGhlIG51bWJlciBvZgogICAgLy8gcmVxdWVzdHMgcGVyIHNlY29uZC4gCiAgICAvLyA1MDAgaXMgdGhlIG1heCB3ZSBhY2NlcHQgb24gdGhlIHNlcnZlci4gCiAgICAvLyBXZSBjaG9zZSA1MDAgYmVjYXVzZSB0aGlzIGlzIHRoZSBsaW1pdCBpbXBvc2VkIGJ5IEZpcmVob3NlIGZvciBhIHB1dCBiYXRjaCByZXF1ZXN0CiAgICBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoIDwgNTApIHsKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPiA1MDApIHsKICAgICAgbG9ncyA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnNwbGljZSgwLCA1MDApOwogICAgfSBlbHNlIHsKICAgICAgbG9ncyA9IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzOwogICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgfQoKICAgIGNvbm5lY3QucHVibGlzaENsaWVudFNpZGVMb2dzKGxvZ3MpOwogIH0KCiAgdmFyIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIExvZ2dlci5jYWxsKHRoaXMpOwogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIAogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fcHVzaExvZ3NEb3duc3RyZWFtKSwKICAgICAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIuTE9HX1BVU0hfSU5URVJWQUwpOwoKICAgIC8vIERpc2FibGUgbG9nIHJvbGxpbmcsIHdlIHdpbGwgcHVyZ2Ugb3VyIG93biBsb2dzIG9uY2UgdGhleSBoYXZlCiAgICAvLyBiZWVuIHB1c2hlZCBkb3duc3RyZWFtLgogICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwodGhpcy5fbG9nUm9sbFRpbWVyKTsKICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IG51bGw7CiAgfTsKICAvLyBIb3cgZnJlcXVlbnRseSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIGRlbGl2ZXJlZCBkb3duc3RyZWFtLgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLkxPR19QVVNIX0lOVEVSVkFMID0gMTAwMDsKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKExvZ2dlci5wcm90b3R5cGUpOwogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IERvd25zdHJlYW1Db25kdWl0TG9nZ2VyOwoKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUucHVzaExvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKGxvZ3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGxvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGxvZyk7CiAgICB9KTsKICB9OwoKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUuX3B1c2hMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIAogICAgdGhpcy5fbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogICAgdGhpcy5fbG9ncyA9IFtdOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldKTsKICAgIH0KCiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogIH07CgogIC8qKgogICAqIFdyYXAgYSBmdW5jdGlvbiB3aXRoIHRyeSBjYXRjaCBibG9jawogICAqLwogIHZhciB0cnlDYXRjaFdyYXBwZXJNZXRob2QgPSBmdW5jdGlvbiAoZm4pIHsKICAgIHZhciB3cmFwcGVkZnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIC8vIFNpbmNlIHRoaXMgd3JhcHMgTG9nZ2VyIGNsYXNzLCB3ZSBjYW4gb25seSBwcmludCBpdCBpbiB0aGUgY29uc29sZSBhbmQgZWF0IGl0LgogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUC5FUlJPUihlKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHdyYXBwZWRmdW5jdGlvbjsKICB9CiAgLyoqCiAgICogVGhpcyBpcyBhIHdyYXBwZXIgbWV0aG9kIHRvIHdyYXAgZWFjaCBmdW5jdGlvbgogICAqIGluIGFuIG9iamVjdCB3aXRoIHRyeSBjYXRjaCBibG9jay4KICAgKi8KICB2YXIgdHJ5Q2F0Y2hXcmFwcGVyT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgZm9yICh2YXIgbWV0aG9kIGluIG9iaikgewogICAgICBpZiAodHlwZW9mKG9ialttZXRob2RdKSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIG9ialttZXRob2RdID0gdHJ5Q2F0Y2hXcmFwcGVyTWV0aG9kKG9ialttZXRob2RdKTsKICAgICAgfQogICAgfQogIH0KCiAgLyoqIENyZWF0ZSB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICBjb25uZWN0LnJvb3RMb2dnZXIgPSBuZXcgTG9nZ2VyKCk7CiAgdHJ5Q2F0Y2hXcmFwcGVyT2JqZWN0KGNvbm5lY3Qucm9vdExvZ2dlcik7CgoKICAvKiogRmV0Y2ggdGhlIHNpbmdsZXRvbiBsb2dnZXIgaW5zdGFuY2UuICovCiAgdmFyIGdldExvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnJvb3RMb2dnZXI7CiAgfTsKCiAgY29ubmVjdCA9IGNvbm5lY3QgfHwge307CiAgY29ubmVjdC5nZXRMb2cgPSBnZXRMb2c7CiAgY29ubmVjdC5Mb2dFbnRyeSA9IExvZ0VudHJ5OwogIGNvbm5lY3QuTG9nZ2VyID0gTG9nZ2VyOwogIGNvbm5lY3QuTG9nTGV2ZWwgPSBMb2dMZXZlbDsKICBjb25uZWN0LkxvZ0NvbXBvbmVudCA9IExvZ0NvbXBvbmVudDsKICBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA0Mzk6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5DaGF0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbywgbWV0YWRhdGEpIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQ7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIGNvbm5lY3QuQ2hhdFNlc3Npb24uc2V0R2xvYmFsQ29uZmlnKHsKICAgICAgICBsb2dnZXJDb25maWc6IHsKICAgICAgICAgIGxvZ2dlcjogbG9nZ2VyCiAgICAgICAgfSwKICAgICAgICByZWdpb246IG1ldGFkYXRhLnJlZ2lvbgogICAgICB9KTsKCiAgICAgIC8qKiBDb3VsZCBiZSBhbHNvIENVU1RPTUVSIC0gIEZvciBub3cgd2UgYXJlIGNyZWF0aW5nIG9ubHkgQWdlbnQgY29ubmVjdGlvbiBtZWRpYSBvYmplY3QgKi8KICAgICAgdmFyIGNvbnRyb2xsZXIgPSBjb25uZWN0LkNoYXRTZXNzaW9uLmNyZWF0ZSh7CiAgICAgICAgY2hhdERldGFpbHM6IG1lZGlhSW5mbywKICAgICAgICB0eXBlOiAiQUdFTlQiLAogICAgICAgIHdlYnNvY2tldE1hbmFnZXI6IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCkKICAgICAgfSk7CiAgICAgIAogICAgICB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwogICAgICByZXR1cm4gY29udHJvbGxlcgogICAgICAgIC5jb25uZWN0KCkKICAgICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCBmb3IgY29udGFjdElkICVzIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLCBtZWRpYUluZm8uY29udGFjdElkKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCIsIG1lZGlhSW5mby5jb250YWN0SWQsIGVycm9yKTsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgZGF0YTogZGF0YSB8fCBtZWRpYUluZm8KICAgICAgfSk7CiAgICB9OwoKICAgIHZhciB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzID0gZnVuY3Rpb24gKGNvbnRyb2xsZXIpIHsKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Ccm9rZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIikKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iLCBkYXRhKTsKICAgICAgfSk7CgogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkVzdGFibGlzaGVkKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIiwgZGF0YSk7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0KICAgIH0KICB9Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAyNzk6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5NZWRpYUZhY3RvcnkgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAvKiogY29udHJvbGxlciBob2xkZXIgKi8KICAgIHZhciBtZWRpYUNvbnRyb2xsZXJzID0ge307CiAgICB2YXIgdG9CZURlc3Ryb3llZCA9IG5ldyBTZXQoKTsKCiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBtZXRhZGF0YSA9IGNvbm5lY3QubWVyZ2Uoe30sIHBhcmFtcykgfHwge307CiAgICBtZXRhZGF0YS5yZWdpb24gPSAgbWV0YWRhdGEucmVnaW9uIHx8ICJ1cy13ZXN0LTIiOyAvLyBEZWZhdWx0IGl0IHRvIHVzLXdlc3QtMgoKICAgIHZhciBnZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICB2YXIgY29ubmVjdGlvbklkID0gY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgdmFyIG1lZGlhSW5mbyA9IGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCk7CiAgICAgIC8qKiBpZiB3ZSBkbyBub3QgaGF2ZSB0aGUgbWVkaWEgaW5mbyB0aGVuIGp1c3QgcmVqZWN0IHRoZSByZXF1ZXN0ICovCiAgICAgIGlmICghbWVkaWFJbmZvKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIk1lZGlhIGluZm8gZG9lcyBub3QgZXhpc3QgZm9yIGEgbWVkaWEgdHlwZSAlcyIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAud2l0aE9iamVjdChjb25uZWN0aW9uT2JqKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdCBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KCiAgICAgIGlmICghbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAibWVkaWEgY29udHJvbGxlciBvZiB0eXBlICVzIGluaXQiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBzd2l0Y2ggKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpIHsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuQ0hBVDoKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LkNoYXRNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSwgbWV0YWRhdGEpLmdldCgpOwogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5TT0ZUUEhPTkU6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5UYXNrTWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCkpLmdldCgpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIlVucmVjb2duaXplZCBtZWRpYSB0eXBlICVzICIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICB9CiAgICB9OwoKICAgIC8qKiBDaGVjayBhbGwgdGhlIGFjdGl2ZSBzdGF0ZXMgZm9yIHRoZSBjb25uZWN0aW9uICovCiAgICB2YXIgaWZDb25uZWN0aW9uQWN0aXZlID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgcmV0dXJuIGNvbm5lY3Rpb25PYmouaXNBY3RpdmUoKTsKICAgIH07CgogICAgdmFyIGdldCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIGlmIChpZkNvbm5lY3Rpb25BY3RpdmUoY29ubmVjdGlvbk9iaikpIHsKICAgICAgICByZXR1cm4gZ2V0TWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmopOwogICAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3koY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKSk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBDb250cm9sbGVyIGlzIG5vIGxvbmdlciBhdmFpbGFibGUgZm9yIHRoaXMgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICBpZiAobWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdICYmICF0b0JlRGVzdHJveWVkLmhhcyhjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAiRGVzdHJveWluZyBtZWRpYUNvbnRyb2xsZXIgZm9yICVzIiwKICAgICAgICAgIGNvbm5lY3Rpb25JZAogICAgICAgICk7CiAgICAgICAgdG9CZURlc3Ryb3llZC5hZGQoY29ubmVjdGlvbklkKTsKICAgICAgICBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0KICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIuY2xlYW5VcCA9PT0gImZ1bmN0aW9uIikgY29udHJvbGxlci5jbGVhblVwKCk7CiAgICAgICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgICAgICAgIHRvQmVEZXN0cm95ZWQuZGVsZXRlKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWxldGUgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICAgICAgICB0b0JlRGVzdHJveWVkLmRlbGV0ZShjb25uZWN0aW9uSWQpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBnZXQsCiAgICAgIGRlc3Ryb3k6IGRlc3Ryb3kKICAgIH07CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNDE4OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIC8vIFRPRE8gbW92ZSBzb2Z0cGhvbmUgaW1wbGVtZW50YXRpb25zIGhlcmUgLSBXaWwgZG8gdGhpcyBmb3IgR0EKICBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWVkaWFJbmZvKQogICAgICB9CiAgICB9CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMTg3OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuVGFza01lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LlRBU0s7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyCiAgICAgICAgLmluZm8obG9nQ29tcG9uZW50LCAiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbyk7CgogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuVGFza1Nlc3Npb24uY3JlYXRlKHsKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogbWVkaWFJbmZvLmluaXRpYWxDb250YWN0SWQsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgfSk7CgogICAgICB0cmFja1Rhc2tDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwoKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJUYXNrIFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyCiAgICAgICAgICAgIC5lcnJvcigKICAgICAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLAogICAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICAgKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcik7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICk7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvLAogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrVGFza0Nvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlcgogICAgICAgICAgLmVycm9yKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIsIGRhdGEpOwogICAgICB9KTsKCiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uRXN0YWJsaXNoZWQoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIKICAgICAgICAgIC5pbmZvKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0sCiAgICB9OwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA3NDM6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgdmFyIFJpbmd0b25lRW5naW5lQmFzZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fcHJldkNvbnRhY3RJZCA9IG51bGw7CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lQ29uZmlnLCAicmluZ3RvbmVDb25maWciKTsKICAgIGlmICghcmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJyaW5ndG9uZVVybCBpcyByZXF1aXJlZCEiKTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLkF1ZGlvICYmIHR5cGVvZiBnbG9iYWwuUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgc2VsZi5fYXVkaW8gPSBuZXcgQXVkaW8ocmluZ3RvbmVDb25maWcucmluZ3RvbmVVcmwpOwogICAgICAgIHNlbGYuX2F1ZGlvLmxvb3AgPSB0cnVlOwogICAgICAgIHNlbGYuX2F1ZGlvLmFkZEV2ZW50TGlzdGVuZXIoImNhbnBsYXkiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9hdWRpb1BsYXlhYmxlID0gdHJ1ZTsKICAgICAgICAgIHJlc29sdmUoc2VsZi5fYXVkaW8pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICB0aGlzLl9hdWRpbyA9IG51bGw7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlVuYWJsZSB0byBwcm92aWRlIGEgcmluZ3RvbmUuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KCiAgICBzZWxmLl9kcml2ZVJpbmd0b25lKCk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiTm90IGltcGxlbWVudGVkLiIpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3N0YXJ0UmluZ3RvbmUgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHRoaXMuX2F1ZGlvKSB7CiAgICAgIHRoaXMuX2F1ZGlvLnBsYXkoKQogICAgICAgIC5jYXRjaChmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFBsYXliYWNrIEZhaWx1cmUiLCBjb250YWN0KTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlJpbmd0b25lIFBsYXliYWNrIEZhaWx1cmUiKS53aXRoRXhjZXB0aW9uKGUpLndpdGhPYmplY3Qoe2N1cnJlbnRTcmM6IHNlbGYuX2F1ZGlvLmN1cnJlbnRTcmMsIHNpbmtJZDogc2VsZi5fYXVkaW8uc2lua0lkLCB2b2x1bWU6IHNlbGYuX2F1ZGlvLnZvbHVtZX0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSk7CiAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RhcnQiLCBjb250YWN0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBTdGFydCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fc3RvcFJpbmd0b25lID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIGlmICh0aGlzLl9hdWRpbykgewogICAgICB0aGlzLl9hdWRpby5wYXVzZSgpOwogICAgICB0aGlzLl9hdWRpby5jdXJyZW50VGltZSA9IDA7CiAgICAgIHRoaXMuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgU3RvcCIsIGNvbnRhY3QpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIFN0b3AiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIC8qKgogICAqIFN0b3AgcmluZ3RvbmUuCiAgICovCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5zdG9wUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9zdG9wUmluZ3RvbmUoKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9yaW5ndG9uZVNldHVwID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuUklOR1RPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5fc3RhcnRSaW5ndG9uZShjb250YWN0KTsKICAgICAgc2VsZi5fcHJldkNvbnRhY3RJZCA9IGNvbnRhY3QuZ2V0Q29udGFjdElkKCk7CgogICAgICBjb250YWN0Lm9uQ29ubmVjdGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIGNvbnRhY3Qub25BY2NlcHRlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICBjb250YWN0Lm9uRW5kZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgLy8gSnVzdCB0byBtYWtlIHN1cmUgdG8gc3RvcCB0aGUgcmluZ3RvbmUgaW4gY2FzZSBvZiB0aGUgZmFpbHVyZXMgb2Ygc3BlY2lmaWMgY2FsbGJhY2tzKG9uQWNjZXB0ZWQsb25Db25uZWN0ZWQpOwogICAgICBjb250YWN0Lm9uUmVmcmVzaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgIT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyAmJgogICAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlICE9PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSB7CiAgICAgICAgICBzZWxmLl9zdG9wUmluZ3RvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdCkgewogICAgaWYgKGNvbnRhY3QgJiYgY29udGFjdC5nZXRDb250YWN0SWQoKSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3QuZ2V0Q29udGFjdElkKCkKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ2hhbmdlIHRoZSBhdWRpbyBkZXZpY2UgdXNlZCB0byBwbGF5IHJpbmd0b25lLgogICAqIElmIGF1ZGlvIGVsZW1lbnQgaXMgbm90IGZ1bGx5IGluaXRpYWxpemVkLCB0aGUgQVBJIHdpbGwgd2FpdCBfYXVkaW9QbGF5YWJsZVByb21pc2UgZm9yIDMgc2Vjb25kcyBhbmQgZmFpbCBvbiB0aW1lb3V0LgogICAqIFRoaXMgQVBJIGlzIHN1cHBvcnRlZCBvbmx5IGJ5IGJyb3dzZXJzIHRoYXQgaW1wbGVtZW50ZWQgRVM2IFByb21pc2UgYW5kIGh0dHA6Ly93d3cudzMub3JnL1RSL2F1ZGlvLW91dHB1dC8KICAgKiBSZXR1cm4gYSBQcm9taXNlIHRoYXQgaW5kaWNhdGVzIHRoZSByZXN1bHQgb2YgY2hhbmdpbmcgb3V0cHV0IGRldmljZS4KICAgKi8KICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLnNldE91dHB1dERldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgaWYgKHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlKSB7CiAgICAgIHZhciBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQgPSBQcm9taXNlLnJhY2UoWwogICAgICAgIHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlLAogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmVqZWN0KCJUaW1lZCBvdXQgd2FpdGluZyBmb3IgcGxheWFibGUgYXVkaW8iKTsgfSwgMzAwMC8qbXMqLyk7CiAgICAgICAgfSkKICAgICAgXSk7CiAgICAgIHJldHVybiBwbGF5YWJsZUF1ZGlvV2l0aFRpbWVvdXQudGhlbihmdW5jdGlvbiAoYXVkaW8pIHsKICAgICAgICBpZiAoYXVkaW8pIHsKICAgICAgICAgIGlmIChhdWRpby5zZXRTaW5rSWQpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShhdWRpby5zZXRTaW5rSWQoZGV2aWNlSWQpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vIGF1ZGlvIGZvdW5kIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBpZiAoZ2xvYmFsLlByb21pc2UpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3QgZWxpZ2libGUgcmluZ3RvbmUgb3duZXIiKTsKICAgIH0KICB9OwoKICB2YXIgVm9pY2VSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKCiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuVk9JQ0UgJiYKICAgICAgICBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CgogICAgbmV3IGNvbm5lY3QuQWdlbnQoKS5nZXRDb250YWN0cygpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgb25Db250YWN0Q29ubmVjdChjb250YWN0KTsKICAgICAgfQogICAgfSk7CiAgfTsKCgogIHZhciBDaGF0UmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CgogIENoYXRSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuQ0hBVCAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdCBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKICB2YXIgVGFza1Jpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1Jpbmd0b25lRW5naW5lOwoKICBUYXNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlRBU0sgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2sgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCgogIHZhciBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7CgogIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25JbmNvbWluZyhmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlFVRVVFX0NBTExCQUNLKSB7CiAgICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDYWxsYmFjayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNhbGxiYWNrIFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvKiBleHBvcnQgY29ubmVjdC5SaW5ndG9uZUVuZ2luZSAqLwogIGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZSA9IFZvaWNlUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5DaGF0UmluZ3RvbmVFbmdpbmUgPSBDaGF0UmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5UYXNrUmluZ3RvbmVFbmdpbmUgPSBUYXNrUmluZ3RvbmVFbmdpbmU7CiAgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgPSBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmU7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA2NDI6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwogIGdsb2JhbC5jY3BWZXJzaW9uID0gIlYyIjsKCiAgdmFyIFJUUEpvYkludGVydmFsTXMgPSAxMDAwOwogIHZhciBzdGF0c1JlcG9ydGluZ0pvYkludGVydmFsTXMgPSAzMDAwMDsKICB2YXIgc3RyZWFtQnVmZmVyU2l6ZSA9IDUwMDsKICB2YXIgQ2FsbFR5cGVNYXAgPSB7fTsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLkFVRElPX09OTFldID0gJ0F1ZGlvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLlZJREVPX09OTFldID0gJ1ZpZGVvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLkFVRElPX1ZJREVPXSA9ICdBdWRpb1ZpZGVvJzsKICBDYWxsVHlwZU1hcFtjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlLk5PTkVdID0gJ05vbmUnOwogIHZhciBBVURJT19JTlBVVCA9ICdhdWRpb19pbnB1dCc7CiAgdmFyIEFVRElPX09VVFBVVCA9ICdhdWRpb19vdXRwdXQnOwoKICB2YXIgTWVkaWFUeXBlTWFwID0ge307CiAgTWVkaWFUeXBlTWFwW2Nvbm5lY3QuQ29udGFjdFR5cGUuVk9JQ0VdID0gIlZvaWNlIjsKICB2YXIgVU5LTk9XTl9NRURJQV9UWVBFID0gIlVua25vd24iOwoKICB2YXIgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgdmFyIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IHt9OwogIHZhciBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IHt9OwogIHZhciBydHBTdGF0c0pvYiA9IG51bGw7CiAgdmFyIHJlcG9ydFN0YXRzSm9iID0gbnVsbDsKICAvL0xvZ2dlciBzcGVjaWZpYyB0byBzb2Z0cGhvbmUuCiAgdmFyIGxvZ2dlciA9IG51bGw7CiAgdmFyIFNvZnRwaG9uZUVycm9yVHlwZXMgPSBjb25uZWN0LlNvZnRwaG9uZUVycm9yVHlwZXM7CiAgdmFyIEhBTkdfVVBfTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQgPSAiTXVsdGlTZXNzaW9uSGFuZ1VwIjsKICB2YXIgTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQgPSAiTXVsdGlTZXNzaW9ucyI7CgogIHZhciBsb2NhbE1lZGlhU3RyZWFtID0ge307CgogIHZhciBzb2Z0cGhvbmVDbGllbnRJZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKCiAgdmFyIHJlcXVlc3RJY2VBY2Nlc3MgPSBmdW5jdGlvbiAodHJhbnNwb3J0KSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCkuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgdHJhbnNwb3J0LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHJlc29sdmUoZGF0YS5zb2Z0cGhvbmVUcmFuc3BvcnQuc29mdHBob25lTWVkaWFDb25uZWN0aW9ucyk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAocmVhc29uKSB7CiAgICAgICAgICBpZiAocmVhc29uLm1lc3NhZ2UgJiYgcmVhc29uLm1lc3NhZ2UuaW5jbHVkZXMoIlNvZnRwaG9uZUNvbm5lY3Rpb25MaW1pdEJyZWFjaGVkRXhjZXB0aW9uIikpIHsKICAgICAgICAgICAgcHVibGlzaEVycm9yKCJtdWx0aXBsZV9zb2Z0cGhvbmVfYWN0aXZlX3Nlc3Npb25zIiwgIk51bWJlciBvZiBhY3RpdmUgc2Vzc2lvbnMgYXJlIG1vcmUgdGhlbiBhbGxvd2VkIGxpbWl0LiIsICIiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlamVjdChFcnJvcigicmVxdWVzdEljZUFjY2VzcyBmYWlsZWQiKSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmVqZWN0KEVycm9yKCJBdXRoZW50aWNhdGlvbiBmYWlsZWQgd2hpbGUgcmVxdWVzdEljZUFjY2VzcyIpKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgcmVqZWN0KEVycm9yKCJBY2Nlc3MgRGVuaWVkIHdoaWxlIHJlcXVlc3RJY2VBY2Nlc3MiKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIHZhciBTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKHNvZnRwaG9uZVBhcmFtcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9nZ2VyID0gbmV3IFNvZnRwaG9uZUxvZ2dlcihjb25uZWN0LmdldExvZygpKTsKICAgIGxvZ2dlci5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIHNvZnRwaG9uZSBtYW5hZ2VyIGluaXRpYWxpemF0aW9uIGhhcyBiZWd1biIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgcnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5OwogICAgaWYgKGNvbm5lY3QuUnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSA9IG5ldyBjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeShsb2dnZXIsCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgICBzb2Z0cGhvbmVDbGllbnRJZCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHJlcXVlc3RJY2VBY2Nlc3MsIHsKICAgICAgICAgIHRyYW5zcG9ydFR5cGU6ICJzb2Z0cGhvbmUiLAogICAgICAgICAgc29mdHBob25lQ2xpZW50SWQ6IHNvZnRwaG9uZUNsaWVudElkCiAgICAgICAgfSksCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBwdWJsaXNoRXJyb3IpKTsKICAgIH0KICAgIGlmICghaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkKCkpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUiwKICAgICAgICAiQ29ubmVjdCBkb2VzIG5vdCBzdXBwb3J0IHRoaXMgYnJvd3Nlci4gU29tZSBmdW5jdGlvbmFsaXR5IG1heSBub3Qgd29yay4gIiwKICAgICAgICAiIik7CiAgICB9CiAgICB2YXIgZ3VtUHJvbWlzZSA9IGZldGNoVXNlck1lZGlhKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICB7CiAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNaWNyb3Bob25lUGVybWlzc2lvbiIsCiAgICAgICAgICBzdGF0dXM6ICJncmFudGVkIgogICAgICAgIH0pOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgcHVibGlzaEVycm9yKGVyciwgIllvdXIgbWljcm9waG9uZSBpcyBub3QgZW5hYmxlZCBpbiB5b3VyIGJyb3dzZXIuICIsICIiKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0IiwgbnVsbCwgCiAgICAgICAgewogICAgICAgICAgY29ubmVjdGl2aXR5Q2hlY2tUeXBlOiAiTWljcm9waG9uZVBlcm1pc3Npb24iLAogICAgICAgICAgc3RhdHVzOiAiZGVuaWVkIgogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIAogICAgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSgpOwogICAgaGFuZGxlU3BlYWtlckRldmljZUNoYW5nZSgpOwogICAgaGFuZGxlTWljcm9waG9uZURldmljZUNoYW5nZSgpOwogICAgbW9uaXRvck1pY3JvcGhvbmVQZXJtaXNzaW9uKCk7CgogICAgdGhpcy5yaW5ndG9uZUVuZ2luZSA9IG51bGw7CiAgICB2YXIgcnRjU2Vzc2lvbnMgPSB7fTsKICAgIC8vIFRyYWNrcyB0aGUgYWdlbnQgY29ubmVjdGlvbiBJRCwgc28gdGhhdCBpZiB0aGUgc2FtZSBjb250YWN0IGdldHMgcmUtcm91dGVkIHRvIHRoZSBzYW1lIGFnZW50LCBpdCdsbCBzdGlsbCBzZXQgdXAgc29mdHBob25lCiAgICB2YXIgY2FsbHNEZXRlY3RlZCA9IHt9OwogICAgdGhpcy5vbkluaXRDb250YWN0U3ViID0ge307CiAgICB0aGlzLm9uSW5pdENvbnRhY3RTdWIudW5zdWJzY3JpYmUgPSBmdW5jdGlvbigpIHt9OwoKICAgIC8vIHZhcmlhYmxlcyBmb3IgZmlyZWZveCBtdWx0aXRhYgogICAgdmFyIGlzU2Vzc2lvblBlbmRpbmcgPSBmYWxzZTsKICAgIHZhciBwZW5kaW5nQ29udGFjdCA9IG51bGw7CiAgICB2YXIgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gbnVsbDsKICAgIHZhciBwb3N0cG9uZVN0YXJ0aW5nU2Vzc2lvbiA9IGZ1bmN0aW9uIChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpc1Nlc3Npb25QZW5kaW5nID0gdHJ1ZTsKICAgICAgcGVuZGluZ0NvbnRhY3QgPSBjb250YWN0OwogICAgICBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBhZ2VudENvbm5lY3Rpb25JZDsKICAgIH0KICAgIHZhciBjYW5jZWxQZW5kaW5nU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgaXNTZXNzaW9uUGVuZGluZyA9IGZhbHNlOwogICAgICBwZW5kaW5nQ29udGFjdCA9IG51bGw7CiAgICAgIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB9CgogICAgLy8gaGVscGVyIG1ldGhvZCB0byBwcm92aWRlIGFjY2VzcyB0byBydGMgc2Vzc2lvbnMKICAgIHRoaXMuZ2V0U2Vzc2lvbiA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQpIHsKICAgICAgcmV0dXJuIHJ0Y1Nlc3Npb25zW2Nvbm5lY3Rpb25JZF07CiAgICB9CgogICAgdGhpcy5yZXBsYWNlTG9jYWxNZWRpYVRyYWNrID0gZnVuY3Rpb24oY29ubmVjdGlvbklkLCB0cmFjaykgewogICAgICB2YXIgc3RyZWFtID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgaWYoc3RyZWFtKXsKICAgICAgICB2YXIgb2xkVHJhY2sgPSBzdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXTsKICAgICAgICB0cmFjay5lbmFibGVkID0gb2xkVHJhY2suZW5hYmxlZDsKICAgICAgICBvbGRUcmFjay5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgc3RyZWFtLnJlbW92ZVRyYWNrKG9sZFRyYWNrKTsKICAgICAgICBzdHJlYW0uYWRkVHJhY2sodHJhY2spOwogICAgICB9CiAgICB9OwoKICAgIHZhciBpc0NvbnRhY3RUZXJtaW5hdGVkID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgcmV0dXJuIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5FTkRFRCB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5FUlJPUiB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5NSVNTRUQ7CiAgICB9OwoKICAgIHZhciBkZXN0cm95U2Vzc2lvbiA9IGZ1bmN0aW9uIChhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnMuaGFzT3duUHJvcGVydHkoYWdlbnRDb25uZWN0aW9uSWQpKSB7CiAgICAgICAgdmFyIHNlc3Npb24gPSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgLy8gQ3VycmVudGx5IHRoZSBhc3N1bXB0aW9uIGlzIGl0IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uIG9ubHkgYW5kIGlmIG9ubHkgaXQgYWxyZWFkeSBoYXMgYmVlbiBodW5nIHVwLgogICAgICAgIC8vIFRPRE86IFVwZGF0ZSBvbmNlIHRoZSBoYW5ndXAgQVBJIGRvZXMgbm90IHRocm93IGV4Y2VwdGlvbnMKICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgICAgc2Vzc2lvbi5oYW5ndXAoKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBsaWx5LmdldExvZygpLndhcm4oIkNsZWFuIHVwIHRoZSBzZXNzaW9uIGxvY2FsbHkgIiArIGFnZW50Q29ubmVjdGlvbklkLCBlcnIubWVzc2FnZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICAvLyBXaGVuIG11bHRpcGxlIFJUQyBzZXNzaW9ucyBkZXRlY3RlZCwgaWdub3JlIHRoZSBuZXcgY2FsbCBhbmQgaGFuZyB1cCB0aGUgcHJldmlvdXMgc2Vzc2lvbnMuCiAgICAvLyBUT0RPOiBVcGRhdGUgd2hlbiBjb25uZWN0LXJ0YyBleHBvc2VzIGFuIEFQSSB0byBkZXRlY3Qgc2Vzc2lvbiBzdGF0dXMuCiAgICB2YXIgc2FuaXR5Q2hlY2tBY3RpdmVTZXNzaW9ucyA9IGZ1bmN0aW9uIChydGNTZXNzaW9ucykgewogICAgICBpZiAoT2JqZWN0LmtleXMocnRjU2Vzc2lvbnMpLmxlbmd0aCA+IDApIHsKICAgICAgICAvLyBFcnJvciEgb3VyIHN0YXRlIGRvZXNuJ3QgbWF0Y2gsIHRlYXIgaXQgYWxsIGRvd24uCiAgICAgICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIHJ0Y1Nlc3Npb25zKSB7CiAgICAgICAgICBpZiAocnRjU2Vzc2lvbnMuaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAvLyBMb2cgYW4gZXJyb3IgZm9yIHRoZSBzZXNzaW9uIHdlIGFyZSBhYm91dCB0byBlbmQuCiAgICAgICAgICAgIHB1Ymxpc2hNdWx0aXBsZVNlc3Npb25zRXZlbnQoSEFOR19VUF9NVUxUSVBMRV9TRVNTSU9OU19FVkVOVCwgcnRjU2Vzc2lvbnNbY29ubmVjdGlvbklkXS5jYWxsSWQsIGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICAgIGRlc3Ryb3lTZXNzaW9uKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiZHVwbGljYXRlIHNlc3Npb24gZGV0ZWN0ZWQsIHJlZnVzaW5nIHRvIHNldHVwIG5ldyBjb25uZWN0aW9uIik7CiAgICAgIH0KICAgIH07CgogICAgdGhpcy5zdGFydFNlc3Npb24gPSBmdW5jdGlvbiAoX2NvbnRhY3QsIF9hZ2VudENvbm5lY3Rpb25JZCkgewogICAgICB2YXIgY29udGFjdCA9IGlzU2Vzc2lvblBlbmRpbmcgPyBwZW5kaW5nQ29udGFjdCA6IF9jb250YWN0OwogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBpc1Nlc3Npb25QZW5kaW5nID8gcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkIDogX2FnZW50Q29ubmVjdGlvbklkOwogICAgICBpZiAoIWNvbnRhY3QgfHwgIWFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNhbmNlbFBlbmRpbmdTZXNzaW9uKCk7CiAgICAgIAogICAgICAvLyBTZXQgdG8gdHJ1ZSwgdGhpcyB3aWxsIGJsb2NrIHN1YnNlcXVlbnQgaW52b2tlcyBmcm9tIGVudGVyaW5nLgogICAgICBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSA9IHRydWU7CiAgICAgIGxvZ2dlci5pbmZvKCJTb2Z0cGhvbmUgY2FsbCBkZXRlY3RlZDoiLCAiY29udGFjdElkICIgKyBjb250YWN0LmdldENvbnRhY3RJZCgpLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIC8vIEVuc3VyZSBvdXIgc2Vzc2lvbiBzdGF0ZSBtYXRjaGVzIG91ciBjb250YWN0IHN0YXRlIHRvIHByZXZlbnQgaXNzdWVzIHNob3VsZCB3ZSBsb3NlIHRyYWNrIG9mIGEgY29udGFjdC4KICAgICAgc2FuaXR5Q2hlY2tBY3RpdmVTZXNzaW9ucyhydGNTZXNzaW9ucyk7CgogICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcpIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBDb25uZWN0aW5nIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CiAgICAgIH0KCiAgICAgIGluaXRpYWxpemVQYXJhbXMoKTsKICAgICAgdmFyIHNvZnRwaG9uZUluZm8gPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmdldFNvZnRwaG9uZU1lZGlhSW5mbygpOwogICAgICB2YXIgY2FsbENvbmZpZyA9IHBhcnNlQ2FsbENvbmZpZyhzb2Z0cGhvbmVJbmZvLmNhbGxDb25maWdKc29uKTsKICAgICAgdmFyIHdlYlNvY2tldFByb3ZpZGVyOwogICAgICBpZiAoY2FsbENvbmZpZy51c2VXZWJTb2NrZXRQcm92aWRlcikgewogICAgICAgIHdlYlNvY2tldFByb3ZpZGVyID0gY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKTsKICAgICAgfQogICAgICB2YXIgc2Vzc2lvbiA9IG5ldyBjb25uZWN0LlJUQ1Nlc3Npb24oCiAgICAgICAgY2FsbENvbmZpZy5zaWduYWxpbmdFbmRwb2ludCwKICAgICAgICBjYWxsQ29uZmlnLmljZVNlcnZlcnMsCiAgICAgICAgc29mdHBob25lSW5mby5jYWxsQ29udGV4dFRva2VuLAogICAgICAgIGxvZ2dlciwKICAgICAgICBjb250YWN0LmdldENvbnRhY3RJZCgpLAogICAgICAgIGFnZW50Q29ubmVjdGlvbklkLAogICAgICAgIHdlYlNvY2tldFByb3ZpZGVyKTsKCiAgICAgIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXSA9IHNlc3Npb247CgogICAgICBpZiAoY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpKSB7CiAgICAgICAgc2Vzc2lvbi5tZWRpYVN0cmVhbSA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKTsKICAgICAgfQoKICAgICAgLy8gQ3VzdG9tIEV2ZW50IHRvIGluZGljYXRlIHRoZSBzZXNzaW9uIGluaXQgb3BlcmF0aW9ucwogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5TRVNTSU9OX0lOSVQsCiAgICAgICAgZGF0YTogewogICAgICAgICAgY29ubmVjdGlvbklkOiBhZ2VudENvbm5lY3Rpb25JZAogICAgICAgIH0KICAgICAgfSk7CgogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkZhaWxlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uLCByZWFzb24pIHsKICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBwdWJsaXNoU29mdHBob25lRmFpbHVyZUxvZ3MocnRjU2Vzc2lvbiwgcmVhc29uKTsKICAgICAgICBwdWJsaXNoU2Vzc2lvbkZhaWx1cmVUZWxlbWV0cnlFdmVudChjb250YWN0LmdldENvbnRhY3RJZCgpLCByZWFzb24pOwogICAgICAgIHN0b3BKb2JzQW5kUmVwb3J0KGNvbnRhY3QsIHJ0Y1Nlc3Npb24uc2Vzc2lvblJlcG9ydCk7CiAgICAgIH07CiAgICAgIHNlc3Npb24ub25TZXNzaW9uQ29ubmVjdGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIENvbm5lY3RlZCIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwogICAgICAgIC8vIEJlY29tZSBtYXN0ZXIgdG8gc2VuZCBsb2dzLCBzaW5jZSB3ZSBuZWVkIGxvZ3MgZnJvbSBzb2Z0cGhvbmUgdGFiLgogICAgICAgIGNvbm5lY3QuYmVjb21lTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNFTkRfTE9HUyk7CiAgICAgICAgLy9zdGFydCBzdGF0cyBjb2xsZWN0aW9uIGFuZCByZXBvcnRpbmcgam9icwogICAgICAgIHN0YXJ0U3RhdHNDb2xsZWN0aW9uSm9iKHJ0Y1Nlc3Npb24pOwogICAgICAgIHN0YXJ0U3RhdHNSZXBvcnRpbmdKb2IoY29udGFjdCk7CiAgICAgICAgZmlyZUNvbnRhY3RBY2NlcHRlZEV2ZW50KGNvbnRhY3QpOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5vblNlc3Npb25Db21wbGV0ZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gQ29tcGxldGVkIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CgogICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIC8vIFN0b3AgYWxsIGpvYnMgYW5kIHBlcmZvcm0gb25lIGxhc3Qgam9iLgogICAgICAgIHN0b3BKb2JzQW5kUmVwb3J0KGNvbnRhY3QsIHJ0Y1Nlc3Npb24uc2Vzc2lvblJlcG9ydCk7CgogICAgICAgIC8vIENsZWFudXAgdGhlIGNhY2hlZCBzdHJlYW1zCiAgICAgICAgZGVsZXRlTG9jYWxNZWRpYVN0cmVhbShhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgIH07CgogICAgICBzZXNzaW9uLm9uTG9jYWxTdHJlYW1BZGRlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uLCBzdHJlYW0pIHsKICAgICAgICAvLyBDYWNoZSB0aGUgc3RyZWFtcyBmb3IgbXV0ZS91bm11dGUKICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2FnZW50Q29ubmVjdGlvbklkXSA9IHsKICAgICAgICAgIHN0cmVhbTogc3RyZWFtCiAgICAgICAgfTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5MT0NBTF9NRURJQV9TVFJFQU1fQ1JFQVRFRCwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgY29ubmVjdGlvbklkOiBhZ2VudENvbm5lY3Rpb25JZAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5yZW1vdGVBdWRpb0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtb3RlLWF1ZGlvJyk7CiAgICAgIGlmIChydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkpIHsKICAgICAgICBzZXNzaW9uLmNvbm5lY3QocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5LmdldChjYWxsQ29uZmlnLmljZVNlcnZlcnMpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXNzaW9uLmNvbm5lY3QoKTsKICAgICAgfQogICAgfQoKICAgIHZhciBvblJlZnJlc2hDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF0gJiYgaXNDb250YWN0VGVybWluYXRlZChjb250YWN0KSkgewogICAgICAgIGRlc3Ryb3lTZXNzaW9uKGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICBjYW5jZWxQZW5kaW5nU2Vzc2lvbigpOwogICAgICB9CiAgICAgIGlmIChjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmICFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSAmJiAoCiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpKSB7CiAgICAgICAgICBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkgJiYgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMoKSkgewogICAgICAgICAgICBwb3N0cG9uZVN0YXJ0aW5nU2Vzc2lvbihjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLnN0YXJ0U2Vzc2lvbihjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgdmFyIG9uSW5pdENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmNvbm5lY3Rpb25JZDsKICAgICAgbG9nZ2VyLmluZm8oIkNvbnRhY3QgZGV0ZWN0ZWQ6IiwgImNvbnRhY3RJZCAiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICBpZiAoIWNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdKSB7CiAgICAgICAgY29udGFjdC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgb25SZWZyZXNoQ29udGFjdChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgc2VsZi5vbkluaXRDb250YWN0U3ViID0gY29ubmVjdC5jb250YWN0KG9uSW5pdENvbnRhY3QpOwoKICAgIC8vIENvbnRhY3QgYWxyZWFkeSBpbiBjb25uZWN0aW5nIHN0YXRlIHNjZW5hcmlvIC0gSW4gdGhpcyBjYXNlIGNvbnRhY3QgSU5JVCBpcyBtaXNzZWQgaGVuY2UgdGhlIE9uUmVmcmVzaCBjYWxsYmFjayBpcyBtaXNzZWQuIAogICAgbmV3IGNvbm5lY3QuQWdlbnQoKS5nZXRDb250YWN0cygpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5jb25uZWN0aW9uSWQ7CiAgICAgIGxvZ2dlci5pbmZvKCJDb250YWN0IGV4aXN0IGluIHRoZSBzbmFwc2hvdC4gUmVpbml0aWF0ZSB0aGUgQ29udGFjdCBhbmQgUlRDIHNlc3Npb24gY3JlYXRpb24gZm9yIGNvbnRhY3RJZCIgKyBjb250YWN0LmdldENvbnRhY3RJZCgpLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgb25Jbml0Q29udGFjdChjb250YWN0KTsKICAgICAgb25SZWZyZXNoQ29udGFjdChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCk7CiAgICB9KTsKICB9OwoKICB2YXIgZmlyZUNvbnRhY3RBY2NlcHRlZEV2ZW50ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICB2YXIgYWdlbnRDb25uZWN0aW9uID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKTsKICAgIGlmICghYWdlbnRDb25uZWN0aW9uKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgQWdlbnRDb25uZWN0aW9uLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc29mdHBob25lTWVkaWFJbmZvID0gYWdlbnRDb25uZWN0aW9uLmdldFNvZnRwaG9uZU1lZGlhSW5mbygpOwogICAgaWYgKCFzb2Z0cGhvbmVNZWRpYUluZm8pIHsKICAgICAgbG9nZ2VyLmluZm8oIk5vdCBhYmxlIHRvIHJldHJpZXZlIHRoZSBhdXRvLWFjY2VwdCBzZXR0aW5nIGZyb20gbnVsbCBTb2Z0cGhvbmVNZWRpYUluZm8sIGlnbm9yaW5nIGV2ZW50IHB1Ymxpc2guLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzb2Z0cGhvbmVNZWRpYUluZm8uYXV0b0FjY2VwdCA9PT0gdHJ1ZSkgewogICAgICBsb2dnZXIuaW5mbygiQXV0by1hY2NlcHQgaXMgZW5hYmxlZCwgc2VuZGluZyBvdXQgQWNjZXB0ZWQgZXZlbnQgdG8gc3RvcCByaW5ndG9uZS4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwKICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3QuY29udGFjdElkKQogICAgICB9KTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwgY29udGFjdC5jb250YWN0SWQpLAogICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdC5jb250YWN0SWQpCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGRpc2FibGVkLCByaW5ndG9uZSB3aWxsIGJlIHN0b3BwZWQgYnkgdXNlciBhY3Rpb24uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICAvLyBCaW5kIGV2ZW50cyBmb3IgbXV0ZQogIHZhciBoYW5kbGVTb2Z0UGhvbmVNdXRlVG9nZ2xlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NVVRFLCBtdXRlVG9nZ2xlKTsKICB9OwoKICB2YXIgaGFuZGxlU3BlYWtlckRldmljZUNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX1NQRUFLRVJfREVWSUNFLCBzZXRTcGVha2VyRGV2aWNlKTsKICB9CgogIHZhciBoYW5kbGVNaWNyb3Bob25lRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX01JQ1JPUEhPTkVfREVWSUNFLCBzZXRNaWNyb3Bob25lRGV2aWNlKTsKICB9CgogIHZhciBtb25pdG9yTWljcm9waG9uZVBlcm1pc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICBpZiAoY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uKCkgPiA0Myl7CiAgICAgICAgbmF2aWdhdG9yLnBlcm1pc3Npb25zLnF1ZXJ5KHtuYW1lOiAnbWljcm9waG9uZSd9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKHBlcm1pc3Npb25TdGF0dXMpewogICAgICAgICAgcGVybWlzc2lvblN0YXR1cy5vbmNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNaWNyb3Bob25lIFBlcm1pc3Npb246ICIgKyBwZXJtaXNzaW9uU3RhdHVzLnN0YXRlKTsKICAgICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDb25uZWN0aXZpdHlDaGVja1Jlc3VsdCIsIG51bGwsIAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29ubmVjdGl2aXR5Q2hlY2tUeXBlOiAiTWljcm9waG9uZVBlcm1pc3Npb24iLAogICAgICAgICAgICAgIHN0YXR1czogcGVybWlzc2lvblN0YXR1cy5zdGF0ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYocGVybWlzc2lvblN0YXR1cy5zdGF0ZSA9PT0gJ2RlbmllZCcpewogICAgICAgICAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCwKICAgICAgICAgICAgICAgICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLAogICAgICAgICAgICAgICAgIiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCBpbiBkZXRlY3RpbmcgbWljcm9waG9uZSBwZXJtaXNzaW9uIHN0YXR1czogIiArIGUpOwogICAgfQogIH0KCiAgLy8gTWFrZSBzdXJlIG9uY2Ugd2UgZGlzY29ubmVjdGVkIHdlIGdldCB0aGUgbXV0ZSBzdGF0ZSBiYWNrIHRvIG5vcm1hbAogIHZhciBkZWxldGVMb2NhbE1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgZGVsZXRlIGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IGZhbHNlIH0KICAgIH0pOwogIH07CgogIC8vIENoZWNrIGZvciB0aGUgbG9jYWwgc3RyZWFtcyBpZiBleGlzdHMgIC0gIHJldmVydCBpdAogIC8vIEFuZCBpbmZvcm0gb3RoZXIgY2xpZW50cyBhYm91dCB0aGUgY2hhbmdlIAogIHZhciBtdXRlVG9nZ2xlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIHZhciBzdGF0dXM7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGRhdGEgJiYgZGF0YS5tdXRlICE9PSB1bmRlZmluZWQpIHsKICAgICAgc3RhdHVzID0gZGF0YS5tdXRlOwogICAgfQoKICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBsb2NhbE1lZGlhU3RyZWFtKSB7CiAgICAgIGlmIChsb2NhbE1lZGlhU3RyZWFtLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICB2YXIgbG9jYWxNZWRpYSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgICAgaWYgKGxvY2FsTWVkaWEpIHsKICAgICAgICAgIHZhciBhdWRpb1RyYWNrcyA9IGxvY2FsTWVkaWEuZ2V0QXVkaW9UcmFja3MoKVswXTsKICAgICAgICAgIGlmIChzdGF0dXMgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBhdWRpb1RyYWNrcy5lbmFibGVkID0gIXN0YXR1czsKICAgICAgICAgICAgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkID0gc3RhdHVzOwoKICAgICAgICAgICAgaWYgKHN0YXR1cykgewogICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJBZ2VudCBoYXMgbXV0ZWQgdGhlIGNvbnRhY3QsIGNvbm5lY3Rpb25JZCAtICAiICsgY29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJBZ2VudCBoYXMgdW5tdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gIiArIGNvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXR1cyA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5tdXRlZCB8fCBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLAogICAgICBkYXRhOiB7IG11dGVkOiBzdGF0dXMgfQogICAgfSk7CiAgfTsKCiAgdmFyIHNldFNwZWFrZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgaWYgKGNvbm5lY3Qua2V5cyhsb2NhbE1lZGlhU3RyZWFtKS5sZW5ndGggPT09IDAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIHZhciByZW1vdGVBdWRpb0VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtb3RlLWF1ZGlvJyk7CiAgICB0cnkgewogICAgICBsb2dnZXIuaW5mbygiVHJ5aW5nIHRvIHNldCBzcGVha2VyIHRvIGRldmljZSAiICsgZGV2aWNlSWQpOwogICAgICBpZiAocmVtb3RlQXVkaW9FbGVtZW50ICYmIHR5cGVvZiByZW1vdGVBdWRpb0VsZW1lbnQuc2V0U2lua0lkID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmVtb3RlQXVkaW9FbGVtZW50LnNldFNpbmtJZChkZXZpY2VJZCk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgdG8gc2V0IHNwZWFrZXIgdG8gZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNQRUFLRVJfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgdmFyIHNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgaWYgKGNvbm5lY3Qua2V5cyhsb2NhbE1lZGlhU3RyZWFtKS5sZW5ndGggPT09IDAgIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkZXZpY2VJZCA9IGRhdGEuZGV2aWNlSWQ7CiAgICB2YXIgc29mdHBob25lTWFuYWdlciA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyKCk7CiAgICB0cnkgewogICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSh7IGF1ZGlvOiB7IGRldmljZUlkOiB7IGV4YWN0OiBkZXZpY2VJZCB9IH0gfSkKICAgICAgICAudGhlbihmdW5jdGlvbiAobmV3TWljcm9waG9uZVN0cmVhbSkgewogICAgICAgICAgdmFyIG5ld01pY3JvcGhvbmVUcmFjayA9IG5ld01pY3JvcGhvbmVTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXTsKICAgICAgICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBsb2NhbE1lZGlhU3RyZWFtKSB7CiAgICAgICAgICAgIGlmIChsb2NhbE1lZGlhU3RyZWFtLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICAgICAgICB2YXIgbG9jYWxNZWRpYSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgICAgICAgICAgdmFyIHNlc3Npb24gPSBzb2Z0cGhvbmVNYW5hZ2VyLmdldFNlc3Npb24oY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgICAvL1JlcGxhY2UgdGhlIGF1ZGlvIHRyYWNrIGluIHRoZSBSdGNQZWVyQ29ubmVjdGlvbgogICAgICAgICAgICAgIHNlc3Npb24uX3BjLmdldFNlbmRlcnMoKVswXS5yZXBsYWNlVHJhY2sobmV3TWljcm9waG9uZVRyYWNrKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vUmVwbGFjZSB0aGUgYXVkaW8gdHJhY2sgaW4gdGhlIGxvY2FsIG1lZGlhIHN0cmVhbSAoZm9yIG11dGUgLyB1bm11dGUpCiAgICAgICAgICAgICAgICBzb2Z0cGhvbmVNYW5hZ2VyLnJlcGxhY2VMb2NhbE1lZGlhVHJhY2soY29ubmVjdGlvbklkLCBuZXdNaWNyb3Bob25lVHJhY2spOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgdG8gc2V0IG1pY3JvcGhvbmUgZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLk1JQ1JPUEhPTkVfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgdmFyIHB1Ymxpc2hTb2Z0cGhvbmVGYWlsdXJlTG9ncyA9IGZ1bmN0aW9uIChydGNTZXNzaW9uLCByZWFzb24pIHsKICAgIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLklDRV9DT0xMRUNUSU9OX1RJTUVPVVQpIHsKICAgICAgdmFyIGVuZFBvaW50VXJsID0gIlxuIjsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBydGNTZXNzaW9uLl9pY2VTZXJ2ZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBydGNTZXNzaW9uLl9pY2VTZXJ2ZXJzW2ldLnVybHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGVuZFBvaW50VXJsID0gZW5kUG9pbnRVcmwgKyBydGNTZXNzaW9uLl9pY2VTZXJ2ZXJzW2ldLnVybHNbal0gKyAiXG4iOwogICAgICAgIH0KICAgICAgfQogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5JQ0VfQ09MTEVDVElPTl9USU1FT1VULCAiSWNlIGNvbGxlY3Rpb24gdGltZWRvdXQuICIsIGVuZFBvaW50VXJsKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5VU0VSX0JVU1kpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuVVNFUl9CVVNZX0VSUk9SLAogICAgICAgICJTb2Z0cGhvbmUgY2FsbCBVc2VyQnVzeSBlcnJvci4gIiwKICAgICAgICAiIik7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuU0lHTkFMTElOR19IQU5EU0hBS0VfRkFJTFVSRSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5TSUdOQUxMSU5HX0hBTkRTSEFLRV9GQUlMVVJFLAogICAgICAgICJIYW5kc2hha2luZyB3aXRoIFNpZ25hbGxpbmcgU2VydmVyICIgKyBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkgKyAiIGZhaWxlZC4gIiwKICAgICAgICBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkdVTV9USU1FT1VUX0ZBSUxVUkUgfHwgcmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5HVU1fT1RIRVJfRkFJTFVSRSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQsCiAgICAgICAgIllvdXIgbWljcm9waG9uZSBpcyBub3QgZW5hYmxlZCBpbiB5b3VyIGJyb3dzZXIuICIsCiAgICAgICAgIiIpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlNJR05BTExJTkdfQ09OTkVDVElPTl9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlNJR05BTExJTkdfQ09OTkVDVElPTl9GQUlMVVJFLAogICAgICAgICJVUkwgIiArIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSArICIgY2Fubm90IGJlIHJlYWNoZWQuICIsCiAgICAgICAgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5DQUxMX05PVF9GT1VORCkgewogICAgICAvLyBObyBuZWVkIHRvIHB1Ymxpc2ggYW55IHNvZnRwaG9uZSBlcnJvciBmb3IgdGhpcyBjYXNlLiBDQ1AgVVggd2lsbCBoYW5kbGUgdGhpcyBjYXNlLgogICAgICBsb2dnZXIuZXJyb3IoIlNvZnRwaG9uZSBjYWxsIGZhaWxlZCBkdWUgdG8gQ2FsbE5vdEZvdW5kRXhjZXB0aW9uLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9IGVsc2UgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5XRUJSVENfRVJST1IsCiAgICAgICAgIndlYnJ0YyBzeXN0ZW0gZXJyb3IuICIsCiAgICAgICAgIiIpOwogICAgfQogIH07CgogIC8qKiBQYXJzZSB0aGUgSlNPTiBlbmNvZGVkIHdlYiBjYWxsIGNvbmZpZyBpbnRvIHRoZSBkYXRhIGl0IHJlcHJlc2VudHMuICovCiAgdmFyIHBhcnNlQ2FsbENvbmZpZyA9IGZ1bmN0aW9uIChzZXJpYWxpemVkQ29uZmlnKSB7CiAgICAvLyBPdXIgdW5kZXJzY29yZSBpcyB0b28gb2xkIGZvciB1bmVzY2FwZQogICAgLy8gaHR0cHM6Ly9pc3N1ZXMuYW1hem9uLmNvbS9pc3N1ZXMvQ1NXRi0xNDY3CiAgICB2YXIgZGVjb2RlZEpTT04gPSBzZXJpYWxpemVkQ29uZmlnLnJlcGxhY2UoLyZxdW90Oy9nLCAnIicpOwogICAgcmV0dXJuIEpTT04ucGFyc2UoZGVjb2RlZEpTT04pOwogIH07CgogIHZhciBmZXRjaFVzZXJNZWRpYSA9IGZ1bmN0aW9uIChjYWxsYmFja3NJbikgewogICAgdmFyIGNhbGxiYWNrcyA9IGNhbGxiYWNrc0luIHx8IHt9OwogICAgY2FsbGJhY2tzLnN1Y2Nlc3MgPSBjYWxsYmFja3Muc3VjY2VzcyB8fCBmdW5jdGlvbiAoKSB7IH07CiAgICBjYWxsYmFja3MuZmFpbHVyZSA9IGNhbGxiYWNrcy5mYWlsdXJlIHx8IGZ1bmN0aW9uICgpIHsgfTsKCiAgICB2YXIgQ09OU1RSQUlOVCA9IHsKICAgICAgYXVkaW86IHRydWUKICAgIH07CgogICAgdmFyIHByb21pc2UgPSBudWxsOwoKICAgIGlmICh0eXBlb2YgUHJvbWlzZSAhPT0gImZ1bmN0aW9uIikgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzID09PSAib2JqZWN0IiAmJiB0eXBlb2YgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcHJvbWlzZSA9IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKENPTlNUUkFJTlQpOwoKICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhKENPTlNUUkFJTlQsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24gKHN0cmVhbSkgewogICAgICB2YXIgYXVkaW9UcmFja3MgPSBzdHJlYW0uZ2V0QXVkaW9UcmFja3MoKTsKICAgICAgaWYgKGF1ZGlvVHJhY2tzICYmIGF1ZGlvVHJhY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhzdHJlYW0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24gKGVycikgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCk7CiAgICB9KTsKICAgIHJldHVybiBwcm9taXNlOwogIH07CgogIHZhciBwdWJsaXNoRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBtZXNzYWdlLCBlbmRQb2ludFVybCkgewogICAgbG9nZ2VyLmVycm9yKCJTb2Z0cGhvbmUgZXJyb3Igb2NjdXJyZWQgOiAiLCBlcnJvclR5cGUsCiAgICAgIG1lc3NhZ2UgfHwgIiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsCiAgICAgIGRhdGE6IG5ldyBjb25uZWN0LlNvZnRwaG9uZUVycm9yKGVycm9yVHlwZSwgbWVzc2FnZSwgZW5kUG9pbnRVcmwpCiAgICB9KTsKICB9OwoKICB2YXIgcHVibGlzaFNlc3Npb25GYWlsdXJlVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoY29udGFjdElkLCByZWFzb24pIHsKICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gRmFpbGVkIiwgY29udGFjdElkLCB7CiAgICAgIGZhaWxlZFJlYXNvbjogcmVhc29uCiAgICB9KTsKICB9OwoKICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkLCBkYXRhKSB7CiAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgIGNvbnRhY3RJZDogY29udGFjdElkLAogICAgICBkYXRhOiBkYXRhCiAgICB9KTsKICB9OwoKICAvLyBQdWJsaXNoIHRoZSBjb250YWN0IGFuZCBhZ2VudCBpbmZvcm1hdGlvbiBpbiBhIG11bHRpcGxlIHNlc3Npb25zIHNjZW5hcmlvcwogIHZhciBwdWJsaXNoTXVsdGlwbGVTZXNzaW9uc0V2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkLCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KGV2ZW50TmFtZSwgY29udGFjdElkLCBbewogICAgICBuYW1lOiAiQWdlbnRDb25uZWN0aW9uSWQiLAogICAgICB2YWx1ZTogYWdlbnRDb25uZWN0aW9uSWQKICAgIH1dKTsKICAgIGxvZ2dlci5pbmZvKCJQdWJsaXNoIG11bHRpcGxlIHNlc3Npb24gZXJyb3IgbWV0cmljcyIsIGV2ZW50TmFtZSwgImNvbnRhY3RJZCAiICsgY29udGFjdElkLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkKICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgfTsKCiAgdmFyIGlzQnJvd3NlclNvZnRQaG9uZVN1cHBvcnRlZCA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIEluIE9wZXJhLCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJPcGVyYSIgb3IgYWZ0ZXIgIlZlcnNpb24iCiAgICBpZiAoY29ubmVjdC5pc09wZXJhQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0T3BlcmFCcm93c2VyVmVyc2lvbigpID4gMTcpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBJbiBDaHJvbWUsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIkNocm9tZSIKICAgIGVsc2UgaWYgKGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbigpID4gMjIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBJbiBGaXJlZm94LCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJGaXJlZm94IgogICAgZWxzZSBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRGaXJlZm94QnJvd3NlclZlcnNpb24oKSA+IDIxKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH07CgogIHZhciBzZW5kU29mdHBob25lTWV0cmljcyA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc3RyZWFtU3RhdHMgPSB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIuc2xpY2UoKTsKICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogICAgaWYgKHN0cmVhbVN0YXRzLmxlbmd0aCA+IDApIHsKICAgICAgY29udGFjdC5zZW5kU29mdHBob25lTWV0cmljcyhzdHJlYW1TdGF0cywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKCJzZW5kU29mdHBob25lTWV0cmljcyBzdWNjZXNzIiArIEpTT04uc3RyaW5naWZ5KHN0cmVhbVN0YXRzKSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgbG9nZ2VyLmVycm9yKCJzZW5kU29mdHBob25lTWV0cmljcyBmYWlsZWQuIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICB2YXIgc2VuZFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uIChjb250YWN0LCByZXBvcnQsIHVzZXJBdWRpb1N0YXRzLCByZW1vdGVBdWRpb1N0YXRzKSB7CiAgICByZXBvcnQuc3RyZWFtU3RhdHMgPSBbYWRkU3RyZWFtVHlwZVRvU3RhdHModXNlckF1ZGlvU3RhdHMsIEFVRElPX0lOUFVUKSwKICAgIGFkZFN0cmVhbVR5cGVUb1N0YXRzKHJlbW90ZUF1ZGlvU3RhdHMsIEFVRElPX09VVFBVVCldOwogICAgdmFyIGNhbGxSZXBvcnQgPSB7CiAgICAgIGNhbGxTdGFydFRpbWU6IHJlcG9ydC5zZXNzaW9uU3RhcnRUaW1lLAogICAgICBjYWxsRW5kVGltZTogcmVwb3J0LnNlc3Npb25FbmRUaW1lLAogICAgICBndW1UaW1lTWlsbGlzOiByZXBvcnQuZ3VtVGltZU1pbGxpcywKICAgICAgaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzOiByZXBvcnQuaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzLAogICAgICBpY2VDb2xsZWN0aW9uVGltZU1pbGxpczogcmVwb3J0LmljZUNvbGxlY3Rpb25UaW1lTWlsbGlzLAogICAgICBzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXM6IHJlcG9ydC5zaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMsCiAgICAgIGhhbmRzaGFraW5nVGltZU1pbGxpczogcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpcywKICAgICAgcHJlVGFsa2luZ1RpbWVNaWxsaXM6IHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpcywKICAgICAgdGFsa2luZ1RpbWVNaWxsaXM6IHJlcG9ydC50YWxraW5nVGltZU1pbGxpcywKICAgICAgY2xlYW51cFRpbWVNaWxsaXM6IHJlcG9ydC5jbGVhbnVwVGltZU1pbGxpcywKICAgICAgaWNlQ29sbGVjdGlvbkZhaWx1cmU6IHJlcG9ydC5pY2VDb2xsZWN0aW9uRmFpbHVyZSwKICAgICAgc2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlOiByZXBvcnQuc2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlLAogICAgICBoYW5kc2hha2luZ0ZhaWx1cmU6IHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmUsCiAgICAgIGd1bU90aGVyRmFpbHVyZTogcmVwb3J0Lmd1bU90aGVyRmFpbHVyZSwKICAgICAgZ3VtVGltZW91dEZhaWx1cmU6IHJlcG9ydC5ndW1UaW1lb3V0RmFpbHVyZSwKICAgICAgY3JlYXRlT2ZmZXJGYWlsdXJlOiByZXBvcnQuY3JlYXRlT2ZmZXJGYWlsdXJlLAogICAgICBzZXRMb2NhbERlc2NyaXB0aW9uRmFpbHVyZTogcmVwb3J0LnNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlLAogICAgICB1c2VyQnVzeUZhaWx1cmU6IHJlcG9ydC51c2VyQnVzeUZhaWx1cmUsCiAgICAgIGludmFsaWRSZW1vdGVTRFBGYWlsdXJlOiByZXBvcnQuaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUsCiAgICAgIG5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZTogcmVwb3J0Lm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSwKICAgICAgc2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlOiByZXBvcnQuc2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlLAogICAgICBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzOiByZXBvcnQuc3RyZWFtU3RhdHMKICAgIH07CiAgICBjb250YWN0LnNlbmRTb2Z0cGhvbmVSZXBvcnQoY2FsbFJlcG9ydCwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oInNlbmRTb2Z0cGhvbmVSZXBvcnQgc3VjY2VzcyIgKyBKU09OLnN0cmluZ2lmeShjYWxsUmVwb3J0KSkKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5lcnJvcigic2VuZFNvZnRwaG9uZVJlcG9ydCBmYWlsZWQuIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgdmFyIHN0YXJ0U3RhdHNDb2xsZWN0aW9uSm9iID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgIHJ0cFN0YXRzSm9iID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgcnRjU2Vzc2lvbi5nZXRVc2VyQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzVXNlclN0YXRzID0gYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzOwogICAgICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMsIHByZXZpb3VzVXNlclN0YXRzLCBBVURJT19JTlBVVCkpOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBsb2dnZXIuZGVidWcoIkZhaWxlZCB0byBnZXQgdXNlciBhdWRpbyBzdGF0cy4iLCBlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CiAgICAgIHJ0Y1Nlc3Npb24uZ2V0UmVtb3RlQXVkaW9TdGF0cygpLnRoZW4oZnVuY3Rpb24gKHN0YXRzKSB7CiAgICAgICAgdmFyIHByZXZpb3VzUmVtb3RlU3RhdHMgPSBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0czsKICAgICAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IHN0YXRzOwogICAgICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5wdXNoKGdldFRpbWVTZXJpZXNTdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgcHJldmlvdXNSZW1vdGVTdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCByZW1vdGUgYXVkaW8gc3RhdHMuIiwgZXJyb3IpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwogICAgfSwgMTAwMCk7CiAgfTsKCiAgdmFyIHN0YXJ0U3RhdHNSZXBvcnRpbmdKb2IgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgcmVwb3J0U3RhdHNKb2IgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICBzZW5kU29mdHBob25lTWV0cmljcyhjb250YWN0KTsKICAgIH0sIHN0YXRzUmVwb3J0aW5nSm9iSW50ZXJ2YWxNcyk7CiAgfTsKCiAgdmFyIGluaXRpYWxpemVQYXJhbXMgPSBmdW5jdGlvbiAoKSB7CiAgICBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSBudWxsOwogICAgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSBudWxsOwogICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgICBydHBTdGF0c0pvYiA9IG51bGw7CiAgICByZXBvcnRTdGF0c0pvYiA9IG51bGw7CiAgfTsKCiAgdmFyIGdldFRpbWVTZXJpZXNTdGF0cyA9IGZ1bmN0aW9uIChjdXJyZW50U3RhdHMsIHByZXZpb3VzU3RhdHMsIHN0cmVhbVR5cGUpIHsKICAgIGlmIChwcmV2aW91c1N0YXRzICYmIGN1cnJlbnRTdGF0cykgewogICAgICB2YXIgcGFja2V0c0xvc3QgPSBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QgPiBwcmV2aW91c1N0YXRzLnBhY2tldHNMb3N0ID8gY3VycmVudFN0YXRzLnBhY2tldHNMb3N0IC0gcHJldmlvdXNTdGF0cy5wYWNrZXRzTG9zdCA6IDA7CiAgICAgIHZhciBwYWNrZXRzQ291bnQgPSBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50ID4gcHJldmlvdXNTdGF0cy5wYWNrZXRzQ291bnQgPyBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50IC0gcHJldmlvdXNTdGF0cy5wYWNrZXRzQ291bnQgOiAwOwogICAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKGN1cnJlbnRTdGF0cy50aW1lc3RhbXAsCiAgICAgICAgcGFja2V0c0xvc3QsCiAgICAgICAgcGFja2V0c0NvdW50LAogICAgICAgIHN0cmVhbVR5cGUsCiAgICAgICAgY3VycmVudFN0YXRzLmF1ZGlvTGV2ZWwsCiAgICAgICAgY3VycmVudFN0YXRzLmpiTWlsbGlzZWNvbmRzLAogICAgICAgIGN1cnJlbnRTdGF0cy5ydHRNaWxsaXNlY29uZHMpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhjdXJyZW50U3RhdHMudGltZXN0YW1wLAogICAgICAgIGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCwKICAgICAgICBjdXJyZW50U3RhdHMucGFja2V0c0NvdW50LAogICAgICAgIHN0cmVhbVR5cGUsCiAgICAgICAgY3VycmVudFN0YXRzLmF1ZGlvTGV2ZWwsCiAgICAgICAgY3VycmVudFN0YXRzLmpiTWlsbGlzZWNvbmRzLAogICAgICAgIGN1cnJlbnRTdGF0cy5ydHRNaWxsaXNlY29uZHMpOwogICAgfQogIH07CgogIHZhciBzdG9wSm9iID0gZnVuY3Rpb24gKHRhc2spIHsKICAgIGlmICh0YXNrICE9PSBudWxsKSB7CiAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRhc2spOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgdmFyIHN0b3BKb2JzQW5kUmVwb3J0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIHNlc3Npb25SZXBvcnQpIHsKICAgIHJ0cFN0YXRzSm9iID0gc3RvcEpvYihydHBTdGF0c0pvYik7CiAgICByZXBvcnRTdGF0c0pvYiA9IHN0b3BKb2IocmVwb3J0U3RhdHNKb2IpOwogICAgc2VuZFNvZnRwaG9uZVJlcG9ydChjb250YWN0LCBzZXNzaW9uUmVwb3J0LCBhZGRTdHJlYW1UeXBlVG9TdGF0cyhhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMsIEFVRElPX0lOUFVUKSwgYWRkU3RyZWFtVHlwZVRvU3RhdHMoYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMsIEFVRElPX09VVFBVVCkpOwogICAgc2VuZFNvZnRwaG9uZU1ldHJpY3MoY29udGFjdCk7CiAgfTsKCiAgLyoqCiAgKiAgIEFkZGluZyBzdHJlYW10eXBlIHBhcmFtZXRlciBvbiB0b3Agb2YgUlRDSlMgUlRTdGF0cyBvYmplY3QuCiAgKi8KICB2YXIgUlRQU3RyZWFtU3RhdHMgPSBmdW5jdGlvbiAodGltZXN0YW1wLCBwYWNrZXRzTG9zdCwgcGFja2V0c0NvdW50LCBzdHJlYW1UeXBlLCBhdWRpb0xldmVsLCBqaXR0ZXJCdWZmZXJNaWxsaXMsIHJvdW5kVHJpcFRpbWVNaWxsaXMpIHsKICAgIHRoaXMuc29mdHBob25lU3RyZWFtVHlwZSA9IHN0cmVhbVR5cGU7CiAgICB0aGlzLnRpbWVzdGFtcCA9IHRpbWVzdGFtcDsKICAgIHRoaXMucGFja2V0c0xvc3QgPSBwYWNrZXRzTG9zdDsKICAgIHRoaXMucGFja2V0c0NvdW50ID0gcGFja2V0c0NvdW50OwogICAgdGhpcy5hdWRpb0xldmVsID0gYXVkaW9MZXZlbDsKICAgIHRoaXMuaml0dGVyQnVmZmVyTWlsbGlzID0gaml0dGVyQnVmZmVyTWlsbGlzOwogICAgdGhpcy5yb3VuZFRyaXBUaW1lTWlsbGlzID0gcm91bmRUcmlwVGltZU1pbGxpczsKICB9OwoKICB2YXIgYWRkU3RyZWFtVHlwZVRvU3RhdHMgPSBmdW5jdGlvbiAoc3RhdHMsIHN0cmVhbVR5cGUpIHsKICAgIHN0YXRzID0gc3RhdHMgfHwge307CiAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKHN0YXRzLnRpbWVzdGFtcCwgc3RhdHMucGFja2V0c0xvc3QsIHN0YXRzLnBhY2tldHNDb3VudCwgc3RyZWFtVHlwZSwgc3RhdHMuYXVkaW9MZXZlbCk7CiAgfTsKCiAgdmFyIFNvZnRwaG9uZUxvZ2dlciA9IGZ1bmN0aW9uIChsb2dnZXIpIHsKICAgIHRoaXMuX29yaWdpbmFsTG9nZ2VyID0gbG9nZ2VyOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdGhpcy5fdGVlID0gZnVuY3Rpb24gKGxldmVsLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBjYWxsIHRoZSBvcmlnaW5hbCBsb2dnZXIgb2JqZWN0IHRvIG91dHB1dCB0byBicm93c2VyCiAgICAgICAgLy9Db25uZWN0IGxvZ2dlciBmb2xsb3dzICVzIGZvcm1hdCB0byBwcmludCBvYmplY3RzIHRvIGNvbnNvbGUuCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHNbMF0pOwogICAgICAgIHZhciBmb3JtYXQgPSAiIjsKICAgICAgICBhcmdzLmZvckVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgZm9ybWF0ID0gZm9ybWF0ICsgIiAlcyI7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseShzZWxmLl9vcmlnaW5hbExvZ2dlciwgW2Nvbm5lY3QuTG9nQ29tcG9uZW50LlNPRlRQSE9ORSwgZm9ybWF0XS5jb25jYXQoYXJncykpOwogICAgICB9OwogICAgfTsKICB9OwoKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgxLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5kZWJ1ZykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuaW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoMiwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuaW5mbykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgzLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5sb2cpKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLndhcm4gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDQsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLndhcm4pKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSg1LCB0aGlzLl9vcmlnaW5hbExvZ2dlci5lcnJvcikoYXJndW1lbnRzKTsKICB9OwoKICBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIgPSBTb2Z0cGhvbmVNYW5hZ2VyOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTQ0OgovKioqLyAoKCkgPT4gewoKLyohIEBsaWNlbnNlIHNwcmludGYuanMgfCBDb3B5cmlnaHQgKGMpIDIwMDctMjAxMyBBbGV4YW5kcnUgTWFyYXN0ZWFudSA8aGVsbG8gYXQgYWxleGVpIGRvdCBybz4gfCAzIGNsYXVzZSBCU0QgbGljZW5zZSAqLwoKKGZ1bmN0aW9uKCkgewogICB2YXIgY3R4ID0gdGhpczsKCgl2YXIgc3ByaW50ZiA9IGZ1bmN0aW9uKCkgewoJCWlmICghc3ByaW50Zi5jYWNoZS5oYXNPd25Qcm9wZXJ0eShhcmd1bWVudHNbMF0pKSB7CgkJCXNwcmludGYuY2FjaGVbYXJndW1lbnRzWzBdXSA9IHNwcmludGYucGFyc2UoYXJndW1lbnRzWzBdKTsKCQl9CgkJcmV0dXJuIHNwcmludGYuZm9ybWF0LmNhbGwobnVsbCwgc3ByaW50Zi5jYWNoZVthcmd1bWVudHNbMF1dLCBhcmd1bWVudHMpOwoJfTsKCglzcHJpbnRmLmZvcm1hdCA9IGZ1bmN0aW9uKHBhcnNlX3RyZWUsIGFyZ3YpIHsKCQl2YXIgY3Vyc29yID0gMSwgdHJlZV9sZW5ndGggPSBwYXJzZV90cmVlLmxlbmd0aCwgbm9kZV90eXBlID0gJycsIGFyZywgb3V0cHV0ID0gW10sIGksIGssIG1hdGNoLCBwYWQsIHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGg7CgkJZm9yIChpID0gMDsgaSA8IHRyZWVfbGVuZ3RoOyBpKyspIHsKCQkJbm9kZV90eXBlID0gZ2V0X3R5cGUocGFyc2VfdHJlZVtpXSk7CgkJCWlmIChub2RlX3R5cGUgPT09ICdzdHJpbmcnKSB7CgkJCQlvdXRwdXQucHVzaChwYXJzZV90cmVlW2ldKTsKCQkJfQoJCQllbHNlIGlmIChub2RlX3R5cGUgPT09ICdhcnJheScpIHsKCQkJCW1hdGNoID0gcGFyc2VfdHJlZVtpXTsgLy8gY29udmVuaWVuY2UgcHVycG9zZXMgb25seQoJCQkJaWYgKG1hdGNoWzJdKSB7IC8vIGtleXdvcmQgYXJndW1lbnQKCQkJCQlhcmcgPSBhcmd2W2N1cnNvcl07CgkJCQkJZm9yIChrID0gMDsgayA8IG1hdGNoWzJdLmxlbmd0aDsgaysrKSB7CgkJCQkJCWlmICghYXJnLmhhc093blByb3BlcnR5KG1hdGNoWzJdW2tdKSkgewoJCQkJCQkJdGhyb3coc3ByaW50ZignW3NwcmludGZdIHByb3BlcnR5ICIlcyIgZG9lcyBub3QgZXhpc3QnLCBtYXRjaFsyXVtrXSkpOwoJCQkJCQl9CgkJCQkJCWFyZyA9IGFyZ1ttYXRjaFsyXVtrXV07CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSBpZiAobWF0Y2hbMV0pIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoZXhwbGljaXQpCgkJCQkJYXJnID0gYXJndlttYXRjaFsxXV07CgkJCQl9CgkJCQllbHNlIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoaW1wbGljaXQpCgkJCQkJYXJnID0gYXJndltjdXJzb3IrK107CgkJCQl9CgoJCQkJaWYgKC9bXnNdLy50ZXN0KG1hdGNoWzhdKSAmJiAoZ2V0X3R5cGUoYXJnKSAhPSAnbnVtYmVyJykpIHsKCQkJCQl0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJXMnLCBnZXRfdHlwZShhcmcpKSk7CgkJCQl9CgkJCQlzd2l0Y2ggKG1hdGNoWzhdKSB7CgkJCQkJY2FzZSAnYic6IGFyZyA9IGFyZy50b1N0cmluZygyKTsgYnJlYWs7CgkJCQkJY2FzZSAnYyc6IGFyZyA9IFN0cmluZy5mcm9tQ2hhckNvZGUoYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAnZCc6IGFyZyA9IHBhcnNlSW50KGFyZywgMTApOyBicmVhazsKCQkJCQljYXNlICdlJzogYXJnID0gbWF0Y2hbN10gPyBhcmcudG9FeHBvbmVudGlhbChtYXRjaFs3XSkgOiBhcmcudG9FeHBvbmVudGlhbCgpOyBicmVhazsKCQkJCQljYXNlICdmJzogYXJnID0gbWF0Y2hbN10gPyBwYXJzZUZsb2F0KGFyZykudG9GaXhlZChtYXRjaFs3XSkgOiBwYXJzZUZsb2F0KGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ28nOiBhcmcgPSBhcmcudG9TdHJpbmcoOCk7IGJyZWFrOwoJCQkJCWNhc2UgJ3MnOiBhcmcgPSAoKGFyZyA9IFN0cmluZyhhcmcpKSAmJiBtYXRjaFs3XSA/IGFyZy5zdWJzdHJpbmcoMCwgbWF0Y2hbN10pIDogYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAndSc6IGFyZyA9IGFyZyA+Pj4gMDsgYnJlYWs7CgkJCQkJY2FzZSAneCc6IGFyZyA9IGFyZy50b1N0cmluZygxNik7IGJyZWFrOwoJCQkJCWNhc2UgJ1gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7IGJyZWFrOwoJCQkJfQoJCQkJYXJnID0gKC9bZGVmXS8udGVzdChtYXRjaFs4XSkgJiYgbWF0Y2hbM10gJiYgYXJnID49IDAgPyAnKycrIGFyZyA6IGFyZyk7CgkJCQlwYWRfY2hhcmFjdGVyID0gbWF0Y2hbNF0gPyBtYXRjaFs0XSA9PSAnMCcgPyAnMCcgOiBtYXRjaFs0XS5jaGFyQXQoMSkgOiAnICc7CgkJCQlwYWRfbGVuZ3RoID0gbWF0Y2hbNl0gLSBTdHJpbmcoYXJnKS5sZW5ndGg7CgkJCQlwYWQgPSBtYXRjaFs2XSA/IHN0cl9yZXBlYXQocGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aCkgOiAnJzsKCQkJCW91dHB1dC5wdXNoKG1hdGNoWzVdID8gYXJnICsgcGFkIDogcGFkICsgYXJnKTsKCQkJfQoJCX0KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfTsKCglzcHJpbnRmLmNhY2hlID0ge307CgoJc3ByaW50Zi5wYXJzZSA9IGZ1bmN0aW9uKGZtdCkgewoJCXZhciBfZm10ID0gZm10LCBtYXRjaCA9IFtdLCBwYXJzZV90cmVlID0gW10sIGFyZ19uYW1lcyA9IDA7CgkJd2hpbGUgKF9mbXQpIHsKCQkJaWYgKChtYXRjaCA9IC9eW15ceDI1XSsvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlwYXJzZV90cmVlLnB1c2gobWF0Y2hbMF0pOwoJCQl9CgkJCWVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNXsyfS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCXBhcnNlX3RyZWUucHVzaCgnJScpOwoJCQl9CgkJCWVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXlwpXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZm9zdXhYXSkvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlpZiAobWF0Y2hbMl0pIHsKCQkJCQlhcmdfbmFtZXMgfD0gMTsKCQkJCQl2YXIgZmllbGRfbGlzdCA9IFtdLCByZXBsYWNlbWVudF9maWVsZCA9IG1hdGNoWzJdLCBmaWVsZF9tYXRjaCA9IFtdOwoJCQkJCWlmICgoZmllbGRfbWF0Y2ggPSAvXihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCXdoaWxlICgocmVwbGFjZW1lbnRfZmllbGQgPSByZXBsYWNlbWVudF9maWVsZC5zdWJzdHJpbmcoZmllbGRfbWF0Y2hbMF0ubGVuZ3RoKSkgIT09ICcnKSB7CgkJCQkJCQlpZiAoKGZpZWxkX21hdGNoID0gL15cLihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgaWYgKChmaWVsZF9tYXRjaCA9IC9eXFsoXGQrKVxdLy5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSB7CgkJCQkJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQkJCX0KCQkJCQltYXRjaFsyXSA9IGZpZWxkX2xpc3Q7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlhcmdfbmFtZXMgfD0gMjsKCQkJCX0KCQkJCWlmIChhcmdfbmFtZXMgPT09IDMpIHsKCQkJCQl0aHJvdygnW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCcpOwoJCQkJfQoJCQkJcGFyc2VfdHJlZS5wdXNoKG1hdGNoKTsKCQkJfQoJCQllbHNlIHsKCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQl9CgkJCV9mbXQgPSBfZm10LnN1YnN0cmluZyhtYXRjaFswXS5sZW5ndGgpOwoJCX0KCQlyZXR1cm4gcGFyc2VfdHJlZTsKCX07CgoJdmFyIHZzcHJpbnRmID0gZnVuY3Rpb24oZm10LCBhcmd2LCBfYXJndikgewoJCV9hcmd2ID0gYXJndi5zbGljZSgwKTsKCQlfYXJndi5zcGxpY2UoMCwgMCwgZm10KTsKCQlyZXR1cm4gc3ByaW50Zi5hcHBseShudWxsLCBfYXJndik7Cgl9OwoKCS8qKgoJICogaGVscGVycwoJICovCglmdW5jdGlvbiBnZXRfdHlwZSh2YXJpYWJsZSkgewoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFyaWFibGUpLnNsaWNlKDgsIC0xKS50b0xvd2VyQ2FzZSgpOwoJfQoKCWZ1bmN0aW9uIHN0cl9yZXBlYXQoaW5wdXQsIG11bHRpcGxpZXIpIHsKCQlmb3IgKHZhciBvdXRwdXQgPSBbXTsgbXVsdGlwbGllciA+IDA7IG91dHB1dFstLW11bHRpcGxpZXJdID0gaW5wdXQpIHsvKiBkbyBub3RoaW5nICovfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9CgoJLyoqCgkgKiBleHBvcnQgdG8gZWl0aGVyIGJyb3dzZXIgb3Igbm9kZS5qcwoJICovCgljdHguc3ByaW50ZiA9IHNwcmludGY7CgljdHgudnNwcmludGYgPSB2c3ByaW50ZjsKfSkoKTsKCgoKLyoqKi8gfSksCgovKioqLyA4MjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgU3RyZWFtCiAgICAqCiAgICAqIFJlcHJlc2VudHMgYW4gb2JqZWN0IGZyb20gd2hpY2ggbWVzc2FnZXMgY2FuIGJlIHJlYWQgYW5kIHRvIHdoaWNoCiAgICAqIG1lc3NhZ2VzIGNhbiBiZSBzZW50LgogICAgKi8KICAgdmFyIFN0cmVhbSA9IGZ1bmN0aW9uKCkge307CgogICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gdGhlIHN0cmVhbS4gIFRoaXMgbWV0aG9kIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3Nlcy4KICAgICovCiAgIFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqCiAgICAqIFByb3ZpZGUgYSBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gbWVzc2FnZXMgYXJlIHJlY2VpdmVkIGZyb20gdGhpcyBzdHJlYW0uCiAgICAqIFRoaXMgbWV0aG9kIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3Nlcy4KICAgICovCiAgIFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgTnVsbFN0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIG51bGwgc3RyZWFtIHdoaWNoIHByb3ZpZGVzIG5vIG1lc3NhZ2Ugc2VuZGluZyBvciByZWNlaXZpbmcgZmFjaWxpdGllcy4KICAgICovCiAgIHZhciBOdWxsU3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICB9OwogICBOdWxsU3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTnVsbFN0cmVhbTsKCiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHt9OwogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkge307CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgV2luZG93U3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIGZvciBjb21tdW5pY2F0aW5nIHdpdGggYSB3aW5kb3cgb2JqZWN0LiAgVGhlIGRvbWFpbiBwcm92aWRlZAogICAgKiBtdXN0IG1hdGNoIHRoZSBhbGxvd2VkIG1lc3NhZ2UgZG9tYWlucyBvZiB0aGUgZG93bnN0cmVhbSByZWNlaXZlcgogICAgKiBvciBtZXNzYWdlcyB3aWxsIGJlIHJlamVjdGVkLCBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dpbmRvdy9wb3N0TWVzc2FnZQogICAgKiBmb3IgbW9yZSBpbmZvLgogICAgKi8KICAgdmFyIFdpbmRvd1N0cmVhbSA9IGZ1bmN0aW9uKHdpbiwgZG9tYWluKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLndpbmRvdyA9IHdpbjsKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gfHwgJyonOwogICB9OwogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdpbmRvd1N0cmVhbTsKCiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy53aW5kb3cucG9zdE1lc3NhZ2UobWVzc2FnZSwgdGhpcy5kb21haW4pOwogICB9OwoKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBXaW5kb3dJT1N0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSB1c2VkIGJ5IElGcmFtZS9wb3B1cCB3aW5kb3dzIHRvIGNvbW11bmljYXRlIHdpdGggdGhlaXIgcGFyZW50cwogICAgKiBhbmQgdmlzZSB2ZXJzYS4KICAgICoKICAgICogVGhpcyBvYmplY3QgZW5jYXBzdWxhdGVzIHRoZSBmYWN0IHRoYXQgaW5jb21pbmcgYW5kIG91dGdvaW5nIG1lc3NhZ2VzCiAgICAqIGFycml2ZSBvbiBkaWZmZXJlbnQgd2luZG93cyBhbmQgYWxsb3dzIHRoaXMgdG8gYmUgbWFuYWdlZCBhcyBhIHNpbmdsZQogICAgKiBTdHJlYW0gb2JqZWN0LgogICAgKi8KICAgdmFyIFdpbmRvd0lPU3RyZWFtID0gZnVuY3Rpb24oaW5wdXR3aW4sIG91dHB1dHdpbiwgZG9tYWluKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLmlucHV0ID0gaW5wdXR3aW47CiAgICAgIHRoaXMub3V0cHV0ID0gb3V0cHV0d2luOwogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiB8fCAnKic7CiAgIH07CiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdpbmRvd0lPU3RyZWFtOwoKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMub3V0cHV0LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRoaXMuZG9tYWluKTsKICAgfTsKCiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMuaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIChtZXNzYWdlKSA9PiB7CiAgICAgICAgIGlmIChtZXNzYWdlLnNvdXJjZSA9PT0gdGhpcy5vdXRwdXQpIHsKICAgICAgICAgICAgZihtZXNzYWdlKTsKICAgICAgICAgfQogICAgICB9KTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBQb3J0U3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIHdyYXBwaW5nIGFuIEhUTUw1IFdvcmtlciBwb3J0LiAgVGhpcyBjb3VsZCBiZSB0aGUgcG9ydAogICAgKiB1c2VkIHRvIGNvbm5lY3QgdG8gYSBXb3JrZXIgb3Igb25lIG9mIHRoZSBtdWx0aXR1ZGUgb2YgcG9ydHMKICAgICogbWFkZSBhdmFpbGFibGUgdG8gYSBTaGFyZWRXb3JrZXIgZm9yIGNvbW11bmljYXRpb24gYmFjayB0bwogICAgKiBpdHMgY29ubmVjdGVkIGNsaWVudHMuCiAgICAqLwogICB2YXIgUG9ydFN0cmVhbSA9IGZ1bmN0aW9uKHBvcnQpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMucG9ydCA9IHBvcnQ7CiAgICAgIHRoaXMuaWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CiAgIH07CiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQb3J0U3RyZWFtOwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKG1lc3NhZ2UpOwogICB9OwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLnBvcnQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuZ2V0SWQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaWQ7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgU3RyZWFtTXVsdGlwbGV4ZXIgZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSB3cmFwcGVyIGZvciBtdWx0aXBsZXhlZCBkb3duc3RyZWFtIGNvbW11bmljYXRpb24gd2l0aAogICAgKiBtdWx0aXBsZSBzdHJlYW1zIGF0IG9uY2UuICBNYWlubHkgdXNlZnVsIGZvciB0aGUgU2hhcmVkV29ya2VyIHRvCiAgICAqIGJyb2FkY2FzdCBldmVudHMgdG8gbWFueSBQb3J0U3RyZWFtIG9iamVjdHMgYXQgb25jZS4KICAgICovCiAgIHZhciBTdHJlYW1NdWx0aXBsZXhlciA9IGZ1bmN0aW9uKHN0cmVhbXMpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuc3RyZWFtTWFwID0gc3RyZWFtcyA/CiAgICAgICAgIGNvbm5lY3QuaW5kZXgoc3RyZWFtcywgZnVuY3Rpb24ocykgeyByZXR1cm4gcy5nZXRJZCgpOyB9KSA6IHt9OwogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMgPSBbXTsKICAgfTsKICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3RyZWFtTXVsdGlwbGV4ZXI7CgogICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gYWxsIHBvcnRzIGluIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLmdldFN0cmVhbXMoKS5mb3JFYWNoKGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICB0cnkgewogICAgICAgICAgICBzdHJlYW0uc2VuZChtZXNzYWdlKTsKCiAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gQ291bGRuJ3Qgc2VuZCBtZXNzYWdlIHRvIG9uZSBvZiB0aGUgZG93bnN0cmVhbXMgZm9yIHNvbWUgcmVhc29uLi4uCiAgICAgICAgICAgIC8vIE5vIHJlbGlhYmxlIGxvZ2dpbmcgcG9zc2libGUgd2l0aG91dCBmdXJ0aGVyIGZhaWx1cmVzLAogICAgICAgICAgICAvLyBubyByZWNvdmVyeSwganVzdCBlYXQgaXQuCiAgICAgICAgIH0KICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogUmVnaXN0ZXIgYSBtZXRob2Qgd2hpY2ggd2lsbCBiZSBjYWxsZWQgd2hlbiBhIG1lc3NhZ2UgaXMgcmVjZWl2ZWQgZnJvbQogICAgKiBhbnkgb2YgdGhlIGRvd25zdHJlYW1zLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzLnB1c2goZik7CgogICAgICAvLyBVcGRhdGUgZXhpc3Rpbmcgc3RyZWFtcyB3aXRoIHRoZSBuZXcgbGlzdGVuZXIuCiAgICAgIHRoaXMuZ2V0U3RyZWFtcygpLmZvckVhY2goZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgIHN0cmVhbS5vbk1lc3NhZ2UoZik7CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIEFkZCBhIHN0cmVhbSB0byB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuYWRkU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdGhpcy5zdHJlYW1NYXBbc3RyZWFtLmdldElkKCldID0gc3RyZWFtOwoKICAgICAgLy8gVXBkYXRlIHN0cmVhbSB3aXRoIGV4aXN0aW5nIGxpc3RlbmVycy4KICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obWVzc2FnZUxpc3RlbmVyKSB7CiAgICAgICAgIHN0cmVhbS5vbk1lc3NhZ2UobWVzc2FnZUxpc3RlbmVyKTsKICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogUmVtb3ZlIHRoZSBnaXZlbiBkb3duc3RyZWFtLiAgVGhpcyBpcyB0eXBpY2FsbHkgdXNlZCBpbiByZXNwb25zZQogICAgKiB0byB0aGUgU2hhcmVkV29ya2VyJ3Mgb25jbG9zZSBldmVudCwgaW5kaWNhdGluZyB0aGF0IGEgY29uc3VtZXIKICAgICogdGFiIGhhcyBiZWVuIGNsb3NlZC4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5yZW1vdmVTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgZGVsZXRlIHRoaXMuc3RyZWFtTWFwW3N0cmVhbS5nZXRJZCgpXTsKICAgfTsKCiAgIC8qKgogICAgKiBHZXQgYSBsaXN0IG9mIHN0cmVhbXMgaW4gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmdldFN0cmVhbXMgPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgcmV0dXJuIGNvbm5lY3QudmFsdWVzKHRoaXMuc3RyZWFtTWFwKTsKICAgfTsKCiAgIC8qKgogICAgKiBHZXQgdGhlIHN0cmVhbSBtYXRjaGluZyB0aGUgZ2l2ZW4gcG9ydC4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5nZXRTdHJlYW1Gb3JQb3J0ID0gZnVuY3Rpb24ocG9ydCkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0U3RyZWFtcygpLCBmdW5jdGlvbihzKSB7CiAgICAgICAgIHJldHVybiBzLnBvcnQgPT09IHBvcnQ7CiAgICAgIH0pOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIENvbmR1aXQKICAgICoKICAgICogQW4gb2JqZWN0IHdoaWNoIGJyaWRnZXMgYW4gdXBzdHJlYW0gYW5kIGEgZG93bnN0cmVhbSwgYWxsb3dpbmcgbWVzc2FnZXMKICAgICogdG8gYmUgcGFzc2VkIHRvIGFuZCBmcm9tIGVhY2ggYW5kIHByb3ZpZGluZyBhbiBldmVudCBidXMgZm9yIGV2ZW50CiAgICAqIHN1YnNjcmlwdGlvbnMgdG8gYmUgbWFkZSB1cHN0cmVhbSBhbmQgZG93bnN0cmVhbS4KICAgICovCiAgIHZhciBDb25kdWl0ID0gZnVuY3Rpb24obmFtZSwgdXBzdHJlYW0sIGRvd25zdHJlYW0pIHsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy51cHN0cmVhbSA9IHVwc3RyZWFtIHx8IG5ldyBOdWxsU3RyZWFtKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbSA9IGRvd25zdHJlYW0gfHwgbmV3IE51bGxTdHJlYW0oKTsKICAgICAgdGhpcy5kb3duc3RyZWFtQnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgICAgdGhpcy51cHN0cmVhbUJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CgogICAgICB0aGlzLnVwc3RyZWFtLm9uTWVzc2FnZShjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2Rpc3BhdGNoRXZlbnQsIHRoaXMudXBzdHJlYW1CdXMpKTsKICAgICAgdGhpcy5kb3duc3RyZWFtLm9uTWVzc2FnZShjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2Rpc3BhdGNoRXZlbnQsIHRoaXMuZG93bnN0cmVhbUJ1cykpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25VcHN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMudXBzdHJlYW1CdXMuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkFsbFVwc3RyZWFtID0gZnVuY3Rpb24oZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLnVwc3RyZWFtQnVzLnN1YnNjcmliZUFsbChmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMuZG93bnN0cmVhbUJ1cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uQWxsRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy5kb3duc3RyZWFtQnVzLnN1YnNjcmliZUFsbChmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLnNlbmRVcHN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIHRoaXMudXBzdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuc2VuZERvd25zdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICB0aGlzLmRvd25zdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuX2Rpc3BhdGNoRXZlbnQgPSBmdW5jdGlvbihidXMsIG1lc3NhZ2VFdmVudCkgewogICAgICB2YXIgbWVzc2FnZSA9IG1lc3NhZ2VFdmVudC5kYXRhOwogICAgICBpZiAobWVzc2FnZS5ldmVudCkgewogICAgICAgICBidXMudHJpZ2dlcihtZXNzYWdlLmV2ZW50LCBtZXNzYWdlLmRhdGEpOwogICAgICB9CiAgIH07CgogICAvKioKICAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggcGFzc2VzIGV2ZW50cyB1cHN0cmVhbS4KICAgICoKICAgICogVXNhZ2U6CiAgICAqIGNvbmR1aXQub25Eb3duc3RyZWFtKCJNeUV2ZW50IiwgY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5wYXNzVXBzdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSwgZXZlbnROYW1lKSB7CiAgICAgICAgIHNlbGYudXBzdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICAgICB9OwogICB9OwoKICAgLyoqCiAgICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIHBhc3NlcyBldmVudHMgZG93bnN0cmVhbS4KICAgICoKICAgICogVXNhZ2U6CiAgICAqIGNvbmR1aXQub25VcHN0cmVhbSgiTXlFdmVudCIsIGNvbmR1aXQucGFzc0Rvd25zdHJlYW0oKSk7CiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5wYXNzRG93bnN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhLCBldmVudE5hbWUpIHsKICAgICAgICAgc2VsZi5kb3duc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgICAgfTsKICAgfTsKCiAgIC8qKgogICAgKiBTaHV0ZG93biB0aGUgY29uZHVpdCdzIGV2ZW50IGJ1c3NlcyBhbmQgcmVtb3ZlIGFsbCBzdWJzY3JpcHRpb25zLgogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUuc2h1dGRvd24gPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy51cHN0cmVhbUJ1cy51bnN1YnNjcmliZUFsbCgpOwogICAgICB0aGlzLmRvd25zdHJlYW1CdXMudW5zdWJzY3JpYmVBbGwoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBJRnJhbWVDb25kdWl0IGV4dGVuZHMgQ29uZHVpdAogICAgKgogICAgKiBDcmVhdGVzIGEgY29uZHVpdCBmb3IgdGhlIGdpdmVuIElGcmFtZSBlbGVtZW50LgogICAgKi8KICAgdmFyIElGcmFtZUNvbmR1aXQgPSBmdW5jdGlvbihuYW1lLCB3aW5kb3csIGlmcmFtZSwgZG9tYWluKSB7CiAgICAgIENvbmR1aXQuY2FsbCh0aGlzLCBuYW1lLCBuZXcgV2luZG93SU9TdHJlYW0od2luZG93LCBpZnJhbWUuY29udGVudFdpbmRvdywgZG9tYWluIHx8ICcqJyksIG51bGwpOwogICB9OwogICBJRnJhbWVDb25kdWl0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29uZHVpdC5wcm90b3R5cGUpOwogICBJRnJhbWVDb25kdWl0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IElGcmFtZUNvbmR1aXQ7CgogICBjb25uZWN0LlN0cmVhbSA9IFN0cmVhbTsKICAgY29ubmVjdC5OdWxsU3RyZWFtID0gTnVsbFN0cmVhbTsKICAgY29ubmVjdC5XaW5kb3dTdHJlYW0gPSBXaW5kb3dTdHJlYW07CiAgIGNvbm5lY3QuV2luZG93SU9TdHJlYW0gPSBXaW5kb3dJT1N0cmVhbTsKICAgY29ubmVjdC5Qb3J0U3RyZWFtID0gUG9ydFN0cmVhbTsKICAgY29ubmVjdC5TdHJlYW1NdWx0aXBsZXhlciA9IFN0cmVhbU11bHRpcGxleGVyOwogICBjb25uZWN0LkNvbmR1aXQgPSBDb25kdWl0OwogICBjb25uZWN0LklGcmFtZUNvbmR1aXQgPSBJRnJhbWVDb25kdWl0Owp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gODMzOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogR3JhcGhMaW5rIDw8YWJzdHJhY3QgY2xhc3M+PgogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBhc3NvY2lhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEgc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgdGhpcy5mcm9tU3RhdGUgPSBmcm9tU3RhdGU7CiAgICAgIHRoaXMudG9TdGF0ZSA9IHRvU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgdGhyb3cgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEZyb21TdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5mcm9tU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldFRvU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudG9TdGF0ZTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRGlyZWN0R3JhcGhMaW5rIDw8Y29uY3JldGUgY2xhc3M+PiBleHRlbmRzIEdyYXBoTGluawogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBieS12YWx1ZSByZXByZXNlbnRhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEKICAgICogc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBEaXJlY3RHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUsIGFzc29jaWF0aW9ucykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXNzb2NpYXRpb25zLCAnYXNzb2NpYXRpb25zJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zOwogICB9OwogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IERpcmVjdEdyYXBoTGluazsKCiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5hc3NvY2lhdGlvbnM7CiAgIH07CgogICAvKioKICAgICogRnVuY3Rpb25hbEdyYXBoTGluayA8PGNvbmNyZXRlIGNsYXNzPj4gZXh0ZW5kcyBHcmFwaExpbmsKICAgICoKICAgICogUmVwcmVzZW50cyBhIGZ1bmN0aW9uYWwgYXNzb2NpYXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhCiAgICAqIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgRnVuY3Rpb25hbEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSwgY2xvc3VyZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2xvc3VyZSwgJ2Nsb3N1cmUnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjbG9zdXJlKSwgJ2Nsb3N1cmUgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuY2xvc3VyZSA9IGNsb3N1cmU7CiAgIH07CiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGdW5jdGlvbmFsR3JhcGhMaW5rOwoKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5jbG9zdXJlKGNvbnRleHQsIHRoaXMuZ2V0RnJvbVN0YXRlKCksIHRoaXMuZ2V0VG9TdGF0ZSgpKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRXZlbnRHcmFwaCA8PGNsYXNzPj4KICAgICoKICAgICogQnVpbGRzIGEgbWFwIG9mIGFzc29jaWF0aW9ucyBmcm9tIG9uZSBzdGF0ZSB0byBhbm90aGVyIGluIGNvbnRleHQgb2YgYQogICAgKiBwYXJ0aWN1bGFyIG9iamVjdC4gIFRoZSBhc3NvY2lhdGlvbnMgY2FuIGJlIGRpcmVjdCAob25lIG9yIG1vcmUgdmFsdWVzKQogICAgKiBvciBmdW5jdGlvbmFsIChhIG1ldGhvZCByZXR1cm5pbmcgb25lIG9yIG1vcmUgdmFsdWVzKSwgYW5kIGFyZSB1c2VkIHRvCiAgICAqIHByb3ZpZGUgYWRkaXRpb25hbCBjb250ZXh0dWFsIGV2ZW50IGhvb2tzIGZvciB0aGUgVUkgdG8gY29uc3VtZS4KICAgICovCiAgIHZhciBFdmVudEdyYXBoID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZnJvbU1hcCA9IHt9OwogICB9OwogICBFdmVudEdyYXBoLkFOWSA9ICI8PGFueT4+IjsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLmFzc29jID0gZnVuY3Rpb24oZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBpZiAoISBmcm9tU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJmcm9tU3RhdGVPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmICghIHRvU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0b1N0YXRlT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoISBhc3NvY09iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFzc29jT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoZnJvbVN0YXRlT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgZnJvbVN0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24oZnJvbVN0YXRlKSB7CiAgICAgICAgICAgIHNlbGYuYXNzb2MoZnJvbVN0YXRlLCB0b1N0YXRlT2JqLCBhc3NvY09iaik7CiAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRvU3RhdGVPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICB0b1N0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24odG9TdGF0ZSkgewogICAgICAgICAgICBzZWxmLmFzc29jKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZSwgYXNzb2NPYmopOwogICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgaWYgKHR5cGVvZiBhc3NvY09iaiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRnVuY3Rpb25hbEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSk7CiAgICAgICAgIH0gZWxzZSBpZiAoYXNzb2NPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRGlyZWN0R3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopKTsKICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IERpcmVjdEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIFthc3NvY09ial0pKTsKICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIHZhciBhc3NvY2lhdGlvbnMgPSBbXTsKCiAgICAgIHZhciB0b01hcEZyb21BbnkgPSB0aGlzLmZyb21NYXBbRXZlbnRHcmFwaC5BTlldIHx8IHt9OwogICAgICB2YXIgdG9NYXAgPSB0aGlzLmZyb21NYXBbZnJvbVN0YXRlXSB8fCB7fTsKCiAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQodGhpcy5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCgKICAgICAgICAgICAgICAgdG9NYXBGcm9tQW55LCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpKTsKICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCh0aGlzLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwKAogICAgICAgICAgICAgICB0b01hcCwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSk7CgogICAgICByZXR1cm4gYXNzb2NpYXRpb25zOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuX2FkZEFzc29jaWF0aW9uID0gZnVuY3Rpb24oYXNzb2MpIHsKICAgICAgdmFyIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXTsKCiAgICAgIGlmICghIHRvTWFwKSB7CiAgICAgICAgIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXSA9IHt9OwogICAgICB9CgogICAgICB2YXIgYXNzb2NMaXN0ID0gdG9NYXBbYXNzb2MuZ2V0VG9TdGF0ZSgpXTsKCiAgICAgIGlmICghIGFzc29jTGlzdCkgewogICAgICAgICBhc3NvY0xpc3QgPSB0b01hcFthc3NvYy5nZXRUb1N0YXRlKCldID0gW107CiAgICAgIH0KCiAgICAgIGFzc29jTGlzdC5wdXNoKGFzc29jKTsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwID0gZnVuY3Rpb24obWFwLCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgdmFyIGFzc29jTGlzdCA9IChtYXBbRXZlbnRHcmFwaC5BTlldIHx8IFtdKS5jb25jYXQobWFwW3RvU3RhdGVdIHx8IFtdKTsKICAgICAgcmV0dXJuIGFzc29jTGlzdC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgYXNzb2MpIHsKICAgICAgICAgcmV0dXJuIHByZXYuY29uY2F0KGFzc29jLmdldEFzc29jaWF0aW9ucyhjb250ZXh0KSk7CiAgICAgIH0sIFtdKTsKICAgfTsKCiAgIGNvbm5lY3QuRXZlbnRHcmFwaCA9IEV2ZW50R3JhcGg7Cgp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gODkxOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgdmFyIHVzZXJBZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgdmFyIE9ORV9EQVlfTUlMTElTID0gMjQgKiA2MCAqIDYwICogMTAwMDsKICB2YXIgREVGQVVMVF9QT1BVUF9IRUlHSFQgPSA1Nzg7CiAgdmFyIERFRkFVTFRfUE9QVVBfV0lEVEggPSA0MzM7CiAgdmFyIENPUFlBQkxFX0VWRU5UX0ZJRUxEUyA9IFsiYnViYmxlcyIsICJjYW5jZWxCdWJibGUiLCAiY2FuY2VsYWJsZSIsICJjb21wb3NlZCIsICJkYXRhIiwgImRlZmF1bHRQcmV2ZW50ZWQiLCAiZXZlbnRQaGFzZSIsICJpc1RydXN0ZWQiLCAibGFzdEV2ZW50SWQiLCAib3JpZ2luIiwgInJldHVyblZhbHVlIiwgInRpbWVTdGFtcCIsICJ0eXBlIl07CgogIC8qKgogICAqIFVucG9sbHV0ZSBzcHJpbnRmIGZ1bmN0aW9ucyBmcm9tIHRoZSBnbG9iYWwgbmFtZXNwYWNlLgogICAqLwogIGNvbm5lY3Quc3ByaW50ZiA9IGdsb2JhbC5zcHJpbnRmOwogIGNvbm5lY3QudnNwcmludGYgPSBnbG9iYWwudnNwcmludGY7CiAgZGVsZXRlIGdsb2JhbC5zcHJpbnRmOwogIGRlbGV0ZSBnbG9iYWwudnNwcmludGY7CgogIGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMgPSB7CiAgICBTVUNDRVNTOiAyMDAsCiAgICBUT09fTUFOWV9SRVFVRVNUUzogNDI5LAogICAgSU5URVJOQUxfU0VSVkVSX0VSUk9SOiA1MDAKICB9OwoKICBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUyA9IHsKICAgIENIQVRfVE9LRU46ICJjaGF0X3Rva2VuIiwKICAgIFdFQl9TT0NLRVQ6ICJ3ZWJfc29ja2V0IgogIH07CgogIC8qKgogICAqIEJpbmRzIHRoZSBnaXZlbiBpbnN0YW5jZSBvYmplY3QgYXMgdGhlIGNvbnRleHQgZm9yCiAgICogdGhlIG1ldGhvZCBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSBzY29wZSBUaGUgaW5zdGFuY2Ugb2JqZWN0IHRvIGJlIHNldCBhcyB0aGUgc2NvcGUKICAgKiAgICBvZiB0aGUgZnVuY3Rpb24uCiAgICogQHBhcmFtIG1ldGhvZCBUaGUgbWV0aG9kIHRvIGJlIGVuY2Fwc3VsYXRlZC4KICAgKgogICAqIEFsbCBvdGhlciBhcmd1bWVudHMsIGlmIGFueSwgYXJlIGJvdW5kIHRvIHRoZSBtZXRob2QKICAgKiBpbnZvY2F0aW9uIGluc2lkZSB0aGUgY2xvc3VyZS4KICAgKgogICAqIEByZXR1cm4gQSBjbG9zdXJlIGVuY2Fwc3VsYXRpbmcgdGhlIGludm9jYXRpb24gb2YgdGhlCiAgICogICAgbWV0aG9kIHByb3ZpZGVkIGluIGNvbnRleHQgb2YgdGhlIGdpdmVuIGluc3RhbmNlLgogICAqLwogIGNvbm5lY3QuaGl0Y2ggPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgc2NvcGUgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgbWV0aG9kID0gYXJncy5zaGlmdCgpOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzY29wZSwgJ3Njb3BlJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWV0aG9kLCAnbWV0aG9kJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKG1ldGhvZCksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNsb3N1cmVBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseShzY29wZSwgYXJncy5jb25jYXQoY2xvc3VyZUFyZ3MpKTsKICAgIH07CiAgfTsKCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhIGNhbGxhYmxlIGZ1bmN0aW9uIHR5cGUuCiAgICogQm9ycm93ZWQgZnJvbSBVbmRlcnNjb3JlLmpzLgogICAqLwogIGNvbm5lY3QuaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLmNvbnN0cnVjdG9yICYmIG9iai5jYWxsICYmIG9iai5hcHBseSk7CiAgfTsKCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhbiBhcnJheS4KICAgKi8KICBjb25uZWN0LmlzQXJyYXkgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBrZXlzIGZyb20gYSBKYXZhc2NyaXB0IG9iamVjdCB1c2VkCiAgICogYXMgYSBoYXNoIG1hcC4KICAgKi8KICBjb25uZWN0LmtleXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIga2V5cyA9IFtdOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtYXAsICdtYXAnKTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICBrZXlzLnB1c2goayk7CiAgICB9CgogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiB2YWx1ZXMgZnJvbSBhIEphdmFzY3JpcHQgb2JqZWN0IHVzZWQKICAgKiBhcyBhIGhhc2ggbWFwLgogICAqLwogIGNvbm5lY3QudmFsdWVzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIHZhbHVlcyA9IFtdOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtYXAsICdtYXAnKTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICB2YWx1ZXMucHVzaChtYXBba10pOwogICAgfQoKICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBrZXkvdmFsdWUgcGFpcnMgZnJvbSB0aGUgZ2l2ZW4gbWFwLgogICAqLwogIGNvbm5lY3QuZW50cmllcyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciBlbnRyaWVzID0gW107CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAgZW50cmllcy5wdXNoKHsga2V5OiBrLCB2YWx1ZTogbWFwW2tdIH0pOwogICAgfQoKICAgIHJldHVybiBlbnRyaWVzOwogIH07CgogIC8qKgogICAqIE1lcmdlIHR3byBvciBtb3JlIG1hcHMgdG9nZXRoZXIgaW50byBhIG5ldyBtYXAsCiAgICogb3Igc2ltcGx5IGNvcHkgYSBzaW5nbGUgbWFwLgogICAqLwogIGNvbm5lY3QubWVyZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJnTWFwcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgcmVzdWx0TWFwID0ge307CgogICAgYXJnTWFwcy5mb3JFYWNoKGZ1bmN0aW9uIChtYXApIHsKICAgICAgY29ubmVjdC5lbnRyaWVzKG1hcCkuZm9yRWFjaChmdW5jdGlvbiAoa3YpIHsKICAgICAgICByZXN1bHRNYXBba3Yua2V5XSA9IGt2LnZhbHVlOwogICAgICB9KTsKICAgIH0pOwoKICAgIHJldHVybiByZXN1bHRNYXA7CiAgfTsKCiAgY29ubmVjdC5ub3cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgfTsKCiAgY29ubmVjdC5maW5kID0gZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgYXJyYXkubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHByZWRpY2F0ZShhcnJheVt4XSkpIHsKICAgICAgICByZXR1cm4gYXJyYXlbeF07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9OwoKICBjb25uZWN0LmNvbnRhaW5zID0gZnVuY3Rpb24gKG9iaiwgdmFsdWUpIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKG9iaiwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAodmFsdWUgaW4gb2JqKTsKICAgIH0KICB9OwoKICBjb25uZWN0LmNvbnRhaW5zVmFsdWUgPSBmdW5jdGlvbiAob2JqLCB2YWx1ZSkgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQob2JqLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChjb25uZWN0LnZhbHVlcyhvYmopLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogR2VuZXJhdGUgYSByYW5kb20gSUQgY29uc2lzdGluZyBvZiB0aGUgY3VycmVudCB0aW1lc3RhbXAKICAgKiBhbmQgYSByYW5kb20gYmFzZS0zNiBudW1iZXIgYmFzZWQgb24gTWF0aC5yYW5kb20oKS4KICAgKi8KICBjb25uZWN0LnJhbmRvbUlkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMtJXMiLCBjb25uZWN0Lm5vdygpLCBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSk7CiAgfTsKCiAgLyoqCiAgICogR2VuZXJhdGUgYW4gZW51bSBmcm9tIHRoZSBnaXZlbiBsaXN0IG9mIGxvd2VyLWNhc2UgZW51bSB2YWx1ZXMsCiAgICogd2hlcmUgdGhlIGVudW0ga2V5cyB3aWxsIGJlIHVwcGVyIGNhc2UuCiAgICoKICAgKiBDb252ZXJzaW9uIGZyb20gcGFzY2FsIGNhc2UgYmFzZWQgb24gY29kZSBmcm9tIGhlcmU6CiAgICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMDUyMTIyNAogICAqLwogIGNvbm5lY3QubWFrZUVudW0gPSBmdW5jdGlvbiAodmFsdWVzKSB7CiAgICB2YXIgZW51bU9iaiA9IHt9OwoKICAgIHZhbHVlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIga2V5ID0gdmFsdWUucmVwbGFjZSgvXC4/KFthLXpdKylfPy9nLCBmdW5jdGlvbiAoeCwgeSkgeyByZXR1cm4geS50b1VwcGVyQ2FzZSgpICsgIl8iOyB9KQogICAgICAgIC5yZXBsYWNlKC9fJC8sICIiKTsKCiAgICAgIGVudW1PYmpba2V5XSA9IHZhbHVlOwogICAgfSk7CgogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0gPSBmdW5jdGlvbiAocHJlZml4LCB2YWx1ZXMpIHsKICAgIHZhciBlbnVtT2JqID0gY29ubmVjdC5tYWtlRW51bSh2YWx1ZXMpOwogICAgY29ubmVjdC5rZXlzKGVudW1PYmopLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBlbnVtT2JqW2tleV0gPSBjb25uZWN0LnNwcmludGYoIiVzOjolcyIsIHByZWZpeCwgZW51bU9ialtrZXldKTsKICAgIH0pOwogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgY29ubmVjdC5tYWtlR2VuZXJpY05hbWVzcGFjZWRFbnVtID0gZnVuY3Rpb24gKHByZWZpeCwgdmFsdWVzLCBkZWxpbWl0ZXIpIHsKICAgIHZhciBlbnVtT2JqID0gY29ubmVjdC5tYWtlRW51bSh2YWx1ZXMpOwogICAgY29ubmVjdC5rZXlzKGVudW1PYmopLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBlbnVtT2JqW2tleV0gPSBjb25uZWN0LnNwcmludGYoIiVzIitkZWxpbWl0ZXIrIiVzIiwgcHJlZml4LCBlbnVtT2JqW2tleV0pOwogICAgfSk7CiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICAvKioKICAqIE1ldGhvZHMgdG8gZGV0ZXJtaW5lIGJyb3dzZXIgdHlwZSBhbmQgdmVyc2lvbnMsIHVzZWQgZm9yIHNvZnRwaG9uZSBpbml0aWFsaXphdGlvbi4KICAqLwogIGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuaXNPcGVyYUJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIk9wZXJhIikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuZ2V0Q2hyb21lQnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY2hyb21lVmVyc2lvbiA9IHVzZXJBZ2VudC5zdWJzdHJpbmcodXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpICsgNyk7CiAgICBpZiAoY2hyb21lVmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChjaHJvbWVWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICBjb25uZWN0LmdldEZpcmVmb3hCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBmaXJlZm94VmVyc2lvbiA9IHVzZXJBZ2VudC5zdWJzdHJpbmcodXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSArIDgpOwogICAgaWYgKGZpcmVmb3hWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KGZpcmVmb3hWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICBjb25uZWN0LmlzVmFsaWRMb2NhbGUgPSBmdW5jdGlvbiAobG9jYWxlKSB7CiAgICB2YXIgbGFuZ3VhZ2VzID0gWwogICAgICB7CiAgICAgICAgaWQ6ICdlbl9VUycsCiAgICAgICAgbGFiZWw6ICdFbmdsaXNoJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdkZV9ERScsCiAgICAgICAgbGFiZWw6ICdEZXV0c2NoJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdlc19FUycsCiAgICAgICAgbGFiZWw6ICdFc3Bhw7FvbCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZnJfRlInLAogICAgICAgIGxhYmVsOiAnRnJhbsOnYWlzJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdqYV9KUCcsCiAgICAgICAgbGFiZWw6ICfml6XmnKzoqp4nCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2l0X0lUJywKICAgICAgICBsYWJlbDogJ0l0YWxpYW5vJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdrb19LUicsCiAgICAgICAgbGFiZWw6ICftlZzqta3slrQnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ3B0X0JSJywKICAgICAgICBsYWJlbDogJ1BvcnR1Z3XDqnMnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ3poX0NOJywKICAgICAgICBsYWJlbDogJ+S4reaWhyjnroDkvZMpJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICd6aF9UVycsCiAgICAgICAgbGFiZWw6ICfkuK3mloco57mB6auUKScKICAgICAgfQogICAgXTsKICAgIHJldHVybiBsYW5ndWFnZXMubWFwKGZ1bmN0aW9uKGxhbmd1YWdlKXsgcmV0dXJuIGxhbmd1YWdlLmlkfSkuaW5jbHVkZXMobG9jYWxlKTsKICB9CgogIGNvbm5lY3QuZ2V0T3BlcmFCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB2ZXJzaW9uT2Zmc2V0ID0gdXNlckFnZW50LmluZGV4T2YoIk9wZXJhIik7CiAgICB2YXIgb3BlcmFWZXJzaW9uID0gKHVzZXJBZ2VudC5pbmRleE9mKCJWZXJzaW9uIikgIT09IC0xKSA/IHVzZXJBZ2VudC5zdWJzdHJpbmcodmVyc2lvbk9mZnNldCArIDgpIDogdXNlckFnZW50LnN1YnN0cmluZyh2ZXJzaW9uT2Zmc2V0ICsgNik7CiAgICBpZiAob3BlcmFWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KG9wZXJhVmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmV0dXJuIGEgbWFwIG9mIGl0ZW1zIGluIHRoZSBnaXZlbiBsaXN0IGluZGV4ZWQgYnkKICAgKiBrZXlzIGRldGVybWluZWQgYnkgdGhlIGNsb3N1cmUgcHJvdmlkZWQuCiAgICoKICAgKiBAcGFyYW0gaXRlcmFibGUgQSBsaXN0LWxpa2Ugb2JqZWN0LgogICAqIEBwYXJhbSBjbG9zdXJlIEEgY2xvc3VyZSB0byBkZXRlcm1pbmUgdGhlIGluZGV4IGZvciB0aGUKICAgKiAgICBpdGVtcyBpbiB0aGUgaXRlcmFibGUuCiAgICogQHJldHVybiBBIG1hcCBmcm9tIGluZGV4IHRvIGl0ZW0gZm9yIGVhY2ggaXRlbSBpbiB0aGUgaXRlcmFibGUuCiAgICovCiAgY29ubmVjdC5pbmRleCA9IGZ1bmN0aW9uIChpdGVyYWJsZSwgY2xvc3VyZSkgewogICAgdmFyIG1hcCA9IHt9OwoKICAgIGl0ZXJhYmxlLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgbWFwW2Nsb3N1cmUoaXRlbSldID0gaXRlbTsKICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfTsKCiAgLyoqCiAgICogQ29udmVydHMgdGhlIGdpdmVuIGFycmF5IGludG8gYSBtYXAgYXMgYSBzZXQsCiAgICogd2hlcmUgZWxlbWVudHMgaW4gdGhlIGFycmF5IGFyZSBtYXBwZWQgdG8gMS4KICAgKi8KICBjb25uZWN0LnNldCA9IGZ1bmN0aW9uIChhcnJheUluKSB7CiAgICB2YXIgc2V0TWFwID0ge307CgogICAgYXJyYXlJbi5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgc2V0TWFwW2tleV0gPSAxOwogICAgfSk7CgogICAgcmV0dXJuIHNldE1hcDsKICB9OwoKICAvKioKICAgKiBSZXR1cm5zIGEgbWFwIGZvciBlYWNoIGtleSBpbiBtYXBCIHdoaWNoCiAgICogaXMgTk9UIGluIG1hcEEuCiAgICovCiAgY29ubmVjdC5yZWxhdGl2ZUNvbXBsZW1lbnQgPSBmdW5jdGlvbiAobWFwQSwgbWFwQikgewogICAgdmFyIGNvbXBNYXAgPSB7fTsKCiAgICBjb25uZWN0LmtleXMobWFwQikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGlmICghKGtleSBpbiBtYXBBKSkgewogICAgICAgIGNvbXBNYXBba2V5XSA9IG1hcEJba2V5XTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIGNvbXBNYXA7CiAgfTsKCiAgLyoqCiAgICogQXNzZXJ0cyB0aGF0IGEgcHJlbWlzZSBpcyB0cnVlLgogICAqLwogIGNvbm5lY3QuYXNzZXJ0VHJ1ZSA9IGZ1bmN0aW9uIChwcmVtaXNlLCBtZXNzYWdlKSB7CiAgICBpZiAoIXByZW1pc2UpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBBc3NlcnRzIHRoYXQgYSB2YWx1ZSBpcyBub3QgbnVsbCBvciB1bmRlZmluZWQuCiAgICovCiAgY29ubmVjdC5hc3NlcnROb3ROdWxsID0gZnVuY3Rpb24gKHZhbHVlLCBuYW1lKSB7CiAgICBjb25uZWN0LmFzc2VydFRydWUodmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09IHVuZGVmaW5lZCwKICAgICAgY29ubmVjdC5zcHJpbnRmKCIlcyBtdXN0IGJlIHByb3ZpZGVkIiwgbmFtZSB8fCAnQSB2YWx1ZScpKTsKICAgIHJldHVybiB2YWx1ZTsKICB9OwoKICBjb25uZWN0LmRlZXBjb3B5ID0gZnVuY3Rpb24gKHNyYykgewogICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3JjKSk7CiAgfTsKCiAgY29ubmVjdC5kZWVwY29weUNyb3NzT3JpZ2luRXZlbnQgPSBmdW5jdGlvbihldmVudCkgewogICAgY29uc3Qgb2JqID0ge307CiAgICBjb25zdCBsaXN0T2ZBY2NlcHRhYmxlS2V5cyA9IENPUFlBQkxFX0VWRU5UX0ZJRUxEUzsKICAgIGxpc3RPZkFjY2VwdGFibGVLZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgICB0cnkgewogICAgICAgIG9ialtrZXldID0gZXZlbnRba2V5XTsKICAgICAgfQogICAgICBjYXRjaChlKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJkZWVwY29weUNyb3NzT3JpZ2luRXZlbnQgZmFpbGVkIG9uIGtleTogIiwga2V5KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBjb25uZWN0LmRlZXBjb3B5KG9iaik7CiAgfQoKICAvKioKICAgKiBHZXQgdGhlIGN1cnJlbnQgYmFzZSB1cmwgb2YgdGhlIG9wZW4gcGFnZSwgZS5nLiBpZiB0aGUgcGFnZSBpcwogICAqIGh0dHBzOi8vZXhhbXBsZS5jb206OTQ5NC9vcmFuZ2VzLCB0aGlzIHdpbGwgYmUgImh0dHBzOi8vZXhhbXBsZS5jb206OTQ5NCIuCiAgICovCiAgY29ubmVjdC5nZXRCYXNlVXJsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvY2F0aW9uID0gZ2xvYmFsLmxvY2F0aW9uOwogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMvLyVzOiVzIiwgbG9jYXRpb24ucHJvdG9jb2wsIGxvY2F0aW9uLmhvc3RuYW1lLCBsb2NhdGlvbi5wb3J0KTsKICB9OwoKICBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbCA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIHByb3RvY29sID0gZ2xvYmFsLmxvY2F0aW9uLnByb3RvY29sOwogICAgaWYgKHVybC5zdWJzdHIoMCwgcHJvdG9jb2wubGVuZ3RoKSAhPT0gcHJvdG9jb2wpIHsKICAgICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMvLyVzIiwgcHJvdG9jb2wsIHVybCk7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0KCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBjdXJyZW50IHdpbmRvdyBpcyBpbiBhbiBpZnJhbWUuCiAgICogQ291cnRlc3k6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzI2MDY5LwogICAqLwogIGNvbm5lY3QuaXNGcmFtZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gd2luZG93LnNlbGYgIT09IHdpbmRvdy50b3A7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH07CgogIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID4gMTsKICB9CgogIGNvbm5lY3QuZmV0Y2ggPSBmdW5jdGlvbiAoZW5kcG9pbnQsIG9wdGlvbnMsIG1pbGxpSW50ZXJ2YWwsIG1heFJldHJ5KSB7CiAgICBtYXhSZXRyeSA9IG1heFJldHJ5IHx8IDU7CiAgICBtaWxsaUludGVydmFsID0gbWlsbGlJbnRlcnZhbCB8fCAxMDAwOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBmZXRjaERhdGEobWF4UmV0cnkpIHsKICAgICAgICBmZXRjaChlbmRwb2ludCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5TVUNDRVNTKSB7CiAgICAgICAgICAgIHJlcy5qc29uKCkudGhlbihqc29uID0+IHJlc29sdmUoanNvbikpLmNhdGNoKCgpID0+IHJlc29sdmUoe30pKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWF4UmV0cnkgIT09IDEgJiYgKHJlcy5zdGF0dXMgPj0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IgfHwgcmVzLnN0YXR1cyA9PT0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5UT09fTUFOWV9SRVFVRVNUUykpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgZmV0Y2hEYXRhKC0tbWF4UmV0cnkpOwogICAgICAgICAgICB9LCBtaWxsaUludGVydmFsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlamVjdChyZXMpOwogICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZmV0Y2hEYXRhKG1heFJldHJ5KTsKICAgIH0pOwogIH07CgogIC8qKgogICAqIENhbGxpbmcgYSBmdW5jdGlvbiB3aXRoIGV4cG9uZW50aWFsIGJhY2tvZmYgd2l0aCBmdWxsIGppdHRlciByZXRyeSBzdHJhdGVneQogICAqIEl0IHdpbGwgcmV0cnkgY2FsbGluZyB0aGUgZnVuY3Rpb24gZm9yIG1heGltdW0gbWF4UmV0cnkgdGltZXMgaWYgaXQgZmFpbHMuCiAgICogU3VjY2VzcyBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgZnVuY3Rpb24gc3VjY2VlZGVkLgogICAqIEZhaWx1cmUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgb25seSBpZiB0aGUgbGFzdCB0cnkgZmFpbGVkLgogICAqLwogIGNvbm5lY3QuYmFja29mZiA9IGZ1bmN0aW9uIChmdW5jLCBtaWxsaUludGVydmFsLCBtYXhSZXRyeSwgY2FsbGJhY2tzKSB7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGZ1bmMpLCAiZnVuYyBtdXN0IGJlIGEgRnVuY3Rpb24iKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciByYXRpbyA9IDI7CgogICAgZnVuYyh7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKG1heFJldHJ5ID4gMCkgewogICAgICAgICAgdmFyIGludGVydmFsID0gbWlsbGlJbnRlcnZhbCAqIDIgKiBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmJhY2tvZmYoZnVuYywgaW50ZXJ2YWwgKiByYXRpbywgLS1tYXhSZXRyeSwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0sIGludGVydmFsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnIsIGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoTWV0cmljID0gZnVuY3Rpb24gKG1ldHJpY0RhdGEpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLkNMSUVOVF9NRVRSSUMsCiAgICAgIGRhdGE6IG1ldHJpY0RhdGEKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVN0YXRzID0gZnVuY3Rpb24oc3RhdHMpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLlNPRlRQSE9ORV9TVEFUUywKICAgICAgZGF0YTogc3RhdHMKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuU09GVFBIT05FX1JFUE9SVCwKICAgICAgZGF0YTogcmVwb3J0CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hDbGlja1N0cmVhbURhdGEgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLkNMSUNLX1NUUkVBTV9EQVRBLAogICAgICBkYXRhOiByZXBvcnQKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaENsaWVudFNpZGVMb2dzID0gZnVuY3Rpb24obG9ncykgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX1NJREVfTE9HUywgbG9ncyk7CiAgfTsKCiAgY29ubmVjdC5hZGROYW1lc3BhY2VUb0xvZ3MgPSBmdW5jdGlvbihuYW1lc3BhY2UpIHsKICAgIGNvbnN0IG1ldGhvZHMgPSBbJ2xvZycsICdlcnJvcicsICd3YXJuJywgJ2luZm8nLCAnZGVidWcnXTsKCiAgICBtZXRob2RzLmZvckVhY2goKG1ldGhvZCkgPT4gewogICAgICBjb25zdCBjb25zb2xlTWV0aG9kID0gd2luZG93LmNvbnNvbGVbbWV0aG9kXTsKICAgICAgd2luZG93LmNvbnNvbGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb25zdCBhcmdzID0gQXJyYXkuZnJvbShhcmd1bWVudHMpOwogICAgICAgIGFyZ3MudW5zaGlmdChgWyR7bmFtZXNwYWNlfV1gKTsKICAgICAgICBjb25zb2xlTWV0aG9kLmFwcGx5KHdpbmRvdy5jb25zb2xlLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CgogIC8qKgogICAqIEEgd3JhcHBlciBhcm91bmQgV2luZG93Lm9wZW4oKSBmb3IgbWFuYWdpbmcgc2luZ2xlIGluc3RhbmNlIHBvcHVwcy4KICAgKi8KICBjb25uZWN0LlBvcHVwTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLm9wZW4gPSBmdW5jdGlvbiAodXJsLCBuYW1lLCBvcHRpb25zKSB7CiAgICB2YXIgdGhlbiA9IHRoaXMuX2dldExhc3RPcGVuZWRUaW1lc3RhbXAobmFtZSk7CiAgICB2YXIgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgd2luID0gbnVsbDsKICAgIGlmIChub3cgLSB0aGVuID4gT05FX0RBWV9NSUxMSVMpIHsKICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAvLyBkZWZhdWx0IHZhbHVlcyBhcmUgY2hvc2VuIHRvIHByb3ZpZGUgYSBtaW5pbXVtIGhlaWdodCB3aXRob3V0IHNjcm9sbGluZwogICAgICAgIC8vIGFuZCBhIHVuaWZvcm0gbWFyZ2luIGJhc2VkIG9uIHRoZSBjc3Mgb2YgdGhlIGNjcCBsb2dpbiBwYWdlCiAgICAgICAgdmFyIGhlaWdodCA9IG9wdGlvbnMuaGVpZ2h0IHx8IERFRkFVTFRfUE9QVVBfSEVJR0hUOwogICAgICAgIHZhciB3aWR0aCA9IG9wdGlvbnMud2lkdGggfHwgREVGQVVMVF9QT1BVUF9XSURUSDsKICAgICAgICB2YXIgdG9wID0gb3B0aW9ucy50b3AgfHwgMDsKICAgICAgICB2YXIgbGVmdCA9IG9wdGlvbnMubGVmdCB8fCAwOwogICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKCcnLCBuYW1lLCAid2lkdGg9Iit3aWR0aCsiLCBoZWlnaHQ9IitoZWlnaHQrIiwgdG9wPSIrdG9wKyIsIGxlZnQ9IitsZWZ0KTsKICAgICAgICBpZiAod2luLmxvY2F0aW9uICE9PSB1cmwpIHsKICAgICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKHVybCwgbmFtZSwgIndpZHRoPSIrd2lkdGgrIiwgaGVpZ2h0PSIraGVpZ2h0KyIsIHRvcD0iK3RvcCsiLCBsZWZ0PSIrbGVmdCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKCcnLCBuYW1lKTsKICAgICAgICBpZiAod2luLmxvY2F0aW9uICE9PSB1cmwpIHsKICAgICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKHVybCwgbmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX3NldExhc3RPcGVuZWRUaW1lc3RhbXAobmFtZSwgbm93KTsKICAgIH0KICAgIHJldHVybiB3aW47CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX2dldExhc3RPcGVuZWRUaW1lc3RhbXAgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIHZhciB2YWx1ZSA9IGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpOwoKICAgIGlmICh2YWx1ZSkgewogICAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKTsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gMDsKICAgIH0KICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX3NldExhc3RPcGVuZWRUaW1lc3RhbXAgPSBmdW5jdGlvbiAobmFtZSwgdHMpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCAnJyArIHRzKTsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX2dldExvY2FsU3RvcmFnZUtleSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gImNvbm5lY3RQb3B1cE1hbmFnZXI6OiIgKyBuYW1lOwogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIHRoZSBIVE1MNSBub3RpZmljYXRpb24gcGVybWlzc2lvbiB2YWx1ZXMuCiAgICovCiAgdmFyIE5vdGlmaWNhdGlvblBlcm1pc3Npb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdncmFudGVkJywKICAgICdkZW5pZWQnLAogICAgJ2RlZmF1bHQnCiAgXSk7CgogIC8qKgogICAqIEEgc2ltcGxlIGVuZ2luZSBmb3Igc2hvd2luZyBub3RpZmljYXRpb24gcG9wdXBzLgogICAqLwogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMucXVldWUgPSBbXTsKICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVGQVVMVDsKICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnJlcXVlc3RQZXJtaXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKCEoIk5vdGlmaWNhdGlvbiIgaW4gZ2xvYmFsKSkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoaXMgYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgbm90aWZpY2F0aW9ucy4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKGdsb2JhbC5Ob3RpZmljYXRpb24ucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGUgdXNlciBoYXMgcmVxdWVzdGVkIHRvIG5vdCByZWNlaXZlIG5vdGlmaWNhdGlvbnMuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQ7CgogICAgfSBlbHNlIGlmICh0aGlzLnBlcm1pc3Npb24gIT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICBnbG9iYWwuTm90aWZpY2F0aW9uLnJlcXVlc3RQZXJtaXNzaW9uKCkudGhlbihmdW5jdGlvbiAocGVybWlzc2lvbikgewogICAgICAgIHNlbGYucGVybWlzc2lvbiA9IHBlcm1pc3Npb247CiAgICAgICAgaWYgKHBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICAgICAgc2VsZi5fc2hvd1F1ZXVlZCgpOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5xdWV1ZSA9IFtdOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5zaG93ID0gZnVuY3Rpb24gKHRpdGxlLCBvcHRpb25zKSB7CiAgICBpZiAodGhpcy5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3Nob3dJbXBsKHsgdGl0bGU6IHRpdGxlLCBvcHRpb25zOiBvcHRpb25zIH0pOwoKICAgIH0gZWxzZSBpZiAodGhpcy5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRCkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlVuYWJsZSB0byBzaG93IG5vdGlmaWNhdGlvbi4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIHZhciBwYXJhbXMgPSB7IHRpdGxlOiB0aXRsZSwgb3B0aW9uczogb3B0aW9ucyB9OwogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIkRlZmVycmluZyBub3RpZmljYXRpb24gdW50aWwgdXNlciBkZWNpZGVzIHRvIGFsbG93IG9yIGRlbnkuIikKICAgICAgICAud2l0aE9iamVjdChwYXJhbXMpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucXVldWUucHVzaChwYXJhbXMpOwogICAgfQogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuX3Nob3dRdWV1ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgbm90aWZpY2F0aW9ucyA9IHRoaXMucXVldWUubWFwKGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgICAgcmV0dXJuIHNlbGYuX3Nob3dJbXBsKHBhcmFtcyk7CiAgICB9KTsKICAgIHRoaXMucXVldWUgPSBbXTsKICAgIHJldHVybiBub3RpZmljYXRpb25zOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuX3Nob3dJbXBsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIG5vdGlmaWNhdGlvbiA9IG5ldyBnbG9iYWwuTm90aWZpY2F0aW9uKHBhcmFtcy50aXRsZSwgcGFyYW1zLm9wdGlvbnMpOwogICAgaWYgKHBhcmFtcy5vcHRpb25zLmNsaWNrZWQpIHsKICAgICAgbm90aWZpY2F0aW9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcGFyYW1zLm9wdGlvbnMuY2xpY2tlZC5jYWxsKG5vdGlmaWNhdGlvbik7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gbm90aWZpY2F0aW9uOwogIH07CgogIGNvbm5lY3QuVmFsdWVFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgaW5zdGFuY2UgPSBuZXcgRXJyb3IoY29ubmVjdC52c3ByaW50Zihmb3JtYXQsIGFyZ3MpKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihpbnN0YW5jZSwgY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZSk7CiAgICByZXR1cm4gaW5zdGFuY2U7IAogIH07CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUsIEVycm9yLnByb3RvdHlwZSk7CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuVmFsdWVFcnJvciwgRXJyb3IpOwogIGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUubmFtZSA9ICdWYWx1ZUVycm9yJzsKCiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBpbnN0YW5jZSA9IG5ldyBFcnJvcihjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlKTsKICAgIHJldHVybiBpbnN0YW5jZTsgCiAgfTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZSwgRXJyb3IucHJvdG90eXBlKTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLCBFcnJvcik7CiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZS5uYW1lID0gJ05vdEltcGxlbWVudGVkRXJyb3InOwoKICBjb25uZWN0LlN0YXRlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGluc3RhbmNlID0gbmV3IEVycm9yKGNvbm5lY3QudnNwcmludGYoZm9ybWF0LCBhcmdzKSk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoaW5zdGFuY2UsIGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUpOwogICAgcmV0dXJuIGluc3RhbmNlOyAKICB9CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUsIEVycm9yLnByb3RvdHlwZSk7CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuU3RhdGVFcnJvciwgRXJyb3IpOwogIGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUubmFtZSA9ICdTdGF0ZUVycm9yJzsKCgoKICBjb25uZWN0LlZvaWNlSWRFcnJvciA9IGZ1bmN0aW9uKHR5cGUsIG1lc3NhZ2UsIGVycil7CiAgICB2YXIgZXJyb3IgPSB7fTsKICAgIGVycm9yLnR5cGUgPSB0eXBlOwogICAgZXJyb3IubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICBlcnJvci5zdGFjayA9IEVycm9yKG1lc3NhZ2UpLnN0YWNrOwogICAgZXJyb3IuZXJyID0gZXJyOwogICAgcmV0dXJuIGVycm9yOwogIH0KCiAgLy8gaW50ZXJuYWwgdXNlIG9ubHkKICBjb25uZWN0LmlzQ0NQID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgIHJldHVybiBjb25kdWl0Lm5hbWUgPT09ICdDb25uZWN0U2hhcmVkV29ya2VyQ29uZHVpdCc7CiAgfQoKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDczNjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIGNvbm5lY3Qud29ya2VyID0ge307CgogIHZhciBHRVRfQUdFTlRfVElNRU9VVF9NUyA9IDMwMDAwOwogIHZhciBHRVRfQUdFTlRfUkVDT1ZFUllfVElNRU9VVF9NUyA9IDUwMDA7CiAgdmFyIEdFVF9BR0VOVF9TVUNDRVNTX1RJTUVPVVRfTVMgPSAxMDA7CiAgdmFyIExPR19CVUZGRVJfQ0FQX1NJWkUgPSA0MDA7CgogIHZhciBDSEVDS19BVVRIX1RPS0VOX0lOVEVSVkFMX01TID0gMzAwMDAwOyAvLyA1IG1pbnV0cwogIHZhciBSRUZSRVNIX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMgPSAxMDAwMDsgLy8gMTAgc2Vjb25kcwogIHZhciBSRUZSRVNIX0FVVEhfVE9LRU5fTUFYX1RSWSA9IDQ7CgogIHZhciBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUyA9IDMwMDAwOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIE1hc3RlclRvcGljQ29vcmRpbmF0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnRvcGljTWFzdGVyTWFwID0ge307CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUuZ2V0TWFzdGVyID0gZnVuY3Rpb24gKHRvcGljKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICd0b3BpYycpOwogICAgcmV0dXJuIHRoaXMudG9waWNNYXN0ZXJNYXBbdG9waWNdIHx8IG51bGw7CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUuc2V0TWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBpZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAndG9waWMnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZCwgJ2lkJyk7CiAgICB0aGlzLnRvcGljTWFzdGVyTWFwW3RvcGljXSA9IGlkOwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLnJlbW92ZU1hc3RlciA9IGZ1bmN0aW9uIChpZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlkLCAnaWQnKTsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjb25uZWN0LmVudHJpZXModGhpcy50b3BpY01hc3Rlck1hcCkuZmlsdGVyKGZ1bmN0aW9uIChlbnRyeSkgewogICAgICByZXR1cm4gZW50cnkudmFsdWUgPT09IGlkOwogICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgZGVsZXRlIHNlbGYudG9waWNNYXN0ZXJNYXBbZW50cnkua2V5XTsKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIFdvcmtlckNsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgKi8KICB2YXIgV29ya2VyQ2xpZW50ID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIGNvbm5lY3QuQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICB9OwogIFdvcmtlckNsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGNvbm5lY3QuQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXb3JrZXJDbGllbnQ7CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24gKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciByZXF1ZXN0X3N0YXJ0ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICBpZihjb25uZWN0LmNvbnRhaW5zVmFsdWUoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMsIG1ldGhvZCkpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldEFnZW50QXBwQ2xpZW50KCkuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyb3IpOwogICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0gZWxzZSBpZihjb25uZWN0LmNvbnRhaW5zVmFsdWUoY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50TWV0aG9kcywgbWV0aG9kKSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0VGFza1RlbXBsYXRlc0NsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCkuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycm9yLCBkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyb3IpOwogICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IsIGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5hdXRoRmFpbHVyZSgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjYWxsYmFja3MuYWNjZXNzRGVuaWVkICYmIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgCiAgfTsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fcmVjb3JkQVBJTGF0ZW5jeSA9IGZ1bmN0aW9uIChtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycikgewogICAgdmFyIHJlcXVlc3RfZW5kID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgcmVxdWVzdF90aW1lID0gcmVxdWVzdF9lbmQgLSByZXF1ZXN0X3N0YXJ0OwogICAgdGhpcy5fc2VuZEFQSU1ldHJpY3MobWV0aG9kLCByZXF1ZXN0X3RpbWUsIGVycik7CiAgfTsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fc2VuZEFQSU1ldHJpY3MgPSBmdW5jdGlvbiAobWV0aG9kLCB0aW1lLCBlcnIpIHsKICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDLCB7CiAgICAgIG5hbWU6IG1ldGhvZCwKICAgICAgdGltZTogdGltZSwKICAgICAgZGltZW5zaW9uczogWwogICAgICAgIHsKICAgICAgICAgIG5hbWU6ICJDYXRlZ29yeSIsCiAgICAgICAgICB2YWx1ZTogIkFQSSIKICAgICAgICB9CiAgICAgIF0sCiAgICAgIGVycm9yOiBlcnIKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBUaGUgb2JqZWN0IHJlc3BvbnNpYmxlIGZvciBwb2xsaW5nIGFuZCBwYXNzaW5nIGRhdGEgZG93bnN0cmVhbSB0byBhbGwKICAgKiBjb25zdW1lciBwb3J0cy4KICAgKi8KICB2YXIgQ2xpZW50RW5naW5lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMubXVsdGlwbGV4ZXIgPSBuZXcgY29ubmVjdC5TdHJlYW1NdWx0aXBsZXhlcigpOwogICAgdGhpcy5jb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdCgiQW1hem9uQ29ubmVjdFNoYXJlZFdvcmtlciIsIG51bGwsIHRoaXMubXVsdGlwbGV4ZXIpOwogICAgdGhpcy5jbGllbnQgPSBuZXcgV29ya2VyQ2xpZW50KHRoaXMuY29uZHVpdCk7CiAgICB0aGlzLnRpbWVvdXQgPSBudWxsOwogICAgdGhpcy5hZ2VudCA9IG51bGw7CiAgICB0aGlzLm5leHRUb2tlbiA9IG51bGw7CiAgICB0aGlzLmluaXREYXRhID0ge307CiAgICB0aGlzLnBvcnRDb25kdWl0TWFwID0ge307CiAgICB0aGlzLnN0cmVhbU1hcEJ5VGFiSWQgPSB7fTsKICAgIHRoaXMubWFzdGVyQ29vcmQgPSBuZXcgTWFzdGVyVG9waWNDb29yZGluYXRvcigpOwogICAgdGhpcy5sb2dzQnVmZmVyID0gW107CiAgICB0aGlzLnN1cHByZXNzID0gZmFsc2U7CiAgICB0aGlzLmZvcmNlT2ZmbGluZSA9IGZhbHNlOwogICAgdGhpcy5sb25nUG9sbGluZ09wdGlvbnMgPSB7CiAgICAgIGFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlOiBmYWxzZSwgCiAgICAgIGFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZTogZmFsc2UsCiAgICB9CgogICAgdmFyIHdlYlNvY2tldE1hbmFnZXIgPSBudWxsOwoKICAgIGNvbm5lY3Qucm9vdExvZ2dlciA9IG5ldyBjb25uZWN0LkRvd25zdHJlYW1Db25kdWl0TG9nZ2VyKHRoaXMuY29uZHVpdCk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGZ1bmN0aW9uIChsb2dzVG9VcGxvYWQpIHsKICAgICAgLy8gQWRkIHNvZnRwaG9uZSBsb2dzIGRvd25zdHJlYW0KICAgICAgY29ubmVjdC5nZXRMb2coKS5wdXNoTG9nc0Rvd25zdHJlYW0obG9nc1RvVXBsb2FkKTsKCiAgICAgIHNlbGYubG9nc0J1ZmZlciA9IHNlbGYubG9nc0J1ZmZlci5jb25jYXQobG9nc1RvVXBsb2FkKTsKICAgICAgLy9vbmx5IGNhbGwgQVBJIHRvIHNlbmQgbG9ncyBpZiBidWZmZXIgcmVhY2hlZCBjYXAKICAgICAgaWYgKHNlbGYubG9nc0J1ZmZlci5sZW5ndGggPiBMT0dfQlVGRkVSX0NBUF9TSVpFKSB7CiAgICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU1VQUFJFU1MsIGZ1bmN0aW9uIChkYXRhKXsKICAgICAgY29ubmVjdC5nZXRMb2coKS5kZWJ1ZygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTZXR0aW5nIFN1cHByZXNzIHRvICVzIiwgZGF0YS5zdXBwcmVzcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5zdXBwcmVzcyA9IGRhdGEuc3VwcHJlc3MgfHwgZmFsc2U7CiAgICAgIC8vc2lnbmFsIG90aGVyIHdpbmRvd3MgdGhhdCBhIGZhaWxvdmVyIGhhcHBlbmVkCiAgICAgIGlmIChzZWxmLm1hc3RlckNvb3JkLmdldE1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUpKSB7CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GQUlMT1ZFUiwgewogICAgICAgICAgaXNQcmltYXJ5OiAhc2VsZi5zdXBwcmVzcwogICAgICAgIH0pOyAgICAgIAogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgRk9SQ0VfT0ZGTElORSB0byAlcyIsIGRhdGEub2ZmbGluZSkKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5mb3JjZU9mZmxpbmUgPSBkYXRhLm9mZmxpbmUgfHwgZmFsc2U7CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKGRhdGEuYXV0aFRva2VuICYmIGRhdGEuYXV0aFRva2VuICE9PSBzZWxmLmluaXREYXRhLmF1dGhUb2tlbikgewogICAgICAgIHNlbGYuaW5pdERhdGEgPSBkYXRhOwogICAgICAgIGNvbm5lY3QuY29yZS5pbml0KGRhdGEpOwogICAgICAgIGlmIChkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucykgewogICAgICAgICAgaWYgKHR5cGVvZiBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZSA9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgc2VsZi5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGUgPSBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlID09ICJib29sZWFuIikgewogICAgICAgICAgICBzZWxmLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGUgPSBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIGluaXQgb25seSBvbmNlLgogICAgICAgIGlmICghd2ViU29ja2V0TWFuYWdlcikgewoKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ3JlYXRpbmcgYSBuZXcgV2Vic29ja2V0IGNvbm5lY3Rpb24gZm9yIENDUCIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgIGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlci5zZXRHbG9iYWxDb25maWcoewogICAgICAgICAgICBsb2dnZXJDb25maWc6IHsgbG9nZ2VyOiBjb25uZWN0LmdldExvZygpIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIgPSBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuY3JlYXRlKCk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkluaXRGYWlsdXJlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbk9wZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uQ2xvc2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0NMT1NFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkdhaW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9HQUlOKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uTG9zdChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uU3Vic2NyaXB0aW9uVXBkYXRlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvbkZhaWx1cmUoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkFsbE1lc3NhZ2UoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5BTExfTUVTU0FHRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLnNlbmRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZi5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJQkUsIGZ1bmN0aW9uICh0b3BpY3MpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zdWJzY3JpYmVUb3BpY3ModG9waWNzKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuaW5pdChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuZ2V0V2ViU29ja2V0VXJsKSkudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmIChyZXNwb25zZSAmJiAhcmVzcG9uc2Uud2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZCkgewogICAgICAgICAgICAgICAgLy8gU3RhcnQgcG9sbGluZyBmb3IgYWdlbnQgZGF0YS4KICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYWdlbnQgcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnQoKTsKICAKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgY29uZmlnIHBvbGxpbmciKQogICAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbih7IHJlcGVhdEZvcmV2ZXI6IHRydWUgfSk7CiAgCiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGF1dGggdG9rZW4gcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5jaGVja0F1dGhUb2tlbiksIENIRUNLX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICAgICAgICAgICAgICBjb25zdCBldmVudCA9IGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRTsKICAgICAgICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGV2ZW50KTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJXZWJTb2NrZXQgZmFpbGVkIHRvIGluaXRpYWxpemUiKQogICAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJOb3QgSW5pdGlhbGl6aW5nIGEgbmV3IFdlYnNvY2tldE1hbmFnZXIgaW5zdGFuY2UsIHNpbmNlIG9uZSBhbHJlYWR5IGV4aXN0cyIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURSwgZnVuY3Rpb24gKCkgewogICAgICAvL3VwbG9hZCBwZW5kaW5nIGxvZ3MgYmVmb3JlIHRlcm1pbmF0aW5nLgogICAgICBzZWxmLmhhbmRsZVNlbmRMb2dzUmVxdWVzdChzZWxmLmxvZ3NCdWZmZXIpOwogICAgICBjb25uZWN0LmNvcmUudGVybWluYXRlKCk7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEVEKTsKICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TWU5DSFJPTklaRSwgZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UpOwogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGRhdGEuZXZlbnQsIGRhdGEuZGF0YSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENhbGxlZCB3aGVuIGEgY29uc3VtZXIgcG9ydCBjb25uZWN0cyB0byB0aGlzIFNoYXJlZFdvcmtlci4KICAgICAqIExldCdzIGFkZCB0aGVtIHRvIG91ciBtdWx0aXBsZXhlci4KICAgICAqLwogICAgZ2xvYmFsLm9uY29ubmVjdCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICB2YXIgcG9ydCA9IGV2ZW50LnBvcnRzWzBdOwogICAgICB2YXIgc3RyZWFtID0gbmV3IGNvbm5lY3QuUG9ydFN0cmVhbShwb3J0KTsKICAgICAgc2VsZi5tdWx0aXBsZXhlci5hZGRTdHJlYW0oc3RyZWFtKTsKICAgICAgcG9ydC5zdGFydCgpOwoKICAgICAgdmFyIHBvcnRDb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdChzdHJlYW0uZ2V0SWQoKSwgbnVsbCwgc3RyZWFtKTsKICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIHsgaWQ6IHN0cmVhbS5nZXRJZCgpIH0pOwoKICAgICAgc2VsZi5wb3J0Q29uZHVpdE1hcFtzdHJlYW0uZ2V0SWQoKV0gPSBwb3J0Q29uZHVpdDsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgeyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCB9KTsKCiAgICAgIGlmIChzZWxmLmFnZW50ICE9PSBudWxsKSB7CiAgICAgICAgc2VsZi51cGRhdGVBZ2VudCgpOwogICAgICB9CgogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFUVVFU1QsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFQSVJlcXVlc3QsIHBvcnRDb25kdWl0KSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVRVUVTVCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlTWFzdGVyUmVxdWVzdCwgcG9ydENvbmR1aXQsIHN0cmVhbS5nZXRJZCgpKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5SRUxPQURfQUdFTlRfQ09ORklHVVJBVElPTiwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbikpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEFCX0lELAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVUYWJJZEV2ZW50LCBzdHJlYW0pKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNMT1NFLCAKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQ2xvc2VFdmVudCwgc3RyZWFtKSk7CiAgICB9OwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TTkFQU0hPVCwgewogICAgICBuZXh0VG9rZW46IHNlbGYubmV4dFRva2VuLAogICAgICB0aW1lb3V0OiBHRVRfQUdFTlRfVElNRU9VVF9NUwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZWxmLmFnZW50ID0gc2VsZi5hZ2VudCB8fCB7fTsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdCA9IGRhdGEuc25hcHNob3Q7CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3QubG9jYWxUaW1lc3RhbXAgPSBjb25uZWN0Lm5vdygpOwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90LnNrZXcgPSBzZWxmLmFnZW50LnNuYXBzaG90LnNuYXBzaG90VGltZXN0YW1wIC0gc2VsZi5hZ2VudC5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcDsKICAgICAgICAgICAgc2VsZi5uZXh0VG9rZW4gPSBkYXRhLm5leHRUb2tlbjsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiR0VUX0FHRU5UX1NOQVBTSE9UIHN1Y2NlZWRlZC4iKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiTG9uZyBwb2xsIGZhaWxlZCB0byB1cGRhdGUgYWdlbnQuIikKICAgICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50KSwgR0VUX0FHRU5UX1NVQ0NFU1NfVElNRU9VVF9NUyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZ2V0IGFnZW50IGRhdGEuIikKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnQpLCBHRVRfQUdFTlRfUkVDT1ZFUllfVElNRU9VVF9NUyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQoKICAgICAgfSk7CgogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9DT05GSUdVUkFUSU9OLCB7fSwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciBjb25maWd1cmF0aW9uID0gZGF0YS5jb25maWd1cmF0aW9uOwogICAgICAgIHNlbGYucG9sbEZvckFnZW50UGVybWlzc2lvbnMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgc2VsZi5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMoY29uZmlndXJhdGlvbik7CiAgICAgICAgaWYgKHBhcmFtcy5yZXBlYXRGb3JldmVyKSB7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiwgcGFyYW1zKSwKICAgICAgICAgICAgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgY29uZmlndXJhdGlvbiBkYXRhLiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAocGFyYW1zLnJlcGVhdEZvcmV2ZXIpIHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pLAogICAgICAgICAgICAgIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TLCBwYXJhbXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgIH0sCiAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50U3RhdGVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9TVEFURVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCgogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRTdGF0ZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIHN0YXRlczogKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLmFnZW50U3RhdGVzID0gKHBhcmFtcy5zdGF0ZXMgfHwgW10pLmNvbmNhdChkYXRhLnN0YXRlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IHN0YXRlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9BR0VOVF9QRVJNSVNTSU9OUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBwZXJtaXNzaW9uczogKHBhcmFtcy5wZXJtaXNzaW9ucyB8fCBbXSkuY29uY2F0KGRhdGEucGVybWlzc2lvbnMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyA9IChwYXJhbXMucGVybWlzc2lvbnMgfHwgW10pLmNvbmNhdChkYXRhLnBlcm1pc3Npb25zKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgcGVybWlzc2lvbnMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0RJQUxBQkxFX0NPVU5UUllfQ09ERVMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2Rlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uZGlhbGFibGVDb3VudHJpZXMgPSAocGFyYW1zLmNvdW50cnlDb2RlcyB8fCBbXSkuY29uY2F0KGRhdGEuY291bnRyeUNvZGVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggZGlhbGFibGUgY291bnRyeSBjb2RlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfUk9VVElOR19QUk9GSUxFX1FVRVVFUywgewogICAgICByb3V0aW5nUHJvZmlsZUFSTjogY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTiwKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgY291bnRyeUNvZGVzOiAocGFyYW1zLnF1ZXVlcyB8fCBbXSkuY29uY2F0KGRhdGEucXVldWVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzID0gKHBhcmFtcy5xdWV1ZXMgfHwgW10pLmNvbmNhdChkYXRhLnF1ZXVlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIHJvdXRpbmcgcHJvZmlsZSBxdWV1ZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBUElSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCByZXF1ZXN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5jbGllbnQuY2FsbChyZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXJhbXMsIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UsIHJlcXVlc3QsIGRhdGEsIEpTT04uc3RyaW5naWZ5KGVycikpOwogICAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBBUEkgcmVxdWVzdCBmYWlsZWQiLCByZXF1ZXN0Lm1ldGhvZCkKICAgICAgICAgIC53aXRoT2JqZWN0KHsgcmVxdWVzdDogc2VsZi5maWx0ZXJBdXRoVG9rZW4ocmVxdWVzdCksIHJlc3BvbnNlOiByZXNwb25zZSB9KQogICAgICAgICAgLndpdGhFeGNlcHRpb24oZXJyKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwsIHthdXRob3JpemU6IHRydWV9KQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogSGFuZGxlIGluY29taW5nIG1hc3RlciBxdWVyeSBvciBtb2RpZmljYXRpb24gcmVxdWVzdHMgZnJvbSBjb25uZWN0ZWQgdGFiIHBvcnRzLgogICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlTWFzdGVyUmVxdWVzdCA9IGZ1bmN0aW9uIChwb3J0Q29uZHVpdCwgcG9ydElkLCByZXF1ZXN0KSB7CiAgICB2YXIgbXVsdGlwbGV4ZXJDb25kdWl0ID0gdGhpcy5jb25kdWl0OwogICAgdmFyIHJlc3BvbnNlID0gbnVsbDsKCiAgICBzd2l0Y2ggKHJlcXVlc3QubWV0aG9kKSB7CiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVI6CiAgICAgICAgdmFyIG1hc3RlcklkID0gdGhpcy5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMpOwogICAgICAgIHZhciB0YWtlT3ZlciA9IEJvb2xlYW4obWFzdGVySWQpICYmIG1hc3RlcklkICE9PSBwb3J0SWQ7CiAgICAgICAgdGhpcy5tYXN0ZXJDb29yZC5zZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMsIHBvcnRJZCk7CiAgICAgICAgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIHJlcXVlc3QsIHsKICAgICAgICAgIG1hc3RlcklkOiBwb3J0SWQsCiAgICAgICAgICB0YWtlT3ZlcjogdGFrZU92ZXIsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKICAgICAgICBpZiAodGFrZU92ZXIpIHsKICAgICAgICAgIG11bHRpcGxleGVyQ29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUjoKICAgICAgICB2YXIgbWFzdGVySWQgPSB0aGlzLm1hc3RlckNvb3JkLmdldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYyk7CiAgICAgICAgaWYgKCFtYXN0ZXJJZCAmJiAhcmVxdWVzdC5wYXJhbXMuc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lKSB7CiAgICAgICAgICB0aGlzLm1hc3RlckNvb3JkLnNldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYywgcG9ydElkKTsKICAgICAgICAgIG1hc3RlcklkID0gcG9ydElkOwogICAgICAgIH0KICAgICAgICByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgcmVxdWVzdCwgewogICAgICAgICAgbWFzdGVySWQ6IG1hc3RlcklkLAogICAgICAgICAgaXNNYXN0ZXI6IHBvcnRJZCA9PT0gbWFzdGVySWQsCiAgICAgICAgICB0b3BpYzogcmVxdWVzdC5wYXJhbXMudG9waWMKICAgICAgICB9KTsKICAgICAgICBicmVhazsKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIG1hc3RlciBtZXRob2Q6ICIgKyByZXF1ZXN0Lm1ldGhvZCk7CiAgICB9CgogICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZVRhYklkRXZlbnQgPSBmdW5jdGlvbiAoc3RyZWFtLCBkYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0cnkgewogICAgICBsZXQgdGFiSWQgPSBkYXRhLnRhYklkOwogICAgICBsZXQgc3RyZWFtc0luVGhpc1RhYiA9IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF07CiAgICAgIGxldCBjdXJyZW50U3RyZWFtSWQgPSBzdHJlYW0uZ2V0SWQoKTsKICAgICAgbGV0IHRhYklkcyA9IE9iamVjdC5rZXlzKHNlbGYuc3RyZWFtTWFwQnlUYWJJZCk7CiAgICAgIGxldCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgPSB0YWJJZHMuZmlsdGVyKHRhYklkID0+IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoID4gMCkubGVuZ3RoOwogICAgICBpZiAoc3RyZWFtc0luVGhpc1RhYiAmJiBzdHJlYW1zSW5UaGlzVGFiLmxlbmd0aCA+IDApewogICAgICAgIGlmICghc3RyZWFtc0luVGhpc1RhYi5pbmNsdWRlcyhjdXJyZW50U3RyZWFtSWQpKSB7CiAgICAgICAgICBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLnB1c2goY3VycmVudFN0cmVhbUlkKTsKICAgICAgICAgIGxldCB1cGRhdGVPYmplY3QgPSB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoLCB0YWJJZCwgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyIH07CiAgICAgICAgICB1cGRhdGVPYmplY3RbdGFiSWRdID0geyBsZW5ndGg6IHN0cmVhbXNJblRoaXNUYWIubGVuZ3RoIH07CiAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB1cGRhdGVPYmplY3QpOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdID0gW3N0cmVhbS5nZXRJZCgpXTsKICAgICAgICBsZXQgdXBkYXRlT2JqZWN0ID0geyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCwgdGFiSWQsIHN0cmVhbXNUYWJzQWNyb3NzQnJvd3Nlcjogc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyICsgMSB9OwogICAgICAgIHVwZGF0ZU9iamVjdFt0YWJJZF0gPSB7IGxlbmd0aDogc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggfTsKICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB1cGRhdGVPYmplY3QpOwogICAgICB9CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiW1RhYiBJZHNdIElzc3VlIHVwZGF0aW5nIGNvbm5lY3RlZCBDQ1BzIHdpdGhpbiB0aGUgc2FtZSB0YWIiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVDbG9zZUV2ZW50ID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLm11bHRpcGxleGVyLnJlbW92ZVN0cmVhbShzdHJlYW0pOwogICAgZGVsZXRlIHNlbGYucG9ydENvbmR1aXRNYXBbc3RyZWFtLmdldElkKCldOwogICAgc2VsZi5tYXN0ZXJDb29yZC5yZW1vdmVNYXN0ZXIoc3RyZWFtLmdldElkKCkpOwogICAgbGV0IHVwZGF0ZU9iamVjdCA9IHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGggfTsKICAgIGxldCB0YWJJZHMgPSBPYmplY3Qua2V5cyhzZWxmLnN0cmVhbU1hcEJ5VGFiSWQpOwogICAgdHJ5IHsKICAgICAgbGV0IHRhYklkID0gdGFiSWRzLmZpbmQoa2V5ID0+IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFtrZXldLmluY2x1ZGVzKHN0cmVhbS5nZXRJZCgpKSk7CiAgICAgIGlmICh0YWJJZCkgewogICAgICAgIGxldCBzdHJlYW1JbmRleEluTWFwID0gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5maW5kSW5kZXgoKHZhbHVlKSA9PiBzdHJlYW0uZ2V0SWQoKSA9PT0gdmFsdWUpOwogICAgICAgIHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0uc3BsaWNlKHN0cmVhbUluZGV4SW5NYXAsIDEpOwogICAgICAgIGxldCB0YWJMZW5ndGggPSBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdID8gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggOiAwOwogICAgICAgIHVwZGF0ZU9iamVjdFt0YWJJZF0gPSB7IGxlbmd0aDogdGFiTGVuZ3RoIH07CiAgICAgICAgdXBkYXRlT2JqZWN0LnRhYklkID0gdGFiSWQ7CiAgICAgIH0KICAgICAgbGV0IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciA9IHRhYklkcy5maWx0ZXIodGFiSWQgPT4gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggPiAwKS5sZW5ndGg7CiAgICAgIHVwZGF0ZU9iamVjdC5zdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgPSBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXI7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiW1RhYiBJZHNdIElzc3VlIHVwZGF0aW5nIHRhYklkLXNwZWNpZmljIHN0cmVhbSBkYXRhIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgdXBkYXRlT2JqZWN0KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uKSB7CiAgICBpZiAoY29uZmlndXJhdGlvbi5wZXJtaXNzaW9ucyAmJgogICAgICBjb25maWd1cmF0aW9uLmRpYWxhYmxlQ291bnRyaWVzICYmCiAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRTdGF0ZXMgJiYKICAgICAgY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMpIHsKCiAgICAgIHRoaXMuYWdlbnQgPSB0aGlzLmFnZW50IHx8IHt9OwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uOwogICAgICB0aGlzLnVwZGF0ZUFnZW50KCk7CgogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgY29uZmlndXJhdGlvbiB1bnRpbCBhbGwgY29uZmlnIGRhdGEgaGFzIGJlZW4gZmV0Y2hlZC4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUudXBkYXRlQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXRoaXMuYWdlbnQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IGhhcyBiZWVuIGZ1bGx5IGNvbnN0cnVjdGVkLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5zbmFwc2hvdCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgc25hcHNob3QgaXMgYXZhaWxhYmxlLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIGlmICghdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBjb25maWd1cmF0aW9uIGlzIGF2YWlsYWJsZS4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIH0gZWxzZSB7CiAgICAgIC8vIEFsaWFzIHNvbWUgb2YgdGhlIHByb3BlcnRpZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LnN0YXR1cyA9IHRoaXMuYWdlbnQuc3RhdGU7CgogICAgICAvLyBTb3J0IHRoZSBjb250YWN0cyBvbiB0aGUgdGltZXN0YW1wCiAgICAgIGlmICh0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzICYmIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMubGVuZ3RoID4gMSkgewogICAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuc29ydChmdW5jdGlvbiAoY29udGFjdEEsIGNvbnRhY3RCKSB7CiAgICAgICAgICByZXR1cm4gY29udGFjdEEuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSAtIGNvbnRhY3RCLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIGNvbnRhY3Quc3RhdHVzID0gY29udGFjdC5zdGF0ZTsKCiAgICAgICAgY29udGFjdC5jb25uZWN0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChjb25uZWN0aW9uKSB7CiAgICAgICAgICBjb25uZWN0aW9uLmFkZHJlc3MgPSBjb25uZWN0aW9uLmVuZHBvaW50OwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUlkID0KICAgICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk47CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMuZm9yRWFjaChmdW5jdGlvbiAocXVldWUpIHsKICAgICAgICBxdWV1ZS5xdWV1ZUlkID0gcXVldWUucXVldWVBUk47CiAgICAgIH0pOwogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICAvL2NvbnRhY3QucXVldWUgaXMgbnVsbCB3aGVuIG1vbml0b3JpbmcKICAgICAgICBpZiAoY29udGFjdC5xdWV1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjb250YWN0LnF1ZXVlLnF1ZXVlSWQgPSBjb250YWN0LnF1ZXVlLnF1ZXVlQVJOOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkID0KICAgICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk47CiAgICAgIAogICAgICBpZiAodGhpcy5zdXBwcmVzcykgewogICAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMgPSB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZpbHRlcihmdW5jdGlvbihjb250YWN0KXsKICAgICAgICAgIHJldHVybiAoY29udGFjdC5zdGF0ZS50eXBlID09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEIHx8IGNvbnRhY3Quc3RhdGUudHlwZSA9PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVEKTsKICAgICAgICB9KTsKICAgICAgICBpZiAodGhpcy5mb3JjZU9mZmxpbmUpIHsKICAgICAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSk7CiAgICAgICAgfQogICAgICB9IAogICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5VUERBVEUsIHRoaXMuYWdlbnQpOwogICAgfQogIH07CgovKioKICogUHJvdmlkZXMgYSB3ZWJzb2NrZXQgdXJsIHRocm91Z2ggdGhlIGNyZWF0ZV90cmFuc3BvcnQgQVBJLgogKiBAcmV0dXJucyBhIHByb21pc2Ugd2hpY2gsIHVwb24gc3VjY2VzcywgcmV0dXJucyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgY3JlYXRlVHJhbnNwb3J0IEFQSS4KICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5nZXRXZWJTb2NrZXRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIG9uQXV0aEZhaWwgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpOwogICAgdmFyIG9uQWNjZXNzRGVuaWVkID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgeyB0cmFuc3BvcnRUeXBlOiBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUy5XRUJfU09DS0VUIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRXZWJTb2NrZXRVcmwgc3VjY2VlZGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgZmFpbGVkIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoewogICAgICAgICAgICByZWFzb246ICdnZXRXZWJTb2NrZXRVcmwgZmFpbGVkJywgCiAgICAgICAgICAgIF9kZWJ1ZzogZXJyCiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgQXV0aCBGYWlsdXJlIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChFcnJvcigiQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIGdldHRpbmcgZ2V0V2ViU29ja2V0VXJsIikpOwogICAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRXZWJTb2NrZXRVcmwgQWNjZXNzIERlbmllZCBGYWlsdXJlIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCBGYWlsdXJlIHdoaWxlIGdldHRpbmcgZ2V0V2ViU29ja2V0VXJsIikpOwogICAgICAgICAgb25BY2Nlc3NEZW5pZWQoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCgogIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSBkb3duc3RyZWFtIHRvIGFsbCBjb25zdW1lcnMgd2hlbiB3ZSBkZXRlY3QgdGhhdCBhdXRoZW50aWNhdGlvbgogICAgKiBhZ2FpbnN0IG9uZSBvZiBvdXIgQVBJcyBoYXMgZmFpbGVkLgogICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZVNlbmRMb2dzUmVxdWVzdCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dFdmVudHMgPSBbXTsKICAgIHZhciBsb2dzVG9TZW5kID0gc2VsZi5sb2dzQnVmZmVyLnNsaWNlKCk7CiAgICBzZWxmLmxvZ3NCdWZmZXIgPSBbXTsKICAgIGxvZ3NUb1NlbmQuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIGxvZ0V2ZW50cy5wdXNoKHsKICAgICAgICB0aW1lc3RhbXA6IGxvZy50aW1lLAogICAgICAgIGNvbXBvbmVudDogbG9nLmNvbXBvbmVudCwKICAgICAgICBtZXNzYWdlOiBsb2cudGV4dAogICAgICB9KTsKICAgIH0pOwogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9DTElFTlRfTE9HUywgeyBsb2dFdmVudHM6IGxvZ0V2ZW50cyB9LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTZW5kTG9ncyByZXF1ZXN0IHN1Y2NlZWRlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiU2VuZExvZ3MgcmVxdWVzdCBmYWlsZWQuIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLndpdGhFeGNlcHRpb24oZXJyKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpCiAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUF1dGhGYWlsID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChkYXRhKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGRhdGEpOwogICAgfQogICAgZWxzZSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwpOwogICAgfQogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDQ0VTU19ERU5JRUQpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuY2hlY2tBdXRoVG9rZW4gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZXhwaXJhdGlvbkRhdGUgPSBuZXcgRGF0ZShzZWxmLmluaXREYXRhLmF1dGhUb2tlbkV4cGlyYXRpb24pOwogICAgdmFyIGN1cnJlbnRUaW1lU3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciB0aGlydHlNaW5zID0gMzAgKiA2MCAqIDEwMDA7CgogICAgLy8gcmVmcmVzaCB0b2tlbiAzMCBtaW51dGVzIGJlZm9yZSBleHBpcmF0aW9uCiAgICBpZiAoZXhwaXJhdGlvbkRhdGUuZ2V0VGltZSgpIDwgKGN1cnJlbnRUaW1lU3RhbXAgKyB0aGlydHlNaW5zKSkgewogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkF1dGggdG9rZW4gZXhwaXJlcyBhdCAiICsgZXhwaXJhdGlvbkRhdGUgKyAiIFN0YXJ0IHJlZnJlc2hpbmcgdG9rZW4gd2l0aCByZXRyeS4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmJhY2tvZmYoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmF1dGhvcml6ZSksIFJFRlJFU0hfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUywgUkVGUkVTSF9BVVRIX1RPS0VOX01BWF9UUlkpOwogICAgfQogIH07CgoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmF1dGhvcml6ZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QuY29yZS5hdXRob3JpemUodGhpcy5pbml0RGF0YS5hdXRob3JpemVFbmRwb2ludCkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgdmFyIGV4cGlyYXRpb24gPSBuZXcgRGF0ZShyZXNwb25zZS5leHBpcmF0aW9uKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBdXRob3JpemF0aW9uIHN1Y2NlZWRlZCBhbmQgdGhlIHRva2VuIGV4cGlyZXMgYXQgJXMiLCBleHBpcmF0aW9uKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBzZWxmLmluaXREYXRhLmF1dGhUb2tlbiA9IHJlc3BvbnNlLmFjY2Vzc1Rva2VuOwogICAgICBzZWxmLmluaXREYXRhLmF1dGhUb2tlbkV4cGlyYXRpb24gPSBleHBpcmF0aW9uOwogICAgICBjb25uZWN0LmNvcmUuaW5pdENsaWVudChzZWxmLmluaXREYXRhKTsKICAgICAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudChzZWxmLmluaXREYXRhKTsKICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoKTsKICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJBdXRob3JpemF0aW9uIGZhaWxlZCB3aXRoIGNvZGUgJXMiLCByZXNwb25zZS5zdGF0dXMpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwMSkgewogICAgICAgIHNlbGYuaGFuZGxlQXV0aEZhaWwoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZSgpOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBGaWx0ZXIgdGhlICdhdXRoZW50aWNhdGlvbicgZmllbGQgb2YgdGhlIHJlcXVlc3QgcGFyYW1zIGZyb20gdGhlIGdpdmVuIEFQSV9SRVFVRVNUIGV2ZW50LgogICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuZmlsdGVyQXV0aFRva2VuID0gZnVuY3Rpb24gKHJlcXVlc3QpIHsKICAgIHZhciBuZXdfcmVxdWVzdCA9IHt9OwoKICAgIGZvciAodmFyIGtleUEgaW4gcmVxdWVzdCkgewogICAgICBpZiAoa2V5QSA9PT0gJ3BhcmFtcycpIHsKICAgICAgICB2YXIgbmV3X3BhcmFtcyA9IHt9OwogICAgICAgIGZvciAodmFyIGtleUIgaW4gcmVxdWVzdC5wYXJhbXMpIHsKICAgICAgICAgIGlmIChrZXlCICE9PSAnYXV0aGVudGljYXRpb24nKSB7CiAgICAgICAgICAgIG5ld19wYXJhbXNba2V5Ql0gPSByZXF1ZXN0LnBhcmFtc1trZXlCXTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG5ld19yZXF1ZXN0LnBhcmFtcyA9IG5ld19wYXJhbXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmV3X3JlcXVlc3Rba2V5QV0gPSByZXF1ZXN0W2tleUFdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG5ld19yZXF1ZXN0OwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0Lndvcmtlci5tYWluID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC53b3JrZXIuY2xpZW50RW5naW5lID0gbmV3IENsaWVudEVuZ2luZSgpOwogIH07Cgp9KSgpOwoKLyoqKi8gfSkKCi8qKioqKiovIAl9KTsKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCXZhciBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18gPSB7fTsKLyoqKioqKi8gCQovKioqKioqLyAJLy8gVGhlIHJlcXVpcmUgZnVuY3Rpb24KLyoqKioqKi8gCWZ1bmN0aW9uIF9fd2VicGFja19yZXF1aXJlX18obW9kdWxlSWQpIHsKLyoqKioqKi8gCQkvLyBDaGVjayBpZiBtb2R1bGUgaXMgaW4gY2FjaGUKLyoqKioqKi8gCQl2YXIgY2FjaGVkTW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXTsKLyoqKioqKi8gCQlpZiAoY2FjaGVkTW9kdWxlICE9PSB1bmRlZmluZWQpIHsKLyoqKioqKi8gCQkJcmV0dXJuIGNhY2hlZE1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJCX0KLyoqKioqKi8gCQkvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKQovKioqKioqLyAJCXZhciBtb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdID0gewovKioqKioqLyAJCQkvLyBubyBtb2R1bGUuaWQgbmVlZGVkCi8qKioqKiovIAkJCS8vIG5vIG1vZHVsZS5sb2FkZWQgbmVlZGVkCi8qKioqKiovIAkJCWV4cG9ydHM6IHt9Ci8qKioqKiovIAkJfTsKLyoqKioqKi8gCQovKioqKioqLyAJCS8vIEV4ZWN1dGUgdGhlIG1vZHVsZSBmdW5jdGlvbgovKioqKioqLyAJCV9fd2VicGFja19tb2R1bGVzX19bbW9kdWxlSWRdKG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pOwovKioqKioqLyAJCi8qKioqKiovIAkJLy8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGUKLyoqKioqKi8gCQlyZXR1cm4gbW9kdWxlLmV4cG9ydHM7Ci8qKioqKiovIAl9Ci8qKioqKiovIAkKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gCS8qIHdlYnBhY2svcnVudGltZS9nbG9iYWwgKi8KLyoqKioqKi8gCSgoKSA9PiB7Ci8qKioqKiovIAkJX193ZWJwYWNrX3JlcXVpcmVfXy5nID0gKGZ1bmN0aW9uKCkgewovKioqKioqLyAJCQlpZiAodHlwZW9mIGdsb2JhbFRoaXMgPT09ICdvYmplY3QnKSByZXR1cm4gZ2xvYmFsVGhpczsKLyoqKioqKi8gCQkJdHJ5IHsKLyoqKioqKi8gCQkJCXJldHVybiB0aGlzIHx8IG5ldyBGdW5jdGlvbigncmV0dXJuIHRoaXMnKSgpOwovKioqKioqLyAJCQl9IGNhdGNoIChlKSB7Ci8qKioqKiovIAkJCQlpZiAodHlwZW9mIHdpbmRvdyA9PT0gJ29iamVjdCcpIHJldHVybiB3aW5kb3c7Ci8qKioqKiovIAkJCX0KLyoqKioqKi8gCQl9KSgpOwovKioqKioqLyAJfSkoKTsKLyoqKioqKi8gCQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqLyAJCi8qKioqKiovIAkvLyBzdGFydHVwCi8qKioqKiovIAkvLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHMKLyoqKioqKi8gCS8vIFRoaXMgZW50cnkgbW9kdWxlIHVzZWQgJ21vZHVsZScgc28gaXQgY2FuJ3QgYmUgaW5saW5lZAovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MjcpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg5NDQpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygxNTEpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4OTEpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg1OTIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4Mik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDc1NCk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgzMyk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDk2NSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDI4Nik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDg5NSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDc0Myk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDY0Mik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDczNik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDQzOSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDI3OSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDQxOCk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDE4Nyk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgyMSk7Ci8qKioqKiovIAl2YXIgX193ZWJwYWNrX2V4cG9ydHNfXyA9IF9fd2VicGFja19yZXF1aXJlX18oNTAwKTsKLyoqKioqKi8gCQovKioqKioqLyB9KSgpCjs=";

  var LATEST_STREAMJS_CODE = window.atob(LATEST_STREAMJS_BASE64_CODE);


  /**
   Connect instance container
   It holds the connect api context within an iframe window.

   usage:
   var newContainer = new Container({ccpUrl: "bla", ...})
   */
  var Container = function(resource) {
      this.region = resource.region;
      this.id = this.region.replace(/-/g, '_');
      this.height = resource.height;
      this.style = resource.iframe_style; 
      this.ccp = this._createFramedCcp(JSON.stringify(resource));
  };

  Container.prototype._createFramedCcp = function (resource) {
    var permission = permission || "microphone; autoplay";
    var style = this.style || FRAME_DIMENSIONS;
    var iframe = document.createElement('iframe');
    iframe.srcdoc = this.getContent(resource);
    iframe.allow = permission;
    iframe.id = this.id;
    iframe.style = style;
    iframe.scrolling = "no";
    return iframe; 
  };

  Container.prototype.getContent = function(resource){
     return [
       "<!DOCTYPE html>",
       "<meta charset='UTF-8'>",
       "<html>",
         "<head>",
           "<script type='text/javascript'>",
             LATEST_STREAMJS_CODE,
           "</script>",
         "</head>",
         "<body onload='init()'>",
           "<div id=containerDiv style='width: 100%;height: " + this.height + "'></div>",
           "<script type='text/javascript'>",
             "function init() {",
               "connect.core.initCCP(containerDiv," + resource + ");",
            "}",
           "</script>",
         "</body>",
       "</html>"
     ].join('');
   };

  globalConnect.Container = Container;
})();
})();

// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
(() => {
/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Note: load utils before core.js
 */

(function () {
  var global = this;
  connect = global.connect || {};
  globalConnect = global.globalConnect || {};
  global.connect = connect;
  global.globalConnect = globalConnect;
  global.lily = connect;

  connect.core = {};
  globalConnect.core = { regions: {} };

  var IFRAME_STYLE = "margin: 0; border: 0; padding:0px;width: 0px;height: 0px";
  var GLOBALIFRAME_STYLE =
    "margin: 0; border: 0; padding:0px;width: 100%;height: 100%";
  var DIV_DEFAULT_HEIGHT = {
    height: "465px",
  };
  var uiFailoverEnabled = true;

  var extractCcpRegionParams = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.standByRegion, "ccpBackupResource");
    connect.assertNotNull(paramsIn.standByRegion.ccpUrl, "ccpUrl");
    connect.assertNotNull(paramsIn.standByRegion.loginUrl, "loginUrl");
    connect.assertNotNull(paramsIn.standByRegion.region, "region");

    var regionAParams = paramsIn;
    var regionBParams = Object.assign({}, paramsIn, {
      ccpUrl: paramsIn.standByRegion.ccpUrl,
      loginUrl: paramsIn.standByRegion.loginUrl,
      region: paramsIn.standByRegion.region,
    });

    var divStyle = extractDivStyle(globalContainerDiv);

    if (divStyle.display == "none") {
      uiFailoverEnabled = false;
    }

    if (parseInt(divStyle.height) <= 0) {
      globalContainerDiv.style.height = DIV_DEFAULT_HEIGHT.height; // populating ccp
      divStyle.height = DIV_DEFAULT_HEIGHT.height;
    }

    return [regionAParams, regionBParams].map(function (params) {
      connect.assertNotNull(params.ccpUrl, "ccpUrl");
      connect.assertNotNull(params.loginUrl, "loginUrl");
      connect.assertNotNull(params.region, "region");
      delete params.standByRegion;
      params.loginPopup = false;
      //signal CCP as part of a disaster recovery fleet
      params.disasterRecoveryOn = true;
      params.iframe_style = IFRAME_STYLE;
      params.height = divStyle.height;
      return params;
    });
  };

  var extractDivStyle = function (globalContainerDiv) {
    var style = window.getComputedStyle(globalContainerDiv);
    return {
      height: style.getPropertyValue("height"),
      width: style.getPropertyValue("width"),
      display: style.getPropertyValue("display"),
    };
  };

  var validateRegion = function (region, availableRegions) {
    connect.assertTrue(
      typeof region == "string",
      "Region provided " + region + " is not a valid string"
    );
    var regions = availableRegions || globalConnect.core.regions;
    if (!regions.hasOwnProperty(region)) {
      var message = "Region provided " + region + " is not found!";
      throw new connect.ValueError(message);
    }
  };

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it successfully gets the primary region.
   * 
   * @callback getPrimaryRegionSuccessCallback
   * @param {string} region -- A string representing an AWS region (e.g. "us-west-2") that is serving as the primary region in the disaster recovery setup.
   */

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it fails to get the primary region.
   * 
   * @callback getPrimaryRegionFailureCallback
   *
   */

  /**
   * Callback for fetching the primary region in a disaster recovery setup.
   * 
   * @callback getPrimaryRegionCallback
   * @param {getPrimaryRegionSuccessCallback} success -- A success callback that getPrimaryRegionCallback should call upon successfully fetching the primary region string.
   * @param {getPrimaryRegionFailureCallback} failure -- A failure callback that getPrimaryRegionCalllback should call upon unsuccessfully fetching the primary region string.
   */


  /**
   * Particular to DR, the getPrimaryRegion paramsIn field is new, and required. It returns a promise that is resolved once the CCP and namespace are successfully initialized. 
   * It is recommended that you do not attempt to use the connect object before this promise is resolved.
   * @param {object} globalContainerDiv -- The container div for the active and secondary CCPs for use with DR.
   * @param {object} paramsIn -- Identical to connect.core.initCCP's paramsIn, save for one additional param.
   * @param {getPrimaryRegionCallback} paramsIn.getPrimaryRegion -- Required. A callback function that fetches the primary region for DR as a string (like "us-west-2") and feeds it into the success callback.
   */
  globalConnect.core.initCCP = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.getPrimaryRegion, "getPrimaryRegion");
    connect.assertTrue(
      connect.isFunction(paramsIn.getPrimaryRegion),
      "getPrimaryRegion must be a function"
    );
    var getPrimaryRegionFunc = paramsIn.getPrimaryRegion;
    delete paramsIn.getPrimaryRegion;

    var dualCcpResources = extractCcpRegionParams(globalContainerDiv, paramsIn);
    getPrimaryRegionFunc(
      function (primaryRegion) {
        return new Promise(resolve => {
          var regions = dualCcpResources.reduce(function (obj, resource) {
            obj[resource.region] = null;
            return obj;
          }, {});
          validateRegion(primaryRegion, regions);

          var containers = dualCcpResources.map(function (resource) {
            if (resource.region === primaryRegion) {
              resource.isPrimary = true;
            }
            return new globalConnect.Container(resource);
          });

          //Create global Iframe and attach ccp containers
          var ccpIframes = containers.map(function (container) {
            return container.ccp.outerHTML;
          });
          var globalIframe = document.createElement("iframe");
          globalIframe.style = GLOBALIFRAME_STYLE;
          globalIframe.id = "globalCCP";
          globalIframe.scrolling = "no";

          // surface single instance connect api in main window
          globalIframe.onload = function () {
            if (uiFailoverEnabled) {
              var secondaryRegion = Object.keys(regions).find(function (
                region
              ) {
                return region != primaryRegion;
              });

              activateUI(primaryRegion, globalIframe.id);
              deactivateUI(secondaryRegion, globalIframe.id);
            }
            containers.map(function (container) {
              globalConnect.core.regions[container.region] =
                globalIframe.contentDocument.getElementById(
                  container.id
                ).contentWindow.connect;
              //listen to failover state change from other window
              var regionalConnect =
                globalConnect.core.regions[container.region];
              regionalConnect.core
                .getUpstream()
                .onUpstream(
                  regionalConnect.DisasterRecoveryEvents.FAILOVER,
                  function (data) {
                    if (data.isPrimary) {
                      connect = regionalConnect;
                      primaryRegion = connect.core.region;
                      if (uiFailoverEnabled) {
                        activateUI(primaryRegion, globalIframe.id);
                      }
                    } else if (uiFailoverEnabled) {
                      secondaryRegion = regionalConnect.core.region;
                      deactivateUI(secondaryRegion, globalIframe.id);
                    }
                  }
                );
            });
            connect = globalConnect.core.regions[primaryRegion];
            resolve();
          };
          globalIframe.srcdoc = ccpIframes.join("");
          globalContainerDiv.appendChild(globalIframe);
        });
      },
      function (callback) {
        console.error(
          "[Disaster Recovery] An error occured, while attempting to retrieve your primary region;"
        );
        callback();
      }
    );
  };

  var deactivateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height: 0; width: 0; border: 0px";
  };

  var activateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height:800px;width:100%;border:0px";
  };

  var getFailoverRegion = function (primaryRegion) {
    var primaryRegion = primaryRegion || connect.core.region;
    return Object.keys(globalConnect.core.regions).find(function (r) {
      return r !== primaryRegion;
    });
  };

  globalConnect.core.failover = function () {
    globalConnect.core.failoverTo(getFailoverRegion());
  };

  globalConnect.core.failoverTo = function (electedNewPrimaryRegion) {
      validateRegion(electedNewPrimaryRegion);
      var currentPrimaryRegion = getFailoverRegion(electedNewPrimaryRegion);
      deactivate(currentPrimaryRegion);
      activate(electedNewPrimaryRegion);
      connect = globalConnect.core.regions[electedNewPrimaryRegion];
  };

  /**-------------------------------------------------------------------------
   * Deactivates a region
   */
  var deactivate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Deactivating %s region.", connect.core.region)
      .sendInternalLogToServer();
    // call this to suppress contacts
    connect.core.suppressContacts(true);
    connect.core.forceOffline();
  };

  /**-------------------------------------------------------------------------
   * Activates Stand-by region on failover using suppress==false event
   */
  var activate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Activating %s region.", connect.core.region)
      .sendInternalLogToServer();
    connect.core.suppressContacts(false);
  };

  //reference to globalConnect initCCP. This is to mimic the single initialization CCP behavior
  connect.core.initCCP = globalConnect.core.initCCP;
})();

})();
>>>>>>> parent of bde816b (Fix for embedded CCP refreshed scenario)

/******/ 	});
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	__webpack_modules__[944]();
/******/ 	// This entry module is referenced by other modules so it can't be inlined
/******/ 	__webpack_modules__[163]();
/******/ 	__webpack_modules__[891]();
/******/ 	__webpack_modules__[772]();
/******/ 	var __webpack_exports__ = {};
/******/ 	__webpack_modules__[341]();
/******/ 	
/******/ })()
;