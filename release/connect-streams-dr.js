/******/ (() => { // webpackBootstrap
/******/ 	var __webpack_modules__ = ({

/***/ 772:
/***/ (() => {

/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
 
(function () {
  var global = this || globalThis;
  var connect = global.connect || {};
  global.connect = connect;
  global.globalConnect = {}
  global.lily = connect;

  globalConnect.Container = null;

  var FRAME_DIMENSIONS = "margin: 0; border: 0; padding: 0px; width: 0px; height: 0px";

  var LATEST_STREAMJS_BASE64_CODE = "LyoqKioqKi8gKCgpID0+IHsgLy8gd2VicGFja0Jvb3RzdHJhcAovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVzX18gPSAoewoKLyoqKi8gODIxOgovKioqLyAoKCkgPT4gewoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5hZ2VudEFwcCA9IHt9OwoKICB2YXIgQVBQID0gewogICAgQ0NQOiAnY2NwJywKICB9OwoKICBjb25uZWN0LmFnZW50QXBwLmluaXRDQ1AgPSBjb25uZWN0LmNvcmUuaW5pdENDUDsKICBjb25uZWN0LmFnZW50QXBwLmlzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoaW5zdGFuY2VBbGlhcykge307CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcENvbW11bmljYXRpb24gPSBmdW5jdGlvbiAoaWZyYW1lSWQsIGVuZHBvaW50KSB7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWZyYW1lSWQpOwogICAgdmFyIGlmcmFtZUNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KGVuZHBvaW50LCB3aW5kb3csIGlmcmFtZSk7CiAgICB2YXIgQlJPQURDQVNUX1RZUEUgPSBbCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsCiAgICAgIGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsCiAgICAgIGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVECiAgICBdOwogICAgaWZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoZSkgewogICAgICBCUk9BRENBU1RfVFlQRS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbSh0eXBlLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWZyYW1lQ29uZHVpdC5zZW5kVXBzdHJlYW0odHlwZSwgZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIGdldENvbm5lY3RVcmwgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgcG9zID0gY2NwVXJsLmluZGV4T2YoJ2NjcC12MicpOwogICAgcmV0dXJuIGNjcFVybC5zbGljZSgwLCBwb3MgLSAxKTsKICB9OwoKICB2YXIgc2lnbk91dFRocm91Z2hDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgbG9nb3V0VXJsID0gZ2V0Q29ubmVjdFVybChjY3BVcmwpICsgJy9sb2dvdXQnOwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2gobG9nb3V0VXJsLCB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGV2ZW50QnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25uZWN0CiAgICAgICAgLmdldExvZygpCiAgICAgICAgLmVycm9yKCdBbiBlcnJvciBvY2N1cmVkIG9uIGxvZ291dC4nICsgZSkKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBsb2dvdXRVcmw7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogIH07CgogIHZhciBzaWduSW5UaHJvdWdoaW5pdENDUCA9IGZ1bmN0aW9uIChjY3BVcmwsIGNvbnRhaW5lciwgY29uZmlnKSB7CiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgY2NwVXJsOiBjY3BVcmwsCiAgICAgIGNjcExvYWRUaW1lb3V0OiAxMDAwMCwKICAgICAgbG9naW5Qb3B1cDogdHJ1ZSwKICAgICAgbG9naW5Vcmw6IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9naW4nLAogICAgICBzb2Z0cGhvbmU6IHsKICAgICAgICBhbGxvd0ZyYW1lZFNvZnRwaG9uZTogdHJ1ZSwKICAgICAgICBkaXNhYmxlUmluZ3RvbmU6IGZhbHNlLAogICAgICB9CiAgICB9OwogICAgdmFyIGNjcFBhcmFtcyA9IGNvbm5lY3QubWVyZ2UoZGVmYXVsdFBhcmFtcywgY29uZmlnLmNjcFBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENDUChjb250YWluZXIsIGNjcFBhcmFtcyk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwID0gZnVuY3Rpb24gKG5hbWUsIGNvbnRhaW5lcklkLCBhcHBVcmwsIGNvbmZpZykgewogICAgY29uZmlnID0gY29uZmlnID8gY29uZmlnIDoge307CiAgICB2YXIgZW5kcG9pbnQgPSBhcHBVcmwuZW5kc1dpdGgoJy8nKSA/IGFwcFVybCA6IGFwcFVybCArICcvJzsKICAgIHZhciBvbkxvYWQgPSBjb25maWcub25Mb2FkID8gY29uZmlnLm9uTG9hZCA6IG51bGw7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSwgb25Mb2FkOiBvbkxvYWQgfTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgcmVnaXN0ZXJDb25maWcsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKSk7CiAgICBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0YXJ0KG5hbWUsIGZ1bmN0aW9uIChtb2R1bGVEYXRhKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGEuZW5kcG9pbnQ7CiAgICAgIHZhciBjb250YWluZXJET00gPSBtb2R1bGVEYXRhLmNvbnRhaW5lckRPTTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgewogICAgICAgICAgICBjb25maWcuY2NwUGFyYW1zID0gY29uZmlnLmNjcFBhcmFtcyA/IGNvbmZpZy5jY3BQYXJhbXMgOiB7fTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5zdHlsZSkgY29uZmlnLmNjcFBhcmFtcy5zdHlsZSA9IGNvbmZpZy5zdHlsZTsKICAgICAgICAgICAgcmV0dXJuIHNpZ25JblRocm91Z2hpbml0Q0NQKGVuZHBvaW50LCBjb250YWluZXJET00sIGNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbihuYW1lLCBlbmRwb2ludCk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25PdXRUaHJvdWdoQ0NQKGVuZHBvaW50KTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuc3RvcEFwcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5zdG9wKG5hbWUpOwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA1MDA6Ci8qKiovICgoKSA9PiB7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGZ1bmN0aW9uIEFwcFJlZ2lzdHJ5KCkgewogICAgdmFyIG1vZHVsZURhdGEgPSB7fTsKICAgIHZhciBtYWtlQXBwSWZyYW1lID0gZnVuY3Rpb24gKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgICBvbkxvYWQ6IGNvbmZpZy5vbkxvYWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICB2YXIgb25Mb2FkID0gbW9kdWxlRGF0YVthcHBOYW1lXS5vbkxvYWQ7CiAgICAgICAgaWYgKGFwcE5hbWUgIT09IEFQUC5DQ1ApIHsKICAgICAgICAgIHZhciBhcHAgPSBtYWtlQXBwSWZyYW1lKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTY1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0ludmFsaWRMb2NhbGUnLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcsCiAgICAnc2lsZW50X21vbml0b3InLAogICAgJ2JhcmdlJwogIF0pOwogIGNvbm5lY3QuQ29ubmVjdGlvblN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5zZXQoWwogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQsCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuU0lMRU5UX01PTklUT1IsCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQkFSR0UKICBdKTsKCiAgY29ubmVjdC5DT05ORUNUSU9OX0NPTk5FQ1RFRF9TVEFURVMgPSBjb25uZWN0LnNldChbCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLlNJTEVOVF9NT05JVE9SLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkJBUkdFCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgICAnZGlzY29ubmVjdCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ29udGFjdFJlY29yZGluZyBWb2ljZSBUcmFjayBjb25maWcKICAgKi8KICBjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnQUxMJywKICAgICdUT19BR0VOVCcsCiAgICAnRlJPTV9BR0VOVCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgTW9uaXRvcmluZ01vZGUKICAgKi8KICBjb25uZWN0Lk1vbml0b3JpbmdNb2RlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnc2lsZW50X21vbml0b3InLAogICAgJ2JhcmdlJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBNb25pdG9yaW5nRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuTW9uaXRvcmluZ0Vycm9yVHlwZXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbnZhbGlkX3RhcmdldF9zdGF0ZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENoYW5uZWxUeXBlCiAgKi8KICBjb25uZWN0LkNoYW5uZWxUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnVk9JQ0UnLAogICAgJ0NIQVQnLAogICAgJ1RBU0snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBNZWRpYVR5cGUKICAqLwogIGNvbm5lY3QuTWVkaWFUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnc29mdHBob25lJywKICAgICdjaGF0JywKICAgICd0YXNrJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNvZnRwaG9uZUNhbGxUeXBlCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2F1ZGlvX3ZpZGVvJywKICAgICd2aWRlb19vbmx5JywKICAgICdhdWRpb19vbmx5JywKICAgICdub25lJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBTb2Z0cGhvbmVFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndW5zdXBwb3J0ZWRfYnJvd3NlcicsCiAgICAnbWljcm9waG9uZV9ub3Rfc2hhcmVkJywKICAgICdzaWduYWxsaW5nX2hhbmRzaGFrZV9mYWlsdXJlJywKICAgICdzaWduYWxsaW5nX2Nvbm5lY3Rpb25fZmFpbHVyZScsCiAgICAnaWNlX2NvbGxlY3Rpb25fdGltZW91dCcsCiAgICAndXNlcl9idXN5X2Vycm9yJywKICAgICd3ZWJydGNfZXJyb3InLAogICAgJ3JlYWx0aW1lX2NvbW11bmljYXRpb25fZXJyb3InLAogICAgJ290aGVyJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDbGlja1R5cGUKICAgKi8KICBjb25uZWN0LkNsaWNrVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ0FjY2VwdCcsCiAgICAnUmVqZWN0JywKICAgICdIYW5ndXAnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWRFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ25vX3NwZWFrZXJfaWRfZm91bmQnLAogICAgJ3NwZWFrZXJfaWRfbm90X2Vucm9sbGVkJywKICAgICdnZXRfc3BlYWtlcl9pZF9mYWlsZWQnLAogICAgJ2dldF9zcGVha2VyX3N0YXR1c19mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9pbl9sY21zX2ZhaWxlZCcsCiAgICAnZGVsZXRlX3NwZWFrZXJfZmFpbGVkJywKICAgICdzdGFydF9zZXNzaW9uX2ZhaWxlZCcsCiAgICAnZXZhbHVhdGVfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3Nlc3Npb25fbm90X2V4aXN0cycsCiAgICAnZGVzY3JpYmVfc2Vzc2lvbl9mYWlsZWQnLAogICAgJ2Vucm9sbF9zcGVha2VyX2ZhaWxlZCcsCiAgICAndXBkYXRlX3NwZWFrZXJfaWRfZmFpbGVkJywKICAgICd1cGRhdGVfc3BlYWtlcl9pZF9pbl9sY21zX2ZhaWxlZCcsCiAgICAnbm90X3N1cHBvcnRlZF9vbl9jb25mZXJlbmNlX2NhbGxzJywKICAgICdlbnJvbGxfc3BlYWtlcl90aW1lb3V0JywKICAgICdldmFsdWF0ZV9zcGVha2VyX3RpbWVvdXQnLAogICAgJ2dldF9kb21haW5faWRfZmFpbGVkJywKICAgICdub19kb21haW5faWRfZm91bmQnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIENUSSBleGNlcHRpb25zCiAgICovCiAgY29ubmVjdC5DVElFeGNlcHRpb25zID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQWNjZXNzRGVuaWVkRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkU3RhdGVFeGNlcHRpb24iLAogICAgIkJhZEVuZHBvaW50RXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQWdlbnRBUk5FeGNlcHRpb24iLAogICAgIkludmFsaWRDb25maWd1cmF0aW9uRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQ29udGFjdFR5cGVFeGNlcHRpb24iLAogICAgIlBhZ2luYXRpb25FeGNlcHRpb24iLAogICAgIlJlZnJlc2hUb2tlbkV4cGlyZWRFeGNlcHRpb24iLAogICAgIlNlbmREYXRhRmFpbGVkRXhjZXB0aW9uIiwKICAgICJVbmF1dGhvcml6ZWRFeGNlcHRpb24iLAogICAgIlF1b3RhRXhjZWVkZWRFeGNlcHRpb24iCiAgXSk7CiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBzdHJlYW1pbmcgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiT05HT0lORyIsCiAgICAiRU5ERUQiLAogICAgIlBFTkRJTkdfQ09ORklHVVJBVElPTiIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBQ0NFUFQiLAogICAgIlJFSkVDVCIsCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIlNQRUFLRVJfTk9UX0VOUk9MTEVEIiwKICAgICJTUEVBS0VSX09QVEVEX09VVCIsCiAgICAiU1BFQUtFUl9JRF9OT1RfUFJPVklERUQiLAogICAgIlNQRUFLRVJfRVhQSVJFRCIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBmcmF1ZCBkZXRlY3Rpb24gZGVjaXNpb24KICAgKi8KICBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIkhJR0hfUklTSyIsCiAgICAiTE9XX1JJU0siCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIGNvbnRhY3QgZmxvdyBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQXV0aGVudGljYXRlZCIsCiAgICAiTm90QXV0aGVudGljYXRlZCIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbnJvbGxlZCIsCiAgICAiT3B0ZWRPdXQiLAogICAgIk5vdEVuYWJsZWQiLAogICAgIkVycm9yIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgIGZyYXVkIGRldGVjdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiSGlnaFJpc2siLAogICAgIkxvd1Jpc2siLAogICAgIkluY29uY2x1c2l2ZSIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgRW5yb2xsbWVudFJlcXVlc3QgU3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSU5fUFJPR1JFU1MiLAogICAgIkNPTVBMRVRFRCIsCiAgICAiRkFJTEVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIFNwZWFrZXIgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9QVEVEX09VVCIsCiAgICAiRU5ST0xMRUQiLAogICAgIlBFTkRJTkciCiAgXSk7CgogIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cyA9IHsKICAgIEVWQUxVQVRFX1NFU1NJT05fREVMQVk6IDEwMDAwLAogICAgRVZBTFVBVElPTl9NQVhfUE9MTF9USU1FUzogMjQsIC8vIEV2YWx1YXRlU3BlYWtlciBpcyBQb2xsaW5nIGZvciBtYXhpbXVtIDIgbWlucy4KICAgIEVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTDogNTAwMCwKICAgIEVOUk9MTE1FTlRfTUFYX1BPTExfVElNRVM6IDEyMCwgLy8gRW5yb2xsbWVudFNwZWFrZXIgaXMgUG9sbGluZyBmb3IgbWF4aW11bSAxMCBtaW5zLgogICAgRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMOiA1MDAwLAogICAgU1RBUlRfU0VTU0lPTl9ERUxBWTogODAwMAogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29uc3RhbnRzIGZvciBBZ2VudFBlcm1pc3Npb25zCiAgICovCiAgY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zID0gewogICAgT1VUQk9VTkRfQ0FMTDogJ291dGJvdW5kQ2FsbCcsCiAgICBWT0lDRV9JRDogJ3ZvaWNlSWQnLAogICAgQ09OVEFDVF9SRUNPUkRJTkc6ICdjb250YWN0UmVjb3JkaW5nJwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50CiAgICovCiAgdmFyIEFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoIlRoZSBhZ2VudCBpcyBub3QgeWV0IGluaXRpYWxpemVkISIpOwogICAgfQogIH07CgogIEFnZW50LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2NyZWF0ZUNvbnRhY3RBUEkgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUmVmcmVzaCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUm91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Ob3RSb3V0YWJsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25PZmZsaW5lID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNvZnRwaG9uZUVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25HYWluZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25BZnRlckNhbGxXb3JrID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1csIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Mb2NhbE1lZGlhU3RyZWFtQ3JlYXRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNwZWFrZXJEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbk1pY3JvcGhvbmVEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vblJpbmdlckRldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5zdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmV4dFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5uZXh0U3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEF2YWlsYWJpbGl0eVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5hZ2VudEF2YWlsYWJpbGl0eVN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc25hcHNob3Quc3RhdGUuc3RhcnRUaW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQWdlbnQucHJvdG90eXBlLmdldFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnBlcm1pc3Npb25zOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb250YWN0cyA9IGZ1bmN0aW9uIChjb250YWN0VHlwZUZpbHRlcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5jb250YWN0cy5tYXAoZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVDb250YWN0QVBJKGNvbnRhY3REYXRhKTsKICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gKCFjb250YWN0VHlwZUZpbHRlcikgfHwgY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbnRhY3RUeXBlRmlsdGVyOwogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbmZpZ3VyYXRpb247CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFnZW50U3RhdGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmFnZW50U3RhdGVzOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5ID0gZnVuY3Rpb24gKGNoYW5uZWwpIHsKICAgIHZhciBjaGFubmVsQ29uY3VycmVuY3lNYXAgPSB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuY2hhbm5lbENvbmN1cnJlbmN5TWFwOwogICAgaWYgKCFjaGFubmVsQ29uY3VycmVuY3lNYXApIHsKICAgICAgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gT2JqZWN0LmtleXMoY29ubmVjdC5DaGFubmVsVHlwZSkucmVkdWNlKGZ1bmN0aW9uIChhY2MsIGtleSkgewogICAgICAgIC8vIEV4Y2x1ZGUgVEFTSyBmcm9tIGRlZmF1bHQgY29uY3VycmVuY3kuCiAgICAgICAgaWYgKGtleSAhPT0gJ1RBU0snKSB7CiAgICAgICAgICBhY2NbY29ubmVjdC5DaGFubmVsVHlwZVtrZXldXSA9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhY2M7CiAgICAgIH0sIHt9KTsKICAgIH0KICAgIHJldHVybiBjaGFubmVsCiAgICAgID8gKGNoYW5uZWxDb25jdXJyZW5jeU1hcFtjaGFubmVsXSB8fCAwKQogICAgICA6IGNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5uYW1lOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFeHRlbnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZXh0ZW5zaW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXREaWFsYWJsZUNvdW50cmllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5kaWFsYWJsZUNvdW50cmllczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuaXNTb2Z0cGhvbmVFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUVuYWJsZWQ7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgaWYgKGNvbmZpZ3VyYXRpb24gJiYgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzICYmIGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRSAmJiAhY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSkgewogICAgICAvLyB3b3JrYXJvdW5kIGZvciB0aGUgaW5jb25zaXN0ZW5jeSBpc3N1ZSB0aGF0IGdldEFnZW50Q29uZmlndXJhdGlvbiByZXR1cm5zIGFnZW50UHJlZmVyZW5jZXMuTEFOR1VBR0UgYnV0IHVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiBleHBlY3RzIGFnZW50UHJlZmVyZW5jZXMubG9jYWxlIHRvIGJlIHNldC4KICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSA9IGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRTsKICAgIH0KCiAgICBpZiAoY29uZmlndXJhdGlvbiAmJiBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMgJiYgIWNvbm5lY3QuaXNWYWxpZExvY2FsZShjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMubG9jYWxlKSkgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzLklOVkFMSURfTE9DQUxFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OLCB7CiAgICAgICAgY29uZmlndXJhdGlvbjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmZpZ3VyYXRpb24sICdjb25maWd1cmF0aW9uJykKICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBhc2sgdGhlIHNoYXJlZCB3b3JrZXIgdG8gcmVsb2FkIGFnZW50IGNvbmZpZwogICAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjYWxsYmFja3MsIG9wdGlvbnMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUFVUX0FHRU5UX1NUQVRFLCB7CiAgICAgIHN0YXRlOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3RhdGUsICdzdGF0ZScpLAogICAgICBlbnF1ZXVlTmV4dFN0YXRlOiBvcHRpb25zICYmICEhb3B0aW9ucy5lbnF1ZXVlTmV4dFN0YXRlCiAgICB9LCBjYWxsYmFja3MpOwogIH07CiAgQWdlbnQucHJvdG90eXBlLm9uRW5xdWV1ZWROZXh0U3RhdGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVOUVVFVUVEX05FWFRfU1RBVEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5jb25uZWN0ID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIHBhcmFtcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfT1VUQk9VTkRfQ09OVEFDVCwgewogICAgICBlbmRwb2ludDogY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKSwKICAgICAgcXVldWVBUk46IChwYXJhbXMgJiYgKHBhcmFtcy5xdWV1ZUFSTiB8fCBwYXJhbXMucXVldWVJZCkpIHx8IHRoaXMuZ2V0Um91dGluZ1Byb2ZpbGUoKS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTgogICAgfSwgcGFyYW1zICYmIHsKICAgICAgICBzdWNjZXNzOiBwYXJhbXMuc3VjY2VzcywKICAgICAgICBmYWlsdXJlOiBwYXJhbXMuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWxsUXVldWVBUk5zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5tYXAoZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgIHJldHVybiBxdWV1ZS5xdWV1ZUFSTjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFbmRwb2ludHMgPSBmdW5jdGlvbiAocXVldWVBUk5zLCBjYWxsYmFja3MsIHBhZ2VJbmZvSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLCAiY2FsbGJhY2tzIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLnN1Y2Nlc3MsICJjYWxsYmFja3Muc3VjY2VzcyIpOwogICAgdmFyIHBhZ2VJbmZvID0gcGFnZUluZm9JbiB8fCB7IH07CgogICAgcGFnZUluZm8uZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzIHx8IFtdOwogICAgcGFnZUluZm8ubWF4UmVzdWx0cyA9IHBhZ2VJbmZvLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgYWxsb3dpbmcgYSBzaW5nbGUgcXVldWVBUk4gdG8gYmUgc3BlY2lmaWVkCiAgICAvLyBpbnN0ZWFkIG9mIGFuIGFycmF5LgogICAgaWYgKCFjb25uZWN0LmlzQXJyYXkocXVldWVBUk5zKSkgewogICAgICBxdWV1ZUFSTnMgPSBbcXVldWVBUk5zXTsKICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0VORFBPSU5UUywgewogICAgICBxdWV1ZUFSTnM6IHF1ZXVlQVJOcywKICAgICAgbmV4dFRva2VuOiBwYWdlSW5mby5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFnZUluZm8ubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5nZXRFbmRwb2ludHMocXVldWVBUk5zLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMsCiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5jb25jYXQoZGF0YS5lbmRwb2ludHMpOwogICAgICAgICAgICB2YXIgZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHsKICAgICAgICAgICAgICBlbmRwb2ludHM6IGVuZHBvaW50cywKICAgICAgICAgICAgICBhZGRyZXNzZXM6IGVuZHBvaW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZGRyZXNzZXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzOwoKICAvL0ludGVybmFsIGlkZW50aWZpZXIuCiAgQWdlbnQucHJvdG90eXBlLl9nZXRSZXNvdXJjZUlkID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcXVldWVBcm5zID0gdGhpcy5nZXRBbGxRdWV1ZUFSTnMoKTsKICAgIGZvciAobGV0IHF1ZXVlQXJuIG9mIHF1ZXVlQXJucykgewogICAgICBjb25zdCBhZ2VudElkTWF0Y2ggPSBxdWV1ZUFybi5tYXRjaCgvXC9hZ2VudFwvKFteL10rKS8pOwoKICAgICAgaWYgKGFnZW50SWRNYXRjaCkgewogICAgICAgIHJldHVybiBhZ2VudElkTWF0Y2hbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgRXJyb3IoIkFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZDogcXVldWVBcm5zIGRpZCBub3QgY29udGFpbiBhZ2VudFJlc291cmNlSWQ6ICIsIHF1ZXVlQXJucyk7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5BZ2VudFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRTbmFwc2hvdAogICAqLwogIHZhciBBZ2VudFNuYXBzaG90ID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgY29ubmVjdC5BZ2VudC5jYWxsKHRoaXMpOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAgfTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWdlbnQucHJvdG90eXBlKTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50U25hcHNob3Q7CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0CiAgICovCiAgdmFyIENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgdGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkluY29taW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0aW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbk1pc3NlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVuZGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKSwgZik7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BQ1cgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUiksIGYpOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsQ29udGFjdElkOwogIH07CiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbnRhY3RJZCA9IENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3REdXJhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RHVyYXRpb247CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZVRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWVUaW1lc3RhbXA7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbm5lY3Rpb25zLm1hcChmdW5jdGlvbiAoY29ubkRhdGEpIHsKICAgICAgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCk7CiAgICB9KSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFjdGl2ZUluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYWxDb25uID0gdGhpcy5nZXRJbml0aWFsQ29ubmVjdGlvbigpOwogICAgaWYgKGluaXRpYWxDb25uICE9IG51bGwgJiYgaW5pdGlhbENvbm4uaXNBY3RpdmUoKSkgewogICAgICByZXR1cm4gaW5pdGlhbENvbm47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gIWNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpICYmIGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U2luZ2xlQWN0aXZlVGhpcmRQYXJ0eUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgIH0pWzBdIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWdlbnRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHZhciBjb25uVHlwZSA9IGNvbm4uZ2V0VHlwZSgpOwogICAgICByZXR1cm4gY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgfHwgY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm5hbWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdE1ldGFkYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0TWV0YWRhdGE7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXREZXNjcmlwdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZGVzY3JpcHRpb247CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UmVmZXJlbmNlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucmVmZXJlbmNlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5hdHRyaWJ1dGVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdEZlYXR1cmVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENoYW5uZWxDb250ZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jaGFubmVsQ29udGV4dDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc1NvZnRwaG9uZUNhbGwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U29mdHBob25lTWVkaWFJbmZvKCkgIT0gbnVsbDsKICAgIH0pICE9IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuX2lzSW5ib3VuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbml0aWF0aW9uTWV0aG9kID0gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYXRpb25NZXRob2Q7CiAgICByZXR1cm4gKGluaXRpYXRpb25NZXRob2QgPT09IGNvbm5lY3QuQ29udGFjdEluaXRpYXRpb25NZXRob2QuT1VUQk9VTkQpID8gZmFsc2UgOiB0cnVlOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuaXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm4gPSB0aGlzLmdldEluaXRpYWxDb25uZWN0aW9uKCk7CgogICAgLy8gV2Ugd2lsbCBncmFkdWFsbHkgY2hhbmdlIGNoZWNraW5nIGluYm91bmQgYnkgcmVseWluZyBvbiBjb250YWN0IGluaXRpYXRpb25NZXRob2QKICAgIGlmIChjb25uLmdldE1lZGlhVHlwZSgpID09PSBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiB0aGlzLl9pc0luYm91bmQoKTsKICAgIH0KCiAgICByZXR1cm4gY29ubiA/IGNvbm4uZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLklOQk9VTkQgOiBmYWxzZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWNjZXB0ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjb250YWN0SWQgPSB0aGlzLmdldENvbnRhY3RJZCgpOwoKICAgIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2xpY2tUeXBlOiBjb25uZWN0LkNsaWNrVHlwZS5BQ0NFUFQsCiAgICAgIGNsaWNrVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICB9KTsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQUNDRVBUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIHNlbGYuZ2V0Q29udGFjdElkKCkpLAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEluIEZpcmVmb3gsIHRoZXJlJ3MgYSBicm93c2VyIHJlc3RyaWN0aW9uIHRoYXQgYW4gdW5mb2N1c2VkIGJyb3dzZXIgdGFiIGlzIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICAvLyBUaGUgcHJvYmxlbSBpcyB0aGF0IHRoZSByZXN0cmljdGlvbiBjb3VsZCBjYXVzZSBhIHdlYnJ0YyBzZXNzaW9uIGNyZWF0aW9uIHRpbWVvdXQgZXJyb3Igd2hlbiB5b3UgZ2V0IGFuIGluY29taW5nIGNhbGwgd2hpbGUgeW91IGFyZSBub3Qgb24gdGhlIHByaW1hcnkgdGFiLgogICAgICAgICAgLy8gSXQgd2FzIGhhcmQgdG8gd29ya2Fyb3VuZCB0aGUgaXNzdWUgZXNwZWNpYWxseSB3aGVuIHlvdSBoYXZlIG11bHRpcGxlIHRhYnMgb3BlbiBiZWNhdXNlIHlvdSBuZWVkZWQgdG8gZmluZCB0aGUgcmlnaHQgdGFiIGFuZCBhY2NlcHQgdGhlIGNvbnRhY3QgYmVmb3JlIHRoZSB0aW1lb3V0LgogICAgICAgICAgLy8gVG8gYXZvaWQgdGhlIGVycm9yLCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4gaW4gRmlyZWZveCwgYSB3ZWJydGMgc2Vzc2lvbiBpcyBub3QgaW1tZWRpYXRlbHkgY3JlYXRlZCBhcyBhbiBpbmNvbWluZyBzb2Z0cGhvbmUgY29udGFjdCBpcyBkZXRlY3RlZC4KICAgICAgICAgIC8vIEluc3RlYWQsIGl0IHdhaXRzIHVudGlsIGNvbnRhY3QuYWNjZXB0KCkgaXMgY2FsbGVkIG9uIGEgdGFiIGFuZCBsZXRzIHRoZSB0YWIgYmVjb21lIHRoZSBuZXcgcHJpbWFyeSB0YWIgYW5kIHN0YXJ0IHRoZSB3ZWIgcnRjIHNlc3Npb24gdGhlcmUKICAgICAgICAgIC8vIGJlY2F1c2UgdGhlIHRhYiBzaG91bGQgYmUgZm9jdXNlZCBhdCB0aGUgbW9tZW50IGFuZCBoYXZlIGFjY2VzcyB0byB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICB2YXIgY29udGFjdCA9IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKTsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcyA/IGNhbGxiYWNrcy5mYWlsdXJlIDogbnVsbAogICAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJjb250YWN0LmRlc3Ryb3koKSBoYXMgYmVlbiBkZXByZWNhdGVkLiIpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjbGlja1R5cGU6IGNvbm5lY3QuQ2xpY2tUeXBlLlJFSkVDVCwKICAgICAgY2xpY2tUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH0pOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY29tcGxldGUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DTEVBUl9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5ub3RpZnlJc3N1ZSA9IGZ1bmN0aW9uIChpc3N1ZUNvZGUsIGRlc2NyaXB0aW9uLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTk9USUZZX0NPTlRBQ1RfSVNTVUUsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBpc3N1ZUNvZGU6IGlzc3VlQ29kZSwKICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmFkZENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoZW5kcG9pbnRJbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGVuZHBvaW50ID0gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnRJbik7CiAgICAvLyBIYXZlIHRvIHJlbW92ZSB0aGUgZW5kcG9pbnRJZCBmaWVsZCBvciBBV1MgSlMgU0RLIGdldHMgbWFkLgogICAgZGVsZXRlIGVuZHBvaW50LmVuZHBvaW50SWQ7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9BRERJVElPTkFMX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBlbmRwb2ludDogZW5kcG9pbnQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUudG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB2YXIgaG9sZGluZ0Nvbm4gPSBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICAgIH0pOwoKICAgIGlmIChob2xkaW5nQ29ubiAhPSBudWxsKSB7CiAgICAgIGNvbm5lY3Rpb25JZCA9IGhvbGRpbmdDb25uLmdldENvbm5lY3Rpb25JZCgpOwoKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhY3RpdmVDb25ucyA9IHRoaXMuZ2V0Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgICByZXR1cm4gY29ubi5pc0FjdGl2ZSgpOwogICAgICB9KTsKICAgICAgaWYgKGFjdGl2ZUNvbm5zLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25uZWN0aW9uSWQgPSBhY3RpdmVDb25uc1swXS5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgfQogICAgfQoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5UT0dHTEVfQUNUSVZFX0NPTk5FQ1RJT05TLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiBjb25uZWN0aW9uSWQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuc2VuZFNvZnRwaG9uZU1ldHJpY3MgPSBmdW5jdGlvbiAoc29mdHBob25lU3RyZWFtU3RhdGlzdGljcywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX01FVFJJQ1MsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgc29mdHBob25lU3RyZWFtU3RhdGlzdGljczogc29mdHBob25lU3RyZWFtU3RhdGlzdGljcwogICAgfSwgY2FsbGJhY2tzKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVTdGF0cyh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHN0YXRzOiBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzCiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5zZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKHJlcG9ydCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfUkVQT1JULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9LCBjYWxsYmFja3MpOwoKICAgIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVJlcG9ydCh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jb25mZXJlbmNlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTkZFUkVOQ0VfQ09OTkVDVElPTlMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnRvU25hcHNob3QgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuaXNNdWx0aVBhcnR5Q29uZmVyZW5jZUVuYWJsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29udGFjdEZlYXR1cmVzID0gdGhpcy5nZXRDb250YWN0RmVhdHVyZXMoKTsKICAgIHJldHVybiAhIShjb250YWN0RmVhdHVyZXMgJiYgY29udGFjdEZlYXR1cmVzLm11bHRpUGFydHlDb25mZXJlbmNlRW5hYmxlZCk7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS51cGRhdGVNb25pdG9yUGFydGljaXBhbnRTdGF0ZSA9IGZ1bmN0aW9uICh0YXJnZXRTdGF0ZSwgY2FsbGJhY2tzKSB7CiAgICBpZighdGFyZ2V0U3RhdGUgfHwgIU9iamVjdC52YWx1ZXMoY29ubmVjdC5Nb25pdG9yaW5nTW9kZSkuaW5jbHVkZXModGFyZ2V0U3RhdGUpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoYEludmFsaWQgdGFyZ2V0IHN0YXRlIHdhcyBwcm92aWRlZDogJHt0YXJnZXRTdGF0ZX1gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5Nb25pdG9yaW5nRXJyb3JUeXBlcy5JTlZBTElEX1RBUkdFVF9TVEFURSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfTU9OSVRPUl9QQVJUSUNJUEFOVF9TVEFURSwgewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgICB0YXJnZXRNb25pdG9yTW9kZTogdGFyZ2V0U3RhdGUudG9VcHBlckNhc2UoKQogICAgICB9LCBjYWxsYmFja3MpOwogICAgfQogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuaXNVbmRlclN1cGVydmlzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIG5vbkFnZW50Q29ubmVjdGlvbnMgPSB0aGlzLmdldENvbm5lY3Rpb25zKCkuZmlsdGVyKChjb25uKSA9PiBjb25uLmdldFR5cGUoKSAhPT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCk7CiAgICB2YXIgc3VwZXJ2aXNvckNvbm5lY3Rpb24gPSBub25BZ2VudENvbm5lY3Rpb25zICYmIG5vbkFnZW50Q29ubmVjdGlvbnMuZmluZChjb25uID0+IGNvbm4uZ2V0U3RhdGUoKS50eXBlID09PSBjb25uZWN0Lk1vbml0b3JpbmdNb2RlLkJBUkdFKTsKICAgIHJldHVybiBzdXBlcnZpc29yQ29ubmVjdGlvbiAhPT0gdW5kZWZpbmVkOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29udGFjdFNuYXBzaG90CiAgICovCiAgdmFyIENvbnRhY3RTbmFwc2hvdCA9IGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgY29ubmVjdC5Db250YWN0LmNhbGwodGhpcywgY29udGFjdERhdGEuY29udGFjdElkKTsKICAgIHRoaXMuY29udGFjdERhdGEgPSBjb250YWN0RGF0YTsKICB9OwogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbnRhY3QucHJvdG90eXBlKTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29udGFjdFNuYXBzaG90OwoKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdERhdGE7CiAgfTsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdChjb25uZWN0aW9uRGF0YSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29ubmVjdGlvbgogICAqLwogIHZhciBDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICAgIHRoaXMuY29ubmVjdGlvbklkID0gY29ubmVjdGlvbklkOwogICAgdGhpcy5faW5pdE1lZGlhQ29udHJvbGxlcigpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbm5lY3Rpb25EYXRhKAogICAgICB0aGlzLmdldENvbnRhY3RJZCgpLCB0aGlzLmdldENvbm5lY3Rpb25JZCgpKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRDb250YWN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb250YWN0SWQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbklkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEVuZHBvaW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkVuZHBvaW50KHRoaXMuX2dldERhdGEoKS5lbmRwb2ludCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0QWRkcmVzcyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEVuZHBvaW50OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnR5cGU7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuaW5pdGlhbDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0FjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCB0aGlzLmdldFN0YXR1cygpLnR5cGUpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29udGFpbnMoY29ubmVjdC5DT05ORUNUSU9OX0NPTk5FQ1RFRF9TVEFURVMsIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNDb25uZWN0aW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkc7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNPbkhvbGQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICAvKioKICAgKiBHZXRzIHRoZSBjdXJyZW50bHkgbW9uaXRvcmVkIGNvbnRhY3QgaW5mbywgUmV0dXJucyBudWxsIGlmIGRvZXMgbm90IGV4aXN0cy4KICAgKiBAcmV0dXJuIHt7YWdlbnROYW1lOnN0cmluZywgY3VzdG9tZXJOYW1lOnN0cmluZywgam9pblRpbWU6RGF0ZX19CiAgICovCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm1vbml0b3JpbmdJbmZvOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICBjb25uZWN0LnB1Ymxpc2hDbGlja1N0cmVhbURhdGEoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNsaWNrVHlwZTogY29ubmVjdC5DbGlja1R5cGUuSEFOR1VQLAogICAgICBjbGlja1RpbWU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgfSk7CgogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5ERVNUUk9ZX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuc2VuZERpZ2l0cyA9IGZ1bmN0aW9uIChkaWdpdHMsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0RJR0lUUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKSwKICAgICAgZGlnaXRzOiBkaWdpdHMKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaG9sZCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuSE9MRF9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVTVU1FX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmdldE1lZGlhSW5mbygpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpLmNhdGNoKGZ1bmN0aW9uICgpIHsgfSk7CiAgICB9CiAgfQoKICAvLyBNZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbgogIC8vICh0eXBlIEFHRU5UIG9yIE1PTklUT1JJTkcpCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25uZWN0aW9uVHlwZSA9IHRoaXMuZ2V0VHlwZSgpOwogICAgcmV0dXJuIGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UCiAgICAgIHx8IGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLk1PTklUT1JJTkc7CiAgfQoKICAvKioKICAgKiBVdGlsaXR5IG1ldGhvZCBmb3IgY2hlY2tpbmcgd2hldGhlciB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uCiAgICogKHR5cGUgQUdFTlQgb3IgTU9OSVRPUklORykKICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24uIEZhbHNlIG90aGVyd2lzZS4KICAgKi8KICBDb25uZWN0aW9uLnByb3RvdHlwZS5faXNBZ2VudENvbm5lY3Rpb25UeXBlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm5lY3Rpb25UeXBlID0gdGhpcy5nZXRUeXBlKCk7CiAgICByZXR1cm4gY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CiAgCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBDb250YWN0IHJlY29yZGluZwogICovCgogIHZhciBDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShjb250YWN0SWQpID8gY29udGFjdElkIDogbnVsbDsKICB9CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0YXJ0Q29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKHRyYWNrQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHZhciByZWNvcmRpbmdUcmFjayA9ICh0cmFja0NvbmZpZyAmJiBPYmplY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcpLmluY2x1ZGVzKHRyYWNrQ29uZmlnKSkgPyB0cmFja0NvbmZpZyA6IGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcuQUxMOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJ2b2ljZVJlY29yZGluZ0NvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAidm9pY2VSZWNvcmRpbmdUcmFjayI6IHJlY29yZGluZ1RyYWNrCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygic3RhcnRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdGFydENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIiwgeyBjYXVzZTogZXJyIH0pKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH07CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0b3BDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNUT1BfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJzdG9wQ29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0b3BDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdG9wQ29udGFjdFJlY29yZGluZyBmYWlsZWQiLCB7IGNhdXNlOiBlcnIgfSkpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKCiAgQ29udGFjdFJlY29yZGluZy5wcm90b3R5cGUuc3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQsIGNvbnRhY3REYXRhOwoKICAgIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1VTUEVORF9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyLAogICAgICAgICAgICAgIGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoRXJyb3IoInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIsIHsgY2F1c2U6IGVyciB9KSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5yZXN1bWVDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlJFU1VNRV9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgc3VjY2VlZGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLCB7IGNhdXNlOiBlcnIgfSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFZvaWNlIGF1dGhlbnRpY2F0b3IgVm9pY2VJZAogICovCgogIHZhciBWb2ljZUlkID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICJjb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiaW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAiYXdzQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCkKICAgICAgfTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRTcGVha2VySWQgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkdFVF9DT05UQUNULCBwYXJhbXMsIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuY29udGFjdERhdGEuY3VzdG9tZXJJZCkgewogICAgICAgICAgICAgIHZhciBvYmogPSB7CiAgICAgICAgICAgICAgICBzcGVha2VySWQ6IGRhdGEuY29udGFjdERhdGEuY3VzdG9tZXJJZAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFNwZWFrZXJJZCBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVzb2x2ZShvYmopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuTk9fU1BFQUtFUl9JRF9GT1VORCwgIk5vIHNwZWFrZXJJZCBhc3NvdGlhdGVkIHdpdGggdGhpcyBjYWxsIik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkdldCBTcGVha2VySWQgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX1NQRUFLRVJfSURfRkFJTEVELCAiR2V0IFNwZWFrZXJJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlclN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlcklkKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGRhdGEuc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0U3BlYWtlclN0YXR1cyBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFU0NSSUJFX1NQRUFLRVIsIHBhcmFtcywgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFNwZWFrZXJTdGF0dXMgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICAgIHZhciBwYXJzZWRFcnIgPSBKU09OLnBhcnNlKGVycik7CiAgICAgICAgICAgICAgICBzd2l0Y2gocGFyc2VkRXJyLnN0YXR1cykgewogICAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgICAgY2FzZSA0MDQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBwYXJzZWRFcnI7CiAgICAgICAgICAgICAgICAgICAgZGF0YS50eXBlID0gZGF0YS50eXBlID8gZGF0YS50eXBlIDogY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TUEVBS0VSX0lEX05PVF9FTlJPTExFRDsKICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlNwZWFrZXIgaXMgbm90IGVucm9sbGVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRTcGVha2VyU3RhdHVzIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX1NQRUFLRVJfU1RBVFVTX0ZBSUxFRCwgIkdldCBTcGVha2VyU3RhdHVzIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgLy8gaW50ZXJuYWwgb25seQogIFZvaWNlSWQucHJvdG90eXBlLl9vcHRPdXRTcGVha2VySW5MY21zID0gZnVuY3Rpb24gKHNwZWFrZXJJZCwgZ2VuZXJhdGVkU3BlYWtlcklkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICJDb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAiQVdTQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCksCiAgICAgICAgIkN1c3RvbWVySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgIlZvaWNlSWRSZXN1bHQiOiB7CiAgICAgICAgICAiU3BlYWtlck9wdGVkT3V0IjogdHJ1ZSwKICAgICAgICAgICJnZW5lcmF0ZWRTcGVha2VySWQiOiBnZW5lcmF0ZWRTcGVha2VySWQKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiX29wdE91dFNwZWFrZXJJbkxjbXMgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlVQREFURV9WT0lDRV9JRF9EQVRBLCBwYXJhbXMsIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygib3B0T3V0U3BlYWtlckluTGNtcyBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJvcHRPdXRTcGVha2VySW5MY21zIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLk9QVF9PVVRfU1BFQUtFUl9JTl9MQ01TX0ZBSUxFRCwgIm9wdE91dFNwZWFrZXJJbkxjbXMgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUub3B0T3V0U3BlYWtlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlcklkKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgdmFyIHNwZWFrZXJJZCA9IGRhdGEuc3BlYWtlcklkOwogICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH07CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXIgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5PUFRfT1VUX1NQRUFLRVIsIHBhcmFtcywgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9vcHRPdXRTcGVha2VySW5MY21zKHNwZWFrZXJJZCwgZGF0YS5nZW5lcmF0ZWRTcGVha2VySWQpLmNhdGNoKGZ1bmN0aW9uKCl7fSk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIm9wdE91dFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfRkFJTEVELCAib3B0T3V0U3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlbGV0ZVNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChkYXRhLnNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH07CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlbGV0ZVNwZWFrZXIgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5ERUxFVEVfU1BFQUtFUiwgcGFyYW1zLCB7CiAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZGVsZXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZGVsZXRlU3BlYWtlciBmYWlsZWQiKQogICAgICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkRFTEVURV9TUEVBS0VSX0ZBSUxFRCwgImRlbGV0ZVNwZWFrZXIgZmFpbGVkLiIsIGVycik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5zdGFydFNlc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICJjb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICAgImN1c3RvbWVyQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCksCiAgICAgICAgICAiY2xpZW50VG9rZW4iOiBBV1MudXRpbC51dWlkLnY0KCksCiAgICAgICAgICAiZG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICB9OwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygic3RhcnRTZXNzaW9uIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNUQVJUX1ZPSUNFX0lEX1NFU1NJT04sIHBhcmFtcywgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGlmKGRhdGEuc2Vzc2lvbklkKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCwgbm8gc2Vzc2lvbiBpZCByZXR1cm5lZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNUQVJUX1NFU1NJT05fRkFJTEVELCAiTm8gc2Vzc2lvbiBpZCByZXR1cm5lZCBmcm9tIHN0YXJ0IHNlc3Npb24gYXBpIik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TVEFSVF9TRVNTSU9OX0ZBSUxFRCwgInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyID0gZnVuY3Rpb24gKHN0YXJ0TmV3KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgcG9sbFRpbWVzID0gMDsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH07CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkVWQUxVQVRFX1NFU1NJT04sIHBhcmFtcywgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGlmKCsrcG9sbFRpbWVzIDwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRJT05fTUFYX1BPTExfVElNRVMpIHsKICAgICAgICAgICAgICAgIGlmKGRhdGEuU3RyZWFtaW5nU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRTdHJlYW1pbmdTdGF0dXMuUEVORElOR19DT05GSUdVUkFUSU9OKSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZXZhbHVhdGUsIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FVkFMVUFUSU9OX1BPTExJTkdfSU5URVJWQUwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaWYoIWRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZighZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQgPSB7fTsKICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmUgaWYgYm90aCBhdXRoZW50aWNhdGlvbiBhbmQgZnJhdWQgZGV0ZWN0aW9uIGFyZSBub3QgZW5hYmxlZC4KICAgICAgICAgICAgICAgICAgaWYoIXNlbGYuaXNBdXRoRW5hYmxlZChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgICFzZWxmLmlzRnJhdWRFbmFibGVkKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZihkYXRhLlN0cmVhbWluZ1N0YXR1cyA9PT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gVm9pY2UgcHJpbnQgaXMgbm90IGxvbmcgZW5vdWdoIGZvciBib3RoIGF1dGhlbnRpY2F0aW9uIGFuZCBmcmF1ZCBkZXRlY3Rpb24KICAgICAgICAgICAgICAgICAgaWYoc2VsZi5pc0F1dGhSZXN1bHRJbmNvbmNsdXNpdmUoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRSZXN1bHRJbmNvbmNsdXNpdmUoZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZXZhbHVhdGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgIHNlbGYuaXNBdXRoRW5hYmxlZChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkFDQ0VQVDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkFVVEhFTlRJQ0FURUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlJFSkVDVDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5TUEVBS0VSX09QVEVEX09VVDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk9QVEVEX09VVDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uU1BFQUtFUl9OT1RfRU5ST0xMRUQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLkVSUk9SOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIXNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgIHNlbGYuaXNGcmF1ZEVuYWJsZWQoZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5ISUdIX1JJU0s6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5ISUdIX1JJU0s7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkxPV19SSVNLOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTE9XX1JJU0s7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkVSUk9SOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIXNlbGYuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgIXNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZSBvbmx5IHdoZW4gYm90aCBhdXRoZW50aWNhdGlvbiBhbmQgZnJhdWQgZGV0ZWN0aW9uIGhhdmUgcmVzdWx0cy4gT3RoZXJ3aXNlLCBrZWVwIHBvbGxpbmcuCiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZXZhbHVhdGUsIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FVkFMVUFUSU9OX1BPTExJTkdfSU5URVJWQUwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciB0aW1lb3V0Iikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRVZBTFVBVEVfU1BFQUtFUl9USU1FT1VULCAiZXZhbHVhdGVTcGVha2VyIHRpbWVvdXQiKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yOwogICAgICAgICAgICAgIHZhciBwYXJzZWRFcnIgPSBKU09OLnBhcnNlKGVycik7CiAgICAgICAgICAgICAgc3dpdGNoKHBhcnNlZEVyci5zdGF0dXMpIHsKICAgICAgICAgICAgICAgIGNhc2UgNDAwOgogICAgICAgICAgICAgICAgY2FzZSA0MDQ6CiAgICAgICAgICAgICAgICAgIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TRVNTSU9OX05PVF9FWElTVFMsICJldmFsdWF0ZVNwZWFrZXIgZmFpbGVkLCBzZXNzaW9uIG5vdCBleGlzdHMiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJldmFsdWF0ZVNwZWFrZXIgZmFpbGVkLCBzZXNzaW9uIG5vdCBleGlzdHMiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRVZBTFVBVEVfU1BFQUtFUl9GQUlMRUQsICJldmFsdWF0ZVNwZWFrZXIgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmKCFzdGFydE5ldykgewogICAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgZXZhbHVhdGUoKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzeW5jU3BlYWtlcklkIGZhaWxlZCB3aGVuIHNlc3Npb24gc3RhcnROZXc9ZmFsc2UiKQogICAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVEVfU0VTU0lPTl9ERUxBWSk7CiAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3luY1NwZWFrZXJJZCBmYWlsZWQgd2hlbiBzZXNzaW9uIHN0YXJ0TmV3PXRydWUiKQogICAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFNlc3Npb24gZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz10cnVlIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7ZXJyOiBlcnJ9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KGVycikKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZGVzY3JpYmVTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgIlNlc3Npb25OYW1lT3JJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICB9OwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZGVzY3JpYmVTZXNzaW9uIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFU0NSSUJFX1NFU1NJT04sIHBhcmFtcywgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkRFU0NSSUJFX1NFU1NJT05fRkFJTEVELCAiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuY2hlY2tFbnJvbGxtZW50U3RhdHVzID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJjaGVja0Vucm9sbG1lbnRTdGF0dXMgY2FsbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwb2xsaW5nVGltZXMgPSAwOwogICAgdmFyIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZUhhc0JlZW5JbnZva2VkID0gZmFsc2U7CgogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZnVuY3Rpb24gZGVzY3JpYmUgKCkgewogICAgICAgIGlmKCsrcG9sbGluZ1RpbWVzIDwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfTUFYX1BPTExfVElNRVMpIHsKICAgICAgICAgIHNlbGYuZGVzY3JpYmVTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICAgICAgc3dpdGNoKGRhdGEuU2Vzc2lvbi5FbnJvbGxtZW50UmVxdWVzdERldGFpbHMuU3RhdHVzKSB7CiAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5DT01QTEVURUQ6CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5JTl9QUk9HUkVTUzoKICAgICAgICAgICAgICAgIGlmICghY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgJiYgdHlwZW9mIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUoZGF0YSk7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZUhhc0JlZW5JbnZva2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZGVzY3JpYmUsIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FTlJPTExNRU5UX1BPTExJTkdfSU5URVJWQUwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5OT1RfRU5PVUdIX1NQRUVDSDoKICAgICAgICAgICAgICAgIGlmKGRhdGEuU2Vzc2lvbi5TdHJlYW1pbmdTdGF0dXMgIT09IGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cy5FTkRFRCkgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGRlc2NyaWJlLGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FTlJPTExNRU5UX1BPTExJTkdfSU5URVJWQUwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgICBkZXNjcmliZSgpOwogICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVyciwgZGF0YSl7CiAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLlNUQVJUX1NFU1NJT05fREVMQVkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5NZXNzYWdlID8gZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5NZXNzYWdlIDogImVucm9sbFNwZWFrZXIgZmFpbGVkLiBVbmtub3duIGVucm9sbG1lbnQgc3RhdHVzIGhhcyBiZWVuIHJlY2VpdmVkIjsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IobWVzc2FnZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAJCSAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVOUk9MTF9TUEVBS0VSX0ZBSUxFRCwgbWVzc2FnZSwgZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5TdGF0dXMpOwogIAkJICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJlbnJvbGxTcGVha2VyIHRpbWVvdXQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5FTlJPTExfU1BFQUtFUl9USU1FT1VULCAiZW5yb2xsU3BlYWtlciB0aW1lb3V0Iik7CiAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgIH0KICAgICAgfQogICAgICBkZXNjcmliZSgpOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZW5yb2xsU3BlYWtlciA9IGZ1bmN0aW9uIChjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZW5yb2xsU3BlYWtlciBjYWxsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5nZXRTcGVha2VyU3RhdHVzKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZihkYXRhLlNwZWFrZXIgJiYgZGF0YS5TcGVha2VyLlN0YXR1cyA9PSBjb25uZWN0LlZvaWNlSWRTcGVha2VyU3RhdHVzLk9QVEVEX09VVCkgewogICAgICAgICAgICBzZWxmLmRlbGV0ZVNwZWFrZXIoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKQogICAgICB9KQogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmVucm9sbFNwZWFrZXJIZWxwZXIgPSBmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0LCBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgIlNlc3Npb25OYW1lT3JJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZW5yb2xsU3BlYWtlckhlbHBlciBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuRU5ST0xMX0JZX1NFU1NJT04sIHBhcmFtcywgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgaWYoZGF0YS5TdGF0dXMgPT09IGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRCkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZW5yb2xsU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxmLmNoZWNrRW5yb2xsbWVudFN0YXR1cyhjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZW5yb2xsU3BlYWtlciBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5FTlJPTExfU1BFQUtFUl9GQUlMRUQsICJlbnJvbGxTcGVha2VyIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgcmVqZWN0KGVycik7CiAgICB9KTsKICB9OwoKICAvLyBpbnRlcm5hbCBvbmx5CiAgVm9pY2VJZC5wcm90b3R5cGUuX3VwZGF0ZVNwZWFrZXJJZEluTGNtcyA9IGZ1bmN0aW9uIChzcGVha2VySWQsIGdlbmVyYXRlZFNwZWFrZXJJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAiQ29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgIkFXU0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpLAogICAgICAgICJDdXN0b21lcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICJWb2ljZUlkUmVzdWx0IjogewogICAgICAgICAgImdlbmVyYXRlZFNwZWFrZXJJZCI6IGdlbmVyYXRlZFNwZWFrZXJJZAogICAgICAgIH0KICAgICAgfTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJfdXBkYXRlU3BlYWtlcklkSW5MY21zIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5VUERBVEVfVk9JQ0VfSURfREFUQSwgcGFyYW1zLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5MY21zIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJbkxjbXMgZmFpbGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0lOX0xDTVNfRkFJTEVELCAidXBkYXRlU3BlYWtlcklkSW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCA9IGZ1bmN0aW9uIChzcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgIlNlc3Npb25OYW1lT3JJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgfTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5VUERBVEVfU0VTU0lPTiwgcGFyYW1zLCB7CiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZVNwZWFrZXJJZEluTGNtcyhzcGVha2VySWQsIGRhdGEuZ2VuZXJhdGVkU3BlYWtlcklkKQogICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yOwogICAgICAgICAgICAgIHZhciBwYXJzZWRFcnIgPSBKU09OLnBhcnNlKGVycik7CiAgICAgICAgICAgICAgc3dpdGNoKHBhcnNlZEVyci5zdGF0dXMpIHsKICAgICAgICAgICAgICAgIGNhc2UgNDAwOgogICAgICAgICAgICAgICAgY2FzZSA0MDQ6CiAgICAgICAgICAgICAgICAgIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TRVNTSU9OX05PVF9FWElTVFMsICJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkLCBzZXNzaW9uIG5vdCBleGlzdHMiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkLCBzZXNzaW9uIG5vdCBleGlzdHMiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuVVBEQVRFX1NQRUFLRVJfSURfRkFJTEVELCAidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnN5bmNTcGVha2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN5bmNTcGVha2VySWQgY2FsbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlcklkKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICBzZWxmLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZChkYXRhLnNwZWFrZXJJZCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pCiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5nZXREb21haW5JZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29uc3QgYWdlbnQgPSBuZXcgY29ubmVjdC5BZ2VudCgpOwogICAgICBpZiAoIWFnZW50LmdldFBlcm1pc3Npb25zKCkuaW5jbHVkZXMoY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zLlZPSUNFX0lEKSkgewogICAgICAgIHJlamVjdChuZXcgRXJyb3IoIkFnZW50IGRvZXNuJ3QgaGF2ZSB0aGUgcGVybWlzc2lvbiBmb3IgVm9pY2UgSUQiKSk7CiAgICAgIH0gZWxzZSBpZiAoY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCkgewogICAgICAgIHJlc29sdmUoY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAgICJJbnRlZ3JhdGlvblR5cGUiOiAiVk9JQ0VfSUQiCiAgICAgICAgfTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldERvbWFpbklkIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkxJU1RfSU5URUdSQVRJT05fQVNTT0NJQVRJT05TLCBwYXJhbXMsIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGRvbWFpbklkOwogICAgICAgICAgICAgIGlmIChkYXRhLkludGVncmF0aW9uQXNzb2NpYXRpb25TdW1tYXJ5TGlzdC5sZW5ndGggPj0gMSkgewogICAgICAgICAgICAgICAgdmFyIGludGVncmF0aW9uQXJuID0gZGF0YS5JbnRlZ3JhdGlvbkFzc29jaWF0aW9uU3VtbWFyeUxpc3RbMF0uSW50ZWdyYXRpb25Bcm47CiAgICAgICAgICAgICAgICBkb21haW5JZCA9IGludGVncmF0aW9uQXJuLnJlcGxhY2UoL14uKmRvbWFpblwvL2ksICcnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkb21haW5JZCkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXREb21haW5JZDogbm8gZG9tYWluSWQgZm91bmQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5OT19ET01BSU5fSURfRk9VTkQpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXREb21haW5JZCBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELAogICAgICAgICAgICAgICAgZGF0YTogeyBkb21haW5JZDogZG9tYWluSWQgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlc29sdmUoZG9tYWluSWQpOwogICAgICAgICAgICB9IGNhdGNoKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldERvbWFpbklkIGZhaWxlZCIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX0RPTUFJTl9JRF9GQUlMRUQsICJnZXREb21haW5JZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldERvbWFpbklkIGZhaWxlZCIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9ET01BSU5fSURfRkFJTEVELCAiZ2V0RG9tYWluSWQgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5jaGVja0NvbmZlcmVuY2VDYWxsID0gZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBpc0NvbmZlcmVuY2VDYWxsID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpLmNvbm5lY3Rpb25zLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgY29ubi5zdGF0ZS50eXBlKTsKICAgIH0pLmxlbmd0aCA+IDI7CiAgICBpZihpc0NvbmZlcmVuY2VDYWxsKXsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigiVm9pY2VJZCBpcyBub3Qgc3VwcG9ydGVkIGZvciBjb25mZXJlbmNlIGNhbGxzIik7CiAgICB9CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhFbmFibGVkID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgIT09IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgPT09IGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOT1VHSF9TUEVFQ0g7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhSZXN1bHRJbmNvbmNsdXNpdmUgPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCA9PT0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZEVuYWJsZWQgPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ICE9PSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2ggPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ID09PSBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTk9VR0hfU1BFRUNIOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZFJlc3VsdEluY29uY2x1c2l2ZSA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgPT09IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICB9CgogIC8qKgogICAqIEBjbGFzcyBWb2ljZUNvbm5lY3Rpb24KICAgKiBAcGFyYW0ge251bWJlcn0gY29udGFjdElkCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvbm5lY3Rpb25JZAogICAqIEBkZXNjcmlwdGlvbiAtIFByb3ZpZGVzIHZvaWNlIG1lZGlhIHNwZWNpZmljIG9wZXJhdGlvbnMKICAgKi8KICB2YXIgVm9pY2VDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvciA9IG5ldyBWb2ljZUlkKGNvbnRhY3RJZCk7CiAgICB0aGlzLl9jb250YWN0UmVjb3JkZXIgPSBuZXcgQ29udGFjdFJlY29yZGluZyhjb250YWN0SWQpOwogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFZvaWNlQ29ubmVjdGlvbjsKCiAgLyoqCiAgKiBAZGVwcmVjYXRlZAogICogUGxlYXNlIHVzZSBnZXRNZWRpYUluZm8KICAqLwogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U29mdHBob25lTWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zb2Z0cGhvbmVNZWRpYUluZm87CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5TT0ZUUEhPTkU7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldFZvaWNlSWRTcGVha2VySWQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5nZXRTcGVha2VySWQoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Vm9pY2VJZFNwZWFrZXJTdGF0dXMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5nZXRTcGVha2VyU3RhdHVzKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLm9wdE91dFZvaWNlSWRTcGVha2VyID0gZnVuY3Rpb24oKSB7CgogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLm9wdE91dFNwZWFrZXIoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZGVsZXRlVm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5kZWxldGVTcGVha2VyKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmV2YWx1YXRlU3BlYWtlcldpdGhWb2ljZUlkID0gZnVuY3Rpb24oc3RhcnROZXcpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5ldmFsdWF0ZVNwZWFrZXIoc3RhcnROZXcpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5lbnJvbGxTcGVha2VySW5Wb2ljZUlkID0gZnVuY3Rpb24oY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZW5yb2xsU3BlYWtlcihjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS51cGRhdGVWb2ljZUlkU3BlYWtlcklkID0gZnVuY3Rpb24oc3BlYWtlcklkKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IudXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkKHNwZWFrZXJJZCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldFF1aWNrQ29ubmVjdE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnF1aWNrQ29ubmVjdE5hbWU7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5pc1NpbGVudE1vbml0b3IgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuU0lMRU5UX01PTklUT1I7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5pc0JhcmdlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkJBUkdFOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckNhcGFiaWxpdGllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvckNhcGFiaWxpdGllczsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzRm9yY2VkTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZm9yY2VkTXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLm11dGVQYXJ0aWNpcGFudCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTVVURV9QQVJUSUNJUEFOVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnVubXV0ZVBhcnRpY2lwYW50ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VTk1VVEVfUEFSVElDSVBBTlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdGFydENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdGFydENvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuc3RvcENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdG9wQ29udGFjdFJlY29yZGluZygpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdXNwZW5kQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5yZXN1bWVDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNoZWNrQ29uZmVyZW5jZUNhbGwgPSBmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGlzQ29uZmVyZW5jZUNhbGwgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCkuY29ubmVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCBjb25uLnN0YXRlLnR5cGUpOwogICAgfSkubGVuZ3RoID4gMjsKICAgIGlmKGlzQ29uZmVyZW5jZUNhbGwpewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCJWb2ljZUlkIGFuZCBDb250YWN0IFJlY29yZGluZyBhcmUgbm90IHN1cHBvcnRlZCBmb3IgY29uZmVyZW5jZSBjYWxscyIpOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIENoYXRDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZAogICAqIEBkZXNjcmlwdGlvbiBhZGRzIHRoZSBjaGF0IG1lZGlhIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkKICAgKi8KICB2YXIgQ2hhdENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ2hhdENvbm5lY3Rpb247CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZGF0YSA9IHRoaXMuX2dldERhdGEoKS5jaGF0TWVkaWFJbmZvOwogICAgaWYgKCFkYXRhKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgICB2YXIgbWVkaWFPYmplY3QgPSB7CiAgICAgICAgY29udGFjdElkOiB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBpbml0aWFsQ29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgIHBhcnRpY2lwYW50SWQ6IHRoaXMuY29ubmVjdGlvbklkLAogICAgICAgIGdldENvbm5lY3Rpb25Ub2tlbjogY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLmdldENvbm5lY3Rpb25Ub2tlbikKICAgICAgfTsKICAgICAgaWYgKGRhdGEuY29ubmVjdGlvbkRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IEpTT04ucGFyc2UoZGF0YS5jb25uZWN0aW9uRGF0YSkuQ29ubmVjdGlvbkF1dGhlbnRpY2F0aW9uVG9rZW47CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFULCAiQ29ubmVjdGlvbiBkYXRhIGlzIGludmFsaWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiB8fCBudWxsOwogICAgICAvKiogSnVzdCB0byBrZWVwIHRoZSBkYXRhIGFjY2Vzc2libGUgKi8KICAgICAgbWVkaWFPYmplY3Qub3JpZ2luYWxJbmZvID0gdGhpcy5fZ2V0RGF0YSgpLmNoYXRNZWRpYUluZm87CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICAgIH0KICB9OwoKICAvKioKICAqIFByb3ZpZGVzIHRoZSBjaGF0IGNvbm5lY3Rpb25Ub2tlbiB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSSBmb3IgYSBzcGVjaWZpYyBjb250YWN0IGFuZCBwYXJ0aWNpcGFudCBJZC4KICAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogICogVXNhZ2U6CiAgKiBjb25uZWN0aW9uLmdldENvbm5lY3Rpb25Ub2tlbigpCiAgKiAgLnRoZW4ocmVzcG9uc2UgPT4ge30pCiAgKiAgLmNhdGNoKGVycm9yID0+IHt9KQogICovCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25Ub2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgdHJhbnNwb3J0RGV0YWlscyA9IHsKICAgICAgdHJhbnNwb3J0VHlwZTogY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMuQ0hBVF9UT0tFTiwKICAgICAgcGFydGljaXBhbnRJZDogdGhpcy5jb25uZWN0aW9uSWQsCiAgICAgIGNvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZAogICAgfTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB0cmFuc3BvcnREZXRhaWxzLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0Q29ubmVjdGlvblRva2VuIHN1Y2NlZWRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0Q29ubmVjdGlvblRva2VuIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoRXJyb3IoImdldENvbm5lY3Rpb25Ub2tlbiBmYWlsZWQiKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5NZWRpYVR5cGUuQ0hBVDsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIE5vdGUgdGhhdCBhIGNoYXQgbWVkaWEgY29udHJvbGxlciBvbmx5IG5lZWRzIHRvIGJlIHByb2R1Y2VkIGZvciBhZ2VudCB0eXBlIGNvbm5lY3Rpb25zLgogICAgaWYgKHRoaXMuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSgpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpLmNhdGNoKGZ1bmN0aW9uICgpIHsgfSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBAY2xhc3MgVGFza0Nvbm5lY3Rpb24KICAgKiBAcGFyYW0geyp9IGNvbnRhY3RJZAogICAqIEBwYXJhbSB7Kn0gY29ubmVjdGlvbklkCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIHRhc2sgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBUYXNrQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tDb25uZWN0aW9uOwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s7CiAgfQoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgIH07CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICB9OwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb25TbmFwc2hvdAogICAqLwogIHZhciBDb25uZWN0aW9uU25hcHNob3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIGNvbm5lY3QuQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbm5lY3Rpb25EYXRhLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIHRoaXMuY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0aW9uRGF0YTsKICB9OwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29ubmVjdGlvblNuYXBzaG90OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgdmFyIEVuZHBvaW50ID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB0aGlzLmVuZHBvaW50QVJOID0gcGFyYW1zLmVuZHBvaW50SWQgfHwgcGFyYW1zLmVuZHBvaW50QVJOIHx8IG51bGw7CiAgICB0aGlzLmVuZHBvaW50SWQgPSB0aGlzLmVuZHBvaW50QVJOOwogICAgdGhpcy50eXBlID0gcGFyYW1zLnR5cGUgfHwgbnVsbDsKICAgIHRoaXMubmFtZSA9IHBhcmFtcy5uYW1lIHx8IG51bGw7CiAgICB0aGlzLnBob25lTnVtYmVyID0gcGFyYW1zLnBob25lTnVtYmVyIHx8IG51bGw7CiAgICB0aGlzLmFnZW50TG9naW4gPSBwYXJhbXMuYWdlbnRMb2dpbiB8fCBudWxsOwogICAgdGhpcy5xdWV1ZSA9IHBhcmFtcy5xdWV1ZSB8fCBudWxsOwogIH07CgogIC8qKgogICAqIFN0cmlwIHRoZSBTSVAgZW5kcG9pbnQgY29tcG9uZW50cyBmcm9tIHRoZSBwaG9uZU51bWJlciBmaWVsZC4KICAgKi8KICBFbmRwb2ludC5wcm90b3R5cGUuc3RyaXBQaG9uZU51bWJlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnBob25lTnVtYmVyID8gdGhpcy5waG9uZU51bWJlci5yZXBsYWNlKC9zaXA6KFteQF0qKUAuKi8sICIkMSIpIDogIiI7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGFuIEVuZHBvaW50IG9iamVjdCBmcm9tIHRoZSBnaXZlbiBwaG9uZSBudW1iZXIgYW5kIG5hbWUuCiAgICovCiAgRW5kcG9pbnQuYnlQaG9uZU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgRW5kcG9pbnQoewogICAgICB0eXBlOiBjb25uZWN0LkVuZHBvaW50VHlwZS5QSE9ORV9OVU1CRVIsCiAgICAgIHBob25lTnVtYmVyOiBudW1iZXIsCiAgICAgIG5hbWU6IG5hbWUgfHwgbnVsbAogICAgfSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgU29mdHBob25lRXJyb3IKICAgKi8KICB2YXIgU29mdHBob25lRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBlcnJvck1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICB0aGlzLmVycm9yVHlwZSA9IGVycm9yVHlwZTsKICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlOwogICAgdGhpcy5lbmRQb2ludFVybCA9IGVuZFBvaW50VXJsOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yVHlwZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFcnJvck1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lcnJvck1lc3NhZ2U7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RW5kUG9pbnRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lbmRQb2ludFVybDsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSb290IFN1YnNjcmlwdGlvbiBBUElzLgogICAqLwogIGNvbm5lY3QuYWdlbnQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgdmFyIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBmKTsKICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIGYobmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CiAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwoKICBjb25uZWN0LmNvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgcmV0dXJuIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIGYpOwogIH07CgogIGNvbm5lY3Qub25XZWJzb2NrZXRJbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGYpOwogICAgaWYgKGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICBmKCk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFN0YXJ0cyB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXN5bmNocm9ub3VzbHkgb25seSBpZiB0aGUgc2hhcmVkIHdvcmtlcgogICAqIHNheXMgd2UgYXJlIHRoZSBtYXN0ZXIgZm9yIHRoZSBnaXZlbiB0b3BpYy4gIElmIHRoZXJlIGlzIG5vIG1hc3RlciBmb3IKICAgKiB0aGUgZ2l2ZW4gdG9waWMsIHdlIGJlY29tZSB0aGUgbWFzdGVyIGFuZCBzdGFydCB0aGUgZnVuY3Rpb24gdW5sZXNzCiAgICogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIGlzIHRydWUuCiAgICoKICAgKiBAcGFyYW0gdG9waWMgVGhlIG1hc3RlciB0b3BpYyB3ZSBhcmUgY29uY2VybmVkIGFib3V0LgogICAqIEBwYXJhbSBmX3RydWUgVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgaWYgd2UgYXJlIHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIGZfZWxzZSBbb3B0aW9uYWxdIEEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgbm90IHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSBbb3B0aW9uYWxdIGlmIHRydWUsIHRoaXMgdGFiIHdvbid0IGJlY29tZSBtYXN0ZXIuCiAgICovCiAgY29ubmVjdC5pZk1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgZl90cnVlLCBmX2Vsc2UsIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZfdHJ1ZSwgIkEgdHJ1ZSBjYWxsYmFjayBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKGZfZWxzZSkgewogICAgICAgIGZfZWxzZSgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUiwgewogICAgICB0b3BpYzogdG9waWMsCiAgICAgIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZTogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmlzTWFzdGVyKSB7CiAgICAgICAgICAgIGZfdHJ1ZSgpOwoKICAgICAgICAgIH0gZWxzZSBpZiAoZl9lbHNlKSB7CiAgICAgICAgICAgIGZfZWxzZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgfTsKCiAgLyoqCiAgICogTm90aWZ5IHRoZSBzaGFyZWQgd29ya2VyIGFuZCBvdGhlciBDQ1AgdGFicyB0aGF0IHdlIGFyZSBub3cgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLgogICAqLwogIGNvbm5lY3QuYmVjb21lTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYyk7CiAgICAgIGlmIChmYWlsdXJlQ2FsbGJhY2spIHsKICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIG1hc3RlckNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQoKTsKICAgICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVIsIHsKICAgICAgICB0b3BpYzogdG9waWMKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChzdWNjZXNzQ2FsbGJhY2spIHsKICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0LkFnZW50ID0gQWdlbnQ7CiAgY29ubmVjdC5BZ2VudFNuYXBzaG90ID0gQWdlbnRTbmFwc2hvdDsKICBjb25uZWN0LkNvbnRhY3QgPSBDb250YWN0OwogIGNvbm5lY3QuQ29udGFjdFNuYXBzaG90ID0gQ29udGFjdFNuYXBzaG90OwogIC8qKiBEZWZhdWx0IHdpbGwgZ2V0IHRoZSBWb2ljZSBjb25uZWN0aW9uICovCiAgY29ubmVjdC5Db25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQmFzZUNvbm5lY3Rpb24gPSBDb25uZWN0aW9uOwogIGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24gPSBDaGF0Q29ubmVjdGlvbjsKICBjb25uZWN0LlRhc2tDb25uZWN0aW9uID0gVGFza0Nvbm5lY3Rpb247CiAgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QgPSBDb25uZWN0aW9uU25hcHNob3Q7CiAgY29ubmVjdC5FbmRwb2ludCA9IEVuZHBvaW50OwogIGNvbm5lY3QuQWRkcmVzcyA9IEVuZHBvaW50OwogIGNvbm5lY3QuU29mdHBob25lRXJyb3IgPSBTb2Z0cGhvbmVFcnJvcjsKICBjb25uZWN0LlZvaWNlSWQgPSBWb2ljZUlkOwogIGNvbm5lY3QuQ29udGFjdFJlY29yZGluZyA9IENvbnRhY3RSZWNvcmRpbmc7Cn0pKCk7CgoKCi8qKiovIH0pLAoKLyoqKi8gODI3OgovKioqLyAoKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgPT4gewoKdmFyIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fOy8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuMTIwMC4wCi8vIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgovLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CihmdW5jdGlvbigpe2Z1bmN0aW9uIHIoZSxuLHQpe2Z1bmN0aW9uIG8oaSxmKXtpZighbltpXSl7aWYoIWVbaV0pe3ZhciBjPXVuZGVmaW5lZDtpZighZiYmYylyZXR1cm4gcmVxdWlyZShpLCEwKTtpZih1KXJldHVybiB1KGksITApO3ZhciBhPW5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK2krIiciKTt0aHJvdyBhLmNvZGU9Ik1PRFVMRV9OT1RfRk9VTkQiLGF9dmFyIHA9bltpXT17ZXhwb3J0czp7fX07ZVtpXVswXS5jYWxsKHAuZXhwb3J0cyxmdW5jdGlvbihyKXt2YXIgbj1lW2ldWzFdW3JdO3JldHVybiBvKG58fHIpfSxwLHAuZXhwb3J0cyxyLGUsbix0KX1yZXR1cm4gbltpXS5leHBvcnRzfWZvcih2YXIgdT11bmRlZmluZWQsaT0wO2k8dC5sZW5ndGg7aSsrKW8odFtpXSk7cmV0dXJuIG99cmV0dXJuIHJ9KSgpKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJ2ZXJzaW9uIjogIjIuMCIsCiAgIm1ldGFkYXRhIjogewogICAgImFwaVZlcnNpb24iOiAiMjAxNC0wNi0zMCIsCiAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAianNvblZlcnNpb24iOiAiMS4xIiwKICAgICJwcm90b2NvbCI6ICJqc29uIiwKICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uIENvZ25pdG8gSWRlbnRpdHkiLAogICAgInNlcnZpY2VJZCI6ICJDb2duaXRvIElkZW50aXR5IiwKICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICJ0YXJnZXRQcmVmaXgiOiAiQVdTQ29nbml0b0lkZW50aXR5U2VydmljZSIsCiAgICAidWlkIjogImNvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMCIKICB9LAogICJvcGVyYXRpb25zIjogewogICAgIkNyZWF0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIkFsbG93Q2xhc3NpY0Zsb3ciOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlN1cHBvcnRlZExvZ2luUHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzUiCiAgICAgICAgICB9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOSIKICAgICAgICAgIH0sCiAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2IiCiAgICAgICAgICB9LAogICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZyIKICAgICAgICAgIH0sCiAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgIH0KICAgIH0sCiAgICAiRGVsZXRlSWRlbnRpdGllcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkc1RvRGVsZXRlIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiVW5wcm9jZXNzZWRJZGVudGl0eUlkcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICAgICAiRXJyb3JDb2RlIjoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiRGVsZXRlSWRlbnRpdHlQb29sIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkRlc2NyaWJlSWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgfQogICAgfSwKICAgICJEZXNjcmliZUlkZW50aXR5UG9vbCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgIH0KICAgIH0sCiAgICAiR2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzEwIgogICAgICAgICAgfSwKICAgICAgICAgICJDdXN0b21Sb2xlQXJuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9LAogICAgICAgICAgICAgICJTZWNyZXRLZXkiOiB7fSwKICAgICAgICAgICAgICAiU2Vzc2lvblRva2VuIjoge30sCiAgICAgICAgICAgICAgIkV4cGlyYXRpb24iOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiYXV0aHR5cGUiOiAibm9uZSIKICAgIH0sCiAgICAiR2V0SWQiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFjY291bnRJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzEwIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgImF1dGh0eXBlIjogIm5vbmUiCiAgICB9LAogICAgIkdldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJSb2xlcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxYyIKICAgICAgICAgIH0sCiAgICAgICAgICAiUm9sZU1hcHBpbmdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFlIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRPcGVuSWRUb2tlbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzEwIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiYXV0aHR5cGUiOiAibm9uZSIKICAgIH0sCiAgICAiR2V0T3BlbklkVG9rZW5Gb3JEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJMb2dpbnMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMTAiCiAgICAgICAgICB9LAogICAgICAgICAgIlByaW5jaXBhbFRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMXMiCiAgICAgICAgICB9LAogICAgICAgICAgIlRva2VuRHVyYXRpb24iOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIlRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0UHJpbmNpcGFsVGFnQXR0cmlidXRlTWFwIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgIklkZW50aXR5UHJvdmlkZXJOYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVByb3ZpZGVyTmFtZSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIlVzZURlZmF1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJQcmluY2lwYWxUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFzIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJMaXN0SWRlbnRpdGllcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJOZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJIaWRlRGlzYWJsZWQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0aWVzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3YiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiTGlzdElkZW50aXR5UG9vbHMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiTWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkxpc3RUYWdzRm9yUmVzb3VyY2UiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJSZXNvdXJjZUFybiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlJlc291cmNlQXJuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkxvb2t1cERldmVsb3BlcklkZW50aXR5IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciI6IHt9LAogICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyTGlzdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJNZXJnZURldmVsb3BlcklkZW50aXRpZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJTb3VyY2VVc2VySWRlbnRpZmllciIsCiAgICAgICAgICAiRGVzdGluYXRpb25Vc2VySWRlbnRpZmllciIsCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAiRGVzdGluYXRpb25Vc2VySWRlbnRpZmllciI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU2V0SWRlbnRpdHlQb29sUm9sZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAiUm9sZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIlJvbGVzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFjIgogICAgICAgICAgfSwKICAgICAgICAgICJSb2xlTWFwcGluZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMWUiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlNldFByaW5jaXBhbFRhZ0F0dHJpYnV0ZU1hcCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJJZGVudGl0eVByb3ZpZGVyTmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICJVc2VEZWZhdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiUHJpbmNpcGFsVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxcyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiVXNlRGVmYXVsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlByaW5jaXBhbFRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMXMiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlRhZ1Jlc291cmNlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiUmVzb3VyY2VBcm4iLAogICAgICAgICAgIlRhZ3MiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiVW5saW5rRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eUlkIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIiwKICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiVW5saW5rSWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eUlkIiwKICAgICAgICAgICJMb2dpbnMiLAogICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxMCIKICAgICAgICAgIH0sCiAgICAgICAgICAiTG9naW5zVG9SZW1vdmUiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTdyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJhdXRodHlwZSI6ICJub25lIgogICAgfSwKICAgICJVbnRhZ1Jlc291cmNlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiUmVzb3VyY2VBcm4iLAogICAgICAgICAgIlRhZ0tleXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgIlRhZ0tleXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiVXBkYXRlSWRlbnRpdHlQb29sIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInNoYXBlIjogIlNrIgogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgfQogICAgfQogIH0sCiAgInNoYXBlcyI6IHsKICAgICJTNSI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7fQogICAgfSwKICAgICJTOSI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7fQogICAgfSwKICAgICJTYiI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICJDbGllbnRJZCI6IHt9LAogICAgICAgICAgIlNlcnZlclNpZGVUb2tlbkNoZWNrIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTZyI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7fQogICAgfSwKICAgICJTaCI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7fQogICAgfSwKICAgICJTayI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30sCiAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgfSwKICAgICAgICAiQWxsb3dDbGFzc2ljRmxvdyI6IHsKICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgfSwKICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAic2hhcGUiOiAiUzUiCiAgICAgICAgfSwKICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAic2hhcGUiOiAiUzkiCiAgICAgICAgfSwKICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgInNoYXBlIjogIlNiIgogICAgICAgIH0sCiAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgfSwKICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU3YiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTdyIKICAgICAgICB9LAogICAgICAgICJDcmVhdGlvbkRhdGUiOiB7CiAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgfSwKICAgICAgICAiTGFzdE1vZGlmaWVkRGF0ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU3ciOiB7CiAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAibWVtYmVyIjoge30KICAgIH0sCiAgICAiUzEwIjogewogICAgICAidHlwZSI6ICJtYXAiLAogICAgICAia2V5Ijoge30sCiAgICAgICJ2YWx1ZSI6IHt9CiAgICB9LAogICAgIlMxYyI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7fQogICAgfSwKICAgICJTMWUiOiB7CiAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICJrZXkiOiB7fSwKICAgICAgInZhbHVlIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIlR5cGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJUeXBlIjoge30sCiAgICAgICAgICAiQW1iaWd1b3VzUm9sZVJlc29sdXRpb24iOiB7fSwKICAgICAgICAgICJSdWxlc0NvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAiUnVsZXMiCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJSdWxlcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICJDbGFpbSIsCiAgICAgICAgICAgICAgICAgICAgIk1hdGNoVHlwZSIsCiAgICAgICAgICAgICAgICAgICAgIlZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAiUm9sZUFSTiIKICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgIkNsYWltIjoge30sCiAgICAgICAgICAgICAgICAgICAgIk1hdGNoVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICJWYWx1ZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIjoge30KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTMXMiOiB7CiAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICJrZXkiOiB7fSwKICAgICAgInZhbHVlIjoge30KICAgIH0KICB9Cn0KfSx7fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAicGFnaW5hdGlvbiI6IHsKICAgICJMaXN0SWRlbnRpdHlQb29scyI6IHsKICAgICAgImlucHV0X3Rva2VuIjogIk5leHRUb2tlbiIsCiAgICAgICJsaW1pdF9rZXkiOiAiTWF4UmVzdWx0cyIsCiAgICAgICJvdXRwdXRfdG9rZW4iOiAiTmV4dFRva2VuIiwKICAgICAgInJlc3VsdF9rZXkiOiAiSWRlbnRpdHlQb29scyIKICAgIH0KICB9Cn0KfSx7fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAidmVyc2lvbiI6ICIyLjAiLAogICJtZXRhZGF0YSI6IHsKICAgICJhcGlWZXJzaW9uIjogIjIwMTctMDItMTUiLAogICAgImVuZHBvaW50UHJlZml4IjogImNvbm5lY3QiLAogICAgImpzb25WZXJzaW9uIjogIjEuMCIsCiAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAic2VydmljZUFiYnJldmlhdGlvbiI6ICJDb25uZWN0IiwKICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uQ29ubmVjdENUSVNlcnZpY2UiLAogICAgInNpZ25hdHVyZVZlcnNpb24iOiAiIiwKICAgICJ0YXJnZXRQcmVmaXgiOiAiQW1hem9uQ29ubmVjdENUSVNlcnZpY2UiLAogICAgInVpZCI6ICJjb25uZWN0LTIwMTctMDItMTUiCiAgfSwKICAib3BlcmF0aW9ucyI6IHsKICAgICJBY2NlcHRDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNsZWFyQ29udGFjdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNvbXBsZXRlQ29udGFjdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNvbmZlcmVuY2VDb25uZWN0aW9ucyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJDcmVhdGVBZGRpdGlvbmFsQ29ubmVjdGlvbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImVuZHBvaW50IgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiQ3JlYXRlT3V0Ym91bmRDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImVuZHBvaW50IgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgIH0sCiAgICAgICAgICAicXVldWVBUk4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJDcmVhdGVUYXNrQ29udGFjdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImVuZHBvaW50IiwKICAgICAgICAgICJuYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgIH0sCiAgICAgICAgICAicHJldmlvdXNDb250YWN0SWQiOiB7fSwKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU3IiCiAgICAgICAgICB9LAogICAgICAgICAgImlkZW1wb3RlbmN5VG9rZW4iOiB7fSwKICAgICAgICAgICJzY2hlZHVsZWRUaW1lIjogewogICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkNyZWF0ZVRyYW5zcG9ydCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInRyYW5zcG9ydFR5cGUiLAogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAidHJhbnNwb3J0VHlwZSI6IHt9LAogICAgICAgICAgInBhcnRpY2lwYW50SWQiOiB7fSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJzb2Z0cGhvbmVDbGllbnRJZCI6IHt9LAogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAid2ViU29ja2V0VHJhbnNwb3J0IjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgInVybCIsCiAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIgogICAgICAgICAgICBdLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAidXJsIjoge30sCiAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgImNoYXRUb2tlblRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJwYXJ0aWNpcGFudFRva2VuIiwKICAgICAgICAgICAgICAiZXhwaXJ5IgogICAgICAgICAgICBdLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgInNvZnRwaG9uZVRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIgogICAgICAgICAgICBdLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFDb25uZWN0aW9ucyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSIsCiAgICAgICAgICAgICAgICAgICAgImNyZWRlbnRpYWwiLAogICAgICAgICAgICAgICAgICAgICJ1cmxzIgogICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAidXNlcm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCI6IHt9LAogICAgICAgICAgICAgICAgICAgICJ1cmxzIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiRGVzdHJveUNvbm5lY3Rpb24iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJHZXRBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFoIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRBZ2VudFBlcm1pc3Npb25zIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJwZXJtaXNzaW9ucyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInBlcm1pc3Npb25zIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldEFnZW50U25hcHNob3QiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgInRpbWVvdXQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInNuYXBzaG90IiwKICAgICAgICAgICJuZXh0VG9rZW4iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJzbmFwc2hvdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgImNvbnRhY3RzIiwKICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAibmV4dFN0YXRlIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJhZ2VudEF2YWlsYWJpbGl0eVN0YXRlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAic3RhdGUiOiB7fSwKICAgICAgICAgICAgICAgICAgInRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJjb250YWN0cyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiCiAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgInF1ZXVlVGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgImluaXRpYWwiCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUluZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVkaWFMZWdDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb25maWdKc29uIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0TWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdEF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25EYXRhIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjdXN0b21lck5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JpbmdJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWdlbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudE5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvaW5UaW1lU3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAiZm9yY2VkTXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAicXVpY2tDb25uZWN0TmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJtb25pdG9yQ2FwYWJpbGl0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJhdHRyaWJ1dGVzIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIgogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjb250YWN0RHVyYXRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlNyIgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImluaXRpYXRpb25NZXRob2QiOiB7fSwKICAgICAgICAgICAgICAgICAgICAiY29udGFjdEZlYXR1cmVzIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiYXR0YWNobWVudHNFbmFibGVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdpbmdNYXJrZG93bkVuYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgIm11bHRpUGFydHlDb25mZXJlbmNlRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY2hhbm5lbENvbnRleHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzY2hlZHVsZWRUaW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICJ0YXNrVGVtcGxhdGVJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAidGFza1RlbXBsYXRlVmVyc2lvbiI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldEFnZW50U3RhdGVzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJzdGF0ZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJzdGF0ZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0RGlhbGFibGVDb3VudHJ5Q29kZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvdW50cnlDb2RlcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvdW50cnlDb2RlcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRFbmRwb2ludHMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAicXVldWVBUk5zIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAicXVldWVBUk5zIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiZW5kcG9pbnRzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0TmV3QXV0aFRva2VuIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgInJlZnJlc2hUb2tlbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgInJlZnJlc2hUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAibmV3QXV0aFRva2VuIjoge30sCiAgICAgICAgICAiZXhwaXJhdGlvbkRhdGVUaW1lIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldFJvdXRpbmdQcm9maWxlUXVldWVzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iOiB7fSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJxdWV1ZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJxdWV1ZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJIb2xkQ29ubmVjdGlvbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIk11dGVQYXJ0aWNpcGFudCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIk5vdGlmeUNvbnRhY3RJc3N1ZSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJpc3N1ZUNvZGUiOiB7fSwKICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgImNsaWVudExvZ3MiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJQdXRBZ2VudFN0YXRlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgInN0YXRlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICB9LAogICAgICAgICAgImVucXVldWVOZXh0U3RhdGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlJlamVjdENvbnRhY3QiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJSZXN1bWVDb25uZWN0aW9uIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiU2VuZENsaWVudExvZ3MiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAibG9nRXZlbnRzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAibG9nRXZlbnRzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjb21wb25lbnQiOiB7fSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiU2VuZERpZ2l0cyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAiZGlnaXRzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAiZGlnaXRzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiU2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzN2IgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJTZW5kU29mdHBob25lQ2FsbFJlcG9ydCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgInJlcG9ydCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICJyZXBvcnQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJjYWxsU3RhcnRUaW1lIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNhbGxFbmRUaW1lIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzN2IgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImd1bVRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImluaXRpYWxpemF0aW9uVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiaWNlQ29sbGVjdGlvblRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiaGFuZHNoYWtlVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAicHJlVGFsa1RpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInRhbGtUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJjbGVhbnVwVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiaWNlQ29sbGVjdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInNpZ25hbGxpbmdDb25uZWN0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiaGFuZHNoYWtlRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiZ3VtT3RoZXJGYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJndW1UaW1lb3V0RmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiY3JlYXRlT2ZmZXJGYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJzZXRMb2NhbERlc2NyaXB0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAidXNlckJ1c3lGYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJpbnZhbGlkUmVtb3RlU0RQRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAibm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJzZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJUb2dnbGVBY3RpdmVDb25uZWN0aW9ucyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlVubXV0ZVBhcnRpY2lwYW50IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiVXBkYXRlQWdlbnRDb25maWd1cmF0aW9uIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFoIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJVcGRhdGVNb25pdG9yUGFydGljaXBhbnRTdGF0ZSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAidGFyZ2V0TW9uaXRvck1vZGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJ0YXJnZXRNb25pdG9yTW9kZSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9CiAgfSwKICAic2hhcGVzIjogewogICAgIlMyIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAibWVtYmVycyI6IHsKICAgICAgICAiYWdlbnRBUk4iOiB7fSwKICAgICAgICAiYXV0aFRva2VuIjoge30KICAgICAgfQogICAgfSwKICAgICJTZSI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICJ0eXBlIgogICAgICBdLAogICAgICAibWVtYmVycyI6IHsKICAgICAgICAiZW5kcG9pbnRBUk4iOiB7fSwKICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICJuYW1lIjoge30sCiAgICAgICAgInBob25lTnVtYmVyIjoge30sCiAgICAgICAgImFnZW50TG9naW4iOiB7fSwKICAgICAgICAicXVldWUiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlNrIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAibWVtYmVycyI6IHsKICAgICAgICAicXVldWVBUk4iOiB7fSwKICAgICAgICAibmFtZSI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiU3IiOiB7CiAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICJrZXkiOiB7fSwKICAgICAgInZhbHVlIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInZhbHVlIiwKICAgICAgICAgICJ0eXBlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAidmFsdWUiOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiUzFoIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgIm5hbWUiLAogICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIiwKICAgICAgICAic29mdHBob25lQXV0b0FjY2VwdCIsCiAgICAgICAgImV4dGVuc2lvbiIsCiAgICAgICAgInJvdXRpbmdQcm9maWxlIgogICAgICBdLAogICAgICAibWVtYmVycyI6IHsKICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICJ1c2VybmFtZSI6IHt9LAogICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIjogewogICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICB9LAogICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IjogewogICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICB9LAogICAgICAgICJleHRlbnNpb24iOiB7fSwKICAgICAgICAicm91dGluZ1Byb2ZpbGUiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICJyb3V0aW5nUHJvZmlsZUFSTiI6IHt9LAogICAgICAgICAgICAiZGVmYXVsdE91dGJvdW5kUXVldWUiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY2hhbm5lbENvbmN1cnJlbmN5TWFwIjogewogICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAiYWdlbnRQcmVmZXJlbmNlcyI6IHsKICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTMjAiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAidHlwZSIsCiAgICAgICAgIm5hbWUiCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJhZ2VudFN0YXRlQVJOIjoge30sCiAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICJzdGFydFRpbWVzdGFtcCI6IHsKICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiUzN2IjogewogICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgIm1lbWJlciI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfSwKICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1UeXBlIjoge30sCiAgICAgICAgICAicGFja2V0Q291bnQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9LAogICAgICAgICAgInBhY2tldHNMb3N0IjogewogICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgfSwKICAgICAgICAgICJhdWRpb0xldmVsIjogewogICAgICAgICAgICAidHlwZSI6ICJkb3VibGUiCiAgICAgICAgICB9LAogICAgICAgICAgImppdHRlckJ1ZmZlck1pbGxpcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgIH0sCiAgICAgICAgICAicm91bmRUcmlwVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0KfSx7fV0sNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAiYWNtIjogewogICAgIm5hbWUiOiAiQUNNIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImFwaWdhdGV3YXkiOiB7CiAgICAibmFtZSI6ICJBUElHYXRld2F5IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImFwcGxpY2F0aW9uYXV0b3NjYWxpbmciOiB7CiAgICAicHJlZml4IjogImFwcGxpY2F0aW9uLWF1dG9zY2FsaW5nIiwKICAgICJuYW1lIjogIkFwcGxpY2F0aW9uQXV0b1NjYWxpbmciLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYXBwc3RyZWFtIjogewogICAgIm5hbWUiOiAiQXBwU3RyZWFtIgogIH0sCiAgImF1dG9zY2FsaW5nIjogewogICAgIm5hbWUiOiAiQXV0b1NjYWxpbmciLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYmF0Y2giOiB7CiAgICAibmFtZSI6ICJCYXRjaCIKICB9LAogICJidWRnZXRzIjogewogICAgIm5hbWUiOiAiQnVkZ2V0cyIKICB9LAogICJjbG91ZGRpcmVjdG9yeSI6IHsKICAgICJuYW1lIjogIkNsb3VkRGlyZWN0b3J5IiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTYtMDUtMTAqIgogICAgXQogIH0sCiAgImNsb3VkZm9ybWF0aW9uIjogewogICAgIm5hbWUiOiAiQ2xvdWRGb3JtYXRpb24iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29ubmVjdCI6IHsKICAgIm5hbWUiOiAiQ29ubmVjdCIsCiAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNsb3VkZnJvbnQiOiB7CiAgICAibmFtZSI6ICJDbG91ZEZyb250IiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTMtMDUtMTIqIiwKICAgICAgIjIwMTMtMTEtMTEqIiwKICAgICAgIjIwMTQtMDUtMzEqIiwKICAgICAgIjIwMTQtMTAtMjEqIiwKICAgICAgIjIwMTQtMTEtMDYqIiwKICAgICAgIjIwMTUtMDQtMTcqIiwKICAgICAgIjIwMTUtMDctMjcqIiwKICAgICAgIjIwMTUtMDktMTcqIiwKICAgICAgIjIwMTYtMDEtMTMqIiwKICAgICAgIjIwMTYtMDEtMjgqIiwKICAgICAgIjIwMTYtMDgtMDEqIiwKICAgICAgIjIwMTYtMDgtMjAqIiwKICAgICAgIjIwMTYtMDktMDcqIiwKICAgICAgIjIwMTYtMDktMjkqIiwKICAgICAgIjIwMTYtMTEtMjUqIiwKICAgICAgIjIwMTctMDMtMjUqIiwKICAgICAgIjIwMTctMTAtMzAqIiwKICAgICAgIjIwMTgtMDYtMTgqIiwKICAgICAgIjIwMTgtMTEtMDUqIiwKICAgICAgIjIwMTktMDMtMjYqIgogICAgXSwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNsb3VkaHNtIjogewogICAgIm5hbWUiOiAiQ2xvdWRIU00iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY2xvdWRzZWFyY2giOiB7CiAgICAibmFtZSI6ICJDbG91ZFNlYXJjaCIKICB9LAogICJjbG91ZHNlYXJjaGRvbWFpbiI6IHsKICAgICJuYW1lIjogIkNsb3VkU2VhcmNoRG9tYWluIgogIH0sCiAgImNsb3VkdHJhaWwiOiB7CiAgICAibmFtZSI6ICJDbG91ZFRyYWlsIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNsb3Vkd2F0Y2giOiB7CiAgICAicHJlZml4IjogIm1vbml0b3JpbmciLAogICAgIm5hbWUiOiAiQ2xvdWRXYXRjaCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjbG91ZHdhdGNoZXZlbnRzIjogewogICAgInByZWZpeCI6ICJldmVudHMiLAogICAgIm5hbWUiOiAiQ2xvdWRXYXRjaEV2ZW50cyIsCiAgICAidmVyc2lvbnMiOiBbCiAgICAgICIyMDE0LTAyLTAzKiIKICAgIF0sCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjbG91ZHdhdGNobG9ncyI6IHsKICAgICJwcmVmaXgiOiAibG9ncyIsCiAgICAibmFtZSI6ICJDbG91ZFdhdGNoTG9ncyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb2RlYnVpbGQiOiB7CiAgICAibmFtZSI6ICJDb2RlQnVpbGQiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29kZWNvbW1pdCI6IHsKICAgICJuYW1lIjogIkNvZGVDb21taXQiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29kZWRlcGxveSI6IHsKICAgICJuYW1lIjogIkNvZGVEZXBsb3kiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29kZXBpcGVsaW5lIjogewogICAgIm5hbWUiOiAiQ29kZVBpcGVsaW5lIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvZ25pdG9pZGVudGl0eSI6IHsKICAgICJwcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAibmFtZSI6ICJDb2duaXRvSWRlbnRpdHkiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29nbml0b2lkZW50aXR5c2VydmljZXByb3ZpZGVyIjogewogICAgInByZWZpeCI6ICJjb2duaXRvLWlkcCIsCiAgICAibmFtZSI6ICJDb2duaXRvSWRlbnRpdHlTZXJ2aWNlUHJvdmlkZXIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29nbml0b3N5bmMiOiB7CiAgICAicHJlZml4IjogImNvZ25pdG8tc3luYyIsCiAgICAibmFtZSI6ICJDb2duaXRvU3luYyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb25maWdzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJjb25maWciLAogICAgIm5hbWUiOiAiQ29uZmlnU2VydmljZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjdXIiOiB7CiAgICAibmFtZSI6ICJDVVIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZGF0YXBpcGVsaW5lIjogewogICAgIm5hbWUiOiAiRGF0YVBpcGVsaW5lIgogIH0sCiAgImRldmljZWZhcm0iOiB7CiAgICAibmFtZSI6ICJEZXZpY2VGYXJtIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImRpcmVjdGNvbm5lY3QiOiB7CiAgICAibmFtZSI6ICJEaXJlY3RDb25uZWN0IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImRpcmVjdG9yeXNlcnZpY2UiOiB7CiAgICAicHJlZml4IjogImRzIiwKICAgICJuYW1lIjogIkRpcmVjdG9yeVNlcnZpY2UiCiAgfSwKICAiZGlzY292ZXJ5IjogewogICAgIm5hbWUiOiAiRGlzY292ZXJ5IgogIH0sCiAgImRtcyI6IHsKICAgICJuYW1lIjogIkRNUyIKICB9LAogICJkeW5hbW9kYiI6IHsKICAgICJuYW1lIjogIkR5bmFtb0RCIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImR5bmFtb2Ric3RyZWFtcyI6IHsKICAgICJwcmVmaXgiOiAic3RyZWFtcy5keW5hbW9kYiIsCiAgICAibmFtZSI6ICJEeW5hbW9EQlN0cmVhbXMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWMyIjogewogICAgIm5hbWUiOiAiRUMyIiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTMtMDYtMTUqIiwKICAgICAgIjIwMTMtMTAtMTUqIiwKICAgICAgIjIwMTQtMDItMDEqIiwKICAgICAgIjIwMTQtMDUtMDEqIiwKICAgICAgIjIwMTQtMDYtMTUqIiwKICAgICAgIjIwMTQtMDktMDEqIiwKICAgICAgIjIwMTQtMTAtMDEqIiwKICAgICAgIjIwMTUtMDMtMDEqIiwKICAgICAgIjIwMTUtMDQtMTUqIiwKICAgICAgIjIwMTUtMTAtMDEqIiwKICAgICAgIjIwMTYtMDQtMDEqIiwKICAgICAgIjIwMTYtMDktMTUqIgogICAgXSwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVjciI6IHsKICAgICJuYW1lIjogIkVDUiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlY3MiOiB7CiAgICAibmFtZSI6ICJFQ1MiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWZzIjogewogICAgInByZWZpeCI6ICJlbGFzdGljZmlsZXN5c3RlbSIsCiAgICAibmFtZSI6ICJFRlMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWxhc3RpY2FjaGUiOiB7CiAgICAibmFtZSI6ICJFbGFzdGlDYWNoZSIsCiAgICAidmVyc2lvbnMiOiBbCiAgICAgICIyMDEyLTExLTE1KiIsCiAgICAgICIyMDE0LTAzLTI0KiIsCiAgICAgICIyMDE0LTA3LTE1KiIsCiAgICAgICIyMDE0LTA5LTMwKiIKICAgIF0sCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlbGFzdGljYmVhbnN0YWxrIjogewogICAgIm5hbWUiOiAiRWxhc3RpY0JlYW5zdGFsayIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlbGIiOiB7CiAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5nIiwKICAgICJuYW1lIjogIkVMQiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlbGJ2MiI6IHsKICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmd2MiIsCiAgICAibmFtZSI6ICJFTEJ2MiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlbXIiOiB7CiAgICAicHJlZml4IjogImVsYXN0aWNtYXByZWR1Y2UiLAogICAgIm5hbWUiOiAiRU1SIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVzIjogewogICAgIm5hbWUiOiAiRVMiCiAgfSwKICAiZWxhc3RpY3RyYW5zY29kZXIiOiB7CiAgICAibmFtZSI6ICJFbGFzdGljVHJhbnNjb2RlciIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJmaXJlaG9zZSI6IHsKICAgICJuYW1lIjogIkZpcmVob3NlIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImdhbWVsaWZ0IjogewogICAgIm5hbWUiOiAiR2FtZUxpZnQiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZ2xhY2llciI6IHsKICAgICJuYW1lIjogIkdsYWNpZXIiCiAgfSwKICAiaGVhbHRoIjogewogICAgIm5hbWUiOiAiSGVhbHRoIgogIH0sCiAgImlhbSI6IHsKICAgICJuYW1lIjogIklBTSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJpbXBvcnRleHBvcnQiOiB7CiAgICAibmFtZSI6ICJJbXBvcnRFeHBvcnQiCiAgfSwKICAiaW5zcGVjdG9yIjogewogICAgIm5hbWUiOiAiSW5zcGVjdG9yIiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTUtMDgtMTgqIgogICAgXSwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImlvdCI6IHsKICAgICJuYW1lIjogIklvdCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJpb3RkYXRhIjogewogICAgInByZWZpeCI6ICJpb3QtZGF0YSIsCiAgICAibmFtZSI6ICJJb3REYXRhIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImtpbmVzaXMiOiB7CiAgICAibmFtZSI6ICJLaW5lc2lzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImtpbmVzaXNhbmFseXRpY3MiOiB7CiAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzIgogIH0sCiAgImttcyI6IHsKICAgICJuYW1lIjogIktNUyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJsYW1iZGEiOiB7CiAgICAibmFtZSI6ICJMYW1iZGEiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibGV4cnVudGltZSI6IHsKICAgICJwcmVmaXgiOiAicnVudGltZS5sZXgiLAogICAgIm5hbWUiOiAiTGV4UnVudGltZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJsaWdodHNhaWwiOiB7CiAgICAibmFtZSI6ICJMaWdodHNhaWwiCiAgfSwKICAibWFjaGluZWxlYXJuaW5nIjogewogICAgIm5hbWUiOiAiTWFjaGluZUxlYXJuaW5nIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIm1hcmtldHBsYWNlY29tbWVyY2VhbmFseXRpY3MiOiB7CiAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUNvbW1lcmNlQW5hbHl0aWNzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIm1hcmtldHBsYWNlbWV0ZXJpbmciOiB7CiAgICAicHJlZml4IjogIm1ldGVyaW5nbWFya2V0cGxhY2UiLAogICAgIm5hbWUiOiAiTWFya2V0cGxhY2VNZXRlcmluZyIKICB9LAogICJtdHVyayI6IHsKICAgICJwcmVmaXgiOiAibXR1cmstcmVxdWVzdGVyIiwKICAgICJuYW1lIjogIk1UdXJrIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIm1vYmlsZWFuYWx5dGljcyI6IHsKICAgICJuYW1lIjogIk1vYmlsZUFuYWx5dGljcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJvcHN3b3JrcyI6IHsKICAgICJuYW1lIjogIk9wc1dvcmtzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIm9wc3dvcmtzY20iOiB7CiAgICAibmFtZSI6ICJPcHNXb3Jrc0NNIgogIH0sCiAgIm9yZ2FuaXphdGlvbnMiOiB7CiAgICAibmFtZSI6ICJPcmdhbml6YXRpb25zIgogIH0sCiAgInBpbnBvaW50IjogewogICAgIm5hbWUiOiAiUGlucG9pbnQiCiAgfSwKICAicG9sbHkiOiB7CiAgICAibmFtZSI6ICJQb2xseSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJyZHMiOiB7CiAgICAibmFtZSI6ICJSRFMiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxNC0wOS0wMSoiCiAgICBdLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicmVkc2hpZnQiOiB7CiAgICAibmFtZSI6ICJSZWRzaGlmdCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJyZWtvZ25pdGlvbiI6IHsKICAgICJuYW1lIjogIlJla29nbml0aW9uIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInJlc291cmNlZ3JvdXBzdGFnZ2luZ2FwaSI6IHsKICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzVGFnZ2luZ0FQSSIKICB9LAogICJyb3V0ZTUzIjogewogICAgIm5hbWUiOiAiUm91dGU1MyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJyb3V0ZTUzZG9tYWlucyI6IHsKICAgICJuYW1lIjogIlJvdXRlNTNEb21haW5zIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInMzIjogewogICAgIm5hbWUiOiAiUzMiLAogICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzM2NvbnRyb2wiOiB7CiAgICAibmFtZSI6ICJTM0NvbnRyb2wiLAogICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUsCiAgICAieG1sTm9EZWZhdWx0TGlzdHMiOiB0cnVlCiAgfSwKICAic2VydmljZWNhdGFsb2ciOiB7CiAgICAibmFtZSI6ICJTZXJ2aWNlQ2F0YWxvZyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzZXMiOiB7CiAgICAicHJlZml4IjogImVtYWlsIiwKICAgICJuYW1lIjogIlNFUyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzaGllbGQiOiB7CiAgICAibmFtZSI6ICJTaGllbGQiCiAgfSwKICAic2ltcGxlZGIiOiB7CiAgICAicHJlZml4IjogInNkYiIsCiAgICAibmFtZSI6ICJTaW1wbGVEQiIKICB9LAogICJzbXMiOiB7CiAgICAibmFtZSI6ICJTTVMiCiAgfSwKICAic25vd2JhbGwiOiB7CiAgICAibmFtZSI6ICJTbm93YmFsbCIKICB9LAogICJzbnMiOiB7CiAgICAibmFtZSI6ICJTTlMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic3FzIjogewogICAgIm5hbWUiOiAiU1FTIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInNzbSI6IHsKICAgICJuYW1lIjogIlNTTSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzdG9yYWdlZ2F0ZXdheSI6IHsKICAgICJuYW1lIjogIlN0b3JhZ2VHYXRld2F5IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInN0ZXBmdW5jdGlvbnMiOiB7CiAgICAicHJlZml4IjogInN0YXRlcyIsCiAgICAibmFtZSI6ICJTdGVwRnVuY3Rpb25zIgogIH0sCiAgInN0cyI6IHsKICAgICJuYW1lIjogIlNUUyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzdXBwb3J0IjogewogICAgIm5hbWUiOiAiU3VwcG9ydCIKICB9LAogICJzd2YiOiB7CiAgICAibmFtZSI6ICJTV0YiCiAgfSwKICAieHJheSI6IHsKICAgICJuYW1lIjogIlhSYXkiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAid2FmIjogewogICAgIm5hbWUiOiAiV0FGIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIndhZnJlZ2lvbmFsIjogewogICAgInByZWZpeCI6ICJ3YWYtcmVnaW9uYWwiLAogICAgIm5hbWUiOiAiV0FGUmVnaW9uYWwiCiAgfSwKICAid29ya2RvY3MiOiB7CiAgICAibmFtZSI6ICJXb3JrRG9jcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJ3b3Jrc3BhY2VzIjogewogICAgIm5hbWUiOiAiV29ya1NwYWNlcyIKICB9LAogICJjb2Rlc3RhciI6IHsKICAgICJuYW1lIjogIkNvZGVTdGFyIgogIH0sCiAgImxleG1vZGVsYnVpbGRpbmdzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJsZXgtbW9kZWxzIiwKICAgICJuYW1lIjogIkxleE1vZGVsQnVpbGRpbmdTZXJ2aWNlIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIm1hcmtldHBsYWNlZW50aXRsZW1lbnRzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJlbnRpdGxlbWVudC5tYXJrZXRwbGFjZSIsCiAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUVudGl0bGVtZW50U2VydmljZSIKICB9LAogICJhdGhlbmEiOiB7CiAgICAibmFtZSI6ICJBdGhlbmEiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZ3JlZW5ncmFzcyI6IHsKICAgICJuYW1lIjogIkdyZWVuZ3Jhc3MiCiAgfSwKICAiZGF4IjogewogICAgIm5hbWUiOiAiREFYIgogIH0sCiAgIm1pZ3JhdGlvbmh1YiI6IHsKICAgICJwcmVmaXgiOiAiQVdTTWlncmF0aW9uSHViIiwKICAgICJuYW1lIjogIk1pZ3JhdGlvbkh1YiIKICB9LAogICJjbG91ZGhzbXYyIjogewogICAgIm5hbWUiOiAiQ2xvdWRIU01WMiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJnbHVlIjogewogICAgIm5hbWUiOiAiR2x1ZSIKICB9LAogICJtb2JpbGUiOiB7CiAgICAibmFtZSI6ICJNb2JpbGUiCiAgfSwKICAicHJpY2luZyI6IHsKICAgICJuYW1lIjogIlByaWNpbmciLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29zdGV4cGxvcmVyIjogewogICAgInByZWZpeCI6ICJjZSIsCiAgICAibmFtZSI6ICJDb3N0RXhwbG9yZXIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibWVkaWFjb252ZXJ0IjogewogICAgIm5hbWUiOiAiTWVkaWFDb252ZXJ0IgogIH0sCiAgIm1lZGlhbGl2ZSI6IHsKICAgICJuYW1lIjogIk1lZGlhTGl2ZSIKICB9LAogICJtZWRpYXBhY2thZ2UiOiB7CiAgICAibmFtZSI6ICJNZWRpYVBhY2thZ2UiCiAgfSwKICAibWVkaWFzdG9yZSI6IHsKICAgICJuYW1lIjogIk1lZGlhU3RvcmUiCiAgfSwKICAibWVkaWFzdG9yZWRhdGEiOiB7CiAgICAicHJlZml4IjogIm1lZGlhc3RvcmUtZGF0YSIsCiAgICAibmFtZSI6ICJNZWRpYVN0b3JlRGF0YSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJhcHBzeW5jIjogewogICAgIm5hbWUiOiAiQXBwU3luYyIKICB9LAogICJndWFyZGR1dHkiOiB7CiAgICAibmFtZSI6ICJHdWFyZER1dHkiCiAgfSwKICAibXEiOiB7CiAgICAibmFtZSI6ICJNUSIKICB9LAogICJjb21wcmVoZW5kIjogewogICAgIm5hbWUiOiAiQ29tcHJlaGVuZCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJpb3Rqb2JzZGF0YXBsYW5lIjogewogICAgInByZWZpeCI6ICJpb3Qtam9icy1kYXRhIiwKICAgICJuYW1lIjogIklvVEpvYnNEYXRhUGxhbmUiCiAgfSwKICAia2luZXNpc3ZpZGVvYXJjaGl2ZWRtZWRpYSI6IHsKICAgICJwcmVmaXgiOiAia2luZXNpcy12aWRlby1hcmNoaXZlZC1tZWRpYSIsCiAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9BcmNoaXZlZE1lZGlhIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImtpbmVzaXN2aWRlb21lZGlhIjogewogICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLW1lZGlhIiwKICAgICJuYW1lIjogIktpbmVzaXNWaWRlb01lZGlhIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImtpbmVzaXN2aWRlbyI6IHsKICAgICJuYW1lIjogIktpbmVzaXNWaWRlbyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzYWdlbWFrZXJydW50aW1lIjogewogICAgInByZWZpeCI6ICJydW50aW1lLnNhZ2VtYWtlciIsCiAgICAibmFtZSI6ICJTYWdlTWFrZXJSdW50aW1lIgogIH0sCiAgInNhZ2VtYWtlciI6IHsKICAgICJuYW1lIjogIlNhZ2VNYWtlciIKICB9LAogICJ0cmFuc2xhdGUiOiB7CiAgICAibmFtZSI6ICJUcmFuc2xhdGUiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicmVzb3VyY2Vncm91cHMiOiB7CiAgICAicHJlZml4IjogInJlc291cmNlLWdyb3VwcyIsCiAgICAibmFtZSI6ICJSZXNvdXJjZUdyb3VwcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJhbGV4YWZvcmJ1c2luZXNzIjogewogICAgIm5hbWUiOiAiQWxleGFGb3JCdXNpbmVzcyIKICB9LAogICJjbG91ZDkiOiB7CiAgICAibmFtZSI6ICJDbG91ZDkiCiAgfSwKICAic2VydmVybGVzc2FwcGxpY2F0aW9ucmVwb3NpdG9yeSI6IHsKICAgICJwcmVmaXgiOiAic2VydmVybGVzc3JlcG8iLAogICAgIm5hbWUiOiAiU2VydmVybGVzc0FwcGxpY2F0aW9uUmVwb3NpdG9yeSIKICB9LAogICJzZXJ2aWNlZGlzY292ZXJ5IjogewogICAgIm5hbWUiOiAiU2VydmljZURpc2NvdmVyeSIKICB9LAogICJ3b3JrbWFpbCI6IHsKICAgICJuYW1lIjogIldvcmtNYWlsIgogIH0sCiAgImF1dG9zY2FsaW5ncGxhbnMiOiB7CiAgICAicHJlZml4IjogImF1dG9zY2FsaW5nLXBsYW5zIiwKICAgICJuYW1lIjogIkF1dG9TY2FsaW5nUGxhbnMiCiAgfSwKICAidHJhbnNjcmliZXNlcnZpY2UiOiB7CiAgICAicHJlZml4IjogInRyYW5zY3JpYmUiLAogICAgIm5hbWUiOiAiVHJhbnNjcmliZVNlcnZpY2UiCiAgfSwKICAiY29ubmVjdCI6IHsKICAgICJuYW1lIjogIkNvbm5lY3QiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYWNtcGNhIjogewogICAgInByZWZpeCI6ICJhY20tcGNhIiwKICAgICJuYW1lIjogIkFDTVBDQSIKICB9LAogICJmbXMiOiB7CiAgICAibmFtZSI6ICJGTVMiCiAgfSwKICAic2VjcmV0c21hbmFnZXIiOiB7CiAgICAibmFtZSI6ICJTZWNyZXRzTWFuYWdlciIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJpb3RhbmFseXRpY3MiOiB7CiAgICAibmFtZSI6ICJJb1RBbmFseXRpY3MiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiaW90MWNsaWNrZGV2aWNlc3NlcnZpY2UiOiB7CiAgICAicHJlZml4IjogImlvdDFjbGljay1kZXZpY2VzIiwKICAgICJuYW1lIjogIklvVDFDbGlja0RldmljZXNTZXJ2aWNlIgogIH0sCiAgImlvdDFjbGlja3Byb2plY3RzIjogewogICAgInByZWZpeCI6ICJpb3QxY2xpY2stcHJvamVjdHMiLAogICAgIm5hbWUiOiAiSW9UMUNsaWNrUHJvamVjdHMiCiAgfSwKICAicGkiOiB7CiAgICAibmFtZSI6ICJQSSIKICB9LAogICJuZXB0dW5lIjogewogICAgIm5hbWUiOiAiTmVwdHVuZSIKICB9LAogICJtZWRpYXRhaWxvciI6IHsKICAgICJuYW1lIjogIk1lZGlhVGFpbG9yIgogIH0sCiAgImVrcyI6IHsKICAgICJuYW1lIjogIkVLUyIKICB9LAogICJtYWNpZSI6IHsKICAgICJuYW1lIjogIk1hY2llIgogIH0sCiAgImRsbSI6IHsKICAgICJuYW1lIjogIkRMTSIKICB9LAogICJzaWduZXIiOiB7CiAgICAibmFtZSI6ICJTaWduZXIiCiAgfSwKICAiY2hpbWUiOiB7CiAgICAibmFtZSI6ICJDaGltZSIKICB9LAogICJwaW5wb2ludGVtYWlsIjogewogICAgInByZWZpeCI6ICJwaW5wb2ludC1lbWFpbCIsCiAgICAibmFtZSI6ICJQaW5wb2ludEVtYWlsIgogIH0sCiAgInJhbSI6IHsKICAgICJuYW1lIjogIlJBTSIKICB9LAogICJyb3V0ZTUzcmVzb2x2ZXIiOiB7CiAgICAibmFtZSI6ICJSb3V0ZTUzUmVzb2x2ZXIiCiAgfSwKICAicGlucG9pbnRzbXN2b2ljZSI6IHsKICAgICJwcmVmaXgiOiAic21zLXZvaWNlIiwKICAgICJuYW1lIjogIlBpbnBvaW50U01TVm9pY2UiCiAgfSwKICAicXVpY2tzaWdodCI6IHsKICAgICJuYW1lIjogIlF1aWNrU2lnaHQiCiAgfSwKICAicmRzZGF0YXNlcnZpY2UiOiB7CiAgICAicHJlZml4IjogInJkcy1kYXRhIiwKICAgICJuYW1lIjogIlJEU0RhdGFTZXJ2aWNlIgogIH0sCiAgImFtcGxpZnkiOiB7CiAgICAibmFtZSI6ICJBbXBsaWZ5IgogIH0sCiAgImRhdGFzeW5jIjogewogICAgIm5hbWUiOiAiRGF0YVN5bmMiCiAgfSwKICAicm9ib21ha2VyIjogewogICAgIm5hbWUiOiAiUm9ib01ha2VyIgogIH0sCiAgInRyYW5zZmVyIjogewogICAgIm5hbWUiOiAiVHJhbnNmZXIiCiAgfSwKICAiZ2xvYmFsYWNjZWxlcmF0b3IiOiB7CiAgICAibmFtZSI6ICJHbG9iYWxBY2NlbGVyYXRvciIKICB9LAogICJjb21wcmVoZW5kbWVkaWNhbCI6IHsKICAgICJuYW1lIjogIkNvbXByZWhlbmRNZWRpY2FsIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImtpbmVzaXNhbmFseXRpY3N2MiI6IHsKICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3NWMiIKICB9LAogICJtZWRpYWNvbm5lY3QiOiB7CiAgICAibmFtZSI6ICJNZWRpYUNvbm5lY3QiCiAgfSwKICAiZnN4IjogewogICAgIm5hbWUiOiAiRlN4IgogIH0sCiAgInNlY3VyaXR5aHViIjogewogICAgIm5hbWUiOiAiU2VjdXJpdHlIdWIiCiAgfSwKICAiYXBwbWVzaCI6IHsKICAgICJuYW1lIjogIkFwcE1lc2giLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxOC0xMC0wMSoiCiAgICBdCiAgfSwKICAibGljZW5zZW1hbmFnZXIiOiB7CiAgICAicHJlZml4IjogImxpY2Vuc2UtbWFuYWdlciIsCiAgICAibmFtZSI6ICJMaWNlbnNlTWFuYWdlciIKICB9LAogICJrYWZrYSI6IHsKICAgICJuYW1lIjogIkthZmthIgogIH0sCiAgImFwaWdhdGV3YXltYW5hZ2VtZW50YXBpIjogewogICAgIm5hbWUiOiAiQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkiCiAgfSwKICAiYXBpZ2F0ZXdheXYyIjogewogICAgIm5hbWUiOiAiQXBpR2F0ZXdheVYyIgogIH0sCiAgImRvY2RiIjogewogICAgIm5hbWUiOiAiRG9jREIiCiAgfSwKICAiYmFja3VwIjogewogICAgIm5hbWUiOiAiQmFja3VwIgogIH0sCiAgIndvcmtsaW5rIjogewogICAgIm5hbWUiOiAiV29ya0xpbmsiCiAgfSwKICAidGV4dHJhY3QiOiB7CiAgICAibmFtZSI6ICJUZXh0cmFjdCIKICB9LAogICJtYW5hZ2VkYmxvY2tjaGFpbiI6IHsKICAgICJuYW1lIjogIk1hbmFnZWRCbG9ja2NoYWluIgogIH0sCiAgIm1lZGlhcGFja2FnZXZvZCI6IHsKICAgICJwcmVmaXgiOiAibWVkaWFwYWNrYWdlLXZvZCIsCiAgICAibmFtZSI6ICJNZWRpYVBhY2thZ2VWb2QiCiAgfSwKICAiZ3JvdW5kc3RhdGlvbiI6IHsKICAgICJuYW1lIjogIkdyb3VuZFN0YXRpb24iCiAgfSwKICAiaW90dGhpbmdzZ3JhcGgiOiB7CiAgICAibmFtZSI6ICJJb1RUaGluZ3NHcmFwaCIKICB9LAogICJpb3RldmVudHMiOiB7CiAgICAibmFtZSI6ICJJb1RFdmVudHMiCiAgfSwKICAiaW90ZXZlbnRzZGF0YSI6IHsKICAgICJwcmVmaXgiOiAiaW90ZXZlbnRzLWRhdGEiLAogICAgIm5hbWUiOiAiSW9URXZlbnRzRGF0YSIKICB9LAogICJwZXJzb25hbGl6ZSI6IHsKICAgICJuYW1lIjogIlBlcnNvbmFsaXplIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInBlcnNvbmFsaXplZXZlbnRzIjogewogICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ldmVudHMiLAogICAgIm5hbWUiOiAiUGVyc29uYWxpemVFdmVudHMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicGVyc29uYWxpemVydW50aW1lIjogewogICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ydW50aW1lIiwKICAgICJuYW1lIjogIlBlcnNvbmFsaXplUnVudGltZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJhcHBsaWNhdGlvbmluc2lnaHRzIjogewogICAgInByZWZpeCI6ICJhcHBsaWNhdGlvbi1pbnNpZ2h0cyIsCiAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkluc2lnaHRzIgogIH0sCiAgInNlcnZpY2VxdW90YXMiOiB7CiAgICAicHJlZml4IjogInNlcnZpY2UtcXVvdGFzIiwKICAgICJuYW1lIjogIlNlcnZpY2VRdW90YXMiCiAgfSwKICAiZWMyaW5zdGFuY2Vjb25uZWN0IjogewogICAgInByZWZpeCI6ICJlYzItaW5zdGFuY2UtY29ubmVjdCIsCiAgICAibmFtZSI6ICJFQzJJbnN0YW5jZUNvbm5lY3QiCiAgfSwKICAiZXZlbnRicmlkZ2UiOiB7CiAgICAibmFtZSI6ICJFdmVudEJyaWRnZSIKICB9LAogICJsYWtlZm9ybWF0aW9uIjogewogICAgIm5hbWUiOiAiTGFrZUZvcm1hdGlvbiIKICB9LAogICJmb3JlY2FzdHNlcnZpY2UiOiB7CiAgICAicHJlZml4IjogImZvcmVjYXN0IiwKICAgICJuYW1lIjogIkZvcmVjYXN0U2VydmljZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJmb3JlY2FzdHF1ZXJ5c2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAiZm9yZWNhc3RxdWVyeSIsCiAgICAibmFtZSI6ICJGb3JlY2FzdFF1ZXJ5U2VydmljZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJxbGRiIjogewogICAgIm5hbWUiOiAiUUxEQiIKICB9LAogICJxbGRic2Vzc2lvbiI6IHsKICAgICJwcmVmaXgiOiAicWxkYi1zZXNzaW9uIiwKICAgICJuYW1lIjogIlFMREJTZXNzaW9uIgogIH0sCiAgIndvcmttYWlsbWVzc2FnZWZsb3ciOiB7CiAgICAibmFtZSI6ICJXb3JrTWFpbE1lc3NhZ2VGbG93IgogIH0sCiAgImNvZGVzdGFybm90aWZpY2F0aW9ucyI6IHsKICAgICJwcmVmaXgiOiAiY29kZXN0YXItbm90aWZpY2F0aW9ucyIsCiAgICAibmFtZSI6ICJDb2RlU3Rhck5vdGlmaWNhdGlvbnMiCiAgfSwKICAic2F2aW5nc3BsYW5zIjogewogICAgIm5hbWUiOiAiU2F2aW5nc1BsYW5zIgogIH0sCiAgInNzbyI6IHsKICAgICJuYW1lIjogIlNTTyIKICB9LAogICJzc29vaWRjIjogewogICAgInByZWZpeCI6ICJzc28tb2lkYyIsCiAgICAibmFtZSI6ICJTU09PSURDIgogIH0sCiAgIm1hcmtldHBsYWNlY2F0YWxvZyI6IHsKICAgICJwcmVmaXgiOiAibWFya2V0cGxhY2UtY2F0YWxvZyIsCiAgICAibmFtZSI6ICJNYXJrZXRwbGFjZUNhdGFsb2ciCiAgfSwKICAiZGF0YWV4Y2hhbmdlIjogewogICAgIm5hbWUiOiAiRGF0YUV4Y2hhbmdlIgogIH0sCiAgInNlc3YyIjogewogICAgIm5hbWUiOiAiU0VTVjIiCiAgfSwKICAibWlncmF0aW9uaHViY29uZmlnIjogewogICAgInByZWZpeCI6ICJtaWdyYXRpb25odWItY29uZmlnIiwKICAgICJuYW1lIjogIk1pZ3JhdGlvbkh1YkNvbmZpZyIKICB9LAogICJjb25uZWN0cGFydGljaXBhbnQiOiB7CiAgICAibmFtZSI6ICJDb25uZWN0UGFydGljaXBhbnQiCiAgfSwKICAiYXBwY29uZmlnIjogewogICAgIm5hbWUiOiAiQXBwQ29uZmlnIgogIH0sCiAgImlvdHNlY3VyZXR1bm5lbGluZyI6IHsKICAgICJuYW1lIjogIklvVFNlY3VyZVR1bm5lbGluZyIKICB9LAogICJ3YWZ2MiI6IHsKICAgICJuYW1lIjogIldBRlYyIgogIH0sCiAgImVsYXN0aWNpbmZlcmVuY2UiOiB7CiAgICAicHJlZml4IjogImVsYXN0aWMtaW5mZXJlbmNlIiwKICAgICJuYW1lIjogIkVsYXN0aWNJbmZlcmVuY2UiCiAgfSwKICAiaW1hZ2VidWlsZGVyIjogewogICAgIm5hbWUiOiAiSW1hZ2VidWlsZGVyIgogIH0sCiAgInNjaGVtYXMiOiB7CiAgICAibmFtZSI6ICJTY2hlbWFzIgogIH0sCiAgImFjY2Vzc2FuYWx5emVyIjogewogICAgIm5hbWUiOiAiQWNjZXNzQW5hbHl6ZXIiCiAgfSwKICAiY29kZWd1cnVyZXZpZXdlciI6IHsKICAgICJwcmVmaXgiOiAiY29kZWd1cnUtcmV2aWV3ZXIiLAogICAgIm5hbWUiOiAiQ29kZUd1cnVSZXZpZXdlciIKICB9LAogICJjb2RlZ3VydXByb2ZpbGVyIjogewogICAgIm5hbWUiOiAiQ29kZUd1cnVQcm9maWxlciIKICB9LAogICJjb21wdXRlb3B0aW1pemVyIjogewogICAgInByZWZpeCI6ICJjb21wdXRlLW9wdGltaXplciIsCiAgICAibmFtZSI6ICJDb21wdXRlT3B0aW1pemVyIgogIH0sCiAgImZyYXVkZGV0ZWN0b3IiOiB7CiAgICAibmFtZSI6ICJGcmF1ZERldGVjdG9yIgogIH0sCiAgImtlbmRyYSI6IHsKICAgICJuYW1lIjogIktlbmRyYSIKICB9LAogICJuZXR3b3JrbWFuYWdlciI6IHsKICAgICJuYW1lIjogIk5ldHdvcmtNYW5hZ2VyIgogIH0sCiAgIm91dHBvc3RzIjogewogICAgIm5hbWUiOiAiT3V0cG9zdHMiCiAgfSwKICAiYXVnbWVudGVkYWlydW50aW1lIjogewogICAgInByZWZpeCI6ICJzYWdlbWFrZXItYTJpLXJ1bnRpbWUiLAogICAgIm5hbWUiOiAiQXVnbWVudGVkQUlSdW50aW1lIgogIH0sCiAgImVicyI6IHsKICAgICJuYW1lIjogIkVCUyIKICB9LAogICJraW5lc2lzdmlkZW9zaWduYWxpbmdjaGFubmVscyI6IHsKICAgICJwcmVmaXgiOiAia2luZXNpcy12aWRlby1zaWduYWxpbmciLAogICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvU2lnbmFsaW5nQ2hhbm5lbHMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZGV0ZWN0aXZlIjogewogICAgIm5hbWUiOiAiRGV0ZWN0aXZlIgogIH0sCiAgImNvZGVzdGFyY29ubmVjdGlvbnMiOiB7CiAgICAicHJlZml4IjogImNvZGVzdGFyLWNvbm5lY3Rpb25zIiwKICAgICJuYW1lIjogIkNvZGVTdGFyY29ubmVjdGlvbnMiCiAgfSwKICAic3ludGhldGljcyI6IHsKICAgICJuYW1lIjogIlN5bnRoZXRpY3MiCiAgfSwKICAiaW90c2l0ZXdpc2UiOiB7CiAgICAibmFtZSI6ICJJb1RTaXRlV2lzZSIKICB9LAogICJtYWNpZTIiOiB7CiAgICAibmFtZSI6ICJNYWNpZTIiCiAgfSwKICAiY29kZWFydGlmYWN0IjogewogICAgIm5hbWUiOiAiQ29kZUFydGlmYWN0IgogIH0sCiAgImhvbmV5Y29kZSI6IHsKICAgICJuYW1lIjogIkhvbmV5Y29kZSIKICB9LAogICJpdnMiOiB7CiAgICAibmFtZSI6ICJJVlMiCiAgfSwKICAiYnJha2V0IjogewogICAgIm5hbWUiOiAiQnJha2V0IgogIH0sCiAgImlkZW50aXR5c3RvcmUiOiB7CiAgICAibmFtZSI6ICJJZGVudGl0eVN0b3JlIgogIH0sCiAgImFwcGZsb3ciOiB7CiAgICAibmFtZSI6ICJBcHBmbG93IgogIH0sCiAgInJlZHNoaWZ0ZGF0YSI6IHsKICAgICJwcmVmaXgiOiAicmVkc2hpZnQtZGF0YSIsCiAgICAibmFtZSI6ICJSZWRzaGlmdERhdGEiCiAgfSwKICAic3NvYWRtaW4iOiB7CiAgICAicHJlZml4IjogInNzby1hZG1pbiIsCiAgICAibmFtZSI6ICJTU09BZG1pbiIKICB9LAogICJ0aW1lc3RyZWFtcXVlcnkiOiB7CiAgICAicHJlZml4IjogInRpbWVzdHJlYW0tcXVlcnkiLAogICAgIm5hbWUiOiAiVGltZXN0cmVhbVF1ZXJ5IgogIH0sCiAgInRpbWVzdHJlYW13cml0ZSI6IHsKICAgICJwcmVmaXgiOiAidGltZXN0cmVhbS13cml0ZSIsCiAgICAibmFtZSI6ICJUaW1lc3RyZWFtV3JpdGUiCiAgfSwKICAiczNvdXRwb3N0cyI6IHsKICAgICJuYW1lIjogIlMzT3V0cG9zdHMiCiAgfSwKICAiZGF0YWJyZXciOiB7CiAgICAibmFtZSI6ICJEYXRhQnJldyIKICB9LAogICJzZXJ2aWNlY2F0YWxvZ2FwcHJlZ2lzdHJ5IjogewogICAgInByZWZpeCI6ICJzZXJ2aWNlY2F0YWxvZy1hcHByZWdpc3RyeSIsCiAgICAibmFtZSI6ICJTZXJ2aWNlQ2F0YWxvZ0FwcFJlZ2lzdHJ5IgogIH0sCiAgIm5ldHdvcmtmaXJld2FsbCI6IHsKICAgICJwcmVmaXgiOiAibmV0d29yay1maXJld2FsbCIsCiAgICAibmFtZSI6ICJOZXR3b3JrRmlyZXdhbGwiCiAgfSwKICAibXdhYSI6IHsKICAgICJuYW1lIjogIk1XQUEiCiAgfSwKICAiYW1wbGlmeWJhY2tlbmQiOiB7CiAgICAibmFtZSI6ICJBbXBsaWZ5QmFja2VuZCIKICB9LAogICJhcHBpbnRlZ3JhdGlvbnMiOiB7CiAgICAibmFtZSI6ICJBcHBJbnRlZ3JhdGlvbnMiCiAgfSwKICAiY29ubmVjdGNvbnRhY3RsZW5zIjogewogICAgInByZWZpeCI6ICJjb25uZWN0LWNvbnRhY3QtbGVucyIsCiAgICAibmFtZSI6ICJDb25uZWN0Q29udGFjdExlbnMiCiAgfSwKICAiZGV2b3BzZ3VydSI6IHsKICAgICJwcmVmaXgiOiAiZGV2b3BzLWd1cnUiLAogICAgIm5hbWUiOiAiRGV2T3BzR3VydSIKICB9LAogICJlY3JwdWJsaWMiOiB7CiAgICAicHJlZml4IjogImVjci1wdWJsaWMiLAogICAgIm5hbWUiOiAiRUNSUFVCTElDIgogIH0sCiAgImxvb2tvdXR2aXNpb24iOiB7CiAgICAibmFtZSI6ICJMb29rb3V0VmlzaW9uIgogIH0sCiAgInNhZ2VtYWtlcmZlYXR1cmVzdG9yZXJ1bnRpbWUiOiB7CiAgICAicHJlZml4IjogInNhZ2VtYWtlci1mZWF0dXJlc3RvcmUtcnVudGltZSIsCiAgICAibmFtZSI6ICJTYWdlTWFrZXJGZWF0dXJlU3RvcmVSdW50aW1lIgogIH0sCiAgImN1c3RvbWVycHJvZmlsZXMiOiB7CiAgICAicHJlZml4IjogImN1c3RvbWVyLXByb2ZpbGVzIiwKICAgICJuYW1lIjogIkN1c3RvbWVyUHJvZmlsZXMiCiAgfSwKICAiYXVkaXRtYW5hZ2VyIjogewogICAgIm5hbWUiOiAiQXVkaXRNYW5hZ2VyIgogIH0sCiAgImVtcmNvbnRhaW5lcnMiOiB7CiAgICAicHJlZml4IjogImVtci1jb250YWluZXJzIiwKICAgICJuYW1lIjogIkVNUmNvbnRhaW5lcnMiCiAgfSwKICAiaGVhbHRobGFrZSI6IHsKICAgICJuYW1lIjogIkhlYWx0aExha2UiCiAgfSwKICAic2FnZW1ha2VyZWRnZSI6IHsKICAgICJwcmVmaXgiOiAic2FnZW1ha2VyLWVkZ2UiLAogICAgIm5hbWUiOiAiU2FnZW1ha2VyRWRnZSIKICB9LAogICJhbXAiOiB7CiAgICAibmFtZSI6ICJBbXAiCiAgfSwKICAiZ3JlZW5ncmFzc3YyIjogewogICAgIm5hbWUiOiAiR3JlZW5ncmFzc1YyIgogIH0sCiAgImlvdGRldmljZWFkdmlzb3IiOiB7CiAgICAibmFtZSI6ICJJb3REZXZpY2VBZHZpc29yIgogIH0sCiAgImlvdGZsZWV0aHViIjogewogICAgIm5hbWUiOiAiSW9URmxlZXRIdWIiCiAgfSwKICAiaW90d2lyZWxlc3MiOiB7CiAgICAibmFtZSI6ICJJb1RXaXJlbGVzcyIKICB9LAogICJsb2NhdGlvbiI6IHsKICAgICJuYW1lIjogIkxvY2F0aW9uIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIndlbGxhcmNoaXRlY3RlZCI6IHsKICAgICJuYW1lIjogIldlbGxBcmNoaXRlY3RlZCIKICB9LAogICJsZXhtb2RlbHN2MiI6IHsKICAgICJwcmVmaXgiOiAibW9kZWxzLmxleC52MiIsCiAgICAibmFtZSI6ICJMZXhNb2RlbHNWMiIKICB9LAogICJsZXhydW50aW1ldjIiOiB7CiAgICAicHJlZml4IjogInJ1bnRpbWUubGV4LnYyIiwKICAgICJuYW1lIjogIkxleFJ1bnRpbWVWMiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJmaXMiOiB7CiAgICAibmFtZSI6ICJGaXMiCiAgfSwKICAibG9va291dG1ldHJpY3MiOiB7CiAgICAibmFtZSI6ICJMb29rb3V0TWV0cmljcyIKICB9LAogICJtZ24iOiB7CiAgICAibmFtZSI6ICJNZ24iCiAgfSwKICAibG9va291dGVxdWlwbWVudCI6IHsKICAgICJuYW1lIjogIkxvb2tvdXRFcXVpcG1lbnQiCiAgfSwKICAibmltYmxlIjogewogICAgIm5hbWUiOiAiTmltYmxlIgogIH0sCiAgImZpbnNwYWNlIjogewogICAgIm5hbWUiOiAiRmluc3BhY2UiCiAgfSwKICAiZmluc3BhY2VkYXRhIjogewogICAgInByZWZpeCI6ICJmaW5zcGFjZS1kYXRhIiwKICAgICJuYW1lIjogIkZpbnNwYWNlZGF0YSIKICB9LAogICJzc21jb250YWN0cyI6IHsKICAgICJwcmVmaXgiOiAic3NtLWNvbnRhY3RzIiwKICAgICJuYW1lIjogIlNTTUNvbnRhY3RzIgogIH0sCiAgInNzbWluY2lkZW50cyI6IHsKICAgICJwcmVmaXgiOiAic3NtLWluY2lkZW50cyIsCiAgICAibmFtZSI6ICJTU01JbmNpZGVudHMiCiAgfSwKICAiYXBwbGljYXRpb25jb3N0cHJvZmlsZXIiOiB7CiAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkNvc3RQcm9maWxlciIKICB9LAogICJhcHBydW5uZXIiOiB7CiAgICAibmFtZSI6ICJBcHBSdW5uZXIiCiAgfSwKICAicHJvdG9uIjogewogICAgIm5hbWUiOiAiUHJvdG9uIgogIH0sCiAgInJvdXRlNTNyZWNvdmVyeWNsdXN0ZXIiOiB7CiAgICAicHJlZml4IjogInJvdXRlNTMtcmVjb3ZlcnktY2x1c3RlciIsCiAgICAibmFtZSI6ICJSb3V0ZTUzUmVjb3ZlcnlDbHVzdGVyIgogIH0sCiAgInJvdXRlNTNyZWNvdmVyeWNvbnRyb2xjb25maWciOiB7CiAgICAicHJlZml4IjogInJvdXRlNTMtcmVjb3ZlcnktY29udHJvbC1jb25maWciLAogICAgIm5hbWUiOiAiUm91dGU1M1JlY292ZXJ5Q29udHJvbENvbmZpZyIKICB9LAogICJyb3V0ZTUzcmVjb3ZlcnlyZWFkaW5lc3MiOiB7CiAgICAicHJlZml4IjogInJvdXRlNTMtcmVjb3ZlcnktcmVhZGluZXNzIiwKICAgICJuYW1lIjogIlJvdXRlNTNSZWNvdmVyeVJlYWRpbmVzcyIKICB9LAogICJjaGltZXNka2lkZW50aXR5IjogewogICAgInByZWZpeCI6ICJjaGltZS1zZGstaWRlbnRpdHkiLAogICAgIm5hbWUiOiAiQ2hpbWVTREtJZGVudGl0eSIKICB9LAogICJjaGltZXNka21lc3NhZ2luZyI6IHsKICAgICJwcmVmaXgiOiAiY2hpbWUtc2RrLW1lc3NhZ2luZyIsCiAgICAibmFtZSI6ICJDaGltZVNES01lc3NhZ2luZyIKICB9LAogICJzbm93ZGV2aWNlbWFuYWdlbWVudCI6IHsKICAgICJwcmVmaXgiOiAic25vdy1kZXZpY2UtbWFuYWdlbWVudCIsCiAgICAibmFtZSI6ICJTbm93RGV2aWNlTWFuYWdlbWVudCIKICB9LAogICJtZW1vcnlkYiI6IHsKICAgICJuYW1lIjogIk1lbW9yeURCIgogIH0sCiAgIm9wZW5zZWFyY2giOiB7CiAgICAibmFtZSI6ICJPcGVuU2VhcmNoIgogIH0sCiAgImthZmthY29ubmVjdCI6IHsKICAgICJuYW1lIjogIkthZmthQ29ubmVjdCIKICB9LAogICJ2b2ljZWlkIjogewogICAgInByZWZpeCI6ICJ2b2ljZS1pZCIsCiAgICAibmFtZSI6ICJWb2ljZUlEIgogIH0sCiAgIndpc2RvbSI6IHsKICAgICJuYW1lIjogIldpc2RvbSIKICB9LAogICJhY2NvdW50IjogewogICAgIm5hbWUiOiAiQWNjb3VudCIKICB9LAogICJjbG91ZGNvbnRyb2wiOiB7CiAgICAibmFtZSI6ICJDbG91ZENvbnRyb2wiCiAgfSwKICAiZ3JhZmFuYSI6IHsKICAgICJuYW1lIjogIkdyYWZhbmEiCiAgfSwKICAicGFub3JhbWEiOiB7CiAgICAibmFtZSI6ICJQYW5vcmFtYSIKICB9LAogICJjaGltZXNka21lZXRpbmdzIjogewogICAgInByZWZpeCI6ICJjaGltZS1zZGstbWVldGluZ3MiLAogICAgIm5hbWUiOiAiQ2hpbWVTREtNZWV0aW5ncyIKICB9LAogICJyZXNpbGllbmNlaHViIjogewogICAgIm5hbWUiOiAiUmVzaWxpZW5jZWh1YiIKICB9LAogICJtaWdyYXRpb25odWJzdHJhdGVneSI6IHsKICAgICJuYW1lIjogIk1pZ3JhdGlvbkh1YlN0cmF0ZWd5IgogIH0sCiAgImFwcGNvbmZpZ2RhdGEiOiB7CiAgICAibmFtZSI6ICJBcHBDb25maWdEYXRhIgogIH0sCiAgImRycyI6IHsKICAgICJuYW1lIjogIkRycyIKICB9LAogICJtaWdyYXRpb25odWJyZWZhY3RvcnNwYWNlcyI6IHsKICAgICJwcmVmaXgiOiAibWlncmF0aW9uLWh1Yi1yZWZhY3Rvci1zcGFjZXMiLAogICAgIm5hbWUiOiAiTWlncmF0aW9uSHViUmVmYWN0b3JTcGFjZXMiCiAgfSwKICAiZXZpZGVudGx5IjogewogICAgIm5hbWUiOiAiRXZpZGVudGx5IgogIH0sCiAgImluc3BlY3RvcjIiOiB7CiAgICAibmFtZSI6ICJJbnNwZWN0b3IyIgogIH0sCiAgInJiaW4iOiB7CiAgICAibmFtZSI6ICJSYmluIgogIH0sCiAgInJ1bSI6IHsKICAgICJuYW1lIjogIlJVTSIKICB9LAogICJiYWNrdXBnYXRld2F5IjogewogICAgInByZWZpeCI6ICJiYWNrdXAtZ2F0ZXdheSIsCiAgICAibmFtZSI6ICJCYWNrdXBHYXRld2F5IgogIH0sCiAgImlvdHR3aW5tYWtlciI6IHsKICAgICJuYW1lIjogIklvVFR3aW5NYWtlciIKICB9LAogICJ3b3Jrc3BhY2Vzd2ViIjogewogICAgInByZWZpeCI6ICJ3b3Jrc3BhY2VzLXdlYiIsCiAgICAibmFtZSI6ICJXb3JrU3BhY2VzV2ViIgogIH0sCiAgImFtcGxpZnl1aWJ1aWxkZXIiOiB7CiAgICAibmFtZSI6ICJBbXBsaWZ5VUlCdWlsZGVyIgogIH0sCiAgImtleXNwYWNlcyI6IHsKICAgICJuYW1lIjogIktleXNwYWNlcyIKICB9LAogICJiaWxsaW5nY29uZHVjdG9yIjogewogICAgIm5hbWUiOiAiQmlsbGluZ2NvbmR1Y3RvciIKICB9LAogICJnYW1lc3BhcmtzIjogewogICAgIm5hbWUiOiAiR2FtZVNwYXJrcyIKICB9LAogICJwaW5wb2ludHNtc3ZvaWNldjIiOiB7CiAgICAicHJlZml4IjogInBpbnBvaW50LXNtcy12b2ljZS12MiIsCiAgICAibmFtZSI6ICJQaW5wb2ludFNNU1ZvaWNlVjIiCiAgfSwKICAiaXZzY2hhdCI6IHsKICAgICJuYW1lIjogIkl2c2NoYXQiCiAgfSwKICAiY2hpbWVzZGttZWRpYXBpcGVsaW5lcyI6IHsKICAgICJwcmVmaXgiOiAiY2hpbWUtc2RrLW1lZGlhLXBpcGVsaW5lcyIsCiAgICAibmFtZSI6ICJDaGltZVNES01lZGlhUGlwZWxpbmVzIgogIH0sCiAgImVtcnNlcnZlcmxlc3MiOiB7CiAgICAicHJlZml4IjogImVtci1zZXJ2ZXJsZXNzIiwKICAgICJuYW1lIjogIkVNUlNlcnZlcmxlc3MiCiAgfSwKICAibTIiOiB7CiAgICAibmFtZSI6ICJNMiIKICB9LAogICJjb25uZWN0Y2FtcGFpZ25zIjogewogICAgIm5hbWUiOiAiQ29ubmVjdENhbXBhaWducyIKICB9LAogICJyZWRzaGlmdHNlcnZlcmxlc3MiOiB7CiAgICAicHJlZml4IjogInJlZHNoaWZ0LXNlcnZlcmxlc3MiLAogICAgIm5hbWUiOiAiUmVkc2hpZnRTZXJ2ZXJsZXNzIgogIH0sCiAgInJvbGVzYW55d2hlcmUiOiB7CiAgICAibmFtZSI6ICJSb2xlc0FueXdoZXJlIgogIH0sCiAgImxpY2Vuc2VtYW5hZ2VydXNlcnN1YnNjcmlwdGlvbnMiOiB7CiAgICAicHJlZml4IjogImxpY2Vuc2UtbWFuYWdlci11c2VyLXN1YnNjcmlwdGlvbnMiLAogICAgIm5hbWUiOiAiTGljZW5zZU1hbmFnZXJVc2VyU3Vic2NyaXB0aW9ucyIKICB9LAogICJiYWNrdXBzdG9yYWdlIjogewogICAgIm5hbWUiOiAiQmFja3VwU3RvcmFnZSIKICB9LAogICJwcml2YXRlbmV0d29ya3MiOiB7CiAgICAibmFtZSI6ICJQcml2YXRlTmV0d29ya3MiCiAgfSwKICAic3VwcG9ydGFwcCI6IHsKICAgICJwcmVmaXgiOiAic3VwcG9ydC1hcHAiLAogICAgIm5hbWUiOiAiU3VwcG9ydEFwcCIKICB9Cn0KCn0se31dLDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz17CiAgInZlcnNpb24iOiAiMi4wIiwKICAibWV0YWRhdGEiOiB7CiAgICAiYXBpVmVyc2lvbiI6ICIyMDExLTA2LTE1IiwKICAgICJlbmRwb2ludFByZWZpeCI6ICJzdHMiLAogICAgImdsb2JhbEVuZHBvaW50IjogInN0cy5hbWF6b25hd3MuY29tIiwKICAgICJwcm90b2NvbCI6ICJxdWVyeSIsCiAgICAic2VydmljZUFiYnJldmlhdGlvbiI6ICJBV1MgU1RTIiwKICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQVdTIFNlY3VyaXR5IFRva2VuIFNlcnZpY2UiLAogICAgInNlcnZpY2VJZCI6ICJTVFMiLAogICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjQiLAogICAgInVpZCI6ICJzdHMtMjAxMS0wNi0xNSIsCiAgICAieG1sTmFtZXNwYWNlIjogImh0dHBzOi8vc3RzLmFtYXpvbmF3cy5jb20vZG9jLzIwMTEtMDYtMTUvIgogIH0sCiAgIm9wZXJhdGlvbnMiOiB7CiAgICAiQXNzdW1lUm9sZSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM4IgogICAgICAgICAgfSwKICAgICAgICAgICJUcmFuc2l0aXZlVGFnS2V5cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgfSwKICAgICAgICAgICJFeHRlcm5hbElkIjoge30sCiAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAiVG9rZW5Db2RlIjoge30sCiAgICAgICAgICAiU291cmNlSWRlbnRpdHkiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlUmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2kiCiAgICAgICAgICB9LAogICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNuIgogICAgICAgICAgfSwKICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJTb3VyY2VJZGVudGl0eSI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkFzc3VtZVJvbGVXaXRoU0FNTCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgIlByaW5jaXBhbEFybiIsCiAgICAgICAgICAiU0FNTEFzc2VydGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICJQcmluY2lwYWxBcm4iOiB7fSwKICAgICAgICAgICJTQU1MQXNzZXJ0aW9uIjoge30sCiAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgfSwKICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoU0FNTFJlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNpIgogICAgICAgICAgfSwKICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiU3ViamVjdCI6IHt9LAogICAgICAgICAgIlN1YmplY3RUeXBlIjoge30sCiAgICAgICAgICAiSXNzdWVyIjoge30sCiAgICAgICAgICAiQXVkaWVuY2UiOiB7fSwKICAgICAgICAgICJOYW1lUXVhbGlmaWVyIjoge30sCiAgICAgICAgICAiU291cmNlSWRlbnRpdHkiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIiwKICAgICAgICAgICJXZWJJZGVudGl0eVRva2VuIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiUm9sZUFybiI6IHt9LAogICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICJQcm92aWRlcklkIjoge30sCiAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgfSwKICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlSZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaSIKICAgICAgICAgIH0sCiAgICAgICAgICAiU3ViamVjdEZyb21XZWJJZGVudGl0eVRva2VuIjoge30sCiAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAic2hhcGUiOiAiU24iCiAgICAgICAgICB9LAogICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIlByb3ZpZGVyIjoge30sCiAgICAgICAgICAiQXVkaWVuY2UiOiB7fSwKICAgICAgICAgICJTb3VyY2VJZGVudGl0eSI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkRlY29kZUF1dGhvcml6YXRpb25NZXNzYWdlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiRW5jb2RlZE1lc3NhZ2UiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkRlY29kZUF1dGhvcml6YXRpb25NZXNzYWdlUmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkRlY29kZWRNZXNzYWdlIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0QWNjZXNzS2V5SW5mbyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkFjY2Vzc0tleUlkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRBY2Nlc3NLZXlJbmZvUmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFjY291bnQiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRDYWxsZXJJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldENhbGxlcklkZW50aXR5UmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlVzZXJJZCI6IHt9LAogICAgICAgICAgIkFjY291bnQiOiB7fSwKICAgICAgICAgICJBcm4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRGZWRlcmF0aW9uVG9rZW4iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJOYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiTmFtZSI6IHt9LAogICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgIH0sCiAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzgiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldEZlZGVyYXRpb25Ub2tlblJlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNpIgogICAgICAgICAgfSwKICAgICAgICAgICJGZWRlcmF0ZWRVc2VyIjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXJJZCIsCiAgICAgICAgICAgICAgIkFybiIKICAgICAgICAgICAgXSwKICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXJJZCI6IHt9LAogICAgICAgICAgICAgICJBcm4iOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldFNlc3Npb25Ub2tlbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJTZXJpYWxOdW1iZXIiOiB7fSwKICAgICAgICAgICJUb2tlbkNvZGUiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRTZXNzaW9uVG9rZW5SZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaSIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LAogICJzaGFwZXMiOiB7CiAgICAiUzQiOiB7CiAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAibWVtYmVyIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXJuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiUzgiOiB7CiAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAibWVtYmVyIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIktleSIsCiAgICAgICAgICAiVmFsdWUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJLZXkiOiB7fSwKICAgICAgICAgICJWYWx1ZSI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlNpIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgIkFjY2Vzc0tleUlkIiwKICAgICAgICAiU2VjcmV0QWNjZXNzS2V5IiwKICAgICAgICAiU2Vzc2lvblRva2VuIiwKICAgICAgICAiRXhwaXJhdGlvbiIKICAgICAgXSwKICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgIkFjY2Vzc0tleUlkIjoge30sCiAgICAgICAgIlNlY3JldEFjY2Vzc0tleSI6IHt9LAogICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAiRXhwaXJhdGlvbiI6IHsKICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU24iOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAiQXNzdW1lZFJvbGVJZCIsCiAgICAgICAgIkFybiIKICAgICAgXSwKICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgIkFzc3VtZWRSb2xlSWQiOiB7fSwKICAgICAgICAiQXJuIjoge30KICAgICAgfQogICAgfQogIH0KfQp9LHt9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJwYWdpbmF0aW9uIjogewogIH0KfQoKfSx7fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwp2YXIgQVdTID0gcmVxdWlyZSgnLi4vbGliL2NvcmUnKTsKdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CgphcGlMb2FkZXIuc2VydmljZXNbJ2NvZ25pdG9pZGVudGl0eSddID0ge307CkFXUy5Db2duaXRvSWRlbnRpdHkgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2NvZ25pdG9pZGVudGl0eScsIFsnMjAxNC0wNi0zMCddKTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snY29nbml0b2lkZW50aXR5J10sICcyMDE0LTA2LTMwJywgewogIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24nKTsKICAgIG1vZGVsLnBhZ2luYXRvcnMgPSByZXF1aXJlKCcuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgcmV0dXJuIG1vZGVsOwogIH0sCiAgZW51bWVyYWJsZTogdHJ1ZSwKICBjb25maWd1cmFibGU6IHRydWUKfSk7Cgptb2R1bGUuZXhwb3J0cyA9IEFXUy5Db2duaXRvSWRlbnRpdHk7Cgp9LHsiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24iOjEsIi4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbiI6MiwiLi4vbGliL2NvcmUiOjE5LCIuLi9saWIvbm9kZV9sb2FkZXIiOjE2fV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwp2YXIgQVdTID0gcmVxdWlyZSgnLi4vbGliL2NvcmUnKTsKdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CgphcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddID0ge307CkFXUy5TVFMgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ3N0cycsIFsnMjAxMS0wNi0xNSddKTsKcmVxdWlyZSgnLi4vbGliL3NlcnZpY2VzL3N0cycpOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSwgJzIwMTEtMDYtMTUnLCB7CiAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICB2YXIgbW9kZWwgPSByZXF1aXJlKCcuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbi5qc29uJyk7CiAgICBtb2RlbC5wYWdpbmF0b3JzID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgcmV0dXJuIG1vZGVsOwogIH0sCiAgZW51bWVyYWJsZTogdHJ1ZSwKICBjb25maWd1cmFibGU6IHRydWUKfSk7Cgptb2R1bGUuZXhwb3J0cyA9IEFXUy5TVFM7Cgp9LHsiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbiI6NSwiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24iOjYsIi4uL2xpYi9jb3JlIjoxOSwiLi4vbGliL25vZGVfbG9hZGVyIjoxNiwiLi4vbGliL3NlcnZpY2VzL3N0cyI6NjJ9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKZnVuY3Rpb24gYXBpTG9hZGVyKHN2YywgdmVyc2lvbikgewogIGlmICghYXBpTG9hZGVyLnNlcnZpY2VzLmhhc093blByb3BlcnR5KHN2YykpIHsKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZFNlcnZpY2U6IEZhaWxlZCB0byBsb2FkIGFwaSBmb3IgJyArIHN2Yyk7CiAgfQogIHJldHVybiBhcGlMb2FkZXIuc2VydmljZXNbc3ZjXVt2ZXJzaW9uXTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKgogKiBUaGlzIG1lbWJlciBvZiBBV1MuYXBpTG9hZGVyIGlzIHByaXZhdGUsIGJ1dCBjaGFuZ2luZyBpdCB3aWxsIG5lY2Vzc2l0YXRlIGEKICogY2hhbmdlIHRvIC4uL3NjcmlwdHMvc2VydmljZXMtdGFibGUtZ2VuZXJhdG9yLnRzCiAqLwphcGlMb2FkZXIuc2VydmljZXMgPSB7fTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gYXBpTG9hZGVyOwoKfSx7fV0sMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgSG1hYyA9IHJlcXVpcmUoJy4vYnJvd3NlckhtYWMnKTsKdmFyIE1kNSA9IHJlcXVpcmUoJy4vYnJvd3Nlck1kNScpOwp2YXIgU2hhMSA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTEnKTsKdmFyIFNoYTI1NiA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTI1NicpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gY3JlYXRlSGFzaChhbGcpIHsKICAgICAgYWxnID0gYWxnLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBNZDUoKTsKICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGEyNTYnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGEyNTYoKTsKICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGExJykgewogICAgICAgIHJldHVybiBuZXcgU2hhMSgpOwogICAgICB9CgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hhc2ggYWxnb3JpdGhtICcgKyBhbGcgKyAnIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgU0RLJyk7CiAgICB9LAogICAgY3JlYXRlSG1hYzogZnVuY3Rpb24gY3JlYXRlSG1hYyhhbGcsIGtleSkgewogICAgICBhbGcgPSBhbGcudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKGFsZyA9PT0gJ21kNScpIHsKICAgICAgICByZXR1cm4gbmV3IEhtYWMoTWQ1LCBrZXkpOwogICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTI1NicpIHsKICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMjU2LCBrZXkpOwogICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBIbWFjKFNoYTEsIGtleSk7CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBFcnJvcignSE1BQyBhbGdvcml0aG0gJyArIGFsZyArICcgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBTREsnKTsKICAgIH0sCiAgICBjcmVhdGVTaWduOiBmdW5jdGlvbigpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdjcmVhdGVTaWduIGlzIG5vdCBpbXBsZW1lbnRlZCBpbiB0aGUgYnJvd3NlcicpOwogICAgfQogIH07Cgp9LHsiLi9icm93c2VySG1hYyI6MTIsIi4vYnJvd3Nlck1kNSI6MTMsIi4vYnJvd3NlclNoYTEiOjE0LCIuL2Jyb3dzZXJTaGEyNTYiOjE1fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKCi8qKgogKiBUaGlzIGlzIGEgcG9seWZpbGwgZm9yIHRoZSBzdGF0aWMgbWV0aG9kIGBpc1ZpZXdgIG9mIGBBcnJheUJ1ZmZlcmAsIHdoaWNoIGlzCiAqIGUuZy4gbWlzc2luZyBpbiBJRSAxMC4KICoKICogQGFwaSBwcml2YXRlCiAqLwppZiAoCiAgICB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICB0eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3ID09PSAndW5kZWZpbmVkJwopIHsKICAgIEFycmF5QnVmZmVyLmlzVmlldyA9IGZ1bmN0aW9uKGFyZykgewogICAgICAgIHJldHVybiB2aWV3U3RyaW5ncy5pbmRleE9mKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChhcmcpKSA+IC0xOwogICAgfTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIHZpZXdTdHJpbmdzID0gWwogICAgJ1tvYmplY3QgSW50OEFycmF5XScsCiAgICAnW29iamVjdCBVaW50OEFycmF5XScsCiAgICAnW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0nLAogICAgJ1tvYmplY3QgSW50MTZBcnJheV0nLAogICAgJ1tvYmplY3QgVWludDE2QXJyYXldJywKICAgICdbb2JqZWN0IEludDMyQXJyYXldJywKICAgICdbb2JqZWN0IFVpbnQzMkFycmF5XScsCiAgICAnW29iamVjdCBGbG9hdDMyQXJyYXldJywKICAgICdbb2JqZWN0IEZsb2F0NjRBcnJheV0nLAogICAgJ1tvYmplY3QgRGF0YVZpZXddJywKXTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGlzRW1wdHlEYXRhKGRhdGEpIHsKICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gZGF0YS5sZW5ndGggPT09IDA7CiAgICB9CiAgICByZXR1cm4gZGF0YS5ieXRlTGVuZ3RoID09PSAwOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBjb252ZXJ0VG9CdWZmZXIoZGF0YSkgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgIGRhdGEgPSBuZXcgQnVmZmVyKGRhdGEsICd1dGY4Jyk7CiAgICB9CgogICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGggLyBVaW50OEFycmF5LkJZVEVTX1BFUl9FTEVNRU5UKTsKICAgIH0KCiAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZGF0YSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICAgIGlzRW1wdHlEYXRhOiBpc0VtcHR5RGF0YSwKICAgIGNvbnZlcnRUb0J1ZmZlcjogY29udmVydFRvQnVmZmVyLAp9OwoKfSx7ImJ1ZmZlci8iOjg0fV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBIbWFjKGhhc2hDdG9yLCBzZWNyZXQpIHsKICAgIHRoaXMuaGFzaCA9IG5ldyBoYXNoQ3RvcigpOwogICAgdGhpcy5vdXRlciA9IG5ldyBoYXNoQ3RvcigpOwoKICAgIHZhciBpbm5lciA9IGJ1ZmZlckZyb21TZWNyZXQoaGFzaEN0b3IsIHNlY3JldCk7CiAgICB2YXIgb3V0ZXIgPSBuZXcgVWludDhBcnJheShoYXNoQ3Rvci5CTE9DS19TSVpFKTsKICAgIG91dGVyLnNldChpbm5lcik7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYXNoQ3Rvci5CTE9DS19TSVpFOyBpKyspIHsKICAgICAgICBpbm5lcltpXSBePSAweDM2OwogICAgICAgIG91dGVyW2ldIF49IDB4NWM7CiAgICB9CgogICAgdGhpcy5oYXNoLnVwZGF0ZShpbm5lcik7CiAgICB0aGlzLm91dGVyLnVwZGF0ZShvdXRlcik7CgogICAgLy8gWmVybyBvdXQgdGhlIGNvcGllZCBrZXkgYnVmZmVyLgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbm5lci5ieXRlTGVuZ3RoOyBpKyspIHsKICAgICAgICBpbm5lcltpXSA9IDA7CiAgICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IEhtYWM7CgpIbWFjLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAodG9IYXNoKSB7CiAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKHRvSGFzaCkgfHwgdGhpcy5lcnJvcikgewogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIHRyeSB7CiAgICAgICAgdGhpcy5oYXNoLnVwZGF0ZShoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHRvSGFzaCkpOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIHRoaXMuZXJyb3IgPSBlOwogICAgfQoKICAgIHJldHVybiB0aGlzOwp9OwoKSG1hYy5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICBpZiAoIXRoaXMub3V0ZXIuZmluaXNoZWQpIHsKICAgICAgICB0aGlzLm91dGVyLnVwZGF0ZSh0aGlzLmhhc2guZGlnZXN0KCkpOwogICAgfQoKICAgIHJldHVybiB0aGlzLm91dGVyLmRpZ2VzdChlbmNvZGluZyk7Cn07CgpmdW5jdGlvbiBidWZmZXJGcm9tU2VjcmV0KGhhc2hDdG9yLCBzZWNyZXQpIHsKICAgIHZhciBpbnB1dCA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc2VjcmV0KTsKICAgIGlmIChpbnB1dC5ieXRlTGVuZ3RoID4gaGFzaEN0b3IuQkxPQ0tfU0laRSkgewogICAgICAgIHZhciBidWZmZXJIYXNoID0gbmV3IGhhc2hDdG9yOwogICAgICAgIGJ1ZmZlckhhc2gudXBkYXRlKGlucHV0KTsKICAgICAgICBpbnB1dCA9IGJ1ZmZlckhhc2guZGlnZXN0KCk7CiAgICB9CiAgICB2YXIgYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICBidWZmZXIuc2V0KGlucHV0KTsKICAgIHJldHVybiBidWZmZXI7Cn0KCn0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExfV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwoKdmFyIEJMT0NLX1NJWkUgPSA2NDsKCnZhciBESUdFU1RfTEVOR1RIID0gMTY7Cgp2YXIgSU5JVCA9IFsKICAgIDB4Njc0NTIzMDEsCiAgICAweGVmY2RhYjg5LAogICAgMHg5OGJhZGNmZSwKICAgIDB4MTAzMjU0NzYsCl07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBNZDUoKSB7CiAgICB0aGlzLnN0YXRlID0gWwogICAgICAgIDB4Njc0NTIzMDEsCiAgICAgICAgMHhlZmNkYWI4OSwKICAgICAgICAweDk4YmFkY2ZlLAogICAgICAgIDB4MTAzMjU0NzYsCiAgICBdOwogICAgdGhpcy5idWZmZXIgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKEJMT0NLX1NJWkUpKTsKICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgIHRoaXMuYnl0ZXNIYXNoZWQgPSAwOwogICAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBNZDU7CgpNZDUuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CgpNZDUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChzb3VyY2VEYXRhKSB7CiAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKHNvdXJjZURhdGEpKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9IGVsc2UgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgfQoKICAgIHZhciBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihzb3VyY2VEYXRhKTsKICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgIHRoaXMuYnl0ZXNIYXNoZWQgKz0gYnl0ZUxlbmd0aDsKICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuYnVmZmVyLnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIGRhdGFbcG9zaXRpb24rK10pOwogICAgICAgIGJ5dGVMZW5ndGgtLTsKICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn07CgpNZDUucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgdmFyIF9hID0gdGhpcywgYnVmZmVyID0gX2EuYnVmZmVyLCB1bmRlY29yYXRlZExlbmd0aCA9IF9hLmJ1ZmZlckxlbmd0aCwgYnl0ZXNIYXNoZWQgPSBfYS5ieXRlc0hhc2hlZDsKICAgICAgICB2YXIgYml0c0hhc2hlZCA9IGJ5dGVzSGFzaGVkICogODsKICAgICAgICBidWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgMTI4KTsKICAgICAgICAvLyBFbnN1cmUgdGhlIGZpbmFsIGJsb2NrIGhhcyBlbm91Z2ggcm9vbSBmb3IgdGhlIGhhc2hlZCBsZW5ndGgKICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgYnVmZmVyLnNldFVpbnQ4KGksIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgYnVmZmVyLnNldFVpbnQ4KGksIDApOwogICAgICAgIH0KICAgICAgICBidWZmZXIuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBiaXRzSGFzaGVkID4+PiAwLCB0cnVlKTsKICAgICAgICBidWZmZXIuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA0LCBNYXRoLmZsb29yKGJpdHNIYXNoZWQgLyAweDEwMDAwMDAwMCksIHRydWUpOwogICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgfQogICAgdmFyIG91dCA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoRElHRVNUX0xFTkdUSCkpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICBvdXQuc2V0VWludDMyKGkgKiA0LCB0aGlzLnN0YXRlW2ldLCB0cnVlKTsKICAgIH0KICAgIHZhciBidWZmID0gbmV3IEJ1ZmZlcihvdXQuYnVmZmVyLCBvdXQuYnl0ZU9mZnNldCwgb3V0LmJ5dGVMZW5ndGgpOwogICAgcmV0dXJuIGVuY29kaW5nID8gYnVmZi50b1N0cmluZyhlbmNvZGluZykgOiBidWZmOwp9OwoKTWQ1LnByb3RvdHlwZS5oYXNoQnVmZmVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIF9hID0gdGhpcywgYnVmZmVyID0gX2EuYnVmZmVyLCBzdGF0ZSA9IF9hLnN0YXRlOwogICAgdmFyIGEgPSBzdGF0ZVswXSwgYiA9IHN0YXRlWzFdLCBjID0gc3RhdGVbMl0sIGQgPSBzdGF0ZVszXTsKICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCA3LCAweGQ3NmFhNDc4KTsKICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCAxMiwgMHhlOGM3Yjc1Nik7CiAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMTcsIDB4MjQyMDcwZGIpOwogICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAyMiwgMHhjMWJkY2VlZSk7CiAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDcsIDB4ZjU3YzBmYWYpOwogICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAxMiwgMHg0Nzg3YzYyYSk7CiAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDE3LCAweGE4MzA0NjEzKTsKICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMjIsIDB4ZmQ0Njk1MDEpOwogICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA3LCAweDY5ODA5OGQ4KTsKICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgMTIsIDB4OGI0NGY3YWYpOwogICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAxNywgMHhmZmZmNWJiMSk7CiAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDIyLCAweDg5NWNkN2JlKTsKICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgNywgMHg2YjkwMTEyMik7CiAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDEyLCAweGZkOTg3MTkzKTsKICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTcsIDB4YTY3OTQzOGUpOwogICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAyMiwgMHg0OWI0MDgyMSk7CiAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNSwgMHhmNjFlMjU2Mik7CiAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDksIDB4YzA0MGIzNDApOwogICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxNCwgMHgyNjVlNWE1MSk7CiAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgMjAsIDB4ZTliNmM3YWEpOwogICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCA1LCAweGQ2MmYxMDVkKTsKICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgOSwgMHgwMjQ0MTQ1Myk7CiAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDE0LCAweGQ4YTFlNjgxKTsKICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMjAsIDB4ZTdkM2ZiYzgpOwogICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCA1LCAweDIxZTFjZGU2KTsKICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgOSwgMHhjMzM3MDdkNik7CiAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDE0LCAweGY0ZDUwZDg3KTsKICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgMjAsIDB4NDU1YTE0ZWQpOwogICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA1LCAweGE5ZTNlOTA1KTsKICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCA5LCAweGZjZWZhM2Y4KTsKICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTQsIDB4Njc2ZjAyZDkpOwogICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAyMCwgMHg4ZDJhNGM4YSk7CiAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDQsIDB4ZmZmYTM5NDIpOwogICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCAxMSwgMHg4NzcxZjY4MSk7CiAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE2LCAweDZkOWQ2MTIyKTsKICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMjMsIDB4ZmRlNTM4MGMpOwogICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDQsIDB4YTRiZWVhNDQpOwogICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAxMSwgMHg0YmRlY2ZhOSk7CiAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE2LCAweGY2YmI0YjYwKTsKICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMjMsIDB4YmViZmJjNzApOwogICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA0LCAweDI4OWI3ZWM2KTsKICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCAxMSwgMHhlYWExMjdmYSk7CiAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDE2LCAweGQ0ZWYzMDg1KTsKICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMjMsIDB4MDQ4ODFkMDUpOwogICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCA0LCAweGQ5ZDRkMDM5KTsKICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgMTEsIDB4ZTZkYjk5ZTUpOwogICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNiwgMHgxZmEyN2NmOCk7CiAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMjMsIDB4YzRhYzU2NjUpOwogICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDYsIDB4ZjQyOTIyNDQpOwogICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxMCwgMHg0MzJhZmY5Nyk7CiAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDE1LCAweGFiOTQyM2E3KTsKICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgMjEsIDB4ZmM5M2EwMzkpOwogICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA2LCAweDY1NWI1OWMzKTsKICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTAsIDB4OGYwY2NjOTIpOwogICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAxNSwgMHhmZmVmZjQ3ZCk7CiAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMjEsIDB4ODU4NDVkZDEpOwogICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA2LCAweDZmYTg3ZTRmKTsKICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTAsIDB4ZmUyY2U2ZTApOwogICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNSwgMHhhMzAxNDMxNCk7CiAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDIxLCAweDRlMDgxMWExKTsKICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgNiwgMHhmNzUzN2U4Mik7CiAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDEwLCAweGJkM2FmMjM1KTsKICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNSwgMHgyYWQ3ZDJiYik7CiAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDIxLCAweGViODZkMzkxKTsKICAgIHN0YXRlWzBdID0gKGEgKyBzdGF0ZVswXSkgJiAweEZGRkZGRkZGOwogICAgc3RhdGVbMV0gPSAoYiArIHN0YXRlWzFdKSAmIDB4RkZGRkZGRkY7CiAgICBzdGF0ZVsyXSA9IChjICsgc3RhdGVbMl0pICYgMHhGRkZGRkZGRjsKICAgIHN0YXRlWzNdID0gKGQgKyBzdGF0ZVszXSkgJiAweEZGRkZGRkZGOwp9OwoKZnVuY3Rpb24gY21uKHEsIGEsIGIsIHgsIHMsIHQpIHsKICAgIGEgPSAoKChhICsgcSkgJiAweEZGRkZGRkZGKSArICgoeCArIHQpICYgMHhGRkZGRkZGRikpICYgMHhGRkZGRkZGRjsKICAgIHJldHVybiAoKChhIDw8IHMpIHwgKGEgPj4+ICgzMiAtIHMpKSkgKyBiKSAmIDB4RkZGRkZGRkY7Cn0KCmZ1bmN0aW9uIGZmKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBjbW4oKGIgJiBjKSB8ICgofmIpICYgZCksIGEsIGIsIHgsIHMsIHQpOwp9CgpmdW5jdGlvbiBnZyhhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gY21uKChiICYgZCkgfCAoYyAmICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKfQoKZnVuY3Rpb24gaGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIGNtbihiIF4gYyBeIGQsIGEsIGIsIHgsIHMsIHQpOwp9CgpmdW5jdGlvbiBpaShhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gY21uKGMgXiAoYiB8ICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKfQoKfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjg0fV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwoKdmFyIEJMT0NLX1NJWkUgPSA2NDsKCnZhciBESUdFU1RfTEVOR1RIID0gMjA7Cgp2YXIgS0VZID0gbmV3IFVpbnQzMkFycmF5KFsKICAgIDB4NWE4Mjc5OTksCiAgICAweDZlZDllYmExLAogICAgMHg4ZjFiYmNkYyB8IDAsCiAgICAweGNhNjJjMWQ2IHwgMApdKTsKCnZhciBJTklUID0gWwogICAgMHg2YTA5ZTY2NywKICAgIDB4YmI2N2FlODUsCiAgICAweDNjNmVmMzcyLAogICAgMHhhNTRmZjUzYSwKICAgIDB4NTEwZTUyN2YsCiAgICAweDliMDU2ODhjLAogICAgMHgxZjgzZDlhYiwKICAgIDB4NWJlMGNkMTksCl07Cgp2YXIgTUFYX0hBU0hBQkxFX0xFTkdUSCA9IE1hdGgucG93KDIsIDUzKSAtIDE7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBTaGExKCkgewogICAgdGhpcy5oMCA9IDB4Njc0NTIzMDE7CiAgICB0aGlzLmgxID0gMHhFRkNEQUI4OTsKICAgIHRoaXMuaDIgPSAweDk4QkFEQ0ZFOwogICAgdGhpcy5oMyA9IDB4MTAzMjU0NzY7CiAgICB0aGlzLmg0ID0gMHhDM0QyRTFGMDsKICAgIC8vIFRoZSBmaXJzdCA2NCBieXRlcyAoMTYgd29yZHMpIGlzIHRoZSBkYXRhIGNodW5rCiAgICB0aGlzLmJsb2NrID0gbmV3IFVpbnQzMkFycmF5KDgwKTsKICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgIHRoaXMudG90YWxMZW5ndGggPSAwOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBTaGExOwoKU2hhMS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKClNoYTEucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICB9CgogICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShkYXRhKSkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwoKICAgIHZhciBsZW5ndGggPSBkYXRhLmxlbmd0aDsKICAgIHRoaXMudG90YWxMZW5ndGggKz0gbGVuZ3RoICogODsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLndyaXRlKGRhdGFbaV0pOwogICAgfQoKICAgIHJldHVybiB0aGlzOwp9OwoKU2hhMS5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiB3cml0ZShieXRlKSB7CiAgICB0aGlzLmJsb2NrW3RoaXMub2Zmc2V0XSB8PSAoYnl0ZSAmIDB4ZmYpIDw8IHRoaXMuc2hpZnQ7CiAgICBpZiAodGhpcy5zaGlmdCkgewogICAgICAgIHRoaXMuc2hpZnQgLT0gODsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICB0aGlzLnNoaWZ0ID0gMjQ7CiAgICB9CgogICAgaWYgKHRoaXMub2Zmc2V0ID09PSAxNikgdGhpcy5wcm9jZXNzQmxvY2soKTsKfTsKClNoYTEucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgLy8gUGFkCiAgICB0aGlzLndyaXRlKDB4ODApOwogICAgaWYgKHRoaXMub2Zmc2V0ID4gMTQgfHwgKHRoaXMub2Zmc2V0ID09PSAxNCAmJiB0aGlzLnNoaWZ0IDwgMjQpKSB7CiAgICAgIHRoaXMucHJvY2Vzc0Jsb2NrKCk7CiAgICB9CiAgICB0aGlzLm9mZnNldCA9IDE0OwogICAgdGhpcy5zaGlmdCA9IDI0OwoKICAgIC8vIDY0LWJpdCBsZW5ndGggYmlnLWVuZGlhbgogICAgdGhpcy53cml0ZSgweDAwKTsgLy8gbnVtYmVycyB0aGlzIGJpZyBhcmVuJ3QgYWNjdXJhdGUgaW4gamF2YXNjcmlwdCBhbnl3YXkKICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIC4uU28ganVzdCBoYXJkLWNvZGUgdG8gemVyby4KICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+IDB4ZmZmZmZmZmZmZiA/IHRoaXMudG90YWxMZW5ndGggLyAweDEwMDAwMDAwMDAwIDogMHgwMCk7CiAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwIDogMHgwMCk7CiAgICBmb3IgKHZhciBzID0gMjQ7IHMgPj0gMDsgcyAtPSA4KSB7CiAgICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4+IHMpOwogICAgfQogICAgLy8gVGhlIHZhbHVlIGluIHN0YXRlIGlzIGxpdHRsZS1lbmRpYW4gcmF0aGVyIHRoYW4gYmlnLWVuZGlhbiwgc28gZmxpcAogICAgLy8gZWFjaCB3b3JkIGludG8gYSBuZXcgVWludDhBcnJheQogICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICB2YXIgb3V0VmlldyA9IG5ldyBEYXRhVmlldyhvdXQuYnVmZmVyKTsKICAgIG91dFZpZXcuc2V0VWludDMyKDAsIHRoaXMuaDAsIGZhbHNlKTsKICAgIG91dFZpZXcuc2V0VWludDMyKDQsIHRoaXMuaDEsIGZhbHNlKTsKICAgIG91dFZpZXcuc2V0VWludDMyKDgsIHRoaXMuaDIsIGZhbHNlKTsKICAgIG91dFZpZXcuc2V0VWludDMyKDEyLCB0aGlzLmgzLCBmYWxzZSk7CiAgICBvdXRWaWV3LnNldFVpbnQzMigxNiwgdGhpcy5oNCwgZmFsc2UpOwoKICAgIHJldHVybiBlbmNvZGluZyA/IG91dC50b1N0cmluZyhlbmNvZGluZykgOiBvdXQ7Cn07CgpTaGExLnByb3RvdHlwZS5wcm9jZXNzQmxvY2sgPSBmdW5jdGlvbiBwcm9jZXNzQmxvY2soKSB7CiAgICAvLyBFeHRlbmQgdGhlIHNpeHRlZW4gMzItYml0IHdvcmRzIGludG8gZWlnaHR5IDMyLWJpdCB3b3JkczoKICAgIGZvciAodmFyIGkgPSAxNjsgaSA8IDgwOyBpKyspIHsKICAgICAgdmFyIHcgPSB0aGlzLmJsb2NrW2kgLSAzXSBeIHRoaXMuYmxvY2tbaSAtIDhdIF4gdGhpcy5ibG9ja1tpIC0gMTRdIF4gdGhpcy5ibG9ja1tpIC0gMTZdOwogICAgICB0aGlzLmJsb2NrW2ldID0gKHcgPDwgMSkgfCAodyA+Pj4gMzEpOwogICAgfQoKICAgIC8vIEluaXRpYWxpemUgaGFzaCB2YWx1ZSBmb3IgdGhpcyBjaHVuazoKICAgIHZhciBhID0gdGhpcy5oMDsKICAgIHZhciBiID0gdGhpcy5oMTsKICAgIHZhciBjID0gdGhpcy5oMjsKICAgIHZhciBkID0gdGhpcy5oMzsKICAgIHZhciBlID0gdGhpcy5oNDsKICAgIHZhciBmLCBrOwoKICAgIC8vIE1haW4gbG9vcDoKICAgIGZvciAoaSA9IDA7IGkgPCA4MDsgaSsrKSB7CiAgICAgIGlmIChpIDwgMjApIHsKICAgICAgICBmID0gZCBeIChiICYgKGMgXiBkKSk7CiAgICAgICAgayA9IDB4NUE4Mjc5OTk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAoaSA8IDQwKSB7CiAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICBrID0gMHg2RUQ5RUJBMTsKICAgICAgfQogICAgICBlbHNlIGlmIChpIDwgNjApIHsKICAgICAgICBmID0gKGIgJiBjKSB8IChkICYgKGIgfCBjKSk7CiAgICAgICAgayA9IDB4OEYxQkJDREM7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICBrID0gMHhDQTYyQzFENjsKICAgICAgfQogICAgICB2YXIgdGVtcCA9IChhIDw8IDUgfCBhID4+PiAyNykgKyBmICsgZSArIGsgKyAodGhpcy5ibG9ja1tpXXwwKTsKICAgICAgZSA9IGQ7CiAgICAgIGQgPSBjOwogICAgICBjID0gKGIgPDwgMzAgfCBiID4+PiAyKTsKICAgICAgYiA9IGE7CiAgICAgIGEgPSB0ZW1wOwogICAgfQoKICAgIC8vIEFkZCB0aGlzIGNodW5rJ3MgaGFzaCB0byByZXN1bHQgc28gZmFyOgogICAgdGhpcy5oMCA9ICh0aGlzLmgwICsgYSkgfCAwOwogICAgdGhpcy5oMSA9ICh0aGlzLmgxICsgYikgfCAwOwogICAgdGhpcy5oMiA9ICh0aGlzLmgyICsgYykgfCAwOwogICAgdGhpcy5oMyA9ICh0aGlzLmgzICsgZCkgfCAwOwogICAgdGhpcy5oNCA9ICh0aGlzLmg0ICsgZSkgfCAwOwoKICAgIC8vIFRoZSBibG9jayBpcyBub3cgcmV1c2FibGUuCiAgICB0aGlzLm9mZnNldCA9IDA7CiAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkrKykgewogICAgICAgIHRoaXMuYmxvY2tbaV0gPSAwOwogICAgfQp9OwoKfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjg0fV0sMTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwoKdmFyIEJMT0NLX1NJWkUgPSA2NDsKCnZhciBESUdFU1RfTEVOR1RIID0gMzI7Cgp2YXIgS0VZID0gbmV3IFVpbnQzMkFycmF5KFsKICAgIDB4NDI4YTJmOTgsCiAgICAweDcxMzc0NDkxLAogICAgMHhiNWMwZmJjZiwKICAgIDB4ZTliNWRiYTUsCiAgICAweDM5NTZjMjViLAogICAgMHg1OWYxMTFmMSwKICAgIDB4OTIzZjgyYTQsCiAgICAweGFiMWM1ZWQ1LAogICAgMHhkODA3YWE5OCwKICAgIDB4MTI4MzViMDEsCiAgICAweDI0MzE4NWJlLAogICAgMHg1NTBjN2RjMywKICAgIDB4NzJiZTVkNzQsCiAgICAweDgwZGViMWZlLAogICAgMHg5YmRjMDZhNywKICAgIDB4YzE5YmYxNzQsCiAgICAweGU0OWI2OWMxLAogICAgMHhlZmJlNDc4NiwKICAgIDB4MGZjMTlkYzYsCiAgICAweDI0MGNhMWNjLAogICAgMHgyZGU5MmM2ZiwKICAgIDB4NGE3NDg0YWEsCiAgICAweDVjYjBhOWRjLAogICAgMHg3NmY5ODhkYSwKICAgIDB4OTgzZTUxNTIsCiAgICAweGE4MzFjNjZkLAogICAgMHhiMDAzMjdjOCwKICAgIDB4YmY1OTdmYzcsCiAgICAweGM2ZTAwYmYzLAogICAgMHhkNWE3OTE0NywKICAgIDB4MDZjYTYzNTEsCiAgICAweDE0MjkyOTY3LAogICAgMHgyN2I3MGE4NSwKICAgIDB4MmUxYjIxMzgsCiAgICAweDRkMmM2ZGZjLAogICAgMHg1MzM4MGQxMywKICAgIDB4NjUwYTczNTQsCiAgICAweDc2NmEwYWJiLAogICAgMHg4MWMyYzkyZSwKICAgIDB4OTI3MjJjODUsCiAgICAweGEyYmZlOGExLAogICAgMHhhODFhNjY0YiwKICAgIDB4YzI0YjhiNzAsCiAgICAweGM3NmM1MWEzLAogICAgMHhkMTkyZTgxOSwKICAgIDB4ZDY5OTA2MjQsCiAgICAweGY0MGUzNTg1LAogICAgMHgxMDZhYTA3MCwKICAgIDB4MTlhNGMxMTYsCiAgICAweDFlMzc2YzA4LAogICAgMHgyNzQ4Nzc0YywKICAgIDB4MzRiMGJjYjUsCiAgICAweDM5MWMwY2IzLAogICAgMHg0ZWQ4YWE0YSwKICAgIDB4NWI5Y2NhNGYsCiAgICAweDY4MmU2ZmYzLAogICAgMHg3NDhmODJlZSwKICAgIDB4NzhhNTYzNmYsCiAgICAweDg0Yzg3ODE0LAogICAgMHg4Y2M3MDIwOCwKICAgIDB4OTBiZWZmZmEsCiAgICAweGE0NTA2Y2ViLAogICAgMHhiZWY5YTNmNywKICAgIDB4YzY3MTc4ZjIKXSk7Cgp2YXIgSU5JVCA9IFsKICAgIDB4NmEwOWU2NjcsCiAgICAweGJiNjdhZTg1LAogICAgMHgzYzZlZjM3MiwKICAgIDB4YTU0ZmY1M2EsCiAgICAweDUxMGU1MjdmLAogICAgMHg5YjA1Njg4YywKICAgIDB4MWY4M2Q5YWIsCiAgICAweDViZTBjZDE5LApdOwoKdmFyIE1BWF9IQVNIQUJMRV9MRU5HVEggPSBNYXRoLnBvdygyLCA1MykgLSAxOwoKLyoqCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBTaGEyNTYoKSB7CiAgICB0aGlzLnN0YXRlID0gWwogICAgICAgIDB4NmEwOWU2NjcsCiAgICAgICAgMHhiYjY3YWU4NSwKICAgICAgICAweDNjNmVmMzcyLAogICAgICAgIDB4YTU0ZmY1M2EsCiAgICAgICAgMHg1MTBlNTI3ZiwKICAgICAgICAweDliMDU2ODhjLAogICAgICAgIDB4MWY4M2Q5YWIsCiAgICAgICAgMHg1YmUwY2QxOSwKICAgIF07CiAgICB0aGlzLnRlbXAgPSBuZXcgSW50MzJBcnJheSg2NCk7CiAgICB0aGlzLmJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDY0KTsKICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgIHRoaXMuYnl0ZXNIYXNoZWQgPSAwOwogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTI1NjsKClNoYTI1Ni5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKClNoYTI1Ni5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgIH0KCiAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoZGF0YSk7CgogICAgdmFyIHBvc2l0aW9uID0gMDsKICAgIHZhciBieXRlTGVuZ3RoID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgaWYgKHRoaXMuYnl0ZXNIYXNoZWQgKiA4ID4gTUFYX0hBU0hBQkxFX0xFTkdUSCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGhhc2ggbW9yZSB0aGFuIDJeNTMgLSAxIGJpdHMnKTsKICAgIH0KCiAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDApIHsKICAgICAgICB0aGlzLmJ1ZmZlclt0aGlzLmJ1ZmZlckxlbmd0aCsrXSA9IGRhdGFbcG9zaXRpb24rK107CiAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgIGlmICh0aGlzLmJ1ZmZlckxlbmd0aCA9PT0gQkxPQ0tfU0laRSkgewogICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpczsKfTsKClNoYTI1Ni5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICB2YXIgYml0c0hhc2hlZCA9IHRoaXMuYnl0ZXNIYXNoZWQgKiA4OwogICAgICAgIHZhciBidWZmZXJWaWV3ID0gbmV3IERhdGFWaWV3KHRoaXMuYnVmZmVyLmJ1ZmZlciwgdGhpcy5idWZmZXIuYnl0ZU9mZnNldCwgdGhpcy5idWZmZXIuYnl0ZUxlbmd0aCk7CiAgICAgICAgdmFyIHVuZGVjb3JhdGVkTGVuZ3RoID0gdGhpcy5idWZmZXJMZW5ndGg7CiAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAweDgwKTsKICAgICAgICAvLyBFbnN1cmUgdGhlIGZpbmFsIGJsb2NrIGhhcyBlbm91Z2ggcm9vbSBmb3IgdGhlIGhhc2hlZCBsZW5ndGgKICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OChpLCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFIC0gODsgaSsrKSB7CiAgICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgoaSwgMCk7CiAgICAgICAgfQogICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBNYXRoLmZsb29yKGJpdHNIYXNoZWQgLyAweDEwMDAwMDAwMCksIHRydWUpOwogICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA0LCBiaXRzSGFzaGVkKTsKICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKICAgIH0KICAgIC8vIFRoZSB2YWx1ZSBpbiBzdGF0ZSBpcyBsaXR0bGUtZW5kaWFuIHJhdGhlciB0aGFuIGJpZy1lbmRpYW4sIHNvIGZsaXAKICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgIHZhciBvdXQgPSBuZXcgQnVmZmVyKERJR0VTVF9MRU5HVEgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICBvdXRbaSAqIDRdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDI0KSAmIDB4ZmY7CiAgICAgICAgb3V0W2kgKiA0ICsgMV0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMTYpICYgMHhmZjsKICAgICAgICBvdXRbaSAqIDQgKyAyXSA9ICh0aGlzLnN0YXRlW2ldID4+PiA4KSAmIDB4ZmY7CiAgICAgICAgb3V0W2kgKiA0ICsgM10gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMCkgJiAweGZmOwogICAgfQogICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKfTsKClNoYTI1Ni5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgYnVmZmVyID0gX2EuYnVmZmVyLAogICAgICAgIHN0YXRlID0gX2Euc3RhdGU7CiAgICB2YXIgc3RhdGUwID0gc3RhdGVbMF0sCiAgICAgICAgc3RhdGUxID0gc3RhdGVbMV0sCiAgICAgICAgc3RhdGUyID0gc3RhdGVbMl0sCiAgICAgICAgc3RhdGUzID0gc3RhdGVbM10sCiAgICAgICAgc3RhdGU0ID0gc3RhdGVbNF0sCiAgICAgICAgc3RhdGU1ID0gc3RhdGVbNV0sCiAgICAgICAgc3RhdGU2ID0gc3RhdGVbNl0sCiAgICAgICAgc3RhdGU3ID0gc3RhdGVbN107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgIGlmIChpIDwgMTYpIHsKICAgICAgICAgICAgdGhpcy50ZW1wW2ldID0gKCgoYnVmZmVyW2kgKiA0XSAmIDB4ZmYpIDw8IDI0KSB8CiAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMV0gJiAweGZmKSA8PCAxNikgfAogICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDJdICYgMHhmZikgPDwgOCkgfAogICAgICAgICAgICAgICAgKGJ1ZmZlclsoaSAqIDQpICsgM10gJiAweGZmKSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgdSA9IHRoaXMudGVtcFtpIC0gMl07CiAgICAgICAgICAgIHZhciB0MV8xID0gKHUgPj4+IDE3IHwgdSA8PCAxNSkgXgogICAgICAgICAgICAgICAgKHUgPj4+IDE5IHwgdSA8PCAxMykgXgogICAgICAgICAgICAgICAgKHUgPj4+IDEwKTsKICAgICAgICAgICAgdSA9IHRoaXMudGVtcFtpIC0gMTVdOwogICAgICAgICAgICB2YXIgdDJfMSA9ICh1ID4+PiA3IHwgdSA8PCAyNSkgXgogICAgICAgICAgICAgICAgKHUgPj4+IDE4IHwgdSA8PCAxNCkgXgogICAgICAgICAgICAgICAgKHUgPj4+IDMpOwogICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAodDFfMSArIHRoaXMudGVtcFtpIC0gN10gfCAwKSArCiAgICAgICAgICAgICAgICAodDJfMSArIHRoaXMudGVtcFtpIC0gMTZdIHwgMCk7CiAgICAgICAgfQogICAgICAgIHZhciB0MSA9ICgoKCgoc3RhdGU0ID4+PiA2IHwgc3RhdGU0IDw8IDI2KSBeCiAgICAgICAgICAgIChzdGF0ZTQgPj4+IDExIHwgc3RhdGU0IDw8IDIxKSBeCiAgICAgICAgICAgIChzdGF0ZTQgPj4+IDI1IHwgc3RhdGU0IDw8IDcpKQogICAgICAgICAgICArICgoc3RhdGU0ICYgc3RhdGU1KSBeICh+c3RhdGU0ICYgc3RhdGU2KSkpIHwgMCkKICAgICAgICAgICAgKyAoKHN0YXRlNyArICgoS0VZW2ldICsgdGhpcy50ZW1wW2ldKSB8IDApKSB8IDApKSB8IDA7CiAgICAgICAgdmFyIHQyID0gKCgoc3RhdGUwID4+PiAyIHwgc3RhdGUwIDw8IDMwKSBeCiAgICAgICAgICAgIChzdGF0ZTAgPj4+IDEzIHwgc3RhdGUwIDw8IDE5KSBeCiAgICAgICAgICAgIChzdGF0ZTAgPj4+IDIyIHwgc3RhdGUwIDw8IDEwKSkgKyAoKHN0YXRlMCAmIHN0YXRlMSkgXiAoc3RhdGUwICYgc3RhdGUyKSBeIChzdGF0ZTEgJiBzdGF0ZTIpKSkgfCAwOwogICAgICAgIHN0YXRlNyA9IHN0YXRlNjsKICAgICAgICBzdGF0ZTYgPSBzdGF0ZTU7CiAgICAgICAgc3RhdGU1ID0gc3RhdGU0OwogICAgICAgIHN0YXRlNCA9IChzdGF0ZTMgKyB0MSkgfCAwOwogICAgICAgIHN0YXRlMyA9IHN0YXRlMjsKICAgICAgICBzdGF0ZTIgPSBzdGF0ZTE7CiAgICAgICAgc3RhdGUxID0gc3RhdGUwOwogICAgICAgIHN0YXRlMCA9ICh0MSArIHQyKSB8IDA7CiAgICB9CiAgICBzdGF0ZVswXSArPSBzdGF0ZTA7CiAgICBzdGF0ZVsxXSArPSBzdGF0ZTE7CiAgICBzdGF0ZVsyXSArPSBzdGF0ZTI7CiAgICBzdGF0ZVszXSArPSBzdGF0ZTM7CiAgICBzdGF0ZVs0XSArPSBzdGF0ZTQ7CiAgICBzdGF0ZVs1XSArPSBzdGF0ZTU7CiAgICBzdGF0ZVs2XSArPSBzdGF0ZTY7CiAgICBzdGF0ZVs3XSArPSBzdGF0ZTc7Cn07Cgp9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODR9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwoKLy8gYnJvd3NlciBzcGVjaWZpYyBtb2R1bGVzCnV0aWwuY3J5cHRvLmxpYiA9IHJlcXVpcmUoJy4vYnJvd3NlckNyeXB0b0xpYicpOwp1dGlsLkJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CnV0aWwudXJsID0gcmVxdWlyZSgndXJsLycpOwp1dGlsLnF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcvJyk7CnV0aWwucmVhbENsb2NrID0gcmVxdWlyZSgnLi9yZWFsY2xvY2svYnJvd3NlckNsb2NrJyk7CnV0aWwuZW52aXJvbm1lbnQgPSAnanMnOwp1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtID0gcmVxdWlyZSgnLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbScpLmNyZWF0ZUV2ZW50U3RyZWFtOwp1dGlsLmlzQnJvd3NlciA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfTsKdXRpbC5pc05vZGUgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9OwoKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1M7CgpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3RlbXBvcmFyeV9jcmVkZW50aWFscycpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NoYWluYWJsZV90ZW1wb3JhcnlfY3JlZGVudGlhbHMnKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jb2duaXRvX2lkZW50aXR5X2NyZWRlbnRpYWxzJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMvc2FtbF9jcmVkZW50aWFscycpOwoKLy8gTG9hZCB0aGUgRE9NUGFyc2VyIFhNTCBwYXJzZXIKQVdTLlhNTC5QYXJzZXIgPSByZXF1aXJlKCcuL3htbC9icm93c2VyX3BhcnNlcicpOwoKLy8gTG9hZCB0aGUgWEhSIEh0dHBDbGllbnQKcmVxdWlyZSgnLi9odHRwL3hocicpOwoKaWYgKHR5cGVvZiBwcm9jZXNzID09PSAndW5kZWZpbmVkJykgewogIHZhciBwcm9jZXNzID0gewogICAgYnJvd3NlcjogdHJ1ZQogIH07Cn0KCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vYnJvd3NlckNyeXB0b0xpYiI6MTAsIi4vY29yZSI6MTksIi4vY3JlZGVudGlhbHMiOjIwLCIuL2NyZWRlbnRpYWxzL2NoYWluYWJsZV90ZW1wb3JhcnlfY3JlZGVudGlhbHMiOjIxLCIuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMiOjIyLCIuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4iOjIzLCIuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMiOjI0LCIuL2NyZWRlbnRpYWxzL3RlbXBvcmFyeV9jcmVkZW50aWFscyI6MjUsIi4vY3JlZGVudGlhbHMvd2ViX2lkZW50aXR5X2NyZWRlbnRpYWxzIjoyNiwiLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbSI6MjgsIi4vaHR0cC94aHIiOjM2LCIuL3JlYWxjbG9jay9icm93c2VyQ2xvY2siOjUzLCIuL3V0aWwiOjcyLCIuL3htbC9icm93c2VyX3BhcnNlciI6NzMsIl9wcm9jZXNzIjo4OSwiYnVmZmVyLyI6ODQsInF1ZXJ5c3RyaW5nLyI6OTYsInVybC8iOjk4fV0sMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMnKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluJyk7CnZhciBQcm9taXNlc0RlcGVuZGVuY3k7CgovKioKICogVGhlIG1haW4gY29uZmlndXJhdGlvbiBjbGFzcyB1c2VkIGJ5IGFsbCBzZXJ2aWNlIG9iamVjdHMgdG8gc2V0CiAqIHRoZSByZWdpb24sIGNyZWRlbnRpYWxzLCBhbmQgb3RoZXIgb3B0aW9ucyBmb3IgcmVxdWVzdHMuCiAqCiAqIEJ5IGRlZmF1bHQsIGNyZWRlbnRpYWxzIGFuZCByZWdpb24gc2V0dGluZ3MgYXJlIGxlZnQgdW5jb25maWd1cmVkLgogKiBUaGlzIHNob3VsZCBiZSBjb25maWd1cmVkIGJ5IHRoZSBhcHBsaWNhdGlvbiBiZWZvcmUgdXNpbmcgYW55CiAqIEFXUyBzZXJ2aWNlIEFQSXMuCiAqCiAqIEluIG9yZGVyIHRvIHNldCBnbG9iYWwgY29uZmlndXJhdGlvbiBvcHRpb25zLCBwcm9wZXJ0aWVzIHNob3VsZAogKiBiZSBhc3NpZ25lZCB0byB0aGUgZ2xvYmFsIHtBV1MuY29uZmlnfSBvYmplY3QuCiAqCiAqIEBzZWUgQVdTLmNvbmZpZwogKgogKiBAIWdyb3VwIEdlbmVyYWwgQ29uZmlndXJhdGlvbiBPcHRpb25zCiAqCiAqIEAhYXR0cmlidXRlIGNyZWRlbnRpYWxzCiAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgQVdTIGNyZWRlbnRpYWxzIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4KICoKICogQCFhdHRyaWJ1dGUgcmVnaW9uCiAqICAgQGV4YW1wbGUgU2V0IHRoZSBnbG9iYWwgcmVnaW9uIHNldHRpbmcgdG8gdXMtd2VzdC0yCiAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmVnaW9uOiAndXMtd2VzdC0yJ30pOwogKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gVGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAqICAgQHNlZSBodHRwOi8vZG9jcy5hbWF6b253ZWJzZXJ2aWNlcy5jb20vZ2VuZXJhbC9sYXRlc3QvZ3IvcmFuZGUuaHRtbAogKiAgICAgQSBsaXN0IG9mIGF2YWlsYWJsZSBlbmRwb2ludHMgZm9yIGVhY2ggQVdTIHNlcnZpY2UKICoKICogQCFhdHRyaWJ1dGUgbWF4UmV0cmllcwogKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZXRyaWVzIHRvIHBlcmZvcm0gZm9yIGEKICogICAgIHNlcnZpY2UgcmVxdWVzdC4gQnkgZGVmYXVsdCB0aGlzIHZhbHVlIGlzIGNhbGN1bGF0ZWQgYnkgdGhlIHNwZWNpZmljCiAqICAgICBzZXJ2aWNlIG9iamVjdCB0aGF0IHRoZSByZXF1ZXN0IGlzIGJlaW5nIG1hZGUgdG8uCiAqCiAqIEAhYXR0cmlidXRlIG1heFJlZGlyZWN0cwogKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZWRpcmVjdHMgdG8gZm9sbG93IGZvciBhCiAqICAgICBzZXJ2aWNlIHJlcXVlc3QuIERlZmF1bHRzIHRvIDEwLgogKgogKiBAIWF0dHJpYnV0ZSBwYXJhbVZhbGlkYXRpb24KICogICBAcmV0dXJuIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzIHNob3VsZCBiZSB2YWxpZGF0ZWQgYWdhaW5zdAogKiAgICAgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZyB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4KICogICAgIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAqCiAqICAgICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAqICAgICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogKiAgICAgICB0byBgdHJ1ZWAuCiAqICAgICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAqICAgICAgIGNvbnN0cmFpbnQuCiAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogKiAgICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAqICAgICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAqCiAqIEAhYXR0cmlidXRlIGNvbXB1dGVDaGVja3N1bXMKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbXB1dGUgY2hlY2tzdW1zIGZvciBwYXlsb2FkIGJvZGllcyB3aGVuCiAqICAgICB0aGUgc2VydmljZSBhY2NlcHRzIGl0IChjdXJyZW50bHkgc3VwcG9ydGVkIGluIFMzIGFuZCBTUVMgb25seSkuCiAqCiAqIEAhYXR0cmlidXRlIGNvbnZlcnRSZXNwb25zZVR5cGVzCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0eXBlcyBhcmUgY29udmVydGVkIHdoZW4gcGFyc2luZyByZXNwb25zZSBkYXRhLgogKiAgICAgQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGZvciBKU09OIGJhc2VkIHNlcnZpY2VzLiBUdXJuaW5nIHRoaXMgb2ZmIG1heQogKiAgICAgaW1wcm92ZSBwZXJmb3JtYW5jZSBvbiBsYXJnZSByZXNwb25zZSBwYXlsb2Fkcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogKgogKiBAIWF0dHJpYnV0ZSBjb3JyZWN0Q2xvY2tTa2V3CiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBhcHBseSBhIGNsb2NrIHNrZXcgY29ycmVjdGlvbiBhbmQgcmV0cnkKICogICAgIHJlcXVlc3RzIHRoYXQgZmFpbCBiZWNhdXNlIG9mIGFuIHNrZXdlZCBjbGllbnQgY2xvY2suIERlZmF1bHRzIHRvCiAqICAgICBgZmFsc2VgLgogKgogKiBAIWF0dHJpYnV0ZSBzc2xFbmFibGVkCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBTU0wgaXMgZW5hYmxlZCBmb3IgcmVxdWVzdHMKICoKICogQCFhdHRyaWJ1dGUgczNGb3JjZVBhdGhTdHlsZQogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZm9yY2UgcGF0aCBzdHlsZSBVUkxzIGZvciBTMyBvYmplY3RzCiAqCiAqIEAhYXR0cmlidXRlIHMzQnVja2V0RW5kcG9pbnQKICogICBAbm90ZSBTZXR0aW5nIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gcmVxdWlyZXMgYW4gYGVuZHBvaW50YCB0byBiZQogKiAgICAgcHJvdmlkZWQgZXhwbGljaXRseSB0byB0aGUgc2VydmljZSBjb25zdHJ1Y3Rvci4KICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBwcm92aWRlZCBlbmRwb2ludCBhZGRyZXNzZXMgYW4gaW5kaXZpZHVhbAogKiAgICAgYnVja2V0IChmYWxzZSBpZiBpdCBhZGRyZXNzZXMgdGhlIHJvb3QgQVBJIGVuZHBvaW50KS4KICoKICogQCFhdHRyaWJ1dGUgczNEaXNhYmxlQm9keVNpZ25pbmcKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGRpc2FibGUgUzMgYm9keSBzaWduaW5nIHdoZW4gdXNpbmcgc2lnbmF0dXJlIHZlcnNpb24gYHY0YC4KICogICAgIEJvZHkgc2lnbmluZyBjYW4gb25seSBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIGh0dHBzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAqCiAqIEAhYXR0cmlidXRlIHMzVXNFYXN0MVJlZ2lvbmFsRW5kcG9pbnQKICogICBAcmV0dXJuIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGVuIHJlZ2lvbiBpcyBzZXQgdG8gJ3VzLWVhc3QtMScsIHdoZXRoZXIgdG8gc2VuZCBzMwogKiAgICAgcmVxdWVzdCB0byBnbG9iYWwgZW5kcG9pbnRzIG9yICd1cy1lYXN0LTEnIHJlZ2lvbmFsIGVuZHBvaW50cy4gVGhpcyBjb25maWcgaXMgb25seQogKiAgICAgYXBwbGljYWJsZSB0byBTMyBjbGllbnQ7CiAqICAgICBEZWZhdWx0cyB0byAnbGVnYWN5JwogKiBAIWF0dHJpYnV0ZSBzM1VzZUFyblJlZ2lvbgogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gb3ZlcnJpZGUgdGhlIHJlcXVlc3QgcmVnaW9uIHdpdGggdGhlIHJlZ2lvbiBpbmZlcnJlZAogKiAgICAgZnJvbSByZXF1ZXN0ZWQgcmVzb3VyY2UncyBBUk4uIE9ubHkgYXZhaWxhYmxlIGZvciBTMyBidWNrZXRzCiAqICAgICBEZWZhdWx0cyB0byBgdHJ1ZWAKICoKICogQCFhdHRyaWJ1dGUgdXNlQWNjZWxlcmF0ZUVuZHBvaW50CiAqICAgQG5vdGUgVGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiBpcyBvbmx5IGNvbXBhdGlibGUgd2l0aCBTMyB3aGlsZSBhY2Nlc3NpbmcKICogICAgIGRucy1jb21wYXRpYmxlIGJ1Y2tldHMuCiAqICAgQHJldHVybiBbQm9vbGVhbl0gV2hldGhlciB0byB1c2UgdGhlIEFjY2VsZXJhdGUgZW5kcG9pbnQgd2l0aCB0aGUgUzMgc2VydmljZS4KICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAqCiAqIEAhYXR0cmlidXRlIHJldHJ5RGVsYXlPcHRpb25zCiAqICAgQGV4YW1wbGUgU2V0IHRoZSBiYXNlIHJldHJ5IGRlbGF5IGZvciBhbGwgc2VydmljZXMgdG8gMzAwIG1zCiAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmV0cnlEZWxheU9wdGlvbnM6IHtiYXNlOiAzMDB9fSk7CiAqICAgICAvLyBEZWxheXMgd2l0aCBtYXhSZXRyaWVzID0gMzogMzAwLCA2MDAsIDEyMDAKICogICBAZXhhbXBsZSBTZXQgYSBjdXN0b20gYmFja29mZiBmdW5jdGlvbiB0byBwcm92aWRlIGRlbGF5IHZhbHVlcyBvbiByZXRyaWVzCiAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmV0cnlEZWxheU9wdGlvbnM6IHtjdXN0b21CYWNrb2ZmOiBmdW5jdGlvbihyZXRyeUNvdW50LCBlcnIpIHsKICogICAgICAgLy8gcmV0dXJucyBkZWxheSBpbiBtcwogKiAgICAgfX19KTsKICogICBAcmV0dXJuIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLgogKiAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICoKICogICAgICogKipiYXNlKiogW0ludGVnZXJdICZtZGFzaDsgVGhlIGJhc2UgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB1c2UgaW4gdGhlCiAqICAgICAgIGV4cG9uZW50aWFsIGJhY2tvZmYgZm9yIG9wZXJhdGlvbiByZXRyaWVzLiBEZWZhdWx0cyB0byAxMDAgbXMgZm9yIGFsbCBzZXJ2aWNlcyBleGNlcHQKICogICAgICAgRHluYW1vREIsIHdoZXJlIGl0IGRlZmF1bHRzIHRvIDUwbXMuCiAqCiAqICAgICAqICoqY3VzdG9tQmFja29mZiAqKiBbZnVuY3Rpb25dICZtZGFzaDsgQSBjdXN0b20gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEKICogICAgICAgcmV0cnkgY291bnQgYW5kIGVycm9yIGFuZCByZXR1cm5zIHRoZSBhbW91bnQgb2YgdGltZSB0byBkZWxheSBpbgogKiAgICAgICBtaWxsaXNlY29uZHMuIElmIHRoZSByZXN1bHQgaXMgYSBub24temVybyBuZWdhdGl2ZSB2YWx1ZSwgbm8gZnVydGhlcgogKiAgICAgICByZXRyeSBhdHRlbXB0cyB3aWxsIGJlIG1hZGUuIFRoZSBgYmFzZWAgb3B0aW9uIHdpbGwgYmUgaWdub3JlZCBpZiB0aGlzCiAqICAgICAgIG9wdGlvbiBpcyBzdXBwbGllZC4gVGhlIGZ1bmN0aW9uIGlzIG9ubHkgY2FsbGVkIGZvciByZXRyeWFibGUgZXJyb3JzLgogKgogKiBAIWF0dHJpYnV0ZSBodHRwT3B0aW9ucwogKiAgIEByZXR1cm4gW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBwYXNzIHRvIHRoZSBsb3ctbGV2ZWwgSFRUUCByZXF1ZXN0LgogKiAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICoKICogICAgICogKipwcm94eSoqIFtTdHJpbmddICZtZGFzaDsgdGhlIFVSTCB0byBwcm94eSByZXF1ZXN0cyB0aHJvdWdoCiAqICAgICAqICoqYWdlbnQqKiBbaHR0cC5BZ2VudCwgaHR0cHMuQWdlbnRdICZtZGFzaDsgdGhlIEFnZW50IG9iamVjdCB0byBwZXJmb3JtCiAqICAgICAgIEhUVFAgcmVxdWVzdHMgd2l0aC4gVXNlZCBmb3IgY29ubmVjdGlvbiBwb29saW5nLiBOb3RlIHRoYXQgZm9yCiAqICAgICAgIFNTTCBjb25uZWN0aW9ucywgYSBzcGVjaWFsIEFnZW50IG9iamVjdCBpcyB1c2VkIGluIG9yZGVyIHRvIGVuYWJsZQogKiAgICAgICBwZWVyIGNlcnRpZmljYXRlIHZlcmlmaWNhdGlvbi4gVGhpcyBmZWF0dXJlIGlzIG9ubHkgc3VwcG9ydGVkIGluIHRoZQogKiAgICAgICBOb2RlLmpzIGVudmlyb25tZW50LgogKiAgICAgKiAqKmNvbm5lY3RUaW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIKICogICAgICAgZmFpbGluZyB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlciBhZnRlcgogKiAgICAgICBgY29ubmVjdFRpbWVvdXRgIG1pbGxpc2Vjb25kcy4gVGhpcyB0aW1lb3V0IGhhcyBubyBlZmZlY3Qgb25jZSBhIHNvY2tldAogKiAgICAgICBjb25uZWN0aW9uIGhhcyBiZWVuIGVzdGFibGlzaGVkLgogKiAgICAgKiAqKnRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBhIHJlcXVlc3QgY2FuCiAqICAgICAgIHRha2UgYmVmb3JlIGF1dG9tYXRpY2FsbHkgYmVpbmcgdGVybWluYXRlZC4KICogICAgICAgRGVmYXVsdHMgdG8gdHdvIG1pbnV0ZXMgKDEyMDAwMCkuCiAqICAgICAqICoqeGhyQXN5bmMqKiBbQm9vbGVhbl0gJm1kYXNoOyBXaGV0aGVyIHRoZSBTREsgd2lsbCBzZW5kIGFzeW5jaHJvbm91cwogKiAgICAgICBIVFRQIHJlcXVlc3RzLiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9ubHkuIFNldCB0byBmYWxzZSB0bwogKiAgICAgICBzZW5kIHJlcXVlc3RzIHN5bmNocm9ub3VzbHkuIERlZmF1bHRzIHRvIHRydWUgKGFzeW5jIG9uKS4KICogICAgICogKip4aHJXaXRoQ3JlZGVudGlhbHMqKiBbQm9vbGVhbl0gJm1kYXNoOyBTZXRzIHRoZSAid2l0aENyZWRlbnRpYWxzIgogKiAgICAgICBwcm9wZXJ0eSBvZiBhbiBYTUxIdHRwUmVxdWVzdCBvYmplY3QuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQKICogICAgICAgb25seS4gRGVmYXVsdHMgdG8gZmFsc2UuCiAqIEAhYXR0cmlidXRlIGxvZ2dlcgogKiAgIEByZXR1cm4gWyN3cml0ZSwjbG9nXSBhbiBvYmplY3QgdGhhdCByZXNwb25kcyB0byAud3JpdGUoKSAobGlrZSBhIHN0cmVhbSkKICogICAgIG9yIC5sb2coKSAobGlrZSB0aGUgY29uc29sZSBvYmplY3QpIGluIG9yZGVyIHRvIGxvZyBpbmZvcm1hdGlvbiBhYm91dAogKiAgICAgcmVxdWVzdHMKICoKICogQCFhdHRyaWJ1dGUgc3lzdGVtQ2xvY2tPZmZzZXQKICogICBAcmV0dXJuIFtOdW1iZXJdIGFuIG9mZnNldCB2YWx1ZSBpbiBtaWxsaXNlY29uZHMgdG8gYXBwbHkgdG8gYWxsIHNpZ25pbmcKICogICAgIHRpbWVzLiBVc2UgdGhpcyB0byBjb21wZW5zYXRlIGZvciBjbG9jayBza2V3IHdoZW4geW91ciBzeXN0ZW0gbWF5IGJlCiAqICAgICBvdXQgb2Ygc3luYyB3aXRoIHRoZSBzZXJ2aWNlIHRpbWUuIE5vdGUgdGhhdCB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uCiAqICAgICBjYW4gb25seSBiZSBhcHBsaWVkIHRvIHRoZSBnbG9iYWwgYEFXUy5jb25maWdgIG9iamVjdCBhbmQgY2Fubm90IGJlCiAqICAgICBvdmVycmlkZGVuIGluIHNlcnZpY2Utc3BlY2lmaWMgY29uZmlndXJhdGlvbi4gRGVmYXVsdHMgdG8gMCBtaWxsaXNlY29uZHMuCiAqCiAqIEAhYXR0cmlidXRlIHNpZ25hdHVyZVZlcnNpb24KICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBzaWduYXR1cmUgdmVyc2lvbiB0byBzaWduIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcKICogICAgIHRoZSBBUEkgY29uZmlndXJhdGlvbikuIFBvc3NpYmxlIHZhbHVlcyBhcmU6ICd2MicsICd2MycsICd2NCcuCiAqCiAqIEAhYXR0cmlidXRlIHNpZ25hdHVyZUNhY2hlCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgc2lnbmF0dXJlIHRvIHNpZ24gcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZwogKiAgICAgdGhlIEFQSSBjb25maWd1cmF0aW9uKSBpcyBjYWNoZWQuIE9ubHkgYXBwbGllcyB0byB0aGUgc2lnbmF0dXJlIHZlcnNpb24gJ3Y0Jy4KICogICAgIERlZmF1bHRzIHRvIGB0cnVlYC4KICoKICogQCFhdHRyaWJ1dGUgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkCiAqICAgQHJldHVybiBbQm9vbGVhbnx1bmRlZmluZWRdIHdoZXRoZXIgdG8gY2FsbCBvcGVyYXRpb25zIHdpdGggZW5kcG9pbnRzCiAqICAgICBnaXZlbiBieSBzZXJ2aWNlIGR5bmFtaWNhbGx5LiBTZXR0aW5nIHRoaXMgY29uZmlnIHRvIGB0cnVlYCB3aWxsIGVuYWJsZQogKiAgICAgZW5kcG9pbnQgZGlzY292ZXJ5IGZvciBhbGwgYXBwbGljYWJsZSBvcGVyYXRpb25zLiBTZXR0aW5nIGl0IHRvIGBmYWxzZWAKICogICAgIHdpbGwgZXhwbGljaXRseSBkaXNhYmxlIGVuZHBvaW50IGRpc2NvdmVyeSBldmVuIHRob3VnaCBvcGVyYXRpb25zIHRoYXQKICogICAgIHJlcXVpcmUgZW5kcG9pbnQgZGlzY292ZXJ5IHdpbGwgcHJlc3VtYWJseSBmYWlsLiBMZWF2aW5nIGl0IHRvCiAqICAgICBgdW5kZWZpbmVkYCBtZWFucyBTREsgb25seSBkbyBlbmRwb2ludCBkaXNjb3Zlcnkgd2hlbiBpdCdzIHJlcXVpcmVkLgogKiAgICAgRGVmYXVsdHMgdG8gYHVuZGVmaW5lZGAKICoKICogQCFhdHRyaWJ1dGUgZW5kcG9pbnRDYWNoZVNpemUKICogICBAcmV0dXJuIFtOdW1iZXJdIHRoZSBzaXplIG9mIHRoZSBnbG9iYWwgY2FjaGUgc3RvcmluZyBlbmRwb2ludHMgZnJvbSBlbmRwb2ludAogKiAgICAgZGlzY292ZXJ5IG9wZXJhdGlvbnMuIE9uY2UgZW5kcG9pbnQgY2FjaGUgaXMgY3JlYXRlZCwgdXBkYXRpbmcgdGhpcyBzZXR0aW5nCiAqICAgICBjYW5ub3QgY2hhbmdlIGV4aXN0aW5nIGNhY2hlIHNpemUuCiAqICAgICBEZWZhdWx0cyB0byAxMDAwCiAqCiAqIEAhYXR0cmlidXRlIGhvc3RQcmVmaXhFbmFibGVkCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBtYXJzaGFsIHJlcXVlc3QgcGFyYW1ldGVycyB0byB0aGUgcHJlZml4IG9mCiAqICAgICBob3N0bmFtZS4gRGVmYXVsdHMgdG8gYHRydWVgLgogKgogKiBAIWF0dHJpYnV0ZSBzdHNSZWdpb25hbEVuZHBvaW50cwogKiAgIEByZXR1cm4gWydsZWdhY3knfCdyZWdpb25hbCddIHdoZXRoZXIgdG8gc2VuZCBzdHMgcmVxdWVzdCB0byBnbG9iYWwgZW5kcG9pbnRzIG9yCiAqICAgICByZWdpb25hbCBlbmRwb2ludHMuCiAqICAgICBEZWZhdWx0cyB0byAnbGVnYWN5Jy4KICoKICogQCFhdHRyaWJ1dGUgdXNlRmlwc0VuZHBvaW50CiAqICAgQHJldHVybiBbQm9vbGVhbl0gRW5hYmxlcyBGSVBTIGNvbXBhdGlibGUgZW5kcG9pbnRzLiBEZWZhdWx0cyB0byBgZmFsc2VgLgogKgogKiBAIWF0dHJpYnV0ZSB1c2VEdWFsc3RhY2tFbmRwb2ludAogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIEVuYWJsZXMgSVB2NiBkdWFsc3RhY2sgZW5kcG9pbnQuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAqLwpBV1MuQ29uZmlnID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgLyoqCiAgICogQCFlbmRncm91cAogICAqLwoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBUaGlzIGlzIHRoZSBvYmplY3QgdGhhdCBwYXNzZXMKICAgKiBvcHRpb24gZGF0YSBhbG9uZyB0byBzZXJ2aWNlIHJlcXVlc3RzLCBpbmNsdWRpbmcgY3JlZGVudGlhbHMsIHNlY3VyaXR5LAogICAqIHJlZ2lvbiBpbmZvcm1hdGlvbiwgYW5kIHNvbWUgc2VydmljZSBzcGVjaWZpYyBzZXR0aW5ncy4KICAgKgogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggY3JlZGVudGlhbHMgYW5kIHJlZ2lvbgogICAqICAgdmFyIGNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKHsKICAgKiAgICAgYWNjZXNzS2V5SWQ6ICdBS0lEJywgc2VjcmV0QWNjZXNzS2V5OiAnU0VDUkVUJywgcmVnaW9uOiAndXMtd2VzdC0yJwogICAqICAgfSk7CiAgICogQG9wdGlvbiBvcHRpb25zIGFjY2Vzc0tleUlkIFtTdHJpbmddIHlvdXIgQVdTIGFjY2VzcyBrZXkgSUQuCiAgICogQG9wdGlvbiBvcHRpb25zIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB5b3VyIEFXUyBzZWNyZXQgYWNjZXNzIGtleS4KICAgKiBAb3B0aW9uIG9wdGlvbnMgc2Vzc2lvblRva2VuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBvcHRpb25hbCBBV1MKICAgKiAgIHNlc3Npb24gdG9rZW4gdG8gc2lnbiByZXF1ZXN0cyB3aXRoLgogICAqIEBvcHRpb24gb3B0aW9ucyBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgQVdTIGNyZWRlbnRpYWxzCiAgICogICB0byBzaWduIHJlcXVlc3RzIHdpdGguIFlvdSBjYW4gZWl0aGVyIHNwZWNpZnkgdGhpcyBvYmplY3QsIG9yCiAgICogICBzcGVjaWZ5IHRoZSBhY2Nlc3NLZXlJZCBhbmQgc2VjcmV0QWNjZXNzS2V5IG9wdGlvbnMgZGlyZWN0bHkuCiAgICogQG9wdGlvbiBvcHRpb25zIGNyZWRlbnRpYWxQcm92aWRlciBbQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXSB0aGUKICAgKiAgIHByb3ZpZGVyIGNoYWluIHVzZWQgdG8gcmVzb2x2ZSBjcmVkZW50aWFscyBpZiBubyBzdGF0aWMgYGNyZWRlbnRpYWxzYAogICAqICAgcHJvcGVydHkgaXMgc2V0LgogICAqIEBvcHRpb24gb3B0aW9ucyByZWdpb24gW1N0cmluZ10gdGhlIHJlZ2lvbiB0byBzZW5kIHNlcnZpY2UgcmVxdWVzdHMgdG8uCiAgICogICBTZWUge3JlZ2lvbn0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICogQG9wdGlvbiBvcHRpb25zIG1heFJldHJpZXMgW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZXRyaWVzIHRvCiAgICogICBhdHRlbXB0IHdpdGggYSByZXF1ZXN0LiBTZWUge21heFJldHJpZXN9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAqIEBvcHRpb24gb3B0aW9ucyBtYXhSZWRpcmVjdHMgW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZWRpcmVjdHMgdG8KICAgKiAgIGZvbGxvdyB3aXRoIGEgcmVxdWVzdC4gU2VlIHttYXhSZWRpcmVjdHN9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAqIEBvcHRpb24gb3B0aW9ucyBzc2xFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBTU0wgZm9yCiAgICogICByZXF1ZXN0cy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgcGFyYW1WYWxpZGF0aW9uIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzCiAgICogICBzaG91bGQgYmUgdmFsaWRhdGVkIGFnYWluc3QgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZwogICAqICAgdGhlIHJlcXVlc3QuIERlZmF1bHRzIHRvIHRydWUuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUKICAgKiAgIGZvbGxvd2luZyBzcGVjaWZpYyB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAqCiAgICogICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICogICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogICAqICAgICB0byBgdHJ1ZWAuCiAgICogICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICogICAgIGNvbnN0cmFpbnQuCiAgICogICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAqICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICogICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAgICogICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICogQG9wdGlvbiBvcHRpb25zIGNvbXB1dGVDaGVja3N1bXMgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29tcHV0ZSBjaGVja3N1bXMKICAgKiAgIGZvciBwYXlsb2FkIGJvZGllcyB3aGVuIHRoZSBzZXJ2aWNlIGFjY2VwdHMgaXQgKGN1cnJlbnRseSBzdXBwb3J0ZWQKICAgKiAgIGluIFMzIG9ubHkpCiAgICogQG9wdGlvbiBvcHRpb25zIGNvbnZlcnRSZXNwb25zZVR5cGVzIFtCb29sZWFuXSB3aGV0aGVyIHR5cGVzIGFyZSBjb252ZXJ0ZWQKICAgKiAgICAgd2hlbiBwYXJzaW5nIHJlc3BvbnNlIGRhdGEuIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBmb3IgSlNPTiBiYXNlZAogICAqICAgICBzZXJ2aWNlcy4gVHVybmluZyB0aGlzIG9mZiBtYXkgaW1wcm92ZSBwZXJmb3JtYW5jZSBvbiBsYXJnZSByZXNwb25zZQogICAqICAgICBwYXlsb2Fkcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqIEBvcHRpb24gb3B0aW9ucyBjb3JyZWN0Q2xvY2tTa2V3IFtCb29sZWFuXSB3aGV0aGVyIHRvIGFwcGx5IGEgY2xvY2sgc2tldwogICAqICAgICBjb3JyZWN0aW9uIGFuZCByZXRyeSByZXF1ZXN0cyB0aGF0IGZhaWwgYmVjYXVzZSBvZiBhbiBza2V3ZWQgY2xpZW50CiAgICogICAgIGNsb2NrLiBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAqIEBvcHRpb24gb3B0aW9ucyBzM0ZvcmNlUGF0aFN0eWxlIFtCb29sZWFuXSB3aGV0aGVyIHRvIGZvcmNlIHBhdGgKICAgKiAgIHN0eWxlIFVSTHMgZm9yIFMzIG9iamVjdHMuCiAgICogQG9wdGlvbiBvcHRpb25zIHMzQnVja2V0RW5kcG9pbnQgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGVuZHBvaW50CiAgICogICBhZGRyZXNzZXMgYW4gaW5kaXZpZHVhbCBidWNrZXQgKGZhbHNlIGlmIGl0IGFkZHJlc3NlcyB0aGUgcm9vdCBBUEkKICAgKiAgIGVuZHBvaW50KS4gTm90ZSB0aGF0IHNldHRpbmcgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiByZXF1aXJlcyBhbgogICAqICAgYGVuZHBvaW50YCB0byBiZSBwcm92aWRlZCBleHBsaWNpdGx5IHRvIHRoZSBzZXJ2aWNlIGNvbnN0cnVjdG9yLgogICAqIEBvcHRpb24gb3B0aW9ucyBzM0Rpc2FibGVCb2R5U2lnbmluZyBbQm9vbGVhbl0gd2hldGhlciBTMyBib2R5IHNpZ25pbmcKICAgKiAgIHNob3VsZCBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIHNpZ25hdHVyZSB2ZXJzaW9uIGB2NGAuIEJvZHkgc2lnbmluZwogICAqICAgY2FuIG9ubHkgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBodHRwcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqIEBvcHRpb24gb3B0aW9ucyBzM1VzRWFzdDFSZWdpb25hbEVuZHBvaW50IFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGVuIHJlZ2lvbgogICAqICAgaXMgc2V0IHRvICd1cy1lYXN0LTEnLCB3aGV0aGVyIHRvIHNlbmQgczMgcmVxdWVzdCB0byBnbG9iYWwgZW5kcG9pbnRzIG9yCiAgICogICAndXMtZWFzdC0xJyByZWdpb25hbCBlbmRwb2ludHMuIFRoaXMgY29uZmlnIGlzIG9ubHkgYXBwbGljYWJsZSB0byBTMyBjbGllbnQuCiAgICogICBEZWZhdWx0cyB0byBgbGVnYWN5YAogICAqIEBvcHRpb24gb3B0aW9ucyBzM1VzZUFyblJlZ2lvbiBbQm9vbGVhbl0gd2hldGhlciB0byBvdmVycmlkZSB0aGUgcmVxdWVzdCByZWdpb24KICAgKiAgIHdpdGggdGhlIHJlZ2lvbiBpbmZlcnJlZCBmcm9tIHJlcXVlc3RlZCByZXNvdXJjZSdzIEFSTi4gT25seSBhdmFpbGFibGUgZm9yIFMzIGJ1Y2tldHMKICAgKiAgIERlZmF1bHRzIHRvIGB0cnVlYAogICAqCiAgICogQG9wdGlvbiBvcHRpb25zIHJldHJ5RGVsYXlPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gY29uZmlndXJlCiAgICogICB0aGUgcmV0cnkgZGVsYXkgb24gcmV0cnlhYmxlIGVycm9ycy4gQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgKgogICAqICAgKiAqKmJhc2UqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgYmFzZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHVzZSBpbiB0aGUKICAgKiAgICAgZXhwb25lbnRpYWwgYmFja29mZiBmb3Igb3BlcmF0aW9uIHJldHJpZXMuIERlZmF1bHRzIHRvIDEwMCBtcyBmb3IgYWxsCiAgICogICAgIHNlcnZpY2VzIGV4Y2VwdCBEeW5hbW9EQiwgd2hlcmUgaXQgZGVmYXVsdHMgdG8gNTBtcy4KICAgKiAgICogKipjdXN0b21CYWNrb2ZmICoqIFtmdW5jdGlvbl0gJm1kYXNoOyBBIGN1c3RvbSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYQogICAqICAgICByZXRyeSBjb3VudCBhbmQgZXJyb3IgYW5kIHJldHVybnMgdGhlIGFtb3VudCBvZiB0aW1lIHRvIGRlbGF5IGluCiAgICogICAgIG1pbGxpc2Vjb25kcy4gSWYgdGhlIHJlc3VsdCBpcyBhIG5vbi16ZXJvIG5lZ2F0aXZlIHZhbHVlLCBubyBmdXJ0aGVyCiAgICogICAgIHJldHJ5IGF0dGVtcHRzIHdpbGwgYmUgbWFkZS4gVGhlIGBiYXNlYCBvcHRpb24gd2lsbCBiZSBpZ25vcmVkIGlmIHRoaXMKICAgKiAgICAgb3B0aW9uIGlzIHN1cHBsaWVkLiBUaGUgZnVuY3Rpb24gaXMgb25seSBjYWxsZWQgZm9yIHJldHJ5YWJsZSBlcnJvcnMuCiAgICogQG9wdGlvbiBvcHRpb25zIGh0dHBPcHRpb25zIFttYXBdIEEgc2V0IG9mIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgbG93LWxldmVsCiAgICogICBIVFRQIHJlcXVlc3QuIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICoKICAgKiAgICogKipwcm94eSoqIFtTdHJpbmddICZtZGFzaDsgdGhlIFVSTCB0byBwcm94eSByZXF1ZXN0cyB0aHJvdWdoCiAgICogICAqICoqYWdlbnQqKiBbaHR0cC5BZ2VudCwgaHR0cHMuQWdlbnRdICZtZGFzaDsgdGhlIEFnZW50IG9iamVjdCB0byBwZXJmb3JtCiAgICogICAgIEhUVFAgcmVxdWVzdHMgd2l0aC4gVXNlZCBmb3IgY29ubmVjdGlvbiBwb29saW5nLiBEZWZhdWx0cyB0byB0aGUgZ2xvYmFsCiAgICogICAgIGFnZW50IChgaHR0cC5nbG9iYWxBZ2VudGApIGZvciBub24tU1NMIGNvbm5lY3Rpb25zLiBOb3RlIHRoYXQgZm9yCiAgICogICAgIFNTTCBjb25uZWN0aW9ucywgYSBzcGVjaWFsIEFnZW50IG9iamVjdCBpcyB1c2VkIGluIG9yZGVyIHRvIGVuYWJsZQogICAqICAgICBwZWVyIGNlcnRpZmljYXRlIHZlcmlmaWNhdGlvbi4gVGhpcyBmZWF0dXJlIGlzIG9ubHkgYXZhaWxhYmxlIGluIHRoZQogICAqICAgICBOb2RlLmpzIGVudmlyb25tZW50LgogICAqICAgKiAqKmNvbm5lY3RUaW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIKICAgKiAgICAgZmFpbGluZyB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlciBhZnRlcgogICAqICAgICBgY29ubmVjdFRpbWVvdXRgIG1pbGxpc2Vjb25kcy4gVGhpcyB0aW1lb3V0IGhhcyBubyBlZmZlY3Qgb25jZSBhIHNvY2tldAogICAqICAgICBjb25uZWN0aW9uIGhhcyBiZWVuIGVzdGFibGlzaGVkLgogICAqICAgKiAqKnRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlciB0aW1lb3V0CiAgICogICAgIG1pbGxpc2Vjb25kcyBvZiBpbmFjdGl2aXR5IG9uIHRoZSBzb2NrZXQuIERlZmF1bHRzIHRvIHR3byBtaW51dGVzCiAgICogICAgICgxMjAwMDApLgogICAqICAgKiAqKnhockFzeW5jKiogW0Jvb2xlYW5dICZtZGFzaDsgV2hldGhlciB0aGUgU0RLIHdpbGwgc2VuZCBhc3luY2hyb25vdXMKICAgKiAgICAgSFRUUCByZXF1ZXN0cy4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvbmx5LiBTZXQgdG8gZmFsc2UgdG8KICAgKiAgICAgc2VuZCByZXF1ZXN0cyBzeW5jaHJvbm91c2x5LiBEZWZhdWx0cyB0byB0cnVlIChhc3luYyBvbikuCiAgICogICAqICoqeGhyV2l0aENyZWRlbnRpYWxzKiogW0Jvb2xlYW5dICZtZGFzaDsgU2V0cyB0aGUgIndpdGhDcmVkZW50aWFscyIKICAgKiAgICAgcHJvcGVydHkgb2YgYW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0LiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50CiAgICogICAgIG9ubHkuIERlZmF1bHRzIHRvIGZhbHNlLgogICAqIEBvcHRpb24gb3B0aW9ucyBhcGlWZXJzaW9uIFtTdHJpbmcsIERhdGVdIGEgU3RyaW5nIGluIFlZWVktTU0tREQgZm9ybWF0CiAgICogICAob3IgYSBkYXRlKSB0aGF0IHJlcHJlc2VudHMgdGhlIGxhdGVzdCBwb3NzaWJsZSBBUEkgdmVyc2lvbiB0aGF0IGNhbiBiZQogICAqICAgdXNlZCBpbiBhbGwgc2VydmljZXMgKHVubGVzcyBvdmVycmlkZGVuIGJ5IGBhcGlWZXJzaW9uc2ApLiBTcGVjaWZ5CiAgICogICAnbGF0ZXN0JyB0byB1c2UgdGhlIGxhdGVzdCBwb3NzaWJsZSB2ZXJzaW9uLgogICAqIEBvcHRpb24gb3B0aW9ucyBhcGlWZXJzaW9ucyBbbWFwPFN0cmluZywgU3RyaW5nfERhdGU+XSBhIG1hcCBvZiBzZXJ2aWNlCiAgICogICBpZGVudGlmaWVycyAodGhlIGxvd2VyY2FzZSBzZXJ2aWNlIGNsYXNzIG5hbWUpIHdpdGggdGhlIEFQSSB2ZXJzaW9uIHRvCiAgICogICB1c2Ugd2hlbiBpbnN0YW50aWF0aW5nIGEgc2VydmljZS4gU3BlY2lmeSAnbGF0ZXN0JyBmb3IgZWFjaCBpbmRpdmlkdWFsCiAgICogICB0aGF0IGNhbiB1c2UgdGhlIGxhdGVzdCBhdmFpbGFibGUgdmVyc2lvbi4KICAgKiBAb3B0aW9uIG9wdGlvbnMgbG9nZ2VyIFsjd3JpdGUsI2xvZ10gYW4gb2JqZWN0IHRoYXQgcmVzcG9uZHMgdG8gLndyaXRlKCkKICAgKiAgIChsaWtlIGEgc3RyZWFtKSBvciAubG9nKCkgKGxpa2UgdGhlIGNvbnNvbGUgb2JqZWN0KSBpbiBvcmRlciB0byBsb2cKICAgKiAgIGluZm9ybWF0aW9uIGFib3V0IHJlcXVlc3RzCiAgICogQG9wdGlvbiBvcHRpb25zIHN5c3RlbUNsb2NrT2Zmc2V0IFtOdW1iZXJdIGFuIG9mZnNldCB2YWx1ZSBpbiBtaWxsaXNlY29uZHMKICAgKiAgIHRvIGFwcGx5IHRvIGFsbCBzaWduaW5nIHRpbWVzLiBVc2UgdGhpcyB0byBjb21wZW5zYXRlIGZvciBjbG9jayBza2V3CiAgICogICB3aGVuIHlvdXIgc3lzdGVtIG1heSBiZSBvdXQgb2Ygc3luYyB3aXRoIHRoZSBzZXJ2aWNlIHRpbWUuIE5vdGUgdGhhdAogICAqICAgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiBjYW4gb25seSBiZSBhcHBsaWVkIHRvIHRoZSBnbG9iYWwgYEFXUy5jb25maWdgCiAgICogICBvYmplY3QgYW5kIGNhbm5vdCBiZSBvdmVycmlkZGVuIGluIHNlcnZpY2Utc3BlY2lmaWMgY29uZmlndXJhdGlvbi4KICAgKiAgIERlZmF1bHRzIHRvIDAgbWlsbGlzZWNvbmRzLgogICAqIEBvcHRpb24gb3B0aW9ucyBzaWduYXR1cmVWZXJzaW9uIFtTdHJpbmddIHRoZSBzaWduYXR1cmUgdmVyc2lvbiB0byBzaWduCiAgICogICByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nIHRoZSBBUEkgY29uZmlndXJhdGlvbikuIFBvc3NpYmxlIHZhbHVlcyBhcmU6CiAgICogICAndjInLCAndjMnLCAndjQnLgogICAqIEBvcHRpb24gb3B0aW9ucyBzaWduYXR1cmVDYWNoZSBbQm9vbGVhbl0gd2hldGhlciB0aGUgc2lnbmF0dXJlIHRvIHNpZ24KICAgKiAgIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcgdGhlIEFQSSBjb25maWd1cmF0aW9uKSBpcyBjYWNoZWQuIE9ubHkgYXBwbGllcwogICAqICAgdG8gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uICd2NCcuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgZHluYW1vRGJDcmMzMiBbQm9vbGVhbl0gd2hldGhlciB0byB2YWxpZGF0ZSB0aGUgQ1JDMzIKICAgKiAgIGNoZWNrc3VtIG9mIEhUVFAgcmVzcG9uc2UgYm9kaWVzIHJldHVybmVkIGJ5IER5bmFtb0RCLiBEZWZhdWx0OiBgdHJ1ZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIHVzZUFjY2VsZXJhdGVFbmRwb2ludCBbQm9vbGVhbl0gV2hldGhlciB0byB1c2UgdGhlCiAgICogICBTMyBUcmFuc2ZlciBBY2NlbGVyYXRpb24gZW5kcG9pbnQgd2l0aCB0aGUgUzMgc2VydmljZS4gRGVmYXVsdDogYGZhbHNlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgY2xpZW50U2lkZU1vbml0b3JpbmcgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29sbGVjdCBhbmQKICAgKiAgIHB1Ymxpc2ggdGhpcyBjbGllbnQncyBwZXJmb3JtYW5jZSBtZXRyaWNzIG9mIGFsbCBpdHMgQVBJIHJlcXVlc3RzLgogICAqIEBvcHRpb24gb3B0aW9ucyBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgW0Jvb2xlYW58dW5kZWZpbmVkXSB3aGV0aGVyIHRvCiAgICogICBjYWxsIG9wZXJhdGlvbnMgd2l0aCBlbmRwb2ludHMgZ2l2ZW4gYnkgc2VydmljZSBkeW5hbWljYWxseS4gU2V0dGluZyB0aGlzCiAgICogY29uZmlnIHRvIGB0cnVlYCB3aWxsIGVuYWJsZSBlbmRwb2ludCBkaXNjb3ZlcnkgZm9yIGFsbCBhcHBsaWNhYmxlIG9wZXJhdGlvbnMuCiAgICogICBTZXR0aW5nIGl0IHRvIGBmYWxzZWAgd2lsbCBleHBsaWNpdGx5IGRpc2FibGUgZW5kcG9pbnQgZGlzY292ZXJ5IGV2ZW4gdGhvdWdoCiAgICogICBvcGVyYXRpb25zIHRoYXQgcmVxdWlyZSBlbmRwb2ludCBkaXNjb3Zlcnkgd2lsbCBwcmVzdW1hYmx5IGZhaWwuIExlYXZpbmcgaXQKICAgKiAgIHRvIGB1bmRlZmluZWRgIG1lYW5zIFNESyB3aWxsIG9ubHkgZG8gZW5kcG9pbnQgZGlzY292ZXJ5IHdoZW4gaXQncyByZXF1aXJlZC4KICAgKiAgIERlZmF1bHRzIHRvIGB1bmRlZmluZWRgCiAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50Q2FjaGVTaXplIFtOdW1iZXJdIHRoZSBzaXplIG9mIHRoZSBnbG9iYWwgY2FjaGUgc3RvcmluZwogICAqICAgZW5kcG9pbnRzIGZyb20gZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbnMuIE9uY2UgZW5kcG9pbnQgY2FjaGUgaXMgY3JlYXRlZCwKICAgKiAgIHVwZGF0aW5nIHRoaXMgc2V0dGluZyBjYW5ub3QgY2hhbmdlIGV4aXN0aW5nIGNhY2hlIHNpemUuCiAgICogICBEZWZhdWx0cyB0byAxMDAwCiAgICogQG9wdGlvbiBvcHRpb25zIGhvc3RQcmVmaXhFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIG1hcnNoYWwgcmVxdWVzdAogICAqICAgcGFyYW1ldGVycyB0byB0aGUgcHJlZml4IG9mIGhvc3RuYW1lLgogICAqICAgRGVmYXVsdHMgdG8gYHRydWVgLgogICAqIEBvcHRpb24gb3B0aW9ucyBzdHNSZWdpb25hbEVuZHBvaW50cyBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hldGhlciB0byBzZW5kIHN0cyByZXF1ZXN0CiAgICogICB0byBnbG9iYWwgZW5kcG9pbnRzIG9yIHJlZ2lvbmFsIGVuZHBvaW50cy4KICAgKiAgIERlZmF1bHRzIHRvICdsZWdhY3knLgogICAqIEBvcHRpb24gb3B0aW9ucyB1c2VGaXBzRW5kcG9pbnQgW0Jvb2xlYW5dIEVuYWJsZXMgRklQUyBjb21wYXRpYmxlIGVuZHBvaW50cy4KICAgKiAgIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIHVzZUR1YWxzdGFja0VuZHBvaW50IFtCb29sZWFuXSBFbmFibGVzIElQdjYgZHVhbHN0YWNrIGVuZHBvaW50LgogICAqICAgRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ29uZmlnKG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zID09PSB1bmRlZmluZWQpIG9wdGlvbnMgPSB7fTsKICAgIG9wdGlvbnMgPSB0aGlzLmV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKTsKCiAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5rZXlzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB0aGlzLnNldChrZXksIG9wdGlvbnNba2V5XSwgdmFsdWUpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQCFncm91cCBNYW5hZ2luZyBDcmVkZW50aWFscwogICAqLwoKICAvKioKICAgKiBMb2FkcyBjcmVkZW50aWFscyBmcm9tIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4gVGhpcyBpcyB1c2VkIGludGVybmFsbHkKICAgKiBieSB0aGUgU0RLIHRvIGVuc3VyZSB0aGF0IHJlZnJlc2hhYmxlIHtDcmVkZW50aWFsc30gb2JqZWN0cyBhcmUgcHJvcGVybHkKICAgKiByZWZyZXNoZWQgYW5kIGxvYWRlZCB3aGVuIHNlbmRpbmcgYSByZXF1ZXN0LiBJZiB5b3Ugd2FudCB0byBlbnN1cmUgdGhhdAogICAqIHlvdXIgY3JlZGVudGlhbHMgYXJlIGxvYWRlZCBwcmlvciB0byBhIHJlcXVlc3QsIHlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kCiAgICogZGlyZWN0bHkgdG8gcHJvdmlkZSBhY2N1cmF0ZSBjcmVkZW50aWFsIGRhdGEgc3RvcmVkIGluIHRoZSBvYmplY3QuCiAgICoKICAgKiBAbm90ZSBJZiB5b3UgY29uZmlndXJlIHRoZSBTREsgd2l0aCBzdGF0aWMgb3IgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMsCiAgICogICB0aGUgY3JlZGVudGlhbCBkYXRhIHNob3VsZCBhbHJlYWR5IGJlIHByZXNlbnQgaW4ge2NyZWRlbnRpYWxzfSBhdHRyaWJ1dGUuCiAgICogICBUaGlzIG1ldGhvZCBpcyBwcmltYXJpbHkgbmVjZXNzYXJ5IHRvIGxvYWQgY3JlZGVudGlhbHMgZnJvbSBhc3luY2hyb25vdXMKICAgKiAgIHNvdXJjZXMsIG9yIHNvdXJjZXMgdGhhdCBjYW4gcmVmcmVzaCBjcmVkZW50aWFscyBwZXJpb2RpY2FsbHkuCiAgICogQGV4YW1wbGUgR2V0dGluZyB5b3VyIGFjY2VzcyBrZXkKICAgKiAgIEFXUy5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICogICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKGVyci5zdGFjayk7IC8vIGNyZWRlbnRpYWxzIG5vdCBsb2FkZWQKICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZygiQWNjZXNzIEtleToiLCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkKTsKICAgKiAgIH0pCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIENhbGxlZCB3aGVuIHRoZSB7Y3JlZGVudGlhbHN9IGhhdmUgYmVlbiBwcm9wZXJseSBzZXQgb24gdGhlIGNvbmZpZ3VyYXRpb24KICAgKiAgIG9iamVjdC4KICAgKgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIHRoaXMgaXMgc2V0LCBjcmVkZW50aWFscyB3ZXJlIG5vdCBzdWNjZXNzZnVsbHkKICAgKiAgICAgbG9hZGVkIGFuZCB0aGlzIGVycm9yIHByb3ZpZGVzIGluZm9ybWF0aW9uIHdoeS4KICAgKiBAc2VlIGNyZWRlbnRpYWxzCiAgICogQHNlZSBDcmVkZW50aWFscwogICAqLwogIGdldENyZWRlbnRpYWxzOiBmdW5jdGlvbiBnZXRDcmVkZW50aWFscyhjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGZ1bmN0aW9uIGZpbmlzaChlcnIpIHsKICAgICAgY2FsbGJhY2soZXJyLCBlcnIgPyBudWxsIDogc2VsZi5jcmVkZW50aWFscyk7CiAgICB9CgogICAgZnVuY3Rpb24gY3JlZEVycm9yKG1zZywgZXJyKSB7CiAgICAgIHJldHVybiBuZXcgQVdTLnV0aWwuZXJyb3IoZXJyIHx8IG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLAogICAgICAgIG1lc3NhZ2U6IG1zZywKICAgICAgICBuYW1lOiAnQ3JlZGVudGlhbHNFcnJvcicKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0QXN5bmNDcmVkZW50aWFscygpIHsKICAgICAgc2VsZi5jcmVkZW50aWFscy5nZXQoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgdmFyIG1zZyA9ICdDb3VsZCBub3QgbG9hZCBjcmVkZW50aWFscyBmcm9tICcgKwogICAgICAgICAgICBzZWxmLmNyZWRlbnRpYWxzLmNvbnN0cnVjdG9yLm5hbWU7CiAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IobXNnLCBlcnIpOwogICAgICAgIH0KICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0U3RhdGljQ3JlZGVudGlhbHMoKSB7CiAgICAgIHZhciBlcnIgPSBudWxsOwogICAgICBpZiAoIXNlbGYuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgfHwgIXNlbGYuY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5KSB7CiAgICAgICAgZXJyID0gY3JlZEVycm9yKCdNaXNzaW5nIGNyZWRlbnRpYWxzJyk7CiAgICAgIH0KICAgICAgZmluaXNoKGVycik7CiAgICB9CgogICAgaWYgKHNlbGYuY3JlZGVudGlhbHMpIHsKICAgICAgaWYgKHR5cGVvZiBzZWxmLmNyZWRlbnRpYWxzLmdldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGdldEFzeW5jQ3JlZGVudGlhbHMoKTsKICAgICAgfSBlbHNlIHsgLy8gc3RhdGljIGNyZWRlbnRpYWxzCiAgICAgICAgZ2V0U3RhdGljQ3JlZGVudGlhbHMoKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChzZWxmLmNyZWRlbnRpYWxQcm92aWRlcikgewogICAgICBzZWxmLmNyZWRlbnRpYWxQcm92aWRlci5yZXNvbHZlKGZ1bmN0aW9uKGVyciwgY3JlZHMpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ0NvdWxkIG5vdCBsb2FkIGNyZWRlbnRpYWxzIGZyb20gYW55IHByb3ZpZGVycycsIGVycik7CiAgICAgICAgfQogICAgICAgIHNlbGYuY3JlZGVudGlhbHMgPSBjcmVkczsKICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBmaW5pc2goY3JlZEVycm9yKCdObyBjcmVkZW50aWFscyB0byBsb2FkJykpOwogICAgfQogIH0sCgogIC8qKgogICAqIEAhZ3JvdXAgTG9hZGluZyBhbmQgU2V0dGluZyBDb25maWd1cmF0aW9uIE9wdGlvbnMKICAgKi8KCiAgLyoqCiAgICogQG92ZXJsb2FkIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzID0gZmFsc2UpCiAgICogICBVcGRhdGVzIHRoZSBjdXJyZW50IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggbmV3IG9wdGlvbnMuCiAgICoKICAgKiAgIEBleGFtcGxlIFVwZGF0ZSBtYXhSZXRyaWVzIHByb3BlcnR5IG9mIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgKiAgICAgY29uZmlnLnVwZGF0ZSh7bWF4UmV0cmllczogMTB9KTsKICAgKiAgIEBwYXJhbSBbT2JqZWN0XSBvcHRpb25zIGEgbWFwIG9mIG9wdGlvbiBrZXlzIGFuZCB2YWx1ZXMuCiAgICogICBAcGFyYW0gW0Jvb2xlYW5dIGFsbG93VW5rbm93bktleXMgd2hldGhlciB1bmtub3duIGtleXMgY2FuIGJlIHNldCBvbgogICAqICAgICB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICogICBAc2VlIGNvbnN0cnVjdG9yCiAgICovCiAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUob3B0aW9ucywgYWxsb3dVbmtub3duS2V5cykgewogICAgYWxsb3dVbmtub3duS2V5cyA9IGFsbG93VW5rbm93bktleXMgfHwgZmFsc2U7CiAgICBvcHRpb25zID0gdGhpcy5leHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucyk7CiAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGFsbG93VW5rbm93bktleXMgfHwgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMua2V5cywga2V5KSB8fAogICAgICAgICAgQVdTLlNlcnZpY2UuaGFzU2VydmljZShrZXkpKSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIC8qKgogICAqIExvYWRzIGNvbmZpZ3VyYXRpb24gZGF0YSBmcm9tIGEgSlNPTiBmaWxlIGludG8gdGhpcyBjb25maWcgb2JqZWN0LgogICAqIEBub3RlIExvYWRpbmcgY29uZmlndXJhdGlvbiB3aWxsIHJlc2V0IGFsbCBleGlzdGluZyBjb25maWd1cmF0aW9uCiAgICogICBvbiB0aGUgb2JqZWN0LgogICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICogQHBhcmFtIHBhdGggW1N0cmluZ10gdGhlIHBhdGggcmVsYXRpdmUgdG8geW91ciBwcm9jZXNzJ3MgY3VycmVudAogICAqICAgIHdvcmtpbmcgZGlyZWN0b3J5IHRvIGxvYWQgY29uZmlndXJhdGlvbiBmcm9tLgogICAqIEByZXR1cm4gW0FXUy5Db25maWddIHRoZSBzYW1lIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICovCiAgbG9hZEZyb21QYXRoOiBmdW5jdGlvbiBsb2FkRnJvbVBhdGgocGF0aCkgewogICAgdGhpcy5jbGVhcigpOwoKICAgIHZhciBvcHRpb25zID0gSlNPTi5wYXJzZShBV1MudXRpbC5yZWFkRmlsZVN5bmMocGF0aCkpOwogICAgdmFyIGZpbGVTeXN0ZW1DcmVkcyA9IG5ldyBBV1MuRmlsZVN5c3RlbUNyZWRlbnRpYWxzKHBhdGgpOwogICAgdmFyIGNoYWluID0gbmV3IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbigpOwogICAgY2hhaW4ucHJvdmlkZXJzLnVuc2hpZnQoZmlsZVN5c3RlbUNyZWRzKTsKICAgIGNoYWluLnJlc29sdmUoZnVuY3Rpb24gKGVyciwgY3JlZHMpIHsKICAgICAgaWYgKGVycikgdGhyb3cgZXJyOwogICAgICBlbHNlIG9wdGlvbnMuY3JlZGVudGlhbHMgPSBjcmVkczsKICAgIH0pOwoKICAgIHRoaXMuY29uc3RydWN0b3Iob3B0aW9ucyk7CgogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQ2xlYXJzIGNvbmZpZ3VyYXRpb24gZGF0YSBvbiB0aGlzIG9iamVjdAogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgLypqc2hpbnQgZm9yaW46ZmFsc2UgKi8KICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgIH0pOwoKICAgIC8vIHJlc2V0IGNyZWRlbnRpYWwgcHJvdmlkZXIKICAgIHRoaXMuc2V0KCdjcmVkZW50aWFscycsIHVuZGVmaW5lZCk7CiAgICB0aGlzLnNldCgnY3JlZGVudGlhbFByb3ZpZGVyJywgdW5kZWZpbmVkKTsKICB9LAoKICAvKioKICAgKiBTZXRzIGEgcHJvcGVydHkgb24gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LCBhbGxvd2luZyBmb3IgYQogICAqIGRlZmF1bHQgdmFsdWUKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzZXQ6IGZ1bmN0aW9uIHNldChwcm9wZXJ0eSwgdmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgaWYgKGRlZmF1bHRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZGVmYXVsdFZhbHVlID0gdGhpcy5rZXlzW3Byb3BlcnR5XTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIGRlZmF1bHRWYWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXNbcHJvcGVydHldID0gZGVmYXVsdFZhbHVlLmNhbGwodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAocHJvcGVydHkgPT09ICdodHRwT3B0aW9ucycgJiYgdGhpc1twcm9wZXJ0eV0pIHsKICAgICAgLy8gZGVlcCBtZXJnZSBodHRwT3B0aW9ucwogICAgICB0aGlzW3Byb3BlcnR5XSA9IEFXUy51dGlsLm1lcmdlKHRoaXNbcHJvcGVydHldLCB2YWx1ZSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgfQogIH0sCgogIC8qKgogICAqIEFsbCBvZiB0aGUga2V5cyB3aXRoIHRoZWlyIGRlZmF1bHQgdmFsdWVzLgogICAqCiAgICogQGNvbnN0YW50CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAga2V5czogewogICAgY3JlZGVudGlhbHM6IG51bGwsCiAgICBjcmVkZW50aWFsUHJvdmlkZXI6IG51bGwsCiAgICByZWdpb246IG51bGwsCiAgICBsb2dnZXI6IG51bGwsCiAgICBhcGlWZXJzaW9uczoge30sCiAgICBhcGlWZXJzaW9uOiBudWxsLAogICAgZW5kcG9pbnQ6IHVuZGVmaW5lZCwKICAgIGh0dHBPcHRpb25zOiB7CiAgICAgIHRpbWVvdXQ6IDEyMDAwMAogICAgfSwKICAgIG1heFJldHJpZXM6IHVuZGVmaW5lZCwKICAgIG1heFJlZGlyZWN0czogMTAsCiAgICBwYXJhbVZhbGlkYXRpb246IHRydWUsCiAgICBzc2xFbmFibGVkOiB0cnVlLAogICAgczNGb3JjZVBhdGhTdHlsZTogZmFsc2UsCiAgICBzM0J1Y2tldEVuZHBvaW50OiBmYWxzZSwKICAgIHMzRGlzYWJsZUJvZHlTaWduaW5nOiB0cnVlLAogICAgczNVc0Vhc3QxUmVnaW9uYWxFbmRwb2ludDogJ2xlZ2FjeScsCiAgICBzM1VzZUFyblJlZ2lvbjogdW5kZWZpbmVkLAogICAgY29tcHV0ZUNoZWNrc3VtczogdHJ1ZSwKICAgIGNvbnZlcnRSZXNwb25zZVR5cGVzOiB0cnVlLAogICAgY29ycmVjdENsb2NrU2tldzogZmFsc2UsCiAgICBjdXN0b21Vc2VyQWdlbnQ6IG51bGwsCiAgICBkeW5hbW9EYkNyYzMyOiB0cnVlLAogICAgc3lzdGVtQ2xvY2tPZmZzZXQ6IDAsCiAgICBzaWduYXR1cmVWZXJzaW9uOiBudWxsLAogICAgc2lnbmF0dXJlQ2FjaGU6IHRydWUsCiAgICByZXRyeURlbGF5T3B0aW9uczoge30sCiAgICB1c2VBY2NlbGVyYXRlRW5kcG9pbnQ6IGZhbHNlLAogICAgY2xpZW50U2lkZU1vbml0b3Jpbmc6IGZhbHNlLAogICAgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkOiB1bmRlZmluZWQsCiAgICBlbmRwb2ludENhY2hlU2l6ZTogMTAwMCwKICAgIGhvc3RQcmVmaXhFbmFibGVkOiB0cnVlLAogICAgc3RzUmVnaW9uYWxFbmRwb2ludHM6ICdsZWdhY3knLAogICAgdXNlRmlwc0VuZHBvaW50OiBmYWxzZSwKICAgIHVzZUR1YWxzdGFja0VuZHBvaW50OiBmYWxzZQogIH0sCgogIC8qKgogICAqIEV4dHJhY3RzIGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXkgYW5kIHNlc3Npb25Ub2tlbgogICAqIGZyb20gYSBjb25maWd1cmF0aW9uIGhhc2guCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBleHRyYWN0Q3JlZGVudGlhbHM6IGZ1bmN0aW9uIGV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucy5hY2Nlc3NLZXlJZCAmJiBvcHRpb25zLnNlY3JldEFjY2Vzc0tleSkgewogICAgICBvcHRpb25zID0gQVdTLnV0aWwuY29weShvcHRpb25zKTsKICAgICAgb3B0aW9ucy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMob3B0aW9ucyk7CiAgICB9CiAgICByZXR1cm4gb3B0aW9uczsKICB9LAoKICAvKioKICAgKiBTZXRzIHRoZSBwcm9taXNlIGRlcGVuZGVuY3kgdGhlIFNESyB3aWxsIHVzZSB3aGVyZXZlciBQcm9taXNlcyBhcmUgcmV0dXJuZWQuCiAgICogUGFzc2luZyBgbnVsbGAgd2lsbCBmb3JjZSB0aGUgU0RLIHRvIHVzZSBuYXRpdmUgUHJvbWlzZXMgaWYgdGhleSBhcmUgYXZhaWxhYmxlLgogICAqIElmIG5hdGl2ZSBQcm9taXNlcyBhcmUgbm90IGF2YWlsYWJsZSwgcGFzc2luZyBgbnVsbGAgd2lsbCBoYXZlIG5vIGVmZmVjdC4KICAgKiBAcGFyYW0gW0NvbnN0cnVjdG9yXSBkZXAgQSByZWZlcmVuY2UgdG8gYSBQcm9taXNlIGNvbnN0cnVjdG9yCiAgICovCiAgc2V0UHJvbWlzZXNEZXBlbmRlbmN5OiBmdW5jdGlvbiBzZXRQcm9taXNlc0RlcGVuZGVuY3koZGVwKSB7CiAgICBQcm9taXNlc0RlcGVuZGVuY3kgPSBkZXA7CiAgICAvLyBpZiBudWxsIHdhcyBwYXNzZWQgaW4sIHdlIHNob3VsZCB0cnkgdG8gdXNlIG5hdGl2ZSBwcm9taXNlcwogICAgaWYgKGRlcCA9PT0gbnVsbCAmJiB0eXBlb2YgUHJvbWlzZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBQcm9taXNlc0RlcGVuZGVuY3kgPSBQcm9taXNlOwogICAgfQogICAgdmFyIGNvbnN0cnVjdG9ycyA9IFtBV1MuUmVxdWVzdCwgQVdTLkNyZWRlbnRpYWxzLCBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dOwogICAgaWYgKEFXUy5TMykgewogICAgICBjb25zdHJ1Y3RvcnMucHVzaChBV1MuUzMpOwogICAgICBpZiAoQVdTLlMzLk1hbmFnZWRVcGxvYWQpIHsKICAgICAgICBjb25zdHJ1Y3RvcnMucHVzaChBV1MuUzMuTWFuYWdlZFVwbG9hZCk7CiAgICAgIH0KICAgIH0KICAgIEFXUy51dGlsLmFkZFByb21pc2VzKGNvbnN0cnVjdG9ycywgUHJvbWlzZXNEZXBlbmRlbmN5KTsKICB9LAoKICAvKioKICAgKiBHZXRzIHRoZSBwcm9taXNlIGRlcGVuZGVuY3kgc2V0IGJ5IGBBV1MuY29uZmlnLnNldFByb21pc2VzRGVwZW5kZW5jeWAuCiAgICovCiAgZ2V0UHJvbWlzZXNEZXBlbmRlbmN5OiBmdW5jdGlvbiBnZXRQcm9taXNlc0RlcGVuZGVuY3koKSB7CiAgICByZXR1cm4gUHJvbWlzZXNEZXBlbmRlbmN5OwogIH0KfSk7CgovKioKICogQHJldHVybiBbQVdTLkNvbmZpZ10gVGhlIGdsb2JhbCBjb25maWd1cmF0aW9uIG9iamVjdCBzaW5nbGV0b24gaW5zdGFuY2UKICogQHJlYWRvbmx5CiAqIEBzZWUgQVdTLkNvbmZpZwogKi8KQVdTLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKCk7Cgp9LHsiLi9jb3JlIjoxOSwiLi9jcmVkZW50aWFscyI6MjAsIi4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbiI6MjN9XSwxODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7Ci8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoY29uZmlnVmFsdWUsIGVycm9yT3B0aW9ucykgewogIGlmICh0eXBlb2YgY29uZmlnVmFsdWUgIT09ICdzdHJpbmcnKSByZXR1cm4gdW5kZWZpbmVkOwogIGVsc2UgaWYgKFsnbGVnYWN5JywgJ3JlZ2lvbmFsJ10uaW5kZXhPZihjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpKSA+PSAwKSB7CiAgICByZXR1cm4gY29uZmlnVmFsdWUudG9Mb3dlckNhc2UoKTsKICB9IGVsc2UgewogICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIGVycm9yT3B0aW9ucyk7CiAgfQp9CgovKioKICogUmVzb2x2ZSB0aGUgY29uZmlndXJhdGlvbiB2YWx1ZSBmb3IgcmVnaW9uYWwgZW5kcG9pbnQgZnJvbSBkaWZmZXJlbmNlIHNvdXJjZXM6IGNsaWVudAogKiBjb25maWcsIGVudmlyb25tZW50YWwgdmFyaWFibGUsIHNoYXJlZCBjb25maWcgZmlsZS4gVmFsdWUgY2FuIGJlIGNhc2UtaW5zZW5zaXRpdmUKICogJ2xlZ2FjeScgb3IgJ3JlZ2luYWwnLgogKiBAcGFyYW0gb3JpZ2luYWxDb25maWcgdXNlci1zdXBwbGllZCBjb25maWcgb2JqZWN0IHRvIHJlc29sdmUKICogQHBhcmFtIG9wdGlvbnMgYSBtYXAgb2YgY29uZmlnIHByb3BlcnR5IG5hbWVzIGZyb20gaW5kaXZpZHVhbCBjb25maWd1cmF0aW9uIHNvdXJjZQogKiAgLSBlbnY6IG5hbWUgb2YgZW52aXJvbm1lbnRhbCB2YXJpYWJsZSB0aGF0IHJlZmVycyB0byB0aGUgY29uZmlnCiAqICAtIHNoYXJlZENvbmZpZzogbmFtZSBvZiBzaGFyZWQgY29uZmlndXJhdGlvbiBmaWxlIHByb3BlcnR5IHRoYXQgcmVmZXJzIHRvIHRoZSBjb25maWcKICogIC0gY2xpZW50Q29uZmlnOiBuYW1lIG9mIGNsaWVudCBjb25maWd1cmF0aW9uIHByb3BlcnR5IHRoYXQgcmVmZXJzIHRvIHRoZSBjb25maWcKICoKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiByZXNvbHZlUmVnaW9uYWxFbmRwb2ludHNGbGFnKG9yaWdpbmFsQ29uZmlnLCBvcHRpb25zKSB7CiAgb3JpZ2luYWxDb25maWcgPSBvcmlnaW5hbENvbmZpZyB8fCB7fTsKICAvL3ZhbGlkYXRlIGNvbmZpZyB2YWx1ZQogIHZhciByZXNvbHZlZDsKICBpZiAob3JpZ2luYWxDb25maWdbb3B0aW9ucy5jbGllbnRDb25maWddKSB7CiAgICByZXNvbHZlZCA9IHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUob3JpZ2luYWxDb25maWdbb3B0aW9ucy5jbGllbnRDb25maWddLCB7CiAgICAgIGNvZGU6ICdJbnZhbGlkQ29uZmlndXJhdGlvbicsCiAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICInICsgb3B0aW9ucy5jbGllbnRDb25maWcgKyAnIiBjb25maWd1cmF0aW9uLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgb3JpZ2luYWxDb25maWdbb3B0aW9ucy5jbGllbnRDb25maWddICsgJyIuJwogICAgfSk7CiAgICBpZiAocmVzb2x2ZWQpIHJldHVybiByZXNvbHZlZDsKICB9CiAgaWYgKCFBV1MudXRpbC5pc05vZGUoKSkgcmV0dXJuIHJlc29sdmVkOwogIC8vdmFsaWRhdGUgZW52aXJvbm1lbnRhbCB2YXJpYWJsZQogIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvY2Vzcy5lbnYsIG9wdGlvbnMuZW52KSkgewogICAgdmFyIGVudkZsYWcgPSBwcm9jZXNzLmVudltvcHRpb25zLmVudl07CiAgICByZXNvbHZlZCA9IHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoZW52RmxhZywgewogICAgICBjb2RlOiAnSW52YWxpZEVudmlyb25tZW50YWxWYXJpYWJsZScsCiAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcgKyBvcHRpb25zLmVudiArICcgZW52aXJvbm1lbnRhbCB2YXJpYWJsZS4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIHByb2Nlc3MuZW52W29wdGlvbnMuZW52XSArICciLicKICAgIH0pOwogICAgaWYgKHJlc29sdmVkKSByZXR1cm4gcmVzb2x2ZWQ7CiAgfQogIC8vdmFsaWRhdGUgc2hhcmVkIGNvbmZpZyBmaWxlCiAgdmFyIHByb2ZpbGUgPSB7fTsKICB0cnkgewogICAgdmFyIHByb2ZpbGVzID0gQVdTLnV0aWwuZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnKEFXUy51dGlsLmluaUxvYWRlcik7CiAgICBwcm9maWxlID0gcHJvZmlsZXNbcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGVdOwogIH0gY2F0Y2ggKGUpIHt9OwogIGlmIChwcm9maWxlICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9maWxlLCBvcHRpb25zLnNoYXJlZENvbmZpZykpIHsKICAgIHZhciBmaWxlRmxhZyA9IHByb2ZpbGVbb3B0aW9ucy5zaGFyZWRDb25maWddOwogICAgcmVzb2x2ZWQgPSB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGZpbGVGbGFnLCB7CiAgICAgIGNvZGU6ICdJbnZhbGlkQ29uZmlndXJhdGlvbicsCiAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcgKyBvcHRpb25zLnNoYXJlZENvbmZpZyArICcgcHJvZmlsZSBjb25maWcuIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9maWxlW29wdGlvbnMuc2hhcmVkQ29uZmlnXSArICciLicKICAgIH0pOwogICAgaWYgKHJlc29sdmVkKSByZXR1cm4gcmVzb2x2ZWQ7CiAgfQogIHJldHVybiByZXNvbHZlZDsKfQoKbW9kdWxlLmV4cG9ydHMgPSByZXNvbHZlUmVnaW9uYWxFbmRwb2ludHNGbGFnOwoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9jb3JlIjoxOSwiX3Byb2Nlc3MiOjg5fV0sMTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIG1haW4gQVdTIG5hbWVzcGFjZQogKi8KdmFyIEFXUyA9IHsgdXRpbDogcmVxdWlyZSgnLi91dGlsJykgfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICogQCFtYWNybyBbbmV3XSBub2Jyb3dzZXIKICogICBAbm90ZSBUaGlzIGZlYXR1cmUgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvZiB0aGUgU0RLLgogKi8KdmFyIF9oaWRkZW4gPSB7fTsgX2hpZGRlbi50b1N0cmluZygpOyAvLyBoYWNrIHRvIHBhcnNlIG1hY3JvCgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUzsKCkFXUy51dGlsLnVwZGF0ZShBV1MsIHsKCiAgLyoqCiAgICogQGNvbnN0YW50CiAgICovCiAgVkVSU0lPTjogJzIuMTIwMC4wJywKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2lnbmVyczoge30sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIFByb3RvY29sOiB7CiAgICBKc29uOiByZXF1aXJlKCcuL3Byb3RvY29sL2pzb24nKSwKICAgIFF1ZXJ5OiByZXF1aXJlKCcuL3Byb3RvY29sL3F1ZXJ5JyksCiAgICBSZXN0OiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKSwKICAgIFJlc3RKc29uOiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfanNvbicpLAogICAgUmVzdFhtbDogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X3htbCcpCiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgWE1MOiB7CiAgICBCdWlsZGVyOiByZXF1aXJlKCcuL3htbC9idWlsZGVyJyksCiAgICBQYXJzZXI6IG51bGwgLy8gY29uZGl0aW9uYWxseSBzZXQgYmFzZWQgb24gZW52aXJvbm1lbnQKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBKU09OOiB7CiAgICBCdWlsZGVyOiByZXF1aXJlKCcuL2pzb24vYnVpbGRlcicpLAogICAgUGFyc2VyOiByZXF1aXJlKCcuL2pzb24vcGFyc2VyJykKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBNb2RlbDogewogICAgQXBpOiByZXF1aXJlKCcuL21vZGVsL2FwaScpLAogICAgT3BlcmF0aW9uOiByZXF1aXJlKCcuL21vZGVsL29wZXJhdGlvbicpLAogICAgU2hhcGU6IHJlcXVpcmUoJy4vbW9kZWwvc2hhcGUnKSwKICAgIFBhZ2luYXRvcjogcmVxdWlyZSgnLi9tb2RlbC9wYWdpbmF0b3InKSwKICAgIFJlc291cmNlV2FpdGVyOiByZXF1aXJlKCcuL21vZGVsL3Jlc291cmNlX3dhaXRlcicpCiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXBpTG9hZGVyOiByZXF1aXJlKCcuL2FwaV9sb2FkZXInKSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgRW5kcG9pbnRDYWNoZTogcmVxdWlyZSgnLi4vdmVuZG9yL2VuZHBvaW50LWNhY2hlJykuRW5kcG9pbnRDYWNoZQp9KTsKcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CnJlcXVpcmUoJy4vc2VydmljZScpOwpyZXF1aXJlKCcuL2NvbmZpZycpOwpyZXF1aXJlKCcuL2h0dHAnKTsKcmVxdWlyZSgnLi9ldmVudF9saXN0ZW5lcnMnKTsKcmVxdWlyZSgnLi9yZXF1ZXN0Jyk7CnJlcXVpcmUoJy4vcmVzcG9uc2UnKTsKcmVxdWlyZSgnLi9yZXNvdXJjZV93YWl0ZXInKTsKcmVxdWlyZSgnLi9zaWduZXJzL3JlcXVlc3Rfc2lnbmVyJyk7CnJlcXVpcmUoJy4vcGFyYW1fdmFsaWRhdG9yJyk7CgovKioKICogQHJlYWRvbmx5CiAqIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIGEgY29sbGVjdGlvbiBvZiBnbG9iYWwgZXZlbnQgbGlzdGVuZXJzIHRoYXQKICogICBhcmUgYXR0YWNoZWQgdG8gZXZlcnkgc2VudCByZXF1ZXN0LgogKiBAc2VlIEFXUy5SZXF1ZXN0IEFXUy5SZXF1ZXN0IGZvciBhIGxpc3Qgb2YgZXZlbnRzIHRvIGxpc3RlbiBmb3IKICogQGV4YW1wbGUgTG9nZ2luZyB0aGUgdGltZSB0YWtlbiB0byBzZW5kIGEgcmVxdWVzdAogKiAgIEFXUy5ldmVudHMub24oJ3NlbmQnLCBmdW5jdGlvbiBzdGFydFNlbmQocmVzcCkgewogKiAgICAgcmVzcC5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICogICB9KS5vbignY29tcGxldGUnLCBmdW5jdGlvbiBjYWxjdWxhdGVUaW1lKHJlc3ApIHsKICogICAgIHZhciB0aW1lID0gKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gcmVzcC5zdGFydFRpbWUpIC8gMTAwMDsKICogICAgIGNvbnNvbGUubG9nKCdSZXF1ZXN0IHRvb2sgJyArIHRpbWUgKyAnIHNlY29uZHMnKTsKICogICB9KTsKICoKICogICBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldHMoKTsgLy8gcHJpbnRzICdSZXF1ZXN0IHRvb2sgMC4yODUgc2Vjb25kcycKICovCkFXUy5ldmVudHMgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwoKLy9jcmVhdGUgZW5kcG9pbnQgY2FjaGUgbGF6aWx5CkFXUy51dGlsLm1lbW9pemVkUHJvcGVydHkoQVdTLCAnZW5kcG9pbnRDYWNoZScsIGZ1bmN0aW9uKCkgewogIHJldHVybiBuZXcgQVdTLkVuZHBvaW50Q2FjaGUoQVdTLmNvbmZpZy5lbmRwb2ludENhY2hlU2l6ZSk7Cn0sIHRydWUpOwoKfSx7Ii4uL3ZlbmRvci9lbmRwb2ludC1jYWNoZSI6MTA5LCIuL2FwaV9sb2FkZXIiOjksIi4vY29uZmlnIjoxNywiLi9ldmVudF9saXN0ZW5lcnMiOjM0LCIuL2h0dHAiOjM1LCIuL2pzb24vYnVpbGRlciI6MzcsIi4vanNvbi9wYXJzZXIiOjM4LCIuL21vZGVsL2FwaSI6MzksIi4vbW9kZWwvb3BlcmF0aW9uIjo0MSwiLi9tb2RlbC9wYWdpbmF0b3IiOjQyLCIuL21vZGVsL3Jlc291cmNlX3dhaXRlciI6NDMsIi4vbW9kZWwvc2hhcGUiOjQ0LCIuL3BhcmFtX3ZhbGlkYXRvciI6NDUsIi4vcHJvdG9jb2wvanNvbiI6NDcsIi4vcHJvdG9jb2wvcXVlcnkiOjQ4LCIuL3Byb3RvY29sL3Jlc3QiOjQ5LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NTAsIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUxLCIuL3JlcXVlc3QiOjU3LCIuL3Jlc291cmNlX3dhaXRlciI6NTgsIi4vcmVzcG9uc2UiOjU5LCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjYwLCIuL3NlcnZpY2UiOjYxLCIuL3NpZ25lcnMvcmVxdWVzdF9zaWduZXIiOjY0LCIuL3V0aWwiOjcyLCIuL3htbC9idWlsZGVyIjo3NH1dLDIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwoKLyoqCiAqIFJlcHJlc2VudHMgeW91ciBBV1Mgc2VjdXJpdHkgY3JlZGVudGlhbHMsIHNwZWNpZmljYWxseSB0aGUKICoge2FjY2Vzc0tleUlkfSwge3NlY3JldEFjY2Vzc0tleX0sIGFuZCBvcHRpb25hbCB7c2Vzc2lvblRva2VufS4KICogQ3JlYXRpbmcgYSBgQ3JlZGVudGlhbHNgIG9iamVjdCBhbGxvd3MgeW91IHRvIHBhc3MgYXJvdW5kIHlvdXIKICogc2VjdXJpdHkgaW5mb3JtYXRpb24gdG8gY29uZmlndXJhdGlvbiBhbmQgc2VydmljZSBvYmplY3RzLgogKgogKiBOb3RlIHRoYXQgdGhpcyBjbGFzcyB0eXBpY2FsbHkgZG9lcyBub3QgbmVlZCB0byBiZSBjb25zdHJ1Y3RlZCBtYW51YWxseSwKICogYXMgdGhlIHtBV1MuQ29uZmlnfSBhbmQge0FXUy5TZXJ2aWNlfSBjbGFzc2VzIGJvdGggYWNjZXB0IHNpbXBsZQogKiBvcHRpb25zIGhhc2hlcyB3aXRoIHRoZSB0aHJlZSBrZXlzLiBUaGVzZSBzdHJ1Y3R1cmVzIHdpbGwgYmUgY29udmVydGVkCiAqIGludG8gQ3JlZGVudGlhbHMgb2JqZWN0cyBhdXRvbWF0aWNhbGx5LgogKgogKiAjIyBFeHBpcmluZyBhbmQgUmVmcmVzaGluZyBDcmVkZW50aWFscwogKgogKiBPY2Nhc2lvbmFsbHkgY3JlZGVudGlhbHMgY2FuIGV4cGlyZSBpbiB0aGUgbWlkZGxlIG9mIGEgbG9uZy1ydW5uaW5nCiAqIGFwcGxpY2F0aW9uLiBJbiB0aGlzIGNhc2UsIHRoZSBTREsgd2lsbCBhdXRvbWF0aWNhbGx5IGF0dGVtcHQgdG8KICogcmVmcmVzaCB0aGUgY3JlZGVudGlhbHMgZnJvbSB0aGUgc3RvcmFnZSBsb2NhdGlvbiBpZiB0aGUgQ3JlZGVudGlhbHMKICogY2xhc3MgaW1wbGVtZW50cyB0aGUge3JlZnJlc2h9IG1ldGhvZC4KICoKICogSWYgeW91IGFyZSBpbXBsZW1lbnRpbmcgYSBjcmVkZW50aWFsIHN0b3JhZ2UgbG9jYXRpb24sIHlvdQogKiB3aWxsIHdhbnQgdG8gY3JlYXRlIGEgc3ViY2xhc3Mgb2YgdGhlIGBDcmVkZW50aWFsc2AgY2xhc3MgYW5kCiAqIG92ZXJyaWRlIHRoZSB7cmVmcmVzaH0gbWV0aG9kLiBUaGlzIG1ldGhvZCBhbGxvd3MgY3JlZGVudGlhbHMgdG8gYmUKICogcmV0cmlldmVkIGZyb20gdGhlIGJhY2tpbmcgc3RvcmUsIGJlIGl0IGEgZmlsZSBzeXN0ZW0sIGRhdGFiYXNlLCBvcgogKiBzb21lIG5ldHdvcmsgc3RvcmFnZS4gVGhlIG1ldGhvZCBzaG91bGQgcmVzZXQgdGhlIGNyZWRlbnRpYWwgYXR0cmlidXRlcwogKiBvbiB0aGUgb2JqZWN0LgogKgogKiBAIWF0dHJpYnV0ZSBleHBpcmVkCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgY3JlZGVudGlhbHMgaGF2ZSBiZWVuIGV4cGlyZWQgYW5kCiAqICAgICByZXF1aXJlIGEgcmVmcmVzaC4gVXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHtleHBpcmVUaW1lfS4KICogQCFhdHRyaWJ1dGUgZXhwaXJlVGltZQogKiAgIEByZXR1cm4gW0RhdGVdIGEgdGltZSB3aGVuIGNyZWRlbnRpYWxzIHNob3VsZCBiZSBjb25zaWRlcmVkIGV4cGlyZWQuIFVzZWQKICogICAgIGluIGNvbmp1bmN0aW9uIHdpdGgge2V4cGlyZWR9LgogKiBAIWF0dHJpYnV0ZSBhY2Nlc3NLZXlJZAogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAqIEAhYXR0cmlidXRlIHNlY3JldEFjY2Vzc0tleQogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogKiBAIWF0dHJpYnV0ZSBzZXNzaW9uVG9rZW4KICogICBAcmV0dXJuIFtTdHJpbmddIGFuIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAqLwpBV1MuQ3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KHsKICAvKioKICAgKiBBIGNyZWRlbnRpYWxzIG9iamVjdCBjYW4gYmUgY3JlYXRlZCB1c2luZyBwb3NpdGlvbmFsIGFyZ3VtZW50cyBvciBhbiBvcHRpb25zCiAgICogaGFzaC4KICAgKgogICAqIEBvdmVybG9hZCBBV1MuQ3JlZGVudGlhbHMoYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleSwgc2Vzc2lvblRva2VuPW51bGwpCiAgICogICBDcmVhdGVzIGEgQ3JlZGVudGlhbHMgb2JqZWN0IHdpdGggYSBnaXZlbiBzZXQgb2YgY3JlZGVudGlhbCBpbmZvcm1hdGlvbgogICAqICAgYXMgcG9zaXRpb25hbCBhcmd1bWVudHMuCiAgICogICBAcGFyYW0gYWNjZXNzS2V5SWQgW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICogICBAcGFyYW0gc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgKiAgIEBwYXJhbSBzZXNzaW9uVG9rZW4gW1N0cmluZ10gdGhlIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICogICBAZXhhbXBsZSBDcmVhdGUgYSBjcmVkZW50aWFscyBvYmplY3Qgd2l0aCBBV1MgY3JlZGVudGlhbHMKICAgKiAgICAgdmFyIGNyZWRzID0gbmV3IEFXUy5DcmVkZW50aWFscygnYWtpZCcsICdzZWNyZXQnLCAnc2Vzc2lvbicpOwogICAqIEBvdmVybG9hZCBBV1MuQ3JlZGVudGlhbHMob3B0aW9ucykKICAgKiAgIENyZWF0ZXMgYSBDcmVkZW50aWFscyBvYmplY3Qgd2l0aCBhIGdpdmVuIHNldCBvZiBjcmVkZW50aWFsIGluZm9ybWF0aW9uCiAgICogICBhcyBhbiBvcHRpb25zIGhhc2guCiAgICogICBAb3B0aW9uIG9wdGlvbnMgYWNjZXNzS2V5SWQgW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICogICBAb3B0aW9uIG9wdGlvbnMgc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgKiAgIEBvcHRpb24gb3B0aW9ucyBzZXNzaW9uVG9rZW4gW1N0cmluZ10gdGhlIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICogICBAZXhhbXBsZSBDcmVhdGUgYSBjcmVkZW50aWFscyBvYmplY3Qgd2l0aCBBV1MgY3JlZGVudGlhbHMKICAgKiAgICAgdmFyIGNyZWRzID0gbmV3IEFXUy5DcmVkZW50aWFscyh7CiAgICogICAgICAgYWNjZXNzS2V5SWQ6ICdha2lkJywgc2VjcmV0QWNjZXNzS2V5OiAnc2VjcmV0Jywgc2Vzc2lvblRva2VuOiAnc2Vzc2lvbicKICAgKiAgICAgfSk7CiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENyZWRlbnRpYWxzKCkgewogICAgLy8gaGlkZSBzZWNyZXRBY2Nlc3NLZXkgZnJvbSBiZWluZyBkaXNwbGF5ZWQgd2l0aCB1dGlsLmluc3BlY3QKICAgIEFXUy51dGlsLmhpZGVQcm9wZXJ0aWVzKHRoaXMsIFsnc2VjcmV0QWNjZXNzS2V5J10pOwoKICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwogICAgdGhpcy5leHBpcmVUaW1lID0gbnVsbDsKICAgIHRoaXMucmVmcmVzaENhbGxiYWNrcyA9IFtdOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFyIGNyZWRzID0gYXJndW1lbnRzWzBdLmNyZWRlbnRpYWxzIHx8IGFyZ3VtZW50c1swXTsKICAgICAgdGhpcy5hY2Nlc3NLZXlJZCA9IGNyZWRzLmFjY2Vzc0tleUlkOwogICAgICB0aGlzLnNlY3JldEFjY2Vzc0tleSA9IGNyZWRzLnNlY3JldEFjY2Vzc0tleTsKICAgICAgdGhpcy5zZXNzaW9uVG9rZW4gPSBjcmVkcy5zZXNzaW9uVG9rZW47CiAgICB9IGVsc2UgewogICAgICB0aGlzLmFjY2Vzc0tleUlkID0gYXJndW1lbnRzWzBdOwogICAgICB0aGlzLnNlY3JldEFjY2Vzc0tleSA9IGFyZ3VtZW50c1sxXTsKICAgICAgdGhpcy5zZXNzaW9uVG9rZW4gPSBhcmd1bWVudHNbMl07CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiBzZWNvbmRzIGJlZm9yZSB7ZXhwaXJlVGltZX0gZHVyaW5nIHdoaWNoCiAgICogICB0aGUgY3JlZGVudGlhbHMgd2lsbCBiZSBjb25zaWRlcmVkIGV4cGlyZWQuCiAgICovCiAgZXhwaXJ5V2luZG93OiAxNSwKCiAgLyoqCiAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHNob3VsZCBjYWxsIHtyZWZyZXNofQogICAqIEBub3RlIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHByb3ZpZGUgY3VzdG9tIHJlZnJlc2gKICAgKiAgIGxvZ2ljLgogICAqLwogIG5lZWRzUmVmcmVzaDogZnVuY3Rpb24gbmVlZHNSZWZyZXNoKCkgewogICAgdmFyIGN1cnJlbnRUaW1lID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIGFkanVzdGVkVGltZSA9IG5ldyBEYXRlKGN1cnJlbnRUaW1lICsgdGhpcy5leHBpcnlXaW5kb3cgKiAxMDAwKTsKCiAgICBpZiAodGhpcy5leHBpcmVUaW1lICYmIGFkanVzdGVkVGltZSA+IHRoaXMuZXhwaXJlVGltZSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmV4cGlyZWQgfHwgIXRoaXMuYWNjZXNzS2V5SWQgfHwgIXRoaXMuc2VjcmV0QWNjZXNzS2V5OwogICAgfQogIH0sCgogIC8qKgogICAqIEdldHMgdGhlIGV4aXN0aW5nIGNyZWRlbnRpYWxzLCByZWZyZXNoaW5nIHRoZW0gaWYgdGhleSBhcmUgbm90IHlldCBsb2FkZWQKICAgKiBvciBoYXZlIGV4cGlyZWQuIFVzZXJzIHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZSB1c2luZyB7cmVmcmVzaH0sCiAgICogYXMgdGhpcyB3aWxsIG5vdCBhdHRlbXB0IHRvIHJlbG9hZCBjcmVkZW50aWFscyB3aGVuIHRoZXkgYXJlIGFscmVhZHkKICAgKiBsb2FkZWQgaW50byB0aGUgb2JqZWN0LgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgZWl0aGVyIGNyZWRlbnRpYWxzCiAgICogICBkbyBub3QgbmVlZCB0byBiZSByZWZyZXNoZWQgb3IgcmVmcmVzaGVkIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcwogICAqICAgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsCiAgICogICBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKi8KICBnZXQ6IGZ1bmN0aW9uIGdldChjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHRoaXMubmVlZHNSZWZyZXNoKCkpIHsKICAgICAgdGhpcy5yZWZyZXNoKGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmICghZXJyKSBzZWxmLmV4cGlyZWQgPSBmYWxzZTsgLy8gcmVzZXQgZXhwaXJlZCBmbGFnCiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2soKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAIW1ldGhvZCAgZ2V0UHJvbWlzZSgpCiAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAqICAgR2V0cyB0aGUgZXhpc3RpbmcgY3JlZGVudGlhbHMsIHJlZnJlc2hpbmcgdGhlbSBpZiB0aGV5IGFyZSBub3QgeWV0IGxvYWRlZAogICAqICAgb3IgaGF2ZSBleHBpcmVkLiBVc2VycyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmUgdXNpbmcge3JlZnJlc2h9LAogICAqICAgYXMgdGhpcyB3aWxsIG5vdCBhdHRlbXB0IHRvIHJlbG9hZCBjcmVkZW50aWFscyB3aGVuIHRoZXkgYXJlIGFscmVhZHkKICAgKiAgIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QuCiAgICoKICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKCkKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4gV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCwgaXQKICAgKiAgICAgbWVhbnMgZWl0aGVyIGNyZWRlbnRpYWxzIGRvIG5vdCBuZWVkIHRvIGJlIHJlZnJlc2hlZCBvciByZWZyZXNoZWQKICAgKiAgICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlCiAgICogICAgIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYGdldGAgY2FsbC4KICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGBnZXRQcm9taXNlYCBtZXRob2QuCiAgICogICAgIHZhciBwcm9taXNlID0gY3JlZFByb3ZpZGVyLmdldFByb21pc2UoKTsKICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgKi8KCiAgLyoqCiAgICogQCFtZXRob2QgIHJlZnJlc2hQcm9taXNlKCkKICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICogICBSZWZyZXNoZXMgdGhlIGNyZWRlbnRpYWxzLiBVc2VycyBzaG91bGQgY2FsbCB7Z2V0fSBiZWZvcmUgYXR0ZW1wdGluZwogICAqICAgdG8gZm9yY2libHkgcmVmcmVzaCBjcmVkZW50aWFscy4KICAgKgogICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLiBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkLCBpdAogICAqICAgICBtZWFucyByZWZyZXNoZWQgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdAogICAqICAgICAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYHJlZnJlc2hgIGNhbGwuCiAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgcmVmcmVzaFByb21pc2VgIG1ldGhvZC4KICAgKiAgICAgdmFyIHByb21pc2UgPSBjcmVkUHJvdmlkZXIucmVmcmVzaFByb21pc2UoKTsKICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgKi8KCiAgLyoqCiAgICogUmVmcmVzaGVzIHRoZSBjcmVkZW50aWFscy4gVXNlcnMgc2hvdWxkIGNhbGwge2dldH0gYmVmb3JlIGF0dGVtcHRpbmcKICAgKiB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgcmVmcmVzaGVkCiAgICogICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUKICAgKiAgIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiBAbm90ZSBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzIGNsYXNzIHRvIHJlc2V0IHRoZQogICAqICAge2FjY2Vzc0tleUlkfSwge3NlY3JldEFjY2Vzc0tleX0gYW5kIG9wdGlvbmFsIHtzZXNzaW9uVG9rZW59CiAgICogICBvbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IGFuZCB0aGVuIGNhbGwgdGhlIGNhbGxiYWNrIHdpdGgKICAgKiAgIGFueSBlcnJvciBpbmZvcm1hdGlvbi4KICAgKiBAc2VlIGdldAogICAqLwogIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwogICAgY2FsbGJhY2soKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgKi8KICBjb2FsZXNjZVJlZnJlc2g6IGZ1bmN0aW9uIGNvYWxlc2NlUmVmcmVzaChjYWxsYmFjaywgc3luYykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKHNlbGYucmVmcmVzaENhbGxiYWNrcy5wdXNoKGNhbGxiYWNrKSA9PT0gMSkgewogICAgICBzZWxmLmxvYWQoZnVuY3Rpb24gb25Mb2FkKGVycikgewogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzZWxmLnJlZnJlc2hDYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoc3luYykgewogICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gY2FsbGJhY2sgY291bGQgdGhyb3csIHNvIGRlZmVyIHRvIGVuc3VyZSBhbGwgY2FsbGJhY2tzIGFyZSBub3RpZmllZAogICAgICAgICAgICBBV1MudXRpbC5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLmxlbmd0aCA9IDA7CiAgICAgIH0pOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBwYXJhbSBjYWxsYmFjawogICAqLwogIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgIGNhbGxiYWNrKCk7CiAgfQp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5DcmVkZW50aWFscy5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICB0aGlzLnByb3RvdHlwZS5nZXRQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdnZXQnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgdGhpcy5wcm90b3R5cGUucmVmcmVzaFByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ3JlZnJlc2gnLCBQcm9taXNlRGVwZW5kZW5jeSk7Cn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuQ3JlZGVudGlhbHMuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICBkZWxldGUgdGhpcy5wcm90b3R5cGUuZ2V0UHJvbWlzZTsKICBkZWxldGUgdGhpcy5wcm90b3R5cGUucmVmcmVzaFByb21pc2U7Cn07CgpBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuQ3JlZGVudGlhbHMpOwoKfSx7Ii4vY29yZSI6MTl9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwoKLyoqCiAqIFJlcHJlc2VudHMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIHtBV1MuU1RTfS4gV2l0aG91dCBhbnkKICogZXh0cmEgcGFyYW1ldGVycywgY3JlZGVudGlhbHMgd2lsbCBiZSBmZXRjaGVkIGZyb20gdGhlCiAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9uLiBJZiBhbiBJQU0gcm9sZSBpcyBwcm92aWRlZCwgdGhlCiAqIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9wZXJhdGlvbiB3aWxsIGJlIHVzZWQgdG8gZmV0Y2ggY3JlZGVudGlhbHMgZm9yIHRoZQogKiByb2xlIGluc3RlYWQuCiAqCiAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBkaWZmZXJzIGZyb20gQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGluCiAqIHRoZSB3YXkgbWFzdGVyQ3JlZGVudGlhbHMgYW5kIHJlZnJlc2hlcyBhcmUgaGFuZGxlZC4KICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIHJlZnJlc2hlcyBleHBpcmVkIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogKiBtYXN0ZXJDcmVkZW50aWFscyBwYXNzZWQgYnkgdGhlIHVzZXIgdG8gc3VwcG9ydCBjaGFpbmluZyBvZiBTVFMgY3JlZGVudGlhbHMuCiAqIEhvd2V2ZXIsIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyByZWN1cnNpdmVseSBjb2xsYXBzZXMgdGhlIG1hc3RlckNyZWRlbnRpYWxzCiAqIGR1cmluZyBpbnN0YW50aWF0aW9uLCBwcmVjbHVkaW5nIHRoZSBhYmlsaXR5IHRvIHJlZnJlc2ggY3JlZGVudGlhbHMgd2hpY2gKICogcmVxdWlyZSBpbnRlcm1lZGlhdGUsIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICoKICogRm9yIGV4YW1wbGUsIGlmIHRoZSBhcHBsaWNhdGlvbiBzaG91bGQgdXNlIFJvbGVBLCB3aGljaCBtdXN0IGJlIGFzc3VtZWQgZnJvbQogKiBSb2xlQiwgYW5kIHRoZSBlbnZpcm9ubWVudCBwcm92aWRlcyBjcmVkZW50aWFscyB3aGljaCBjYW4gYXNzdW1lIFJvbGVCLCB0aGVuCiAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBtdXN0IGJlIHVzZWQgdG8gc3VwcG9ydCByZWZyZXNoaW5nIHRoZQogKiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZm9yIFJvbGVBOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIHZhciByb2xlQUNyZWRzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAqICAgcGFyYW1zOiB7Um9sZUFybjogJ1JvbGVBJ30sCiAqICAgbWFzdGVyQ3JlZGVudGlhbHM6IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogKiAgICAgcGFyYW1zOiB7Um9sZUFybjogJ1JvbGVCJ30sCiAqICAgICBtYXN0ZXJDcmVkZW50aWFsczogbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKQogKiAgIH0pCiAqIH0pOwogKiBgYGAKICoKICogSWYgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGhhZCBiZWVuIHVzZWQgaW4gdGhlIHByZXZpb3VzIGV4YW1wbGUsCiAqIGByb2xlQUNyZWRzYCB3b3VsZCBmYWlsIHRvIHJlZnJlc2ggYmVjYXVzZSBgcm9sZUFDcmVkc2Agd291bGQKICogdXNlIHRoZSBlbnZpcm9ubWVudCBjcmVkZW50aWFscyBmb3IgdGhlIEFzc3VtZVJvbGUgcmVxdWVzdC4KICoKICogQW5vdGhlciBkaWZmZXJlbmNlIGlzIHRoYXQgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIGNyZWF0ZXMgdGhlIFNUUwogKiBzZXJ2aWNlIGluc3RhbmNlIGR1cmluZyBpbnN0YW50aWF0aW9uIHdoaWxlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBjcmVhdGVzCiAqIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSBkdXJpbmcgdGhlIGZpcnN0IHJlZnJlc2guIENyZWF0aW5nIHRoZSBzZXJ2aWNlCiAqIGluc3RhbmNlIGR1cmluZyBpbnN0YW50aWF0aW9uIGVmZmVjdGl2ZWx5IGNhcHR1cmVzIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICogZnJvbSB0aGUgZ2xvYmFsIGNvbmZpZywgc28gdGhhdCBzdWJzZXF1ZW50IGNoYW5nZXMgdG8gdGhlIGdsb2JhbCBjb25maWcgZG8KICogbm90IGFmZmVjdCB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzIHVzZWQgdG8gcmVmcmVzaCB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogKgogKiBUaGlzIGFsbG93cyBhbiBpbnN0YW5jZSBvZiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgdG8gYmUgYXNzaWduZWQKICogdG8gQVdTLmNvbmZpZy5jcmVkZW50aWFsczoKICoKICogYGBgamF2YXNjcmlwdAogKiB2YXIgZW52Q3JlZHMgPSBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOwogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gZW52Q3JlZHM7CiAqIC8vIG1hc3RlckNyZWRlbnRpYWxzIHdpbGwgYmUgZW52Q3JlZHMKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogKiAgIHBhcmFtczoge1JvbGVBcm46ICcuLi4nfQogKiB9KTsKICogYGBgCiAqCiAqIFNpbWlsYXJseSwgdG8gdXNlIHRoZSBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbidzIGRlZmF1bHQgcHJvdmlkZXJzIGFzIHRoZQogKiBtYXN0ZXIgY3JlZGVudGlhbHMsIHNpbXBseSBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YKICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogKiAgIHBhcmFtczoge1JvbGVBcm46ICcuLi4nfQogKiB9KTsKICogYGBgCiAqCiAqIEAhYXR0cmlidXRlIHNlcnZpY2UKICogICBAcmV0dXJuIFtBV1MuU1RTXSB0aGUgU1RTIHNlcnZpY2UgaW5zdGFuY2UgdXNlZCB0bwogKiAgICAgZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAqIEBub3RlIChzZWUgY29uc3RydWN0b3IpCiAqLwpBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSBvcHRpb25zIFttYXBdIGEgc2V0IG9mIG9wdGlvbnMKICAgKiBAb3B0aW9uIG9wdGlvbnMgcGFyYW1zIFttYXBdICh7fSkgYSBtYXAgb2Ygb3B0aW9ucyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhlCiAgICogICB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvciB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbnMuCiAgICogICBJZiBhIGBSb2xlQXJuYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCBjcmVkZW50aWFscyB3aWxsIGJlIGJhc2VkIG9uIHRoZQogICAqICAgSUFNIHJvbGUuIElmIGEgYFNlcmlhbE51bWJlcmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwge3Rva2VuQ29kZUZufSBtdXN0CiAgICogICBhbHNvIGJlIHBhc3NlZCBpbiBvciBhbiBlcnJvciB3aWxsIGJlIHRocm93bi4KICAgKiBAb3B0aW9uIG9wdGlvbnMgbWFzdGVyQ3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAqICAgdXNlZCB0byBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4gQnkgZGVmYXVsdCwKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgb3IgQVdTLmNvbmZpZy5jcmVkZW50aWFsUHJvdmlkZXIgd2lsbCBiZSB1c2VkLgogICAqIEBvcHRpb24gb3B0aW9ucyB0b2tlbkNvZGVGbiBbRnVuY3Rpb25dIChudWxsKSBGdW5jdGlvbiB0byBwcm92aWRlCiAgICogICBgVG9rZW5Db2RlYCwgaWYgYFNlcmlhbE51bWJlcmAgaXMgcHJvdmlkZWQgZm9yIHByb2ZpbGUgaW4ge3BhcmFtc30uIEZ1bmN0aW9uCiAgICogICBpcyBjYWxsZWQgd2l0aCB2YWx1ZSBvZiBgU2VyaWFsTnVtYmVyYCBhbmQgYGNhbGxiYWNrYCwgYW5kIHNob3VsZCBwcm92aWRlCiAgICogICB0aGUgYFRva2VuQ29kZWAgb3IgYW4gZXJyb3IgdG8gdGhlIGNhbGxiYWNrIGluIHRoZSBmb3JtYXQKICAgKiAgIGBjYWxsYmFjayhlcnIsIHRva2VuKWAuCiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBnZW5lcmljIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGFuIElBTSByb2xlCiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICAgIHBhcmFtczogewogICAqICAgICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1RlbXBvcmFyeUNyZWRlbnRpYWxzJwogICAqICAgICB9CiAgICogICB9KTsKICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZQogICAqIEBzZWUgQVdTLlNUUy5nZXRTZXNzaW9uVG9rZW4KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMob3B0aW9ucykgewogICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuZXJyb3JDb2RlID0gJ0NoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJzsKICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICB0aGlzLnRva2VuQ29kZUZuID0gbnVsbDsKCiAgICB2YXIgcGFyYW1zID0gQVdTLnV0aWwuY29weShvcHRpb25zLnBhcmFtcykgfHwge307CiAgICBpZiAocGFyYW1zLlJvbGVBcm4pIHsKICAgICAgcGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9IHBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3RlbXBvcmFyeS1jcmVkZW50aWFscyc7CiAgICB9CiAgICBpZiAocGFyYW1zLlNlcmlhbE51bWJlcikgewogICAgICBpZiAoIW9wdGlvbnMudG9rZW5Db2RlRm4gfHwgKHR5cGVvZiBvcHRpb25zLnRva2VuQ29kZUZuICE9PSAnZnVuY3Rpb24nKSkgewogICAgICAgIHRocm93IG5ldyBBV1MudXRpbC5lcnJvcigKICAgICAgICAgIG5ldyBFcnJvcigndG9rZW5Db2RlRm4gbXVzdCBiZSBhIGZ1bmN0aW9uIHdoZW4gcGFyYW1zLlNlcmlhbE51bWJlciBpcyBnaXZlbicpLAogICAgICAgICAge2NvZGU6IHRoaXMuZXJyb3JDb2RlfQogICAgICAgICk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50b2tlbkNvZGVGbiA9IG9wdGlvbnMudG9rZW5Db2RlRm47CiAgICAgIH0KICAgIH0KICAgIHZhciBjb25maWcgPSBBV1MudXRpbC5tZXJnZSgKICAgICAgewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIGNyZWRlbnRpYWxzOiBvcHRpb25zLm1hc3RlckNyZWRlbnRpYWxzIHx8IEFXUy5jb25maWcuY3JlZGVudGlhbHMKICAgICAgfSwKICAgICAgb3B0aW9ucy5zdHNDb25maWcgfHwge30KICAgICk7CiAgICB0aGlzLnNlcnZpY2UgPSBuZXcgU1RTKGNvbmZpZyk7CiAgfSwKCiAgLyoqCiAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yCiAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSwgZGVwZW5kaW5nIG9uIHdoZXRoZXIgYW4gSUFNIHJvbGUgQVJOIHdhcyBwYXNzZWQKICAgKiB0byB0aGUgY3JlZGVudGlhbHMge2NvbnN0cnVjdG9yfS4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqIEBzZWUgQVdTLkNyZWRlbnRpYWxzLmdldAogICAqLwogIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgKi8KICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgb3BlcmF0aW9uID0gc2VsZi5zZXJ2aWNlLmNvbmZpZy5wYXJhbXMuUm9sZUFybiA/ICdhc3N1bWVSb2xlJyA6ICdnZXRTZXNzaW9uVG9rZW4nOwogICAgdGhpcy5nZXRUb2tlbkNvZGUoZnVuY3Rpb24gKGVyciwgdG9rZW5Db2RlKSB7CiAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgaWYgKGVycikgewogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0b2tlbkNvZGUpIHsKICAgICAgICBwYXJhbXMuVG9rZW5Db2RlID0gdG9rZW5Db2RlOwogICAgICB9CiAgICAgIHNlbGYuc2VydmljZVtvcGVyYXRpb25dKHBhcmFtcywgZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldFRva2VuQ29kZTogZnVuY3Rpb24gZ2V0VG9rZW5Db2RlKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAodGhpcy50b2tlbkNvZGVGbikgewogICAgICB0aGlzLnRva2VuQ29kZUZuKHRoaXMuc2VydmljZS5jb25maWcucGFyYW1zLlNlcmlhbE51bWJlciwgZnVuY3Rpb24gKGVyciwgdG9rZW4pIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9IGVycjsKICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICBtZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjaygKICAgICAgICAgICAgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgbmV3IEVycm9yKCdFcnJvciBmZXRjaGluZyBNRkEgdG9rZW46ICcgKyBtZXNzYWdlKSwKICAgICAgICAgICAgICB7IGNvZGU6IHNlbGYuZXJyb3JDb2RlfQogICAgICAgICAgICApCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhudWxsLCB0b2tlbik7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sobnVsbCk7CiAgICB9CiAgfQp9KTsKCn0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTl9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBDb2duaXRvSWRlbnRpdHkgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL2NvZ25pdG9pZGVudGl0eScpOwp2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKCi8qKgogKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiB1c2luZwogKiB0aGUgQW1hem9uIENvZ25pdG8gSWRlbnRpdHkgc2VydmljZS4KICoKICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAqIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLCB3aGljaAogKiByZXF1aXJlcyBlaXRoZXIgYW4gYElkZW50aXR5SWRgIG9yIGFuIGBJZGVudGl0eVBvb2xJZGAgKEFtYXpvbiBDb2duaXRvCiAqIElkZW50aXR5IFBvb2wgSUQpLCB3aGljaCBpcyB1c2VkIHRvIGNhbGwge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWR9IHRvCiAqIG9idGFpbiBhbiBgSWRlbnRpdHlJZGAuIElmIHRoZSBpZGVudGl0eSBvciBpZGVudGl0eSBwb29sIGlzIG5vdCBjb25maWd1cmVkIGluCiAqIHRoZSBBbWF6b24gQ29nbml0byBDb25zb2xlIHRvIHVzZSBJQU0gcm9sZXMgd2l0aCB0aGUgYXBwcm9wcmlhdGUgcGVybWlzc2lvbnMsCiAqIHRoZW4gYWRkaXRpb25hbGx5IGEgYFJvbGVBcm5gIGlzIHJlcXVpcmVkIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0CiAqIHBvbGljeSBmb3IgdGhlIEFtYXpvbiBDb2duaXRvIHJvbGUgdGhhdCB0aGUgdXNlciB3aWxsIGxvZyBpbnRvLiBJZiBhIGBSb2xlQXJuYAogKiBpcyBwcm92aWRlZCwgdGhlbiB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLCBhZnRlciBmaXJzdCBnZXR0aW5nIGFuCiAqIE9wZW4gSUQgdG9rZW4gZnJvbSB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0uCiAqCiAqIEluIGFkZGl0aW9uLCBpZiB0aGlzIGNyZWRlbnRpYWwgcHJvdmlkZXIgaXMgdXNlZCB0byBwcm92aWRlIGF1dGhlbnRpY2F0ZWQKICogbG9naW4sIHRoZSBgTG9naW5zYCBtYXAgbWF5IGJlIHNldCB0byB0aGUgdG9rZW5zIHByb3ZpZGVkIGJ5IHRoZSByZXNwZWN0aXZlCiAqIGlkZW50aXR5IHByb3ZpZGVycy4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogKiBvYmplY3Qgd2l0aCBwcm9wZXIgcHJvcGVydHkgdmFsdWVzLgogKgogKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogKgogKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBXZWJJZGVudGl0eVRva2VuLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICoKICogYGBgamF2YXNjcmlwdAogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5Mb2dpbnNbJ2dyYXBoLmZhY2Vib29rLmNvbSddID0gdXBkYXRlZFRva2VuOwogKiBgYGAKICoKICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogKgogKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWR9LAogKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LCBhbmQKICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAqICAgICBgcGFyYW1zLldlYklkZW50aXR5VG9rZW5gIHByb3BlcnR5LgogKiBAIWF0dHJpYnV0ZSBkYXRhCiAqICAgQHJldHVybiBbbWFwXSB0aGUgcmF3IGRhdGEgcmVzcG9uc2UgZnJvbSB0aGUgY2FsbCB0bwogKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0sIG9yCiAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVXNlIHRoaXMgaWYgeW91IHdhbnQgdG8gZ2V0CiAqICAgICBhY2Nlc3MgdG8gb3RoZXIgcHJvcGVydGllcyBmcm9tIHRoZSByZXNwb25zZS4KICogQCFhdHRyaWJ1dGUgaWRlbnRpdHlJZAogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIENvZ25pdG8gSUQgcmV0dXJuZWQgYnkgdGhlIGxhc3QgY2FsbCB0bwogKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LiBUaGlzIElEIHJlcHJlc2VudHMgdGhlIGFjdHVhbAogKiAgICAgZmluYWwgcmVzb2x2ZWQgaWRlbnRpdHkgSUQgZnJvbSBBbWF6b24gQ29nbml0by4KICovCkFXUy5Db2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9jYWxTdG9yYWdlS2V5OiB7CiAgICBpZDogJ2F3cy5jb2duaXRvLmlkZW50aXR5LWlkLicsCiAgICBwcm92aWRlcnM6ICdhd3MuY29nbml0by5pZGVudGl0eS1wcm92aWRlcnMuJwogIH0sCgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMoewogICAqCiAgICogICAgIC8vIGVpdGhlciBJZGVudGl0eVBvb2xJZCBvciBJZGVudGl0eUlkIGlzIHJlcXVpcmVkCiAgICogICAgIC8vIFNlZSB0aGUgSWRlbnRpdHlQb29sSWQgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SUQgKGxpbmtlZCBiZWxvdykKICAgKiAgICAgLy8gU2VlIHRoZSBJZGVudGl0eUlkIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkKICAgKiAgICAgLy8gb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbiAobGlua2VkIGJlbG93KQogICAqICAgICBJZGVudGl0eVBvb2xJZDogJ3VzLWVhc3QtMToxNjk5ZWJjMC03OTAwLTQwOTktYjkxMC0yZGY5NGY1MmEwMzAnLAogICAqICAgICBJZGVudGl0eUlkOiAndXMtZWFzdC0xOjEyOGQwYTc0LWM4MmYtNDU1My05MTZkLTkwMDUzZTRhOGIwZicKICAgKgogICAqICAgICAvLyBvcHRpb25hbCwgb25seSBuZWNlc3Nhcnkgd2hlbiB0aGUgaWRlbnRpdHkgcG9vbCBpcyBub3QgY29uZmlndXJlZAogICAqICAgICAvLyB0byB1c2UgSUFNIHJvbGVzIGluIHRoZSBBbWF6b24gQ29nbml0byBDb25zb2xlCiAgICogICAgIC8vIFNlZSB0aGUgUm9sZUFybiBwYXJhbSBmb3IgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IChsaW5rZWQgYmVsb3cpCiAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL01ZQVBQLUNvZ25pdG9JZGVudGl0eScsCiAgICoKICAgKiAgICAgLy8gb3B0aW9uYWwgdG9rZW5zLCB1c2VkIGZvciBhdXRoZW50aWNhdGVkIGxvZ2luCiAgICogICAgIC8vIFNlZSB0aGUgTG9naW5zIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldElEIChsaW5rZWQgYmVsb3cpCiAgICogICAgIExvZ2luczogewogICAqICAgICAgICdncmFwaC5mYWNlYm9vay5jb20nOiAnRkJUT0tFTicsCiAgICogICAgICAgJ3d3dy5hbWF6b24uY29tJzogJ0FNQVpPTlRPS0VOJywKICAgKiAgICAgICAnYWNjb3VudHMuZ29vZ2xlLmNvbSc6ICdHT09HTEVUT0tFTicsCiAgICogICAgICAgJ2FwaS50d2l0dGVyLmNvbSc6ICdUV0lUVEVSVE9LRU4nLAogICAqICAgICAgICd3d3cuZGlnaXRzLmNvbSc6ICdESUdJVFNUT0tFTicKICAgKiAgICAgfSwKICAgKgogICAqICAgICAvLyBvcHRpb25hbCBuYW1lLCBkZWZhdWx0cyB0byB3ZWItaWRlbnRpdHkKICAgKiAgICAgLy8gU2VlIHRoZSBSb2xlU2Vzc2lvbk5hbWUgcGFyYW0gZm9yIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSAobGlua2VkIGJlbG93KQogICAqICAgICBSb2xlU2Vzc2lvbk5hbWU6ICd3ZWInLAogICAqCiAgICogICAgIC8vIG9wdGlvbmFsLCBvbmx5IG5lY2Vzc2FyeSB3aGVuIGFwcGxpY2F0aW9uIHJ1bnMgaW4gYSBicm93c2VyCiAgICogICAgIC8vIGFuZCBtdWx0aXBsZSB1c2VycyBhcmUgc2lnbmVkIGluIGF0IG9uY2UsIHVzZWQgZm9yIGNhY2hpbmcKICAgKiAgICAgTG9naW5JZDogJ2V4YW1wbGVAZ21haWwuY29tJwogICAqCiAgICogICB9LCB7CiAgICogICAgICAvLyBvcHRpb25hbGx5IHByb3ZpZGUgY29uZmlndXJhdGlvbiB0byBhcHBseSB0byB0aGUgdW5kZXJseWluZyBzZXJ2aWNlIGNsaWVudHMKICAgKiAgICAgIC8vIGlmIGNvbmZpZ3VyYXRpb24gaXMgbm90IHByb3ZpZGVkLCB0aGVuIGNvbmZpZ3VyYXRpb24gd2lsbCBiZSBwdWxsZWQgZnJvbSBBV1MuY29uZmlnCiAgICoKICAgKiAgICAgIC8vIHJlZ2lvbiBzaG91bGQgbWF0Y2ggdGhlIHJlZ2lvbiB5b3VyIGlkZW50aXR5IHBvb2wgaXMgbG9jYXRlZCBpbgogICAqICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJywKICAgKgogICAqICAgICAgLy8gc3BlY2lmeSB0aW1lb3V0IG9wdGlvbnMKICAgKiAgICAgIGh0dHBPcHRpb25zOiB7CiAgICogICAgICAgIHRpbWVvdXQ6IDEwMAogICAqICAgICAgfQogICAqICAgfSk7CiAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldElkCiAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkKICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eQogICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbgogICAqIEBzZWUgQVdTLkNvbmZpZwogICAqIEBub3RlIElmIGEgcmVnaW9uIGlzIG5vdCBwcm92aWRlZCBpbiB0aGUgZ2xvYmFsIEFXUy5jb25maWcsIG9yCiAgICogICBzcGVjaWZpZWQgaW4gdGhlIGBjbGllbnRDb25maWdgIHRvIHRoZSBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscwogICAqICAgY29uc3RydWN0b3IsIHlvdSBtYXkgZW5jb3VudGVyIGEgJ01pc3NpbmcgY3JlZGVudGlhbHMgaW4gY29uZmlnJyBlcnJvcgogICAqICAgd2hlbiBjYWxsaW5nIG1ha2luZyBhIHNlcnZpY2UgY2FsbC4KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMocGFyYW1zLCBjbGllbnRDb25maWcpIHsKICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgdGhpcy5kYXRhID0gbnVsbDsKICAgIHRoaXMuX2lkZW50aXR5SWQgPSBudWxsOwogICAgdGhpcy5fY2xpZW50Q29uZmlnID0gQVdTLnV0aWwuY29weShjbGllbnRDb25maWcgfHwge30pOwogICAgdGhpcy5sb2FkQ2FjaGVkSWQoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnaWRlbnRpdHlJZCcsIHsKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLmxvYWRDYWNoZWRJZCgpOwogICAgICAgIHJldHVybiBzZWxmLl9pZGVudGl0eUlkIHx8IHNlbGYucGFyYW1zLklkZW50aXR5SWQ7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oaWRlbnRpdHlJZCkgewogICAgICAgIHNlbGYuX2lkZW50aXR5SWQgPSBpZGVudGl0eUlkOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0sCiAgICogb3Ige0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiBAc2VlIEFXUy5DcmVkZW50aWFscy5nZXQKICAgKi8KICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogQHBhcmFtIGNhbGxiYWNrCiAgICovCiAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICBzZWxmLmRhdGEgPSBudWxsOwogICAgc2VsZi5faWRlbnRpdHlJZCA9IG51bGw7CiAgICBzZWxmLmdldElkKGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoIWVycikgewogICAgICAgIGlmICghc2VsZi5wYXJhbXMuUm9sZUFybikgewogICAgICAgICAgc2VsZi5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGNhbGxiYWNrKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5nZXRDcmVkZW50aWFsc0Zyb21TVFMoY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBDbGVhcnMgdGhlIGNhY2hlZCBDb2duaXRvIElEIGFzc29jaWF0ZWQgd2l0aCB0aGUgY3VycmVudGx5IGNvbmZpZ3VyZWQKICAgKiBpZGVudGl0eSBwb29sIElELiBVc2UgdGhpcyB0byBtYW51YWxseSBpbnZhbGlkYXRlIHlvdXIgY2FjaGUgaWYKICAgKiB0aGUgaWRlbnRpdHkgcG9vbCBJRCB3YXMgZGVsZXRlZC4KICAgKi8KICBjbGVhckNhY2hlZElkOiBmdW5jdGlvbiBjbGVhckNhY2hlKCkgewogICAgdGhpcy5faWRlbnRpdHlJZCA9IG51bGw7CiAgICBkZWxldGUgdGhpcy5wYXJhbXMuSWRlbnRpdHlJZDsKCiAgICB2YXIgcG9vbElkID0gdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQ7CiAgICB2YXIgbG9naW5JZCA9IHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJyc7CiAgICBkZWxldGUgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5LmlkICsgcG9vbElkICsgbG9naW5JZF07CiAgICBkZWxldGUgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5LnByb3ZpZGVycyArIHBvb2xJZCArIGxvZ2luSWRdOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQ6IGZ1bmN0aW9uIGNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoZXJyLmNvZGUgPT0gJ05vdEF1dGhvcml6ZWRFeGNlcHRpb24nKSB7CiAgICAgIHNlbGYuY2xlYXJDYWNoZWRJZCgpOwogICAgfQogIH0sCgogIC8qKgogICAqIFJldHJpZXZlcyBhIENvZ25pdG8gSUQsIGxvYWRpbmcgZnJvbSBjYWNoZSBpZiBpdCB3YXMgYWxyZWFkeSByZXRyaWV2ZWQKICAgKiBvbiB0aGlzIGRldmljZS4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGlkZW50aXR5SWQpCiAgICogICBAcGFyYW0gZXJyIFtFcnJvciwgbnVsbF0gYW4gZXJyb3Igb2JqZWN0IGlmIHRoZSBjYWxsIGZhaWxlZCBvciBudWxsIGlmCiAgICogICAgIGl0IHN1Y2NlZWRlZC4KICAgKiAgIEBwYXJhbSBpZGVudGl0eUlkIFtTdHJpbmcsIG51bGxdIGlmIHN1Y2Nlc3NmdWwsIHRoZSBjYWxsYmFjayB3aWxsIHJldHVybgogICAqICAgICB0aGUgQ29nbml0byBJRC4KICAgKiBAbm90ZSBJZiBub3QgbG9hZGVkIGV4cGxpY2l0bHksIHRoZSBDb2duaXRvIElEIGlzIGxvYWRlZCBhbmQgc3RvcmVkIGluCiAgICogICBsb2NhbFN0b3JhZ2UgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb2YgYSBkZXZpY2UuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0SWQ6IGZ1bmN0aW9uIGdldElkKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAodHlwZW9mIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBzZWxmLnBhcmFtcy5JZGVudGl0eUlkKTsKICAgIH0KCiAgICBzZWxmLmNvZ25pdG8uZ2V0SWQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgIGlmICghZXJyICYmIGRhdGEuSWRlbnRpdHlJZCkgewogICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBkYXRhLklkZW50aXR5SWQ7CiAgICAgICAgY2FsbGJhY2sobnVsbCwgZGF0YS5JZGVudGl0eUlkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9CiAgICB9KTsKICB9LAoKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZENyZWRlbnRpYWxzOiBmdW5jdGlvbiBsb2FkQ3JlZGVudGlhbHMoZGF0YSwgY3JlZGVudGlhbHMpIHsKICAgIGlmICghZGF0YSB8fCAhY3JlZGVudGlhbHMpIHJldHVybjsKICAgIGNyZWRlbnRpYWxzLmV4cGlyZWQgPSBmYWxzZTsKICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkID0gZGF0YS5DcmVkZW50aWFscy5BY2Nlc3NLZXlJZDsKICAgIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSA9IGRhdGEuQ3JlZGVudGlhbHMuU2VjcmV0S2V5OwogICAgY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID0gZGF0YS5DcmVkZW50aWFscy5TZXNzaW9uVG9rZW47CiAgICBjcmVkZW50aWFscy5leHBpcmVUaW1lID0gZGF0YS5DcmVkZW50aWFscy5FeHBpcmF0aW9uOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHk6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY29nbml0by5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICBpZiAoIWVycikgewogICAgICAgIHNlbGYuY2FjaGVJZChkYXRhKTsKICAgICAgICBzZWxmLmRhdGEgPSBkYXRhOwogICAgICAgIHNlbGYubG9hZENyZWRlbnRpYWxzKHNlbGYuZGF0YSwgc2VsZik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgIH0KICAgICAgY2FsbGJhY2soZXJyKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldENyZWRlbnRpYWxzRnJvbVNUUzogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGcm9tU1RTKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNvZ25pdG8uZ2V0T3BlbklkVG9rZW4oZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgIGlmICghZXJyKSB7CiAgICAgICAgc2VsZi5jYWNoZUlkKGRhdGEpOwogICAgICAgIHNlbGYucGFyYW1zLldlYklkZW50aXR5VG9rZW4gPSBkYXRhLlRva2VuOwogICAgICAgIHNlbGYud2ViSWRlbnRpdHlDcmVkZW50aWFscy5yZWZyZXNoKGZ1bmN0aW9uKHdlYkVycikgewogICAgICAgICAgaWYgKCF3ZWJFcnIpIHsKICAgICAgICAgICAgc2VsZi5kYXRhID0gc2VsZi53ZWJJZGVudGl0eUNyZWRlbnRpYWxzLmRhdGE7CiAgICAgICAgICAgIHNlbGYuc3RzLmNyZWRlbnRpYWxzRnJvbShzZWxmLmRhdGEsIHNlbGYpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2sod2ViRXJyKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkQ2FjaGVkSWQ6IGZ1bmN0aW9uIGxvYWRDYWNoZWRJZCgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBpbiB0aGUgYnJvd3NlciB3ZSBzb3VyY2UgZGVmYXVsdCBJZGVudGl0eUlkIGZyb20gbG9jYWxTdG9yYWdlCiAgICBpZiAoQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgIXNlbGYucGFyYW1zLklkZW50aXR5SWQpIHsKICAgICAgdmFyIGlkID0gc2VsZi5nZXRTdG9yYWdlKCdpZCcpOwogICAgICBpZiAoaWQgJiYgc2VsZi5wYXJhbXMuTG9naW5zKSB7CiAgICAgICAgdmFyIGFjdHVhbFByb3ZpZGVycyA9IE9iamVjdC5rZXlzKHNlbGYucGFyYW1zLkxvZ2lucyk7CiAgICAgICAgdmFyIGNhY2hlZFByb3ZpZGVycyA9CiAgICAgICAgICAoc2VsZi5nZXRTdG9yYWdlKCdwcm92aWRlcnMnKSB8fCAnJykuc3BsaXQoJywnKTsKCiAgICAgICAgLy8gb25seSBsb2FkIElEIGlmIGF0IGxlYXN0IG9uZSBwcm92aWRlciB1c2VkIHRoaXMgSUQgYmVmb3JlCiAgICAgICAgdmFyIGludGVyc2VjdCA9IGNhY2hlZFByb3ZpZGVycy5maWx0ZXIoZnVuY3Rpb24obikgewogICAgICAgICAgcmV0dXJuIGFjdHVhbFByb3ZpZGVycy5pbmRleE9mKG4pICE9PSAtMTsKICAgICAgICB9KTsKICAgICAgICBpZiAoaW50ZXJzZWN0Lmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGlkOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpZCkgewogICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBpZDsKICAgICAgfQogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNsaWVudENvbmZpZyA9IHRoaXMuX2NsaWVudENvbmZpZzsKICAgIHRoaXMud2ViSWRlbnRpdHlDcmVkZW50aWFscyA9IHRoaXMud2ViSWRlbnRpdHlDcmVkZW50aWFscyB8fAogICAgICBuZXcgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHModGhpcy5wYXJhbXMsIGNsaWVudENvbmZpZyk7CiAgICBpZiAoIXRoaXMuY29nbml0bykgewogICAgICB2YXIgY29nbml0b0NvbmZpZyA9IEFXUy51dGlsLm1lcmdlKHt9LCBjbGllbnRDb25maWcpOwogICAgICBjb2duaXRvQ29uZmlnLnBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgICB0aGlzLmNvZ25pdG8gPSBuZXcgQ29nbml0b0lkZW50aXR5KGNvZ25pdG9Db25maWcpOwogICAgfQogICAgdGhpcy5zdHMgPSB0aGlzLnN0cyB8fCBuZXcgU1RTKGNsaWVudENvbmZpZyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY2FjaGVJZDogZnVuY3Rpb24gY2FjaGVJZChkYXRhKSB7CiAgICB0aGlzLl9pZGVudGl0eUlkID0gZGF0YS5JZGVudGl0eUlkOwogICAgdGhpcy5wYXJhbXMuSWRlbnRpdHlJZCA9IHRoaXMuX2lkZW50aXR5SWQ7CgogICAgLy8gY2FjaGUgdGhpcyBJZGVudGl0eUlkIGluIGJyb3dzZXIgbG9jYWxTdG9yYWdlIGlmIHBvc3NpYmxlCiAgICBpZiAoQVdTLnV0aWwuaXNCcm93c2VyKCkpIHsKICAgICAgdGhpcy5zZXRTdG9yYWdlKCdpZCcsIGRhdGEuSWRlbnRpdHlJZCk7CgogICAgICBpZiAodGhpcy5wYXJhbXMuTG9naW5zKSB7CiAgICAgICAgdGhpcy5zZXRTdG9yYWdlKCdwcm92aWRlcnMnLCBPYmplY3Qua2V5cyh0aGlzLnBhcmFtcy5Mb2dpbnMpLmpvaW4oJywnKSk7CiAgICAgIH0KICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRTdG9yYWdlOiBmdW5jdGlvbiBnZXRTdG9yYWdlKGtleSkgewogICAgcmV0dXJuIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleVtrZXldICsgdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQgKyAodGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJyldOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNldFN0b3JhZ2U6IGZ1bmN0aW9uIHNldFN0b3JhZ2Uoa2V5LCB2YWwpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleVtrZXldICsgdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQgKyAodGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJyldID0gdmFsOwogICAgfSBjYXRjaCAoXykge30KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzdG9yYWdlOiAoZnVuY3Rpb24oKSB7CiAgICB0cnkgewogICAgICB2YXIgc3RvcmFnZSA9IEFXUy51dGlsLmlzQnJvd3NlcigpICYmIHdpbmRvdy5sb2NhbFN0b3JhZ2UgIT09IG51bGwgJiYgdHlwZW9mIHdpbmRvdy5sb2NhbFN0b3JhZ2UgPT09ICdvYmplY3QnID8KICAgICAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2UgOiB7fTsKCiAgICAgIC8vIFRlc3Qgc2V0L3JlbW92ZSB3aGljaCB3b3VsZCB0aHJvdyBhbiBlcnJvciBpbiBTYWZhcmkncyBwcml2YXRlIGJyb3dzaW5nCiAgICAgIHN0b3JhZ2VbJ2F3cy50ZXN0LXN0b3JhZ2UnXSA9ICdmb29iYXInOwogICAgICBkZWxldGUgc3RvcmFnZVsnYXdzLnRlc3Qtc3RvcmFnZSddOwoKICAgICAgcmV0dXJuIHN0b3JhZ2U7CiAgICB9IGNhdGNoIChfKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0KICB9KSgpCn0pOwoKfSx7Ii4uLy4uL2NsaWVudHMvY29nbml0b2lkZW50aXR5Ijo3LCIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTl9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CgovKioKICogQ3JlYXRlcyBhIGNyZWRlbnRpYWwgcHJvdmlkZXIgY2hhaW4gdGhhdCBzZWFyY2hlcyBmb3IgQVdTIGNyZWRlbnRpYWxzCiAqIGluIGEgbGlzdCBvZiBjcmVkZW50aWFsIHByb3ZpZGVycyBzcGVjaWZpZWQgYnkgdGhlIHtwcm92aWRlcnN9IHByb3BlcnR5LgogKgogKiBCeSBkZWZhdWx0LCB0aGUgY2hhaW4gd2lsbCB1c2UgdGhlIHtkZWZhdWx0UHJvdmlkZXJzfSB0byByZXNvbHZlIGNyZWRlbnRpYWxzLgogKiBUaGVzZSBwcm92aWRlcnMgd2lsbCBsb29rIGluIHRoZSBlbnZpcm9ubWVudCB1c2luZyB0aGUKICoge0FXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzfSBjbGFzcyB3aXRoIHRoZSAnQVdTJyBhbmQgJ0FNQVpPTicgcHJlZml4ZXMuCiAqCiAqICMjIFNldHRpbmcgUHJvdmlkZXJzCiAqCiAqIEVhY2ggcHJvdmlkZXIgaW4gdGhlIHtwcm92aWRlcnN9IGxpc3Qgc2hvdWxkIGJlIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAqIGEge0FXUy5DcmVkZW50aWFsc30gb2JqZWN0LCBvciBhIGhhcmRjb2RlZCBjcmVkZW50aWFscyBvYmplY3QuIFRoZSBmdW5jdGlvbgogKiBmb3JtIGFsbG93cyBmb3IgZGVsYXllZCBleGVjdXRpb24gb2YgdGhlIGNyZWRlbnRpYWwgY29uc3RydWN0aW9uLgogKgogKiAjIyBSZXNvbHZpbmcgQ3JlZGVudGlhbHMgZnJvbSBhIENoYWluCiAqCiAqIENhbGwge3Jlc29sdmV9IHRvIHJldHVybiB0aGUgZmlyc3QgdmFsaWQgY3JlZGVudGlhbCBvYmplY3QgdGhhdCBjYW4gYmUKICogbG9hZGVkIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICoKICogRm9yIGV4YW1wbGUsIHRvIHJlc29sdmUgYSBjaGFpbiB3aXRoIGEgY3VzdG9tIHByb3ZpZGVyIHRoYXQgY2hlY2tzIGEgZmlsZQogKiBvbiBkaXNrIGFmdGVyIHRoZSBzZXQgb2Yge2RlZmF1bHRQcm92aWRlcnN9OgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIHZhciBkaXNrUHJvdmlkZXIgPSBuZXcgQVdTLkZpbGVTeXN0ZW1DcmVkZW50aWFscygnLi9jcmVkcy5qc29uJyk7CiAqIHZhciBjaGFpbiA9IG5ldyBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4oKTsKICogY2hhaW4ucHJvdmlkZXJzLnB1c2goZGlza1Byb3ZpZGVyKTsKICogY2hhaW4ucmVzb2x2ZSgpOwogKiBgYGAKICoKICogVGhlIGFib3ZlIGNvZGUgd2lsbCByZXR1cm4gdGhlIGBkaXNrUHJvdmlkZXJgIG9iamVjdCBpZiB0aGUKICogZmlsZSBjb250YWlucyBjcmVkZW50aWFscyBhbmQgdGhlIGBkZWZhdWx0UHJvdmlkZXJzYCBkbyBub3QgY29udGFpbgogKiBhbnkgY3JlZGVudGlhbCBzZXR0aW5ncy4KICoKICogQCFhdHRyaWJ1dGUgcHJvdmlkZXJzCiAqICAgQHJldHVybiBbQXJyYXk8QVdTLkNyZWRlbnRpYWxzLCBGdW5jdGlvbj5dCiAqICAgICBhIGxpc3Qgb2YgY3JlZGVudGlhbHMgb2JqZWN0cyBvciBmdW5jdGlvbnMgdGhhdCByZXR1cm4gY3JlZGVudGlhbHMKICogICAgIG9iamVjdHMuIElmIHRoZSBwcm92aWRlciBpcyBhIGZ1bmN0aW9uLCB0aGUgZnVuY3Rpb24gd2lsbCBiZQogKiAgICAgZXhlY3V0ZWQgbGF6aWx5IHdoZW4gdGhlIHByb3ZpZGVyIG5lZWRzIHRvIGJlIGNoZWNrZWQgZm9yIHZhbGlkCiAqICAgICBjcmVkZW50aWFscy4gQnkgZGVmYXVsdCwgdGhpcyBvYmplY3Qgd2lsbCBiZSBzZXQgdG8gdGhlCiAqICAgICB7ZGVmYXVsdFByb3ZpZGVyc30uCiAqICAgQHNlZSBkZWZhdWx0UHJvdmlkZXJzCiAqLwpBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IENyZWRlbnRpYWxQcm92aWRlckNoYWluIHdpdGggYSBkZWZhdWx0IHNldCBvZiBwcm92aWRlcnMKICAgKiBzcGVjaWZpZWQgYnkge2RlZmF1bHRQcm92aWRlcnN9LgogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbihwcm92aWRlcnMpIHsKICAgIGlmIChwcm92aWRlcnMpIHsKICAgICAgdGhpcy5wcm92aWRlcnMgPSBwcm92aWRlcnM7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnByb3ZpZGVycyA9IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzLnNsaWNlKDApOwogICAgfQogICAgdGhpcy5yZXNvbHZlQ2FsbGJhY2tzID0gW107CiAgfSwKCiAgLyoqCiAgICogQCFtZXRob2QgIHJlc29sdmVQcm9taXNlKCkKICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICogICBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICogICBjcmVkZW50aWFscyBpbiB7cHJvdmlkZXJzfS4KICAgKgogICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oY3JlZGVudGlhbHMpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQgYW5kIHRoZSBwcm92aWRlciByZXNvbHZlcyB0aGUgY2hhaW4KICAgKiAgICAgdG8gYSBjcmVkZW50aWFscyBvYmplY3QKICAgKiAgICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBjcmVkZW50aWFscyBvYmplY3QgcmVzb2x2ZWQKICAgKiAgICAgICBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnJvcikKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBpZiBubyBjcmVkZW50aWFscyBhcmUgZm91bmQuCiAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYHJlc29sdmVgIG1ldGhvZCBjYWxsLgogICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYHJlc29sdmVQcm9taXNlYCBtZXRob2QuCiAgICogICAgIHZhciBwcm9taXNlID0gY2hhaW4ucmVzb2x2ZVByb21pc2UoKTsKICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGNyZWRlbnRpYWxzKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAqLwoKICAvKioKICAgKiBSZXNvbHZlcyB0aGUgcHJvdmlkZXIgY2hhaW4gYnkgc2VhcmNoaW5nIGZvciB0aGUgZmlyc3Qgc2V0IG9mCiAgICogY3JlZGVudGlhbHMgaW4ge3Byb3ZpZGVyc30uCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBjcmVkZW50aWFscykKICAgKiAgIENhbGxlZCB3aGVuIHRoZSBwcm92aWRlciByZXNvbHZlcyB0aGUgY2hhaW4gdG8gYSBjcmVkZW50aWFscyBvYmplY3QKICAgKiAgIG9yIG51bGwgaWYgbm8gY3JlZGVudGlhbHMgY2FuIGJlIGZvdW5kLgogICAqCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBpZiBubyBjcmVkZW50aWFscyBhcmUKICAgKiAgICAgZm91bmQuCiAgICogICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCByZXNvbHZlZAogICAqICAgICBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICogQHJldHVybiBbQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXSB0aGUgcHJvdmlkZXIsIGZvciBjaGFpbmluZy4KICAgKi8KICByZXNvbHZlOiBmdW5jdGlvbiByZXNvbHZlKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoc2VsZi5wcm92aWRlcnMubGVuZ3RoID09PSAwKSB7CiAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignTm8gcHJvdmlkZXJzJykpOwogICAgICByZXR1cm4gc2VsZjsKICAgIH0KCiAgICBpZiAoc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spID09PSAxKSB7CiAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgIHZhciBwcm92aWRlcnMgPSBzZWxmLnByb3ZpZGVycy5zbGljZSgwKTsKCiAgICAgIGZ1bmN0aW9uIHJlc29sdmVOZXh0KGVyciwgY3JlZHMpIHsKICAgICAgICBpZiAoKCFlcnIgJiYgY3JlZHMpIHx8IGluZGV4ID09PSBwcm92aWRlcnMubGVuZ3RoKSB7CiAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLCBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgY2FsbGJhY2soZXJyLCBjcmVkcyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHNlbGYucmVzb2x2ZUNhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHByb3ZpZGVyID0gcHJvdmlkZXJzW2luZGV4KytdOwogICAgICAgIGlmICh0eXBlb2YgcHJvdmlkZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGNyZWRzID0gcHJvdmlkZXIuY2FsbCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjcmVkcyA9IHByb3ZpZGVyOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNyZWRzLmdldCkgewogICAgICAgICAgY3JlZHMuZ2V0KGZ1bmN0aW9uIChnZXRFcnIpIHsKICAgICAgICAgICAgcmVzb2x2ZU5leHQoZ2V0RXJyLCBnZXRFcnIgPyBudWxsIDogY3JlZHMpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc29sdmVOZXh0KG51bGwsIGNyZWRzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlc29sdmVOZXh0KCk7CiAgICB9CgogICAgcmV0dXJuIHNlbGY7CiAgfQp9KTsKCi8qKgogKiBUaGUgZGVmYXVsdCBzZXQgb2YgcHJvdmlkZXJzIHVzZWQgYnkgYSB2YW5pbGxhIENyZWRlbnRpYWxQcm92aWRlckNoYWluLgogKgogKiBJbiB0aGUgYnJvd3NlcjoKICoKICogYGBgamF2YXNjcmlwdAogKiBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFtdCiAqIGBgYAogKgogKiBJbiBOb2RlLmpzOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gWwogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7IH0sCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBTUFaT04nKTsgfSwKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlNzb0NyZWRlbnRpYWxzKCk7IH0sCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5TaGFyZWRJbmlGaWxlQ3JlZGVudGlhbHMoKTsgfSwKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVDU0NyZWRlbnRpYWxzKCk7IH0sCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5Qcm9jZXNzQ3JlZGVudGlhbHMoKTsgfSwKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlRva2VuRmlsZVdlYklkZW50aXR5Q3JlZGVudGlhbHMoKTsgfSwKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVDMk1ldGFkYXRhQ3JlZGVudGlhbHMoKSB9CiAqIF0KICogYGBgCiAqLwpBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFtdOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogIHRoaXMucHJvdG90eXBlLnJlc29sdmVQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdyZXNvbHZlJywgUHJvbWlzZURlcGVuZGVuY3kpOwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnJlc29sdmVQcm9taXNlOwp9OwoKQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKTsKCn0seyIuLi9jb3JlIjoxOX1dLDI0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CgovKioKICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgU0FNTCBzdXBwb3J0LgogKgogKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfSBzZXJ2aWNlIG9wZXJhdGlvbi4gVGhpcyBvcGVyYXRpb24KICogcmVxdWlyZXMgYSBgUm9sZUFybmAgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QgcG9saWN5IGZvciB0aGUKICogYXBwbGljYXRpb24gZm9yIHdoaWNoIGNyZWRlbnRpYWxzIHdpbGwgYmUgZ2l2ZW4sIGFzIHdlbGwgYXMgYSBgUHJpbmNpcGFsQXJuYAogKiByZXByZXNlbnRpbmcgdGhlIEFSTiBmb3IgdGhlIFNBTUwgaWRlbnRpdHkgcHJvdmlkZXIuIEluIGFkZGl0aW9uLCB0aGUKICogYFNBTUxBc3NlcnRpb25gIG11c3QgYmUgc2V0IHRvIHRoZSB0b2tlbiBwcm92aWRlZCBieSB0aGUgaWRlbnRpdHkKICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICogb2JqZWN0IHdpdGggcHJvcGVyIGBSb2xlQXJuYCwgYFByaW5jaXBhbEFybmAsIGFuZCBgU0FNTEFzc2VydGlvbmAgdmFsdWVzLgogKgogKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogKgogKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBTQU1MQXNzZXJ0aW9uLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICoKICogYGBgamF2YXNjcmlwdAogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5TQU1MQXNzZXJ0aW9uID0gdXBkYXRlZFRva2VuOwogKiBgYGAKICoKICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogKgogKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogKiAgICAgYHBhcmFtcy5TQU1MQXNzZXJ0aW9uYCBwcm9wZXJ0eS4KICovCkFXUy5TQU1MQ3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAqIEBwYXJhbSAoc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MKQogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuU0FNTENyZWRlbnRpYWxzKHsKICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFJvbGUnLAogICAqICAgICBQcmluY2lwYWxBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1NBTUxQcmluY2lwYWwnLAogICAqICAgICBTQU1MQXNzZXJ0aW9uOiAnYmFzZTY0LXRva2VuJywgLy8gYmFzZTY0LWVuY29kZWQgdG9rZW4gZnJvbSBJZFAKICAgKiAgIH0pOwogICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUwKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU0FNTENyZWRlbnRpYWxzKHBhcmFtcykgewogICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgfSwKCiAgLyoqCiAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqIEBzZWUgZ2V0CiAgICovCiAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGVXaXRoU0FNTChmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgIGlmICghZXJyKSB7CiAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgfQogICAgICBjYWxsYmFjayhlcnIpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnNlcnZpY2UgPSB0aGlzLnNlcnZpY2UgfHwgbmV3IFNUUyh7cGFyYW1zOiB0aGlzLnBhcmFtc30pOwogIH0KCn0pOwoKfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOX1dLDI1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CgovKioKICogUmVwcmVzZW50cyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20ge0FXUy5TVFN9LiBXaXRob3V0IGFueQogKiBleHRyYSBwYXJhbWV0ZXJzLCBjcmVkZW50aWFscyB3aWxsIGJlIGZldGNoZWQgZnJvbSB0aGUKICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb24uIElmIGFuIElBTSByb2xlIGlzIHByb3ZpZGVkLCB0aGUKICoge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3BlcmF0aW9uIHdpbGwgYmUgdXNlZCB0byBmZXRjaCBjcmVkZW50aWFscyBmb3IgdGhlCiAqIHJvbGUgaW5zdGVhZC4KICoKICogQG5vdGUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGlzIGRlcHJlY2F0ZWQsIGJ1dCByZW1haW5zIGF2YWlsYWJsZSBmb3IKICogICBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4ge0FXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsc30gaXMgdGhlCiAqICAgcHJlZmVycmVkIGNsYXNzIGZvciB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAqCiAqIFRvIHNldHVwIHRlbXBvcmFyeSBjcmVkZW50aWFscywgY29uZmlndXJlIGEgc2V0IG9mIG1hc3RlciBjcmVkZW50aWFscwogKiB1c2luZyB0aGUgc3RhbmRhcmQgY3JlZGVudGlhbHMgcHJvdmlkZXJzIChlbnZpcm9ubWVudCwgRUMyIGluc3RhbmNlIG1ldGFkYXRhLAogKiBvciBmcm9tIHRoZSBmaWxlc3lzdGVtKSwgdGhlbiBzZXQgdGhlIGdsb2JhbCBjcmVkZW50aWFscyB0byBhIG5ldwogKiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0OgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIC8vIE5vdGUgdGhhdCBlbnZpcm9ubWVudCBjcmVkZW50aWFscyBhcmUgbG9hZGVkIGJ5IGRlZmF1bHQsCiAqIC8vIHRoZSBmb2xsb3dpbmcgbGluZSBpcyBzaG93biBmb3IgY2xhcml0eToKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7CiAqCiAqIC8vIE5vdyBzZXQgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHNlZWRlZCBmcm9tIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICoKICogLy8gc3Vic2VxdWVudCByZXF1ZXN0cyB3aWxsIG5vdyB1c2UgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICogbmV3IEFXUy5TMygpLmxpc3RCdWNrZXQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICogYGBgCiAqCiAqIEAhYXR0cmlidXRlIG1hc3RlckNyZWRlbnRpYWxzCiAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIChub24tdGVtcG9yYXJ5KSBjcmVkZW50aWFscyB1c2VkIHRvCiAqICAgICBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICogQG5vdGUgKHNlZSBjb25zdHJ1Y3RvcikKICovCkFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0LgogICAqCiAgICogQG5vdGUgSW4gb3JkZXIgdG8gY3JlYXRlIHRlbXBvcmFyeSBjcmVkZW50aWFscywgeW91IGZpcnN0IG5lZWQgdG8gaGF2ZQogICAqICAgIm1hc3RlciIgY3JlZGVudGlhbHMgY29uZmlndXJlZCBpbiB7QVdTLkNvbmZpZy5jcmVkZW50aWFsc30uIFRoZXNlCiAgICogICBtYXN0ZXIgY3JlZGVudGlhbHMgYXJlIG5lY2Vzc2FyeSB0byByZXRyaWV2ZSB0aGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLAogICAqICAgYXMgd2VsbCBhcyByZWZyZXNoIHRoZSBjcmVkZW50aWFscyB3aGVuIHRoZXkgZXhwaXJlLgogICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2Ygb3B0aW9ucyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhlCiAgICogICB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvciB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbnMuCiAgICogICBJZiBhIGBSb2xlQXJuYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCBjcmVkZW50aWFscyB3aWxsIGJlIGJhc2VkIG9uIHRoZQogICAqICAgSUFNIHJvbGUuCiAgICogQHBhcmFtIG1hc3RlckNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgKG5vbi10ZW1wb3JhcnkpIGNyZWRlbnRpYWxzCiAgICogIHVzZWQgdG8gZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBnZW5lcmljIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGFuIElBTSByb2xlCiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1RlbXBvcmFyeUNyZWRlbnRpYWxzJywKICAgKiAgIH0pOwogICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlCiAgICogQHNlZSBBV1MuU1RTLmdldFNlc3Npb25Ub2tlbgogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBUZW1wb3JhcnlDcmVkZW50aWFscyhwYXJhbXMsIG1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgIHRoaXMubG9hZE1hc3RlckNyZWRlbnRpYWxzKG1hc3RlckNyZWRlbnRpYWxzKTsKICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CgogICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICBpZiAodGhpcy5wYXJhbXMuUm9sZUFybikgewogICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPQogICAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAndGVtcG9yYXJ5LWNyZWRlbnRpYWxzJzsKICAgIH0KICB9LAoKICAvKioKICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3IKICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59LCBkZXBlbmRpbmcgb24gd2hldGhlciBhbiBJQU0gcm9sZSBBUk4gd2FzIHBhc3NlZAogICAqIHRvIHRoZSBjcmVkZW50aWFscyB7Y29uc3RydWN0b3J9LgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogQHNlZSBnZXQKICAgKi8KICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoIChjYWxsYmFjaykgewogICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWQ6IGZ1bmN0aW9uIGxvYWQgKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgIHNlbGYubWFzdGVyQ3JlZGVudGlhbHMuZ2V0KGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscyA9IHNlbGYubWFzdGVyQ3JlZGVudGlhbHM7CiAgICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnBhcmFtcy5Sb2xlQXJuID8KICAgICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZSA6IHNlbGYuc2VydmljZS5nZXRTZXNzaW9uVG9rZW47CiAgICAgIG9wZXJhdGlvbi5jYWxsKHNlbGYuc2VydmljZSwgZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWRNYXN0ZXJDcmVkZW50aWFsczogZnVuY3Rpb24gbG9hZE1hc3RlckNyZWRlbnRpYWxzIChtYXN0ZXJDcmVkZW50aWFscykgewogICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IG1hc3RlckNyZWRlbnRpYWxzIHx8IEFXUy5jb25maWcuY3JlZGVudGlhbHM7CiAgICB3aGlsZSAodGhpcy5tYXN0ZXJDcmVkZW50aWFscy5tYXN0ZXJDcmVkZW50aWFscykgewogICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gdGhpcy5tYXN0ZXJDcmVkZW50aWFscy5tYXN0ZXJDcmVkZW50aWFsczsKICAgIH0KCiAgICBpZiAodHlwZW9mIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMuZ2V0ICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHRoaXMubWFzdGVyQ3JlZGVudGlhbHMpOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc2VydmljZSA9IHRoaXMuc2VydmljZSB8fCBuZXcgU1RTKHtwYXJhbXM6IHRoaXMucGFyYW1zfSk7CiAgfQoKfSk7Cgp9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE5fV0sMjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKCi8qKgogKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBXZWIgSWRlbnRpdHkgRmVkZXJhdGlvbiBzdXBwb3J0LgogKgogKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24uIFRoaXMgb3BlcmF0aW9uCiAqIHJlcXVpcmVzIGEgYFJvbGVBcm5gIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0IHBvbGljeSBmb3IgdGhlCiAqIGFwcGxpY2F0aW9uIGZvciB3aGljaCBjcmVkZW50aWFscyB3aWxsIGJlIGdpdmVuLiBJbiBhZGRpdGlvbiwgdGhlCiAqIGBXZWJJZGVudGl0eVRva2VuYCBtdXN0IGJlIHNldCB0byB0aGUgdG9rZW4gcHJvdmlkZWQgYnkgdGhlIGlkZW50aXR5CiAqIHByb3ZpZGVyLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAqIG9iamVjdCB3aXRoIHByb3BlciBgUm9sZUFybmAgYW5kIGBXZWJJZGVudGl0eVRva2VuYCB2YWx1ZXMuCiAqCiAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAqCiAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFdlYklkZW50aXR5VG9rZW4sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLldlYklkZW50aXR5VG9rZW4gPSB1cGRhdGVkVG9rZW47CiAqIGBgYAogKgogKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAqCiAqIEAhYXR0cmlidXRlIHBhcmFtcwogKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogKiAgICAgYHBhcmFtcy5XZWJJZGVudGl0eVRva2VuYCBwcm9wZXJ0eS4KICogQCFhdHRyaWJ1dGUgZGF0YQogKiAgIEByZXR1cm4gW21hcF0gdGhlIHJhdyBkYXRhIHJlc3BvbnNlIGZyb20gdGhlIGNhbGwgdG8KICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBVc2UgdGhpcyBpZiB5b3Ugd2FudCB0byBnZXQKICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogKi8KQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAqIEBwYXJhbSAoc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSkKICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHMoewogICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9XZWJJZGVudGl0eScsCiAgICogICAgIFdlYklkZW50aXR5VG9rZW46ICdBQkNERUZHSElKS0xNTk9QJywgLy8gdG9rZW4gZnJvbSBpZGVudGl0eSBzZXJ2aWNlCiAgICogICAgIFJvbGVTZXNzaW9uTmFtZTogJ3dlYicgLy8gb3B0aW9uYWwgbmFtZSwgZGVmYXVsdHMgdG8gd2ViLWlkZW50aXR5CiAgICogICB9LCB7CiAgICogICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIEFXUy5TVFMgc2VydmljZSBjbGllbnQKICAgKiAgICAgLy8gaWYgY29uZmlndXJhdGlvbiBpcyBub3QgcHJvdmlkZWQsIHRoZW4gY29uZmlndXJhdGlvbiB3aWxsIGJlIHB1bGxlZCBmcm9tIEFXUy5jb25maWcKICAgKgogICAqICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAqICAgICBodHRwT3B0aW9uczogewogICAqICAgICAgIHRpbWVvdXQ6IDEwMAogICAqICAgICB9CiAgICogICB9KTsKICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eQogICAqIEBzZWUgQVdTLkNvbmZpZwogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBXZWJJZGVudGl0eUNyZWRlbnRpYWxzKHBhcmFtcywgY2xpZW50Q29uZmlnKSB7CiAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9IHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAnd2ViLWlkZW50aXR5JzsKICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICB0aGlzLl9jbGllbnRDb25maWcgPSBBV1MudXRpbC5jb3B5KGNsaWVudENvbmZpZyB8fCB7fSk7CiAgfSwKCiAgLyoqCiAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9CiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiBAc2VlIGdldAogICAqLwogIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgc2VsZi5kYXRhID0gbnVsbDsKICAgICAgaWYgKCFlcnIpIHsKICAgICAgICBzZWxmLmRhdGEgPSBkYXRhOwogICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgIH0KICAgICAgY2FsbGJhY2soZXJyKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLnNlcnZpY2UpIHsKICAgICAgdmFyIHN0c0NvbmZpZyA9IEFXUy51dGlsLm1lcmdlKHt9LCB0aGlzLl9jbGllbnRDb25maWcpOwogICAgICBzdHNDb25maWcucGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICAgIHRoaXMuc2VydmljZSA9IG5ldyBTVFMoc3RzQ29uZmlnKTsKICAgIH0KICB9Cgp9KTsKCn0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTl9XSwyNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CnZhciBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzID0gWydBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWScsICdBV1NfRU5EUE9JTlRfRElTQ09WRVJZX0VOQUJMRUQnXTsKCi8qKgogKiBHZW5lcmF0ZSBrZXkgKGV4Y2VwdCByZXNvdXJjZXMgYW5kIG9wZXJhdGlvbiBwYXJ0KSB0byBpbmRleCB0aGUgZW5kcG9pbnRzIGluIHRoZSBjYWNoZQogKiBJZiBpbnB1dCBzaGFwZSBoYXMgZW5kcG9pbnRkaXNjb3ZlcnlpZCB0cmFpdCB0aGVuIHVzZQogKiAgIGFjY2Vzc0tleSArIG9wZXJhdGlvbiArIHJlc291cmNlcyArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAqIElmIGlucHV0IHNoYXBlIGRvZXNuJ3QgaGF2ZSBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAqICAgYWNjZXNzS2V5ICsgcmVnaW9uICsgc2VydmljZSBhcyBjYWNoZSBrZXkKICogQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XSBvYmplY3Qgd2l0aCBrZXlzIHRvIGluZGV4IGVuZHBvaW50cy4KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBnZXRDYWNoZUtleShyZXF1ZXN0KSB7CiAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpIHx8IHt9OwogIHZhciBvcGVyYXRpb25zID0gYXBpLm9wZXJhdGlvbnM7CiAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgaWYgKHNlcnZpY2UuY29uZmlnLnJlZ2lvbikgewogICAgaWRlbnRpZmllcnMucmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogIH0KICBpZiAoYXBpLnNlcnZpY2VJZCkgewogICAgaWRlbnRpZmllcnMuc2VydmljZUlkID0gYXBpLnNlcnZpY2VJZDsKICB9CiAgaWYgKHNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkKSB7CiAgICBpZGVudGlmaWVycy5hY2Nlc3NLZXlJZCA9IHNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogIH0KICByZXR1cm4gaWRlbnRpZmllcnM7Cn0KCi8qKgogKiBSZWN1cnNpdmUgaGVscGVyIGZvciBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKCkuCiAqIExvb2tzIGZvciByZXF1aXJlZCBzdHJpbmcgaW5wdXQgbWVtYmVycyB0aGF0IGhhdmUgJ2VuZHBvaW50ZGlzY292ZXJ5aWQnIHRyYWl0LgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXMsIHNoYXBlKSB7CiAgaWYgKCFzaGFwZSB8fCBwYXJhbXMgPT09IHVuZGVmaW5lZCB8fCBwYXJhbXMgPT09IG51bGwpIHJldHVybjsKICBpZiAoc2hhcGUudHlwZSA9PT0gJ3N0cnVjdHVyZScgJiYgc2hhcGUucmVxdWlyZWQgJiYgc2hhcGUucmVxdWlyZWQubGVuZ3RoID4gMCkgewogICAgdXRpbC5hcnJheUVhY2goc2hhcGUucmVxdWlyZWQsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1tuYW1lXTsKICAgICAgaWYgKG1lbWJlclNoYXBlLmVuZHBvaW50RGlzY292ZXJ5SWQgPT09IHRydWUpIHsKICAgICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgICByZXN1bHRbbG9jYXRpb25OYW1lXSA9IFN0cmluZyhwYXJhbXNbbmFtZV0pOwogICAgICB9IGVsc2UgewogICAgICAgIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXNbbmFtZV0sIG1lbWJlclNoYXBlKTsKICAgICAgfQogICAgfSk7CiAgfQp9CgovKioKICogR2V0IGN1c3RvbSBpZGVudGlmaWVycyBmb3IgY2FjaGUga2V5LgogKiBJZGVudGlmaWVzIGN1c3RvbSBpZGVudGlmaWVycyBieSBjaGVja2luZyBlYWNoIHNoYXBlJ3MgYGVuZHBvaW50RGlzY292ZXJ5SWRgIHRyYWl0LgogKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICogQHBhcmFtIFtvYmplY3RdIGlucHV0IHNoYXBlIG9mIHRoZSBnaXZlbiBvcGVyYXRpb24ncyBhcGkKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIHNoYXBlKSB7CiAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihpZGVudGlmaWVycywgcmVxdWVzdC5wYXJhbXMsIHNoYXBlKTsKICByZXR1cm4gaWRlbnRpZmllcnM7Cn0KCi8qKgogKiBDYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24gd2hlbiBpdCdzIG9wdGlvbmFsLgogKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSB0aGUgY2FjaGVkIGVuZHBvaW50cy4gSWYgZW5kcG9pbnRzCiAqIGFyZSB1bmF2YWlsYWJsZSB0aGVuIHVzZSByZWdpb25hbCBlbmRwb2ludHMgYW5kIGNhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbgogKiBhc3luY2hyb25vdXNseS4gVGhpcyBpcyB0dXJuZWQgb2ZmIGJ5IGRlZmF1bHQuCiAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0KSB7CiAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uTW9kZWwgPyBvcGVyYXRpb25Nb2RlbC5pbnB1dCA6IHVuZGVmaW5lZDsKCiAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgIGlmIChvcGVyYXRpb25Nb2RlbCkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uTW9kZWwubmFtZTsKICB9CiAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleSk7CiAgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID09PSAxICYmIGVuZHBvaW50c1swXS5BZGRyZXNzID09PSAnJykgewogICAgLy9lbmRwb2ludCBvcGVyYXRpb24gaXMgYmVpbmcgbWFkZSBidXQgcmVzcG9uc2Ugbm90IHlldCByZWNlaXZlZAogICAgLy9vciBlbmRwb2ludCBvcGVyYXRpb24ganVzdCBmYWlsZWQgaW4gMSBtaW51dGUKICAgIHJldHVybjsKICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgLy9mb3VuZCBlbmRwb2ludCByZWNvcmQgZnJvbSBjYWNoZQogICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChlbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgfSBlbHNlIHsKICAgIC8vZW5kcG9pbnQgcmVjb3JkIG5vdCBpbiBjYWNoZSBvciBvdXRkYXRlZC4gbWFrZSBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAgICB2YXIgZW5kcG9pbnRSZXF1ZXN0ID0gc2VydmljZS5tYWtlUmVxdWVzdChhcGkuZW5kcG9pbnRPcGVyYXRpb24sIHsKICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICB9KTsKICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigncmV0cnknLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5SRVRSWV9DSEVDSyk7CiAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIFt7CiAgICAgIEFkZHJlc3M6ICcnLAogICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMQogICAgfV0pOwogICAgZW5kcG9pbnRSZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgIGlmIChkYXRhICYmIGRhdGEuRW5kcG9pbnRzKSB7CiAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBkYXRhLkVuZHBvaW50cyk7CiAgICAgIH0gZWxzZSBpZiAoZXJyKSB7CiAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICAgICAgQWRkcmVzczogJycsCiAgICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMSAvL25vdCB0byBtYWtlIG1vcmUgZW5kcG9pbnQgb3BlcmF0aW9uIGluIG5leHQgMSBtaW51dGUKICAgICAgICB9XSk7CiAgICAgIH0KICAgIH0pOwogIH0KfQoKdmFyIHJlcXVlc3RRdWV1ZSA9IHt9OwoKLyoqCiAqIENhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbiB3aGVuIGl0J3MgcmVxdWlyZWQuCiAqIFdoZW4gZW5kcG9pbnQgaXMgYXZhaWxhYmxlIGluIGNhY2hlIHRoZW4gdXNlIGNhY2hlZCBvbmVzLiBJZiBlbmRwb2ludHMgYXJlCiAqIHVuYXZhaWxhYmxlIHRoZW4gU0RLIHNob3VsZCBjYWxsIGVuZHBvaW50IG9wZXJhdGlvbiB0aGVuIHVzZSByZXR1cm5lZCBuZXcKICogZW5kcG9pbnQgZm9yIHRoZSBhcGkgY2FsbC4gU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvIGRvIGVuZHBvaW50CiAqIGRpc2NvdmVyeS4gVGhpcyBpcyB0dXJuZWQgb2ZmIGJ5IGRlZmF1bHQKICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICB2YXIgYXBpID0gc2VydmljZS5hcGk7CiAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwoKICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogIH0KICB2YXIgY2FjaGVLZXlTdHIgPSBBV1MuRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoY2FjaGVLZXkpOwogIHZhciBlbmRwb2ludHMgPSBBV1MuZW5kcG9pbnRDYWNoZS5nZXQoY2FjaGVLZXlTdHIpOyAvL2VuZHBvaW50IGNhY2hlIGFsc28gYWNjZXB0cyBzdHJpbmcga2V5cwogIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA9PT0gMSAmJiBlbmRwb2ludHNbMF0uQWRkcmVzcyA9PT0gJycpIHsKICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgIC8vcHVzaCByZXF1ZXN0IG9iamVjdCB0byBhIHBlbmRpbmcgcXVldWUKICAgIGlmICghcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSkgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSA9IFtdOwogICAgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXS5wdXNoKHtyZXF1ZXN0OiByZXF1ZXN0LCBjYWxsYmFjazogZG9uZX0pOwogICAgcmV0dXJuOwogIH0gZWxzZSBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPiAwKSB7CiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgIGRvbmUoKTsKICB9IGVsc2UgewogICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgSWRlbnRpZmllcnM6IGlkZW50aWZpZXJzLAogICAgfSk7CiAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCk7CgogICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAvL3RvbyBtdWNoIGluLWZsaWdodCBjYWxscwogICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBbewogICAgICBBZGRyZXNzOiAnJywKICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDYwIC8vbG9uZy1saXZlIGNhY2hlCiAgICB9XSk7CiAgICBlbmRwb2ludFJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgaWYgKGVycikgewogICAgICAgIHJlcXVlc3QucmVzcG9uc2UuZXJyb3IgPSB1dGlsLmVycm9yKGVyciwgeyByZXRyeWFibGU6IGZhbHNlIH0pOwogICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnJlbW92ZShjYWNoZUtleSk7CgogICAgICAgIC8vZmFpbCBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICBpZiAocmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSkgewogICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LnJlcXVlc3QucmVzcG9uc2UuZXJyb3IgPSB1dGlsLmVycm9yKGVyciwgeyByZXRyeWFibGU6IGZhbHNlIH0pOwogICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgfSk7CiAgICAgICAgICBkZWxldGUgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZGF0YSkgewogICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleVN0ciwgZGF0YS5FbmRwb2ludHMpOwogICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZGF0YS5FbmRwb2ludHNbMF0uQWRkcmVzcyk7CgogICAgICAgIC8vdXBkYXRlIHRoZSBlbmRwb2ludCBmb3IgYWxsIHRoZSBwZW5kaW5nIHJlcXVlc3RzIGluIGJhdGNoCiAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgdXRpbC5hcnJheUVhY2gocGVuZGluZ1JlcXVlc3RzLCBmdW5jdGlvbihyZXF1ZXN0Q29udGV4dCkgewogICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgfSk7CiAgICAgICAgICBkZWxldGUgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZG9uZSgpOwogICAgfSk7CiAgfQp9CgovKioKICogYWRkIGFwaSB2ZXJzaW9uIGhlYWRlciB0byBlbmRwb2ludCBvcGVyYXRpb24KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCkgewogIHZhciBhcGkgPSBlbmRwb2ludFJlcXVlc3Quc2VydmljZS5hcGk7CiAgdmFyIGFwaVZlcnNpb24gPSBhcGkuYXBpVmVyc2lvbjsKICBpZiAoYXBpVmVyc2lvbiAmJiAhZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10pIHsKICAgIGVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddID0gYXBpVmVyc2lvbjsKICB9Cn0KCi8qKgogKiBJZiBhcGkgY2FsbCBnZXRzIGludmFsaWQgZW5kcG9pbnQgZXhjZXB0aW9uLCBTREsgc2hvdWxkIGF0dGVtcHQgdG8gcmVtb3ZlIHRoZSBpbnZhbGlkCiAqIGVuZHBvaW50IGZyb20gY2FjaGUuCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyhyZXNwb25zZSkgewogIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogIHZhciBodHRwUmVzcG9uc2UgPSByZXNwb25zZS5odHRwUmVzcG9uc2U7CiAgaWYgKGVycm9yICYmCiAgICAoZXJyb3IuY29kZSA9PT0gJ0ludmFsaWRFbmRwb2ludEV4Y2VwdGlvbicgfHwgaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDQyMSkKICApIHsKICAgIHZhciByZXF1ZXN0ID0gcmVzcG9uc2UucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb25zID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA/IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLmlucHV0IDogdW5kZWZpbmVkOwogICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgaWYgKG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXS5uYW1lOwogICAgfQogICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKICB9Cn0KCi8qKgogKiBJZiBlbmRwb2ludCBpcyBleHBsaWNpdGx5IGNvbmZpZ3VyZWQsIFNESyBzaG91bGQgbm90IGRvIGVuZHBvaW50IGRpc2NvdmVyeSBpbiBhbnl0aW1lLgogKiBAcGFyYW0gW29iamVjdF0gY2xpZW50IFNlcnZpY2UgY2xpZW50IG9iamVjdC4KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBoYXNDdXN0b21FbmRwb2ludChjbGllbnQpIHsKICAvL2lmIHNldCBlbmRwb2ludCBpcyBzZXQgZm9yIHNwZWNpZmljIGNsaWVudCwgZW5hYmxlIGVuZHBvaW50IGRpc2NvdmVyeSB3aWxsIHJhaXNlIGFuIGVycm9yLgogIGlmIChjbGllbnQuX29yaWdpbmFsQ29uZmlnICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnQgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgPT09IHRydWUpIHsKICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICBtZXNzYWdlOiAnQ3VzdG9tIGVuZHBvaW50IGlzIHN1cHBsaWVkOyBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgbXVzdCBub3QgYmUgdHJ1ZS4nCiAgICB9KTsKICB9OwogIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW2NsaWVudC5zZXJ2aWNlSWRlbnRpZmllcl0gfHwge307CiAgcmV0dXJuIEJvb2xlYW4oQVdTLmNvbmZpZy5lbmRwb2ludCB8fCBzdmNDb25maWcuZW5kcG9pbnQgfHwgKGNsaWVudC5fb3JpZ2luYWxDb25maWcgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludCkpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBpc0ZhbHN5KHZhbHVlKSB7CiAgcmV0dXJuIFsnZmFsc2UnLCAnMCddLmluZGV4T2YodmFsdWUpID49IDA7Cn0KCi8qKgogKiBJZiBlbmRwb2ludCBkaXNjb3Zlcnkgc2hvdWxkIHBlcmZvcm0gZm9yIHRoaXMgcmVxdWVzdCB3aGVuIG5vIG9wZXJhdGlvbiByZXF1aXJlcyBlbmRwb2ludAogKiBkaXNjb3ZlcnkgZm9yIHRoZSBnaXZlbiBzZXJ2aWNlLgogKiBTREsgcGVyZm9ybXMgY29uZmlnIHJlc29sdXRpb24gaW4gb3JkZXIgbGlrZSBiZWxvdzoKICogMS4gSWYgc2V0IGluIGNsaWVudCBjb25maWd1cmF0aW9uLgogKiAyLiBJZiBzZXQgaW4gZW52IEFXU19FTkFCTEVfRU5EUE9JTlRfRElTQ09WRVJZLgogKiAzLiBJZiBzZXQgaW4gc2hhcmVkIGluaSBjb25maWcgZmlsZSB3aXRoIGtleSAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnLgogKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCByZXF1ZXN0IG9iamVjdC4KICogQHJldHVybnMgW2Jvb2xlYW58dW5kZWZpbmVkXSBpZiBlbmRwb2ludCBkaXNjb3ZlcnkgY29uZmlnIGlzIG5vdCBzZXQgaW4gYW55IHNvdXJjZSwgdGhpcwogKiAgZnVuY3Rpb24gcmV0dXJucyB1bmRlZmluZWQKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiByZXNvbHZlRW5kcG9pbnREaXNjb3ZlcnlDb25maWcocmVxdWVzdCkgewogIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogIGlmIChzZXJ2aWNlLmNvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgIT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuIHNlcnZpY2UuY29uZmlnLmVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZDsKICB9CgogIC8vc2hhcmVkIGluaSBmaWxlIGlzIG9ubHkgYXZhaWxhYmxlIGluIE5vZGUKICAvL25vdCB0byBjaGVjayBlbnYgaW4gYnJvd3NlcgogIGlmICh1dGlsLmlzQnJvd3NlcigpKSByZXR1cm4gdW5kZWZpbmVkOwoKICAvLyBJZiBhbnkgb2YgcmVjb2duaXplZCBlbmRwb2ludCBkaXNjb3ZlcnkgY29uZmlnIGVudiBpcyBzZXQKICBmb3IgKHZhciBpID0gMDsgaSA8IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBlbnYgPSBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzW2ldOwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgZW52KSkgewogICAgICBpZiAocHJvY2Vzcy5lbnZbZW52XSA9PT0gJycgfHwgcHJvY2Vzcy5lbnZbZW52XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2Vudmlyb25tZW50YWwgdmFyaWFibGUgJyArIGVudiArICcgY2Fubm90IGJlIHNldCB0byBub3RoaW5nJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiAhaXNGYWxzeShwcm9jZXNzLmVudltlbnZdKTsKICAgIH0KICB9CgogIHZhciBjb25maWdGaWxlID0ge307CiAgdHJ5IHsKICAgIGNvbmZpZ0ZpbGUgPSBBV1MudXRpbC5pbmlMb2FkZXIgPyBBV1MudXRpbC5pbmlMb2FkZXIubG9hZEZyb20oewogICAgICBpc0NvbmZpZzogdHJ1ZSwKICAgICAgZmlsZW5hbWU6IHByb2Nlc3MuZW52W0FXUy51dGlsLnNoYXJlZENvbmZpZ0ZpbGVFbnZdCiAgICB9KSA6IHt9OwogIH0gY2F0Y2ggKGUpIHt9CiAgdmFyIHNoYXJlZEZpbGVDb25maWcgPSBjb25maWdGaWxlWwogICAgcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGUKICBdIHx8IHt9OwogIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc2hhcmVkRmlsZUNvbmZpZywgJ2VuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkJykpIHsKICAgIGlmIChzaGFyZWRGaWxlQ29uZmlnLmVuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICBtZXNzYWdlOiAnY29uZmlnIGZpbGUgZW50cnkgXCdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZFwnIGNhbm5vdCBiZSBzZXQgdG8gbm90aGluZycKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gIWlzRmFsc3koc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCk7CiAgfQogIHJldHVybiB1bmRlZmluZWQ7Cn0KCi8qKgogKiBhdHRhY2ggZW5kcG9pbnQgZGlzY292ZXJ5IGxvZ2ljIHRvIHJlcXVlc3Qgb2JqZWN0CiAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0CiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gZGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2UgfHwge307CiAgaWYgKGhhc0N1c3RvbUVuZHBvaW50KHNlcnZpY2UpIHx8IHJlcXVlc3QuaXNQcmVzaWduZWQoKSkgcmV0dXJuIGRvbmUoKTsKCiAgdmFyIG9wZXJhdGlvbnMgPSBzZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogIHZhciBvcGVyYXRpb25Nb2RlbCA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogIHZhciBpc0VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgOiAnTlVMTCc7CiAgdmFyIGlzRW5hYmxlZCA9IHJlc29sdmVFbmRwb2ludERpc2NvdmVyeUNvbmZpZyhyZXF1ZXN0KTsKICB2YXIgaGFzUmVxdWlyZWRFbmRwb2ludERpc2NvdmVyeSA9IHNlcnZpY2UuYXBpLmhhc1JlcXVpcmVkRW5kcG9pbnREaXNjb3Zlcnk7CiAgaWYgKGlzRW5hYmxlZCB8fCBoYXNSZXF1aXJlZEVuZHBvaW50RGlzY292ZXJ5KSB7CiAgICAvLyBPbmNlIGEgY3VzdG9tZXIgZW5hYmxlcyBlbmRwb2ludCBkaXNjb3ZlcnksIHRoZSBTREsgc2hvdWxkIHN0YXJ0IGFwcGVuZGluZwogICAgLy8gdGhlIHN0cmluZyBlbmRwb2ludC1kaXNjb3ZlcnkgdG8gdGhlIHVzZXItYWdlbnQgb24gYWxsIHJlcXVlc3RzLgogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgnZW5kcG9pbnQtZGlzY292ZXJ5Jyk7CiAgfQogIHN3aXRjaCAoaXNFbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkKSB7CiAgICBjYXNlICdPUFRJT05BTCc6CiAgICAgIGlmIChpc0VuYWJsZWQgfHwgaGFzUmVxdWlyZWRFbmRwb2ludERpc2NvdmVyeSkgewogICAgICAgIC8vIEZvciBhIGdpdmVuIHNlcnZpY2U7IGlmIGF0IGxlYXN0IG9uZSBvcGVyYXRpb24gcmVxdWlyZXMgZW5kcG9pbnQgZGlzY292ZXJ5IHRoZW4gdGhlIFNESyBtdXN0IGVuYWJsZSBlbmRwb2ludCBkaXNjb3ZlcnkKICAgICAgICAvLyBieSBkZWZhdWx0IGZvciBhbGwgb3BlcmF0aW9ucyBvZiB0aGF0IHNlcnZpY2UsIGluY2x1ZGluZyBvcGVyYXRpb25zIHdoZXJlIGVuZHBvaW50IGRpc2NvdmVyeSBpcyBvcHRpb25hbC4KICAgICAgICBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCk7CiAgICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgIH0KICAgICAgZG9uZSgpOwogICAgICBicmVhazsKICAgIGNhc2UgJ1JFUVVJUkVEJzoKICAgICAgaWYgKGlzRW5hYmxlZCA9PT0gZmFsc2UpIHsKICAgICAgICAvLyBGb3IgYSBnaXZlbiBvcGVyYXRpb247IGlmIGVuZHBvaW50IGRpc2NvdmVyeSBpcyByZXF1aXJlZCBhbmQgaXQgaGFzIGJlZW4gZGlzYWJsZWQgb24gdGhlIFNESyBjbGllbnQsCiAgICAgICAgLy8gdGhlbiB0aGUgU0RLIG11c3QgcmV0dXJuIGEgY2xlYXIgYW5kIGFjdGlvbmFibGUgZXhjZXB0aW9uLgogICAgICAgIHJlcXVlc3QucmVzcG9uc2UuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnRW5kcG9pbnQgRGlzY292ZXJ5IGlzIGRpc2FibGVkIGJ1dCAnICsgc2VydmljZS5hcGkuY2xhc3NOYW1lICsgJy4nICsgcmVxdWVzdC5vcGVyYXRpb24gKwogICAgICAgICAgICAgICAgICAgICcoKSByZXF1aXJlcyBpdC4gUGxlYXNlIGNoZWNrIHlvdXIgY29uZmlndXJhdGlvbnMuJwogICAgICAgIH0pOwogICAgICAgIGRvbmUoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0lOVkFMSURBVEVfQ0FDSEVEX0VORFBPSU5UUycsICdleHRyYWN0RXJyb3InLCBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKTsKICAgICAgcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpOwogICAgICBicmVhazsKICAgIGNhc2UgJ05VTEwnOgogICAgZGVmYXVsdDoKICAgICAgZG9uZSgpOwogICAgICBicmVhazsKICB9Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIGRpc2NvdmVyRW5kcG9pbnQ6IGRpc2NvdmVyRW5kcG9pbnQsCiAgcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50OiByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQsCiAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50OiBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQsCiAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyczogbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycywKICBnZXRDYWNoZUtleTogZ2V0Q2FjaGVLZXksCiAgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50OiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzLAp9OwoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9jb3JlIjoxOSwiLi91dGlsIjo3MiwiX3Byb2Nlc3MiOjg5fV0sMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgZXZlbnRNZXNzYWdlQ2h1bmtlciA9IHJlcXVpcmUoJy4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXInKS5ldmVudE1lc3NhZ2VDaHVua2VyOwp2YXIgcGFyc2VFdmVudCA9IHJlcXVpcmUoJy4vcGFyc2UtZXZlbnQnKS5wYXJzZUV2ZW50OwoKZnVuY3Rpb24gY3JlYXRlRXZlbnRTdHJlYW0oYm9keSwgcGFyc2VyLCBtb2RlbCkgewogICAgdmFyIGV2ZW50TWVzc2FnZXMgPSBldmVudE1lc3NhZ2VDaHVua2VyKGJvZHkpOwoKICAgIHZhciBldmVudHMgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50TWVzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBldmVudHMucHVzaChwYXJzZUV2ZW50KHBhcnNlciwgZXZlbnRNZXNzYWdlc1tpXSwgbW9kZWwpKTsKICAgIH0KCiAgICByZXR1cm4gZXZlbnRzOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIGNyZWF0ZUV2ZW50U3RyZWFtOiBjcmVhdGVFdmVudFN0cmVhbQp9OwoKfSx7Ii4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXIiOjI5LCIuL3BhcnNlLWV2ZW50IjozMX1dLDI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRha2VzIGluIGEgYnVmZmVyIG9mIGV2ZW50IG1lc3NhZ2VzIGFuZCBzcGxpdHMgdGhlbSBpbnRvIGluZGl2aWR1YWwgbWVzc2FnZXMuCiAqIEBwYXJhbSB7QnVmZmVyfSBidWZmZXIKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBldmVudE1lc3NhZ2VDaHVua2VyKGJ1ZmZlcikgewogICAgLyoqIEB0eXBlIEJ1ZmZlcltdICovCiAgICB2YXIgbWVzc2FnZXMgPSBbXTsKICAgIHZhciBvZmZzZXQgPSAwOwoKICAgIHdoaWxlIChvZmZzZXQgPCBidWZmZXIubGVuZ3RoKSB7CiAgICAgICAgdmFyIHRvdGFsTGVuZ3RoID0gYnVmZmVyLnJlYWRJbnQzMkJFKG9mZnNldCk7CgogICAgICAgIC8vIGNyZWF0ZSBuZXcgYnVmZmVyIGZvciBpbmRpdmlkdWFsIG1lc3NhZ2UgKHNoYXJlcyBtZW1vcnkgd2l0aCBvcmlnaW5hbCkKICAgICAgICB2YXIgbWVzc2FnZSA9IGJ1ZmZlci5zbGljZShvZmZzZXQsIHRvdGFsTGVuZ3RoICsgb2Zmc2V0KTsKICAgICAgICAvLyBpbmNyZW1lbnQgb2Zmc2V0IHRvIGl0IHN0YXJ0cyBhdCB0aGUgbmV4dCBtZXNzYWdlCiAgICAgICAgb2Zmc2V0ICs9IHRvdGFsTGVuZ3RoOwoKICAgICAgICBtZXNzYWdlcy5wdXNoKG1lc3NhZ2UpOwogICAgfQoKICAgIHJldHVybiBtZXNzYWdlczsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBldmVudE1lc3NhZ2VDaHVua2VyOiBldmVudE1lc3NhZ2VDaHVua2VyCn07Cgp9LHt9XSwzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CnZhciB0b0J1ZmZlciA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyOwoKLyoqCiAqIEEgbG9zc2xlc3MgcmVwcmVzZW50YXRpb24gb2YgYSBzaWduZWQsIDY0LWJpdCBpbnRlZ2VyLiBJbnN0YW5jZXMgb2YgdGhpcwogKiBjbGFzcyBtYXkgYmUgdXNlZCBpbiBhcml0aG1ldGljIGV4cHJlc3Npb25zIGFzIGlmIHRoZXkgd2VyZSBudW1lcmljCiAqIHByaW1pdGl2ZXMsIGJ1dCB0aGUgYmluYXJ5IHJlcHJlc2VudGF0aW9uIHdpbGwgYmUgcHJlc2VydmVkIHVuY2hhbmdlZCBhcyB0aGUKICogYGJ5dGVzYCBwcm9wZXJ0eSBvZiB0aGUgb2JqZWN0LiBUaGUgYnl0ZXMgc2hvdWxkIGJlIGVuY29kZWQgYXMgYmlnLWVuZGlhbiwKICogdHdvJ3MgY29tcGxlbWVudCBpbnRlZ2Vycy4KICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gSW50NjQoYnl0ZXMpIHsKICAgIGlmIChieXRlcy5sZW5ndGggIT09IDgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludDY0IGJ1ZmZlcnMgbXVzdCBiZSBleGFjdGx5IDggYnl0ZXMnKTsKICAgIH0KICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIoYnl0ZXMpKSBieXRlcyA9IHRvQnVmZmVyKGJ5dGVzKTsKCiAgICB0aGlzLmJ5dGVzID0gYnl0ZXM7Cn0KCi8qKgogKiBAcGFyYW0ge251bWJlcn0gbnVtYmVyCiAqIEByZXR1cm5zIHtJbnQ2NH0KICoKICogQGFwaSBwcml2YXRlCiAqLwpJbnQ2NC5mcm9tTnVtYmVyID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICBpZiAobnVtYmVyID4gOTIyMzM3MjAzNjg1NDc3NTgwNyB8fCBudW1iZXIgPCAtOTIyMzM3MjAzNjg1NDc3NTgwOCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgbnVtYmVyICsgJyBpcyB0b28gbGFyZ2UgKG9yLCBpZiBuZWdhdGl2ZSwgdG9vIHNtYWxsKSB0byByZXByZXNlbnQgYXMgYW4gSW50NjQnCiAgICAgICAgKTsKICAgIH0KCiAgICB2YXIgYnl0ZXMgPSBuZXcgVWludDhBcnJheSg4KTsKICAgIGZvciAoCiAgICAgICAgdmFyIGkgPSA3LCByZW1haW5pbmcgPSBNYXRoLmFicyhNYXRoLnJvdW5kKG51bWJlcikpOwogICAgICAgIGkgPiAtMSAmJiByZW1haW5pbmcgPiAwOwogICAgICAgIGktLSwgcmVtYWluaW5nIC89IDI1NgogICAgKSB7CiAgICAgICAgYnl0ZXNbaV0gPSByZW1haW5pbmc7CiAgICB9CgogICAgaWYgKG51bWJlciA8IDApIHsKICAgICAgICBuZWdhdGUoYnl0ZXMpOwogICAgfQoKICAgIHJldHVybiBuZXcgSW50NjQoYnl0ZXMpOwp9OwoKLyoqCiAqIEByZXR1cm5zIHtudW1iZXJ9CiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KSW50NjQucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbigpIHsKICAgIHZhciBieXRlcyA9IHRoaXMuYnl0ZXMuc2xpY2UoMCk7CiAgICB2YXIgbmVnYXRpdmUgPSBieXRlc1swXSAmIDEyODsKICAgIGlmIChuZWdhdGl2ZSkgewogICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICB9CgogICAgcmV0dXJuIHBhcnNlSW50KGJ5dGVzLnRvU3RyaW5nKCdoZXgnKSwgMTYpICogKG5lZ2F0aXZlID8gLTEgOiAxKTsKfTsKCkludDY0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIFN0cmluZyh0aGlzLnZhbHVlT2YoKSk7Cn07CgovKioKICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gbmVnYXRlKGJ5dGVzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDg7IGkrKykgewogICAgICAgIGJ5dGVzW2ldIF49IDB4RkY7CiAgICB9CiAgICBmb3IgKHZhciBpID0gNzsgaSA+IC0xOyBpLS0pIHsKICAgICAgICBieXRlc1tpXSsrOwogICAgICAgIGlmIChieXRlc1tpXSAhPT0gMCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgSW50NjQ6IEludDY0Cn07Cgp9LHsiLi4vY29yZSI6MTl9XSwzMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBwYXJzZU1lc3NhZ2UgPSByZXF1aXJlKCcuL3BhcnNlLW1lc3NhZ2UnKS5wYXJzZU1lc3NhZ2U7CgovKioKICoKICogQHBhcmFtIHsqfSBwYXJzZXIKICogQHBhcmFtIHtCdWZmZXJ9IG1lc3NhZ2UKICogQHBhcmFtIHsqfSBzaGFwZQogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHBhcnNlRXZlbnQocGFyc2VyLCBtZXNzYWdlLCBzaGFwZSkgewogICAgdmFyIHBhcnNlZE1lc3NhZ2UgPSBwYXJzZU1lc3NhZ2UobWVzc2FnZSk7CgogICAgLy8gY2hlY2sgaWYgbWVzc2FnZSBpcyBhbiBldmVudCBvciBlcnJvcgogICAgdmFyIG1lc3NhZ2VUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6bWVzc2FnZS10eXBlJ107CiAgICBpZiAobWVzc2FnZVR5cGUpIHsKICAgICAgICBpZiAobWVzc2FnZVR5cGUudmFsdWUgPT09ICdlcnJvcicpIHsKICAgICAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihwYXJzZWRNZXNzYWdlKTsKICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2VUeXBlLnZhbHVlICE9PSAnZXZlbnQnKSB7CiAgICAgICAgICAgIC8vIG5vdCBzdXJlIGhvdyB0byBwYXJzZSBub24tZXZlbnRzL25vbi1lcnJvcnMsIGlnbm9yZSBmb3Igbm93CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgLy8gZGV0ZXJtaW5lIGV2ZW50IHR5cGUKICAgIHZhciBldmVudFR5cGUgPSBwYXJzZWRNZXNzYWdlLmhlYWRlcnNbJzpldmVudC10eXBlJ107CiAgICAvLyBjaGVjayB0aGF0IHRoZSBldmVudCB0eXBlIGlzIG1vZGVsZWQKICAgIHZhciBldmVudE1vZGVsID0gc2hhcGUubWVtYmVyc1tldmVudFR5cGUudmFsdWVdOwogICAgaWYgKCFldmVudE1vZGVsKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIC8vIGNoZWNrIGlmIGFuIGV2ZW50IHBheWxvYWQgZXhpc3RzCiAgICB2YXIgZXZlbnRQYXlsb2FkTWVtYmVyTmFtZSA9IGV2ZW50TW9kZWwuZXZlbnRQYXlsb2FkTWVtYmVyTmFtZTsKICAgIGlmIChldmVudFBheWxvYWRNZW1iZXJOYW1lKSB7CiAgICAgICAgdmFyIHBheWxvYWRTaGFwZSA9IGV2ZW50TW9kZWwubWVtYmVyc1tldmVudFBheWxvYWRNZW1iZXJOYW1lXTsKICAgICAgICAvLyBpZiB0aGUgc2hhcGUgaXMgYmluYXJ5LCByZXR1cm4gdGhlIGJ5dGUgYXJyYXkKICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknKSB7CiAgICAgICAgICAgIHJlc3VsdFtldmVudFBheWxvYWRNZW1iZXJOYW1lXSA9IHBhcnNlZE1lc3NhZ2UuYm9keTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZXIucGFyc2UocGFyc2VkTWVzc2FnZS5ib2R5LnRvU3RyaW5nKCksIHBheWxvYWRTaGFwZSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIHJlYWQgZXZlbnQgaGVhZGVycwogICAgdmFyIGV2ZW50SGVhZGVyTmFtZXMgPSBldmVudE1vZGVsLmV2ZW50SGVhZGVyTWVtYmVyTmFtZXM7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50SGVhZGVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgbmFtZSA9IGV2ZW50SGVhZGVyTmFtZXNbaV07CiAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1tuYW1lXSkgewogICAgICAgICAgICAvLyBwYXJzZSB0aGUgaGVhZGVyIQogICAgICAgICAgICByZXN1bHRbbmFtZV0gPSBldmVudE1vZGVsLm1lbWJlcnNbbmFtZV0udG9UeXBlKHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1tuYW1lXS52YWx1ZSk7CiAgICAgICAgfQogICAgfQoKICAgIHZhciBvdXRwdXQgPSB7fTsKICAgIG91dHB1dFtldmVudFR5cGUudmFsdWVdID0gcmVzdWx0OwogICAgcmV0dXJuIG91dHB1dDsKfQoKZnVuY3Rpb24gcGFyc2VFcnJvcihtZXNzYWdlKSB7CiAgICB2YXIgZXJyb3JDb2RlID0gbWVzc2FnZS5oZWFkZXJzWyc6ZXJyb3ItY29kZSddOwogICAgdmFyIGVycm9yTWVzc2FnZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLW1lc3NhZ2UnXTsKICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UudmFsdWUgfHwgZXJyb3JNZXNzYWdlKTsKICAgIGVycm9yLmNvZGUgPSBlcnJvci5uYW1lID0gZXJyb3JDb2RlLnZhbHVlIHx8IGVycm9yQ29kZTsKICAgIHJldHVybiBlcnJvcjsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBwYXJzZUV2ZW50OiBwYXJzZUV2ZW50Cn07Cgp9LHsiLi9wYXJzZS1tZXNzYWdlIjozMn1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEludDY0ID0gcmVxdWlyZSgnLi9pbnQ2NCcpLkludDY0OwoKdmFyIHNwbGl0TWVzc2FnZSA9IHJlcXVpcmUoJy4vc3BsaXQtbWVzc2FnZScpLnNwbGl0TWVzc2FnZTsKCnZhciBCT09MRUFOX1RBRyA9ICdib29sZWFuJzsKdmFyIEJZVEVfVEFHID0gJ2J5dGUnOwp2YXIgU0hPUlRfVEFHID0gJ3Nob3J0JzsKdmFyIElOVF9UQUcgPSAnaW50ZWdlcic7CnZhciBMT05HX1RBRyA9ICdsb25nJzsKdmFyIEJJTkFSWV9UQUcgPSAnYmluYXJ5JzsKdmFyIFNUUklOR19UQUcgPSAnc3RyaW5nJzsKdmFyIFRJTUVTVEFNUF9UQUcgPSAndGltZXN0YW1wJzsKdmFyIFVVSURfVEFHID0gJ3V1aWQnOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKgogKiBAcGFyYW0ge0J1ZmZlcn0gaGVhZGVycwogKi8KZnVuY3Rpb24gcGFyc2VIZWFkZXJzKGhlYWRlcnMpIHsKICAgIHZhciBvdXQgPSB7fTsKICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICB3aGlsZSAocG9zaXRpb24gPCBoZWFkZXJzLmxlbmd0aCkgewogICAgICAgIHZhciBuYW1lTGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDgocG9zaXRpb24rKyk7CiAgICAgICAgdmFyIG5hbWUgPSBoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIG5hbWVMZW5ndGgpLnRvU3RyaW5nKCk7CiAgICAgICAgcG9zaXRpb24gKz0gbmFtZUxlbmd0aDsKICAgICAgICBzd2l0Y2ggKGhlYWRlcnMucmVhZFVJbnQ4KHBvc2l0aW9uKyspKSB7CiAgICAgICAgICAgIGNhc2UgMCAvKiBib29sVHJ1ZSAqLzoKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBCT09MRUFOX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDEgLyogYm9vbEZhbHNlICovOgogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IEJPT0xFQU5fVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDIgLyogYnl0ZSAqLzoKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBCWVRFX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50OChwb3NpdGlvbisrKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDMgLyogc2hvcnQgKi86CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogU0hPUlRfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQxNkJFKHBvc2l0aW9uKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSA0IC8qIGludGVnZXIgKi86CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogSU5UX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MzJCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA0OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNSAvKiBsb25nICovOgogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IExPTkdfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgSW50NjQoaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyA4KSkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNiAvKiBieXRlQXJyYXkgKi86CiAgICAgICAgICAgICAgICB2YXIgYmluYXJ5TGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDE2QkUocG9zaXRpb24pOwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBCSU5BUllfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIGJpbmFyeUxlbmd0aCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBiaW5hcnlMZW5ndGg7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSA3IC8qIHN0cmluZyAqLzoKICAgICAgICAgICAgICAgIHZhciBzdHJpbmdMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IFNUUklOR19UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMuc2xpY2UoCiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiArIHN0cmluZ0xlbmd0aAogICAgICAgICAgICAgICAgICAgICkudG9TdHJpbmcoKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IHN0cmluZ0xlbmd0aDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDggLyogdGltZXN0YW1wICovOgogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IFRJTUVTVEFNUF9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBEYXRlKAogICAgICAgICAgICAgICAgICAgICAgICBuZXcgSW50NjQoaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyA4KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52YWx1ZU9mKCkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gODsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDkgLyogdXVpZCAqLzoKICAgICAgICAgICAgICAgIHZhciB1dWlkQ2hhcnMgPSBoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDE2KQogICAgICAgICAgICAgICAgICAgIC50b1N0cmluZygnaGV4Jyk7CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAxNjsKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBVVUlEX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdXVpZENoYXJzLnN1YnN0cigwLCA4KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoOCwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDEyLCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMTYsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigyMCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIGhlYWRlciB0eXBlIHRhZycpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBvdXQ7Cn0KCmZ1bmN0aW9uIHBhcnNlTWVzc2FnZShtZXNzYWdlKSB7CiAgICB2YXIgcGFyc2VkID0gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpOwogICAgcmV0dXJuIHsgaGVhZGVyczogcGFyc2VIZWFkZXJzKHBhcnNlZC5oZWFkZXJzKSwgYm9keTogcGFyc2VkLmJvZHkgfTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBwYXJzZU1lc3NhZ2U6IHBhcnNlTWVzc2FnZQp9OwoKfSx7Ii4vaW50NjQiOjMwLCIuL3NwbGl0LW1lc3NhZ2UiOjMzfV0sMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL2NvcmUnKS51dGlsOwp2YXIgdG9CdWZmZXIgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcjsKCi8vIEFsbCBwcmVsdWRlIGNvbXBvbmVudHMgYXJlIHVuc2lnbmVkLCAzMi1iaXQgaW50ZWdlcnMKdmFyIFBSRUxVREVfTUVNQkVSX0xFTkdUSCA9IDQ7Ci8vIFRoZSBwcmVsdWRlIGNvbnNpc3RzIG9mIHR3byBjb21wb25lbnRzCnZhciBQUkVMVURFX0xFTkdUSCA9IFBSRUxVREVfTUVNQkVSX0xFTkdUSCAqIDI7Ci8vIENoZWNrc3VtcyBhcmUgYWx3YXlzIENSQzMyIGhhc2hlcy4KdmFyIENIRUNLU1VNX0xFTkdUSCA9IDQ7Ci8vIE1lc3NhZ2VzIG11c3QgaW5jbHVkZSBhIGZ1bGwgcHJlbHVkZSwgYSBwcmVsdWRlIGNoZWNrc3VtLCBhbmQgYSBtZXNzYWdlIGNoZWNrc3VtCnZhciBNSU5JTVVNX01FU1NBR0VfTEVOR1RIID0gUFJFTFVERV9MRU5HVEggKyBDSEVDS1NVTV9MRU5HVEggKiAyOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKgogKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogKi8KZnVuY3Rpb24gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpIHsKICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIobWVzc2FnZSkpIG1lc3NhZ2UgPSB0b0J1ZmZlcihtZXNzYWdlKTsKCiAgICBpZiAobWVzc2FnZS5sZW5ndGggPCBNSU5JTVVNX01FU1NBR0VfTEVOR1RIKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlZCBtZXNzYWdlIHRvbyBzaG9ydCB0byBhY2NvbW1vZGF0ZSBldmVudCBzdHJlYW0gbWVzc2FnZSBvdmVyaGVhZCcpOwogICAgfQoKICAgIGlmIChtZXNzYWdlLmxlbmd0aCAhPT0gbWVzc2FnZS5yZWFkVUludDMyQkUoMCkpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcG9ydGVkIG1lc3NhZ2UgbGVuZ3RoIGRvZXMgbm90IG1hdGNoIHJlY2VpdmVkIG1lc3NhZ2UgbGVuZ3RoJyk7CiAgICB9CgogICAgdmFyIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtID0gbWVzc2FnZS5yZWFkVUludDMyQkUoUFJFTFVERV9MRU5HVEgpOwoKICAgIGlmICgKICAgICAgICBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSAhPT0gdXRpbC5jcnlwdG8uY3JjMzIoCiAgICAgICAgICAgIG1lc3NhZ2Uuc2xpY2UoMCwgUFJFTFVERV9MRU5HVEgpCiAgICAgICAgKQogICAgKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAnVGhlIHByZWx1ZGUgY2hlY2tzdW0gc3BlY2lmaWVkIGluIHRoZSBtZXNzYWdlICgnICsKICAgICAgICAgICAgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gKwogICAgICAgICAgICAnKSBkb2VzIG5vdCBtYXRjaCB0aGUgY2FsY3VsYXRlZCBDUkMzMiBjaGVja3N1bS4nCiAgICAgICAgKTsKICAgIH0KCiAgICB2YXIgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCk7CgogICAgaWYgKAogICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgbWVzc2FnZS5zbGljZSgwLCBtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCkKICAgICAgICApCiAgICApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICdUaGUgbWVzc2FnZSBjaGVja3N1bSBkaWQgbm90IG1hdGNoIHRoZSBleHBlY3RlZCB2YWx1ZSBvZiAnICsKICAgICAgICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtCiAgICAgICAgKTsKICAgIH0KCiAgICB2YXIgaGVhZGVyc1N0YXJ0ID0gUFJFTFVERV9MRU5HVEggKyBDSEVDS1NVTV9MRU5HVEg7CiAgICB2YXIgaGVhZGVyc0VuZCA9IGhlYWRlcnNTdGFydCArIG1lc3NhZ2UucmVhZFVJbnQzMkJFKFBSRUxVREVfTUVNQkVSX0xFTkdUSCk7CgogICAgcmV0dXJuIHsKICAgICAgICBoZWFkZXJzOiBtZXNzYWdlLnNsaWNlKGhlYWRlcnNTdGFydCwgaGVhZGVyc0VuZCksCiAgICAgICAgYm9keTogbWVzc2FnZS5zbGljZShoZWFkZXJzRW5kLCBtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCksCiAgICB9Owp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIHNwbGl0TWVzc2FnZTogc3BsaXRNZXNzYWdlCn07Cgp9LHsiLi4vY29yZSI6MTl9XSwzNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnZhciBTZXF1ZW50aWFsRXhlY3V0b3IgPSByZXF1aXJlKCcuL3NlcXVlbnRpYWxfZXhlY3V0b3InKTsKdmFyIERJU0NPVkVSX0VORFBPSU5UID0gcmVxdWlyZSgnLi9kaXNjb3Zlcl9lbmRwb2ludCcpLmRpc2NvdmVyRW5kcG9pbnQ7Ci8qKgogKiBUaGUgbmFtZXNwYWNlIHVzZWQgdG8gcmVnaXN0ZXIgZ2xvYmFsIGV2ZW50IGxpc3RlbmVycyBmb3IgcmVxdWVzdCBidWlsZGluZwogKiBhbmQgc2VuZGluZy4KICovCkFXUy5FdmVudExpc3RlbmVycyA9IHsKICAvKioKICAgKiBAIWF0dHJpYnV0ZSBWQUxJREFURV9DUkVERU5USUFMUwogICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIHdoZXRoZXIgdGhlIHJlcXVlc3QgaXMgYmVpbmcKICAgKiAgIHNlbnQgd2l0aCBjcmVkZW50aWFscy4KICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgY3JlZGVudGlhbHMKICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFM7CiAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgbGlzdGVuZXIpOwogICAqICAgQHJlYWRvbmx5CiAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgKiBAIWF0dHJpYnV0ZSBWQUxJREFURV9SRUdJT04KICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZWdpb24gaXMgc2V0CiAgICogICBmb3IgYSByZXF1ZXN0LgogICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyByZWdpb24gY29uZmlndXJhdGlvbgogICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT047CiAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgbGlzdGVuZXIpOwogICAqICAgQHJlYWRvbmx5CiAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgKiBAIWF0dHJpYnV0ZSBWQUxJREFURV9QQVJBTUVURVJTCiAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgaW5wdXQgcGFyYW1ldGVycyBpbiBhIHJlcXVlc3QuCiAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIHBhcmFtZXRlcnMKICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUzsKICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICogICBAZXhhbXBsZSBEaXNhYmxlIHBhcmFtZXRlciB2YWxpZGF0aW9uIGdsb2JhbGx5CiAgICogICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICogICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OKTsKICAgKiAgIEByZWFkb25seQogICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICogQCFhdHRyaWJ1dGUgU0VORAogICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgaW5pdGlhdGVzIHRoZSBIVFRQIGNvbm5lY3Rpb24gZm9yIGEKICAgKiAgIHJlcXVlc3QgYmVpbmcgc2VudC4gSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnNlbmQgJ3NlbmQnIFJlcXVlc3QgZXZlbnR9CiAgICogICBAZXhhbXBsZSBSZXBsYWNpbmcgdGhlIEhUVFAgaGFuZGxlcgogICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5EOwogICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdzZW5kJywgbGlzdGVuZXIpOwogICAqICAgICByZXF1ZXN0Lm9uKCdzZW5kJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgICBjdXN0b21IYW5kbGVyLnNlbmQocmVzcG9uc2UpOwogICAqICAgICB9KTsKICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAqICAgQHJlYWRvbmx5CiAgICogQCFhdHRyaWJ1dGUgSFRUUF9EQVRBCiAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCByZWFkcyBkYXRhIGZyb20gdGhlIEhUVFAgY29ubmVjdGlvbiBpbiBvcmRlcgogICAqICAgdG8gYnVpbGQgdGhlIHJlc3BvbnNlIGRhdGEuCiAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+aHR0cERhdGEgJ2h0dHBEYXRhJyBSZXF1ZXN0IGV2ZW50fS4KICAgKiAgIFJlbW92ZSB0aGlzIGhhbmRsZXIgaWYgeW91IGFyZSBvdmVycmlkaW5nIHRoZSAnaHR0cERhdGEnIGV2ZW50IGFuZAogICAqICAgZG8gbm90IHdhbnQgZXh0cmEgZGF0YSBwcm9jZXNzaW5nIGFuZCBidWZmZXJpbmcgb3ZlcmhlYWQuCiAgICogICBAZXhhbXBsZSBEaXNhYmxpbmcgZGVmYXVsdCBkYXRhIHByb2Nlc3NpbmcKICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBOwogICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdodHRwRGF0YScsIGxpc3RlbmVyKTsKICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAqICAgQHJlYWRvbmx5CiAgICovCiAgQ29yZToge30gLyogZG9jIGhhY2sgKi8KfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSkgewogIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgIHJldHVybiAnJzsKICB9CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHJldHVybiBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKfQoKQVdTLkV2ZW50TGlzdGVuZXJzID0gewogIENvcmU6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQsIGFkZEFzeW5jKSB7CiAgICBhZGRBc3luYygnVkFMSURBVEVfQ1JFREVOVElBTFMnLCAndmFsaWRhdGUnLAogICAgICAgIGZ1bmN0aW9uIFZBTElEQVRFX0NSRURFTlRJQUxTKHJlcSwgZG9uZSkgewogICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFyZXEuc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQogICAgICByZXEuc2VydmljZS5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyLAogICAgICAgICAgICB7Y29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcsIGlmIHVzaW5nIEFXU19DT05GSUdfRklMRSwgc2V0IEFXU19TREtfTE9BRF9DT05GSUc9MSd9KTsKICAgICAgICB9CiAgICAgICAgZG9uZSgpOwogICAgICB9KTsKICAgIH0pOwoKICAgIGFkZCgnVkFMSURBVEVfUkVHSU9OJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gVkFMSURBVEVfUkVHSU9OKHJlcSkgewogICAgICBpZiAoIXJlcS5zZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHsKICAgICAgICB2YXIgZG5zSG9zdFJlZ2V4ID0gbmV3IFJlZ0V4cCgvXihbYS16QS1aMC05XXxbYS16QS1aMC05XVthLXpBLVowLTktXXswLDYxfVthLXpBLVowLTldKSQvKTsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmNvbmZpZy5yZWdpb24pIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9IGVsc2UgaWYgKCFkbnNIb3N0UmVnZXgudGVzdChyZXEuc2VydmljZS5jb25maWcucmVnaW9uKSkgewogICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgIHtjb2RlOiAnQ29uZmlnRXJyb3InLCBtZXNzYWdlOiAnSW52YWxpZCByZWdpb24gaW4gY29uZmlnJ30pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgYWRkKCdCVUlMRF9JREVNUE9URU5DWV9UT0tFTlMnLCAndmFsaWRhdGUnLCBmdW5jdGlvbiBCVUlMRF9JREVNUE9URU5DWV9UT0tFTlMocmVxKSB7CiAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICBpZiAoIW9wZXJhdGlvbikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgaWRlbXBvdGVudE1lbWJlcnMgPSBvcGVyYXRpb24uaWRlbXBvdGVudE1lbWJlcnM7CiAgICAgIGlmICghaWRlbXBvdGVudE1lbWJlcnMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIGNyZWF0ZXMgYSBjb3B5IG9mIHBhcmFtcyBzbyB1c2VyJ3MgcGFyYW0gb2JqZWN0IGlzbid0IG11dGF0ZWQKICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocmVxLnBhcmFtcyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gaWRlbXBvdGVudE1lbWJlcnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgaWYgKCFwYXJhbXNbaWRlbXBvdGVudE1lbWJlcnNbaV1dKSB7CiAgICAgICAgICAvLyBhZGQgdGhlIG1lbWJlcgogICAgICAgICAgcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSA9IEFXUy51dGlsLnV1aWQudjQoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVxLnBhcmFtcyA9IHBhcmFtczsKICAgIH0pOwoKICAgIGFkZCgnVkFMSURBVEVfUEFSQU1FVEVSUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1BBUkFNRVRFUlMocmVxKSB7CiAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICAgIHZhciB2YWxpZGF0aW9uID0gcmVxLnNlcnZpY2UuY29uZmlnLnBhcmFtVmFsaWRhdGlvbjsKICAgICAgbmV3IEFXUy5QYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKS52YWxpZGF0ZShydWxlcywgcmVxLnBhcmFtcyk7CiAgICB9KTsKCiAgICBhZGQoJ0NPTVBVVEVfQ0hFQ0tTVU0nLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIENPTVBVVEVfQ0hFQ0tTVU0ocmVxKSB7CiAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICBpZiAoIW9wZXJhdGlvbikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYm9keSA9IHJlcS5odHRwUmVxdWVzdC5ib2R5OwogICAgICB2YXIgaXNOb25TdHJlYW1pbmdQYXlsb2FkID0gYm9keSAmJiAoQVdTLnV0aWwuQnVmZmVyLmlzQnVmZmVyKGJvZHkpIHx8IHR5cGVvZiBib2R5ID09PSAnc3RyaW5nJyk7CiAgICAgIHZhciBoZWFkZXJzID0gcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnM7CiAgICAgIGlmICgKICAgICAgICBvcGVyYXRpb24uaHR0cENoZWNrc3VtUmVxdWlyZWQgJiYKICAgICAgICByZXEuc2VydmljZS5jb25maWcuY29tcHV0ZUNoZWNrc3VtcyAmJgogICAgICAgIGlzTm9uU3RyZWFtaW5nUGF5bG9hZCAmJgogICAgICAgICFoZWFkZXJzWydDb250ZW50LU1ENSddCiAgICAgICkgewogICAgICAgIHZhciBtZDUgPSBBV1MudXRpbC5jcnlwdG8ubWQ1KGJvZHksICdiYXNlNjQnKTsKICAgICAgICBoZWFkZXJzWydDb250ZW50LU1ENSddID0gbWQ1OwogICAgICB9CiAgICB9KTsKCiAgICBhZGRBc3luYygnQ09NUFVURV9TSEEyNTYnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIENPTVBVVEVfU0hBMjU2KHJlcSwgZG9uZSkgewogICAgICByZXEuaGFsdEhhbmRsZXJzT25FcnJvcigpOwogICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24gJiYgIWF1dGh0eXBlICYmICFyZXEuc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQogICAgICBpZiAocmVxLnNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxKSA9PT0gQVdTLlNpZ25lcnMuVjQpIHsKICAgICAgICB2YXIgYm9keSA9IHJlcS5odHRwUmVxdWVzdC5ib2R5IHx8ICcnOwogICAgICAgIGlmIChhdXRodHlwZS5pbmRleE9mKCd1bnNpZ25lZC1ib2R5JykgPj0gMCkgewogICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10gPSAnVU5TSUdORUQtUEFZTE9BRCc7CiAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgIH0KICAgICAgICBBV1MudXRpbC5jb21wdXRlU2hhMjU2KGJvZHksIGZ1bmN0aW9uKGVyciwgc2hhKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIGRvbmUoZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXSA9IHNoYTsKICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGRvbmUoKTsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdTRVRfQ09OVEVOVF9MRU5HVEgnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIFNFVF9DT05URU5UX0xFTkdUSChyZXEpIHsKICAgICAgdmFyIGF1dGh0eXBlID0gZ2V0T3BlcmF0aW9uQXV0aHR5cGUocmVxKTsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBBV1MudXRpbC5nZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSk7CiAgICAgIGlmIChyZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBsZW5ndGggPSBBV1MudXRpbC5zdHJpbmcuYnl0ZUxlbmd0aChyZXEuaHR0cFJlcXVlc3QuYm9keSk7CiAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9IGxlbmd0aDsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyICYmIHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICAgICAgaWYgKHBheWxvYWRNZW1iZXIucmVxdWlyZXNMZW5ndGgpIHsKICAgICAgICAgICAgICAvL3N0cmVhbWluZyBwYXlsb2FkIHJlcXVpcmVzIGxlbmd0aChzMywgZ2xhY2llcikKICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXV0aHR5cGUuaW5kZXhPZigndW5zaWduZWQtYm9keScpID49IDApIHsKICAgICAgICAgICAgICAvL3VuYm91bmRlZCBzdHJlYW1pbmcgcGF5bG9hZChsZXgsIG1lZGlhc3RvcmUpCiAgICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1RyYW5zZmVyLUVuY29kaW5nJ10gPSAnY2h1bmtlZCc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgYWRkKCdTRVRfSFRUUF9IT1NUJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBTRVRfSFRUUF9IT1NUKHJlcSkgewogICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gcmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICB9KTsKCiAgICBhZGQoJ1NFVF9UUkFDRV9JRCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX1RSQUNFX0lEKHJlcSkgewogICAgICB2YXIgdHJhY2VJZEhlYWRlck5hbWUgPSAnWC1BbXpuLVRyYWNlLUlkJzsKICAgICAgaWYgKEFXUy51dGlsLmlzTm9kZSgpICYmICFPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChyZXEuaHR0cFJlcXVlc3QuaGVhZGVycywgdHJhY2VJZEhlYWRlck5hbWUpKSB7CiAgICAgICAgdmFyIEVOVl9MQU1CREFfRlVOQ1RJT05fTkFNRSA9ICdBV1NfTEFNQkRBX0ZVTkNUSU9OX05BTUUnOwogICAgICAgIHZhciBFTlZfVFJBQ0VfSUQgPSAnX1hfQU1aTl9UUkFDRV9JRCc7CiAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IHByb2Nlc3MuZW52W0VOVl9MQU1CREFfRlVOQ1RJT05fTkFNRV07CiAgICAgICAgdmFyIHRyYWNlSWQgPSBwcm9jZXNzLmVudltFTlZfVFJBQ0VfSURdOwogICAgICAgIGlmICgKICAgICAgICAgIHR5cGVvZiBmdW5jdGlvbk5hbWUgPT09ICdzdHJpbmcnICYmCiAgICAgICAgICBmdW5jdGlvbk5hbWUubGVuZ3RoID4gMCAmJgogICAgICAgICAgdHlwZW9mIHRyYWNlSWQgPT09ICdzdHJpbmcnICYmCiAgICAgICAgICB0cmFjZUlkLmxlbmd0aCA+IDAKICAgICAgICApIHsKICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW3RyYWNlSWRIZWFkZXJOYW1lXSA9IHRyYWNlSWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ1JFU1RBUlQnLCAncmVzdGFydCcsIGZ1bmN0aW9uIFJFU1RBUlQoKSB7CiAgICAgIHZhciBlcnIgPSB0aGlzLnJlc3BvbnNlLmVycm9yOwogICAgICBpZiAoIWVyciB8fCAhZXJyLnJldHJ5YWJsZSkgcmV0dXJuOwoKICAgICAgdGhpcy5odHRwUmVxdWVzdCA9IG5ldyBBV1MuSHR0cFJlcXVlc3QoCiAgICAgICAgdGhpcy5zZXJ2aWNlLmVuZHBvaW50LAogICAgICAgIHRoaXMuc2VydmljZS5yZWdpb24KICAgICAgKTsKCiAgICAgIGlmICh0aGlzLnJlc3BvbnNlLnJldHJ5Q291bnQgPCB0aGlzLnNlcnZpY2UuY29uZmlnLm1heFJldHJpZXMpIHsKICAgICAgICB0aGlzLnJlc3BvbnNlLnJldHJ5Q291bnQrKzsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gbnVsbDsKICAgICAgfQogICAgfSk7CgogICAgdmFyIGFkZFRvSGVhZCA9IHRydWU7CiAgICBhZGRBc3luYygnRElTQ09WRVJfRU5EUE9JTlQnLCAnc2lnbicsIERJU0NPVkVSX0VORFBPSU5ULCBhZGRUb0hlYWQpOwoKICAgIGFkZEFzeW5jKCdTSUdOJywgJ3NpZ24nLCBmdW5jdGlvbiBTSUdOKHJlcSwgZG9uZSkgewogICAgICB2YXIgc2VydmljZSA9IHJlcS5zZXJ2aWNlOwogICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICB2YXIgb3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgIGlmICghc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKCiAgICAgIHNlcnZpY2UuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uIChlcnIsIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgICAgcmV0dXJuIGRvbmUoKTsKICAgICAgICB9CgogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgZGF0ZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAgICAgICAgIHZhciBTaWduZXJDbGFzcyA9IHNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxKTsKICAgICAgICAgIHZhciBzaWduZXIgPSBuZXcgU2lnbmVyQ2xhc3MocmVxLmh0dHBSZXF1ZXN0LAogICAgICAgICAgICBzZXJ2aWNlLmdldFNpZ25pbmdOYW1lKHJlcSksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzaWduYXR1cmVDYWNoZTogc2VydmljZS5jb25maWcuc2lnbmF0dXJlQ2FjaGUsCiAgICAgICAgICAgICAgb3BlcmF0aW9uOiBvcGVyYXRpb24sCiAgICAgICAgICAgICAgc2lnbmF0dXJlVmVyc2lvbjogc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbgogICAgICAgICAgICB9KTsKICAgICAgICAgIHNpZ25lci5zZXRTZXJ2aWNlQ2xpZW50SWQoc2VydmljZS5fY2xpZW50SWQpOwoKICAgICAgICAgIC8vIGNsZWFyIG9sZCBhdXRob3JpemF0aW9uIGhlYWRlcnMKICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddOwogICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydEYXRlJ107CiAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKCiAgICAgICAgICAvLyBhZGQgbmV3IGF1dGhvcml6YXRpb24KICAgICAgICAgIHNpZ25lci5hZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKTsKICAgICAgICAgIHJlcS5zaWduZWRBdCA9IGRhdGU7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gZTsKICAgICAgICB9CiAgICAgICAgZG9uZSgpOwogICAgICB9KTsKICAgIH0pOwoKICAgIGFkZCgnVkFMSURBVEVfUkVTUE9OU0UnLCAndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFU1BPTlNFKHJlc3ApIHsKICAgICAgaWYgKHRoaXMuc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgdGhpcykpIHsKICAgICAgICByZXNwLmRhdGEgPSB7fTsKICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwLmRhdGEgPSBudWxsOwogICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgIHtjb2RlOiAnVW5rbm93bkVycm9yJywgbWVzc2FnZTogJ0FuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuJ30pOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0VSUk9SJywgJ2Vycm9yJywgZnVuY3Rpb24gRVJST1IoZXJyLCByZXNwKSB7CiAgICAgIHZhciBlcnJvckNvZGVNYXBwaW5nID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuYXBpLmVycm9yQ29kZU1hcHBpbmc7CiAgICAgIGlmIChlcnJvckNvZGVNYXBwaW5nICYmIGVyciAmJiBlcnIuY29kZSkgewogICAgICAgIHZhciBtYXBwaW5nID0gZXJyb3JDb2RlTWFwcGluZ1tlcnIuY29kZV07CiAgICAgICAgaWYgKG1hcHBpbmcpIHsKICAgICAgICAgIHJlc3AuZXJyb3IuY29kZSA9IG1hcHBpbmcuY29kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sIHRydWUpOwoKICAgIGFkZEFzeW5jKCdTRU5EJywgJ3NlbmQnLCBmdW5jdGlvbiBTRU5EKHJlc3AsIGRvbmUpIHsKICAgICAgcmVzcC5odHRwUmVzcG9uc2UuX2Fib3J0Q2FsbGJhY2sgPSBkb25lOwogICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgcmVzcC5kYXRhID0gbnVsbDsKCiAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGh0dHBSZXNwKSB7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtID0gaHR0cFJlc3A7CiAgICAgICAgdmFyIHN0cmVhbSA9IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5zdHJlYW07CiAgICAgICAgdmFyIHNlcnZpY2UgPSByZXNwLnJlcXVlc3Quc2VydmljZTsKICAgICAgICB2YXIgYXBpID0gc2VydmljZS5hcGk7CiAgICAgICAgdmFyIG9wZXJhdGlvbk5hbWUgPSByZXNwLnJlcXVlc3Qub3BlcmF0aW9uOwogICAgICAgIHZhciBvcGVyYXRpb24gPSBhcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXSB8fCB7fTsKCiAgICAgICAgaHR0cFJlc3Aub24oJ2hlYWRlcnMnLCBmdW5jdGlvbiBvbkhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgc3RhdHVzTWVzc2FnZSkgewogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoCiAgICAgICAgICAgICdodHRwSGVhZGVycycsCiAgICAgICAgICAgIFtzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwLCBzdGF0dXNNZXNzYWdlXQogICAgICAgICAgKTsKCiAgICAgICAgICBpZiAoIXJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbWluZykgewogICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsgLy8gc3RyZWFtczIgQVBJIGNoZWNrCiAgICAgICAgICAgICAgLy8gaWYgd2UgZGV0ZWN0IGV2ZW50IHN0cmVhbXMsIHdlJ3JlIGdvaW5nIHRvIGhhdmUgdG8KICAgICAgICAgICAgICAvLyByZXR1cm4gdGhlIHN0cmVhbSBpbW1lZGlhdGVseQogICAgICAgICAgICAgIGlmIChvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQgJiYgc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkpIHsKICAgICAgICAgICAgICAgIC8vIHNraXAgcmVhZGluZyB0aGUgSW5jb21pbmdTdHJlYW0KICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG9uZScpOwogICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaHR0cFJlc3Aub24oJ3JlYWRhYmxlJywgZnVuY3Rpb24gb25SZWFkYWJsZSgpIHsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gaHR0cFJlc3AucmVhZCgpOwogICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEYXRhJywgW2RhdGEsIHJlc3BdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsgLy8gbGVnYWN5IHN0cmVhbXMgQVBJCiAgICAgICAgICAgICAgaHR0cFJlc3Aub24oJ2RhdGEnLCBmdW5jdGlvbiBvbkRhdGEoZGF0YSkgewogICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEYXRhJywgW2RhdGEsIHJlc3BdKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICBodHRwUmVzcC5vbignZW5kJywgZnVuY3Rpb24gb25FbmQoKSB7CiAgICAgICAgICBpZiAoIXN0cmVhbSB8fCAhc3RyZWFtLmRpZENhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiAmJiAob3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0ICYmIHNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApKSkgewogICAgICAgICAgICAgIC8vIGRvbid0IGNvbmNhdGVuYXRlIHJlc3BvbnNlIGNodW5rcyB3aGVuIHN0cmVhbWluZyBldmVudCBzdHJlYW0gZGF0YSB3aGVuIHJlc3BvbnNlIGlzIHN1Y2Nlc3NmdWwKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb25lJyk7CiAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gcHJvZ3Jlc3MoaHR0cFJlc3ApIHsKICAgICAgICBodHRwUmVzcC5vbignc2VuZFByb2dyZXNzJywgZnVuY3Rpb24gb25TZW5kUHJvZ3Jlc3ModmFsdWUpIHsKICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwVXBsb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICB9KTsKCiAgICAgICAgaHR0cFJlc3Aub24oJ3JlY2VpdmVQcm9ncmVzcycsIGZ1bmN0aW9uIG9uUmVjZWl2ZVByb2dyZXNzKHZhbHVlKSB7CiAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvd25sb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXJyb3IoZXJyKSB7CiAgICAgICAgaWYgKGVyci5jb2RlICE9PSAnUmVxdWVzdEFib3J0ZWRFcnJvcicpIHsKICAgICAgICAgIHZhciBlcnJDb2RlID0gZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InID8gZXJyLmNvZGUgOiAnTmV0d29ya2luZ0Vycm9yJzsKICAgICAgICAgIGVyciA9IEFXUy51dGlsLmVycm9yKGVyciwgewogICAgICAgICAgICBjb2RlOiBlcnJDb2RlLAogICAgICAgICAgICByZWdpb246IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb24sCiAgICAgICAgICAgIGhvc3RuYW1lOiByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUsCiAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJlc3AuZXJyb3IgPSBlcnI7CiAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBFcnJvcicsIFtyZXNwLmVycm9yLCByZXNwXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGV4ZWN1dGVTZW5kKCkgewogICAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgICB2YXIgaHR0cE9wdGlvbnMgPSByZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuaHR0cE9wdGlvbnMgfHwge307CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBzdHJlYW0gPSBodHRwLmhhbmRsZVJlcXVlc3QocmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2ssIGVycm9yKTsKICAgICAgICAgIHByb2dyZXNzKHN0cmVhbSk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBlcnJvcihlcnIpOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgdGltZURpZmYgPSAocmVzcC5yZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKSAtIHRoaXMuc2lnbmVkQXQpIC8gMTAwMDsKICAgICAgaWYgKHRpbWVEaWZmID49IDYwICogMTApIHsgLy8gaWYgd2Ugc2lnbmVkIDEwbWluIGFnbywgcmUtc2lnbgogICAgICAgIHRoaXMuZW1pdCgnc2lnbicsIFt0aGlzXSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSBkb25lKGVycik7CiAgICAgICAgICBlbHNlIGV4ZWN1dGVTZW5kKCk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZXhlY3V0ZVNlbmQoKTsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdIVFRQX0hFQURFUlMnLCAnaHR0cEhlYWRlcnMnLAogICAgICAgIGZ1bmN0aW9uIEhUVFBfSEVBREVSUyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwLCBzdGF0dXNNZXNzYWdlKSB7CiAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlID0gc3RhdHVzTWVzc2FnZTsKICAgICAgcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkgPSBBV1MudXRpbC5idWZmZXIudG9CdWZmZXIoJycpOwogICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzID0gW107CiAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzID0gMDsKICAgICAgdmFyIGRhdGVIZWFkZXIgPSBoZWFkZXJzLmRhdGUgfHwgaGVhZGVycy5EYXRlOwogICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICBpZiAoZGF0ZUhlYWRlcikgewogICAgICAgIHZhciBzZXJ2ZXJUaW1lID0gRGF0ZS5wYXJzZShkYXRlSGVhZGVyKTsKICAgICAgICBpZiAoc2VydmljZS5jb25maWcuY29ycmVjdENsb2NrU2tldwogICAgICAgICAgICAmJiBzZXJ2aWNlLmlzQ2xvY2tTa2V3ZWQoc2VydmVyVGltZSkpIHsKICAgICAgICAgIHNlcnZpY2UuYXBwbHlDbG9ja09mZnNldChzZXJ2ZXJUaW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnSFRUUF9EQVRBJywgJ2h0dHBEYXRhJywgZnVuY3Rpb24gSFRUUF9EQVRBKGNodW5rLCByZXNwKSB7CiAgICAgIGlmIChjaHVuaykgewogICAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgewogICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMgKz0gY2h1bmsubGVuZ3RoOwoKICAgICAgICAgIHZhciB0b3RhbCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ107CiAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSB7IGxvYWRlZDogcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMsIHRvdGFsOiB0b3RhbCB9OwogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb3dubG9hZFByb2dyZXNzJywgW3Byb2dyZXNzLCByZXNwXSk7CiAgICAgICAgfQoKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzLnB1c2goQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKGNodW5rKSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnSFRUUF9ET05FJywgJ2h0dHBEb25lJywgZnVuY3Rpb24gSFRUUF9ET05FKHJlc3ApIHsKICAgICAgLy8gY29udmVydCBidWZmZXJzIGFycmF5IGludG8gc2luZ2xlIGJ1ZmZlcgogICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyAmJiByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgYm9keSA9IEFXUy51dGlsLmJ1ZmZlci5jb25jYXQocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyk7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYm9keSA9IGJvZHk7CiAgICAgIH0KICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzOwogICAgICBkZWxldGUgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVyczsKICAgIH0pOwoKICAgIGFkZCgnRklOQUxJWkVfRVJST1InLCAncmV0cnknLCBmdW5jdGlvbiBGSU5BTElaRV9FUlJPUihyZXNwKSB7CiAgICAgIGlmIChyZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlKSB7CiAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICBpZiAocmVzcC5lcnJvci5yZXRyeWFibGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0aGlzLnNlcnZpY2UucmV0cnlhYmxlRXJyb3IocmVzcC5lcnJvciwgdGhpcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0lOVkFMSURBVEVfQ1JFREVOVElBTFMnLCAncmV0cnknLCBmdW5jdGlvbiBJTlZBTElEQVRFX0NSRURFTlRJQUxTKHJlc3ApIHsKICAgICAgaWYgKCFyZXNwLmVycm9yKSByZXR1cm47CiAgICAgIHN3aXRjaCAocmVzcC5lcnJvci5jb2RlKSB7CiAgICAgICAgY2FzZSAnUmVxdWVzdEV4cGlyZWQnOiAvLyBFQzIgb25seQogICAgICAgIGNhc2UgJ0V4cGlyZWRUb2tlbkV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnRXhwaXJlZFRva2VuJzoKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICAgIHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5leHBpcmVkID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdFWFBJUkVEX1NJR05BVFVSRScsICdyZXRyeScsIGZ1bmN0aW9uIEVYUElSRURfU0lHTkFUVVJFKHJlc3ApIHsKICAgICAgdmFyIGVyciA9IHJlc3AuZXJyb3I7CiAgICAgIGlmICghZXJyKSByZXR1cm47CiAgICAgIGlmICh0eXBlb2YgZXJyLmNvZGUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoZXJyLmNvZGUubWF0Y2goL1NpZ25hdHVyZS8pICYmIGVyci5tZXNzYWdlLm1hdGNoKC9leHBpcmVkLykpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnQ0xPQ0tfU0tFV0VEJywgJ3JldHJ5JywgZnVuY3Rpb24gQ0xPQ0tfU0tFV0VEKHJlc3ApIHsKICAgICAgaWYgKCFyZXNwLmVycm9yKSByZXR1cm47CiAgICAgIGlmICh0aGlzLnNlcnZpY2UuY2xvY2tTa2V3RXJyb3IocmVzcC5lcnJvcikKICAgICAgICAgICYmIHRoaXMuc2VydmljZS5jb25maWcuY29ycmVjdENsb2NrU2tldykgewogICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdSRURJUkVDVCcsICdyZXRyeScsIGZ1bmN0aW9uIFJFRElSRUNUKHJlc3ApIHsKICAgICAgaWYgKHJlc3AuZXJyb3IgJiYgcmVzcC5lcnJvci5zdGF0dXNDb2RlID49IDMwMCAmJgogICAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlIDwgNDAwICYmIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2xvY2F0aW9uJ10pIHsKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50ID0KICAgICAgICAgIG5ldyBBV1MuRW5kcG9pbnQocmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1snbG9jYXRpb24nXSk7CiAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5oZWFkZXJzWydIb3N0J10gPSB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICAgICAgcmVzcC5lcnJvci5yZWRpcmVjdCA9IHRydWU7CiAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ1JFVFJZX0NIRUNLJywgJ3JldHJ5JywgZnVuY3Rpb24gUkVUUllfQ0hFQ0socmVzcCkgewogICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgIGlmIChyZXNwLmVycm9yLnJlZGlyZWN0ICYmIHJlc3AucmVkaXJlY3RDb3VudCA8IHJlc3AubWF4UmVkaXJlY3RzKSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSAwOwogICAgICAgIH0gZWxzZSBpZiAocmVzcC5yZXRyeUNvdW50IDwgcmVzcC5tYXhSZXRyaWVzKSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSB0aGlzLnNlcnZpY2UucmV0cnlEZWxheXMocmVzcC5yZXRyeUNvdW50LCByZXNwLmVycm9yKSB8fCAwOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgYWRkQXN5bmMoJ1JFU0VUX1JFVFJZX1NUQVRFJywgJ2FmdGVyUmV0cnknLCBmdW5jdGlvbiBSRVNFVF9SRVRSWV9TVEFURShyZXNwLCBkb25lKSB7CiAgICAgIHZhciBkZWxheSwgd2lsbFJldHJ5ID0gZmFsc2U7CgogICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgIGRlbGF5ID0gcmVzcC5lcnJvci5yZXRyeURlbGF5IHx8IDA7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IucmV0cnlhYmxlICYmIHJlc3AucmV0cnlDb3VudCA8IHJlc3AubWF4UmV0cmllcykgewogICAgICAgICAgcmVzcC5yZXRyeUNvdW50Kys7CiAgICAgICAgICB3aWxsUmV0cnkgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAocmVzcC5lcnJvci5yZWRpcmVjdCAmJiByZXNwLnJlZGlyZWN0Q291bnQgPCByZXNwLm1heFJlZGlyZWN0cykgewogICAgICAgICAgcmVzcC5yZWRpcmVjdENvdW50Kys7CiAgICAgICAgICB3aWxsUmV0cnkgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gZGVsYXkgPCAwIGlzIGEgc2lnbmFsIGZyb20gY3VzdG9tQmFja29mZiB0byBza2lwIHJldHJpZXMKICAgICAgaWYgKHdpbGxSZXRyeSAmJiBkZWxheSA+PSAwKSB7CiAgICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgICAgc2V0VGltZW91dChkb25lLCBkZWxheSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9uZSgpOwogICAgICB9CiAgICB9KTsKICB9KSwKCiAgQ29yZVBvc3Q6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIGFkZCgnRVhUUkFDVF9SRVFVRVNUX0lEJywgJ2V4dHJhY3REYXRhJywgQVdTLnV0aWwuZXh0cmFjdFJlcXVlc3RJZCk7CiAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RXJyb3InLCBBV1MudXRpbC5leHRyYWN0UmVxdWVzdElkKTsKCiAgICBhZGQoJ0VOT1RGT1VORF9FUlJPUicsICdodHRwRXJyb3InLCBmdW5jdGlvbiBFTk9URk9VTkRfRVJST1IoZXJyKSB7CiAgICAgIGZ1bmN0aW9uIGlzRE5TRXJyb3IoZXJyKSB7CiAgICAgICAgcmV0dXJuIGVyci5lcnJubyA9PT0gJ0VOT1RGT1VORCcgfHwKICAgICAgICAgIHR5cGVvZiBlcnIuZXJybm8gPT09ICdudW1iZXInICYmCiAgICAgICAgICB0eXBlb2YgQVdTLnV0aWwuZ2V0U3lzdGVtRXJyb3JOYW1lID09PSAnZnVuY3Rpb24nICYmCiAgICAgICAgICBbJ0VBSV9OT05BTUUnLCAnRUFJX05PREFUQSddLmluZGV4T2YoQVdTLnV0aWwuZ2V0U3lzdGVtRXJyb3JOYW1lKGVyci5lcnJubykgPj0gMCk7CiAgICAgIH0KICAgICAgaWYgKGVyci5jb2RlID09PSAnTmV0d29ya2luZ0Vycm9yJyAmJiBpc0ROU0Vycm9yKGVycikpIHsKICAgICAgICB2YXIgbWVzc2FnZSA9ICdJbmFjY2Vzc2libGUgaG9zdDogYCcgKyBlcnIuaG9zdG5hbWUgKyAnXCcgYXQgcG9ydCBgJyArIGVyci5wb3J0ICsKICAgICAgICAgICdcJy4gVGhpcyBzZXJ2aWNlIG1heSBub3QgYmUgYXZhaWxhYmxlIGluIHRoZSBgJyArIGVyci5yZWdpb24gKwogICAgICAgICAgJ1wnIHJlZ2lvbi4nOwogICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHsKICAgICAgICAgIGNvZGU6ICdVbmtub3duRW5kcG9pbnQnLAogICAgICAgICAgcmVnaW9uOiBlcnIucmVnaW9uLAogICAgICAgICAgaG9zdG5hbWU6IGVyci5ob3N0bmFtZSwKICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZSwKICAgICAgICAgIG9yaWdpbmFsRXJyb3I6IGVycgogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9KSwKCiAgTG9nZ2VyOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICBhZGQoJ0xPR19SRVFVRVNUJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gTE9HX1JFUVVFU1QocmVzcCkgewogICAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgICB2YXIgbG9nZ2VyID0gcmVxLnNlcnZpY2UuY29uZmlnLmxvZ2dlcjsKICAgICAgaWYgKCFsb2dnZXIpIHJldHVybjsKICAgICAgZnVuY3Rpb24gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUsIHNoYXBlKSB7CiAgICAgICAgaWYgKCFzaGFwZSkgewogICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgIH0KICAgICAgICBpZiAoaW5wdXRTaGFwZS5pc1NlbnNpdGl2ZSkgewogICAgICAgICAgcmV0dXJuICcqKipTZW5zaXRpdmVJbmZvcm1hdGlvbioqKic7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoaW5wdXRTaGFwZS50eXBlKSB7CiAgICAgICAgICBjYXNlICdzdHJ1Y3R1cmUnOgogICAgICAgICAgICB2YXIgc3RydWN0ID0ge307CiAgICAgICAgICAgIEFXUy51dGlsLmVhY2goc2hhcGUsIGZ1bmN0aW9uKHN1YlNoYXBlTmFtZSwgc3ViU2hhcGUpIHsKICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGlucHV0U2hhcGUubWVtYmVycywgc3ViU2hhcGVOYW1lKSkgewogICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS5tZW1iZXJzW3N1YlNoYXBlTmFtZV0sIHN1YlNoYXBlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBzdWJTaGFwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gc3RydWN0OwogICAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICAgIHZhciBsaXN0ID0gW107CiAgICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgbGlzdC5wdXNoKGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlciwgc3ViU2hhcGUpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBsaXN0OwogICAgICAgICAgY2FzZSAnbWFwJzoKICAgICAgICAgICAgdmFyIG1hcCA9IHt9OwogICAgICAgICAgICBBV1MudXRpbC5lYWNoKHNoYXBlLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgbWFwW2tleV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiBzaGFwZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGJ1aWxkTWVzc2FnZSgpIHsKICAgICAgICB2YXIgdGltZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIHZhciBkZWx0YSA9ICh0aW1lIC0gcmVxLnN0YXJ0VGltZS5nZXRUaW1lKCkpIC8gMTAwMDsKICAgICAgICB2YXIgYW5zaSA9IGxvZ2dlci5pc1RUWSA/IHRydWUgOiBmYWxzZTsKICAgICAgICB2YXIgc3RhdHVzID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICB2YXIgY2Vuc29yZWRQYXJhbXMgPSByZXEucGFyYW1zOwogICAgICAgIGlmICgKICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zICYmCiAgICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0gJiYKICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dAogICAgICAgICkgewogICAgICAgICAgdmFyIGlucHV0U2hhcGUgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgICAgICAgIGNlbnNvcmVkUGFyYW1zID0gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUsIHJlcS5wYXJhbXMpOwogICAgICAgIH0KICAgICAgICB2YXIgcGFyYW1zID0gcmVxdWlyZSgndXRpbCcpLmluc3BlY3QoY2Vuc29yZWRQYXJhbXMsIHRydWUsIG51bGwpOwogICAgICAgIHZhciBtZXNzYWdlID0gJyc7CiAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMzNtJzsKICAgICAgICBtZXNzYWdlICs9ICdbQVdTICcgKyByZXEuc2VydmljZS5zZXJ2aWNlSWRlbnRpZmllciArICcgJyArIHN0YXR1czsKICAgICAgICBtZXNzYWdlICs9ICcgJyArIGRlbHRhLnRvU3RyaW5nKCkgKyAncyAnICsgcmVzcC5yZXRyeUNvdW50ICsgJyByZXRyaWVzXSc7CiAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMDsxbSc7CiAgICAgICAgbWVzc2FnZSArPSAnICcgKyBBV1MudXRpbC5zdHJpbmcubG93ZXJGaXJzdChyZXEub3BlcmF0aW9uKTsKICAgICAgICBtZXNzYWdlICs9ICcoJyArIHBhcmFtcyArICcpJzsKICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswbSc7CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH0KCiAgICAgIHZhciBsaW5lID0gYnVpbGRNZXNzYWdlKCk7CiAgICAgIGlmICh0eXBlb2YgbG9nZ2VyLmxvZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGxvZ2dlci5sb2cobGluZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGxvZ2dlci53cml0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGxvZ2dlci53cml0ZShsaW5lICsgJ1xuJyk7CiAgICAgIH0KICAgIH0pOwogIH0pLAoKICBKc29uOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9qc29uJyk7CiAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgfSksCgogIFJlc3Q6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKTsKICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICB9KSwKCiAgUmVzdEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfanNvbicpOwogICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogIH0pLAoKICBSZXN0WG1sOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X3htbCcpOwogICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogIH0pLAoKICBRdWVyeTogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKTsKICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICB9KQp9OwoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9jb3JlIjoxOSwiLi9kaXNjb3Zlcl9lbmRwb2ludCI6MjcsIi4vcHJvdG9jb2wvanNvbiI6NDcsIi4vcHJvdG9jb2wvcXVlcnkiOjQ4LCIuL3Byb3RvY29sL3Jlc3QiOjQ5LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NTAsIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUxLCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjYwLCJfcHJvY2VzcyI6ODksInV0aWwiOjgzfV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCi8qKgogKiBUaGUgZW5kcG9pbnQgdGhhdCBhIHNlcnZpY2Ugd2lsbCB0YWxrIHRvLCBmb3IgZXhhbXBsZSwKICogYCdodHRwczovL2VjMi5hcC1zb3V0aGVhc3QtMS5hbWF6b25hd3MuY29tJ2AuIElmCiAqIHlvdSBuZWVkIHRvIG92ZXJyaWRlIGFuIGVuZHBvaW50IGZvciBhIHNlcnZpY2UsIHlvdSBjYW4KICogc2V0IHRoZSBlbmRwb2ludCBvbiBhIHNlcnZpY2UgYnkgcGFzc2luZyB0aGUgZW5kcG9pbnQKICogb2JqZWN0IHdpdGggdGhlIGBlbmRwb2ludGAgb3B0aW9uIGtleToKICoKICogYGBgamF2YXNjcmlwdAogKiB2YXIgZXAgPSBuZXcgQVdTLkVuZHBvaW50KCdhd3Nwcm94eS5leGFtcGxlLmNvbScpOwogKiB2YXIgczMgPSBuZXcgQVdTLlMzKHtlbmRwb2ludDogZXB9KTsKICogczMuc2VydmljZS5lbmRwb2ludC5ob3N0bmFtZSA9PSAnYXdzcHJveHkuZXhhbXBsZS5jb20nCiAqIGBgYAogKgogKiBOb3RlIHRoYXQgaWYgeW91IGRvIG5vdCBzcGVjaWZ5IGEgcHJvdG9jb2wsIHRoZSBwcm90b2NvbCB3aWxsCiAqIGJlIHNlbGVjdGVkIGJhc2VkIG9uIHlvdXIgY3VycmVudCB7QVdTLmNvbmZpZ30gY29uZmlndXJhdGlvbi4KICoKICogQCFhdHRyaWJ1dGUgcHJvdG9jb2wKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBwcm90b2NvbCAoaHR0cCBvciBodHRwcykgb2YgdGhlIGVuZHBvaW50CiAqICAgICBVUkwKICogQCFhdHRyaWJ1dGUgaG9zdG5hbWUKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50LCBlLmcuLAogKiAgICAgZXhhbXBsZS5jb20KICogQCFhdHRyaWJ1dGUgaG9zdAogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGhvc3QgcG9ydGlvbiBvZiB0aGUgZW5kcG9pbnQgaW5jbHVkaW5nCiAqICAgICB0aGUgcG9ydCwgZS5nLiwgZXhhbXBsZS5jb206ODAKICogQCFhdHRyaWJ1dGUgcG9ydAogKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBwb3J0IG9mIHRoZSBlbmRwb2ludAogKiBAIWF0dHJpYnV0ZSBocmVmCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgZnVsbCBVUkwgb2YgdGhlIGVuZHBvaW50CiAqLwpBV1MuRW5kcG9pbnQgPSBpbmhlcml0KHsKCiAgLyoqCiAgICogQG92ZXJsb2FkIEVuZHBvaW50KGVuZHBvaW50KQogICAqICAgQ29uc3RydWN0cyBhIG5ldyBlbmRwb2ludCBnaXZlbiBhbiBlbmRwb2ludCBVUkwuIElmIHRoZQogICAqICAgVVJMIG9taXRzIGEgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpLCB0aGUgZGVmYXVsdCBwcm90b2NvbAogICAqICAgc2V0IGluIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IHdpbGwgYmUgdXNlZC4KICAgKiAgIEBwYXJhbSBlbmRwb2ludCBbU3RyaW5nXSB0aGUgVVJMIHRvIGNvbnN0cnVjdCBhbiBlbmRwb2ludCBmcm9tCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEVuZHBvaW50KGVuZHBvaW50LCBjb25maWcpIHsKICAgIEFXUy51dGlsLmhpZGVQcm9wZXJ0aWVzKHRoaXMsIFsnc2xhc2hlcycsICdhdXRoJywgJ2hhc2gnLCAnc2VhcmNoJywgJ3F1ZXJ5J10pOwoKICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgPT09ICd1bmRlZmluZWQnIHx8IGVuZHBvaW50ID09PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBlbmRwb2ludDogJyArIGVuZHBvaW50KTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuZHBvaW50ICE9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY29weShlbmRwb2ludCk7CiAgICB9CgogICAgaWYgKCFlbmRwb2ludC5tYXRjaCgvXmh0dHAvKSkgewogICAgICB2YXIgdXNlU1NMID0gY29uZmlnICYmIGNvbmZpZy5zc2xFbmFibGVkICE9PSB1bmRlZmluZWQgPwogICAgICAgIGNvbmZpZy5zc2xFbmFibGVkIDogQVdTLmNvbmZpZy5zc2xFbmFibGVkOwogICAgICBlbmRwb2ludCA9ICh1c2VTU0wgPyAnaHR0cHMnIDogJ2h0dHAnKSArICc6Ly8nICsgZW5kcG9pbnQ7CiAgICB9CgogICAgQVdTLnV0aWwudXBkYXRlKHRoaXMsIEFXUy51dGlsLnVybFBhcnNlKGVuZHBvaW50KSk7CgogICAgLy8gRW5zdXJlIHRoZSBwb3J0IHByb3BlcnR5IGlzIHNldCBhcyBhbiBpbnRlZ2VyCiAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgIHRoaXMucG9ydCA9IHBhcnNlSW50KHRoaXMucG9ydCwgMTApOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wb3J0ID0gdGhpcy5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyA0NDMgOiA4MDsKICAgIH0KICB9Cgp9KTsKCi8qKgogKiBUaGUgbG93IGxldmVsIEhUVFAgcmVxdWVzdCBvYmplY3QsIGVuY2Fwc3VsYXRpbmcgYWxsIEhUVFAgaGVhZGVyCiAqIGFuZCBib2R5IGRhdGEgc2VudCBieSBhIHNlcnZpY2UgcmVxdWVzdC4KICoKICogQCFhdHRyaWJ1dGUgbWV0aG9kCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgSFRUUCBtZXRob2Qgb2YgdGhlIHJlcXVlc3QKICogQCFhdHRyaWJ1dGUgcGF0aAogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHBhdGggcG9ydGlvbiBvZiB0aGUgVVJJLCBlLmcuLAogKiAgICAgIi9saXN0Lz9zdGFydD01Jm51bT0xMCIKICogQCFhdHRyaWJ1dGUgaGVhZGVycwogKiAgIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0KICogICAgIGEgbWFwIG9mIGhlYWRlciBrZXlzIGFuZCB0aGVpciByZXNwZWN0aXZlIHZhbHVlcwogKiBAIWF0dHJpYnV0ZSBib2R5CiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVxdWVzdCBib2R5IHBheWxvYWQKICogQCFhdHRyaWJ1dGUgZW5kcG9pbnQKICogICBAcmV0dXJuIFtBV1MuRW5kcG9pbnRdIHRoZSBlbmRwb2ludCBmb3IgdGhlIHJlcXVlc3QKICogQCFhdHRyaWJ1dGUgcmVnaW9uCiAqICAgQGFwaSBwcml2YXRlCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVnaW9uLCBmb3Igc2lnbmluZyBwdXJwb3NlcyBvbmx5LgogKi8KQVdTLkh0dHBSZXF1ZXN0ID0gaW5oZXJpdCh7CgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBIdHRwUmVxdWVzdChlbmRwb2ludCwgcmVnaW9uKSB7CiAgICBlbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgdGhpcy5tZXRob2QgPSAnUE9TVCc7CiAgICB0aGlzLnBhdGggPSBlbmRwb2ludC5wYXRoIHx8ICcvJzsKICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgdGhpcy5ib2R5ID0gJyc7CiAgICB0aGlzLmVuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICB0aGlzLnJlZ2lvbiA9IHJlZ2lvbjsKICAgIHRoaXMuX3VzZXJBZ2VudCA9ICcnOwogICAgdGhpcy5zZXRVc2VyQWdlbnQoKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzZXRVc2VyQWdlbnQ6IGZ1bmN0aW9uIHNldFVzZXJBZ2VudCgpIHsKICAgIHRoaXMuX3VzZXJBZ2VudCA9IHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSBBV1MudXRpbC51c2VyQWdlbnQoKTsKICB9LAoKICBnZXRVc2VyQWdlbnRIZWFkZXJOYW1lOiBmdW5jdGlvbiBnZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCkgewogICAgdmFyIHByZWZpeCA9IEFXUy51dGlsLmlzQnJvd3NlcigpID8gJ1gtQW16LScgOiAnJzsKICAgIHJldHVybiBwcmVmaXggKyAnVXNlci1BZ2VudCc7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXBwZW5kVG9Vc2VyQWdlbnQ6IGZ1bmN0aW9uIGFwcGVuZFRvVXNlckFnZW50KGFnZW50UGFydGlhbCkgewogICAgaWYgKHR5cGVvZiBhZ2VudFBhcnRpYWwgPT09ICdzdHJpbmcnICYmIGFnZW50UGFydGlhbCkgewogICAgICB0aGlzLl91c2VyQWdlbnQgKz0gJyAnICsgYWdlbnRQYXJ0aWFsOwogICAgfQogICAgdGhpcy5oZWFkZXJzW3RoaXMuZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpXSA9IHRoaXMuX3VzZXJBZ2VudDsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRVc2VyQWdlbnQ6IGZ1bmN0aW9uIGdldFVzZXJBZ2VudCgpIHsKICAgIHJldHVybiB0aGlzLl91c2VyQWdlbnQ7CiAgfSwKCiAgLyoqCiAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgcGFydCBvZiB0aGUge3BhdGh9IGV4Y2x1ZGluZyB0aGUKICAgKiAgIHF1ZXJ5IHN0cmluZwogICAqLwogIHBhdGhuYW1lOiBmdW5jdGlvbiBwYXRobmFtZSgpIHsKICAgIHJldHVybiB0aGlzLnBhdGguc3BsaXQoJz8nLCAxKVswXTsKICB9LAoKICAvKioKICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBxdWVyeSBzdHJpbmcgcG9ydGlvbiBvZiB0aGUge3BhdGh9CiAgICovCiAgc2VhcmNoOiBmdW5jdGlvbiBzZWFyY2goKSB7CiAgICB2YXIgcXVlcnkgPSB0aGlzLnBhdGguc3BsaXQoJz8nLCAyKVsxXTsKICAgIGlmIChxdWVyeSkgewogICAgICBxdWVyeSA9IEFXUy51dGlsLnF1ZXJ5U3RyaW5nUGFyc2UocXVlcnkpOwogICAgICByZXR1cm4gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeSk7CiAgICB9CiAgICByZXR1cm4gJyc7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogdXBkYXRlIGh0dHBSZXF1ZXN0IGVuZHBvaW50IHdpdGggZW5kcG9pbnQgc3RyaW5nCiAgICovCiAgdXBkYXRlRW5kcG9pbnQ6IGZ1bmN0aW9uIHVwZGF0ZUVuZHBvaW50KGVuZHBvaW50U3RyKSB7CiAgICB2YXIgbmV3RW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50U3RyKTsKICAgIHRoaXMuZW5kcG9pbnQgPSBuZXdFbmRwb2ludDsKICAgIHRoaXMucGF0aCA9IG5ld0VuZHBvaW50LnBhdGggfHwgJy8nOwogICAgaWYgKHRoaXMuaGVhZGVyc1snSG9zdCddKSB7CiAgICAgIHRoaXMuaGVhZGVyc1snSG9zdCddID0gbmV3RW5kcG9pbnQuaG9zdDsKICAgIH0KICB9Cn0pOwoKLyoqCiAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXNwb25zZSBvYmplY3QsIGVuY2Fwc3VsYXRpbmcgYWxsIEhUVFAgaGVhZGVyCiAqIGFuZCBib2R5IGRhdGEgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICoKICogQCFhdHRyaWJ1dGUgc3RhdHVzQ29kZQogKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZSAoZS5nLiwgMjAwLCA0MDQpCiAqIEAhYXR0cmlidXRlIGhlYWRlcnMKICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAqICAgICAgYSBtYXAgb2YgcmVzcG9uc2UgaGVhZGVyIGtleXMgYW5kIHRoZWlyIHJlc3BlY3RpdmUgdmFsdWVzCiAqIEAhYXR0cmlidXRlIGJvZHkKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXNwb25zZSBib2R5IHBheWxvYWQKICogQCFhdHRyaWJ1dGUgW3JdIHN0cmVhbWluZwogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhpcyByZXNwb25zZSBpcyBiZWluZyBzdHJlYW1lZCBhdCBhIGxvdy1sZXZlbC4KICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAgKGJ1ZmZlcmVkIHJlYWRzKS4gRG8gbm90IG1vZGlmeSB0aGlzIG1hbnVhbGx5LCB1c2UKICogICAgIHtjcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtfSB0byBjb252ZXJ0IHRoZSBzdHJlYW0gdG8gdW5idWZmZXJlZCBtb2RlCiAqICAgICBpbnN0ZWFkLgogKi8KQVdTLkh0dHBSZXNwb25zZSA9IGluaGVyaXQoewoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlc3BvbnNlKCkgewogICAgdGhpcy5zdGF0dXNDb2RlID0gdW5kZWZpbmVkOwogICAgdGhpcy5oZWFkZXJzID0ge307CiAgICB0aGlzLmJvZHkgPSB1bmRlZmluZWQ7CiAgICB0aGlzLnN0cmVhbWluZyA9IGZhbHNlOwogICAgdGhpcy5zdHJlYW0gPSBudWxsOwogIH0sCgogIC8qKgogICAqIERpc2FibGVzIGJ1ZmZlcmluZyBvbiB0aGUgSFRUUCByZXNwb25zZSBhbmQgcmV0dXJucyB0aGUgc3RyZWFtIGZvciByZWFkaW5nLgogICAqIEByZXR1cm4gW1N0cmVhbSwgWE1MSHR0cFJlcXVlc3QsIG51bGxdIHRoZSB1bmRlcmx5aW5nIHN0cmVhbSBvYmplY3QuCiAgICogICBVc2UgdGhpcyBvYmplY3QgdG8gZGlyZWN0bHkgcmVhZCBkYXRhIG9mZiBvZiB0aGUgc3RyZWFtLgogICAqIEBub3RlIFRoaXMgb2JqZWN0IGlzIG9ubHkgYXZhaWxhYmxlIGFmdGVyIHRoZSB7QVdTLlJlcXVlc3R+aHR0cEhlYWRlcnN9CiAgICogICBldmVudCBoYXMgZmlyZWQuIFRoaXMgbWV0aG9kIG11c3QgYmUgY2FsbGVkIHByaW9yIHRvCiAgICogICB7QVdTLlJlcXVlc3R+aHR0cERhdGF9LgogICAqIEBleGFtcGxlIFRha2luZyBjb250cm9sIG9mIGEgc3RyZWFtCiAgICogICByZXF1ZXN0Lm9uKCdodHRwSGVhZGVycycsIGZ1bmN0aW9uKHN0YXR1c0NvZGUsIGhlYWRlcnMpIHsKICAgKiAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgKiAgICAgICBpZiAoaGVhZGVycy5ldGFnID09PSAneHl6JykgewogICAqICAgICAgICAgLy8gcGlwZSB0aGUgc3RyZWFtLCBkaXNhYmxpbmcgYnVmZmVyaW5nCiAgICogICAgICAgICB2YXIgc3RyZWFtID0gdGhpcy5yZXNwb25zZS5odHRwUmVzcG9uc2UuY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpOwogICAqICAgICAgICAgc3RyZWFtLnBpcGUocHJvY2Vzcy5zdGRvdXQpOwogICAqICAgICAgIH0gZWxzZSB7IC8vIGFib3J0IHRoaXMgcmVxdWVzdCBhbmQgc2V0IGEgYmV0dGVyIGVycm9yIG1lc3NhZ2UKICAgKiAgICAgICAgIHRoaXMuYWJvcnQoKTsKICAgKiAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBuZXcgRXJyb3IoJ0ludmFsaWQgRVRhZycpOwogICAqICAgICAgIH0KICAgKiAgICAgfQogICAqICAgfSkuc2VuZChjb25zb2xlLmxvZyk7CiAgICovCiAgY3JlYXRlVW5idWZmZXJlZFN0cmVhbTogZnVuY3Rpb24gY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpIHsKICAgIHRoaXMuc3RyZWFtaW5nID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzLnN0cmVhbTsKICB9Cn0pOwoKCkFXUy5IdHRwQ2xpZW50ID0gaW5oZXJpdCh7fSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSA9IGZ1bmN0aW9uIGdldEluc3RhbmNlKCkgewogIGlmICh0aGlzLnNpbmdsZXRvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzLnNpbmdsZXRvbiA9IG5ldyB0aGlzKCk7CiAgfQogIHJldHVybiB0aGlzLnNpbmdsZXRvbjsKfTsKCn0seyIuL2NvcmUiOjE5fV0sMzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwpyZXF1aXJlKCcuLi9odHRwJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuWEhSQ2xpZW50ID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgaGFuZGxlUmVxdWVzdDogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGNhbGxiYWNrLCBlcnJDYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGVuZHBvaW50ID0gaHR0cFJlcXVlc3QuZW5kcG9pbnQ7CiAgICB2YXIgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKICAgIHZhciBocmVmID0gZW5kcG9pbnQucHJvdG9jb2wgKyAnLy8nICsgZW5kcG9pbnQuaG9zdG5hbWU7CiAgICBpZiAoZW5kcG9pbnQucG9ydCAhPT0gODAgJiYgZW5kcG9pbnQucG9ydCAhPT0gNDQzKSB7CiAgICAgIGhyZWYgKz0gJzonICsgZW5kcG9pbnQucG9ydDsKICAgIH0KICAgIGhyZWYgKz0gaHR0cFJlcXVlc3QucGF0aDsKCiAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCksIGhlYWRlcnNFbWl0dGVkID0gZmFsc2U7CiAgICBodHRwUmVxdWVzdC5zdHJlYW0gPSB4aHI7CgogICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMCkgcmV0dXJuOyAvLyAwIGNvZGUgaXMgaW52YWxpZAogICAgICB9IGNhdGNoIChlKSB7IHJldHVybjsgfQoKICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA+PSB0aGlzLkhFQURFUlNfUkVDRUlWRUQgJiYgIWhlYWRlcnNFbWl0dGVkKSB7CiAgICAgICAgZW1pdHRlci5zdGF0dXNDb2RlID0geGhyLnN0YXR1czsKICAgICAgICBlbWl0dGVyLmhlYWRlcnMgPSBzZWxmLnBhcnNlSGVhZGVycyh4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkpOwogICAgICAgIGVtaXR0ZXIuZW1pdCgKICAgICAgICAgICdoZWFkZXJzJywKICAgICAgICAgIGVtaXR0ZXIuc3RhdHVzQ29kZSwKICAgICAgICAgIGVtaXR0ZXIuaGVhZGVycywKICAgICAgICAgIHhoci5zdGF0dXNUZXh0CiAgICAgICAgKTsKICAgICAgICBoZWFkZXJzRW1pdHRlZCA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PT0gdGhpcy5ET05FKSB7CiAgICAgICAgc2VsZi5maW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcik7CiAgICAgIH0KICAgIH0sIGZhbHNlKTsKICAgIHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgIGVtaXR0ZXIuZW1pdCgnc2VuZFByb2dyZXNzJywgZXZ0KTsKICAgIH0pOwogICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2dCkgewogICAgICBlbWl0dGVyLmVtaXQoJ3JlY2VpdmVQcm9ncmVzcycsIGV2dCk7CiAgICB9LCBmYWxzZSk7CiAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigndGltZW91dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdUaW1lb3V0JyksIHtjb2RlOiAnVGltZW91dEVycm9yJ30pKTsKICAgIH0sIGZhbHNlKTsKICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdOZXR3b3JrIEZhaWx1cmUnKSwgewogICAgICAgIGNvZGU6ICdOZXR3b3JraW5nRXJyb3InCiAgICAgIH0pKTsKICAgIH0sIGZhbHNlKTsKICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdhYm9ydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQnKSwgewogICAgICAgIGNvZGU6ICdSZXF1ZXN0QWJvcnRlZEVycm9yJwogICAgICB9KSk7CiAgICB9LCBmYWxzZSk7CgogICAgY2FsbGJhY2soZW1pdHRlcik7CiAgICB4aHIub3BlbihodHRwUmVxdWVzdC5tZXRob2QsIGhyZWYsIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSk7CiAgICBBV1MudXRpbC5lYWNoKGh0dHBSZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgIT09ICdDb250ZW50LUxlbmd0aCcgJiYga2V5ICE9PSAnVXNlci1BZ2VudCcgJiYga2V5ICE9PSAnSG9zdCcpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgfQogICAgfSk7CgogICAgaWYgKGh0dHBPcHRpb25zLnRpbWVvdXQgJiYgaHR0cE9wdGlvbnMueGhyQXN5bmMgIT09IGZhbHNlKSB7CiAgICAgIHhoci50aW1lb3V0ID0gaHR0cE9wdGlvbnMudGltZW91dDsKICAgIH0KCiAgICBpZiAoaHR0cE9wdGlvbnMueGhyV2l0aENyZWRlbnRpYWxzKSB7CiAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgfQogICAgdHJ5IHsgeGhyLnJlc3BvbnNlVHlwZSA9ICdhcnJheWJ1ZmZlcic7IH0gY2F0Y2ggKGUpIHt9CgogICAgdHJ5IHsKICAgICAgaWYgKGh0dHBSZXF1ZXN0LmJvZHkpIHsKICAgICAgICB4aHIuc2VuZChodHRwUmVxdWVzdC5ib2R5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB4aHIuc2VuZCgpOwogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgaWYgKGh0dHBSZXF1ZXN0LmJvZHkgJiYgdHlwZW9mIGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyID09PSAnb2JqZWN0JykgewogICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyKTsgLy8gc2VuZCBBcnJheUJ1ZmZlciBkaXJlY3RseQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IGVycjsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBlbWl0dGVyOwogIH0sCgogIHBhcnNlSGVhZGVyczogZnVuY3Rpb24gcGFyc2VIZWFkZXJzKHJhd0hlYWRlcnMpIHsKICAgIHZhciBoZWFkZXJzID0ge307CiAgICBBV1MudXRpbC5hcnJheUVhY2gocmF3SGVhZGVycy5zcGxpdCgvXHI/XG4vKSwgZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgdmFyIGtleSA9IGxpbmUuc3BsaXQoJzonLCAxKVswXTsKICAgICAgdmFyIHZhbHVlID0gbGluZS5zdWJzdHJpbmcoa2V5Lmxlbmd0aCArIDIpOwogICAgICBpZiAoa2V5Lmxlbmd0aCA+IDApIGhlYWRlcnNba2V5LnRvTG93ZXJDYXNlKCldID0gdmFsdWU7CiAgICB9KTsKICAgIHJldHVybiBoZWFkZXJzOwogIH0sCgogIGZpbmlzaFJlcXVlc3Q6IGZ1bmN0aW9uIGZpbmlzaFJlcXVlc3QoeGhyLCBlbWl0dGVyKSB7CiAgICB2YXIgYnVmZmVyOwogICAgaWYgKHhoci5yZXNwb25zZVR5cGUgPT09ICdhcnJheWJ1ZmZlcicgJiYgeGhyLnJlc3BvbnNlKSB7CiAgICAgIHZhciBhYiA9IHhoci5yZXNwb25zZTsKICAgICAgYnVmZmVyID0gbmV3IEFXUy51dGlsLkJ1ZmZlcihhYi5ieXRlTGVuZ3RoKTsKICAgICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShhYik7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYnVmZmVyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgYnVmZmVyW2ldID0gdmlld1tpXTsKICAgICAgfQogICAgfQoKICAgIHRyeSB7CiAgICAgIGlmICghYnVmZmVyICYmIHR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoeGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgaWYgKGJ1ZmZlcikgZW1pdHRlci5lbWl0KCdkYXRhJywgYnVmZmVyKTsKICAgIGVtaXR0ZXIuZW1pdCgnZW5kJyk7CiAgfQp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5IdHRwQ2xpZW50LnByb3RvdHlwZSA9IEFXUy5YSFJDbGllbnQucHJvdG90eXBlOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPSAxOwoKfSx7Ii4uL2NvcmUiOjE5LCIuLi9odHRwIjozNSwiZXZlbnRzIjo4NX1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CgpmdW5jdGlvbiBKc29uQnVpbGRlcigpIHsgfQoKSnNvbkJ1aWxkZXIucHJvdG90eXBlLmJ1aWxkID0gZnVuY3Rpb24odmFsdWUsIHNoYXBlKSB7CiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpKTsKfTsKCmZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICBpZiAoIXNoYXBlIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CgogIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHRyYW5zbGF0ZVN0cnVjdHVyZSh2YWx1ZSwgc2hhcGUpOwogICAgY2FzZSAnbWFwJzogcmV0dXJuIHRyYW5zbGF0ZU1hcCh2YWx1ZSwgc2hhcGUpOwogICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICBkZWZhdWx0OiByZXR1cm4gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSk7CiAgfQp9CgpmdW5jdGlvbiB0cmFuc2xhdGVTdHJ1Y3R1cmUoc3RydWN0dXJlLCBzaGFwZSkgewogIGlmIChzaGFwZS5pc0RvY3VtZW50KSB7CiAgICByZXR1cm4gc3RydWN0dXJlOwogIH0KICB2YXIgc3RydWN0ID0ge307CiAgdXRpbC5lYWNoKHN0cnVjdHVyZSwgZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICBpZiAobWVtYmVyU2hhcGUpIHsKICAgICAgaWYgKG1lbWJlclNoYXBlLmxvY2F0aW9uICE9PSAnYm9keScpIHJldHVybjsKICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBzdHJ1Y3RbbG9jYXRpb25OYW1lXSA9IHJlc3VsdDsKICAgIH0KICB9KTsKICByZXR1cm4gc3RydWN0Owp9CgpmdW5jdGlvbiB0cmFuc2xhdGVMaXN0KGxpc3QsIHNoYXBlKSB7CiAgdmFyIG91dCA9IFtdOwogIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXQucHVzaChyZXN1bHQpOwogIH0pOwogIHJldHVybiBvdXQ7Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgdmFyIG91dCA9IHt9OwogIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgb3V0W2tleV0gPSByZXN1bHQ7CiAgfSk7CiAgcmV0dXJuIG91dDsKfQoKZnVuY3Rpb24gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSkgewogIHJldHVybiBzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEpzb25CdWlsZGVyOwoKfSx7Ii4uL3V0aWwiOjcyfV0sMzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKCmZ1bmN0aW9uIEpzb25QYXJzZXIoKSB7IH0KCkpzb25QYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24odmFsdWUsIHNoYXBlKSB7CiAgcmV0dXJuIHRyYW5zbGF0ZShKU09OLnBhcnNlKHZhbHVlKSwgc2hhcGUpOwp9OwoKZnVuY3Rpb24gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkgewogIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKCiAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICBjYXNlICdtYXAnOiByZXR1cm4gdHJhbnNsYXRlTWFwKHZhbHVlLCBzaGFwZSk7CiAgICBjYXNlICdsaXN0JzogcmV0dXJuIHRyYW5zbGF0ZUxpc3QodmFsdWUsIHNoYXBlKTsKICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICB9Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZVN0cnVjdHVyZShzdHJ1Y3R1cmUsIHNoYXBlKSB7CiAgaWYgKHN0cnVjdHVyZSA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogIGlmIChzaGFwZS5pc0RvY3VtZW50KSByZXR1cm4gc3RydWN0dXJlOwoKICB2YXIgc3RydWN0ID0ge307CiAgdmFyIHNoYXBlTWVtYmVycyA9IHNoYXBlLm1lbWJlcnM7CiAgdXRpbC5lYWNoKHNoYXBlTWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdHJ1Y3R1cmUsIGxvY2F0aW9uTmFtZSkpIHsKICAgICAgdmFyIHZhbHVlID0gc3RydWN0dXJlW2xvY2F0aW9uTmFtZV07CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBzdHJ1Y3RbbmFtZV0gPSByZXN1bHQ7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHN0cnVjdDsKfQoKZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CgogIHZhciBvdXQgPSBbXTsKICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgb3V0LnB1c2gobnVsbCk7CiAgICBlbHNlIG91dC5wdXNoKHJlc3VsdCk7CiAgfSk7CiAgcmV0dXJuIG91dDsKfQoKZnVuY3Rpb24gdHJhbnNsYXRlTWFwKG1hcCwgc2hhcGUpIHsKICBpZiAobWFwID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CgogIHZhciBvdXQgPSB7fTsKICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dFtrZXldID0gbnVsbDsKICAgIGVsc2Ugb3V0W2tleV0gPSByZXN1bHQ7CiAgfSk7CiAgcmV0dXJuIG91dDsKfQoKZnVuY3Rpb24gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSkgewogIHJldHVybiBzaGFwZS50b1R5cGUodmFsdWUpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEpzb25QYXJzZXI7Cgp9LHsiLi4vdXRpbCI6NzJ9XSwzOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7CnZhciBPcGVyYXRpb24gPSByZXF1aXJlKCcuL29wZXJhdGlvbicpOwp2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7CnZhciBQYWdpbmF0b3IgPSByZXF1aXJlKCcuL3BhZ2luYXRvcicpOwp2YXIgUmVzb3VyY2VXYWl0ZXIgPSByZXF1aXJlKCcuL3Jlc291cmNlX3dhaXRlcicpOwp2YXIgbWV0YWRhdGEgPSByZXF1aXJlKCcuLi8uLi9hcGlzL21ldGFkYXRhLmpzb24nKTsKCnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5Owp2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKCmZ1bmN0aW9uIEFwaShhcGksIG9wdGlvbnMpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgYXBpID0gYXBpIHx8IHt9OwogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIG9wdGlvbnMuYXBpID0gdGhpczsKCiAgYXBpLm1ldGFkYXRhID0gYXBpLm1ldGFkYXRhIHx8IHt9OwoKICB2YXIgc2VydmljZUlkZW50aWZpZXIgPSBvcHRpb25zLnNlcnZpY2VJZGVudGlmaWVyOwogIGRlbGV0ZSBvcHRpb25zLnNlcnZpY2VJZGVudGlmaWVyOwoKICBwcm9wZXJ0eSh0aGlzLCAnaXNBcGknLCB0cnVlLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2FwaVZlcnNpb24nLCBhcGkubWV0YWRhdGEuYXBpVmVyc2lvbik7CiAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50UHJlZml4JywgYXBpLm1ldGFkYXRhLmVuZHBvaW50UHJlZml4KTsKICBwcm9wZXJ0eSh0aGlzLCAnc2lnbmluZ05hbWUnLCBhcGkubWV0YWRhdGEuc2lnbmluZ05hbWUpOwogIHByb3BlcnR5KHRoaXMsICdnbG9iYWxFbmRwb2ludCcsIGFwaS5tZXRhZGF0YS5nbG9iYWxFbmRwb2ludCk7CiAgcHJvcGVydHkodGhpcywgJ3NpZ25hdHVyZVZlcnNpb24nLCBhcGkubWV0YWRhdGEuc2lnbmF0dXJlVmVyc2lvbik7CiAgcHJvcGVydHkodGhpcywgJ2pzb25WZXJzaW9uJywgYXBpLm1ldGFkYXRhLmpzb25WZXJzaW9uKTsKICBwcm9wZXJ0eSh0aGlzLCAndGFyZ2V0UHJlZml4JywgYXBpLm1ldGFkYXRhLnRhcmdldFByZWZpeCk7CiAgcHJvcGVydHkodGhpcywgJ3Byb3RvY29sJywgYXBpLm1ldGFkYXRhLnByb3RvY29sKTsKICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgYXBpLm1ldGFkYXRhLnRpbWVzdGFtcEZvcm1hdCk7CiAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIGFwaS5tZXRhZGF0YS54bWxOYW1lc3BhY2UpOwogIHByb3BlcnR5KHRoaXMsICdhYmJyZXZpYXRpb24nLCBhcGkubWV0YWRhdGEuc2VydmljZUFiYnJldmlhdGlvbik7CiAgcHJvcGVydHkodGhpcywgJ2Z1bGxOYW1lJywgYXBpLm1ldGFkYXRhLnNlcnZpY2VGdWxsTmFtZSk7CiAgcHJvcGVydHkodGhpcywgJ3NlcnZpY2VJZCcsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlSWQpOwogIGlmIChzZXJ2aWNlSWRlbnRpZmllciAmJiBtZXRhZGF0YVtzZXJ2aWNlSWRlbnRpZmllcl0pIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3htbE5vRGVmYXVsdExpc3RzJywgbWV0YWRhdGFbc2VydmljZUlkZW50aWZpZXJdLnhtbE5vRGVmYXVsdExpc3RzLCBmYWxzZSk7CiAgfQoKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdjbGFzc05hbWUnLCBmdW5jdGlvbigpIHsKICAgIHZhciBuYW1lID0gYXBpLm1ldGFkYXRhLnNlcnZpY2VBYmJyZXZpYXRpb24gfHwgYXBpLm1ldGFkYXRhLnNlcnZpY2VGdWxsTmFtZTsKICAgIGlmICghbmFtZSkgcmV0dXJuIG51bGw7CgogICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvXkFtYXpvbnxBV1Nccyp8XCguKnxccyt8XFcrL2csICcnKTsKICAgIGlmIChuYW1lID09PSAnRWxhc3RpY0xvYWRCYWxhbmNpbmcnKSBuYW1lID0gJ0VMQic7CiAgICByZXR1cm4gbmFtZTsKICB9KTsKCiAgZnVuY3Rpb24gYWRkRW5kcG9pbnRPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uKSB7CiAgICBpZiAob3BlcmF0aW9uLmVuZHBvaW50b3BlcmF0aW9uID09PSB0cnVlKSB7CiAgICAgIHByb3BlcnR5KHNlbGYsICdlbmRwb2ludE9wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QobmFtZSkpOwogICAgfQogICAgaWYgKG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeSAmJiAhc2VsZi5oYXNSZXF1aXJlZEVuZHBvaW50RGlzY292ZXJ5KSB7CiAgICAgIHByb3BlcnR5KAogICAgICAgIHNlbGYsCiAgICAgICAgJ2hhc1JlcXVpcmVkRW5kcG9pbnREaXNjb3ZlcnknLAogICAgICAgIG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeS5yZXF1aXJlZCA9PT0gdHJ1ZQogICAgICApOwogICAgfQogIH0KCiAgcHJvcGVydHkodGhpcywgJ29wZXJhdGlvbnMnLCBuZXcgQ29sbGVjdGlvbihhcGkub3BlcmF0aW9ucywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgb3BlcmF0aW9uKSB7CiAgICByZXR1cm4gbmV3IE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24sIG9wdGlvbnMpOwogIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QsIGFkZEVuZHBvaW50T3BlcmF0aW9uKSk7CgogIHByb3BlcnR5KHRoaXMsICdzaGFwZXMnLCBuZXcgQ29sbGVjdGlvbihhcGkuc2hhcGVzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBzaGFwZSkgewogICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZSwgb3B0aW9ucyk7CiAgfSkpOwoKICBwcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9ycycsIG5ldyBDb2xsZWN0aW9uKGFwaS5wYWdpbmF0b3JzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBwYWdpbmF0b3IpIHsKICAgIHJldHVybiBuZXcgUGFnaW5hdG9yKG5hbWUsIHBhZ2luYXRvciwgb3B0aW9ucyk7CiAgfSkpOwoKICBwcm9wZXJ0eSh0aGlzLCAnd2FpdGVycycsIG5ldyBDb2xsZWN0aW9uKGFwaS53YWl0ZXJzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCB3YWl0ZXIpIHsKICAgIHJldHVybiBuZXcgUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKTsKICB9LCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KSk7CgogIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgYXBpLmRvY3VtZW50YXRpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb25VcmwnLCBhcGkuZG9jdW1lbnRhdGlvblVybCk7CiAgfQogIHByb3BlcnR5KHRoaXMsICdlcnJvckNvZGVNYXBwaW5nJywgYXBpLmF3c1F1ZXJ5Q29tcGF0aWJsZSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQXBpOwoKfSx7Ii4uLy4uL2FwaXMvbWV0YWRhdGEuanNvbiI6NCwiLi4vdXRpbCI6NzIsIi4vY29sbGVjdGlvbiI6NDAsIi4vb3BlcmF0aW9uIjo0MSwiLi9wYWdpbmF0b3IiOjQyLCIuL3Jlc291cmNlX3dhaXRlciI6NDMsIi4vc2hhcGUiOjQ0fV0sNDA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5tZW1vaXplZFByb3BlcnR5OwoKZnVuY3Rpb24gbWVtb2l6ZShuYW1lLCB2YWx1ZSwgZmFjdG9yeSwgbmFtZVRyKSB7CiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCBuYW1lVHIobmFtZSksIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWUpOwogIH0pOwp9CgpmdW5jdGlvbiBDb2xsZWN0aW9uKGl0ZXJhYmxlLCBvcHRpb25zLCBmYWN0b3J5LCBuYW1lVHIsIGNhbGxiYWNrKSB7CiAgbmFtZVRyID0gbmFtZVRyIHx8IFN0cmluZzsKICB2YXIgc2VsZiA9IHRoaXM7CgogIGZvciAodmFyIGlkIGluIGl0ZXJhYmxlKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpZCkpIHsKICAgICAgbWVtb2l6ZS5jYWxsKHNlbGYsIGlkLCBpdGVyYWJsZVtpZF0sIGZhY3RvcnksIG5hbWVUcik7CiAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soaWQsIGl0ZXJhYmxlW2lkXSk7CiAgICB9CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IENvbGxlY3Rpb247Cgp9LHsiLi4vdXRpbCI6NzJ9XSw0MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBTaGFwZSA9IHJlcXVpcmUoJy4vc2hhcGUnKTsKCnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5Owp2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKCmZ1bmN0aW9uIE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24sIG9wdGlvbnMpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIHByb3BlcnR5KHRoaXMsICduYW1lJywgb3BlcmF0aW9uLm5hbWUgfHwgbmFtZSk7CiAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CgogIG9wZXJhdGlvbi5odHRwID0gb3BlcmF0aW9uLmh0dHAgfHwge307CiAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50Jywgb3BlcmF0aW9uLmVuZHBvaW50KTsKICBwcm9wZXJ0eSh0aGlzLCAnaHR0cE1ldGhvZCcsIG9wZXJhdGlvbi5odHRwLm1ldGhvZCB8fCAnUE9TVCcpOwogIHByb3BlcnR5KHRoaXMsICdodHRwUGF0aCcsIG9wZXJhdGlvbi5odHRwLnJlcXVlc3RVcmkgfHwgJy8nKTsKICBwcm9wZXJ0eSh0aGlzLCAnYXV0aHR5cGUnLCBvcGVyYXRpb24uYXV0aHR5cGUgfHwgJycpOwogIHByb3BlcnR5KAogICAgdGhpcywKICAgICdlbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkJywKICAgIG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeSA/CiAgICAgIChvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkucmVxdWlyZWQgPyAnUkVRVUlSRUQnIDogJ09QVElPTkFMJykgOgogICAgJ05VTEwnCiAgKTsKCiAgLy8gaHR0cENoZWNrc3VtIHJlcGxhY2VzIHVzYWdlIG9mIGh0dHBDaGVja3N1bVJlcXVpcmVkLCBidXQgc29tZSBBUElzCiAgLy8gKHMzY29udHJvbCkgc3RpbGwgdXNlcyBvbGQgdHJhaXQuCiAgdmFyIGh0dHBDaGVja3N1bVJlcXVpcmVkID0gb3BlcmF0aW9uLmh0dHBDaGVja3N1bVJlcXVpcmVkCiAgICB8fCAob3BlcmF0aW9uLmh0dHBDaGVja3N1bSAmJiBvcGVyYXRpb24uaHR0cENoZWNrc3VtLnJlcXVlc3RDaGVja3N1bVJlcXVpcmVkKTsKICBwcm9wZXJ0eSh0aGlzLCAnaHR0cENoZWNrc3VtUmVxdWlyZWQnLCBodHRwQ2hlY2tzdW1SZXF1aXJlZCwgZmFsc2UpOwoKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdpbnB1dCcsIGZ1bmN0aW9uKCkgewogICAgaWYgKCFvcGVyYXRpb24uaW5wdXQpIHsKICAgICAgcmV0dXJuIG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSwgb3B0aW9ucyk7CiAgICB9CiAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5pbnB1dCwgb3B0aW9ucyk7CiAgfSk7CgogIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ291dHB1dCcsIGZ1bmN0aW9uKCkgewogICAgaWYgKCFvcGVyYXRpb24ub3V0cHV0KSB7CiAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShvcGVyYXRpb24ub3V0cHV0LCBvcHRpb25zKTsKICB9KTsKCiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXJyb3JzJywgZnVuY3Rpb24oKSB7CiAgICB2YXIgbGlzdCA9IFtdOwogICAgaWYgKCFvcGVyYXRpb24uZXJyb3JzKSByZXR1cm4gbnVsbDsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wZXJhdGlvbi5lcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgbGlzdC5wdXNoKFNoYXBlLmNyZWF0ZShvcGVyYXRpb24uZXJyb3JzW2ldLCBvcHRpb25zKSk7CiAgICB9CgogICAgcmV0dXJuIGxpc3Q7CiAgfSk7CgogIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ3BhZ2luYXRvcicsIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG9wdGlvbnMuYXBpLnBhZ2luYXRvcnNbbmFtZV07CiAgfSk7CgogIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb25VcmwnLCBvcGVyYXRpb24uZG9jdW1lbnRhdGlvblVybCk7CiAgfQoKICAvLyBpZGVtcG90ZW50TWVtYmVycyBvbmx5IHRyYWNrcyB0b3AtbGV2ZWwgaW5wdXQgc2hhcGVzCiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaWRlbXBvdGVudE1lbWJlcnMnLCBmdW5jdGlvbigpIHsKICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IFtdOwogICAgdmFyIGlucHV0ID0gc2VsZi5pbnB1dDsKICAgIHZhciBtZW1iZXJzID0gaW5wdXQubWVtYmVyczsKICAgIGlmICghaW5wdXQubWVtYmVycykgewogICAgICByZXR1cm4gaWRlbXBvdGVudE1lbWJlcnM7CiAgICB9CiAgICBmb3IgKHZhciBuYW1lIGluIG1lbWJlcnMpIHsKICAgICAgaWYgKCFtZW1iZXJzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKG1lbWJlcnNbbmFtZV0uaXNJZGVtcG90ZW50ID09PSB0cnVlKSB7CiAgICAgICAgaWRlbXBvdGVudE1lbWJlcnMucHVzaChuYW1lKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGlkZW1wb3RlbnRNZW1iZXJzOwogIH0pOwoKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdoYXNFdmVudE91dHB1dCcsIGZ1bmN0aW9uKCkgewogICAgdmFyIG91dHB1dCA9IHNlbGYub3V0cHV0OwogICAgcmV0dXJuIGhhc0V2ZW50U3RyZWFtKG91dHB1dCk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGhhc0V2ZW50U3RyZWFtKHRvcExldmVsU2hhcGUpIHsKICB2YXIgbWVtYmVycyA9IHRvcExldmVsU2hhcGUubWVtYmVyczsKICB2YXIgcGF5bG9hZCA9IHRvcExldmVsU2hhcGUucGF5bG9hZDsKCiAgaWYgKCF0b3BMZXZlbFNoYXBlLm1lbWJlcnMpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGlmIChwYXlsb2FkKSB7CiAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG1lbWJlcnNbcGF5bG9hZF07CiAgICByZXR1cm4gcGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtOwogIH0KCiAgLy8gY2hlY2sgaWYgYW55IG1lbWJlciBpcyBhbiBldmVudCBzdHJlYW0KICBmb3IgKHZhciBuYW1lIGluIG1lbWJlcnMpIHsKICAgIGlmICghbWVtYmVycy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0V2ZW50U3RyZWFtID09PSB0cnVlKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IE9wZXJhdGlvbjsKCn0seyIuLi91dGlsIjo3MiwiLi9zaGFwZSI6NDR9XSw0MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBwcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5wcm9wZXJ0eTsKCmZ1bmN0aW9uIFBhZ2luYXRvcihuYW1lLCBwYWdpbmF0b3IpIHsKICBwcm9wZXJ0eSh0aGlzLCAnaW5wdXRUb2tlbicsIHBhZ2luYXRvci5pbnB1dF90b2tlbik7CiAgcHJvcGVydHkodGhpcywgJ2xpbWl0S2V5JywgcGFnaW5hdG9yLmxpbWl0X2tleSk7CiAgcHJvcGVydHkodGhpcywgJ21vcmVSZXN1bHRzJywgcGFnaW5hdG9yLm1vcmVfcmVzdWx0cyk7CiAgcHJvcGVydHkodGhpcywgJ291dHB1dFRva2VuJywgcGFnaW5hdG9yLm91dHB1dF90b2tlbik7CiAgcHJvcGVydHkodGhpcywgJ3Jlc3VsdEtleScsIHBhZ2luYXRvci5yZXN1bHRfa2V5KTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBQYWdpbmF0b3I7Cgp9LHsiLi4vdXRpbCI6NzJ9XSw0MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5OwoKZnVuY3Rpb24gUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgcHJvcGVydHkodGhpcywgJ25hbWUnLCBuYW1lKTsKICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKCiAgaWYgKHdhaXRlci5vcGVyYXRpb24pIHsKICAgIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb24nLCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KHdhaXRlci5vcGVyYXRpb24pKTsKICB9CgogIHZhciBzZWxmID0gdGhpczsKICB2YXIga2V5cyA9IFsKICAgICd0eXBlJywKICAgICdkZXNjcmlwdGlvbicsCiAgICAnZGVsYXknLAogICAgJ21heEF0dGVtcHRzJywKICAgICdhY2NlcHRvcnMnCiAgXTsKCiAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgdmFyIHZhbHVlID0gd2FpdGVyW2tleV07CiAgICBpZiAodmFsdWUpIHsKICAgICAgcHJvcGVydHkoc2VsZiwga2V5LCB2YWx1ZSk7CiAgICB9CiAgfSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gUmVzb3VyY2VXYWl0ZXI7Cgp9LHsiLi4vdXRpbCI6NzJ9XSw0NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7Cgp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKCmZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUpIHsKICBpZiAodmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgdXRpbC5wcm9wZXJ0eS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KfQoKZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUpIHsKICBpZiAoIW9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGVbbmFtZV0pIHsKICAgIHV0aWwubWVtb2l6ZWRQcm9wZXJ0eS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KfQoKZnVuY3Rpb24gU2hhcGUoc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgcHJvcGVydHkodGhpcywgJ3NoYXBlJywgc2hhcGUuc2hhcGUpOwogIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICd0eXBlJywgc2hhcGUudHlwZSk7CiAgcHJvcGVydHkodGhpcywgJ2VudW0nLCBzaGFwZS5lbnVtKTsKICBwcm9wZXJ0eSh0aGlzLCAnbWluJywgc2hhcGUubWluKTsKICBwcm9wZXJ0eSh0aGlzLCAnbWF4Jywgc2hhcGUubWF4KTsKICBwcm9wZXJ0eSh0aGlzLCAncGF0dGVybicsIHNoYXBlLnBhdHRlcm4pOwogIHByb3BlcnR5KHRoaXMsICdsb2NhdGlvbicsIHNoYXBlLmxvY2F0aW9uIHx8IHRoaXMubG9jYXRpb24gfHwgJ2JvZHknKTsKICBwcm9wZXJ0eSh0aGlzLCAnbmFtZScsIHRoaXMubmFtZSB8fCBzaGFwZS54bWxOYW1lIHx8IHNoYXBlLnF1ZXJ5TmFtZSB8fAogICAgc2hhcGUubG9jYXRpb25OYW1lIHx8IG1lbWJlck5hbWUpOwogIHByb3BlcnR5KHRoaXMsICdpc1N0cmVhbWluZycsIHNoYXBlLnN0cmVhbWluZyB8fCB0aGlzLmlzU3RyZWFtaW5nIHx8IGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZXNMZW5ndGgnLCBzaGFwZS5yZXF1aXJlc0xlbmd0aCwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc0NvbXBvc2l0ZScsIHNoYXBlLmlzQ29tcG9zaXRlIHx8IGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNTaGFwZScsIHRydWUsIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNRdWVyeU5hbWUnLCBCb29sZWFuKHNoYXBlLnF1ZXJ5TmFtZSksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNMb2NhdGlvbk5hbWUnLCBCb29sZWFuKHNoYXBlLmxvY2F0aW9uTmFtZSksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNJZGVtcG90ZW50Jywgc2hhcGUuaWRlbXBvdGVuY3lUb2tlbiA9PT0gdHJ1ZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzSnNvblZhbHVlJywgc2hhcGUuanNvbnZhbHVlID09PSB0cnVlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNTZW5zaXRpdmUnLCBzaGFwZS5zZW5zaXRpdmUgPT09IHRydWUgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5zZW5zaXRpdmUgPT09IHRydWUpOwogIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50U3RyZWFtJywgQm9vbGVhbihzaGFwZS5ldmVudHN0cmVhbSksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudCcsIEJvb2xlYW4oc2hhcGUuZXZlbnQpLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRQYXlsb2FkJywgQm9vbGVhbihzaGFwZS5ldmVudHBheWxvYWQpLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRIZWFkZXInLCBCb29sZWFuKHNoYXBlLmV2ZW50aGVhZGVyKSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc1RpbWVzdGFtcEZvcm1hdFNldCcsIEJvb2xlYW4oc2hhcGUudGltZXN0YW1wRm9ybWF0KSB8fCBzaGFwZS5wcm90b3R5cGUgJiYgc2hhcGUucHJvdG90eXBlLmlzVGltZXN0YW1wRm9ybWF0U2V0ID09PSB0cnVlLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50RGlzY292ZXJ5SWQnLCBCb29sZWFuKHNoYXBlLmVuZHBvaW50ZGlzY292ZXJ5aWQpLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2hvc3RMYWJlbCcsIEJvb2xlYW4oc2hhcGUuaG9zdExhYmVsKSwgZmFsc2UpOwoKICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvbicsIHNoYXBlLmRvY3VtZW50YXRpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb25VcmwnLCBzaGFwZS5kb2N1bWVudGF0aW9uVXJsKTsKICB9CgogIGlmIChzaGFwZS54bWxBdHRyaWJ1dGUpIHsKICAgIHByb3BlcnR5KHRoaXMsICdpc1htbEF0dHJpYnV0ZScsIHNoYXBlLnhtbEF0dHJpYnV0ZSB8fCBmYWxzZSk7CiAgfQoKICAvLyB0eXBlIGNvbnZlcnNpb24gYW5kIHBhcnNpbmcKICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgbnVsbCk7CiAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiAnJzsKICAgIHJldHVybiB2YWx1ZTsKICB9OwogIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9Owp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpTaGFwZS5ub3JtYWxpemVkVHlwZXMgPSB7CiAgY2hhcmFjdGVyOiAnc3RyaW5nJywKICBkb3VibGU6ICdmbG9hdCcsCiAgbG9uZzogJ2ludGVnZXInLAogIHNob3J0OiAnaW50ZWdlcicsCiAgYmlnaW50ZWdlcjogJ2ludGVnZXInLAogIGJpZ2RlY2ltYWw6ICdmbG9hdCcsCiAgYmxvYjogJ2JpbmFyeScKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovClNoYXBlLnR5cGVzID0gewogICdzdHJ1Y3R1cmUnOiBTdHJ1Y3R1cmVTaGFwZSwKICAnbGlzdCc6IExpc3RTaGFwZSwKICAnbWFwJzogTWFwU2hhcGUsCiAgJ2Jvb2xlYW4nOiBCb29sZWFuU2hhcGUsCiAgJ3RpbWVzdGFtcCc6IFRpbWVzdGFtcFNoYXBlLAogICdmbG9hdCc6IEZsb2F0U2hhcGUsCiAgJ2ludGVnZXInOiBJbnRlZ2VyU2hhcGUsCiAgJ3N0cmluZyc6IFN0cmluZ1NoYXBlLAogICdiYXNlNjQnOiBCYXNlNjRTaGFwZSwKICAnYmluYXJ5JzogQmluYXJ5U2hhcGUKfTsKClNoYXBlLnJlc29sdmUgPSBmdW5jdGlvbiByZXNvbHZlKHNoYXBlLCBvcHRpb25zKSB7CiAgaWYgKHNoYXBlLnNoYXBlKSB7CiAgICB2YXIgcmVmU2hhcGUgPSBvcHRpb25zLmFwaS5zaGFwZXNbc2hhcGUuc2hhcGVdOwogICAgaWYgKCFyZWZTaGFwZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHNoYXBlIHJlZmVyZW5jZTogJyArIHNoYXBlLnNoYXBlKTsKICAgIH0KCiAgICByZXR1cm4gcmVmU2hhcGU7CiAgfSBlbHNlIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKClNoYXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogIGlmIChzaGFwZS5pc1NoYXBlKSByZXR1cm4gc2hhcGU7CgogIHZhciByZWZTaGFwZSA9IFNoYXBlLnJlc29sdmUoc2hhcGUsIG9wdGlvbnMpOwogIGlmIChyZWZTaGFwZSkgewogICAgdmFyIGZpbHRlcmVkS2V5cyA9IE9iamVjdC5rZXlzKHNoYXBlKTsKICAgIGlmICghb3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIGZpbHRlcmVkS2V5cyA9IGZpbHRlcmVkS2V5cy5maWx0ZXIoZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiAhbmFtZS5tYXRjaCgvZG9jdW1lbnRhdGlvbi8pOwogICAgICB9KTsKICAgIH0KCiAgICAvLyBjcmVhdGUgYW4gaW5saW5lIHNoYXBlIHdpdGggZXh0cmEgbWVtYmVycwogICAgdmFyIElubGluZVNoYXBlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJlZlNoYXBlLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgfTsKICAgIElubGluZVNoYXBlLnByb3RvdHlwZSA9IHJlZlNoYXBlOwogICAgcmV0dXJuIG5ldyBJbmxpbmVTaGFwZSgpOwogIH0gZWxzZSB7CiAgICAvLyBzZXQgdHlwZSBpZiBub3Qgc2V0CiAgICBpZiAoIXNoYXBlLnR5cGUpIHsKICAgICAgaWYgKHNoYXBlLm1lbWJlcnMpIHNoYXBlLnR5cGUgPSAnc3RydWN0dXJlJzsKICAgICAgZWxzZSBpZiAoc2hhcGUubWVtYmVyKSBzaGFwZS50eXBlID0gJ2xpc3QnOwogICAgICBlbHNlIGlmIChzaGFwZS5rZXkpIHNoYXBlLnR5cGUgPSAnbWFwJzsKICAgICAgZWxzZSBzaGFwZS50eXBlID0gJ3N0cmluZyc7CiAgICB9CgogICAgLy8gbm9ybWFsaXplIHR5cGVzCiAgICB2YXIgb3JpZ1R5cGUgPSBzaGFwZS50eXBlOwogICAgaWYgKFNoYXBlLm5vcm1hbGl6ZWRUeXBlc1tzaGFwZS50eXBlXSkgewogICAgICBzaGFwZS50eXBlID0gU2hhcGUubm9ybWFsaXplZFR5cGVzW3NoYXBlLnR5cGVdOwogICAgfQoKICAgIGlmIChTaGFwZS50eXBlc1tzaGFwZS50eXBlXSkgewogICAgICByZXR1cm4gbmV3IFNoYXBlLnR5cGVzW3NoYXBlLnR5cGVdKHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIHNoYXBlIHR5cGU6ICcgKyBvcmlnVHlwZSk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gQ29tcG9zaXRlU2hhcGUoc2hhcGUpIHsKICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIHByb3BlcnR5KHRoaXMsICdpc0NvbXBvc2l0ZScsIHRydWUpOwoKICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZmxhdHRlbmVkJywgc2hhcGUuZmxhdHRlbmVkIHx8IGZhbHNlKTsKICB9Cn0KCmZ1bmN0aW9uIFN0cnVjdHVyZVNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHZhciByZXF1aXJlZE1hcCA9IG51bGwsIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CgogIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIGlmIChmaXJzdEluaXQpIHsKICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIHt9OyB9KTsKICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJzJywge30pOwogICAgcHJvcGVydHkodGhpcywgJ21lbWJlck5hbWVzJywgW10pOwogICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgW10pOwogICAgcHJvcGVydHkodGhpcywgJ2lzUmVxdWlyZWQnLCBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9KTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0RvY3VtZW50JywgQm9vbGVhbihzaGFwZS5kb2N1bWVudCkpOwogIH0KCiAgaWYgKHNoYXBlLm1lbWJlcnMpIHsKICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJzJywgbmV3IENvbGxlY3Rpb24oc2hhcGUubWVtYmVycywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUobWVtYmVyLCBvcHRpb25zLCBuYW1lKTsKICAgIH0pKTsKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ21lbWJlck5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzaGFwZS54bWxPcmRlciB8fCBPYmplY3Qua2V5cyhzaGFwZS5tZW1iZXJzKTsKICAgIH0pOwoKICAgIGlmIChzaGFwZS5ldmVudCkgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdldmVudFBheWxvYWRNZW1iZXJOYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG1lbWJlcnMgPSBzZWxmLm1lbWJlcnM7CiAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgcGF5bG9hZHMKICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG1lbWJlck5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRQYXlsb2FkKSB7CiAgICAgICAgICAgIHJldHVybiBtZW1iZXJOYW1lc1tpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXZlbnRIZWFkZXJNZW1iZXJOYW1lcycsIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgIHZhciBtZW1iZXJOYW1lcyA9IHNlbGYubWVtYmVyTmFtZXM7CiAgICAgICAgdmFyIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXMgPSBbXTsKICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgaGVhZGVycwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbWVtYmVyTmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAobWVtYmVyc1ttZW1iZXJOYW1lc1tpXV0uaXNFdmVudEhlYWRlcikgewogICAgICAgICAgICBldmVudEhlYWRlck1lbWJlck5hbWVzLnB1c2gobWVtYmVyTmFtZXNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZlbnRIZWFkZXJNZW1iZXJOYW1lczsKICAgICAgfSk7CiAgICB9CiAgfQoKICBpZiAoc2hhcGUucmVxdWlyZWQpIHsKICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlZCcsIHNoYXBlLnJlcXVpcmVkKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1JlcXVpcmVkJywgZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXJlcXVpcmVkTWFwKSB7CiAgICAgICAgcmVxdWlyZWRNYXAgPSB7fTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNoYXBlLnJlcXVpcmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXF1aXJlZE1hcFtzaGFwZS5yZXF1aXJlZFtpXV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlcXVpcmVkTWFwW25hbWVdOwogICAgfSwgZmFsc2UsIHRydWUpOwogIH0KCiAgcHJvcGVydHkodGhpcywgJ3Jlc3VsdFdyYXBwZXInLCBzaGFwZS5yZXN1bHRXcmFwcGVyIHx8IG51bGwpOwoKICBpZiAoc2hhcGUucGF5bG9hZCkgewogICAgcHJvcGVydHkodGhpcywgJ3BheWxvYWQnLCBzaGFwZS5wYXlsb2FkKTsKICB9CgogIGlmICh0eXBlb2Ygc2hhcGUueG1sTmFtZXNwYWNlID09PSAnc3RyaW5nJykgewogICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIHNoYXBlLnhtbE5hbWVzcGFjZSk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygc2hhcGUueG1sTmFtZXNwYWNlID09PSAnb2JqZWN0JykgewogICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVByZWZpeCcsIHNoYXBlLnhtbE5hbWVzcGFjZS5wcmVmaXgpOwogICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVVyaScsIHNoYXBlLnhtbE5hbWVzcGFjZS51cmkpOwogIH0KfQoKZnVuY3Rpb24gTGlzdFNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzLCBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIGlmIChmaXJzdEluaXQpIHsKICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIFtdOyB9KTsKICB9CgogIGlmIChzaGFwZS5tZW1iZXIpIHsKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ21lbWJlcicsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLm1lbWJlciwgb3B0aW9ucyk7CiAgICB9KTsKICB9CgogIGlmICh0aGlzLmZsYXR0ZW5lZCkgewogICAgdmFyIG9sZE5hbWUgPSB0aGlzLm5hbWU7CiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICduYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzZWxmLm1lbWJlci5uYW1lIHx8IG9sZE5hbWU7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIE1hcFNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgdmFyIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgaWYgKGZpcnN0SW5pdCkgewogICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgcHJvcGVydHkodGhpcywgJ2tleScsIFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cmluZyd9LCBvcHRpb25zKSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAndmFsdWUnLCBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJpbmcnfSwgb3B0aW9ucykpOwogIH0KCiAgaWYgKHNoYXBlLmtleSkgewogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAna2V5JywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUua2V5LCBvcHRpb25zKTsKICAgIH0pOwogIH0KICBpZiAoc2hhcGUudmFsdWUpIHsKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ3ZhbHVlJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUudmFsdWUsIG9wdGlvbnMpOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBUaW1lc3RhbXBTaGFwZShzaGFwZSkgewogIHZhciBzZWxmID0gdGhpczsKICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICBpZiAoc2hhcGUudGltZXN0YW1wRm9ybWF0KSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0Jywgc2hhcGUudGltZXN0YW1wRm9ybWF0KTsKICB9IGVsc2UgaWYgKHNlbGYuaXNUaW1lc3RhbXBGb3JtYXRTZXQgJiYgdGhpcy50aW1lc3RhbXBGb3JtYXQpIHsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCB0aGlzLnRpbWVzdGFtcEZvcm1hdCk7CiAgfSBlbHNlIGlmICh0aGlzLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdyZmM4MjInKTsKICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAnaXNvODYwMScpOwogIH0gZWxzZSBpZiAodGhpcy5hcGkpIHsKICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgY2FzZSAnanNvbic6CiAgICAgIGNhc2UgJ3Jlc3QtanNvbic6CiAgICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICd1bml4VGltZXN0YW1wJyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ3Jlc3QteG1sJzoKICAgICAgY2FzZSAncXVlcnknOgogICAgICBjYXNlICdlYzInOgogICAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAnaXNvODYwMScpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgaWYgKHR5cGVvZiB2YWx1ZS50b1VUQ1N0cmluZyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHZhbHVlOwogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/CiAgICAgICAgICAgdXRpbC5kYXRlLnBhcnNlVGltZXN0YW1wKHZhbHVlKSA6IG51bGw7CiAgfTsKCiAgdGhpcy50b1dpcmVGb3JtYXQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHV0aWwuZGF0ZS5mb3JtYXQodmFsdWUsIHNlbGYudGltZXN0YW1wRm9ybWF0KTsKICB9Owp9CgpmdW5jdGlvbiBTdHJpbmdTaGFwZSgpIHsKICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICB2YXIgbnVsbExlc3NQcm90b2NvbHMgPSBbJ3Jlc3QteG1sJywgJ3F1ZXJ5JywgJ2VjMiddOwogIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHZhbHVlID0gdGhpcy5hcGkgJiYgbnVsbExlc3NQcm90b2NvbHMuaW5kZXhPZih0aGlzLmFwaS5wcm90b2NvbCkgPiAtMSA/CiAgICAgIHZhbHVlIHx8ICcnIDogdmFsdWU7CiAgICBpZiAodGhpcy5pc0pzb25WYWx1ZSkgewogICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZS50b1N0cmluZyA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgIHZhbHVlLnRvU3RyaW5nKCkgOiB2YWx1ZTsKICB9OwoKICB0aGlzLnRvV2lyZUZvcm1hdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5pc0pzb25WYWx1ZSA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlOwogIH07Cn0KCmZ1bmN0aW9uIEZsb2F0U2hhcGUoKSB7CiAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgcmV0dXJuIHBhcnNlRmxvYXQodmFsdWUpOwogIH07CiAgdGhpcy50b1dpcmVGb3JtYXQgPSB0aGlzLnRvVHlwZTsKfQoKZnVuY3Rpb24gSW50ZWdlclNoYXBlKCkgewogIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwogIH07CiAgdGhpcy50b1dpcmVGb3JtYXQgPSB0aGlzLnRvVHlwZTsKfQoKZnVuY3Rpb24gQmluYXJ5U2hhcGUoKSB7CiAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YXIgYnVmID0gdXRpbC5iYXNlNjQuZGVjb2RlKHZhbHVlKTsKICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlICYmIHV0aWwuaXNOb2RlKCkgJiYgdHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgLyogTm9kZS5qcyBjYW4gY3JlYXRlIGEgQnVmZmVyIHRoYXQgaXMgbm90IGlzb2xhdGVkLgogICAqIGkuZS4gYnVmLmJ5dGVMZW5ndGggIT09IGJ1Zi5idWZmZXIuYnl0ZUxlbmd0aAogICAqIFRoaXMgbWVhbnMgdGhhdCB0aGUgc2Vuc2l0aXZlIGRhdGEgaXMgYWNjZXNzaWJsZSB0byBhbnlvbmUgd2l0aCBhY2Nlc3MgdG8gYnVmLmJ1ZmZlci4KICAgKiBJZiB0aGlzIGlzIHRoZSBub2RlIHNoYXJlZCBCdWZmZXIsIHRoZW4gb3RoZXIgY29kZSB3aXRoaW4gdGhpcyBwcm9jZXNzIF9jb3VsZF8gZmluZCB0aGlzIHNlY3JldC4KICAgKiBDb3B5IHNlbnNpdGl2ZSBkYXRhIHRvIGFuIGlzb2xhdGVkIEJ1ZmZlciBhbmQgemVybyB0aGUgc2Vuc2l0aXZlIGRhdGEuCiAgICogV2hpbGUgdGhpcyBpcyBzYWZlIHRvIGRvIGhlcmUsIGNvcHlpbmcgdGhpcyBjb2RlIHNvbWV3aGVyZSBlbHNlIG1heSBwcm9kdWNlIHVuZXhwZWN0ZWQgcmVzdWx0cy4KICAgKi8KICAgICAgdmFyIHNlY3VyZUJ1ZiA9IHV0aWwuQnVmZmVyLmFsbG9jKGJ1Zi5sZW5ndGgsIGJ1Zik7CiAgICAgIGJ1Zi5maWxsKDApOwogICAgICBidWYgPSBzZWN1cmVCdWY7CiAgICB9CiAgICByZXR1cm4gYnVmOwogIH07CiAgdGhpcy50b1dpcmVGb3JtYXQgPSB1dGlsLmJhc2U2NC5lbmNvZGU7Cn0KCmZ1bmN0aW9uIEJhc2U2NFNoYXBlKCkgewogIEJpbmFyeVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KCmZ1bmN0aW9uIEJvb2xlYW5TaGFwZSgpIHsKICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHJldHVybiB2YWx1ZTsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiB2YWx1ZSA9PT0gJ3RydWUnOwogIH07Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovClNoYXBlLnNoYXBlcyA9IHsKICBTdHJ1Y3R1cmVTaGFwZTogU3RydWN0dXJlU2hhcGUsCiAgTGlzdFNoYXBlOiBMaXN0U2hhcGUsCiAgTWFwU2hhcGU6IE1hcFNoYXBlLAogIFN0cmluZ1NoYXBlOiBTdHJpbmdTaGFwZSwKICBCb29sZWFuU2hhcGU6IEJvb2xlYW5TaGFwZSwKICBCYXNlNjRTaGFwZTogQmFzZTY0U2hhcGUKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gU2hhcGU7Cgp9LHsiLi4vdXRpbCI6NzIsIi4vY29sbGVjdGlvbiI6NDB9XSw0NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5QYXJhbVZhbGlkYXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogIC8qKgogICAqIENyZWF0ZSBhIG5ldyB2YWxpZGF0b3Igb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHZhbGlkYXRpb24gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMgc2hvdWxkIGJlCiAgICogICAgIHZhbGlkYXRlZCBhZ2FpbnN0IHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcgdGhlCiAgICogICAgIHJlcXVlc3QuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljCiAgICogICAgIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAgICoKICAgKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAqICAgICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogICAqICAgICAgIHRvIGB0cnVlYC4KICAgKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAqICAgICAgIGNvbnN0cmFpbnQuCiAgICogICAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAqICAgICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAgICogICAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUGFyYW1WYWxpZGF0b3IodmFsaWRhdGlvbikgewogICAgaWYgKHZhbGlkYXRpb24gPT09IHRydWUgfHwgdmFsaWRhdGlvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHZhbGlkYXRpb24gPSB7J21pbic6IHRydWV9OwogICAgfQogICAgdGhpcy52YWxpZGF0aW9uID0gdmFsaWRhdGlvbjsKICB9LAoKICB2YWxpZGF0ZTogZnVuY3Rpb24gdmFsaWRhdGUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgdGhpcy5lcnJvcnMgPSBbXTsKICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUsIHBhcmFtcyB8fCB7fSwgY29udGV4dCB8fCAncGFyYW1zJyk7CgogICAgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA+IDEpIHsKICAgICAgdmFyIG1zZyA9IHRoaXMuZXJyb3JzLmpvaW4oJ1xuKiAnKTsKICAgICAgbXNnID0gJ1RoZXJlIHdlcmUgJyArIHRoaXMuZXJyb3JzLmxlbmd0aCArCiAgICAgICAgJyB2YWxpZGF0aW9uIGVycm9yczpcbiogJyArIG1zZzsKICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1zZyksCiAgICAgICAge2NvZGU6ICdNdWx0aXBsZVZhbGlkYXRpb25FcnJvcnMnLCBlcnJvcnM6IHRoaXMuZXJyb3JzfSk7CiAgICB9IGVsc2UgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA9PT0gMSkgewogICAgICB0aHJvdyB0aGlzLmVycm9yc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0sCgogIGZhaWw6IGZ1bmN0aW9uIGZhaWwoY29kZSwgbWVzc2FnZSkgewogICAgdGhpcy5lcnJvcnMucHVzaChBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHtjb2RlOiBjb2RlfSkpOwogIH0sCgogIHZhbGlkYXRlU3RydWN0dXJlOiBmdW5jdGlvbiB2YWxpZGF0ZVN0cnVjdHVyZShzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICBpZiAoc2hhcGUuaXNEb2N1bWVudCkgcmV0dXJuIHRydWU7CgogICAgdGhpcy52YWxpZGF0ZVR5cGUocGFyYW1zLCBjb250ZXh0LCBbJ29iamVjdCddLCAnc3RydWN0dXJlJyk7CiAgICB2YXIgcGFyYW1OYW1lOwogICAgZm9yICh2YXIgaSA9IDA7IHNoYXBlLnJlcXVpcmVkICYmIGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICBwYXJhbU5hbWUgPSBzaGFwZS5yZXF1aXJlZFtpXTsKICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW3BhcmFtTmFtZV07CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgdGhpcy5mYWlsKCdNaXNzaW5nUmVxdWlyZWRQYXJhbWV0ZXInLAogICAgICAgICAgJ01pc3NpbmcgcmVxdWlyZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBpbiAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyB2YWxpZGF0ZSBoYXNoIG1lbWJlcnMKICAgIGZvciAocGFyYW1OYW1lIGluIHBhcmFtcykgewogICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtTmFtZSkpIGNvbnRpbnVlOwoKICAgICAgdmFyIHBhcmFtVmFsdWUgPSBwYXJhbXNbcGFyYW1OYW1lXSwKICAgICAgICAgIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1twYXJhbU5hbWVdOwoKICAgICAgaWYgKG1lbWJlclNoYXBlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB2YXIgbWVtYmVyQ29udGV4dCA9IFtjb250ZXh0LCBwYXJhbU5hbWVdLmpvaW4oJy4nKTsKICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKG1lbWJlclNoYXBlLCBwYXJhbVZhbHVlLCBtZW1iZXJDb250ZXh0KTsKICAgICAgfSBlbHNlIGlmIChwYXJhbVZhbHVlICE9PSB1bmRlZmluZWQgJiYgcGFyYW1WYWx1ZSAhPT0gbnVsbCkgewogICAgICAgIHRoaXMuZmFpbCgnVW5leHBlY3RlZFBhcmFtZXRlcicsCiAgICAgICAgICAnVW5leHBlY3RlZCBrZXkgXCcnICsgcGFyYW1OYW1lICsgJ1wnIGZvdW5kIGluICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0sCgogIHZhbGlkYXRlTWVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpIHsKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU3RydWN0dXJlKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgIGNhc2UgJ2xpc3QnOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTGlzdChzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICBjYXNlICdtYXAnOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTWFwKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTY2FsYXIoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgIH0KICB9LAoKICB2YWxpZGF0ZUxpc3Q6IGZ1bmN0aW9uIHZhbGlkYXRlTGlzdChzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUocGFyYW1zLCBjb250ZXh0LCBbQXJyYXldKSkgewogICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHBhcmFtcy5sZW5ndGgsIGNvbnRleHQsICdsaXN0IG1lbWJlciBjb3VudCcpOwogICAgICAvLyB2YWxpZGF0ZSBhcnJheSBtZW1iZXJzCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5tZW1iZXIsIHBhcmFtc1tpXSwgY29udGV4dCArICdbJyArIGkgKyAnXScpOwogICAgICB9CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVNYXA6IGZ1bmN0aW9uIHZhbGlkYXRlTWFwKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdtYXAnKSkgewogICAgICAvLyBCdWlsZCB1cCBhIGNvdW50IG9mIG1hcCBtZW1iZXJzIHRvIHZhbGlkYXRlIHJhbmdlIHRyYWl0cy4KICAgICAgdmFyIG1hcENvdW50ID0gMDsKICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7CiAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1zLCBwYXJhbSkpIGNvbnRpbnVlOwogICAgICAgIC8vIFZhbGlkYXRlIGFueSBtYXAga2V5IHRyYWl0IGNvbnN0cmFpbnRzCiAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5rZXksIHBhcmFtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCArICdba2V5PVwnJyArIHBhcmFtICsgJ1wnXScpOwogICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUudmFsdWUsIHBhcmFtc1twYXJhbV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1tcJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICBtYXBDb3VudCsrOwogICAgICB9CiAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgbWFwQ291bnQsIGNvbnRleHQsICdtYXAgbWVtYmVyIGNvdW50Jyk7CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVTY2FsYXI6IGZ1bmN0aW9uIHZhbGlkYXRlU2NhbGFyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgbnVsbDoKICAgICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVBheWxvYWQodmFsdWUsIGNvbnRleHQpOwogICAgICBjYXNlICdpbnRlZ2VyJzoKICAgICAgY2FzZSAnZmxvYXQnOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgWydib29sZWFuJ10pOwogICAgICBjYXNlICd0aW1lc3RhbXAnOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgW0RhdGUsCiAgICAgICAgICAvXlxkezR9LVxkezJ9LVxkezJ9VFxkezJ9OlxkezJ9OlxkezJ9KFwuXGQrKT9aJC8sICdudW1iZXInXSwKICAgICAgICAgICdEYXRlIG9iamVjdCwgSVNPLTg2MDEgc3RyaW5nLCBvciBhIFVOSVggdGltZXN0YW1wJyk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIHRoaXMuZmFpbCgnVW5rb3duVHlwZScsICdVbmhhbmRsZWQgdHlwZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLnR5cGUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVTdHJpbmc6IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgdmFyIHZhbGlkVHlwZXMgPSBbJ3N0cmluZyddOwogICAgaWYgKHNoYXBlLmlzSnNvblZhbHVlKSB7CiAgICAgIHZhbGlkVHlwZXMgPSB2YWxpZFR5cGVzLmNvbmNhdChbJ251bWJlcicsICdvYmplY3QnLCAnYm9vbGVhbiddKTsKICAgIH0KICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgdmFsaWRUeXBlcykpIHsKICAgICAgdGhpcy52YWxpZGF0ZUVudW0oc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZS5sZW5ndGgsIGNvbnRleHQsICdzdHJpbmcgbGVuZ3RoJyk7CiAgICAgIHRoaXMudmFsaWRhdGVQYXR0ZXJuKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgIHRoaXMudmFsaWRhdGVVcmkoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgIH0KICB9LAoKICB2YWxpZGF0ZVVyaTogZnVuY3Rpb24gdmFsaWRhdGVVcmkoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICBpZiAoc2hhcGVbJ2xvY2F0aW9uJ10gPT09ICd1cmknKSB7CiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICB0aGlzLmZhaWwoJ1VyaVBhcmFtZXRlckVycm9yJywgJ0V4cGVjdGVkIHVyaSBwYXJhbWV0ZXIgdG8gaGF2ZSBsZW5ndGggPj0gMSwnCiAgICAgICAgICArICcgYnV0IGZvdW5kICInICsgdmFsdWUgKyciIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0KICB9LAoKICB2YWxpZGF0ZVBhdHRlcm46IGZ1bmN0aW9uIHZhbGlkYXRlUGF0dGVybihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ3BhdHRlcm4nXSAmJiBzaGFwZVsncGF0dGVybiddICE9PSB1bmRlZmluZWQpIHsKICAgICAgaWYgKCEobmV3IFJlZ0V4cChzaGFwZVsncGF0dGVybiddKSkudGVzdCh2YWx1ZSkpIHsKICAgICAgICB0aGlzLmZhaWwoJ1BhdHRlcm5NYXRjaEVycm9yJywgJ1Byb3ZpZGVkIHZhbHVlICInICsgdmFsdWUgKyAnIiAnCiAgICAgICAgICArICdkb2VzIG5vdCBtYXRjaCByZWdleCBwYXR0ZXJuIC8nICsgc2hhcGVbJ3BhdHRlcm4nXSArICcvIGZvciAnCiAgICAgICAgICArIGNvbnRleHQpOwogICAgICB9CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVSYW5nZTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsIGRlc2NyaXB0b3IpIHsKICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ21pbiddKSB7CiAgICAgIGlmIChzaGFwZVsnbWluJ10gIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA8IHNoYXBlWydtaW4nXSkgewogICAgICAgIHRoaXMuZmFpbCgnTWluUmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPj0gJwogICAgICAgICAgKyBzaGFwZVsnbWluJ10gKyAnLCBidXQgZm91bmQgJyArIHZhbHVlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy52YWxpZGF0aW9uWydtYXgnXSkgewogICAgICBpZiAoc2hhcGVbJ21heCddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPiBzaGFwZVsnbWF4J10pIHsKICAgICAgICB0aGlzLmZhaWwoJ01heFJhbmdlRXJyb3InLCAnRXhwZWN0ZWQgJyArIGRlc2NyaXB0b3IgKyAnIDw9ICcKICAgICAgICAgICsgc2hhcGVbJ21heCddICsgJywgYnV0IGZvdW5kICcgKyB2YWx1ZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfQogIH0sCgogIHZhbGlkYXRlRW51bTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ2VudW0nXSAmJiBzaGFwZVsnZW51bSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgLy8gRmFpbCBpZiB0aGUgc3RyaW5nIHZhbHVlIGlzIG5vdCBwcmVzZW50IGluIHRoZSBlbnVtIGxpc3QKICAgICAgaWYgKHNoYXBlWydlbnVtJ10uaW5kZXhPZih2YWx1ZSkgPT09IC0xKSB7CiAgICAgICAgdGhpcy5mYWlsKCdFbnVtRXJyb3InLCAnRm91bmQgc3RyaW5nIHZhbHVlIG9mICcgKyB2YWx1ZSArICcsIGJ1dCAnCiAgICAgICAgICArICdleHBlY3RlZCAnICsgc2hhcGVbJ2VudW0nXS5qb2luKCd8JykgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0KICB9LAoKICB2YWxpZGF0ZVR5cGU6IGZ1bmN0aW9uIHZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgYWNjZXB0ZWRUeXBlcywgdHlwZSkgewogICAgLy8gV2Ugd2lsbCBub3QgbG9nIGFuIGVycm9yIGZvciBudWxsIG9yIHVuZGVmaW5lZCwgYnV0IHdlIHdpbGwgcmV0dXJuCiAgICAvLyBmYWxzZSBzbyB0aGF0IGNhbGxlcnMga25vdyB0aGF0IHRoZSBleHBlY3RlZCB0eXBlIHdhcyBub3Qgc3RyaWN0bHkgbWV0LgogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsKCiAgICB2YXIgZm91bmRJbnZhbGlkVHlwZSA9IGZhbHNlOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhY2NlcHRlZFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0eXBlb2YgYWNjZXB0ZWRUeXBlc1tpXSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChhY2NlcHRlZFR5cGVzW2ldIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgaWYgKCh2YWx1ZSB8fCAnJykudG9TdHJpbmcoKS5tYXRjaChhY2NlcHRlZFR5cGVzW2ldKSkgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgYWNjZXB0ZWRUeXBlc1tpXSkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKEFXUy51dGlsLmlzVHlwZSh2YWx1ZSwgYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICAgIGlmICghdHlwZSAmJiAhZm91bmRJbnZhbGlkVHlwZSkgYWNjZXB0ZWRUeXBlcyA9IGFjY2VwdGVkVHlwZXMuc2xpY2UoKTsKICAgICAgICBhY2NlcHRlZFR5cGVzW2ldID0gQVdTLnV0aWwudHlwZU5hbWUoYWNjZXB0ZWRUeXBlc1tpXSk7CiAgICAgIH0KICAgICAgZm91bmRJbnZhbGlkVHlwZSA9IHRydWU7CiAgICB9CgogICAgdmFyIGFjY2VwdGVkVHlwZSA9IHR5cGU7CiAgICBpZiAoIWFjY2VwdGVkVHlwZSkgewogICAgICBhY2NlcHRlZFR5cGUgPSBhY2NlcHRlZFR5cGVzLmpvaW4oJywgJykucmVwbGFjZSgvLChbXixdKykkLywgJywgb3IkMScpOwogICAgfQoKICAgIHZhciB2b3dlbCA9IGFjY2VwdGVkVHlwZS5tYXRjaCgvXlthZWlvdV0vaSkgPyAnbicgOiAnJzsKICAgIHRoaXMuZmFpbCgnSW52YWxpZFBhcmFtZXRlclR5cGUnLCAnRXhwZWN0ZWQgJyArIGNvbnRleHQgKyAnIHRvIGJlIGEnICsKICAgICAgICAgICAgICB2b3dlbCArICcgJyArIGFjY2VwdGVkVHlwZSk7CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgdmFsaWRhdGVOdW1iZXI6IGZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHZhciBjYXN0ZWRWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgICBpZiAoY2FzdGVkVmFsdWUudG9TdHJpbmcoKSA9PT0gdmFsdWUpIHZhbHVlID0gY2FzdGVkVmFsdWU7CiAgICB9CiAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnbnVtYmVyJ10pKSB7CiAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsICdudW1lcmljIHZhbHVlJyk7CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVQYXlsb2FkOiBmdW5jdGlvbiB2YWxpZGF0ZVBheWxvYWQodmFsdWUsIGNvbnRleHQpIHsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuOwogICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZS5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJykgcmV0dXJuOyAvLyB0eXBlZCBhcnJheXMKICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgeyAvLyBzcGVjaWFsIGNoZWNrIGZvciBidWZmZXIvc3RyZWFtIGluIE5vZGUuanMKICAgICAgdmFyIFN0cmVhbSA9IEFXUy51dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgIGlmIChBV1MudXRpbC5CdWZmZXIuaXNCdWZmZXIodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgU3RyZWFtKSByZXR1cm47CiAgICB9IGVsc2UgewogICAgICBpZiAodHlwZW9mIEJsb2IgIT09IHZvaWQgMCAmJiB2YWx1ZSBpbnN0YW5jZW9mIEJsb2IpIHJldHVybjsKICAgIH0KCiAgICB2YXIgdHlwZXMgPSBbJ0J1ZmZlcicsICdTdHJlYW0nLCAnRmlsZScsICdCbG9iJywgJ0FycmF5QnVmZmVyJywgJ0RhdGFWaWV3J107CiAgICBpZiAodmFsdWUpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0eXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIHR5cGVzW2ldKSkgcmV0dXJuOwogICAgICAgIGlmIChBV1MudXRpbC50eXBlTmFtZSh2YWx1ZS5jb25zdHJ1Y3RvcikgPT09IHR5cGVzW2ldKSByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmZhaWwoJ0ludmFsaWRQYXJhbWV0ZXJUeXBlJywgJ0V4cGVjdGVkICcgKyBjb250ZXh0ICsgJyB0byBiZSBhICcgKwogICAgICAnc3RyaW5nLCBCdWZmZXIsIFN0cmVhbSwgQmxvYiwgb3IgdHlwZWQgYXJyYXkgb2JqZWN0Jyk7CiAgfQp9KTsKCn0seyIuL2NvcmUiOjE5fV0sNDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9ICByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CgovKioKICogUHJlcGVuZCBwcmVmaXggZGVmaW5lZCBieSBBUEkgbW9kZWwgdG8gZW5kcG9pbnQgdGhhdCdzIGFscmVhZHkKICogY29uc3RydWN0ZWQuIFRoaXMgZmVhdHVyZSBkb2VzIG5vdCBhcHBseSB0byBvcGVyYXRpb25zIHVzaW5nCiAqIGVuZHBvaW50IGRpc2NvdmVyeSBhbmQgY2FuIGJlIGRpc2FibGVkLgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHBvcHVsYXRlSG9zdFByZWZpeChyZXF1ZXN0KSAgewogIHZhciBlbmFibGVkID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5ob3N0UHJlZml4RW5hYmxlZDsKICBpZiAoIWVuYWJsZWQpIHJldHVybiByZXF1ZXN0OwogIHZhciBvcGVyYXRpb25Nb2RlbCA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgLy9kb24ndCBtYXJzaGFsIGhvc3QgcHJlZml4IHdoZW4gb3BlcmF0aW9uIGhhcyBlbmRwb2ludCBkaXNjb3ZlcnkgdHJhaXRzCiAgaWYgKGhhc0VuZHBvaW50RGlzY292ZXIocmVxdWVzdCkpIHJldHVybiByZXF1ZXN0OwogIGlmIChvcGVyYXRpb25Nb2RlbC5lbmRwb2ludCAmJiBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludC5ob3N0UHJlZml4KSB7CiAgICB2YXIgaG9zdFByZWZpeE5vdGF0aW9uID0gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeDsKICAgIHZhciBob3N0UHJlZml4ID0gZXhwYW5kSG9zdFByZWZpeChob3N0UHJlZml4Tm90YXRpb24sIHJlcXVlc3QucGFyYW1zLCBvcGVyYXRpb25Nb2RlbC5pbnB1dCk7CiAgICBwcmVwZW5kRW5kcG9pbnRQcmVmaXgocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCwgaG9zdFByZWZpeCk7CiAgICB2YWxpZGF0ZUhvc3RuYW1lKHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUpOwogIH0KICByZXR1cm4gcmVxdWVzdDsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSB7CiAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGk7CiAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogIHZhciBpc0VuZHBvaW50T3BlcmF0aW9uID0gYXBpLmVuZHBvaW50T3BlcmF0aW9uICYmIChhcGkuZW5kcG9pbnRPcGVyYXRpb24gPT09IHV0aWwuc3RyaW5nLmxvd2VyRmlyc3Qob3BlcmF0aW9uTW9kZWwubmFtZSkpOwogIHJldHVybiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCAhPT0gJ05VTEwnIHx8IGlzRW5kcG9pbnRPcGVyYXRpb24gPT09IHRydWUpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcGFyYW1zLCBzaGFwZSkgewogIHV0aWwuZWFjaChzaGFwZS5tZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgIGlmIChtZW1iZXIuaG9zdExhYmVsID09PSB0cnVlKSB7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zW25hbWVdICE9PSAnc3RyaW5nJyB8fCBwYXJhbXNbbmFtZV0gPT09ICcnKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgbWVzc2FnZTogJ1BhcmFtZXRlciAnICsgbmFtZSArICcgc2hvdWxkIGJlIGEgbm9uLWVtcHR5IHN0cmluZy4nLAogICAgICAgICAgY29kZTogJ0ludmFsaWRQYXJhbWV0ZXInCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG5hbWUgKyAnXFx9JywgJ2cnKTsKICAgICAgaG9zdFByZWZpeE5vdGF0aW9uID0gaG9zdFByZWZpeE5vdGF0aW9uLnJlcGxhY2UocmVnZXgsIHBhcmFtc1tuYW1lXSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIGhvc3RQcmVmaXhOb3RhdGlvbjsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gcHJlcGVuZEVuZHBvaW50UHJlZml4KGVuZHBvaW50LCBwcmVmaXgpIHsKICBpZiAoZW5kcG9pbnQuaG9zdCkgewogICAgZW5kcG9pbnQuaG9zdCA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3Q7CiAgfQogIGlmIChlbmRwb2ludC5ob3N0bmFtZSkgewogICAgZW5kcG9pbnQuaG9zdG5hbWUgPSBwcmVmaXggKyBlbmRwb2ludC5ob3N0bmFtZTsKICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHZhbGlkYXRlSG9zdG5hbWUoaG9zdG5hbWUpIHsKICB2YXIgbGFiZWxzID0gaG9zdG5hbWUuc3BsaXQoJy4nKTsKICAvL1JlZmVyZW5jZTogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzExMjMjc2VjdGlvbi0yCiAgdmFyIGhvc3RQYXR0ZXJuID0gL15bYS16QS1aMC05XXsxfSR8XlthLXpBLVowLTldW2EtekEtWjAtOVwtXSpbYS16QS1aMC05XSQvOwogIHV0aWwuYXJyYXlFYWNoKGxhYmVscywgZnVuY3Rpb24obGFiZWwpIHsKICAgIGlmICghbGFiZWwubGVuZ3RoIHx8IGxhYmVsLmxlbmd0aCA8IDEgfHwgbGFiZWwubGVuZ3RoID4gNjMpIHsKICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdWYWxpZGF0aW9uRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdIb3N0bmFtZSBsYWJlbCBsZW5ndGggc2hvdWxkIGJlIGJldHdlZW4gMSB0byA2MyBjaGFyYWN0ZXJzLCBpbmNsdXNpdmUuJwogICAgICB9KTsKICAgIH0KICAgIGlmICghaG9zdFBhdHRlcm4udGVzdChsYWJlbCkpIHsKICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAge2NvZGU6ICdWYWxpZGF0aW9uRXJyb3InLCBtZXNzYWdlOiBsYWJlbCArICcgaXMgbm90IGhvc3RuYW1lIGNvbXBhdGlibGUuJ30pOwogICAgfQogIH0pOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKICBwb3B1bGF0ZUhvc3RQcmVmaXg6IHBvcHVsYXRlSG9zdFByZWZpeAp9OwoKfSx7Ii4uL2NvcmUiOjE5LCIuLi91dGlsIjo3Mn1dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBKc29uQnVpbGRlciA9IHJlcXVpcmUoJy4uL2pzb24vYnVpbGRlcicpOwp2YXIgSnNvblBhcnNlciA9IHJlcXVpcmUoJy4uL2pzb24vcGFyc2VyJyk7CnZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CgpmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogIHZhciBhcGkgPSByZXEuc2VydmljZS5hcGk7CiAgdmFyIHRhcmdldCA9IGFwaS50YXJnZXRQcmVmaXggKyAnLicgKyBhcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5uYW1lOwogIHZhciB2ZXJzaW9uID0gYXBpLmpzb25WZXJzaW9uIHx8ICcxLjAnOwogIHZhciBpbnB1dCA9IGFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CgogIGlmICh2ZXJzaW9uID09PSAxKSB2ZXJzaW9uID0gJzEuMCc7CiAgaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIuYnVpbGQocmVxLnBhcmFtcyB8fCB7fSwgaW5wdXQpOwogIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtYW16LWpzb24tJyArIHZlcnNpb247CiAgaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotVGFyZ2V0J10gPSB0YXJnZXQ7CgogIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwp9CgpmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogIHZhciBlcnJvciA9IHt9OwogIHZhciBodHRwUmVzcG9uc2UgPSByZXNwLmh0dHBSZXNwb25zZTsKCiAgZXJyb3IuY29kZSA9IGh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tZXJyb3J0eXBlJ10gfHwgJ1Vua25vd25FcnJvcic7CiAgaWYgKHR5cGVvZiBlcnJvci5jb2RlID09PSAnc3RyaW5nJykgewogICAgZXJyb3IuY29kZSA9IGVycm9yLmNvZGUuc3BsaXQoJzonKVswXTsKICB9CgogIGlmIChodHRwUmVzcG9uc2UuYm9keS5sZW5ndGggPiAwKSB7CiAgICB0cnkgewogICAgICB2YXIgZSA9IEpTT04ucGFyc2UoaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgICAgIHZhciBjb2RlID0gZS5fX3R5cGUgfHwgZS5jb2RlIHx8IGUuQ29kZTsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICBlcnJvci5jb2RlID0gY29kZS5zcGxpdCgnIycpLnBvcCgpOwogICAgICB9CiAgICAgIGlmIChlcnJvci5jb2RlID09PSAnUmVxdWVzdEVudGl0eVRvb0xhcmdlJykgewogICAgICAgIGVycm9yLm1lc3NhZ2UgPSAnUmVxdWVzdCBib2R5IG11c3QgYmUgbGVzcyB0aGFuIDEgTUInOwogICAgICB9IGVsc2UgewogICAgICAgIGVycm9yLm1lc3NhZ2UgPSAoZS5tZXNzYWdlIHx8IGUuTWVzc2FnZSB8fCBudWxsKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnJvci5zdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZTsKICAgIH0KICB9IGVsc2UgewogICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgZXJyb3IubWVzc2FnZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLnRvU3RyaW5nKCk7CiAgfQoKICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgZXJyb3IpOwp9CgpmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgdmFyIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkgfHwgJ3t9JzsKICBpZiAocmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNvbnZlcnRSZXNwb25zZVR5cGVzID09PSBmYWxzZSkgewogICAgcmVzcC5kYXRhID0gSlNPTi5wYXJzZShib2R5KTsKICB9IGVsc2UgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3Jlc3AucmVxdWVzdC5vcGVyYXRpb25dOwogICAgdmFyIHNoYXBlID0gb3BlcmF0aW9uLm91dHB1dCB8fCB7fTsKICAgIHZhciBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgcmVzcC5kYXRhID0gcGFyc2VyLnBhcnNlKGJvZHksIHNoYXBlKTsKICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQp9OwoKfSx7Ii4uL2pzb24vYnVpbGRlciI6MzcsIi4uL2pzb24vcGFyc2VyIjozOCwiLi4vdXRpbCI6NzIsIi4vaGVscGVycyI6NDZ9XSw0ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgUXVlcnlQYXJhbVNlcmlhbGl6ZXIgPSByZXF1aXJlKCcuLi9xdWVyeS9xdWVyeV9wYXJhbV9zZXJpYWxpemVyJyk7CnZhciBTaGFwZSA9IHJlcXVpcmUoJy4uL21vZGVsL3NoYXBlJyk7CnZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CgpmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHZhciBodHRwUmVxdWVzdCA9IHJlcS5odHRwUmVxdWVzdDsKICBodHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9CiAgICAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PXV0Zi04JzsKICBodHRwUmVxdWVzdC5wYXJhbXMgPSB7CiAgICBWZXJzaW9uOiByZXEuc2VydmljZS5hcGkuYXBpVmVyc2lvbiwKICAgIEFjdGlvbjogb3BlcmF0aW9uLm5hbWUKICB9OwoKICAvLyBjb252ZXJ0IHRoZSByZXF1ZXN0IHBhcmFtZXRlcnMgaW50byBhIGxpc3Qgb2YgcXVlcnkgcGFyYW1zLAogIC8vIGUuZy4gRGVlcGx5Lk5lc3RlZFBhcmFtLjAuTmFtZT12YWx1ZQogIHZhciBidWlsZGVyID0gbmV3IFF1ZXJ5UGFyYW1TZXJpYWxpemVyKCk7CiAgYnVpbGRlci5zZXJpYWxpemUocmVxLnBhcmFtcywgb3BlcmF0aW9uLmlucHV0LCBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgaHR0cFJlcXVlc3QucGFyYW1zW25hbWVdID0gdmFsdWU7CiAgfSk7CiAgaHR0cFJlcXVlc3QuYm9keSA9IHV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhodHRwUmVxdWVzdC5wYXJhbXMpOwoKICBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxKTsKfQoKZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICB2YXIgZGF0YSwgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKTsKICBpZiAoYm9keS5tYXRjaCgnPFVua25vd25PcGVyYXRpb25FeGNlcHRpb24nKSkgewogICAgZGF0YSA9IHsKICAgICAgQ29kZTogJ1Vua25vd25PcGVyYXRpb24nLAogICAgICBNZXNzYWdlOiAnVW5rbm93biBvcGVyYXRpb24gJyArIHJlc3AucmVxdWVzdC5vcGVyYXRpb24KICAgIH07CiAgfSBlbHNlIHsKICAgIHRyeSB7CiAgICAgIGRhdGEgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKS5wYXJzZShib2R5KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZGF0YSA9IHsKICAgICAgICBDb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgICAgfTsKICAgIH0KICB9CgogIGlmIChkYXRhLnJlcXVlc3RJZCAmJiAhcmVzcC5yZXF1ZXN0SWQpIHJlc3AucmVxdWVzdElkID0gZGF0YS5yZXF1ZXN0SWQ7CiAgaWYgKGRhdGEuRXJyb3JzKSBkYXRhID0gZGF0YS5FcnJvcnM7CiAgaWYgKGRhdGEuRXJyb3IpIGRhdGEgPSBkYXRhLkVycm9yOwogIGlmIChkYXRhLkNvZGUpIHsKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgIGNvZGU6IGRhdGEuQ29kZSwKICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICB9KTsKICB9IGVsc2UgewogICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgY29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgbWVzc2FnZTogbnVsbAogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgdmFyIHNoYXBlID0gb3BlcmF0aW9uLm91dHB1dCB8fCB7fTsKICB2YXIgb3JpZ1J1bGVzID0gc2hhcGU7CgogIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgdmFyIHRtcCA9IFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cnVjdHVyZSd9KTsKICAgIHRtcC5tZW1iZXJzW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSA9IHNoYXBlOwogICAgdG1wLm1lbWJlck5hbWVzID0gW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgIHV0aWwucHJvcGVydHkoc2hhcGUsICduYW1lJywgc2hhcGUucmVzdWx0V3JhcHBlcik7CiAgICBzaGFwZSA9IHRtcDsKICB9CgogIHZhciBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKCiAgLy8gVE9ETzogUmVmYWN0b3IgWE1MIFBhcnNlciB0byBwYXJzZSBSZXF1ZXN0SWQgZnJvbSByZXNwb25zZS4KICBpZiAoc2hhcGUgJiYgc2hhcGUubWVtYmVycyAmJiAhc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCkgewogICAgdmFyIHJlcXVlc3RJZFNoYXBlID0gU2hhcGUuY3JlYXRlKAogICAgICB7IHR5cGU6ICdzdHJpbmcnIH0sCiAgICAgIHsgYXBpOiB7IHByb3RvY29sOiAncXVlcnknIH0gfSwKICAgICAgJ3JlcXVlc3RJZCcKICAgICk7CiAgICBzaGFwZS5tZW1iZXJzLl9YQU1aUmVxdWVzdElkID0gcmVxdWVzdElkU2hhcGU7CiAgfQoKICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShyZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCksIHNoYXBlKTsKICByZXNwLnJlcXVlc3RJZCA9IGRhdGEuX1hBTVpSZXF1ZXN0SWQgfHwgZGF0YS5yZXF1ZXN0SWQ7CgogIGlmIChkYXRhLl9YQU1aUmVxdWVzdElkKSBkZWxldGUgZGF0YS5fWEFNWlJlcXVlc3RJZDsKCiAgaWYgKG9yaWdSdWxlcy5yZXN1bHRXcmFwcGVyKSB7CiAgICBpZiAoZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pIHsKICAgICAgdXRpbC51cGRhdGUoZGF0YSwgZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pOwogICAgICBkZWxldGUgZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl07CiAgICB9CiAgfQoKICByZXNwLmRhdGEgPSBkYXRhOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKfTsKCn0seyIuLi9jb3JlIjoxOSwiLi4vbW9kZWwvc2hhcGUiOjQ0LCIuLi9xdWVyeS9xdWVyeV9wYXJhbV9zZXJpYWxpemVyIjo1MiwiLi4vdXRpbCI6NzIsIi4vaGVscGVycyI6NDZ9XSw0OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgcG9wdWxhdGVIb3N0UHJlZml4ID0gcmVxdWlyZSgnLi9oZWxwZXJzJykucG9wdWxhdGVIb3N0UHJlZml4OwoKZnVuY3Rpb24gcG9wdWxhdGVNZXRob2QocmVxKSB7CiAgcmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmh0dHBNZXRob2Q7Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlVVJJKGVuZHBvaW50UGF0aCwgb3BlcmF0aW9uUGF0aCwgaW5wdXQsIHBhcmFtcykgewogIHZhciB1cmkgPSBbZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoXS5qb2luKCcvJyk7CiAgdXJpID0gdXJpLnJlcGxhY2UoL1wvKy9nLCAnLycpOwoKICB2YXIgcXVlcnlTdHJpbmcgPSB7fSwgcXVlcnlTdHJpbmdTZXQgPSBmYWxzZTsKICB1dGlsLmVhY2goaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgdmFyIHBhcmFtVmFsdWUgPSBwYXJhbXNbbmFtZV07CiAgICBpZiAocGFyYW1WYWx1ZSA9PT0gbnVsbCB8fCBwYXJhbVZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICd1cmknKSB7CiAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoJ1xceycgKyBtZW1iZXIubmFtZSArICcoXFwrKT9cXH0nKTsKICAgICAgdXJpID0gdXJpLnJlcGxhY2UocmVnZXgsIGZ1bmN0aW9uKF8sIHBsdXMpIHsKICAgICAgICB2YXIgZm4gPSBwbHVzID8gdXRpbC51cmlFc2NhcGVQYXRoIDogdXRpbC51cmlFc2NhcGU7CiAgICAgICAgcmV0dXJuIGZuKFN0cmluZyhwYXJhbVZhbHVlKSk7CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgcXVlcnlTdHJpbmdTZXQgPSB0cnVlOwoKICAgICAgaWYgKG1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICBxdWVyeVN0cmluZ1ttZW1iZXIubmFtZV0gPSBwYXJhbVZhbHVlLm1hcChmdW5jdGlvbih2YWwpIHsKICAgICAgICAgIHJldHVybiB1dGlsLnVyaUVzY2FwZShtZW1iZXIubWVtYmVyLnRvV2lyZUZvcm1hdCh2YWwpLnRvU3RyaW5nKCkpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgIHV0aWwuZWFjaChwYXJhbVZhbHVlLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgcXVlcnlTdHJpbmdba2V5XSA9IHZhbHVlLm1hcChmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbCkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHF1ZXJ5U3RyaW5nW2tleV0gPSB1dGlsLnVyaUVzY2FwZShTdHJpbmcodmFsdWUpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBxdWVyeVN0cmluZ1ttZW1iZXIubmFtZV0gPSB1dGlsLnVyaUVzY2FwZShtZW1iZXIudG9XaXJlRm9ybWF0KHBhcmFtVmFsdWUpLnRvU3RyaW5nKCkpOwogICAgICB9CiAgICB9CiAgfSk7CgogIGlmIChxdWVyeVN0cmluZ1NldCkgewogICAgdXJpICs9ICh1cmkuaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPycpOwogICAgdmFyIHBhcnRzID0gW107CiAgICB1dGlsLmFycmF5RWFjaChPYmplY3Qua2V5cyhxdWVyeVN0cmluZykuc29ydCgpLCBmdW5jdGlvbihrZXkpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHF1ZXJ5U3RyaW5nW2tleV0pKSB7CiAgICAgICAgcXVlcnlTdHJpbmdba2V5XSA9IFtxdWVyeVN0cmluZ1trZXldXTsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5U3RyaW5nW2tleV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICBwYXJ0cy5wdXNoKHV0aWwudXJpRXNjYXBlKFN0cmluZyhrZXkpKSArICc9JyArIHF1ZXJ5U3RyaW5nW2tleV1baV0pOwogICAgICB9CiAgICB9KTsKICAgIHVyaSArPSBwYXJ0cy5qb2luKCcmJyk7CiAgfQoKICByZXR1cm4gdXJpOwp9CgpmdW5jdGlvbiBwb3B1bGF0ZVVSSShyZXEpIHsKICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgdmFyIGlucHV0ID0gb3BlcmF0aW9uLmlucHV0OwoKICB2YXIgdXJpID0gZ2VuZXJhdGVVUkkocmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50LnBhdGgsIG9wZXJhdGlvbi5odHRwUGF0aCwgaW5wdXQsIHJlcS5wYXJhbXMpOwogIHJlcS5odHRwUmVxdWVzdC5wYXRoID0gdXJpOwp9CgpmdW5jdGlvbiBwb3B1bGF0ZUhlYWRlcnMocmVxKSB7CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHV0aWwuZWFjaChvcGVyYXRpb24uaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgdmFyIHZhbHVlID0gcmVxLnBhcmFtc1tuYW1lXTsKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CgogICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICB1dGlsLmVhY2godmFsdWUsIGZ1bmN0aW9uKGtleSwgbWVtYmVyVmFsdWUpIHsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1ttZW1iZXIubmFtZSArIGtleV0gPSBtZW1iZXJWYWx1ZTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgdmFsdWUgPSBtZW1iZXIudG9XaXJlRm9ybWF0KHZhbHVlKS50b1N0cmluZygpOwogICAgICBpZiAobWVtYmVyLmlzSnNvblZhbHVlKSB7CiAgICAgICAgdmFsdWUgPSB1dGlsLmJhc2U2NC5lbmNvZGUodmFsdWUpOwogICAgICB9CiAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW21lbWJlci5uYW1lXSA9IHZhbHVlOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgcG9wdWxhdGVNZXRob2QocmVxKTsKICBwb3B1bGF0ZVVSSShyZXEpOwogIHBvcHVsYXRlSGVhZGVycyhyZXEpOwogIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwp9CgpmdW5jdGlvbiBleHRyYWN0RXJyb3IoKSB7Cn0KCmZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogIHZhciBkYXRhID0ge307CiAgdmFyIHIgPSByZXNwLmh0dHBSZXNwb25zZTsKICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CgogIC8vIG5vcm1hbGl6ZSBoZWFkZXJzIG5hbWVzIHRvIGxvd2VyLWNhc2VkIGtleXMgZm9yIG1hdGNoaW5nCiAgdmFyIGhlYWRlcnMgPSB7fTsKICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgaGVhZGVyc1trLnRvTG93ZXJDYXNlKCldID0gdjsKICB9KTsKCiAgdXRpbC5lYWNoKG91dHB1dC5tZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgIHZhciBoZWFkZXIgPSAobWVtYmVyLm5hbWUgfHwgbmFtZSkudG9Mb3dlckNhc2UoKTsKICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXJzJyAmJiBtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgZGF0YVtuYW1lXSA9IHt9OwogICAgICB2YXIgbG9jYXRpb24gPSBtZW1iZXIuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXIubmFtZSA6ICcnOwogICAgICB2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14nICsgbG9jYXRpb24gKyAnKC4rKScsICdpJyk7CiAgICAgIHV0aWwuZWFjaChyLmhlYWRlcnMsIGZ1bmN0aW9uIChrLCB2KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGsubWF0Y2gocGF0dGVybik7CiAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgZGF0YVtuYW1lXVtyZXN1bHRbMV1dID0gdjsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgIGlmIChoZWFkZXJzW2hlYWRlcl0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciB2YWx1ZSA9IG1lbWJlci5pc0pzb25WYWx1ZSA/CiAgICAgICAgICB1dGlsLmJhc2U2NC5kZWNvZGUoaGVhZGVyc1toZWFkZXJdKSA6CiAgICAgICAgICBoZWFkZXJzW2hlYWRlcl07CiAgICAgICAgZGF0YVtuYW1lXSA9IG1lbWJlci50b1R5cGUodmFsdWUpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3N0YXR1c0NvZGUnKSB7CiAgICAgIGRhdGFbbmFtZV0gPSBwYXJzZUludChyLnN0YXR1c0NvZGUsIDEwKTsKICAgIH0KICB9KTsKCiAgcmVzcC5kYXRhID0gZGF0YTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhLAogIGdlbmVyYXRlVVJJOiBnZW5lcmF0ZVVSSQp9OwoKfSx7Ii4uL3V0aWwiOjcyLCIuL2hlbHBlcnMiOjQ2fV0sNTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIFJlc3QgPSByZXF1aXJlKCcuL3Jlc3QnKTsKdmFyIEpzb24gPSByZXF1aXJlKCcuL2pzb24nKTsKdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CnZhciBKc29uUGFyc2VyID0gcmVxdWlyZSgnLi4vanNvbi9wYXJzZXInKTsKCmZ1bmN0aW9uIHBvcHVsYXRlQm9keShyZXEpIHsKICB2YXIgYnVpbGRlciA9IG5ldyBKc29uQnVpbGRlcigpOwogIHZhciBpbnB1dCA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwoKICBpZiAoaW5wdXQucGF5bG9hZCkgewogICAgdmFyIHBhcmFtcyA9IHt9OwogICAgdmFyIHBheWxvYWRTaGFwZSA9IGlucHV0Lm1lbWJlcnNbaW5wdXQucGF5bG9hZF07CiAgICBwYXJhbXMgPSByZXEucGFyYW1zW2lucHV0LnBheWxvYWRdOwoKICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHBhcmFtcyB8fCB7fSwgcGF5bG9hZFNoYXBlKTsKICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEpOwogICAgfSBlbHNlIGlmIChwYXJhbXMgIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBub24tSlNPTiBwYXlsb2FkCiAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRTaGFwZS5pc1N0cmVhbWluZykgewogICAgICAgIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIuYnVpbGQocmVxLnBhcmFtcywgaW5wdXQpOwogICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEpOwogIH0KfQoKZnVuY3Rpb24gYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEsIGlzQmluYXJ5KSB7CiAgaWYgKCFyZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10pIHsKICAgIHZhciB0eXBlID0gaXNCaW5hcnkgPyAnYmluYXJ5L29jdGV0LXN0cmVhbScgOiAnYXBwbGljYXRpb24vanNvbic7CiAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSB0eXBlOwogIH0KfQoKZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CgogIC8vIG5ldmVyIHNlbmQgYm9keSBwYXlsb2FkIG9uIEdFVC9IRUFEL0RFTEVURQogIGlmIChbJ0dFVCcsICdIRUFEJywgJ0RFTEVURSddLmluZGV4T2YocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCkgPCAwKSB7CiAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICB9Cn0KCmZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgSnNvbi5leHRyYWN0RXJyb3IocmVzcCk7Cn0KCmZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICBSZXN0LmV4dHJhY3REYXRhKHJlc3ApOwoKICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5vdXRwdXQgfHwge307CiAgdmFyIHBhcnNlcjsKICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CgogIGlmIChydWxlcy5wYXlsb2FkKSB7CiAgICB2YXIgcGF5bG9hZE1lbWJlciA9IHJ1bGVzLm1lbWJlcnNbcnVsZXMucGF5bG9hZF07CiAgICB2YXIgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHk7CiAgICBpZiAocGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtKSB7CiAgICAgIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHV0aWwuY3JlYXRlRXZlbnRTdHJlYW0oCiAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiBib2R5LAogICAgICAgIHBhcnNlciwKICAgICAgICBwYXlsb2FkTWVtYmVyCiAgICAgICk7CiAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScgfHwgcGF5bG9hZE1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgdmFyIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LCBwYXlsb2FkTWVtYmVyKTsKICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IGJvZHk7CiAgICB9IGVsc2UgewogICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGRhdGEgPSByZXNwLmRhdGE7CiAgICBKc29uLmV4dHJhY3REYXRhKHJlc3ApOwogICAgcmVzcC5kYXRhID0gdXRpbC5tZXJnZShkYXRhLCByZXNwLmRhdGEpOwogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCn07Cgp9LHsiLi4vanNvbi9idWlsZGVyIjozNywiLi4vanNvbi9wYXJzZXIiOjM4LCIuLi91dGlsIjo3MiwiLi9qc29uIjo0NywiLi9yZXN0Ijo0OX1dLDUxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CgpmdW5jdGlvbiBwb3B1bGF0ZUJvZHkocmVxKSB7CiAgdmFyIGlucHV0ID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgdmFyIGJ1aWxkZXIgPSBuZXcgQVdTLlhNTC5CdWlsZGVyKCk7CiAgdmFyIHBhcmFtcyA9IHJlcS5wYXJhbXM7CgogIHZhciBwYXlsb2FkID0gaW5wdXQucGF5bG9hZDsKICBpZiAocGF5bG9hZCkgewogICAgdmFyIHBheWxvYWRNZW1iZXIgPSBpbnB1dC5tZW1iZXJzW3BheWxvYWRdOwogICAgcGFyYW1zID0gcGFyYW1zW3BheWxvYWRdOwogICAgaWYgKHBhcmFtcyA9PT0gdW5kZWZpbmVkKSByZXR1cm47CgogICAgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgdmFyIHJvb3RFbGVtZW50ID0gcGF5bG9hZE1lbWJlci5uYW1lOwogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBwYXlsb2FkTWVtYmVyLCByb290RWxlbWVudCwgdHJ1ZSk7CiAgICB9IGVsc2UgeyAvLyBub24teG1sIHBheWxvYWQKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBwYXJhbXM7CiAgICB9CiAgfSBlbHNlIHsKICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci50b1hNTChwYXJhbXMsIGlucHV0LCBpbnB1dC5uYW1lIHx8CiAgICAgIGlucHV0LnNoYXBlIHx8IHV0aWwuc3RyaW5nLnVwcGVyRmlyc3QocmVxLm9wZXJhdGlvbikgKyAnUmVxdWVzdCcpOwogIH0KfQoKZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CgogIC8vIG5ldmVyIHNlbmQgYm9keSBwYXlsb2FkIG9uIEdFVC9IRUFECiAgaWYgKFsnR0VUJywgJ0hFQUQnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgcG9wdWxhdGVCb2R5KHJlcSk7CiAgfQp9CgpmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogIFJlc3QuZXh0cmFjdEVycm9yKHJlc3ApOwoKICB2YXIgZGF0YTsKICB0cnkgewogICAgZGF0YSA9IG5ldyBBV1MuWE1MLlBhcnNlcigpLnBhcnNlKHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgfSBjYXRjaCAoZSkgewogICAgZGF0YSA9IHsKICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgTWVzc2FnZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZQogICAgfTsKICB9CgogIGlmIChkYXRhLkVycm9ycykgZGF0YSA9IGRhdGEuRXJyb3JzOwogIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICBpZiAoZGF0YS5Db2RlKSB7CiAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgIG1lc3NhZ2U6IGRhdGEuTWVzc2FnZQogICAgfSk7CiAgfSBlbHNlIHsKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgIGNvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgIG1lc3NhZ2U6IG51bGwKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CgogIHZhciBwYXJzZXI7CiAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICB2YXIgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHk7CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwoKICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CgogIHZhciBwYXlsb2FkID0gb3V0cHV0LnBheWxvYWQ7CiAgaWYgKHBheWxvYWQpIHsKICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICBpZiAocGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtKSB7CiAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyID8gcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtIDogcmVzcC5odHRwUmVzcG9uc2UuYm9keSwKICAgICAgICBwYXJzZXIsCiAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICApOwogICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSBwYXJzZXIucGFyc2UoYm9keS50b1N0cmluZygpLCBwYXlsb2FkTWVtYmVyKTsKICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IGJvZHk7CiAgICB9IGVsc2UgewogICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgIH0KICB9IGVsc2UgaWYgKGJvZHkubGVuZ3RoID4gMCkgewogICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIG91dHB1dCk7CiAgICB1dGlsLnVwZGF0ZShyZXNwLmRhdGEsIGRhdGEpOwogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCn07Cgp9LHsiLi4vY29yZSI6MTksIi4uL3V0aWwiOjcyLCIuL3Jlc3QiOjQ5fV0sNTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKCmZ1bmN0aW9uIFF1ZXJ5UGFyYW1TZXJpYWxpemVyKCkgewp9CgpRdWVyeVBhcmFtU2VyaWFsaXplci5wcm90b3R5cGUuc2VyaWFsaXplID0gZnVuY3Rpb24ocGFyYW1zLCBzaGFwZSwgZm4pIHsKICBzZXJpYWxpemVTdHJ1Y3R1cmUoJycsIHBhcmFtcywgc2hhcGUsIGZuKTsKfTsKCmZ1bmN0aW9uIHVjZmlyc3Qoc2hhcGUpIHsKICBpZiAoc2hhcGUuaXNRdWVyeU5hbWUgfHwgc2hhcGUuYXBpLnByb3RvY29sICE9PSAnZWMyJykgewogICAgcmV0dXJuIHNoYXBlLm5hbWU7CiAgfSBlbHNlIHsKICAgIHJldHVybiBzaGFwZS5uYW1lWzBdLnRvVXBwZXJDYXNlKCkgKyBzaGFwZS5uYW1lLnN1YnN0cigxKTsKICB9Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZVN0cnVjdHVyZShwcmVmaXgsIHN0cnVjdCwgcnVsZXMsIGZuKSB7CiAgdXRpbC5lYWNoKHJ1bGVzLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgdmFyIHZhbHVlID0gc3RydWN0W25hbWVdOwogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKCiAgICB2YXIgbWVtYmVyTmFtZSA9IHVjZmlyc3QobWVtYmVyKTsKICAgIG1lbWJlck5hbWUgPSBwcmVmaXggPyBwcmVmaXggKyAnLicgKyBtZW1iZXJOYW1lIDogbWVtYmVyTmFtZTsKICAgIHNlcmlhbGl6ZU1lbWJlcihtZW1iZXJOYW1lLCB2YWx1ZSwgbWVtYmVyLCBmbik7CiAgfSk7Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZU1hcChuYW1lLCBtYXAsIHJ1bGVzLCBmbikgewogIHZhciBpID0gMTsKICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgdmFyIHByZWZpeCA9IHJ1bGVzLmZsYXR0ZW5lZCA/ICcuJyA6ICcuZW50cnkuJzsKICAgIHZhciBwb3NpdGlvbiA9IHByZWZpeCArIChpKyspICsgJy4nOwogICAgdmFyIGtleU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy5rZXkubmFtZSB8fCAna2V5Jyk7CiAgICB2YXIgdmFsdWVOYW1lID0gcG9zaXRpb24gKyAocnVsZXMudmFsdWUubmFtZSB8fCAndmFsdWUnKTsKICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsga2V5TmFtZSwga2V5LCBydWxlcy5rZXksIGZuKTsKICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgdmFsdWVOYW1lLCB2YWx1ZSwgcnVsZXMudmFsdWUsIGZuKTsKICB9KTsKfQoKZnVuY3Rpb24gc2VyaWFsaXplTGlzdChuYW1lLCBsaXN0LCBydWxlcywgZm4pIHsKICB2YXIgbWVtYmVyUnVsZXMgPSBydWxlcy5tZW1iZXIgfHwge307CgogIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgewogICAgZm4uY2FsbCh0aGlzLCBuYW1lLCBudWxsKTsKICAgIHJldHVybjsKICB9CgogIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uICh2LCBuKSB7CiAgICB2YXIgc3VmZml4ID0gJy4nICsgKG4gKyAxKTsKICAgIGlmIChydWxlcy5hcGkucHJvdG9jb2wgPT09ICdlYzInKSB7CiAgICAgIC8vIERvIG5vdGhpbmcgZm9yIEVDMgogICAgICBzdWZmaXggPSBzdWZmaXggKyAnJzsgLy8gbWFrZSBsaW50ZXIgaGFwcHkKICAgIH0gZWxzZSBpZiAocnVsZXMuZmxhdHRlbmVkKSB7CiAgICAgIGlmIChtZW1iZXJSdWxlcy5uYW1lKSB7CiAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpOwogICAgICAgIHBhcnRzLnBvcCgpOwogICAgICAgIHBhcnRzLnB1c2godWNmaXJzdChtZW1iZXJSdWxlcykpOwogICAgICAgIG5hbWUgPSBwYXJ0cy5qb2luKCcuJyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN1ZmZpeCA9ICcuJyArIChtZW1iZXJSdWxlcy5uYW1lID8gbWVtYmVyUnVsZXMubmFtZSA6ICdtZW1iZXInKSArIHN1ZmZpeDsKICAgIH0KICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgc3VmZml4LCB2LCBtZW1iZXJSdWxlcywgZm4pOwogIH0pOwp9CgpmdW5jdGlvbiBzZXJpYWxpemVNZW1iZXIobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbikgewogIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgaWYgKHJ1bGVzLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICBzZXJpYWxpemVTdHJ1Y3R1cmUobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgfSBlbHNlIGlmIChydWxlcy50eXBlID09PSAnbGlzdCcpIHsKICAgIHNlcmlhbGl6ZUxpc3QobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgfSBlbHNlIGlmIChydWxlcy50eXBlID09PSAnbWFwJykgewogICAgc2VyaWFsaXplTWFwKG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogIH0gZWxzZSB7CiAgICBmbihuYW1lLCBydWxlcy50b1dpcmVGb3JtYXQodmFsdWUpLnRvU3RyaW5nKCkpOwogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBRdWVyeVBhcmFtU2VyaWFsaXplcjsKCn0seyIuLi91dGlsIjo3Mn1dLDUzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7CiAgLy9wcm92aWRlIHJlYWx0aW1lIGNsb2NrIGZvciBwZXJmb3JtYW5jZSBtZWFzdXJlbWVudAogIG5vdzogZnVuY3Rpb24gbm93KCkgewogICAgaWYgKHR5cGVvZiBwZXJmb3JtYW5jZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB9CiAgICByZXR1cm4gRGF0ZS5ub3coKTsKICB9Cn07Cgp9LHt9XSw1NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmZ1bmN0aW9uIGlzRmlwc1JlZ2lvbihyZWdpb24pIHsKICByZXR1cm4gdHlwZW9mIHJlZ2lvbiA9PT0gJ3N0cmluZycgJiYgKHJlZ2lvbi5zdGFydHNXaXRoKCdmaXBzLScpIHx8IHJlZ2lvbi5lbmRzV2l0aCgnLWZpcHMnKSk7Cn0KCmZ1bmN0aW9uIGlzR2xvYmFsUmVnaW9uKHJlZ2lvbikgewogIHJldHVybiB0eXBlb2YgcmVnaW9uID09PSAnc3RyaW5nJyAmJiBbJ2F3cy1nbG9iYWwnLCAnYXdzLXVzLWdvdi1nbG9iYWwnXS5pbmNsdWRlcyhyZWdpb24pOwp9CgpmdW5jdGlvbiBnZXRSZWFsUmVnaW9uKHJlZ2lvbikgewogIHJldHVybiBbJ2ZpcHMtYXdzLWdsb2JhbCcsICdhd3MtZmlwcycsICdhd3MtZ2xvYmFsJ10uaW5jbHVkZXMocmVnaW9uKQogICAgICA/ICd1cy1lYXN0LTEnCiAgICAgIDogWydmaXBzLWF3cy11cy1nb3YtZ2xvYmFsJywgJ2F3cy11cy1nb3YtZ2xvYmFsJ10uaW5jbHVkZXMocmVnaW9uKQogICAgICA/ICd1cy1nb3Ytd2VzdC0xJwogICAgICA6IHJlZ2lvbi5yZXBsYWNlKC9maXBzLShka3ItfHByb2QtKT98LWZpcHMvLCAnJyk7Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIGlzRmlwc1JlZ2lvbjogaXNGaXBzUmVnaW9uLAogIGlzR2xvYmFsUmVnaW9uOiBpc0dsb2JhbFJlZ2lvbiwKICBnZXRSZWFsUmVnaW9uOiBnZXRSZWFsUmVnaW9uCn07Cgp9LHt9XSw1NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CnZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWdfZGF0YS5qc29uJyk7CgpmdW5jdGlvbiBnZW5lcmF0ZVJlZ2lvblByZWZpeChyZWdpb24pIHsKICBpZiAoIXJlZ2lvbikgcmV0dXJuIG51bGw7CiAgdmFyIHBhcnRzID0gcmVnaW9uLnNwbGl0KCctJyk7CiAgaWYgKHBhcnRzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwogIHJldHVybiBwYXJ0cy5zbGljZSgwLCBwYXJ0cy5sZW5ndGggLSAyKS5qb2luKCctJykgKyAnLSonOwp9CgpmdW5jdGlvbiBkZXJpdmVkS2V5cyhzZXJ2aWNlKSB7CiAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICB2YXIgcmVnaW9uUHJlZml4ID0gZ2VuZXJhdGVSZWdpb25QcmVmaXgocmVnaW9uKTsKICB2YXIgZW5kcG9pbnRQcmVmaXggPSBzZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeDsKCiAgcmV0dXJuIFsKICAgIFtyZWdpb24sIGVuZHBvaW50UHJlZml4XSwKICAgIFtyZWdpb25QcmVmaXgsIGVuZHBvaW50UHJlZml4XSwKICAgIFtyZWdpb24sICcqJ10sCiAgICBbcmVnaW9uUHJlZml4LCAnKiddLAogICAgWycqJywgZW5kcG9pbnRQcmVmaXhdLAogICAgWycqJywgJyonXQogIF0ubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgIHJldHVybiBpdGVtWzBdICYmIGl0ZW1bMV0gPyBpdGVtLmpvaW4oJy8nKSA6IG51bGw7CiAgfSk7Cn0KCmZ1bmN0aW9uIGFwcGx5Q29uZmlnKHNlcnZpY2UsIGNvbmZpZykgewogIHV0aWwuZWFjaChjb25maWcsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIGlmIChrZXkgPT09ICdnbG9iYWxFbmRwb2ludCcpIHJldHVybjsKICAgIGlmIChzZXJ2aWNlLmNvbmZpZ1trZXldID09PSB1bmRlZmluZWQgfHwgc2VydmljZS5jb25maWdba2V5XSA9PT0gbnVsbCkgewogICAgICBzZXJ2aWNlLmNvbmZpZ1trZXldID0gdmFsdWU7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGNvbmZpZ3VyZUVuZHBvaW50KHNlcnZpY2UpIHsKICB2YXIga2V5cyA9IGRlcml2ZWRLZXlzKHNlcnZpY2UpOwogIHZhciB1c2VGaXBzRW5kcG9pbnQgPSBzZXJ2aWNlLmNvbmZpZy51c2VGaXBzRW5kcG9pbnQ7CiAgdmFyIHVzZUR1YWxzdGFja0VuZHBvaW50ID0gc2VydmljZS5jb25maWcudXNlRHVhbHN0YWNrRW5kcG9pbnQ7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgIGlmICgha2V5KSBjb250aW51ZTsKCiAgICB2YXIgcnVsZXMgPSB1c2VGaXBzRW5kcG9pbnQKICAgICAgPyB1c2VEdWFsc3RhY2tFbmRwb2ludAogICAgICAgID8gcmVnaW9uQ29uZmlnLmR1YWxzdGFja0ZpcHNSdWxlcwogICAgICAgIDogcmVnaW9uQ29uZmlnLmZpcHNSdWxlcwogICAgICA6IHVzZUR1YWxzdGFja0VuZHBvaW50CiAgICAgID8gcmVnaW9uQ29uZmlnLmR1YWxzdGFja1J1bGVzCiAgICAgIDogcmVnaW9uQ29uZmlnLnJ1bGVzOwoKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocnVsZXMsIGtleSkpIHsKICAgICAgdmFyIGNvbmZpZyA9IHJ1bGVzW2tleV07CiAgICAgIGlmICh0eXBlb2YgY29uZmlnID09PSAnc3RyaW5nJykgewogICAgICAgIGNvbmZpZyA9IHJlZ2lvbkNvbmZpZy5wYXR0ZXJuc1tjb25maWddOwogICAgICB9CgogICAgICAvLyBzZXQgZ2xvYmFsIGVuZHBvaW50CiAgICAgIHNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCA9ICEhY29uZmlnLmdsb2JhbEVuZHBvaW50OwogICAgICBpZiAoY29uZmlnLnNpZ25pbmdSZWdpb24pIHsKICAgICAgICBzZXJ2aWNlLnNpZ25pbmdSZWdpb24gPSBjb25maWcuc2lnbmluZ1JlZ2lvbjsKICAgICAgfQoKICAgICAgLy8gc2lnbmF0dXJlIHZlcnNpb24KICAgICAgaWYgKCFjb25maWcuc2lnbmF0dXJlVmVyc2lvbikgY29uZmlnLnNpZ25hdHVyZVZlcnNpb24gPSAndjQnOwoKICAgICAgLy8gbWVyZ2UgY29uZmlnCiAgICAgIGFwcGx5Q29uZmlnKHNlcnZpY2UsIGNvbmZpZyk7CiAgICAgIHJldHVybjsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGdldEVuZHBvaW50U3VmZml4KHJlZ2lvbikgewogIHZhciByZWdpb25SZWdleGVzID0gewogICAgJ14odXN8ZXV8YXB8c2F8Y2F8bWUpXFwtXFx3K1xcLVxcZCskJzogJ2FtYXpvbmF3cy5jb20nLAogICAgJ15jblxcLVxcdytcXC1cXGQrJCc6ICdhbWF6b25hd3MuY29tLmNuJywKICAgICdedXNcXC1nb3ZcXC1cXHcrXFwtXFxkKyQnOiAnYW1hem9uYXdzLmNvbScsCiAgICAnXnVzXFwtaXNvXFwtXFx3K1xcLVxcZCskJzogJ2Mycy5pYy5nb3YnLAogICAgJ151c1xcLWlzb2JcXC1cXHcrXFwtXFxkKyQnOiAnc2Mycy5zZ292LmdvdicKICB9OwogIHZhciBkZWZhdWx0U3VmZml4ID0gJ2FtYXpvbmF3cy5jb20nOwogIHZhciByZWdleGVzID0gT2JqZWN0LmtleXMocmVnaW9uUmVnZXhlcyk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdleGVzLmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgcmVnaW9uUGF0dGVybiA9IFJlZ0V4cChyZWdleGVzW2ldKTsKICAgIHZhciBkbnNTdWZmaXggPSByZWdpb25SZWdleGVzW3JlZ2V4ZXNbaV1dOwogICAgaWYgKHJlZ2lvblBhdHRlcm4udGVzdChyZWdpb24pKSByZXR1cm4gZG5zU3VmZml4OwogIH0KICByZXR1cm4gZGVmYXVsdFN1ZmZpeDsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgY29uZmlndXJlRW5kcG9pbnQ6IGNvbmZpZ3VyZUVuZHBvaW50LAogIGdldEVuZHBvaW50U3VmZml4OiBnZXRFbmRwb2ludFN1ZmZpeCwKfTsKCn0seyIuL3JlZ2lvbl9jb25maWdfZGF0YS5qc29uIjo1NiwiLi91dGlsIjo3Mn1dLDU2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJydWxlcyI6IHsKICAgICIqLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiY24tKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICB9LAogICAgInVzLWlzby0qLyoiOiAidXNJc28iLAogICAgInVzLWlzb2ItKi8qIjogInVzSXNvYiIsCiAgICAiKi9idWRnZXRzIjogImdsb2JhbFNTTCIsCiAgICAiKi9jbG91ZGZyb250IjogImdsb2JhbFNTTCIsCiAgICAiKi9zdHMiOiAiZ2xvYmFsU1NMIiwKICAgICIqL2ltcG9ydGV4cG9ydCI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICB9LAoKICAgICIqL3JvdXRlNTMiOiAiZ2xvYmFsU1NMIiwKICAgICJjbi0qL3JvdXRlNTMiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbS5jbiIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUsCiAgICAgICJzaWduaW5nUmVnaW9uIjogImNuLW5vcnRod2VzdC0xIgogICAgfSwKICAgICJ1cy1nb3YtKi9yb3V0ZTUzIjogImdsb2JhbEdvdkNsb3VkIiwKICAgICJ1cy1pc28tKi9yb3V0ZTUzIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmMycy5pYy5nb3YiLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlLAogICAgICAic2lnbmluZ1JlZ2lvbiI6ICJ1cy1pc28tZWFzdC0xIgogICAgfSwKICAgICJ1cy1pc29iLSovcm91dGU1MyI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5zYzJzLnNnb3YuZ292IiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZSwKICAgICAgInNpZ25pbmdSZWdpb24iOiAidXMtaXNvYi1lYXN0LTEiCiAgICB9LAoKICAgICIqL3dhZiI6ICJnbG9iYWxTU0wiLAoKICAgICIqL2lhbSI6ICJnbG9iYWxTU0wiLAogICAgImNuLSovaWFtIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmNuLW5vcnRoLTEuYW1hem9uYXdzLmNvbS5jbiIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUsCiAgICAgICJzaWduaW5nUmVnaW9uIjogImNuLW5vcnRoLTEiCiAgICB9LAogICAgInVzLWdvdi0qL2lhbSI6ICJnbG9iYWxHb3ZDbG91ZCIsCgogICAgInVzLWdvdi0qL3N0cyI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJ1cy1nb3Ytd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJ1cy13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgInVzLXdlc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAiZXUtd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJhcC1zb3V0aGVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAiYXAtc291dGhlYXN0LTIvczMiOiAiczNzaWduYXR1cmUiLAogICAgImFwLW5vcnRoZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJzYS1lYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgInVzLWVhc3QtMS9zMyI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICB9LAogICAgInVzLWVhc3QtMS9zZGIiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgfSwKICAgICIqL3NkYiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiCiAgICB9CiAgfSwKCiAgImZpcHNSdWxlcyI6IHsKICAgICIqLyoiOiAiZmlwc1N0YW5kYXJkIiwKICAgICJ1cy1nb3YtKi8qIjogImZpcHNTdGFuZGFyZCIsCiAgICAidXMtaXNvLSovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLntyZWdpb259LmMycy5pYy5nb3YiCiAgICB9LAogICAgInVzLWlzby0qL2RtcyI6ICJ1c0lzbyIsCiAgICAidXMtaXNvYi0qLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy57cmVnaW9ufS5zYzJzLnNnb3YuZ292IgogICAgfSwKICAgICJ1cy1pc29iLSovZG1zIjogInVzSXNvYiIsCiAgICAiY24tKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMue3JlZ2lvbn0uYW1hem9uYXdzLmNvbS5jbiIKICAgIH0sCiAgICAiKi9hcGkuZWNyIjogImZpcHMuYXBpLmVjciIsCiAgICAiKi9hcGkuc2FnZW1ha2VyIjogImZpcHMuYXBpLnNhZ2VtYWtlciIsCiAgICAiKi9iYXRjaCI6ICJmaXBzRG90UHJlZml4IiwKICAgICIqL2VrcyI6ICJmaXBzRG90UHJlZml4IiwKICAgICIqL21vZGVscy5sZXgiOiAiZmlwcy5tb2RlbHMubGV4IiwKICAgICIqL3J1bnRpbWUubGV4IjogImZpcHMucnVudGltZS5sZXgiLAogICAgIiovcnVudGltZS5zYWdlbWFrZXIiOiB7CiAgICAgICJlbmRwb2ludCI6ICJydW50aW1lLWZpcHMuc2FnZW1ha2VyLntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgIiovaWFtIjogImZpcHNXaXRob3V0UmVnaW9uIiwKICAgICIqL3JvdXRlNTMiOiAiZmlwc1dpdGhvdXRSZWdpb24iLAogICAgIiovdHJhbnNjcmliZSI6ICJmaXBzRG90UHJlZml4IiwKICAgICIqL3dhZiI6ICJmaXBzV2l0aG91dFJlZ2lvbiIsCgogICAgInVzLWdvdi0qL3RyYW5zY3JpYmUiOiAiZmlwc0RvdFByZWZpeCIsCiAgICAidXMtZ292LSovYXBpLmVjciI6ICJmaXBzLmFwaS5lY3IiLAogICAgInVzLWdvdi0qL2FwaS5zYWdlbWFrZXIiOiAiZmlwcy5hcGkuc2FnZW1ha2VyIiwKICAgICJ1cy1nb3YtKi9tb2RlbHMubGV4IjogImZpcHMubW9kZWxzLmxleCIsCiAgICAidXMtZ292LSovcnVudGltZS5sZXgiOiAiZmlwcy5ydW50aW1lLmxleCIsCiAgICAidXMtZ292LSovYWNtLXBjYSI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9iYXRjaCI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9jb25maWciOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovZWtzIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2VsYXN0aWNtYXByZWR1Y2UiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovaWRlbnRpdHlzdG9yZSI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9keW5hbW9kYiI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9lbGFzdGljbG9hZGJhbGFuY2luZyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9ndWFyZGR1dHkiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovbW9uaXRvcmluZyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9yZXNvdXJjZS1ncm91cHMiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovcnVudGltZS5zYWdlbWFrZXIiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovc2VydmljZWNhdGFsb2ctYXBwcmVnaXN0cnkiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovc2VydmljZXF1b3RhcyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9zc20iOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovc3RzIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL3N1cHBvcnQiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LXdlc3QtMS9zdGF0ZXMiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtaXNvLWVhc3QtMS9lbGFzdGljZmlsZXN5c3RlbSI6IHsKICAgICAgImVuZHBvaW50IjogImVsYXN0aWNmaWxlc3lzdGVtLWZpcHMue3JlZ2lvbn0uYzJzLmljLmdvdiIKICAgIH0sCiAgICAidXMtZ292LXdlc3QtMS9vcmdhbml6YXRpb25zIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi13ZXN0LTEvcm91dGU1MyI6IHsKICAgICAgImVuZHBvaW50IjogInJvdXRlNTMudXMtZ292LmFtYXpvbmF3cy5jb20iCiAgICB9CiAgfSwKCiAgImR1YWxzdGFja1J1bGVzIjogewogICAgIiovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hcGkuYXdzIgogICAgfSwKICAgICJjbi0qLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYXBpLmFtYXpvbndlYnNlcnZpY2VzLmNvbS5jbiIKICAgIH0sCgogICAgIiovczMiOiAiZHVhbHN0YWNrTGVnYWN5IiwKICAgICJjbi0qL3MzIjogImR1YWxzdGFja0xlZ2FjeUNuIiwKICAgICIqL3MzLWNvbnRyb2wiOiAiZHVhbHN0YWNrTGVnYWN5IiwKICAgICJjbi0qL3MzLWNvbnRyb2wiOiAiZHVhbHN0YWNrTGVnYWN5Q24iLAoKICAgICJhcC1zb3V0aC0xL2VjMiI6ICJkdWFsc3RhY2tMZWdhY3lFYzIiLAogICAgImV1LXdlc3QtMS9lYzIiOiAiZHVhbHN0YWNrTGVnYWN5RWMyIiwKICAgICJzYS1lYXN0LTEvZWMyIjogImR1YWxzdGFja0xlZ2FjeUVjMiIsCiAgICAidXMtZWFzdC0xL2VjMiI6ICJkdWFsc3RhY2tMZWdhY3lFYzIiLAogICAgInVzLWVhc3QtMi9lYzIiOiAiZHVhbHN0YWNrTGVnYWN5RWMyIiwKICAgICJ1cy13ZXN0LTIvZWMyIjogImR1YWxzdGFja0xlZ2FjeUVjMiIKICB9LAoKICAiZHVhbHN0YWNrRmlwc1J1bGVzIjogewogICAgIiovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLntyZWdpb259LmFwaS5hd3MiCiAgICB9LAogICAgImNuLSovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLntyZWdpb259LmFwaS5hbWF6b253ZWJzZXJ2aWNlcy5jb20uY24iCiAgICB9LAogICAgIiovczMiOiAiZHVhbHN0YWNrRmlwc0xlZ2FjeSIsCiAgICAiY24tKi9zMyI6ICJkdWFsc3RhY2tGaXBzTGVnYWN5Q24iLAogICAgIiovczMtY29udHJvbCI6ICJkdWFsc3RhY2tGaXBzTGVnYWN5IiwKICAgICJjbi0qL3MzLWNvbnRyb2wiOiAiZHVhbHN0YWNrRmlwc0xlZ2FjeUNuIgogIH0sCgogICJwYXR0ZXJucyI6IHsKICAgICJnbG9iYWxTU0wiOiB7CiAgICAgICJlbmRwb2ludCI6ICJodHRwczovL3tzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZSwKICAgICAgInNpZ25pbmdSZWdpb24iOiAidXMtZWFzdC0xIgogICAgfSwKICAgICJnbG9iYWxHb3ZDbG91ZCI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS51cy1nb3YuYW1hem9uYXdzLmNvbSIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUsCiAgICAgICJzaWduaW5nUmVnaW9uIjogInVzLWdvdi13ZXN0LTEiCiAgICB9LAogICAgInMzc2lnbmF0dXJlIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJzMyIKICAgIH0sCiAgICAidXNJc28iOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYzJzLmljLmdvdiIKICAgIH0sCiAgICAidXNJc29iIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LnNjMnMuc2dvdi5nb3YiCiAgICB9LAogICAgImZpcHNTdGFuZGFyZCI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImZpcHNEb3RQcmVmaXgiOiB7CiAgICAgICJlbmRwb2ludCI6ICJmaXBzLntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJmaXBzV2l0aG91dFJlZ2lvbiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImZpcHMuYXBpLmVjciI6IHsKICAgICAgImVuZHBvaW50IjogImVjci1maXBzLntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImZpcHMuYXBpLnNhZ2VtYWtlciI6IHsKICAgICAgImVuZHBvaW50IjogImFwaS1maXBzLnNhZ2VtYWtlci57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJmaXBzLm1vZGVscy5sZXgiOiB7CiAgICAgICJlbmRwb2ludCI6ICJtb2RlbHMtZmlwcy5sZXgue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZmlwcy5ydW50aW1lLmxleCI6IHsKICAgICAgImVuZHBvaW50IjogInJ1bnRpbWUtZmlwcy5sZXgue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZmlwc1dpdGhTZXJ2aWNlT25seSI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJkdWFsc3RhY2tMZWdhY3kiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImR1YWxzdGFja0xlZ2FjeUNuIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmR1YWxzdGFjay57cmVnaW9ufS5hbWF6b25hd3MuY29tLmNuIgogICAgfSwKICAgICJkdWFsc3RhY2tGaXBzTGVnYWN5IjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMuZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImR1YWxzdGFja0ZpcHNMZWdhY3lDbiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLmR1YWxzdGFjay57cmVnaW9ufS5hbWF6b25hd3MuY29tLmNuIgogICAgfSwKICAgICJkdWFsc3RhY2tMZWdhY3lFYzIiOiB7CiAgICAgICJlbmRwb2ludCI6ICJhcGkuZWMyLntyZWdpb259LmF3cyIKICAgIH0KICB9Cn0KCn0se31dLDU3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKdmFyIEFjY2VwdG9yU3RhdGVNYWNoaW5lID0gcmVxdWlyZSgnLi9zdGF0ZV9tYWNoaW5lJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKdmFyIGRvbWFpbiA9IEFXUy51dGlsLmRvbWFpbjsKdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciBoYXJkRXJyb3JTdGF0ZXMgPSB7c3VjY2VzczogMSwgZXJyb3I6IDEsIGNvbXBsZXRlOiAxfTsKCmZ1bmN0aW9uIGlzVGVybWluYWxTdGF0ZShtYWNoaW5lKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChoYXJkRXJyb3JTdGF0ZXMsIG1hY2hpbmUuX2FzbS5jdXJyZW50U3RhdGUpOwp9Cgp2YXIgZnNtID0gbmV3IEFjY2VwdG9yU3RhdGVNYWNoaW5lKCk7CmZzbS5zZXR1cFN0YXRlcyA9IGZ1bmN0aW9uKCkgewogIHZhciB0cmFuc2l0aW9uID0gZnVuY3Rpb24oXywgZG9uZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvciA9IGZhbHNlOwoKICAgIHNlbGYuZW1pdChzZWxmLl9hc20uY3VycmVudFN0YXRlLCBmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKGVycikgewogICAgICAgIGlmIChpc1Rlcm1pbmFsU3RhdGUoc2VsZikpIHsKICAgICAgICAgIGlmIChkb21haW4gJiYgc2VsZi5kb21haW4gaW5zdGFuY2VvZiBkb21haW4uRG9tYWluKSB7CiAgICAgICAgICAgIGVyci5kb21haW5FbWl0dGVyID0gc2VsZjsKICAgICAgICAgICAgZXJyLmRvbWFpbiA9IHNlbGYuZG9tYWluOwogICAgICAgICAgICBlcnIuZG9tYWluVGhyb3duID0gZmFsc2U7CiAgICAgICAgICAgIHNlbGYuZG9tYWluLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICAgIGRvbmUoZXJyKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9uZShzZWxmLnJlc3BvbnNlLmVycm9yKTsKICAgICAgfQogICAgfSk7CgogIH07CgogIHRoaXMuYWRkU3RhdGUoJ3ZhbGlkYXRlJywgJ2J1aWxkJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnYnVpbGQnLCAnYWZ0ZXJCdWlsZCcsICdyZXN0YXJ0JywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnYWZ0ZXJCdWlsZCcsICdzaWduJywgJ3Jlc3RhcnQnLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdzaWduJywgJ3NlbmQnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdyZXRyeScsICdhZnRlclJldHJ5JywgJ2FmdGVyUmV0cnknLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdhZnRlclJldHJ5JywgJ3NpZ24nLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdzZW5kJywgJ3ZhbGlkYXRlUmVzcG9uc2UnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCd2YWxpZGF0ZVJlc3BvbnNlJywgJ2V4dHJhY3REYXRhJywgJ2V4dHJhY3RFcnJvcicsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ2V4dHJhY3RFcnJvcicsICdleHRyYWN0RGF0YScsICdyZXRyeScsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ2V4dHJhY3REYXRhJywgJ3N1Y2Nlc3MnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdyZXN0YXJ0JywgJ2J1aWxkJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnc3VjY2VzcycsICdjb21wbGV0ZScsICdjb21wbGV0ZScsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ2Vycm9yJywgJ2NvbXBsZXRlJywgJ2NvbXBsZXRlJywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnY29tcGxldGUnLCBudWxsLCBudWxsLCB0cmFuc2l0aW9uKTsKfTsKZnNtLnNldHVwU3RhdGVzKCk7CgovKioKICogIyMgQXN5bmNocm9ub3VzIFJlcXVlc3RzCiAqCiAqIEFsbCByZXF1ZXN0cyBtYWRlIHRocm91Z2ggdGhlIFNESyBhcmUgYXN5bmNocm9ub3VzIGFuZCB1c2UgYQogKiBjYWxsYmFjayBpbnRlcmZhY2UuIEVhY2ggc2VydmljZSBtZXRob2QgdGhhdCBraWNrcyBvZmYgYSByZXF1ZXN0CiAqIHJldHVybnMgYW4gYEFXUy5SZXF1ZXN0YCBvYmplY3QgdGhhdCB5b3UgY2FuIHVzZSB0byByZWdpc3RlcgogKiBjYWxsYmFja3MuCiAqCiAqIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIHNlcnZpY2UgbWV0aG9kIHJldHVybnMgdGhlIHJlcXVlc3QKICogb2JqZWN0IGFzICJyZXF1ZXN0Iiwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIC8vIHJlcXVlc3QgaXMgYW4gQVdTLlJlcXVlc3Qgb2JqZWN0CiAqIHZhciByZXF1ZXN0ID0gZWMyLmRlc2NyaWJlSW5zdGFuY2VzKCk7CiAqCiAqIC8vIHJlZ2lzdGVyIGNhbGxiYWNrcyBvbiByZXF1ZXN0IHRvIHJldHJpZXZlIHJlc3BvbnNlIGRhdGEKICogcmVxdWVzdC5vbignc3VjY2VzcycsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAqICAgY29uc29sZS5sb2cocmVzcG9uc2UuZGF0YSk7CiAqIH0pOwogKiBgYGAKICoKICogV2hlbiBhIHJlcXVlc3QgaXMgcmVhZHkgdG8gYmUgc2VudCwgdGhlIHtzZW5kfSBtZXRob2Qgc2hvdWxkCiAqIGJlIGNhbGxlZDoKICoKICogYGBgamF2YXNjcmlwdAogKiByZXF1ZXN0LnNlbmQoKTsKICogYGBgCiAqCiAqIFNpbmNlIHJlZ2lzdGVyZWQgY2FsbGJhY2tzIG1heSBvciBtYXkgbm90IGJlIGlkZW1wb3RlbnQsIHJlcXVlc3RzIHNob3VsZCBvbmx5CiAqIGJlIHNlbnQgb25jZS4gVG8gcGVyZm9ybSB0aGUgc2FtZSBvcGVyYXRpb24gbXVsdGlwbGUgdGltZXMsIHlvdSB3aWxsIG5lZWQgdG8KICogY3JlYXRlIG11bHRpcGxlIHJlcXVlc3Qgb2JqZWN0cywgZWFjaCB3aXRoIGl0cyBvd24gcmVnaXN0ZXJlZCBjYWxsYmFja3MuCiAqCiAqICMjIFJlbW92aW5nIERlZmF1bHQgTGlzdGVuZXJzIGZvciBFdmVudHMKICoKICogUmVxdWVzdCBvYmplY3RzIGFyZSBidWlsdCB3aXRoIGRlZmF1bHQgbGlzdGVuZXJzIGZvciB0aGUgdmFyaW91cyBldmVudHMsCiAqIGRlcGVuZGluZyBvbiB0aGUgc2VydmljZSB0eXBlLiBJbiBzb21lIGNhc2VzLCB5b3UgbWF5IHdhbnQgdG8gcmVtb3ZlCiAqIHNvbWUgYnVpbHQtaW4gbGlzdGVuZXJzIHRvIGN1c3RvbWl6ZSBiZWhhdmlvdXIuIERvaW5nIHRoaXMgcmVxdWlyZXMKICogYWNjZXNzIHRvIHRoZSBidWlsdC1pbiBsaXN0ZW5lciBmdW5jdGlvbnMsIHdoaWNoIGFyZSBleHBvc2VkIHRocm91Z2gKICogdGhlIHtBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZX0gbmFtZXNwYWNlLiBGb3IgaW5zdGFuY2UsIHlvdSBtYXkKICogd2FudCB0byBjdXN0b21pemUgdGhlIEhUVFAgaGFuZGxlciB1c2VkIHdoZW4gc2VuZGluZyBhIHJlcXVlc3QuIEluIHRoaXMKICogY2FzZSwgeW91IGNhbiByZW1vdmUgdGhlIGJ1aWx0LWluIGxpc3RlbmVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgJ3NlbmQnCiAqIGV2ZW50LCB0aGUge0FXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkR9IGxpc3RlbmVyIGFuZCBhZGQgeW91ciBvd24uCiAqCiAqICMjIE11bHRpcGxlIENhbGxiYWNrcyBhbmQgQ2hhaW5pbmcKICoKICogWW91IGNhbiByZWdpc3RlciBtdWx0aXBsZSBjYWxsYmFja3Mgb24gYW55IHJlcXVlc3Qgb2JqZWN0LiBUaGUKICogY2FsbGJhY2tzIGNhbiBiZSByZWdpc3RlcmVkIGZvciBkaWZmZXJlbnQgZXZlbnRzLCBvciBhbGwgZm9yIHRoZQogKiBzYW1lIGV2ZW50LiBJbiBhZGRpdGlvbiwgeW91IGNhbiBjaGFpbiBjYWxsYmFjayByZWdpc3RyYXRpb24sIGZvcgogKiBleGFtcGxlOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIHJlcXVlc3QuCiAqICAgb24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbihyZXNwb25zZSkgewogKiAgICAgY29uc29sZS5sb2coIlN1Y2Nlc3MhIik7CiAqICAgfSkuCiAqICAgb24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyb3IsIHJlc3BvbnNlKSB7CiAqICAgICBjb25zb2xlLmxvZygiRXJyb3IhIik7CiAqICAgfSkuCiAqICAgb24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICogICAgIGNvbnNvbGUubG9nKCJBbHdheXMhIik7CiAqICAgfSkuCiAqICAgc2VuZCgpOwogKiBgYGAKICoKICogVGhlIGFib3ZlIGV4YW1wbGUgd2lsbCBwcmludCBlaXRoZXIgIlN1Y2Nlc3MhIEFsd2F5cyEiLCBvciAiRXJyb3IhIEFsd2F5cyEiLAogKiBkZXBlbmRpbmcgb24gd2hldGhlciB0aGUgcmVxdWVzdCBzdWNjZWVkZWQgb3Igbm90LgogKgogKiBAIWF0dHJpYnV0ZSBodHRwUmVxdWVzdAogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgSFRUUCBQcm9wZXJ0aWVzCiAqICAgQHJldHVybiBbQVdTLkh0dHBSZXF1ZXN0XSB0aGUgcmF3IEhUVFAgcmVxdWVzdCBvYmplY3QKICogICAgIGNvbnRhaW5pbmcgcmVxdWVzdCBoZWFkZXJzIGFuZCBib2R5IGluZm9ybWF0aW9uCiAqICAgICBzZW50IGJ5IHRoZSBzZXJ2aWNlLgogKgogKiBAIWF0dHJpYnV0ZSBzdGFydFRpbWUKICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAqICAgQHJldHVybiBbRGF0ZV0gdGhlIHRpbWUgdGhhdCB0aGUgcmVxdWVzdCBzdGFydGVkCiAqCiAqIEAhZ3JvdXAgUmVxdWVzdCBCdWlsZGluZyBFdmVudHMKICoKICogQCFldmVudCB2YWxpZGF0ZShyZXF1ZXN0KQogKiAgIFRyaWdnZXJlZCB3aGVuIGEgcmVxdWVzdCBpcyBiZWluZyB2YWxpZGF0ZWQuIExpc3RlbmVycwogKiAgIHNob3VsZCB0aHJvdyBhbiBlcnJvciBpZiB0aGUgcmVxdWVzdCBzaG91bGQgbm90IGJlIHNlbnQuCiAqICAgQHBhcmFtIHJlcXVlc3QgW1JlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBiZWluZyBzZW50CiAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUwogKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OCiAqICAgQGV4YW1wbGUgRW5zdXJpbmcgdGhhdCBhIGNlcnRhaW4gcGFyYW1ldGVyIGlzIHNldCBiZWZvcmUgc2VuZGluZyBhIHJlcXVlc3QKICogICAgIHZhciByZXEgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICogICAgIHJlcS5vbigndmFsaWRhdGUnLCBmdW5jdGlvbigpIHsKICogICAgICAgaWYgKCFyZXEucGFyYW1zLkJvZHkubWF0Y2goL15IZWxsb1xzLykpIHsKICogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JvZHkgbXVzdCBzdGFydCB3aXRoICJIZWxsbyAiJyk7CiAqICAgICAgIH0KICogICAgIH0pOwogKiAgICAgcmVxLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICoKICogQCFldmVudCBidWlsZChyZXF1ZXN0KQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IHBheWxvYWQgaXMgYmVpbmcgYnVpbHQuIExpc3RlbmVycwogKiAgIHNob3VsZCBmaWxsIHRoZSBuZWNlc3NhcnkgaW5mb3JtYXRpb24gdG8gc2VuZCB0aGUgcmVxdWVzdAogKiAgIG92ZXIgSFRUUC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH52YWxpZGF0ZSkKICogICBAZXhhbXBsZSBBZGQgYSBjdXN0b20gSFRUUCBoZWFkZXIgdG8gYSByZXF1ZXN0CiAqICAgICB2YXIgcmVxID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAqICAgICByZXEub24oJ2J1aWxkJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDdXN0b20tSGVhZGVyJ10gPSAndmFsdWUnOwogKiAgICAgfSk7CiAqICAgICByZXEuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogKgogKiBAIWV2ZW50IHNpZ24ocmVxdWVzdCkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyBiZWluZyBzaWduZWQuIExpc3RlbmVycyBzaG91bGQKICogICBhZGQgdGhlIGNvcnJlY3QgYXV0aGVudGljYXRpb24gaGVhZGVycyBhbmQvb3IgYWRqdXN0IHRoZSBib2R5LAogKiAgIGRlcGVuZGluZyBvbiB0aGUgYXV0aGVudGljYXRpb24gbWVjaGFuaXNtIGJlaW5nIHVzZWQuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+dmFsaWRhdGUpCiAqCiAqIEAhZ3JvdXAgUmVxdWVzdCBTZW5kaW5nIEV2ZW50cwogKgogKiBAIWV2ZW50IHNlbmQocmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgcmVhZHkgdG8gYmUgc2VudC4gTGlzdGVuZXJzCiAqICAgc2hvdWxkIGNhbGwgdGhlIHVuZGVybHlpbmcgdHJhbnNwb3J0IGxheWVyIHRvIGluaXRpYXRlCiAqICAgdGhlIHNlbmRpbmcgb2YgdGhlIHJlcXVlc3QuCiAqICAgQHBhcmFtIHJlc3BvbnNlIFtSZXNwb25zZV0gdGhlIHJlc3BvbnNlIG9iamVjdAogKiAgIEBjb250ZXh0IFtSZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgdGhhdCB3YXMgc2VudAogKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORAogKgogKiBAIWV2ZW50IHJldHJ5KHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIGEgcmVxdWVzdCBmYWlsZWQgYW5kIG1pZ2h0IG5lZWQgdG8gYmUgcmV0cmllZCBvciByZWRpcmVjdGVkLgogKiAgIElmIHRoZSByZXNwb25zZSBpcyByZXRyeWFibGUsIHRoZSBsaXN0ZW5lciBzaG91bGQgc2V0IHRoZQogKiAgIGByZXNwb25zZS5lcnJvci5yZXRyeWFibGVgIHByb3BlcnR5IHRvIGB0cnVlYCwgYW5kIG9wdGlvbmFsbHkgc2V0CiAqICAgYHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXlgIHRvIHRoZSBtaWxsaXNlY29uZCBkZWxheSBmb3IgdGhlIG5leHQgYXR0ZW1wdC4KICogICBJbiB0aGUgY2FzZSBvZiBhIHJlZGlyZWN0LCBgcmVzcG9uc2UuZXJyb3IucmVkaXJlY3RgIHNob3VsZCBiZSBzZXQgdG8KICogICBgdHJ1ZWAgd2l0aCBgcmV0cnlEZWxheWAgc2V0IHRvIGFuIG9wdGlvbmFsIGRlbGF5IG9uIHRoZSBuZXh0IHJlcXVlc3QuCiAqCiAqICAgSWYgYSBsaXN0ZW5lciBkZWNpZGVzIHRoYXQgYSByZXF1ZXN0IHNob3VsZCBub3QgYmUgcmV0cmllZCwKICogICBpdCBzaG91bGQgc2V0IGJvdGggYHJldHJ5YWJsZWAgYW5kIGByZWRpcmVjdGAgdG8gZmFsc2UuCiAqCiAqICAgTm90ZSB0aGF0IGEgcmV0cnlhYmxlIGVycm9yIHdpbGwgYmUgcmV0cmllZCBhdCBtb3N0CiAqICAge0FXUy5Db25maWcubWF4UmV0cmllc30gdGltZXMgKGJhc2VkIG9uIHRoZSBzZXJ2aWNlIG9iamVjdCdzIGNvbmZpZykuCiAqICAgU2ltaWxhcmx5LCBhIHJlcXVlc3QgdGhhdCBpcyByZWRpcmVjdGVkIHdpbGwgb25seSByZWRpcmVjdCBhdCBtb3N0CiAqICAge0FXUy5Db25maWcubWF4UmVkaXJlY3RzfSB0aW1lcy4KICoKICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAZXhhbXBsZSBBZGRpbmcgYSBjdXN0b20gcmV0cnkgZm9yIGEgNDA0IHJlc3BvbnNlCiAqICAgICByZXF1ZXN0Lm9uKCdyZXRyeScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAqICAgICAgIC8vIHRoaXMgcmVzb3VyY2UgaXMgbm90IHlldCBhdmFpbGFibGUsIHdhaXQgMTAgc2Vjb25kcyB0byBnZXQgaXQgYWdhaW4KICogICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MDQgJiYgcmVzcG9uc2UuZXJyb3IpIHsKICogICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeWFibGUgPSB0cnVlOyAgIC8vIHJldHJ5IHRoaXMgZXJyb3IKICogICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeURlbGF5ID0gMTAwMDA7IC8vIHdhaXQgMTAgc2Vjb25kcwogKiAgICAgICB9CiAqICAgICB9KTsKICoKICogQCFncm91cCBEYXRhIFBhcnNpbmcgRXZlbnRzCiAqCiAqIEAhZXZlbnQgZXh0cmFjdEVycm9yKHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCBvbiBhbGwgbm9uLTJ4eCByZXF1ZXN0cyBzbyB0aGF0IGxpc3RlbmVycyBjYW4gZXh0cmFjdAogKiAgIGVycm9yIGRldGFpbHMgZnJvbSB0aGUgcmVzcG9uc2UgYm9keS4gTGlzdGVuZXJzIHRvIHRoaXMgZXZlbnQKICogICBzaG91bGQgc2V0IHRoZSBgcmVzcG9uc2UuZXJyb3JgIHByb3BlcnR5LgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAIWV2ZW50IGV4dHJhY3REYXRhKHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCBpbiBzdWNjZXNzZnVsIHJlcXVlc3RzIHRvIGFsbG93IGxpc3RlbmVycyB0bwogKiAgIGRlLXNlcmlhbGl6ZSB0aGUgcmVzcG9uc2UgYm9keSBpbnRvIGByZXNwb25zZS5kYXRhYC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQCFncm91cCBDb21wbGV0aW9uIEV2ZW50cwogKgogKiBAIWV2ZW50IHN1Y2Nlc3MocmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4KICogICBgcmVzcG9uc2UuZGF0YWAgd2lsbCBjb250YWluIHRoZSByZXNwb25zZSBkYXRhIGFuZAogKiAgIGByZXNwb25zZS5lcnJvcmAgd2lsbCBiZSBudWxsLgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAIWV2ZW50IGVycm9yKGVycm9yLCByZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiBhbiBlcnJvciBvY2N1cnMgYXQgYW55IHBvaW50IGR1cmluZyB0aGUKICogICByZXF1ZXN0LiBgcmVzcG9uc2UuZXJyb3JgIHdpbGwgY29udGFpbiBkZXRhaWxzIGFib3V0IHRoZSBlcnJvcgogKiAgIHRoYXQgb2NjdXJyZWQuIGByZXNwb25zZS5kYXRhYCB3aWxsIGJlIG51bGwuCiAqICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCBjb250YWluaW5nIGRldGFpbHMgYWJvdXQKICogICAgIHRoZSBlcnJvciB0aGF0IG9jY3VycmVkLgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAIWV2ZW50IGNvbXBsZXRlKHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuZXZlciBhIHJlcXVlc3QgY3ljbGUgY29tcGxldGVzLiBgcmVzcG9uc2UuZXJyb3JgCiAqICAgc2hvdWxkIGJlIGNoZWNrZWQsIHNpbmNlIHRoZSByZXF1ZXN0IG1heSBoYXZlIGZhaWxlZC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQCFncm91cCBIVFRQIEV2ZW50cwogKgogKiBAIWV2ZW50IGh0dHBIZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3BvbnNlLCBzdGF0dXNNZXNzYWdlKQogKiAgIFRyaWdnZXJlZCB3aGVuIGhlYWRlcnMgYXJlIHNlbnQgYnkgdGhlIHJlbW90ZSBzZXJ2ZXIKICogICBAcGFyYW0gc3RhdHVzQ29kZSBbSW50ZWdlcl0gdGhlIEhUVFAgcmVzcG9uc2UgY29kZQogKiAgIEBwYXJhbSBoZWFkZXJzIFttYXA8U3RyaW5nLFN0cmluZz5dIHRoZSByZXNwb25zZSBoZWFkZXJzCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAcGFyYW0gc3RhdHVzTWVzc2FnZSBbU3RyaW5nXSBBIHN0YXR1cyBtZXNzYWdlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIEhUVFAKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZSBjb2RlCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAIWV2ZW50IGh0dHBEYXRhKGNodW5rLCByZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiBkYXRhIGlzIHNlbnQgYnkgdGhlIHJlbW90ZSBzZXJ2ZXIKICogICBAcGFyYW0gY2h1bmsgW0J1ZmZlcl0gdGhlIGJ1ZmZlciBkYXRhIGNvbnRhaW5pbmcgdGhlIG5leHQgZGF0YSBjaHVuawogKiAgICAgZnJvbSB0aGUgc2VydmVyCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEEKICoKICogQCFldmVudCBodHRwVXBsb2FkUHJvZ3Jlc3MocHJvZ3Jlc3MsIHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgaGFzIHVwbG9hZGVkIG1vcmUgZGF0YQogKiAgIEBwYXJhbSBwcm9ncmVzcyBbbWFwXSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYGxvYWRlZGAgYW5kIGB0b3RhbGAgYnl0ZXMKICogICAgIG9mIHRoZSByZXF1ZXN0LgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBub3RlIFRoaXMgZXZlbnQgd2lsbCBub3QgYmUgZW1pdHRlZCBpbiBOb2RlLmpzIDAuOC54LgogKgogKiBAIWV2ZW50IGh0dHBEb3dubG9hZFByb2dyZXNzKHByb2dyZXNzLCByZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGhhcyBkb3dubG9hZGVkIG1vcmUgZGF0YQogKiAgIEBwYXJhbSBwcm9ncmVzcyBbbWFwXSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYGxvYWRlZGAgYW5kIGB0b3RhbGAgYnl0ZXMKICogICAgIG9mIHRoZSByZXF1ZXN0LgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBub3RlIFRoaXMgZXZlbnQgd2lsbCBub3QgYmUgZW1pdHRlZCBpbiBOb2RlLmpzIDAuOC54LgogKgogKiBAIWV2ZW50IGh0dHBFcnJvcihlcnJvciwgcmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBmYWlsZWQKICogICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHRoYXQgd2FzIHRocm93bgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAIWV2ZW50IGh0dHBEb25lKHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBzZXJ2ZXIgaXMgZmluaXNoZWQgc2VuZGluZyBkYXRhCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEBzZWUgQVdTLlJlc3BvbnNlCiAqLwpBV1MuUmVxdWVzdCA9IGluaGVyaXQoewoKICAvKioKICAgKiBDcmVhdGVzIGEgcmVxdWVzdCBmb3IgYW4gb3BlcmF0aW9uIG9uIGEgZ2l2ZW4gc2VydmljZSB3aXRoCiAgICogYSBzZXQgb2YgaW5wdXQgcGFyYW1ldGVycy4KICAgKgogICAqIEBwYXJhbSBzZXJ2aWNlIFtBV1MuU2VydmljZV0gdGhlIHNlcnZpY2UgdG8gcGVyZm9ybSB0aGUgb3BlcmF0aW9uIG9uCiAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgb3BlcmF0aW9uIHRvIHBlcmZvcm0gb24gdGhlIHNlcnZpY2UKICAgKiBAcGFyYW0gcGFyYW1zIFtPYmplY3RdIHBhcmFtZXRlcnMgdG8gc2VuZCB0byB0aGUgb3BlcmF0aW9uLgogICAqICAgU2VlIHRoZSBvcGVyYXRpb24ncyBkb2N1bWVudGF0aW9uIGZvciB0aGUgZm9ybWF0IG9mIHRoZQogICAqICAgcGFyYW1ldGVycy4KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVxdWVzdChzZXJ2aWNlLCBvcGVyYXRpb24sIHBhcmFtcykgewogICAgdmFyIGVuZHBvaW50ID0gc2VydmljZS5lbmRwb2ludDsKICAgIHZhciByZWdpb24gPSBzZXJ2aWNlLmNvbmZpZy5yZWdpb247CiAgICB2YXIgY3VzdG9tVXNlckFnZW50ID0gc2VydmljZS5jb25maWcuY3VzdG9tVXNlckFnZW50OwoKICAgIGlmIChzZXJ2aWNlLnNpZ25pbmdSZWdpb24pIHsKICAgICAgcmVnaW9uID0gc2VydmljZS5zaWduaW5nUmVnaW9uOwogICAgfSBlbHNlIGlmIChzZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHsKICAgICAgcmVnaW9uID0gJ3VzLWVhc3QtMSc7CiAgICB9CgogICAgdGhpcy5kb21haW4gPSBkb21haW4gJiYgZG9tYWluLmFjdGl2ZTsKICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7CiAgICB0aGlzLm9wZXJhdGlvbiA9IG9wZXJhdGlvbjsKICAgIHRoaXMucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgdGhpcy5odHRwUmVxdWVzdCA9IG5ldyBBV1MuSHR0cFJlcXVlc3QoZW5kcG9pbnQsIHJlZ2lvbik7CiAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KGN1c3RvbVVzZXJBZ2VudCk7CiAgICB0aGlzLnN0YXJ0VGltZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKCiAgICB0aGlzLnJlc3BvbnNlID0gbmV3IEFXUy5SZXNwb25zZSh0aGlzKTsKICAgIHRoaXMuX2FzbSA9IG5ldyBBY2NlcHRvclN0YXRlTWFjaGluZShmc20uc3RhdGVzLCAndmFsaWRhdGUnKTsKICAgIHRoaXMuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSBmYWxzZTsKCiAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcyk7CiAgICB0aGlzLmVtaXQgPSB0aGlzLmVtaXRFdmVudDsKICB9LAoKICAvKioKICAgKiBAIWdyb3VwIFNlbmRpbmcgYSBSZXF1ZXN0CiAgICovCgogIC8qKgogICAqIEBvdmVybG9hZCBzZW5kKGNhbGxiYWNrID0gbnVsbCkKICAgKiAgIFNlbmRzIHRoZSByZXF1ZXN0IG9iamVjdC4KICAgKgogICAqICAgQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgKiAgICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAqICAgICBmcm9tIHRoZSBzZXJ2aWNlLgogICAqICAgICBAY29udGV4dCBbQVdTLlJlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBiZWluZyBzZW50LgogICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqICAgICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgKiAgICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICogICAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGggYSBjYWxsYmFjawogICAqICAgICByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICogICAgIHJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgY29uc29sZS5sb2coZXJyLCBkYXRhKTsgfSk7CiAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRoIG5vIGNhbGxiYWNrICh1c2luZyBldmVudCBoYW5kbGVycykKICAgKiAgICAgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAqICAgICByZXF1ZXN0Lm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7IC4uLiB9KTsgLy8gcmVnaXN0ZXIgYSBjYWxsYmFjawogICAqICAgICByZXF1ZXN0LnNlbmQoKTsKICAgKi8KICBzZW5kOiBmdW5jdGlvbiBzZW5kKGNhbGxiYWNrKSB7CiAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgnY2FsbGJhY2snKTsKICAgICAgdGhpcy5vbignY29tcGxldGUnLCBmdW5jdGlvbiAocmVzcCkgewogICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcCwgcmVzcC5lcnJvciwgcmVzcC5kYXRhKTsKICAgICAgfSk7CiAgICB9CiAgICB0aGlzLnJ1blRvKCk7CgogICAgcmV0dXJuIHRoaXMucmVzcG9uc2U7CiAgfSwKCiAgLyoqCiAgICogQCFtZXRob2QgIHByb21pc2UoKQogICAqICAgU2VuZHMgdGhlIHJlcXVlc3QgYW5kIHJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICoKICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKGRhdGEpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuCiAgICogICAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3QgdXNpbmcgcHJvbWlzZXMuCiAgICogICAgIHZhciByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICogICAgIHZhciByZXN1bHQgPSByZXF1ZXN0LnByb21pc2UoKTsKICAgKiAgICAgcmVzdWx0LnRoZW4oZnVuY3Rpb24oZGF0YSkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyb3IpIHsgLi4uIH0pOwogICAqLwoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBidWlsZDogZnVuY3Rpb24gYnVpbGQoY2FsbGJhY2spIHsKICAgIHJldHVybiB0aGlzLnJ1blRvKCdzZW5kJywgY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHJ1blRvOiBmdW5jdGlvbiBydW5UbyhzdGF0ZSwgZG9uZSkgewogICAgdGhpcy5fYXNtLnJ1blRvKHN0YXRlLCBkb25lLCB0aGlzKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEFib3J0cyBhIHJlcXVlc3QsIGVtaXR0aW5nIHRoZSBlcnJvciBhbmQgY29tcGxldGUgZXZlbnRzLgogICAqCiAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgKiBAZXhhbXBsZSBBYm9ydGluZyBhIHJlcXVlc3QgYWZ0ZXIgc2VuZGluZwogICAqICAgdmFyIHBhcmFtcyA9IHsKICAgKiAgICAgQnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5JywKICAgKiAgICAgQm9keTogQnVmZmVyLmFsbG9jKDEwMjQgKiAxMDI0ICogNSkgLy8gNU1CIHBheWxvYWQKICAgKiAgIH07CiAgICogICB2YXIgcmVxdWVzdCA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogICAqICAgcmVxdWVzdC5zZW5kKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgKiAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkVycm9yOiIsIGVyci5jb2RlLCBlcnIubWVzc2FnZSk7CiAgICogICAgIGVsc2UgY29uc29sZS5sb2coZGF0YSk7CiAgICogICB9KTsKICAgKgogICAqICAgLy8gYWJvcnQgcmVxdWVzdCBpbiAxIHNlY29uZAogICAqICAgc2V0VGltZW91dChyZXF1ZXN0LmFib3J0LmJpbmQocmVxdWVzdCksIDEwMDApOwogICAqCiAgICogICAvLyBwcmludHMgIkVycm9yOiBSZXF1ZXN0QWJvcnRlZEVycm9yIFJlcXVlc3QgYWJvcnRlZCBieSB1c2VyIgogICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XSB0aGUgc2FtZSByZXF1ZXN0IG9iamVjdCwgZm9yIGNoYWluaW5nLgogICAqIEBzaW5jZSB2MS40LjAKICAgKi8KICBhYm9ydDogZnVuY3Rpb24gYWJvcnQoKSB7CiAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygndmFsaWRhdGVSZXNwb25zZScpOwogICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4dHJhY3RFcnJvcicpOwogICAgdGhpcy5vbigndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIGFkZEFib3J0ZWRFcnJvcihyZXNwKSB7CiAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCBieSB1c2VyJyksIHsKICAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InLCByZXRyeWFibGU6IGZhbHNlCiAgICAgIH0pOwogICAgfSk7CgogICAgaWYgKHRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtICYmICF0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbS5kaWRDYWxsYmFjaykgeyAvLyBhYm9ydCBIVFRQIHN0cmVhbQogICAgICB0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbS5hYm9ydCgpOwogICAgICBpZiAodGhpcy5odHRwUmVxdWVzdC5fYWJvcnRDYWxsYmFjaykgewogICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0Ll9hYm9ydENhbGxiYWNrKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3NlbmQnKTsgLy8gaGF2ZW4ndCBzZW50IHlldCwgc28gbGV0J3Mgbm90CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBJdGVyYXRlcyBvdmVyIGVhY2ggcGFnZSBvZiByZXN1bHRzIGdpdmVuIGEgcGFnZWFibGUgcmVxdWVzdCwgY2FsbGluZwogICAqIHRoZSBwcm92aWRlZCBjYWxsYmFjayB3aXRoIGVhY2ggcGFnZSBvZiBkYXRhLiBBZnRlciBhbGwgcGFnZXMgaGF2ZSBiZWVuCiAgICogcmV0cmlldmVkLCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggYG51bGxgIGRhdGEuCiAgICoKICAgKiBAbm90ZSBUaGlzIG9wZXJhdGlvbiBjYW4gZ2VuZXJhdGUgbXVsdGlwbGUgcmVxdWVzdHMgdG8gYSBzZXJ2aWNlLgogICAqIEBleGFtcGxlIEl0ZXJhdGluZyBvdmVyIG11bHRpcGxlIHBhZ2VzIG9mIG9iamVjdHMgaW4gYW4gUzMgYnVja2V0CiAgICogICB2YXIgcGFnZXMgPSAxOwogICAqICAgczMubGlzdE9iamVjdHMoKS5lYWNoUGFnZShmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgKiAgICAgaWYgKGVycikgcmV0dXJuOwogICAqICAgICBjb25zb2xlLmxvZygiUGFnZSIsIHBhZ2VzKyspOwogICAqICAgICBjb25zb2xlLmxvZyhkYXRhKTsKICAgKiAgIH0pOwogICAqIEBleGFtcGxlIEl0ZXJhdGluZyBvdmVyIG11bHRpcGxlIHBhZ2VzIHdpdGggYW4gYXN5bmNocm9ub3VzIGNhbGxiYWNrCiAgICogICBzMy5saXN0T2JqZWN0cyhwYXJhbXMpLmVhY2hQYWdlKGZ1bmN0aW9uKGVyciwgZGF0YSwgZG9uZSkgewogICAqICAgICBkb1NvbWV0aGluZ0FzeW5jQW5kT3JFeHBlbnNpdmUoZnVuY3Rpb24oKSB7CiAgICogICAgICAgLy8gVGhlIG5leHQgcGFnZSBvZiByZXN1bHRzIGlzbid0IGZldGNoZWQgdW50aWwgZG9uZSBpcyBjYWxsZWQKICAgKiAgICAgICBkb25lKCk7CiAgICogICAgIH0pOwogICAqICAgfSk7CiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSwgW2RvbmVDYWxsYmFja10pCiAgICogICBDYWxsZWQgd2l0aCBlYWNoIHBhZ2Ugb2YgcmVzdWx0aW5nIGRhdGEgZnJvbSB0aGUgcmVxdWVzdC4gSWYgdGhlCiAgICogICBvcHRpb25hbCBgZG9uZUNhbGxiYWNrYCBpcyBwcm92aWRlZCBpbiB0aGUgZnVuY3Rpb24sIGl0IG11c3QgYmUgY2FsbGVkCiAgICogICB3aGVuIHRoZSBjYWxsYmFjayBpcyBjb21wbGV0ZS4KICAgKgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQuCiAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSBhIHNpbmdsZSBwYWdlIG9mIHJlc3BvbnNlIGRhdGEuIElmIHRoZXJlIGlzIG5vCiAgICogICAgIG1vcmUgZGF0YSwgdGhpcyBvYmplY3Qgd2lsbCBiZSBgbnVsbGAuCiAgICogICBAcGFyYW0gZG9uZUNhbGxiYWNrIFtGdW5jdGlvbl0gYW4gb3B0aW9uYWwgZG9uZSBjYWxsYmFjay4gSWYgdGhpcwogICAqICAgICBhcmd1bWVudCBpcyBkZWZpbmVkIGluIHRoZSBmdW5jdGlvbiBkZWNsYXJhdGlvbiwgaXQgc2hvdWxkIGJlIGNhbGxlZAogICAqICAgICB3aGVuIHRoZSBuZXh0IHBhZ2UgaXMgcmVhZHkgdG8gYmUgcmV0cmlldmVkLiBUaGlzIGlzIHVzZWZ1bCBmb3IKICAgKiAgICAgY29udHJvbGxpbmcgc2VyaWFsIHBhZ2luYXRpb24gYWNyb3NzIGFzeW5jaHJvbm91cyBvcGVyYXRpb25zLgogICAqICAgQHJldHVybiBbQm9vbGVhbl0gaWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYGZhbHNlYCwgcGFnaW5hdGlvbiB3aWxsCiAgICogICAgIHN0b3AuCiAgICoKICAgKiBAc2VlIEFXUy5SZXF1ZXN0LmVhY2hJdGVtCiAgICogQHNlZSBBV1MuUmVzcG9uc2UubmV4dFBhZ2UKICAgKiBAc2luY2UgdjEuNC4wCiAgICovCiAgZWFjaFBhZ2U6IGZ1bmN0aW9uIGVhY2hQYWdlKGNhbGxiYWNrKSB7CiAgICAvLyBNYWtlIGFsbCBjYWxsYmFja3MgYXN5bmMtaXNoCiAgICBjYWxsYmFjayA9IEFXUy51dGlsLmZuLm1ha2VBc3luYyhjYWxsYmFjaywgMyk7CgogICAgZnVuY3Rpb24gd3JhcHBlZENhbGxiYWNrKHJlc3BvbnNlKSB7CiAgICAgIGNhbGxiYWNrLmNhbGwocmVzcG9uc2UsIHJlc3BvbnNlLmVycm9yLCByZXNwb25zZS5kYXRhLCBmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHJldHVybjsKCiAgICAgICAgaWYgKHJlc3BvbnNlLmhhc05leHRQYWdlKCkpIHsKICAgICAgICAgIHJlc3BvbnNlLm5leHRQYWdlKCkub24oJ2NvbXBsZXRlJywgd3JhcHBlZENhbGxiYWNrKS5zZW5kKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcG9uc2UsIG51bGwsIG51bGwsIEFXUy51dGlsLmZuLm5vb3ApOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgdGhpcy5vbignY29tcGxldGUnLCB3cmFwcGVkQ2FsbGJhY2spLnNlbmQoKTsKICB9LAoKICAvKioKICAgKiBFbnVtZXJhdGVzIG92ZXIgaW5kaXZpZHVhbCBpdGVtcyBvZiBhIHJlcXVlc3QsIHBhZ2luZyB0aGUgcmVzcG9uc2VzIGlmCiAgICogbmVjZXNzYXJ5LgogICAqCiAgICogQGFwaSBleHBlcmltZW50YWwKICAgKiBAc2luY2UgdjEuNC4wCiAgICovCiAgZWFjaEl0ZW06IGZ1bmN0aW9uIGVhY2hJdGVtKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBmdW5jdGlvbiB3cmFwcGVkQ2FsbGJhY2soZXJyLCBkYXRhKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiBjYWxsYmFjayhlcnIsIG51bGwpOwogICAgICBpZiAoZGF0YSA9PT0gbnVsbCkgcmV0dXJuIGNhbGxiYWNrKG51bGwsIG51bGwpOwoKICAgICAgdmFyIGNvbmZpZyA9IHNlbGYuc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHNlbGYub3BlcmF0aW9uKTsKICAgICAgdmFyIHJlc3VsdEtleSA9IGNvbmZpZy5yZXN1bHRLZXk7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdEtleSkpIHJlc3VsdEtleSA9IHJlc3VsdEtleVswXTsKICAgICAgdmFyIGl0ZW1zID0gam1lc3BhdGguc2VhcmNoKGRhdGEsIHJlc3VsdEtleSk7CiAgICAgIHZhciBjb250aW51ZUl0ZXJhdGlvbiA9IHRydWU7CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaChpdGVtcywgZnVuY3Rpb24oaXRlbSkgewogICAgICAgIGNvbnRpbnVlSXRlcmF0aW9uID0gY2FsbGJhY2sobnVsbCwgaXRlbSk7CiAgICAgICAgaWYgKGNvbnRpbnVlSXRlcmF0aW9uID09PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuIEFXUy51dGlsLmFib3J0OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBjb250aW51ZUl0ZXJhdGlvbjsKICAgIH0KCiAgICB0aGlzLmVhY2hQYWdlKHdyYXBwZWRDYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgb3BlcmF0aW9uIGNhbiByZXR1cm4gbXVsdGlwbGUgcGFnZXMgb2YKICAgKiAgIHJlc3BvbnNlIGRhdGEuCiAgICogQHNlZSBBV1MuUmVzcG9uc2UuZWFjaFBhZ2UKICAgKiBAc2luY2UgdjEuNC4wCiAgICovCiAgaXNQYWdlYWJsZTogZnVuY3Rpb24gaXNQYWdlYWJsZSgpIHsKICAgIHJldHVybiB0aGlzLnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyh0aGlzLm9wZXJhdGlvbikgPyB0cnVlIDogZmFsc2U7CiAgfSwKCiAgLyoqCiAgICogU2VuZHMgdGhlIHJlcXVlc3QgYW5kIGNvbnZlcnRzIHRoZSByZXF1ZXN0IG9iamVjdCBpbnRvIGEgcmVhZGFibGUgc3RyZWFtCiAgICogdGhhdCBjYW4gYmUgcmVhZCBmcm9tIG9yIHBpcGVkIGludG8gYSB3cml0YWJsZSBzdHJlYW0uCiAgICoKICAgKiBAbm90ZSBUaGUgZGF0YSByZWFkIGZyb20gYSByZWFkYWJsZSBzdHJlYW0gY29udGFpbnMgb25seQogICAqICAgdGhlIHJhdyBIVFRQIGJvZHkgY29udGVudHMuCiAgICogQGV4YW1wbGUgTWFudWFsbHkgcmVhZGluZyBmcm9tIGEgc3RyZWFtCiAgICogICByZXF1ZXN0LmNyZWF0ZVJlYWRTdHJlYW0oKS5vbignZGF0YScsIGZ1bmN0aW9uKGRhdGEpIHsKICAgKiAgICAgY29uc29sZS5sb2coIkdvdCBkYXRhOiIsIGRhdGEudG9TdHJpbmcoKSk7CiAgICogICB9KTsKICAgKiBAZXhhbXBsZSBQaXBpbmcgYSByZXF1ZXN0IGJvZHkgaW50byBhIGZpbGUKICAgKiAgIHZhciBvdXQgPSBmcy5jcmVhdGVXcml0ZVN0cmVhbSgnL3BhdGgvdG8vb3V0ZmlsZS5qcGcnKTsKICAgKiAgIHMzLnNlcnZpY2UuZ2V0T2JqZWN0KHBhcmFtcykuY3JlYXRlUmVhZFN0cmVhbSgpLnBpcGUob3V0KTsKICAgKiBAcmV0dXJuIFtTdHJlYW1dIHRoZSByZWFkYWJsZSBzdHJlYW0gb2JqZWN0IHRoYXQgY2FuIGJlIHBpcGVkCiAgICogICBvciByZWFkIGZyb20gKGJ5IHJlZ2lzdGVyaW5nICdkYXRhJyBldmVudCBsaXN0ZW5lcnMpLgogICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICovCiAgY3JlYXRlUmVhZFN0cmVhbTogZnVuY3Rpb24gY3JlYXRlUmVhZFN0cmVhbSgpIHsKICAgIHZhciBzdHJlYW1zID0gQVdTLnV0aWwuc3RyZWFtOwogICAgdmFyIHJlcSA9IHRoaXM7CiAgICB2YXIgc3RyZWFtID0gbnVsbDsKCiAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgc3RyZWFtID0gbmV3IHN0cmVhbXMuUGFzc1Rocm91Z2goKTsKICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsgcmVxLnNlbmQoKTsgfSk7CiAgICB9IGVsc2UgewogICAgICBzdHJlYW0gPSBuZXcgc3RyZWFtcy5TdHJlYW0oKTsKICAgICAgc3RyZWFtLnJlYWRhYmxlID0gdHJ1ZTsKCiAgICAgIHN0cmVhbS5zZW50ID0gZmFsc2U7CiAgICAgIHN0cmVhbS5vbignbmV3TGlzdGVuZXInLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmICghc3RyZWFtLnNlbnQgJiYgZXZlbnQgPT09ICdkYXRhJykgewogICAgICAgICAgc3RyZWFtLnNlbnQgPSB0cnVlOwogICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsgcmVxLnNlbmQoKTsgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICB0aGlzLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgfSk7CgogICAgdGhpcy5vbignaHR0cEhlYWRlcnMnLCBmdW5jdGlvbiBzdHJlYW1IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3ApIHsKICAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgICByZXEucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBKTsKICAgICAgICByZXEucmVtb3ZlTGlzdGVuZXIoJ2h0dHBFcnJvcicsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfRVJST1IpOwogICAgICAgIHJlcS5vbignaHR0cEVycm9yJywgZnVuY3Rpb24gc3RyZWFtSHR0cEVycm9yKGVycm9yKSB7CiAgICAgICAgICByZXNwLmVycm9yID0gZXJyb3I7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IGZhbHNlOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgdmFyIGV4cGVjdGVkTGVuOwogICAgICAgIGlmIChyZXEuaHR0cFJlcXVlc3QubWV0aG9kICE9PSAnSEVBRCcpIHsKICAgICAgICAgIGV4cGVjdGVkTGVuID0gcGFyc2VJbnQoaGVhZGVyc1snY29udGVudC1sZW5ndGgnXSwgMTApOwogICAgICAgIH0KICAgICAgICBpZiAoZXhwZWN0ZWRMZW4gIT09IHVuZGVmaW5lZCAmJiAhaXNOYU4oZXhwZWN0ZWRMZW4pICYmIGV4cGVjdGVkTGVuID49IDApIHsKICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IHRydWU7CiAgICAgICAgICB2YXIgcmVjZWl2ZWRMZW4gPSAwOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQgPSBmdW5jdGlvbiBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KCkgewogICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCAmJiByZWNlaXZlZExlbiAhPT0gZXhwZWN0ZWRMZW4pIHsKICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgbmV3IEVycm9yKCdTdHJlYW0gY29udGVudCBsZW5ndGggbWlzbWF0Y2guIFJlY2VpdmVkICcgKwogICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKyAnIG9mICcgKyBleHBlY3RlZExlbiArICcgYnl0ZXMuJyksCiAgICAgICAgICAgICAgeyBjb2RlOiAnU3RyZWFtQ29udGVudExlbmd0aE1pc21hdGNoJyB9CiAgICAgICAgICAgICkpOwogICAgICAgICAgfSBlbHNlIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICBzdHJlYW0uZW5kKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdHJlYW0uZW1pdCgnZW5kJyk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGh0dHBTdHJlYW0gPSByZXNwLmh0dHBSZXNwb25zZS5jcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtKCk7CgogICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCkgewogICAgICAgICAgICB2YXIgbGVuZ3RoQWNjdW11bGF0b3IgPSBuZXcgc3RyZWFtcy5QYXNzVGhyb3VnaCgpOwogICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaykgewogICAgICAgICAgICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICs9IGNodW5rLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHN0cmVhbXMuUGFzc1Rocm91Z2gucHJvdG90eXBlLl93cml0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3Iub24oJ2VuZCcsIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQpOwogICAgICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICAgICAgaHR0cFN0cmVhbS51bnBpcGUobGVuZ3RoQWNjdW11bGF0b3IpOwogICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLmVtaXQoJ2VuZCcpOwogICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLmVuZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaHR0cFN0cmVhbS5waXBlKGxlbmd0aEFjY3VtdWxhdG9yKS5waXBlKHN0cmVhbSwgeyBlbmQ6IGZhbHNlIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHR0cFN0cmVhbS5waXBlKHN0cmVhbSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoKSB7CiAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgICBpZiAoYXJnICYmIGFyZy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICs9IGFyZy5sZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBodHRwU3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdkYXRhJywgYXJnKTsKICAgICAgICAgIH0pOwogICAgICAgICAgaHR0cFN0cmVhbS5vbignZW5kJywgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCk7CiAgICAgICAgfQoKICAgICAgICBodHRwU3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gc3RyZWFtOwogIH0sCgogIC8qKgogICAqIEBwYXJhbSBbQXJyYXksUmVzcG9uc2VdIGFyZ3MgVGhpcyBzaG91bGQgYmUgdGhlIHJlc3BvbnNlIG9iamVjdCwKICAgKiAgIG9yIGFuIGFycmF5IG9mIGFyZ3MgdG8gc2VuZCB0byB0aGUgZXZlbnQuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZW1pdEV2ZW50OiBmdW5jdGlvbiBlbWl0KGV2ZW50TmFtZSwgYXJncywgZG9uZSkgewogICAgaWYgKHR5cGVvZiBhcmdzID09PSAnZnVuY3Rpb24nKSB7IGRvbmUgPSBhcmdzOyBhcmdzID0gbnVsbDsgfQogICAgaWYgKCFkb25lKSBkb25lID0gZnVuY3Rpb24oKSB7IH07CiAgICBpZiAoIWFyZ3MpIGFyZ3MgPSB0aGlzLmV2ZW50UGFyYW1ldGVycyhldmVudE5hbWUsIHRoaXMucmVzcG9uc2UpOwoKICAgIHZhciBvcmlnRW1pdCA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmVtaXQ7CiAgICBvcmlnRW1pdC5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgYXJncywgZnVuY3Rpb24gKGVycikgewogICAgICBpZiAoZXJyKSB0aGlzLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICBkb25lLmNhbGwodGhpcywgZXJyKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGV2ZW50UGFyYW1ldGVyczogZnVuY3Rpb24gZXZlbnRQYXJhbWV0ZXJzKGV2ZW50TmFtZSkgewogICAgc3dpdGNoIChldmVudE5hbWUpIHsKICAgICAgY2FzZSAncmVzdGFydCc6CiAgICAgIGNhc2UgJ3ZhbGlkYXRlJzoKICAgICAgY2FzZSAnc2lnbic6CiAgICAgIGNhc2UgJ2J1aWxkJzoKICAgICAgY2FzZSAnYWZ0ZXJWYWxpZGF0ZSc6CiAgICAgIGNhc2UgJ2FmdGVyQnVpbGQnOgogICAgICAgIHJldHVybiBbdGhpc107CiAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICByZXR1cm4gW3RoaXMucmVzcG9uc2UuZXJyb3IsIHRoaXMucmVzcG9uc2VdOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBbdGhpcy5yZXNwb25zZV07CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgcHJlc2lnbjogZnVuY3Rpb24gcHJlc2lnbihleHBpcmVzLCBjYWxsYmFjaykgewogICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgZXhwaXJlcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IGV4cGlyZXM7CiAgICAgIGV4cGlyZXMgPSBudWxsOwogICAgfQogICAgcmV0dXJuIG5ldyBBV1MuU2lnbmVycy5QcmVzaWduKCkuc2lnbih0aGlzLnRvR2V0KCksIGV4cGlyZXMsIGNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpc1ByZXNpZ25lZDogZnVuY3Rpb24gaXNQcmVzaWduZWQoKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVycywgJ3ByZXNpZ25lZC1leHBpcmVzJyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdG9VbmF1dGhlbnRpY2F0ZWQ6IGZ1bmN0aW9uIHRvVW5hdXRoZW50aWNhdGVkKCkgewogICAgdGhpcy5fdW5BdXRoZW50aWNhdGVkID0gdHJ1ZTsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFMpOwogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignc2lnbicsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNJR04pOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdG9HZXQ6IGZ1bmN0aW9uIHRvR2V0KCkgewogICAgaWYgKHRoaXMuc2VydmljZS5hcGkucHJvdG9jb2wgPT09ICdxdWVyeScgfHwKICAgICAgICB0aGlzLnNlcnZpY2UuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdidWlsZCcsIHRoaXMuYnVpbGRBc0dldCk7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXIoJ2J1aWxkJywgdGhpcy5idWlsZEFzR2V0KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGJ1aWxkQXNHZXQ6IGZ1bmN0aW9uIGJ1aWxkQXNHZXQocmVxdWVzdCkgewogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5tZXRob2QgPSAnR0VUJzsKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QucGF0aCA9IHJlcXVlc3Quc2VydmljZS5lbmRwb2ludC5wYXRoICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc/JyArIHJlcXVlc3QuaHR0cFJlcXVlc3QuYm9keTsKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuYm9keSA9ICcnOwoKICAgIC8vIGRvbid0IG5lZWQgdGhlc2UgaGVhZGVycyBvbiBhIEdFVCByZXF1ZXN0CiAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddOwogICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaGFsdEhhbmRsZXJzT25FcnJvcjogZnVuY3Rpb24gaGFsdEhhbmRsZXJzT25FcnJvcigpIHsKICAgIHRoaXMuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSB0cnVlOwogIH0KfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuUmVxdWVzdC5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICB0aGlzLnByb3RvdHlwZS5wcm9taXNlID0gZnVuY3Rpb24gcHJvbWlzZSgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIC8vIGFwcGVuZCB0byB1c2VyIGFnZW50CiAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdwcm9taXNlJyk7CiAgICByZXR1cm4gbmV3IFByb21pc2VEZXBlbmRlbmN5KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgcmVqZWN0KHJlc3AuZXJyb3IpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBkZWZpbmUgJHJlc3BvbnNlIHByb3BlcnR5IHNvIHRoYXQgaXQgaXMgbm90IGVudW1lcmFibGUKICAgICAgICAgIC8vIHRoaXMgcHJldmVudHMgY2lyY3VsYXIgcmVmZXJlbmNlIGVycm9ycyB3aGVuIHN0cmluZ2lmeWluZyB0aGUgSlNPTiBvYmplY3QKICAgICAgICAgIHJlc29sdmUoT2JqZWN0LmRlZmluZVByb3BlcnR5KAogICAgICAgICAgICByZXNwLmRhdGEgfHwge30sCiAgICAgICAgICAgICckcmVzcG9uc2UnLAogICAgICAgICAgICB7dmFsdWU6IHJlc3B9CiAgICAgICAgICApKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBzZWxmLnJ1blRvKCk7CiAgICB9KTsKICB9Owp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlJlcXVlc3QuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICBkZWxldGUgdGhpcy5wcm90b3R5cGUucHJvbWlzZTsKfTsKCkFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5SZXF1ZXN0KTsKCkFXUy51dGlsLm1peGluKEFXUy5SZXF1ZXN0LCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vY29yZSI6MTksIi4vc3RhdGVfbWFjaGluZSI6NzEsIl9wcm9jZXNzIjo4OSwiam1lc3BhdGgiOjg4fV0sNTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogQ29weXJpZ2h0IDIwMTItMjAxMyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKS4gWW91CiAqIG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YKICogdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdAogKgogKiAgICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FwYWNoZTIuMC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcwogKiBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRgogKiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMKICogbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIENIRUNLX0FDQ0VQVE9SUyhyZXNwKSB7CiAgdmFyIHdhaXRlciA9IHJlc3AucmVxdWVzdC5fd2FpdGVyOwogIHZhciBhY2NlcHRvcnMgPSB3YWl0ZXIuY29uZmlnLmFjY2VwdG9yczsKICB2YXIgYWNjZXB0b3JNYXRjaGVkID0gZmFsc2U7CiAgdmFyIHN0YXRlID0gJ3JldHJ5JzsKCiAgYWNjZXB0b3JzLmZvckVhY2goZnVuY3Rpb24oYWNjZXB0b3IpIHsKICAgIGlmICghYWNjZXB0b3JNYXRjaGVkKSB7CiAgICAgIHZhciBtYXRjaGVyID0gd2FpdGVyLm1hdGNoZXJzW2FjY2VwdG9yLm1hdGNoZXJdOwogICAgICBpZiAobWF0Y2hlciAmJiBtYXRjaGVyKHJlc3AsIGFjY2VwdG9yLmV4cGVjdGVkLCBhY2NlcHRvci5hcmd1bWVudCkpIHsKICAgICAgICBhY2NlcHRvck1hdGNoZWQgPSB0cnVlOwogICAgICAgIHN0YXRlID0gYWNjZXB0b3Iuc3RhdGU7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgaWYgKCFhY2NlcHRvck1hdGNoZWQgJiYgcmVzcC5lcnJvcikgc3RhdGUgPSAnZmFpbHVyZSc7CgogIGlmIChzdGF0ZSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICB3YWl0ZXIuc2V0U3VjY2VzcyhyZXNwKTsKICB9IGVsc2UgewogICAgd2FpdGVyLnNldEVycm9yKHJlc3AsIHN0YXRlID09PSAncmV0cnknKTsKICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5SZXNvdXJjZVdhaXRlciA9IGluaGVyaXQoewogIC8qKgogICAqIFdhaXRzIGZvciBhIGdpdmVuIHN0YXRlIG9uIGEgc2VydmljZSBvYmplY3QKICAgKiBAcGFyYW0gc2VydmljZSBbU2VydmljZV0gdGhlIHNlcnZpY2Ugb2JqZWN0IHRvIHdhaXQgb24KICAgKiBAcGFyYW0gc3RhdGUgW1N0cmluZ10gdGhlIHN0YXRlIChkZWZpbmVkIGluIHdhaXRlciBjb25maWd1cmF0aW9uKSB0byB3YWl0CiAgICogICBmb3IuCiAgICogQGV4YW1wbGUgQ3JlYXRlIGEgd2FpdGVyIGZvciBydW5uaW5nIEVDMiBpbnN0YW5jZXMKICAgKiAgIHZhciBlYzIgPSBuZXcgQVdTLkVDMjsKICAgKiAgIHZhciB3YWl0ZXIgPSBuZXcgQVdTLlJlc291cmNlV2FpdGVyKGVjMiwgJ2luc3RhbmNlUnVubmluZycpOwogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBjb25zdHJ1Y3RvcihzZXJ2aWNlLCBzdGF0ZSkgewogICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICAgIHRoaXMubG9hZFdhaXRlckNvbmZpZyh0aGlzLnN0YXRlKTsKICB9LAoKICBzZXJ2aWNlOiBudWxsLAoKICBzdGF0ZTogbnVsbCwKCiAgY29uZmlnOiBudWxsLAoKICBtYXRjaGVyczogewogICAgcGF0aDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gam1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdCxleHBlY3RlZCk7CiAgICB9LAoKICAgIHBhdGhBbGw6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICB0cnkgewogICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHRzKSkgcmVzdWx0cyA9IFtyZXN1bHRzXTsKICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgaWYgKCFudW1SZXN1bHRzKSByZXR1cm4gZmFsc2U7CiAgICAgIGZvciAodmFyIGluZCA9IDAgOyBpbmQgPCBudW1SZXN1bHRzOyBpbmQrKykgewogICAgICAgIGlmICgham1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICBwYXRoQW55OiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcmVzdWx0cyA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgIHZhciBudW1SZXN1bHRzID0gcmVzdWx0cy5sZW5ndGg7CiAgICAgIGZvciAodmFyIGluZCA9IDAgOyBpbmQgPCBudW1SZXN1bHRzOyBpbmQrKykgewogICAgICAgIGlmIChqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIHN0YXR1czogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQpIHsKICAgICAgdmFyIHN0YXR1c0NvZGUgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICByZXR1cm4gKHR5cGVvZiBzdGF0dXNDb2RlID09PSAnbnVtYmVyJykgJiYgKHN0YXR1c0NvZGUgPT09IGV4cGVjdGVkKTsKICAgIH0sCgogICAgZXJyb3I6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkKSB7CiAgICAgIGlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdzdHJpbmcnICYmIHJlc3AuZXJyb3IpIHsKICAgICAgICByZXR1cm4gZXhwZWN0ZWQgPT09IHJlc3AuZXJyb3IuY29kZTsKICAgICAgfQogICAgICAvLyBpZiBleHBlY3RlZCBpcyBub3Qgc3RyaW5nLCBjYW4gYmUgYm9vbGVhbiBpbmRpY2F0aW5nIHByZXNlbmNlIG9mIGVycm9yCiAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gISFyZXNwLmVycm9yOwogICAgfQogIH0sCgogIGxpc3RlbmVyczogbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIGFkZCgnUkVUUllfQ0hFQ0snLCAncmV0cnknLCBmdW5jdGlvbihyZXNwKSB7CiAgICAgIHZhciB3YWl0ZXIgPSByZXNwLnJlcXVlc3QuX3dhaXRlcjsKICAgICAgaWYgKHJlc3AuZXJyb3IgJiYgcmVzcC5lcnJvci5jb2RlID09PSAnUmVzb3VyY2VOb3RSZWFkeScpIHsKICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSAod2FpdGVyLmNvbmZpZy5kZWxheSB8fCAwKSAqIDEwMDA7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnQ0hFQ0tfT1VUUFVUJywgJ2V4dHJhY3REYXRhJywgQ0hFQ0tfQUNDRVBUT1JTKTsKCiAgICBhZGQoJ0NIRUNLX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIENIRUNLX0FDQ0VQVE9SUyk7CiAgfSksCgogIC8qKgogICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XQogICAqLwogIHdhaXQ6IGZ1bmN0aW9uIHdhaXQocGFyYW1zLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7IHBhcmFtcyA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICBpZiAocGFyYW1zICYmIHBhcmFtcy4kd2FpdGVyKSB7CiAgICAgIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocGFyYW1zKTsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXMuJHdhaXRlci5kZWxheSA9PT0gJ251bWJlcicpIHsKICAgICAgICB0aGlzLmNvbmZpZy5kZWxheSA9IHBhcmFtcy4kd2FpdGVyLmRlbGF5OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zLiR3YWl0ZXIubWF4QXR0ZW1wdHMgPT09ICdudW1iZXInKSB7CiAgICAgICAgdGhpcy5jb25maWcubWF4QXR0ZW1wdHMgPSBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0czsKICAgICAgfQogICAgICBkZWxldGUgcGFyYW1zLiR3YWl0ZXI7CiAgICB9CgogICAgdmFyIHJlcXVlc3QgPSB0aGlzLnNlcnZpY2UubWFrZVJlcXVlc3QodGhpcy5jb25maWcub3BlcmF0aW9uLCBwYXJhbXMpOwogICAgcmVxdWVzdC5fd2FpdGVyID0gdGhpczsKICAgIHJlcXVlc3QucmVzcG9uc2UubWF4UmV0cmllcyA9IHRoaXMuY29uZmlnLm1heEF0dGVtcHRzOwogICAgcmVxdWVzdC5hZGRMaXN0ZW5lcnModGhpcy5saXN0ZW5lcnMpOwoKICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdC5zZW5kKGNhbGxiYWNrKTsKICAgIHJldHVybiByZXF1ZXN0OwogIH0sCgogIHNldFN1Y2Nlc3M6IGZ1bmN0aW9uIHNldFN1Y2Nlc3MocmVzcCkgewogICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICByZXNwLmRhdGEgPSByZXNwLmRhdGEgfHwge307CiAgICByZXNwLnJlcXVlc3QucmVtb3ZlQWxsTGlzdGVuZXJzKCdleHRyYWN0RGF0YScpOwogIH0sCgogIHNldEVycm9yOiBmdW5jdGlvbiBzZXRFcnJvcihyZXNwLCByZXRyeWFibGUpIHsKICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IocmVzcC5lcnJvciB8fCBuZXcgRXJyb3IoKSwgewogICAgICBjb2RlOiAnUmVzb3VyY2VOb3RSZWFkeScsCiAgICAgIG1lc3NhZ2U6ICdSZXNvdXJjZSBpcyBub3QgaW4gdGhlIHN0YXRlICcgKyB0aGlzLnN0YXRlLAogICAgICByZXRyeWFibGU6IHJldHJ5YWJsZQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogTG9hZHMgd2FpdGVyIGNvbmZpZ3VyYXRpb24gZnJvbSBBUEkgY29uZmlndXJhdGlvbgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZFdhaXRlckNvbmZpZzogZnVuY3Rpb24gbG9hZFdhaXRlckNvbmZpZyhzdGF0ZSkgewogICAgaWYgKCF0aGlzLnNlcnZpY2UuYXBpLndhaXRlcnNbc3RhdGVdKSB7CiAgICAgIHRocm93IG5ldyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdTdGF0ZU5vdEZvdW5kRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdTdGF0ZSAnICsgc3RhdGUgKyAnIG5vdCBmb3VuZC4nCiAgICAgIH0pOwogICAgfQoKICAgIHRoaXMuY29uZmlnID0gQVdTLnV0aWwuY29weSh0aGlzLnNlcnZpY2UuYXBpLndhaXRlcnNbc3RhdGVdKTsKICB9Cn0pOwoKfSx7Ii4vY29yZSI6MTksImptZXNwYXRoIjo4OH1dLDU5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CnZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CgovKioKICogVGhpcyBjbGFzcyBlbmNhcHN1bGF0ZXMgdGhlIHJlc3BvbnNlIGluZm9ybWF0aW9uCiAqIGZyb20gYSBzZXJ2aWNlIHJlcXVlc3Qgb3BlcmF0aW9uIHNlbnQgdGhyb3VnaCB7QVdTLlJlcXVlc3R9LgogKiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0d28gbWFpbiBwcm9wZXJ0aWVzIGZvciBnZXR0aW5nIGluZm9ybWF0aW9uCiAqIGJhY2sgZnJvbSBhIHJlcXVlc3Q6CiAqCiAqICMjIFRoZSBgZGF0YWAgcHJvcGVydHkKICoKICogVGhlIGByZXNwb25zZS5kYXRhYCBwcm9wZXJ0eSBjb250YWlucyB0aGUgc2VyaWFsaXplZCBvYmplY3QgZGF0YQogKiByZXRyaWV2ZWQgZnJvbSB0aGUgc2VydmljZSByZXF1ZXN0LiBGb3IgaW5zdGFuY2UsIGZvciBhbgogKiBBbWF6b24gRHluYW1vREIgYGxpc3RUYWJsZXNgIG1ldGhvZCBjYWxsLCB0aGUgcmVzcG9uc2UgZGF0YSBtaWdodAogKiBsb29rIGxpa2U6CiAqCiAqIGBgYAogKiA+IHJlc3AuZGF0YQogKiB7IFRhYmxlTmFtZXM6CiAqICAgIFsgJ3RhYmxlMScsICd0YWJsZTInLCAuLi4gXSB9CiAqIGBgYAogKgogKiBUaGUgYGRhdGFgIHByb3BlcnR5IGNhbiBiZSBudWxsIGlmIGFuIGVycm9yIG9jY3VycyAoc2VlIGJlbG93KS4KICoKICogIyMgVGhlIGBlcnJvcmAgcHJvcGVydHkKICoKICogSW4gdGhlIGV2ZW50IG9mIGEgc2VydmljZSBlcnJvciAob3IgdHJhbnNmZXIgZXJyb3IpLCB0aGUKICogYHJlc3BvbnNlLmVycm9yYCBwcm9wZXJ0eSB3aWxsIGJlIGZpbGxlZCB3aXRoIHRoZSBnaXZlbgogKiBlcnJvciBkYXRhIGluIHRoZSBmb3JtOgogKgogKiBgYGAKICogeyBjb2RlOiAnU0hPUlRfVU5JUVVFX0VSUk9SX0NPREUnLAogKiAgIG1lc3NhZ2U6ICdTb21lIGh1bWFuIHJlYWRhYmxlIGVycm9yIG1lc3NhZ2UnIH0KICogYGBgCiAqCiAqIEluIHRoZSBjYXNlIG9mIGFuIGVycm9yLCB0aGUgYGRhdGFgIHByb3BlcnR5IHdpbGwgYmUgYG51bGxgLgogKiBOb3RlIHRoYXQgaWYgeW91IGhhbmRsZSBldmVudHMgdGhhdCBjYW4gYmUgaW4gYSBmYWlsdXJlIHN0YXRlLAogKiB5b3Ugc2hvdWxkIGFsd2F5cyBjaGVjayB3aGV0aGVyIGByZXNwb25zZS5lcnJvcmAgaXMgc2V0CiAqIGJlZm9yZSBhdHRlbXB0aW5nIHRvIGFjY2VzcyB0aGUgYHJlc3BvbnNlLmRhdGFgIHByb3BlcnR5LgogKgogKiBAIWF0dHJpYnV0ZSBkYXRhCiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICogICBAbm90ZSBJbnNpZGUgb2YgYSB7QVdTLlJlcXVlc3R+aHR0cERhdGF9IGV2ZW50LCB0aGlzCiAqICAgICBwcm9wZXJ0eSBjb250YWlucyBhIHNpbmdsZSByYXcgcGFja2V0IGluc3RlYWQgb2YgdGhlCiAqICAgICBmdWxsIGRlLXNlcmlhbGl6ZWQgc2VydmljZSByZXNwb25zZS4KICogICBAcmV0dXJuIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIHJlc3BvbnNlIGRhdGEKICogICAgIGZyb20gdGhlIHNlcnZpY2UuCiAqCiAqIEAhYXR0cmlidXRlIGVycm9yCiAqICAgQW4gc3RydWN0dXJlIGNvbnRhaW5pbmcgaW5mb3JtYXRpb24gYWJvdXQgYSBzZXJ2aWNlCiAqICAgb3IgbmV0d29ya2luZyBlcnJvci4KICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogKiAgIEBub3RlIFRoaXMgYXR0cmlidXRlIGlzIG9ubHkgZmlsbGVkIGlmIGEgc2VydmljZSBvcgogKiAgICAgbmV0d29ya2luZyBlcnJvciBvY2N1cnMuCiAqICAgQHJldHVybiBbRXJyb3JdCiAqICAgICAqIGNvZGUgW1N0cmluZ10gYSB1bmlxdWUgc2hvcnQgY29kZSByZXByZXNlbnRpbmcgdGhlCiAqICAgICAgIGVycm9yIHRoYXQgd2FzIGVtaXR0ZWQuCiAqICAgICAqIG1lc3NhZ2UgW1N0cmluZ10gYSBsb25nZXIgaHVtYW4gcmVhZGFibGUgZXJyb3IgbWVzc2FnZQogKiAgICAgKiByZXRyeWFibGUgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGVycm9yIG1lc3NhZ2UgaXMKICogICAgICAgcmV0cnlhYmxlLgogKiAgICAgKiBzdGF0dXNDb2RlIFtOdW1lcmljXSBpbiB0aGUgY2FzZSBvZiBhIHJlcXVlc3QgdGhhdCByZWFjaGVkIHRoZSBzZXJ2aWNlLAogKiAgICAgICB0aGlzIHZhbHVlIGNvbnRhaW5zIHRoZSByZXNwb25zZSBzdGF0dXMgY29kZS4KICogICAgICogdGltZSBbRGF0ZV0gdGhlIGRhdGUgdGltZSBvYmplY3Qgd2hlbiB0aGUgZXJyb3Igb2NjdXJyZWQuCiAqICAgICAqIGhvc3RuYW1lIFtTdHJpbmddIHNldCB3aGVuIGEgbmV0d29ya2luZyBlcnJvciBvY2N1cnMgdG8gZWFzaWx5CiAqICAgICAgIGlkZW50aWZ5IHRoZSBlbmRwb2ludCBvZiB0aGUgcmVxdWVzdC4KICogICAgICogcmVnaW9uIFtTdHJpbmddIHNldCB3aGVuIGEgbmV0d29ya2luZyBlcnJvciBvY2N1cnMgdG8gZWFzaWx5CiAqICAgICAgIGlkZW50aWZ5IHRoZSByZWdpb24gb2YgdGhlIHJlcXVlc3QuCiAqCiAqIEAhYXR0cmlidXRlIHJlcXVlc3RJZAogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgdW5pcXVlIHJlcXVlc3QgSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSByZXNwb25zZS4KICogICAgIExvZyB0aGlzIHZhbHVlIHdoZW4gZGVidWdnaW5nIHJlcXVlc3RzIGZvciBBV1Mgc3VwcG9ydC4KICoKICogQCFhdHRyaWJ1dGUgcmV0cnlDb3VudAogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJldHJpZXMgdGhhdCB3ZXJlCiAqICAgICBhdHRlbXB0ZWQgYmVmb3JlIHRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQuCiAqCiAqIEAhYXR0cmlidXRlIHJlZGlyZWN0Q291bnQKICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiByZWRpcmVjdHMgdGhhdCB3ZXJlCiAqICAgICBmb2xsb3dlZCBiZWZvcmUgdGhlIHJlcXVlc3Qgd2FzIGNvbXBsZXRlZC4KICoKICogQCFhdHRyaWJ1dGUgaHR0cFJlc3BvbnNlCiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICogICBAcmV0dXJuIFtBV1MuSHR0cFJlc3BvbnNlXSB0aGUgcmF3IEhUVFAgcmVzcG9uc2Ugb2JqZWN0CiAqICAgICBjb250YWluaW5nIHRoZSByZXNwb25zZSBoZWFkZXJzIGFuZCBib2R5IGluZm9ybWF0aW9uCiAqICAgICBmcm9tIHRoZSBzZXJ2ZXIuCiAqCiAqIEBzZWUgQVdTLlJlcXVlc3QKICovCkFXUy5SZXNwb25zZSA9IGluaGVyaXQoewoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVzcG9uc2UocmVxdWVzdCkgewogICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICB0aGlzLmVycm9yID0gbnVsbDsKICAgIHRoaXMucmV0cnlDb3VudCA9IDA7CiAgICB0aGlzLnJlZGlyZWN0Q291bnQgPSAwOwogICAgdGhpcy5odHRwUmVzcG9uc2UgPSBuZXcgQVdTLkh0dHBSZXNwb25zZSgpOwogICAgaWYgKHJlcXVlc3QpIHsKICAgICAgdGhpcy5tYXhSZXRyaWVzID0gcmVxdWVzdC5zZXJ2aWNlLm51bVJldHJpZXMoKTsKICAgICAgdGhpcy5tYXhSZWRpcmVjdHMgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLm1heFJlZGlyZWN0czsKICAgIH0KICB9LAoKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHJlcXVlc3QgZm9yIHRoZSBuZXh0IHBhZ2Ugb2YgcmVzcG9uc2UgZGF0YSwgY2FsbGluZyB0aGUKICAgKiBjYWxsYmFjayB3aXRoIHRoZSBwYWdlIGRhdGEgaWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZC4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICogICBDYWxsZWQgd2hlbiBhIHBhZ2Ugb2YgZGF0YSBpcyByZXR1cm5lZCBmcm9tIHRoZSBuZXh0IHJlcXVlc3QuCiAgICoKICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBhbiBlcnJvciBvYmplY3QsIGlmIGFuIGVycm9yIG9jY3VycmVkIGluIHRoZSByZXF1ZXN0CiAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgbmV4dCBwYWdlIG9mIGRhdGEsIG9yIG51bGwsIGlmIHRoZXJlIGFyZSBubwogICAqICAgICBtb3JlIHBhZ2VzIGxlZnQuCiAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBmb3IgdGhlIG5leHQgcGFnZSBvZiBkYXRhCiAgICogQHJldHVybiBbbnVsbF0gaWYgbm8gY2FsbGJhY2sgaXMgcHJvdmlkZWQgYW5kIHRoZXJlIGFyZSBubyBwYWdlcyBsZWZ0CiAgICogICB0byByZXRyaWV2ZS4KICAgKiBAc2luY2UgdjEuNC4wCiAgICovCiAgbmV4dFBhZ2U6IGZ1bmN0aW9uIG5leHRQYWdlKGNhbGxiYWNrKSB7CiAgICB2YXIgY29uZmlnOwogICAgdmFyIHNlcnZpY2UgPSB0aGlzLnJlcXVlc3Quc2VydmljZTsKICAgIHZhciBvcGVyYXRpb24gPSB0aGlzLnJlcXVlc3Qub3BlcmF0aW9uOwogICAgdHJ5IHsKICAgICAgY29uZmlnID0gc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdHJ1ZSk7CiAgICB9IGNhdGNoIChlKSB7IHRoaXMuZXJyb3IgPSBlOyB9CgogICAgaWYgKCF0aGlzLmhhc05leHRQYWdlKCkpIHsKICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayh0aGlzLmVycm9yLCBudWxsKTsKICAgICAgZWxzZSBpZiAodGhpcy5lcnJvcikgdGhyb3cgdGhpcy5lcnJvcjsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkodGhpcy5yZXF1ZXN0LnBhcmFtcyk7CiAgICBpZiAoIXRoaXMubmV4dFBhZ2VUb2tlbnMpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrID8gY2FsbGJhY2sobnVsbCwgbnVsbCkgOiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGlucHV0VG9rZW5zID0gY29uZmlnLmlucHV0VG9rZW47CiAgICAgIGlmICh0eXBlb2YgaW5wdXRUb2tlbnMgPT09ICdzdHJpbmcnKSBpbnB1dFRva2VucyA9IFtpbnB1dFRva2Vuc107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXRUb2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwYXJhbXNbaW5wdXRUb2tlbnNbaV1dID0gdGhpcy5uZXh0UGFnZVRva2Vuc1tpXTsKICAgICAgfQogICAgICByZXR1cm4gc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLnJlcXVlc3Qub3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIG1vcmUgcGFnZXMgb2YgZGF0YSBjYW4gYmUgcmV0dXJuZWQgYnkgZnVydGhlcgogICAqICAgcmVxdWVzdHMKICAgKiBAc2luY2UgdjEuNC4wCiAgICovCiAgaGFzTmV4dFBhZ2U6IGZ1bmN0aW9uIGhhc05leHRQYWdlKCkgewogICAgdGhpcy5jYWNoZU5leHRQYWdlVG9rZW5zKCk7CiAgICBpZiAodGhpcy5uZXh0UGFnZVRva2VucykgcmV0dXJuIHRydWU7CiAgICBpZiAodGhpcy5uZXh0UGFnZVRva2VucyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgZWxzZSByZXR1cm4gZmFsc2U7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY2FjaGVOZXh0UGFnZVRva2VuczogZnVuY3Rpb24gY2FjaGVOZXh0UGFnZVRva2VucygpIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcywgJ25leHRQYWdlVG9rZW5zJykpIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHVuZGVmaW5lZDsKCiAgICB2YXIgY29uZmlnID0gdGhpcy5yZXF1ZXN0LnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyh0aGlzLnJlcXVlc3Qub3BlcmF0aW9uKTsKICAgIGlmICghY29uZmlnKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKCiAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gbnVsbDsKICAgIGlmIChjb25maWcubW9yZVJlc3VsdHMpIHsKICAgICAgaWYgKCFqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBjb25maWcubW9yZVJlc3VsdHMpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgZXhwcnMgPSBjb25maWcub3V0cHV0VG9rZW47CiAgICBpZiAodHlwZW9mIGV4cHJzID09PSAnc3RyaW5nJykgZXhwcnMgPSBbZXhwcnNdOwogICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgZXhwcnMsIGZ1bmN0aW9uIChleHByKSB7CiAgICAgIHZhciBvdXRwdXQgPSBqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBleHByKTsKICAgICAgaWYgKG91dHB1dCkgewogICAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSB0aGlzLm5leHRQYWdlVG9rZW5zIHx8IFtdOwogICAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMucHVzaChvdXRwdXQpOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICB9Cgp9KTsKCn0seyIuL2NvcmUiOjE5LCJqbWVzcGF0aCI6ODh9XSw2MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICogQCFtZXRob2Qgb24oZXZlbnROYW1lLCBjYWxsYmFjaykKICogICBSZWdpc3RlcnMgYW4gZXZlbnQgbGlzdGVuZXIgY2FsbGJhY2sgZm9yIHRoZSBldmVudCBnaXZlbiBieSBgZXZlbnROYW1lYC4KICogICBQYXJhbWV0ZXJzIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gZGVwZW5kIG9uIHRoZSBpbmRpdmlkdWFsIGV2ZW50CiAqICAgYmVpbmcgdHJpZ2dlcmVkLiBTZWUgdGhlIGV2ZW50IGRvY3VtZW50YXRpb24gZm9yIHRob3NlIHBhcmFtZXRlcnMuCiAqCiAqICAgQHBhcmFtIGV2ZW50TmFtZSBbU3RyaW5nXSB0aGUgZXZlbnQgbmFtZSB0byByZWdpc3RlciB0aGUgbGlzdGVuZXIgZm9yCiAqICAgQHBhcmFtIGNhbGxiYWNrIFtGdW5jdGlvbl0gdGhlIGxpc3RlbmVyIGNhbGxiYWNrIGZ1bmN0aW9uCiAqICAgQHBhcmFtIHRvSGVhZCBbQm9vbGVhbl0gYXR0YWNoIHRoZSBsaXN0ZW5lciBjYWxsYmFjayB0byB0aGUgaGVhZCBvZiBjYWxsYmFjayBhcnJheSBpZiBzZXQgdG8gdHJ1ZS4KICogICAgIERlZmF1bHQgdG8gYmUgZmFsc2UuCiAqICAgQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gdGhlIHNhbWUgb2JqZWN0IGZvciBjaGFpbmluZwogKi8KQVdTLlNlcXVlbnRpYWxFeGVjdXRvciA9IEFXUy51dGlsLmluaGVyaXQoewoKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VxdWVudGlhbEV4ZWN1dG9yKCkgewogICAgdGhpcy5fZXZlbnRzID0ge307CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbGlzdGVuZXJzOiBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0gPyB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS5zbGljZSgwKSA6IFtdOwogIH0sCgogIG9uOiBmdW5jdGlvbiBvbihldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpIHsKICAgIGlmICh0aGlzLl9ldmVudHNbZXZlbnROYW1lXSkgewogICAgICB0b0hlYWQgPwogICAgICAgIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnVuc2hpZnQobGlzdGVuZXIpIDoKICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdID0gW2xpc3RlbmVyXTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIG9uQXN5bmM6IGZ1bmN0aW9uIG9uQXN5bmMoZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICBsaXN0ZW5lci5faXNBc3luYyA9IHRydWU7CiAgICByZXR1cm4gdGhpcy5vbihldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpOwogIH0sCgogIHJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICBpZiAobGlzdGVuZXJzKSB7CiAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICB2YXIgcG9zaXRpb24gPSAtMTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgIGlmIChsaXN0ZW5lcnNbaV0gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChwb3NpdGlvbiA+IC0xKSB7CiAgICAgICAgbGlzdGVuZXJzLnNwbGljZShwb3NpdGlvbiwgMSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIHJlbW92ZUFsbExpc3RlbmVyczogZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50TmFtZSkgewogICAgaWYgKGV2ZW50TmFtZSkgewogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGVtaXQ6IGZ1bmN0aW9uIGVtaXQoZXZlbnROYW1lLCBldmVudEFyZ3MsIGRvbmVDYWxsYmFjaykgewogICAgaWYgKCFkb25lQ2FsbGJhY2spIGRvbmVDYWxsYmFjayA9IGZ1bmN0aW9uKCkgeyB9OwogICAgdmFyIGxpc3RlbmVycyA9IHRoaXMubGlzdGVuZXJzKGV2ZW50TmFtZSk7CiAgICB2YXIgY291bnQgPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgdGhpcy5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spOwogICAgcmV0dXJuIGNvdW50ID4gMDsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjYWxsTGlzdGVuZXJzOiBmdW5jdGlvbiBjYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBwcmV2RXJyb3IpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBlcnJvciA9IHByZXZFcnJvciB8fCBudWxsOwoKICAgIGZ1bmN0aW9uIGNhbGxOZXh0TGlzdGVuZXIoZXJyKSB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBlcnJvciA9IEFXUy51dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCBlcnIpOwogICAgICAgIGlmIChzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yKSB7CiAgICAgICAgICByZXR1cm4gZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgICAgIH0KICAgICAgfQogICAgICBzZWxmLmNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIGVycm9yKTsKICAgIH0KCiAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgdmFyIGxpc3RlbmVyID0gbGlzdGVuZXJzLnNoaWZ0KCk7CiAgICAgIGlmIChsaXN0ZW5lci5faXNBc3luYykgeyAvLyBhc3luY2hyb25vdXMgbGlzdGVuZXIKICAgICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChbY2FsbE5leHRMaXN0ZW5lcl0pKTsKICAgICAgICByZXR1cm47IC8vIHN0b3AgaGVyZSwgY2FsbE5leHRMaXN0ZW5lciB3aWxsIGNvbnRpbnVlCiAgICAgIH0gZWxzZSB7IC8vIHN5bmNocm9ub3VzIGxpc3RlbmVyCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwgZXJyKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVycm9yICYmIHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IpIHsKICAgICAgICAgIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICB9LAoKICAvKioKICAgKiBBZGRzIG9yIGNvcGllcyBhIHNldCBvZiBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGxpc3Qgb2YKICAgKiBsaXN0ZW5lcnMgb3IgU2VxdWVudGlhbEV4ZWN1dG9yIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSBsaXN0ZW5lcnMgW21hcDxTdHJpbmcsQXJyYXk8RnVuY3Rpb24+PiwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0KICAgKiAgIGEgbGlzdCBvZiBldmVudHMgYW5kIGNhbGxiYWNrcywgb3IgYW4gZXZlbnQgZW1pdHRlciBvYmplY3QKICAgKiAgIGNvbnRhaW5pbmcgbGlzdGVuZXJzIHRvIGFkZCB0byB0aGlzIGVtaXR0ZXIgb2JqZWN0LgogICAqIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBlbWl0dGVyIG9iamVjdCwgZm9yIGNoYWluaW5nLgogICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhIG1hcCBvZiBsaXN0ZW5lcnMKICAgKiAgIGVtaXR0ZXIuYWRkTGlzdGVuZXJzKHsKICAgKiAgICAgZXZlbnQxOiBbZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbigpIHsgLi4uIH1dLAogICAqICAgICBldmVudDI6IFtmdW5jdGlvbigpIHsgLi4uIH1dCiAgICogICB9KTsKICAgKiAgIGVtaXR0ZXIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIgaGFzIGV2ZW50MQogICAqICAgZW1pdHRlci5lbWl0KCdldmVudDInKTsgLy8gZW1pdHRlciBoYXMgZXZlbnQyCiAgICogQGV4YW1wbGUgQWRkaW5nIGxpc3RlbmVycyBmcm9tIGFub3RoZXIgZW1pdHRlciBvYmplY3QKICAgKiAgIHZhciBlbWl0dGVyMSA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICogICBlbWl0dGVyMS5vbignZXZlbnQxJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgKiAgIGVtaXR0ZXIxLm9uKCdldmVudDInLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAqICAgdmFyIGVtaXR0ZXIyID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAgKiAgIGVtaXR0ZXIyLmFkZExpc3RlbmVycyhlbWl0dGVyMSk7CiAgICogICBlbWl0dGVyMi5lbWl0KCdldmVudDEnKTsgLy8gZW1pdHRlcjIgaGFzIGV2ZW50MQogICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQyJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDIKICAgKi8KICBhZGRMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZExpc3RlbmVycyhsaXN0ZW5lcnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAvLyBleHRyYWN0IGxpc3RlbmVycyBpZiBwYXJhbWV0ZXIgaXMgYW4gU2VxdWVudGlhbEV4ZWN1dG9yIG9iamVjdAogICAgaWYgKGxpc3RlbmVycy5fZXZlbnRzKSBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuX2V2ZW50czsKCiAgICBBV1MudXRpbC5lYWNoKGxpc3RlbmVycywgZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrcykgewogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrcyA9PT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2tzID0gW2NhbGxiYWNrc107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaChjYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgc2VsZi5vbihldmVudCwgY2FsbGJhY2spOwogICAgICB9KTsKICAgIH0pOwoKICAgIHJldHVybiBzZWxmOwogIH0sCgogIC8qKgogICAqIFJlZ2lzdGVycyBhbiBldmVudCB3aXRoIHtvbn0gYW5kIHNhdmVzIHRoZSBjYWxsYmFjayBoYW5kbGUgZnVuY3Rpb24KICAgKiBhcyBhIHByb3BlcnR5IG9uIHRoZSBlbWl0dGVyIG9iamVjdCB1c2luZyBhIGdpdmVuIGBuYW1lYC4KICAgKgogICAqIEBwYXJhbSBuYW1lIFtTdHJpbmddIHRoZSBwcm9wZXJ0eSBuYW1lIHRvIHNldCBvbiB0aGlzIG9iamVjdCBjb250YWluaW5nCiAgICogICB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gaGFuZGxlIHNvIHRoYXQgdGhlIGxpc3RlbmVyIGNhbiBiZSByZW1vdmVkIGluCiAgICogICB0aGUgZnV0dXJlLgogICAqIEBwYXJhbSAoc2VlIG9uKQogICAqIEByZXR1cm4gKHNlZSBvbikKICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBuYW1lZCBsaXN0ZW5lciBEQVRBX0NBTExCQUNLCiAgICogICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbigpIHsgZG9Tb21ldGhpbmcoKTsgfTsKICAgKiAgIGVtaXR0ZXIuYWRkTmFtZWRMaXN0ZW5lcignREFUQV9DQUxMQkFDSycsICdkYXRhJywgbGlzdGVuZXIpOwogICAqCiAgICogICAvLyB0aGUgZm9sbG93aW5nIHByaW50czogdHJ1ZQogICAqICAgY29uc29sZS5sb2coZW1pdHRlci5EQVRBX0NBTExCQUNLID09IGxpc3RlbmVyKTsKICAgKi8KICBhZGROYW1lZExpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCkgewogICAgdGhpc1tuYW1lXSA9IGNhbGxiYWNrOwogICAgdGhpcy5hZGRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYWRkTmFtZWRBc3luY0xpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZEFzeW5jTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICBjYWxsYmFjay5faXNBc3luYyA9IHRydWU7CiAgICByZXR1cm4gdGhpcy5hZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCk7CiAgfSwKCiAgLyoqCiAgICogSGVscGVyIG1ldGhvZCB0byBhZGQgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzIHVzaW5nCiAgICoge2FkZE5hbWVkTGlzdGVuZXJ9LiBUaGUgY2FsbGJhY2sgY29udGFpbnMgYSBwYXJhbWV0ZXIKICAgKiB3aXRoIGEgaGFuZGxlIHRvIHRoZSBgYWRkTmFtZWRMaXN0ZW5lcmAgbWV0aG9kLgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGFkZCkKICAgKiAgIFRoZSBjYWxsYmFjayBmdW5jdGlvbiBpcyBjYWxsZWQgaW1tZWRpYXRlbHkgaW4gb3JkZXIgdG8gcHJvdmlkZQogICAqICAgdGhlIGBhZGRgIGZ1bmN0aW9uIHRvIHRoZSBibG9jay4gVGhpcyBzaW1wbGlmaWVzIHRoZSBhZGRpdGlvbiBvZgogICAqICAgYSBsYXJnZSBncm91cCBvZiBuYW1lZCBsaXN0ZW5lcnMuCiAgICogICBAcGFyYW0gYWRkIFtGdW5jdGlvbl0gdGhlIHthZGROYW1lZExpc3RlbmVyfSBmdW5jdGlvbiB0byBjYWxsCiAgICogICAgIHdoZW4gcmVnaXN0ZXJpbmcgbGlzdGVuZXJzLgogICAqIEBleGFtcGxlIEFkZGluZyBhIHNldCBvZiBuYW1lZCBsaXN0ZW5lcnMKICAgKiAgIGVtaXR0ZXIuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICogICAgIGFkZCgnREFUQV9DQUxMQkFDSycsICdkYXRhJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgKiAgICAgYWRkKCdPVEhFUicsICdvdGhlckV2ZW50JywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgKiAgICAgYWRkKCdMQVNUJywgJ2xhc3RFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICogICB9KTsKICAgKgogICAqICAgLy8gdGhlc2UgcHJvcGVydGllcyBhcmUgbm93IHNldDoKICAgKiAgIGVtaXR0ZXIuREFUQV9DQUxMQkFDSzsKICAgKiAgIGVtaXR0ZXIuT1RIRVI7CiAgICogICBlbWl0dGVyLkxBU1Q7CiAgICovCiAgYWRkTmFtZWRMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZE5hbWVkTGlzdGVuZXJzKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjYWxsYmFjaygKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5hZGROYW1lZExpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgIH0sCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYuYWRkTmFtZWRBc3luY0xpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgICk7CiAgICByZXR1cm4gdGhpczsKICB9Cn0pOwoKLyoqCiAqIHtvbn0gaXMgdGhlIHByZWZlcmVkIG1ldGhvZC4KICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLm9uOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yOwoKfSx7Ii4vY29yZSI6MTl9XSw2MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnZhciBBcGkgPSByZXF1aXJlKCcuL21vZGVsL2FwaScpOwp2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi9yZWdpb25fY29uZmlnJyk7Cgp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CnZhciBjbGllbnRDb3VudCA9IDA7CnZhciByZWdpb25fdXRpbHMgPSByZXF1aXJlKCcuL3JlZ2lvbi91dGlscycpOwoKLyoqCiAqIFRoZSBzZXJ2aWNlIGNsYXNzIHJlcHJlc2VudGluZyBhbiBBV1Mgc2VydmljZS4KICoKICogQGNsYXNzX2Fic3RyYWN0IFRoaXMgY2xhc3MgaXMgYW4gYWJzdHJhY3QgY2xhc3MuCiAqCiAqIEAhYXR0cmlidXRlIGFwaVZlcnNpb25zCiAqICAgQHJldHVybiBbQXJyYXk8U3RyaW5nPl0gdGhlIGxpc3Qgb2YgQVBJIHZlcnNpb25zIHN1cHBvcnRlZCBieSB0aGlzIHNlcnZpY2UuCiAqICAgQHJlYWRvbmx5CiAqLwpBV1MuU2VydmljZSA9IGluaGVyaXQoewogIC8qKgogICAqIENyZWF0ZSBhIG5ldyBzZXJ2aWNlIG9iamVjdCB3aXRoIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgKgogICAqIEBwYXJhbSBjb25maWcgW21hcF0gYSBtYXAgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNlcnZpY2UoY29uZmlnKSB7CiAgICBpZiAoIXRoaXMubG9hZFNlcnZpY2VDbGFzcykgewogICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAnU2VydmljZSBtdXN0IGJlIGNvbnN0cnVjdGVkIHdpdGggYG5ld1wnIG9wZXJhdG9yJyk7CiAgICB9CgogICAgaWYgKGNvbmZpZykgewogICAgICBpZiAoY29uZmlnLnJlZ2lvbikgewogICAgICAgIHZhciByZWdpb24gPSBjb25maWcucmVnaW9uOwogICAgICAgIGlmIChyZWdpb25fdXRpbHMuaXNGaXBzUmVnaW9uKHJlZ2lvbikpIHsKICAgICAgICAgIGNvbmZpZy5yZWdpb24gPSByZWdpb25fdXRpbHMuZ2V0UmVhbFJlZ2lvbihyZWdpb24pOwogICAgICAgICAgY29uZmlnLnVzZUZpcHNFbmRwb2ludCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChyZWdpb25fdXRpbHMuaXNHbG9iYWxSZWdpb24ocmVnaW9uKSkgewogICAgICAgICAgY29uZmlnLnJlZ2lvbiA9IHJlZ2lvbl91dGlscy5nZXRSZWFsUmVnaW9uKHJlZ2lvbik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0eXBlb2YgY29uZmlnLnVzZUR1YWxzdGFjayA9PT0gJ2Jvb2xlYW4nCiAgICAgICAgJiYgdHlwZW9mIGNvbmZpZy51c2VEdWFsc3RhY2tFbmRwb2ludCAhPT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgY29uZmlnLnVzZUR1YWxzdGFja0VuZHBvaW50ID0gY29uZmlnLnVzZUR1YWxzdGFjazsKICAgICAgfQogICAgfQoKICAgIHZhciBTZXJ2aWNlQ2xhc3MgPSB0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MoY29uZmlnIHx8IHt9KTsKICAgIGlmIChTZXJ2aWNlQ2xhc3MpIHsKICAgICAgdmFyIG9yaWdpbmFsQ29uZmlnID0gQVdTLnV0aWwuY29weShjb25maWcpOwogICAgICB2YXIgc3ZjID0gbmV3IFNlcnZpY2VDbGFzcyhjb25maWcpOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc3ZjLCAnX29yaWdpbmFsQ29uZmlnJywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBvcmlnaW5hbENvbmZpZzsgfSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSk7CiAgICAgIHN2Yy5fY2xpZW50SWQgPSArK2NsaWVudENvdW50OwogICAgICByZXR1cm4gc3ZjOwogICAgfQogICAgdGhpcy5pbml0aWFsaXplKGNvbmZpZyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZShjb25maWcpIHsKICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW3RoaXMuc2VydmljZUlkZW50aWZpZXJdOwogICAgdGhpcy5jb25maWcgPSBuZXcgQVdTLkNvbmZpZyhBV1MuY29uZmlnKTsKICAgIGlmIChzdmNDb25maWcpIHRoaXMuY29uZmlnLnVwZGF0ZShzdmNDb25maWcsIHRydWUpOwogICAgaWYgKGNvbmZpZykgdGhpcy5jb25maWcudXBkYXRlKGNvbmZpZywgdHJ1ZSk7CgogICAgdGhpcy52YWxpZGF0ZVNlcnZpY2UoKTsKICAgIGlmICghdGhpcy5jb25maWcuZW5kcG9pbnQpIHJlZ2lvbkNvbmZpZy5jb25maWd1cmVFbmRwb2ludCh0aGlzKTsKCiAgICB0aGlzLmNvbmZpZy5lbmRwb2ludCA9IHRoaXMuZW5kcG9pbnRGcm9tVGVtcGxhdGUodGhpcy5jb25maWcuZW5kcG9pbnQpOwogICAgdGhpcy5zZXRFbmRwb2ludCh0aGlzLmNvbmZpZy5lbmRwb2ludCk7CiAgICAvL2VuYWJsZSBhdHRhY2hpbmcgbGlzdGVuZXJzIHRvIHNlcnZpY2UgY2xpZW50CiAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcyk7CiAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyh0aGlzKTsKICAgIGlmICgodGhpcy5jb25maWcuY2xpZW50U2lkZU1vbml0b3JpbmcgfHwgQVdTLlNlcnZpY2UuX2NsaWVudFNpZGVNb25pdG9yaW5nKSAmJiB0aGlzLnB1Ymxpc2hlcikgewogICAgICB2YXIgcHVibGlzaGVyID0gdGhpcy5wdWJsaXNoZXI7CiAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQ0FMTCcsICdhcGlDYWxsJywgZnVuY3Rpb24gUFVCTElTSF9BUElfQ0FMTChldmVudCkgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7cHVibGlzaGVyLmV2ZW50SGFuZGxlcihldmVudCk7fSk7CiAgICAgIH0pOwogICAgICB0aGlzLmFkZE5hbWVkTGlzdGVuZXIoJ1BVQkxJU0hfQVBJX0FUVEVNUFQnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9BVFRFTVBUKGV2ZW50KSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtwdWJsaXNoZXIuZXZlbnRIYW5kbGVyKGV2ZW50KTt9KTsKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZFNlcnZpY2VDbGFzczogZnVuY3Rpb24gbG9hZFNlcnZpY2VDbGFzcyhzZXJ2aWNlQ29uZmlnKSB7CiAgICB2YXIgY29uZmlnID0gc2VydmljZUNvbmZpZzsKICAgIGlmICghQVdTLnV0aWwuaXNFbXB0eSh0aGlzLmFwaSkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgaWYgKGNvbmZpZy5hcGlDb25maWcpIHsKICAgICAgcmV0dXJuIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgY29uZmlnLmFwaUNvbmZpZyk7CiAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICAgIGNvbmZpZy51cGRhdGUoc2VydmljZUNvbmZpZywgdHJ1ZSk7CiAgICAgIHZhciB2ZXJzaW9uID0gY29uZmlnLmFwaVZlcnNpb25zW3RoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXJdOwogICAgICB2ZXJzaW9uID0gdmVyc2lvbiB8fCBjb25maWcuYXBpVmVyc2lvbjsKICAgICAgcmV0dXJuIHRoaXMuZ2V0TGF0ZXN0U2VydmljZUNsYXNzKHZlcnNpb24pOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldExhdGVzdFNlcnZpY2VDbGFzczogZnVuY3Rpb24gZ2V0TGF0ZXN0U2VydmljZUNsYXNzKHZlcnNpb24pIHsKICAgIHZlcnNpb24gPSB0aGlzLmdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pOwogICAgaWYgKHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXNbdmVyc2lvbl0gPT09IG51bGwpIHsKICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZUFwaSh0aGlzLmNvbnN0cnVjdG9yLCB2ZXJzaW9uKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRMYXRlc3RTZXJ2aWNlVmVyc2lvbjogZnVuY3Rpb24gZ2V0TGF0ZXN0U2VydmljZVZlcnNpb24odmVyc2lvbikgewogICAgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzIHx8IHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2VydmljZXMgZGVmaW5lZCBvbiAnICsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZUlkZW50aWZpZXIpOwogICAgfQoKICAgIGlmICghdmVyc2lvbikgewogICAgICB2ZXJzaW9uID0gJ2xhdGVzdCc7CiAgICB9IGVsc2UgaWYgKEFXUy51dGlsLmlzVHlwZSh2ZXJzaW9uLCBEYXRlKSkgewogICAgICB2ZXJzaW9uID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKHZlcnNpb24pLnNwbGl0KCdUJylbMF07CiAgICB9CgogICAgaWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eSh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzLCB2ZXJzaW9uKSkgewogICAgICByZXR1cm4gdmVyc2lvbjsKICAgIH0KCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpLnNvcnQoKTsKICAgIHZhciBzZWxlY3RlZFZlcnNpb24gPSBudWxsOwogICAgZm9yICh2YXIgaSA9IGtleXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgLy8gdmVyc2lvbnMgdGhhdCBlbmQgaW4gIioiIGFyZSBub3QgYXZhaWxhYmxlIG9uIGRpc2sgYW5kIGNhbiBiZQogICAgICAvLyBza2lwcGVkLCBzbyBkbyBub3QgY2hvb3NlIHRoZXNlIGFzIHNlbGVjdGVkVmVyc2lvbnMKICAgICAgaWYgKGtleXNbaV1ba2V5c1tpXS5sZW5ndGggLSAxXSAhPT0gJyonKSB7CiAgICAgICAgc2VsZWN0ZWRWZXJzaW9uID0ga2V5c1tpXTsKICAgICAgfQogICAgICBpZiAoa2V5c1tpXS5zdWJzdHIoMCwgMTApIDw9IHZlcnNpb24pIHsKICAgICAgICByZXR1cm4gc2VsZWN0ZWRWZXJzaW9uOwogICAgICB9CiAgICB9CgogICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCAnICsgdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlSWRlbnRpZmllciArCiAgICAgICAgICAgICAgICAgICAgJyBBUEkgdG8gc2F0aXNmeSB2ZXJzaW9uIGNvbnN0cmFpbnQgYCcgKyB2ZXJzaW9uICsgJ1wnJyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXBpOiB7fSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZGVmYXVsdFJldHJ5Q291bnQ6IDMsCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGN1c3RvbWl6ZVJlcXVlc3RzOiBmdW5jdGlvbiBjdXN0b21pemVSZXF1ZXN0cyhjYWxsYmFjaykgewogICAgaWYgKCFjYWxsYmFjaykgewogICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyID0gbnVsbDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPSBjYWxsYmFjazsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjYWxsYmFjayB0eXBlIFwnJyArIHR5cGVvZiBjYWxsYmFjayArICdcJyBwcm92aWRlZCBpbiBjdXN0b21pemVSZXF1ZXN0cycpOwogICAgfQogIH0sCgogIC8qKgogICAqIENhbGxzIGFuIG9wZXJhdGlvbiBvbiBhIHNlcnZpY2Ugd2l0aCB0aGUgZ2l2ZW4gaW5wdXQgcGFyYW1ldGVycy4KICAgKgogICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG5hbWUgb2YgdGhlIG9wZXJhdGlvbiB0byBjYWxsIG9uIHRoZSBzZXJ2aWNlLgogICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICogICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgKiAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICovCiAgbWFrZVJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgIHBhcmFtcyA9IG51bGw7CiAgICB9CgogICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgaWYgKHRoaXMuY29uZmlnLnBhcmFtcykgeyAvLyBjb3B5IG9ubHkgdG9wbGV2ZWwgYm91bmQgcGFyYW1zCiAgICAgIHZhciBydWxlcyA9IHRoaXMuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXTsKICAgICAgaWYgKHJ1bGVzKSB7CiAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgIEFXUy51dGlsLmVhY2godGhpcy5jb25maWcucGFyYW1zLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICBpZiAocnVsZXMuaW5wdXQubWVtYmVyc1trZXldKSB7CiAgICAgICAgICAgIGlmIChwYXJhbXNba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtc1trZXldID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcGFyYW1zW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgdmFyIHJlcXVlc3QgPSBuZXcgQVdTLlJlcXVlc3QodGhpcywgb3BlcmF0aW9uLCBwYXJhbXMpOwogICAgdGhpcy5hZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgdGhpcy5hdHRhY2hNb25pdG9yaW5nRW1pdHRlcihyZXF1ZXN0KTsKICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdC5zZW5kKGNhbGxiYWNrKTsKICAgIHJldHVybiByZXF1ZXN0OwogIH0sCgogIC8qKgogICAqIENhbGxzIGFuIG9wZXJhdGlvbiBvbiBhIHNlcnZpY2Ugd2l0aCB0aGUgZ2l2ZW4gaW5wdXQgcGFyYW1ldGVycywgd2l0aG91dAogICAqIGFueSBhdXRoZW50aWNhdGlvbiBkYXRhLiBUaGlzIG1ldGhvZCBpcyB1c2VmdWwgZm9yICJwdWJsaWMiIEFQSSBvcGVyYXRpb25zLgogICAqCiAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgbmFtZSBvZiB0aGUgb3BlcmF0aW9uIHRvIGNhbGwgb24gdGhlIHNlcnZpY2UuCiAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBpbnB1dCBvcHRpb25zIGZvciB0aGUgb3BlcmF0aW9uCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgKiAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgKi8KICBtYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdDogZnVuY3Rpb24gbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Qob3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgcGFyYW1zID0ge307CiAgICB9CgogICAgdmFyIHJlcXVlc3QgPSB0aGlzLm1ha2VSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zKS50b1VuYXV0aGVudGljYXRlZCgpOwogICAgcmV0dXJuIGNhbGxiYWNrID8gcmVxdWVzdC5zZW5kKGNhbGxiYWNrKSA6IHJlcXVlc3Q7CiAgfSwKCiAgLyoqCiAgICogV2FpdHMgZm9yIGEgZ2l2ZW4gc3RhdGUKICAgKgogICAqIEBwYXJhbSBzdGF0ZSBbU3RyaW5nXSB0aGUgc3RhdGUgb24gdGhlIHNlcnZpY2UgdG8gd2FpdCBmb3IKICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIHBhcmFtZXRlcnMgdG8gcGFzcyB3aXRoIGVhY2ggcmVxdWVzdAogICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIgW21hcF0gYSBtYXAgb2YgY29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgd2FpdGVyCiAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlci5kZWxheSBbTnVtYmVyXSBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdG8gd2FpdCBiZXR3ZWVuCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0cwogICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIubWF4QXR0ZW1wdHMgW051bWJlcl0gVGhlIG1heGltdW0gbnVtYmVyIG9mIHJlcXVlc3RzCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBzZW5kIHdoaWxlIHdhaXRpbmcKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAqICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAqLwogIHdhaXRGb3I6IGZ1bmN0aW9uIHdhaXRGb3Ioc3RhdGUsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgIHZhciB3YWl0ZXIgPSBuZXcgQVdTLlJlc291cmNlV2FpdGVyKHRoaXMsIHN0YXRlKTsKICAgIHJldHVybiB3YWl0ZXIud2FpdChwYXJhbXMsIGNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhZGRBbGxSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBhZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpIHsKICAgIHZhciBsaXN0ID0gW0FXUy5ldmVudHMsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLCB0aGlzLnNlcnZpY2VJbnRlcmZhY2UoKSwKICAgICAgICAgICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlUG9zdF07CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGxpc3RbaV0pIHJlcXVlc3QuYWRkTGlzdGVuZXJzKGxpc3RbaV0pOwogICAgfQoKICAgIC8vIGRpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24KICAgIGlmICghdGhpcy5jb25maWcucGFyYW1WYWxpZGF0aW9uKSB7CiAgICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywKICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgIH0KCiAgICBpZiAodGhpcy5jb25maWcubG9nZ2VyKSB7IC8vIGFkZCBsb2dnaW5nIGV2ZW50cwogICAgICByZXF1ZXN0LmFkZExpc3RlbmVycyhBV1MuRXZlbnRMaXN0ZW5lcnMuTG9nZ2VyKTsKICAgIH0KCiAgICB0aGlzLnNldHVwUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KTsKICAgIC8vIGNhbGwgcHJvdG90eXBlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgIGlmICh0eXBlb2YgdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuY3VzdG9tUmVxdWVzdEhhbmRsZXIocmVxdWVzdCk7CiAgICB9CiAgICAvLyBjYWxsIGluc3RhbmNlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcywgJ2N1c3RvbVJlcXVlc3RIYW5kbGVyJykgJiYgdHlwZW9mIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgIH0KICB9LAoKICAvKioKICAgKiBFdmVudCByZWNvcmRpbmcgbWV0cmljcyBmb3IgYSB3aG9sZSBBUEkgY2FsbC4KICAgKiBAcmV0dXJucyB7b2JqZWN0fSBhIHN1YnNldCBvZiBhcGkgY2FsbCBtZXRyaWNzCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXBpQ2FsbEV2ZW50OiBmdW5jdGlvbiBhcGlDYWxsRXZlbnQocmVxdWVzdCkgewogICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgbW9uaXRvcmluZ0V2ZW50ID0gewogICAgICBUeXBlOiAnQXBpQ2FsbCcsCiAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgVmVyc2lvbjogMSwKICAgICAgU2VydmljZTogcmVxdWVzdC5zZXJ2aWNlLmFwaS5zZXJ2aWNlSWQgfHwgcmVxdWVzdC5zZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgUmVnaW9uOiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgTWF4UmV0cmllc0V4Y2VlZGVkOiAwLAogICAgICBVc2VyQWdlbnQ6IHJlcXVlc3QuaHR0cFJlcXVlc3QuZ2V0VXNlckFnZW50KCksCiAgICB9OwogICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICBtb25pdG9yaW5nRXZlbnQuRmluYWxIdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgfQogICAgaWYgKHJlc3BvbnNlLmVycm9yKSB7CiAgICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICB2YXIgc3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICBpZiAoc3RhdHVzQ29kZSA+IDI5OSkgewogICAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxBd3NFeGNlcHRpb24gPSBlcnJvci5jb2RlOwogICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxBd3NFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5GaW5hbFNka0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogIH0sCgogIC8qKgogICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhbiBBUEkgY2FsbCBhdHRlbXB0LgogICAqIEByZXR1cm5zIHtvYmplY3R9IGEgc3Vic2V0IG9mIGFwaSBjYWxsIGF0dGVtcHQgbWV0cmljcwogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFwaUF0dGVtcHRFdmVudDogZnVuY3Rpb24gYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpIHsKICAgIHZhciBhcGkgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHsKICAgICAgVHlwZTogJ0FwaUNhbGxBdHRlbXB0JywKICAgICAgQXBpOiBhcGkgPyBhcGkubmFtZSA6IHJlcXVlc3Qub3BlcmF0aW9uLAogICAgICBWZXJzaW9uOiAxLAogICAgICBTZXJ2aWNlOiByZXF1ZXN0LnNlcnZpY2UuYXBpLnNlcnZpY2VJZCB8fCByZXF1ZXN0LnNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICBGcWRuOiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3RuYW1lLAogICAgICBVc2VyQWdlbnQ6IHJlcXVlc3QuaHR0cFJlcXVlc3QuZ2V0VXNlckFnZW50KCksCiAgICB9OwogICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICBtb25pdG9yaW5nRXZlbnQuSHR0cFN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgIH0KICAgIGlmICgKICAgICAgIXJlcXVlc3QuX3VuQXV0aGVudGljYXRlZCAmJgogICAgICByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzICYmCiAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQKICAgICkgewogICAgICBtb25pdG9yaW5nRXZlbnQuQWNjZXNzS2V5ID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAgIH0KICAgIGlmICghcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnMpIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICBpZiAocmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddKSB7CiAgICAgIG1vbml0b3JpbmdFdmVudC5TZXNzaW9uVG9rZW4gPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ107CiAgICB9CiAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXSkgewogICAgICBtb25pdG9yaW5nRXZlbnQuWEFtem5SZXF1ZXN0SWQgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddOwogICAgfQogICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ10pIHsKICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpSZXF1ZXN0SWQgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddOwogICAgfQogICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1pZC0yJ10pIHsKICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpJZDIgPSByZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotaWQtMiddOwogICAgfQogICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICB9LAoKICAvKioKICAgKiBBZGQgbWV0cmljcyBvZiBmYWlsZWQgcmVxdWVzdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhdHRlbXB0RmFpbEV2ZW50OiBmdW5jdGlvbiBhdHRlbXB0RmFpbEV2ZW50KHJlcXVlc3QpIHsKICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB0aGlzLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA+IDI5OSApIHsKICAgICAgaWYgKGVycm9yLmNvZGUpIG1vbml0b3JpbmdFdmVudC5Bd3NFeGNlcHRpb24gPSBlcnJvci5jb2RlOwogICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgfSBlbHNlIHsKICAgICAgaWYgKGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZSkgbW9uaXRvcmluZ0V2ZW50LlNka0V4Y2VwdGlvbiA9IGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZTsKICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5TZGtFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgIH0KICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgfSwKCiAgLyoqCiAgICogQXR0YWNoIGxpc3RlbmVycyB0byByZXF1ZXN0IG9iamVjdCB0byBmZXRjaCBtZXRyaWNzIG9mIGVhY2ggcmVxdWVzdAogICAqIGFuZCBlbWl0IGRhdGEgb2JqZWN0IHRocm91Z2ggXCdBcGlDYWxsXCcgYW5kIFwnQXBpQ2FsbEF0dGVtcHRcJyBldmVudHMuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXI6IGZ1bmN0aW9uIGF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpIHsKICAgIHZhciBhdHRlbXB0VGltZXN0YW1wOyAvL3RpbWVzdGFtcCBtYXJraW5nIHRoZSBiZWdpbm5pbmcgb2YgYSByZXF1ZXN0IGF0dGVtcHQKICAgIHZhciBhdHRlbXB0U3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIHJlcXVlc3QgYXR0ZW1wdC4gVXNlZCB0byBjYWxjdWxhdGluZyBhdHRlbXB0TGF0ZW5jeQogICAgdmFyIGF0dGVtcHRMYXRlbmN5OyAvL2xhdGVuY3kgZnJvbSByZXF1ZXN0IHNlbnQgb3V0IHRvIGh0dHAgcmVzcG9uc2UgcmVhY2hpbmcgU0RLCiAgICB2YXIgY2FsbFN0YXJ0UmVhbFRpbWU7IC8vU3RhcnQgdGltZSBvZiBBUEkgY2FsbC4gVXNlZCB0byBjYWxjdWxhdGluZyBBUEkgY2FsbCBsYXRlbmN5CiAgICB2YXIgYXR0ZW1wdENvdW50ID0gMDsgLy9yZXF1ZXN0LnJldHJ5Q291bnQgaXMgbm90IHJlbGlhYmxlIGhlcmUKICAgIHZhciByZWdpb247IC8vcmVnaW9uIGNhY2hlIHJlZ2lvbiBmb3IgZWFjaCBhdHRlbXB0IHNpbmNlIGl0IGNhbiBiZSB1cGRhdGVkIGluIHBsYXNlIChlLmcuIHMzKQogICAgdmFyIGNhbGxUaW1lc3RhbXA7IC8vdGltZXN0YW1wIHdoZW4gdGhlIHJlcXVlc3QgaXMgY3JlYXRlZAogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGFkZFRvSGVhZCA9IHRydWU7CgogICAgcmVxdWVzdC5vbigndmFsaWRhdGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgIGNhbGxTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICBjYWxsVGltZXN0YW1wID0gRGF0ZS5ub3coKTsKICAgIH0sIGFkZFRvSGVhZCk7CiAgICByZXF1ZXN0Lm9uKCdzaWduJywgZnVuY3Rpb24gKCkgewogICAgICBhdHRlbXB0U3RhcnRSZWFsVGltZSA9IEFXUy51dGlsLnJlYWxDbG9jay5ub3coKTsKICAgICAgYXR0ZW1wdFRpbWVzdGFtcCA9IERhdGUubm93KCk7CiAgICAgIHJlZ2lvbiA9IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uOwogICAgICBhdHRlbXB0Q291bnQrKzsKICAgIH0sIGFkZFRvSGVhZCk7CiAgICByZXF1ZXN0Lm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24oKSB7CiAgICAgIGF0dGVtcHRMYXRlbmN5ID0gTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBhdHRlbXB0U3RhcnRSZWFsVGltZSk7CiAgICB9KTsKICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVCcsICdzdWNjZXNzJywgZnVuY3Rpb24gQVBJX0NBTExfQVRURU1QVCgpIHsKICAgICAgdmFyIGFwaUF0dGVtcHRFdmVudCA9IHNlbGYuYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpOwogICAgICBhcGlBdHRlbXB0RXZlbnQuVGltZXN0YW1wID0gYXR0ZW1wdFRpbWVzdGFtcDsKICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgYXBpQXR0ZW1wdEV2ZW50LlJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgc2VsZi5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFthcGlBdHRlbXB0RXZlbnRdKTsKICAgIH0pOwogICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTF9BVFRFTVBUX1JFVFJZJywgJ3JldHJ5JywgZnVuY3Rpb24gQVBJX0NBTExfQVRURU1QVF9SRVRSWSgpIHsKICAgICAgdmFyIGFwaUF0dGVtcHRFdmVudCA9IHNlbGYuYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KTsKICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgIC8vYXR0ZW1wdExhdGVuY3kgbWF5IG5vdCBiZSBhdmFpbGFibGUgaWYgZmFpbCBiZWZvcmUgcmVzcG9uc2UKICAgICAgYXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSB8fAogICAgICAgIE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgICBhcGlBdHRlbXB0RXZlbnQuQXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSA+PSAwID8gYXR0ZW1wdExhdGVuY3kgOiAwOwogICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICBzZWxmLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2FwaUF0dGVtcHRFdmVudF0pOwogICAgfSk7CiAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gQVBJX0NBTEwoKSB7CiAgICAgIHZhciBhcGlDYWxsRXZlbnQgPSBzZWxmLmFwaUNhbGxFdmVudChyZXF1ZXN0KTsKICAgICAgYXBpQ2FsbEV2ZW50LkF0dGVtcHRDb3VudCA9IGF0dGVtcHRDb3VudDsKICAgICAgaWYgKGFwaUNhbGxFdmVudC5BdHRlbXB0Q291bnQgPD0gMCkgcmV0dXJuOwogICAgICBhcGlDYWxsRXZlbnQuVGltZXN0YW1wID0gY2FsbFRpbWVzdGFtcDsKICAgICAgdmFyIGxhdGVuY3kgPSBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGNhbGxTdGFydFJlYWxUaW1lKTsKICAgICAgYXBpQ2FsbEV2ZW50LkxhdGVuY3kgPSBsYXRlbmN5ID49IDAgPyBsYXRlbmN5IDogMDsKICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgaWYgKAogICAgICAgIHJlc3BvbnNlLmVycm9yICYmCiAgICAgICAgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlICYmCiAgICAgICAgdHlwZW9mIHJlc3BvbnNlLnJldHJ5Q291bnQgPT09ICdudW1iZXInICYmCiAgICAgICAgdHlwZW9mIHJlc3BvbnNlLm1heFJldHJpZXMgPT09ICdudW1iZXInICYmCiAgICAgICAgKHJlc3BvbnNlLnJldHJ5Q291bnQgPj0gcmVzcG9uc2UubWF4UmV0cmllcykKICAgICAgKSB7CiAgICAgICAgYXBpQ2FsbEV2ZW50Lk1heFJldHJpZXNFeGNlZWRlZCA9IDE7CiAgICAgIH0KICAgICAgc2VsZi5lbWl0KCdhcGlDYWxsJywgW2FwaUNhbGxFdmVudF0pOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gc2V0dXAgYW55IGN1c3RvbSByZXF1ZXN0IGxpc3RlbmVycyBmb3IgZWFjaAogICAqIG5ldyByZXF1ZXN0IHRvIHRoZSBzZXJ2aWNlLgogICAqCiAgICogQG1ldGhvZF9hYnN0cmFjdCBUaGlzIGlzIGFuIGFic3RyYWN0IG1ldGhvZC4KICAgKi8KICBzZXR1cFJlcXVlc3RMaXN0ZW5lcnM6IGZ1bmN0aW9uIHNldHVwUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgfSwKCiAgLyoqCiAgICogR2V0cyB0aGUgc2lnbmluZyBuYW1lIGZvciBhIGdpdmVuIHJlcXVlc3QKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRTaWduaW5nTmFtZTogZnVuY3Rpb24gZ2V0U2lnbmluZ05hbWUoKSB7CiAgICByZXR1cm4gdGhpcy5hcGkuc2lnbmluZ05hbWUgfHwgdGhpcy5hcGkuZW5kcG9pbnRQcmVmaXg7CiAgfSwKCiAgLyoqCiAgICogR2V0cyB0aGUgc2lnbmVyIGNsYXNzIGZvciBhIGdpdmVuIHJlcXVlc3QKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRTaWduZXJDbGFzczogZnVuY3Rpb24gZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCkgewogICAgdmFyIHZlcnNpb247CiAgICAvLyBnZXQgb3BlcmF0aW9uIGF1dGh0eXBlIGlmIHByZXNlbnQKICAgIHZhciBvcGVyYXRpb24gPSBudWxsOwogICAgdmFyIGF1dGh0eXBlID0gJyc7CiAgICBpZiAocmVxdWVzdCkgewogICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgb3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gfHwgbnVsbDsKICAgICAgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgIH0KICAgIGlmICh0aGlzLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSB7CiAgICAgIHZlcnNpb24gPSB0aGlzLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uOwogICAgfSBlbHNlIGlmIChhdXRodHlwZSA9PT0gJ3Y0JyB8fCBhdXRodHlwZSA9PT0gJ3Y0LXVuc2lnbmVkLWJvZHknKSB7CiAgICAgIHZlcnNpb24gPSAndjQnOwogICAgfSBlbHNlIHsKICAgICAgdmVyc2lvbiA9IHRoaXMuYXBpLnNpZ25hdHVyZVZlcnNpb247CiAgICB9CiAgICByZXR1cm4gQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5nZXRWZXJzaW9uKHZlcnNpb24pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNlcnZpY2VJbnRlcmZhY2U6IGZ1bmN0aW9uIHNlcnZpY2VJbnRlcmZhY2UoKSB7CiAgICBzd2l0Y2ggKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgIGNhc2UgJ2VjMic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUXVlcnk7CiAgICAgIGNhc2UgJ3F1ZXJ5JzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgY2FzZSAnanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuSnNvbjsKICAgICAgY2FzZSAncmVzdC1qc29uJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5SZXN0SnNvbjsKICAgICAgY2FzZSAncmVzdC14bWwnOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RYbWw7CiAgICB9CiAgICBpZiAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNlcnZpY2UgYHByb3RvY29sXCcgJyArCiAgICAgICAgdGhpcy5hcGkucHJvdG9jb2wgKyAnIGluIEFQSSBjb25maWcnKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzdWNjZXNzZnVsUmVzcG9uc2U6IGZ1bmN0aW9uIHN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSB7CiAgICByZXR1cm4gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDMwMDsKICB9LAoKICAvKioKICAgKiBIb3cgbWFueSB0aW1lcyBhIGZhaWxlZCByZXF1ZXN0IHNob3VsZCBiZSByZXRyaWVkIGJlZm9yZSBnaXZpbmcgdXAuCiAgICogdGhlIGRlZmF1bHRSZXRyeUNvdW50IGNhbiBiZSBvdmVycmlkZW4gYnkgc2VydmljZSBjbGFzc2VzLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbnVtUmV0cmllczogZnVuY3Rpb24gbnVtUmV0cmllcygpIHsKICAgIGlmICh0aGlzLmNvbmZpZy5tYXhSZXRyaWVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLm1heFJldHJpZXM7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5kZWZhdWx0UmV0cnlDb3VudDsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICByZXRyeURlbGF5czogZnVuY3Rpb24gcmV0cnlEZWxheXMocmV0cnlDb3VudCwgZXJyKSB7CiAgICByZXR1cm4gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCB0aGlzLmNvbmZpZy5yZXRyeURlbGF5T3B0aW9ucywgZXJyKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICByZXRyeWFibGVFcnJvcjogZnVuY3Rpb24gcmV0cnlhYmxlRXJyb3IoZXJyb3IpIHsKICAgIGlmICh0aGlzLnRpbWVvdXRFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgaWYgKHRoaXMubmV0d29ya2luZ0Vycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICBpZiAodGhpcy5leHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgaWYgKHRoaXMudGhyb3R0bGVkRXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChlcnJvci5zdGF0dXNDb2RlID49IDUwMCkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbmV0d29ya2luZ0Vycm9yOiBmdW5jdGlvbiBuZXR3b3JraW5nRXJyb3IoZXJyb3IpIHsKICAgIHJldHVybiBlcnJvci5jb2RlID09PSAnTmV0d29ya2luZ0Vycm9yJzsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB0aW1lb3V0RXJyb3I6IGZ1bmN0aW9uIHRpbWVvdXRFcnJvcihlcnJvcikgewogICAgcmV0dXJuIGVycm9yLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGV4cGlyZWRDcmVkZW50aWFsc0Vycm9yOiBmdW5jdGlvbiBleHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikgewogICAgLy8gVE9ETyA6IHRoaXMgb25seSBoYW5kbGVzICpvbmUqIG9mIHRoZSBleHBpcmVkIGNyZWRlbnRpYWwgY29kZXMKICAgIHJldHVybiAoZXJyb3IuY29kZSA9PT0gJ0V4cGlyZWRUb2tlbkV4Y2VwdGlvbicpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNsb2NrU2tld0Vycm9yOiBmdW5jdGlvbiBjbG9ja1NrZXdFcnJvcihlcnJvcikgewogICAgc3dpdGNoIChlcnJvci5jb2RlKSB7CiAgICAgIGNhc2UgJ1JlcXVlc3RUaW1lVG9vU2tld2VkJzoKICAgICAgY2FzZSAnUmVxdWVzdEV4cGlyZWQnOgogICAgICBjYXNlICdJbnZhbGlkU2lnbmF0dXJlRXhjZXB0aW9uJzoKICAgICAgY2FzZSAnU2lnbmF0dXJlRG9lc05vdE1hdGNoJzoKICAgICAgY2FzZSAnQXV0aEZhaWx1cmUnOgogICAgICBjYXNlICdSZXF1ZXN0SW5UaGVGdXR1cmUnOgogICAgICAgIHJldHVybiB0cnVlOwogICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0U2tld0NvcnJlY3RlZERhdGU6IGZ1bmN0aW9uIGdldFNrZXdDb3JyZWN0ZWREYXRlKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChuZXdTZXJ2ZXJUaW1lKSB7CiAgICBpZiAobmV3U2VydmVyVGltZSkgewogICAgICB0aGlzLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCA9IG5ld1NlcnZlclRpbWUgLSBEYXRlLm5vdygpOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQobmV3U2VydmVyVGltZSkgewogICAgaWYgKG5ld1NlcnZlclRpbWUpIHsKICAgICAgcmV0dXJuIE1hdGguYWJzKHRoaXMuZ2V0U2tld0NvcnJlY3RlZERhdGUoKS5nZXRUaW1lKCkgLSBuZXdTZXJ2ZXJUaW1lKSA+PSAzMDAwMDA7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdGhyb3R0bGVkRXJyb3I6IGZ1bmN0aW9uIHRocm90dGxlZEVycm9yKGVycm9yKSB7CiAgICAvLyB0aGlzIGxvZ2ljIHZhcmllcyBiZXR3ZWVuIHNlcnZpY2VzCiAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA9PT0gNDI5KSByZXR1cm4gdHJ1ZTsKICAgIHN3aXRjaCAoZXJyb3IuY29kZSkgewogICAgICBjYXNlICdQcm92aXNpb25lZFRocm91Z2hwdXRFeGNlZWRlZEV4Y2VwdGlvbic6CiAgICAgIGNhc2UgJ1Rocm90dGxpbmcnOgogICAgICBjYXNlICdUaHJvdHRsaW5nRXhjZXB0aW9uJzoKICAgICAgY2FzZSAnUmVxdWVzdExpbWl0RXhjZWVkZWQnOgogICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkJzoKICAgICAgY2FzZSAnUmVxdWVzdFRocm90dGxlZEV4Y2VwdGlvbic6CiAgICAgIGNhc2UgJ1Rvb01hbnlSZXF1ZXN0c0V4Y2VwdGlvbic6CiAgICAgIGNhc2UgJ1RyYW5zYWN0aW9uSW5Qcm9ncmVzc0V4Y2VwdGlvbic6IC8vZHluYW1vZGIKICAgICAgY2FzZSAnRUMyVGhyb3R0bGVkRXhjZXB0aW9uJzoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZW5kcG9pbnRGcm9tVGVtcGxhdGU6IGZ1bmN0aW9uIGVuZHBvaW50RnJvbVRlbXBsYXRlKGVuZHBvaW50KSB7CiAgICBpZiAodHlwZW9mIGVuZHBvaW50ICE9PSAnc3RyaW5nJykgcmV0dXJuIGVuZHBvaW50OwoKICAgIHZhciBlID0gZW5kcG9pbnQ7CiAgICBlID0gZS5yZXBsYWNlKC9ce3NlcnZpY2VcfS9nLCB0aGlzLmFwaS5lbmRwb2ludFByZWZpeCk7CiAgICBlID0gZS5yZXBsYWNlKC9ce3JlZ2lvblx9L2csIHRoaXMuY29uZmlnLnJlZ2lvbik7CiAgICBlID0gZS5yZXBsYWNlKC9ce3NjaGVtZVx9L2csIHRoaXMuY29uZmlnLnNzbEVuYWJsZWQgPyAnaHR0cHMnIDogJ2h0dHAnKTsKICAgIHJldHVybiBlOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNldEVuZHBvaW50OiBmdW5jdGlvbiBzZXRFbmRwb2ludChlbmRwb2ludCkgewogICAgdGhpcy5lbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQsIHRoaXMuY29uZmlnKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBwYWdpbmF0aW9uQ29uZmlnOiBmdW5jdGlvbiBwYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdGhyb3dFeGNlcHRpb24pIHsKICAgIHZhciBwYWdpbmF0b3IgPSB0aGlzLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl0ucGFnaW5hdG9yOwogICAgaWYgKCFwYWdpbmF0b3IpIHsKICAgICAgaWYgKHRocm93RXhjZXB0aW9uKSB7CiAgICAgICAgdmFyIGUgPSBuZXcgRXJyb3IoKTsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihlLCAnTm8gcGFnaW5hdGlvbiBjb25maWd1cmF0aW9uIGZvciAnICsgb3BlcmF0aW9uKTsKICAgICAgfQogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZXR1cm4gcGFnaW5hdG9yOwogIH0KfSk7CgpBV1MudXRpbC51cGRhdGUoQVdTLlNlcnZpY2UsIHsKCiAgLyoqCiAgICogQWRkcyBvbmUgbWV0aG9kIGZvciBlYWNoIG9wZXJhdGlvbiBkZXNjcmliZWQgaW4gdGhlIGFwaSBjb25maWd1cmF0aW9uCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBkZWZpbmVNZXRob2RzOiBmdW5jdGlvbiBkZWZpbmVNZXRob2RzKHN2YykgewogICAgQVdTLnV0aWwuZWFjaChzdmMucHJvdG90eXBlLmFwaS5vcGVyYXRpb25zLCBmdW5jdGlvbiBpdGVyYXRvcihtZXRob2QpIHsKICAgICAgaWYgKHN2Yy5wcm90b3R5cGVbbWV0aG9kXSkgcmV0dXJuOwogICAgICB2YXIgb3BlcmF0aW9uID0gc3ZjLnByb3RvdHlwZS5hcGkub3BlcmF0aW9uc1ttZXRob2RdOwogICAgICBpZiAob3BlcmF0aW9uLmF1dGh0eXBlID09PSAnbm9uZScpIHsKICAgICAgICBzdmMucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAocGFyYW1zLCBjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHN2Yy5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2spOwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwogIH0sCgogIC8qKgogICAqIERlZmluZXMgYSBuZXcgU2VydmljZSBjbGFzcyB1c2luZyBhIHNlcnZpY2UgaWRlbnRpZmllciBhbmQgbGlzdCBvZiB2ZXJzaW9ucwogICAqIGluY2x1ZGluZyBhbiBvcHRpb25hbCBzZXQgb2YgZmVhdHVyZXMgKGZ1bmN0aW9ucykgdG8gYXBwbHkgdG8gdGhlIGNsYXNzCiAgICogcHJvdG90eXBlLgogICAqCiAgICogQHBhcmFtIHNlcnZpY2VJZGVudGlmaWVyIFtTdHJpbmddIHRoZSBpZGVudGlmaWVyIGZvciB0aGUgc2VydmljZQogICAqIEBwYXJhbSB2ZXJzaW9ucyBbQXJyYXk8U3RyaW5nPl0gYSBsaXN0IG9mIHZlcnNpb25zIHRoYXQgd29yayB3aXRoIHRoaXMKICAgKiAgIHNlcnZpY2UKICAgKiBAcGFyYW0gZmVhdHVyZXMgW09iamVjdF0gYW4gb2JqZWN0IHRvIGF0dGFjaCB0byB0aGUgcHJvdG90eXBlCiAgICogQHJldHVybiBbQ2xhc3M8U2VydmljZT5dIHRoZSBzZXJ2aWNlIGNsYXNzIGRlZmluZWQgYnkgdGhpcyBmdW5jdGlvbi4KICAgKi8KICBkZWZpbmVTZXJ2aWNlOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlKHNlcnZpY2VJZGVudGlmaWVyLCB2ZXJzaW9ucywgZmVhdHVyZXMpIHsKICAgIEFXUy5TZXJ2aWNlLl9zZXJ2aWNlTWFwW3NlcnZpY2VJZGVudGlmaWVyXSA9IHRydWU7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkodmVyc2lvbnMpKSB7CiAgICAgIGZlYXR1cmVzID0gdmVyc2lvbnM7CiAgICAgIHZlcnNpb25zID0gW107CiAgICB9CgogICAgdmFyIHN2YyA9IGluaGVyaXQoQVdTLlNlcnZpY2UsIGZlYXR1cmVzIHx8IHt9KTsKCiAgICBpZiAodHlwZW9mIHNlcnZpY2VJZGVudGlmaWVyID09PSAnc3RyaW5nJykgewogICAgICBBV1MuU2VydmljZS5hZGRWZXJzaW9ucyhzdmMsIHZlcnNpb25zKTsKCiAgICAgIHZhciBpZGVudGlmaWVyID0gc3ZjLnNlcnZpY2VJZGVudGlmaWVyIHx8IHNlcnZpY2VJZGVudGlmaWVyOwogICAgICBzdmMuc2VydmljZUlkZW50aWZpZXIgPSBpZGVudGlmaWVyOwogICAgfSBlbHNlIHsgLy8gZGVmaW5lU2VydmljZSBjYWxsZWQgd2l0aCBhbiBBUEkKICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBzZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lTWV0aG9kcyhzdmMpOwogICAgfQogICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMucHJvdG90eXBlKTsKICAgIC8vdXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZyBpcyBvbmx5IGF2YWlsYWJsZSBpbiBub2RlCiAgICBpZiAoIXRoaXMucHJvdG90eXBlLnB1Ymxpc2hlciAmJiBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZykgewogICAgICB2YXIgUHVibGlzaGVyID0gQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcuUHVibGlzaGVyOwogICAgICB2YXIgY29uZmlnUHJvdmlkZXIgPSBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZy5jb25maWdQcm92aWRlcjsKICAgICAgdmFyIHB1Ymxpc2hlckNvbmZpZyA9IGNvbmZpZ1Byb3ZpZGVyKCk7CiAgICAgIHRoaXMucHJvdG90eXBlLnB1Ymxpc2hlciA9IG5ldyBQdWJsaXNoZXIocHVibGlzaGVyQ29uZmlnKTsKICAgICAgaWYgKHB1Ymxpc2hlckNvbmZpZy5lbmFibGVkKSB7CiAgICAgICAgLy9pZiBjc20gaXMgZW5hYmxlZCBpbiBlbnZpcm9ubWVudCwgU0RLIHNob3VsZCBzZW5kIGFsbCBtZXRyaWNzCiAgICAgICAgQVdTLlNlcnZpY2UuX2NsaWVudFNpZGVNb25pdG9yaW5nID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHN2Yy5wcm90b3R5cGUpOwogICAgQVdTLlNlcnZpY2UuYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnMoc3ZjLnByb3RvdHlwZSk7CiAgICByZXR1cm4gc3ZjOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFkZFZlcnNpb25zOiBmdW5jdGlvbiBhZGRWZXJzaW9ucyhzdmMsIHZlcnNpb25zKSB7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkodmVyc2lvbnMpKSB2ZXJzaW9ucyA9IFt2ZXJzaW9uc107CgogICAgc3ZjLnNlcnZpY2VzID0gc3ZjLnNlcnZpY2VzIHx8IHt9OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2ZXJzaW9ucy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoc3ZjLnNlcnZpY2VzW3ZlcnNpb25zW2ldXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgc3ZjLnNlcnZpY2VzW3ZlcnNpb25zW2ldXSA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICBzdmMuYXBpVmVyc2lvbnMgPSBPYmplY3Qua2V5cyhzdmMuc2VydmljZXMpLnNvcnQoKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBkZWZpbmVTZXJ2aWNlQXBpOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlQXBpKHN1cGVyY2xhc3MsIHZlcnNpb24sIGFwaUNvbmZpZykgewogICAgdmFyIHN2YyA9IGluaGVyaXQoc3VwZXJjbGFzcywgewogICAgICBzZXJ2aWNlSWRlbnRpZmllcjogc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllcgogICAgfSk7CgogICAgZnVuY3Rpb24gc2V0QXBpKGFwaSkgewogICAgICBpZiAoYXBpLmlzQXBpKSB7CiAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBhcGk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBuZXcgQXBpKGFwaSwgewogICAgICAgICAgc2VydmljZUlkZW50aWZpZXI6IHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpIHsKICAgICAgaWYgKGFwaUNvbmZpZykgewogICAgICAgIHNldEFwaShhcGlDb25maWcpOwogICAgICB9IGVsc2UgewogICAgICAgIHRyeSB7CiAgICAgICAgICBzZXRBcGkoQVdTLmFwaUxvYWRlcihzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyLCB2ZXJzaW9uKSk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihlcnIsIHsKICAgICAgICAgICAgbWVzc2FnZTogJ0NvdWxkIG5vdCBmaW5kIEFQSSBjb25maWd1cmF0aW9uICcgKwogICAgICAgICAgICAgIHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIgKyAnLScgKyB2ZXJzaW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3VwZXJjbGFzcy5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgICBzdXBlcmNsYXNzLmFwaVZlcnNpb25zID0gc3VwZXJjbGFzcy5hcGlWZXJzaW9ucy5jb25jYXQodmVyc2lvbikuc29ydCgpOwogICAgICB9CiAgICAgIHN1cGVyY2xhc3Muc2VydmljZXNbdmVyc2lvbl0gPSBzdmM7CiAgICB9IGVsc2UgewogICAgICBzZXRBcGkodmVyc2lvbik7CiAgICB9CgogICAgQVdTLlNlcnZpY2UuZGVmaW5lTWV0aG9kcyhzdmMpOwogICAgcmV0dXJuIHN2YzsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBoYXNTZXJ2aWNlOiBmdW5jdGlvbihpZGVudGlmaWVyKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUy5TZXJ2aWNlLl9zZXJ2aWNlTWFwLCBpZGVudGlmaWVyKTsKICB9LAoKICAvKioKICAgKiBAcGFyYW0gYXR0YWNoT24gYXR0YWNoIGRlZmF1bHQgbW9uaXRvcmluZyBsaXN0ZW5lcnMgdG8gb2JqZWN0CiAgICoKICAgKiBFYWNoIG1vbml0b3JpbmcgZXZlbnQgc2hvdWxkIGJlIGVtaXR0ZWQgZnJvbSBzZXJ2aWNlIGNsaWVudCB0byBzZXJ2aWNlIGNvbnN0cnVjdG9yIHByb3RvdHlwZSBhbmQgdGhlbgogICAqIHRvIGdsb2JhbCBzZXJ2aWNlIHByb3RvdHlwZSBsaWtlIGJ1YmJsaW5nIHVwLiBUaGVzZSBkZWZhdWx0IG1vbml0b3JpbmcgZXZlbnRzIGxpc3RlbmVyIHdpbGwgdHJhbnNmZXIKICAgKiB0aGUgbW9uaXRvcmluZyBldmVudHMgdG8gdGhlIHVwcGVyIGxheWVyLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyhhdHRhY2hPbikgewogICAgYXR0YWNoT24uYWRkTmFtZWRMaXN0ZW5lcignTU9OSVRPUl9FVkVOVFNfQlVCQkxFJywgJ2FwaUNhbGxBdHRlbXB0JywgZnVuY3Rpb24gRVZFTlRTX0JVQkJMRShldmVudCkgewogICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgaWYgKGJhc2VDbGFzcy5fZXZlbnRzKSBiYXNlQ2xhc3MuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbZXZlbnRdKTsKICAgIH0pOwogICAgYXR0YWNoT24uYWRkTmFtZWRMaXN0ZW5lcignQ0FMTF9FVkVOVFNfQlVCQkxFJywgJ2FwaUNhbGwnLCBmdW5jdGlvbiBDQUxMX0VWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgdmFyIGJhc2VDbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihhdHRhY2hPbik7CiAgICAgIGlmIChiYXNlQ2xhc3MuX2V2ZW50cykgYmFzZUNsYXNzLmVtaXQoJ2FwaUNhbGwnLCBbZXZlbnRdKTsKICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIF9zZXJ2aWNlTWFwOiB7fQp9KTsKCkFXUy51dGlsLm1peGluKEFXUy5TZXJ2aWNlLCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNlcnZpY2U7Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2NvcmUiOjE5LCIuL21vZGVsL2FwaSI6MzksIi4vcmVnaW9uL3V0aWxzIjo1NCwiLi9yZWdpb25fY29uZmlnIjo1NSwiX3Byb2Nlc3MiOjg5fV0sNjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgcmVzb2x2ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZyA9IHJlcXVpcmUoJy4uL2NvbmZpZ19yZWdpb25hbF9lbmRwb2ludCcpOwp2YXIgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgPSAnQVdTX1NUU19SRUdJT05BTF9FTkRQT0lOVFMnOwp2YXIgQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgPSAnc3RzX3JlZ2lvbmFsX2VuZHBvaW50cyc7CgpBV1MudXRpbC51cGRhdGUoQVdTLlNUUy5wcm90b3R5cGUsIHsKICAvKioKICAgKiBAb3ZlcmxvYWQgY3JlZGVudGlhbHNGcm9tKGRhdGEsIGNyZWRlbnRpYWxzID0gbnVsbCkKICAgKiAgIENyZWF0ZXMgYSBjcmVkZW50aWFscyBvYmplY3QgZnJvbSBTVFMgcmVzcG9uc2UgZGF0YSBjb250YWluaW5nCiAgICogICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbi4gVXNlZnVsIGZvciBxdWlja2x5IHNldHRpbmcgQVdTIGNyZWRlbnRpYWxzLgogICAqCiAgICogICBAbm90ZSBUaGlzIGlzIGEgbG93LWxldmVsIHV0aWxpdHkgZnVuY3Rpb24uIElmIHlvdSB3YW50IHRvIGxvYWQgdGVtcG9yYXJ5CiAgICogICAgIGNyZWRlbnRpYWxzIGludG8geW91ciBwcm9jZXNzIGZvciBzdWJzZXF1ZW50IHJlcXVlc3RzIHRvIEFXUyByZXNvdXJjZXMsCiAgICogICAgIHlvdSBzaG91bGQgdXNlIHtBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHN9IGluc3RlYWQuCiAgICogICBAcGFyYW0gZGF0YSBbbWFwXSBkYXRhIHJldHJpZXZlZCBmcm9tIGEgY2FsbCB0byB7Z2V0RmVkZXJhdGVkVG9rZW59LAogICAqICAgICB7Z2V0U2Vzc2lvblRva2VufSwge2Fzc3VtZVJvbGV9LCBvciB7YXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uCiAgICogICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gYW4gb3B0aW9uYWwgY3JlZGVudGlhbHMgb2JqZWN0IHRvCiAgICogICAgIGZpbGwgaW5zdGVhZCBvZiBjcmVhdGluZyBhIG5ldyBvYmplY3QuIFVzZWZ1bCB3aGVuIG1vZGlmeWluZyBhbgogICAqICAgICBleGlzdGluZyBjcmVkZW50aWFscyBvYmplY3QgZnJvbSBhIHJlZnJlc2ggY2FsbC4KICAgKiAgIEByZXR1cm4gW0FXUy5UZW1wb3JhcnlDcmVkZW50aWFsc10gdGhlIHNldCBvZiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgKiAgICAgbG9hZGVkIGZyb20gYSByYXcgU1RTIG9wZXJhdGlvbiByZXNwb25zZS4KICAgKiAgIEBleGFtcGxlIFVzaW5nIGNyZWRlbnRpYWxzRnJvbSB0byBsb2FkIGdsb2JhbCBBV1MgY3JlZGVudGlhbHMKICAgKiAgICAgdmFyIHN0cyA9IG5ldyBBV1MuU1RTKCk7CiAgICogICAgIHN0cy5nZXRTZXNzaW9uVG9rZW4oZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAqICAgICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJFcnJvciBnZXR0aW5nIGNyZWRlbnRpYWxzIik7CiAgICogICAgICAgZWxzZSB7CiAgICogICAgICAgICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gc3RzLmNyZWRlbnRpYWxzRnJvbShkYXRhKTsKICAgKiAgICAgICB9CiAgICogICAgIH0pOwogICAqICAgQHNlZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMKICAgKi8KICBjcmVkZW50aWFsc0Zyb206IGZ1bmN0aW9uIGNyZWRlbnRpYWxzRnJvbShkYXRhLCBjcmVkZW50aWFscykgewogICAgaWYgKCFkYXRhKSByZXR1cm4gbnVsbDsKICAgIGlmICghY3JlZGVudGlhbHMpIGNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgY3JlZGVudGlhbHMuZXhwaXJlZCA9IGZhbHNlOwogICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgPSBkYXRhLkNyZWRlbnRpYWxzLkFjY2Vzc0tleUlkOwogICAgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ID0gZGF0YS5DcmVkZW50aWFscy5TZWNyZXRBY2Nlc3NLZXk7CiAgICBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4gPSBkYXRhLkNyZWRlbnRpYWxzLlNlc3Npb25Ub2tlbjsKICAgIGNyZWRlbnRpYWxzLmV4cGlyZVRpbWUgPSBkYXRhLkNyZWRlbnRpYWxzLkV4cGlyYXRpb247CiAgICByZXR1cm4gY3JlZGVudGlhbHM7CiAgfSwKCiAgYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eTogZnVuY3Rpb24gYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eScsIHBhcmFtcywgY2FsbGJhY2spOwogIH0sCgogIGFzc3VtZVJvbGVXaXRoU0FNTDogZnVuY3Rpb24gYXNzdW1lUm9sZVdpdGhTQU1MKHBhcmFtcywgY2FsbGJhY2spIHsKICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdhc3N1bWVSb2xlV2l0aFNBTUwnLCBwYXJhbXMsIGNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzZXR1cFJlcXVlc3RMaXN0ZW5lcnM6IGZ1bmN0aW9uIHNldHVwUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICByZXF1ZXN0LmFkZExpc3RlbmVyKCd2YWxpZGF0ZScsIHRoaXMub3B0SW5SZWdpb25hbEVuZHBvaW50LCB0cnVlKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBvcHRJblJlZ2lvbmFsRW5kcG9pbnQ6IGZ1bmN0aW9uIG9wdEluUmVnaW9uYWxFbmRwb2ludChyZXEpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxLnNlcnZpY2U7CiAgICB2YXIgY29uZmlnID0gc2VydmljZS5jb25maWc7CiAgICBjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgPSByZXNvbHZlUmVnaW9uYWxFbmRwb2ludHNGbGFnKHNlcnZpY2UuX29yaWdpbmFsQ29uZmlnLCB7CiAgICAgIGVudjogRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQsCiAgICAgIHNoYXJlZENvbmZpZzogQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQsCiAgICAgIGNsaWVudENvbmZpZzogJ3N0c1JlZ2lvbmFsRW5kcG9pbnRzJwogICAgfSk7CiAgICBpZiAoCiAgICAgIGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyA9PT0gJ3JlZ2lvbmFsJyAmJgogICAgICBzZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQKICAgICkgewogICAgICAvL2NsaWVudCB3aWxsIHRocm93IGlmIHJlZ2lvbiBpcyBub3Qgc3VwcGxpZWQ7IHJlcXVlc3Qgd2lsbCBiZSBzaWduZWQgd2l0aCBzcGVjaWZpZWQgcmVnaW9uCiAgICAgIGlmICghY29uZmlnLnJlZ2lvbikgewogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAge2NvZGU6ICdDb25maWdFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIHJlZ2lvbiBpbiBjb25maWcnfSk7CiAgICAgIH0KICAgICAgdmFyIGluc2VydFBvaW50ID0gY29uZmlnLmVuZHBvaW50LmluZGV4T2YoJy5hbWF6b25hd3MuY29tJyk7CiAgICAgIHZhciByZWdpb25hbEVuZHBvaW50ID0gY29uZmlnLmVuZHBvaW50LnN1YnN0cmluZygwLCBpbnNlcnRQb2ludCkgKwogICAgICAgICcuJyArIGNvbmZpZy5yZWdpb24gKyBjb25maWcuZW5kcG9pbnQuc3Vic3RyaW5nKGluc2VydFBvaW50KTsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KHJlZ2lvbmFsRW5kcG9pbnQpOwogICAgICByZXEuaHR0cFJlcXVlc3QucmVnaW9uID0gY29uZmlnLnJlZ2lvbjsKICAgIH0KICB9Cgp9KTsKCn0seyIuLi9jb25maWdfcmVnaW9uYWxfZW5kcG9pbnQiOjE4LCIuLi9jb3JlIjoxOX1dLDYzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIGV4cGlyZXNIZWFkZXIgPSAncHJlc2lnbmVkLWV4cGlyZXMnOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gc2lnbmVkVXJsQnVpbGRlcihyZXF1ZXN0KSB7CiAgdmFyIGV4cGlyZXMgPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl07CiAgdmFyIHNpZ25lckNsYXNzID0gcmVxdWVzdC5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcXVlc3QpOwoKICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydVc2VyLUFnZW50J107CiAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotVXNlci1BZ2VudCddOwoKICBpZiAoc2lnbmVyQ2xhc3MgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICBpZiAoZXhwaXJlcyA+IDYwNDgwMCkgeyAvLyBvbmUgd2VlayBleHBpcnkgaXMgaW52YWxpZAogICAgICB2YXIgbWVzc2FnZSA9ICdQcmVzaWduaW5nIGRvZXMgbm90IHN1cHBvcnQgZXhwaXJ5IHRpbWUgZ3JlYXRlciAnICsKICAgICAgICAgICAgICAgICAgICAndGhhbiBhIHdlZWsgd2l0aCBTaWdWNCBzaWduaW5nLic7CiAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ0ludmFsaWRFeHBpcnlUaW1lJywgbWVzc2FnZTogbWVzc2FnZSwgcmV0cnlhYmxlOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IGV4cGlyZXM7CiAgfSBlbHNlIGlmIChzaWduZXJDbGFzcyA9PT0gQVdTLlNpZ25lcnMuUzMpIHsKICAgIHZhciBub3cgPSByZXF1ZXN0LnNlcnZpY2UgPyByZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKSA6IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpOwogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gcGFyc2VJbnQoCiAgICAgIEFXUy51dGlsLmRhdGUudW5peFRpbWVzdGFtcChub3cpICsgZXhwaXJlcywgMTApLnRvU3RyaW5nKCk7CiAgfSBlbHNlIHsKICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgIG1lc3NhZ2U6ICdQcmVzaWduaW5nIG9ubHkgc3VwcG9ydHMgUzMgb3IgU2lnVjQgc2lnbmluZy4nLAogICAgICBjb2RlOiAnVW5zdXBwb3J0ZWRTaWduZXInLCByZXRyeWFibGU6IGZhbHNlCiAgICB9KTsKICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHNpZ25lZFVybFNpZ25lcihyZXF1ZXN0KSB7CiAgdmFyIGVuZHBvaW50ID0gcmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludDsKICB2YXIgcGFyc2VkVXJsID0gQVdTLnV0aWwudXJsUGFyc2UocmVxdWVzdC5odHRwUmVxdWVzdC5wYXRoKTsKICB2YXIgcXVlcnlQYXJhbXMgPSB7fTsKCiAgaWYgKHBhcnNlZFVybC5zZWFyY2gpIHsKICAgIHF1ZXJ5UGFyYW1zID0gQVdTLnV0aWwucXVlcnlTdHJpbmdQYXJzZShwYXJzZWRVcmwuc2VhcmNoLnN1YnN0cigxKSk7CiAgfQoKICB2YXIgYXV0aCA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddLnNwbGl0KCcgJyk7CiAgaWYgKGF1dGhbMF0gPT09ICdBV1MnKSB7CiAgICBhdXRoID0gYXV0aFsxXS5zcGxpdCgnOicpOwogICAgcXVlcnlQYXJhbXNbJ1NpZ25hdHVyZSddID0gYXV0aC5wb3AoKTsKICAgIHF1ZXJ5UGFyYW1zWydBV1NBY2Nlc3NLZXlJZCddID0gYXV0aC5qb2luKCc6Jyk7CgogICAgQVdTLnV0aWwuZWFjaChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIGtleSA9ICdFeHBpcmVzJzsKICAgICAgaWYgKGtleS5pbmRleE9mKCd4LWFtei1tZXRhLScpID09PSAwKSB7CiAgICAgICAgLy8gRGVsZXRlIGV4aXN0aW5nLCBwb3RlbnRpYWxseSBub3Qgbm9ybWFsaXplZCBrZXkKICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNba2V5XTsKICAgICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgfQogICAgICBxdWVyeVBhcmFtc1trZXldID0gdmFsdWU7CiAgICB9KTsKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl07CiAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0F1dGhvcml6YXRpb24nXTsKICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snSG9zdCddOwogIH0gZWxzZSBpZiAoYXV0aFswXSA9PT0gJ0FXUzQtSE1BQy1TSEEyNTYnKSB7IC8vIFNpZ1Y0IHNpZ25pbmcKICAgIGF1dGguc2hpZnQoKTsKICAgIHZhciByZXN0ID0gYXV0aC5qb2luKCcgJyk7CiAgICB2YXIgc2lnbmF0dXJlID0gcmVzdC5tYXRjaCgvU2lnbmF0dXJlPSguKj8pKD86LHxcc3xccj9cbnwkKS8pWzFdOwogICAgcXVlcnlQYXJhbXNbJ1gtQW16LVNpZ25hdHVyZSddID0gc2lnbmF0dXJlOwogICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydFeHBpcmVzJ107CiAgfQoKICAvLyBidWlsZCBVUkwKICBlbmRwb2ludC5wYXRobmFtZSA9IHBhcnNlZFVybC5wYXRobmFtZTsKICBlbmRwb2ludC5zZWFyY2ggPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5UGFyYW1zKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNpZ25lcnMuUHJlc2lnbiA9IGluaGVyaXQoewogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNpZ246IGZ1bmN0aW9uIHNpZ24ocmVxdWVzdCwgZXhwaXJlVGltZSwgY2FsbGJhY2spIHsKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IGV4cGlyZVRpbWUgfHwgMzYwMDsKICAgIHJlcXVlc3Qub24oJ2J1aWxkJywgc2lnbmVkVXJsQnVpbGRlcik7CiAgICByZXF1ZXN0Lm9uKCdzaWduJywgc2lnbmVkVXJsU2lnbmVyKTsKICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2FmdGVyQnVpbGQnLAogICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRVRfQ09OVEVOVF9MRU5HVEgpOwogICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignYWZ0ZXJCdWlsZCcsCiAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkNPTVBVVEVfU0hBMjU2KTsKCiAgICByZXF1ZXN0LmVtaXQoJ2JlZm9yZVByZXNpZ24nLCBbcmVxdWVzdF0pOwoKICAgIGlmIChjYWxsYmFjaykgewogICAgICByZXF1ZXN0LmJ1aWxkKGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnJlc3BvbnNlLmVycm9yKSBjYWxsYmFjayh0aGlzLnJlc3BvbnNlLmVycm9yKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIGNhbGxiYWNrKG51bGwsIEFXUy51dGlsLnVybEZvcm1hdChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50KSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlcXVlc3QuYnVpbGQoKTsKICAgICAgaWYgKHJlcXVlc3QucmVzcG9uc2UuZXJyb3IpIHRocm93IHJlcXVlc3QucmVzcG9uc2UuZXJyb3I7CiAgICAgIHJldHVybiBBV1MudXRpbC51cmxGb3JtYXQocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCk7CiAgICB9CiAgfQp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuUHJlc2lnbjsKCn0seyIuLi9jb3JlIjoxOX1dLDY0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKCnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIgPSBpbmhlcml0KHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVxdWVzdFNpZ25lcihyZXF1ZXN0KSB7CiAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogIH0sCgogIHNldFNlcnZpY2VDbGllbnRJZDogZnVuY3Rpb24gc2V0U2VydmljZUNsaWVudElkKGlkKSB7CiAgICB0aGlzLnNlcnZpY2VDbGllbnRJZCA9IGlkOwogIH0sCgogIGdldFNlcnZpY2VDbGllbnRJZDogZnVuY3Rpb24gZ2V0U2VydmljZUNsaWVudElkKCkgewogICAgcmV0dXJuIHRoaXMuc2VydmljZUNsaWVudElkOwogIH0KfSk7CgpBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmdldFZlcnNpb24gPSBmdW5jdGlvbiBnZXRWZXJzaW9uKHZlcnNpb24pIHsKICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgIGNhc2UgJ3YyJzogcmV0dXJuIEFXUy5TaWduZXJzLlYyOwogICAgY2FzZSAndjMnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjM7CiAgICBjYXNlICdzM3Y0JzogcmV0dXJuIEFXUy5TaWduZXJzLlY0OwogICAgY2FzZSAndjQnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjQ7CiAgICBjYXNlICdzMyc6IHJldHVybiBBV1MuU2lnbmVycy5TMzsKICAgIGNhc2UgJ3YzaHR0cHMnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjNIdHRwczsKICB9CiAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25pbmcgdmVyc2lvbiAnICsgdmVyc2lvbik7Cn07CgpyZXF1aXJlKCcuL3YyJyk7CnJlcXVpcmUoJy4vdjMnKTsKcmVxdWlyZSgnLi92M2h0dHBzJyk7CnJlcXVpcmUoJy4vdjQnKTsKcmVxdWlyZSgnLi9zMycpOwpyZXF1aXJlKCcuL3ByZXNpZ24nKTsKCn0seyIuLi9jb3JlIjoxOSwiLi9wcmVzaWduIjo2MywiLi9zMyI6NjUsIi4vdjIiOjY2LCIuL3YzIjo2NywiLi92M2h0dHBzIjo2OCwiLi92NCI6Njl9XSw2NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TaWduZXJzLlMzID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgLyoqCiAgICogV2hlbiBidWlsZGluZyB0aGUgc3RyaW5nVG9TaWduLCB0aGVzZSBzdWIgcmVzb3VyY2UgcGFyYW1zIHNob3VsZCBiZQogICAqIHBhcnQgb2YgdGhlIGNhbm9uaWNhbCByZXNvdXJjZSBzdHJpbmcgd2l0aCB0aGVpciBOT04tZGVjb2RlZCB2YWx1ZXMKICAgKi8KICBzdWJSZXNvdXJjZXM6IHsKICAgICdhY2wnOiAxLAogICAgJ2FjY2VsZXJhdGUnOiAxLAogICAgJ2FuYWx5dGljcyc6IDEsCiAgICAnY29ycyc6IDEsCiAgICAnbGlmZWN5Y2xlJzogMSwKICAgICdkZWxldGUnOiAxLAogICAgJ2ludmVudG9yeSc6IDEsCiAgICAnbG9jYXRpb24nOiAxLAogICAgJ2xvZ2dpbmcnOiAxLAogICAgJ21ldHJpY3MnOiAxLAogICAgJ25vdGlmaWNhdGlvbic6IDEsCiAgICAncGFydE51bWJlcic6IDEsCiAgICAncG9saWN5JzogMSwKICAgICdyZXF1ZXN0UGF5bWVudCc6IDEsCiAgICAncmVwbGljYXRpb24nOiAxLAogICAgJ3Jlc3RvcmUnOiAxLAogICAgJ3RhZ2dpbmcnOiAxLAogICAgJ3RvcnJlbnQnOiAxLAogICAgJ3VwbG9hZElkJzogMSwKICAgICd1cGxvYWRzJzogMSwKICAgICd2ZXJzaW9uSWQnOiAxLAogICAgJ3ZlcnNpb25pbmcnOiAxLAogICAgJ3ZlcnNpb25zJzogMSwKICAgICd3ZWJzaXRlJzogMQogIH0sCgogIC8vIHdoZW4gYnVpbGRpbmcgdGhlIHN0cmluZ1RvU2lnbiwgdGhlc2UgcXVlcnlzdHJpbmcgcGFyYW1zIHNob3VsZCBiZQogIC8vIHBhcnQgb2YgdGhlIGNhbm9uaWNhbCByZXNvdXJjZSBzdHJpbmcgd2l0aCB0aGVpciBOT04tZW5jb2RlZCB2YWx1ZXMKICByZXNwb25zZUhlYWRlcnM6IHsKICAgICdyZXNwb25zZS1jb250ZW50LXR5cGUnOiAxLAogICAgJ3Jlc3BvbnNlLWNvbnRlbnQtbGFuZ3VhZ2UnOiAxLAogICAgJ3Jlc3BvbnNlLWV4cGlyZXMnOiAxLAogICAgJ3Jlc3BvbnNlLWNhY2hlLWNvbnRyb2wnOiAxLAogICAgJ3Jlc3BvbnNlLWNvbnRlbnQtZGlzcG9zaXRpb24nOiAxLAogICAgJ3Jlc3BvbnNlLWNvbnRlbnQtZW5jb2RpbmcnOiAxCiAgfSwKCiAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogICAgaWYgKCF0aGlzLnJlcXVlc3QuaGVhZGVyc1sncHJlc2lnbmVkLWV4cGlyZXMnXSkgewogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gQVdTLnV0aWwuZGF0ZS5yZmM4MjIoZGF0ZSk7CiAgICB9CgogICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAvLyBwcmVzaWduZWQgVVJMcyByZXF1aXJlIHRoaXMgaGVhZGVyIHRvIGJlIGxvd2VyY2FzZWQKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICB9CgogICAgdmFyIHNpZ25hdHVyZSA9IHRoaXMuc2lnbihjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCkpOwogICAgdmFyIGF1dGggPSAnQVdTICcgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICc6JyArIHNpZ25hdHVyZTsKCiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYXV0aDsKICB9LAoKICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwoKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgcGFydHMucHVzaChyLm1ldGhvZCk7CiAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1snQ29udGVudC1NRDUnXSB8fCAnJyk7CiAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gfHwgJycpOwoKICAgIC8vIFRoaXMgaXMgdGhlICJEYXRlIiBoZWFkZXIsIGJ1dCB3ZSB1c2UgWC1BbXotRGF0ZS4KICAgIC8vIFRoZSBTMyBzaWduaW5nIG1lY2hhbmlzbSByZXF1aXJlcyB1cyB0byBwYXNzIGFuIGVtcHR5CiAgICAvLyBzdHJpbmcgZm9yIHRoaXMgRGF0ZSBoZWFkZXIgcmVnYXJkbGVzcy4KICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddIHx8ICcnKTsKCiAgICB2YXIgaGVhZGVycyA9IHRoaXMuY2Fub25pY2FsaXplZEFtekhlYWRlcnMoKTsKICAgIGlmIChoZWFkZXJzKSBwYXJ0cy5wdXNoKGhlYWRlcnMpOwogICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbGl6ZWRSZXNvdXJjZSgpKTsKCiAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKCiAgfSwKCiAgY2Fub25pY2FsaXplZEFtekhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzKCkgewoKICAgIHZhciBhbXpIZWFkZXJzID0gW107CgogICAgQVdTLnV0aWwuZWFjaCh0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgaWYgKG5hbWUubWF0Y2goL154LWFtei0vaSkpCiAgICAgICAgYW16SGVhZGVycy5wdXNoKG5hbWUpOwogICAgfSk7CgogICAgYW16SGVhZGVycy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhLnRvTG93ZXJDYXNlKCkgPCBiLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7CiAgICB9KTsKCiAgICB2YXIgcGFydHMgPSBbXTsKICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGFtekhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHBhcnRzLnB1c2gobmFtZS50b0xvd2VyQ2FzZSgpICsgJzonICsgU3RyaW5nKHRoaXMucmVxdWVzdC5oZWFkZXJzW25hbWVdKSk7CiAgICB9KTsKCiAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKCiAgfSwKCiAgY2Fub25pY2FsaXplZFJlc291cmNlOiBmdW5jdGlvbiBjYW5vbmljYWxpemVkUmVzb3VyY2UoKSB7CgogICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CgogICAgdmFyIHBhcnRzID0gci5wYXRoLnNwbGl0KCc/Jyk7CiAgICB2YXIgcGF0aCA9IHBhcnRzWzBdOwogICAgdmFyIHF1ZXJ5c3RyaW5nID0gcGFydHNbMV07CgogICAgdmFyIHJlc291cmNlID0gJyc7CgogICAgaWYgKHIudmlydHVhbEhvc3RlZEJ1Y2tldCkKICAgICAgcmVzb3VyY2UgKz0gJy8nICsgci52aXJ0dWFsSG9zdGVkQnVja2V0OwoKICAgIHJlc291cmNlICs9IHBhdGg7CgogICAgaWYgKHF1ZXJ5c3RyaW5nKSB7CgogICAgICAvLyBjb2xsZWN0IGEgbGlzdCBvZiBzdWIgcmVzb3VyY2VzIGFuZCBxdWVyeSBwYXJhbXMgdGhhdCBuZWVkIHRvIGJlIHNpZ25lZAogICAgICB2YXIgcmVzb3VyY2VzID0gW107CgogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBxdWVyeXN0cmluZy5zcGxpdCgnJicpLCBmdW5jdGlvbiAocGFyYW0pIHsKICAgICAgICB2YXIgbmFtZSA9IHBhcmFtLnNwbGl0KCc9JylbMF07CiAgICAgICAgdmFyIHZhbHVlID0gcGFyYW0uc3BsaXQoJz0nKVsxXTsKICAgICAgICBpZiAodGhpcy5zdWJSZXNvdXJjZXNbbmFtZV0gfHwgdGhpcy5yZXNwb25zZUhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgIHZhciBzdWJyZXNvdXJjZSA9IHsgbmFtZTogbmFtZSB9OwogICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc3ViUmVzb3VyY2VzW25hbWVdKSB7CiAgICAgICAgICAgICAgc3VicmVzb3VyY2UudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdWJyZXNvdXJjZS52YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc291cmNlcy5wdXNoKHN1YnJlc291cmNlKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmVzb3VyY2VzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIGEubmFtZSA8IGIubmFtZSA/IC0xIDogMTsgfSk7CgogICAgICBpZiAocmVzb3VyY2VzLmxlbmd0aCkgewoKICAgICAgICBxdWVyeXN0cmluZyA9IFtdOwogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChyZXNvdXJjZXMsIGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMudmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHF1ZXJ5c3RyaW5nLnB1c2gocmVzLm5hbWUgKyAnPScgKyByZXMudmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXNvdXJjZSArPSAnPycgKyBxdWVyeXN0cmluZy5qb2luKCcmJyk7CiAgICAgIH0KCiAgICB9CgogICAgcmV0dXJuIHJlc291cmNlOwoKICB9LAoKICBzaWduOiBmdW5jdGlvbiBzaWduKHNlY3JldCwgc3RyaW5nKSB7CiAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoc2VjcmV0LCBzdHJpbmcsICdiYXNlNjQnLCAnc2hhMScpOwogIH0KfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlMzOwoKfSx7Ii4uL2NvcmUiOjE5fV0sNjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2lnbmVycy5WMiA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKCiAgICBpZiAoIWRhdGUpIGRhdGUgPSBBV1MudXRpbC5kYXRlLmdldERhdGUoKTsKCiAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKCiAgICByLnBhcmFtcy5UaW1lc3RhbXAgPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEoZGF0ZSk7CiAgICByLnBhcmFtcy5TaWduYXR1cmVWZXJzaW9uID0gJzInOwogICAgci5wYXJhbXMuU2lnbmF0dXJlTWV0aG9kID0gJ0htYWNTSEEyNTYnOwogICAgci5wYXJhbXMuQVdTQWNjZXNzS2V5SWQgPSBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKCiAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgIHIucGFyYW1zLlNlY3VyaXR5VG9rZW4gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICB9CgogICAgZGVsZXRlIHIucGFyYW1zLlNpZ25hdHVyZTsgLy8gZGVsZXRlIG9sZCBTaWduYXR1cmUgZm9yIHJlLXNpZ25pbmcKICAgIHIucGFyYW1zLlNpZ25hdHVyZSA9IHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKCiAgICByLmJvZHkgPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHIucGFyYW1zKTsKICAgIHIuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9IHIuYm9keS5sZW5ndGg7CiAgfSwKCiAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMpIHsKICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCksICdiYXNlNjQnKTsKICB9LAoKICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LmVuZHBvaW50Lmhvc3QudG9Mb3dlckNhc2UoKSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5wYXRobmFtZSgpKTsKICAgIHBhcnRzLnB1c2goQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyh0aGlzLnJlcXVlc3QucGFyYW1zKSk7CiAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICB9Cgp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjI7Cgp9LHsiLi4vY29yZSI6MTl9XSw2NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TaWduZXJzLlYzID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewoKICAgIHZhciBkYXRldGltZSA9IEFXUy51dGlsLmRhdGUucmZjODIyKGRhdGUpOwoKICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBkYXRldGltZTsKCiAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgfQoKICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtem4tQXV0aG9yaXphdGlvbiddID0KICAgICAgdGhpcy5hdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CgogIH0sCgogIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMpIHsKICAgIHJldHVybiAnQVdTMyAnICsKICAgICAgJ0FXU0FjY2Vzc0tleUlkPScgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcsJyArCiAgICAgICdBbGdvcml0aG09SG1hY1NIQTI1NiwnICsKICAgICAgJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpICsgJywnICsKICAgICAgJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogIH0sCgogIHNpZ25lZEhlYWRlcnM6IGZ1bmN0aW9uIHNpZ25lZEhlYWRlcnMoKSB7CiAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgQVdTLnV0aWwuYXJyYXlFYWNoKHRoaXMuaGVhZGVyc1RvU2lnbigpLCBmdW5jdGlvbiBpdGVyYXRvcihoKSB7CiAgICAgIGhlYWRlcnMucHVzaChoLnRvTG93ZXJDYXNlKCkpOwogICAgfSk7CiAgICByZXR1cm4gaGVhZGVycy5zb3J0KCkuam9pbignOycpOwogIH0sCgogIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICB2YXIgaGVhZGVycyA9IHRoaXMucmVxdWVzdC5oZWFkZXJzOwogICAgdmFyIHBhcnRzID0gW107CiAgICBBV1MudXRpbC5hcnJheUVhY2godGhpcy5oZWFkZXJzVG9TaWduKCksIGZ1bmN0aW9uIGl0ZXJhdG9yKGgpIHsKICAgICAgcGFydHMucHVzaChoLnRvTG93ZXJDYXNlKCkudHJpbSgpICsgJzonICsgU3RyaW5nKGhlYWRlcnNbaF0pLnRyaW0oKSk7CiAgICB9KTsKICAgIHJldHVybiBwYXJ0cy5zb3J0KCkuam9pbignXG4nKSArICdcbic7CiAgfSwKCiAgaGVhZGVyc1RvU2lnbjogZnVuY3Rpb24gaGVhZGVyc1RvU2lnbigpIHsKICAgIHZhciBoZWFkZXJzID0gW107CiAgICBBV1MudXRpbC5lYWNoKHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiBpdGVyYXRvcihrKSB7CiAgICAgIGlmIChrID09PSAnSG9zdCcgfHwgayA9PT0gJ0NvbnRlbnQtRW5jb2RpbmcnIHx8IGsubWF0Y2goL15YLUFtei9pKSkgewogICAgICAgIGhlYWRlcnMucHVzaChrKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaGVhZGVyczsKICB9LAoKICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscykgewogICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSwgJ2Jhc2U2NCcpOwogIH0sCgogIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgdmFyIHBhcnRzID0gW107CiAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgcGFydHMucHVzaCgnLycpOwogICAgcGFydHMucHVzaCgnJyk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsSGVhZGVycygpKTsKICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LmJvZHkpOwogICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYocGFydHMuam9pbignXG4nKSk7CiAgfQoKfSk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYzOwoKfSx7Ii4uL2NvcmUiOjE5fV0sNjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgpyZXF1aXJlKCcuL3YzJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2lnbmVycy5WM0h0dHBzID0gaW5oZXJpdChBV1MuU2lnbmVycy5WMywgewogIGF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMpIHsKICAgIHJldHVybiAnQVdTMy1IVFRQUyAnICsKICAgICAgJ0FXU0FjY2Vzc0tleUlkPScgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcsJyArCiAgICAgICdBbGdvcml0aG09SG1hY1NIQTI1NiwnICsKICAgICAgJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogIH0sCgogIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgcmV0dXJuIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ107CiAgfQp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjNIdHRwczsKCn0seyIuLi9jb3JlIjoxOSwiLi92MyI6Njd9XSw2OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciB2NENyZWRlbnRpYWxzID0gcmVxdWlyZSgnLi92NF9jcmVkZW50aWFscycpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2lnbmVycy5WNCA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBWNChyZXF1ZXN0LCBzZXJ2aWNlTmFtZSwgb3B0aW9ucykgewogICAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5jYWxsKHRoaXMsIHJlcXVlc3QpOwogICAgdGhpcy5zZXJ2aWNlTmFtZSA9IHNlcnZpY2VOYW1lOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLnNpZ25hdHVyZUNhY2hlID0gdHlwZW9mIG9wdGlvbnMuc2lnbmF0dXJlQ2FjaGUgPT09ICdib29sZWFuJyA/IG9wdGlvbnMuc2lnbmF0dXJlQ2FjaGUgOiB0cnVlOwogICAgdGhpcy5vcGVyYXRpb24gPSBvcHRpb25zLm9wZXJhdGlvbjsKICAgIHRoaXMuc2lnbmF0dXJlVmVyc2lvbiA9IG9wdGlvbnMuc2lnbmF0dXJlVmVyc2lvbjsKICB9LAoKICBhbGdvcml0aG06ICdBV1M0LUhNQUMtU0hBMjU2JywKCiAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKGRhdGUpLnJlcGxhY2UoL1s6XC1dfFwuXGR7M30vZywgJycpOwoKICAgIGlmICh0aGlzLmlzUHJlc2lnbmVkKCkpIHsKICAgICAgdGhpcy51cGRhdGVGb3JQcmVzaWduZWQoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuYWRkSGVhZGVycyhjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgfQoKICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPQogICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICB9LAoKICBhZGRIZWFkZXJzOiBmdW5jdGlvbiBhZGRIZWFkZXJzKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IGRhdGV0aW1lOwogICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgIH0KICB9LAoKICB1cGRhdGVGb3JQcmVzaWduZWQ6IGZ1bmN0aW9uIHVwZGF0ZUZvclByZXNpZ25lZChjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgIHZhciBjcmVkU3RyaW5nID0gdGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKTsKICAgIHZhciBxcyA9IHsKICAgICAgJ1gtQW16LURhdGUnOiBkYXRldGltZSwKICAgICAgJ1gtQW16LUFsZ29yaXRobSc6IHRoaXMuYWxnb3JpdGhtLAogICAgICAnWC1BbXotQ3JlZGVudGlhbCc6IGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZywKICAgICAgJ1gtQW16LUV4cGlyZXMnOiB0aGlzLnJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSwKICAgICAgJ1gtQW16LVNpZ25lZEhlYWRlcnMnOiB0aGlzLnNpZ25lZEhlYWRlcnMoKQogICAgfTsKCiAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgIHFzWydYLUFtei1TZWN1cml0eS1Ub2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgfQoKICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10pIHsKICAgICAgcXNbJ0NvbnRlbnQtVHlwZSddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddOwogICAgfQogICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LU1ENSddKSB7CiAgICAgIHFzWydDb250ZW50LU1ENSddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J107CiAgICB9CiAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXSkgewogICAgICBxc1snQ2FjaGUtQ29udHJvbCddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXTsKICAgIH0KCiAgICAvLyBuZWVkIHRvIHB1bGwgaW4gYW55IG90aGVyIFgtQW16LSogaGVhZGVycwogICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIHJldHVybjsKICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSB7CiAgICAgICAgdmFyIGxvd2VyS2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgLy8gTWV0YWRhdGEgc2hvdWxkIGJlIG5vcm1hbGl6ZWQKICAgICAgICBpZiAobG93ZXJLZXkuaW5kZXhPZigneC1hbXotbWV0YS0nKSA9PT0gMCkgewogICAgICAgICAgcXNbbG93ZXJLZXldID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgewogICAgICAgICAgcXNba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgdmFyIHNlcCA9IHRoaXMucmVxdWVzdC5wYXRoLmluZGV4T2YoJz8nKSA+PSAwID8gJyYnIDogJz8nOwogICAgdGhpcy5yZXF1ZXN0LnBhdGggKz0gc2VwICsgQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxcyk7CiAgfSwKCiAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgdmFyIGNyZWRTdHJpbmcgPSB0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpOwogICAgcGFydHMucHVzaCh0aGlzLmFsZ29yaXRobSArICcgQ3JlZGVudGlhbD0nICsKICAgICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLycgKyBjcmVkU3RyaW5nKTsKICAgIHBhcnRzLnB1c2goJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpKTsKICAgIHBhcnRzLnB1c2goJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSk7CiAgICByZXR1cm4gcGFydHMuam9pbignLCAnKTsKICB9LAoKICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgIHZhciBzaWduaW5nS2V5ID0gdjRDcmVkZW50aWFscy5nZXRTaWduaW5nS2V5KAogICAgICBjcmVkZW50aWFscywKICAgICAgZGF0ZXRpbWUuc3Vic3RyKDAsIDgpLAogICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICB0aGlzLnNlcnZpY2VOYW1lLAogICAgICB0aGlzLnNpZ25hdHVyZUNhY2hlCiAgICApOwogICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKHNpZ25pbmdLZXksIHRoaXMuc3RyaW5nVG9TaWduKGRhdGV0aW1lKSwgJ2hleCcpOwogIH0sCgogIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKGRhdGV0aW1lKSB7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHBhcnRzLnB1c2goJ0FXUzQtSE1BQy1TSEEyNTYnKTsKICAgIHBhcnRzLnB1c2goZGF0ZXRpbWUpOwogICAgcGFydHMucHVzaCh0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpKTsKICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLmNhbm9uaWNhbFN0cmluZygpKSk7CiAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICB9LAoKICBjYW5vbmljYWxTdHJpbmc6IGZ1bmN0aW9uIGNhbm9uaWNhbFN0cmluZygpIHsKICAgIHZhciBwYXJ0cyA9IFtdLCBwYXRobmFtZSA9IHRoaXMucmVxdWVzdC5wYXRobmFtZSgpOwogICAgaWYgKHRoaXMuc2VydmljZU5hbWUgIT09ICdzMycgJiYgdGhpcy5zaWduYXR1cmVWZXJzaW9uICE9PSAnczN2NCcpIHBhdGhuYW1lID0gQVdTLnV0aWwudXJpRXNjYXBlUGF0aChwYXRobmFtZSk7CgogICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgIHBhcnRzLnB1c2gocGF0aG5hbWUpOwogICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3Quc2VhcmNoKCkpOwogICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbEhlYWRlcnMoKSArICdcbicpOwogICAgcGFydHMucHVzaCh0aGlzLnNpZ25lZEhlYWRlcnMoKSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuaGV4RW5jb2RlZEJvZHlIYXNoKCkpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgfSwKCiAgY2Fub25pY2FsSGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVycygpIHsKICAgIHZhciBoZWFkZXJzID0gW107CiAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIGl0ZW0pIHsKICAgICAgaGVhZGVycy5wdXNoKFtrZXksIGl0ZW1dKTsKICAgIH0pOwogICAgaGVhZGVycy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhWzBdLnRvTG93ZXJDYXNlKCkgPCBiWzBdLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7CiAgICB9KTsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgaGVhZGVycywgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgdmFyIGtleSA9IGl0ZW1bMF0udG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSB7CiAgICAgICAgdmFyIHZhbHVlID0gaXRlbVsxXTsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignSGVhZGVyICcgKyBrZXkgKyAnIGNvbnRhaW5zIGludmFsaWQgdmFsdWUnKSwgewogICAgICAgICAgICBjb2RlOiAnSW52YWxpZEhlYWRlcicKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBwYXJ0cy5wdXNoKGtleSArICc6JyArCiAgICAgICAgICB0aGlzLmNhbm9uaWNhbEhlYWRlclZhbHVlcyh2YWx1ZS50b1N0cmluZygpKSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgfSwKCiAgY2Fub25pY2FsSGVhZGVyVmFsdWVzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJWYWx1ZXModmFsdWVzKSB7CiAgICByZXR1cm4gdmFsdWVzLnJlcGxhY2UoL1xzKy9nLCAnICcpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7CiAgfSwKCiAgc2lnbmVkSGVhZGVyczogZnVuY3Rpb24gc2lnbmVkSGVhZGVycygpIHsKICAgIHZhciBrZXlzID0gW107CiAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAga2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmICh0aGlzLmlzU2lnbmFibGVIZWFkZXIoa2V5KSkga2V5cy5wdXNoKGtleSk7CiAgICB9KTsKICAgIHJldHVybiBrZXlzLnNvcnQoKS5qb2luKCc7Jyk7CiAgfSwKCiAgY3JlZGVudGlhbFN0cmluZzogZnVuY3Rpb24gY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSkgewogICAgcmV0dXJuIHY0Q3JlZGVudGlhbHMuY3JlYXRlU2NvcGUoCiAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgdGhpcy5yZXF1ZXN0LnJlZ2lvbiwKICAgICAgdGhpcy5zZXJ2aWNlTmFtZQogICAgKTsKICB9LAoKICBoZXhFbmNvZGVkSGFzaDogZnVuY3Rpb24gaGFzaChzdHJpbmcpIHsKICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uc2hhMjU2KHN0cmluZywgJ2hleCcpOwogIH0sCgogIGhleEVuY29kZWRCb2R5SGFzaDogZnVuY3Rpb24gaGV4RW5jb2RlZEJvZHlIYXNoKCkgewogICAgdmFyIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3Q7CiAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpICYmIChbJ3MzJywgJ3MzLW9iamVjdC1sYW1iZGEnXS5pbmRleE9mKHRoaXMuc2VydmljZU5hbWUpID4gLTEpICYmICFyZXF1ZXN0LmJvZHkpIHsKICAgICAgcmV0dXJuICdVTlNJR05FRC1QQVlMT0FEJzsKICAgIH0gZWxzZSBpZiAocmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddKSB7CiAgICAgIHJldHVybiByZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J107CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLnJlcXVlc3QuYm9keSB8fCAnJyk7CiAgICB9CiAgfSwKCiAgdW5zaWduYWJsZUhlYWRlcnM6IFsKICAgICdhdXRob3JpemF0aW9uJywKICAgICdjb250ZW50LXR5cGUnLAogICAgJ2NvbnRlbnQtbGVuZ3RoJywKICAgICd1c2VyLWFnZW50JywKICAgIGV4cGlyZXNIZWFkZXIsCiAgICAnZXhwZWN0JywKICAgICd4LWFtem4tdHJhY2UtaWQnCiAgXSwKCiAgaXNTaWduYWJsZUhlYWRlcjogZnVuY3Rpb24gaXNTaWduYWJsZUhlYWRlcihrZXkpIHsKICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgcmV0dXJuIHRydWU7CiAgICByZXR1cm4gdGhpcy51bnNpZ25hYmxlSGVhZGVycy5pbmRleE9mKGtleSkgPCAwOwogIH0sCgogIGlzUHJlc2lnbmVkOiBmdW5jdGlvbiBpc1ByZXNpZ25lZCgpIHsKICAgIHJldHVybiB0aGlzLnJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA/IHRydWUgOiBmYWxzZTsKICB9Cgp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjQ7Cgp9LHsiLi4vY29yZSI6MTksIi4vdjRfY3JlZGVudGlhbHMiOjcwfV0sNzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIGNhY2hlZFNlY3JldCA9IHt9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIGNhY2hlUXVldWUgPSBbXTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciBtYXhDYWNoZUVudHJpZXMgPSA1MDsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciB2NElkZW50aWZpZXIgPSAnYXdzNF9yZXF1ZXN0JzsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgKiBAcGFyYW0gcmVnaW9uIFtTdHJpbmddCiAgICogQHBhcmFtIHNlcnZpY2VOYW1lIFtTdHJpbmddCiAgICogQHJldHVybiBbU3RyaW5nXQogICAqLwogIGNyZWF0ZVNjb3BlOiBmdW5jdGlvbiBjcmVhdGVTY29wZShkYXRlLCByZWdpb24sIHNlcnZpY2VOYW1lKSB7CiAgICByZXR1cm4gWwogICAgICBkYXRlLnN1YnN0cigwLCA4KSwKICAgICAgcmVnaW9uLAogICAgICBzZXJ2aWNlTmFtZSwKICAgICAgdjRJZGVudGlmaWVyCiAgICBdLmpvaW4oJy8nKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSBjcmVkZW50aWFscyBbQ3JlZGVudGlhbHNdCiAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgKiBAcGFyYW0gcmVnaW9uIFtTdHJpbmddCiAgICogQHBhcmFtIHNlcnZpY2UgW1N0cmluZ10KICAgKiBAcGFyYW0gc2hvdWxkQ2FjaGUgW0Jvb2xlYW5dCiAgICogQHJldHVybiBbU3RyaW5nXQogICAqLwogIGdldFNpZ25pbmdLZXk6IGZ1bmN0aW9uIGdldFNpZ25pbmdLZXkoCiAgICBjcmVkZW50aWFscywKICAgIGRhdGUsCiAgICByZWdpb24sCiAgICBzZXJ2aWNlLAogICAgc2hvdWxkQ2FjaGUKICApIHsKICAgIHZhciBjcmVkc0lkZW50aWZpZXIgPSBBV1MudXRpbC5jcnlwdG8KICAgICAgLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCwgJ2Jhc2U2NCcpOwogICAgdmFyIGNhY2hlS2V5ID0gW2NyZWRzSWRlbnRpZmllciwgZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlXS5qb2luKCdfJyk7CiAgICBzaG91bGRDYWNoZSA9IHNob3VsZENhY2hlICE9PSBmYWxzZTsKICAgIGlmIChzaG91bGRDYWNoZSAmJiAoY2FjaGVLZXkgaW4gY2FjaGVkU2VjcmV0KSkgewogICAgICByZXR1cm4gY2FjaGVkU2VjcmV0W2NhY2hlS2V5XTsKICAgIH0KCiAgICB2YXIga0RhdGUgPSBBV1MudXRpbC5jcnlwdG8uaG1hYygKICAgICAgJ0FXUzQnICsgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LAogICAgICBkYXRlLAogICAgICAnYnVmZmVyJwogICAgKTsKICAgIHZhciBrUmVnaW9uID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa0RhdGUsIHJlZ2lvbiwgJ2J1ZmZlcicpOwogICAgdmFyIGtTZXJ2aWNlID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa1JlZ2lvbiwgc2VydmljZSwgJ2J1ZmZlcicpOwoKICAgIHZhciBzaWduaW5nS2V5ID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa1NlcnZpY2UsIHY0SWRlbnRpZmllciwgJ2J1ZmZlcicpOwogICAgaWYgKHNob3VsZENhY2hlKSB7CiAgICAgIGNhY2hlZFNlY3JldFtjYWNoZUtleV0gPSBzaWduaW5nS2V5OwogICAgICBjYWNoZVF1ZXVlLnB1c2goY2FjaGVLZXkpOwogICAgICBpZiAoY2FjaGVRdWV1ZS5sZW5ndGggPiBtYXhDYWNoZUVudHJpZXMpIHsKICAgICAgICAvLyByZW1vdmUgdGhlIG9sZGVzdCBlbnRyeSAobm90IHRoZSBsZWFzdCByZWNlbnRseSB1c2VkKQogICAgICAgIGRlbGV0ZSBjYWNoZWRTZWNyZXRbY2FjaGVRdWV1ZS5zaGlmdCgpXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBzaWduaW5nS2V5OwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogRW1wdGllcyB0aGUgZGVyaXZlZCBzaWduaW5nIGtleSBjYWNoZS4gTWFkZSBhdmFpbGFibGUgZm9yIHRlc3RpbmcgcHVycG9zZXMKICAgKiBvbmx5LgogICAqLwogIGVtcHR5Q2FjaGU6IGZ1bmN0aW9uIGVtcHR5Q2FjaGUoKSB7CiAgICBjYWNoZWRTZWNyZXQgPSB7fTsKICAgIGNhY2hlUXVldWUgPSBbXTsKICB9Cn07Cgp9LHsiLi4vY29yZSI6MTl9XSw3MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmZ1bmN0aW9uIEFjY2VwdG9yU3RhdGVNYWNoaW5lKHN0YXRlcywgc3RhdGUpIHsKICB0aGlzLmN1cnJlbnRTdGF0ZSA9IHN0YXRlIHx8IG51bGw7CiAgdGhpcy5zdGF0ZXMgPSBzdGF0ZXMgfHwge307Cn0KCkFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5ydW5UbyA9IGZ1bmN0aW9uIHJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGlucHV0RXJyb3IpIHsKICBpZiAodHlwZW9mIGZpbmFsU3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgIGlucHV0RXJyb3IgPSBiaW5kT2JqZWN0OyBiaW5kT2JqZWN0ID0gZG9uZTsKICAgIGRvbmUgPSBmaW5hbFN0YXRlOyBmaW5hbFN0YXRlID0gbnVsbDsKICB9CgogIHZhciBzZWxmID0gdGhpczsKICB2YXIgc3RhdGUgPSBzZWxmLnN0YXRlc1tzZWxmLmN1cnJlbnRTdGF0ZV07CiAgc3RhdGUuZm4uY2FsbChiaW5kT2JqZWN0IHx8IHNlbGYsIGlucHV0RXJyb3IsIGZ1bmN0aW9uKGVycikgewogICAgaWYgKGVycikgewogICAgICBpZiAoc3RhdGUuZmFpbCkgc2VsZi5jdXJyZW50U3RhdGUgPSBzdGF0ZS5mYWlsOwogICAgICBlbHNlIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QsIGVycikgOiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgaWYgKHN0YXRlLmFjY2VwdCkgc2VsZi5jdXJyZW50U3RhdGUgPSBzdGF0ZS5hY2NlcHQ7CiAgICAgIGVsc2UgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCkgOiBudWxsOwogICAgfQogICAgaWYgKHNlbGYuY3VycmVudFN0YXRlID09PSBmaW5hbFN0YXRlKSB7CiAgICAgIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QsIGVycikgOiBudWxsOwogICAgfQoKICAgIHNlbGYucnVuVG8oZmluYWxTdGF0ZSwgZG9uZSwgYmluZE9iamVjdCwgZXJyKTsKICB9KTsKfTsKCkFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5hZGRTdGF0ZSA9IGZ1bmN0aW9uIGFkZFN0YXRlKG5hbWUsIGFjY2VwdFN0YXRlLCBmYWlsU3RhdGUsIGZuKSB7CiAgaWYgKHR5cGVvZiBhY2NlcHRTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgZm4gPSBhY2NlcHRTdGF0ZTsgYWNjZXB0U3RhdGUgPSBudWxsOyBmYWlsU3RhdGUgPSBudWxsOwogIH0gZWxzZSBpZiAodHlwZW9mIGZhaWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgZm4gPSBmYWlsU3RhdGU7IGZhaWxTdGF0ZSA9IG51bGw7CiAgfQoKICBpZiAoIXRoaXMuY3VycmVudFN0YXRlKSB0aGlzLmN1cnJlbnRTdGF0ZSA9IG5hbWU7CiAgdGhpcy5zdGF0ZXNbbmFtZV0gPSB7IGFjY2VwdDogYWNjZXB0U3RhdGUsIGZhaWw6IGZhaWxTdGF0ZSwgZm46IGZuIH07CiAgcmV0dXJuIHRoaXM7Cn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFjY2VwdG9yU3RhdGVNYWNoaW5lOwoKfSx7fV0sNzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3Msc2V0SW1tZWRpYXRlKXsoZnVuY3Rpb24gKCl7Ci8qIGVzbGludCBndWFyZC1mb3ItaW46MCAqLwp2YXIgQVdTOwoKLyoqCiAqIEEgc2V0IG9mIHV0aWxpdHkgbWV0aG9kcyBmb3IgdXNlIHdpdGggdGhlIEFXUyBTREsuCiAqCiAqIEAhYXR0cmlidXRlIGFib3J0CiAqICAgUmV0dXJuIHRoaXMgdmFsdWUgZnJvbSBhbiBpdGVyYXRvciBmdW5jdGlvbiB7ZWFjaH0gb3Ige2FycmF5RWFjaH0KICogICB0byBicmVhayBvdXQgb2YgdGhlIGl0ZXJhdGlvbi4KICogICBAZXhhbXBsZSBCcmVha2luZyBvdXQgb2YgYW4gaXRlcmF0b3IgZnVuY3Rpb24KICogICAgIEFXUy51dGlsLmVhY2goe2E6IDEsIGI6IDIsIGM6IDN9LCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAqICAgICAgIGlmIChrZXkgPT0gJ2InKSByZXR1cm4gQVdTLnV0aWwuYWJvcnQ7CiAqICAgICB9KTsKICogICBAc2VlIGVhY2gKICogICBAc2VlIGFycmF5RWFjaAogKiBAYXBpIHByaXZhdGUKICovCnZhciB1dGlsID0gewogIGVudmlyb25tZW50OiAnbm9kZWpzJywKICBlbmdpbmU6IGZ1bmN0aW9uIGVuZ2luZSgpIHsKICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybiBuYXZpZ2F0b3IudXNlckFnZW50OwogICAgfSBlbHNlIHsKICAgICAgdmFyIGVuZ2luZSA9IHByb2Nlc3MucGxhdGZvcm0gKyAnLycgKyBwcm9jZXNzLnZlcnNpb247CiAgICAgIGlmIChwcm9jZXNzLmVudi5BV1NfRVhFQ1VUSU9OX0VOVikgewogICAgICAgIGVuZ2luZSArPSAnIGV4ZWMtZW52LycgKyBwcm9jZXNzLmVudi5BV1NfRVhFQ1VUSU9OX0VOVjsKICAgICAgfQogICAgICByZXR1cm4gZW5naW5lOwogICAgfQogIH0sCgogIHVzZXJBZ2VudDogZnVuY3Rpb24gdXNlckFnZW50KCkgewogICAgdmFyIG5hbWUgPSB1dGlsLmVudmlyb25tZW50OwogICAgdmFyIGFnZW50ID0gJ2F3cy1zZGstJyArIG5hbWUgKyAnLycgKyByZXF1aXJlKCcuL2NvcmUnKS5WRVJTSU9OOwogICAgaWYgKG5hbWUgPT09ICdub2RlanMnKSBhZ2VudCArPSAnICcgKyB1dGlsLmVuZ2luZSgpOwogICAgcmV0dXJuIGFnZW50OwogIH0sCgogIHVyaUVzY2FwZTogZnVuY3Rpb24gdXJpRXNjYXBlKHN0cmluZykgewogICAgdmFyIG91dHB1dCA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmcpOwogICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoL1teQS1aYS16MC05Xy5+XC0lXSsvZywgZXNjYXBlKTsKCiAgICAvLyBBV1MgcGVyY2VudC1lbmNvZGVzIHNvbWUgZXh0cmEgbm9uLXN0YW5kYXJkIGNoYXJhY3RlcnMgaW4gYSBVUkkKICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9bKl0vZywgZnVuY3Rpb24oY2gpIHsKICAgICAgcmV0dXJuICclJyArIGNoLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7CiAgICB9KTsKCiAgICByZXR1cm4gb3V0cHV0OwogIH0sCgogIHVyaUVzY2FwZVBhdGg6IGZ1bmN0aW9uIHVyaUVzY2FwZVBhdGgoc3RyaW5nKSB7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHV0aWwuYXJyYXlFYWNoKHN0cmluZy5zcGxpdCgnLycpLCBmdW5jdGlvbiAocGFydCkgewogICAgICBwYXJ0cy5wdXNoKHV0aWwudXJpRXNjYXBlKHBhcnQpKTsKICAgIH0pOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKTsKICB9LAoKICB1cmxQYXJzZTogZnVuY3Rpb24gdXJsUGFyc2UodXJsKSB7CiAgICByZXR1cm4gdXRpbC51cmwucGFyc2UodXJsKTsKICB9LAoKICB1cmxGb3JtYXQ6IGZ1bmN0aW9uIHVybEZvcm1hdCh1cmwpIHsKICAgIHJldHVybiB1dGlsLnVybC5mb3JtYXQodXJsKTsKICB9LAoKICBxdWVyeVN0cmluZ1BhcnNlOiBmdW5jdGlvbiBxdWVyeVN0cmluZ1BhcnNlKHFzKSB7CiAgICByZXR1cm4gdXRpbC5xdWVyeXN0cmluZy5wYXJzZShxcyk7CiAgfSwKCiAgcXVlcnlQYXJhbXNUb1N0cmluZzogZnVuY3Rpb24gcXVlcnlQYXJhbXNUb1N0cmluZyhwYXJhbXMpIHsKICAgIHZhciBpdGVtcyA9IFtdOwogICAgdmFyIGVzY2FwZSA9IHV0aWwudXJpRXNjYXBlOwogICAgdmFyIHNvcnRlZEtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpLnNvcnQoKTsKCiAgICB1dGlsLmFycmF5RWFjaChzb3J0ZWRLZXlzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgICAgdmFyIGVuYW1lID0gZXNjYXBlKG5hbWUpOwogICAgICB2YXIgcmVzdWx0ID0gZW5hbWUgKyAnPSc7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHZhciB2YWxzID0gW107CiAgICAgICAgdXRpbC5hcnJheUVhY2godmFsdWUsIGZ1bmN0aW9uKGl0ZW0pIHsgdmFscy5wdXNoKGVzY2FwZShpdGVtKSk7IH0pOwogICAgICAgIHJlc3VsdCA9IGVuYW1lICsgJz0nICsgdmFscy5zb3J0KCkuam9pbignJicgKyBlbmFtZSArICc9Jyk7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgIHJlc3VsdCA9IGVuYW1lICsgJz0nICsgZXNjYXBlKHZhbHVlKTsKICAgICAgfQogICAgICBpdGVtcy5wdXNoKHJlc3VsdCk7CiAgICB9KTsKCiAgICByZXR1cm4gaXRlbXMuam9pbignJicpOwogIH0sCgogIHJlYWRGaWxlU3luYzogZnVuY3Rpb24gcmVhZEZpbGVTeW5jKHBhdGgpIHsKICAgIGlmICh1dGlsLmlzQnJvd3NlcigpKSByZXR1cm4gbnVsbDsKICAgIHJldHVybiByZXF1aXJlKCdmcycpLnJlYWRGaWxlU3luYyhwYXRoLCAndXRmLTgnKTsKICB9LAoKICBiYXNlNjQ6IHsKICAgIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlNjQoc3RyaW5nKSB7CiAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnbnVtYmVyJykgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgYmFzZTY0IGVuY29kZSBudW1iZXIgJyArIHN0cmluZykpOwogICAgICB9CiAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgdHlwZW9mIHN0cmluZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nOwogICAgICB9CiAgICAgIHZhciBidWYgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogICAgICByZXR1cm4gYnVmLnRvU3RyaW5nKCdiYXNlNjQnKTsKICAgIH0sCgogICAgZGVjb2RlOiBmdW5jdGlvbiBkZWNvZGU2NChzdHJpbmcpIHsKICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBiYXNlNjQgZGVjb2RlIG51bWJlciAnICsgc3RyaW5nKSk7CiAgICAgIH0KICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgIH0KICAgICAgcmV0dXJuIHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZywgJ2Jhc2U2NCcpOwogICAgfQoKICB9LAoKICBidWZmZXI6IHsKICAgIC8qKgogICAgICogQnVmZmVyIGNvbnN0cnVjdG9yIGZvciBOb2RlIGJ1ZmZlciBhbmQgYnVmZmVyIHBvbGx5ZmlsbAogICAgICovCiAgICB0b0J1ZmZlcjogZnVuY3Rpb24oZGF0YSwgZW5jb2RpbmcpIHsKICAgICAgcmV0dXJuICh0eXBlb2YgdXRpbC5CdWZmZXIuZnJvbSA9PT0gJ2Z1bmN0aW9uJyAmJiB1dGlsLkJ1ZmZlci5mcm9tICE9PSBVaW50OEFycmF5LmZyb20pID8KICAgICAgICB1dGlsLkJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKSA6IG5ldyB1dGlsLkJ1ZmZlcihkYXRhLCBlbmNvZGluZyk7CiAgICB9LAoKICAgIGFsbG9jOiBmdW5jdGlvbihzaXplLCBmaWxsLCBlbmNvZGluZykgewogICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzaXplIHBhc3NlZCB0byBhbGxvYyBtdXN0IGJlIGEgbnVtYmVyLicpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdXRpbC5CdWZmZXIuYWxsb2MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gdXRpbC5CdWZmZXIuYWxsb2Moc2l6ZSwgZmlsbCwgZW5jb2RpbmcpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBidWYgPSBuZXcgdXRpbC5CdWZmZXIoc2l6ZSk7CiAgICAgICAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYnVmLmZpbGwgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGJ1Zi5maWxsKGZpbGwsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBlbmNvZGluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBidWY7CiAgICAgIH0KICAgIH0sCgogICAgdG9TdHJlYW06IGZ1bmN0aW9uIHRvU3RyZWFtKGJ1ZmZlcikgewogICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ1ZmZlcikpIGJ1ZmZlciA9ICB1dGlsLmJ1ZmZlci50b0J1ZmZlcihidWZmZXIpOwoKICAgICAgdmFyIHJlYWRhYmxlID0gbmV3ICh1dGlsLnN0cmVhbS5SZWFkYWJsZSkoKTsKICAgICAgdmFyIHBvcyA9IDA7CiAgICAgIHJlYWRhYmxlLl9yZWFkID0gZnVuY3Rpb24oc2l6ZSkgewogICAgICAgIGlmIChwb3MgPj0gYnVmZmVyLmxlbmd0aCkgcmV0dXJuIHJlYWRhYmxlLnB1c2gobnVsbCk7CgogICAgICAgIHZhciBlbmQgPSBwb3MgKyBzaXplOwogICAgICAgIGlmIChlbmQgPiBidWZmZXIubGVuZ3RoKSBlbmQgPSBidWZmZXIubGVuZ3RoOwogICAgICAgIHJlYWRhYmxlLnB1c2goYnVmZmVyLnNsaWNlKHBvcywgZW5kKSk7CiAgICAgICAgcG9zID0gZW5kOwogICAgICB9OwoKICAgICAgcmV0dXJuIHJlYWRhYmxlOwogICAgfSwKCiAgICAvKioKICAgICAqIENvbmNhdGVuYXRlcyBhIGxpc3Qgb2YgQnVmZmVyIG9iamVjdHMuCiAgICAgKi8KICAgIGNvbmNhdDogZnVuY3Rpb24oYnVmZmVycykgewogICAgICB2YXIgbGVuZ3RoID0gMCwKICAgICAgICAgIG9mZnNldCA9IDAsCiAgICAgICAgICBidWZmZXIgPSBudWxsLCBpOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGJ1ZmZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZW5ndGggKz0gYnVmZmVyc1tpXS5sZW5ndGg7CiAgICAgIH0KCiAgICAgIGJ1ZmZlciA9IHV0aWwuYnVmZmVyLmFsbG9jKGxlbmd0aCk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGJ1ZmZlcnNbaV0uY29weShidWZmZXIsIG9mZnNldCk7CiAgICAgICAgb2Zmc2V0ICs9IGJ1ZmZlcnNbaV0ubGVuZ3RoOwogICAgICB9CgogICAgICByZXR1cm4gYnVmZmVyOwogICAgfQogIH0sCgogIHN0cmluZzogewogICAgYnl0ZUxlbmd0aDogZnVuY3Rpb24gYnl0ZUxlbmd0aChzdHJpbmcpIHsKICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCBzdHJpbmcgPT09IHVuZGVmaW5lZCkgcmV0dXJuIDA7CiAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJykgc3RyaW5nID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKCiAgICAgIGlmICh0eXBlb2Ygc3RyaW5nLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcubGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiBzdHJpbmcubGVuZ3RoOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcuc2l6ZSA9PT0gJ251bWJlcicpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLnNpemU7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5wYXRoID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiByZXF1aXJlKCdmcycpLmxzdGF0U3luYyhzdHJpbmcucGF0aCkuc2l6ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGRldGVybWluZSBsZW5ndGggb2YgJyArIHN0cmluZyksCiAgICAgICAgICB7IG9iamVjdDogc3RyaW5nIH0pOwogICAgICB9CiAgICB9LAoKICAgIHVwcGVyRmlyc3Q6IGZ1bmN0aW9uIHVwcGVyRmlyc3Qoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmdbMF0udG9VcHBlckNhc2UoKSArIHN0cmluZy5zdWJzdHIoMSk7CiAgICB9LAoKICAgIGxvd2VyRmlyc3Q6IGZ1bmN0aW9uIGxvd2VyRmlyc3Qoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmdbMF0udG9Mb3dlckNhc2UoKSArIHN0cmluZy5zdWJzdHIoMSk7CiAgICB9CiAgfSwKCiAgaW5pOiB7CiAgICBwYXJzZTogZnVuY3Rpb24gc3RyaW5nKGluaSkgewogICAgICB2YXIgY3VycmVudFNlY3Rpb24sIG1hcCA9IHt9OwogICAgICB1dGlsLmFycmF5RWFjaChpbmkuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICBsaW5lID0gbGluZS5zcGxpdCgvKF58XHMpWzsjXS8pWzBdLnRyaW0oKTsgLy8gcmVtb3ZlIGNvbW1lbnRzIGFuZCB0cmltCiAgICAgICAgdmFyIGlzU2VjdGlvbiA9IGxpbmVbMF0gPT09ICdbJyAmJiBsaW5lW2xpbmUubGVuZ3RoIC0gMV0gPT09ICddJzsKICAgICAgICBpZiAoaXNTZWN0aW9uKSB7CiAgICAgICAgICBjdXJyZW50U2VjdGlvbiA9IGxpbmUuc3Vic3RyaW5nKDEsIGxpbmUubGVuZ3RoIC0gMSk7CiAgICAgICAgICBpZiAoY3VycmVudFNlY3Rpb24gPT09ICdfX3Byb3RvX18nIHx8IGN1cnJlbnRTZWN0aW9uLnNwbGl0KC9ccy8pWzFdID09PSAnX19wcm90b19fJykgewogICAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKAogICAgICAgICAgICAgIG5ldyBFcnJvcignQ2Fubm90IGxvYWQgcHJvZmlsZSBuYW1lIFwnJyArIGN1cnJlbnRTZWN0aW9uICsgJ1wnIGZyb20gc2hhcmVkIGluaSBmaWxlLicpCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50U2VjdGlvbikgewogICAgICAgICAgdmFyIGluZGV4T2ZFcXVhbHNTaWduID0gbGluZS5pbmRleE9mKCc9Jyk7CiAgICAgICAgICB2YXIgc3RhcnQgPSAwOwogICAgICAgICAgdmFyIGVuZCA9IGxpbmUubGVuZ3RoIC0gMTsKICAgICAgICAgIHZhciBpc0Fzc2lnbm1lbnQgPQogICAgICAgICAgICBpbmRleE9mRXF1YWxzU2lnbiAhPT0gLTEgJiYgaW5kZXhPZkVxdWFsc1NpZ24gIT09IHN0YXJ0ICYmIGluZGV4T2ZFcXVhbHNTaWduICE9PSBlbmQ7CgogICAgICAgICAgaWYgKGlzQXNzaWdubWVudCkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGxpbmUuc3Vic3RyaW5nKDAsIGluZGV4T2ZFcXVhbHNTaWduKS50cmltKCk7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGxpbmUuc3Vic3RyaW5nKGluZGV4T2ZFcXVhbHNTaWduICsgMSkudHJpbSgpOwoKICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXSA9IG1hcFtjdXJyZW50U2VjdGlvbl0gfHwge307CiAgICAgICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl1bbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIG1hcDsKICAgIH0KICB9LAoKICBmbjogewogICAgbm9vcDogZnVuY3Rpb24oKSB7fSwKICAgIGNhbGxiYWNrOiBmdW5jdGlvbiAoZXJyKSB7IGlmIChlcnIpIHRocm93IGVycjsgfSwKCiAgICAvKioKICAgICAqIFR1cm4gYSBzeW5jaHJvbm91cyBmdW5jdGlvbiBpbnRvIGFzICJhc3luYyIgZnVuY3Rpb24gYnkgbWFraW5nIGl0IGNhbGwKICAgICAqIGEgY2FsbGJhY2suIFRoZSB1bmRlcmx5aW5nIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aXRoIGFsbCBidXQgdGhlIGxhc3QgYXJndW1lbnQsCiAgICAgKiB3aGljaCBpcyB0cmVhdGVkIGFzIHRoZSBjYWxsYmFjay4gVGhlIGNhbGxiYWNrIGlzIHBhc3NlZCBwYXNzZWQgYSBmaXJzdCBhcmd1bWVudAogICAgICogb2YgbnVsbCBvbiBzdWNjZXNzIHRvIG1pbWljayBzdGFuZGFyZCBub2RlIGNhbGxiYWNrcy4KICAgICAqLwogICAgbWFrZUFzeW5jOiBmdW5jdGlvbiBtYWtlQXN5bmMoZm4sIGV4cGVjdGVkQXJncykgewogICAgICBpZiAoZXhwZWN0ZWRBcmdzICYmIGV4cGVjdGVkQXJncyA8PSBmbi5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZm47CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJncy5wb3AoKTsKICAgICAgICB2YXIgcmVzdWx0ID0gZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKICAgICAgfTsKICAgIH0KICB9LAoKICAvKioKICAgKiBEYXRlIGFuZCB0aW1lIHV0aWxpdHkgZnVuY3Rpb25zLgogICAqLwogIGRhdGU6IHsKCiAgICAvKioKICAgICAqIEByZXR1cm4gW0RhdGVdIHRoZSBjdXJyZW50IEphdmFTY3JpcHQgZGF0ZSBvYmplY3QuIFNpbmNlIGFsbAogICAgICogICBBV1Mgc2VydmljZXMgcmVseSBvbiB0aGlzIGRhdGUgb2JqZWN0LCB5b3UgY2FuIG92ZXJyaWRlCiAgICAgKiAgIHRoaXMgZnVuY3Rpb24gdG8gcHJvdmlkZSBhIHNwZWNpYWwgdGltZSB2YWx1ZSB0byBBV1Mgc2VydmljZQogICAgICogICByZXF1ZXN0cy4KICAgICAqLwogICAgZ2V0RGF0ZTogZnVuY3Rpb24gZ2V0RGF0ZSgpIHsKICAgICAgaWYgKCFBV1MpIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogICAgICBpZiAoQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCkgeyAvLyB1c2Ugb2Zmc2V0IHdoZW4gbm9uLXplcm8KICAgICAgICByZXR1cm4gbmV3IERhdGUobmV3IERhdGUoKS5nZXRUaW1lKCkgKyBBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIGRhdGUgaW4gSVNPLTg2MDEgZm9ybWF0CiAgICAgKi8KICAgIGlzbzg2MDE6IGZ1bmN0aW9uIGlzbzg2MDEoZGF0ZSkgewogICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgIHJldHVybiBkYXRlLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvXC5cZHszfVokLywgJ1onKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBkYXRlIGluIFJGQyA4MjIgZm9ybWF0CiAgICAgKi8KICAgIHJmYzgyMjogZnVuY3Rpb24gcmZjODIyKGRhdGUpIHsKICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICByZXR1cm4gZGF0ZS50b1VUQ1N0cmluZygpOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4gW0ludGVnZXJdIHRoZSBVTklYIHRpbWVzdGFtcCB2YWx1ZSBmb3IgdGhlIGN1cnJlbnQgdGltZQogICAgICovCiAgICB1bml4VGltZXN0YW1wOiBmdW5jdGlvbiB1bml4VGltZXN0YW1wKGRhdGUpIHsKICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICByZXR1cm4gZGF0ZS5nZXRUaW1lKCkgLyAxMDAwOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSBbU3RyaW5nLG51bWJlcixEYXRlXSBkYXRlCiAgICAgKiBAcmV0dXJuIFtEYXRlXQogICAgICovCiAgICBmcm9tOiBmdW5jdGlvbiBmb3JtYXQoZGF0ZSkgewogICAgICBpZiAodHlwZW9mIGRhdGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUgKiAxMDAwKTsgLy8gdW5peCB0aW1lc3RhbXAKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBHaXZlbiBhIERhdGUgb3IgZGF0ZS1saWtlIHZhbHVlLCB0aGlzIGZ1bmN0aW9uIGZvcm1hdHMgdGhlCiAgICAgKiBkYXRlIGludG8gYSBzdHJpbmcgb2YgdGhlIHJlcXVlc3RlZCB2YWx1ZS4KICAgICAqIEBwYXJhbSBbU3RyaW5nLG51bWJlcixEYXRlXSBkYXRlCiAgICAgKiBAcGFyYW0gW1N0cmluZ10gZm9ybWF0dGVyIFZhbGlkIGZvcm1hdHMgYXJlOgogICAgICMgICAqICdpc284NjAxJwogICAgICMgICAqICdyZmM4MjInCiAgICAgIyAgICogJ3VuaXhUaW1lc3RhbXAnCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgKi8KICAgIGZvcm1hdDogZnVuY3Rpb24gZm9ybWF0KGRhdGUsIGZvcm1hdHRlcikgewogICAgICBpZiAoIWZvcm1hdHRlcikgZm9ybWF0dGVyID0gJ2lzbzg2MDEnOwogICAgICByZXR1cm4gdXRpbC5kYXRlW2Zvcm1hdHRlcl0odXRpbC5kYXRlLmZyb20oZGF0ZSkpOwogICAgfSwKCiAgICBwYXJzZVRpbWVzdGFtcDogZnVuY3Rpb24gcGFyc2VUaW1lc3RhbXAodmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHsgLy8gdW5peCB0aW1lc3RhbXAgKG51bWJlcikKICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlxkKyQvKSkgeyAvLyB1bml4IHRpbWVzdGFtcAogICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSAqIDEwMDApOwogICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGR7NH0vKSkgeyAvLyBpc284NjAxCiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlKTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlx3ezN9LC8pKSB7IC8vIHJmYzgyMgogICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcigKICAgICAgICAgIG5ldyBFcnJvcigndW5oYW5kbGVkIHRpbWVzdGFtcCBmb3JtYXQ6ICcgKyB2YWx1ZSksCiAgICAgICAgICB7Y29kZTogJ1RpbWVzdGFtcFBhcnNlckVycm9yJ30pOwogICAgICB9CiAgICB9CgogIH0sCgogIGNyeXB0bzogewogICAgY3JjMzJUYWJsZTogWwogICAgIDB4MDAwMDAwMDAsIDB4NzcwNzMwOTYsIDB4RUUwRTYxMkMsIDB4OTkwOTUxQkEsIDB4MDc2REM0MTksCiAgICAgMHg3MDZBRjQ4RiwgMHhFOTYzQTUzNSwgMHg5RTY0OTVBMywgMHgwRURCODgzMiwgMHg3OURDQjhBNCwKICAgICAweEUwRDVFOTFFLCAweDk3RDJEOTg4LCAweDA5QjY0QzJCLCAweDdFQjE3Q0JELCAweEU3QjgyRDA3LAogICAgIDB4OTBCRjFEOTEsIDB4MURCNzEwNjQsIDB4NkFCMDIwRjIsIDB4RjNCOTcxNDgsIDB4ODRCRTQxREUsCiAgICAgMHgxQURBRDQ3RCwgMHg2RERERTRFQiwgMHhGNEQ0QjU1MSwgMHg4M0QzODVDNywgMHgxMzZDOTg1NiwKICAgICAweDY0NkJBOEMwLCAweEZENjJGOTdBLCAweDhBNjVDOUVDLCAweDE0MDE1QzRGLCAweDYzMDY2Q0Q5LAogICAgIDB4RkEwRjNENjMsIDB4OEQwODBERjUsIDB4M0I2RTIwQzgsIDB4NEM2OTEwNUUsIDB4RDU2MDQxRTQsCiAgICAgMHhBMjY3NzE3MiwgMHgzQzAzRTREMSwgMHg0QjA0RDQ0NywgMHhEMjBEODVGRCwgMHhBNTBBQjU2QiwKICAgICAweDM1QjVBOEZBLCAweDQyQjI5ODZDLCAweERCQkJDOUQ2LCAweEFDQkNGOTQwLCAweDMyRDg2Q0UzLAogICAgIDB4NDVERjVDNzUsIDB4RENENjBEQ0YsIDB4QUJEMTNENTksIDB4MjZEOTMwQUMsIDB4NTFERTAwM0EsCiAgICAgMHhDOEQ3NTE4MCwgMHhCRkQwNjExNiwgMHgyMUI0RjRCNSwgMHg1NkIzQzQyMywgMHhDRkJBOTU5OSwKICAgICAweEI4QkRBNTBGLCAweDI4MDJCODlFLCAweDVGMDU4ODA4LCAweEM2MENEOUIyLCAweEIxMEJFOTI0LAogICAgIDB4MkY2RjdDODcsIDB4NTg2ODRDMTEsIDB4QzE2MTFEQUIsIDB4QjY2NjJEM0QsIDB4NzZEQzQxOTAsCiAgICAgMHgwMURCNzEwNiwgMHg5OEQyMjBCQywgMHhFRkQ1MTAyQSwgMHg3MUIxODU4OSwgMHgwNkI2QjUxRiwKICAgICAweDlGQkZFNEE1LCAweEU4QjhENDMzLCAweDc4MDdDOUEyLCAweDBGMDBGOTM0LCAweDk2MDlBODhFLAogICAgIDB4RTEwRTk4MTgsIDB4N0Y2QTBEQkIsIDB4MDg2RDNEMkQsIDB4OTE2NDZDOTcsIDB4RTY2MzVDMDEsCiAgICAgMHg2QjZCNTFGNCwgMHgxQzZDNjE2MiwgMHg4NTY1MzBEOCwgMHhGMjYyMDA0RSwgMHg2QzA2OTVFRCwKICAgICAweDFCMDFBNTdCLCAweDgyMDhGNEMxLCAweEY1MEZDNDU3LCAweDY1QjBEOUM2LCAweDEyQjdFOTUwLAogICAgIDB4OEJCRUI4RUEsIDB4RkNCOTg4N0MsIDB4NjJERDFEREYsIDB4MTVEQTJENDksIDB4OENEMzdDRjMsCiAgICAgMHhGQkQ0NEM2NSwgMHg0REIyNjE1OCwgMHgzQUI1NTFDRSwgMHhBM0JDMDA3NCwgMHhENEJCMzBFMiwKICAgICAweDRBREZBNTQxLCAweDNERDg5NUQ3LCAweEE0RDFDNDZELCAweEQzRDZGNEZCLCAweDQzNjlFOTZBLAogICAgIDB4MzQ2RUQ5RkMsIDB4QUQ2Nzg4NDYsIDB4REE2MEI4RDAsIDB4NDQwNDJENzMsIDB4MzMwMzFERTUsCiAgICAgMHhBQTBBNEM1RiwgMHhERDBEN0NDOSwgMHg1MDA1NzEzQywgMHgyNzAyNDFBQSwgMHhCRTBCMTAxMCwKICAgICAweEM5MEMyMDg2LCAweDU3NjhCNTI1LCAweDIwNkY4NUIzLCAweEI5NjZENDA5LCAweENFNjFFNDlGLAogICAgIDB4NUVERUY5MEUsIDB4MjlEOUM5OTgsIDB4QjBEMDk4MjIsIDB4QzdEN0E4QjQsIDB4NTlCMzNEMTcsCiAgICAgMHgyRUI0MEQ4MSwgMHhCN0JENUMzQiwgMHhDMEJBNkNBRCwgMHhFREI4ODMyMCwgMHg5QUJGQjNCNiwKICAgICAweDAzQjZFMjBDLCAweDc0QjFEMjlBLCAweEVBRDU0NzM5LCAweDlERDI3N0FGLCAweDA0REIyNjE1LAogICAgIDB4NzNEQzE2ODMsIDB4RTM2MzBCMTIsIDB4OTQ2NDNCODQsIDB4MEQ2RDZBM0UsIDB4N0E2QTVBQTgsCiAgICAgMHhFNDBFQ0YwQiwgMHg5MzA5RkY5RCwgMHgwQTAwQUUyNywgMHg3RDA3OUVCMSwgMHhGMDBGOTM0NCwKICAgICAweDg3MDhBM0QyLCAweDFFMDFGMjY4LCAweDY5MDZDMkZFLCAweEY3NjI1NzVELCAweDgwNjU2N0NCLAogICAgIDB4MTk2QzM2NzEsIDB4NkU2QjA2RTcsIDB4RkVENDFCNzYsIDB4ODlEMzJCRTAsIDB4MTBEQTdBNUEsCiAgICAgMHg2N0RENEFDQywgMHhGOUI5REY2RiwgMHg4RUJFRUZGOSwgMHgxN0I3QkU0MywgMHg2MEIwOEVENSwKICAgICAweEQ2RDZBM0U4LCAweEExRDE5MzdFLCAweDM4RDhDMkM0LCAweDRGREZGMjUyLCAweEQxQkI2N0YxLAogICAgIDB4QTZCQzU3NjcsIDB4M0ZCNTA2REQsIDB4NDhCMjM2NEIsIDB4RDgwRDJCREEsIDB4QUYwQTFCNEMsCiAgICAgMHgzNjAzNEFGNiwgMHg0MTA0N0E2MCwgMHhERjYwRUZDMywgMHhBODY3REY1NSwgMHgzMTZFOEVFRiwKICAgICAweDQ2NjlCRTc5LCAweENCNjFCMzhDLCAweEJDNjY4MzFBLCAweDI1NkZEMkEwLCAweDUyNjhFMjM2LAogICAgIDB4Q0MwQzc3OTUsIDB4QkIwQjQ3MDMsIDB4MjIwMjE2QjksIDB4NTUwNTI2MkYsIDB4QzVCQTNCQkUsCiAgICAgMHhCMkJEMEIyOCwgMHgyQkI0NUE5MiwgMHg1Q0IzNkEwNCwgMHhDMkQ3RkZBNywgMHhCNUQwQ0YzMSwKICAgICAweDJDRDk5RThCLCAweDVCREVBRTFELCAweDlCNjRDMkIwLCAweEVDNjNGMjI2LCAweDc1NkFBMzlDLAogICAgIDB4MDI2RDkzMEEsIDB4OUMwOTA2QTksIDB4RUIwRTM2M0YsIDB4NzIwNzY3ODUsIDB4MDUwMDU3MTMsCiAgICAgMHg5NUJGNEE4MiwgMHhFMkI4N0ExNCwgMHg3QkIxMkJBRSwgMHgwQ0I2MUIzOCwgMHg5MkQyOEU5QiwKICAgICAweEU1RDVCRTBELCAweDdDRENFRkI3LCAweDBCREJERjIxLCAweDg2RDNEMkQ0LCAweEYxRDRFMjQyLAogICAgIDB4NjhEREIzRjgsIDB4MUZEQTgzNkUsIDB4ODFCRTE2Q0QsIDB4RjZCOTI2NUIsIDB4NkZCMDc3RTEsCiAgICAgMHgxOEI3NDc3NywgMHg4ODA4NUFFNiwgMHhGRjBGNkE3MCwgMHg2NjA2M0JDQSwgMHgxMTAxMEI1QywKICAgICAweDhGNjU5RUZGLCAweEY4NjJBRTY5LCAweDYxNkJGRkQzLCAweDE2NkNDRjQ1LCAweEEwMEFFMjc4LAogICAgIDB4RDcwREQyRUUsIDB4NEUwNDgzNTQsIDB4MzkwM0IzQzIsIDB4QTc2NzI2NjEsIDB4RDA2MDE2RjcsCiAgICAgMHg0OTY5NDc0RCwgMHgzRTZFNzdEQiwgMHhBRUQxNkE0QSwgMHhEOUQ2NUFEQywgMHg0MERGMEI2NiwKICAgICAweDM3RDgzQkYwLCAweEE5QkNBRTUzLCAweERFQkI5RUM1LCAweDQ3QjJDRjdGLCAweDMwQjVGRkU5LAogICAgIDB4QkRCREYyMUMsIDB4Q0FCQUMyOEEsIDB4NTNCMzkzMzAsIDB4MjRCNEEzQTYsIDB4QkFEMDM2MDUsCiAgICAgMHhDREQ3MDY5MywgMHg1NERFNTcyOSwgMHgyM0Q5NjdCRiwgMHhCMzY2N0EyRSwgMHhDNDYxNEFCOCwKICAgICAweDVENjgxQjAyLCAweDJBNkYyQjk0LCAweEI0MEJCRTM3LCAweEMzMEM4RUExLCAweDVBMDVERjFCLAogICAgIDB4MkQwMkVGOERdLAoKICAgIGNyYzMyOiBmdW5jdGlvbiBjcmMzMihkYXRhKSB7CiAgICAgIHZhciB0YmwgPSB1dGlsLmNyeXB0by5jcmMzMlRhYmxlOwogICAgICB2YXIgY3JjID0gMCBeIC0xOwoKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgIGRhdGEgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihkYXRhKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGNvZGUgPSBkYXRhLnJlYWRVSW50OChpKTsKICAgICAgICBjcmMgPSAoY3JjID4+PiA4KSBeIHRibFsoY3JjIF4gY29kZSkgJiAweEZGXTsKICAgICAgfQogICAgICByZXR1cm4gKGNyYyBeIC0xKSA+Pj4gMDsKICAgIH0sCgogICAgaG1hYzogZnVuY3Rpb24gaG1hYyhrZXksIHN0cmluZywgZGlnZXN0LCBmbikgewogICAgICBpZiAoIWRpZ2VzdCkgZGlnZXN0ID0gJ2JpbmFyeSc7CiAgICAgIGlmIChkaWdlc3QgPT09ICdidWZmZXInKSB7IGRpZ2VzdCA9IHVuZGVmaW5lZDsgfQogICAgICBpZiAoIWZuKSBmbiA9ICdzaGEyNTYnOwogICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHN0cmluZyA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgIHJldHVybiB1dGlsLmNyeXB0by5saWIuY3JlYXRlSG1hYyhmbiwga2V5KS51cGRhdGUoc3RyaW5nKS5kaWdlc3QoZGlnZXN0KTsKICAgIH0sCgogICAgbWQ1OiBmdW5jdGlvbiBtZDUoZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdXRpbC5jcnlwdG8uaGFzaCgnbWQ1JywgZGF0YSwgZGlnZXN0LCBjYWxsYmFjayk7CiAgICB9LAoKICAgIHNoYTI1NjogZnVuY3Rpb24gc2hhMjU2KGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ3NoYTI1NicsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgfSwKCiAgICBoYXNoOiBmdW5jdGlvbihhbGdvcml0aG0sIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgdmFyIGhhc2ggPSB1dGlsLmNyeXB0by5jcmVhdGVIYXNoKGFsZ29yaXRobSk7CiAgICAgIGlmICghZGlnZXN0KSB7IGRpZ2VzdCA9ICdiaW5hcnknOyB9CiAgICAgIGlmIChkaWdlc3QgPT09ICdidWZmZXInKSB7IGRpZ2VzdCA9IHVuZGVmaW5lZDsgfQogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gdXRpbC5idWZmZXIudG9CdWZmZXIoZGF0YSk7CiAgICAgIHZhciBzbGljZUZuID0gdXRpbC5hcnJheVNsaWNlRm4oZGF0YSk7CiAgICAgIHZhciBpc0J1ZmZlciA9IHV0aWwuQnVmZmVyLmlzQnVmZmVyKGRhdGEpOwogICAgICAvL0lkZW50aWZ5aW5nIG9iamVjdHMgd2l0aCBhbiBBcnJheUJ1ZmZlciBhcyBidWZmZXJzCiAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgZGF0YSAmJiBkYXRhLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSBpc0J1ZmZlciA9IHRydWU7CgogICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmCiAgICAgICAgICB0eXBlb2YgZGF0YS5vbiA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNCdWZmZXIpIHsKICAgICAgICBkYXRhLm9uKCdkYXRhJywgZnVuY3Rpb24oY2h1bmspIHsgaGFzaC51cGRhdGUoY2h1bmspOyB9KTsKICAgICAgICBkYXRhLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgeyBjYWxsYmFjayhlcnIpOyB9KTsKICAgICAgICBkYXRhLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsgY2FsbGJhY2sobnVsbCwgaGFzaC5kaWdlc3QoZGlnZXN0KSk7IH0pOwogICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrICYmIHNsaWNlRm4gJiYgIWlzQnVmZmVyICYmCiAgICAgICAgICAgICAgICAgdHlwZW9mIEZpbGVSZWFkZXIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgLy8gdGhpcyBtaWdodCBiZSBhIEZpbGUvQmxvYgogICAgICAgIHZhciBpbmRleCA9IDAsIHNpemUgPSAxMDI0ICogNTEyOwogICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgICAgIHJlYWRlci5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZWFkIGRhdGEuJykpOwogICAgICAgIH07CiAgICAgICAgcmVhZGVyLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGJ1ZiA9IG5ldyB1dGlsLkJ1ZmZlcihuZXcgVWludDhBcnJheShyZWFkZXIucmVzdWx0KSk7CiAgICAgICAgICBoYXNoLnVwZGF0ZShidWYpOwogICAgICAgICAgaW5kZXggKz0gYnVmLmxlbmd0aDsKICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nKCk7CiAgICAgICAgfTsKICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGluZGV4ID49IGRhdGEuc2l6ZSkgewogICAgICAgICAgICBjYWxsYmFjayhudWxsLCBoYXNoLmRpZ2VzdChkaWdlc3QpKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBiYWNrID0gaW5kZXggKyBzaXplOwogICAgICAgICAgaWYgKGJhY2sgPiBkYXRhLnNpemUpIGJhY2sgPSBkYXRhLnNpemU7CiAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoc2xpY2VGbi5jYWxsKGRhdGEsIGluZGV4LCBiYWNrKSk7CiAgICAgICAgfTsKCiAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgICBkYXRhID0gbmV3IHV0aWwuQnVmZmVyKG5ldyBVaW50OEFycmF5KGRhdGEpKTsKICAgICAgICB9CiAgICAgICAgdmFyIG91dCA9IGhhc2gudXBkYXRlKGRhdGEpLmRpZ2VzdChkaWdlc3QpOwogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sobnVsbCwgb3V0KTsKICAgICAgICByZXR1cm4gb3V0OwogICAgICB9CiAgICB9LAoKICAgIHRvSGV4OiBmdW5jdGlvbiB0b0hleChkYXRhKSB7CiAgICAgIHZhciBvdXQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb3V0LnB1c2goKCcwJyArIGRhdGEuY2hhckNvZGVBdChpKS50b1N0cmluZygxNikpLnN1YnN0cigtMiwgMikpOwogICAgICB9CiAgICAgIHJldHVybiBvdXQuam9pbignJyk7CiAgICB9LAoKICAgIGNyZWF0ZUhhc2g6IGZ1bmN0aW9uIGNyZWF0ZUhhc2goYWxnb3JpdGhtKSB7CiAgICAgIHJldHVybiB1dGlsLmNyeXB0by5saWIuY3JlYXRlSGFzaChhbGdvcml0aG0pOwogICAgfQoKICB9LAoKICAvKiogQCFpZ25vcmUgKi8KCiAgLyogQWJvcnQgY29uc3RhbnQgKi8KICBhYm9ydDoge30sCgogIGVhY2g6IGZ1bmN0aW9uIGVhY2gob2JqZWN0LCBpdGVyRnVuY3Rpb24pIHsKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHsKICAgICAgICB2YXIgcmV0ID0gaXRlckZ1bmN0aW9uLmNhbGwodGhpcywga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgICAgaWYgKHJldCA9PT0gdXRpbC5hYm9ydCkgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9LAoKICBhcnJheUVhY2g6IGZ1bmN0aW9uIGFycmF5RWFjaChhcnJheSwgaXRlckZ1bmN0aW9uKSB7CiAgICBmb3IgKHZhciBpZHggaW4gYXJyYXkpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChhcnJheSwgaWR4KSkgewogICAgICAgIHZhciByZXQgPSBpdGVyRnVuY3Rpb24uY2FsbCh0aGlzLCBhcnJheVtpZHhdLCBwYXJzZUludChpZHgsIDEwKSk7CiAgICAgICAgaWYgKHJldCA9PT0gdXRpbC5hYm9ydCkgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9LAoKICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvYmoxLCBvYmoyKSB7CiAgICB1dGlsLmVhY2gob2JqMiwgZnVuY3Rpb24gaXRlcmF0b3Ioa2V5LCBpdGVtKSB7CiAgICAgIG9iajFba2V5XSA9IGl0ZW07CiAgICB9KTsKICAgIHJldHVybiBvYmoxOwogIH0sCgogIG1lcmdlOiBmdW5jdGlvbiBtZXJnZShvYmoxLCBvYmoyKSB7CiAgICByZXR1cm4gdXRpbC51cGRhdGUodXRpbC5jb3B5KG9iajEpLCBvYmoyKTsKICB9LAoKICBjb3B5OiBmdW5jdGlvbiBjb3B5KG9iamVjdCkgewogICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCBvYmplY3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG9iamVjdDsKICAgIHZhciBkdXBlID0ge307CiAgICAvLyBqc2hpbnQgZm9yaW46ZmFsc2UKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgZHVwZVtrZXldID0gb2JqZWN0W2tleV07CiAgICB9CiAgICByZXR1cm4gZHVwZTsKICB9LAoKICBpc0VtcHR5OiBmdW5jdGlvbiBpc0VtcHR5KG9iaikgewogICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBhcnJheVNsaWNlRm46IGZ1bmN0aW9uIGFycmF5U2xpY2VGbihvYmopIHsKICAgIHZhciBmbiA9IG9iai5zbGljZSB8fCBvYmoud2Via2l0U2xpY2UgfHwgb2JqLm1velNsaWNlOwogICAgcmV0dXJuIHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJyA/IGZuIDogbnVsbDsKICB9LAoKICBpc1R5cGU6IGZ1bmN0aW9uIGlzVHlwZShvYmosIHR5cGUpIHsKICAgIC8vIGhhbmRsZSBjcm9zcy0iZnJhbWUiIG9iamVjdHMKICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJykgdHlwZSA9IHV0aWwudHlwZU5hbWUodHlwZSk7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyB0eXBlICsgJ10nOwogIH0sCgogIHR5cGVOYW1lOiBmdW5jdGlvbiB0eXBlTmFtZSh0eXBlKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHR5cGUsICduYW1lJykpIHJldHVybiB0eXBlLm5hbWU7CiAgICB2YXIgc3RyID0gdHlwZS50b1N0cmluZygpOwogICAgdmFyIG1hdGNoID0gc3RyLm1hdGNoKC9eXHMqZnVuY3Rpb24gKC4rKVwoLyk7CiAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IHN0cjsKICB9LAoKICBlcnJvcjogZnVuY3Rpb24gZXJyb3IoZXJyLCBvcHRpb25zKSB7CiAgICB2YXIgb3JpZ2luYWxFcnJvciA9IG51bGw7CiAgICBpZiAodHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJyAmJiBlcnIubWVzc2FnZSAhPT0gJycpIHsKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJyB8fCAob3B0aW9ucyAmJiBvcHRpb25zLm1lc3NhZ2UpKSB7CiAgICAgICAgb3JpZ2luYWxFcnJvciA9IHV0aWwuY29weShlcnIpOwogICAgICAgIG9yaWdpbmFsRXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICB9CiAgICB9CiAgICBlcnIubWVzc2FnZSA9IGVyci5tZXNzYWdlIHx8IG51bGw7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnM7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JyAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgIHV0aWwudXBkYXRlKGVyciwgb3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UpCiAgICAgICAgZXJyLm1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2U7CiAgICAgIGlmIChvcHRpb25zLmNvZGUgfHwgb3B0aW9ucy5uYW1lKQogICAgICAgIGVyci5jb2RlID0gb3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZTsKICAgICAgaWYgKG9wdGlvbnMuc3RhY2spCiAgICAgICAgZXJyLnN0YWNrID0gb3B0aW9ucy5zdGFjazsKICAgIH0KCiAgICBpZiAodHlwZW9mIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbmFtZScsIHt3cml0YWJsZTogdHJ1ZSwgZW51bWVyYWJsZTogZmFsc2V9KTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVyciwgJ21lc3NhZ2UnLCB7ZW51bWVyYWJsZTogdHJ1ZX0pOwogICAgfQoKICAgIGVyci5uYW1lID0gU3RyaW5nKG9wdGlvbnMgJiYgb3B0aW9ucy5uYW1lIHx8IGVyci5uYW1lIHx8IGVyci5jb2RlIHx8ICdFcnJvcicpOwogICAgZXJyLnRpbWUgPSBuZXcgRGF0ZSgpOwoKICAgIGlmIChvcmlnaW5hbEVycm9yKSBlcnIub3JpZ2luYWxFcnJvciA9IG9yaWdpbmFsRXJyb3I7CgogICAgcmV0dXJuIGVycjsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpbmhlcml0OiBmdW5jdGlvbiBpbmhlcml0KGtsYXNzLCBmZWF0dXJlcykgewogICAgdmFyIG5ld09iamVjdCA9IG51bGw7CiAgICBpZiAoZmVhdHVyZXMgPT09IHVuZGVmaW5lZCkgewogICAgICBmZWF0dXJlcyA9IGtsYXNzOwogICAgICBrbGFzcyA9IE9iamVjdDsKICAgICAgbmV3T2JqZWN0ID0ge307CiAgICB9IGVsc2UgewogICAgICB2YXIgY3RvciA9IGZ1bmN0aW9uIENvbnN0cnVjdG9yV3JhcHBlcigpIHt9OwogICAgICBjdG9yLnByb3RvdHlwZSA9IGtsYXNzLnByb3RvdHlwZTsKICAgICAgbmV3T2JqZWN0ID0gbmV3IGN0b3IoKTsKICAgIH0KCiAgICAvLyBjb25zdHJ1Y3RvciBub3Qgc3VwcGxpZWQsIGNyZWF0ZSBwYXNzLXRocm91Z2ggY3RvcgogICAgaWYgKGZlYXR1cmVzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgZmVhdHVyZXMuY29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoa2xhc3MgIT09IE9iamVjdCkgewogICAgICAgICAgcmV0dXJuIGtsYXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIGZlYXR1cmVzLmNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IG5ld09iamVjdDsKICAgIHV0aWwudXBkYXRlKGZlYXR1cmVzLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgZmVhdHVyZXMpOwogICAgZmVhdHVyZXMuY29uc3RydWN0b3IuX19zdXBlcl9fID0ga2xhc3M7CiAgICByZXR1cm4gZmVhdHVyZXMuY29uc3RydWN0b3I7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbWl4aW46IGZ1bmN0aW9uIG1peGluKCkgewogICAgdmFyIGtsYXNzID0gYXJndW1lbnRzWzBdOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgLy8ganNoaW50IGZvcmluOmZhbHNlCiAgICAgIGZvciAodmFyIHByb3AgaW4gYXJndW1lbnRzW2ldLnByb3RvdHlwZSkgewogICAgICAgIHZhciBmbiA9IGFyZ3VtZW50c1tpXS5wcm90b3R5cGVbcHJvcF07CiAgICAgICAgaWYgKHByb3AgIT09ICdjb25zdHJ1Y3RvcicpIHsKICAgICAgICAgIGtsYXNzLnByb3RvdHlwZVtwcm9wXSA9IGZuOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGtsYXNzOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGhpZGVQcm9wZXJ0aWVzOiBmdW5jdGlvbiBoaWRlUHJvcGVydGllcyhvYmosIHByb3BzKSB7CiAgICBpZiAodHlwZW9mIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSAhPT0gJ2Z1bmN0aW9uJykgcmV0dXJuOwoKICAgIHV0aWwuYXJyYXlFYWNoKHByb3BzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgewogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0pOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgcHJvcGVydHk6IGZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUsIGVudW1lcmFibGUsIGlzVmFsdWUpIHsKICAgIHZhciBvcHRzID0gewogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGVudW1lcmFibGU6IGVudW1lcmFibGUgIT09IHVuZGVmaW5lZCA/IGVudW1lcmFibGUgOiB0cnVlCiAgICB9OwogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNWYWx1ZSkgewogICAgICBvcHRzLmdldCA9IHZhbHVlOwogICAgfQogICAgZWxzZSB7CiAgICAgIG9wdHMudmFsdWUgPSB2YWx1ZTsgb3B0cy53cml0YWJsZSA9IHRydWU7CiAgICB9CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgbmFtZSwgb3B0cyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbWVtb2l6ZWRQcm9wZXJ0eTogZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUsIGdldCwgZW51bWVyYWJsZSkgewogICAgdmFyIGNhY2hlZFZhbHVlID0gbnVsbDsKCiAgICAvLyBidWlsZCBlbnVtZXJhYmxlIGF0dHJpYnV0ZSBmb3IgZWFjaCB2YWx1ZSB3aXRoIGxhenkgYWNjZXNzb3IuCiAgICB1dGlsLnByb3BlcnR5KG9iaiwgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChjYWNoZWRWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgIGNhY2hlZFZhbHVlID0gZ2V0KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNhY2hlZFZhbHVlOwogICAgfSwgZW51bWVyYWJsZSk7CiAgfSwKCiAgLyoqCiAgICogVE9ETyBSZW1vdmUgaW4gbWFqb3IgdmVyc2lvbiByZXZpc2lvbgogICAqIFRoaXMgYmFja2ZpbGwgcG9wdWxhdGVzIHJlc3BvbnNlIGRhdGEgd2l0aG91dCB0aGUKICAgKiB0b3AtbGV2ZWwgcGF5bG9hZCBuYW1lLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaG9pc3RQYXlsb2FkTWVtYmVyOiBmdW5jdGlvbiBob2lzdFBheWxvYWRNZW1iZXIocmVzcCkgewogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVxLm9wZXJhdGlvbjsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogICAgaWYgKG91dHB1dC5wYXlsb2FkICYmICFvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBvdXRwdXQubWVtYmVyc1tvdXRwdXQucGF5bG9hZF07CiAgICAgIHZhciByZXNwb25zZVBheWxvYWQgPSByZXNwLmRhdGFbb3V0cHV0LnBheWxvYWRdOwogICAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHV0aWwuZWFjaChyZXNwb25zZVBheWxvYWQsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgIHV0aWwucHJvcGVydHkocmVzcC5kYXRhLCBrZXksIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9LAoKICAvKioKICAgKiBDb21wdXRlIFNIQS0yNTYgY2hlY2tzdW1zIG9mIHN0cmVhbXMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNvbXB1dGVTaGEyNTY6IGZ1bmN0aW9uIGNvbXB1dGVTaGEyNTYoYm9keSwgZG9uZSkgewogICAgaWYgKHV0aWwuaXNOb2RlKCkpIHsKICAgICAgdmFyIFN0cmVhbSA9IHV0aWwuc3RyZWFtLlN0cmVhbTsKICAgICAgdmFyIGZzID0gcmVxdWlyZSgnZnMnKTsKICAgICAgaWYgKHR5cGVvZiBTdHJlYW0gPT09ICdmdW5jdGlvbicgJiYgYm9keSBpbnN0YW5jZW9mIFN0cmVhbSkgewogICAgICAgIGlmICh0eXBlb2YgYm9keS5wYXRoID09PSAnc3RyaW5nJykgeyAvLyBhc3N1bWUgZmlsZSBvYmplY3QKICAgICAgICAgIHZhciBzZXR0aW5ncyA9IHt9OwogICAgICAgICAgaWYgKHR5cGVvZiBib2R5LnN0YXJ0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICBzZXR0aW5ncy5zdGFydCA9IGJvZHkuc3RhcnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGJvZHkuZW5kID09PSAnbnVtYmVyJykgewogICAgICAgICAgICBzZXR0aW5ncy5lbmQgPSBib2R5LmVuZDsKICAgICAgICAgIH0KICAgICAgICAgIGJvZHkgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGJvZHkucGF0aCwgc2V0dGluZ3MpOwogICAgICAgIH0gZWxzZSB7IC8vIFRPRE8gc3VwcG9ydCBvdGhlciBzdHJlYW0gdHlwZXMKICAgICAgICAgIHJldHVybiBkb25lKG5ldyBFcnJvcignTm9uLWZpbGUgc3RyZWFtIG9iamVjdHMgYXJlICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdub3Qgc3VwcG9ydGVkIHdpdGggU2lnVjQnKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdXRpbC5jcnlwdG8uc2hhMjU2KGJvZHksICdoZXgnLCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICBpZiAoZXJyKSBkb25lKGVycik7CiAgICAgIGVsc2UgZG9uZShudWxsLCBzaGEpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaXNDbG9ja1NrZXdlZDogZnVuY3Rpb24gaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSB7CiAgICBpZiAoc2VydmVyVGltZSkgewogICAgICB1dGlsLnByb3BlcnR5KEFXUy5jb25maWcsICdpc0Nsb2NrU2tld2VkJywKICAgICAgICBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHNlcnZlclRpbWUpID49IDMwMDAwMCwgZmFsc2UpOwogICAgICByZXR1cm4gQVdTLmNvbmZpZy5pc0Nsb2NrU2tld2VkOwogICAgfQogIH0sCgogIGFwcGx5Q2xvY2tPZmZzZXQ6IGZ1bmN0aW9uIGFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSkgewogICAgaWYgKHNlcnZlclRpbWUpCiAgICAgIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBzZXJ2ZXJUaW1lIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZXh0cmFjdFJlcXVlc3RJZDogZnVuY3Rpb24gZXh0cmFjdFJlcXVlc3RJZChyZXNwKSB7CiAgICB2YXIgcmVxdWVzdElkID0gcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddIHx8CiAgICAgICAgICAgICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKCiAgICBpZiAoIXJlcXVlc3RJZCAmJiByZXNwLmRhdGEgJiYgcmVzcC5kYXRhLlJlc3BvbnNlTWV0YWRhdGEpIHsKICAgICAgcmVxdWVzdElkID0gcmVzcC5kYXRhLlJlc3BvbnNlTWV0YWRhdGEuUmVxdWVzdElkOwogICAgfQoKICAgIGlmIChyZXF1ZXN0SWQpIHsKICAgICAgcmVzcC5yZXF1ZXN0SWQgPSByZXF1ZXN0SWQ7CiAgICB9CgogICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgcmVzcC5lcnJvci5yZXF1ZXN0SWQgPSByZXF1ZXN0SWQ7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYWRkUHJvbWlzZXM6IGZ1bmN0aW9uIGFkZFByb21pc2VzKGNvbnN0cnVjdG9ycywgUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHZhciBkZWxldGVQcm9taXNlcyA9IGZhbHNlOwogICAgaWYgKFByb21pc2VEZXBlbmRlbmN5ID09PSB1bmRlZmluZWQgJiYgQVdTICYmIEFXUy5jb25maWcpIHsKICAgICAgUHJvbWlzZURlcGVuZGVuY3kgPSBBV1MuY29uZmlnLmdldFByb21pc2VzRGVwZW5kZW5jeSgpOwogICAgfQogICAgaWYgKFByb21pc2VEZXBlbmRlbmN5ID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIFByb21pc2UgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIFByb21pc2VEZXBlbmRlbmN5ID0gUHJvbWlzZTsKICAgIH0KICAgIGlmICh0eXBlb2YgUHJvbWlzZURlcGVuZGVuY3kgIT09ICdmdW5jdGlvbicpIGRlbGV0ZVByb21pc2VzID0gdHJ1ZTsKICAgIGlmICghQXJyYXkuaXNBcnJheShjb25zdHJ1Y3RvcnMpKSBjb25zdHJ1Y3RvcnMgPSBbY29uc3RydWN0b3JzXTsKCiAgICBmb3IgKHZhciBpbmQgPSAwOyBpbmQgPCBjb25zdHJ1Y3RvcnMubGVuZ3RoOyBpbmQrKykgewogICAgICB2YXIgY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcnNbaW5kXTsKICAgICAgaWYgKGRlbGV0ZVByb21pc2VzKSB7CiAgICAgICAgaWYgKGNvbnN0cnVjdG9yLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKSB7CiAgICAgICAgICBjb25zdHJ1Y3Rvci5kZWxldGVQcm9taXNlc0Zyb21DbGFzcygpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChjb25zdHJ1Y3Rvci5hZGRQcm9taXNlc1RvQ2xhc3MpIHsKICAgICAgICBjb25zdHJ1Y3Rvci5hZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpOwogICAgICB9CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogUmV0dXJuIGEgZnVuY3Rpb24gdGhhdCB3aWxsIHJldHVybiBhIHByb21pc2Ugd2hvc2UgZmF0ZSBpcyBkZWNpZGVkIGJ5IHRoZQogICAqIGNhbGxiYWNrIGJlaGF2aW9yIG9mIHRoZSBnaXZlbiBtZXRob2Qgd2l0aCBgbWV0aG9kTmFtZWAuIFRoZSBtZXRob2QgdG8gYmUKICAgKiBwcm9taXNpZmllZCBzaG91bGQgY29uZm9ybSB0byBub2RlLmpzIGNvbnZlbnRpb24gb2YgYWNjZXB0aW5nIGEgY2FsbGJhY2sgYXMKICAgKiBsYXN0IGFyZ3VtZW50IGFuZCBjYWxsaW5nIHRoYXQgY2FsbGJhY2sgd2l0aCBlcnJvciBhcyB0aGUgZmlyc3QgYXJndW1lbnQKICAgKiBhbmQgc3VjY2VzcyB2YWx1ZSBvbiB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAqLwogIHByb21pc2lmeU1ldGhvZDogZnVuY3Rpb24gcHJvbWlzaWZ5TWV0aG9kKG1ldGhvZE5hbWUsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICByZXR1cm4gZnVuY3Rpb24gcHJvbWlzZSgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZURlcGVuZGVuY3koZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgYXJncy5wdXNoKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgc2VsZlttZXRob2ROYW1lXS5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgfSk7CiAgICB9OwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGlzRHVhbHN0YWNrQXZhaWxhYmxlOiBmdW5jdGlvbiBpc0R1YWxzdGFja0F2YWlsYWJsZShzZXJ2aWNlKSB7CiAgICBpZiAoIXNlcnZpY2UpIHJldHVybiBmYWxzZTsKICAgIHZhciBtZXRhZGF0YSA9IHJlcXVpcmUoJy4uL2FwaXMvbWV0YWRhdGEuanNvbicpOwogICAgaWYgKHR5cGVvZiBzZXJ2aWNlICE9PSAnc3RyaW5nJykgc2VydmljZSA9IHNlcnZpY2Uuc2VydmljZUlkZW50aWZpZXI7CiAgICBpZiAodHlwZW9mIHNlcnZpY2UgIT09ICdzdHJpbmcnIHx8ICFtZXRhZGF0YS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlKSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuICEhbWV0YWRhdGFbc2VydmljZV0uZHVhbHN0YWNrQXZhaWxhYmxlOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNhbGN1bGF0ZVJldHJ5RGVsYXk6IGZ1bmN0aW9uIGNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgcmV0cnlEZWxheU9wdGlvbnMsIGVycikgewogICAgaWYgKCFyZXRyeURlbGF5T3B0aW9ucykgcmV0cnlEZWxheU9wdGlvbnMgPSB7fTsKICAgIHZhciBjdXN0b21CYWNrb2ZmID0gcmV0cnlEZWxheU9wdGlvbnMuY3VzdG9tQmFja29mZiB8fCBudWxsOwogICAgaWYgKHR5cGVvZiBjdXN0b21CYWNrb2ZmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBjdXN0b21CYWNrb2ZmKHJldHJ5Q291bnQsIGVycik7CiAgICB9CiAgICB2YXIgYmFzZSA9IHR5cGVvZiByZXRyeURlbGF5T3B0aW9ucy5iYXNlID09PSAnbnVtYmVyJyA/IHJldHJ5RGVsYXlPcHRpb25zLmJhc2UgOiAxMDA7CiAgICB2YXIgZGVsYXkgPSBNYXRoLnJhbmRvbSgpICogKE1hdGgucG93KDIsIHJldHJ5Q291bnQpICogYmFzZSk7CiAgICByZXR1cm4gZGVsYXk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaGFuZGxlUmVxdWVzdFdpdGhSZXRyaWVzOiBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0V2l0aFJldHJpZXMoaHR0cFJlcXVlc3QsIG9wdGlvbnMsIGNiKSB7CiAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgIHZhciBodHRwT3B0aW9ucyA9IG9wdGlvbnMuaHR0cE9wdGlvbnMgfHwge307CiAgICB2YXIgcmV0cnlDb3VudCA9IDA7CgogICAgdmFyIGVyckNhbGxiYWNrID0gZnVuY3Rpb24oZXJyKSB7CiAgICAgIHZhciBtYXhSZXRyaWVzID0gb3B0aW9ucy5tYXhSZXRyaWVzIHx8IDA7CiAgICAgIGlmIChlcnIgJiYgZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InKSBlcnIucmV0cnlhYmxlID0gdHJ1ZTsKCiAgICAgIC8vIENhbGwgYGNhbGN1bGF0ZVJldHJ5RGVsYXkoKWAgb25seSB3aGVuIHJlbGV2YW50LCBzZWUgIzM0MDEKICAgICAgaWYgKGVyciAmJiBlcnIucmV0cnlhYmxlICYmIHJldHJ5Q291bnQgPCBtYXhSZXRyaWVzKSB7CiAgICAgICAgdmFyIGRlbGF5ID0gdXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIG9wdGlvbnMucmV0cnlEZWxheU9wdGlvbnMsIGVycik7CiAgICAgICAgaWYgKGRlbGF5ID49IDApIHsKICAgICAgICAgIHJldHJ5Q291bnQrKzsKICAgICAgICAgIHNldFRpbWVvdXQoc2VuZFJlcXVlc3QsIGRlbGF5ICsgKGVyci5yZXRyeUFmdGVyIHx8IDApKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgICAgY2IoZXJyKTsKICAgIH07CgogICAgdmFyIHNlbmRSZXF1ZXN0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBkYXRhID0gJyc7CiAgICAgIGh0dHAuaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGZ1bmN0aW9uKGh0dHBSZXNwb25zZSkgewogICAgICAgIGh0dHBSZXNwb25zZS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7IGRhdGEgKz0gY2h1bmsudG9TdHJpbmcoKTsgfSk7CiAgICAgICAgaHR0cFJlc3BvbnNlLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBzdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICAgICAgICBjYihudWxsLCBkYXRhKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByZXRyeUFmdGVyID0gcGFyc2VJbnQoaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3JldHJ5LWFmdGVyJ10sIDEwKSAqIDEwMDAgfHwgMDsKICAgICAgICAgICAgdmFyIGVyciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3RhdHVzQ29kZTogc3RhdHVzQ29kZSwKICAgICAgICAgICAgICAgIHJldHJ5YWJsZTogc3RhdHVzQ29kZSA+PSA1MDAgfHwgc3RhdHVzQ29kZSA9PT0gNDI5CiAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAocmV0cnlBZnRlciAmJiBlcnIucmV0cnlhYmxlKSBlcnIucmV0cnlBZnRlciA9IHJldHJ5QWZ0ZXI7CiAgICAgICAgICAgIGVyckNhbGxiYWNrKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIGVyckNhbGxiYWNrKTsKICAgIH07CgogICAgQVdTLnV0aWwuZGVmZXIoc2VuZFJlcXVlc3QpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHV1aWQ6IHsKICAgIHY0OiBmdW5jdGlvbiB1dWlkVjQoKSB7CiAgICAgIHJldHVybiByZXF1aXJlKCd1dWlkJykudjQoKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjb252ZXJ0UGF5bG9hZFRvU3RyaW5nOiBmdW5jdGlvbiBjb252ZXJ0UGF5bG9hZFRvU3RyaW5nKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLm9wZXJhdGlvbjsKICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl0ub3V0cHV0IHx8IHt9OwogICAgaWYgKHJ1bGVzLnBheWxvYWQgJiYgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdKSB7CiAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXS50b1N0cmluZygpOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGRlZmVyOiBmdW5jdGlvbiBkZWZlcihjYWxsYmFjaykgewogICAgaWYgKHR5cGVvZiBwcm9jZXNzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBwcm9jZXNzLm5leHRUaWNrKGNhbGxiYWNrKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHNldEltbWVkaWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBzZXRJbW1lZGlhdGUoY2FsbGJhY2spOwogICAgfSBlbHNlIHsKICAgICAgc2V0VGltZW91dChjYWxsYmFjaywgMCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0UmVxdWVzdFBheWxvYWRTaGFwZTogZnVuY3Rpb24gZ2V0UmVxdWVzdFBheWxvYWRTaGFwZShyZXEpIHsKICAgIHZhciBvcGVyYXRpb25zID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnM7CiAgICBpZiAoIW9wZXJhdGlvbnMpIHJldHVybiB1bmRlZmluZWQ7CiAgICB2YXIgb3BlcmF0aW9uID0gKG9wZXJhdGlvbnMgfHwge30pW3JlcS5vcGVyYXRpb25dOwogICAgaWYgKCFvcGVyYXRpb24gfHwgIW9wZXJhdGlvbi5pbnB1dCB8fCAhb3BlcmF0aW9uLmlucHV0LnBheWxvYWQpIHJldHVybiB1bmRlZmluZWQ7CiAgICByZXR1cm4gb3BlcmF0aW9uLmlucHV0Lm1lbWJlcnNbb3BlcmF0aW9uLmlucHV0LnBheWxvYWRdOwogIH0sCgogIGdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZzogZnVuY3Rpb24gZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnKGluaUxvYWRlciwgZmlsZW5hbWUpIHsKICAgIHZhciBwcm9maWxlcyA9IHt9OwogICAgdmFyIHByb2ZpbGVzRnJvbUNvbmZpZyA9IHt9OwogICAgaWYgKHByb2Nlc3MuZW52W3V0aWwuY29uZmlnT3B0SW5FbnZdKSB7CiAgICAgIHZhciBwcm9maWxlc0Zyb21Db25maWcgPSBpbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgIGlzQ29uZmlnOiB0cnVlLAogICAgICAgIGZpbGVuYW1lOiBwcm9jZXNzLmVudlt1dGlsLnNoYXJlZENvbmZpZ0ZpbGVFbnZdCiAgICAgIH0pOwogICAgfQogICAgdmFyIHByb2ZpbGVzRnJvbUNyZWRzPSB7fTsKICAgIHRyeSB7CiAgICAgIHZhciBwcm9maWxlc0Zyb21DcmVkcyA9IGluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lIHx8CiAgICAgICAgICAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0gJiYgcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDcmVkZW50aWFsc0ZpbGVFbnZdKQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIC8vIGlmIHVzaW5nIGNvbmZpZywgYXNzdW1lIGl0IGlzIGZ1bGx5IGRlc2NyaXB0aXZlIHdpdGhvdXQgYSBjcmVkZW50aWFscyBmaWxlOgogICAgICBpZiAoIXByb2Nlc3MuZW52W3V0aWwuY29uZmlnT3B0SW5FbnZdKSB0aHJvdyBlcnJvcjsKICAgIH0KICAgIGZvciAodmFyIGkgPSAwLCBwcm9maWxlTmFtZXMgPSBPYmplY3Qua2V5cyhwcm9maWxlc0Zyb21Db25maWcpOyBpIDwgcHJvZmlsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gPSBvYmplY3RBc3NpZ24ocHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSB8fCB7fSwgcHJvZmlsZXNGcm9tQ29uZmlnW3Byb2ZpbGVOYW1lc1tpXV0pOwogICAgfQogICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNyZWRzKTsgaSA8IHByb2ZpbGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICBwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dID0gb2JqZWN0QXNzaWduKHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gfHwge30sIHByb2ZpbGVzRnJvbUNyZWRzW3Byb2ZpbGVOYW1lc1tpXV0pOwogICAgfQogICAgcmV0dXJuIHByb2ZpbGVzOwoKICAgIC8qKgogICAgICogUm91Z2hseSB0aGUgc2VtYW50aWNzIG9mIGBPYmplY3QuYXNzaWduKHRhcmdldCwgc291cmNlKWAKICAgICAqLwogICAgZnVuY3Rpb24gb2JqZWN0QXNzaWduKHRhcmdldCwgc291cmNlKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0YXJnZXRba2V5c1tpXV0gPSBzb3VyY2Vba2V5c1tpXV07CiAgICAgIH0KICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBUk46IHsKICAgIHZhbGlkYXRlOiBmdW5jdGlvbiB2YWxpZGF0ZUFSTihzdHIpIHsKICAgICAgcmV0dXJuIHN0ciAmJiBzdHIuaW5kZXhPZignYXJuOicpID09PSAwICYmIHN0ci5zcGxpdCgnOicpLmxlbmd0aCA+PSA2OwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiBwYXJzZUFSTihhcm4pIHsKICAgICAgdmFyIG1hdGNoZWQgPSBhcm4uc3BsaXQoJzonKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBwYXJ0aXRpb246IG1hdGNoZWRbMV0sCiAgICAgICAgc2VydmljZTogbWF0Y2hlZFsyXSwKICAgICAgICByZWdpb246IG1hdGNoZWRbM10sCiAgICAgICAgYWNjb3VudElkOiBtYXRjaGVkWzRdLAogICAgICAgIHJlc291cmNlOiBtYXRjaGVkLnNsaWNlKDUpLmpvaW4oJzonKQogICAgICB9OwogICAgfSwKICAgIGJ1aWxkOiBmdW5jdGlvbiBidWlsZEFSTihhcm5PYmplY3QpIHsKICAgICAgaWYgKAogICAgICAgIGFybk9iamVjdC5zZXJ2aWNlID09PSB1bmRlZmluZWQgfHwKICAgICAgICBhcm5PYmplY3QucmVnaW9uID09PSB1bmRlZmluZWQgfHwKICAgICAgICBhcm5PYmplY3QuYWNjb3VudElkID09PSB1bmRlZmluZWQgfHwKICAgICAgICBhcm5PYmplY3QucmVzb3VyY2UgPT09IHVuZGVmaW5lZAogICAgICApIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdJbnB1dCBBUk4gb2JqZWN0IGlzIGludmFsaWQnKSk7CiAgICAgIHJldHVybiAnYXJuOicrIChhcm5PYmplY3QucGFydGl0aW9uIHx8ICdhd3MnKSArICc6JyArIGFybk9iamVjdC5zZXJ2aWNlICsKICAgICAgICAnOicgKyBhcm5PYmplY3QucmVnaW9uICsgJzonICsgYXJuT2JqZWN0LmFjY291bnRJZCArICc6JyArIGFybk9iamVjdC5yZXNvdXJjZTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBkZWZhdWx0UHJvZmlsZTogJ2RlZmF1bHQnLAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjb25maWdPcHRJbkVudjogJ0FXU19TREtfTE9BRF9DT05GSUcnLAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzaGFyZWRDcmVkZW50aWFsc0ZpbGVFbnY6ICdBV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUnLAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBzaGFyZWRDb25maWdGaWxlRW52OiAnQVdTX0NPTkZJR19GSUxFJywKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaW1kc0Rpc2FibGVkRW52OiAnQVdTX0VDMl9NRVRBREFUQV9ESVNBQkxFRCcKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gdXRpbDsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSxyZXF1aXJlKCJ0aW1lcnMiKS5zZXRJbW1lZGlhdGUpCn0seyIuLi9hcGlzL21ldGFkYXRhLmpzb24iOjQsIi4vY29yZSI6MTksIl9wcm9jZXNzIjo4OSwiZnMiOjgwLCJ0aW1lcnMiOjk3LCJ1dWlkIjoxMDB9XSw3MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwoKZnVuY3Rpb24gRG9tWG1sUGFyc2VyKCkgeyB9CgpEb21YbWxQYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24oeG1sLCBzaGFwZSkgewogIGlmICh4bWwucmVwbGFjZSgvXlxzKy8sICcnKSA9PT0gJycpIHJldHVybiB7fTsKCiAgdmFyIHJlc3VsdCwgZXJyb3I7CiAgdHJ5IHsKICAgIGlmICh3aW5kb3cuRE9NUGFyc2VyKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICByZXN1bHQgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKHhtbCwgJ3RleHQveG1sJyk7CiAgICAgIH0gY2F0Y2ggKHN5bnRheEVycm9yKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ1BhcnNlIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICB7CiAgICAgICAgICAgIG9yaWdpbmFsRXJyb3I6IHN5bnRheEVycm9yLAogICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAocmVzdWx0LmRvY3VtZW50RWxlbWVudCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgcGFyc2UgZW1wdHkgZG9jdW1lbnQuJyksCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHZhciBpc0Vycm9yID0gcmVzdWx0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdwYXJzZXJlcnJvcicpWzBdOwogICAgICBpZiAoaXNFcnJvciAmJiAoaXNFcnJvci5wYXJlbnROb2RlID09PSByZXN1bHQgfHwKICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ2JvZHknIHx8CiAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUucGFyZW50Tm9kZSA9PT0gcmVzdWx0IHx8CiAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ2JvZHknKSkgewogICAgICAgIHZhciBlcnJvckVsZW1lbnQgPSBpc0Vycm9yLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkaXYnKVswXSB8fCBpc0Vycm9yOwogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKGVycm9yRWxlbWVudC50ZXh0Q29udGVudCB8fCAnUGFyc2VyIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKICAgICAgcmVzdWx0ID0gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MRE9NJyk7CiAgICAgIHJlc3VsdC5hc3luYyA9IGZhbHNlOwoKICAgICAgaWYgKCFyZXN1bHQubG9hZFhNTCh4bWwpKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ1BhcnNlIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGxvYWQgWE1MIHBhcnNlcicpOwogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIGVycm9yID0gZTsKICB9CgogIGlmIChyZXN1bHQgJiYgcmVzdWx0LmRvY3VtZW50RWxlbWVudCAmJiAhZXJyb3IpIHsKICAgIHZhciBkYXRhID0gcGFyc2VYbWwocmVzdWx0LmRvY3VtZW50RWxlbWVudCwgc2hhcGUpOwogICAgdmFyIG1ldGFkYXRhID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShyZXN1bHQuZG9jdW1lbnRFbGVtZW50LCAnUmVzcG9uc2VNZXRhZGF0YScpOwogICAgaWYgKG1ldGFkYXRhKSB7CiAgICAgIGRhdGEuUmVzcG9uc2VNZXRhZGF0YSA9IHBhcnNlWG1sKG1ldGFkYXRhLCB7fSk7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9IGVsc2UgaWYgKGVycm9yKSB7CiAgICB0aHJvdyB1dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCB7Y29kZTogJ1hNTFBhcnNlckVycm9yJywgcmV0cnlhYmxlOiB0cnVlfSk7CiAgfSBlbHNlIHsgLy8gZW1wdHkgeG1sIGRvY3VtZW50CiAgICByZXR1cm4ge307CiAgfQp9OwoKZnVuY3Rpb24gZ2V0RWxlbWVudEJ5VGFnTmFtZSh4bWwsIHRhZykgewogIHZhciBlbGVtZW50cyA9IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwogIGZvciAodmFyIGkgPSAwLCBpTGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICBpZiAoZWxlbWVudHNbaV0ucGFyZW50Tm9kZSA9PT0geG1sKSB7CiAgICAgIHJldHVybiBlbGVtZW50c1tpXTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIHBhcnNlWG1sKHhtbCwgc2hhcGUpIHsKICBpZiAoIXNoYXBlKSBzaGFwZSA9IHt9OwogIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpOwogICAgY2FzZSAnbWFwJzogcmV0dXJuIHBhcnNlTWFwKHhtbCwgc2hhcGUpOwogICAgY2FzZSAnbGlzdCc6IHJldHVybiBwYXJzZUxpc3QoeG1sLCBzaGFwZSk7CiAgICBjYXNlIHVuZGVmaW5lZDogY2FzZSBudWxsOiByZXR1cm4gcGFyc2VVbmtub3duKHhtbCk7CiAgICBkZWZhdWx0OiByZXR1cm4gcGFyc2VTY2FsYXIoeG1sLCBzaGFwZSk7CiAgfQp9CgpmdW5jdGlvbiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKSB7CiAgdmFyIGRhdGEgPSB7fTsKICBpZiAoeG1sID09PSBudWxsKSByZXR1cm4gZGF0YTsKCiAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG1lbWJlck5hbWUsIG1lbWJlclNoYXBlKSB7CiAgICBpZiAobWVtYmVyU2hhcGUuaXNYbWxBdHRyaWJ1dGUpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh4bWwuYXR0cmlidXRlcywgbWVtYmVyU2hhcGUubmFtZSkpIHsKICAgICAgICB2YXIgdmFsdWUgPSB4bWwuYXR0cmlidXRlc1ttZW1iZXJTaGFwZS5uYW1lXS52YWx1ZTsKICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gcGFyc2VYbWwoe3RleHRDb250ZW50OiB2YWx1ZX0sIG1lbWJlclNoYXBlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIHhtbENoaWxkID0gbWVtYmVyU2hhcGUuZmxhdHRlbmVkID8geG1sIDoKICAgICAgICBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgbWVtYmVyU2hhcGUubmFtZSk7CiAgICAgIGlmICh4bWxDaGlsZCkgewogICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBwYXJzZVhtbCh4bWxDaGlsZCwgbWVtYmVyU2hhcGUpOwogICAgICB9IGVsc2UgaWYgKAogICAgICAgICFtZW1iZXJTaGFwZS5mbGF0dGVuZWQgJiYKICAgICAgICBtZW1iZXJTaGFwZS50eXBlID09PSAnbGlzdCcgJiYKICAgICAgICAhc2hhcGUuYXBpLnhtbE5vRGVmYXVsdExpc3RzKSB7CiAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IG1lbWJlclNoYXBlLmRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgfQogIH0pOwoKICByZXR1cm4gZGF0YTsKfQoKZnVuY3Rpb24gcGFyc2VNYXAoeG1sLCBzaGFwZSkgewogIHZhciBkYXRhID0ge307CiAgdmFyIHhtbEtleSA9IHNoYXBlLmtleS5uYW1lIHx8ICdrZXknOwogIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKICB2YXIgdGFnTmFtZSA9IHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAnZW50cnknOwoKICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgd2hpbGUgKGNoaWxkKSB7CiAgICBpZiAoY2hpbGQubm9kZU5hbWUgPT09IHRhZ05hbWUpIHsKICAgICAgdmFyIGtleSA9IGdldEVsZW1lbnRCeVRhZ05hbWUoY2hpbGQsIHhtbEtleSkudGV4dENvbnRlbnQ7CiAgICAgIHZhciB2YWx1ZSA9IGdldEVsZW1lbnRCeVRhZ05hbWUoY2hpbGQsIHhtbFZhbHVlKTsKICAgICAgZGF0YVtrZXldID0gcGFyc2VYbWwodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgIH0KICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogIH0KICByZXR1cm4gZGF0YTsKfQoKZnVuY3Rpb24gcGFyc2VMaXN0KHhtbCwgc2hhcGUpIHsKICB2YXIgZGF0YSA9IFtdOwogIHZhciB0YWdOYW1lID0gc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6IChzaGFwZS5tZW1iZXIubmFtZSB8fCAnbWVtYmVyJyk7CgogIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICB3aGlsZSAoY2hpbGQpIHsKICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PT0gdGFnTmFtZSkgewogICAgICBkYXRhLnB1c2gocGFyc2VYbWwoY2hpbGQsIHNoYXBlLm1lbWJlcikpOwogICAgfQogICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgfQogIHJldHVybiBkYXRhOwp9CgpmdW5jdGlvbiBwYXJzZVNjYWxhcih4bWwsIHNoYXBlKSB7CiAgaWYgKHhtbC5nZXRBdHRyaWJ1dGUpIHsKICAgIHZhciBlbmNvZGluZyA9IHhtbC5nZXRBdHRyaWJ1dGUoJ2VuY29kaW5nJyk7CiAgICBpZiAoZW5jb2RpbmcgPT09ICdiYXNlNjQnKSB7CiAgICAgIHNoYXBlID0gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogZW5jb2Rpbmd9KTsKICAgIH0KICB9CgogIHZhciB0ZXh0ID0geG1sLnRleHRDb250ZW50OwogIGlmICh0ZXh0ID09PSAnJykgdGV4dCA9IG51bGw7CiAgaWYgKHR5cGVvZiBzaGFwZS50b1R5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgIHJldHVybiBzaGFwZS50b1R5cGUodGV4dCk7CiAgfSBlbHNlIHsKICAgIHJldHVybiB0ZXh0OwogIH0KfQoKZnVuY3Rpb24gcGFyc2VVbmtub3duKHhtbCkgewogIGlmICh4bWwgPT09IHVuZGVmaW5lZCB8fCB4bWwgPT09IG51bGwpIHJldHVybiAnJzsKCiAgLy8gZW1wdHkgb2JqZWN0CiAgaWYgKCF4bWwuZmlyc3RFbGVtZW50Q2hpbGQpIHsKICAgIGlmICh4bWwucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSBudWxsKSByZXR1cm4ge307CiAgICBpZiAoeG1sLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwKSByZXR1cm4gJyc7CiAgICBlbHNlIHJldHVybiB4bWwudGV4dENvbnRlbnQ7CiAgfQoKICAvLyBvYmplY3QsIHBhcnNlIGFzIHN0cnVjdHVyZQogIHZhciBzaGFwZSA9IHt0eXBlOiAnc3RydWN0dXJlJywgbWVtYmVyczoge319OwogIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICB3aGlsZSAoY2hpbGQpIHsKICAgIHZhciB0YWcgPSBjaGlsZC5ub2RlTmFtZTsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc2hhcGUubWVtYmVycywgdGFnKSkgewogICAgICAvLyBtdWx0aXBsZSB0YWdzIG9mIHRoZSBzYW1lIG5hbWUgbWFrZXMgaXQgYSBsaXN0CiAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXS50eXBlID0gJ2xpc3QnOwogICAgfSBlbHNlIHsKICAgICAgc2hhcGUubWVtYmVyc1t0YWddID0ge25hbWU6IHRhZ307CiAgICB9CiAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICB9CiAgcmV0dXJuIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IERvbVhtbFBhcnNlcjsKCn0seyIuLi9tb2RlbC9zaGFwZSI6NDQsIi4uL3V0aWwiOjcyfV0sNzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIFhtbE5vZGUgPSByZXF1aXJlKCcuL3htbC1ub2RlJykuWG1sTm9kZTsKdmFyIFhtbFRleHQgPSByZXF1aXJlKCcuL3htbC10ZXh0JykuWG1sVGV4dDsKCmZ1bmN0aW9uIFhtbEJ1aWxkZXIoKSB7IH0KClhtbEJ1aWxkZXIucHJvdG90eXBlLnRvWE1MID0gZnVuY3Rpb24ocGFyYW1zLCBzaGFwZSwgcm9vdEVsZW1lbnQsIG5vRW1wdHkpIHsKICB2YXIgeG1sID0gbmV3IFhtbE5vZGUocm9vdEVsZW1lbnQpOwogIGFwcGx5TmFtZXNwYWNlcyh4bWwsIHNoYXBlLCB0cnVlKTsKICBzZXJpYWxpemUoeG1sLCBwYXJhbXMsIHNoYXBlKTsKICByZXR1cm4geG1sLmNoaWxkcmVuLmxlbmd0aCA+IDAgfHwgbm9FbXB0eSA/IHhtbC50b1N0cmluZygpIDogJyc7Cn07CgpmdW5jdGlvbiBzZXJpYWxpemUoeG1sLCB2YWx1ZSwgc2hhcGUpIHsKICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiBzZXJpYWxpemVTdHJ1Y3R1cmUoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgY2FzZSAnbWFwJzogcmV0dXJuIHNlcmlhbGl6ZU1hcCh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICBjYXNlICdsaXN0JzogcmV0dXJuIHNlcmlhbGl6ZUxpc3QoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgZGVmYXVsdDogcmV0dXJuIHNlcmlhbGl6ZVNjYWxhcih4bWwsIHZhbHVlLCBzaGFwZSk7CiAgfQp9CgpmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUoeG1sLCBwYXJhbXMsIHNoYXBlKSB7CiAgdXRpbC5hcnJheUVhY2goc2hhcGUubWVtYmVyTmFtZXMsIGZ1bmN0aW9uKG1lbWJlck5hbWUpIHsKICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbWVtYmVyTmFtZV07CiAgICBpZiAobWVtYmVyU2hhcGUubG9jYXRpb24gIT09ICdib2R5JykgcmV0dXJuOwoKICAgIHZhciB2YWx1ZSA9IHBhcmFtc1ttZW1iZXJOYW1lXTsKICAgIHZhciBuYW1lID0gbWVtYmVyU2hhcGUubmFtZTsKICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgIGlmIChtZW1iZXJTaGFwZS5pc1htbEF0dHJpYnV0ZSkgewogICAgICAgIHhtbC5hZGRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICB9IGVsc2UgaWYgKG1lbWJlclNoYXBlLmZsYXR0ZW5lZCkgewogICAgICAgIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgIGFwcGx5TmFtZXNwYWNlcyhlbGVtZW50LCBtZW1iZXJTaGFwZSk7CiAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgIH0KICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gc2VyaWFsaXplTWFwKHhtbCwgbWFwLCBzaGFwZSkgewogIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICB2YXIgeG1sVmFsdWUgPSBzaGFwZS52YWx1ZS5uYW1lIHx8ICd2YWx1ZSc7CgogIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHZhciBlbnRyeSA9IG5ldyBYbWxOb2RlKHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAnZW50cnknKTsKICAgIHhtbC5hZGRDaGlsZE5vZGUoZW50cnkpOwoKICAgIHZhciBlbnRyeUtleSA9IG5ldyBYbWxOb2RlKHhtbEtleSk7CiAgICB2YXIgZW50cnlWYWx1ZSA9IG5ldyBYbWxOb2RlKHhtbFZhbHVlKTsKICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeUtleSk7CiAgICBlbnRyeS5hZGRDaGlsZE5vZGUoZW50cnlWYWx1ZSk7CgogICAgc2VyaWFsaXplKGVudHJ5S2V5LCBrZXksIHNoYXBlLmtleSk7CiAgICBzZXJpYWxpemUoZW50cnlWYWx1ZSwgdmFsdWUsIHNoYXBlLnZhbHVlKTsKICB9KTsKfQoKZnVuY3Rpb24gc2VyaWFsaXplTGlzdCh4bWwsIGxpc3QsIHNoYXBlKSB7CiAgaWYgKHNoYXBlLmZsYXR0ZW5lZCkgewogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIG5hbWUgPSBzaGFwZS5tZW1iZXIubmFtZSB8fCBzaGFwZS5uYW1lOwogICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICB9KTsKICB9IGVsc2UgewogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIG5hbWUgPSBzaGFwZS5tZW1iZXIubmFtZSB8fCAnbWVtYmVyJzsKICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBzZXJpYWxpemVTY2FsYXIoeG1sLCB2YWx1ZSwgc2hhcGUpIHsKICB4bWwuYWRkQ2hpbGROb2RlKAogICAgbmV3IFhtbFRleHQoc2hhcGUudG9XaXJlRm9ybWF0KHZhbHVlKSkKICApOwp9CgpmdW5jdGlvbiBhcHBseU5hbWVzcGFjZXMoeG1sLCBzaGFwZSwgaXNSb290KSB7CiAgdmFyIHVyaSwgcHJlZml4ID0gJ3htbG5zJzsKICBpZiAoc2hhcGUueG1sTmFtZXNwYWNlVXJpKSB7CiAgICB1cmkgPSBzaGFwZS54bWxOYW1lc3BhY2VVcmk7CiAgICBpZiAoc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4KSBwcmVmaXggKz0gJzonICsgc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4OwogIH0gZWxzZSBpZiAoaXNSb290ICYmIHNoYXBlLmFwaS54bWxOYW1lc3BhY2VVcmkpIHsKICAgIHVyaSA9IHNoYXBlLmFwaS54bWxOYW1lc3BhY2VVcmk7CiAgfQoKICBpZiAodXJpKSB4bWwuYWRkQXR0cmlidXRlKHByZWZpeCwgdXJpKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBYbWxCdWlsZGVyOwoKfSx7Ii4uL3V0aWwiOjcyLCIuL3htbC1ub2RlIjo3NywiLi94bWwtdGV4dCI6Nzh9XSw3NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBFc2NhcGVzIGNoYXJhY3RlcnMgdGhhdCBjYW4gbm90IGJlIGluIGFuIFhNTCBhdHRyaWJ1dGUuCiAqLwpmdW5jdGlvbiBlc2NhcGVBdHRyaWJ1dGUodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLycvZywgJyZhcG9zOycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7JykucmVwbGFjZSgvIi9nLCAnJnF1b3Q7Jyk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgZXNjYXBlQXR0cmlidXRlOiBlc2NhcGVBdHRyaWJ1dGUKfTsKCn0se31dLDc2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEVzY2FwZXMgY2hhcmFjdGVycyB0aGF0IGNhbiBub3QgYmUgaW4gYW4gWE1MIGVsZW1lbnQuCiAqLwpmdW5jdGlvbiBlc2NhcGVFbGVtZW50KHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvJi9nLCAnJmFtcDsnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoLzwvZywgJyZsdDsnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoLz4vZywgJyZndDsnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xyL2csICcmI3gwRDsnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xuL2csICcmI3gwQTsnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1x1MDA4NS9nLCAnJiN4ODU7JykKICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cdTIwMjgvLCAnJiN4MjAyODsnKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBlc2NhcGVFbGVtZW50OiBlc2NhcGVFbGVtZW50Cn07Cgp9LHt9XSw3NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBlc2NhcGVBdHRyaWJ1dGUgPSByZXF1aXJlKCcuL2VzY2FwZS1hdHRyaWJ1dGUnKS5lc2NhcGVBdHRyaWJ1dGU7CgovKioKICogUmVwcmVzZW50cyBhbiBYTUwgbm9kZS4KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBYbWxOb2RlKG5hbWUsIGNoaWxkcmVuKSB7CiAgICBpZiAoY2hpbGRyZW4gPT09IHZvaWQgMCkgeyBjaGlsZHJlbiA9IFtdOyB9CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307Cn0KWG1sTm9kZS5wcm90b3R5cGUuYWRkQXR0cmlidXRlID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICB0aGlzLmF0dHJpYnV0ZXNbbmFtZV0gPSB2YWx1ZTsKICAgIHJldHVybiB0aGlzOwp9OwpYbWxOb2RlLnByb3RvdHlwZS5hZGRDaGlsZE5vZGUgPSBmdW5jdGlvbiAoY2hpbGQpIHsKICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICByZXR1cm4gdGhpczsKfTsKWG1sTm9kZS5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIGRlbGV0ZSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CiAgICByZXR1cm4gdGhpczsKfTsKWG1sTm9kZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaGFzQ2hpbGRyZW4gPSBCb29sZWFuKHRoaXMuY2hpbGRyZW4ubGVuZ3RoKTsKICAgIHZhciB4bWxUZXh0ID0gJzwnICsgdGhpcy5uYW1lOwogICAgLy8gYWRkIGF0dHJpYnV0ZXMKICAgIHZhciBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgZm9yICh2YXIgaSA9IDAsIGF0dHJpYnV0ZU5hbWVzID0gT2JqZWN0LmtleXMoYXR0cmlidXRlcyk7IGkgPCBhdHRyaWJ1dGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZXNbaV07CiAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGUgIT09ICd1bmRlZmluZWQnICYmIGF0dHJpYnV0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICB4bWxUZXh0ICs9ICcgJyArIGF0dHJpYnV0ZU5hbWUgKyAnPVwiJyArIGVzY2FwZUF0dHJpYnV0ZSgnJyArIGF0dHJpYnV0ZSkgKyAnXCInOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB4bWxUZXh0ICs9ICFoYXNDaGlsZHJlbiA/ICcvPicgOiAnPicgKyB0aGlzLmNoaWxkcmVuLm1hcChmdW5jdGlvbiAoYykgeyByZXR1cm4gYy50b1N0cmluZygpOyB9KS5qb2luKCcnKSArICc8LycgKyB0aGlzLm5hbWUgKyAnPic7Cn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIFhtbE5vZGU6IFhtbE5vZGUKfTsKCn0seyIuL2VzY2FwZS1hdHRyaWJ1dGUiOjc1fV0sNzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgZXNjYXBlRWxlbWVudCA9IHJlcXVpcmUoJy4vZXNjYXBlLWVsZW1lbnQnKS5lc2NhcGVFbGVtZW50OwoKLyoqCiAqIFJlcHJlc2VudHMgYW4gWE1MIHRleHQgdmFsdWUuCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gWG1sVGV4dCh2YWx1ZSkgewogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwp9CgpYbWxUZXh0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBlc2NhcGVFbGVtZW50KCcnICsgdGhpcy52YWx1ZSk7Cn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIFhtbFRleHQ6IFhtbFRleHQKfTsKCn0seyIuL2VzY2FwZS1lbGVtZW50Ijo3Nn1dLDc5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnCgpleHBvcnRzLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoCmV4cG9ydHMudG9CeXRlQXJyYXkgPSB0b0J5dGVBcnJheQpleHBvcnRzLmZyb21CeXRlQXJyYXkgPSBmcm9tQnl0ZUFycmF5Cgp2YXIgbG9va3VwID0gW10KdmFyIHJldkxvb2t1cCA9IFtdCnZhciBBcnIgPSB0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcgPyBVaW50OEFycmF5IDogQXJyYXkKCnZhciBjb2RlID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8nCmZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2RlLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgbG9va3VwW2ldID0gY29kZVtpXQogIHJldkxvb2t1cFtjb2RlLmNoYXJDb2RlQXQoaSldID0gaQp9CgovLyBTdXBwb3J0IGRlY29kaW5nIFVSTC1zYWZlIGJhc2U2NCBzdHJpbmdzLCBhcyBOb2RlLmpzIGRvZXMuCi8vIFNlZTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmFzZTY0I1VSTF9hcHBsaWNhdGlvbnMKcmV2TG9va3VwWyctJy5jaGFyQ29kZUF0KDApXSA9IDYyCnJldkxvb2t1cFsnXycuY2hhckNvZGVBdCgwKV0gPSA2MwoKZnVuY3Rpb24gZ2V0TGVucyAoYjY0KSB7CiAgdmFyIGxlbiA9IGI2NC5sZW5ndGgKCiAgaWYgKGxlbiAlIDQgPiAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc3RyaW5nLiBMZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDQnKQogIH0KCiAgLy8gVHJpbSBvZmYgZXh0cmEgYnl0ZXMgYWZ0ZXIgcGxhY2Vob2xkZXIgYnl0ZXMgYXJlIGZvdW5kCiAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vYmVhdGdhbW1pdC9iYXNlNjQtanMvaXNzdWVzLzQyCiAgdmFyIHZhbGlkTGVuID0gYjY0LmluZGV4T2YoJz0nKQogIGlmICh2YWxpZExlbiA9PT0gLTEpIHZhbGlkTGVuID0gbGVuCgogIHZhciBwbGFjZUhvbGRlcnNMZW4gPSB2YWxpZExlbiA9PT0gbGVuCiAgICA/IDAKICAgIDogNCAtICh2YWxpZExlbiAlIDQpCgogIHJldHVybiBbdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbl0KfQoKLy8gYmFzZTY0IGlzIDQvMyArIHVwIHRvIHR3byBjaGFyYWN0ZXJzIG9mIHRoZSBvcmlnaW5hbCBkYXRhCmZ1bmN0aW9uIGJ5dGVMZW5ndGggKGI2NCkgewogIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpCiAgdmFyIHZhbGlkTGVuID0gbGVuc1swXQogIHZhciBwbGFjZUhvbGRlcnNMZW4gPSBsZW5zWzFdCiAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCn0KCmZ1bmN0aW9uIF9ieXRlTGVuZ3RoIChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pIHsKICByZXR1cm4gKCh2YWxpZExlbiArIHBsYWNlSG9sZGVyc0xlbikgKiAzIC8gNCkgLSBwbGFjZUhvbGRlcnNMZW4KfQoKZnVuY3Rpb24gdG9CeXRlQXJyYXkgKGI2NCkgewogIHZhciB0bXAKICB2YXIgbGVucyA9IGdldExlbnMoYjY0KQogIHZhciB2YWxpZExlbiA9IGxlbnNbMF0KICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXQoKICB2YXIgYXJyID0gbmV3IEFycihfYnl0ZUxlbmd0aChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pKQoKICB2YXIgY3VyQnl0ZSA9IDAKCiAgLy8gaWYgdGhlcmUgYXJlIHBsYWNlaG9sZGVycywgb25seSBnZXQgdXAgdG8gdGhlIGxhc3QgY29tcGxldGUgNCBjaGFycwogIHZhciBsZW4gPSBwbGFjZUhvbGRlcnNMZW4gPiAwCiAgICA/IHZhbGlkTGVuIC0gNAogICAgOiB2YWxpZExlbgoKICB2YXIgaQogIGZvciAoaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewogICAgdG1wID0KICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMTgpIHwKICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDEyKSB8CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA8PCA2KSB8CiAgICAgIHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMyldCiAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gMTYpICYgMHhGRgogICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgfQoKICBpZiAocGxhY2VIb2xkZXJzTGVuID09PSAyKSB7CiAgICB0bXAgPQogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAyKSB8CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA+PiA0KQogICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgfQoKICBpZiAocGxhY2VIb2xkZXJzTGVuID09PSAxKSB7CiAgICB0bXAgPQogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxMCkgfAogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPDwgNCkgfAogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPj4gMikKICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiA4KSAmIDB4RkYKICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogIH0KCiAgcmV0dXJuIGFycgp9CgpmdW5jdGlvbiB0cmlwbGV0VG9CYXNlNjQgKG51bSkgewogIHJldHVybiBsb29rdXBbbnVtID4+IDE4ICYgMHgzRl0gKwogICAgbG9va3VwW251bSA+PiAxMiAmIDB4M0ZdICsKICAgIGxvb2t1cFtudW0gPj4gNiAmIDB4M0ZdICsKICAgIGxvb2t1cFtudW0gJiAweDNGXQp9CgpmdW5jdGlvbiBlbmNvZGVDaHVuayAodWludDgsIHN0YXJ0LCBlbmQpIHsKICB2YXIgdG1wCiAgdmFyIG91dHB1dCA9IFtdCiAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpICs9IDMpIHsKICAgIHRtcCA9CiAgICAgICgodWludDhbaV0gPDwgMTYpICYgMHhGRjAwMDApICsKICAgICAgKCh1aW50OFtpICsgMV0gPDwgOCkgJiAweEZGMDApICsKICAgICAgKHVpbnQ4W2kgKyAyXSAmIDB4RkYpCiAgICBvdXRwdXQucHVzaCh0cmlwbGV0VG9CYXNlNjQodG1wKSkKICB9CiAgcmV0dXJuIG91dHB1dC5qb2luKCcnKQp9CgpmdW5jdGlvbiBmcm9tQnl0ZUFycmF5ICh1aW50OCkgewogIHZhciB0bXAKICB2YXIgbGVuID0gdWludDgubGVuZ3RoCiAgdmFyIGV4dHJhQnl0ZXMgPSBsZW4gJSAzIC8vIGlmIHdlIGhhdmUgMSBieXRlIGxlZnQsIHBhZCAyIGJ5dGVzCiAgdmFyIHBhcnRzID0gW10KICB2YXIgbWF4Q2h1bmtMZW5ndGggPSAxNjM4MyAvLyBtdXN0IGJlIG11bHRpcGxlIG9mIDMKCiAgLy8gZ28gdGhyb3VnaCB0aGUgYXJyYXkgZXZlcnkgdGhyZWUgYnl0ZXMsIHdlJ2xsIGRlYWwgd2l0aCB0cmFpbGluZyBzdHVmZiBsYXRlcgogIGZvciAodmFyIGkgPSAwLCBsZW4yID0gbGVuIC0gZXh0cmFCeXRlczsgaSA8IGxlbjI7IGkgKz0gbWF4Q2h1bmtMZW5ndGgpIHsKICAgIHBhcnRzLnB1c2goZW5jb2RlQ2h1bmsodWludDgsIGksIChpICsgbWF4Q2h1bmtMZW5ndGgpID4gbGVuMiA/IGxlbjIgOiAoaSArIG1heENodW5rTGVuZ3RoKSkpCiAgfQoKICAvLyBwYWQgdGhlIGVuZCB3aXRoIHplcm9zLCBidXQgbWFrZSBzdXJlIHRvIG5vdCBmb3JnZXQgdGhlIGV4dHJhIGJ5dGVzCiAgaWYgKGV4dHJhQnl0ZXMgPT09IDEpIHsKICAgIHRtcCA9IHVpbnQ4W2xlbiAtIDFdCiAgICBwYXJ0cy5wdXNoKAogICAgICBsb29rdXBbdG1wID4+IDJdICsKICAgICAgbG9va3VwWyh0bXAgPDwgNCkgJiAweDNGXSArCiAgICAgICc9PScKICAgICkKICB9IGVsc2UgaWYgKGV4dHJhQnl0ZXMgPT09IDIpIHsKICAgIHRtcCA9ICh1aW50OFtsZW4gLSAyXSA8PCA4KSArIHVpbnQ4W2xlbiAtIDFdCiAgICBwYXJ0cy5wdXNoKAogICAgICBsb29rdXBbdG1wID4+IDEwXSArCiAgICAgIGxvb2t1cFsodG1wID4+IDQpICYgMHgzRl0gKwogICAgICBsb29rdXBbKHRtcCA8PCAyKSAmIDB4M0ZdICsKICAgICAgJz0nCiAgICApCiAgfQoKICByZXR1cm4gcGFydHMuam9pbignJykKfQoKfSx7fV0sODA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoKfSx7fV0sODE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewppZiAodHlwZW9mIE9iamVjdC5jcmVhdGUgPT09ICdmdW5jdGlvbicpIHsKICAvLyBpbXBsZW1lbnRhdGlvbiBmcm9tIHN0YW5kYXJkIG5vZGUuanMgJ3V0aWwnIG1vZHVsZQogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaW5oZXJpdHMoY3Rvciwgc3VwZXJDdG9yKSB7CiAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcgogICAgY3Rvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ3Rvci5wcm90b3R5cGUsIHsKICAgICAgY29uc3RydWN0b3I6IHsKICAgICAgICB2YWx1ZTogY3RvciwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfQogICAgfSk7CiAgfTsKfSBlbHNlIHsKICAvLyBvbGQgc2Nob29sIHNoaW0gZm9yIG9sZCBicm93c2VycwogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaW5oZXJpdHMoY3Rvciwgc3VwZXJDdG9yKSB7CiAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcgogICAgdmFyIFRlbXBDdG9yID0gZnVuY3Rpb24gKCkge30KICAgIFRlbXBDdG9yLnByb3RvdHlwZSA9IHN1cGVyQ3Rvci5wcm90b3R5cGUKICAgIGN0b3IucHJvdG90eXBlID0gbmV3IFRlbXBDdG9yKCkKICAgIGN0b3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY3RvcgogIH0KfQoKfSx7fV0sODI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGlzQnVmZmVyKGFyZykgewogIHJldHVybiBhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcKICAgICYmIHR5cGVvZiBhcmcuY29weSA9PT0gJ2Z1bmN0aW9uJwogICAgJiYgdHlwZW9mIGFyZy5maWxsID09PSAnZnVuY3Rpb24nCiAgICAmJiB0eXBlb2YgYXJnLnJlYWRVSW50OCA9PT0gJ2Z1bmN0aW9uJzsKfQp9LHt9XSw4MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2VzcyxnbG9iYWwpeyhmdW5jdGlvbiAoKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKdmFyIGZvcm1hdFJlZ0V4cCA9IC8lW3NkaiVdL2c7CmV4cG9ydHMuZm9ybWF0ID0gZnVuY3Rpb24oZikgewogIGlmICghaXNTdHJpbmcoZikpIHsKICAgIHZhciBvYmplY3RzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICBvYmplY3RzLnB1c2goaW5zcGVjdChhcmd1bWVudHNbaV0pKTsKICAgIH0KICAgIHJldHVybiBvYmplY3RzLmpvaW4oJyAnKTsKICB9CgogIHZhciBpID0gMTsKICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICB2YXIgbGVuID0gYXJncy5sZW5ndGg7CiAgdmFyIHN0ciA9IFN0cmluZyhmKS5yZXBsYWNlKGZvcm1hdFJlZ0V4cCwgZnVuY3Rpb24oeCkgewogICAgaWYgKHggPT09ICclJScpIHJldHVybiAnJSc7CiAgICBpZiAoaSA+PSBsZW4pIHJldHVybiB4OwogICAgc3dpdGNoICh4KSB7CiAgICAgIGNhc2UgJyVzJzogcmV0dXJuIFN0cmluZyhhcmdzW2krK10pOwogICAgICBjYXNlICclZCc6IHJldHVybiBOdW1iZXIoYXJnc1tpKytdKTsKICAgICAgY2FzZSAnJWonOgogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYXJnc1tpKytdKTsKICAgICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgICByZXR1cm4gJ1tDaXJjdWxhcl0nOwogICAgICAgIH0KICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4geDsKICAgIH0KICB9KTsKICBmb3IgKHZhciB4ID0gYXJnc1tpXTsgaSA8IGxlbjsgeCA9IGFyZ3NbKytpXSkgewogICAgaWYgKGlzTnVsbCh4KSB8fCAhaXNPYmplY3QoeCkpIHsKICAgICAgc3RyICs9ICcgJyArIHg7CiAgICB9IGVsc2UgewogICAgICBzdHIgKz0gJyAnICsgaW5zcGVjdCh4KTsKICAgIH0KICB9CiAgcmV0dXJuIHN0cjsKfTsKCgovLyBNYXJrIHRoYXQgYSBtZXRob2Qgc2hvdWxkIG5vdCBiZSB1c2VkLgovLyBSZXR1cm5zIGEgbW9kaWZpZWQgZnVuY3Rpb24gd2hpY2ggd2FybnMgb25jZSBieSBkZWZhdWx0LgovLyBJZiAtLW5vLWRlcHJlY2F0aW9uIGlzIHNldCwgdGhlbiBpdCBpcyBhIG5vLW9wLgpleHBvcnRzLmRlcHJlY2F0ZSA9IGZ1bmN0aW9uKGZuLCBtc2cpIHsKICAvLyBBbGxvdyBmb3IgZGVwcmVjYXRpbmcgdGhpbmdzIGluIHRoZSBwcm9jZXNzIG9mIHN0YXJ0aW5nIHVwLgogIGlmIChpc1VuZGVmaW5lZChnbG9iYWwucHJvY2VzcykpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGV4cG9ydHMuZGVwcmVjYXRlKGZuLCBtc2cpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KCiAgaWYgKHByb2Nlc3Mubm9EZXByZWNhdGlvbiA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIGZuOwogIH0KCiAgdmFyIHdhcm5lZCA9IGZhbHNlOwogIGZ1bmN0aW9uIGRlcHJlY2F0ZWQoKSB7CiAgICBpZiAoIXdhcm5lZCkgewogICAgICBpZiAocHJvY2Vzcy50aHJvd0RlcHJlY2F0aW9uKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy50cmFjZURlcHJlY2F0aW9uKSB7CiAgICAgICAgY29uc29sZS50cmFjZShtc2cpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgfQogICAgICB3YXJuZWQgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQoKICByZXR1cm4gZGVwcmVjYXRlZDsKfTsKCgp2YXIgZGVidWdzID0ge307CnZhciBkZWJ1Z0Vudmlyb247CmV4cG9ydHMuZGVidWdsb2cgPSBmdW5jdGlvbihzZXQpIHsKICBpZiAoaXNVbmRlZmluZWQoZGVidWdFbnZpcm9uKSkKICAgIGRlYnVnRW52aXJvbiA9IHByb2Nlc3MuZW52Lk5PREVfREVCVUcgfHwgJyc7CiAgc2V0ID0gc2V0LnRvVXBwZXJDYXNlKCk7CiAgaWYgKCFkZWJ1Z3Nbc2V0XSkgewogICAgaWYgKG5ldyBSZWdFeHAoJ1xcYicgKyBzZXQgKyAnXFxiJywgJ2knKS50ZXN0KGRlYnVnRW52aXJvbikpIHsKICAgICAgdmFyIHBpZCA9IHByb2Nlc3MucGlkOwogICAgICBkZWJ1Z3Nbc2V0XSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBtc2cgPSBleHBvcnRzLmZvcm1hdC5hcHBseShleHBvcnRzLCBhcmd1bWVudHMpOwogICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzICVkOiAlcycsIHNldCwgcGlkLCBtc2cpOwogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgZGVidWdzW3NldF0gPSBmdW5jdGlvbigpIHt9OwogICAgfQogIH0KICByZXR1cm4gZGVidWdzW3NldF07Cn07CgoKLyoqCiAqIEVjaG9zIHRoZSB2YWx1ZSBvZiBhIHZhbHVlLiBUcnlzIHRvIHByaW50IHRoZSB2YWx1ZSBvdXQKICogaW4gdGhlIGJlc3Qgd2F5IHBvc3NpYmxlIGdpdmVuIHRoZSBkaWZmZXJlbnQgdHlwZXMuCiAqCiAqIEBwYXJhbSB7T2JqZWN0fSBvYmogVGhlIG9iamVjdCB0byBwcmludCBvdXQuCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIE9wdGlvbmFsIG9wdGlvbnMgb2JqZWN0IHRoYXQgYWx0ZXJzIHRoZSBvdXRwdXQuCiAqLwovKiBsZWdhY3k6IG9iaiwgc2hvd0hpZGRlbiwgZGVwdGgsIGNvbG9ycyovCmZ1bmN0aW9uIGluc3BlY3Qob2JqLCBvcHRzKSB7CiAgLy8gZGVmYXVsdCBvcHRpb25zCiAgdmFyIGN0eCA9IHsKICAgIHNlZW46IFtdLAogICAgc3R5bGl6ZTogc3R5bGl6ZU5vQ29sb3IKICB9OwogIC8vIGxlZ2FjeS4uLgogIGlmIChhcmd1bWVudHMubGVuZ3RoID49IDMpIGN0eC5kZXB0aCA9IGFyZ3VtZW50c1syXTsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+PSA0KSBjdHguY29sb3JzID0gYXJndW1lbnRzWzNdOwogIGlmIChpc0Jvb2xlYW4ob3B0cykpIHsKICAgIC8vIGxlZ2FjeS4uLgogICAgY3R4LnNob3dIaWRkZW4gPSBvcHRzOwogIH0gZWxzZSBpZiAob3B0cykgewogICAgLy8gZ290IGFuICJvcHRpb25zIiBvYmplY3QKICAgIGV4cG9ydHMuX2V4dGVuZChjdHgsIG9wdHMpOwogIH0KICAvLyBzZXQgZGVmYXVsdCBvcHRpb25zCiAgaWYgKGlzVW5kZWZpbmVkKGN0eC5zaG93SGlkZGVuKSkgY3R4LnNob3dIaWRkZW4gPSBmYWxzZTsKICBpZiAoaXNVbmRlZmluZWQoY3R4LmRlcHRoKSkgY3R4LmRlcHRoID0gMjsKICBpZiAoaXNVbmRlZmluZWQoY3R4LmNvbG9ycykpIGN0eC5jb2xvcnMgPSBmYWxzZTsKICBpZiAoaXNVbmRlZmluZWQoY3R4LmN1c3RvbUluc3BlY3QpKSBjdHguY3VzdG9tSW5zcGVjdCA9IHRydWU7CiAgaWYgKGN0eC5jb2xvcnMpIGN0eC5zdHlsaXplID0gc3R5bGl6ZVdpdGhDb2xvcjsKICByZXR1cm4gZm9ybWF0VmFsdWUoY3R4LCBvYmosIGN0eC5kZXB0aCk7Cn0KZXhwb3J0cy5pbnNwZWN0ID0gaW5zcGVjdDsKCgovLyBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0FOU0lfZXNjYXBlX2NvZGUjZ3JhcGhpY3MKaW5zcGVjdC5jb2xvcnMgPSB7CiAgJ2JvbGQnIDogWzEsIDIyXSwKICAnaXRhbGljJyA6IFszLCAyM10sCiAgJ3VuZGVybGluZScgOiBbNCwgMjRdLAogICdpbnZlcnNlJyA6IFs3LCAyN10sCiAgJ3doaXRlJyA6IFszNywgMzldLAogICdncmV5JyA6IFs5MCwgMzldLAogICdibGFjaycgOiBbMzAsIDM5XSwKICAnYmx1ZScgOiBbMzQsIDM5XSwKICAnY3lhbicgOiBbMzYsIDM5XSwKICAnZ3JlZW4nIDogWzMyLCAzOV0sCiAgJ21hZ2VudGEnIDogWzM1LCAzOV0sCiAgJ3JlZCcgOiBbMzEsIDM5XSwKICAneWVsbG93JyA6IFszMywgMzldCn07CgovLyBEb24ndCB1c2UgJ2JsdWUnIG5vdCB2aXNpYmxlIG9uIGNtZC5leGUKaW5zcGVjdC5zdHlsZXMgPSB7CiAgJ3NwZWNpYWwnOiAnY3lhbicsCiAgJ251bWJlcic6ICd5ZWxsb3cnLAogICdib29sZWFuJzogJ3llbGxvdycsCiAgJ3VuZGVmaW5lZCc6ICdncmV5JywKICAnbnVsbCc6ICdib2xkJywKICAnc3RyaW5nJzogJ2dyZWVuJywKICAnZGF0ZSc6ICdtYWdlbnRhJywKICAvLyAibmFtZSI6IGludGVudGlvbmFsbHkgbm90IHN0eWxpbmcKICAncmVnZXhwJzogJ3JlZCcKfTsKCgpmdW5jdGlvbiBzdHlsaXplV2l0aENvbG9yKHN0ciwgc3R5bGVUeXBlKSB7CiAgdmFyIHN0eWxlID0gaW5zcGVjdC5zdHlsZXNbc3R5bGVUeXBlXTsKCiAgaWYgKHN0eWxlKSB7CiAgICByZXR1cm4gJ1x1MDAxYlsnICsgaW5zcGVjdC5jb2xvcnNbc3R5bGVdWzBdICsgJ20nICsgc3RyICsKICAgICAgICAgICAnXHUwMDFiWycgKyBpbnNwZWN0LmNvbG9yc1tzdHlsZV1bMV0gKyAnbSc7CiAgfSBlbHNlIHsKICAgIHJldHVybiBzdHI7CiAgfQp9CgoKZnVuY3Rpb24gc3R5bGl6ZU5vQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICByZXR1cm4gc3RyOwp9CgoKZnVuY3Rpb24gYXJyYXlUb0hhc2goYXJyYXkpIHsKICB2YXIgaGFzaCA9IHt9OwoKICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uKHZhbCwgaWR4KSB7CiAgICBoYXNoW3ZhbF0gPSB0cnVlOwogIH0pOwoKICByZXR1cm4gaGFzaDsKfQoKCmZ1bmN0aW9uIGZvcm1hdFZhbHVlKGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcykgewogIC8vIFByb3ZpZGUgYSBob29rIGZvciB1c2VyLXNwZWNpZmllZCBpbnNwZWN0IGZ1bmN0aW9ucy4KICAvLyBDaGVjayB0aGF0IHZhbHVlIGlzIGFuIG9iamVjdCB3aXRoIGFuIGluc3BlY3QgZnVuY3Rpb24gb24gaXQKICBpZiAoY3R4LmN1c3RvbUluc3BlY3QgJiYKICAgICAgdmFsdWUgJiYKICAgICAgaXNGdW5jdGlvbih2YWx1ZS5pbnNwZWN0KSAmJgogICAgICAvLyBGaWx0ZXIgb3V0IHRoZSB1dGlsIG1vZHVsZSwgaXQncyBpbnNwZWN0IGZ1bmN0aW9uIGlzIHNwZWNpYWwKICAgICAgdmFsdWUuaW5zcGVjdCAhPT0gZXhwb3J0cy5pbnNwZWN0ICYmCiAgICAgIC8vIEFsc28gZmlsdGVyIG91dCBhbnkgcHJvdG90eXBlIG9iamVjdHMgdXNpbmcgdGhlIGNpcmN1bGFyIGNoZWNrLgogICAgICAhKHZhbHVlLmNvbnN0cnVjdG9yICYmIHZhbHVlLmNvbnN0cnVjdG9yLnByb3RvdHlwZSA9PT0gdmFsdWUpKSB7CiAgICB2YXIgcmV0ID0gdmFsdWUuaW5zcGVjdChyZWN1cnNlVGltZXMsIGN0eCk7CiAgICBpZiAoIWlzU3RyaW5nKHJldCkpIHsKICAgICAgcmV0ID0gZm9ybWF0VmFsdWUoY3R4LCByZXQsIHJlY3Vyc2VUaW1lcyk7CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KCiAgLy8gUHJpbWl0aXZlIHR5cGVzIGNhbm5vdCBoYXZlIHByb3BlcnRpZXMKICB2YXIgcHJpbWl0aXZlID0gZm9ybWF0UHJpbWl0aXZlKGN0eCwgdmFsdWUpOwogIGlmIChwcmltaXRpdmUpIHsKICAgIHJldHVybiBwcmltaXRpdmU7CiAgfQoKICAvLyBMb29rIHVwIHRoZSBrZXlzIG9mIHRoZSBvYmplY3QuCiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh2YWx1ZSk7CiAgdmFyIHZpc2libGVLZXlzID0gYXJyYXlUb0hhc2goa2V5cyk7CgogIGlmIChjdHguc2hvd0hpZGRlbikgewogICAga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHZhbHVlKTsKICB9CgogIC8vIElFIGRvZXNuJ3QgbWFrZSBlcnJvciBmaWVsZHMgbm9uLWVudW1lcmFibGUKICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvZHd3NTJzYnQodj12cy45NCkuYXNweAogIGlmIChpc0Vycm9yKHZhbHVlKQogICAgICAmJiAoa2V5cy5pbmRleE9mKCdtZXNzYWdlJykgPj0gMCB8fCBrZXlzLmluZGV4T2YoJ2Rlc2NyaXB0aW9uJykgPj0gMCkpIHsKICAgIHJldHVybiBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgfQoKICAvLyBTb21lIHR5cGUgb2Ygb2JqZWN0IHdpdGhvdXQgcHJvcGVydGllcyBjYW4gYmUgc2hvcnRjdXR0ZWQuCiAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgdmFyIG5hbWUgPSB2YWx1ZS5uYW1lID8gJzogJyArIHZhbHVlLm5hbWUgOiAnJzsKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCdbRnVuY3Rpb24nICsgbmFtZSArICddJywgJ3NwZWNpYWwnKTsKICAgIH0KICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdyZWdleHAnKTsKICAgIH0KICAgIGlmIChpc0RhdGUodmFsdWUpKSB7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZShEYXRlLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ2RhdGUnKTsKICAgIH0KICAgIGlmIChpc0Vycm9yKHZhbHVlKSkgewogICAgICByZXR1cm4gZm9ybWF0RXJyb3IodmFsdWUpOwogICAgfQogIH0KCiAgdmFyIGJhc2UgPSAnJywgYXJyYXkgPSBmYWxzZSwgYnJhY2VzID0gWyd7JywgJ30nXTsKCiAgLy8gTWFrZSBBcnJheSBzYXkgdGhhdCB0aGV5IGFyZSBBcnJheQogIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgYXJyYXkgPSB0cnVlOwogICAgYnJhY2VzID0gWydbJywgJ10nXTsKICB9CgogIC8vIE1ha2UgZnVuY3Rpb25zIHNheSB0aGF0IHRoZXkgYXJlIGZ1bmN0aW9ucwogIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgdmFyIG4gPSB2YWx1ZS5uYW1lID8gJzogJyArIHZhbHVlLm5hbWUgOiAnJzsKICAgIGJhc2UgPSAnIFtGdW5jdGlvbicgKyBuICsgJ10nOwogIH0KCiAgLy8gTWFrZSBSZWdFeHBzIHNheSB0aGF0IHRoZXkgYXJlIFJlZ0V4cHMKICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICBiYXNlID0gJyAnICsgUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICB9CgogIC8vIE1ha2UgZGF0ZXMgd2l0aCBwcm9wZXJ0aWVzIGZpcnN0IHNheSB0aGUgZGF0ZQogIGlmIChpc0RhdGUodmFsdWUpKSB7CiAgICBiYXNlID0gJyAnICsgRGF0ZS5wcm90b3R5cGUudG9VVENTdHJpbmcuY2FsbCh2YWx1ZSk7CiAgfQoKICAvLyBNYWtlIGVycm9yIHdpdGggbWVzc2FnZSBmaXJzdCBzYXkgdGhlIGVycm9yCiAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICBiYXNlID0gJyAnICsgZm9ybWF0RXJyb3IodmFsdWUpOwogIH0KCiAgaWYgKGtleXMubGVuZ3RoID09PSAwICYmICghYXJyYXkgfHwgdmFsdWUubGVuZ3RoID09IDApKSB7CiAgICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArIGJyYWNlc1sxXTsKICB9CgogIGlmIChyZWN1cnNlVGltZXMgPCAwKSB7CiAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ1tPYmplY3RdJywgJ3NwZWNpYWwnKTsKICAgIH0KICB9CgogIGN0eC5zZWVuLnB1c2godmFsdWUpOwoKICB2YXIgb3V0cHV0OwogIGlmIChhcnJheSkgewogICAgb3V0cHV0ID0gZm9ybWF0QXJyYXkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5cyk7CiAgfSBlbHNlIHsKICAgIG91dHB1dCA9IGtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICByZXR1cm4gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSk7CiAgICB9KTsKICB9CgogIGN0eC5zZWVuLnBvcCgpOwoKICByZXR1cm4gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpOwp9CgoKZnVuY3Rpb24gZm9ybWF0UHJpbWl0aXZlKGN0eCwgdmFsdWUpIHsKICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKQogICAgcmV0dXJuIGN0eC5zdHlsaXplKCd1bmRlZmluZWQnLCAndW5kZWZpbmVkJyk7CiAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgdmFyIHNpbXBsZSA9ICdcJycgKyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkucmVwbGFjZSgvXiJ8IiQvZywgJycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICciJykgKyAnXCcnOwogICAgcmV0dXJuIGN0eC5zdHlsaXplKHNpbXBsZSwgJ3N0cmluZycpOwogIH0KICBpZiAoaXNOdW1iZXIodmFsdWUpKQogICAgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdudW1iZXInKTsKICBpZiAoaXNCb29sZWFuKHZhbHVlKSkKICAgIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnYm9vbGVhbicpOwogIC8vIEZvciBzb21lIHJlYXNvbiB0eXBlb2YgbnVsbCBpcyAib2JqZWN0Iiwgc28gc3BlY2lhbCBjYXNlIGhlcmUuCiAgaWYgKGlzTnVsbCh2YWx1ZSkpCiAgICByZXR1cm4gY3R4LnN0eWxpemUoJ251bGwnLCAnbnVsbCcpOwp9CgoKZnVuY3Rpb24gZm9ybWF0RXJyb3IodmFsdWUpIHsKICByZXR1cm4gJ1snICsgRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpICsgJ10nOwp9CgoKZnVuY3Rpb24gZm9ybWF0QXJyYXkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5cykgewogIHZhciBvdXRwdXQgPSBbXTsKICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgaWYgKGhhc093blByb3BlcnR5KHZhbHVlLCBTdHJpbmcoaSkpKSB7CiAgICAgIG91dHB1dC5wdXNoKGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsCiAgICAgICAgICBTdHJpbmcoaSksIHRydWUpKTsKICAgIH0gZWxzZSB7CiAgICAgIG91dHB1dC5wdXNoKCcnKTsKICAgIH0KICB9CiAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgaWYgKCFrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgb3V0cHV0LnB1c2goZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywKICAgICAgICAgIGtleSwgdHJ1ZSkpOwogICAgfQogIH0pOwogIHJldHVybiBvdXRwdXQ7Cn0KCgpmdW5jdGlvbiBmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIGFycmF5KSB7CiAgdmFyIG5hbWUsIHN0ciwgZGVzYzsKICBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih2YWx1ZSwga2V5KSB8fCB7IHZhbHVlOiB2YWx1ZVtrZXldIH07CiAgaWYgKGRlc2MuZ2V0KSB7CiAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tHZXR0ZXIvU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICB9IGVsc2UgewogICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0dldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tTZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgIH0KICB9CiAgaWYgKCFoYXNPd25Qcm9wZXJ0eSh2aXNpYmxlS2V5cywga2V5KSkgewogICAgbmFtZSA9ICdbJyArIGtleSArICddJzsKICB9CiAgaWYgKCFzdHIpIHsKICAgIGlmIChjdHguc2Vlbi5pbmRleE9mKGRlc2MudmFsdWUpIDwgMCkgewogICAgICBpZiAoaXNOdWxsKHJlY3Vyc2VUaW1lcykpIHsKICAgICAgICBzdHIgPSBmb3JtYXRWYWx1ZShjdHgsIGRlc2MudmFsdWUsIG51bGwpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IGZvcm1hdFZhbHVlKGN0eCwgZGVzYy52YWx1ZSwgcmVjdXJzZVRpbWVzIC0gMSk7CiAgICAgIH0KICAgICAgaWYgKHN0ci5pbmRleE9mKCdcbicpID4gLTEpIHsKICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgIHN0ciA9IHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICByZXR1cm4gJyAgJyArIGxpbmU7CiAgICAgICAgICB9KS5qb2luKCdcbicpLnN1YnN0cigyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyID0gJ1xuJyArIHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICByZXR1cm4gJyAgICcgKyBsaW5lOwogICAgICAgICAgfSkuam9pbignXG4nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbQ2lyY3VsYXJdJywgJ3NwZWNpYWwnKTsKICAgIH0KICB9CiAgaWYgKGlzVW5kZWZpbmVkKG5hbWUpKSB7CiAgICBpZiAoYXJyYXkgJiYga2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgIHJldHVybiBzdHI7CiAgICB9CiAgICBuYW1lID0gSlNPTi5zdHJpbmdpZnkoJycgKyBrZXkpOwogICAgaWYgKG5hbWUubWF0Y2goL14iKFthLXpBLVpfXVthLXpBLVpfMC05XSopIiQvKSkgewogICAgICBuYW1lID0gbmFtZS5zdWJzdHIoMSwgbmFtZS5sZW5ndGggLSAyKTsKICAgICAgbmFtZSA9IGN0eC5zdHlsaXplKG5hbWUsICduYW1lJyk7CiAgICB9IGVsc2UgewogICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJyInKQogICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8oXiJ8IiQpL2csICInIik7CiAgICAgIG5hbWUgPSBjdHguc3R5bGl6ZShuYW1lLCAnc3RyaW5nJyk7CiAgICB9CiAgfQoKICByZXR1cm4gbmFtZSArICc6ICcgKyBzdHI7Cn0KCgpmdW5jdGlvbiByZWR1Y2VUb1NpbmdsZVN0cmluZyhvdXRwdXQsIGJhc2UsIGJyYWNlcykgewogIHZhciBudW1MaW5lc0VzdCA9IDA7CiAgdmFyIGxlbmd0aCA9IG91dHB1dC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgY3VyKSB7CiAgICBudW1MaW5lc0VzdCsrOwogICAgaWYgKGN1ci5pbmRleE9mKCdcbicpID49IDApIG51bUxpbmVzRXN0Kys7CiAgICByZXR1cm4gcHJldiArIGN1ci5yZXBsYWNlKC9cdTAwMWJcW1xkXGQ/bS9nLCAnJykubGVuZ3RoICsgMTsKICB9LCAwKTsKCiAgaWYgKGxlbmd0aCA+IDYwKSB7CiAgICByZXR1cm4gYnJhY2VzWzBdICsKICAgICAgICAgICAoYmFzZSA9PT0gJycgPyAnJyA6IGJhc2UgKyAnXG4gJykgKwogICAgICAgICAgICcgJyArCiAgICAgICAgICAgb3V0cHV0LmpvaW4oJyxcbiAgJykgKwogICAgICAgICAgICcgJyArCiAgICAgICAgICAgYnJhY2VzWzFdOwogIH0KCiAgcmV0dXJuIGJyYWNlc1swXSArIGJhc2UgKyAnICcgKyBvdXRwdXQuam9pbignLCAnKSArICcgJyArIGJyYWNlc1sxXTsKfQoKCi8vIE5PVEU6IFRoZXNlIHR5cGUgY2hlY2tpbmcgZnVuY3Rpb25zIGludGVudGlvbmFsbHkgZG9uJ3QgdXNlIGBpbnN0YW5jZW9mYAovLyBiZWNhdXNlIGl0IGlzIGZyYWdpbGUgYW5kIGNhbiBiZSBlYXNpbHkgZmFrZWQgd2l0aCBgT2JqZWN0LmNyZWF0ZSgpYC4KZnVuY3Rpb24gaXNBcnJheShhcikgewogIHJldHVybiBBcnJheS5pc0FycmF5KGFyKTsKfQpleHBvcnRzLmlzQXJyYXkgPSBpc0FycmF5OwoKZnVuY3Rpb24gaXNCb29sZWFuKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnYm9vbGVhbic7Cn0KZXhwb3J0cy5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CgpmdW5jdGlvbiBpc051bGwoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKfQpleHBvcnRzLmlzTnVsbCA9IGlzTnVsbDsKCmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKGFyZykgewogIHJldHVybiBhcmcgPT0gbnVsbDsKfQpleHBvcnRzLmlzTnVsbE9yVW5kZWZpbmVkID0gaXNOdWxsT3JVbmRlZmluZWQ7CgpmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7Cn0KZXhwb3J0cy5pc051bWJlciA9IGlzTnVtYmVyOwoKZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnOwp9CmV4cG9ydHMuaXNTdHJpbmcgPSBpc1N0cmluZzsKCmZ1bmN0aW9uIGlzU3ltYm9sKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3ltYm9sJzsKfQpleHBvcnRzLmlzU3ltYm9sID0gaXNTeW1ib2w7CgpmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gYXJnID09PSB2b2lkIDA7Cn0KZXhwb3J0cy5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwoKZnVuY3Rpb24gaXNSZWdFeHAocmUpIHsKICByZXR1cm4gaXNPYmplY3QocmUpICYmIG9iamVjdFRvU3RyaW5nKHJlKSA9PT0gJ1tvYmplY3QgUmVnRXhwXSc7Cn0KZXhwb3J0cy5pc1JlZ0V4cCA9IGlzUmVnRXhwOwoKZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKfQpleHBvcnRzLmlzT2JqZWN0ID0gaXNPYmplY3Q7CgpmdW5jdGlvbiBpc0RhdGUoZCkgewogIHJldHVybiBpc09iamVjdChkKSAmJiBvYmplY3RUb1N0cmluZyhkKSA9PT0gJ1tvYmplY3QgRGF0ZV0nOwp9CmV4cG9ydHMuaXNEYXRlID0gaXNEYXRlOwoKZnVuY3Rpb24gaXNFcnJvcihlKSB7CiAgcmV0dXJuIGlzT2JqZWN0KGUpICYmCiAgICAgIChvYmplY3RUb1N0cmluZyhlKSA9PT0gJ1tvYmplY3QgRXJyb3JdJyB8fCBlIGluc3RhbmNlb2YgRXJyb3IpOwp9CmV4cG9ydHMuaXNFcnJvciA9IGlzRXJyb3I7CgpmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwp9CmV4cG9ydHMuaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CgpmdW5jdGlvbiBpc1ByaW1pdGl2ZShhcmcpIHsKICByZXR1cm4gYXJnID09PSBudWxsIHx8CiAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJyB8fAogICAgICAgICB0eXBlb2YgYXJnID09PSAnbnVtYmVyJyB8fAogICAgICAgICB0eXBlb2YgYXJnID09PSAnc3RyaW5nJyB8fAogICAgICAgICB0eXBlb2YgYXJnID09PSAnc3ltYm9sJyB8fCAgLy8gRVM2IHN5bWJvbAogICAgICAgICB0eXBlb2YgYXJnID09PSAndW5kZWZpbmVkJzsKfQpleHBvcnRzLmlzUHJpbWl0aXZlID0gaXNQcmltaXRpdmU7CgpleHBvcnRzLmlzQnVmZmVyID0gcmVxdWlyZSgnLi9zdXBwb3J0L2lzQnVmZmVyJyk7CgpmdW5jdGlvbiBvYmplY3RUb1N0cmluZyhvKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvKTsKfQoKCmZ1bmN0aW9uIHBhZChuKSB7CiAgcmV0dXJuIG4gPCAxMCA/ICcwJyArIG4udG9TdHJpbmcoMTApIDogbi50b1N0cmluZygxMCk7Cn0KCgp2YXIgbW9udGhzID0gWydKYW4nLCAnRmViJywgJ01hcicsICdBcHInLCAnTWF5JywgJ0p1bicsICdKdWwnLCAnQXVnJywgJ1NlcCcsCiAgICAgICAgICAgICAgJ09jdCcsICdOb3YnLCAnRGVjJ107CgovLyAyNiBGZWIgMTY6MTk6MzQKZnVuY3Rpb24gdGltZXN0YW1wKCkgewogIHZhciBkID0gbmV3IERhdGUoKTsKICB2YXIgdGltZSA9IFtwYWQoZC5nZXRIb3VycygpKSwKICAgICAgICAgICAgICBwYWQoZC5nZXRNaW51dGVzKCkpLAogICAgICAgICAgICAgIHBhZChkLmdldFNlY29uZHMoKSldLmpvaW4oJzonKTsKICByZXR1cm4gW2QuZ2V0RGF0ZSgpLCBtb250aHNbZC5nZXRNb250aCgpXSwgdGltZV0uam9pbignICcpOwp9CgoKLy8gbG9nIGlzIGp1c3QgYSB0aGluIHdyYXBwZXIgdG8gY29uc29sZS5sb2cgdGhhdCBwcmVwZW5kcyBhIHRpbWVzdGFtcApleHBvcnRzLmxvZyA9IGZ1bmN0aW9uKCkgewogIGNvbnNvbGUubG9nKCclcyAtICVzJywgdGltZXN0YW1wKCksIGV4cG9ydHMuZm9ybWF0LmFwcGx5KGV4cG9ydHMsIGFyZ3VtZW50cykpOwp9OwoKCi8qKgogKiBJbmhlcml0IHRoZSBwcm90b3R5cGUgbWV0aG9kcyBmcm9tIG9uZSBjb25zdHJ1Y3RvciBpbnRvIGFub3RoZXIuCiAqCiAqIFRoZSBGdW5jdGlvbi5wcm90b3R5cGUuaW5oZXJpdHMgZnJvbSBsYW5nLmpzIHJld3JpdHRlbiBhcyBhIHN0YW5kYWxvbmUKICogZnVuY3Rpb24gKG5vdCBvbiBGdW5jdGlvbi5wcm90b3R5cGUpLiBOT1RFOiBJZiB0aGlzIGZpbGUgaXMgdG8gYmUgbG9hZGVkCiAqIGR1cmluZyBib290c3RyYXBwaW5nIHRoaXMgZnVuY3Rpb24gbmVlZHMgdG8gYmUgcmV3cml0dGVuIHVzaW5nIHNvbWUgbmF0aXZlCiAqIGZ1bmN0aW9ucyBhcyBwcm90b3R5cGUgc2V0dXAgdXNpbmcgbm9ybWFsIEphdmFTY3JpcHQgZG9lcyBub3Qgd29yayBhcwogKiBleHBlY3RlZCBkdXJpbmcgYm9vdHN0cmFwcGluZyAoc2VlIG1pcnJvci5qcyBpbiByMTE0OTAzKS4KICoKICogQHBhcmFtIHtmdW5jdGlvbn0gY3RvciBDb25zdHJ1Y3RvciBmdW5jdGlvbiB3aGljaCBuZWVkcyB0byBpbmhlcml0IHRoZQogKiAgICAgcHJvdG90eXBlLgogKiBAcGFyYW0ge2Z1bmN0aW9ufSBzdXBlckN0b3IgQ29uc3RydWN0b3IgZnVuY3Rpb24gdG8gaW5oZXJpdCBwcm90b3R5cGUgZnJvbS4KICovCmV4cG9ydHMuaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwoKZXhwb3J0cy5fZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luLCBhZGQpIHsKICAvLyBEb24ndCBkbyBhbnl0aGluZyBpZiBhZGQgaXNuJ3QgYW4gb2JqZWN0CiAgaWYgKCFhZGQgfHwgIWlzT2JqZWN0KGFkZCkpIHJldHVybiBvcmlnaW47CgogIHZhciBrZXlzID0gT2JqZWN0LmtleXMoYWRkKTsKICB2YXIgaSA9IGtleXMubGVuZ3RoOwogIHdoaWxlIChpLS0pIHsKICAgIG9yaWdpbltrZXlzW2ldXSA9IGFkZFtrZXlzW2ldXTsKICB9CiAgcmV0dXJuIG9yaWdpbjsKfTsKCmZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKfQoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpLHR5cGVvZiBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgIT09ICJ1bmRlZmluZWQiID8gX193ZWJwYWNrX3JlcXVpcmVfXy5nIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCn0seyIuL3N1cHBvcnQvaXNCdWZmZXIiOjgyLCJfcHJvY2VzcyI6ODksImluaGVyaXRzIjo4MX1dLDg0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChnbG9iYWwsQnVmZmVyKXsoZnVuY3Rpb24gKCl7Ci8qIQogKiBUaGUgYnVmZmVyIG1vZHVsZSBmcm9tIG5vZGUuanMsIGZvciB0aGUgYnJvd3Nlci4KICoKICogQGF1dGhvciAgIEZlcm9zcyBBYm91a2hhZGlqZWggPGh0dHA6Ly9mZXJvc3Mub3JnPgogKiBAbGljZW5zZSAgTUlUCiAqLwovKiBlc2xpbnQtZGlzYWJsZSBuby1wcm90byAqLwoKJ3VzZSBzdHJpY3QnCgp2YXIgYmFzZTY0ID0gcmVxdWlyZSgnYmFzZTY0LWpzJykKdmFyIGllZWU3NTQgPSByZXF1aXJlKCdpZWVlNzU0JykKdmFyIGlzQXJyYXkgPSByZXF1aXJlKCdpc2FycmF5JykKCmV4cG9ydHMuQnVmZmVyID0gQnVmZmVyCmV4cG9ydHMuU2xvd0J1ZmZlciA9IFNsb3dCdWZmZXIKZXhwb3J0cy5JTlNQRUNUX01BWF9CWVRFUyA9IDUwCgovKioKICogSWYgYEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUYDoKICogICA9PT0gdHJ1ZSAgICBVc2UgVWludDhBcnJheSBpbXBsZW1lbnRhdGlvbiAoZmFzdGVzdCkKICogICA9PT0gZmFsc2UgICBVc2UgT2JqZWN0IGltcGxlbWVudGF0aW9uIChtb3N0IGNvbXBhdGlibGUsIGV2ZW4gSUU2KQogKgogKiBCcm93c2VycyB0aGF0IHN1cHBvcnQgdHlwZWQgYXJyYXlzIGFyZSBJRSAxMCssIEZpcmVmb3ggNCssIENocm9tZSA3KywgU2FmYXJpIDUuMSssCiAqIE9wZXJhIDExLjYrLCBpT1MgNC4yKy4KICoKICogRHVlIHRvIHZhcmlvdXMgYnJvd3NlciBidWdzLCBzb21ldGltZXMgdGhlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiB3aWxsIGJlIHVzZWQgZXZlbgogKiB3aGVuIHRoZSBicm93c2VyIHN1cHBvcnRzIHR5cGVkIGFycmF5cy4KICoKICogTm90ZToKICoKICogICAtIEZpcmVmb3ggNC0yOSBsYWNrcyBzdXBwb3J0IGZvciBhZGRpbmcgbmV3IHByb3BlcnRpZXMgdG8gYFVpbnQ4QXJyYXlgIGluc3RhbmNlcywKICogICAgIFNlZTogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njk1NDM4LgogKgogKiAgIC0gQ2hyb21lIDktMTAgaXMgbWlzc2luZyB0aGUgYFR5cGVkQXJyYXkucHJvdG90eXBlLnN1YmFycmF5YCBmdW5jdGlvbi4KICoKICogICAtIElFMTAgaGFzIGEgYnJva2VuIGBUeXBlZEFycmF5LnByb3RvdHlwZS5zdWJhcnJheWAgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhcnJheXMgb2YKICogICAgIGluY29ycmVjdCBsZW5ndGggaW4gc29tZSBzaXR1YXRpb25zLgoKICogV2UgZGV0ZWN0IHRoZXNlIGJ1Z2d5IGJyb3dzZXJzIGFuZCBzZXQgYEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUYCB0byBgZmFsc2VgIHNvIHRoZXkKICogZ2V0IHRoZSBPYmplY3QgaW1wbGVtZW50YXRpb24sIHdoaWNoIGlzIHNsb3dlciBidXQgYmVoYXZlcyBjb3JyZWN0bHkuCiAqLwpCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCA9IGdsb2JhbC5UWVBFRF9BUlJBWV9TVVBQT1JUICE9PSB1bmRlZmluZWQKICA/IGdsb2JhbC5UWVBFRF9BUlJBWV9TVVBQT1JUCiAgOiB0eXBlZEFycmF5U3VwcG9ydCgpCgovKgogKiBFeHBvcnQga01heExlbmd0aCBhZnRlciB0eXBlZCBhcnJheSBzdXBwb3J0IGlzIGRldGVybWluZWQuCiAqLwpleHBvcnRzLmtNYXhMZW5ndGggPSBrTWF4TGVuZ3RoKCkKCmZ1bmN0aW9uIHR5cGVkQXJyYXlTdXBwb3J0ICgpIHsKICB0cnkgewogICAgdmFyIGFyciA9IG5ldyBVaW50OEFycmF5KDEpCiAgICBhcnIuX19wcm90b19fID0ge19fcHJvdG9fXzogVWludDhBcnJheS5wcm90b3R5cGUsIGZvbzogZnVuY3Rpb24gKCkgeyByZXR1cm4gNDIgfX0KICAgIHJldHVybiBhcnIuZm9vKCkgPT09IDQyICYmIC8vIHR5cGVkIGFycmF5IGluc3RhbmNlcyBjYW4gYmUgYXVnbWVudGVkCiAgICAgICAgdHlwZW9mIGFyci5zdWJhcnJheSA9PT0gJ2Z1bmN0aW9uJyAmJiAvLyBjaHJvbWUgOS0xMCBsYWNrIGBzdWJhcnJheWAKICAgICAgICBhcnIuc3ViYXJyYXkoMSwgMSkuYnl0ZUxlbmd0aCA9PT0gMCAvLyBpZTEwIGhhcyBicm9rZW4gYHN1YmFycmF5YAogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiBmYWxzZQogIH0KfQoKZnVuY3Rpb24ga01heExlbmd0aCAoKSB7CiAgcmV0dXJuIEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUCiAgICA/IDB4N2ZmZmZmZmYKICAgIDogMHgzZmZmZmZmZgp9CgpmdW5jdGlvbiBjcmVhdGVCdWZmZXIgKHRoYXQsIGxlbmd0aCkgewogIGlmIChrTWF4TGVuZ3RoKCkgPCBsZW5ndGgpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIHR5cGVkIGFycmF5IGxlbmd0aCcpCiAgfQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgLy8gUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UsIGZvciBiZXN0IHBlcmZvcm1hbmNlCiAgICB0aGF0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKQogICAgdGhhdC5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgfSBlbHNlIHsKICAgIC8vIEZhbGxiYWNrOiBSZXR1cm4gYW4gb2JqZWN0IGluc3RhbmNlIG9mIHRoZSBCdWZmZXIgY2xhc3MKICAgIGlmICh0aGF0ID09PSBudWxsKSB7CiAgICAgIHRoYXQgPSBuZXcgQnVmZmVyKGxlbmd0aCkKICAgIH0KICAgIHRoYXQubGVuZ3RoID0gbGVuZ3RoCiAgfQoKICByZXR1cm4gdGhhdAp9CgovKioKICogVGhlIEJ1ZmZlciBjb25zdHJ1Y3RvciByZXR1cm5zIGluc3RhbmNlcyBvZiBgVWludDhBcnJheWAgdGhhdCBoYXZlIHRoZWlyCiAqIHByb3RvdHlwZSBjaGFuZ2VkIHRvIGBCdWZmZXIucHJvdG90eXBlYC4gRnVydGhlcm1vcmUsIGBCdWZmZXJgIGlzIGEgc3ViY2xhc3Mgb2YKICogYFVpbnQ4QXJyYXlgLCBzbyB0aGUgcmV0dXJuZWQgaW5zdGFuY2VzIHdpbGwgaGF2ZSBhbGwgdGhlIG5vZGUgYEJ1ZmZlcmAgbWV0aG9kcwogKiBhbmQgdGhlIGBVaW50OEFycmF5YCBtZXRob2RzLiBTcXVhcmUgYnJhY2tldCBub3RhdGlvbiB3b3JrcyBhcyBleHBlY3RlZCAtLSBpdAogKiByZXR1cm5zIGEgc2luZ2xlIG9jdGV0LgogKgogKiBUaGUgYFVpbnQ4QXJyYXlgIHByb3RvdHlwZSByZW1haW5zIHVubW9kaWZpZWQuCiAqLwoKZnVuY3Rpb24gQnVmZmVyIChhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgJiYgISh0aGlzIGluc3RhbmNlb2YgQnVmZmVyKSkgewogICAgcmV0dXJuIG5ldyBCdWZmZXIoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCiAgfQoKICAvLyBDb21tb24gY2FzZS4KICBpZiAodHlwZW9mIGFyZyA9PT0gJ251bWJlcicpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmdPck9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICdJZiBlbmNvZGluZyBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycKICAgICAgKQogICAgfQogICAgcmV0dXJuIGFsbG9jVW5zYWZlKHRoaXMsIGFyZykKICB9CiAgcmV0dXJuIGZyb20odGhpcywgYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCn0KCkJ1ZmZlci5wb29sU2l6ZSA9IDgxOTIgLy8gbm90IHVzZWQgYnkgdGhpcyBpbXBsZW1lbnRhdGlvbgoKLy8gVE9ETzogTGVnYWN5LCBub3QgbmVlZGVkIGFueW1vcmUuIFJlbW92ZSBpbiBuZXh0IG1ham9yIHZlcnNpb24uCkJ1ZmZlci5fYXVnbWVudCA9IGZ1bmN0aW9uIChhcnIpIHsKICBhcnIuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogIHJldHVybiBhcnIKfQoKZnVuY3Rpb24gZnJvbSAodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIGEgbnVtYmVyJykKICB9CgogIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgIHJldHVybiBmcm9tQXJyYXlCdWZmZXIodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICB9CgogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gZnJvbVN0cmluZyh0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCkKICB9CgogIHJldHVybiBmcm9tT2JqZWN0KHRoYXQsIHZhbHVlKQp9CgovKioKICogRnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG8gQnVmZmVyKGFyZywgZW5jb2RpbmcpIGJ1dCB0aHJvd3MgYSBUeXBlRXJyb3IKICogaWYgdmFsdWUgaXMgYSBudW1iZXIuCiAqIEJ1ZmZlci5mcm9tKHN0clssIGVuY29kaW5nXSkKICogQnVmZmVyLmZyb20oYXJyYXkpCiAqIEJ1ZmZlci5mcm9tKGJ1ZmZlcikKICogQnVmZmVyLmZyb20oYXJyYXlCdWZmZXJbLCBieXRlT2Zmc2V0WywgbGVuZ3RoXV0pCiAqKi8KQnVmZmVyLmZyb20gPSBmdW5jdGlvbiAodmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBmcm9tKG51bGwsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpCn0KCmlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogIEJ1ZmZlci5wcm90b3R5cGUuX19wcm90b19fID0gVWludDhBcnJheS5wcm90b3R5cGUKICBCdWZmZXIuX19wcm90b19fID0gVWludDhBcnJheQogIGlmICh0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBTeW1ib2wuc3BlY2llcyAmJgogICAgICBCdWZmZXJbU3ltYm9sLnNwZWNpZXNdID09PSBCdWZmZXIpIHsKICAgIC8vIEZpeCBzdWJhcnJheSgpIGluIEVTMjAxNi4gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL2J1ZmZlci9wdWxsLzk3CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQnVmZmVyLCBTeW1ib2wuc3BlY2llcywgewogICAgICB2YWx1ZTogbnVsbCwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICB9KQogIH0KfQoKZnVuY3Rpb24gYXNzZXJ0U2l6ZSAoc2l6ZSkgewogIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJzaXplIiBhcmd1bWVudCBtdXN0IGJlIGEgbnVtYmVyJykKICB9IGVsc2UgaWYgKHNpemUgPCAwKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIG5lZ2F0aXZlJykKICB9Cn0KCmZ1bmN0aW9uIGFsbG9jICh0aGF0LCBzaXplLCBmaWxsLCBlbmNvZGluZykgewogIGFzc2VydFNpemUoc2l6ZSkKICBpZiAoc2l6ZSA8PSAwKSB7CiAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpCiAgfQogIGlmIChmaWxsICE9PSB1bmRlZmluZWQpIHsKICAgIC8vIE9ubHkgcGF5IGF0dGVudGlvbiB0byBlbmNvZGluZyBpZiBpdCdzIGEgc3RyaW5nLiBUaGlzCiAgICAvLyBwcmV2ZW50cyBhY2NpZGVudGFsbHkgc2VuZGluZyBpbiBhIG51bWJlciB0aGF0IHdvdWxkCiAgICAvLyBiZSBpbnRlcnByZXR0ZWQgYXMgYSBzdGFydCBvZmZzZXQuCiAgICByZXR1cm4gdHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJwogICAgICA/IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKS5maWxsKGZpbGwsIGVuY29kaW5nKQogICAgICA6IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKS5maWxsKGZpbGwpCiAgfQogIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkKfQoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICogYWxsb2Moc2l6ZVssIGZpbGxbLCBlbmNvZGluZ11dKQogKiovCkJ1ZmZlci5hbGxvYyA9IGZ1bmN0aW9uIChzaXplLCBmaWxsLCBlbmNvZGluZykgewogIHJldHVybiBhbGxvYyhudWxsLCBzaXplLCBmaWxsLCBlbmNvZGluZykKfQoKZnVuY3Rpb24gYWxsb2NVbnNhZmUgKHRoYXQsIHNpemUpIHsKICBhc3NlcnRTaXplKHNpemUpCiAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplIDwgMCA/IDAgOiBjaGVja2VkKHNpemUpIHwgMCkKICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpemU7ICsraSkgewogICAgICB0aGF0W2ldID0gMAogICAgfQogIH0KICByZXR1cm4gdGhhdAp9CgovKioKICogRXF1aXZhbGVudCB0byBCdWZmZXIobnVtKSwgYnkgZGVmYXVsdCBjcmVhdGVzIGEgbm9uLXplcm8tZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICogKi8KQnVmZmVyLmFsbG9jVW5zYWZlID0gZnVuY3Rpb24gKHNpemUpIHsKICByZXR1cm4gYWxsb2NVbnNhZmUobnVsbCwgc2l6ZSkKfQovKioKICogRXF1aXZhbGVudCB0byBTbG93QnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAqLwpCdWZmZXIuYWxsb2NVbnNhZmVTbG93ID0gZnVuY3Rpb24gKHNpemUpIHsKICByZXR1cm4gYWxsb2NVbnNhZmUobnVsbCwgc2l6ZSkKfQoKZnVuY3Rpb24gZnJvbVN0cmluZyAodGhhdCwgc3RyaW5nLCBlbmNvZGluZykgewogIGlmICh0eXBlb2YgZW5jb2RpbmcgIT09ICdzdHJpbmcnIHx8IGVuY29kaW5nID09PSAnJykgewogICAgZW5jb2RpbmcgPSAndXRmOCcKICB9CgogIGlmICghQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCciZW5jb2RpbmciIG11c3QgYmUgYSB2YWxpZCBzdHJpbmcgZW5jb2RpbmcnKQogIH0KCiAgdmFyIGxlbmd0aCA9IGJ5dGVMZW5ndGgoc3RyaW5nLCBlbmNvZGluZykgfCAwCiAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW5ndGgpCgogIHZhciBhY3R1YWwgPSB0aGF0LndyaXRlKHN0cmluZywgZW5jb2RpbmcpCgogIGlmIChhY3R1YWwgIT09IGxlbmd0aCkgewogICAgLy8gV3JpdGluZyBhIGhleCBzdHJpbmcsIGZvciBleGFtcGxlLCB0aGF0IGNvbnRhaW5zIGludmFsaWQgY2hhcmFjdGVycyB3aWxsCiAgICAvLyBjYXVzZSBldmVyeXRoaW5nIGFmdGVyIHRoZSBmaXJzdCBpbnZhbGlkIGNoYXJhY3RlciB0byBiZSBpZ25vcmVkLiAoZS5nLgogICAgLy8gJ2FieHhjZCcgd2lsbCBiZSB0cmVhdGVkIGFzICdhYicpCiAgICB0aGF0ID0gdGhhdC5zbGljZSgwLCBhY3R1YWwpCiAgfQoKICByZXR1cm4gdGhhdAp9CgpmdW5jdGlvbiBmcm9tQXJyYXlMaWtlICh0aGF0LCBhcnJheSkgewogIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGggPCAwID8gMCA6IGNoZWNrZWQoYXJyYXkubGVuZ3RoKSB8IDAKICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbmd0aCkKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7CiAgICB0aGF0W2ldID0gYXJyYXlbaV0gJiAyNTUKICB9CiAgcmV0dXJuIHRoYXQKfQoKZnVuY3Rpb24gZnJvbUFycmF5QnVmZmVyICh0aGF0LCBhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKSB7CiAgYXJyYXkuYnl0ZUxlbmd0aCAvLyB0aGlzIHRocm93cyBpZiBgYXJyYXlgIGlzIG5vdCBhIHZhbGlkIEFycmF5QnVmZmVyCgogIGlmIChieXRlT2Zmc2V0IDwgMCB8fCBhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1wnb2Zmc2V0XCcgaXMgb3V0IG9mIGJvdW5kcycpCiAgfQoKICBpZiAoYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQgKyAobGVuZ3RoIHx8IDApKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignXCdsZW5ndGhcJyBpcyBvdXQgb2YgYm91bmRzJykKICB9CgogIGlmIChieXRlT2Zmc2V0ID09PSB1bmRlZmluZWQgJiYgbGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXkpCiAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCkKICB9IGVsc2UgewogICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKQogIH0KCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZSwgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgIHRoYXQgPSBhcnJheQogICAgdGhhdC5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgfSBlbHNlIHsKICAgIC8vIEZhbGxiYWNrOiBSZXR1cm4gYW4gb2JqZWN0IGluc3RhbmNlIG9mIHRoZSBCdWZmZXIgY2xhc3MKICAgIHRoYXQgPSBmcm9tQXJyYXlMaWtlKHRoYXQsIGFycmF5KQogIH0KICByZXR1cm4gdGhhdAp9CgpmdW5jdGlvbiBmcm9tT2JqZWN0ICh0aGF0LCBvYmopIHsKICBpZiAoQnVmZmVyLmlzQnVmZmVyKG9iaikpIHsKICAgIHZhciBsZW4gPSBjaGVja2VkKG9iai5sZW5ndGgpIHwgMAogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW4pCgogICAgaWYgKHRoYXQubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiB0aGF0CiAgICB9CgogICAgb2JqLmNvcHkodGhhdCwgMCwgMCwgbGVuKQogICAgcmV0dXJuIHRoYXQKICB9CgogIGlmIChvYmopIHsKICAgIGlmICgodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJgogICAgICAgIG9iai5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgfHwgJ2xlbmd0aCcgaW4gb2JqKSB7CiAgICAgIGlmICh0eXBlb2Ygb2JqLmxlbmd0aCAhPT0gJ251bWJlcicgfHwgaXNuYW4ob2JqLmxlbmd0aCkpIHsKICAgICAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIDApCiAgICAgIH0KICAgICAgcmV0dXJuIGZyb21BcnJheUxpa2UodGhhdCwgb2JqKQogICAgfQoKICAgIGlmIChvYmoudHlwZSA9PT0gJ0J1ZmZlcicgJiYgaXNBcnJheShvYmouZGF0YSkpIHsKICAgICAgcmV0dXJuIGZyb21BcnJheUxpa2UodGhhdCwgb2JqLmRhdGEpCiAgICB9CiAgfQoKICB0aHJvdyBuZXcgVHlwZUVycm9yKCdGaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nLCBCdWZmZXIsIEFycmF5QnVmZmVyLCBBcnJheSwgb3IgYXJyYXktbGlrZSBvYmplY3QuJykKfQoKZnVuY3Rpb24gY2hlY2tlZCAobGVuZ3RoKSB7CiAgLy8gTm90ZTogY2Fubm90IHVzZSBgbGVuZ3RoIDwga01heExlbmd0aCgpYCBoZXJlIGJlY2F1c2UgdGhhdCBmYWlscyB3aGVuCiAgLy8gbGVuZ3RoIGlzIE5hTiAod2hpY2ggaXMgb3RoZXJ3aXNlIGNvZXJjZWQgdG8gemVyby4pCiAgaWYgKGxlbmd0aCA+PSBrTWF4TGVuZ3RoKCkpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgJ3NpemU6IDB4JyArIGtNYXhMZW5ndGgoKS50b1N0cmluZygxNikgKyAnIGJ5dGVzJykKICB9CiAgcmV0dXJuIGxlbmd0aCB8IDAKfQoKZnVuY3Rpb24gU2xvd0J1ZmZlciAobGVuZ3RoKSB7CiAgaWYgKCtsZW5ndGggIT0gbGVuZ3RoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZXFlcWVxCiAgICBsZW5ndGggPSAwCiAgfQogIHJldHVybiBCdWZmZXIuYWxsb2MoK2xlbmd0aCkKfQoKQnVmZmVyLmlzQnVmZmVyID0gZnVuY3Rpb24gaXNCdWZmZXIgKGIpIHsKICByZXR1cm4gISEoYiAhPSBudWxsICYmIGIuX2lzQnVmZmVyKQp9CgpCdWZmZXIuY29tcGFyZSA9IGZ1bmN0aW9uIGNvbXBhcmUgKGEsIGIpIHsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihhKSB8fCAhQnVmZmVyLmlzQnVmZmVyKGIpKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudHMgbXVzdCBiZSBCdWZmZXJzJykKICB9CgogIGlmIChhID09PSBiKSByZXR1cm4gMAoKICB2YXIgeCA9IGEubGVuZ3RoCiAgdmFyIHkgPSBiLmxlbmd0aAoKICBmb3IgKHZhciBpID0gMCwgbGVuID0gTWF0aC5taW4oeCwgeSk7IGkgPCBsZW47ICsraSkgewogICAgaWYgKGFbaV0gIT09IGJbaV0pIHsKICAgICAgeCA9IGFbaV0KICAgICAgeSA9IGJbaV0KICAgICAgYnJlYWsKICAgIH0KICB9CgogIGlmICh4IDwgeSkgcmV0dXJuIC0xCiAgaWYgKHkgPCB4KSByZXR1cm4gMQogIHJldHVybiAwCn0KCkJ1ZmZlci5pc0VuY29kaW5nID0gZnVuY3Rpb24gaXNFbmNvZGluZyAoZW5jb2RpbmcpIHsKICBzd2l0Y2ggKFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKSkgewogICAgY2FzZSAnaGV4JzoKICAgIGNhc2UgJ3V0ZjgnOgogICAgY2FzZSAndXRmLTgnOgogICAgY2FzZSAnYXNjaWknOgogICAgY2FzZSAnbGF0aW4xJzoKICAgIGNhc2UgJ2JpbmFyeSc6CiAgICBjYXNlICdiYXNlNjQnOgogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgcmV0dXJuIHRydWUKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBmYWxzZQogIH0KfQoKQnVmZmVyLmNvbmNhdCA9IGZ1bmN0aW9uIGNvbmNhdCAobGlzdCwgbGVuZ3RoKSB7CiAgaWYgKCFpc0FycmF5KGxpc3QpKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJykKICB9CgogIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIEJ1ZmZlci5hbGxvYygwKQogIH0KCiAgdmFyIGkKICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgIGxlbmd0aCA9IDAKICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICAgIGxlbmd0aCArPSBsaXN0W2ldLmxlbmd0aAogICAgfQogIH0KCiAgdmFyIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShsZW5ndGgpCiAgdmFyIHBvcyA9IDAKICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgdmFyIGJ1ZiA9IGxpc3RbaV0KICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCiAgICB9CiAgICBidWYuY29weShidWZmZXIsIHBvcykKICAgIHBvcyArPSBidWYubGVuZ3RoCiAgfQogIHJldHVybiBidWZmZXIKfQoKZnVuY3Rpb24gYnl0ZUxlbmd0aCAoc3RyaW5nLCBlbmNvZGluZykgewogIGlmIChCdWZmZXIuaXNCdWZmZXIoc3RyaW5nKSkgewogICAgcmV0dXJuIHN0cmluZy5sZW5ndGgKICB9CiAgaWYgKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAoQXJyYXlCdWZmZXIuaXNWaWV3KHN0cmluZykgfHwgc3RyaW5nIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpKSB7CiAgICByZXR1cm4gc3RyaW5nLmJ5dGVMZW5ndGgKICB9CiAgaWYgKHR5cGVvZiBzdHJpbmcgIT09ICdzdHJpbmcnKSB7CiAgICBzdHJpbmcgPSAnJyArIHN0cmluZwogIH0KCiAgdmFyIGxlbiA9IHN0cmluZy5sZW5ndGgKICBpZiAobGVuID09PSAwKSByZXR1cm4gMAoKICAvLyBVc2UgYSBmb3IgbG9vcCB0byBhdm9pZCByZWN1cnNpb24KICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogIGZvciAoOzspIHsKICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgY2FzZSAnYXNjaWknOgogICAgICBjYXNlICdsYXRpbjEnOgogICAgICBjYXNlICdiaW5hcnknOgogICAgICAgIHJldHVybiBsZW4KICAgICAgY2FzZSAndXRmOCc6CiAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgICAgcmV0dXJuIHV0ZjhUb0J5dGVzKHN0cmluZykubGVuZ3RoCiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgcmV0dXJuIGxlbiAqIDIKICAgICAgY2FzZSAnaGV4JzoKICAgICAgICByZXR1cm4gbGVuID4+PiAxCiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgcmV0dXJuIGJhc2U2NFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGgKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAobG93ZXJlZENhc2UpIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aCAvLyBhc3N1bWUgdXRmOAogICAgICAgIGVuY29kaW5nID0gKCcnICsgZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgIH0KICB9Cn0KQnVmZmVyLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoCgpmdW5jdGlvbiBzbG93VG9TdHJpbmcgKGVuY29kaW5nLCBzdGFydCwgZW5kKSB7CiAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKCiAgLy8gTm8gbmVlZCB0byB2ZXJpZnkgdGhhdCAidGhpcy5sZW5ndGggPD0gTUFYX1VJTlQzMiIgc2luY2UgaXQncyBhIHJlYWQtb25seQogIC8vIHByb3BlcnR5IG9mIGEgdHlwZWQgYXJyYXkuCgogIC8vIFRoaXMgYmVoYXZlcyBuZWl0aGVyIGxpa2UgU3RyaW5nIG5vciBVaW50OEFycmF5IGluIHRoYXQgd2Ugc2V0IHN0YXJ0L2VuZAogIC8vIHRvIHRoZWlyIHVwcGVyL2xvd2VyIGJvdW5kcyBpZiB0aGUgdmFsdWUgcGFzc2VkIGlzIG91dCBvZiByYW5nZS4KICAvLyB1bmRlZmluZWQgaXMgaGFuZGxlZCBzcGVjaWFsbHkgYXMgcGVyIEVDTUEtMjYyIDZ0aCBFZGl0aW9uLAogIC8vIFNlY3Rpb24gMTMuMy4zLjcgUnVudGltZSBTZW1hbnRpY3M6IEtleWVkQmluZGluZ0luaXRpYWxpemF0aW9uLgogIGlmIChzdGFydCA9PT0gdW5kZWZpbmVkIHx8IHN0YXJ0IDwgMCkgewogICAgc3RhcnQgPSAwCiAgfQogIC8vIFJldHVybiBlYXJseSBpZiBzdGFydCA+IHRoaXMubGVuZ3RoLiBEb25lIGhlcmUgdG8gcHJldmVudCBwb3RlbnRpYWwgdWludDMyCiAgLy8gY29lcmNpb24gZmFpbCBiZWxvdy4KICBpZiAoc3RhcnQgPiB0aGlzLmxlbmd0aCkgewogICAgcmV0dXJuICcnCiAgfQoKICBpZiAoZW5kID09PSB1bmRlZmluZWQgfHwgZW5kID4gdGhpcy5sZW5ndGgpIHsKICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgfQoKICBpZiAoZW5kIDw9IDApIHsKICAgIHJldHVybiAnJwogIH0KCiAgLy8gRm9yY2UgY29lcnNpb24gdG8gdWludDMyLiBUaGlzIHdpbGwgYWxzbyBjb2VyY2UgZmFsc2V5L05hTiB2YWx1ZXMgdG8gMC4KICBlbmQgPj4+PSAwCiAgc3RhcnQgPj4+PSAwCgogIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgIHJldHVybiAnJwogIH0KCiAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCcKCiAgd2hpbGUgKHRydWUpIHsKICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgY2FzZSAnaGV4JzoKICAgICAgICByZXR1cm4gaGV4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgIHJldHVybiBhc2NpaVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBjYXNlICdsYXRpbjEnOgogICAgICBjYXNlICdiaW5hcnknOgogICAgICAgIHJldHVybiBsYXRpbjFTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICByZXR1cm4gYmFzZTY0U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgcmV0dXJuIHV0ZjE2bGVTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAobG93ZXJlZENhc2UpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgICBlbmNvZGluZyA9IChlbmNvZGluZyArICcnKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICB9CiAgfQp9CgovLyBUaGUgcHJvcGVydHkgaXMgdXNlZCBieSBgQnVmZmVyLmlzQnVmZmVyYCBhbmQgYGlzLWJ1ZmZlcmAgKGluIFNhZmFyaSA1LTcpIHRvIGRldGVjdAovLyBCdWZmZXIgaW5zdGFuY2VzLgpCdWZmZXIucHJvdG90eXBlLl9pc0J1ZmZlciA9IHRydWUKCmZ1bmN0aW9uIHN3YXAgKGIsIG4sIG0pIHsKICB2YXIgaSA9IGJbbl0KICBiW25dID0gYlttXQogIGJbbV0gPSBpCn0KCkJ1ZmZlci5wcm90b3R5cGUuc3dhcDE2ID0gZnVuY3Rpb24gc3dhcDE2ICgpIHsKICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICBpZiAobGVuICUgMiAhPT0gMCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNi1iaXRzJykKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikgewogICAgc3dhcCh0aGlzLCBpLCBpICsgMSkKICB9CiAgcmV0dXJuIHRoaXMKfQoKQnVmZmVyLnByb3RvdHlwZS5zd2FwMzIgPSBmdW5jdGlvbiBzd2FwMzIgKCkgewogIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogIGlmIChsZW4gJSA0ICE9PSAwKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDMyLWJpdHMnKQogIH0KICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSA0KSB7CiAgICBzd2FwKHRoaXMsIGksIGkgKyAzKQogICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDIpCiAgfQogIHJldHVybiB0aGlzCn0KCkJ1ZmZlci5wcm90b3R5cGUuc3dhcDY0ID0gZnVuY3Rpb24gc3dhcDY0ICgpIHsKICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICBpZiAobGVuICUgOCAhPT0gMCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA2NC1iaXRzJykKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gOCkgewogICAgc3dhcCh0aGlzLCBpLCBpICsgNykKICAgIHN3YXAodGhpcywgaSArIDEsIGkgKyA2KQogICAgc3dhcCh0aGlzLCBpICsgMiwgaSArIDUpCiAgICBzd2FwKHRoaXMsIGkgKyAzLCBpICsgNCkKICB9CiAgcmV0dXJuIHRoaXMKfQoKQnVmZmVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIHRvU3RyaW5nICgpIHsKICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggfCAwCiAgaWYgKGxlbmd0aCA9PT0gMCkgcmV0dXJuICcnCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHJldHVybiB1dGY4U2xpY2UodGhpcywgMCwgbGVuZ3RoKQogIHJldHVybiBzbG93VG9TdHJpbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKQp9CgpCdWZmZXIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uIGVxdWFscyAoYikgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKGIpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICBpZiAodGhpcyA9PT0gYikgcmV0dXJuIHRydWUKICByZXR1cm4gQnVmZmVyLmNvbXBhcmUodGhpcywgYikgPT09IDAKfQoKQnVmZmVyLnByb3RvdHlwZS5pbnNwZWN0ID0gZnVuY3Rpb24gaW5zcGVjdCAoKSB7CiAgdmFyIHN0ciA9ICcnCiAgdmFyIG1heCA9IGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMKICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICBzdHIgPSB0aGlzLnRvU3RyaW5nKCdoZXgnLCAwLCBtYXgpLm1hdGNoKC8uezJ9L2cpLmpvaW4oJyAnKQogICAgaWYgKHRoaXMubGVuZ3RoID4gbWF4KSBzdHIgKz0gJyAuLi4gJwogIH0KICByZXR1cm4gJzxCdWZmZXIgJyArIHN0ciArICc+Jwp9CgpCdWZmZXIucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlICh0YXJnZXQsIHN0YXJ0LCBlbmQsIHRoaXNTdGFydCwgdGhpc0VuZCkgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKHRhcmdldCkpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogIH0KCiAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgIHN0YXJ0ID0gMAogIH0KICBpZiAoZW5kID09PSB1bmRlZmluZWQpIHsKICAgIGVuZCA9IHRhcmdldCA/IHRhcmdldC5sZW5ndGggOiAwCiAgfQogIGlmICh0aGlzU3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgdGhpc1N0YXJ0ID0gMAogIH0KICBpZiAodGhpc0VuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzRW5kID0gdGhpcy5sZW5ndGgKICB9CgogIGlmIChzdGFydCA8IDAgfHwgZW5kID4gdGFyZ2V0Lmxlbmd0aCB8fCB0aGlzU3RhcnQgPCAwIHx8IHRoaXNFbmQgPiB0aGlzLmxlbmd0aCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ291dCBvZiByYW5nZSBpbmRleCcpCiAgfQoKICBpZiAodGhpc1N0YXJ0ID49IHRoaXNFbmQgJiYgc3RhcnQgPj0gZW5kKSB7CiAgICByZXR1cm4gMAogIH0KICBpZiAodGhpc1N0YXJ0ID49IHRoaXNFbmQpIHsKICAgIHJldHVybiAtMQogIH0KICBpZiAoc3RhcnQgPj0gZW5kKSB7CiAgICByZXR1cm4gMQogIH0KCiAgc3RhcnQgPj4+PSAwCiAgZW5kID4+Pj0gMAogIHRoaXNTdGFydCA+Pj49IDAKICB0aGlzRW5kID4+Pj0gMAoKICBpZiAodGhpcyA9PT0gdGFyZ2V0KSByZXR1cm4gMAoKICB2YXIgeCA9IHRoaXNFbmQgLSB0aGlzU3RhcnQKICB2YXIgeSA9IGVuZCAtIHN0YXJ0CiAgdmFyIGxlbiA9IE1hdGgubWluKHgsIHkpCgogIHZhciB0aGlzQ29weSA9IHRoaXMuc2xpY2UodGhpc1N0YXJ0LCB0aGlzRW5kKQogIHZhciB0YXJnZXRDb3B5ID0gdGFyZ2V0LnNsaWNlKHN0YXJ0LCBlbmQpCgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgIGlmICh0aGlzQ29weVtpXSAhPT0gdGFyZ2V0Q29weVtpXSkgewogICAgICB4ID0gdGhpc0NvcHlbaV0KICAgICAgeSA9IHRhcmdldENvcHlbaV0KICAgICAgYnJlYWsKICAgIH0KICB9CgogIGlmICh4IDwgeSkgcmV0dXJuIC0xCiAgaWYgKHkgPCB4KSByZXR1cm4gMQogIHJldHVybiAwCn0KCi8vIEZpbmRzIGVpdGhlciB0aGUgZmlyc3QgaW5kZXggb2YgYHZhbGAgaW4gYGJ1ZmZlcmAgYXQgb2Zmc2V0ID49IGBieXRlT2Zmc2V0YCwKLy8gT1IgdGhlIGxhc3QgaW5kZXggb2YgYHZhbGAgaW4gYGJ1ZmZlcmAgYXQgb2Zmc2V0IDw9IGBieXRlT2Zmc2V0YC4KLy8KLy8gQXJndW1lbnRzOgovLyAtIGJ1ZmZlciAtIGEgQnVmZmVyIHRvIHNlYXJjaAovLyAtIHZhbCAtIGEgc3RyaW5nLCBCdWZmZXIsIG9yIG51bWJlcgovLyAtIGJ5dGVPZmZzZXQgLSBhbiBpbmRleCBpbnRvIGBidWZmZXJgOyB3aWxsIGJlIGNsYW1wZWQgdG8gYW4gaW50MzIKLy8gLSBlbmNvZGluZyAtIGFuIG9wdGlvbmFsIGVuY29kaW5nLCByZWxldmFudCBpcyB2YWwgaXMgYSBzdHJpbmcKLy8gLSBkaXIgLSB0cnVlIGZvciBpbmRleE9mLCBmYWxzZSBmb3IgbGFzdEluZGV4T2YKZnVuY3Rpb24gYmlkaXJlY3Rpb25hbEluZGV4T2YgKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgLy8gRW1wdHkgYnVmZmVyIG1lYW5zIG5vIG1hdGNoCiAgaWYgKGJ1ZmZlci5sZW5ndGggPT09IDApIHJldHVybiAtMQoKICAvLyBOb3JtYWxpemUgYnl0ZU9mZnNldAogIGlmICh0eXBlb2YgYnl0ZU9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgIGVuY29kaW5nID0gYnl0ZU9mZnNldAogICAgYnl0ZU9mZnNldCA9IDAKICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPiAweDdmZmZmZmZmKSB7CiAgICBieXRlT2Zmc2V0ID0gMHg3ZmZmZmZmZgogIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA8IC0weDgwMDAwMDAwKSB7CiAgICBieXRlT2Zmc2V0ID0gLTB4ODAwMDAwMDAKICB9CiAgYnl0ZU9mZnNldCA9ICtieXRlT2Zmc2V0ICAvLyBDb2VyY2UgdG8gTnVtYmVyLgogIGlmIChpc05hTihieXRlT2Zmc2V0KSkgewogICAgLy8gYnl0ZU9mZnNldDogaXQgaXQncyB1bmRlZmluZWQsIG51bGwsIE5hTiwgImZvbyIsIGV0Yywgc2VhcmNoIHdob2xlIGJ1ZmZlcgogICAgYnl0ZU9mZnNldCA9IGRpciA/IDAgOiAoYnVmZmVyLmxlbmd0aCAtIDEpCiAgfQoKICAvLyBOb3JtYWxpemUgYnl0ZU9mZnNldDogbmVnYXRpdmUgb2Zmc2V0cyBzdGFydCBmcm9tIHRoZSBlbmQgb2YgdGhlIGJ1ZmZlcgogIGlmIChieXRlT2Zmc2V0IDwgMCkgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggKyBieXRlT2Zmc2V0CiAgaWYgKGJ5dGVPZmZzZXQgPj0gYnVmZmVyLmxlbmd0aCkgewogICAgaWYgKGRpcikgcmV0dXJuIC0xCiAgICBlbHNlIGJ5dGVPZmZzZXQgPSBidWZmZXIubGVuZ3RoIC0gMQogIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA8IDApIHsKICAgIGlmIChkaXIpIGJ5dGVPZmZzZXQgPSAwCiAgICBlbHNlIHJldHVybiAtMQogIH0KCiAgLy8gTm9ybWFsaXplIHZhbAogIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgdmFsID0gQnVmZmVyLmZyb20odmFsLCBlbmNvZGluZykKICB9CgogIC8vIEZpbmFsbHksIHNlYXJjaCBlaXRoZXIgaW5kZXhPZiAoaWYgZGlyIGlzIHRydWUpIG9yIGxhc3RJbmRleE9mCiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih2YWwpKSB7CiAgICAvLyBTcGVjaWFsIGNhc2U6IGxvb2tpbmcgZm9yIGVtcHR5IHN0cmluZy9idWZmZXIgYWx3YXlzIGZhaWxzCiAgICBpZiAodmFsLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gLTEKICAgIH0KICAgIHJldHVybiBhcnJheUluZGV4T2YoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpCiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgdmFsID0gdmFsICYgMHhGRiAvLyBTZWFyY2ggZm9yIGEgYnl0ZSB2YWx1ZSBbMC0yNTVdCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgJiYKICAgICAgICB0eXBlb2YgVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBpZiAoZGlyKSB7CiAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUubGFzdEluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKICAgICAgfQogICAgfQogICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIFsgdmFsIF0sIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpCiAgfQoKICB0aHJvdyBuZXcgVHlwZUVycm9yKCd2YWwgbXVzdCBiZSBzdHJpbmcsIG51bWJlciBvciBCdWZmZXInKQp9CgpmdW5jdGlvbiBhcnJheUluZGV4T2YgKGFyciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgdmFyIGluZGV4U2l6ZSA9IDEKICB2YXIgYXJyTGVuZ3RoID0gYXJyLmxlbmd0aAogIHZhciB2YWxMZW5ndGggPSB2YWwubGVuZ3RoCgogIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkKSB7CiAgICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgaWYgKGVuY29kaW5nID09PSAndWNzMicgfHwgZW5jb2RpbmcgPT09ICd1Y3MtMicgfHwKICAgICAgICBlbmNvZGluZyA9PT0gJ3V0ZjE2bGUnIHx8IGVuY29kaW5nID09PSAndXRmLTE2bGUnKSB7CiAgICAgIGlmIChhcnIubGVuZ3RoIDwgMiB8fCB2YWwubGVuZ3RoIDwgMikgewogICAgICAgIHJldHVybiAtMQogICAgICB9CiAgICAgIGluZGV4U2l6ZSA9IDIKICAgICAgYXJyTGVuZ3RoIC89IDIKICAgICAgdmFsTGVuZ3RoIC89IDIKICAgICAgYnl0ZU9mZnNldCAvPSAyCiAgICB9CiAgfQoKICBmdW5jdGlvbiByZWFkIChidWYsIGkpIHsKICAgIGlmIChpbmRleFNpemUgPT09IDEpIHsKICAgICAgcmV0dXJuIGJ1ZltpXQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGJ1Zi5yZWFkVUludDE2QkUoaSAqIGluZGV4U2l6ZSkKICAgIH0KICB9CgogIHZhciBpCiAgaWYgKGRpcikgewogICAgdmFyIGZvdW5kSW5kZXggPSAtMQogICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA8IGFyckxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChyZWFkKGFyciwgaSkgPT09IHJlYWQodmFsLCBmb3VuZEluZGV4ID09PSAtMSA/IDAgOiBpIC0gZm91bmRJbmRleCkpIHsKICAgICAgICBpZiAoZm91bmRJbmRleCA9PT0gLTEpIGZvdW5kSW5kZXggPSBpCiAgICAgICAgaWYgKGkgLSBmb3VuZEluZGV4ICsgMSA9PT0gdmFsTGVuZ3RoKSByZXR1cm4gZm91bmRJbmRleCAqIGluZGV4U2l6ZQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChmb3VuZEluZGV4ICE9PSAtMSkgaSAtPSBpIC0gZm91bmRJbmRleAogICAgICAgIGZvdW5kSW5kZXggPSAtMQogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChieXRlT2Zmc2V0ICsgdmFsTGVuZ3RoID4gYXJyTGVuZ3RoKSBieXRlT2Zmc2V0ID0gYXJyTGVuZ3RoIC0gdmFsTGVuZ3RoCiAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpID49IDA7IGktLSkgewogICAgICB2YXIgZm91bmQgPSB0cnVlCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdmFsTGVuZ3RoOyBqKyspIHsKICAgICAgICBpZiAocmVhZChhcnIsIGkgKyBqKSAhPT0gcmVhZCh2YWwsIGopKSB7CiAgICAgICAgICBmb3VuZCA9IGZhbHNlCiAgICAgICAgICBicmVhawogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZm91bmQpIHJldHVybiBpCiAgICB9CiAgfQoKICByZXR1cm4gLTEKfQoKQnVmZmVyLnByb3RvdHlwZS5pbmNsdWRlcyA9IGZ1bmN0aW9uIGluY2x1ZGVzICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgcmV0dXJuIHRoaXMuaW5kZXhPZih2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSAhPT0gLTEKfQoKQnVmZmVyLnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24gaW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiBiaWRpcmVjdGlvbmFsSW5kZXhPZih0aGlzLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCB0cnVlKQp9CgpCdWZmZXIucHJvdG90eXBlLmxhc3RJbmRleE9mID0gZnVuY3Rpb24gbGFzdEluZGV4T2YgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICByZXR1cm4gYmlkaXJlY3Rpb25hbEluZGV4T2YodGhpcywgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZmFsc2UpCn0KCmZ1bmN0aW9uIGhleFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICBvZmZzZXQgPSBOdW1iZXIob2Zmc2V0KSB8fCAwCiAgdmFyIHJlbWFpbmluZyA9IGJ1Zi5sZW5ndGggLSBvZmZzZXQKICBpZiAoIWxlbmd0aCkgewogICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgfSBlbHNlIHsKICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpCiAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgfQogIH0KCiAgLy8gbXVzdCBiZSBhbiBldmVuIG51bWJlciBvZiBkaWdpdHMKICB2YXIgc3RyTGVuID0gc3RyaW5nLmxlbmd0aAogIGlmIChzdHJMZW4gJSAyICE9PSAwKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIGhleCBzdHJpbmcnKQoKICBpZiAobGVuZ3RoID4gc3RyTGVuIC8gMikgewogICAgbGVuZ3RoID0gc3RyTGVuIC8gMgogIH0KICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICB2YXIgcGFyc2VkID0gcGFyc2VJbnQoc3RyaW5nLnN1YnN0cihpICogMiwgMiksIDE2KQogICAgaWYgKGlzTmFOKHBhcnNlZCkpIHJldHVybiBpCiAgICBidWZbb2Zmc2V0ICsgaV0gPSBwYXJzZWQKICB9CiAgcmV0dXJuIGkKfQoKZnVuY3Rpb24gdXRmOFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICByZXR1cm4gYmxpdEJ1ZmZlcih1dGY4VG9CeXRlcyhzdHJpbmcsIGJ1Zi5sZW5ndGggLSBvZmZzZXQpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQp9CgpmdW5jdGlvbiBhc2NpaVdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICByZXR1cm4gYmxpdEJ1ZmZlcihhc2NpaVRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKfQoKZnVuY3Rpb24gbGF0aW4xV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBhc2NpaVdyaXRlKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKfQoKZnVuY3Rpb24gYmFzZTY0V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBibGl0QnVmZmVyKGJhc2U2NFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKfQoKZnVuY3Rpb24gdWNzMldyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICByZXR1cm4gYmxpdEJ1ZmZlcih1dGYxNmxlVG9CeXRlcyhzdHJpbmcsIGJ1Zi5sZW5ndGggLSBvZmZzZXQpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gd3JpdGUgKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKSB7CiAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZykKICBpZiAob2Zmc2V0ID09PSB1bmRlZmluZWQpIHsKICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICBsZW5ndGggPSB0aGlzLmxlbmd0aAogICAgb2Zmc2V0ID0gMAogIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcsIGVuY29kaW5nKQogIH0gZWxzZSBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIG9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgIGVuY29kaW5nID0gb2Zmc2V0CiAgICBsZW5ndGggPSB0aGlzLmxlbmd0aAogICAgb2Zmc2V0ID0gMAogIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcsIG9mZnNldFssIGxlbmd0aF1bLCBlbmNvZGluZ10pCiAgfSBlbHNlIGlmIChpc0Zpbml0ZShvZmZzZXQpKSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoaXNGaW5pdGUobGVuZ3RoKSkgewogICAgICBsZW5ndGggPSBsZW5ndGggfCAwCiAgICAgIGlmIChlbmNvZGluZyA9PT0gdW5kZWZpbmVkKSBlbmNvZGluZyA9ICd1dGY4JwogICAgfSBlbHNlIHsKICAgICAgZW5jb2RpbmcgPSBsZW5ndGgKICAgICAgbGVuZ3RoID0gdW5kZWZpbmVkCiAgICB9CiAgLy8gbGVnYWN5IHdyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldCwgbGVuZ3RoKSAtIHJlbW92ZSBpbiB2MC4xMwogIH0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdCdWZmZXIud3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0WywgbGVuZ3RoXSkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCcKICAgICkKICB9CgogIHZhciByZW1haW5pbmcgPSB0aGlzLmxlbmd0aCAtIG9mZnNldAogIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCB8fCBsZW5ndGggPiByZW1haW5pbmcpIGxlbmd0aCA9IHJlbWFpbmluZwoKICBpZiAoKHN0cmluZy5sZW5ndGggPiAwICYmIChsZW5ndGggPCAwIHx8IG9mZnNldCA8IDApKSB8fCBvZmZzZXQgPiB0aGlzLmxlbmd0aCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0F0dGVtcHQgdG8gd3JpdGUgb3V0c2lkZSBidWZmZXIgYm91bmRzJykKICB9CgogIGlmICghZW5jb2RpbmcpIGVuY29kaW5nID0gJ3V0ZjgnCgogIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgZm9yICg7OykgewogICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICBjYXNlICdoZXgnOgogICAgICAgIHJldHVybiBoZXhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQoKICAgICAgY2FzZSAndXRmOCc6CiAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICByZXR1cm4gdXRmOFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgogICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgcmV0dXJuIGFzY2lpV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCiAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgcmV0dXJuIGxhdGluMVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgogICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIC8vIFdhcm5pbmc6IG1heExlbmd0aCBub3QgdGFrZW4gaW50byBhY2NvdW50IGluIGJhc2U2NFdyaXRlCiAgICAgICAgcmV0dXJuIGJhc2U2NFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgogICAgICBjYXNlICd1Y3MyJzoKICAgICAgY2FzZSAndWNzLTInOgogICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgIHJldHVybiB1Y3MyV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgfQogIH0KfQoKQnVmZmVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04gKCkgewogIHJldHVybiB7CiAgICB0eXBlOiAnQnVmZmVyJywKICAgIGRhdGE6IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMuX2FyciB8fCB0aGlzLCAwKQogIH0KfQoKZnVuY3Rpb24gYmFzZTY0U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIGlmIChzdGFydCA9PT0gMCAmJiBlbmQgPT09IGJ1Zi5sZW5ndGgpIHsKICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYpCiAgfSBlbHNlIHsKICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYuc2xpY2Uoc3RhcnQsIGVuZCkpCiAgfQp9CgpmdW5jdGlvbiB1dGY4U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICB2YXIgcmVzID0gW10KCiAgdmFyIGkgPSBzdGFydAogIHdoaWxlIChpIDwgZW5kKSB7CiAgICB2YXIgZmlyc3RCeXRlID0gYnVmW2ldCiAgICB2YXIgY29kZVBvaW50ID0gbnVsbAogICAgdmFyIGJ5dGVzUGVyU2VxdWVuY2UgPSAoZmlyc3RCeXRlID4gMHhFRikgPyA0CiAgICAgIDogKGZpcnN0Qnl0ZSA+IDB4REYpID8gMwogICAgICA6IChmaXJzdEJ5dGUgPiAweEJGKSA/IDIKICAgICAgOiAxCgogICAgaWYgKGkgKyBieXRlc1BlclNlcXVlbmNlIDw9IGVuZCkgewogICAgICB2YXIgc2Vjb25kQnl0ZSwgdGhpcmRCeXRlLCBmb3VydGhCeXRlLCB0ZW1wQ29kZVBvaW50CgogICAgICBzd2l0Y2ggKGJ5dGVzUGVyU2VxdWVuY2UpIHsKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBpZiAoZmlyc3RCeXRlIDwgMHg4MCkgewogICAgICAgICAgICBjb2RlUG9pbnQgPSBmaXJzdEJ5dGUKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHgxRikgPDwgMHg2IHwgKHNlY29uZEJ5dGUgJiAweDNGKQogICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0YpIHsKICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrCiAgICAgICAgY2FzZSAzOgogICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl0KICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwICYmICh0aGlyZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCkgewogICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHhDIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAodGhpcmRCeXRlICYgMHgzRikKICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweDdGRiAmJiAodGVtcENvZGVQb2ludCA8IDB4RDgwMCB8fCB0ZW1wQ29kZVBvaW50ID4gMHhERkZGKSkgewogICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDQ6CiAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXQogICAgICAgICAgZm91cnRoQnl0ZSA9IGJ1ZltpICsgM10KICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwICYmICh0aGlyZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAoZm91cnRoQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHhGKSA8PCAweDEyIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweEMgfCAodGhpcmRCeXRlICYgMHgzRikgPDwgMHg2IHwgKGZvdXJ0aEJ5dGUgJiAweDNGKQogICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4RkZGRiAmJiB0ZW1wQ29kZVBvaW50IDwgMHgxMTAwMDApIHsKICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGlmIChjb2RlUG9pbnQgPT09IG51bGwpIHsKICAgICAgLy8gd2UgZGlkIG5vdCBnZW5lcmF0ZSBhIHZhbGlkIGNvZGVQb2ludCBzbyBpbnNlcnQgYQogICAgICAvLyByZXBsYWNlbWVudCBjaGFyIChVK0ZGRkQpIGFuZCBhZHZhbmNlIG9ubHkgMSBieXRlCiAgICAgIGNvZGVQb2ludCA9IDB4RkZGRAogICAgICBieXRlc1BlclNlcXVlbmNlID0gMQogICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPiAweEZGRkYpIHsKICAgICAgLy8gZW5jb2RlIHRvIHV0ZjE2IChzdXJyb2dhdGUgcGFpciBkYW5jZSkKICAgICAgY29kZVBvaW50IC09IDB4MTAwMDAKICAgICAgcmVzLnB1c2goY29kZVBvaW50ID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKQogICAgICBjb2RlUG9pbnQgPSAweERDMDAgfCBjb2RlUG9pbnQgJiAweDNGRgogICAgfQoKICAgIHJlcy5wdXNoKGNvZGVQb2ludCkKICAgIGkgKz0gYnl0ZXNQZXJTZXF1ZW5jZQogIH0KCiAgcmV0dXJuIGRlY29kZUNvZGVQb2ludHNBcnJheShyZXMpCn0KCi8vIEJhc2VkIG9uIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzIyNzQ3MjcyLzY4MDc0MiwgdGhlIGJyb3dzZXIgd2l0aAovLyB0aGUgbG93ZXN0IGxpbWl0IGlzIENocm9tZSwgd2l0aCAweDEwMDAwIGFyZ3MuCi8vIFdlIGdvIDEgbWFnbml0dWRlIGxlc3MsIGZvciBzYWZldHkKdmFyIE1BWF9BUkdVTUVOVFNfTEVOR1RIID0gMHgxMDAwCgpmdW5jdGlvbiBkZWNvZGVDb2RlUG9pbnRzQXJyYXkgKGNvZGVQb2ludHMpIHsKICB2YXIgbGVuID0gY29kZVBvaW50cy5sZW5ndGgKICBpZiAobGVuIDw9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKSB7CiAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNvZGVQb2ludHMpIC8vIGF2b2lkIGV4dHJhIHNsaWNlKCkKICB9CgogIC8vIERlY29kZSBpbiBjaHVua3MgdG8gYXZvaWQgImNhbGwgc3RhY2sgc2l6ZSBleGNlZWRlZCIuCiAgdmFyIHJlcyA9ICcnCiAgdmFyIGkgPSAwCiAgd2hpbGUgKGkgPCBsZW4pIHsKICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KAogICAgICBTdHJpbmcsCiAgICAgIGNvZGVQb2ludHMuc2xpY2UoaSwgaSArPSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkKICAgICkKICB9CiAgcmV0dXJuIHJlcwp9CgpmdW5jdGlvbiBhc2NpaVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICB2YXIgcmV0ID0gJycKICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCgogIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0gJiAweDdGKQogIH0KICByZXR1cm4gcmV0Cn0KCmZ1bmN0aW9uIGxhdGluMVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICB2YXIgcmV0ID0gJycKICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCgogIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0pCiAgfQogIHJldHVybiByZXQKfQoKZnVuY3Rpb24gaGV4U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIHZhciBsZW4gPSBidWYubGVuZ3RoCgogIGlmICghc3RhcnQgfHwgc3RhcnQgPCAwKSBzdGFydCA9IDAKICBpZiAoIWVuZCB8fCBlbmQgPCAwIHx8IGVuZCA+IGxlbikgZW5kID0gbGVuCgogIHZhciBvdXQgPSAnJwogIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICBvdXQgKz0gdG9IZXgoYnVmW2ldKQogIH0KICByZXR1cm4gb3V0Cn0KCmZ1bmN0aW9uIHV0ZjE2bGVTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIGJ5dGVzID0gYnVmLnNsaWNlKHN0YXJ0LCBlbmQpCiAgdmFyIHJlcyA9ICcnCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkgKz0gMikgewogICAgcmVzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNbaV0gKyBieXRlc1tpICsgMV0gKiAyNTYpCiAgfQogIHJldHVybiByZXMKfQoKQnVmZmVyLnByb3RvdHlwZS5zbGljZSA9IGZ1bmN0aW9uIHNsaWNlIChzdGFydCwgZW5kKSB7CiAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgc3RhcnQgPSB+fnN0YXJ0CiAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyBsZW4gOiB+fmVuZAoKICBpZiAoc3RhcnQgPCAwKSB7CiAgICBzdGFydCArPSBsZW4KICAgIGlmIChzdGFydCA8IDApIHN0YXJ0ID0gMAogIH0gZWxzZSBpZiAoc3RhcnQgPiBsZW4pIHsKICAgIHN0YXJ0ID0gbGVuCiAgfQoKICBpZiAoZW5kIDwgMCkgewogICAgZW5kICs9IGxlbgogICAgaWYgKGVuZCA8IDApIGVuZCA9IDAKICB9IGVsc2UgaWYgKGVuZCA+IGxlbikgewogICAgZW5kID0gbGVuCiAgfQoKICBpZiAoZW5kIDwgc3RhcnQpIGVuZCA9IHN0YXJ0CgogIHZhciBuZXdCdWYKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIG5ld0J1ZiA9IHRoaXMuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICAgIG5ld0J1Zi5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgfSBlbHNlIHsKICAgIHZhciBzbGljZUxlbiA9IGVuZCAtIHN0YXJ0CiAgICBuZXdCdWYgPSBuZXcgQnVmZmVyKHNsaWNlTGVuLCB1bmRlZmluZWQpCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNsaWNlTGVuOyArK2kpIHsKICAgICAgbmV3QnVmW2ldID0gdGhpc1tpICsgc3RhcnRdCiAgICB9CiAgfQoKICByZXR1cm4gbmV3QnVmCn0KCi8qCiAqIE5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgYnVmZmVyIGlzbid0IHRyeWluZyB0byB3cml0ZSBvdXQgb2YgYm91bmRzLgogKi8KZnVuY3Rpb24gY2hlY2tPZmZzZXQgKG9mZnNldCwgZXh0LCBsZW5ndGgpIHsKICBpZiAoKG9mZnNldCAlIDEpICE9PSAwIHx8IG9mZnNldCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdvZmZzZXQgaXMgbm90IHVpbnQnKQogIGlmIChvZmZzZXQgKyBleHQgPiBsZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoJykKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludExFID0gZnVuY3Rpb24gcmVhZFVJbnRMRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIG9mZnNldCA9IG9mZnNldCB8IDAKICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQoKICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdCiAgdmFyIG11bCA9IDEKICB2YXIgaSA9IDAKICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgaV0gKiBtdWwKICB9CgogIHJldHVybiB2YWwKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludEJFID0gZnVuY3Rpb24gcmVhZFVJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIG9mZnNldCA9IG9mZnNldCB8IDAKICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICBpZiAoIW5vQXNzZXJ0KSB7CiAgICBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIH0KCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoXQogIHZhciBtdWwgPSAxCiAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdICogbXVsCiAgfQoKICByZXR1cm4gdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQ4ID0gZnVuY3Rpb24gcmVhZFVJbnQ4IChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCkKICByZXR1cm4gdGhpc1tvZmZzZXRdCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkxFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICByZXR1cm4gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2QkUgPSBmdW5jdGlvbiByZWFkVUludDE2QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogIHJldHVybiAodGhpc1tvZmZzZXRdIDw8IDgpIHwgdGhpc1tvZmZzZXQgKyAxXQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCgogIHJldHVybiAoKHRoaXNbb2Zmc2V0XSkgfAogICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSkgKwogICAgICAodGhpc1tvZmZzZXQgKyAzXSAqIDB4MTAwMDAwMCkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyQkUgPSBmdW5jdGlvbiByZWFkVUludDMyQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSAqIDB4MTAwMDAwMCkgKwogICAgKCh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CiAgICB0aGlzW29mZnNldCArIDNdKQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnRMRSA9IGZ1bmN0aW9uIHJlYWRJbnRMRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIG9mZnNldCA9IG9mZnNldCB8IDAKICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQoKICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdCiAgdmFyIG11bCA9IDEKICB2YXIgaSA9IDAKICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgaV0gKiBtdWwKICB9CiAgbXVsICo9IDB4ODAKCiAgaWYgKHZhbCA+PSBtdWwpIHZhbCAtPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkKCiAgcmV0dXJuIHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnRCRSA9IGZ1bmN0aW9uIHJlYWRJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIG9mZnNldCA9IG9mZnNldCB8IDAKICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQoKICB2YXIgaSA9IGJ5dGVMZW5ndGgKICB2YXIgbXVsID0gMQogIHZhciB2YWwgPSB0aGlzW29mZnNldCArIC0taV0KICB3aGlsZSAoaSA+IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0taV0gKiBtdWwKICB9CiAgbXVsICo9IDB4ODAKCiAgaWYgKHZhbCA+PSBtdWwpIHZhbCAtPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkKCiAgcmV0dXJuIHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQ4ID0gZnVuY3Rpb24gcmVhZEludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKQogIGlmICghKHRoaXNbb2Zmc2V0XSAmIDB4ODApKSByZXR1cm4gKHRoaXNbb2Zmc2V0XSkKICByZXR1cm4gKCgweGZmIC0gdGhpc1tvZmZzZXRdICsgMSkgKiAtMSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZMRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludDE2QkUgPSBmdW5jdGlvbiByZWFkSW50MTZCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgMV0gfCAodGhpc1tvZmZzZXRdIDw8IDgpCiAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkxFID0gZnVuY3Rpb24gcmVhZEludDMyTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSkgfAogICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYpIHwKICAgICh0aGlzW29mZnNldCArIDNdIDw8IDI0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkJFID0gZnVuY3Rpb24gcmVhZEludDMyQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCAyNCkgfAogICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICh0aGlzW29mZnNldCArIDNdKQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdExFID0gZnVuY3Rpb24gcmVhZEZsb2F0TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCB0cnVlLCAyMywgNCkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRCRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdEJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDIzLCA0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVMRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDUyLCA4KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVCRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCA1MiwgOCkKfQoKZnVuY3Rpb24gY2hlY2tJbnQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHRocm93IG5ldyBUeXBlRXJyb3IoJyJidWZmZXIiIGFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIgaW5zdGFuY2UnKQogIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJyJ2YWx1ZSIgYXJndW1lbnQgaXMgb3V0IG9mIGJvdW5kcycpCiAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludExFID0gZnVuY3Rpb24gd3JpdGVVSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgaWYgKCFub0Fzc2VydCkgewogICAgdmFyIG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpIC0gMQogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApCiAgfQoKICB2YXIgbXVsID0gMQogIHZhciBpID0gMAogIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMHhGRgogIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkYKICB9CgogIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICBpZiAoIW5vQXNzZXJ0KSB7CiAgICB2YXIgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBtYXhCeXRlcywgMCkKICB9CgogIHZhciBpID0gYnl0ZUxlbmd0aCAtIDEKICB2YXIgbXVsID0gMQogIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAodmFsdWUgLyBtdWwpICYgMHhGRgogIH0KCiAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVVSW50OCAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweGZmLCAwKQogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogIHJldHVybiBvZmZzZXQgKyAxCn0KCmZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDE2IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmICsgdmFsdWUgKyAxCiAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCAyKTsgaSA8IGo7ICsraSkgewogICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlICYgKDB4ZmYgPDwgKDggKiAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSkpKSA+Pj4KICAgICAgKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkgKiA4CiAgfQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4ZmZmZiwgMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgMgp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4ZmZmZiwgMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgJiAweGZmKQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDIKfQoKZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MzIgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCA0KTsgaSA8IGo7ICsraSkgewogICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlID4+PiAobGl0dGxlRW5kaWFuID8gaSA6IDMgLSBpKSAqIDgpICYgMHhmZgogIH0KfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkxFID0gZnVuY3Rpb24gd3JpdGVVSW50MzJMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiAxNikKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4ZmZmZmZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50TEUgPSBmdW5jdGlvbiB3cml0ZUludExFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIHsKICAgIHZhciBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoIC0gMSkKCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBsaW1pdCAtIDEsIC1saW1pdCkKICB9CgogIHZhciBpID0gMAogIHZhciBtdWwgPSAxCiAgdmFyIHN1YiA9IDAKICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkYKICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgaWYgKHZhbHVlIDwgMCAmJiBzdWIgPT09IDAgJiYgdGhpc1tvZmZzZXQgKyBpIC0gMV0gIT09IDApIHsKICAgICAgc3ViID0gMQogICAgfQogICAgdGhpc1tvZmZzZXQgKyBpXSA9ICgodmFsdWUgLyBtdWwpID4+IDApIC0gc3ViICYgMHhGRgogIH0KCiAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludEJFID0gZnVuY3Rpb24gd3JpdGVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSB7CiAgICB2YXIgbGltaXQgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCAtIDEpCgogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbGltaXQgLSAxLCAtbGltaXQpCiAgfQoKICB2YXIgaSA9IGJ5dGVMZW5ndGggLSAxCiAgdmFyIG11bCA9IDEKICB2YXIgc3ViID0gMAogIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSArIDFdICE9PSAwKSB7CiAgICAgIHN1YiA9IDEKICAgIH0KICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAoKHZhbHVlIC8gbXVsKSA+PiAwKSAtIHN1YiAmIDB4RkYKICB9CgogIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQ4ID0gZnVuY3Rpb24gd3JpdGVJbnQ4ICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4N2YsIC0weDgwKQogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmYgKyB2YWx1ZSArIDEKICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogIHJldHVybiBvZmZzZXQgKyAxCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkxFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgMgp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MTZCRSA9IGZ1bmN0aW9uIHdyaXRlSW50MTZCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZikKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgfQogIHJldHVybiBvZmZzZXQgKyAyCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkxFID0gZnVuY3Rpb24gd3JpdGVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiAxNikKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJCRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlICYgMHhmZikKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgfQogIHJldHVybiBvZmZzZXQgKyA0Cn0KCmZ1bmN0aW9uIGNoZWNrSUVFRTc1NCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogIGlmIChvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKfQoKZnVuY3Rpb24gd3JpdGVGbG9hdCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgewogICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgNCwgMy40MDI4MjM0NjYzODUyODg2ZSszOCwgLTMuNDAyODIzNDY2Mzg1Mjg4NmUrMzgpCiAgfQogIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDIzLCA0KQogIHJldHVybiBvZmZzZXQgKyA0Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVGbG9hdExFID0gZnVuY3Rpb24gd3JpdGVGbG9hdExFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRCRSA9IGZ1bmN0aW9uIHdyaXRlRmxvYXRCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCn0KCmZ1bmN0aW9uIHdyaXRlRG91YmxlIChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSB7CiAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA4LCAxLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCwgLTEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4KQogIH0KICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCA1MiwgOCkKICByZXR1cm4gb2Zmc2V0ICsgOAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlTEUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUJFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UsIG5vQXNzZXJ0KQp9CgovLyBjb3B5KHRhcmdldEJ1ZmZlciwgdGFyZ2V0U3RhcnQ9MCwgc291cmNlU3RhcnQ9MCwgc291cmNlRW5kPWJ1ZmZlci5sZW5ndGgpCkJ1ZmZlci5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uIGNvcHkgKHRhcmdldCwgdGFyZ2V0U3RhcnQsIHN0YXJ0LCBlbmQpIHsKICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICBpZiAoIWVuZCAmJiBlbmQgIT09IDApIGVuZCA9IHRoaXMubGVuZ3RoCiAgaWYgKHRhcmdldFN0YXJ0ID49IHRhcmdldC5sZW5ndGgpIHRhcmdldFN0YXJ0ID0gdGFyZ2V0Lmxlbmd0aAogIGlmICghdGFyZ2V0U3RhcnQpIHRhcmdldFN0YXJ0ID0gMAogIGlmIChlbmQgPiAwICYmIGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydAoKICAvLyBDb3B5IDAgYnl0ZXM7IHdlJ3JlIGRvbmUKICBpZiAoZW5kID09PSBzdGFydCkgcmV0dXJuIDAKICBpZiAodGFyZ2V0Lmxlbmd0aCA9PT0gMCB8fCB0aGlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDAKCiAgLy8gRmF0YWwgZXJyb3IgY29uZGl0aW9ucwogIGlmICh0YXJnZXRTdGFydCA8IDApIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCd0YXJnZXRTdGFydCBvdXQgb2YgYm91bmRzJykKICB9CiAgaWYgKHN0YXJ0IDwgMCB8fCBzdGFydCA+PSB0aGlzLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NvdXJjZVN0YXJ0IG91dCBvZiBib3VuZHMnKQogIGlmIChlbmQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlRW5kIG91dCBvZiBib3VuZHMnKQoKICAvLyBBcmUgd2Ugb29iPwogIGlmIChlbmQgPiB0aGlzLmxlbmd0aCkgZW5kID0gdGhpcy5sZW5ndGgKICBpZiAodGFyZ2V0Lmxlbmd0aCAtIHRhcmdldFN0YXJ0IDwgZW5kIC0gc3RhcnQpIHsKICAgIGVuZCA9IHRhcmdldC5sZW5ndGggLSB0YXJnZXRTdGFydCArIHN0YXJ0CiAgfQoKICB2YXIgbGVuID0gZW5kIC0gc3RhcnQKICB2YXIgaQoKICBpZiAodGhpcyA9PT0gdGFyZ2V0ICYmIHN0YXJ0IDwgdGFyZ2V0U3RhcnQgJiYgdGFyZ2V0U3RhcnQgPCBlbmQpIHsKICAgIC8vIGRlc2NlbmRpbmcgY29weSBmcm9tIGVuZAogICAgZm9yIChpID0gbGVuIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgdGFyZ2V0W2kgKyB0YXJnZXRTdGFydF0gPSB0aGlzW2kgKyBzdGFydF0KICAgIH0KICB9IGVsc2UgaWYgKGxlbiA8IDEwMDAgfHwgIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAvLyBhc2NlbmRpbmcgY29weSBmcm9tIHN0YXJ0CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdGFyZ2V0W2kgKyB0YXJnZXRTdGFydF0gPSB0aGlzW2kgKyBzdGFydF0KICAgIH0KICB9IGVsc2UgewogICAgVWludDhBcnJheS5wcm90b3R5cGUuc2V0LmNhbGwoCiAgICAgIHRhcmdldCwKICAgICAgdGhpcy5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBsZW4pLAogICAgICB0YXJnZXRTdGFydAogICAgKQogIH0KCiAgcmV0dXJuIGxlbgp9CgovLyBVc2FnZToKLy8gICAgYnVmZmVyLmZpbGwobnVtYmVyWywgb2Zmc2V0WywgZW5kXV0pCi8vICAgIGJ1ZmZlci5maWxsKGJ1ZmZlclssIG9mZnNldFssIGVuZF1dKQovLyAgICBidWZmZXIuZmlsbChzdHJpbmdbLCBvZmZzZXRbLCBlbmRdXVssIGVuY29kaW5nXSkKQnVmZmVyLnByb3RvdHlwZS5maWxsID0gZnVuY3Rpb24gZmlsbCAodmFsLCBzdGFydCwgZW5kLCBlbmNvZGluZykgewogIC8vIEhhbmRsZSBzdHJpbmcgY2FzZXM6CiAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IHN0YXJ0CiAgICAgIHN0YXJ0ID0gMAogICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5kID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGVuZAogICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgfQogICAgaWYgKHZhbC5sZW5ndGggPT09IDEpIHsKICAgICAgdmFyIGNvZGUgPSB2YWwuY2hhckNvZGVBdCgwKQogICAgICBpZiAoY29kZSA8IDI1NikgewogICAgICAgIHZhbCA9IGNvZGUKICAgICAgfQogICAgfQogICAgaWYgKGVuY29kaW5nICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGVuY29kaW5nICE9PSAnc3RyaW5nJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdlbmNvZGluZyBtdXN0IGJlIGEgc3RyaW5nJykKICAgIH0KICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnICYmICFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgIHZhbCA9IHZhbCAmIDI1NQogIH0KCiAgLy8gSW52YWxpZCByYW5nZXMgYXJlIG5vdCBzZXQgdG8gYSBkZWZhdWx0LCBzbyBjYW4gcmFuZ2UgY2hlY2sgZWFybHkuCiAgaWYgKHN0YXJ0IDwgMCB8fCB0aGlzLmxlbmd0aCA8IHN0YXJ0IHx8IHRoaXMubGVuZ3RoIDwgZW5kKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignT3V0IG9mIHJhbmdlIGluZGV4JykKICB9CgogIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgIHJldHVybiB0aGlzCiAgfQoKICBzdGFydCA9IHN0YXJ0ID4+PiAwCiAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyB0aGlzLmxlbmd0aCA6IGVuZCA+Pj4gMAoKICBpZiAoIXZhbCkgdmFsID0gMAoKICB2YXIgaQogIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICB0aGlzW2ldID0gdmFsCiAgICB9CiAgfSBlbHNlIHsKICAgIHZhciBieXRlcyA9IEJ1ZmZlci5pc0J1ZmZlcih2YWwpCiAgICAgID8gdmFsCiAgICAgIDogdXRmOFRvQnl0ZXMobmV3IEJ1ZmZlcih2YWwsIGVuY29kaW5nKS50b1N0cmluZygpKQogICAgdmFyIGxlbiA9IGJ5dGVzLmxlbmd0aAogICAgZm9yIChpID0gMDsgaSA8IGVuZCAtIHN0YXJ0OyArK2kpIHsKICAgICAgdGhpc1tpICsgc3RhcnRdID0gYnl0ZXNbaSAlIGxlbl0KICAgIH0KICB9CgogIHJldHVybiB0aGlzCn0KCi8vIEhFTFBFUiBGVU5DVElPTlMKLy8gPT09PT09PT09PT09PT09PQoKdmFyIElOVkFMSURfQkFTRTY0X1JFID0gL1teK1wvMC05QS1aYS16LV9dL2cKCmZ1bmN0aW9uIGJhc2U2NGNsZWFuIChzdHIpIHsKICAvLyBOb2RlIHN0cmlwcyBvdXQgaW52YWxpZCBjaGFyYWN0ZXJzIGxpa2UgXG4gYW5kIFx0IGZyb20gdGhlIHN0cmluZywgYmFzZTY0LWpzIGRvZXMgbm90CiAgc3RyID0gc3RyaW5ndHJpbShzdHIpLnJlcGxhY2UoSU5WQUxJRF9CQVNFNjRfUkUsICcnKQogIC8vIE5vZGUgY29udmVydHMgc3RyaW5ncyB3aXRoIGxlbmd0aCA8IDIgdG8gJycKICBpZiAoc3RyLmxlbmd0aCA8IDIpIHJldHVybiAnJwogIC8vIE5vZGUgYWxsb3dzIGZvciBub24tcGFkZGVkIGJhc2U2NCBzdHJpbmdzIChtaXNzaW5nIHRyYWlsaW5nID09PSksIGJhc2U2NC1qcyBkb2VzIG5vdAogIHdoaWxlIChzdHIubGVuZ3RoICUgNCAhPT0gMCkgewogICAgc3RyID0gc3RyICsgJz0nCiAgfQogIHJldHVybiBzdHIKfQoKZnVuY3Rpb24gc3RyaW5ndHJpbSAoc3RyKSB7CiAgaWYgKHN0ci50cmltKSByZXR1cm4gc3RyLnRyaW0oKQogIHJldHVybiBzdHIucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQp9CgpmdW5jdGlvbiB0b0hleCAobikgewogIGlmIChuIDwgMTYpIHJldHVybiAnMCcgKyBuLnRvU3RyaW5nKDE2KQogIHJldHVybiBuLnRvU3RyaW5nKDE2KQp9CgpmdW5jdGlvbiB1dGY4VG9CeXRlcyAoc3RyaW5nLCB1bml0cykgewogIHVuaXRzID0gdW5pdHMgfHwgSW5maW5pdHkKICB2YXIgY29kZVBvaW50CiAgdmFyIGxlbmd0aCA9IHN0cmluZy5sZW5ndGgKICB2YXIgbGVhZFN1cnJvZ2F0ZSA9IG51bGwKICB2YXIgYnl0ZXMgPSBbXQoKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICBjb2RlUG9pbnQgPSBzdHJpbmcuY2hhckNvZGVBdChpKQoKICAgIC8vIGlzIHN1cnJvZ2F0ZSBjb21wb25lbnQKICAgIGlmIChjb2RlUG9pbnQgPiAweEQ3RkYgJiYgY29kZVBvaW50IDwgMHhFMDAwKSB7CiAgICAgIC8vIGxhc3QgY2hhciB3YXMgYSBsZWFkCiAgICAgIGlmICghbGVhZFN1cnJvZ2F0ZSkgewogICAgICAgIC8vIG5vIGxlYWQgeWV0CiAgICAgICAgaWYgKGNvZGVQb2ludCA+IDB4REJGRikgewogICAgICAgICAgLy8gdW5leHBlY3RlZCB0cmFpbAogICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0gZWxzZSBpZiAoaSArIDEgPT09IGxlbmd0aCkgewogICAgICAgICAgLy8gdW5wYWlyZWQgbGVhZAogICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgLy8gdmFsaWQgbGVhZAogICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQKCiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgLy8gMiBsZWFkcyBpbiBhIHJvdwogICAgICBpZiAoY29kZVBvaW50IDwgMHhEQzAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAogICAgICAgIGNvbnRpbnVlCiAgICAgIH0KCiAgICAgIC8vIHZhbGlkIHN1cnJvZ2F0ZSBwYWlyCiAgICAgIGNvZGVQb2ludCA9IChsZWFkU3Vycm9nYXRlIC0gMHhEODAwIDw8IDEwIHwgY29kZVBvaW50IC0gMHhEQzAwKSArIDB4MTAwMDAKICAgIH0gZWxzZSBpZiAobGVhZFN1cnJvZ2F0ZSkgewogICAgICAvLyB2YWxpZCBibXAgY2hhciwgYnV0IGxhc3QgY2hhciB3YXMgYSBsZWFkCiAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgfQoKICAgIGxlYWRTdXJyb2dhdGUgPSBudWxsCgogICAgLy8gZW5jb2RlIHV0ZjgKICAgIGlmIChjb2RlUG9pbnQgPCAweDgwKSB7CiAgICAgIGlmICgodW5pdHMgLT0gMSkgPCAwKSBicmVhawogICAgICBieXRlcy5wdXNoKGNvZGVQb2ludCkKICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHg4MDApIHsKICAgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCiAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgY29kZVBvaW50ID4+IDB4NiB8IDB4QzAsCiAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgKQogICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDEwMDAwKSB7CiAgICAgIGlmICgodW5pdHMgLT0gMykgPCAwKSBicmVhawogICAgICBieXRlcy5wdXNoKAogICAgICAgIGNvZGVQb2ludCA+PiAweEMgfCAweEUwLAogICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICApCiAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTEwMDAwKSB7CiAgICAgIGlmICgodW5pdHMgLT0gNCkgPCAwKSBicmVhawogICAgICBieXRlcy5wdXNoKAogICAgICAgIGNvZGVQb2ludCA+PiAweDEyIHwgMHhGMCwKICAgICAgICBjb2RlUG9pbnQgPj4gMHhDICYgMHgzRiB8IDB4ODAsCiAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAogICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICkKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb2RlIHBvaW50JykKICAgIH0KICB9CgogIHJldHVybiBieXRlcwp9CgpmdW5jdGlvbiBhc2NpaVRvQnl0ZXMgKHN0cikgewogIHZhciBieXRlQXJyYXkgPSBbXQogIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAvLyBOb2RlJ3MgY29kZSBzZWVtcyB0byBiZSBkb2luZyB0aGlzIGFuZCBub3QgJiAweDdGLi4KICAgIGJ5dGVBcnJheS5wdXNoKHN0ci5jaGFyQ29kZUF0KGkpICYgMHhGRikKICB9CiAgcmV0dXJuIGJ5dGVBcnJheQp9CgpmdW5jdGlvbiB1dGYxNmxlVG9CeXRlcyAoc3RyLCB1bml0cykgewogIHZhciBjLCBoaSwgbG8KICB2YXIgYnl0ZUFycmF5ID0gW10KICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCgogICAgYyA9IHN0ci5jaGFyQ29kZUF0KGkpCiAgICBoaSA9IGMgPj4gOAogICAgbG8gPSBjICUgMjU2CiAgICBieXRlQXJyYXkucHVzaChsbykKICAgIGJ5dGVBcnJheS5wdXNoKGhpKQogIH0KCiAgcmV0dXJuIGJ5dGVBcnJheQp9CgpmdW5jdGlvbiBiYXNlNjRUb0J5dGVzIChzdHIpIHsKICByZXR1cm4gYmFzZTY0LnRvQnl0ZUFycmF5KGJhc2U2NGNsZWFuKHN0cikpCn0KCmZ1bmN0aW9uIGJsaXRCdWZmZXIgKHNyYywgZHN0LCBvZmZzZXQsIGxlbmd0aCkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgIGlmICgoaSArIG9mZnNldCA+PSBkc3QubGVuZ3RoKSB8fCAoaSA+PSBzcmMubGVuZ3RoKSkgYnJlYWsKICAgIGRzdFtpICsgb2Zmc2V0XSA9IHNyY1tpXQogIH0KICByZXR1cm4gaQp9CgpmdW5jdGlvbiBpc25hbiAodmFsKSB7CiAgcmV0dXJuIHZhbCAhPT0gdmFsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tc2VsZi1jb21wYXJlCn0KCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMsdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSxyZXF1aXJlKCJidWZmZXIiKS5CdWZmZXIpCn0seyJiYXNlNjQtanMiOjc5LCJidWZmZXIiOjg0LCJpZWVlNzU0Ijo4NiwiaXNhcnJheSI6ODd9XSw4NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCmZ1bmN0aW9uIEV2ZW50RW1pdHRlcigpIHsKICB0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CiAgdGhpcy5fbWF4TGlzdGVuZXJzID0gdGhpcy5fbWF4TGlzdGVuZXJzIHx8IHVuZGVmaW5lZDsKfQptb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKCi8vIEJhY2t3YXJkcy1jb21wYXQgd2l0aCBub2RlIDAuMTAueApFdmVudEVtaXR0ZXIuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzID0gdW5kZWZpbmVkOwpFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9tYXhMaXN0ZW5lcnMgPSB1bmRlZmluZWQ7CgovLyBCeSBkZWZhdWx0IEV2ZW50RW1pdHRlcnMgd2lsbCBwcmludCBhIHdhcm5pbmcgaWYgbW9yZSB0aGFuIDEwIGxpc3RlbmVycyBhcmUKLy8gYWRkZWQgdG8gaXQuIFRoaXMgaXMgYSB1c2VmdWwgZGVmYXVsdCB3aGljaCBoZWxwcyBmaW5kaW5nIG1lbW9yeSBsZWFrcy4KRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnMgPSAxMDsKCi8vIE9idmlvdXNseSBub3QgYWxsIEVtaXR0ZXJzIHNob3VsZCBiZSBsaW1pdGVkIHRvIDEwLiBUaGlzIGZ1bmN0aW9uIGFsbG93cwovLyB0aGF0IHRvIGJlIGluY3JlYXNlZC4gU2V0IHRvIHplcm8gZm9yIHVubGltaXRlZC4KRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5zZXRNYXhMaXN0ZW5lcnMgPSBmdW5jdGlvbihuKSB7CiAgaWYgKCFpc051bWJlcihuKSB8fCBuIDwgMCB8fCBpc05hTihuKSkKICAgIHRocm93IFR5cGVFcnJvcignbiBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyJyk7CiAgdGhpcy5fbWF4TGlzdGVuZXJzID0gbjsKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKHR5cGUpIHsKICB2YXIgZXIsIGhhbmRsZXIsIGxlbiwgYXJncywgaSwgbGlzdGVuZXJzOwoKICBpZiAoIXRoaXMuX2V2ZW50cykKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoKICAvLyBJZiB0aGVyZSBpcyBubyAnZXJyb3InIGV2ZW50IGxpc3RlbmVyIHRoZW4gdGhyb3cuCiAgaWYgKHR5cGUgPT09ICdlcnJvcicpIHsKICAgIGlmICghdGhpcy5fZXZlbnRzLmVycm9yIHx8CiAgICAgICAgKGlzT2JqZWN0KHRoaXMuX2V2ZW50cy5lcnJvcikgJiYgIXRoaXMuX2V2ZW50cy5lcnJvci5sZW5ndGgpKSB7CiAgICAgIGVyID0gYXJndW1lbnRzWzFdOwogICAgICBpZiAoZXIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIHRocm93IGVyOyAvLyBVbmhhbmRsZWQgJ2Vycm9yJyBldmVudAogICAgICB9IGVsc2UgewogICAgICAgIC8vIEF0IGxlYXN0IGdpdmUgc29tZSBraW5kIG9mIGNvbnRleHQgdG8gdGhlIHVzZXIKICAgICAgICB2YXIgZXJyID0gbmV3IEVycm9yKCdVbmNhdWdodCwgdW5zcGVjaWZpZWQgImVycm9yIiBldmVudC4gKCcgKyBlciArICcpJyk7CiAgICAgICAgZXJyLmNvbnRleHQgPSBlcjsKICAgICAgICB0aHJvdyBlcnI7CiAgICAgIH0KICAgIH0KICB9CgogIGhhbmRsZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07CgogIGlmIChpc1VuZGVmaW5lZChoYW5kbGVyKSkKICAgIHJldHVybiBmYWxzZTsKCiAgaWYgKGlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAvLyBmYXN0IGNhc2VzCiAgICAgIGNhc2UgMToKICAgICAgICBoYW5kbGVyLmNhbGwodGhpcyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIC8vIHNsb3dlcgogICAgICBkZWZhdWx0OgogICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIGhhbmRsZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdChoYW5kbGVyKSkgewogICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICBsaXN0ZW5lcnMgPSBoYW5kbGVyLnNsaWNlKCk7CiAgICBsZW4gPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKQogICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkodGhpcywgYXJncyk7CiAgfQoKICByZXR1cm4gdHJ1ZTsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogIHZhciBtOwoKICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICB0aGlzLl9ldmVudHMgPSB7fTsKCiAgLy8gVG8gYXZvaWQgcmVjdXJzaW9uIGluIHRoZSBjYXNlIHRoYXQgdHlwZSA9PT0gIm5ld0xpc3RlbmVyIiEgQmVmb3JlCiAgLy8gYWRkaW5nIGl0IHRvIHRoZSBsaXN0ZW5lcnMsIGZpcnN0IGVtaXQgIm5ld0xpc3RlbmVyIi4KICBpZiAodGhpcy5fZXZlbnRzLm5ld0xpc3RlbmVyKQogICAgdGhpcy5lbWl0KCduZXdMaXN0ZW5lcicsIHR5cGUsCiAgICAgICAgICAgICAgaXNGdW5jdGlvbihsaXN0ZW5lci5saXN0ZW5lcikgPwogICAgICAgICAgICAgIGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIpOwoKICBpZiAoIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgIC8vIE9wdGltaXplIHRoZSBjYXNlIG9mIG9uZSBsaXN0ZW5lci4gRG9uJ3QgbmVlZCB0aGUgZXh0cmEgYXJyYXkgb2JqZWN0LgogICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gbGlzdGVuZXI7CiAgZWxzZSBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgZ290IGFuIGFycmF5LCBqdXN0IGFwcGVuZC4KICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKICBlbHNlCiAgICAvLyBBZGRpbmcgdGhlIHNlY29uZCBlbGVtZW50LCBuZWVkIHRvIGNoYW5nZSB0byBhcnJheS4KICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IFt0aGlzLl9ldmVudHNbdHlwZV0sIGxpc3RlbmVyXTsKCiAgLy8gQ2hlY2sgZm9yIGxpc3RlbmVyIGxlYWsKICBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSAmJiAhdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCkgewogICAgaWYgKCFpc1VuZGVmaW5lZCh0aGlzLl9tYXhMaXN0ZW5lcnMpKSB7CiAgICAgIG0gPSB0aGlzLl9tYXhMaXN0ZW5lcnM7CiAgICB9IGVsc2UgewogICAgICBtID0gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CiAgICB9CgogICAgaWYgKG0gJiYgbSA+IDAgJiYgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCA+IG0pIHsKICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7CiAgICAgIGNvbnNvbGUuZXJyb3IoJyhub2RlKSB3YXJuaW5nOiBwb3NzaWJsZSBFdmVudEVtaXR0ZXIgbWVtb3J5ICcgKwogICAgICAgICAgICAgICAgICAgICdsZWFrIGRldGVjdGVkLiAlZCBsaXN0ZW5lcnMgYWRkZWQuICcgKwogICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLAogICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGgpOwogICAgICBpZiAodHlwZW9mIGNvbnNvbGUudHJhY2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwCiAgICAgICAgY29uc29sZS50cmFjZSgpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUub24gPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyOwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgdmFyIGZpcmVkID0gZmFsc2U7CgogIGZ1bmN0aW9uIGcoKSB7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGcpOwoKICAgIGlmICghZmlyZWQpIHsKICAgICAgZmlyZWQgPSB0cnVlOwogICAgICBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgZy5saXN0ZW5lciA9IGxpc3RlbmVyOwogIHRoaXMub24odHlwZSwgZyk7CgogIHJldHVybiB0aGlzOwp9OwoKLy8gZW1pdHMgYSAncmVtb3ZlTGlzdGVuZXInIGV2ZW50IGlmZiB0aGUgbGlzdGVuZXIgd2FzIHJlbW92ZWQKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgdmFyIGxpc3QsIHBvc2l0aW9uLCBsZW5ndGgsIGk7CgogIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgcmV0dXJuIHRoaXM7CgogIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgbGVuZ3RoID0gbGlzdC5sZW5ndGg7CiAgcG9zaXRpb24gPSAtMTsKCiAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8CiAgICAgIChpc0Z1bmN0aW9uKGxpc3QubGlzdGVuZXIpICYmIGxpc3QubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CgogIH0gZWxzZSBpZiAoaXNPYmplY3QobGlzdCkpIHsKICAgIGZvciAoaSA9IGxlbmd0aDsgaS0tID4gMDspIHsKICAgICAgaWYgKGxpc3RbaV0gPT09IGxpc3RlbmVyIHx8CiAgICAgICAgICAobGlzdFtpXS5saXN0ZW5lciAmJiBsaXN0W2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZiAocG9zaXRpb24gPCAwKQogICAgICByZXR1cm4gdGhpczsKCiAgICBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKICAgICAgbGlzdC5sZW5ndGggPSAwOwogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgfSBlbHNlIHsKICAgICAgbGlzdC5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgfQoKICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CiAgfQoKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogIHZhciBrZXksIGxpc3RlbmVyczsKCiAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICByZXR1cm4gdGhpczsKCiAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdAogIGlmICghdGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKSB7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICBlbHNlIGlmICh0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8vIGVtaXQgcmVtb3ZlTGlzdGVuZXIgZm9yIGFsbCBsaXN0ZW5lcnMgb24gYWxsIGV2ZW50cwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICBmb3IgKGtleSBpbiB0aGlzLl9ldmVudHMpIHsKICAgICAgaWYgKGtleSA9PT0gJ3JlbW92ZUxpc3RlbmVyJykgY29udGludWU7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CiAgICB9CiAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygncmVtb3ZlTGlzdGVuZXInKTsKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CgogIGlmIChpc0Z1bmN0aW9uKGxpc3RlbmVycykpIHsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzKTsKICB9IGVsc2UgaWYgKGxpc3RlbmVycykgewogICAgLy8gTElGTyBvcmRlcgogICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGgpCiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7CiAgfQogIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CgogIHJldHVybiB0aGlzOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIHJldDsKICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgcmV0ID0gW107CiAgZWxzZSBpZiAoaXNGdW5jdGlvbih0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgcmV0ID0gW3RoaXMuX2V2ZW50c1t0eXBlXV07CiAgZWxzZQogICAgcmV0ID0gdGhpcy5fZXZlbnRzW3R5cGVdLnNsaWNlKCk7CiAgcmV0dXJuIHJldDsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsKICBpZiAodGhpcy5fZXZlbnRzKSB7CiAgICB2YXIgZXZsaXN0ZW5lciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKCiAgICBpZiAoaXNGdW5jdGlvbihldmxpc3RlbmVyKSkKICAgICAgcmV0dXJuIDE7CiAgICBlbHNlIGlmIChldmxpc3RlbmVyKQogICAgICByZXR1cm4gZXZsaXN0ZW5lci5sZW5ndGg7CiAgfQogIHJldHVybiAwOwp9OwoKRXZlbnRFbWl0dGVyLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJDb3VudCh0eXBlKTsKfTsKCmZ1bmN0aW9uIGlzRnVuY3Rpb24oYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7Cn0KCmZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKfQoKZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKfQoKZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwp9Cgp9LHt9XSw4NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmV4cG9ydHMucmVhZCA9IGZ1bmN0aW9uIChidWZmZXIsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CiAgdmFyIGUsIG0KICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxCiAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDEKICB2YXIgZUJpYXMgPSBlTWF4ID4+IDEKICB2YXIgbkJpdHMgPSAtNwogIHZhciBpID0gaXNMRSA/IChuQnl0ZXMgLSAxKSA6IDAKICB2YXIgZCA9IGlzTEUgPyAtMSA6IDEKICB2YXIgcyA9IGJ1ZmZlcltvZmZzZXQgKyBpXQoKICBpICs9IGQKCiAgZSA9IHMgJiAoKDEgPDwgKC1uQml0cykpIC0gMSkKICBzID4+PSAoLW5CaXRzKQogIG5CaXRzICs9IGVMZW4KICBmb3IgKDsgbkJpdHMgPiAwOyBlID0gKGUgKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CgogIG0gPSBlICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpCiAgZSA+Pj0gKC1uQml0cykKICBuQml0cyArPSBtTGVuCiAgZm9yICg7IG5CaXRzID4gMDsgbSA9IChtICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQoKICBpZiAoZSA9PT0gMCkgewogICAgZSA9IDEgLSBlQmlhcwogIH0gZWxzZSBpZiAoZSA9PT0gZU1heCkgewogICAgcmV0dXJuIG0gPyBOYU4gOiAoKHMgPyAtMSA6IDEpICogSW5maW5pdHkpCiAgfSBlbHNlIHsKICAgIG0gPSBtICsgTWF0aC5wb3coMiwgbUxlbikKICAgIGUgPSBlIC0gZUJpYXMKICB9CiAgcmV0dXJuIChzID8gLTEgOiAxKSAqIG0gKiBNYXRoLnBvdygyLCBlIC0gbUxlbikKfQoKZXhwb3J0cy53cml0ZSA9IGZ1bmN0aW9uIChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogIHZhciBlLCBtLCBjCiAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMQogIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxCiAgdmFyIGVCaWFzID0gZU1heCA+PiAxCiAgdmFyIHJ0ID0gKG1MZW4gPT09IDIzID8gTWF0aC5wb3coMiwgLTI0KSAtIE1hdGgucG93KDIsIC03NykgOiAwKQogIHZhciBpID0gaXNMRSA/IDAgOiAobkJ5dGVzIC0gMSkKICB2YXIgZCA9IGlzTEUgPyAxIDogLTEKICB2YXIgcyA9IHZhbHVlIDwgMCB8fCAodmFsdWUgPT09IDAgJiYgMSAvIHZhbHVlIDwgMCkgPyAxIDogMAoKICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKQoKICBpZiAoaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBJbmZpbml0eSkgewogICAgbSA9IGlzTmFOKHZhbHVlKSA/IDEgOiAwCiAgICBlID0gZU1heAogIH0gZWxzZSB7CiAgICBlID0gTWF0aC5mbG9vcihNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMikKICAgIGlmICh2YWx1ZSAqIChjID0gTWF0aC5wb3coMiwgLWUpKSA8IDEpIHsKICAgICAgZS0tCiAgICAgIGMgKj0gMgogICAgfQogICAgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgIHZhbHVlICs9IHJ0IC8gYwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgKz0gcnQgKiBNYXRoLnBvdygyLCAxIC0gZUJpYXMpCiAgICB9CiAgICBpZiAodmFsdWUgKiBjID49IDIpIHsKICAgICAgZSsrCiAgICAgIGMgLz0gMgogICAgfQoKICAgIGlmIChlICsgZUJpYXMgPj0gZU1heCkgewogICAgICBtID0gMAogICAgICBlID0gZU1heAogICAgfSBlbHNlIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICBtID0gKCh2YWx1ZSAqIGMpIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKQogICAgICBlID0gZSArIGVCaWFzCiAgICB9IGVsc2UgewogICAgICBtID0gdmFsdWUgKiBNYXRoLnBvdygyLCBlQmlhcyAtIDEpICogTWF0aC5wb3coMiwgbUxlbikKICAgICAgZSA9IDAKICAgIH0KICB9CgogIGZvciAoOyBtTGVuID49IDg7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IG0gJiAweGZmLCBpICs9IGQsIG0gLz0gMjU2LCBtTGVuIC09IDgpIHt9CgogIGUgPSAoZSA8PCBtTGVuKSB8IG0KICBlTGVuICs9IG1MZW4KICBmb3IgKDsgZUxlbiA+IDA7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IGUgJiAweGZmLCBpICs9IGQsIGUgLz0gMjU2LCBlTGVuIC09IDgpIHt9CgogIGJ1ZmZlcltvZmZzZXQgKyBpIC0gZF0gfD0gcyAqIDEyOAp9Cgp9LHt9XSw4NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB0b1N0cmluZyA9IHt9LnRvU3RyaW5nOwoKbW9kdWxlLmV4cG9ydHMgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChhcnIpIHsKICByZXR1cm4gdG9TdHJpbmcuY2FsbChhcnIpID09ICdbb2JqZWN0IEFycmF5XSc7Cn07Cgp9LHt9XSw4ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbihleHBvcnRzKSB7CiAgInVzZSBzdHJpY3QiOwoKICBmdW5jdGlvbiBpc0FycmF5KG9iaikgewogICAgaWYgKG9iaiAhPT0gbnVsbCkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IEFycmF5XSI7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICAgIGlmIChvYmogIT09IG51bGwpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBPYmplY3RdIjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKSB7CiAgICAvLyBDaGVjayB0aGUgc2NhbGFyIGNhc2UgZmlyc3QuCiAgICBpZiAoZmlyc3QgPT09IHNlY29uZCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLyBDaGVjayBpZiB0aGV5IGFyZSB0aGUgc2FtZSB0eXBlLgogICAgdmFyIGZpcnN0VHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChmaXJzdCk7CiAgICBpZiAoZmlyc3RUeXBlICE9PSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc2Vjb25kKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvLyBXZSBrbm93IHRoYXQgZmlyc3QgYW5kIHNlY29uZCBoYXZlIHRoZSBzYW1lIHR5cGUgc28gd2UgY2FuIGp1c3QgY2hlY2sgdGhlCiAgICAvLyBmaXJzdCB0eXBlIGZyb20gbm93IG9uLgogICAgaWYgKGlzQXJyYXkoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgdGhleSdyZSBub3QgdGhlIHNhbWUgbGVuZ3RoOwogICAgICBpZiAoZmlyc3QubGVuZ3RoICE9PSBzZWNvbmQubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlyc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoc3RyaWN0RGVlcEVxdWFsKGZpcnN0W2ldLCBzZWNvbmRbaV0pID09PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChpc09iamVjdChmaXJzdCkgPT09IHRydWUpIHsKICAgICAgLy8gQW4gb2JqZWN0IGlzIGVxdWFsIGlmIGl0IGhhcyB0aGUgc2FtZSBrZXkvdmFsdWUgcGFpcnMuCiAgICAgIHZhciBrZXlzU2VlbiA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gZmlyc3QpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChmaXJzdCwga2V5KSkgewogICAgICAgICAgaWYgKHN0cmljdERlZXBFcXVhbChmaXJzdFtrZXldLCBzZWNvbmRba2V5XSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGtleXNTZWVuW2tleV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBOb3cgY2hlY2sgdGhhdCB0aGVyZSBhcmVuJ3QgYW55IGtleXMgaW4gc2Vjb25kIHRoYXQgd2VyZW4ndAogICAgICAvLyBpbiBmaXJzdC4KICAgICAgZm9yICh2YXIga2V5MiBpbiBzZWNvbmQpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzZWNvbmQsIGtleTIpKSB7CiAgICAgICAgICBpZiAoa2V5c1NlZW5ba2V5Ml0gIT09IHRydWUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGlzRmFsc2Uob2JqKSB7CiAgICAvLyBGcm9tIHRoZSBzcGVjOgogICAgLy8gQSBmYWxzZSB2YWx1ZSBjb3JyZXNwb25kcyB0byB0aGUgZm9sbG93aW5nIHZhbHVlczoKICAgIC8vIEVtcHR5IGxpc3QKICAgIC8vIEVtcHR5IG9iamVjdAogICAgLy8gRW1wdHkgc3RyaW5nCiAgICAvLyBGYWxzZSBib29sZWFuCiAgICAvLyBudWxsIHZhbHVlCgogICAgLy8gRmlyc3QgY2hlY2sgdGhlIHNjYWxhciB2YWx1ZXMuCiAgICBpZiAob2JqID09PSAiIiB8fCBvYmogPT09IGZhbHNlIHx8IG9iaiA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChpc0FycmF5KG9iaikgJiYgb2JqLmxlbmd0aCA9PT0gMCkgewogICAgICAgIC8vIENoZWNrIGZvciBhbiBlbXB0eSBhcnJheS4KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgIC8vIENoZWNrIGZvciBhbiBlbXB0eSBvYmplY3QuCiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgYW55IGtleXMsIHRoZW4KICAgICAgICAgICAgLy8gdGhlIG9iamVjdCBpcyBub3QgZW1wdHkgc28gdGhlIG9iamVjdAogICAgICAgICAgICAvLyBpcyBub3QgZmFsc2UuCiAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gb2JqVmFsdWVzKG9iaikgewogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgdmFyIHZhbHVlcyA9IFtdOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhbHVlcy5wdXNoKG9ialtrZXlzW2ldXSk7CiAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2UoYSwgYikgewogICAgICB2YXIgbWVyZ2VkID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgICBtZXJnZWRba2V5XSA9IGFba2V5XTsKICAgICAgfQogICAgICBmb3IgKHZhciBrZXkyIGluIGIpIHsKICAgICAgICAgIG1lcmdlZFtrZXkyXSA9IGJba2V5Ml07CiAgICAgIH0KICAgICAgcmV0dXJuIG1lcmdlZDsKICB9CgogIHZhciB0cmltTGVmdDsKICBpZiAodHlwZW9mIFN0cmluZy5wcm90b3R5cGUudHJpbUxlZnQgPT09ICJmdW5jdGlvbiIpIHsKICAgIHRyaW1MZWZ0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBzdHIudHJpbUxlZnQoKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIHRyaW1MZWZ0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgIHJldHVybiBzdHIubWF0Y2goL15ccyooLiopLylbMV07CiAgICB9OwogIH0KCiAgLy8gVHlwZSBjb25zdGFudHMgdXNlZCB0byBkZWZpbmUgZnVuY3Rpb25zLgogIHZhciBUWVBFX05VTUJFUiA9IDA7CiAgdmFyIFRZUEVfQU5ZID0gMTsKICB2YXIgVFlQRV9TVFJJTkcgPSAyOwogIHZhciBUWVBFX0FSUkFZID0gMzsKICB2YXIgVFlQRV9PQkpFQ1QgPSA0OwogIHZhciBUWVBFX0JPT0xFQU4gPSA1OwogIHZhciBUWVBFX0VYUFJFRiA9IDY7CiAgdmFyIFRZUEVfTlVMTCA9IDc7CiAgdmFyIFRZUEVfQVJSQVlfTlVNQkVSID0gODsKICB2YXIgVFlQRV9BUlJBWV9TVFJJTkcgPSA5OwogIHZhciBUWVBFX05BTUVfVEFCTEUgPSB7CiAgICAwOiAnbnVtYmVyJywKICAgIDE6ICdhbnknLAogICAgMjogJ3N0cmluZycsCiAgICAzOiAnYXJyYXknLAogICAgNDogJ29iamVjdCcsCiAgICA1OiAnYm9vbGVhbicsCiAgICA2OiAnZXhwcmVzc2lvbicsCiAgICA3OiAnbnVsbCcsCiAgICA4OiAnQXJyYXk8bnVtYmVyPicsCiAgICA5OiAnQXJyYXk8c3RyaW5nPicKICB9OwoKICB2YXIgVE9LX0VPRiA9ICJFT0YiOwogIHZhciBUT0tfVU5RVU9URURJREVOVElGSUVSID0gIlVucXVvdGVkSWRlbnRpZmllciI7CiAgdmFyIFRPS19RVU9URURJREVOVElGSUVSID0gIlF1b3RlZElkZW50aWZpZXIiOwogIHZhciBUT0tfUkJSQUNLRVQgPSAiUmJyYWNrZXQiOwogIHZhciBUT0tfUlBBUkVOID0gIlJwYXJlbiI7CiAgdmFyIFRPS19DT01NQSA9ICJDb21tYSI7CiAgdmFyIFRPS19DT0xPTiA9ICJDb2xvbiI7CiAgdmFyIFRPS19SQlJBQ0UgPSAiUmJyYWNlIjsKICB2YXIgVE9LX05VTUJFUiA9ICJOdW1iZXIiOwogIHZhciBUT0tfQ1VSUkVOVCA9ICJDdXJyZW50IjsKICB2YXIgVE9LX0VYUFJFRiA9ICJFeHByZWYiOwogIHZhciBUT0tfUElQRSA9ICJQaXBlIjsKICB2YXIgVE9LX09SID0gIk9yIjsKICB2YXIgVE9LX0FORCA9ICJBbmQiOwogIHZhciBUT0tfRVEgPSAiRVEiOwogIHZhciBUT0tfR1QgPSAiR1QiOwogIHZhciBUT0tfTFQgPSAiTFQiOwogIHZhciBUT0tfR1RFID0gIkdURSI7CiAgdmFyIFRPS19MVEUgPSAiTFRFIjsKICB2YXIgVE9LX05FID0gIk5FIjsKICB2YXIgVE9LX0ZMQVRURU4gPSAiRmxhdHRlbiI7CiAgdmFyIFRPS19TVEFSID0gIlN0YXIiOwogIHZhciBUT0tfRklMVEVSID0gIkZpbHRlciI7CiAgdmFyIFRPS19ET1QgPSAiRG90IjsKICB2YXIgVE9LX05PVCA9ICJOb3QiOwogIHZhciBUT0tfTEJSQUNFID0gIkxicmFjZSI7CiAgdmFyIFRPS19MQlJBQ0tFVCA9ICJMYnJhY2tldCI7CiAgdmFyIFRPS19MUEFSRU49ICJMcGFyZW4iOwogIHZhciBUT0tfTElURVJBTD0gIkxpdGVyYWwiOwoKICAvLyBUaGUgIiYiLCAiWyIsICI8IiwgIj4iIHRva2VucwogIC8vIGFyZSBub3QgaW4gYmFzaWNUb2tlbiBiZWNhdXNlCiAgLy8gdGhlcmUgYXJlIHR3byB0b2tlbiB2YXJpYW50cwogIC8vICgiJiYiLCAiWz8iLCAiPD0iLCAiPj0iKS4gIFRoaXMgaXMgc3BlY2lhbGx5IGhhbmRsZWQKICAvLyBiZWxvdy4KCiAgdmFyIGJhc2ljVG9rZW5zID0gewogICAgIi4iOiBUT0tfRE9ULAogICAgIioiOiBUT0tfU1RBUiwKICAgICIsIjogVE9LX0NPTU1BLAogICAgIjoiOiBUT0tfQ09MT04sCiAgICAieyI6IFRPS19MQlJBQ0UsCiAgICAifSI6IFRPS19SQlJBQ0UsCiAgICAiXSI6IFRPS19SQlJBQ0tFVCwKICAgICIoIjogVE9LX0xQQVJFTiwKICAgICIpIjogVE9LX1JQQVJFTiwKICAgICJAIjogVE9LX0NVUlJFTlQKICB9OwoKICB2YXIgb3BlcmF0b3JTdGFydFRva2VuID0gewogICAgICAiPCI6IHRydWUsCiAgICAgICI+IjogdHJ1ZSwKICAgICAgIj0iOiB0cnVlLAogICAgICAiISI6IHRydWUKICB9OwoKICB2YXIgc2tpcENoYXJzID0gewogICAgICAiICI6IHRydWUsCiAgICAgICJcdCI6IHRydWUsCiAgICAgICJcbiI6IHRydWUKICB9OwoKCiAgZnVuY3Rpb24gaXNBbHBoYShjaCkgewogICAgICByZXR1cm4gKGNoID49ICJhIiAmJiBjaCA8PSAieiIpIHx8CiAgICAgICAgICAgICAoY2ggPj0gIkEiICYmIGNoIDw9ICJaIikgfHwKICAgICAgICAgICAgIGNoID09PSAiXyI7CiAgfQoKICBmdW5jdGlvbiBpc051bShjaCkgewogICAgICByZXR1cm4gKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICBjaCA9PT0gIi0iOwogIH0KICBmdW5jdGlvbiBpc0FscGhhTnVtKGNoKSB7CiAgICAgIHJldHVybiAoY2ggPj0gImEiICYmIGNoIDw9ICJ6IikgfHwKICAgICAgICAgICAgIChjaCA+PSAiQSIgJiYgY2ggPD0gIloiKSB8fAogICAgICAgICAgICAgKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICBjaCA9PT0gIl8iOwogIH0KCiAgZnVuY3Rpb24gTGV4ZXIoKSB7CiAgfQogIExleGVyLnByb3RvdHlwZSA9IHsKICAgICAgdG9rZW5pemU6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdmFyIHRva2VucyA9IFtdOwogICAgICAgICAgdGhpcy5fY3VycmVudCA9IDA7CiAgICAgICAgICB2YXIgc3RhcnQ7CiAgICAgICAgICB2YXIgaWRlbnRpZmllcjsKICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgIHdoaWxlICh0aGlzLl9jdXJyZW50IDwgc3RyZWFtLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FscGhhKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVVucXVvdGVkSWRlbnRpZmllcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1VOUVVPVEVESURFTlRJRklFUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChiYXNpY1Rva2Vuc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IGJhc2ljVG9rZW5zW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdHJlYW1bdGhpcy5fY3VycmVudF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiB0aGlzLl9jdXJyZW50fSk7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgICAgdG9rZW4gPSB0aGlzLl9jb25zdW1lTnVtYmVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIlsiKSB7CiAgICAgICAgICAgICAgICAgIC8vIE5vIG5lZWQgdG8gaW5jcmVtZW50IHRoaXMuX2N1cnJlbnQuICBUaGlzIGhhcHBlbnMKICAgICAgICAgICAgICAgICAgLy8gaW4gX2NvbnN1bWVMQnJhY2tldAogICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2NvbnN1bWVMQnJhY2tldChzdHJlYW0pOwogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJcIiIpIHsKICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVF1b3RlZElkZW50aWZpZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19RVU9URURJREVOVElGSUVSLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiciKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVSYXdTdHJpbmdMaXRlcmFsKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfTElURVJBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJgIikgewogICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIHZhciBsaXRlcmFsID0gdGhpcy5fY29uc3VtZUxpdGVyYWwoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19MSVRFUkFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGxpdGVyYWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yU3RhcnRUb2tlbltzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godGhpcy5fY29uc3VtZU9wZXJhdG9yKHN0cmVhbSkpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2tpcENoYXJzW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgd2hpdGVzcGFjZS4KICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICImIikgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19BTkQsIHZhbHVlOiAiJiYiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfRVhQUkVGLCB2YWx1ZTogIiYiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAifCIpIHsKICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJ8IikgewogICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19PUiwgdmFsdWU6ICJ8fCIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19QSVBFLCB2YWx1ZTogInwiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiVW5rbm93biBjaGFyYWN0ZXI6IiArIHN0cmVhbVt0aGlzLl9jdXJyZW50XSk7CiAgICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiTGV4ZXJFcnJvciI7CiAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0b2tlbnM7CiAgICAgIH0sCgogICAgICBfY29uc3VtZVVucXVvdGVkSWRlbnRpZmllcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgd2hpbGUgKHRoaXMuX2N1cnJlbnQgPCBzdHJlYW0ubGVuZ3RoICYmIGlzQWxwaGFOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpOwogICAgICB9LAoKICAgICAgX2NvbnN1bWVRdW90ZWRJZGVudGlmaWVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICJcIiIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgZG91YmxlIHF1b3RlIGFuZCB5b3UgY2FuIGVzY2FwZSBhbiBlc2NhcGUuCiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiXCIiKSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICB9LAoKICAgICAgX2NvbnN1bWVSYXdTdHJpbmdMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICInIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBzaW5nbGUgcXVvdGUgYW5kIHlvdSBjYW4gZXNjYXBlIGFuIGVzY2FwZS4KICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICInIikpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB2YXIgbGl0ZXJhbCA9IHN0cmVhbS5zbGljZShzdGFydCArIDEsIHRoaXMuX2N1cnJlbnQgLSAxKTsKICAgICAgICAgIHJldHVybiBsaXRlcmFsLnJlcGxhY2UoIlxcJyIsICInIik7CiAgICAgIH0sCgogICAgICBfY29uc3VtZU51bWJlcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VJbnQoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19OVU1CRVIsIHZhbHVlOiB2YWx1ZSwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgfSwKCiAgICAgIF9jb25zdW1lTEJyYWNrZXQ6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI/IikgewogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GSUxURVIsIHZhbHVlOiAiWz8iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJdIikgewogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GTEFUVEVOLCB2YWx1ZTogIltdIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTEJSQUNLRVQsIHZhbHVlOiAiWyIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBfY29uc3VtZU9wZXJhdG9yOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICB2YXIgc3RhcnRpbmdDaGFyID0gc3RyZWFtW3N0YXJ0XTsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIGlmIChzdGFydGluZ0NoYXIgPT09ICIhIikgewogICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05FLCB2YWx1ZTogIiE9Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTk9ULCB2YWx1ZTogIiEiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPCIpIHsKICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MVEUsIHZhbHVlOiAiPD0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xULCB2YWx1ZTogIjwiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPiIpIHsKICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVEUsIHZhbHVlOiAiPj0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0dULCB2YWx1ZTogIj4iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPSIpIHsKICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19FUSwgdmFsdWU6ICI9PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9LAoKICAgICAgX2NvbnN1bWVMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgIHZhciBsaXRlcmFsOwogICAgICAgICAgd2hpbGUoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiYCIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgbGl0ZXJhbCBjaGFyIG9yIHlvdSBjYW4gZXNjYXBlIHRoZSBlc2NhcGUuCiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiYCIpKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxpdGVyYWxTdHJpbmcgPSB0cmltTGVmdChzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICAgIGxpdGVyYWxTdHJpbmcgPSBsaXRlcmFsU3RyaW5nLnJlcGxhY2UoIlxcYCIsICJgIik7CiAgICAgICAgICBpZiAodGhpcy5fbG9va3NMaWtlSlNPTihsaXRlcmFsU3RyaW5nKSkgewogICAgICAgICAgICAgIGxpdGVyYWwgPSBKU09OLnBhcnNlKGxpdGVyYWxTdHJpbmcpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBUcnkgdG8gSlNPTiBwYXJzZSBpdCBhcyAiPGxpdGVyYWw+IgogICAgICAgICAgICAgIGxpdGVyYWwgPSBKU09OLnBhcnNlKCJcIiIgKyBsaXRlcmFsU3RyaW5nICsgIlwiIik7CiAgICAgICAgICB9CiAgICAgICAgICAvLyArMSBnZXRzIHVzIHRvIHRoZSBlbmRpbmcgImAiLCArMSB0byBtb3ZlIG9uIHRvIHRoZSBuZXh0IGNoYXIuCiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICByZXR1cm4gbGl0ZXJhbDsKICAgICAgfSwKCiAgICAgIF9sb29rc0xpa2VKU09OOiBmdW5jdGlvbihsaXRlcmFsU3RyaW5nKSB7CiAgICAgICAgICB2YXIgc3RhcnRpbmdDaGFycyA9ICJbe1wiIjsKICAgICAgICAgIHZhciBqc29uTGl0ZXJhbHMgPSBbInRydWUiLCAiZmFsc2UiLCAibnVsbCJdOwogICAgICAgICAgdmFyIG51bWJlckxvb2tpbmcgPSAiLTAxMjM0NTY3ODkiOwoKICAgICAgICAgIGlmIChsaXRlcmFsU3RyaW5nID09PSAiIikgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFycy5pbmRleE9mKGxpdGVyYWxTdHJpbmdbMF0pID49IDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoanNvbkxpdGVyYWxzLmluZGV4T2YobGl0ZXJhbFN0cmluZykgPj0gMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChudW1iZXJMb29raW5nLmluZGV4T2YobGl0ZXJhbFN0cmluZ1swXSkgPj0gMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgfQogIH07CgogICAgICB2YXIgYmluZGluZ1Bvd2VyID0ge307CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfRU9GXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfVU5RVU9URURJREVOVElGSUVSXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfUVVPVEVESURFTlRJRklFUl0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX1JCUkFDS0VUXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfUlBBUkVOXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfQ09NTUFdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19SQlJBQ0VdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19OVU1CRVJdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19DVVJSRU5UXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfRVhQUkVGXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfUElQRV0gPSAxOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX09SXSA9IDI7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfQU5EXSA9IDM7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfRVFdID0gNTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19HVF0gPSA1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0xUXSA9IDU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfR1RFXSA9IDU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFRFXSA9IDU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTkVdID0gNTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19GTEFUVEVOXSA9IDk7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfU1RBUl0gPSAyMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19GSUxURVJdID0gMjE7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfRE9UXSA9IDQwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX05PVF0gPSA0NTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0VdID0gNTA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTEJSQUNLRVRdID0gNTU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFBBUkVOXSA9IDYwOwoKICBmdW5jdGlvbiBQYXJzZXIoKSB7CiAgfQoKICBQYXJzZXIucHJvdG90eXBlID0gewogICAgICBwYXJzZTogZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgICAgICAgdGhpcy5fbG9hZFRva2VucyhleHByZXNzaW9uKTsKICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgdmFyIGFzdCA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19FT0YpIHsKICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgIlVuZXhwZWN0ZWQgdG9rZW4gdHlwZTogIiArIHQudHlwZSArICIsIHZhbHVlOiAiICsgdC52YWx1ZSk7CiAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYXN0OwogICAgICB9LAoKICAgICAgX2xvYWRUb2tlbnM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgICAgIHZhciBsZXhlciA9IG5ldyBMZXhlcigpOwogICAgICAgICAgdmFyIHRva2VucyA9IGxleGVyLnRva2VuaXplKGV4cHJlc3Npb24pOwogICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19FT0YsIHZhbHVlOiAiIiwgc3RhcnQ6IGV4cHJlc3Npb24ubGVuZ3RofSk7CiAgICAgICAgICB0aGlzLnRva2VucyA9IHRva2VuczsKICAgICAgfSwKCiAgICAgIGV4cHJlc3Npb246IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgdmFyIGxlZnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgdmFyIGxlZnQgPSB0aGlzLm51ZChsZWZ0VG9rZW4pOwogICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgIHdoaWxlIChyYnAgPCBiaW5kaW5nUG93ZXJbY3VycmVudFRva2VuXSkgewogICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy5sZWQoY3VycmVudFRva2VuLCBsZWZ0KTsKICAgICAgICAgICAgICBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgfSwKCiAgICAgIF9sb29rYWhlYWQ6IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgICAgcmV0dXJuIHRoaXMudG9rZW5zW3RoaXMuaW5kZXggKyBudW1iZXJdLnR5cGU7CiAgICAgIH0sCgogICAgICBfbG9va2FoZWFkVG9rZW46IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgICAgcmV0dXJuIHRoaXMudG9rZW5zW3RoaXMuaW5kZXggKyBudW1iZXJdOwogICAgICB9LAoKICAgICAgX2FkdmFuY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICB9LAoKICAgICAgbnVkOiBmdW5jdGlvbih0b2tlbikgewogICAgICAgIHZhciBsZWZ0OwogICAgICAgIHZhciByaWdodDsKICAgICAgICB2YXIgZXhwcmVzc2lvbjsKICAgICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHsKICAgICAgICAgIGNhc2UgVE9LX0xJVEVSQUw6CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkxpdGVyYWwiLCB2YWx1ZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgY2FzZSBUT0tfVU5RVU9URURJREVOVElGSUVSOgogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJGaWVsZCIsIG5hbWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgIGNhc2UgVE9LX1FVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgIHZhciBub2RlID0ge3R5cGU6ICJGaWVsZCIsIG5hbWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0xQQVJFTikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJRdW90ZWQgaWRlbnRpZmllciBub3QgYWxsb3dlZCBmb3IgZnVuY3Rpb24gbmFtZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICBjYXNlIFRPS19OT1Q6CiAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5Ob3QpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJOb3RFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtyaWdodF19OwogICAgICAgICAgY2FzZSBUT0tfU1RBUjoKICAgICAgICAgICAgbGVmdCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgcmlnaHQgPSBudWxsOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FuIGhhcHBlbiBpbiBhIG11bHRpc2VsZWN0LAogICAgICAgICAgICAgICAgLy8gW2EsIGIsICpdCiAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJWYWx1ZVByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBjYXNlIFRPS19GSUxURVI6CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxlZCh0b2tlbi50eXBlLCB7dHlwZTogIklkZW50aXR5In0pOwogICAgICAgICAgY2FzZSBUT0tfTEJSQUNFOgogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdEhhc2goKTsKICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgIGxlZnQgPSB7dHlwZTogVE9LX0ZMQVRURU4sIGNoaWxkcmVuOiBbe3R5cGU6ICJJZGVudGl0eSJ9XX07CiAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GbGF0dGVuKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGNhc2UgVE9LX0xCUkFDS0VUOgogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTlVNQkVSIHx8IHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlSW5kZXhFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdElmU2xpY2Uoe3R5cGU6ICJJZGVudGl0eSJ9LCByaWdodCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfU1RBUiAmJgogICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvb2thaGVhZCgxKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFt7dHlwZTogIklkZW50aXR5In0sIHJpZ2h0XX07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RMaXN0KCk7CiAgICAgICAgICBjYXNlIFRPS19DVVJSRU5UOgogICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgIGNhc2UgVE9LX0VYUFJFRjoKICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuRXhwcmVmKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRXhwcmVzc2lvblJlZmVyZW5jZSIsIGNoaWxkcmVuOiBbZXhwcmVzc2lvbl19OwogICAgICAgICAgY2FzZSBUT0tfTFBBUkVOOgogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUlBBUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NVUlJFTlQpIHsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhcmdzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgIHJldHVybiBhcmdzWzBdOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhpcy5fZXJyb3JUb2tlbih0b2tlbik7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgbGVkOiBmdW5jdGlvbih0b2tlbk5hbWUsIGxlZnQpIHsKICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgc3dpdGNoKHRva2VuTmFtZSkgewogICAgICAgICAgY2FzZSBUT0tfRE9UOgogICAgICAgICAgICB2YXIgcmJwID0gYmluZGluZ1Bvd2VyLkRvdDsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1NUQVIpIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VEb3RSSFMocmJwKTsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlN1YmV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQ3JlYXRpbmcgYSBwcm9qZWN0aW9uLgogICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKHJicCk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlZhbHVlUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGNhc2UgVE9LX1BJUEU6CiAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5QaXBlKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfUElQRSwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgY2FzZSBUT0tfT1I6CiAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5Pcik7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk9yRXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGNhc2UgVE9LX0FORDoKICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkFuZCk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkFuZEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBjYXNlIFRPS19MUEFSRU46CiAgICAgICAgICAgIHZhciBuYW1lID0gbGVmdC5uYW1lOwogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiwgbm9kZTsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JQQVJFTikgewogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DVVJSRU5UKSB7CiAgICAgICAgICAgICAgICBleHByZXNzaW9uID0ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhcmdzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgIG5vZGUgPSB7dHlwZTogIkZ1bmN0aW9uIiwgbmFtZTogbmFtZSwgY2hpbGRyZW46IGFyZ3N9OwogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIGNhc2UgVE9LX0ZJTFRFUjoKICAgICAgICAgICAgdmFyIGNvbmRpdGlvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZMQVRURU4pIHsKICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmlsdGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJGaWx0ZXJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodCwgY29uZGl0aW9uXX07CiAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICB2YXIgbGVmdE5vZGUgPSB7dHlwZTogVE9LX0ZMQVRURU4sIGNoaWxkcmVuOiBbbGVmdF19OwogICAgICAgICAgICB2YXIgcmlnaHROb2RlID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GbGF0dGVuKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdE5vZGUsIHJpZ2h0Tm9kZV19OwogICAgICAgICAgY2FzZSBUT0tfRVE6CiAgICAgICAgICBjYXNlIFRPS19ORToKICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgY2FzZSBUT0tfR1RFOgogICAgICAgICAgY2FzZSBUT0tfTFQ6CiAgICAgICAgICBjYXNlIFRPS19MVEU6CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZUNvbXBhcmF0b3IobGVmdCwgdG9rZW5OYW1lKTsKICAgICAgICAgIGNhc2UgVE9LX0xCUkFDS0VUOgogICAgICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRPS19OVU1CRVIgfHwgdG9rZW4udHlwZSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlSW5kZXhFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdElmU2xpY2UobGVmdCwgcmlnaHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19TVEFSKTsKICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhpcy5fZXJyb3JUb2tlbih0aGlzLl9sb29rYWhlYWRUb2tlbigwKSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgX21hdGNoOiBmdW5jdGlvbih0b2tlblR5cGUpIHsKICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IHRva2VuVHlwZSkgewogICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkV4cGVjdGVkICIgKyB0b2tlblR5cGUgKyAiLCBnb3Q6ICIgKyB0LnR5cGUpOwogICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgX2Vycm9yVG9rZW46IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkludmFsaWQgdG9rZW4gKCIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnR5cGUgKyAiKTogXCIiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi52YWx1ZSArICJcIiIpOwogICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfSwKCgogICAgICBfcGFyc2VJbmRleEV4cHJlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTE9OIHx8IHRoaXMuX2xvb2thaGVhZCgxKSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlU2xpY2VFeHByZXNzaW9uKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBub2RlID0gewogICAgICAgICAgICAgICAgICB0eXBlOiAiSW5kZXgiLAogICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fbG9va2FoZWFkVG9rZW4oMCkudmFsdWV9OwogICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICB9LAoKICAgICAgX3Byb2plY3RJZlNsaWNlOiBmdW5jdGlvbihsZWZ0LCByaWdodCkgewogICAgICAgICAgdmFyIGluZGV4RXhwciA9IHt0eXBlOiAiSW5kZXhFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgaWYgKHJpZ2h0LnR5cGUgPT09ICJTbGljZSIpIHsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICB0eXBlOiAiUHJvamVjdGlvbiIsCiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbaW5kZXhFeHByLCB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpXQogICAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBpbmRleEV4cHI7CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBfcGFyc2VTbGljZUV4cHJlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gW3N0YXJ0OmVuZDpzdGVwXSB3aGVyZSBlYWNoIHBhcnQgaXMgb3B0aW9uYWwsIGFzIHdlbGwgYXMgdGhlIGxhc3QKICAgICAgICAgIC8vIGNvbG9uLgogICAgICAgICAgdmFyIHBhcnRzID0gW251bGwsIG51bGwsIG51bGxdOwogICAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICAgIHZhciBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRva2VuICE9PSBUT0tfUkJSQUNLRVQgJiYgaW5kZXggPCAzKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX05VTUJFUikgewogICAgICAgICAgICAgICAgICBwYXJ0c1tpbmRleF0gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKS52YWx1ZTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlN5bnRheCBlcnJvciwgdW5leHBlY3RlZCB0b2tlbjogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJlcnJvciI7CiAgICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0eXBlOiAiU2xpY2UiLAogICAgICAgICAgICAgIGNoaWxkcmVuOiBwYXJ0cwogICAgICAgICAgfTsKICAgICAgfSwKCiAgICAgIF9wYXJzZUNvbXBhcmF0b3I6IGZ1bmN0aW9uKGxlZnQsIGNvbXBhcmF0b3IpIHsKICAgICAgICB2YXIgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyW2NvbXBhcmF0b3JdKTsKICAgICAgICByZXR1cm4ge3R5cGU6ICJDb21wYXJhdG9yIiwgbmFtZTogY29tcGFyYXRvciwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICB9LAoKICAgICAgX3BhcnNlRG90UkhTOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgIHZhciBsb29rYWhlYWQgPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICB2YXIgZXhwclRva2VucyA9IFtUT0tfVU5RVU9URURJREVOVElGSUVSLCBUT0tfUVVPVEVESURFTlRJRklFUiwgVE9LX1NUQVJdOwogICAgICAgICAgaWYgKGV4cHJUb2tlbnMuaW5kZXhPZihsb29rYWhlYWQpID49IDApIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxvb2thaGVhZCA9PT0gVE9LX0xCUkFDS0VUKSB7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDS0VUKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdExpc3QoKTsKICAgICAgICAgIH0gZWxzZSBpZiAobG9va2FoZWFkID09PSBUT0tfTEJSQUNFKSB7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDRSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RIYXNoKCk7CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBfcGFyc2VQcm9qZWN0aW9uUkhTOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgIGlmIChiaW5kaW5nUG93ZXJbdGhpcy5fbG9va2FoZWFkKDApXSA8IDEwKSB7CiAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0xCUkFDS0VUKSB7CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRklMVEVSKSB7CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRE9UKSB7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0RPVCk7CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiU3l0YW54IGVycm9yLCB1bmV4cGVjdGVkIHRva2VuOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC52YWx1ZSArICIoIiArIHQudHlwZSArICIpIik7CiAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmlnaHQ7CiAgICAgIH0sCgogICAgICBfcGFyc2VNdWx0aXNlbGVjdExpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGV4cHJlc3Npb25zID0gW107CiAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICBleHByZXNzaW9ucy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgdG9rZW4gUmJyYWNrZXQiKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdExpc3QiLCBjaGlsZHJlbjogZXhwcmVzc2lvbnN9OwogICAgICB9LAoKICAgICAgX3BhcnNlTXVsdGlzZWxlY3RIYXNoOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcGFpcnMgPSBbXTsKICAgICAgICB2YXIgaWRlbnRpZmllclR5cGVzID0gW1RPS19VTlFVT1RFRElERU5USUZJRVIsIFRPS19RVU9URURJREVOVElGSUVSXTsKICAgICAgICB2YXIga2V5VG9rZW4sIGtleU5hbWUsIHZhbHVlLCBub2RlOwogICAgICAgIGZvciAoOzspIHsKICAgICAgICAgIGtleVRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICBpZiAoaWRlbnRpZmllclR5cGVzLmluZGV4T2Yoa2V5VG9rZW4udHlwZSkgPCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0aW5nIGFuIGlkZW50aWZpZXIgdG9rZW4sIGdvdDogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlUb2tlbi50eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGtleU5hbWUgPSBrZXlUb2tlbi52YWx1ZTsKICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT0xPTik7CiAgICAgICAgICB2YWx1ZSA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgIG5vZGUgPSB7dHlwZTogIktleVZhbHVlUGFpciIsIG5hbWU6IGtleU5hbWUsIHZhbHVlOiB2YWx1ZX07CiAgICAgICAgICBwYWlycy5wdXNoKG5vZGUpOwogICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDRSkgewogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNFKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7dHlwZTogIk11bHRpU2VsZWN0SGFzaCIsIGNoaWxkcmVuOiBwYWlyc307CiAgICAgIH0KICB9OwoKCiAgZnVuY3Rpb24gVHJlZUludGVycHJldGVyKHJ1bnRpbWUpIHsKICAgIHRoaXMucnVudGltZSA9IHJ1bnRpbWU7CiAgfQoKICBUcmVlSW50ZXJwcmV0ZXIucHJvdG90eXBlID0gewogICAgICBzZWFyY2g6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLCB2YWx1ZSk7CiAgICAgIH0sCgogICAgICB2aXNpdDogZnVuY3Rpb24obm9kZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBtYXRjaGVkLCBjdXJyZW50LCByZXN1bHQsIGZpcnN0LCBzZWNvbmQsIGZpZWxkLCBsZWZ0LCByaWdodCwgY29sbGVjdGVkLCBpOwogICAgICAgICAgc3dpdGNoIChub2RlLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiRmllbGQiOgogICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiBpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgZmllbGQgPSB2YWx1ZVtub2RlLm5hbWVdOwogICAgICAgICAgICAgICAgICBpZiAoZmllbGQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmllbGQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgIlN1YmV4cHJlc3Npb24iOgogICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgcmVzdWx0KTsKICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgY2FzZSAiSW5kZXhFeHByZXNzaW9uIjoKICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGxlZnQpOwogICAgICAgICAgICAgIHJldHVybiByaWdodDsKICAgICAgICAgICAgY2FzZSAiSW5kZXgiOgogICAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgaW5kZXggPSBub2RlLnZhbHVlOwogICAgICAgICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgICAgIGluZGV4ID0gdmFsdWUubGVuZ3RoICsgaW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlW2luZGV4XTsKICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIGNhc2UgIlNsaWNlIjoKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNsaWNlUGFyYW1zID0gbm9kZS5jaGlsZHJlbi5zbGljZSgwKTsKICAgICAgICAgICAgICB2YXIgY29tcHV0ZWQgPSB0aGlzLmNvbXB1dGVTbGljZVBhcmFtcyh2YWx1ZS5sZW5ndGgsIHNsaWNlUGFyYW1zKTsKICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBjb21wdXRlZFswXTsKICAgICAgICAgICAgICB2YXIgc3RvcCA9IGNvbXB1dGVkWzFdOwogICAgICAgICAgICAgIHZhciBzdGVwID0gY29tcHV0ZWRbMl07CiAgICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgICAgICAgaWYgKHN0ZXAgPiAwKSB7CiAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZVtpXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA+IHN0b3A7IGkgKz0gc3RlcCkgewogICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIGNhc2UgIlByb2plY3Rpb24iOgogICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGxlZnQgY2hpbGQuCiAgICAgICAgICAgICAgdmFyIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoYmFzZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYmFzZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgYmFzZVtpXSk7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgY2FzZSAiVmFsdWVQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSBsZWZ0IGNoaWxkLgogICAgICAgICAgICAgIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0KGJhc2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IG9ialZhbHVlcyhiYXNlKTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZXNbaV0pOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgIGNhc2UgIkZpbHRlclByb2plY3Rpb24iOgogICAgICAgICAgICAgIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoYmFzZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgICAgICAgICAgICB2YXIgZmluYWxSZXN1bHRzID0gW107CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJhc2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMl0sIGJhc2VbaV0pOwogICAgICAgICAgICAgICAgaWYgKCFpc0ZhbHNlKG1hdGNoZWQpKSB7CiAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnB1c2goYmFzZVtpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmlsdGVyZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGZpbHRlcmVkW2pdKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZpbmFsUmVzdWx0cy5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmluYWxSZXN1bHRzOwogICAgICAgICAgICBjYXNlICJDb21wYXJhdG9yIjoKICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIHNlY29uZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgIHN3aXRjaChub2RlLm5hbWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgVE9LX0VROgogICAgICAgICAgICAgICAgICByZXN1bHQgPSBzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBUT0tfTkU6CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9ICFzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBUT0tfR1Q6CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0ID4gc2Vjb25kOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgVE9LX0dURToKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPj0gc2Vjb25kOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgVE9LX0xUOgogICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA8IHNlY29uZDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRPS19MVEU6CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0IDw9IHNlY29uZDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gY29tcGFyYXRvcjogIiArIG5vZGUubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KG9yaWdpbmFsKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBtZXJnZWQgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3JpZ2luYWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBvcmlnaW5hbFtpXTsKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGN1cnJlbnQpKSB7CiAgICAgICAgICAgICAgICAgIG1lcmdlZC5wdXNoLmFwcGx5KG1lcmdlZCwgY3VycmVudCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtZXJnZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgICAgICAgICAgY2FzZSAiSWRlbnRpdHkiOgogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgY2FzZSAiTXVsdGlTZWxlY3RMaXN0IjoKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaCh0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5baV0sIHZhbHVlKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgIGNhc2UgIk11bHRpU2VsZWN0SGFzaCI6CiAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29sbGVjdGVkID0ge307CiAgICAgICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGlsZCA9IG5vZGUuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWRbY2hpbGQubmFtZV0gPSB0aGlzLnZpc2l0KGNoaWxkLnZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgIGNhc2UgIk9yRXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIGlmIChpc0ZhbHNlKG1hdGNoZWQpKSB7CiAgICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICAgICAgICAgIGNhc2UgIkFuZEV4cHJlc3Npb24iOgogICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CgogICAgICAgICAgICAgIGlmIChpc0ZhbHNlKGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZpcnN0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgIGNhc2UgIk5vdEV4cHJlc3Npb24iOgogICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGlzRmFsc2UoZmlyc3QpOwogICAgICAgICAgICBjYXNlICJMaXRlcmFsIjoKICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICAgICAgY2FzZSBUT0tfUElQRToKICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgIGNhc2UgVE9LX0NVUlJFTlQ6CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBjYXNlICJGdW5jdGlvbiI6CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkQXJncyA9IFtdOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHJlc29sdmVkQXJncy5wdXNoKHRoaXMudmlzaXQobm9kZS5jaGlsZHJlbltpXSwgdmFsdWUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVudGltZS5jYWxsRnVuY3Rpb24obm9kZS5uYW1lLCByZXNvbHZlZEFyZ3MpOwogICAgICAgICAgICBjYXNlICJFeHByZXNzaW9uUmVmZXJlbmNlIjoKICAgICAgICAgICAgICB2YXIgcmVmTm9kZSA9IG5vZGUuY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgLy8gVGFnIHRoZSBub2RlIHdpdGggYSBzcGVjaWZpYyBhdHRyaWJ1dGUgc28gdGhlIHR5cGUKICAgICAgICAgICAgICAvLyBjaGVja2VyIHZlcmlmeSB0aGUgdHlwZS4KICAgICAgICAgICAgICByZWZOb2RlLmptZXNwYXRoVHlwZSA9IFRPS19FWFBSRUY7CiAgICAgICAgICAgICAgcmV0dXJuIHJlZk5vZGU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIG5vZGUgdHlwZTogIiArIG5vZGUudHlwZSk7CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBjb21wdXRlU2xpY2VQYXJhbXM6IGZ1bmN0aW9uKGFycmF5TGVuZ3RoLCBzbGljZVBhcmFtcykgewogICAgICAgIHZhciBzdGFydCA9IHNsaWNlUGFyYW1zWzBdOwogICAgICAgIHZhciBzdG9wID0gc2xpY2VQYXJhbXNbMV07CiAgICAgICAgdmFyIHN0ZXAgPSBzbGljZVBhcmFtc1syXTsKICAgICAgICB2YXIgY29tcHV0ZWQgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgaWYgKHN0ZXAgPT09IG51bGwpIHsKICAgICAgICAgIHN0ZXAgPSAxOwogICAgICAgIH0gZWxzZSBpZiAoc3RlcCA9PT0gMCkgewogICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJJbnZhbGlkIHNsaWNlLCBzdGVwIGNhbm5vdCBiZSAwIik7CiAgICAgICAgICBlcnJvci5uYW1lID0gIlJ1bnRpbWVFcnJvciI7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICAgICAgdmFyIHN0ZXBWYWx1ZU5lZ2F0aXZlID0gc3RlcCA8IDAgPyB0cnVlIDogZmFsc2U7CgogICAgICAgIGlmIChzdGFydCA9PT0gbnVsbCkgewogICAgICAgICAgICBzdGFydCA9IHN0ZXBWYWx1ZU5lZ2F0aXZlID8gYXJyYXlMZW5ndGggLSAxIDogMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGFydCA9IHRoaXMuY2FwU2xpY2VSYW5nZShhcnJheUxlbmd0aCwgc3RhcnQsIHN0ZXApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHN0b3AgPT09IG51bGwpIHsKICAgICAgICAgICAgc3RvcCA9IHN0ZXBWYWx1ZU5lZ2F0aXZlID8gLTEgOiBhcnJheUxlbmd0aDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdG9wID0gdGhpcy5jYXBTbGljZVJhbmdlKGFycmF5TGVuZ3RoLCBzdG9wLCBzdGVwKTsKICAgICAgICB9CiAgICAgICAgY29tcHV0ZWRbMF0gPSBzdGFydDsKICAgICAgICBjb21wdXRlZFsxXSA9IHN0b3A7CiAgICAgICAgY29tcHV0ZWRbMl0gPSBzdGVwOwogICAgICAgIHJldHVybiBjb21wdXRlZDsKICAgICAgfSwKCiAgICAgIGNhcFNsaWNlUmFuZ2U6IGZ1bmN0aW9uKGFycmF5TGVuZ3RoLCBhY3R1YWxWYWx1ZSwgc3RlcCkgewogICAgICAgICAgaWYgKGFjdHVhbFZhbHVlIDwgMCkgewogICAgICAgICAgICAgIGFjdHVhbFZhbHVlICs9IGFycmF5TGVuZ3RoOwogICAgICAgICAgICAgIGlmIChhY3R1YWxWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgPSBzdGVwIDwgMCA/IC0xIDogMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGFjdHVhbFZhbHVlID49IGFycmF5TGVuZ3RoKSB7CiAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgPSBzdGVwIDwgMCA/IGFycmF5TGVuZ3RoIC0gMSA6IGFycmF5TGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFjdHVhbFZhbHVlOwogICAgICB9CgogIH07CgogIGZ1bmN0aW9uIFJ1bnRpbWUoaW50ZXJwcmV0ZXIpIHsKICAgIHRoaXMuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICB0aGlzLmZ1bmN0aW9uVGFibGUgPSB7CiAgICAgICAgLy8gbmFtZTogW2Z1bmN0aW9uLCA8c2lnbmF0dXJlPl0KICAgICAgICAvLyBUaGUgPHNpZ25hdHVyZT4gY2FuIGJlOgogICAgICAgIC8vCiAgICAgICAgLy8gewogICAgICAgIC8vICAgYXJnczogW1t0eXBlMSwgdHlwZTJdLCBbdHlwZTEsIHR5cGUyXV0sCiAgICAgICAgLy8gICB2YXJpYWRpYzogdHJ1ZXxmYWxzZQogICAgICAgIC8vIH0KICAgICAgICAvLwogICAgICAgIC8vIEVhY2ggYXJnIGluIHRoZSBhcmcgbGlzdCBpcyBhIGxpc3Qgb2YgdmFsaWQgdHlwZXMKICAgICAgICAvLyAoaWYgdGhlIGZ1bmN0aW9uIGlzIG92ZXJsb2FkZWQgYW5kIHN1cHBvcnRzIG11bHRpcGxlCiAgICAgICAgLy8gdHlwZXMuICBJZiB0aGUgdHlwZSBpcyAiYW55IiB0aGVuIG5vIHR5cGUgY2hlY2tpbmcKICAgICAgICAvLyBvY2N1cnMgb24gdGhlIGFyZ3VtZW50LiAgVmFyaWFkaWMgaXMgb3B0aW9uYWwKICAgICAgICAvLyBhbmQgaWYgbm90IHByb3ZpZGVkIGlzIGFzc3VtZWQgdG8gYmUgZmFsc2UuCiAgICAgICAgYWJzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQWJzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgIGF2Zzoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkF2ZywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICBjZWlsOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQ2VpbCwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICBjb250YWluczogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Db250YWlucywKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZXX0sCiAgICAgICAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAiZW5kc193aXRoIjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25FbmRzV2l0aCwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HXX0sIHt0eXBlczogW1RZUEVfU1RSSU5HXX1dfSwKICAgICAgICBmbG9vcjoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkZsb29yLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgIGxlbmd0aDogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25MZW5ndGgsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWSwgVFlQRV9PQkpFQ1RdfV19LAogICAgICAgIG1hcDogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXAsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0VYUFJFRl19LCB7dHlwZXM6IFtUWVBFX0FSUkFZXX1dfSwKICAgICAgICBtYXg6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWF4LAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVIsIFRZUEVfQVJSQVlfU1RSSU5HXX1dfSwKICAgICAgICAibWVyZ2UiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1lcmdlLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdLCB2YXJpYWRpYzogdHJ1ZX1dCiAgICAgICAgfSwKICAgICAgICAibWF4X2J5IjogewogICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWF4QnksCiAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgIH0sCiAgICAgICAgc3VtOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU3VtLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICJzdGFydHNfd2l0aCI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU3RhcnRzV2l0aCwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HXX0sIHt0eXBlczogW1RZUEVfU1RSSU5HXX1dfSwKICAgICAgICBtaW46IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVIsIFRZUEVfQVJSQVlfU1RSSU5HXX1dfSwKICAgICAgICAibWluX2J5IjogewogICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluQnksCiAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgIH0sCiAgICAgICAgdHlwZToge19mdW5jOiB0aGlzLl9mdW5jdGlvblR5cGUsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAga2V5czoge19mdW5jOiB0aGlzLl9mdW5jdGlvbktleXMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF19XX0sCiAgICAgICAgdmFsdWVzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVmFsdWVzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdfV19LAogICAgICAgIHNvcnQ6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0LCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9TVFJJTkcsIFRZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAic29ydF9ieSI6IHsKICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblNvcnRCeSwKICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgfSwKICAgICAgICBqb2luOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkpvaW4sCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFsKICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfU1RSSU5HXX0sCiAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX0FSUkFZX1NUUklOR119CiAgICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgIHJldmVyc2U6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uUmV2ZXJzZSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZXX1dfSwKICAgICAgICAidG9fYXJyYXkiOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9BcnJheSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAidG9fc3RyaW5nIjoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvU3RyaW5nLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICJ0b19udW1iZXIiOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9OdW1iZXIsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgIm5vdF9udWxsIjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Ob3ROdWxsLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldLCB2YXJpYWRpYzogdHJ1ZX1dCiAgICAgICAgfQogICAgfTsKICB9CgogIFJ1bnRpbWUucHJvdG90eXBlID0gewogICAgY2FsbEZ1bmN0aW9uOiBmdW5jdGlvbihuYW1lLCByZXNvbHZlZEFyZ3MpIHsKICAgICAgdmFyIGZ1bmN0aW9uRW50cnkgPSB0aGlzLmZ1bmN0aW9uVGFibGVbbmFtZV07CiAgICAgIGlmIChmdW5jdGlvbkVudHJ5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBmdW5jdGlvbjogIiArIG5hbWUgKyAiKCkiKTsKICAgICAgfQogICAgICB0aGlzLl92YWxpZGF0ZUFyZ3MobmFtZSwgcmVzb2x2ZWRBcmdzLCBmdW5jdGlvbkVudHJ5Ll9zaWduYXR1cmUpOwogICAgICByZXR1cm4gZnVuY3Rpb25FbnRyeS5fZnVuYy5jYWxsKHRoaXMsIHJlc29sdmVkQXJncyk7CiAgICB9LAoKICAgIF92YWxpZGF0ZUFyZ3M6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MsIHNpZ25hdHVyZSkgewogICAgICAgIC8vIFZhbGlkYXRpbmcgdGhlIGFyZ3MgcmVxdWlyZXMgdmFsaWRhdGluZwogICAgICAgIC8vIHRoZSBjb3JyZWN0IGFyaXR5IGFuZCB0aGUgY29ycmVjdCB0eXBlIG9mIGVhY2ggYXJnLgogICAgICAgIC8vIElmIHRoZSBsYXN0IGFyZ3VtZW50IGlzIGRlY2xhcmVkIGFzIHZhcmlhZGljLCB0aGVuIHdlIG5lZWQKICAgICAgICAvLyBhIG1pbmltdW0gbnVtYmVyIG9mIGFyZ3MgdG8gYmUgcmVxdWlyZWQuICBPdGhlcndpc2UgaXQgaGFzIHRvCiAgICAgICAgLy8gYmUgYW4gZXhhY3QgYW1vdW50LgogICAgICAgIHZhciBwbHVyYWxpemVkOwogICAgICAgIGlmIChzaWduYXR1cmVbc2lnbmF0dXJlLmxlbmd0aCAtIDFdLnZhcmlhZGljKSB7CiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IHNpZ25hdHVyZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHBsdXJhbGl6ZWQgPSBzaWduYXR1cmUubGVuZ3RoID09PSAxID8gIiBhcmd1bWVudCIgOiAiIGFyZ3VtZW50cyI7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50RXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0YWtlcyBhdCBsZWFzdCIgKyBzaWduYXR1cmUubGVuZ3RoICsgcGx1cmFsaXplZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgIiArIGFyZ3MubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoYXJncy5sZW5ndGggIT09IHNpZ25hdHVyZS5sZW5ndGgpIHsKICAgICAgICAgICAgcGx1cmFsaXplZCA9IHNpZ25hdHVyZS5sZW5ndGggPT09IDEgPyAiIGFyZ3VtZW50IiA6ICIgYXJndW1lbnRzIjsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudEVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0YWtlcyAiICsgc2lnbmF0dXJlLmxlbmd0aCArIHBsdXJhbGl6ZWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBidXQgcmVjZWl2ZWQgIiArIGFyZ3MubGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRTcGVjOwogICAgICAgIHZhciBhY3R1YWxUeXBlOwogICAgICAgIHZhciB0eXBlTWF0Y2hlZDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpZ25hdHVyZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0eXBlTWF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICBjdXJyZW50U3BlYyA9IHNpZ25hdHVyZVtpXS50eXBlczsKICAgICAgICAgICAgYWN0dWFsVHlwZSA9IHRoaXMuX2dldFR5cGVOYW1lKGFyZ3NbaV0pOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGN1cnJlbnRTcGVjLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fdHlwZU1hdGNoZXMoYWN0dWFsVHlwZSwgY3VycmVudFNwZWNbal0sIGFyZ3NbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZU1hdGNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdHlwZU1hdGNoZWQpIHsKICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZCA9IGN1cnJlbnRTcGVjCiAgICAgICAgICAgICAgICAgICAgLm1hcChmdW5jdGlvbih0eXBlSWRlbnRpZmllcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OQU1FX1RBQkxFW3R5cGVJZGVudGlmaWVyXTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC5qb2luKCcsJyk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlR5cGVFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4cGVjdGVkIGFyZ3VtZW50ICIgKyAoaSArIDEpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIHRvIGJlIHR5cGUgIiArIGV4cGVjdGVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCB0eXBlICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRZUEVfTkFNRV9UQUJMRVthY3R1YWxUeXBlXSArICIgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgX3R5cGVNYXRjaGVzOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBhcmdWYWx1ZSkgewogICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BTlkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9TVFJJTkcgfHwKICAgICAgICAgICAgZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfTlVNQkVSIHx8CiAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgIC8vIFRoZSBleHBlY3RlZCB0eXBlIGNhbiBlaXRoZXIganVzdCBiZSBhcnJheSwKICAgICAgICAgICAgLy8gb3IgaXQgY2FuIHJlcXVpcmUgYSBzcGVjaWZpYyBzdWJ0eXBlIChhcnJheSBvZiBudW1iZXJzKS4KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gVGhlIHNpbXBsZXN0IGNhc2UgaXMgaWYgImFycmF5IiB3aXRoIG5vIHN1YnR5cGUgaXMgc3BlY2lmaWVkLgogICAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IFRZUEVfQVJSQVk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0dWFsID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCB0byBjaGVjayBzdWJ0eXBlcy4KICAgICAgICAgICAgICAgIC8vIEkgdGhpbmsgdGhpcyBoYXMgcG90ZW50aWFsIHRvIGJlIGltcHJvdmVkLgogICAgICAgICAgICAgICAgdmFyIHN1YnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfTlVNQkVSKSB7CiAgICAgICAgICAgICAgICAgIHN1YnR5cGUgPSBUWVBFX05VTUJFUjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfU1RSSU5HKSB7CiAgICAgICAgICAgICAgICAgIHN1YnR5cGUgPSBUWVBFX1NUUklORzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnVmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX3R5cGVNYXRjaGVzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2V0VHlwZU5hbWUoYXJnVmFsdWVbaV0pLCBzdWJ0eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdWYWx1ZVtpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGFjdHVhbCA9PT0gZXhwZWN0ZWQ7CiAgICAgICAgfQogICAgfSwKICAgIF9nZXRUeXBlTmFtZTogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgc3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSkgewogICAgICAgICAgICBjYXNlICJbb2JqZWN0IFN0cmluZ10iOgogICAgICAgICAgICAgIHJldHVybiBUWVBFX1NUUklORzsKICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdW1iZXJdIjoKICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OVU1CRVI7CiAgICAgICAgICAgIGNhc2UgIltvYmplY3QgQXJyYXldIjoKICAgICAgICAgICAgICByZXR1cm4gVFlQRV9BUlJBWTsKICAgICAgICAgICAgY2FzZSAiW29iamVjdCBCb29sZWFuXSI6CiAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfQk9PTEVBTjsKICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdWxsXSI6CiAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfTlVMTDsKICAgICAgICAgICAgY2FzZSAiW29iamVjdCBPYmplY3RdIjoKICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGFuIGV4cHJlZi4gIElmIGl0IGhhcywgaXQncyBiZWVuCiAgICAgICAgICAgICAgLy8gdGFnZ2VkIHdpdGggYSBqbWVzcGF0aFR5cGUgYXR0ciBvZiAnRXhwcmVmJzsKICAgICAgICAgICAgICBpZiAob2JqLmptZXNwYXRoVHlwZSA9PT0gVE9LX0VYUFJFRikgewogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfRVhQUkVGOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9PQkpFQ1Q7CiAgICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uU3RhcnRzV2l0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5sYXN0SW5kZXhPZihyZXNvbHZlZEFyZ3NbMV0pID09PSAwOwogICAgfSwKCiAgICBfZnVuY3Rpb25FbmRzV2l0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHNlYXJjaFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIgc3VmZml4ID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHJldHVybiBzZWFyY2hTdHIuaW5kZXhPZihzdWZmaXgsIHNlYXJjaFN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoKSAhPT0gLTE7CiAgICB9LAoKICAgIF9mdW5jdGlvblJldmVyc2U6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgdmFyIG9yaWdpbmFsU3RyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIHJldmVyc2VkU3RyID0gIiI7CiAgICAgICAgICBmb3IgKHZhciBpID0gb3JpZ2luYWxTdHIubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICByZXZlcnNlZFN0ciArPSBvcmlnaW5hbFN0cltpXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXZlcnNlZFN0cjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHJldmVyc2VkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICByZXZlcnNlZEFycmF5LnJldmVyc2UoKTsKICAgICAgICAgIHJldHVybiByZXZlcnNlZEFycmF5OwogICAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uQWJzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgcmV0dXJuIE1hdGguYWJzKHJlc29sdmVkQXJnc1swXSk7CiAgICB9LAoKICAgIF9mdW5jdGlvbkNlaWw6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHJldHVybiBNYXRoLmNlaWwocmVzb2x2ZWRBcmdzWzBdKTsKICAgIH0sCgogICAgX2Z1bmN0aW9uQXZnOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgc3VtID0gMDsKICAgICAgICB2YXIgaW5wdXRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlucHV0QXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgc3VtICs9IGlucHV0QXJyYXlbaV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdW0gLyBpbnB1dEFycmF5Lmxlbmd0aDsKICAgIH0sCgogICAgX2Z1bmN0aW9uQ29udGFpbnM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0uaW5kZXhPZihyZXNvbHZlZEFyZ3NbMV0pID49IDA7CiAgICB9LAoKICAgIF9mdW5jdGlvbkZsb29yOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihyZXNvbHZlZEFyZ3NbMF0pOwogICAgfSwKCiAgICBfZnVuY3Rpb25MZW5ndGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgaWYgKCFpc09iamVjdChyZXNvbHZlZEFyZ3NbMF0pKSB7CiAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoOwogICAgICAgfSBlbHNlIHsKICAgICAgICAgLy8gQXMgZmFyIGFzIEkgY2FuIHRlbGwsIHRoZXJlJ3Mgbm8gd2F5IHRvIGdldCB0aGUgbGVuZ3RoCiAgICAgICAgIC8vIG9mIGFuIG9iamVjdCB3aXRob3V0IE8obikgaXRlcmF0aW9uIHRocm91Z2ggdGhlIG9iamVjdC4KICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlc29sdmVkQXJnc1swXSkubGVuZ3RoOwogICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25NYXA6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICB2YXIgbWFwcGVkID0gW107CiAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBtYXBwZWQucHVzaChpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBlbGVtZW50c1tpXSkpOwogICAgICB9CiAgICAgIHJldHVybiBtYXBwZWQ7CiAgICB9LAoKICAgIF9mdW5jdGlvbk1lcmdlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgdmFyIG1lcmdlZCA9IHt9OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjdXJyZW50ID0gcmVzb2x2ZWRBcmdzW2ldOwogICAgICAgIGZvciAodmFyIGtleSBpbiBjdXJyZW50KSB7CiAgICAgICAgICBtZXJnZWRba2V5XSA9IGN1cnJlbnRba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1lcmdlZDsKICAgIH0sCgogICAgX2Z1bmN0aW9uTWF4OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgaWYgKHJlc29sdmVkQXJnc1swXS5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdWzBdKTsKICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgcmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIG1heEVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAobWF4RWxlbWVudC5sb2NhbGVDb21wYXJlKGVsZW1lbnRzW2ldKSA8IDApIHsKICAgICAgICAgICAgICAgICAgbWF4RWxlbWVudCA9IGVsZW1lbnRzW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXhFbGVtZW50OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvbk1pbjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIGlmIChyZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoID4gMCkgewogICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXVswXSk7CiAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBtaW5FbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW1lbnRzW2ldLmxvY2FsZUNvbXBhcmUobWluRWxlbWVudCkgPCAwKSB7CiAgICAgICAgICAgICAgICAgIG1pbkVsZW1lbnQgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWluRWxlbWVudDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uU3VtOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgdmFyIHN1bSA9IDA7CiAgICAgIHZhciBsaXN0VG9TdW0gPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdFRvU3VtLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgc3VtICs9IGxpc3RUb1N1bVtpXTsKICAgICAgfQogICAgICByZXR1cm4gc3VtOwogICAgfSwKCiAgICBfZnVuY3Rpb25UeXBlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBzd2l0Y2ggKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkpIHsKICAgICAgICAgIGNhc2UgVFlQRV9OVU1CRVI6CiAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgIGNhc2UgVFlQRV9TVFJJTkc6CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgIGNhc2UgVFlQRV9BUlJBWToKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgICBjYXNlIFRZUEVfT0JKRUNUOgogICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICBjYXNlIFRZUEVfQk9PTEVBTjoKICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsKICAgICAgICAgIGNhc2UgVFlQRV9FWFBSRUY6CiAgICAgICAgICAgIHJldHVybiAiZXhwcmVmIjsKICAgICAgICAgIGNhc2UgVFlQRV9OVUxMOgogICAgICAgICAgICByZXR1cm4gIm51bGwiOwogICAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uS2V5czogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlc29sdmVkQXJnc1swXSk7CiAgICB9LAoKICAgIF9mdW5jdGlvblZhbHVlczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIG9iaiA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWx1ZXMucHVzaChvYmpba2V5c1tpXV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgfSwKCiAgICBfZnVuY3Rpb25Kb2luOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgam9pbkNoYXIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGxpc3RKb2luID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHJldHVybiBsaXN0Sm9pbi5qb2luKGpvaW5DaGFyKTsKICAgIH0sCgogICAgX2Z1bmN0aW9uVG9BcnJheTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gW3Jlc29sdmVkQXJnc1swXV07CiAgICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25Ub1N0cmluZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25Ub051bWJlcjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICB2YXIgY29udmVydGVkVmFsdWU7CiAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIH0gZWxzZSBpZiAodHlwZU5hbWUgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgIGNvbnZlcnRlZFZhbHVlID0gK3Jlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgaWYgKCFpc05hTihjb252ZXJ0ZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJ0ZWRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgX2Z1bmN0aW9uTm90TnVsbDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1tpXSkgIT09IFRZUEVfTlVMTCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1tpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgX2Z1bmN0aW9uU29ydDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHNvcnRlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgIHNvcnRlZEFycmF5LnNvcnQoKTsKICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICB9LAoKICAgIF9mdW5jdGlvblNvcnRCeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHNvcnRlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgIGlmIChzb3J0ZWRBcnJheS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICAgIH0KICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICB2YXIgcmVxdWlyZWRUeXBlID0gdGhpcy5fZ2V0VHlwZU5hbWUoCiAgICAgICAgICAgIGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIHNvcnRlZEFycmF5WzBdKSk7CiAgICAgICAgaWYgKFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddLmluZGV4T2YocmVxdWlyZWRUeXBlKSA8IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUeXBlRXJyb3IiKTsKICAgICAgICB9CiAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgIC8vIEluIG9yZGVyIHRvIGdldCBhIHN0YWJsZSBzb3J0IG91dCBvZiBhbiB1bnN0YWJsZQogICAgICAgIC8vIHNvcnQgYWxnb3JpdGhtLCB3ZSBkZWNvcmF0ZS9zb3J0L3VuZGVjb3JhdGUgKERTVSkKICAgICAgICAvLyBieSBjcmVhdGluZyBhIG5ldyBsaXN0IG9mIFtpbmRleCwgZWxlbWVudF0gcGFpcnMuCiAgICAgICAgLy8gSW4gdGhlIGNtcCBmdW5jdGlvbiwgaWYgdGhlIGV2YWx1YXRlZCBlbGVtZW50cyBhcmUKICAgICAgICAvLyBlcXVhbCwgdGhlbiB0aGUgaW5kZXggd2lsbCBiZSB1c2VkIGFzIHRoZSB0aWVicmVha2VyLgogICAgICAgIC8vIEFmdGVyIHRoZSBkZWNvcmF0ZWQgbGlzdCBoYXMgYmVlbiBzb3J0ZWQsIGl0IHdpbGwgYmUKICAgICAgICAvLyB1bmRlY29yYXRlZCB0byBleHRyYWN0IHRoZSBvcmlnaW5hbCBlbGVtZW50cy4KICAgICAgICB2YXIgZGVjb3JhdGVkID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgZGVjb3JhdGVkLnB1c2goW2ksIHNvcnRlZEFycmF5W2ldXSk7CiAgICAgICAgfQogICAgICAgIGRlY29yYXRlZC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgIHZhciBleHByQSA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGFbMV0pOwogICAgICAgICAgdmFyIGV4cHJCID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgYlsxXSk7CiAgICAgICAgICBpZiAodGhhdC5fZ2V0VHlwZU5hbWUoZXhwckEpICE9PSByZXF1aXJlZFR5cGUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICJUeXBlRXJyb3I6IGV4cGVjdGVkICIgKyByZXF1aXJlZFR5cGUgKyAiLCByZWNlaXZlZCAiICsKICAgICAgICAgICAgICAgICAgdGhhdC5fZ2V0VHlwZU5hbWUoZXhwckEpKTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhhdC5fZ2V0VHlwZU5hbWUoZXhwckIpICE9PSByZXF1aXJlZFR5cGUpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICJUeXBlRXJyb3I6IGV4cGVjdGVkICIgKyByZXF1aXJlZFR5cGUgKyAiLCByZWNlaXZlZCAiICsKICAgICAgICAgICAgICAgICAgdGhhdC5fZ2V0VHlwZU5hbWUoZXhwckIpKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHByQSA+IGV4cHJCKSB7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgfSBlbHNlIGlmIChleHByQSA8IGV4cHJCKSB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIHRoZXkncmUgZXF1YWwgY29tcGFyZSB0aGUgaXRlbXMgYnkgdGhlaXIKICAgICAgICAgICAgLy8gb3JkZXIgdG8gbWFpbnRhaW4gcmVsYXRpdmUgb3JkZXIgb2YgZXF1YWwga2V5cwogICAgICAgICAgICAvLyAoaS5lLiB0byBnZXQgYSBzdGFibGUgc29ydCkuCiAgICAgICAgICAgIHJldHVybiBhWzBdIC0gYlswXTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAvLyBVbmRlY29yYXRlOiBleHRyYWN0IG91dCB0aGUgb3JpZ2luYWwgbGlzdCBlbGVtZW50cy4KICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGRlY29yYXRlZC5sZW5ndGg7IGorKykgewogICAgICAgICAgc29ydGVkQXJyYXlbal0gPSBkZWNvcmF0ZWRbal1bMV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgIH0sCgogICAgX2Z1bmN0aW9uTWF4Qnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgdmFyIHJlc29sdmVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgIHZhciBrZXlGdW5jdGlvbiA9IHRoaXMuY3JlYXRlS2V5RnVuY3Rpb24oZXhwcmVmTm9kZSwgW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10pOwogICAgICB2YXIgbWF4TnVtYmVyID0gLUluZmluaXR5OwogICAgICB2YXIgbWF4UmVjb3JkOwogICAgICB2YXIgY3VycmVudDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgIGlmIChjdXJyZW50ID4gbWF4TnVtYmVyKSB7CiAgICAgICAgICBtYXhOdW1iZXIgPSBjdXJyZW50OwogICAgICAgICAgbWF4UmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG1heFJlY29yZDsKICAgIH0sCgogICAgX2Z1bmN0aW9uTWluQnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgdmFyIHJlc29sdmVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgIHZhciBrZXlGdW5jdGlvbiA9IHRoaXMuY3JlYXRlS2V5RnVuY3Rpb24oZXhwcmVmTm9kZSwgW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10pOwogICAgICB2YXIgbWluTnVtYmVyID0gSW5maW5pdHk7CiAgICAgIHZhciBtaW5SZWNvcmQ7CiAgICAgIHZhciBjdXJyZW50OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICBjdXJyZW50ID0ga2V5RnVuY3Rpb24ocmVzb2x2ZWRBcnJheVtpXSk7CiAgICAgICAgaWYgKGN1cnJlbnQgPCBtaW5OdW1iZXIpIHsKICAgICAgICAgIG1pbk51bWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICBtaW5SZWNvcmQgPSByZXNvbHZlZEFycmF5W2ldOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWluUmVjb3JkOwogICAgfSwKCiAgICBjcmVhdGVLZXlGdW5jdGlvbjogZnVuY3Rpb24oZXhwcmVmTm9kZSwgYWxsb3dlZFR5cGVzKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgIHZhciBrZXlGdW5jID0gZnVuY3Rpb24oeCkgewogICAgICAgIHZhciBjdXJyZW50ID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgeCk7CiAgICAgICAgaWYgKGFsbG93ZWRUeXBlcy5pbmRleE9mKHRoYXQuX2dldFR5cGVOYW1lKGN1cnJlbnQpKSA8IDApIHsKICAgICAgICAgIHZhciBtc2cgPSAiVHlwZUVycm9yOiBleHBlY3RlZCBvbmUgb2YgIiArIGFsbG93ZWRUeXBlcyArCiAgICAgICAgICAgICAgICAgICAgIiwgcmVjZWl2ZWQgIiArIHRoYXQuX2dldFR5cGVOYW1lKGN1cnJlbnQpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICB9OwogICAgICByZXR1cm4ga2V5RnVuYzsKICAgIH0KCiAgfTsKCiAgZnVuY3Rpb24gY29tcGlsZShzdHJlYW0pIHsKICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKCk7CiAgICB2YXIgYXN0ID0gcGFyc2VyLnBhcnNlKHN0cmVhbSk7CiAgICByZXR1cm4gYXN0OwogIH0KCiAgZnVuY3Rpb24gdG9rZW5pemUoc3RyZWFtKSB7CiAgICAgIHZhciBsZXhlciA9IG5ldyBMZXhlcigpOwogICAgICByZXR1cm4gbGV4ZXIudG9rZW5pemUoc3RyZWFtKTsKICB9CgogIGZ1bmN0aW9uIHNlYXJjaChkYXRhLCBleHByZXNzaW9uKSB7CiAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKCk7CiAgICAgIC8vIFRoaXMgbmVlZHMgdG8gYmUgaW1wcm92ZWQuICBCb3RoIHRoZSBpbnRlcnByZXRlciBhbmQgcnVudGltZSBkZXBlbmQgb24KICAgICAgLy8gZWFjaCBvdGhlci4gIFRoZSBydW50aW1lIG5lZWRzIHRoZSBpbnRlcnByZXRlciB0byBzdXBwb3J0IGV4cHJlZnMuCiAgICAgIC8vIFRoZXJlJ3MgbGlrZWx5IGEgY2xlYW4gd2F5IHRvIGF2b2lkIHRoZSBjeWNsaWMgZGVwZW5kZW5jeS4KICAgICAgdmFyIHJ1bnRpbWUgPSBuZXcgUnVudGltZSgpOwogICAgICB2YXIgaW50ZXJwcmV0ZXIgPSBuZXcgVHJlZUludGVycHJldGVyKHJ1bnRpbWUpOwogICAgICBydW50aW1lLl9pbnRlcnByZXRlciA9IGludGVycHJldGVyOwogICAgICB2YXIgbm9kZSA9IHBhcnNlci5wYXJzZShleHByZXNzaW9uKTsKICAgICAgcmV0dXJuIGludGVycHJldGVyLnNlYXJjaChub2RlLCBkYXRhKTsKICB9CgogIGV4cG9ydHMudG9rZW5pemUgPSB0b2tlbml6ZTsKICBleHBvcnRzLmNvbXBpbGUgPSBjb21waWxlOwogIGV4cG9ydHMuc2VhcmNoID0gc2VhcmNoOwogIGV4cG9ydHMuc3RyaWN0RGVlcEVxdWFsID0gc3RyaWN0RGVlcEVxdWFsOwp9KSh0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgPyB0aGlzLmptZXNwYXRoID0ge30gOiBleHBvcnRzKTsKCn0se31dLDg5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gc2hpbSBmb3IgdXNpbmcgcHJvY2VzcyBpbiBicm93c2VyCnZhciBwcm9jZXNzID0gbW9kdWxlLmV4cG9ydHMgPSB7fTsKCi8vIGNhY2hlZCBmcm9tIHdoYXRldmVyIGdsb2JhbCBpcyBwcmVzZW50IHNvIHRoYXQgdGVzdCBydW5uZXJzIHRoYXQgc3R1YiBpdAovLyBkb24ndCBicmVhayB0aGluZ3MuICBCdXQgd2UgbmVlZCB0byB3cmFwIGl0IGluIGEgdHJ5IGNhdGNoIGluIGNhc2UgaXQgaXMKLy8gd3JhcHBlZCBpbiBzdHJpY3QgbW9kZSBjb2RlIHdoaWNoIGRvZXNuJ3QgZGVmaW5lIGFueSBnbG9iYWxzLiAgSXQncyBpbnNpZGUgYQovLyBmdW5jdGlvbiBiZWNhdXNlIHRyeS9jYXRjaGVzIGRlb3B0aW1pemUgaW4gY2VydGFpbiBlbmdpbmVzLgoKdmFyIGNhY2hlZFNldFRpbWVvdXQ7CnZhciBjYWNoZWRDbGVhclRpbWVvdXQ7CgpmdW5jdGlvbiBkZWZhdWx0U2V0VGltb3V0KCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdzZXRUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7Cn0KZnVuY3Rpb24gZGVmYXVsdENsZWFyVGltZW91dCAoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsZWFyVGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCcpOwp9CihmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICAgIGlmICh0eXBlb2Ygc2V0VGltZW91dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gZGVmYXVsdFNldFRpbW91dDsKICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICB9CiAgICB0cnkgewogICAgICAgIGlmICh0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBkZWZhdWx0Q2xlYXJUaW1lb3V0OwogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBkZWZhdWx0Q2xlYXJUaW1lb3V0OwogICAgfQp9ICgpKQpmdW5jdGlvbiBydW5UaW1lb3V0KGZ1bikgewogICAgaWYgKGNhY2hlZFNldFRpbWVvdXQgPT09IHNldFRpbWVvdXQpIHsKICAgICAgICAvL25vcm1hbCBlbnZpcm9tZW50cyBpbiBzYW5lIHNpdHVhdGlvbnMKICAgICAgICByZXR1cm4gc2V0VGltZW91dChmdW4sIDApOwogICAgfQogICAgLy8gaWYgc2V0VGltZW91dCB3YXNuJ3QgYXZhaWxhYmxlIGJ1dCB3YXMgbGF0dGVyIGRlZmluZWQKICAgIGlmICgoY2FjaGVkU2V0VGltZW91dCA9PT0gZGVmYXVsdFNldFRpbW91dCB8fCAhY2FjaGVkU2V0VGltZW91dCkgJiYgc2V0VGltZW91dCkgewogICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7CiAgICB9CiAgICB0cnkgewogICAgICAgIC8vIHdoZW4gd2hlbiBzb21lYm9keSBoYXMgc2NyZXdlZCB3aXRoIHNldFRpbWVvdXQgYnV0IG5vIEkuRS4gbWFkZG5lc3MKICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dChmdW4sIDApOwogICAgfSBjYXRjaChlKXsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBXaGVuIHdlIGFyZSBpbiBJLkUuIGJ1dCB0aGUgc2NyaXB0IGhhcyBiZWVuIGV2YWxlZCBzbyBJLkUuIGRvZXNuJ3QgdHJ1c3QgdGhlIGdsb2JhbCBvYmplY3Qgd2hlbiBjYWxsZWQgbm9ybWFsbHkKICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbChudWxsLCBmdW4sIDApOwogICAgICAgIH0gY2F0Y2goZSl7CiAgICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUgYnV0IHdoZW4gaXQncyBhIHZlcnNpb24gb2YgSS5FLiB0aGF0IG11c3QgaGF2ZSB0aGUgZ2xvYmFsIG9iamVjdCBmb3IgJ3RoaXMnLCBob3BmdWxseSBvdXIgY29udGV4dCBjb3JyZWN0IG90aGVyd2lzZSBpdCB3aWxsIHRocm93IGEgZ2xvYmFsIGVycm9yCiAgICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwodGhpcywgZnVuLCAwKTsKICAgICAgICB9CiAgICB9CgoKfQpmdW5jdGlvbiBydW5DbGVhclRpbWVvdXQobWFya2VyKSB7CiAgICBpZiAoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBjbGVhclRpbWVvdXQpIHsKICAgICAgICAvL25vcm1hbCBlbnZpcm9tZW50cyBpbiBzYW5lIHNpdHVhdGlvbnMKICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICB9CiAgICAvLyBpZiBjbGVhclRpbWVvdXQgd2Fzbid0IGF2YWlsYWJsZSBidXQgd2FzIGxhdHRlciBkZWZpbmVkCiAgICBpZiAoKGNhY2hlZENsZWFyVGltZW91dCA9PT0gZGVmYXVsdENsZWFyVGltZW91dCB8fCAhY2FjaGVkQ2xlYXJUaW1lb3V0KSAmJiBjbGVhclRpbWVvdXQpIHsKICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7CiAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dChtYXJrZXIpOwogICAgfQogICAgdHJ5IHsKICAgICAgICAvLyB3aGVuIHdoZW4gc29tZWJvZHkgaGFzIHNjcmV3ZWQgd2l0aCBzZXRUaW1lb3V0IGJ1dCBubyBJLkUuIG1hZGRuZXNzCiAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dChtYXJrZXIpOwogICAgfSBjYXRjaCAoZSl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0ICB0cnVzdCB0aGUgZ2xvYmFsIG9iamVjdCB3aGVuIGNhbGxlZCBub3JtYWxseQogICAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0LmNhbGwobnVsbCwgbWFya2VyKTsKICAgICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2hlbiBpdCdzIGEgdmVyc2lvbiBvZiBJLkUuIHRoYXQgbXVzdCBoYXZlIHRoZSBnbG9iYWwgb2JqZWN0IGZvciAndGhpcycsIGhvcGZ1bGx5IG91ciBjb250ZXh0IGNvcnJlY3Qgb3RoZXJ3aXNlIGl0IHdpbGwgdGhyb3cgYSBnbG9iYWwgZXJyb3IuCiAgICAgICAgICAgIC8vIFNvbWUgdmVyc2lvbnMgb2YgSS5FLiBoYXZlIGRpZmZlcmVudCBydWxlcyBmb3IgY2xlYXJUaW1lb3V0IHZzIHNldFRpbWVvdXQKICAgICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dC5jYWxsKHRoaXMsIG1hcmtlcik7CiAgICAgICAgfQogICAgfQoKCgp9CnZhciBxdWV1ZSA9IFtdOwp2YXIgZHJhaW5pbmcgPSBmYWxzZTsKdmFyIGN1cnJlbnRRdWV1ZTsKdmFyIHF1ZXVlSW5kZXggPSAtMTsKCmZ1bmN0aW9uIGNsZWFuVXBOZXh0VGljaygpIHsKICAgIGlmICghZHJhaW5pbmcgfHwgIWN1cnJlbnRRdWV1ZSkgewogICAgICAgIHJldHVybjsKICAgIH0KICAgIGRyYWluaW5nID0gZmFsc2U7CiAgICBpZiAoY3VycmVudFF1ZXVlLmxlbmd0aCkgewogICAgICAgIHF1ZXVlID0gY3VycmVudFF1ZXVlLmNvbmNhdChxdWV1ZSk7CiAgICB9IGVsc2UgewogICAgICAgIHF1ZXVlSW5kZXggPSAtMTsKICAgIH0KICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBkcmFpblF1ZXVlKCk7CiAgICB9Cn0KCmZ1bmN0aW9uIGRyYWluUXVldWUoKSB7CiAgICBpZiAoZHJhaW5pbmcpIHsKICAgICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdGltZW91dCA9IHJ1blRpbWVvdXQoY2xlYW5VcE5leHRUaWNrKTsKICAgIGRyYWluaW5nID0gdHJ1ZTsKCiAgICB2YXIgbGVuID0gcXVldWUubGVuZ3RoOwogICAgd2hpbGUobGVuKSB7CiAgICAgICAgY3VycmVudFF1ZXVlID0gcXVldWU7CiAgICAgICAgcXVldWUgPSBbXTsKICAgICAgICB3aGlsZSAoKytxdWV1ZUluZGV4IDwgbGVuKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50UXVldWUpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZVtxdWV1ZUluZGV4XS5ydW4oKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICAgICAgbGVuID0gcXVldWUubGVuZ3RoOwogICAgfQogICAgY3VycmVudFF1ZXVlID0gbnVsbDsKICAgIGRyYWluaW5nID0gZmFsc2U7CiAgICBydW5DbGVhclRpbWVvdXQodGltZW91dCk7Cn0KCnByb2Nlc3MubmV4dFRpY2sgPSBmdW5jdGlvbiAoZnVuKSB7CiAgICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoIC0gMSk7CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICB9CiAgICB9CiAgICBxdWV1ZS5wdXNoKG5ldyBJdGVtKGZ1biwgYXJncykpOwogICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMSAmJiAhZHJhaW5pbmcpIHsKICAgICAgICBydW5UaW1lb3V0KGRyYWluUXVldWUpOwogICAgfQp9OwoKLy8gdjggbGlrZXMgcHJlZGljdGlibGUgb2JqZWN0cwpmdW5jdGlvbiBJdGVtKGZ1biwgYXJyYXkpIHsKICAgIHRoaXMuZnVuID0gZnVuOwogICAgdGhpcy5hcnJheSA9IGFycmF5Owp9Ckl0ZW0ucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuZnVuLmFwcGx5KG51bGwsIHRoaXMuYXJyYXkpOwp9Owpwcm9jZXNzLnRpdGxlID0gJ2Jyb3dzZXInOwpwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwpwcm9jZXNzLmVudiA9IHt9Owpwcm9jZXNzLmFyZ3YgPSBbXTsKcHJvY2Vzcy52ZXJzaW9uID0gJyc7IC8vIGVtcHR5IHN0cmluZyB0byBhdm9pZCByZWdleHAgaXNzdWVzCnByb2Nlc3MudmVyc2lvbnMgPSB7fTsKCmZ1bmN0aW9uIG5vb3AoKSB7fQoKcHJvY2Vzcy5vbiA9IG5vb3A7CnByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLm9uY2UgPSBub29wOwpwcm9jZXNzLm9mZiA9IG5vb3A7CnByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7CnByb2Nlc3MuZW1pdCA9IG5vb3A7CnByb2Nlc3MucHJlcGVuZExpc3RlbmVyID0gbm9vcDsKcHJvY2Vzcy5wcmVwZW5kT25jZUxpc3RlbmVyID0gbm9vcDsKCnByb2Nlc3MubGlzdGVuZXJzID0gZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuIFtdIH0KCnByb2Nlc3MuYmluZGluZyA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkJyk7Cn07Cgpwcm9jZXNzLmN3ZCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICcvJyB9Owpwcm9jZXNzLmNoZGlyID0gZnVuY3Rpb24gKGRpcikgewogICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmNoZGlyIGlzIG5vdCBzdXBwb3J0ZWQnKTsKfTsKcHJvY2Vzcy51bWFzayA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gMDsgfTsKCn0se31dLDkwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChnbG9iYWwpeyhmdW5jdGlvbiAoKXsKLyohIGh0dHBzOi8vbXRocy5iZS9wdW55Y29kZSB2MS4zLjIgYnkgQG1hdGhpYXMgKi8KOyhmdW5jdGlvbihyb290KSB7CgoJLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlcyAqLwoJdmFyIGZyZWVFeHBvcnRzID0gdHlwZW9mIGV4cG9ydHMgPT0gJ29iamVjdCcgJiYgZXhwb3J0cyAmJgoJCSFleHBvcnRzLm5vZGVUeXBlICYmIGV4cG9ydHM7Cgl2YXIgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gJ29iamVjdCcgJiYgbW9kdWxlICYmCgkJIW1vZHVsZS5ub2RlVHlwZSAmJiBtb2R1bGU7Cgl2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsOwoJaWYgKAoJCWZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8CgkJZnJlZUdsb2JhbC53aW5kb3cgPT09IGZyZWVHbG9iYWwgfHwKCQlmcmVlR2xvYmFsLnNlbGYgPT09IGZyZWVHbG9iYWwKCSkgewoJCXJvb3QgPSBmcmVlR2xvYmFsOwoJfQoKCS8qKgoJICogVGhlIGBwdW55Y29kZWAgb2JqZWN0LgoJICogQG5hbWUgcHVueWNvZGUKCSAqIEB0eXBlIE9iamVjdAoJICovCgl2YXIgcHVueWNvZGUsCgoJLyoqIEhpZ2hlc3QgcG9zaXRpdmUgc2lnbmVkIDMyLWJpdCBmbG9hdCB2YWx1ZSAqLwoJbWF4SW50ID0gMjE0NzQ4MzY0NywgLy8gYWthLiAweDdGRkZGRkZGIG9yIDJeMzEtMQoKCS8qKiBCb290c3RyaW5nIHBhcmFtZXRlcnMgKi8KCWJhc2UgPSAzNiwKCXRNaW4gPSAxLAoJdE1heCA9IDI2LAoJc2tldyA9IDM4LAoJZGFtcCA9IDcwMCwKCWluaXRpYWxCaWFzID0gNzIsCglpbml0aWFsTiA9IDEyOCwgLy8gMHg4MAoJZGVsaW1pdGVyID0gJy0nLCAvLyAnXHgyRCcKCgkvKiogUmVndWxhciBleHByZXNzaW9ucyAqLwoJcmVnZXhQdW55Y29kZSA9IC9eeG4tLS8sCglyZWdleE5vbkFTQ0lJID0gL1teXHgyMC1ceDdFXS8sIC8vIHVucHJpbnRhYmxlIEFTQ0lJIGNoYXJzICsgbm9uLUFTQ0lJIGNoYXJzCglyZWdleFNlcGFyYXRvcnMgPSAvW1x4MkVcdTMwMDJcdUZGMEVcdUZGNjFdL2csIC8vIFJGQyAzNDkwIHNlcGFyYXRvcnMKCgkvKiogRXJyb3IgbWVzc2FnZXMgKi8KCWVycm9ycyA9IHsKCQknb3ZlcmZsb3cnOiAnT3ZlcmZsb3c6IGlucHV0IG5lZWRzIHdpZGVyIGludGVnZXJzIHRvIHByb2Nlc3MnLAoJCSdub3QtYmFzaWMnOiAnSWxsZWdhbCBpbnB1dCA+PSAweDgwIChub3QgYSBiYXNpYyBjb2RlIHBvaW50KScsCgkJJ2ludmFsaWQtaW5wdXQnOiAnSW52YWxpZCBpbnB1dCcKCX0sCgoJLyoqIENvbnZlbmllbmNlIHNob3J0Y3V0cyAqLwoJYmFzZU1pbnVzVE1pbiA9IGJhc2UgLSB0TWluLAoJZmxvb3IgPSBNYXRoLmZsb29yLAoJc3RyaW5nRnJvbUNoYXJDb2RlID0gU3RyaW5nLmZyb21DaGFyQ29kZSwKCgkvKiogVGVtcG9yYXJ5IHZhcmlhYmxlICovCglrZXk7CgoJLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoJLyoqCgkgKiBBIGdlbmVyaWMgZXJyb3IgdXRpbGl0eSBmdW5jdGlvbi4KCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgZXJyb3IgdHlwZS4KCSAqIEByZXR1cm5zIHtFcnJvcn0gVGhyb3dzIGEgYFJhbmdlRXJyb3JgIHdpdGggdGhlIGFwcGxpY2FibGUgZXJyb3IgbWVzc2FnZS4KCSAqLwoJZnVuY3Rpb24gZXJyb3IodHlwZSkgewoJCXRocm93IFJhbmdlRXJyb3IoZXJyb3JzW3R5cGVdKTsKCX0KCgkvKioKCSAqIEEgZ2VuZXJpYyBgQXJyYXkjbWFwYCB1dGlsaXR5IGZ1bmN0aW9uLgoJICogQHByaXZhdGUKCSAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpdGVyYXRlIG92ZXIuCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkgYXJyYXkKCSAqIGl0ZW0uCgkgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IGFycmF5IG9mIHZhbHVlcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24uCgkgKi8KCWZ1bmN0aW9uIG1hcChhcnJheSwgZm4pIHsKCQl2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwoJCXZhciByZXN1bHQgPSBbXTsKCQl3aGlsZSAobGVuZ3RoLS0pIHsKCQkJcmVzdWx0W2xlbmd0aF0gPSBmbihhcnJheVtsZW5ndGhdKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0KCgkvKioKCSAqIEEgc2ltcGxlIGBBcnJheSNtYXBgLWxpa2Ugd3JhcHBlciB0byB3b3JrIHdpdGggZG9tYWluIG5hbWUgc3RyaW5ncyBvciBlbWFpbAoJICogYWRkcmVzc2VzLgoJICogQHByaXZhdGUKCSAqIEBwYXJhbSB7U3RyaW5nfSBkb21haW4gVGhlIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MuCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdGhhdCBnZXRzIGNhbGxlZCBmb3IgZXZlcnkKCSAqIGNoYXJhY3Rlci4KCSAqIEByZXR1cm5zIHtBcnJheX0gQSBuZXcgc3RyaW5nIG9mIGNoYXJhY3RlcnMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrCgkgKiBmdW5jdGlvbi4KCSAqLwoJZnVuY3Rpb24gbWFwRG9tYWluKHN0cmluZywgZm4pIHsKCQl2YXIgcGFydHMgPSBzdHJpbmcuc3BsaXQoJ0AnKTsKCQl2YXIgcmVzdWx0ID0gJyc7CgkJaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHsKCQkJLy8gSW4gZW1haWwgYWRkcmVzc2VzLCBvbmx5IHRoZSBkb21haW4gbmFtZSBzaG91bGQgYmUgcHVueWNvZGVkLiBMZWF2ZQoJCQkvLyB0aGUgbG9jYWwgcGFydCAoaS5lLiBldmVyeXRoaW5nIHVwIHRvIGBAYCkgaW50YWN0LgoJCQlyZXN1bHQgPSBwYXJ0c1swXSArICdAJzsKCQkJc3RyaW5nID0gcGFydHNbMV07CgkJfQoJCS8vIEF2b2lkIGBzcGxpdChyZWdleClgIGZvciBJRTggY29tcGF0aWJpbGl0eS4gU2VlICMxNy4KCQlzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShyZWdleFNlcGFyYXRvcnMsICdceDJFJyk7CgkJdmFyIGxhYmVscyA9IHN0cmluZy5zcGxpdCgnLicpOwoJCXZhciBlbmNvZGVkID0gbWFwKGxhYmVscywgZm4pLmpvaW4oJy4nKTsKCQlyZXR1cm4gcmVzdWx0ICsgZW5jb2RlZDsKCX0KCgkvKioKCSAqIENyZWF0ZXMgYW4gYXJyYXkgY29udGFpbmluZyB0aGUgbnVtZXJpYyBjb2RlIHBvaW50cyBvZiBlYWNoIFVuaWNvZGUKCSAqIGNoYXJhY3RlciBpbiB0aGUgc3RyaW5nLiBXaGlsZSBKYXZhU2NyaXB0IHVzZXMgVUNTLTIgaW50ZXJuYWxseSwKCSAqIHRoaXMgZnVuY3Rpb24gd2lsbCBjb252ZXJ0IGEgcGFpciBvZiBzdXJyb2dhdGUgaGFsdmVzIChlYWNoIG9mIHdoaWNoCgkgKiBVQ1MtMiBleHBvc2VzIGFzIHNlcGFyYXRlIGNoYXJhY3RlcnMpIGludG8gYSBzaW5nbGUgY29kZSBwb2ludCwKCSAqIG1hdGNoaW5nIFVURi0xNi4KCSAqIEBzZWUgYHB1bnljb2RlLnVjczIuZW5jb2RlYAoJICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CgkgKiBAbWVtYmVyT2YgcHVueWNvZGUudWNzMgoJICogQG5hbWUgZGVjb2RlCgkgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBVbmljb2RlIGlucHV0IHN0cmluZyAoVUNTLTIpLgoJICogQHJldHVybnMge0FycmF5fSBUaGUgbmV3IGFycmF5IG9mIGNvZGUgcG9pbnRzLgoJICovCglmdW5jdGlvbiB1Y3MyZGVjb2RlKHN0cmluZykgewoJCXZhciBvdXRwdXQgPSBbXSwKCQkgICAgY291bnRlciA9IDAsCgkJICAgIGxlbmd0aCA9IHN0cmluZy5sZW5ndGgsCgkJICAgIHZhbHVlLAoJCSAgICBleHRyYTsKCQl3aGlsZSAoY291bnRlciA8IGxlbmd0aCkgewoJCQl2YWx1ZSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CgkJCWlmICh2YWx1ZSA+PSAweEQ4MDAgJiYgdmFsdWUgPD0gMHhEQkZGICYmIGNvdW50ZXIgPCBsZW5ndGgpIHsKCQkJCS8vIGhpZ2ggc3Vycm9nYXRlLCBhbmQgdGhlcmUgaXMgYSBuZXh0IGNoYXJhY3RlcgoJCQkJZXh0cmEgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwoJCQkJaWYgKChleHRyYSAmIDB4RkMwMCkgPT0gMHhEQzAwKSB7IC8vIGxvdyBzdXJyb2dhdGUKCQkJCQlvdXRwdXQucHVzaCgoKHZhbHVlICYgMHgzRkYpIDw8IDEwKSArIChleHRyYSAmIDB4M0ZGKSArIDB4MTAwMDApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB1bm1hdGNoZWQgc3Vycm9nYXRlOyBvbmx5IGFwcGVuZCB0aGlzIGNvZGUgdW5pdCwgaW4gY2FzZSB0aGUgbmV4dAoJCQkJCS8vIGNvZGUgdW5pdCBpcyB0aGUgaGlnaCBzdXJyb2dhdGUgb2YgYSBzdXJyb2dhdGUgcGFpcgoJCQkJCW91dHB1dC5wdXNoKHZhbHVlKTsKCQkJCQljb3VudGVyLS07CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlvdXRwdXQucHVzaCh2YWx1ZSk7CgkJCX0KCQl9CgkJcmV0dXJuIG91dHB1dDsKCX0KCgkvKioKCSAqIENyZWF0ZXMgYSBzdHJpbmcgYmFzZWQgb24gYW4gYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KCSAqIEBzZWUgYHB1bnljb2RlLnVjczIuZGVjb2RlYAoJICogQG1lbWJlck9mIHB1bnljb2RlLnVjczIKCSAqIEBuYW1lIGVuY29kZQoJICogQHBhcmFtIHtBcnJheX0gY29kZVBvaW50cyBUaGUgYXJyYXkgb2YgbnVtZXJpYyBjb2RlIHBvaW50cy4KCSAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBuZXcgVW5pY29kZSBzdHJpbmcgKFVDUy0yKS4KCSAqLwoJZnVuY3Rpb24gdWNzMmVuY29kZShhcnJheSkgewoJCXJldHVybiBtYXAoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKSB7CgkJCXZhciBvdXRwdXQgPSAnJzsKCQkJaWYgKHZhbHVlID4gMHhGRkZGKSB7CgkJCQl2YWx1ZSAtPSAweDEwMDAwOwoJCQkJb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCk7CgkJCQl2YWx1ZSA9IDB4REMwMCB8IHZhbHVlICYgMHgzRkY7CgkJCX0KCQkJb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSk7CgkJCXJldHVybiBvdXRwdXQ7CgkJfSkuam9pbignJyk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIGJhc2ljIGNvZGUgcG9pbnQgaW50byBhIGRpZ2l0L2ludGVnZXIuCgkgKiBAc2VlIGBkaWdpdFRvQmFzaWMoKWAKCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge051bWJlcn0gY29kZVBvaW50IFRoZSBiYXNpYyBudW1lcmljIGNvZGUgcG9pbnQgdmFsdWUuCgkgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQgKGZvciB1c2UgaW4KCSAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaW4gdGhlIHJhbmdlIGAwYCB0byBgYmFzZSAtIDFgLCBvciBgYmFzZWAgaWYKCSAqIHRoZSBjb2RlIHBvaW50IGRvZXMgbm90IHJlcHJlc2VudCBhIHZhbHVlLgoJICovCglmdW5jdGlvbiBiYXNpY1RvRGlnaXQoY29kZVBvaW50KSB7CgkJaWYgKGNvZGVQb2ludCAtIDQ4IDwgMTApIHsKCQkJcmV0dXJuIGNvZGVQb2ludCAtIDIyOwoJCX0KCQlpZiAoY29kZVBvaW50IC0gNjUgPCAyNikgewoJCQlyZXR1cm4gY29kZVBvaW50IC0gNjU7CgkJfQoJCWlmIChjb2RlUG9pbnQgLSA5NyA8IDI2KSB7CgkJCXJldHVybiBjb2RlUG9pbnQgLSA5NzsKCQl9CgkJcmV0dXJuIGJhc2U7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIGRpZ2l0L2ludGVnZXIgaW50byBhIGJhc2ljIGNvZGUgcG9pbnQuCgkgKiBAc2VlIGBiYXNpY1RvRGlnaXQoKWAKCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0ge051bWJlcn0gZGlnaXQgVGhlIG51bWVyaWMgdmFsdWUgb2YgYSBiYXNpYyBjb2RlIHBvaW50LgoJICogQHJldHVybnMge051bWJlcn0gVGhlIGJhc2ljIGNvZGUgcG9pbnQgd2hvc2UgdmFsdWUgKHdoZW4gdXNlZCBmb3IKCSAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaXMgYGRpZ2l0YCwgd2hpY2ggbmVlZHMgdG8gYmUgaW4gdGhlIHJhbmdlCgkgKiBgMGAgdG8gYGJhc2UgLSAxYC4gSWYgYGZsYWdgIGlzIG5vbi16ZXJvLCB0aGUgdXBwZXJjYXNlIGZvcm0gaXMKCSAqIHVzZWQ7IGVsc2UsIHRoZSBsb3dlcmNhc2UgZm9ybSBpcyB1c2VkLiBUaGUgYmVoYXZpb3IgaXMgdW5kZWZpbmVkCgkgKiBpZiBgZmxhZ2AgaXMgbm9uLXplcm8gYW5kIGBkaWdpdGAgaGFzIG5vIHVwcGVyY2FzZSBmb3JtLgoJICovCglmdW5jdGlvbiBkaWdpdFRvQmFzaWMoZGlnaXQsIGZsYWcpIHsKCQkvLyAgMC4uMjUgbWFwIHRvIEFTQ0lJIGEuLnogb3IgQS4uWgoJCS8vIDI2Li4zNSBtYXAgdG8gQVNDSUkgMC4uOQoJCXJldHVybiBkaWdpdCArIDIyICsgNzUgKiAoZGlnaXQgPCAyNikgLSAoKGZsYWcgIT0gMCkgPDwgNSk7Cgl9CgoJLyoqCgkgKiBCaWFzIGFkYXB0YXRpb24gZnVuY3Rpb24gYXMgcGVyIHNlY3Rpb24gMy40IG9mIFJGQyAzNDkyLgoJICogaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzQ5MiNzZWN0aW9uLTMuNAoJICogQHByaXZhdGUKCSAqLwoJZnVuY3Rpb24gYWRhcHQoZGVsdGEsIG51bVBvaW50cywgZmlyc3RUaW1lKSB7CgkJdmFyIGsgPSAwOwoJCWRlbHRhID0gZmlyc3RUaW1lID8gZmxvb3IoZGVsdGEgLyBkYW1wKSA6IGRlbHRhID4+IDE7CgkJZGVsdGEgKz0gZmxvb3IoZGVsdGEgLyBudW1Qb2ludHMpOwoJCWZvciAoLyogbm8gaW5pdGlhbGl6YXRpb24gKi87IGRlbHRhID4gYmFzZU1pbnVzVE1pbiAqIHRNYXggPj4gMTsgayArPSBiYXNlKSB7CgkJCWRlbHRhID0gZmxvb3IoZGVsdGEgLyBiYXNlTWludXNUTWluKTsKCQl9CgkJcmV0dXJuIGZsb29yKGsgKyAoYmFzZU1pbnVzVE1pbiArIDEpICogZGVsdGEgLyAoZGVsdGEgKyBza2V3KSk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMgdG8gYSBzdHJpbmcgb2YgVW5pY29kZQoJICogc3ltYm9scy4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgoJICovCglmdW5jdGlvbiBkZWNvZGUoaW5wdXQpIHsKCQkvLyBEb24ndCB1c2UgVUNTLTIKCQl2YXIgb3V0cHV0ID0gW10sCgkJICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCSAgICBvdXQsCgkJICAgIGkgPSAwLAoJCSAgICBuID0gaW5pdGlhbE4sCgkJICAgIGJpYXMgPSBpbml0aWFsQmlhcywKCQkgICAgYmFzaWMsCgkJICAgIGosCgkJICAgIGluZGV4LAoJCSAgICBvbGRpLAoJCSAgICB3LAoJCSAgICBrLAoJCSAgICBkaWdpdCwKCQkgICAgdCwKCQkgICAgLyoqIENhY2hlZCBjYWxjdWxhdGlvbiByZXN1bHRzICovCgkJICAgIGJhc2VNaW51c1Q7CgoJCS8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHM6IGxldCBgYmFzaWNgIGJlIHRoZSBudW1iZXIgb2YgaW5wdXQgY29kZQoJCS8vIHBvaW50cyBiZWZvcmUgdGhlIGxhc3QgZGVsaW1pdGVyLCBvciBgMGAgaWYgdGhlcmUgaXMgbm9uZSwgdGhlbiBjb3B5CgkJLy8gdGhlIGZpcnN0IGJhc2ljIGNvZGUgcG9pbnRzIHRvIHRoZSBvdXRwdXQuCgoJCWJhc2ljID0gaW5wdXQubGFzdEluZGV4T2YoZGVsaW1pdGVyKTsKCQlpZiAoYmFzaWMgPCAwKSB7CgkJCWJhc2ljID0gMDsKCQl9CgoJCWZvciAoaiA9IDA7IGogPCBiYXNpYzsgKytqKSB7CgkJCS8vIGlmIGl0J3Mgbm90IGEgYmFzaWMgY29kZSBwb2ludAoJCQlpZiAoaW5wdXQuY2hhckNvZGVBdChqKSA+PSAweDgwKSB7CgkJCQllcnJvcignbm90LWJhc2ljJyk7CgkJCX0KCQkJb3V0cHV0LnB1c2goaW5wdXQuY2hhckNvZGVBdChqKSk7CgkJfQoKCQkvLyBNYWluIGRlY29kaW5nIGxvb3A6IHN0YXJ0IGp1c3QgYWZ0ZXIgdGhlIGxhc3QgZGVsaW1pdGVyIGlmIGFueSBiYXNpYyBjb2RlCgkJLy8gcG9pbnRzIHdlcmUgY29waWVkOyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nIG90aGVyd2lzZS4KCgkJZm9yIChpbmRleCA9IGJhc2ljID4gMCA/IGJhc2ljICsgMSA6IDA7IGluZGV4IDwgaW5wdXRMZW5ndGg7IC8qIG5vIGZpbmFsIGV4cHJlc3Npb24gKi8pIHsKCgkJCS8vIGBpbmRleGAgaXMgdGhlIGluZGV4IG9mIHRoZSBuZXh0IGNoYXJhY3RlciB0byBiZSBjb25zdW1lZC4KCQkJLy8gRGVjb2RlIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIgaW50byBgZGVsdGFgLAoJCQkvLyB3aGljaCBnZXRzIGFkZGVkIHRvIGBpYC4gVGhlIG92ZXJmbG93IGNoZWNraW5nIGlzIGVhc2llcgoJCQkvLyBpZiB3ZSBpbmNyZWFzZSBgaWAgYXMgd2UgZ28sIHRoZW4gc3VidHJhY3Qgb2ZmIGl0cyBzdGFydGluZwoJCQkvLyB2YWx1ZSBhdCB0aGUgZW5kIHRvIG9idGFpbiBgZGVsdGFgLgoJCQlmb3IgKG9sZGkgPSBpLCB3ID0gMSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CgoJCQkJaWYgKGluZGV4ID49IGlucHV0TGVuZ3RoKSB7CgkJCQkJZXJyb3IoJ2ludmFsaWQtaW5wdXQnKTsKCQkJCX0KCgkJCQlkaWdpdCA9IGJhc2ljVG9EaWdpdChpbnB1dC5jaGFyQ29kZUF0KGluZGV4KyspKTsKCgkJCQlpZiAoZGlnaXQgPj0gYmFzZSB8fCBkaWdpdCA+IGZsb29yKChtYXhJbnQgLSBpKSAvIHcpKSB7CgkJCQkJZXJyb3IoJ292ZXJmbG93Jyk7CgkJCQl9CgoJCQkJaSArPSBkaWdpdCAqIHc7CgkJCQl0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKCgkJCQlpZiAoZGlnaXQgPCB0KSB7CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwoJCQkJaWYgKHcgPiBmbG9vcihtYXhJbnQgLyBiYXNlTWludXNUKSkgewoJCQkJCWVycm9yKCdvdmVyZmxvdycpOwoJCQkJfQoKCQkJCXcgKj0gYmFzZU1pbnVzVDsKCgkJCX0KCgkJCW91dCA9IG91dHB1dC5sZW5ndGggKyAxOwoJCQliaWFzID0gYWRhcHQoaSAtIG9sZGksIG91dCwgb2xkaSA9PSAwKTsKCgkJCS8vIGBpYCB3YXMgc3VwcG9zZWQgdG8gd3JhcCBhcm91bmQgZnJvbSBgb3V0YCB0byBgMGAsCgkJCS8vIGluY3JlbWVudGluZyBgbmAgZWFjaCB0aW1lLCBzbyB3ZSdsbCBmaXggdGhhdCBub3c6CgkJCWlmIChmbG9vcihpIC8gb3V0KSA+IG1heEludCAtIG4pIHsKCQkJCWVycm9yKCdvdmVyZmxvdycpOwoJCQl9CgoJCQluICs9IGZsb29yKGkgLyBvdXQpOwoJCQlpICU9IG91dDsKCgkJCS8vIEluc2VydCBgbmAgYXQgcG9zaXRpb24gYGlgIG9mIHRoZSBvdXRwdXQKCQkJb3V0cHV0LnNwbGljZShpKyssIDAsIG4pOwoKCQl9CgoJCXJldHVybiB1Y3MyZW5jb2RlKG91dHB1dCk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMgKGUuZy4gYSBkb21haW4gbmFtZSBsYWJlbCkgdG8gYQoJICogUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgoJICovCglmdW5jdGlvbiBlbmNvZGUoaW5wdXQpIHsKCQl2YXIgbiwKCQkgICAgZGVsdGEsCgkJICAgIGhhbmRsZWRDUENvdW50LAoJCSAgICBiYXNpY0xlbmd0aCwKCQkgICAgYmlhcywKCQkgICAgaiwKCQkgICAgbSwKCQkgICAgcSwKCQkgICAgaywKCQkgICAgdCwKCQkgICAgY3VycmVudFZhbHVlLAoJCSAgICBvdXRwdXQgPSBbXSwKCQkgICAgLyoqIGBpbnB1dExlbmd0aGAgd2lsbCBob2xkIHRoZSBudW1iZXIgb2YgY29kZSBwb2ludHMgaW4gYGlucHV0YC4gKi8KCQkgICAgaW5wdXRMZW5ndGgsCgkJICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwoJCSAgICBoYW5kbGVkQ1BDb3VudFBsdXNPbmUsCgkJICAgIGJhc2VNaW51c1QsCgkJICAgIHFNaW51c1Q7CgoJCS8vIENvbnZlcnQgdGhlIGlucHV0IGluIFVDUy0yIHRvIFVuaWNvZGUKCQlpbnB1dCA9IHVjczJkZWNvZGUoaW5wdXQpOwoKCQkvLyBDYWNoZSB0aGUgbGVuZ3RoCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGg7CgoJCS8vIEluaXRpYWxpemUgdGhlIHN0YXRlCgkJbiA9IGluaXRpYWxOOwoJCWRlbHRhID0gMDsKCQliaWFzID0gaW5pdGlhbEJpYXM7CgoJCS8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHMKCQlmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewoJCQljdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKCQkJaWYgKGN1cnJlbnRWYWx1ZSA8IDB4ODApIHsKCQkJCW91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShjdXJyZW50VmFsdWUpKTsKCQkJfQoJCX0KCgkJaGFuZGxlZENQQ291bnQgPSBiYXNpY0xlbmd0aCA9IG91dHB1dC5sZW5ndGg7CgoJCS8vIGBoYW5kbGVkQ1BDb3VudGAgaXMgdGhlIG51bWJlciBvZiBjb2RlIHBvaW50cyB0aGF0IGhhdmUgYmVlbiBoYW5kbGVkOwoJCS8vIGBiYXNpY0xlbmd0aGAgaXMgdGhlIG51bWJlciBvZiBiYXNpYyBjb2RlIHBvaW50cy4KCgkJLy8gRmluaXNoIHRoZSBiYXNpYyBzdHJpbmcgLSBpZiBpdCBpcyBub3QgZW1wdHkgLSB3aXRoIGEgZGVsaW1pdGVyCgkJaWYgKGJhc2ljTGVuZ3RoKSB7CgkJCW91dHB1dC5wdXNoKGRlbGltaXRlcik7CgkJfQoKCQkvLyBNYWluIGVuY29kaW5nIGxvb3A6CgkJd2hpbGUgKGhhbmRsZWRDUENvdW50IDwgaW5wdXRMZW5ndGgpIHsKCgkJCS8vIEFsbCBub24tYmFzaWMgY29kZSBwb2ludHMgPCBuIGhhdmUgYmVlbiBoYW5kbGVkIGFscmVhZHkuIEZpbmQgdGhlIG5leHQKCQkJLy8gbGFyZ2VyIG9uZToKCQkJZm9yIChtID0gbWF4SW50LCBqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKCQkJCWN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwoJCQkJaWYgKGN1cnJlbnRWYWx1ZSA+PSBuICYmIGN1cnJlbnRWYWx1ZSA8IG0pIHsKCQkJCQltID0gY3VycmVudFZhbHVlOwoJCQkJfQoJCQl9CgoJCQkvLyBJbmNyZWFzZSBgZGVsdGFgIGVub3VnaCB0byBhZHZhbmNlIHRoZSBkZWNvZGVyJ3MgPG4saT4gc3RhdGUgdG8gPG0sMD4sCgkJCS8vIGJ1dCBndWFyZCBhZ2FpbnN0IG92ZXJmbG93CgkJCWhhbmRsZWRDUENvdW50UGx1c09uZSA9IGhhbmRsZWRDUENvdW50ICsgMTsKCQkJaWYgKG0gLSBuID4gZmxvb3IoKG1heEludCAtIGRlbHRhKSAvIGhhbmRsZWRDUENvdW50UGx1c09uZSkpIHsKCQkJCWVycm9yKCdvdmVyZmxvdycpOwoJCQl9CgoJCQlkZWx0YSArPSAobSAtIG4pICogaGFuZGxlZENQQ291bnRQbHVzT25lOwoJCQluID0gbTsKCgkJCWZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CgkJCQljdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKCgkJCQlpZiAoY3VycmVudFZhbHVlIDwgbiAmJiArK2RlbHRhID4gbWF4SW50KSB7CgkJCQkJZXJyb3IoJ292ZXJmbG93Jyk7CgkJCQl9CgoJCQkJaWYgKGN1cnJlbnRWYWx1ZSA9PSBuKSB7CgkJCQkJLy8gUmVwcmVzZW50IGRlbHRhIGFzIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIKCQkJCQlmb3IgKHEgPSBkZWx0YSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CgkJCQkJCXQgPSBrIDw9IGJpYXMgPyB0TWluIDogKGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXMpOwoJCQkJCQlpZiAocSA8IHQpIHsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJCXFNaW51c1QgPSBxIC0gdDsKCQkJCQkJYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwoJCQkJCQlvdXRwdXQucHVzaCgKCQkJCQkJCXN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWModCArIHFNaW51c1QgJSBiYXNlTWludXNULCAwKSkKCQkJCQkJKTsKCQkJCQkJcSA9IGZsb29yKHFNaW51c1QgLyBiYXNlTWludXNUKTsKCQkJCQl9CgoJCQkJCW91dHB1dC5wdXNoKHN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWMocSwgMCkpKTsKCQkJCQliaWFzID0gYWRhcHQoZGVsdGEsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgaGFuZGxlZENQQ291bnQgPT0gYmFzaWNMZW5ndGgpOwoJCQkJCWRlbHRhID0gMDsKCQkJCQkrK2hhbmRsZWRDUENvdW50OwoJCQkJfQoJCQl9CgoJCQkrK2RlbHRhOwoJCQkrK247CgoJCX0KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfQoKCS8qKgoJICogQ29udmVydHMgYSBQdW55Y29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcwoJICogdG8gVW5pY29kZS4gT25seSB0aGUgUHVueWNvZGVkIHBhcnRzIG9mIHRoZSBpbnB1dCB3aWxsIGJlIGNvbnZlcnRlZCwgaS5lLgoJICogaXQgZG9lc24ndCBtYXR0ZXIgaWYgeW91IGNhbGwgaXQgb24gYSBzdHJpbmcgdGhhdCBoYXMgYWxyZWFkeSBiZWVuCgkgKiBjb252ZXJ0ZWQgdG8gVW5pY29kZS4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZWQgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcyB0bwoJICogY29udmVydCB0byBVbmljb2RlLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIFVuaWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIFB1bnljb2RlCgkgKiBzdHJpbmcuCgkgKi8KCWZ1bmN0aW9uIHRvVW5pY29kZShpbnB1dCkgewoJCXJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewoJCQlyZXR1cm4gcmVnZXhQdW55Y29kZS50ZXN0KHN0cmluZykKCQkJCT8gZGVjb2RlKHN0cmluZy5zbGljZSg0KS50b0xvd2VyQ2FzZSgpKQoJCQkJOiBzdHJpbmc7CgkJfSk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIFVuaWNvZGUgc3RyaW5nIHJlcHJlc2VudGluZyBhIGRvbWFpbiBuYW1lIG9yIGFuIGVtYWlsIGFkZHJlc3MgdG8KCSAqIFB1bnljb2RlLiBPbmx5IHRoZSBub24tQVNDSUkgcGFydHMgb2YgdGhlIGRvbWFpbiBuYW1lIHdpbGwgYmUgY29udmVydGVkLAoJICogaS5lLiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQncyBhbHJlYWR5IGluCgkgKiBBU0NJSS4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvIGNvbnZlcnQsIGFzIGEKCSAqIFVuaWNvZGUgc3RyaW5nLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIFB1bnljb2RlIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBkb21haW4gbmFtZSBvcgoJICogZW1haWwgYWRkcmVzcy4KCSAqLwoJZnVuY3Rpb24gdG9BU0NJSShpbnB1dCkgewoJCXJldHVybiBtYXBEb21haW4oaW5wdXQsIGZ1bmN0aW9uKHN0cmluZykgewoJCQlyZXR1cm4gcmVnZXhOb25BU0NJSS50ZXN0KHN0cmluZykKCQkJCT8gJ3huLS0nICsgZW5jb2RlKHN0cmluZykKCQkJCTogc3RyaW5nOwoJCX0pOwoJfQoKCS8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKCS8qKiBEZWZpbmUgdGhlIHB1YmxpYyBBUEkgKi8KCXB1bnljb2RlID0gewoJCS8qKgoJCSAqIEEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBQdW55Y29kZS5qcyB2ZXJzaW9uIG51bWJlci4KCQkgKiBAbWVtYmVyT2YgcHVueWNvZGUKCQkgKiBAdHlwZSBTdHJpbmcKCQkgKi8KCQkndmVyc2lvbic6ICcxLjMuMicsCgkJLyoqCgkJICogQW4gb2JqZWN0IG9mIG1ldGhvZHMgdG8gY29udmVydCBmcm9tIEphdmFTY3JpcHQncyBpbnRlcm5hbCBjaGFyYWN0ZXIKCQkgKiByZXByZXNlbnRhdGlvbiAoVUNTLTIpIHRvIFVuaWNvZGUgY29kZSBwb2ludHMsIGFuZCBiYWNrLgoJCSAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgoJCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJCSAqIEB0eXBlIE9iamVjdAoJCSAqLwoJCSd1Y3MyJzogewoJCQknZGVjb2RlJzogdWNzMmRlY29kZSwKCQkJJ2VuY29kZSc6IHVjczJlbmNvZGUKCQl9LAoJCSdkZWNvZGUnOiBkZWNvZGUsCgkJJ2VuY29kZSc6IGVuY29kZSwKCQkndG9BU0NJSSc6IHRvQVNDSUksCgkJJ3RvVW5pY29kZSc6IHRvVW5pY29kZQoJfTsKCgkvKiogRXhwb3NlIGBwdW55Y29kZWAgKi8KCS8vIFNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucwoJLy8gbGlrZSB0aGUgZm9sbG93aW5nOgoJaWYgKAoJCXRydWUKCSkgewoJCSEoX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gPSAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBwdW55Y29kZTsKCQl9KS5jYWxsKGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18sIGV4cG9ydHMsIG1vZHVsZSksCgkJX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gIT09IHVuZGVmaW5lZCAmJiAobW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXykpOwoJfSBlbHNlIHt9Cgp9KHRoaXMpKTsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMsdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKfSx7fV0sOTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgondXNlIHN0cmljdCc7CgovLyBJZiBvYmouaGFzT3duUHJvcGVydHkgaGFzIGJlZW4gb3ZlcnJpZGRlbiwgdGhlbiBjYWxsaW5nCi8vIG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSB3aWxsIGJyZWFrLgovLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb3llbnQvbm9kZS9pc3N1ZXMvMTcwNwpmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7Cn0KCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocXMsIHNlcCwgZXEsIG9wdGlvbnMpIHsKICBzZXAgPSBzZXAgfHwgJyYnOwogIGVxID0gZXEgfHwgJz0nOwogIHZhciBvYmogPSB7fTsKCiAgaWYgKHR5cGVvZiBxcyAhPT0gJ3N0cmluZycgfHwgcXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gb2JqOwogIH0KCiAgdmFyIHJlZ2V4cCA9IC9cKy9nOwogIHFzID0gcXMuc3BsaXQoc2VwKTsKCiAgdmFyIG1heEtleXMgPSAxMDAwOwogIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLm1heEtleXMgPT09ICdudW1iZXInKSB7CiAgICBtYXhLZXlzID0gb3B0aW9ucy5tYXhLZXlzOwogIH0KCiAgdmFyIGxlbiA9IHFzLmxlbmd0aDsKICAvLyBtYXhLZXlzIDw9IDAgbWVhbnMgdGhhdCB3ZSBzaG91bGQgbm90IGxpbWl0IGtleXMgY291bnQKICBpZiAobWF4S2V5cyA+IDAgJiYgbGVuID4gbWF4S2V5cykgewogICAgbGVuID0gbWF4S2V5czsKICB9CgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgIHZhciB4ID0gcXNbaV0ucmVwbGFjZShyZWdleHAsICclMjAnKSwKICAgICAgICBpZHggPSB4LmluZGV4T2YoZXEpLAogICAgICAgIGtzdHIsIHZzdHIsIGssIHY7CgogICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgIGtzdHIgPSB4LnN1YnN0cigwLCBpZHgpOwogICAgICB2c3RyID0geC5zdWJzdHIoaWR4ICsgMSk7CiAgICB9IGVsc2UgewogICAgICBrc3RyID0geDsKICAgICAgdnN0ciA9ICcnOwogICAgfQoKICAgIGsgPSBkZWNvZGVVUklDb21wb25lbnQoa3N0cik7CiAgICB2ID0gZGVjb2RlVVJJQ29tcG9uZW50KHZzdHIpOwoKICAgIGlmICghaGFzT3duUHJvcGVydHkob2JqLCBrKSkgewogICAgICBvYmpba10gPSB2OwogICAgfSBlbHNlIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgb2JqW2tdLnB1c2godik7CiAgICB9IGVsc2UgewogICAgICBvYmpba10gPSBbb2JqW2tdLCB2XTsKICAgIH0KICB9CgogIHJldHVybiBvYmo7Cn07Cgp2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKHhzKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4cykgPT09ICdbb2JqZWN0IEFycmF5XSc7Cn07Cgp9LHt9XSw5MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCid1c2Ugc3RyaWN0JzsKCnZhciBzdHJpbmdpZnlQcmltaXRpdmUgPSBmdW5jdGlvbih2KSB7CiAgc3dpdGNoICh0eXBlb2YgdikgewogICAgY2FzZSAnc3RyaW5nJzoKICAgICAgcmV0dXJuIHY7CgogICAgY2FzZSAnYm9vbGVhbic6CiAgICAgIHJldHVybiB2ID8gJ3RydWUnIDogJ2ZhbHNlJzsKCiAgICBjYXNlICdudW1iZXInOgogICAgICByZXR1cm4gaXNGaW5pdGUodikgPyB2IDogJyc7CgogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuICcnOwogIH0KfTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgc2VwID0gc2VwIHx8ICcmJzsKICBlcSA9IGVxIHx8ICc9JzsKICBpZiAob2JqID09PSBudWxsKSB7CiAgICBvYmogPSB1bmRlZmluZWQ7CiAgfQoKICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgIHJldHVybiBtYXAob2JqZWN0S2V5cyhvYmopLCBmdW5jdGlvbihrKSB7CiAgICAgIHZhciBrcyA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUoaykpICsgZXE7CiAgICAgIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgICByZXR1cm4gbWFwKG9ialtrXSwgZnVuY3Rpb24odikgewogICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZSh2KSk7CiAgICAgICAgfSkuam9pbihzZXApOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqW2tdKSk7CiAgICAgIH0KICAgIH0pLmpvaW4oc2VwKTsKCiAgfQoKICBpZiAoIW5hbWUpIHJldHVybiAnJzsKICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShuYW1lKSkgKyBlcSArCiAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqKSk7Cn07Cgp2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKHhzKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4cykgPT09ICdbb2JqZWN0IEFycmF5XSc7Cn07CgpmdW5jdGlvbiBtYXAgKHhzLCBmKSB7CiAgaWYgKHhzLm1hcCkgcmV0dXJuIHhzLm1hcChmKTsKICB2YXIgcmVzID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB4cy5sZW5ndGg7IGkrKykgewogICAgcmVzLnB1c2goZih4c1tpXSwgaSkpOwogIH0KICByZXR1cm4gcmVzOwp9Cgp2YXIgb2JqZWN0S2V5cyA9IE9iamVjdC5rZXlzIHx8IGZ1bmN0aW9uIChvYmopIHsKICB2YXIgcmVzID0gW107CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHJlcy5wdXNoKGtleSk7CiAgfQogIHJldHVybiByZXM7Cn07Cgp9LHt9XSw5MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCmV4cG9ydHMuZGVjb2RlID0gZXhwb3J0cy5wYXJzZSA9IHJlcXVpcmUoJy4vZGVjb2RlJyk7CmV4cG9ydHMuZW5jb2RlID0gZXhwb3J0cy5zdHJpbmdpZnkgPSByZXF1aXJlKCcuL2VuY29kZScpOwoKfSx7Ii4vZGVjb2RlIjo5MSwiLi9lbmNvZGUiOjkyfV0sOTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgondXNlIHN0cmljdCc7CgovLyBJZiBvYmouaGFzT3duUHJvcGVydHkgaGFzIGJlZW4gb3ZlcnJpZGRlbiwgdGhlbiBjYWxsaW5nCi8vIG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSB3aWxsIGJyZWFrLgovLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb3llbnQvbm9kZS9pc3N1ZXMvMTcwNwpmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7Cn0KCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocXMsIHNlcCwgZXEsIG9wdGlvbnMpIHsKICBzZXAgPSBzZXAgfHwgJyYnOwogIGVxID0gZXEgfHwgJz0nOwogIHZhciBvYmogPSB7fTsKCiAgaWYgKHR5cGVvZiBxcyAhPT0gJ3N0cmluZycgfHwgcXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gb2JqOwogIH0KCiAgdmFyIHJlZ2V4cCA9IC9cKy9nOwogIHFzID0gcXMuc3BsaXQoc2VwKTsKCiAgdmFyIG1heEtleXMgPSAxMDAwOwogIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLm1heEtleXMgPT09ICdudW1iZXInKSB7CiAgICBtYXhLZXlzID0gb3B0aW9ucy5tYXhLZXlzOwogIH0KCiAgdmFyIGxlbiA9IHFzLmxlbmd0aDsKICAvLyBtYXhLZXlzIDw9IDAgbWVhbnMgdGhhdCB3ZSBzaG91bGQgbm90IGxpbWl0IGtleXMgY291bnQKICBpZiAobWF4S2V5cyA+IDAgJiYgbGVuID4gbWF4S2V5cykgewogICAgbGVuID0gbWF4S2V5czsKICB9CgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgIHZhciB4ID0gcXNbaV0ucmVwbGFjZShyZWdleHAsICclMjAnKSwKICAgICAgICBpZHggPSB4LmluZGV4T2YoZXEpLAogICAgICAgIGtzdHIsIHZzdHIsIGssIHY7CgogICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgIGtzdHIgPSB4LnN1YnN0cigwLCBpZHgpOwogICAgICB2c3RyID0geC5zdWJzdHIoaWR4ICsgMSk7CiAgICB9IGVsc2UgewogICAgICBrc3RyID0geDsKICAgICAgdnN0ciA9ICcnOwogICAgfQoKICAgIGsgPSBkZWNvZGVVUklDb21wb25lbnQoa3N0cik7CiAgICB2ID0gZGVjb2RlVVJJQ29tcG9uZW50KHZzdHIpOwoKICAgIGlmICghaGFzT3duUHJvcGVydHkob2JqLCBrKSkgewogICAgICBvYmpba10gPSB2OwogICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG9ialtrXSkpIHsKICAgICAgb2JqW2tdLnB1c2godik7CiAgICB9IGVsc2UgewogICAgICBvYmpba10gPSBbb2JqW2tdLCB2XTsKICAgIH0KICB9CgogIHJldHVybiBvYmo7Cn07Cgp9LHt9XSw5NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCid1c2Ugc3RyaWN0JzsKCnZhciBzdHJpbmdpZnlQcmltaXRpdmUgPSBmdW5jdGlvbih2KSB7CiAgc3dpdGNoICh0eXBlb2YgdikgewogICAgY2FzZSAnc3RyaW5nJzoKICAgICAgcmV0dXJuIHY7CgogICAgY2FzZSAnYm9vbGVhbic6CiAgICAgIHJldHVybiB2ID8gJ3RydWUnIDogJ2ZhbHNlJzsKCiAgICBjYXNlICdudW1iZXInOgogICAgICByZXR1cm4gaXNGaW5pdGUodikgPyB2IDogJyc7CgogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuICcnOwogIH0KfTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgc2VwID0gc2VwIHx8ICcmJzsKICBlcSA9IGVxIHx8ICc9JzsKICBpZiAob2JqID09PSBudWxsKSB7CiAgICBvYmogPSB1bmRlZmluZWQ7CiAgfQoKICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLm1hcChmdW5jdGlvbihrKSB7CiAgICAgIHZhciBrcyA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUoaykpICsgZXE7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KG9ialtrXSkpIHsKICAgICAgICByZXR1cm4gb2JqW2tdLm1hcChmdW5jdGlvbih2KSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICB9KS5qb2luKHNlcCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgfQogICAgfSkuam9pbihzZXApOwoKICB9CgogIGlmICghbmFtZSkgcmV0dXJuICcnOwogIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG5hbWUpKSArIGVxICsKICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKfTsKCn0se31dLDk2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKYXJndW1lbnRzWzRdWzkzXVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKfSx7Ii4vZGVjb2RlIjo5NCwiLi9lbmNvZGUiOjk1LCJkdXAiOjkzfV0sOTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHNldEltbWVkaWF0ZSxjbGVhckltbWVkaWF0ZSl7KGZ1bmN0aW9uICgpewp2YXIgbmV4dFRpY2sgPSByZXF1aXJlKCdwcm9jZXNzL2Jyb3dzZXIuanMnKS5uZXh0VGljazsKdmFyIGFwcGx5ID0gRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5Owp2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CnZhciBpbW1lZGlhdGVJZHMgPSB7fTsKdmFyIG5leHRJbW1lZGlhdGVJZCA9IDA7CgovLyBET00gQVBJcywgZm9yIGNvbXBsZXRlbmVzcwoKZXhwb3J0cy5zZXRUaW1lb3V0ID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0VGltZW91dCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhclRpbWVvdXQpOwp9OwpleHBvcnRzLnNldEludGVydmFsID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0SW50ZXJ2YWwsIHdpbmRvdywgYXJndW1lbnRzKSwgY2xlYXJJbnRlcnZhbCk7Cn07CmV4cG9ydHMuY2xlYXJUaW1lb3V0ID0KZXhwb3J0cy5jbGVhckludGVydmFsID0gZnVuY3Rpb24odGltZW91dCkgeyB0aW1lb3V0LmNsb3NlKCk7IH07CgpmdW5jdGlvbiBUaW1lb3V0KGlkLCBjbGVhckZuKSB7CiAgdGhpcy5faWQgPSBpZDsKICB0aGlzLl9jbGVhckZuID0gY2xlYXJGbjsKfQpUaW1lb3V0LnByb3RvdHlwZS51bnJlZiA9IFRpbWVvdXQucHJvdG90eXBlLnJlZiA9IGZ1bmN0aW9uKCkge307ClRpbWVvdXQucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5fY2xlYXJGbi5jYWxsKHdpbmRvdywgdGhpcy5faWQpOwp9OwoKLy8gRG9lcyBub3Qgc3RhcnQgdGhlIHRpbWUsIGp1c3Qgc2V0cyB1cCB0aGUgbWVtYmVycyBuZWVkZWQuCmV4cG9ydHMuZW5yb2xsID0gZnVuY3Rpb24oaXRlbSwgbXNlY3MpIHsKICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgaXRlbS5faWRsZVRpbWVvdXQgPSBtc2VjczsKfTsKCmV4cG9ydHMudW5lbnJvbGwgPSBmdW5jdGlvbihpdGVtKSB7CiAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogIGl0ZW0uX2lkbGVUaW1lb3V0ID0gLTE7Cn07CgpleHBvcnRzLl91bnJlZkFjdGl2ZSA9IGV4cG9ydHMuYWN0aXZlID0gZnVuY3Rpb24oaXRlbSkgewogIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKCiAgdmFyIG1zZWNzID0gaXRlbS5faWRsZVRpbWVvdXQ7CiAgaWYgKG1zZWNzID49IDApIHsKICAgIGl0ZW0uX2lkbGVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uIG9uVGltZW91dCgpIHsKICAgICAgaWYgKGl0ZW0uX29uVGltZW91dCkKICAgICAgICBpdGVtLl9vblRpbWVvdXQoKTsKICAgIH0sIG1zZWNzKTsKICB9Cn07CgovLyBUaGF0J3Mgbm90IGhvdyBub2RlLmpzIGltcGxlbWVudHMgaXQgYnV0IHRoZSBleHBvc2VkIGFwaSBpcyB0aGUgc2FtZS4KZXhwb3J0cy5zZXRJbW1lZGlhdGUgPSB0eXBlb2Ygc2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iID8gc2V0SW1tZWRpYXRlIDogZnVuY3Rpb24oZm4pIHsKICB2YXIgaWQgPSBuZXh0SW1tZWRpYXRlSWQrKzsKICB2YXIgYXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPCAyID8gZmFsc2UgOiBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgogIGltbWVkaWF0ZUlkc1tpZF0gPSB0cnVlOwoKICBuZXh0VGljayhmdW5jdGlvbiBvbk5leHRUaWNrKCkgewogICAgaWYgKGltbWVkaWF0ZUlkc1tpZF0pIHsKICAgICAgLy8gZm4uY2FsbCgpIGlzIGZhc3RlciBzbyB3ZSBvcHRpbWl6ZSBmb3IgdGhlIGNvbW1vbiB1c2UtY2FzZQogICAgICAvLyBAc2VlIGh0dHA6Ly9qc3BlcmYuY29tL2NhbGwtYXBwbHktc2VndQogICAgICBpZiAoYXJncykgewogICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICB9IGVsc2UgewogICAgICAgIGZuLmNhbGwobnVsbCk7CiAgICAgIH0KICAgICAgLy8gUHJldmVudCBpZHMgZnJvbSBsZWFraW5nCiAgICAgIGV4cG9ydHMuY2xlYXJJbW1lZGlhdGUoaWQpOwogICAgfQogIH0pOwoKICByZXR1cm4gaWQ7Cn07CgpleHBvcnRzLmNsZWFySW1tZWRpYXRlID0gdHlwZW9mIGNsZWFySW1tZWRpYXRlID09PSAiZnVuY3Rpb24iID8gY2xlYXJJbW1lZGlhdGUgOiBmdW5jdGlvbihpZCkgewogIGRlbGV0ZSBpbW1lZGlhdGVJZHNbaWRdOwp9Owp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoInRpbWVycyIpLnNldEltbWVkaWF0ZSxyZXF1aXJlKCJ0aW1lcnMiKS5jbGVhckltbWVkaWF0ZSkKfSx7InByb2Nlc3MvYnJvd3Nlci5qcyI6ODksInRpbWVycyI6OTd9XSw5ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCnZhciBwdW55Y29kZSA9IHJlcXVpcmUoJ3B1bnljb2RlJyk7CgpleHBvcnRzLnBhcnNlID0gdXJsUGFyc2U7CmV4cG9ydHMucmVzb2x2ZSA9IHVybFJlc29sdmU7CmV4cG9ydHMucmVzb2x2ZU9iamVjdCA9IHVybFJlc29sdmVPYmplY3Q7CmV4cG9ydHMuZm9ybWF0ID0gdXJsRm9ybWF0OwoKZXhwb3J0cy5VcmwgPSBVcmw7CgpmdW5jdGlvbiBVcmwoKSB7CiAgdGhpcy5wcm90b2NvbCA9IG51bGw7CiAgdGhpcy5zbGFzaGVzID0gbnVsbDsKICB0aGlzLmF1dGggPSBudWxsOwogIHRoaXMuaG9zdCA9IG51bGw7CiAgdGhpcy5wb3J0ID0gbnVsbDsKICB0aGlzLmhvc3RuYW1lID0gbnVsbDsKICB0aGlzLmhhc2ggPSBudWxsOwogIHRoaXMuc2VhcmNoID0gbnVsbDsKICB0aGlzLnF1ZXJ5ID0gbnVsbDsKICB0aGlzLnBhdGhuYW1lID0gbnVsbDsKICB0aGlzLnBhdGggPSBudWxsOwogIHRoaXMuaHJlZiA9IG51bGw7Cn0KCi8vIFJlZmVyZW5jZTogUkZDIDM5ODYsIFJGQyAxODA4LCBSRkMgMjM5NgoKLy8gZGVmaW5lIHRoZXNlIGhlcmUgc28gYXQgbGVhc3QgdGhleSBvbmx5IGhhdmUgdG8gYmUKLy8gY29tcGlsZWQgb25jZSBvbiB0aGUgZmlyc3QgbW9kdWxlIGxvYWQuCnZhciBwcm90b2NvbFBhdHRlcm4gPSAvXihbYS16MC05ListXSs6KS9pLAogICAgcG9ydFBhdHRlcm4gPSAvOlswLTldKiQvLAoKICAgIC8vIFJGQyAyMzk2OiBjaGFyYWN0ZXJzIHJlc2VydmVkIGZvciBkZWxpbWl0aW5nIFVSTHMuCiAgICAvLyBXZSBhY3R1YWxseSBqdXN0IGF1dG8tZXNjYXBlIHRoZXNlLgogICAgZGVsaW1zID0gWyc8JywgJz4nLCAnIicsICdgJywgJyAnLCAnXHInLCAnXG4nLCAnXHQnXSwKCiAgICAvLyBSRkMgMjM5NjogY2hhcmFjdGVycyBub3QgYWxsb3dlZCBmb3IgdmFyaW91cyByZWFzb25zLgogICAgdW53aXNlID0gWyd7JywgJ30nLCAnfCcsICdcXCcsICdeJywgJ2AnXS5jb25jYXQoZGVsaW1zKSwKCiAgICAvLyBBbGxvd2VkIGJ5IFJGQ3MsIGJ1dCBjYXVzZSBvZiBYU1MgYXR0YWNrcy4gIEFsd2F5cyBlc2NhcGUgdGhlc2UuCiAgICBhdXRvRXNjYXBlID0gWydcJyddLmNvbmNhdCh1bndpc2UpLAogICAgLy8gQ2hhcmFjdGVycyB0aGF0IGFyZSBuZXZlciBldmVyIGFsbG93ZWQgaW4gYSBob3N0bmFtZS4KICAgIC8vIE5vdGUgdGhhdCBhbnkgaW52YWxpZCBjaGFycyBhcmUgYWxzbyBoYW5kbGVkLCBidXQgdGhlc2UKICAgIC8vIGFyZSB0aGUgb25lcyB0aGF0IGFyZSAqZXhwZWN0ZWQqIHRvIGJlIHNlZW4sIHNvIHdlIGZhc3QtcGF0aAogICAgLy8gdGhlbS4KICAgIG5vbkhvc3RDaGFycyA9IFsnJScsICcvJywgJz8nLCAnOycsICcjJ10uY29uY2F0KGF1dG9Fc2NhcGUpLAogICAgaG9zdEVuZGluZ0NoYXJzID0gWycvJywgJz8nLCAnIyddLAogICAgaG9zdG5hbWVNYXhMZW4gPSAyNTUsCiAgICBob3N0bmFtZVBhcnRQYXR0ZXJuID0gL15bYS16MC05QS1aXy1dezAsNjN9JC8sCiAgICBob3N0bmFtZVBhcnRTdGFydCA9IC9eKFthLXowLTlBLVpfLV17MCw2M30pKC4qKSQvLAogICAgLy8gcHJvdG9jb2xzIHRoYXQgY2FuIGFsbG93ICJ1bnNhZmUiIGFuZCAidW53aXNlIiBjaGFycy4KICAgIHVuc2FmZVByb3RvY29sID0gewogICAgICAnamF2YXNjcmlwdCc6IHRydWUsCiAgICAgICdqYXZhc2NyaXB0Oic6IHRydWUKICAgIH0sCiAgICAvLyBwcm90b2NvbHMgdGhhdCBuZXZlciBoYXZlIGEgaG9zdG5hbWUuCiAgICBob3N0bGVzc1Byb3RvY29sID0gewogICAgICAnamF2YXNjcmlwdCc6IHRydWUsCiAgICAgICdqYXZhc2NyaXB0Oic6IHRydWUKICAgIH0sCiAgICAvLyBwcm90b2NvbHMgdGhhdCBhbHdheXMgY29udGFpbiBhIC8vIGJpdC4KICAgIHNsYXNoZWRQcm90b2NvbCA9IHsKICAgICAgJ2h0dHAnOiB0cnVlLAogICAgICAnaHR0cHMnOiB0cnVlLAogICAgICAnZnRwJzogdHJ1ZSwKICAgICAgJ2dvcGhlcic6IHRydWUsCiAgICAgICdmaWxlJzogdHJ1ZSwKICAgICAgJ2h0dHA6JzogdHJ1ZSwKICAgICAgJ2h0dHBzOic6IHRydWUsCiAgICAgICdmdHA6JzogdHJ1ZSwKICAgICAgJ2dvcGhlcjonOiB0cnVlLAogICAgICAnZmlsZTonOiB0cnVlCiAgICB9LAogICAgcXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZycpOwoKZnVuY3Rpb24gdXJsUGFyc2UodXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCkgewogIGlmICh1cmwgJiYgaXNPYmplY3QodXJsKSAmJiB1cmwgaW5zdGFuY2VvZiBVcmwpIHJldHVybiB1cmw7CgogIHZhciB1ID0gbmV3IFVybDsKICB1LnBhcnNlKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpOwogIHJldHVybiB1Owp9CgpVcmwucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24odXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCkgewogIGlmICghaXNTdHJpbmcodXJsKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiUGFyYW1ldGVyICd1cmwnIG11c3QgYmUgYSBzdHJpbmcsIG5vdCAiICsgdHlwZW9mIHVybCk7CiAgfQoKICB2YXIgcmVzdCA9IHVybDsKCiAgLy8gdHJpbSBiZWZvcmUgcHJvY2VlZGluZy4KICAvLyBUaGlzIGlzIHRvIHN1cHBvcnQgcGFyc2Ugc3R1ZmYgbGlrZSAiICBodHRwOi8vZm9vLmNvbSAgXG4iCiAgcmVzdCA9IHJlc3QudHJpbSgpOwoKICB2YXIgcHJvdG8gPSBwcm90b2NvbFBhdHRlcm4uZXhlYyhyZXN0KTsKICBpZiAocHJvdG8pIHsKICAgIHByb3RvID0gcHJvdG9bMF07CiAgICB2YXIgbG93ZXJQcm90byA9IHByb3RvLnRvTG93ZXJDYXNlKCk7CiAgICB0aGlzLnByb3RvY29sID0gbG93ZXJQcm90bzsKICAgIHJlc3QgPSByZXN0LnN1YnN0cihwcm90by5sZW5ndGgpOwogIH0KCiAgLy8gZmlndXJlIG91dCBpZiBpdCdzIGdvdCBhIGhvc3QKICAvLyB1c2VyQHNlcnZlciBpcyAqYWx3YXlzKiBpbnRlcnByZXRlZCBhcyBhIGhvc3RuYW1lLCBhbmQgdXJsCiAgLy8gcmVzb2x1dGlvbiB3aWxsIHRyZWF0IC8vZm9vL2JhciBhcyBob3N0PWZvbyxwYXRoPWJhciBiZWNhdXNlIHRoYXQncwogIC8vIGhvdyB0aGUgYnJvd3NlciByZXNvbHZlcyByZWxhdGl2ZSBVUkxzLgogIGlmIChzbGFzaGVzRGVub3RlSG9zdCB8fCBwcm90byB8fCByZXN0Lm1hdGNoKC9eXC9cL1teQFwvXStAW15AXC9dKy8pKSB7CiAgICB2YXIgc2xhc2hlcyA9IHJlc3Quc3Vic3RyKDAsIDIpID09PSAnLy8nOwogICAgaWYgKHNsYXNoZXMgJiYgIShwcm90byAmJiBob3N0bGVzc1Byb3RvY29sW3Byb3RvXSkpIHsKICAgICAgcmVzdCA9IHJlc3Quc3Vic3RyKDIpOwogICAgICB0aGlzLnNsYXNoZXMgPSB0cnVlOwogICAgfQogIH0KCiAgaWYgKCFob3N0bGVzc1Byb3RvY29sW3Byb3RvXSAmJgogICAgICAoc2xhc2hlcyB8fCAocHJvdG8gJiYgIXNsYXNoZWRQcm90b2NvbFtwcm90b10pKSkgewoKICAgIC8vIHRoZXJlJ3MgYSBob3N0bmFtZS4KICAgIC8vIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiAvLCA/LCA7LCBvciAjIGVuZHMgdGhlIGhvc3QuCiAgICAvLwogICAgLy8gSWYgdGhlcmUgaXMgYW4gQCBpbiB0aGUgaG9zdG5hbWUsIHRoZW4gbm9uLWhvc3QgY2hhcnMgKmFyZSogYWxsb3dlZAogICAgLy8gdG8gdGhlIGxlZnQgb2YgdGhlIGxhc3QgQCBzaWduLCB1bmxlc3Mgc29tZSBob3N0LWVuZGluZyBjaGFyYWN0ZXIKICAgIC8vIGNvbWVzICpiZWZvcmUqIHRoZSBALXNpZ24uCiAgICAvLyBVUkxzIGFyZSBvYm5veGlvdXMuCiAgICAvLwogICAgLy8gZXg6CiAgICAvLyBodHRwOi8vYUBiQGMvID0+IHVzZXI6YUBiIGhvc3Q6YwogICAgLy8gaHR0cDovL2FAYj9AYyA9PiB1c2VyOmEgaG9zdDpjIHBhdGg6Lz9AYwoKICAgIC8vIHYwLjEyIFRPRE8oaXNhYWNzKTogVGhpcyBpcyBub3QgcXVpdGUgaG93IENocm9tZSBkb2VzIHRoaW5ncy4KICAgIC8vIFJldmlldyBvdXIgdGVzdCBjYXNlIGFnYWluc3QgYnJvd3NlcnMgbW9yZSBjb21wcmVoZW5zaXZlbHkuCgogICAgLy8gZmluZCB0aGUgZmlyc3QgaW5zdGFuY2Ugb2YgYW55IGhvc3RFbmRpbmdDaGFycwogICAgdmFyIGhvc3RFbmQgPSAtMTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaG9zdEVuZGluZ0NoYXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBoZWMgPSByZXN0LmluZGV4T2YoaG9zdEVuZGluZ0NoYXJzW2ldKTsKICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgIGhvc3RFbmQgPSBoZWM7CiAgICB9CgogICAgLy8gYXQgdGhpcyBwb2ludCwgZWl0aGVyIHdlIGhhdmUgYW4gZXhwbGljaXQgcG9pbnQgd2hlcmUgdGhlCiAgICAvLyBhdXRoIHBvcnRpb24gY2Fubm90IGdvIHBhc3QsIG9yIHRoZSBsYXN0IEAgY2hhciBpcyB0aGUgZGVjaWRlci4KICAgIHZhciBhdXRoLCBhdFNpZ247CiAgICBpZiAoaG9zdEVuZCA9PT0gLTEpIHsKICAgICAgLy8gYXRTaWduIGNhbiBiZSBhbnl3aGVyZS4KICAgICAgYXRTaWduID0gcmVzdC5sYXN0SW5kZXhPZignQCcpOwogICAgfSBlbHNlIHsKICAgICAgLy8gYXRTaWduIG11c3QgYmUgaW4gYXV0aCBwb3J0aW9uLgogICAgICAvLyBodHRwOi8vYUBiL2NAZCA9PiBob3N0OmIgYXV0aDphIHBhdGg6L2NAZAogICAgICBhdFNpZ24gPSByZXN0Lmxhc3RJbmRleE9mKCdAJywgaG9zdEVuZCk7CiAgICB9CgogICAgLy8gTm93IHdlIGhhdmUgYSBwb3J0aW9uIHdoaWNoIGlzIGRlZmluaXRlbHkgdGhlIGF1dGguCiAgICAvLyBQdWxsIHRoYXQgb2ZmLgogICAgaWYgKGF0U2lnbiAhPT0gLTEpIHsKICAgICAgYXV0aCA9IHJlc3Quc2xpY2UoMCwgYXRTaWduKTsKICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoYXRTaWduICsgMSk7CiAgICAgIHRoaXMuYXV0aCA9IGRlY29kZVVSSUNvbXBvbmVudChhdXRoKTsKICAgIH0KCiAgICAvLyB0aGUgaG9zdCBpcyB0aGUgcmVtYWluaW5nIHRvIHRoZSBsZWZ0IG9mIHRoZSBmaXJzdCBub24taG9zdCBjaGFyCiAgICBob3N0RW5kID0gLTE7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vbkhvc3RDaGFycy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgaGVjID0gcmVzdC5pbmRleE9mKG5vbkhvc3RDaGFyc1tpXSk7CiAgICAgIGlmIChoZWMgIT09IC0xICYmIChob3N0RW5kID09PSAtMSB8fCBoZWMgPCBob3N0RW5kKSkKICAgICAgICBob3N0RW5kID0gaGVjOwogICAgfQogICAgLy8gaWYgd2Ugc3RpbGwgaGF2ZSBub3QgaGl0IGl0LCB0aGVuIHRoZSBlbnRpcmUgdGhpbmcgaXMgYSBob3N0LgogICAgaWYgKGhvc3RFbmQgPT09IC0xKQogICAgICBob3N0RW5kID0gcmVzdC5sZW5ndGg7CgogICAgdGhpcy5ob3N0ID0gcmVzdC5zbGljZSgwLCBob3N0RW5kKTsKICAgIHJlc3QgPSByZXN0LnNsaWNlKGhvc3RFbmQpOwoKICAgIC8vIHB1bGwgb3V0IHBvcnQuCiAgICB0aGlzLnBhcnNlSG9zdCgpOwoKICAgIC8vIHdlJ3ZlIGluZGljYXRlZCB0aGF0IHRoZXJlIGlzIGEgaG9zdG5hbWUsCiAgICAvLyBzbyBldmVuIGlmIGl0J3MgZW1wdHksIGl0IGhhcyB0byBiZSBwcmVzZW50LgogICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUgfHwgJyc7CgogICAgLy8gaWYgaG9zdG5hbWUgYmVnaW5zIHdpdGggWyBhbmQgZW5kcyB3aXRoIF0KICAgIC8vIGFzc3VtZSB0aGF0IGl0J3MgYW4gSVB2NiBhZGRyZXNzLgogICAgdmFyIGlwdjZIb3N0bmFtZSA9IHRoaXMuaG9zdG5hbWVbMF0gPT09ICdbJyAmJgogICAgICAgIHRoaXMuaG9zdG5hbWVbdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAxXSA9PT0gJ10nOwoKICAgIC8vIHZhbGlkYXRlIGEgbGl0dGxlLgogICAgaWYgKCFpcHY2SG9zdG5hbWUpIHsKICAgICAgdmFyIGhvc3RwYXJ0cyA9IHRoaXMuaG9zdG5hbWUuc3BsaXQoL1wuLyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaG9zdHBhcnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHZhciBwYXJ0ID0gaG9zdHBhcnRzW2ldOwogICAgICAgIGlmICghcGFydCkgY29udGludWU7CiAgICAgICAgaWYgKCFwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFBhdHRlcm4pKSB7CiAgICAgICAgICB2YXIgbmV3cGFydCA9ICcnOwogICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGsgPSBwYXJ0Lmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICBpZiAocGFydC5jaGFyQ29kZUF0KGopID4gMTI3KSB7CiAgICAgICAgICAgICAgLy8gd2UgcmVwbGFjZSBub24tQVNDSUkgY2hhciB3aXRoIGEgdGVtcG9yYXJ5IHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0aGlzIHRvIG1ha2Ugc3VyZSBzaXplIG9mIGhvc3RuYW1lIGlzIG5vdAogICAgICAgICAgICAgIC8vIGJyb2tlbiBieSByZXBsYWNpbmcgbm9uLUFTQ0lJIGJ5IG5vdGhpbmcKICAgICAgICAgICAgICBuZXdwYXJ0ICs9ICd4JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXdwYXJ0ICs9IHBhcnRbal07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIHdlIHRlc3QgYWdhaW4gd2l0aCBBU0NJSSBjaGFyIG9ubHkKICAgICAgICAgIGlmICghbmV3cGFydC5tYXRjaChob3N0bmFtZVBhcnRQYXR0ZXJuKSkgewogICAgICAgICAgICB2YXIgdmFsaWRQYXJ0cyA9IGhvc3RwYXJ0cy5zbGljZSgwLCBpKTsKICAgICAgICAgICAgdmFyIG5vdEhvc3QgPSBob3N0cGFydHMuc2xpY2UoaSArIDEpOwogICAgICAgICAgICB2YXIgYml0ID0gcGFydC5tYXRjaChob3N0bmFtZVBhcnRTdGFydCk7CiAgICAgICAgICAgIGlmIChiaXQpIHsKICAgICAgICAgICAgICB2YWxpZFBhcnRzLnB1c2goYml0WzFdKTsKICAgICAgICAgICAgICBub3RIb3N0LnVuc2hpZnQoYml0WzJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm90SG9zdC5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXN0ID0gJy8nICsgbm90SG9zdC5qb2luKCcuJykgKyByZXN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaG9zdG5hbWUgPSB2YWxpZFBhcnRzLmpvaW4oJy4nKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMuaG9zdG5hbWUubGVuZ3RoID4gaG9zdG5hbWVNYXhMZW4pIHsKICAgICAgdGhpcy5ob3N0bmFtZSA9ICcnOwogICAgfSBlbHNlIHsKICAgICAgLy8gaG9zdG5hbWVzIGFyZSBhbHdheXMgbG93ZXIgY2FzZS4KICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIH0KCiAgICBpZiAoIWlwdjZIb3N0bmFtZSkgewogICAgICAvLyBJRE5BIFN1cHBvcnQ6IFJldHVybnMgYSBwdW55IGNvZGVkIHJlcHJlc2VudGF0aW9uIG9mICJkb21haW4iLgogICAgICAvLyBJdCBvbmx5IGNvbnZlcnRzIHRoZSBwYXJ0IG9mIHRoZSBkb21haW4gbmFtZSB0aGF0CiAgICAgIC8vIGhhcyBub24gQVNDSUkgY2hhcmFjdGVycy4gSS5lLiBpdCBkb3NlbnQgbWF0dGVyIGlmCiAgICAgIC8vIHlvdSBjYWxsIGl0IHdpdGggYSBkb21haW4gdGhhdCBhbHJlYWR5IGlzIGluIEFTQ0lJLgogICAgICB2YXIgZG9tYWluQXJyYXkgPSB0aGlzLmhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAgIHZhciBuZXdPdXQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb21haW5BcnJheS5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBzID0gZG9tYWluQXJyYXlbaV07CiAgICAgICAgbmV3T3V0LnB1c2gocy5tYXRjaCgvW15BLVphLXowLTlfLV0vKSA/CiAgICAgICAgICAgICd4bi0tJyArIHB1bnljb2RlLmVuY29kZShzKSA6IHMpOwogICAgICB9CiAgICAgIHRoaXMuaG9zdG5hbWUgPSBuZXdPdXQuam9pbignLicpOwogICAgfQoKICAgIHZhciBwID0gdGhpcy5wb3J0ID8gJzonICsgdGhpcy5wb3J0IDogJyc7CiAgICB2YXIgaCA9IHRoaXMuaG9zdG5hbWUgfHwgJyc7CiAgICB0aGlzLmhvc3QgPSBoICsgcDsKICAgIHRoaXMuaHJlZiArPSB0aGlzLmhvc3Q7CgogICAgLy8gc3RyaXAgWyBhbmQgXSBmcm9tIHRoZSBob3N0bmFtZQogICAgLy8gdGhlIGhvc3QgZmllbGQgc3RpbGwgcmV0YWlucyB0aGVtLCB0aG91Z2gKICAgIGlmIChpcHY2SG9zdG5hbWUpIHsKICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUuc3Vic3RyKDEsIHRoaXMuaG9zdG5hbWUubGVuZ3RoIC0gMik7CiAgICAgIGlmIChyZXN0WzBdICE9PSAnLycpIHsKICAgICAgICByZXN0ID0gJy8nICsgcmVzdDsKICAgICAgfQogICAgfQogIH0KCiAgLy8gbm93IHJlc3QgaXMgc2V0IHRvIHRoZSBwb3N0LWhvc3Qgc3R1ZmYuCiAgLy8gY2hvcCBvZmYgYW55IGRlbGltIGNoYXJzLgogIGlmICghdW5zYWZlUHJvdG9jb2xbbG93ZXJQcm90b10pIHsKCiAgICAvLyBGaXJzdCwgbWFrZSAxMDAlIHN1cmUgdGhhdCBhbnkgImF1dG9Fc2NhcGUiIGNoYXJzIGdldAogICAgLy8gZXNjYXBlZCwgZXZlbiBpZiBlbmNvZGVVUklDb21wb25lbnQgZG9lc24ndCB0aGluayB0aGV5CiAgICAvLyBuZWVkIHRvIGJlLgogICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhdXRvRXNjYXBlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgYWUgPSBhdXRvRXNjYXBlW2ldOwogICAgICB2YXIgZXNjID0gZW5jb2RlVVJJQ29tcG9uZW50KGFlKTsKICAgICAgaWYgKGVzYyA9PT0gYWUpIHsKICAgICAgICBlc2MgPSBlc2NhcGUoYWUpOwogICAgICB9CiAgICAgIHJlc3QgPSByZXN0LnNwbGl0KGFlKS5qb2luKGVzYyk7CiAgICB9CiAgfQoKCiAgLy8gY2hvcCBvZmYgZnJvbSB0aGUgdGFpbCBmaXJzdC4KICB2YXIgaGFzaCA9IHJlc3QuaW5kZXhPZignIycpOwogIGlmIChoYXNoICE9PSAtMSkgewogICAgLy8gZ290IGEgZnJhZ21lbnQgc3RyaW5nLgogICAgdGhpcy5oYXNoID0gcmVzdC5zdWJzdHIoaGFzaCk7CiAgICByZXN0ID0gcmVzdC5zbGljZSgwLCBoYXNoKTsKICB9CiAgdmFyIHFtID0gcmVzdC5pbmRleE9mKCc/Jyk7CiAgaWYgKHFtICE9PSAtMSkgewogICAgdGhpcy5zZWFyY2ggPSByZXN0LnN1YnN0cihxbSk7CiAgICB0aGlzLnF1ZXJ5ID0gcmVzdC5zdWJzdHIocW0gKyAxKTsKICAgIGlmIChwYXJzZVF1ZXJ5U3RyaW5nKSB7CiAgICAgIHRoaXMucXVlcnkgPSBxdWVyeXN0cmluZy5wYXJzZSh0aGlzLnF1ZXJ5KTsKICAgIH0KICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIHFtKTsKICB9IGVsc2UgaWYgKHBhcnNlUXVlcnlTdHJpbmcpIHsKICAgIC8vIG5vIHF1ZXJ5IHN0cmluZywgYnV0IHBhcnNlUXVlcnlTdHJpbmcgc3RpbGwgcmVxdWVzdGVkCiAgICB0aGlzLnNlYXJjaCA9ICcnOwogICAgdGhpcy5xdWVyeSA9IHt9OwogIH0KICBpZiAocmVzdCkgdGhpcy5wYXRobmFtZSA9IHJlc3Q7CiAgaWYgKHNsYXNoZWRQcm90b2NvbFtsb3dlclByb3RvXSAmJgogICAgICB0aGlzLmhvc3RuYW1lICYmICF0aGlzLnBhdGhuYW1lKSB7CiAgICB0aGlzLnBhdGhuYW1lID0gJy8nOwogIH0KCiAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogIGlmICh0aGlzLnBhdGhuYW1lIHx8IHRoaXMuc2VhcmNoKSB7CiAgICB2YXIgcCA9IHRoaXMucGF0aG5hbWUgfHwgJyc7CiAgICB2YXIgcyA9IHRoaXMuc2VhcmNoIHx8ICcnOwogICAgdGhpcy5wYXRoID0gcCArIHM7CiAgfQoKICAvLyBmaW5hbGx5LCByZWNvbnN0cnVjdCB0aGUgaHJlZiBiYXNlZCBvbiB3aGF0IGhhcyBiZWVuIHZhbGlkYXRlZC4KICB0aGlzLmhyZWYgPSB0aGlzLmZvcm1hdCgpOwogIHJldHVybiB0aGlzOwp9OwoKLy8gZm9ybWF0IGEgcGFyc2VkIG9iamVjdCBpbnRvIGEgdXJsIHN0cmluZwpmdW5jdGlvbiB1cmxGb3JtYXQob2JqKSB7CiAgLy8gZW5zdXJlIGl0J3MgYW4gb2JqZWN0LCBhbmQgbm90IGEgc3RyaW5nIHVybC4KICAvLyBJZiBpdCdzIGFuIG9iaiwgdGhpcyBpcyBhIG5vLW9wLgogIC8vIHRoaXMgd2F5LCB5b3UgY2FuIGNhbGwgdXJsX2Zvcm1hdCgpIG9uIHN0cmluZ3MKICAvLyB0byBjbGVhbiB1cCBwb3RlbnRpYWxseSB3b25reSB1cmxzLgogIGlmIChpc1N0cmluZyhvYmopKSBvYmogPSB1cmxQYXJzZShvYmopOwogIGlmICghKG9iaiBpbnN0YW5jZW9mIFVybCkpIHJldHVybiBVcmwucHJvdG90eXBlLmZvcm1hdC5jYWxsKG9iaik7CiAgcmV0dXJuIG9iai5mb3JtYXQoKTsKfQoKVXJsLnByb3RvdHlwZS5mb3JtYXQgPSBmdW5jdGlvbigpIHsKICB2YXIgYXV0aCA9IHRoaXMuYXV0aCB8fCAnJzsKICBpZiAoYXV0aCkgewogICAgYXV0aCA9IGVuY29kZVVSSUNvbXBvbmVudChhdXRoKTsKICAgIGF1dGggPSBhdXRoLnJlcGxhY2UoLyUzQS9pLCAnOicpOwogICAgYXV0aCArPSAnQCc7CiAgfQoKICB2YXIgcHJvdG9jb2wgPSB0aGlzLnByb3RvY29sIHx8ICcnLAogICAgICBwYXRobmFtZSA9IHRoaXMucGF0aG5hbWUgfHwgJycsCiAgICAgIGhhc2ggPSB0aGlzLmhhc2ggfHwgJycsCiAgICAgIGhvc3QgPSBmYWxzZSwKICAgICAgcXVlcnkgPSAnJzsKCiAgaWYgKHRoaXMuaG9zdCkgewogICAgaG9zdCA9IGF1dGggKyB0aGlzLmhvc3Q7CiAgfSBlbHNlIGlmICh0aGlzLmhvc3RuYW1lKSB7CiAgICBob3N0ID0gYXV0aCArICh0aGlzLmhvc3RuYW1lLmluZGV4T2YoJzonKSA9PT0gLTEgPwogICAgICAgIHRoaXMuaG9zdG5hbWUgOgogICAgICAgICdbJyArIHRoaXMuaG9zdG5hbWUgKyAnXScpOwogICAgaWYgKHRoaXMucG9ydCkgewogICAgICBob3N0ICs9ICc6JyArIHRoaXMucG9ydDsKICAgIH0KICB9CgogIGlmICh0aGlzLnF1ZXJ5ICYmCiAgICAgIGlzT2JqZWN0KHRoaXMucXVlcnkpICYmCiAgICAgIE9iamVjdC5rZXlzKHRoaXMucXVlcnkpLmxlbmd0aCkgewogICAgcXVlcnkgPSBxdWVyeXN0cmluZy5zdHJpbmdpZnkodGhpcy5xdWVyeSk7CiAgfQoKICB2YXIgc2VhcmNoID0gdGhpcy5zZWFyY2ggfHwgKHF1ZXJ5ICYmICgnPycgKyBxdWVyeSkpIHx8ICcnOwoKICBpZiAocHJvdG9jb2wgJiYgcHJvdG9jb2wuc3Vic3RyKC0xKSAhPT0gJzonKSBwcm90b2NvbCArPSAnOic7CgogIC8vIG9ubHkgdGhlIHNsYXNoZWRQcm90b2NvbHMgZ2V0IHRoZSAvLy4gIE5vdCBtYWlsdG86LCB4bXBwOiwgZXRjLgogIC8vIHVubGVzcyB0aGV5IGhhZCB0aGVtIHRvIGJlZ2luIHdpdGguCiAgaWYgKHRoaXMuc2xhc2hlcyB8fAogICAgICAoIXByb3RvY29sIHx8IHNsYXNoZWRQcm90b2NvbFtwcm90b2NvbF0pICYmIGhvc3QgIT09IGZhbHNlKSB7CiAgICBob3N0ID0gJy8vJyArIChob3N0IHx8ICcnKTsKICAgIGlmIChwYXRobmFtZSAmJiBwYXRobmFtZS5jaGFyQXQoMCkgIT09ICcvJykgcGF0aG5hbWUgPSAnLycgKyBwYXRobmFtZTsKICB9IGVsc2UgaWYgKCFob3N0KSB7CiAgICBob3N0ID0gJyc7CiAgfQoKICBpZiAoaGFzaCAmJiBoYXNoLmNoYXJBdCgwKSAhPT0gJyMnKSBoYXNoID0gJyMnICsgaGFzaDsKICBpZiAoc2VhcmNoICYmIHNlYXJjaC5jaGFyQXQoMCkgIT09ICc/Jykgc2VhcmNoID0gJz8nICsgc2VhcmNoOwoKICBwYXRobmFtZSA9IHBhdGhuYW1lLnJlcGxhY2UoL1s/I10vZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQobWF0Y2gpOwogIH0pOwogIHNlYXJjaCA9IHNlYXJjaC5yZXBsYWNlKCcjJywgJyUyMycpOwoKICByZXR1cm4gcHJvdG9jb2wgKyBob3N0ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwp9OwoKZnVuY3Rpb24gdXJsUmVzb2x2ZShzb3VyY2UsIHJlbGF0aXZlKSB7CiAgcmV0dXJuIHVybFBhcnNlKHNvdXJjZSwgZmFsc2UsIHRydWUpLnJlc29sdmUocmVsYXRpdmUpOwp9CgpVcmwucHJvdG90eXBlLnJlc29sdmUgPSBmdW5jdGlvbihyZWxhdGl2ZSkgewogIHJldHVybiB0aGlzLnJlc29sdmVPYmplY3QodXJsUGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKSkuZm9ybWF0KCk7Cn07CgpmdW5jdGlvbiB1cmxSZXNvbHZlT2JqZWN0KHNvdXJjZSwgcmVsYXRpdmUpIHsKICBpZiAoIXNvdXJjZSkgcmV0dXJuIHJlbGF0aXZlOwogIHJldHVybiB1cmxQYXJzZShzb3VyY2UsIGZhbHNlLCB0cnVlKS5yZXNvbHZlT2JqZWN0KHJlbGF0aXZlKTsKfQoKVXJsLnByb3RvdHlwZS5yZXNvbHZlT2JqZWN0ID0gZnVuY3Rpb24ocmVsYXRpdmUpIHsKICBpZiAoaXNTdHJpbmcocmVsYXRpdmUpKSB7CiAgICB2YXIgcmVsID0gbmV3IFVybCgpOwogICAgcmVsLnBhcnNlKHJlbGF0aXZlLCBmYWxzZSwgdHJ1ZSk7CiAgICByZWxhdGl2ZSA9IHJlbDsKICB9CgogIHZhciByZXN1bHQgPSBuZXcgVXJsKCk7CiAgT2JqZWN0LmtleXModGhpcykuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICByZXN1bHRba10gPSB0aGlzW2tdOwogIH0sIHRoaXMpOwoKICAvLyBoYXNoIGlzIGFsd2F5cyBvdmVycmlkZGVuLCBubyBtYXR0ZXIgd2hhdC4KICAvLyBldmVuIGhyZWY9IiIgd2lsbCByZW1vdmUgaXQuCiAgcmVzdWx0Lmhhc2ggPSByZWxhdGl2ZS5oYXNoOwoKICAvLyBpZiB0aGUgcmVsYXRpdmUgdXJsIGlzIGVtcHR5LCB0aGVuIHRoZXJlJ3Mgbm90aGluZyBsZWZ0IHRvIGRvIGhlcmUuCiAgaWYgKHJlbGF0aXZlLmhyZWYgPT09ICcnKSB7CiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvLyBocmVmcyBsaWtlIC8vZm9vL2JhciBhbHdheXMgY3V0IHRvIHRoZSBwcm90b2NvbC4KICBpZiAocmVsYXRpdmUuc2xhc2hlcyAmJiAhcmVsYXRpdmUucHJvdG9jb2wpIHsKICAgIC8vIHRha2UgZXZlcnl0aGluZyBleGNlcHQgdGhlIHByb3RvY29sIGZyb20gcmVsYXRpdmUKICAgIE9iamVjdC5rZXlzKHJlbGF0aXZlKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgaWYgKGsgIT09ICdwcm90b2NvbCcpCiAgICAgICAgcmVzdWx0W2tdID0gcmVsYXRpdmVba107CiAgICB9KTsKCiAgICAvL3VybFBhcnNlIGFwcGVuZHMgdHJhaWxpbmcgLyB0byB1cmxzIGxpa2UgaHR0cDovL3d3dy5leGFtcGxlLmNvbQogICAgaWYgKHNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdICYmCiAgICAgICAgcmVzdWx0Lmhvc3RuYW1lICYmICFyZXN1bHQucGF0aG5hbWUpIHsKICAgICAgcmVzdWx0LnBhdGggPSByZXN1bHQucGF0aG5hbWUgPSAnLyc7CiAgICB9CgogICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgaWYgKHJlbGF0aXZlLnByb3RvY29sICYmIHJlbGF0aXZlLnByb3RvY29sICE9PSByZXN1bHQucHJvdG9jb2wpIHsKICAgIC8vIGlmIGl0J3MgYSBrbm93biB1cmwgcHJvdG9jb2wsIHRoZW4gY2hhbmdpbmcKICAgIC8vIHRoZSBwcm90b2NvbCBkb2VzIHdlaXJkIHRoaW5ncwogICAgLy8gZmlyc3QsIGlmIGl0J3Mgbm90IGZpbGU6LCB0aGVuIHdlIE1VU1QgaGF2ZSBhIGhvc3QsCiAgICAvLyBhbmQgaWYgdGhlcmUgd2FzIGEgcGF0aAogICAgLy8gdG8gYmVnaW4gd2l0aCwgdGhlbiB3ZSBNVVNUIGhhdmUgYSBwYXRoLgogICAgLy8gaWYgaXQgaXMgZmlsZTosIHRoZW4gdGhlIGhvc3QgaXMgZHJvcHBlZCwKICAgIC8vIGJlY2F1c2UgdGhhdCdzIGtub3duIHRvIGJlIGhvc3RsZXNzLgogICAgLy8gYW55dGhpbmcgZWxzZSBpcyBhc3N1bWVkIHRvIGJlIGFic29sdXRlLgogICAgaWYgKCFzbGFzaGVkUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgIE9iamVjdC5rZXlzKHJlbGF0aXZlKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgICByZXN1bHRba10gPSByZWxhdGl2ZVtrXTsKICAgICAgfSk7CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIHJlc3VsdC5wcm90b2NvbCA9IHJlbGF0aXZlLnByb3RvY29sOwogICAgaWYgKCFyZWxhdGl2ZS5ob3N0ICYmICFob3N0bGVzc1Byb3RvY29sW3JlbGF0aXZlLnByb3RvY29sXSkgewogICAgICB2YXIgcmVsUGF0aCA9IChyZWxhdGl2ZS5wYXRobmFtZSB8fCAnJykuc3BsaXQoJy8nKTsKICAgICAgd2hpbGUgKHJlbFBhdGgubGVuZ3RoICYmICEocmVsYXRpdmUuaG9zdCA9IHJlbFBhdGguc2hpZnQoKSkpOwogICAgICBpZiAoIXJlbGF0aXZlLmhvc3QpIHJlbGF0aXZlLmhvc3QgPSAnJzsKICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0bmFtZSkgcmVsYXRpdmUuaG9zdG5hbWUgPSAnJzsKICAgICAgaWYgKHJlbFBhdGhbMF0gIT09ICcnKSByZWxQYXRoLnVuc2hpZnQoJycpOwogICAgICBpZiAocmVsUGF0aC5sZW5ndGggPCAyKSByZWxQYXRoLnVuc2hpZnQoJycpOwogICAgICByZXN1bHQucGF0aG5hbWUgPSByZWxQYXRoLmpvaW4oJy8nKTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbGF0aXZlLnBhdGhuYW1lOwogICAgfQogICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgcmVzdWx0Lmhvc3QgPSByZWxhdGl2ZS5ob3N0IHx8ICcnOwogICAgcmVzdWx0LmF1dGggPSByZWxhdGl2ZS5hdXRoOwogICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdDsKICAgIHJlc3VsdC5wb3J0ID0gcmVsYXRpdmUucG9ydDsKICAgIC8vIHRvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICBpZiAocmVzdWx0LnBhdGhuYW1lIHx8IHJlc3VsdC5zZWFyY2gpIHsKICAgICAgdmFyIHAgPSByZXN1bHQucGF0aG5hbWUgfHwgJyc7CiAgICAgIHZhciBzID0gcmVzdWx0LnNlYXJjaCB8fCAnJzsKICAgICAgcmVzdWx0LnBhdGggPSBwICsgczsKICAgIH0KICAgIHJlc3VsdC5zbGFzaGVzID0gcmVzdWx0LnNsYXNoZXMgfHwgcmVsYXRpdmUuc2xhc2hlczsKICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIHZhciBpc1NvdXJjZUFicyA9IChyZXN1bHQucGF0aG5hbWUgJiYgcmVzdWx0LnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nKSwKICAgICAgaXNSZWxBYnMgPSAoCiAgICAgICAgICByZWxhdGl2ZS5ob3N0IHx8CiAgICAgICAgICByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJwogICAgICApLAogICAgICBtdXN0RW5kQWJzID0gKGlzUmVsQWJzIHx8IGlzU291cmNlQWJzIHx8CiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5ob3N0ICYmIHJlbGF0aXZlLnBhdGhuYW1lKSksCiAgICAgIHJlbW92ZUFsbERvdHMgPSBtdXN0RW5kQWJzLAogICAgICBzcmNQYXRoID0gcmVzdWx0LnBhdGhuYW1lICYmIHJlc3VsdC5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICByZWxQYXRoID0gcmVsYXRpdmUucGF0aG5hbWUgJiYgcmVsYXRpdmUucGF0aG5hbWUuc3BsaXQoJy8nKSB8fCBbXSwKICAgICAgcHN5Y2hvdGljID0gcmVzdWx0LnByb3RvY29sICYmICFzbGFzaGVkUHJvdG9jb2xbcmVzdWx0LnByb3RvY29sXTsKCiAgLy8gaWYgdGhlIHVybCBpcyBhIG5vbi1zbGFzaGVkIHVybCwgdGhlbiByZWxhdGl2ZQogIC8vIGxpbmtzIGxpa2UgLi4vLi4gc2hvdWxkIGJlIGFibGUKICAvLyB0byBjcmF3bCB1cCB0byB0aGUgaG9zdG5hbWUsIGFzIHdlbGwuICBUaGlzIGlzIHN0cmFuZ2UuCiAgLy8gcmVzdWx0LnByb3RvY29sIGhhcyBhbHJlYWR5IGJlZW4gc2V0IGJ5IG5vdy4KICAvLyBMYXRlciBvbiwgcHV0IHRoZSBmaXJzdCBwYXRoIHBhcnQgaW50byB0aGUgaG9zdCBmaWVsZC4KICBpZiAocHN5Y2hvdGljKSB7CiAgICByZXN1bHQuaG9zdG5hbWUgPSAnJzsKICAgIHJlc3VsdC5wb3J0ID0gbnVsbDsKICAgIGlmIChyZXN1bHQuaG9zdCkgewogICAgICBpZiAoc3JjUGF0aFswXSA9PT0gJycpIHNyY1BhdGhbMF0gPSByZXN1bHQuaG9zdDsKICAgICAgZWxzZSBzcmNQYXRoLnVuc2hpZnQocmVzdWx0Lmhvc3QpOwogICAgfQogICAgcmVzdWx0Lmhvc3QgPSAnJzsKICAgIGlmIChyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgICByZWxhdGl2ZS5ob3N0bmFtZSA9IG51bGw7CiAgICAgIHJlbGF0aXZlLnBvcnQgPSBudWxsOwogICAgICBpZiAocmVsYXRpdmUuaG9zdCkgewogICAgICAgIGlmIChyZWxQYXRoWzBdID09PSAnJykgcmVsUGF0aFswXSA9IHJlbGF0aXZlLmhvc3Q7CiAgICAgICAgZWxzZSByZWxQYXRoLnVuc2hpZnQocmVsYXRpdmUuaG9zdCk7CiAgICAgIH0KICAgICAgcmVsYXRpdmUuaG9zdCA9IG51bGw7CiAgICB9CiAgICBtdXN0RW5kQWJzID0gbXVzdEVuZEFicyAmJiAocmVsUGF0aFswXSA9PT0gJycgfHwgc3JjUGF0aFswXSA9PT0gJycpOwogIH0KCiAgaWYgKGlzUmVsQWJzKSB7CiAgICAvLyBpdCdzIGFic29sdXRlLgogICAgcmVzdWx0Lmhvc3QgPSAocmVsYXRpdmUuaG9zdCB8fCByZWxhdGl2ZS5ob3N0ID09PSAnJykgPwogICAgICAgICAgICAgICAgICByZWxhdGl2ZS5ob3N0IDogcmVzdWx0Lmhvc3Q7CiAgICByZXN1bHQuaG9zdG5hbWUgPSAocmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdG5hbWUgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZS5ob3N0bmFtZSA6IHJlc3VsdC5ob3N0bmFtZTsKICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgIHNyY1BhdGggPSByZWxQYXRoOwogICAgLy8gZmFsbCB0aHJvdWdoIHRvIHRoZSBkb3QtaGFuZGxpbmcgYmVsb3cuCiAgfSBlbHNlIGlmIChyZWxQYXRoLmxlbmd0aCkgewogICAgLy8gaXQncyByZWxhdGl2ZQogICAgLy8gdGhyb3cgYXdheSB0aGUgZXhpc3RpbmcgZmlsZSwgYW5kIHRha2UgdGhlIG5ldyBwYXRoIGluc3RlYWQuCiAgICBpZiAoIXNyY1BhdGgpIHNyY1BhdGggPSBbXTsKICAgIHNyY1BhdGgucG9wKCk7CiAgICBzcmNQYXRoID0gc3JjUGF0aC5jb25jYXQocmVsUGF0aCk7CiAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgfSBlbHNlIGlmICghaXNOdWxsT3JVbmRlZmluZWQocmVsYXRpdmUuc2VhcmNoKSkgewogICAgLy8ganVzdCBwdWxsIG91dCB0aGUgc2VhcmNoLgogICAgLy8gbGlrZSBocmVmPSc/Zm9vJy4KICAgIC8vIFB1dCB0aGlzIGFmdGVyIHRoZSBvdGhlciB0d28gY2FzZXMgYmVjYXVzZSBpdCBzaW1wbGlmaWVzIHRoZSBib29sZWFucwogICAgaWYgKHBzeWNob3RpYykgewogICAgICByZXN1bHQuaG9zdG5hbWUgPSByZXN1bHQuaG9zdCA9IHNyY1BhdGguc2hpZnQoKTsKICAgICAgLy9vY2NhdGlvbmFseSB0aGUgYXV0aCBjYW4gZ2V0IHN0dWNrIG9ubHkgaW4gaG9zdAogICAgICAvL3RoaXMgZXNwZWNpYWx5IGhhcHBlbnMgaW4gY2FzZXMgbGlrZQogICAgICAvL3VybC5yZXNvbHZlT2JqZWN0KCdtYWlsdG86bG9jYWwxQGRvbWFpbjEnLCAnbG9jYWwyQGRvbWFpbjInKQogICAgICB2YXIgYXV0aEluSG9zdCA9IHJlc3VsdC5ob3N0ICYmIHJlc3VsdC5ob3N0LmluZGV4T2YoJ0AnKSA+IDAgPwogICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ob3N0LnNwbGl0KCdAJykgOiBmYWxzZTsKICAgICAgaWYgKGF1dGhJbkhvc3QpIHsKICAgICAgICByZXN1bHQuYXV0aCA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICByZXN1bHQuaG9zdCA9IHJlc3VsdC5ob3N0bmFtZSA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgfQogICAgfQogICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgaWYgKCFpc051bGwocmVzdWx0LnBhdGhuYW1lKSB8fCAhaXNOdWxsKHJlc3VsdC5zZWFyY2gpKSB7CiAgICAgIHJlc3VsdC5wYXRoID0gKHJlc3VsdC5wYXRobmFtZSA/IHJlc3VsdC5wYXRobmFtZSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5zZWFyY2ggPyByZXN1bHQuc2VhcmNoIDogJycpOwogICAgfQogICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgaWYgKCFzcmNQYXRoLmxlbmd0aCkgewogICAgLy8gbm8gcGF0aCBhdCBhbGwuICBlYXN5LgogICAgLy8gd2UndmUgYWxyZWFkeSBoYW5kbGVkIHRoZSBvdGhlciBzdHVmZiBhYm92ZS4KICAgIHJlc3VsdC5wYXRobmFtZSA9IG51bGw7CiAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICBpZiAocmVzdWx0LnNlYXJjaCkgewogICAgICByZXN1bHQucGF0aCA9ICcvJyArIHJlc3VsdC5zZWFyY2g7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgICB9CiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvLyBpZiBhIHVybCBFTkRzIGluIC4gb3IgLi4sIHRoZW4gaXQgbXVzdCBnZXQgYSB0cmFpbGluZyBzbGFzaC4KICAvLyBob3dldmVyLCBpZiBpdCBlbmRzIGluIGFueXRoaW5nIGVsc2Ugbm9uLXNsYXNoeSwKICAvLyB0aGVuIGl0IG11c3QgTk9UIGdldCBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciBsYXN0ID0gc3JjUGF0aC5zbGljZSgtMSlbMF07CiAgdmFyIGhhc1RyYWlsaW5nU2xhc2ggPSAoCiAgICAgIChyZXN1bHQuaG9zdCB8fCByZWxhdGl2ZS5ob3N0KSAmJiAobGFzdCA9PT0gJy4nIHx8IGxhc3QgPT09ICcuLicpIHx8CiAgICAgIGxhc3QgPT09ICcnKTsKCiAgLy8gc3RyaXAgc2luZ2xlIGRvdHMsIHJlc29sdmUgZG91YmxlIGRvdHMgdG8gcGFyZW50IGRpcgogIC8vIGlmIHRoZSBwYXRoIHRyaWVzIHRvIGdvIGFib3ZlIHRoZSByb290LCBgdXBgIGVuZHMgdXAgPiAwCiAgdmFyIHVwID0gMDsKICBmb3IgKHZhciBpID0gc3JjUGF0aC5sZW5ndGg7IGkgPj0gMDsgaS0tKSB7CiAgICBsYXN0ID0gc3JjUGF0aFtpXTsKICAgIGlmIChsYXN0ID09ICcuJykgewogICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgIH0gZWxzZSBpZiAobGFzdCA9PT0gJy4uJykgewogICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgdXArKzsKICAgIH0gZWxzZSBpZiAodXApIHsKICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgIHVwLS07CiAgICB9CiAgfQoKICAvLyBpZiB0aGUgcGF0aCBpcyBhbGxvd2VkIHRvIGdvIGFib3ZlIHRoZSByb290LCByZXN0b3JlIGxlYWRpbmcgLi5zCiAgaWYgKCFtdXN0RW5kQWJzICYmICFyZW1vdmVBbGxEb3RzKSB7CiAgICBmb3IgKDsgdXAtLTsgdXApIHsKICAgICAgc3JjUGF0aC51bnNoaWZ0KCcuLicpOwogICAgfQogIH0KCiAgaWYgKG11c3RFbmRBYnMgJiYgc3JjUGF0aFswXSAhPT0gJycgJiYKICAgICAgKCFzcmNQYXRoWzBdIHx8IHNyY1BhdGhbMF0uY2hhckF0KDApICE9PSAnLycpKSB7CiAgICBzcmNQYXRoLnVuc2hpZnQoJycpOwogIH0KCiAgaWYgKGhhc1RyYWlsaW5nU2xhc2ggJiYgKHNyY1BhdGguam9pbignLycpLnN1YnN0cigtMSkgIT09ICcvJykpIHsKICAgIHNyY1BhdGgucHVzaCgnJyk7CiAgfQoKICB2YXIgaXNBYnNvbHV0ZSA9IHNyY1BhdGhbMF0gPT09ICcnIHx8CiAgICAgIChzcmNQYXRoWzBdICYmIHNyY1BhdGhbMF0uY2hhckF0KDApID09PSAnLycpOwoKICAvLyBwdXQgdGhlIGhvc3QgYmFjawogIGlmIChwc3ljaG90aWMpIHsKICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gaXNBYnNvbHV0ZSA/ICcnIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjUGF0aC5sZW5ndGggPyBzcmNQYXRoLnNoaWZ0KCkgOiAnJzsKICAgIC8vb2NjYXRpb25hbHkgdGhlIGF1dGggY2FuIGdldCBzdHVjayBvbmx5IGluIGhvc3QKICAgIC8vdGhpcyBlc3BlY2lhbHkgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAvL3VybC5yZXNvbHZlT2JqZWN0KCdtYWlsdG86bG9jYWwxQGRvbWFpbjEnLCAnbG9jYWwyQGRvbWFpbjInKQogICAgdmFyIGF1dGhJbkhvc3QgPSByZXN1bHQuaG9zdCAmJiByZXN1bHQuaG9zdC5pbmRleE9mKCdAJykgPiAwID8KICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmhvc3Quc3BsaXQoJ0AnKSA6IGZhbHNlOwogICAgaWYgKGF1dGhJbkhvc3QpIHsKICAgICAgcmVzdWx0LmF1dGggPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgIHJlc3VsdC5ob3N0ID0gcmVzdWx0Lmhvc3RuYW1lID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgfQogIH0KCiAgbXVzdEVuZEFicyA9IG11c3RFbmRBYnMgfHwgKHJlc3VsdC5ob3N0ICYmIHNyY1BhdGgubGVuZ3RoKTsKCiAgaWYgKG11c3RFbmRBYnMgJiYgIWlzQWJzb2x1dGUpIHsKICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgfQoKICBpZiAoIXNyY1BhdGgubGVuZ3RoKSB7CiAgICByZXN1bHQucGF0aG5hbWUgPSBudWxsOwogICAgcmVzdWx0LnBhdGggPSBudWxsOwogIH0gZWxzZSB7CiAgICByZXN1bHQucGF0aG5hbWUgPSBzcmNQYXRoLmpvaW4oJy8nKTsKICB9CgogIC8vdG8gc3VwcG9ydCByZXF1ZXN0Lmh0dHAKICBpZiAoIWlzTnVsbChyZXN1bHQucGF0aG5hbWUpIHx8ICFpc051bGwocmVzdWx0LnNlYXJjaCkpIHsKICAgIHJlc3VsdC5wYXRoID0gKHJlc3VsdC5wYXRobmFtZSA/IHJlc3VsdC5wYXRobmFtZSA6ICcnKSArCiAgICAgICAgICAgICAgICAgIChyZXN1bHQuc2VhcmNoID8gcmVzdWx0LnNlYXJjaCA6ICcnKTsKICB9CiAgcmVzdWx0LmF1dGggPSByZWxhdGl2ZS5hdXRoIHx8IHJlc3VsdC5hdXRoOwogIHJlc3VsdC5zbGFzaGVzID0gcmVzdWx0LnNsYXNoZXMgfHwgcmVsYXRpdmUuc2xhc2hlczsKICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICByZXR1cm4gcmVzdWx0Owp9OwoKVXJsLnByb3RvdHlwZS5wYXJzZUhvc3QgPSBmdW5jdGlvbigpIHsKICB2YXIgaG9zdCA9IHRoaXMuaG9zdDsKICB2YXIgcG9ydCA9IHBvcnRQYXR0ZXJuLmV4ZWMoaG9zdCk7CiAgaWYgKHBvcnQpIHsKICAgIHBvcnQgPSBwb3J0WzBdOwogICAgaWYgKHBvcnQgIT09ICc6JykgewogICAgICB0aGlzLnBvcnQgPSBwb3J0LnN1YnN0cigxKTsKICAgIH0KICAgIGhvc3QgPSBob3N0LnN1YnN0cigwLCBob3N0Lmxlbmd0aCAtIHBvcnQubGVuZ3RoKTsKICB9CiAgaWYgKGhvc3QpIHRoaXMuaG9zdG5hbWUgPSBob3N0Owp9OwoKZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICJzdHJpbmciOwp9CgpmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwp9CgpmdW5jdGlvbiBpc051bGwoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKfQpmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gIGFyZyA9PSBudWxsOwp9Cgp9LHsicHVueWNvZGUiOjkwLCJxdWVyeXN0cmluZyI6OTN9XSw5OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKLyoqCiAqIENvbnZlcnQgYXJyYXkgb2YgMTYgYnl0ZSB2YWx1ZXMgdG8gVVVJRCBzdHJpbmcgZm9ybWF0IG9mIHRoZSBmb3JtOgogKiBYWFhYWFhYWC1YWFhYLVhYWFgtWFhYWC1YWFhYWFhYWFhYWFgKICovCnZhciBieXRlVG9IZXggPSBbXTsKCmZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyArK2kpIHsKICBieXRlVG9IZXhbaV0gPSAoaSArIDB4MTAwKS50b1N0cmluZygxNikuc3Vic3RyKDEpOwp9CgpmdW5jdGlvbiBieXRlc1RvVXVpZChidWYsIG9mZnNldCkgewogIHZhciBpID0gb2Zmc2V0IHx8IDA7CiAgdmFyIGJ0aCA9IGJ5dGVUb0hleDsgLy8gam9pbiB1c2VkIHRvIGZpeCBtZW1vcnkgaXNzdWUgY2F1c2VkIGJ5IGNvbmNhdGVuYXRpb246IGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTMxNzUjYzQKCiAgcmV0dXJuIFtidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLCBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV1dLmpvaW4oJycpOwp9Cgp2YXIgX2RlZmF1bHQgPSBieXRlc1RvVXVpZDsKZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0se31dLDEwMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ2MSIsIHsKICBlbnVtZXJhYmxlOiB0cnVlLAogIGdldDogZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIF92LmRlZmF1bHQ7CiAgfQp9KTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ2MyIsIHsKICBlbnVtZXJhYmxlOiB0cnVlLAogIGdldDogZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIF92Mi5kZWZhdWx0OwogIH0KfSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidjQiLCB7CiAgZW51bWVyYWJsZTogdHJ1ZSwKICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBfdjMuZGVmYXVsdDsKICB9Cn0pOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInY1IiwgewogIGVudW1lcmFibGU6IHRydWUsCiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gX3Y0LmRlZmF1bHQ7CiAgfQp9KTsKCnZhciBfdiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi92MS5qcyIpKTsKCnZhciBfdjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vdjMuanMiKSk7Cgp2YXIgX3YzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3Y0LmpzIikpOwoKdmFyIF92NCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi92NS5qcyIpKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9Cn0seyIuL3YxLmpzIjoxMDQsIi4vdjMuanMiOjEwNSwiLi92NC5qcyI6MTA3LCIuL3Y1LmpzIjoxMDh9XSwxMDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCi8qCiAqIEJyb3dzZXItY29tcGF0aWJsZSBKYXZhU2NyaXB0IE1ENQogKgogKiBNb2RpZmljYXRpb24gb2YgSmF2YVNjcmlwdCBNRDUKICogaHR0cHM6Ly9naXRodWIuY29tL2JsdWVpbXAvSmF2YVNjcmlwdC1NRDUKICoKICogQ29weXJpZ2h0IDIwMTEsIFNlYmFzdGlhbiBUc2NoYW4KICogaHR0cHM6Ly9ibHVlaW1wLm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2U6CiAqIGh0dHBzOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUCiAqCiAqIEJhc2VkIG9uCiAqIEEgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgUlNBIERhdGEgU2VjdXJpdHksIEluYy4gTUQ1IE1lc3NhZ2UKICogRGlnZXN0IEFsZ29yaXRobSwgYXMgZGVmaW5lZCBpbiBSRkMgMTMyMS4KICogVmVyc2lvbiAyLjIgQ29weXJpZ2h0IChDKSBQYXVsIEpvaG5zdG9uIDE5OTkgLSAyMDA5CiAqIE90aGVyIGNvbnRyaWJ1dG9yczogR3JlZyBIb2x0LCBBbmRyZXcgS2VwZXJ0LCBZZG5hciwgTG9zdGluZXQKICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBMaWNlbnNlCiAqIFNlZSBodHRwOi8vcGFqaG9tZS5vcmcudWsvY3J5cHQvbWQ1IGZvciBtb3JlIGluZm8uCiAqLwpmdW5jdGlvbiBtZDUoYnl0ZXMpIHsKICBpZiAodHlwZW9mIGJ5dGVzID09ICdzdHJpbmcnKSB7CiAgICB2YXIgbXNnID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGJ5dGVzKSk7IC8vIFVURjggZXNjYXBlCgogICAgYnl0ZXMgPSBuZXcgQXJyYXkobXNnLmxlbmd0aCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtc2cubGVuZ3RoOyBpKyspIGJ5dGVzW2ldID0gbXNnLmNoYXJDb2RlQXQoaSk7CiAgfQoKICByZXR1cm4gbWQ1VG9IZXhFbmNvZGVkQXJyYXkod29yZHNUb01kNShieXRlc1RvV29yZHMoYnl0ZXMpLCBieXRlcy5sZW5ndGggKiA4KSk7Cn0KLyoKICogQ29udmVydCBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzIHRvIGFuIGFycmF5IG9mIGJ5dGVzCiAqLwoKCmZ1bmN0aW9uIG1kNVRvSGV4RW5jb2RlZEFycmF5KGlucHV0KSB7CiAgdmFyIGk7CiAgdmFyIHg7CiAgdmFyIG91dHB1dCA9IFtdOwogIHZhciBsZW5ndGgzMiA9IGlucHV0Lmxlbmd0aCAqIDMyOwogIHZhciBoZXhUYWIgPSAnMDEyMzQ1Njc4OWFiY2RlZic7CiAgdmFyIGhleDsKCiAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDMyOyBpICs9IDgpIHsKICAgIHggPSBpbnB1dFtpID4+IDVdID4+PiBpICUgMzIgJiAweGZmOwogICAgaGV4ID0gcGFyc2VJbnQoaGV4VGFiLmNoYXJBdCh4ID4+PiA0ICYgMHgwZikgKyBoZXhUYWIuY2hhckF0KHggJiAweDBmKSwgMTYpOwogICAgb3V0cHV0LnB1c2goaGV4KTsKICB9CgogIHJldHVybiBvdXRwdXQ7Cn0KLyoKICogQ2FsY3VsYXRlIHRoZSBNRDUgb2YgYW4gYXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcywgYW5kIGEgYml0IGxlbmd0aC4KICovCgoKZnVuY3Rpb24gd29yZHNUb01kNSh4LCBsZW4pIHsKICAvKiBhcHBlbmQgcGFkZGluZyAqLwogIHhbbGVuID4+IDVdIHw9IDB4ODAgPDwgbGVuICUgMzI7CiAgeFsobGVuICsgNjQgPj4+IDkgPDwgNCkgKyAxNF0gPSBsZW47CiAgdmFyIGk7CiAgdmFyIG9sZGE7CiAgdmFyIG9sZGI7CiAgdmFyIG9sZGM7CiAgdmFyIG9sZGQ7CiAgdmFyIGEgPSAxNzMyNTg0MTkzOwogIHZhciBiID0gLTI3MTczMzg3OTsKICB2YXIgYyA9IC0xNzMyNTg0MTk0OwogIHZhciBkID0gMjcxNzMzODc4OwoKICBmb3IgKGkgPSAwOyBpIDwgeC5sZW5ndGg7IGkgKz0gMTYpIHsKICAgIG9sZGEgPSBhOwogICAgb2xkYiA9IGI7CiAgICBvbGRjID0gYzsKICAgIG9sZGQgPSBkOwogICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaV0sIDcsIC02ODA4NzY5MzYpOwogICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDFdLCAxMiwgLTM4OTU2NDU4Nik7CiAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMl0sIDE3LCA2MDYxMDU4MTkpOwogICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDNdLCAyMiwgLTEwNDQ1MjUzMzApOwogICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaSArIDRdLCA3LCAtMTc2NDE4ODk3KTsKICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyA1XSwgMTIsIDEyMDAwODA0MjYpOwogICAgYyA9IG1kNWZmKGMsIGQsIGEsIGIsIHhbaSArIDZdLCAxNywgLTE0NzMyMzEzNDEpOwogICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDddLCAyMiwgLTQ1NzA1OTgzKTsKICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2kgKyA4XSwgNywgMTc3MDAzNTQxNik7CiAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgOV0sIDEyLCAtMTk1ODQxNDQxNyk7CiAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMTBdLCAxNywgLTQyMDYzKTsKICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyAxMV0sIDIyLCAtMTk5MDQwNDE2Mik7CiAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpICsgMTJdLCA3LCAxODA0NjAzNjgyKTsKICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyAxM10sIDEyLCAtNDAzNDExMDEpOwogICAgYyA9IG1kNWZmKGMsIGQsIGEsIGIsIHhbaSArIDE0XSwgMTcsIC0xNTAyMDAyMjkwKTsKICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyAxNV0sIDIyLCAxMjM2NTM1MzI5KTsKICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyAxXSwgNSwgLTE2NTc5NjUxMCk7CiAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgNl0sIDksIC0xMDY5NTAxNjMyKTsKICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAxMV0sIDE0LCA2NDM3MTc3MTMpOwogICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaV0sIDIwLCAtMzczODk3MzAyKTsKICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyA1XSwgNSwgLTcwMTU1ODY5MSk7CiAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgMTBdLCA5LCAzODAxNjA4Myk7CiAgICBjID0gbWQ1Z2coYywgZCwgYSwgYiwgeFtpICsgMTVdLCAxNCwgLTY2MDQ3ODMzNSk7CiAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpICsgNF0sIDIwLCAtNDA1NTM3ODQ4KTsKICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyA5XSwgNSwgNTY4NDQ2NDM4KTsKICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAxNF0sIDksIC0xMDE5ODAzNjkwKTsKICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAzXSwgMTQsIC0xODczNjM5NjEpOwogICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaSArIDhdLCAyMCwgMTE2MzUzMTUwMSk7CiAgICBhID0gbWQ1Z2coYSwgYiwgYywgZCwgeFtpICsgMTNdLCA1LCAtMTQ0NDY4MTQ2Nyk7CiAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgMl0sIDksIC01MTQwMzc4NCk7CiAgICBjID0gbWQ1Z2coYywgZCwgYSwgYiwgeFtpICsgN10sIDE0LCAxNzM1MzI4NDczKTsKICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2kgKyAxMl0sIDIwLCAtMTkyNjYwNzczNCk7CiAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgNV0sIDQsIC0zNzg1NTgpOwogICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDhdLCAxMSwgLTIwMjI1NzQ0NjMpOwogICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDExXSwgMTYsIDE4MzkwMzA1NjIpOwogICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDE0XSwgMjMsIC0zNTMwOTU1Nik7CiAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgMV0sIDQsIC0xNTMwOTkyMDYwKTsKICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2kgKyA0XSwgMTEsIDEyNzI4OTMzNTMpOwogICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDddLCAxNiwgLTE1NTQ5NzYzMik7CiAgICBiID0gbWQ1aGgoYiwgYywgZCwgYSwgeFtpICsgMTBdLCAyMywgLTEwOTQ3MzA2NDApOwogICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDEzXSwgNCwgNjgxMjc5MTc0KTsKICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2ldLCAxMSwgLTM1ODUzNzIyMik7CiAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgM10sIDE2LCAtNzIyNTIxOTc5KTsKICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyA2XSwgMjMsIDc2MDI5MTg5KTsKICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyA5XSwgNCwgLTY0MDM2NDQ4Nyk7CiAgICBkID0gbWQ1aGgoZCwgYSwgYiwgYywgeFtpICsgMTJdLCAxMSwgLTQyMTgxNTgzNSk7CiAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgMTVdLCAxNiwgNTMwNzQyNTIwKTsKICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyAyXSwgMjMsIC05OTUzMzg2NTEpOwogICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaV0sIDYsIC0xOTg2MzA4NDQpOwogICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDddLCAxMCwgMTEyNjg5MTQxNSk7CiAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMTRdLCAxNSwgLTE0MTYzNTQ5MDUpOwogICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDVdLCAyMSwgLTU3NDM0MDU1KTsKICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2kgKyAxMl0sIDYsIDE3MDA0ODU1NzEpOwogICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDNdLCAxMCwgLTE4OTQ5ODY2MDYpOwogICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDEwXSwgMTUsIC0xMDUxNTIzKTsKICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyAxXSwgMjEsIC0yMDU0OTIyNzk5KTsKICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2kgKyA4XSwgNiwgMTg3MzMxMzM1OSk7CiAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgMTVdLCAxMCwgLTMwNjExNzQ0KTsKICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyA2XSwgMTUsIC0xNTYwMTk4MzgwKTsKICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyAxM10sIDIxLCAxMzA5MTUxNjQ5KTsKICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2kgKyA0XSwgNiwgLTE0NTUyMzA3MCk7CiAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgMTFdLCAxMCwgLTExMjAyMTAzNzkpOwogICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDJdLCAxNSwgNzE4Nzg3MjU5KTsKICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyA5XSwgMjEsIC0zNDM0ODU1NTEpOwogICAgYSA9IHNhZmVBZGQoYSwgb2xkYSk7CiAgICBiID0gc2FmZUFkZChiLCBvbGRiKTsKICAgIGMgPSBzYWZlQWRkKGMsIG9sZGMpOwogICAgZCA9IHNhZmVBZGQoZCwgb2xkZCk7CiAgfQoKICByZXR1cm4gW2EsIGIsIGMsIGRdOwp9Ci8qCiAqIENvbnZlcnQgYW4gYXJyYXkgYnl0ZXMgdG8gYW4gYXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcwogKiBDaGFyYWN0ZXJzID4yNTUgaGF2ZSB0aGVpciBoaWdoLWJ5dGUgc2lsZW50bHkgaWdub3JlZC4KICovCgoKZnVuY3Rpb24gYnl0ZXNUb1dvcmRzKGlucHV0KSB7CiAgdmFyIGk7CiAgdmFyIG91dHB1dCA9IFtdOwogIG91dHB1dFsoaW5wdXQubGVuZ3RoID4+IDIpIC0gMV0gPSB1bmRlZmluZWQ7CgogIGZvciAoaSA9IDA7IGkgPCBvdXRwdXQubGVuZ3RoOyBpICs9IDEpIHsKICAgIG91dHB1dFtpXSA9IDA7CiAgfQoKICB2YXIgbGVuZ3RoOCA9IGlucHV0Lmxlbmd0aCAqIDg7CgogIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg4OyBpICs9IDgpIHsKICAgIG91dHB1dFtpID4+IDVdIHw9IChpbnB1dFtpIC8gOF0gJiAweGZmKSA8PCBpICUgMzI7CiAgfQoKICByZXR1cm4gb3V0cHV0Owp9Ci8qCiAqIEFkZCBpbnRlZ2Vycywgd3JhcHBpbmcgYXQgMl4zMi4gVGhpcyB1c2VzIDE2LWJpdCBvcGVyYXRpb25zIGludGVybmFsbHkKICogdG8gd29yayBhcm91bmQgYnVncyBpbiBzb21lIEpTIGludGVycHJldGVycy4KICovCgoKZnVuY3Rpb24gc2FmZUFkZCh4LCB5KSB7CiAgdmFyIGxzdyA9ICh4ICYgMHhmZmZmKSArICh5ICYgMHhmZmZmKTsKICB2YXIgbXN3ID0gKHggPj4gMTYpICsgKHkgPj4gMTYpICsgKGxzdyA+PiAxNik7CiAgcmV0dXJuIG1zdyA8PCAxNiB8IGxzdyAmIDB4ZmZmZjsKfQovKgogKiBCaXR3aXNlIHJvdGF0ZSBhIDMyLWJpdCBudW1iZXIgdG8gdGhlIGxlZnQuCiAqLwoKCmZ1bmN0aW9uIGJpdFJvdGF0ZUxlZnQobnVtLCBjbnQpIHsKICByZXR1cm4gbnVtIDw8IGNudCB8IG51bSA+Pj4gMzIgLSBjbnQ7Cn0KLyoKICogVGhlc2UgZnVuY3Rpb25zIGltcGxlbWVudCB0aGUgZm91ciBiYXNpYyBvcGVyYXRpb25zIHRoZSBhbGdvcml0aG0gdXNlcy4KICovCgoKZnVuY3Rpb24gbWQ1Y21uKHEsIGEsIGIsIHgsIHMsIHQpIHsKICByZXR1cm4gc2FmZUFkZChiaXRSb3RhdGVMZWZ0KHNhZmVBZGQoc2FmZUFkZChhLCBxKSwgc2FmZUFkZCh4LCB0KSksIHMpLCBiKTsKfQoKZnVuY3Rpb24gbWQ1ZmYoYSwgYiwgYywgZCwgeCwgcywgdCkgewogIHJldHVybiBtZDVjbW4oYiAmIGMgfCB+YiAmIGQsIGEsIGIsIHgsIHMsIHQpOwp9CgpmdW5jdGlvbiBtZDVnZyhhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgcmV0dXJuIG1kNWNtbihiICYgZCB8IGMgJiB+ZCwgYSwgYiwgeCwgcywgdCk7Cn0KCmZ1bmN0aW9uIG1kNWhoKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICByZXR1cm4gbWQ1Y21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7Cn0KCmZ1bmN0aW9uIG1kNWlpKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICByZXR1cm4gbWQ1Y21uKGMgXiAoYiB8IH5kKSwgYSwgYiwgeCwgcywgdCk7Cn0KCnZhciBfZGVmYXVsdCA9IG1kNTsKZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0se31dLDEwMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gcm5nOwovLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLiBJbiB0aGUgYnJvd3NlciB3ZSB0aGVyZWZvcmUKLy8gcmVxdWlyZSB0aGUgY3J5cHRvIEFQSSBhbmQgZG8gbm90IHN1cHBvcnQgYnVpbHQtaW4gZmFsbGJhY2sgdG8gbG93ZXIgcXVhbGl0eSByYW5kb20gbnVtYmVyCi8vIGdlbmVyYXRvcnMgKGxpa2UgTWF0aC5yYW5kb20oKSkuCi8vIGdldFJhbmRvbVZhbHVlcyBuZWVkcyB0byBiZSBpbnZva2VkIGluIGEgY29udGV4dCB3aGVyZSAidGhpcyIgaXMgYSBDcnlwdG8gaW1wbGVtZW50YXRpb24uIEFsc28sCi8vIGZpbmQgdGhlIGNvbXBsZXRlIGltcGxlbWVudGF0aW9uIG9mIGNyeXB0byAobXNDcnlwdG8pIG9uIElFMTEuCnZhciBnZXRSYW5kb21WYWx1ZXMgPSB0eXBlb2YgY3J5cHRvICE9ICd1bmRlZmluZWQnICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKGNyeXB0bykgfHwgdHlwZW9mIG1zQ3J5cHRvICE9ICd1bmRlZmluZWQnICYmIHR5cGVvZiBtc0NyeXB0by5nZXRSYW5kb21WYWx1ZXMgPT0gJ2Z1bmN0aW9uJyAmJiBtc0NyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChtc0NyeXB0byk7CnZhciBybmRzOCA9IG5ldyBVaW50OEFycmF5KDE2KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11bmRlZgoKZnVuY3Rpb24gcm5nKCkgewogIGlmICghZ2V0UmFuZG9tVmFsdWVzKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyeXB0by5nZXRSYW5kb21WYWx1ZXMoKSBub3Qgc3VwcG9ydGVkLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3V1aWRqcy91dWlkI2dldHJhbmRvbXZhbHVlcy1ub3Qtc3VwcG9ydGVkJyk7CiAgfQoKICByZXR1cm4gZ2V0UmFuZG9tVmFsdWVzKHJuZHM4KTsKfQp9LHt9XSwxMDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCi8vIEFkYXB0ZWQgZnJvbSBDaHJpcyBWZW5lc3MnIFNIQTEgY29kZSBhdAovLyBodHRwOi8vd3d3Lm1vdmFibGUtdHlwZS5jby51ay9zY3JpcHRzL3NoYTEuaHRtbApmdW5jdGlvbiBmKHMsIHgsIHksIHopIHsKICBzd2l0Y2ggKHMpIHsKICAgIGNhc2UgMDoKICAgICAgcmV0dXJuIHggJiB5IF4gfnggJiB6OwoKICAgIGNhc2UgMToKICAgICAgcmV0dXJuIHggXiB5IF4gejsKCiAgICBjYXNlIDI6CiAgICAgIHJldHVybiB4ICYgeSBeIHggJiB6IF4geSAmIHo7CgogICAgY2FzZSAzOgogICAgICByZXR1cm4geCBeIHkgXiB6OwogIH0KfQoKZnVuY3Rpb24gUk9UTCh4LCBuKSB7CiAgcmV0dXJuIHggPDwgbiB8IHggPj4+IDMyIC0gbjsKfQoKZnVuY3Rpb24gc2hhMShieXRlcykgewogIHZhciBLID0gWzB4NWE4Mjc5OTksIDB4NmVkOWViYTEsIDB4OGYxYmJjZGMsIDB4Y2E2MmMxZDZdOwogIHZhciBIID0gWzB4Njc0NTIzMDEsIDB4ZWZjZGFiODksIDB4OThiYWRjZmUsIDB4MTAzMjU0NzYsIDB4YzNkMmUxZjBdOwoKICBpZiAodHlwZW9mIGJ5dGVzID09ICdzdHJpbmcnKSB7CiAgICB2YXIgbXNnID0gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGJ5dGVzKSk7IC8vIFVURjggZXNjYXBlCgogICAgYnl0ZXMgPSBuZXcgQXJyYXkobXNnLmxlbmd0aCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtc2cubGVuZ3RoOyBpKyspIGJ5dGVzW2ldID0gbXNnLmNoYXJDb2RlQXQoaSk7CiAgfQoKICBieXRlcy5wdXNoKDB4ODApOwogIHZhciBsID0gYnl0ZXMubGVuZ3RoIC8gNCArIDI7CiAgdmFyIE4gPSBNYXRoLmNlaWwobCAvIDE2KTsKICB2YXIgTSA9IG5ldyBBcnJheShOKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBOOyBpKyspIHsKICAgIE1baV0gPSBuZXcgQXJyYXkoMTYpOwoKICAgIGZvciAodmFyIGogPSAwOyBqIDwgMTY7IGorKykgewogICAgICBNW2ldW2pdID0gYnl0ZXNbaSAqIDY0ICsgaiAqIDRdIDw8IDI0IHwgYnl0ZXNbaSAqIDY0ICsgaiAqIDQgKyAxXSA8PCAxNiB8IGJ5dGVzW2kgKiA2NCArIGogKiA0ICsgMl0gPDwgOCB8IGJ5dGVzW2kgKiA2NCArIGogKiA0ICsgM107CiAgICB9CiAgfQoKICBNW04gLSAxXVsxNF0gPSAoYnl0ZXMubGVuZ3RoIC0gMSkgKiA4IC8gTWF0aC5wb3coMiwgMzIpOwogIE1bTiAtIDFdWzE0XSA9IE1hdGguZmxvb3IoTVtOIC0gMV1bMTRdKTsKICBNW04gLSAxXVsxNV0gPSAoYnl0ZXMubGVuZ3RoIC0gMSkgKiA4ICYgMHhmZmZmZmZmZjsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBOOyBpKyspIHsKICAgIHZhciBXID0gbmV3IEFycmF5KDgwKTsKCiAgICBmb3IgKHZhciB0ID0gMDsgdCA8IDE2OyB0KyspIFdbdF0gPSBNW2ldW3RdOwoKICAgIGZvciAodmFyIHQgPSAxNjsgdCA8IDgwOyB0KyspIHsKICAgICAgV1t0XSA9IFJPVEwoV1t0IC0gM10gXiBXW3QgLSA4XSBeIFdbdCAtIDE0XSBeIFdbdCAtIDE2XSwgMSk7CiAgICB9CgogICAgdmFyIGEgPSBIWzBdOwogICAgdmFyIGIgPSBIWzFdOwogICAgdmFyIGMgPSBIWzJdOwogICAgdmFyIGQgPSBIWzNdOwogICAgdmFyIGUgPSBIWzRdOwoKICAgIGZvciAodmFyIHQgPSAwOyB0IDwgODA7IHQrKykgewogICAgICB2YXIgcyA9IE1hdGguZmxvb3IodCAvIDIwKTsKICAgICAgdmFyIFQgPSBST1RMKGEsIDUpICsgZihzLCBiLCBjLCBkKSArIGUgKyBLW3NdICsgV1t0XSA+Pj4gMDsKICAgICAgZSA9IGQ7CiAgICAgIGQgPSBjOwogICAgICBjID0gUk9UTChiLCAzMCkgPj4+IDA7CiAgICAgIGIgPSBhOwogICAgICBhID0gVDsKICAgIH0KCiAgICBIWzBdID0gSFswXSArIGEgPj4+IDA7CiAgICBIWzFdID0gSFsxXSArIGIgPj4+IDA7CiAgICBIWzJdID0gSFsyXSArIGMgPj4+IDA7CiAgICBIWzNdID0gSFszXSArIGQgPj4+IDA7CiAgICBIWzRdID0gSFs0XSArIGUgPj4+IDA7CiAgfQoKICByZXR1cm4gW0hbMF0gPj4gMjQgJiAweGZmLCBIWzBdID4+IDE2ICYgMHhmZiwgSFswXSA+PiA4ICYgMHhmZiwgSFswXSAmIDB4ZmYsIEhbMV0gPj4gMjQgJiAweGZmLCBIWzFdID4+IDE2ICYgMHhmZiwgSFsxXSA+PiA4ICYgMHhmZiwgSFsxXSAmIDB4ZmYsIEhbMl0gPj4gMjQgJiAweGZmLCBIWzJdID4+IDE2ICYgMHhmZiwgSFsyXSA+PiA4ICYgMHhmZiwgSFsyXSAmIDB4ZmYsIEhbM10gPj4gMjQgJiAweGZmLCBIWzNdID4+IDE2ICYgMHhmZiwgSFszXSA+PiA4ICYgMHhmZiwgSFszXSAmIDB4ZmYsIEhbNF0gPj4gMjQgJiAweGZmLCBIWzRdID4+IDE2ICYgMHhmZiwgSFs0XSA+PiA4ICYgMHhmZiwgSFs0XSAmIDB4ZmZdOwp9Cgp2YXIgX2RlZmF1bHQgPSBzaGExOwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7fV0sMTA0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7Cgp2YXIgX3JuZyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9ybmcuanMiKSk7Cgp2YXIgX2J5dGVzVG9VdWlkID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL2J5dGVzVG9VdWlkLmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCi8vICoqYHYxKClgIC0gR2VuZXJhdGUgdGltZS1iYXNlZCBVVUlEKioKLy8KLy8gSW5zcGlyZWQgYnkgaHR0cHM6Ly9naXRodWIuY29tL0xpb3NLL1VVSUQuanMKLy8gYW5kIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS91dWlkLmh0bWwKdmFyIF9ub2RlSWQ7Cgp2YXIgX2Nsb2Nrc2VxOyAvLyBQcmV2aW91cyB1dWlkIGNyZWF0aW9uIHRpbWUKCgp2YXIgX2xhc3RNU2VjcyA9IDA7CnZhciBfbGFzdE5TZWNzID0gMDsgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS91dWlkanMvdXVpZCBmb3IgQVBJIGRldGFpbHMKCmZ1bmN0aW9uIHYxKG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgdmFyIGIgPSBidWYgfHwgW107CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgdmFyIG5vZGUgPSBvcHRpb25zLm5vZGUgfHwgX25vZGVJZDsKICB2YXIgY2xvY2tzZXEgPSBvcHRpb25zLmNsb2Nrc2VxICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNsb2Nrc2VxIDogX2Nsb2Nrc2VxOyAvLyBub2RlIGFuZCBjbG9ja3NlcSBuZWVkIHRvIGJlIGluaXRpYWxpemVkIHRvIHJhbmRvbSB2YWx1ZXMgaWYgdGhleSdyZSBub3QKICAvLyBzcGVjaWZpZWQuICBXZSBkbyB0aGlzIGxhemlseSB0byBtaW5pbWl6ZSBpc3N1ZXMgcmVsYXRlZCB0byBpbnN1ZmZpY2llbnQKICAvLyBzeXN0ZW0gZW50cm9weS4gIFNlZSAjMTg5CgogIGlmIChub2RlID09IG51bGwgfHwgY2xvY2tzZXEgPT0gbnVsbCkgewogICAgdmFyIHNlZWRCeXRlcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBfcm5nLmRlZmF1bHQpKCk7CgogICAgaWYgKG5vZGUgPT0gbnVsbCkgewogICAgICAvLyBQZXIgNC41LCBjcmVhdGUgYW5kIDQ4LWJpdCBub2RlIGlkLCAoNDcgcmFuZG9tIGJpdHMgKyBtdWx0aWNhc3QgYml0ID0gMSkKICAgICAgbm9kZSA9IF9ub2RlSWQgPSBbc2VlZEJ5dGVzWzBdIHwgMHgwMSwgc2VlZEJ5dGVzWzFdLCBzZWVkQnl0ZXNbMl0sIHNlZWRCeXRlc1szXSwgc2VlZEJ5dGVzWzRdLCBzZWVkQnl0ZXNbNV1dOwogICAgfQoKICAgIGlmIChjbG9ja3NlcSA9PSBudWxsKSB7CiAgICAgIC8vIFBlciA0LjIuMiwgcmFuZG9taXplICgxNCBiaXQpIGNsb2Nrc2VxCiAgICAgIGNsb2Nrc2VxID0gX2Nsb2Nrc2VxID0gKHNlZWRCeXRlc1s2XSA8PCA4IHwgc2VlZEJ5dGVzWzddKSAmIDB4M2ZmZjsKICAgIH0KICB9IC8vIFVVSUQgdGltZXN0YW1wcyBhcmUgMTAwIG5hbm8tc2Vjb25kIHVuaXRzIHNpbmNlIHRoZSBHcmVnb3JpYW4gZXBvY2gsCiAgLy8gKDE1ODItMTAtMTUgMDA6MDApLiAgSlNOdW1iZXJzIGFyZW4ndCBwcmVjaXNlIGVub3VnaCBmb3IgdGhpcywgc28KICAvLyB0aW1lIGlzIGhhbmRsZWQgaW50ZXJuYWxseSBhcyAnbXNlY3MnIChpbnRlZ2VyIG1pbGxpc2Vjb25kcykgYW5kICduc2VjcycKICAvLyAoMTAwLW5hbm9zZWNvbmRzIG9mZnNldCBmcm9tIG1zZWNzKSBzaW5jZSB1bml4IGVwb2NoLCAxOTcwLTAxLTAxIDAwOjAwLgoKCiAgdmFyIG1zZWNzID0gb3B0aW9ucy5tc2VjcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5tc2VjcyA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpOyAvLyBQZXIgNC4yLjEuMiwgdXNlIGNvdW50IG9mIHV1aWQncyBnZW5lcmF0ZWQgZHVyaW5nIHRoZSBjdXJyZW50IGNsb2NrCiAgLy8gY3ljbGUgdG8gc2ltdWxhdGUgaGlnaGVyIHJlc29sdXRpb24gY2xvY2sKCiAgdmFyIG5zZWNzID0gb3B0aW9ucy5uc2VjcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5uc2VjcyA6IF9sYXN0TlNlY3MgKyAxOyAvLyBUaW1lIHNpbmNlIGxhc3QgdXVpZCBjcmVhdGlvbiAoaW4gbXNlY3MpCgogIHZhciBkdCA9IG1zZWNzIC0gX2xhc3RNU2VjcyArIChuc2VjcyAtIF9sYXN0TlNlY3MpIC8gMTAwMDA7IC8vIFBlciA0LjIuMS4yLCBCdW1wIGNsb2Nrc2VxIG9uIGNsb2NrIHJlZ3Jlc3Npb24KCiAgaWYgKGR0IDwgMCAmJiBvcHRpb25zLmNsb2Nrc2VxID09PSB1bmRlZmluZWQpIHsKICAgIGNsb2Nrc2VxID0gY2xvY2tzZXEgKyAxICYgMHgzZmZmOwogIH0gLy8gUmVzZXQgbnNlY3MgaWYgY2xvY2sgcmVncmVzc2VzIChuZXcgY2xvY2tzZXEpIG9yIHdlJ3ZlIG1vdmVkIG9udG8gYSBuZXcKICAvLyB0aW1lIGludGVydmFsCgoKICBpZiAoKGR0IDwgMCB8fCBtc2VjcyA+IF9sYXN0TVNlY3MpICYmIG9wdGlvbnMubnNlY3MgPT09IHVuZGVmaW5lZCkgewogICAgbnNlY3MgPSAwOwogIH0gLy8gUGVyIDQuMi4xLjIgVGhyb3cgZXJyb3IgaWYgdG9vIG1hbnkgdXVpZHMgYXJlIHJlcXVlc3RlZAoKCiAgaWYgKG5zZWNzID49IDEwMDAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoInV1aWQudjEoKTogQ2FuJ3QgY3JlYXRlIG1vcmUgdGhhbiAxME0gdXVpZHMvc2VjIik7CiAgfQoKICBfbGFzdE1TZWNzID0gbXNlY3M7CiAgX2xhc3ROU2VjcyA9IG5zZWNzOwogIF9jbG9ja3NlcSA9IGNsb2Nrc2VxOyAvLyBQZXIgNC4xLjQgLSBDb252ZXJ0IGZyb20gdW5peCBlcG9jaCB0byBHcmVnb3JpYW4gZXBvY2gKCiAgbXNlY3MgKz0gMTIyMTkyOTI4MDAwMDA7IC8vIGB0aW1lX2xvd2AKCiAgdmFyIHRsID0gKChtc2VjcyAmIDB4ZmZmZmZmZikgKiAxMDAwMCArIG5zZWNzKSAlIDB4MTAwMDAwMDAwOwogIGJbaSsrXSA9IHRsID4+PiAyNCAmIDB4ZmY7CiAgYltpKytdID0gdGwgPj4+IDE2ICYgMHhmZjsKICBiW2krK10gPSB0bCA+Pj4gOCAmIDB4ZmY7CiAgYltpKytdID0gdGwgJiAweGZmOyAvLyBgdGltZV9taWRgCgogIHZhciB0bWggPSBtc2VjcyAvIDB4MTAwMDAwMDAwICogMTAwMDAgJiAweGZmZmZmZmY7CiAgYltpKytdID0gdG1oID4+PiA4ICYgMHhmZjsKICBiW2krK10gPSB0bWggJiAweGZmOyAvLyBgdGltZV9oaWdoX2FuZF92ZXJzaW9uYAoKICBiW2krK10gPSB0bWggPj4+IDI0ICYgMHhmIHwgMHgxMDsgLy8gaW5jbHVkZSB2ZXJzaW9uCgogIGJbaSsrXSA9IHRtaCA+Pj4gMTYgJiAweGZmOyAvLyBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAgKFBlciA0LjIuMiAtIGluY2x1ZGUgdmFyaWFudCkKCiAgYltpKytdID0gY2xvY2tzZXEgPj4+IDggfCAweDgwOyAvLyBgY2xvY2tfc2VxX2xvd2AKCiAgYltpKytdID0gY2xvY2tzZXEgJiAweGZmOyAvLyBgbm9kZWAKCiAgZm9yICh2YXIgbiA9IDA7IG4gPCA2OyArK24pIHsKICAgIGJbaSArIG5dID0gbm9kZVtuXTsKICB9CgogIHJldHVybiBidWYgPyBidWYgOiAoMCwgX2J5dGVzVG9VdWlkLmRlZmF1bHQpKGIpOwp9Cgp2YXIgX2RlZmF1bHQgPSB2MTsKZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0seyIuL2J5dGVzVG9VdWlkLmpzIjo5OSwiLi9ybmcuanMiOjEwMn1dLDEwNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKdmFyIF92ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3YzNS5qcyIpKTsKCnZhciBfbWQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vbWQ1LmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmNvbnN0IHYzID0gKDAsIF92LmRlZmF1bHQpKCd2MycsIDB4MzAsIF9tZC5kZWZhdWx0KTsKdmFyIF9kZWZhdWx0ID0gdjM7CmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9LHsiLi9tZDUuanMiOjEwMSwiLi92MzUuanMiOjEwNn1dLDEwNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7CmV4cG9ydHMuVVJMID0gZXhwb3J0cy5ETlMgPSB2b2lkIDA7Cgp2YXIgX2J5dGVzVG9VdWlkID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL2J5dGVzVG9VdWlkLmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmZ1bmN0aW9uIHV1aWRUb0J5dGVzKHV1aWQpIHsKICAvLyBOb3RlOiBXZSBhc3N1bWUgd2UncmUgYmVpbmcgcGFzc2VkIGEgdmFsaWQgdXVpZCBzdHJpbmcKICB2YXIgYnl0ZXMgPSBbXTsKICB1dWlkLnJlcGxhY2UoL1thLWZBLUYwLTldezJ9L2csIGZ1bmN0aW9uIChoZXgpIHsKICAgIGJ5dGVzLnB1c2gocGFyc2VJbnQoaGV4LCAxNikpOwogIH0pOwogIHJldHVybiBieXRlczsKfQoKZnVuY3Rpb24gc3RyaW5nVG9CeXRlcyhzdHIpIHsKICBzdHIgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoc3RyKSk7IC8vIFVURjggZXNjYXBlCgogIHZhciBieXRlcyA9IG5ldyBBcnJheShzdHIubGVuZ3RoKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgIGJ5dGVzW2ldID0gc3RyLmNoYXJDb2RlQXQoaSk7CiAgfQoKICByZXR1cm4gYnl0ZXM7Cn0KCmNvbnN0IEROUyA9ICc2YmE3YjgxMC05ZGFkLTExZDEtODBiNC0wMGMwNGZkNDMwYzgnOwpleHBvcnRzLkROUyA9IEROUzsKY29uc3QgVVJMID0gJzZiYTdiODExLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCc7CmV4cG9ydHMuVVJMID0gVVJMOwoKZnVuY3Rpb24gX2RlZmF1bHQobmFtZSwgdmVyc2lvbiwgaGFzaGZ1bmMpIHsKICB2YXIgZ2VuZXJhdGVVVUlEID0gZnVuY3Rpb24gKHZhbHVlLCBuYW1lc3BhY2UsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgb2ZmID0gYnVmICYmIG9mZnNldCB8fCAwOwogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgdmFsdWUgPSBzdHJpbmdUb0J5dGVzKHZhbHVlKTsKICAgIGlmICh0eXBlb2YgbmFtZXNwYWNlID09ICdzdHJpbmcnKSBuYW1lc3BhY2UgPSB1dWlkVG9CeXRlcyhuYW1lc3BhY2UpOwogICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkgdGhyb3cgVHlwZUVycm9yKCd2YWx1ZSBtdXN0IGJlIGFuIGFycmF5IG9mIGJ5dGVzJyk7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkobmFtZXNwYWNlKSB8fCBuYW1lc3BhY2UubGVuZ3RoICE9PSAxNikgdGhyb3cgVHlwZUVycm9yKCduYW1lc3BhY2UgbXVzdCBiZSB1dWlkIHN0cmluZyBvciBhbiBBcnJheSBvZiAxNiBieXRlIHZhbHVlcycpOyAvLyBQZXIgNC4zCgogICAgdmFyIGJ5dGVzID0gaGFzaGZ1bmMobmFtZXNwYWNlLmNvbmNhdCh2YWx1ZSkpOwogICAgYnl0ZXNbNl0gPSBieXRlc1s2XSAmIDB4MGYgfCB2ZXJzaW9uOwogICAgYnl0ZXNbOF0gPSBieXRlc1s4XSAmIDB4M2YgfCAweDgwOwoKICAgIGlmIChidWYpIHsKICAgICAgZm9yICh2YXIgaWR4ID0gMDsgaWR4IDwgMTY7ICsraWR4KSB7CiAgICAgICAgYnVmW29mZiArIGlkeF0gPSBieXRlc1tpZHhdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJ1ZiB8fCAoMCwgX2J5dGVzVG9VdWlkLmRlZmF1bHQpKGJ5dGVzKTsKICB9OyAvLyBGdW5jdGlvbiNuYW1lIGlzIG5vdCBzZXR0YWJsZSBvbiBzb21lIHBsYXRmb3JtcyAoIzI3MCkKCgogIHRyeSB7CiAgICBnZW5lcmF0ZVVVSUQubmFtZSA9IG5hbWU7CiAgfSBjYXRjaCAoZXJyKSB7fSAvLyBGb3IgQ29tbW9uSlMgZGVmYXVsdCBleHBvcnQgc3VwcG9ydAoKCiAgZ2VuZXJhdGVVVUlELkROUyA9IEROUzsKICBnZW5lcmF0ZVVVSUQuVVJMID0gVVJMOwogIHJldHVybiBnZW5lcmF0ZVVVSUQ7Cn0KfSx7Ii4vYnl0ZXNUb1V1aWQuanMiOjk5fV0sMTA3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7Cgp2YXIgX3JuZyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9ybmcuanMiKSk7Cgp2YXIgX2J5dGVzVG9VdWlkID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL2J5dGVzVG9VdWlkLmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CgogIGlmICh0eXBlb2Ygb3B0aW9ucyA9PSAnc3RyaW5nJykgewogICAgYnVmID0gb3B0aW9ucyA9PT0gJ2JpbmFyeScgPyBuZXcgQXJyYXkoMTYpIDogbnVsbDsKICAgIG9wdGlvbnMgPSBudWxsOwogIH0KCiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIHZhciBybmRzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IF9ybmcuZGVmYXVsdCkoKTsgLy8gUGVyIDQuNCwgc2V0IGJpdHMgZm9yIHZlcnNpb24gYW5kIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYAoKCiAgcm5kc1s2XSA9IHJuZHNbNl0gJiAweDBmIHwgMHg0MDsKICBybmRzWzhdID0gcm5kc1s4XSAmIDB4M2YgfCAweDgwOyAvLyBDb3B5IGJ5dGVzIHRvIGJ1ZmZlciwgaWYgcHJvdmlkZWQKCiAgaWYgKGJ1ZikgewogICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IDE2OyArK2lpKSB7CiAgICAgIGJ1ZltpICsgaWldID0gcm5kc1tpaV07CiAgICB9CiAgfQoKICByZXR1cm4gYnVmIHx8ICgwLCBfYnl0ZXNUb1V1aWQuZGVmYXVsdCkocm5kcyk7Cn0KCnZhciBfZGVmYXVsdCA9IHY0OwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7Ii4vYnl0ZXNUb1V1aWQuanMiOjk5LCIuL3JuZy5qcyI6MTAyfV0sMTA4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7Cgp2YXIgX3YgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vdjM1LmpzIikpOwoKdmFyIF9zaGEgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vc2hhMS5qcyIpKTsKCmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9Cgpjb25zdCB2NSA9ICgwLCBfdi5kZWZhdWx0KSgndjUnLCAweDUwLCBfc2hhLmRlZmF1bHQpOwp2YXIgX2RlZmF1bHQgPSB2NTsKZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0seyIuL3NoYTEuanMiOjEwMywiLi92MzUuanMiOjEwNn1dLDEwOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKdmFyIExSVV8xID0gcmVxdWlyZSgiLi91dGlscy9MUlUiKTsKdmFyIENBQ0hFX1NJWkUgPSAxMDAwOwovKioKICogSW5zcGlyZWQgbm9kZS1scnUtY2FjaGVbaHR0cHM6Ly9naXRodWIuY29tL2lzYWFjcy9ub2RlLWxydS1jYWNoZV0KICovCnZhciBFbmRwb2ludENhY2hlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gRW5kcG9pbnRDYWNoZShtYXhTaXplKSB7CiAgICAgICAgaWYgKG1heFNpemUgPT09IHZvaWQgMCkgeyBtYXhTaXplID0gQ0FDSEVfU0laRTsgfQogICAgICAgIHRoaXMubWF4U2l6ZSA9IG1heFNpemU7CiAgICAgICAgdGhpcy5jYWNoZSA9IG5ldyBMUlVfMS5MUlVDYWNoZShtYXhTaXplKTsKICAgIH0KICAgIDsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbmRwb2ludENhY2hlLnByb3RvdHlwZSwgInNpemUiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlLmxlbmd0aDsKICAgICAgICB9LAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICB9KTsKICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgdmFyIGVuZHBvaW50UmVjb3JkID0gdGhpcy5wb3B1bGF0ZVZhbHVlKHZhbHVlKTsKICAgICAgICB0aGlzLmNhY2hlLnB1dChrZXlTdHJpbmcsIGVuZHBvaW50UmVjb3JkKTsKICAgIH07CiAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLmNhY2hlLmdldChrZXlTdHJpbmcpOwogICAgICAgIGlmIChyZWNvcmRzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSByZWNvcmRzLmxlbmd0aC0xOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdmFyIHJlY29yZCA9IHJlY29yZHNbaV07CiAgICAgICAgICAgICAgICBpZiAocmVjb3JkLkV4cGlyZSA8IG5vdykgewogICAgICAgICAgICAgICAgICAgIHJlY29yZHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZWNvcmRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlY29yZHM7CiAgICB9OwogICAgRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGlkZW50aWZpZXJzID0gW107CiAgICAgICAgdmFyIGlkZW50aWZpZXJOYW1lcyA9IE9iamVjdC5rZXlzKGtleSkuc29ydCgpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaWRlbnRpZmllck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBpZGVudGlmaWVyTmFtZSA9IGlkZW50aWZpZXJOYW1lc1tpXTsKICAgICAgICAgICAgaWYgKGtleVtpZGVudGlmaWVyTmFtZV0gPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBpZGVudGlmaWVycy5wdXNoKGtleVtpZGVudGlmaWVyTmFtZV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaWRlbnRpZmllcnMuam9pbignICcpOwogICAgfTsKICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnBvcHVsYXRlVmFsdWUgPSBmdW5jdGlvbiAoZW5kcG9pbnRzKSB7CiAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgcmV0dXJuIGVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7IHJldHVybiAoewogICAgICAgICAgICBBZGRyZXNzOiBlbmRwb2ludC5BZGRyZXNzIHx8ICcnLAogICAgICAgICAgICBFeHBpcmU6IG5vdyArIChlbmRwb2ludC5DYWNoZVBlcmlvZEluTWludXRlcyB8fCAxKSAqIDYwICogMTAwMAogICAgICAgIH0pOyB9KTsKICAgIH07CiAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLmNhY2hlLmVtcHR5KCk7CiAgICB9OwogICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKGtleSkgewogICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgIHRoaXMuY2FjaGUucmVtb3ZlKGtleVN0cmluZyk7CiAgICB9OwogICAgcmV0dXJuIEVuZHBvaW50Q2FjaGU7Cn0oKSk7CmV4cG9ydHMuRW5kcG9pbnRDYWNoZSA9IEVuZHBvaW50Q2FjaGU7Cn0seyIuL3V0aWxzL0xSVSI6MTEwfV0sMTEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwp2YXIgTGlua2VkTGlzdE5vZGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMaW5rZWRMaXN0Tm9kZShrZXksIHZhbHVlKSB7CiAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfQogICAgcmV0dXJuIExpbmtlZExpc3ROb2RlOwp9KCkpOwp2YXIgTFJVQ2FjaGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBMUlVDYWNoZShzaXplKSB7CiAgICAgICAgdGhpcy5ub2RlTWFwID0ge307CiAgICAgICAgdGhpcy5zaXplID0gMDsKICAgICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInIHx8IHNpemUgPCAxKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FjaGUgc2l6ZSBjYW4gb25seSBiZSBwb3NpdGl2ZSBudW1iZXInKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zaXplTGltaXQgPSBzaXplOwogICAgfQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExSVUNhY2hlLnByb3RvdHlwZSwgImxlbmd0aCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2l6ZTsKICAgICAgICB9LAogICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICB9KTsKICAgIExSVUNhY2hlLnByb3RvdHlwZS5wcmVwZW5kVG9MaXN0ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICBpZiAoIXRoaXMuaGVhZGVyTm9kZSkgewogICAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gbm9kZTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZS5wcmV2ID0gbm9kZTsKICAgICAgICAgICAgbm9kZS5uZXh0ID0gdGhpcy5oZWFkZXJOb2RlOwogICAgICAgIH0KICAgICAgICB0aGlzLmhlYWRlck5vZGUgPSBub2RlOwogICAgICAgIHRoaXMuc2l6ZSsrOwogICAgfTsKICAgIExSVUNhY2hlLnByb3RvdHlwZS5yZW1vdmVGcm9tVGFpbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoIXRoaXMudGFpbE5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgdmFyIG5vZGUgPSB0aGlzLnRhaWxOb2RlOwogICAgICAgIHZhciBwcmV2Tm9kZSA9IG5vZGUucHJldjsKICAgICAgICBpZiAocHJldk5vZGUpIHsKICAgICAgICAgICAgcHJldk5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgICAgbm9kZS5wcmV2ID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMudGFpbE5vZGUgPSBwcmV2Tm9kZTsKICAgICAgICB0aGlzLnNpemUtLTsKICAgICAgICByZXR1cm4gbm9kZTsKICAgIH07CiAgICBMUlVDYWNoZS5wcm90b3R5cGUuZGV0YWNoRnJvbUxpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgIGlmICh0aGlzLmhlYWRlck5vZGUgPT09IG5vZGUpIHsKICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlID0gbm9kZS5uZXh0OwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy50YWlsTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gbm9kZS5wcmV2OwogICAgICAgIH0KICAgICAgICBpZiAobm9kZS5wcmV2KSB7CiAgICAgICAgICAgIG5vZGUucHJldi5uZXh0ID0gbm9kZS5uZXh0OwogICAgICAgIH0KICAgICAgICBpZiAobm9kZS5uZXh0KSB7CiAgICAgICAgICAgIG5vZGUubmV4dC5wcmV2ID0gbm9kZS5wcmV2OwogICAgICAgIH0KICAgICAgICBub2RlLm5leHQgPSB1bmRlZmluZWQ7CiAgICAgICAgbm9kZS5wcmV2ID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuc2l6ZS0tOwogICAgfTsKICAgIExSVUNhY2hlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgIHRoaXMucHJlcGVuZFRvTGlzdChub2RlKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWU7CiAgICAgICAgfQogICAgfTsKICAgIExSVUNhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICB9CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLnB1dCA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlKGtleSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMuc2l6ZSA9PT0gdGhpcy5zaXplTGltaXQpIHsKICAgICAgICAgICAgdmFyIHRhaWxOb2RlID0gdGhpcy5yZW1vdmVGcm9tVGFpbCgpOwogICAgICAgICAgICB2YXIga2V5XzEgPSB0YWlsTm9kZS5rZXk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XzFdOwogICAgICAgIH0KICAgICAgICB2YXIgbmV3Tm9kZSA9IG5ldyBMaW5rZWRMaXN0Tm9kZShrZXksIHZhbHVlKTsKICAgICAgICB0aGlzLm5vZGVNYXBba2V5XSA9IG5ld05vZGU7CiAgICAgICAgdGhpcy5wcmVwZW5kVG9MaXN0KG5ld05vZGUpOwogICAgfTsKICAgIExSVUNhY2hlLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMubm9kZU1hcCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgfQogICAgfTsKICAgIHJldHVybiBMUlVDYWNoZTsKfSgpKTsKZXhwb3J0cy5MUlVDYWNoZSA9IExSVUNhY2hlOwp9LHt9XSwxMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBBV1MgU0RLIGZvciBKYXZhU2NyaXB0IHYyLjEyMDAuMAovLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dApyZXF1aXJlKCcuL2Jyb3dzZXJfbG9hZGVyJyk7Cgp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CgppZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHdpbmRvdy5BV1MgPSBBV1M7CmlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7Cn0KaWYgKHR5cGVvZiBzZWxmICE9PSAndW5kZWZpbmVkJykgc2VsZi5BV1MgPSBBV1M7CgovKioKICogQHByaXZhdGUKICogRE8gTk9UIFJFTU9WRQogKiBicm93c2VyIGJ1aWxkZXIgd2lsbCBzdHJpcCBvdXQgdGhpcyBsaW5lIGlmIHNlcnZpY2VzIGFyZSBzdXBwbGllZCBvbiB0aGUgY29tbWFuZCBsaW5lLgogKi9pZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MsICdDb25uZWN0JykpIHsKICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydjb25uZWN0J10gPSB7fTsKICBBV1MuQ29ubmVjdCA9IEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2Nvbm5lY3QnLCBbICcyMDE3LTAyLTE1JyBdKTsKfQpBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydjb25uZWN0J11bJzIwMTctMDItMTUnXSA9IHJlcXVpcmUoJy4uL2FwaXMvY29ubmVjdC0yMDE3LTAyLTE1Lm1pbicpOwoKCn0seyIuLi9hcGlzL2Nvbm5lY3QtMjAxNy0wMi0xNS5taW4iOjMsIi4vYnJvd3Nlcl9sb2FkZXIiOjE2LCIuL2NvcmUiOjE5fV19LHt9LFsxMTFdKTsKCgoKLyoqKi8gfSksCgovKioqLyA3NTQ6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQ2xpZW50TWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5DbGllbnRNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICAgICdnZXRBZ2VudFNuYXBzaG90JywKICAgICAgICAgJ3B1dEFnZW50U3RhdGUnLAogICAgICAgICAnZ2V0QWdlbnRTdGF0ZXMnLAogICAgICAgICAnZ2V0RGlhbGFibGVDb3VudHJ5Q29kZXMnLAogICAgICAgICAnZ2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMnLAogICAgICAgICAnZ2V0QWdlbnRQZXJtaXNzaW9ucycsCiAgICAgICAgICdnZXRBZ2VudENvbmZpZ3VyYXRpb24nLAogICAgICAgICAndXBkYXRlQWdlbnRDb25maWd1cmF0aW9uJywKICAgICAgICAgJ2FjY2VwdENvbnRhY3QnLAogICAgICAgICAnY3JlYXRlT3V0Ym91bmRDb250YWN0JywKICAgICAgICAgJ2NyZWF0ZVRhc2tDb250YWN0JywKICAgICAgICAgJ2NsZWFyQ29udGFjdCcsCiAgICAgICAgICdjb21wbGV0ZUNvbnRhY3QnLAogICAgICAgICAnZGVzdHJveUNvbnRhY3QnLAogICAgICAgICAncmVqZWN0Q29udGFjdCcsCiAgICAgICAgICdub3RpZnlDb250YWN0SXNzdWUnLAogICAgICAgICAndXBkYXRlQ29udGFjdEF0dHJpYnV0ZXMnLAogICAgICAgICAnY3JlYXRlQWRkaXRpb25hbENvbm5lY3Rpb24nLAogICAgICAgICAnZGVzdHJveUNvbm5lY3Rpb24nLAogICAgICAgICAnaG9sZENvbm5lY3Rpb24nLAogICAgICAgICAncmVzdW1lQ29ubmVjdGlvbicsCiAgICAgICAgICd0b2dnbGVBY3RpdmVDb25uZWN0aW9ucycsCiAgICAgICAgICdjb25mZXJlbmNlQ29ubmVjdGlvbnMnLAogICAgICAgICAnc2VuZENsaWVudExvZ3MnLAogICAgICAgICAnc2VuZERpZ2l0cycsCiAgICAgICAgICdzZW5kU29mdHBob25lQ2FsbFJlcG9ydCcsCiAgICAgICAgICdzZW5kU29mdHBob25lQ2FsbE1ldHJpY3MnLAogICAgICAgICAnZ2V0RW5kcG9pbnRzJywKICAgICAgICAgJ2dldE5ld0F1dGhUb2tlbicsCiAgICAgICAgICdjcmVhdGVUcmFuc3BvcnQnLAogICAgICAgICAnbXV0ZVBhcnRpY2lwYW50JywKICAgICAgICAgJ3VubXV0ZVBhcnRpY2lwYW50JywKICAgICAgICAgJ3VwZGF0ZU1vbml0b3JQYXJ0aWNpcGFudFN0YXRlJwogICBdKTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIEFnZW50QXBwQ2xpZW50TWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMgPSB7CiAgICAgIEdFVF9DT05UQUNUOiAiQWdlbnRBcHBTZXJ2aWNlLkxjbXMuZ2V0Q29udGFjdCIsCiAgICAgIERFTEVURV9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZGVsZXRlU3BlYWtlciIsCiAgICAgIEVOUk9MTF9CWV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZW5yb2xsQnlTZXNzaW9uIiwKICAgICAgRVZBTFVBVEVfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmV2YWx1YXRlU2Vzc2lvbiIsCiAgICAgIERFU0NSSUJFX1NQRUFLRVI6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5kZXNjcmliZVNwZWFrZXIiLAogICAgICBPUFRfT1VUX1NQRUFLRVI6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5vcHRPdXRTcGVha2VyIiwKICAgICAgVVBEQVRFX1ZPSUNFX0lEX0RBVEE6ICJBZ2VudEFwcFNlcnZpY2UuTGNtcy51cGRhdGVWb2ljZUlkRGF0YSIsCiAgICAgIERFU0NSSUJFX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5kZXNjcmliZVNlc3Npb24iLAogICAgICBVUERBVEVfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLnVwZGF0ZVNlc3Npb24iLAogICAgICBTVEFSVF9WT0lDRV9JRF9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLk5hc2Euc3RhcnRWb2ljZUlkU2Vzc2lvbiIsCiAgICAgIExJU1RfSU5URUdSQVRJT05fQVNTT0NJQVRJT05TOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5saXN0SW50ZWdyYXRpb25Bc3NvY2lhdGlvbnMiLAogICAgICBTVEFSVF9DT05UQUNUX1JFQ09SRElORzogIkFnZW50QXBwU2VydmljZS5BY3MuU3RhcnRDb250YWN0UmVjb3JkaW5nIiwKICAgICAgU1RPUF9DT05UQUNUX1JFQ09SRElORzogIkFnZW50QXBwU2VydmljZS5BY3MuU3RvcENvbnRhY3RSZWNvcmRpbmciLAogICAgICBTVVNQRU5EX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5TdXNwZW5kQ29udGFjdFJlY29yZGluZyIsCiAgICAgIFJFU1VNRV9DT05UQUNUX1JFQ09SRElORzogIkFnZW50QXBwU2VydmljZS5BY3MuUmVzdW1lQ29udGFjdFJlY29yZGluZyIKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIE1hc3Rlck1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuTWFzdGVyTWV0aG9kcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgICAgICAnYmVjb21lTWFzdGVyJywKICAgICAgICAgJ2NoZWNrTWFzdGVyJwogICBdKTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIFRhc2tUZW1wbGF0ZXNDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnRNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICdsaXN0VGFza1RlbXBsYXRlcycsCiAgICAgICdnZXRUYXNrVGVtcGxhdGUnLAogICAgICAnY3JlYXRlVGVtcGxhdGVkVGFzaycsCiAgICAgICd1cGRhdGVDb250YWN0JwogICBdKTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBhYnN0cmFjdCBjbGFzcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgQ2xpZW50QmFzZSA9IGZ1bmN0aW9uKCkge307CiAgIENsaWVudEJhc2UuRU1QVFlfQ0FMTEJBQ0tTID0gewogICAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHsgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24oKSB7IH0KICAgfTsKCiAgIENsaWVudEJhc2UucHJvdG90eXBlLmNhbGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtc0luLCBjYWxsYmFja3NJbikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWV0aG9kLCAnbWV0aG9kJyk7CiAgICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgICAgdmFyIGNhbGxiYWNrcyA9IGNhbGxiYWNrc0luIHx8IENsaWVudEJhc2UuRU1QVFlfQ0FMTEJBQ0tTOwogICAgICB0aGlzLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKTsKICAgfTsKCiAgIENsaWVudEJhc2UucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIE51bGxDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgTnVsbENsaWVudCA9IGZ1bmN0aW9uKCkgewogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgIH07CiAgIE51bGxDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIE51bGxDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTnVsbENsaWVudDsKCiAgIE51bGxDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgICB2YXIgbWVzc2FnZSA9IGNvbm5lY3Quc3ByaW50ZignTm8gc3VjaCBtZXRob2QgZXhpc3RzIG9uIE5VTEwgY2xpZW50OiAlcycsIG1ldGhvZCk7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSksIHttZXNzYWdlOiBtZXNzYWdlfSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBhYnN0cmFjdCBjbGFzcyBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlIGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UgPSBmdW5jdGlvbihjb25kdWl0LCByZXF1ZXN0RXZlbnQsIHJlc3BvbnNlRXZlbnQpIHsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgICB0aGlzLnJlcXVlc3RFdmVudCA9IHJlcXVlc3RFdmVudDsKICAgICAgdGhpcy5yZXNwb25zZUV2ZW50ID0gcmVzcG9uc2VFdmVudDsKICAgICAgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwID0ge307CgogICAgICB0aGlzLmNvbmR1aXQub25VcHN0cmVhbShyZXNwb25zZUV2ZW50LCBjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2hhbmRsZVJlc3BvbnNlKSk7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2U7CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVxdWVzdCh0aGlzLnJlcXVlc3RFdmVudCwgbWV0aG9kLCBwYXJhbXMpOwogICAgICB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdC5yZXF1ZXN0SWRdID0gY2FsbGJhY2tzOwogICAgICB0aGlzLmNvbmR1aXQuc2VuZFVwc3RyZWFtKHJlcXVlc3QuZXZlbnQsIHJlcXVlc3QpOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2dldENhbGxiYWNrc0ZvclJlcXVlc3QgPSBmdW5jdGlvbihyZXF1ZXN0SWQpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0SWRdIHx8IG51bGw7CgogICAgICBpZiAoY2FsbGJhY2tzICE9IG51bGwpIHsKICAgICAgICAgZGVsZXRlIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0SWRdOwogICAgICB9CgogICAgICByZXR1cm4gY2FsbGJhY2tzOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2hhbmRsZVJlc3BvbnNlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICB2YXIgY2FsbGJhY2tzID0gdGhpcy5fZ2V0Q2FsbGJhY2tzRm9yUmVxdWVzdChkYXRhLnJlcXVlc3RJZCk7CiAgICAgIGlmIChjYWxsYmFja3MgPT0gbnVsbCkgewogICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChkYXRhLmVyciAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShkYXRhLmVyciwgZGF0YS5kYXRhKTsKCiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2tzLnN1Y2Nlc3MpIHsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YS5kYXRhKTsKICAgICAgfQogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFVwc3RyZWFtQ29uZHVpdENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRDbGllbnQgPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UuY2FsbCh0aGlzLCBjb25kdWl0LCBjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVRVUVTVCwgY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFKTsKICAgfTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UuY2FsbCh0aGlzLCBjb25kdWl0LCBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVRVUVTVCwgY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFKTsKICAgfTsKICAgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50OwogICAKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRBcHBDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICovCiAgIHZhciBBZ2VudEFwcENsaWVudCA9IGZ1bmN0aW9uKGF1dGhDb29raWVOYW1lLCBhdXRoVG9rZW4sIGVuZHBvaW50KSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhdXRoQ29va2llTmFtZSwgJ2F1dGhDb29raWVOYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhdXRoVG9rZW4sICdhdXRoVG9rZW4nKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKTsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICB0aGlzLmVuZHBvaW50VXJsID0gY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2woZW5kcG9pbnQpOwogICAgICB0aGlzLmF1dGhUb2tlbiA9IGF1dGhUb2tlbjsKICAgICAgdGhpcy5hdXRoQ29va2llTmFtZSA9IGF1dGhDb29raWVOYW1lCiAgIH07CgogICBBZ2VudEFwcENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQWdlbnRBcHBDbGllbnQ7CgogICBBZ2VudEFwcENsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBiZWFyID0ge307CiAgICAgIGJlYXJbc2VsZi5hdXRoQ29va2llTmFtZV0gPSBzZWxmLmF1dGhUb2tlbjsKICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgIG1ldGhvZDogJ3Bvc3QnLAogICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShwYXJhbXMgfHwge30pLAogICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICAgICdYLUFtei10YXJnZXQnOiBtZXRob2QsCiAgICAgICAgICAgICAgICdYLUFtei1CZWFyZXInOiBKU09OLnN0cmluZ2lmeShiZWFyKQogICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbm5lY3QuZmV0Y2goc2VsZi5lbmRwb2ludFVybCwgb3B0aW9ucykudGhlbihmdW5jdGlvbihyZXMpewogICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhyZXMpOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgICBjb25zdCByZWFkZXIgPSBlcnIuYm9keS5nZXRSZWFkZXIoKTsKICAgICAgICAgbGV0IGJvZHkgPSAnJzsKICAgICAgICAgY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpOwogICAgICAgICByZWFkZXIucmVhZCgpLnRoZW4oZnVuY3Rpb24gcHJvY2Vzc1RleHQoeyBkb25lLCB2YWx1ZSB9KSB7CiAgICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgICAgIHZhciBlcnJvciA9IEpTT04ucGFyc2UoYm9keSk7CiAgICAgICAgICAgICAgIGVycm9yLnN0YXR1cyA9IGVyci5zdGF0dXM7CiAgICAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yKTsKICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkgKz0gZGVjb2Rlci5kZWNvZGUodmFsdWUpOwogICAgICAgICAgICByZXR1cm4gcmVhZGVyLnJlYWQoKS50aGVuKHByb2Nlc3NUZXh0KTsKICAgICAgICAgfSk7CiAgICAgIH0pCiAgIH07CiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBBV1NDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgQVdTQ2xpZW50ID0gZnVuY3Rpb24oYXV0aFRva2VuLCByZWdpb24sIGVuZHBvaW50SW4pIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGF1dGhUb2tlbiwgJ2F1dGhUb2tlbicpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVnaW9uLCAncmVnaW9uJyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoe30pOwogICAgICBBV1MuY29uZmlnLnJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgdGhpcy5hdXRoVG9rZW4gPSBhdXRoVG9rZW47CiAgICAgIHZhciBiYXNlVXJsID0gY29ubmVjdC5nZXRCYXNlVXJsKCk7CiAgICAgIHZhciBlbmRwb2ludFVybCA9IGVuZHBvaW50SW4gfHwgKCAKICAgICAgICAgYmFzZVVybC5pbmNsdWRlcygiLmF3c2FwcHMuY29tIikKICAgICAgICAgICAgPyBiYXNlVXJsICsgJy9jb25uZWN0L2FwaScKICAgICAgICAgICAgOiBiYXNlVXJsICsgJy9hcGknCiAgICAgICk7CiAgICAgIHZhciBlbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnRVcmwpOwogICAgICB0aGlzLmNsaWVudCA9IG5ldyBBV1MuQ29ubmVjdCh7ZW5kcG9pbnQ6IGVuZHBvaW50fSk7CiAgIH07CiAgIEFXU0NsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFXU0NsaWVudDsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewoKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKCiAgICAgIGlmICghIGNvbm5lY3QuY29udGFpbnModGhpcy5jbGllbnQsIG1ldGhvZCkpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBBV1MgY2xpZW50OiAlcycsIG1ldGhvZCk7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSksIHttZXNzYWdlOiBtZXNzYWdlfSk7CgogICAgICB9IGVsc2UgewogICAgICAgICBwYXJhbXMgPSB0aGlzLl90cmFuc2xhdGVQYXJhbXMobWV0aG9kLCBwYXJhbXMpOwoKICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IC0tPiBDYWxsaW5nIG9wZXJhdGlvbiAnJXMnIiwgbWV0aG9kKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgdGhpcy5jbGllbnRbbWV0aG9kXShwYXJhbXMpCiAgICAgICAgICAgIC5vbignYnVpbGQnLCBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQmVhcmVyJ10gPSBzZWxmLmF1dGhUb2tlbjsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSBjb25uZWN0LkNUSUV4Y2VwdGlvbnMuVU5BVVRIT1JJWkVEX0VYQ0VQVElPTikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3MuYWNjZXNzRGVuaWVkICYmIChlcnIuY29kZSA9PT0gY29ubmVjdC5DVElFeGNlcHRpb25zLkFDQ0VTU19ERU5JRURfRVhDRVBUSU9OIHx8IGVyci5zdGF0dXNDb2RlID09PSA0MDMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQoKTsKICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2FuJ3QgcGFzcyBlcnIgZGlyZWN0bHkgdG8gcG9zdE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcG9zdE1lc3NhZ2UoKSB0cmllcyB0byBjbG9uZSB0aGUgZXJyIG9iamVjdCBhbmQgZmFpbGVkLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWZlciB0byBodHRwczovL2dpdGh1Yi5jb20vZ29hdHNsYWNrZXIvYWx0LWRldnRvb2wvaXNzdWVzLzUKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnR5cGUgPSBlcnIuY29kZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5zdGFjayA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLnN0YWNrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGVyci5zdGFjaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5zdGFjayA9IGVyci5zdGFjazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVyci5zdGFjayA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5zdGFjayA9IFtKU09OLnN0cmluZ2lmeShlcnIuc3RhY2spXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVyci5zdGFjayA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5zdGFjayA9IGVyci5zdGFjay5zcGxpdCgnXG4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCB7fQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvciwgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiA8LS0gT3BlcmF0aW9uICclcycgZmFpbGVkOiAlcyIsIG1ldGhvZCwgSlNPTi5zdHJpbmdpZnkoZXJyKSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiA8LS0gT3BlcmF0aW9uICclcycgc3VjY2VlZGVkLiIsIG1ldGhvZCkud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBoYW5kbGUgQVdTIEFQSSByZXF1ZXN0IGZvciBtZXRob2QgJXMiLCBtZXRob2QpCiAgICAgICAgICAgICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgIH0KICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3JlcXVpcmVzQXV0aGVudGljYXRpb25QYXJhbSA9IGZ1bmN0aW9uIChtZXRob2QpIHsKICAgICAgcmV0dXJuIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ0xFQVJfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVEFTS19DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9NT05JVE9SX1BBUlRJQ0lQQU5UX1NUQVRFOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUGFyYW1zID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMpIHsKICAgICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuVVBEQVRFX0FHRU5UX0NPTkZJR1VSQVRJT046CiAgICAgICAgICAgIHBhcmFtcy5jb25maWd1cmF0aW9uID0gdGhpcy5fdHJhbnNsYXRlQWdlbnRDb25maWd1cmF0aW9uKHBhcmFtcy5jb25maWd1cmF0aW9uKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX01FVFJJQ1M6CiAgICAgICAgICAgIHBhcmFtcy5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcygKICAgICAgICAgICAgICAgICAgcGFyYW1zLnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfUkVQT1JUOgogICAgICAgICAgICBwYXJhbXMucmVwb3J0ID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lQ2FsbFJlcG9ydChwYXJhbXMucmVwb3J0KTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgaWYgKHRoaXMuX3JlcXVpcmVzQXV0aGVudGljYXRpb25QYXJhbShtZXRob2QpKSB7CiAgICAgICAgIHBhcmFtcy5hdXRoZW50aWNhdGlvbiA9IHsKICAgICAgICAgICAgYXV0aFRva2VuOiB0aGlzLmF1dGhUb2tlbgogICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIG5hbWU6IGNvbmZpZy5uYW1lLAogICAgICAgICBzb2Z0cGhvbmVFbmFibGVkOiBjb25maWcuc29mdHBob25lRW5hYmxlZCwKICAgICAgICAgc29mdHBob25lQXV0b0FjY2VwdDogY29uZmlnLnNvZnRwaG9uZUF1dG9BY2NlcHQsCiAgICAgICAgIGV4dGVuc2lvbjogY29uZmlnLmV4dGVuc2lvbiwKICAgICAgICAgcm91dGluZ1Byb2ZpbGU6IHRoaXMuX3RyYW5zbGF0ZVJvdXRpbmdQcm9maWxlKGNvbmZpZy5yb3V0aW5nUHJvZmlsZSksCiAgICAgICAgIGFnZW50UHJlZmVyZW5jZXM6IGNvbmZpZy5hZ2VudFByZWZlcmVuY2VzCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uKHByb2ZpbGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgbmFtZTogcHJvZmlsZS5uYW1lLAogICAgICAgICByb3V0aW5nUHJvZmlsZUFSTjogcHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTiwKICAgICAgICAgZGVmYXVsdE91dGJvdW5kUXVldWU6IHRoaXMuX3RyYW5zbGF0ZVF1ZXVlKHByb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUpCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVRdWV1ZSA9IGZ1bmN0aW9uKHF1ZXVlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIHF1ZXVlQVJOOiAgIHF1ZXVlLnF1ZXVlQVJOLAogICAgICAgICBuYW1lOiAgICAgICBxdWV1ZS5uYW1lCiAgICAgIH07CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gZnVuY3Rpb24oc3RhdHMpIHsKICAgICAgc3RhdHMuZm9yRWFjaChmdW5jdGlvbihzdGF0KSB7CiAgICAgICAgIGlmICgncGFja2V0c0NvdW50JyBpbiBzdGF0KSB7CiAgICAgICAgICAgIHN0YXQucGFja2V0Q291bnQgPSBzdGF0LnBhY2tldHNDb3VudDsKICAgICAgICAgICAgZGVsZXRlIHN0YXQucGFja2V0c0NvdW50OwogICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHN0YXRzOwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlU29mdHBob25lQ2FsbFJlcG9ydCA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgICBpZiAoJ2hhbmRzaGFraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5oYW5kc2hha2VUaW1lTWlsbGlzID0gcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIGlmICgncHJlVGFsa2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQucHJlVGFsa1RpbWVNaWxsaXMgPSByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIGlmICgnaGFuZHNoYWtpbmdGYWlsdXJlJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LmhhbmRzaGFrZUZhaWx1cmUgPSByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlOwogICAgICAgICBkZWxldGUgcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZTsKICAgICAgfQoKICAgICAgaWYgKCd0YWxraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC50YWxrVGltZU1pbGxpcyA9IHJlcG9ydC50YWxraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC50YWxraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgcmVwb3J0LnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKAogICAgICAgICAgICByZXBvcnQuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyk7CgogICAgICByZXR1cm4gcmVwb3J0OwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgVGFza1RlbXBsYXRlc0NsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgKi8KICAgdmFyIFRhc2tUZW1wbGF0ZXNDbGllbnQgPSBmdW5jdGlvbihlbmRwb2ludCkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZW5kcG9pbnQsICdlbmRwb2ludCcpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIGlmIChlbmRwb2ludC5pbmNsdWRlcygnL3Rhc2stdGVtcGxhdGVzJykpIHsKICAgICAgICAgdGhpcy5lbmRwb2ludFVybCA9IGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sKGVuZHBvaW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgdmFyIEFXU0VuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludCk7CiAgICAgICAgIHZhciBDRlByZWZpeCA9IGVuZHBvaW50LmluY2x1ZGVzKCcuYXdzYXBwcy5jb20nKSA/ICcvY29ubmVjdCcgOiAnJzsKICAgICAgICAgdGhpcy5lbmRwb2ludFVybCA9IGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sKGAke0FXU0VuZHBvaW50Lmhvc3R9JHtDRlByZWZpeH0vdGFzay10ZW1wbGF0ZXMvYXBpL2NjcGApOwogICAgICB9CiAgIH07CgogICBUYXNrVGVtcGxhdGVzQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBUYXNrVGVtcGxhdGVzQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tUZW1wbGF0ZXNDbGllbnQ7CgogICBUYXNrVGVtcGxhdGVzQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOwogICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJywKICAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAneC1jc3JmLXRva2VuJzogJ2NzcmYnICAgICAgICAgCiAgICAgICAgIH0KICAgICAgfTsKICAgICAgdmFyIGluc3RhbmNlSWQgPSBwYXJhbXMuaW5zdGFuY2VJZDsKICAgICAgdmFyIHVybCA9IHRoaXMuZW5kcG9pbnRVcmw7CiAgICAgIHZhciBtZXRob2RzID0gY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50TWV0aG9kczsKICAgICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgICAgY2FzZSBtZXRob2RzLkxJU1RfVEFTS19URU1QTEFURVM6IAogICAgICAgICAgICB1cmwgKz0gYC9wcm94eS9pbnN0YW5jZS8ke2luc3RhbmNlSWR9L3Rhc2svdGVtcGxhdGVgOwogICAgICAgICAgICBpZiAocGFyYW1zLnF1ZXJ5UGFyYW1zKSB7CiAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gbmV3IFVSTFNlYXJjaFBhcmFtcyhwYXJhbXMucXVlcnlQYXJhbXMpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgIGlmIChxdWVyeVN0cmluZykgewogICAgICAgICAgICAgICAgICB1cmwgKz0gYD8ke3F1ZXJ5U3RyaW5nfWA7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgY2FzZSBtZXRob2RzLkdFVF9UQVNLX1RFTVBMQVRFOiAKICAgICAgICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy50ZW1wbGF0ZVBhcmFtcywgJ3BhcmFtcy50ZW1wbGF0ZVBhcmFtcycpOwogICAgICAgICAgICBjb25zdCBpZCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMudGVtcGxhdGVQYXJhbXMuaWQsICdwYXJhbXMudGVtcGxhdGVQYXJhbXMuaWQnKTsKICAgICAgICAgICAgY29uc3QgdmVyc2lvbiA9IHBhcmFtcy50ZW1wbGF0ZVBhcmFtcy52ZXJzaW9uOwogICAgICAgICAgICB1cmwgKz0gYC9wcm94eS9pbnN0YW5jZS8ke2luc3RhbmNlSWR9L3Rhc2svdGVtcGxhdGUvJHtpZH1gOwogICAgICAgICAgICBpZiAodmVyc2lvbikgewogICAgICAgICAgICAgICB1cmwgKz0gYD9zbmFwc2hvdFZlcnNpb249JHt2ZXJzaW9ufWA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIGNhc2UgbWV0aG9kcy5DUkVBVEVfVEVNUExBVEVEX1RBU0s6IAogICAgICAgICAgICB1cmwgKz0gYC8ke21ldGhvZH1gOwogICAgICAgICAgICBvcHRpb25zLmJvZHkgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpOwogICAgICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICdQVVQnOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgY2FzZSBtZXRob2RzLlVQREFURV9DT05UQUNUOiAKICAgICAgICAgICAgdXJsICs9IGAvJHttZXRob2R9YDsKICAgICAgICAgICAgb3B0aW9ucy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTsKICAgICAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAnUE9TVCc7CiAgICAgIH0KICAgICAgY29ubmVjdC5mZXRjaCh1cmwsIG9wdGlvbnMpCiAgICAgIC50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHJlcyk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgIGNvbnN0IHJlYWRlciA9IGVyci5ib2R5LmdldFJlYWRlcigpOwogICAgICAgICBsZXQgYm9keSA9ICcnOwogICAgICAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7CiAgICAgICAgIHJlYWRlci5yZWFkKCkudGhlbihmdW5jdGlvbiBwcm9jZXNzVGV4dCh7IGRvbmUsIHZhbHVlIH0pIHsKICAgICAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgICAgICAgdmFyIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTsKICAgICAgICAgICAgICAgZXJyb3Iuc3RhdHVzID0gZXJyLnN0YXR1czsKICAgICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYm9keSArPSBkZWNvZGVyLmRlY29kZSh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiByZWFkZXIucmVhZCgpLnRoZW4ocHJvY2Vzc1RleHQpOwogICAgICAgICB9KTsKICAgICAgfSkKICAgfTsKCiAgIGNvbm5lY3QuQ2xpZW50QmFzZSA9IENsaWVudEJhc2U7CiAgIGNvbm5lY3QuTnVsbENsaWVudCA9IE51bGxDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50ID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50OwogICBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCA9IFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudDsKICAgY29ubmVjdC5BV1NDbGllbnQgPSBBV1NDbGllbnQ7CiAgIGNvbm5lY3QuQWdlbnRBcHBDbGllbnQgPSBBZ2VudEFwcENsaWVudDsKICAgY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50ID0gVGFza1RlbXBsYXRlc0NsaWVudDsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDg5NToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuY29yZSA9IHt9OwogIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IGZhbHNlOwogIGNvbm5lY3QudmVyc2lvbiA9ICIxLjcuNCI7CiAgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkUgPSA1MDA7CiAKICB2YXIgQ0NQX1NZTl9USU1FT1VUID0gMTAwMDsgLy8gMSBzZWMKICB2YXIgQ0NQX0FDS19USU1FT1VUID0gMzAwMDsgLy8gMyBzZWMKICB2YXIgQ0NQX0xPQURfVElNRU9VVCA9IDUwMDA7IC8vIDUgc2VjCiAgdmFyIENDUF9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTCA9IDUwMDA7IC8vIDUgc2VjCiAgdmFyIENDUF9EUl9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTCA9IDEwMDAwOyAvLzEwIHMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0xJTUlUID0gNjsgLy8gNiBhdHRlbXB0cwogIHZhciBDQ1BfSUZSQU1FX05BTUUgPSAnQW1hem9uIENvbm5lY3QgQ0NQJzsKIAogIHZhciBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4gPSAiaHR0cHM6Ly97YWxpYXN9LmF3c2FwcHMuY29tL2F1dGgvP2NsaWVudF9pZD17Y2xpZW50X2lkfSZyZWRpcmVjdF91cmk9e3JlZGlyZWN0fSI7CiAgdmFyIENMSUVOVF9JRF9NQVAgPSB7CiAgICAidXMtZWFzdC0xIjogIjA2OTE5ZjRmZDhlZDMyNGUiCiAgfTsKIAogIHZhciBBVVRIT1JJWkVfRU5EUE9JTlQgPSAiL2F1dGgvYXV0aG9yaXplIjsKICB2YXIgTEVHQUNZX0FVVEhPUklaRV9FTkRQT0lOVCA9ICIvY29ubmVjdC9hdXRoL2F1dGhvcml6ZSI7CiAgdmFyIEFVVEhPUklaRV9SRVRSWV9JTlRFUlZBTCA9IDIwMDA7CiAgdmFyIEFVVEhPUklaRV9NQVhfUkVUUlkgPSA1OwogCiAgdmFyIExFR0FDWV9XSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UID0gIi9jb25uZWN0L3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UID0gIi93aGl0ZWxpc3RlZC1vcmlnaW5zIjsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19SRVRSWV9JTlRFUlZBTCA9IDIwMDA7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfTUFYX1JFVFJZID0gNTsKCiAgdmFyIENTTV9JRlJBTUVfUkVGUkVTSF9BVFRFTVBUUyA9ICdJZnJhbWVSZWZyZXNoQXR0ZW1wdHMnOwogIHZhciBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1NVQ0NFU1MgPSAnSWZyYW1lSW5pdGlhbGl6YXRpb25TdWNjZXNzJzsKICB2YXIgQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9USU1FID0gJ0lmcmFtZUluaXRpYWxpemF0aW9uVGltZSc7CgogIHZhciBDT05ORUNURURfQ0NQU19TSU5HTEVfVEFCID0gJ0Nvbm5lY3RlZENDUFNpbmdsZVRhYkNvdW50JzsKICB2YXIgQ0NQX1RBQlNfQUNST1NTX0JST1dTRVJfQ09VTlQgPSAnQ0NQVGFic0Fjcm9zc0Jyb3dzZXJDb3VudCc7CgogIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gMDsKICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiA9IDA7CgogIGNvbm5lY3QuY29yZS5NQVhfQVVUSE9SSVpFX1JFVFJZX0NPVU5UX0ZPUl9TRVNTSU9OID0gMzsKICBjb25uZWN0LmNvcmUuTUFYX0NUSV9BVVRIX1JFVFJZX0NPVU5UID0gMTA7CiAgY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50ID0gMDsKICBjb25uZWN0LmNvcmUuYXV0aG9yaXplVGltZW91dElkID0gbnVsbDsKICBjb25uZWN0LmNvcmUuY3RpVGltZW91dElkID0gbnVsbDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBTZXNzaW9uU3RvcmFnZUtleXMKICAgKi8KICBjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3RhYl9pZCcsCiAgICAnYXV0aG9yaXplX3JldHJ5X2NvdW50JywKICBdKTsKCiAgLyoqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBUaGlzIGZ1bmN0aW9uIHdhcyBvbmx5IG1lYW50IGZvciBpbnRlcm5hbCB1c2UuIAogICAqIFRoZSBuYW1lIGlzIG1pc2xlYWRpbmcgZm9yIHdoYXQgaXQgc2hvdWxkIGRvLgogICAqIEludGVybmFsbHkgd2UgaGF2ZSByZXBsYWNlZCBpdHMgdXNhZ2Ugd2l0aCBgZ2V0TG9naW5VcmxgLgogICAqLwogIHZhciBjcmVhdGVMb2dpblVybCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciByZWRpcmVjdCA9ICJodHRwczovL2xpbHkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGF3L2F1dGgvY29kZSI7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVkaXJlY3QpOwogCiAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgIHJldHVybiBwYXJhbXMubG9naW5VcmwKICAgIH0gZWxzZSBpZiAocGFyYW1zLmFsaWFzKSB7CiAgICAgIGxvZy53YXJuKCJUaGUgYGFsaWFzYCBwYXJhbSBpcyBkZXByZWNhdGVkIGFuZCBzaG91bGQgbm90IGJlIGV4cGVjdGVkIHRvIGZ1bmN0aW9uIHByb3Blcmx5LiBQbGVhc2UgdXNlIGBjY3BVcmxgIG9yIGBsb2dpblVybGAuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW1hem9uLWNvbm5lY3QvYW1hem9uLWNvbm5lY3Qtc3RyZWFtcy9ibG9iL21hc3Rlci9SRUFETUUubWQjY29ubmVjdGNvcmVpbml0Y2NwIGZvciB2YWxpZCBwYXJhbWV0ZXJzLiIpOwogICAgICByZXR1cm4gTEVHQUNZX0xPR0lOX1VSTF9QQVRURVJOCiAgICAgICAgLnJlcGxhY2UoInthbGlhc30iLCBwYXJhbXMuYWxpYXMpCiAgICAgICAgLnJlcGxhY2UoIntjbGllbnRfaWR9IiwgQ0xJRU5UX0lEX01BUFsidXMtZWFzdC0xIl0pCiAgICAgICAgLnJlcGxhY2UoIntyZWRpcmVjdH0iLCBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgcmVkaXJlY3QpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwYXJhbXMuY2NwVXJsOwogICAgfQogIH07CgogIC8qKgogICAqIFJlcGxhY2VzIGBjcmVhdGVMb2dpblVybGAsIGFzIHRoYXQgZnVuY3Rpb24ncyBuYW1lIHdhcyBtaXNsZWFkaW5nLgogICAqIFRoZSBgcGFyYW1zLmFsaWFzYCBwYXJhbWV0ZXIgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHJlZnJhaW4gZnJvbSB1c2luZyBpdC4KICAgKi8KICB2YXIgZ2V0TG9naW5VcmwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgcmVkaXJlY3QgPSAiaHR0cHM6Ly9saWx5LnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL3Rhdy9hdXRoL2NvZGUiOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZGlyZWN0KTsKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgbG9nLndhcm4oIlRoZSBgYWxpYXNgIHBhcmFtIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZXhwZWN0ZWQgdG8gZnVuY3Rpb24gcHJvcGVybHkuIFBsZWFzZSB1c2UgYGNjcFVybGAgb3IgYGxvZ2luVXJsYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWF6b24tY29ubmVjdC9hbWF6b24tY29ubmVjdC1zdHJlYW1zL2Jsb2IvbWFzdGVyL1JFQURNRS5tZCNjb25uZWN0Y29yZWluaXRjY3AgZm9yIHZhbGlkIHBhcmFtZXRlcnMuIik7CiAgICAgIHJldHVybiBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFJldHVybnMgc2NoZW1lOi8vaG9zdDpwb3J0IGZvciBhIGdpdmVuIHVybAogICovCiAgZnVuY3Rpb24gc2FuaXRpemVEb21haW4odXJsKSB7CiAgICB2YXIgZG9tYWluID0gdXJsLm1hdGNoKC9eKD86aHR0cHM/OlwvXC8pPyg/OlteQFxuXStAKT8oPzp3d3dcLik/KFteOlwvXG4/XSspL2lnKTsKICAgIHJldHVybiBkb21haW4ubGVuZ3RoID8gZG9tYWluWzBdIDogIiI7CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBQcmludCBhIHdhcm5pbmcgbWVzc2FnZSBpZiB0aGUgQ29ubmVjdCBjb3JlIGlzIG5vdCBpbml0aWFsaXplZC4KICAgICovCiAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgICBsb2cud2FybigiQ29ubmVjdCBjb3JlIGFscmVhZHkgaW5pdGlhbGl6ZWQsIG9ubHkgbmVlZHMgdG8gYmUgaW5pdGlhbGl6ZWQgb25jZS4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIERJU0FTVEVSIFJFQ09WRVJZIAogICovCiAgCiAgIHZhciBtYWtlQWdlbnRPZmZsaW5lID0gZnVuY3Rpb24oYWdlbnQsIGNhbGxiYWNrcykgewogICAgdmFyIG9mZmxpbmVTdGF0ZSA9IGFnZW50LmdldEFnZW50U3RhdGVzKCkuZmluZChmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgcmV0dXJuIHN0YXRlLnR5cGUgPT09IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuT0ZGTElORTsKICAgIH0pOwogICAgYWdlbnQuc2V0U3RhdGUob2ZmbGluZVN0YXRlLCBjYWxsYmFja3MpOyAgIAogIH0KIAogIC8vIFN1cHByZXNzIENvbnRhY3RzIGZ1bmN0aW9uIAogIC8vIFRoaXMgaXMgdXNlZCBieSBEaXNhc3RlciBSZWNvdmVyeSBhcyBhIHNhZmVndWFyZCB0byBub3Qgc3VyZmFjZSBpbmNvbWluZyBjYWxscy9jaGF0cyB0byBVSQogIC8vIAogIHZhciBzdXBwcmVzc0NvbnRhY3RzID0gZnVuY3Rpb24gKGlzU3VwcHJlc3NlZCkgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNpZ25hbCBzaGFyZWR3b3JrZXIgdG8gc2V0IGNvbnRhY3RzIHN1cHByZXNzb3IgdG8gJXMgZm9yIGluc3RhbmNlICVzLiIsIAogICAgICBpc1N1cHByZXNzZWQsIGNvbm5lY3QuY29yZS5yZWdpb24KICAgICkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU1VQUFJFU1MsIHsKICAgICAgc3VwcHJlc3M6IGlzU3VwcHJlc3NlZAogICAgfSk7CiAgfQogCiAgdmFyIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtID0gZnVuY3Rpb24ob2ZmbGluZSkgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbRElTQVNURVIgUkVDT1ZFUlldIFNpZ25hbCBzaGFyZWR3b3JrZXIgdG8gc2V0IGZvcmNlT2ZmbGluZSB0byAlcyBmb3IgaW5zdGFuY2UgJXMuIiwgCiAgICAgIG9mZmxpbmUsIGNvbm5lY3QuY29yZS5yZWdpb24KICAgICkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgewogICAgICBvZmZsaW5lOiBvZmZsaW5lCiAgICB9KTsKICB9CiAKICAvLyBGb3JjZSB0aGUgaW5zdGFuY2UgdG8gYmUgb2ZmbGluZS4gCiAgLy8gVGhpcyB0cmllcyB0byBkaXNjb25uZWN0IGFsbCBjb250YWN0cyAoSGFyZCBzdG9wKQogIC8vIGlmIGR1ZSB0byBhIGZhaWx1cmUgKHRoZSBiYWNrZW5kIGlzIG5vdCByZWFjaGFibGUpLCBzaWduYWwgdGhlIHNoYXJlZCB3b3JrZXIgdG8gZm9yY2Vfb2ZmbGluZSB3aGVuIGl0IHdha2VzIHVwIGFnYWluCiAgLy8gVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSByYW4gZnJvbSBuYXRpdmUgQ0NQIGZvciBkaXNjb25uZWN0aW5nIGNoYXRzLgogIHZhciBmb3JjZU9mZmxpbmUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gQXR0ZW1wdGluZyB0byBmb3JjZSBpbnN0YW5jZSAlcyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24oYWdlbnQpIHsKICAgICAgdmFyIGNvbnRhY3RDbG9zZWQgPSAwOwogICAgICB2YXIgY29udGFjdHMgPSBhZ2VudC5nZXRDb250YWN0cygpOwogICAgICBpZiAoY29udGFjdHMubGVuZ3RoKSB7CiAgICAgICAgY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbihjb250YWN0KSAKICAgICAgICAgIHsKICAgICAgICAgICAgY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5kZXN0cm95KHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIGFsbCBhY3RpdmUgY29udGFjdHMgYXJlIGNsb3NlZAogICAgICAgICAgICAgICAgaWYgKCsrY29udGFjdENsb3NlZCA9PT0gY29udGFjdHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgLy8gSXQncyBvayBpZiB3ZSdyZSBub3QgYWJsZSB0byBwdXQgdGhlIGFnZW50IG9mZmxpbmUuIAogICAgICAgICAgICAgICAgICAvLyBzaW5jZSB3ZSdyZSBzdXBwcmVzc2luZyB0aGUgYWdlbnRzIGNvbnRhY3RzIGFscmVhZHkuIAogICAgICAgICAgICAgICAgICBtYWtlQWdlbnRPZmZsaW5lKGFnZW50KTsKICAgICAgICAgICAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5zdGFuY2UgJXMgaXMgbm93IG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBsb2cud2FybigiW0Rpc2FzdGVyIFJlY292ZXJ5XSBBbiBlcnJvciBvY2N1cmVkIHdoaWxlIGF0dGVtcHRpbmcgdG8gZm9yY2UgdGhpcyBpbnN0YW5jZSB0byBvZmZsaW5lIGluIHJlZ2lvbiAlcyIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBsb2cud2FybihlcnIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAvLyBzaWduYWwgdGhlIHNoYXJlZHdvcmtlciB0byBjYWxsIGZvcmNlT2ZmbGluZSBhZ2FpbiB3aGVuIG5ldHdvcmsgY29ubmVjdGlvbiAKICAgICAgICAgICAgICAgIC8vIGhhcyBiZWVuIHJlLWVzdGFibGlzaGVkICh0aGlzIGhhcHBlbnMgaW4gY2FzZSBvZiBuZXR3b3JrIG9yIGJhY2tlbmQgZmFpbHVyZXMpCiAgICAgICAgICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbSh0cnVlKTsKICAgICAgICAgICAgfX0pOwogICAgICAgICAgfQogICAgICAgICkgICAgICAgIAogICAgICB9IGVsc2UgewogICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKGZhbHNlKTsKICAgICAgICBtYWtlQWdlbnRPZmZsaW5lKGFnZW50KTsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbnN0YW5jZSAlcyBpcyBub3cgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH0KIAogIC8vSW5pdGlhdGUgRGlzYXN0ZXIgUmVjb3ZlcnkgKFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGZyb20gY3VzdG9tQ0NQIHRoYXQgYXJlIERSIGVuYWJsZWQpCiAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKICAgIGNvbm5lY3QuY29yZS5yZWdpb24gPSBwYXJhbXMucmVnaW9uOwogICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMgPSBzdXBwcmVzc0NvbnRhY3RzOyAgCiAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lID0gZm9yY2VPZmZsaW5lOwoKICAgIC8vUmVnaXN0ZXIgaWZyYW1lIGxpc3RuZXIgdG8gc2V0IG5hdGl2ZSBDQ1Agb2ZmbGluZQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TRVRfT0ZGTElORSwgZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgIH0pOwogCiAgICAvLyBSZWdpc3RlciBFdmVudCBsaXN0bmVyIHRvIEZvcmNlIHRoZSBBZ2VudCB0byBiZSBvZmZsaW5lIHdoZW4gc2hhcmVkIHdvcmtlciByZWNvdmVycyBmcm9tIG5ldHdvcmsgZmFpbHVyZQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCAKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5pdGlhbGl6aW5nIHJlZ2lvbiAlcyBhcyBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LCAKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgYWxyZWFkeSBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKCiAgICBpZiAoIXBhcmFtcy5pc1ByaW1hcnkpIHsKICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHModHJ1ZSk7CiAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUoKTsKICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgaW5zdGFuY2UgaXMgc2V0IHRvIHN0YW5kLWJ5IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzKGZhbHNlKTsKICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gJXMgaW5zdGFuY2UgaXMgc2V0IHRvIHByaW1hcnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBCYXNpYyBDb25uZWN0IGNsaWVudCBpbml0aWFsaXphdGlvbi4KICAgKiBTaG91bGQgYmUgdXNlZCBvbmx5IGJ5IHRoZSBBUEkgU2hhcmVkIFdvcmtlci4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuY29yZS5ldmVudEJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQocGFyYW1zKTsKICAgIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQocGFyYW1zKTsKICAgIGNvbm5lY3QuY29yZS5pbml0VGFza1RlbXBsYXRlc0NsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVkIEFXUyBjbGllbnQKICAgKiBTaG91bGQgYmUgdXNlZCBieSBTaGFyZWQgV29ya2VyIHRvIHVwZGF0ZSBBV1MgY2xpZW50IHdpdGggbmV3IGNyZWRlbnRpYWxzCiAgICogYWZ0ZXIgcmVmcmVzaGVkIGF1dGhlbnRpY2F0aW9uLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOwogICAgCiAgICB2YXIgYXV0aFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW4sICdwYXJhbXMuYXV0aFRva2VuJyk7CiAgICB2YXIgcmVnaW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5yZWdpb24sICdwYXJhbXMucmVnaW9uJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMuZW5kcG9pbnQgfHwgbnVsbDsKIAogICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LkFXU0NsaWVudChhdXRoVG9rZW4sIHJlZ2lvbiwgZW5kcG9pbnQpOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplZCBBZ2VudEFwcCBjbGllbnQKICAgKiBTaG91bGQgYmUgdXNlZCBieSBTaGFyZWQgV29ya2VyIHRvIHVwZGF0ZSBBZ2VudEFwcCBjbGllbnQgd2l0aCBuZXcgY3JlZGVudGlhbHMKICAgKiBhZnRlciByZWZyZXNoZWQgYXV0aGVudGljYXRpb24uCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsgICAgCiAgICB2YXIgYXV0aFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW4sICdwYXJhbXMuYXV0aFRva2VuJyk7CiAgICB2YXIgYXV0aENvb2tpZU5hbWUgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhDb29raWVOYW1lLCAncGFyYW1zLmF1dGhDb29raWVOYW1lJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmFnZW50QXBwRW5kcG9pbnQsICdwYXJhbXMuYWdlbnRBcHBFbmRwb2ludCcpOwogICAgCiAgICBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQgPSBuZXcgY29ubmVjdC5BZ2VudEFwcENsaWVudChhdXRoQ29va2llTmFtZSwgYXV0aFRva2VuLCBlbmRwb2ludCk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVkIFRhc2tUZW1wbGF0ZXMgY2xpZW50CiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRUYXNrVGVtcGxhdGVzQ2xpZW50ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLnRhc2tUZW1wbGF0ZXNFbmRwb2ludCB8fCBwYXJhbXMuZW5kcG9pbnQ7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZW5kcG9pbnQsICd0YXNrVGVtcGxhdGVzRW5kcG9pbnQnKTsKICAgIGNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50ID0gbmV3IGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudChlbmRwb2ludCk7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBVbmluaXRpYWxpemUgQ29ubmVjdC4KICAgKi8KICBjb25uZWN0LmNvcmUudGVybWluYXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIGNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGlmIChidXMpIGJ1cy51bnN1YnNjcmliZUFsbCgpOwogICAgY29ubmVjdC5jb3JlLmJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBudWxsOwogICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBudWxsOwogICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyID0gbnVsbDsKICAgIGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IGZhbHNlOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogU2V0dXAgdGhlIFNvZnRwaG9uZU1hbmFnZXIgdG8gYmUgaW5pdGlhbGl6ZWQgd2hlbiB0aGUgYWdlbnQKICAgKiBpcyBkZXRlcm1pbmVkIHRvIGhhdmUgc29mdHBob25lIGVuYWJsZWQuCiAgICovCiAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IG51bGw7CiAKICBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW07CiAgfTsKIAogIGNvbm5lY3QuY29yZS5zZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gc3RyZWFtOwogIH07CiAKICBjb25uZWN0LmNvcmUuaW5pdFJpbmd0b25lRW5naW5lcyA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICJwYXJhbXMiKTsKIAogICAgdmFyIHNldHVwUmluZ3RvbmVFbmdpbmVzID0gZnVuY3Rpb24gKHJpbmd0b25lU2V0dGluZ3MpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3MsICJyaW5ndG9uZVNldHRpbmdzIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZVNldHRpbmdzLnZvaWNlLCAicmluZ3RvbmVTZXR0aW5ncy52b2ljZSIpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUocmluZ3RvbmVTZXR0aW5ncy52b2ljZS5yaW5ndG9uZVVybCB8fCByaW5ndG9uZVNldHRpbmdzLnZvaWNlLmRpc2FibGVkLCAicmluZ3RvbmVTZXR0aW5ncy52b2ljZS5yaW5ndG9uZVVybCBtdXN0IGJlIHByb3ZpZGVkIG9yIHJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQgbXVzdCBiZSB0cnVlIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLCAicmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjayIpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5yaW5ndG9uZVVybCB8fCByaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkLCAicmluZ3RvbmVTZXR0aW5ncy52b2ljZS5yaW5ndG9uZVVybCBtdXN0IGJlIHByb3ZpZGVkIG9yIHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2suZGlzYWJsZWQgbXVzdCBiZSB0cnVlIik7CiAKICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcyA9IHt9OwogCiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgYWdlbnQub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuUklOR1RPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLnZvaWNlLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnZvaWNlKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy52b2ljZSA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5Wb2ljZVJpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UpOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiVm9pY2VSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLmNoYXQuZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMuY2hhdCkgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMuY2hhdCA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5DaGF0UmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy5jaGF0KTsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNoYXRSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLnRhc2suZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudGFzaykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudGFzayA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5UYXNrUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy50YXNrKTsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiVGFza1Jpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2suZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMucXVldWVfY2FsbGJhY2spIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnF1ZXVlX2NhbGxiYWNrID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrKTsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICBoYW5kbGVSaW5nZXJEZXZpY2VDaGFuZ2UoKTsKICAgIH07CiAKICAgIHZhciBtZXJnZVBhcmFtcyA9IGZ1bmN0aW9uIChwYXJhbXMsIG90aGVyUGFyYW1zKSB7CiAgICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eTogc3VwcG9ydCBwdWxsaW5nIGRpc2FibGVkIGZsYWcgYW5kIHJpbmd0b25lVXJsCiAgICAgIC8vIGZyb20gc29mdHBob25lIGNvbmZpZyBpZiBpdCBleGlzdHMgZnJvbSBkb3duc3RyZWFtIGludG8gdGhlIHJpbmd0b25lIGNvbmZpZy4KICAgICAgcGFyYW1zLnJpbmd0b25lID0gcGFyYW1zLnJpbmd0b25lIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UgPSBwYXJhbXMucmluZ3RvbmUudm9pY2UgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjayA9IHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjayB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQgPSBwYXJhbXMucmluZ3RvbmUuY2hhdCB8fCB7IGRpc2FibGVkOiB0cnVlIH07CiAgICAgIHBhcmFtcy5yaW5ndG9uZS50YXNrID0gcGFyYW1zLnJpbmd0b25lLnRhc2sgfHwgeyBkaXNhYmxlZDogdHJ1ZSB9OwogCiAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUpIHsKICAgICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lLmRpc2FibGVSaW5ndG9uZSkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgfQogCiAgICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybCkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlLnJpbmd0b25lVXJsID0gb3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsOwogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLnJpbmd0b25lVXJsID0gb3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsOwogICAgICAgIH0KICAgICAgfQogCiAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0KSB7CiAgICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQuZGlzYWJsZVJpbmd0b25lKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdC5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgfQogCiAgICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQucmluZ3RvbmVVcmwpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0LnJpbmd0b25lVXJsID0gb3RoZXJQYXJhbXMuY2hhdC5yaW5ndG9uZVVybDsKICAgICAgICB9CiAgICAgIH0KIAogICAgICAvLyBNZXJnZSBpbiByaW5ndG9uZSBzZXR0aW5ncyBmcm9tIGRvd25zdHJlYW0uCiAgICAgIGlmIChvdGhlclBhcmFtcy5yaW5ndG9uZSkgewogICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZSA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLnZvaWNlLAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUudm9pY2UgfHwge30pOwogICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjayA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUudm9pY2UgfHwge30pOwogICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0ID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUuY2hhdCwKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLmNoYXQgfHwge30pOwogICAgICB9CiAgICB9OwogCiAgICAvLyBNZXJnZSBwYXJhbXMgZnJvbSBwYXJhbXMuc29mdHBob25lIGFuZCBwYXJhbXMuY2hhdCBpbnRvIHBhcmFtcy5yaW5ndG9uZQogICAgLy8gZm9yIGVtYmVkZGVkIGFuZCBub24tZW1iZWRkZWQgdXNlIGNhc2VzIHNvIHRoYXQgZGVmYXVsdHMgYXJlIHBpY2tlZCB1cC4KICAgIG1lcmdlUGFyYW1zKHBhcmFtcywgcGFyYW1zKTsKIAogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAvLyBJZiB0aGUgQ0NQIGlzIGluIGEgZnJhbWUsIHdhaXQgZm9yIGNvbmZpZ3VyYXRpb24gZnJvbSBkb3duc3RyZWFtLgogICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAvLyBNZXJnZSBhbGwgcGFyYW1zIGZyb20gZGF0YSBpbnRvIHBhcmFtcyBmb3IgYW55IG92ZXJyaWRkZW4KICAgICAgICAvLyB2YWx1ZXMgaW4gZWl0aGVyIGxlZ2FjeSAic29mdHBob25lIiBvciAicmluZ3RvbmUiIHNldHRpbmdzLgogICAgICAgIG1lcmdlUGFyYW1zKHBhcmFtcywgZGF0YSk7CiAgICAgICAgc2V0dXBSaW5ndG9uZUVuZ2luZXMocGFyYW1zLnJpbmd0b25lKTsKICAgICAgfSk7CiAKICAgIH0gZWxzZSB7CiAgICAgIHNldHVwUmluZ3RvbmVFbmdpbmVzKHBhcmFtcy5yaW5ndG9uZSk7CiAgICB9CiAgfTsKCiAgdmFyIGhhbmRsZVJpbmdlckRldmljZUNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX1JJTkdFUl9ERVZJQ0UsIHNldFJpbmdlckRldmljZSk7CiAgfQoKICB2YXIgc2V0UmluZ2VyRGV2aWNlID0gZnVuY3Rpb24gKGRhdGEpewogICAgaWYoY29ubmVjdC5rZXlzKGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMpLmxlbmd0aCA9PT0gMCB8fCAhZGF0YSB8fCAhZGF0YS5kZXZpY2VJZCl7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkZXZpY2VJZCA9IGRhdGEuZGV2aWNlSWQ7CiAgICBmb3IgKHZhciByaW5ndG9uZVR5cGUgaW4gY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcykgewogICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzW3Jpbmd0b25lVHlwZV0uc2V0T3V0cHV0RGV2aWNlKGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuUklOR0VSX0RFVklDRV9DSEFOR0VELAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9CgogIGNvbm5lY3QuY29yZS5pbml0U29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGluaXRTb2Z0cGhvbmVNYW5hZ2VyIHN0YXJ0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogCiAgICB2YXIgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUgPSBmdW5jdGlvbiAoc29mdHBob25lUGFyYW1zSW4pIHsKICAgICAgdmFyIHNvZnRwaG9uZVBhcmFtcyA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnNvZnRwaG9uZSB8fCB7fSwgc29mdHBob25lUGFyYW1zSW4pOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgIGlmICghYWdlbnQuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5KGNvbm5lY3QuQ2hhbm5lbFR5cGUuVk9JQ0UpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGFnZW50Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgc3ViID0gdGhpczsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBhZ2VudCByZWZyZXNoIGhhbmRsZXIgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogCiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gY29uZmlybWVkIGFzIHNvZnRwaG9uZSBtYXN0ZXIgdG9waWMiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICBpZiAoIWNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyICYmIGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgLy8gQmVjb21lIG1hc3RlciB0byBzZW5kIGxvZ3MsIHNpbmNlIHdlIG5lZWQgbG9ncyBmcm9tIHNvZnRwaG9uZSB0YWIuCiAgICAgICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIoc29mdHBob25lUGFyYW1zKTsKICAgICAgICAgICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfTsKIAogICAgLyoqCiAgICAgKiBJZiB0aGUgd2luZG93IGlzIGZyYW1lZCwgd2UgbmVlZCB0byB3YWl0IGZvciBhIENPTkZJR1VSRSBtZXNzYWdlIGZyb20KICAgICAqIGRvd25zdHJlYW0gYmVmb3JlIHdlIHRyeSB0byBpbml0aWFsaXplLCB1bmxlc3MgcGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lIGlzIHRydWUuCiAgICAgKi8KICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgIXBhcmFtcy5hbGxvd0ZyYW1lZFNvZnRwaG9uZSkgewogICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBDb25maWd1cmUgZXZlbnQgaGFuZGxlciBleGVjdXRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgaWYgKGRhdGEuc29mdHBob25lICYmIGRhdGEuc29mdHBob25lLmFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZShkYXRhLnNvZnRwaG9uZSk7CiAgICAgICAgICAKICAgICAgICB9CiAgICAgICAgc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KGRhdGEuc29mdHBob25lKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZShwYXJhbXMpOwogICAgICBzZXR1cEV2ZW50TGlzdGVuZXJzRm9yTXVsdGlUYWJVc2VJbkZpcmVmb3gocGFyYW1zKTsKICAgIH0KIAogICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgLy8gU3luYyBtdXRlIGFjcm9zcyBhbGwgdGFicyAKICAgICAgaWYgKGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpICYmIGFnZW50LmdldENoYW5uZWxDb25jdXJyZW5jeShjb25uZWN0LkNoYW5uZWxUeXBlLlZPSUNFKSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFCiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgZnVuY3Rpb24gc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KHNvZnRwaG9uZVBhcmFtc0luKSB7CiAgICAgIHZhciBzb2Z0cGhvbmVQYXJhbXMgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5zb2Z0cGhvbmUgfHwge30sIHNvZnRwaG9uZVBhcmFtc0luKTsKCiAgICAgIC8vIGtlZXAgdGhlIHNvZnRwaG9uZSBwYXJhbXMgZm9yIGV4dGVybmFsIHVzZQogICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zID0gc29mdHBob25lUGFyYW1zOwoKICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpKSB7CiAgICAgICAgLy8gSW4gRmlyZWZveCwgd2hlbiBhIHRhYiB0YWtlcyBvdmVyIGFub3RoZXIgdGFiJ3Mgc29mdHBob25lIHByaW1hcnksCiAgICAgICAgLy8gdGhlIHByZXZpb3VzIHByaW1hcnkgdGFiIHNob3VsZCBkZWxldGUgc29mcGhvbmUgbWFuYWdlciBhbmQgc3RvcCBtaWNyb3Bob25lCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMuZGF0YSAmJiByZXMuZGF0YS50b3BpYyA9PT0gY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FICYmIHJlcy5kYXRhLnRha2VPdmVyICYmIChyZXMuZGF0YS5tYXN0ZXJJZCAhPT0gY29ubmVjdC5jb3JlLnBvcnRTdHJlYW1JZCkpIHsKICAgICAgICAgICAgaWYgKGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIub25Jbml0Q29udGFjdFN1Yi51bnN1YnNjcmliZSgpOwogICAgICAgICAgICAgIGRlbGV0ZSBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdXNlck1lZGlhU3RyZWFtID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpOwogICAgICAgICAgICBpZiAodXNlck1lZGlhU3RyZWFtKSB7CiAgICAgICAgICAgICAgdXNlck1lZGlhU3RyZWFtLmdldFRyYWNrcygpLmZvckVhY2goZnVuY3Rpb24odHJhY2spIHsgdHJhY2suc3RvcCgpOyB9KTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIEluIEZpcmVmb3gsIHdoZW4gbXVsdGlwbGUgdGFicyBhcmUgb3BlbiwKICAgICAgICAvLyB3ZWJydGMgc2Vzc2lvbiBpcyBub3Qgc3RhcnRlZCB1bnRpbCBSRUFEWV9UT19TVEFSVF9TRVNTSU9OIGV2ZW50IGlzIHRyaWdnZXJlZAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIuc3RhcnRTZXNzaW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICAgICAgICAgIGlmICghY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgJiYgYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkpIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyKHNvZnRwaG9uZVBhcmFtcyk7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLnN0YXJ0U2Vzc2lvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBoYW5kbGluZyBvdXRib3VuZC1jYWxsIGFuZCBhdXRvLWFjY2VwdCBjYXNlcyBmb3IgcGVuZGluZyBzZXNzaW9uCiAgICAgICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgICAgICBjLm9uUmVmcmVzaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzKCkgJiYKICAgICAgICAgICAgICAgIGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gJ3Zpc2libGUnICYmCiAgICAgICAgICAgICAgICAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgfHwgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIGlzT3V0Qm91bmRDYWxsID0gY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiAhY29udGFjdC5pc0luYm91bmQoKTsKICAgICAgICAgICAgICAgIHZhciBpc0F1dG9BY2NlcHRFbmFibGVkID0gY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiBhZ2VudC5nZXRDb25maWd1cmF0aW9uKCkuc29mdHBob25lQXV0b0FjY2VwdDsKICAgICAgICAgICAgICAgIHZhciBpc1F1ZXVlZENhbGxiYWNrID0gY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuUVVFVUVfQ0FMTEJBQ0s7CiAgICAgICAgICAgICAgICBpZiAoaXNPdXRCb3VuZENhbGwgfHwgaXNBdXRvQWNjZXB0RW5hYmxlZCB8fCBpc1F1ZXVlZENhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gdHJpZ2dlciBSRUFEWV9UT19TVEFSVF9TRVNTSU9OIGV2ZW50IGluIGEgY29udGV4dCB3aXRoIFNvZnRwaG9uZSBNYW5hZ2VyCiAgLy8gaW50ZXJuYWwgdXNlIG9ubHkKICBjb25uZWN0LmNvcmUudHJpZ2dlclJlYWR5VG9TdGFydFNlc3Npb25FdmVudCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhbGxvd0ZyYW1lZFNvZnRwaG9uZSA9IGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMgJiYgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcy5hbGxvd0ZyYW1lZFNvZnRwaG9uZTsKICAgIGlmIChjb25uZWN0LmlzQ0NQKCkpIHsKICAgICAgaWYgKGFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgLy8gdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBpbiB0aGlzIGlmcmFtZWQgQ0NQIGNvbnRleHQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgICAgICAvLyBpZiB0aGlzIGlzIGFuIGlmcmFtZWQgQ0NQLCB0aGUgZXZlbnQgaXMgc2VuZCB0byBkb3duc3RyZWFtIChDUk0pCiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kRG93bnN0cmVhbShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGlmIHRoaXMgaXMgYSBzdGFuZGFsb25lIENDUCwgdHJpZ2dlciB0aGlzIGV2ZW50IGluIHRoaXMgQ0NQIGNvbnRleHQKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgLy8gdGhlIGV2ZW50IGlzIHNlbmQgdG8gdGhlIHVwc3RyZWFtIChpZnJhbWVkIENDUCkKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgaW4gdGhpcyBDUk0gY29udGV4dAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICB9CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb3JlLmluaXRQYWdlT3B0aW9ucyA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICJwYXJhbXMiKTsKICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgLy8gSWYgdGhlIENDUCBpcyBpbiBhIGZyYW1lLCB3YWl0IGZvciBjb25maWd1cmF0aW9uIGZyb20gZG93bnN0cmVhbS4KICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULAogICAgICAgICAgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLkNPTkZJR1VSRSwKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICAvLyBMaXN0ZW4gZm9yIGlmcmFtZSBtZWRpYSBkZXZpY2VzIHJlcXVlc3QgZnJvbSBDUk0KICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVRVUVTVCwgZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIHNlbmREZXZpY2VzKGRldmljZXMpIHsKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVNQT05TRSwgZGV2aWNlcyk7CiAgICAgICAgfQogICAgICAgIGlmIChuYXZpZ2F0b3IgJiYgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcykgewogICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKCkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkZXZpY2VzSW4pIHsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXNJbiB8fCBbXTsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXMubWFwKGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQudG9KU09OKCkgfSk7CiAgICAgICAgICAgIHNlbmREZXZpY2VzKGRldmljZXMpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIHNlbmREZXZpY2VzKHtlcnJvcjogZXJyLm1lc3NhZ2V9KTsKICAgICAgICAgIH0pOyAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VuZERldmljZXMoe2Vycm9yOiAiTm8gbmF2aWdhdG9yIG9yIG5hdmlnYXRvci5tZWRpYURldmljZXMgb2JqZWN0IGZvdW5kIn0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEdldCB0aGUgbGlzdCBvZiBtZWRpYSBkZXZpY2VzIGZyb20gaWZyYW1lZCBDQ1AKICAgKiBUaW1lb3V0IGZvciB0aGUgcmVxdWVzdCBpcyBwYXNzZWQgb24gYW4gb3B0aW9uYWwgYXJndW1lbnQKICAgKiBUaGUgZGVmYXVsdCB0aW1lb3V0IGlzIDEwMDBtcwogICAqLwogIGNvbm5lY3QuY29yZS5nZXRGcmFtZU1lZGlhRGV2aWNlcyA9IGZ1bmN0aW9uICh0aW1lb3V0SW4pIHsKICAgIHZhciBzdWIgPSBudWxsOwogICAgdmFyIHRpbWVvdXQgPSB0aW1lb3V0SW4gfHwgMTAwMDsKICAgIHZhciB0aW1lb3V0UHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IAogICAgICAgIHJlamVjdChuZXcgRXJyb3IoIlRpbWVvdXQgZXhjZWVkZWQiKSk7IAogICAgICB9LCB0aW1lb3V0KTsKICAgIH0pOwogICAgdmFyIG1lZGlhRGV2aWNlc1Byb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IAogICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpIHx8IGNvbm5lY3QuaXNDQ1AoKSkgewogICAgICAgIGlmIChuYXZpZ2F0b3IgJiYgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcykgewogICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKCkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkZXZpY2VzSW4pIHsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXNJbiB8fCBbXTsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXMubWFwKGZ1bmN0aW9uIChkKSB7IHJldHVybiBkLnRvSlNPTigpIH0pOwogICAgICAgICAgICByZXNvbHZlKGRldmljZXMpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoIk5vIG5hdmlnYXRvciBvciBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzIG9iamVjdCBmb3VuZCIpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICAgIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFU1BPTlNFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEuZXJyb3IpIHsKICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihkYXRhLmVycm9yKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVRVUVTVCk7CiAgICAgIH0KICAgIH0pCiAgICByZXR1cm4gUHJvbWlzZS5yYWNlKFttZWRpYURldmljZXNQcm9taXNlLCB0aW1lb3V0UHJvbWlzZV0pCiAgICAuZmluYWxseShmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChzdWIpIHsKICAgICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvL0ludGVybmFsIHVzZSBvbmx5LgogIGNvbm5lY3QuY29yZS5hdXRob3JpemUgPSBmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgIHZhciBvcHRpb25zID0gewogICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnCiAgICB9OwoKICAgIHZhciBhdXRob3JpemVFbmRwb2ludCA9IGVuZHBvaW50OwogICAgaWYgKCFhdXRob3JpemVFbmRwb2ludCkgewogICAgICBhdXRob3JpemVFbmRwb2ludCA9IGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbigpCiAgICAgICAgPyBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UCiAgICAgICAgOiBBVVRIT1JJWkVfRU5EUE9JTlQ7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5mZXRjaChhdXRob3JpemVFbmRwb2ludCwgb3B0aW9ucywgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMLCBBVVRIT1JJWkVfTUFYX1JFVFJZKTsKICB9OwogCiAgLyoqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBUaGlzIHVzZWQgdG8gYmUgdXNlZCBpbnRlcm5hbGx5LCBidXQgaXMgbm8gbG9uZ2VyIG5lZWRlZC4KICAgKi8KICBjb25uZWN0LmNvcmUudmVyaWZ5RG9tYWluQWNjZXNzID0gZnVuY3Rpb24gKGF1dGhUb2tlbiwgZW5kcG9pbnQpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhpcyBBUEkgd2lsbCBiZSBkZXByZWNhdGVkIGluIHRoZSBuZXh0IG1ham9yIHZlcnNpb24gcmVsZWFzZSIpOwogICAgaWYgKCFjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwogICAgfQogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIGhlYWRlcnM6IHsKICAgICAgICAnWC1BbXotQmVhcmVyJzogYXV0aFRva2VuCiAgICAgIH0KICAgIH07CiAgICB2YXIgd2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQgPSBudWxsOwogICAgaWYgKGVuZHBvaW50KXsKICAgICAgd2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQgPSBlbmRwb2ludDsKICAgIH0KICAgIGVsc2UgewogICAgICB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbigpIAogICAgICAgID8gTEVHQUNZX1dISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQKICAgICAgICA6IFdISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQ7CiAgICB9CiAgICAKICAgIHJldHVybiBjb25uZWN0LmZldGNoKHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50LCBvcHRpb25zLCBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMLCBXSElURUxJU1RFRF9PUklHSU5TX01BWF9SRVRSWSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgdmFyIHRvcERvbWFpbiA9IHNhbml0aXplRG9tYWluKHdpbmRvdy5kb2N1bWVudC5yZWZlcnJlcik7CiAgICAgIHZhciBpc0FsbG93ZWQgPSByZXNwb25zZS53aGl0ZWxpc3RlZE9yaWdpbnMuc29tZShmdW5jdGlvbiAob3JpZ2luKSB7CiAgICAgICAgcmV0dXJuIHRvcERvbWFpbiA9PT0gc2FuaXRpemVEb21haW4ob3JpZ2luKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBpc0FsbG93ZWQgPyBQcm9taXNlLnJlc29sdmUoKSA6IFByb21pc2UucmVqZWN0KCk7CiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogUmV0dXJucyB0cnVlIGlmIHRoaXMgd2luZG93J3MgaHJlZiBpcyBvbiB0aGUgbGVnYWN5IGNvbm5lY3QgZG9tYWluLiAKICAgKiBPbmx5IHVzZWZ1bCBmb3IgaW50ZXJuYWwgdXNlLiAKICAgKi8KICBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4gPSBmdW5jdGlvbih1cmwpIHsKICAgIHVybCA9IHVybCB8fCB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgIHJldHVybiB1cmwuaW5jbHVkZXMoJy5hd3NhcHBzLmNvbScpOwogIH0KIAoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZXMgQ29ubmVjdCBieSBjcmVhdGluZyBvciBjb25uZWN0aW5nIHRvIHRoZSBBUEkgU2hhcmVkIFdvcmtlci4KICAgKiBVc2VkIG9ubHkgYnkgdGhlIENDUAogICAqLwogIGNvbm5lY3QuY29yZS5pbml0U2hhcmVkV29ya2VyID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQoKTsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOwogCiAgICB2YXIgc2hhcmVkV29ya2VyVXJsID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5zaGFyZWRXb3JrZXJVcmwsICdwYXJhbXMuc2hhcmVkV29ya2VyVXJsJyk7CiAgICB2YXIgYXV0aFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW4sICdwYXJhbXMuYXV0aFRva2VuJyk7CiAgICB2YXIgcmVmcmVzaFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5yZWZyZXNoVG9rZW4sICdwYXJhbXMucmVmcmVzaFRva2VuJyk7CiAgICB2YXIgYXV0aFRva2VuRXhwaXJhdGlvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuRXhwaXJhdGlvbiwgJ3BhcmFtcy5hdXRoVG9rZW5FeHBpcmF0aW9uJyk7CiAgICB2YXIgcmVnaW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5yZWdpb24sICdwYXJhbXMucmVnaW9uJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMuZW5kcG9pbnQgfHwgbnVsbDsKICAgIHZhciBhdXRob3JpemVFbmRwb2ludCA9IHBhcmFtcy5hdXRob3JpemVFbmRwb2ludDsKICAgIGlmICghYXV0aG9yaXplRW5kcG9pbnQpIHsKICAgICAgYXV0aG9yaXplRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKQogICAgICAgID8gTEVHQUNZX0FVVEhPUklaRV9FTkRQT0lOVAogICAgICAgIDogQVVUSE9SSVpFX0VORFBPSU5UOwogICAgfQogICAgdmFyIGFnZW50QXBwRW5kcG9pbnQgPSBwYXJhbXMuYWdlbnRBcHBFbmRwb2ludCB8fCBudWxsOwogICAgdmFyIHRhc2tUZW1wbGF0ZXNFbmRwb2ludCA9IHBhcmFtcy50YXNrVGVtcGxhdGVzRW5kcG9pbnQgfHwgbnVsbDsKICAgIHZhciBhdXRoQ29va2llTmFtZSA9IHBhcmFtcy5hdXRoQ29va2llTmFtZSB8fCBudWxsOwogCiAgICB0cnkgewogICAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cyh7IGxvZ0V2ZW50czogdHJ1ZSB9KTsKICAgICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeSA9IG5ldyBjb25uZWN0Lk1lZGlhRmFjdG9yeShwYXJhbXMpOwogICAgICAKICAgICAgLy8gQ3JlYXRlIHRoZSBzaGFyZWQgd29ya2VyIGFuZCB1cHN0cmVhbSBjb25kdWl0LgogICAgICB2YXIgd29ya2VyID0gbmV3IFNoYXJlZFdvcmtlcihzaGFyZWRXb3JrZXJVcmwsICJDb25uZWN0U2hhcmVkV29ya2VyIik7CiAgICAgIHZhciBjb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdCgiQ29ubmVjdFNoYXJlZFdvcmtlckNvbmR1aXQiLAogICAgICAgIG5ldyBjb25uZWN0LlBvcnRTdHJlYW0od29ya2VyLnBvcnQpLAogICAgICAgIG5ldyBjb25uZWN0LldpbmRvd0lPU3RyZWFtKHdpbmRvdywgcGFyZW50KSk7CiAKICAgICAgLy8gU2V0IHRoZSBnbG9iYWwgdXBzdHJlYW0gY29uZHVpdCBmb3IgZXh0ZXJuYWwgdXNlLgogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBjb25kdWl0OwogICAgICBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXIgPSBuZXcgV2ViU29ja2V0UHJvdmlkZXIoKTsKIAogICAgICAvLyBDbG9zZSBvdXIgcG9ydCB0byB0aGUgc2hhcmVkIHdvcmtlciBiZWZvcmUgdGhlIHdpbmRvdyBjbG9zZXMuCiAgICAgIGdsb2JhbC5vbnVubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DTE9TRSk7CiAgICAgICAgd29ya2VyLnBvcnQuY2xvc2UoKTsKICAgICAgfTsKIAogICAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoKGNvbmR1aXQpOwogICAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlRG93bnN0cmVhbUNsaWVudFNpZGVMb2dzUHVzaCgpOwogICAgICAvLyBCcmlkZ2UgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKICAgICAgLy8gUGFzcyBhbGwgdXBzdHJlYW0gbWVzc2FnZXMgKGZyb20gc2hhcmVkIHdvcmtlcikgZG93bnN0cmVhbSAodG8gQ0NQIGNvbnN1bWVyKS4KICAgICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbmR1aXQucGFzc0Rvd25zdHJlYW0oKSk7CgogICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgICAgLy8gQnJpZGdlIGFsbCBkb3duc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAgICAgICAgLy8gUGFzcyBhbGwgZG93bnN0cmVhbSBtZXNzYWdlcyAoZnJvbSBDQ1AgY29uc3VtZXIpIHVwc3RyZWFtICh0byBzaGFyZWQgd29ya2VyKS4KICAgICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICAgfQoKICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIHsKICAgICAgICBhdXRoVG9rZW46IGF1dGhUb2tlbiwKICAgICAgICBhdXRoVG9rZW5FeHBpcmF0aW9uOiBhdXRoVG9rZW5FeHBpcmF0aW9uLAogICAgICAgIGVuZHBvaW50OiBlbmRwb2ludCwKICAgICAgICByZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiwKICAgICAgICByZWdpb246IHJlZ2lvbiwKICAgICAgICBhdXRob3JpemVFbmRwb2ludDogYXV0aG9yaXplRW5kcG9pbnQsCiAgICAgICAgYWdlbnRBcHBFbmRwb2ludDogYWdlbnRBcHBFbmRwb2ludCwKICAgICAgICB0YXNrVGVtcGxhdGVzRW5kcG9pbnQ6IHRhc2tUZW1wbGF0ZXNFbmRwb2ludCwKICAgICAgICBhdXRoQ29va2llTmFtZTogYXV0aENvb2tpZU5hbWUsCiAgICAgICAgbG9uZ1BvbGxpbmdPcHRpb25zOiBwYXJhbXMubG9uZ1BvbGxpbmdPcHRpb25zIHx8IHVuZGVmaW5lZAogICAgICB9KTsKIAogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENvbm5lY3RTaGFyZWRXb3JrZXIhIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgIGNvbm5lY3QuY29yZS5fc2V0VGFiSWQoKTsKICAgICAgICBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkID0gZGF0YS5pZDsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIH0pOwogICAgICAvLyBBZGQgYWxsIHVwc3RyZWFtIGxvZyBlbnRyaWVzIHRvIG91ciBvd24gbG9nZ2VyLgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBHZXQgd29ya2VyIGxvZ3MKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlcihjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgfSk7CiAgICAgIC8vIEdldCBvdXRlciBjb250ZXh0IGxvZ3MKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgZnVuY3Rpb24gKGxvZ3MpIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmIEFycmF5LmlzQXJyYXkobG9ncykpIHsKICAgICAgICAgIGxvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlcihjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBHZXQgbG9nIGZyb20gb3V0ZXIgY29udGV4dAogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2cpIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmIGxvZy5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7IAogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nKSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGNvbm5lY3QuY29yZS5vbkF1dGhGYWlsKGNvbm5lY3QuaGl0Y2goY29ubmVjdC5jb3JlLCBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhGYWlsLCBwYXJhbXMubG9naW5FbmRwb2ludCB8fCBudWxsLCBhdXRob3JpemVFbmRwb2ludCkpOyAvLyBGb3IgYXV0aCByZXRyeSBsb2dpYyBvbiA0MDFzLgogICAgICBjb25uZWN0LmNvcmUub25BdXRob3JpemVTdWNjZXNzKGNvbm5lY3QuaGl0Y2goY29ubmVjdC5jb3JlLCBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZVN1Y2Nlc3MpKTsgLy8gRm9yIGF1dGggcmV0cnkgbG9naWMgb24gNDAxcy4KCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiVXNlciBBZ2VudDogIiArIG5hdmlnYXRvci51c2VyQWdlbnQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiaXNDQ1B2MjogIiArIHRydWUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiaXNGcmFtZWQ6ICIgKyBjb25uZWN0LmlzRnJhbWVkKCkpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbS5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuT1VURVJfQ09OVEVYVF9JTkZPLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciBzdHJlYW1zVmVyc2lvbiA9IGRhdGEuc3RyZWFtc1ZlcnNpb247CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTdHJlYW1zSlMgVmVyc2lvbjogIiArIHN0cmVhbXNWZXJzaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJOdW1iZXIgb2YgY29ubmVjdGVkIENDUHMgdXBkYXRlZDogIiArIGRhdGEubGVuZ3RoKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gZGF0YS5sZW5ndGg7CiAgICAgICAgaWYgKGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXSAmJiAhaXNOYU4oZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdLmxlbmd0aCkpewogICAgICAgICAgaWYgKGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiICE9PSBkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0ubGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID0gZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID4gMSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhlcmUgYXJlICIgKyBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiArICIgY29ubmVjdGVkIENDUHMgaW4gdGhpcyB0YWIuIFBsZWFzZSBhZGp1c3QgeW91ciBpbXBsZW1lbnRhdGlvbiB0byBhdm9pZCBjb21wbGljYXRpb25zLiBJZiB5b3UgYXJlIGVtYmVkZGluZyBDQ1AsIHBsZWFzZSBkbyBzbyBleGNsdXNpdmVseSB3aXRoIGluaXRDQ1AuIEluaXRDQ1Agd2lsbCBub3QgbGV0IHlvdSBlbWJlZCBtb3JlIHRoYW4gb25lIENDUC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgICAgbmFtZTogQ09OTkVDVEVEX0NDUFNfU0lOR0xFX1RBQiwKICAgICAgICAgICAgICBkYXRhOiB7IGNvdW50OiBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYn0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkYXRhLnRhYklkICYmIGRhdGEuc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLk1FVFJJQ1MsICgpID0+CiAgICAgICAgICAgIGNvbm5lY3QuYWdlbnQoKCkgPT4gY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgICBuYW1lOiBDQ1BfVEFCU19BQ1JPU1NfQlJPV1NFUl9DT1VOVCwKICAgICAgICAgICAgICBkYXRhOiB7IHRhYklkOiBkYXRhLnRhYklkLCBjb3VudDogZGF0YS5zdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgfQogICAgICAgICAgICB9KSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQoY29uZHVpdCk7CiAKICAgICAgLy8gUGFzcyB0aGUgVEVSTUlOQVRFIHJlcXVlc3QgdXBzdHJlYW0gdG8gdGhlIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEUsCiAgICAgICAgY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAKICAgICAgLy8gUmVmcmVzaCB0aGUgcGFnZSB3aGVuIHdlIHJlY2VpdmUgdGhlIFRFUk1JTkFURUQgcmVzcG9uc2UgZnJvbSB0aGUKICAgICAgLy8gc2hhcmVkIHdvcmtlci4KICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsIGZ1bmN0aW9uICgpIHsKICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKHRydWUpOwogICAgICB9KTsKIAogICAgICB3b3JrZXIucG9ydC5zdGFydCgpOwoKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEuZG9tYWluSWQpIHsKICAgICAgICAgIGNvbm5lY3QuY29yZS52b2ljZUlkRG9tYWluSWQgPSBkYXRhLmRvbWFpbklkOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyB0cnkgZmV0Y2hpbmcgdm9pY2VJZCdzIGRvbWFpbklkIG9uY2UgdGhlIGFnZW50IGlzIGluaXRpYWxpemVkCiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB2b2ljZUlkID0gbmV3IGNvbm5lY3QuVm9pY2VJZCgpOwogICAgICAgIHZvaWNlSWQuZ2V0RG9tYWluSWQoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJ2b2ljZUlkIGRvbWFpbklkIHN1Y2Nlc3NmdWxseSBmZXRjaGVkIGF0IGFnZW50IGluaXRpYWxpemF0aW9uOiAiICsgZG9tYWluSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInZvaWNlSWQgZG9tYWluSWQgbm90IGZldGNoZWQgYXQgYWdlbnQgaW5pdGlhbGl6YXRpb24iKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIH0pOwogICAgICB9KTsKIAogICAgICAvLyBBdHRlbXB0IHRvIGdldCBwZXJtaXNzaW9uIHRvIHNob3cgbm90aWZpY2F0aW9ucy4KICAgICAgdmFyIG5tID0gY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgICAgbm0ucmVxdWVzdFBlcm1pc3Npb24oKTsKCiAgICAgIGNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5JTklUX0RJU0FTVEVSX1JFQ09WRVJZLCBmdW5jdGlvbihwYXJhbXMpIHsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdERpc2FzdGVyUmVjb3ZlcnkocGFyYW1zKTsKICAgICAgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGluaXRpYWxpemUgdGhlIEFQSSBzaGFyZWQgd29ya2VyLCB3ZSdyZSBkZWFkISIpCiAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBjb25uZWN0LmNvcmUuX3NldFRhYklkID0gZnVuY3Rpb24oKSB7CiAgICB0cnkgewogICAgICBjb25uZWN0LmNvcmUudGFiSWQgPSB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5UQUJfSUQpOwogICAgICBpZiAoIWNvbm5lY3QuY29yZS50YWJJZCl7CiAgICAgICAgY29ubmVjdC5jb3JlLnRhYklkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLlRBQl9JRCwgY29ubmVjdC5jb3JlLnRhYklkKTsKICAgICAgfQogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0uc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRBQl9JRCwge3RhYklkOiBjb25uZWN0LmNvcmUudGFiSWR9KTsKICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJbVGFiIElkXSBUaGVyZSB3YXMgYW4gaXNzdWUgc2V0dGluZyB0aGUgdGFiIElkIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgbG9hZGluZyB0aGUgQ0NQIGluIGFuIGlmcmFtZSBhbmQgY29ubmVjdGluZyB0byBpdC4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENDUCA9IGZ1bmN0aW9uIChjb250YWluZXJEaXYsIHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIklmcmFtZSBpbml0aWFsaXphdGlvbiBzdGFydGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBpbml0U3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKICAgIC8vIENoZWNrIGlmIENDUCBpZnJhbWUgaGFzIGFscmVhZHkgYmVlbiBpbml0aWFsaXplZCB0aHJvdWdoIGluaXRDQ1AKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmNvcmUuX2dldENDUElmcmFtZSgpKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBpbml0Q0NQIHdoZW4gYW4gaWZyYW1lIGdlbmVyYXRlZCBieSBpbml0Q0NQIGFscmVhZHkgZXhpc3RzJykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignRXJyb3Igd2hpbGUgY2hlY2tpbmcgaWYgaW5pdENDUCBoYXMgYWxyZWFkeSBiZWVuIGNhbGxlZCcpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KIAogICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCB3aGVuIGluc3RlYWQgb2YgdGFraW5nIGEgcGFyYW1zIG9iamVjdAogICAgLy8gYXMgaW5wdXQgd2Ugb25seSBhY2NlcHRlZCBjY3BVcmwuCiAgICB2YXIgcGFyYW1zID0ge307CiAgICBpZiAodHlwZW9mIChwYXJhbXNJbikgPT09ICdzdHJpbmcnKSB7CiAgICAgIHBhcmFtcy5jY3BVcmwgPSBwYXJhbXNJbjsKICAgIH0gZWxzZSB7CiAgICAgIHBhcmFtcyA9IHBhcmFtc0luOwogICAgfQogCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFpbmVyRGl2LCAnY29udGFpbmVyRGl2Jyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmNjcFVybCwgJ3BhcmFtcy5jY3BVcmwnKTsKIAogICAgLy8gQ3JlYXRlIHRoZSBDQ1AgaWZyYW1lIGFuZCBhcHBlbmQgaXQgdG8gdGhlIGNvbnRhaW5lciBkaXYuCiAgICB2YXIgaWZyYW1lID0gY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUoY29udGFpbmVyRGl2LCBwYXJhbXMpOwoKICAgIC8vIEluaXRpYWxpemUgdGhlIGV2ZW50IGJ1cyBhbmQgYWdlbnQgZGF0YSBwcm92aWRlcnMuCiAgICAvLyBOT1RFOiBTZXR0aW5nIGxvZ0V2ZW50cyBoZXJlIHRvIEZBTFNFIGluIG9yZGVyIHRvIGF2b2lkIGR1cGxpY2F0aW5nCiAgICAvLyBldmVudHMgd2hpY2ggYXJlIGxvZ2dlZCBpbiBDQ1AuCiAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cyh7IGxvZ0V2ZW50czogZmFsc2UgfSk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeSA9IG5ldyBjb25uZWN0Lk1lZGlhRmFjdG9yeShwYXJhbXMpOwogCiAgICAvLyBCdWlsZCB0aGUgdXBzdHJlYW0gY29uZHVpdCBjb21tdW5pY2F0aW5nIHdpdGggdGhlIENDUCBpZnJhbWUuCiAgICB2YXIgY29uZHVpdCA9IG5ldyBjb25uZWN0LklGcmFtZUNvbmR1aXQocGFyYW1zLmNjcFVybCwgd2luZG93LCBpZnJhbWUpOwogCiAgICAvLyBMZXQgQ0NQIGtub3cgaWYgaWZyYW1lIGlzIHZpc2libGUKICAgIGNvbm5lY3QuY29yZS5fc2VuZElmcmFtZVN0eWxlRGF0YVVwc3RyZWFtQWZ0ZXJSZWFzb25hYmxlV2FpdFRpbWUoaWZyYW1lLCBjb25kdWl0KTsKIAogICAgLy8gU2V0IHRoZSBnbG9iYWwgdXBzdHJlYW0gY29uZHVpdCBmb3IgZXh0ZXJuYWwgdXNlLgogICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gY29uZHVpdDsKIAogICAgLy8gSW5pdCB3ZWJTb2NrZXRQcm92aWRlcgogICAgY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyID0gbmV3IFdlYlNvY2tldFByb3ZpZGVyKCk7CiAKICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAKICAgIC8vIEluaXRpYWxpemUgdGhlIGtlZXBhbGl2ZSBtYW5hZ2VyLgogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBuZXcgS2VlcGFsaXZlTWFuYWdlcihjb25kdWl0LAogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSwKICAgICAgcGFyYW1zLmNjcFN5blRpbWVvdXQgfHwgQ0NQX1NZTl9USU1FT1VULAogICAgICBwYXJhbXMuY2NwQWNrVGltZW91dCB8fCBDQ1BfQUNLX1RJTUVPVVQpCiAgICAgIDsKICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9IG51bGw7CiAKICAgIC8vIEFsbG93IDUgc2VjIChkZWZhdWx0KSBiZWZvcmUgcmVjZWl2aW5nIHRoZSBmaXJzdCBBQ0sgZnJvbSB0aGUgQ0NQLgogICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ0NQIExvYWRUaW1lb3V0IHRyaWdnZXJlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9LCBwYXJhbXMuY2NwTG9hZFRpbWVvdXQgfHwgQ0NQX0xPQURfVElNRU9VVCk7CgogICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQTG9nc1B1c2goY29uZHVpdCk7CiAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NQdXNoKGNvbmR1aXQpOwogCiAgICAvLyBPbmNlIHdlIHJlY2VpdmUgdGhlIGZpcnN0IEFDSywgc2V0dXAgb3VyIHVwc3RyZWFtIEFQSSBjbGllbnQgYW5kIGVzdGFibGlzaAogICAgLy8gdGhlIFNZTi9BQ0sgcmVmcmVzaCBmbG93LgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkFja25vd2xlZGdlZCBieSB0aGUgQ0NQISIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQgPSBkYXRhLmlkOwoKICAgICAgaWYgKHBhcmFtcy5zb2Z0cGhvbmUgfHwgcGFyYW1zLmNoYXQgfHwgcGFyYW1zLnBhZ2VPcHRpb25zIHx8IHBhcmFtcy5zaG91bGRBZGROYW1lc3BhY2VUb0xvZ3MpIHsKICAgICAgICAvLyBTZW5kIGNvbmZpZ3VyYXRpb24gdXAgdG8gdGhlIENDUC4KICAgICAgICAvL3NldCBpdCB0byBmYWxzZSBpZiBzZWNvbmRhcnkKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIHsKICAgICAgICAgIHNvZnRwaG9uZTogcGFyYW1zLnNvZnRwaG9uZSwKICAgICAgICAgIGNoYXQ6IHBhcmFtcy5jaGF0LAogICAgICAgICAgcGFnZU9wdGlvbnM6IHBhcmFtcy5wYWdlT3B0aW9ucywKICAgICAgICAgIHNob3VsZEFkZE5hbWVzcGFjZVRvTG9nczogcGFyYW1zLnNob3VsZEFkZE5hbWVzcGFjZVRvTG9ncywKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gSWYgRFIgZW5hYmxlZCwgc2V0IHRoaXMgQ0NQIGluc3RhbmNlIGFzIHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldAogICAgICBpZiAocGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgewogICAgICAgIGNvbm5lY3QuY29yZS5yZWdpb24gPSBwYXJhbXMucmVnaW9uOwogICAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzID0gc3VwcHJlc3NDb250YWN0czsKICAgICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU0VUX09GRkxJTkUpOwogICAgICAgIH0gICAgICAgCiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLklOSVRfRElTQVNURVJfUkVDT1ZFUlksIHBhcmFtcyk7CiAgICAgIH0KIAogICAgICBpZiAoY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UpIHsKICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlKTsKICAgICAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICAgIH0KCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk9VVEVSX0NPTlRFWFRfSU5GTywgeyBzdHJlYW1zVmVyc2lvbjogY29ubmVjdC52ZXJzaW9uIH0pOwogCiAgICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyLnN0YXJ0KCk7CiAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKCiAgICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuSU5JVCk7CiAgICAgIGlmIChpbml0U3RhcnRUaW1lKSB7CiAgICAgICAgdmFyIGluaXRUaW1lID0gRGF0ZS5ub3coKSAtIGluaXRTdGFydFRpbWU7CiAgICAgICAgdmFyIHJlZnJlc2hBdHRlbXB0cyA9IGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCB8fCAwOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygnSWZyYW1lIGluaXRpYWxpemF0aW9uIHN1Y2NlZWRlZCcpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBJZnJhbWUgaW5pdGlhbGl6YXRpb24gdGltZSAke2luaXRUaW1lfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBJZnJhbWUgcmVmcmVzaCBhdHRlbXB0cyAke3JlZnJlc2hBdHRlbXB0c31gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTLAogICAgICAgICAgICBkYXRhOiB7IGNvdW50OiByZWZyZXNoQXR0ZW1wdHN9IAogICAgICAgICAgfSk7CiAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1NVQ0NFU1MsCiAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IDF9IAogICAgICAgICAgfSk7CiAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1RJTUUsCiAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IGluaXRUaW1lfSAKICAgICAgICAgIH0pOwogICAgICAgICAgLy90byBhdm9pZCBtZXRyaWMgZW1pc3Npb24gYWZ0ZXIgaW5pdGlhbGl6YXRpb24KICAgICAgICAgIGluaXRTdGFydFRpbWUgPSBudWxsOwogICAgICAgIH0sMTAwMCkKICAgICAgfQogICAgfSk7CiAKICAgIC8vIEFkZCBhbnkgbG9ncyBmcm9tIHRoZSB1cHN0cmVhbSB0byBvdXIgb3duIGxvZ2dlci4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuYWRkTG9nRW50cnkoY29ubmVjdC5Mb2dFbnRyeS5mcm9tT2JqZWN0KGxvZ0VudHJ5KSk7CiAgICAgIH0KICAgIH0pOwogCiAgICAvLyBQb3AgYSBsb2dpbiBwYWdlIHdoZW4gd2UgZW5jb3VudGVyIGFuIEFDSyB0aW1lb3V0LgogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VULCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vIGxvZ2luUG9wdXAgaXMgdHJ1ZSBieSBkZWZhdWx0LCBvbmx5IGZhbHNlIGlmIGV4cGxpY2l0bHkgc2V0IHRvIGZhbHNlLgogICAgICBpZiAocGFyYW1zLmxvZ2luUG9wdXAgIT09IGZhbHNlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBsb2dpblVybCA9IGdldExvZ2luVXJsKHBhcmFtcyk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIkFDS19USU1FT1VUIG9jY3VycmVkLCBhdHRlbXB0aW5nIHRvIHBvcCB0aGUgbG9naW4gcGFnZSBpZiBub3QgYWxyZWFkeSBvcGVuLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAvLyBjbGVhciBvdXQgbGFzdCBvcGVuZWQgdGltZXN0YW1wIGZvciBTQU1MIGF1dGhlbnRpY2F0aW9uIHdoZW4gdGhlcmUgaXMgQUNLX1RJTUVPVVQKICAgICAgICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLmNsZWFyKGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdyA9IGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5vcGVuKGxvZ2luVXJsLCBjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCwgcGFyYW1zLmxvZ2luT3B0aW9ucyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQUNLX1RJTUVPVVQgb2NjdXJyZWQgYnV0IHdlIGFyZSB1bmFibGUgdG8gb3BlbiB0aGUgbG9naW4gcG9wdXAuIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9PSBudWxsKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLmNsZWFyKGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQKTsKICAgICAgICAgICAgaWYgKChwYXJhbXMubG9naW5Qb3B1cEF1dG9DbG9zZSB8fCAocGFyYW1zLmxvZ2luT3B0aW9ucyAmJiBwYXJhbXMubG9naW5PcHRpb25zLmF1dG9DbG9zZSkpICYmIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdy5jbG9zZSgpOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgY29ubmVjdC5jb3JlLl9yZWZyZXNoSWZyYW1lT25UaW1lb3V0KHBhcmFtcywgY29udGFpbmVyRGl2KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJFcnJvciBvY2N1cnJlZCB3aGlsZSByZWZyZXNoaW5nIGlmcmFtZSIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogCiAgICBpZiAocGFyYW1zLm9uVmlld0NvbnRhY3QpIHsKICAgICAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QocGFyYW1zLm9uVmlld0NvbnRhY3QpOwogICAgfQoKICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gZGF0YS5sZW5ndGg7CiAgICB9KTsKCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmIChkYXRhICYmIGRhdGEuZG9tYWluSWQpIHsKICAgICAgICBjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkID0gZGF0YS5kb21haW5JZDsKICAgICAgfQogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9SRVRSSUVTX0VYSEFVU1RFRCwgZnVuY3Rpb24gKCkgewogICAgICBpZiAoaW5pdFN0YXJ0VGltZSkgewogICAgICAgIHZhciByZWZyZXNoQXR0ZW1wdHMgPSBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgLSAxOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygnSWZyYW1lIGluaXRpYWxpemF0aW9uIGZhaWxlZCcpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBUaW1lIGFmdGVyIGlmcmFtZSBpbml0aWFsaXphdGlvbiBzdGFydGVkICR7RGF0ZS5ub3coKSAtIGluaXRTdGFydFRpbWV9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYElmcmFtZSByZWZyZXNoIGF0dGVtcHRzICR7cmVmcmVzaEF0dGVtcHRzfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfUkVGUkVTSF9BVFRFTVBUUywKICAgICAgICAgIGRhdGE6IHsgY291bnQ6IHJlZnJlc2hBdHRlbXB0c30KICAgICAgICB9KTsKICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9TVUNDRVNTLAogICAgICAgICAgZGF0YTogeyBjb3VudDogMH0KICAgICAgICB9KTsKICAgICAgICBpbml0U3RhcnRUaW1lID0gbnVsbDsKICAgICAgfQogICAgfSk7CgogICAgLy8ga2VlcCB0aGUgc29mdHBob25lIHBhcmFtcyBmb3IgZXh0ZXJuYWwgdXNlCiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zID0gcGFyYW1zLnNvZnRwaG9uZTsKICB9OwoKICBjb25uZWN0LmNvcmUub25JZnJhbWVSZXRyaWVzRXhoYXVzdGVkID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9SRVRSSUVTX0VYSEFVU1RFRCwgZik7CiAgfQoKICBjb25uZWN0LmNvcmUuX3JlZnJlc2hJZnJhbWVPblRpbWVvdXQgPSBmdW5jdGlvbihpbml0Q0NQUGFyYW1zLCBjb250YWluZXJEaXYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpbml0Q0NQUGFyYW1zLCAnaW5pdENDUFBhcmFtcycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgdmFyIGNjcElmcmFtZVJlZnJlc2hJbnRlcnZhbCA9IChpbml0Q0NQUGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgPyBDQ1BfRFJfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgOiBDQ1BfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUw7CiAgICB2YXIgcmV0cnlEZWxheSA9IEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkoKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCAtIDEgfHwgMCksIHsgYmFzZTogMjAwMCB9KTsKICAgIC8vIEV2YWx1YXRlcyB0byAwIGZvciAwdGggYXR0ZW1wdCBhbmQgMSBmb3IgcmVzdCAoPjApIG9mIHRoZSByZWZyZXNoIGF0dGVtcHRzCiAgICB2YXIgdGltZW91dEZhY3RvciA9IE1hdGguY2VpbCgoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDApIC8gQ0NQX0lGUkFNRV9SRUZSRVNIX0xJTUlUKTsKICAgIHZhciB0aW1lb3V0ID0gKGNjcElmcmFtZVJlZnJlc2hJbnRlcnZhbCArIHJldHJ5RGVsYXkpICogdGltZW91dEZhY3RvcjsKICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgPSAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDApICsgMTsKICAgICAgaWYgKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCA8PSBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGlmcmFtZSA9IGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lKCk7CiAgICAgICAgICBpZiAoaWZyYW1lKSB7CiAgICAgICAgICAgIGlmcmFtZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGlmcmFtZSk7IC8vIFRoZSBvbmx5IHdheSB0byBmb3JjZSBhIHN5bmNocm9ub3VzIHJlbG9hZCBvZiB0aGUgaWZyYW1lIHdpdGhvdXQgdGhlIG9sZCBpZnJhbWUgY29udGludWluZyB0byBmdW5jdGlvbiBpcyB0byByZW1vdmUgdGhlIG9sZCBpZnJhbWUgZW50aXJlbHkuCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3SWZyYW1lID0gY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUoY29udGFpbmVyRGl2LCBpbml0Q0NQUGFyYW1zKTsKICAgICAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbS51cHN0cmVhbS5vdXRwdXQgPSBuZXdJZnJhbWUuY29udGVudFdpbmRvdzsgLy9yZXBsYWNlcyB0aGUgb3V0cHV0IHdpbmRvdyAob2xkIGlmcmFtZSdzIGNvbnRlbnRXaW5kb3cpIG9mIHRoZSBXaW5kb3dJT1N0cmVhbSAod2l0aGluIHRoZSBJRnJhbWVDb25kdWl0KSB3aXRoIHRoZSBuZXcgaWZyYW1lJ3MgY29udGVudFdpbmRvdy4KICAgICAgICAgIGNvbm5lY3QuY29yZS5fc2VuZElmcmFtZVN0eWxlRGF0YVVwc3RyZWFtQWZ0ZXJSZWFzb25hYmxlV2FpdFRpbWUobmV3SWZyYW1lLCBjb25uZWN0LmNvcmUudXBzdHJlYW0pOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignRXJyb3Igd2hpbGUgY2hlY2tpbmcgZm9yLCBhbmQgcmVjcmVhdGluZywgdGhlIENDUCBJRnJhbWUnKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICAgIGNvbm5lY3QuY29yZS5fcmVmcmVzaElmcmFtZU9uVGltZW91dChpbml0Q0NQUGFyYW1zLCBjb250YWluZXJEaXYpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1JFVFJJRVNfRVhIQVVTVEVEKTsKICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCk7CiAgICAgIH0KICAgIH0sIHRpbWVvdXQpOwogIH0KCgogIGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBpZnJhbWUgb2Ygd2luZG93LmRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKSkgewogICAgICBpZiAoaWZyYW1lLm5hbWUgPT09IENDUF9JRlJBTUVfTkFNRSkgewogICAgICAgIHJldHVybiBpZnJhbWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KCiAgY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUgPSBmdW5jdGlvbihjb250YWluZXJEaXYsIGluaXRDQ1BQYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpbml0Q0NQUGFyYW1zLCAnaW5pdENDUFBhcmFtcycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwogICAgaWZyYW1lLnNyYyA9IGluaXRDQ1BQYXJhbXMuY2NwVXJsOwogICAgaWZyYW1lLmFsbG93ID0gIm1pY3JvcGhvbmU7IGF1dG9wbGF5IjsKICAgIGlmcmFtZS5zdHlsZSA9IGluaXRDQ1BQYXJhbXMuc3R5bGUgfHwgIndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUiOwogICAgaWZyYW1lLnRpdGxlID0gaW5pdENDUFBhcmFtcy5pZnJhbWVUaXRsZSB8fCBDQ1BfSUZSQU1FX05BTUU7CiAgICBpZnJhbWUubmFtZSA9IENDUF9JRlJBTUVfTkFNRTsKICAgIGNvbnRhaW5lckRpdi5hcHBlbmRDaGlsZChpZnJhbWUpOwogICAgcmV0dXJuIGlmcmFtZTsKICB9CgogIGNvbm5lY3QuY29yZS5fc2VuZElmcmFtZVN0eWxlRGF0YVVwc3RyZWFtQWZ0ZXJSZWFzb25hYmxlV2FpdFRpbWUgPSBmdW5jdGlvbihpZnJhbWUsIGNvbmR1aXQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZnJhbWUsICdpZnJhbWUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb25kdWl0LCAnY29uZHVpdCcpOwogICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoaWZyYW1lLCBudWxsKTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgZGlzcGxheTogc3R5bGUuZGlzcGxheSwKICAgICAgICBvZmZzZXRXaWR0aDogaWZyYW1lLm9mZnNldFdpZHRoLAogICAgICAgIG9mZnNldEhlaWdodDogaWZyYW1lLm9mZnNldEhlaWdodCwKICAgICAgICBjbGllbnRSZWN0c0xlbmd0aDogaWZyYW1lLmdldENsaWVudFJlY3RzKCkubGVuZ3RoCiAgICAgIH07CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9TVFlMRSwgZGF0YSk7CiAgICB9LCAxMDAwMCk7CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBLZWVwYWxpdmVNYW5hZ2VyID0gZnVuY3Rpb24gKGNvbmR1aXQsIGV2ZW50QnVzLCBzeW5UaW1lb3V0LCBhY2tUaW1lb3V0KSB7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgdGhpcy5ldmVudEJ1cyA9IGV2ZW50QnVzOwogICAgdGhpcy5zeW5UaW1lb3V0ID0gc3luVGltZW91dDsKICAgIHRoaXMuYWNrVGltZW91dCA9IGFja1RpbWVvdXQ7CiAgICB0aGlzLmFja1RpbWVyID0gbnVsbDsKICAgIHRoaXMuc3luVGltZXIgPSBudWxsOwogICAgdGhpcy5hY2tTdWIgPSBudWxsOwogIH07CiAKICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKIAogICAgdGhpcy5jb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TWU5DSFJPTklaRSk7CiAgICB0aGlzLmFja1N1YiA9IHRoaXMuY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChzZWxmLmFja1RpbWVyKTsKICAgICAgc2VsZi5fZGVmZXJTdGFydCgpOwogICAgfSk7CiAgICB0aGlzLmFja1RpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmFja1N1Yi51bnN1YnNjcmliZSgpOwogICAgICBzZWxmLmV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQpOwogICAgICBzZWxmLl9kZWZlclN0YXJ0KCk7CiAgICB9LCB0aGlzLmFja1RpbWVvdXQpOwogIH07CiAKICAvL0ZpeGVzIHRoZSBrZWVwYWxpdmVtYW5hZ2VyLgogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLl9kZWZlclN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zeW5UaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5zdGFydCksIHRoaXMuc3luVGltZW91dCk7CiAgfTsKCiAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IG9ubHksIGluIGNhc2UgY3VzdG9tZXJzIGFyZSB1c2luZyB0aGlzIHRvIHN0YXJ0IHRoZSBrZWVwYWxpdmVtYW5hZ2VyIGZvciBzb21lIHJlYXNvbi4KICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5kZWZlclN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuc3luVGltZXIgPT0gbnVsbCkgewogICAgICB0aGlzLnN5blRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnN0YXJ0KSwgdGhpcy5zeW5UaW1lb3V0KTsKICAgIH0KICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogCiAgdmFyIFdlYlNvY2tldFByb3ZpZGVyID0gZnVuY3Rpb24gKCkgewogCiAgICB2YXIgY2FsbGJhY2tzID0gewogICAgICBpbml0RmFpbHVyZTogbmV3IFNldCgpLAogICAgICBzdWJzY3JpcHRpb25VcGRhdGU6IG5ldyBTZXQoKSwKICAgICAgc3Vic2NyaXB0aW9uRmFpbHVyZTogbmV3IFNldCgpLAogICAgICB0b3BpYzogbmV3IE1hcCgpLAogICAgICBhbGxNZXNzYWdlOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25HYWluOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25Mb3N0OiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25PcGVuOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25DbG9zZTogbmV3IFNldCgpCiAgICB9OwogCiAgICB2YXIgaW52b2tlQ2FsbGJhY2tzID0gZnVuY3Rpb24gKGNhbGxiYWNrcywgcmVzcG9uc2UpIHsKICAgICAgY2FsbGJhY2tzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2socmVzcG9uc2UpOwogICAgICB9KTsKICAgIH07CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFLCBmdW5jdGlvbiAoKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuaW5pdEZhaWx1cmUpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLCByZXNwb25zZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fQ0xPU0UsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZSwgcmVzcG9uc2UpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0dBSU4sIGZ1bmN0aW9uICgpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbik7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fTE9TVCwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9VUERBVEUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZSwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX0ZBSUxVUkUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkFMTF9NRVNTQUdFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5hbGxNZXNzYWdlLCByZXNwb25zZSk7CiAgICAgIGlmIChjYWxsYmFja3MudG9waWMuaGFzKHJlc3BvbnNlLnRvcGljKSkgewogICAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MudG9waWMuZ2V0KHJlc3BvbnNlLnRvcGljKSwgcmVzcG9uc2UpOwogICAgICB9CiAgICB9KTsKIAogICAgdGhpcy5zZW5kTWVzc2FnZSA9IGZ1bmN0aW9uICh3ZWJTb2NrZXRQYXlsb2FkKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCB3ZWJTb2NrZXRQYXlsb2FkKTsKICAgIH07CiAKICAgIHRoaXMub25Jbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmluaXRGYWlsdXJlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5pbml0RmFpbHVyZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbk9wZW4gPSBmdW5jdGlvbihjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uT3Blbi5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkNsb3NlID0gZnVuY3Rpb24oY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkdhaW4gPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbi5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4uZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25Db25uZWN0aW9uTG9zdCA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdC5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vblN1YnNjcmlwdGlvblVwZGF0ZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMuc3Vic2NyaWJlVG9waWNzID0gZnVuY3Rpb24gKHRvcGljcykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWNzLCAndG9waWNzJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzQXJyYXkodG9waWNzKSwgJ3RvcGljcyBtdXN0IGJlIGEgYXJyYXknKTsKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklCRSwgdG9waWNzKTsKICAgIH07CiAKICAgIHRoaXMub25NZXNzYWdlID0gZnVuY3Rpb24gKHRvcGljTmFtZSwgY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljTmFtZSwgJ3RvcGljTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgaWYgKGNhbGxiYWNrcy50b3BpYy5oYXModG9waWNOYW1lKSkgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5nZXQodG9waWNOYW1lKS5hZGQoY2IpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5zZXQodG9waWNOYW1lLCBuZXcgU2V0KFtjYl0pKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MudG9waWMuZ2V0KHRvcGljTmFtZSkuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25BbGxNZXNzYWdlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuYWxsTWVzc2FnZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuYWxsTWVzc2FnZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIEFnZW50RGF0YVByb3ZpZGVyID0gZnVuY3Rpb24gKGJ1cykgewogICAgdmFyIGFnZW50RGF0YSA9IG51bGw7CiAgICB0aGlzLmJ1cyA9IGJ1czsKICAgIHRoaXMuYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnVwZGF0ZUFnZW50RGF0YSkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUudXBkYXRlQWdlbnREYXRhID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgdmFyIG9sZEFnZW50RGF0YSA9IHRoaXMuYWdlbnREYXRhOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAKICAgIGlmIChvbGRBZ2VudERhdGEgPT0gbnVsbCkgewogICAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgfQogCiAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAKICAgIHRoaXMuX2ZpcmVBZ2VudFVwZGF0ZUV2ZW50cyhvbGRBZ2VudERhdGEpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0QWdlbnREYXRhID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuYWdlbnREYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignTm8gYWdlbnQgZGF0YSBpcyBhdmFpbGFibGUgeWV0IScpOwogICAgfQogCiAgICByZXR1cm4gdGhpcy5hZ2VudERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb250YWN0RGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHZhciBhZ2VudERhdGEgPSB0aGlzLmdldEFnZW50RGF0YSgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5maW5kKGFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGN0ZGF0YSkgewogICAgICByZXR1cm4gY3RkYXRhLmNvbnRhY3RJZCA9PT0gY29udGFjdElkOwogICAgfSk7CiAKICAgIGlmIChjb250YWN0RGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0NvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb250YWN0SWQpOwogICAgfQogCiAgICByZXR1cm4gY29udGFjdERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb25uZWN0aW9uRGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdmFyIGNvbnRhY3REYXRhID0gdGhpcy5nZXRDb250YWN0RGF0YShjb250YWN0SWQpOwogICAgdmFyIGNvbm5lY3Rpb25EYXRhID0gY29ubmVjdC5maW5kKGNvbnRhY3REYXRhLmNvbm5lY3Rpb25zLCBmdW5jdGlvbiAoY2RhdGEpIHsKICAgICAgcmV0dXJuIGNkYXRhLmNvbm5lY3Rpb25JZCA9PT0gY29ubmVjdGlvbklkOwogICAgfSk7CiAKICAgIGlmIChjb25uZWN0aW9uRGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0Nvbm5lY3Rpb24gJXMgZm9yIGNvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb25uZWN0aW9uSWQsIGNvbnRhY3RJZCk7CiAgICB9CiAKICAgIHJldHVybiBjb25uZWN0aW9uRGF0YTsKICB9OwoKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0SW5zdGFuY2VJZCA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gdGhpcy5nZXRBZ2VudERhdGEoKS5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQubWF0Y2goL2luc3RhbmNlXC8oWzAtOWEtZkEtRnwtXSspXC8vKVsxXTsKICB9CgogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRBV1NBY2NvdW50SWQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuZ2V0QWdlbnREYXRhKCkuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkLm1hdGNoKC86KFswLTldKyk6aW5zdGFuY2UvKVsxXTsKICB9CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2RpZmZDb250YWN0cyA9IGZ1bmN0aW9uIChvbGRBZ2VudERhdGEpIHsKICAgIHZhciBkaWZmID0gewogICAgICBhZGRlZDoge30sCiAgICAgIHJlbW92ZWQ6IHt9LAogICAgICBjb21tb246IHt9LAogICAgICBvbGRNYXA6IGNvbm5lY3QuaW5kZXgob2xkQWdlbnREYXRhID09IG51bGwgPyBbXSA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICB9OwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5vbGRNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoY29ubmVjdC5jb250YWlucyhkaWZmLm5ld01hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuY29tbW9uW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9IGVsc2UgewogICAgICAgIGRpZmYucmVtb3ZlZFtjb250YWN0SWRdID0gZGlmZi5vbGRNYXBbY29udGFjdElkXTsKICAgICAgfQogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLm5ld01hcCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIGlmICghY29ubmVjdC5jb250YWlucyhkaWZmLm9sZE1hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuYWRkZWRbY29udGFjdElkXSA9IGRpZmYubmV3TWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICByZXR1cm4gZGlmZjsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9maXJlQWdlbnRVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZGlmZiA9IG51bGw7CiAgICB2YXIgb2xkQWdlbnRTdGF0ZSA9IG9sZEFnZW50RGF0YSA9PSBudWxsID8gY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBuZXdBZ2VudFN0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBvbGRSb3V0aW5nU3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuSU5JVCA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogICAgdmFyIG5ld1JvdXRpbmdTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLnR5cGU7CiAKICAgIGlmIChvbGRSb3V0aW5nU3RhdGUgIT09IG5ld1JvdXRpbmdTdGF0ZSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRSb3V0aW5nRXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRSb3V0aW5nU3RhdGUsIG5ld1JvdXRpbmdTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CiAKICAgIGlmIChvbGRBZ2VudFN0YXRlICE9PSBuZXdBZ2VudFN0YXRlKSB7CiAgICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIHsKICAgICAgICBhZ2VudDogbmV3IGNvbm5lY3QuQWdlbnQoKSwKICAgICAgICBvbGRTdGF0ZTogb2xkQWdlbnRTdGF0ZSwKICAgICAgICBuZXdTdGF0ZTogbmV3QWdlbnRTdGF0ZQogCiAgICAgIH0pOwogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkQWdlbnRTdGF0ZSwgbmV3QWdlbnRTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIG9sZE5leHRTdGF0ZSA9IG9sZEFnZW50RGF0YSAmJiBvbGRBZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlID8gb2xkQWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZS5uYW1lIDogbnVsbDsKICAgIHZhciBuZXdOZXh0U3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUgPyB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUubmFtZSA6IG51bGw7CiAgICBpZiAob2xkTmV4dFN0YXRlICE9PSBuZXdOZXh0U3RhdGUgJiYgbmV3TmV4dFN0YXRlKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5FTlFVRVVFRF9ORVhUX1NUQVRFLCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KCiAgICBpZiAob2xkQWdlbnREYXRhICE9PSBudWxsKSB7CiAgICAgIGRpZmYgPSB0aGlzLl9kaWZmQ29udGFjdHMob2xkQWdlbnREYXRhKTsKIAogICAgfSBlbHNlIHsKICAgICAgZGlmZiA9IHsKICAgICAgICBhZGRlZDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgICByZW1vdmVkOiB7fSwKICAgICAgICBjb21tb246IHt9LAogICAgICAgIG9sZE1hcDoge30sCiAgICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICAgIH07CiAgICB9CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYuYWRkZWQpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKSk7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3REYXRhLmNvbnRhY3RJZCwgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOSVQsIGNvbnRhY3REYXRhLnN0YXRlLnR5cGUpOwogICAgfSk7CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYucmVtb3ZlZCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBjb250YWN0RGF0YS5jb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5fdW5zdWJBbGxDb250YWN0RXZlbnRzRm9yQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpOwogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLmNvbW1vbikuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3RJZCwgZGlmZi5vbGRNYXBbY29udGFjdElkXS5zdGF0ZS50eXBlLCBkaWZmLm5ld01hcFtjb250YWN0SWRdLnN0YXRlLnR5cGUpOwogICAgfSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAoY29udGFjdElkLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKG9sZENvbnRhY3RTdGF0ZSAhPT0gbmV3Q29udGFjdFN0YXRlKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnQsIGNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICAgIH0pOwogICAgfQoKICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBjb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX3Vuc3ViQWxsQ29udGFjdEV2ZW50c0ZvckNvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RFdmVudHMpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgICBzZWxmLmJ1cy5nZXRTdWJzY3JpcHRpb25zKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgY29udGFjdElkKSkKICAgICAgICAubWFwKGZ1bmN0aW9uIChzdWIpIHsgc3ViLnVuc3Vic2NyaWJlKCk7IH0pOwogICAgfSk7CiAgfTsKIAogIC8qKiAtLS0tLSBtaW5pbWFsIHZpZXcgbGF5ZXIgZXZlbnQgaGFuZGxpbmcgKiovCiAKICBjb25uZWN0LmNvcmUub25WaWV3Q29udGFjdCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLCBmKTsKICB9OwogCiAgLyoqCiAgICogVXNlZCBvZiBhZ2VudCBpbnRlcmZhY2UgY29udHJvbC4gCiAgICogY29ubmVjdC5jb3JlLnZpZXdDb250YWN0KCJjb250YWN0SWQiKSAtPiAgdGhpcyBpcyBjdXJyZW50bHkgcHJvZ3JhbW1lZCB0byBnZXQgdGhlIGNvbnRhY3QgaW50byB2aWV3LgogICAqLwogIGNvbm5lY3QuY29yZS52aWV3Q29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLAogICAgICBkYXRhOiB7CiAgICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqIC0tLS0tIG1pbmltYWwgdmlldyBsYXllciBldmVudCBoYW5kbGluZyAqKi8KIAogIGNvbm5lY3QuY29yZS5vbkFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ2hhbm5lbFZpZXdFdmVudHMuQUNUSVZBVEVfQ0hBTk5FTF9XSVRIX1ZJRVdfVFlQRSwgZik7CiAgfTsKIAogIC8qKgogICAqIFVzZWQgb2YgYWdlbnQgaW50ZXJmYWNlIGNvbnRyb2wuIAogICAqIGNvbm5lY3QuY29yZS5hY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUoKSAtPiAgdGhpcyBpcyBjdXJyZW50bHkgcHJvZ3JhbW1lZCB0byBnZXQgZWl0aGVyIHRoZSBudW1iZXIgcGFkLCBxdWljayBjb25uZWN0cywgb3IgY3JlYXRlIHRhc2sgaW50byB2aWV3LgogICAqIHRoZSB2YWxpZCBjb21iaW5hdGlvbnMgYXJlICgiY3JlYXRlX3Rhc2siLCAidGFzayIpLCAoIm51bWJlcl9wYWQiLCAic29mdHBob25lIiksICgiY3JlYXRlX3Rhc2siLCAic29mdHBob25lIiksICgicXVpY2tfY29ubmVjdHMiLCAic29mdHBob25lIikKICAgKiB0aGUgc29mdHBob25lIHdpdGggY3JlYXRlX3Rhc2sgY29tYm8gaXMgYSBzcGVjaWFsIGNhc2UgaW4gdGhlIGNoYW5uZWwgdmlldyB0byBhbGxvdyBhbGwgdGhyZWUgdmlldyB0eXBlIGJ1dHRvbnMgdG8gYXBwZWFyIG9uIHRoZSBzb2Z0cGhvbmUgc2NyZWVuCiAgICoKICAgKiBUaGUgJ3NvdXJjZScgaXMgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHdoaWNoIGluZGljYXRlcyB0aGUgcmVxdWVzdGVyLiBGb3IgZXhhbXBsZSwgaWYgaW52b2tlZCB3aXRoICgiY3JlYXRlX3Rhc2siLCAidGFzayIsICJhZ2VudGFwcCIpIHdlIHdvdWxkIGtub3cgYWdlbnRhcHAgcmVxdWVzdGVkIG9wZW4gdGFzayB2aWV3LgogICAqIAogICAqICJjYXNlSWQiIGlzIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB3aGljaCBpcyBwYXNzZWQgd2hlbiBhIHRhc2sgaXMgY3JlYXRlZCBmcm9tIGEgS2VzeXRvbmUgY2FzZQogICAqLwogICBjb25uZWN0LmNvcmUuYWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlID0gZnVuY3Rpb24gKHZpZXdUeXBlLCBtZWRpYVR5cGUsIHNvdXJjZSwgY2FzZUlkKSB7CiAgICBjb25zdCBkYXRhID0geyB2aWV3VHlwZSwgbWVkaWFUeXBlIH07CiAgICBpZiAoc291cmNlKSB7CiAgICAgIGRhdGEuc291cmNlID0gc291cmNlOwogICAgfQogICAgaWYgKGNhc2VJZCkgewogICAgICBkYXRhLmNhc2VJZCA9IGNhc2VJZDsKICAgIH0KICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ2hhbm5lbFZpZXdFdmVudHMuQUNUSVZBVEVfQ0hBTk5FTF9XSVRIX1ZJRVdfVFlQRSwKICAgICAgZGF0YQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogVXNlZCB0byBwdWJsaXNoICd0YXNrIGNyZWF0ZWQnIGV2ZW50CiAgICovCiAgY29ubmVjdC5jb3JlLnRyaWdnZXJUYXNrQ3JlYXRlZCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS51cHN0cmVhbUJ1cy50cmlnZ2VyKGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVELCBkYXRhKTsKICB9OwoKICAvKiogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogCiAgLyoqCiAgKiBUaGlzIHdpbGwgYmUgaGVscGZ1bCBmb3IgdGhlIGN1c3RvbSBhbmQgZW1iZWRkZWQgQ0NQcyAKICAqIHRvIGhhbmRsZSB0aGUgYWNjZXNzIGRlbmllZCB1c2UgY2FzZS4gCiAgKi8KICBjb25uZWN0LmNvcmUub25BY2Nlc3NEZW5pZWQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0NFU1NfREVOSUVELCBmKTsKICB9OwogCiAgLyoqCiAgKiBUaGlzIHdpbGwgYmUgaGVscGZ1bCBmb3IgU0FNTCB1c2UgY2FzZXMgdG8gaGFuZGxlIHRoZSBjdXN0b20gbG9naW5zLiAKICAqLwogIGNvbm5lY3QuY29yZS5vbkF1dGhGYWlsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBmKTsKICB9OwoKICBjb25uZWN0LmNvcmUub25BdXRob3JpemVTdWNjZXNzID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1NVQ0NFU1MsIGYpOwogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVTdWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQsIDApOwogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRoRmFpbCA9IGZ1bmN0aW9uKGxvZ2luVXJsLCBhdXRob3JpemVFbmRwb2ludCwgYXV0aEZhaWxEYXRhKSB7CiAgICBpZiAoYXV0aEZhaWxEYXRhICYmIGF1dGhGYWlsRGF0YS5hdXRob3JpemUpIHsKICAgICAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVGYWlsKGxvZ2luVXJsKTsKICAgIH0KICAgIGVsc2UgewogICAgICBjb25uZWN0LmNvcmUuX2hhbmRsZUNUSUF1dGhGYWlsKGF1dGhvcml6ZUVuZHBvaW50KTsKICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplRmFpbCA9IGZ1bmN0aW9uKGxvZ2luVXJsKSB7CiAgICBsZXQgYXV0aFJldHJ5Q291bnQgPSBjb25uZWN0LmNvcmUuX2dldEF1dGhSZXRyeUNvdW50KCkKICAgIGlmICghY29ubmVjdC5jb3JlLmF1dGhvcml6ZVRpbWVvdXRJZCkgewogICAgICBpZiAoYXV0aFJldHJ5Q291bnQgPCBjb25uZWN0LmNvcmUuTUFYX0FVVEhPUklaRV9SRVRSWV9DT1VOVF9GT1JfU0VTU0lPTikgewogICAgICAgIGNvbm5lY3QuY29yZS5faW5jcmVtZW50QXV0aFJldHJ5Q291bnQoKTsKICAgICAgICBsZXQgcmV0cnlEZWxheSA9IEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkoYXV0aFJldHJ5Q291bnQgKyAxIHx8IDAsIHsgYmFzZTogMjAwMCB9KTsKICAgICAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBjb25uZWN0LmNvcmUuX3JlZGlyZWN0VG9Mb2dpbihsb2dpblVybCk7CiAgICAgICAgfSwgcmV0cnlEZWxheSk7IC8vV2UgZG9uJ3QgaGF2ZSB0byBjbGVhciB0aGUgdGltZW91dElkIGJlY2F1c2Ugd2UgYXJlIHJlZGlyZWN0aW5nIGF3YXkgZnJvbSB0aGlzIG9yaWdpbiBvbmNlIHRoZSB0aW1lb3V0IGNvbXBsZXRlcy4KICAgICAgfQogICAgICBlbHNlICB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBoYXZlIGV4aGF1c3RlZCBvdXIgYXV0aG9yaXphdGlvbiByZXRyaWVzIGR1ZSB0byA0MDFzIGZyb20gdGhlIGF1dGhvcml6ZSBhcGkuIE5vIG1vcmUgcmV0cmllcyB3aWxsIGJlIGF0dGVtcHRlZCBpbiB0aGlzIHNlc3Npb24gdW50aWwgdGhlIGF1dGhvcml6ZSBhcGkgcmV0dXJucyAyMDAuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCk7CiAgICAgIH0KICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5fcmVkaXJlY3RUb0xvZ2luID0gZnVuY3Rpb24obG9naW5VcmwpIHsKICAgIGlmICh0eXBlb2YobG9naW5VcmwpID09PSAnc3RyaW5nJykgewogICAgICBsb2NhdGlvbi5hc3NpZ24obG9naW5VcmwpOwogICAgfSBlbHNlIHsKICAgICAgbG9jYXRpb24ucmVsb2FkKCk7CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUNUSUF1dGhGYWlsID0gZnVuY3Rpb24oYXV0aG9yaXplRW5kcG9pbnQpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmN0aVRpbWVvdXRJZCkgewogICAgICBpZiAoY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50IDwgY29ubmVjdC5jb3JlLk1BWF9DVElfQVVUSF9SRVRSWV9DT1VOVCkgewogICAgICAgIGNvbm5lY3QuY29yZS5jdGlBdXRoUmV0cnlDb3VudCsrOwogICAgICAgIGxldCByZXRyeURlbGF5ID0gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgfHwgMCwgeyBiYXNlOiA1MDAgfSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmN0aVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZShhdXRob3JpemVFbmRwb2ludCkudGhlbihjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRob3JpemVTdWNjZXNzLmJpbmQoY29ubmVjdC5jb3JlKSkuY2F0Y2goY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aEZhaWwuYmluZChjb25uZWN0LmNvcmUsIHthdXRob3JpemU6IHRydWV9KSk7CiAgICAgICAgICBjb25uZWN0LmNvcmUuY3RpVGltZW91dElkID0gbnVsbDsKICAgICAgICB9LCByZXRyeURlbGF5KTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGhhdmUgZXhoYXVzdGVkIG91ciBhdXRob3JpemF0aW9uIHJldHJpZXMgZHVlIHRvIDQwMXMgZnJvbSB0aGUgQ1RJIHNlcnZpY2UuIE5vIG1vcmUgcmV0cmllcyB3aWxsIGJlIGF0dGVtcHRlZCB1bnRpbCB0aGUgcGFnZSBpcyByZWZyZXNoZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkNUSV9BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQpOwogICAgICB9CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRob3JpemVTdWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS51cHN0cmVhbUJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9TVUNDRVNTKTsKICB9CgogIGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhGYWlsID0gZnVuY3Rpb24oZGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkudXBzdHJlYW1CdXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGRhdGEpOwogIH0KCiAgY29ubmVjdC5jb3JlLl9nZXRBdXRoUmV0cnlDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgbGV0IGl0ZW0gPSB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQpOwogICAgaWYgKGl0ZW0gIT09IG51bGwpIHsKICAgICAgaWYgKCFpc05hTihwYXJzZUludChpdGVtKSkpIHsKICAgICAgICByZXR1cm4gcGFyc2VJbnQoaXRlbSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcigiVGhlIHNlc3Npb24gc3RvcmFnZSB2YWx1ZSBmb3IgYXV0aCByZXRyeSBjb3VudCB3YXMgTmFOIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCwgMCk7CiAgICAgIHJldHVybiAwOwogICAgfSAKICB9CgogIGNvbm5lY3QuY29yZS5faW5jcmVtZW50QXV0aFJldHJ5Q291bnQgPSBmdW5jdGlvbigpIHsKICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCwgKGNvbm5lY3QuY29yZS5fZ2V0QXV0aFJldHJ5Q291bnQoKSsxKS50b1N0cmluZygpKTsKICB9CgogIGNvbm5lY3QuY29yZS5vbkF1dGhvcml6ZVJldHJpZXNFeGhhdXN0ZWQgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVELCBmKTsKICB9CgogIGNvbm5lY3QuY29yZS5vbkNUSUF1dGhvcml6ZVJldHJpZXNFeGhhdXN0ZWQgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ1RJX0FVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCwgZik7CiAgfQogCiAgLyoqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KIAogIC8qKgogICAqIFVzZWQgZm9yIGhhbmRsaW5nIHRoZSBydGMgc2Vzc2lvbiBzdGF0cy4KICAgKiBVc2FnZQogICAqIGNvbm5lY3QuY29yZS5vblNvZnRwaG9uZVNlc3Npb25Jbml0KGZ1bmN0aW9uKHsgY29ubmVjdGlvbklkIH0pIHsKICAgKiAgICAgdmFyIHNvZnRwaG9uZU1hbmFnZXIgPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlcigpOwogICAqICAgICBpZihzb2Z0cGhvbmVNYW5hZ2VyKXsKICAgKiAgICAgICAgLy8gYWNjZXNzIHNlc3Npb24KICAgKiAgICAgICAgdmFyIHNlc3Npb24gPSBzb2Z0cGhvbmVNYW5hZ2VyLmdldFNlc3Npb24oY29ubmVjdGlvbklkKTsgCiAgICogICAgICB9CiAgICogfSk7CiAgICovCiAKICBjb25uZWN0LmNvcmUub25Tb2Z0cGhvbmVTZXNzaW9uSW5pdCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5TRVNTSU9OX0lOSVQsIGYpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLm9uQ29uZmlndXJlID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuQ09ORklHVVJFLCBmKTsKICB9CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgIGNvbm5lY3QuY29yZS5vbkluaXRpYWxpemVkID0gZnVuY3Rpb24oZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5JTklULCBmKTsKICB9CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhY3RJZCwgJ2NvbnRhY3RJZCcpOwogICAgaWYgKCFjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdEV2ZW50cyksIGV2ZW50TmFtZSkpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuVmFsdWVFcnJvcignJXMgaXMgbm90IGEgdmFsaWQgY29udGFjdCBldmVudC4nLCBldmVudE5hbWUpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZignJXM6OiVzJywgZXZlbnROYW1lLCBjb250YWN0SWQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ldmVudEJ1czsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlcjsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXI7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0TG9jYWxUaW1lc3RhbXAgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCkuc25hcHNob3QubG9jYWxUaW1lc3RhbXA7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0U2tldyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKS5zbmFwc2hvdC5za2V3OwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50Um91dGluZ0V2ZW50R3JhcGg7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRSb3V0aW5nRXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuUk9VVEFCTEUpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5OT1RfUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuT0ZGTElORSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoOwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzKSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5FUlJPUikKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50QXZhaWxTdGF0ZXMuQUZURVJfQ0FMTF9XT1JLLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLkFDVyk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5jb250YWN0RXZlbnRHcmFwaDsKICB9OwogCiAgY29ubmVjdC5jb3JlLmNvbnRhY3RFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5DT01JTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLlBFTkRJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5QRU5ESU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVElORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVOREVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKQogICAgLmFzc29jKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTKSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5yZWxhdGl2ZUNvbXBsZW1lbnQoY29ubmVjdC5DT05UQUNUX0FDVElWRV9TVEFURVMsIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSkpLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRU5ERUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRVJST1IpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5NSVNTRUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBjb3JlIGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUuY2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG51bGw7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBBZ2VudEFwcCBDbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFRhc2tUZW1wbGF0ZXNDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IFRhc2tUZW1wbGF0ZXMgQ2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50ID0gbnVsbDsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgbWFzdGVyIGNsaWVudCBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXROb3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlcikgewogICAgICBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlciA9IG5ldyBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5wb3B1cE1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUucG9wdXBNYW5hZ2VyID0gbmV3IGNvbm5lY3QuUG9wdXBNYW5hZ2VyKCk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUudXBzdHJlYW0pIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlcmUgaXMgbm8gdXBzdHJlYW0gY29uZHVpdCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUudXBzdHJlYW07CiAgfTsKICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5BZ2VudERhdGFQcm92aWRlciA9IEFnZW50RGF0YVByb3ZpZGVyOwogCn0pKCk7CgovKioqLyB9KSwKCi8qKiovIDU5MjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgdmFyIEFMTF9FVkVOVFMgPSAnPDxhbGw+Pic7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gRXZlbnRUeXBlCiAgICovCiAgdmFyIEV2ZW50VHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2Fja25vd2xlZGdlJywKICAgICdhY2tfdGltZW91dCcsCiAgICAnaW5pdCcsCiAgICAnYXBpX3JlcXVlc3QnLAogICAgJ2FwaV9yZXNwb25zZScsCiAgICAnYXV0aF9mYWlsJywKICAgICdhY2Nlc3NfZGVuaWVkJywKICAgICdjbG9zZScsCiAgICAnY29uZmlndXJlJywKICAgICdsb2cnLAogICAgJ21hc3Rlcl9yZXF1ZXN0JywKICAgICdtYXN0ZXJfcmVzcG9uc2UnLAogICAgJ3N5bmNocm9uaXplJywKICAgICd0ZXJtaW5hdGUnLAogICAgJ3Rlcm1pbmF0ZWQnLAogICAgJ3NlbmRfbG9ncycsCiAgICAncmVsb2FkX2FnZW50X2NvbmZpZ3VyYXRpb24nLAogICAgJ2Jyb2FkY2FzdCcsCiAgICAnYXBpX21ldHJpYycsCiAgICAnY2xpZW50X21ldHJpYycsCiAgICAnc29mdHBob25lX3N0YXRzJywKICAgICdzb2Z0cGhvbmVfcmVwb3J0JywKICAgICdjbGllbnRfc2lkZV9sb2dzJywKICAgICdzZXJ2ZXJfYm91bmRfaW50ZXJuYWxfbG9nJywKICAgICdtdXRlJywKICAgICJpZnJhbWVfc3R5bGUiLAogICAgImlmcmFtZV9yZXRyaWVzX2V4aGF1c3RlZCIsCiAgICAidXBkYXRlX2Nvbm5lY3RlZF9jY3BzIiwKICAgICJvdXRlcl9jb250ZXh0X2luZm8iLAogICAgIm1lZGlhX2RldmljZV9yZXF1ZXN0IiwKICAgICJtZWRpYV9kZXZpY2VfcmVzcG9uc2UiLAogICAgInRhYl9pZCIsCiAgICAnYXV0aG9yaXplX3N1Y2Nlc3MnLAogICAgJ2F1dGhvcml6ZV9yZXRyaWVzX2V4aGF1c3RlZCcsCiAgICAnY3RpX2F1dGhvcml6ZV9yZXRyaWVzX2V4aGF1c3RlZCcsCiAgICAnY2xpY2tfc3RyZWFtX2RhdGEnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gTWFzdGVyVG9waWNzCiAgICovCiAgdmFyIE1hc3RlclRvcGljcyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25uZWN0JywgWwogICAgJ2xvZ2luUG9wdXAnLAogICAgJ3NlbmRMb2dzJywKICAgICdzb2Z0cGhvbmUnLAogICAgJ3Jpbmd0b25lJywKICAgICdtZXRyaWNzJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFnZW50RXZlbnRzCiAgICovCiAgdmFyIEFnZW50RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2FnZW50JywgWwogICAgJ2luaXQnLAogICAgJ3VwZGF0ZScsCiAgICAncmVmcmVzaCcsCiAgICAncm91dGFibGUnLAogICAgJ25vdF9yb3V0YWJsZScsCiAgICAncGVuZGluZycsCiAgICAnY29udGFjdF9wZW5kaW5nJywKICAgICdvZmZsaW5lJywKICAgICdlcnJvcicsCiAgICAnc29mdHBob25lX2Vycm9yJywKICAgICd3ZWJzb2NrZXRfY29ubmVjdGlvbl9sb3N0JywKICAgICd3ZWJzb2NrZXRfY29ubmVjdGlvbl9nYWluZWQnLAogICAgJ3N0YXRlX2NoYW5nZScsCiAgICAnYWN3JywKICAgICdtdXRlX3RvZ2dsZScsCiAgICAnbG9jYWxfbWVkaWFfc3RyZWFtX2NyZWF0ZWQnLAogICAgJ2VucXVldWVkX25leHRfc3RhdGUnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBXZWJTb2NrZXRFdmVudHMKICAqLwogIHZhciBXZWJTb2NrZXRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnd2ViU29ja2V0JywgWwogICAgJ2luaXRfZmFpbHVyZScsCiAgICAnY29ubmVjdGlvbl9vcGVuJywKICAgICdjb25uZWN0aW9uX2Nsb3NlJywKICAgICdjb25uZWN0aW9uX2Vycm9yJywKICAgICdjb25uZWN0aW9uX2dhaW4nLAogICAgJ2Nvbm5lY3Rpb25fbG9zdCcsCiAgICAnc3Vic2NyaXB0aW9uX3VwZGF0ZScsCiAgICAnc3Vic2NyaXB0aW9uX2ZhaWx1cmUnLAogICAgJ2FsbF9tZXNzYWdlJywKICAgICdzZW5kJywKICAgICdzdWJzY3JpYmUnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIENvbnRhY3RFdmVudHMKICAgICovCiAgdmFyIENvbnRhY3RFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29udGFjdCcsIFsKICAgICdpbml0JywKICAgICdyZWZyZXNoJywKICAgICdkZXN0cm95ZWQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnYWN3JywKICAgICd2aWV3JywKICAgICdlbmRlZCcsCiAgICAnZXJyb3InLAogICAgJ2FjY2VwdGVkJwogIF0pOwoKICB2YXIgQ2hhbm5lbFZpZXdFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgndGFza0xpc3QnLCBbCiAgICAnYWN0aXZhdGVfY2hhbm5lbF93aXRoX3ZpZXdfdHlwZScKICBdKTsKICAKICB2YXIgVGFza0V2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd0YXNrJywgWwogICAgICAnY3JlYXRlZCcKICBdKTsKCgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBDb25uZWN0aW9uRXZlbnRzCiAgKi8KICB2YXIgQ29ubmVjdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25uZWN0aW9uJywgWwogICAgJ3Nlc3Npb25faW5pdCcsCiAgICAncmVhZHlfdG9fc3RhcnRfc2Vzc2lvbicKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb25maWd1cmF0aW9uIEV2ZW50cwogICAqLwogIHZhciBDb25maWd1cmF0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbmZpZ3VyYXRpb24nLCBbCiAgICAnY29uZmlndXJlJywKICAgICdzZXRfc3BlYWtlcl9kZXZpY2UnLAogICAgJ3NldF9taWNyb3Bob25lX2RldmljZScsCiAgICAnc2V0X3Jpbmdlcl9kZXZpY2UnLAogICAgJ3NwZWFrZXJfZGV2aWNlX2NoYW5nZWQnLAogICAgJ21pY3JvcGhvbmVfZGV2aWNlX2NoYW5nZWQnLAogICAgJ3Jpbmdlcl9kZXZpY2VfY2hhbmdlZCcKICBdKTsKCiAgdmFyIERpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnZGlzYXN0ZXJSZWNvdmVyeScsIFsKICAgICdzdXBwcmVzcycsCiAgICAnZm9yY2Vfb2ZmbGluZScsIC8vIGxldHRpbmcgdGhlIHNoYXJlZHdvcmtlciBrbm93IHRvIGZvcmNlIG9mZmxpbmUgCiAgICAnc2V0X29mZmxpbmUnLCAvLyBpZnJhbWUgbGV0dGluZyB0aGUgbmF0aXZlIGNjcCB0byBzZXQgb2ZmbGluZQogICAgJ2luaXRfZGlzYXN0ZXJfcmVjb3ZlcnknLAogICAgJ2ZhaWxvdmVyJyAvLyB1c2VkIHRvIHByb3BhZ2F0ZSBmYWlsb3ZlciBzdGF0ZSB0byBvdGhlciB3aW5kb3dzCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gVm9pY2VJZCBFdmVudHMKICAgKi8KICAgdmFyIFZvaWNlSWRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgndm9pY2VJZCcsIFsKICAgICd1cGRhdGVfZG9tYWluX2lkJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBFdmVudEZhY3RvcnkKICAgKi8KICB2YXIgRXZlbnRGYWN0b3J5ID0gZnVuY3Rpb24gKCkgeyB9OwogIEV2ZW50RmFjdG9yeS5jcmVhdGVSZXF1ZXN0ID0gZnVuY3Rpb24gKHR5cGUsIG1ldGhvZCwgcGFyYW1zKSB7CiAgICByZXR1cm4gewogICAgICBldmVudDogdHlwZSwKICAgICAgcmVxdWVzdElkOiBjb25uZWN0LnJhbmRvbUlkKCksCiAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICBwYXJhbXM6IHBhcmFtcwogICAgfTsKICB9OwoKICBFdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UgPSBmdW5jdGlvbiAodHlwZSwgcmVxdWVzdCwgZGF0YSwgZXJyKSB7CiAgICByZXR1cm4gewogICAgICBldmVudDogdHlwZSwKICAgICAgcmVxdWVzdElkOiByZXF1ZXN0LnJlcXVlc3RJZCwKICAgICAgZGF0YTogZGF0YSwKICAgICAgZXJyOiBlcnIgfHwgbnVsbAogICAgfTsKICB9OwoKICAvKioKICAgKiBBbiBvYmplY3QgcmVwcmVzZW50aW5nIGFuIGV2ZW50IHN1YnNjcmlwdGlvbiBpbiBhbiBFdmVudEJ1cy4KICAgKi8KICB2YXIgU3Vic2NyaXB0aW9uID0gZnVuY3Rpb24gKHN1Yk1hcCwgZXZlbnROYW1lLCBmKSB7CiAgICB0aGlzLnN1Yk1hcCA9IHN1Yk1hcDsKICAgIHRoaXMuaWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CiAgICB0aGlzLmV2ZW50TmFtZSA9IGV2ZW50TmFtZTsKICAgIHRoaXMuZiA9IGY7CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgdGhlIGhhbmRsZXIgb2YgdGhpcyBzdWJzY3JpcHRpb24gZnJvbSB0aGUgRXZlbnRCdXMKICAgKiBmcm9tIHdoaWNoIGl0IHdhcyBjcmVhdGVkLgogICAqLwogIFN1YnNjcmlwdGlvbi5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1Yk1hcC51bnN1YnNjcmliZSh0aGlzLmV2ZW50TmFtZSwgdGhpcy5pZCk7CiAgfTsKCiAgLyoqCiAgICogQSBtYXAgb2YgZXZlbnQgc3Vic2NyaXB0aW9ucywgdXNlZCBieSB0aGUgRXZlbnRCdXMuCiAgICovCiAgdmFyIFN1YnNjcmlwdGlvbk1hcCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViSWRNYXAgPSB7fTsKICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwID0ge307CiAgfTsKCiAgLyoqCiAgICogQWRkIGEgc3Vic2NyaXB0aW9uIGZvciB0aGUgbmFtZWQgZXZlbnQuICBDcmVhdGVzIGEgbmV3IFN1YnNjcmlwdGlvbgogICAqIG9iamVjdCBhbmQgcmV0dXJucyBpdC4gIFRoaXMgb2JqZWN0IGNhbiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZikgewogICAgdmFyIHN1YiA9IG5ldyBTdWJzY3JpcHRpb24odGhpcywgZXZlbnROYW1lLCBmKTsKCiAgICB0aGlzLnN1YklkTWFwW3N1Yi5pZF0gPSBzdWI7CiAgICB2YXIgc3ViTGlzdCA9IHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gfHwgW107CiAgICBzdWJMaXN0LnB1c2goc3ViKTsKICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gPSBzdWJMaXN0OwogICAgcmV0dXJuIHN1YjsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSBhIHN1YnNjcmlwdGlvbiBtYXRjaGluZyB0aGUgZ2l2ZW4gZXZlbnQgbmFtZSBhbmQgaWQuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIHN1YklkKSB7CiAgICBpZiAoY29ubmVjdC5jb250YWlucyh0aGlzLnN1YkV2ZW50TmFtZU1hcCwgZXZlbnROYW1lKSkgewogICAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdID0gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXS5maWx0ZXIoZnVuY3Rpb24gKHMpIHsgcmV0dXJuIHMuaWQgIT09IHN1YklkOyB9KTsKCiAgICAgIGlmICh0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdLmxlbmd0aCA8IDEpIHsKICAgICAgICBkZWxldGUgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXTsKICAgICAgfQogICAgfQoKICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKHRoaXMuc3ViSWRNYXAsIHN1YklkKSkgewogICAgICBkZWxldGUgdGhpcy5zdWJJZE1hcFtzdWJJZF07CiAgICB9CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBhbGwgc3Vic2NyaXB0aW9ucyBpbiB0aGUgc3Vic2NyaXB0aW9uIG1hcC4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLmdldEFsbFN1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC52YWx1ZXModGhpcy5zdWJFdmVudE5hbWVNYXApLnJlZHVjZShmdW5jdGlvbiAoYSwgYikgewogICAgICByZXR1cm4gYS5jb25jYXQoYik7CiAgICB9LCBbXSk7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGZvciB0aGUgZ2l2ZW4gZXZlbnQgbmFtZSwgb3IgYW4gZW1wdHkKICAgKiBsaXN0IGlmIHRoZXJlIGFyZSBubyBzdWJzY3JpcHRpb25zLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuZ2V0U3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdIHx8IFtdOwogIH07CgogIC8qKgogICAqIEFuIG9iamVjdCB3aGljaCBtYWludGFpbnMgYSBtYXAgb2Ygc3Vic2NyaXB0aW9ucyBhbmQgc2VydmVzIGFzIHRoZQogICAqIG1lY2hhbmlzbSBmb3IgdHJpZ2dlcmluZyBldmVudHMgdG8gYmUgaGFuZGxlZCBieSBzdWJzY3JpYmVycy4KICAgKi8KICB2YXIgRXZlbnRCdXMgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKCiAgICB0aGlzLnN1Yk1hcCA9IG5ldyBTdWJzY3JpcHRpb25NYXAoKTsKICAgIHRoaXMubG9nRXZlbnRzID0gcGFyYW1zLmxvZ0V2ZW50cyB8fCBmYWxzZTsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmUgdG8gdGhlIG5hbWVkIGV2ZW50LiAgUmV0dXJucyBhIG5ldyBTdWJzY3JpcHRpb24gb2JqZWN0CiAgICogd2hpY2ggY2FuIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgfTsKCiAgLyoqCiAgICogU3Vic2NyaWJlIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uIGFsbCBldmVudHMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnN1YnNjcmliZUFsbCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgcmV0dXJuIHRoaXMuc3ViTWFwLnN1YnNjcmliZShBTExfRVZFTlRTLCBmKTsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHRoZSBnaXZlbiBldmVudCBuYW1lLCBvciBhbiBlbXB0eQogICAqIGxpc3QgaWYgdGhlcmUgYXJlIG5vIHN1YnNjcmlwdGlvbnMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLmdldFN1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuZ2V0U3Vic2NyaXB0aW9ucyhldmVudE5hbWUpOwogIH07CgogIC8qKgogICAqIFRyaWdnZXIgdGhlIGdpdmVuIGV2ZW50IHdpdGggdGhlIGdpdmVuIGRhdGEuICBBbGwgbWV0aG9kcyBzdWJzY3JpYmVkCiAgICogdG8gdGhpcyBldmVudCB3aWxsIGJlIGNhbGxlZCBhbmQgYXJlIHByb3ZpZGVkIHdpdGggdGhlIGdpdmVuIGFyYml0cmFyeQogICAqIGRhdGEgb2JqZWN0IGFuZCB0aGUgbmFtZSBvZiB0aGUgZXZlbnQsIGluIHRoYXQgb3JkZXIuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnRyaWdnZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgYWxsRXZlbnRTdWJzID0gdGhpcy5zdWJNYXAuZ2V0U3Vic2NyaXB0aW9ucyhBTExfRVZFTlRTKTsKICAgIHZhciBldmVudFN1YnMgPSB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKGV2ZW50TmFtZSk7CgogICAgaWYgKHRoaXMubG9nRXZlbnRzICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5MT0cgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuQVBJX01FVFJJQyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRwogICAgKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIlB1Ymxpc2hpbmcgZXZlbnQ6ICVzIiwgZXZlbnROYW1lKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQoKICAgIGlmICgKICAgICAgZXZlbnROYW1lLnN0YXJ0c1dpdGgoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVEKSAmJgogICAgICBkYXRhICYmCiAgICAgIGRhdGEuY29udGFjdElkICYmCiAgICAgICEoZGF0YSBpbnN0YW5jZW9mIGNvbm5lY3QuQ29udGFjdCkKICAgICkgewogICAgICBkYXRhID0gbmV3IGNvbm5lY3QuQ29udGFjdChkYXRhLmNvbnRhY3RJZCk7CiAgICB9CgogICAgYWxsRXZlbnRTdWJzLmNvbmNhdChldmVudFN1YnMpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICB0cnkgewogICAgICAgIHN1Yi5mKGRhdGEgfHwgbnVsbCwgZXZlbnROYW1lLCBzZWxmKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIiclcycgZXZlbnQgaGFuZGxlciBmYWlsZWQuIiwgZXZlbnROYW1lKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIGJyaWRnZXMgYW4gZXZlbnQgZnJvbSBhbm90aGVyIEV2ZW50QnVzIHRvIHRoaXMgYnVzLgogICAqCiAgICogVXNhZ2U6CiAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgYnVzLmJyaWRnZSgpKTsKICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuYnJpZGdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhLCBldmVudCkgewogICAgICBzZWxmLnRyaWdnZXIoZXZlbnQsIGRhdGEpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSBhbGwgZXZlbnRzIGluIHRoZSBldmVudCBidXMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnVuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJNYXAuZ2V0QWxsU3Vic2NyaXB0aW9ucygpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuRXZlbnRCdXMgPSBFdmVudEJ1czsKICBjb25uZWN0LkV2ZW50RmFjdG9yeSA9IEV2ZW50RmFjdG9yeTsKICBjb25uZWN0LkV2ZW50VHlwZSA9IEV2ZW50VHlwZTsKICBjb25uZWN0LkFnZW50RXZlbnRzID0gQWdlbnRFdmVudHM7CiAgY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzID0gQ29uZmlndXJhdGlvbkV2ZW50czsKICBjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMgPSBDb25uZWN0aW9uRXZlbnRzOwogIGNvbm5lY3QuQ29ubm5lY3Rpb25FdmVudHMgPSBDb25uZWN0aW9uRXZlbnRzOyAvL2RlcHJlY2F0ZSBvbiBuZXh0IG1ham9yIHZlcnNpb24gcmVsZWFzZS4KICBjb25uZWN0LkNvbnRhY3RFdmVudHMgPSBDb250YWN0RXZlbnRzOwogIGNvbm5lY3QuQ2hhbm5lbFZpZXdFdmVudHMgPSBDaGFubmVsVmlld0V2ZW50czsKICBjb25uZWN0LlRhc2tFdmVudHMgPSBUYXNrRXZlbnRzOwogIGNvbm5lY3QuVm9pY2VJZEV2ZW50cyA9IFZvaWNlSWRFdmVudHM7CiAgY29ubmVjdC5XZWJTb2NrZXRFdmVudHMgPSBXZWJTb2NrZXRFdmVudHM7CiAgY29ubmVjdC5NYXN0ZXJUb3BpY3MgPSBNYXN0ZXJUb3BpY3M7CiAgY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzID0gRGlzYXN0ZXJSZWNvdmVyeUV2ZW50czsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDI4NjoKLyoqKi8gKCgpID0+IHsKCiFmdW5jdGlvbihlKXt2YXIgbj17fTtmdW5jdGlvbiB0KG8pe2lmKG5bb10pcmV0dXJuIG5bb10uZXhwb3J0czt2YXIgcj1uW29dPXtpOm8sbDohMSxleHBvcnRzOnt9fTtyZXR1cm4gZVtvXS5jYWxsKHIuZXhwb3J0cyxyLHIuZXhwb3J0cyx0KSxyLmw9ITAsci5leHBvcnRzfXQubT1lLHQuYz1uLHQuZD1mdW5jdGlvbihlLG4sbyl7dC5vKGUsbil8fE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG4se2VudW1lcmFibGU6ITAsZ2V0Om99KX0sdC5yPWZ1bmN0aW9uKGUpeyJ1bmRlZmluZWQiIT10eXBlb2YgU3ltYm9sJiZTeW1ib2wudG9TdHJpbmdUYWcmJk9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLFN5bWJvbC50b1N0cmluZ1RhZyx7dmFsdWU6Ik1vZHVsZSJ9KSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwiX19lc01vZHVsZSIse3ZhbHVlOiEwfSl9LHQudD1mdW5jdGlvbihlLG4pe2lmKDEmbiYmKGU9dChlKSksOCZuKXJldHVybiBlO2lmKDQmbiYmIm9iamVjdCI9PXR5cGVvZiBlJiZlJiZlLl9fZXNNb2R1bGUpcmV0dXJuIGU7dmFyIG89T2JqZWN0LmNyZWF0ZShudWxsKTtpZih0LnIobyksT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sImRlZmF1bHQiLHtlbnVtZXJhYmxlOiEwLHZhbHVlOmV9KSwyJm4mJiJzdHJpbmciIT10eXBlb2YgZSlmb3IodmFyIHIgaW4gZSl0LmQobyxyLGZ1bmN0aW9uKG4pe3JldHVybiBlW25dfS5iaW5kKG51bGwscikpO3JldHVybiBvfSx0Lm49ZnVuY3Rpb24oZSl7dmFyIG49ZSYmZS5fX2VzTW9kdWxlP2Z1bmN0aW9uKCl7cmV0dXJuIGUuZGVmYXVsdH06ZnVuY3Rpb24oKXtyZXR1cm4gZX07cmV0dXJuIHQuZChuLCJhIixuKSxufSx0Lm89ZnVuY3Rpb24oZSxuKXtyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGUsbil9LHQucD0iIix0KHQucz0yKX0oW2Z1bmN0aW9uKGUsbix0KXsidXNlIHN0cmljdCI7dmFyIG89dCgxKSxyPSJOVUxMIixpPSJDTElFTlRfTE9HR0VSIixjPSJERUJVRyIsYT0yZTMscz0iQU1aX1dFQl9TT0NLRVRfTUFOQUdFUjoiLHU9Ik5ldHdvcmsgb2ZmbGluZSIsbD0iTmV0d29yayBvbmxpbmUsIGNvbm5lY3RpbmcgdG8gV2ViU29ja2V0IHNlcnZlciIsZj0iTmV0d29yayBvZmZsaW5lLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIsZD0iSGVhcnRiZWF0IHJlc3BvbnNlIG5vdCByZWNlaXZlZCIscD0iSGVhcnRiZWF0IHJlc3BvbnNlIHJlY2VpdmVkIixnPSJTZW5kaW5nIGhlYXJ0YmVhdCIsYj0iRmFpbGVkIHRvIHNlbmQgaGVhcnRiZWF0IHNpbmNlIFdlYlNvY2tldCBpcyBub3Qgb3BlbiIseT0iV2ViU29ja2V0IGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQhIixtPSJXZWJTb2NrZXQgY29ubmVjdGlvbiBpcyBjbG9zZWQiLHY9IldlYlNvY2tldE1hbmFnZXIgRXJyb3IsIGVycm9yX2V2ZW50OiAiLFM9IlNjaGVkdWxpbmcgV2ViU29ja2V0IHJlaW5pdGlhbGl6YXRpb24sIGFmdGVyIGRlbGF5ICIsaD0iV2ViU29ja2V0IFVSTCBjYW5ub3QgYmUgdXNlZCB0byBlc3RhYmxpc2ggY29ubmVjdGlvbiIsaz0iV2ViU29ja2V0IEluaXRpYWxpemF0aW9uIGZhaWxlZCAtIFRlcm1pbmF0aW5nIGFuZCBjbGVhbmluZyBzdWJzY3JpcHRpb25zIix3PSJUZXJtaW5hdGluZyBXZWJTb2NrZXQgTWFuYWdlciIsQz0iRmV0Y2hpbmcgbmV3IFdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLEw9IlN1Y2Nlc3NmdWxseSBmZXRjaGVkIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLFQ9IkZhaWxlZCB0byBmZXRjaCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixPPSJSZXRyeWluZyBmZXRjaGluZyBuZXcgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsVz0iSW5pdGlhbGl6aW5nIFdlYnNvY2tldCBNYW5hZ2VyIixJPSJJbml0aWFsaXppbmcgV2Vic29ja2V0IE1hbmFnZXIgRmFpbGVkISIsTj0iV2Vic29ja2V0IGNvbm5lY3Rpb24gb3BlbiIsXz0iV2Vic29ja2V0IGNvbm5lY3Rpb24gY2xvc2UiLEU9IldlYnNvY2tldCBjb25uZWN0aW9uIGdhaW4iLEY9IldlYnNvY2tldCBjb25uZWN0aW9uIGxvc3QiLEE9IldlYnNvY2tldCBzdWJzY3JpcHRpb24gZmFpbHVyZSIsUj0iUmVzZXQgV2Vic29ja2V0IHN0YXRlIix4PSJXZWJTb2NrZXRNYW5hZ2VyIE1lc3NhZ2UgRXJyb3IiLEQ9Ik1lc3NhZ2UgcmVjZWl2ZWQgZm9yIHRvcGljICIsaj0iSW52YWxpZCBpbmNvbWluZyBtZXNzYWdlIixNPSJXZWJzb2NrZXRNYW5hZ2VyIGludm9rZSBjYWxsYmFja3MgZm9yIHRvcGljIHN1Y2Nlc3MgIixHPSJhd3Mvc3Vic2NyaWJlIix6PSJhd3MvdW5zdWJzY3JpYmUiLFA9ImF3cy9oZWFydGJlYXQiLEg9ImNvbm5lY3RlZCIsVT0iZGlzY29ubmVjdGVkIjtmdW5jdGlvbiBxKGUpe3JldHVybihxPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9dmFyIEo9e2Fzc2VydFRydWU6ZnVuY3Rpb24oZSxuKXtpZighZSl0aHJvdyBuZXcgRXJyb3Iobil9LGFzc2VydE5vdE51bGw6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gSi5hc3NlcnRUcnVlKG51bGwhPT1lJiZ2b2lkIDAhPT1xKGUpLE9iamVjdChvLnNwcmludGYpKCIlcyBtdXN0IGJlIHByb3ZpZGVkIixufHwiQSB2YWx1ZSIpKSxlfSxpc05vbkVtcHR5U3RyaW5nOmZ1bmN0aW9uKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZSYmZS5sZW5ndGg+MH0sYXNzZXJ0SXNMaXN0OmZ1bmN0aW9uKGUsbil7aWYoIUFycmF5LmlzQXJyYXkoZSkpdGhyb3cgbmV3IEVycm9yKG4rIiBpcyBub3QgYW4gYXJyYXkiKX0saXNGdW5jdGlvbjpmdW5jdGlvbihlKXtyZXR1cm4hIShlJiZlLmNvbnN0cnVjdG9yJiZlLmNhbGwmJmUuYXBwbHkpfSxpc09iamVjdDpmdW5jdGlvbihlKXtyZXR1cm4hKCJvYmplY3QiIT09cShlKXx8bnVsbD09PWUpfSxpc1N0cmluZzpmdW5jdGlvbihlKXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIGV9LGlzTnVtYmVyOmZ1bmN0aW9uKGUpe3JldHVybiJudW1iZXIiPT10eXBlb2YgZX19LEI9bmV3IFJlZ0V4cCgiXih3c3M6Ly8pXFx3KiIpO0oudmFsaWRXU1VybD1mdW5jdGlvbihlKXtyZXR1cm4gQi50ZXN0KGUpfSxKLmdldFN1YnNjcmlwdGlvblJlc3BvbnNlPWZ1bmN0aW9uKGUsbix0KXtyZXR1cm57dG9waWM6ZSxjb250ZW50OntzdGF0dXM6bj8ic3VjY2VzcyI6ImZhaWx1cmUiLHRvcGljczp0fX19LEouYXNzZXJ0SXNPYmplY3Q9ZnVuY3Rpb24oZSxuKXtpZighSi5pc09iamVjdChlKSl0aHJvdyBuZXcgRXJyb3IobisiIGlzIG5vdCBhbiBvYmplY3QhIil9LEouYWRkSml0dGVyPWZ1bmN0aW9uKGUpe3ZhciBuPWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXToxO249TWF0aC5taW4obiwxKTt2YXIgdD1NYXRoLnJhbmRvbSgpPi41PzE6LTE7cmV0dXJuIE1hdGguZmxvb3IoZSt0KmUqTWF0aC5yYW5kb20oKSpuKX0sSi5pc05ldHdvcmtPbmxpbmU9ZnVuY3Rpb24oKXtyZXR1cm4gbmF2aWdhdG9yLm9uTGluZX0sSi5pc05ldHdvcmtGYWlsdXJlPWZ1bmN0aW9uKGUpe3JldHVybiEoIWUuX2RlYnVnfHwhZS5fZGVidWcudHlwZSkmJiJOZXR3b3JraW5nRXJyb3IiPT09ZS5fZGVidWcudHlwZX07dmFyIFY9SjtmdW5jdGlvbiBYKGUsbil7cmV0dXJuIW58fCJvYmplY3QiIT09WihuKSYmImZ1bmN0aW9uIiE9dHlwZW9mIG4/ZnVuY3Rpb24oZSl7aWYodm9pZCAwPT09ZSl0aHJvdyBuZXcgUmVmZXJlbmNlRXJyb3IoInRoaXMgaGFzbid0IGJlZW4gaW5pdGlhbGlzZWQgLSBzdXBlcigpIGhhc24ndCBiZWVuIGNhbGxlZCIpO3JldHVybiBlfShlKTpufWZ1bmN0aW9uICQoZSl7cmV0dXJuKCQ9T2JqZWN0LnNldFByb3RvdHlwZU9mP09iamVjdC5nZXRQcm90b3R5cGVPZjpmdW5jdGlvbihlKXtyZXR1cm4gZS5fX3Byb3RvX198fE9iamVjdC5nZXRQcm90b3R5cGVPZihlKX0pKGUpfWZ1bmN0aW9uIEsoZSxuKXtyZXR1cm4oSz1PYmplY3Quc2V0UHJvdG90eXBlT2Z8fGZ1bmN0aW9uKGUsbil7cmV0dXJuIGUuX19wcm90b19fPW4sZX0pKGUsbil9ZnVuY3Rpb24gWihlKXtyZXR1cm4oWj0iZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiYic3ltYm9sIj09dHlwZW9mIFN5bWJvbC5pdGVyYXRvcj9mdW5jdGlvbihlKXtyZXR1cm4gdHlwZW9mIGV9OmZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiZlLmNvbnN0cnVjdG9yPT09U3ltYm9sJiZlIT09U3ltYm9sLnByb3RvdHlwZT8ic3ltYm9sIjp0eXBlb2YgZX0pKGUpfWZ1bmN0aW9uIFEoZSxuKXtpZighKGUgaW5zdGFuY2VvZiBuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKX1mdW5jdGlvbiBZKGUsbil7Zm9yKHZhciB0PTA7dDxuLmxlbmd0aDt0Kyspe3ZhciBvPW5bdF07by5lbnVtZXJhYmxlPW8uZW51bWVyYWJsZXx8ITEsby5jb25maWd1cmFibGU9ITAsInZhbHVlImluIG8mJihvLndyaXRhYmxlPSEwKSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxvLmtleSxvKX19ZnVuY3Rpb24gZWUoZSxuLHQpe3JldHVybiBuJiZZKGUucHJvdG90eXBlLG4pLHQmJlkoZSx0KSxlfXZhciBuZT1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXtRKHRoaXMsZSl9cmV0dXJuIGVlKGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiYWR2YW5jZWRMb2ciLHZhbHVlOmZ1bmN0aW9uKGUpe319XSksZX0oKSx0ZT1zLG9lPXtERUJVRzoxMCxJTkZPOjIwLFdBUk46MzAsRVJST1I6NDAsQURWQU5DRURfTE9HOjUwfSxyZT1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXtRKHRoaXMsZSksdGhpcy51cGRhdGVMb2dnZXJDb25maWcoKSx0aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyPWFlKCl9cmV0dXJuIGVlKGUsW3trZXk6IndyaXRlVG9DbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUsbil7aWYodGhpcy5oYXNDbGllbnRMb2dnZXIoKSlzd2l0Y2goZSl7Y2FzZSBvZS5ERUJVRzpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmRlYnVnKG4pfHxuO2Nhc2Ugb2UuSU5GTzpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmluZm8obil8fG47Y2FzZSBvZS5XQVJOOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIud2FybihuKXx8bjtjYXNlIG9lLkVSUk9SOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuZXJyb3Iobil8fG47Y2FzZSBvZS5BRFZBTkNFRF9MT0c6cmV0dXJuIHRoaXMuX2FkdmFuY2VkTG9nV3JpdGVyP3RoaXMuX2NsaWVudExvZ2dlclt0aGlzLl9hZHZhbmNlZExvZ1dyaXRlcl0obil8fG46IiJ9fX0se2tleToiaXNMZXZlbEVuYWJsZWQiLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBlPj10aGlzLl9sZXZlbH19LHtrZXk6Imhhc0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXRoaXMuX2NsaWVudExvZ2dlcn19LHtrZXk6ImdldExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49ZS5wcmVmaXh8fHRlO3JldHVybiB0aGlzLl9sb2dzRGVzdGluYXRpb249PT1jP3RoaXMuY29uc29sZUxvZ2dlcldyYXBwZXI6bmV3IGNlKG4pfX0se2tleToidXBkYXRlTG9nZ2VyQ29uZmlnIix2YWx1ZTpmdW5jdGlvbihlKXt2YXIgbj1lfHx7fTt0aGlzLl9sZXZlbD1uLmxldmVsfHxvZS5JTkZPLHRoaXMuX2FkdmFuY2VkTG9nV3JpdGVyPSJ3YXJuIixuLmFkdmFuY2VkTG9nV3JpdGVyJiYodGhpcy5fYWR2YW5jZWRMb2dXcml0ZXI9bi5hZHZhbmNlZExvZ1dyaXRlciksbi5jdXN0b21pemVkTG9nZ2VyJiYib2JqZWN0Ij09PVoobi5jdXN0b21pemVkTG9nZ2VyKSYmKHRoaXMudXNlQ2xpZW50TG9nZ2VyPSEwKSx0aGlzLl9jbGllbnRMb2dnZXI9bi5sb2dnZXJ8fHRoaXMuc2VsZWN0TG9nZ2VyKG4pLHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1yLG4uZGVidWcmJih0aGlzLl9sb2dzRGVzdGluYXRpb249Yyksbi5sb2dnZXImJih0aGlzLl9sb2dzRGVzdGluYXRpb249aSl9fSx7a2V5OiJzZWxlY3RMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBlLmN1c3RvbWl6ZWRMb2dnZXImJiJvYmplY3QiPT09WihlLmN1c3RvbWl6ZWRMb2dnZXIpP2UuY3VzdG9taXplZExvZ2dlcjplLnVzZURlZmF1bHRMb2dnZXI/KHRoaXMuY29uc29sZUxvZ2dlcldyYXBwZXI9YWUoKSx0aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyKTpudWxsfX1dKSxlfSgpLGllPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZSgpe1EodGhpcyxlKX1yZXR1cm4gZWUoZSxbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImFkdmFuY2VkTG9nIix2YWx1ZTpmdW5jdGlvbigpe319XSksZX0oKSxjZT1mdW5jdGlvbihlKXtmdW5jdGlvbiBuKGUpe3ZhciB0O3JldHVybiBRKHRoaXMsbiksKHQ9WCh0aGlzLCQobikuY2FsbCh0aGlzKSkpLnByZWZpeD1lfHx0ZSx0fXJldHVybiBmdW5jdGlvbihlLG4pe2lmKCJmdW5jdGlvbiIhPXR5cGVvZiBuJiZudWxsIT09bil0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiIpO2UucHJvdG90eXBlPU9iamVjdC5jcmVhdGUobiYmbi5wcm90b3R5cGUse2NvbnN0cnVjdG9yOnt2YWx1ZTplLHdyaXRhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMH19KSxuJiZLKGUsbil9KG4saWUpLGVlKG4sW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2cob2UuREVCVUcsbil9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2cob2UuSU5GTyxuKX19LHtrZXk6Indhcm4iLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5XQVJOLG4pfX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5FUlJPUixuKX19LHtrZXk6ImFkdmFuY2VkTG9nIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2cob2UuQURWQU5DRURfTE9HLG4pfX0se2tleToiX3Nob3VsZExvZyIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIHNlLmhhc0NsaWVudExvZ2dlcigpJiZzZS5pc0xldmVsRW5hYmxlZChlKX19LHtrZXk6Il93cml0ZVRvQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlLG4pe3JldHVybiBzZS53cml0ZVRvQ2xpZW50TG9nZ2VyKGUsbil9fSx7a2V5OiJfbG9nIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuX3Nob3VsZExvZyhlKSl7dmFyIHQ9c2UudXNlQ2xpZW50TG9nZ2VyP246dGhpcy5fY29udmVydFRvU2luZ2xlU3RhdGVtZW50KG4sZSk7cmV0dXJuIHRoaXMuX3dyaXRlVG9DbGllbnRMb2dnZXIoZSx0KX19fSx7a2V5OiJfY29udmVydFRvU2luZ2xlU3RhdGVtZW50Iix2YWx1ZTpmdW5jdGlvbihlLG4pe3ZhciB0PW5ldyBEYXRlKERhdGUubm93KCkpLnRvSVNPU3RyaW5nKCksbz10aGlzLl9nZXRMb2dMZXZlbEJ5VmFsdWUobikscj0iWyIuY29uY2F0KHQsIl1bIikuY29uY2F0KG8sIl0iKTt0aGlzLnByZWZpeCYmKHIrPXRoaXMucHJlZml4KyIgIiksdGhpcy5vcHRpb25zJiYodGhpcy5vcHRpb25zLnByZWZpeD9yKz0iICIrdGhpcy5vcHRpb25zLnByZWZpeCsiOiI6cis9IiIsdGhpcy5vcHRpb25zLmxvZ01ldGFEYXRhP3IrPSIgTWV0YSBkYXRhOiAiK0pTT04uc3RyaW5naWZ5KHRoaXMub3B0aW9ucy5sb2dNZXRhRGF0YSk6cis9IiIpO2Zvcih2YXIgaT0wO2k8ZS5sZW5ndGg7aSsrKXt2YXIgYz1lW2ldO3IrPXRoaXMuX2NvbnZlcnRUb1N0cmluZyhjKSsiICJ9cmV0dXJuIHJ9fSx7a2V5OiJfZ2V0TG9nTGV2ZWxCeVZhbHVlIix2YWx1ZTpmdW5jdGlvbihlKXtzd2l0Y2goZSl7Y2FzZSAxMDpyZXR1cm4iREVCVUciO2Nhc2UgMjA6cmV0dXJuIklORk8iO2Nhc2UgMzA6cmV0dXJuIldBUk4iO2Nhc2UgNDA6cmV0dXJuIkVSUk9SIjtjYXNlIDUwOnJldHVybiJBRFZBTkNFRF9MT0cifX19LHtrZXk6Il9jb252ZXJ0VG9TdHJpbmciLHZhbHVlOmZ1bmN0aW9uKGUpe3RyeXtpZighZSlyZXR1cm4iIjtpZihWLmlzU3RyaW5nKGUpKXJldHVybiBlO2lmKFYuaXNPYmplY3QoZSkmJlYuaXNGdW5jdGlvbihlLnRvU3RyaW5nKSl7dmFyIG49ZS50b1N0cmluZygpO2lmKCJbb2JqZWN0IE9iamVjdF0iIT09bilyZXR1cm4gbn1yZXR1cm4gSlNPTi5zdHJpbmdpZnkoZSl9Y2F0Y2gobil7cmV0dXJuIGNvbnNvbGUuZXJyb3IoIkVycm9yIHdoaWxlIGNvbnZlcnRpbmcgYXJndW1lbnQgdG8gc3RyaW5nIixlLG4pLCIifX19XSksbn0oKSxhZT1mdW5jdGlvbigpe3ZhciBlPW5ldyBpZTtyZXR1cm4gZS5kZWJ1Zz1mdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiBjb25zb2xlLmRlYnVnLmFwcGx5KHdpbmRvdy5jb25zb2xlLFtdLmNvbmNhdChuKSl9LGUuaW5mbz1mdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiBjb25zb2xlLmluZm8uYXBwbHkod2luZG93LmNvbnNvbGUsW10uY29uY2F0KG4pKX0sZS53YXJuPWZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIGNvbnNvbGUud2Fybi5hcHBseSh3aW5kb3cuY29uc29sZSxbXS5jb25jYXQobikpfSxlLmVycm9yPWZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIGNvbnNvbGUuZXJyb3IuYXBwbHkod2luZG93LmNvbnNvbGUsW10uY29uY2F0KG4pKX0sZX0sc2U9bmV3IHJlO2Z1bmN0aW9uIHVlKGUsbil7Zm9yKHZhciB0PTA7dDxuLmxlbmd0aDt0Kyspe3ZhciBvPW5bdF07by5lbnVtZXJhYmxlPW8uZW51bWVyYWJsZXx8ITEsby5jb25maWd1cmFibGU9ITAsInZhbHVlImluIG8mJihvLndyaXRhYmxlPSEwKSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxvLmtleSxvKX19dmFyIGxlPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZShuKXt2YXIgdD1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06YTshZnVuY3Rpb24oZSxuKXtpZighKGUgaW5zdGFuY2VvZiBuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKX0odGhpcyxlKSx0aGlzLm51bUF0dGVtcHRzPTAsdGhpcy5leGVjdXRvcj1uLHRoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9uPSExLHRoaXMuZGVmYXVsdFJldHJ5PXR9dmFyIG4sdCxvO3JldHVybiBuPWUsKHQ9W3trZXk6InJldHJ5Iix2YWx1ZTpmdW5jdGlvbigpe3ZhciBlPXRoaXM7dGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb258fCh0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbj0hMCxzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7ZS5fZXhlY3V0ZSgpfSx0aGlzLl9nZXREZWxheSgpKSl9fSx7a2V5OiJfZXhlY3V0ZSIsdmFsdWU6ZnVuY3Rpb24oKXt0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbj0hMSx0aGlzLmV4ZWN1dG9yKCksdGhpcy5udW1BdHRlbXB0cysrfX0se2tleToiY29ubmVjdGVkIix2YWx1ZTpmdW5jdGlvbigpe3RoaXMubnVtQXR0ZW1wdHM9MH19LHtrZXk6Il9nZXREZWxheSIsdmFsdWU6ZnVuY3Rpb24oKXt2YXIgZT1NYXRoLnBvdygyLHRoaXMubnVtQXR0ZW1wdHMpKnRoaXMuZGVmYXVsdFJldHJ5O3JldHVybiBlPD0zZTQ/ZTozZTR9fSx7a2V5OiJnZXRJc0Nvbm5lY3RlZCIsdmFsdWU6ZnVuY3Rpb24oKXtyZXR1cm4hdGhpcy5udW1BdHRlbXB0c319XSkmJnVlKG4ucHJvdG90eXBlLHQpLG8mJnVlKG4sbyksZX0oKTt0LmQobiwiYSIsZnVuY3Rpb24oKXtyZXR1cm4gZGV9KTt2YXIgZmU9ZnVuY3Rpb24oKXt2YXIgZT1zZS5nZXRMb2dnZXIoe3ByZWZpeDpzfSksbj1WLmlzTmV0d29ya09ubGluZSgpLHQ9e3ByaW1hcnk6bnVsbCxzZWNvbmRhcnk6bnVsbH0sbz17cmVjb25uZWN0V2ViU29ja2V0OiEwLHdlYnNvY2tldEluaXRGYWlsZWQ6ITEsZXhwb25lbnRpYWxCYWNrT2ZmVGltZToxZTMsZXhwb25lbnRpYWxUaW1lb3V0SGFuZGxlOm51bGwsbGlmZVRpbWVUaW1lb3V0SGFuZGxlOm51bGwsd2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQ6bnVsbCxjb25uU3RhdGU6bnVsbH0scj17Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6MCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpudWxsLG5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOm51bGx9LGk9e3BlbmRpbmdSZXNwb25zZTohMSxpbnRlcnZhbEhhbmRsZTpudWxsfSxjPXtpbml0RmFpbHVyZTpuZXcgU2V0LGdldFdlYlNvY2tldFRyYW5zcG9ydDpudWxsLHN1YnNjcmlwdGlvblVwZGF0ZTpuZXcgU2V0LHN1YnNjcmlwdGlvbkZhaWx1cmU6bmV3IFNldCx0b3BpYzpuZXcgTWFwLGFsbE1lc3NhZ2U6bmV3IFNldCxjb25uZWN0aW9uR2FpbjpuZXcgU2V0LGNvbm5lY3Rpb25Mb3N0Om5ldyBTZXQsY29ubmVjdGlvbk9wZW46bmV3IFNldCxjb25uZWN0aW9uQ2xvc2U6bmV3IFNldH0sYT17Y29ubkNvbmZpZzpudWxsLHByb21pc2VIYW5kbGU6bnVsbCxwcm9taXNlQ29tcGxldGVkOiEwfSxxPXtzdWJzY3JpYmVkOm5ldyBTZXQscGVuZGluZzpuZXcgU2V0LHN1YnNjcmlwdGlvbkhpc3Rvcnk6bmV3IFNldH0sSj17cmVzcG9uc2VDaGVja0ludGVydmFsSWQ6bnVsbCxyZXF1ZXN0Q29tcGxldGVkOiEwLHJlU3Vic2NyaWJlSW50ZXJ2YWxJZDpudWxsLGNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM6MCxjb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0OjB9LEI9bmV3IGxlKGZ1bmN0aW9uKCl7aGUoKX0pLFg9bmV3IFNldChbRyx6LFBdKSwkPXNldEludGVydmFsKGZ1bmN0aW9uKCl7aWYobiE9PVYuaXNOZXR3b3JrT25saW5lKCkpe2lmKCEobj1WLmlzTmV0d29ya09ubGluZSgpKSlyZXR1cm4gZS5hZHZhbmNlZExvZyh1KSx2b2lkIENlKGUuaW5mbyh1KSk7dmFyIHQ9dGUoKTtuJiYoIXR8fFkodCxXZWJTb2NrZXQuQ0xPU0lORyl8fFkodCxXZWJTb2NrZXQuQ0xPU0VEKSkmJihlLmFkdmFuY2VkTG9nKGwpLENlKGUuaW5mbyhsKSksaGUoKSl9fSwyNTApLEs9ZnVuY3Rpb24obix0KXtuLmZvckVhY2goZnVuY3Rpb24obil7dHJ5e24odCl9Y2F0Y2gobil7Q2UoZS5lcnJvcigiRXJyb3IgZXhlY3V0aW5nIGNhbGxiYWNrIixuKSl9fSl9LFo9ZnVuY3Rpb24oZSl7aWYobnVsbD09PWUpcmV0dXJuIk5VTEwiO3N3aXRjaChlLnJlYWR5U3RhdGUpe2Nhc2UgV2ViU29ja2V0LkNPTk5FQ1RJTkc6cmV0dXJuIkNPTk5FQ1RJTkciO2Nhc2UgV2ViU29ja2V0Lk9QRU46cmV0dXJuIk9QRU4iO2Nhc2UgV2ViU29ja2V0LkNMT1NJTkc6cmV0dXJuIkNMT1NJTkciO2Nhc2UgV2ViU29ja2V0LkNMT1NFRDpyZXR1cm4iQ0xPU0VEIjtkZWZhdWx0OnJldHVybiJVTkRFRklORUQifX0sUT1mdW5jdGlvbigpe3ZhciBuPWFyZ3VtZW50cy5sZW5ndGg+MCYmdm9pZCAwIT09YXJndW1lbnRzWzBdP2FyZ3VtZW50c1swXToiIjtDZShlLmRlYnVnKCJbIituKyJdIFByaW1hcnkgV2ViU29ja2V0OiAiK1oodC5wcmltYXJ5KSsiIHwgU2Vjb25kYXJ5IFdlYlNvY2tldDogIitaKHQuc2Vjb25kYXJ5KSkpfSxZPWZ1bmN0aW9uKGUsbil7cmV0dXJuIGUmJmUucmVhZHlTdGF0ZT09PW59LGVlPWZ1bmN0aW9uKGUpe3JldHVybiBZKGUsV2ViU29ja2V0Lk9QRU4pfSxuZT1mdW5jdGlvbihlKXtyZXR1cm4gbnVsbD09PWV8fHZvaWQgMD09PWUucmVhZHlTdGF0ZXx8WShlLFdlYlNvY2tldC5DTE9TRUQpfSx0ZT1mdW5jdGlvbigpe3JldHVybiBudWxsIT09dC5zZWNvbmRhcnk/dC5zZWNvbmRhcnk6dC5wcmltYXJ5fSxvZT1mdW5jdGlvbigpe3JldHVybiBlZSh0ZSgpKX0scmU9ZnVuY3Rpb24oKXtpZihpLnBlbmRpbmdSZXNwb25zZSlyZXR1cm4gZS5hZHZhbmNlZExvZyhkKSxDZShlLndhcm4oZCkpLGNsZWFySW50ZXJ2YWwoaS5pbnRlcnZhbEhhbmRsZSksaS5wZW5kaW5nUmVzcG9uc2U9ITEsdm9pZCBoZSgpO29lKCk/KENlKGUuZGVidWcoZykpLHRlKCkuc2VuZCh2ZShQKSksaS5wZW5kaW5nUmVzcG9uc2U9ITApOihlLmFkdmFuY2VkTG9nKGIpLENlKGUud2FybihiKSksUSgic2VuZEhlYXJ0QmVhdCIpLGhlKCkpfSxpZT1mdW5jdGlvbigpe2UuYWR2YW5jZWRMb2coUiksby5leHBvbmVudGlhbEJhY2tPZmZUaW1lPTFlMyxpLnBlbmRpbmdSZXNwb25zZT0hMSxvLnJlY29ubmVjdFdlYlNvY2tldD0hMCxjbGVhclRpbWVvdXQoby5saWZlVGltZVRpbWVvdXRIYW5kbGUpLGNsZWFySW50ZXJ2YWwoaS5pbnRlcnZhbEhhbmRsZSksY2xlYXJUaW1lb3V0KG8uZXhwb25lbnRpYWxUaW1lb3V0SGFuZGxlKSxjbGVhclRpbWVvdXQoby53ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZCl9LGNlPWZ1bmN0aW9uKCl7Si5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTAsSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsY2xlYXJJbnRlcnZhbChKLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkKSxjbGVhckludGVydmFsKEoucmVTdWJzY3JpYmVJbnRlcnZhbElkKX0sYWU9ZnVuY3Rpb24oKXtyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50PTAsci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZT1udWxsLHIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA9bnVsbH0sdWU9ZnVuY3Rpb24oKXtCLmNvbm5lY3RlZCgpO3RyeXtlLmFkdmFuY2VkTG9nKHkpLENlKGUuaW5mbyh5KSksUSgid2ViU29ja2V0T25PcGVuIiksbnVsbCE9PW8uY29ublN0YXRlJiZvLmNvbm5TdGF0ZSE9PVV8fEsoYy5jb25uZWN0aW9uR2Fpbiksby5jb25uU3RhdGU9SDt2YXIgbj1EYXRlLm5vdygpO0soYy5jb25uZWN0aW9uT3Blbix7Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLG5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOnIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXAsY29ubmVjdGlvbkVzdGFibGlzaGVkVGltZTpuLHRpbWVUb0Nvbm5lY3Q6bi1yLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLHRpbWVXaXRob3V0Q29ubmVjdGlvbjpyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wP24tci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSksYWUoKSxpZSgpLHRlKCkub3BlblRpbWVzdGFtcD1EYXRlLm5vdygpLDA9PT1xLnN1YnNjcmliZWQuc2l6ZSYmZWUodC5zZWNvbmRhcnkpJiZnZSh0LnByaW1hcnksIltQcmltYXJ5IFdlYlNvY2tldF0gQ2xvc2luZyBXZWJTb2NrZXQiKSwocS5zdWJzY3JpYmVkLnNpemU+MHx8cS5wZW5kaW5nLnNpemU+MCkmJihlZSh0LnNlY29uZGFyeSkmJkNlKGUuaW5mbygiU3Vic2NyaWJpbmcgc2Vjb25kYXJ5IHdlYnNvY2tldCB0byB0b3BpY3Mgb2YgcHJpbWFyeSB3ZWJzb2NrZXQiKSkscS5zdWJzY3JpYmVkLmZvckVhY2goZnVuY3Rpb24oZSl7cS5zdWJzY3JpcHRpb25IaXN0b3J5LmFkZChlKSxxLnBlbmRpbmcuYWRkKGUpfSkscS5zdWJzY3JpYmVkLmNsZWFyKCkscGUoKSkscmUoKSxpLmludGVydmFsSGFuZGxlPXNldEludGVydmFsKHJlLDFlNCk7dmFyIHM9MWUzKmEuY29ubkNvbmZpZy53ZWJTb2NrZXRUcmFuc3BvcnQudHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHM7Q2UoZS5kZWJ1ZygiU2NoZWR1bGluZyBXZWJTb2NrZXQgbWFuYWdlciByZWNvbm5lY3Rpb24sIGFmdGVyIGRlbGF5ICIrcysiIG1zIikpLG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtDZShlLmRlYnVnKCJTdGFydGluZyBzY2hlZHVsZWQgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uIikpLGhlKCl9LHMpfWNhdGNoKG4pe0NlKGUuZXJyb3IoIkVycm9yIGFmdGVyIGVzdGFibGlzaGluZyBXZWJTb2NrZXQgY29ubmVjdGlvbiIsbikpfX0sZmU9ZnVuY3Rpb24obil7USgid2ViU29ja2V0T25FcnJvciIpLGUuYWR2YW5jZWRMb2codixKU09OLnN0cmluZ2lmeShuKSksQ2UoZS5lcnJvcih2LEpTT04uc3RyaW5naWZ5KG4pKSksQi5nZXRJc0Nvbm5lY3RlZCgpP2hlKCk6Qi5yZXRyeSgpfSxkZT1mdW5jdGlvbihuKXt2YXIgbz1KU09OLnBhcnNlKG4uZGF0YSk7c3dpdGNoKG8udG9waWMpe2Nhc2UgRzppZihDZShlLmRlYnVnKCJTdWJzY3JpcHRpb24gTWVzc2FnZSByZWNlaXZlZCBmcm9tIHdlYlNvY2tldCBzZXJ2ZXIiLG4uZGF0YSkpLEoucmVxdWVzdENvbXBsZXRlZD0hMCxKLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCwic3VjY2VzcyI9PT1vLmNvbnRlbnQuc3RhdHVzKUouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wLG8uY29udGVudC50b3BpY3MuZm9yRWFjaChmdW5jdGlvbihlKXtxLnN1YnNjcmlwdGlvbkhpc3RvcnkuZGVsZXRlKGUpLHEucGVuZGluZy5kZWxldGUoZSkscS5zdWJzY3JpYmVkLmFkZChlKX0pLDA9PT1xLnN1YnNjcmlwdGlvbkhpc3Rvcnkuc2l6ZT9lZSh0LnNlY29uZGFyeSkmJihDZShlLmluZm8oIlN1Y2Nlc3NmdWxseSBzdWJzY3JpYmVkIHNlY29uZGFyeSB3ZWJzb2NrZXQgdG8gYWxsIHRvcGljcyBvZiBwcmltYXJ5IHdlYnNvY2tldCIpKSxnZSh0LnByaW1hcnksIltQcmltYXJ5IFdlYlNvY2tldF0gQ2xvc2luZyBXZWJTb2NrZXQiKSk6cGUoKSxLKGMuc3Vic2NyaXB0aW9uVXBkYXRlLG8pO2Vsc2V7aWYoY2xlYXJJbnRlcnZhbChKLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZCksKytKLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHMsNT09PUouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cylyZXR1cm4gSyhjLnN1YnNjcmlwdGlvbkZhaWx1cmUsbyksdm9pZChKLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCk7Si5yZVN1YnNjcmliZUludGVydmFsSWQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtwZSgpfSw1MDApfWJyZWFrO2Nhc2UgUDpDZShlLmRlYnVnKHApKSxpLnBlbmRpbmdSZXNwb25zZT0hMTticmVhaztkZWZhdWx0OmlmKG8udG9waWMpe2lmKGUuYWR2YW5jZWRMb2coRCxvLnRvcGljKSxDZShlLmRlYnVnKEQrby50b3BpYykpLGVlKHQucHJpbWFyeSkmJmVlKHQuc2Vjb25kYXJ5KSYmMD09PXEuc3Vic2NyaXB0aW9uSGlzdG9yeS5zaXplJiZ0aGlzPT09dC5wcmltYXJ5KXJldHVybiB2b2lkIENlKGUud2FybigiSWdub3JpbmcgTWVzc2FnZSBmb3IgVG9waWMgIitvLnRvcGljKyIsIHRvIGF2b2lkIGR1cGxpY2F0ZXMiKSk7aWYoMD09PWMuYWxsTWVzc2FnZS5zaXplJiYwPT09Yy50b3BpYy5zaXplKXJldHVybiB2b2lkIENlKGUud2FybigiTm8gcmVnaXN0ZXJlZCBjYWxsYmFjayBsaXN0ZW5lciBmb3IgVG9waWMiLG8udG9waWMpKTtlLmFkdmFuY2VkTG9nKE0sby50b3BpYyksSyhjLmFsbE1lc3NhZ2UsbyksYy50b3BpYy5oYXMoby50b3BpYykmJksoYy50b3BpYy5nZXQoby50b3BpYyksbyl9ZWxzZSBvLm1lc3NhZ2U/KGUuYWR2YW5jZWRMb2coeCxvKSxDZShlLndhcm4oeCxvKSkpOihlLmFkdmFuY2VkTG9nKGosbyksQ2UoZS53YXJuKGosbykpKX19LHBlPWZ1bmN0aW9uIG4oKXtpZihKLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q+MylyZXR1cm4gQ2UoZS53YXJuKCJJZ25vcmluZyBzdWJzY3JpYmVQZW5kaW5nVG9waWNzIHNpbmNlIHdlIGhhdmUgZXhoYXVzdGVkIG1heCBzdWJzY3JpcHRpb24gcmV0cmllcyB3aXRoIG5vIHJlc3BvbnNlIikpLHZvaWQgSyhjLnN1YnNjcmlwdGlvbkZhaWx1cmUsVi5nZXRTdWJzY3JpcHRpb25SZXNwb25zZShHLCExLEFycmF5LmZyb20ocS5wZW5kaW5nKSkpO29lKCk/MCE9PUFycmF5LmZyb20ocS5wZW5kaW5nKS5sZW5ndGgmJihjbGVhckludGVydmFsKEoucmVzcG9uc2VDaGVja0ludGVydmFsSWQpLHRlKCkuc2VuZCh2ZShHLHt0b3BpY3M6QXJyYXkuZnJvbShxLnBlbmRpbmcpfSkpLEoucmVxdWVzdENvbXBsZXRlZD0hMSxKLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkPXNldEludGVydmFsKGZ1bmN0aW9uKCl7Si5yZXF1ZXN0Q29tcGxldGVkfHwoKytKLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3QsbigpKX0sMWUzKSk6Q2UoZS53YXJuKCJJZ25vcmluZyBzdWJzY3JpYmVQZW5kaW5nVG9waWNzIGNhbGwgc2luY2UgRGVmYXVsdCBXZWJTb2NrZXQgaXMgbm90IG9wZW4iKSl9LGdlPWZ1bmN0aW9uKG4sdCl7WShuLFdlYlNvY2tldC5DT05ORUNUSU5HKXx8WShuLFdlYlNvY2tldC5PUEVOKT9uLmNsb3NlKDFlMyx0KTpDZShlLndhcm4oIklnbm9yaW5nIFdlYlNvY2tldCBDbG9zZSByZXF1ZXN0LCBXZWJTb2NrZXQgU3RhdGU6ICIrWihuKSkpfSxiZT1mdW5jdGlvbihlKXtnZSh0LnByaW1hcnksIltQcmltYXJ5XSBXZWJTb2NrZXQgIitlKSxnZSh0LnNlY29uZGFyeSwiW1NlY29uZGFyeV0gV2ViU29ja2V0ICIrZSl9LHllPWZ1bmN0aW9uKCl7ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCsrO3ZhciBuPVYuYWRkSml0dGVyKG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZSwuMyk7RGF0ZS5ub3coKStuPD1hLmNvbm5Db25maWcudXJsQ29ublZhbGlkVGltZT8oZS5hZHZhbmNlZExvZyhTKSxDZShlLmRlYnVnKFMrbisiIG1zIikpLG8uZXhwb25lbnRpYWxUaW1lb3V0SGFuZGxlPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtyZXR1cm4ga2UoKX0sbiksby5leHBvbmVudGlhbEJhY2tPZmZUaW1lKj0yKTooZS5hZHZhbmNlZExvZyhoKSxDZShlLndhcm4oaCkpLGhlKCkpfSxtZT1mdW5jdGlvbihuKXtpZSgpLGNlKCksZS5hZHZhbmNlZExvZyhrLG4pLENlKGUuZXJyb3IoaykpLG8ud2Vic29ja2V0SW5pdEZhaWxlZD0hMCxiZSh3KSxjbGVhckludGVydmFsKCQpLEsoYy5pbml0RmFpbHVyZSx7Y29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ6ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudCxjb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZTpyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lLHJlYXNvbjpufSksYWUoKX0sdmU9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkoe3RvcGljOmUsY29udGVudDpufSl9LFNlPWZ1bmN0aW9uKG4pe3JldHVybiEhKFYuaXNPYmplY3QobikmJlYuaXNPYmplY3Qobi53ZWJTb2NrZXRUcmFuc3BvcnQpJiZWLmlzTm9uRW1wdHlTdHJpbmcobi53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKSYmVi52YWxpZFdTVXJsKG4ud2ViU29ja2V0VHJhbnNwb3J0LnVybCkmJjFlMypuLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcz49M2U1KXx8KENlKGUuZXJyb3IoIkludmFsaWQgV2ViU29ja2V0IENvbm5lY3Rpb24gQ29uZmlndXJhdGlvbiIsbikpLCExKX0saGU9ZnVuY3Rpb24oKXtpZighVi5pc05ldHdvcmtPbmxpbmUoKSlyZXR1cm4gZS5hZHZhbmNlZExvZyhmKSx2b2lkIENlKGUuaW5mbyhmKSk7aWYoby53ZWJzb2NrZXRJbml0RmFpbGVkKUNlKGUuZGVidWcoIldlYlNvY2tldCBJbml0IGhhZCBmYWlsZWQsIGlnbm9yaW5nIHRoaXMgZ2V0V2ViU29ja2V0Q29ubkNvbmZpZyByZXF1ZXN0IikpO2Vsc2V7aWYoYS5wcm9taXNlQ29tcGxldGVkKXJldHVybiBpZSgpLGUuYWR2YW5jZWRMb2coQyksQ2UoZS5pbmZvKEMpKSxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPXIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWV8fERhdGUubm93KCksYS5wcm9taXNlQ29tcGxldGVkPSExLGEucHJvbWlzZUhhbmRsZT1jLmdldFdlYlNvY2tldFRyYW5zcG9ydCgpLGEucHJvbWlzZUhhbmRsZS50aGVuKGZ1bmN0aW9uKG4pe3JldHVybiBhLnByb21pc2VDb21wbGV0ZWQ9ITAsZS5hZHZhbmNlZExvZyhMKSxDZShlLmRlYnVnKEwsbikpLFNlKG4pPyhhLmNvbm5Db25maWc9bixhLmNvbm5Db25maWcudXJsQ29ublZhbGlkVGltZT1EYXRlLm5vdygpKzg1ZTMsa2UoKSk6KG1lKCJJbnZhbGlkIFdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb246ICIrbikse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9KX0sZnVuY3Rpb24obil7cmV0dXJuIGEucHJvbWlzZUNvbXBsZXRlZD0hMCxlLmFkdmFuY2VkTG9nKFQpLENlKGUuZXJyb3IoVCxuKSksVi5pc05ldHdvcmtGYWlsdXJlKG4pPyhlLmFkdmFuY2VkTG9nKE8rSlNPTi5zdHJpbmdpZnkobikpLENlKGUuaW5mbyhPK0pTT04uc3RyaW5naWZ5KG4pKSksQi5yZXRyeSgpKTptZSgiRmFpbGVkIHRvIGZldGNoIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb246ICIrSlNPTi5zdHJpbmdpZnkobikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfX0pO0NlKGUuZGVidWcoIlRoZXJlIGlzIGFuIG9uZ29pbmcgZ2V0V2ViU29ja2V0Q29ubkNvbmZpZyByZXF1ZXN0LCB0aGlzIHJlcXVlc3Qgd2lsbCBiZSBpZ25vcmVkIikpfX0sa2U9ZnVuY3Rpb24oKXtpZihvLndlYnNvY2tldEluaXRGYWlsZWQpcmV0dXJuIENlKGUuaW5mbygid2ViLXNvY2tldCBpbml0aWFsaXppbmcgaGFkIGZhaWxlZCwgYWJvcnRpbmcgcmUtaW5pdCIpKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH07aWYoIVYuaXNOZXR3b3JrT25saW5lKCkpcmV0dXJuIENlKGUud2FybigiU3lzdGVtIGlzIG9mZmxpbmUgYWJvcnRpbmcgd2ViLXNvY2tldCBpbml0IikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfTtlLmFkdmFuY2VkTG9nKFcpLENlKGUuaW5mbyhXKSksUSgiaW5pdFdlYlNvY2tldCIpO3RyeXtpZihTZShhLmNvbm5Db25maWcpKXt2YXIgbj1udWxsO3JldHVybiBlZSh0LnByaW1hcnkpPyhDZShlLmRlYnVnKCJQcmltYXJ5IFNvY2tldCBjb25uZWN0aW9uIGlzIGFscmVhZHkgb3BlbiIpKSxZKHQuc2Vjb25kYXJ5LFdlYlNvY2tldC5DT05ORUNUSU5HKXx8KENlKGUuZGVidWcoIkVzdGFibGlzaGluZyBhIHNlY29uZGFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSksQi5udW1BdHRlbXB0cz0wLHQuc2Vjb25kYXJ5PXdlKCkpLG49dC5zZWNvbmRhcnkpOihZKHQucHJpbWFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChDZShlLmRlYnVnKCJFc3RhYmxpc2hpbmcgYSBwcmltYXJ5IHdlYi1zb2NrZXQgY29ubmVjdGlvbiIpKSx0LnByaW1hcnk9d2UoKSksbj10LnByaW1hcnkpLG8ud2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQ9c2V0VGltZW91dChmdW5jdGlvbigpe2VlKG4pfHx5ZSgpfSwxZTMpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiExfX19Y2F0Y2gobil7cmV0dXJuIENlKGUuZXJyb3IoIkVycm9yIEluaXRpYWxpemluZyB3ZWItc29ja2V0LW1hbmFnZXIiLG4pKSxtZSgiRmFpbGVkIHRvIGluaXRpYWxpemUgbmV3IFdlYlNvY2tldDogIituLm1lc3NhZ2UpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfX19LHdlPWZ1bmN0aW9uKCl7dmFyIG49bmV3IFdlYlNvY2tldChhLmNvbm5Db25maWcud2ViU29ja2V0VHJhbnNwb3J0LnVybCk7cmV0dXJuIG4uYWRkRXZlbnRMaXN0ZW5lcigib3BlbiIsdWUpLG4uYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsZGUpLG4uYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLGZlKSxuLmFkZEV2ZW50TGlzdGVuZXIoImNsb3NlIixmdW5jdGlvbihpKXtyZXR1cm4gZnVuY3Rpb24obixpKXtlLmFkdmFuY2VkTG9nKG0sSlNPTi5zdHJpbmdpZnkobikpLENlKGUuaW5mbyhtLEpTT04uc3RyaW5naWZ5KG4pKSksUSgid2ViU29ja2V0T25DbG9zZSBiZWZvcmUtY2xlYW51cCIpLEsoYy5jb25uZWN0aW9uQ2xvc2Use29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLG5lKHQucHJpbWFyeSkmJih0LnByaW1hcnk9bnVsbCksbmUodC5zZWNvbmRhcnkpJiYodC5zZWNvbmRhcnk9bnVsbCksby5yZWNvbm5lY3RXZWJTb2NrZXQmJihlZSh0LnByaW1hcnkpfHxlZSh0LnNlY29uZGFyeSk/bmUodC5wcmltYXJ5KSYmZWUodC5zZWNvbmRhcnkpJiYoQ2UoZS5pbmZvKCJbUHJpbWFyeV0gV2ViU29ja2V0IENsZWFubHkgQ2xvc2VkIikpLHQucHJpbWFyeT10LnNlY29uZGFyeSx0LnNlY29uZGFyeT1udWxsKTooQ2UoZS53YXJuKCJOZWl0aGVyIHByaW1hcnkgd2Vic29ja2V0IGFuZCBub3Igc2Vjb25kYXJ5IHdlYnNvY2tldCBoYXZlIG9wZW4gY29ubmVjdGlvbnMsIGF0dGVtcHRpbmcgdG8gcmUtZXN0YWJsaXNoIGNvbm5lY3Rpb24iKSksby5jb25uU3RhdGU9PT1VP0NlKGUuaW5mbygiSWdub3JpbmcgY29ubmVjdGlvbkxvc3QgY2FsbGJhY2sgaW52b2NhdGlvbiIpKTooSyhjLmNvbm5lY3Rpb25Mb3N0LHtvcGVuVGltZXN0YW1wOmkub3BlblRpbWVzdGFtcCxjbG9zZVRpbWVzdGFtcDpEYXRlLm5vdygpLGNvbm5lY3Rpb25EdXJhdGlvbjpEYXRlLm5vdygpLWkub3BlblRpbWVzdGFtcCxjb2RlOm4uY29kZSxyZWFzb246bi5yZWFzb259KSxyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wPURhdGUubm93KCkpLG8uY29ublN0YXRlPVUsaGUoKSksUSgid2ViU29ja2V0T25DbG9zZSBhZnRlci1jbGVhbnVwIikpfShpLG4pfSksbn0sQ2U9ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBlLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyJiZlLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCksZX07dGhpcy5pbml0PWZ1bmN0aW9uKG4pe2lmKFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksInRyYW5zcG9ydEhhbmRsZSBtdXN0IGJlIGEgZnVuY3Rpb24iKSxudWxsPT09Yy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQpcmV0dXJuIGMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0PW4saGUoKTtDZShlLndhcm4oIldlYiBTb2NrZXQgTWFuYWdlciB3YXMgYWxyZWFkeSBpbml0aWFsaXplZCIpKX0sdGhpcy5vbkluaXRGYWlsdXJlPWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKEkpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuaW5pdEZhaWx1cmUuYWRkKG4pLG8ud2Vic29ja2V0SW5pdEZhaWxlZCYmbigpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuaW5pdEZhaWx1cmUuZGVsZXRlKG4pfX0sdGhpcy5vbkNvbm5lY3Rpb25PcGVuPWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKE4pLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbk9wZW4uYWRkKG4pLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbk9wZW4uZGVsZXRlKG4pfX0sdGhpcy5vbkNvbm5lY3Rpb25DbG9zZT1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhfKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25DbG9zZS5hZGQobiksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uQ2xvc2UuZGVsZXRlKG4pfX0sdGhpcy5vbkNvbm5lY3Rpb25HYWluPWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKEUpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkdhaW4uYWRkKG4pLG9lKCkmJm4oKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25HYWluLmRlbGV0ZShuKX19LHRoaXMub25Db25uZWN0aW9uTG9zdD1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhGKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25Mb3N0LmFkZChuKSxvLmNvbm5TdGF0ZT09PVUmJm4oKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25Mb3N0LmRlbGV0ZShuKX19LHRoaXMub25TdWJzY3JpcHRpb25VcGRhdGU9ZnVuY3Rpb24oZSl7cmV0dXJuIFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuc3Vic2NyaXB0aW9uVXBkYXRlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvblVwZGF0ZS5kZWxldGUoZSl9fSx0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZT1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhBKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnN1YnNjcmlwdGlvbkZhaWx1cmUuYWRkKG4pLGZ1bmN0aW9uKCl7cmV0dXJuIGMuc3Vic2NyaXB0aW9uRmFpbHVyZS5kZWxldGUobil9fSx0aGlzLm9uTWVzc2FnZT1mdW5jdGlvbihlLG4pe3JldHVybiBWLmFzc2VydE5vdE51bGwoZSwidG9waWNOYW1lIiksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy50b3BpYy5oYXMoZSk/Yy50b3BpYy5nZXQoZSkuYWRkKG4pOmMudG9waWMuc2V0KGUsbmV3IFNldChbbl0pKSxmdW5jdGlvbigpe3JldHVybiBjLnRvcGljLmdldChlKS5kZWxldGUobil9fSx0aGlzLm9uQWxsTWVzc2FnZT1mdW5jdGlvbihlKXtyZXR1cm4gVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5hbGxNZXNzYWdlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmFsbE1lc3NhZ2UuZGVsZXRlKGUpfX0sdGhpcy5zdWJzY3JpYmVUb3BpY3M9ZnVuY3Rpb24oZSl7Vi5hc3NlcnROb3ROdWxsKGUsInRvcGljcyIpLFYuYXNzZXJ0SXNMaXN0KGUpLGUuZm9yRWFjaChmdW5jdGlvbihlKXtxLnN1YnNjcmliZWQuaGFzKGUpfHxxLnBlbmRpbmcuYWRkKGUpfSksSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAscGUoKX0sdGhpcy5zZW5kTWVzc2FnZT1mdW5jdGlvbihuKXtpZihWLmFzc2VydElzT2JqZWN0KG4sInBheWxvYWQiKSx2b2lkIDA9PT1uLnRvcGljfHxYLmhhcyhuLnRvcGljKSlDZShlLndhcm4oIkNhbm5vdCBzZW5kIG1lc3NhZ2UsIEludmFsaWQgdG9waWMiLG4pKTtlbHNle3RyeXtuPUpTT04uc3RyaW5naWZ5KG4pfWNhdGNoKHQpe3JldHVybiB2b2lkIENlKGUud2FybigiRXJyb3Igc3RyaW5naWZ5IG1lc3NhZ2UiLG4pKX1vZSgpP3RlKCkuc2VuZChuKTpDZShlLndhcm4oIkNhbm5vdCBzZW5kIG1lc3NhZ2UsIHdlYiBzb2NrZXQgY29ubmVjdGlvbiBpcyBub3Qgb3BlbiIpKX19LHRoaXMuY2xvc2VXZWJTb2NrZXQ9ZnVuY3Rpb24oKXtpZSgpLGNlKCksby5yZWNvbm5lY3RXZWJTb2NrZXQ9ITEsY2xlYXJJbnRlcnZhbCgkKSxiZSgiVXNlciByZXF1ZXN0IHRvIGNsb3NlIFdlYlNvY2tldCIpfSx0aGlzLnRlcm1pbmF0ZVdlYlNvY2tldE1hbmFnZXI9bWV9LGRlPXtjcmVhdGU6ZnVuY3Rpb24oKXtyZXR1cm4gbmV3IGZlfSxzZXRHbG9iYWxDb25maWc6ZnVuY3Rpb24oZSl7dmFyIG49ZSYmZS5sb2dnZXJDb25maWc7c2UudXBkYXRlTG9nZ2VyQ29uZmlnKG4pfSxMb2dMZXZlbDpvZSxMb2dnZXI6bmV9fSxmdW5jdGlvbihlLG4sdCl7dmFyIG87IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO3ZhciByPXtub3Rfc3RyaW5nOi9bXnNdLyxub3RfYm9vbDovW150XS8sbm90X3R5cGU6L1teVF0vLG5vdF9wcmltaXRpdmU6L1tedl0vLG51bWJlcjovW2RpZWZnXS8sbnVtZXJpY19hcmc6L1tiY2RpZWZndXhYXS8sanNvbjovW2pdLyxub3RfanNvbjovW15qXS8sdGV4dDovXlteXHgyNV0rLyxtb2R1bG86L15ceDI1ezJ9LyxwbGFjZWhvbGRlcjovXlx4MjUoPzooWzEtOV1cZCopXCR8XCgoW14pXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZ2lqb3N0VHV2eFhdKS8sa2V5Oi9eKFthLXpfXVthLXpfXGRdKikvaSxrZXlfYWNjZXNzOi9eXC4oW2Etel9dW2Etel9cZF0qKS9pLGluZGV4X2FjY2VzczovXlxbKFxkKylcXS8sc2lnbjovXlsrLV0vfTtmdW5jdGlvbiBpKGUpe3JldHVybiBmdW5jdGlvbihlLG4pe3ZhciB0LG8sYyxhLHMsdSxsLGYsZCxwPTEsZz1lLmxlbmd0aCxiPSIiO2ZvcihvPTA7bzxnO28rKylpZigic3RyaW5nIj09dHlwZW9mIGVbb10pYis9ZVtvXTtlbHNlIGlmKCJvYmplY3QiPT10eXBlb2YgZVtvXSl7aWYoKGE9ZVtvXSkua2V5cylmb3IodD1uW3BdLGM9MDtjPGEua2V5cy5sZW5ndGg7YysrKXtpZihudWxsPT10KXRocm93IG5ldyBFcnJvcihpKCdbc3ByaW50Zl0gQ2Fubm90IGFjY2VzcyBwcm9wZXJ0eSAiJXMiIG9mIHVuZGVmaW5lZCB2YWx1ZSAiJXMiJyxhLmtleXNbY10sYS5rZXlzW2MtMV0pKTt0PXRbYS5rZXlzW2NdXX1lbHNlIHQ9YS5wYXJhbV9ubz9uW2EucGFyYW1fbm9dOm5bcCsrXTtpZihyLm5vdF90eXBlLnRlc3QoYS50eXBlKSYmci5ub3RfcHJpbWl0aXZlLnRlc3QoYS50eXBlKSYmdCBpbnN0YW5jZW9mIEZ1bmN0aW9uJiYodD10KCkpLHIubnVtZXJpY19hcmcudGVzdChhLnR5cGUpJiYibnVtYmVyIiE9dHlwZW9mIHQmJmlzTmFOKHQpKXRocm93IG5ldyBUeXBlRXJyb3IoaSgiW3NwcmludGZdIGV4cGVjdGluZyBudW1iZXIgYnV0IGZvdW5kICVUIix0KSk7c3dpdGNoKHIubnVtYmVyLnRlc3QoYS50eXBlKSYmKGY9dD49MCksYS50eXBlKXtjYXNlImIiOnQ9cGFyc2VJbnQodCwxMCkudG9TdHJpbmcoMik7YnJlYWs7Y2FzZSJjIjp0PVN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQodCwxMCkpO2JyZWFrO2Nhc2UiZCI6Y2FzZSJpIjp0PXBhcnNlSW50KHQsMTApO2JyZWFrO2Nhc2UiaiI6dD1KU09OLnN0cmluZ2lmeSh0LG51bGwsYS53aWR0aD9wYXJzZUludChhLndpZHRoKTowKTticmVhaztjYXNlImUiOnQ9YS5wcmVjaXNpb24/cGFyc2VGbG9hdCh0KS50b0V4cG9uZW50aWFsKGEucHJlY2lzaW9uKTpwYXJzZUZsb2F0KHQpLnRvRXhwb25lbnRpYWwoKTticmVhaztjYXNlImYiOnQ9YS5wcmVjaXNpb24/cGFyc2VGbG9hdCh0KS50b0ZpeGVkKGEucHJlY2lzaW9uKTpwYXJzZUZsb2F0KHQpO2JyZWFrO2Nhc2UiZyI6dD1hLnByZWNpc2lvbj9TdHJpbmcoTnVtYmVyKHQudG9QcmVjaXNpb24oYS5wcmVjaXNpb24pKSk6cGFyc2VGbG9hdCh0KTticmVhaztjYXNlIm8iOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoOCk7YnJlYWs7Y2FzZSJzIjp0PVN0cmluZyh0KSx0PWEucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAsYS5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ0Ijp0PVN0cmluZyghIXQpLHQ9YS5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxhLnByZWNpc2lvbik6dDticmVhaztjYXNlIlQiOnQ9T2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHQpLnNsaWNlKDgsLTEpLnRvTG93ZXJDYXNlKCksdD1hLnByZWNpc2lvbj90LnN1YnN0cmluZygwLGEucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UidSI6dD1wYXJzZUludCh0LDEwKT4+PjA7YnJlYWs7Y2FzZSJ2Ijp0PXQudmFsdWVPZigpLHQ9YS5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxhLnByZWNpc2lvbik6dDticmVhaztjYXNlIngiOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoMTYpO2JyZWFrO2Nhc2UiWCI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKX1yLmpzb24udGVzdChhLnR5cGUpP2IrPXQ6KCFyLm51bWJlci50ZXN0KGEudHlwZSl8fGYmJiFhLnNpZ24/ZD0iIjooZD1mPyIrIjoiLSIsdD10LnRvU3RyaW5nKCkucmVwbGFjZShyLnNpZ24sIiIpKSx1PWEucGFkX2NoYXI/IjAiPT09YS5wYWRfY2hhcj8iMCI6YS5wYWRfY2hhci5jaGFyQXQoMSk6IiAiLGw9YS53aWR0aC0oZCt0KS5sZW5ndGgscz1hLndpZHRoJiZsPjA/dS5yZXBlYXQobCk6IiIsYis9YS5hbGlnbj9kK3QrczoiMCI9PT11P2Qrcyt0OnMrZCt0KX1yZXR1cm4gYn0oZnVuY3Rpb24oZSl7aWYoYVtlXSlyZXR1cm4gYVtlXTt2YXIgbix0PWUsbz1bXSxpPTA7Zm9yKDt0Oyl7aWYobnVsbCE9PShuPXIudGV4dC5leGVjKHQpKSlvLnB1c2goblswXSk7ZWxzZSBpZihudWxsIT09KG49ci5tb2R1bG8uZXhlYyh0KSkpby5wdXNoKCIlIik7ZWxzZXtpZihudWxsPT09KG49ci5wbGFjZWhvbGRlci5leGVjKHQpKSl0aHJvdyBuZXcgU3ludGF4RXJyb3IoIltzcHJpbnRmXSB1bmV4cGVjdGVkIHBsYWNlaG9sZGVyIik7aWYoblsyXSl7aXw9MTt2YXIgYz1bXSxzPW5bMl0sdT1bXTtpZihudWxsPT09KHU9ci5rZXkuZXhlYyhzKSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gZmFpbGVkIHRvIHBhcnNlIG5hbWVkIGFyZ3VtZW50IGtleSIpO2ZvcihjLnB1c2godVsxXSk7IiIhPT0ocz1zLnN1YnN0cmluZyh1WzBdLmxlbmd0aCkpOylpZihudWxsIT09KHU9ci5rZXlfYWNjZXNzLmV4ZWMocykpKWMucHVzaCh1WzFdKTtlbHNle2lmKG51bGw9PT0odT1yLmluZGV4X2FjY2Vzcy5leGVjKHMpKSl0aHJvdyBuZXcgU3ludGF4RXJyb3IoIltzcHJpbnRmXSBmYWlsZWQgdG8gcGFyc2UgbmFtZWQgYXJndW1lbnQga2V5Iik7Yy5wdXNoKHVbMV0pfW5bMl09Y31lbHNlIGl8PTI7aWYoMz09PWkpdGhyb3cgbmV3IEVycm9yKCJbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkIik7by5wdXNoKHtwbGFjZWhvbGRlcjpuWzBdLHBhcmFtX25vOm5bMV0sa2V5czpuWzJdLHNpZ246blszXSxwYWRfY2hhcjpuWzRdLGFsaWduOm5bNV0sd2lkdGg6bls2XSxwcmVjaXNpb246bls3XSx0eXBlOm5bOF19KX10PXQuc3Vic3RyaW5nKG5bMF0ubGVuZ3RoKX1yZXR1cm4gYVtlXT1vfShlKSxhcmd1bWVudHMpfWZ1bmN0aW9uIGMoZSxuKXtyZXR1cm4gaS5hcHBseShudWxsLFtlXS5jb25jYXQobnx8W10pKX12YXIgYT1PYmplY3QuY3JlYXRlKG51bGwpO24uc3ByaW50Zj1pLG4udnNwcmludGY9YywidW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdyYmKHdpbmRvdy5zcHJpbnRmPWksd2luZG93LnZzcHJpbnRmPWMsdm9pZCAwPT09KG89ZnVuY3Rpb24oKXtyZXR1cm57c3ByaW50ZjppLHZzcHJpbnRmOmN9fS5jYWxsKG4sdCxuLGUpKXx8KGUuZXhwb3J0cz1vKSl9KCl9LGZ1bmN0aW9uKGUsbix0KXsidXNlIHN0cmljdCI7dC5yKG4pLGZ1bmN0aW9uKGUpe3QuZChuLCJXZWJTb2NrZXRNYW5hZ2VyIixmdW5jdGlvbigpe3JldHVybiByfSk7dmFyIG89dCgwKTtlLmNvbm5lY3Q9ZS5jb25uZWN0fHx7fSxjb25uZWN0LldlYlNvY2tldE1hbmFnZXI9by5hO3ZhciByPW8uYX0uY2FsbCh0aGlzLHQoMykpfSxmdW5jdGlvbihlLG4pe3ZhciB0O3Q9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpc30oKTt0cnl7dD10fHxuZXcgRnVuY3Rpb24oInJldHVybiB0aGlzIikoKX1jYXRjaChlKXsib2JqZWN0Ij09dHlwZW9mIHdpbmRvdyYmKHQ9d2luZG93KX1lLmV4cG9ydHM9dH1dKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9YW1hem9uLWNvbm5lY3Qtd2Vic29ja2V0LW1hbmFnZXIuanMubWFwCgoKLyoqKi8gfSksCgovKioqLyAxNTE6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAvLyBIb3cgZnJlcXVlbnRseSBzb2Z0cGhvbmUgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCByZXBvcnRlZCB0byBzaGFyZWQgd29ya2VyLgogIHZhciBTT0ZUUEhPTkVfTE9HX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMgPSA1MDAwOwoKICAvLyBIb3cgZnJlcXVlbnRseSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIHNlbnQgZG93bnN0cmVhbQogIHZhciBMT0dTX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMgPSA1MDAwOwoKICAvLyBUaGUgZGVmYXVsdCBsb2cgcm9sbCBpbnRlcnZhbCAoMzBtaW4pCiAgdmFyIERFRkFVTFRfTE9HX1JPTExfSU5URVJWQUwgPSAxODAwMDAwOwoKICAvKioKICAgKiBBbiBlbnVtZXJhdGlvbiBvZiBjb21tb24gbG9nZ2luZyBsZXZlbHMuCiAgICovCiAgdmFyIExvZ0xldmVsID0gewogICAgVEVTVDogIlRFU1QiLAogICAgVFJBQ0U6ICJUUkFDRSIsCiAgICBERUJVRzogIkRFQlVHIiwKICAgIElORk86ICJJTkZPIiwKICAgIExPRzogIkxPRyIsCiAgICBXQVJOOiAiV0FSTiIsCiAgICBFUlJPUjogIkVSUk9SIiwKICAgIENSSVRJQ0FMOiAiQ1JJVElDQUwiCiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgY29tcG9uZW50cy4KICAgKi8KICB2YXIgTG9nQ29tcG9uZW50ID0gewogICAgQ0NQOiAiY2NwIiwKICAgIFNPRlRQSE9ORTogInNvZnRwaG9uZSIsCiAgICBDSEFUOiAiY2hhdCIsCiAgICBUQVNLOiAidGFzayIKICB9OwoKICAvKioKICAgKiBUaGUgbnVtZXJpYyBvcmRlciBvZiB0aGUgbG9nZ2luZyBsZXZlbHMgYWJvdmUuCiAgICogVGhleSBhcmUgc3BhY2VkIHRvIGFsbG93IHRoZSBhZGRpdGlvbiBvZiBvdGhlciBsb2cKICAgKiBsZXZlbHMgYXQgYSBsYXRlciB0aW1lLgogICAqLwogIHZhciBMb2dMZXZlbE9yZGVyID0gewogICAgVEVTVDogMCwKICAgIFRSQUNFOiAxMCwKICAgIERFQlVHOiAyMCwKICAgIElORk86IDMwLAogICAgTE9HOiA0MCwKICAgIFdBUk46IDUwLAogICAgRVJST1I6IDEwMCwKICAgIENSSVRJQ0FMOiAyMDAKCiAgfTsKCiAgLyoqCiAgICogQSBtYXAgZnJvbSBsb2cgbGV2ZWwgdG8gY29uc29sZSBsb2dnZXIgZnVuY3Rpb24uCiAgICovCiAgdmFyIENPTlNPTEVfTE9HR0VSX01BUCA9IHsKICAgIFRSQUNFOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmluZm8odGV4dCk7IH0sCiAgICBERUJVRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgSU5GTzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgTE9HOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFRFU1Q6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUubG9nKHRleHQpOyB9LAogICAgV0FSTjogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS53YXJuKHRleHQpOyB9LAogICAgRVJST1I6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0sCiAgICBDUklUSUNBTDogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5lcnJvcih0ZXh0KTsgfQogIH07CgogIC8qKgogICogQ2hlY2tzIGlmIGl0IGlzIGEgdmFsaWQgbG9nIGNvbXBvbmVudCBlbnVtCiAgKi8KCiAgdmFyIGlzVmFsaWRMb2dDb21wb25lbnQgPSBmdW5jdGlvbiAoY29tcG9uZW50KSB7CiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhMb2dDb21wb25lbnQpLmluZGV4T2YoY29tcG9uZW50KSAhPT0gLTE7CiAgfTsKCiAgLyoqCiAgKiBFeHRyYWN0IHRoZSBjdXN0b20gYXJndW1lbnRzIGFzIHJlcXVpcmVkIGJ5IHRoZSBsb2dnZXIKICAqLwogIHZhciBleHRyYWN0TG9nZ2VyQXJncyA9IGZ1bmN0aW9uIChsb2dnZXJBcmdzKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGxvZ2dlckFyZ3MsIDApOwogICAgdmFyIGZpcnN0QXJnID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGZvcm1hdDsKICAgIHZhciBjb21wb25lbnQ7CgogICAgaWYgKGlzVmFsaWRMb2dDb21wb25lbnQoZmlyc3RBcmcpKSB7CiAgICAgIGNvbXBvbmVudCA9IGZpcnN0QXJnOwogICAgICBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB9IGVsc2UgewogICAgICAvL2RlZmF1bHQgdG8gQ0NQIGNvbXBvbmVudAogICAgICBmb3JtYXQgPSBmaXJzdEFyZzsKICAgICAgY29tcG9uZW50ID0gTG9nQ29tcG9uZW50LkNDUDsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBmb3JtYXQ6IGZvcm1hdCwKICAgICAgY29tcG9uZW50OiBjb21wb25lbnQsCiAgICAgIGFyZ3M6IGFyZ3MKICAgIH07CiAgfTsKCiAgLyoqCiAgICogQSBsb2cgZW50cnkuCiAgICoKICAgKiBAcGFyYW0gY29tcG9uZW50IFRoZSBsb2dnaW5nIGNvbXBvbmVudC4KICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxvZyBsZXZlbCBvZiB0aGlzIGxvZyBlbnRyeS4KICAgKiBAcGFyYW0gdGV4dCBUaGUgdGV4dCBjb250YWluZWQgaW4gdGhlIGxvZyBlbnRyeS4KICAgKiBAcGFyYW0gbG9nZ2VySWQgVGhlIHJvb3QgbG9nZ2VyIGlkLgogICAqCiAgICogTG9nIGVudHJpZXMgYXJlIGF3YXJlIG9mIHRoZWlyIHRpbWVzdGFtcCwgb3JkZXIsCiAgICogYW5kIGNhbiBjb250YWluIG9iamVjdHMgYW5kIGV4Y2VwdGlvbiBzdGFjayB0cmFjZXMuCiAgICovCiAgdmFyIExvZ0VudHJ5ID0gZnVuY3Rpb24gKGNvbXBvbmVudCwgbGV2ZWwsIHRleHQsIGxvZ2dlcklkKSB7CiAgICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDsKICAgIHRoaXMubGV2ZWwgPSBsZXZlbDsKICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB0aGlzLnRpbWUgPSBuZXcgRGF0ZSgpOwogICAgdGhpcy5leGNlcHRpb24gPSBudWxsOwogICAgdGhpcy5vYmplY3RzID0gW107CiAgICB0aGlzLmxpbmUgPSAwOwogICAgdGhpcy5hZ2VudFJlc291cmNlSWQgPSBudWxsOwogICAgdHJ5IHsKICAgICAgaWYgKGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQpewogICAgICAgIHRoaXMuYWdlbnRSZXNvdXJjZUlkID0gbmV3IGNvbm5lY3QuQWdlbnQoKS5fZ2V0UmVzb3VyY2VJZCgpOwogICAgICB9CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29uc29sZS5sb2coIklzc3VlIGZpbmRpbmcgYWdlbnRSZXNvdXJjZUlkOiAiLCBlKTsgLy9jYW4ndCB1c2Ugb3VyIGxvZ2dlciBoZXJlIGFzIHdlIG1pZ2h0IGluZmluaXRlbHkgYXR0ZW1wdCB0byBsb2cgdGhpcyBlcnJvci4KICAgIH0KICAgIHRoaXMubG9nZ2VySWQgPSBsb2dnZXJJZDsKICB9OwoKICBMb2dFbnRyeS5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGVudHJ5ID0gbmV3IExvZ0VudHJ5KExvZ0NvbXBvbmVudC5DQ1AsIG9iai5sZXZlbCwgb2JqLnRleHQsIG9iai5sb2dnZXJJZCk7CgogICAgLy8gUmVxdWlyZWQgdG8gY2hlY2sgZm9yIERhdGUgb2JqZWN0cyBzZW50IGFjcm9zcyBmcmFtZSBib3VuZGFyaWVzCiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iai50aW1lKSA9PT0gJ1tvYmplY3QgRGF0ZV0nKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZShvYmoudGltZS5nZXRUaW1lKCkpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdudW1iZXInKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZShvYmoudGltZSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmoudGltZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZW50cnkudGltZSA9IERhdGUucGFyc2Uob2JqLnRpbWUpOwogICAgfSBlbHNlIHsKICAgICAgZW50cnkudGltZSA9IG5ldyBEYXRlKCk7CiAgICB9CiAgICBlbnRyeS5leGNlcHRpb24gPSBvYmouZXhjZXB0aW9uOwogICAgZW50cnkub2JqZWN0cyA9IG9iai5vYmplY3RzOwogICAgcmV0dXJuIGVudHJ5OwogIH07CgogIC8qKgogICAqIFByaXZhdGUgbWV0aG9kIHRvIHJlbW92ZSBzZW5zaXRpdmUgaW5mbyBmcm9tIGNsaWVudCBsb2cKICAgKi8KICB2YXIgcmVkYWN0U2Vuc2l0aXZlSW5mbyA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHZhciBhdXRoVG9rZW5SZWdleCA9IC9BdXRoVG9rZW4uKlw9L2c7CiAgICBpZihkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JykgewogICAgICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgIGlmICh0eXBlb2YgZGF0YVtrZXldID09PSAnb2JqZWN0JykgewogICAgICAgICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhkYXRhW2tleV0pCiAgICAgICAgfSBlbHNlIGlmKHR5cGVvZiBkYXRhW2tleV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAidXJsIiB8fCBrZXkgPT09ICJ0ZXh0IikgewogICAgICAgICAgICBkYXRhW2tleV0gPSBkYXRhW2tleV0ucmVwbGFjZShhdXRoVG9rZW5SZWdleCwgIltyZWRhY3RlZF0iKTsKICAgICAgICAgIH0gZWxzZSBpZiAoWyJxdWlja0Nvbm5lY3ROYW1lIl0uaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICBkYXRhW2tleV0gPSAiW3JlZGFjdGVkXSI7CiAgICAgICAgICB9IGVsc2UgaWYgKFsiY3VzdG9tZXJJZCIsICJDdXN0b21lcklkIiwgIlNwZWFrZXJJZCIsICJDdXN0b21lclNwZWFrZXJJZCJdLmluY2x1ZGVzKGtleSkpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gbWQ1KGRhdGFba2V5XSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIFB1bGxzIHRoZSB0eXBlLCBtZXNzYWdlLCBhbmQgc3RhY2sgdHJhY2UKICAgKiBvdXQgb2YgdGhlIGdpdmVuIGV4Y2VwdGlvbiBmb3IgSlNPTiBzZXJpYWxpemF0aW9uLgogICAqLwogIHZhciBMb2dnZWRFeGNlcHRpb24gPSBmdW5jdGlvbiAoZSkgewogICAgdGhpcy50eXBlID0gKGUgaW5zdGFuY2VvZiBFcnJvcikgPyBlLm5hbWUgOiBlLmNvZGUgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGUpOwogICAgdGhpcy5tZXNzYWdlID0gZS5tZXNzYWdlOwogICAgdGhpcy5zdGFjayA9IFtdOwogICAgaWYgKGUuc3RhY2spewogICAgICB0cnkgewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZS5zdGFjaykpIHsKICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gZS5zdGFjazsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGUuc3RhY2sgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgdGhpcy5zdGFjayA9IFtKU09OLnN0cmluZ2lmeShlLnN0YWNrKV07CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlLnN0YWNrID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBlLnN0YWNrLnNwbGl0KCdcbicpOwogICAgICAgICAgfQogICAgICB9IGNhdGNoIHt9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogTWluaW1hbGx5IHN0cmluZ2lmeSB0aGlzIGxvZyBlbnRyeSBmb3IgcHJpbnRpbmcKICAgKiB0byB0aGUgY29uc29sZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCJbJXNdIFslc10gWyVzXTogJXMiLAogICAgICB0aGlzLmdldFRpbWUoKSAmJiB0aGlzLmdldFRpbWUoKS50b0lTT1N0cmluZyA/IHRoaXMuZ2V0VGltZSgpLnRvSVNPU3RyaW5nKCkgOiAiPz8/IiwKICAgICAgdGhpcy5nZXRMZXZlbCgpLAogICAgICB0aGlzLmdldEFnZW50UmVzb3VyY2VJZCgpLAogICAgICB0aGlzLmdldFRleHQoKSk7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsb2cgZW50cnkgdGltZXN0YW1wLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRUaW1lID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudGltZTsKICB9OwoKICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0QWdlbnRSZXNvdXJjZUlkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnRSZXNvdXJjZUlkOwogIH0KCiAgLyoqCiAgICogR2V0IHRoZSBsZXZlbCBvZiB0aGUgbG9nIGVudHJ5LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRMZXZlbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmxldmVsOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRleHQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldFRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy50ZXh0OwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IGNvbXBvbmVudC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0Q29tcG9uZW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29tcG9uZW50OwogIH07CgogIC8qKgogICAqIEFkZCBhbiBleGNlcHRpb24gc3RhY2sgdHJhY2UgdG8gdGhpcyBsb2cgZW50cnkuCiAgICogQSBsb2cgZW50cnkgbWF5IGNvbnRhaW4gb25seSBvbmUgZXhjZXB0aW9uIHN0YWNrIHRyYWNlLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMuZXhjZXB0aW9uID0gbmV3IExvZ2dlZEV4Y2VwdGlvbihlKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEFkZCBhbiBhcmJpdHJhcnkgb2JqZWN0IHRvIHRoZSBsb2cgZW50cnkuICBBIGxvZyBlbnRyeQogICAqIG1heSBjb250YWluIGFueSBudW1iZXIgb2Ygb2JqZWN0cy4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3BpZWRPYmogPSBjb25uZWN0LmRlZXBjb3B5KG9iaik7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGNvcGllZE9iaik7CiAgICB0aGlzLm9iamVjdHMucHVzaChjb3BpZWRPYmopOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogQWRkIGEgY3Jvc3Mgb3JpZ2luIGV2ZW50IG9iamVjdCB0byB0aGUgbG9nIGVudHJ5LiAgQSBsb2cgZW50cnkKICAgKiBtYXkgY29udGFpbiBhbnkgbnVtYmVyIG9mIG9iamVjdHMuCiAgICovCiAgIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoQ3Jvc3NPcmlnaW5FdmVudE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3BpZWRPYmogPSBjb25uZWN0LmRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudChvYmopOwogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhjb3BpZWRPYmopOwogICAgdGhpcy5vYmplY3RzLnB1c2goY29waWVkT2JqKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEluZGljYXRlIHRoYXQgdGhpcyBsb2cgZW50cnkgc2hvdWxkIGJlIHNlbnQgdG8gdGhlIHNlcnZlcgogICAqIE5PVEU6IFRoaXMgc2hvdWxkIGJlIHVzZWQgZm9yIGludGVybmFsIGxvZ3Mgb25seQogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlciA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnB1c2godGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBUaGUgbG9nZ2VyIGluc3RhbmNlLgogICAqLwogIHZhciBMb2dnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9sb2dzID0gW107CiAgICB0aGlzLl9yb2xsZWRMb2dzID0gW107CiAgICB0aGlzLl9sb2dzVG9QdXNoID0gW107CiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgdGhpcy5fZWNob0xldmVsID0gTG9nTGV2ZWxPcmRlci5JTkZPOwogICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9saW5lQ291bnQgPSAwOwogICAgdGhpcy5fbG9nUm9sbEludGVydmFsID0gMDsKICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IG51bGw7CiAgICB0aGlzLl9sb2dnZXJJZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIi0iICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICB0aGlzLnNldExvZ1JvbGxJbnRlcnZhbChERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMKTsKICAgIHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2ggPSAwOwogIH07CgogIC8qKgogICAqIFNldHMgdGhlIGludGVydmFsIGluIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBsb2dzIHdpbGwgYmUgcm90YXRlZC4KICAgKiBMb2dzIGFyZSByb3RhdGVkIG91dCBjb21wbGV0ZWx5IGF0IHRoZSBlbmQgb2YgdGhlIHNlY29uZCByb2xsCiAgICogYW5kIHdpbGwgZXZlbnR1YWxseSBiZSBnYXJiYWdlIGNvbGxlY3RlZC4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldExvZ1JvbGxJbnRlcnZhbCA9IGZ1bmN0aW9uIChpbnRlcnZhbCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmICghKHRoaXMuX2xvZ1JvbGxUaW1lcikgfHwgaW50ZXJ2YWwgIT09IHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCkgewogICAgICBpZiAodGhpcy5fbG9nUm9sbFRpbWVyKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwodGhpcy5fbG9nUm9sbFRpbWVyKTsKICAgICAgfQogICAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSBpbnRlcnZhbDsKICAgICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gZ2xvYmFsLnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLl9yb2xsZWRMb2dzID0gc2VsZi5fbG9nczsKICAgICAgICBzZWxmLl9sb2dzID0gW107CiAgICAgICAgc2VsZi5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IDA7CiAgICAgICAgc2VsZi5pbmZvKCJMb2cgcm9sbCBpbnRlcnZhbCBvY2N1cnJlZC4iKTsKICAgICAgfSwgdGhpcy5fbG9nUm9sbEludGVydmFsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMud2FybigiTG9nZ2VyIGlzIGFscmVhZHkgc2V0IHRvIHRoZSBnaXZlbiBpbnRlcnZhbDogJWQiLCB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgbG9nIGxldmVsLiAgVGhpcyBpcyB0aGUgbWluaW11bSBsZXZlbCBhdCB3aGljaCBsb2dzIHdpbGwKICAgKiBiZSBrZXB0IGZvciBsYXRlciBhcmNoaXZpbmcuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRMb2dMZXZlbCA9IGZ1bmN0aW9uIChsZXZlbCkgewogICAgaWYgKGxldmVsIGluIExvZ0xldmVsT3JkZXIpIHsKICAgICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgZWNobyBsZXZlbC4gIFRoaXMgaXMgdGhlIG1pbmltdW0gbGV2ZWwgYXQgd2hpY2ggbG9ncyB3aWxsCiAgICogYmUgcHJpbnRlZCB0byB0aGUgamF2YXNjcmlwdCBjb25zb2xlLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0RWNob0xldmVsID0gZnVuY3Rpb24gKGxldmVsKSB7CiAgICBpZiAobGV2ZWwgaW4gTG9nTGV2ZWxPcmRlcikgewogICAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFdyaXRlIGEgcGFydGljdWxhciBsb2cgZW50cnkuCiAgICoKICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxvZ2dpbmcgbGV2ZWwgb2YgdGhlIGVudHJ5LgogICAqIEBwYXJhbSB0ZXh0IFRoZSB0ZXh0IGNvbnRlbnRzIG9mIHRoZSBlbnRyeS4KICAgKgogICAqIEByZXR1cm5zIFRoZSBuZXcgbG9nIGVudHJ5LgogICAqLwogIExvZ2dlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBsZXZlbCwgdGV4dCkgewogICAgdmFyIGxvZ0VudHJ5ID0gbmV3IExvZ0VudHJ5KGNvbXBvbmVudCwgbGV2ZWwsIHRleHQsIHRoaXMuZ2V0TG9nZ2VySWQoKSk7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGxvZ0VudHJ5KTsKICAgIHRoaXMuYWRkTG9nRW50cnkobG9nRW50cnkpOwogICAgcmV0dXJuIGxvZ0VudHJ5OwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuYWRkTG9nRW50cnkgPSBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgIC8vIENhbGwgdGhpcyBzZWNvbmQgdGltZSBhcyBpbiBzb21lIHBsYWNlcyB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBkaXJlY3RseQogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhsb2dFbnRyeSk7CiAgICB0aGlzLl9sb2dzLnB1c2gobG9nRW50cnkpOwoKICAgIC8vRm9yIG5vdyBvbmx5IHNlbmQgc29mdHBob25lIGxvZ3Mgb25seS4KICAgIC8vVE9ETyBhZGQgQ0NQIGxvZ3Mgb25jZSB3ZSBhcmUgc3VyZSB0aGF0IG5vIHNlbnNpdGl2ZSBkYXRhIGlzIGJlaW5nIGxvZ2dlZC4KICAgIGlmIChMb2dDb21wb25lbnQuU09GVFBIT05FID09PSBsb2dFbnRyeS5jb21wb25lbnQpIHsKICAgICAgdGhpcy5fbG9nc1RvUHVzaC5wdXNoKGxvZ0VudHJ5KTsKICAgIH0KCiAgICBpZiAobG9nRW50cnkubGV2ZWwgaW4gTG9nTGV2ZWxPcmRlciAmJgogICAgICBMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9sb2dMZXZlbCkgewoKICAgICAgaWYgKExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2VjaG9MZXZlbCkgewogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUFtsb2dFbnRyeS5nZXRMZXZlbCgpXShsb2dFbnRyeS50b1N0cmluZygpKTsKICAgICAgfQoKICAgICAgbG9nRW50cnkubGluZSA9IHRoaXMuX2xpbmVDb3VudCsrOwogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlciA9IGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MucHVzaChsb2dFbnRyeSk7CgogICAgaWYgKGxvZ0VudHJ5LmxldmVsIGluIExvZ0xldmVsT3JkZXIgJiYKICAgICAgTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fbG9nTGV2ZWwpIHsKCiAgICAgIGlmIChMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9lY2hvTGV2ZWwpIHsKICAgICAgICBDT05TT0xFX0xPR0dFUl9NQVBbbG9nRW50cnkuZ2V0TGV2ZWwoKV0obG9nRW50cnkudG9TdHJpbmcoKSk7CiAgICAgIH0KCiAgICAgIGxvZ0VudHJ5LmxpbmUgPSB0aGlzLl9saW5lQ291bnQrKzsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZW1vdmUgYWxsIG9iamVjdHMgZnJvbSBhbGwgbG9nIGVudHJpZXMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5jbGVhck9iamVjdHMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbeF0ub2JqZWN0cykgewogICAgICAgIGRlbGV0ZSB0aGlzLl9sb2dzW3hdLm9iamVjdHM7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBSZW1vdmUgYWxsIGV4Y2VwdGlvbiBzdGFjayB0cmFjZXMgZnJvbSB0aGUgbG9nIGVudHJpZXMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5jbGVhckV4Y2VwdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbeF0uZXhjZXB0aW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ3NbeF0uZXhjZXB0aW9uOwogICAgICB9CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS50cmFjZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5UUkFDRSwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5ERUJVRywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLklORk8sIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkxPRywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS50ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLlRFU1QsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUud2FybiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5XQVJOLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkVSUk9SLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmNyaXRpY2FsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkVSUk9SLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICAvKioKICAgKiBDcmVhdGUgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGxvZ2dlciBjb250ZW50cy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxpbmVzID0gW107CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgbGluZXMucHVzaCh0aGlzLl9sb2dzW3hdLnRvU3RyaW5nKCkpOwogICAgfQoKICAgIHJldHVybiBsaW5lcy5qb2luKCJcbiIpOwogIH07CiAgCiAgLyoqCiAgICogRG93bmxvYWQvQXJjaGl2ZSBsb2dzIHRvIGEgZmlsZSwgCiAgICogQnkgZGVmYXVsdCwgaXQgcmV0dXJucyBhbGwgbG9ncy4KICAgKiBUbyBmaWx0ZXIgbG9ncyBieSB0aGUgbWluaW11bSBsb2cgbGV2ZWwgc2V0IGJ5IHNldExvZ0xldmVsIG9yIHRoZSBkZWZhdWx0IHNldCBpbiBfbG9nTGV2ZWwsIAogICAqIHBhc3MgaW4gZmlsdGVyQnlMb2dMZXZlbCB0byB0cnVlIGluIG9wdGlvbnMKICAgKiAKICAgKiBAcGFyYW0gb3B0aW9ucyBkb3dubG9hZCBvcHRpb25zIFtPYmplY3R8U3RyaW5nXS4gCiAgICogLSBvZiB0eXBlIE9iamVjdDogCiAgICogICB7IGxvZ05hbWU6ICdteS1sb2ctbmFtZScsCiAgICogICAgIGZpbHRlckJ5TG9nTGV2ZWw6IGZhbHNlLCAvL2Rvd25sb2FkIGFsbCBsb2dzCiAgICogICB9CiAgICogLSBvZiB0eXBlIFN0cmluZyAoZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpLCB0aGUgZmlsZSdzIG5hbWUKICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmRvd25sb2FkID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIGxvZ05hbWUgPSAnYWdlbnQtbG9nJzsKICAgIHZhciBmaWx0ZXJCeUxvZ0xldmVsID0gZmFsc2U7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JykgewogICAgICBsb2dOYW1lID0gb3B0aW9ucy5sb2dOYW1lIHx8IGxvZ05hbWU7CiAgICAgIGZpbHRlckJ5TG9nTGV2ZWwgPSBvcHRpb25zLmZpbHRlckJ5TG9nTGV2ZWwgfHwgZmlsdGVyQnlMb2dMZXZlbDsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICBsb2dOYW1lID0gb3B0aW9ucyB8fCBsb2dOYW1lOwogICAgfQoKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dzID0gdGhpcy5fcm9sbGVkTG9ncy5jb25jYXQodGhpcy5fbG9ncyk7CiAgICBpZiAoZmlsdGVyQnlMb2dMZXZlbCkgewogICAgICBsb2dzID0gbG9ncy5maWx0ZXIoZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICByZXR1cm4gTG9nTGV2ZWxPcmRlcltlbnRyeS5sZXZlbF0gPj0gc2VsZi5fbG9nTGV2ZWw7CiAgICAgIH0pOwogICAgfQoKICAgIHZhciBsb2dCbG9iID0gbmV3IGdsb2JhbC5CbG9iKFtKU09OLnN0cmluZ2lmeShsb2dzLCB1bmRlZmluZWQsIDQpXSwgWyd0ZXh0L3BsYWluJ10pOwogICAgdmFyIGRvd25sb2FkTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIHZhciBsb2dOYW1lID0gbG9nTmFtZSB8fCAnYWdlbnQtbG9nJzsKICAgIGRvd25sb2FkTGluay5ocmVmID0gZ2xvYmFsLlVSTC5jcmVhdGVPYmplY3RVUkwobG9nQmxvYik7CiAgICBkb3dubG9hZExpbmsuZG93bmxvYWQgPSBsb2dOYW1lICsgJy50eHQnOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb3dubG9hZExpbmspOwogICAgZG93bmxvYWRMaW5rLmNsaWNrKCk7CiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRvd25sb2FkTGluayk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtTG9nUHVzaCA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBpZiAoIWNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkKSB7CiAgICAgIGNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgLyoqIFNjaGVkdWxlIHB1c2hpbmcgbG9ncyBmcmVxdWVudGx5IHRvIHNoYXJlZHdvcmtlciB1cHN0cmVhbSwgc2hhcmVkd29ya2VyIHdpbGwgcmVwb3J0IHRvIHRoZSBDVEkgYmFja2VuZCovCiAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucmVwb3J0TWFzdGVyTG9nc1VwU3RyZWFtLCBjb25kdWl0KSwgU09GVFBIT05FX0xPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTKTsKICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICB2YXIgbG9nc1RvUHVzaCA9IHRoaXMuX2xvZ3NUb1B1c2guc2xpY2UoKTsKICAgIHRoaXMuX2xvZ3NUb1B1c2ggPSBbXTsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChsb2dzVG9QdXNoLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGxvZ3NUb1B1c2gpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NQdXNoID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzVXBzdHJlYW0sIGNvbmR1aXQpLCAxMDAwKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUExvZ3NQdXNoID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoT3V0ZXJDb250ZXh0Q0NQTG9nc1Vwc3RyZWFtLCBjb25kdWl0KSwgMTAwMCk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hPdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NVcHN0cmVhbSA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPiAwKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nc1tpXS50ZXh0ID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0udGV4dDsKICAgICAgfQoKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MpOwogICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgfQogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoT3V0ZXJDb250ZXh0Q0NQTG9nc1Vwc3RyZWFtID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZm9yICh2YXIgaSA9IHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2g7IGkgPCB0aGlzLl9sb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW2ldLmxvZ2dlcklkICE9PSB0aGlzLl9sb2dnZXJJZCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgdGhpcy5fbG9nc1tpXSk7CiAgICB9CiAgICB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoID0gdGhpcy5fbG9ncy5sZW5ndGg7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLmdldExvZ2dlcklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2xvZ2dlcklkOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVEb3duc3RyZWFtQ2xpZW50U2lkZUxvZ3NQdXNoID0gZnVuY3Rpb24gKCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoQ2xpZW50U2lkZUxvZ3NEb3duc3RyZWFtKSwgTE9HU19SRVBPUlRfSU5URVJWQUxfTUlMTElTKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaENsaWVudFNpZGVMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dzID0gW107CgogICAgLy8gV2UgZG8gbm90IHNlbmQgYSByZXF1ZXN0IGlmIHdlIGhhdmUgbGVzcyB0aGFuIDUwIHJlY29yZHMgc28gdGhhdCB3ZSBtaW5pbWl6ZSB0aGUgbnVtYmVyIG9mCiAgICAvLyByZXF1ZXN0cyBwZXIgc2Vjb25kLiAKICAgIC8vIDUwMCBpcyB0aGUgbWF4IHdlIGFjY2VwdCBvbiB0aGUgc2VydmVyLiAKICAgIC8vIFdlIGNob3NlIDUwMCBiZWNhdXNlIHRoaXMgaXMgdGhlIGxpbWl0IGltcG9zZWQgYnkgRmlyZWhvc2UgZm9yIGEgcHV0IGJhdGNoIHJlcXVlc3QKICAgIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPCA1MCkgewogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aCA+IDUwMCkgewogICAgICBsb2dzID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3Muc3BsaWNlKDAsIDUwMCk7CiAgICB9IGVsc2UgewogICAgICBsb2dzID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3M7CiAgICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB9CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpZW50U2lkZUxvZ3MobG9ncyk7CiAgfQoKICB2YXIgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIgPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgTG9nZ2VyLmNhbGwodGhpcyk7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgCiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9wdXNoTG9nc0Rvd25zdHJlYW0pLAogICAgICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5MT0dfUFVTSF9JTlRFUlZBTCk7CgogICAgLy8gRGlzYWJsZSBsb2cgcm9sbGluZywgd2Ugd2lsbCBwdXJnZSBvdXIgb3duIGxvZ3Mgb25jZSB0aGV5IGhhdmUKICAgIC8vIGJlZW4gcHVzaGVkIGRvd25zdHJlYW0uCiAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbCh0aGlzLl9sb2dSb2xsVGltZXIpOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICB9OwogIC8vIEhvdyBmcmVxdWVudGx5IGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgZGVsaXZlcmVkIGRvd25zdHJlYW0uCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIuTE9HX1BVU0hfSU5URVJWQUwgPSAxMDAwOwogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoTG9nZ2VyLnByb3RvdHlwZSk7CiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5wdXNoTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAobG9ncykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogIH07CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5fcHVzaExvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgCiAgICB0aGlzLl9sb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBsb2cpOwogICAgfSk7CiAgICB0aGlzLl9sb2dzID0gW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0pOwogICAgfQoKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgfTsKCiAgLyoqCiAgICogV3JhcCBhIGZ1bmN0aW9uIHdpdGggdHJ5IGNhdGNoIGJsb2NrCiAgICovCiAgdmFyIHRyeUNhdGNoV3JhcHBlck1ldGhvZCA9IGZ1bmN0aW9uIChmbikgewogICAgdmFyIHdyYXBwZWRmdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy8gU2luY2UgdGhpcyB3cmFwcyBMb2dnZXIgY2xhc3MsIHdlIGNhbiBvbmx5IHByaW50IGl0IGluIHRoZSBjb25zb2xlIGFuZCBlYXQgaXQuCiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQLkVSUk9SKGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gd3JhcHBlZGZ1bmN0aW9uOwogIH0KICAvKioKICAgKiBUaGlzIGlzIGEgd3JhcHBlciBtZXRob2QgdG8gd3JhcCBlYWNoIGZ1bmN0aW9uCiAgICogaW4gYW4gb2JqZWN0IHdpdGggdHJ5IGNhdGNoIGJsb2NrLgogICAqLwogIHZhciB0cnlDYXRjaFdyYXBwZXJPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBmb3IgKHZhciBtZXRob2QgaW4gb2JqKSB7CiAgICAgIGlmICh0eXBlb2Yob2JqW21ldGhvZF0pID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgb2JqW21ldGhvZF0gPSB0cnlDYXRjaFdyYXBwZXJNZXRob2Qob2JqW21ldGhvZF0pOwogICAgICB9CiAgICB9CiAgfQoKICAvKiogQ3JlYXRlIHRoZSBzaW5nbGV0b24gbG9nZ2VyIGluc3RhbmNlLiAqLwogIGNvbm5lY3Qucm9vdExvZ2dlciA9IG5ldyBMb2dnZXIoKTsKICB0cnlDYXRjaFdyYXBwZXJPYmplY3QoY29ubmVjdC5yb290TG9nZ2VyKTsKCgogIC8qKiBGZXRjaCB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICB2YXIgZ2V0TG9nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qucm9vdExvZ2dlcjsKICB9OwoKICBjb25uZWN0ID0gY29ubmVjdCB8fCB7fTsKICBjb25uZWN0LmdldExvZyA9IGdldExvZzsKICBjb25uZWN0LkxvZ0VudHJ5ID0gTG9nRW50cnk7CiAgY29ubmVjdC5Mb2dnZXIgPSBMb2dnZXI7CiAgY29ubmVjdC5Mb2dMZXZlbCA9IExvZ0xldmVsOwogIGNvbm5lY3QuTG9nQ29tcG9uZW50ID0gTG9nQ29tcG9uZW50OwogIGNvbm5lY3QuRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIgPSBEb3duc3RyZWFtQ29uZHVpdExvZ2dlcjsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDE2MzoKLyoqKi8gKGZ1bmN0aW9uKCkgewoKLyoKICogSmF2YVNjcmlwdCBNRDUKICogaHR0cHM6Ly9naXRodWIuY29tL2JsdWVpbXAvSmF2YVNjcmlwdC1NRDUKICoKICogQ29weXJpZ2h0IDIwMTEsIFNlYmFzdGlhbiBUc2NoYW4KICogaHR0cHM6Ly9ibHVlaW1wLm5ldAogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2U6CiAqIGh0dHBzOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUCiAqCiAqIEJhc2VkIG9uCiAqIEEgSmF2YVNjcmlwdCBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgUlNBIERhdGEgU2VjdXJpdHksIEluYy4gTUQ1IE1lc3NhZ2UKICogRGlnZXN0IEFsZ29yaXRobSwgYXMgZGVmaW5lZCBpbiBSRkMgMTMyMS4KICogVmVyc2lvbiAyLjIgQ29weXJpZ2h0IChDKSBQYXVsIEpvaG5zdG9uIDE5OTkgLSAyMDA5CiAqIE90aGVyIGNvbnRyaWJ1dG9yczogR3JlZyBIb2x0LCBBbmRyZXcgS2VwZXJ0LCBZZG5hciwgTG9zdGluZXQKICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBMaWNlbnNlCiAqIFNlZSBodHRwOi8vcGFqaG9tZS5vcmcudWsvY3J5cHQvbWQ1IGZvciBtb3JlIGluZm8uCiAqLwoKLyogZ2xvYmFsIGRlZmluZSAqLwoKLyogZXNsaW50LWRpc2FibGUgc3RyaWN0ICovCgo7KGZ1bmN0aW9uICgkKSB7CiAgJ3VzZSBzdHJpY3QnCgl2YXIgY3R4ID0gdGhpcyB8fCBnbG9iYWxUaGlzOwoKICAvKioKICAgKiBBZGQgaW50ZWdlcnMsIHdyYXBwaW5nIGF0IDJeMzIuCiAgICogVGhpcyB1c2VzIDE2LWJpdCBvcGVyYXRpb25zIGludGVybmFsbHkgdG8gd29yayBhcm91bmQgYnVncyBpbiBpbnRlcnByZXRlcnMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0geCBGaXJzdCBpbnRlZ2VyCiAgICogQHBhcmFtIHtudW1iZXJ9IHkgU2Vjb25kIGludGVnZXIKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBTdW0KICAgKi8KICBmdW5jdGlvbiBzYWZlQWRkKHgsIHkpIHsKICAgIHZhciBsc3cgPSAoeCAmIDB4ZmZmZikgKyAoeSAmIDB4ZmZmZikKICAgIHZhciBtc3cgPSAoeCA+PiAxNikgKyAoeSA+PiAxNikgKyAobHN3ID4+IDE2KQogICAgcmV0dXJuIChtc3cgPDwgMTYpIHwgKGxzdyAmIDB4ZmZmZikKICB9CgogIC8qKgogICAqIEJpdHdpc2Ugcm90YXRlIGEgMzItYml0IG51bWJlciB0byB0aGUgbGVmdC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBudW0gMzItYml0IG51bWJlcgogICAqIEBwYXJhbSB7bnVtYmVyfSBjbnQgUm90YXRpb24gY291bnQKICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSb3RhdGVkIG51bWJlcgogICAqLwogIGZ1bmN0aW9uIGJpdFJvdGF0ZUxlZnQobnVtLCBjbnQpIHsKICAgIHJldHVybiAobnVtIDw8IGNudCkgfCAobnVtID4+PiAoMzIgLSBjbnQpKQogIH0KCiAgLyoqCiAgICogQmFzaWMgb3BlcmF0aW9uIHRoZSBhbGdvcml0aG0gdXNlcy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBxIHEKICAgKiBAcGFyYW0ge251bWJlcn0gYSBhCiAgICogQHBhcmFtIHtudW1iZXJ9IGIgYgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IHgKICAgKiBAcGFyYW0ge251bWJlcn0gcyBzCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgdAogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJlc3VsdAogICAqLwogIGZ1bmN0aW9uIG1kNWNtbihxLCBhLCBiLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gc2FmZUFkZChiaXRSb3RhdGVMZWZ0KHNhZmVBZGQoc2FmZUFkZChhLCBxKSwgc2FmZUFkZCh4LCB0KSksIHMpLCBiKQogIH0KICAvKioKICAgKiBCYXNpYyBvcGVyYXRpb24gdGhlIGFsZ29yaXRobSB1c2VzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGEgYQogICAqIEBwYXJhbSB7bnVtYmVyfSBiIGIKICAgKiBAcGFyYW0ge251bWJlcn0gYyBjCiAgICogQHBhcmFtIHtudW1iZXJ9IGQgZAogICAqIEBwYXJhbSB7bnVtYmVyfSB4IHgKICAgKiBAcGFyYW0ge251bWJlcn0gcyBzCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgdAogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJlc3VsdAogICAqLwogIGZ1bmN0aW9uIG1kNWZmKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBtZDVjbW4oKGIgJiBjKSB8ICh+YiAmIGQpLCBhLCBiLCB4LCBzLCB0KQogIH0KICAvKioKICAgKiBCYXNpYyBvcGVyYXRpb24gdGhlIGFsZ29yaXRobSB1c2VzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGEgYQogICAqIEBwYXJhbSB7bnVtYmVyfSBiIGIKICAgKiBAcGFyYW0ge251bWJlcn0gYyBjCiAgICogQHBhcmFtIHtudW1iZXJ9IGQgZAogICAqIEBwYXJhbSB7bnVtYmVyfSB4IHgKICAgKiBAcGFyYW0ge251bWJlcn0gcyBzCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgdAogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJlc3VsdAogICAqLwogIGZ1bmN0aW9uIG1kNWdnKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBtZDVjbW4oKGIgJiBkKSB8IChjICYgfmQpLCBhLCBiLCB4LCBzLCB0KQogIH0KICAvKioKICAgKiBCYXNpYyBvcGVyYXRpb24gdGhlIGFsZ29yaXRobSB1c2VzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGEgYQogICAqIEBwYXJhbSB7bnVtYmVyfSBiIGIKICAgKiBAcGFyYW0ge251bWJlcn0gYyBjCiAgICogQHBhcmFtIHtudW1iZXJ9IGQgZAogICAqIEBwYXJhbSB7bnVtYmVyfSB4IHgKICAgKiBAcGFyYW0ge251bWJlcn0gcyBzCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgdAogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJlc3VsdAogICAqLwogIGZ1bmN0aW9uIG1kNWhoKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBtZDVjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KQogIH0KICAvKioKICAgKiBCYXNpYyBvcGVyYXRpb24gdGhlIGFsZ29yaXRobSB1c2VzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGEgYQogICAqIEBwYXJhbSB7bnVtYmVyfSBiIGIKICAgKiBAcGFyYW0ge251bWJlcn0gYyBjCiAgICogQHBhcmFtIHtudW1iZXJ9IGQgZAogICAqIEBwYXJhbSB7bnVtYmVyfSB4IHgKICAgKiBAcGFyYW0ge251bWJlcn0gcyBzCiAgICogQHBhcmFtIHtudW1iZXJ9IHQgdAogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJlc3VsdAogICAqLwogIGZ1bmN0aW9uIG1kNWlpKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBtZDVjbW4oYyBeIChiIHwgfmQpLCBhLCBiLCB4LCBzLCB0KQogIH0KCiAgLyoqCiAgICogQ2FsY3VsYXRlIHRoZSBNRDUgb2YgYW4gYXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcywgYW5kIGEgYml0IGxlbmd0aC4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IHggQXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcwogICAqIEBwYXJhbSB7bnVtYmVyfSBsZW4gQml0IGxlbmd0aAogICAqIEByZXR1cm5zIHtBcnJheTxudW1iZXI+fSBNRDUgQXJyYXkKICAgKi8KICBmdW5jdGlvbiBiaW5sTUQ1KHgsIGxlbikgewogICAgLyogYXBwZW5kIHBhZGRpbmcgKi8KICAgIHhbbGVuID4+IDVdIHw9IDB4ODAgPDwgbGVuICUgMzIKICAgIHhbKCgobGVuICsgNjQpID4+PiA5KSA8PCA0KSArIDE0XSA9IGxlbgoKICAgIHZhciBpCiAgICB2YXIgb2xkYQogICAgdmFyIG9sZGIKICAgIHZhciBvbGRjCiAgICB2YXIgb2xkZAogICAgdmFyIGEgPSAxNzMyNTg0MTkzCiAgICB2YXIgYiA9IC0yNzE3MzM4NzkKICAgIHZhciBjID0gLTE3MzI1ODQxOTQKICAgIHZhciBkID0gMjcxNzMzODc4CgogICAgZm9yIChpID0gMDsgaSA8IHgubGVuZ3RoOyBpICs9IDE2KSB7CiAgICAgIG9sZGEgPSBhCiAgICAgIG9sZGIgPSBiCiAgICAgIG9sZGMgPSBjCiAgICAgIG9sZGQgPSBkCgogICAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpXSwgNywgLTY4MDg3NjkzNikKICAgICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDFdLCAxMiwgLTM4OTU2NDU4NikKICAgICAgYyA9IG1kNWZmKGMsIGQsIGEsIGIsIHhbaSArIDJdLCAxNywgNjA2MTA1ODE5KQogICAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgM10sIDIyLCAtMTA0NDUyNTMzMCkKICAgICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaSArIDRdLCA3LCAtMTc2NDE4ODk3KQogICAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgNV0sIDEyLCAxMjAwMDgwNDI2KQogICAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgNl0sIDE3LCAtMTQ3MzIzMTM0MSkKICAgICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDddLCAyMiwgLTQ1NzA1OTgzKQogICAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpICsgOF0sIDcsIDE3NzAwMzU0MTYpCiAgICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyA5XSwgMTIsIC0xOTU4NDE0NDE3KQogICAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMTBdLCAxNywgLTQyMDYzKQogICAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgMTFdLCAyMiwgLTE5OTA0MDQxNjIpCiAgICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2kgKyAxMl0sIDcsIDE4MDQ2MDM2ODIpCiAgICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyAxM10sIDEyLCAtNDAzNDExMDEpCiAgICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAxNF0sIDE3LCAtMTUwMjAwMjI5MCkKICAgICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDE1XSwgMjIsIDEyMzY1MzUzMjkpCgogICAgICBhID0gbWQ1Z2coYSwgYiwgYywgZCwgeFtpICsgMV0sIDUsIC0xNjU3OTY1MTApCiAgICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyA2XSwgOSwgLTEwNjk1MDE2MzIpCiAgICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAxMV0sIDE0LCA2NDM3MTc3MTMpCiAgICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2ldLCAyMCwgLTM3Mzg5NzMwMikKICAgICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDVdLCA1LCAtNzAxNTU4NjkxKQogICAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgMTBdLCA5LCAzODAxNjA4MykKICAgICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDE1XSwgMTQsIC02NjA0NzgzMzUpCiAgICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2kgKyA0XSwgMjAsIC00MDU1Mzc4NDgpCiAgICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyA5XSwgNSwgNTY4NDQ2NDM4KQogICAgICBkID0gbWQ1Z2coZCwgYSwgYiwgYywgeFtpICsgMTRdLCA5LCAtMTAxOTgwMzY5MCkKICAgICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDNdLCAxNCwgLTE4NzM2Mzk2MSkKICAgICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaSArIDhdLCAyMCwgMTE2MzUzMTUwMSkKICAgICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDEzXSwgNSwgLTE0NDQ2ODE0NjcpCiAgICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAyXSwgOSwgLTUxNDAzNzg0KQogICAgICBjID0gbWQ1Z2coYywgZCwgYSwgYiwgeFtpICsgN10sIDE0LCAxNzM1MzI4NDczKQogICAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpICsgMTJdLCAyMCwgLTE5MjY2MDc3MzQpCgogICAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgNV0sIDQsIC0zNzg1NTgpCiAgICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2kgKyA4XSwgMTEsIC0yMDIyNTc0NDYzKQogICAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgMTFdLCAxNiwgMTgzOTAzMDU2MikKICAgICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDE0XSwgMjMsIC0zNTMwOTU1NikKICAgICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDFdLCA0LCAtMTUzMDk5MjA2MCkKICAgICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDRdLCAxMSwgMTI3Mjg5MzM1MykKICAgICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDddLCAxNiwgLTE1NTQ5NzYzMikKICAgICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDEwXSwgMjMsIC0xMDk0NzMwNjQwKQogICAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgMTNdLCA0LCA2ODEyNzkxNzQpCiAgICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2ldLCAxMSwgLTM1ODUzNzIyMikKICAgICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDNdLCAxNiwgLTcyMjUyMTk3OSkKICAgICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDZdLCAyMywgNzYwMjkxODkpCiAgICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyA5XSwgNCwgLTY0MDM2NDQ4NykKICAgICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDEyXSwgMTEsIC00MjE4MTU4MzUpCiAgICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE2LCA1MzA3NDI1MjApCiAgICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyAyXSwgMjMsIC05OTUzMzg2NTEpCgogICAgICBhID0gbWQ1aWkoYSwgYiwgYywgZCwgeFtpXSwgNiwgLTE5ODYzMDg0NCkKICAgICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDddLCAxMCwgMTEyNjg5MTQxNSkKICAgICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDE0XSwgMTUsIC0xNDE2MzU0OTA1KQogICAgICBiID0gbWQ1aWkoYiwgYywgZCwgYSwgeFtpICsgNV0sIDIxLCAtNTc0MzQwNTUpCiAgICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2kgKyAxMl0sIDYsIDE3MDA0ODU1NzEpCiAgICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAzXSwgMTAsIC0xODk0OTg2NjA2KQogICAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMTBdLCAxNSwgLTEwNTE1MjMpCiAgICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyAxXSwgMjEsIC0yMDU0OTIyNzk5KQogICAgICBhID0gbWQ1aWkoYSwgYiwgYywgZCwgeFtpICsgOF0sIDYsIDE4NzMzMTMzNTkpCiAgICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAxNV0sIDEwLCAtMzA2MTE3NDQpCiAgICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyA2XSwgMTUsIC0xNTYwMTk4MzgwKQogICAgICBiID0gbWQ1aWkoYiwgYywgZCwgYSwgeFtpICsgMTNdLCAyMSwgMTMwOTE1MTY0OSkKICAgICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDRdLCA2LCAtMTQ1NTIzMDcwKQogICAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgMTFdLCAxMCwgLTExMjAyMTAzNzkpCiAgICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyAyXSwgMTUsIDcxODc4NzI1OSkKICAgICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDldLCAyMSwgLTM0MzQ4NTU1MSkKCiAgICAgIGEgPSBzYWZlQWRkKGEsIG9sZGEpCiAgICAgIGIgPSBzYWZlQWRkKGIsIG9sZGIpCiAgICAgIGMgPSBzYWZlQWRkKGMsIG9sZGMpCiAgICAgIGQgPSBzYWZlQWRkKGQsIG9sZGQpCiAgICB9CiAgICByZXR1cm4gW2EsIGIsIGMsIGRdCiAgfQoKICAvKioKICAgKiBDb252ZXJ0IGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMgdG8gYSBzdHJpbmcKICAgKgogICAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gaW5wdXQgTUQ1IEFycmF5CiAgICogQHJldHVybnMge3N0cmluZ30gTUQ1IHN0cmluZwogICAqLwogIGZ1bmN0aW9uIGJpbmwycnN0cihpbnB1dCkgewogICAgdmFyIGkKICAgIHZhciBvdXRwdXQgPSAnJwogICAgdmFyIGxlbmd0aDMyID0gaW5wdXQubGVuZ3RoICogMzIKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGgzMjsgaSArPSA4KSB7CiAgICAgIG91dHB1dCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKChpbnB1dFtpID4+IDVdID4+PiBpICUgMzIpICYgMHhmZikKICAgIH0KICAgIHJldHVybiBvdXRwdXQKICB9CgogIC8qKgogICAqIENvbnZlcnQgYSByYXcgc3RyaW5nIHRvIGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMKICAgKiBDaGFyYWN0ZXJzID4yNTUgaGF2ZSB0aGVpciBoaWdoLWJ5dGUgc2lsZW50bHkgaWdub3JlZC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBpbnB1dCBSYXcgaW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge0FycmF5PG51bWJlcj59IEFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMKICAgKi8KICBmdW5jdGlvbiByc3RyMmJpbmwoaW5wdXQpIHsKICAgIHZhciBpCiAgICB2YXIgb3V0cHV0ID0gW10KICAgIG91dHB1dFsoaW5wdXQubGVuZ3RoID4+IDIpIC0gMV0gPSB1bmRlZmluZWQKICAgIGZvciAoaSA9IDA7IGkgPCBvdXRwdXQubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgb3V0cHV0W2ldID0gMAogICAgfQogICAgdmFyIGxlbmd0aDggPSBpbnB1dC5sZW5ndGggKiA4CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoODsgaSArPSA4KSB7CiAgICAgIG91dHB1dFtpID4+IDVdIHw9IChpbnB1dC5jaGFyQ29kZUF0KGkgLyA4KSAmIDB4ZmYpIDw8IGkgJSAzMgogICAgfQogICAgcmV0dXJuIG91dHB1dAogIH0KCiAgLyoqCiAgICogQ2FsY3VsYXRlIHRoZSBNRDUgb2YgYSByYXcgc3RyaW5nCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcyBJbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSYXcgTUQ1IHN0cmluZwogICAqLwogIGZ1bmN0aW9uIHJzdHJNRDUocykgewogICAgcmV0dXJuIGJpbmwycnN0cihiaW5sTUQ1KHJzdHIyYmlubChzKSwgcy5sZW5ndGggKiA4KSkKICB9CgogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIEhNQUMtTUQ1IG9mIGEga2V5IGFuZCBzb21lIGRhdGEgKHJhdyBzdHJpbmdzKQogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBITUFDIGtleQogICAqIEBwYXJhbSB7c3RyaW5nfSBkYXRhIFJhdyBpbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSYXcgTUQ1IHN0cmluZwogICAqLwogIGZ1bmN0aW9uIHJzdHJITUFDTUQ1KGtleSwgZGF0YSkgewogICAgdmFyIGkKICAgIHZhciBia2V5ID0gcnN0cjJiaW5sKGtleSkKICAgIHZhciBpcGFkID0gW10KICAgIHZhciBvcGFkID0gW10KICAgIHZhciBoYXNoCiAgICBpcGFkWzE1XSA9IG9wYWRbMTVdID0gdW5kZWZpbmVkCiAgICBpZiAoYmtleS5sZW5ndGggPiAxNikgewogICAgICBia2V5ID0gYmlubE1ENShia2V5LCBrZXkubGVuZ3RoICogOCkKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSArPSAxKSB7CiAgICAgIGlwYWRbaV0gPSBia2V5W2ldIF4gMHgzNjM2MzYzNgogICAgICBvcGFkW2ldID0gYmtleVtpXSBeIDB4NWM1YzVjNWMKICAgIH0KICAgIGhhc2ggPSBiaW5sTUQ1KGlwYWQuY29uY2F0KHJzdHIyYmlubChkYXRhKSksIDUxMiArIGRhdGEubGVuZ3RoICogOCkKICAgIHJldHVybiBiaW5sMnJzdHIoYmlubE1ENShvcGFkLmNvbmNhdChoYXNoKSwgNTEyICsgMTI4KSkKICB9CgogIC8qKgogICAqIENvbnZlcnQgYSByYXcgc3RyaW5nIHRvIGEgaGV4IHN0cmluZwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlucHV0IFJhdyBpbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBIZXggZW5jb2RlZCBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiByc3RyMmhleChpbnB1dCkgewogICAgdmFyIGhleFRhYiA9ICcwMTIzNDU2Nzg5YWJjZGVmJwogICAgdmFyIG91dHB1dCA9ICcnCiAgICB2YXIgeAogICAgdmFyIGkKICAgIGZvciAoaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkgKz0gMSkgewogICAgICB4ID0gaW5wdXQuY2hhckNvZGVBdChpKQogICAgICBvdXRwdXQgKz0gaGV4VGFiLmNoYXJBdCgoeCA+Pj4gNCkgJiAweDBmKSArIGhleFRhYi5jaGFyQXQoeCAmIDB4MGYpCiAgICB9CiAgICByZXR1cm4gb3V0cHV0CiAgfQoKICAvKioKICAgKiBFbmNvZGUgYSBzdHJpbmcgYXMgVVRGLTgKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBpbnB1dCBJbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBVVEY4IHN0cmluZwogICAqLwogIGZ1bmN0aW9uIHN0cjJyc3RyVVRGOChpbnB1dCkgewogICAgcmV0dXJuIHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChpbnB1dCkpCiAgfQoKICAvKioKICAgKiBFbmNvZGVzIGlucHV0IHN0cmluZyBhcyByYXcgTUQ1IHN0cmluZwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHMgSW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gUmF3IE1ENSBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiByYXdNRDUocykgewogICAgcmV0dXJuIHJzdHJNRDUoc3RyMnJzdHJVVEY4KHMpKQogIH0KICAvKioKICAgKiBFbmNvZGVzIGlucHV0IHN0cmluZyBhcyBIZXggZW5jb2RlZCBzdHJpbmcKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBzIElucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IEhleCBlbmNvZGVkIHN0cmluZwogICAqLwogIGZ1bmN0aW9uIGhleE1ENShzKSB7CiAgICByZXR1cm4gcnN0cjJoZXgocmF3TUQ1KHMpKQogIH0KICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSByYXcgSE1BQy1NRDUgZm9yIHRoZSBnaXZlbiBrZXkgYW5kIGRhdGEKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBrIEhNQUMga2V5CiAgICogQHBhcmFtIHtzdHJpbmd9IGQgSW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gUmF3IE1ENSBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiByYXdITUFDTUQ1KGssIGQpIHsKICAgIHJldHVybiByc3RySE1BQ01ENShzdHIycnN0clVURjgoayksIHN0cjJyc3RyVVRGOChkKSkKICB9CiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgSGV4IGVuY29kZWQgSE1BQy1NRDUgZm9yIHRoZSBnaXZlbiBrZXkgYW5kIGRhdGEKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBrIEhNQUMga2V5CiAgICogQHBhcmFtIHtzdHJpbmd9IGQgSW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gUmF3IE1ENSBzdHJpbmcKICAgKi8KICBmdW5jdGlvbiBoZXhITUFDTUQ1KGssIGQpIHsKICAgIHJldHVybiByc3RyMmhleChyYXdITUFDTUQ1KGssIGQpKQogIH0KCiAgLyoqCiAgICogQ2FsY3VsYXRlcyBNRDUgdmFsdWUgZm9yIGEgZ2l2ZW4gc3RyaW5nLgogICAqIElmIGEga2V5IGlzIHByb3ZpZGVkLCBjYWxjdWxhdGVzIHRoZSBITUFDLU1ENSB2YWx1ZS4KICAgKiBSZXR1cm5zIGEgSGV4IGVuY29kZWQgc3RyaW5nIHVubGVzcyB0aGUgcmF3IGFyZ3VtZW50IGlzIGdpdmVuLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBJbnB1dCBzdHJpbmcKICAgKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gSE1BQyBrZXkKICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyYXddIFJhdyBvdXRwdXQgc3dpdGNoCiAgICogQHJldHVybnMge3N0cmluZ30gTUQ1IG91dHB1dAogICAqLwogIGZ1bmN0aW9uIG1kNShzdHJpbmcsIGtleSwgcmF3KSB7CiAgICBpZiAoIWtleSkgewogICAgICBpZiAoIXJhdykgewogICAgICAgIHJldHVybiBoZXhNRDUoc3RyaW5nKQogICAgICB9CiAgICAgIHJldHVybiByYXdNRDUoc3RyaW5nKQogICAgfQogICAgaWYgKCFyYXcpIHsKICAgICAgcmV0dXJuIGhleEhNQUNNRDUoa2V5LCBzdHJpbmcpCiAgICB9CiAgICByZXR1cm4gcmF3SE1BQ01ENShrZXksIHN0cmluZykKICB9CgoJY3R4Lm1kNSA9IG1kNQp9KSh0aGlzKQoKLyoqKi8gfSksCgovKioqLyA0Mzk6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5DaGF0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbywgbWV0YWRhdGEpIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQ7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIGNvbm5lY3QuQ2hhdFNlc3Npb24uc2V0R2xvYmFsQ29uZmlnKHsKICAgICAgICBsb2dnZXJDb25maWc6IHsKICAgICAgICAgIGxvZ2dlcjogbG9nZ2VyCiAgICAgICAgfSwKICAgICAgICByZWdpb246IG1ldGFkYXRhLnJlZ2lvbgogICAgICB9KTsKCiAgICAgIC8qKiBDb3VsZCBiZSBhbHNvIENVU1RPTUVSIC0gIEZvciBub3cgd2UgYXJlIGNyZWF0aW5nIG9ubHkgQWdlbnQgY29ubmVjdGlvbiBtZWRpYSBvYmplY3QgKi8KICAgICAgdmFyIGNvbnRyb2xsZXIgPSBjb25uZWN0LkNoYXRTZXNzaW9uLmNyZWF0ZSh7CiAgICAgICAgY2hhdERldGFpbHM6IG1lZGlhSW5mbywKICAgICAgICB0eXBlOiAiQUdFTlQiLAogICAgICAgIHdlYnNvY2tldE1hbmFnZXI6IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCkKICAgICAgfSk7CiAgICAgIAogICAgICB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwogICAgICByZXR1cm4gY29udHJvbGxlcgogICAgICAgIC5jb25uZWN0KCkKICAgICAgICAudGhlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCBmb3IgY29udGFjdElkICVzIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLCBtZWRpYUluZm8uY29udGFjdElkKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCIsIG1lZGlhSW5mby5jb250YWN0SWQsIGVycm9yKTsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgZGF0YTogZGF0YSB8fCBtZWRpYUluZm8KICAgICAgfSk7CiAgICB9OwoKICAgIHZhciB0cmFja0NoYXRDb25uZWN0aW9uU3RhdHVzID0gZnVuY3Rpb24gKGNvbnRyb2xsZXIpIHsKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Ccm9rZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIikKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iLCBkYXRhKTsKICAgICAgfSk7CgogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkVzdGFibGlzaGVkKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIiwgZGF0YSk7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0KICAgIH0KICB9Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAyNzk6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5NZWRpYUZhY3RvcnkgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAvKiogY29udHJvbGxlciBob2xkZXIgKi8KICAgIHZhciBtZWRpYUNvbnRyb2xsZXJzID0ge307CiAgICB2YXIgdG9CZURlc3Ryb3llZCA9IG5ldyBTZXQoKTsKCiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBtZXRhZGF0YSA9IGNvbm5lY3QubWVyZ2Uoe30sIHBhcmFtcykgfHwge307CiAgICBtZXRhZGF0YS5yZWdpb24gPSAgbWV0YWRhdGEucmVnaW9uIHx8ICJ1cy13ZXN0LTIiOyAvLyBEZWZhdWx0IGl0IHRvIHVzLXdlc3QtMgoKICAgIHZhciBnZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICB2YXIgY29ubmVjdGlvbklkID0gY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgdmFyIG1lZGlhSW5mbyA9IGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCk7CiAgICAgIC8qKiBpZiB3ZSBkbyBub3QgaGF2ZSB0aGUgbWVkaWEgaW5mbyB0aGVuIGp1c3QgcmVqZWN0IHRoZSByZXF1ZXN0ICovCiAgICAgIGlmICghbWVkaWFJbmZvKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIk1lZGlhIGluZm8gZG9lcyBub3QgZXhpc3QgZm9yIGEgbWVkaWEgdHlwZSAlcyIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAud2l0aE9iamVjdChjb25uZWN0aW9uT2JqKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdCBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KCiAgICAgIGlmICghbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdKSB7CiAgICAgICAgbG9nZ2VyLmluZm8obG9nQ29tcG9uZW50LCAibWVkaWEgY29udHJvbGxlciBvZiB0eXBlICVzIGluaXQiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBzd2l0Y2ggKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpIHsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuQ0hBVDoKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LkNoYXRNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSwgbWV0YWRhdGEpLmdldCgpOwogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5TT0ZUUEhPTkU6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5UYXNrTWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCkpLmdldCgpOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIlVucmVjb2duaXplZCBtZWRpYSB0eXBlICVzICIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICB9CiAgICB9OwoKICAgIC8qKiBDaGVjayBhbGwgdGhlIGFjdGl2ZSBzdGF0ZXMgZm9yIHRoZSBjb25uZWN0aW9uICovCiAgICB2YXIgaWZDb25uZWN0aW9uQWN0aXZlID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgcmV0dXJuIGNvbm5lY3Rpb25PYmouaXNBY3RpdmUoKTsKICAgIH07CgogICAgdmFyIGdldCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIGlmIChpZkNvbm5lY3Rpb25BY3RpdmUoY29ubmVjdGlvbk9iaikpIHsKICAgICAgICByZXR1cm4gZ2V0TWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmopOwogICAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3koY29ubmVjdGlvbk9iai5nZXRDb25uZWN0aW9uSWQoKSk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBDb250cm9sbGVyIGlzIG5vIGxvbmdlciBhdmFpbGFibGUgZm9yIHRoaXMgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICBpZiAobWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdICYmICF0b0JlRGVzdHJveWVkLmhhcyhjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAiRGVzdHJveWluZyBtZWRpYUNvbnRyb2xsZXIgZm9yICVzIiwKICAgICAgICAgIGNvbm5lY3Rpb25JZAogICAgICAgICk7CiAgICAgICAgdG9CZURlc3Ryb3llZC5hZGQoY29ubmVjdGlvbklkKTsKICAgICAgICBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0KICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRyb2xsZXIuY2xlYW5VcCA9PT0gImZ1bmN0aW9uIikgY29udHJvbGxlci5jbGVhblVwKCk7CiAgICAgICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgICAgICAgIHRvQmVEZXN0cm95ZWQuZGVsZXRlKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkZWxldGUgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICAgICAgICB0b0JlRGVzdHJveWVkLmRlbGV0ZShjb25uZWN0aW9uSWQpOwogICAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBnZXQsCiAgICAgIGRlc3Ryb3k6IGRlc3Ryb3kKICAgIH07CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNDE4OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIC8vIFRPRE8gbW92ZSBzb2Z0cGhvbmUgaW1wbGVtZW50YXRpb25zIGhlcmUgLSBXaWwgZG8gdGhpcyBmb3IgR0EKICBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWVkaWFJbmZvKQogICAgICB9CiAgICB9CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMTg3OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuVGFza01lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8pIHsKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LlRBU0s7CgogICAgdmFyIGNyZWF0ZU1lZGlhSW5zdGFuY2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiLCBtZWRpYUluZm8uY29udGFjdElkKTsKICAgICAgbG9nZ2VyCiAgICAgICAgLmluZm8obG9nQ29tcG9uZW50LCAiVGFzayBtZWRpYSBjb250cm9sbGVyIGluaXQiKQogICAgICAgIC53aXRoT2JqZWN0KG1lZGlhSW5mbyk7CgogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuVGFza1Nlc3Npb24uY3JlYXRlKHsKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogbWVkaWFJbmZvLmluaXRpYWxDb250YWN0SWQsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKSwKICAgICAgfSk7CgogICAgICB0cmFja1Rhc2tDb25uZWN0aW9uU3RhdHVzKGNvbnRyb2xsZXIpOwoKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oCiAgICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJUYXNrIFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgKTsKICAgICAgICAgIHJldHVybiBjb250cm9sbGVyOwogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgbG9nZ2VyCiAgICAgICAgICAgIC5lcnJvcigKICAgICAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQgZm9yIGNvbnRhY3QgJXMiLAogICAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICAgKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnJvcik7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoCiAgICAgICAgICAgICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICAgICAgZXJyb3IKICAgICAgICAgICk7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvLAogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrVGFza0Nvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlcgogICAgICAgICAgLmVycm9yKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIsIGRhdGEpOwogICAgICB9KTsKCiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uRXN0YWJsaXNoZWQoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIKICAgICAgICAgIC5pbmZvKGxvZ0NvbXBvbmVudCwgIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjcmVhdGVNZWRpYUluc3RhbmNlKCk7CiAgICAgIH0sCiAgICB9OwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA3NDM6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgUmluZ3RvbmVFbmdpbmVCYXNlID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl9wcmV2Q29udGFjdElkID0gbnVsbDsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVDb25maWcsICJyaW5ndG9uZUNvbmZpZyIpOwogICAgaWYgKCFyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoInJpbmd0b25lVXJsIGlzIHJlcXVpcmVkISIpOwogICAgfQoKICAgIGlmIChnbG9iYWwuQXVkaW8gJiYgdHlwZW9mIGdsb2JhbC5Qcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICB0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBzZWxmLl9hdWRpbyA9IG5ldyBBdWRpbyhyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCk7CiAgICAgICAgc2VsZi5fYXVkaW8ubG9vcCA9IHRydWU7CiAgICAgICAgc2VsZi5fYXVkaW8uYWRkRXZlbnRMaXN0ZW5lcigiY2FucGxheSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuX2F1ZGlvUGxheWFibGUgPSB0cnVlOwogICAgICAgICAgcmVzb2x2ZShzZWxmLl9hdWRpbyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2F1ZGlvID0gbnVsbDsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiVW5hYmxlIHRvIHByb3ZpZGUgYSByaW5ndG9uZS4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQoKICAgIHNlbGYuX2RyaXZlUmluZ3RvbmUoKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgaW1wbGVtZW50ZWQuIik7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fc3RhcnRSaW5ndG9uZSA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAodGhpcy5fYXVkaW8pIHsKICAgICAgdGhpcy5fYXVkaW8ucGxheSgpCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgUGxheWJhY2sgRmFpbHVyZSIsIGNvbnRhY3QpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiUmluZ3RvbmUgUGxheWJhY2sgRmFpbHVyZSIpLndpdGhFeGNlcHRpb24oZSkud2l0aE9iamVjdCh7Y3VycmVudFNyYzogc2VsZi5fYXVkaW8uY3VycmVudFNyYywgc2lua0lkOiBzZWxmLl9hdWRpby5zaW5rSWQsIHZvbHVtZTogc2VsZi5fYXVkaW8udm9sdW1lfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9KTsKICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBTdGFydCIsIGNvbnRhY3QpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIFN0YXJ0Iikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9zdG9wUmluZ3RvbmUgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgaWYgKHRoaXMuX2F1ZGlvKSB7CiAgICAgIHRoaXMuX2F1ZGlvLnBhdXNlKCk7CiAgICAgIHRoaXMuX2F1ZGlvLmN1cnJlbnRUaW1lID0gMDsKICAgICAgdGhpcy5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBTdG9wIiwgY29udGFjdCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgU3RvcCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU3RvcCByaW5ndG9uZS4KICAgKi8KICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLnN0b3BSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N0b3BSaW5ndG9uZSgpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3Jpbmd0b25lU2V0dXAgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICBzZWxmLl9zdGFydFJpbmd0b25lKGNvbnRhY3QpOwogICAgICBzZWxmLl9wcmV2Q29udGFjdElkID0gY29udGFjdC5nZXRDb250YWN0SWQoKTsKCiAgICAgIGNvbnRhY3Qub25Db25uZWN0ZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgY29udGFjdC5vbkFjY2VwdGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIGNvbnRhY3Qub25FbmRlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICAvLyBKdXN0IHRvIG1ha2Ugc3VyZSB0byBzdG9wIHRoZSByaW5ndG9uZSBpbiBjYXNlIG9mIHRoZSBmYWlsdXJlcyBvZiBzcGVjaWZpYyBjYWxsYmFja3Mob25BY2NlcHRlZCxvbkNvbm5lY3RlZCk7CiAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSAhPT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HICYmCiAgICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgIT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpIHsKICAgICAgICAgIHNlbGYuX3N0b3BSaW5ndG9uZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0KSB7CiAgICBpZiAoY29udGFjdCAmJiBjb250YWN0LmdldENvbnRhY3RJZCgpKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogY29udGFjdC5nZXRDb250YWN0SWQoKQogICAgICB9KTsKICAgIH0KICB9OwoKICAvKioKICAgKiBDaGFuZ2UgdGhlIGF1ZGlvIGRldmljZSB1c2VkIHRvIHBsYXkgcmluZ3RvbmUuCiAgICogSWYgYXVkaW8gZWxlbWVudCBpcyBub3QgZnVsbHkgaW5pdGlhbGl6ZWQsIHRoZSBBUEkgd2lsbCB3YWl0IF9hdWRpb1BsYXlhYmxlUHJvbWlzZSBmb3IgMyBzZWNvbmRzIGFuZCBmYWlsIG9uIHRpbWVvdXQuCiAgICogVGhpcyBBUEkgaXMgc3VwcG9ydGVkIG9ubHkgYnkgYnJvd3NlcnMgdGhhdCBpbXBsZW1lbnRlZCBFUzYgUHJvbWlzZSBhbmQgaHR0cDovL3d3dy53My5vcmcvVFIvYXVkaW8tb3V0cHV0LwogICAqIFJldHVybiBhIFByb21pc2UgdGhhdCBpbmRpY2F0ZXMgdGhlIHJlc3VsdCBvZiBjaGFuZ2luZyBvdXRwdXQgZGV2aWNlLgogICAqLwogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuc2V0T3V0cHV0RGV2aWNlID0gZnVuY3Rpb24gKGRldmljZUlkKSB7CiAgICBpZiAodGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UpIHsKICAgICAgdmFyIHBsYXlhYmxlQXVkaW9XaXRoVGltZW91dCA9IFByb21pc2UucmFjZShbCiAgICAgICAgdGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UsCiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZWplY3QoIlRpbWVkIG91dCB3YWl0aW5nIGZvciBwbGF5YWJsZSBhdWRpbyIpOyB9LCAzMDAwLyptcyovKTsKICAgICAgICB9KQogICAgICBdKTsKICAgICAgcmV0dXJuIHBsYXlhYmxlQXVkaW9XaXRoVGltZW91dC50aGVuKGZ1bmN0aW9uIChhdWRpbykgewogICAgICAgIGlmIChhdWRpbykgewogICAgICAgICAgaWYgKGF1ZGlvLnNldFNpbmtJZCkgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGF1ZGlvLnNldFNpbmtJZChkZXZpY2VJZCkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3Qgc3VwcG9ydGVkIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm8gYXVkaW8gZm91bmQiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGlmIChnbG9iYWwuUHJvbWlzZSkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vdCBlbGlnaWJsZSByaW5ndG9uZSBvd25lciIpOwogICAgfQogIH07CgogIHZhciBWb2ljZVJpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBWb2ljZVJpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBWb2ljZVJpbmd0b25lRW5naW5lOwoKICBWb2ljZVJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5WT0lDRSAmJgogICAgICAgIGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKCiAgICBuZXcgY29ubmVjdC5BZ2VudCgpLmdldENvbnRhY3RzKCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcpIHsKICAgICAgICBvbkNvbnRhY3RDb25uZWN0KGNvbnRhY3QpOwogICAgICB9CiAgICB9KTsKICB9OwoKCiAgdmFyIENoYXRSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENoYXRSaW5ndG9uZUVuZ2luZTsKCiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5DSEFUICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDaGF0IFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uQ29ubmVjdGluZyhvbkNvbnRhY3RDb25uZWN0KTsKICAgIH0pOwogIH07CgogIHZhciBUYXNrUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFRhc2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFRhc2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUYXNrUmluZ3RvbmVFbmdpbmU7CgogIFRhc2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuVEFTSyAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiVGFzayBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKCiAgdmFyIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZTsKCiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkluY29taW5nKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuUVVFVUVfQ0FMTEJBQ0spIHsKICAgICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNhbGxiYWNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2FsbGJhY2sgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8qIGV4cG9ydCBjb25uZWN0LlJpbmd0b25lRW5naW5lICovCiAgY29ubmVjdC5Wb2ljZVJpbmd0b25lRW5naW5lID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZSA9IENoYXRSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LlRhc2tSaW5ndG9uZUVuZ2luZSA9IFRhc2tSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LlF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZSA9IFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZTsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDY0MjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmNjcFZlcnNpb24gPSAiVjIiOwoKICB2YXIgUlRQSm9iSW50ZXJ2YWxNcyA9IDEwMDA7CiAgdmFyIHN0YXRzUmVwb3J0aW5nSm9iSW50ZXJ2YWxNcyA9IDMwMDAwOwogIHZhciBzdHJlYW1CdWZmZXJTaXplID0gNTAwOwogIHZhciBDYWxsVHlwZU1hcCA9IHt9OwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuQVVESU9fT05MWV0gPSAnQXVkaW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuVklERU9fT05MWV0gPSAnVmlkZW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuQVVESU9fVklERU9dID0gJ0F1ZGlvVmlkZW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuTk9ORV0gPSAnTm9uZSc7CiAgdmFyIEFVRElPX0lOUFVUID0gJ2F1ZGlvX2lucHV0JzsKICB2YXIgQVVESU9fT1VUUFVUID0gJ2F1ZGlvX291dHB1dCc7CgogIHZhciBNZWRpYVR5cGVNYXAgPSB7fTsKICBNZWRpYVR5cGVNYXBbY29ubmVjdC5Db250YWN0VHlwZS5WT0lDRV0gPSAiVm9pY2UiOwogIHZhciBVTktOT1dOX01FRElBX1RZUEUgPSAiVW5rbm93biI7CgogIHZhciB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICB2YXIgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0ge307CiAgdmFyIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0ge307CiAgdmFyIHJ0cFN0YXRzSm9iID0gbnVsbDsKICB2YXIgcmVwb3J0U3RhdHNKb2IgPSBudWxsOwogIC8vTG9nZ2VyIHNwZWNpZmljIHRvIHNvZnRwaG9uZS4KICB2YXIgbG9nZ2VyID0gbnVsbDsKICB2YXIgU29mdHBob25lRXJyb3JUeXBlcyA9IGNvbm5lY3QuU29mdHBob25lRXJyb3JUeXBlczsKICB2YXIgSEFOR19VUF9NVUxUSVBMRV9TRVNTSU9OU19FVkVOVCA9ICJNdWx0aVNlc3Npb25IYW5nVXAiOwogIHZhciBNVUxUSVBMRV9TRVNTSU9OU19FVkVOVCA9ICJNdWx0aVNlc3Npb25zIjsKCiAgdmFyIGxvY2FsTWVkaWFTdHJlYW0gPSB7fTsKCiAgdmFyIHNvZnRwaG9uZUNsaWVudElkID0gY29ubmVjdC5yYW5kb21JZCgpOwoKICB2YXIgcmVxdWVzdEljZUFjY2VzcyA9IGZ1bmN0aW9uICh0cmFuc3BvcnQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKS5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB0cmFuc3BvcnQsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgcmVzb2x2ZShkYXRhLnNvZnRwaG9uZVRyYW5zcG9ydC5zb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIGlmIChyZWFzb24ubWVzc2FnZSAmJiByZWFzb24ubWVzc2FnZS5pbmNsdWRlcygiU29mdHBob25lQ29ubmVjdGlvbkxpbWl0QnJlYWNoZWRFeGNlcHRpb24iKSkgewogICAgICAgICAgICBwdWJsaXNoRXJyb3IoIm11bHRpcGxlX3NvZnRwaG9uZV9hY3RpdmVfc2Vzc2lvbnMiLCAiTnVtYmVyIG9mIGFjdGl2ZSBzZXNzaW9ucyBhcmUgbW9yZSB0aGVuIGFsbG93ZWQgbGltaXQuIiwgIiIpOwogICAgICAgICAgfQogICAgICAgICAgcmVqZWN0KEVycm9yKCJyZXF1ZXN0SWNlQWNjZXNzIGZhaWxlZCIpKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkF1dGhlbnRpY2F0aW9uIGZhaWxlZCB3aGlsZSByZXF1ZXN0SWNlQWNjZXNzIikpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkFjY2VzcyBEZW5pZWQgd2hpbGUgcmVxdWVzdEljZUFjY2VzcyIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAoc29mdHBob25lUGFyYW1zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBsb2dnZXIgPSBuZXcgU29mdHBob25lTG9nZ2VyKGNvbm5lY3QuZ2V0TG9nKCkpOwogICAgbG9nZ2VyLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gc29mdHBob25lIG1hbmFnZXIgaW5pdGlhbGl6YXRpb24gaGFzIGJlZ3VuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBydGNQZWVyQ29ubmVjdGlvbkZhY3Rvcnk7CiAgICBpZiAoY29ubmVjdC5SdGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkpIHsKICAgICAgcnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5ID0gbmV3IGNvbm5lY3QuUnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KGxvZ2dlciwKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpLAogICAgICAgIHNvZnRwaG9uZUNsaWVudElkLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgcmVxdWVzdEljZUFjY2VzcywgewogICAgICAgICAgdHJhbnNwb3J0VHlwZTogInNvZnRwaG9uZSIsCiAgICAgICAgICBzb2Z0cGhvbmVDbGllbnRJZDogc29mdHBob25lQ2xpZW50SWQKICAgICAgICB9KSwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHB1Ymxpc2hFcnJvcikpOwogICAgfQogICAgaWYgKCFpc0Jyb3dzZXJTb2Z0UGhvbmVTdXBwb3J0ZWQoKSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSLAogICAgICAgICJDb25uZWN0IGRvZXMgbm90IHN1cHBvcnQgdGhpcyBicm93c2VyLiBTb21lIGZ1bmN0aW9uYWxpdHkgbWF5IG5vdCB3b3JrLiAiLAogICAgICAgICIiKTsKICAgIH0KICAgIHZhciBndW1Qcm9taXNlID0gZmV0Y2hVc2VyTWVkaWEoewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDb25uZWN0aXZpdHlDaGVja1Jlc3VsdCIsIG51bGwsIAogICAgICAgIHsKICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgIHN0YXR1czogImdyYW50ZWQiCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBwdWJsaXNoRXJyb3IoZXJyLCAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwgIiIpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICB7CiAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNaWNyb3Bob25lUGVybWlzc2lvbiIsCiAgICAgICAgICBzdGF0dXM6ICJkZW5pZWQiCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICBoYW5kbGVTb2Z0UGhvbmVNdXRlVG9nZ2xlKCk7CiAgICBoYW5kbGVTcGVha2VyRGV2aWNlQ2hhbmdlKCk7CiAgICBoYW5kbGVNaWNyb3Bob25lRGV2aWNlQ2hhbmdlKCk7CiAgICBtb25pdG9yTWljcm9waG9uZVBlcm1pc3Npb24oKTsKCiAgICB0aGlzLnJpbmd0b25lRW5naW5lID0gbnVsbDsKICAgIHZhciBydGNTZXNzaW9ucyA9IHt9OwogICAgLy8gVHJhY2tzIHRoZSBhZ2VudCBjb25uZWN0aW9uIElELCBzbyB0aGF0IGlmIHRoZSBzYW1lIGNvbnRhY3QgZ2V0cyByZS1yb3V0ZWQgdG8gdGhlIHNhbWUgYWdlbnQsIGl0J2xsIHN0aWxsIHNldCB1cCBzb2Z0cGhvbmUKICAgIHZhciBjYWxsc0RldGVjdGVkID0ge307CiAgICB0aGlzLm9uSW5pdENvbnRhY3RTdWIgPSB7fTsKICAgIHRoaXMub25Jbml0Q29udGFjdFN1Yi51bnN1YnNjcmliZSA9IGZ1bmN0aW9uKCkge307CgogICAgLy8gdmFyaWFibGVzIGZvciBmaXJlZm94IG11bHRpdGFiCiAgICB2YXIgaXNTZXNzaW9uUGVuZGluZyA9IGZhbHNlOwogICAgdmFyIHBlbmRpbmdDb250YWN0ID0gbnVsbDsKICAgIHZhciBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBudWxsOwogICAgdmFyIHBvc3Rwb25lU3RhcnRpbmdTZXNzaW9uID0gZnVuY3Rpb24gKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlzU2Vzc2lvblBlbmRpbmcgPSB0cnVlOwogICAgICBwZW5kaW5nQ29udGFjdCA9IGNvbnRhY3Q7CiAgICAgIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IGFnZW50Q29ubmVjdGlvbklkOwogICAgfQogICAgdmFyIGNhbmNlbFBlbmRpbmdTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgICBpc1Nlc3Npb25QZW5kaW5nID0gZmFsc2U7CiAgICAgIHBlbmRpbmdDb250YWN0ID0gbnVsbDsKICAgICAgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gbnVsbDsKICAgIH0KCiAgICAvLyBoZWxwZXIgbWV0aG9kIHRvIHByb3ZpZGUgYWNjZXNzIHRvIHJ0YyBzZXNzaW9ucwogICAgdGhpcy5nZXRTZXNzaW9uID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICByZXR1cm4gcnRjU2Vzc2lvbnNbY29ubmVjdGlvbklkXTsKICAgIH0KCiAgICB0aGlzLnJlcGxhY2VMb2NhbE1lZGlhVHJhY2sgPSBmdW5jdGlvbihjb25uZWN0aW9uSWQsIHRyYWNrKSB7CiAgICAgIHZhciBzdHJlYW0gPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0uc3RyZWFtOwogICAgICBpZihzdHJlYW0pewogICAgICAgIHZhciBvbGRUcmFjayA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgIHRyYWNrLmVuYWJsZWQgPSBvbGRUcmFjay5lbmFibGVkOwogICAgICAgIG9sZFRyYWNrLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBzdHJlYW0ucmVtb3ZlVHJhY2sob2xkVHJhY2spOwogICAgICAgIHN0cmVhbS5hZGRUcmFjayh0cmFjayk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIGlzQ29udGFjdFRlcm1pbmF0ZWQgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVOREVEIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVSUk9SIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLk1JU1NFRDsKICAgIH07CgogICAgdmFyIGRlc3Ryb3lTZXNzaW9uID0gZnVuY3Rpb24gKGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShhZ2VudENvbm5lY3Rpb25JZCkpIHsKICAgICAgICB2YXIgc2Vzc2lvbiA9IHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAvLyBDdXJyZW50bHkgdGhlIGFzc3VtcHRpb24gaXMgaXQgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24gb25seSBhbmQgaWYgb25seSBpdCBhbHJlYWR5IGhhcyBiZWVuIGh1bmcgdXAuCiAgICAgICAgLy8gVE9ETzogVXBkYXRlIG9uY2UgdGhlIGhhbmd1cCBBUEkgZG9lcyBub3QgdGhyb3cgZXhjZXB0aW9ucwogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBzZXNzaW9uLmhhbmd1cCgpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGxpbHkuZ2V0TG9nKCkud2FybigiQ2xlYW4gdXAgdGhlIHNlc3Npb24gbG9jYWxseSAiICsgYWdlbnRDb25uZWN0aW9uSWQsIGVyci5tZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIC8vIFdoZW4gbXVsdGlwbGUgUlRDIHNlc3Npb25zIGRldGVjdGVkLCBpZ25vcmUgdGhlIG5ldyBjYWxsIGFuZCBoYW5nIHVwIHRoZSBwcmV2aW91cyBzZXNzaW9ucy4KICAgIC8vIFRPRE86IFVwZGF0ZSB3aGVuIGNvbm5lY3QtcnRjIGV4cG9zZXMgYW4gQVBJIHRvIGRldGVjdCBzZXNzaW9uIHN0YXR1cy4KICAgIHZhciBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb25zKSB7CiAgICAgIGlmIChPYmplY3Qua2V5cyhydGNTZXNzaW9ucykubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEVycm9yISBvdXIgc3RhdGUgZG9lc24ndCBtYXRjaCwgdGVhciBpdCBhbGwgZG93bi4KICAgICAgICBmb3IgKHZhciBjb25uZWN0aW9uSWQgaW4gcnRjU2Vzc2lvbnMpIHsKICAgICAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgICAgIC8vIExvZyBhbiBlcnJvciBmb3IgdGhlIHNlc3Npb24gd2UgYXJlIGFib3V0IHRvIGVuZC4KICAgICAgICAgICAgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudChIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5ULCBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdLmNhbGxJZCwgY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgZGVzdHJveVNlc3Npb24oY29ubmVjdGlvbklkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkdXBsaWNhdGUgc2Vzc2lvbiBkZXRlY3RlZCwgcmVmdXNpbmcgdG8gc2V0dXAgbmV3IGNvbm5lY3Rpb24iKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnN0YXJ0U2Vzc2lvbiA9IGZ1bmN0aW9uIChfY29udGFjdCwgX2FnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIHZhciBjb250YWN0ID0gaXNTZXNzaW9uUGVuZGluZyA/IHBlbmRpbmdDb250YWN0IDogX2NvbnRhY3Q7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGlzU2Vzc2lvblBlbmRpbmcgPyBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgOiBfYWdlbnRDb25uZWN0aW9uSWQ7CiAgICAgIGlmICghY29udGFjdCB8fCAhYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY2FuY2VsUGVuZGluZ1Nlc3Npb24oKTsKICAgICAgCiAgICAgIC8vIFNldCB0byB0cnVlLCB0aGlzIHdpbGwgYmxvY2sgc3Vic2VxdWVudCBpbnZva2VzIGZyb20gZW50ZXJpbmcuCiAgICAgIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdID0gdHJ1ZTsKICAgICAgbG9nZ2VyLmluZm8oIlNvZnRwaG9uZSBjYWxsIGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgLy8gRW5zdXJlIG91ciBzZXNzaW9uIHN0YXRlIG1hdGNoZXMgb3VyIGNvbnRhY3Qgc3RhdGUgdG8gcHJldmVudCBpc3N1ZXMgc2hvdWxkIHdlIGxvc2UgdHJhY2sgb2YgYSBjb250YWN0LgogICAgICBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zKHJ0Y1Nlc3Npb25zKTsKCiAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORykgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIENvbm5lY3RpbmciLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgfQoKICAgICAgaW5pdGlhbGl6ZVBhcmFtcygpOwogICAgICB2YXIgc29mdHBob25lSW5mbyA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuZ2V0U29mdHBob25lTWVkaWFJbmZvKCk7CiAgICAgIHZhciBjYWxsQ29uZmlnID0gcGFyc2VDYWxsQ29uZmlnKHNvZnRwaG9uZUluZm8uY2FsbENvbmZpZ0pzb24pOwogICAgICB2YXIgd2ViU29ja2V0UHJvdmlkZXI7CiAgICAgIGlmIChjYWxsQ29uZmlnLnVzZVdlYlNvY2tldFByb3ZpZGVyKSB7CiAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIgPSBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpOwogICAgICB9CiAgICAgIHZhciBzZXNzaW9uID0gbmV3IGNvbm5lY3QuUlRDU2Vzc2lvbigKICAgICAgICBjYWxsQ29uZmlnLnNpZ25hbGluZ0VuZHBvaW50LAogICAgICAgIGNhbGxDb25maWcuaWNlU2VydmVycywKICAgICAgICBzb2Z0cGhvbmVJbmZvLmNhbGxDb250ZXh0VG9rZW4sCiAgICAgICAgbG9nZ2VyLAogICAgICAgIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksCiAgICAgICAgYWdlbnRDb25uZWN0aW9uSWQsCiAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIpOwoKICAgICAgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdID0gc2Vzc2lvbjsKCiAgICAgIGlmIChjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCkpIHsKICAgICAgICBzZXNzaW9uLm1lZGlhU3RyZWFtID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpOwogICAgICB9CgogICAgICAvLyBDdXN0b20gRXZlbnQgdG8gaW5kaWNhdGUgdGhlIHNlc3Npb24gaW5pdCBvcGVyYXRpb25zCiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBjb25uZWN0aW9uSWQ6IGFnZW50Q29ubmVjdGlvbklkCiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHNlc3Npb24ub25TZXNzaW9uRmFpbGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIHB1Ymxpc2hTb2Z0cGhvbmVGYWlsdXJlTG9ncyhydGNTZXNzaW9uLCByZWFzb24pOwogICAgICAgIHB1Ymxpc2hTZXNzaW9uRmFpbHVyZVRlbGVtZXRyeUV2ZW50KGNvbnRhY3QuZ2V0Q29udGFjdElkKCksIHJlYXNvbik7CiAgICAgICAgc3RvcEpvYnNBbmRSZXBvcnQoY29udGFjdCwgcnRjU2Vzc2lvbi5zZXNzaW9uUmVwb3J0KTsKICAgICAgfTsKICAgICAgc2Vzc2lvbi5vblNlc3Npb25Db25uZWN0ZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gQ29ubmVjdGVkIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CiAgICAgICAgLy8gQmVjb21lIG1hc3RlciB0byBzZW5kIGxvZ3MsIHNpbmNlIHdlIG5lZWQgbG9ncyBmcm9tIHNvZnRwaG9uZSB0YWIuCiAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAvL3N0YXJ0IHN0YXRzIGNvbGxlY3Rpb24gYW5kIHJlcG9ydGluZyBqb2JzCiAgICAgICAgc3RhcnRTdGF0c0NvbGxlY3Rpb25Kb2IocnRjU2Vzc2lvbik7CiAgICAgICAgc3RhcnRTdGF0c1JlcG9ydGluZ0pvYihjb250YWN0KTsKICAgICAgICBmaXJlQ29udGFjdEFjY2VwdGVkRXZlbnQoY29udGFjdCk7CiAgICAgIH07CgogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbXBsZXRlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb21wbGV0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKCiAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgLy8gU3RvcCBhbGwgam9icyBhbmQgcGVyZm9ybSBvbmUgbGFzdCBqb2IuCiAgICAgICAgc3RvcEpvYnNBbmRSZXBvcnQoY29udGFjdCwgcnRjU2Vzc2lvbi5zZXNzaW9uUmVwb3J0KTsKCiAgICAgICAgLy8gQ2xlYW51cCB0aGUgY2FjaGVkIHN0cmVhbXMKICAgICAgICBkZWxldGVMb2NhbE1lZGlhU3RyZWFtKGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ub25Mb2NhbFN0cmVhbUFkZGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHN0cmVhbSkgewogICAgICAgIC8vIENhY2hlIHRoZSBzdHJlYW1zIGZvciBtdXRlL3VubXV0ZQogICAgICAgIGxvY2FsTWVkaWFTdHJlYW1bYWdlbnRDb25uZWN0aW9uSWRdID0gewogICAgICAgICAgc3RyZWFtOiBzdHJlYW0KICAgICAgICB9OwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLkxPQ0FMX01FRElBX1NUUkVBTV9DUkVBVEVELAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBjb25uZWN0aW9uSWQ6IGFnZW50Q29ubmVjdGlvbklkCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICBzZXNzaW9uLnJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGUtYXVkaW8nKTsKICAgICAgaWYgKHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSkgewogICAgICAgIHNlc3Npb24uY29ubmVjdChydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkuZ2V0KGNhbGxDb25maWcuaWNlU2VydmVycykpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlc3Npb24uY29ubmVjdCgpOwogICAgICB9CiAgICB9CgogICAgdmFyIG9uUmVmcmVzaENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXSAmJiBpc0NvbnRhY3RUZXJtaW5hdGVkKGNvbnRhY3QpKSB7CiAgICAgICAgZGVzdHJveVNlc3Npb24oYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIGNhbmNlbFBlbmRpbmdTZXNzaW9uKCk7CiAgICAgIH0KICAgICAgaWYgKGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgIWNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdICYmICgKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykpIHsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb25uZWN0Lmhhc090aGVyQ29ubmVjdGVkQ0NQcygpKSB7CiAgICAgICAgICAgIHBvc3Rwb25lU3RhcnRpbmdTZXNzaW9uKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICB2YXIgb25Jbml0Q29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuY29ubmVjdGlvbklkOwogICAgICBsb2dnZXIuaW5mbygiQ29udGFjdCBkZXRlY3RlZDoiLCAiY29udGFjdElkICIgKyBjb250YWN0LmdldENvbnRhY3RJZCgpLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIGlmICghY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0pIHsKICAgICAgICBjb250YWN0Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvblJlZnJlc2hDb250YWN0KGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICBzZWxmLm9uSW5pdENvbnRhY3RTdWIgPSBjb25uZWN0LmNvbnRhY3Qob25Jbml0Q29udGFjdCk7CgogICAgLy8gQ29udGFjdCBhbHJlYWR5IGluIGNvbm5lY3Rpbmcgc3RhdGUgc2NlbmFyaW8gLSBJbiB0aGlzIGNhc2UgY29udGFjdCBJTklUIGlzIG1pc3NlZCBoZW5jZSB0aGUgT25SZWZyZXNoIGNhbGxiYWNrIGlzIG1pc3NlZC4gCiAgICBuZXcgY29ubmVjdC5BZ2VudCgpLmdldENvbnRhY3RzKCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmNvbm5lY3Rpb25JZDsKICAgICAgbG9nZ2VyLmluZm8oIkNvbnRhY3QgZXhpc3QgaW4gdGhlIHNuYXBzaG90LiBSZWluaXRpYXRlIHRoZSBDb250YWN0IGFuZCBSVEMgc2Vzc2lvbiBjcmVhdGlvbiBmb3IgY29udGFjdElkIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBvbkluaXRDb250YWN0KGNvbnRhY3QpOwogICAgICBvblJlZnJlc2hDb250YWN0KGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgIH0pOwogIH07CgogIHZhciBmaXJlQ29udGFjdEFjY2VwdGVkRXZlbnQgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgIHZhciBhZ2VudENvbm5lY3Rpb24gPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpOwogICAgaWYgKCFhZ2VudENvbm5lY3Rpb24pIHsKICAgICAgbG9nZ2VyLmluZm8oIk5vdCBhYmxlIHRvIHJldHJpZXZlIHRoZSBhdXRvLWFjY2VwdCBzZXR0aW5nIGZyb20gbnVsbCBBZ2VudENvbm5lY3Rpb24sIGlnbm9yaW5nIGV2ZW50IHB1Ymxpc2guLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzb2Z0cGhvbmVNZWRpYUluZm8gPSBhZ2VudENvbm5lY3Rpb24uZ2V0U29mdHBob25lTWVkaWFJbmZvKCk7CiAgICBpZiAoIXNvZnRwaG9uZU1lZGlhSW5mbykgewogICAgICBsb2dnZXIuaW5mbygiTm90IGFibGUgdG8gcmV0cmlldmUgdGhlIGF1dG8tYWNjZXB0IHNldHRpbmcgZnJvbSBudWxsIFNvZnRwaG9uZU1lZGlhSW5mbywgaWdub3JpbmcgZXZlbnQgcHVibGlzaC4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHNvZnRwaG9uZU1lZGlhSW5mby5hdXRvQWNjZXB0ID09PSB0cnVlKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJBdXRvLWFjY2VwdCBpcyBlbmFibGVkLCBzZW5kaW5nIG91dCBBY2NlcHRlZCBldmVudCB0byBzdG9wIHJpbmd0b25lLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdC5jb250YWN0SWQpCiAgICAgIH0pOwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELCBjb250YWN0LmNvbnRhY3RJZCksCiAgICAgICAgZGF0YTogbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0LmNvbnRhY3RJZCkKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBsb2dnZXIuaW5mbygiQXV0by1hY2NlcHQgaXMgZGlzYWJsZWQsIHJpbmd0b25lIHdpbGwgYmUgc3RvcHBlZCBieSB1c2VyIGFjdGlvbi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIC8vIEJpbmQgZXZlbnRzIGZvciBtdXRlCiAgdmFyIGhhbmRsZVNvZnRQaG9uZU11dGVUb2dnbGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUsIG11dGVUb2dnbGUpOwogIH07CgogIHZhciBoYW5kbGVTcGVha2VyRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfU1BFQUtFUl9ERVZJQ0UsIHNldFNwZWFrZXJEZXZpY2UpOwogIH0KCiAgdmFyIGhhbmRsZU1pY3JvcGhvbmVEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsIHNldE1pY3JvcGhvbmVEZXZpY2UpOwogIH0KCiAgdmFyIG1vbml0b3JNaWNyb3Bob25lUGVybWlzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmlzQ2hyb21lQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0Q2hyb21lQnJvd3NlclZlcnNpb24oKSA+IDQzKXsKICAgICAgICBuYXZpZ2F0b3IucGVybWlzc2lvbnMucXVlcnkoe25hbWU6ICdtaWNyb3Bob25lJ30pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocGVybWlzc2lvblN0YXR1cyl7CiAgICAgICAgICBwZXJtaXNzaW9uU3RhdHVzLm9uY2hhbmdlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk1pY3JvcGhvbmUgUGVybWlzc2lvbjogIiArIHBlcm1pc3Npb25TdGF0dXMuc3RhdGUpOwogICAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0IiwgbnVsbCwgCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNaWNyb3Bob25lUGVybWlzc2lvbiIsCiAgICAgICAgICAgICAgc3RhdHVzOiBwZXJtaXNzaW9uU3RhdHVzLnN0YXRlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihwZXJtaXNzaW9uU3RhdHVzLnN0YXRlID09PSAnZGVuaWVkJyl7CiAgICAgICAgICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVELAogICAgICAgICAgICAgICAgIllvdXIgbWljcm9waG9uZSBpcyBub3QgZW5hYmxlZCBpbiB5b3VyIGJyb3dzZXIuICIsCiAgICAgICAgICAgICAgICAiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGxvZ2dlci5lcnJvcigiRmFpbGVkIGluIGRldGVjdGluZyBtaWNyb3Bob25lIHBlcm1pc3Npb24gc3RhdHVzOiAiICsgZSk7CiAgICB9CiAgfQoKICAvLyBNYWtlIHN1cmUgb25jZSB3ZSBkaXNjb25uZWN0ZWQgd2UgZ2V0IHRoZSBtdXRlIHN0YXRlIGJhY2sgdG8gbm9ybWFsCiAgdmFyIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICBkZWxldGUgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogZmFsc2UgfQogICAgfSk7CiAgfTsKCiAgLy8gQ2hlY2sgZm9yIHRoZSBsb2NhbCBzdHJlYW1zIGlmIGV4aXN0cyAgLSAgcmV2ZXJ0IGl0CiAgLy8gQW5kIGluZm9ybSBvdGhlciBjbGllbnRzIGFib3V0IHRoZSBjaGFuZ2UgCiAgdmFyIG11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHN0YXR1czsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZGF0YSAmJiBkYXRhLm11dGUgIT09IHVuZGVmaW5lZCkgewogICAgICBzdGF0dXMgPSBkYXRhLm11dGU7CiAgICB9CgogICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICBpZiAobG9jYWxNZWRpYSkgewogICAgICAgICAgdmFyIGF1ZGlvVHJhY2tzID0gbG9jYWxNZWRpYS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgaWYgKHN0YXR1cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGF1ZGlvVHJhY2tzLmVuYWJsZWQgPSAhc3RhdHVzOwogICAgICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgPSBzdGF0dXM7CgogICAgICAgICAgICBpZiAoc3RhdHVzKSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyBtdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gICIgKyBjb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyB1bm11dGVkIHRoZSBjb250YWN0LCBjb25uZWN0aW9uSWQgLSAiICsgY29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkIHx8IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IHN0YXR1cyB9CiAgICB9KTsKICB9OwoKICB2YXIgc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCB8fCAhZGF0YSB8fCAhZGF0YS5kZXZpY2VJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgdmFyIHJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGUtYXVkaW8nKTsKICAgIHRyeSB7CiAgICAgIGxvZ2dlci5pbmZvKCJUcnlpbmcgdG8gc2V0IHNwZWFrZXIgdG8gZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICAgIGlmIChyZW1vdGVBdWRpb0VsZW1lbnQgJiYgdHlwZW9mIHJlbW90ZUF1ZGlvRWxlbWVudC5zZXRTaW5rSWQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZW1vdGVBdWRpb0VsZW1lbnQuc2V0U2lua0lkKGRldmljZUlkKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgc3BlYWtlciB0byBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU1BFQUtFUl9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgc2V0TWljcm9waG9uZURldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIHZhciBzb2Z0cGhvbmVNYW5hZ2VyID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIoKTsKICAgIHRyeSB7CiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsgYXVkaW86IHsgZGV2aWNlSWQ6IHsgZXhhY3Q6IGRldmljZUlkIH0gfSB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChuZXdNaWNyb3Bob25lU3RyZWFtKSB7CiAgICAgICAgICB2YXIgbmV3TWljcm9waG9uZVRyYWNrID0gbmV3TWljcm9waG9uZVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgICAgIC8vUmVwbGFjZSB0aGUgYXVkaW8gdHJhY2sgaW4gdGhlIFJ0Y1BlZXJDb25uZWN0aW9uCiAgICAgICAgICAgICAgc2Vzc2lvbi5fcGMuZ2V0U2VuZGVycygpWzBdLnJlcGxhY2VUcmFjayhuZXdNaWNyb3Bob25lVHJhY2spLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy9SZXBsYWNlIHRoZSBhdWRpbyB0cmFjayBpbiB0aGUgbG9jYWwgbWVkaWEgc3RyZWFtIChmb3IgbXV0ZSAvIHVubXV0ZSkKICAgICAgICAgICAgICAgIHNvZnRwaG9uZU1hbmFnZXIucmVwbGFjZUxvY2FsTWVkaWFUcmFjayhjb25uZWN0aW9uSWQsIG5ld01pY3JvcGhvbmVUcmFjayk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0gY2F0Y2goZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgbWljcm9waG9uZSBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuTUlDUk9QSE9ORV9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCkgewogICAgICB2YXIgZW5kUG9pbnRVcmwgPSAiXG4iOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJscy5sZW5ndGg7IGorKykgewogICAgICAgICAgZW5kUG9pbnRVcmwgPSBlbmRQb2ludFVybCArIHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJsc1tqXSArICJcbiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLklDRV9DT0xMRUNUSU9OX1RJTUVPVVQsICJJY2UgY29sbGVjdGlvbiB0aW1lZG91dC4gIiwgZW5kUG9pbnRVcmwpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlVTRVJfQlVTWSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5VU0VSX0JVU1lfRVJST1IsCiAgICAgICAgIlNvZnRwaG9uZSBjYWxsIFVzZXJCdXN5IGVycm9yLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0hBTkRTSEFLRV9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUsCiAgICAgICAgIkhhbmRzaGFraW5nIHdpdGggU2lnbmFsbGluZyBTZXJ2ZXIgIiArIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSArICIgZmFpbGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX1RJTUVPVVRfRkFJTFVSRSB8fCByZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkdVTV9PVEhFUl9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCwKICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAiIik7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUsCiAgICAgICAgIlVSTCAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBjYW5ub3QgYmUgcmVhY2hlZC4gIiwKICAgICAgICBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkNBTExfTk9UX0ZPVU5EKSB7CiAgICAgIC8vIE5vIG5lZWQgdG8gcHVibGlzaCBhbnkgc29mdHBob25lIGVycm9yIGZvciB0aGlzIGNhc2UuIENDUCBVWCB3aWxsIGhhbmRsZSB0aGlzIGNhc2UuCiAgICAgIGxvZ2dlci5lcnJvcigiU29mdHBob25lIGNhbGwgZmFpbGVkIGR1ZSB0byBDYWxsTm90Rm91bmRFeGNlcHRpb24uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLldFQlJUQ19FUlJPUiwKICAgICAgICAid2VicnRjIHN5c3RlbSBlcnJvci4gIiwKICAgICAgICAiIik7CiAgICB9CiAgfTsKCiAgLyoqIFBhcnNlIHRoZSBKU09OIGVuY29kZWQgd2ViIGNhbGwgY29uZmlnIGludG8gdGhlIGRhdGEgaXQgcmVwcmVzZW50cy4gKi8KICB2YXIgcGFyc2VDYWxsQ29uZmlnID0gZnVuY3Rpb24gKHNlcmlhbGl6ZWRDb25maWcpIHsKICAgIC8vIE91ciB1bmRlcnNjb3JlIGlzIHRvbyBvbGQgZm9yIHVuZXNjYXBlCiAgICAvLyBodHRwczovL2lzc3Vlcy5hbWF6b24uY29tL2lzc3Vlcy9DU1dGLTE0NjcKICAgIHZhciBkZWNvZGVkSlNPTiA9IHNlcmlhbGl6ZWRDb25maWcucmVwbGFjZSgvJnF1b3Q7L2csICciJyk7CiAgICByZXR1cm4gSlNPTi5wYXJzZShkZWNvZGVkSlNPTik7CiAgfTsKCiAgdmFyIGZldGNoVXNlck1lZGlhID0gZnVuY3Rpb24gKGNhbGxiYWNrc0luKSB7CiAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IGNhbGxiYWNrcy5zdWNjZXNzIHx8IGZ1bmN0aW9uICgpIHsgfTsKICAgIGNhbGxiYWNrcy5mYWlsdXJlID0gY2FsbGJhY2tzLmZhaWx1cmUgfHwgZnVuY3Rpb24gKCkgeyB9OwoKICAgIHZhciBDT05TVFJBSU5UID0gewogICAgICBhdWRpbzogdHJ1ZQogICAgfTsKCiAgICB2YXIgcHJvbWlzZSA9IG51bGw7CgogICAgaWYgKHR5cGVvZiBQcm9taXNlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMgPT09ICJvYmplY3QiICYmIHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCk7CgogICAgfSBlbHNlIGlmICh0eXBlb2YgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgIHZhciBhdWRpb1RyYWNrcyA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwogICAgICBpZiAoYXVkaW9UcmFja3MgJiYgYXVkaW9UcmFja3MubGVuZ3RoID4gMCkgewogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHN0cmVhbSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgIH0pOwogICAgcmV0dXJuIHByb21pc2U7CiAgfTsKCiAgdmFyIHB1Ymxpc2hFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICBsb2dnZXIuZXJyb3IoIlNvZnRwaG9uZSBlcnJvciBvY2N1cnJlZCA6ICIsIGVycm9yVHlwZSwKICAgICAgbWVzc2FnZSB8fCAiIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLlNPRlRQSE9ORV9FUlJPUiwKICAgICAgZGF0YTogbmV3IGNvbm5lY3QuU29mdHBob25lRXJyb3IoZXJyb3JUeXBlLCBtZXNzYWdlLCBlbmRQb2ludFVybCkKICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoU2Vzc2lvbkZhaWx1cmVUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0SWQsIHJlYXNvbikgewogICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBGYWlsZWQiLCBjb250YWN0SWQsIHsKICAgICAgZmFpbGVkUmVhc29uOiByZWFzb24KICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGRhdGEpIHsKICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgY29udGFjdElkOiBjb250YWN0SWQsCiAgICAgIGRhdGE6IGRhdGEKICAgIH0pOwogIH07CgogIC8vIFB1Ymxpc2ggdGhlIGNvbnRhY3QgYW5kIGFnZW50IGluZm9ybWF0aW9uIGluIGEgbXVsdGlwbGUgc2Vzc2lvbnMgc2NlbmFyaW9zCiAgdmFyIHB1Ymxpc2hNdWx0aXBsZVNlc3Npb25zRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoZXZlbnROYW1lLCBjb250YWN0SWQsIFt7CiAgICAgIG5hbWU6ICJBZ2VudENvbm5lY3Rpb25JZCIsCiAgICAgIHZhbHVlOiBhZ2VudENvbm5lY3Rpb25JZAogICAgfV0pOwogICAgbG9nZ2VyLmluZm8oIlB1Ymxpc2ggbXVsdGlwbGUgc2Vzc2lvbiBlcnJvciBtZXRyaWNzIiwgZXZlbnROYW1lLCAiY29udGFjdElkICIgKyBjb250YWN0SWQsICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKQogICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICB9OwoKICB2YXIgaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkID0gZnVuY3Rpb24gKCkgewogICAgLy8gSW4gT3BlcmEsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIk9wZXJhIiBvciBhZnRlciAiVmVyc2lvbiIKICAgIGlmIChjb25uZWN0LmlzT3BlcmFCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uKCkgPiAxNykgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIENocm9tZSwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiQ2hyb21lIgogICAgZWxzZSBpZiAoY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uKCkgPiAyMikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIEZpcmVmb3gsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIkZpcmVmb3giCiAgICBlbHNlIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb25uZWN0LmdldEZpcmVmb3hCcm93c2VyVmVyc2lvbigpID4gMjEpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKCiAgdmFyIHNlbmRTb2Z0cGhvbmVNZXRyaWNzID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzdHJlYW1TdGF0cyA9IHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5zbGljZSgpOwogICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgICBpZiAoc3RyZWFtU3RhdHMubGVuZ3RoID4gMCkgewogICAgICBjb250YWN0LnNlbmRTb2Z0cGhvbmVNZXRyaWNzKHN0cmVhbVN0YXRzLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oInNlbmRTb2Z0cGhvbmVNZXRyaWNzIHN1Y2Nlc3MiICsgSlNPTi5zdHJpbmdpZnkoc3RyZWFtU3RhdHMpKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBsb2dnZXIuZXJyb3IoInNlbmRTb2Z0cGhvbmVNZXRyaWNzIGZhaWxlZC4iKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIHZhciBzZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIHJlcG9ydCwgdXNlckF1ZGlvU3RhdHMsIHJlbW90ZUF1ZGlvU3RhdHMpIHsKICAgIHJlcG9ydC5zdHJlYW1TdGF0cyA9IFthZGRTdHJlYW1UeXBlVG9TdGF0cyh1c2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLAogICAgYWRkU3RyZWFtVHlwZVRvU3RhdHMocmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKV07CiAgICB2YXIgY2FsbFJlcG9ydCA9IHsKICAgICAgY2FsbFN0YXJ0VGltZTogcmVwb3J0LnNlc3Npb25TdGFydFRpbWUsCiAgICAgIGNhbGxFbmRUaW1lOiByZXBvcnQuc2Vzc2lvbkVuZFRpbWUsCiAgICAgIGd1bVRpbWVNaWxsaXM6IHJlcG9ydC5ndW1UaW1lTWlsbGlzLAogICAgICBpbml0aWFsaXphdGlvblRpbWVNaWxsaXM6IHJlcG9ydC5pbml0aWFsaXphdGlvblRpbWVNaWxsaXMsCiAgICAgIGljZUNvbGxlY3Rpb25UaW1lTWlsbGlzOiByZXBvcnQuaWNlQ29sbGVjdGlvblRpbWVNaWxsaXMsCiAgICAgIHNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpczogcmVwb3J0LnNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpcywKICAgICAgaGFuZHNoYWtpbmdUaW1lTWlsbGlzOiByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzLAogICAgICBwcmVUYWxraW5nVGltZU1pbGxpczogcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzLAogICAgICB0YWxraW5nVGltZU1pbGxpczogcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzLAogICAgICBjbGVhbnVwVGltZU1pbGxpczogcmVwb3J0LmNsZWFudXBUaW1lTWlsbGlzLAogICAgICBpY2VDb2xsZWN0aW9uRmFpbHVyZTogcmVwb3J0LmljZUNvbGxlY3Rpb25GYWlsdXJlLAogICAgICBzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmU6IHJlcG9ydC5zaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgIGhhbmRzaGFraW5nRmFpbHVyZTogcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZSwKICAgICAgZ3VtT3RoZXJGYWlsdXJlOiByZXBvcnQuZ3VtT3RoZXJGYWlsdXJlLAogICAgICBndW1UaW1lb3V0RmFpbHVyZTogcmVwb3J0Lmd1bVRpbWVvdXRGYWlsdXJlLAogICAgICBjcmVhdGVPZmZlckZhaWx1cmU6IHJlcG9ydC5jcmVhdGVPZmZlckZhaWx1cmUsCiAgICAgIHNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlOiByZXBvcnQuc2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHVzZXJCdXN5RmFpbHVyZTogcmVwb3J0LnVzZXJCdXN5RmFpbHVyZSwKICAgICAgaW52YWxpZFJlbW90ZVNEUEZhaWx1cmU6IHJlcG9ydC5pbnZhbGlkUmVtb3RlU0RQRmFpbHVyZSwKICAgICAgbm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlOiByZXBvcnQubm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlLAogICAgICBzZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmU6IHJlcG9ydC5zZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3M6IHJlcG9ydC5zdHJlYW1TdGF0cwogICAgfTsKICAgIGNvbnRhY3Quc2VuZFNvZnRwaG9uZVJlcG9ydChjYWxsUmVwb3J0LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICBsb2dnZXIuaW5mbygic2VuZFNvZnRwaG9uZVJlcG9ydCBzdWNjZXNzIiArIEpTT04uc3RyaW5naWZ5KGNhbGxSZXBvcnQpKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKCJzZW5kU29mdHBob25lUmVwb3J0IGZhaWxlZC4iKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c0NvbGxlY3Rpb25Kb2IgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgcnRwU3RhdHNKb2IgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICBydGNTZXNzaW9uLmdldFVzZXJBdWRpb1N0YXRzKCkudGhlbihmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICB2YXIgcHJldmlvdXNVc2VyU3RhdHMgPSBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHM7CiAgICAgICAgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0gc3RhdHM7CiAgICAgICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnB1c2goZ2V0VGltZVNlcmllc1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgcHJldmlvdXNVc2VyU3RhdHMsIEFVRElPX0lOUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCB1c2VyIGF1ZGlvIHN0YXRzLiIsIGVycm9yKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKICAgICAgcnRjU2Vzc2lvbi5nZXRSZW1vdGVBdWRpb1N0YXRzKCkudGhlbihmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICB2YXIgcHJldmlvdXNSZW1vdGVTdGF0cyA9IGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzOwogICAgICAgIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0gc3RhdHM7CiAgICAgICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnB1c2goZ2V0VGltZVNlcmllc1N0YXRzKGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzLCBwcmV2aW91c1JlbW90ZVN0YXRzLCBBVURJT19PVVRQVVQpKTsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgbG9nZ2VyLmRlYnVnKCJGYWlsZWQgdG8gZ2V0IHJlbW90ZSBhdWRpbyBzdGF0cy4iLCBlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CiAgICB9LCAxMDAwKTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c1JlcG9ydGluZ0pvYiA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICByZXBvcnRTdGF0c0pvYiA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbmRTb2Z0cGhvbmVNZXRyaWNzKGNvbnRhY3QpOwogICAgfSwgc3RhdHNSZXBvcnRpbmdKb2JJbnRlcnZhbE1zKTsKICB9OwoKICB2YXIgaW5pdGlhbGl6ZVBhcmFtcyA9IGZ1bmN0aW9uICgpIHsKICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IG51bGw7CiAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IG51bGw7CiAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICAgIHJ0cFN0YXRzSm9iID0gbnVsbDsKICAgIHJlcG9ydFN0YXRzSm9iID0gbnVsbDsKICB9OwoKICB2YXIgZ2V0VGltZVNlcmllc1N0YXRzID0gZnVuY3Rpb24gKGN1cnJlbnRTdGF0cywgcHJldmlvdXNTdGF0cywgc3RyZWFtVHlwZSkgewogICAgaWYgKHByZXZpb3VzU3RhdHMgJiYgY3VycmVudFN0YXRzKSB7CiAgICAgIHZhciBwYWNrZXRzTG9zdCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCA+IHByZXZpb3VzU3RhdHMucGFja2V0c0xvc3QgPyBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNMb3N0IDogMDsKICAgICAgdmFyIHBhY2tldHNDb3VudCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgPiBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA/IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA6IDA7CiAgICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoY3VycmVudFN0YXRzLnRpbWVzdGFtcCwKICAgICAgICBwYWNrZXRzTG9zdCwKICAgICAgICBwYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKGN1cnJlbnRTdGF0cy50aW1lc3RhbXAsCiAgICAgICAgY3VycmVudFN0YXRzLnBhY2tldHNMb3N0LAogICAgICAgIGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9CiAgfTsKCiAgdmFyIHN0b3BKb2IgPSBmdW5jdGlvbiAodGFzaykgewogICAgaWYgKHRhc2sgIT09IG51bGwpIHsKICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGFzayk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9OwoKICB2YXIgc3RvcEpvYnNBbmRSZXBvcnQgPSBmdW5jdGlvbiAoY29udGFjdCwgc2Vzc2lvblJlcG9ydCkgewogICAgcnRwU3RhdHNKb2IgPSBzdG9wSm9iKHJ0cFN0YXRzSm9iKTsKICAgIHJlcG9ydFN0YXRzSm9iID0gc3RvcEpvYihyZXBvcnRTdGF0c0pvYik7CiAgICBzZW5kU29mdHBob25lUmVwb3J0KGNvbnRhY3QsIHNlc3Npb25SZXBvcnQsIGFkZFN0cmVhbVR5cGVUb1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLCBhZGRTdHJlYW1UeXBlVG9TdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICBzZW5kU29mdHBob25lTWV0cmljcyhjb250YWN0KTsKICB9OwoKICAvKioKICAqICAgQWRkaW5nIHN0cmVhbXR5cGUgcGFyYW1ldGVyIG9uIHRvcCBvZiBSVENKUyBSVFN0YXRzIG9iamVjdC4KICAqLwogIHZhciBSVFBTdHJlYW1TdGF0cyA9IGZ1bmN0aW9uICh0aW1lc3RhbXAsIHBhY2tldHNMb3N0LCBwYWNrZXRzQ291bnQsIHN0cmVhbVR5cGUsIGF1ZGlvTGV2ZWwsIGppdHRlckJ1ZmZlck1pbGxpcywgcm91bmRUcmlwVGltZU1pbGxpcykgewogICAgdGhpcy5zb2Z0cGhvbmVTdHJlYW1UeXBlID0gc3RyZWFtVHlwZTsKICAgIHRoaXMudGltZXN0YW1wID0gdGltZXN0YW1wOwogICAgdGhpcy5wYWNrZXRzTG9zdCA9IHBhY2tldHNMb3N0OwogICAgdGhpcy5wYWNrZXRzQ291bnQgPSBwYWNrZXRzQ291bnQ7CiAgICB0aGlzLmF1ZGlvTGV2ZWwgPSBhdWRpb0xldmVsOwogICAgdGhpcy5qaXR0ZXJCdWZmZXJNaWxsaXMgPSBqaXR0ZXJCdWZmZXJNaWxsaXM7CiAgICB0aGlzLnJvdW5kVHJpcFRpbWVNaWxsaXMgPSByb3VuZFRyaXBUaW1lTWlsbGlzOwogIH07CgogIHZhciBhZGRTdHJlYW1UeXBlVG9TdGF0cyA9IGZ1bmN0aW9uIChzdGF0cywgc3RyZWFtVHlwZSkgewogICAgc3RhdHMgPSBzdGF0cyB8fCB7fTsKICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoc3RhdHMudGltZXN0YW1wLCBzdGF0cy5wYWNrZXRzTG9zdCwgc3RhdHMucGFja2V0c0NvdW50LCBzdHJlYW1UeXBlLCBzdGF0cy5hdWRpb0xldmVsKTsKICB9OwoKICB2YXIgU29mdHBob25lTG9nZ2VyID0gZnVuY3Rpb24gKGxvZ2dlcikgewogICAgdGhpcy5fb3JpZ2luYWxMb2dnZXIgPSBsb2dnZXI7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl90ZWUgPSBmdW5jdGlvbiAobGV2ZWwsIG1ldGhvZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGNhbGwgdGhlIG9yaWdpbmFsIGxvZ2dlciBvYmplY3QgdG8gb3V0cHV0IHRvIGJyb3dzZXIKICAgICAgICAvL0Nvbm5lY3QgbG9nZ2VyIGZvbGxvd3MgJXMgZm9ybWF0IHRvIHByaW50IG9iamVjdHMgdG8gY29uc29sZS4KICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50c1swXSk7CiAgICAgICAgdmFyIGZvcm1hdCA9ICIiOwogICAgICAgIGFyZ3MuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgKyAiICVzIjsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHNlbGYuX29yaWdpbmFsTG9nZ2VyLCBbY29ubmVjdC5Mb2dDb21wb25lbnQuU09GVFBIT05FLCBmb3JtYXRdLmNvbmNhdChhcmdzKSk7CiAgICAgIH07CiAgICB9OwogIH07CgogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDEsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmRlYnVnKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgyLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5pbmZvKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDMsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmxvZykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUud2FybiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoNCwgdGhpcy5fb3JpZ2luYWxMb2dnZXIud2FybikoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDUsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmVycm9yKShhcmd1bWVudHMpOwogIH07CgogIGNvbm5lY3QuU29mdHBob25lTWFuYWdlciA9IFNvZnRwaG9uZU1hbmFnZXI7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA5NDQ6Ci8qKiovICgoKSA9PiB7CgovKiEgQGxpY2Vuc2Ugc3ByaW50Zi5qcyB8IENvcHlyaWdodCAoYykgMjAwNy0yMDEzIEFsZXhhbmRydSBNYXJhc3RlYW51IDxoZWxsbyBhdCBhbGV4ZWkgZG90IHJvPiB8IDMgY2xhdXNlIEJTRCBsaWNlbnNlICovCgooZnVuY3Rpb24oKSB7CiAgIHZhciBjdHggPSB0aGlzIHx8IGdsb2JhbFRoaXM7CgoJdmFyIHNwcmludGYgPSBmdW5jdGlvbigpIHsKCQlpZiAoIXNwcmludGYuY2FjaGUuaGFzT3duUHJvcGVydHkoYXJndW1lbnRzWzBdKSkgewoJCQlzcHJpbnRmLmNhY2hlW2FyZ3VtZW50c1swXV0gPSBzcHJpbnRmLnBhcnNlKGFyZ3VtZW50c1swXSk7CgkJfQoJCXJldHVybiBzcHJpbnRmLmZvcm1hdC5jYWxsKG51bGwsIHNwcmludGYuY2FjaGVbYXJndW1lbnRzWzBdXSwgYXJndW1lbnRzKTsKCX07CgoJc3ByaW50Zi5mb3JtYXQgPSBmdW5jdGlvbihwYXJzZV90cmVlLCBhcmd2KSB7CgkJdmFyIGN1cnNvciA9IDEsIHRyZWVfbGVuZ3RoID0gcGFyc2VfdHJlZS5sZW5ndGgsIG5vZGVfdHlwZSA9ICcnLCBhcmcsIG91dHB1dCA9IFtdLCBpLCBrLCBtYXRjaCwgcGFkLCBwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoOwoJCWZvciAoaSA9IDA7IGkgPCB0cmVlX2xlbmd0aDsgaSsrKSB7CgkJCW5vZGVfdHlwZSA9IGdldF90eXBlKHBhcnNlX3RyZWVbaV0pOwoJCQlpZiAobm9kZV90eXBlID09PSAnc3RyaW5nJykgewoJCQkJb3V0cHV0LnB1c2gocGFyc2VfdHJlZVtpXSk7CgkJCX0KCQkJZWxzZSBpZiAobm9kZV90eXBlID09PSAnYXJyYXknKSB7CgkJCQltYXRjaCA9IHBhcnNlX3RyZWVbaV07IC8vIGNvbnZlbmllbmNlIHB1cnBvc2VzIG9ubHkKCQkJCWlmIChtYXRjaFsyXSkgeyAvLyBrZXl3b3JkIGFyZ3VtZW50CgkJCQkJYXJnID0gYXJndltjdXJzb3JdOwoJCQkJCWZvciAoayA9IDA7IGsgPCBtYXRjaFsyXS5sZW5ndGg7IGsrKykgewoJCQkJCQlpZiAoIWFyZy5oYXNPd25Qcm9wZXJ0eShtYXRjaFsyXVtrXSkpIHsKCQkJCQkJCXRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBwcm9wZXJ0eSAiJXMiIGRvZXMgbm90IGV4aXN0JywgbWF0Y2hbMl1ba10pKTsKCQkJCQkJfQoJCQkJCQlhcmcgPSBhcmdbbWF0Y2hbMl1ba11dOwoJCQkJCX0KCQkJCX0KCQkJCWVsc2UgaWYgKG1hdGNoWzFdKSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGV4cGxpY2l0KQoJCQkJCWFyZyA9IGFyZ3ZbbWF0Y2hbMV1dOwoJCQkJfQoJCQkJZWxzZSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGltcGxpY2l0KQoJCQkJCWFyZyA9IGFyZ3ZbY3Vyc29yKytdOwoJCQkJfQoKCQkJCWlmICgvW15zXS8udGVzdChtYXRjaFs4XSkgJiYgKGdldF90eXBlKGFyZykgIT0gJ251bWJlcicpKSB7CgkJCQkJdGhyb3coc3ByaW50ZignW3NwcmludGZdIGV4cGVjdGluZyBudW1iZXIgYnV0IGZvdW5kICVzJywgZ2V0X3R5cGUoYXJnKSkpOwoJCQkJfQoJCQkJc3dpdGNoIChtYXRjaFs4XSkgewoJCQkJCWNhc2UgJ2InOiBhcmcgPSBhcmcudG9TdHJpbmcoMik7IGJyZWFrOwoJCQkJCWNhc2UgJ2MnOiBhcmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ2QnOiBhcmcgPSBwYXJzZUludChhcmcsIDEwKTsgYnJlYWs7CgkJCQkJY2FzZSAnZSc6IGFyZyA9IG1hdGNoWzddID8gYXJnLnRvRXhwb25lbnRpYWwobWF0Y2hbN10pIDogYXJnLnRvRXhwb25lbnRpYWwoKTsgYnJlYWs7CgkJCQkJY2FzZSAnZic6IGFyZyA9IG1hdGNoWzddID8gcGFyc2VGbG9hdChhcmcpLnRvRml4ZWQobWF0Y2hbN10pIDogcGFyc2VGbG9hdChhcmcpOyBicmVhazsKCQkJCQljYXNlICdvJzogYXJnID0gYXJnLnRvU3RyaW5nKDgpOyBicmVhazsKCQkJCQljYXNlICdzJzogYXJnID0gKChhcmcgPSBTdHJpbmcoYXJnKSkgJiYgbWF0Y2hbN10gPyBhcmcuc3Vic3RyaW5nKDAsIG1hdGNoWzddKSA6IGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ3UnOiBhcmcgPSBhcmcgPj4+IDA7IGJyZWFrOwoJCQkJCWNhc2UgJ3gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpOyBicmVhazsKCQkJCQljYXNlICdYJzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOyBicmVhazsKCQkJCX0KCQkJCWFyZyA9ICgvW2RlZl0vLnRlc3QobWF0Y2hbOF0pICYmIG1hdGNoWzNdICYmIGFyZyA+PSAwID8gJysnKyBhcmcgOiBhcmcpOwoJCQkJcGFkX2NoYXJhY3RlciA9IG1hdGNoWzRdID8gbWF0Y2hbNF0gPT0gJzAnID8gJzAnIDogbWF0Y2hbNF0uY2hhckF0KDEpIDogJyAnOwoJCQkJcGFkX2xlbmd0aCA9IG1hdGNoWzZdIC0gU3RyaW5nKGFyZykubGVuZ3RoOwoJCQkJcGFkID0gbWF0Y2hbNl0gPyBzdHJfcmVwZWF0KHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGgpIDogJyc7CgkJCQlvdXRwdXQucHVzaChtYXRjaFs1XSA/IGFyZyArIHBhZCA6IHBhZCArIGFyZyk7CgkJCX0KCQl9CgkJcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKCX07CgoJc3ByaW50Zi5jYWNoZSA9IHt9OwoKCXNwcmludGYucGFyc2UgPSBmdW5jdGlvbihmbXQpIHsKCQl2YXIgX2ZtdCA9IGZtdCwgbWF0Y2ggPSBbXSwgcGFyc2VfdHJlZSA9IFtdLCBhcmdfbmFtZXMgPSAwOwoJCXdoaWxlIChfZm10KSB7CgkJCWlmICgobWF0Y2ggPSAvXlteXHgyNV0rLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJcGFyc2VfdHJlZS5wdXNoKG1hdGNoWzBdKTsKCQkJfQoJCQllbHNlIGlmICgobWF0Y2ggPSAvXlx4MjV7Mn0vLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlwYXJzZV90cmVlLnB1c2goJyUnKTsKCQkJfQoJCQllbHNlIGlmICgobWF0Y2ggPSAvXlx4MjUoPzooWzEtOV1cZCopXCR8XCgoW15cKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWZvc3V4WF0pLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJaWYgKG1hdGNoWzJdKSB7CgkJCQkJYXJnX25hbWVzIHw9IDE7CgkJCQkJdmFyIGZpZWxkX2xpc3QgPSBbXSwgcmVwbGFjZW1lbnRfZmllbGQgPSBtYXRjaFsyXSwgZmllbGRfbWF0Y2ggPSBbXTsKCQkJCQlpZiAoKGZpZWxkX21hdGNoID0gL14oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQl3aGlsZSAoKHJlcGxhY2VtZW50X2ZpZWxkID0gcmVwbGFjZW1lbnRfZmllbGQuc3Vic3RyaW5nKGZpZWxkX21hdGNoWzBdLmxlbmd0aCkpICE9PSAnJykgewoJCQkJCQkJaWYgKChmaWVsZF9tYXRjaCA9IC9eXC4oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIGlmICgoZmllbGRfbWF0Y2ggPSAvXlxbKFxkKylcXS8uZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJCQl9CgkJCQkJbWF0Y2hbMl0gPSBmaWVsZF9saXN0OwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJYXJnX25hbWVzIHw9IDI7CgkJCQl9CgkJCQlpZiAoYXJnX25hbWVzID09PSAzKSB7CgkJCQkJdGhyb3coJ1tzcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQnKTsKCQkJCX0KCQkJCXBhcnNlX3RyZWUucHVzaChtYXRjaCk7CgkJCX0KCQkJZWxzZSB7CgkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJfQoJCQlfZm10ID0gX2ZtdC5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKCQl9CgkJcmV0dXJuIHBhcnNlX3RyZWU7Cgl9OwoKCXZhciB2c3ByaW50ZiA9IGZ1bmN0aW9uKGZtdCwgYXJndiwgX2FyZ3YpIHsKCQlfYXJndiA9IGFyZ3Yuc2xpY2UoMCk7CgkJX2FyZ3Yuc3BsaWNlKDAsIDAsIGZtdCk7CgkJcmV0dXJuIHNwcmludGYuYXBwbHkobnVsbCwgX2FyZ3YpOwoJfTsKCgkvKioKCSAqIGhlbHBlcnMKCSAqLwoJZnVuY3Rpb24gZ2V0X3R5cGUodmFyaWFibGUpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhcmlhYmxlKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKTsKCX0KCglmdW5jdGlvbiBzdHJfcmVwZWF0KGlucHV0LCBtdWx0aXBsaWVyKSB7CgkJZm9yICh2YXIgb3V0cHV0ID0gW107IG11bHRpcGxpZXIgPiAwOyBvdXRwdXRbLS1tdWx0aXBsaWVyXSA9IGlucHV0KSB7LyogZG8gbm90aGluZyAqL30KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfQoKCS8qKgoJICogZXhwb3J0IHRvIGVpdGhlciBicm93c2VyIG9yIG5vZGUuanMKCSAqLwoJY3R4LnNwcmludGYgPSBzcHJpbnRmOwoJY3R4LnZzcHJpbnRmID0gdnNwcmludGY7Cn0pKCk7CgoKCi8qKiovIH0pLAoKLyoqKi8gODI6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFN0cmVhbQogICAgKgogICAgKiBSZXByZXNlbnRzIGFuIG9iamVjdCBmcm9tIHdoaWNoIG1lc3NhZ2VzIGNhbiBiZSByZWFkIGFuZCB0byB3aGljaAogICAgKiBtZXNzYWdlcyBjYW4gYmUgc2VudC4KICAgICovCiAgIHZhciBTdHJlYW0gPSBmdW5jdGlvbigpIHt9OwoKICAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBzdHJlYW0uICBUaGlzIG1ldGhvZCBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzZXMuCiAgICAqLwogICBTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKgogICAgKiBQcm92aWRlIGEgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIG1lc3NhZ2VzIGFyZSByZWNlaXZlZCBmcm9tIHRoaXMgc3RyZWFtLgogICAgKiBUaGlzIG1ldGhvZCBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzZXMuCiAgICAqLwogICBTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIE51bGxTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBudWxsIHN0cmVhbSB3aGljaCBwcm92aWRlcyBubyBtZXNzYWdlIHNlbmRpbmcgb3IgcmVjZWl2aW5nIGZhY2lsaXRpZXMuCiAgICAqLwogICB2YXIgTnVsbFN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgfTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE51bGxTdHJlYW07CgogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7fTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHt9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFdpbmRvd1N0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSBmb3IgY29tbXVuaWNhdGluZyB3aXRoIGEgd2luZG93IG9iamVjdC4gIFRoZSBkb21haW4gcHJvdmlkZWQKICAgICogbXVzdCBtYXRjaCB0aGUgYWxsb3dlZCBtZXNzYWdlIGRvbWFpbnMgb2YgdGhlIGRvd25zdHJlYW0gcmVjZWl2ZXIKICAgICogb3IgbWVzc2FnZXMgd2lsbCBiZSByZWplY3RlZCwgc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9XaW5kb3cvcG9zdE1lc3NhZ2UKICAgICogZm9yIG1vcmUgaW5mby4KICAgICovCiAgIHZhciBXaW5kb3dTdHJlYW0gPSBmdW5jdGlvbih3aW4sIGRvbWFpbikgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy53aW5kb3cgPSB3aW47CiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluIHx8ICcqJzsKICAgfTsKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXaW5kb3dTdHJlYW07CgogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMud2luZG93LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRoaXMuZG9tYWluKTsKICAgfTsKCiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgV2luZG93SU9TdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gdXNlZCBieSBJRnJhbWUvcG9wdXAgd2luZG93cyB0byBjb21tdW5pY2F0ZSB3aXRoIHRoZWlyIHBhcmVudHMKICAgICogYW5kIHZpc2UgdmVyc2EuCiAgICAqCiAgICAqIFRoaXMgb2JqZWN0IGVuY2Fwc3VsYXRlcyB0aGUgZmFjdCB0aGF0IGluY29taW5nIGFuZCBvdXRnb2luZyBtZXNzYWdlcwogICAgKiBhcnJpdmUgb24gZGlmZmVyZW50IHdpbmRvd3MgYW5kIGFsbG93cyB0aGlzIHRvIGJlIG1hbmFnZWQgYXMgYSBzaW5nbGUKICAgICogU3RyZWFtIG9iamVjdC4KICAgICovCiAgIHZhciBXaW5kb3dJT1N0cmVhbSA9IGZ1bmN0aW9uKGlucHV0d2luLCBvdXRwdXR3aW4sIGRvbWFpbikgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5pbnB1dCA9IGlucHV0d2luOwogICAgICB0aGlzLm91dHB1dCA9IG91dHB1dHdpbjsKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gfHwgJyonOwogICB9OwogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXaW5kb3dJT1N0cmVhbTsKCiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLm91dHB1dC5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLmRvbWFpbik7CiAgIH07CgogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLmlucHV0LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCAobWVzc2FnZSkgPT4gewogICAgICAgICBpZiAobWVzc2FnZS5zb3VyY2UgPT09IHRoaXMub3V0cHV0KSB7CiAgICAgICAgICAgIGYobWVzc2FnZSk7CiAgICAgICAgIH0KICAgICAgfSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgUG9ydFN0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSB3cmFwcGluZyBhbiBIVE1MNSBXb3JrZXIgcG9ydC4gIFRoaXMgY291bGQgYmUgdGhlIHBvcnQKICAgICogdXNlZCB0byBjb25uZWN0IHRvIGEgV29ya2VyIG9yIG9uZSBvZiB0aGUgbXVsdGl0dWRlIG9mIHBvcnRzCiAgICAqIG1hZGUgYXZhaWxhYmxlIHRvIGEgU2hhcmVkV29ya2VyIGZvciBjb21tdW5pY2F0aW9uIGJhY2sgdG8KICAgICogaXRzIGNvbm5lY3RlZCBjbGllbnRzLgogICAgKi8KICAgdmFyIFBvcnRTdHJlYW0gPSBmdW5jdGlvbihwb3J0KSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLnBvcnQgPSBwb3J0OwogICAgICB0aGlzLmlkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICB9OwogICBQb3J0U3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUG9ydFN0cmVhbTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZShtZXNzYWdlKTsKICAgfTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5wb3J0LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmKTsKICAgfTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLmdldElkID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFN0cmVhbU11bHRpcGxleGVyIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgd3JhcHBlciBmb3IgbXVsdGlwbGV4ZWQgZG93bnN0cmVhbSBjb21tdW5pY2F0aW9uIHdpdGgKICAgICogbXVsdGlwbGUgc3RyZWFtcyBhdCBvbmNlLiAgTWFpbmx5IHVzZWZ1bCBmb3IgdGhlIFNoYXJlZFdvcmtlciB0bwogICAgKiBicm9hZGNhc3QgZXZlbnRzIHRvIG1hbnkgUG9ydFN0cmVhbSBvYmplY3RzIGF0IG9uY2UuCiAgICAqLwogICB2YXIgU3RyZWFtTXVsdGlwbGV4ZXIgPSBmdW5jdGlvbihzdHJlYW1zKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLnN0cmVhbU1hcCA9IHN0cmVhbXMgPwogICAgICAgICBjb25uZWN0LmluZGV4KHN0cmVhbXMsIGZ1bmN0aW9uKHMpIHsgcmV0dXJuIHMuZ2V0SWQoKTsgfSkgOiB7fTsKICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzID0gW107CiAgIH07CiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFN0cmVhbU11bHRpcGxleGVyOwoKICAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIGFsbCBwb3J0cyBpbiB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5nZXRTdHJlYW1zKCkuZm9yRWFjaChmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc3RyZWFtLnNlbmQobWVzc2FnZSk7CgogICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIENvdWxkbid0IHNlbmQgbWVzc2FnZSB0byBvbmUgb2YgdGhlIGRvd25zdHJlYW1zIGZvciBzb21lIHJlYXNvbi4uLgogICAgICAgICAgICAvLyBObyByZWxpYWJsZSBsb2dnaW5nIHBvc3NpYmxlIHdpdGhvdXQgZnVydGhlciBmYWlsdXJlcywKICAgICAgICAgICAgLy8gbm8gcmVjb3ZlcnksIGp1c3QgZWF0IGl0LgogICAgICAgICB9CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIFJlZ2lzdGVyIGEgbWV0aG9kIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHdoZW4gYSBtZXNzYWdlIGlzIHJlY2VpdmVkIGZyb20KICAgICogYW55IG9mIHRoZSBkb3duc3RyZWFtcy4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycy5wdXNoKGYpOwoKICAgICAgLy8gVXBkYXRlIGV4aXN0aW5nIHN0cmVhbXMgd2l0aCB0aGUgbmV3IGxpc3RlbmVyLgogICAgICB0aGlzLmdldFN0cmVhbXMoKS5mb3JFYWNoKGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICBzdHJlYW0ub25NZXNzYWdlKGYpOwogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBBZGQgYSBzdHJlYW0gdG8gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmFkZFN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHRoaXMuc3RyZWFtTWFwW3N0cmVhbS5nZXRJZCgpXSA9IHN0cmVhbTsKCiAgICAgIC8vIFVwZGF0ZSBzdHJlYW0gd2l0aCBleGlzdGluZyBsaXN0ZW5lcnMuCiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uKG1lc3NhZ2VMaXN0ZW5lcikgewogICAgICAgICBzdHJlYW0ub25NZXNzYWdlKG1lc3NhZ2VMaXN0ZW5lcik7CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIFJlbW92ZSB0aGUgZ2l2ZW4gZG93bnN0cmVhbS4gIFRoaXMgaXMgdHlwaWNhbGx5IHVzZWQgaW4gcmVzcG9uc2UKICAgICogdG8gdGhlIFNoYXJlZFdvcmtlcidzIG9uY2xvc2UgZXZlbnQsIGluZGljYXRpbmcgdGhhdCBhIGNvbnN1bWVyCiAgICAqIHRhYiBoYXMgYmVlbiBjbG9zZWQuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUucmVtb3ZlU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN0cmVhbU1hcFtzdHJlYW0uZ2V0SWQoKV07CiAgIH07CgogICAvKioKICAgICogR2V0IGEgbGlzdCBvZiBzdHJlYW1zIGluIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5nZXRTdHJlYW1zID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN0cmVhbU1hcCk7CiAgIH07CgogICAvKioKICAgICogR2V0IHRoZSBzdHJlYW0gbWF0Y2hpbmcgdGhlIGdpdmVuIHBvcnQuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuZ2V0U3RyZWFtRm9yUG9ydCA9IGZ1bmN0aW9uKHBvcnQpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldFN0cmVhbXMoKSwgZnVuY3Rpb24ocykgewogICAgICAgICByZXR1cm4gcy5wb3J0ID09PSBwb3J0OwogICAgICB9KTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBDb25kdWl0CiAgICAqCiAgICAqIEFuIG9iamVjdCB3aGljaCBicmlkZ2VzIGFuIHVwc3RyZWFtIGFuZCBhIGRvd25zdHJlYW0sIGFsbG93aW5nIG1lc3NhZ2VzCiAgICAqIHRvIGJlIHBhc3NlZCB0byBhbmQgZnJvbSBlYWNoIGFuZCBwcm92aWRpbmcgYW4gZXZlbnQgYnVzIGZvciBldmVudAogICAgKiBzdWJzY3JpcHRpb25zIHRvIGJlIG1hZGUgdXBzdHJlYW0gYW5kIGRvd25zdHJlYW0uCiAgICAqLwogICB2YXIgQ29uZHVpdCA9IGZ1bmN0aW9uKG5hbWUsIHVwc3RyZWFtLCBkb3duc3RyZWFtKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMudXBzdHJlYW0gPSB1cHN0cmVhbSB8fCBuZXcgTnVsbFN0cmVhbSgpOwogICAgICB0aGlzLmRvd25zdHJlYW0gPSBkb3duc3RyZWFtIHx8IG5ldyBOdWxsU3RyZWFtKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbUJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CiAgICAgIHRoaXMudXBzdHJlYW1CdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwoKICAgICAgdGhpcy51cHN0cmVhbS5vbk1lc3NhZ2UoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9kaXNwYXRjaEV2ZW50LCB0aGlzLnVwc3RyZWFtQnVzKSk7CiAgICAgIHRoaXMuZG93bnN0cmVhbS5vbk1lc3NhZ2UoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9kaXNwYXRjaEV2ZW50LCB0aGlzLmRvd25zdHJlYW1CdXMpKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uVXBzdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLnVwc3RyZWFtQnVzLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25BbGxVcHN0cmVhbSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy51cHN0cmVhbUJ1cy5zdWJzY3JpYmVBbGwoZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkRvd25zdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLmRvd25zdHJlYW1CdXMuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkFsbERvd25zdHJlYW0gPSBmdW5jdGlvbihmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMuZG93bnN0cmVhbUJ1cy5zdWJzY3JpYmVBbGwoZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5zZW5kVXBzdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICB0aGlzLnVwc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLnNlbmREb3duc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgdGhpcy5kb3duc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLl9kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oYnVzLCBtZXNzYWdlRXZlbnQpIHsKICAgICAgdmFyIG1lc3NhZ2UgPSBtZXNzYWdlRXZlbnQuZGF0YTsKICAgICAgaWYgKG1lc3NhZ2UuZXZlbnQpIHsKICAgICAgICAgYnVzLnRyaWdnZXIobWVzc2FnZS5ldmVudCwgbWVzc2FnZS5kYXRhKTsKICAgICAgfQogICB9OwoKICAgLyoqCiAgICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIHBhc3NlcyBldmVudHMgdXBzdHJlYW0uCiAgICAqCiAgICAqIFVzYWdlOgogICAgKiBjb25kdWl0Lm9uRG93bnN0cmVhbSgiTXlFdmVudCIsIGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUucGFzc1Vwc3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEsIGV2ZW50TmFtZSkgewogICAgICAgICBzZWxmLnVwc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgICAgfTsKICAgfTsKCiAgIC8qKgogICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBwYXNzZXMgZXZlbnRzIGRvd25zdHJlYW0uCiAgICAqCiAgICAqIFVzYWdlOgogICAgKiBjb25kdWl0Lm9uVXBzdHJlYW0oIk15RXZlbnQiLCBjb25kdWl0LnBhc3NEb3duc3RyZWFtKCkpOwogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUucGFzc0Rvd25zdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSwgZXZlbnROYW1lKSB7CiAgICAgICAgIHNlbGYuZG93bnN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgICAgIH07CiAgIH07CgogICAvKioKICAgICogU2h1dGRvd24gdGhlIGNvbmR1aXQncyBldmVudCBidXNzZXMgYW5kIHJlbW92ZSBhbGwgc3Vic2NyaXB0aW9ucy4KICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnNodXRkb3duID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMudXBzdHJlYW1CdXMudW5zdWJzY3JpYmVBbGwoKTsKICAgICAgdGhpcy5kb3duc3RyZWFtQnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgSUZyYW1lQ29uZHVpdCBleHRlbmRzIENvbmR1aXQKICAgICoKICAgICogQ3JlYXRlcyBhIGNvbmR1aXQgZm9yIHRoZSBnaXZlbiBJRnJhbWUgZWxlbWVudC4KICAgICovCiAgIHZhciBJRnJhbWVDb25kdWl0ID0gZnVuY3Rpb24obmFtZSwgd2luZG93LCBpZnJhbWUsIGRvbWFpbikgewogICAgICBDb25kdWl0LmNhbGwodGhpcywgbmFtZSwgbmV3IFdpbmRvd0lPU3RyZWFtKHdpbmRvdywgaWZyYW1lLmNvbnRlbnRXaW5kb3csIGRvbWFpbiB8fCAnKicpLCBudWxsKTsKICAgfTsKICAgSUZyYW1lQ29uZHVpdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbmR1aXQucHJvdG90eXBlKTsKICAgSUZyYW1lQ29uZHVpdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBJRnJhbWVDb25kdWl0OwoKICAgY29ubmVjdC5TdHJlYW0gPSBTdHJlYW07CiAgIGNvbm5lY3QuTnVsbFN0cmVhbSA9IE51bGxTdHJlYW07CiAgIGNvbm5lY3QuV2luZG93U3RyZWFtID0gV2luZG93U3RyZWFtOwogICBjb25uZWN0LldpbmRvd0lPU3RyZWFtID0gV2luZG93SU9TdHJlYW07CiAgIGNvbm5lY3QuUG9ydFN0cmVhbSA9IFBvcnRTdHJlYW07CiAgIGNvbm5lY3QuU3RyZWFtTXVsdGlwbGV4ZXIgPSBTdHJlYW1NdWx0aXBsZXhlcjsKICAgY29ubmVjdC5Db25kdWl0ID0gQ29uZHVpdDsKICAgY29ubmVjdC5JRnJhbWVDb25kdWl0ID0gSUZyYW1lQ29uZHVpdDsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDgzMzoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIEdyYXBoTGluayA8PGFic3RyYWN0IGNsYXNzPj4KICAgICoKICAgICogUmVwcmVzZW50cyB0aGUgYXNzb2NpYXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgR3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIHRoaXMuZnJvbVN0YXRlID0gZnJvbVN0YXRlOwogICAgICB0aGlzLnRvU3RhdGUgPSB0b1N0YXRlOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHRocm93IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRGcm9tU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZnJvbVN0YXRlOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRUb1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnRvU3RhdGU7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIERpcmVjdEdyYXBoTGluayA8PGNvbmNyZXRlIGNsYXNzPj4gZXh0ZW5kcyBHcmFwaExpbmsKICAgICoKICAgICogUmVwcmVzZW50cyB0aGUgYnktdmFsdWUgcmVwcmVzZW50YXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhCiAgICAqIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgRGlyZWN0R3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlLCBhc3NvY2lhdGlvbnMpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGFzc29jaWF0aW9ucywgJ2Fzc29jaWF0aW9ucycpOwogICAgICBHcmFwaExpbmsuY2FsbCh0aGlzLCBmcm9tU3RhdGUsIHRvU3RhdGUpOwogICAgICB0aGlzLmFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9uczsKICAgfTsKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3JhcGhMaW5rLnByb3RvdHlwZSk7CiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEaXJlY3RHcmFwaExpbms7CgogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuYXNzb2NpYXRpb25zOwogICB9OwoKICAgLyoqCiAgICAqIEZ1bmN0aW9uYWxHcmFwaExpbmsgPDxjb25jcmV0ZSBjbGFzcz4+IGV4dGVuZHMgR3JhcGhMaW5rCiAgICAqCiAgICAqIFJlcHJlc2VudHMgYSBmdW5jdGlvbmFsIGFzc29jaWF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYQogICAgKiBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIEZ1bmN0aW9uYWxHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUsIGNsb3N1cmUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNsb3N1cmUsICdjbG9zdXJlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2xvc3VyZSksICdjbG9zdXJlIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBHcmFwaExpbmsuY2FsbCh0aGlzLCBmcm9tU3RhdGUsIHRvU3RhdGUpOwogICAgICB0aGlzLmNsb3N1cmUgPSBjbG9zdXJlOwogICB9OwogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3JhcGhMaW5rLnByb3RvdHlwZSk7CiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRnVuY3Rpb25hbEdyYXBoTGluazsKCiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xvc3VyZShjb250ZXh0LCB0aGlzLmdldEZyb21TdGF0ZSgpLCB0aGlzLmdldFRvU3RhdGUoKSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIEV2ZW50R3JhcGggPDxjbGFzcz4+CiAgICAqCiAgICAqIEJ1aWxkcyBhIG1hcCBvZiBhc3NvY2lhdGlvbnMgZnJvbSBvbmUgc3RhdGUgdG8gYW5vdGhlciBpbiBjb250ZXh0IG9mIGEKICAgICogcGFydGljdWxhciBvYmplY3QuICBUaGUgYXNzb2NpYXRpb25zIGNhbiBiZSBkaXJlY3QgKG9uZSBvciBtb3JlIHZhbHVlcykKICAgICogb3IgZnVuY3Rpb25hbCAoYSBtZXRob2QgcmV0dXJuaW5nIG9uZSBvciBtb3JlIHZhbHVlcyksIGFuZCBhcmUgdXNlZCB0bwogICAgKiBwcm92aWRlIGFkZGl0aW9uYWwgY29udGV4dHVhbCBldmVudCBob29rcyBmb3IgdGhlIFVJIHRvIGNvbnN1bWUuCiAgICAqLwogICB2YXIgRXZlbnRHcmFwaCA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmZyb21NYXAgPSB7fTsKICAgfTsKICAgRXZlbnRHcmFwaC5BTlkgPSAiPDxhbnk+PiI7CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5hc3NvYyA9IGZ1bmN0aW9uKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgaWYgKCEgZnJvbVN0YXRlT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZnJvbVN0YXRlT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoISB0b1N0YXRlT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigidG9TdGF0ZU9iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKCEgYXNzb2NPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhc3NvY09iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKGZyb21TdGF0ZU9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgIGZyb21TdGF0ZU9iai5mb3JFYWNoKGZ1bmN0aW9uKGZyb21TdGF0ZSkgewogICAgICAgICAgICBzZWxmLmFzc29jKGZyb21TdGF0ZSwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopOwogICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0b1N0YXRlT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgdG9TdGF0ZU9iai5mb3JFYWNoKGZ1bmN0aW9uKHRvU3RhdGUpIHsKICAgICAgICAgICAgc2VsZi5hc3NvYyhmcm9tU3RhdGVPYmosIHRvU3RhdGUsIGFzc29jT2JqKTsKICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgIGlmICh0eXBlb2YgYXNzb2NPYmogPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IEZ1bmN0aW9uYWxHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikpOwogICAgICAgICB9IGVsc2UgaWYgKGFzc29jT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IERpcmVjdEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSk7CiAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBEaXJlY3RHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBbYXNzb2NPYmpdKSk7CiAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICB2YXIgYXNzb2NpYXRpb25zID0gW107CgogICAgICB2YXIgdG9NYXBGcm9tQW55ID0gdGhpcy5mcm9tTWFwW0V2ZW50R3JhcGguQU5ZXSB8fCB7fTsKICAgICAgdmFyIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Zyb21TdGF0ZV0gfHwge307CgogICAgICBhc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnMuY29uY2F0KHRoaXMuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAoCiAgICAgICAgICAgICAgIHRvTWFwRnJvbUFueSwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSk7CiAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQodGhpcy5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCgKICAgICAgICAgICAgICAgdG9NYXAsIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkpOwoKICAgICAgcmV0dXJuIGFzc29jaWF0aW9uczsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLl9hZGRBc3NvY2lhdGlvbiA9IGZ1bmN0aW9uKGFzc29jKSB7CiAgICAgIHZhciB0b01hcCA9IHRoaXMuZnJvbU1hcFthc3NvYy5nZXRGcm9tU3RhdGUoKV07CgogICAgICBpZiAoISB0b01hcCkgewogICAgICAgICB0b01hcCA9IHRoaXMuZnJvbU1hcFthc3NvYy5nZXRGcm9tU3RhdGUoKV0gPSB7fTsKICAgICAgfQoKICAgICAgdmFyIGFzc29jTGlzdCA9IHRvTWFwW2Fzc29jLmdldFRvU3RhdGUoKV07CgogICAgICBpZiAoISBhc3NvY0xpc3QpIHsKICAgICAgICAgYXNzb2NMaXN0ID0gdG9NYXBbYXNzb2MuZ2V0VG9TdGF0ZSgpXSA9IFtdOwogICAgICB9CgogICAgICBhc3NvY0xpc3QucHVzaChhc3NvYyk7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCA9IGZ1bmN0aW9uKG1hcCwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIHZhciBhc3NvY0xpc3QgPSAobWFwW0V2ZW50R3JhcGguQU5ZXSB8fCBbXSkuY29uY2F0KG1hcFt0b1N0YXRlXSB8fCBbXSk7CiAgICAgIHJldHVybiBhc3NvY0xpc3QucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGFzc29jKSB7CiAgICAgICAgIHJldHVybiBwcmV2LmNvbmNhdChhc3NvYy5nZXRBc3NvY2lhdGlvbnMoY29udGV4dCkpOwogICAgICB9LCBbXSk7CiAgIH07CgogICBjb25uZWN0LkV2ZW50R3JhcGggPSBFdmVudEdyYXBoOwoKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDg5MToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIHZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogIHZhciBPTkVfREFZX01JTExJUyA9IDI0ICogNjAgKiA2MCAqIDEwMDA7CiAgdmFyIERFRkFVTFRfUE9QVVBfSEVJR0hUID0gNTc4OwogIHZhciBERUZBVUxUX1BPUFVQX1dJRFRIID0gNDMzOwogIHZhciBDT1BZQUJMRV9FVkVOVF9GSUVMRFMgPSBbImJ1YmJsZXMiLCAiY2FuY2VsQnViYmxlIiwgImNhbmNlbGFibGUiLCAiY29tcG9zZWQiLCAiZGF0YSIsICJkZWZhdWx0UHJldmVudGVkIiwgImV2ZW50UGhhc2UiLCAiaXNUcnVzdGVkIiwgImxhc3RFdmVudElkIiwgIm9yaWdpbiIsICJyZXR1cm5WYWx1ZSIsICJ0aW1lU3RhbXAiLCAidHlwZSJdOwoKICAvKioKICAgKiBVbnBvbGx1dGUgc3ByaW50ZiBmdW5jdGlvbnMgZnJvbSB0aGUgZ2xvYmFsIG5hbWVzcGFjZS4KICAgKi8KICBjb25uZWN0LnNwcmludGYgPSBnbG9iYWwuc3ByaW50ZjsKICBjb25uZWN0LnZzcHJpbnRmID0gZ2xvYmFsLnZzcHJpbnRmOwogIGRlbGV0ZSBnbG9iYWwuc3ByaW50ZjsKICBkZWxldGUgZ2xvYmFsLnZzcHJpbnRmOwoKICBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTID0gewogICAgU1VDQ0VTUzogMjAwLAogICAgVE9PX01BTllfUkVRVUVTVFM6IDQyOSwKICAgIElOVEVSTkFMX1NFUlZFUl9FUlJPUjogNTAwCiAgfTsKCiAgY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMgPSB7CiAgICBDSEFUX1RPS0VOOiAiY2hhdF90b2tlbiIsCiAgICBXRUJfU09DS0VUOiAid2ViX3NvY2tldCIKICB9OwoKICAvKioKICAgKiBCaW5kcyB0aGUgZ2l2ZW4gaW5zdGFuY2Ugb2JqZWN0IGFzIHRoZSBjb250ZXh0IGZvcgogICAqIHRoZSBtZXRob2QgcHJvdmlkZWQuCiAgICoKICAgKiBAcGFyYW0gc2NvcGUgVGhlIGluc3RhbmNlIG9iamVjdCB0byBiZSBzZXQgYXMgdGhlIHNjb3BlCiAgICogICAgb2YgdGhlIGZ1bmN0aW9uLgogICAqIEBwYXJhbSBtZXRob2QgVGhlIG1ldGhvZCB0byBiZSBlbmNhcHN1bGF0ZWQuCiAgICoKICAgKiBBbGwgb3RoZXIgYXJndW1lbnRzLCBpZiBhbnksIGFyZSBib3VuZCB0byB0aGUgbWV0aG9kCiAgICogaW52b2NhdGlvbiBpbnNpZGUgdGhlIGNsb3N1cmUuCiAgICoKICAgKiBAcmV0dXJuIEEgY2xvc3VyZSBlbmNhcHN1bGF0aW5nIHRoZSBpbnZvY2F0aW9uIG9mIHRoZQogICAqICAgIG1ldGhvZCBwcm92aWRlZCBpbiBjb250ZXh0IG9mIHRoZSBnaXZlbiBpbnN0YW5jZS4KICAgKi8KICBjb25uZWN0LmhpdGNoID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIHNjb3BlID0gYXJncy5zaGlmdCgpOwogICAgdmFyIG1ldGhvZCA9IGFyZ3Muc2hpZnQoKTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoc2NvcGUsICdzY29wZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihtZXRob2QpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjbG9zdXJlQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBtZXRob2QuYXBwbHkoc2NvcGUsIGFyZ3MuY29uY2F0KGNsb3N1cmVBcmdzKSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYSBjYWxsYWJsZSBmdW5jdGlvbiB0eXBlLgogICAqIEJvcnJvd2VkIGZyb20gVW5kZXJzY29yZS5qcy4KICAgKi8KICBjb25uZWN0LmlzRnVuY3Rpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5jb25zdHJ1Y3RvciAmJiBvYmouY2FsbCAmJiBvYmouYXBwbHkpOwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYW4gYXJyYXkuCiAgICovCiAgY29ubmVjdC5pc0FycmF5ID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5cyBmcm9tIGEgSmF2YXNjcmlwdCBvYmplY3QgdXNlZAogICAqIGFzIGEgaGFzaCBtYXAuCiAgICovCiAgY29ubmVjdC5rZXlzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIGtleXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAga2V5cy5wdXNoKGspOwogICAgfQoKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2YgdmFsdWVzIGZyb20gYSBKYXZhc2NyaXB0IG9iamVjdCB1c2VkCiAgICogYXMgYSBoYXNoIG1hcC4KICAgKi8KICBjb25uZWN0LnZhbHVlcyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciB2YWx1ZXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAgdmFsdWVzLnB1c2gobWFwW2tdKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5L3ZhbHVlIHBhaXJzIGZyb20gdGhlIGdpdmVuIG1hcC4KICAgKi8KICBjb25uZWN0LmVudHJpZXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIgZW50cmllcyA9IFtdOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIGVudHJpZXMucHVzaCh7IGtleTogaywgdmFsdWU6IG1hcFtrXSB9KTsKICAgIH0KCiAgICByZXR1cm4gZW50cmllczsKICB9OwoKICAvKioKICAgKiBNZXJnZSB0d28gb3IgbW9yZSBtYXBzIHRvZ2V0aGVyIGludG8gYSBuZXcgbWFwLAogICAqIG9yIHNpbXBseSBjb3B5IGEgc2luZ2xlIG1hcC4KICAgKi8KICBjb25uZWN0Lm1lcmdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ01hcHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIHJlc3VsdE1hcCA9IHt9OwoKICAgIGFyZ01hcHMuZm9yRWFjaChmdW5jdGlvbiAobWFwKSB7CiAgICAgIGNvbm5lY3QuZW50cmllcyhtYXApLmZvckVhY2goZnVuY3Rpb24gKGt2KSB7CiAgICAgICAgcmVzdWx0TWFwW2t2LmtleV0gPSBrdi52YWx1ZTsKICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4gcmVzdWx0TWFwOwogIH07CgogIGNvbm5lY3Qubm93ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CgogIGNvbm5lY3QuZmluZCA9IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IGFycmF5Lmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbeF0pKSB7CiAgICAgICAgcmV0dXJuIGFycmF5W3hdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgY29ubmVjdC5jb250YWlucyA9IGZ1bmN0aW9uIChvYmosIHZhbHVlKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChvYmosIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKHZhbHVlIGluIG9iaik7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb250YWluc1ZhbHVlID0gZnVuY3Rpb24gKG9iaiwgdmFsdWUpIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKG9iaiwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQoY29ubmVjdC52YWx1ZXMob2JqKSwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwogICAgfQogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGEgcmFuZG9tIElEIGNvbnNpc3Rpbmcgb2YgdGhlIGN1cnJlbnQgdGltZXN0YW1wCiAgICogYW5kIGEgcmFuZG9tIGJhc2UtMzYgbnVtYmVyIGJhc2VkIG9uIE1hdGgucmFuZG9tKCkuCiAgICovCiAgY29ubmVjdC5yYW5kb21JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLSVzIiwgY29ubmVjdC5ub3coKSwgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMikpOwogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGFuIGVudW0gZnJvbSB0aGUgZ2l2ZW4gbGlzdCBvZiBsb3dlci1jYXNlIGVudW0gdmFsdWVzLAogICAqIHdoZXJlIHRoZSBlbnVtIGtleXMgd2lsbCBiZSB1cHBlciBjYXNlLgogICAqCiAgICogQ29udmVyc2lvbiBmcm9tIHBhc2NhbCBjYXNlIGJhc2VkIG9uIGNvZGUgZnJvbSBoZXJlOgogICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzA1MjEyMjQKICAgKi8KICBjb25uZWN0Lm1ha2VFbnVtID0gZnVuY3Rpb24gKHZhbHVlcykgewogICAgdmFyIGVudW1PYmogPSB7fTsKCiAgICB2YWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGtleSA9IHZhbHVlLnJlcGxhY2UoL1wuPyhbYS16XSspXz8vZywgZnVuY3Rpb24gKHgsIHkpIHsgcmV0dXJuIHkudG9VcHBlckNhc2UoKSArICJfIjsgfSkKICAgICAgICAucmVwbGFjZSgvXyQvLCAiIik7CgogICAgICBlbnVtT2JqW2tleV0gPSB2YWx1ZTsKICAgIH0pOwoKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtID0gZnVuY3Rpb24gKHByZWZpeCwgdmFsdWVzKSB7CiAgICB2YXIgZW51bU9iaiA9IGNvbm5lY3QubWFrZUVudW0odmFsdWVzKTsKICAgIGNvbm5lY3Qua2V5cyhlbnVtT2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZW51bU9ialtrZXldID0gY29ubmVjdC5zcHJpbnRmKCIlczo6JXMiLCBwcmVmaXgsIGVudW1PYmpba2V5XSk7CiAgICB9KTsKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIGNvbm5lY3QubWFrZUdlbmVyaWNOYW1lc3BhY2VkRW51bSA9IGZ1bmN0aW9uIChwcmVmaXgsIHZhbHVlcywgZGVsaW1pdGVyKSB7CiAgICB2YXIgZW51bU9iaiA9IGNvbm5lY3QubWFrZUVudW0odmFsdWVzKTsKICAgIGNvbm5lY3Qua2V5cyhlbnVtT2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZW51bU9ialtrZXldID0gY29ubmVjdC5zcHJpbnRmKCIlcyIrZGVsaW1pdGVyKyIlcyIsIHByZWZpeCwgZW51bU9ialtrZXldKTsKICAgIH0pOwogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgLyoqCiAgKiBNZXRob2RzIHRvIGRldGVybWluZSBicm93c2VyIHR5cGUgYW5kIHZlcnNpb25zLCB1c2VkIGZvciBzb2Z0cGhvbmUgaW5pdGlhbGl6YXRpb24uCiAgKi8KICBjb25uZWN0LmlzQ2hyb21lQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzT3BlcmFCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJPcGVyYSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNocm9tZVZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSArIDcpOwogICAgaWYgKGNocm9tZVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoY2hyb21lVmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5nZXRGaXJlZm94QnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZmlyZWZveFZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgKyA4KTsKICAgIGlmIChmaXJlZm94VmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChmaXJlZm94VmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5pc1ZhbGlkTG9jYWxlID0gZnVuY3Rpb24gKGxvY2FsZSkgewogICAgdmFyIGxhbmd1YWdlcyA9IFsKICAgICAgewogICAgICAgIGlkOiAnZW5fVVMnLAogICAgICAgIGxhYmVsOiAnRW5nbGlzaCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZGVfREUnLAogICAgICAgIGxhYmVsOiAnRGV1dHNjaCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZXNfRVMnLAogICAgICAgIGxhYmVsOiAnRXNwYcOxb2wnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2ZyX0ZSJywKICAgICAgICBsYWJlbDogJ0ZyYW7Dp2FpcycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnamFfSlAnLAogICAgICAgIGxhYmVsOiAn5pel5pys6KqeJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdpdF9JVCcsCiAgICAgICAgbGFiZWw6ICdJdGFsaWFubycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAna29fS1InLAogICAgICAgIGxhYmVsOiAn7ZWc6rWt7Ja0JwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdwdF9CUicsCiAgICAgICAgbGFiZWw6ICdQb3J0dWd1w6pzJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICd6aF9DTicsCiAgICAgICAgbGFiZWw6ICfkuK3mloco566A5L2TKScKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnemhfVFcnLAogICAgICAgIGxhYmVsOiAn5Lit5paHKOe5gemrlCknCiAgICAgIH0KICAgIF07CiAgICByZXR1cm4gbGFuZ3VhZ2VzLm1hcChmdW5jdGlvbihsYW5ndWFnZSl7IHJldHVybiBsYW5ndWFnZS5pZH0pLmluY2x1ZGVzKGxvY2FsZSk7CiAgfQoKICBjb25uZWN0LmdldE9wZXJhQnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdmVyc2lvbk9mZnNldCA9IHVzZXJBZ2VudC5pbmRleE9mKCJPcGVyYSIpOwogICAgdmFyIG9wZXJhVmVyc2lvbiA9ICh1c2VyQWdlbnQuaW5kZXhPZigiVmVyc2lvbiIpICE9PSAtMSkgPyB1c2VyQWdlbnQuc3Vic3RyaW5nKHZlcnNpb25PZmZzZXQgKyA4KSA6IHVzZXJBZ2VudC5zdWJzdHJpbmcodmVyc2lvbk9mZnNldCArIDYpOwogICAgaWYgKG9wZXJhVmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChvcGVyYVZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIC8qKgogICAqIFJldHVybiBhIG1hcCBvZiBpdGVtcyBpbiB0aGUgZ2l2ZW4gbGlzdCBpbmRleGVkIGJ5CiAgICoga2V5cyBkZXRlcm1pbmVkIGJ5IHRoZSBjbG9zdXJlIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIGl0ZXJhYmxlIEEgbGlzdC1saWtlIG9iamVjdC4KICAgKiBAcGFyYW0gY2xvc3VyZSBBIGNsb3N1cmUgdG8gZGV0ZXJtaW5lIHRoZSBpbmRleCBmb3IgdGhlCiAgICogICAgaXRlbXMgaW4gdGhlIGl0ZXJhYmxlLgogICAqIEByZXR1cm4gQSBtYXAgZnJvbSBpbmRleCB0byBpdGVtIGZvciBlYWNoIGl0ZW0gaW4gdGhlIGl0ZXJhYmxlLgogICAqLwogIGNvbm5lY3QuaW5kZXggPSBmdW5jdGlvbiAoaXRlcmFibGUsIGNsb3N1cmUpIHsKICAgIHZhciBtYXAgPSB7fTsKCiAgICBpdGVyYWJsZS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIG1hcFtjbG9zdXJlKGl0ZW0pXSA9IGl0ZW07CiAgICB9KTsKCiAgICByZXR1cm4gbWFwOwogIH07CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBnaXZlbiBhcnJheSBpbnRvIGEgbWFwIGFzIGEgc2V0LAogICAqIHdoZXJlIGVsZW1lbnRzIGluIHRoZSBhcnJheSBhcmUgbWFwcGVkIHRvIDEuCiAgICovCiAgY29ubmVjdC5zZXQgPSBmdW5jdGlvbiAoYXJyYXlJbikgewogICAgdmFyIHNldE1hcCA9IHt9OwoKICAgIGFycmF5SW4uZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHNldE1hcFtrZXldID0gMTsKICAgIH0pOwoKICAgIHJldHVybiBzZXRNYXA7CiAgfTsKCiAgLyoqCiAgICogUmV0dXJucyBhIG1hcCBmb3IgZWFjaCBrZXkgaW4gbWFwQiB3aGljaAogICAqIGlzIE5PVCBpbiBtYXBBLgogICAqLwogIGNvbm5lY3QucmVsYXRpdmVDb21wbGVtZW50ID0gZnVuY3Rpb24gKG1hcEEsIG1hcEIpIHsKICAgIHZhciBjb21wTWFwID0ge307CgogICAgY29ubmVjdC5rZXlzKG1hcEIpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBpZiAoIShrZXkgaW4gbWFwQSkpIHsKICAgICAgICBjb21wTWFwW2tleV0gPSBtYXBCW2tleV07CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBjb21wTWFwOwogIH07CgogIC8qKgogICAqIEFzc2VydHMgdGhhdCBhIHByZW1pc2UgaXMgdHJ1ZS4KICAgKi8KICBjb25uZWN0LmFzc2VydFRydWUgPSBmdW5jdGlvbiAocHJlbWlzZSwgbWVzc2FnZSkgewogICAgaWYgKCFwcmVtaXNlKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQXNzZXJ0cyB0aGF0IGEgdmFsdWUgaXMgbm90IG51bGwgb3IgdW5kZWZpbmVkLgogICAqLwogIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCA9IGZ1bmN0aW9uICh2YWx1ZSwgbmFtZSkgewogICAgY29ubmVjdC5hc3NlcnRUcnVlKHZhbHVlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9PSB1bmRlZmluZWQsCiAgICAgIGNvbm5lY3Quc3ByaW50ZigiJXMgbXVzdCBiZSBwcm92aWRlZCIsIG5hbWUgfHwgJ0EgdmFsdWUnKSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgY29ubmVjdC5kZWVwY29weSA9IGZ1bmN0aW9uIChzcmMpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHNyYykpOwogIH07CgogIGNvbm5lY3QuZGVlcGNvcHlDcm9zc09yaWdpbkV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIGNvbnN0IG9iaiA9IHt9OwogICAgY29uc3QgbGlzdE9mQWNjZXB0YWJsZUtleXMgPSBDT1BZQUJMRV9FVkVOVF9GSUVMRFM7CiAgICBsaXN0T2ZBY2NlcHRhYmxlS2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBvYmpba2V5XSA9IGV2ZW50W2tleV07CiAgICAgIH0KICAgICAgY2F0Y2goZSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZGVlcGNvcHlDcm9zc09yaWdpbkV2ZW50IGZhaWxlZCBvbiBrZXk6ICIsIGtleSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gY29ubmVjdC5kZWVwY29weShvYmopOwogIH0KCiAgLyoqCiAgICogR2V0IHRoZSBjdXJyZW50IGJhc2UgdXJsIG9mIHRoZSBvcGVuIHBhZ2UsIGUuZy4gaWYgdGhlIHBhZ2UgaXMKICAgKiBodHRwczovL2V4YW1wbGUuY29tOjk0OTQvb3JhbmdlcywgdGhpcyB3aWxsIGJlICJodHRwczovL2V4YW1wbGUuY29tOjk0OTQiLgogICAqLwogIGNvbm5lY3QuZ2V0QmFzZVVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2NhdGlvbiA9IGdsb2JhbC5sb2NhdGlvbjsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLy8lczolcyIsIGxvY2F0aW9uLnByb3RvY29sLCBsb2NhdGlvbi5ob3N0bmFtZSwgbG9jYXRpb24ucG9ydCk7CiAgfTsKCiAgY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2wgPSBmdW5jdGlvbih1cmwpIHsKICAgIHZhciBwcm90b2NvbCA9IGdsb2JhbC5sb2NhdGlvbi5wcm90b2NvbDsKICAgIGlmICh1cmwuc3Vic3RyKDAsIHByb3RvY29sLmxlbmd0aCkgIT09IHByb3RvY29sKSB7CiAgICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLy8lcyIsIHByb3RvY29sLCB1cmwpOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgY3VycmVudCB3aW5kb3cgaXMgaW4gYW4gaWZyYW1lLgogICAqIENvdXJ0ZXN5OiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMyNjA2OS8KICAgKi8KICBjb25uZWN0LmlzRnJhbWVkID0gZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIHdpbmRvdy5zZWxmICE9PSB3aW5kb3cudG9wOwogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICBjb25uZWN0Lmhhc090aGVyQ29ubmVjdGVkQ0NQcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA+IDE7CiAgfQoKICBjb25uZWN0LmZldGNoID0gZnVuY3Rpb24gKGVuZHBvaW50LCBvcHRpb25zLCBtaWxsaUludGVydmFsLCBtYXhSZXRyeSkgewogICAgbWF4UmV0cnkgPSBtYXhSZXRyeSB8fCA1OwogICAgbWlsbGlJbnRlcnZhbCA9IG1pbGxpSW50ZXJ2YWwgfHwgMTAwMDsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZnVuY3Rpb24gZmV0Y2hEYXRhKG1heFJldHJ5KSB7CiAgICAgICAgZmV0Y2goZW5kcG9pbnQsIG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuU1VDQ0VTUykgewogICAgICAgICAgICByZXMuanNvbigpLnRoZW4oanNvbiA9PiByZXNvbHZlKGpzb24pKS5jYXRjaCgoKSA9PiByZXNvbHZlKHt9KSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG1heFJldHJ5ICE9PSAxICYmIChyZXMuc3RhdHVzID49IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SIHx8IHJlcy5zdGF0dXMgPT09IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuVE9PX01BTllfUkVRVUVTVFMpKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGZldGNoRGF0YSgtLW1heFJldHJ5KTsKICAgICAgICAgICAgfSwgbWlsbGlJbnRlcnZhbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWplY3QocmVzKTsKICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGZldGNoRGF0YShtYXhSZXRyeSk7CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBDYWxsaW5nIGEgZnVuY3Rpb24gd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmIHdpdGggZnVsbCBqaXR0ZXIgcmV0cnkgc3RyYXRlZ3kKICAgKiBJdCB3aWxsIHJldHJ5IGNhbGxpbmcgdGhlIGZ1bmN0aW9uIGZvciBtYXhpbXVtIG1heFJldHJ5IHRpbWVzIGlmIGl0IGZhaWxzLgogICAqIFN1Y2Nlc3MgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIGZ1bmN0aW9uIHN1Y2NlZWRlZC4KICAgKiBGYWlsdXJlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIG9ubHkgaWYgdGhlIGxhc3QgdHJ5IGZhaWxlZC4KICAgKi8KICBjb25uZWN0LmJhY2tvZmYgPSBmdW5jdGlvbiAoZnVuYywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnksIGNhbGxiYWNrcykgewogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmdW5jKSwgImZ1bmMgbXVzdCBiZSBhIEZ1bmN0aW9uIik7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmF0aW8gPSAyOwoKICAgIGZ1bmMoewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLnN1Y2Nlc3MpIHsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGlmIChtYXhSZXRyeSA+IDApIHsKICAgICAgICAgIHZhciBpbnRlcnZhbCA9IG1pbGxpSW50ZXJ2YWwgKiAyICogTWF0aC5yYW5kb20oKTsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5iYWNrb2ZmKGZ1bmMsIGludGVydmFsICogcmF0aW8sIC0tbWF4UmV0cnksIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LCBpbnRlcnZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyLCBkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaE1ldHJpYyA9IGZ1bmN0aW9uIChtZXRyaWNEYXRhKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5DTElFTlRfTUVUUklDLAogICAgICBkYXRhOiBtZXRyaWNEYXRhCiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVTdGF0cyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5TT0ZUUEhPTkVfU1RBVFMsCiAgICAgIGRhdGE6IHN0YXRzCiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLlNPRlRQSE9ORV9SRVBPUlQsCiAgICAgIGRhdGE6IHJlcG9ydAogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5DTElDS19TVFJFQU1fREFUQSwKICAgICAgZGF0YTogcmVwb3J0CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hDbGllbnRTaWRlTG9ncyA9IGZ1bmN0aW9uKGxvZ3MpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkNMSUVOVF9TSURFX0xPR1MsIGxvZ3MpOwogIH07CgogIGNvbm5lY3QuYWRkTmFtZXNwYWNlVG9Mb2dzID0gZnVuY3Rpb24obmFtZXNwYWNlKSB7CiAgICBjb25zdCBtZXRob2RzID0gWydsb2cnLCAnZXJyb3InLCAnd2FybicsICdpbmZvJywgJ2RlYnVnJ107CgogICAgbWV0aG9kcy5mb3JFYWNoKChtZXRob2QpID0+IHsKICAgICAgY29uc3QgY29uc29sZU1ldGhvZCA9IHdpbmRvdy5jb25zb2xlW21ldGhvZF07CiAgICAgIHdpbmRvdy5jb25zb2xlW21ldGhvZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29uc3QgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKICAgICAgICBhcmdzLnVuc2hpZnQoYFske25hbWVzcGFjZX1dYCk7CiAgICAgICAgY29uc29sZU1ldGhvZC5hcHBseSh3aW5kb3cuY29uc29sZSwgYXJncyk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBBIHdyYXBwZXIgYXJvdW5kIFdpbmRvdy5vcGVuKCkgZm9yIG1hbmFnaW5nIHNpbmdsZSBpbnN0YW5jZSBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7IH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24gKHVybCwgbmFtZSwgb3B0aW9ucykgewogICAgdmFyIHRoZW4gPSB0aGlzLl9nZXRMYXN0T3BlbmVkVGltZXN0YW1wKG5hbWUpOwogICAgdmFyIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHdpbiA9IG51bGw7CiAgICBpZiAobm93IC0gdGhlbiA+IE9ORV9EQVlfTUlMTElTKSB7CiAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgLy8gZGVmYXVsdCB2YWx1ZXMgYXJlIGNob3NlbiB0byBwcm92aWRlIGEgbWluaW11bSBoZWlnaHQgd2l0aG91dCBzY3JvbGxpbmcKICAgICAgICAvLyBhbmQgYSB1bmlmb3JtIG1hcmdpbiBiYXNlZCBvbiB0aGUgY3NzIG9mIHRoZSBjY3AgbG9naW4gcGFnZQogICAgICAgIHZhciBoZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCBERUZBVUxUX1BPUFVQX0hFSUdIVDsKICAgICAgICB2YXIgd2lkdGggPSBvcHRpb25zLndpZHRoIHx8IERFRkFVTFRfUE9QVVBfV0lEVEg7CiAgICAgICAgdmFyIHRvcCA9IG9wdGlvbnMudG9wIHx8IDA7CiAgICAgICAgdmFyIGxlZnQgPSBvcHRpb25zLmxlZnQgfHwgMDsKICAgICAgICB3aW4gPSB3aW5kb3cub3BlbignJywgbmFtZSwgIndpZHRoPSIrd2lkdGgrIiwgaGVpZ2h0PSIraGVpZ2h0KyIsIHRvcD0iK3RvcCsiLCBsZWZ0PSIrbGVmdCk7CiAgICAgICAgaWYgKHdpbi5sb2NhdGlvbiAhPT0gdXJsKSB7CiAgICAgICAgICB3aW4gPSB3aW5kb3cub3Blbih1cmwsIG5hbWUsICJ3aWR0aD0iK3dpZHRoKyIsIGhlaWdodD0iK2hlaWdodCsiLCB0b3A9Iit0b3ArIiwgbGVmdD0iK2xlZnQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB3aW4gPSB3aW5kb3cub3BlbignJywgbmFtZSk7CiAgICAgICAgaWYgKHdpbi5sb2NhdGlvbiAhPT0gdXJsKSB7CiAgICAgICAgICB3aW4gPSB3aW5kb3cub3Blbih1cmwsIG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9zZXRMYXN0T3BlbmVkVGltZXN0YW1wKG5hbWUsIG5vdyk7CiAgICB9CiAgICByZXR1cm4gd2luOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgZ2xvYmFsLmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLl9nZXRMYXN0T3BlbmVkVGltZXN0YW1wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICB2YXIgdmFsdWUgPSBnbG9iYWwubG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTsKCiAgICBpZiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMCk7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLl9zZXRMYXN0T3BlbmVkVGltZXN0YW1wID0gZnVuY3Rpb24gKG5hbWUsIHRzKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgZ2xvYmFsLmxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgJycgKyB0cyk7CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLl9nZXRMb2NhbFN0b3JhZ2VLZXkgPSBmdW5jdGlvbiAobmFtZSkgewogICAgcmV0dXJuICJjb25uZWN0UG9wdXBNYW5hZ2VyOjoiICsgbmFtZTsKICB9OwoKICAvKioKICAgKiBBbiBlbnVtZXJhdGlvbiBvZiB0aGUgSFRNTDUgbm90aWZpY2F0aW9uIHBlcm1pc3Npb24gdmFsdWVzLgogICAqLwogIHZhciBOb3RpZmljYXRpb25QZXJtaXNzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnZ3JhbnRlZCcsCiAgICAnZGVuaWVkJywKICAgICdkZWZhdWx0JwogIF0pOwoKICAvKioKICAgKiBBIHNpbXBsZSBlbmdpbmUgZm9yIHNob3dpbmcgbm90aWZpY2F0aW9uIHBvcHVwcy4KICAgKi8KICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnF1ZXVlID0gW107CiAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFRkFVTFQ7CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5yZXF1ZXN0UGVybWlzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmICghKCJOb3RpZmljYXRpb24iIGluIGdsb2JhbCkpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGlzIGJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IG5vdGlmaWNhdGlvbnMuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQ7CgogICAgfSBlbHNlIGlmIChnbG9iYWwuTm90aWZpY2F0aW9uLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhlIHVzZXIgaGFzIHJlcXVlc3RlZCB0byBub3QgcmVjZWl2ZSBub3RpZmljYXRpb25zLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEOwoKICAgIH0gZWxzZSBpZiAodGhpcy5wZXJtaXNzaW9uICE9PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgZ2xvYmFsLk5vdGlmaWNhdGlvbi5yZXF1ZXN0UGVybWlzc2lvbigpLnRoZW4oZnVuY3Rpb24gKHBlcm1pc3Npb24pIHsKICAgICAgICBzZWxmLnBlcm1pc3Npb24gPSBwZXJtaXNzaW9uOwogICAgICAgIGlmIChwZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgICAgIHNlbGYuX3Nob3dRdWV1ZWQoKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYucXVldWUgPSBbXTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uICh0aXRsZSwgb3B0aW9ucykgewogICAgaWYgKHRoaXMucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIHJldHVybiB0aGlzLl9zaG93SW1wbCh7IHRpdGxlOiB0aXRsZSwgb3B0aW9uczogb3B0aW9ucyB9KTsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJVbmFibGUgdG8gc2hvdyBub3RpZmljYXRpb24uIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgIHRpdGxlOiB0aXRsZSwKICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMKICAgICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICB2YXIgcGFyYW1zID0geyB0aXRsZTogdGl0bGUsIG9wdGlvbnM6IG9wdGlvbnMgfTsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJEZWZlcnJpbmcgbm90aWZpY2F0aW9uIHVudGlsIHVzZXIgZGVjaWRlcyB0byBhbGxvdyBvciBkZW55LiIpCiAgICAgICAgLndpdGhPYmplY3QocGFyYW1zKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnF1ZXVlLnB1c2gocGFyYW1zKTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLl9zaG93UXVldWVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG5vdGlmaWNhdGlvbnMgPSB0aGlzLnF1ZXVlLm1hcChmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgIHJldHVybiBzZWxmLl9zaG93SW1wbChwYXJhbXMpOwogICAgfSk7CiAgICB0aGlzLnF1ZXVlID0gW107CiAgICByZXR1cm4gbm90aWZpY2F0aW9uczsKICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLl9zaG93SW1wbCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciBub3RpZmljYXRpb24gPSBuZXcgZ2xvYmFsLk5vdGlmaWNhdGlvbihwYXJhbXMudGl0bGUsIHBhcmFtcy5vcHRpb25zKTsKICAgIGlmIChwYXJhbXMub3B0aW9ucy5jbGlja2VkKSB7CiAgICAgIG5vdGlmaWNhdGlvbi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIHBhcmFtcy5vcHRpb25zLmNsaWNrZWQuY2FsbChub3RpZmljYXRpb24pOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIG5vdGlmaWNhdGlvbjsKICB9OwoKICBjb25uZWN0LlZhbHVlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGluc3RhbmNlID0gbmV3IEVycm9yKGNvbm5lY3QudnNwcmludGYoZm9ybWF0LCBhcmdzKSk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoaW5zdGFuY2UsIGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUpOwogICAgcmV0dXJuIGluc3RhbmNlOyAKICB9OwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlLCBFcnJvci5wcm90b3R5cGUpOwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlZhbHVlRXJyb3IsIEVycm9yKTsKICBjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnVmFsdWVFcnJvcic7CgogIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgaW5zdGFuY2UgPSBuZXcgRXJyb3IoY29ubmVjdC52c3ByaW50Zihmb3JtYXQsIGFyZ3MpKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihpbnN0YW5jZSwgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZSk7CiAgICByZXR1cm4gaW5zdGFuY2U7IAogIH07CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUsIEVycm9yLnByb3RvdHlwZSk7CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvciwgRXJyb3IpOwogIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUubmFtZSA9ICdOb3RJbXBsZW1lbnRlZEVycm9yJzsKCiAgY29ubmVjdC5TdGF0ZUVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBpbnN0YW5jZSA9IG5ldyBFcnJvcihjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlKTsKICAgIHJldHVybiBpbnN0YW5jZTsgCiAgfQogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlLCBFcnJvci5wcm90b3R5cGUpOwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlN0YXRlRXJyb3IsIEVycm9yKTsKICBjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnU3RhdGVFcnJvcic7CgoKCiAgY29ubmVjdC5Wb2ljZUlkRXJyb3IgPSBmdW5jdGlvbih0eXBlLCBtZXNzYWdlLCBlcnIpewogICAgdmFyIGVycm9yID0ge307CiAgICBlcnJvci50eXBlID0gdHlwZTsKICAgIGVycm9yLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgZXJyb3Iuc3RhY2sgPSBFcnJvcihtZXNzYWdlKS5zdGFjazsKICAgIGVycm9yLmVyciA9IGVycjsKICAgIHJldHVybiBlcnJvcjsKICB9CgogIC8vIGludGVybmFsIHVzZSBvbmx5CiAgY29ubmVjdC5pc0NDUCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICByZXR1cm4gY29uZHVpdC5uYW1lID09PSAnQ29ubmVjdFNoYXJlZFdvcmtlckNvbmR1aXQnOwogIH0KCn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA3MzY6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICBjb25uZWN0LndvcmtlciA9IHt9OwoKICB2YXIgR0VUX0FHRU5UX1RJTUVPVVRfTVMgPSAzMDAwMDsKICB2YXIgR0VUX0FHRU5UX1JFQ09WRVJZX1RJTUVPVVRfTVMgPSA1MDAwOwogIHZhciBHRVRfQUdFTlRfU1VDQ0VTU19USU1FT1VUX01TID0gMTAwOwogIHZhciBMT0dfQlVGRkVSX0NBUF9TSVpFID0gNDAwOwoKICB2YXIgQ0hFQ0tfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyA9IDMwMDAwMDsgLy8gNSBtaW51dGVzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyA9IDEwMDAwOyAvLyAxMCBzZWNvbmRzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZID0gNDsKCiAgdmFyIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TID0gMzAwMDA7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgTWFzdGVyVG9waWNDb29yZGluYXRvciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXAgPSB7fTsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5nZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgJ3RvcGljJyk7CiAgICByZXR1cm4gdGhpcy50b3BpY01hc3Rlck1hcFt0b3BpY10gfHwgbnVsbDsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5zZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICd0b3BpYycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlkLCAnaWQnKTsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXBbdG9waWNdID0gaWQ7CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUucmVtb3ZlTWFzdGVyID0gZnVuY3Rpb24gKGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWQsICdpZCcpOwogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGNvbm5lY3QuZW50cmllcyh0aGlzLnRvcGljTWFzdGVyTWFwKS5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgIHJldHVybiBlbnRyeS52YWx1ZSA9PT0gaWQ7CiAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkgewogICAgICBkZWxldGUgc2VsZi50b3BpY01hc3Rlck1hcFtlbnRyeS5rZXldOwogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgV29ya2VyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogIHZhciBXb3JrZXJDbGllbnQgPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgY29ubmVjdC5DbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogIH07CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5DbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdvcmtlckNsaWVudDsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbiAobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVlc3Rfc3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGlmKGNvbm5lY3QuY29udGFpbnNWYWx1ZShjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcywgbWV0aG9kKSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIGlmKGNvbm5lY3QuY29udGFpbnNWYWx1ZShjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnRNZXRob2RzLCBtZXRob2QpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRUYXNrVGVtcGxhdGVzQ2xpZW50KCkuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyb3IpOwogICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IsIGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvciwgZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLmF1dGhGYWlsdXJlKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQgJiYgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICAKICB9OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9yZWNvcmRBUElMYXRlbmN5ID0gZnVuY3Rpb24gKG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyKSB7CiAgICB2YXIgcmVxdWVzdF9lbmQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciByZXF1ZXN0X3RpbWUgPSByZXF1ZXN0X2VuZCAtIHJlcXVlc3Rfc3RhcnQ7CiAgICB0aGlzLl9zZW5kQVBJTWV0cmljcyhtZXRob2QsIHJlcXVlc3RfdGltZSwgZXJyKTsKICB9OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9zZW5kQVBJTWV0cmljcyA9IGZ1bmN0aW9uIChtZXRob2QsIHRpbWUsIGVycikgewogICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9NRVRSSUMsIHsKICAgICAgbmFtZTogbWV0aG9kLAogICAgICB0aW1lOiB0aW1lLAogICAgICBkaW1lbnNpb25zOiBbCiAgICAgICAgewogICAgICAgICAgbmFtZTogIkNhdGVnb3J5IiwKICAgICAgICAgIHZhbHVlOiAiQVBJIgogICAgICAgIH0KICAgICAgXSwKICAgICAgZXJyb3I6IGVycgogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFRoZSBvYmplY3QgcmVzcG9uc2libGUgZm9yIHBvbGxpbmcgYW5kIHBhc3NpbmcgZGF0YSBkb3duc3RyZWFtIHRvIGFsbAogICAqIGNvbnN1bWVyIHBvcnRzLgogICAqLwogIHZhciBDbGllbnRFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5tdWx0aXBsZXhlciA9IG5ldyBjb25uZWN0LlN0cmVhbU11bHRpcGxleGVyKCk7CiAgICB0aGlzLmNvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KCJBbWF6b25Db25uZWN0U2hhcmVkV29ya2VyIiwgbnVsbCwgdGhpcy5tdWx0aXBsZXhlcik7CiAgICB0aGlzLmNsaWVudCA9IG5ldyBXb3JrZXJDbGllbnQodGhpcy5jb25kdWl0KTsKICAgIHRoaXMudGltZW91dCA9IG51bGw7CiAgICB0aGlzLmFnZW50ID0gbnVsbDsKICAgIHRoaXMubmV4dFRva2VuID0gbnVsbDsKICAgIHRoaXMuaW5pdERhdGEgPSB7fTsKICAgIHRoaXMucG9ydENvbmR1aXRNYXAgPSB7fTsKICAgIHRoaXMuc3RyZWFtTWFwQnlUYWJJZCA9IHt9OwogICAgdGhpcy5tYXN0ZXJDb29yZCA9IG5ldyBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yKCk7CiAgICB0aGlzLmxvZ3NCdWZmZXIgPSBbXTsKICAgIHRoaXMuc3VwcHJlc3MgPSBmYWxzZTsKICAgIHRoaXMuZm9yY2VPZmZsaW5lID0gZmFsc2U7CiAgICB0aGlzLmxvbmdQb2xsaW5nT3B0aW9ucyA9IHsKICAgICAgYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGU6IGZhbHNlLCAKICAgICAgYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlOiBmYWxzZSwKICAgIH0KCiAgICB2YXIgd2ViU29ja2V0TWFuYWdlciA9IG51bGw7CgogICAgY29ubmVjdC5yb290TG9nZ2VyID0gbmV3IGNvbm5lY3QuRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIodGhpcy5jb25kdWl0KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFTkRfTE9HUywgZnVuY3Rpb24gKGxvZ3NUb1VwbG9hZCkgewogICAgICAvLyBBZGQgc29mdHBob25lIGxvZ3MgZG93bnN0cmVhbQogICAgICBjb25uZWN0LmdldExvZygpLnB1c2hMb2dzRG93bnN0cmVhbShsb2dzVG9VcGxvYWQpOwoKICAgICAgc2VsZi5sb2dzQnVmZmVyID0gc2VsZi5sb2dzQnVmZmVyLmNvbmNhdChsb2dzVG9VcGxvYWQpOwogICAgICAvL29ubHkgY2FsbCBBUEkgdG8gc2VuZCBsb2dzIGlmIGJ1ZmZlciByZWFjaGVkIGNhcAogICAgICBpZiAoc2VsZi5sb2dzQnVmZmVyLmxlbmd0aCA+IExPR19CVUZGRVJfQ0FQX1NJWkUpIHsKICAgICAgICBzZWxmLmhhbmRsZVNlbmRMb2dzUmVxdWVzdChzZWxmLmxvZ3NCdWZmZXIpOwogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgZnVuY3Rpb24gKGRhdGEpewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgU3VwcHJlc3MgdG8gJXMiLCBkYXRhLnN1cHByZXNzKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBzZWxmLnN1cHByZXNzID0gZGF0YS5zdXBwcmVzcyB8fCBmYWxzZTsKICAgICAgLy9zaWduYWwgb3RoZXIgd2luZG93cyB0aGF0IGEgZmFpbG92ZXIgaGFwcGVuZWQKICAgICAgaWYgKHNlbGYubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSkpIHsKICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZBSUxPVkVSLCB7CiAgICAgICAgICBpc1ByaW1hcnk6ICFzZWxmLnN1cHByZXNzCiAgICAgICAgfSk7ICAgICAgCiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZGVidWcoIltEaXNhc3RlciBSZWNvdmVyeV0gU2V0dGluZyBGT1JDRV9PRkZMSU5FIHRvICVzIiwgZGF0YS5vZmZsaW5lKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBzZWxmLmZvcmNlT2ZmbGluZSA9IGRhdGEub2ZmbGluZSB8fCBmYWxzZTsKICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAoZGF0YS5hdXRoVG9rZW4gJiYgZGF0YS5hdXRoVG9rZW4gIT09IHNlbGYuaW5pdERhdGEuYXV0aFRva2VuKSB7CiAgICAgICAgc2VsZi5pbml0RGF0YSA9IGRhdGE7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXQoZGF0YSk7CiAgICAgICAgaWYgKGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlID09ICJib29sZWFuIikgewogICAgICAgICAgICBzZWxmLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZSA9IGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGUgPT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIHNlbGYubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZSA9IGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gaW5pdCBvbmx5IG9uY2UuCiAgICAgICAgaWYgKCF3ZWJTb2NrZXRNYW5hZ2VyKSB7CgogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDcmVhdGluZyBhIG5ldyBXZWJzb2NrZXQgY29ubmVjdGlvbiBmb3IgQ0NQIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAgICAgY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyLnNldEdsb2JhbENvbmZpZyh7CiAgICAgICAgICAgIGxvZ2dlckNvbmZpZzogeyBsb2dnZXI6IGNvbm5lY3QuZ2V0TG9nKCkgfQogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlciA9IGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlci5jcmVhdGUoKTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uSW5pdEZhaWx1cmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uT3BlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fT1BFTiwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25DbG9zZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fQ0xPU0UsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uR2FpbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCk7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0dBSU4pOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25Mb3N0KGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCByZXNwb25zZSk7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0xPU1QsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25TdWJzY3JpcHRpb25VcGRhdGUoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fVVBEQVRFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uU3Vic2NyaXB0aW9uRmFpbHVyZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9GQUlMVVJFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQWxsTWVzc2FnZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkFMTF9NRVNTQUdFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBzZWxmLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNFTkQsIGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuc2VuZE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBzZWxmLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklCRSwgZnVuY3Rpb24gKHRvcGljcykgewogICAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLnN1YnNjcmliZVRvcGljcyh0b3BpY3MpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5pbml0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5nZXRXZWJTb2NrZXRVcmwpKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlICYmICFyZXNwb25zZS53ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkKSB7CiAgICAgICAgICAgICAgICAvLyBTdGFydCBwb2xsaW5nIGZvciBhZ2VudCBkYXRhLgogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJLaWNraW5nIG9mZiBhZ2VudCBwb2xsaW5nIikKICAgICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudCgpOwogIAogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJLaWNraW5nIG9mZiBjb25maWcgcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKHsgcmVwZWF0Rm9yZXZlcjogdHJ1ZSB9KTsKICAKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYXV0aCB0b2tlbiBwb2xsaW5nIikKICAgICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmNoZWNrQXV0aFRva2VuKSwgQ0hFQ0tfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFOwogICAgICAgICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oZXZlbnQpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIldlYlNvY2tldCBmYWlsZWQgdG8gaW5pdGlhbGl6ZSIpCiAgICAgICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIk5vdCBJbml0aWFsaXppbmcgYSBuZXcgV2Vic29ja2V0TWFuYWdlciBpbnN0YW5jZSwgc2luY2Ugb25lIGFscmVhZHkgZXhpc3RzIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFLCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vdXBsb2FkIHBlbmRpbmcgbG9ncyBiZWZvcmUgdGVybWluYXRpbmcuCiAgICAgIHNlbGYuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0KHNlbGYubG9nc0J1ZmZlcik7CiAgICAgIGNvbm5lY3QuY29yZS50ZXJtaW5hdGUoKTsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQpOwogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNZTkNIUk9OSVpFLCBmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSk7CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oZGF0YS5ldmVudCwgZGF0YS5kYXRhKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ2FsbGVkIHdoZW4gYSBjb25zdW1lciBwb3J0IGNvbm5lY3RzIHRvIHRoaXMgU2hhcmVkV29ya2VyLgogICAgICogTGV0J3MgYWRkIHRoZW0gdG8gb3VyIG11bHRpcGxleGVyLgogICAgICovCiAgICBnbG9iYWwub25jb25uZWN0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBwb3J0ID0gZXZlbnQucG9ydHNbMF07CiAgICAgIHZhciBzdHJlYW0gPSBuZXcgY29ubmVjdC5Qb3J0U3RyZWFtKHBvcnQpOwogICAgICBzZWxmLm11bHRpcGxleGVyLmFkZFN0cmVhbShzdHJlYW0pOwogICAgICBwb3J0LnN0YXJ0KCk7CgogICAgICB2YXIgcG9ydENvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KHN0cmVhbS5nZXRJZCgpLCBudWxsLCBzdHJlYW0pOwogICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgeyBpZDogc3RyZWFtLmdldElkKCkgfSk7CgogICAgICBzZWxmLnBvcnRDb25kdWl0TWFwW3N0cmVhbS5nZXRJZCgpXSA9IHBvcnRDb25kdWl0OwogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoIH0pOwoKICAgICAgaWYgKHNlbGYuYWdlbnQgIT09IG51bGwpIHsKICAgICAgICBzZWxmLnVwZGF0ZUFnZW50KCk7CiAgICAgIH0KCiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVRVUVTVCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQVBJUmVxdWVzdCwgcG9ydENvbmR1aXQpKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVFVRVNULAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVNYXN0ZXJSZXF1ZXN0LCBwb3J0Q29uZHVpdCwgc3RyZWFtLmdldElkKCkpKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlJFTE9BRF9BR0VOVF9DT05GSUdVUkFUSU9OLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5UQUJfSUQsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZVRhYklkRXZlbnQsIHN0cmVhbSkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ0xPU0UsIAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVDbG9zZUV2ZW50LCBzdHJlYW0pKTsKICAgIH07CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1NOQVBTSE9ULCB7CiAgICAgIG5leHRUb2tlbjogc2VsZi5uZXh0VG9rZW4sCiAgICAgIHRpbWVvdXQ6IEdFVF9BR0VOVF9USU1FT1VUX01TCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNlbGYuYWdlbnQgPSBzZWxmLmFnZW50IHx8IHt9OwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90ID0gZGF0YS5zbmFwc2hvdDsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcCA9IGNvbm5lY3Qubm93KCk7CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3Quc2tldyA9IHNlbGYuYWdlbnQuc25hcHNob3Quc25hcHNob3RUaW1lc3RhbXAgLSBzZWxmLmFnZW50LnNuYXBzaG90LmxvY2FsVGltZXN0YW1wOwogICAgICAgICAgICBzZWxmLm5leHRUb2tlbiA9IGRhdGEubmV4dFRva2VuOwogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJHRVRfQUdFTlRfU05BUFNIT1Qgc3VjY2VlZGVkLiIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudCgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJMb25nIHBvbGwgZmFpbGVkIHRvIHVwZGF0ZSBhZ2VudC4iKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnQpLCBHRVRfQUdFTlRfU1VDQ0VTU19USU1FT1VUX01TKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBnZXQgYWdlbnQgZGF0YS4iKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudCksIEdFVF9BR0VOVF9SRUNPVkVSWV9USU1FT1VUX01TKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCgogICAgICB9KTsKCiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX0NPTkZJR1VSQVRJT04sIHt9LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIGNvbmZpZ3VyYXRpb24gPSBkYXRhLmNvbmZpZ3VyYXRpb247CiAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFN0YXRlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2Rlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBpZiAocGFyYW1zLnJlcGVhdEZvcmV2ZXIpIHsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uLCBwYXJhbXMpLAogICAgICAgICAgICBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBjb25maWd1cmF0aW9uIGRhdGEuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChwYXJhbXMucmVwZWF0Rm9yZXZlcikgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiksCiAgICAgICAgICAgICAgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMsIHBhcmFtcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgfSwKICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRTdGF0ZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1NUQVRFUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFN0YXRlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgc3RhdGVzOiAocGFyYW1zLnN0YXRlcyB8fCBbXSkuY29uY2F0KGRhdGEuc3RhdGVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRTdGF0ZXMgPSAocGFyYW1zLnN0YXRlcyB8fCBbXSkuY29uY2F0KGRhdGEuc3RhdGVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgc3RhdGVzIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50UGVybWlzc2lvbnMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1BFUk1JU1NJT05TLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwoKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50UGVybWlzc2lvbnMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIHBlcm1pc3Npb25zOiAocGFyYW1zLnBlcm1pc3Npb25zIHx8IFtdKS5jb25jYXQoZGF0YS5wZXJtaXNzaW9ucyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLnBlcm1pc3Npb25zID0gKHBhcmFtcy5wZXJtaXNzaW9ucyB8fCBbXSkuY29uY2F0KGRhdGEucGVybWlzc2lvbnMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBwZXJtaXNzaW9ucyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2RlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfRElBTEFCTEVfQ09VTlRSWV9DT0RFUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBjb3VudHJ5Q29kZXM6IChwYXJhbXMuY291bnRyeUNvZGVzIHx8IFtdKS5jb25jYXQoZGF0YS5jb3VudHJ5Q29kZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5kaWFsYWJsZUNvdW50cmllcyA9IChwYXJhbXMuY291bnRyeUNvZGVzIHx8IFtdKS5jb25jYXQoZGF0YS5jb3VudHJ5Q29kZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBkaWFsYWJsZSBjb3VudHJ5IGNvZGVzIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9ST1VUSU5HX1BST0ZJTEVfUVVFVUVTLCB7CiAgICAgIHJvdXRpbmdQcm9maWxlQVJOOiBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOLAogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBjb3VudHJ5Q29kZXM6IChwYXJhbXMucXVldWVzIHx8IFtdKS5jb25jYXQoZGF0YS5xdWV1ZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMgPSAocGFyYW1zLnF1ZXVlcyB8fCBbXSkuY29uY2F0KGRhdGEucXVldWVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggcm91dGluZyBwcm9maWxlIHF1ZXVlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUFQSVJlcXVlc3QgPSBmdW5jdGlvbiAocG9ydENvbmR1aXQsIHJlcXVlc3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLmNsaWVudC5jYWxsKHJlcXVlc3QubWV0aG9kLCByZXF1ZXN0LnBhcmFtcywgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSwgcmVxdWVzdCwgZGF0YSk7CiAgICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHZhciByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSwgcmVxdWVzdCwgZGF0YSwgSlNPTi5zdHJpbmdpZnkoZXJyKSk7CiAgICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCInJXMnIEFQSSByZXF1ZXN0IGZhaWxlZCIsIHJlcXVlc3QubWV0aG9kKQogICAgICAgICAgLndpdGhPYmplY3QoeyByZXF1ZXN0OiBzZWxmLmZpbHRlckF1dGhUb2tlbihyZXF1ZXN0KSwgcmVzcG9uc2U6IHJlc3BvbnNlIH0pCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnIpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCwge2F1dGhvcml6ZTogdHJ1ZX0pCiAgICB9KTsKICB9OwoKICAvKioKICAgKiBIYW5kbGUgaW5jb21pbmcgbWFzdGVyIHF1ZXJ5IG9yIG1vZGlmaWNhdGlvbiByZXF1ZXN0cyBmcm9tIGNvbm5lY3RlZCB0YWIgcG9ydHMuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVNYXN0ZXJSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCBwb3J0SWQsIHJlcXVlc3QpIHsKICAgIHZhciBtdWx0aXBsZXhlckNvbmR1aXQgPSB0aGlzLmNvbmR1aXQ7CiAgICB2YXIgcmVzcG9uc2UgPSBudWxsOwoKICAgIHN3aXRjaCAocmVxdWVzdC5tZXRob2QpIHsKICAgICAgY2FzZSBjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQkVDT01FX01BU1RFUjoKICAgICAgICB2YXIgbWFzdGVySWQgPSB0aGlzLm1hc3RlckNvb3JkLmdldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYyk7CiAgICAgICAgdmFyIHRha2VPdmVyID0gQm9vbGVhbihtYXN0ZXJJZCkgJiYgbWFzdGVySWQgIT09IHBvcnRJZDsKICAgICAgICB0aGlzLm1hc3RlckNvb3JkLnNldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYywgcG9ydElkKTsKICAgICAgICByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgcmVxdWVzdCwgewogICAgICAgICAgbWFzdGVySWQ6IHBvcnRJZCwKICAgICAgICAgIHRha2VPdmVyOiB0YWtlT3ZlciwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwogICAgICAgIGlmICh0YWtlT3ZlcikgewogICAgICAgICAgbXVsdGlwbGV4ZXJDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQ0hFQ0tfTUFTVEVSOgogICAgICAgIHZhciBtYXN0ZXJJZCA9IHRoaXMubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljKTsKICAgICAgICBpZiAoIW1hc3RlcklkICYmICFyZXF1ZXN0LnBhcmFtcy5zaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUpIHsKICAgICAgICAgIHRoaXMubWFzdGVyQ29vcmQuc2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljLCBwb3J0SWQpOwogICAgICAgICAgbWFzdGVySWQgPSBwb3J0SWQ7CiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCByZXF1ZXN0LCB7CiAgICAgICAgICBtYXN0ZXJJZDogbWFzdGVySWQsCiAgICAgICAgICBpc01hc3RlcjogcG9ydElkID09PSBtYXN0ZXJJZCwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbWFzdGVyIG1ldGhvZDogIiArIHJlcXVlc3QubWV0aG9kKTsKICAgIH0KCiAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlVGFiSWRFdmVudCA9IGZ1bmN0aW9uIChzdHJlYW0sIGRhdGEpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRyeSB7CiAgICAgIGxldCB0YWJJZCA9IGRhdGEudGFiSWQ7CiAgICAgIGxldCBzdHJlYW1zSW5UaGlzVGFiID0gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXTsKICAgICAgbGV0IGN1cnJlbnRTdHJlYW1JZCA9IHN0cmVhbS5nZXRJZCgpOwogICAgICBsZXQgdGFiSWRzID0gT2JqZWN0LmtleXMoc2VsZi5zdHJlYW1NYXBCeVRhYklkKTsKICAgICAgbGV0IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciA9IHRhYklkcy5maWx0ZXIodGFiSWQgPT4gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggPiAwKS5sZW5ndGg7CiAgICAgIGlmIChzdHJlYW1zSW5UaGlzVGFiICYmIHN0cmVhbXNJblRoaXNUYWIubGVuZ3RoID4gMCl7CiAgICAgICAgaWYgKCFzdHJlYW1zSW5UaGlzVGFiLmluY2x1ZGVzKGN1cnJlbnRTdHJlYW1JZCkpIHsKICAgICAgICAgIHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ucHVzaChjdXJyZW50U3RyZWFtSWQpOwogICAgICAgICAgbGV0IHVwZGF0ZU9iamVjdCA9IHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGgsIHRhYklkLCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgfTsKICAgICAgICAgIHVwZGF0ZU9iamVjdFt0YWJJZF0gPSB7IGxlbmd0aDogc3RyZWFtc0luVGhpc1RhYi5sZW5ndGggfTsKICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHVwZGF0ZU9iamVjdCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0gPSBbc3RyZWFtLmdldElkKCldOwogICAgICAgIGxldCB1cGRhdGVPYmplY3QgPSB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoLCB0YWJJZCwgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyOiBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgKyAxIH07CiAgICAgICAgdXBkYXRlT2JqZWN0W3RhYklkXSA9IHsgbGVuZ3RoOiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCB9OwogICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHVwZGF0ZU9iamVjdCk7CiAgICAgIH0KICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJbVGFiIElkc10gSXNzdWUgdXBkYXRpbmcgY29ubmVjdGVkIENDUHMgd2l0aGluIHRoZSBzYW1lIHRhYiIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUNsb3NlRXZlbnQgPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYubXVsdGlwbGV4ZXIucmVtb3ZlU3RyZWFtKHN0cmVhbSk7CiAgICBkZWxldGUgc2VsZi5wb3J0Q29uZHVpdE1hcFtzdHJlYW0uZ2V0SWQoKV07CiAgICBzZWxmLm1hc3RlckNvb3JkLnJlbW92ZU1hc3RlcihzdHJlYW0uZ2V0SWQoKSk7CiAgICBsZXQgdXBkYXRlT2JqZWN0ID0geyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCB9OwogICAgbGV0IHRhYklkcyA9IE9iamVjdC5rZXlzKHNlbGYuc3RyZWFtTWFwQnlUYWJJZCk7CiAgICB0cnkgewogICAgICBsZXQgdGFiSWQgPSB0YWJJZHMuZmluZChrZXkgPT4gc2VsZi5zdHJlYW1NYXBCeVRhYklkW2tleV0uaW5jbHVkZXMoc3RyZWFtLmdldElkKCkpKTsKICAgICAgaWYgKHRhYklkKSB7CiAgICAgICAgbGV0IHN0cmVhbUluZGV4SW5NYXAgPSBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmZpbmRJbmRleCgodmFsdWUpID0+IHN0cmVhbS5nZXRJZCgpID09PSB2YWx1ZSk7CiAgICAgICAgc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5zcGxpY2Uoc3RyZWFtSW5kZXhJbk1hcCwgMSk7CiAgICAgICAgbGV0IHRhYkxlbmd0aCA9IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0gPyBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCA6IDA7CiAgICAgICAgdXBkYXRlT2JqZWN0W3RhYklkXSA9IHsgbGVuZ3RoOiB0YWJMZW5ndGggfTsKICAgICAgICB1cGRhdGVPYmplY3QudGFiSWQgPSB0YWJJZDsKICAgICAgfQogICAgICBsZXQgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyID0gdGFiSWRzLmZpbHRlcih0YWJJZCA9PiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCA+IDApLmxlbmd0aDsKICAgICAgdXBkYXRlT2JqZWN0LnN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciA9IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlcjsKICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJbVGFiIElkc10gSXNzdWUgdXBkYXRpbmcgdGFiSWQtc3BlY2lmaWMgc3RyZWFtIGRhdGEiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB1cGRhdGVPYmplY3QpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24pIHsKICAgIGlmIChjb25maWd1cmF0aW9uLnBlcm1pc3Npb25zICYmCiAgICAgIGNvbmZpZ3VyYXRpb24uZGlhbGFibGVDb3VudHJpZXMgJiYKICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFN0YXRlcyAmJgogICAgICBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcykgewoKICAgICAgdGhpcy5hZ2VudCA9IHRoaXMuYWdlbnQgfHwge307CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICAgIHRoaXMudXBkYXRlQWdlbnQoKTsKCiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCBjb25maWd1cmF0aW9uIHVudGlsIGFsbCBjb25maWcgZGF0YSBoYXMgYmVlbiBmZXRjaGVkLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS51cGRhdGVBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGhpcy5hZ2VudCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgaGFzIGJlZW4gZnVsbHkgY29uc3RydWN0ZWQuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgaWYgKCF0aGlzLmFnZW50LnNuYXBzaG90KSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBzbmFwc2hvdCBpcyBhdmFpbGFibGUuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgaWYgKCF0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24pIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IGNvbmZpZ3VyYXRpb24gaXMgYXZhaWxhYmxlLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIHsKICAgICAgLy8gQWxpYXMgc29tZSBvZiB0aGUgcHJvcGVydGllcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3Quc3RhdHVzID0gdGhpcy5hZ2VudC5zdGF0ZTsKCiAgICAgIC8vIFNvcnQgdGhlIGNvbnRhY3RzIG9uIHRoZSB0aW1lc3RhbXAKICAgICAgaWYgKHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMgJiYgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5zb3J0KGZ1bmN0aW9uIChjb250YWN0QSwgY29udGFjdEIpIHsKICAgICAgICAgIHJldHVybiBjb250YWN0QS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpIC0gY29udGFjdEIuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgY29udGFjdC5zdGF0dXMgPSBjb250YWN0LnN0YXRlOwoKICAgICAgICBjb250YWN0LmNvbm5lY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHsKICAgICAgICAgIGNvbm5lY3Rpb24uYWRkcmVzcyA9IGNvbm5lY3Rpb24uZW5kcG9pbnQ7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlLnF1ZXVlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTjsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5mb3JFYWNoKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICAgIHF1ZXVlLnF1ZXVlSWQgPSBxdWV1ZS5xdWV1ZUFSTjsKICAgICAgfSk7CiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIC8vY29udGFjdC5xdWV1ZSBpcyBudWxsIHdoZW4gbW9uaXRvcmluZwogICAgICAgIGlmIChjb250YWN0LnF1ZXVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRhY3QucXVldWUucXVldWVJZCA9IGNvbnRhY3QucXVldWUucXVldWVBUk47CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTjsKICAgICAgCiAgICAgIGlmICh0aGlzLnN1cHByZXNzKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cyA9IHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZmlsdGVyKGZ1bmN0aW9uKGNvbnRhY3QpewogICAgICAgICAgcmV0dXJuIChjb250YWN0LnN0YXRlLnR5cGUgPT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQgfHwgY29udGFjdC5zdGF0ZS50eXBlID09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQpOwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmZvcmNlT2ZmbGluZSkgewogICAgICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FKTsKICAgICAgICB9CiAgICAgIH0gCiAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgdGhpcy5hZ2VudCk7CiAgICB9CiAgfTsKCi8qKgogKiBQcm92aWRlcyBhIHdlYnNvY2tldCB1cmwgdGhyb3VnaCB0aGUgY3JlYXRlX3RyYW5zcG9ydCBBUEkuCiAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmdldFdlYlNvY2tldFVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CiAgICB2YXIgb25BY2Nlc3NEZW5pZWQgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB7IHRyYW5zcG9ydFR5cGU6IGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTLldFQl9TT0NLRVQgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFdlYlNvY2tldFVybCBzdWNjZWVkZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBmYWlsZWQiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgIHJlYXNvbjogJ2dldFdlYlNvY2tldFVybCBmYWlsZWQnLCAKICAgICAgICAgICAgX2RlYnVnOiBlcnIKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBBdXRoIEZhaWx1cmUiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBdXRoZW50aWNhdGlvbiBmYWlsZWQgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBBY2Nlc3MgRGVuaWVkIEZhaWx1cmUiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBY2Nlc3MgRGVuaWVkIEZhaWx1cmUgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkFjY2Vzc0RlbmllZCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKCiAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIGRvd25zdHJlYW0gdG8gYWxsIGNvbnN1bWVycyB3aGVuIHdlIGRldGVjdCB0aGF0IGF1dGhlbnRpY2F0aW9uCiAgICAqIGFnYWluc3Qgb25lIG9mIG91ciBBUElzIGhhcyBmYWlsZWQuCiAgICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ0V2ZW50cyA9IFtdOwogICAgdmFyIGxvZ3NUb1NlbmQgPSBzZWxmLmxvZ3NCdWZmZXIuc2xpY2UoKTsKICAgIHNlbGYubG9nc0J1ZmZlciA9IFtdOwogICAgbG9nc1RvU2VuZC5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgbG9nRXZlbnRzLnB1c2goewogICAgICAgIHRpbWVzdGFtcDogbG9nLnRpbWUsCiAgICAgICAgY29tcG9uZW50OiBsb2cuY29tcG9uZW50LAogICAgICAgIG1lc3NhZ2U6IGxvZy50ZXh0CiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0NMSUVOVF9MT0dTLCB7IGxvZ0V2ZW50czogbG9nRXZlbnRzIH0sIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlNlbmRMb2dzIHJlcXVlc3Qgc3VjY2VlZGVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJTZW5kTG9ncyByZXF1ZXN0IGZhaWxlZC4iKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkud2l0aEV4Y2VwdGlvbihlcnIpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCkKICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQXV0aEZhaWwgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKGRhdGEpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZGF0YSk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCk7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBY2Nlc3NEZW5pZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNDRVNTX0RFTklFRCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5jaGVja0F1dGhUb2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBleHBpcmF0aW9uRGF0ZSA9IG5ldyBEYXRlKHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbik7CiAgICB2YXIgY3VycmVudFRpbWVTdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHRoaXJ0eU1pbnMgPSAzMCAqIDYwICogMTAwMDsKCiAgICAvLyByZWZyZXNoIHRva2VuIDMwIG1pbnV0ZXMgYmVmb3JlIGV4cGlyYXRpb24KICAgIGlmIChleHBpcmF0aW9uRGF0ZS5nZXRUaW1lKCkgPCAoY3VycmVudFRpbWVTdGFtcCArIHRoaXJ0eU1pbnMpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aCB0b2tlbiBleHBpcmVzIGF0ICIgKyBleHBpcmF0aW9uRGF0ZSArICIgU3RhcnQgcmVmcmVzaGluZyB0b2tlbiB3aXRoIHJldHJ5LiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuYmFja29mZihjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuYXV0aG9yaXplKSwgUkVGUkVTSF9BVVRIX1RPS0VOX0lOVEVSVkFMX01TLCBSRUZSRVNIX0FVVEhfVE9LRU5fTUFYX1RSWSk7CiAgICB9CiAgfTsKCgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuYXV0aG9yaXplID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZSh0aGlzLmluaXREYXRhLmF1dGhvcml6ZUVuZHBvaW50KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICB2YXIgZXhwaXJhdGlvbiA9IG5ldyBEYXRlKHJlc3BvbnNlLmV4cGlyYXRpb24pOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkF1dGhvcml6YXRpb24gc3VjY2VlZGVkIGFuZCB0aGUgdG9rZW4gZXhwaXJlcyBhdCAlcyIsIGV4cGlyYXRpb24pCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuID0gcmVzcG9uc2UuYWNjZXNzVG9rZW47CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbiA9IGV4cGlyYXRpb247CiAgICAgIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50KHNlbGYuaW5pdERhdGEpOwogICAgICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50KHNlbGYuaW5pdERhdGEpOwogICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkF1dGhvcml6YXRpb24gZmFpbGVkIHdpdGggY29kZSAlcyIsIHJlc3BvbnNlLnN0YXR1cykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxKSB7CiAgICAgICAgc2VsZi5oYW5kbGVBdXRoRmFpbCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIEZpbHRlciB0aGUgJ2F1dGhlbnRpY2F0aW9uJyBmaWVsZCBvZiB0aGUgcmVxdWVzdCBwYXJhbXMgZnJvbSB0aGUgZ2l2ZW4gQVBJX1JFUVVFU1QgZXZlbnQuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5maWx0ZXJBdXRoVG9rZW4gPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgdmFyIG5ld19yZXF1ZXN0ID0ge307CgogICAgZm9yICh2YXIga2V5QSBpbiByZXF1ZXN0KSB7CiAgICAgIGlmIChrZXlBID09PSAncGFyYW1zJykgewogICAgICAgIHZhciBuZXdfcGFyYW1zID0ge307CiAgICAgICAgZm9yICh2YXIga2V5QiBpbiByZXF1ZXN0LnBhcmFtcykgewogICAgICAgICAgaWYgKGtleUIgIT09ICdhdXRoZW50aWNhdGlvbicpIHsKICAgICAgICAgICAgbmV3X3BhcmFtc1trZXlCXSA9IHJlcXVlc3QucGFyYW1zW2tleUJdOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV3X3JlcXVlc3QucGFyYW1zID0gbmV3X3BhcmFtczsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXdfcmVxdWVzdFtrZXlBXSA9IHJlcXVlc3Rba2V5QV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbmV3X3JlcXVlc3Q7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3Qud29ya2VyLm1haW4gPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0Lndvcmtlci5jbGllbnRFbmdpbmUgPSBuZXcgQ2xpZW50RW5naW5lKCk7CiAgfTsKCn0pKCk7CgovKioqLyB9KQoKLyoqKioqKi8gCX0pOwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqLyAJLy8gVGhlIG1vZHVsZSBjYWNoZQovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVfY2FjaGVfXyA9IHt9OwovKioqKioqLyAJCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCXZhciBjYWNoZWRNb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdOwovKioqKioqLyAJCWlmIChjYWNoZWRNb2R1bGUgIT09IHVuZGVmaW5lZCkgewovKioqKioqLyAJCQlyZXR1cm4gY2FjaGVkTW9kdWxlLmV4cG9ydHM7Ci8qKioqKiovIAkJfQovKioqKioqLyAJCS8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpCi8qKioqKiovIAkJdmFyIG1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF0gPSB7Ci8qKioqKiovIAkJCS8vIG5vIG1vZHVsZS5pZCBuZWVkZWQKLyoqKioqKi8gCQkJLy8gbm8gbW9kdWxlLmxvYWRlZCBuZWVkZWQKLyoqKioqKi8gCQkJZXhwb3J0czoge30KLyoqKioqKi8gCQl9OwovKioqKioqLyAJCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJX193ZWJwYWNrX21vZHVsZXNfX1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovIAkKLyoqKioqKi8gCQkvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZQovKioqKioqLyAJCXJldHVybiBtb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCX0KLyoqKioqKi8gCQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqLyAJLyogd2VicGFjay9ydW50aW1lL2dsb2JhbCAqLwovKioqKioqLyAJKCgpID0+IHsKLyoqKioqKi8gCQlfX3dlYnBhY2tfcmVxdWlyZV9fLmcgPSAoZnVuY3Rpb24oKSB7Ci8qKioqKiovIAkJCWlmICh0eXBlb2YgZ2xvYmFsVGhpcyA9PT0gJ29iamVjdCcpIHJldHVybiBnbG9iYWxUaGlzOwovKioqKioqLyAJCQl0cnkgewovKioqKioqLyAJCQkJcmV0dXJuIHRoaXMgfHwgbmV3IEZ1bmN0aW9uKCdyZXR1cm4gdGhpcycpKCk7Ci8qKioqKiovIAkJCX0gY2F0Y2ggKGUpIHsKLyoqKioqKi8gCQkJCWlmICh0eXBlb2Ygd2luZG93ID09PSAnb2JqZWN0JykgcmV0dXJuIHdpbmRvdzsKLyoqKioqKi8gCQkJfQovKioqKioqLyAJCX0pKCk7Ci8qKioqKiovIAl9KSgpOwovKioqKioqLyAJCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkKLyoqKioqKi8gCS8vIHN0YXJ0dXAKLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJLy8gVGhpcyBlbnRyeSBtb2R1bGUgdXNlZCAnbW9kdWxlJyBzbyBpdCBjYW4ndCBiZSBpbmxpbmVkCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgyNyk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDE2Myk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDk0NCk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDE1MSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDg5MSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDU5Mik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgyKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNzU0KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODMzKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oOTY1KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMjg2KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODk1KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNzQzKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNjQyKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNzM2KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNDM5KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMjc5KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNDE4KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMTg3KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODIxKTsKLyoqKioqKi8gCXZhciBfX3dlYnBhY2tfZXhwb3J0c19fID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1MDApOwovKioqKioqLyAJCi8qKioqKiovIH0pKCkKOw==";

  var LATEST_STREAMJS_CODE = window.atob(LATEST_STREAMJS_BASE64_CODE);


  /**
   Connect instance container
   It holds the connect api context within an iframe window.

   usage:
   var newContainer = new Container({ccpUrl: "bla", ...})
   */
  var Container = function(resource) {
      this.region = resource.region;
      this.id = this.region.replace(/-/g, '_');
      this.height = resource.height;
      this.style = resource.iframe_style; 
      this.ccp = this._createFramedCcp(JSON.stringify(resource));
  };

  Container.prototype._createFramedCcp = function (resource) {
    var permission = permission || "microphone; autoplay";
    var style = this.style || FRAME_DIMENSIONS;
    var iframe = document.createElement('iframe');
    iframe.srcdoc = this.getContent(resource);
    iframe.allow = permission;
    iframe.id = this.id;
    iframe.style = style;
    iframe.scrolling = "no";
    return iframe; 
  };

  Container.prototype.getContent = function(resource){
     return [
       "<!DOCTYPE html>",
       "<meta charset='UTF-8'>",
       "<html>",
         "<head>",
           "<script type='text/javascript'>",
             LATEST_STREAMJS_CODE,
           "</script>",
         "</head>",
         "<body onload='init()'>",
           "<div id=containerDiv style='width: 100%;height: " + this.height + "'></div>",
           "<script type='text/javascript'>",
             "function init() {",
               "connect.core.initCCP(containerDiv," + resource + ");",
            "}",
           "</script>",
         "</body>",
       "</html>"
     ].join('');
   };

  globalConnect.Container = Container;
})();

/***/ }),

/***/ 341:
/***/ (() => {

/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Note: load utils before core.js
 */

(function () {
  var global = this || globalThis;
  var connect = global.connect || {};
  var globalConnect = global.globalConnect || {};
  global.connect = connect;
  global.globalConnect = globalConnect;
  global.lily = connect;

  connect.core = {};
  globalConnect.core = { regions: {} };

  var IFRAME_STYLE = "margin: 0; border: 0; padding:0px;width: 0px;height: 0px";
  var GLOBALIFRAME_STYLE =
    "margin: 0; border: 0; padding:0px;width: 100%;height: 100%";
  var DIV_DEFAULT_HEIGHT = {
    height: "465px",
  };
  var uiFailoverEnabled = true;

  var extractCcpRegionParams = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.standByRegion, "ccpBackupResource");
    connect.assertNotNull(paramsIn.standByRegion.ccpUrl, "ccpUrl");
    connect.assertNotNull(paramsIn.standByRegion.loginUrl, "loginUrl");
    connect.assertNotNull(paramsIn.standByRegion.region, "region");

    var regionAParams = paramsIn;
    var regionBParams = Object.assign({}, paramsIn, {
      ccpUrl: paramsIn.standByRegion.ccpUrl,
      loginUrl: paramsIn.standByRegion.loginUrl,
      region: paramsIn.standByRegion.region,
    });

    var divStyle = extractDivStyle(globalContainerDiv);

    if (divStyle.display == "none") {
      uiFailoverEnabled = false;
    }

    if (parseInt(divStyle.height) <= 0) {
      globalContainerDiv.style.height = DIV_DEFAULT_HEIGHT.height; // populating ccp
      divStyle.height = DIV_DEFAULT_HEIGHT.height;
    }

    return [regionAParams, regionBParams].map(function (params) {
      connect.assertNotNull(params.ccpUrl, "ccpUrl");
      connect.assertNotNull(params.loginUrl, "loginUrl");
      connect.assertNotNull(params.region, "region");
      delete params.standByRegion;
      params.loginPopup = false;
      //signal CCP as part of a disaster recovery fleet
      params.disasterRecoveryOn = true;
      params.iframe_style = IFRAME_STYLE;
      params.height = divStyle.height;
      return params;
    });
  };

  var extractDivStyle = function (globalContainerDiv) {
    var style = window.getComputedStyle(globalContainerDiv);
    return {
      height: style.getPropertyValue("height"),
      width: style.getPropertyValue("width"),
      display: style.getPropertyValue("display"),
    };
  };

  var validateRegion = function (region, availableRegions) {
    connect.assertTrue(
      typeof region == "string",
      "Region provided " + region + " is not a valid string"
    );
    var regions = availableRegions || globalConnect.core.regions;
    if (!regions.hasOwnProperty(region)) {
      var message = "Region provided " + region + " is not found!";
      throw new connect.ValueError(message);
    }
  };

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it successfully gets the primary region.
   * 
   * @callback getPrimaryRegionSuccessCallback
   * @param {string} region -- A string representing an AWS region (e.g. "us-west-2") that is serving as the primary region in the disaster recovery setup.
   */

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it fails to get the primary region.
   * 
   * @callback getPrimaryRegionFailureCallback
   *
   */

  /**
   * Callback for fetching the primary region in a disaster recovery setup.
   * 
   * @callback getPrimaryRegionCallback
   * @param {getPrimaryRegionSuccessCallback} success -- A success callback that getPrimaryRegionCallback should call upon successfully fetching the primary region string.
   * @param {getPrimaryRegionFailureCallback} failure -- A failure callback that getPrimaryRegionCalllback should call upon unsuccessfully fetching the primary region string.
   */


  /**
   * Particular to DR, the getPrimaryRegion paramsIn field is new, and required. It returns a promise that is resolved once the CCP and namespace are successfully initialized. 
   * It is recommended that you do not attempt to use the connect object before this promise is resolved.
   * @param {object} globalContainerDiv -- The container div for the active and secondary CCPs for use with DR.
   * @param {object} paramsIn -- Identical to connect.core.initCCP's paramsIn, save for one additional param.
   * @param {getPrimaryRegionCallback} paramsIn.getPrimaryRegion -- Required. A callback function that fetches the primary region for DR as a string (like "us-west-2") and feeds it into the success callback.
   */
  globalConnect.core.initCCP = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.getPrimaryRegion, "getPrimaryRegion");
    connect.assertTrue(
      connect.isFunction(paramsIn.getPrimaryRegion),
      "getPrimaryRegion must be a function"
    );
    var getPrimaryRegionFunc = paramsIn.getPrimaryRegion;
    delete paramsIn.getPrimaryRegion;

    var dualCcpResources = extractCcpRegionParams(globalContainerDiv, paramsIn);
    getPrimaryRegionFunc(
      function (primaryRegion) {
        return new Promise(resolve => {
          var regions = dualCcpResources.reduce(function (obj, resource) {
            obj[resource.region] = null;
            return obj;
          }, {});
          validateRegion(primaryRegion, regions);

          var containers = dualCcpResources.map(function (resource) {
            if (resource.region === primaryRegion) {
              resource.isPrimary = true;
            }
            return new globalConnect.Container(resource);
          });

          //Create global Iframe and attach ccp containers
          var ccpIframes = containers.map(function (container) {
            return container.ccp.outerHTML;
          });
          var globalIframe = document.createElement("iframe");
          globalIframe.style = GLOBALIFRAME_STYLE;
          globalIframe.id = "globalCCP";
          globalIframe.scrolling = "no";

          // surface single instance connect api in main window
          globalIframe.onload = function () {
            if (uiFailoverEnabled) {
              var secondaryRegion = Object.keys(regions).find(function (
                region
              ) {
                return region != primaryRegion;
              });

              activateUI(primaryRegion, globalIframe.id);
              deactivateUI(secondaryRegion, globalIframe.id);
            }
            containers.map(function (container) {
              globalConnect.core.regions[container.region] =
                globalIframe.contentDocument.getElementById(
                  container.id
                ).contentWindow.connect;
              //listen to failover state change from other window
              var regionalConnect =
                globalConnect.core.regions[container.region];
              regionalConnect.core
                .getUpstream()
                .onUpstream(
                  regionalConnect.DisasterRecoveryEvents.FAILOVER,
                  function (data) {
                    if (data.isPrimary) {
                      connect = regionalConnect;
                      primaryRegion = connect.core.region;
                      if (uiFailoverEnabled) {
                        activateUI(primaryRegion, globalIframe.id);
                      }
                    } else if (uiFailoverEnabled) {
                      secondaryRegion = regionalConnect.core.region;
                      deactivateUI(secondaryRegion, globalIframe.id);
                    }
                  }
                );
            });
            connect = globalConnect.core.regions[primaryRegion];
            resolve();
          };
          globalIframe.srcdoc = ccpIframes.join("");
          globalContainerDiv.appendChild(globalIframe);
        });
      },
      function (callback) {
        console.error(
          "[Disaster Recovery] An error occured, while attempting to retrieve your primary region;"
        );
        callback();
      }
    );
  };

  var deactivateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height: 0; width: 0; border: 0px";
  };

  var activateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height:800px;width:100%;border:0px";
  };

  var getFailoverRegion = function (primaryRegion) {
    var primaryRegion = primaryRegion || connect.core.region;
    return Object.keys(globalConnect.core.regions).find(function (r) {
      return r !== primaryRegion;
    });
  };

  globalConnect.core.failover = function () {
    globalConnect.core.failoverTo(getFailoverRegion());
  };

  globalConnect.core.failoverTo = function (electedNewPrimaryRegion) {
      validateRegion(electedNewPrimaryRegion);
      var currentPrimaryRegion = getFailoverRegion(electedNewPrimaryRegion);
      deactivate(currentPrimaryRegion);
      activate(electedNewPrimaryRegion);
      connect = globalConnect.core.regions[electedNewPrimaryRegion];
  };

  /**-------------------------------------------------------------------------
   * Deactivates a region
   */
  var deactivate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Deactivating %s region.", connect.core.region)
      .sendInternalLogToServer();
    // call this to suppress contacts
    connect.core.suppressContacts(true);
    connect.core.forceOffline();
  };

  /**-------------------------------------------------------------------------
   * Activates Stand-by region on failover using suppress==false event
   */
  var activate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Activating %s region.", connect.core.region)
      .sendInternalLogToServer();
    connect.core.suppressContacts(false);
  };

  //reference to globalConnect initCCP. This is to mimic the single initialization CCP behavior
  connect.core.initCCP = globalConnect.core.initCCP;
})();


/***/ }),

/***/ 163:
/***/ (function() {

/*
 * JavaScript MD5
 * https://github.com/blueimp/JavaScript-MD5
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * https://opensource.org/licenses/MIT
 *
 * Based on
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */

/* global define */

/* eslint-disable strict */

;(function ($) {
  'use strict'
	var ctx = this || globalThis;

  /**
   * Add integers, wrapping at 2^32.
   * This uses 16-bit operations internally to work around bugs in interpreters.
   *
   * @param {number} x First integer
   * @param {number} y Second integer
   * @returns {number} Sum
   */
  function safeAdd(x, y) {
    var lsw = (x & 0xffff) + (y & 0xffff)
    var msw = (x >> 16) + (y >> 16) + (lsw >> 16)
    return (msw << 16) | (lsw & 0xffff)
  }

  /**
   * Bitwise rotate a 32-bit number to the left.
   *
   * @param {number} num 32-bit number
   * @param {number} cnt Rotation count
   * @returns {number} Rotated number
   */
  function bitRotateLeft(num, cnt) {
    return (num << cnt) | (num >>> (32 - cnt))
  }

  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} q q
   * @param {number} a a
   * @param {number} b b
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5cmn(q, a, b, x, s, t) {
    return safeAdd(bitRotateLeft(safeAdd(safeAdd(a, q), safeAdd(x, t)), s), b)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5ff(a, b, c, d, x, s, t) {
    return md5cmn((b & c) | (~b & d), a, b, x, s, t)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5gg(a, b, c, d, x, s, t) {
    return md5cmn((b & d) | (c & ~d), a, b, x, s, t)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5hh(a, b, c, d, x, s, t) {
    return md5cmn(b ^ c ^ d, a, b, x, s, t)
  }
  /**
   * Basic operation the algorithm uses.
   *
   * @param {number} a a
   * @param {number} b b
   * @param {number} c c
   * @param {number} d d
   * @param {number} x x
   * @param {number} s s
   * @param {number} t t
   * @returns {number} Result
   */
  function md5ii(a, b, c, d, x, s, t) {
    return md5cmn(c ^ (b | ~d), a, b, x, s, t)
  }

  /**
   * Calculate the MD5 of an array of little-endian words, and a bit length.
   *
   * @param {Array} x Array of little-endian words
   * @param {number} len Bit length
   * @returns {Array<number>} MD5 Array
   */
  function binlMD5(x, len) {
    /* append padding */
    x[len >> 5] |= 0x80 << len % 32
    x[(((len + 64) >>> 9) << 4) + 14] = len

    var i
    var olda
    var oldb
    var oldc
    var oldd
    var a = 1732584193
    var b = -271733879
    var c = -1732584194
    var d = 271733878

    for (i = 0; i < x.length; i += 16) {
      olda = a
      oldb = b
      oldc = c
      oldd = d

      a = md5ff(a, b, c, d, x[i], 7, -680876936)
      d = md5ff(d, a, b, c, x[i + 1], 12, -389564586)
      c = md5ff(c, d, a, b, x[i + 2], 17, 606105819)
      b = md5ff(b, c, d, a, x[i + 3], 22, -1044525330)
      a = md5ff(a, b, c, d, x[i + 4], 7, -176418897)
      d = md5ff(d, a, b, c, x[i + 5], 12, 1200080426)
      c = md5ff(c, d, a, b, x[i + 6], 17, -1473231341)
      b = md5ff(b, c, d, a, x[i + 7], 22, -45705983)
      a = md5ff(a, b, c, d, x[i + 8], 7, 1770035416)
      d = md5ff(d, a, b, c, x[i + 9], 12, -1958414417)
      c = md5ff(c, d, a, b, x[i + 10], 17, -42063)
      b = md5ff(b, c, d, a, x[i + 11], 22, -1990404162)
      a = md5ff(a, b, c, d, x[i + 12], 7, 1804603682)
      d = md5ff(d, a, b, c, x[i + 13], 12, -40341101)
      c = md5ff(c, d, a, b, x[i + 14], 17, -1502002290)
      b = md5ff(b, c, d, a, x[i + 15], 22, 1236535329)

      a = md5gg(a, b, c, d, x[i + 1], 5, -165796510)
      d = md5gg(d, a, b, c, x[i + 6], 9, -1069501632)
      c = md5gg(c, d, a, b, x[i + 11], 14, 643717713)
      b = md5gg(b, c, d, a, x[i], 20, -373897302)
      a = md5gg(a, b, c, d, x[i + 5], 5, -701558691)
      d = md5gg(d, a, b, c, x[i + 10], 9, 38016083)
      c = md5gg(c, d, a, b, x[i + 15], 14, -660478335)
      b = md5gg(b, c, d, a, x[i + 4], 20, -405537848)
      a = md5gg(a, b, c, d, x[i + 9], 5, 568446438)
      d = md5gg(d, a, b, c, x[i + 14], 9, -1019803690)
      c = md5gg(c, d, a, b, x[i + 3], 14, -187363961)
      b = md5gg(b, c, d, a, x[i + 8], 20, 1163531501)
      a = md5gg(a, b, c, d, x[i + 13], 5, -1444681467)
      d = md5gg(d, a, b, c, x[i + 2], 9, -51403784)
      c = md5gg(c, d, a, b, x[i + 7], 14, 1735328473)
      b = md5gg(b, c, d, a, x[i + 12], 20, -1926607734)

      a = md5hh(a, b, c, d, x[i + 5], 4, -378558)
      d = md5hh(d, a, b, c, x[i + 8], 11, -2022574463)
      c = md5hh(c, d, a, b, x[i + 11], 16, 1839030562)
      b = md5hh(b, c, d, a, x[i + 14], 23, -35309556)
      a = md5hh(a, b, c, d, x[i + 1], 4, -1530992060)
      d = md5hh(d, a, b, c, x[i + 4], 11, 1272893353)
      c = md5hh(c, d, a, b, x[i + 7], 16, -155497632)
      b = md5hh(b, c, d, a, x[i + 10], 23, -1094730640)
      a = md5hh(a, b, c, d, x[i + 13], 4, 681279174)
      d = md5hh(d, a, b, c, x[i], 11, -358537222)
      c = md5hh(c, d, a, b, x[i + 3], 16, -722521979)
      b = md5hh(b, c, d, a, x[i + 6], 23, 76029189)
      a = md5hh(a, b, c, d, x[i + 9], 4, -640364487)
      d = md5hh(d, a, b, c, x[i + 12], 11, -421815835)
      c = md5hh(c, d, a, b, x[i + 15], 16, 530742520)
      b = md5hh(b, c, d, a, x[i + 2], 23, -995338651)

      a = md5ii(a, b, c, d, x[i], 6, -198630844)
      d = md5ii(d, a, b, c, x[i + 7], 10, 1126891415)
      c = md5ii(c, d, a, b, x[i + 14], 15, -1416354905)
      b = md5ii(b, c, d, a, x[i + 5], 21, -57434055)
      a = md5ii(a, b, c, d, x[i + 12], 6, 1700485571)
      d = md5ii(d, a, b, c, x[i + 3], 10, -1894986606)
      c = md5ii(c, d, a, b, x[i + 10], 15, -1051523)
      b = md5ii(b, c, d, a, x[i + 1], 21, -2054922799)
      a = md5ii(a, b, c, d, x[i + 8], 6, 1873313359)
      d = md5ii(d, a, b, c, x[i + 15], 10, -30611744)
      c = md5ii(c, d, a, b, x[i + 6], 15, -1560198380)
      b = md5ii(b, c, d, a, x[i + 13], 21, 1309151649)
      a = md5ii(a, b, c, d, x[i + 4], 6, -145523070)
      d = md5ii(d, a, b, c, x[i + 11], 10, -1120210379)
      c = md5ii(c, d, a, b, x[i + 2], 15, 718787259)
      b = md5ii(b, c, d, a, x[i + 9], 21, -343485551)

      a = safeAdd(a, olda)
      b = safeAdd(b, oldb)
      c = safeAdd(c, oldc)
      d = safeAdd(d, oldd)
    }
    return [a, b, c, d]
  }

  /**
   * Convert an array of little-endian words to a string
   *
   * @param {Array<number>} input MD5 Array
   * @returns {string} MD5 string
   */
  function binl2rstr(input) {
    var i
    var output = ''
    var length32 = input.length * 32
    for (i = 0; i < length32; i += 8) {
      output += String.fromCharCode((input[i >> 5] >>> i % 32) & 0xff)
    }
    return output
  }

  /**
   * Convert a raw string to an array of little-endian words
   * Characters >255 have their high-byte silently ignored.
   *
   * @param {string} input Raw input string
   * @returns {Array<number>} Array of little-endian words
   */
  function rstr2binl(input) {
    var i
    var output = []
    output[(input.length >> 2) - 1] = undefined
    for (i = 0; i < output.length; i += 1) {
      output[i] = 0
    }
    var length8 = input.length * 8
    for (i = 0; i < length8; i += 8) {
      output[i >> 5] |= (input.charCodeAt(i / 8) & 0xff) << i % 32
    }
    return output
  }

  /**
   * Calculate the MD5 of a raw string
   *
   * @param {string} s Input string
   * @returns {string} Raw MD5 string
   */
  function rstrMD5(s) {
    return binl2rstr(binlMD5(rstr2binl(s), s.length * 8))
  }

  /**
   * Calculates the HMAC-MD5 of a key and some data (raw strings)
   *
   * @param {string} key HMAC key
   * @param {string} data Raw input string
   * @returns {string} Raw MD5 string
   */
  function rstrHMACMD5(key, data) {
    var i
    var bkey = rstr2binl(key)
    var ipad = []
    var opad = []
    var hash
    ipad[15] = opad[15] = undefined
    if (bkey.length > 16) {
      bkey = binlMD5(bkey, key.length * 8)
    }
    for (i = 0; i < 16; i += 1) {
      ipad[i] = bkey[i] ^ 0x36363636
      opad[i] = bkey[i] ^ 0x5c5c5c5c
    }
    hash = binlMD5(ipad.concat(rstr2binl(data)), 512 + data.length * 8)
    return binl2rstr(binlMD5(opad.concat(hash), 512 + 128))
  }

  /**
   * Convert a raw string to a hex string
   *
   * @param {string} input Raw input string
   * @returns {string} Hex encoded string
   */
  function rstr2hex(input) {
    var hexTab = '0123456789abcdef'
    var output = ''
    var x
    var i
    for (i = 0; i < input.length; i += 1) {
      x = input.charCodeAt(i)
      output += hexTab.charAt((x >>> 4) & 0x0f) + hexTab.charAt(x & 0x0f)
    }
    return output
  }

  /**
   * Encode a string as UTF-8
   *
   * @param {string} input Input string
   * @returns {string} UTF8 string
   */
  function str2rstrUTF8(input) {
    return unescape(encodeURIComponent(input))
  }

  /**
   * Encodes input string as raw MD5 string
   *
   * @param {string} s Input string
   * @returns {string} Raw MD5 string
   */
  function rawMD5(s) {
    return rstrMD5(str2rstrUTF8(s))
  }
  /**
   * Encodes input string as Hex encoded string
   *
   * @param {string} s Input string
   * @returns {string} Hex encoded string
   */
  function hexMD5(s) {
    return rstr2hex(rawMD5(s))
  }
  /**
   * Calculates the raw HMAC-MD5 for the given key and data
   *
   * @param {string} k HMAC key
   * @param {string} d Input string
   * @returns {string} Raw MD5 string
   */
  function rawHMACMD5(k, d) {
    return rstrHMACMD5(str2rstrUTF8(k), str2rstrUTF8(d))
  }
  /**
   * Calculates the Hex encoded HMAC-MD5 for the given key and data
   *
   * @param {string} k HMAC key
   * @param {string} d Input string
   * @returns {string} Raw MD5 string
   */
  function hexHMACMD5(k, d) {
    return rstr2hex(rawHMACMD5(k, d))
  }

  /**
   * Calculates MD5 value for a given string.
   * If a key is provided, calculates the HMAC-MD5 value.
   * Returns a Hex encoded string unless the raw argument is given.
   *
   * @param {string} string Input string
   * @param {string} [key] HMAC key
   * @param {boolean} [raw] Raw output switch
   * @returns {string} MD5 output
   */
  function md5(string, key, raw) {
    if (!key) {
      if (!raw) {
        return hexMD5(string)
      }
      return rawMD5(string)
    }
    if (!raw) {
      return hexHMACMD5(key, string)
    }
    return rawHMACMD5(key, string)
  }

	ctx.md5 = md5
})(this)

/***/ }),

/***/ 944:
/***/ (() => {

/*! @license sprintf.js | Copyright (c) 2007-2013 Alexandru Marasteanu <hello at alexei dot ro> | 3 clause BSD license */

(function() {
   var ctx = this || globalThis;

	var sprintf = function() {
		if (!sprintf.cache.hasOwnProperty(arguments[0])) {
			sprintf.cache[arguments[0]] = sprintf.parse(arguments[0]);
		}
		return sprintf.format.call(null, sprintf.cache[arguments[0]], arguments);
	};

	sprintf.format = function(parse_tree, argv) {
		var cursor = 1, tree_length = parse_tree.length, node_type = '', arg, output = [], i, k, match, pad, pad_character, pad_length;
		for (i = 0; i < tree_length; i++) {
			node_type = get_type(parse_tree[i]);
			if (node_type === 'string') {
				output.push(parse_tree[i]);
			}
			else if (node_type === 'array') {
				match = parse_tree[i]; // convenience purposes only
				if (match[2]) { // keyword argument
					arg = argv[cursor];
					for (k = 0; k < match[2].length; k++) {
						if (!arg.hasOwnProperty(match[2][k])) {
							throw(sprintf('[sprintf] property "%s" does not exist', match[2][k]));
						}
						arg = arg[match[2][k]];
					}
				}
				else if (match[1]) { // positional argument (explicit)
					arg = argv[match[1]];
				}
				else { // positional argument (implicit)
					arg = argv[cursor++];
				}

				if (/[^s]/.test(match[8]) && (get_type(arg) != 'number')) {
					throw(sprintf('[sprintf] expecting number but found %s', get_type(arg)));
				}
				switch (match[8]) {
					case 'b': arg = arg.toString(2); break;
					case 'c': arg = String.fromCharCode(arg); break;
					case 'd': arg = parseInt(arg, 10); break;
					case 'e': arg = match[7] ? arg.toExponential(match[7]) : arg.toExponential(); break;
					case 'f': arg = match[7] ? parseFloat(arg).toFixed(match[7]) : parseFloat(arg); break;
					case 'o': arg = arg.toString(8); break;
					case 's': arg = ((arg = String(arg)) && match[7] ? arg.substring(0, match[7]) : arg); break;
					case 'u': arg = arg >>> 0; break;
					case 'x': arg = arg.toString(16); break;
					case 'X': arg = arg.toString(16).toUpperCase(); break;
				}
				arg = (/[def]/.test(match[8]) && match[3] && arg >= 0 ? '+'+ arg : arg);
				pad_character = match[4] ? match[4] == '0' ? '0' : match[4].charAt(1) : ' ';
				pad_length = match[6] - String(arg).length;
				pad = match[6] ? str_repeat(pad_character, pad_length) : '';
				output.push(match[5] ? arg + pad : pad + arg);
			}
		}
		return output.join('');
	};

	sprintf.cache = {};

	sprintf.parse = function(fmt) {
		var _fmt = fmt, match = [], parse_tree = [], arg_names = 0;
		while (_fmt) {
			if ((match = /^[^\x25]+/.exec(_fmt)) !== null) {
				parse_tree.push(match[0]);
			}
			else if ((match = /^\x25{2}/.exec(_fmt)) !== null) {
				parse_tree.push('%');
			}
			else if ((match = /^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt)) !== null) {
				if (match[2]) {
					arg_names |= 1;
					var field_list = [], replacement_field = match[2], field_match = [];
					if ((field_match = /^([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
						field_list.push(field_match[1]);
						while ((replacement_field = replacement_field.substring(field_match[0].length)) !== '') {
							if ((field_match = /^\.([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else if ((field_match = /^\[(\d+)\]/.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else {
								throw('[sprintf] huh?');
							}
						}
					}
					else {
						throw('[sprintf] huh?');
					}
					match[2] = field_list;
				}
				else {
					arg_names |= 2;
				}
				if (arg_names === 3) {
					throw('[sprintf] mixing positional and named placeholders is not (yet) supported');
				}
				parse_tree.push(match);
			}
			else {
				throw('[sprintf] huh?');
			}
			_fmt = _fmt.substring(match[0].length);
		}
		return parse_tree;
	};

	var vsprintf = function(fmt, argv, _argv) {
		_argv = argv.slice(0);
		_argv.splice(0, 0, fmt);
		return sprintf.apply(null, _argv);
	};

	/**
	 * helpers
	 */
	function get_type(variable) {
		return Object.prototype.toString.call(variable).slice(8, -1).toLowerCase();
	}

	function str_repeat(input, multiplier) {
		for (var output = []; multiplier > 0; output[--multiplier] = input) {/* do nothing */}
		return output.join('');
	}

	/**
	 * export to either browser or node.js
	 */
	ctx.sprintf = sprintf;
	ctx.vsprintf = vsprintf;
})();



/***/ }),

/***/ 891:
/***/ (() => {

/*
 * Copyright 2014-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
(function () {
  var global = this || globalThis;
  var connect = global.connect || {};
  global.connect = connect;
  global.lily = connect;

  var userAgent = navigator.userAgent;
  var ONE_DAY_MILLIS = 24 * 60 * 60 * 1000;
  var DEFAULT_POPUP_HEIGHT = 578;
  var DEFAULT_POPUP_WIDTH = 433;
  var COPYABLE_EVENT_FIELDS = ["bubbles", "cancelBubble", "cancelable", "composed", "data", "defaultPrevented", "eventPhase", "isTrusted", "lastEventId", "origin", "returnValue", "timeStamp", "type"];

  /**
   * Unpollute sprintf functions from the global namespace.
   */
  connect.sprintf = global.sprintf;
  connect.vsprintf = global.vsprintf;
  delete global.sprintf;
  delete global.vsprintf;

  connect.HTTP_STATUS_CODES = {
    SUCCESS: 200,
    TOO_MANY_REQUESTS: 429,
    INTERNAL_SERVER_ERROR: 500
  };

  connect.TRANSPORT_TYPES = {
    CHAT_TOKEN: "chat_token",
    WEB_SOCKET: "web_socket"
  };

  /**
   * Binds the given instance object as the context for
   * the method provided.
   *
   * @param scope The instance object to be set as the scope
   *    of the function.
   * @param method The method to be encapsulated.
   *
   * All other arguments, if any, are bound to the method
   * invocation inside the closure.
   *
   * @return A closure encapsulating the invocation of the
   *    method provided in context of the given instance.
   */
  connect.hitch = function () {
    var args = Array.prototype.slice.call(arguments);
    var scope = args.shift();
    var method = args.shift();

    connect.assertNotNull(scope, 'scope');
    connect.assertNotNull(method, 'method');
    connect.assertTrue(connect.isFunction(method), 'method must be a function');

    return function () {
      var closureArgs = Array.prototype.slice.call(arguments);
      return method.apply(scope, args.concat(closureArgs));
    };
  };

  /**
   * Determine if the given value is a callable function type.
   * Borrowed from Underscore.js.
   */
  connect.isFunction = function (obj) {
    return !!(obj && obj.constructor && obj.call && obj.apply);
  };

  /**
   * Determine if the given value is an array.
   */
  connect.isArray = function (obj) {
    return Object.prototype.toString.call(obj) === '[object Array]';
  };

  /**
   * Get a list of keys from a Javascript object used
   * as a hash map.
   */
  connect.keys = function (map) {
    var keys = [];

    connect.assertNotNull(map, 'map');

    for (var k in map) {
      keys.push(k);
    }

    return keys;
  };

  /**
   * Get a list of values from a Javascript object used
   * as a hash map.
   */
  connect.values = function (map) {
    var values = [];

    connect.assertNotNull(map, 'map');

    for (var k in map) {
      values.push(map[k]);
    }

    return values;
  };

  /**
   * Get a list of key/value pairs from the given map.
   */
  connect.entries = function (map) {
    var entries = [];

    for (var k in map) {
      entries.push({ key: k, value: map[k] });
    }

    return entries;
  };

  /**
   * Merge two or more maps together into a new map,
   * or simply copy a single map.
   */
  connect.merge = function () {
    var argMaps = Array.prototype.slice.call(arguments, 0);
    var resultMap = {};

    argMaps.forEach(function (map) {
      connect.entries(map).forEach(function (kv) {
        resultMap[kv.key] = kv.value;
      });
    });

    return resultMap;
  };

  connect.now = function () {
    return new Date().getTime();
  };

  connect.find = function (array, predicate) {
    for (var x = 0; x < array.length; x++) {
      if (predicate(array[x])) {
        return array[x];
      }
    }

    return null;
  };

  connect.contains = function (obj, value) {
    if (obj instanceof Array) {
      return connect.find(obj, function (v) { return v === value; }) != null;

    } else {
      return (value in obj);
    }
  };

  connect.containsValue = function (obj, value) {
    if (obj instanceof Array) {
      return connect.find(obj, function (v) { return v === value; }) != null;

    } else {
      return connect.find(connect.values(obj), function (v) { return v === value; }) != null;
    }
  };

  /**
   * Generate a random ID consisting of the current timestamp
   * and a random base-36 number based on Math.random().
   */
  connect.randomId = function () {
    return connect.sprintf("%s-%s", connect.now(), Math.random().toString(36).slice(2));
  };

  /**
   * Generate an enum from the given list of lower-case enum values,
   * where the enum keys will be upper case.
   *
   * Conversion from pascal case based on code from here:
   * http://stackoverflow.com/questions/30521224
   */
  connect.makeEnum = function (values) {
    var enumObj = {};

    values.forEach(function (value) {
      var key = value.replace(/\.?([a-z]+)_?/g, function (x, y) { return y.toUpperCase() + "_"; })
        .replace(/_$/, "");

      enumObj[key] = value;
    });

    return enumObj;
  };

  connect.makeNamespacedEnum = function (prefix, values) {
    var enumObj = connect.makeEnum(values);
    connect.keys(enumObj).forEach(function (key) {
      enumObj[key] = connect.sprintf("%s::%s", prefix, enumObj[key]);
    });
    return enumObj;
  };

  connect.makeGenericNamespacedEnum = function (prefix, values, delimiter) {
    var enumObj = connect.makeEnum(values);
    connect.keys(enumObj).forEach(function (key) {
      enumObj[key] = connect.sprintf("%s"+delimiter+"%s", prefix, enumObj[key]);
    });
    return enumObj;
  };

  /**
  * Methods to determine browser type and versions, used for softphone initialization.
  */
  connect.isChromeBrowser = function () {
    return userAgent.indexOf("Chrome") !== -1;
  };

  connect.isFirefoxBrowser = function () {
    return userAgent.indexOf("Firefox") !== -1;
  };

  connect.isOperaBrowser = function () {
    return userAgent.indexOf("Opera") !== -1;
  };

  connect.getChromeBrowserVersion = function () {
    var chromeVersion = userAgent.substring(userAgent.indexOf("Chrome") + 7);
    if (chromeVersion) {
      return parseFloat(chromeVersion);
    } else {
      return -1;
    }
  };

  connect.getFirefoxBrowserVersion = function () {
    var firefoxVersion = userAgent.substring(userAgent.indexOf("Firefox") + 8);
    if (firefoxVersion) {
      return parseFloat(firefoxVersion);
    } else {
      return -1;
    }
  };

  connect.isValidLocale = function (locale) {
    var languages = [
      {
        id: 'en_US',
        label: 'English'
      },
      {
        id: 'de_DE',
        label: 'Deutsch'
      },
      {
        id: 'es_ES',
        label: 'Español'
      },
      {
        id: 'fr_FR',
        label: 'Français'
      },
      {
        id: 'ja_JP',
        label: '日本語'
      },
      {
        id: 'it_IT',
        label: 'Italiano'
      },
      {
        id: 'ko_KR',
        label: '한국어'
      },
      {
        id: 'pt_BR',
        label: 'Português'
      },
      {
        id: 'zh_CN',
        label: '中文(简体)'
      },
      {
        id: 'zh_TW',
        label: '中文(繁體)'
      }
    ];
    return languages.map(function(language){ return language.id}).includes(locale);
  }

  connect.getOperaBrowserVersion = function () {
    var versionOffset = userAgent.indexOf("Opera");
    var operaVersion = (userAgent.indexOf("Version") !== -1) ? userAgent.substring(versionOffset + 8) : userAgent.substring(versionOffset + 6);
    if (operaVersion) {
      return parseFloat(operaVersion);
    } else {
      return -1;
    }
  };

  /**
   * Return a map of items in the given list indexed by
   * keys determined by the closure provided.
   *
   * @param iterable A list-like object.
   * @param closure A closure to determine the index for the
   *    items in the iterable.
   * @return A map from index to item for each item in the iterable.
   */
  connect.index = function (iterable, closure) {
    var map = {};

    iterable.forEach(function (item) {
      map[closure(item)] = item;
    });

    return map;
  };

  /**
   * Converts the given array into a map as a set,
   * where elements in the array are mapped to 1.
   */
  connect.set = function (arrayIn) {
    var setMap = {};

    arrayIn.forEach(function (key) {
      setMap[key] = 1;
    });

    return setMap;
  };

  /**
   * Returns a map for each key in mapB which
   * is NOT in mapA.
   */
  connect.relativeComplement = function (mapA, mapB) {
    var compMap = {};

    connect.keys(mapB).forEach(function (key) {
      if (!(key in mapA)) {
        compMap[key] = mapB[key];
      }
    });

    return compMap;
  };

  /**
   * Asserts that a premise is true.
   */
  connect.assertTrue = function (premise, message) {
    if (!premise) {
      throw new connect.ValueError(message);
    }
  };

  /**
   * Asserts that a value is not null or undefined.
   */
  connect.assertNotNull = function (value, name) {
    connect.assertTrue(value != null && typeof value !== undefined,
      connect.sprintf("%s must be provided", name || 'A value'));
    return value;
  };

  connect.deepcopy = function (src) {
    return JSON.parse(JSON.stringify(src));
  };

  connect.deepcopyCrossOriginEvent = function(event) {
    const obj = {};
    const listOfAcceptableKeys = COPYABLE_EVENT_FIELDS;
    listOfAcceptableKeys.forEach((key) => {
      try {
        obj[key] = event[key];
      }
      catch(e) {
        connect.getLog().info("deepcopyCrossOriginEvent failed on key: ", key).sendInternalLogToServer();
      }
    });
    return connect.deepcopy(obj);
  }

  /**
   * Get the current base url of the open page, e.g. if the page is
   * https://example.com:9494/oranges, this will be "https://example.com:9494".
   */
  connect.getBaseUrl = function () {
    var location = global.location;
    return connect.sprintf("%s//%s:%s", location.protocol, location.hostname, location.port);
  };

  connect.getUrlWithProtocol = function(url) {
    var protocol = global.location.protocol;
    if (url.substr(0, protocol.length) !== protocol) {
      return connect.sprintf("%s//%s", protocol, url);
    }
    return url;
  }

  /**
   * Determine if the current window is in an iframe.
   * Courtesy: http://stackoverflow.com/questions/326069/
   */
  connect.isFramed = function () {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  };

  connect.hasOtherConnectedCCPs = function () {
    return connect.numberOfConnectedCCPs > 1;
  }

  connect.fetch = function (endpoint, options, milliInterval, maxRetry) {
    maxRetry = maxRetry || 5;
    milliInterval = milliInterval || 1000;
    options = options || {};
    return new Promise(function (resolve, reject) {
      function fetchData(maxRetry) {
        fetch(endpoint, options).then(function (res) {
          if (res.status === connect.HTTP_STATUS_CODES.SUCCESS) {
            res.json().then(json => resolve(json)).catch(() => resolve({}));
          } else if (maxRetry !== 1 && (res.status >= connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR || res.status === connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)) {
            setTimeout(function () {
              fetchData(--maxRetry);
            }, milliInterval);
          } else {
            reject(res);
          }
        }).catch(function (e) {
          reject(e);
        });
      }
      fetchData(maxRetry);
    });
  };

  /**
   * Calling a function with exponential backoff with full jitter retry strategy
   * It will retry calling the function for maximum maxRetry times if it fails.
   * Success callback will be called if the function succeeded.
   * Failure callback will be called only if the last try failed.
   */
  connect.backoff = function (func, milliInterval, maxRetry, callbacks) {
    connect.assertTrue(connect.isFunction(func), "func must be a Function");
    var self = this;
    var ratio = 2;

    func({
      success: function (data) {
        if (callbacks && callbacks.success) {
          callbacks.success(data);
        }
      },
      failure: function (err, data) {
        if (maxRetry > 0) {
          var interval = milliInterval * 2 * Math.random();
          global.setTimeout(function () {
            self.backoff(func, interval * ratio, --maxRetry, callbacks);
          }, interval);
        } else {
          if (callbacks && callbacks.failure) {
            callbacks.failure(err, data);
          }
        }
      }
    });
  };

  connect.publishMetric = function (metricData) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.CLIENT_METRIC,
      data: metricData
    });
  };

  connect.publishSoftphoneStats = function(stats) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.SOFTPHONE_STATS,
      data: stats
    });
  };

  connect.publishSoftphoneReport = function(report) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.SOFTPHONE_REPORT,
      data: report
    });
  };

  connect.publishClickStreamData = function(report) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.CLICK_STREAM_DATA,
      data: report
    });
  };

  connect.publishClientSideLogs = function(logs) {
    var bus = connect.core.getEventBus();
    bus.trigger(connect.EventType.CLIENT_SIDE_LOGS, logs);
  };

  connect.addNamespaceToLogs = function(namespace) {
    const methods = ['log', 'error', 'warn', 'info', 'debug'];

    methods.forEach((method) => {
      const consoleMethod = window.console[method];
      window.console[method] = function () {
        const args = Array.from(arguments);
        args.unshift(`[${namespace}]`);
        consoleMethod.apply(window.console, args);
      };
    });
  };

  /**
   * A wrapper around Window.open() for managing single instance popups.
   */
  connect.PopupManager = function () { };

  connect.PopupManager.prototype.open = function (url, name, options) {
    var then = this._getLastOpenedTimestamp(name);
    var now = new Date().getTime();
    var win = null;
    if (now - then > ONE_DAY_MILLIS) {
      if (options) {
        // default values are chosen to provide a minimum height without scrolling
        // and a uniform margin based on the css of the ccp login page
        var height = options.height || DEFAULT_POPUP_HEIGHT;
        var width = options.width || DEFAULT_POPUP_WIDTH;
        var top = options.top || 0;
        var left = options.left || 0;
        win = window.open('', name, "width="+width+", height="+height+", top="+top+", left="+left);
        if (win.location !== url) {
          win = window.open(url, name, "width="+width+", height="+height+", top="+top+", left="+left);
        }
      } else {
        win = window.open('', name);
        if (win.location !== url) {
          win = window.open(url, name);
        }
      }
      this._setLastOpenedTimestamp(name, now);
    }
    return win;
  };

  connect.PopupManager.prototype.clear = function (name) {
    var key = this._getLocalStorageKey(name);
    global.localStorage.removeItem(key);
  };

  connect.PopupManager.prototype._getLastOpenedTimestamp = function (name) {
    var key = this._getLocalStorageKey(name);
    var value = global.localStorage.getItem(key);

    if (value) {
      return parseInt(value, 10);

    } else {
      return 0;
    }
  };

  connect.PopupManager.prototype._setLastOpenedTimestamp = function (name, ts) {
    var key = this._getLocalStorageKey(name);
    global.localStorage.setItem(key, '' + ts);
  };

  connect.PopupManager.prototype._getLocalStorageKey = function (name) {
    return "connectPopupManager::" + name;
  };

  /**
   * An enumeration of the HTML5 notification permission values.
   */
  var NotificationPermission = connect.makeEnum([
    'granted',
    'denied',
    'default'
  ]);

  /**
   * A simple engine for showing notification popups.
   */
  connect.NotificationManager = function () {
    this.queue = [];
    this.permission = NotificationPermission.DEFAULT;
  };

  connect.NotificationManager.prototype.requestPermission = function () {
    var self = this;
    if (!("Notification" in global)) {
      connect.getLog().warn("This browser doesn't support notifications.").sendInternalLogToServer();
      this.permission = NotificationPermission.DENIED;

    } else if (global.Notification.permission === NotificationPermission.DENIED) {
      connect.getLog().warn("The user has requested to not receive notifications.").sendInternalLogToServer();
      this.permission = NotificationPermission.DENIED;

    } else if (this.permission !== NotificationPermission.GRANTED) {
      global.Notification.requestPermission().then(function (permission) {
        self.permission = permission;
        if (permission === NotificationPermission.GRANTED) {
          self._showQueued();

        } else {
          self.queue = [];
        }
      });
    }
  };

  connect.NotificationManager.prototype.show = function (title, options) {
    if (this.permission === NotificationPermission.GRANTED) {
      return this._showImpl({ title: title, options: options });

    } else if (this.permission === NotificationPermission.DENIED) {
      connect.getLog().warn("Unable to show notification.")
        .sendInternalLogToServer()
        .withObject({
          title: title,
          options: options
        });

    } else {
      var params = { title: title, options: options };
      connect.getLog().warn("Deferring notification until user decides to allow or deny.")
        .withObject(params)
        .sendInternalLogToServer();
      this.queue.push(params);
    }
  };

  connect.NotificationManager.prototype._showQueued = function () {
    var self = this;
    var notifications = this.queue.map(function (params) {
      return self._showImpl(params);
    });
    this.queue = [];
    return notifications;
  };

  connect.NotificationManager.prototype._showImpl = function (params) {
    var notification = new global.Notification(params.title, params.options);
    if (params.options.clicked) {
      notification.onclick = function () {
        params.options.clicked.call(notification);
      };
    }
    return notification;
  };

  connect.ValueError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.ValueError.prototype);
    return instance; 
  };
  Object.setPrototypeOf(connect.ValueError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.ValueError, Error);
  connect.ValueError.prototype.name = 'ValueError';

  connect.NotImplementedError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.NotImplementedError.prototype);
    return instance; 
  };
  Object.setPrototypeOf(connect.NotImplementedError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.NotImplementedError, Error);
  connect.NotImplementedError.prototype.name = 'NotImplementedError';

  connect.StateError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.StateError.prototype);
    return instance; 
  }
  Object.setPrototypeOf(connect.StateError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.StateError, Error);
  connect.StateError.prototype.name = 'StateError';



  connect.VoiceIdError = function(type, message, err){
    var error = {};
    error.type = type;
    error.message = message;
    error.stack = Error(message).stack;
    error.err = err;
    return error;
  }

  // internal use only
  connect.isCCP = function () {
    var conduit = connect.core.getUpstream();
    return conduit.name === 'ConnectSharedWorkerConduit';
  }

})();


/***/ })

/******/ 	});
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	__webpack_modules__[944]();
/******/ 	// This entry module is referenced by other modules so it can't be inlined
/******/ 	__webpack_modules__[163]();
/******/ 	__webpack_modules__[891]();
/******/ 	__webpack_modules__[772]();
/******/ 	var __webpack_exports__ = {};
/******/ 	__webpack_modules__[341]();
/******/ 	
/******/ })()
;