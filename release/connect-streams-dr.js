/******/ (() => { // webpackBootstrap
var __webpack_exports__ = {};
// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
(() => {
/*! @license sprintf.js | Copyright (c) 2007-2013 Alexandru Marasteanu <hello at alexei dot ro> | 3 clause BSD license */

(function() {
   var ctx = this;

	var sprintf = function() {
		if (!sprintf.cache.hasOwnProperty(arguments[0])) {
			sprintf.cache[arguments[0]] = sprintf.parse(arguments[0]);
		}
		return sprintf.format.call(null, sprintf.cache[arguments[0]], arguments);
	};

	sprintf.format = function(parse_tree, argv) {
		var cursor = 1, tree_length = parse_tree.length, node_type = '', arg, output = [], i, k, match, pad, pad_character, pad_length;
		for (i = 0; i < tree_length; i++) {
			node_type = get_type(parse_tree[i]);
			if (node_type === 'string') {
				output.push(parse_tree[i]);
			}
			else if (node_type === 'array') {
				match = parse_tree[i]; // convenience purposes only
				if (match[2]) { // keyword argument
					arg = argv[cursor];
					for (k = 0; k < match[2].length; k++) {
						if (!arg.hasOwnProperty(match[2][k])) {
							throw(sprintf('[sprintf] property "%s" does not exist', match[2][k]));
						}
						arg = arg[match[2][k]];
					}
				}
				else if (match[1]) { // positional argument (explicit)
					arg = argv[match[1]];
				}
				else { // positional argument (implicit)
					arg = argv[cursor++];
				}

				if (/[^s]/.test(match[8]) && (get_type(arg) != 'number')) {
					throw(sprintf('[sprintf] expecting number but found %s', get_type(arg)));
				}
				switch (match[8]) {
					case 'b': arg = arg.toString(2); break;
					case 'c': arg = String.fromCharCode(arg); break;
					case 'd': arg = parseInt(arg, 10); break;
					case 'e': arg = match[7] ? arg.toExponential(match[7]) : arg.toExponential(); break;
					case 'f': arg = match[7] ? parseFloat(arg).toFixed(match[7]) : parseFloat(arg); break;
					case 'o': arg = arg.toString(8); break;
					case 's': arg = ((arg = String(arg)) && match[7] ? arg.substring(0, match[7]) : arg); break;
					case 'u': arg = arg >>> 0; break;
					case 'x': arg = arg.toString(16); break;
					case 'X': arg = arg.toString(16).toUpperCase(); break;
				}
				arg = (/[def]/.test(match[8]) && match[3] && arg >= 0 ? '+'+ arg : arg);
				pad_character = match[4] ? match[4] == '0' ? '0' : match[4].charAt(1) : ' ';
				pad_length = match[6] - String(arg).length;
				pad = match[6] ? str_repeat(pad_character, pad_length) : '';
				output.push(match[5] ? arg + pad : pad + arg);
			}
		}
		return output.join('');
	};

	sprintf.cache = {};

	sprintf.parse = function(fmt) {
		var _fmt = fmt, match = [], parse_tree = [], arg_names = 0;
		while (_fmt) {
			if ((match = /^[^\x25]+/.exec(_fmt)) !== null) {
				parse_tree.push(match[0]);
			}
			else if ((match = /^\x25{2}/.exec(_fmt)) !== null) {
				parse_tree.push('%');
			}
			else if ((match = /^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt)) !== null) {
				if (match[2]) {
					arg_names |= 1;
					var field_list = [], replacement_field = match[2], field_match = [];
					if ((field_match = /^([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
						field_list.push(field_match[1]);
						while ((replacement_field = replacement_field.substring(field_match[0].length)) !== '') {
							if ((field_match = /^\.([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else if ((field_match = /^\[(\d+)\]/.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else {
								throw('[sprintf] huh?');
							}
						}
					}
					else {
						throw('[sprintf] huh?');
					}
					match[2] = field_list;
				}
				else {
					arg_names |= 2;
				}
				if (arg_names === 3) {
					throw('[sprintf] mixing positional and named placeholders is not (yet) supported');
				}
				parse_tree.push(match);
			}
			else {
				throw('[sprintf] huh?');
			}
			_fmt = _fmt.substring(match[0].length);
		}
		return parse_tree;
	};

	var vsprintf = function(fmt, argv, _argv) {
		_argv = argv.slice(0);
		_argv.splice(0, 0, fmt);
		return sprintf.apply(null, _argv);
	};

	/**
	 * helpers
	 */
	function get_type(variable) {
		return Object.prototype.toString.call(variable).slice(8, -1).toLowerCase();
	}

	function str_repeat(input, multiplier) {
		for (var output = []; multiplier > 0; output[--multiplier] = input) {/* do nothing */}
		return output.join('');
	}

	/**
	 * export to either browser or node.js
	 */
	ctx.sprintf = sprintf;
	ctx.vsprintf = vsprintf;
})();


})();

// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
(() => {
/*
 * Copyright 2014-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
(function () {
  var global = this;
  connect = global.connect || {};
  global.connect = connect;
  global.lily = connect;

  var userAgent = navigator.userAgent;
  var ONE_DAY_MILLIS = 24 * 60 * 60 * 1000;
  var DEFAULT_POPUP_HEIGHT = 578;
  var DEFAULT_POPUP_WIDTH = 433;
  var COPYABLE_EVENT_FIELDS = ["bubbles", "cancelBubble", "cancelable", "composed", "data", "defaultPrevented", "eventPhase", "isTrusted", "lastEventId", "origin", "returnValue", "timeStamp", "type"];

  /**
   * Unpollute sprintf functions from the global namespace.
   */
  connect.sprintf = global.sprintf;
  connect.vsprintf = global.vsprintf;
  delete global.sprintf;
  delete global.vsprintf;

  connect.HTTP_STATUS_CODES = {
    SUCCESS: 200,
    TOO_MANY_REQUESTS: 429,
    INTERNAL_SERVER_ERROR: 500
  };

  connect.TRANSPORT_TYPES = {
    CHAT_TOKEN: "chat_token",
    WEB_SOCKET: "web_socket"
  };

  /**
   * Binds the given instance object as the context for
   * the method provided.
   *
   * @param scope The instance object to be set as the scope
   *    of the function.
   * @param method The method to be encapsulated.
   *
   * All other arguments, if any, are bound to the method
   * invocation inside the closure.
   *
   * @return A closure encapsulating the invocation of the
   *    method provided in context of the given instance.
   */
  connect.hitch = function () {
    var args = Array.prototype.slice.call(arguments);
    var scope = args.shift();
    var method = args.shift();

    connect.assertNotNull(scope, 'scope');
    connect.assertNotNull(method, 'method');
    connect.assertTrue(connect.isFunction(method), 'method must be a function');

    return function () {
      var closureArgs = Array.prototype.slice.call(arguments);
      return method.apply(scope, args.concat(closureArgs));
    };
  };

  /**
   * Determine if the given value is a callable function type.
   * Borrowed from Underscore.js.
   */
  connect.isFunction = function (obj) {
    return !!(obj && obj.constructor && obj.call && obj.apply);
  };

  /**
   * Determine if the given value is an array.
   */
  connect.isArray = function (obj) {
    return Object.prototype.toString.call(obj) === '[object Array]';
  };

  /**
   * Get a list of keys from a Javascript object used
   * as a hash map.
   */
  connect.keys = function (map) {
    var keys = [];

    connect.assertNotNull(map, 'map');

    for (var k in map) {
      keys.push(k);
    }

    return keys;
  };

  /**
   * Get a list of values from a Javascript object used
   * as a hash map.
   */
  connect.values = function (map) {
    var values = [];

    connect.assertNotNull(map, 'map');

    for (var k in map) {
      values.push(map[k]);
    }

    return values;
  };

  /**
   * Get a list of key/value pairs from the given map.
   */
  connect.entries = function (map) {
    var entries = [];

    for (var k in map) {
      entries.push({ key: k, value: map[k] });
    }

    return entries;
  };

  /**
   * Merge two or more maps together into a new map,
   * or simply copy a single map.
   */
  connect.merge = function () {
    var argMaps = Array.prototype.slice.call(arguments, 0);
    var resultMap = {};

    argMaps.forEach(function (map) {
      connect.entries(map).forEach(function (kv) {
        resultMap[kv.key] = kv.value;
      });
    });

    return resultMap;
  };

  connect.now = function () {
    return new Date().getTime();
  };

  connect.find = function (array, predicate) {
    for (var x = 0; x < array.length; x++) {
      if (predicate(array[x])) {
        return array[x];
      }
    }

    return null;
  };

  connect.contains = function (obj, value) {
    if (obj instanceof Array) {
      return connect.find(obj, function (v) { return v === value; }) != null;

    } else {
      return (value in obj);
    }
  };

  connect.containsValue = function (obj, value) {
    if (obj instanceof Array) {
      return connect.find(obj, function (v) { return v === value; }) != null;

    } else {
      return connect.find(connect.values(obj), function (v) { return v === value; }) != null;
    }
  };

  /**
   * Generate a random ID consisting of the current timestamp
   * and a random base-36 number based on Math.random().
   */
  connect.randomId = function () {
    return connect.sprintf("%s-%s", connect.now(), Math.random().toString(36).slice(2));
  };

  /**
   * Generate an enum from the given list of lower-case enum values,
   * where the enum keys will be upper case.
   *
   * Conversion from pascal case based on code from here:
   * http://stackoverflow.com/questions/30521224
   */
  connect.makeEnum = function (values) {
    var enumObj = {};

    values.forEach(function (value) {
      var key = value.replace(/\.?([a-z]+)_?/g, function (x, y) { return y.toUpperCase() + "_"; })
        .replace(/_$/, "");

      enumObj[key] = value;
    });

    return enumObj;
  };

  connect.makeNamespacedEnum = function (prefix, values) {
    var enumObj = connect.makeEnum(values);
    connect.keys(enumObj).forEach(function (key) {
      enumObj[key] = connect.sprintf("%s::%s", prefix, enumObj[key]);
    });
    return enumObj;
  };

  connect.makeGenericNamespacedEnum = function (prefix, values, delimiter) {
    var enumObj = connect.makeEnum(values);
    connect.keys(enumObj).forEach(function (key) {
      enumObj[key] = connect.sprintf("%s"+delimiter+"%s", prefix, enumObj[key]);
    });
    return enumObj;
  };

  /**
  * Methods to determine browser type and versions, used for softphone initialization.
  */
  connect.isChromeBrowser = function () {
    return userAgent.indexOf("Chrome") !== -1;
  };

  connect.isFirefoxBrowser = function () {
    return userAgent.indexOf("Firefox") !== -1;
  };

  connect.isOperaBrowser = function () {
    return userAgent.indexOf("Opera") !== -1;
  };

  connect.getChromeBrowserVersion = function () {
    var chromeVersion = userAgent.substring(userAgent.indexOf("Chrome") + 7);
    if (chromeVersion) {
      return parseFloat(chromeVersion);
    } else {
      return -1;
    }
  };

  connect.getFirefoxBrowserVersion = function () {
    var firefoxVersion = userAgent.substring(userAgent.indexOf("Firefox") + 8);
    if (firefoxVersion) {
      return parseFloat(firefoxVersion);
    } else {
      return -1;
    }
  };

  connect.isValidLocale = function (locale) {
    var languages = [
      {
        id: 'en_US',
        label: 'English'
      },
      {
        id: 'de_DE',
        label: 'Deutsch'
      },
      {
        id: 'es_ES',
        label: 'Español'
      },
      {
        id: 'fr_FR',
        label: 'Français'
      },
      {
        id: 'ja_JP',
        label: '日本語'
      },
      {
        id: 'it_IT',
        label: 'Italiano'
      },
      {
        id: 'ko_KR',
        label: '한국어'
      },
      {
        id: 'pt_BR',
        label: 'Português'
      },
      {
        id: 'zh_CN',
        label: '中文(简体)'
      },
      {
        id: 'zh_TW',
        label: '中文(繁體)'
      }
    ];
    return languages.map(function(language){ return language.id}).includes(locale);
  }

  connect.getOperaBrowserVersion = function () {
    var versionOffset = userAgent.indexOf("Opera");
    var operaVersion = (userAgent.indexOf("Version") !== -1) ? userAgent.substring(versionOffset + 8) : userAgent.substring(versionOffset + 6);
    if (operaVersion) {
      return parseFloat(operaVersion);
    } else {
      return -1;
    }
  };

  /**
   * Return a map of items in the given list indexed by
   * keys determined by the closure provided.
   *
   * @param iterable A list-like object.
   * @param closure A closure to determine the index for the
   *    items in the iterable.
   * @return A map from index to item for each item in the iterable.
   */
  connect.index = function (iterable, closure) {
    var map = {};

    iterable.forEach(function (item) {
      map[closure(item)] = item;
    });

    return map;
  };

  /**
   * Converts the given array into a map as a set,
   * where elements in the array are mapped to 1.
   */
  connect.set = function (arrayIn) {
    var setMap = {};

    arrayIn.forEach(function (key) {
      setMap[key] = 1;
    });

    return setMap;
  };

  /**
   * Returns a map for each key in mapB which
   * is NOT in mapA.
   */
  connect.relativeComplement = function (mapA, mapB) {
    var compMap = {};

    connect.keys(mapB).forEach(function (key) {
      if (!(key in mapA)) {
        compMap[key] = mapB[key];
      }
    });

    return compMap;
  };

  /**
   * Asserts that a premise is true.
   */
  connect.assertTrue = function (premise, message) {
    if (!premise) {
      throw new connect.ValueError(message);
    }
  };

  /**
   * Asserts that a value is not null or undefined.
   */
  connect.assertNotNull = function (value, name) {
    connect.assertTrue(value != null && typeof value !== undefined,
      connect.sprintf("%s must be provided", name || 'A value'));
    return value;
  };

  connect.deepcopy = function (src) {
    return JSON.parse(JSON.stringify(src));
  };

  connect.deepcopyCrossOriginEvent = function(event) {
    const obj = {};
    const listOfAcceptableKeys = COPYABLE_EVENT_FIELDS;
    listOfAcceptableKeys.forEach((key) => {
      try {
        obj[key] = event[key];
      }
      catch(e) {
        connect.getLog().info("deepcopyCrossOriginEvent failed on key: ", key).sendInternalLogToServer();
      }
    });
    return connect.deepcopy(obj);
  }

  /**
   * Get the current base url of the open page, e.g. if the page is
   * https://example.com:9494/oranges, this will be "https://example.com:9494".
   */
  connect.getBaseUrl = function () {
    var location = global.location;
    return connect.sprintf("%s//%s:%s", location.protocol, location.hostname, location.port);
  };

  connect.getUrlWithProtocol = function(url) {
    var protocol = global.location.protocol;
    if (url.substr(0, protocol.length) !== protocol) {
      return connect.sprintf("%s//%s", protocol, url);
    }
    return url;
  }

  /**
   * Determine if the current window is in an iframe.
   * Courtesy: http://stackoverflow.com/questions/326069/
   */
  connect.isFramed = function () {
    try {
      return window.self !== window.top;
    } catch (e) {
      return true;
    }
  };

  connect.hasOtherConnectedCCPs = function () {
    return connect.numberOfConnectedCCPs > 1;
  }

  connect.fetch = function (endpoint, options, milliInterval, maxRetry) {
    maxRetry = maxRetry || 5;
    milliInterval = milliInterval || 1000;
    options = options || {};
    return new Promise(function (resolve, reject) {
      function fetchData(maxRetry) {
        fetch(endpoint, options).then(function (res) {
          if (res.status === connect.HTTP_STATUS_CODES.SUCCESS) {
            res.json().then(json => resolve(json)).catch(() => resolve({}));
          } else if (maxRetry !== 1 && (res.status >= connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR || res.status === connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)) {
            setTimeout(function () {
              fetchData(--maxRetry);
            }, milliInterval);
          } else {
            reject(res);
          }
        }).catch(function (e) {
          reject(e);
        });
      }
      fetchData(maxRetry);
    });
  };

  /**
   * Calling a function with exponential backoff with full jitter retry strategy
   * It will retry calling the function for maximum maxRetry times if it fails.
   * Success callback will be called if the function succeeded.
   * Failure callback will be called only if the last try failed.
   */
  connect.backoff = function (func, milliInterval, maxRetry, callbacks) {
    connect.assertTrue(connect.isFunction(func), "func must be a Function");
    var self = this;
    var ratio = 2;

    func({
      success: function (data) {
        if (callbacks && callbacks.success) {
          callbacks.success(data);
        }
      },
      failure: function (err, data) {
        if (maxRetry > 0) {
          var interval = milliInterval * 2 * Math.random();
          global.setTimeout(function () {
            self.backoff(func, interval * ratio, --maxRetry, callbacks);
          }, interval);
        } else {
          if (callbacks && callbacks.failure) {
            callbacks.failure(err, data);
          }
        }
      }
    });
  };

  connect.publishMetric = function (metricData) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.CLIENT_METRIC,
      data: metricData
    });
  };

  connect.publishSoftphoneStats = function(stats) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.SOFTPHONE_STATS,
      data: stats
    });
  };

  connect.publishSoftphoneReport = function(report) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.SOFTPHONE_REPORT,
      data: report
    });
  };

  connect.publishClickStreamData = function(report) {
    connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST, {
      event: connect.EventType.CLICK_STREAM_DATA,
      data: report
    });
  };

  connect.publishClientSideLogs = function(logs) {
    var bus = connect.core.getEventBus();
    bus.trigger(connect.EventType.CLIENT_SIDE_LOGS, logs);
  };

  connect.addNamespaceToLogs = function(namespace) {
    const methods = ['log', 'error', 'warn', 'info', 'debug'];

    methods.forEach((method) => {
      const consoleMethod = window.console[method];
      window.console[method] = function () {
        const args = Array.from(arguments);
        args.unshift(`[${namespace}]`);
        consoleMethod.apply(window.console, args);
      };
    });
  };

  /**
   * A wrapper around Window.open() for managing single instance popups.
   */
  connect.PopupManager = function () { };

  connect.PopupManager.prototype.open = function (url, name, options) {
    var then = this._getLastOpenedTimestamp(name);
    var now = new Date().getTime();
    var win = null;
    if (now - then > ONE_DAY_MILLIS) {
      if (options) {
        // default values are chosen to provide a minimum height without scrolling
        // and a uniform margin based on the css of the ccp login page
        var height = options.height || DEFAULT_POPUP_HEIGHT;
        var width = options.width || DEFAULT_POPUP_WIDTH;
        var top = options.top || 0;
        var left = options.left || 0;
        win = window.open('', name, "width="+width+", height="+height+", top="+top+", left="+left);
        if (win.location !== url) {
          win = window.open(url, name, "width="+width+", height="+height+", top="+top+", left="+left);
        }
      } else {
        win = window.open('', name);
        if (win.location !== url) {
          win = window.open(url, name);
        }
      }
      this._setLastOpenedTimestamp(name, now);
    }
    return win;
  };

  connect.PopupManager.prototype.clear = function (name) {
    var key = this._getLocalStorageKey(name);
    global.localStorage.removeItem(key);
  };

  connect.PopupManager.prototype._getLastOpenedTimestamp = function (name) {
    var key = this._getLocalStorageKey(name);
    var value = global.localStorage.getItem(key);

    if (value) {
      return parseInt(value, 10);

    } else {
      return 0;
    }
  };

  connect.PopupManager.prototype._setLastOpenedTimestamp = function (name, ts) {
    var key = this._getLocalStorageKey(name);
    global.localStorage.setItem(key, '' + ts);
  };

  connect.PopupManager.prototype._getLocalStorageKey = function (name) {
    return "connectPopupManager::" + name;
  };

  /**
   * An enumeration of the HTML5 notification permission values.
   */
  var NotificationPermission = connect.makeEnum([
    'granted',
    'denied',
    'default'
  ]);

  /**
   * A simple engine for showing notification popups.
   */
  connect.NotificationManager = function () {
    this.queue = [];
    this.permission = NotificationPermission.DEFAULT;
  };

  connect.NotificationManager.prototype.requestPermission = function () {
    var self = this;
    if (!("Notification" in global)) {
      connect.getLog().warn("This browser doesn't support notifications.").sendInternalLogToServer();
      this.permission = NotificationPermission.DENIED;

    } else if (global.Notification.permission === NotificationPermission.DENIED) {
      connect.getLog().warn("The user has requested to not receive notifications.").sendInternalLogToServer();
      this.permission = NotificationPermission.DENIED;

    } else if (this.permission !== NotificationPermission.GRANTED) {
      global.Notification.requestPermission().then(function (permission) {
        self.permission = permission;
        if (permission === NotificationPermission.GRANTED) {
          self._showQueued();

        } else {
          self.queue = [];
        }
      });
    }
  };

  connect.NotificationManager.prototype.show = function (title, options) {
    if (this.permission === NotificationPermission.GRANTED) {
      return this._showImpl({ title: title, options: options });

    } else if (this.permission === NotificationPermission.DENIED) {
      connect.getLog().warn("Unable to show notification.")
        .sendInternalLogToServer()
        .withObject({
          title: title,
          options: options
        });

    } else {
      var params = { title: title, options: options };
      connect.getLog().warn("Deferring notification until user decides to allow or deny.")
        .withObject(params)
        .sendInternalLogToServer();
      this.queue.push(params);
    }
  };

  connect.NotificationManager.prototype._showQueued = function () {
    var self = this;
    var notifications = this.queue.map(function (params) {
      return self._showImpl(params);
    });
    this.queue = [];
    return notifications;
  };

  connect.NotificationManager.prototype._showImpl = function (params) {
    var notification = new global.Notification(params.title, params.options);
    if (params.options.clicked) {
      notification.onclick = function () {
        params.options.clicked.call(notification);
      };
    }
    return notification;
  };

  connect.ValueError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.ValueError.prototype);
    return instance; 
  };
  Object.setPrototypeOf(connect.ValueError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.ValueError, Error);
  connect.ValueError.prototype.name = 'ValueError';

  connect.NotImplementedError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.NotImplementedError.prototype);
    return instance; 
  };
  Object.setPrototypeOf(connect.NotImplementedError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.NotImplementedError, Error);
  connect.NotImplementedError.prototype.name = 'NotImplementedError';

  connect.StateError = function () {
    var args = Array.prototype.slice.call(arguments, 0);
    var format = args.shift();
    var instance = new Error(connect.vsprintf(format, args));
    Object.setPrototypeOf(instance, connect.StateError.prototype);
    return instance; 
  }
  Object.setPrototypeOf(connect.StateError.prototype, Error.prototype);
  Object.setPrototypeOf(connect.StateError, Error);
  connect.StateError.prototype.name = 'StateError';



  connect.VoiceIdError = function(type, message, err){
    var error = {};
    error.type = type;
    error.message = message;
    error.stack = Error(message).stack;
    error.err = err;
    return error;
  }

  // internal use only
  connect.isCCP = function () {
    var conduit = connect.core.getUpstream();
    return conduit.name === 'ConnectSharedWorkerConduit';
  }

})();

})();

// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
(() => {
/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
 
(function () {
  var global = this;
  connect = global.connect || {};
  global.connect = connect;
  global.globalConnect = {}
  global.lily = connect;

  globalConnect.Container = null;

  var FRAME_DIMENSIONS = "margin: 0; border: 0; padding: 0px; width: 0px; height: 0px";

  var LATEST_STREAMJS_BASE64_CODE = "LyoqKioqKi8gKCgpID0+IHsgLy8gd2VicGFja0Jvb3RzdHJhcAovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVzX18gPSAoewoKLyoqKi8gODIxOgovKioqLyAoKCkgPT4gewoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5hZ2VudEFwcCA9IHt9OwoKICB2YXIgQVBQID0gewogICAgQ0NQOiAnY2NwJywKICB9OwoKICBjb25uZWN0LmFnZW50QXBwLmluaXRDQ1AgPSBjb25uZWN0LmNvcmUuaW5pdENDUDsKICBjb25uZWN0LmFnZW50QXBwLmlzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoaW5zdGFuY2VBbGlhcykge307CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcENvbW11bmljYXRpb24gPSBmdW5jdGlvbiAoaWZyYW1lSWQsIGVuZHBvaW50KSB7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWZyYW1lSWQpOwogICAgdmFyIGlmcmFtZUNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KGVuZHBvaW50LCB3aW5kb3csIGlmcmFtZSk7CiAgICB2YXIgQlJPQURDQVNUX1RZUEUgPSBbCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsCiAgICAgIGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsCiAgICAgIGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVECiAgICBdOwogICAgaWZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoZSkgewogICAgICBCUk9BRENBU1RfVFlQRS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbSh0eXBlLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWZyYW1lQ29uZHVpdC5zZW5kVXBzdHJlYW0odHlwZSwgZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIGdldENvbm5lY3RVcmwgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgcG9zID0gY2NwVXJsLmluZGV4T2YoJ2NjcC12MicpOwogICAgcmV0dXJuIGNjcFVybC5zbGljZSgwLCBwb3MgLSAxKTsKICB9OwoKICB2YXIgc2lnbk91dFRocm91Z2hDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgbG9nb3V0VXJsID0gZ2V0Q29ubmVjdFVybChjY3BVcmwpICsgJy9sb2dvdXQnOwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2gobG9nb3V0VXJsLCB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGV2ZW50QnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25uZWN0CiAgICAgICAgLmdldExvZygpCiAgICAgICAgLmVycm9yKCdBbiBlcnJvciBvY2N1cmVkIG9uIGxvZ291dC4nICsgZSkKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBsb2dvdXRVcmw7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogIH07CgogIHZhciBzaWduSW5UaHJvdWdoaW5pdENDUCA9IGZ1bmN0aW9uIChjY3BVcmwsIGNvbnRhaW5lciwgY29uZmlnKSB7CiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgY2NwVXJsOiBjY3BVcmwsCiAgICAgIGNjcExvYWRUaW1lb3V0OiAxMDAwMCwKICAgICAgbG9naW5Qb3B1cDogdHJ1ZSwKICAgICAgbG9naW5Vcmw6IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9naW4nLAogICAgICBzb2Z0cGhvbmU6IHsKICAgICAgICBhbGxvd0ZyYW1lZFNvZnRwaG9uZTogdHJ1ZSwKICAgICAgICBkaXNhYmxlUmluZ3RvbmU6IGZhbHNlLAogICAgICB9CiAgICB9OwogICAgdmFyIGNjcFBhcmFtcyA9IGNvbm5lY3QubWVyZ2UoZGVmYXVsdFBhcmFtcywgY29uZmlnLmNjcFBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENDUChjb250YWluZXIsIGNjcFBhcmFtcyk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwID0gZnVuY3Rpb24gKG5hbWUsIGNvbnRhaW5lcklkLCBhcHBVcmwsIGNvbmZpZykgewogICAgY29uZmlnID0gY29uZmlnID8gY29uZmlnIDoge307CiAgICB2YXIgZW5kcG9pbnQgPSBhcHBVcmwuZW5kc1dpdGgoJy8nKSA/IGFwcFVybCA6IGFwcFVybCArICcvJzsKICAgIHZhciBvbkxvYWQgPSBjb25maWcub25Mb2FkID8gY29uZmlnLm9uTG9hZCA6IG51bGw7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSwgb25Mb2FkOiBvbkxvYWQgfTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgcmVnaXN0ZXJDb25maWcsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKSk7CiAgICBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0YXJ0KG5hbWUsIGZ1bmN0aW9uIChtb2R1bGVEYXRhKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGEuZW5kcG9pbnQ7CiAgICAgIHZhciBjb250YWluZXJET00gPSBtb2R1bGVEYXRhLmNvbnRhaW5lckRPTTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgewogICAgICAgICAgICBjb25maWcuY2NwUGFyYW1zID0gY29uZmlnLmNjcFBhcmFtcyA/IGNvbmZpZy5jY3BQYXJhbXMgOiB7fTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5zdHlsZSkgY29uZmlnLmNjcFBhcmFtcy5zdHlsZSA9IGNvbmZpZy5zdHlsZTsKICAgICAgICAgICAgcmV0dXJuIHNpZ25JblRocm91Z2hpbml0Q0NQKGVuZHBvaW50LCBjb250YWluZXJET00sIGNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbihuYW1lLCBlbmRwb2ludCk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25PdXRUaHJvdWdoQ0NQKGVuZHBvaW50KTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuc3RvcEFwcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5zdG9wKG5hbWUpOwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA1MDA6Ci8qKiovICgoKSA9PiB7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGZ1bmN0aW9uIEFwcFJlZ2lzdHJ5KCkgewogICAgdmFyIG1vZHVsZURhdGEgPSB7fTsKICAgIHZhciBtYWtlQXBwSWZyYW1lID0gZnVuY3Rpb24gKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgICBvbkxvYWQ6IGNvbmZpZy5vbkxvYWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICB2YXIgb25Mb2FkID0gbW9kdWxlRGF0YVthcHBOYW1lXS5vbkxvYWQ7CiAgICAgICAgaWYgKGFwcE5hbWUgIT09IEFQUC5DQ1ApIHsKICAgICAgICAgIHZhciBhcHAgPSBtYWtlQXBwSWZyYW1lKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTY1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0ludmFsaWRMb2NhbGUnLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcKICBdKTsKICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0dXNUeXBlID0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3Quc2V0KFsKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xECiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgICAnZGlzY29ubmVjdCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ29udGFjdFJlY29yZGluZyBWb2ljZSBUcmFjayBjb25maWcKICAgKi8KICBjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnQUxMJywKICAgICdUT19BR0VOVCcsCiAgICAnRlJPTV9BR0VOVCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgTW9uaXRvcmluZ01vZGUKICAgKi8KICBjb25uZWN0Lk1vbml0b3JpbmdNb2RlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnU0lMRU5UX01PTklUT1InLAogICAgJ0JBUkdFJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBNb25pdG9yaW5nRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuTW9uaXRvcmluZ0Vycm9yVHlwZXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbnZhbGlkX3RhcmdldF9zdGF0ZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENoYW5uZWxUeXBlCiAgKi8KICBjb25uZWN0LkNoYW5uZWxUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnVk9JQ0UnLAogICAgJ0NIQVQnLAogICAgJ1RBU0snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBNZWRpYVR5cGUKICAqLwogIGNvbm5lY3QuTWVkaWFUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnc29mdHBob25lJywKICAgICdjaGF0JywKICAgICd0YXNrJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNvZnRwaG9uZUNhbGxUeXBlCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2F1ZGlvX3ZpZGVvJywKICAgICd2aWRlb19vbmx5JywKICAgICdhdWRpb19vbmx5JywKICAgICdub25lJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBTb2Z0cGhvbmVFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndW5zdXBwb3J0ZWRfYnJvd3NlcicsCiAgICAnbWljcm9waG9uZV9ub3Rfc2hhcmVkJywKICAgICdzaWduYWxsaW5nX2hhbmRzaGFrZV9mYWlsdXJlJywKICAgICdzaWduYWxsaW5nX2Nvbm5lY3Rpb25fZmFpbHVyZScsCiAgICAnaWNlX2NvbGxlY3Rpb25fdGltZW91dCcsCiAgICAndXNlcl9idXN5X2Vycm9yJywKICAgICd3ZWJydGNfZXJyb3InLAogICAgJ3JlYWx0aW1lX2NvbW11bmljYXRpb25fZXJyb3InLAogICAgJ290aGVyJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDbGlja1R5cGUKICAgKi8KICBjb25uZWN0LkNsaWNrVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ0FjY2VwdCcsCiAgICAnUmVqZWN0JywKICAgICdIYW5ndXAnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWRFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ25vX3NwZWFrZXJfaWRfZm91bmQnLAogICAgJ3NwZWFrZXJfaWRfbm90X2Vucm9sbGVkJywKICAgICdnZXRfc3BlYWtlcl9pZF9mYWlsZWQnLAogICAgJ2dldF9zcGVha2VyX3N0YXR1c19mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9pbl9sY21zX2ZhaWxlZCcsCiAgICAnZGVsZXRlX3NwZWFrZXJfZmFpbGVkJywKICAgICdzdGFydF9zZXNzaW9uX2ZhaWxlZCcsCiAgICAnZXZhbHVhdGVfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3Nlc3Npb25fbm90X2V4aXN0cycsCiAgICAnZGVzY3JpYmVfc2Vzc2lvbl9mYWlsZWQnLAogICAgJ2Vucm9sbF9zcGVha2VyX2ZhaWxlZCcsCiAgICAndXBkYXRlX3NwZWFrZXJfaWRfZmFpbGVkJywKICAgICd1cGRhdGVfc3BlYWtlcl9pZF9pbl9sY21zX2ZhaWxlZCcsCiAgICAnbm90X3N1cHBvcnRlZF9vbl9jb25mZXJlbmNlX2NhbGxzJywKICAgICdlbnJvbGxfc3BlYWtlcl90aW1lb3V0JywKICAgICdldmFsdWF0ZV9zcGVha2VyX3RpbWVvdXQnLAogICAgJ2dldF9kb21haW5faWRfZmFpbGVkJywKICAgICdub19kb21haW5faWRfZm91bmQnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIENUSSBleGNlcHRpb25zCiAgICovCiAgY29ubmVjdC5DVElFeGNlcHRpb25zID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQWNjZXNzRGVuaWVkRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkU3RhdGVFeGNlcHRpb24iLAogICAgIkJhZEVuZHBvaW50RXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQWdlbnRBUk5FeGNlcHRpb24iLAogICAgIkludmFsaWRDb25maWd1cmF0aW9uRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQ29udGFjdFR5cGVFeGNlcHRpb24iLAogICAgIlBhZ2luYXRpb25FeGNlcHRpb24iLAogICAgIlJlZnJlc2hUb2tlbkV4cGlyZWRFeGNlcHRpb24iLAogICAgIlNlbmREYXRhRmFpbGVkRXhjZXB0aW9uIiwKICAgICJVbmF1dGhvcml6ZWRFeGNlcHRpb24iLAogICAgIlF1b3RhRXhjZWVkZWRFeGNlcHRpb24iCiAgXSk7CiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBzdHJlYW1pbmcgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiT05HT0lORyIsCiAgICAiRU5ERUQiLAogICAgIlBFTkRJTkdfQ09ORklHVVJBVElPTiIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBQ0NFUFQiLAogICAgIlJFSkVDVCIsCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIlNQRUFLRVJfTk9UX0VOUk9MTEVEIiwKICAgICJTUEVBS0VSX09QVEVEX09VVCIsCiAgICAiU1BFQUtFUl9JRF9OT1RfUFJPVklERUQiLAogICAgIlNQRUFLRVJfRVhQSVJFRCIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBmcmF1ZCBkZXRlY3Rpb24gZGVjaXNpb24KICAgKi8KICBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIkhJR0hfUklTSyIsCiAgICAiTE9XX1JJU0siCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIGNvbnRhY3QgZmxvdyBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQXV0aGVudGljYXRlZCIsCiAgICAiTm90QXV0aGVudGljYXRlZCIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbnJvbGxlZCIsCiAgICAiT3B0ZWRPdXQiLAogICAgIk5vdEVuYWJsZWQiLAogICAgIkVycm9yIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgIGZyYXVkIGRldGVjdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiSGlnaFJpc2siLAogICAgIkxvd1Jpc2siLAogICAgIkluY29uY2x1c2l2ZSIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgRW5yb2xsbWVudFJlcXVlc3QgU3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSU5fUFJPR1JFU1MiLAogICAgIkNPTVBMRVRFRCIsCiAgICAiRkFJTEVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIFNwZWFrZXIgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9QVEVEX09VVCIsCiAgICAiRU5ST0xMRUQiLAogICAgIlBFTkRJTkciCiAgXSk7CgogIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cyA9IHsKICAgIEVWQUxVQVRFX1NFU1NJT05fREVMQVk6IDEwMDAwLAogICAgRVZBTFVBVElPTl9NQVhfUE9MTF9USU1FUzogMjQsIC8vIEV2YWx1YXRlU3BlYWtlciBpcyBQb2xsaW5nIGZvciBtYXhpbXVtIDIgbWlucy4KICAgIEVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTDogNTAwMCwKICAgIEVOUk9MTE1FTlRfTUFYX1BPTExfVElNRVM6IDEyMCwgLy8gRW5yb2xsbWVudFNwZWFrZXIgaXMgUG9sbGluZyBmb3IgbWF4aW11bSAxMCBtaW5zLgogICAgRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMOiA1MDAwLAogICAgU1RBUlRfU0VTU0lPTl9ERUxBWTogODAwMAogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29uc3RhbnRzIGZvciBBZ2VudFBlcm1pc3Npb25zCiAgICovCiAgY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zID0gewogICAgT1VUQk9VTkRfQ0FMTDogJ291dGJvdW5kQ2FsbCcsCiAgICBWT0lDRV9JRDogJ3ZvaWNlSWQnLAogICAgQ09OVEFDVF9SRUNPUkRJTkc6ICdjb250YWN0UmVjb3JkaW5nJwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50CiAgICovCiAgdmFyIEFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoIlRoZSBhZ2VudCBpcyBub3QgeWV0IGluaXRpYWxpemVkISIpOwogICAgfQogIH07CgogIEFnZW50LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2NyZWF0ZUNvbnRhY3RBUEkgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUmVmcmVzaCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUm91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Ob3RSb3V0YWJsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25PZmZsaW5lID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNvZnRwaG9uZUVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25HYWluZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25BZnRlckNhbGxXb3JrID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1csIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Mb2NhbE1lZGlhU3RyZWFtQ3JlYXRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNwZWFrZXJEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbk1pY3JvcGhvbmVEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vblJpbmdlckRldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5zdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmV4dFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5uZXh0U3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEF2YWlsYWJpbGl0eVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5hZ2VudEF2YWlsYWJpbGl0eVN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc25hcHNob3Quc3RhdGUuc3RhcnRUaW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQWdlbnQucHJvdG90eXBlLmdldFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnBlcm1pc3Npb25zOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb250YWN0cyA9IGZ1bmN0aW9uIChjb250YWN0VHlwZUZpbHRlcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5jb250YWN0cy5tYXAoZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVDb250YWN0QVBJKGNvbnRhY3REYXRhKTsKICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gKCFjb250YWN0VHlwZUZpbHRlcikgfHwgY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbnRhY3RUeXBlRmlsdGVyOwogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbmZpZ3VyYXRpb247CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFnZW50U3RhdGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmFnZW50U3RhdGVzOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5ID0gZnVuY3Rpb24gKGNoYW5uZWwpIHsKICAgIHZhciBjaGFubmVsQ29uY3VycmVuY3lNYXAgPSB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuY2hhbm5lbENvbmN1cnJlbmN5TWFwOwogICAgaWYgKCFjaGFubmVsQ29uY3VycmVuY3lNYXApIHsKICAgICAgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gT2JqZWN0LmtleXMoY29ubmVjdC5DaGFubmVsVHlwZSkucmVkdWNlKGZ1bmN0aW9uIChhY2MsIGtleSkgewogICAgICAgIC8vIEV4Y2x1ZGUgVEFTSyBmcm9tIGRlZmF1bHQgY29uY3VycmVuY3kuCiAgICAgICAgaWYgKGtleSAhPT0gJ1RBU0snKSB7CiAgICAgICAgICBhY2NbY29ubmVjdC5DaGFubmVsVHlwZVtrZXldXSA9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhY2M7CiAgICAgIH0sIHt9KTsKICAgIH0KICAgIHJldHVybiBjaGFubmVsCiAgICAgID8gKGNoYW5uZWxDb25jdXJyZW5jeU1hcFtjaGFubmVsXSB8fCAwKQogICAgICA6IGNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5uYW1lOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFeHRlbnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZXh0ZW5zaW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXREaWFsYWJsZUNvdW50cmllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5kaWFsYWJsZUNvdW50cmllczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuaXNTb2Z0cGhvbmVFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUVuYWJsZWQ7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgaWYgKGNvbmZpZ3VyYXRpb24gJiYgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzICYmIGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRSAmJiAhY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSkgewogICAgICAvLyB3b3JrYXJvdW5kIGZvciB0aGUgaW5jb25zaXN0ZW5jeSBpc3N1ZSB0aGF0IGdldEFnZW50Q29uZmlndXJhdGlvbiByZXR1cm5zIGFnZW50UHJlZmVyZW5jZXMuTEFOR1VBR0UgYnV0IHVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiBleHBlY3RzIGFnZW50UHJlZmVyZW5jZXMubG9jYWxlIHRvIGJlIHNldC4KICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSA9IGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRTsKICAgIH0KCiAgICBpZiAoY29uZmlndXJhdGlvbiAmJiBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMgJiYgIWNvbm5lY3QuaXNWYWxpZExvY2FsZShjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMubG9jYWxlKSkgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzLklOVkFMSURfTE9DQUxFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OLCB7CiAgICAgICAgY29uZmlndXJhdGlvbjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmZpZ3VyYXRpb24sICdjb25maWd1cmF0aW9uJykKICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBhc2sgdGhlIHNoYXJlZCB3b3JrZXIgdG8gcmVsb2FkIGFnZW50IGNvbmZpZwogICAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjYWxsYmFja3MsIG9wdGlvbnMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUFVUX0FHRU5UX1NUQVRFLCB7CiAgICAgIHN0YXRlOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3RhdGUsICdzdGF0ZScpLAogICAgICBlbnF1ZXVlTmV4dFN0YXRlOiBvcHRpb25zICYmICEhb3B0aW9ucy5lbnF1ZXVlTmV4dFN0YXRlCiAgICB9LCBjYWxsYmFja3MpOwogIH07CiAgQWdlbnQucHJvdG90eXBlLm9uRW5xdWV1ZWROZXh0U3RhdGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVOUVVFVUVEX05FWFRfU1RBVEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5jb25uZWN0ID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIHBhcmFtcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfT1VUQk9VTkRfQ09OVEFDVCwgewogICAgICBlbmRwb2ludDogY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKSwKICAgICAgcXVldWVBUk46IChwYXJhbXMgJiYgKHBhcmFtcy5xdWV1ZUFSTiB8fCBwYXJhbXMucXVldWVJZCkpIHx8IHRoaXMuZ2V0Um91dGluZ1Byb2ZpbGUoKS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTgogICAgfSwgcGFyYW1zICYmIHsKICAgICAgICBzdWNjZXNzOiBwYXJhbXMuc3VjY2VzcywKICAgICAgICBmYWlsdXJlOiBwYXJhbXMuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWxsUXVldWVBUk5zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5tYXAoZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgIHJldHVybiBxdWV1ZS5xdWV1ZUFSTjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFbmRwb2ludHMgPSBmdW5jdGlvbiAocXVldWVBUk5zLCBjYWxsYmFja3MsIHBhZ2VJbmZvSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLCAiY2FsbGJhY2tzIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLnN1Y2Nlc3MsICJjYWxsYmFja3Muc3VjY2VzcyIpOwogICAgdmFyIHBhZ2VJbmZvID0gcGFnZUluZm9JbiB8fCB7IH07CgogICAgcGFnZUluZm8uZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzIHx8IFtdOwogICAgcGFnZUluZm8ubWF4UmVzdWx0cyA9IHBhZ2VJbmZvLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgYWxsb3dpbmcgYSBzaW5nbGUgcXVldWVBUk4gdG8gYmUgc3BlY2lmaWVkCiAgICAvLyBpbnN0ZWFkIG9mIGFuIGFycmF5LgogICAgaWYgKCFjb25uZWN0LmlzQXJyYXkocXVldWVBUk5zKSkgewogICAgICBxdWV1ZUFSTnMgPSBbcXVldWVBUk5zXTsKICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0VORFBPSU5UUywgewogICAgICBxdWV1ZUFSTnM6IHF1ZXVlQVJOcywKICAgICAgbmV4dFRva2VuOiBwYWdlSW5mby5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFnZUluZm8ubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5nZXRFbmRwb2ludHMocXVldWVBUk5zLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMsCiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5jb25jYXQoZGF0YS5lbmRwb2ludHMpOwogICAgICAgICAgICB2YXIgZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHsKICAgICAgICAgICAgICBlbmRwb2ludHM6IGVuZHBvaW50cywKICAgICAgICAgICAgICBhZGRyZXNzZXM6IGVuZHBvaW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZGRyZXNzZXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzOwoKICAvL0ludGVybmFsIGlkZW50aWZpZXIuCiAgQWdlbnQucHJvdG90eXBlLl9nZXRSZXNvdXJjZUlkID0gZnVuY3Rpb24oKSB7CiAgICBxdWV1ZUFybnMgPSB0aGlzLmdldEFsbFF1ZXVlQVJOcygpOwogICAgZm9yIChsZXQgcXVldWVBcm4gb2YgcXVldWVBcm5zKSB7CiAgICAgIGNvbnN0IGFnZW50SWRNYXRjaCA9IHF1ZXVlQXJuLm1hdGNoKC9cL2FnZW50XC8oW14vXSspLyk7CgogICAgICBpZiAoYWdlbnRJZE1hdGNoKSB7CiAgICAgICAgcmV0dXJuIGFnZW50SWRNYXRjaFsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBFcnJvcigiQWdlbnQucHJvdG90eXBlLl9nZXRSZXNvdXJjZUlkOiBxdWV1ZUFybnMgZGlkIG5vdCBjb250YWluIGFnZW50UmVzb3VyY2VJZDogIiwgcXVldWVBcm5zKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkFnZW50U25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudFNuYXBzaG90CiAgICovCiAgdmFyIEFnZW50U25hcHNob3QgPSBmdW5jdGlvbiAoYWdlbnREYXRhKSB7CiAgICBjb25uZWN0LkFnZW50LmNhbGwodGhpcyk7CiAgICB0aGlzLmFnZW50RGF0YSA9IGFnZW50RGF0YTsKICB9OwogIEFnZW50U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBZ2VudC5wcm90b3R5cGUpOwogIEFnZW50U25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQWdlbnRTbmFwc2hvdDsKCiAgQWdlbnRTbmFwc2hvdC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5hZ2VudERhdGE7CiAgfTsKCiAgQWdlbnRTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbnRhY3RBUEkgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3QKICAgKi8KICB2YXIgQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHRoaXMuY29udGFjdElkID0gY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuZ2V0Q29udGFjdElkKCkpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLl9jcmVhdGVDb25uZWN0aW9uQVBJID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25EYXRhKSB7CiAgICBpZiAodGhpcy5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuQ0hBVCkgewogICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9IGVsc2UgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLlRBU0spIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LlRhc2tDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LlZvaWNlQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRFdmVudE5hbWUgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnROYW1lLCB0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblJlZnJlc2ggPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uSW5jb21pbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5DT01JTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkNvbm5lY3RpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uUGVuZGluZyA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5QRU5ESU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BY2NlcHRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uTWlzc2VkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uRW5kZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuRU5ERUQpLCBmKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkRFU1RST1lFRCksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uRGVzdHJveSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkFDVyA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ1cpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkNvbm5lY3RlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVSUk9SKSwgZik7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRDb250YWN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb250YWN0SWQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0T3JpZ2luYWxDb250YWN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWxDb250YWN0SWQ7CiAgfTsKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29udGFjdElkID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0T3JpZ2luYWxDb250YWN0SWQ7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnR5cGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdER1cmF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbnRhY3REdXJhdGlvbjsKICB9CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zdGF0ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm5vdygpIC0gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCkgKyBjb25uZWN0LmNvcmUuZ2V0U2tldygpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXR1c0R1cmF0aW9uID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UXVldWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnF1ZXVlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlVGltZXN0YW1wID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZVRpbWVzdGFtcDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRDb25uZWN0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29ubmVjdGlvbnMubWFwKGZ1bmN0aW9uIChjb25uRGF0YSkgewogICAgICBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuQ0hBVCkgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5DaGF0Q29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIGlmIChzZWxmLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LlRhc2tDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uLmlzSW5pdGlhbENvbm5lY3Rpb24oKTsKICAgIH0pIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWN0aXZlSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaW5pdGlhbENvbm4gPSB0aGlzLmdldEluaXRpYWxDb25uZWN0aW9uKCk7CiAgICBpZiAoaW5pdGlhbENvbm4gIT0gbnVsbCAmJiBpbml0aWFsQ29ubi5pc0FjdGl2ZSgpKSB7CiAgICAgIHJldHVybiBpbml0aWFsQ29ubjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldFRoaXJkUGFydHlDb25uZWN0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbm5lY3Rpb25zKCkuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiAhY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCkgJiYgY29ubi5nZXRUeXBlKCkgIT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQ7CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTaW5nbGVBY3RpdmVUaGlyZFBhcnR5Q29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFRoaXJkUGFydHlDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0FjdGl2ZSgpOwogICAgfSlbMF0gfHwgbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBZ2VudENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgdmFyIGNvbm5UeXBlID0gY29ubi5nZXRUeXBlKCk7CiAgICAgIHJldHVybiBjb25uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCB8fCBjb25uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubmFtZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRDb250YWN0TWV0YWRhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbnRhY3RNZXRhZGF0YTsKICB9CgogIENvbnRhY3QucHJvdG90eXBlLmdldERlc2NyaXB0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5kZXNjcmlwdGlvbjsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRSZWZlcmVuY2VzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5yZWZlcmVuY2VzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmF0dHJpYnV0ZXM7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdEZlYXR1cmVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RmVhdHVyZXM7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbnRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNoYW5uZWxDb250ZXh0OwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzU29mdHBob25lQ2FsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKSAhPSBudWxsOwogICAgfSkgIT0gbnVsbDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5faXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYXRpb25NZXRob2QgPSB0aGlzLl9nZXREYXRhKCkuaW5pdGlhdGlvbk1ldGhvZDsKICAgIHJldHVybiAoaW5pdGlhdGlvbk1ldGhvZCA9PT0gY29ubmVjdC5Db250YWN0SW5pdGlhdGlvbk1ldGhvZC5PVVRCT1VORCkgPyBmYWxzZSA6IHRydWU7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5pc0luYm91bmQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubiA9IHRoaXMuZ2V0SW5pdGlhbENvbm5lY3Rpb24oKTsKCiAgICAvLyBXZSB3aWxsIGdyYWR1YWxseSBjaGFuZ2UgY2hlY2tpbmcgaW5ib3VuZCBieSByZWx5aW5nIG9uIGNvbnRhY3QgaW5pdGlhdGlvbk1ldGhvZAogICAgaWYgKGNvbm4uZ2V0TWVkaWFUeXBlKCkgPT09IGNvbm5lY3QuTWVkaWFUeXBlLlRBU0spIHsKICAgICAgcmV0dXJuIHRoaXMuX2lzSW5ib3VuZCgpOwogICAgfQoKICAgIHJldHVybiBjb25uID8gY29ubi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuSU5CT1VORCA6IGZhbHNlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5hY2NlcHQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNvbnRhY3RJZCA9IHRoaXMuZ2V0Q29udGFjdElkKCk7CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjbGlja1R5cGU6IGNvbm5lY3QuQ2xpY2tUeXBlLkFDQ0VQVCwKICAgICAgY2xpY2tUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH0pOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5BQ0NFUFRfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZAogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsCiAgICAgICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKQogICAgICAgICAgfSk7CiAgICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCwgc2VsZi5nZXRDb250YWN0SWQoKSksCiAgICAgICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKQogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gSW4gRmlyZWZveCwgdGhlcmUncyBhIGJyb3dzZXIgcmVzdHJpY3Rpb24gdGhhdCBhbiB1bmZvY3VzZWQgYnJvd3NlciB0YWIgaXMgbm90IGFsbG93ZWQgdG8gYWNjZXNzIHRoZSB1c2VyJ3MgbWljcm9waG9uZS4KICAgICAgICAgIC8vIFRoZSBwcm9ibGVtIGlzIHRoYXQgdGhlIHJlc3RyaWN0aW9uIGNvdWxkIGNhdXNlIGEgd2VicnRjIHNlc3Npb24gY3JlYXRpb24gdGltZW91dCBlcnJvciB3aGVuIHlvdSBnZXQgYW4gaW5jb21pbmcgY2FsbCB3aGlsZSB5b3UgYXJlIG5vdCBvbiB0aGUgcHJpbWFyeSB0YWIuCiAgICAgICAgICAvLyBJdCB3YXMgaGFyZCB0byB3b3JrYXJvdW5kIHRoZSBpc3N1ZSBlc3BlY2lhbGx5IHdoZW4geW91IGhhdmUgbXVsdGlwbGUgdGFicyBvcGVuIGJlY2F1c2UgeW91IG5lZWRlZCB0byBmaW5kIHRoZSByaWdodCB0YWIgYW5kIGFjY2VwdCB0aGUgY29udGFjdCBiZWZvcmUgdGhlIHRpbWVvdXQuCiAgICAgICAgICAvLyBUbyBhdm9pZCB0aGUgZXJyb3IsIHdoZW4gbXVsdGlwbGUgdGFicyBhcmUgb3BlbiBpbiBGaXJlZm94LCBhIHdlYnJ0YyBzZXNzaW9uIGlzIG5vdCBpbW1lZGlhdGVseSBjcmVhdGVkIGFzIGFuIGluY29taW5nIHNvZnRwaG9uZSBjb250YWN0IGlzIGRldGVjdGVkLgogICAgICAgICAgLy8gSW5zdGVhZCwgaXQgd2FpdHMgdW50aWwgY29udGFjdC5hY2NlcHQoKSBpcyBjYWxsZWQgb24gYSB0YWIgYW5kIGxldHMgdGhlIHRhYiBiZWNvbWUgdGhlIG5ldyBwcmltYXJ5IHRhYiBhbmQgc3RhcnQgdGhlIHdlYiBydGMgc2Vzc2lvbiB0aGVyZQogICAgICAgICAgLy8gYmVjYXVzZSB0aGUgdGFiIHNob3VsZCBiZSBmb2N1c2VkIGF0IHRoZSBtb21lbnQgYW5kIGhhdmUgYWNjZXNzIHRvIHRoZSB1c2VyJ3MgbWljcm9waG9uZS4KICAgICAgICAgIHZhciBjb250YWN0ID0gbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpOwogICAgICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkpIHsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogY2FsbGJhY2tzID8gY2FsbGJhY2tzLmZhaWx1cmUgOiBudWxsCiAgICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmdldExvZygpLndhcm4oImNvbnRhY3QuZGVzdHJveSgpIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hDbGlja1N0cmVhbURhdGEoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNsaWNrVHlwZTogY29ubmVjdC5DbGlja1R5cGUuUkVKRUNULAogICAgICBjbGlja1RpbWU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgfSk7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlJFSkVDVF9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jb21wbGV0ZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09NUExFVEVfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNMRUFSX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm5vdGlmeUlzc3VlID0gZnVuY3Rpb24gKGlzc3VlQ29kZSwgZGVzY3JpcHRpb24sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5OT1RJRllfQ09OVEFDVF9JU1NVRSwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGlzc3VlQ29kZTogaXNzdWVDb2RlLAogICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24KICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWRkQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX0FERElUSU9OQUxfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGVuZHBvaW50OiBlbmRwb2ludAogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS50b2dnbGVBY3RpdmVDb25uZWN0aW9ucyA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29ubmVjdGlvbklkID0gbnVsbDsKICAgIHZhciBob2xkaW5nQ29ubiA9IGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEOwogICAgfSk7CgogICAgaWYgKGhvbGRpbmdDb25uICE9IG51bGwpIHsKICAgICAgY29ubmVjdGlvbklkID0gaG9sZGluZ0Nvbm4uZ2V0Q29ubmVjdGlvbklkKCk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIGFjdGl2ZUNvbm5zID0gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICAgIHJldHVybiBjb25uLmlzQWN0aXZlKCk7CiAgICAgIH0pOwogICAgICBpZiAoYWN0aXZlQ29ubnMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbm5lY3Rpb25JZCA9IGFjdGl2ZUNvbm5zWzBdLmdldENvbm5lY3Rpb25JZCgpOwogICAgICB9CiAgICB9CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlRPR0dMRV9BQ1RJVkVfQ09OTkVDVElPTlMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZAogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5zZW5kU29mdHBob25lTWV0cmljcyA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfTUVUUklDUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNjcFZlcnNpb246IGdsb2JhbC5jY3BWZXJzaW9uLAogICAgICBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzOiBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzCiAgICB9LCBjYWxsYmFja3MpOwoKICAgIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVN0YXRzKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgc3RhdHM6IHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnNlbmRTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbiAocmVwb3J0LCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9SRVBPUlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgcmVwb3J0OiByZXBvcnQKICAgIH0sIGNhbGxiYWNrcyk7CgogICAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lUmVwb3J0KHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgcmVwb3J0OiByZXBvcnQKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNvbmZlcmVuY2VDb25uZWN0aW9ucyA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09ORkVSRU5DRV9DT05ORUNUSU9OUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc011bHRpUGFydHlDb25mZXJlbmNlRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb250YWN0RmVhdHVyZXMgPSB0aGlzLmdldENvbnRhY3RGZWF0dXJlcygpOwogICAgcmV0dXJuICEhKGNvbnRhY3RGZWF0dXJlcyAmJiBjb250YWN0RmVhdHVyZXMubXVsdGlQYXJ0eUNvbmZlcmVuY2VFbmFibGVkKTsKICB9CgogIENvbnRhY3QucHJvdG90eXBlLnVwZGF0ZU1vbml0b3JQYXJ0aWNpcGFudFN0YXRlID0gZnVuY3Rpb24gKHRhcmdldFN0YXRlLCBjYWxsYmFja3MpIHsKICAgIGlmKCF0YXJnZXRTdGF0ZSB8fCAhT2JqZWN0LnZhbHVlcyhjb25uZWN0Lk1vbml0b3JpbmdNb2RlKS5pbmNsdWRlcyh0YXJnZXRTdGF0ZSkpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihgSW52YWxpZCB0YXJnZXQgc3RhdGUgd2FzIHByb3ZpZGVkOiAke3RhcmdldFN0YXRlfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShjb25uZWN0Lk1vbml0b3JpbmdFcnJvclR5cGVzLklOVkFMSURfVEFSR0VUX1NUQVRFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9NT05JVE9SX1BBUlRJQ0lQQU5UX1NUQVRFLCB7CiAgICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICAgIHRhcmdldE1vbml0b3JNb2RlOiB0YXJnZXRTdGF0ZQogICAgICB9LCBjYWxsYmFja3MpOwogICAgfQogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29udGFjdFNuYXBzaG90CiAgICovCiAgdmFyIENvbnRhY3RTbmFwc2hvdCA9IGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgY29ubmVjdC5Db250YWN0LmNhbGwodGhpcywgY29udGFjdERhdGEuY29udGFjdElkKTsKICAgIHRoaXMuY29udGFjdERhdGEgPSBjb250YWN0RGF0YTsKICB9OwogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbnRhY3QucHJvdG90eXBlKTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29udGFjdFNuYXBzaG90OwoKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdERhdGE7CiAgfTsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdChjb25uZWN0aW9uRGF0YSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29ubmVjdGlvbgogICAqLwogIHZhciBDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICAgIHRoaXMuY29ubmVjdGlvbklkID0gY29ubmVjdGlvbklkOwogICAgdGhpcy5faW5pdE1lZGlhQ29udHJvbGxlcigpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbm5lY3Rpb25EYXRhKAogICAgICB0aGlzLmdldENvbnRhY3RJZCgpLCB0aGlzLmdldENvbm5lY3Rpb25JZCgpKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRDb250YWN0SWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb250YWN0SWQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbklkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEVuZHBvaW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkVuZHBvaW50KHRoaXMuX2dldERhdGEoKS5lbmRwb2ludCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0QWRkcmVzcyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEVuZHBvaW50OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnR5cGU7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuaW5pdGlhbDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0FjdGl2ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCB0aGlzLmdldFN0YXR1cygpLnR5cGUpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzQ29ubmVjdGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVElORzsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc09uSG9sZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xEOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFNvZnRwaG9uZU1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIC8qKgogICAqIEdldHMgdGhlIGN1cnJlbnRseSBtb25pdG9yZWQgY29udGFjdCBpbmZvLCBSZXR1cm5zIG51bGwgaWYgZG9lcyBub3QgZXhpc3RzLgogICAqIEByZXR1cm4ge3thZ2VudE5hbWU6c3RyaW5nLCBjdXN0b21lck5hbWU6c3RyaW5nLCBqb2luVGltZTpEYXRlfX0KICAgKi8KICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNb25pdG9ySW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvcmluZ0luZm87CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2xpY2tUeXBlOiBjb25uZWN0LkNsaWNrVHlwZS5IQU5HVVAsCiAgICAgIGNsaWNrVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICB9KTsKCiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkRFU1RST1lfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5zZW5kRGlnaXRzID0gZnVuY3Rpb24gKGRpZ2l0cywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfRElHSVRTLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpLAogICAgICBkaWdpdHM6IGRpZ2l0cwogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5ob2xkID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5IT0xEX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRVNVTUVfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS50b1NuYXBzaG90ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCh0aGlzLl9nZXREYXRhKCkpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuZ2V0TWVkaWFJbmZvKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8vIE1ldGhvZCBmb3IgY2hlY2tpbmcgd2hldGhlciB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uCiAgLy8gKHR5cGUgQUdFTlQgb3IgTU9OSVRPUklORykKICBDb25uZWN0aW9uLnByb3RvdHlwZS5faXNBZ2VudENvbm5lY3Rpb25UeXBlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm5lY3Rpb25UeXBlID0gdGhpcy5nZXRUeXBlKCk7CiAgICByZXR1cm4gY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CgogIC8qKgogICAqIFV0aWxpdHkgbWV0aG9kIGZvciBjaGVja2luZyB3aGV0aGVyIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24KICAgKiAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbi4gRmFsc2Ugb3RoZXJ3aXNlLgogICAqLwogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVAogICAgICB8fCBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBDb250YWN0IHJlY29yZGluZwogICovCgogIHZhciBDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShjb250YWN0SWQpID8gY29udGFjdElkIDogbnVsbDsKICB9CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0YXJ0Q29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKHRyYWNrQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHZhciByZWNvcmRpbmdUcmFjayA9ICh0cmFja0NvbmZpZyAmJiBPYmplY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcpLmluY2x1ZGVzKHRyYWNrQ29uZmlnKSkgPyB0cmFja0NvbmZpZyA6IGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcuQUxMOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJ2b2ljZVJlY29yZGluZ0NvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAidm9pY2VSZWNvcmRpbmdUcmFjayI6IHJlY29yZGluZ1RyYWNrCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygic3RhcnRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdGFydENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIiwgeyBjYXVzZTogZXJyIH0pKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH07CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN0b3BDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNUT1BfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJzdG9wQ29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0b3BDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdG9wQ29udGFjdFJlY29yZGluZyBmYWlsZWQiLCB7IGNhdXNlOiBlcnIgfSkpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKCiAgQ29udGFjdFJlY29yZGluZy5wcm90b3R5cGUuc3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQsIGNvbnRhY3REYXRhOwoKICAgIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1VTUEVORF9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3VzcGVuZENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyLAogICAgICAgICAgICAgIGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgICByZWplY3QoRXJyb3IoInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIsIHsgY2F1c2U6IGVyciB9KSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5yZXN1bWVDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlJFU1VNRV9DT05UQUNUX1JFQ09SRElORywgewogICAgICAgICJpbml0aWFsQ29udGFjdElkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCkKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgc3VjY2VlZGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLCB7IGNhdXNlOiBlcnIgfSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFZvaWNlIGF1dGhlbnRpY2F0b3IgVm9pY2VJZAogICovCgogIHZhciBWb2ljZUlkID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuR0VUX0NPTlRBQ1QsIHsKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgImF3c0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgaWYoZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkKSB7CiAgICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIHNwZWFrZXJJZDogZGF0YS5jb250YWN0RGF0YS5jdXN0b21lcklkCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0U3BlYWtlcklkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICByZXNvbHZlKG9iaik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5OT19TUEVBS0VSX0lEX0ZPVU5ELCAiTm8gc3BlYWtlcklkIGFzc290aWF0ZWQgd2l0aCB0aGlzIGNhbGwiKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiR2V0IFNwZWFrZXJJZCBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfU1BFQUtFUl9JRF9GQUlMRUQsICJHZXQgU3BlYWtlcklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5nZXRTcGVha2VyU3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5ERVNDUklCRV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRTcGVha2VyU3RhdHVzIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgICAgc3dpdGNoKHBhcnNlZEVyci5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gcGFyc2VkRXJyOwogICAgICAgICAgICAgICAgICAgIGRhdGEudHlwZSA9IGRhdGEudHlwZSA/IGRhdGEudHlwZSA6IGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1BFQUtFUl9JRF9OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTcGVha2VyIGlzIG5vdCBlbnJvbGxlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0U3BlYWtlclN0YXR1cyBmYWlsZWQiKQogICAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9TUEVBS0VSX1NUQVRVU19GQUlMRUQsICJHZXQgU3BlYWtlclN0YXR1cyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIGludGVybmFsIG9ubHkKICBWb2ljZUlkLnByb3RvdHlwZS5fb3B0T3V0U3BlYWtlckluTGNtcyA9IGZ1bmN0aW9uIChzcGVha2VySWQsIGdlbmVyYXRlZFNwZWFrZXJJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlVQREFURV9WT0lDRV9JRF9EQVRBLCB7CiAgICAgICAgIkNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJJbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJBV1NBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAiQ3VzdG9tZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAiVm9pY2VJZFJlc3VsdCI6IHsKICAgICAgICAgICJTcGVha2VyT3B0ZWRPdXQiOiB0cnVlLAogICAgICAgICAgImdlbmVyYXRlZFNwZWFrZXJJZCI6IGdlbmVyYXRlZFNwZWFrZXJJZAogICAgICAgIH0KICAgICAgICB9LCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXJJbkxjbXMgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigib3B0T3V0U3BlYWtlckluTGNtcyBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfSU5fTENNU19GQUlMRUQsICJvcHRPdXRTcGVha2VySW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLm9wdE91dFNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIHZhciBzcGVha2VySWQgPSBkYXRhLnNwZWFrZXJJZDsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLk9QVF9PVVRfU1BFQUtFUiwgewogICAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9vcHRPdXRTcGVha2VySW5MY21zKHNwZWFrZXJJZCwgZGF0YS5nZW5lcmF0ZWRTcGVha2VySWQpLmNhdGNoKGZ1bmN0aW9uKCl7fSk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIm9wdE91dFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfRkFJTEVELCAib3B0T3V0U3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlbGV0ZVNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFTEVURV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJkZWxldGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJkZWxldGVTcGVha2VyIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuREVMRVRFX1NQRUFLRVJfRkFJTEVELCAiZGVsZXRlU3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnN0YXJ0U2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfVk9JQ0VfSURfU0VTU0lPTiwgewogICAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgICAiY3VzdG9tZXJBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAgICJjbGllbnRUb2tlbiI6IEFXUy51dGlsLnV1aWQudjQoKSwKICAgICAgICAgICJkb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGlmKGRhdGEuc2Vzc2lvbklkKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCwgbm8gc2Vzc2lvbiBpZCByZXR1cm5lZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNUQVJUX1NFU1NJT05fRkFJTEVELCAiTm8gc2Vzc2lvbiBpZCByZXR1cm5lZCBmcm9tIHN0YXJ0IHNlc3Npb24gYXBpIik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TVEFSVF9TRVNTSU9OX0ZBSUxFRCwgInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyID0gZnVuY3Rpb24gKHN0YXJ0TmV3KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgcG9sbFRpbWVzID0gMDsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGV2YWx1YXRlKCkgewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FVkFMVUFURV9TRVNTSU9OLCB7CiAgICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBpZigrK3BvbGxUaW1lcyA8IGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FVkFMVUFUSU9OX01BWF9QT0xMX1RJTUVTKSB7CiAgICAgICAgICAgICAgICBpZihkYXRhLlN0cmVhbWluZ1N0YXR1cyA9PT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLlBFTkRJTkdfQ09ORklHVVJBVElPTikgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmKCFkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIWRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlIGlmIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBhcmUgbm90IGVuYWJsZWQuCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICAhc2VsZi5pc0ZyYXVkRW5hYmxlZChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoZGF0YS5TdHJlYW1pbmdTdGF0dXMgPT09IGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cy5FTkRFRCkgewogICAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFZvaWNlIHByaW50IGlzIG5vdCBsb25nIGVub3VnaCBmb3IgYm90aCBhdXRoZW50aWNhdGlvbiBhbmQgZnJhdWQgZGV0ZWN0aW9uCiAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pc0ZyYXVkUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5BQ0NFUFQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5SRUpFQ1Q6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfQVVUSEVOVElDQVRFRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uU1BFQUtFUl9PUFRFRF9PVVQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5PUFRFRF9PVVQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlNQRUFLRVJfTk9UX0VOUk9MTEVEOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOUk9MTEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRFbmFibGVkKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkxPV19SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgICFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmUgb25seSB3aGVuIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBoYXZlIHJlc3VsdHMuIE90aGVyd2lzZSwga2VlcCBwb2xsaW5nLgogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJldmFsdWF0ZVNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfVElNRU9VVCwgImV2YWx1YXRlU3BlYWtlciB0aW1lb3V0Iik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfRkFJTEVELCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZighc3RhcnROZXcpIHsKICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGV2YWx1YXRlKCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3luY1NwZWFrZXJJZCBmYWlsZWQgd2hlbiBzZXNzaW9uIHN0YXJ0TmV3PWZhbHNlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRFX1NFU1NJT05fREVMQVkpOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN5bmNTcGVha2VySWQgZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz10cnVlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRTZXNzaW9uIGZhaWxlZCB3aGVuIHNlc3Npb24gc3RhcnROZXc9dHJ1ZSIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChlcnIpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlc2NyaWJlU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFU0NSSUJFX1NFU1NJT04sIHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkRFU0NSSUJFX1NFU1NJT05fRkFJTEVELCAiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuY2hlY2tFbnJvbGxtZW50U3RhdHVzID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBvbGxpbmdUaW1lcyA9IDA7CiAgICB2YXIgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSBmYWxzZTsKCiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBkZXNjcmliZSAoKSB7CiAgICAgICAgaWYoKytwb2xsaW5nVGltZXMgPCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRU5ST0xMTUVOVF9NQVhfUE9MTF9USU1FUykgewogICAgICAgICAgc2VsZi5kZXNjcmliZVNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICBzd2l0Y2goZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5TdGF0dXMpIHsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRDoKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLklOX1BST0dSRVNTOgogICAgICAgICAgICAgICAgaWYgKCFjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGVIYXNCZWVuSW52b2tlZCAmJiB0eXBlb2YgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0VGltZW91dChkZXNjcmliZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLk5PVF9FTk9VR0hfU1BFRUNIOgogICAgICAgICAgICAgICAgaWYoZGF0YS5TZXNzaW9uLlN0cmVhbWluZ1N0YXR1cyAhPT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZGVzY3JpYmUsY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaWJlKCk7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9LCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuU1RBUlRfU0VTU0lPTl9ERUxBWSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgPyBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgOiAiZW5yb2xsU3BlYWtlciBmYWlsZWQuIFVua25vd24gZW5yb2xsbWVudCBzdGF0dXMgaGFzIGJlZW4gcmVjZWl2ZWQiOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihtZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogIAkJICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCBtZXNzYWdlLCBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLlN0YXR1cyk7CiAgCQkgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVOUk9MTF9TUEVBS0VSX1RJTUVPVVQsICJlbnJvbGxTcGVha2VyIHRpbWVvdXQiKTsKICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlc2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5lbnJvbGxTcGVha2VyID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5nZXRTcGVha2VyU3RhdHVzKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZihkYXRhLlNwZWFrZXIgJiYgZGF0YS5TcGVha2VyLlN0YXR1cyA9PSBjb25uZWN0LlZvaWNlSWRTcGVha2VyU3RhdHVzLk9QVEVEX09VVCkgewogICAgICAgICAgICBzZWxmLmRlbGV0ZVNwZWFrZXIoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKQogICAgICB9KQogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmVucm9sbFNwZWFrZXJIZWxwZXIgPSBmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0LCBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FTlJPTExfQllfU0VTU0lPTiwgewogICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5DT01QTEVURUQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5jaGVja0Vucm9sbG1lbnRTdGF0dXMoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJlbnJvbGxTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCAiZW5yb2xsU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHJlamVjdChlcnIpOwogICAgfSk7CiAgfTsKCiAgLy8gaW50ZXJuYWwgb25seQogIFZvaWNlSWQucHJvdG90eXBlLl91cGRhdGVTcGVha2VySWRJbkxjbXMgPSBmdW5jdGlvbiAoc3BlYWtlcklkLCBnZW5lcmF0ZWRTcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5VUERBVEVfVk9JQ0VfSURfREFUQSwgewogICAgICAgICJDb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAiQVdTQWNjb3VudElkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QVdTQWNjb3VudElkKCksCiAgICAgICAgIkN1c3RvbWVySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgIlZvaWNlSWRSZXN1bHQiOiB7CiAgICAgICAgICAiZ2VuZXJhdGVkU3BlYWtlcklkIjogZ2VuZXJhdGVkU3BlYWtlcklkCiAgICAgICAgfQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5MY21zIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJbkxjbXMgZmFpbGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0lOX0xDTVNfRkFJTEVELCAidXBkYXRlU3BlYWtlcklkSW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCA9IGZ1bmN0aW9uIChzcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1NFU1NJT04sIHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBzZWxmLl91cGRhdGVTcGVha2VySWRJbkxjbXMoc3BlYWtlcklkLCBkYXRhLmdlbmVyYXRlZFNwZWFrZXJJZCkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5zeW5jU3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYudXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkKGRhdGEuc3BlYWtlcklkKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pCiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmdldERvbWFpbklkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjb25zdCBhZ2VudCA9IG5ldyBjb25uZWN0LkFnZW50KCk7CiAgICAgIGlmICghYWdlbnQuZ2V0UGVybWlzc2lvbnMoKS5pbmNsdWRlcyhjb25uZWN0LkFnZW50UGVybWlzc2lvbnMuVk9JQ0VfSUQpKSB7CiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiQWdlbnQgZG9lc24ndCBoYXZlIHRoZSBwZXJtaXNzaW9uIGZvciBWb2ljZSBJRCIpKTsKICAgICAgfSBlbHNlIGlmIChjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkKSB7CiAgICAgICAgcmVzb2x2ZShjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkxJU1RfSU5URUdSQVRJT05fQVNTT0NJQVRJT05TLCB7CiAgICAgICAgICAiSW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAgICJJbnRlZ3JhdGlvblR5cGUiOiAiVk9JQ0VfSUQiCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgZG9tYWluSWQ7CiAgICAgICAgICAgICAgaWYgKGRhdGEuSW50ZWdyYXRpb25Bc3NvY2lhdGlvblN1bW1hcnlMaXN0Lmxlbmd0aCA+PSAxKSB7CiAgICAgICAgICAgICAgICB2YXIgaW50ZWdyYXRpb25Bcm4gPSBkYXRhLkludGVncmF0aW9uQXNzb2NpYXRpb25TdW1tYXJ5TGlzdFswXS5JbnRlZ3JhdGlvbkFybjsKICAgICAgICAgICAgICAgIGRvbWFpbklkID0gaW50ZWdyYXRpb25Bcm4ucmVwbGFjZSgvXi4qZG9tYWluXC8vaSwgJycpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWRvbWFpbklkKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldERvbWFpbklkOiBubyBkb21haW5JZCBmb3VuZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLk5PX0RPTUFJTl9JRF9GT1VORCk7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldERvbWFpbklkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgICAgICBldmVudDogY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsCiAgICAgICAgICAgICAgICBkYXRhOiB7IGRvbWFpbklkOiBkb21haW5JZCB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVzb2x2ZShkb21haW5JZCk7CiAgICAgICAgICAgIH0gY2F0Y2goZXJyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0RG9tYWluSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfRE9NQUlOX0lEX0ZBSUxFRCwgImdldERvbWFpbklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0RG9tYWluSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX0RPTUFJTl9JRF9GQUlMRUQsICJnZXREb21haW5JZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmNoZWNrQ29uZmVyZW5jZUNhbGwgPSBmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGlzQ29uZmVyZW5jZUNhbGwgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCkuY29ubmVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCBjb25uLnN0YXRlLnR5cGUpOwogICAgfSkubGVuZ3RoID4gMjsKICAgIGlmKGlzQ29uZmVyZW5jZUNhbGwpewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCJWb2ljZUlkIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIGNvbmZlcmVuY2UgY2FsbHMiKTsKICAgIH0KICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzQXV0aEVuYWJsZWQgPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCAhPT0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2ggPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCA9PT0gY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5PVUdIX1NQRUVDSDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzQXV0aFJlc3VsdEluY29uY2x1c2l2ZSA9IGZ1bmN0aW9uKGF1dGhSZXN1bHQpIHsKICAgIHJldHVybiBhdXRoUmVzdWx0ID09PSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0ZyYXVkRW5hYmxlZCA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgIT09IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaCA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgPT09IGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTk9UX0VOT1VHSF9TUEVFQ0g7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0ZyYXVkUmVzdWx0SW5jb25jbHVzaXZlID0gZnVuY3Rpb24oZnJhdWRSZXN1bHQpIHsKICAgIHJldHVybiBmcmF1ZFJlc3VsdCA9PT0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogIH0KCiAgLyoqCiAgICogQGNsYXNzIFZvaWNlQ29ubmVjdGlvbgogICAqIEBwYXJhbSB7bnVtYmVyfSBjb250YWN0SWQKICAgKiBAcGFyYW0ge251bWJlcn0gY29ubmVjdGlvbklkCiAgICogQGRlc2NyaXB0aW9uIC0gUHJvdmlkZXMgdm9pY2UgbWVkaWEgc3BlY2lmaWMgb3BlcmF0aW9ucwogICAqLwogIHZhciBWb2ljZUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yID0gbmV3IFZvaWNlSWQoY29udGFjdElkKTsKICAgIHRoaXMuX2NvbnRhY3RSZWNvcmRlciA9IG5ldyBDb250YWN0UmVjb3JkaW5nKGNvbnRhY3RJZCk7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VDb25uZWN0aW9uOwoKICAvKioKICAqIEBkZXByZWNhdGVkCiAgKiBQbGVhc2UgdXNlIGdldE1lZGlhSW5mbwogICovCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Vm9pY2VJZFNwZWFrZXJJZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJJZCgpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRWb2ljZUlkU3BlYWtlclN0YXR1cyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmdldFNwZWFrZXJTdGF0dXMoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUub3B0T3V0Vm9pY2VJZFNwZWFrZXIgPSBmdW5jdGlvbigpIHsKCiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3Iub3B0T3V0U3BlYWtlcigpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5kZWxldGVWb2ljZUlkU3BlYWtlciA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmRlbGV0ZVNwZWFrZXIoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyV2l0aFZvaWNlSWQgPSBmdW5jdGlvbihzdGFydE5ldykgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmV2YWx1YXRlU3BlYWtlcihzdGFydE5ldyk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmVucm9sbFNwZWFrZXJJblZvaWNlSWQgPSBmdW5jdGlvbihjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5lbnJvbGxTcGVha2VyKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnVwZGF0ZVZvaWNlSWRTcGVha2VySWQgPSBmdW5jdGlvbihzcGVha2VySWQpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci51cGRhdGVTcGVha2VySWRJblZvaWNlSWQoc3BlYWtlcklkKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0UXVpY2tDb25uZWN0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVpY2tDb25uZWN0TmFtZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1vbml0b3JTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvclN0YXRlOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckNhcGFiaWxpdGllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubW9uaXRvckNhcGFiaWxpdGllczsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkubXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzRm9yY2VkTXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZm9yY2VkTXV0ZTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLm11dGVQYXJ0aWNpcGFudCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTVVURV9QQVJUSUNJUEFOVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnVubXV0ZVBhcnRpY2lwYW50ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VTk1VVEVfUEFSVElDSVBBTlQsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdGFydENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdGFydENvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuc3RvcENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5zdG9wQ29udGFjdFJlY29yZGluZygpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdXNwZW5kQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZUNvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIHRoaXMuX2NvbnRhY3RSZWNvcmRlci5yZXN1bWVDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNoZWNrQ29uZmVyZW5jZUNhbGwgPSBmdW5jdGlvbigpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGlzQ29uZmVyZW5jZUNhbGwgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCkuY29ubmVjdGlvbnMuZmlsdGVyKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTLCBjb25uLnN0YXRlLnR5cGUpOwogICAgfSkubGVuZ3RoID4gMjsKICAgIGlmKGlzQ29uZmVyZW5jZUNhbGwpewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCJWb2ljZUlkIGFuZCBDb250YWN0IFJlY29yZGluZyBhcmUgbm90IHN1cHBvcnRlZCBmb3IgY29uZmVyZW5jZSBjYWxscyIpOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIENoYXRDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZAogICAqIEBkZXNjcmlwdGlvbiBhZGRzIHRoZSBjaGF0IG1lZGlhIHNwZWNpZmljIGZ1bmN0aW9uYWxpdHkKICAgKi8KICB2YXIgQ2hhdENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ2hhdENvbm5lY3Rpb247CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZGF0YSA9IHRoaXMuX2dldERhdGEoKS5jaGF0TWVkaWFJbmZvOwogICAgaWYgKCFkYXRhKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgICB2YXIgbWVkaWFPYmplY3QgPSB7CiAgICAgICAgY29udGFjdElkOiB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBpbml0aWFsQ29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgIHBhcnRpY2lwYW50SWQ6IHRoaXMuY29ubmVjdGlvbklkLAogICAgICAgIGdldENvbm5lY3Rpb25Ub2tlbjogY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLmdldENvbm5lY3Rpb25Ub2tlbikKICAgICAgfTsKICAgICAgaWYgKGRhdGEuY29ubmVjdGlvbkRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IEpTT04ucGFyc2UoZGF0YS5jb25uZWN0aW9uRGF0YSkuQ29ubmVjdGlvbkF1dGhlbnRpY2F0aW9uVG9rZW47CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFULCAiQ29ubmVjdGlvbiBkYXRhIGlzIGludmFsaWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiB8fCBudWxsOwogICAgICAvKiogSnVzdCB0byBrZWVwIHRoZSBkYXRhIGFjY2Vzc2libGUgKi8KICAgICAgbWVkaWFPYmplY3Qub3JpZ2luYWxJbmZvID0gdGhpcy5fZ2V0RGF0YSgpLmNoYXRNZWRpYUluZm87CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICAgIH0KICB9OwoKICAvKioKICAqIFByb3ZpZGVzIHRoZSBjaGF0IGNvbm5lY3Rpb25Ub2tlbiB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSSBmb3IgYSBzcGVjaWZpYyBjb250YWN0IGFuZCBwYXJ0aWNpcGFudCBJZC4KICAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogICogVXNhZ2U6CiAgKiBjb25uZWN0aW9uLmdldENvbm5lY3Rpb25Ub2tlbigpCiAgKiAgLnRoZW4ocmVzcG9uc2UgPT4ge30pCiAgKiAgLmNhdGNoKGVycm9yID0+IHt9KQogICovCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25Ub2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHZhciB0cmFuc3BvcnREZXRhaWxzID0gewogICAgICB0cmFuc3BvcnRUeXBlOiBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUy5DSEFUX1RPS0VOLAogICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgY29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkCiAgICB9OwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHRyYW5zcG9ydERldGFpbHMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRDb25uZWN0aW9uVG9rZW4gc3VjY2VlZGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRDb25uZWN0aW9uVG9rZW4gZmFpbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigiZ2V0Q29ubmVjdGlvblRva2VuIGZhaWxlZCIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgLy8gTm90ZSB0aGF0IGEgY2hhdCBtZWRpYSBjb250cm9sbGVyIG9ubHkgbmVlZHMgdG8gYmUgcHJvZHVjZWQgZm9yIGFnZW50IHR5cGUgY29ubmVjdGlvbnMuCiAgICBpZiAodGhpcy5faXNBZ2VudENvbm5lY3Rpb25UeXBlKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIEBjbGFzcyBUYXNrQ29ubmVjdGlvbgogICAqIEBwYXJhbSB7Kn0gY29udGFjdElkCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQKICAgKiBAZGVzY3JpcHRpb24gYWRkcyB0aGUgdGFzayBtZWRpYSBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5CiAgICovCiAgdmFyIFRhc2tDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza0Nvbm5lY3Rpb247CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5NZWRpYVR5cGUuVEFTSzsKICB9CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgICAgdmFyIG1lZGlhT2JqZWN0ID0gewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgfTsKICAgICAgcmV0dXJuIG1lZGlhT2JqZWN0OwogIH07CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29ubmVjdGlvblNuYXBzaG90CiAgICovCiAgdmFyIENvbm5lY3Rpb25TbmFwc2hvdCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgY29ubmVjdC5Db25uZWN0aW9uLmNhbGwodGhpcywgY29ubmVjdGlvbkRhdGEuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgdGhpcy5jb25uZWN0aW9uRGF0YSA9IGNvbm5lY3Rpb25EYXRhOwogIH07CiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDb25uZWN0aW9uU25hcHNob3Q7CgogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uRGF0YTsKICB9OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgeyB9OwoKICB2YXIgRW5kcG9pbnQgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHRoaXMuZW5kcG9pbnRBUk4gPSBwYXJhbXMuZW5kcG9pbnRJZCB8fCBwYXJhbXMuZW5kcG9pbnRBUk4gfHwgbnVsbDsKICAgIHRoaXMuZW5kcG9pbnRJZCA9IHRoaXMuZW5kcG9pbnRBUk47CiAgICB0aGlzLnR5cGUgPSBwYXJhbXMudHlwZSB8fCBudWxsOwogICAgdGhpcy5uYW1lID0gcGFyYW1zLm5hbWUgfHwgbnVsbDsKICAgIHRoaXMucGhvbmVOdW1iZXIgPSBwYXJhbXMucGhvbmVOdW1iZXIgfHwgbnVsbDsKICAgIHRoaXMuYWdlbnRMb2dpbiA9IHBhcmFtcy5hZ2VudExvZ2luIHx8IG51bGw7CiAgICB0aGlzLnF1ZXVlID0gcGFyYW1zLnF1ZXVlIHx8IG51bGw7CiAgfTsKCiAgLyoqCiAgICogU3RyaXAgdGhlIFNJUCBlbmRwb2ludCBjb21wb25lbnRzIGZyb20gdGhlIHBob25lTnVtYmVyIGZpZWxkLgogICAqLwogIEVuZHBvaW50LnByb3RvdHlwZS5zdHJpcFBob25lTnVtYmVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMucGhvbmVOdW1iZXIgPyB0aGlzLnBob25lTnVtYmVyLnJlcGxhY2UoL3NpcDooW15AXSopQC4qLywgIiQxIikgOiAiIjsKICB9OwoKICAvKioKICAgKiBDcmVhdGUgYW4gRW5kcG9pbnQgb2JqZWN0IGZyb20gdGhlIGdpdmVuIHBob25lIG51bWJlciBhbmQgbmFtZS4KICAgKi8KICBFbmRwb2ludC5ieVBob25lTnVtYmVyID0gZnVuY3Rpb24gKG51bWJlciwgbmFtZSkgewogICAgcmV0dXJuIG5ldyBFbmRwb2ludCh7CiAgICAgIHR5cGU6IGNvbm5lY3QuRW5kcG9pbnRUeXBlLlBIT05FX05VTUJFUiwKICAgICAgcGhvbmVOdW1iZXI6IG51bWJlciwKICAgICAgbmFtZTogbmFtZSB8fCBudWxsCiAgICB9KTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBTb2Z0cGhvbmVFcnJvcgogICAqLwogIHZhciBTb2Z0cGhvbmVFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIGVycm9yTWVzc2FnZSwgZW5kUG9pbnRVcmwpIHsKICAgIHRoaXMuZXJyb3JUeXBlID0gZXJyb3JUeXBlOwogICAgdGhpcy5lcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2U7CiAgICB0aGlzLmVuZFBvaW50VXJsID0gZW5kUG9pbnRVcmw7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RXJyb3JUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZXJyb3JUeXBlOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yTWVzc2FnZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFbmRQb2ludFVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVuZFBvaW50VXJsOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFJvb3QgU3Vic2NyaXB0aW9uIEFQSXMuCiAgICovCiAgY29ubmVjdC5hZ2VudCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLklOSVQsIGYpOwogICAgaWYgKGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQpIHsKICAgICAgZihuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KICAgIHJldHVybiBzdWI7CiAgfTsKICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gZmFsc2U7CgogIGNvbm5lY3QuY29udGFjdCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICByZXR1cm4gYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5JVCwgZik7CiAgfTsKCiAgY29ubmVjdC5vbldlYnNvY2tldEluaXRGYWlsdXJlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIHZhciBzdWIgPSBidXMuc3Vic2NyaWJlKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSwgZik7CiAgICBpZiAoY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkKSB7CiAgICAgIGYoKTsKICAgIH0KICAgIHJldHVybiBzdWI7CiAgfTsKCiAgLyoqCiAgICogU3RhcnRzIHRoZSBnaXZlbiBmdW5jdGlvbiBhc3luY2hyb25vdXNseSBvbmx5IGlmIHRoZSBzaGFyZWQgd29ya2VyCiAgICogc2F5cyB3ZSBhcmUgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLiAgSWYgdGhlcmUgaXMgbm8gbWFzdGVyIGZvcgogICAqIHRoZSBnaXZlbiB0b3BpYywgd2UgYmVjb21lIHRoZSBtYXN0ZXIgYW5kIHN0YXJ0IHRoZSBmdW5jdGlvbiB1bmxlc3MKICAgKiBzaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUgaXMgdHJ1ZS4KICAgKgogICAqIEBwYXJhbSB0b3BpYyBUaGUgbWFzdGVyIHRvcGljIHdlIGFyZSBjb25jZXJuZWQgYWJvdXQuCiAgICogQHBhcmFtIGZfdHJ1ZSBUaGUgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgdGhlIG1hc3Rlci4KICAgKiBAcGFyYW0gZl9lbHNlIFtvcHRpb25hbF0gQSBjYWxsYmFjayB0byBiZSBpbnZva2VkIGlmIHdlIGFyZSBub3QgdGhlIG1hc3Rlci4KICAgKiBAcGFyYW0gc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIFtvcHRpb25hbF0gaWYgdHJ1ZSwgdGhpcyB0YWIgd29uJ3QgYmVjb21lIG1hc3Rlci4KICAgKi8KICBjb25uZWN0LmlmTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBmX3RydWUsIGZfZWxzZSwgc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZl90cnVlLCAiQSB0cnVlIGNhbGxiYWNrIG11c3QgYmUgcHJvdmlkZWQuIik7CgogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIC8vIFdlIGNhbid0IGJlIHRoZSBtYXN0ZXIgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50IQogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGNhbid0IGJlIHRoZSBtYXN0ZXIgZm9yIHRvcGljICclcycgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50ISIsIHRvcGljKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAoZl9lbHNlKSB7CiAgICAgICAgZl9lbHNlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBtYXN0ZXJDbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0TWFzdGVyQ2xpZW50KCk7CiAgICBtYXN0ZXJDbGllbnQuY2FsbChjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQ0hFQ0tfTUFTVEVSLCB7CiAgICAgIHRvcGljOiB0b3BpYywKICAgICAgc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lOiBzaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEuaXNNYXN0ZXIpIHsKICAgICAgICAgICAgZl90cnVlKCk7CgogICAgICAgICAgfSBlbHNlIGlmIChmX2Vsc2UpIHsKICAgICAgICAgICAgZl9lbHNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICB9OwoKICAvKioKICAgKiBOb3RpZnkgdGhlIHNoYXJlZCB3b3JrZXIgYW5kIG90aGVyIENDUCB0YWJzIHRoYXQgd2UgYXJlIG5vdyB0aGUgbWFzdGVyIGZvciB0aGUgZ2l2ZW4gdG9waWMuCiAgICovCiAgY29ubmVjdC5iZWNvbWVNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CgogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIC8vIFdlIGNhbid0IGJlIHRoZSBtYXN0ZXIgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50IQogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGNhbid0IGJlIHRoZSBtYXN0ZXIgZm9yIHRvcGljICclcycgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50ISIsIHRvcGljKTsKICAgICAgaWYgKGZhaWx1cmVDYWxsYmFjaykgewogICAgICAgIGZhaWx1cmVDYWxsYmFjaygpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgICBtYXN0ZXJDbGllbnQuY2FsbChjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQkVDT01FX01BU1RFUiwgewogICAgICAgIHRvcGljOiB0b3BpYwogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHN1Y2Nlc3NDYWxsYmFjaykgewogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2soKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbm5lY3QuQWdlbnQgPSBBZ2VudDsKICBjb25uZWN0LkFnZW50U25hcHNob3QgPSBBZ2VudFNuYXBzaG90OwogIGNvbm5lY3QuQ29udGFjdCA9IENvbnRhY3Q7CiAgY29ubmVjdC5Db250YWN0U25hcHNob3QgPSBDb250YWN0U25hcHNob3Q7CiAgLyoqIERlZmF1bHQgd2lsbCBnZXQgdGhlIFZvaWNlIGNvbm5lY3Rpb24gKi8KICBjb25uZWN0LkNvbm5lY3Rpb24gPSBWb2ljZUNvbm5lY3Rpb247CiAgY29ubmVjdC5CYXNlQ29ubmVjdGlvbiA9IENvbm5lY3Rpb247CiAgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24gPSBWb2ljZUNvbm5lY3Rpb247CiAgY29ubmVjdC5DaGF0Q29ubmVjdGlvbiA9IENoYXRDb25uZWN0aW9uOwogIGNvbm5lY3QuVGFza0Nvbm5lY3Rpb24gPSBUYXNrQ29ubmVjdGlvbjsKICBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCA9IENvbm5lY3Rpb25TbmFwc2hvdDsKICBjb25uZWN0LkVuZHBvaW50ID0gRW5kcG9pbnQ7CiAgY29ubmVjdC5BZGRyZXNzID0gRW5kcG9pbnQ7CiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvciA9IFNvZnRwaG9uZUVycm9yOwogIGNvbm5lY3QuVm9pY2VJZCA9IFZvaWNlSWQ7CiAgY29ubmVjdC5Db250YWN0UmVjb3JkaW5nID0gQ29udGFjdFJlY29yZGluZzsKfSkoKTsKCgoKLyoqKi8gfSksCgovKioqLyA4Mjc6Ci8qKiovICgobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSA9PiB7Cgp2YXIgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX187Ly8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi41NTMuMAovLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dAooZnVuY3Rpb24oKXtmdW5jdGlvbiByKGUsbix0KXtmdW5jdGlvbiBvKGksZil7aWYoIW5baV0pe2lmKCFlW2ldKXt2YXIgYz11bmRlZmluZWQ7aWYoIWYmJmMpcmV0dXJuIHJlcXVpcmUoaSwhMCk7aWYodSlyZXR1cm4gdShpLCEwKTt2YXIgYT1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitpKyInIik7dGhyb3cgYS5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixhfXZhciBwPW5baV09e2V4cG9ydHM6e319O2VbaV1bMF0uY2FsbChwLmV4cG9ydHMsZnVuY3Rpb24ocil7dmFyIG49ZVtpXVsxXVtyXTtyZXR1cm4gbyhufHxyKX0scCxwLmV4cG9ydHMscixlLG4sdCl9cmV0dXJuIG5baV0uZXhwb3J0c31mb3IodmFyIHU9dW5kZWZpbmVkLGk9MDtpPHQubGVuZ3RoO2krKylvKHRbaV0pO3JldHVybiBvfXJldHVybiByfSkoKSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInZlcnNpb24iOiAiMi4wIiwKICAgICJtZXRhZGF0YSI6IHsKICAgICAgImFwaVZlcnNpb24iOiAiMjAxNC0wNi0zMCIsCiAgICAgICJlbmRwb2ludFByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICAgImpzb25WZXJzaW9uIjogIjEuMSIsCiAgICAgICJwcm90b2NvbCI6ICJqc29uIiwKICAgICAgInNlcnZpY2VGdWxsTmFtZSI6ICJBbWF6b24gQ29nbml0byBJZGVudGl0eSIsCiAgICAgICJzZXJ2aWNlSWQiOiAiQ29nbml0byBJZGVudGl0eSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICAgInRhcmdldFByZWZpeCI6ICJBV1NDb2duaXRvSWRlbnRpdHlTZXJ2aWNlIiwKICAgICAgInVpZCI6ICJjb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAiCiAgICB9LAogICAgIm9wZXJhdGlvbnMiOiB7CiAgICAgICJDcmVhdGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9LAogICAgICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdXBwb3J0ZWRMb2dpblByb3ZpZGVycyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM4IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNmIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVsZXRlSWRlbnRpdGllcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZHNUb0RlbGV0ZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJVbnByb2Nlc3NlZElkZW50aXR5SWRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICAgICAgICJFcnJvckNvZGUiOiB7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlbGV0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzY3JpYmVJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTdSIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZXNjcmliZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQ3VzdG9tUm9sZUFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9LAogICAgICAgICAgICAgICAgIlNlY3JldEtleSI6IHt9LAogICAgICAgICAgICAgICAgIlNlc3Npb25Ub2tlbiI6IHt9LAogICAgICAgICAgICAgICAgIkV4cGlyYXRpb24iOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRJZCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2NvdW50SWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0SWRlbnRpdHlQb29sUm9sZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJSb2xlcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFiIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUm9sZU1hcHBpbmdzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWQiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRPcGVuSWRUb2tlbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3oiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0T3BlbklkVG9rZW5Gb3JEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiTG9naW5zIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU3oiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJUb2tlbkR1cmF0aW9uIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdElkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiTWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJIaWRlRGlzYWJsZWQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0aWVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU3UiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJMaXN0SWRlbnRpdHlQb29scyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiTWF4UmVzdWx0cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29scyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdFRhZ3NGb3JSZXNvdXJjZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUmVzb3VyY2VBcm4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVGFncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJMb29rdXBEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiOiB7fSwKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXJMaXN0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJNZXJnZURldmVsb3BlcklkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICAgIkRlc3RpbmF0aW9uVXNlcklkZW50aWZpZXIiLAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIiwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiU291cmNlVXNlcklkZW50aWZpZXIiOiB7fSwKICAgICAgICAgICAgIkRlc3RpbmF0aW9uVXNlcklkZW50aWZpZXIiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJSb2xlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJSb2xlcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFiIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUm9sZU1hcHBpbmdzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWQiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJUYWdSZXNvdXJjZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUmVzb3VyY2VBcm4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgICAiVGFncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVubGlua0RldmVsb3BlcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIiwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSIsCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbmxpbmtJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIsCiAgICAgICAgICAgICJMb2dpbnMiLAogICAgICAgICAgICAiTG9naW5zVG9SZW1vdmUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiTG9naW5zVG9SZW1vdmUiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN2IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW50YWdSZXNvdXJjZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUmVzb3VyY2VBcm4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSZXNvdXJjZUFybiI6IHt9LAogICAgICAgICAgICAiVGFnS2V5cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVXBkYXRlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgInNoYXBlcyI6IHsKICAgICAgIlM0IjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgIH0sCiAgICAgICJTOCI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjoge30KICAgICAgfSwKICAgICAgIlNhIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIkNsaWVudElkIjoge30sCiAgICAgICAgICAgICJTZXJ2ZXJTaWRlVG9rZW5DaGVjayI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2YiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTZyI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiU2oiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiLAogICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9LAogICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgIH0sCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiT3BlbklkQ29ubmVjdFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM4IgogICAgICAgICAgfSwKICAgICAgICAgICJDb2duaXRvSWRlbnRpdHlQcm92aWRlcnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTYSIKICAgICAgICAgIH0sCiAgICAgICAgICAiU2FtbFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNmIgogICAgICAgICAgfSwKICAgICAgICAgICJJZGVudGl0eVBvb2xUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2ciCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU3UiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiU3YiCiAgICAgICAgICB9LAogICAgICAgICAgIkNyZWF0aW9uRGF0ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfSwKICAgICAgICAgICJMYXN0TW9kaWZpZWREYXRlIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU3YiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTeiI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzFiIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgIH0sCiAgICAgICJTMWQiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlR5cGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJUeXBlIjoge30sCiAgICAgICAgICAgICJBbWJpZ3VvdXNSb2xlUmVzb2x1dGlvbiI6IHt9LAogICAgICAgICAgICAiUnVsZXNDb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgIlJ1bGVzIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiUnVsZXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgIkNsYWltIiwKICAgICAgICAgICAgICAgICAgICAgICJNYXRjaFR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgIlZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIgogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAiQ2xhaW0iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJNYXRjaFR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJWYWx1ZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIlJvbGVBUk4iOiB7fQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB9LHt9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAicGFnaW5hdGlvbiI6IHsKICAgIH0KICB9CiAgCiAgfSx7fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInZlcnNpb24iOiAiMi4wIiwKICAgICJtZXRhZGF0YSI6IHsKICAgICAgImFwaVZlcnNpb24iOiAiMjAxNy0wMi0xNSIsCiAgICAgICJlbmRwb2ludFByZWZpeCI6ICJjb25uZWN0IiwKICAgICAgImpzb25WZXJzaW9uIjogIjEuMCIsCiAgICAgICJwcm90b2NvbCI6ICJqc29uIiwKICAgICAgInNlcnZpY2VBYmJyZXZpYXRpb24iOiAiQ29ubmVjdCIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uQ29ubmVjdENUSVNlcnZpY2UiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICIiLAogICAgICAidGFyZ2V0UHJlZml4IjogIkFtYXpvbkNvbm5lY3RDVElTZXJ2aWNlIiwKICAgICAgInVpZCI6ICJjb25uZWN0LTIwMTctMDItMTUiCiAgICB9LAogICAgIm9wZXJhdGlvbnMiOiB7CiAgICAgICJBY2NlcHRDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ2xlYXJDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ29tcGxldGVDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ29uZmVyZW5jZUNvbm5lY3Rpb25zIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlQWRkaXRpb25hbENvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJlbmRwb2ludCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDcmVhdGVPdXRib3VuZENvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImVuZHBvaW50IgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicXVldWVBUk4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlVGFza0NvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImVuZHBvaW50IiwKICAgICAgICAgICAgIm5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJwcmV2aW91c0NvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiaWRlbXBvdGVuY3lUb2tlbiI6IHt9LAogICAgICAgICAgICAic2NoZWR1bGVkVGltZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJDcmVhdGVUcmFuc3BvcnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInRyYW5zcG9ydFR5cGUiLAogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ0cmFuc3BvcnRUeXBlIjoge30sCiAgICAgICAgICAgICJwYXJ0aWNpcGFudElkIjoge30sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgInNvZnRwaG9uZUNsaWVudElkIjoge30sCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ3ZWJTb2NrZXRUcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAidXJsIiwKICAgICAgICAgICAgICAgICJ0cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInVybCI6IHt9LAogICAgICAgICAgICAgICAgInRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJleHBpcnkiOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNoYXRUb2tlblRyYW5zcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJwYXJ0aWNpcGFudFRva2VuIiwKICAgICAgICAgICAgICAgICJleHBpcnkiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJwYXJ0aWNpcGFudFRva2VuIjoge30sCiAgICAgICAgICAgICAgICAiZXhwaXJ5Ijoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzb2Z0cGhvbmVUcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFDb25uZWN0aW9ucyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIiwKICAgICAgICAgICAgICAgICAgICAgICJjcmVkZW50aWFsIiwKICAgICAgICAgICAgICAgICAgICAgICJ1cmxzIgogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidXNlcm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJjcmVkZW50aWFsIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAidXJscyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlc3Ryb3lDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRDb25maWd1cmF0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFoIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRQZXJtaXNzaW9ucyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJwZXJtaXNzaW9ucyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInBlcm1pc3Npb25zIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRBZ2VudFNuYXBzaG90IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAidGltZW91dCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInNuYXBzaG90IiwKICAgICAgICAgICAgIm5leHRUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInNuYXBzaG90IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICJjb250YWN0cyIsCiAgICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibmV4dFN0YXRlIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJhZ2VudEF2YWlsYWJpbGl0eVN0YXRlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAidGltZVN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjb250YWN0cyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbnMiLAogICAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiCiAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsQ29udGFjdElkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAicXVldWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAicXVldWVUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImluaXRpYWwiCiAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUluZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsVHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhdXRvQWNjZXB0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZWRpYUxlZ0NvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsQ29udGV4dFRva2VuIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxDb25maWdKc29uIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0TWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdEF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25EYXRhIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImN1c3RvbWVyTmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9uaXRvcmluZ0luZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFnZW50TmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9pblRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZm9yY2VkTXV0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAicXVpY2tDb25uZWN0TmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JDYXBhYmlsaXRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibW9uaXRvclN0YXRlIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibmFtZSIKICAgICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3REdXJhdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhdGlvbk1ldGhvZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RGZWF0dXJlcyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgImF0dGFjaG1lbnRzRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnaW5nTWFya2Rvd25FbmFibGVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJtdWx0aVBhcnR5Q29uZmVyZW5jZUVuYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJjaGFubmVsQ29udGV4dCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInNjaGVkdWxlZFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRhc2tUZW1wbGF0ZUlkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInRhc2tUZW1wbGF0ZVZlcnNpb24iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRTdGF0ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAic3RhdGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAic3RhdGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RGlhbGFibGVDb3VudHJ5Q29kZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY291bnRyeUNvZGVzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY291bnRyeUNvZGVzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRFbmRwb2ludHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInF1ZXVlQVJOcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiZW5kcG9pbnRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2UiCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXROZXdBdXRoVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJlZnJlc2hUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAibmV3QXV0aFRva2VuIjoge30sCiAgICAgICAgICAgICJleHBpcmF0aW9uRGF0ZVRpbWUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iOiB7fSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInF1ZXVlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInF1ZXVlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiSG9sZENvbm5lY3Rpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJNdXRlUGFydGljaXBhbnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJOb3RpZnlDb250YWN0SXNzdWUiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiaXNzdWVDb2RlIjoge30sCiAgICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgICAiY2xpZW50TG9ncyI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJQdXRBZ2VudFN0YXRlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJzdGF0ZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJlbnF1ZXVlTmV4dFN0YXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlJlamVjdENvbnRhY3QiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJSZXN1bWVDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZENsaWVudExvZ3MiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImxvZ0V2ZW50cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImxvZ0V2ZW50cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgImNvbXBvbmVudCI6IHt9LAogICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHt9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kRGlnaXRzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIiwKICAgICAgICAgICAgImRpZ2l0cyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAgICJkaWdpdHMiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzN2IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZW5kU29mdHBob25lQ2FsbFJlcG9ydCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgInJlcG9ydCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgICAicmVwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiY2FsbFN0YXJ0VGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjYWxsRW5kVGltZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzIjogewogICAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzN2IgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJndW1UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpbml0aWFsaXphdGlvblRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZVRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInByZVRhbGtUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ0YWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY2xlYW51cFRpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImljZUNvbGxlY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImhhbmRzaGFrZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImd1bU90aGVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZ3VtVGltZW91dEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNyZWF0ZU9mZmVyRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInVzZXJCdXN5RmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiaW52YWxpZFJlbW90ZVNEUEZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm5vUmVtb3RlSWNlQ2FuZGlkYXRlRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2V0UmVtb3RlRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbm11dGVQYXJ0aWNpcGFudCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29uZmlndXJhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxaCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgInNoYXBlcyI6IHsKICAgICAgIlMyIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYWdlbnRBUk4iOiB7fSwKICAgICAgICAgICJhdXRoVG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInR5cGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJlbmRwb2ludEFSTiI6IHt9LAogICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAicGhvbmVOdW1iZXIiOiB7fSwKICAgICAgICAgICJhZ2VudExvZ2luIjoge30sCiAgICAgICAgICAicXVldWUiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTayI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInF1ZXVlQVJOIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU3IiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInZhbHVlIiwKICAgICAgICAgICAgInR5cGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ2YWx1ZSI6IHt9LAogICAgICAgICAgICAidHlwZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUzFoIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIm5hbWUiLAogICAgICAgICAgInNvZnRwaG9uZUVuYWJsZWQiLAogICAgICAgICAgInNvZnRwaG9uZUF1dG9BY2NlcHQiLAogICAgICAgICAgImV4dGVuc2lvbiIsCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAidXNlcm5hbWUiOiB7fSwKICAgICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJleHRlbnNpb24iOiB7fSwKICAgICAgICAgICJyb3V0aW5nUHJvZmlsZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iOiB7fSwKICAgICAgICAgICAgICAiZGVmYXVsdE91dGJvdW5kUXVldWUiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiY2hhbm5lbENvbmN1cnJlbmN5TWFwIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAiYWdlbnRQcmVmZXJlbmNlcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlMyMCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICJuYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYWdlbnRTdGF0ZUFSTiI6IHt9LAogICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAic3RhcnRUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTM3YiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1UeXBlIjoge30sCiAgICAgICAgICAgICJwYWNrZXRDb3VudCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicGFja2V0c0xvc3QiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImF1ZGlvTGV2ZWwiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiZG91YmxlIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiaml0dGVyQnVmZmVyTWlsbGlzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJyb3VuZFRyaXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgfSx7fV0sNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgImFjbSI6IHsKICAgICAgIm5hbWUiOiAiQUNNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwaWdhdGV3YXkiOiB7CiAgICAgICJuYW1lIjogIkFQSUdhdGV3YXkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwbGljYXRpb25hdXRvc2NhbGluZyI6IHsKICAgICAgInByZWZpeCI6ICJhcHBsaWNhdGlvbi1hdXRvc2NhbGluZyIsCiAgICAgICJuYW1lIjogIkFwcGxpY2F0aW9uQXV0b1NjYWxpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYXBwc3RyZWFtIjogewogICAgICAibmFtZSI6ICJBcHBTdHJlYW0iCiAgICB9LAogICAgImF1dG9zY2FsaW5nIjogewogICAgICAibmFtZSI6ICJBdXRvU2NhbGluZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJiYXRjaCI6IHsKICAgICAgIm5hbWUiOiAiQmF0Y2giCiAgICB9LAogICAgImJ1ZGdldHMiOiB7CiAgICAgICJuYW1lIjogIkJ1ZGdldHMiCiAgICB9LAogICAgImNsb3VkZGlyZWN0b3J5IjogewogICAgICAibmFtZSI6ICJDbG91ZERpcmVjdG9yeSIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNi0wNS0xMCoiCiAgICAgIF0KICAgIH0sCiAgICAiY2xvdWRmb3JtYXRpb24iOiB7CiAgICAgICJuYW1lIjogIkNsb3VkRm9ybWF0aW9uIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3VkZnJvbnQiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkRnJvbnQiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTMtMDUtMTIqIiwKICAgICAgICAiMjAxMy0xMS0xMSoiLAogICAgICAgICIyMDE0LTA1LTMxKiIsCiAgICAgICAgIjIwMTQtMTAtMjEqIiwKICAgICAgICAiMjAxNC0xMS0wNioiLAogICAgICAgICIyMDE1LTA0LTE3KiIsCiAgICAgICAgIjIwMTUtMDctMjcqIiwKICAgICAgICAiMjAxNS0wOS0xNyoiLAogICAgICAgICIyMDE2LTAxLTEzKiIsCiAgICAgICAgIjIwMTYtMDEtMjgqIiwKICAgICAgICAiMjAxNi0wOC0wMSoiLAogICAgICAgICIyMDE2LTA4LTIwKiIsCiAgICAgICAgIjIwMTYtMDktMDcqIiwKICAgICAgICAiMjAxNi0wOS0yOSoiLAogICAgICAgICIyMDE2LTExLTI1KiIsCiAgICAgICAgIjIwMTctMDMtMjUqIiwKICAgICAgICAiMjAxNy0xMC0zMCoiLAogICAgICAgICIyMDE4LTA2LTE4KiIsCiAgICAgICAgIjIwMTgtMTEtMDUqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWRoc20iOiB7CiAgICAgICJuYW1lIjogIkNsb3VkSFNNIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkc2VhcmNoIjogewogICAgICAibmFtZSI6ICJDbG91ZFNlYXJjaCIKICAgIH0sCiAgICAiY2xvdWRzZWFyY2hkb21haW4iOiB7CiAgICAgICJuYW1lIjogIkNsb3VkU2VhcmNoRG9tYWluIgogICAgfSwKICAgICJjbG91ZHRyYWlsIjogewogICAgICAibmFtZSI6ICJDbG91ZFRyYWlsIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2giOiB7CiAgICAgICJwcmVmaXgiOiAibW9uaXRvcmluZyIsCiAgICAgICJuYW1lIjogIkNsb3VkV2F0Y2giLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY2xvdWR3YXRjaGV2ZW50cyI6IHsKICAgICAgInByZWZpeCI6ICJldmVudHMiLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoRXZlbnRzIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE0LTAyLTAzKiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2hsb2dzIjogewogICAgICAicHJlZml4IjogImxvZ3MiLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoTG9ncyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlYnVpbGQiOiB7CiAgICAgICJuYW1lIjogIkNvZGVCdWlsZCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlY29tbWl0IjogewogICAgICAibmFtZSI6ICJDb2RlQ29tbWl0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVkZXBsb3kiOiB7CiAgICAgICJuYW1lIjogIkNvZGVEZXBsb3kiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZXBpcGVsaW5lIjogewogICAgICAibmFtZSI6ICJDb2RlUGlwZWxpbmUiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29nbml0b2lkZW50aXR5IjogewogICAgICAicHJlZml4IjogImNvZ25pdG8taWRlbnRpdHkiLAogICAgICAibmFtZSI6ICJDb2duaXRvSWRlbnRpdHkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29nbml0b2lkZW50aXR5c2VydmljZXByb3ZpZGVyIjogewogICAgICAicHJlZml4IjogImNvZ25pdG8taWRwIiwKICAgICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5U2VydmljZVByb3ZpZGVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9zeW5jIjogewogICAgICAicHJlZml4IjogImNvZ25pdG8tc3luYyIsCiAgICAgICJuYW1lIjogIkNvZ25pdG9TeW5jIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvbmZpZ3NlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiY29uZmlnIiwKICAgICAgIm5hbWUiOiAiQ29uZmlnU2VydmljZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb25uZWN0IjogewogICAgICAibmFtZSI6ICJDb25uZWN0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImN1ciI6IHsKICAgICAgIm5hbWUiOiAiQ1VSIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImRhdGFwaXBlbGluZSI6IHsKICAgICAgIm5hbWUiOiAiRGF0YVBpcGVsaW5lIgogICAgfSwKICAgICJkZXZpY2VmYXJtIjogewogICAgICAibmFtZSI6ICJEZXZpY2VGYXJtIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImRpcmVjdGNvbm5lY3QiOiB7CiAgICAgICJuYW1lIjogIkRpcmVjdENvbm5lY3QiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZGlyZWN0b3J5c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJkcyIsCiAgICAgICJuYW1lIjogIkRpcmVjdG9yeVNlcnZpY2UiCiAgICB9LAogICAgImRpc2NvdmVyeSI6IHsKICAgICAgIm5hbWUiOiAiRGlzY292ZXJ5IgogICAgfSwKICAgICJkbXMiOiB7CiAgICAgICJuYW1lIjogIkRNUyIKICAgIH0sCiAgICAiZHluYW1vZGIiOiB7CiAgICAgICJuYW1lIjogIkR5bmFtb0RCIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImR5bmFtb2Ric3RyZWFtcyI6IHsKICAgICAgInByZWZpeCI6ICJzdHJlYW1zLmR5bmFtb2RiIiwKICAgICAgIm5hbWUiOiAiRHluYW1vREJTdHJlYW1zIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVjMiI6IHsKICAgICAgIm5hbWUiOiAiRUMyIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEzLTA2LTE1KiIsCiAgICAgICAgIjIwMTMtMTAtMTUqIiwKICAgICAgICAiMjAxNC0wMi0wMSoiLAogICAgICAgICIyMDE0LTA1LTAxKiIsCiAgICAgICAgIjIwMTQtMDYtMTUqIiwKICAgICAgICAiMjAxNC0wOS0wMSoiLAogICAgICAgICIyMDE0LTEwLTAxKiIsCiAgICAgICAgIjIwMTUtMDMtMDEqIiwKICAgICAgICAiMjAxNS0wNC0xNSoiLAogICAgICAgICIyMDE1LTEwLTAxKiIsCiAgICAgICAgIjIwMTYtMDQtMDEqIiwKICAgICAgICAiMjAxNi0wOS0xNSoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlY3IiOiB7CiAgICAgICJuYW1lIjogIkVDUiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlY3MiOiB7CiAgICAgICJuYW1lIjogIkVDUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlZnMiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY2ZpbGVzeXN0ZW0iLAogICAgICAibmFtZSI6ICJFRlMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxhc3RpY2FjaGUiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aUNhY2hlIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEyLTExLTE1KiIsCiAgICAgICAgIjIwMTQtMDMtMjQqIiwKICAgICAgICAiMjAxNC0wNy0xNSoiLAogICAgICAgICIyMDE0LTA5LTMwKiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYXN0aWNiZWFuc3RhbGsiOiB7CiAgICAgICJuYW1lIjogIkVsYXN0aWNCZWFuc3RhbGsiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWxiIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5nIiwKICAgICAgIm5hbWUiOiAiRUxCIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYnYyIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNsb2FkYmFsYW5jaW5ndjIiLAogICAgICAibmFtZSI6ICJFTEJ2MiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbXIiOiB7CiAgICAgICJwcmVmaXgiOiAiZWxhc3RpY21hcHJlZHVjZSIsCiAgICAgICJuYW1lIjogIkVNUiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlcyI6IHsKICAgICAgIm5hbWUiOiAiRVMiCiAgICB9LAogICAgImVsYXN0aWN0cmFuc2NvZGVyIjogewogICAgICAibmFtZSI6ICJFbGFzdGljVHJhbnNjb2RlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJmaXJlaG9zZSI6IHsKICAgICAgIm5hbWUiOiAiRmlyZWhvc2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZ2FtZWxpZnQiOiB7CiAgICAgICJuYW1lIjogIkdhbWVMaWZ0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImdsYWNpZXIiOiB7CiAgICAgICJuYW1lIjogIkdsYWNpZXIiCiAgICB9LAogICAgImhlYWx0aCI6IHsKICAgICAgIm5hbWUiOiAiSGVhbHRoIgogICAgfSwKICAgICJpYW0iOiB7CiAgICAgICJuYW1lIjogIklBTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJpbXBvcnRleHBvcnQiOiB7CiAgICAgICJuYW1lIjogIkltcG9ydEV4cG9ydCIKICAgIH0sCiAgICAiaW5zcGVjdG9yIjogewogICAgICAibmFtZSI6ICJJbnNwZWN0b3IiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTUtMDgtMTgqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90IjogewogICAgICAibmFtZSI6ICJJb3QiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90ZGF0YSI6IHsKICAgICAgInByZWZpeCI6ICJpb3QtZGF0YSIsCiAgICAgICJuYW1lIjogIklvdERhdGEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpcyI6IHsKICAgICAgIm5hbWUiOiAiS2luZXNpcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzYW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzIgogICAgfSwKICAgICJrbXMiOiB7CiAgICAgICJuYW1lIjogIktNUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsYW1iZGEiOiB7CiAgICAgICJuYW1lIjogIkxhbWJkYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsZXhydW50aW1lIjogewogICAgICAicHJlZml4IjogInJ1bnRpbWUubGV4IiwKICAgICAgIm5hbWUiOiAiTGV4UnVudGltZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJsaWdodHNhaWwiOiB7CiAgICAgICJuYW1lIjogIkxpZ2h0c2FpbCIKICAgIH0sCiAgICAibWFjaGluZWxlYXJuaW5nIjogewogICAgICAibmFtZSI6ICJNYWNoaW5lTGVhcm5pbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWFya2V0cGxhY2Vjb21tZXJjZWFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiTWFya2V0cGxhY2VDb21tZXJjZUFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtYXJrZXRwbGFjZW1ldGVyaW5nIjogewogICAgICAicHJlZml4IjogIm1ldGVyaW5nbWFya2V0cGxhY2UiLAogICAgICAibmFtZSI6ICJNYXJrZXRwbGFjZU1ldGVyaW5nIgogICAgfSwKICAgICJtdHVyayI6IHsKICAgICAgInByZWZpeCI6ICJtdHVyay1yZXF1ZXN0ZXIiLAogICAgICAibmFtZSI6ICJNVHVyayIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtb2JpbGVhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIk1vYmlsZUFuYWx5dGljcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJvcHN3b3JrcyI6IHsKICAgICAgIm5hbWUiOiAiT3BzV29ya3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAib3Bzd29ya3NjbSI6IHsKICAgICAgIm5hbWUiOiAiT3BzV29ya3NDTSIKICAgIH0sCiAgICAib3JnYW5pemF0aW9ucyI6IHsKICAgICAgIm5hbWUiOiAiT3JnYW5pemF0aW9ucyIKICAgIH0sCiAgICAicGlucG9pbnQiOiB7CiAgICAgICJuYW1lIjogIlBpbnBvaW50IgogICAgfSwKICAgICJwb2xseSI6IHsKICAgICAgIm5hbWUiOiAiUG9sbHkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmRzIjogewogICAgICAibmFtZSI6ICJSRFMiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTQtMDktMDEqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVkc2hpZnQiOiB7CiAgICAgICJuYW1lIjogIlJlZHNoaWZ0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJla29nbml0aW9uIjogewogICAgICAibmFtZSI6ICJSZWtvZ25pdGlvbiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZXNvdXJjZWdyb3Vwc3RhZ2dpbmdhcGkiOiB7CiAgICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzVGFnZ2luZ0FQSSIKICAgIH0sCiAgICAicm91dGU1MyI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1MyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyb3V0ZTUzZG9tYWlucyI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1M0RvbWFpbnMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiczMiOiB7CiAgICAgICJuYW1lIjogIlMzIiwKICAgICAgImR1YWxzdGFja0F2YWlsYWJsZSI6IHRydWUsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzM2NvbnRyb2wiOiB7CiAgICAgICJuYW1lIjogIlMzQ29udHJvbCIsCiAgICAgICJkdWFsc3RhY2tBdmFpbGFibGUiOiB0cnVlCiAgICB9LAogICAgInNlcnZpY2VjYXRhbG9nIjogewogICAgICAibmFtZSI6ICJTZXJ2aWNlQ2F0YWxvZyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzZXMiOiB7CiAgICAgICJwcmVmaXgiOiAiZW1haWwiLAogICAgICAibmFtZSI6ICJTRVMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic2hpZWxkIjogewogICAgICAibmFtZSI6ICJTaGllbGQiCiAgICB9LAogICAgInNpbXBsZWRiIjogewogICAgICAicHJlZml4IjogInNkYiIsCiAgICAgICJuYW1lIjogIlNpbXBsZURCIgogICAgfSwKICAgICJzbXMiOiB7CiAgICAgICJuYW1lIjogIlNNUyIKICAgIH0sCiAgICAic25vd2JhbGwiOiB7CiAgICAgICJuYW1lIjogIlNub3diYWxsIgogICAgfSwKICAgICJzbnMiOiB7CiAgICAgICJuYW1lIjogIlNOUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzcXMiOiB7CiAgICAgICJuYW1lIjogIlNRUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzc20iOiB7CiAgICAgICJuYW1lIjogIlNTTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdG9yYWdlZ2F0ZXdheSI6IHsKICAgICAgIm5hbWUiOiAiU3RvcmFnZUdhdGV3YXkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic3RlcGZ1bmN0aW9ucyI6IHsKICAgICAgInByZWZpeCI6ICJzdGF0ZXMiLAogICAgICAibmFtZSI6ICJTdGVwRnVuY3Rpb25zIgogICAgfSwKICAgICJzdHMiOiB7CiAgICAgICJuYW1lIjogIlNUUyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJzdXBwb3J0IjogewogICAgICAibmFtZSI6ICJTdXBwb3J0IgogICAgfSwKICAgICJzd2YiOiB7CiAgICAgICJuYW1lIjogIlNXRiIKICAgIH0sCiAgICAieHJheSI6IHsKICAgICAgIm5hbWUiOiAiWFJheSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJ3YWYiOiB7CiAgICAgICJuYW1lIjogIldBRiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJ3YWZyZWdpb25hbCI6IHsKICAgICAgInByZWZpeCI6ICJ3YWYtcmVnaW9uYWwiLAogICAgICAibmFtZSI6ICJXQUZSZWdpb25hbCIKICAgIH0sCiAgICAid29ya2RvY3MiOiB7CiAgICAgICJuYW1lIjogIldvcmtEb2NzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIndvcmtzcGFjZXMiOiB7CiAgICAgICJuYW1lIjogIldvcmtTcGFjZXMiCiAgICB9LAogICAgImNvZGVzdGFyIjogewogICAgICAibmFtZSI6ICJDb2RlU3RhciIKICAgIH0sCiAgICAibGV4bW9kZWxidWlsZGluZ3NlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAibGV4LW1vZGVscyIsCiAgICAgICJuYW1lIjogIkxleE1vZGVsQnVpbGRpbmdTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1hcmtldHBsYWNlZW50aXRsZW1lbnRzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImVudGl0bGVtZW50Lm1hcmtldHBsYWNlIiwKICAgICAgIm5hbWUiOiAiTWFya2V0cGxhY2VFbnRpdGxlbWVudFNlcnZpY2UiCiAgICB9LAogICAgImF0aGVuYSI6IHsKICAgICAgIm5hbWUiOiAiQXRoZW5hIgogICAgfSwKICAgICJncmVlbmdyYXNzIjogewogICAgICAibmFtZSI6ICJHcmVlbmdyYXNzIgogICAgfSwKICAgICJkYXgiOiB7CiAgICAgICJuYW1lIjogIkRBWCIKICAgIH0sCiAgICAibWlncmF0aW9uaHViIjogewogICAgICAicHJlZml4IjogIkFXU01pZ3JhdGlvbkh1YiIsCiAgICAgICJuYW1lIjogIk1pZ3JhdGlvbkh1YiIKICAgIH0sCiAgICAiY2xvdWRoc212MiI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRIU01WMiIKICAgIH0sCiAgICAiZ2x1ZSI6IHsKICAgICAgIm5hbWUiOiAiR2x1ZSIKICAgIH0sCiAgICAibW9iaWxlIjogewogICAgICAibmFtZSI6ICJNb2JpbGUiCiAgICB9LAogICAgInByaWNpbmciOiB7CiAgICAgICJuYW1lIjogIlByaWNpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29zdGV4cGxvcmVyIjogewogICAgICAicHJlZml4IjogImNlIiwKICAgICAgIm5hbWUiOiAiQ29zdEV4cGxvcmVyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1lZGlhY29udmVydCI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFDb252ZXJ0IgogICAgfSwKICAgICJtZWRpYWxpdmUiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhTGl2ZSIKICAgIH0sCiAgICAibWVkaWFwYWNrYWdlIjogewogICAgICAibmFtZSI6ICJNZWRpYVBhY2thZ2UiCiAgICB9LAogICAgIm1lZGlhc3RvcmUiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhU3RvcmUiCiAgICB9LAogICAgIm1lZGlhc3RvcmVkYXRhIjogewogICAgICAicHJlZml4IjogIm1lZGlhc3RvcmUtZGF0YSIsCiAgICAgICJuYW1lIjogIk1lZGlhU3RvcmVEYXRhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcHN5bmMiOiB7CiAgICAgICJuYW1lIjogIkFwcFN5bmMiCiAgICB9LAogICAgImd1YXJkZHV0eSI6IHsKICAgICAgIm5hbWUiOiAiR3VhcmREdXR5IgogICAgfSwKICAgICJtcSI6IHsKICAgICAgIm5hbWUiOiAiTVEiCiAgICB9LAogICAgImNvbXByZWhlbmQiOiB7CiAgICAgICJuYW1lIjogIkNvbXByZWhlbmQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90am9ic2RhdGFwbGFuZSI6IHsKICAgICAgInByZWZpeCI6ICJpb3Qtam9icy1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW9USm9ic0RhdGFQbGFuZSIKICAgIH0sCiAgICAia2luZXNpc3ZpZGVvYXJjaGl2ZWRtZWRpYSI6IHsKICAgICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLWFyY2hpdmVkLW1lZGlhIiwKICAgICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvQXJjaGl2ZWRNZWRpYSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzdmlkZW9tZWRpYSI6IHsKICAgICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLW1lZGlhIiwKICAgICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvTWVkaWEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc3ZpZGVvIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW8iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic2FnZW1ha2VycnVudGltZSI6IHsKICAgICAgInByZWZpeCI6ICJydW50aW1lLnNhZ2VtYWtlciIsCiAgICAgICJuYW1lIjogIlNhZ2VNYWtlclJ1bnRpbWUiCiAgICB9LAogICAgInNhZ2VtYWtlciI6IHsKICAgICAgIm5hbWUiOiAiU2FnZU1ha2VyIgogICAgfSwKICAgICJ0cmFuc2xhdGUiOiB7CiAgICAgICJuYW1lIjogIlRyYW5zbGF0ZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZXNvdXJjZWdyb3VwcyI6IHsKICAgICAgInByZWZpeCI6ICJyZXNvdXJjZS1ncm91cHMiLAogICAgICAibmFtZSI6ICJSZXNvdXJjZUdyb3VwcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhbGV4YWZvcmJ1c2luZXNzIjogewogICAgICAibmFtZSI6ICJBbGV4YUZvckJ1c2luZXNzIgogICAgfSwKICAgICJjbG91ZDkiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkOSIKICAgIH0sCiAgICAic2VydmVybGVzc2FwcGxpY2F0aW9ucmVwb3NpdG9yeSI6IHsKICAgICAgInByZWZpeCI6ICJzZXJ2ZXJsZXNzcmVwbyIsCiAgICAgICJuYW1lIjogIlNlcnZlcmxlc3NBcHBsaWNhdGlvblJlcG9zaXRvcnkiCiAgICB9LAogICAgInNlcnZpY2VkaXNjb3ZlcnkiOiB7CiAgICAgICJuYW1lIjogIlNlcnZpY2VEaXNjb3ZlcnkiCiAgICB9LAogICAgIndvcmttYWlsIjogewogICAgICAibmFtZSI6ICJXb3JrTWFpbCIKICAgIH0sCiAgICAiYXV0b3NjYWxpbmdwbGFucyI6IHsKICAgICAgInByZWZpeCI6ICJhdXRvc2NhbGluZy1wbGFucyIsCiAgICAgICJuYW1lIjogIkF1dG9TY2FsaW5nUGxhbnMiCiAgICB9LAogICAgInRyYW5zY3JpYmVzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogInRyYW5zY3JpYmUiLAogICAgICAibmFtZSI6ICJUcmFuc2NyaWJlU2VydmljZSIKICAgIH0sCiAgICAiY29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiQ29ubmVjdCIKICAgIH0sCiAgICAiYWNtcGNhIjogewogICAgICAicHJlZml4IjogImFjbS1wY2EiLAogICAgICAibmFtZSI6ICJBQ01QQ0EiCiAgICB9LAogICAgImZtcyI6IHsKICAgICAgIm5hbWUiOiAiRk1TIgogICAgfSwKICAgICJzZWNyZXRzbWFuYWdlciI6IHsKICAgICAgIm5hbWUiOiAiU2VjcmV0c01hbmFnZXIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW90YW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJJb1RBbmFseXRpY3MiLAogICAgICAiY29ycyI6IHRydWUJCiAgICB9LAogICAgImlvdDFjbGlja2RldmljZXNzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImlvdDFjbGljay1kZXZpY2VzIiwKICAgICAgIm5hbWUiOiAiSW9UMUNsaWNrRGV2aWNlc1NlcnZpY2UiCiAgICB9LAogICAgImlvdDFjbGlja3Byb2plY3RzIjogewogICAgICAicHJlZml4IjogImlvdDFjbGljay1wcm9qZWN0cyIsCiAgICAgICJuYW1lIjogIklvVDFDbGlja1Byb2plY3RzIgogICAgfSwKICAgICJwaSI6IHsKICAgICAgIm5hbWUiOiAiUEkiCiAgICB9LAogICAgIm5lcHR1bmUiOiB7CiAgICAgICJuYW1lIjogIk5lcHR1bmUiCiAgICB9LAogICAgIm1lZGlhdGFpbG9yIjogewogICAgICAibmFtZSI6ICJNZWRpYVRhaWxvciIKICAgIH0sCiAgICAiZWtzIjogewogICAgICAibmFtZSI6ICJFS1MiCiAgICB9LAogICAgIm1hY2llIjogewogICAgICAibmFtZSI6ICJNYWNpZSIKICAgIH0sCiAgICAiZGxtIjogewogICAgICAibmFtZSI6ICJETE0iCiAgICB9LAogICAgInNpZ25lciI6IHsKICAgICAgIm5hbWUiOiAiU2lnbmVyIgogICAgfSwKICAgICJjaGltZSI6IHsKICAgICAgIm5hbWUiOiAiQ2hpbWUiCiAgICB9LAogICAgInBpbnBvaW50ZW1haWwiOiB7CiAgICAgICJwcmVmaXgiOiAicGlucG9pbnQtZW1haWwiLAogICAgICAibmFtZSI6ICJQaW5wb2ludEVtYWlsIgogICAgfSwKICAgICJyYW0iOiB7CiAgICAgICJuYW1lIjogIlJBTSIKICAgIH0sCiAgICAicm91dGU1M3Jlc29sdmVyIjogewogICAgICAibmFtZSI6ICJSb3V0ZTUzUmVzb2x2ZXIiCiAgICB9LAogICAgInBpbnBvaW50c21zdm9pY2UiOiB7CiAgICAgICJwcmVmaXgiOiAic21zLXZvaWNlIiwKICAgICAgIm5hbWUiOiAiUGlucG9pbnRTTVNWb2ljZSIKICAgIH0sCiAgICAicXVpY2tzaWdodCI6IHsKICAgICAgIm5hbWUiOiAiUXVpY2tTaWdodCIKICAgIH0sCiAgICAicmRzZGF0YXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAicmRzLWRhdGEiLAogICAgICAibmFtZSI6ICJSRFNEYXRhU2VydmljZSIKICAgIH0sCiAgICAiYW1wbGlmeSI6IHsKICAgICAgIm5hbWUiOiAiQW1wbGlmeSIKICAgIH0sCiAgICAiZGF0YXN5bmMiOiB7CiAgICAgICJuYW1lIjogIkRhdGFTeW5jIgogICAgfSwKICAgICJyb2JvbWFrZXIiOiB7CiAgICAgICJuYW1lIjogIlJvYm9NYWtlciIKICAgIH0sCiAgICAidHJhbnNmZXIiOiB7CiAgICAgICJuYW1lIjogIlRyYW5zZmVyIgogICAgfSwKICAgICJnbG9iYWxhY2NlbGVyYXRvciI6IHsKICAgICAgIm5hbWUiOiAiR2xvYmFsQWNjZWxlcmF0b3IiCiAgICB9LAogICAgImNvbXByZWhlbmRtZWRpY2FsIjogewogICAgICAibmFtZSI6ICJDb21wcmVoZW5kTWVkaWNhbCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJraW5lc2lzYW5hbHl0aWNzdjIiOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3NWMiIKICAgIH0sCiAgICAibWVkaWFjb25uZWN0IjogewogICAgICAibmFtZSI6ICJNZWRpYUNvbm5lY3QiCiAgICB9LAogICAgImZzeCI6IHsKICAgICAgIm5hbWUiOiAiRlN4IgogICAgfSwKICAgICJzZWN1cml0eWh1YiI6IHsKICAgICAgIm5hbWUiOiAiU2VjdXJpdHlIdWIiCiAgICB9LAogICAgImFwcG1lc2giOiB7CiAgICAgICJuYW1lIjogIkFwcE1lc2giLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTgtMTAtMDEqIgogICAgICBdCiAgICB9LAogICAgImxpY2Vuc2VtYW5hZ2VyIjogewogICAgICAicHJlZml4IjogImxpY2Vuc2UtbWFuYWdlciIsCiAgICAgICJuYW1lIjogIkxpY2Vuc2VNYW5hZ2VyIgogICAgfSwKICAgICJrYWZrYSI6IHsKICAgICAgIm5hbWUiOiAiS2Fma2EiCiAgICB9LAogICAgImFwaWdhdGV3YXltYW5hZ2VtZW50YXBpIjogewogICAgICAibmFtZSI6ICJBcGlHYXRld2F5TWFuYWdlbWVudEFwaSIKICAgIH0sCiAgICAiYXBpZ2F0ZXdheXYyIjogewogICAgICAibmFtZSI6ICJBcGlHYXRld2F5VjIiCiAgICB9LAogICAgImRvY2RiIjogewogICAgICAibmFtZSI6ICJEb2NEQiIKICAgIH0sCiAgICAiYmFja3VwIjogewogICAgICAibmFtZSI6ICJCYWNrdXAiCiAgICB9LAogICAgIndvcmtsaW5rIjogewogICAgICAibmFtZSI6ICJXb3JrTGluayIKICAgIH0sCiAgICAidGV4dHJhY3QiOiB7CiAgICAgICJuYW1lIjogIlRleHRyYWN0IgogICAgfSwKICAgICJtYW5hZ2VkYmxvY2tjaGFpbiI6IHsKICAgICAgIm5hbWUiOiAiTWFuYWdlZEJsb2NrY2hhaW4iCiAgICB9LAogICAgIm1lZGlhcGFja2FnZXZvZCI6IHsKICAgICAgInByZWZpeCI6ICJtZWRpYXBhY2thZ2Utdm9kIiwKICAgICAgIm5hbWUiOiAiTWVkaWFQYWNrYWdlVm9kIgogICAgfSwKICAgICJncm91bmRzdGF0aW9uIjogewogICAgICAibmFtZSI6ICJHcm91bmRTdGF0aW9uIgogICAgfSwKICAgICJpb3R0aGluZ3NncmFwaCI6IHsKICAgICAgIm5hbWUiOiAiSW9UVGhpbmdzR3JhcGgiCiAgICB9LAogICAgImlvdGV2ZW50cyI6IHsKICAgICAgIm5hbWUiOiAiSW9URXZlbnRzIgogICAgfSwKICAgICJpb3RldmVudHNkYXRhIjogewogICAgICAicHJlZml4IjogImlvdGV2ZW50cy1kYXRhIiwKICAgICAgIm5hbWUiOiAiSW9URXZlbnRzRGF0YSIKICAgIH0sCiAgICAicGVyc29uYWxpemUiOiB7CiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInBlcnNvbmFsaXplZXZlbnRzIjogewogICAgICAicHJlZml4IjogInBlcnNvbmFsaXplLWV2ZW50cyIsCiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplRXZlbnRzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInBlcnNvbmFsaXplcnVudGltZSI6IHsKICAgICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ydW50aW1lIiwKICAgICAgIm5hbWUiOiAiUGVyc29uYWxpemVSdW50aW1lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcGxpY2F0aW9uaW5zaWdodHMiOiB7CiAgICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24taW5zaWdodHMiLAogICAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkluc2lnaHRzIgogICAgfSwKICAgICJzZXJ2aWNlcXVvdGFzIjogewogICAgICAicHJlZml4IjogInNlcnZpY2UtcXVvdGFzIiwKICAgICAgIm5hbWUiOiAiU2VydmljZVF1b3RhcyIKICAgIH0sCiAgICAiZWMyaW5zdGFuY2Vjb25uZWN0IjogewogICAgICAicHJlZml4IjogImVjMi1pbnN0YW5jZS1jb25uZWN0IiwKICAgICAgIm5hbWUiOiAiRUMySW5zdGFuY2VDb25uZWN0IgogICAgfSwKICAgICJldmVudGJyaWRnZSI6IHsKICAgICAgIm5hbWUiOiAiRXZlbnRCcmlkZ2UiCiAgICB9LAogICAgImxha2Vmb3JtYXRpb24iOiB7CiAgICAgICJuYW1lIjogIkxha2VGb3JtYXRpb24iCiAgICB9LAogICAgImZvcmVjYXN0c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJmb3JlY2FzdCIsCiAgICAgICJuYW1lIjogIkZvcmVjYXN0U2VydmljZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJmb3JlY2FzdHF1ZXJ5c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJmb3JlY2FzdHF1ZXJ5IiwKICAgICAgIm5hbWUiOiAiRm9yZWNhc3RRdWVyeVNlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicWxkYiI6IHsKICAgICAgIm5hbWUiOiAiUUxEQiIKICAgIH0sCiAgICAicWxkYnNlc3Npb24iOiB7CiAgICAgICJwcmVmaXgiOiAicWxkYi1zZXNzaW9uIiwKICAgICAgIm5hbWUiOiAiUUxEQlNlc3Npb24iCiAgICB9LAogICAgIndvcmttYWlsbWVzc2FnZWZsb3ciOiB7CiAgICAgICJuYW1lIjogIldvcmtNYWlsTWVzc2FnZUZsb3ciCiAgICB9CiAgfQogIAogIH0se31dLDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTEtMDYtMTUiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAic3RzIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogInN0cy5hbWF6b25hd3MuY29tIiwKICAgICAgInByb3RvY29sIjogInF1ZXJ5IiwKICAgICAgInNlcnZpY2VBYmJyZXZpYXRpb24iOiAiQVdTIFNUUyIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQVdTIFNlY3VyaXR5IFRva2VuIFNlcnZpY2UiLAogICAgICAic2VydmljZUlkIjogIlNUUyIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInY0IiwKICAgICAgInVpZCI6ICJzdHMtMjAxMS0wNi0xNSIsCiAgICAgICJ4bWxOYW1lc3BhY2UiOiAiaHR0cHM6Ly9zdHMuYW1hem9uYXdzLmNvbS9kb2MvMjAxMS0wNi0xNS8iCiAgICB9LAogICAgIm9wZXJhdGlvbnMiOiB7CiAgICAgICJBc3N1bWVSb2xlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRXh0ZXJuYWxJZCI6IHt9LAogICAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAgICJUb2tlbkNvZGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkFzc3VtZVJvbGVXaXRoU0FNTCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJQcmluY2lwYWxBcm4iLAogICAgICAgICAgICAiU0FNTEFzc2VydGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlByaW5jaXBhbEFybiI6IHt9LAogICAgICAgICAgICAiU0FNTEFzc2VydGlvbiI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhTQU1MUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdWJqZWN0Ijoge30sCiAgICAgICAgICAgICJTdWJqZWN0VHlwZSI6IHt9LAogICAgICAgICAgICAiSXNzdWVyIjoge30sCiAgICAgICAgICAgICJBdWRpZW5jZSI6IHt9LAogICAgICAgICAgICAiTmFtZVF1YWxpZmllciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiLAogICAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlJvbGVBcm4iOiB7fSwKICAgICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiI6IHt9LAogICAgICAgICAgICAiUHJvdmlkZXJJZCI6IHt9LAogICAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTdWJqZWN0RnJvbVdlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQcm92aWRlciI6IHt9LAogICAgICAgICAgICAiQXVkaWVuY2UiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlY29kZUF1dGhvcml6YXRpb25NZXNzYWdlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkVuY29kZWRNZXNzYWdlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJEZWNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWNjZXNzS2V5SW5mbyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiQWNjZXNzS2V5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0QWNjZXNzS2V5SW5mb1Jlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJBY2NvdW50Ijoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRDYWxsZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldENhbGxlcklkZW50aXR5UmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlVzZXJJZCI6IHt9LAogICAgICAgICAgICAiQWNjb3VudCI6IHt9LAogICAgICAgICAgICAiQXJuIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRGZWRlcmF0aW9uVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIk5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJOYW1lIjoge30sCiAgICAgICAgICAgICJQb2xpY3kiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRGZWRlcmF0aW9uVG9rZW5SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRmVkZXJhdGVkVXNlciI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiLAogICAgICAgICAgICAgICAgIkFybiIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXJJZCI6IHt9LAogICAgICAgICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0U2Vzc2lvblRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU2VyaWFsTnVtYmVyIjoge30sCiAgICAgICAgICAgICJUb2tlbkNvZGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldFNlc3Npb25Ub2tlblJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAic2hhcGVzIjogewogICAgICAiUzQiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2MiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiQWNjZXNzS2V5SWQiLAogICAgICAgICAgIlNlY3JldEFjY2Vzc0tleSIsCiAgICAgICAgICAiU2Vzc2lvblRva2VuIiwKICAgICAgICAgICJFeHBpcmF0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiOiB7fSwKICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2giOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiQXNzdW1lZFJvbGVJZCIsCiAgICAgICAgICAiQXJuIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQXNzdW1lZFJvbGVJZCI6IHt9LAogICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGFyZ3VtZW50c1s0XVsyXVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKICB9LHsiZHVwIjoyfV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CiAgdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKICB2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKICAKICBhcGlMb2FkZXIuc2VydmljZXNbJ2NvZ25pdG9pZGVudGl0eSddID0ge307CiAgQVdTLkNvZ25pdG9JZGVudGl0eSA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29nbml0b2lkZW50aXR5JywgWycyMDE0LTA2LTMwJ10pOwogIHJlcXVpcmUoJy4uL2xpYi9zZXJ2aWNlcy9jb2duaXRvaWRlbnRpdHknKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSwgJzIwMTQtMDYtMzAnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24nKTsKICAgICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbicpLnBhZ2luYXRpb247CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSk7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuQ29nbml0b0lkZW50aXR5OwogIAogIH0seyIuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5taW4uanNvbiI6MSwiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAucGFnaW5hdG9ycy5qc29uIjoyLCIuLi9saWIvY29yZSI6MTgsIi4uL2xpYi9ub2RlX2xvYWRlciI6MTYsIi4uL2xpYi9zZXJ2aWNlcy9jb2duaXRvaWRlbnRpdHkiOjYwfV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2xpYi9jb3JlJyk7CiAgdmFyIFNlcnZpY2UgPSBBV1MuU2VydmljZTsKICB2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKICAKICBhcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddID0ge307CiAgQVdTLlNUUyA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnc3RzJywgWycyMDExLTA2LTE1J10pOwogIHJlcXVpcmUoJy4uL2xpYi9zZXJ2aWNlcy9zdHMnKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSwgJzIwMTEtMDYtMTUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIG1vZGVsID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbicpOwogICAgICBtb2RlbC5wYWdpbmF0b3JzID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwogIAogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNUUzsKICAKICB9LHsiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4uanNvbiI6NSwiLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5wYWdpbmF0b3JzLmpzb24iOjYsIi4uL2xpYi9jb3JlIjoxOCwiLi4vbGliL25vZGVfbG9hZGVyIjoxNiwiLi4vbGliL3NlcnZpY2VzL3N0cyI6NjF9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBmdW5jdGlvbiBhcGlMb2FkZXIoc3ZjLCB2ZXJzaW9uKSB7CiAgICBpZiAoIWFwaUxvYWRlci5zZXJ2aWNlcy5oYXNPd25Qcm9wZXJ0eShzdmMpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZFNlcnZpY2U6IEZhaWxlZCB0byBsb2FkIGFwaSBmb3IgJyArIHN2Yyk7CiAgICB9CiAgICByZXR1cm4gYXBpTG9hZGVyLnNlcnZpY2VzW3N2Y11bdmVyc2lvbl07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogVGhpcyBtZW1iZXIgb2YgQVdTLmFwaUxvYWRlciBpcyBwcml2YXRlLCBidXQgY2hhbmdpbmcgaXQgd2lsbCBuZWNlc3NpdGF0ZSBhCiAgICogY2hhbmdlIHRvIC4uL3NjcmlwdHMvc2VydmljZXMtdGFibGUtZ2VuZXJhdG9yLnRzCiAgICovCiAgYXBpTG9hZGVyLnNlcnZpY2VzID0ge307CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBhcGlMb2FkZXI7CiAgCiAgfSx7fV0sMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBIbWFjID0gcmVxdWlyZSgnLi9icm93c2VySG1hYycpOwogIHZhciBNZDUgPSByZXF1aXJlKCcuL2Jyb3dzZXJNZDUnKTsKICB2YXIgU2hhMSA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTEnKTsKICB2YXIgU2hhMjU2ID0gcmVxdWlyZSgnLi9icm93c2VyU2hhMjU2Jyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZykgewogICAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IE1kNSgpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgICAgcmV0dXJuIG5ldyBTaGEyNTYoKTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFNoYTEoKTsKICAgICAgICB9CiAgCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIYXNoIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgICB9LAogICAgICBjcmVhdGVIbWFjOiBmdW5jdGlvbiBjcmVhdGVIbWFjKGFsZywga2V5KSB7CiAgICAgICAgYWxnID0gYWxnLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKGFsZyA9PT0gJ21kNScpIHsKICAgICAgICAgIHJldHVybiBuZXcgSG1hYyhNZDUsIGtleSk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGEyNTYnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMjU2LCBrZXkpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMScpIHsKICAgICAgICAgIHJldHVybiBuZXcgSG1hYyhTaGExLCBrZXkpOwogICAgICAgIH0KICAKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0hNQUMgYWxnb3JpdGhtICcgKyBhbGcgKyAnIGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhlIGJyb3dzZXIgU0RLJyk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZVNpZ246IGZ1bmN0aW9uKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignY3JlYXRlU2lnbiBpcyBub3QgaW1wbGVtZW50ZWQgaW4gdGhlIGJyb3dzZXInKTsKICAgICAgfQogICAgfTsKICAKICB9LHsiLi9icm93c2VySG1hYyI6MTIsIi4vYnJvd3Nlck1kNSI6MTMsIi4vYnJvd3NlclNoYTEiOjE0LCIuL2Jyb3dzZXJTaGEyNTYiOjE1fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIAogIC8qKgogICAqIFRoaXMgaXMgYSBwb2x5ZmlsbCBmb3IgdGhlIHN0YXRpYyBtZXRob2QgYGlzVmlld2Agb2YgYEFycmF5QnVmZmVyYCwgd2hpY2ggaXMKICAgKiBlLmcuIG1pc3NpbmcgaW4gSUUgMTAuCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpZiAoCiAgICAgIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgICAgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ3VuZGVmaW5lZCcKICApIHsKICAgICAgQXJyYXlCdWZmZXIuaXNWaWV3ID0gZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICByZXR1cm4gdmlld1N0cmluZ3MuaW5kZXhPZihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYXJnKSkgPiAtMTsKICAgICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIHZpZXdTdHJpbmdzID0gWwogICAgICAnW29iamVjdCBJbnQ4QXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDhBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0nLAogICAgICAnW29iamVjdCBJbnQxNkFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQxNkFycmF5XScsCiAgICAgICdbb2JqZWN0IEludDMyQXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDMyQXJyYXldJywKICAgICAgJ1tvYmplY3QgRmxvYXQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IEZsb2F0NjRBcnJheV0nLAogICAgICAnW29iamVjdCBEYXRhVmlld10nLAogIF07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaXNFbXB0eURhdGEoZGF0YSkgewogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gZGF0YS5sZW5ndGggPT09IDA7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGEuYnl0ZUxlbmd0aCA9PT0gMDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gY29udmVydFRvQnVmZmVyKGRhdGEpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgZGF0YSA9IG5ldyBCdWZmZXIoZGF0YSwgJ3V0ZjgnKTsKICAgICAgfQogIAogICAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZGF0YS5idWZmZXIsIGRhdGEuYnl0ZU9mZnNldCwgZGF0YS5ieXRlTGVuZ3RoIC8gVWludDhBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7CiAgICAgIGlzRW1wdHlEYXRhOiBpc0VtcHR5RGF0YSwKICAgICAgY29udmVydFRvQnVmZmVyOiBjb252ZXJ0VG9CdWZmZXIsCiAgfTsKICAKICB9LHsiYnVmZmVyLyI6ODF9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIEhtYWMoaGFzaEN0b3IsIHNlY3JldCkgewogICAgICB0aGlzLmhhc2ggPSBuZXcgaGFzaEN0b3IoKTsKICAgICAgdGhpcy5vdXRlciA9IG5ldyBoYXNoQ3RvcigpOwogIAogICAgICB2YXIgaW5uZXIgPSBidWZmZXJGcm9tU2VjcmV0KGhhc2hDdG9yLCBzZWNyZXQpOwogICAgICB2YXIgb3V0ZXIgPSBuZXcgVWludDhBcnJheShoYXNoQ3Rvci5CTE9DS19TSVpFKTsKICAgICAgb3V0ZXIuc2V0KGlubmVyKTsKICAKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBoYXNoQ3Rvci5CTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgIGlubmVyW2ldIF49IDB4MzY7CiAgICAgICAgICBvdXRlcltpXSBePSAweDVjOwogICAgICB9CiAgCiAgICAgIHRoaXMuaGFzaC51cGRhdGUoaW5uZXIpOwogICAgICB0aGlzLm91dGVyLnVwZGF0ZShvdXRlcik7CiAgCiAgICAgIC8vIFplcm8gb3V0IHRoZSBjb3BpZWQga2V5IGJ1ZmZlci4KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbm5lci5ieXRlTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlubmVyW2ldID0gMDsKICAgICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBIbWFjOwogIAogIEhtYWMucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICh0b0hhc2gpIHsKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YSh0b0hhc2gpIHx8IHRoaXMuZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLmhhc2gudXBkYXRlKGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIodG9IYXNoKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRoaXMuZXJyb3IgPSBlOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgSG1hYy5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIGlmICghdGhpcy5vdXRlci5maW5pc2hlZCkgewogICAgICAgICAgdGhpcy5vdXRlci51cGRhdGUodGhpcy5oYXNoLmRpZ2VzdCgpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpcy5vdXRlci5kaWdlc3QoZW5jb2RpbmcpOwogIH07CiAgCiAgZnVuY3Rpb24gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KSB7CiAgICAgIHZhciBpbnB1dCA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc2VjcmV0KTsKICAgICAgaWYgKGlucHV0LmJ5dGVMZW5ndGggPiBoYXNoQ3Rvci5CTE9DS19TSVpFKSB7CiAgICAgICAgICB2YXIgYnVmZmVySGFzaCA9IG5ldyBoYXNoQ3RvcjsKICAgICAgICAgIGJ1ZmZlckhhc2gudXBkYXRlKGlucHV0KTsKICAgICAgICAgIGlucHV0ID0gYnVmZmVySGFzaC5kaWdlc3QoKTsKICAgICAgfQogICAgICB2YXIgYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICAgIGJ1ZmZlci5zZXQoaW5wdXQpOwogICAgICByZXR1cm4gYnVmZmVyOwogIH0KICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMX1dLDEzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDE2OwogIAogIHZhciBJTklUID0gWwogICAgICAweDY3NDUyMzAxLAogICAgICAweGVmY2RhYjg5LAogICAgICAweDk4YmFkY2ZlLAogICAgICAweDEwMzI1NDc2LAogIF07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gTWQ1KCkgewogICAgICB0aGlzLnN0YXRlID0gWwogICAgICAgICAgMHg2NzQ1MjMwMSwKICAgICAgICAgIDB4ZWZjZGFiODksCiAgICAgICAgICAweDk4YmFkY2ZlLAogICAgICAgICAgMHgxMDMyNTQ3NiwKICAgICAgXTsKICAgICAgdGhpcy5idWZmZXIgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKEJMT0NLX1NJWkUpKTsKICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgICAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSBNZDU7CiAgCiAgTWQ1LkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwogIAogIE1kNS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKHNvdXJjZURhdGEpIHsKICAgICAgaWYgKGhhc2hVdGlscy5pc0VtcHR5RGF0YShzb3VyY2VEYXRhKSkgewogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICB2YXIgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoc291cmNlRGF0YSk7CiAgICAgIHZhciBwb3NpdGlvbiA9IDA7CiAgICAgIHZhciBieXRlTGVuZ3RoID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkICs9IGJ5dGVMZW5ndGg7CiAgICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgICAgdGhpcy5idWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgZGF0YVtwb3NpdGlvbisrXSk7CiAgICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBNZDUucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgdW5kZWNvcmF0ZWRMZW5ndGggPSBfYS5idWZmZXJMZW5ndGgsIGJ5dGVzSGFzaGVkID0gX2EuYnl0ZXNIYXNoZWQ7CiAgICAgICAgICB2YXIgYml0c0hhc2hlZCA9IGJ5dGVzSGFzaGVkICogODsKICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAxMjgpOwogICAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRSAtIDg7IGkrKykgewogICAgICAgICAgICAgIGJ1ZmZlci5zZXRVaW50OChpLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIGJpdHNIYXNoZWQgPj4+IDAsIHRydWUpOwogICAgICAgICAgYnVmZmVyLnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgTWF0aC5mbG9vcihiaXRzSGFzaGVkIC8gMHgxMDAwMDAwMDApLCB0cnVlKTsKICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgdGhpcy5maW5pc2hlZCA9IHRydWU7CiAgICAgIH0KICAgICAgdmFyIG91dCA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoRElHRVNUX0xFTkdUSCkpOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgb3V0LnNldFVpbnQzMihpICogNCwgdGhpcy5zdGF0ZVtpXSwgdHJ1ZSk7CiAgICAgIH0KICAgICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKG91dC5idWZmZXIsIG91dC5ieXRlT2Zmc2V0LCBvdXQuYnl0ZUxlbmd0aCk7CiAgICAgIHJldHVybiBlbmNvZGluZyA/IGJ1ZmYudG9TdHJpbmcoZW5jb2RpbmcpIDogYnVmZjsKICB9OwogIAogIE1kNS5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9hID0gdGhpcywgYnVmZmVyID0gX2EuYnVmZmVyLCBzdGF0ZSA9IF9hLnN0YXRlOwogICAgICB2YXIgYSA9IHN0YXRlWzBdLCBiID0gc3RhdGVbMV0sIGMgPSBzdGF0ZVsyXSwgZCA9IHN0YXRlWzNdOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNywgMHhkNzZhYTQ3OCk7CiAgICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCAxMiwgMHhlOGM3Yjc1Nik7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNywgMHgyNDIwNzBkYik7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMjIsIDB4YzFiZGNlZWUpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDcsIDB4ZjU3YzBmYWYpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDEyLCAweDQ3ODdjNjJhKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNywgMHhhODMwNDYxMyk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMjIsIDB4ZmQ0Njk1MDEpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDcsIDB4Njk4MDk4ZDgpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDEyLCAweDhiNDRmN2FmKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAxNywgMHhmZmZmNWJiMSk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMjIsIDB4ODk1Y2Q3YmUpOwogICAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDcsIDB4NmI5MDExMjIpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDEyLCAweGZkOTg3MTkzKTsKICAgICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAxNywgMHhhNjc5NDM4ZSk7CiAgICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMjIsIDB4NDliNDA4MjEpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNSwgMHhmNjFlMjU2Mik7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgOSwgMHhjMDQwYjM0MCk7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTQsIDB4MjY1ZTVhNTEpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgMjAsIDB4ZTliNmM3YWEpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDUsIDB4ZDYyZjEwNWQpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDksIDB4MDI0NDE0NTMpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDE0LCAweGQ4YTFlNjgxKTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAyMCwgMHhlN2QzZmJjOCk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgNSwgMHgyMWUxY2RlNik7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgOSwgMHhjMzM3MDdkNik7CiAgICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTQsIDB4ZjRkNTBkODcpOwogICAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDIwLCAweDQ1NWExNGVkKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA1LCAweGE5ZTNlOTA1KTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDksIDB4ZmNlZmEzZjgpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE0LCAweDY3NmYwMmQ5KTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAyMCwgMHg4ZDJhNGM4YSk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgNCwgMHhmZmZhMzk0Mik7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDMyLCB0cnVlKSwgMTEsIDB4ODc3MWY2ODEpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE2LCAweDZkOWQ2MTIyKTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAyMywgMHhmZGU1MzgwYyk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCA0LCAweGE0YmVlYTQ0KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAxMSwgMHg0YmRlY2ZhOSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTYsIDB4ZjZiYjRiNjApOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDIzLCAweGJlYmZiYzcwKTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCA0LCAweDI4OWI3ZWM2KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDExLCAweGVhYTEyN2ZhKTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxNiwgMHhkNGVmMzA4NSk7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMjMsIDB4MDQ4ODFkMDUpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDQsIDB4ZDlkNGQwMzkpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDExLCAweGU2ZGI5OWU1KTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNiwgMHgxZmEyN2NmOCk7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAyMywgMHhjNGFjNTY2NSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCA2LCAweGY0MjkyMjQ0KTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxMCwgMHg0MzJhZmY5Nyk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTUsIDB4YWI5NDIzYTcpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDIxLCAweGZjOTNhMDM5KTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA2LCAweDY1NWI1OWMzKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxMCwgMHg4ZjBjY2M5Mik7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTUsIDB4ZmZlZmY0N2QpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMjEsIDB4ODU4NDVkZDEpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDYsIDB4NmZhODdlNGYpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDEwLCAweGZlMmNlNmUwKTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAxNSwgMHhhMzAxNDMxNCk7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgMjEsIDB4NGUwODExYTEpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDYsIDB4Zjc1MzdlODIpOwogICAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDEwLCAweGJkM2FmMjM1KTsKICAgICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDE1LCAweDJhZDdkMmJiKTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAyMSwgMHhlYjg2ZDM5MSk7CiAgICAgIHN0YXRlWzBdID0gKGEgKyBzdGF0ZVswXSkgJiAweEZGRkZGRkZGOwogICAgICBzdGF0ZVsxXSA9IChiICsgc3RhdGVbMV0pICYgMHhGRkZGRkZGRjsKICAgICAgc3RhdGVbMl0gPSAoYyArIHN0YXRlWzJdKSAmIDB4RkZGRkZGRkY7CiAgICAgIHN0YXRlWzNdID0gKGQgKyBzdGF0ZVszXSkgJiAweEZGRkZGRkZGOwogIH07CiAgCiAgZnVuY3Rpb24gY21uKHEsIGEsIGIsIHgsIHMsIHQpIHsKICAgICAgYSA9ICgoKGEgKyBxKSAmIDB4RkZGRkZGRkYpICsgKCh4ICsgdCkgJiAweEZGRkZGRkZGKSkgJiAweEZGRkZGRkZGOwogICAgICByZXR1cm4gKCgoYSA8PCBzKSB8IChhID4+PiAoMzIgLSBzKSkpICsgYikgJiAweEZGRkZGRkZGOwogIH0KICAKICBmdW5jdGlvbiBmZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oKGIgJiBjKSB8ICgofmIpICYgZCksIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICBmdW5jdGlvbiBnZyhhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oKGIgJiBkKSB8IChjICYgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwogIH0KICAKICBmdW5jdGlvbiBoaChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICAgIHJldHVybiBjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gaWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKGMgXiAoYiB8ICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjgxfV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICB2YXIgQkxPQ0tfU0laRSA9IDY0OwogIAogIHZhciBESUdFU1RfTEVOR1RIID0gMjA7CiAgCiAgdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAgIDB4NWE4Mjc5OTksCiAgICAgIDB4NmVkOWViYTEsCiAgICAgIDB4OGYxYmJjZGMgfCAwLAogICAgICAweGNhNjJjMWQ2IHwgMAogIF0pOwogIAogIHZhciBJTklUID0gWwogICAgICAweDZhMDllNjY3LAogICAgICAweGJiNjdhZTg1LAogICAgICAweDNjNmVmMzcyLAogICAgICAweGE1NGZmNTNhLAogICAgICAweDUxMGU1MjdmLAogICAgICAweDliMDU2ODhjLAogICAgICAweDFmODNkOWFiLAogICAgICAweDViZTBjZDE5LAogIF07CiAgCiAgdmFyIE1BWF9IQVNIQUJMRV9MRU5HVEggPSBNYXRoLnBvdygyLCA1MykgLSAxOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFNoYTEoKSB7CiAgICAgIHRoaXMuaDAgPSAweDY3NDUyMzAxOwogICAgICB0aGlzLmgxID0gMHhFRkNEQUI4OTsKICAgICAgdGhpcy5oMiA9IDB4OThCQURDRkU7CiAgICAgIHRoaXMuaDMgPSAweDEwMzI1NDc2OwogICAgICB0aGlzLmg0ID0gMHhDM0QyRTFGMDsKICAgICAgLy8gVGhlIGZpcnN0IDY0IGJ5dGVzICgxNiB3b3JkcykgaXMgdGhlIGRhdGEgY2h1bmsKICAgICAgdGhpcy5ibG9jayA9IG5ldyBVaW50MzJBcnJheSg4MCk7CiAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgdGhpcy5zaGlmdCA9IDI0OwogICAgICB0aGlzLnRvdGFsTGVuZ3RoID0gMDsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMTsKICAKICBTaGExLkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwogIAogIFNoYTEucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgICB9CiAgCiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwogIAogICAgICB2YXIgbGVuZ3RoID0gZGF0YS5sZW5ndGg7CiAgICAgIHRoaXMudG90YWxMZW5ndGggKz0gbGVuZ3RoICogODsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy53cml0ZShkYXRhW2ldKTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIFNoYTEucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gd3JpdGUoYnl0ZSkgewogICAgICB0aGlzLmJsb2NrW3RoaXMub2Zmc2V0XSB8PSAoYnl0ZSAmIDB4ZmYpIDw8IHRoaXMuc2hpZnQ7CiAgICAgIGlmICh0aGlzLnNoaWZ0KSB7CiAgICAgICAgICB0aGlzLnNoaWZ0IC09IDg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLm9mZnNldCsrOwogICAgICAgICAgdGhpcy5zaGlmdCA9IDI0OwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLm9mZnNldCA9PT0gMTYpIHRoaXMucHJvY2Vzc0Jsb2NrKCk7CiAgfTsKICAKICBTaGExLnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgLy8gUGFkCiAgICAgIHRoaXMud3JpdGUoMHg4MCk7CiAgICAgIGlmICh0aGlzLm9mZnNldCA+IDE0IHx8ICh0aGlzLm9mZnNldCA9PT0gMTQgJiYgdGhpcy5zaGlmdCA8IDI0KSkgewogICAgICAgIHRoaXMucHJvY2Vzc0Jsb2NrKCk7CiAgICAgIH0KICAgICAgdGhpcy5vZmZzZXQgPSAxNDsKICAgICAgdGhpcy5zaGlmdCA9IDI0OwogIAogICAgICAvLyA2NC1iaXQgbGVuZ3RoIGJpZy1lbmRpYW4KICAgICAgdGhpcy53cml0ZSgweDAwKTsgLy8gbnVtYmVycyB0aGlzIGJpZyBhcmVuJ3QgYWNjdXJhdGUgaW4gamF2YXNjcmlwdCBhbnl3YXkKICAgICAgdGhpcy53cml0ZSgweDAwKTsgLy8gLi5TbyBqdXN0IGhhcmQtY29kZSB0byB6ZXJvLgogICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmZmYgPyB0aGlzLnRvdGFsTGVuZ3RoIC8gMHgxMDAwMDAwMDAwMCA6IDB4MDApOwogICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPiAweGZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwIDogMHgwMCk7CiAgICAgIGZvciAodmFyIHMgPSAyNDsgcyA+PSAwOyBzIC09IDgpIHsKICAgICAgICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+PiBzKTsKICAgICAgfQogICAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICAgIHZhciBvdXRWaWV3ID0gbmV3IERhdGFWaWV3KG91dC5idWZmZXIpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigwLCB0aGlzLmgwLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDQsIHRoaXMuaDEsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoOCwgdGhpcy5oMiwgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigxMiwgdGhpcy5oMywgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMigxNiwgdGhpcy5oNCwgZmFsc2UpOwogIAogICAgICByZXR1cm4gZW5jb2RpbmcgPyBvdXQudG9TdHJpbmcoZW5jb2RpbmcpIDogb3V0OwogIH07CiAgCiAgU2hhMS5wcm90b3R5cGUucHJvY2Vzc0Jsb2NrID0gZnVuY3Rpb24gcHJvY2Vzc0Jsb2NrKCkgewogICAgICAvLyBFeHRlbmQgdGhlIHNpeHRlZW4gMzItYml0IHdvcmRzIGludG8gZWlnaHR5IDMyLWJpdCB3b3JkczoKICAgICAgZm9yICh2YXIgaSA9IDE2OyBpIDwgODA7IGkrKykgewogICAgICAgIHZhciB3ID0gdGhpcy5ibG9ja1tpIC0gM10gXiB0aGlzLmJsb2NrW2kgLSA4XSBeIHRoaXMuYmxvY2tbaSAtIDE0XSBeIHRoaXMuYmxvY2tbaSAtIDE2XTsKICAgICAgICB0aGlzLmJsb2NrW2ldID0gKHcgPDwgMSkgfCAodyA+Pj4gMzEpOwogICAgICB9CiAgCiAgICAgIC8vIEluaXRpYWxpemUgaGFzaCB2YWx1ZSBmb3IgdGhpcyBjaHVuazoKICAgICAgdmFyIGEgPSB0aGlzLmgwOwogICAgICB2YXIgYiA9IHRoaXMuaDE7CiAgICAgIHZhciBjID0gdGhpcy5oMjsKICAgICAgdmFyIGQgPSB0aGlzLmgzOwogICAgICB2YXIgZSA9IHRoaXMuaDQ7CiAgICAgIHZhciBmLCBrOwogIAogICAgICAvLyBNYWluIGxvb3A6CiAgICAgIGZvciAoaSA9IDA7IGkgPCA4MDsgaSsrKSB7CiAgICAgICAgaWYgKGkgPCAyMCkgewogICAgICAgICAgZiA9IGQgXiAoYiAmIChjIF4gZCkpOwogICAgICAgICAgayA9IDB4NUE4Mjc5OTk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGkgPCA0MCkgewogICAgICAgICAgZiA9IGIgXiBjIF4gZDsKICAgICAgICAgIGsgPSAweDZFRDlFQkExOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpIDwgNjApIHsKICAgICAgICAgIGYgPSAoYiAmIGMpIHwgKGQgJiAoYiB8IGMpKTsKICAgICAgICAgIGsgPSAweDhGMUJCQ0RDOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgICBrID0gMHhDQTYyQzFENjsKICAgICAgICB9CiAgICAgICAgdmFyIHRlbXAgPSAoYSA8PCA1IHwgYSA+Pj4gMjcpICsgZiArIGUgKyBrICsgKHRoaXMuYmxvY2tbaV18MCk7CiAgICAgICAgZSA9IGQ7CiAgICAgICAgZCA9IGM7CiAgICAgICAgYyA9IChiIDw8IDMwIHwgYiA+Pj4gMik7CiAgICAgICAgYiA9IGE7CiAgICAgICAgYSA9IHRlbXA7CiAgICAgIH0KICAKICAgICAgLy8gQWRkIHRoaXMgY2h1bmsncyBoYXNoIHRvIHJlc3VsdCBzbyBmYXI6CiAgICAgIHRoaXMuaDAgPSAodGhpcy5oMCArIGEpIHwgMDsKICAgICAgdGhpcy5oMSA9ICh0aGlzLmgxICsgYikgfCAwOwogICAgICB0aGlzLmgyID0gKHRoaXMuaDIgKyBjKSB8IDA7CiAgICAgIHRoaXMuaDMgPSAodGhpcy5oMyArIGQpIHwgMDsKICAgICAgdGhpcy5oNCA9ICh0aGlzLmg0ICsgZSkgfCAwOwogIAogICAgICAvLyBUaGUgYmxvY2sgaXMgbm93IHJldXNhYmxlLgogICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSsrKSB7CiAgICAgICAgICB0aGlzLmJsb2NrW2ldID0gMDsKICAgICAgfQogIH07CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTEsImJ1ZmZlci8iOjgxfV0sMTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICB2YXIgQkxPQ0tfU0laRSA9IDY0OwogIAogIHZhciBESUdFU1RfTEVOR1RIID0gMzI7CiAgCiAgdmFyIEtFWSA9IG5ldyBVaW50MzJBcnJheShbCiAgICAgIDB4NDI4YTJmOTgsCiAgICAgIDB4NzEzNzQ0OTEsCiAgICAgIDB4YjVjMGZiY2YsCiAgICAgIDB4ZTliNWRiYTUsCiAgICAgIDB4Mzk1NmMyNWIsCiAgICAgIDB4NTlmMTExZjEsCiAgICAgIDB4OTIzZjgyYTQsCiAgICAgIDB4YWIxYzVlZDUsCiAgICAgIDB4ZDgwN2FhOTgsCiAgICAgIDB4MTI4MzViMDEsCiAgICAgIDB4MjQzMTg1YmUsCiAgICAgIDB4NTUwYzdkYzMsCiAgICAgIDB4NzJiZTVkNzQsCiAgICAgIDB4ODBkZWIxZmUsCiAgICAgIDB4OWJkYzA2YTcsCiAgICAgIDB4YzE5YmYxNzQsCiAgICAgIDB4ZTQ5YjY5YzEsCiAgICAgIDB4ZWZiZTQ3ODYsCiAgICAgIDB4MGZjMTlkYzYsCiAgICAgIDB4MjQwY2ExY2MsCiAgICAgIDB4MmRlOTJjNmYsCiAgICAgIDB4NGE3NDg0YWEsCiAgICAgIDB4NWNiMGE5ZGMsCiAgICAgIDB4NzZmOTg4ZGEsCiAgICAgIDB4OTgzZTUxNTIsCiAgICAgIDB4YTgzMWM2NmQsCiAgICAgIDB4YjAwMzI3YzgsCiAgICAgIDB4YmY1OTdmYzcsCiAgICAgIDB4YzZlMDBiZjMsCiAgICAgIDB4ZDVhNzkxNDcsCiAgICAgIDB4MDZjYTYzNTEsCiAgICAgIDB4MTQyOTI5NjcsCiAgICAgIDB4MjdiNzBhODUsCiAgICAgIDB4MmUxYjIxMzgsCiAgICAgIDB4NGQyYzZkZmMsCiAgICAgIDB4NTMzODBkMTMsCiAgICAgIDB4NjUwYTczNTQsCiAgICAgIDB4NzY2YTBhYmIsCiAgICAgIDB4ODFjMmM5MmUsCiAgICAgIDB4OTI3MjJjODUsCiAgICAgIDB4YTJiZmU4YTEsCiAgICAgIDB4YTgxYTY2NGIsCiAgICAgIDB4YzI0YjhiNzAsCiAgICAgIDB4Yzc2YzUxYTMsCiAgICAgIDB4ZDE5MmU4MTksCiAgICAgIDB4ZDY5OTA2MjQsCiAgICAgIDB4ZjQwZTM1ODUsCiAgICAgIDB4MTA2YWEwNzAsCiAgICAgIDB4MTlhNGMxMTYsCiAgICAgIDB4MWUzNzZjMDgsCiAgICAgIDB4Mjc0ODc3NGMsCiAgICAgIDB4MzRiMGJjYjUsCiAgICAgIDB4MzkxYzBjYjMsCiAgICAgIDB4NGVkOGFhNGEsCiAgICAgIDB4NWI5Y2NhNGYsCiAgICAgIDB4NjgyZTZmZjMsCiAgICAgIDB4NzQ4ZjgyZWUsCiAgICAgIDB4NzhhNTYzNmYsCiAgICAgIDB4ODRjODc4MTQsCiAgICAgIDB4OGNjNzAyMDgsCiAgICAgIDB4OTBiZWZmZmEsCiAgICAgIDB4YTQ1MDZjZWIsCiAgICAgIDB4YmVmOWEzZjcsCiAgICAgIDB4YzY3MTc4ZjIKICBdKTsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2YTA5ZTY2NywKICAgICAgMHhiYjY3YWU4NSwKICAgICAgMHgzYzZlZjM3MiwKICAgICAgMHhhNTRmZjUzYSwKICAgICAgMHg1MTBlNTI3ZiwKICAgICAgMHg5YjA1Njg4YywKICAgICAgMHgxZjgzZDlhYiwKICAgICAgMHg1YmUwY2QxOSwKICBdOwogIAogIHZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKICAKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFNoYTI1NigpIHsKICAgICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAgIDB4NmEwOWU2NjcsCiAgICAgICAgICAweGJiNjdhZTg1LAogICAgICAgICAgMHgzYzZlZjM3MiwKICAgICAgICAgIDB4YTU0ZmY1M2EsCiAgICAgICAgICAweDUxMGU1MjdmLAogICAgICAgICAgMHg5YjA1Njg4YywKICAgICAgICAgIDB4MWY4M2Q5YWIsCiAgICAgICAgICAweDViZTBjZDE5LAogICAgICBdOwogICAgICB0aGlzLnRlbXAgPSBuZXcgSW50MzJBcnJheSg2NCk7CiAgICAgIHRoaXMuYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoNjQpOwogICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgPSAwOwogICAgICAvKioKICAgICAgICogQHByaXZhdGUKICAgICAgICovCiAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMjU2OwogIAogIFNoYTI1Ni5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBTaGEyNTYucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgICB9CiAgCiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgCiAgICAgIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKGRhdGEpOwogIAogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgICBpZiAodGhpcy5ieXRlc0hhc2hlZCAqIDggPiBNQVhfSEFTSEFCTEVfTEVOR1RIKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNoIG1vcmUgdGhhbiAyXjUzIC0gMSBiaXRzJyk7CiAgICAgIH0KICAKICAgICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwKSB7CiAgICAgICAgICB0aGlzLmJ1ZmZlclt0aGlzLmJ1ZmZlckxlbmd0aCsrXSA9IGRhdGFbcG9zaXRpb24rK107CiAgICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgICBpZiAodGhpcy5idWZmZXJMZW5ndGggPT09IEJMT0NLX1NJWkUpIHsKICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBTaGEyNTYucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHZhciBiaXRzSGFzaGVkID0gdGhpcy5ieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgICB2YXIgYnVmZmVyVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlci5idWZmZXIsIHRoaXMuYnVmZmVyLmJ5dGVPZmZzZXQsIHRoaXMuYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgICAgdmFyIHVuZGVjb3JhdGVkTGVuZ3RoID0gdGhpcy5idWZmZXJMZW5ndGg7CiAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIDB4ODApOwogICAgICAgICAgLy8gRW5zdXJlIHRoZSBmaW5hbCBibG9jayBoYXMgZW5vdWdoIHJvb20gZm9yIHRoZSBoYXNoZWQgbGVuZ3RoCiAgICAgICAgICBpZiAodW5kZWNvcmF0ZWRMZW5ndGggJSBCTE9DS19TSVpFID49IEJMT0NLX1NJWkUgLSA4KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgICAgfQogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQzMihCTE9DS19TSVpFIC0gNCwgYml0c0hhc2hlZCk7CiAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgICB9CiAgICAgIC8vIFRoZSB2YWx1ZSBpbiBzdGF0ZSBpcyBsaXR0bGUtZW5kaWFuIHJhdGhlciB0aGFuIGJpZy1lbmRpYW4sIHNvIGZsaXAKICAgICAgLy8gZWFjaCB3b3JkIGludG8gYSBuZXcgVWludDhBcnJheQogICAgICB2YXIgb3V0ID0gbmV3IEJ1ZmZlcihESUdFU1RfTEVOR1RIKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyBpKyspIHsKICAgICAgICAgIG91dFtpICogNF0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMjQpICYgMHhmZjsKICAgICAgICAgIG91dFtpICogNCArIDFdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDE2KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAyXSA9ICh0aGlzLnN0YXRlW2ldID4+PiA4KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAzXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAwKSAmIDB4ZmY7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKICB9OwogIAogIFNoYTI1Ni5wcm90b3R5cGUuaGFzaEJ1ZmZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIF9hID0gdGhpcywKICAgICAgICAgIGJ1ZmZlciA9IF9hLmJ1ZmZlciwKICAgICAgICAgIHN0YXRlID0gX2Euc3RhdGU7CiAgICAgIHZhciBzdGF0ZTAgPSBzdGF0ZVswXSwKICAgICAgICAgIHN0YXRlMSA9IHN0YXRlWzFdLAogICAgICAgICAgc3RhdGUyID0gc3RhdGVbMl0sCiAgICAgICAgICBzdGF0ZTMgPSBzdGF0ZVszXSwKICAgICAgICAgIHN0YXRlNCA9IHN0YXRlWzRdLAogICAgICAgICAgc3RhdGU1ID0gc3RhdGVbNV0sCiAgICAgICAgICBzdGF0ZTYgPSBzdGF0ZVs2XSwKICAgICAgICAgIHN0YXRlNyA9IHN0YXRlWzddOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgaWYgKGkgPCAxNikgewogICAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICgoKGJ1ZmZlcltpICogNF0gJiAweGZmKSA8PCAyNCkgfAogICAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMV0gJiAweGZmKSA8PCAxNikgfAogICAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMl0gJiAweGZmKSA8PCA4KSB8CiAgICAgICAgICAgICAgICAgIChidWZmZXJbKGkgKiA0KSArIDNdICYgMHhmZikpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHUgPSB0aGlzLnRlbXBbaSAtIDJdOwogICAgICAgICAgICAgIHZhciB0MV8xID0gKHUgPj4+IDE3IHwgdSA8PCAxNSkgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTkgfCB1IDw8IDEzKSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAxMCk7CiAgICAgICAgICAgICAgdSA9IHRoaXMudGVtcFtpIC0gMTVdOwogICAgICAgICAgICAgIHZhciB0Ml8xID0gKHUgPj4+IDcgfCB1IDw8IDI1KSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAxOCB8IHUgPDwgMTQpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDMpOwogICAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICh0MV8xICsgdGhpcy50ZW1wW2kgLSA3XSB8IDApICsKICAgICAgICAgICAgICAgICAgKHQyXzEgKyB0aGlzLnRlbXBbaSAtIDE2XSB8IDApOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHQxID0gKCgoKChzdGF0ZTQgPj4+IDYgfCBzdGF0ZTQgPDwgMjYpIF4KICAgICAgICAgICAgICAoc3RhdGU0ID4+PiAxMSB8IHN0YXRlNCA8PCAyMSkgXgogICAgICAgICAgICAgIChzdGF0ZTQgPj4+IDI1IHwgc3RhdGU0IDw8IDcpKQogICAgICAgICAgICAgICsgKChzdGF0ZTQgJiBzdGF0ZTUpIF4gKH5zdGF0ZTQgJiBzdGF0ZTYpKSkgfCAwKQogICAgICAgICAgICAgICsgKChzdGF0ZTcgKyAoKEtFWVtpXSArIHRoaXMudGVtcFtpXSkgfCAwKSkgfCAwKSkgfCAwOwogICAgICAgICAgdmFyIHQyID0gKCgoc3RhdGUwID4+PiAyIHwgc3RhdGUwIDw8IDMwKSBeCiAgICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMTMgfCBzdGF0ZTAgPDwgMTkpIF4KICAgICAgICAgICAgICAoc3RhdGUwID4+PiAyMiB8IHN0YXRlMCA8PCAxMCkpICsgKChzdGF0ZTAgJiBzdGF0ZTEpIF4gKHN0YXRlMCAmIHN0YXRlMikgXiAoc3RhdGUxICYgc3RhdGUyKSkpIHwgMDsKICAgICAgICAgIHN0YXRlNyA9IHN0YXRlNjsKICAgICAgICAgIHN0YXRlNiA9IHN0YXRlNTsKICAgICAgICAgIHN0YXRlNSA9IHN0YXRlNDsKICAgICAgICAgIHN0YXRlNCA9IChzdGF0ZTMgKyB0MSkgfCAwOwogICAgICAgICAgc3RhdGUzID0gc3RhdGUyOwogICAgICAgICAgc3RhdGUyID0gc3RhdGUxOwogICAgICAgICAgc3RhdGUxID0gc3RhdGUwOwogICAgICAgICAgc3RhdGUwID0gKHQxICsgdDIpIHwgMDsKICAgICAgfQogICAgICBzdGF0ZVswXSArPSBzdGF0ZTA7CiAgICAgIHN0YXRlWzFdICs9IHN0YXRlMTsKICAgICAgc3RhdGVbMl0gKz0gc3RhdGUyOwogICAgICBzdGF0ZVszXSArPSBzdGF0ZTM7CiAgICAgIHN0YXRlWzRdICs9IHN0YXRlNDsKICAgICAgc3RhdGVbNV0gKz0gc3RhdGU1OwogICAgICBzdGF0ZVs2XSArPSBzdGF0ZTY7CiAgICAgIHN0YXRlWzddICs9IHN0YXRlNzsKICB9OwogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MX1dLDE2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIAogIC8vIGJyb3dzZXIgc3BlY2lmaWMgbW9kdWxlcwogIHV0aWwuY3J5cHRvLmxpYiA9IHJlcXVpcmUoJy4vYnJvd3NlckNyeXB0b0xpYicpOwogIHV0aWwuQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB1dGlsLnVybCA9IHJlcXVpcmUoJ3VybC8nKTsKICB1dGlsLnF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcvJyk7CiAgdXRpbC5yZWFsQ2xvY2sgPSByZXF1aXJlKCcuL3JlYWxjbG9jay9icm93c2VyQ2xvY2snKTsKICB1dGlsLmVudmlyb25tZW50ID0gJ2pzJzsKICB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtID0gcmVxdWlyZSgnLi9ldmVudC1zdHJlYW0vYnVmZmVyZWQtY3JlYXRlLWV2ZW50LXN0cmVhbScpLmNyZWF0ZUV2ZW50U3RyZWFtOwogIHV0aWwuaXNCcm93c2VyID0gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9OwogIHV0aWwuaXNOb2RlID0gZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfTsKICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgCiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3NhbWxfY3JlZGVudGlhbHMnKTsKICAKICAvLyBMb2FkIHRoZSBET01QYXJzZXIgWE1MIHBhcnNlcgogIEFXUy5YTUwuUGFyc2VyID0gcmVxdWlyZSgnLi94bWwvYnJvd3Nlcl9wYXJzZXInKTsKICAKICAvLyBMb2FkIHRoZSBYSFIgSHR0cENsaWVudAogIHJlcXVpcmUoJy4vaHR0cC94aHInKTsKICAKICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgcHJvY2VzcyA9IHsKICAgICAgYnJvd3NlcjogdHJ1ZQogICAgfTsKICB9CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2Jyb3dzZXJDcnlwdG9MaWIiOjEwLCIuL2NvcmUiOjE4LCIuL2NyZWRlbnRpYWxzIjoxOSwiLi9jcmVkZW50aWFscy9jaGFpbmFibGVfdGVtcG9yYXJ5X2NyZWRlbnRpYWxzIjoyMCwiLi9jcmVkZW50aWFscy9jb2duaXRvX2lkZW50aXR5X2NyZWRlbnRpYWxzIjoyMSwiLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluIjoyMiwiLi9jcmVkZW50aWFscy9zYW1sX2NyZWRlbnRpYWxzIjoyMywiLi9jcmVkZW50aWFscy90ZW1wb3JhcnlfY3JlZGVudGlhbHMiOjI0LCIuL2NyZWRlbnRpYWxzL3dlYl9pZGVudGl0eV9jcmVkZW50aWFscyI6MjUsIi4vZXZlbnQtc3RyZWFtL2J1ZmZlcmVkLWNyZWF0ZS1ldmVudC1zdHJlYW0iOjI3LCIuL2h0dHAveGhyIjozNSwiLi9yZWFsY2xvY2svYnJvd3NlckNsb2NrIjo1MiwiLi91dGlsIjo3MSwiLi94bWwvYnJvd3Nlcl9wYXJzZXIiOjcyLCJfcHJvY2VzcyI6ODYsImJ1ZmZlci8iOjgxLCJxdWVyeXN0cmluZy8iOjkyLCJ1cmwvIjo5NH1dLDE3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbicpOwogIHZhciBQcm9taXNlc0RlcGVuZGVuY3k7CiAgCiAgLyoqCiAgICogVGhlIG1haW4gY29uZmlndXJhdGlvbiBjbGFzcyB1c2VkIGJ5IGFsbCBzZXJ2aWNlIG9iamVjdHMgdG8gc2V0CiAgICogdGhlIHJlZ2lvbiwgY3JlZGVudGlhbHMsIGFuZCBvdGhlciBvcHRpb25zIGZvciByZXF1ZXN0cy4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGNyZWRlbnRpYWxzIGFuZCByZWdpb24gc2V0dGluZ3MgYXJlIGxlZnQgdW5jb25maWd1cmVkLgogICAqIFRoaXMgc2hvdWxkIGJlIGNvbmZpZ3VyZWQgYnkgdGhlIGFwcGxpY2F0aW9uIGJlZm9yZSB1c2luZyBhbnkKICAgKiBBV1Mgc2VydmljZSBBUElzLgogICAqCiAgICogSW4gb3JkZXIgdG8gc2V0IGdsb2JhbCBjb25maWd1cmF0aW9uIG9wdGlvbnMsIHByb3BlcnRpZXMgc2hvdWxkCiAgICogYmUgYXNzaWduZWQgdG8gdGhlIGdsb2JhbCB7QVdTLmNvbmZpZ30gb2JqZWN0LgogICAqCiAgICogQHNlZSBBV1MuY29uZmlnCiAgICoKICAgKiBAIWdyb3VwIEdlbmVyYWwgQ29uZmlndXJhdGlvbiBPcHRpb25zCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjcmVkZW50aWFscwogICAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgQVdTIGNyZWRlbnRpYWxzIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlZ2lvbgogICAqICAgQGV4YW1wbGUgU2V0IHRoZSBnbG9iYWwgcmVnaW9uIHNldHRpbmcgdG8gdXMtd2VzdC0yCiAgICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZWdpb246ICd1cy13ZXN0LTInfSk7CiAgICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIFRoZSByZWdpb24gdG8gc2VuZCBzZXJ2aWNlIHJlcXVlc3RzIHRvLgogICAqICAgQHNlZSBodHRwOi8vZG9jcy5hbWF6b253ZWJzZXJ2aWNlcy5jb20vZ2VuZXJhbC9sYXRlc3QvZ3IvcmFuZGUuaHRtbAogICAqICAgICBBIGxpc3Qgb2YgYXZhaWxhYmxlIGVuZHBvaW50cyBmb3IgZWFjaCBBV1Mgc2VydmljZQogICAqCiAgICogQCFhdHRyaWJ1dGUgbWF4UmV0cmllcwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJldHJpZXMgdG8gcGVyZm9ybSBmb3IgYQogICAqICAgICBzZXJ2aWNlIHJlcXVlc3QuIEJ5IGRlZmF1bHQgdGhpcyB2YWx1ZSBpcyBjYWxjdWxhdGVkIGJ5IHRoZSBzcGVjaWZpYwogICAqICAgICBzZXJ2aWNlIG9iamVjdCB0aGF0IHRoZSByZXF1ZXN0IGlzIGJlaW5nIG1hZGUgdG8uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtYXhSZWRpcmVjdHMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZWRpcmVjdHMgdG8gZm9sbG93IGZvciBhCiAgICogICAgIHNlcnZpY2UgcmVxdWVzdC4gRGVmYXVsdHMgdG8gMTAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbVZhbGlkYXRpb24KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMgc2hvdWxkIGJlIHZhbGlkYXRlZCBhZ2FpbnN0CiAgICogICAgIHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcgdGhlIHJlcXVlc3QuIERlZmF1bHRzIHRvIHRydWUuCiAgICogICAgIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAgICoKICAgKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAqICAgICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogICAqICAgICAgIHRvIGB0cnVlYC4KICAgKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAqICAgICAgIGNvbnN0cmFpbnQuCiAgICogICAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAqICAgICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAgICogICAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgKgogICAqIEAhYXR0cmlidXRlIGNvbXB1dGVDaGVja3N1bXMKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29tcHV0ZSBjaGVja3N1bXMgZm9yIHBheWxvYWQgYm9kaWVzIHdoZW4KICAgKiAgICAgdGhlIHNlcnZpY2UgYWNjZXB0cyBpdCAoY3VycmVudGx5IHN1cHBvcnRlZCBpbiBTMyBvbmx5KS4KICAgKgogICAqIEAhYXR0cmlidXRlIGNvbnZlcnRSZXNwb25zZVR5cGVzCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHR5cGVzIGFyZSBjb252ZXJ0ZWQgd2hlbiBwYXJzaW5nIHJlc3BvbnNlIGRhdGEuCiAgICogICAgIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBmb3IgSlNPTiBiYXNlZCBzZXJ2aWNlcy4gVHVybmluZyB0aGlzIG9mZiBtYXkKICAgKiAgICAgaW1wcm92ZSBwZXJmb3JtYW5jZSBvbiBsYXJnZSByZXNwb25zZSBwYXlsb2Fkcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgY29ycmVjdENsb2NrU2tldwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBhcHBseSBhIGNsb2NrIHNrZXcgY29ycmVjdGlvbiBhbmQgcmV0cnkKICAgKiAgICAgcmVxdWVzdHMgdGhhdCBmYWlsIGJlY2F1c2Ugb2YgYW4gc2tld2VkIGNsaWVudCBjbG9jay4gRGVmYXVsdHMgdG8KICAgKiAgICAgYGZhbHNlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHNzbEVuYWJsZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgU1NMIGlzIGVuYWJsZWQgZm9yIHJlcXVlc3RzCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzM0ZvcmNlUGF0aFN0eWxlCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGZvcmNlIHBhdGggc3R5bGUgVVJMcyBmb3IgUzMgb2JqZWN0cwogICAqCiAgICogQCFhdHRyaWJ1dGUgczNCdWNrZXRFbmRwb2ludAogICAqICAgQG5vdGUgU2V0dGluZyB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIHJlcXVpcmVzIGFuIGBlbmRwb2ludGAgdG8gYmUKICAgKiAgICAgcHJvdmlkZWQgZXhwbGljaXRseSB0byB0aGUgc2VydmljZSBjb25zdHJ1Y3Rvci4KICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGVuZHBvaW50IGFkZHJlc3NlcyBhbiBpbmRpdmlkdWFsCiAgICogICAgIGJ1Y2tldCAoZmFsc2UgaWYgaXQgYWRkcmVzc2VzIHRoZSByb290IEFQSSBlbmRwb2ludCkuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzM0Rpc2FibGVCb2R5U2lnbmluZwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBkaXNhYmxlIFMzIGJvZHkgc2lnbmluZyB3aGVuIHVzaW5nIHNpZ25hdHVyZSB2ZXJzaW9uIGB2NGAuCiAgICogICAgIEJvZHkgc2lnbmluZyBjYW4gb25seSBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIGh0dHBzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSB1c2VBY2NlbGVyYXRlRW5kcG9pbnQKICAgKiAgIEBub3RlIFRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gaXMgb25seSBjb21wYXRpYmxlIHdpdGggUzMgd2hpbGUgYWNjZXNzaW5nCiAgICogICAgIGRucy1jb21wYXRpYmxlIGJ1Y2tldHMuCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSBXaGV0aGVyIHRvIHVzZSB0aGUgQWNjZWxlcmF0ZSBlbmRwb2ludCB3aXRoIHRoZSBTMyBzZXJ2aWNlLgogICAqICAgICBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmV0cnlEZWxheU9wdGlvbnMKICAgKiAgIEBleGFtcGxlIFNldCB0aGUgYmFzZSByZXRyeSBkZWxheSBmb3IgYWxsIHNlcnZpY2VzIHRvIDMwMCBtcwogICAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmV0cnlEZWxheU9wdGlvbnM6IHtiYXNlOiAzMDB9fSk7CiAgICogICAgIC8vIERlbGF5cyB3aXRoIG1heFJldHJpZXMgPSAzOiAzMDAsIDYwMCwgMTIwMAogICAqICAgQGV4YW1wbGUgU2V0IGEgY3VzdG9tIGJhY2tvZmYgZnVuY3Rpb24gdG8gcHJvdmlkZSBkZWxheSB2YWx1ZXMgb24gcmV0cmllcwogICAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmV0cnlEZWxheU9wdGlvbnM6IHtjdXN0b21CYWNrb2ZmOiBmdW5jdGlvbihyZXRyeUNvdW50KSB7CiAgICogICAgICAgLy8gcmV0dXJucyBkZWxheSBpbiBtcwogICAqICAgICB9fX0pOwogICAqICAgQHJldHVybiBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIGNvbmZpZ3VyZSB0aGUgcmV0cnkgZGVsYXkgb24gcmV0cnlhYmxlIGVycm9ycy4KICAgKiAgICAgQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgKgogICAqICAgICAqICoqYmFzZSoqIFtJbnRlZ2VyXSAmbWRhc2g7IFRoZSBiYXNlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdXNlIGluIHRoZQogICAqICAgICAgIGV4cG9uZW50aWFsIGJhY2tvZmYgZm9yIG9wZXJhdGlvbiByZXRyaWVzLiBEZWZhdWx0cyB0byAxMDAgbXMgZm9yIGFsbCBzZXJ2aWNlcyBleGNlcHQKICAgKiAgICAgICBEeW5hbW9EQiwgd2hlcmUgaXQgZGVmYXVsdHMgdG8gNTBtcy4KICAgKiAgICAgKiAqKmN1c3RvbUJhY2tvZmYgKiogW2Z1bmN0aW9uXSAmbWRhc2g7IEEgY3VzdG9tIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBhIHJldHJ5IGNvdW50CiAgICogICAgICAgYW5kIHJldHVybnMgdGhlIGFtb3VudCBvZiB0aW1lIHRvIGRlbGF5IGluIG1pbGxpc2Vjb25kcy4gVGhlIGBiYXNlYCBvcHRpb24gd2lsbCBiZQogICAqICAgICAgIGlnbm9yZWQgaWYgdGhpcyBvcHRpb24gaXMgc3VwcGxpZWQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBodHRwT3B0aW9ucwogICAqICAgQHJldHVybiBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIHBhc3MgdG8gdGhlIGxvdy1sZXZlbCBIVFRQIHJlcXVlc3QuCiAgICogICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICoKICAgKiAgICAgKiAqKnByb3h5KiogW1N0cmluZ10gJm1kYXNoOyB0aGUgVVJMIHRvIHByb3h5IHJlcXVlc3RzIHRocm91Z2gKICAgKiAgICAgKiAqKmFnZW50KiogW2h0dHAuQWdlbnQsIGh0dHBzLkFnZW50XSAmbWRhc2g7IHRoZSBBZ2VudCBvYmplY3QgdG8gcGVyZm9ybQogICAqICAgICAgIEhUVFAgcmVxdWVzdHMgd2l0aC4gVXNlZCBmb3IgY29ubmVjdGlvbiBwb29saW5nLiBOb3RlIHRoYXQgZm9yCiAgICogICAgICAgU1NMIGNvbm5lY3Rpb25zLCBhIHNwZWNpYWwgQWdlbnQgb2JqZWN0IGlzIHVzZWQgaW4gb3JkZXIgdG8gZW5hYmxlCiAgICogICAgICAgcGVlciBjZXJ0aWZpY2F0ZSB2ZXJpZmljYXRpb24uIFRoaXMgZmVhdHVyZSBpcyBvbmx5IHN1cHBvcnRlZCBpbiB0aGUKICAgKiAgICAgICBOb2RlLmpzIGVudmlyb25tZW50LgogICAqICAgICAqICoqY29ubmVjdFRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlcgogICAqICAgICAgIGZhaWxpbmcgdG8gZXN0YWJsaXNoIGEgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIgYWZ0ZXIKICAgKiAgICAgICBgY29ubmVjdFRpbWVvdXRgIG1pbGxpc2Vjb25kcy4gVGhpcyB0aW1lb3V0IGhhcyBubyBlZmZlY3Qgb25jZSBhIHNvY2tldAogICAqICAgICAgIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQuCiAgICogICAgICogKip0aW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIgdGltZW91dAogICAqICAgICAgIG1pbGxpc2Vjb25kcyBvZiBpbmFjdGl2aXR5IG9uIHRoZSBzb2NrZXQuIERlZmF1bHRzIHRvIHR3byBtaW51dGVzCiAgICogICAgICAgKDEyMDAwMCkKICAgKiAgICAgKiAqKnhockFzeW5jKiogW0Jvb2xlYW5dICZtZGFzaDsgV2hldGhlciB0aGUgU0RLIHdpbGwgc2VuZCBhc3luY2hyb25vdXMKICAgKiAgICAgICBIVFRQIHJlcXVlc3RzLiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9ubHkuIFNldCB0byBmYWxzZSB0bwogICAqICAgICAgIHNlbmQgcmVxdWVzdHMgc3luY2hyb25vdXNseS4gRGVmYXVsdHMgdG8gdHJ1ZSAoYXN5bmMgb24pLgogICAqICAgICAqICoqeGhyV2l0aENyZWRlbnRpYWxzKiogW0Jvb2xlYW5dICZtZGFzaDsgU2V0cyB0aGUgIndpdGhDcmVkZW50aWFscyIKICAgKiAgICAgICBwcm9wZXJ0eSBvZiBhbiBYTUxIdHRwUmVxdWVzdCBvYmplY3QuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQKICAgKiAgICAgICBvbmx5LiBEZWZhdWx0cyB0byBmYWxzZS4KICAgKiBAIWF0dHJpYnV0ZSBsb2dnZXIKICAgKiAgIEByZXR1cm4gWyN3cml0ZSwjbG9nXSBhbiBvYmplY3QgdGhhdCByZXNwb25kcyB0byAud3JpdGUoKSAobGlrZSBhIHN0cmVhbSkKICAgKiAgICAgb3IgLmxvZygpIChsaWtlIHRoZSBjb25zb2xlIG9iamVjdCkgaW4gb3JkZXIgdG8gbG9nIGluZm9ybWF0aW9uIGFib3V0CiAgICogICAgIHJlcXVlc3RzCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzeXN0ZW1DbG9ja09mZnNldAogICAqICAgQHJldHVybiBbTnVtYmVyXSBhbiBvZmZzZXQgdmFsdWUgaW4gbWlsbGlzZWNvbmRzIHRvIGFwcGx5IHRvIGFsbCBzaWduaW5nCiAgICogICAgIHRpbWVzLiBVc2UgdGhpcyB0byBjb21wZW5zYXRlIGZvciBjbG9jayBza2V3IHdoZW4geW91ciBzeXN0ZW0gbWF5IGJlCiAgICogICAgIG91dCBvZiBzeW5jIHdpdGggdGhlIHNlcnZpY2UgdGltZS4gTm90ZSB0aGF0IHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24KICAgKiAgICAgY2FuIG9ubHkgYmUgYXBwbGllZCB0byB0aGUgZ2xvYmFsIGBBV1MuY29uZmlnYCBvYmplY3QgYW5kIGNhbm5vdCBiZQogICAqICAgICBvdmVycmlkZGVuIGluIHNlcnZpY2Utc3BlY2lmaWMgY29uZmlndXJhdGlvbi4gRGVmYXVsdHMgdG8gMCBtaWxsaXNlY29uZHMuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzaWduYXR1cmVWZXJzaW9uCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBzaWduYXR1cmUgdmVyc2lvbiB0byBzaWduIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcKICAgKiAgICAgdGhlIEFQSSBjb25maWd1cmF0aW9uKS4gUG9zc2libGUgdmFsdWVzIGFyZTogJ3YyJywgJ3YzJywgJ3Y0Jy4KICAgKgogICAqIEAhYXR0cmlidXRlIHNpZ25hdHVyZUNhY2hlCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBzaWduYXR1cmUgdG8gc2lnbiByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nCiAgICogICAgIHRoZSBBUEkgY29uZmlndXJhdGlvbikgaXMgY2FjaGVkLiBPbmx5IGFwcGxpZXMgdG8gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uICd2NCcuCiAgICogICAgIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5IGZvciBvcGVyYXRpb25zIHRoYXQKICAgKiAgICAgYWxsb3cgb3B0aW9uYWxseSB1c2luZyBhbiBlbmRwb2ludCByZXR1cm5lZCBieSB0aGUgc2VydmljZS4KICAgKiAgICAgRGVmYXVsdHMgdG8gJ2ZhbHNlJwogICAqCiAgICogQCFhdHRyaWJ1dGUgZW5kcG9pbnRDYWNoZVNpemUKICAgKiAgIEByZXR1cm4gW051bWJlcl0gdGhlIHNpemUgb2YgdGhlIGdsb2JhbCBjYWNoZSBzdG9yaW5nIGVuZHBvaW50cyBmcm9tIGVuZHBvaW50CiAgICogICAgIGRpc2NvdmVyeSBvcGVyYXRpb25zLiBPbmNlIGVuZHBvaW50IGNhY2hlIGlzIGNyZWF0ZWQsIHVwZGF0aW5nIHRoaXMgc2V0dGluZwogICAqICAgICBjYW5ub3QgY2hhbmdlIGV4aXN0aW5nIGNhY2hlIHNpemUuCiAgICogICAgIERlZmF1bHRzIHRvIDEwMDAKICAgKgogICAqIEAhYXR0cmlidXRlIGhvc3RQcmVmaXhFbmFibGVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIG1hcnNoYWwgcmVxdWVzdCBwYXJhbWV0ZXJzIHRvIHRoZSBwcmVmaXggb2YKICAgKiAgICAgaG9zdG5hbWUuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHN0c1JlZ2lvbmFsRW5kcG9pbnRzCiAgICogICBAcmV0dXJuIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGV0aGVyIHRvIHNlbmQgc3RzIHJlcXVlc3QgdG8gZ2xvYmFsIGVuZHBvaW50cyBvcgogICAqICAgICByZWdpb25hbCBlbmRwb2ludHMuCiAgICogICAgIERlZmF1bHRzIHRvICdsZWdhY3knCiAgICovCiAgQVdTLkNvbmZpZyA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBAIWVuZGdyb3VwCiAgICAgKi8KICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjb25maWd1cmF0aW9uIG9iamVjdC4gVGhpcyBpcyB0aGUgb2JqZWN0IHRoYXQgcGFzc2VzCiAgICAgKiBvcHRpb24gZGF0YSBhbG9uZyB0byBzZXJ2aWNlIHJlcXVlc3RzLCBpbmNsdWRpbmcgY3JlZGVudGlhbHMsIHNlY3VyaXR5LAogICAgICogcmVnaW9uIGluZm9ybWF0aW9uLCBhbmQgc29tZSBzZXJ2aWNlIHNwZWNpZmljIHNldHRpbmdzLgogICAgICoKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggY3JlZGVudGlhbHMgYW5kIHJlZ2lvbgogICAgICogICB2YXIgY29uZmlnID0gbmV3IEFXUy5Db25maWcoewogICAgICogICAgIGFjY2Vzc0tleUlkOiAnQUtJRCcsIHNlY3JldEFjY2Vzc0tleTogJ1NFQ1JFVCcsIHJlZ2lvbjogJ3VzLXdlc3QtMicKICAgICAqICAgfSk7CiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgYWNjZXNzS2V5SWQgW1N0cmluZ10geW91ciBBV1MgYWNjZXNzIGtleSBJRC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10geW91ciBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2Vzc2lvblRva2VuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBvcHRpb25hbCBBV1MKICAgICAqICAgc2Vzc2lvbiB0b2tlbiB0byBzaWduIHJlcXVlc3RzIHdpdGguCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIEFXUyBjcmVkZW50aWFscwogICAgICogICB0byBzaWduIHJlcXVlc3RzIHdpdGguIFlvdSBjYW4gZWl0aGVyIHNwZWNpZnkgdGhpcyBvYmplY3QsIG9yCiAgICAgKiAgIHNwZWNpZnkgdGhlIGFjY2Vzc0tleUlkIGFuZCBzZWNyZXRBY2Nlc3NLZXkgb3B0aW9ucyBkaXJlY3RseS4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjcmVkZW50aWFsUHJvdmlkZXIgW0FXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl0gdGhlCiAgICAgKiAgIHByb3ZpZGVyIGNoYWluIHVzZWQgdG8gcmVzb2x2ZSBjcmVkZW50aWFscyBpZiBubyBzdGF0aWMgYGNyZWRlbnRpYWxzYAogICAgICogICBwcm9wZXJ0eSBpcyBzZXQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcmVnaW9uIFtTdHJpbmddIHRoZSByZWdpb24gdG8gc2VuZCBzZXJ2aWNlIHJlcXVlc3RzIHRvLgogICAgICogICBTZWUge3JlZ2lvbn0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbWF4UmV0cmllcyBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJldHJpZXMgdG8KICAgICAqICAgYXR0ZW1wdCB3aXRoIGEgcmVxdWVzdC4gU2VlIHttYXhSZXRyaWVzfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBtYXhSZWRpcmVjdHMgW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZWRpcmVjdHMgdG8KICAgICAqICAgZm9sbG93IHdpdGggYSByZXF1ZXN0LiBTZWUge21heFJlZGlyZWN0c30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc3NsRW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBlbmFibGUgU1NMIGZvcgogICAgICogICByZXF1ZXN0cy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBwYXJhbVZhbGlkYXRpb24gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMKICAgICAqICAgc2hvdWxkIGJlIHZhbGlkYXRlZCBhZ2FpbnN0IHRoZSBvcGVyYXRpb24gZGVzY3JpcHRpb24gYmVmb3JlIHNlbmRpbmcKICAgICAqICAgdGhlIHJlcXVlc3QuIERlZmF1bHRzIHRvIHRydWUuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUKICAgICAqICAgZm9sbG93aW5nIHNwZWNpZmljIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAgICAgKgogICAgICogICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICAgKiAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICAgKiAgICAgdG8gYHRydWVgLgogICAgICogICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICAgKiAgICAgY29uc3RyYWludC4KICAgICAqICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgICAqICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKiAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgICAqICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNvbXB1dGVDaGVja3N1bXMgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29tcHV0ZSBjaGVja3N1bXMKICAgICAqICAgZm9yIHBheWxvYWQgYm9kaWVzIHdoZW4gdGhlIHNlcnZpY2UgYWNjZXB0cyBpdCAoY3VycmVudGx5IHN1cHBvcnRlZAogICAgICogICBpbiBTMyBvbmx5KQogICAgICogQG9wdGlvbiBvcHRpb25zIGNvbnZlcnRSZXNwb25zZVR5cGVzIFtCb29sZWFuXSB3aGV0aGVyIHR5cGVzIGFyZSBjb252ZXJ0ZWQKICAgICAqICAgICB3aGVuIHBhcnNpbmcgcmVzcG9uc2UgZGF0YS4gQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGZvciBKU09OIGJhc2VkCiAgICAgKiAgICAgc2VydmljZXMuIFR1cm5pbmcgdGhpcyBvZmYgbWF5IGltcHJvdmUgcGVyZm9ybWFuY2Ugb24gbGFyZ2UgcmVzcG9uc2UKICAgICAqICAgICBwYXlsb2Fkcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNvcnJlY3RDbG9ja1NrZXcgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gYXBwbHkgYSBjbG9jayBza2V3CiAgICAgKiAgICAgY29ycmVjdGlvbiBhbmQgcmV0cnkgcmVxdWVzdHMgdGhhdCBmYWlsIGJlY2F1c2Ugb2YgYW4gc2tld2VkIGNsaWVudAogICAgICogICAgIGNsb2NrLiBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAgICogQG9wdGlvbiBvcHRpb25zIHMzRm9yY2VQYXRoU3R5bGUgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZm9yY2UgcGF0aAogICAgICogICBzdHlsZSBVUkxzIGZvciBTMyBvYmplY3RzLgogICAgICogQG9wdGlvbiBvcHRpb25zIHMzQnVja2V0RW5kcG9pbnQgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGVuZHBvaW50CiAgICAgKiAgIGFkZHJlc3NlcyBhbiBpbmRpdmlkdWFsIGJ1Y2tldCAoZmFsc2UgaWYgaXQgYWRkcmVzc2VzIHRoZSByb290IEFQSQogICAgICogICBlbmRwb2ludCkuIE5vdGUgdGhhdCBzZXR0aW5nIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gcmVxdWlyZXMgYW4KICAgICAqICAgYGVuZHBvaW50YCB0byBiZSBwcm92aWRlZCBleHBsaWNpdGx5IHRvIHRoZSBzZXJ2aWNlIGNvbnN0cnVjdG9yLgogICAgICogQG9wdGlvbiBvcHRpb25zIHMzRGlzYWJsZUJvZHlTaWduaW5nIFtCb29sZWFuXSB3aGV0aGVyIFMzIGJvZHkgc2lnbmluZwogICAgICogICBzaG91bGQgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBzaWduYXR1cmUgdmVyc2lvbiBgdjRgLiBCb2R5IHNpZ25pbmcKICAgICAqICAgY2FuIG9ubHkgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBodHRwcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICoKICAgICAqIEBvcHRpb24gb3B0aW9ucyByZXRyeURlbGF5T3B0aW9ucyBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIGNvbmZpZ3VyZQogICAgICogICB0aGUgcmV0cnkgZGVsYXkgb24gcmV0cnlhYmxlIGVycm9ycy4gQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgICAqCiAgICAgKiAgICogKipiYXNlKiogW0ludGVnZXJdICZtZGFzaDsgVGhlIGJhc2UgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB1c2UgaW4gdGhlCiAgICAgKiAgICAgZXhwb25lbnRpYWwgYmFja29mZiBmb3Igb3BlcmF0aW9uIHJldHJpZXMuIERlZmF1bHRzIHRvIDEwMCBtcyBmb3IgYWxsCiAgICAgKiAgICAgc2VydmljZXMgZXhjZXB0IER5bmFtb0RCLCB3aGVyZSBpdCBkZWZhdWx0cyB0byA1MG1zLgogICAgICogICAqICoqY3VzdG9tQmFja29mZiAqKiBbZnVuY3Rpb25dICZtZGFzaDsgQSBjdXN0b20gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIGEgcmV0cnkgY291bnQKICAgICAqICAgICBhbmQgcmV0dXJucyB0aGUgYW1vdW50IG9mIHRpbWUgdG8gZGVsYXkgaW4gbWlsbGlzZWNvbmRzLiBUaGUgYGJhc2VgIG9wdGlvbiB3aWxsIGJlCiAgICAgKiAgICAgaWdub3JlZCBpZiB0aGlzIG9wdGlvbiBpcyBzdXBwbGllZC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBodHRwT3B0aW9ucyBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIHBhc3MgdG8gdGhlIGxvdy1sZXZlbAogICAgICogICBIVFRQIHJlcXVlc3QuIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICAgKgogICAgICogICAqICoqcHJveHkqKiBbU3RyaW5nXSAmbWRhc2g7IHRoZSBVUkwgdG8gcHJveHkgcmVxdWVzdHMgdGhyb3VnaAogICAgICogICAqICoqYWdlbnQqKiBbaHR0cC5BZ2VudCwgaHR0cHMuQWdlbnRdICZtZGFzaDsgdGhlIEFnZW50IG9iamVjdCB0byBwZXJmb3JtCiAgICAgKiAgICAgSFRUUCByZXF1ZXN0cyB3aXRoLiBVc2VkIGZvciBjb25uZWN0aW9uIHBvb2xpbmcuIERlZmF1bHRzIHRvIHRoZSBnbG9iYWwKICAgICAqICAgICBhZ2VudCAoYGh0dHAuZ2xvYmFsQWdlbnRgKSBmb3Igbm9uLVNTTCBjb25uZWN0aW9ucy4gTm90ZSB0aGF0IGZvcgogICAgICogICAgIFNTTCBjb25uZWN0aW9ucywgYSBzcGVjaWFsIEFnZW50IG9iamVjdCBpcyB1c2VkIGluIG9yZGVyIHRvIGVuYWJsZQogICAgICogICAgIHBlZXIgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uLiBUaGlzIGZlYXR1cmUgaXMgb25seSBhdmFpbGFibGUgaW4gdGhlCiAgICAgKiAgICAgTm9kZS5qcyBlbnZpcm9ubWVudC4KICAgICAqICAgKiAqKmNvbm5lY3RUaW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIKICAgICAqICAgICBmYWlsaW5nIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyIGFmdGVyCiAgICAgKiAgICAgYGNvbm5lY3RUaW1lb3V0YCBtaWxsaXNlY29uZHMuIFRoaXMgdGltZW91dCBoYXMgbm8gZWZmZWN0IG9uY2UgYSBzb2NrZXQKICAgICAqICAgICBjb25uZWN0aW9uIGhhcyBiZWVuIGVzdGFibGlzaGVkLgogICAgICogICAqICoqdGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyIHRpbWVvdXQKICAgICAqICAgICBtaWxsaXNlY29uZHMgb2YgaW5hY3Rpdml0eSBvbiB0aGUgc29ja2V0LiBEZWZhdWx0cyB0byB0d28gbWludXRlcwogICAgICogICAgICgxMjAwMDApLgogICAgICogICAqICoqeGhyQXN5bmMqKiBbQm9vbGVhbl0gJm1kYXNoOyBXaGV0aGVyIHRoZSBTREsgd2lsbCBzZW5kIGFzeW5jaHJvbm91cwogICAgICogICAgIEhUVFAgcmVxdWVzdHMuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb25seS4gU2V0IHRvIGZhbHNlIHRvCiAgICAgKiAgICAgc2VuZCByZXF1ZXN0cyBzeW5jaHJvbm91c2x5LiBEZWZhdWx0cyB0byB0cnVlIChhc3luYyBvbikuCiAgICAgKiAgICogKip4aHJXaXRoQ3JlZGVudGlhbHMqKiBbQm9vbGVhbl0gJm1kYXNoOyBTZXRzIHRoZSAid2l0aENyZWRlbnRpYWxzIgogICAgICogICAgIHByb3BlcnR5IG9mIGFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdC4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudAogICAgICogICAgIG9ubHkuIERlZmF1bHRzIHRvIGZhbHNlLgogICAgICogQG9wdGlvbiBvcHRpb25zIGFwaVZlcnNpb24gW1N0cmluZywgRGF0ZV0gYSBTdHJpbmcgaW4gWVlZWS1NTS1ERCBmb3JtYXQKICAgICAqICAgKG9yIGEgZGF0ZSkgdGhhdCByZXByZXNlbnRzIHRoZSBsYXRlc3QgcG9zc2libGUgQVBJIHZlcnNpb24gdGhhdCBjYW4gYmUKICAgICAqICAgdXNlZCBpbiBhbGwgc2VydmljZXMgKHVubGVzcyBvdmVycmlkZGVuIGJ5IGBhcGlWZXJzaW9uc2ApLiBTcGVjaWZ5CiAgICAgKiAgICdsYXRlc3QnIHRvIHVzZSB0aGUgbGF0ZXN0IHBvc3NpYmxlIHZlcnNpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgYXBpVmVyc2lvbnMgW21hcDxTdHJpbmcsIFN0cmluZ3xEYXRlPl0gYSBtYXAgb2Ygc2VydmljZQogICAgICogICBpZGVudGlmaWVycyAodGhlIGxvd2VyY2FzZSBzZXJ2aWNlIGNsYXNzIG5hbWUpIHdpdGggdGhlIEFQSSB2ZXJzaW9uIHRvCiAgICAgKiAgIHVzZSB3aGVuIGluc3RhbnRpYXRpbmcgYSBzZXJ2aWNlLiBTcGVjaWZ5ICdsYXRlc3QnIGZvciBlYWNoIGluZGl2aWR1YWwKICAgICAqICAgdGhhdCBjYW4gdXNlIHRoZSBsYXRlc3QgYXZhaWxhYmxlIHZlcnNpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbG9nZ2VyIFsjd3JpdGUsI2xvZ10gYW4gb2JqZWN0IHRoYXQgcmVzcG9uZHMgdG8gLndyaXRlKCkKICAgICAqICAgKGxpa2UgYSBzdHJlYW0pIG9yIC5sb2coKSAobGlrZSB0aGUgY29uc29sZSBvYmplY3QpIGluIG9yZGVyIHRvIGxvZwogICAgICogICBpbmZvcm1hdGlvbiBhYm91dCByZXF1ZXN0cwogICAgICogQG9wdGlvbiBvcHRpb25zIHN5c3RlbUNsb2NrT2Zmc2V0IFtOdW1iZXJdIGFuIG9mZnNldCB2YWx1ZSBpbiBtaWxsaXNlY29uZHMKICAgICAqICAgdG8gYXBwbHkgdG8gYWxsIHNpZ25pbmcgdGltZXMuIFVzZSB0aGlzIHRvIGNvbXBlbnNhdGUgZm9yIGNsb2NrIHNrZXcKICAgICAqICAgd2hlbiB5b3VyIHN5c3RlbSBtYXkgYmUgb3V0IG9mIHN5bmMgd2l0aCB0aGUgc2VydmljZSB0aW1lLiBOb3RlIHRoYXQKICAgICAqICAgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiBjYW4gb25seSBiZSBhcHBsaWVkIHRvIHRoZSBnbG9iYWwgYEFXUy5jb25maWdgCiAgICAgKiAgIG9iamVjdCBhbmQgY2Fubm90IGJlIG92ZXJyaWRkZW4gaW4gc2VydmljZS1zcGVjaWZpYyBjb25maWd1cmF0aW9uLgogICAgICogICBEZWZhdWx0cyB0byAwIG1pbGxpc2Vjb25kcy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzaWduYXR1cmVWZXJzaW9uIFtTdHJpbmddIHRoZSBzaWduYXR1cmUgdmVyc2lvbiB0byBzaWduCiAgICAgKiAgIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcgdGhlIEFQSSBjb25maWd1cmF0aW9uKS4gUG9zc2libGUgdmFsdWVzIGFyZToKICAgICAqICAgJ3YyJywgJ3YzJywgJ3Y0Jy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzaWduYXR1cmVDYWNoZSBbQm9vbGVhbl0gd2hldGhlciB0aGUgc2lnbmF0dXJlIHRvIHNpZ24KICAgICAqICAgcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZyB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pIGlzIGNhY2hlZC4gT25seSBhcHBsaWVzCiAgICAgKiAgIHRvIHRoZSBzaWduYXR1cmUgdmVyc2lvbiAndjQnLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgZHluYW1vRGJDcmMzMiBbQm9vbGVhbl0gd2hldGhlciB0byB2YWxpZGF0ZSB0aGUgQ1JDMzIKICAgICAqICAgY2hlY2tzdW0gb2YgSFRUUCByZXNwb25zZSBib2RpZXMgcmV0dXJuZWQgYnkgRHluYW1vREIuIERlZmF1bHQ6IGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyB1c2VBY2NlbGVyYXRlRW5kcG9pbnQgW0Jvb2xlYW5dIFdoZXRoZXIgdG8gdXNlIHRoZQogICAgICogICBTMyBUcmFuc2ZlciBBY2NlbGVyYXRpb24gZW5kcG9pbnQgd2l0aCB0aGUgUzMgc2VydmljZS4gRGVmYXVsdDogYGZhbHNlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjbGllbnRTaWRlTW9uaXRvcmluZyBbQm9vbGVhbl0gd2hldGhlciB0byBjb2xsZWN0IGFuZAogICAgICogICBwdWJsaXNoIHRoaXMgY2xpZW50J3MgcGVyZm9ybWFuY2UgbWV0cmljcyBvZiBhbGwgaXRzIEFQSSByZXF1ZXN0cy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZW5hYmxlIGVuZHBvaW50CiAgICAgKiAgIGRpc2NvdmVyeSBmb3Igb3BlcmF0aW9ucyB0aGF0IGFsbG93IG9wdGlvbmFsbHkgdXNpbmcgYW4gZW5kcG9pbnQgcmV0dXJuZWQgYnkKICAgICAqICAgdGhlIHNlcnZpY2UuCiAgICAgKiAgIERlZmF1bHRzIHRvICdmYWxzZScKICAgICAqIEBvcHRpb24gb3B0aW9ucyBlbmRwb2ludENhY2hlU2l6ZSBbTnVtYmVyXSB0aGUgc2l6ZSBvZiB0aGUgZ2xvYmFsIGNhY2hlIHN0b3JpbmcKICAgICAqICAgZW5kcG9pbnRzIGZyb20gZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbnMuIE9uY2UgZW5kcG9pbnQgY2FjaGUgaXMgY3JlYXRlZCwKICAgICAqICAgdXBkYXRpbmcgdGhpcyBzZXR0aW5nIGNhbm5vdCBjaGFuZ2UgZXhpc3RpbmcgY2FjaGUgc2l6ZS4KICAgICAqICAgRGVmYXVsdHMgdG8gMTAwMAogICAgICogQG9wdGlvbiBvcHRpb25zIGhvc3RQcmVmaXhFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIG1hcnNoYWwgcmVxdWVzdAogICAgICogICBwYXJhbWV0ZXJzIHRvIHRoZSBwcmVmaXggb2YgaG9zdG5hbWUuCiAgICAgKiAgIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzdHNSZWdpb25hbEVuZHBvaW50cyBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hldGhlciB0byBzZW5kIHN0cyByZXF1ZXN0CiAgICAgKiAgIHRvIGdsb2JhbCBlbmRwb2ludHMgb3IgcmVnaW9uYWwgZW5kcG9pbnRzLgogICAgICogICBEZWZhdWx0cyB0byAnbGVnYWN5Jy4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENvbmZpZyhvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB1bmRlZmluZWQpIG9wdGlvbnMgPSB7fTsKICAgICAgb3B0aW9ucyA9IHRoaXMuZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpOwogIAogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5rZXlzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgb3B0aW9uc1trZXldLCB2YWx1ZSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFncm91cCBNYW5hZ2luZyBDcmVkZW50aWFscwogICAgICovCiAgCiAgICAvKioKICAgICAqIExvYWRzIGNyZWRlbnRpYWxzIGZyb20gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBUaGlzIGlzIHVzZWQgaW50ZXJuYWxseQogICAgICogYnkgdGhlIFNESyB0byBlbnN1cmUgdGhhdCByZWZyZXNoYWJsZSB7Q3JlZGVudGlhbHN9IG9iamVjdHMgYXJlIHByb3Blcmx5CiAgICAgKiByZWZyZXNoZWQgYW5kIGxvYWRlZCB3aGVuIHNlbmRpbmcgYSByZXF1ZXN0LiBJZiB5b3Ugd2FudCB0byBlbnN1cmUgdGhhdAogICAgICogeW91ciBjcmVkZW50aWFscyBhcmUgbG9hZGVkIHByaW9yIHRvIGEgcmVxdWVzdCwgeW91IGNhbiB1c2UgdGhpcyBtZXRob2QKICAgICAqIGRpcmVjdGx5IHRvIHByb3ZpZGUgYWNjdXJhdGUgY3JlZGVudGlhbCBkYXRhIHN0b3JlZCBpbiB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBub3RlIElmIHlvdSBjb25maWd1cmUgdGhlIFNESyB3aXRoIHN0YXRpYyBvciBlbnZpcm9ubWVudCBjcmVkZW50aWFscywKICAgICAqICAgdGhlIGNyZWRlbnRpYWwgZGF0YSBzaG91bGQgYWxyZWFkeSBiZSBwcmVzZW50IGluIHtjcmVkZW50aWFsc30gYXR0cmlidXRlLgogICAgICogICBUaGlzIG1ldGhvZCBpcyBwcmltYXJpbHkgbmVjZXNzYXJ5IHRvIGxvYWQgY3JlZGVudGlhbHMgZnJvbSBhc3luY2hyb25vdXMKICAgICAqICAgc291cmNlcywgb3Igc291cmNlcyB0aGF0IGNhbiByZWZyZXNoIGNyZWRlbnRpYWxzIHBlcmlvZGljYWxseS4KICAgICAqIEBleGFtcGxlIEdldHRpbmcgeW91ciBhY2Nlc3Mga2V5CiAgICAgKiAgIEFXUy5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICAgKiAgICAgaWYgKGVycikgY29uc29sZS5sb2coZXJyLnN0YWNrKTsgLy8gY3JlZGVudGlhbHMgbm90IGxvYWRlZAogICAgICogICAgIGVsc2UgY29uc29sZS5sb2coIkFjY2VzcyBLZXk6IiwgQVdTLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCk7CiAgICAgKiAgIH0pCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUge2NyZWRlbnRpYWxzfSBoYXZlIGJlZW4gcHJvcGVybHkgc2V0IG9uIHRoZSBjb25maWd1cmF0aW9uCiAgICAgKiAgIG9iamVjdC4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiB0aGlzIGlzIHNldCwgY3JlZGVudGlhbHMgd2VyZSBub3Qgc3VjY2Vzc2Z1bGx5CiAgICAgKiAgICAgbG9hZGVkIGFuZCB0aGlzIGVycm9yIHByb3ZpZGVzIGluZm9ybWF0aW9uIHdoeS4KICAgICAqIEBzZWUgY3JlZGVudGlhbHMKICAgICAqIEBzZWUgQ3JlZGVudGlhbHMKICAgICAqLwogICAgZ2V0Q3JlZGVudGlhbHM6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgZnVuY3Rpb24gZmluaXNoKGVycikgewogICAgICAgIGNhbGxiYWNrKGVyciwgZXJyID8gbnVsbCA6IHNlbGYuY3JlZGVudGlhbHMpOwogICAgICB9CiAgCiAgICAgIGZ1bmN0aW9uIGNyZWRFcnJvcihtc2csIGVycikgewogICAgICAgIHJldHVybiBuZXcgQVdTLnV0aWwuZXJyb3IoZXJyIHx8IG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnQ3JlZGVudGlhbHNFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiBtc2csCiAgICAgICAgICBuYW1lOiAnQ3JlZGVudGlhbHNFcnJvcicKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICBmdW5jdGlvbiBnZXRBc3luY0NyZWRlbnRpYWxzKCkgewogICAgICAgIHNlbGYuY3JlZGVudGlhbHMuZ2V0KGZ1bmN0aW9uKGVycikgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICB2YXIgbXNnID0gJ0NvdWxkIG5vdCBsb2FkIGNyZWRlbnRpYWxzIGZyb20gJyArCiAgICAgICAgICAgICAgc2VsZi5jcmVkZW50aWFscy5jb25zdHJ1Y3Rvci5uYW1lOwogICAgICAgICAgICBlcnIgPSBjcmVkRXJyb3IobXNnLCBlcnIpOwogICAgICAgICAgfQogICAgICAgICAgZmluaXNoKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgZnVuY3Rpb24gZ2V0U3RhdGljQ3JlZGVudGlhbHMoKSB7CiAgICAgICAgdmFyIGVyciA9IG51bGw7CiAgICAgICAgaWYgKCFzZWxmLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkIHx8ICFzZWxmLmNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSkgewogICAgICAgICAgZXJyID0gY3JlZEVycm9yKCdNaXNzaW5nIGNyZWRlbnRpYWxzJyk7CiAgICAgICAgfQogICAgICAgIGZpbmlzaChlcnIpOwogICAgICB9CiAgCiAgICAgIGlmIChzZWxmLmNyZWRlbnRpYWxzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzZWxmLmNyZWRlbnRpYWxzLmdldCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgZ2V0QXN5bmNDcmVkZW50aWFscygpOwogICAgICAgIH0gZWxzZSB7IC8vIHN0YXRpYyBjcmVkZW50aWFscwogICAgICAgICAgZ2V0U3RhdGljQ3JlZGVudGlhbHMoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5jcmVkZW50aWFsUHJvdmlkZXIpIHsKICAgICAgICBzZWxmLmNyZWRlbnRpYWxQcm92aWRlci5yZXNvbHZlKGZ1bmN0aW9uKGVyciwgY3JlZHMpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgZXJyID0gY3JlZEVycm9yKCdDb3VsZCBub3QgbG9hZCBjcmVkZW50aWFscyBmcm9tIGFueSBwcm92aWRlcnMnLCBlcnIpOwogICAgICAgICAgfQogICAgICAgICAgc2VsZi5jcmVkZW50aWFscyA9IGNyZWRzOwogICAgICAgICAgZmluaXNoKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZmluaXNoKGNyZWRFcnJvcignTm8gY3JlZGVudGlhbHMgdG8gbG9hZCcpKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQCFncm91cCBMb2FkaW5nIGFuZCBTZXR0aW5nIENvbmZpZ3VyYXRpb24gT3B0aW9ucwogICAgICovCiAgCiAgICAvKioKICAgICAqIEBvdmVybG9hZCB1cGRhdGUob3B0aW9ucywgYWxsb3dVbmtub3duS2V5cyA9IGZhbHNlKQogICAgICogICBVcGRhdGVzIHRoZSBjdXJyZW50IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggbmV3IG9wdGlvbnMuCiAgICAgKgogICAgICogICBAZXhhbXBsZSBVcGRhdGUgbWF4UmV0cmllcyBwcm9wZXJ0eSBvZiBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKiAgICAgY29uZmlnLnVwZGF0ZSh7bWF4UmV0cmllczogMTB9KTsKICAgICAqICAgQHBhcmFtIFtPYmplY3RdIG9wdGlvbnMgYSBtYXAgb2Ygb3B0aW9uIGtleXMgYW5kIHZhbHVlcy4KICAgICAqICAgQHBhcmFtIFtCb29sZWFuXSBhbGxvd1Vua25vd25LZXlzIHdoZXRoZXIgdW5rbm93biBrZXlzIGNhbiBiZSBzZXQgb24KICAgICAqICAgICB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICAgKiAgIEBzZWUgY29uc3RydWN0b3IKICAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUob3B0aW9ucywgYWxsb3dVbmtub3duS2V5cykgewogICAgICBhbGxvd1Vua25vd25LZXlzID0gYWxsb3dVbmtub3duS2V5cyB8fCBmYWxzZTsKICAgICAgb3B0aW9ucyA9IHRoaXMuZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpOwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgb3B0aW9ucywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoYWxsb3dVbmtub3duS2V5cyB8fCBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5rZXlzLCBrZXkpIHx8CiAgICAgICAgICAgIEFXUy5TZXJ2aWNlLmhhc1NlcnZpY2Uoa2V5KSkgewogICAgICAgICAgdGhpcy5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIExvYWRzIGNvbmZpZ3VyYXRpb24gZGF0YSBmcm9tIGEgSlNPTiBmaWxlIGludG8gdGhpcyBjb25maWcgb2JqZWN0LgogICAgICogQG5vdGUgTG9hZGluZyBjb25maWd1cmF0aW9uIHdpbGwgcmVzZXQgYWxsIGV4aXN0aW5nIGNvbmZpZ3VyYXRpb24KICAgICAqICAgb24gdGhlIG9iamVjdC4KICAgICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICAgKiBAcGFyYW0gcGF0aCBbU3RyaW5nXSB0aGUgcGF0aCByZWxhdGl2ZSB0byB5b3VyIHByb2Nlc3MncyBjdXJyZW50CiAgICAgKiAgICB3b3JraW5nIGRpcmVjdG9yeSB0byBsb2FkIGNvbmZpZ3VyYXRpb24gZnJvbS4KICAgICAqIEByZXR1cm4gW0FXUy5Db25maWddIHRoZSBzYW1lIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKi8KICAgIGxvYWRGcm9tUGF0aDogZnVuY3Rpb24gbG9hZEZyb21QYXRoKHBhdGgpIHsKICAgICAgdGhpcy5jbGVhcigpOwogIAogICAgICB2YXIgb3B0aW9ucyA9IEpTT04ucGFyc2UoQVdTLnV0aWwucmVhZEZpbGVTeW5jKHBhdGgpKTsKICAgICAgdmFyIGZpbGVTeXN0ZW1DcmVkcyA9IG5ldyBBV1MuRmlsZVN5c3RlbUNyZWRlbnRpYWxzKHBhdGgpOwogICAgICB2YXIgY2hhaW4gPSBuZXcgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKCk7CiAgICAgIGNoYWluLnByb3ZpZGVycy51bnNoaWZ0KGZpbGVTeXN0ZW1DcmVkcyk7CiAgICAgIGNoYWluLnJlc29sdmUoZnVuY3Rpb24gKGVyciwgY3JlZHMpIHsKICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAgICAgZWxzZSBvcHRpb25zLmNyZWRlbnRpYWxzID0gY3JlZHM7CiAgICAgIH0pOwogIAogICAgICB0aGlzLmNvbnN0cnVjdG9yKG9wdGlvbnMpOwogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENsZWFycyBjb25maWd1cmF0aW9uIGRhdGEgb24gdGhpcyBvYmplY3QKICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICAvKmpzaGludCBmb3JpbjpmYWxzZSAqLwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5rZXlzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgICAgfSk7CiAgCiAgICAgIC8vIHJlc2V0IGNyZWRlbnRpYWwgcHJvdmlkZXIKICAgICAgdGhpcy5zZXQoJ2NyZWRlbnRpYWxzJywgdW5kZWZpbmVkKTsKICAgICAgdGhpcy5zZXQoJ2NyZWRlbnRpYWxQcm92aWRlcicsIHVuZGVmaW5lZCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBTZXRzIGEgcHJvcGVydHkgb24gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LCBhbGxvd2luZyBmb3IgYQogICAgICogZGVmYXVsdCB2YWx1ZQogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldDogZnVuY3Rpb24gc2V0KHByb3BlcnR5LCB2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBkZWZhdWx0VmFsdWUgPSB0aGlzLmtleXNbcHJvcGVydHldOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGRlZmF1bHRWYWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBkZWZhdWx0VmFsdWUuY2FsbCh0aGlzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHByb3BlcnR5ID09PSAnaHR0cE9wdGlvbnMnICYmIHRoaXNbcHJvcGVydHldKSB7CiAgICAgICAgLy8gZGVlcCBtZXJnZSBodHRwT3B0aW9ucwogICAgICAgIHRoaXNbcHJvcGVydHldID0gQVdTLnV0aWwubWVyZ2UodGhpc1twcm9wZXJ0eV0sIHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IHZhbHVlOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBbGwgb2YgdGhlIGtleXMgd2l0aCB0aGVpciBkZWZhdWx0IHZhbHVlcy4KICAgICAqCiAgICAgKiBAY29uc3RhbnQKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBrZXlzOiB7CiAgICAgIGNyZWRlbnRpYWxzOiBudWxsLAogICAgICBjcmVkZW50aWFsUHJvdmlkZXI6IG51bGwsCiAgICAgIHJlZ2lvbjogbnVsbCwKICAgICAgbG9nZ2VyOiBudWxsLAogICAgICBhcGlWZXJzaW9uczoge30sCiAgICAgIGFwaVZlcnNpb246IG51bGwsCiAgICAgIGVuZHBvaW50OiB1bmRlZmluZWQsCiAgICAgIGh0dHBPcHRpb25zOiB7CiAgICAgICAgdGltZW91dDogMTIwMDAwCiAgICAgIH0sCiAgICAgIG1heFJldHJpZXM6IHVuZGVmaW5lZCwKICAgICAgbWF4UmVkaXJlY3RzOiAxMCwKICAgICAgcGFyYW1WYWxpZGF0aW9uOiB0cnVlLAogICAgICBzc2xFbmFibGVkOiB0cnVlLAogICAgICBzM0ZvcmNlUGF0aFN0eWxlOiBmYWxzZSwKICAgICAgczNCdWNrZXRFbmRwb2ludDogZmFsc2UsCiAgICAgIHMzRGlzYWJsZUJvZHlTaWduaW5nOiB0cnVlLAogICAgICBjb21wdXRlQ2hlY2tzdW1zOiB0cnVlLAogICAgICBjb252ZXJ0UmVzcG9uc2VUeXBlczogdHJ1ZSwKICAgICAgY29ycmVjdENsb2NrU2tldzogZmFsc2UsCiAgICAgIGN1c3RvbVVzZXJBZ2VudDogbnVsbCwKICAgICAgZHluYW1vRGJDcmMzMjogdHJ1ZSwKICAgICAgc3lzdGVtQ2xvY2tPZmZzZXQ6IDAsCiAgICAgIHNpZ25hdHVyZVZlcnNpb246IG51bGwsCiAgICAgIHNpZ25hdHVyZUNhY2hlOiB0cnVlLAogICAgICByZXRyeURlbGF5T3B0aW9uczoge30sCiAgICAgIHVzZUFjY2VsZXJhdGVFbmRwb2ludDogZmFsc2UsCiAgICAgIGNsaWVudFNpZGVNb25pdG9yaW5nOiBmYWxzZSwKICAgICAgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkOiBmYWxzZSwKICAgICAgZW5kcG9pbnRDYWNoZVNpemU6IDEwMDAsCiAgICAgIGhvc3RQcmVmaXhFbmFibGVkOiB0cnVlLAogICAgICBzdHNSZWdpb25hbEVuZHBvaW50czogbnVsbAogICAgfSwKICAKICAgIC8qKgogICAgICogRXh0cmFjdHMgYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleSBhbmQgc2Vzc2lvblRva2VuCiAgICAgKiBmcm9tIGEgY29uZmlndXJhdGlvbiBoYXNoLgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBleHRyYWN0Q3JlZGVudGlhbHM6IGZ1bmN0aW9uIGV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zLmFjY2Vzc0tleUlkICYmIG9wdGlvbnMuc2VjcmV0QWNjZXNzS2V5KSB7CiAgICAgICAgb3B0aW9ucyA9IEFXUy51dGlsLmNvcHkob3B0aW9ucyk7CiAgICAgICAgb3B0aW9ucy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMob3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9wdGlvbnM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBwcm9taXNlIGRlcGVuZGVuY3kgdGhlIFNESyB3aWxsIHVzZSB3aGVyZXZlciBQcm9taXNlcyBhcmUgcmV0dXJuZWQuCiAgICAgKiBQYXNzaW5nIGBudWxsYCB3aWxsIGZvcmNlIHRoZSBTREsgdG8gdXNlIG5hdGl2ZSBQcm9taXNlcyBpZiB0aGV5IGFyZSBhdmFpbGFibGUuCiAgICAgKiBJZiBuYXRpdmUgUHJvbWlzZXMgYXJlIG5vdCBhdmFpbGFibGUsIHBhc3NpbmcgYG51bGxgIHdpbGwgaGF2ZSBubyBlZmZlY3QuCiAgICAgKiBAcGFyYW0gW0NvbnN0cnVjdG9yXSBkZXAgQSByZWZlcmVuY2UgdG8gYSBQcm9taXNlIGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIHNldFByb21pc2VzRGVwZW5kZW5jeTogZnVuY3Rpb24gc2V0UHJvbWlzZXNEZXBlbmRlbmN5KGRlcCkgewogICAgICBQcm9taXNlc0RlcGVuZGVuY3kgPSBkZXA7CiAgICAgIC8vIGlmIG51bGwgd2FzIHBhc3NlZCBpbiwgd2Ugc2hvdWxkIHRyeSB0byB1c2UgbmF0aXZlIHByb21pc2VzCiAgICAgIGlmIChkZXAgPT09IG51bGwgJiYgdHlwZW9mIFByb21pc2UgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBQcm9taXNlc0RlcGVuZGVuY3kgPSBQcm9taXNlOwogICAgICB9CiAgICAgIHZhciBjb25zdHJ1Y3RvcnMgPSBbQVdTLlJlcXVlc3QsIEFXUy5DcmVkZW50aWFscywgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXTsKICAgICAgaWYgKEFXUy5TMykgewogICAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKEFXUy5TMyk7CiAgICAgICAgaWYgKEFXUy5TMy5NYW5hZ2VkVXBsb2FkKSB7CiAgICAgICAgICBjb25zdHJ1Y3RvcnMucHVzaChBV1MuUzMuTWFuYWdlZFVwbG9hZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIEFXUy51dGlsLmFkZFByb21pc2VzKGNvbnN0cnVjdG9ycywgUHJvbWlzZXNEZXBlbmRlbmN5KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEdldHMgdGhlIHByb21pc2UgZGVwZW5kZW5jeSBzZXQgYnkgYEFXUy5jb25maWcuc2V0UHJvbWlzZXNEZXBlbmRlbmN5YC4KICAgICAqLwogICAgZ2V0UHJvbWlzZXNEZXBlbmRlbmN5OiBmdW5jdGlvbiBnZXRQcm9taXNlc0RlcGVuZGVuY3koKSB7CiAgICAgIHJldHVybiBQcm9taXNlc0RlcGVuZGVuY3k7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQHJldHVybiBbQVdTLkNvbmZpZ10gVGhlIGdsb2JhbCBjb25maWd1cmF0aW9uIG9iamVjdCBzaW5nbGV0b24gaW5zdGFuY2UKICAgKiBAcmVhZG9ubHkKICAgKiBAc2VlIEFXUy5Db25maWcKICAgKi8KICBBV1MuY29uZmlnID0gbmV3IEFXUy5Db25maWcoKTsKICAKICB9LHsiLi9jb3JlIjoxOCwiLi9jcmVkZW50aWFscyI6MTksIi4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbiI6MjJ9XSwxODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogVGhlIG1haW4gQVdTIG5hbWVzcGFjZQogICAqLwogIHZhciBBV1MgPSB7IHV0aWw6IHJlcXVpcmUoJy4vdXRpbCcpIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogQCFtYWNybyBbbmV3XSBub2Jyb3dzZXIKICAgKiAgIEBub3RlIFRoaXMgZmVhdHVyZSBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9mIHRoZSBTREsuCiAgICovCiAgdmFyIF9oaWRkZW4gPSB7fTsgX2hpZGRlbi50b1N0cmluZygpOyAvLyBoYWNrIHRvIHBhcnNlIG1hY3JvCiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1M7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUywgewogIAogICAgLyoqCiAgICAgKiBAY29uc3RhbnQKICAgICAqLwogICAgVkVSU0lPTjogJzIuNTUzLjAnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgU2lnbmVyczoge30sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBQcm90b2NvbDogewogICAgICBKc29uOiByZXF1aXJlKCcuL3Byb3RvY29sL2pzb24nKSwKICAgICAgUXVlcnk6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKSwKICAgICAgUmVzdDogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0JyksCiAgICAgIFJlc3RKc29uOiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfanNvbicpLAogICAgICBSZXN0WG1sOiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfeG1sJykKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBYTUw6IHsKICAgICAgQnVpbGRlcjogcmVxdWlyZSgnLi94bWwvYnVpbGRlcicpLAogICAgICBQYXJzZXI6IG51bGwgLy8gY29uZGl0aW9uYWxseSBzZXQgYmFzZWQgb24gZW52aXJvbm1lbnQKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBKU09OOiB7CiAgICAgIEJ1aWxkZXI6IHJlcXVpcmUoJy4vanNvbi9idWlsZGVyJyksCiAgICAgIFBhcnNlcjogcmVxdWlyZSgnLi9qc29uL3BhcnNlcicpCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgTW9kZWw6IHsKICAgICAgQXBpOiByZXF1aXJlKCcuL21vZGVsL2FwaScpLAogICAgICBPcGVyYXRpb246IHJlcXVpcmUoJy4vbW9kZWwvb3BlcmF0aW9uJyksCiAgICAgIFNoYXBlOiByZXF1aXJlKCcuL21vZGVsL3NoYXBlJyksCiAgICAgIFBhZ2luYXRvcjogcmVxdWlyZSgnLi9tb2RlbC9wYWdpbmF0b3InKSwKICAgICAgUmVzb3VyY2VXYWl0ZXI6IHJlcXVpcmUoJy4vbW9kZWwvcmVzb3VyY2Vfd2FpdGVyJykKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcGlMb2FkZXI6IHJlcXVpcmUoJy4vYXBpX2xvYWRlcicpLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgRW5kcG9pbnRDYWNoZTogcmVxdWlyZSgnLi4vdmVuZG9yL2VuZHBvaW50LWNhY2hlJykuRW5kcG9pbnRDYWNoZQogIH0pOwogIHJlcXVpcmUoJy4vc2VxdWVudGlhbF9leGVjdXRvcicpOwogIHJlcXVpcmUoJy4vc2VydmljZScpOwogIHJlcXVpcmUoJy4vY29uZmlnJyk7CiAgcmVxdWlyZSgnLi9odHRwJyk7CiAgcmVxdWlyZSgnLi9ldmVudF9saXN0ZW5lcnMnKTsKICByZXF1aXJlKCcuL3JlcXVlc3QnKTsKICByZXF1aXJlKCcuL3Jlc3BvbnNlJyk7CiAgcmVxdWlyZSgnLi9yZXNvdXJjZV93YWl0ZXInKTsKICByZXF1aXJlKCcuL3NpZ25lcnMvcmVxdWVzdF9zaWduZXInKTsKICByZXF1aXJlKCcuL3BhcmFtX3ZhbGlkYXRvcicpOwogIAogIC8qKgogICAqIEByZWFkb25seQogICAqIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIGEgY29sbGVjdGlvbiBvZiBnbG9iYWwgZXZlbnQgbGlzdGVuZXJzIHRoYXQKICAgKiAgIGFyZSBhdHRhY2hlZCB0byBldmVyeSBzZW50IHJlcXVlc3QuCiAgICogQHNlZSBBV1MuUmVxdWVzdCBBV1MuUmVxdWVzdCBmb3IgYSBsaXN0IG9mIGV2ZW50cyB0byBsaXN0ZW4gZm9yCiAgICogQGV4YW1wbGUgTG9nZ2luZyB0aGUgdGltZSB0YWtlbiB0byBzZW5kIGEgcmVxdWVzdAogICAqICAgQVdTLmV2ZW50cy5vbignc2VuZCcsIGZ1bmN0aW9uIHN0YXJ0U2VuZChyZXNwKSB7CiAgICogICAgIHJlc3Auc3RhcnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICogICB9KS5vbignY29tcGxldGUnLCBmdW5jdGlvbiBjYWxjdWxhdGVUaW1lKHJlc3ApIHsKICAgKiAgICAgdmFyIHRpbWUgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkgLSByZXNwLnN0YXJ0VGltZSkgLyAxMDAwOwogICAqICAgICBjb25zb2xlLmxvZygnUmVxdWVzdCB0b29rICcgKyB0aW1lICsgJyBzZWNvbmRzJyk7CiAgICogICB9KTsKICAgKgogICAqICAgbmV3IEFXUy5TMygpLmxpc3RCdWNrZXRzKCk7IC8vIHByaW50cyAnUmVxdWVzdCB0b29rIDAuMjg1IHNlY29uZHMnCiAgICovCiAgQVdTLmV2ZW50cyA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgCiAgLy9jcmVhdGUgZW5kcG9pbnQgY2FjaGUgbGF6aWx5CiAgQVdTLnV0aWwubWVtb2l6ZWRQcm9wZXJ0eShBV1MsICdlbmRwb2ludENhY2hlJywgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gbmV3IEFXUy5FbmRwb2ludENhY2hlKEFXUy5jb25maWcuZW5kcG9pbnRDYWNoZVNpemUpOwogIH0sIHRydWUpOwogIAogIH0seyIuLi92ZW5kb3IvZW5kcG9pbnQtY2FjaGUiOjEwMywiLi9hcGlfbG9hZGVyIjo5LCIuL2NvbmZpZyI6MTcsIi4vZXZlbnRfbGlzdGVuZXJzIjozMywiLi9odHRwIjozNCwiLi9qc29uL2J1aWxkZXIiOjM2LCIuL2pzb24vcGFyc2VyIjozNywiLi9tb2RlbC9hcGkiOjM4LCIuL21vZGVsL29wZXJhdGlvbiI6NDAsIi4vbW9kZWwvcGFnaW5hdG9yIjo0MSwiLi9tb2RlbC9yZXNvdXJjZV93YWl0ZXIiOjQyLCIuL21vZGVsL3NoYXBlIjo0MywiLi9wYXJhbV92YWxpZGF0b3IiOjQ0LCIuL3Byb3RvY29sL2pzb24iOjQ2LCIuL3Byb3RvY29sL3F1ZXJ5Ijo0NywiLi9wcm90b2NvbC9yZXN0Ijo0OCwiLi9wcm90b2NvbC9yZXN0X2pzb24iOjQ5LCIuL3Byb3RvY29sL3Jlc3RfeG1sIjo1MCwiLi9yZXF1ZXN0Ijo1NSwiLi9yZXNvdXJjZV93YWl0ZXIiOjU2LCIuL3Jlc3BvbnNlIjo1NywiLi9zZXF1ZW50aWFsX2V4ZWN1dG9yIjo1OCwiLi9zZXJ2aWNlIjo1OSwiLi9zaWduZXJzL3JlcXVlc3Rfc2lnbmVyIjo2MywiLi91dGlsIjo3MSwiLi94bWwvYnVpbGRlciI6NzN9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgeW91ciBBV1Mgc2VjdXJpdHkgY3JlZGVudGlhbHMsIHNwZWNpZmljYWxseSB0aGUKICAgKiB7YWNjZXNzS2V5SWR9LCB7c2VjcmV0QWNjZXNzS2V5fSwgYW5kIG9wdGlvbmFsIHtzZXNzaW9uVG9rZW59LgogICAqIENyZWF0aW5nIGEgYENyZWRlbnRpYWxzYCBvYmplY3QgYWxsb3dzIHlvdSB0byBwYXNzIGFyb3VuZCB5b3VyCiAgICogc2VjdXJpdHkgaW5mb3JtYXRpb24gdG8gY29uZmlndXJhdGlvbiBhbmQgc2VydmljZSBvYmplY3RzLgogICAqCiAgICogTm90ZSB0aGF0IHRoaXMgY2xhc3MgdHlwaWNhbGx5IGRvZXMgbm90IG5lZWQgdG8gYmUgY29uc3RydWN0ZWQgbWFudWFsbHksCiAgICogYXMgdGhlIHtBV1MuQ29uZmlnfSBhbmQge0FXUy5TZXJ2aWNlfSBjbGFzc2VzIGJvdGggYWNjZXB0IHNpbXBsZQogICAqIG9wdGlvbnMgaGFzaGVzIHdpdGggdGhlIHRocmVlIGtleXMuIFRoZXNlIHN0cnVjdHVyZXMgd2lsbCBiZSBjb252ZXJ0ZWQKICAgKiBpbnRvIENyZWRlbnRpYWxzIG9iamVjdHMgYXV0b21hdGljYWxseS4KICAgKgogICAqICMjIEV4cGlyaW5nIGFuZCBSZWZyZXNoaW5nIENyZWRlbnRpYWxzCiAgICoKICAgKiBPY2Nhc2lvbmFsbHkgY3JlZGVudGlhbHMgY2FuIGV4cGlyZSBpbiB0aGUgbWlkZGxlIG9mIGEgbG9uZy1ydW5uaW5nCiAgICogYXBwbGljYXRpb24uIEluIHRoaXMgY2FzZSwgdGhlIFNESyB3aWxsIGF1dG9tYXRpY2FsbHkgYXR0ZW1wdCB0bwogICAqIHJlZnJlc2ggdGhlIGNyZWRlbnRpYWxzIGZyb20gdGhlIHN0b3JhZ2UgbG9jYXRpb24gaWYgdGhlIENyZWRlbnRpYWxzCiAgICogY2xhc3MgaW1wbGVtZW50cyB0aGUge3JlZnJlc2h9IG1ldGhvZC4KICAgKgogICAqIElmIHlvdSBhcmUgaW1wbGVtZW50aW5nIGEgY3JlZGVudGlhbCBzdG9yYWdlIGxvY2F0aW9uLCB5b3UKICAgKiB3aWxsIHdhbnQgdG8gY3JlYXRlIGEgc3ViY2xhc3Mgb2YgdGhlIGBDcmVkZW50aWFsc2AgY2xhc3MgYW5kCiAgICogb3ZlcnJpZGUgdGhlIHtyZWZyZXNofSBtZXRob2QuIFRoaXMgbWV0aG9kIGFsbG93cyBjcmVkZW50aWFscyB0byBiZQogICAqIHJldHJpZXZlZCBmcm9tIHRoZSBiYWNraW5nIHN0b3JlLCBiZSBpdCBhIGZpbGUgc3lzdGVtLCBkYXRhYmFzZSwgb3IKICAgKiBzb21lIG5ldHdvcmsgc3RvcmFnZS4gVGhlIG1ldGhvZCBzaG91bGQgcmVzZXQgdGhlIGNyZWRlbnRpYWwgYXR0cmlidXRlcwogICAqIG9uIHRoZSBvYmplY3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBleHBpcmVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBjcmVkZW50aWFscyBoYXZlIGJlZW4gZXhwaXJlZCBhbmQKICAgKiAgICAgcmVxdWlyZSBhIHJlZnJlc2guIFVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB7ZXhwaXJlVGltZX0uCiAgICogQCFhdHRyaWJ1dGUgZXhwaXJlVGltZQogICAqICAgQHJldHVybiBbRGF0ZV0gYSB0aW1lIHdoZW4gY3JlZGVudGlhbHMgc2hvdWxkIGJlIGNvbnNpZGVyZWQgZXhwaXJlZC4gVXNlZAogICAqICAgICBpbiBjb25qdW5jdGlvbiB3aXRoIHtleHBpcmVkfS4KICAgKiBAIWF0dHJpYnV0ZSBhY2Nlc3NLZXlJZAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgKiBAIWF0dHJpYnV0ZSBzZWNyZXRBY2Nlc3NLZXkKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAqIEAhYXR0cmlidXRlIHNlc3Npb25Ub2tlbgogICAqICAgQHJldHVybiBbU3RyaW5nXSBhbiBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAqLwogIEFXUy5DcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBBIGNyZWRlbnRpYWxzIG9iamVjdCBjYW4gYmUgY3JlYXRlZCB1c2luZyBwb3NpdGlvbmFsIGFyZ3VtZW50cyBvciBhbiBvcHRpb25zCiAgICAgKiBoYXNoLgogICAgICoKICAgICAqIEBvdmVybG9hZCBBV1MuQ3JlZGVudGlhbHMoYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleSwgc2Vzc2lvblRva2VuPW51bGwpCiAgICAgKiAgIENyZWF0ZXMgYSBDcmVkZW50aWFscyBvYmplY3Qgd2l0aCBhIGdpdmVuIHNldCBvZiBjcmVkZW50aWFsIGluZm9ybWF0aW9uCiAgICAgKiAgIGFzIHBvc2l0aW9uYWwgYXJndW1lbnRzLgogICAgICogICBAcGFyYW0gYWNjZXNzS2V5SWQgW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICAgKiAgIEBwYXJhbSBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAgICogICBAcGFyYW0gc2Vzc2lvblRva2VuIFtTdHJpbmddIHRoZSBvcHRpb25hbCBBV1Mgc2Vzc2lvbiB0b2tlbgogICAgICogICBAZXhhbXBsZSBDcmVhdGUgYSBjcmVkZW50aWFscyBvYmplY3Qgd2l0aCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgY3JlZHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKCdha2lkJywgJ3NlY3JldCcsICdzZXNzaW9uJyk7CiAgICAgKiBAb3ZlcmxvYWQgQVdTLkNyZWRlbnRpYWxzKG9wdGlvbnMpCiAgICAgKiAgIENyZWF0ZXMgYSBDcmVkZW50aWFscyBvYmplY3Qgd2l0aCBhIGdpdmVuIHNldCBvZiBjcmVkZW50aWFsIGluZm9ybWF0aW9uCiAgICAgKiAgIGFzIGFuIG9wdGlvbnMgaGFzaC4KICAgICAqICAgQG9wdGlvbiBvcHRpb25zIGFjY2Vzc0tleUlkIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAgICogICBAb3B0aW9uIG9wdGlvbnMgc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgICAqICAgQG9wdGlvbiBvcHRpb25zIHNlc3Npb25Ub2tlbiBbU3RyaW5nXSB0aGUgb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgICAqICAgQGV4YW1wbGUgQ3JlYXRlIGEgY3JlZGVudGlhbHMgb2JqZWN0IHdpdGggQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGNyZWRzID0gbmV3IEFXUy5DcmVkZW50aWFscyh7CiAgICAgKiAgICAgICBhY2Nlc3NLZXlJZDogJ2FraWQnLCBzZWNyZXRBY2Nlc3NLZXk6ICdzZWNyZXQnLCBzZXNzaW9uVG9rZW46ICdzZXNzaW9uJwogICAgICogICAgIH0pOwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ3JlZGVudGlhbHMoKSB7CiAgICAgIC8vIGhpZGUgc2VjcmV0QWNjZXNzS2V5IGZyb20gYmVpbmcgZGlzcGxheWVkIHdpdGggdXRpbC5pbnNwZWN0CiAgICAgIEFXUy51dGlsLmhpZGVQcm9wZXJ0aWVzKHRoaXMsIFsnc2VjcmV0QWNjZXNzS2V5J10pOwogIAogICAgICB0aGlzLmV4cGlyZWQgPSBmYWxzZTsKICAgICAgdGhpcy5leHBpcmVUaW1lID0gbnVsbDsKICAgICAgdGhpcy5yZWZyZXNoQ2FsbGJhY2tzID0gW107CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgdmFyIGNyZWRzID0gYXJndW1lbnRzWzBdLmNyZWRlbnRpYWxzIHx8IGFyZ3VtZW50c1swXTsKICAgICAgICB0aGlzLmFjY2Vzc0tleUlkID0gY3JlZHMuYWNjZXNzS2V5SWQ7CiAgICAgICAgdGhpcy5zZWNyZXRBY2Nlc3NLZXkgPSBjcmVkcy5zZWNyZXRBY2Nlc3NLZXk7CiAgICAgICAgdGhpcy5zZXNzaW9uVG9rZW4gPSBjcmVkcy5zZXNzaW9uVG9rZW47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hY2Nlc3NLZXlJZCA9IGFyZ3VtZW50c1swXTsKICAgICAgICB0aGlzLnNlY3JldEFjY2Vzc0tleSA9IGFyZ3VtZW50c1sxXTsKICAgICAgICB0aGlzLnNlc3Npb25Ub2tlbiA9IGFyZ3VtZW50c1syXTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiBzZWNvbmRzIGJlZm9yZSB7ZXhwaXJlVGltZX0gZHVyaW5nIHdoaWNoCiAgICAgKiAgIHRoZSBjcmVkZW50aWFscyB3aWxsIGJlIGNvbnNpZGVyZWQgZXhwaXJlZC4KICAgICAqLwogICAgZXhwaXJ5V2luZG93OiAxNSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHNob3VsZCBjYWxsIHtyZWZyZXNofQogICAgICogQG5vdGUgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gcHJvdmlkZSBjdXN0b20gcmVmcmVzaAogICAgICogICBsb2dpYy4KICAgICAqLwogICAgbmVlZHNSZWZyZXNoOiBmdW5jdGlvbiBuZWVkc1JlZnJlc2goKSB7CiAgICAgIHZhciBjdXJyZW50VGltZSA9IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpLmdldFRpbWUoKTsKICAgICAgdmFyIGFkanVzdGVkVGltZSA9IG5ldyBEYXRlKGN1cnJlbnRUaW1lICsgdGhpcy5leHBpcnlXaW5kb3cgKiAxMDAwKTsKICAKICAgICAgaWYgKHRoaXMuZXhwaXJlVGltZSAmJiBhZGp1c3RlZFRpbWUgPiB0aGlzLmV4cGlyZVRpbWUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5leHBpcmVkIHx8ICF0aGlzLmFjY2Vzc0tleUlkIHx8ICF0aGlzLnNlY3JldEFjY2Vzc0tleTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgZXhpc3RpbmcgY3JlZGVudGlhbHMsIHJlZnJlc2hpbmcgdGhlbSBpZiB0aGV5IGFyZSBub3QgeWV0IGxvYWRlZAogICAgICogb3IgaGF2ZSBleHBpcmVkLiBVc2VycyBzaG91bGQgY2FsbCB0aGlzIG1ldGhvZCBiZWZvcmUgdXNpbmcge3JlZnJlc2h9LAogICAgICogYXMgdGhpcyB3aWxsIG5vdCBhdHRlbXB0IHRvIHJlbG9hZCBjcmVkZW50aWFscyB3aGVuIHRoZXkgYXJlIGFscmVhZHkKICAgICAqIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyBlaXRoZXIgY3JlZGVudGlhbHMKICAgICAqICAgZG8gbm90IG5lZWQgdG8gYmUgcmVmcmVzaGVkIG9yIHJlZnJlc2hlZCBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMKICAgICAqICAgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsCiAgICAgKiAgIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKi8KICAgIGdldDogZnVuY3Rpb24gZ2V0KGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHRoaXMubmVlZHNSZWZyZXNoKCkpIHsKICAgICAgICB0aGlzLnJlZnJlc2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoIWVycikgc2VsZi5leHBpcmVkID0gZmFsc2U7IC8vIHJlc2V0IGV4cGlyZWQgZmxhZwogICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhlcnIpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIGdldFByb21pc2UoKQogICAgICogICBSZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICogICBHZXRzIHRoZSBleGlzdGluZyBjcmVkZW50aWFscywgcmVmcmVzaGluZyB0aGVtIGlmIHRoZXkgYXJlIG5vdCB5ZXQgbG9hZGVkCiAgICAgKiAgIG9yIGhhdmUgZXhwaXJlZC4gVXNlcnMgc2hvdWxkIGNhbGwgdGhpcyBtZXRob2QgYmVmb3JlIHVzaW5nIHtyZWZyZXNofSwKICAgICAqICAgYXMgdGhpcyB3aWxsIG5vdCBhdHRlbXB0IHRvIHJlbG9hZCBjcmVkZW50aWFscyB3aGVuIHRoZXkgYXJlIGFscmVhZHkKICAgICAqICAgbG9hZGVkIGludG8gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKCkKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLiBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkLCBpdAogICAgICogICAgIG1lYW5zIGVpdGhlciBjcmVkZW50aWFscyBkbyBub3QgbmVlZCB0byBiZSByZWZyZXNoZWQgb3IgcmVmcmVzaGVkCiAgICAgKiAgICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlCiAgICAgKiAgICAgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGBnZXRgIGNhbGwuCiAgICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGBnZXRQcm9taXNlYCBtZXRob2QuCiAgICAgKiAgICAgdmFyIHByb21pc2UgPSBjcmVkUHJvdmlkZXIuZ2V0UHJvbWlzZSgpOwogICAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIHJlZnJlc2hQcm9taXNlKCkKICAgICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqICAgUmVmcmVzaGVzIHRoZSBjcmVkZW50aWFscy4gVXNlcnMgc2hvdWxkIGNhbGwge2dldH0gYmVmb3JlIGF0dGVtcHRpbmcKICAgICAqICAgdG8gZm9yY2libHkgcmVmcmVzaCBjcmVkZW50aWFscy4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKCkKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLiBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkLCBpdAogICAgICogICAgIG1lYW5zIHJlZnJlc2hlZCBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0CiAgICAgKiAgICAgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYHJlZnJlc2hgIGNhbGwuCiAgICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGByZWZyZXNoUHJvbWlzZWAgbWV0aG9kLgogICAgICogICAgIHZhciBwcm9taXNlID0gY3JlZFByb3ZpZGVyLnJlZnJlc2hQcm9taXNlKCk7CiAgICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgdGhlIGNyZWRlbnRpYWxzLiBVc2VycyBzaG91bGQgY2FsbCB7Z2V0fSBiZWZvcmUgYXR0ZW1wdGluZwogICAgICogdG8gZm9yY2libHkgcmVmcmVzaCBjcmVkZW50aWFscy4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHJlZnJlc2hlZAogICAgICogICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUKICAgICAqICAgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAbm90ZSBTdWJjbGFzc2VzIHNob3VsZCBvdmVycmlkZSB0aGlzIGNsYXNzIHRvIHJlc2V0IHRoZQogICAgICogICB7YWNjZXNzS2V5SWR9LCB7c2VjcmV0QWNjZXNzS2V5fSBhbmQgb3B0aW9uYWwge3Nlc3Npb25Ub2tlbn0KICAgICAqICAgb24gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCBhbmQgdGhlbiBjYWxsIHRoZSBjYWxsYmFjayB3aXRoCiAgICAgKiAgIGFueSBlcnJvciBpbmZvcm1hdGlvbi4KICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5leHBpcmVkID0gZmFsc2U7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBjb2FsZXNjZVJlZnJlc2g6IGZ1bmN0aW9uIGNvYWxlc2NlUmVmcmVzaChjYWxsYmFjaywgc3luYykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChzZWxmLnJlZnJlc2hDYWxsYmFja3MucHVzaChjYWxsYmFjaykgPT09IDEpIHsKICAgICAgICBzZWxmLmxvYWQoZnVuY3Rpb24gb25Mb2FkKGVycikgewogICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNlbGYucmVmcmVzaENhbGxiYWNrcywgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHN5bmMpIHsKICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGNhbGxiYWNrIGNvdWxkIHRocm93LCBzbyBkZWZlciB0byBlbnN1cmUgYWxsIGNhbGxiYWNrcyBhcmUgbm90aWZpZWQKICAgICAgICAgICAgICBBV1MudXRpbC5kZWZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHNlbGYucmVmcmVzaENhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxzLmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdGhpcy5wcm90b3R5cGUuZ2V0UHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgnZ2V0JywgUHJvbWlzZURlcGVuZGVuY3kpOwogICAgdGhpcy5wcm90b3R5cGUucmVmcmVzaFByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ3JlZnJlc2gnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbHMuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5nZXRQcm9taXNlOwogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnJlZnJlc2hQcm9taXNlOwogIH07CiAgCiAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLkNyZWRlbnRpYWxzKTsKICAKICB9LHsiLi9jb3JlIjoxOH1dLDIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIHtBV1MuU1RTfS4gV2l0aG91dCBhbnkKICAgKiBleHRyYSBwYXJhbWV0ZXJzLCBjcmVkZW50aWFscyB3aWxsIGJlIGZldGNoZWQgZnJvbSB0aGUKICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbi4gSWYgYW4gSUFNIHJvbGUgaXMgcHJvdmlkZWQsIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9wZXJhdGlvbiB3aWxsIGJlIHVzZWQgdG8gZmV0Y2ggY3JlZGVudGlhbHMgZm9yIHRoZQogICAqIHJvbGUgaW5zdGVhZC4KICAgKgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBkaWZmZXJzIGZyb20gQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGluCiAgICogdGhlIHdheSBtYXN0ZXJDcmVkZW50aWFscyBhbmQgcmVmcmVzaGVzIGFyZSBoYW5kbGVkLgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyByZWZyZXNoZXMgZXhwaXJlZCBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiBtYXN0ZXJDcmVkZW50aWFscyBwYXNzZWQgYnkgdGhlIHVzZXIgdG8gc3VwcG9ydCBjaGFpbmluZyBvZiBTVFMgY3JlZGVudGlhbHMuCiAgICogSG93ZXZlciwgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIHJlY3Vyc2l2ZWx5IGNvbGxhcHNlcyB0aGUgbWFzdGVyQ3JlZGVudGlhbHMKICAgKiBkdXJpbmcgaW5zdGFudGlhdGlvbiwgcHJlY2x1ZGluZyB0aGUgYWJpbGl0eSB0byByZWZyZXNoIGNyZWRlbnRpYWxzIHdoaWNoCiAgICogcmVxdWlyZSBpbnRlcm1lZGlhdGUsIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICAgKgogICAqIEZvciBleGFtcGxlLCBpZiB0aGUgYXBwbGljYXRpb24gc2hvdWxkIHVzZSBSb2xlQSwgd2hpY2ggbXVzdCBiZSBhc3N1bWVkIGZyb20KICAgKiBSb2xlQiwgYW5kIHRoZSBlbnZpcm9ubWVudCBwcm92aWRlcyBjcmVkZW50aWFscyB3aGljaCBjYW4gYXNzdW1lIFJvbGVCLCB0aGVuCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIG11c3QgYmUgdXNlZCB0byBzdXBwb3J0IHJlZnJlc2hpbmcgdGhlCiAgICogdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZvciBSb2xlQToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiB2YXIgcm9sZUFDcmVkcyA9IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgcGFyYW1zOiB7Um9sZUFybjogJ1JvbGVBJ30sCiAgICogICBtYXN0ZXJDcmVkZW50aWFsczogbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICAgIHBhcmFtczoge1JvbGVBcm46ICdSb2xlQid9LAogICAqICAgICBtYXN0ZXJDcmVkZW50aWFsczogbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKQogICAqICAgfSkKICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIElmIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBoYWQgYmVlbiB1c2VkIGluIHRoZSBwcmV2aW91cyBleGFtcGxlLAogICAqIGByb2xlQUNyZWRzYCB3b3VsZCBmYWlsIHRvIHJlZnJlc2ggYmVjYXVzZSBgcm9sZUFDcmVkc2Agd291bGQKICAgKiB1c2UgdGhlIGVudmlyb25tZW50IGNyZWRlbnRpYWxzIGZvciB0aGUgQXNzdW1lUm9sZSByZXF1ZXN0LgogICAqCiAgICogQW5vdGhlciBkaWZmZXJlbmNlIGlzIHRoYXQgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIGNyZWF0ZXMgdGhlIFNUUwogICAqIHNlcnZpY2UgaW5zdGFuY2UgZHVyaW5nIGluc3RhbnRpYXRpb24gd2hpbGUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGNyZWF0ZXMKICAgKiB0aGUgU1RTIHNlcnZpY2UgaW5zdGFuY2UgZHVyaW5nIHRoZSBmaXJzdCByZWZyZXNoLiBDcmVhdGluZyB0aGUgc2VydmljZQogICAqIGluc3RhbmNlIGR1cmluZyBpbnN0YW50aWF0aW9uIGVmZmVjdGl2ZWx5IGNhcHR1cmVzIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgKiBmcm9tIHRoZSBnbG9iYWwgY29uZmlnLCBzbyB0aGF0IHN1YnNlcXVlbnQgY2hhbmdlcyB0byB0aGUgZ2xvYmFsIGNvbmZpZyBkbwogICAqIG5vdCBhZmZlY3QgdGhlIG1hc3RlciBjcmVkZW50aWFscyB1c2VkIHRvIHJlZnJlc2ggdGhlIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICAgKgogICAqIFRoaXMgYWxsb3dzIGFuIGluc3RhbmNlIG9mIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyB0byBiZSBhc3NpZ25lZAogICAqIHRvIEFXUy5jb25maWcuY3JlZGVudGlhbHM6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGVudkNyZWRzID0gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gZW52Q3JlZHM7CiAgICogLy8gbWFzdGVyQ3JlZGVudGlhbHMgd2lsbCBiZSBlbnZDcmVkcwogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgIHBhcmFtczoge1JvbGVBcm46ICcuLi4nfQogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogU2ltaWxhcmx5LCB0byB1c2UgdGhlIENyZWRlbnRpYWxQcm92aWRlckNoYWluJ3MgZGVmYXVsdCBwcm92aWRlcnMgYXMgdGhlCiAgICogbWFzdGVyIGNyZWRlbnRpYWxzLCBzaW1wbHkgY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mCiAgICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgcGFyYW1zOiB7Um9sZUFybjogJy4uLid9CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzZXJ2aWNlCiAgICogICBAcmV0dXJuIFtBV1MuU1RTXSB0aGUgU1RTIHNlcnZpY2UgaW5zdGFuY2UgdXNlZCB0bwogICAqICAgICBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBAbm90ZSAoc2VlIGNvbnN0cnVjdG9yKQogICAqLwogIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gb3B0aW9ucyBbbWFwXSBhIHNldCBvZiBvcHRpb25zCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcGFyYW1zIFttYXBdICh7fSkgYSBtYXAgb2Ygb3B0aW9ucyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhlCiAgICAgKiAgIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9ucy4KICAgICAqICAgSWYgYSBgUm9sZUFybmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwgY3JlZGVudGlhbHMgd2lsbCBiZSBiYXNlZCBvbiB0aGUKICAgICAqICAgSUFNIHJvbGUuIElmIGEgYFNlcmlhbE51bWJlcmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwge3Rva2VuQ29kZUZufSBtdXN0CiAgICAgKiAgIGFsc28gYmUgcGFzc2VkIGluIG9yIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duLgogICAgICogQG9wdGlvbiBvcHRpb25zIG1hc3RlckNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMKICAgICAqICAgdXNlZCB0byBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4gQnkgZGVmYXVsdCwKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyBvciBBV1MuY29uZmlnLmNyZWRlbnRpYWxQcm92aWRlciB3aWxsIGJlIHVzZWQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgdG9rZW5Db2RlRm4gW0Z1bmN0aW9uXSAobnVsbCkgRnVuY3Rpb24gdG8gcHJvdmlkZQogICAgICogICBgVG9rZW5Db2RlYCwgaWYgYFNlcmlhbE51bWJlcmAgaXMgcHJvdmlkZWQgZm9yIHByb2ZpbGUgaW4ge3BhcmFtc30uIEZ1bmN0aW9uCiAgICAgKiAgIGlzIGNhbGxlZCB3aXRoIHZhbHVlIG9mIGBTZXJpYWxOdW1iZXJgIGFuZCBgY2FsbGJhY2tgLCBhbmQgc2hvdWxkIHByb3ZpZGUKICAgICAqICAgdGhlIGBUb2tlbkNvZGVgIG9yIGFuIGVycm9yIHRvIHRoZSBjYWxsYmFjayBpbiB0aGUgZm9ybWF0CiAgICAgKiAgIGBjYWxsYmFjayhlcnIsIHRva2VuKWAuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGdlbmVyaWMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGFuIElBTSByb2xlCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgICAqICAgICBwYXJhbXM6IHsKICAgICAqICAgICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1RlbXBvcmFyeUNyZWRlbnRpYWxzJwogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZQogICAgICogQHNlZSBBV1MuU1RTLmdldFNlc3Npb25Ub2tlbgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMob3B0aW9ucykgewogICAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHRoaXMuZXJyb3JDb2RlID0gJ0NoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzUHJvdmlkZXJGYWlsdXJlJzsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgICAgdGhpcy50b2tlbkNvZGVGbiA9IG51bGw7CiAgCiAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KG9wdGlvbnMucGFyYW1zKSB8fCB7fTsKICAgICAgaWYgKHBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgICAgcGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9IHBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3RlbXBvcmFyeS1jcmVkZW50aWFscyc7CiAgICAgIH0KICAgICAgaWYgKHBhcmFtcy5TZXJpYWxOdW1iZXIpIHsKICAgICAgICBpZiAoIW9wdGlvbnMudG9rZW5Db2RlRm4gfHwgKHR5cGVvZiBvcHRpb25zLnRva2VuQ29kZUZuICE9PSAnZnVuY3Rpb24nKSkgewogICAgICAgICAgdGhyb3cgbmV3IEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICBuZXcgRXJyb3IoJ3Rva2VuQ29kZUZuIG11c3QgYmUgYSBmdW5jdGlvbiB3aGVuIHBhcmFtcy5TZXJpYWxOdW1iZXIgaXMgZ2l2ZW4nKSwKICAgICAgICAgICAge2NvZGU6IHRoaXMuZXJyb3JDb2RlfQogICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50b2tlbkNvZGVGbiA9IG9wdGlvbnMudG9rZW5Db2RlRm47CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBjb25maWcgPSBBV1MudXRpbC5tZXJnZSgKICAgICAgICB7CiAgICAgICAgICBwYXJhbXM6IHBhcmFtcywKICAgICAgICAgIGNyZWRlbnRpYWxzOiBvcHRpb25zLm1hc3RlckNyZWRlbnRpYWxzIHx8IEFXUy5jb25maWcuY3JlZGVudGlhbHMKICAgICAgICB9LAogICAgICAgIG9wdGlvbnMuc3RzQ29uZmlnIHx8IHt9CiAgICAgICk7CiAgICAgIHRoaXMuc2VydmljZSA9IG5ldyBTVFMoY29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcgogICAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSwgZGVwZW5kaW5nIG9uIHdoZXRoZXIgYW4gSUFNIHJvbGUgQVJOIHdhcyBwYXNzZWQKICAgICAqIHRvIHRoZSBjcmVkZW50aWFscyB7Y29uc3RydWN0b3J9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgQVdTLkNyZWRlbnRpYWxzLmdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogQHBhcmFtIGNhbGxiYWNrCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb3BlcmF0aW9uID0gc2VsZi5zZXJ2aWNlLmNvbmZpZy5wYXJhbXMuUm9sZUFybiA/ICdhc3N1bWVSb2xlJyA6ICdnZXRTZXNzaW9uVG9rZW4nOwogICAgICB0aGlzLmdldFRva2VuQ29kZShmdW5jdGlvbiAoZXJyLCB0b2tlbkNvZGUpIHsKICAgICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRva2VuQ29kZSkgewogICAgICAgICAgcGFyYW1zLlRva2VuQ29kZSA9IHRva2VuQ29kZTsKICAgICAgICB9CiAgICAgICAgc2VsZi5zZXJ2aWNlW29wZXJhdGlvbl0ocGFyYW1zLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0VG9rZW5Db2RlOiBmdW5jdGlvbiBnZXRUb2tlbkNvZGUoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodGhpcy50b2tlbkNvZGVGbikgewogICAgICAgIHRoaXMudG9rZW5Db2RlRm4odGhpcy5zZXJ2aWNlLmNvbmZpZy5wYXJhbXMuU2VyaWFsTnVtYmVyLCBmdW5jdGlvbiAoZXJyLCB0b2tlbikgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGVycjsKICAgICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrKAogICAgICAgICAgICAgIEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICAgICAgbmV3IEVycm9yKCdFcnJvciBmZXRjaGluZyBNRkEgdG9rZW46ICcgKyBtZXNzYWdlKSwKICAgICAgICAgICAgICAgIHsgY29kZTogc2VsZi5lcnJvckNvZGV9CiAgICAgICAgICAgICAgKQogICAgICAgICAgICApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayhudWxsLCB0b2tlbik7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sobnVsbCk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIENvZ25pdG9JZGVudGl0eSA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvY29nbml0b2lkZW50aXR5Jyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgV2ViIElkZW50aXR5IEZlZGVyYXRpb24gdXNpbmcKICAgKiB0aGUgQW1hem9uIENvZ25pdG8gSWRlbnRpdHkgc2VydmljZS4KICAgKgogICAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLCB3aGljaAogICAqIHJlcXVpcmVzIGVpdGhlciBhbiBgSWRlbnRpdHlJZGAgb3IgYW4gYElkZW50aXR5UG9vbElkYCAoQW1hem9uIENvZ25pdG8KICAgKiBJZGVudGl0eSBQb29sIElEKSwgd2hpY2ggaXMgdXNlZCB0byBjYWxsIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldElkfSB0bwogICAqIG9idGFpbiBhbiBgSWRlbnRpdHlJZGAuIElmIHRoZSBpZGVudGl0eSBvciBpZGVudGl0eSBwb29sIGlzIG5vdCBjb25maWd1cmVkIGluCiAgICogdGhlIEFtYXpvbiBDb2duaXRvIENvbnNvbGUgdG8gdXNlIElBTSByb2xlcyB3aXRoIHRoZSBhcHByb3ByaWF0ZSBwZXJtaXNzaW9ucywKICAgKiB0aGVuIGFkZGl0aW9uYWxseSBhIGBSb2xlQXJuYCBpcyByZXF1aXJlZCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdAogICAqIHBvbGljeSBmb3IgdGhlIEFtYXpvbiBDb2duaXRvIHJvbGUgdGhhdCB0aGUgdXNlciB3aWxsIGxvZyBpbnRvLiBJZiBhIGBSb2xlQXJuYAogICAqIGlzIHByb3ZpZGVkLCB0aGVuIHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbiwgYWZ0ZXIgZmlyc3QgZ2V0dGluZyBhbgogICAqIE9wZW4gSUQgdG9rZW4gZnJvbSB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0uCiAgICoKICAgKiBJbiBhZGRpdGlvbiwgaWYgdGhpcyBjcmVkZW50aWFsIHByb3ZpZGVyIGlzIHVzZWQgdG8gcHJvdmlkZSBhdXRoZW50aWNhdGVkCiAgICogbG9naW4sIHRoZSBgTG9naW5zYCBtYXAgbWF5IGJlIHNldCB0byB0aGUgdG9rZW5zIHByb3ZpZGVkIGJ5IHRoZSByZXNwZWN0aXZlCiAgICogaWRlbnRpdHkgcHJvdmlkZXJzLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAgICogb2JqZWN0IHdpdGggcHJvcGVyIHByb3BlcnR5IHZhbHVlcy4KICAgKgogICAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAgICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAgICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogICAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICAgKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAgICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICAgKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAgICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAgICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgV2ViSWRlbnRpdHlUb2tlbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICAgKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5Mb2dpbnNbJ2dyYXBoLmZhY2Vib29rLmNvbSddID0gdXBkYXRlZFRva2VuOwogICAqIGBgYAogICAqCiAgICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZH0sCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufSwgYW5kCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAgICogICAgIGBwYXJhbXMuV2ViSWRlbnRpdHlUb2tlbmAgcHJvcGVydHkuCiAgICogQCFhdHRyaWJ1dGUgZGF0YQogICAqICAgQHJldHVybiBbbWFwXSB0aGUgcmF3IGRhdGEgcmVzcG9uc2UgZnJvbSB0aGUgY2FsbCB0bwogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSwgb3IKICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFVzZSB0aGlzIGlmIHlvdSB3YW50IHRvIGdldAogICAqICAgICBhY2Nlc3MgdG8gb3RoZXIgcHJvcGVydGllcyBmcm9tIHRoZSByZXNwb25zZS4KICAgKiBAIWF0dHJpYnV0ZSBpZGVudGl0eUlkCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBDb2duaXRvIElEIHJldHVybmVkIGJ5IHRoZSBsYXN0IGNhbGwgdG8KICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LiBUaGlzIElEIHJlcHJlc2VudHMgdGhlIGFjdHVhbAogICAqICAgICBmaW5hbCByZXNvbHZlZCBpZGVudGl0eSBJRCBmcm9tIEFtYXpvbiBDb2duaXRvLgogICAqLwogIEFXUy5Db2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2NhbFN0b3JhZ2VLZXk6IHsKICAgICAgaWQ6ICdhd3MuY29nbml0by5pZGVudGl0eS1pZC4nLAogICAgICBwcm92aWRlcnM6ICdhd3MuY29nbml0by5pZGVudGl0eS1wcm92aWRlcnMuJwogICAgfSwKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMoewogICAgICoKICAgICAqICAgICAvLyBlaXRoZXIgSWRlbnRpdHlQb29sSWQgb3IgSWRlbnRpdHlJZCBpcyByZXF1aXJlZAogICAgICogICAgIC8vIFNlZSB0aGUgSWRlbnRpdHlQb29sSWQgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SUQgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICAvLyBTZWUgdGhlIElkZW50aXR5SWQgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eQogICAgICogICAgIC8vIG9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW4gKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBJZGVudGl0eVBvb2xJZDogJ3VzLWVhc3QtMToxNjk5ZWJjMC03OTAwLTQwOTktYjkxMC0yZGY5NGY1MmEwMzAnLAogICAgICogICAgIElkZW50aXR5SWQ6ICd1cy1lYXN0LTE6MTI4ZDBhNzQtYzgyZi00NTUzLTkxNmQtOTAwNTNlNGE4YjBmJwogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCwgb25seSBuZWNlc3Nhcnkgd2hlbiB0aGUgaWRlbnRpdHkgcG9vbCBpcyBub3QgY29uZmlndXJlZAogICAgICogICAgIC8vIHRvIHVzZSBJQU0gcm9sZXMgaW4gdGhlIEFtYXpvbiBDb2duaXRvIENvbnNvbGUKICAgICAqICAgICAvLyBTZWUgdGhlIFJvbGVBcm4gcGFyYW0gZm9yIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSAobGlua2VkIGJlbG93KQogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL01ZQVBQLUNvZ25pdG9JZGVudGl0eScsCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsIHRva2VucywgdXNlZCBmb3IgYXV0aGVudGljYXRlZCBsb2dpbgogICAgICogICAgIC8vIFNlZSB0aGUgTG9naW5zIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldElEIChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgTG9naW5zOiB7CiAgICAgKiAgICAgICAnZ3JhcGguZmFjZWJvb2suY29tJzogJ0ZCVE9LRU4nLAogICAgICogICAgICAgJ3d3dy5hbWF6b24uY29tJzogJ0FNQVpPTlRPS0VOJywKICAgICAqICAgICAgICdhY2NvdW50cy5nb29nbGUuY29tJzogJ0dPT0dMRVRPS0VOJywKICAgICAqICAgICAgICdhcGkudHdpdHRlci5jb20nOiAnVFdJVFRFUlRPS0VOJywKICAgICAqICAgICAgICd3d3cuZGlnaXRzLmNvbSc6ICdESUdJVFNUT0tFTicKICAgICAqICAgICB9LAogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCBuYW1lLCBkZWZhdWx0cyB0byB3ZWItaWRlbnRpdHkKICAgICAqICAgICAvLyBTZWUgdGhlIFJvbGVTZXNzaW9uTmFtZSBwYXJhbSBmb3IgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgUm9sZVNlc3Npb25OYW1lOiAnd2ViJywKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwsIG9ubHkgbmVjZXNzYXJ5IHdoZW4gYXBwbGljYXRpb24gcnVucyBpbiBhIGJyb3dzZXIKICAgICAqICAgICAvLyBhbmQgbXVsdGlwbGUgdXNlcnMgYXJlIHNpZ25lZCBpbiBhdCBvbmNlLCB1c2VkIGZvciBjYWNoaW5nCiAgICAgKiAgICAgTG9naW5JZDogJ2V4YW1wbGVAZ21haWwuY29tJwogICAgICoKICAgICAqICAgfSwgewogICAgICogICAgICAvLyBvcHRpb25hbGx5IHByb3ZpZGUgY29uZmlndXJhdGlvbiB0byBhcHBseSB0byB0aGUgdW5kZXJseWluZyBzZXJ2aWNlIGNsaWVudHMKICAgICAqICAgICAgLy8gaWYgY29uZmlndXJhdGlvbiBpcyBub3QgcHJvdmlkZWQsIHRoZW4gY29uZmlndXJhdGlvbiB3aWxsIGJlIHB1bGxlZCBmcm9tIEFXUy5jb25maWcKICAgICAqCiAgICAgKiAgICAgIC8vIHJlZ2lvbiBzaG91bGQgbWF0Y2ggdGhlIHJlZ2lvbiB5b3VyIGlkZW50aXR5IHBvb2wgaXMgbG9jYXRlZCBpbgogICAgICogICAgICByZWdpb246ICd1cy1lYXN0LTEnLAogICAgICoKICAgICAqICAgICAgLy8gc3BlY2lmeSB0aW1lb3V0IG9wdGlvbnMKICAgICAqICAgICAgaHR0cE9wdGlvbnM6IHsKICAgICAqICAgICAgICB0aW1lb3V0OiAxMDAKICAgICAqICAgICAgfQogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZAogICAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5CiAgICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW4KICAgICAqIEBzZWUgQVdTLkNvbmZpZwogICAgICogQG5vdGUgSWYgYSByZWdpb24gaXMgbm90IHByb3ZpZGVkIGluIHRoZSBnbG9iYWwgQVdTLmNvbmZpZywgb3IKICAgICAqICAgc3BlY2lmaWVkIGluIHRoZSBgY2xpZW50Q29uZmlnYCB0byB0aGUgQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMKICAgICAqICAgY29uc3RydWN0b3IsIHlvdSBtYXkgZW5jb3VudGVyIGEgJ01pc3NpbmcgY3JlZGVudGlhbHMgaW4gY29uZmlnJyBlcnJvcgogICAgICogICB3aGVuIGNhbGxpbmcgbWFraW5nIGEgc2VydmljZSBjYWxsLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMocGFyYW1zLCBjbGllbnRDb25maWcpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgICB0aGlzLl9pZGVudGl0eUlkID0gbnVsbDsKICAgICAgdGhpcy5fY2xpZW50Q29uZmlnID0gQVdTLnV0aWwuY29weShjbGllbnRDb25maWcgfHwge30pOwogICAgICB0aGlzLmxvYWRDYWNoZWRJZCgpOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnaWRlbnRpdHlJZCcsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5sb2FkQ2FjaGVkSWQoKTsKICAgICAgICAgIHJldHVybiBzZWxmLl9pZGVudGl0eUlkIHx8IHNlbGYucGFyYW1zLklkZW50aXR5SWQ7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKGlkZW50aXR5SWQpIHsKICAgICAgICAgIHNlbGYuX2lkZW50aXR5SWQgPSBpZGVudGl0eUlkOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0sCiAgICAgKiBvciB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIEFXUy5DcmVkZW50aWFscy5nZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYuZGF0YSA9IG51bGw7CiAgICAgIHNlbGYuX2lkZW50aXR5SWQgPSBudWxsOwogICAgICBzZWxmLmdldElkKGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBpZiAoIXNlbGYucGFyYW1zLlJvbGVBcm4pIHsKICAgICAgICAgICAgc2VsZi5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGNhbGxiYWNrKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuZ2V0Q3JlZGVudGlhbHNGcm9tU1RTKGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5jbGVhcklkT25Ob3RBdXRob3JpemVkKGVycik7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDbGVhcnMgdGhlIGNhY2hlZCBDb2duaXRvIElEIGFzc29jaWF0ZWQgd2l0aCB0aGUgY3VycmVudGx5IGNvbmZpZ3VyZWQKICAgICAqIGlkZW50aXR5IHBvb2wgSUQuIFVzZSB0aGlzIHRvIG1hbnVhbGx5IGludmFsaWRhdGUgeW91ciBjYWNoZSBpZgogICAgICogdGhlIGlkZW50aXR5IHBvb2wgSUQgd2FzIGRlbGV0ZWQuCiAgICAgKi8KICAgIGNsZWFyQ2FjaGVkSWQ6IGZ1bmN0aW9uIGNsZWFyQ2FjaGUoKSB7CiAgICAgIHRoaXMuX2lkZW50aXR5SWQgPSBudWxsOwogICAgICBkZWxldGUgdGhpcy5wYXJhbXMuSWRlbnRpdHlJZDsKICAKICAgICAgdmFyIHBvb2xJZCA9IHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkOwogICAgICB2YXIgbG9naW5JZCA9IHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJyc7CiAgICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXkuaWQgKyBwb29sSWQgKyBsb2dpbklkXTsKICAgICAgZGVsZXRlIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleS5wcm92aWRlcnMgKyBwb29sSWQgKyBsb2dpbklkXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjbGVhcklkT25Ob3RBdXRob3JpemVkOiBmdW5jdGlvbiBjbGVhcklkT25Ob3RBdXRob3JpemVkKGVycikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChlcnIuY29kZSA9PSAnTm90QXV0aG9yaXplZEV4Y2VwdGlvbicpIHsKICAgICAgICBzZWxmLmNsZWFyQ2FjaGVkSWQoKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogUmV0cmlldmVzIGEgQ29nbml0byBJRCwgbG9hZGluZyBmcm9tIGNhY2hlIGlmIGl0IHdhcyBhbHJlYWR5IHJldHJpZXZlZAogICAgICogb24gdGhpcyBkZXZpY2UuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgaWRlbnRpdHlJZCkKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3IsIG51bGxdIGFuIGVycm9yIG9iamVjdCBpZiB0aGUgY2FsbCBmYWlsZWQgb3IgbnVsbCBpZgogICAgICogICAgIGl0IHN1Y2NlZWRlZC4KICAgICAqICAgQHBhcmFtIGlkZW50aXR5SWQgW1N0cmluZywgbnVsbF0gaWYgc3VjY2Vzc2Z1bCwgdGhlIGNhbGxiYWNrIHdpbGwgcmV0dXJuCiAgICAgKiAgICAgdGhlIENvZ25pdG8gSUQuCiAgICAgKiBAbm90ZSBJZiBub3QgbG9hZGVkIGV4cGxpY2l0bHksIHRoZSBDb2duaXRvIElEIGlzIGxvYWRlZCBhbmQgc3RvcmVkIGluCiAgICAgKiAgIGxvY2FsU3RvcmFnZSBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvZiBhIGRldmljZS4KICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRJZDogZnVuY3Rpb24gZ2V0SWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAodHlwZW9mIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHNlbGYucGFyYW1zLklkZW50aXR5SWQpOwogICAgICB9CiAgCiAgICAgIHNlbGYuY29nbml0by5nZXRJZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVyciAmJiBkYXRhLklkZW50aXR5SWQpIHsKICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBkYXRhLklkZW50aXR5SWQ7CiAgICAgICAgICBjYWxsYmFjayhudWxsLCBkYXRhLklkZW50aXR5SWQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZENyZWRlbnRpYWxzOiBmdW5jdGlvbiBsb2FkQ3JlZGVudGlhbHMoZGF0YSwgY3JlZGVudGlhbHMpIHsKICAgICAgaWYgKCFkYXRhIHx8ICFjcmVkZW50aWFscykgcmV0dXJuOwogICAgICBjcmVkZW50aWFscy5leHBpcmVkID0gZmFsc2U7CiAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkID0gZGF0YS5DcmVkZW50aWFscy5BY2Nlc3NLZXlJZDsKICAgICAgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ID0gZGF0YS5DcmVkZW50aWFscy5TZWNyZXRLZXk7CiAgICAgIGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbiA9IGRhdGEuQ3JlZGVudGlhbHMuU2Vzc2lvblRva2VuOwogICAgICBjcmVkZW50aWFscy5leHBpcmVUaW1lID0gZGF0YS5DcmVkZW50aWFscy5FeHBpcmF0aW9uOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHk6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNvZ25pdG8uZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5jYWNoZUlkKGRhdGEpOwogICAgICAgICAgc2VsZi5kYXRhID0gZGF0YTsKICAgICAgICAgIHNlbGYubG9hZENyZWRlbnRpYWxzKHNlbGYuZGF0YSwgc2VsZik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRDcmVkZW50aWFsc0Zyb21TVFM6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRnJvbVNUUyhjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY29nbml0by5nZXRPcGVuSWRUb2tlbihmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5jYWNoZUlkKGRhdGEpOwogICAgICAgICAgc2VsZi5wYXJhbXMuV2ViSWRlbnRpdHlUb2tlbiA9IGRhdGEuVG9rZW47CiAgICAgICAgICBzZWxmLndlYklkZW50aXR5Q3JlZGVudGlhbHMucmVmcmVzaChmdW5jdGlvbih3ZWJFcnIpIHsKICAgICAgICAgICAgaWYgKCF3ZWJFcnIpIHsKICAgICAgICAgICAgICBzZWxmLmRhdGEgPSBzZWxmLndlYklkZW50aXR5Q3JlZGVudGlhbHMuZGF0YTsKICAgICAgICAgICAgICBzZWxmLnN0cy5jcmVkZW50aWFsc0Zyb20oc2VsZi5kYXRhLCBzZWxmKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjayh3ZWJFcnIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRDYWNoZWRJZDogZnVuY3Rpb24gbG9hZENhY2hlZElkKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICAgIC8vIGluIHRoZSBicm93c2VyIHdlIHNvdXJjZSBkZWZhdWx0IElkZW50aXR5SWQgZnJvbSBsb2NhbFN0b3JhZ2UKICAgICAgaWYgKEFXUy51dGlsLmlzQnJvd3NlcigpICYmICFzZWxmLnBhcmFtcy5JZGVudGl0eUlkKSB7CiAgICAgICAgdmFyIGlkID0gc2VsZi5nZXRTdG9yYWdlKCdpZCcpOwogICAgICAgIGlmIChpZCAmJiBzZWxmLnBhcmFtcy5Mb2dpbnMpIHsKICAgICAgICAgIHZhciBhY3R1YWxQcm92aWRlcnMgPSBPYmplY3Qua2V5cyhzZWxmLnBhcmFtcy5Mb2dpbnMpOwogICAgICAgICAgdmFyIGNhY2hlZFByb3ZpZGVycyA9CiAgICAgICAgICAgIChzZWxmLmdldFN0b3JhZ2UoJ3Byb3ZpZGVycycpIHx8ICcnKS5zcGxpdCgnLCcpOwogIAogICAgICAgICAgLy8gb25seSBsb2FkIElEIGlmIGF0IGxlYXN0IG9uZSBwcm92aWRlciB1c2VkIHRoaXMgSUQgYmVmb3JlCiAgICAgICAgICB2YXIgaW50ZXJzZWN0ID0gY2FjaGVkUHJvdmlkZXJzLmZpbHRlcihmdW5jdGlvbihuKSB7CiAgICAgICAgICAgIHJldHVybiBhY3R1YWxQcm92aWRlcnMuaW5kZXhPZihuKSAhPT0gLTE7CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChpbnRlcnNlY3QubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIHNlbGYucGFyYW1zLklkZW50aXR5SWQgPSBpZDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGlkKSB7CiAgICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gaWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjbGllbnRDb25maWcgPSB0aGlzLl9jbGllbnRDb25maWc7CiAgICAgIHRoaXMud2ViSWRlbnRpdHlDcmVkZW50aWFscyA9IHRoaXMud2ViSWRlbnRpdHlDcmVkZW50aWFscyB8fAogICAgICAgIG5ldyBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyh0aGlzLnBhcmFtcywgY2xpZW50Q29uZmlnKTsKICAgICAgaWYgKCF0aGlzLmNvZ25pdG8pIHsKICAgICAgICB2YXIgY29nbml0b0NvbmZpZyA9IEFXUy51dGlsLm1lcmdlKHt9LCBjbGllbnRDb25maWcpOwogICAgICAgIGNvZ25pdG9Db25maWcucGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICAgICAgdGhpcy5jb2duaXRvID0gbmV3IENvZ25pdG9JZGVudGl0eShjb2duaXRvQ29uZmlnKTsKICAgICAgfQogICAgICB0aGlzLnN0cyA9IHRoaXMuc3RzIHx8IG5ldyBTVFMoY2xpZW50Q29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWNoZUlkOiBmdW5jdGlvbiBjYWNoZUlkKGRhdGEpIHsKICAgICAgdGhpcy5faWRlbnRpdHlJZCA9IGRhdGEuSWRlbnRpdHlJZDsKICAgICAgdGhpcy5wYXJhbXMuSWRlbnRpdHlJZCA9IHRoaXMuX2lkZW50aXR5SWQ7CiAgCiAgICAgIC8vIGNhY2hlIHRoaXMgSWRlbnRpdHlJZCBpbiBicm93c2VyIGxvY2FsU3RvcmFnZSBpZiBwb3NzaWJsZQogICAgICBpZiAoQVdTLnV0aWwuaXNCcm93c2VyKCkpIHsKICAgICAgICB0aGlzLnNldFN0b3JhZ2UoJ2lkJywgZGF0YS5JZGVudGl0eUlkKTsKICAKICAgICAgICBpZiAodGhpcy5wYXJhbXMuTG9naW5zKSB7CiAgICAgICAgICB0aGlzLnNldFN0b3JhZ2UoJ3Byb3ZpZGVycycsIE9iamVjdC5rZXlzKHRoaXMucGFyYW1zLkxvZ2lucykuam9pbignLCcpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTdG9yYWdlOiBmdW5jdGlvbiBnZXRTdG9yYWdlKGtleSkgewogICAgICByZXR1cm4gdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5W2tleV0gKyB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZCArICh0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnKV07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0U3RvcmFnZTogZnVuY3Rpb24gc2V0U3RvcmFnZShrZXksIHZhbCkgewogICAgICB0cnkgewogICAgICAgIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleVtrZXldICsgdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQgKyAodGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJyldID0gdmFsOwogICAgICB9IGNhdGNoIChfKSB7fQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHN0b3JhZ2U6IChmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgc3RvcmFnZSA9IEFXUy51dGlsLmlzQnJvd3NlcigpICYmIHdpbmRvdy5sb2NhbFN0b3JhZ2UgIT09IG51bGwgJiYgdHlwZW9mIHdpbmRvdy5sb2NhbFN0b3JhZ2UgPT09ICdvYmplY3QnID8KICAgICAgICAgICAgd2luZG93LmxvY2FsU3RvcmFnZSA6IHt9OwogIAogICAgICAgIC8vIFRlc3Qgc2V0L3JlbW92ZSB3aGljaCB3b3VsZCB0aHJvdyBhbiBlcnJvciBpbiBTYWZhcmkncyBwcml2YXRlIGJyb3dzaW5nCiAgICAgICAgc3RvcmFnZVsnYXdzLnRlc3Qtc3RvcmFnZSddID0gJ2Zvb2Jhcic7CiAgICAgICAgZGVsZXRlIHN0b3JhZ2VbJ2F3cy50ZXN0LXN0b3JhZ2UnXTsKICAKICAgICAgICByZXR1cm4gc3RvcmFnZTsKICAgICAgfSBjYXRjaCAoXykgewogICAgICAgIHJldHVybiB7fTsKICAgICAgfQogICAgfSkoKQogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL2NvZ25pdG9pZGVudGl0eSI6NywiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQ3JlYXRlcyBhIGNyZWRlbnRpYWwgcHJvdmlkZXIgY2hhaW4gdGhhdCBzZWFyY2hlcyBmb3IgQVdTIGNyZWRlbnRpYWxzCiAgICogaW4gYSBsaXN0IG9mIGNyZWRlbnRpYWwgcHJvdmlkZXJzIHNwZWNpZmllZCBieSB0aGUge3Byb3ZpZGVyc30gcHJvcGVydHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCB0aGUgY2hhaW4gd2lsbCB1c2UgdGhlIHtkZWZhdWx0UHJvdmlkZXJzfSB0byByZXNvbHZlIGNyZWRlbnRpYWxzLgogICAqIFRoZXNlIHByb3ZpZGVycyB3aWxsIGxvb2sgaW4gdGhlIGVudmlyb25tZW50IHVzaW5nIHRoZQogICAqIHtBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFsc30gY2xhc3Mgd2l0aCB0aGUgJ0FXUycgYW5kICdBTUFaT04nIHByZWZpeGVzLgogICAqCiAgICogIyMgU2V0dGluZyBQcm92aWRlcnMKICAgKgogICAqIEVhY2ggcHJvdmlkZXIgaW4gdGhlIHtwcm92aWRlcnN9IGxpc3Qgc2hvdWxkIGJlIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAgICogYSB7QVdTLkNyZWRlbnRpYWxzfSBvYmplY3QsIG9yIGEgaGFyZGNvZGVkIGNyZWRlbnRpYWxzIG9iamVjdC4gVGhlIGZ1bmN0aW9uCiAgICogZm9ybSBhbGxvd3MgZm9yIGRlbGF5ZWQgZXhlY3V0aW9uIG9mIHRoZSBjcmVkZW50aWFsIGNvbnN0cnVjdGlvbi4KICAgKgogICAqICMjIFJlc29sdmluZyBDcmVkZW50aWFscyBmcm9tIGEgQ2hhaW4KICAgKgogICAqIENhbGwge3Jlc29sdmV9IHRvIHJldHVybiB0aGUgZmlyc3QgdmFsaWQgY3JlZGVudGlhbCBvYmplY3QgdGhhdCBjYW4gYmUKICAgKiBsb2FkZWQgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAqCiAgICogRm9yIGV4YW1wbGUsIHRvIHJlc29sdmUgYSBjaGFpbiB3aXRoIGEgY3VzdG9tIHByb3ZpZGVyIHRoYXQgY2hlY2tzIGEgZmlsZQogICAqIG9uIGRpc2sgYWZ0ZXIgdGhlIHNldCBvZiB7ZGVmYXVsdFByb3ZpZGVyc306CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGRpc2tQcm92aWRlciA9IG5ldyBBV1MuRmlsZVN5c3RlbUNyZWRlbnRpYWxzKCcuL2NyZWRzLmpzb24nKTsKICAgKiB2YXIgY2hhaW4gPSBuZXcgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKCk7CiAgICogY2hhaW4ucHJvdmlkZXJzLnB1c2goZGlza1Byb3ZpZGVyKTsKICAgKiBjaGFpbi5yZXNvbHZlKCk7CiAgICogYGBgCiAgICoKICAgKiBUaGUgYWJvdmUgY29kZSB3aWxsIHJldHVybiB0aGUgYGRpc2tQcm92aWRlcmAgb2JqZWN0IGlmIHRoZQogICAqIGZpbGUgY29udGFpbnMgY3JlZGVudGlhbHMgYW5kIHRoZSBgZGVmYXVsdFByb3ZpZGVyc2AgZG8gbm90IGNvbnRhaW4KICAgKiBhbnkgY3JlZGVudGlhbCBzZXR0aW5ncy4KICAgKgogICAqIEAhYXR0cmlidXRlIHByb3ZpZGVycwogICAqICAgQHJldHVybiBbQXJyYXk8QVdTLkNyZWRlbnRpYWxzLCBGdW5jdGlvbj5dCiAgICogICAgIGEgbGlzdCBvZiBjcmVkZW50aWFscyBvYmplY3RzIG9yIGZ1bmN0aW9ucyB0aGF0IHJldHVybiBjcmVkZW50aWFscwogICAqICAgICBvYmplY3RzLiBJZiB0aGUgcHJvdmlkZXIgaXMgYSBmdW5jdGlvbiwgdGhlIGZ1bmN0aW9uIHdpbGwgYmUKICAgKiAgICAgZXhlY3V0ZWQgbGF6aWx5IHdoZW4gdGhlIHByb3ZpZGVyIG5lZWRzIHRvIGJlIGNoZWNrZWQgZm9yIHZhbGlkCiAgICogICAgIGNyZWRlbnRpYWxzLiBCeSBkZWZhdWx0LCB0aGlzIG9iamVjdCB3aWxsIGJlIHNldCB0byB0aGUKICAgKiAgICAge2RlZmF1bHRQcm92aWRlcnN9LgogICAqICAgQHNlZSBkZWZhdWx0UHJvdmlkZXJzCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbiB3aXRoIGEgZGVmYXVsdCBzZXQgb2YgcHJvdmlkZXJzCiAgICAgKiBzcGVjaWZpZWQgYnkge2RlZmF1bHRQcm92aWRlcnN9LgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4ocHJvdmlkZXJzKSB7CiAgICAgIGlmIChwcm92aWRlcnMpIHsKICAgICAgICB0aGlzLnByb3ZpZGVycyA9IHByb3ZpZGVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnByb3ZpZGVycyA9IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzLnNsaWNlKDApOwogICAgICB9CiAgICAgIHRoaXMucmVzb2x2ZUNhbGxiYWNrcyA9IFtdOwogICAgfSwKICAKICAgIC8qKgogICAgICogQCFtZXRob2QgIHJlc29sdmVQcm9taXNlKCkKICAgICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqICAgUmVzb2x2ZXMgdGhlIHByb3ZpZGVyIGNoYWluIGJ5IHNlYXJjaGluZyBmb3IgdGhlIGZpcnN0IHNldCBvZgogICAgICogICBjcmVkZW50aWFscyBpbiB7cHJvdmlkZXJzfS4KICAgICAqCiAgICAgKiAgIFR3byBjYWxsYmFja3MgY2FuIGJlIHByb3ZpZGVkIHRvIHRoZSBgdGhlbmAgbWV0aG9kIG9uIHRoZSByZXR1cm5lZCBwcm9taXNlLgogICAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgQGNhbGxiYWNrIGZ1bGZpbGxlZENhbGxiYWNrIGZ1bmN0aW9uKGNyZWRlbnRpYWxzKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQgYW5kIHRoZSBwcm92aWRlciByZXNvbHZlcyB0aGUgY2hhaW4KICAgICAqICAgICB0byBhIGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHJlc29sdmVkCiAgICAgKiAgICAgICBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBpZiBubyBjcmVkZW50aWFscyBhcmUgZm91bmQuCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgcmVzb2x2ZWAgbWV0aG9kIGNhbGwuCiAgICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGByZXNvbHZlUHJvbWlzZWAgbWV0aG9kLgogICAgICogICAgIHZhciBwcm9taXNlID0gY2hhaW4ucmVzb2x2ZVByb21pc2UoKTsKICAgICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oY3JlZGVudGlhbHMpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogUmVzb2x2ZXMgdGhlIHByb3ZpZGVyIGNoYWluIGJ5IHNlYXJjaGluZyBmb3IgdGhlIGZpcnN0IHNldCBvZgogICAgICogY3JlZGVudGlhbHMgaW4ge3Byb3ZpZGVyc30uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgY3JlZGVudGlhbHMpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBwcm92aWRlciByZXNvbHZlcyB0aGUgY2hhaW4gdG8gYSBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgb3IgbnVsbCBpZiBubyBjcmVkZW50aWFscyBjYW4gYmUgZm91bmQuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBpZiBubyBjcmVkZW50aWFscyBhcmUKICAgICAqICAgICBmb3VuZC4KICAgICAqICAgQHBhcmFtIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBjcmVkZW50aWFscyBvYmplY3QgcmVzb2x2ZWQKICAgICAqICAgICBieSB0aGUgcHJvdmlkZXIgY2hhaW4uCiAgICAgKiBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dIHRoZSBwcm92aWRlciwgZm9yIGNoYWluaW5nLgogICAgICovCiAgICByZXNvbHZlOiBmdW5jdGlvbiByZXNvbHZlKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHNlbGYucHJvdmlkZXJzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignTm8gcHJvdmlkZXJzJykpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgICB9CiAgCiAgICAgIGlmIChzZWxmLnJlc29sdmVDYWxsYmFja3MucHVzaChjYWxsYmFjaykgPT09IDEpIHsKICAgICAgICB2YXIgaW5kZXggPSAwOwogICAgICAgIHZhciBwcm92aWRlcnMgPSBzZWxmLnByb3ZpZGVycy5zbGljZSgwKTsKICAKICAgICAgICBmdW5jdGlvbiByZXNvbHZlTmV4dChlcnIsIGNyZWRzKSB7CiAgICAgICAgICBpZiAoKCFlcnIgJiYgY3JlZHMpIHx8IGluZGV4ID09PSBwcm92aWRlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzZWxmLnJlc29sdmVDYWxsYmFja3MsIGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgY3JlZHMpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAKICAgICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVyc1tpbmRleCsrXTsKICAgICAgICAgIGlmICh0eXBlb2YgcHJvdmlkZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY3JlZHMgPSBwcm92aWRlci5jYWxsKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjcmVkcyA9IHByb3ZpZGVyOwogICAgICAgICAgfQogIAogICAgICAgICAgaWYgKGNyZWRzLmdldCkgewogICAgICAgICAgICBjcmVkcy5nZXQoZnVuY3Rpb24gKGdldEVycikgewogICAgICAgICAgICAgIHJlc29sdmVOZXh0KGdldEVyciwgZ2V0RXJyID8gbnVsbCA6IGNyZWRzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlTmV4dChudWxsLCBjcmVkcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIHJlc29sdmVOZXh0KCk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogVGhlIGRlZmF1bHQgc2V0IG9mIHByb3ZpZGVycyB1c2VkIGJ5IGEgdmFuaWxsYSBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbi4KICAgKgogICAqIEluIHRoZSBicm93c2VyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gW10KICAgKiBgYGAKICAgKgogICAqIEluIE5vZGUuanM6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBTUFaT04nKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuU2hhcmVkSW5pRmlsZUNyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVDU0NyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlByb2Nlc3NDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5Ub2tlbkZpbGVXZWJJZGVudGl0eUNyZWRlbnRpYWxzKCk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVDMk1ldGFkYXRhQ3JlZGVudGlhbHMoKSB9CiAgICogXQogICAqIGBgYAogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gW107CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdGhpcy5wcm90b3R5cGUucmVzb2x2ZVByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ3Jlc29sdmUnLCBQcm9taXNlRGVwZW5kZW5jeSk7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5yZXNvbHZlUHJvbWlzZTsKICB9OwogIAogIEFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbik7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgU0FNTCBzdXBwb3J0LgogICAqCiAgICogQnkgZGVmYXVsdCB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfSBzZXJ2aWNlIG9wZXJhdGlvbi4gVGhpcyBvcGVyYXRpb24KICAgKiByZXF1aXJlcyBhIGBSb2xlQXJuYCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdCBwb2xpY3kgZm9yIHRoZQogICAqIGFwcGxpY2F0aW9uIGZvciB3aGljaCBjcmVkZW50aWFscyB3aWxsIGJlIGdpdmVuLCBhcyB3ZWxsIGFzIGEgYFByaW5jaXBhbEFybmAKICAgKiByZXByZXNlbnRpbmcgdGhlIEFSTiBmb3IgdGhlIFNBTUwgaWRlbnRpdHkgcHJvdmlkZXIuIEluIGFkZGl0aW9uLCB0aGUKICAgKiBgU0FNTEFzc2VydGlvbmAgbXVzdCBiZSBzZXQgdG8gdGhlIHRva2VuIHByb3ZpZGVkIGJ5IHRoZSBpZGVudGl0eQogICAqIHByb3ZpZGVyLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAgICogb2JqZWN0IHdpdGggcHJvcGVyIGBSb2xlQXJuYCwgYFByaW5jaXBhbEFybmAsIGFuZCBgU0FNTEFzc2VydGlvbmAgdmFsdWVzLgogICAqCiAgICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICAgKgogICAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICAgKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICAgKiBleHBpcmVzLCBpdCB3aWxsIG5vdCBiZSB1c2FibGUgdG8gcmVmcmVzaCBBV1MgY3JlZGVudGlhbHMsIGFuZCBhbm90aGVyCiAgICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogICAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICAgKiBwcm92aWRlcnMuIENvbnN1bHQgdGhlIGRvY3VtZW50YXRpb24gZm9yIHRoZSBpZGVudGl0eSBwcm92aWRlciBmb3IgcmVmcmVzaGluZwogICAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICAgKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICAgKiBjb2RlIHdpbGwgdXBkYXRlIHRoZSBTQU1MQXNzZXJ0aW9uLCBhc3N1bWluZyB5b3UgaGF2ZSByZXRyaWV2ZWQgYW4gdXBkYXRlZAogICAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLlNBTUxBc3NlcnRpb24gPSB1cGRhdGVkVG9rZW47CiAgICogYGBgCiAgICoKICAgKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwYXJhbXMKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICAgKiAgICAgYHBhcmFtcy5TQU1MQXNzZXJ0aW9uYCBwcm9wZXJ0eS4KICAgKi8KICBBV1MuU0FNTENyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKiBAcGFyYW0gKHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTCkKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5TQU1MQ3JlZGVudGlhbHMoewogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1NBTUxSb2xlJywKICAgICAqICAgICBQcmluY2lwYWxBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1NBTUxQcmluY2lwYWwnLAogICAgICogICAgIFNBTUxBc3NlcnRpb246ICdiYXNlNjQtdG9rZW4nLCAvLyBiYXNlNjQtZW5jb2RlZCB0b2tlbiBmcm9tIElkUAogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUwKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNBTUxDcmVkZW50aWFscyhwYXJhbXMpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlV2l0aFNBTUwoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5zZXJ2aWNlID0gdGhpcy5zZXJ2aWNlIHx8IG5ldyBTVFMoe3BhcmFtczogdGhpcy5wYXJhbXN9KTsKICAgIH0KICAKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20ge0FXUy5TVFN9LiBXaXRob3V0IGFueQogICAqIGV4dHJhIHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIHRoZQogICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9uLiBJZiBhbiBJQU0gcm9sZSBpcyBwcm92aWRlZCwgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3BlcmF0aW9uIHdpbGwgYmUgdXNlZCB0byBmZXRjaCBjcmVkZW50aWFscyBmb3IgdGhlCiAgICogcm9sZSBpbnN0ZWFkLgogICAqCiAgICogQG5vdGUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGlzIGRlcHJlY2F0ZWQsIGJ1dCByZW1haW5zIGF2YWlsYWJsZSBmb3IKICAgKiAgIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LiB7QVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzfSBpcyB0aGUKICAgKiAgIHByZWZlcnJlZCBjbGFzcyBmb3IgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogICAqCiAgICogVG8gc2V0dXAgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLCBjb25maWd1cmUgYSBzZXQgb2YgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICogdXNpbmcgdGhlIHN0YW5kYXJkIGNyZWRlbnRpYWxzIHByb3ZpZGVycyAoZW52aXJvbm1lbnQsIEVDMiBpbnN0YW5jZSBtZXRhZGF0YSwKICAgKiBvciBmcm9tIHRoZSBmaWxlc3lzdGVtKSwgdGhlbiBzZXQgdGhlIGdsb2JhbCBjcmVkZW50aWFscyB0byBhIG5ldwogICAqIHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3Q6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogLy8gTm90ZSB0aGF0IGVudmlyb25tZW50IGNyZWRlbnRpYWxzIGFyZSBsb2FkZWQgYnkgZGVmYXVsdCwKICAgKiAvLyB0aGUgZm9sbG93aW5nIGxpbmUgaXMgc2hvd24gZm9yIGNsYXJpdHk6CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7CiAgICoKICAgKiAvLyBOb3cgc2V0IHRlbXBvcmFyeSBjcmVkZW50aWFscyBzZWVkZWQgZnJvbSB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgKgogICAqIC8vIHN1YnNlcXVlbnQgcmVxdWVzdHMgd2lsbCBub3cgdXNlIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICogbmV3IEFXUy5TMygpLmxpc3RCdWNrZXQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICAgKiBgYGAKICAgKgogICAqIEAhYXR0cmlidXRlIG1hc3RlckNyZWRlbnRpYWxzCiAgICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgKG5vbi10ZW1wb3JhcnkpIGNyZWRlbnRpYWxzIHVzZWQgdG8KICAgKiAgICAgZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICogQG5vdGUgKHNlZSBjb25zdHJ1Y3RvcikKICAgKi8KICBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKgogICAgICogQG5vdGUgSW4gb3JkZXIgdG8gY3JlYXRlIHRlbXBvcmFyeSBjcmVkZW50aWFscywgeW91IGZpcnN0IG5lZWQgdG8gaGF2ZQogICAgICogICAibWFzdGVyIiBjcmVkZW50aWFscyBjb25maWd1cmVkIGluIHtBV1MuQ29uZmlnLmNyZWRlbnRpYWxzfS4gVGhlc2UKICAgICAqICAgbWFzdGVyIGNyZWRlbnRpYWxzIGFyZSBuZWNlc3NhcnkgdG8gcmV0cmlldmUgdGhlIHRlbXBvcmFyeSBjcmVkZW50aWFscywKICAgICAqICAgYXMgd2VsbCBhcyByZWZyZXNoIHRoZSBjcmVkZW50aWFscyB3aGVuIHRoZXkgZXhwaXJlLgogICAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUKICAgICAqICAge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3Ige0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb25zLgogICAgICogICBJZiBhIGBSb2xlQXJuYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCBjcmVkZW50aWFscyB3aWxsIGJlIGJhc2VkIG9uIHRoZQogICAgICogICBJQU0gcm9sZS4KICAgICAqIEBwYXJhbSBtYXN0ZXJDcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIChub24tdGVtcG9yYXJ5KSBjcmVkZW50aWFscwogICAgICogIHVzZWQgdG8gZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGdlbmVyaWMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGFuIElBTSByb2xlCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9UZW1wb3JhcnlDcmVkZW50aWFscycsCiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGUKICAgICAqIEBzZWUgQVdTLlNUUy5nZXRTZXNzaW9uVG9rZW4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFRlbXBvcmFyeUNyZWRlbnRpYWxzKHBhcmFtcywgbWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMubG9hZE1hc3RlckNyZWRlbnRpYWxzKG1hc3RlckNyZWRlbnRpYWxzKTsKICAgICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICAgIGlmICh0aGlzLnBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lID0KICAgICAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAndGVtcG9yYXJ5LWNyZWRlbnRpYWxzJzsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yCiAgICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59LCBkZXBlbmRpbmcgb24gd2hldGhlciBhbiBJQU0gcm9sZSBBUk4gd2FzIHBhc3NlZAogICAgICogdG8gdGhlIGNyZWRlbnRpYWxzIHtjb25zdHJ1Y3Rvcn0uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaCAoY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQgKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYubWFzdGVyQ3JlZGVudGlhbHMuZ2V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzID0gc2VsZi5tYXN0ZXJDcmVkZW50aWFsczsKICAgICAgICB2YXIgb3BlcmF0aW9uID0gc2VsZi5wYXJhbXMuUm9sZUFybiA/CiAgICAgICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZSA6IHNlbGYuc2VydmljZS5nZXRTZXNzaW9uVG9rZW47CiAgICAgICAgb3BlcmF0aW9uLmNhbGwoc2VsZi5zZXJ2aWNlLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZE1hc3RlckNyZWRlbnRpYWxzOiBmdW5jdGlvbiBsb2FkTWFzdGVyQ3JlZGVudGlhbHMgKG1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSBtYXN0ZXJDcmVkZW50aWFscyB8fCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzOwogICAgICB3aGlsZSAodGhpcy5tYXN0ZXJDcmVkZW50aWFscy5tYXN0ZXJDcmVkZW50aWFscykgewogICAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSB0aGlzLm1hc3RlckNyZWRlbnRpYWxzLm1hc3RlckNyZWRlbnRpYWxzOwogICAgICB9CiAgCiAgICAgIGlmICh0eXBlb2YgdGhpcy5tYXN0ZXJDcmVkZW50aWFscy5nZXQgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyh0aGlzLm1hc3RlckNyZWRlbnRpYWxzKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy5zZXJ2aWNlID0gdGhpcy5zZXJ2aWNlIHx8IG5ldyBTVFMoe3BhcmFtczogdGhpcy5wYXJhbXN9KTsKICAgIH0KICAKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSBTVFMgV2ViIElkZW50aXR5IEZlZGVyYXRpb24gc3VwcG9ydC4KICAgKgogICAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9IHNlcnZpY2Ugb3BlcmF0aW9uLiBUaGlzIG9wZXJhdGlvbgogICAqIHJlcXVpcmVzIGEgYFJvbGVBcm5gIGNvbnRhaW5pbmcgdGhlIEFSTiBvZiB0aGUgSUFNIHRydXN0IHBvbGljeSBmb3IgdGhlCiAgICogYXBwbGljYXRpb24gZm9yIHdoaWNoIGNyZWRlbnRpYWxzIHdpbGwgYmUgZ2l2ZW4uIEluIGFkZGl0aW9uLCB0aGUKICAgKiBgV2ViSWRlbnRpdHlUb2tlbmAgbXVzdCBiZSBzZXQgdG8gdGhlIHRva2VuIHByb3ZpZGVkIGJ5IHRoZSBpZGVudGl0eQogICAqIHByb3ZpZGVyLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAgICogb2JqZWN0IHdpdGggcHJvcGVyIGBSb2xlQXJuYCBhbmQgYFdlYklkZW50aXR5VG9rZW5gIHZhbHVlcy4KICAgKgogICAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAgICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAgICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogICAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICAgKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAgICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICAgKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAgICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAgICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgV2ViSWRlbnRpdHlUb2tlbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICAgKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5XZWJJZGVudGl0eVRva2VuID0gdXBkYXRlZFRva2VuOwogICAqIGBgYAogICAqCiAgICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogICAqICAgICBgcGFyYW1zLldlYklkZW50aXR5VG9rZW5gIHByb3BlcnR5LgogICAqIEAhYXR0cmlidXRlIGRhdGEKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIHJhdyBkYXRhIHJlc3BvbnNlIGZyb20gdGhlIGNhbGwgdG8KICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFVzZSB0aGlzIGlmIHlvdSB3YW50IHRvIGdldAogICAqICAgICBhY2Nlc3MgdG8gb3RoZXIgcHJvcGVydGllcyBmcm9tIHRoZSByZXNwb25zZS4KICAgKi8KICBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICogQHBhcmFtIChzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KQogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHMoewogICAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1dlYklkZW50aXR5JywKICAgICAqICAgICBXZWJJZGVudGl0eVRva2VuOiAnQUJDREVGR0hJSktMTU5PUCcsIC8vIHRva2VuIGZyb20gaWRlbnRpdHkgc2VydmljZQogICAgICogICAgIFJvbGVTZXNzaW9uTmFtZTogJ3dlYicgLy8gb3B0aW9uYWwgbmFtZSwgZGVmYXVsdHMgdG8gd2ViLWlkZW50aXR5CiAgICAgKiAgIH0sIHsKICAgICAqICAgICAvLyBvcHRpb25hbGx5IHByb3ZpZGUgY29uZmlndXJhdGlvbiB0byBhcHBseSB0byB0aGUgdW5kZXJseWluZyBBV1MuU1RTIHNlcnZpY2UgY2xpZW50CiAgICAgKiAgICAgLy8gaWYgY29uZmlndXJhdGlvbiBpcyBub3QgcHJvdmlkZWQsIHRoZW4gY29uZmlndXJhdGlvbiB3aWxsIGJlIHB1bGxlZCBmcm9tIEFXUy5jb25maWcKICAgICAqCiAgICAgKiAgICAgLy8gc3BlY2lmeSB0aW1lb3V0IG9wdGlvbnMKICAgICAqICAgICBodHRwT3B0aW9uczogewogICAgICogICAgICAgdGltZW91dDogMTAwCiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5CiAgICAgKiBAc2VlIEFXUy5Db25maWcKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFdlYklkZW50aXR5Q3JlZGVudGlhbHMocGFyYW1zLCBjbGllbnRDb25maWcpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPSB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3dlYi1pZGVudGl0eSc7CiAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgIHRoaXMuX2NsaWVudENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY2xpZW50Q29uZmlnIHx8IHt9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fQogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHNlbGYuZGF0YSA9IG51bGw7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuZGF0YSA9IGRhdGE7CiAgICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICAgIH0KICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnNlcnZpY2UpIHsKICAgICAgICB2YXIgc3RzQ29uZmlnID0gQVdTLnV0aWwubWVyZ2Uoe30sIHRoaXMuX2NsaWVudENvbmZpZyk7CiAgICAgICAgc3RzQ29uZmlnLnBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgICAgIHRoaXMuc2VydmljZSA9IG5ldyBTVFMoc3RzQ29uZmlnKTsKICAgICAgfQogICAgfQogIAogIH0pOwogIAogIH0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTh9XSwyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CiAgdmFyIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMgPSBbJ0FXU19FTkFCTEVfRU5EUE9JTlRfRElTQ09WRVJZJywgJ0FXU19FTkRQT0lOVF9ESVNDT1ZFUllfRU5BQkxFRCddOwogIAogIC8qKgogICAqIEdlbmVyYXRlIGtleSAoZXhjZXB0IHJlc291cmNlcyBhbmQgb3BlcmF0aW9uIHBhcnQpIHRvIGluZGV4IHRoZSBlbmRwb2ludHMgaW4gdGhlIGNhY2hlCiAgICogSWYgaW5wdXQgc2hhcGUgaGFzIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICAgKiAgIGFjY2Vzc0tleSArIG9wZXJhdGlvbiArIHJlc291cmNlcyArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAgICogSWYgaW5wdXQgc2hhcGUgZG9lc24ndCBoYXZlIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICAgKiAgIGFjY2Vzc0tleSArIHJlZ2lvbiArIHNlcnZpY2UgYXMgY2FjaGUga2V5CiAgICogQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XSBvYmplY3Qgd2l0aCBrZXlzIHRvIGluZGV4IGVuZHBvaW50cy4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBnZXRDYWNoZUtleShyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaSB8fCB7fTsKICAgIHZhciBvcGVyYXRpb25zID0gYXBpLm9wZXJhdGlvbnM7CiAgICB2YXIgaWRlbnRpZmllcnMgPSB7fTsKICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5yZWdpb24pIHsKICAgICAgaWRlbnRpZmllcnMucmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgfQogICAgaWYgKGFwaS5zZXJ2aWNlSWQpIHsKICAgICAgaWRlbnRpZmllcnMuc2VydmljZUlkID0gYXBpLnNlcnZpY2VJZDsKICAgIH0KICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCkgewogICAgICBpZGVudGlmaWVycy5hY2Nlc3NLZXlJZCA9IHNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgfQogICAgcmV0dXJuIGlkZW50aWZpZXJzOwogIH0KICAKICAvKioKICAgKiBSZWN1cnNpdmUgaGVscGVyIGZvciBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKCkuCiAgICogTG9va3MgZm9yIHJlcXVpcmVkIHN0cmluZyBpbnB1dCBtZW1iZXJzIHRoYXQgaGF2ZSAnZW5kcG9pbnRkaXNjb3ZlcnlpZCcgdHJhaXQuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtcywgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgcGFyYW1zID09PSB1bmRlZmluZWQgfHwgcGFyYW1zID09PSBudWxsKSByZXR1cm47CiAgICBpZiAoc2hhcGUudHlwZSA9PT0gJ3N0cnVjdHVyZScgJiYgc2hhcGUucmVxdWlyZWQgJiYgc2hhcGUucmVxdWlyZWQubGVuZ3RoID4gMCkgewogICAgICB1dGlsLmFycmF5RWFjaChzaGFwZS5yZXF1aXJlZCwgZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgICAgaWYgKG1lbWJlclNoYXBlLmVuZHBvaW50RGlzY292ZXJ5SWQgPT09IHRydWUpIHsKICAgICAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgICAgICAgcmVzdWx0W2xvY2F0aW9uTmFtZV0gPSBTdHJpbmcocGFyYW1zW25hbWVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtc1tuYW1lXSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEdldCBjdXN0b20gaWRlbnRpZmllcnMgZm9yIGNhY2hlIGtleS4KICAgKiBJZGVudGlmaWVzIGN1c3RvbSBpZGVudGlmaWVycyBieSBjaGVja2luZyBlYWNoIHNoYXBlJ3MgYGVuZHBvaW50RGlzY292ZXJ5SWRgIHRyYWl0LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBwYXJhbSBbb2JqZWN0XSBpbnB1dCBzaGFwZSBvZiB0aGUgZ2l2ZW4gb3BlcmF0aW9uJ3MgYXBpCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBzaGFwZSkgewogICAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKGlkZW50aWZpZXJzLCByZXF1ZXN0LnBhcmFtcywgc2hhcGUpOwogICAgcmV0dXJuIGlkZW50aWZpZXJzOwogIH0KICAKICAvKioKICAgKiBDYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24gd2hlbiBpdCdzIG9wdGlvbmFsLgogICAqIFdoZW4gZW5kcG9pbnQgaXMgYXZhaWxhYmxlIGluIGNhY2hlIHRoZW4gdXNlIHRoZSBjYWNoZWQgZW5kcG9pbnRzLiBJZiBlbmRwb2ludHMKICAgKiBhcmUgdW5hdmFpbGFibGUgdGhlbiB1c2UgcmVnaW9uYWwgZW5kcG9pbnRzIGFuZCBjYWxsIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb24KICAgKiBhc3luY2hyb25vdXNseS4gVGhpcyBpcyB0dXJuZWQgb2ZmIGJ5IGRlZmF1bHQuCiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgICB9CiAgICB2YXIgZW5kcG9pbnRzID0gQVdTLmVuZHBvaW50Q2FjaGUuZ2V0KGNhY2hlS2V5KTsKICAgIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA9PT0gMSAmJiBlbmRwb2ludHNbMF0uQWRkcmVzcyA9PT0gJycpIHsKICAgICAgLy9lbmRwb2ludCBvcGVyYXRpb24gaXMgYmVpbmcgbWFkZSBidXQgcmVzcG9uc2Ugbm90IHlldCByZWNlaXZlZAogICAgICAvL29yIGVuZHBvaW50IG9wZXJhdGlvbiBqdXN0IGZhaWxlZCBpbiAxIG1pbnV0ZQogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgICAvL2ZvdW5kIGVuZHBvaW50IHJlY29yZCBmcm9tIGNhY2hlCiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgfSBlbHNlIHsKICAgICAgLy9lbmRwb2ludCByZWNvcmQgbm90IGluIGNhY2hlIG9yIG91dGRhdGVkLiBtYWtlIGRpc2NvdmVyeSBvcGVyYXRpb24KICAgICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgICAgfSk7CiAgICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3JldHJ5JywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuUkVUUllfQ0hFQ0spOwogICAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiAxCiAgICAgIH1dKTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5FbmRwb2ludHMpIHsKICAgICAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgZGF0YS5FbmRwb2ludHMpOwogICAgICAgIH0gZWxzZSBpZiAoZXJyKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIFt7CiAgICAgICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMSAvL25vdCB0byBtYWtlIG1vcmUgZW5kcG9pbnQgb3BlcmF0aW9uIGluIG5leHQgMSBtaW51dGUKICAgICAgICAgIH1dKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAKICB2YXIgcmVxdWVzdFF1ZXVlID0ge307CiAgCiAgLyoqCiAgICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyByZXF1aXJlZC4KICAgKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSBjYWNoZWQgb25lcy4gSWYgZW5kcG9pbnRzIGFyZQogICAqIHVuYXZhaWxhYmxlIHRoZW4gU0RLIHNob3VsZCBjYWxsIGVuZHBvaW50IG9wZXJhdGlvbiB0aGVuIHVzZSByZXR1cm5lZCBuZXcKICAgKiBlbmRwb2ludCBmb3IgdGhlIGFwaSBjYWxsLiBTREsgd2lsbCBhdXRvbWF0aWNhbGx5IGF0dGVtcHQgdG8gZG8gZW5kcG9pbnQKICAgKiBkaXNjb3ZlcnkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0CiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIGFwaSA9IHNlcnZpY2UuYXBpOwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgICB9CiAgICB2YXIgY2FjaGVLZXlTdHIgPSBBV1MuRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoY2FjaGVLZXkpOwogICAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleVN0cik7IC8vZW5kcG9pbnQgY2FjaGUgYWxzbyBhY2NlcHRzIHN0cmluZyBrZXlzCiAgICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgICAgLy9wdXNoIHJlcXVlc3Qgb2JqZWN0IHRvIGEgcGVuZGluZyBxdWV1ZQogICAgICBpZiAoIXJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0gPSBbXTsKICAgICAgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXS5wdXNoKHtyZXF1ZXN0OiByZXF1ZXN0LCBjYWxsYmFjazogZG9uZX0pOwogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID4gMCkgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgICAgZG9uZSgpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGVuZHBvaW50UmVxdWVzdCA9IHNlcnZpY2UubWFrZVJlcXVlc3QoYXBpLmVuZHBvaW50T3BlcmF0aW9uLCB7CiAgICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgICAgfSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpOwogIAogICAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBbewogICAgICAgIEFkZHJlc3M6ICcnLAogICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiA2MCAvL2xvbmctbGl2ZSBjYWNoZQogICAgICB9XSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHZhciBlcnJvclBhcmFtcyA9IHsKICAgICAgICAgICAgY29kZTogJ0VuZHBvaW50RGlzY292ZXJ5RXhjZXB0aW9uJywKICAgICAgICAgICAgbWVzc2FnZTogJ1JlcXVlc3QgY2Fubm90IGJlIGZ1bGZpbGxlZCB3aXRob3V0IHNwZWNpZnlpbmcgYW4gZW5kcG9pbnQnLAogICAgICAgICAgICByZXRyeWFibGU6IGZhbHNlCiAgICAgICAgICB9OwogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCBlcnJvclBhcmFtcyk7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwogIAogICAgICAgICAgLy9mYWlsIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0LnJlc3BvbnNlLmVycm9yID0gdXRpbC5lcnJvcihlcnIsIGVycm9yUGFyYW1zKTsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChkYXRhKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXlTdHIsIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZGF0YS5FbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgCiAgICAgICAgICAvL3VwZGF0ZSB0aGUgZW5kcG9pbnQgZm9yIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgICAgaWYgKHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0pIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LmNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkZWxldGUgcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZG9uZSgpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogYWRkIGFwaSB2ZXJzaW9uIGhlYWRlciB0byBlbmRwb2ludCBvcGVyYXRpb24KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCkgewogICAgdmFyIGFwaSA9IGVuZHBvaW50UmVxdWVzdC5zZXJ2aWNlLmFwaTsKICAgIHZhciBhcGlWZXJzaW9uID0gYXBpLmFwaVZlcnNpb247CiAgICBpZiAoYXBpVmVyc2lvbiAmJiAhZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10pIHsKICAgICAgZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10gPSBhcGlWZXJzaW9uOwogICAgfQogIH0KICAKICAvKioKICAgKiBJZiBhcGkgY2FsbCBnZXRzIGludmFsaWQgZW5kcG9pbnQgZXhjZXB0aW9uLCBTREsgc2hvdWxkIGF0dGVtcHQgdG8gcmVtb3ZlIHRoZSBpbnZhbGlkCiAgICogZW5kcG9pbnQgZnJvbSBjYWNoZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKHJlc3BvbnNlKSB7CiAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgIHZhciBodHRwUmVzcG9uc2UgPSByZXNwb25zZS5odHRwUmVzcG9uc2U7CiAgICBpZiAoZXJyb3IgJiYKICAgICAgKGVycm9yLmNvZGUgPT09ICdJbnZhbGlkRW5kcG9pbnRFeGNlcHRpb24nIHx8IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MjEpCiAgICApIHsKICAgICAgdmFyIHJlcXVlc3QgPSByZXNwb25zZS5yZXF1ZXN0OwogICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA/IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLmlucHV0IDogdW5kZWZpbmVkOwogICAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgICB2YXIgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShyZXF1ZXN0KTsKICAgICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICAgIGlmIChvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSkgY2FjaGVLZXkub3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0ubmFtZTsKICAgICAgfQogICAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwogICAgfQogIH0KICAKICAvKioKICAgKiBJZiBlbmRwb2ludCBpcyBleHBsaWNpdGx5IGNvbmZpZ3VyZWQsIFNESyBzaG91bGQgbm90IGRvIGVuZHBvaW50IGRpc2NvdmVyeSBpbiBhbnl0aW1lLgogICAqIEBwYXJhbSBbb2JqZWN0XSBjbGllbnQgU2VydmljZSBjbGllbnQgb2JqZWN0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGhhc0N1c3RvbUVuZHBvaW50KGNsaWVudCkgewogICAgLy9pZiBzZXQgZW5kcG9pbnQgaXMgc2V0IGZvciBzcGVjaWZpYyBjbGllbnQsIGVuYWJsZSBlbmRwb2ludCBkaXNjb3Zlcnkgd2lsbCByYWlzZSBhbiBlcnJvci4KICAgIGlmIChjbGllbnQuX29yaWdpbmFsQ29uZmlnICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnQgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgPT09IHRydWUpIHsKICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICBtZXNzYWdlOiAnQ3VzdG9tIGVuZHBvaW50IGlzIHN1cHBsaWVkOyBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgbXVzdCBub3QgYmUgdHJ1ZS4nCiAgICAgIH0pOwogICAgfTsKICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW2NsaWVudC5zZXJ2aWNlSWRlbnRpZmllcl0gfHwge307CiAgICByZXR1cm4gQm9vbGVhbihBV1MuY29uZmlnLmVuZHBvaW50IHx8IHN2Y0NvbmZpZy5lbmRwb2ludCB8fCAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50KSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRmFsc3kodmFsdWUpIHsKICAgIHJldHVybiBbJ2ZhbHNlJywgJzAnXS5pbmRleE9mKHZhbHVlKSA+PSAwOwogIH0KICAKICAvKioKICAgKiBJZiBlbmRwb2ludCBkaXNjb3Zlcnkgc2hvdWxkIHBlcmZvcm0gZm9yIHRoaXMgcmVxdWVzdCB3aGVuIGVuZHBvaW50IGRpc2NvdmVyeSBpcyBvcHRpb25hbC4KICAgKiBTREsgcGVyZm9ybXMgY29uZmlnIHJlc29sdXRpb24gaW4gb3JkZXIgbGlrZSBiZWxvdzoKICAgKiAxLiBJZiB0dXJuZWQgb24gY2xpZW50IGNvbmZpZ3VyYXRpb24oZGVmYXVsdCB0byBvZmYpIHRoZW4gdHVybiBvbiBlbmRwb2ludCBkaXNjb3ZlcnkuCiAgICogMi4gSWYgdHVybmVkIG9uIGluIGVudiBBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWSB0aGVuIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIDMuIElmIHR1cm5lZCBvbiBpbiBzaGFyZWQgaW5pIGNvbmZpZyBmaWxlIHdpdGgga2V5ICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcsIHRoZW4KICAgKiAgIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IHJlcXVlc3Qgb2JqZWN0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRW5kcG9pbnREaXNjb3ZlcnlBcHBsaWNhYmxlKHJlcXVlc3QpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogICAgaWYgKHNlcnZpY2UuY29uZmlnLmVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCA9PT0gdHJ1ZSkgcmV0dXJuIHRydWU7CiAgCiAgICAvL3NoYXJlZCBpbmkgZmlsZSBpcyBvbmx5IGF2YWlsYWJsZSBpbiBOb2RlCiAgICAvL25vdCB0byBjaGVjayBlbnYgaW4gYnJvd3NlcgogICAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiBmYWxzZTsKICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgZW52ID0gZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52c1tpXTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgZW52KSkgewogICAgICAgIGlmIChwcm9jZXNzLmVudltlbnZdID09PSAnJyB8fCBwcm9jZXNzLmVudltlbnZdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgICBtZXNzYWdlOiAnZW52aXJvbm1lbnRhbCB2YXJpYWJsZSAnICsgZW52ICsgJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0ZhbHN5KHByb2Nlc3MuZW52W2Vudl0pKSByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIAogICAgdmFyIGNvbmZpZ0ZpbGUgPSB7fTsKICAgIHRyeSB7CiAgICAgIGNvbmZpZ0ZpbGUgPSBBV1MudXRpbC5pbmlMb2FkZXIgPyBBV1MudXRpbC5pbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgIGlzQ29uZmlnOiB0cnVlLAogICAgICAgIGZpbGVuYW1lOiBwcm9jZXNzLmVudltBV1MudXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgICB9KSA6IHt9OwogICAgfSBjYXRjaCAoZSkge30KICAgIHZhciBzaGFyZWRGaWxlQ29uZmlnID0gY29uZmlnRmlsZVsKICAgICAgcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGUKICAgIF0gfHwge307CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNoYXJlZEZpbGVDb25maWcsICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcpKSB7CiAgICAgIGlmIChzaGFyZWRGaWxlQ29uZmlnLmVuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnY29uZmlnIGZpbGUgZW50cnkgXCdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZFwnIGNhbm5vdCBiZSBzZXQgdG8gbm90aGluZycKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIWlzRmFsc3koc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCkpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KICAKICAvKioKICAgKiBhdHRhY2ggZW5kcG9pbnQgZGlzY292ZXJ5IGxvZ2ljIHRvIHJlcXVlc3Qgb2JqZWN0CiAgICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3QKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBkaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICAgIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlIHx8IHt9OwogICAgaWYgKGhhc0N1c3RvbUVuZHBvaW50KHNlcnZpY2UpIHx8IHJlcXVlc3QuaXNQcmVzaWduZWQoKSkgcmV0dXJuIGRvbmUoKTsKICAKICAgIGlmICghaXNFbmRwb2ludERpc2NvdmVyeUFwcGxpY2FibGUocmVxdWVzdCkpIHJldHVybiBkb25lKCk7CiAgCiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdlbmRwb2ludC1kaXNjb3ZlcnknKTsKICAKICAgIHZhciBvcGVyYXRpb25zID0gc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgdmFyIGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA6ICdOVUxMJzsKICAgIHN3aXRjaCAoaXNFbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkKSB7CiAgICAgIGNhc2UgJ09QVElPTkFMJzoKICAgICAgICBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCk7CiAgICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgICAgZG9uZSgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdSRVFVSVJFRCc6CiAgICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdJTlZBTElEQVRFX0NBQ0hFRF9FTkRQT0lOVFMnLCAnZXh0cmFjdEVycm9yJywgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyk7CiAgICAgICAgcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdOVUxMJzoKICAgICAgZGVmYXVsdDoKICAgICAgICBkb25lKCk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gewogICAgZGlzY292ZXJFbmRwb2ludDogZGlzY292ZXJFbmRwb2ludCwKICAgIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludDogcmVxdWlyZWREaXNjb3ZlckVuZHBvaW50LAogICAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50OiBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQsCiAgICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzOiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzLAogICAgZ2V0Q2FjaGVLZXk6IGdldENhY2hlS2V5LAogICAgaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50OiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzLAogIH07CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL3V0aWwiOjcxLCJfcHJvY2VzcyI6ODZ9XSwyNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGV2ZW50TWVzc2FnZUNodW5rZXIgPSByZXF1aXJlKCcuLi9ldmVudC1zdHJlYW0vZXZlbnQtbWVzc2FnZS1jaHVua2VyJykuZXZlbnRNZXNzYWdlQ2h1bmtlcjsKICB2YXIgcGFyc2VFdmVudCA9IHJlcXVpcmUoJy4vcGFyc2UtZXZlbnQnKS5wYXJzZUV2ZW50OwogIAogIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50U3RyZWFtKGJvZHksIHBhcnNlciwgbW9kZWwpIHsKICAgICAgdmFyIGV2ZW50TWVzc2FnZXMgPSBldmVudE1lc3NhZ2VDaHVua2VyKGJvZHkpOwogIAogICAgICB2YXIgZXZlbnRzID0gW107CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRNZXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZXZlbnRzLnB1c2gocGFyc2VFdmVudChwYXJzZXIsIGV2ZW50TWVzc2FnZXNbaV0sIG1vZGVsKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGV2ZW50czsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZUV2ZW50U3RyZWFtOiBjcmVhdGVFdmVudFN0cmVhbQogIH07CiAgCiAgfSx7Ii4uL2V2ZW50LXN0cmVhbS9ldmVudC1tZXNzYWdlLWNodW5rZXIiOjI4LCIuL3BhcnNlLWV2ZW50IjozMH1dLDI4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBUYWtlcyBpbiBhIGJ1ZmZlciBvZiBldmVudCBtZXNzYWdlcyBhbmQgc3BsaXRzIHRoZW0gaW50byBpbmRpdmlkdWFsIG1lc3NhZ2VzLgogICAqIEBwYXJhbSB7QnVmZmVyfSBidWZmZXIKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBldmVudE1lc3NhZ2VDaHVua2VyKGJ1ZmZlcikgewogICAgICAvKiogQHR5cGUgQnVmZmVyW10gKi8KICAgICAgdmFyIG1lc3NhZ2VzID0gW107CiAgICAgIHZhciBvZmZzZXQgPSAwOwogIAogICAgICB3aGlsZSAob2Zmc2V0IDwgYnVmZmVyLmxlbmd0aCkgewogICAgICAgICAgdmFyIHRvdGFsTGVuZ3RoID0gYnVmZmVyLnJlYWRJbnQzMkJFKG9mZnNldCk7CiAgCiAgICAgICAgICAvLyBjcmVhdGUgbmV3IGJ1ZmZlciBmb3IgaW5kaXZpZHVhbCBtZXNzYWdlIChzaGFyZXMgbWVtb3J5IHdpdGggb3JpZ2luYWwpCiAgICAgICAgICB2YXIgbWVzc2FnZSA9IGJ1ZmZlci5zbGljZShvZmZzZXQsIHRvdGFsTGVuZ3RoICsgb2Zmc2V0KTsKICAgICAgICAgIC8vIGluY3JlbWVudCBvZmZzZXQgdG8gaXQgc3RhcnRzIGF0IHRoZSBuZXh0IG1lc3NhZ2UKICAgICAgICAgIG9mZnNldCArPSB0b3RhbExlbmd0aDsKICAKICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobWVzc2FnZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIG1lc3NhZ2VzOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXZlbnRNZXNzYWdlQ2h1bmtlcjogZXZlbnRNZXNzYWdlQ2h1bmtlcgogIH07CiAgCiAgfSx7fV0sMjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CiAgdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CiAgCiAgLyoqCiAgICogQSBsb3NzbGVzcyByZXByZXNlbnRhdGlvbiBvZiBhIHNpZ25lZCwgNjQtYml0IGludGVnZXIuIEluc3RhbmNlcyBvZiB0aGlzCiAgICogY2xhc3MgbWF5IGJlIHVzZWQgaW4gYXJpdGhtZXRpYyBleHByZXNzaW9ucyBhcyBpZiB0aGV5IHdlcmUgbnVtZXJpYwogICAqIHByaW1pdGl2ZXMsIGJ1dCB0aGUgYmluYXJ5IHJlcHJlc2VudGF0aW9uIHdpbGwgYmUgcHJlc2VydmVkIHVuY2hhbmdlZCBhcyB0aGUKICAgKiBgYnl0ZXNgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoZSBieXRlcyBzaG91bGQgYmUgZW5jb2RlZCBhcyBiaWctZW5kaWFuLAogICAqIHR3bydzIGNvbXBsZW1lbnQgaW50ZWdlcnMuCiAgICogQHBhcmFtIHtCdWZmZXJ9IGJ5dGVzCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBJbnQ2NChieXRlcykgewogICAgICBpZiAoYnl0ZXMubGVuZ3RoICE9PSA4KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludDY0IGJ1ZmZlcnMgbXVzdCBiZSBleGFjdGx5IDggYnl0ZXMnKTsKICAgICAgfQogICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ5dGVzKSkgYnl0ZXMgPSB0b0J1ZmZlcihieXRlcyk7CiAgCiAgICAgIHRoaXMuYnl0ZXMgPSBieXRlczsKICB9CiAgCiAgLyoqCiAgICogQHBhcmFtIHtudW1iZXJ9IG51bWJlcgogICAqIEByZXR1cm5zIHtJbnQ2NH0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LmZyb21OdW1iZXIgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgaWYgKG51bWJlciA+IDkyMjMzNzIwMzY4NTQ3NzU4MDcgfHwgbnVtYmVyIDwgLTkyMjMzNzIwMzY4NTQ3NzU4MDgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICBudW1iZXIgKyAnIGlzIHRvbyBsYXJnZSAob3IsIGlmIG5lZ2F0aXZlLCB0b28gc21hbGwpIHRvIHJlcHJlc2VudCBhcyBhbiBJbnQ2NCcKICAgICAgICAgICk7CiAgICAgIH0KICAKICAgICAgdmFyIGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICAgIGZvciAoCiAgICAgICAgICB2YXIgaSA9IDcsIHJlbWFpbmluZyA9IE1hdGguYWJzKE1hdGgucm91bmQobnVtYmVyKSk7CiAgICAgICAgICBpID4gLTEgJiYgcmVtYWluaW5nID4gMDsKICAgICAgICAgIGktLSwgcmVtYWluaW5nIC89IDI1NgogICAgICApIHsKICAgICAgICAgIGJ5dGVzW2ldID0gcmVtYWluaW5nOwogICAgICB9CiAgCiAgICAgIGlmIChudW1iZXIgPCAwKSB7CiAgICAgICAgICBuZWdhdGUoYnl0ZXMpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBuZXcgSW50NjQoYnl0ZXMpOwogIH07CiAgCiAgLyoqCiAgICogQHJldHVybnMge251bWJlcn0KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEludDY0LnByb3RvdHlwZS52YWx1ZU9mID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBieXRlcyA9IHRoaXMuYnl0ZXMuc2xpY2UoMCk7CiAgICAgIHZhciBuZWdhdGl2ZSA9IGJ5dGVzWzBdICYgMTI4OwogICAgICBpZiAobmVnYXRpdmUpIHsKICAgICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHBhcnNlSW50KGJ5dGVzLnRvU3RyaW5nKCdoZXgnKSwgMTYpICogKG5lZ2F0aXZlID8gLTEgOiAxKTsKICB9OwogIAogIEludDY0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXMudmFsdWVPZigpKTsKICB9OwogIAogIC8qKgogICAqIEBwYXJhbSB7QnVmZmVyfSBieXRlcwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gbmVnYXRlKGJ5dGVzKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICBieXRlc1tpXSBePSAweEZGOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSA3OyBpID4gLTE7IGktLSkgewogICAgICAgICAgYnl0ZXNbaV0rKzsKICAgICAgICAgIGlmIChieXRlc1tpXSAhPT0gMCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbnQ2NDogSW50NjQKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDMwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcGFyc2VNZXNzYWdlID0gcmVxdWlyZSgnLi9wYXJzZS1tZXNzYWdlJykucGFyc2VNZXNzYWdlOwogIAogIC8qKgogICAqCiAgICogQHBhcmFtIHsqfSBwYXJzZXIKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqIEBwYXJhbSB7Kn0gc2hhcGUKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwYXJzZUV2ZW50KHBhcnNlciwgbWVzc2FnZSwgc2hhcGUpIHsKICAgICAgdmFyIHBhcnNlZE1lc3NhZ2UgPSBwYXJzZU1lc3NhZ2UobWVzc2FnZSk7CiAgCiAgICAgIC8vIGNoZWNrIGlmIG1lc3NhZ2UgaXMgYW4gZXZlbnQgb3IgZXJyb3IKICAgICAgdmFyIG1lc3NhZ2VUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6bWVzc2FnZS10eXBlJ107CiAgICAgIGlmIChtZXNzYWdlVHlwZSkgewogICAgICAgICAgaWYgKG1lc3NhZ2VUeXBlLnZhbHVlID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgdGhyb3cgcGFyc2VFcnJvcihwYXJzZWRNZXNzYWdlKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZVR5cGUudmFsdWUgIT09ICdldmVudCcpIHsKICAgICAgICAgICAgICAvLyBub3Qgc3VyZSBob3cgdG8gcGFyc2Ugbm9uLWV2ZW50cy9ub24tZXJyb3JzLCBpZ25vcmUgZm9yIG5vdwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyBkZXRlcm1pbmUgZXZlbnQgdHlwZQogICAgICB2YXIgZXZlbnRUeXBlID0gcGFyc2VkTWVzc2FnZS5oZWFkZXJzWyc6ZXZlbnQtdHlwZSddOwogICAgICAvLyBjaGVjayB0aGF0IHRoZSBldmVudCB0eXBlIGlzIG1vZGVsZWQKICAgICAgdmFyIGV2ZW50TW9kZWwgPSBzaGFwZS5tZW1iZXJzW2V2ZW50VHlwZS52YWx1ZV07CiAgICAgIGlmICghZXZlbnRNb2RlbCkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgCiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgLy8gY2hlY2sgaWYgYW4gZXZlbnQgcGF5bG9hZCBleGlzdHMKICAgICAgdmFyIGV2ZW50UGF5bG9hZE1lbWJlck5hbWUgPSBldmVudE1vZGVsLmV2ZW50UGF5bG9hZE1lbWJlck5hbWU7CiAgICAgIGlmIChldmVudFBheWxvYWRNZW1iZXJOYW1lKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZFNoYXBlID0gZXZlbnRNb2RlbC5tZW1iZXJzW2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdOwogICAgICAgICAgLy8gaWYgdGhlIHNoYXBlIGlzIGJpbmFyeSwgcmV0dXJuIHRoZSBieXRlIGFycmF5CiAgICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknKSB7CiAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdID0gcGFyc2VkTWVzc2FnZS5ib2R5OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHRbZXZlbnRQYXlsb2FkTWVtYmVyTmFtZV0gPSBwYXJzZXIucGFyc2UocGFyc2VkTWVzc2FnZS5ib2R5LnRvU3RyaW5nKCksIHBheWxvYWRTaGFwZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgLy8gcmVhZCBldmVudCBoZWFkZXJzCiAgICAgIHZhciBldmVudEhlYWRlck5hbWVzID0gZXZlbnRNb2RlbC5ldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50SGVhZGVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBuYW1lID0gZXZlbnRIZWFkZXJOYW1lc1tpXTsKICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlLmhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgICAgICAvLyBwYXJzZSB0aGUgaGVhZGVyIQogICAgICAgICAgICAgIHJlc3VsdFtuYW1lXSA9IGV2ZW50TW9kZWwubWVtYmVyc1tuYW1lXS50b1R5cGUocGFyc2VkTWVzc2FnZS5oZWFkZXJzW25hbWVdLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgb3V0cHV0ID0ge307CiAgICAgIG91dHB1dFtldmVudFR5cGUudmFsdWVdID0gcmVzdWx0OwogICAgICByZXR1cm4gb3V0cHV0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZUVycm9yKG1lc3NhZ2UpIHsKICAgICAgdmFyIGVycm9yQ29kZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLWNvZGUnXTsKICAgICAgdmFyIGVycm9yTWVzc2FnZSA9IG1lc3NhZ2UuaGVhZGVyc1snOmVycm9yLW1lc3NhZ2UnXTsKICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKGVycm9yTWVzc2FnZS52YWx1ZSB8fCBlcnJvck1lc3NhZ2UpOwogICAgICBlcnJvci5jb2RlID0gZXJyb3IubmFtZSA9IGVycm9yQ29kZS52YWx1ZSB8fCBlcnJvckNvZGU7CiAgICAgIHJldHVybiBlcnJvcjsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHBhcnNlRXZlbnQ6IHBhcnNlRXZlbnQKICB9OwogIAogIH0seyIuL3BhcnNlLW1lc3NhZ2UiOjMxfV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBJbnQ2NCA9IHJlcXVpcmUoJy4vaW50NjQnKS5JbnQ2NDsKICAKICB2YXIgc3BsaXRNZXNzYWdlID0gcmVxdWlyZSgnLi9zcGxpdC1tZXNzYWdlJykuc3BsaXRNZXNzYWdlOwogIAogIHZhciBCT09MRUFOX1RBRyA9ICdib29sZWFuJzsKICB2YXIgQllURV9UQUcgPSAnYnl0ZSc7CiAgdmFyIFNIT1JUX1RBRyA9ICdzaG9ydCc7CiAgdmFyIElOVF9UQUcgPSAnaW50ZWdlcic7CiAgdmFyIExPTkdfVEFHID0gJ2xvbmcnOwogIHZhciBCSU5BUllfVEFHID0gJ2JpbmFyeSc7CiAgdmFyIFNUUklOR19UQUcgPSAnc3RyaW5nJzsKICB2YXIgVElNRVNUQU1QX1RBRyA9ICd0aW1lc3RhbXAnOwogIHZhciBVVUlEX1RBRyA9ICd1dWlkJzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIEBwYXJhbSB7QnVmZmVyfSBoZWFkZXJzCiAgICovCiAgZnVuY3Rpb24gcGFyc2VIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgdmFyIG91dCA9IHt9OwogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB3aGlsZSAocG9zaXRpb24gPCBoZWFkZXJzLmxlbmd0aCkgewogICAgICAgICAgdmFyIG5hbWVMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKTsKICAgICAgICAgIHZhciBuYW1lID0gaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyBuYW1lTGVuZ3RoKS50b1N0cmluZygpOwogICAgICAgICAgcG9zaXRpb24gKz0gbmFtZUxlbmd0aDsKICAgICAgICAgIHN3aXRjaCAoaGVhZGVycy5yZWFkVUludDgocG9zaXRpb24rKykpIHsKICAgICAgICAgICAgICBjYXNlIDAgLyogYm9vbFRydWUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJPT0xFQU5fVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAxIC8qIGJvb2xGYWxzZSAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAyIC8qIGJ5dGUgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJZVEVfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDgocG9zaXRpb24rKykKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAzIC8qIHNob3J0ICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBTSE9SVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MTZCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA0IC8qIGludGVnZXIgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IElOVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5yZWFkSW50MzJCRShwb3NpdGlvbikKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gNDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA1IC8qIGxvbmcgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IExPTkdfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDYgLyogYnl0ZUFycmF5ICovOgogICAgICAgICAgICAgICAgICB2YXIgYmluYXJ5TGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDE2QkUocG9zaXRpb24pOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCSU5BUllfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgYmluYXJ5TGVuZ3RoKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBiaW5hcnlMZW5ndGg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNyAvKiBzdHJpbmcgKi86CiAgICAgICAgICAgICAgICAgIHZhciBzdHJpbmdMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFNUUklOR19UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiArIHN0cmluZ0xlbmd0aAogICAgICAgICAgICAgICAgICAgICAgKS50b1N0cmluZygpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IHN0cmluZ0xlbmd0aDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA4IC8qIHRpbWVzdGFtcCAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVElNRVNUQU1QX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgRGF0ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgSW50NjQoaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyA4KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlT2YoKQogICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDkgLyogdXVpZCAqLzoKICAgICAgICAgICAgICAgICAgdmFyIHV1aWRDaGFycyA9IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgMTYpCiAgICAgICAgICAgICAgICAgICAgICAudG9TdHJpbmcoJ2hleCcpOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAxNjsKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogVVVJRF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdXVpZENoYXJzLnN1YnN0cigwLCA4KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cig4LCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxMiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMTYsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDIwKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXplZCBoZWFkZXIgdHlwZSB0YWcnKTsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiBwYXJzZU1lc3NhZ2UobWVzc2FnZSkgewogICAgICB2YXIgcGFyc2VkID0gc3BsaXRNZXNzYWdlKG1lc3NhZ2UpOwogICAgICByZXR1cm4geyBoZWFkZXJzOiBwYXJzZUhlYWRlcnMocGFyc2VkLmhlYWRlcnMpLCBib2R5OiBwYXJzZWQuYm9keSB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgcGFyc2VNZXNzYWdlOiBwYXJzZU1lc3NhZ2UKICB9OwogIAogIH0seyIuL2ludDY0IjoyOSwiLi9zcGxpdC1tZXNzYWdlIjozMn1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL2NvcmUnKS51dGlsOwogIHZhciB0b0J1ZmZlciA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyOwogIAogIC8vIEFsbCBwcmVsdWRlIGNvbXBvbmVudHMgYXJlIHVuc2lnbmVkLCAzMi1iaXQgaW50ZWdlcnMKICB2YXIgUFJFTFVERV9NRU1CRVJfTEVOR1RIID0gNDsKICAvLyBUaGUgcHJlbHVkZSBjb25zaXN0cyBvZiB0d28gY29tcG9uZW50cwogIHZhciBQUkVMVURFX0xFTkdUSCA9IFBSRUxVREVfTUVNQkVSX0xFTkdUSCAqIDI7CiAgLy8gQ2hlY2tzdW1zIGFyZSBhbHdheXMgQ1JDMzIgaGFzaGVzLgogIHZhciBDSEVDS1NVTV9MRU5HVEggPSA0OwogIC8vIE1lc3NhZ2VzIG11c3QgaW5jbHVkZSBhIGZ1bGwgcHJlbHVkZSwgYSBwcmVsdWRlIGNoZWNrc3VtLCBhbmQgYSBtZXNzYWdlIGNoZWNrc3VtCiAgdmFyIE1JTklNVU1fTUVTU0FHRV9MRU5HVEggPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSCAqIDI7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogICAqLwogIGZ1bmN0aW9uIHNwbGl0TWVzc2FnZShtZXNzYWdlKSB7CiAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIobWVzc2FnZSkpIG1lc3NhZ2UgPSB0b0J1ZmZlcihtZXNzYWdlKTsKICAKICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoIDwgTUlOSU1VTV9NRVNTQUdFX0xFTkdUSCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm92aWRlZCBtZXNzYWdlIHRvbyBzaG9ydCB0byBhY2NvbW1vZGF0ZSBldmVudCBzdHJlYW0gbWVzc2FnZSBvdmVyaGVhZCcpOwogICAgICB9CiAgCiAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCAhPT0gbWVzc2FnZS5yZWFkVUludDMyQkUoMCkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUmVwb3J0ZWQgbWVzc2FnZSBsZW5ndGggZG9lcyBub3QgbWF0Y2ggcmVjZWl2ZWQgbWVzc2FnZSBsZW5ndGgnKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIFBSRUxVREVfTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIHByZWx1ZGUgY2hlY2tzdW0gc3BlY2lmaWVkIGluIHRoZSBtZXNzYWdlICgnICsKICAgICAgICAgICAgICBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSArCiAgICAgICAgICAgICAgJykgZG9lcyBub3QgbWF0Y2ggdGhlIGNhbGN1bGF0ZWQgQ1JDMzIgY2hlY2tzdW0uJwogICAgICAgICAgKTsKICAgICAgfQogIAogICAgICB2YXIgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCk7CiAgCiAgICAgIGlmICgKICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKQogICAgICAgICAgKQogICAgICApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnVGhlIG1lc3NhZ2UgY2hlY2tzdW0gZGlkIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWQgdmFsdWUgb2YgJyArCiAgICAgICAgICAgICAgICAgIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtCiAgICAgICAgICApOwogICAgICB9CiAgCiAgICAgIHZhciBoZWFkZXJzU3RhcnQgPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSDsKICAgICAgdmFyIGhlYWRlcnNFbmQgPSBoZWFkZXJzU3RhcnQgKyBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX01FTUJFUl9MRU5HVEgpOwogIAogICAgICByZXR1cm4gewogICAgICAgICAgaGVhZGVyczogbWVzc2FnZS5zbGljZShoZWFkZXJzU3RhcnQsIGhlYWRlcnNFbmQpLAogICAgICAgICAgYm9keTogbWVzc2FnZS5zbGljZShoZWFkZXJzRW5kLCBtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCksCiAgICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBzcGxpdE1lc3NhZ2U6IHNwbGl0TWVzc2FnZQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgU2VxdWVudGlhbEV4ZWN1dG9yID0gcmVxdWlyZSgnLi9zZXF1ZW50aWFsX2V4ZWN1dG9yJyk7CiAgdmFyIERJU0NPVkVSX0VORFBPSU5UID0gcmVxdWlyZSgnLi9kaXNjb3Zlcl9lbmRwb2ludCcpLmRpc2NvdmVyRW5kcG9pbnQ7CiAgLyoqCiAgICogVGhlIG5hbWVzcGFjZSB1c2VkIHRvIHJlZ2lzdGVyIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgZm9yIHJlcXVlc3QgYnVpbGRpbmcKICAgKiBhbmQgc2VuZGluZy4KICAgKi8KICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICAvKioKICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX0NSRURFTlRJQUxTCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyB3aGV0aGVyIHRoZSByZXF1ZXN0IGlzIGJlaW5nCiAgICAgKiAgIHNlbnQgd2l0aCBjcmVkZW50aWFscy4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1JFR0lPTgogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgd2hldGhlciB0aGUgcmVnaW9uIGlzIHNldAogICAgICogICBmb3IgYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcmVnaW9uIGNvbmZpZ3VyYXRpb24KICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT047CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1BBUkFNRVRFUlMKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIGlucHV0IHBhcmFtZXRlcnMgaW4gYSByZXF1ZXN0LgogICAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcGFyYW1ldGVycwogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlM7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICAgKiAgIEBleGFtcGxlIERpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24gZ2xvYmFsbHkKICAgICAqICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLAogICAgICogICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OKTsKICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogQCFhdHRyaWJ1dGUgU0VORAogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCBpbml0aWF0ZXMgdGhlIEhUVFAgY29ubmVjdGlvbiBmb3IgYQogICAgICogICByZXF1ZXN0IGJlaW5nIHNlbnQuIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH5zZW5kICdzZW5kJyBSZXF1ZXN0IGV2ZW50fQogICAgICogICBAZXhhbXBsZSBSZXBsYWNpbmcgdGhlIEhUVFAgaGFuZGxlcgogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQ7CiAgICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignc2VuZCcsIGxpc3RlbmVyKTsKICAgICAqICAgICByZXF1ZXN0Lm9uKCdzZW5kJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgIGN1c3RvbUhhbmRsZXIuc2VuZChyZXNwb25zZSk7CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAgICogICBAcmVhZG9ubHkKICAgICAqIEAhYXR0cmlidXRlIEhUVFBfREFUQQogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCByZWFkcyBkYXRhIGZyb20gdGhlIEhUVFAgY29ubmVjdGlvbiBpbiBvcmRlcgogICAgICogICB0byBidWlsZCB0aGUgcmVzcG9uc2UgZGF0YS4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fmh0dHBEYXRhICdodHRwRGF0YScgUmVxdWVzdCBldmVudH0uCiAgICAgKiAgIFJlbW92ZSB0aGlzIGhhbmRsZXIgaWYgeW91IGFyZSBvdmVycmlkaW5nIHRoZSAnaHR0cERhdGEnIGV2ZW50IGFuZAogICAgICogICBkbyBub3Qgd2FudCBleHRyYSBkYXRhIHByb2Nlc3NpbmcgYW5kIGJ1ZmZlcmluZyBvdmVyaGVhZC4KICAgICAqICAgQGV4YW1wbGUgRGlzYWJsaW5nIGRlZmF1bHQgZGF0YSBwcm9jZXNzaW5nCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgbGlzdGVuZXIpOwogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqICAgQHJlYWRvbmx5CiAgICAgKi8KICAgIENvcmU6IHt9IC8qIGRvYyBoYWNrICovCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBnZXRPcGVyYXRpb25BdXRodHlwZShyZXEpIHsKICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgcmV0dXJuICcnOwogICAgfQogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgcmV0dXJuIG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogIH0KICAKICBBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICBDb3JlOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkLCBhZGRBc3luYykgewogICAgICBhZGRBc3luYygnVkFMSURBVEVfQ1JFREVOVElBTFMnLCAndmFsaWRhdGUnLAogICAgICAgICAgZnVuY3Rpb24gVkFMSURBVEVfQ1JFREVOVElBTFMocmVxLCBkb25lKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhcmVxLnNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAgICAgICByZXEuc2VydmljZS5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKGVyciwKICAgICAgICAgICAgICB7Y29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnfSk7CiAgICAgICAgICB9CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1ZBTElEQVRFX1JFR0lPTicsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFR0lPTihyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmNvbmZpZy5yZWdpb24gJiYgIXJlcS5zZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHsKICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0JVSUxEX0lERU1QT1RFTkNZX1RPS0VOUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIEJVSUxEX0lERU1QT1RFTkNZX1RPS0VOUyhyZXEpIHsKICAgICAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgICBpZiAoIW9wZXJhdGlvbikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaWRlbXBvdGVudE1lbWJlcnMgPSBvcGVyYXRpb24uaWRlbXBvdGVudE1lbWJlcnM7CiAgICAgICAgaWYgKCFpZGVtcG90ZW50TWVtYmVycy5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gY3JlYXRlcyBhIGNvcHkgb2YgcGFyYW1zIHNvIHVzZXIncyBwYXJhbSBvYmplY3QgaXNuJ3QgbXV0YXRlZAogICAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHJlcS5wYXJhbXMpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gaWRlbXBvdGVudE1lbWJlcnMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAoIXBhcmFtc1tpZGVtcG90ZW50TWVtYmVyc1tpXV0pIHsKICAgICAgICAgICAgLy8gYWRkIHRoZSBtZW1iZXIKICAgICAgICAgICAgcGFyYW1zW2lkZW1wb3RlbnRNZW1iZXJzW2ldXSA9IEFXUy51dGlsLnV1aWQudjQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVxLnBhcmFtcyA9IHBhcmFtczsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUEFSQU1FVEVSUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIFZBTElEQVRFX1BBUkFNRVRFUlMocmVxKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgICAgICB2YXIgdmFsaWRhdGlvbiA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5wYXJhbVZhbGlkYXRpb247CiAgICAgICAgbmV3IEFXUy5QYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKS52YWxpZGF0ZShydWxlcywgcmVxLnBhcmFtcyk7CiAgICAgIH0pOwogIAogICAgICBhZGRBc3luYygnQ09NUFVURV9TSEEyNTYnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIENPTVBVVEVfU0hBMjU2KHJlcSwgZG9uZSkgewogICAgICAgIHJlcS5oYWx0SGFuZGxlcnNPbkVycm9yKCk7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgICAgdmFyIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXJlcS5zZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgICAgICAgaWYgKHJlcS5zZXJ2aWNlLmdldFNpZ25lckNsYXNzKHJlcSkgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICAgICAgICB2YXIgYm9keSA9IHJlcS5odHRwUmVxdWVzdC5ib2R5IHx8ICcnOwogICAgICAgICAgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgICAgfQogICAgICAgICAgQVdTLnV0aWwuY29tcHV0ZVNoYTI1Nihib2R5LCBmdW5jdGlvbihlcnIsIHNoYSkgewogICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgZG9uZShlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gc2hhOwogICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1NFVF9DT05URU5UX0xFTkdUSCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0NPTlRFTlRfTEVOR1RIKHJlcSkgewogICAgICAgIHZhciBhdXRodHlwZSA9IGdldE9wZXJhdGlvbkF1dGh0eXBlKHJlcSk7CiAgICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBBV1MudXRpbC5nZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSk7CiAgICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBBV1MudXRpbC5zdHJpbmcuYnl0ZUxlbmd0aChyZXEuaHR0cFJlcXVlc3QuYm9keSk7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gbGVuZ3RoOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChwYXlsb2FkTWVtYmVyICYmIHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZE1lbWJlci5yZXF1aXJlc0xlbmd0aCkgewogICAgICAgICAgICAgICAgLy9zdHJlYW1pbmcgcGF5bG9hZCByZXF1aXJlcyBsZW5ndGgoczMsIGdsYWNpZXIpCiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdXRodHlwZS5pbmRleE9mKCd1bnNpZ25lZC1ib2R5JykgPj0gMCkgewogICAgICAgICAgICAgICAgLy91bmJvdW5kZWQgc3RyZWFtaW5nIHBheWxvYWQobGV4LCBtZWRpYXN0b3JlKQogICAgICAgICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1RyYW5zZmVyLUVuY29kaW5nJ10gPSAnY2h1bmtlZCc7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnU0VUX0hUVFBfSE9TVCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0hUVFBfSE9TVChyZXEpIHsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gcmVxLmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3Q7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1JFU1RBUlQnLCAncmVzdGFydCcsIGZ1bmN0aW9uIFJFU1RBUlQoKSB7CiAgICAgICAgdmFyIGVyciA9IHRoaXMucmVzcG9uc2UuZXJyb3I7CiAgICAgICAgaWYgKCFlcnIgfHwgIWVyci5yZXRyeWFibGUpIHJldHVybjsKICAKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdCgKICAgICAgICAgIHRoaXMuc2VydmljZS5lbmRwb2ludCwKICAgICAgICAgIHRoaXMuc2VydmljZS5yZWdpb24KICAgICAgICApOwogIAogICAgICAgIGlmICh0aGlzLnJlc3BvbnNlLnJldHJ5Q291bnQgPCB0aGlzLnNlcnZpY2UuY29uZmlnLm1heFJldHJpZXMpIHsKICAgICAgICAgIHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCsrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKICAgICAgYWRkQXN5bmMoJ0RJU0NPVkVSX0VORFBPSU5UJywgJ3NpZ24nLCBESVNDT1ZFUl9FTkRQT0lOVCwgYWRkVG9IZWFkKTsKICAKICAgICAgYWRkQXN5bmMoJ1NJR04nLCAnc2lnbicsIGZ1bmN0aW9uIFNJR04ocmVxLCBkb25lKSB7CiAgICAgICAgdmFyIHNlcnZpY2UgPSByZXEuc2VydmljZTsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICAgIHZhciBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICAgIHZhciBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICAgIGlmICghc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHJldHVybiBkb25lKCk7IC8vIG5vbmUKICAKICAgICAgICBzZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbiAoZXJyLCBjcmVkZW50aWFscykgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgZGF0ZSA9IHNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKTsKICAgICAgICAgICAgdmFyIFNpZ25lckNsYXNzID0gc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXEpOwogICAgICAgICAgICB2YXIgc2lnbmVyID0gbmV3IFNpZ25lckNsYXNzKHJlcS5odHRwUmVxdWVzdCwKICAgICAgICAgICAgICBzZXJ2aWNlLmFwaS5zaWduaW5nTmFtZSB8fCBzZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzaWduYXR1cmVDYWNoZTogc2VydmljZS5jb25maWcuc2lnbmF0dXJlQ2FjaGUsCiAgICAgICAgICAgICAgICBvcGVyYXRpb246IG9wZXJhdGlvbiwKICAgICAgICAgICAgICAgIHNpZ25hdHVyZVZlcnNpb246IHNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2lnbmVyLnNldFNlcnZpY2VDbGllbnRJZChzZXJ2aWNlLl9jbGllbnRJZCk7CiAgCiAgICAgICAgICAgIC8vIGNsZWFyIG9sZCBhdXRob3JpemF0aW9uIGhlYWRlcnMKICAgICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ107CiAgICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snRGF0ZSddOwogICAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICAKICAgICAgICAgICAgLy8gYWRkIG5ldyBhdXRob3JpemF0aW9uCiAgICAgICAgICAgIHNpZ25lci5hZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKTsKICAgICAgICAgICAgcmVxLnNpZ25lZEF0ID0gZGF0ZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gZTsKICAgICAgICAgIH0KICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnVkFMSURBVEVfUkVTUE9OU0UnLCAndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIFZBTElEQVRFX1JFU1BPTlNFKHJlc3ApIHsKICAgICAgICBpZiAodGhpcy5zZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCB0aGlzKSkgewogICAgICAgICAgcmVzcC5kYXRhID0ge307CiAgICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzcC5kYXRhID0gbnVsbDsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdVbmtub3duRXJyb3InLCBtZXNzYWdlOiAnQW4gdW5rbm93biBlcnJvciBvY2N1cnJlZC4nfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1NFTkQnLCAnc2VuZCcsIGZ1bmN0aW9uIFNFTkQocmVzcCwgZG9uZSkgewogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLl9hYm9ydENhbGxiYWNrID0gZG9uZTsKICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICByZXNwLmRhdGEgPSBudWxsOwogIAogICAgICAgIGZ1bmN0aW9uIGNhbGxiYWNrKGh0dHBSZXNwKSB7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gPSBodHRwUmVzcDsKICAgICAgICAgIHZhciBzdHJlYW0gPSByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3Quc3RyZWFtOwogICAgICAgICAgdmFyIHNlcnZpY2UgPSByZXNwLnJlcXVlc3Quc2VydmljZTsKICAgICAgICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgICAgICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbjsKICAgICAgICAgIHZhciBvcGVyYXRpb24gPSBhcGkub3BlcmF0aW9uc1tvcGVyYXRpb25OYW1lXSB8fCB7fTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdoZWFkZXJzJywgZnVuY3Rpb24gb25IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoCiAgICAgICAgICAgICAgJ2h0dHBIZWFkZXJzJywKICAgICAgICAgICAgICBbc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCwgc3RhdHVzTWVzc2FnZV0KICAgICAgICAgICAgKTsKICAKICAgICAgICAgICAgaWYgKCFyZXNwLmh0dHBSZXNwb25zZS5zdHJlYW1pbmcpIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsgLy8gc3RyZWFtczIgQVBJIGNoZWNrCiAgICAgICAgICAgICAgICAvLyBpZiB3ZSBkZXRlY3QgZXZlbnQgc3RyZWFtcywgd2UncmUgZ29pbmcgdG8gaGF2ZSB0bwogICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRoZSBzdHJlYW0gaW1tZWRpYXRlbHkKICAgICAgICAgICAgICAgIGlmIChvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQgJiYgc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkpIHsKICAgICAgICAgICAgICAgICAgLy8gc2tpcCByZWFkaW5nIHRoZSBJbmNvbWluZ1N0cmVhbQogICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgCiAgICAgICAgICAgICAgICBodHRwUmVzcC5vbigncmVhZGFibGUnLCBmdW5jdGlvbiBvblJlYWRhYmxlKCkgewogICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGh0dHBSZXNwLnJlYWQoKTsKICAgICAgICAgICAgICAgICAgaWYgKGRhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBsZWdhY3kgc3RyZWFtcyBBUEkKICAgICAgICAgICAgICAgIGh0dHBSZXNwLm9uKCdkYXRhJywgZnVuY3Rpb24gb25EYXRhKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEYXRhJywgW2RhdGEsIHJlc3BdKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgCiAgICAgICAgICBodHRwUmVzcC5vbignZW5kJywgZnVuY3Rpb24gb25FbmQoKSB7CiAgICAgICAgICAgIGlmICghc3RyZWFtIHx8ICFzdHJlYW0uZGlkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgJiYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkpIHsKICAgICAgICAgICAgICAgIC8vIGRvbid0IGNvbmNhdGVuYXRlIHJlc3BvbnNlIGNodW5rcyB3aGVuIHN0cmVhbWluZyBldmVudCBzdHJlYW0gZGF0YSB3aGVuIHJlc3BvbnNlIGlzIHN1Y2Nlc3NmdWwKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb25lJyk7CiAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgZnVuY3Rpb24gcHJvZ3Jlc3MoaHR0cFJlc3ApIHsKICAgICAgICAgIGh0dHBSZXNwLm9uKCdzZW5kUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblNlbmRQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cFVwbG9hZFByb2dyZXNzJywgW3ZhbHVlLCByZXNwXSk7CiAgICAgICAgICB9KTsKICAKICAgICAgICAgIGh0dHBSZXNwLm9uKCdyZWNlaXZlUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblJlY2VpdmVQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvd25sb2FkUHJvZ3Jlc3MnLCBbdmFsdWUsIHJlc3BdKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgICAgIGlmIChlcnIuY29kZSAhPT0gJ1JlcXVlc3RBYm9ydGVkRXJyb3InKSB7CiAgICAgICAgICAgIHZhciBlcnJDb2RlID0gZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InID8gZXJyLmNvZGUgOiAnTmV0d29ya2luZ0Vycm9yJzsKICAgICAgICAgICAgZXJyID0gQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgICAgY29kZTogZXJyQ29kZSwKICAgICAgICAgICAgICByZWdpb246IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb24sCiAgICAgICAgICAgICAgaG9zdG5hbWU6IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNwLmVycm9yID0gZXJyOwogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBFcnJvcicsIFtyZXNwLmVycm9yLCByZXNwXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBleGVjdXRlU2VuZCgpIHsKICAgICAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgICAgIHZhciBodHRwT3B0aW9ucyA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBzdHJlYW0gPSBodHRwLmhhbmRsZVJlcXVlc3QocmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaywgZXJyb3IpOwogICAgICAgICAgICBwcm9ncmVzcyhzdHJlYW0pOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB0aW1lRGlmZiA9IChyZXNwLnJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIC0gdGhpcy5zaWduZWRBdCkgLyAxMDAwOwogICAgICAgIGlmICh0aW1lRGlmZiA+PSA2MCAqIDEwKSB7IC8vIGlmIHdlIHNpZ25lZCAxMG1pbiBhZ28sIHJlLXNpZ24KICAgICAgICAgIHRoaXMuZW1pdCgnc2lnbicsIFt0aGlzXSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgICAgICAgZWxzZSBleGVjdXRlU2VuZCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4ZWN1dGVTZW5kKCk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0hFQURFUlMnLCAnaHR0cEhlYWRlcnMnLAogICAgICAgICAgZnVuY3Rpb24gSFRUUF9IRUFERVJTKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3AsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlID0gc3RhdHVzTWVzc2FnZTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzID0gaGVhZGVyczsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gQVdTLnV0aWwuYnVmZmVyLnRvQnVmZmVyKCcnKTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzID0gW107CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMgPSAwOwogICAgICAgIHZhciBkYXRlSGVhZGVyID0gaGVhZGVycy5kYXRlIHx8IGhlYWRlcnMuRGF0ZTsKICAgICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICAgIGlmIChkYXRlSGVhZGVyKSB7CiAgICAgICAgICB2YXIgc2VydmVyVGltZSA9IERhdGUucGFyc2UoZGF0ZUhlYWRlcik7CiAgICAgICAgICBpZiAoc2VydmljZS5jb25maWcuY29ycmVjdENsb2NrU2tldwogICAgICAgICAgICAgICYmIHNlcnZpY2UuaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSkgewogICAgICAgICAgICBzZXJ2aWNlLmFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdIVFRQX0RBVEEnLCAnaHR0cERhdGEnLCBmdW5jdGlvbiBIVFRQX0RBVEEoY2h1bmssIHJlc3ApIHsKICAgICAgICBpZiAoY2h1bmspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc05vZGUoKSkgewogICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyArPSBjaHVuay5sZW5ndGg7CiAgCiAgICAgICAgICAgIHZhciB0b3RhbCA9IHJlc3AuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ107CiAgICAgICAgICAgIHZhciBwcm9ncmVzcyA9IHsgbG9hZGVkOiByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcywgdG90YWw6IHRvdGFsIH07CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFtwcm9ncmVzcywgcmVzcF0pOwogICAgICAgICAgfQogIAogICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5wdXNoKEFXUy51dGlsLmJ1ZmZlci50b0J1ZmZlcihjaHVuaykpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSFRUUF9ET05FJywgJ2h0dHBEb25lJywgZnVuY3Rpb24gSFRUUF9ET05FKHJlc3ApIHsKICAgICAgICAvLyBjb252ZXJ0IGJ1ZmZlcnMgYXJyYXkgaW50byBzaW5nbGUgYnVmZmVyCiAgICAgICAgaWYgKHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgJiYgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgYm9keSA9IEFXUy51dGlsLmJ1ZmZlci5jb25jYXQocmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyk7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gYm9keTsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzOwogICAgICAgIGRlbGV0ZSByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzOwogICAgICB9KTsKICAKICAgICAgYWRkKCdGSU5BTElaRV9FUlJPUicsICdyZXRyeScsIGZ1bmN0aW9uIEZJTkFMSVpFX0VSUk9SKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSkgewogICAgICAgICAgcmVzcC5lcnJvci5zdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdGhpcy5zZXJ2aWNlLnJldHJ5YWJsZUVycm9yKHJlc3AuZXJyb3IsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSU5WQUxJREFURV9DUkVERU5USUFMUycsICdyZXRyeScsIGZ1bmN0aW9uIElOVkFMSURBVEVfQ1JFREVOVElBTFMocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIHN3aXRjaCAocmVzcC5lcnJvci5jb2RlKSB7CiAgICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6IC8vIEVDMiBvbmx5CiAgICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW5FeGNlcHRpb24nOgogICAgICAgICAgY2FzZSAnRXhwaXJlZFRva2VuJzoKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgICAgICByZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuZXhwaXJlZCA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdFWFBJUkVEX1NJR05BVFVSRScsICdyZXRyeScsIGZ1bmN0aW9uIEVYUElSRURfU0lHTkFUVVJFKHJlc3ApIHsKICAgICAgICB2YXIgZXJyID0gcmVzcC5lcnJvcjsKICAgICAgICBpZiAoIWVycikgcmV0dXJuOwogICAgICAgIGlmICh0eXBlb2YgZXJyLmNvZGUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmIChlcnIuY29kZS5tYXRjaCgvU2lnbmF0dXJlLykgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL2V4cGlyZWQvKSkgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdDTE9DS19TS0VXRUQnLCAncmV0cnknLCBmdW5jdGlvbiBDTE9DS19TS0VXRUQocmVzcCkgewogICAgICAgIGlmICghcmVzcC5lcnJvcikgcmV0dXJuOwogICAgICAgIGlmICh0aGlzLnNlcnZpY2UuY2xvY2tTa2V3RXJyb3IocmVzcC5lcnJvcikKICAgICAgICAgICAgJiYgdGhpcy5zZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3KSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRURJUkVDVCcsICdyZXRyeScsIGZ1bmN0aW9uIFJFRElSRUNUKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvciAmJiByZXNwLmVycm9yLnN0YXR1c0NvZGUgPj0gMzAwICYmCiAgICAgICAgICAgIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA8IDQwMCAmJiByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKSB7CiAgICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmVuZHBvaW50ID0KICAgICAgICAgICAgbmV3IEFXUy5FbmRwb2ludChyZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKTsKICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVyc1snSG9zdCddID0gdGhpcy5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0OwogICAgICAgICAgcmVzcC5lcnJvci5yZWRpcmVjdCA9IHRydWU7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uIFJFVFJZX0NIRUNLKHJlc3ApIHsKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeURlbGF5ID0gMDsKICAgICAgICAgIH0gZWxzZSBpZiAocmVzcC5yZXRyeUNvdW50IDwgcmVzcC5tYXhSZXRyaWVzKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9IHRoaXMuc2VydmljZS5yZXRyeURlbGF5cyhyZXNwLnJldHJ5Q291bnQpIHx8IDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ1JFU0VUX1JFVFJZX1NUQVRFJywgJ2FmdGVyUmV0cnknLCBmdW5jdGlvbiBSRVNFVF9SRVRSWV9TVEFURShyZXNwLCBkb25lKSB7CiAgICAgICAgdmFyIGRlbGF5LCB3aWxsUmV0cnkgPSBmYWxzZTsKICAKICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgZGVsYXkgPSByZXNwLmVycm9yLnJldHJ5RGVsYXkgfHwgMDsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSAmJiByZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgICAgcmVzcC5yZXRyeUNvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgICAgcmVzcC5yZWRpcmVjdENvdW50Kys7CiAgICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIGlmICh3aWxsUmV0cnkpIHsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICAgICAgc2V0VGltZW91dChkb25lLCBkZWxheSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSksCiAgCiAgICBDb3JlUG9zdDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RGF0YScsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwogICAgICBhZGQoJ0VYVFJBQ1RfUkVRVUVTVF9JRCcsICdleHRyYWN0RXJyb3InLCBBV1MudXRpbC5leHRyYWN0UmVxdWVzdElkKTsKICAKICAgICAgYWRkKCdFTk9URk9VTkRfRVJST1InLCAnaHR0cEVycm9yJywgZnVuY3Rpb24gRU5PVEZPVU5EX0VSUk9SKGVycikgewogICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ05ldHdvcmtpbmdFcnJvcicgJiYgZXJyLmVycm5vID09PSAnRU5PVEZPVU5EJykgewogICAgICAgICAgdmFyIG1lc3NhZ2UgPSAnSW5hY2Nlc3NpYmxlIGhvc3Q6IGAnICsgZXJyLmhvc3RuYW1lICsKICAgICAgICAgICAgJ1wnLiBUaGlzIHNlcnZpY2UgbWF5IG5vdCBiZSBhdmFpbGFibGUgaW4gdGhlIGAnICsgZXJyLnJlZ2lvbiArCiAgICAgICAgICAgICdcJyByZWdpb24uJzsKICAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobWVzc2FnZSksIHsKICAgICAgICAgICAgY29kZTogJ1Vua25vd25FbmRwb2ludCcsCiAgICAgICAgICAgIHJlZ2lvbjogZXJyLnJlZ2lvbiwKICAgICAgICAgICAgaG9zdG5hbWU6IGVyci5ob3N0bmFtZSwKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlLAogICAgICAgICAgICBvcmlnaW5hbEVycm9yOiBlcnIKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIExvZ2dlcjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICBhZGQoJ0xPR19SRVFVRVNUJywgJ2NvbXBsZXRlJywgZnVuY3Rpb24gTE9HX1JFUVVFU1QocmVzcCkgewogICAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgICAgdmFyIGxvZ2dlciA9IHJlcS5zZXJ2aWNlLmNvbmZpZy5sb2dnZXI7CiAgICAgICAgaWYgKCFsb2dnZXIpIHJldHVybjsKICAgICAgICBmdW5jdGlvbiBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZSwgc2hhcGUpIHsKICAgICAgICAgIGlmICghc2hhcGUpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChpbnB1dFNoYXBlLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgICAgICB2YXIgc3RydWN0ID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGVOYW1lLCBzdWJTaGFwZSkgewogICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpbnB1dFNoYXBlLm1lbWJlcnMsIHN1YlNoYXBlTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgc3RydWN0W3N1YlNoYXBlTmFtZV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS5tZW1iZXJzW3N1YlNoYXBlTmFtZV0sIHN1YlNoYXBlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHN0cnVjdFtzdWJTaGFwZU5hbWVdID0gc3ViU2hhcGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIHN0cnVjdDsKICAgICAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2hhcGUsIGZ1bmN0aW9uKHN1YlNoYXBlLCBpbmRleCkgewogICAgICAgICAgICAgICAgbGlzdC5wdXNoKGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlciwgc3ViU2hhcGUpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICAgICAgY2FzZSAnbWFwJzoKICAgICAgICAgICAgICB2YXIgbWFwID0ge307CiAgICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgbWFwW2tleV0gPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS52YWx1ZSwgdmFsdWUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBtYXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKGlucHV0U2hhcGUuaXNTZW5zaXRpdmUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnKioqU2Vuc2l0aXZlSW5mb3JtYXRpb24qKionOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICBmdW5jdGlvbiBidWlsZE1lc3NhZ2UoKSB7CiAgICAgICAgICB2YXIgdGltZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgdmFyIGRlbHRhID0gKHRpbWUgLSByZXEuc3RhcnRUaW1lLmdldFRpbWUoKSkgLyAxMDAwOwogICAgICAgICAgdmFyIGFuc2kgPSBsb2dnZXIuaXNUVFkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICB2YXIgc3RhdHVzID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIHZhciBjZW5zb3JlZFBhcmFtcyA9IHJlcS5wYXJhbXM7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zICYmCiAgICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXSAmJgogICAgICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQKICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgaW5wdXRTaGFwZSA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICAgICAgICBjZW5zb3JlZFBhcmFtcyA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLCByZXEucGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJhbXMgPSByZXF1aXJlKCd1dGlsJykuaW5zcGVjdChjZW5zb3JlZFBhcmFtcywgdHJ1ZSwgbnVsbCk7CiAgICAgICAgICB2YXIgbWVzc2FnZSA9ICcnOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMzNtJzsKICAgICAgICAgIG1lc3NhZ2UgKz0gJ1tBV1MgJyArIHJlcS5zZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyICsgJyAnICsgc3RhdHVzOwogICAgICAgICAgbWVzc2FnZSArPSAnICcgKyBkZWx0YS50b1N0cmluZygpICsgJ3MgJyArIHJlc3AucmV0cnlDb3VudCArICcgcmV0cmllc10nOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMDsxbSc7CiAgICAgICAgICBtZXNzYWdlICs9ICcgJyArIEFXUy51dGlsLnN0cmluZy5sb3dlckZpcnN0KHJlcS5vcGVyYXRpb24pOwogICAgICAgICAgbWVzc2FnZSArPSAnKCcgKyBwYXJhbXMgKyAnKSc7CiAgICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswbSc7CiAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICB9CiAgCiAgICAgICAgdmFyIGxpbmUgPSBidWlsZE1lc3NhZ2UoKTsKICAgICAgICBpZiAodHlwZW9mIGxvZ2dlci5sb2cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGxvZ2dlci5sb2cobGluZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbG9nZ2VyLndyaXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBsb2dnZXIud3JpdGUobGluZSArICdcbicpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KSwKICAKICAgIEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBSZXN0OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3QnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUmVzdEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFJlc3RYbWw6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF94bWwnKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUXVlcnk6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pCiAgfTsKICAKICB9LHsiLi9jb3JlIjoxOCwiLi9kaXNjb3Zlcl9lbmRwb2ludCI6MjYsIi4vcHJvdG9jb2wvanNvbiI6NDYsIi4vcHJvdG9jb2wvcXVlcnkiOjQ3LCIuL3Byb3RvY29sL3Jlc3QiOjQ4LCIuL3Byb3RvY29sL3Jlc3RfanNvbiI6NDksIi4vcHJvdG9jb2wvcmVzdF94bWwiOjUwLCIuL3NlcXVlbnRpYWxfZXhlY3V0b3IiOjU4LCJ1dGlsIjo5N31dLDM0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIFRoZSBlbmRwb2ludCB0aGF0IGEgc2VydmljZSB3aWxsIHRhbGsgdG8sIGZvciBleGFtcGxlLAogICAqIGAnaHR0cHM6Ly9lYzIuYXAtc291dGhlYXN0LTEuYW1hem9uYXdzLmNvbSdgLiBJZgogICAqIHlvdSBuZWVkIHRvIG92ZXJyaWRlIGFuIGVuZHBvaW50IGZvciBhIHNlcnZpY2UsIHlvdSBjYW4KICAgKiBzZXQgdGhlIGVuZHBvaW50IG9uIGEgc2VydmljZSBieSBwYXNzaW5nIHRoZSBlbmRwb2ludAogICAqIG9iamVjdCB3aXRoIHRoZSBgZW5kcG9pbnRgIG9wdGlvbiBrZXk6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIGVwID0gbmV3IEFXUy5FbmRwb2ludCgnYXdzcHJveHkuZXhhbXBsZS5jb20nKTsKICAgKiB2YXIgczMgPSBuZXcgQVdTLlMzKHtlbmRwb2ludDogZXB9KTsKICAgKiBzMy5zZXJ2aWNlLmVuZHBvaW50Lmhvc3RuYW1lID09ICdhd3Nwcm94eS5leGFtcGxlLmNvbScKICAgKiBgYGAKICAgKgogICAqIE5vdGUgdGhhdCBpZiB5b3UgZG8gbm90IHNwZWNpZnkgYSBwcm90b2NvbCwgdGhlIHByb3RvY29sIHdpbGwKICAgKiBiZSBzZWxlY3RlZCBiYXNlZCBvbiB5b3VyIGN1cnJlbnQge0FXUy5jb25maWd9IGNvbmZpZ3VyYXRpb24uCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwcm90b2NvbAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcHJvdG9jb2wgKGh0dHAgb3IgaHR0cHMpIG9mIHRoZSBlbmRwb2ludAogICAqICAgICBVUkwKICAgKiBAIWF0dHJpYnV0ZSBob3N0bmFtZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgaG9zdCBwb3J0aW9uIG9mIHRoZSBlbmRwb2ludCwgZS5nLiwKICAgKiAgICAgZXhhbXBsZS5jb20KICAgKiBAIWF0dHJpYnV0ZSBob3N0CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBob3N0IHBvcnRpb24gb2YgdGhlIGVuZHBvaW50IGluY2x1ZGluZwogICAqICAgICB0aGUgcG9ydCwgZS5nLiwgZXhhbXBsZS5jb206ODAKICAgKiBAIWF0dHJpYnV0ZSBwb3J0CiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgcG9ydCBvZiB0aGUgZW5kcG9pbnQKICAgKiBAIWF0dHJpYnV0ZSBocmVmCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBmdWxsIFVSTCBvZiB0aGUgZW5kcG9pbnQKICAgKi8KICBBV1MuRW5kcG9pbnQgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIEVuZHBvaW50KGVuZHBvaW50KQogICAgICogICBDb25zdHJ1Y3RzIGEgbmV3IGVuZHBvaW50IGdpdmVuIGFuIGVuZHBvaW50IFVSTC4gSWYgdGhlCiAgICAgKiAgIFVSTCBvbWl0cyBhIHByb3RvY29sIChodHRwIG9yIGh0dHBzKSwgdGhlIGRlZmF1bHQgcHJvdG9jb2wKICAgICAqICAgc2V0IGluIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IHdpbGwgYmUgdXNlZC4KICAgICAqICAgQHBhcmFtIGVuZHBvaW50IFtTdHJpbmddIHRoZSBVUkwgdG8gY29uc3RydWN0IGFuIGVuZHBvaW50IGZyb20KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEVuZHBvaW50KGVuZHBvaW50LCBjb25maWcpIHsKICAgICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzbGFzaGVzJywgJ2F1dGgnLCAnaGFzaCcsICdzZWFyY2gnLCAncXVlcnknXSk7CiAgCiAgICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgPT09ICd1bmRlZmluZWQnIHx8IGVuZHBvaW50ID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGVuZHBvaW50OiAnICsgZW5kcG9pbnQpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHsKICAgICAgICByZXR1cm4gQVdTLnV0aWwuY29weShlbmRwb2ludCk7CiAgICAgIH0KICAKICAgICAgaWYgKCFlbmRwb2ludC5tYXRjaCgvXmh0dHAvKSkgewogICAgICAgIHZhciB1c2VTU0wgPSBjb25maWcgJiYgY29uZmlnLnNzbEVuYWJsZWQgIT09IHVuZGVmaW5lZCA/CiAgICAgICAgICBjb25maWcuc3NsRW5hYmxlZCA6IEFXUy5jb25maWcuc3NsRW5hYmxlZDsKICAgICAgICBlbmRwb2ludCA9ICh1c2VTU0wgPyAnaHR0cHMnIDogJ2h0dHAnKSArICc6Ly8nICsgZW5kcG9pbnQ7CiAgICAgIH0KICAKICAgICAgQVdTLnV0aWwudXBkYXRlKHRoaXMsIEFXUy51dGlsLnVybFBhcnNlKGVuZHBvaW50KSk7CiAgCiAgICAgIC8vIEVuc3VyZSB0aGUgcG9ydCBwcm9wZXJ0eSBpcyBzZXQgYXMgYW4gaW50ZWdlcgogICAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgICAgdGhpcy5wb3J0ID0gcGFyc2VJbnQodGhpcy5wb3J0LCAxMCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wb3J0ID0gdGhpcy5wcm90b2NvbCA9PT0gJ2h0dHBzOicgPyA0NDMgOiA4MDsKICAgICAgfQogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXF1ZXN0IG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICAgKiBhbmQgYm9keSBkYXRhIHNlbnQgYnkgYSBzZXJ2aWNlIHJlcXVlc3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtZXRob2QKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEhUVFAgbWV0aG9kIG9mIHRoZSByZXF1ZXN0CiAgICogQCFhdHRyaWJ1dGUgcGF0aAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcGF0aCBwb3J0aW9uIG9mIHRoZSBVUkksIGUuZy4sCiAgICogICAgICIvbGlzdC8/c3RhcnQ9NSZudW09MTAiCiAgICogQCFhdHRyaWJ1dGUgaGVhZGVycwogICAqICAgQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XQogICAqICAgICBhIG1hcCBvZiBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXF1ZXN0IGJvZHkgcGF5bG9hZAogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50CiAgICogICBAcmV0dXJuIFtBV1MuRW5kcG9pbnRdIHRoZSBlbmRwb2ludCBmb3IgdGhlIHJlcXVlc3QKICAgKiBAIWF0dHJpYnV0ZSByZWdpb24KICAgKiAgIEBhcGkgcHJpdmF0ZQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVnaW9uLCBmb3Igc2lnbmluZyBwdXJwb3NlcyBvbmx5LgogICAqLwogIEFXUy5IdHRwUmVxdWVzdCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pIHsKICAgICAgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgdGhpcy5tZXRob2QgPSAnUE9TVCc7CiAgICAgIHRoaXMucGF0aCA9IGVuZHBvaW50LnBhdGggfHwgJy8nOwogICAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgICAgdGhpcy5ib2R5ID0gJyc7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludDsKICAgICAgdGhpcy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuX3VzZXJBZ2VudCA9ICcnOwogICAgICB0aGlzLnNldFVzZXJBZ2VudCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldFVzZXJBZ2VudDogZnVuY3Rpb24gc2V0VXNlckFnZW50KCkgewogICAgICB0aGlzLl91c2VyQWdlbnQgPSB0aGlzLmhlYWRlcnNbdGhpcy5nZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCldID0gQVdTLnV0aWwudXNlckFnZW50KCk7CiAgICB9LAogIAogICAgZ2V0VXNlckFnZW50SGVhZGVyTmFtZTogZnVuY3Rpb24gZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpIHsKICAgICAgdmFyIHByZWZpeCA9IEFXUy51dGlsLmlzQnJvd3NlcigpID8gJ1gtQW16LScgOiAnJzsKICAgICAgcmV0dXJuIHByZWZpeCArICdVc2VyLUFnZW50JzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcHBlbmRUb1VzZXJBZ2VudDogZnVuY3Rpb24gYXBwZW5kVG9Vc2VyQWdlbnQoYWdlbnRQYXJ0aWFsKSB7CiAgICAgIGlmICh0eXBlb2YgYWdlbnRQYXJ0aWFsID09PSAnc3RyaW5nJyAmJiBhZ2VudFBhcnRpYWwpIHsKICAgICAgICB0aGlzLl91c2VyQWdlbnQgKz0gJyAnICsgYWdlbnRQYXJ0aWFsOwogICAgICB9CiAgICAgIHRoaXMuaGVhZGVyc1t0aGlzLmdldFVzZXJBZ2VudEhlYWRlck5hbWUoKV0gPSB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0VXNlckFnZW50OiBmdW5jdGlvbiBnZXRVc2VyQWdlbnQoKSB7CiAgICAgIHJldHVybiB0aGlzLl91c2VyQWdlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXJ0IG9mIHRoZSB7cGF0aH0gZXhjbHVkaW5nIHRoZQogICAgICogICBxdWVyeSBzdHJpbmcKICAgICAqLwogICAgcGF0aG5hbWU6IGZ1bmN0aW9uIHBhdGhuYW1lKCkgewogICAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCc/JywgMSlbMF07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBxdWVyeSBzdHJpbmcgcG9ydGlvbiBvZiB0aGUge3BhdGh9CiAgICAgKi8KICAgIHNlYXJjaDogZnVuY3Rpb24gc2VhcmNoKCkgewogICAgICB2YXIgcXVlcnkgPSB0aGlzLnBhdGguc3BsaXQoJz8nLCAyKVsxXTsKICAgICAgaWYgKHF1ZXJ5KSB7CiAgICAgICAgcXVlcnkgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHF1ZXJ5KTsKICAgICAgICByZXR1cm4gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeSk7CiAgICAgIH0KICAgICAgcmV0dXJuICcnOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiB1cGRhdGUgaHR0cFJlcXVlc3QgZW5kcG9pbnQgd2l0aCBlbmRwb2ludCBzdHJpbmcKICAgICAqLwogICAgdXBkYXRlRW5kcG9pbnQ6IGZ1bmN0aW9uIHVwZGF0ZUVuZHBvaW50KGVuZHBvaW50U3RyKSB7CiAgICAgIHZhciBuZXdFbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnRTdHIpOwogICAgICB0aGlzLmVuZHBvaW50ID0gbmV3RW5kcG9pbnQ7CiAgICAgIHRoaXMucGF0aCA9IG5ld0VuZHBvaW50LnBhdGggfHwgJy8nOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXNwb25zZSBvYmplY3QsIGVuY2Fwc3VsYXRpbmcgYWxsIEhUVFAgaGVhZGVyCiAgICogYW5kIGJvZHkgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RhdHVzQ29kZQogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIEhUVFAgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3BvbnNlIChlLmcuLCAyMDAsIDQwNCkKICAgKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAgICogICBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dCiAgICogICAgICBhIG1hcCBvZiByZXNwb25zZSBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICAgKiBAIWF0dHJpYnV0ZSBib2R5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXNwb25zZSBib2R5IHBheWxvYWQKICAgKiBAIWF0dHJpYnV0ZSBbcl0gc3RyZWFtaW5nCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoaXMgcmVzcG9uc2UgaXMgYmVpbmcgc3RyZWFtZWQgYXQgYSBsb3ctbGV2ZWwuCiAgICogICAgIERlZmF1bHRzIHRvIGBmYWxzZWAgKGJ1ZmZlcmVkIHJlYWRzKS4gRG8gbm90IG1vZGlmeSB0aGlzIG1hbnVhbGx5LCB1c2UKICAgKiAgICAge2NyZWF0ZVVuYnVmZmVyZWRTdHJlYW19IHRvIGNvbnZlcnQgdGhlIHN0cmVhbSB0byB1bmJ1ZmZlcmVkIG1vZGUKICAgKiAgICAgaW5zdGVhZC4KICAgKi8KICBBV1MuSHR0cFJlc3BvbnNlID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gSHR0cFJlc3BvbnNlKCkgewogICAgICB0aGlzLnN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuaGVhZGVycyA9IHt9OwogICAgICB0aGlzLmJvZHkgPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuc3RyZWFtID0gbnVsbDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIERpc2FibGVzIGJ1ZmZlcmluZyBvbiB0aGUgSFRUUCByZXNwb25zZSBhbmQgcmV0dXJucyB0aGUgc3RyZWFtIGZvciByZWFkaW5nLgogICAgICogQHJldHVybiBbU3RyZWFtLCBYTUxIdHRwUmVxdWVzdCwgbnVsbF0gdGhlIHVuZGVybHlpbmcgc3RyZWFtIG9iamVjdC4KICAgICAqICAgVXNlIHRoaXMgb2JqZWN0IHRvIGRpcmVjdGx5IHJlYWQgZGF0YSBvZmYgb2YgdGhlIHN0cmVhbS4KICAgICAqIEBub3RlIFRoaXMgb2JqZWN0IGlzIG9ubHkgYXZhaWxhYmxlIGFmdGVyIHRoZSB7QVdTLlJlcXVlc3R+aHR0cEhlYWRlcnN9CiAgICAgKiAgIGV2ZW50IGhhcyBmaXJlZC4gVGhpcyBtZXRob2QgbXVzdCBiZSBjYWxsZWQgcHJpb3IgdG8KICAgICAqICAge0FXUy5SZXF1ZXN0fmh0dHBEYXRhfS4KICAgICAqIEBleGFtcGxlIFRha2luZyBjb250cm9sIG9mIGEgc3RyZWFtCiAgICAgKiAgIHJlcXVlc3Qub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24oc3RhdHVzQ29kZSwgaGVhZGVycykgewogICAgICogICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgKiAgICAgICBpZiAoaGVhZGVycy5ldGFnID09PSAneHl6JykgewogICAgICogICAgICAgICAvLyBwaXBlIHRoZSBzdHJlYW0sIGRpc2FibGluZyBidWZmZXJpbmcKICAgICAqICAgICAgICAgdmFyIHN0cmVhbSA9IHRoaXMucmVzcG9uc2UuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKICAgICAqICAgICAgICAgc3RyZWFtLnBpcGUocHJvY2Vzcy5zdGRvdXQpOwogICAgICogICAgICAgfSBlbHNlIHsgLy8gYWJvcnQgdGhpcyByZXF1ZXN0IGFuZCBzZXQgYSBiZXR0ZXIgZXJyb3IgbWVzc2FnZQogICAgICogICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgKiAgICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBuZXcgRXJyb3IoJ0ludmFsaWQgRVRhZycpOwogICAgICogICAgICAgfQogICAgICogICAgIH0KICAgICAqICAgfSkuc2VuZChjb25zb2xlLmxvZyk7CiAgICAgKi8KICAgIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKSB7CiAgICAgIHRoaXMuc3RyZWFtaW5nID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuc3RyZWFtOwogICAgfQogIH0pOwogIAogIAogIEFXUy5IdHRwQ2xpZW50ID0gaW5oZXJpdCh7fSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UgPSBmdW5jdGlvbiBnZXRJbnN0YW5jZSgpIHsKICAgIGlmICh0aGlzLnNpbmdsZXRvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXMuc2luZ2xldG9uID0gbmV3IHRoaXMoKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnNpbmdsZXRvbjsKICB9OwogIAogIH0seyIuL2NvcmUiOjE4fV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKICByZXF1aXJlKCcuLi9odHRwJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlhIUkNsaWVudCA9IEFXUy51dGlsLmluaGVyaXQoewogICAgaGFuZGxlUmVxdWVzdDogZnVuY3Rpb24gaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGNhbGxiYWNrLCBlcnJDYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBlbmRwb2ludCA9IGh0dHBSZXF1ZXN0LmVuZHBvaW50OwogICAgICB2YXIgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTsKICAgICAgdmFyIGhyZWYgPSBlbmRwb2ludC5wcm90b2NvbCArICcvLycgKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgICAgaWYgKGVuZHBvaW50LnBvcnQgIT09IDgwICYmIGVuZHBvaW50LnBvcnQgIT09IDQ0MykgewogICAgICAgIGhyZWYgKz0gJzonICsgZW5kcG9pbnQucG9ydDsKICAgICAgfQogICAgICBocmVmICs9IGh0dHBSZXF1ZXN0LnBhdGg7CiAgCiAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKSwgaGVhZGVyc0VtaXR0ZWQgPSBmYWxzZTsKICAgICAgaHR0cFJlcXVlc3Quc3RyZWFtID0geGhyOwogIAogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMCkgcmV0dXJuOyAvLyAwIGNvZGUgaXMgaW52YWxpZAogICAgICAgIH0gY2F0Y2ggKGUpIHsgcmV0dXJuOyB9CiAgCiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA+PSB0aGlzLkhFQURFUlNfUkVDRUlWRUQgJiYgIWhlYWRlcnNFbWl0dGVkKSB7CiAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUgPSB4aHIuc3RhdHVzOwogICAgICAgICAgZW1pdHRlci5oZWFkZXJzID0gc2VsZi5wYXJzZUhlYWRlcnMoeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpKTsKICAgICAgICAgIGVtaXR0ZXIuZW1pdCgKICAgICAgICAgICAgJ2hlYWRlcnMnLAogICAgICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUsCiAgICAgICAgICAgIGVtaXR0ZXIuaGVhZGVycywKICAgICAgICAgICAgeGhyLnN0YXR1c1RleHQKICAgICAgICAgICk7CiAgICAgICAgICBoZWFkZXJzRW1pdHRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT09IHRoaXMuRE9ORSkgewogICAgICAgICAgc2VsZi5maW5pc2hSZXF1ZXN0KHhociwgZW1pdHRlcik7CiAgICAgICAgfQogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci51cGxvYWQuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgZW1pdHRlci5lbWl0KCdzZW5kUHJvZ3Jlc3MnLCBldnQpOwogICAgICB9KTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgIGVtaXR0ZXIuZW1pdCgncmVjZWl2ZVByb2dyZXNzJywgZXZ0KTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigndGltZW91dCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1RpbWVvdXQnKSwge2NvZGU6ICdUaW1lb3V0RXJyb3InfSkpOwogICAgICB9LCBmYWxzZSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ05ldHdvcmsgRmFpbHVyZScpLCB7CiAgICAgICAgICBjb2RlOiAnTmV0d29ya2luZ0Vycm9yJwogICAgICAgIH0pKTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignYWJvcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQnKSwgewogICAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InCiAgICAgICAgfSkpOwogICAgICB9LCBmYWxzZSk7CiAgCiAgICAgIGNhbGxiYWNrKGVtaXR0ZXIpOwogICAgICB4aHIub3BlbihodHRwUmVxdWVzdC5tZXRob2QsIGhyZWYsIGh0dHBPcHRpb25zLnhockFzeW5jICE9PSBmYWxzZSk7CiAgICAgIEFXUy51dGlsLmVhY2goaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ICE9PSAnQ29udGVudC1MZW5ndGgnICYmIGtleSAhPT0gJ1VzZXItQWdlbnQnICYmIGtleSAhPT0gJ0hvc3QnKSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBpZiAoaHR0cE9wdGlvbnMudGltZW91dCAmJiBodHRwT3B0aW9ucy54aHJBc3luYyAhPT0gZmFsc2UpIHsKICAgICAgICB4aHIudGltZW91dCA9IGh0dHBPcHRpb25zLnRpbWVvdXQ7CiAgICAgIH0KICAKICAgICAgaWYgKGh0dHBPcHRpb25zLnhocldpdGhDcmVkZW50aWFscykgewogICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICB9CiAgICAgIHRyeSB7IHhoci5yZXNwb25zZVR5cGUgPSAnYXJyYXlidWZmZXInOyB9IGNhdGNoIChlKSB7fQogIAogICAgICB0cnkgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5KSB7CiAgICAgICAgICB4aHIuc2VuZChodHRwUmVxdWVzdC5ib2R5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGhyLnNlbmQoKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGlmIChodHRwUmVxdWVzdC5ib2R5ICYmIHR5cGVvZiBodHRwUmVxdWVzdC5ib2R5LmJ1ZmZlciA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkuYnVmZmVyKTsgLy8gc2VuZCBBcnJheUJ1ZmZlciBkaXJlY3RseQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiBlbWl0dGVyOwogICAgfSwKICAKICAgIHBhcnNlSGVhZGVyczogZnVuY3Rpb24gcGFyc2VIZWFkZXJzKHJhd0hlYWRlcnMpIHsKICAgICAgdmFyIGhlYWRlcnMgPSB7fTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJhd0hlYWRlcnMuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgdmFyIGtleSA9IGxpbmUuc3BsaXQoJzonLCAxKVswXTsKICAgICAgICB2YXIgdmFsdWUgPSBsaW5lLnN1YnN0cmluZyhrZXkubGVuZ3RoICsgMik7CiAgICAgICAgaWYgKGtleS5sZW5ndGggPiAwKSBoZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpXSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnM7CiAgICB9LAogIAogICAgZmluaXNoUmVxdWVzdDogZnVuY3Rpb24gZmluaXNoUmVxdWVzdCh4aHIsIGVtaXR0ZXIpIHsKICAgICAgdmFyIGJ1ZmZlcjsKICAgICAgaWYgKHhoci5yZXNwb25zZVR5cGUgPT09ICdhcnJheWJ1ZmZlcicgJiYgeGhyLnJlc3BvbnNlKSB7CiAgICAgICAgdmFyIGFiID0geGhyLnJlc3BvbnNlOwogICAgICAgIGJ1ZmZlciA9IG5ldyBBV1MudXRpbC5CdWZmZXIoYWIuYnl0ZUxlbmd0aCk7CiAgICAgICAgdmFyIHZpZXcgPSBuZXcgVWludDhBcnJheShhYik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGJ1ZmZlcltpXSA9IHZpZXdbaV07CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHRyeSB7CiAgICAgICAgaWYgKCFidWZmZXIgJiYgdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBidWZmZXIgPSBuZXcgQVdTLnV0aWwuQnVmZmVyKHhoci5yZXNwb25zZVRleHQpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAKICAgICAgaWYgKGJ1ZmZlcikgZW1pdHRlci5lbWl0KCdkYXRhJywgYnVmZmVyKTsKICAgICAgZW1pdHRlci5lbWl0KCdlbmQnKTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5wcm90b3R5cGUgPSBBV1MuWEhSQ2xpZW50LnByb3RvdHlwZTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9IDE7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi9odHRwIjozNCwiZXZlbnRzIjo4Mn1dLDM2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uQnVpbGRlcigpIHsgfQogIAogIEpzb25CdWlsZGVyLnByb3RvdHlwZS5idWlsZCA9IGZ1bmN0aW9uKHZhbHVlLCBzaGFwZSkgewogICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHV0aWwuZWFjaChzdHJ1Y3R1cmUsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZSkgewogICAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W2xvY2F0aW9uTmFtZV0gPSByZXN1bHQ7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHN0cnVjdDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTGlzdChsaXN0LCBzaGFwZSkgewogICAgdmFyIG91dCA9IFtdOwogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXQucHVzaChyZXN1bHQpOwogICAgfSk7CiAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVNYXAobWFwLCBzaGFwZSkgewogICAgdmFyIG91dCA9IHt9OwogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25CdWlsZGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBKc29uUGFyc2VyKCkgeyB9CiAgCiAgSnNvblBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiB0cmFuc2xhdGUoSlNPTi5wYXJzZSh2YWx1ZSksIHNoYXBlKTsKICB9OwogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiB0cmFuc2xhdGVMaXN0KHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICAgIGlmIChzdHJ1Y3R1cmUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAKICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgIHZhciBzaGFwZU1lbWJlcnMgPSBzaGFwZS5tZW1iZXJzOwogICAgdXRpbC5lYWNoKHNoYXBlTWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3RydWN0dXJlLCBsb2NhdGlvbk5hbWUpKSB7CiAgICAgICAgdmFyIHZhbHVlID0gc3RydWN0dXJlW2xvY2F0aW9uTmFtZV07CiAgICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgc3RydWN0W25hbWVdID0gcmVzdWx0OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBzdHJ1Y3Q7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZUxpc3QobGlzdCwgc2hhcGUpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0gW107CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIG91dC5wdXNoKG51bGwpOwogICAgICBlbHNlIG91dC5wdXNoKHJlc3VsdCk7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZU1hcChtYXAsIHNoYXBlKSB7CiAgICBpZiAobWFwID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgb3V0ID0ge307CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IG51bGw7CiAgICAgIGVsc2Ugb3V0W2tleV0gPSByZXN1bHQ7CiAgICB9KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBzaGFwZS50b1R5cGUodmFsdWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEpzb25QYXJzZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sMzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBDb2xsZWN0aW9uID0gcmVxdWlyZSgnLi9jb2xsZWN0aW9uJyk7CiAgdmFyIE9wZXJhdGlvbiA9IHJlcXVpcmUoJy4vb3BlcmF0aW9uJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi9zaGFwZScpOwogIHZhciBQYWdpbmF0b3IgPSByZXF1aXJlKCcuL3BhZ2luYXRvcicpOwogIHZhciBSZXNvdXJjZVdhaXRlciA9IHJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBBcGkoYXBpLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBhcGkgPSBhcGkgfHwge307CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIG9wdGlvbnMuYXBpID0gdGhpczsKICAKICAgIGFwaS5tZXRhZGF0YSA9IGFwaS5tZXRhZGF0YSB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdpc0FwaScsIHRydWUsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGlWZXJzaW9uJywgYXBpLm1ldGFkYXRhLmFwaVZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50UHJlZml4JywgYXBpLm1ldGFkYXRhLmVuZHBvaW50UHJlZml4KTsKICAgIHByb3BlcnR5KHRoaXMsICdzaWduaW5nTmFtZScsIGFwaS5tZXRhZGF0YS5zaWduaW5nTmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZ2xvYmFsRW5kcG9pbnQnLCBhcGkubWV0YWRhdGEuZ2xvYmFsRW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ3NpZ25hdHVyZVZlcnNpb24nLCBhcGkubWV0YWRhdGEuc2lnbmF0dXJlVmVyc2lvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnanNvblZlcnNpb24nLCBhcGkubWV0YWRhdGEuanNvblZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ3RhcmdldFByZWZpeCcsIGFwaS5tZXRhZGF0YS50YXJnZXRQcmVmaXgpOwogICAgcHJvcGVydHkodGhpcywgJ3Byb3RvY29sJywgYXBpLm1ldGFkYXRhLnByb3RvY29sKTsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBhcGkubWV0YWRhdGEudGltZXN0YW1wRm9ybWF0KTsKICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBhcGkubWV0YWRhdGEueG1sTmFtZXNwYWNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhYmJyZXZpYXRpb24nLCBhcGkubWV0YWRhdGEuc2VydmljZUFiYnJldmlhdGlvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZnVsbE5hbWUnLCBhcGkubWV0YWRhdGEuc2VydmljZUZ1bGxOYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdzZXJ2aWNlSWQnLCBhcGkubWV0YWRhdGEuc2VydmljZUlkKTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2NsYXNzTmFtZScsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbmFtZSA9IGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uIHx8IGFwaS5tZXRhZGF0YS5zZXJ2aWNlRnVsbE5hbWU7CiAgICAgIGlmICghbmFtZSkgcmV0dXJuIG51bGw7CiAgCiAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoL15BbWF6b258QVdTXHMqfFwoLip8XHMrfFxXKy9nLCAnJyk7CiAgICAgIGlmIChuYW1lID09PSAnRWxhc3RpY0xvYWRCYWxhbmNpbmcnKSBuYW1lID0gJ0VMQic7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSk7CiAgCiAgICBmdW5jdGlvbiBhZGRFbmRwb2ludE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgaWYgKG9wZXJhdGlvbi5lbmRwb2ludG9wZXJhdGlvbiA9PT0gdHJ1ZSkgewogICAgICAgIHByb3BlcnR5KHNlbGYsICdlbmRwb2ludE9wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QobmFtZSkpOwogICAgICB9CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnb3BlcmF0aW9ucycsIG5ldyBDb2xsZWN0aW9uKGFwaS5vcGVyYXRpb25zLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgICAgcmV0dXJuIG5ldyBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKTsKICAgIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QsIGFkZEVuZHBvaW50T3BlcmF0aW9uKSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGVzJywgbmV3IENvbGxlY3Rpb24oYXBpLnNoYXBlcywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgc2hhcGUpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZSwgb3B0aW9ucyk7CiAgICB9KSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9ycycsIG5ldyBDb2xsZWN0aW9uKGFwaS5wYWdpbmF0b3JzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBwYWdpbmF0b3IpIHsKICAgICAgcmV0dXJuIG5ldyBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yLCBvcHRpb25zKTsKICAgIH0pKTsKICAKICAgIHByb3BlcnR5KHRoaXMsICd3YWl0ZXJzJywgbmV3IENvbGxlY3Rpb24oYXBpLndhaXRlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHdhaXRlcikgewogICAgICByZXR1cm4gbmV3IFJlc291cmNlV2FpdGVyKG5hbWUsIHdhaXRlciwgb3B0aW9ucyk7CiAgICB9LCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgYXBpLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIGFwaS5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBcGk7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL2NvbGxlY3Rpb24iOjM5LCIuL29wZXJhdGlvbiI6NDAsIi4vcGFnaW5hdG9yIjo0MSwiLi9yZXNvdXJjZV93YWl0ZXIiOjQyLCIuL3NoYXBlIjo0M31dLDM5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL3V0aWwnKS5tZW1vaXplZFByb3BlcnR5OwogIAogIGZ1bmN0aW9uIG1lbW9pemUobmFtZSwgdmFsdWUsIGZhY3RvcnksIG5hbWVUcikgewogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCBuYW1lVHIobmFtZSksIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZSk7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gQ29sbGVjdGlvbihpdGVyYWJsZSwgb3B0aW9ucywgZmFjdG9yeSwgbmFtZVRyLCBjYWxsYmFjaykgewogICAgbmFtZVRyID0gbmFtZVRyIHx8IFN0cmluZzsKICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgIGZvciAodmFyIGlkIGluIGl0ZXJhYmxlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGlkKSkgewogICAgICAgIG1lbW9pemUuY2FsbChzZWxmLCBpZCwgaXRlcmFibGVbaWRdLCBmYWN0b3J5LCBuYW1lVHIpOwogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soaWQsIGl0ZXJhYmxlW2lkXSk7CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuL3NoYXBlJyk7CiAgCiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIHByb3BlcnR5ID0gdXRpbC5wcm9wZXJ0eTsKICB2YXIgbWVtb2l6ZWRQcm9wZXJ0eSA9IHV0aWwubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgb3BlcmF0aW9uLm5hbWUgfHwgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIG9wZXJhdGlvbi5odHRwID0gb3BlcmF0aW9uLmh0dHAgfHwge307CiAgICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnQnLCBvcGVyYXRpb24uZW5kcG9pbnQpOwogICAgcHJvcGVydHkodGhpcywgJ2h0dHBNZXRob2QnLCBvcGVyYXRpb24uaHR0cC5tZXRob2QgfHwgJ1BPU1QnKTsKICAgIHByb3BlcnR5KHRoaXMsICdodHRwUGF0aCcsIG9wZXJhdGlvbi5odHRwLnJlcXVlc3RVcmkgfHwgJy8nKTsKICAgIHByb3BlcnR5KHRoaXMsICdhdXRodHlwZScsIG9wZXJhdGlvbi5hdXRodHlwZSB8fCAnJyk7CiAgICBwcm9wZXJ0eSgKICAgICAgdGhpcywKICAgICAgJ2VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQnLAogICAgICBvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkgPwogICAgICAgIChvcGVyYXRpb24uZW5kcG9pbnRkaXNjb3ZlcnkucmVxdWlyZWQgPyAnUkVRVUlSRUQnIDogJ09QVElPTkFMJykgOgogICAgICAnTlVMTCcKICAgICk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdpbnB1dCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIW9wZXJhdGlvbi5pbnB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmlucHV0LCBvcHRpb25zKTsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnb3V0cHV0JywgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghb3BlcmF0aW9uLm91dHB1dCkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLm91dHB1dCwgb3B0aW9ucyk7CiAgICB9KTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2Vycm9ycycsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGlzdCA9IFtdOwogICAgICBpZiAoIW9wZXJhdGlvbi5lcnJvcnMpIHJldHVybiBudWxsOwogIAogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9wZXJhdGlvbi5lcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsaXN0LnB1c2goU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5lcnJvcnNbaV0sIG9wdGlvbnMpKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbGlzdDsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9yJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBvcHRpb25zLmFwaS5wYWdpbmF0b3JzW25hbWVdOwogICAgfSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgb3BlcmF0aW9uLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIG9wZXJhdGlvbi5kb2N1bWVudGF0aW9uVXJsKTsKICAgIH0KICAKICAgIC8vIGlkZW1wb3RlbnRNZW1iZXJzIG9ubHkgdHJhY2tzIHRvcC1sZXZlbCBpbnB1dCBzaGFwZXMKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lkZW1wb3RlbnRNZW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IFtdOwogICAgICB2YXIgaW5wdXQgPSBzZWxmLmlucHV0OwogICAgICB2YXIgbWVtYmVycyA9IGlucHV0Lm1lbWJlcnM7CiAgICAgIGlmICghaW5wdXQubWVtYmVycykgewogICAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgICAgfQogICAgICBmb3IgKHZhciBuYW1lIGluIG1lbWJlcnMpIHsKICAgICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0lkZW1wb3RlbnQgPT09IHRydWUpIHsKICAgICAgICAgIGlkZW1wb3RlbnRNZW1iZXJzLnB1c2gobmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgIH0pOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaGFzRXZlbnRPdXRwdXQnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIG91dHB1dCA9IHNlbGYub3V0cHV0OwogICAgICByZXR1cm4gaGFzRXZlbnRTdHJlYW0ob3V0cHV0KTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBoYXNFdmVudFN0cmVhbSh0b3BMZXZlbFNoYXBlKSB7CiAgICB2YXIgbWVtYmVycyA9IHRvcExldmVsU2hhcGUubWVtYmVyczsKICAgIHZhciBwYXlsb2FkID0gdG9wTGV2ZWxTaGFwZS5wYXlsb2FkOwogIAogICAgaWYgKCF0b3BMZXZlbFNoYXBlLm1lbWJlcnMpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIAogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBtZW1iZXJzW3BheWxvYWRdOwogICAgICByZXR1cm4gcGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtOwogICAgfQogIAogICAgLy8gY2hlY2sgaWYgYW55IG1lbWJlciBpcyBhbiBldmVudCBzdHJlYW0KICAgIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0V2ZW50U3RyZWFtID09PSB0cnVlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBPcGVyYXRpb247CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL3NoYXBlIjo0M31dLDQxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcHJvcGVydHkgPSByZXF1aXJlKCcuLi91dGlsJykucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUGFnaW5hdG9yKG5hbWUsIHBhZ2luYXRvcikgewogICAgcHJvcGVydHkodGhpcywgJ2lucHV0VG9rZW4nLCBwYWdpbmF0b3IuaW5wdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ2xpbWl0S2V5JywgcGFnaW5hdG9yLmxpbWl0X2tleSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbW9yZVJlc3VsdHMnLCBwYWdpbmF0b3IubW9yZV9yZXN1bHRzKTsKICAgIHByb3BlcnR5KHRoaXMsICdvdXRwdXRUb2tlbicsIHBhZ2luYXRvci5vdXRwdXRfdG9rZW4pOwogICAgcHJvcGVydHkodGhpcywgJ3Jlc3VsdEtleScsIHBhZ2luYXRvci5yZXN1bHRfa2V5KTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBQYWdpbmF0b3I7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gUmVzb3VyY2VXYWl0ZXIobmFtZSwgd2FpdGVyLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgbmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKICAKICAgIGlmICh3YWl0ZXIub3BlcmF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdvcGVyYXRpb24nLCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KHdhaXRlci5vcGVyYXRpb24pKTsKICAgIH0KICAKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBrZXlzID0gWwogICAgICAndHlwZScsCiAgICAgICdkZXNjcmlwdGlvbicsCiAgICAgICdkZWxheScsCiAgICAgICdtYXhBdHRlbXB0cycsCiAgICAgICdhY2NlcHRvcnMnCiAgICBdOwogIAogICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgdmFsdWUgPSB3YWl0ZXJba2V5XTsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgcHJvcGVydHkoc2VsZiwga2V5LCB2YWx1ZSk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFJlc291cmNlV2FpdGVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwogIAogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIAogIGZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUpIHsKICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHV0aWwucHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUpIHsKICAgIGlmICghb2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZVtuYW1lXSkgewogICAgICB1dGlsLm1lbW9pemVkUHJvcGVydHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gU2hhcGUoc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgcHJvcGVydHkodGhpcywgJ3NoYXBlJywgc2hhcGUuc2hhcGUpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAndHlwZScsIHNoYXBlLnR5cGUpOwogICAgcHJvcGVydHkodGhpcywgJ2VudW0nLCBzaGFwZS5lbnVtKTsKICAgIHByb3BlcnR5KHRoaXMsICdtaW4nLCBzaGFwZS5taW4pOwogICAgcHJvcGVydHkodGhpcywgJ21heCcsIHNoYXBlLm1heCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncGF0dGVybicsIHNoYXBlLnBhdHRlcm4pOwogICAgcHJvcGVydHkodGhpcywgJ2xvY2F0aW9uJywgc2hhcGUubG9jYXRpb24gfHwgdGhpcy5sb2NhdGlvbiB8fCAnYm9keScpOwogICAgcHJvcGVydHkodGhpcywgJ25hbWUnLCB0aGlzLm5hbWUgfHwgc2hhcGUueG1sTmFtZSB8fCBzaGFwZS5xdWVyeU5hbWUgfHwKICAgICAgc2hhcGUubG9jYXRpb25OYW1lIHx8IG1lbWJlck5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzU3RyZWFtaW5nJywgc2hhcGUuc3RyZWFtaW5nIHx8IHRoaXMuaXNTdHJlYW1pbmcgfHwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVzTGVuZ3RoJywgc2hhcGUucmVxdWlyZXNMZW5ndGgsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0NvbXBvc2l0ZScsIHNoYXBlLmlzQ29tcG9zaXRlIHx8IGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1NoYXBlJywgdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzUXVlcnlOYW1lJywgQm9vbGVhbihzaGFwZS5xdWVyeU5hbWUpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNMb2NhdGlvbk5hbWUnLCBCb29sZWFuKHNoYXBlLmxvY2F0aW9uTmFtZSksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0lkZW1wb3RlbnQnLCBzaGFwZS5pZGVtcG90ZW5jeVRva2VuID09PSB0cnVlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0pzb25WYWx1ZScsIHNoYXBlLmpzb252YWx1ZSA9PT0gdHJ1ZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNTZW5zaXRpdmUnLCBzaGFwZS5zZW5zaXRpdmUgPT09IHRydWUgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5zZW5zaXRpdmUgPT09IHRydWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRTdHJlYW0nLCBCb29sZWFuKHNoYXBlLmV2ZW50c3RyZWFtKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnQnLCBCb29sZWFuKHNoYXBlLmV2ZW50KSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRQYXlsb2FkJywgQm9vbGVhbihzaGFwZS5ldmVudHBheWxvYWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudEhlYWRlcicsIEJvb2xlYW4oc2hhcGUuZXZlbnRoZWFkZXIpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNUaW1lc3RhbXBGb3JtYXRTZXQnLCBCb29sZWFuKHNoYXBlLnRpbWVzdGFtcEZvcm1hdCkgfHwgc2hhcGUucHJvdG90eXBlICYmIHNoYXBlLnByb3RvdHlwZS5pc1RpbWVzdGFtcEZvcm1hdFNldCA9PT0gdHJ1ZSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50RGlzY292ZXJ5SWQnLCBCb29sZWFuKHNoYXBlLmVuZHBvaW50ZGlzY292ZXJ5aWQpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaG9zdExhYmVsJywgQm9vbGVhbihzaGFwZS5ob3N0TGFiZWwpLCBmYWxzZSk7CiAgCiAgICBpZiAob3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgc2hhcGUuZG9jdW1lbnRhdGlvbik7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uVXJsJywgc2hhcGUuZG9jdW1lbnRhdGlvblVybCk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUueG1sQXR0cmlidXRlKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdpc1htbEF0dHJpYnV0ZScsIHNoYXBlLnhtbEF0dHJpYnV0ZSB8fCBmYWxzZSk7CiAgICB9CiAgCiAgICAvLyB0eXBlIGNvbnZlcnNpb24gYW5kIHBhcnNpbmcKICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBudWxsKTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiAnJzsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaGFwZS5ub3JtYWxpemVkVHlwZXMgPSB7CiAgICBjaGFyYWN0ZXI6ICdzdHJpbmcnLAogICAgZG91YmxlOiAnZmxvYXQnLAogICAgbG9uZzogJ2ludGVnZXInLAogICAgc2hvcnQ6ICdpbnRlZ2VyJywKICAgIGJpZ2ludGVnZXI6ICdpbnRlZ2VyJywKICAgIGJpZ2RlY2ltYWw6ICdmbG9hdCcsCiAgICBibG9iOiAnYmluYXJ5JwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUudHlwZXMgPSB7CiAgICAnc3RydWN0dXJlJzogU3RydWN0dXJlU2hhcGUsCiAgICAnbGlzdCc6IExpc3RTaGFwZSwKICAgICdtYXAnOiBNYXBTaGFwZSwKICAgICdib29sZWFuJzogQm9vbGVhblNoYXBlLAogICAgJ3RpbWVzdGFtcCc6IFRpbWVzdGFtcFNoYXBlLAogICAgJ2Zsb2F0JzogRmxvYXRTaGFwZSwKICAgICdpbnRlZ2VyJzogSW50ZWdlclNoYXBlLAogICAgJ3N0cmluZyc6IFN0cmluZ1NoYXBlLAogICAgJ2Jhc2U2NCc6IEJhc2U2NFNoYXBlLAogICAgJ2JpbmFyeSc6IEJpbmFyeVNoYXBlCiAgfTsKICAKICBTaGFwZS5yZXNvbHZlID0gZnVuY3Rpb24gcmVzb2x2ZShzaGFwZSwgb3B0aW9ucykgewogICAgaWYgKHNoYXBlLnNoYXBlKSB7CiAgICAgIHZhciByZWZTaGFwZSA9IG9wdGlvbnMuYXBpLnNoYXBlc1tzaGFwZS5zaGFwZV07CiAgICAgIGlmICghcmVmU2hhcGUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHNoYXBlIHJlZmVyZW5jZTogJyArIHNoYXBlLnNoYXBlKTsKICAgICAgfQogIAogICAgICByZXR1cm4gcmVmU2hhcGU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwogIAogIFNoYXBlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogICAgaWYgKHNoYXBlLmlzU2hhcGUpIHJldHVybiBzaGFwZTsKICAKICAgIHZhciByZWZTaGFwZSA9IFNoYXBlLnJlc29sdmUoc2hhcGUsIG9wdGlvbnMpOwogICAgaWYgKHJlZlNoYXBlKSB7CiAgICAgIHZhciBmaWx0ZXJlZEtleXMgPSBPYmplY3Qua2V5cyhzaGFwZSk7CiAgICAgIGlmICghb3B0aW9ucy5kb2N1bWVudGF0aW9uKSB7CiAgICAgICAgZmlsdGVyZWRLZXlzID0gZmlsdGVyZWRLZXlzLmZpbHRlcihmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICByZXR1cm4gIW5hbWUubWF0Y2goL2RvY3VtZW50YXRpb24vKTsKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICAvLyBjcmVhdGUgYW4gaW5saW5lIHNoYXBlIHdpdGggZXh0cmEgbWVtYmVycwogICAgICB2YXIgSW5saW5lU2hhcGUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZWZTaGFwZS5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKTsKICAgICAgfTsKICAgICAgSW5saW5lU2hhcGUucHJvdG90eXBlID0gcmVmU2hhcGU7CiAgICAgIHJldHVybiBuZXcgSW5saW5lU2hhcGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHNldCB0eXBlIGlmIG5vdCBzZXQKICAgICAgaWYgKCFzaGFwZS50eXBlKSB7CiAgICAgICAgaWYgKHNoYXBlLm1lbWJlcnMpIHNoYXBlLnR5cGUgPSAnc3RydWN0dXJlJzsKICAgICAgICBlbHNlIGlmIChzaGFwZS5tZW1iZXIpIHNoYXBlLnR5cGUgPSAnbGlzdCc7CiAgICAgICAgZWxzZSBpZiAoc2hhcGUua2V5KSBzaGFwZS50eXBlID0gJ21hcCc7CiAgICAgICAgZWxzZSBzaGFwZS50eXBlID0gJ3N0cmluZyc7CiAgICAgIH0KICAKICAgICAgLy8gbm9ybWFsaXplIHR5cGVzCiAgICAgIHZhciBvcmlnVHlwZSA9IHNoYXBlLnR5cGU7CiAgICAgIGlmIChTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV0pIHsKICAgICAgICBzaGFwZS50eXBlID0gU2hhcGUubm9ybWFsaXplZFR5cGVzW3NoYXBlLnR5cGVdOwogICAgICB9CiAgCiAgICAgIGlmIChTaGFwZS50eXBlc1tzaGFwZS50eXBlXSkgewogICAgICAgIHJldHVybiBuZXcgU2hhcGUudHlwZXNbc2hhcGUudHlwZV0oc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5yZWNvZ25pemVkIHNoYXBlIHR5cGU6ICcgKyBvcmlnVHlwZSk7CiAgICAgIH0KICAgIH0KICB9OwogIAogIGZ1bmN0aW9uIENvbXBvc2l0ZVNoYXBlKHNoYXBlKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgdHJ1ZSk7CiAgCiAgICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdmbGF0dGVuZWQnLCBzaGFwZS5mbGF0dGVuZWQgfHwgZmFsc2UpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBTdHJ1Y3R1cmVTaGFwZShzaGFwZSwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVpcmVkTWFwID0gbnVsbCwgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICAKICAgIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoZmlyc3RJbml0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIHt9OyB9KTsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCB7fSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJOYW1lcycsIFtdKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgW10pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0pOwogICAgfQogIAogICAgaWYgKHNoYXBlLm1lbWJlcnMpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCBuZXcgQ29sbGVjdGlvbihzaGFwZS5tZW1iZXJzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG1lbWJlciwgb3B0aW9ucywgbmFtZSk7CiAgICAgIH0pKTsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2hhcGUueG1sT3JkZXIgfHwgT2JqZWN0LmtleXMoc2hhcGUubWVtYmVycyk7CiAgICAgIH0pOwogIAogICAgICBpZiAoc2hhcGUuZXZlbnQpIHsKICAgICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdldmVudFBheWxvYWRNZW1iZXJOYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbWVtYmVycyA9IHNlbGYubWVtYmVyczsKICAgICAgICAgIHZhciBtZW1iZXJOYW1lcyA9IHNlbGYubWVtYmVyTmFtZXM7CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgcGF5bG9hZHMKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbWVtYmVyTmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtZW1iZXJzW21lbWJlck5hbWVzW2ldXS5pc0V2ZW50UGF5bG9hZCkgewogICAgICAgICAgICAgIHJldHVybiBtZW1iZXJOYW1lc1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50SGVhZGVyTWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBtZW1iZXJzID0gc2VsZi5tZW1iZXJzOwogICAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICAgIHZhciBldmVudEhlYWRlck1lbWJlck5hbWVzID0gW107CiAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgbWVtYmVycyB0byBmaW5kIG9uZXMgdGhhdCBhcmUgZXZlbnQgaGVhZGVycwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKG1lbWJlcnNbbWVtYmVyTmFtZXNbaV1dLmlzRXZlbnRIZWFkZXIpIHsKICAgICAgICAgICAgICBldmVudEhlYWRlck1lbWJlck5hbWVzLnB1c2gobWVtYmVyTmFtZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnRIZWFkZXJNZW1iZXJOYW1lczsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIAogICAgaWYgKHNoYXBlLnJlcXVpcmVkKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlZCcsIHNoYXBlLnJlcXVpcmVkKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2lzUmVxdWlyZWQnLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgaWYgKCFyZXF1aXJlZE1hcCkgewogICAgICAgICAgcmVxdWlyZWRNYXAgPSB7fTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hhcGUucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVxdWlyZWRNYXBbc2hhcGUucmVxdWlyZWRbaV1dID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIHJlcXVpcmVkTWFwW25hbWVdOwogICAgICB9LCBmYWxzZSwgdHJ1ZSk7CiAgICB9CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0V3JhcHBlcicsIHNoYXBlLnJlc3VsdFdyYXBwZXIgfHwgbnVsbCk7CiAgCiAgICBpZiAoc2hhcGUucGF5bG9hZCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAncGF5bG9hZCcsIHNoYXBlLnBheWxvYWQpOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygc2hhcGUueG1sTmFtZXNwYWNlID09PSAnb2JqZWN0JykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlUHJlZml4Jywgc2hhcGUueG1sTmFtZXNwYWNlLnByZWZpeCk7CiAgICAgIHByb3BlcnR5KHRoaXMsICd4bWxOYW1lc3BhY2VVcmknLCBzaGFwZS54bWxOYW1lc3BhY2UudXJpKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTGlzdFNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKGZpcnN0SW5pdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiBbXTsgfSk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUubWVtYmVyKSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ21lbWJlcicsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUubWVtYmVyLCBvcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgCiAgICBpZiAodGhpcy5mbGF0dGVuZWQpIHsKICAgICAgdmFyIG9sZE5hbWUgPSB0aGlzLm5hbWU7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ25hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc2VsZi5tZW1iZXIubmFtZSB8fCBvbGROYW1lOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gTWFwU2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIHZhciBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogICAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChmaXJzdEluaXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAna2V5JywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgICAgcHJvcGVydHkodGhpcywgJ3ZhbHVlJywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgIH0KICAKICAgIGlmIChzaGFwZS5rZXkpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAna2V5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5rZXksIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICAgIGlmIChzaGFwZS52YWx1ZSkgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICd2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUudmFsdWUsIG9wdGlvbnMpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gVGltZXN0YW1wU2hhcGUoc2hhcGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoc2hhcGUudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBzaGFwZS50aW1lc3RhbXBGb3JtYXQpOwogICAgfSBlbHNlIGlmIChzZWxmLmlzVGltZXN0YW1wRm9ybWF0U2V0ICYmIHRoaXMudGltZXN0YW1wRm9ybWF0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCB0aGlzLnRpbWVzdGFtcEZvcm1hdCk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAncmZjODIyJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdpc284NjAxJyk7CiAgICB9IGVsc2UgaWYgKHRoaXMuYXBpKSB7CiAgICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgICBjYXNlICdqc29uJzoKICAgICAgICBjYXNlICdyZXN0LWpzb24nOgogICAgICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICd1bml4VGltZXN0YW1wJyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdyZXN0LXhtbCc6CiAgICAgICAgY2FzZSAncXVlcnknOgogICAgICAgIGNhc2UgJ2VjMic6CiAgICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ2lzbzg2MDEnKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZS50b1VUQ1N0cmluZyA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIHZhbHVlOwogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8KICAgICAgICAgICAgIHV0aWwuZGF0ZS5wYXJzZVRpbWVzdGFtcCh2YWx1ZSkgOiBudWxsOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHV0aWwuZGF0ZS5mb3JtYXQodmFsdWUsIHNlbGYudGltZXN0YW1wRm9ybWF0KTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIFN0cmluZ1NoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHZhciBudWxsTGVzc1Byb3RvY29scyA9IFsncmVzdC14bWwnLCAncXVlcnknLCAnZWMyJ107CiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gdGhpcy5hcGkgJiYgbnVsbExlc3NQcm90b2NvbHMuaW5kZXhPZih0aGlzLmFwaS5wcm90b2NvbCkgPiAtMSA/CiAgICAgICAgdmFsdWUgfHwgJycgOiB2YWx1ZTsKICAgICAgaWYgKHRoaXMuaXNKc29uVmFsdWUpIHsKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZS50b1N0cmluZyA9PT0gJ2Z1bmN0aW9uJyA/CiAgICAgICAgdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlOwogICAgfTsKICAKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHRoaXMuaXNKc29uVmFsdWUgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZTsKICAgIH07CiAgfQogIAogIGZ1bmN0aW9uIEZsb2F0U2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbHVlKTsKICAgIH07CiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IHRoaXMudG9UeXBlOwogIH0KICAKICBmdW5jdGlvbiBJbnRlZ2VyU2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdGhpcy50b1R5cGU7CiAgfQogIAogIGZ1bmN0aW9uIEJpbmFyeVNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIGJ1ZiA9IHV0aWwuYmFzZTY0LmRlY29kZSh2YWx1ZSk7CiAgICAgIGlmICh0aGlzLmlzU2Vuc2l0aXZlICYmIHV0aWwuaXNOb2RlKCkgJiYgdHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgICAvKiBOb2RlLmpzIGNhbiBjcmVhdGUgYSBCdWZmZXIgdGhhdCBpcyBub3QgaXNvbGF0ZWQuCiAgICAgKiBpLmUuIGJ1Zi5ieXRlTGVuZ3RoICE9PSBidWYuYnVmZmVyLmJ5dGVMZW5ndGgKICAgICAqIFRoaXMgbWVhbnMgdGhhdCB0aGUgc2Vuc2l0aXZlIGRhdGEgaXMgYWNjZXNzaWJsZSB0byBhbnlvbmUgd2l0aCBhY2Nlc3MgdG8gYnVmLmJ1ZmZlci4KICAgICAqIElmIHRoaXMgaXMgdGhlIG5vZGUgc2hhcmVkIEJ1ZmZlciwgdGhlbiBvdGhlciBjb2RlIHdpdGhpbiB0aGlzIHByb2Nlc3MgX2NvdWxkXyBmaW5kIHRoaXMgc2VjcmV0LgogICAgICogQ29weSBzZW5zaXRpdmUgZGF0YSB0byBhbiBpc29sYXRlZCBCdWZmZXIgYW5kIHplcm8gdGhlIHNlbnNpdGl2ZSBkYXRhLgogICAgICogV2hpbGUgdGhpcyBpcyBzYWZlIHRvIGRvIGhlcmUsIGNvcHlpbmcgdGhpcyBjb2RlIHNvbWV3aGVyZSBlbHNlIG1heSBwcm9kdWNlIHVuZXhwZWN0ZWQgcmVzdWx0cy4KICAgICAqLwogICAgICAgIHZhciBzZWN1cmVCdWYgPSB1dGlsLkJ1ZmZlci5hbGxvYyhidWYubGVuZ3RoLCBidWYpOwogICAgICAgIGJ1Zi5maWxsKDApOwogICAgICAgIGJ1ZiA9IHNlY3VyZUJ1ZjsKICAgICAgfQogICAgICByZXR1cm4gYnVmOwogICAgfTsKICAgIHRoaXMudG9XaXJlRm9ybWF0ID0gdXRpbC5iYXNlNjQuZW5jb2RlOwogIH0KICAKICBmdW5jdGlvbiBCYXNlNjRTaGFwZSgpIHsKICAgIEJpbmFyeVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQogIAogIGZ1bmN0aW9uIEJvb2xlYW5TaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlOwogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB2YWx1ZSA9PT0gJ3RydWUnOwogICAgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUuc2hhcGVzID0gewogICAgU3RydWN0dXJlU2hhcGU6IFN0cnVjdHVyZVNoYXBlLAogICAgTGlzdFNoYXBlOiBMaXN0U2hhcGUsCiAgICBNYXBTaGFwZTogTWFwU2hhcGUsCiAgICBTdHJpbmdTaGFwZTogU3RyaW5nU2hhcGUsCiAgICBCb29sZWFuU2hhcGU6IEJvb2xlYW5TaGFwZSwKICAgIEJhc2U2NFNoYXBlOiBCYXNlNjRTaGFwZQogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBTaGFwZTsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vY29sbGVjdGlvbiI6Mzl9XSw0NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5QYXJhbVZhbGlkYXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgdmFsaWRhdG9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gdmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUKICAgICAqICAgICB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZQogICAgICogICAgIHJlcXVlc3QuIFBhc3MgYSBtYXAgdG8gZW5hYmxlIGFueSBvZiB0aGUgZm9sbG93aW5nIHNwZWNpZmljCiAgICAgKiAgICAgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgICAqCiAgICAgKiAgICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICAgKiAgICAgICB0byBgdHJ1ZWAuCiAgICAgKiAgICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAgICogICAgICAgY29uc3RyYWludC4KICAgICAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAgICogICAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgICAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBQYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKSB7CiAgICAgIGlmICh2YWxpZGF0aW9uID09PSB0cnVlIHx8IHZhbGlkYXRpb24gPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhbGlkYXRpb24gPSB7J21pbic6IHRydWV9OwogICAgICB9CiAgICAgIHRoaXMudmFsaWRhdGlvbiA9IHZhbGlkYXRpb247CiAgICB9LAogIAogICAgdmFsaWRhdGU6IGZ1bmN0aW9uIHZhbGlkYXRlKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgdGhpcy5lcnJvcnMgPSBbXTsKICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW1zIHx8IHt9LCBjb250ZXh0IHx8ICdwYXJhbXMnKTsKICAKICAgICAgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA+IDEpIHsKICAgICAgICB2YXIgbXNnID0gdGhpcy5lcnJvcnMuam9pbignXG4qICcpOwogICAgICAgIG1zZyA9ICdUaGVyZSB3ZXJlICcgKyB0aGlzLmVycm9ycy5sZW5ndGggKwogICAgICAgICAgJyB2YWxpZGF0aW9uIGVycm9yczpcbiogJyArIG1zZzsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobXNnKSwKICAgICAgICAgIHtjb2RlOiAnTXVsdGlwbGVWYWxpZGF0aW9uRXJyb3JzJywgZXJyb3JzOiB0aGlzLmVycm9yc30pOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZXJyb3JzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRocm93IHRoaXMuZXJyb3JzWzBdOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9LAogIAogICAgZmFpbDogZnVuY3Rpb24gZmFpbChjb2RlLCBtZXNzYWdlKSB7CiAgICAgIHRoaXMuZXJyb3JzLnB1c2goQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpLCB7Y29kZTogY29kZX0pKTsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cnVjdHVyZTogZnVuY3Rpb24gdmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICB0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdzdHJ1Y3R1cmUnKTsKICAKICAgICAgdmFyIHBhcmFtTmFtZTsKICAgICAgZm9yICh2YXIgaSA9IDA7IHNoYXBlLnJlcXVpcmVkICYmIGkgPCBzaGFwZS5yZXF1aXJlZC5sZW5ndGg7IGkrKykgewogICAgICAgIHBhcmFtTmFtZSA9IHNoYXBlLnJlcXVpcmVkW2ldOwogICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdOwogICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01pc3NpbmdSZXF1aXJlZFBhcmFtZXRlcicsCiAgICAgICAgICAgICdNaXNzaW5nIHJlcXVpcmVkIGtleSBcJycgKyBwYXJhbU5hbWUgKyAnXCcgaW4gJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICAvLyB2YWxpZGF0ZSBoYXNoIG1lbWJlcnMKICAgICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1zKSB7CiAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1zLCBwYXJhbU5hbWUpKSBjb250aW51ZTsKICAKICAgICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdLAogICAgICAgICAgICBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbcGFyYW1OYW1lXTsKICAKICAgICAgICBpZiAobWVtYmVyU2hhcGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdmFyIG1lbWJlckNvbnRleHQgPSBbY29udGV4dCwgcGFyYW1OYW1lXS5qb2luKCcuJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKG1lbWJlclNoYXBlLCBwYXJhbVZhbHVlLCBtZW1iZXJDb250ZXh0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5mYWlsKCdVbmV4cGVjdGVkUGFyYW1ldGVyJywKICAgICAgICAgICAgJ1VuZXhwZWN0ZWQga2V5IFwnJyArIHBhcmFtTmFtZSArICdcJyBmb3VuZCBpbiAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTWVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpIHsKICAgICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgICAgY2FzZSAnc3RydWN0dXJlJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU3RydWN0dXJlKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZUxpc3Qoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdtYXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVNYXAoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTY2FsYXIoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTGlzdDogZnVuY3Rpb24gdmFsaWRhdGVMaXN0KHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgW0FycmF5XSkpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHBhcmFtcy5sZW5ndGgsIGNvbnRleHQsICdsaXN0IG1lbWJlciBjb3VudCcpOwogICAgICAgIC8vIHZhbGlkYXRlIGFycmF5IG1lbWJlcnMKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5tZW1iZXIsIHBhcmFtc1tpXSwgY29udGV4dCArICdbJyArIGkgKyAnXScpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlTWFwOiBmdW5jdGlvbiB2YWxpZGF0ZU1hcChzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdtYXAnKSkgewogICAgICAgIC8vIEJ1aWxkIHVwIGEgY291bnQgb2YgbWFwIG1lbWJlcnMgdG8gdmFsaWRhdGUgcmFuZ2UgdHJhaXRzLgogICAgICAgIHZhciBtYXBDb3VudCA9IDA7CiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7CiAgICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtKSkgY29udGludWU7CiAgICAgICAgICAvLyBWYWxpZGF0ZSBhbnkgbWFwIGtleSB0cmFpdCBjb25zdHJhaW50cwogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS5rZXksIHBhcmFtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1trZXk9XCcnICsgcGFyYW0gKyAnXCddJyk7CiAgICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLnZhbHVlLCBwYXJhbXNbcGFyYW1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1tcJycgKyBwYXJhbSArICdcJ10nKTsKICAgICAgICAgIG1hcENvdW50Kys7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgbWFwQ291bnQsIGNvbnRleHQsICdtYXAgbWVtYmVyIGNvdW50Jyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVNjYWxhcjogZnVuY3Rpb24gdmFsaWRhdGVTY2FsYXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICAgIGNhc2UgbnVsbDoKICAgICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVBheWxvYWQodmFsdWUsIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2ludGVnZXInOgogICAgICAgIGNhc2UgJ2Zsb2F0JzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTnVtYmVyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIFsnYm9vbGVhbiddKTsKICAgICAgICBjYXNlICd0aW1lc3RhbXAnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbRGF0ZSwKICAgICAgICAgICAgL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLCAnbnVtYmVyJ10sCiAgICAgICAgICAgICdEYXRlIG9iamVjdCwgSVNPLTg2MDEgc3RyaW5nLCBvciBhIFVOSVggdGltZXN0YW1wJyk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB0aGlzLmZhaWwoJ1Vua293blR5cGUnLCAnVW5oYW5kbGVkIHR5cGUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLnR5cGUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVN0cmluZzogZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciB2YWxpZFR5cGVzID0gWydzdHJpbmcnXTsKICAgICAgaWYgKHNoYXBlLmlzSnNvblZhbHVlKSB7CiAgICAgICAgdmFsaWRUeXBlcyA9IHZhbGlkVHlwZXMuY29uY2F0KFsnbnVtYmVyJywgJ29iamVjdCcsICdib29sZWFuJ10pOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgdmFsaWRUeXBlcykpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlRW51bShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUubGVuZ3RoLCBjb250ZXh0LCAnc3RyaW5nIGxlbmd0aCcpOwogICAgICAgIHRoaXMudmFsaWRhdGVQYXR0ZXJuKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgdGhpcy52YWxpZGF0ZVVyaShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVVcmk6IGZ1bmN0aW9uIHZhbGlkYXRlVXJpKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAoc2hhcGVbJ2xvY2F0aW9uJ10gPT09ICd1cmknKSB7CiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgdGhpcy5mYWlsKCdVcmlQYXJhbWV0ZXJFcnJvcicsICdFeHBlY3RlZCB1cmkgcGFyYW1ldGVyIHRvIGhhdmUgbGVuZ3RoID49IDEsJwogICAgICAgICAgICArICcgYnV0IGZvdW5kICInICsgdmFsdWUgKyciIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVQYXR0ZXJuOiBmdW5jdGlvbiB2YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ3BhdHRlcm4nXSAmJiBzaGFwZVsncGF0dGVybiddICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIShuZXcgUmVnRXhwKHNoYXBlWydwYXR0ZXJuJ10pKS50ZXN0KHZhbHVlKSkgewogICAgICAgICAgdGhpcy5mYWlsKCdQYXR0ZXJuTWF0Y2hFcnJvcicsICdQcm92aWRlZCB2YWx1ZSAiJyArIHZhbHVlICsgJyIgJwogICAgICAgICAgICArICdkb2VzIG5vdCBtYXRjaCByZWdleCBwYXR0ZXJuIC8nICsgc2hhcGVbJ3BhdHRlcm4nXSArICcvIGZvciAnCiAgICAgICAgICAgICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVSYW5nZTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsIGRlc2NyaXB0b3IpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWluJ10pIHsKICAgICAgICBpZiAoc2hhcGVbJ21pbiddICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPCBzaGFwZVsnbWluJ10pIHsKICAgICAgICAgIHRoaXMuZmFpbCgnTWluUmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPj0gJwogICAgICAgICAgICArIHNoYXBlWydtaW4nXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ21heCddKSB7CiAgICAgICAgaWYgKHNoYXBlWydtYXgnXSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlID4gc2hhcGVbJ21heCddKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01heFJhbmdlRXJyb3InLCAnRXhwZWN0ZWQgJyArIGRlc2NyaXB0b3IgKyAnIDw9ICcKICAgICAgICAgICAgKyBzaGFwZVsnbWF4J10gKyAnLCBidXQgZm91bmQgJyArIHZhbHVlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlRW51bTogZnVuY3Rpb24gdmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHRoaXMudmFsaWRhdGlvblsnZW51bSddICYmIHNoYXBlWydlbnVtJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIEZhaWwgaWYgdGhlIHN0cmluZyB2YWx1ZSBpcyBub3QgcHJlc2VudCBpbiB0aGUgZW51bSBsaXN0CiAgICAgICAgaWYgKHNoYXBlWydlbnVtJ10uaW5kZXhPZih2YWx1ZSkgPT09IC0xKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ0VudW1FcnJvcicsICdGb3VuZCBzdHJpbmcgdmFsdWUgb2YgJyArIHZhbHVlICsgJywgYnV0ICcKICAgICAgICAgICAgKyAnZXhwZWN0ZWQgJyArIHNoYXBlWydlbnVtJ10uam9pbignfCcpICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlVHlwZTogZnVuY3Rpb24gdmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBhY2NlcHRlZFR5cGVzLCB0eXBlKSB7CiAgICAgIC8vIFdlIHdpbGwgbm90IGxvZyBhbiBlcnJvciBmb3IgbnVsbCBvciB1bmRlZmluZWQsIGJ1dCB3ZSB3aWxsIHJldHVybgogICAgICAvLyBmYWxzZSBzbyB0aGF0IGNhbGxlcnMga25vdyB0aGF0IHRoZSBleHBlY3RlZCB0eXBlIHdhcyBub3Qgc3RyaWN0bHkgbWV0LgogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwogIAogICAgICB2YXIgZm91bmRJbnZhbGlkVHlwZSA9IGZhbHNlOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjY2VwdGVkVHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodHlwZW9mIGFjY2VwdGVkVHlwZXNbaV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGFjY2VwdGVkVHlwZXNbaV0gaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIGlmICgodmFsdWUgfHwgJycpLnRvU3RyaW5nKCkubWF0Y2goYWNjZXB0ZWRUeXBlc1tpXSkpIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIGFjY2VwdGVkVHlwZXNbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGlmICghdHlwZSAmJiAhZm91bmRJbnZhbGlkVHlwZSkgYWNjZXB0ZWRUeXBlcyA9IGFjY2VwdGVkVHlwZXMuc2xpY2UoKTsKICAgICAgICAgIGFjY2VwdGVkVHlwZXNbaV0gPSBBV1MudXRpbC50eXBlTmFtZShhY2NlcHRlZFR5cGVzW2ldKTsKICAgICAgICB9CiAgICAgICAgZm91bmRJbnZhbGlkVHlwZSA9IHRydWU7CiAgICAgIH0KICAKICAgICAgdmFyIGFjY2VwdGVkVHlwZSA9IHR5cGU7CiAgICAgIGlmICghYWNjZXB0ZWRUeXBlKSB7CiAgICAgICAgYWNjZXB0ZWRUeXBlID0gYWNjZXB0ZWRUeXBlcy5qb2luKCcsICcpLnJlcGxhY2UoLywoW14sXSspJC8sICcsIG9yJDEnKTsKICAgICAgfQogIAogICAgICB2YXIgdm93ZWwgPSBhY2NlcHRlZFR5cGUubWF0Y2goL15bYWVpb3VdL2kpID8gJ24nIDogJyc7CiAgICAgIHRoaXMuZmFpbCgnSW52YWxpZFBhcmFtZXRlclR5cGUnLCAnRXhwZWN0ZWQgJyArIGNvbnRleHQgKyAnIHRvIGJlIGEnICsKICAgICAgICAgICAgICAgIHZvd2VsICsgJyAnICsgYWNjZXB0ZWRUeXBlKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAKICAgIHZhbGlkYXRlTnVtYmVyOiBmdW5jdGlvbiB2YWxpZGF0ZU51bWJlcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICB2YXIgY2FzdGVkVmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgICAgICBpZiAoY2FzdGVkVmFsdWUudG9TdHJpbmcoKSA9PT0gdmFsdWUpIHZhbHVlID0gY2FzdGVkVmFsdWU7CiAgICAgIH0KICAgICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbJ251bWJlciddKSkgewogICAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgdmFsdWUsIGNvbnRleHQsICdudW1lcmljIHZhbHVlJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVBheWxvYWQ6IGZ1bmN0aW9uIHZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuOwogICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSByZXR1cm47IC8vIHR5cGVkIGFycmF5cwogICAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkpIHsgLy8gc3BlY2lhbCBjaGVjayBmb3IgYnVmZmVyL3N0cmVhbSBpbiBOb2RlLmpzCiAgICAgICAgdmFyIFN0cmVhbSA9IEFXUy51dGlsLnN0cmVhbS5TdHJlYW07CiAgICAgICAgaWYgKEFXUy51dGlsLkJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJlYW0pIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodHlwZW9mIEJsb2IgIT09IHZvaWQgMCAmJiB2YWx1ZSBpbnN0YW5jZW9mIEJsb2IpIHJldHVybjsKICAgICAgfQogIAogICAgICB2YXIgdHlwZXMgPSBbJ0J1ZmZlcicsICdTdHJlYW0nLCAnRmlsZScsICdCbG9iJywgJ0FycmF5QnVmZmVyJywgJ0RhdGFWaWV3J107CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChBV1MudXRpbC5pc1R5cGUodmFsdWUsIHR5cGVzW2ldKSkgcmV0dXJuOwogICAgICAgICAgaWYgKEFXUy51dGlsLnR5cGVOYW1lKHZhbHVlLmNvbnN0cnVjdG9yKSA9PT0gdHlwZXNbaV0pIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYSAnICsKICAgICAgICAnc3RyaW5nLCBCdWZmZXIsIFN0cmVhbSwgQmxvYiwgb3IgdHlwZWQgYXJyYXkgb2JqZWN0Jyk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSw0NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSAgcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogUHJlcGVuZCBwcmVmaXggZGVmaW5lZCBieSBBUEkgbW9kZWwgdG8gZW5kcG9pbnQgdGhhdCdzIGFscmVhZHkKICAgKiBjb25zdHJ1Y3RlZC4gVGhpcyBmZWF0dXJlIGRvZXMgbm90IGFwcGx5IHRvIG9wZXJhdGlvbnMgdXNpbmcKICAgKiBlbmRwb2ludCBkaXNjb3ZlcnkgYW5kIGNhbiBiZSBkaXNhYmxlZC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxdWVzdCkgIHsKICAgIHZhciBlbmFibGVkID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5ob3N0UHJlZml4RW5hYmxlZDsKICAgIGlmICghZW5hYmxlZCkgcmV0dXJuIHJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgLy9kb24ndCBtYXJzaGFsIGhvc3QgcHJlZml4IHdoZW4gb3BlcmF0aW9uIGhhcyBlbmRwb2ludCBkaXNjb3ZlcnkgdHJhaXRzCiAgICBpZiAoaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSkgcmV0dXJuIHJlcXVlc3Q7CiAgICBpZiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQgJiYgb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeCkgewogICAgICB2YXIgaG9zdFByZWZpeE5vdGF0aW9uID0gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnQuaG9zdFByZWZpeDsKICAgICAgdmFyIGhvc3RQcmVmaXggPSBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcmVxdWVzdC5wYXJhbXMsIG9wZXJhdGlvbk1vZGVsLmlucHV0KTsKICAgICAgcHJlcGVuZEVuZHBvaW50UHJlZml4KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQsIGhvc3RQcmVmaXgpOwogICAgICB2YWxpZGF0ZUhvc3RuYW1lKHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUpOwogICAgfQogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGhhc0VuZHBvaW50RGlzY292ZXIocmVxdWVzdCkgewogICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGk7CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgaXNFbmRwb2ludE9wZXJhdGlvbiA9IGFwaS5lbmRwb2ludE9wZXJhdGlvbiAmJiAoYXBpLmVuZHBvaW50T3BlcmF0aW9uID09PSB1dGlsLnN0cmluZy5sb3dlckZpcnN0KG9wZXJhdGlvbk1vZGVsLm5hbWUpKTsKICAgIHJldHVybiAob3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCAhPT0gJ05VTEwnIHx8IGlzRW5kcG9pbnRPcGVyYXRpb24gPT09IHRydWUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcGFyYW1zLCBzaGFwZSkgewogICAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICBpZiAobWVtYmVyLmhvc3RMYWJlbCA9PT0gdHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW25hbWVdICE9PSAnc3RyaW5nJyB8fCBwYXJhbXNbbmFtZV0gPT09ICcnKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdQYXJhbWV0ZXIgJyArIG5hbWUgKyAnIHNob3VsZCBiZSBhIG5vbi1lbXB0eSBzdHJpbmcuJywKICAgICAgICAgICAgY29kZTogJ0ludmFsaWRQYXJhbWV0ZXInCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG5hbWUgKyAnXFx9JywgJ2cnKTsKICAgICAgICBob3N0UHJlZml4Tm90YXRpb24gPSBob3N0UHJlZml4Tm90YXRpb24ucmVwbGFjZShyZWdleCwgcGFyYW1zW25hbWVdKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gaG9zdFByZWZpeE5vdGF0aW9uOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBwcmVwZW5kRW5kcG9pbnRQcmVmaXgoZW5kcG9pbnQsIHByZWZpeCkgewogICAgaWYgKGVuZHBvaW50Lmhvc3QpIHsKICAgICAgZW5kcG9pbnQuaG9zdCA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3Q7CiAgICB9CiAgICBpZiAoZW5kcG9pbnQuaG9zdG5hbWUpIHsKICAgICAgZW5kcG9pbnQuaG9zdG5hbWUgPSBwcmVmaXggKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gdmFsaWRhdGVIb3N0bmFtZShob3N0bmFtZSkgewogICAgdmFyIGxhYmVscyA9IGhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAvL1JlZmVyZW5jZTogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzExMjMjc2VjdGlvbi0yCiAgICB2YXIgaG9zdFBhdHRlcm4gPSAvXlthLXpBLVowLTldezF9JHxeW2EtekEtWjAtOV1bYS16QS1aMC05XC1dKlthLXpBLVowLTldJC87CiAgICB1dGlsLmFycmF5RWFjaChsYWJlbHMsIGZ1bmN0aW9uKGxhYmVsKSB7CiAgICAgIGlmICghbGFiZWwubGVuZ3RoIHx8IGxhYmVsLmxlbmd0aCA8IDEgfHwgbGFiZWwubGVuZ3RoID4gNjMpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdIb3N0bmFtZSBsYWJlbCBsZW5ndGggc2hvdWxkIGJlIGJldHdlZW4gMSB0byA2MyBjaGFyYWN0ZXJzLCBpbmNsdXNpdmUuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghaG9zdFBhdHRlcm4udGVzdChsYWJlbCkpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgIHtjb2RlOiAnVmFsaWRhdGlvbkVycm9yJywgbWVzc2FnZTogbGFiZWwgKyAnIGlzIG5vdCBob3N0bmFtZSBjb21wYXRpYmxlLid9KTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gewogICAgcG9wdWxhdGVIb3N0UHJlZml4OiBwb3B1bGF0ZUhvc3RQcmVmaXgKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vdXRpbCI6NzF9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgdmFyIGFwaSA9IHJlcS5zZXJ2aWNlLmFwaTsKICAgIHZhciB0YXJnZXQgPSBhcGkudGFyZ2V0UHJlZml4ICsgJy4nICsgYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0ubmFtZTsKICAgIHZhciB2ZXJzaW9uID0gYXBpLmpzb25WZXJzaW9uIHx8ICcxLjAnOwogICAgdmFyIGlucHV0ID0gYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBKc29uQnVpbGRlcigpOwogIAogICAgaWYgKHZlcnNpb24gPT09IDEpIHZlcnNpb24gPSAnMS4wJzsKICAgIGh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMgfHwge30sIGlucHV0KTsKICAgIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtYW16LWpzb24tJyArIHZlcnNpb247CiAgICBodHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1UYXJnZXQnXSA9IHRhcmdldDsKICAKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgdmFyIGVycm9yID0ge307CiAgICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcC5odHRwUmVzcG9uc2U7CiAgCiAgICBlcnJvci5jb2RlID0gaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1lcnJvcnR5cGUnXSB8fCAnVW5rbm93bkVycm9yJzsKICAgIGlmICh0eXBlb2YgZXJyb3IuY29kZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZXJyb3IuY29kZSA9IGVycm9yLmNvZGUuc3BsaXQoJzonKVswXTsKICAgIH0KICAKICAgIGlmIChodHRwUmVzcG9uc2UuYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIGUgPSBKU09OLnBhcnNlKGh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkpOwogICAgICAgIGlmIChlLl9fdHlwZSB8fCBlLmNvZGUpIHsKICAgICAgICAgIGVycm9yLmNvZGUgPSAoZS5fX3R5cGUgfHwgZS5jb2RlKS5zcGxpdCgnIycpLnBvcCgpOwogICAgICAgIH0KICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ1JlcXVlc3RFbnRpdHlUb29MYXJnZScpIHsKICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSAnUmVxdWVzdCBib2R5IG11c3QgYmUgbGVzcyB0aGFuIDEgTUInOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBlcnJvci5tZXNzYWdlID0gKGUubWVzc2FnZSB8fCBlLk1lc3NhZ2UgfHwgbnVsbCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIGVycm9yLm1lc3NhZ2UgPSBodHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICBlcnJvci5tZXNzYWdlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUudG9TdHJpbmcoKTsKICAgIH0KICAKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvcik7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpIHx8ICd7fSc7CiAgICBpZiAocmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNvbnZlcnRSZXNwb25zZVR5cGVzID09PSBmYWxzZSkgewogICAgICByZXNwLmRhdGEgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3Jlc3AucmVxdWVzdC5vcGVyYXRpb25dOwogICAgICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhID0gcGFyc2VyLnBhcnNlKGJvZHksIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBRdWVyeVBhcmFtU2VyaWFsaXplciA9IHJlcXVpcmUoJy4uL3F1ZXJ5L3F1ZXJ5X3BhcmFtX3NlcmlhbGl6ZXInKTsKICB2YXIgU2hhcGUgPSByZXF1aXJlKCcuLi9tb2RlbC9zaGFwZScpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogICAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPQogICAgICAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PXV0Zi04JzsKICAgIGh0dHBSZXF1ZXN0LnBhcmFtcyA9IHsKICAgICAgVmVyc2lvbjogcmVxLnNlcnZpY2UuYXBpLmFwaVZlcnNpb24sCiAgICAgIEFjdGlvbjogb3BlcmF0aW9uLm5hbWUKICAgIH07CiAgCiAgICAvLyBjb252ZXJ0IHRoZSByZXF1ZXN0IHBhcmFtZXRlcnMgaW50byBhIGxpc3Qgb2YgcXVlcnkgcGFyYW1zLAogICAgLy8gZS5nLiBEZWVwbHkuTmVzdGVkUGFyYW0uMC5OYW1lPXZhbHVlCiAgICB2YXIgYnVpbGRlciA9IG5ldyBRdWVyeVBhcmFtU2VyaWFsaXplcigpOwogICAgYnVpbGRlci5zZXJpYWxpemUocmVxLnBhcmFtcywgb3BlcmF0aW9uLmlucHV0LCBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICBodHRwUmVxdWVzdC5wYXJhbXNbbmFtZV0gPSB2YWx1ZTsKICAgIH0pOwogICAgaHR0cFJlcXVlc3QuYm9keSA9IHV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhodHRwUmVxdWVzdC5wYXJhbXMpOwogIAogICAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICB2YXIgZGF0YSwgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKTsKICAgIGlmIChib2R5Lm1hdGNoKCc8VW5rbm93bk9wZXJhdGlvbkV4Y2VwdGlvbicpKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogJ1Vua25vd25PcGVyYXRpb24nLAogICAgICAgIE1lc3NhZ2U6ICdVbmtub3duIG9wZXJhdGlvbiAnICsgcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbgogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdHJ5IHsKICAgICAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UoYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBkYXRhID0gewogICAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICAgIE1lc3NhZ2U6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UKICAgICAgICB9OwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoZGF0YS5yZXF1ZXN0SWQgJiYgIXJlc3AucmVxdWVzdElkKSByZXNwLnJlcXVlc3RJZCA9IGRhdGEucmVxdWVzdElkOwogICAgaWYgKGRhdGEuRXJyb3JzKSBkYXRhID0gZGF0YS5FcnJvcnM7CiAgICBpZiAoZGF0YS5FcnJvcikgZGF0YSA9IGRhdGEuRXJyb3I7CiAgICBpZiAoZGF0YS5Db2RlKSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogZGF0YS5Db2RlLAogICAgICAgIG1lc3NhZ2U6IGRhdGEuTWVzc2FnZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBtZXNzYWdlOiBudWxsCiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIHNoYXBlID0gb3BlcmF0aW9uLm91dHB1dCB8fCB7fTsKICAgIHZhciBvcmlnUnVsZXMgPSBzaGFwZTsKICAKICAgIGlmIChvcmlnUnVsZXMucmVzdWx0V3JhcHBlcikgewogICAgICB2YXIgdG1wID0gU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30pOwogICAgICB0bXAubWVtYmVyc1tvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0gPSBzaGFwZTsKICAgICAgdG1wLm1lbWJlck5hbWVzID0gW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgdXRpbC5wcm9wZXJ0eShzaGFwZSwgJ25hbWUnLCBzaGFwZS5yZXN1bHRXcmFwcGVyKTsKICAgICAgc2hhcGUgPSB0bXA7CiAgICB9CiAgCiAgICB2YXIgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgCiAgICAvLyBUT0RPOiBSZWZhY3RvciBYTUwgUGFyc2VyIHRvIHBhcnNlIFJlcXVlc3RJZCBmcm9tIHJlc3BvbnNlLgogICAgaWYgKHNoYXBlICYmIHNoYXBlLm1lbWJlcnMgJiYgIXNoYXBlLm1lbWJlcnMuX1hBTVpSZXF1ZXN0SWQpIHsKICAgICAgdmFyIHJlcXVlc3RJZFNoYXBlID0gU2hhcGUuY3JlYXRlKAogICAgICAgIHsgdHlwZTogJ3N0cmluZycgfSwKICAgICAgICB7IGFwaTogeyBwcm90b2NvbDogJ3F1ZXJ5JyB9IH0sCiAgICAgICAgJ3JlcXVlc3RJZCcKICAgICAgKTsKICAgICAgc2hhcGUubWVtYmVycy5fWEFNWlJlcXVlc3RJZCA9IHJlcXVlc3RJZFNoYXBlOwogICAgfQogIAogICAgdmFyIGRhdGEgPSBwYXJzZXIucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpLCBzaGFwZSk7CiAgICByZXNwLnJlcXVlc3RJZCA9IGRhdGEuX1hBTVpSZXF1ZXN0SWQgfHwgZGF0YS5yZXF1ZXN0SWQ7CiAgCiAgICBpZiAoZGF0YS5fWEFNWlJlcXVlc3RJZCkgZGVsZXRlIGRhdGEuX1hBTVpSZXF1ZXN0SWQ7CiAgCiAgICBpZiAob3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXIpIHsKICAgICAgaWYgKGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdKSB7CiAgICAgICAgdXRpbC51cGRhdGUoZGF0YSwgZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl0pOwogICAgICAgIGRlbGV0ZSBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgICAgfQogICAgfQogIAogICAgcmVzcC5kYXRhID0gZGF0YTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL21vZGVsL3NoYXBlIjo0MywiLi4vcXVlcnkvcXVlcnlfcGFyYW1fc2VyaWFsaXplciI6NTEsIi4uL3V0aWwiOjcxLCIuL2hlbHBlcnMiOjQ1fV0sNDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVNZXRob2QocmVxKSB7CiAgICByZXEuaHR0cFJlcXVlc3QubWV0aG9kID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaHR0cE1ldGhvZDsKICB9CiAgCiAgZnVuY3Rpb24gZ2VuZXJhdGVVUkkoZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoLCBpbnB1dCwgcGFyYW1zKSB7CiAgICB2YXIgdXJpID0gW2VuZHBvaW50UGF0aCwgb3BlcmF0aW9uUGF0aF0uam9pbignLycpOwogICAgdXJpID0gdXJpLnJlcGxhY2UoL1wvKy9nLCAnLycpOwogIAogICAgdmFyIHF1ZXJ5U3RyaW5nID0ge30sIHF1ZXJ5U3RyaW5nU2V0ID0gZmFsc2U7CiAgICB1dGlsLmVhY2goaW5wdXQubWVtYmVycywgZnVuY3Rpb24gKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHBhcmFtVmFsdWUgPT09IG51bGwgfHwgcGFyYW1WYWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICd1cmknKSB7CiAgICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG1lbWJlci5uYW1lICsgJyhcXCspP1xcfScpOwogICAgICAgIHVyaSA9IHVyaS5yZXBsYWNlKHJlZ2V4LCBmdW5jdGlvbihfLCBwbHVzKSB7CiAgICAgICAgICB2YXIgZm4gPSBwbHVzID8gdXRpbC51cmlFc2NhcGVQYXRoIDogdXRpbC51cmlFc2NhcGU7CiAgICAgICAgICByZXR1cm4gZm4oU3RyaW5nKHBhcmFtVmFsdWUpKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdxdWVyeXN0cmluZycpIHsKICAgICAgICBxdWVyeVN0cmluZ1NldCA9IHRydWU7CiAgCiAgICAgICAgaWYgKG1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHBhcmFtVmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICByZXR1cm4gdXRpbC51cmlFc2NhcGUobWVtYmVyLm1lbWJlci50b1dpcmVGb3JtYXQodmFsKS50b1N0cmluZygpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAobWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgICB1dGlsLmVhY2gocGFyYW1WYWx1ZSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwudXJpRXNjYXBlKFN0cmluZyh2YWwpKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdXRpbC51cmlFc2NhcGUoU3RyaW5nKHZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1ttZW1iZXIubmFtZV0gPSB1dGlsLnVyaUVzY2FwZShtZW1iZXIudG9XaXJlRm9ybWF0KHBhcmFtVmFsdWUpLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBpZiAocXVlcnlTdHJpbmdTZXQpIHsKICAgICAgdXJpICs9ICh1cmkuaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPycpOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdXRpbC5hcnJheUVhY2goT2JqZWN0LmtleXMocXVlcnlTdHJpbmcpLnNvcnQoKSwgZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHF1ZXJ5U3RyaW5nW2tleV0pKSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gW3F1ZXJ5U3RyaW5nW2tleV1dOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXJ5U3RyaW5nW2tleV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUoU3RyaW5nKGtleSkpICsgJz0nICsgcXVlcnlTdHJpbmdba2V5XVtpXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdXJpICs9IHBhcnRzLmpvaW4oJyYnKTsKICAgIH0KICAKICAgIHJldHVybiB1cmk7CiAgfQogIAogIGZ1bmN0aW9uIHBvcHVsYXRlVVJJKHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdmFyIGlucHV0ID0gb3BlcmF0aW9uLmlucHV0OwogIAogICAgdmFyIHVyaSA9IGdlbmVyYXRlVVJJKHJlcS5odHRwUmVxdWVzdC5lbmRwb2ludC5wYXRoLCBvcGVyYXRpb24uaHR0cFBhdGgsIGlucHV0LCByZXEucGFyYW1zKTsKICAgIHJlcS5odHRwUmVxdWVzdC5wYXRoID0gdXJpOwogIH0KICAKICBmdW5jdGlvbiBwb3B1bGF0ZUhlYWRlcnMocmVxKSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB1dGlsLmVhY2gob3BlcmF0aW9uLmlucHV0Lm1lbWJlcnMsIGZ1bmN0aW9uIChuYW1lLCBtZW1iZXIpIHsKICAgICAgdmFyIHZhbHVlID0gcmVxLnBhcmFtc1tuYW1lXTsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgIHV0aWwuZWFjaCh2YWx1ZSwgZnVuY3Rpb24oa2V5LCBtZW1iZXJWYWx1ZSkgewogICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWUgKyBrZXldID0gbWVtYmVyVmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICAgIHZhbHVlID0gbWVtYmVyLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKTsKICAgICAgICBpZiAobWVtYmVyLmlzSnNvblZhbHVlKSB7CiAgICAgICAgICB2YWx1ZSA9IHV0aWwuYmFzZTY0LmVuY29kZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW21lbWJlci5uYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgcG9wdWxhdGVNZXRob2QocmVxKTsKICAgIHBvcHVsYXRlVVJJKHJlcSk7CiAgICBwb3B1bGF0ZUhlYWRlcnMocmVxKTsKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IoKSB7CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHIgPSByZXNwLmh0dHBSZXNwb25zZTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgLy8gbm9ybWFsaXplIGhlYWRlcnMgbmFtZXMgdG8gbG93ZXItY2FzZWQga2V5cyBmb3IgbWF0Y2hpbmcKICAgIHZhciBoZWFkZXJzID0ge307CiAgICB1dGlsLmVhY2goci5oZWFkZXJzLCBmdW5jdGlvbiAoaywgdikgewogICAgICBoZWFkZXJzW2sudG9Mb3dlckNhc2UoKV0gPSB2OwogICAgfSk7CiAgCiAgICB1dGlsLmVhY2gob3V0cHV0Lm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgaGVhZGVyID0gKG1lbWJlci5uYW1lIHx8IG5hbWUpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXJzJyAmJiBtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICBkYXRhW25hbWVdID0ge307CiAgICAgICAgdmFyIGxvY2F0aW9uID0gbWVtYmVyLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyLm5hbWUgOiAnJzsKICAgICAgICB2YXIgcGF0dGVybiA9IG5ldyBSZWdFeHAoJ14nICsgbG9jYXRpb24gKyAnKC4rKScsICdpJyk7CiAgICAgICAgdXRpbC5lYWNoKHIuaGVhZGVycywgZnVuY3Rpb24gKGssIHYpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBrLm1hdGNoKHBhdHRlcm4pOwogICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCkgewogICAgICAgICAgICBkYXRhW25hbWVdW3Jlc3VsdFsxXV0gPSB2OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgICBpZiAoaGVhZGVyc1toZWFkZXJdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IG1lbWJlci5pc0pzb25WYWx1ZSA/CiAgICAgICAgICAgIHV0aWwuYmFzZTY0LmRlY29kZShoZWFkZXJzW2hlYWRlcl0pIDoKICAgICAgICAgICAgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgZGF0YVtuYW1lXSA9IG1lbWJlci50b1R5cGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdzdGF0dXNDb2RlJykgewogICAgICAgIGRhdGFbbmFtZV0gPSBwYXJzZUludChyLnN0YXR1c0NvZGUsIDEwKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXNwLmRhdGEgPSBkYXRhOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEsCiAgICBnZW5lcmF0ZVVSSTogZ2VuZXJhdGVVUkkKICB9OwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgUmVzdCA9IHJlcXVpcmUoJy4vcmVzdCcpOwogIHZhciBKc29uID0gcmVxdWlyZSgnLi9qc29uJyk7CiAgdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CiAgdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwogIAogIGZ1bmN0aW9uIHBvcHVsYXRlQm9keShyZXEpIHsKICAgIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CiAgICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAKICAgIGlmIChpbnB1dC5wYXlsb2FkKSB7CiAgICAgIHZhciBwYXJhbXMgPSB7fTsKICAgICAgdmFyIHBheWxvYWRTaGFwZSA9IGlucHV0Lm1lbWJlcnNbaW5wdXQucGF5bG9hZF07CiAgICAgIHBhcmFtcyA9IHJlcS5wYXJhbXNbaW5wdXQucGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLmJ1aWxkKHBhcmFtcywgcGF5bG9hZFNoYXBlKTsKICAgICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi1KU09OIHBheWxvYWQKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IHBhcmFtczsKICAgICAgICBpZiAocGF5bG9hZFNoYXBlLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRTaGFwZS5pc1N0cmVhbWluZykgewogICAgICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEsIHRydWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGJvZHkgPSBidWlsZGVyLmJ1aWxkKHJlcS5wYXJhbXMsIGlucHV0KTsKICAgICAgaWYgKGJvZHkgIT09ICd7fScgfHwgcmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCAhPT0gJ0dFVCcpIHsgLy9kb24ndCBzZW5kIGVtcHR5IGJvZHkgZm9yIEdFVCBtZXRob2QKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJvZHk7CiAgICAgIH0KICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgaXNCaW5hcnkpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBpbnB1dCA9IG9wZXJhdGlvbi5pbnB1dDsKICAKICAgIGlmICghcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICAgIHZhciB0eXBlID0gaXNCaW5hcnkgPyAnYmluYXJ5L29jdGV0LXN0cmVhbScgOiAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9IHR5cGU7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIFJlc3QuYnVpbGRSZXF1ZXN0KHJlcSk7CiAgCiAgICAvLyBuZXZlciBzZW5kIGJvZHkgcGF5bG9hZCBvbiBIRUFEL0RFTEVURQogICAgaWYgKFsnSEVBRCcsICdERUxFVEUnXS5pbmRleE9mKHJlcS5odHRwUmVxdWVzdC5tZXRob2QpIDwgMCkgewogICAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIEpzb24uZXh0cmFjdEVycm9yKHJlc3ApOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3REYXRhKHJlc3ApOwogIAogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgIHZhciBwYXJzZXI7CiAgICB2YXIgaGFzRXZlbnRPdXRwdXQgPSBvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQ7CiAgCiAgICBpZiAocnVsZXMucGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IHJ1bGVzLm1lbWJlcnNbcnVsZXMucGF5bG9hZF07CiAgICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgICAgaWYgKHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbSkgewogICAgICAgIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gdXRpbC5jcmVhdGVFdmVudFN0cmVhbSgKICAgICAgICAgIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyID8gcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtIDogYm9keSwKICAgICAgICAgIHBhcnNlciwKICAgICAgICAgIHBheWxvYWRNZW1iZXIKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScgfHwgcGF5bG9hZE1lbWJlci50eXBlID09PSAnbGlzdCcpIHsKICAgICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXJzZXIucGFyc2UoYm9keSwgcGF5bG9hZE1lbWJlcik7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gYm9keTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0gPSBwYXlsb2FkTWVtYmVyLnRvVHlwZShib2R5KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGRhdGEgPSByZXNwLmRhdGE7CiAgICAgIEpzb24uZXh0cmFjdERhdGEocmVzcCk7CiAgICAgIHJlc3AuZGF0YSA9IHV0aWwubWVyZ2UoZGF0YSwgcmVzcC5kYXRhKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCiAgfTsKICAKICB9LHsiLi4vanNvbi9idWlsZGVyIjozNiwiLi4vanNvbi9wYXJzZXIiOjM3LCIuLi91dGlsIjo3MSwiLi9qc29uIjo0NiwiLi9yZXN0Ijo0OH1dLDUwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBSZXN0ID0gcmVxdWlyZSgnLi9yZXN0Jyk7CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogICAgdmFyIGlucHV0ID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBBV1MuWE1MLkJ1aWxkZXIoKTsKICAgIHZhciBwYXJhbXMgPSByZXEucGFyYW1zOwogIAogICAgdmFyIHBheWxvYWQgPSBpbnB1dC5wYXlsb2FkOwogICAgaWYgKHBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBpbnB1dC5tZW1iZXJzW3BheWxvYWRdOwogICAgICBwYXJhbXMgPSBwYXJhbXNbcGF5bG9hZF07CiAgICAgIGlmIChwYXJhbXMgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHZhciByb290RWxlbWVudCA9IHBheWxvYWRNZW1iZXIubmFtZTsKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBwYXlsb2FkTWVtYmVyLCByb290RWxlbWVudCwgdHJ1ZSk7CiAgICAgIH0gZWxzZSB7IC8vIG5vbi14bWwgcGF5bG9hZAogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gcGFyYW1zOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIudG9YTUwocGFyYW1zLCBpbnB1dCwgaW5wdXQubmFtZSB8fAogICAgICAgIGlucHV0LnNoYXBlIHx8IHV0aWwuc3RyaW5nLnVwcGVyRmlyc3QocmVxLm9wZXJhdGlvbikgKyAnUmVxdWVzdCcpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICBSZXN0LmJ1aWxkUmVxdWVzdChyZXEpOwogIAogICAgLy8gbmV2ZXIgc2VuZCBib2R5IHBheWxvYWQgb24gR0VUL0hFQUQKICAgIGlmIChbJ0dFVCcsICdIRUFEJ10uaW5kZXhPZihyZXEuaHR0cFJlcXVlc3QubWV0aG9kKSA8IDApIHsKICAgICAgcG9wdWxhdGVCb2R5KHJlcSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3RFcnJvcihyZXNwKTsKICAKICAgIHZhciBkYXRhOwogICAgdHJ5IHsKICAgICAgZGF0YSA9IG5ldyBBV1MuWE1MLlBhcnNlcigpLnBhcnNlKHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGRhdGEgPSB7CiAgICAgICAgQ29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBNZXNzYWdlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlCiAgICAgIH07CiAgICB9CiAgCiAgICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICAgIGlmIChkYXRhLkVycm9yKSBkYXRhID0gZGF0YS5FcnJvcjsKICAgIGlmIChkYXRhLkNvZGUpIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiBkYXRhLkNvZGUsCiAgICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICAgIG1lc3NhZ2U6IG51bGwKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICAgIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CiAgCiAgICB2YXIgcGFyc2VyOwogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogIAogICAgdmFyIGhhc0V2ZW50T3V0cHV0ID0gb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0OwogIAogICAgdmFyIHBheWxvYWQgPSBvdXRwdXQucGF5bG9hZDsKICAgIGlmIChwYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW0pIHsKICAgICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSB1dGlsLmNyZWF0ZUV2ZW50U3RyZWFtKAogICAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiByZXNwLmh0dHBSZXNwb25zZS5ib2R5LAogICAgICAgICAgcGFyc2VyLAogICAgICAgICAgcGF5bG9hZE1lbWJlcgogICAgICAgICk7CiAgICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIHBheWxvYWRNZW1iZXIpOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IGJvZHk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gcGF5bG9hZE1lbWJlci50b1R5cGUoYm9keSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoYm9keS5sZW5ndGggPiAwKSB7CiAgICAgIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogICAgICB2YXIgZGF0YSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIG91dHB1dCk7CiAgICAgIHV0aWwudXBkYXRlKHJlc3AuZGF0YSwgZGF0YSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi91dGlsIjo3MSwiLi9yZXN0Ijo0OH1dLDUxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBRdWVyeVBhcmFtU2VyaWFsaXplcigpIHsKICB9CiAgCiAgUXVlcnlQYXJhbVNlcmlhbGl6ZXIucHJvdG90eXBlLnNlcmlhbGl6ZSA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIGZuKSB7CiAgICBzZXJpYWxpemVTdHJ1Y3R1cmUoJycsIHBhcmFtcywgc2hhcGUsIGZuKTsKICB9OwogIAogIGZ1bmN0aW9uIHVjZmlyc3Qoc2hhcGUpIHsKICAgIGlmIChzaGFwZS5pc1F1ZXJ5TmFtZSB8fCBzaGFwZS5hcGkucHJvdG9jb2wgIT09ICdlYzInKSB7CiAgICAgIHJldHVybiBzaGFwZS5uYW1lOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHNoYXBlLm5hbWVbMF0udG9VcHBlckNhc2UoKSArIHNoYXBlLm5hbWUuc3Vic3RyKDEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUocHJlZml4LCBzdHJ1Y3QsIHJ1bGVzLCBmbikgewogICAgdXRpbC5lYWNoKHJ1bGVzLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgICB2YXIgdmFsdWUgPSBzdHJ1Y3RbbmFtZV07CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIHZhciBtZW1iZXJOYW1lID0gdWNmaXJzdChtZW1iZXIpOwogICAgICBtZW1iZXJOYW1lID0gcHJlZml4ID8gcHJlZml4ICsgJy4nICsgbWVtYmVyTmFtZSA6IG1lbWJlck5hbWU7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihtZW1iZXJOYW1lLCB2YWx1ZSwgbWVtYmVyLCBmbik7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTWFwKG5hbWUsIG1hcCwgcnVsZXMsIGZuKSB7CiAgICB2YXIgaSA9IDE7CiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcHJlZml4ID0gcnVsZXMuZmxhdHRlbmVkID8gJy4nIDogJy5lbnRyeS4nOwogICAgICB2YXIgcG9zaXRpb24gPSBwcmVmaXggKyAoaSsrKSArICcuJzsKICAgICAgdmFyIGtleU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy5rZXkubmFtZSB8fCAna2V5Jyk7CiAgICAgIHZhciB2YWx1ZU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy52YWx1ZS5uYW1lIHx8ICd2YWx1ZScpOwogICAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIGtleU5hbWUsIGtleSwgcnVsZXMua2V5LCBmbik7CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgdmFsdWVOYW1lLCB2YWx1ZSwgcnVsZXMudmFsdWUsIGZuKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVMaXN0KG5hbWUsIGxpc3QsIHJ1bGVzLCBmbikgewogICAgdmFyIG1lbWJlclJ1bGVzID0gcnVsZXMubWVtYmVyIHx8IHt9OwogIAogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgIGZuLmNhbGwodGhpcywgbmFtZSwgbnVsbCk7CiAgICAgIHJldHVybjsKICAgIH0KICAKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uICh2LCBuKSB7CiAgICAgIHZhciBzdWZmaXggPSAnLicgKyAobiArIDEpOwogICAgICBpZiAocnVsZXMuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICAgIC8vIERvIG5vdGhpbmcgZm9yIEVDMgogICAgICAgIHN1ZmZpeCA9IHN1ZmZpeCArICcnOyAvLyBtYWtlIGxpbnRlciBoYXBweQogICAgICB9IGVsc2UgaWYgKHJ1bGVzLmZsYXR0ZW5lZCkgewogICAgICAgIGlmIChtZW1iZXJSdWxlcy5uYW1lKSB7CiAgICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgICBwYXJ0cy5wb3AoKTsKICAgICAgICAgIHBhcnRzLnB1c2godWNmaXJzdChtZW1iZXJSdWxlcykpOwogICAgICAgICAgbmFtZSA9IHBhcnRzLmpvaW4oJy4nKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3VmZml4ID0gJy4nICsgKG1lbWJlclJ1bGVzLm5hbWUgPyBtZW1iZXJSdWxlcy5uYW1lIDogJ21lbWJlcicpICsgc3VmZml4OwogICAgICB9CiAgICAgIHNlcmlhbGl6ZU1lbWJlcihuYW1lICsgc3VmZml4LCB2LCBtZW1iZXJSdWxlcywgZm4pOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1lbWJlcihuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgaWYgKHJ1bGVzLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgIHNlcmlhbGl6ZVN0cnVjdHVyZShuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSBpZiAocnVsZXMudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgIHNlcmlhbGl6ZUxpc3QobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgICB9IGVsc2UgaWYgKHJ1bGVzLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgIHNlcmlhbGl6ZU1hcChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICAgIH0gZWxzZSB7CiAgICAgIGZuKG5hbWUsIHJ1bGVzLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gUXVlcnlQYXJhbVNlcmlhbGl6ZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxfV0sNTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gewogICAgLy9wcm92aWRlIHJlYWx0aW1lIGNsb2NrIGZvciBwZXJmb3JtYW5jZSBtZWFzdXJlbWVudAogICAgbm93OiBmdW5jdGlvbiBub3coKSB7CiAgICAgIGlmICh0eXBlb2YgcGVyZm9ybWFuY2UgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIERhdGUubm93KCk7CiAgICB9CiAgfTsKICAKICB9LHt9XSw1MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKICB2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbicpOwogIAogIGZ1bmN0aW9uIGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbikgewogICAgaWYgKCFyZWdpb24pIHJldHVybiBudWxsOwogIAogICAgdmFyIHBhcnRzID0gcmVnaW9uLnNwbGl0KCctJyk7CiAgICBpZiAocGFydHMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcGFydHMuc2xpY2UoMCwgcGFydHMubGVuZ3RoIC0gMikuam9pbignLScpICsgJy0qJzsKICB9CiAgCiAgZnVuY3Rpb24gZGVyaXZlZEtleXMoc2VydmljZSkgewogICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIHZhciByZWdpb25QcmVmaXggPSBnZW5lcmF0ZVJlZ2lvblByZWZpeChyZWdpb24pOwogICAgdmFyIGVuZHBvaW50UHJlZml4ID0gc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXg7CiAgCiAgICByZXR1cm4gWwogICAgICBbcmVnaW9uLCBlbmRwb2ludFByZWZpeF0sCiAgICAgIFtyZWdpb25QcmVmaXgsIGVuZHBvaW50UHJlZml4XSwKICAgICAgW3JlZ2lvbiwgJyonXSwKICAgICAgW3JlZ2lvblByZWZpeCwgJyonXSwKICAgICAgWycqJywgZW5kcG9pbnRQcmVmaXhdLAogICAgICBbJyonLCAnKiddCiAgICBdLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgIHJldHVybiBpdGVtWzBdICYmIGl0ZW1bMV0gPyBpdGVtLmpvaW4oJy8nKSA6IG51bGw7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKSB7CiAgICB1dGlsLmVhY2goY29uZmlnLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChrZXkgPT09ICdnbG9iYWxFbmRwb2ludCcpIHJldHVybjsKICAgICAgaWYgKHNlcnZpY2UuY29uZmlnW2tleV0gPT09IHVuZGVmaW5lZCB8fCBzZXJ2aWNlLmNvbmZpZ1trZXldID09PSBudWxsKSB7CiAgICAgICAgc2VydmljZS5jb25maWdba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gY29uZmlndXJlRW5kcG9pbnQoc2VydmljZSkgewogICAgdmFyIGtleXMgPSBkZXJpdmVkS2V5cyhzZXJ2aWNlKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgaWYgKCFrZXkpIGNvbnRpbnVlOwogIAogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJlZ2lvbkNvbmZpZy5ydWxlcywga2V5KSkgewogICAgICAgIHZhciBjb25maWcgPSByZWdpb25Db25maWcucnVsZXNba2V5XTsKICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGNvbmZpZyA9IHJlZ2lvbkNvbmZpZy5wYXR0ZXJuc1tjb25maWddOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZHVhbHN0YWNrIGVuZHBvaW50CiAgICAgICAgaWYgKHNlcnZpY2UuY29uZmlnLnVzZUR1YWxzdGFjayAmJiB1dGlsLmlzRHVhbHN0YWNrQXZhaWxhYmxlKHNlcnZpY2UpKSB7CiAgICAgICAgICBjb25maWcgPSB1dGlsLmNvcHkoY29uZmlnKTsKICAgICAgICAgIGNvbmZpZy5lbmRwb2ludCA9ICd7c2VydmljZX0uZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20nOwogICAgICAgIH0KICAKICAgICAgICAvLyBzZXQgZ2xvYmFsIGVuZHBvaW50CiAgICAgICAgc2VydmljZS5pc0dsb2JhbEVuZHBvaW50ID0gISFjb25maWcuZ2xvYmFsRW5kcG9pbnQ7CiAgCiAgICAgICAgLy8gc2lnbmF0dXJlIHZlcnNpb24KICAgICAgICBpZiAoIWNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSBjb25maWcuc2lnbmF0dXJlVmVyc2lvbiA9ICd2NCc7CiAgCiAgICAgICAgLy8gbWVyZ2UgY29uZmlnCiAgICAgICAgYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBjb25maWd1cmVFbmRwb2ludDsKICAKICB9LHsiLi9yZWdpb25fY29uZmlnX2RhdGEuanNvbiI6NTQsIi4vdXRpbCI6NzF9XSw1NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInJ1bGVzIjogewogICAgICAiKi8qIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgImNuLSovKiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICAgIH0sCiAgICAgICIqL2J1ZGdldHMiOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovY2xvdWRmcm9udCI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9pYW0iOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovc3RzIjogImdsb2JhbFNTTCIsCiAgICAgICIqL2ltcG9ydGV4cG9ydCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIiwKICAgICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICAgIH0sCiAgICAgICIqL3JvdXRlNTMiOiB7CiAgICAgICAgImVuZHBvaW50IjogImh0dHBzOi8ve3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYzaHR0cHMiLAogICAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgICAgfSwKICAgICAgIiovd2FmIjogImdsb2JhbFNTTCIsCiAgICAgICJ1cy1nb3YtKi9pYW0iOiAiZ2xvYmFsR292Q2xvdWQiLAogICAgICAidXMtZ292LSovc3RzIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInVzLWdvdi13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAidXMtd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLXdlc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJldS13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtc291dGhlYXN0LTIvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiYXAtbm9ydGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAic2EtZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLWVhc3QtMS9zMyI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInMzIgogICAgICB9LAogICAgICAidXMtZWFzdC0xL3NkYiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInYyIgogICAgICB9LAogICAgICAiKi9zZGIiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIKICAgICAgfQogICAgfSwKICAKICAgICJwYXR0ZXJucyI6IHsKICAgICAgImdsb2JhbFNTTCI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAiaHR0cHM6Ly97c2VydmljZX0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgICB9LAogICAgICAiZ2xvYmFsR292Q2xvdWQiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS51cy1nb3YuYW1hem9uYXdzLmNvbSIKICAgICAgfSwKICAgICAgInMzc2lnbmF0dXJlIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiczMiCiAgICAgIH0KICAgIH0KICB9CiAgCiAgfSx7fV0sNTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgQWNjZXB0b3JTdGF0ZU1hY2hpbmUgPSByZXF1aXJlKCcuL3N0YXRlX21hY2hpbmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGRvbWFpbiA9IEFXUy51dGlsLmRvbWFpbjsKICB2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBoYXJkRXJyb3JTdGF0ZXMgPSB7c3VjY2VzczogMSwgZXJyb3I6IDEsIGNvbXBsZXRlOiAxfTsKICAKICBmdW5jdGlvbiBpc1Rlcm1pbmFsU3RhdGUobWFjaGluZSkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChoYXJkRXJyb3JTdGF0ZXMsIG1hY2hpbmUuX2FzbS5jdXJyZW50U3RhdGUpOwogIH0KICAKICB2YXIgZnNtID0gbmV3IEFjY2VwdG9yU3RhdGVNYWNoaW5lKCk7CiAgZnNtLnNldHVwU3RhdGVzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgdHJhbnNpdGlvbiA9IGZ1bmN0aW9uKF8sIGRvbmUpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gZmFsc2U7CiAgCiAgICAgIHNlbGYuZW1pdChzZWxmLl9hc20uY3VycmVudFN0YXRlLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBpZiAoaXNUZXJtaW5hbFN0YXRlKHNlbGYpKSB7CiAgICAgICAgICAgIGlmIChkb21haW4gJiYgc2VsZi5kb21haW4gaW5zdGFuY2VvZiBkb21haW4uRG9tYWluKSB7CiAgICAgICAgICAgICAgZXJyLmRvbWFpbkVtaXR0ZXIgPSBzZWxmOwogICAgICAgICAgICAgIGVyci5kb21haW4gPSBzZWxmLmRvbWFpbjsKICAgICAgICAgICAgICBlcnIuZG9tYWluVGhyb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgc2VsZi5kb21haW4uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5yZXNwb25zZS5lcnJvciA9IGVycjsKICAgICAgICAgICAgZG9uZShlcnIpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkb25lKHNlbGYucmVzcG9uc2UuZXJyb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICB9OwogIAogICAgdGhpcy5hZGRTdGF0ZSgndmFsaWRhdGUnLCAnYnVpbGQnLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2J1aWxkJywgJ2FmdGVyQnVpbGQnLCAncmVzdGFydCcsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnYWZ0ZXJCdWlsZCcsICdzaWduJywgJ3Jlc3RhcnQnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3NpZ24nLCAnc2VuZCcsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgncmV0cnknLCAnYWZ0ZXJSZXRyeScsICdhZnRlclJldHJ5JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdhZnRlclJldHJ5JywgJ3NpZ24nLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3NlbmQnLCAndmFsaWRhdGVSZXNwb25zZScsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgndmFsaWRhdGVSZXNwb25zZScsICdleHRyYWN0RGF0YScsICdleHRyYWN0RXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2V4dHJhY3RFcnJvcicsICdleHRyYWN0RGF0YScsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnZXh0cmFjdERhdGEnLCAnc3VjY2VzcycsICdyZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgncmVzdGFydCcsICdidWlsZCcsICdlcnJvcicsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnc3VjY2VzcycsICdjb21wbGV0ZScsICdjb21wbGV0ZScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnZXJyb3InLCAnY29tcGxldGUnLCAnY29tcGxldGUnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2NvbXBsZXRlJywgbnVsbCwgbnVsbCwgdHJhbnNpdGlvbik7CiAgfTsKICBmc20uc2V0dXBTdGF0ZXMoKTsKICAKICAvKioKICAgKiAjIyBBc3luY2hyb25vdXMgUmVxdWVzdHMKICAgKgogICAqIEFsbCByZXF1ZXN0cyBtYWRlIHRocm91Z2ggdGhlIFNESyBhcmUgYXN5bmNocm9ub3VzIGFuZCB1c2UgYQogICAqIGNhbGxiYWNrIGludGVyZmFjZS4gRWFjaCBzZXJ2aWNlIG1ldGhvZCB0aGF0IGtpY2tzIG9mZiBhIHJlcXVlc3QKICAgKiByZXR1cm5zIGFuIGBBV1MuUmVxdWVzdGAgb2JqZWN0IHRoYXQgeW91IGNhbiB1c2UgdG8gcmVnaXN0ZXIKICAgKiBjYWxsYmFja3MuCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBzZXJ2aWNlIG1ldGhvZCByZXR1cm5zIHRoZSByZXF1ZXN0CiAgICogb2JqZWN0IGFzICJyZXF1ZXN0Iiwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIC8vIHJlcXVlc3QgaXMgYW4gQVdTLlJlcXVlc3Qgb2JqZWN0CiAgICogdmFyIHJlcXVlc3QgPSBlYzIuZGVzY3JpYmVJbnN0YW5jZXMoKTsKICAgKgogICAqIC8vIHJlZ2lzdGVyIGNhbGxiYWNrcyBvbiByZXF1ZXN0IHRvIHJldHJpZXZlIHJlc3BvbnNlIGRhdGEKICAgKiByZXF1ZXN0Lm9uKCdzdWNjZXNzJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgIGNvbnNvbGUubG9nKHJlc3BvbnNlLmRhdGEpOwogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogV2hlbiBhIHJlcXVlc3QgaXMgcmVhZHkgdG8gYmUgc2VudCwgdGhlIHtzZW5kfSBtZXRob2Qgc2hvdWxkCiAgICogYmUgY2FsbGVkOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHJlcXVlc3Quc2VuZCgpOwogICAqIGBgYAogICAqCiAgICogU2luY2UgcmVnaXN0ZXJlZCBjYWxsYmFja3MgbWF5IG9yIG1heSBub3QgYmUgaWRlbXBvdGVudCwgcmVxdWVzdHMgc2hvdWxkIG9ubHkKICAgKiBiZSBzZW50IG9uY2UuIFRvIHBlcmZvcm0gdGhlIHNhbWUgb3BlcmF0aW9uIG11bHRpcGxlIHRpbWVzLCB5b3Ugd2lsbCBuZWVkIHRvCiAgICogY3JlYXRlIG11bHRpcGxlIHJlcXVlc3Qgb2JqZWN0cywgZWFjaCB3aXRoIGl0cyBvd24gcmVnaXN0ZXJlZCBjYWxsYmFja3MuCiAgICoKICAgKiAjIyBSZW1vdmluZyBEZWZhdWx0IExpc3RlbmVycyBmb3IgRXZlbnRzCiAgICoKICAgKiBSZXF1ZXN0IG9iamVjdHMgYXJlIGJ1aWx0IHdpdGggZGVmYXVsdCBsaXN0ZW5lcnMgZm9yIHRoZSB2YXJpb3VzIGV2ZW50cywKICAgKiBkZXBlbmRpbmcgb24gdGhlIHNlcnZpY2UgdHlwZS4gSW4gc29tZSBjYXNlcywgeW91IG1heSB3YW50IHRvIHJlbW92ZQogICAqIHNvbWUgYnVpbHQtaW4gbGlzdGVuZXJzIHRvIGN1c3RvbWl6ZSBiZWhhdmlvdXIuIERvaW5nIHRoaXMgcmVxdWlyZXMKICAgKiBhY2Nlc3MgdG8gdGhlIGJ1aWx0LWluIGxpc3RlbmVyIGZ1bmN0aW9ucywgd2hpY2ggYXJlIGV4cG9zZWQgdGhyb3VnaAogICAqIHRoZSB7QVdTLkV2ZW50TGlzdGVuZXJzLkNvcmV9IG5hbWVzcGFjZS4gRm9yIGluc3RhbmNlLCB5b3UgbWF5CiAgICogd2FudCB0byBjdXN0b21pemUgdGhlIEhUVFAgaGFuZGxlciB1c2VkIHdoZW4gc2VuZGluZyBhIHJlcXVlc3QuIEluIHRoaXMKICAgKiBjYXNlLCB5b3UgY2FuIHJlbW92ZSB0aGUgYnVpbHQtaW4gbGlzdGVuZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSAnc2VuZCcKICAgKiBldmVudCwgdGhlIHtBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5EfSBsaXN0ZW5lciBhbmQgYWRkIHlvdXIgb3duLgogICAqCiAgICogIyMgTXVsdGlwbGUgQ2FsbGJhY2tzIGFuZCBDaGFpbmluZwogICAqCiAgICogWW91IGNhbiByZWdpc3RlciBtdWx0aXBsZSBjYWxsYmFja3Mgb24gYW55IHJlcXVlc3Qgb2JqZWN0LiBUaGUKICAgKiBjYWxsYmFja3MgY2FuIGJlIHJlZ2lzdGVyZWQgZm9yIGRpZmZlcmVudCBldmVudHMsIG9yIGFsbCBmb3IgdGhlCiAgICogc2FtZSBldmVudC4gSW4gYWRkaXRpb24sIHlvdSBjYW4gY2hhaW4gY2FsbGJhY2sgcmVnaXN0cmF0aW9uLCBmb3IKICAgKiBleGFtcGxlOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHJlcXVlc3QuCiAgICogICBvbignc3VjY2VzcycsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJTdWNjZXNzISIpOwogICAqICAgfSkuCiAgICogICBvbignZXJyb3InLCBmdW5jdGlvbihlcnJvciwgcmVzcG9uc2UpIHsKICAgKiAgICAgY29uc29sZS5sb2coIkVycm9yISIpOwogICAqICAgfSkuCiAgICogICBvbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgICBjb25zb2xlLmxvZygiQWx3YXlzISIpOwogICAqICAgfSkuCiAgICogICBzZW5kKCk7CiAgICogYGBgCiAgICoKICAgKiBUaGUgYWJvdmUgZXhhbXBsZSB3aWxsIHByaW50IGVpdGhlciAiU3VjY2VzcyEgQWx3YXlzISIsIG9yICJFcnJvciEgQWx3YXlzISIsCiAgICogZGVwZW5kaW5nIG9uIHdoZXRoZXIgdGhlIHJlcXVlc3Qgc3VjY2VlZGVkIG9yIG5vdC4KICAgKgogICAqIEAhYXR0cmlidXRlIGh0dHBSZXF1ZXN0CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgSFRUUCBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtBV1MuSHR0cFJlcXVlc3RdIHRoZSByYXcgSFRUUCByZXF1ZXN0IG9iamVjdAogICAqICAgICBjb250YWluaW5nIHJlcXVlc3QgaGVhZGVycyBhbmQgYm9keSBpbmZvcm1hdGlvbgogICAqICAgICBzZW50IGJ5IHRoZSBzZXJ2aWNlLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc3RhcnRUaW1lCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0RhdGVdIHRoZSB0aW1lIHRoYXQgdGhlIHJlcXVlc3Qgc3RhcnRlZAogICAqCiAgICogQCFncm91cCBSZXF1ZXN0IEJ1aWxkaW5nIEV2ZW50cwogICAqCiAgICogQCFldmVudCB2YWxpZGF0ZShyZXF1ZXN0KQogICAqICAgVHJpZ2dlcmVkIHdoZW4gYSByZXF1ZXN0IGlzIGJlaW5nIHZhbGlkYXRlZC4gTGlzdGVuZXJzCiAgICogICBzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgdGhlIHJlcXVlc3Qgc2hvdWxkIG5vdCBiZSBzZW50LgogICAqICAgQHBhcmFtIHJlcXVlc3QgW1JlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCBiZWluZyBzZW50CiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTCiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTgogICAqICAgQGV4YW1wbGUgRW5zdXJpbmcgdGhhdCBhIGNlcnRhaW4gcGFyYW1ldGVyIGlzIHNldCBiZWZvcmUgc2VuZGluZyBhIHJlcXVlc3QKICAgKiAgICAgdmFyIHJlcSA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogICAqICAgICByZXEub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24oKSB7CiAgICogICAgICAgaWYgKCFyZXEucGFyYW1zLkJvZHkubWF0Y2goL15IZWxsb1xzLykpIHsKICAgKiAgICAgICAgIHRocm93IG5ldyBFcnJvcignQm9keSBtdXN0IHN0YXJ0IHdpdGggIkhlbGxvICInKTsKICAgKiAgICAgICB9CiAgICogICAgIH0pOwogICAqICAgICByZXEuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogICAqCiAgICogQCFldmVudCBidWlsZChyZXF1ZXN0KQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgcGF5bG9hZCBpcyBiZWluZyBidWlsdC4gTGlzdGVuZXJzCiAgICogICBzaG91bGQgZmlsbCB0aGUgbmVjZXNzYXJ5IGluZm9ybWF0aW9uIHRvIHNlbmQgdGhlIHJlcXVlc3QKICAgKiAgIG92ZXIgSFRUUC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnZhbGlkYXRlKQogICAqICAgQGV4YW1wbGUgQWRkIGEgY3VzdG9tIEhUVFAgaGVhZGVyIHRvIGEgcmVxdWVzdAogICAqICAgICB2YXIgcmVxID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICogICAgIHJlcS5vbignYnVpbGQnLCBmdW5jdGlvbigpIHsKICAgKiAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ3VzdG9tLUhlYWRlciddID0gJ3ZhbHVlJzsKICAgKiAgICAgfSk7CiAgICogICAgIHJlcS5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAgICoKICAgKiBAIWV2ZW50IHNpZ24ocmVxdWVzdCkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGlzIGJlaW5nIHNpZ25lZC4gTGlzdGVuZXJzIHNob3VsZAogICAqICAgYWRkIHRoZSBjb3JyZWN0IGF1dGhlbnRpY2F0aW9uIGhlYWRlcnMgYW5kL29yIGFkanVzdCB0aGUgYm9keSwKICAgKiAgIGRlcGVuZGluZyBvbiB0aGUgYXV0aGVudGljYXRpb24gbWVjaGFuaXNtIGJlaW5nIHVzZWQuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH52YWxpZGF0ZSkKICAgKgogICAqIEAhZ3JvdXAgUmVxdWVzdCBTZW5kaW5nIEV2ZW50cwogICAqCiAgICogQCFldmVudCBzZW5kKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgaXMgcmVhZHkgdG8gYmUgc2VudC4gTGlzdGVuZXJzCiAgICogICBzaG91bGQgY2FsbCB0aGUgdW5kZXJseWluZyB0cmFuc3BvcnQgbGF5ZXIgdG8gaW5pdGlhdGUKICAgKiAgIHRoZSBzZW5kaW5nIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQHBhcmFtIHJlc3BvbnNlIFtSZXNwb25zZV0gdGhlIHJlc3BvbnNlIG9iamVjdAogICAqICAgQGNvbnRleHQgW1JlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCB0aGF0IHdhcyBzZW50CiAgICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQKICAgKgogICAqIEAhZXZlbnQgcmV0cnkocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBhIHJlcXVlc3QgZmFpbGVkIGFuZCBtaWdodCBuZWVkIHRvIGJlIHJldHJpZWQgb3IgcmVkaXJlY3RlZC4KICAgKiAgIElmIHRoZSByZXNwb25zZSBpcyByZXRyeWFibGUsIHRoZSBsaXN0ZW5lciBzaG91bGQgc2V0IHRoZQogICAqICAgYHJlc3BvbnNlLmVycm9yLnJldHJ5YWJsZWAgcHJvcGVydHkgdG8gYHRydWVgLCBhbmQgb3B0aW9uYWxseSBzZXQKICAgKiAgIGByZXNwb25zZS5lcnJvci5yZXRyeURlbGF5YCB0byB0aGUgbWlsbGlzZWNvbmQgZGVsYXkgZm9yIHRoZSBuZXh0IGF0dGVtcHQuCiAgICogICBJbiB0aGUgY2FzZSBvZiBhIHJlZGlyZWN0LCBgcmVzcG9uc2UuZXJyb3IucmVkaXJlY3RgIHNob3VsZCBiZSBzZXQgdG8KICAgKiAgIGB0cnVlYCB3aXRoIGByZXRyeURlbGF5YCBzZXQgdG8gYW4gb3B0aW9uYWwgZGVsYXkgb24gdGhlIG5leHQgcmVxdWVzdC4KICAgKgogICAqICAgSWYgYSBsaXN0ZW5lciBkZWNpZGVzIHRoYXQgYSByZXF1ZXN0IHNob3VsZCBub3QgYmUgcmV0cmllZCwKICAgKiAgIGl0IHNob3VsZCBzZXQgYm90aCBgcmV0cnlhYmxlYCBhbmQgYHJlZGlyZWN0YCB0byBmYWxzZS4KICAgKgogICAqICAgTm90ZSB0aGF0IGEgcmV0cnlhYmxlIGVycm9yIHdpbGwgYmUgcmV0cmllZCBhdCBtb3N0CiAgICogICB7QVdTLkNvbmZpZy5tYXhSZXRyaWVzfSB0aW1lcyAoYmFzZWQgb24gdGhlIHNlcnZpY2Ugb2JqZWN0J3MgY29uZmlnKS4KICAgKiAgIFNpbWlsYXJseSwgYSByZXF1ZXN0IHRoYXQgaXMgcmVkaXJlY3RlZCB3aWxsIG9ubHkgcmVkaXJlY3QgYXQgbW9zdAogICAqICAge0FXUy5Db25maWcubWF4UmVkaXJlY3RzfSB0aW1lcy4KICAgKgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBleGFtcGxlIEFkZGluZyBhIGN1c3RvbSByZXRyeSBmb3IgYSA0MDQgcmVzcG9uc2UKICAgKiAgICAgcmVxdWVzdC5vbigncmV0cnknLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgICAgIC8vIHRoaXMgcmVzb3VyY2UgaXMgbm90IHlldCBhdmFpbGFibGUsIHdhaXQgMTAgc2Vjb25kcyB0byBnZXQgaXQgYWdhaW4KICAgKiAgICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDQwNCAmJiByZXNwb25zZS5lcnJvcikgewogICAqICAgICAgICAgcmVzcG9uc2UuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsgICAvLyByZXRyeSB0aGlzIGVycm9yCiAgICogICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeURlbGF5ID0gMTAwMDA7IC8vIHdhaXQgMTAgc2Vjb25kcwogICAqICAgICAgIH0KICAgKiAgICAgfSk7CiAgICoKICAgKiBAIWdyb3VwIERhdGEgUGFyc2luZyBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgZXh0cmFjdEVycm9yKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIG9uIGFsbCBub24tMnh4IHJlcXVlc3RzIHNvIHRoYXQgbGlzdGVuZXJzIGNhbiBleHRyYWN0CiAgICogICBlcnJvciBkZXRhaWxzIGZyb20gdGhlIHJlc3BvbnNlIGJvZHkuIExpc3RlbmVycyB0byB0aGlzIGV2ZW50CiAgICogICBzaG91bGQgc2V0IHRoZSBgcmVzcG9uc2UuZXJyb3JgIHByb3BlcnR5LgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgZXh0cmFjdERhdGEocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgaW4gc3VjY2Vzc2Z1bCByZXF1ZXN0cyB0byBhbGxvdyBsaXN0ZW5lcnMgdG8KICAgKiAgIGRlLXNlcmlhbGl6ZSB0aGUgcmVzcG9uc2UgYm9keSBpbnRvIGByZXNwb25zZS5kYXRhYC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWdyb3VwIENvbXBsZXRpb24gRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IHN1Y2Nlc3MocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5LgogICAqICAgYHJlc3BvbnNlLmRhdGFgIHdpbGwgY29udGFpbiB0aGUgcmVzcG9uc2UgZGF0YSBhbmQKICAgKiAgIGByZXNwb25zZS5lcnJvcmAgd2lsbCBiZSBudWxsLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgZXJyb3IoZXJyb3IsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gYW4gZXJyb3Igb2NjdXJzIGF0IGFueSBwb2ludCBkdXJpbmcgdGhlCiAgICogICByZXF1ZXN0LiBgcmVzcG9uc2UuZXJyb3JgIHdpbGwgY29udGFpbiBkZXRhaWxzIGFib3V0IHRoZSBlcnJvcgogICAqICAgdGhhdCBvY2N1cnJlZC4gYHJlc3BvbnNlLmRhdGFgIHdpbGwgYmUgbnVsbC4KICAgKiAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgY29udGFpbmluZyBkZXRhaWxzIGFib3V0CiAgICogICAgIHRoZSBlcnJvciB0aGF0IG9jY3VycmVkLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKgogICAqIEAhZXZlbnQgY29tcGxldGUocmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbmV2ZXIgYSByZXF1ZXN0IGN5Y2xlIGNvbXBsZXRlcy4gYHJlc3BvbnNlLmVycm9yYAogICAqICAgc2hvdWxkIGJlIGNoZWNrZWQsIHNpbmNlIHRoZSByZXF1ZXN0IG1heSBoYXZlIGZhaWxlZC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWdyb3VwIEhUVFAgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IGh0dHBIZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3BvbnNlLCBzdGF0dXNNZXNzYWdlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gaGVhZGVycyBhcmUgc2VudCBieSB0aGUgcmVtb3RlIHNlcnZlcgogICAqICAgQHBhcmFtIHN0YXR1c0NvZGUgW0ludGVnZXJdIHRoZSBIVFRQIHJlc3BvbnNlIGNvZGUKICAgKiAgIEBwYXJhbSBoZWFkZXJzIFttYXA8U3RyaW5nLFN0cmluZz5dIHRoZSByZXNwb25zZSBoZWFkZXJzCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQHBhcmFtIHN0YXR1c01lc3NhZ2UgW1N0cmluZ10gQSBzdGF0dXMgbWVzc2FnZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBIVFRQCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZSBjb2RlCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGh0dHBEYXRhKGNodW5rLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGRhdGEgaXMgc2VudCBieSB0aGUgcmVtb3RlIHNlcnZlcgogICAqICAgQHBhcmFtIGNodW5rIFtCdWZmZXJdIHRoZSBidWZmZXIgZGF0YSBjb250YWluaW5nIHRoZSBuZXh0IGRhdGEgY2h1bmsKICAgKiAgICAgZnJvbSB0aGUgc2VydmVyCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEEKICAgKgogICAqIEAhZXZlbnQgaHR0cFVwbG9hZFByb2dyZXNzKHByb2dyZXNzLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgaGFzIHVwbG9hZGVkIG1vcmUgZGF0YQogICAqICAgQHBhcmFtIHByb2dyZXNzIFttYXBdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgbG9hZGVkYCBhbmQgYHRvdGFsYCBieXRlcwogICAqICAgICBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAbm90ZSBUaGlzIGV2ZW50IHdpbGwgbm90IGJlIGVtaXR0ZWQgaW4gTm9kZS5qcyAwLjgueC4KICAgKgogICAqIEAhZXZlbnQgaHR0cERvd25sb2FkUHJvZ3Jlc3MocHJvZ3Jlc3MsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBoYXMgZG93bmxvYWRlZCBtb3JlIGRhdGEKICAgKiAgIEBwYXJhbSBwcm9ncmVzcyBbbWFwXSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYGxvYWRlZGAgYW5kIGB0b3RhbGAgYnl0ZXMKICAgKiAgICAgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQG5vdGUgVGhpcyBldmVudCB3aWxsIG5vdCBiZSBlbWl0dGVkIGluIE5vZGUuanMgMC44LnguCiAgICoKICAgKiBAIWV2ZW50IGh0dHBFcnJvcihlcnJvciwgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGZhaWxlZAogICAqICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCB0aGF0IHdhcyB0aHJvd24KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGh0dHBEb25lKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHNlcnZlciBpcyBmaW5pc2hlZCBzZW5kaW5nIGRhdGEKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAc2VlIEFXUy5SZXNwb25zZQogICAqLwogIEFXUy5SZXF1ZXN0ID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSByZXF1ZXN0IGZvciBhbiBvcGVyYXRpb24gb24gYSBnaXZlbiBzZXJ2aWNlIHdpdGgKICAgICAqIGEgc2V0IG9mIGlucHV0IHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQHBhcmFtIHNlcnZpY2UgW0FXUy5TZXJ2aWNlXSB0aGUgc2VydmljZSB0byBwZXJmb3JtIHRoZSBvcGVyYXRpb24gb24KICAgICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG9wZXJhdGlvbiB0byBwZXJmb3JtIG9uIHRoZSBzZXJ2aWNlCiAgICAgKiBAcGFyYW0gcGFyYW1zIFtPYmplY3RdIHBhcmFtZXRlcnMgdG8gc2VuZCB0byB0aGUgb3BlcmF0aW9uLgogICAgICogICBTZWUgdGhlIG9wZXJhdGlvbidzIGRvY3VtZW50YXRpb24gZm9yIHRoZSBmb3JtYXQgb2YgdGhlCiAgICAgKiAgIHBhcmFtZXRlcnMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXF1ZXN0KHNlcnZpY2UsIG9wZXJhdGlvbiwgcGFyYW1zKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IHNlcnZpY2UuZW5kcG9pbnQ7CiAgICAgIHZhciByZWdpb24gPSBzZXJ2aWNlLmNvbmZpZy5yZWdpb247CiAgICAgIHZhciBjdXN0b21Vc2VyQWdlbnQgPSBzZXJ2aWNlLmNvbmZpZy5jdXN0b21Vc2VyQWdlbnQ7CiAgCiAgICAgIC8vIGdsb2JhbCBlbmRwb2ludHMgc2lnbiBhcyB1cy1lYXN0LTEKICAgICAgaWYgKHNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCkgcmVnaW9uID0gJ3VzLWVhc3QtMSc7CiAgCiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluICYmIGRvbWFpbi5hY3RpdmU7CiAgICAgIHRoaXMuc2VydmljZSA9IHNlcnZpY2U7CiAgICAgIHRoaXMub3BlcmF0aW9uID0gb3BlcmF0aW9uOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgdGhpcy5odHRwUmVxdWVzdCA9IG5ldyBBV1MuSHR0cFJlcXVlc3QoZW5kcG9pbnQsIHJlZ2lvbik7CiAgICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoY3VzdG9tVXNlckFnZW50KTsKICAgICAgdGhpcy5zdGFydFRpbWUgPSBzZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCk7CiAgCiAgICAgIHRoaXMucmVzcG9uc2UgPSBuZXcgQVdTLlJlc3BvbnNlKHRoaXMpOwogICAgICB0aGlzLl9hc20gPSBuZXcgQWNjZXB0b3JTdGF0ZU1hY2hpbmUoZnNtLnN0YXRlcywgJ3ZhbGlkYXRlJyk7CiAgICAgIHRoaXMuX2hhbHRIYW5kbGVyc09uRXJyb3IgPSBmYWxzZTsKICAKICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgICB0aGlzLmVtaXQgPSB0aGlzLmVtaXRFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhZ3JvdXAgU2VuZGluZyBhIFJlcXVlc3QKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgc2VuZChjYWxsYmFjayA9IG51bGwpCiAgICAgKiAgIFNlbmRzIHRoZSByZXF1ZXN0IG9iamVjdC4KICAgICAqCiAgICAgKiAgIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICAgKiAgICAgQGNvbnRleHQgW0FXUy5SZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgYmVpbmcgc2VudC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAgICogICAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBhIGNhbGxiYWNrCiAgICAgKiAgICAgcmVxdWVzdCA9IHMzLnB1dE9iamVjdCh7QnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5J30pOwogICAgICogICAgIHJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgY29uc29sZS5sb2coZXJyLCBkYXRhKTsgfSk7CiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGggbm8gY2FsbGJhY2sgKHVzaW5nIGV2ZW50IGhhbmRsZXJzKQogICAgICogICAgIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgICAqICAgICByZXF1ZXN0Lm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7IC4uLiB9KTsgLy8gcmVnaXN0ZXIgYSBjYWxsYmFjawogICAgICogICAgIHJlcXVlc3Quc2VuZCgpOwogICAgICovCiAgICBzZW5kOiBmdW5jdGlvbiBzZW5kKGNhbGxiYWNrKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIC8vIGFwcGVuZCB0byB1c2VyIGFnZW50CiAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgnY2FsbGJhY2snKTsKICAgICAgICB0aGlzLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3AsIHJlc3AuZXJyb3IsIHJlc3AuZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhpcy5ydW5UbygpOwogIAogICAgICByZXR1cm4gdGhpcy5yZXNwb25zZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICBwcm9taXNlKCkKICAgICAqICAgU2VuZHMgdGhlIHJlcXVlc3QgYW5kIHJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbihkYXRhKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuCiAgICAgKiAgICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnJvcikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgcmVxdWVzdC4KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3QgdXNpbmcgcHJvbWlzZXMuCiAgICAgKiAgICAgdmFyIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgICAqICAgICB2YXIgcmVzdWx0ID0gcmVxdWVzdC5wcm9taXNlKCk7CiAgICAgKiAgICAgcmVzdWx0LnRoZW4oZnVuY3Rpb24oZGF0YSkgeyAuLi4gfSwgZnVuY3Rpb24oZXJyb3IpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBidWlsZDogZnVuY3Rpb24gYnVpbGQoY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMucnVuVG8oJ3NlbmQnLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcnVuVG86IGZ1bmN0aW9uIHJ1blRvKHN0YXRlLCBkb25lKSB7CiAgICAgIHRoaXMuX2FzbS5ydW5UbyhzdGF0ZSwgZG9uZSwgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQWJvcnRzIGEgcmVxdWVzdCwgZW1pdHRpbmcgdGhlIGVycm9yIGFuZCBjb21wbGV0ZSBldmVudHMuCiAgICAgKgogICAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgICAqIEBleGFtcGxlIEFib3J0aW5nIGEgcmVxdWVzdCBhZnRlciBzZW5kaW5nCiAgICAgKiAgIHZhciBwYXJhbXMgPSB7CiAgICAgKiAgICAgQnVja2V0OiAnYnVja2V0JywgS2V5OiAna2V5JywKICAgICAqICAgICBCb2R5OiBCdWZmZXIuYWxsb2MoMTAyNCAqIDEwMjQgKiA1KSAvLyA1TUIgcGF5bG9hZAogICAgICogICB9OwogICAgICogICB2YXIgcmVxdWVzdCA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogICAgICogICByZXF1ZXN0LnNlbmQoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICogICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJFcnJvcjoiLCBlcnIuY29kZSwgZXJyLm1lc3NhZ2UpOwogICAgICogICAgIGVsc2UgY29uc29sZS5sb2coZGF0YSk7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gYWJvcnQgcmVxdWVzdCBpbiAxIHNlY29uZAogICAgICogICBzZXRUaW1lb3V0KHJlcXVlc3QuYWJvcnQuYmluZChyZXF1ZXN0KSwgMTAwMCk7CiAgICAgKgogICAgICogICAvLyBwcmludHMgIkVycm9yOiBSZXF1ZXN0QWJvcnRlZEVycm9yIFJlcXVlc3QgYWJvcnRlZCBieSB1c2VyIgogICAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdIHRoZSBzYW1lIHJlcXVlc3Qgb2JqZWN0LCBmb3IgY2hhaW5pbmcuCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGFib3J0OiBmdW5jdGlvbiBhYm9ydCgpIHsKICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3ZhbGlkYXRlUmVzcG9uc2UnKTsKICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4dHJhY3RFcnJvcicpOwogICAgICB0aGlzLm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24gYWRkQWJvcnRlZEVycm9yKHJlc3ApIHsKICAgICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdSZXF1ZXN0IGFib3J0ZWQgYnkgdXNlcicpLCB7CiAgICAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InLCByZXRyeWFibGU6IGZhbHNlCiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICBpZiAodGhpcy5odHRwUmVxdWVzdC5zdHJlYW0gJiYgIXRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtLmRpZENhbGxiYWNrKSB7IC8vIGFib3J0IEhUVFAgc3RyZWFtCiAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5zdHJlYW0uYWJvcnQoKTsKICAgICAgICBpZiAodGhpcy5odHRwUmVxdWVzdC5fYWJvcnRDYWxsYmFjaykgewogICAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuX2Fib3J0Q2FsbGJhY2soKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3NlbmQnKTsgLy8gaGF2ZW4ndCBzZW50IHlldCwgc28gbGV0J3Mgbm90CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlYWNoIHBhZ2Ugb2YgcmVzdWx0cyBnaXZlbiBhIHBhZ2VhYmxlIHJlcXVlc3QsIGNhbGxpbmcKICAgICAqIHRoZSBwcm92aWRlZCBjYWxsYmFjayB3aXRoIGVhY2ggcGFnZSBvZiBkYXRhLiBBZnRlciBhbGwgcGFnZXMgaGF2ZSBiZWVuCiAgICAgKiByZXRyaWV2ZWQsIHRoZSBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBgbnVsbGAgZGF0YS4KICAgICAqCiAgICAgKiBAbm90ZSBUaGlzIG9wZXJhdGlvbiBjYW4gZ2VuZXJhdGUgbXVsdGlwbGUgcmVxdWVzdHMgdG8gYSBzZXJ2aWNlLgogICAgICogQGV4YW1wbGUgSXRlcmF0aW5nIG92ZXIgbXVsdGlwbGUgcGFnZXMgb2Ygb2JqZWN0cyBpbiBhbiBTMyBidWNrZXQKICAgICAqICAgdmFyIHBhZ2VzID0gMTsKICAgICAqICAgczMubGlzdE9iamVjdHMoKS5lYWNoUGFnZShmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAqICAgICBpZiAoZXJyKSByZXR1cm47CiAgICAgKiAgICAgY29uc29sZS5sb2coIlBhZ2UiLCBwYWdlcysrKTsKICAgICAqICAgICBjb25zb2xlLmxvZyhkYXRhKTsKICAgICAqICAgfSk7CiAgICAgKiBAZXhhbXBsZSBJdGVyYXRpbmcgb3ZlciBtdWx0aXBsZSBwYWdlcyB3aXRoIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjawogICAgICogICBzMy5saXN0T2JqZWN0cyhwYXJhbXMpLmVhY2hQYWdlKGZ1bmN0aW9uKGVyciwgZGF0YSwgZG9uZSkgewogICAgICogICAgIGRvU29tZXRoaW5nQXN5bmNBbmRPckV4cGVuc2l2ZShmdW5jdGlvbigpIHsKICAgICAqICAgICAgIC8vIFRoZSBuZXh0IHBhZ2Ugb2YgcmVzdWx0cyBpc24ndCBmZXRjaGVkIHVudGlsIGRvbmUgaXMgY2FsbGVkCiAgICAgKiAgICAgICBkb25lKCk7CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIH0pOwogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSwgW2RvbmVDYWxsYmFja10pCiAgICAgKiAgIENhbGxlZCB3aXRoIGVhY2ggcGFnZSBvZiByZXN1bHRpbmcgZGF0YSBmcm9tIHRoZSByZXF1ZXN0LiBJZiB0aGUKICAgICAqICAgb3B0aW9uYWwgYGRvbmVDYWxsYmFja2AgaXMgcHJvdmlkZWQgaW4gdGhlIGZ1bmN0aW9uLCBpdCBtdXN0IGJlIGNhbGxlZAogICAgICogICB3aGVuIHRoZSBjYWxsYmFjayBpcyBjb21wbGV0ZS4KICAgICAqCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBhbiBlcnJvciBvYmplY3QsIGlmIGFuIGVycm9yIG9jY3VycmVkLgogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSBhIHNpbmdsZSBwYWdlIG9mIHJlc3BvbnNlIGRhdGEuIElmIHRoZXJlIGlzIG5vCiAgICAgKiAgICAgbW9yZSBkYXRhLCB0aGlzIG9iamVjdCB3aWxsIGJlIGBudWxsYC4KICAgICAqICAgQHBhcmFtIGRvbmVDYWxsYmFjayBbRnVuY3Rpb25dIGFuIG9wdGlvbmFsIGRvbmUgY2FsbGJhY2suIElmIHRoaXMKICAgICAqICAgICBhcmd1bWVudCBpcyBkZWZpbmVkIGluIHRoZSBmdW5jdGlvbiBkZWNsYXJhdGlvbiwgaXQgc2hvdWxkIGJlIGNhbGxlZAogICAgICogICAgIHdoZW4gdGhlIG5leHQgcGFnZSBpcyByZWFkeSB0byBiZSByZXRyaWV2ZWQuIFRoaXMgaXMgdXNlZnVsIGZvcgogICAgICogICAgIGNvbnRyb2xsaW5nIHNlcmlhbCBwYWdpbmF0aW9uIGFjcm9zcyBhc3luY2hyb25vdXMgb3BlcmF0aW9ucy4KICAgICAqICAgQHJldHVybiBbQm9vbGVhbl0gaWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYGZhbHNlYCwgcGFnaW5hdGlvbiB3aWxsCiAgICAgKiAgICAgc3RvcC4KICAgICAqCiAgICAgKiBAc2VlIEFXUy5SZXF1ZXN0LmVhY2hJdGVtCiAgICAgKiBAc2VlIEFXUy5SZXNwb25zZS5uZXh0UGFnZQogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBlYWNoUGFnZTogZnVuY3Rpb24gZWFjaFBhZ2UoY2FsbGJhY2spIHsKICAgICAgLy8gTWFrZSBhbGwgY2FsbGJhY2tzIGFzeW5jLWlzaAogICAgICBjYWxsYmFjayA9IEFXUy51dGlsLmZuLm1ha2VBc3luYyhjYWxsYmFjaywgMyk7CiAgCiAgICAgIGZ1bmN0aW9uIHdyYXBwZWRDYWxsYmFjayhyZXNwb25zZSkgewogICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcG9uc2UsIHJlc3BvbnNlLmVycm9yLCByZXNwb25zZS5kYXRhLCBmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkgcmV0dXJuOwogIAogICAgICAgICAgaWYgKHJlc3BvbnNlLmhhc05leHRQYWdlKCkpIHsKICAgICAgICAgICAgcmVzcG9uc2UubmV4dFBhZ2UoKS5vbignY29tcGxldGUnLCB3cmFwcGVkQ2FsbGJhY2spLnNlbmQoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwocmVzcG9uc2UsIG51bGwsIG51bGwsIEFXUy51dGlsLmZuLm5vb3ApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHRoaXMub24oJ2NvbXBsZXRlJywgd3JhcHBlZENhbGxiYWNrKS5zZW5kKCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFbnVtZXJhdGVzIG92ZXIgaW5kaXZpZHVhbCBpdGVtcyBvZiBhIHJlcXVlc3QsIHBhZ2luZyB0aGUgcmVzcG9uc2VzIGlmCiAgICAgKiBuZWNlc3NhcnkuCiAgICAgKgogICAgICogQGFwaSBleHBlcmltZW50YWwKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgZWFjaEl0ZW06IGZ1bmN0aW9uIGVhY2hJdGVtKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgZnVuY3Rpb24gd3JhcHBlZENhbGxiYWNrKGVyciwgZGF0YSkgewogICAgICAgIGlmIChlcnIpIHJldHVybiBjYWxsYmFjayhlcnIsIG51bGwpOwogICAgICAgIGlmIChkYXRhID09PSBudWxsKSByZXR1cm4gY2FsbGJhY2sobnVsbCwgbnVsbCk7CiAgCiAgICAgICAgdmFyIGNvbmZpZyA9IHNlbGYuc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHNlbGYub3BlcmF0aW9uKTsKICAgICAgICB2YXIgcmVzdWx0S2V5ID0gY29uZmlnLnJlc3VsdEtleTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRLZXkpKSByZXN1bHRLZXkgPSByZXN1bHRLZXlbMF07CiAgICAgICAgdmFyIGl0ZW1zID0gam1lc3BhdGguc2VhcmNoKGRhdGEsIHJlc3VsdEtleSk7CiAgICAgICAgdmFyIGNvbnRpbnVlSXRlcmF0aW9uID0gdHJ1ZTsKICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goaXRlbXMsIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgIGNvbnRpbnVlSXRlcmF0aW9uID0gY2FsbGJhY2sobnVsbCwgaXRlbSk7CiAgICAgICAgICBpZiAoY29udGludWVJdGVyYXRpb24gPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBBV1MudXRpbC5hYm9ydDsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gY29udGludWVJdGVyYXRpb247CiAgICAgIH0KICAKICAgICAgdGhpcy5lYWNoUGFnZSh3cmFwcGVkQ2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgb3BlcmF0aW9uIGNhbiByZXR1cm4gbXVsdGlwbGUgcGFnZXMgb2YKICAgICAqICAgcmVzcG9uc2UgZGF0YS4KICAgICAqIEBzZWUgQVdTLlJlc3BvbnNlLmVhY2hQYWdlCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGlzUGFnZWFibGU6IGZ1bmN0aW9uIGlzUGFnZWFibGUoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyh0aGlzLm9wZXJhdGlvbikgPyB0cnVlIDogZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBTZW5kcyB0aGUgcmVxdWVzdCBhbmQgY29udmVydHMgdGhlIHJlcXVlc3Qgb2JqZWN0IGludG8gYSByZWFkYWJsZSBzdHJlYW0KICAgICAqIHRoYXQgY2FuIGJlIHJlYWQgZnJvbSBvciBwaXBlZCBpbnRvIGEgd3JpdGFibGUgc3RyZWFtLgogICAgICoKICAgICAqIEBub3RlIFRoZSBkYXRhIHJlYWQgZnJvbSBhIHJlYWRhYmxlIHN0cmVhbSBjb250YWlucyBvbmx5CiAgICAgKiAgIHRoZSByYXcgSFRUUCBib2R5IGNvbnRlbnRzLgogICAgICogQGV4YW1wbGUgTWFudWFsbHkgcmVhZGluZyBmcm9tIGEgc3RyZWFtCiAgICAgKiAgIHJlcXVlc3QuY3JlYXRlUmVhZFN0cmVhbSgpLm9uKCdkYXRhJywgZnVuY3Rpb24oZGF0YSkgewogICAgICogICAgIGNvbnNvbGUubG9nKCJHb3QgZGF0YToiLCBkYXRhLnRvU3RyaW5nKCkpOwogICAgICogICB9KTsKICAgICAqIEBleGFtcGxlIFBpcGluZyBhIHJlcXVlc3QgYm9keSBpbnRvIGEgZmlsZQogICAgICogICB2YXIgb3V0ID0gZnMuY3JlYXRlV3JpdGVTdHJlYW0oJy9wYXRoL3RvL291dGZpbGUuanBnJyk7CiAgICAgKiAgIHMzLnNlcnZpY2UuZ2V0T2JqZWN0KHBhcmFtcykuY3JlYXRlUmVhZFN0cmVhbSgpLnBpcGUob3V0KTsKICAgICAqIEByZXR1cm4gW1N0cmVhbV0gdGhlIHJlYWRhYmxlIHN0cmVhbSBvYmplY3QgdGhhdCBjYW4gYmUgcGlwZWQKICAgICAqICAgb3IgcmVhZCBmcm9tIChieSByZWdpc3RlcmluZyAnZGF0YScgZXZlbnQgbGlzdGVuZXJzKS4KICAgICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICAgKi8KICAgIGNyZWF0ZVJlYWRTdHJlYW06IGZ1bmN0aW9uIGNyZWF0ZVJlYWRTdHJlYW0oKSB7CiAgICAgIHZhciBzdHJlYW1zID0gQVdTLnV0aWwuc3RyZWFtOwogICAgICB2YXIgcmVxID0gdGhpczsKICAgICAgdmFyIHN0cmVhbSA9IG51bGw7CiAgCiAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICAgIHN0cmVhbSA9IG5ldyBzdHJlYW1zLlBhc3NUaHJvdWdoKCk7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsgcmVxLnNlbmQoKTsgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyZWFtID0gbmV3IHN0cmVhbXMuU3RyZWFtKCk7CiAgICAgICAgc3RyZWFtLnJlYWRhYmxlID0gdHJ1ZTsKICAKICAgICAgICBzdHJlYW0uc2VudCA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5vbignbmV3TGlzdGVuZXInLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgaWYgKCFzdHJlYW0uc2VudCAmJiBldmVudCA9PT0gJ2RhdGEnKSB7CiAgICAgICAgICAgIHN0cmVhbS5zZW50ID0gdHJ1ZTsKICAgICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsgcmVxLnNlbmQoKTsgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICB9KTsKICAKICAgICAgdGhpcy5vbignaHR0cEhlYWRlcnMnLCBmdW5jdGlvbiBzdHJlYW1IZWFkZXJzKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3ApIHsKICAgICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICAgICAgcmVxLnJlbW92ZUxpc3RlbmVyKCdodHRwRGF0YScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQSk7CiAgICAgICAgICByZXEucmVtb3ZlTGlzdGVuZXIoJ2h0dHBFcnJvcicsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfRVJST1IpOwogICAgICAgICAgcmVxLm9uKCdodHRwRXJyb3InLCBmdW5jdGlvbiBzdHJlYW1IdHRwRXJyb3IoZXJyb3IpIHsKICAgICAgICAgICAgcmVzcC5lcnJvciA9IGVycm9yOwogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IGZhbHNlOwogICAgICAgICAgfSk7CiAgCiAgICAgICAgICB2YXIgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICB2YXIgZXhwZWN0ZWRMZW47CiAgICAgICAgICBpZiAocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCAhPT0gJ0hFQUQnKSB7CiAgICAgICAgICAgIGV4cGVjdGVkTGVuID0gcGFyc2VJbnQoaGVhZGVyc1snY29udGVudC1sZW5ndGgnXSwgMTApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4cGVjdGVkTGVuICE9PSB1bmRlZmluZWQgJiYgIWlzTmFOKGV4cGVjdGVkTGVuKSAmJiBleHBlY3RlZExlbiA+PSAwKSB7CiAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IHRydWU7CiAgICAgICAgICAgIHZhciByZWNlaXZlZExlbiA9IDA7CiAgICAgICAgICB9CiAgCiAgICAgICAgICB2YXIgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCA9IGZ1bmN0aW9uIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQoKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggJiYgcmVjZWl2ZWRMZW4gIT09IGV4cGVjdGVkTGVuKSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgQVdTLnV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgICBuZXcgRXJyb3IoJ1N0cmVhbSBjb250ZW50IGxlbmd0aCBtaXNtYXRjaC4gUmVjZWl2ZWQgJyArCiAgICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICsgJyBvZiAnICsgZXhwZWN0ZWRMZW4gKyAnIGJ5dGVzLicpLAogICAgICAgICAgICAgICAgeyBjb2RlOiAnU3RyZWFtQ29udGVudExlbmd0aE1pc21hdGNoJyB9CiAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICAgICAgICBzdHJlYW0uZW5kKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2VuZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogIAogICAgICAgICAgdmFyIGh0dHBTdHJlYW0gPSByZXNwLmh0dHBSZXNwb25zZS5jcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtKCk7CiAgCiAgICAgICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENoZWNrQ29udGVudExlbmd0aCkgewogICAgICAgICAgICAgIHZhciBsZW5ndGhBY2N1bXVsYXRvciA9IG5ldyBzdHJlYW1zLlBhc3NUaHJvdWdoKCk7CiAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuX3dyaXRlID0gZnVuY3Rpb24oY2h1bmspIHsKICAgICAgICAgICAgICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKz0gY2h1bmsubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHN0cmVhbXMuUGFzc1Rocm91Z2gucHJvdG90eXBlLl93cml0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH07CiAgCiAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3Iub24oJ2VuZCcsIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQpOwogICAgICAgICAgICAgIHN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaHR0cFN0cmVhbS51bnBpcGUobGVuZ3RoQWNjdW11bGF0b3IpOwogICAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuZW1pdCgnZW5kJyk7CiAgICAgICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5lbmQoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBodHRwU3RyZWFtLnBpcGUobGVuZ3RoQWNjdW11bGF0b3IpLnBpcGUoc3RyZWFtLCB7IGVuZDogZmFsc2UgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaHR0cFN0cmVhbS5waXBlKHN0cmVhbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgCiAgICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGgpIHsKICAgICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJnICYmIGFyZy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKz0gYXJnLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICBodHRwU3RyZWFtLm9uKCdkYXRhJywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2RhdGEnLCBhcmcpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaHR0cFN0cmVhbS5vbignZW5kJywgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBodHRwU3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBzdHJlYW07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcGFyYW0gW0FycmF5LFJlc3BvbnNlXSBhcmdzIFRoaXMgc2hvdWxkIGJlIHRoZSByZXNwb25zZSBvYmplY3QsCiAgICAgKiAgIG9yIGFuIGFycmF5IG9mIGFyZ3MgdG8gc2VuZCB0byB0aGUgZXZlbnQuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZW1pdEV2ZW50OiBmdW5jdGlvbiBlbWl0KGV2ZW50TmFtZSwgYXJncywgZG9uZSkgewogICAgICBpZiAodHlwZW9mIGFyZ3MgPT09ICdmdW5jdGlvbicpIHsgZG9uZSA9IGFyZ3M7IGFyZ3MgPSBudWxsOyB9CiAgICAgIGlmICghZG9uZSkgZG9uZSA9IGZ1bmN0aW9uKCkgeyB9OwogICAgICBpZiAoIWFyZ3MpIGFyZ3MgPSB0aGlzLmV2ZW50UGFyYW1ldGVycyhldmVudE5hbWUsIHRoaXMucmVzcG9uc2UpOwogIAogICAgICB2YXIgb3JpZ0VtaXQgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5lbWl0OwogICAgICBvcmlnRW1pdC5jYWxsKHRoaXMsIGV2ZW50TmFtZSwgYXJncywgZnVuY3Rpb24gKGVycikgewogICAgICAgIGlmIChlcnIpIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgZG9uZS5jYWxsKHRoaXMsIGVycik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV2ZW50UGFyYW1ldGVyczogZnVuY3Rpb24gZXZlbnRQYXJhbWV0ZXJzKGV2ZW50TmFtZSkgewogICAgICBzd2l0Y2ggKGV2ZW50TmFtZSkgewogICAgICAgIGNhc2UgJ3Jlc3RhcnQnOgogICAgICAgIGNhc2UgJ3ZhbGlkYXRlJzoKICAgICAgICBjYXNlICdzaWduJzoKICAgICAgICBjYXNlICdidWlsZCc6CiAgICAgICAgY2FzZSAnYWZ0ZXJWYWxpZGF0ZSc6CiAgICAgICAgY2FzZSAnYWZ0ZXJCdWlsZCc6CiAgICAgICAgICByZXR1cm4gW3RoaXNdOwogICAgICAgIGNhc2UgJ2Vycm9yJzoKICAgICAgICAgIHJldHVybiBbdGhpcy5yZXNwb25zZS5lcnJvciwgdGhpcy5yZXNwb25zZV07CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBbdGhpcy5yZXNwb25zZV07CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwcmVzaWduOiBmdW5jdGlvbiBwcmVzaWduKGV4cGlyZXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIGV4cGlyZXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IGV4cGlyZXM7CiAgICAgICAgZXhwaXJlcyA9IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBBV1MuU2lnbmVycy5QcmVzaWduKCkuc2lnbih0aGlzLnRvR2V0KCksIGV4cGlyZXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc1ByZXNpZ25lZDogZnVuY3Rpb24gaXNQcmVzaWduZWQoKSB7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5odHRwUmVxdWVzdC5oZWFkZXJzLCAncHJlc2lnbmVkLWV4cGlyZXMnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0b1VuYXV0aGVudGljYXRlZDogZnVuY3Rpb24gdG9VbmF1dGhlbnRpY2F0ZWQoKSB7CiAgICAgIHRoaXMuX3VuQXV0aGVudGljYXRlZCA9IHRydWU7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfQ1JFREVOVElBTFMpOwogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdzaWduJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0lHTik7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRvR2V0OiBmdW5jdGlvbiB0b0dldCgpIHsKICAgICAgaWYgKHRoaXMuc2VydmljZS5hcGkucHJvdG9jb2wgPT09ICdxdWVyeScgfHwKICAgICAgICAgIHRoaXMuc2VydmljZS5hcGkucHJvdG9jb2wgPT09ICdlYzInKSB7CiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignYnVpbGQnLCB0aGlzLmJ1aWxkQXNHZXQpOwogICAgICAgIHRoaXMuYWRkTGlzdGVuZXIoJ2J1aWxkJywgdGhpcy5idWlsZEFzR2V0KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBidWlsZEFzR2V0OiBmdW5jdGlvbiBidWlsZEFzR2V0KHJlcXVlc3QpIHsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5tZXRob2QgPSAnR0VUJzsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5wYXRoID0gcmVxdWVzdC5zZXJ2aWNlLmVuZHBvaW50LnBhdGggKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPycgKyByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmJvZHk7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuYm9keSA9ICcnOwogIAogICAgICAvLyBkb24ndCBuZWVkIHRoZXNlIGhlYWRlcnMgb24gYSBHRVQgcmVxdWVzdAogICAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddOwogICAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoYWx0SGFuZGxlcnNPbkVycm9yOiBmdW5jdGlvbiBoYWx0SGFuZGxlcnNPbkVycm9yKCkgewogICAgICB0aGlzLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gdHJ1ZTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUmVxdWVzdC5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHRoaXMucHJvdG90eXBlLnByb21pc2UgPSBmdW5jdGlvbiBwcm9taXNlKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIC8vIGFwcGVuZCB0byB1c2VyIGFnZW50CiAgICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ3Byb21pc2UnKTsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlRGVwZW5kZW5jeShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBzZWxmLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgICAgIHJlamVjdChyZXNwLmVycm9yKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGRlZmluZSAkcmVzcG9uc2UgcHJvcGVydHkgc28gdGhhdCBpdCBpcyBub3QgZW51bWJlcmFibGUKICAgICAgICAgICAgLy8gdGhpcyBwcmV2ZW50cyBjaXJjdWxhciByZWZlcmVuY2UgZXJyb3JzIHdoZW4gc3RyaW5naWZ5aW5nIHRoZSBKU09OIG9iamVjdAogICAgICAgICAgICByZXNvbHZlKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgKICAgICAgICAgICAgICByZXNwLmRhdGEgfHwge30sCiAgICAgICAgICAgICAgJyRyZXNwb25zZScsCiAgICAgICAgICAgICAge3ZhbHVlOiByZXNwfQogICAgICAgICAgICApKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBzZWxmLnJ1blRvKCk7CiAgICAgIH0pOwogICAgfTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5SZXF1ZXN0LmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUucHJvbWlzZTsKICB9OwogIAogIEFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5SZXF1ZXN0KTsKICAKICBBV1MudXRpbC5taXhpbihBV1MuUmVxdWVzdCwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcik7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuL2NvcmUiOjE4LCIuL3N0YXRlX21hY2hpbmUiOjcwLCJfcHJvY2VzcyI6ODYsImptZXNwYXRoIjo4NX1dLDU2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBDb3B5cmlnaHQgMjAxMi0yMDEzIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAgICoKICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKS4gWW91CiAgICogbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZgogICAqIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXQKICAgKgogICAqICAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXBhY2hlMi4wLwogICAqCiAgICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcwogICAqIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GCiAgICogQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljCiAgICogbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICAgKi8KICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gQ0hFQ0tfQUNDRVBUT1JTKHJlc3ApIHsKICAgIHZhciB3YWl0ZXIgPSByZXNwLnJlcXVlc3QuX3dhaXRlcjsKICAgIHZhciBhY2NlcHRvcnMgPSB3YWl0ZXIuY29uZmlnLmFjY2VwdG9yczsKICAgIHZhciBhY2NlcHRvck1hdGNoZWQgPSBmYWxzZTsKICAgIHZhciBzdGF0ZSA9ICdyZXRyeSc7CiAgCiAgICBhY2NlcHRvcnMuZm9yRWFjaChmdW5jdGlvbihhY2NlcHRvcikgewogICAgICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCkgewogICAgICAgIHZhciBtYXRjaGVyID0gd2FpdGVyLm1hdGNoZXJzW2FjY2VwdG9yLm1hdGNoZXJdOwogICAgICAgIGlmIChtYXRjaGVyICYmIG1hdGNoZXIocmVzcCwgYWNjZXB0b3IuZXhwZWN0ZWQsIGFjY2VwdG9yLmFyZ3VtZW50KSkgewogICAgICAgICAgYWNjZXB0b3JNYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgIHN0YXRlID0gYWNjZXB0b3Iuc3RhdGU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAKICAgIGlmICghYWNjZXB0b3JNYXRjaGVkICYmIHJlc3AuZXJyb3IpIHN0YXRlID0gJ2ZhaWx1cmUnOwogIAogICAgaWYgKHN0YXRlID09PSAnc3VjY2VzcycpIHsKICAgICAgd2FpdGVyLnNldFN1Y2Nlc3MocmVzcCk7CiAgICB9IGVsc2UgewogICAgICB3YWl0ZXIuc2V0RXJyb3IocmVzcCwgc3RhdGUgPT09ICdyZXRyeScpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUmVzb3VyY2VXYWl0ZXIgPSBpbmhlcml0KHsKICAgIC8qKgogICAgICogV2FpdHMgZm9yIGEgZ2l2ZW4gc3RhdGUgb24gYSBzZXJ2aWNlIG9iamVjdAogICAgICogQHBhcmFtIHNlcnZpY2UgW1NlcnZpY2VdIHRoZSBzZXJ2aWNlIG9iamVjdCB0byB3YWl0IG9uCiAgICAgKiBAcGFyYW0gc3RhdGUgW1N0cmluZ10gdGhlIHN0YXRlIChkZWZpbmVkIGluIHdhaXRlciBjb25maWd1cmF0aW9uKSB0byB3YWl0CiAgICAgKiAgIGZvci4KICAgICAqIEBleGFtcGxlIENyZWF0ZSBhIHdhaXRlciBmb3IgcnVubmluZyBFQzIgaW5zdGFuY2VzCiAgICAgKiAgIHZhciBlYzIgPSBuZXcgQVdTLkVDMjsKICAgICAqICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIoZWMyLCAnaW5zdGFuY2VSdW5uaW5nJyk7CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBjb25zdHJ1Y3RvcihzZXJ2aWNlLCBzdGF0ZSkgewogICAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlOwogICAgICB0aGlzLnN0YXRlID0gc3RhdGU7CiAgICAgIHRoaXMubG9hZFdhaXRlckNvbmZpZyh0aGlzLnN0YXRlKTsKICAgIH0sCiAgCiAgICBzZXJ2aWNlOiBudWxsLAogIAogICAgc3RhdGU6IG51bGwsCiAgCiAgICBjb25maWc6IG51bGwsCiAgCiAgICBtYXRjaGVyczogewogICAgICBwYXRoOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHQsZXhwZWN0ZWQpOwogICAgICB9LAogIAogICAgICBwYXRoQWxsOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHJlc3VsdHMgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHRzKSkgcmVzdWx0cyA9IFtyZXN1bHRzXTsKICAgICAgICB2YXIgbnVtUmVzdWx0cyA9IHJlc3VsdHMubGVuZ3RoOwogICAgICAgIGlmICghbnVtUmVzdWx0cykgcmV0dXJuIGZhbHNlOwogICAgICAgIGZvciAodmFyIGluZCA9IDAgOyBpbmQgPCBudW1SZXN1bHRzOyBpbmQrKykgewogICAgICAgICAgaWYgKCFqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAKICAgICAgcGF0aEFueTogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICAgIGlmIChqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAKICAgICAgc3RhdHVzOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICByZXR1cm4gKHR5cGVvZiBzdGF0dXNDb2RlID09PSAnbnVtYmVyJykgJiYgKHN0YXR1c0NvZGUgPT09IGV4cGVjdGVkKTsKICAgICAgfSwKICAKICAgICAgZXJyb3I6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBleHBlY3RlZCA9PT0gJ3N0cmluZycgJiYgcmVzcC5lcnJvcikgewogICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSByZXNwLmVycm9yLmNvZGU7CiAgICAgICAgfQogICAgICAgIC8vIGlmIGV4cGVjdGVkIGlzIG5vdCBzdHJpbmcsIGNhbiBiZSBib29sZWFuIGluZGljYXRpbmcgcHJlc2VuY2Ugb2YgZXJyb3IKICAgICAgICByZXR1cm4gZXhwZWN0ZWQgPT09ICEhcmVzcC5lcnJvcjsKICAgICAgfQogICAgfSwKICAKICAgIGxpc3RlbmVyczogbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IgJiYgcmVzcC5lcnJvci5jb2RlID09PSAnUmVzb3VyY2VOb3RSZWFkeScpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9ICh3YWl0ZXIuY29uZmlnLmRlbGF5IHx8IDApICogMTAwMDsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0NIRUNLX09VVFBVVCcsICdleHRyYWN0RGF0YScsIENIRUNLX0FDQ0VQVE9SUyk7CiAgCiAgICAgIGFkZCgnQ0hFQ0tfRVJST1InLCAnZXh0cmFjdEVycm9yJywgQ0hFQ0tfQUNDRVBUT1JTKTsKICAgIH0pLAogIAogICAgLyoqCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0KICAgICAqLwogICAgd2FpdDogZnVuY3Rpb24gd2FpdChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7IHBhcmFtcyA9IHVuZGVmaW5lZDsKICAgICAgfQogIAogICAgICBpZiAocGFyYW1zICYmIHBhcmFtcy4kd2FpdGVyKSB7CiAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLiR3YWl0ZXIuZGVsYXkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aGlzLmNvbmZpZy5kZWxheSA9IHBhcmFtcy4kd2FpdGVyLmRlbGF5OwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLm1heEF0dGVtcHRzID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhpcy5jb25maWcubWF4QXR0ZW1wdHMgPSBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0czsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHBhcmFtcy4kd2FpdGVyOwogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5zZXJ2aWNlLm1ha2VSZXF1ZXN0KHRoaXMuY29uZmlnLm9wZXJhdGlvbiwgcGFyYW1zKTsKICAgICAgcmVxdWVzdC5fd2FpdGVyID0gdGhpczsKICAgICAgcmVxdWVzdC5yZXNwb25zZS5tYXhSZXRyaWVzID0gdGhpcy5jb25maWcubWF4QXR0ZW1wdHM7CiAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKHRoaXMubGlzdGVuZXJzKTsKICAKICAgICAgaWYgKGNhbGxiYWNrKSByZXF1ZXN0LnNlbmQoY2FsbGJhY2spOwogICAgICByZXR1cm4gcmVxdWVzdDsKICAgIH0sCiAgCiAgICBzZXRTdWNjZXNzOiBmdW5jdGlvbiBzZXRTdWNjZXNzKHJlc3ApIHsKICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgIHJlc3AuZGF0YSA9IHJlc3AuZGF0YSB8fCB7fTsKICAgICAgcmVzcC5yZXF1ZXN0LnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdERhdGEnKTsKICAgIH0sCiAgCiAgICBzZXRFcnJvcjogZnVuY3Rpb24gc2V0RXJyb3IocmVzcCwgcmV0cnlhYmxlKSB7CiAgICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihyZXNwLmVycm9yIHx8IG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ1Jlc291cmNlTm90UmVhZHknLAogICAgICAgIG1lc3NhZ2U6ICdSZXNvdXJjZSBpcyBub3QgaW4gdGhlIHN0YXRlICcgKyB0aGlzLnN0YXRlLAogICAgICAgIHJldHJ5YWJsZTogcmV0cnlhYmxlCiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogTG9hZHMgd2FpdGVyIGNvbmZpZ3VyYXRpb24gZnJvbSBBUEkgY29uZmlndXJhdGlvbgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkV2FpdGVyQ29uZmlnOiBmdW5jdGlvbiBsb2FkV2FpdGVyQ29uZmlnKHN0YXRlKSB7CiAgICAgIGlmICghdGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSkgewogICAgICAgIHRocm93IG5ldyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ1N0YXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnU3RhdGUgJyArIHN0YXRlICsgJyBub3QgZm91bmQuJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHRoaXMuY29uZmlnID0gQVdTLnV0aWwuY29weSh0aGlzLnNlcnZpY2UuYXBpLndhaXRlcnNbc3RhdGVdKTsKICAgIH0KICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOCwiam1lc3BhdGgiOjg1fV0sNTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKICAKICAvKioKICAgKiBUaGlzIGNsYXNzIGVuY2Fwc3VsYXRlcyB0aGUgcmVzcG9uc2UgaW5mb3JtYXRpb24KICAgKiBmcm9tIGEgc2VydmljZSByZXF1ZXN0IG9wZXJhdGlvbiBzZW50IHRocm91Z2gge0FXUy5SZXF1ZXN0fS4KICAgKiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0d28gbWFpbiBwcm9wZXJ0aWVzIGZvciBnZXR0aW5nIGluZm9ybWF0aW9uCiAgICogYmFjayBmcm9tIGEgcmVxdWVzdDoKICAgKgogICAqICMjIFRoZSBgZGF0YWAgcHJvcGVydHkKICAgKgogICAqIFRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkgY29udGFpbnMgdGhlIHNlcmlhbGl6ZWQgb2JqZWN0IGRhdGEKICAgKiByZXRyaWV2ZWQgZnJvbSB0aGUgc2VydmljZSByZXF1ZXN0LiBGb3IgaW5zdGFuY2UsIGZvciBhbgogICAqIEFtYXpvbiBEeW5hbW9EQiBgbGlzdFRhYmxlc2AgbWV0aG9kIGNhbGwsIHRoZSByZXNwb25zZSBkYXRhIG1pZ2h0CiAgICogbG9vayBsaWtlOgogICAqCiAgICogYGBgCiAgICogPiByZXNwLmRhdGEKICAgKiB7IFRhYmxlTmFtZXM6CiAgICogICAgWyAndGFibGUxJywgJ3RhYmxlMicsIC4uLiBdIH0KICAgKiBgYGAKICAgKgogICAqIFRoZSBgZGF0YWAgcHJvcGVydHkgY2FuIGJlIG51bGwgaWYgYW4gZXJyb3Igb2NjdXJzIChzZWUgYmVsb3cpLgogICAqCiAgICogIyMgVGhlIGBlcnJvcmAgcHJvcGVydHkKICAgKgogICAqIEluIHRoZSBldmVudCBvZiBhIHNlcnZpY2UgZXJyb3IgKG9yIHRyYW5zZmVyIGVycm9yKSwgdGhlCiAgICogYHJlc3BvbnNlLmVycm9yYCBwcm9wZXJ0eSB3aWxsIGJlIGZpbGxlZCB3aXRoIHRoZSBnaXZlbgogICAqIGVycm9yIGRhdGEgaW4gdGhlIGZvcm06CiAgICoKICAgKiBgYGAKICAgKiB7IGNvZGU6ICdTSE9SVF9VTklRVUVfRVJST1JfQ09ERScsCiAgICogICBtZXNzYWdlOiAnU29tZSBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlJyB9CiAgICogYGBgCiAgICoKICAgKiBJbiB0aGUgY2FzZSBvZiBhbiBlcnJvciwgdGhlIGBkYXRhYCBwcm9wZXJ0eSB3aWxsIGJlIGBudWxsYC4KICAgKiBOb3RlIHRoYXQgaWYgeW91IGhhbmRsZSBldmVudHMgdGhhdCBjYW4gYmUgaW4gYSBmYWlsdXJlIHN0YXRlLAogICAqIHlvdSBzaG91bGQgYWx3YXlzIGNoZWNrIHdoZXRoZXIgYHJlc3BvbnNlLmVycm9yYCBpcyBzZXQKICAgKiBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgdGhlIGByZXNwb25zZS5kYXRhYCBwcm9wZXJ0eS4KICAgKgogICAqIEAhYXR0cmlidXRlIGRhdGEKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICAgKiAgIEBub3RlIEluc2lkZSBvZiBhIHtBV1MuUmVxdWVzdH5odHRwRGF0YX0gZXZlbnQsIHRoaXMKICAgKiAgICAgcHJvcGVydHkgY29udGFpbnMgYSBzaW5nbGUgcmF3IHBhY2tldCBpbnN0ZWFkIG9mIHRoZQogICAqICAgICBmdWxsIGRlLXNlcmlhbGl6ZWQgc2VydmljZSByZXNwb25zZS4KICAgKiAgIEByZXR1cm4gW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgcmVzcG9uc2UgZGF0YQogICAqICAgICBmcm9tIHRoZSBzZXJ2aWNlLgogICAqCiAgICogQCFhdHRyaWJ1dGUgZXJyb3IKICAgKiAgIEFuIHN0cnVjdHVyZSBjb250YWluaW5nIGluZm9ybWF0aW9uIGFib3V0IGEgc2VydmljZQogICAqICAgb3IgbmV0d29ya2luZyBlcnJvci4KICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICAgKiAgIEBub3RlIFRoaXMgYXR0cmlidXRlIGlzIG9ubHkgZmlsbGVkIGlmIGEgc2VydmljZSBvcgogICAqICAgICBuZXR3b3JraW5nIGVycm9yIG9jY3Vycy4KICAgKiAgIEByZXR1cm4gW0Vycm9yXQogICAqICAgICAqIGNvZGUgW1N0cmluZ10gYSB1bmlxdWUgc2hvcnQgY29kZSByZXByZXNlbnRpbmcgdGhlCiAgICogICAgICAgZXJyb3IgdGhhdCB3YXMgZW1pdHRlZC4KICAgKiAgICAgKiBtZXNzYWdlIFtTdHJpbmddIGEgbG9uZ2VyIGh1bWFuIHJlYWRhYmxlIGVycm9yIG1lc3NhZ2UKICAgKiAgICAgKiByZXRyeWFibGUgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGVycm9yIG1lc3NhZ2UgaXMKICAgKiAgICAgICByZXRyeWFibGUuCiAgICogICAgICogc3RhdHVzQ29kZSBbTnVtZXJpY10gaW4gdGhlIGNhc2Ugb2YgYSByZXF1ZXN0IHRoYXQgcmVhY2hlZCB0aGUgc2VydmljZSwKICAgKiAgICAgICB0aGlzIHZhbHVlIGNvbnRhaW5zIHRoZSByZXNwb25zZSBzdGF0dXMgY29kZS4KICAgKiAgICAgKiB0aW1lIFtEYXRlXSB0aGUgZGF0ZSB0aW1lIG9iamVjdCB3aGVuIHRoZSBlcnJvciBvY2N1cnJlZC4KICAgKiAgICAgKiBob3N0bmFtZSBbU3RyaW5nXSBzZXQgd2hlbiBhIG5ldHdvcmtpbmcgZXJyb3Igb2NjdXJzIHRvIGVhc2lseQogICAqICAgICAgIGlkZW50aWZ5IHRoZSBlbmRwb2ludCBvZiB0aGUgcmVxdWVzdC4KICAgKiAgICAgKiByZWdpb24gW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICAgKiAgICAgICBpZGVudGlmeSB0aGUgcmVnaW9uIG9mIHRoZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVxdWVzdElkCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSB1bmlxdWUgcmVxdWVzdCBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIHJlc3BvbnNlLgogICAqICAgICBMb2cgdGhpcyB2YWx1ZSB3aGVuIGRlYnVnZ2luZyByZXF1ZXN0cyBmb3IgQVdTIHN1cHBvcnQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZXRyeUNvdW50CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2YgcmV0cmllcyB0aGF0IHdlcmUKICAgKiAgICAgYXR0ZW1wdGVkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmVkaXJlY3RDb3VudAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJlZGlyZWN0cyB0aGF0IHdlcmUKICAgKiAgICAgZm9sbG93ZWQgYmVmb3JlIHRoZSByZXF1ZXN0IHdhcyBjb21wbGV0ZWQuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBodHRwUmVzcG9uc2UKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICAgKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVzcG9uc2VdIHRoZSByYXcgSFRUUCByZXNwb25zZSBvYmplY3QKICAgKiAgICAgY29udGFpbmluZyB0aGUgcmVzcG9uc2UgaGVhZGVycyBhbmQgYm9keSBpbmZvcm1hdGlvbgogICAqICAgICBmcm9tIHRoZSBzZXJ2ZXIuCiAgICoKICAgKiBAc2VlIEFXUy5SZXF1ZXN0CiAgICovCiAgQVdTLlJlc3BvbnNlID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVzcG9uc2UocmVxdWVzdCkgewogICAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgICB0aGlzLmVycm9yID0gbnVsbDsKICAgICAgdGhpcy5yZXRyeUNvdW50ID0gMDsKICAgICAgdGhpcy5yZWRpcmVjdENvdW50ID0gMDsKICAgICAgdGhpcy5odHRwUmVzcG9uc2UgPSBuZXcgQVdTLkh0dHBSZXNwb25zZSgpOwogICAgICBpZiAocmVxdWVzdCkgewogICAgICAgIHRoaXMubWF4UmV0cmllcyA9IHJlcXVlc3Quc2VydmljZS5udW1SZXRyaWVzKCk7CiAgICAgICAgdGhpcy5tYXhSZWRpcmVjdHMgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLm1heFJlZGlyZWN0czsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyByZXF1ZXN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIHJlc3BvbnNlIGRhdGEsIGNhbGxpbmcgdGhlCiAgICAgKiBjYWxsYmFjayB3aXRoIHRoZSBwYWdlIGRhdGEgaWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICBDYWxsZWQgd2hlbiBhIHBhZ2Ugb2YgZGF0YSBpcyByZXR1cm5lZCBmcm9tIHRoZSBuZXh0IHJlcXVlc3QuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gYW4gZXJyb3Igb2JqZWN0LCBpZiBhbiBlcnJvciBvY2N1cnJlZCBpbiB0aGUgcmVxdWVzdAogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgbmV4dCBwYWdlIG9mIGRhdGEsIG9yIG51bGwsIGlmIHRoZXJlIGFyZSBubwogICAgICogICAgIG1vcmUgcGFnZXMgbGVmdC4KICAgICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgZm9yIHRoZSBuZXh0IHBhZ2Ugb2YgZGF0YQogICAgICogQHJldHVybiBbbnVsbF0gaWYgbm8gY2FsbGJhY2sgaXMgcHJvdmlkZWQgYW5kIHRoZXJlIGFyZSBubyBwYWdlcyBsZWZ0CiAgICAgKiAgIHRvIHJldHJpZXZlLgogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBuZXh0UGFnZTogZnVuY3Rpb24gbmV4dFBhZ2UoY2FsbGJhY2spIHsKICAgICAgdmFyIGNvbmZpZzsKICAgICAgdmFyIHNlcnZpY2UgPSB0aGlzLnJlcXVlc3Quc2VydmljZTsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHRoaXMucmVxdWVzdC5vcGVyYXRpb247CiAgICAgIHRyeSB7CiAgICAgICAgY29uZmlnID0gc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdHJ1ZSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsgdGhpcy5lcnJvciA9IGU7IH0KICAKICAgICAgaWYgKCF0aGlzLmhhc05leHRQYWdlKCkpIHsKICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMuZXJyb3IsIG51bGwpOwogICAgICAgIGVsc2UgaWYgKHRoaXMuZXJyb3IpIHRocm93IHRoaXMuZXJyb3I7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAKICAgICAgdmFyIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkodGhpcy5yZXF1ZXN0LnBhcmFtcyk7CiAgICAgIGlmICghdGhpcy5uZXh0UGFnZVRva2VucykgewogICAgICAgIHJldHVybiBjYWxsYmFjayA/IGNhbGxiYWNrKG51bGwsIG51bGwpIDogbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaW5wdXRUb2tlbnMgPSBjb25maWcuaW5wdXRUb2tlbjsKICAgICAgICBpZiAodHlwZW9mIGlucHV0VG9rZW5zID09PSAnc3RyaW5nJykgaW5wdXRUb2tlbnMgPSBbaW5wdXRUb2tlbnNdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXRUb2tlbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHBhcmFtc1tpbnB1dFRva2Vuc1tpXV0gPSB0aGlzLm5leHRQYWdlVG9rZW5zW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLnJlcXVlc3Qub3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciBtb3JlIHBhZ2VzIG9mIGRhdGEgY2FuIGJlIHJldHVybmVkIGJ5IGZ1cnRoZXIKICAgICAqICAgcmVxdWVzdHMKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgaGFzTmV4dFBhZ2U6IGZ1bmN0aW9uIGhhc05leHRQYWdlKCkgewogICAgICB0aGlzLmNhY2hlTmV4dFBhZ2VUb2tlbnMoKTsKICAgICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5uZXh0UGFnZVRva2VucyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICBlbHNlIHJldHVybiBmYWxzZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWNoZU5leHRQYWdlVG9rZW5zOiBmdW5jdGlvbiBjYWNoZU5leHRQYWdlVG9rZW5zKCkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsICduZXh0UGFnZVRva2VucycpKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHVuZGVmaW5lZDsKICAKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMucmVxdWVzdC5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbik7CiAgICAgIGlmICghY29uZmlnKSByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAKICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IG51bGw7CiAgICAgIGlmIChjb25maWcubW9yZVJlc3VsdHMpIHsKICAgICAgICBpZiAoIWptZXNwYXRoLnNlYXJjaCh0aGlzLmRhdGEsIGNvbmZpZy5tb3JlUmVzdWx0cykpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgZXhwcnMgPSBjb25maWcub3V0cHV0VG9rZW47CiAgICAgIGlmICh0eXBlb2YgZXhwcnMgPT09ICdzdHJpbmcnKSBleHBycyA9IFtleHByc107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGV4cHJzLCBmdW5jdGlvbiAoZXhwcikgewogICAgICAgIHZhciBvdXRwdXQgPSBqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBleHByKTsKICAgICAgICBpZiAob3V0cHV0KSB7CiAgICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gdGhpcy5uZXh0UGFnZVRva2VucyB8fCBbXTsKICAgICAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMucHVzaChvdXRwdXQpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogICAgfQogIAogIH0pOwogIAogIH0seyIuL2NvcmUiOjE4LCJqbWVzcGF0aCI6ODV9XSw1ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEAhbWV0aG9kIG9uKGV2ZW50TmFtZSwgY2FsbGJhY2spCiAgICogICBSZWdpc3RlcnMgYW4gZXZlbnQgbGlzdGVuZXIgY2FsbGJhY2sgZm9yIHRoZSBldmVudCBnaXZlbiBieSBgZXZlbnROYW1lYC4KICAgKiAgIFBhcmFtZXRlcnMgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBkZXBlbmQgb24gdGhlIGluZGl2aWR1YWwgZXZlbnQKICAgKiAgIGJlaW5nIHRyaWdnZXJlZC4gU2VlIHRoZSBldmVudCBkb2N1bWVudGF0aW9uIGZvciB0aG9zZSBwYXJhbWV0ZXJzLgogICAqCiAgICogICBAcGFyYW0gZXZlbnROYW1lIFtTdHJpbmddIHRoZSBldmVudCBuYW1lIHRvIHJlZ2lzdGVyIHRoZSBsaXN0ZW5lciBmb3IKICAgKiAgIEBwYXJhbSBjYWxsYmFjayBbRnVuY3Rpb25dIHRoZSBsaXN0ZW5lciBjYWxsYmFjayBmdW5jdGlvbgogICAqICAgQHBhcmFtIHRvSGVhZCBbQm9vbGVhbl0gYXR0YWNoIHRoZSBsaXN0ZW5lciBjYWxsYmFjayB0byB0aGUgaGVhZCBvZiBjYWxsYmFjayBhcnJheSBpZiBzZXQgdG8gdHJ1ZS4KICAgKiAgICAgRGVmYXVsdCB0byBiZSBmYWxzZS4KICAgKiAgIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBzYW1lIG9iamVjdCBmb3IgY2hhaW5pbmcKICAgKi8KICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VxdWVudGlhbEV4ZWN1dG9yKCkgewogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsaXN0ZW5lcnM6IGZ1bmN0aW9uIGxpc3RlbmVycyhldmVudE5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdID8gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0uc2xpY2UoMCkgOiBbXTsKICAgIH0sCiAgCiAgICBvbjogZnVuY3Rpb24gb24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICAgIGlmICh0aGlzLl9ldmVudHNbZXZlbnROYW1lXSkgewogICAgICAgIHRvSGVhZCA/CiAgICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS51bnNoaWZ0KGxpc3RlbmVyKSA6CiAgICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXS5wdXNoKGxpc3RlbmVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA9IFtsaXN0ZW5lcl07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgb25Bc3luYzogZnVuY3Rpb24gb25Bc3luYyhldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpIHsKICAgICAgbGlzdGVuZXIuX2lzQXN5bmMgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5vbihldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpOwogICAgfSwKICAKICAgIHJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihldmVudE5hbWUsIGxpc3RlbmVyKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgaWYgKGxpc3RlbmVycykgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOwogICAgICAgIHZhciBwb3NpdGlvbiA9IC0xOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaV0gPT09IGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBvc2l0aW9uID4gLTEpIHsKICAgICAgICAgIGxpc3RlbmVycy5zcGxpY2UocG9zaXRpb24sIDEpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICByZW1vdmVBbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIHJlbW92ZUFsbExpc3RlbmVycyhldmVudE5hbWUpIHsKICAgICAgaWYgKGV2ZW50TmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbWl0OiBmdW5jdGlvbiBlbWl0KGV2ZW50TmFtZSwgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spIHsKICAgICAgaWYgKCFkb25lQ2FsbGJhY2spIGRvbmVDYWxsYmFjayA9IGZ1bmN0aW9uKCkgeyB9OwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnMoZXZlbnROYW1lKTsKICAgICAgdmFyIGNvdW50ID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgdGhpcy5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgZXZlbnRBcmdzLCBkb25lQ2FsbGJhY2spOwogICAgICByZXR1cm4gY291bnQgPiAwOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIGNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIHByZXZFcnJvcikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBlcnJvciA9IHByZXZFcnJvciB8fCBudWxsOwogIAogICAgICBmdW5jdGlvbiBjYWxsTmV4dExpc3RlbmVyKGVycikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgICBpZiAoc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgICByZXR1cm4gZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZWxmLmNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIGVycm9yKTsKICAgICAgfQogIAogICAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgbGlzdGVuZXIgPSBsaXN0ZW5lcnMuc2hpZnQoKTsKICAgICAgICBpZiAobGlzdGVuZXIuX2lzQXN5bmMpIHsgLy8gYXN5bmNocm9ub3VzIGxpc3RlbmVyCiAgICAgICAgICBsaXN0ZW5lci5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChbY2FsbE5leHRMaXN0ZW5lcl0pKTsKICAgICAgICAgIHJldHVybjsgLy8gc3RvcCBoZXJlLCBjYWxsTmV4dExpc3RlbmVyIHdpbGwgY29udGludWUKICAgICAgICB9IGVsc2UgeyAvLyBzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnJvciB8fCBuZXcgRXJyb3IoKSwgZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlcnJvciAmJiBzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yKSB7CiAgICAgICAgICAgIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBZGRzIG9yIGNvcGllcyBhIHNldCBvZiBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGxpc3Qgb2YKICAgICAqIGxpc3RlbmVycyBvciBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSBsaXN0ZW5lcnMgW21hcDxTdHJpbmcsQXJyYXk8RnVuY3Rpb24+PiwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0KICAgICAqICAgYSBsaXN0IG9mIGV2ZW50cyBhbmQgY2FsbGJhY2tzLCBvciBhbiBldmVudCBlbWl0dGVyIG9iamVjdAogICAgICogICBjb250YWluaW5nIGxpc3RlbmVycyB0byBhZGQgdG8gdGhpcyBlbWl0dGVyIG9iamVjdC4KICAgICAqIEByZXR1cm4gW0FXUy5TZXF1ZW50aWFsRXhlY3V0b3JdIHRoZSBlbWl0dGVyIG9iamVjdCwgZm9yIGNoYWluaW5nLgogICAgICogQGV4YW1wbGUgQWRkaW5nIGxpc3RlbmVycyBmcm9tIGEgbWFwIG9mIGxpc3RlbmVycwogICAgICogICBlbWl0dGVyLmFkZExpc3RlbmVycyh7CiAgICAgKiAgICAgZXZlbnQxOiBbZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbigpIHsgLi4uIH1dLAogICAgICogICAgIGV2ZW50MjogW2Z1bmN0aW9uKCkgeyAuLi4gfV0KICAgICAqICAgfSk7CiAgICAgKiAgIGVtaXR0ZXIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIgaGFzIGV2ZW50MQogICAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyIGhhcyBldmVudDIKICAgICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhbm90aGVyIGVtaXR0ZXIgb2JqZWN0CiAgICAgKiAgIHZhciBlbWl0dGVyMSA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICAgKiAgIGVtaXR0ZXIxLm9uKCdldmVudDEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICBlbWl0dGVyMS5vbignZXZlbnQyJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgdmFyIGVtaXR0ZXIyID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAgICAqICAgZW1pdHRlcjIuYWRkTGlzdGVuZXJzKGVtaXR0ZXIxKTsKICAgICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQxJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDEKICAgICAqICAgZW1pdHRlcjIuZW1pdCgnZXZlbnQyJyk7IC8vIGVtaXR0ZXIyIGhhcyBldmVudDIKICAgICAqLwogICAgYWRkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGRMaXN0ZW5lcnMobGlzdGVuZXJzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAKICAgICAgLy8gZXh0cmFjdCBsaXN0ZW5lcnMgaWYgcGFyYW1ldGVyIGlzIGFuIFNlcXVlbnRpYWxFeGVjdXRvciBvYmplY3QKICAgICAgaWYgKGxpc3RlbmVycy5fZXZlbnRzKSBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuX2V2ZW50czsKICAKICAgICAgQVdTLnV0aWwuZWFjaChsaXN0ZW5lcnMsIGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFja3MpIHsKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrcyA9PT0gJ2Z1bmN0aW9uJykgY2FsbGJhY2tzID0gW2NhbGxiYWNrc107CiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKGNhbGxiYWNrcywgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHNlbGYub24oZXZlbnQsIGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBzZWxmOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVnaXN0ZXJzIGFuIGV2ZW50IHdpdGgge29ufSBhbmQgc2F2ZXMgdGhlIGNhbGxiYWNrIGhhbmRsZSBmdW5jdGlvbgogICAgICogYXMgYSBwcm9wZXJ0eSBvbiB0aGUgZW1pdHRlciBvYmplY3QgdXNpbmcgYSBnaXZlbiBgbmFtZWAuCiAgICAgKgogICAgICogQHBhcmFtIG5hbWUgW1N0cmluZ10gdGhlIHByb3BlcnR5IG5hbWUgdG8gc2V0IG9uIHRoaXMgb2JqZWN0IGNvbnRhaW5pbmcKICAgICAqICAgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGhhbmRsZSBzbyB0aGF0IHRoZSBsaXN0ZW5lciBjYW4gYmUgcmVtb3ZlZCBpbgogICAgICogICB0aGUgZnV0dXJlLgogICAgICogQHBhcmFtIChzZWUgb24pCiAgICAgKiBAcmV0dXJuIChzZWUgb24pCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBuYW1lZCBsaXN0ZW5lciBEQVRBX0NBTExCQUNLCiAgICAgKiAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKCkgeyBkb1NvbWV0aGluZygpOyB9OwogICAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXIoJ0RBVEFfQ0FMTEJBQ0snLCAnZGF0YScsIGxpc3RlbmVyKTsKICAgICAqCiAgICAgKiAgIC8vIHRoZSBmb2xsb3dpbmcgcHJpbnRzOiB0cnVlCiAgICAgKiAgIGNvbnNvbGUubG9nKGVtaXR0ZXIuREFUQV9DQUxMQkFDSyA9PSBsaXN0ZW5lcik7CiAgICAgKi8KICAgIGFkZE5hbWVkTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICAgIHRoaXNbbmFtZV0gPSBjYWxsYmFjazsKICAgICAgdGhpcy5hZGRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGROYW1lZEFzeW5jTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkQXN5bmNMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpIHsKICAgICAgY2FsbGJhY2suX2lzQXN5bmMgPSB0cnVlOwogICAgICByZXR1cm4gdGhpcy5hZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBIZWxwZXIgbWV0aG9kIHRvIGFkZCBhIHNldCBvZiBuYW1lZCBsaXN0ZW5lcnMgdXNpbmcKICAgICAqIHthZGROYW1lZExpc3RlbmVyfS4gVGhlIGNhbGxiYWNrIGNvbnRhaW5zIGEgcGFyYW1ldGVyCiAgICAgKiB3aXRoIGEgaGFuZGxlIHRvIHRoZSBgYWRkTmFtZWRMaXN0ZW5lcmAgbWV0aG9kLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihhZGQpCiAgICAgKiAgIFRoZSBjYWxsYmFjayBmdW5jdGlvbiBpcyBjYWxsZWQgaW1tZWRpYXRlbHkgaW4gb3JkZXIgdG8gcHJvdmlkZQogICAgICogICB0aGUgYGFkZGAgZnVuY3Rpb24gdG8gdGhlIGJsb2NrLiBUaGlzIHNpbXBsaWZpZXMgdGhlIGFkZGl0aW9uIG9mCiAgICAgKiAgIGEgbGFyZ2UgZ3JvdXAgb2YgbmFtZWQgbGlzdGVuZXJzLgogICAgICogICBAcGFyYW0gYWRkIFtGdW5jdGlvbl0gdGhlIHthZGROYW1lZExpc3RlbmVyfSBmdW5jdGlvbiB0byBjYWxsCiAgICAgKiAgICAgd2hlbiByZWdpc3RlcmluZyBsaXN0ZW5lcnMuCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzCiAgICAgKiAgIGVtaXR0ZXIuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgKiAgICAgYWRkKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICAgIGFkZCgnT1RIRVInLCAnb3RoZXJFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgICAgYWRkKCdMQVNUJywgJ2xhc3RFdmVudCcsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgIH0pOwogICAgICoKICAgICAqICAgLy8gdGhlc2UgcHJvcGVydGllcyBhcmUgbm93IHNldDoKICAgICAqICAgZW1pdHRlci5EQVRBX0NBTExCQUNLOwogICAgICogICBlbWl0dGVyLk9USEVSOwogICAgICogICBlbWl0dGVyLkxBU1Q7CiAgICAgKi8KICAgIGFkZE5hbWVkTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVycyhjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGNhbGxiYWNrKAogICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5hZGROYW1lZExpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuYWRkTmFtZWRBc3luY0xpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICApOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiB7b259IGlzIHRoZSBwcmVmZXJlZCBtZXRob2QuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLnByb3RvdHlwZS5vbjsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3I7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSw1OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBBcGkgPSByZXF1aXJlKCcuL21vZGVsL2FwaScpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWcnKTsKICAKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgdmFyIGNsaWVudENvdW50ID0gMDsKICAKICAvKioKICAgKiBUaGUgc2VydmljZSBjbGFzcyByZXByZXNlbnRpbmcgYW4gQVdTIHNlcnZpY2UuCiAgICoKICAgKiBAY2xhc3NfYWJzdHJhY3QgVGhpcyBjbGFzcyBpcyBhbiBhYnN0cmFjdCBjbGFzcy4KICAgKgogICAqIEAhYXR0cmlidXRlIGFwaVZlcnNpb25zCiAgICogICBAcmV0dXJuIFtBcnJheTxTdHJpbmc+XSB0aGUgbGlzdCBvZiBBUEkgdmVyc2lvbnMgc3VwcG9ydGVkIGJ5IHRoaXMgc2VydmljZS4KICAgKiAgIEByZWFkb25seQogICAqLwogIEFXUy5TZXJ2aWNlID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIENyZWF0ZSBhIG5ldyBzZXJ2aWNlIG9iamVjdCB3aXRoIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAqCiAgICAgKiBAcGFyYW0gY29uZmlnIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VydmljZShjb25maWcpIHsKICAgICAgaWYgKCF0aGlzLmxvYWRTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICdTZXJ2aWNlIG11c3QgYmUgY29uc3RydWN0ZWQgd2l0aCBgbmV3XCcgb3BlcmF0b3InKTsKICAgICAgfQogICAgICB2YXIgU2VydmljZUNsYXNzID0gdGhpcy5sb2FkU2VydmljZUNsYXNzKGNvbmZpZyB8fCB7fSk7CiAgICAgIGlmIChTZXJ2aWNlQ2xhc3MpIHsKICAgICAgICB2YXIgb3JpZ2luYWxDb25maWcgPSBBV1MudXRpbC5jb3B5KGNvbmZpZyk7CiAgICAgICAgdmFyIHN2YyA9IG5ldyBTZXJ2aWNlQ2xhc3MoY29uZmlnKTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoc3ZjLCAnX29yaWdpbmFsQ29uZmlnJywgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG9yaWdpbmFsQ29uZmlnOyB9LAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICB9KTsKICAgICAgICBzdmMuX2NsaWVudElkID0gKytjbGllbnRDb3VudDsKICAgICAgICByZXR1cm4gc3ZjOwogICAgICB9CiAgICAgIHRoaXMuaW5pdGlhbGl6ZShjb25maWcpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoY29uZmlnKSB7CiAgICAgIHZhciBzdmNDb25maWcgPSBBV1MuY29uZmlnW3RoaXMuc2VydmljZUlkZW50aWZpZXJdOwogICAgICB0aGlzLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKEFXUy5jb25maWcpOwogICAgICBpZiAoc3ZjQ29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoc3ZjQ29uZmlnLCB0cnVlKTsKICAgICAgaWYgKGNvbmZpZykgdGhpcy5jb25maWcudXBkYXRlKGNvbmZpZywgdHJ1ZSk7CiAgCiAgICAgIHRoaXMudmFsaWRhdGVTZXJ2aWNlKCk7CiAgICAgIGlmICghdGhpcy5jb25maWcuZW5kcG9pbnQpIHJlZ2lvbkNvbmZpZyh0aGlzKTsKICAKICAgICAgdGhpcy5jb25maWcuZW5kcG9pbnQgPSB0aGlzLmVuZHBvaW50RnJvbVRlbXBsYXRlKHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgICAgdGhpcy5zZXRFbmRwb2ludCh0aGlzLmNvbmZpZy5lbmRwb2ludCk7CiAgICAgIC8vZW5hYmxlIGF0dGFjaGluZyBsaXN0ZW5lcnMgdG8gc2VydmljZSBjbGllbnQKICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMpOwogICAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyh0aGlzKTsKICAgICAgaWYgKCh0aGlzLmNvbmZpZy5jbGllbnRTaWRlTW9uaXRvcmluZyB8fCBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcpICYmIHRoaXMucHVibGlzaGVyKSB7CiAgICAgICAgdmFyIHB1Ymxpc2hlciA9IHRoaXMucHVibGlzaGVyOwogICAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQ0FMTCcsICdhcGlDYWxsJywgZnVuY3Rpb24gUFVCTElTSF9BUElfQ0FMTChldmVudCkgewogICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtwdWJsaXNoZXIuZXZlbnRIYW5kbGVyKGV2ZW50KTt9KTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmFkZE5hbWVkTGlzdGVuZXIoJ1BVQkxJU0hfQVBJX0FUVEVNUFQnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9BVFRFTVBUKGV2ZW50KSB7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZFNlcnZpY2VDbGFzczogZnVuY3Rpb24gbG9hZFNlcnZpY2VDbGFzcyhzZXJ2aWNlQ29uZmlnKSB7CiAgICAgIHZhciBjb25maWcgPSBzZXJ2aWNlQ29uZmlnOwogICAgICBpZiAoIUFXUy51dGlsLmlzRW1wdHkodGhpcy5hcGkpKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSBpZiAoY29uZmlnLmFwaUNvbmZpZykgewogICAgICAgIHJldHVybiBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlQXBpKHRoaXMuY29uc3RydWN0b3IsIGNvbmZpZy5hcGlDb25maWcpOwogICAgICB9IGVsc2UgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uZmlnID0gbmV3IEFXUy5Db25maWcoQVdTLmNvbmZpZyk7CiAgICAgICAgY29uZmlnLnVwZGF0ZShzZXJ2aWNlQ29uZmlnLCB0cnVlKTsKICAgICAgICB2YXIgdmVyc2lvbiA9IGNvbmZpZy5hcGlWZXJzaW9uc1t0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyXTsKICAgICAgICB2ZXJzaW9uID0gdmVyc2lvbiB8fCBjb25maWcuYXBpVmVyc2lvbjsKICAgICAgICByZXR1cm4gdGhpcy5nZXRMYXRlc3RTZXJ2aWNlQ2xhc3ModmVyc2lvbik7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRMYXRlc3RTZXJ2aWNlQ2xhc3M6IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VDbGFzcyh2ZXJzaW9uKSB7CiAgICAgIHZlcnNpb24gPSB0aGlzLmdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pOwogICAgICBpZiAodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXSA9PT0gbnVsbCkgewogICAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2VBcGkodGhpcy5jb25zdHJ1Y3RvciwgdmVyc2lvbik7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXNbdmVyc2lvbl07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0TGF0ZXN0U2VydmljZVZlcnNpb246IGZ1bmN0aW9uIGdldExhdGVzdFNlcnZpY2VWZXJzaW9uKHZlcnNpb24pIHsKICAgICAgaWYgKCF0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzIHx8IHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzZXJ2aWNlcyBkZWZpbmVkIG9uICcgKwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyKTsKICAgICAgfQogIAogICAgICBpZiAoIXZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gJ2xhdGVzdCc7CiAgICAgIH0gZWxzZSBpZiAoQVdTLnV0aWwuaXNUeXBlKHZlcnNpb24sIERhdGUpKSB7CiAgICAgICAgdmVyc2lvbiA9IEFXUy51dGlsLmRhdGUuaXNvODYwMSh2ZXJzaW9uKS5zcGxpdCgnVCcpWzBdOwogICAgICB9CiAgCiAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgICByZXR1cm4gdmVyc2lvbjsKICAgICAgfQogIAogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpLnNvcnQoKTsKICAgICAgdmFyIHNlbGVjdGVkVmVyc2lvbiA9IG51bGw7CiAgICAgIGZvciAodmFyIGkgPSBrZXlzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgLy8gdmVyc2lvbnMgdGhhdCBlbmQgaW4gIioiIGFyZSBub3QgYXZhaWxhYmxlIG9uIGRpc2sgYW5kIGNhbiBiZQogICAgICAgIC8vIHNraXBwZWQsIHNvIGRvIG5vdCBjaG9vc2UgdGhlc2UgYXMgc2VsZWN0ZWRWZXJzaW9ucwogICAgICAgIGlmIChrZXlzW2ldW2tleXNbaV0ubGVuZ3RoIC0gMV0gIT09ICcqJykgewogICAgICAgICAgc2VsZWN0ZWRWZXJzaW9uID0ga2V5c1tpXTsKICAgICAgICB9CiAgICAgICAgaWYgKGtleXNbaV0uc3Vic3RyKDAsIDEwKSA8PSB2ZXJzaW9uKSB7CiAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRWZXJzaW9uOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kICcgKyB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyICsKICAgICAgICAgICAgICAgICAgICAgICcgQVBJIHRvIHNhdGlzZnkgdmVyc2lvbiBjb25zdHJhaW50IGAnICsgdmVyc2lvbiArICdcJycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaToge30sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZhdWx0UmV0cnlDb3VudDogMywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGN1c3RvbWl6ZVJlcXVlc3RzOiBmdW5jdGlvbiBjdXN0b21pemVSZXF1ZXN0cyhjYWxsYmFjaykgewogICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IGNhbGxiYWNrOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjYWxsYmFjayB0eXBlIFwnJyArIHR5cGVvZiBjYWxsYmFjayArICdcJyBwcm92aWRlZCBpbiBjdXN0b21pemVSZXF1ZXN0cycpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDYWxscyBhbiBvcGVyYXRpb24gb24gYSBzZXJ2aWNlIHdpdGggdGhlIGdpdmVuIGlucHV0IHBhcmFtZXRlcnMuCiAgICAgKgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgbmFtZSBvZiB0aGUgb3BlcmF0aW9uIHRvIGNhbGwgb24gdGhlIHNlcnZpY2UuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIGlucHV0IG9wdGlvbnMgZm9yIHRoZSBvcGVyYXRpb24KICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIG1ha2VSZXF1ZXN0OiBmdW5jdGlvbiBtYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgICBwYXJhbXMgPSBudWxsOwogICAgICB9CiAgCiAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgICAgaWYgKHRoaXMuY29uZmlnLnBhcmFtcykgeyAvLyBjb3B5IG9ubHkgdG9wbGV2ZWwgYm91bmQgcGFyYW1zCiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dOwogICAgICAgIGlmIChydWxlcykgewogICAgICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLmNvbmZpZy5wYXJhbXMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHJ1bGVzLmlucHV0Lm1lbWJlcnNba2V5XSkgewogICAgICAgICAgICAgIGlmIChwYXJhbXNba2V5XSA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtc1trZXldID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gbmV3IEFXUy5SZXF1ZXN0KHRoaXMsIG9wZXJhdGlvbiwgcGFyYW1zKTsKICAgICAgdGhpcy5hZGRBbGxSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICB0aGlzLmF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpOwogICAgICBpZiAoY2FsbGJhY2spIHJlcXVlc3Quc2VuZChjYWxsYmFjayk7CiAgICAgIHJldHVybiByZXF1ZXN0OwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2FsbHMgYW4gb3BlcmF0aW9uIG9uIGEgc2VydmljZSB3aXRoIHRoZSBnaXZlbiBpbnB1dCBwYXJhbWV0ZXJzLCB3aXRob3V0CiAgICAgKiBhbnkgYXV0aGVudGljYXRpb24gZGF0YS4gVGhpcyBtZXRob2QgaXMgdXNlZnVsIGZvciAicHVibGljIiBBUEkgb3BlcmF0aW9ucy4KICAgICAqCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgaW5wdXQgb3B0aW9ucyBmb3IgdGhlIG9wZXJhdGlvbgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgICAqLwogICAgbWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3Q6IGZ1bmN0aW9uIG1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICAgIHBhcmFtcyA9IHt9OwogICAgICB9CiAgCiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5tYWtlUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcykudG9VbmF1dGhlbnRpY2F0ZWQoKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrID8gcmVxdWVzdC5zZW5kKGNhbGxiYWNrKSA6IHJlcXVlc3Q7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBXYWl0cyBmb3IgYSBnaXZlbiBzdGF0ZQogICAgICoKICAgICAqIEBwYXJhbSBzdGF0ZSBbU3RyaW5nXSB0aGUgc3RhdGUgb24gdGhlIHNlcnZpY2UgdG8gd2FpdCBmb3IKICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgcGFyYW1ldGVycyB0byBwYXNzIHdpdGggZWFjaCByZXF1ZXN0CiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyIFttYXBdIGEgbWFwIG9mIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIHdhaXRlcgogICAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlci5kZWxheSBbTnVtYmVyXSBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdG8gd2FpdCBiZXR3ZWVuCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzCiAgICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLm1heEF0dGVtcHRzIFtOdW1iZXJdIFRoZSBtYXhpbXVtIG51bWJlciBvZiByZXF1ZXN0cwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBzZW5kIHdoaWxlIHdhaXRpbmcKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIHdhaXRGb3I6IGZ1bmN0aW9uIHdhaXRGb3Ioc3RhdGUsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIodGhpcywgc3RhdGUpOwogICAgICByZXR1cm4gd2FpdGVyLndhaXQocGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkQWxsUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gYWRkQWxsUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KSB7CiAgICAgIHZhciBsaXN0ID0gW0FXUy5ldmVudHMsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLCB0aGlzLnNlcnZpY2VJbnRlcmZhY2UoKSwKICAgICAgICAgICAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmVQb3N0XTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGxpc3RbaV0pIHJlcXVlc3QuYWRkTGlzdGVuZXJzKGxpc3RbaV0pOwogICAgICB9CiAgCiAgICAgIC8vIGRpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24KICAgICAgaWYgKCF0aGlzLmNvbmZpZy5wYXJhbVZhbGlkYXRpb24pIHsKICAgICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsCiAgICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5jb25maWcubG9nZ2VyKSB7IC8vIGFkZCBsb2dnaW5nIGV2ZW50cwogICAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKEFXUy5FdmVudExpc3RlbmVycy5Mb2dnZXIpOwogICAgICB9CiAgCiAgICAgIHRoaXMuc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgICAvLyBjYWxsIHByb3RvdHlwZSdzIGN1c3RvbVJlcXVlc3RIYW5kbGVyCiAgICAgIGlmICh0eXBlb2YgdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgICAgfQogICAgICAvLyBjYWxsIGluc3RhbmNlJ3MgY3VzdG9tUmVxdWVzdEhhbmRsZXIKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnY3VzdG9tUmVxdWVzdEhhbmRsZXInKSAmJiB0eXBlb2YgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIocmVxdWVzdCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhIHdob2xlIEFQSSBjYWxsLgogICAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUNhbGxFdmVudDogZnVuY3Rpb24gYXBpQ2FsbEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGwnLAogICAgICAgIEFwaTogYXBpID8gYXBpLm5hbWUgOiByZXF1ZXN0Lm9wZXJhdGlvbiwKICAgICAgICBWZXJzaW9uOiAxLAogICAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgICAgUmVnaW9uOiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgICBNYXhSZXRyaWVzRXhjZWVkZWQ6IDAsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuRmluYWxIdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5lcnJvcikgewogICAgICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgaWYgKHN0YXR1c0NvZGUgPiAyOTkpIHsKICAgICAgICAgIGlmIChlcnJvci5jb2RlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxBd3NFeGNlcHRpb24gPSBlcnJvci5jb2RlOwogICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuRmluYWxTZGtFeGNlcHRpb24gPSBlcnJvci5jb2RlIHx8IGVycm9yLm5hbWU7CiAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFdmVudCByZWNvcmRpbmcgbWV0cmljcyBmb3IgYW4gQVBJIGNhbGwgYXR0ZW1wdC4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGEgc3Vic2V0IG9mIGFwaSBjYWxsIGF0dGVtcHQgbWV0cmljcwogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwaUF0dGVtcHRFdmVudDogZnVuY3Rpb24gYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpIHsKICAgICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgICAgVHlwZTogJ0FwaUNhbGxBdHRlbXB0JywKICAgICAgICBBcGk6IGFwaSA/IGFwaS5uYW1lIDogcmVxdWVzdC5vcGVyYXRpb24sCiAgICAgICAgVmVyc2lvbjogMSwKICAgICAgICBTZXJ2aWNlOiByZXF1ZXN0LnNlcnZpY2UuYXBpLnNlcnZpY2VJZCB8fCByZXF1ZXN0LnNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICAgIEZxZG46IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUsCiAgICAgICAgVXNlckFnZW50OiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmdldFVzZXJBZ2VudCgpLAogICAgICB9OwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuSHR0cFN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgfQogICAgICBpZiAoCiAgICAgICAgIXJlcXVlc3QuX3VuQXV0aGVudGljYXRlZCAmJgogICAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgJiYKICAgICAgICByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkCiAgICAgICkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5BY2Nlc3NLZXkgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgICB9CiAgICAgIGlmICghcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnMpIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICAgIGlmIChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuU2Vzc2lvblRva2VuID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddOwogICAgICB9CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlhBbXpuUmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16UmVxdWVzdElkID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16SWQyID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXTsKICAgICAgfQogICAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQWRkIG1ldHJpY3Mgb2YgZmFpbGVkIHJlcXVlc3QuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0ZW1wdEZhaWxFdmVudDogZnVuY3Rpb24gYXR0ZW1wdEZhaWxFdmVudChyZXF1ZXN0KSB7CiAgICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB0aGlzLmFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KTsKICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA+IDI5OSApIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5Bd3NFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uID0gZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lOwogICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEF0dGFjaCBsaXN0ZW5lcnMgdG8gcmVxdWVzdCBvYmplY3QgdG8gZmV0Y2ggbWV0cmljcyBvZiBlYWNoIHJlcXVlc3QKICAgICAqIGFuZCBlbWl0IGRhdGEgb2JqZWN0IHRocm91Z2ggXCdBcGlDYWxsXCcgYW5kIFwnQXBpQ2FsbEF0dGVtcHRcJyBldmVudHMuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXI6IGZ1bmN0aW9uIGF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpIHsKICAgICAgdmFyIGF0dGVtcHRUaW1lc3RhbXA7IC8vdGltZXN0YW1wIG1hcmtpbmcgdGhlIGJlZ2lubmluZyBvZiBhIHJlcXVlc3QgYXR0ZW1wdAogICAgICB2YXIgYXR0ZW1wdFN0YXJ0UmVhbFRpbWU7IC8vU3RhcnQgdGltZSBvZiByZXF1ZXN0IGF0dGVtcHQuIFVzZWQgdG8gY2FsY3VsYXRpbmcgYXR0ZW1wdExhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRMYXRlbmN5OyAvL2xhdGVuY3kgZnJvbSByZXF1ZXN0IHNlbnQgb3V0IHRvIGh0dHAgcmVzcG9uc2UgcmVhY2hpbmcgU0RLCiAgICAgIHZhciBjYWxsU3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIEFQSSBjYWxsLiBVc2VkIHRvIGNhbGN1bGF0aW5nIEFQSSBjYWxsIGxhdGVuY3kKICAgICAgdmFyIGF0dGVtcHRDb3VudCA9IDA7IC8vcmVxdWVzdC5yZXRyeUNvdW50IGlzIG5vdCByZWxpYWJsZSBoZXJlCiAgICAgIHZhciByZWdpb247IC8vcmVnaW9uIGNhY2hlIHJlZ2lvbiBmb3IgZWFjaCBhdHRlbXB0IHNpbmNlIGl0IGNhbiBiZSB1cGRhdGVkIGluIHBsYXNlIChlLmcuIHMzKQogICAgICB2YXIgY2FsbFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgd2hlbiB0aGUgcmVxdWVzdCBpcyBjcmVhdGVkCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGFkZFRvSGVhZCA9IHRydWU7CiAgCiAgICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlJywgZnVuY3Rpb24gKCkgewogICAgICAgIGNhbGxTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGNhbGxUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCdzaWduJywgZnVuY3Rpb24gKCkgewogICAgICAgIGF0dGVtcHRTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICAgIGF0dGVtcHRUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgICAgIHJlZ2lvbiA9IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uOwogICAgICAgIGF0dGVtcHRDb3VudCsrOwogICAgICB9LCBhZGRUb0hlYWQpOwogICAgICByZXF1ZXN0Lm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgYXR0ZW1wdExhdGVuY3kgPSBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGF0dGVtcHRTdGFydFJlYWxUaW1lKTsKICAgICAgfSk7CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTExfQVRURU1QVCcsICdzdWNjZXNzJywgZnVuY3Rpb24gQVBJX0NBTExfQVRURU1QVCgpIHsKICAgICAgICB2YXIgYXBpQXR0ZW1wdEV2ZW50ID0gc2VsZi5hcGlBdHRlbXB0RXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LkF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgPj0gMCA/IGF0dGVtcHRMYXRlbmN5IDogMDsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICAgIH0pOwogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMX0FUVEVNUFRfUkVUUlknLCAncmV0cnknLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUX1JFVFJZKCkgewogICAgICAgIHZhciBhcGlBdHRlbXB0RXZlbnQgPSBzZWxmLmF0dGVtcHRGYWlsRXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlRpbWVzdGFtcCA9IGF0dGVtcHRUaW1lc3RhbXA7CiAgICAgICAgLy9hdHRlbXB0TGF0ZW5jeSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpZiBmYWlsIGJlZm9yZSByZXNwb25zZQogICAgICAgIGF0dGVtcHRMYXRlbmN5ID0gYXR0ZW1wdExhdGVuY3kgfHwKICAgICAgICAgIE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gYXR0ZW1wdFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5BdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5ID49IDAgPyBhdHRlbXB0TGF0ZW5jeSA6IDA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2FwaUF0dGVtcHRFdmVudF0pOwogICAgICB9KTsKICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTCcsICdjb21wbGV0ZScsIGZ1bmN0aW9uIEFQSV9DQUxMKCkgewogICAgICAgIHZhciBhcGlDYWxsRXZlbnQgPSBzZWxmLmFwaUNhbGxFdmVudChyZXF1ZXN0KTsKICAgICAgICBhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50ID0gYXR0ZW1wdENvdW50OwogICAgICAgIGlmIChhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50IDw9IDApIHJldHVybjsKICAgICAgICBhcGlDYWxsRXZlbnQuVGltZXN0YW1wID0gY2FsbFRpbWVzdGFtcDsKICAgICAgICB2YXIgbGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gY2FsbFN0YXJ0UmVhbFRpbWUpOwogICAgICAgIGFwaUNhbGxFdmVudC5MYXRlbmN5ID0gbGF0ZW5jeSA+PSAwID8gbGF0ZW5jeSA6IDA7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgICBpZiAoCiAgICAgICAgICB0eXBlb2YgcmVzcG9uc2UucmV0cnlDb3VudCA9PT0gJ251bWJlcicgJiYKICAgICAgICAgIHR5cGVvZiByZXNwb25zZS5tYXhSZXRyaWVzID09PSAnbnVtYmVyJyAmJgogICAgICAgICAgKHJlc3BvbnNlLnJldHJ5Q291bnQgPj0gcmVzcG9uc2UubWF4UmV0cmllcykKICAgICAgICApIHsKICAgICAgICAgIGFwaUNhbGxFdmVudC5NYXhSZXRyaWVzRXhjZWVkZWQgPSAxOwogICAgICAgIH0KICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGwnLCBbYXBpQ2FsbEV2ZW50XSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gc2V0dXAgYW55IGN1c3RvbSByZXF1ZXN0IGxpc3RlbmVycyBmb3IgZWFjaAogICAgICogbmV3IHJlcXVlc3QgdG8gdGhlIHNlcnZpY2UuCiAgICAgKgogICAgICogQG1ldGhvZF9hYnN0cmFjdCBUaGlzIGlzIGFuIGFic3RyYWN0IG1ldGhvZC4KICAgICAqLwogICAgc2V0dXBSZXF1ZXN0TGlzdGVuZXJzOiBmdW5jdGlvbiBzZXR1cFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogICAgfSwKICAKICAgIC8qKgogICAgICogR2V0cyB0aGUgc2lnbmVyIGNsYXNzIGZvciBhIGdpdmVuIHJlcXVlc3QKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTaWduZXJDbGFzczogZnVuY3Rpb24gZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCkgewogICAgICB2YXIgdmVyc2lvbjsKICAgICAgLy8gZ2V0IG9wZXJhdGlvbiBhdXRodHlwZSBpZiBwcmVzZW50CiAgICAgIHZhciBvcGVyYXRpb24gPSBudWxsOwogICAgICB2YXIgYXV0aHR5cGUgPSAnJzsKICAgICAgaWYgKHJlcXVlc3QpIHsKICAgICAgICB2YXIgb3BlcmF0aW9ucyA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgICBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSB8fCBudWxsOwogICAgICAgIGF1dGh0eXBlID0gb3BlcmF0aW9uID8gb3BlcmF0aW9uLmF1dGh0eXBlIDogJyc7CiAgICAgIH0KICAgICAgaWYgKHRoaXMuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHsKICAgICAgICB2ZXJzaW9uID0gdGhpcy5jb25maWcuc2lnbmF0dXJlVmVyc2lvbjsKICAgICAgfSBlbHNlIGlmIChhdXRodHlwZSA9PT0gJ3Y0JyB8fCBhdXRodHlwZSA9PT0gJ3Y0LXVuc2lnbmVkLWJvZHknKSB7CiAgICAgICAgdmVyc2lvbiA9ICd2NCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmVyc2lvbiA9IHRoaXMuYXBpLnNpZ25hdHVyZVZlcnNpb247CiAgICAgIH0KICAgICAgcmV0dXJuIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbih2ZXJzaW9uKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXJ2aWNlSW50ZXJmYWNlOiBmdW5jdGlvbiBzZXJ2aWNlSW50ZXJmYWNlKCkgewogICAgICBzd2l0Y2ggKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgICAgY2FzZSAnZWMyJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgICBjYXNlICdxdWVyeSc6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUXVlcnk7CiAgICAgICAgY2FzZSAnanNvbic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuSnNvbjsKICAgICAgICBjYXNlICdyZXN0LWpzb24nOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RKc29uOwogICAgICAgIGNhc2UgJ3Jlc3QteG1sJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5SZXN0WG1sOwogICAgICB9CiAgICAgIGlmICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzZXJ2aWNlIGBwcm90b2NvbFwnICcgKwogICAgICAgICAgdGhpcy5hcGkucHJvdG9jb2wgKyAnIGluIEFQSSBjb25maWcnKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHN1Y2Nlc3NmdWxSZXNwb25zZTogZnVuY3Rpb24gc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApIHsKICAgICAgcmV0dXJuIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDA7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBIb3cgbWFueSB0aW1lcyBhIGZhaWxlZCByZXF1ZXN0IHNob3VsZCBiZSByZXRyaWVkIGJlZm9yZSBnaXZpbmcgdXAuCiAgICAgKiB0aGUgZGVmYXVsdFJldHJ5Q291bnQgY2FuIGJlIG92ZXJyaWRlbiBieSBzZXJ2aWNlIGNsYXNzZXMuCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG51bVJldHJpZXM6IGZ1bmN0aW9uIG51bVJldHJpZXMoKSB7CiAgICAgIGlmICh0aGlzLmNvbmZpZy5tYXhSZXRyaWVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25maWcubWF4UmV0cmllczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWZhdWx0UmV0cnlDb3VudDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJldHJ5RGVsYXlzOiBmdW5jdGlvbiByZXRyeURlbGF5cyhyZXRyeUNvdW50KSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHRoaXMuY29uZmlnLnJldHJ5RGVsYXlPcHRpb25zKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICByZXRyeWFibGVFcnJvcjogZnVuY3Rpb24gcmV0cnlhYmxlRXJyb3IoZXJyb3IpIHsKICAgICAgaWYgKHRoaXMudGltZW91dEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICAgIGlmICh0aGlzLm5ldHdvcmtpbmdFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5leHBpcmVkQ3JlZGVudGlhbHNFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy50aHJvdHRsZWRFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA+PSA1MDApIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbmV0d29ya2luZ0Vycm9yOiBmdW5jdGlvbiBuZXR3b3JraW5nRXJyb3IoZXJyb3IpIHsKICAgICAgcmV0dXJuIGVycm9yLmNvZGUgPT09ICdOZXR3b3JraW5nRXJyb3InOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHRpbWVvdXRFcnJvcjogZnVuY3Rpb24gdGltZW91dEVycm9yKGVycm9yKSB7CiAgICAgIHJldHVybiBlcnJvci5jb2RlID09PSAnVGltZW91dEVycm9yJzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBleHBpcmVkQ3JlZGVudGlhbHNFcnJvcjogZnVuY3Rpb24gZXhwaXJlZENyZWRlbnRpYWxzRXJyb3IoZXJyb3IpIHsKICAgICAgLy8gVE9ETyA6IHRoaXMgb25seSBoYW5kbGVzICpvbmUqIG9mIHRoZSBleHBpcmVkIGNyZWRlbnRpYWwgY29kZXMKICAgICAgcmV0dXJuIChlcnJvci5jb2RlID09PSAnRXhwaXJlZFRva2VuRXhjZXB0aW9uJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2xvY2tTa2V3RXJyb3I6IGZ1bmN0aW9uIGNsb2NrU2tld0Vycm9yKGVycm9yKSB7CiAgICAgIHN3aXRjaCAoZXJyb3IuY29kZSkgewogICAgICAgIGNhc2UgJ1JlcXVlc3RUaW1lVG9vU2tld2VkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6CiAgICAgICAgY2FzZSAnSW52YWxpZFNpZ25hdHVyZUV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnU2lnbmF0dXJlRG9lc05vdE1hdGNoJzoKICAgICAgICBjYXNlICdBdXRoRmFpbHVyZSc6CiAgICAgICAgY2FzZSAnUmVxdWVzdEluVGhlRnV0dXJlJzoKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFNrZXdDb3JyZWN0ZWREYXRlOiBmdW5jdGlvbiBnZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIHsKICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgICAgdGhpcy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBuZXdTZXJ2ZXJUaW1lIC0gRGF0ZS5ub3coKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQobmV3U2VydmVyVGltZSkgewogICAgICBpZiAobmV3U2VydmVyVGltZSkgewogICAgICAgIHJldHVybiBNYXRoLmFicyh0aGlzLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkuZ2V0VGltZSgpIC0gbmV3U2VydmVyVGltZSkgPj0gMzAwMDA7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0aHJvdHRsZWRFcnJvcjogZnVuY3Rpb24gdGhyb3R0bGVkRXJyb3IoZXJyb3IpIHsKICAgICAgLy8gdGhpcyBsb2dpYyB2YXJpZXMgYmV0d2VlbiBzZXJ2aWNlcwogICAgICBpZiAoZXJyb3Iuc3RhdHVzQ29kZSA9PT0gNDI5KSByZXR1cm4gdHJ1ZTsKICAgICAgc3dpdGNoIChlcnJvci5jb2RlKSB7CiAgICAgICAgY2FzZSAnUHJvdmlzaW9uZWRUaHJvdWdocHV0RXhjZWVkZWRFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1Rocm90dGxpbmcnOgogICAgICAgIGNhc2UgJ1Rocm90dGxpbmdFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1JlcXVlc3RMaW1pdEV4Y2VlZGVkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkJzoKICAgICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdUb29NYW55UmVxdWVzdHNFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1RyYW5zYWN0aW9uSW5Qcm9ncmVzc0V4Y2VwdGlvbic6IC8vZHluYW1vZGIKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBlbmRwb2ludEZyb21UZW1wbGF0ZTogZnVuY3Rpb24gZW5kcG9pbnRGcm9tVGVtcGxhdGUoZW5kcG9pbnQpIHsKICAgICAgaWYgKHR5cGVvZiBlbmRwb2ludCAhPT0gJ3N0cmluZycpIHJldHVybiBlbmRwb2ludDsKICAKICAgICAgdmFyIGUgPSBlbmRwb2ludDsKICAgICAgZSA9IGUucmVwbGFjZSgvXHtzZXJ2aWNlXH0vZywgdGhpcy5hcGkuZW5kcG9pbnRQcmVmaXgpOwogICAgICBlID0gZS5yZXBsYWNlKC9ce3JlZ2lvblx9L2csIHRoaXMuY29uZmlnLnJlZ2lvbik7CiAgICAgIGUgPSBlLnJlcGxhY2UoL1x7c2NoZW1lXH0vZywgdGhpcy5jb25maWcuc3NsRW5hYmxlZCA/ICdodHRwcycgOiAnaHR0cCcpOwogICAgICByZXR1cm4gZTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXRFbmRwb2ludDogZnVuY3Rpb24gc2V0RW5kcG9pbnQoZW5kcG9pbnQpIHsKICAgICAgdGhpcy5lbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQsIHRoaXMuY29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwYWdpbmF0aW9uQ29uZmlnOiBmdW5jdGlvbiBwYWdpbmF0aW9uQ29uZmlnKG9wZXJhdGlvbiwgdGhyb3dFeGNlcHRpb24pIHsKICAgICAgdmFyIHBhZ2luYXRvciA9IHRoaXMuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXS5wYWdpbmF0b3I7CiAgICAgIGlmICghcGFnaW5hdG9yKSB7CiAgICAgICAgaWYgKHRocm93RXhjZXB0aW9uKSB7CiAgICAgICAgICB2YXIgZSA9IG5ldyBFcnJvcigpOwogICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IoZSwgJ05vIHBhZ2luYXRpb24gY29uZmlndXJhdGlvbiBmb3IgJyArIG9wZXJhdGlvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgCiAgICAgIHJldHVybiBwYWdpbmF0b3I7CiAgICB9CiAgfSk7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5TZXJ2aWNlLCB7CiAgCiAgICAvKioKICAgICAqIEFkZHMgb25lIG1ldGhvZCBmb3IgZWFjaCBvcGVyYXRpb24gZGVzY3JpYmVkIGluIHRoZSBhcGkgY29uZmlndXJhdGlvbgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZpbmVNZXRob2RzOiBmdW5jdGlvbiBkZWZpbmVNZXRob2RzKHN2YykgewogICAgICBBV1MudXRpbC5lYWNoKHN2Yy5wcm90b3R5cGUuYXBpLm9wZXJhdGlvbnMsIGZ1bmN0aW9uIGl0ZXJhdG9yKG1ldGhvZCkgewogICAgICAgIGlmIChzdmMucHJvdG90eXBlW21ldGhvZF0pIHJldHVybjsKICAgICAgICB2YXIgb3BlcmF0aW9uID0gc3ZjLnByb3RvdHlwZS5hcGkub3BlcmF0aW9uc1ttZXRob2RdOwogICAgICAgIGlmIChvcGVyYXRpb24uYXV0aHR5cGUgPT09ICdub25lJykgewogICAgICAgICAgc3ZjLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1ha2VSZXF1ZXN0KG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBEZWZpbmVzIGEgbmV3IFNlcnZpY2UgY2xhc3MgdXNpbmcgYSBzZXJ2aWNlIGlkZW50aWZpZXIgYW5kIGxpc3Qgb2YgdmVyc2lvbnMKICAgICAqIGluY2x1ZGluZyBhbiBvcHRpb25hbCBzZXQgb2YgZmVhdHVyZXMgKGZ1bmN0aW9ucykgdG8gYXBwbHkgdG8gdGhlIGNsYXNzCiAgICAgKiBwcm90b3R5cGUuCiAgICAgKgogICAgICogQHBhcmFtIHNlcnZpY2VJZGVudGlmaWVyIFtTdHJpbmddIHRoZSBpZGVudGlmaWVyIGZvciB0aGUgc2VydmljZQogICAgICogQHBhcmFtIHZlcnNpb25zIFtBcnJheTxTdHJpbmc+XSBhIGxpc3Qgb2YgdmVyc2lvbnMgdGhhdCB3b3JrIHdpdGggdGhpcwogICAgICogICBzZXJ2aWNlCiAgICAgKiBAcGFyYW0gZmVhdHVyZXMgW09iamVjdF0gYW4gb2JqZWN0IHRvIGF0dGFjaCB0byB0aGUgcHJvdG90eXBlCiAgICAgKiBAcmV0dXJuIFtDbGFzczxTZXJ2aWNlPl0gdGhlIHNlcnZpY2UgY2xhc3MgZGVmaW5lZCBieSB0aGlzIGZ1bmN0aW9uLgogICAgICovCiAgICBkZWZpbmVTZXJ2aWNlOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlKHNlcnZpY2VJZGVudGlmaWVyLCB2ZXJzaW9ucywgZmVhdHVyZXMpIHsKICAgICAgQVdTLlNlcnZpY2UuX3NlcnZpY2VNYXBbc2VydmljZUlkZW50aWZpZXJdID0gdHJ1ZTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZlcnNpb25zKSkgewogICAgICAgIGZlYXR1cmVzID0gdmVyc2lvbnM7CiAgICAgICAgdmVyc2lvbnMgPSBbXTsKICAgICAgfQogIAogICAgICB2YXIgc3ZjID0gaW5oZXJpdChBV1MuU2VydmljZSwgZmVhdHVyZXMgfHwge30pOwogIAogICAgICBpZiAodHlwZW9mIHNlcnZpY2VJZGVudGlmaWVyID09PSAnc3RyaW5nJykgewogICAgICAgIEFXUy5TZXJ2aWNlLmFkZFZlcnNpb25zKHN2YywgdmVyc2lvbnMpOwogIAogICAgICAgIHZhciBpZGVudGlmaWVyID0gc3ZjLnNlcnZpY2VJZGVudGlmaWVyIHx8IHNlcnZpY2VJZGVudGlmaWVyOwogICAgICAgIHN2Yy5zZXJ2aWNlSWRlbnRpZmllciA9IGlkZW50aWZpZXI7CiAgICAgIH0gZWxzZSB7IC8vIGRlZmluZVNlcnZpY2UgY2FsbGVkIHdpdGggYW4gQVBJCiAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBzZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgICBBV1MuU2VydmljZS5kZWZpbmVNZXRob2RzKHN2Yyk7CiAgICAgIH0KICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHRoaXMucHJvdG90eXBlKTsKICAgICAgLy91dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nIGlzIG9ubHkgYXZhaWxhYmxlIGluIG5vZGUKICAgICAgaWYgKCF0aGlzLnByb3RvdHlwZS5wdWJsaXNoZXIgJiYgQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcpIHsKICAgICAgICB2YXIgUHVibGlzaGVyID0gQVdTLnV0aWwuY2xpZW50U2lkZU1vbml0b3JpbmcuUHVibGlzaGVyOwogICAgICAgIHZhciBjb25maWdQcm92aWRlciA9IEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nLmNvbmZpZ1Byb3ZpZGVyOwogICAgICAgIHZhciBwdWJsaXNoZXJDb25maWcgPSBjb25maWdQcm92aWRlcigpOwogICAgICAgIHRoaXMucHJvdG90eXBlLnB1Ymxpc2hlciA9IG5ldyBQdWJsaXNoZXIocHVibGlzaGVyQ29uZmlnKTsKICAgICAgICBpZiAocHVibGlzaGVyQ29uZmlnLmVuYWJsZWQpIHsKICAgICAgICAgIC8vaWYgY3NtIGlzIGVuYWJsZWQgaW4gZW52aXJvbm1lbnQsIFNESyBzaG91bGQgc2VuZCBhbGwgbWV0cmljcwogICAgICAgICAgQVdTLlNlcnZpY2UuX2NsaWVudFNpZGVNb25pdG9yaW5nID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5jYWxsKHN2Yy5wcm90b3R5cGUpOwogICAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyhzdmMucHJvdG90eXBlKTsKICAgICAgcmV0dXJuIHN2YzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGRWZXJzaW9uczogZnVuY3Rpb24gYWRkVmVyc2lvbnMoc3ZjLCB2ZXJzaW9ucykgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmVyc2lvbnMpKSB2ZXJzaW9ucyA9IFt2ZXJzaW9uc107CiAgCiAgICAgIHN2Yy5zZXJ2aWNlcyA9IHN2Yy5zZXJ2aWNlcyB8fCB7fTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2ZXJzaW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChzdmMuc2VydmljZXNbdmVyc2lvbnNbaV1dID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHN2Yy5zZXJ2aWNlc1t2ZXJzaW9uc1tpXV0gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBzdmMuYXBpVmVyc2lvbnMgPSBPYmplY3Qua2V5cyhzdmMuc2VydmljZXMpLnNvcnQoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZpbmVTZXJ2aWNlQXBpOiBmdW5jdGlvbiBkZWZpbmVTZXJ2aWNlQXBpKHN1cGVyY2xhc3MsIHZlcnNpb24sIGFwaUNvbmZpZykgewogICAgICB2YXIgc3ZjID0gaW5oZXJpdChzdXBlcmNsYXNzLCB7CiAgICAgICAgc2VydmljZUlkZW50aWZpZXI6IHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIKICAgICAgfSk7CiAgCiAgICAgIGZ1bmN0aW9uIHNldEFwaShhcGkpIHsKICAgICAgICBpZiAoYXBpLmlzQXBpKSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IGFwaTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBuZXcgQXBpKGFwaSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAoYXBpQ29uZmlnKSB7CiAgICAgICAgICBzZXRBcGkoYXBpQ29uZmlnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0QXBpKEFXUy5hcGlMb2FkZXIoc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllciwgdmVyc2lvbikpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKGVyciwgewogICAgICAgICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgZmluZCBBUEkgY29uZmlndXJhdGlvbiAnICsKICAgICAgICAgICAgICAgIHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIgKyAnLScgKyB2ZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdXBlcmNsYXNzLnNlcnZpY2VzLCB2ZXJzaW9uKSkgewogICAgICAgICAgc3VwZXJjbGFzcy5hcGlWZXJzaW9ucyA9IHN1cGVyY2xhc3MuYXBpVmVyc2lvbnMuY29uY2F0KHZlcnNpb24pLnNvcnQoKTsKICAgICAgICB9CiAgICAgICAgc3VwZXJjbGFzcy5zZXJ2aWNlc1t2ZXJzaW9uXSA9IHN2YzsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRBcGkodmVyc2lvbik7CiAgICAgIH0KICAKICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lTWV0aG9kcyhzdmMpOwogICAgICByZXR1cm4gc3ZjOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhhc1NlcnZpY2U6IGZ1bmN0aW9uKGlkZW50aWZpZXIpIHsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MuU2VydmljZS5fc2VydmljZU1hcCwgaWRlbnRpZmllcik7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAcGFyYW0gYXR0YWNoT24gYXR0YWNoIGRlZmF1bHQgbW9uaXRvcmluZyBsaXN0ZW5lcnMgdG8gb2JqZWN0CiAgICAgKgogICAgICogRWFjaCBtb25pdG9yaW5nIGV2ZW50IHNob3VsZCBiZSBlbWl0dGVkIGZyb20gc2VydmljZSBjbGllbnQgdG8gc2VydmljZSBjb25zdHJ1Y3RvciBwcm90b3R5cGUgYW5kIHRoZW4KICAgICAqIHRvIGdsb2JhbCBzZXJ2aWNlIHByb3RvdHlwZSBsaWtlIGJ1YmJsaW5nIHVwLiBUaGVzZSBkZWZhdWx0IG1vbml0b3JpbmcgZXZlbnRzIGxpc3RlbmVyIHdpbGwgdHJhbnNmZXIKICAgICAqIHRoZSBtb25pdG9yaW5nIGV2ZW50cyB0byB0aGUgdXBwZXIgbGF5ZXIuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKGF0dGFjaE9uKSB7CiAgICAgIGF0dGFjaE9uLmFkZE5hbWVkTGlzdGVuZXIoJ01PTklUT1JfRVZFTlRTX0JVQkJMRScsICdhcGlDYWxsQXR0ZW1wdCcsIGZ1bmN0aW9uIEVWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFtldmVudF0pOwogICAgICB9KTsKICAgICAgYXR0YWNoT24uYWRkTmFtZWRMaXN0ZW5lcignQ0FMTF9FVkVOVFNfQlVCQkxFJywgJ2FwaUNhbGwnLCBmdW5jdGlvbiBDQUxMX0VWRU5UU19CVUJCTEUoZXZlbnQpIHsKICAgICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsJywgW2V2ZW50XSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIF9zZXJ2aWNlTWFwOiB7fQogIH0pOwogIAogIEFXUy51dGlsLm1peGluKEFXUy5TZXJ2aWNlLCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXJ2aWNlOwogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9jb3JlIjoxOCwiLi9tb2RlbC9hcGkiOjM4LCIuL3JlZ2lvbl9jb25maWciOjUzLCJfcHJvY2VzcyI6ODZ9XSw2MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICBBV1MudXRpbC51cGRhdGUoQVdTLkNvZ25pdG9JZGVudGl0eS5wcm90b3R5cGUsIHsKICAgIGdldE9wZW5JZFRva2VuOiBmdW5jdGlvbiBnZXRPcGVuSWRUb2tlbihwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRPcGVuSWRUb2tlbicsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGdldElkOiBmdW5jdGlvbiBnZXRJZChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdnZXRJZCcsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHk6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eScsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfQogIH0pOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDYxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuLi9yZWdpb25fY29uZmlnJyk7CiAgdmFyIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEID0gJ0FXU19TVFNfUkVHSU9OQUxfRU5EUE9JTlRTJzsKICB2YXIgQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgPSAnc3RzX3JlZ2lvbmFsX2VuZHBvaW50cyc7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5TVFMucHJvdG90eXBlLCB7CiAgICAvKioKICAgICAqIEBvdmVybG9hZCBjcmVkZW50aWFsc0Zyb20oZGF0YSwgY3JlZGVudGlhbHMgPSBudWxsKQogICAgICogICBDcmVhdGVzIGEgY3JlZGVudGlhbHMgb2JqZWN0IGZyb20gU1RTIHJlc3BvbnNlIGRhdGEgY29udGFpbmluZwogICAgICogICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbi4gVXNlZnVsIGZvciBxdWlja2x5IHNldHRpbmcgQVdTIGNyZWRlbnRpYWxzLgogICAgICoKICAgICAqICAgQG5vdGUgVGhpcyBpcyBhIGxvdy1sZXZlbCB1dGlsaXR5IGZ1bmN0aW9uLiBJZiB5b3Ugd2FudCB0byBsb2FkIHRlbXBvcmFyeQogICAgICogICAgIGNyZWRlbnRpYWxzIGludG8geW91ciBwcm9jZXNzIGZvciBzdWJzZXF1ZW50IHJlcXVlc3RzIHRvIEFXUyByZXNvdXJjZXMsCiAgICAgKiAgICAgeW91IHNob3VsZCB1c2Uge0FXUy5UZW1wb3JhcnlDcmVkZW50aWFsc30gaW5zdGVhZC4KICAgICAqICAgQHBhcmFtIGRhdGEgW21hcF0gZGF0YSByZXRyaWV2ZWQgZnJvbSBhIGNhbGwgdG8ge2dldEZlZGVyYXRlZFRva2VufSwKICAgICAqICAgICB7Z2V0U2Vzc2lvblRva2VufSwge2Fzc3VtZVJvbGV9LCBvciB7YXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uCiAgICAgKiAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSBhbiBvcHRpb25hbCBjcmVkZW50aWFscyBvYmplY3QgdG8KICAgICAqICAgICBmaWxsIGluc3RlYWQgb2YgY3JlYXRpbmcgYSBuZXcgb2JqZWN0LiBVc2VmdWwgd2hlbiBtb2RpZnlpbmcgYW4KICAgICAqICAgICBleGlzdGluZyBjcmVkZW50aWFscyBvYmplY3QgZnJvbSBhIHJlZnJlc2ggY2FsbC4KICAgICAqICAgQHJldHVybiBbQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzXSB0aGUgc2V0IG9mIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAgICogICAgIGxvYWRlZCBmcm9tIGEgcmF3IFNUUyBvcGVyYXRpb24gcmVzcG9uc2UuCiAgICAgKiAgIEBleGFtcGxlIFVzaW5nIGNyZWRlbnRpYWxzRnJvbSB0byBsb2FkIGdsb2JhbCBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgICB2YXIgc3RzID0gbmV3IEFXUy5TVFMoKTsKICAgICAqICAgICBzdHMuZ2V0U2Vzc2lvblRva2VuKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAqICAgICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKCJFcnJvciBnZXR0aW5nIGNyZWRlbnRpYWxzIik7CiAgICAgKiAgICAgICBlbHNlIHsKICAgICAqICAgICAgICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IHN0cy5jcmVkZW50aWFsc0Zyb20oZGF0YSk7CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfSk7CiAgICAgKiAgIEBzZWUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzCiAgICAgKi8KICAgIGNyZWRlbnRpYWxzRnJvbTogZnVuY3Rpb24gY3JlZGVudGlhbHNGcm9tKGRhdGEsIGNyZWRlbnRpYWxzKSB7CiAgICAgIGlmICghZGF0YSkgcmV0dXJuIG51bGw7CiAgICAgIGlmICghY3JlZGVudGlhbHMpIGNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgICBjcmVkZW50aWFscy5leHBpcmVkID0gZmFsc2U7CiAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkID0gZGF0YS5DcmVkZW50aWFscy5BY2Nlc3NLZXlJZDsKICAgICAgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ID0gZGF0YS5DcmVkZW50aWFscy5TZWNyZXRBY2Nlc3NLZXk7CiAgICAgIGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbiA9IGRhdGEuQ3JlZGVudGlhbHMuU2Vzc2lvblRva2VuOwogICAgICBjcmVkZW50aWFscy5leHBpcmVUaW1lID0gZGF0YS5DcmVkZW50aWFscy5FeHBpcmF0aW9uOwogICAgICByZXR1cm4gY3JlZGVudGlhbHM7CiAgICB9LAogIAogICAgYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eTogZnVuY3Rpb24gYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eShwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5JywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgYXNzdW1lUm9sZVdpdGhTQU1MOiBmdW5jdGlvbiBhc3N1bWVSb2xlV2l0aFNBTUwocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnYXNzdW1lUm9sZVdpdGhTQU1MJywgcGFyYW1zLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZTogZnVuY3Rpb24gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShjb25maWdWYWx1ZSwgZXJyb3JPcHRpb25zKSB7CiAgICAgIGlmICh0eXBlb2YgY29uZmlnVmFsdWUgPT09ICdzdHJpbmcnICYmIFsnbGVnYWN5JywgJ3JlZ2lvbmFsJ10uaW5kZXhPZihjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpKSA+PSAwKSB7CiAgICAgICAgdGhpcy5jb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgPSBjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgZXJyb3JPcHRpb25zKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnOiBmdW5jdGlvbiB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZygpIHsKICAgICAgLy92YWxpZGF0ZSBjb25maWcgdmFsdWUKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnOwogICAgICBpZiAoY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICJzdHNSZWdpb25hbEVuZHBvaW50cyIgY29uZmlndXJhdGlvbi4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFBV1MudXRpbC5pc05vZGUoKSkgcmV0dXJuOwogICAgICAvL3ZhbGlkYXRlIGVudmlyb25tZW50YWwgdmFyaWFibGUKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQpKSB7CiAgICAgICAgdmFyIGVudkZsYWcgPSBwcm9jZXNzLmVudltFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF07CiAgICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZ1ZhbHVlKGVudkZsYWcsIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkRW52aXJvbm1lbnRhbFZhcmlhYmxlJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcgKyBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCArICcgZW52aXJvbm1lbnRhbCB2YXJpYWJsZS4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9jZXNzLmVudltFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF0gKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgLy92YWxpZGF0ZSBzaGFyZWQgY29uZmlnIGZpbGUKICAgICAgdmFyIHByb2ZpbGUgPSB7fTsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcHJvZmlsZXMgPSBBV1MudXRpbC5nZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWcoQVdTLnV0aWwuaW5pTG9hZGVyKTsKICAgICAgICBwcm9maWxlID0gcHJvZmlsZXNbcHJvY2Vzcy5lbnYuQVdTX1BST0ZJTEUgfHwgQVdTLnV0aWwuZGVmYXVsdFByb2ZpbGVdOwogICAgICB9IGNhdGNoIChlKSB7fTsKICAgICAgaWYgKHByb2ZpbGUgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2ZpbGUsIENPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEKSkgewogICAgICAgIHZhciBmaWxlRmxhZyA9IHByb2ZpbGVbQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdOwogICAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShmaWxlRmxhZywgewogICAgICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdpbnZhbGlkICcrQ09ORklHX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQrJyBwcm9maWxlIGNvbmZpZy4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBwcm9maWxlW0NPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXSArICciLicKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG9wdEluUmVnaW9uYWxFbmRwb2ludDogZnVuY3Rpb24gb3B0SW5SZWdpb25hbEVuZHBvaW50KCkgewogICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnKCk7CiAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZzsKICAgICAgaWYgKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyA9PT0gJ3JlZ2lvbmFsJykgewogICAgICAgIHJlZ2lvbkNvbmZpZyh0aGlzKTsKICAgICAgICBpZiAoIXRoaXMuaXNHbG9iYWxFbmRwb2ludCkgcmV0dXJuOwogICAgICAgIHRoaXMuaXNHbG9iYWxFbmRwb2ludCA9IGZhbHNlOwogICAgICAgIC8vY2xpZW50IHdpbGwgdGhyb3cgaWYgcmVnaW9uIGlzIG5vdCBzdXBwbGllZDsgcmVxdWVzdCB3aWxsIGJlIHNpZ25lZCB3aXRoIHNwZWNpZmllZCByZWdpb24KICAgICAgICBpZiAoIWNvbmZpZy5yZWdpb24pIHsKICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgICB9CiAgICAgICAgdmFyIGluc2VydFBvaW50ID0gY29uZmlnLmVuZHBvaW50LmluZGV4T2YoJy5hbWF6b25hd3MuY29tJyk7CiAgICAgICAgY29uZmlnLmVuZHBvaW50ID0gY29uZmlnLmVuZHBvaW50LnN1YnN0cmluZygwLCBpbnNlcnRQb2ludCkgKwogICAgICAgICAgJy4nICsgY29uZmlnLnJlZ2lvbiArIGNvbmZpZy5lbmRwb2ludC5zdWJzdHJpbmcoaW5zZXJ0UG9pbnQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVTZXJ2aWNlOiBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZpY2UoKSB7CiAgICAgIHRoaXMub3B0SW5SZWdpb25hbEVuZHBvaW50KCk7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQogIH0seyIuLi9jb3JlIjoxOCwiLi4vcmVnaW9uX2NvbmZpZyI6NTMsIl9wcm9jZXNzIjo4Nn1dLDYyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gc2lnbmVkVXJsQnVpbGRlcihyZXF1ZXN0KSB7CiAgICB2YXIgZXhwaXJlcyA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXTsKICAgIHZhciBzaWduZXJDbGFzcyA9IHJlcXVlc3Quc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXF1ZXN0KTsKICAKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1VzZXItQWdlbnQnXTsKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LVVzZXItQWdlbnQnXTsKICAKICAgIGlmIChzaWduZXJDbGFzcyA9PT0gQVdTLlNpZ25lcnMuVjQpIHsKICAgICAgaWYgKGV4cGlyZXMgPiA2MDQ4MDApIHsgLy8gb25lIHdlZWsgZXhwaXJ5IGlzIGludmFsaWQKICAgICAgICB2YXIgbWVzc2FnZSA9ICdQcmVzaWduaW5nIGRvZXMgbm90IHN1cHBvcnQgZXhwaXJ5IHRpbWUgZ3JlYXRlciAnICsKICAgICAgICAgICAgICAgICAgICAgICd0aGFuIGEgd2VlayB3aXRoIFNpZ1Y0IHNpZ25pbmcuJzsKICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0ludmFsaWRFeHBpcnlUaW1lJywgbWVzc2FnZTogbWVzc2FnZSwgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IGV4cGlyZXM7CiAgICB9IGVsc2UgaWYgKHNpZ25lckNsYXNzID09PSBBV1MuU2lnbmVycy5TMykgewogICAgICB2YXIgbm93ID0gcmVxdWVzdC5zZXJ2aWNlID8gcmVxdWVzdC5zZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCkgOiBBV1MudXRpbC5kYXRlLmdldERhdGUoKTsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gcGFyc2VJbnQoCiAgICAgICAgQVdTLnV0aWwuZGF0ZS51bml4VGltZXN0YW1wKG5vdykgKyBleHBpcmVzLCAxMCkudG9TdHJpbmcoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgbWVzc2FnZTogJ1ByZXNpZ25pbmcgb25seSBzdXBwb3J0cyBTMyBvciBTaWdWNCBzaWduaW5nLicsCiAgICAgICAgY29kZTogJ1Vuc3VwcG9ydGVkU2lnbmVyJywgcmV0cnlhYmxlOiBmYWxzZQogICAgICB9KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gc2lnbmVkVXJsU2lnbmVyKHJlcXVlc3QpIHsKICAgIHZhciBlbmRwb2ludCA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQ7CiAgICB2YXIgcGFyc2VkVXJsID0gQVdTLnV0aWwudXJsUGFyc2UocmVxdWVzdC5odHRwUmVxdWVzdC5wYXRoKTsKICAgIHZhciBxdWVyeVBhcmFtcyA9IHt9OwogIAogICAgaWYgKHBhcnNlZFVybC5zZWFyY2gpIHsKICAgICAgcXVlcnlQYXJhbXMgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHBhcnNlZFVybC5zZWFyY2guc3Vic3RyKDEpKTsKICAgIH0KICAKICAgIHZhciBhdXRoID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10uc3BsaXQoJyAnKTsKICAgIGlmIChhdXRoWzBdID09PSAnQVdTJykgewogICAgICBhdXRoID0gYXV0aFsxXS5zcGxpdCgnOicpOwogICAgICBxdWVyeVBhcmFtc1snQVdTQWNjZXNzS2V5SWQnXSA9IGF1dGhbMF07CiAgICAgIHF1ZXJ5UGFyYW1zWydTaWduYXR1cmUnXSA9IGF1dGhbMV07CiAgCiAgICAgIEFXUy51dGlsLmVhY2gocmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIGtleSA9ICdFeHBpcmVzJzsKICAgICAgICBpZiAoa2V5LmluZGV4T2YoJ3gtYW16LW1ldGEtJykgPT09IDApIHsKICAgICAgICAgIC8vIERlbGV0ZSBleGlzdGluZywgcG90ZW50aWFsbHkgbm90IG5vcm1hbGl6ZWQga2V5CiAgICAgICAgICBkZWxldGUgcXVlcnlQYXJhbXNba2V5XTsKICAgICAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgIH0KICAgICAgICBxdWVyeVBhcmFtc1trZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0F1dGhvcml6YXRpb24nXTsKICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydIb3N0J107CiAgICB9IGVsc2UgaWYgKGF1dGhbMF0gPT09ICdBV1M0LUhNQUMtU0hBMjU2JykgeyAvLyBTaWdWNCBzaWduaW5nCiAgICAgIGF1dGguc2hpZnQoKTsKICAgICAgdmFyIHJlc3QgPSBhdXRoLmpvaW4oJyAnKTsKICAgICAgdmFyIHNpZ25hdHVyZSA9IHJlc3QubWF0Y2goL1NpZ25hdHVyZT0oLio/KSg/Oix8XHN8XHI/XG58JCkvKVsxXTsKICAgICAgcXVlcnlQYXJhbXNbJ1gtQW16LVNpZ25hdHVyZSddID0gc2lnbmF0dXJlOwogICAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0V4cGlyZXMnXTsKICAgIH0KICAKICAgIC8vIGJ1aWxkIFVSTAogICAgZW5kcG9pbnQucGF0aG5hbWUgPSBwYXJzZWRVcmwucGF0aG5hbWU7CiAgICBlbmRwb2ludC5zZWFyY2ggPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5UGFyYW1zKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUHJlc2lnbiA9IGluaGVyaXQoewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2lnbjogZnVuY3Rpb24gc2lnbihyZXF1ZXN0LCBleHBpcmVUaW1lLCBjYWxsYmFjaykgewogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBleHBpcmVUaW1lIHx8IDM2MDA7CiAgICAgIHJlcXVlc3Qub24oJ2J1aWxkJywgc2lnbmVkVXJsQnVpbGRlcik7CiAgICAgIHJlcXVlc3Qub24oJ3NpZ24nLCBzaWduZWRVcmxTaWduZXIpOwogICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRVRfQ09OVEVOVF9MRU5HVEgpOwogICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5DT01QVVRFX1NIQTI1Nik7CiAgCiAgICAgIHJlcXVlc3QuZW1pdCgnYmVmb3JlUHJlc2lnbicsIFtyZXF1ZXN0XSk7CiAgCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHJlcXVlc3QuYnVpbGQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5yZXNwb25zZS5lcnJvcikgY2FsbGJhY2sodGhpcy5yZXNwb25zZS5lcnJvcik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgQVdTLnV0aWwudXJsRm9ybWF0KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXF1ZXN0LmJ1aWxkKCk7CiAgICAgICAgaWYgKHJlcXVlc3QucmVzcG9uc2UuZXJyb3IpIHRocm93IHJlcXVlc3QucmVzcG9uc2UuZXJyb3I7CiAgICAgICAgcmV0dXJuIEFXUy51dGlsLnVybEZvcm1hdChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50KTsKICAgICAgfQogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuUHJlc2lnbjsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICAKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciA9IGluaGVyaXQoewogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlcXVlc3RTaWduZXIocmVxdWVzdCkgewogICAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgfSwKICAKICAgIHNldFNlcnZpY2VDbGllbnRJZDogZnVuY3Rpb24gc2V0U2VydmljZUNsaWVudElkKGlkKSB7CiAgICAgIHRoaXMuc2VydmljZUNsaWVudElkID0gaWQ7CiAgICB9LAogIAogICAgZ2V0U2VydmljZUNsaWVudElkOiBmdW5jdGlvbiBnZXRTZXJ2aWNlQ2xpZW50SWQoKSB7CiAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VDbGllbnRJZDsKICAgIH0KICB9KTsKICAKICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmdldFZlcnNpb24gPSBmdW5jdGlvbiBnZXRWZXJzaW9uKHZlcnNpb24pIHsKICAgIHN3aXRjaCAodmVyc2lvbikgewogICAgICBjYXNlICd2Mic6IHJldHVybiBBV1MuU2lnbmVycy5WMjsKICAgICAgY2FzZSAndjMnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjM7CiAgICAgIGNhc2UgJ3MzdjQnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjQ7CiAgICAgIGNhc2UgJ3Y0JzogcmV0dXJuIEFXUy5TaWduZXJzLlY0OwogICAgICBjYXNlICdzMyc6IHJldHVybiBBV1MuU2lnbmVycy5TMzsKICAgICAgY2FzZSAndjNodHRwcyc6IHJldHVybiBBV1MuU2lnbmVycy5WM0h0dHBzOwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHNpZ25pbmcgdmVyc2lvbiAnICsgdmVyc2lvbik7CiAgfTsKICAKICByZXF1aXJlKCcuL3YyJyk7CiAgcmVxdWlyZSgnLi92MycpOwogIHJlcXVpcmUoJy4vdjNodHRwcycpOwogIHJlcXVpcmUoJy4vdjQnKTsKICByZXF1aXJlKCcuL3MzJyk7CiAgcmVxdWlyZSgnLi9wcmVzaWduJyk7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3ByZXNpZ24iOjYyLCIuL3MzIjo2NCwiLi92MiI6NjUsIi4vdjMiOjY2LCIuL3YzaHR0cHMiOjY3LCIuL3Y0Ijo2OH1dLDY0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5TMyA9IGluaGVyaXQoQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciwgewogICAgLyoqCiAgICAgKiBXaGVuIGJ1aWxkaW5nIHRoZSBzdHJpbmdUb1NpZ24sIHRoZXNlIHN1YiByZXNvdXJjZSBwYXJhbXMgc2hvdWxkIGJlCiAgICAgKiBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWRlY29kZWQgdmFsdWVzCiAgICAgKi8KICAgIHN1YlJlc291cmNlczogewogICAgICAnYWNsJzogMSwKICAgICAgJ2FjY2VsZXJhdGUnOiAxLAogICAgICAnYW5hbHl0aWNzJzogMSwKICAgICAgJ2NvcnMnOiAxLAogICAgICAnbGlmZWN5Y2xlJzogMSwKICAgICAgJ2RlbGV0ZSc6IDEsCiAgICAgICdpbnZlbnRvcnknOiAxLAogICAgICAnbG9jYXRpb24nOiAxLAogICAgICAnbG9nZ2luZyc6IDEsCiAgICAgICdtZXRyaWNzJzogMSwKICAgICAgJ25vdGlmaWNhdGlvbic6IDEsCiAgICAgICdwYXJ0TnVtYmVyJzogMSwKICAgICAgJ3BvbGljeSc6IDEsCiAgICAgICdyZXF1ZXN0UGF5bWVudCc6IDEsCiAgICAgICdyZXBsaWNhdGlvbic6IDEsCiAgICAgICdyZXN0b3JlJzogMSwKICAgICAgJ3RhZ2dpbmcnOiAxLAogICAgICAndG9ycmVudCc6IDEsCiAgICAgICd1cGxvYWRJZCc6IDEsCiAgICAgICd1cGxvYWRzJzogMSwKICAgICAgJ3ZlcnNpb25JZCc6IDEsCiAgICAgICd2ZXJzaW9uaW5nJzogMSwKICAgICAgJ3ZlcnNpb25zJzogMSwKICAgICAgJ3dlYnNpdGUnOiAxCiAgICB9LAogIAogICAgLy8gd2hlbiBidWlsZGluZyB0aGUgc3RyaW5nVG9TaWduLCB0aGVzZSBxdWVyeXN0cmluZyBwYXJhbXMgc2hvdWxkIGJlCiAgICAvLyBwYXJ0IG9mIHRoZSBjYW5vbmljYWwgcmVzb3VyY2Ugc3RyaW5nIHdpdGggdGhlaXIgTk9OLWVuY29kZWQgdmFsdWVzCiAgICByZXNwb25zZUhlYWRlcnM6IHsKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtdHlwZSc6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWxhbmd1YWdlJzogMSwKICAgICAgJ3Jlc3BvbnNlLWV4cGlyZXMnOiAxLAogICAgICAncmVzcG9uc2UtY2FjaGUtY29udHJvbCc6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWRpc3Bvc2l0aW9uJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNvbnRlbnQtZW5jb2RpbmcnOiAxCiAgICB9LAogIAogICAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewogICAgICBpZiAoIXRoaXMucmVxdWVzdC5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IEFXUy51dGlsLmRhdGUucmZjODIyKGRhdGUpOwogICAgICB9CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICAvLyBwcmVzaWduZWQgVVJMcyByZXF1aXJlIHRoaXMgaGVhZGVyIHRvIGJlIGxvd2VyY2FzZWQKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICB2YXIgc2lnbmF0dXJlID0gdGhpcy5zaWduKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSk7CiAgICAgIHZhciBhdXRoID0gJ0FXUyAnICsgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnOicgKyBzaWduYXR1cmU7CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBhdXRoOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2goci5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1snQ29udGVudC1NRDUnXSB8fCAnJyk7CiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydDb250ZW50LVR5cGUnXSB8fCAnJyk7CiAgCiAgICAgIC8vIFRoaXMgaXMgdGhlICJEYXRlIiBoZWFkZXIsIGJ1dCB3ZSB1c2UgWC1BbXotRGF0ZS4KICAgICAgLy8gVGhlIFMzIHNpZ25pbmcgbWVjaGFuaXNtIHJlcXVpcmVzIHVzIHRvIHBhc3MgYW4gZW1wdHkKICAgICAgLy8gc3RyaW5nIGZvciB0aGlzIERhdGUgaGVhZGVyIHJlZ2FyZGxlc3MuCiAgICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddIHx8ICcnKTsKICAKICAgICAgdmFyIGhlYWRlcnMgPSB0aGlzLmNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzKCk7CiAgICAgIGlmIChoZWFkZXJzKSBwYXJ0cy5wdXNoKGhlYWRlcnMpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsaXplZFJlc291cmNlKCkpOwogIAogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAKICAgIH0sCiAgCiAgICBjYW5vbmljYWxpemVkQW16SGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsaXplZEFtekhlYWRlcnMoKSB7CiAgCiAgICAgIHZhciBhbXpIZWFkZXJzID0gW107CiAgCiAgICAgIEFXUy51dGlsLmVhY2godGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgaWYgKG5hbWUubWF0Y2goL154LWFtei0vaSkpCiAgICAgICAgICBhbXpIZWFkZXJzLnB1c2gobmFtZSk7CiAgICAgIH0pOwogIAogICAgICBhbXpIZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYS50b0xvd2VyQ2FzZSgpIDwgYi50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgICB9KTsKICAKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGFtekhlYWRlcnMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcGFydHMucHVzaChuYW1lLnRvTG93ZXJDYXNlKCkgKyAnOicgKyBTdHJpbmcodGhpcy5yZXF1ZXN0LmhlYWRlcnNbbmFtZV0pKTsKICAgICAgfSk7CiAgCiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIAogICAgfSwKICAKICAgIGNhbm9uaWNhbGl6ZWRSZXNvdXJjZTogZnVuY3Rpb24gY2Fub25pY2FsaXplZFJlc291cmNlKCkgewogIAogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgdmFyIHBhcnRzID0gci5wYXRoLnNwbGl0KCc/Jyk7CiAgICAgIHZhciBwYXRoID0gcGFydHNbMF07CiAgICAgIHZhciBxdWVyeXN0cmluZyA9IHBhcnRzWzFdOwogIAogICAgICB2YXIgcmVzb3VyY2UgPSAnJzsKICAKICAgICAgaWYgKHIudmlydHVhbEhvc3RlZEJ1Y2tldCkKICAgICAgICByZXNvdXJjZSArPSAnLycgKyByLnZpcnR1YWxIb3N0ZWRCdWNrZXQ7CiAgCiAgICAgIHJlc291cmNlICs9IHBhdGg7CiAgCiAgICAgIGlmIChxdWVyeXN0cmluZykgewogIAogICAgICAgIC8vIGNvbGxlY3QgYSBsaXN0IG9mIHN1YiByZXNvdXJjZXMgYW5kIHF1ZXJ5IHBhcmFtcyB0aGF0IG5lZWQgdG8gYmUgc2lnbmVkCiAgICAgICAgdmFyIHJlc291cmNlcyA9IFtdOwogIAogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIHF1ZXJ5c3RyaW5nLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChwYXJhbSkgewogICAgICAgICAgdmFyIG5hbWUgPSBwYXJhbS5zcGxpdCgnPScpWzBdOwogICAgICAgICAgdmFyIHZhbHVlID0gcGFyYW0uc3BsaXQoJz0nKVsxXTsKICAgICAgICAgIGlmICh0aGlzLnN1YlJlc291cmNlc1tuYW1lXSB8fCB0aGlzLnJlc3BvbnNlSGVhZGVyc1tuYW1lXSkgewogICAgICAgICAgICB2YXIgc3VicmVzb3VyY2UgPSB7IG5hbWU6IG5hbWUgfTsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5zdWJSZXNvdXJjZXNbbmFtZV0pIHsKICAgICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb3VyY2VzLnB1c2goc3VicmVzb3VyY2UpOwogICAgICAgICAgfQogICAgICAgIH0pOwogIAogICAgICAgIHJlc291cmNlcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLm5hbWUgPCBiLm5hbWUgPyAtMSA6IDE7IH0pOwogIAogICAgICAgIGlmIChyZXNvdXJjZXMubGVuZ3RoKSB7CiAgCiAgICAgICAgICBxdWVyeXN0cmluZyA9IFtdOwogICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJlc291cmNlcywgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgICBpZiAocmVzLnZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBxdWVyeXN0cmluZy5wdXNoKHJlcy5uYW1lICsgJz0nICsgcmVzLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgCiAgICAgICAgICByZXNvdXJjZSArPSAnPycgKyBxdWVyeXN0cmluZy5qb2luKCcmJyk7CiAgICAgICAgfQogIAogICAgICB9CiAgCiAgICAgIHJldHVybiByZXNvdXJjZTsKICAKICAgIH0sCiAgCiAgICBzaWduOiBmdW5jdGlvbiBzaWduKHNlY3JldCwgc3RyaW5nKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhzZWNyZXQsIHN0cmluZywgJ2Jhc2U2NCcsICdzaGExJyk7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5TMzsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjIgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAKICAgICAgaWYgKCFkYXRlKSBkYXRlID0gQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCk7CiAgCiAgICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwogIAogICAgICByLnBhcmFtcy5UaW1lc3RhbXAgPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEoZGF0ZSk7CiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZVZlcnNpb24gPSAnMic7CiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZU1ldGhvZCA9ICdIbWFjU0hBMjU2JzsKICAgICAgci5wYXJhbXMuQVdTQWNjZXNzS2V5SWQgPSBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHIucGFyYW1zLlNlY3VyaXR5VG9rZW4gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgZGVsZXRlIHIucGFyYW1zLlNpZ25hdHVyZTsgLy8gZGVsZXRlIG9sZCBTaWduYXR1cmUgZm9yIHJlLXNpZ25pbmcKICAgICAgci5wYXJhbXMuU2lnbmF0dXJlID0gdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogIAogICAgICByLmJvZHkgPSBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHIucGFyYW1zKTsKICAgICAgci5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gci5ib2R5Lmxlbmd0aDsKICAgIH0sCiAgCiAgICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpLCAnYmFzZTY0Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5lbmRwb2ludC5ob3N0LnRvTG93ZXJDYXNlKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5wYXRobmFtZSgpKTsKICAgICAgcGFydHMucHVzaChBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHRoaXMucmVxdWVzdC5wYXJhbXMpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMjsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAKICAgICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5yZmM4MjIoZGF0ZSk7CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBkYXRldGltZTsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtem4tQXV0aG9yaXphdGlvbiddID0KICAgICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAKICAgIH0sCiAgCiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiAnQVdTMyAnICsKICAgICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICAgJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpICsgJywnICsKICAgICAgICAnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgICB9LAogIAogICAgc2lnbmVkSGVhZGVyczogZnVuY3Rpb24gc2lnbmVkSGVhZGVycygpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHRoaXMuaGVhZGVyc1RvU2lnbigpLCBmdW5jdGlvbiBpdGVyYXRvcihoKSB7CiAgICAgICAgaGVhZGVycy5wdXNoKGgudG9Mb3dlckNhc2UoKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gaGVhZGVycy5zb3J0KCkuam9pbignOycpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnM7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2godGhpcy5oZWFkZXJzVG9TaWduKCksIGZ1bmN0aW9uIGl0ZXJhdG9yKGgpIHsKICAgICAgICBwYXJ0cy5wdXNoKGgudG9Mb3dlckNhc2UoKS50cmltKCkgKyAnOicgKyBTdHJpbmcoaGVhZGVyc1toXSkudHJpbSgpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5zb3J0KCkuam9pbignXG4nKSArICdcbic7CiAgICB9LAogIAogICAgaGVhZGVyc1RvU2lnbjogZnVuY3Rpb24gaGVhZGVyc1RvU2lnbigpIHsKICAgICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gaXRlcmF0b3IoaykgewogICAgICAgIGlmIChrID09PSAnSG9zdCcgfHwgayA9PT0gJ0NvbnRlbnQtRW5jb2RpbmcnIHx8IGsubWF0Y2goL15YLUFtei9pKSkgewogICAgICAgICAgaGVhZGVycy5wdXNoKGspOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfSwKICAKICAgIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCksICdiYXNlNjQnKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2goJy8nKTsKICAgICAgcGFydHMucHVzaCgnJyk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5ib2R5KTsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYocGFydHMuam9pbignXG4nKSk7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMzsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgcmVxdWlyZSgnLi92MycpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlYzSHR0cHMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlYzLCB7CiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzKSB7CiAgICAgIHJldHVybiAnQVdTMy1IVFRQUyAnICsKICAgICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgICAnQWxnb3JpdGhtPUhtYWNTSEEyNTYsJyArCiAgICAgICAgJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlYzSHR0cHM7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3YzIjo2Nn1dLDY4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciB2NENyZWRlbnRpYWxzID0gcmVxdWlyZSgnLi92NF9jcmVkZW50aWFscycpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuVjQgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBWNChyZXF1ZXN0LCBzZXJ2aWNlTmFtZSwgb3B0aW9ucykgewogICAgICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmNhbGwodGhpcywgcmVxdWVzdCk7CiAgICAgIHRoaXMuc2VydmljZU5hbWUgPSBzZXJ2aWNlTmFtZTsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHRoaXMuc2lnbmF0dXJlQ2FjaGUgPSB0eXBlb2Ygb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA9PT0gJ2Jvb2xlYW4nID8gb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA6IHRydWU7CiAgICAgIHRoaXMub3BlcmF0aW9uID0gb3B0aW9ucy5vcGVyYXRpb247CiAgICAgIHRoaXMuc2lnbmF0dXJlVmVyc2lvbiA9IG9wdGlvbnMuc2lnbmF0dXJlVmVyc2lvbjsKICAgIH0sCiAgCiAgICBhbGdvcml0aG06ICdBV1M0LUhNQUMtU0hBMjU2JywKICAKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAgICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKGRhdGUpLnJlcGxhY2UoL1s6XC1dfFwuXGR7M30vZywgJycpOwogIAogICAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpKSB7CiAgICAgICAgdGhpcy51cGRhdGVGb3JQcmVzaWduZWQoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFkZEhlYWRlcnMoY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgICAgfQogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0KICAgICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKICAgIH0sCiAgCiAgICBhZGRIZWFkZXJzOiBmdW5jdGlvbiBhZGRIZWFkZXJzKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gZGF0ZXRpbWU7CiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogICAgfSwKICAKICAgIHVwZGF0ZUZvclByZXNpZ25lZDogZnVuY3Rpb24gdXBkYXRlRm9yUHJlc2lnbmVkKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgY3JlZFN0cmluZyA9IHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSk7CiAgICAgIHZhciBxcyA9IHsKICAgICAgICAnWC1BbXotRGF0ZSc6IGRhdGV0aW1lLAogICAgICAgICdYLUFtei1BbGdvcml0aG0nOiB0aGlzLmFsZ29yaXRobSwKICAgICAgICAnWC1BbXotQ3JlZGVudGlhbCc6IGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZywKICAgICAgICAnWC1BbXotRXhwaXJlcyc6IHRoaXMucmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdLAogICAgICAgICdYLUFtei1TaWduZWRIZWFkZXJzJzogdGhpcy5zaWduZWRIZWFkZXJzKCkKICAgICAgfTsKICAKICAgICAgaWYgKGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbikgewogICAgICAgIHFzWydYLUFtei1TZWN1cml0eS1Ub2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10pIHsKICAgICAgICBxc1snQ29udGVudC1UeXBlJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgICAgIH0KICAgICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LU1ENSddKSB7CiAgICAgICAgcXNbJ0NvbnRlbnQtTUQ1J10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1NRDUnXTsKICAgICAgfQogICAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXSkgewogICAgICAgIHFzWydDYWNoZS1Db250cm9sJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ2FjaGUtQ29udHJvbCddOwogICAgICB9CiAgCiAgICAgIC8vIG5lZWQgdG8gcHVsbCBpbiBhbnkgb3RoZXIgWC1BbXotKiBoZWFkZXJzCiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChrZXkgPT09IGV4cGlyZXNIZWFkZXIpIHJldHVybjsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICAgIHZhciBsb3dlcktleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgLy8gTWV0YWRhdGEgc2hvdWxkIGJlIG5vcm1hbGl6ZWQKICAgICAgICAgIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei1tZXRhLScpID09PSAwKSB7CiAgICAgICAgICAgIHFzW2xvd2VyS2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgewogICAgICAgICAgICBxc1trZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgdmFyIHNlcCA9IHRoaXMucmVxdWVzdC5wYXRoLmluZGV4T2YoJz8nKSA+PSAwID8gJyYnIDogJz8nOwogICAgICB0aGlzLnJlcXVlc3QucGF0aCArPSBzZXAgKyBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHFzKTsKICAgIH0sCiAgCiAgICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdmFyIGNyZWRTdHJpbmcgPSB0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuYWxnb3JpdGhtICsgJyBDcmVkZW50aWFsPScgKwogICAgICAgIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJy8nICsgY3JlZFN0cmluZyk7CiAgICAgIHBhcnRzLnB1c2goJ1NpZ25lZEhlYWRlcnM9JyArIHRoaXMuc2lnbmVkSGVhZGVycygpKTsKICAgICAgcGFydHMucHVzaCgnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscywgZGF0ZXRpbWUpKTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJywgJyk7CiAgICB9LAogIAogICAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICAgIHZhciBzaWduaW5nS2V5ID0gdjRDcmVkZW50aWFscy5nZXRTaWduaW5nS2V5KAogICAgICAgIGNyZWRlbnRpYWxzLAogICAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICAgIHRoaXMuc2VydmljZU5hbWUsCiAgICAgICAgdGhpcy5zaWduYXR1cmVDYWNoZQogICAgICApOwogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoc2lnbmluZ0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oZGF0ZXRpbWUpLCAnaGV4Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oZGF0ZXRpbWUpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHBhcnRzLnB1c2goJ0FXUzQtSE1BQy1TSEEyNTYnKTsKICAgICAgcGFydHMucHVzaChkYXRldGltZSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLmNhbm9uaWNhbFN0cmluZygpKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbFN0cmluZzogZnVuY3Rpb24gY2Fub25pY2FsU3RyaW5nKCkgewogICAgICB2YXIgcGFydHMgPSBbXSwgcGF0aG5hbWUgPSB0aGlzLnJlcXVlc3QucGF0aG5hbWUoKTsKICAgICAgaWYgKHRoaXMuc2VydmljZU5hbWUgIT09ICdzMycgJiYgdGhpcy5zaWduYXR1cmVWZXJzaW9uICE9PSAnczN2NCcpIHBhdGhuYW1lID0gQVdTLnV0aWwudXJpRXNjYXBlUGF0aChwYXRobmFtZSk7CiAgCiAgICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICAgIHBhcnRzLnB1c2gocGF0aG5hbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5zZWFyY2goKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkgKyAnXG4nKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnNpZ25lZEhlYWRlcnMoKSk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkQm9keUhhc2goKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgaXRlbSkgewogICAgICAgIGhlYWRlcnMucHVzaChba2V5LCBpdGVtXSk7CiAgICAgIH0pOwogICAgICBoZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYVswXS50b0xvd2VyQ2FzZSgpIDwgYlswXS50b0xvd2VyQ2FzZSgpID8gLTEgOiAxOwogICAgICB9KTsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIGhlYWRlcnMsIGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZW1bMF0udG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGl0ZW1bMV07CiAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUudG9TdHJpbmcgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdIZWFkZXIgJyArIGtleSArICcgY29udGFpbnMgaW52YWxpZCB2YWx1ZScpLCB7CiAgICAgICAgICAgICAgY29kZTogJ0ludmFsaWRIZWFkZXInCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcGFydHMucHVzaChrZXkgKyAnOicgKwogICAgICAgICAgICB0aGlzLmNhbm9uaWNhbEhlYWRlclZhbHVlcyh2YWx1ZS50b1N0cmluZygpKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgICB9LAogIAogICAgY2Fub25pY2FsSGVhZGVyVmFsdWVzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJWYWx1ZXModmFsdWVzKSB7CiAgICAgIHJldHVybiB2YWx1ZXMucmVwbGFjZSgvXHMrL2csICcgJykucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKICAgIH0sCiAgCiAgICBzaWduZWRIZWFkZXJzOiBmdW5jdGlvbiBzaWduZWRIZWFkZXJzKCkgewogICAgICB2YXIga2V5cyA9IFtdOwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIGtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGtleXMuc29ydCgpLmpvaW4oJzsnKTsKICAgIH0sCiAgCiAgICBjcmVkZW50aWFsU3RyaW5nOiBmdW5jdGlvbiBjcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSB7CiAgICAgIHJldHVybiB2NENyZWRlbnRpYWxzLmNyZWF0ZVNjb3BlKAogICAgICAgIGRhdGV0aW1lLnN1YnN0cigwLCA4KSwKICAgICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICAgIHRoaXMuc2VydmljZU5hbWUKICAgICAgKTsKICAgIH0sCiAgCiAgICBoZXhFbmNvZGVkSGFzaDogZnVuY3Rpb24gaGFzaChzdHJpbmcpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYoc3RyaW5nLCAnaGV4Jyk7CiAgICB9LAogIAogICAgaGV4RW5jb2RlZEJvZHlIYXNoOiBmdW5jdGlvbiBoZXhFbmNvZGVkQm9keUhhc2goKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0OwogICAgICBpZiAodGhpcy5pc1ByZXNpZ25lZCgpICYmIHRoaXMuc2VydmljZU5hbWUgPT09ICdzMycgJiYgIXJlcXVlc3QuYm9keSkgewogICAgICAgIHJldHVybiAnVU5TSUdORUQtUEFZTE9BRCc7CiAgICAgIH0gZWxzZSBpZiAocmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddKSB7CiAgICAgICAgcmV0dXJuIHJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5oZXhFbmNvZGVkSGFzaCh0aGlzLnJlcXVlc3QuYm9keSB8fCAnJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB1bnNpZ25hYmxlSGVhZGVyczogWwogICAgICAnYXV0aG9yaXphdGlvbicsCiAgICAgICdjb250ZW50LXR5cGUnLAogICAgICAnY29udGVudC1sZW5ndGgnLAogICAgICAndXNlci1hZ2VudCcsCiAgICAgIGV4cGlyZXNIZWFkZXIsCiAgICAgICdleHBlY3QnLAogICAgICAneC1hbXpuLXRyYWNlLWlkJwogICAgXSwKICAKICAgIGlzU2lnbmFibGVIZWFkZXI6IGZ1bmN0aW9uIGlzU2lnbmFibGVIZWFkZXIoa2V5KSB7CiAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCd4LWFtei0nKSA9PT0gMCkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiB0aGlzLnVuc2lnbmFibGVIZWFkZXJzLmluZGV4T2Yoa2V5KSA8IDA7CiAgICB9LAogIAogICAgaXNQcmVzaWduZWQ6IGZ1bmN0aW9uIGlzUHJlc2lnbmVkKCkgewogICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPyB0cnVlIDogZmFsc2U7CiAgICB9CiAgCiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WNDsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4vdjRfY3JlZGVudGlhbHMiOjY5fV0sNjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGNhY2hlZFNlY3JldCA9IHt9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBjYWNoZVF1ZXVlID0gW107CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIG1heENhY2hlRW50cmllcyA9IDUwOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB2NElkZW50aWZpZXIgPSAnYXdzNF9yZXF1ZXN0JzsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgICAqIEBwYXJhbSBzZXJ2aWNlTmFtZSBbU3RyaW5nXQogICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICovCiAgICBjcmVhdGVTY29wZTogZnVuY3Rpb24gY3JlYXRlU2NvcGUoZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlTmFtZSkgewogICAgICByZXR1cm4gWwogICAgICAgIGRhdGUuc3Vic3RyKDAsIDgpLAogICAgICAgIHJlZ2lvbiwKICAgICAgICBzZXJ2aWNlTmFtZSwKICAgICAgICB2NElkZW50aWZpZXIKICAgICAgXS5qb2luKCcvJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gY3JlZGVudGlhbHMgW0NyZWRlbnRpYWxzXQogICAgICogQHBhcmFtIGRhdGUgW1N0cmluZ10KICAgICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gc2hvdWxkQ2FjaGUgW0Jvb2xlYW5dCiAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgKi8KICAgIGdldFNpZ25pbmdLZXk6IGZ1bmN0aW9uIGdldFNpZ25pbmdLZXkoCiAgICAgIGNyZWRlbnRpYWxzLAogICAgICBkYXRlLAogICAgICByZWdpb24sCiAgICAgIHNlcnZpY2UsCiAgICAgIHNob3VsZENhY2hlCiAgICApIHsKICAgICAgdmFyIGNyZWRzSWRlbnRpZmllciA9IEFXUy51dGlsLmNyeXB0bwogICAgICAgIC5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQsICdiYXNlNjQnKTsKICAgICAgdmFyIGNhY2hlS2V5ID0gW2NyZWRzSWRlbnRpZmllciwgZGF0ZSwgcmVnaW9uLCBzZXJ2aWNlXS5qb2luKCdfJyk7CiAgICAgIHNob3VsZENhY2hlID0gc2hvdWxkQ2FjaGUgIT09IGZhbHNlOwogICAgICBpZiAoc2hvdWxkQ2FjaGUgJiYgKGNhY2hlS2V5IGluIGNhY2hlZFNlY3JldCkpIHsKICAgICAgICByZXR1cm4gY2FjaGVkU2VjcmV0W2NhY2hlS2V5XTsKICAgICAgfQogIAogICAgICB2YXIga0RhdGUgPSBBV1MudXRpbC5jcnlwdG8uaG1hYygKICAgICAgICAnQVdTNCcgKyBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksCiAgICAgICAgZGF0ZSwKICAgICAgICAnYnVmZmVyJwogICAgICApOwogICAgICB2YXIga1JlZ2lvbiA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtEYXRlLCByZWdpb24sICdidWZmZXInKTsKICAgICAgdmFyIGtTZXJ2aWNlID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoa1JlZ2lvbiwgc2VydmljZSwgJ2J1ZmZlcicpOwogIAogICAgICB2YXIgc2lnbmluZ0tleSA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtTZXJ2aWNlLCB2NElkZW50aWZpZXIsICdidWZmZXInKTsKICAgICAgaWYgKHNob3VsZENhY2hlKSB7CiAgICAgICAgY2FjaGVkU2VjcmV0W2NhY2hlS2V5XSA9IHNpZ25pbmdLZXk7CiAgICAgICAgY2FjaGVRdWV1ZS5wdXNoKGNhY2hlS2V5KTsKICAgICAgICBpZiAoY2FjaGVRdWV1ZS5sZW5ndGggPiBtYXhDYWNoZUVudHJpZXMpIHsKICAgICAgICAgIC8vIHJlbW92ZSB0aGUgb2xkZXN0IGVudHJ5IChub3QgdGhlIGxlYXN0IHJlY2VudGx5IHVzZWQpCiAgICAgICAgICBkZWxldGUgY2FjaGVkU2VjcmV0W2NhY2hlUXVldWUuc2hpZnQoKV07CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiBzaWduaW5nS2V5OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogRW1wdGllcyB0aGUgZGVyaXZlZCBzaWduaW5nIGtleSBjYWNoZS4gTWFkZSBhdmFpbGFibGUgZm9yIHRlc3RpbmcgcHVycG9zZXMKICAgICAqIG9ubHkuCiAgICAgKi8KICAgIGVtcHR5Q2FjaGU6IGZ1bmN0aW9uIGVtcHR5Q2FjaGUoKSB7CiAgICAgIGNhY2hlZFNlY3JldCA9IHt9OwogICAgICBjYWNoZVF1ZXVlID0gW107CiAgICB9CiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw3MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZnVuY3Rpb24gQWNjZXB0b3JTdGF0ZU1hY2hpbmUoc3RhdGVzLCBzdGF0ZSkgewogICAgdGhpcy5jdXJyZW50U3RhdGUgPSBzdGF0ZSB8fCBudWxsOwogICAgdGhpcy5zdGF0ZXMgPSBzdGF0ZXMgfHwge307CiAgfQogIAogIEFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5ydW5UbyA9IGZ1bmN0aW9uIHJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGlucHV0RXJyb3IpIHsKICAgIGlmICh0eXBlb2YgZmluYWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBpbnB1dEVycm9yID0gYmluZE9iamVjdDsgYmluZE9iamVjdCA9IGRvbmU7CiAgICAgIGRvbmUgPSBmaW5hbFN0YXRlOyBmaW5hbFN0YXRlID0gbnVsbDsKICAgIH0KICAKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBzdGF0ZSA9IHNlbGYuc3RhdGVzW3NlbGYuY3VycmVudFN0YXRlXTsKICAgIHN0YXRlLmZuLmNhbGwoYmluZE9iamVjdCB8fCBzZWxmLCBpbnB1dEVycm9yLCBmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKGVycikgewogICAgICAgIGlmIChzdGF0ZS5mYWlsKSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmZhaWw7CiAgICAgICAgZWxzZSByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoc3RhdGUuYWNjZXB0KSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmFjY2VwdDsKICAgICAgICBlbHNlIHJldHVybiBkb25lID8gZG9uZS5jYWxsKGJpbmRPYmplY3QpIDogbnVsbDsKICAgICAgfQogICAgICBpZiAoc2VsZi5jdXJyZW50U3RhdGUgPT09IGZpbmFsU3RhdGUpIHsKICAgICAgICByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0LCBlcnIpIDogbnVsbDsKICAgICAgfQogIAogICAgICBzZWxmLnJ1blRvKGZpbmFsU3RhdGUsIGRvbmUsIGJpbmRPYmplY3QsIGVycik7CiAgICB9KTsKICB9OwogIAogIEFjY2VwdG9yU3RhdGVNYWNoaW5lLnByb3RvdHlwZS5hZGRTdGF0ZSA9IGZ1bmN0aW9uIGFkZFN0YXRlKG5hbWUsIGFjY2VwdFN0YXRlLCBmYWlsU3RhdGUsIGZuKSB7CiAgICBpZiAodHlwZW9mIGFjY2VwdFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGZuID0gYWNjZXB0U3RhdGU7IGFjY2VwdFN0YXRlID0gbnVsbDsgZmFpbFN0YXRlID0gbnVsbDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGZhaWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBmbiA9IGZhaWxTdGF0ZTsgZmFpbFN0YXRlID0gbnVsbDsKICAgIH0KICAKICAgIGlmICghdGhpcy5jdXJyZW50U3RhdGUpIHRoaXMuY3VycmVudFN0YXRlID0gbmFtZTsKICAgIHRoaXMuc3RhdGVzW25hbWVdID0geyBhY2NlcHQ6IGFjY2VwdFN0YXRlLCBmYWlsOiBmYWlsU3RhdGUsIGZuOiBmbiB9OwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFjY2VwdG9yU3RhdGVNYWNoaW5lOwogIAogIH0se31dLDcxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3Msc2V0SW1tZWRpYXRlKXsoZnVuY3Rpb24gKCl7CiAgLyogZXNsaW50IGd1YXJkLWZvci1pbjowICovCiAgdmFyIEFXUzsKICAKICAvKioKICAgKiBBIHNldCBvZiB1dGlsaXR5IG1ldGhvZHMgZm9yIHVzZSB3aXRoIHRoZSBBV1MgU0RLLgogICAqCiAgICogQCFhdHRyaWJ1dGUgYWJvcnQKICAgKiAgIFJldHVybiB0aGlzIHZhbHVlIGZyb20gYW4gaXRlcmF0b3IgZnVuY3Rpb24ge2VhY2h9IG9yIHthcnJheUVhY2h9CiAgICogICB0byBicmVhayBvdXQgb2YgdGhlIGl0ZXJhdGlvbi4KICAgKiAgIEBleGFtcGxlIEJyZWFraW5nIG91dCBvZiBhbiBpdGVyYXRvciBmdW5jdGlvbgogICAqICAgICBBV1MudXRpbC5lYWNoKHthOiAxLCBiOiAyLCBjOiAzfSwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAqICAgICAgIGlmIChrZXkgPT0gJ2InKSByZXR1cm4gQVdTLnV0aWwuYWJvcnQ7CiAgICogICAgIH0pOwogICAqICAgQHNlZSBlYWNoCiAgICogICBAc2VlIGFycmF5RWFjaAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB1dGlsID0gewogICAgZW52aXJvbm1lbnQ6ICdub2RlanMnLAogICAgZW5naW5lOiBmdW5jdGlvbiBlbmdpbmUoKSB7CiAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBuYXZpZ2F0b3IgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGVuZ2luZSA9IHByb2Nlc3MucGxhdGZvcm0gKyAnLycgKyBwcm9jZXNzLnZlcnNpb247CiAgICAgICAgaWYgKHByb2Nlc3MuZW52LkFXU19FWEVDVVRJT05fRU5WKSB7CiAgICAgICAgICBlbmdpbmUgKz0gJyBleGVjLWVudi8nICsgcHJvY2Vzcy5lbnYuQVdTX0VYRUNVVElPTl9FTlY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbmdpbmU7CiAgICAgIH0KICAgIH0sCiAgCiAgICB1c2VyQWdlbnQ6IGZ1bmN0aW9uIHVzZXJBZ2VudCgpIHsKICAgICAgdmFyIG5hbWUgPSB1dGlsLmVudmlyb25tZW50OwogICAgICB2YXIgYWdlbnQgPSAnYXdzLXNkay0nICsgbmFtZSArICcvJyArIHJlcXVpcmUoJy4vY29yZScpLlZFUlNJT047CiAgICAgIGlmIChuYW1lID09PSAnbm9kZWpzJykgYWdlbnQgKz0gJyAnICsgdXRpbC5lbmdpbmUoKTsKICAgICAgcmV0dXJuIGFnZW50OwogICAgfSwKICAKICAgIHVyaUVzY2FwZTogZnVuY3Rpb24gdXJpRXNjYXBlKHN0cmluZykgewogICAgICB2YXIgb3V0cHV0ID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZyk7CiAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC9bXkEtWmEtejAtOV8uflwtJV0rL2csIGVzY2FwZSk7CiAgCiAgICAgIC8vIEFXUyBwZXJjZW50LWVuY29kZXMgc29tZSBleHRyYSBub24tc3RhbmRhcmQgY2hhcmFjdGVycyBpbiBhIFVSSQogICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvWypdL2csIGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgcmV0dXJuICclJyArIGNoLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gb3V0cHV0OwogICAgfSwKICAKICAgIHVyaUVzY2FwZVBhdGg6IGZ1bmN0aW9uIHVyaUVzY2FwZVBhdGgoc3RyaW5nKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICB1dGlsLmFycmF5RWFjaChzdHJpbmcuc3BsaXQoJy8nKSwgZnVuY3Rpb24gKHBhcnQpIHsKICAgICAgICBwYXJ0cy5wdXNoKHV0aWwudXJpRXNjYXBlKHBhcnQpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcvJyk7CiAgICB9LAogIAogICAgdXJsUGFyc2U6IGZ1bmN0aW9uIHVybFBhcnNlKHVybCkgewogICAgICByZXR1cm4gdXRpbC51cmwucGFyc2UodXJsKTsKICAgIH0sCiAgCiAgICB1cmxGb3JtYXQ6IGZ1bmN0aW9uIHVybEZvcm1hdCh1cmwpIHsKICAgICAgcmV0dXJuIHV0aWwudXJsLmZvcm1hdCh1cmwpOwogICAgfSwKICAKICAgIHF1ZXJ5U3RyaW5nUGFyc2U6IGZ1bmN0aW9uIHF1ZXJ5U3RyaW5nUGFyc2UocXMpIHsKICAgICAgcmV0dXJuIHV0aWwucXVlcnlzdHJpbmcucGFyc2UocXMpOwogICAgfSwKICAKICAgIHF1ZXJ5UGFyYW1zVG9TdHJpbmc6IGZ1bmN0aW9uIHF1ZXJ5UGFyYW1zVG9TdHJpbmcocGFyYW1zKSB7CiAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICB2YXIgZXNjYXBlID0gdXRpbC51cmlFc2NhcGU7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gT2JqZWN0LmtleXMocGFyYW1zKS5zb3J0KCk7CiAgCiAgICAgIHV0aWwuYXJyYXlFYWNoKHNvcnRlZEtleXMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbbmFtZV07CiAgICAgICAgdmFyIGVuYW1lID0gZXNjYXBlKG5hbWUpOwogICAgICAgIHZhciByZXN1bHQgPSBlbmFtZSArICc9JzsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgIHZhciB2YWxzID0gW107CiAgICAgICAgICB1dGlsLmFycmF5RWFjaCh2YWx1ZSwgZnVuY3Rpb24oaXRlbSkgeyB2YWxzLnB1c2goZXNjYXBlKGl0ZW0pKTsgfSk7CiAgICAgICAgICByZXN1bHQgPSBlbmFtZSArICc9JyArIHZhbHMuc29ydCgpLmpvaW4oJyYnICsgZW5hbWUgKyAnPScpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgcmVzdWx0ID0gZW5hbWUgKyAnPScgKyBlc2NhcGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBpdGVtcy5wdXNoKHJlc3VsdCk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gaXRlbXMuam9pbignJicpOwogICAgfSwKICAKICAgIHJlYWRGaWxlU3luYzogZnVuY3Rpb24gcmVhZEZpbGVTeW5jKHBhdGgpIHsKICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gcmVxdWlyZSgnZnMnKS5yZWFkRmlsZVN5bmMocGF0aCwgJ3V0Zi04Jyk7CiAgICB9LAogIAogICAgYmFzZTY0OiB7CiAgICAgIGVuY29kZTogZnVuY3Rpb24gZW5jb2RlNjQoc3RyaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBlbmNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGJ1ZiA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgICAgcmV0dXJuIGJ1Zi50b1N0cmluZygnYmFzZTY0Jyk7CiAgICAgIH0sCiAgCiAgICAgIGRlY29kZTogZnVuY3Rpb24gZGVjb2RlNjQoc3RyaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBkZWNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZywgJ2Jhc2U2NCcpOwogICAgICB9CiAgCiAgICB9LAogIAogICAgYnVmZmVyOiB7CiAgICAgIC8qKgogICAgICAgKiBCdWZmZXIgY29uc3RydWN0b3IgZm9yIE5vZGUgYnVmZmVyIGFuZCBidWZmZXIgcG9sbHlmaWxsCiAgICAgICAqLwogICAgICB0b0J1ZmZlcjogZnVuY3Rpb24oZGF0YSwgZW5jb2RpbmcpIHsKICAgICAgICByZXR1cm4gKHR5cGVvZiB1dGlsLkJ1ZmZlci5mcm9tID09PSAnZnVuY3Rpb24nICYmIHV0aWwuQnVmZmVyLmZyb20gIT09IFVpbnQ4QXJyYXkuZnJvbSkgPwogICAgICAgICAgdXRpbC5CdWZmZXIuZnJvbShkYXRhLCBlbmNvZGluZykgOiBuZXcgdXRpbC5CdWZmZXIoZGF0YSwgZW5jb2RpbmcpOwogICAgICB9LAogIAogICAgICBhbGxvYzogZnVuY3Rpb24oc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgICAgICBpZiAodHlwZW9mIHNpemUgIT09ICdudW1iZXInKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NpemUgcGFzc2VkIHRvIGFsbG9jIG11c3QgYmUgYSBudW1iZXIuJyk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgdXRpbC5CdWZmZXIuYWxsb2MgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHJldHVybiB1dGlsLkJ1ZmZlci5hbGxvYyhzaXplLCBmaWxsLCBlbmNvZGluZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBidWYgPSBuZXcgdXRpbC5CdWZmZXIoc2l6ZSk7CiAgICAgICAgICBpZiAoZmlsbCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBidWYuZmlsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBidWYuZmlsbChmaWxsLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgZW5jb2RpbmcpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJ1ZjsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHRvU3RyZWFtOiBmdW5jdGlvbiB0b1N0cmVhbShidWZmZXIpIHsKICAgICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKGJ1ZmZlcikpIGJ1ZmZlciA9ICB1dGlsLmJ1ZmZlci50b0J1ZmZlcihidWZmZXIpOwogIAogICAgICAgIHZhciByZWFkYWJsZSA9IG5ldyAodXRpbC5zdHJlYW0uUmVhZGFibGUpKCk7CiAgICAgICAgdmFyIHBvcyA9IDA7CiAgICAgICAgcmVhZGFibGUuX3JlYWQgPSBmdW5jdGlvbihzaXplKSB7CiAgICAgICAgICBpZiAocG9zID49IGJ1ZmZlci5sZW5ndGgpIHJldHVybiByZWFkYWJsZS5wdXNoKG51bGwpOwogIAogICAgICAgICAgdmFyIGVuZCA9IHBvcyArIHNpemU7CiAgICAgICAgICBpZiAoZW5kID4gYnVmZmVyLmxlbmd0aCkgZW5kID0gYnVmZmVyLmxlbmd0aDsKICAgICAgICAgIHJlYWRhYmxlLnB1c2goYnVmZmVyLnNsaWNlKHBvcywgZW5kKSk7CiAgICAgICAgICBwb3MgPSBlbmQ7CiAgICAgICAgfTsKICAKICAgICAgICByZXR1cm4gcmVhZGFibGU7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBDb25jYXRlbmF0ZXMgYSBsaXN0IG9mIEJ1ZmZlciBvYmplY3RzLgogICAgICAgKi8KICAgICAgY29uY2F0OiBmdW5jdGlvbihidWZmZXJzKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IDAsCiAgICAgICAgICAgIG9mZnNldCA9IDAsCiAgICAgICAgICAgIGJ1ZmZlciA9IG51bGwsIGk7CiAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1ZmZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGxlbmd0aCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgCiAgICAgICAgYnVmZmVyID0gdXRpbC5idWZmZXIuYWxsb2MobGVuZ3RoKTsKICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgYnVmZmVyc1tpXS5jb3B5KGJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgICAgIG9mZnNldCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGJ1ZmZlcjsKICAgICAgfQogICAgfSwKICAKICAgIHN0cmluZzogewogICAgICBieXRlTGVuZ3RoOiBmdW5jdGlvbiBieXRlTGVuZ3RoKHN0cmluZykgewogICAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgc3RyaW5nID09PSB1bmRlZmluZWQpIHJldHVybiAwOwogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJykgc3RyaW5nID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAKICAgICAgICBpZiAodHlwZW9mIHN0cmluZy5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5sZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nLmxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcuc2l6ZSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcuc2l6ZTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcucGF0aCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIHJldHVybiByZXF1aXJlKCdmcycpLmxzdGF0U3luYyhzdHJpbmcucGF0aCkuc2l6ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBkZXRlcm1pbmUgbGVuZ3RoIG9mICcgKyBzdHJpbmcpLAogICAgICAgICAgICB7IG9iamVjdDogc3RyaW5nIH0pOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgdXBwZXJGaXJzdDogZnVuY3Rpb24gdXBwZXJGaXJzdChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nWzBdLnRvVXBwZXJDYXNlKCkgKyBzdHJpbmcuc3Vic3RyKDEpOwogICAgICB9LAogIAogICAgICBsb3dlckZpcnN0OiBmdW5jdGlvbiBsb3dlckZpcnN0KHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmdbMF0udG9Mb3dlckNhc2UoKSArIHN0cmluZy5zdWJzdHIoMSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICBpbmk6IHsKICAgICAgcGFyc2U6IGZ1bmN0aW9uIHN0cmluZyhpbmkpIHsKICAgICAgICB2YXIgY3VycmVudFNlY3Rpb24sIG1hcCA9IHt9OwogICAgICAgIHV0aWwuYXJyYXlFYWNoKGluaS5zcGxpdCgvXHI/XG4vKSwgZnVuY3Rpb24obGluZSkgewogICAgICAgICAgbGluZSA9IGxpbmUuc3BsaXQoLyhefFxzKVs7I10vKVswXTsgLy8gcmVtb3ZlIGNvbW1lbnRzCiAgICAgICAgICB2YXIgc2VjdGlvbiA9IGxpbmUubWF0Y2goL15ccypcWyhbXlxbXF1dKylcXVxzKiQvKTsKICAgICAgICAgIGlmIChzZWN0aW9uKSB7CiAgICAgICAgICAgIGN1cnJlbnRTZWN0aW9uID0gc2VjdGlvblsxXTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFNlY3Rpb24pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBsaW5lLm1hdGNoKC9eXHMqKC4rPylccyo9XHMqKC4rPylccyokLyk7CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXSA9IG1hcFtjdXJyZW50U2VjdGlvbl0gfHwge307CiAgICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXVtpdGVtWzFdXSA9IGl0ZW1bMl07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAKICAgICAgICByZXR1cm4gbWFwOwogICAgICB9CiAgICB9LAogIAogICAgZm46IHsKICAgICAgbm9vcDogZnVuY3Rpb24oKSB7fSwKICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIChlcnIpIHsgaWYgKGVycikgdGhyb3cgZXJyOyB9LAogIAogICAgICAvKioKICAgICAgICogVHVybiBhIHN5bmNocm9ub3VzIGZ1bmN0aW9uIGludG8gYXMgImFzeW5jIiBmdW5jdGlvbiBieSBtYWtpbmcgaXQgY2FsbAogICAgICAgKiBhIGNhbGxiYWNrLiBUaGUgdW5kZXJseWluZyBmdW5jdGlvbiBpcyBjYWxsZWQgd2l0aCBhbGwgYnV0IHRoZSBsYXN0IGFyZ3VtZW50LAogICAgICAgKiB3aGljaCBpcyB0cmVhdGVkIGFzIHRoZSBjYWxsYmFjay4gVGhlIGNhbGxiYWNrIGlzIHBhc3NlZCBwYXNzZWQgYSBmaXJzdCBhcmd1bWVudAogICAgICAgKiBvZiBudWxsIG9uIHN1Y2Nlc3MgdG8gbWltaWNrIHN0YW5kYXJkIG5vZGUgY2FsbGJhY2tzLgogICAgICAgKi8KICAgICAgbWFrZUFzeW5jOiBmdW5jdGlvbiBtYWtlQXN5bmMoZm4sIGV4cGVjdGVkQXJncykgewogICAgICAgIGlmIChleHBlY3RlZEFyZ3MgJiYgZXhwZWN0ZWRBcmdzIDw9IGZuLmxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgICAgY2FsbGJhY2socmVzdWx0KTsKICAgICAgICB9OwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBEYXRlIGFuZCB0aW1lIHV0aWxpdHkgZnVuY3Rpb25zLgogICAgICovCiAgICBkYXRlOiB7CiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtEYXRlXSB0aGUgY3VycmVudCBKYXZhU2NyaXB0IGRhdGUgb2JqZWN0LiBTaW5jZSBhbGwKICAgICAgICogICBBV1Mgc2VydmljZXMgcmVseSBvbiB0aGlzIGRhdGUgb2JqZWN0LCB5b3UgY2FuIG92ZXJyaWRlCiAgICAgICAqICAgdGhpcyBmdW5jdGlvbiB0byBwcm92aWRlIGEgc3BlY2lhbCB0aW1lIHZhbHVlIHRvIEFXUyBzZXJ2aWNlCiAgICAgICAqICAgcmVxdWVzdHMuCiAgICAgICAqLwogICAgICBnZXREYXRlOiBmdW5jdGlvbiBnZXREYXRlKCkgewogICAgICAgIGlmICghQVdTKSBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAgICAgICBpZiAoQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCkgeyAvLyB1c2Ugb2Zmc2V0IHdoZW4gbm9uLXplcm8KICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBkYXRlIGluIElTTy04NjAxIGZvcm1hdAogICAgICAgKi8KICAgICAgaXNvODYwMTogZnVuY3Rpb24gaXNvODYwMShkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvXC5cZHszfVokLywgJ1onKTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIGRhdGUgaW4gUkZDIDgyMiBmb3JtYXQKICAgICAgICovCiAgICAgIHJmYzgyMjogZnVuY3Rpb24gcmZjODIyKGRhdGUpIHsKICAgICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgICAgcmV0dXJuIGRhdGUudG9VVENTdHJpbmcoKTsKICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4gW0ludGVnZXJdIHRoZSBVTklYIHRpbWVzdGFtcCB2YWx1ZSBmb3IgdGhlIGN1cnJlbnQgdGltZQogICAgICAgKi8KICAgICAgdW5peFRpbWVzdGFtcDogZnVuY3Rpb24gdW5peFRpbWVzdGFtcChkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKSAvIDEwMDA7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcGFyYW0gW1N0cmluZyxudW1iZXIsRGF0ZV0gZGF0ZQogICAgICAgKiBAcmV0dXJuIFtEYXRlXQogICAgICAgKi8KICAgICAgZnJvbTogZnVuY3Rpb24gZm9ybWF0KGRhdGUpIHsKICAgICAgICBpZiAodHlwZW9mIGRhdGUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSAqIDEwMDApOyAvLyB1bml4IHRpbWVzdGFtcAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogR2l2ZW4gYSBEYXRlIG9yIGRhdGUtbGlrZSB2YWx1ZSwgdGhpcyBmdW5jdGlvbiBmb3JtYXRzIHRoZQogICAgICAgKiBkYXRlIGludG8gYSBzdHJpbmcgb2YgdGhlIHJlcXVlc3RlZCB2YWx1ZS4KICAgICAgICogQHBhcmFtIFtTdHJpbmcsbnVtYmVyLERhdGVdIGRhdGUKICAgICAgICogQHBhcmFtIFtTdHJpbmddIGZvcm1hdHRlciBWYWxpZCBmb3JtYXRzIGFyZToKICAgICAgICMgICAqICdpc284NjAxJwogICAgICAgIyAgICogJ3JmYzgyMicKICAgICAgICMgICAqICd1bml4VGltZXN0YW1wJwogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICAgICAqLwogICAgICBmb3JtYXQ6IGZ1bmN0aW9uIGZvcm1hdChkYXRlLCBmb3JtYXR0ZXIpIHsKICAgICAgICBpZiAoIWZvcm1hdHRlcikgZm9ybWF0dGVyID0gJ2lzbzg2MDEnOwogICAgICAgIHJldHVybiB1dGlsLmRhdGVbZm9ybWF0dGVyXSh1dGlsLmRhdGUuZnJvbShkYXRlKSk7CiAgICAgIH0sCiAgCiAgICAgIHBhcnNlVGltZXN0YW1wOiBmdW5jdGlvbiBwYXJzZVRpbWVzdGFtcCh2YWx1ZSkgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7IC8vIHVuaXggdGltZXN0YW1wIChudW1iZXIpCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGQrJC8pKSB7IC8vIHVuaXggdGltZXN0YW1wCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUgKiAxMDAwKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGR7NH0vKSkgeyAvLyBpc284NjAxCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cd3szfSwvKSkgeyAvLyByZmM4MjIKICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IoCiAgICAgICAgICAgIG5ldyBFcnJvcigndW5oYW5kbGVkIHRpbWVzdGFtcCBmb3JtYXQ6ICcgKyB2YWx1ZSksCiAgICAgICAgICAgIHtjb2RlOiAnVGltZXN0YW1wUGFyc2VyRXJyb3InfSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICB9LAogIAogICAgY3J5cHRvOiB7CiAgICAgIGNyYzMyVGFibGU6IFsKICAgICAgIDB4MDAwMDAwMDAsIDB4NzcwNzMwOTYsIDB4RUUwRTYxMkMsIDB4OTkwOTUxQkEsIDB4MDc2REM0MTksCiAgICAgICAweDcwNkFGNDhGLCAweEU5NjNBNTM1LCAweDlFNjQ5NUEzLCAweDBFREI4ODMyLCAweDc5RENCOEE0LAogICAgICAgMHhFMEQ1RTkxRSwgMHg5N0QyRDk4OCwgMHgwOUI2NEMyQiwgMHg3RUIxN0NCRCwgMHhFN0I4MkQwNywKICAgICAgIDB4OTBCRjFEOTEsIDB4MURCNzEwNjQsIDB4NkFCMDIwRjIsIDB4RjNCOTcxNDgsIDB4ODRCRTQxREUsCiAgICAgICAweDFBREFENDdELCAweDZERERFNEVCLCAweEY0RDRCNTUxLCAweDgzRDM4NUM3LCAweDEzNkM5ODU2LAogICAgICAgMHg2NDZCQThDMCwgMHhGRDYyRjk3QSwgMHg4QTY1QzlFQywgMHgxNDAxNUM0RiwgMHg2MzA2NkNEOSwKICAgICAgIDB4RkEwRjNENjMsIDB4OEQwODBERjUsIDB4M0I2RTIwQzgsIDB4NEM2OTEwNUUsIDB4RDU2MDQxRTQsCiAgICAgICAweEEyNjc3MTcyLCAweDNDMDNFNEQxLCAweDRCMDRENDQ3LCAweEQyMEQ4NUZELCAweEE1MEFCNTZCLAogICAgICAgMHgzNUI1QThGQSwgMHg0MkIyOTg2QywgMHhEQkJCQzlENiwgMHhBQ0JDRjk0MCwgMHgzMkQ4NkNFMywKICAgICAgIDB4NDVERjVDNzUsIDB4RENENjBEQ0YsIDB4QUJEMTNENTksIDB4MjZEOTMwQUMsIDB4NTFERTAwM0EsCiAgICAgICAweEM4RDc1MTgwLCAweEJGRDA2MTE2LCAweDIxQjRGNEI1LCAweDU2QjNDNDIzLCAweENGQkE5NTk5LAogICAgICAgMHhCOEJEQTUwRiwgMHgyODAyQjg5RSwgMHg1RjA1ODgwOCwgMHhDNjBDRDlCMiwgMHhCMTBCRTkyNCwKICAgICAgIDB4MkY2RjdDODcsIDB4NTg2ODRDMTEsIDB4QzE2MTFEQUIsIDB4QjY2NjJEM0QsIDB4NzZEQzQxOTAsCiAgICAgICAweDAxREI3MTA2LCAweDk4RDIyMEJDLCAweEVGRDUxMDJBLCAweDcxQjE4NTg5LCAweDA2QjZCNTFGLAogICAgICAgMHg5RkJGRTRBNSwgMHhFOEI4RDQzMywgMHg3ODA3QzlBMiwgMHgwRjAwRjkzNCwgMHg5NjA5QTg4RSwKICAgICAgIDB4RTEwRTk4MTgsIDB4N0Y2QTBEQkIsIDB4MDg2RDNEMkQsIDB4OTE2NDZDOTcsIDB4RTY2MzVDMDEsCiAgICAgICAweDZCNkI1MUY0LCAweDFDNkM2MTYyLCAweDg1NjUzMEQ4LCAweEYyNjIwMDRFLCAweDZDMDY5NUVELAogICAgICAgMHgxQjAxQTU3QiwgMHg4MjA4RjRDMSwgMHhGNTBGQzQ1NywgMHg2NUIwRDlDNiwgMHgxMkI3RTk1MCwKICAgICAgIDB4OEJCRUI4RUEsIDB4RkNCOTg4N0MsIDB4NjJERDFEREYsIDB4MTVEQTJENDksIDB4OENEMzdDRjMsCiAgICAgICAweEZCRDQ0QzY1LCAweDREQjI2MTU4LCAweDNBQjU1MUNFLCAweEEzQkMwMDc0LCAweEQ0QkIzMEUyLAogICAgICAgMHg0QURGQTU0MSwgMHgzREQ4OTVENywgMHhBNEQxQzQ2RCwgMHhEM0Q2RjRGQiwgMHg0MzY5RTk2QSwKICAgICAgIDB4MzQ2RUQ5RkMsIDB4QUQ2Nzg4NDYsIDB4REE2MEI4RDAsIDB4NDQwNDJENzMsIDB4MzMwMzFERTUsCiAgICAgICAweEFBMEE0QzVGLCAweEREMEQ3Q0M5LCAweDUwMDU3MTNDLCAweDI3MDI0MUFBLCAweEJFMEIxMDEwLAogICAgICAgMHhDOTBDMjA4NiwgMHg1NzY4QjUyNSwgMHgyMDZGODVCMywgMHhCOTY2RDQwOSwgMHhDRTYxRTQ5RiwKICAgICAgIDB4NUVERUY5MEUsIDB4MjlEOUM5OTgsIDB4QjBEMDk4MjIsIDB4QzdEN0E4QjQsIDB4NTlCMzNEMTcsCiAgICAgICAweDJFQjQwRDgxLCAweEI3QkQ1QzNCLCAweEMwQkE2Q0FELCAweEVEQjg4MzIwLCAweDlBQkZCM0I2LAogICAgICAgMHgwM0I2RTIwQywgMHg3NEIxRDI5QSwgMHhFQUQ1NDczOSwgMHg5REQyNzdBRiwgMHgwNERCMjYxNSwKICAgICAgIDB4NzNEQzE2ODMsIDB4RTM2MzBCMTIsIDB4OTQ2NDNCODQsIDB4MEQ2RDZBM0UsIDB4N0E2QTVBQTgsCiAgICAgICAweEU0MEVDRjBCLCAweDkzMDlGRjlELCAweDBBMDBBRTI3LCAweDdEMDc5RUIxLCAweEYwMEY5MzQ0LAogICAgICAgMHg4NzA4QTNEMiwgMHgxRTAxRjI2OCwgMHg2OTA2QzJGRSwgMHhGNzYyNTc1RCwgMHg4MDY1NjdDQiwKICAgICAgIDB4MTk2QzM2NzEsIDB4NkU2QjA2RTcsIDB4RkVENDFCNzYsIDB4ODlEMzJCRTAsIDB4MTBEQTdBNUEsCiAgICAgICAweDY3REQ0QUNDLCAweEY5QjlERjZGLCAweDhFQkVFRkY5LCAweDE3QjdCRTQzLCAweDYwQjA4RUQ1LAogICAgICAgMHhENkQ2QTNFOCwgMHhBMUQxOTM3RSwgMHgzOEQ4QzJDNCwgMHg0RkRGRjI1MiwgMHhEMUJCNjdGMSwKICAgICAgIDB4QTZCQzU3NjcsIDB4M0ZCNTA2REQsIDB4NDhCMjM2NEIsIDB4RDgwRDJCREEsIDB4QUYwQTFCNEMsCiAgICAgICAweDM2MDM0QUY2LCAweDQxMDQ3QTYwLCAweERGNjBFRkMzLCAweEE4NjdERjU1LCAweDMxNkU4RUVGLAogICAgICAgMHg0NjY5QkU3OSwgMHhDQjYxQjM4QywgMHhCQzY2ODMxQSwgMHgyNTZGRDJBMCwgMHg1MjY4RTIzNiwKICAgICAgIDB4Q0MwQzc3OTUsIDB4QkIwQjQ3MDMsIDB4MjIwMjE2QjksIDB4NTUwNTI2MkYsIDB4QzVCQTNCQkUsCiAgICAgICAweEIyQkQwQjI4LCAweDJCQjQ1QTkyLCAweDVDQjM2QTA0LCAweEMyRDdGRkE3LCAweEI1RDBDRjMxLAogICAgICAgMHgyQ0Q5OUU4QiwgMHg1QkRFQUUxRCwgMHg5QjY0QzJCMCwgMHhFQzYzRjIyNiwgMHg3NTZBQTM5QywKICAgICAgIDB4MDI2RDkzMEEsIDB4OUMwOTA2QTksIDB4RUIwRTM2M0YsIDB4NzIwNzY3ODUsIDB4MDUwMDU3MTMsCiAgICAgICAweDk1QkY0QTgyLCAweEUyQjg3QTE0LCAweDdCQjEyQkFFLCAweDBDQjYxQjM4LCAweDkyRDI4RTlCLAogICAgICAgMHhFNUQ1QkUwRCwgMHg3Q0RDRUZCNywgMHgwQkRCREYyMSwgMHg4NkQzRDJENCwgMHhGMUQ0RTI0MiwKICAgICAgIDB4NjhEREIzRjgsIDB4MUZEQTgzNkUsIDB4ODFCRTE2Q0QsIDB4RjZCOTI2NUIsIDB4NkZCMDc3RTEsCiAgICAgICAweDE4Qjc0Nzc3LCAweDg4MDg1QUU2LCAweEZGMEY2QTcwLCAweDY2MDYzQkNBLCAweDExMDEwQjVDLAogICAgICAgMHg4RjY1OUVGRiwgMHhGODYyQUU2OSwgMHg2MTZCRkZEMywgMHgxNjZDQ0Y0NSwgMHhBMDBBRTI3OCwKICAgICAgIDB4RDcwREQyRUUsIDB4NEUwNDgzNTQsIDB4MzkwM0IzQzIsIDB4QTc2NzI2NjEsIDB4RDA2MDE2RjcsCiAgICAgICAweDQ5Njk0NzRELCAweDNFNkU3N0RCLCAweEFFRDE2QTRBLCAweEQ5RDY1QURDLCAweDQwREYwQjY2LAogICAgICAgMHgzN0Q4M0JGMCwgMHhBOUJDQUU1MywgMHhERUJCOUVDNSwgMHg0N0IyQ0Y3RiwgMHgzMEI1RkZFOSwKICAgICAgIDB4QkRCREYyMUMsIDB4Q0FCQUMyOEEsIDB4NTNCMzkzMzAsIDB4MjRCNEEzQTYsIDB4QkFEMDM2MDUsCiAgICAgICAweENERDcwNjkzLCAweDU0REU1NzI5LCAweDIzRDk2N0JGLCAweEIzNjY3QTJFLCAweEM0NjE0QUI4LAogICAgICAgMHg1RDY4MUIwMiwgMHgyQTZGMkI5NCwgMHhCNDBCQkUzNywgMHhDMzBDOEVBMSwgMHg1QTA1REYxQiwKICAgICAgIDB4MkQwMkVGOERdLAogIAogICAgICBjcmMzMjogZnVuY3Rpb24gY3JjMzIoZGF0YSkgewogICAgICAgIHZhciB0YmwgPSB1dGlsLmNyeXB0by5jcmMzMlRhYmxlOwogICAgICAgIHZhciBjcmMgPSAwIF4gLTE7CiAgCiAgICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgZGF0YSA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKGRhdGEpOwogICAgICAgIH0KICAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBjb2RlID0gZGF0YS5yZWFkVUludDgoaSk7CiAgICAgICAgICBjcmMgPSAoY3JjID4+PiA4KSBeIHRibFsoY3JjIF4gY29kZSkgJiAweEZGXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIChjcmMgXiAtMSkgPj4+IDA7CiAgICAgIH0sCiAgCiAgICAgIGhtYWM6IGZ1bmN0aW9uIGhtYWMoa2V5LCBzdHJpbmcsIGRpZ2VzdCwgZm4pIHsKICAgICAgICBpZiAoIWRpZ2VzdCkgZGlnZXN0ID0gJ2JpbmFyeSc7CiAgICAgICAgaWYgKGRpZ2VzdCA9PT0gJ2J1ZmZlcicpIHsgZGlnZXN0ID0gdW5kZWZpbmVkOyB9CiAgICAgICAgaWYgKCFmbikgZm4gPSAnc2hhMjU2JzsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHN0cmluZyA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmxpYi5jcmVhdGVIbWFjKGZuLCBrZXkpLnVwZGF0ZShzdHJpbmcpLmRpZ2VzdChkaWdlc3QpOwogICAgICB9LAogIAogICAgICBtZDU6IGZ1bmN0aW9uIG1kNShkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ21kNScsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgICB9LAogIAogICAgICBzaGEyNTY6IGZ1bmN0aW9uIHNoYTI1NihkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmhhc2goJ3NoYTI1NicsIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spOwogICAgICB9LAogIAogICAgICBoYXNoOiBmdW5jdGlvbihhbGdvcml0aG0sIGRhdGEsIGRpZ2VzdCwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgaGFzaCA9IHV0aWwuY3J5cHRvLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTsKICAgICAgICBpZiAoIWRpZ2VzdCkgeyBkaWdlc3QgPSAnYmluYXJ5JzsgfQogICAgICAgIGlmIChkaWdlc3QgPT09ICdidWZmZXInKSB7IGRpZ2VzdCA9IHVuZGVmaW5lZDsgfQogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihkYXRhKTsKICAgICAgICB2YXIgc2xpY2VGbiA9IHV0aWwuYXJyYXlTbGljZUZuKGRhdGEpOwogICAgICAgIHZhciBpc0J1ZmZlciA9IHV0aWwuQnVmZmVyLmlzQnVmZmVyKGRhdGEpOwogICAgICAgIC8vSWRlbnRpZnlpbmcgb2JqZWN0cyB3aXRoIGFuIEFycmF5QnVmZmVyIGFzIGJ1ZmZlcnMKICAgICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIGRhdGEgJiYgZGF0YS5idWZmZXIgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgaXNCdWZmZXIgPSB0cnVlOwogIAogICAgICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgdHlwZW9mIGRhdGEub24gPT09ICdmdW5jdGlvbicgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgICBkYXRhLm9uKCdkYXRhJywgZnVuY3Rpb24oY2h1bmspIHsgaGFzaC51cGRhdGUoY2h1bmspOyB9KTsKICAgICAgICAgIGRhdGEub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7IGNhbGxiYWNrKGVycik7IH0pOwogICAgICAgICAgZGF0YS5vbignZW5kJywgZnVuY3Rpb24oKSB7IGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOyB9KTsKICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrICYmIHNsaWNlRm4gJiYgIWlzQnVmZmVyICYmCiAgICAgICAgICAgICAgICAgICB0eXBlb2YgRmlsZVJlYWRlciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIC8vIHRoaXMgbWlnaHQgYmUgYSBGaWxlL0Jsb2IKICAgICAgICAgIHZhciBpbmRleCA9IDAsIHNpemUgPSAxMDI0ICogNTEyOwogICAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgICByZWFkZXIub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZWFkIGRhdGEuJykpOwogICAgICAgICAgfTsKICAgICAgICAgIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGJ1ZiA9IG5ldyB1dGlsLkJ1ZmZlcihuZXcgVWludDhBcnJheShyZWFkZXIucmVzdWx0KSk7CiAgICAgICAgICAgIGhhc2gudXBkYXRlKGJ1Zik7CiAgICAgICAgICAgIGluZGV4ICs9IGJ1Zi5sZW5ndGg7CiAgICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nKCk7CiAgICAgICAgICB9OwogICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGluZGV4ID49IGRhdGEuc2l6ZSkgewogICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICB2YXIgYmFjayA9IGluZGV4ICsgc2l6ZTsKICAgICAgICAgICAgaWYgKGJhY2sgPiBkYXRhLnNpemUpIGJhY2sgPSBkYXRhLnNpemU7CiAgICAgICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihzbGljZUZuLmNhbGwoZGF0YSwgaW5kZXgsIGJhY2spKTsKICAgICAgICAgIH07CiAgCiAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYgIWlzQnVmZmVyKSB7CiAgICAgICAgICAgIGRhdGEgPSBuZXcgdXRpbC5CdWZmZXIobmV3IFVpbnQ4QXJyYXkoZGF0YSkpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG91dCA9IGhhc2gudXBkYXRlKGRhdGEpLmRpZ2VzdChkaWdlc3QpOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsLCBvdXQpOwogICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHRvSGV4OiBmdW5jdGlvbiB0b0hleChkYXRhKSB7CiAgICAgICAgdmFyIG91dCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewogICAgICAgICAgb3V0LnB1c2goKCcwJyArIGRhdGEuY2hhckNvZGVBdChpKS50b1N0cmluZygxNikpLnN1YnN0cigtMiwgMikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0LmpvaW4oJycpOwogICAgICB9LAogIAogICAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZ29yaXRobSkgewogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5saWIuY3JlYXRlSGFzaChhbGdvcml0aG0pOwogICAgICB9CiAgCiAgICB9LAogIAogICAgLyoqIEAhaWdub3JlICovCiAgCiAgICAvKiBBYm9ydCBjb25zdGFudCAqLwogICAgYWJvcnQ6IHt9LAogIAogICAgZWFjaDogZnVuY3Rpb24gZWFjaChvYmplY3QsIGl0ZXJGdW5jdGlvbikgewogICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHsKICAgICAgICAgIHZhciByZXQgPSBpdGVyRnVuY3Rpb24uY2FsbCh0aGlzLCBrZXksIG9iamVjdFtrZXldKTsKICAgICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIGFycmF5RWFjaDogZnVuY3Rpb24gYXJyYXlFYWNoKGFycmF5LCBpdGVyRnVuY3Rpb24pIHsKICAgICAgZm9yICh2YXIgaWR4IGluIGFycmF5KSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChhcnJheSwgaWR4KSkgewogICAgICAgICAgdmFyIHJldCA9IGl0ZXJGdW5jdGlvbi5jYWxsKHRoaXMsIGFycmF5W2lkeF0sIHBhcnNlSW50KGlkeCwgMTApKTsKICAgICAgICAgIGlmIChyZXQgPT09IHV0aWwuYWJvcnQpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9iajEsIG9iajIpIHsKICAgICAgdXRpbC5lYWNoKG9iajIsIGZ1bmN0aW9uIGl0ZXJhdG9yKGtleSwgaXRlbSkgewogICAgICAgIG9iajFba2V5XSA9IGl0ZW07CiAgICAgIH0pOwogICAgICByZXR1cm4gb2JqMTsKICAgIH0sCiAgCiAgICBtZXJnZTogZnVuY3Rpb24gbWVyZ2Uob2JqMSwgb2JqMikgewogICAgICByZXR1cm4gdXRpbC51cGRhdGUodXRpbC5jb3B5KG9iajEpLCBvYmoyKTsKICAgIH0sCiAgCiAgICBjb3B5OiBmdW5jdGlvbiBjb3B5KG9iamVjdCkgewogICAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IG9iamVjdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gb2JqZWN0OwogICAgICB2YXIgZHVwZSA9IHt9OwogICAgICAvLyBqc2hpbnQgZm9yaW46ZmFsc2UKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgIGR1cGVba2V5XSA9IG9iamVjdFtrZXldOwogICAgICB9CiAgICAgIHJldHVybiBkdXBlOwogICAgfSwKICAKICAgIGlzRW1wdHk6IGZ1bmN0aW9uIGlzRW1wdHkob2JqKSB7CiAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAKICAgIGFycmF5U2xpY2VGbjogZnVuY3Rpb24gYXJyYXlTbGljZUZuKG9iaikgewogICAgICB2YXIgZm4gPSBvYmouc2xpY2UgfHwgb2JqLndlYmtpdFNsaWNlIHx8IG9iai5tb3pTbGljZTsKICAgICAgcmV0dXJuIHR5cGVvZiBmbiA9PT0gJ2Z1bmN0aW9uJyA/IGZuIDogbnVsbDsKICAgIH0sCiAgCiAgICBpc1R5cGU6IGZ1bmN0aW9uIGlzVHlwZShvYmosIHR5cGUpIHsKICAgICAgLy8gaGFuZGxlIGNyb3NzLSJmcmFtZSIgb2JqZWN0cwogICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicpIHR5cGUgPSB1dGlsLnR5cGVOYW1lKHR5cGUpOwogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyB0eXBlICsgJ10nOwogICAgfSwKICAKICAgIHR5cGVOYW1lOiBmdW5jdGlvbiB0eXBlTmFtZSh0eXBlKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodHlwZSwgJ25hbWUnKSkgcmV0dXJuIHR5cGUubmFtZTsKICAgICAgdmFyIHN0ciA9IHR5cGUudG9TdHJpbmcoKTsKICAgICAgdmFyIG1hdGNoID0gc3RyLm1hdGNoKC9eXHMqZnVuY3Rpb24gKC4rKVwoLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogc3RyOwogICAgfSwKICAKICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihlcnIsIG9wdGlvbnMpIHsKICAgICAgdmFyIG9yaWdpbmFsRXJyb3IgPSBudWxsOwogICAgICBpZiAodHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJyAmJiBlcnIubWVzc2FnZSAhPT0gJycpIHsKICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnIHx8IChvcHRpb25zICYmIG9wdGlvbnMubWVzc2FnZSkpIHsKICAgICAgICAgIG9yaWdpbmFsRXJyb3IgPSB1dGlsLmNvcHkoZXJyKTsKICAgICAgICAgIG9yaWdpbmFsRXJyb3IubWVzc2FnZSA9IGVyci5tZXNzYWdlOwogICAgICAgIH0KICAgICAgfQogICAgICBlcnIubWVzc2FnZSA9IGVyci5tZXNzYWdlIHx8IG51bGw7CiAgCiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnM7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmIG9wdGlvbnMgIT09IG51bGwpIHsKICAgICAgICB1dGlsLnVwZGF0ZShlcnIsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UpCiAgICAgICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnMubWVzc2FnZTsKICAgICAgICBpZiAob3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZSkKICAgICAgICAgIGVyci5jb2RlID0gb3B0aW9ucy5jb2RlIHx8IG9wdGlvbnMubmFtZTsKICAgICAgICBpZiAob3B0aW9ucy5zdGFjaykKICAgICAgICAgIGVyci5zdGFjayA9IG9wdGlvbnMuc3RhY2s7CiAgICAgIH0KICAKICAgICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbmFtZScsIHt3cml0YWJsZTogdHJ1ZSwgZW51bWVyYWJsZTogZmFsc2V9KTsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbWVzc2FnZScsIHtlbnVtZXJhYmxlOiB0cnVlfSk7CiAgICAgIH0KICAKICAgICAgZXJyLm5hbWUgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZSB8fCBlcnIubmFtZSB8fCBlcnIuY29kZSB8fCAnRXJyb3InOwogICAgICBlcnIudGltZSA9IG5ldyBEYXRlKCk7CiAgCiAgICAgIGlmIChvcmlnaW5hbEVycm9yKSBlcnIub3JpZ2luYWxFcnJvciA9IG9yaWdpbmFsRXJyb3I7CiAgCiAgICAgIHJldHVybiBlcnI7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaW5oZXJpdDogZnVuY3Rpb24gaW5oZXJpdChrbGFzcywgZmVhdHVyZXMpIHsKICAgICAgdmFyIG5ld09iamVjdCA9IG51bGw7CiAgICAgIGlmIChmZWF0dXJlcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgZmVhdHVyZXMgPSBrbGFzczsKICAgICAgICBrbGFzcyA9IE9iamVjdDsKICAgICAgICBuZXdPYmplY3QgPSB7fTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgY3RvciA9IGZ1bmN0aW9uIENvbnN0cnVjdG9yV3JhcHBlcigpIHt9OwogICAgICAgIGN0b3IucHJvdG90eXBlID0ga2xhc3MucHJvdG90eXBlOwogICAgICAgIG5ld09iamVjdCA9IG5ldyBjdG9yKCk7CiAgICAgIH0KICAKICAgICAgLy8gY29uc3RydWN0b3Igbm90IHN1cHBsaWVkLCBjcmVhdGUgcGFzcy10aHJvdWdoIGN0b3IKICAgICAgaWYgKGZlYXR1cmVzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICBmZWF0dXJlcy5jb25zdHJ1Y3RvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKGtsYXNzICE9PSBPYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIGtsYXNzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogIAogICAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBuZXdPYmplY3Q7CiAgICAgIHV0aWwudXBkYXRlKGZlYXR1cmVzLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgZmVhdHVyZXMpOwogICAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5fX3N1cGVyX18gPSBrbGFzczsKICAgICAgcmV0dXJuIGZlYXR1cmVzLmNvbnN0cnVjdG9yOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG1peGluOiBmdW5jdGlvbiBtaXhpbigpIHsKICAgICAgdmFyIGtsYXNzID0gYXJndW1lbnRzWzBdOwogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIC8vIGpzaGludCBmb3JpbjpmYWxzZQogICAgICAgIGZvciAodmFyIHByb3AgaW4gYXJndW1lbnRzW2ldLnByb3RvdHlwZSkgewogICAgICAgICAgdmFyIGZuID0gYXJndW1lbnRzW2ldLnByb3RvdHlwZVtwcm9wXTsKICAgICAgICAgIGlmIChwcm9wICE9PSAnY29uc3RydWN0b3InKSB7CiAgICAgICAgICAgIGtsYXNzLnByb3RvdHlwZVtwcm9wXSA9IGZuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4ga2xhc3M7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGlkZVByb3BlcnRpZXM6IGZ1bmN0aW9uIGhpZGVQcm9wZXJ0aWVzKG9iaiwgcHJvcHMpIHsKICAgICAgaWYgKHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgIT09ICdmdW5jdGlvbicpIHJldHVybjsKICAKICAgICAgdXRpbC5hcnJheUVhY2gocHJvcHMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBwcm9wZXJ0eTogZnVuY3Rpb24gcHJvcGVydHkob2JqLCBuYW1lLCB2YWx1ZSwgZW51bWVyYWJsZSwgaXNWYWx1ZSkgewogICAgICB2YXIgb3B0cyA9IHsKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSAhPT0gdW5kZWZpbmVkID8gZW51bWVyYWJsZSA6IHRydWUKICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiAhaXNWYWx1ZSkgewogICAgICAgIG9wdHMuZ2V0ID0gdmFsdWU7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgb3B0cy52YWx1ZSA9IHZhbHVlOyBvcHRzLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgfQogIAogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBuYW1lLCBvcHRzKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBtZW1vaXplZFByb3BlcnR5OiBmdW5jdGlvbiBtZW1vaXplZFByb3BlcnR5KG9iaiwgbmFtZSwgZ2V0LCBlbnVtZXJhYmxlKSB7CiAgICAgIHZhciBjYWNoZWRWYWx1ZSA9IG51bGw7CiAgCiAgICAgIC8vIGJ1aWxkIGVudW1lcmFibGUgYXR0cmlidXRlIGZvciBlYWNoIHZhbHVlIHdpdGggbGF6eSBhY2Nlc3Nvci4KICAgICAgdXRpbC5wcm9wZXJ0eShvYmosIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChjYWNoZWRWYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgY2FjaGVkVmFsdWUgPSBnZXQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNhY2hlZFZhbHVlOwogICAgICB9LCBlbnVtZXJhYmxlKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFRPRE8gUmVtb3ZlIGluIG1ham9yIHZlcnNpb24gcmV2aXNpb24KICAgICAqIFRoaXMgYmFja2ZpbGwgcG9wdWxhdGVzIHJlc3BvbnNlIGRhdGEgd2l0aG91dCB0aGUKICAgICAqIHRvcC1sZXZlbCBwYXlsb2FkIG5hbWUuCiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhvaXN0UGF5bG9hZE1lbWJlcjogZnVuY3Rpb24gaG9pc3RQYXlsb2FkTWVtYmVyKHJlc3ApIHsKICAgICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbk5hbWUgPSByZXEub3BlcmF0aW9uOwogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uTmFtZV07CiAgICAgIHZhciBvdXRwdXQgPSBvcGVyYXRpb24ub3V0cHV0OwogICAgICBpZiAob3V0cHV0LnBheWxvYWQgJiYgIW9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCkgewogICAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gb3V0cHV0Lm1lbWJlcnNbb3V0cHV0LnBheWxvYWRdOwogICAgICAgIHZhciByZXNwb25zZVBheWxvYWQgPSByZXNwLmRhdGFbb3V0cHV0LnBheWxvYWRdOwogICAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgICB1dGlsLmVhY2gocmVzcG9uc2VQYXlsb2FkLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHV0aWwucHJvcGVydHkocmVzcC5kYXRhLCBrZXksIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENvbXB1dGUgU0hBLTI1NiBjaGVja3N1bXMgb2Ygc3RyZWFtcwogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjb21wdXRlU2hhMjU2OiBmdW5jdGlvbiBjb21wdXRlU2hhMjU2KGJvZHksIGRvbmUpIHsKICAgICAgaWYgKHV0aWwuaXNOb2RlKCkpIHsKICAgICAgICB2YXIgU3RyZWFtID0gdXRpbC5zdHJlYW0uU3RyZWFtOwogICAgICAgIHZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7CiAgICAgICAgaWYgKHR5cGVvZiBTdHJlYW0gPT09ICdmdW5jdGlvbicgJiYgYm9keSBpbnN0YW5jZW9mIFN0cmVhbSkgewogICAgICAgICAgaWYgKHR5cGVvZiBib2R5LnBhdGggPT09ICdzdHJpbmcnKSB7IC8vIGFzc3VtZSBmaWxlIG9iamVjdAogICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSB7fTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBib2R5LnN0YXJ0ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHNldHRpbmdzLnN0YXJ0ID0gYm9keS5zdGFydDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGJvZHkuZW5kID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHNldHRpbmdzLmVuZCA9IGJvZHkuZW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGJvZHkucGF0aCwgc2V0dGluZ3MpOwogICAgICAgICAgfSBlbHNlIHsgLy8gVE9ETyBzdXBwb3J0IG90aGVyIHN0cmVhbSB0eXBlcwogICAgICAgICAgICByZXR1cm4gZG9uZShuZXcgRXJyb3IoJ05vbi1maWxlIHN0cmVhbSBvYmplY3RzIGFyZSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdub3Qgc3VwcG9ydGVkIHdpdGggU2lnVjQnKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHV0aWwuY3J5cHRvLnNoYTI1Nihib2R5LCAnaGV4JywgZnVuY3Rpb24oZXJyLCBzaGEpIHsKICAgICAgICBpZiAoZXJyKSBkb25lKGVycik7CiAgICAgICAgZWxzZSBkb25lKG51bGwsIHNoYSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGlzQ2xvY2tTa2V3ZWQ6IGZ1bmN0aW9uIGlzQ2xvY2tTa2V3ZWQoc2VydmVyVGltZSkgewogICAgICBpZiAoc2VydmVyVGltZSkgewogICAgICAgIHV0aWwucHJvcGVydHkoQVdTLmNvbmZpZywgJ2lzQ2xvY2tTa2V3ZWQnLAogICAgICAgICAgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSBzZXJ2ZXJUaW1lKSA+PSAzMDAwMDAsIGZhbHNlKTsKICAgICAgICByZXR1cm4gQVdTLmNvbmZpZy5pc0Nsb2NrU2tld2VkOwogICAgICB9CiAgICB9LAogIAogICAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChzZXJ2ZXJUaW1lKSB7CiAgICAgIGlmIChzZXJ2ZXJUaW1lKQogICAgICAgIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQgPSBzZXJ2ZXJUaW1lIC0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXh0cmFjdFJlcXVlc3RJZDogZnVuY3Rpb24gZXh0cmFjdFJlcXVlc3RJZChyZXNwKSB7CiAgICAgIHZhciByZXF1ZXN0SWQgPSByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ10gfHwKICAgICAgICAgICAgICAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ107CiAgCiAgICAgIGlmICghcmVxdWVzdElkICYmIHJlc3AuZGF0YSAmJiByZXNwLmRhdGEuUmVzcG9uc2VNZXRhZGF0YSkgewogICAgICAgIHJlcXVlc3RJZCA9IHJlc3AuZGF0YS5SZXNwb25zZU1ldGFkYXRhLlJlcXVlc3RJZDsKICAgICAgfQogIAogICAgICBpZiAocmVxdWVzdElkKSB7CiAgICAgICAgcmVzcC5yZXF1ZXN0SWQgPSByZXF1ZXN0SWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICByZXNwLmVycm9yLnJlcXVlc3RJZCA9IHJlcXVlc3RJZDsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZFByb21pc2VzOiBmdW5jdGlvbiBhZGRQcm9taXNlcyhjb25zdHJ1Y3RvcnMsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICAgIHZhciBkZWxldGVQcm9taXNlcyA9IGZhbHNlOwogICAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiBBV1MgJiYgQVdTLmNvbmZpZykgewogICAgICAgIFByb21pc2VEZXBlbmRlbmN5ID0gQVdTLmNvbmZpZy5nZXRQcm9taXNlc0RlcGVuZGVuY3koKTsKICAgICAgfQogICAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICBQcm9taXNlRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBQcm9taXNlRGVwZW5kZW5jeSAhPT0gJ2Z1bmN0aW9uJykgZGVsZXRlUHJvbWlzZXMgPSB0cnVlOwogICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY29uc3RydWN0b3JzKSkgY29uc3RydWN0b3JzID0gW2NvbnN0cnVjdG9yc107CiAgCiAgICAgIGZvciAodmFyIGluZCA9IDA7IGluZCA8IGNvbnN0cnVjdG9ycy5sZW5ndGg7IGluZCsrKSB7CiAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gY29uc3RydWN0b3JzW2luZF07CiAgICAgICAgaWYgKGRlbGV0ZVByb21pc2VzKSB7CiAgICAgICAgICBpZiAoY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MpIHsKICAgICAgICAgICAgY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNvbnN0cnVjdG9yLmFkZFByb21pc2VzVG9DbGFzcykgewogICAgICAgICAgY29uc3RydWN0b3IuYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogUmV0dXJuIGEgZnVuY3Rpb24gdGhhdCB3aWxsIHJldHVybiBhIHByb21pc2Ugd2hvc2UgZmF0ZSBpcyBkZWNpZGVkIGJ5IHRoZQogICAgICogY2FsbGJhY2sgYmVoYXZpb3Igb2YgdGhlIGdpdmVuIG1ldGhvZCB3aXRoIGBtZXRob2ROYW1lYC4gVGhlIG1ldGhvZCB0byBiZQogICAgICogcHJvbWlzaWZpZWQgc2hvdWxkIGNvbmZvcm0gdG8gbm9kZS5qcyBjb252ZW50aW9uIG9mIGFjY2VwdGluZyBhIGNhbGxiYWNrIGFzCiAgICAgKiBsYXN0IGFyZ3VtZW50IGFuZCBjYWxsaW5nIHRoYXQgY2FsbGJhY2sgd2l0aCBlcnJvciBhcyB0aGUgZmlyc3QgYXJndW1lbnQKICAgICAqIGFuZCBzdWNjZXNzIHZhbHVlIG9uIHRoZSBzZWNvbmQgYXJndW1lbnQuCiAgICAgKi8KICAgIHByb21pc2lmeU1ldGhvZDogZnVuY3Rpb24gcHJvbWlzaWZ5TWV0aG9kKG1ldGhvZE5hbWUsIFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBwcm9taXNlKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlRGVwZW5kZW5jeShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGFyZ3MucHVzaChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZlttZXRob2ROYW1lXS5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc0R1YWxzdGFja0F2YWlsYWJsZTogZnVuY3Rpb24gaXNEdWFsc3RhY2tBdmFpbGFibGUoc2VydmljZSkgewogICAgICBpZiAoIXNlcnZpY2UpIHJldHVybiBmYWxzZTsKICAgICAgdmFyIG1ldGFkYXRhID0gcmVxdWlyZSgnLi4vYXBpcy9tZXRhZGF0YS5qc29uJyk7CiAgICAgIGlmICh0eXBlb2Ygc2VydmljZSAhPT0gJ3N0cmluZycpIHNlcnZpY2UgPSBzZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyOwogICAgICBpZiAodHlwZW9mIHNlcnZpY2UgIT09ICdzdHJpbmcnIHx8ICFtZXRhZGF0YS5oYXNPd25Qcm9wZXJ0eShzZXJ2aWNlKSkgcmV0dXJuIGZhbHNlOwogICAgICByZXR1cm4gISFtZXRhZGF0YVtzZXJ2aWNlXS5kdWFsc3RhY2tBdmFpbGFibGU7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FsY3VsYXRlUmV0cnlEZWxheTogZnVuY3Rpb24gY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCByZXRyeURlbGF5T3B0aW9ucykgewogICAgICBpZiAoIXJldHJ5RGVsYXlPcHRpb25zKSByZXRyeURlbGF5T3B0aW9ucyA9IHt9OwogICAgICB2YXIgY3VzdG9tQmFja29mZiA9IHJldHJ5RGVsYXlPcHRpb25zLmN1c3RvbUJhY2tvZmYgfHwgbnVsbDsKICAgICAgaWYgKHR5cGVvZiBjdXN0b21CYWNrb2ZmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGN1c3RvbUJhY2tvZmYocmV0cnlDb3VudCk7CiAgICAgIH0KICAgICAgdmFyIGJhc2UgPSB0eXBlb2YgcmV0cnlEZWxheU9wdGlvbnMuYmFzZSA9PT0gJ251bWJlcicgPyByZXRyeURlbGF5T3B0aW9ucy5iYXNlIDogMTAwOwogICAgICB2YXIgZGVsYXkgPSBNYXRoLnJhbmRvbSgpICogKE1hdGgucG93KDIsIHJldHJ5Q291bnQpICogYmFzZSk7CiAgICAgIHJldHVybiBkZWxheTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoYW5kbGVSZXF1ZXN0V2l0aFJldHJpZXM6IGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3RXaXRoUmV0cmllcyhodHRwUmVxdWVzdCwgb3B0aW9ucywgY2IpIHsKICAgICAgaWYgKCFvcHRpb25zKSBvcHRpb25zID0ge307CiAgICAgIHZhciBodHRwID0gQVdTLkh0dHBDbGllbnQuZ2V0SW5zdGFuY2UoKTsKICAgICAgdmFyIGh0dHBPcHRpb25zID0gb3B0aW9ucy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIHJldHJ5Q291bnQgPSAwOwogIAogICAgICB2YXIgZXJyQ2FsbGJhY2sgPSBmdW5jdGlvbihlcnIpIHsKICAgICAgICB2YXIgbWF4UmV0cmllcyA9IG9wdGlvbnMubWF4UmV0cmllcyB8fCAwOwogICAgICAgIGlmIChlcnIgJiYgZXJyLmNvZGUgPT09ICdUaW1lb3V0RXJyb3InKSBlcnIucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICBpZiAoZXJyICYmIGVyci5yZXRyeWFibGUgJiYgcmV0cnlDb3VudCA8IG1heFJldHJpZXMpIHsKICAgICAgICAgIHJldHJ5Q291bnQrKzsKICAgICAgICAgIHZhciBkZWxheSA9IHV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCBvcHRpb25zLnJldHJ5RGVsYXlPcHRpb25zKTsKICAgICAgICAgIHNldFRpbWVvdXQoc2VuZFJlcXVlc3QsIGRlbGF5ICsgKGVyci5yZXRyeUFmdGVyIHx8IDApKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2IoZXJyKTsKICAgICAgICB9CiAgICAgIH07CiAgCiAgICAgIHZhciBzZW5kUmVxdWVzdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkYXRhID0gJyc7CiAgICAgICAgaHR0cC5oYW5kbGVSZXF1ZXN0KGh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywgZnVuY3Rpb24oaHR0cFJlc3BvbnNlKSB7CiAgICAgICAgICBodHRwUmVzcG9uc2Uub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgeyBkYXRhICs9IGNodW5rLnRvU3RyaW5nKCk7IH0pOwogICAgICAgICAgaHR0cFJlc3BvbnNlLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgICAgICAgICBjYihudWxsLCBkYXRhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmV0cnlBZnRlciA9IHBhcnNlSW50KGh0dHBSZXNwb25zZS5oZWFkZXJzWydyZXRyeS1hZnRlciddLCAxMCkgKiAxMDAwIHx8IDA7CiAgICAgICAgICAgICAgdmFyIGVyciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgICAgICB7IHJldHJ5YWJsZTogc3RhdHVzQ29kZSA+PSA1MDAgfHwgc3RhdHVzQ29kZSA9PT0gNDI5IH0KICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGlmIChyZXRyeUFmdGVyICYmIGVyci5yZXRyeWFibGUpIGVyci5yZXRyeUFmdGVyID0gcmV0cnlBZnRlcjsKICAgICAgICAgICAgICBlcnJDYWxsYmFjayhlcnIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LCBlcnJDYWxsYmFjayk7CiAgICAgIH07CiAgCiAgICAgIEFXUy51dGlsLmRlZmVyKHNlbmRSZXF1ZXN0KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB1dWlkOiB7CiAgICAgIHY0OiBmdW5jdGlvbiB1dWlkVjQoKSB7CiAgICAgICAgcmV0dXJuIHJlcXVpcmUoJ3V1aWQnKS52NCgpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29udmVydFBheWxvYWRUb1N0cmluZzogZnVuY3Rpb24gY29udmVydFBheWxvYWRUb1N0cmluZyhyZXNwKSB7CiAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXEub3BlcmF0aW9uOwogICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICAgICAgaWYgKHJ1bGVzLnBheWxvYWQgJiYgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdKSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdLnRvU3RyaW5nKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZlcjogZnVuY3Rpb24gZGVmZXIoY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwcm9jZXNzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2FsbGJhY2spOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBzZXRJbW1lZGlhdGUoY2FsbGJhY2spOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFRpbWVvdXQoY2FsbGJhY2ssIDApOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0UmVxdWVzdFBheWxvYWRTaGFwZTogZnVuY3Rpb24gZ2V0UmVxdWVzdFBheWxvYWRTaGFwZShyZXEpIHsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uczsKICAgICAgaWYgKCFvcGVyYXRpb25zKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICB2YXIgb3BlcmF0aW9uID0gKG9wZXJhdGlvbnMgfHwge30pW3JlcS5vcGVyYXRpb25dOwogICAgICBpZiAoIW9wZXJhdGlvbiB8fCAhb3BlcmF0aW9uLmlucHV0IHx8ICFvcGVyYXRpb24uaW5wdXQucGF5bG9hZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcmV0dXJuIG9wZXJhdGlvbi5pbnB1dC5tZW1iZXJzW29wZXJhdGlvbi5pbnB1dC5wYXlsb2FkXTsKICAgIH0sCiAgCiAgICBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWc6IGZ1bmN0aW9uIGdldFByb2ZpbGVzRnJvbVNoYXJlZENvbmZpZyhpbmlMb2FkZXIsIGZpbGVuYW1lKSB7CiAgICAgIHZhciBwcm9maWxlcyA9IHt9OwogICAgICB2YXIgcHJvZmlsZXNGcm9tQ29uZmlnID0ge307CiAgICAgIGlmIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSkgewogICAgICAgIHZhciBwcm9maWxlc0Zyb21Db25maWcgPSBpbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgICAgaXNDb25maWc6IHRydWUsCiAgICAgICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDb25maWdGaWxlRW52XQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHZhciBwcm9maWxlc0Zyb21DcmVkcyA9IGluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lIHx8CiAgICAgICAgICAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0gJiYgcHJvY2Vzcy5lbnZbdXRpbC5zaGFyZWRDcmVkZW50aWFsc0ZpbGVFbnZdKQogICAgICB9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNvbmZpZyk7IGkgPCBwcm9maWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dID0gcHJvZmlsZXNGcm9tQ29uZmlnW3Byb2ZpbGVOYW1lc1tpXV07CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNyZWRzKTsgaSA8IHByb2ZpbGVOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gPSBwcm9maWxlc0Zyb21DcmVkc1twcm9maWxlTmFtZXNbaV1dOwogICAgICB9CiAgICAgIHJldHVybiBwcm9maWxlczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBkZWZhdWx0UHJvZmlsZTogJ2RlZmF1bHQnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uZmlnT3B0SW5FbnY6ICdBV1NfU0RLX0xPQURfQ09ORklHJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNoYXJlZENyZWRlbnRpYWxzRmlsZUVudjogJ0FXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRScsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzaGFyZWRDb25maWdGaWxlRW52OiAnQVdTX0NPTkZJR19GSUxFJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGltZHNEaXNhYmxlZEVudjogJ0FXU19FQzJfTUVUQURBVEFfRElTQUJMRUQnCiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHV0aWw7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpLHJlcXVpcmUoInRpbWVycyIpLnNldEltbWVkaWF0ZSkKICB9LHsiLi4vYXBpcy9tZXRhZGF0YS5qc29uIjo0LCIuL2NvcmUiOjE4LCJfcHJvY2VzcyI6ODYsImZzIjo3OSwidGltZXJzIjo5MywidXVpZCI6OTh9XSw3MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi4vbW9kZWwvc2hhcGUnKTsKICAKICBmdW5jdGlvbiBEb21YbWxQYXJzZXIoKSB7IH0KICAKICBEb21YbWxQYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24oeG1sLCBzaGFwZSkgewogICAgaWYgKHhtbC5yZXBsYWNlKC9eXHMrLywgJycpID09PSAnJykgcmV0dXJuIHt9OwogIAogICAgdmFyIHJlc3VsdCwgZXJyb3I7CiAgICB0cnkgewogICAgICBpZiAod2luZG93LkRPTVBhcnNlcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgICAgcmVzdWx0ID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh4bWwsICd0ZXh0L3htbCcpOwogICAgICAgIH0gY2F0Y2ggKHN5bnRheEVycm9yKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3I6IHN5bnRheEVycm9yLAogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICBpZiAocmVzdWx0LmRvY3VtZW50RWxlbWVudCA9PT0gbnVsbCkgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSBlbXB0eSBkb2N1bWVudC4nKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAKICAgICAgICB2YXIgaXNFcnJvciA9IHJlc3VsdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgncGFyc2VyZXJyb3InKVswXTsKICAgICAgICBpZiAoaXNFcnJvciAmJiAoaXNFcnJvci5wYXJlbnROb2RlID09PSByZXN1bHQgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLm5vZGVOYW1lID09PSAnYm9keScgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLnBhcmVudE5vZGUgPT09IHJlc3VsdCB8fAogICAgICAgICAgICBpc0Vycm9yLnBhcmVudE5vZGUucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ2JvZHknKSkgewogICAgICAgICAgdmFyIGVycm9yRWxlbWVudCA9IGlzRXJyb3IuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2RpdicpWzBdIHx8IGlzRXJyb3I7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcihlcnJvckVsZW1lbnQudGV4dENvbnRlbnQgfHwgJ1BhcnNlciBlcnJvciBpbiBkb2N1bWVudCcpLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgICByZXRyeWFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MRE9NJyk7CiAgICAgICAgcmVzdWx0LmFzeW5jID0gZmFsc2U7CiAgCiAgICAgICAgaWYgKCFyZXN1bHQubG9hZFhNTCh4bWwpKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBsb2FkIFhNTCBwYXJzZXInKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBlcnJvciA9IGU7CiAgICB9CiAgCiAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5kb2N1bWVudEVsZW1lbnQgJiYgIWVycm9yKSB7CiAgICAgIHZhciBkYXRhID0gcGFyc2VYbWwocmVzdWx0LmRvY3VtZW50RWxlbWVudCwgc2hhcGUpOwogICAgICB2YXIgbWV0YWRhdGEgPSBnZXRFbGVtZW50QnlUYWdOYW1lKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQsICdSZXNwb25zZU1ldGFkYXRhJyk7CiAgICAgIGlmIChtZXRhZGF0YSkgewogICAgICAgIGRhdGEuUmVzcG9uc2VNZXRhZGF0YSA9IHBhcnNlWG1sKG1ldGFkYXRhLCB7fSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9IGVsc2UgaWYgKGVycm9yKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIHtjb2RlOiAnWE1MUGFyc2VyRXJyb3InLCByZXRyeWFibGU6IHRydWV9KTsKICAgIH0gZWxzZSB7IC8vIGVtcHR5IHhtbCBkb2N1bWVudAogICAgICByZXR1cm4ge307CiAgICB9CiAgfTsKICAKICBmdW5jdGlvbiBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgdGFnKSB7CiAgICB2YXIgZWxlbWVudHMgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgIGlmIChlbGVtZW50c1tpXS5wYXJlbnROb2RlID09PSB4bWwpIHsKICAgICAgICByZXR1cm4gZWxlbWVudHNbaV07CiAgICAgIH0KICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VYbWwoeG1sLCBzaGFwZSkgewogICAgaWYgKCFzaGFwZSkgc2hhcGUgPSB7fTsKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgJ21hcCc6IHJldHVybiBwYXJzZU1hcCh4bWwsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiBwYXJzZUxpc3QoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgdW5kZWZpbmVkOiBjYXNlIG51bGw6IHJldHVybiBwYXJzZVVua25vd24oeG1sKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHBhcnNlU2NhbGFyKHhtbCwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgaWYgKHhtbCA9PT0gbnVsbCkgcmV0dXJuIGRhdGE7CiAgCiAgICB1dGlsLmVhY2goc2hhcGUubWVtYmVycywgZnVuY3Rpb24obWVtYmVyTmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgICAgaWYgKG1lbWJlclNoYXBlLmlzWG1sQXR0cmlidXRlKSB7CiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh4bWwuYXR0cmlidXRlcywgbWVtYmVyU2hhcGUubmFtZSkpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHhtbC5hdHRyaWJ1dGVzW21lbWJlclNoYXBlLm5hbWVdLnZhbHVlOwogICAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IHBhcnNlWG1sKHt0ZXh0Q29udGVudDogdmFsdWV9LCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciB4bWxDaGlsZCA9IG1lbWJlclNoYXBlLmZsYXR0ZW5lZCA/IHhtbCA6CiAgICAgICAgICBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgbWVtYmVyU2hhcGUubmFtZSk7CiAgICAgICAgaWYgKHhtbENoaWxkKSB7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gcGFyc2VYbWwoeG1sQ2hpbGQsIG1lbWJlclNoYXBlKTsKICAgICAgICB9IGVsc2UgaWYgKCFtZW1iZXJTaGFwZS5mbGF0dGVuZWQgJiYgbWVtYmVyU2hhcGUudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gbWVtYmVyU2hhcGUuZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VNYXAoeG1sLCBzaGFwZSkgewogICAgdmFyIGRhdGEgPSB7fTsKICAgIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICAgIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKICAgIHZhciB0YWdOYW1lID0gc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeSc7CiAgCiAgICB2YXIgY2hpbGQgPSB4bWwuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgaWYgKGNoaWxkLm5vZGVOYW1lID09PSB0YWdOYW1lKSB7CiAgICAgICAgdmFyIGtleSA9IGdldEVsZW1lbnRCeVRhZ05hbWUoY2hpbGQsIHhtbEtleSkudGV4dENvbnRlbnQ7CiAgICAgICAgdmFyIHZhbHVlID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShjaGlsZCwgeG1sVmFsdWUpOwogICAgICAgIGRhdGFba2V5XSA9IHBhcnNlWG1sKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VMaXN0KHhtbCwgc2hhcGUpIHsKICAgIHZhciBkYXRhID0gW107CiAgICB2YXIgdGFnTmFtZSA9IHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAoc2hhcGUubWVtYmVyLm5hbWUgfHwgJ21lbWJlcicpOwogIAogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PT0gdGFnTmFtZSkgewogICAgICAgIGRhdGEucHVzaChwYXJzZVhtbChjaGlsZCwgc2hhcGUubWVtYmVyKSk7CiAgICAgIH0KICAgICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VTY2FsYXIoeG1sLCBzaGFwZSkgewogICAgaWYgKHhtbC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgdmFyIGVuY29kaW5nID0geG1sLmdldEF0dHJpYnV0ZSgnZW5jb2RpbmcnKTsKICAgICAgaWYgKGVuY29kaW5nID09PSAnYmFzZTY0JykgewogICAgICAgIHNoYXBlID0gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogZW5jb2Rpbmd9KTsKICAgICAgfQogICAgfQogIAogICAgdmFyIHRleHQgPSB4bWwudGV4dENvbnRlbnQ7CiAgICBpZiAodGV4dCA9PT0gJycpIHRleHQgPSBudWxsOwogICAgaWYgKHR5cGVvZiBzaGFwZS50b1R5cGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIHNoYXBlLnRvVHlwZSh0ZXh0KTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0ZXh0OwogICAgfQogIH0KICAKICBmdW5jdGlvbiBwYXJzZVVua25vd24oeG1sKSB7CiAgICBpZiAoeG1sID09PSB1bmRlZmluZWQgfHwgeG1sID09PSBudWxsKSByZXR1cm4gJyc7CiAgCiAgICAvLyBlbXB0eSBvYmplY3QKICAgIGlmICgheG1sLmZpcnN0RWxlbWVudENoaWxkKSB7CiAgICAgIGlmICh4bWwucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSBudWxsKSByZXR1cm4ge307CiAgICAgIGlmICh4bWwuY2hpbGROb2Rlcy5sZW5ndGggPT09IDApIHJldHVybiAnJzsKICAgICAgZWxzZSByZXR1cm4geG1sLnRleHRDb250ZW50OwogICAgfQogIAogICAgLy8gb2JqZWN0LCBwYXJzZSBhcyBzdHJ1Y3R1cmUKICAgIHZhciBzaGFwZSA9IHt0eXBlOiAnc3RydWN0dXJlJywgbWVtYmVyczoge319OwogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIHZhciB0YWcgPSBjaGlsZC5ub2RlTmFtZTsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFwZS5tZW1iZXJzLCB0YWcpKSB7CiAgICAgICAgLy8gbXVsdGlwbGUgdGFncyBvZiB0aGUgc2FtZSBuYW1lIG1ha2VzIGl0IGEgbGlzdAogICAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXS50eXBlID0gJ2xpc3QnOwogICAgICB9IGVsc2UgewogICAgICAgIHNoYXBlLm1lbWJlcnNbdGFnXSA9IHtuYW1lOiB0YWd9OwogICAgICB9CiAgICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IERvbVhtbFBhcnNlcjsKICAKICB9LHsiLi4vbW9kZWwvc2hhcGUiOjQzLCIuLi91dGlsIjo3MX1dLDczOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgWG1sTm9kZSA9IHJlcXVpcmUoJy4veG1sLW5vZGUnKS5YbWxOb2RlOwogIHZhciBYbWxUZXh0ID0gcmVxdWlyZSgnLi94bWwtdGV4dCcpLlhtbFRleHQ7CiAgCiAgZnVuY3Rpb24gWG1sQnVpbGRlcigpIHsgfQogIAogIFhtbEJ1aWxkZXIucHJvdG90eXBlLnRvWE1MID0gZnVuY3Rpb24ocGFyYW1zLCBzaGFwZSwgcm9vdEVsZW1lbnQsIG5vRW1wdHkpIHsKICAgIHZhciB4bWwgPSBuZXcgWG1sTm9kZShyb290RWxlbWVudCk7CiAgICBhcHBseU5hbWVzcGFjZXMoeG1sLCBzaGFwZSwgdHJ1ZSk7CiAgICBzZXJpYWxpemUoeG1sLCBwYXJhbXMsIHNoYXBlKTsKICAgIHJldHVybiB4bWwuY2hpbGRyZW4ubGVuZ3RoID4gMCB8fCBub0VtcHR5ID8geG1sLnRvU3RyaW5nKCkgOiAnJzsKICB9OwogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBzaGFwZSkgewogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiBzZXJpYWxpemVTdHJ1Y3R1cmUoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdtYXAnOiByZXR1cm4gc2VyaWFsaXplTWFwKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbGlzdCc6IHJldHVybiBzZXJpYWxpemVMaXN0KHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgZGVmYXVsdDogcmV0dXJuIHNlcmlhbGl6ZVNjYWxhcih4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZVN0cnVjdHVyZSh4bWwsIHBhcmFtcywgc2hhcGUpIHsKICAgIHV0aWwuYXJyYXlFYWNoKHNoYXBlLm1lbWJlck5hbWVzLCBmdW5jdGlvbihtZW1iZXJOYW1lKSB7CiAgICAgIHZhciBtZW1iZXJTaGFwZSA9IHNoYXBlLm1lbWJlcnNbbWVtYmVyTmFtZV07CiAgICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CiAgCiAgICAgIHZhciB2YWx1ZSA9IHBhcmFtc1ttZW1iZXJOYW1lXTsKICAgICAgdmFyIG5hbWUgPSBtZW1iZXJTaGFwZS5uYW1lOwogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgICAgIGlmIChtZW1iZXJTaGFwZS5pc1htbEF0dHJpYnV0ZSkgewogICAgICAgICAgeG1sLmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmIChtZW1iZXJTaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgICAgIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgICAgYXBwbHlOYW1lc3BhY2VzKGVsZW1lbnQsIG1lbWJlclNoYXBlKTsKICAgICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1hcCh4bWwsIG1hcCwgc2hhcGUpIHsKICAgIHZhciB4bWxLZXkgPSBzaGFwZS5rZXkubmFtZSB8fCAna2V5JzsKICAgIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKICAKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGVudHJ5ID0gbmV3IFhtbE5vZGUoc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeScpOwogICAgICB4bWwuYWRkQ2hpbGROb2RlKGVudHJ5KTsKICAKICAgICAgdmFyIGVudHJ5S2V5ID0gbmV3IFhtbE5vZGUoeG1sS2V5KTsKICAgICAgdmFyIGVudHJ5VmFsdWUgPSBuZXcgWG1sTm9kZSh4bWxWYWx1ZSk7CiAgICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeUtleSk7CiAgICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeVZhbHVlKTsKICAKICAgICAgc2VyaWFsaXplKGVudHJ5S2V5LCBrZXksIHNoYXBlLmtleSk7CiAgICAgIHNlcmlhbGl6ZShlbnRyeVZhbHVlLCB2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZUxpc3QoeG1sLCBsaXN0LCBzaGFwZSkgewogICAgaWYgKHNoYXBlLmZsYXR0ZW5lZCkgewogICAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBuYW1lID0gc2hhcGUubWVtYmVyLm5hbWUgfHwgc2hhcGUubmFtZTsKICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG5hbWUgPSBzaGFwZS5tZW1iZXIubmFtZSB8fCAnbWVtYmVyJzsKICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgc2VyaWFsaXplKGVsZW1lbnQsIHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplU2NhbGFyKHhtbCwgdmFsdWUsIHNoYXBlKSB7CiAgICB4bWwuYWRkQ2hpbGROb2RlKAogICAgICBuZXcgWG1sVGV4dChzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpKQogICAgKTsKICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlOYW1lc3BhY2VzKHhtbCwgc2hhcGUsIGlzUm9vdCkgewogICAgdmFyIHVyaSwgcHJlZml4ID0gJ3htbG5zJzsKICAgIGlmIChzaGFwZS54bWxOYW1lc3BhY2VVcmkpIHsKICAgICAgdXJpID0gc2hhcGUueG1sTmFtZXNwYWNlVXJpOwogICAgICBpZiAoc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4KSBwcmVmaXggKz0gJzonICsgc2hhcGUueG1sTmFtZXNwYWNlUHJlZml4OwogICAgfSBlbHNlIGlmIChpc1Jvb3QgJiYgc2hhcGUuYXBpLnhtbE5hbWVzcGFjZVVyaSkgewogICAgICB1cmkgPSBzaGFwZS5hcGkueG1sTmFtZXNwYWNlVXJpOwogICAgfQogIAogICAgaWYgKHVyaSkgeG1sLmFkZEF0dHJpYnV0ZShwcmVmaXgsIHVyaSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gWG1sQnVpbGRlcjsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4veG1sLW5vZGUiOjc2LCIuL3htbC10ZXh0Ijo3N31dLDc0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBFc2NhcGVzIGNoYXJhY3RlcnMgdGhhdCBjYW4gbm90IGJlIGluIGFuIFhNTCBhdHRyaWJ1dGUuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlQXR0cmlidXRlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLycvZywgJyZhcG9zOycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7JykucmVwbGFjZSgvIi9nLCAnJnF1b3Q7Jyk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBlc2NhcGVBdHRyaWJ1dGU6IGVzY2FwZUF0dHJpYnV0ZQogIH07CiAgCiAgfSx7fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIEVzY2FwZXMgY2hhcmFjdGVycyB0aGF0IGNhbiBub3QgYmUgaW4gYW4gWE1MIGVsZW1lbnQuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlRWxlbWVudCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC88L2csICcmbHQ7JykucmVwbGFjZSgvPi9nLCAnJmd0OycpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXNjYXBlRWxlbWVudDogZXNjYXBlRWxlbWVudAogIH07CiAgCiAgfSx7fV0sNzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBlc2NhcGVBdHRyaWJ1dGUgPSByZXF1aXJlKCcuL2VzY2FwZS1hdHRyaWJ1dGUnKS5lc2NhcGVBdHRyaWJ1dGU7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBhbiBYTUwgbm9kZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBYbWxOb2RlKG5hbWUsIGNoaWxkcmVuKSB7CiAgICAgIGlmIChjaGlsZHJlbiA9PT0gdm9pZCAwKSB7IGNoaWxkcmVuID0gW107IH0KICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICB9CiAgWG1sTm9kZS5wcm90b3R5cGUuYWRkQXR0cmlidXRlID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMuYXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLmFkZENoaWxkTm9kZSA9IGZ1bmN0aW9uIChjaGlsZCkgewogICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGRlbGV0ZSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgWG1sTm9kZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBoYXNDaGlsZHJlbiA9IEJvb2xlYW4odGhpcy5jaGlsZHJlbi5sZW5ndGgpOwogICAgICB2YXIgeG1sVGV4dCA9ICc8JyArIHRoaXMubmFtZTsKICAgICAgLy8gYWRkIGF0dHJpYnV0ZXMKICAgICAgdmFyIGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRyaWJ1dGVOYW1lcyA9IE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpOyBpIDwgYXR0cmlidXRlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gYXR0cmlidXRlTmFtZXNbaV07CiAgICAgICAgICB2YXIgYXR0cmlidXRlID0gYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlICE9PSAndW5kZWZpbmVkJyAmJiBhdHRyaWJ1dGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB4bWxUZXh0ICs9ICcgJyArIGF0dHJpYnV0ZU5hbWUgKyAnPVwiJyArIGVzY2FwZUF0dHJpYnV0ZSgnJyArIGF0dHJpYnV0ZSkgKyAnXCInOwogICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB4bWxUZXh0ICs9ICFoYXNDaGlsZHJlbiA/ICcvPicgOiAnPicgKyB0aGlzLmNoaWxkcmVuLm1hcChmdW5jdGlvbiAoYykgeyByZXR1cm4gYy50b1N0cmluZygpOyB9KS5qb2luKCcnKSArICc8LycgKyB0aGlzLm5hbWUgKyAnPic7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgWG1sTm9kZTogWG1sTm9kZQogIH07CiAgCiAgfSx7Ii4vZXNjYXBlLWF0dHJpYnV0ZSI6NzR9XSw3NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGVzY2FwZUVsZW1lbnQgPSByZXF1aXJlKCcuL2VzY2FwZS1lbGVtZW50JykuZXNjYXBlRWxlbWVudDsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIGFuIFhNTCB0ZXh0IHZhbHVlLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIFhtbFRleHQodmFsdWUpIHsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH0KICAKICBYbWxUZXh0LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGVzY2FwZUVsZW1lbnQoJycgKyB0aGlzLnZhbHVlKTsKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBYbWxUZXh0OiBYbWxUZXh0CiAgfTsKICAKICB9LHsiLi9lc2NhcGUtZWxlbWVudCI6NzV9XSw3ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgJ3VzZSBzdHJpY3QnCiAgCiAgZXhwb3J0cy5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAogIGV4cG9ydHMudG9CeXRlQXJyYXkgPSB0b0J5dGVBcnJheQogIGV4cG9ydHMuZnJvbUJ5dGVBcnJheSA9IGZyb21CeXRlQXJyYXkKICAKICB2YXIgbG9va3VwID0gW10KICB2YXIgcmV2TG9va3VwID0gW10KICB2YXIgQXJyID0gdHlwZW9mIFVpbnQ4QXJyYXkgIT09ICd1bmRlZmluZWQnID8gVWludDhBcnJheSA6IEFycmF5CiAgCiAgdmFyIGNvZGUgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLycKICBmb3IgKHZhciBpID0gMCwgbGVuID0gY29kZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgbG9va3VwW2ldID0gY29kZVtpXQogICAgcmV2TG9va3VwW2NvZGUuY2hhckNvZGVBdChpKV0gPSBpCiAgfQogIAogIC8vIFN1cHBvcnQgZGVjb2RpbmcgVVJMLXNhZmUgYmFzZTY0IHN0cmluZ3MsIGFzIE5vZGUuanMgZG9lcy4KICAvLyBTZWU6IGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Jhc2U2NCNVUkxfYXBwbGljYXRpb25zCiAgcmV2TG9va3VwWyctJy5jaGFyQ29kZUF0KDApXSA9IDYyCiAgcmV2TG9va3VwWydfJy5jaGFyQ29kZUF0KDApXSA9IDYzCiAgCiAgZnVuY3Rpb24gZ2V0TGVucyAoYjY0KSB7CiAgICB2YXIgbGVuID0gYjY0Lmxlbmd0aAogIAogICAgaWYgKGxlbiAlIDQgPiAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzdHJpbmcuIExlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNCcpCiAgICB9CiAgCiAgICAvLyBUcmltIG9mZiBleHRyYSBieXRlcyBhZnRlciBwbGFjZWhvbGRlciBieXRlcyBhcmUgZm91bmQKICAgIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2JlYXRnYW1taXQvYmFzZTY0LWpzL2lzc3Vlcy80MgogICAgdmFyIHZhbGlkTGVuID0gYjY0LmluZGV4T2YoJz0nKQogICAgaWYgKHZhbGlkTGVuID09PSAtMSkgdmFsaWRMZW4gPSBsZW4KICAKICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSB2YWxpZExlbiA9PT0gbGVuCiAgICAgID8gMAogICAgICA6IDQgLSAodmFsaWRMZW4gJSA0KQogIAogICAgcmV0dXJuIFt2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuXQogIH0KICAKICAvLyBiYXNlNjQgaXMgNC8zICsgdXAgdG8gdHdvIGNoYXJhY3RlcnMgb2YgdGhlIG9yaWdpbmFsIGRhdGEKICBmdW5jdGlvbiBieXRlTGVuZ3RoIChiNjQpIHsKICAgIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpCiAgICB2YXIgdmFsaWRMZW4gPSBsZW5zWzBdCiAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gbGVuc1sxXQogICAgcmV0dXJuICgodmFsaWRMZW4gKyBwbGFjZUhvbGRlcnNMZW4pICogMyAvIDQpIC0gcGxhY2VIb2xkZXJzTGVuCiAgfQogIAogIGZ1bmN0aW9uIF9ieXRlTGVuZ3RoIChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pIHsKICAgIHJldHVybiAoKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0KSAtIHBsYWNlSG9sZGVyc0xlbgogIH0KICAKICBmdW5jdGlvbiB0b0J5dGVBcnJheSAoYjY0KSB7CiAgICB2YXIgdG1wCiAgICB2YXIgbGVucyA9IGdldExlbnMoYjY0KQogICAgdmFyIHZhbGlkTGVuID0gbGVuc1swXQogICAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IGxlbnNbMV0KICAKICAgIHZhciBhcnIgPSBuZXcgQXJyKF9ieXRlTGVuZ3RoKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikpCiAgCiAgICB2YXIgY3VyQnl0ZSA9IDAKICAKICAgIC8vIGlmIHRoZXJlIGFyZSBwbGFjZWhvbGRlcnMsIG9ubHkgZ2V0IHVwIHRvIHRoZSBsYXN0IGNvbXBsZXRlIDQgY2hhcnMKICAgIHZhciBsZW4gPSBwbGFjZUhvbGRlcnNMZW4gPiAwCiAgICAgID8gdmFsaWRMZW4gLSA0CiAgICAgIDogdmFsaWRMZW4KICAKICAgIHZhciBpCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpICs9IDQpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxOCkgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCAxMikgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA8PCA2KSB8CiAgICAgICAgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAzKV0KICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDE2KSAmIDB4RkYKICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDIpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAyKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldID4+IDQpCiAgICAgIGFycltjdXJCeXRlKytdID0gdG1wICYgMHhGRgogICAgfQogIAogICAgaWYgKHBsYWNlSG9sZGVyc0xlbiA9PT0gMSkgewogICAgICB0bXAgPQogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDEwKSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldIDw8IDQpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPj4gMikKICAgICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBhcnIKICB9CiAgCiAgZnVuY3Rpb24gdHJpcGxldFRvQmFzZTY0IChudW0pIHsKICAgIHJldHVybiBsb29rdXBbbnVtID4+IDE4ICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtID4+IDEyICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtID4+IDYgJiAweDNGXSArCiAgICAgIGxvb2t1cFtudW0gJiAweDNGXQogIH0KICAKICBmdW5jdGlvbiBlbmNvZGVDaHVuayAodWludDgsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciB0bXAKICAgIHZhciBvdXRwdXQgPSBbXQogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpICs9IDMpIHsKICAgICAgdG1wID0KICAgICAgICAoKHVpbnQ4W2ldIDw8IDE2KSAmIDB4RkYwMDAwKSArCiAgICAgICAgKCh1aW50OFtpICsgMV0gPDwgOCkgJiAweEZGMDApICsKICAgICAgICAodWludDhbaSArIDJdICYgMHhGRikKICAgICAgb3V0cHV0LnB1c2godHJpcGxldFRvQmFzZTY0KHRtcCkpCiAgICB9CiAgICByZXR1cm4gb3V0cHV0LmpvaW4oJycpCiAgfQogIAogIGZ1bmN0aW9uIGZyb21CeXRlQXJyYXkgKHVpbnQ4KSB7CiAgICB2YXIgdG1wCiAgICB2YXIgbGVuID0gdWludDgubGVuZ3RoCiAgICB2YXIgZXh0cmFCeXRlcyA9IGxlbiAlIDMgLy8gaWYgd2UgaGF2ZSAxIGJ5dGUgbGVmdCwgcGFkIDIgYnl0ZXMKICAgIHZhciBwYXJ0cyA9IFtdCiAgICB2YXIgbWF4Q2h1bmtMZW5ndGggPSAxNjM4MyAvLyBtdXN0IGJlIG11bHRpcGxlIG9mIDMKICAKICAgIC8vIGdvIHRocm91Z2ggdGhlIGFycmF5IGV2ZXJ5IHRocmVlIGJ5dGVzLCB3ZSdsbCBkZWFsIHdpdGggdHJhaWxpbmcgc3R1ZmYgbGF0ZXIKICAgIGZvciAodmFyIGkgPSAwLCBsZW4yID0gbGVuIC0gZXh0cmFCeXRlczsgaSA8IGxlbjI7IGkgKz0gbWF4Q2h1bmtMZW5ndGgpIHsKICAgICAgcGFydHMucHVzaChlbmNvZGVDaHVuayh1aW50OCwgaSwgKGkgKyBtYXhDaHVua0xlbmd0aCkgPiBsZW4yID8gbGVuMiA6IChpICsgbWF4Q2h1bmtMZW5ndGgpKSkKICAgIH0KICAKICAgIC8vIHBhZCB0aGUgZW5kIHdpdGggemVyb3MsIGJ1dCBtYWtlIHN1cmUgdG8gbm90IGZvcmdldCB0aGUgZXh0cmEgYnl0ZXMKICAgIGlmIChleHRyYUJ5dGVzID09PSAxKSB7CiAgICAgIHRtcCA9IHVpbnQ4W2xlbiAtIDFdCiAgICAgIHBhcnRzLnB1c2goCiAgICAgICAgbG9va3VwW3RtcCA+PiAyXSArCiAgICAgICAgbG9va3VwWyh0bXAgPDwgNCkgJiAweDNGXSArCiAgICAgICAgJz09JwogICAgICApCiAgICB9IGVsc2UgaWYgKGV4dHJhQnl0ZXMgPT09IDIpIHsKICAgICAgdG1wID0gKHVpbnQ4W2xlbiAtIDJdIDw8IDgpICsgdWludDhbbGVuIC0gMV0KICAgICAgcGFydHMucHVzaCgKICAgICAgICBsb29rdXBbdG1wID4+IDEwXSArCiAgICAgICAgbG9va3VwWyh0bXAgPj4gNCkgJiAweDNGXSArCiAgICAgICAgbG9va3VwWyh0bXAgPDwgMikgJiAweDNGXSArCiAgICAgICAgJz0nCiAgICAgICkKICAgIH0KICAKICAgIHJldHVybiBwYXJ0cy5qb2luKCcnKQogIH0KICAKICB9LHt9XSw3OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgCiAgfSx7fV0sODA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoZ2xvYmFsKXsoZnVuY3Rpb24gKCl7CiAgLyohIGh0dHBzOi8vbXRocy5iZS9wdW55Y29kZSB2MS4zLjIgYnkgQG1hdGhpYXMgKi8KICA7KGZ1bmN0aW9uKHJvb3QpIHsKICAKICAgIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZXMgKi8KICAgIHZhciBmcmVlRXhwb3J0cyA9IHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnICYmIGV4cG9ydHMgJiYKICAgICAgIWV4cG9ydHMubm9kZVR5cGUgJiYgZXhwb3J0czsKICAgIHZhciBmcmVlTW9kdWxlID0gdHlwZW9mIG1vZHVsZSA9PSAnb2JqZWN0JyAmJiBtb2R1bGUgJiYKICAgICAgIW1vZHVsZS5ub2RlVHlwZSAmJiBtb2R1bGU7CiAgICB2YXIgZnJlZUdsb2JhbCA9IHR5cGVvZiBnbG9iYWwgPT0gJ29iamVjdCcgJiYgZ2xvYmFsOwogICAgaWYgKAogICAgICBmcmVlR2xvYmFsLmdsb2JhbCA9PT0gZnJlZUdsb2JhbCB8fAogICAgICBmcmVlR2xvYmFsLndpbmRvdyA9PT0gZnJlZUdsb2JhbCB8fAogICAgICBmcmVlR2xvYmFsLnNlbGYgPT09IGZyZWVHbG9iYWwKICAgICkgewogICAgICByb290ID0gZnJlZUdsb2JhbDsKICAgIH0KICAKICAgIC8qKgogICAgICogVGhlIGBwdW55Y29kZWAgb2JqZWN0LgogICAgICogQG5hbWUgcHVueWNvZGUKICAgICAqIEB0eXBlIE9iamVjdAogICAgICovCiAgICB2YXIgcHVueWNvZGUsCiAgCiAgICAvKiogSGlnaGVzdCBwb3NpdGl2ZSBzaWduZWQgMzItYml0IGZsb2F0IHZhbHVlICovCiAgICBtYXhJbnQgPSAyMTQ3NDgzNjQ3LCAvLyBha2EuIDB4N0ZGRkZGRkYgb3IgMl4zMS0xCiAgCiAgICAvKiogQm9vdHN0cmluZyBwYXJhbWV0ZXJzICovCiAgICBiYXNlID0gMzYsCiAgICB0TWluID0gMSwKICAgIHRNYXggPSAyNiwKICAgIHNrZXcgPSAzOCwKICAgIGRhbXAgPSA3MDAsCiAgICBpbml0aWFsQmlhcyA9IDcyLAogICAgaW5pdGlhbE4gPSAxMjgsIC8vIDB4ODAKICAgIGRlbGltaXRlciA9ICctJywgLy8gJ1x4MkQnCiAgCiAgICAvKiogUmVndWxhciBleHByZXNzaW9ucyAqLwogICAgcmVnZXhQdW55Y29kZSA9IC9eeG4tLS8sCiAgICByZWdleE5vbkFTQ0lJID0gL1teXHgyMC1ceDdFXS8sIC8vIHVucHJpbnRhYmxlIEFTQ0lJIGNoYXJzICsgbm9uLUFTQ0lJIGNoYXJzCiAgICByZWdleFNlcGFyYXRvcnMgPSAvW1x4MkVcdTMwMDJcdUZGMEVcdUZGNjFdL2csIC8vIFJGQyAzNDkwIHNlcGFyYXRvcnMKICAKICAgIC8qKiBFcnJvciBtZXNzYWdlcyAqLwogICAgZXJyb3JzID0gewogICAgICAnb3ZlcmZsb3cnOiAnT3ZlcmZsb3c6IGlucHV0IG5lZWRzIHdpZGVyIGludGVnZXJzIHRvIHByb2Nlc3MnLAogICAgICAnbm90LWJhc2ljJzogJ0lsbGVnYWwgaW5wdXQgPj0gMHg4MCAobm90IGEgYmFzaWMgY29kZSBwb2ludCknLAogICAgICAnaW52YWxpZC1pbnB1dCc6ICdJbnZhbGlkIGlucHV0JwogICAgfSwKICAKICAgIC8qKiBDb252ZW5pZW5jZSBzaG9ydGN1dHMgKi8KICAgIGJhc2VNaW51c1RNaW4gPSBiYXNlIC0gdE1pbiwKICAgIGZsb29yID0gTWF0aC5mbG9vciwKICAgIHN0cmluZ0Zyb21DaGFyQ29kZSA9IFN0cmluZy5mcm9tQ2hhckNvZGUsCiAgCiAgICAvKiogVGVtcG9yYXJ5IHZhcmlhYmxlICovCiAgICBrZXk7CiAgCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAKICAgIC8qKgogICAgICogQSBnZW5lcmljIGVycm9yIHV0aWxpdHkgZnVuY3Rpb24uCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIGVycm9yIHR5cGUuCiAgICAgKiBAcmV0dXJucyB7RXJyb3J9IFRocm93cyBhIGBSYW5nZUVycm9yYCB3aXRoIHRoZSBhcHBsaWNhYmxlIGVycm9yIG1lc3NhZ2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVycm9yKHR5cGUpIHsKICAgICAgdGhyb3cgUmFuZ2VFcnJvcihlcnJvcnNbdHlwZV0pOwogICAgfQogIAogICAgLyoqCiAgICAgKiBBIGdlbmVyaWMgYEFycmF5I21hcGAgdXRpbGl0eSBmdW5jdGlvbi4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgZm9yIGV2ZXJ5IGFycmF5CiAgICAgKiBpdGVtLgogICAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBhcnJheSBvZiB2YWx1ZXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBtYXAoYXJyYXksIGZuKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgcmVzdWx0W2xlbmd0aF0gPSBmbihhcnJheVtsZW5ndGhdKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgLyoqCiAgICAgKiBBIHNpbXBsZSBgQXJyYXkjbWFwYC1saWtlIHdyYXBwZXIgdG8gd29yayB3aXRoIGRvbWFpbiBuYW1lIHN0cmluZ3Mgb3IgZW1haWwKICAgICAqIGFkZHJlc3Nlcy4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZG9tYWluIFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRoYXQgZ2V0cyBjYWxsZWQgZm9yIGV2ZXJ5CiAgICAgKiBjaGFyYWN0ZXIuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IEEgbmV3IHN0cmluZyBvZiBjaGFyYWN0ZXJzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjawogICAgICogZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcERvbWFpbihzdHJpbmcsIGZuKSB7CiAgICAgIHZhciBwYXJ0cyA9IHN0cmluZy5zcGxpdCgnQCcpOwogICAgICB2YXIgcmVzdWx0ID0gJyc7CiAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgLy8gSW4gZW1haWwgYWRkcmVzc2VzLCBvbmx5IHRoZSBkb21haW4gbmFtZSBzaG91bGQgYmUgcHVueWNvZGVkLiBMZWF2ZQogICAgICAgIC8vIHRoZSBsb2NhbCBwYXJ0IChpLmUuIGV2ZXJ5dGhpbmcgdXAgdG8gYEBgKSBpbnRhY3QuCiAgICAgICAgcmVzdWx0ID0gcGFydHNbMF0gKyAnQCc7CiAgICAgICAgc3RyaW5nID0gcGFydHNbMV07CiAgICAgIH0KICAgICAgLy8gQXZvaWQgYHNwbGl0KHJlZ2V4KWAgZm9yIElFOCBjb21wYXRpYmlsaXR5LiBTZWUgIzE3LgogICAgICBzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShyZWdleFNlcGFyYXRvcnMsICdceDJFJyk7CiAgICAgIHZhciBsYWJlbHMgPSBzdHJpbmcuc3BsaXQoJy4nKTsKICAgICAgdmFyIGVuY29kZWQgPSBtYXAobGFiZWxzLCBmbikuam9pbignLicpOwogICAgICByZXR1cm4gcmVzdWx0ICsgZW5jb2RlZDsKICAgIH0KICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjb250YWluaW5nIHRoZSBudW1lcmljIGNvZGUgcG9pbnRzIG9mIGVhY2ggVW5pY29kZQogICAgICogY2hhcmFjdGVyIGluIHRoZSBzdHJpbmcuIFdoaWxlIEphdmFTY3JpcHQgdXNlcyBVQ1MtMiBpbnRlcm5hbGx5LAogICAgICogdGhpcyBmdW5jdGlvbiB3aWxsIGNvbnZlcnQgYSBwYWlyIG9mIHN1cnJvZ2F0ZSBoYWx2ZXMgKGVhY2ggb2Ygd2hpY2gKICAgICAqIFVDUy0yIGV4cG9zZXMgYXMgc2VwYXJhdGUgY2hhcmFjdGVycykgaW50byBhIHNpbmdsZSBjb2RlIHBvaW50LAogICAgICogbWF0Y2hpbmcgVVRGLTE2LgogICAgICogQHNlZSBgcHVueWNvZGUudWNzMi5lbmNvZGVgCiAgICAgKiBAc2VlIDxodHRwczovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZz4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZS51Y3MyCiAgICAgKiBAbmFtZSBkZWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIFVuaWNvZGUgaW5wdXQgc3RyaW5nIChVQ1MtMikuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFRoZSBuZXcgYXJyYXkgb2YgY29kZSBwb2ludHMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVjczJkZWNvZGUoc3RyaW5nKSB7CiAgICAgIHZhciBvdXRwdXQgPSBbXSwKICAgICAgICAgIGNvdW50ZXIgPSAwLAogICAgICAgICAgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgZXh0cmE7CiAgICAgIHdoaWxlIChjb3VudGVyIDwgbGVuZ3RoKSB7CiAgICAgICAgdmFsdWUgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgIGlmICh2YWx1ZSA+PSAweEQ4MDAgJiYgdmFsdWUgPD0gMHhEQkZGICYmIGNvdW50ZXIgPCBsZW5ndGgpIHsKICAgICAgICAgIC8vIGhpZ2ggc3Vycm9nYXRlLCBhbmQgdGhlcmUgaXMgYSBuZXh0IGNoYXJhY3RlcgogICAgICAgICAgZXh0cmEgPSBzdHJpbmcuY2hhckNvZGVBdChjb3VudGVyKyspOwogICAgICAgICAgaWYgKChleHRyYSAmIDB4RkMwMCkgPT0gMHhEQzAwKSB7IC8vIGxvdyBzdXJyb2dhdGUKICAgICAgICAgICAgb3V0cHV0LnB1c2goKCh2YWx1ZSAmIDB4M0ZGKSA8PCAxMCkgKyAoZXh0cmEgJiAweDNGRikgKyAweDEwMDAwKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHVubWF0Y2hlZCBzdXJyb2dhdGU7IG9ubHkgYXBwZW5kIHRoaXMgY29kZSB1bml0LCBpbiBjYXNlIHRoZSBuZXh0CiAgICAgICAgICAgIC8vIGNvZGUgdW5pdCBpcyB0aGUgaGlnaCBzdXJyb2dhdGUgb2YgYSBzdXJyb2dhdGUgcGFpcgogICAgICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIGNvdW50ZXItLTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb3V0cHV0OwogICAgfQogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc3RyaW5nIGJhc2VkIG9uIGFuIGFycmF5IG9mIG51bWVyaWMgY29kZSBwb2ludHMuCiAgICAgKiBAc2VlIGBwdW55Y29kZS51Y3MyLmRlY29kZWAKICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZS51Y3MyCiAgICAgKiBAbmFtZSBlbmNvZGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGNvZGVQb2ludHMgVGhlIGFycmF5IG9mIG51bWVyaWMgY29kZSBwb2ludHMuCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgbmV3IFVuaWNvZGUgc3RyaW5nIChVQ1MtMikuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVjczJlbmNvZGUoYXJyYXkpIHsKICAgICAgcmV0dXJuIG1hcChhcnJheSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgb3V0cHV0ID0gJyc7CiAgICAgICAgaWYgKHZhbHVlID4gMHhGRkZGKSB7CiAgICAgICAgICB2YWx1ZSAtPSAweDEwMDAwOwogICAgICAgICAgb3V0cHV0ICs9IHN0cmluZ0Zyb21DaGFyQ29kZSh2YWx1ZSA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCk7CiAgICAgICAgICB2YWx1ZSA9IDB4REMwMCB8IHZhbHVlICYgMHgzRkY7CiAgICAgICAgfQogICAgICAgIG91dHB1dCArPSBzdHJpbmdGcm9tQ2hhckNvZGUodmFsdWUpOwogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgIH0pLmpvaW4oJycpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIGJhc2ljIGNvZGUgcG9pbnQgaW50byBhIGRpZ2l0L2ludGVnZXIuCiAgICAgKiBAc2VlIGBkaWdpdFRvQmFzaWMoKWAKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gY29kZVBvaW50IFRoZSBiYXNpYyBudW1lcmljIGNvZGUgcG9pbnQgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQgKGZvciB1c2UgaW4KICAgICAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaW4gdGhlIHJhbmdlIGAwYCB0byBgYmFzZSAtIDFgLCBvciBgYmFzZWAgaWYKICAgICAqIHRoZSBjb2RlIHBvaW50IGRvZXMgbm90IHJlcHJlc2VudCBhIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNpY1RvRGlnaXQoY29kZVBvaW50KSB7CiAgICAgIGlmIChjb2RlUG9pbnQgLSA0OCA8IDEwKSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDIyOwogICAgICB9CiAgICAgIGlmIChjb2RlUG9pbnQgLSA2NSA8IDI2KSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDY1OwogICAgICB9CiAgICAgIGlmIChjb2RlUG9pbnQgLSA5NyA8IDI2KSB7CiAgICAgICAgcmV0dXJuIGNvZGVQb2ludCAtIDk3OwogICAgICB9CiAgICAgIHJldHVybiBiYXNlOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIGRpZ2l0L2ludGVnZXIgaW50byBhIGJhc2ljIGNvZGUgcG9pbnQuCiAgICAgKiBAc2VlIGBiYXNpY1RvRGlnaXQoKWAKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge051bWJlcn0gZGlnaXQgVGhlIG51bWVyaWMgdmFsdWUgb2YgYSBiYXNpYyBjb2RlIHBvaW50LgogICAgICogQHJldHVybnMge051bWJlcn0gVGhlIGJhc2ljIGNvZGUgcG9pbnQgd2hvc2UgdmFsdWUgKHdoZW4gdXNlZCBmb3IKICAgICAqIHJlcHJlc2VudGluZyBpbnRlZ2VycykgaXMgYGRpZ2l0YCwgd2hpY2ggbmVlZHMgdG8gYmUgaW4gdGhlIHJhbmdlCiAgICAgKiBgMGAgdG8gYGJhc2UgLSAxYC4gSWYgYGZsYWdgIGlzIG5vbi16ZXJvLCB0aGUgdXBwZXJjYXNlIGZvcm0gaXMKICAgICAqIHVzZWQ7IGVsc2UsIHRoZSBsb3dlcmNhc2UgZm9ybSBpcyB1c2VkLiBUaGUgYmVoYXZpb3IgaXMgdW5kZWZpbmVkCiAgICAgKiBpZiBgZmxhZ2AgaXMgbm9uLXplcm8gYW5kIGBkaWdpdGAgaGFzIG5vIHVwcGVyY2FzZSBmb3JtLgogICAgICovCiAgICBmdW5jdGlvbiBkaWdpdFRvQmFzaWMoZGlnaXQsIGZsYWcpIHsKICAgICAgLy8gIDAuLjI1IG1hcCB0byBBU0NJSSBhLi56IG9yIEEuLloKICAgICAgLy8gMjYuLjM1IG1hcCB0byBBU0NJSSAwLi45CiAgICAgIHJldHVybiBkaWdpdCArIDIyICsgNzUgKiAoZGlnaXQgPCAyNikgLSAoKGZsYWcgIT0gMCkgPDwgNSk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIEJpYXMgYWRhcHRhdGlvbiBmdW5jdGlvbiBhcyBwZXIgc2VjdGlvbiAzLjQgb2YgUkZDIDM0OTIuCiAgICAgKiBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzNDkyI3NlY3Rpb24tMy40CiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICBmdW5jdGlvbiBhZGFwdChkZWx0YSwgbnVtUG9pbnRzLCBmaXJzdFRpbWUpIHsKICAgICAgdmFyIGsgPSAwOwogICAgICBkZWx0YSA9IGZpcnN0VGltZSA/IGZsb29yKGRlbHRhIC8gZGFtcCkgOiBkZWx0YSA+PiAxOwogICAgICBkZWx0YSArPSBmbG9vcihkZWx0YSAvIG51bVBvaW50cyk7CiAgICAgIGZvciAoLyogbm8gaW5pdGlhbGl6YXRpb24gKi87IGRlbHRhID4gYmFzZU1pbnVzVE1pbiAqIHRNYXggPj4gMTsgayArPSBiYXNlKSB7CiAgICAgICAgZGVsdGEgPSBmbG9vcihkZWx0YSAvIGJhc2VNaW51c1RNaW4pOwogICAgICB9CiAgICAgIHJldHVybiBmbG9vcihrICsgKGJhc2VNaW51c1RNaW4gKyAxKSAqIGRlbHRhIC8gKGRlbHRhICsgc2tldykpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMgdG8gYSBzdHJpbmcgb2YgVW5pY29kZQogICAgICogc3ltYm9scy4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgogICAgICovCiAgICBmdW5jdGlvbiBkZWNvZGUoaW5wdXQpIHsKICAgICAgLy8gRG9uJ3QgdXNlIFVDUy0yCiAgICAgIHZhciBvdXRwdXQgPSBbXSwKICAgICAgICAgIGlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAogICAgICAgICAgb3V0LAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICBuID0gaW5pdGlhbE4sCiAgICAgICAgICBiaWFzID0gaW5pdGlhbEJpYXMsCiAgICAgICAgICBiYXNpYywKICAgICAgICAgIGosCiAgICAgICAgICBpbmRleCwKICAgICAgICAgIG9sZGksCiAgICAgICAgICB3LAogICAgICAgICAgaywKICAgICAgICAgIGRpZ2l0LAogICAgICAgICAgdCwKICAgICAgICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwogICAgICAgICAgYmFzZU1pbnVzVDsKICAKICAgICAgLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50czogbGV0IGBiYXNpY2AgYmUgdGhlIG51bWJlciBvZiBpbnB1dCBjb2RlCiAgICAgIC8vIHBvaW50cyBiZWZvcmUgdGhlIGxhc3QgZGVsaW1pdGVyLCBvciBgMGAgaWYgdGhlcmUgaXMgbm9uZSwgdGhlbiBjb3B5CiAgICAgIC8vIHRoZSBmaXJzdCBiYXNpYyBjb2RlIHBvaW50cyB0byB0aGUgb3V0cHV0LgogIAogICAgICBiYXNpYyA9IGlucHV0Lmxhc3RJbmRleE9mKGRlbGltaXRlcik7CiAgICAgIGlmIChiYXNpYyA8IDApIHsKICAgICAgICBiYXNpYyA9IDA7CiAgICAgIH0KICAKICAgICAgZm9yIChqID0gMDsgaiA8IGJhc2ljOyArK2opIHsKICAgICAgICAvLyBpZiBpdCdzIG5vdCBhIGJhc2ljIGNvZGUgcG9pbnQKICAgICAgICBpZiAoaW5wdXQuY2hhckNvZGVBdChqKSA+PSAweDgwKSB7CiAgICAgICAgICBlcnJvcignbm90LWJhc2ljJyk7CiAgICAgICAgfQogICAgICAgIG91dHB1dC5wdXNoKGlucHV0LmNoYXJDb2RlQXQoaikpOwogICAgICB9CiAgCiAgICAgIC8vIE1haW4gZGVjb2RpbmcgbG9vcDogc3RhcnQganVzdCBhZnRlciB0aGUgbGFzdCBkZWxpbWl0ZXIgaWYgYW55IGJhc2ljIGNvZGUKICAgICAgLy8gcG9pbnRzIHdlcmUgY29waWVkOyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nIG90aGVyd2lzZS4KICAKICAgICAgZm9yIChpbmRleCA9IGJhc2ljID4gMCA/IGJhc2ljICsgMSA6IDA7IGluZGV4IDwgaW5wdXRMZW5ndGg7IC8qIG5vIGZpbmFsIGV4cHJlc3Npb24gKi8pIHsKICAKICAgICAgICAvLyBgaW5kZXhgIGlzIHRoZSBpbmRleCBvZiB0aGUgbmV4dCBjaGFyYWN0ZXIgdG8gYmUgY29uc3VtZWQuCiAgICAgICAgLy8gRGVjb2RlIGEgZ2VuZXJhbGl6ZWQgdmFyaWFibGUtbGVuZ3RoIGludGVnZXIgaW50byBgZGVsdGFgLAogICAgICAgIC8vIHdoaWNoIGdldHMgYWRkZWQgdG8gYGlgLiBUaGUgb3ZlcmZsb3cgY2hlY2tpbmcgaXMgZWFzaWVyCiAgICAgICAgLy8gaWYgd2UgaW5jcmVhc2UgYGlgIGFzIHdlIGdvLCB0aGVuIHN1YnRyYWN0IG9mZiBpdHMgc3RhcnRpbmcKICAgICAgICAvLyB2YWx1ZSBhdCB0aGUgZW5kIHRvIG9idGFpbiBgZGVsdGFgLgogICAgICAgIGZvciAob2xkaSA9IGksIHcgPSAxLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKICAKICAgICAgICAgIGlmIChpbmRleCA+PSBpbnB1dExlbmd0aCkgewogICAgICAgICAgICBlcnJvcignaW52YWxpZC1pbnB1dCcpOwogICAgICAgICAgfQogIAogICAgICAgICAgZGlnaXQgPSBiYXNpY1RvRGlnaXQoaW5wdXQuY2hhckNvZGVBdChpbmRleCsrKSk7CiAgCiAgICAgICAgICBpZiAoZGlnaXQgPj0gYmFzZSB8fCBkaWdpdCA+IGZsb29yKChtYXhJbnQgLSBpKSAvIHcpKSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgaSArPSBkaWdpdCAqIHc7CiAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKICAKICAgICAgICAgIGlmIChkaWdpdCA8IHQpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBiYXNlTWludXNUID0gYmFzZSAtIHQ7CiAgICAgICAgICBpZiAodyA+IGZsb29yKG1heEludCAvIGJhc2VNaW51c1QpKSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgdyAqPSBiYXNlTWludXNUOwogIAogICAgICAgIH0KICAKICAgICAgICBvdXQgPSBvdXRwdXQubGVuZ3RoICsgMTsKICAgICAgICBiaWFzID0gYWRhcHQoaSAtIG9sZGksIG91dCwgb2xkaSA9PSAwKTsKICAKICAgICAgICAvLyBgaWAgd2FzIHN1cHBvc2VkIHRvIHdyYXAgYXJvdW5kIGZyb20gYG91dGAgdG8gYDBgLAogICAgICAgIC8vIGluY3JlbWVudGluZyBgbmAgZWFjaCB0aW1lLCBzbyB3ZSdsbCBmaXggdGhhdCBub3c6CiAgICAgICAgaWYgKGZsb29yKGkgLyBvdXQpID4gbWF4SW50IC0gbikgewogICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgfQogIAogICAgICAgIG4gKz0gZmxvb3IoaSAvIG91dCk7CiAgICAgICAgaSAlPSBvdXQ7CiAgCiAgICAgICAgLy8gSW5zZXJ0IGBuYCBhdCBwb3NpdGlvbiBgaWAgb2YgdGhlIG91dHB1dAogICAgICAgIG91dHB1dC5zcGxpY2UoaSsrLCAwLCBuKTsKICAKICAgICAgfQogIAogICAgICByZXR1cm4gdWNzMmVuY29kZShvdXRwdXQpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMgKGUuZy4gYSBkb21haW4gbmFtZSBsYWJlbCkgdG8gYQogICAgICogUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIHJlc3VsdGluZyBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgogICAgICovCiAgICBmdW5jdGlvbiBlbmNvZGUoaW5wdXQpIHsKICAgICAgdmFyIG4sCiAgICAgICAgICBkZWx0YSwKICAgICAgICAgIGhhbmRsZWRDUENvdW50LAogICAgICAgICAgYmFzaWNMZW5ndGgsCiAgICAgICAgICBiaWFzLAogICAgICAgICAgaiwKICAgICAgICAgIG0sCiAgICAgICAgICBxLAogICAgICAgICAgaywKICAgICAgICAgIHQsCiAgICAgICAgICBjdXJyZW50VmFsdWUsCiAgICAgICAgICBvdXRwdXQgPSBbXSwKICAgICAgICAgIC8qKiBgaW5wdXRMZW5ndGhgIHdpbGwgaG9sZCB0aGUgbnVtYmVyIG9mIGNvZGUgcG9pbnRzIGluIGBpbnB1dGAuICovCiAgICAgICAgICBpbnB1dExlbmd0aCwKICAgICAgICAgIC8qKiBDYWNoZWQgY2FsY3VsYXRpb24gcmVzdWx0cyAqLwogICAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lLAogICAgICAgICAgYmFzZU1pbnVzVCwKICAgICAgICAgIHFNaW51c1Q7CiAgCiAgICAgIC8vIENvbnZlcnQgdGhlIGlucHV0IGluIFVDUy0yIHRvIFVuaWNvZGUKICAgICAgaW5wdXQgPSB1Y3MyZGVjb2RlKGlucHV0KTsKICAKICAgICAgLy8gQ2FjaGUgdGhlIGxlbmd0aAogICAgICBpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aDsKICAKICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgc3RhdGUKICAgICAgbiA9IGluaXRpYWxOOwogICAgICBkZWx0YSA9IDA7CiAgICAgIGJpYXMgPSBpbml0aWFsQmlhczsKICAKICAgICAgLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50cwogICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgIGlmIChjdXJyZW50VmFsdWUgPCAweDgwKSB7CiAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoY3VycmVudFZhbHVlKSk7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGhhbmRsZWRDUENvdW50ID0gYmFzaWNMZW5ndGggPSBvdXRwdXQubGVuZ3RoOwogIAogICAgICAvLyBgaGFuZGxlZENQQ291bnRgIGlzIHRoZSBudW1iZXIgb2YgY29kZSBwb2ludHMgdGhhdCBoYXZlIGJlZW4gaGFuZGxlZDsKICAgICAgLy8gYGJhc2ljTGVuZ3RoYCBpcyB0aGUgbnVtYmVyIG9mIGJhc2ljIGNvZGUgcG9pbnRzLgogIAogICAgICAvLyBGaW5pc2ggdGhlIGJhc2ljIHN0cmluZyAtIGlmIGl0IGlzIG5vdCBlbXB0eSAtIHdpdGggYSBkZWxpbWl0ZXIKICAgICAgaWYgKGJhc2ljTGVuZ3RoKSB7CiAgICAgICAgb3V0cHV0LnB1c2goZGVsaW1pdGVyKTsKICAgICAgfQogIAogICAgICAvLyBNYWluIGVuY29kaW5nIGxvb3A6CiAgICAgIHdoaWxlIChoYW5kbGVkQ1BDb3VudCA8IGlucHV0TGVuZ3RoKSB7CiAgCiAgICAgICAgLy8gQWxsIG5vbi1iYXNpYyBjb2RlIHBvaW50cyA8IG4gaGF2ZSBiZWVuIGhhbmRsZWQgYWxyZWFkeS4gRmluZCB0aGUgbmV4dAogICAgICAgIC8vIGxhcmdlciBvbmU6CiAgICAgICAgZm9yIChtID0gbWF4SW50LCBqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA+PSBuICYmIGN1cnJlbnRWYWx1ZSA8IG0pIHsKICAgICAgICAgICAgbSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgLy8gSW5jcmVhc2UgYGRlbHRhYCBlbm91Z2ggdG8gYWR2YW5jZSB0aGUgZGVjb2RlcidzIDxuLGk+IHN0YXRlIHRvIDxtLDA+LAogICAgICAgIC8vIGJ1dCBndWFyZCBhZ2FpbnN0IG92ZXJmbG93CiAgICAgICAgaGFuZGxlZENQQ291bnRQbHVzT25lID0gaGFuZGxlZENQQ291bnQgKyAxOwogICAgICAgIGlmIChtIC0gbiA+IGZsb29yKChtYXhJbnQgLSBkZWx0YSkgLyBoYW5kbGVkQ1BDb3VudFBsdXNPbmUpKSB7CiAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICB9CiAgCiAgICAgICAgZGVsdGEgKz0gKG0gLSBuKSAqIGhhbmRsZWRDUENvdW50UGx1c09uZTsKICAgICAgICBuID0gbTsKICAKICAgICAgICBmb3IgKGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewogICAgICAgICAgY3VycmVudFZhbHVlID0gaW5wdXRbal07CiAgCiAgICAgICAgICBpZiAoY3VycmVudFZhbHVlIDwgbiAmJiArK2RlbHRhID4gbWF4SW50KSB7CiAgICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgICAgfQogIAogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA9PSBuKSB7CiAgICAgICAgICAgIC8vIFJlcHJlc2VudCBkZWx0YSBhcyBhIGdlbmVyYWxpemVkIHZhcmlhYmxlLWxlbmd0aCBpbnRlZ2VyCiAgICAgICAgICAgIGZvciAocSA9IGRlbHRhLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKICAgICAgICAgICAgICB0ID0gayA8PSBiaWFzID8gdE1pbiA6IChrID49IGJpYXMgKyB0TWF4ID8gdE1heCA6IGsgLSBiaWFzKTsKICAgICAgICAgICAgICBpZiAocSA8IHQpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxTWludXNUID0gcSAtIHQ7CiAgICAgICAgICAgICAgYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwogICAgICAgICAgICAgIG91dHB1dC5wdXNoKAogICAgICAgICAgICAgICAgc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyh0ICsgcU1pbnVzVCAlIGJhc2VNaW51c1QsIDApKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcSA9IGZsb29yKHFNaW51c1QgLyBiYXNlTWludXNUKTsKICAgICAgICAgICAgfQogIAogICAgICAgICAgICBvdXRwdXQucHVzaChzdHJpbmdGcm9tQ2hhckNvZGUoZGlnaXRUb0Jhc2ljKHEsIDApKSk7CiAgICAgICAgICAgIGJpYXMgPSBhZGFwdChkZWx0YSwgaGFuZGxlZENQQ291bnRQbHVzT25lLCBoYW5kbGVkQ1BDb3VudCA9PSBiYXNpY0xlbmd0aCk7CiAgICAgICAgICAgIGRlbHRhID0gMDsKICAgICAgICAgICAgKytoYW5kbGVkQ1BDb3VudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgKytkZWx0YTsKICAgICAgICArK247CiAgCiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBQdW55Y29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcwogICAgICogdG8gVW5pY29kZS4gT25seSB0aGUgUHVueWNvZGVkIHBhcnRzIG9mIHRoZSBpbnB1dCB3aWxsIGJlIGNvbnZlcnRlZCwgaS5lLgogICAgICogaXQgZG9lc24ndCBtYXR0ZXIgaWYgeW91IGNhbGwgaXQgb24gYSBzdHJpbmcgdGhhdCBoYXMgYWxyZWFkeSBiZWVuCiAgICAgKiBjb252ZXJ0ZWQgdG8gVW5pY29kZS4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBQdW55Y29kZWQgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcyB0bwogICAgICogY29udmVydCB0byBVbmljb2RlLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIFVuaWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIFB1bnljb2RlCiAgICAgKiBzdHJpbmcuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvVW5pY29kZShpbnB1dCkgewogICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICByZXR1cm4gcmVnZXhQdW55Y29kZS50ZXN0KHN0cmluZykKICAgICAgICAgID8gZGVjb2RlKHN0cmluZy5zbGljZSg0KS50b0xvd2VyQ2FzZSgpKQogICAgICAgICAgOiBzdHJpbmc7CiAgICAgIH0pOwogICAgfQogIAogICAgLyoqCiAgICAgKiBDb252ZXJ0cyBhIFVuaWNvZGUgc3RyaW5nIHJlcHJlc2VudGluZyBhIGRvbWFpbiBuYW1lIG9yIGFuIGVtYWlsIGFkZHJlc3MgdG8KICAgICAqIFB1bnljb2RlLiBPbmx5IHRoZSBub24tQVNDSUkgcGFydHMgb2YgdGhlIGRvbWFpbiBuYW1lIHdpbGwgYmUgY29udmVydGVkLAogICAgICogaS5lLiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQncyBhbHJlYWR5IGluCiAgICAgKiBBU0NJSS4KICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGlucHV0IFRoZSBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvIGNvbnZlcnQsIGFzIGEKICAgICAqIFVuaWNvZGUgc3RyaW5nLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIFB1bnljb2RlIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBkb21haW4gbmFtZSBvcgogICAgICogZW1haWwgYWRkcmVzcy4KICAgICAqLwogICAgZnVuY3Rpb24gdG9BU0NJSShpbnB1dCkgewogICAgICByZXR1cm4gbWFwRG9tYWluKGlucHV0LCBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICByZXR1cm4gcmVnZXhOb25BU0NJSS50ZXN0KHN0cmluZykKICAgICAgICAgID8gJ3huLS0nICsgZW5jb2RlKHN0cmluZykKICAgICAgICAgIDogc3RyaW5nOwogICAgICB9KTsKICAgIH0KICAKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIAogICAgLyoqIERlZmluZSB0aGUgcHVibGljIEFQSSAqLwogICAgcHVueWNvZGUgPSB7CiAgICAgIC8qKgogICAgICAgKiBBIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgUHVueWNvZGUuanMgdmVyc2lvbiBudW1iZXIuCiAgICAgICAqIEBtZW1iZXJPZiBwdW55Y29kZQogICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICovCiAgICAgICd2ZXJzaW9uJzogJzEuMy4yJywKICAgICAgLyoqCiAgICAgICAqIEFuIG9iamVjdCBvZiBtZXRob2RzIHRvIGNvbnZlcnQgZnJvbSBKYXZhU2NyaXB0J3MgaW50ZXJuYWwgY2hhcmFjdGVyCiAgICAgICAqIHJlcHJlc2VudGF0aW9uIChVQ1MtMikgdG8gVW5pY29kZSBjb2RlIHBvaW50cywgYW5kIGJhY2suCiAgICAgICAqIEBzZWUgPGh0dHBzOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9qYXZhc2NyaXB0LWVuY29kaW5nPgogICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICAndWNzMic6IHsKICAgICAgICAnZGVjb2RlJzogdWNzMmRlY29kZSwKICAgICAgICAnZW5jb2RlJzogdWNzMmVuY29kZQogICAgICB9LAogICAgICAnZGVjb2RlJzogZGVjb2RlLAogICAgICAnZW5jb2RlJzogZW5jb2RlLAogICAgICAndG9BU0NJSSc6IHRvQVNDSUksCiAgICAgICd0b1VuaWNvZGUnOiB0b1VuaWNvZGUKICAgIH07CiAgCiAgICAvKiogRXhwb3NlIGBwdW55Y29kZWAgKi8KICAgIC8vIFNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMsIGxpa2Ugci5qcywgY2hlY2sgZm9yIHNwZWNpZmljIGNvbmRpdGlvbiBwYXR0ZXJucwogICAgLy8gbGlrZSB0aGUgZm9sbG93aW5nOgogICAgaWYgKAogICAgICB0cnVlCiAgICApIHsKICAgICAgIShfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyA9IChmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gcHVueWNvZGU7CiAgICAgIH0pLmNhbGwoZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXywgZXhwb3J0cywgbW9kdWxlKSwKCQlfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyAhPT0gdW5kZWZpbmVkICYmIChtb2R1bGUuZXhwb3J0cyA9IF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fKSk7CiAgICB9IGVsc2Uge30KICAKICB9KHRoaXMpKTsKICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHR5cGVvZiBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgIT09ICJ1bmRlZmluZWQiID8gX193ZWJwYWNrX3JlcXVpcmVfXy5nIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCiAgfSx7fV0sODE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoZ2xvYmFsLEJ1ZmZlcil7KGZ1bmN0aW9uICgpewogIC8qIQogICAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogICAqCiAgICogQGF1dGhvciAgIEZlcm9zcyBBYm91a2hhZGlqZWggPGZlcm9zc0BmZXJvc3Mub3JnPiA8aHR0cDovL2Zlcm9zcy5vcmc+CiAgICogQGxpY2Vuc2UgIE1JVAogICAqLwogIC8qIGVzbGludC1kaXNhYmxlIG5vLXByb3RvICovCiAgCiAgJ3VzZSBzdHJpY3QnCiAgCiAgdmFyIGJhc2U2NCA9IHJlcXVpcmUoJ2Jhc2U2NC1qcycpCiAgdmFyIGllZWU3NTQgPSByZXF1aXJlKCdpZWVlNzU0JykKICB2YXIgaXNBcnJheSA9IHJlcXVpcmUoJ2lzYXJyYXknKQogIAogIGV4cG9ydHMuQnVmZmVyID0gQnVmZmVyCiAgZXhwb3J0cy5TbG93QnVmZmVyID0gU2xvd0J1ZmZlcgogIGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMgPSA1MAogIAogIC8qKgogICAqIElmIGBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVGA6CiAgICogICA9PT0gdHJ1ZSAgICBVc2UgVWludDhBcnJheSBpbXBsZW1lbnRhdGlvbiAoZmFzdGVzdCkKICAgKiAgID09PSBmYWxzZSAgIFVzZSBPYmplY3QgaW1wbGVtZW50YXRpb24gKG1vc3QgY29tcGF0aWJsZSwgZXZlbiBJRTYpCiAgICoKICAgKiBCcm93c2VycyB0aGF0IHN1cHBvcnQgdHlwZWQgYXJyYXlzIGFyZSBJRSAxMCssIEZpcmVmb3ggNCssIENocm9tZSA3KywgU2FmYXJpIDUuMSssCiAgICogT3BlcmEgMTEuNissIGlPUyA0LjIrLgogICAqCiAgICogRHVlIHRvIHZhcmlvdXMgYnJvd3NlciBidWdzLCBzb21ldGltZXMgdGhlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiB3aWxsIGJlIHVzZWQgZXZlbgogICAqIHdoZW4gdGhlIGJyb3dzZXIgc3VwcG9ydHMgdHlwZWQgYXJyYXlzLgogICAqCiAgICogTm90ZToKICAgKgogICAqICAgLSBGaXJlZm94IDQtMjkgbGFja3Mgc3VwcG9ydCBmb3IgYWRkaW5nIG5ldyBwcm9wZXJ0aWVzIHRvIGBVaW50OEFycmF5YCBpbnN0YW5jZXMsCiAgICogICAgIFNlZTogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njk1NDM4LgogICAqCiAgICogICAtIENocm9tZSA5LTEwIGlzIG1pc3NpbmcgdGhlIGBUeXBlZEFycmF5LnByb3RvdHlwZS5zdWJhcnJheWAgZnVuY3Rpb24uCiAgICoKICAgKiAgIC0gSUUxMCBoYXMgYSBicm9rZW4gYFR5cGVkQXJyYXkucHJvdG90eXBlLnN1YmFycmF5YCBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFycmF5cyBvZgogICAqICAgICBpbmNvcnJlY3QgbGVuZ3RoIGluIHNvbWUgc2l0dWF0aW9ucy4KICAKICAgKiBXZSBkZXRlY3QgdGhlc2UgYnVnZ3kgYnJvd3NlcnMgYW5kIHNldCBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgIHRvIGBmYWxzZWAgc28gdGhleQogICAqIGdldCB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uLCB3aGljaCBpcyBzbG93ZXIgYnV0IGJlaGF2ZXMgY29ycmVjdGx5LgogICAqLwogIEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUID0gZ2xvYmFsLlRZUEVEX0FSUkFZX1NVUFBPUlQgIT09IHVuZGVmaW5lZAogICAgPyBnbG9iYWwuVFlQRURfQVJSQVlfU1VQUE9SVAogICAgOiB0eXBlZEFycmF5U3VwcG9ydCgpCiAgCiAgLyoKICAgKiBFeHBvcnQga01heExlbmd0aCBhZnRlciB0eXBlZCBhcnJheSBzdXBwb3J0IGlzIGRldGVybWluZWQuCiAgICovCiAgZXhwb3J0cy5rTWF4TGVuZ3RoID0ga01heExlbmd0aCgpCiAgCiAgZnVuY3Rpb24gdHlwZWRBcnJheVN1cHBvcnQgKCkgewogICAgdHJ5IHsKICAgICAgdmFyIGFyciA9IG5ldyBVaW50OEFycmF5KDEpCiAgICAgIGFyci5fX3Byb3RvX18gPSB7X19wcm90b19fOiBVaW50OEFycmF5LnByb3RvdHlwZSwgZm9vOiBmdW5jdGlvbiAoKSB7IHJldHVybiA0MiB9fQogICAgICByZXR1cm4gYXJyLmZvbygpID09PSA0MiAmJiAvLyB0eXBlZCBhcnJheSBpbnN0YW5jZXMgY2FuIGJlIGF1Z21lbnRlZAogICAgICAgICAgdHlwZW9mIGFyci5zdWJhcnJheSA9PT0gJ2Z1bmN0aW9uJyAmJiAvLyBjaHJvbWUgOS0xMCBsYWNrIGBzdWJhcnJheWAKICAgICAgICAgIGFyci5zdWJhcnJheSgxLCAxKS5ieXRlTGVuZ3RoID09PSAwIC8vIGllMTAgaGFzIGJyb2tlbiBgc3ViYXJyYXlgCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KICAKICBmdW5jdGlvbiBrTWF4TGVuZ3RoICgpIHsKICAgIHJldHVybiBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVAogICAgICA/IDB4N2ZmZmZmZmYKICAgICAgOiAweDNmZmZmZmZmCiAgfQogIAogIGZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlciAodGhhdCwgbGVuZ3RoKSB7CiAgICBpZiAoa01heExlbmd0aCgpIDwgbGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbnZhbGlkIHR5cGVkIGFycmF5IGxlbmd0aCcpCiAgICB9CiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UsIGZvciBiZXN0IHBlcmZvcm1hbmNlCiAgICAgIHRoYXQgPSBuZXcgVWludDhBcnJheShsZW5ndGgpCiAgICAgIHRoYXQuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgfSBlbHNlIHsKICAgICAgLy8gRmFsbGJhY2s6IFJldHVybiBhbiBvYmplY3QgaW5zdGFuY2Ugb2YgdGhlIEJ1ZmZlciBjbGFzcwogICAgICBpZiAodGhhdCA9PT0gbnVsbCkgewogICAgICAgIHRoYXQgPSBuZXcgQnVmZmVyKGxlbmd0aCkKICAgICAgfQogICAgICB0aGF0Lmxlbmd0aCA9IGxlbmd0aAogICAgfQogIAogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgLyoqCiAgICogVGhlIEJ1ZmZlciBjb25zdHJ1Y3RvciByZXR1cm5zIGluc3RhbmNlcyBvZiBgVWludDhBcnJheWAgdGhhdCBoYXZlIHRoZWlyCiAgICogcHJvdG90eXBlIGNoYW5nZWQgdG8gYEJ1ZmZlci5wcm90b3R5cGVgLiBGdXJ0aGVybW9yZSwgYEJ1ZmZlcmAgaXMgYSBzdWJjbGFzcyBvZgogICAqIGBVaW50OEFycmF5YCwgc28gdGhlIHJldHVybmVkIGluc3RhbmNlcyB3aWxsIGhhdmUgYWxsIHRoZSBub2RlIGBCdWZmZXJgIG1ldGhvZHMKICAgKiBhbmQgdGhlIGBVaW50OEFycmF5YCBtZXRob2RzLiBTcXVhcmUgYnJhY2tldCBub3RhdGlvbiB3b3JrcyBhcyBleHBlY3RlZCAtLSBpdAogICAqIHJldHVybnMgYSBzaW5nbGUgb2N0ZXQuCiAgICoKICAgKiBUaGUgYFVpbnQ4QXJyYXlgIHByb3RvdHlwZSByZW1haW5zIHVubW9kaWZpZWQuCiAgICovCiAgCiAgZnVuY3Rpb24gQnVmZmVyIChhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJiAhKHRoaXMgaW5zdGFuY2VvZiBCdWZmZXIpKSB7CiAgICAgIHJldHVybiBuZXcgQnVmZmVyKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgLy8gQ29tbW9uIGNhc2UuCiAgICBpZiAodHlwZW9mIGFyZyA9PT0gJ251bWJlcicpIHsKICAgICAgaWYgKHR5cGVvZiBlbmNvZGluZ09yT2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICdJZiBlbmNvZGluZyBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycKICAgICAgICApCiAgICAgIH0KICAgICAgcmV0dXJuIGFsbG9jVW5zYWZlKHRoaXMsIGFyZykKICAgIH0KICAgIHJldHVybiBmcm9tKHRoaXMsIGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBCdWZmZXIucG9vbFNpemUgPSA4MTkyIC8vIG5vdCB1c2VkIGJ5IHRoaXMgaW1wbGVtZW50YXRpb24KICAKICAvLyBUT0RPOiBMZWdhY3ksIG5vdCBuZWVkZWQgYW55bW9yZS4gUmVtb3ZlIGluIG5leHQgbWFqb3IgdmVyc2lvbi4KICBCdWZmZXIuX2F1Z21lbnQgPSBmdW5jdGlvbiAoYXJyKSB7CiAgICBhcnIuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgcmV0dXJuIGFycgogIH0KICAKICBmdW5jdGlvbiBmcm9tICh0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIGEgbnVtYmVyJykKICAgIH0KICAKICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgICAgcmV0dXJuIGZyb21BcnJheUJ1ZmZlcih0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIGZyb21TdHJpbmcodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQpCiAgICB9CiAgCiAgICByZXR1cm4gZnJvbU9iamVjdCh0aGF0LCB2YWx1ZSkKICB9CiAgCiAgLyoqCiAgICogRnVuY3Rpb25hbGx5IGVxdWl2YWxlbnQgdG8gQnVmZmVyKGFyZywgZW5jb2RpbmcpIGJ1dCB0aHJvd3MgYSBUeXBlRXJyb3IKICAgKiBpZiB2YWx1ZSBpcyBhIG51bWJlci4KICAgKiBCdWZmZXIuZnJvbShzdHJbLCBlbmNvZGluZ10pCiAgICogQnVmZmVyLmZyb20oYXJyYXkpCiAgICogQnVmZmVyLmZyb20oYnVmZmVyKQogICAqIEJ1ZmZlci5mcm9tKGFycmF5QnVmZmVyWywgYnl0ZU9mZnNldFssIGxlbmd0aF1dKQogICAqKi8KICBCdWZmZXIuZnJvbSA9IGZ1bmN0aW9uICh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gZnJvbShudWxsLCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIEJ1ZmZlci5wcm90b3R5cGUuX19wcm90b19fID0gVWludDhBcnJheS5wcm90b3R5cGUKICAgIEJ1ZmZlci5fX3Byb3RvX18gPSBVaW50OEFycmF5CiAgICBpZiAodHlwZW9mIFN5bWJvbCAhPT0gJ3VuZGVmaW5lZCcgJiYgU3ltYm9sLnNwZWNpZXMgJiYKICAgICAgICBCdWZmZXJbU3ltYm9sLnNwZWNpZXNdID09PSBCdWZmZXIpIHsKICAgICAgLy8gRml4IHN1YmFycmF5KCkgaW4gRVMyMDE2LiBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyL3B1bGwvOTcKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEJ1ZmZlciwgU3ltYm9sLnNwZWNpZXMsIHsKICAgICAgICB2YWx1ZTogbnVsbCwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgfSkKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYXNzZXJ0U2l6ZSAoc2l6ZSkgewogICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpCiAgICB9IGVsc2UgaWYgKHNpemUgPCAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgbmVnYXRpdmUnKQogICAgfQogIH0KICAKICBmdW5jdGlvbiBhbGxvYyAodGhhdCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpIHsKICAgIGFzc2VydFNpemUoc2l6ZSkKICAgIGlmIChzaXplIDw9IDApIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKQogICAgfQogICAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBPbmx5IHBheSBhdHRlbnRpb24gdG8gZW5jb2RpbmcgaWYgaXQncyBhIHN0cmluZy4gVGhpcwogICAgICAvLyBwcmV2ZW50cyBhY2NpZGVudGFsbHkgc2VuZGluZyBpbiBhIG51bWJlciB0aGF0IHdvdWxkCiAgICAgIC8vIGJlIGludGVycHJldHRlZCBhcyBhIHN0YXJ0IG9mZnNldC4KICAgICAgcmV0dXJuIHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycKICAgICAgICA/IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKS5maWxsKGZpbGwsIGVuY29kaW5nKQogICAgICAgIDogY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpLmZpbGwoZmlsbCkKICAgIH0KICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkKICB9CiAgCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBmaWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqIGFsbG9jKHNpemVbLCBmaWxsWywgZW5jb2RpbmddXSkKICAgKiovCiAgQnVmZmVyLmFsbG9jID0gZnVuY3Rpb24gKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICByZXR1cm4gYWxsb2MobnVsbCwgc2l6ZSwgZmlsbCwgZW5jb2RpbmcpCiAgfQogIAogIGZ1bmN0aW9uIGFsbG9jVW5zYWZlICh0aGF0LCBzaXplKSB7CiAgICBhc3NlcnRTaXplKHNpemUpCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUgPCAwID8gMCA6IGNoZWNrZWQoc2l6ZSkgfCAwKQogICAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpemU7ICsraSkgewogICAgICAgIHRoYXRbaV0gPSAwCiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIC8qKgogICAqIEVxdWl2YWxlbnQgdG8gQnVmZmVyKG51bSksIGJ5IGRlZmF1bHQgY3JlYXRlcyBhIG5vbi16ZXJvLWZpbGxlZCBCdWZmZXIgaW5zdGFuY2UuCiAgICogKi8KICBCdWZmZXIuYWxsb2NVbnNhZmUgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCiAgfQogIC8qKgogICAqIEVxdWl2YWxlbnQgdG8gU2xvd0J1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqLwogIEJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cgPSBmdW5jdGlvbiAoc2l6ZSkgewogICAgcmV0dXJuIGFsbG9jVW5zYWZlKG51bGwsIHNpemUpCiAgfQogIAogIGZ1bmN0aW9uIGZyb21TdHJpbmcgKHRoYXQsIHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmICh0eXBlb2YgZW5jb2RpbmcgIT09ICdzdHJpbmcnIHx8IGVuY29kaW5nID09PSAnJykgewogICAgICBlbmNvZGluZyA9ICd1dGY4JwogICAgfQogIAogICAgaWYgKCFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImVuY29kaW5nIiBtdXN0IGJlIGEgdmFsaWQgc3RyaW5nIGVuY29kaW5nJykKICAgIH0KICAKICAgIHZhciBsZW5ndGggPSBieXRlTGVuZ3RoKHN0cmluZywgZW5jb2RpbmcpIHwgMAogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBsZW5ndGgpCiAgCiAgICB2YXIgYWN0dWFsID0gdGhhdC53cml0ZShzdHJpbmcsIGVuY29kaW5nKQogIAogICAgaWYgKGFjdHVhbCAhPT0gbGVuZ3RoKSB7CiAgICAgIC8vIFdyaXRpbmcgYSBoZXggc3RyaW5nLCBmb3IgZXhhbXBsZSwgdGhhdCBjb250YWlucyBpbnZhbGlkIGNoYXJhY3RlcnMgd2lsbAogICAgICAvLyBjYXVzZSBldmVyeXRoaW5nIGFmdGVyIHRoZSBmaXJzdCBpbnZhbGlkIGNoYXJhY3RlciB0byBiZSBpZ25vcmVkLiAoZS5nLgogICAgICAvLyAnYWJ4eGNkJyB3aWxsIGJlIHRyZWF0ZWQgYXMgJ2FiJykKICAgICAgdGhhdCA9IHRoYXQuc2xpY2UoMCwgYWN0dWFsKQogICAgfQogIAogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbUFycmF5TGlrZSAodGhhdCwgYXJyYXkpIHsKICAgIHZhciBsZW5ndGggPSBhcnJheS5sZW5ndGggPCAwID8gMCA6IGNoZWNrZWQoYXJyYXkubGVuZ3RoKSB8IDAKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuZ3RoKQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICB0aGF0W2ldID0gYXJyYXlbaV0gJiAyNTUKICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIGZ1bmN0aW9uIGZyb21BcnJheUJ1ZmZlciAodGhhdCwgYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkgewogICAgYXJyYXkuYnl0ZUxlbmd0aCAvLyB0aGlzIHRocm93cyBpZiBgYXJyYXlgIGlzIG5vdCBhIHZhbGlkIEFycmF5QnVmZmVyCiAgCiAgICBpZiAoYnl0ZU9mZnNldCA8IDAgfHwgYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1wnb2Zmc2V0XCcgaXMgb3V0IG9mIGJvdW5kcycpCiAgICB9CiAgCiAgICBpZiAoYXJyYXkuYnl0ZUxlbmd0aCA8IGJ5dGVPZmZzZXQgKyAobGVuZ3RoIHx8IDApKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdcJ2xlbmd0aFwnIGlzIG91dCBvZiBib3VuZHMnKQogICAgfQogIAogICAgaWYgKGJ5dGVPZmZzZXQgPT09IHVuZGVmaW5lZCAmJiBsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5KQogICAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5LCBieXRlT2Zmc2V0KQogICAgfSBlbHNlIHsKICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCwgbGVuZ3RoKQogICAgfQogIAogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlLCBmb3IgYmVzdCBwZXJmb3JtYW5jZQogICAgICB0aGF0ID0gYXJyYXkKICAgICAgdGhhdC5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICB9IGVsc2UgewogICAgICAvLyBGYWxsYmFjazogUmV0dXJuIGFuIG9iamVjdCBpbnN0YW5jZSBvZiB0aGUgQnVmZmVyIGNsYXNzCiAgICAgIHRoYXQgPSBmcm9tQXJyYXlMaWtlKHRoYXQsIGFycmF5KQogICAgfQogICAgcmV0dXJuIHRoYXQKICB9CiAgCiAgZnVuY3Rpb24gZnJvbU9iamVjdCAodGhhdCwgb2JqKSB7CiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKG9iaikpIHsKICAgICAgdmFyIGxlbiA9IGNoZWNrZWQob2JqLmxlbmd0aCkgfCAwCiAgICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuKQogIAogICAgICBpZiAodGhhdC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdGhhdAogICAgICB9CiAgCiAgICAgIG9iai5jb3B5KHRoYXQsIDAsIDAsIGxlbikKICAgICAgcmV0dXJuIHRoYXQKICAgIH0KICAKICAgIGlmIChvYmopIHsKICAgICAgaWYgKCh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICAgICAgICBvYmouYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHx8ICdsZW5ndGgnIGluIG9iaikgewogICAgICAgIGlmICh0eXBlb2Ygb2JqLmxlbmd0aCAhPT0gJ251bWJlcicgfHwgaXNuYW4ob2JqLmxlbmd0aCkpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgMCkKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyb21BcnJheUxpa2UodGhhdCwgb2JqKQogICAgICB9CiAgCiAgICAgIGlmIChvYmoudHlwZSA9PT0gJ0J1ZmZlcicgJiYgaXNBcnJheShvYmouZGF0YSkpIHsKICAgICAgICByZXR1cm4gZnJvbUFycmF5TGlrZSh0aGF0LCBvYmouZGF0YSkKICAgICAgfQogICAgfQogIAogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignRmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZywgQnVmZmVyLCBBcnJheUJ1ZmZlciwgQXJyYXksIG9yIGFycmF5LWxpa2Ugb2JqZWN0LicpCiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrZWQgKGxlbmd0aCkgewogICAgLy8gTm90ZTogY2Fubm90IHVzZSBgbGVuZ3RoIDwga01heExlbmd0aCgpYCBoZXJlIGJlY2F1c2UgdGhhdCBmYWlscyB3aGVuCiAgICAvLyBsZW5ndGggaXMgTmFOICh3aGljaCBpcyBvdGhlcndpc2UgY29lcmNlZCB0byB6ZXJvLikKICAgIGlmIChsZW5ndGggPj0ga01heExlbmd0aCgpKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAnc2l6ZTogMHgnICsga01heExlbmd0aCgpLnRvU3RyaW5nKDE2KSArICcgYnl0ZXMnKQogICAgfQogICAgcmV0dXJuIGxlbmd0aCB8IDAKICB9CiAgCiAgZnVuY3Rpb24gU2xvd0J1ZmZlciAobGVuZ3RoKSB7CiAgICBpZiAoK2xlbmd0aCAhPSBsZW5ndGgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBlcWVxZXEKICAgICAgbGVuZ3RoID0gMAogICAgfQogICAgcmV0dXJuIEJ1ZmZlci5hbGxvYygrbGVuZ3RoKQogIH0KICAKICBCdWZmZXIuaXNCdWZmZXIgPSBmdW5jdGlvbiBpc0J1ZmZlciAoYikgewogICAgcmV0dXJuICEhKGIgIT0gbnVsbCAmJiBiLl9pc0J1ZmZlcikKICB9CiAgCiAgQnVmZmVyLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlIChhLCBiKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihhKSB8fCAhQnVmZmVyLmlzQnVmZmVyKGIpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50cyBtdXN0IGJlIEJ1ZmZlcnMnKQogICAgfQogIAogICAgaWYgKGEgPT09IGIpIHJldHVybiAwCiAgCiAgICB2YXIgeCA9IGEubGVuZ3RoCiAgICB2YXIgeSA9IGIubGVuZ3RoCiAgCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gTWF0aC5taW4oeCwgeSk7IGkgPCBsZW47ICsraSkgewogICAgICBpZiAoYVtpXSAhPT0gYltpXSkgewogICAgICAgIHggPSBhW2ldCiAgICAgICAgeSA9IGJbaV0KICAgICAgICBicmVhawogICAgICB9CiAgICB9CiAgCiAgICBpZiAoeCA8IHkpIHJldHVybiAtMQogICAgaWYgKHkgPCB4KSByZXR1cm4gMQogICAgcmV0dXJuIDAKICB9CiAgCiAgQnVmZmVyLmlzRW5jb2RpbmcgPSBmdW5jdGlvbiBpc0VuY29kaW5nIChlbmNvZGluZykgewogICAgc3dpdGNoIChTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgY2FzZSAnaGV4JzoKICAgICAgY2FzZSAndXRmOCc6CiAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgY2FzZSAnYXNjaWknOgogICAgICBjYXNlICdsYXRpbjEnOgogICAgICBjYXNlICdiaW5hcnknOgogICAgICBjYXNlICdiYXNlNjQnOgogICAgICBjYXNlICd1Y3MyJzoKICAgICAgY2FzZSAndWNzLTInOgogICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgIHJldHVybiB0cnVlCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlCiAgICB9CiAgfQogIAogIEJ1ZmZlci5jb25jYXQgPSBmdW5jdGlvbiBjb25jYXQgKGxpc3QsIGxlbmd0aCkgewogICAgaWYgKCFpc0FycmF5KGxpc3QpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKQogICAgfQogIAogICAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBCdWZmZXIuYWxsb2MoMCkKICAgIH0KICAKICAgIHZhciBpCiAgICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgICAgbGVuZ3RoID0gMAogICAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgICAgIGxlbmd0aCArPSBsaXN0W2ldLmxlbmd0aAogICAgICB9CiAgICB9CiAgCiAgICB2YXIgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCkKICAgIHZhciBwb3MgPSAwCiAgICBmb3IgKGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7ICsraSkgewogICAgICB2YXIgYnVmID0gbGlzdFtpXQogICAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihidWYpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignImxpc3QiIGFyZ3VtZW50IG11c3QgYmUgYW4gQXJyYXkgb2YgQnVmZmVycycpCiAgICAgIH0KICAgICAgYnVmLmNvcHkoYnVmZmVyLCBwb3MpCiAgICAgIHBvcyArPSBidWYubGVuZ3RoCiAgICB9CiAgICByZXR1cm4gYnVmZmVyCiAgfQogIAogIGZ1bmN0aW9uIGJ5dGVMZW5ndGggKHN0cmluZywgZW5jb2RpbmcpIHsKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIoc3RyaW5nKSkgewogICAgICByZXR1cm4gc3RyaW5nLmxlbmd0aAogICAgfQogICAgaWYgKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIEFycmF5QnVmZmVyLmlzVmlldyA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgIChBcnJheUJ1ZmZlci5pc1ZpZXcoc3RyaW5nKSB8fCBzdHJpbmcgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikpIHsKICAgICAgcmV0dXJuIHN0cmluZy5ieXRlTGVuZ3RoCiAgICB9CiAgICBpZiAodHlwZW9mIHN0cmluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgc3RyaW5nID0gJycgKyBzdHJpbmcKICAgIH0KICAKICAgIHZhciBsZW4gPSBzdHJpbmcubGVuZ3RoCiAgICBpZiAobGVuID09PSAwKSByZXR1cm4gMAogIAogICAgLy8gVXNlIGEgZm9yIGxvb3AgdG8gYXZvaWQgcmVjdXJzaW9uCiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogICAgZm9yICg7OykgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsZW4KICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgICAgICByZXR1cm4gdXRmOFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGgKICAgICAgICBjYXNlICd1Y3MyJzoKICAgICAgICBjYXNlICd1Y3MtMic6CiAgICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgICAgY2FzZSAndXRmLTE2bGUnOgogICAgICAgICAgcmV0dXJuIGxlbiAqIDIKICAgICAgICBjYXNlICdoZXgnOgogICAgICAgICAgcmV0dXJuIGxlbiA+Pj4gMQogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICByZXR1cm4gYmFzZTY0VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBpZiAobG93ZXJlZENhc2UpIHJldHVybiB1dGY4VG9CeXRlcyhzdHJpbmcpLmxlbmd0aCAvLyBhc3N1bWUgdXRmOAogICAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CiAgQnVmZmVyLmJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoCiAgCiAgZnVuY3Rpb24gc2xvd1RvU3RyaW5nIChlbmNvZGluZywgc3RhcnQsIGVuZCkgewogICAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICAKICAgIC8vIE5vIG5lZWQgdG8gdmVyaWZ5IHRoYXQgInRoaXMubGVuZ3RoIDw9IE1BWF9VSU5UMzIiIHNpbmNlIGl0J3MgYSByZWFkLW9ubHkKICAgIC8vIHByb3BlcnR5IG9mIGEgdHlwZWQgYXJyYXkuCiAgCiAgICAvLyBUaGlzIGJlaGF2ZXMgbmVpdGhlciBsaWtlIFN0cmluZyBub3IgVWludDhBcnJheSBpbiB0aGF0IHdlIHNldCBzdGFydC9lbmQKICAgIC8vIHRvIHRoZWlyIHVwcGVyL2xvd2VyIGJvdW5kcyBpZiB0aGUgdmFsdWUgcGFzc2VkIGlzIG91dCBvZiByYW5nZS4KICAgIC8vIHVuZGVmaW5lZCBpcyBoYW5kbGVkIHNwZWNpYWxseSBhcyBwZXIgRUNNQS0yNjIgNnRoIEVkaXRpb24sCiAgICAvLyBTZWN0aW9uIDEzLjMuMy43IFJ1bnRpbWUgU2VtYW50aWNzOiBLZXllZEJpbmRpbmdJbml0aWFsaXphdGlvbi4KICAgIGlmIChzdGFydCA9PT0gdW5kZWZpbmVkIHx8IHN0YXJ0IDwgMCkgewogICAgICBzdGFydCA9IDAKICAgIH0KICAgIC8vIFJldHVybiBlYXJseSBpZiBzdGFydCA+IHRoaXMubGVuZ3RoLiBEb25lIGhlcmUgdG8gcHJldmVudCBwb3RlbnRpYWwgdWludDMyCiAgICAvLyBjb2VyY2lvbiBmYWlsIGJlbG93LgogICAgaWYgKHN0YXJ0ID4gdGhpcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICBpZiAoZW5kID09PSB1bmRlZmluZWQgfHwgZW5kID4gdGhpcy5sZW5ndGgpIHsKICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgIH0KICAKICAgIGlmIChlbmQgPD0gMCkgewogICAgICByZXR1cm4gJycKICAgIH0KICAKICAgIC8vIEZvcmNlIGNvZXJzaW9uIHRvIHVpbnQzMi4gVGhpcyB3aWxsIGFsc28gY29lcmNlIGZhbHNleS9OYU4gdmFsdWVzIHRvIDAuCiAgICBlbmQgPj4+PSAwCiAgICBzdGFydCA+Pj49IDAKICAKICAgIGlmIChlbmQgPD0gc3RhcnQpIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwogIAogICAgd2hpbGUgKHRydWUpIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgICByZXR1cm4gaGV4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgICByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgICAgcmV0dXJuIGFzY2lpU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gbGF0aW4xU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgICAgcmV0dXJuIGJhc2U2NFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiB1dGYxNmxlU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKICAKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgICBlbmNvZGluZyA9IChlbmNvZGluZyArICcnKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICAKICAvLyBUaGUgcHJvcGVydHkgaXMgdXNlZCBieSBgQnVmZmVyLmlzQnVmZmVyYCBhbmQgYGlzLWJ1ZmZlcmAgKGluIFNhZmFyaSA1LTcpIHRvIGRldGVjdAogIC8vIEJ1ZmZlciBpbnN0YW5jZXMuCiAgQnVmZmVyLnByb3RvdHlwZS5faXNCdWZmZXIgPSB0cnVlCiAgCiAgZnVuY3Rpb24gc3dhcCAoYiwgbiwgbSkgewogICAgdmFyIGkgPSBiW25dCiAgICBiW25dID0gYlttXQogICAgYlttXSA9IGkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwMTYgPSBmdW5jdGlvbiBzd2FwMTYgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgMiAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyAxKQogICAgfQogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zd2FwMzIgPSBmdW5jdGlvbiBzd2FwMzIgKCkgewogICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgICBpZiAobGVuICUgNCAhPT0gMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDMyLWJpdHMnKQogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gNCkgewogICAgICBzd2FwKHRoaXMsIGksIGkgKyAzKQogICAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgMikKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc3dhcDY0ID0gZnVuY3Rpb24gc3dhcDY0ICgpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgaWYgKGxlbiAlIDggIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA2NC1iaXRzJykKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDgpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgNykKICAgICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDYpCiAgICAgIHN3YXAodGhpcywgaSArIDIsIGkgKyA1KQogICAgICBzd2FwKHRoaXMsIGkgKyAzLCBpICsgNCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiB0b1N0cmluZyAoKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggfCAwCiAgICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gJycKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIDAsIGxlbmd0aCkKICAgIHJldHVybiBzbG93VG9TdHJpbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmVxdWFscyA9IGZ1bmN0aW9uIGVxdWFscyAoYikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogICAgaWYgKHRoaXMgPT09IGIpIHJldHVybiB0cnVlCiAgICByZXR1cm4gQnVmZmVyLmNvbXBhcmUodGhpcywgYikgPT09IDAKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbnNwZWN0ID0gZnVuY3Rpb24gaW5zcGVjdCAoKSB7CiAgICB2YXIgc3RyID0gJycKICAgIHZhciBtYXggPSBleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTCiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHN0ciA9IHRoaXMudG9TdHJpbmcoJ2hleCcsIDAsIG1heCkubWF0Y2goLy57Mn0vZykuam9pbignICcpCiAgICAgIGlmICh0aGlzLmxlbmd0aCA+IG1heCkgc3RyICs9ICcgLi4uICcKICAgIH0KICAgIHJldHVybiAnPEJ1ZmZlciAnICsgc3RyICsgJz4nCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuY29tcGFyZSA9IGZ1bmN0aW9uIGNvbXBhcmUgKHRhcmdldCwgc3RhcnQsIGVuZCwgdGhpc1N0YXJ0LCB0aGlzRW5kKSB7CiAgICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcih0YXJnZXQpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogICAgfQogIAogICAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgICAgc3RhcnQgPSAwCiAgICB9CiAgICBpZiAoZW5kID09PSB1bmRlZmluZWQpIHsKICAgICAgZW5kID0gdGFyZ2V0ID8gdGFyZ2V0Lmxlbmd0aCA6IDAKICAgIH0KICAgIGlmICh0aGlzU3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzU3RhcnQgPSAwCiAgICB9CiAgICBpZiAodGhpc0VuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHRoaXNFbmQgPSB0aGlzLmxlbmd0aAogICAgfQogIAogICAgaWYgKHN0YXJ0IDwgMCB8fCBlbmQgPiB0YXJnZXQubGVuZ3RoIHx8IHRoaXNTdGFydCA8IDAgfHwgdGhpc0VuZCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdvdXQgb2YgcmFuZ2UgaW5kZXgnKQogICAgfQogIAogICAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kICYmIHN0YXJ0ID49IGVuZCkgewogICAgICByZXR1cm4gMAogICAgfQogICAgaWYgKHRoaXNTdGFydCA+PSB0aGlzRW5kKSB7CiAgICAgIHJldHVybiAtMQogICAgfQogICAgaWYgKHN0YXJ0ID49IGVuZCkgewogICAgICByZXR1cm4gMQogICAgfQogIAogICAgc3RhcnQgPj4+PSAwCiAgICBlbmQgPj4+PSAwCiAgICB0aGlzU3RhcnQgPj4+PSAwCiAgICB0aGlzRW5kID4+Pj0gMAogIAogICAgaWYgKHRoaXMgPT09IHRhcmdldCkgcmV0dXJuIDAKICAKICAgIHZhciB4ID0gdGhpc0VuZCAtIHRoaXNTdGFydAogICAgdmFyIHkgPSBlbmQgLSBzdGFydAogICAgdmFyIGxlbiA9IE1hdGgubWluKHgsIHkpCiAgCiAgICB2YXIgdGhpc0NvcHkgPSB0aGlzLnNsaWNlKHRoaXNTdGFydCwgdGhpc0VuZCkKICAgIHZhciB0YXJnZXRDb3B5ID0gdGFyZ2V0LnNsaWNlKHN0YXJ0LCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmICh0aGlzQ29weVtpXSAhPT0gdGFyZ2V0Q29weVtpXSkgewogICAgICAgIHggPSB0aGlzQ29weVtpXQogICAgICAgIHkgPSB0YXJnZXRDb3B5W2ldCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIAogICAgaWYgKHggPCB5KSByZXR1cm4gLTEKICAgIGlmICh5IDwgeCkgcmV0dXJuIDEKICAgIHJldHVybiAwCiAgfQogIAogIC8vIEZpbmRzIGVpdGhlciB0aGUgZmlyc3QgaW5kZXggb2YgYHZhbGAgaW4gYGJ1ZmZlcmAgYXQgb2Zmc2V0ID49IGBieXRlT2Zmc2V0YCwKICAvLyBPUiB0aGUgbGFzdCBpbmRleCBvZiBgdmFsYCBpbiBgYnVmZmVyYCBhdCBvZmZzZXQgPD0gYGJ5dGVPZmZzZXRgLgogIC8vCiAgLy8gQXJndW1lbnRzOgogIC8vIC0gYnVmZmVyIC0gYSBCdWZmZXIgdG8gc2VhcmNoCiAgLy8gLSB2YWwgLSBhIHN0cmluZywgQnVmZmVyLCBvciBudW1iZXIKICAvLyAtIGJ5dGVPZmZzZXQgLSBhbiBpbmRleCBpbnRvIGBidWZmZXJgOyB3aWxsIGJlIGNsYW1wZWQgdG8gYW4gaW50MzIKICAvLyAtIGVuY29kaW5nIC0gYW4gb3B0aW9uYWwgZW5jb2RpbmcsIHJlbGV2YW50IGlzIHZhbCBpcyBhIHN0cmluZwogIC8vIC0gZGlyIC0gdHJ1ZSBmb3IgaW5kZXhPZiwgZmFsc2UgZm9yIGxhc3RJbmRleE9mCiAgZnVuY3Rpb24gYmlkaXJlY3Rpb25hbEluZGV4T2YgKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgICAvLyBFbXB0eSBidWZmZXIgbWVhbnMgbm8gbWF0Y2gKICAgIGlmIChidWZmZXIubGVuZ3RoID09PSAwKSByZXR1cm4gLTEKICAKICAgIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0CiAgICBpZiAodHlwZW9mIGJ5dGVPZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gYnl0ZU9mZnNldAogICAgICBieXRlT2Zmc2V0ID0gMAogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0ID4gMHg3ZmZmZmZmZikgewogICAgICBieXRlT2Zmc2V0ID0gMHg3ZmZmZmZmZgogICAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgLTB4ODAwMDAwMDApIHsKICAgICAgYnl0ZU9mZnNldCA9IC0weDgwMDAwMDAwCiAgICB9CiAgICBieXRlT2Zmc2V0ID0gK2J5dGVPZmZzZXQgIC8vIENvZXJjZSB0byBOdW1iZXIuCiAgICBpZiAoaXNOYU4oYnl0ZU9mZnNldCkpIHsKICAgICAgLy8gYnl0ZU9mZnNldDogaXQgaXQncyB1bmRlZmluZWQsIG51bGwsIE5hTiwgImZvbyIsIGV0Yywgc2VhcmNoIHdob2xlIGJ1ZmZlcgogICAgICBieXRlT2Zmc2V0ID0gZGlyID8gMCA6IChidWZmZXIubGVuZ3RoIC0gMSkKICAgIH0KICAKICAgIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0OiBuZWdhdGl2ZSBvZmZzZXRzIHN0YXJ0IGZyb20gdGhlIGVuZCBvZiB0aGUgYnVmZmVyCiAgICBpZiAoYnl0ZU9mZnNldCA8IDApIGJ5dGVPZmZzZXQgPSBidWZmZXIubGVuZ3RoICsgYnl0ZU9mZnNldAogICAgaWYgKGJ5dGVPZmZzZXQgPj0gYnVmZmVyLmxlbmd0aCkgewogICAgICBpZiAoZGlyKSByZXR1cm4gLTEKICAgICAgZWxzZSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCAtIDEKICAgIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA8IDApIHsKICAgICAgaWYgKGRpcikgYnl0ZU9mZnNldCA9IDAKICAgICAgZWxzZSByZXR1cm4gLTEKICAgIH0KICAKICAgIC8vIE5vcm1hbGl6ZSB2YWwKICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICB2YWwgPSBCdWZmZXIuZnJvbSh2YWwsIGVuY29kaW5nKQogICAgfQogIAogICAgLy8gRmluYWxseSwgc2VhcmNoIGVpdGhlciBpbmRleE9mIChpZiBkaXIgaXMgdHJ1ZSkgb3IgbGFzdEluZGV4T2YKICAgIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsKSkgewogICAgICAvLyBTcGVjaWFsIGNhc2U6IGxvb2tpbmcgZm9yIGVtcHR5IHN0cmluZy9idWZmZXIgYWx3YXlzIGZhaWxzCiAgICAgIGlmICh2YWwubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIC0xCiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgdmFsID0gdmFsICYgMHhGRiAvLyBTZWFyY2ggZm9yIGEgYnl0ZSB2YWx1ZSBbMC0yNTVdCiAgICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJgogICAgICAgICAgdHlwZW9mIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBpZiAoZGlyKSB7CiAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUubGFzdEluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIFsgdmFsIF0sIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpCiAgICB9CiAgCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd2YWwgbXVzdCBiZSBzdHJpbmcsIG51bWJlciBvciBCdWZmZXInKQogIH0KICAKICBmdW5jdGlvbiBhcnJheUluZGV4T2YgKGFyciwgdmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKSB7CiAgICB2YXIgaW5kZXhTaXplID0gMQogICAgdmFyIGFyckxlbmd0aCA9IGFyci5sZW5ndGgKICAgIHZhciB2YWxMZW5ndGggPSB2YWwubGVuZ3RoCiAgCiAgICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCkgewogICAgICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICBpZiAoZW5jb2RpbmcgPT09ICd1Y3MyJyB8fCBlbmNvZGluZyA9PT0gJ3Vjcy0yJyB8fAogICAgICAgICAgZW5jb2RpbmcgPT09ICd1dGYxNmxlJyB8fCBlbmNvZGluZyA9PT0gJ3V0Zi0xNmxlJykgewogICAgICAgIGlmIChhcnIubGVuZ3RoIDwgMiB8fCB2YWwubGVuZ3RoIDwgMikgewogICAgICAgICAgcmV0dXJuIC0xCiAgICAgICAgfQogICAgICAgIGluZGV4U2l6ZSA9IDIKICAgICAgICBhcnJMZW5ndGggLz0gMgogICAgICAgIHZhbExlbmd0aCAvPSAyCiAgICAgICAgYnl0ZU9mZnNldCAvPSAyCiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIHJlYWQgKGJ1ZiwgaSkgewogICAgICBpZiAoaW5kZXhTaXplID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGJ1ZltpXQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBidWYucmVhZFVJbnQxNkJFKGkgKiBpbmRleFNpemUpCiAgICAgIH0KICAgIH0KICAKICAgIHZhciBpCiAgICBpZiAoZGlyKSB7CiAgICAgIHZhciBmb3VuZEluZGV4ID0gLTEKICAgICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA8IGFyckxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJlYWQoYXJyLCBpKSA9PT0gcmVhZCh2YWwsIGZvdW5kSW5kZXggPT09IC0xID8gMCA6IGkgLSBmb3VuZEluZGV4KSkgewogICAgICAgICAgaWYgKGZvdW5kSW5kZXggPT09IC0xKSBmb3VuZEluZGV4ID0gaQogICAgICAgICAgaWYgKGkgLSBmb3VuZEluZGV4ICsgMSA9PT0gdmFsTGVuZ3RoKSByZXR1cm4gZm91bmRJbmRleCAqIGluZGV4U2l6ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZm91bmRJbmRleCAhPT0gLTEpIGkgLT0gaSAtIGZvdW5kSW5kZXgKICAgICAgICAgIGZvdW5kSW5kZXggPSAtMQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGJ5dGVPZmZzZXQgKyB2YWxMZW5ndGggPiBhcnJMZW5ndGgpIGJ5dGVPZmZzZXQgPSBhcnJMZW5ndGggLSB2YWxMZW5ndGgKICAgICAgZm9yIChpID0gYnl0ZU9mZnNldDsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB2YXIgZm91bmQgPSB0cnVlCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB2YWxMZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHJlYWQoYXJyLCBpICsgaikgIT09IHJlYWQodmFsLCBqKSkgewogICAgICAgICAgICBmb3VuZCA9IGZhbHNlCiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChmb3VuZCkgcmV0dXJuIGkKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIC0xCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuaW5jbHVkZXMgPSBmdW5jdGlvbiBpbmNsdWRlcyAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIHRoaXMuaW5kZXhPZih2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSAhPT0gLTEKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24gaW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIHRydWUpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUubGFzdEluZGV4T2YgPSBmdW5jdGlvbiBsYXN0SW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogICAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGZhbHNlKQogIH0KICAKICBmdW5jdGlvbiBoZXhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICBvZmZzZXQgPSBOdW1iZXIob2Zmc2V0KSB8fCAwCiAgICB2YXIgcmVtYWluaW5nID0gYnVmLmxlbmd0aCAtIG9mZnNldAogICAgaWYgKCFsZW5ndGgpIHsKICAgICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgICB9IGVsc2UgewogICAgICBsZW5ndGggPSBOdW1iZXIobGVuZ3RoKQogICAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgICAgIH0KICAgIH0KICAKICAgIC8vIG11c3QgYmUgYW4gZXZlbiBudW1iZXIgb2YgZGlnaXRzCiAgICB2YXIgc3RyTGVuID0gc3RyaW5nLmxlbmd0aAogICAgaWYgKHN0ckxlbiAlIDIgIT09IDApIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCiAgCiAgICBpZiAobGVuZ3RoID4gc3RyTGVuIC8gMikgewogICAgICBsZW5ndGggPSBzdHJMZW4gLyAyCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIHZhciBwYXJzZWQgPSBwYXJzZUludChzdHJpbmcuc3Vic3RyKGkgKiAyLCAyKSwgMTYpCiAgICAgIGlmIChpc05hTihwYXJzZWQpKSByZXR1cm4gaQogICAgICBidWZbb2Zmc2V0ICsgaV0gPSBwYXJzZWQKICAgIH0KICAgIHJldHVybiBpCiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcih1dGY4VG9CeXRlcyhzdHJpbmcsIGJ1Zi5sZW5ndGggLSBvZmZzZXQpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBhc2NpaVdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKGFzY2lpVG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBsYXRpbjFXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYXNjaWlXcml0ZShidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKGJhc2U2NFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gdWNzMldyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIHJldHVybiBibGl0QnVmZmVyKHV0ZjE2bGVUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiB3cml0ZSAoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcpCiAgICBpZiAob2Zmc2V0ID09PSB1bmRlZmluZWQpIHsKICAgICAgZW5jb2RpbmcgPSAndXRmOCcKICAgICAgbGVuZ3RoID0gdGhpcy5sZW5ndGgKICAgICAgb2Zmc2V0ID0gMAogICAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgZW5jb2RpbmcpCiAgICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvZmZzZXQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gb2Zmc2V0CiAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICAgIG9mZnNldCA9IDAKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcsIG9mZnNldFssIGxlbmd0aF1bLCBlbmNvZGluZ10pCiAgICB9IGVsc2UgaWYgKGlzRmluaXRlKG9mZnNldCkpIHsKICAgICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgICBpZiAoaXNGaW5pdGUobGVuZ3RoKSkgewogICAgICAgIGxlbmd0aCA9IGxlbmd0aCB8IDAKICAgICAgICBpZiAoZW5jb2RpbmcgPT09IHVuZGVmaW5lZCkgZW5jb2RpbmcgPSAndXRmOCcKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmNvZGluZyA9IGxlbmd0aAogICAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZAogICAgICB9CiAgICAvLyBsZWdhY3kgd3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0LCBsZW5ndGgpIC0gcmVtb3ZlIGluIHYwLjEzCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ0J1ZmZlci53cml0ZShzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXRbLCBsZW5ndGhdKSBpcyBubyBsb25nZXIgc3VwcG9ydGVkJwogICAgICApCiAgICB9CiAgCiAgICB2YXIgcmVtYWluaW5nID0gdGhpcy5sZW5ndGggLSBvZmZzZXQKICAgIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCB8fCBsZW5ndGggPiByZW1haW5pbmcpIGxlbmd0aCA9IHJlbWFpbmluZwogIAogICAgaWYgKChzdHJpbmcubGVuZ3RoID4gMCAmJiAobGVuZ3RoIDwgMCB8fCBvZmZzZXQgPCAwKSkgfHwgb2Zmc2V0ID4gdGhpcy5sZW5ndGgpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0F0dGVtcHQgdG8gd3JpdGUgb3V0c2lkZSBidWZmZXIgYm91bmRzJykKICAgIH0KICAKICAgIGlmICghZW5jb2RpbmcpIGVuY29kaW5nID0gJ3V0ZjgnCiAgCiAgICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQogICAgZm9yICg7OykgewogICAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBoZXhXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICAgIHJldHVybiB1dGY4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgICByZXR1cm4gYXNjaWlXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICAgIHJldHVybiBsYXRpbjFXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgICAvLyBXYXJuaW5nOiBtYXhMZW5ndGggbm90IHRha2VuIGludG8gYWNjb3VudCBpbiBiYXNlNjRXcml0ZQogICAgICAgICAgcmV0dXJuIGJhc2U2NFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiB1Y3MyV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgICAgfQogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTiAoKSB7CiAgICByZXR1cm4gewogICAgICB0eXBlOiAnQnVmZmVyJywKICAgICAgZGF0YTogQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fYXJyIHx8IHRoaXMsIDApCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIGlmIChzdGFydCA9PT0gMCAmJiBlbmQgPT09IGJ1Zi5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1ZikKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYuc2xpY2Uoc3RhcnQsIGVuZCkpCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgICB2YXIgcmVzID0gW10KICAKICAgIHZhciBpID0gc3RhcnQKICAgIHdoaWxlIChpIDwgZW5kKSB7CiAgICAgIHZhciBmaXJzdEJ5dGUgPSBidWZbaV0KICAgICAgdmFyIGNvZGVQb2ludCA9IG51bGwKICAgICAgdmFyIGJ5dGVzUGVyU2VxdWVuY2UgPSAoZmlyc3RCeXRlID4gMHhFRikgPyA0CiAgICAgICAgOiAoZmlyc3RCeXRlID4gMHhERikgPyAzCiAgICAgICAgOiAoZmlyc3RCeXRlID4gMHhCRikgPyAyCiAgICAgICAgOiAxCiAgCiAgICAgIGlmIChpICsgYnl0ZXNQZXJTZXF1ZW5jZSA8PSBlbmQpIHsKICAgICAgICB2YXIgc2Vjb25kQnl0ZSwgdGhpcmRCeXRlLCBmb3VydGhCeXRlLCB0ZW1wQ29kZVBvaW50CiAgCiAgICAgICAgc3dpdGNoIChieXRlc1BlclNlcXVlbmNlKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGlmIChmaXJzdEJ5dGUgPCAweDgwKSB7CiAgICAgICAgICAgICAgY29kZVBvaW50ID0gZmlyc3RCeXRlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4MUYpIDw8IDB4NiB8IChzZWNvbmRCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0YpIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgc2Vjb25kQnl0ZSA9IGJ1ZltpICsgMV0KICAgICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXQogICAgICAgICAgICBpZiAoKHNlY29uZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAodGhpcmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHhDIHwgKHNlY29uZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAodGhpcmRCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0ZGICYmICh0ZW1wQ29kZVBvaW50IDwgMHhEODAwIHx8IHRlbXBDb2RlUG9pbnQgPiAweERGRkYpKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl0KICAgICAgICAgICAgZm91cnRoQnl0ZSA9IGJ1ZltpICsgM10KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwICYmIChmb3VydGhCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgICB0ZW1wQ29kZVBvaW50ID0gKGZpcnN0Qnl0ZSAmIDB4RikgPDwgMHgxMiB8IChzZWNvbmRCeXRlICYgMHgzRikgPDwgMHhDIHwgKHRoaXJkQnl0ZSAmIDB4M0YpIDw8IDB4NiB8IChmb3VydGhCeXRlICYgMHgzRikKICAgICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4RkZGRiAmJiB0ZW1wQ29kZVBvaW50IDwgMHgxMTAwMDApIHsKICAgICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKGNvZGVQb2ludCA9PT0gbnVsbCkgewogICAgICAgIC8vIHdlIGRpZCBub3QgZ2VuZXJhdGUgYSB2YWxpZCBjb2RlUG9pbnQgc28gaW5zZXJ0IGEKICAgICAgICAvLyByZXBsYWNlbWVudCBjaGFyIChVK0ZGRkQpIGFuZCBhZHZhbmNlIG9ubHkgMSBieXRlCiAgICAgICAgY29kZVBvaW50ID0gMHhGRkZECiAgICAgICAgYnl0ZXNQZXJTZXF1ZW5jZSA9IDEKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPiAweEZGRkYpIHsKICAgICAgICAvLyBlbmNvZGUgdG8gdXRmMTYgKHN1cnJvZ2F0ZSBwYWlyIGRhbmNlKQogICAgICAgIGNvZGVQb2ludCAtPSAweDEwMDAwCiAgICAgICAgcmVzLnB1c2goY29kZVBvaW50ID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKQogICAgICAgIGNvZGVQb2ludCA9IDB4REMwMCB8IGNvZGVQb2ludCAmIDB4M0ZGCiAgICAgIH0KICAKICAgICAgcmVzLnB1c2goY29kZVBvaW50KQogICAgICBpICs9IGJ5dGVzUGVyU2VxdWVuY2UKICAgIH0KICAKICAgIHJldHVybiBkZWNvZGVDb2RlUG9pbnRzQXJyYXkocmVzKQogIH0KICAKICAvLyBCYXNlZCBvbiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8yMjc0NzI3Mi82ODA3NDIsIHRoZSBicm93c2VyIHdpdGgKICAvLyB0aGUgbG93ZXN0IGxpbWl0IGlzIENocm9tZSwgd2l0aCAweDEwMDAwIGFyZ3MuCiAgLy8gV2UgZ28gMSBtYWduaXR1ZGUgbGVzcywgZm9yIHNhZmV0eQogIHZhciBNQVhfQVJHVU1FTlRTX0xFTkdUSCA9IDB4MTAwMAogIAogIGZ1bmN0aW9uIGRlY29kZUNvZGVQb2ludHNBcnJheSAoY29kZVBvaW50cykgewogICAgdmFyIGxlbiA9IGNvZGVQb2ludHMubGVuZ3RoCiAgICBpZiAobGVuIDw9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKSB7CiAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY29kZVBvaW50cykgLy8gYXZvaWQgZXh0cmEgc2xpY2UoKQogICAgfQogIAogICAgLy8gRGVjb2RlIGluIGNodW5rcyB0byBhdm9pZCAiY2FsbCBzdGFjayBzaXplIGV4Y2VlZGVkIi4KICAgIHZhciByZXMgPSAnJwogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoaSA8IGxlbikgewogICAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseSgKICAgICAgICBTdHJpbmcsCiAgICAgICAgY29kZVBvaW50cy5zbGljZShpLCBpICs9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKQogICAgICApCiAgICB9CiAgICByZXR1cm4gcmVzCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIHJldCA9ICcnCiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0gJiAweDdGKQogICAgfQogICAgcmV0dXJuIHJldAogIH0KICAKICBmdW5jdGlvbiBsYXRpbjFTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgcmV0ID0gJycKICAgIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKICAKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSkKICAgIH0KICAgIHJldHVybiByZXQKICB9CiAgCiAgZnVuY3Rpb24gaGV4U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIGxlbiA9IGJ1Zi5sZW5ndGgKICAKICAgIGlmICghc3RhcnQgfHwgc3RhcnQgPCAwKSBzdGFydCA9IDAKICAgIGlmICghZW5kIHx8IGVuZCA8IDAgfHwgZW5kID4gbGVuKSBlbmQgPSBsZW4KICAKICAgIHZhciBvdXQgPSAnJwogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgb3V0ICs9IHRvSGV4KGJ1ZltpXSkKICAgIH0KICAgIHJldHVybiBvdXQKICB9CiAgCiAgZnVuY3Rpb24gdXRmMTZsZVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKQogICAgdmFyIHJlcyA9ICcnCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldICsgYnl0ZXNbaSArIDFdICogMjU2KQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2UgKHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgc3RhcnQgPSB+fnN0YXJ0CiAgICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IGxlbiA6IH5+ZW5kCiAgCiAgICBpZiAoc3RhcnQgPCAwKSB7CiAgICAgIHN0YXJ0ICs9IGxlbgogICAgICBpZiAoc3RhcnQgPCAwKSBzdGFydCA9IDAKICAgIH0gZWxzZSBpZiAoc3RhcnQgPiBsZW4pIHsKICAgICAgc3RhcnQgPSBsZW4KICAgIH0KICAKICAgIGlmIChlbmQgPCAwKSB7CiAgICAgIGVuZCArPSBsZW4KICAgICAgaWYgKGVuZCA8IDApIGVuZCA9IDAKICAgIH0gZWxzZSBpZiAoZW5kID4gbGVuKSB7CiAgICAgIGVuZCA9IGxlbgogICAgfQogIAogICAgaWYgKGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydAogIAogICAgdmFyIG5ld0J1ZgogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIG5ld0J1ZiA9IHRoaXMuc3ViYXJyYXkoc3RhcnQsIGVuZCkKICAgICAgbmV3QnVmLl9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIH0gZWxzZSB7CiAgICAgIHZhciBzbGljZUxlbiA9IGVuZCAtIHN0YXJ0CiAgICAgIG5ld0J1ZiA9IG5ldyBCdWZmZXIoc2xpY2VMZW4sIHVuZGVmaW5lZCkKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzbGljZUxlbjsgKytpKSB7CiAgICAgICAgbmV3QnVmW2ldID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBuZXdCdWYKICB9CiAgCiAgLyoKICAgKiBOZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IGJ1ZmZlciBpc24ndCB0cnlpbmcgdG8gd3JpdGUgb3V0IG9mIGJvdW5kcy4KICAgKi8KICBmdW5jdGlvbiBjaGVja09mZnNldCAob2Zmc2V0LCBleHQsIGxlbmd0aCkgewogICAgaWYgKChvZmZzZXQgJSAxKSAhPT0gMCB8fCBvZmZzZXQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG5vdCB1aW50JykKICAgIGlmIChvZmZzZXQgKyBleHQgPiBsZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoJykKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludExFID0gZnVuY3Rpb24gcmVhZFVJbnRMRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIAogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XQogICAgdmFyIG11bCA9IDEKICAgIHZhciBpID0gMAogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgaV0gKiBtdWwKICAgIH0KICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludEJFID0gZnVuY3Rpb24gcmVhZFVJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgICB9CiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdCiAgICB2YXIgbXVsID0gMQogICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aF0gKiBtdWwKICAgIH0KICAKICAgIHJldHVybiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDggPSBmdW5jdGlvbiByZWFkVUludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gdGhpc1tvZmZzZXRdCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkxFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkJFID0gZnVuY3Rpb24gcmVhZFVJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgOCkgfCB0aGlzW29mZnNldCArIDFdCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkxFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIAogICAgcmV0dXJuICgodGhpc1tvZmZzZXRdKSB8CiAgICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSkgKwogICAgICAgICh0aGlzW29mZnNldCArIDNdICogMHgxMDAwMDAwKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJCRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdICogMHgxMDAwMDAwKSArCiAgICAgICgodGhpc1tvZmZzZXQgKyAxXSA8PCAxNikgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CiAgICAgIHRoaXNbb2Zmc2V0ICsgM10pCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludExFID0gZnVuY3Rpb24gcmVhZEludExFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bAogICAgfQogICAgbXVsICo9IDB4ODAKICAKICAgIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludEJFID0gZnVuY3Rpb24gcmVhZEludEJFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGgKICAgIHZhciBtdWwgPSAxCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWldCiAgICB3aGlsZSAoaSA+IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1pXSAqIG11bAogICAgfQogICAgbXVsICo9IDB4ODAKICAKICAgIGlmICh2YWwgPj0gbXVsKSB2YWwgLT0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpCiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDggPSBmdW5jdGlvbiByZWFkSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAxLCB0aGlzLmxlbmd0aCkKICAgIGlmICghKHRoaXNbb2Zmc2V0XSAmIDB4ODApKSByZXR1cm4gKHRoaXNbb2Zmc2V0XSkKICAgIHJldHVybiAoKDB4ZmYgLSB0aGlzW29mZnNldF0gKyAxKSAqIC0xKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkxFID0gZnVuY3Rpb24gcmVhZEludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgICB2YXIgdmFsID0gdGhpc1tvZmZzZXRdIHwgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkKICAgIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgMV0gfCAodGhpc1tvZmZzZXRdIDw8IDgpCiAgICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUgPSBmdW5jdGlvbiByZWFkSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdKSB8CiAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gPDwgMjQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyQkUgPSBmdW5jdGlvbiByZWFkSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAodGhpc1tvZmZzZXRdIDw8IDI0KSB8CiAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10pCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0TEUgPSBmdW5jdGlvbiByZWFkRmxvYXRMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCB0cnVlLCAyMywgNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRCRSA9IGZ1bmN0aW9uIHJlYWRGbG9hdEJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCAyMywgNCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkRG91YmxlTEUgPSBmdW5jdGlvbiByZWFkRG91YmxlTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgNTIsIDgpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZERvdWJsZUJFID0gZnVuY3Rpb24gcmVhZERvdWJsZUJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCA1MiwgOCkKICB9CiAgCiAgZnVuY3Rpb24gY2hlY2tJbnQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpCiAgICBpZiAodmFsdWUgPiBtYXggfHwgdmFsdWUgPCBtaW4pIHRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKQogICAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludExFID0gZnVuY3Rpb24gd3JpdGVVSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDEKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbWF4Qnl0ZXMsIDApCiAgICB9CiAgCiAgICB2YXIgbXVsID0gMQogICAgdmFyIGkgPSAwCiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAodmFsdWUgLyBtdWwpICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlVUludEJFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG1heEJ5dGVzLCAwKQogICAgfQogIAogICAgdmFyIGkgPSBieXRlTGVuZ3RoIC0gMQogICAgdmFyIG11bCA9IDEKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50OCA9IGZ1bmN0aW9uIHdyaXRlVUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMHhmZiwgMCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICByZXR1cm4gb2Zmc2V0ICsgMQogIH0KICAKICBmdW5jdGlvbiBvYmplY3RXcml0ZVVJbnQxNiAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4pIHsKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmICsgdmFsdWUgKyAxCiAgICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKGJ1Zi5sZW5ndGggLSBvZmZzZXQsIDIpOyBpIDwgajsgKytpKSB7CiAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9ICh2YWx1ZSAmICgweGZmIDw8ICg4ICogKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkpKSkgPj4+CiAgICAgICAgKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkgKiA4CiAgICB9CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHhmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVVSW50MTZCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MzIgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICAgIGZvciAodmFyIGkgPSAwLCBqID0gTWF0aC5taW4oYnVmLmxlbmd0aCAtIG9mZnNldCwgNCk7IGkgPCBqOyArK2kpIHsKICAgICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlID4+PiAobGl0dGxlRW5kaWFuID8gaSA6IDMgLSBpKSAqIDgpICYgMHhmZgogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4ZmZmZmZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDE2KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJCRSA9IGZ1bmN0aW9uIHdyaXRlVUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbGltaXQgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCAtIDEpCiAgCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KQogICAgfQogIAogICAgdmFyIGkgPSAwCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHN1YiA9IDAKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMHhGRgogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgaWYgKHZhbHVlIDwgMCAmJiBzdWIgPT09IDAgJiYgdGhpc1tvZmZzZXQgKyBpIC0gMV0gIT09IDApIHsKICAgICAgICBzdWIgPSAxCiAgICAgIH0KICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICgodmFsdWUgLyBtdWwpID4+IDApIC0gc3ViICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludEJFID0gZnVuY3Rpb24gd3JpdGVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIHZhciBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoIC0gMSkKICAKICAgICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbGltaXQgLSAxLCAtbGltaXQpCiAgICB9CiAgCiAgICB2YXIgaSA9IGJ5dGVMZW5ndGggLSAxCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHN1YiA9IDAKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgKyAxXSAhPT0gMCkgewogICAgICAgIHN1YiA9IDEKICAgICAgfQogICAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50OCA9IGZ1bmN0aW9uIHdyaXRlSW50OCAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweDdmLCAtMHg4MCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICAgIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZiArIHZhbHVlICsgMQogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHJldHVybiBvZmZzZXQgKyAxCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkxFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MzJMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHg3ZmZmZmZmZiwgLTB4ODAwMDAwMDApCiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrSUVFRTc1NCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgICBpZiAob2Zmc2V0IDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgfQogIAogIGZ1bmN0aW9uIHdyaXRlRmxvYXQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA0LCAzLjQwMjgyMzQ2NjM4NTI4ODZlKzM4LCAtMy40MDI4MjM0NjYzODUyODg2ZSszOCkKICAgIH0KICAgIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDIzLCA0KQogICAgcmV0dXJuIG9mZnNldCArIDQKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0TEUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0QkUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVGbG9hdCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCiAgfQogIAogIGZ1bmN0aW9uIHdyaXRlRG91YmxlIChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgOCwgMS43OTc2OTMxMzQ4NjIzMTU3RSszMDgsIC0xLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCkKICAgIH0KICAgIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDUyLCA4KQogICAgcmV0dXJuIG9mZnNldCArIDgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUxFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUJFID0gZnVuY3Rpb24gd3JpdGVEb3VibGVCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCiAgfQogIAogIC8vIGNvcHkodGFyZ2V0QnVmZmVyLCB0YXJnZXRTdGFydD0wLCBzb3VyY2VTdGFydD0wLCBzb3VyY2VFbmQ9YnVmZmVyLmxlbmd0aCkKICBCdWZmZXIucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiBjb3B5ICh0YXJnZXQsIHRhcmdldFN0YXJ0LCBzdGFydCwgZW5kKSB7CiAgICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICAgIGlmICghZW5kICYmIGVuZCAhPT0gMCkgZW5kID0gdGhpcy5sZW5ndGgKICAgIGlmICh0YXJnZXRTdGFydCA+PSB0YXJnZXQubGVuZ3RoKSB0YXJnZXRTdGFydCA9IHRhcmdldC5sZW5ndGgKICAgIGlmICghdGFyZ2V0U3RhcnQpIHRhcmdldFN0YXJ0ID0gMAogICAgaWYgKGVuZCA+IDAgJiYgZW5kIDwgc3RhcnQpIGVuZCA9IHN0YXJ0CiAgCiAgICAvLyBDb3B5IDAgYnl0ZXM7IHdlJ3JlIGRvbmUKICAgIGlmIChlbmQgPT09IHN0YXJ0KSByZXR1cm4gMAogICAgaWYgKHRhcmdldC5sZW5ndGggPT09IDAgfHwgdGhpcy5sZW5ndGggPT09IDApIHJldHVybiAwCiAgCiAgICAvLyBGYXRhbCBlcnJvciBjb25kaXRpb25zCiAgICBpZiAodGFyZ2V0U3RhcnQgPCAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCd0YXJnZXRTdGFydCBvdXQgb2YgYm91bmRzJykKICAgIH0KICAgIGlmIChzdGFydCA8IDAgfHwgc3RhcnQgPj0gdGhpcy5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdzb3VyY2VTdGFydCBvdXQgb2YgYm91bmRzJykKICAgIGlmIChlbmQgPCAwKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlRW5kIG91dCBvZiBib3VuZHMnKQogIAogICAgLy8gQXJlIHdlIG9vYj8KICAgIGlmIChlbmQgPiB0aGlzLmxlbmd0aCkgZW5kID0gdGhpcy5sZW5ndGgKICAgIGlmICh0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgPCBlbmQgLSBzdGFydCkgewogICAgICBlbmQgPSB0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgKyBzdGFydAogICAgfQogIAogICAgdmFyIGxlbiA9IGVuZCAtIHN0YXJ0CiAgICB2YXIgaQogIAogICAgaWYgKHRoaXMgPT09IHRhcmdldCAmJiBzdGFydCA8IHRhcmdldFN0YXJ0ICYmIHRhcmdldFN0YXJ0IDwgZW5kKSB7CiAgICAgIC8vIGRlc2NlbmRpbmcgY29weSBmcm9tIGVuZAogICAgICBmb3IgKGkgPSBsZW4gLSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHRhcmdldFtpICsgdGFyZ2V0U3RhcnRdID0gdGhpc1tpICsgc3RhcnRdCiAgICAgIH0KICAgIH0gZWxzZSBpZiAobGVuIDwgMTAwMCB8fCAhQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgLy8gYXNjZW5kaW5nIGNvcHkgZnJvbSBzdGFydAogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB0YXJnZXRbaSArIHRhcmdldFN0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbCgKICAgICAgICB0YXJnZXQsCiAgICAgICAgdGhpcy5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBsZW4pLAogICAgICAgIHRhcmdldFN0YXJ0CiAgICAgICkKICAgIH0KICAKICAgIHJldHVybiBsZW4KICB9CiAgCiAgLy8gVXNhZ2U6CiAgLy8gICAgYnVmZmVyLmZpbGwobnVtYmVyWywgb2Zmc2V0WywgZW5kXV0pCiAgLy8gICAgYnVmZmVyLmZpbGwoYnVmZmVyWywgb2Zmc2V0WywgZW5kXV0pCiAgLy8gICAgYnVmZmVyLmZpbGwoc3RyaW5nWywgb2Zmc2V0WywgZW5kXV1bLCBlbmNvZGluZ10pCiAgQnVmZmVyLnByb3RvdHlwZS5maWxsID0gZnVuY3Rpb24gZmlsbCAodmFsLCBzdGFydCwgZW5kLCBlbmNvZGluZykgewogICAgLy8gSGFuZGxlIHN0cmluZyBjYXNlczoKICAgIGlmICh0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAnc3RyaW5nJykgewogICAgICAgIGVuY29kaW5nID0gc3RhcnQKICAgICAgICBzdGFydCA9IDAKICAgICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZW5jb2RpbmcgPSBlbmQKICAgICAgICBlbmQgPSB0aGlzLmxlbmd0aAogICAgICB9CiAgICAgIGlmICh2YWwubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdmFyIGNvZGUgPSB2YWwuY2hhckNvZGVBdCgwKQogICAgICAgIGlmIChjb2RlIDwgMjU2KSB7CiAgICAgICAgICB2YWwgPSBjb2RlCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChlbmNvZGluZyAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdlbmNvZGluZyBtdXN0IGJlIGEgc3RyaW5nJykKICAgICAgfQogICAgICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnc3RyaW5nJyAmJiAhQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICAgIHZhbCA9IHZhbCAmIDI1NQogICAgfQogIAogICAgLy8gSW52YWxpZCByYW5nZXMgYXJlIG5vdCBzZXQgdG8gYSBkZWZhdWx0LCBzbyBjYW4gcmFuZ2UgY2hlY2sgZWFybHkuCiAgICBpZiAoc3RhcnQgPCAwIHx8IHRoaXMubGVuZ3RoIDwgc3RhcnQgfHwgdGhpcy5sZW5ndGggPCBlbmQpIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ091dCBvZiByYW5nZSBpbmRleCcpCiAgICB9CiAgCiAgICBpZiAoZW5kIDw9IHN0YXJ0KSB7CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgCiAgICBzdGFydCA9IHN0YXJ0ID4+PiAwCiAgICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IHRoaXMubGVuZ3RoIDogZW5kID4+PiAwCiAgCiAgICBpZiAoIXZhbCkgdmFsID0gMAogIAogICAgdmFyIGkKICAgIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgICAgdGhpc1tpXSA9IHZhbAogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgYnl0ZXMgPSBCdWZmZXIuaXNCdWZmZXIodmFsKQogICAgICAgID8gdmFsCiAgICAgICAgOiB1dGY4VG9CeXRlcyhuZXcgQnVmZmVyKHZhbCwgZW5jb2RpbmcpLnRvU3RyaW5nKCkpCiAgICAgIHZhciBsZW4gPSBieXRlcy5sZW5ndGgKICAgICAgZm9yIChpID0gMDsgaSA8IGVuZCAtIHN0YXJ0OyArK2kpIHsKICAgICAgICB0aGlzW2kgKyBzdGFydF0gPSBieXRlc1tpICUgbGVuXQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gdGhpcwogIH0KICAKICAvLyBIRUxQRVIgRlVOQ1RJT05TCiAgLy8gPT09PT09PT09PT09PT09PQogIAogIHZhciBJTlZBTElEX0JBU0U2NF9SRSA9IC9bXitcLzAtOUEtWmEtei1fXS9nCiAgCiAgZnVuY3Rpb24gYmFzZTY0Y2xlYW4gKHN0cikgewogICAgLy8gTm9kZSBzdHJpcHMgb3V0IGludmFsaWQgY2hhcmFjdGVycyBsaWtlIFxuIGFuZCBcdCBmcm9tIHRoZSBzdHJpbmcsIGJhc2U2NC1qcyBkb2VzIG5vdAogICAgc3RyID0gc3RyaW5ndHJpbShzdHIpLnJlcGxhY2UoSU5WQUxJRF9CQVNFNjRfUkUsICcnKQogICAgLy8gTm9kZSBjb252ZXJ0cyBzdHJpbmdzIHdpdGggbGVuZ3RoIDwgMiB0byAnJwogICAgaWYgKHN0ci5sZW5ndGggPCAyKSByZXR1cm4gJycKICAgIC8vIE5vZGUgYWxsb3dzIGZvciBub24tcGFkZGVkIGJhc2U2NCBzdHJpbmdzIChtaXNzaW5nIHRyYWlsaW5nID09PSksIGJhc2U2NC1qcyBkb2VzIG5vdAogICAgd2hpbGUgKHN0ci5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICAgIHN0ciA9IHN0ciArICc9JwogICAgfQogICAgcmV0dXJuIHN0cgogIH0KICAKICBmdW5jdGlvbiBzdHJpbmd0cmltIChzdHIpIHsKICAgIGlmIChzdHIudHJpbSkgcmV0dXJuIHN0ci50cmltKCkKICAgIHJldHVybiBzdHIucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQogIH0KICAKICBmdW5jdGlvbiB0b0hleCAobikgewogICAgaWYgKG4gPCAxNikgcmV0dXJuICcwJyArIG4udG9TdHJpbmcoMTYpCiAgICByZXR1cm4gbi50b1N0cmluZygxNikKICB9CiAgCiAgZnVuY3Rpb24gdXRmOFRvQnl0ZXMgKHN0cmluZywgdW5pdHMpIHsKICAgIHVuaXRzID0gdW5pdHMgfHwgSW5maW5pdHkKICAgIHZhciBjb2RlUG9pbnQKICAgIHZhciBsZW5ndGggPSBzdHJpbmcubGVuZ3RoCiAgICB2YXIgbGVhZFN1cnJvZ2F0ZSA9IG51bGwKICAgIHZhciBieXRlcyA9IFtdCiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGNvZGVQb2ludCA9IHN0cmluZy5jaGFyQ29kZUF0KGkpCiAgCiAgICAgIC8vIGlzIHN1cnJvZ2F0ZSBjb21wb25lbnQKICAgICAgaWYgKGNvZGVQb2ludCA+IDB4RDdGRiAmJiBjb2RlUG9pbnQgPCAweEUwMDApIHsKICAgICAgICAvLyBsYXN0IGNoYXIgd2FzIGEgbGVhZAogICAgICAgIGlmICghbGVhZFN1cnJvZ2F0ZSkgewogICAgICAgICAgLy8gbm8gbGVhZCB5ZXQKICAgICAgICAgIGlmIChjb2RlUG9pbnQgPiAweERCRkYpIHsKICAgICAgICAgICAgLy8gdW5leHBlY3RlZCB0cmFpbAogICAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0gZWxzZSBpZiAoaSArIDEgPT09IGxlbmd0aCkgewogICAgICAgICAgICAvLyB1bnBhaXJlZCBsZWFkCiAgICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgfQogIAogICAgICAgICAgLy8gdmFsaWQgbGVhZAogICAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAogIAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgCiAgICAgICAgLy8gMiBsZWFkcyBpbiBhIHJvdwogICAgICAgIGlmIChjb2RlUG9pbnQgPCAweERDMDApIHsKICAgICAgICAgIGlmICgodW5pdHMgLT0gMykgPiAtMSkgYnl0ZXMucHVzaCgweEVGLCAweEJGLCAweEJEKQogICAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAogICAgICAgICAgY29udGludWUKICAgICAgICB9CiAgCiAgICAgICAgLy8gdmFsaWQgc3Vycm9nYXRlIHBhaXIKICAgICAgICBjb2RlUG9pbnQgPSAobGVhZFN1cnJvZ2F0ZSAtIDB4RDgwMCA8PCAxMCB8IGNvZGVQb2ludCAtIDB4REMwMCkgKyAweDEwMDAwCiAgICAgIH0gZWxzZSBpZiAobGVhZFN1cnJvZ2F0ZSkgewogICAgICAgIC8vIHZhbGlkIGJtcCBjaGFyLCBidXQgbGFzdCBjaGFyIHdhcyBhIGxlYWQKICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgfQogIAogICAgICBsZWFkU3Vycm9nYXRlID0gbnVsbAogIAogICAgICAvLyBlbmNvZGUgdXRmOAogICAgICBpZiAoY29kZVBvaW50IDwgMHg4MCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMSkgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goY29kZVBvaW50KQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4ODAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSAyKSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgfCAweEMwLAogICAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgICApCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHgxMDAwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMykgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHhDIHwgMHhFMCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTEwMDAwKSB7CiAgICAgICAgaWYgKCh1bml0cyAtPSA0KSA8IDApIGJyZWFrCiAgICAgICAgYnl0ZXMucHVzaCgKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDEyIHwgMHhGMCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweEMgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCA+PiAweDYgJiAweDNGIHwgMHg4MCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjb2RlIHBvaW50JykKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIGJ5dGVzCiAgfQogIAogIGZ1bmN0aW9uIGFzY2lpVG9CeXRlcyAoc3RyKSB7CiAgICB2YXIgYnl0ZUFycmF5ID0gW10KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgIC8vIE5vZGUncyBjb2RlIHNlZW1zIHRvIGJlIGRvaW5nIHRoaXMgYW5kIG5vdCAmIDB4N0YuLgogICAgICBieXRlQXJyYXkucHVzaChzdHIuY2hhckNvZGVBdChpKSAmIDB4RkYpCiAgICB9CiAgICByZXR1cm4gYnl0ZUFycmF5CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjE2bGVUb0J5dGVzIChzdHIsIHVuaXRzKSB7CiAgICB2YXIgYywgaGksIGxvCiAgICB2YXIgYnl0ZUFycmF5ID0gW10KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawogIAogICAgICBjID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgICAgaGkgPSBjID4+IDgKICAgICAgbG8gPSBjICUgMjU2CiAgICAgIGJ5dGVBcnJheS5wdXNoKGxvKQogICAgICBieXRlQXJyYXkucHVzaChoaSkKICAgIH0KICAKICAgIHJldHVybiBieXRlQXJyYXkKICB9CiAgCiAgZnVuY3Rpb24gYmFzZTY0VG9CeXRlcyAoc3RyKSB7CiAgICByZXR1cm4gYmFzZTY0LnRvQnl0ZUFycmF5KGJhc2U2NGNsZWFuKHN0cikpCiAgfQogIAogIGZ1bmN0aW9uIGJsaXRCdWZmZXIgKHNyYywgZHN0LCBvZmZzZXQsIGxlbmd0aCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBpZiAoKGkgKyBvZmZzZXQgPj0gZHN0Lmxlbmd0aCkgfHwgKGkgPj0gc3JjLmxlbmd0aCkpIGJyZWFrCiAgICAgIGRzdFtpICsgb2Zmc2V0XSA9IHNyY1tpXQogICAgfQogICAgcmV0dXJuIGkKICB9CiAgCiAgZnVuY3Rpb24gaXNuYW4gKHZhbCkgewogICAgcmV0dXJuIHZhbCAhPT0gdmFsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tc2VsZi1jb21wYXJlCiAgfQogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMsdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSxyZXF1aXJlKCJidWZmZXIiKS5CdWZmZXIpCiAgfSx7ImJhc2U2NC1qcyI6NzgsImJ1ZmZlciI6ODEsImllZWU3NTQiOjgzLCJpc2FycmF5Ijo4NH1dLDgyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICBmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgICB0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CiAgICB0aGlzLl9tYXhMaXN0ZW5lcnMgPSB0aGlzLl9tYXhMaXN0ZW5lcnMgfHwgdW5kZWZpbmVkOwogIH0KICBtb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKICAKICAvLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKICBFdmVudEVtaXR0ZXIuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuX2V2ZW50cyA9IHVuZGVmaW5lZDsKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9tYXhMaXN0ZW5lcnMgPSB1bmRlZmluZWQ7CiAgCiAgLy8gQnkgZGVmYXVsdCBFdmVudEVtaXR0ZXJzIHdpbGwgcHJpbnQgYSB3YXJuaW5nIGlmIG1vcmUgdGhhbiAxMCBsaXN0ZW5lcnMgYXJlCiAgLy8gYWRkZWQgdG8gaXQuIFRoaXMgaXMgYSB1c2VmdWwgZGVmYXVsdCB3aGljaCBoZWxwcyBmaW5kaW5nIG1lbW9yeSBsZWFrcy4KICBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVycyA9IDEwOwogIAogIC8vIE9idmlvdXNseSBub3QgYWxsIEVtaXR0ZXJzIHNob3VsZCBiZSBsaW1pdGVkIHRvIDEwLiBUaGlzIGZ1bmN0aW9uIGFsbG93cwogIC8vIHRoYXQgdG8gYmUgaW5jcmVhc2VkLiBTZXQgdG8gemVybyBmb3IgdW5saW1pdGVkLgogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewogICAgaWYgKCFpc051bWJlcihuKSB8fCBuIDwgMCB8fCBpc05hTihuKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCduIG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXInKTsKICAgIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciBlciwgaGFuZGxlciwgbGVuLCBhcmdzLCBpLCBsaXN0ZW5lcnM7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgCiAgICAvLyBJZiB0aGVyZSBpcyBubyAnZXJyb3InIGV2ZW50IGxpc3RlbmVyIHRoZW4gdGhyb3cuCiAgICBpZiAodHlwZSA9PT0gJ2Vycm9yJykgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAogICAgICAgICAgKGlzT2JqZWN0KHRoaXMuX2V2ZW50cy5lcnJvcikgJiYgIXRoaXMuX2V2ZW50cy5lcnJvci5sZW5ndGgpKSB7CiAgICAgICAgZXIgPSBhcmd1bWVudHNbMV07CiAgICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgIHRocm93IGVyOyAvLyBVbmhhbmRsZWQgJ2Vycm9yJyBldmVudAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBBdCBsZWFzdCBnaXZlIHNvbWUga2luZCBvZiBjb250ZXh0IHRvIHRoZSB1c2VyCiAgICAgICAgICB2YXIgZXJyID0gbmV3IEVycm9yKCdVbmNhdWdodCwgdW5zcGVjaWZpZWQgImVycm9yIiBldmVudC4gKCcgKyBlciArICcpJyk7CiAgICAgICAgICBlcnIuY29udGV4dCA9IGVyOwogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgIGlmIChpc1VuZGVmaW5lZChoYW5kbGVyKSkKICAgICAgcmV0dXJuIGZhbHNlOwogIAogICAgaWYgKGlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgLy8gZmFzdCBjYXNlcwogICAgICAgIGNhc2UgMToKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIC8vIHNsb3dlcgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgIGhhbmRsZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoaGFuZGxlcikpIHsKICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGxpc3RlbmVycyA9IGhhbmRsZXIuc2xpY2UoKTsKICAgICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICAKICAgIHJldHVybiB0cnVlOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgbTsKICAKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cykKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgCiAgICAvLyBUbyBhdm9pZCByZWN1cnNpb24gaW4gdGhlIGNhc2UgdGhhdCB0eXBlID09PSAibmV3TGlzdGVuZXIiISBCZWZvcmUKICAgIC8vIGFkZGluZyBpdCB0byB0aGUgbGlzdGVuZXJzLCBmaXJzdCBlbWl0ICJuZXdMaXN0ZW5lciIuCiAgICBpZiAodGhpcy5fZXZlbnRzLm5ld0xpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ25ld0xpc3RlbmVyJywgdHlwZSwKICAgICAgICAgICAgICAgIGlzRnVuY3Rpb24obGlzdGVuZXIubGlzdGVuZXIpID8KICAgICAgICAgICAgICAgIGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIpOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgIC8vIE9wdGltaXplIHRoZSBjYXNlIG9mIG9uZSBsaXN0ZW5lci4gRG9uJ3QgbmVlZCB0aGUgZXh0cmEgYXJyYXkgb2JqZWN0LgogICAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBsaXN0ZW5lcjsKICAgIGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICAgIC8vIElmIHdlJ3ZlIGFscmVhZHkgZ290IGFuIGFycmF5LCBqdXN0IGFwcGVuZC4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogICAgZWxzZQogICAgICAvLyBBZGRpbmcgdGhlIHNlY29uZCBlbGVtZW50LCBuZWVkIHRvIGNoYW5nZSB0byBhcnJheS4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gW3RoaXMuX2V2ZW50c1t0eXBlXSwgbGlzdGVuZXJdOwogIAogICAgLy8gQ2hlY2sgZm9yIGxpc3RlbmVyIGxlYWsKICAgIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CiAgICAgIGlmICghaXNVbmRlZmluZWQodGhpcy5fbWF4TGlzdGVuZXJzKSkgewogICAgICAgIG0gPSB0aGlzLl9tYXhMaXN0ZW5lcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbSA9IEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzOwogICAgICB9CiAgCiAgICAgIGlmIChtICYmIG0gPiAwICYmIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGggPiBtKSB7CiAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7CiAgICAgICAgY29uc29sZS5lcnJvcignKG5vZGUpIHdhcm5pbmc6IHBvc3NpYmxlIEV2ZW50RW1pdHRlciBtZW1vcnkgJyArCiAgICAgICAgICAgICAgICAgICAgICAnbGVhayBkZXRlY3RlZC4gJWQgbGlzdGVuZXJzIGFkZGVkLiAnICsKICAgICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLAogICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCk7CiAgICAgICAgaWYgKHR5cGVvZiBjb25zb2xlLnRyYWNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwCiAgICAgICAgICBjb25zb2xlLnRyYWNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub24gPSBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyOwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwogIAogICAgdmFyIGZpcmVkID0gZmFsc2U7CiAgCiAgICBmdW5jdGlvbiBnKCkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGcpOwogIAogICAgICBpZiAoIWZpcmVkKSB7CiAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgIGxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH0KICAKICAgIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKICAgIHRoaXMub24odHlwZSwgZyk7CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIC8vIGVtaXRzIGEgJ3JlbW92ZUxpc3RlbmVyJyBldmVudCBpZmYgdGhlIGxpc3RlbmVyIHdhcyByZW1vdmVkCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgICB2YXIgbGlzdCwgcG9zaXRpb24sIGxlbmd0aCwgaTsKICAKICAgIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgCiAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICByZXR1cm4gdGhpczsKICAKICAgIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICBsZW5ndGggPSBsaXN0Lmxlbmd0aDsKICAgIHBvc2l0aW9uID0gLTE7CiAgCiAgICBpZiAobGlzdCA9PT0gbGlzdGVuZXIgfHwKICAgICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikKICAgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogIAogICAgfSBlbHNlIGlmIChpc09iamVjdChsaXN0KSkgewogICAgICBmb3IgKGkgPSBsZW5ndGg7IGktLSA+IDA7KSB7CiAgICAgICAgaWYgKGxpc3RbaV0gPT09IGxpc3RlbmVyIHx8CiAgICAgICAgICAgIChsaXN0W2ldLmxpc3RlbmVyICYmIGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmIChwb3NpdGlvbiA8IDApCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgCiAgICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMSkgewogICAgICAgIGxpc3QubGVuZ3RoID0gMDsKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICB9IGVsc2UgewogICAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7CiAgICB9CiAgCiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogICAgdmFyIGtleSwgbGlzdGVuZXJzOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgIHJldHVybiB0aGlzOwogIAogICAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdAogICAgaWYgKCF0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIGVsc2UgaWYgKHRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAKICAgIC8vIGVtaXQgcmVtb3ZlTGlzdGVuZXIgZm9yIGFsbCBsaXN0ZW5lcnMgb24gYWxsIGV2ZW50cwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ3JlbW92ZUxpc3RlbmVyJykgY29udGludWU7CiAgICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoa2V5KTsKICAgICAgfQogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygncmVtb3ZlTGlzdGVuZXInKTsKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIAogICAgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgaWYgKGlzRnVuY3Rpb24obGlzdGVuZXJzKSkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7CiAgICB9IGVsc2UgaWYgKGxpc3RlbmVycykgewogICAgICAvLyBMSUZPIG9yZGVyCiAgICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoKQogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7CiAgICB9CiAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciByZXQ7CiAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICByZXQgPSBbXTsKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24odGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgICAgcmV0ID0gW3RoaXMuX2V2ZW50c1t0eXBlXV07CiAgICBlbHNlCiAgICAgIHJldCA9IHRoaXMuX2V2ZW50c1t0eXBlXS5zbGljZSgpOwogICAgcmV0dXJuIHJldDsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIGlmICh0aGlzLl9ldmVudHMpIHsKICAgICAgdmFyIGV2bGlzdGVuZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICAgIGlmIChpc0Z1bmN0aW9uKGV2bGlzdGVuZXIpKQogICAgICAgIHJldHVybiAxOwogICAgICBlbHNlIGlmIChldmxpc3RlbmVyKQogICAgICAgIHJldHVybiBldmxpc3RlbmVyLmxlbmd0aDsKICAgIH0KICAgIHJldHVybiAwOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgICByZXR1cm4gZW1pdHRlci5saXN0ZW5lckNvdW50KHR5cGUpOwogIH07CiAgCiAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwogIH0KICAKICBmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKICB9CiAgCiAgZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogIH0KICAKICBmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IHZvaWQgMDsKICB9CiAgCiAgfSx7fV0sODM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGV4cG9ydHMucmVhZCA9IGZ1bmN0aW9uIChidWZmZXIsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CiAgICB2YXIgZSwgbQogICAgdmFyIGVMZW4gPSAobkJ5dGVzICogOCkgLSBtTGVuIC0gMQogICAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDEKICAgIHZhciBlQmlhcyA9IGVNYXggPj4gMQogICAgdmFyIG5CaXRzID0gLTcKICAgIHZhciBpID0gaXNMRSA/IChuQnl0ZXMgLSAxKSA6IDAKICAgIHZhciBkID0gaXNMRSA/IC0xIDogMQogICAgdmFyIHMgPSBidWZmZXJbb2Zmc2V0ICsgaV0KICAKICAgIGkgKz0gZAogIAogICAgZSA9IHMgJiAoKDEgPDwgKC1uQml0cykpIC0gMSkKICAgIHMgPj49ICgtbkJpdHMpCiAgICBuQml0cyArPSBlTGVuCiAgICBmb3IgKDsgbkJpdHMgPiAwOyBlID0gKGUgKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CiAgCiAgICBtID0gZSAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKQogICAgZSA+Pj0gKC1uQml0cykKICAgIG5CaXRzICs9IG1MZW4KICAgIGZvciAoOyBuQml0cyA+IDA7IG0gPSAobSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KICAKICAgIGlmIChlID09PSAwKSB7CiAgICAgIGUgPSAxIC0gZUJpYXMKICAgIH0gZWxzZSBpZiAoZSA9PT0gZU1heCkgewogICAgICByZXR1cm4gbSA/IE5hTiA6ICgocyA/IC0xIDogMSkgKiBJbmZpbml0eSkKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBtICsgTWF0aC5wb3coMiwgbUxlbikKICAgICAgZSA9IGUgLSBlQmlhcwogICAgfQogICAgcmV0dXJuIChzID8gLTEgOiAxKSAqIG0gKiBNYXRoLnBvdygyLCBlIC0gbUxlbikKICB9CiAgCiAgZXhwb3J0cy53cml0ZSA9IGZ1bmN0aW9uIChidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogICAgdmFyIGUsIG0sIGMKICAgIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDEKICAgIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxCiAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDEKICAgIHZhciBydCA9IChtTGVuID09PSAyMyA/IE1hdGgucG93KDIsIC0yNCkgLSBNYXRoLnBvdygyLCAtNzcpIDogMCkKICAgIHZhciBpID0gaXNMRSA/IDAgOiAobkJ5dGVzIC0gMSkKICAgIHZhciBkID0gaXNMRSA/IDEgOiAtMQogICAgdmFyIHMgPSB2YWx1ZSA8IDAgfHwgKHZhbHVlID09PSAwICYmIDEgLyB2YWx1ZSA8IDApID8gMSA6IDAKICAKICAgIHZhbHVlID0gTWF0aC5hYnModmFsdWUpCiAgCiAgICBpZiAoaXNOYU4odmFsdWUpIHx8IHZhbHVlID09PSBJbmZpbml0eSkgewogICAgICBtID0gaXNOYU4odmFsdWUpID8gMSA6IDAKICAgICAgZSA9IGVNYXgKICAgIH0gZWxzZSB7CiAgICAgIGUgPSBNYXRoLmZsb29yKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4yKQogICAgICBpZiAodmFsdWUgKiAoYyA9IE1hdGgucG93KDIsIC1lKSkgPCAxKSB7CiAgICAgICAgZS0tCiAgICAgICAgYyAqPSAyCiAgICAgIH0KICAgICAgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgICAgdmFsdWUgKz0gcnQgLyBjCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgKz0gcnQgKiBNYXRoLnBvdygyLCAxIC0gZUJpYXMpCiAgICAgIH0KICAgICAgaWYgKHZhbHVlICogYyA+PSAyKSB7CiAgICAgICAgZSsrCiAgICAgICAgYyAvPSAyCiAgICAgIH0KICAKICAgICAgaWYgKGUgKyBlQmlhcyA+PSBlTWF4KSB7CiAgICAgICAgbSA9IDAKICAgICAgICBlID0gZU1heAogICAgICB9IGVsc2UgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgICAgbSA9ICgodmFsdWUgKiBjKSAtIDEpICogTWF0aC5wb3coMiwgbUxlbikKICAgICAgICBlID0gZSArIGVCaWFzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgbSA9IHZhbHVlICogTWF0aC5wb3coMiwgZUJpYXMgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pCiAgICAgICAgZSA9IDAKICAgICAgfQogICAgfQogIAogICAgZm9yICg7IG1MZW4gPj0gODsgYnVmZmVyW29mZnNldCArIGldID0gbSAmIDB4ZmYsIGkgKz0gZCwgbSAvPSAyNTYsIG1MZW4gLT0gOCkge30KICAKICAgIGUgPSAoZSA8PCBtTGVuKSB8IG0KICAgIGVMZW4gKz0gbUxlbgogICAgZm9yICg7IGVMZW4gPiAwOyBidWZmZXJbb2Zmc2V0ICsgaV0gPSBlICYgMHhmZiwgaSArPSBkLCBlIC89IDI1NiwgZUxlbiAtPSA4KSB7fQogIAogICAgYnVmZmVyW29mZnNldCArIGkgLSBkXSB8PSBzICogMTI4CiAgfQogIAogIH0se31dLDg0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdG9TdHJpbmcgPSB7fS50b1N0cmluZzsKICAKICBtb2R1bGUuZXhwb3J0cyA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKGFycikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwoYXJyKSA9PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgfSx7fV0sODU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgCiAgICBmdW5jdGlvbiBpc0FycmF5KG9iaikgewogICAgICBpZiAob2JqICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBBcnJheV0iOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgICAgIGlmIChvYmogIT09IG51bGwpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IE9iamVjdF0iOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgLy8gQ2hlY2sgdGhlIHNjYWxhciBjYXNlIGZpcnN0LgogICAgICBpZiAoZmlyc3QgPT09IHNlY29uZCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgCiAgICAgIC8vIENoZWNrIGlmIHRoZXkgYXJlIHRoZSBzYW1lIHR5cGUuCiAgICAgIHZhciBmaXJzdFR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZmlyc3QpOwogICAgICBpZiAoZmlyc3RUeXBlICE9PSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc2Vjb25kKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICAvLyBXZSBrbm93IHRoYXQgZmlyc3QgYW5kIHNlY29uZCBoYXZlIHRoZSBzYW1lIHR5cGUgc28gd2UgY2FuIGp1c3QgY2hlY2sgdGhlCiAgICAgIC8vIGZpcnN0IHR5cGUgZnJvbSBub3cgb24uCiAgICAgIGlmIChpc0FycmF5KGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgIC8vIFNob3J0IGNpcmN1aXQgaWYgdGhleSdyZSBub3QgdGhlIHNhbWUgbGVuZ3RoOwogICAgICAgIGlmIChmaXJzdC5sZW5ndGggIT09IHNlY29uZC5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaXJzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHN0cmljdERlZXBFcXVhbChmaXJzdFtpXSwgc2Vjb25kW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXNPYmplY3QoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgLy8gQW4gb2JqZWN0IGlzIGVxdWFsIGlmIGl0IGhhcyB0aGUgc2FtZSBrZXkvdmFsdWUgcGFpcnMuCiAgICAgICAgdmFyIGtleXNTZWVuID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIGZpcnN0KSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChmaXJzdCwga2V5KSkgewogICAgICAgICAgICBpZiAoc3RyaWN0RGVlcEVxdWFsKGZpcnN0W2tleV0sIHNlY29uZFtrZXldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5c1NlZW5ba2V5XSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIE5vdyBjaGVjayB0aGF0IHRoZXJlIGFyZW4ndCBhbnkga2V5cyBpbiBzZWNvbmQgdGhhdCB3ZXJlbid0CiAgICAgICAgLy8gaW4gZmlyc3QuCiAgICAgICAgZm9yICh2YXIga2V5MiBpbiBzZWNvbmQpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNlY29uZCwga2V5MikpIHsKICAgICAgICAgICAgaWYgKGtleXNTZWVuW2tleTJdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAKICAgIGZ1bmN0aW9uIGlzRmFsc2Uob2JqKSB7CiAgICAgIC8vIEZyb20gdGhlIHNwZWM6CiAgICAgIC8vIEEgZmFsc2UgdmFsdWUgY29ycmVzcG9uZHMgdG8gdGhlIGZvbGxvd2luZyB2YWx1ZXM6CiAgICAgIC8vIEVtcHR5IGxpc3QKICAgICAgLy8gRW1wdHkgb2JqZWN0CiAgICAgIC8vIEVtcHR5IHN0cmluZwogICAgICAvLyBGYWxzZSBib29sZWFuCiAgICAgIC8vIG51bGwgdmFsdWUKICAKICAgICAgLy8gRmlyc3QgY2hlY2sgdGhlIHNjYWxhciB2YWx1ZXMuCiAgICAgIGlmIChvYmogPT09ICIiIHx8IG9iaiA9PT0gZmFsc2UgfHwgb2JqID09PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5KG9iaikgJiYgb2JqLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IGFycmF5LgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IG9iamVjdC4KICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAvLyBJZiB0aGVyZSBhcmUgYW55IGtleXMsIHRoZW4KICAgICAgICAgICAgICAvLyB0aGUgb2JqZWN0IGlzIG5vdCBlbXB0eSBzbyB0aGUgb2JqZWN0CiAgICAgICAgICAgICAgLy8gaXMgbm90IGZhbHNlLgogICAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiBvYmpWYWx1ZXMob2JqKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWx1ZXMucHVzaChvYmpba2V5c1tpXV0pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBtZXJnZShhLCBiKSB7CiAgICAgICAgdmFyIG1lcmdlZCA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBhKSB7CiAgICAgICAgICAgIG1lcmdlZFtrZXldID0gYVtrZXldOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkyIGluIGIpIHsKICAgICAgICAgICAgbWVyZ2VkW2tleTJdID0gYltrZXkyXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgIH0KICAKICAgIHZhciB0cmltTGVmdDsKICAgIGlmICh0eXBlb2YgU3RyaW5nLnByb3RvdHlwZS50cmltTGVmdCA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cmltTGVmdCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBzdHIudHJpbUxlZnQoKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRyaW1MZWZ0ID0gZnVuY3Rpb24oc3RyKSB7CiAgICAgICAgcmV0dXJuIHN0ci5tYXRjaCgvXlxzKiguKikvKVsxXTsKICAgICAgfTsKICAgIH0KICAKICAgIC8vIFR5cGUgY29uc3RhbnRzIHVzZWQgdG8gZGVmaW5lIGZ1bmN0aW9ucy4KICAgIHZhciBUWVBFX05VTUJFUiA9IDA7CiAgICB2YXIgVFlQRV9BTlkgPSAxOwogICAgdmFyIFRZUEVfU1RSSU5HID0gMjsKICAgIHZhciBUWVBFX0FSUkFZID0gMzsKICAgIHZhciBUWVBFX09CSkVDVCA9IDQ7CiAgICB2YXIgVFlQRV9CT09MRUFOID0gNTsKICAgIHZhciBUWVBFX0VYUFJFRiA9IDY7CiAgICB2YXIgVFlQRV9OVUxMID0gNzsKICAgIHZhciBUWVBFX0FSUkFZX05VTUJFUiA9IDg7CiAgICB2YXIgVFlQRV9BUlJBWV9TVFJJTkcgPSA5OwogIAogICAgdmFyIFRPS19FT0YgPSAiRU9GIjsKICAgIHZhciBUT0tfVU5RVU9URURJREVOVElGSUVSID0gIlVucXVvdGVkSWRlbnRpZmllciI7CiAgICB2YXIgVE9LX1FVT1RFRElERU5USUZJRVIgPSAiUXVvdGVkSWRlbnRpZmllciI7CiAgICB2YXIgVE9LX1JCUkFDS0VUID0gIlJicmFja2V0IjsKICAgIHZhciBUT0tfUlBBUkVOID0gIlJwYXJlbiI7CiAgICB2YXIgVE9LX0NPTU1BID0gIkNvbW1hIjsKICAgIHZhciBUT0tfQ09MT04gPSAiQ29sb24iOwogICAgdmFyIFRPS19SQlJBQ0UgPSAiUmJyYWNlIjsKICAgIHZhciBUT0tfTlVNQkVSID0gIk51bWJlciI7CiAgICB2YXIgVE9LX0NVUlJFTlQgPSAiQ3VycmVudCI7CiAgICB2YXIgVE9LX0VYUFJFRiA9ICJFeHByZWYiOwogICAgdmFyIFRPS19QSVBFID0gIlBpcGUiOwogICAgdmFyIFRPS19PUiA9ICJPciI7CiAgICB2YXIgVE9LX0FORCA9ICJBbmQiOwogICAgdmFyIFRPS19FUSA9ICJFUSI7CiAgICB2YXIgVE9LX0dUID0gIkdUIjsKICAgIHZhciBUT0tfTFQgPSAiTFQiOwogICAgdmFyIFRPS19HVEUgPSAiR1RFIjsKICAgIHZhciBUT0tfTFRFID0gIkxURSI7CiAgICB2YXIgVE9LX05FID0gIk5FIjsKICAgIHZhciBUT0tfRkxBVFRFTiA9ICJGbGF0dGVuIjsKICAgIHZhciBUT0tfU1RBUiA9ICJTdGFyIjsKICAgIHZhciBUT0tfRklMVEVSID0gIkZpbHRlciI7CiAgICB2YXIgVE9LX0RPVCA9ICJEb3QiOwogICAgdmFyIFRPS19OT1QgPSAiTm90IjsKICAgIHZhciBUT0tfTEJSQUNFID0gIkxicmFjZSI7CiAgICB2YXIgVE9LX0xCUkFDS0VUID0gIkxicmFja2V0IjsKICAgIHZhciBUT0tfTFBBUkVOPSAiTHBhcmVuIjsKICAgIHZhciBUT0tfTElURVJBTD0gIkxpdGVyYWwiOwogIAogICAgLy8gVGhlICImIiwgIlsiLCAiPCIsICI+IiB0b2tlbnMKICAgIC8vIGFyZSBub3QgaW4gYmFzaWNUb2tlbiBiZWNhdXNlCiAgICAvLyB0aGVyZSBhcmUgdHdvIHRva2VuIHZhcmlhbnRzCiAgICAvLyAoIiYmIiwgIls/IiwgIjw9IiwgIj49IikuICBUaGlzIGlzIHNwZWNpYWxseSBoYW5kbGVkCiAgICAvLyBiZWxvdy4KICAKICAgIHZhciBiYXNpY1Rva2VucyA9IHsKICAgICAgIi4iOiBUT0tfRE9ULAogICAgICAiKiI6IFRPS19TVEFSLAogICAgICAiLCI6IFRPS19DT01NQSwKICAgICAgIjoiOiBUT0tfQ09MT04sCiAgICAgICJ7IjogVE9LX0xCUkFDRSwKICAgICAgIn0iOiBUT0tfUkJSQUNFLAogICAgICAiXSI6IFRPS19SQlJBQ0tFVCwKICAgICAgIigiOiBUT0tfTFBBUkVOLAogICAgICAiKSI6IFRPS19SUEFSRU4sCiAgICAgICJAIjogVE9LX0NVUlJFTlQKICAgIH07CiAgCiAgICB2YXIgb3BlcmF0b3JTdGFydFRva2VuID0gewogICAgICAgICI8IjogdHJ1ZSwKICAgICAgICAiPiI6IHRydWUsCiAgICAgICAgIj0iOiB0cnVlLAogICAgICAgICIhIjogdHJ1ZQogICAgfTsKICAKICAgIHZhciBza2lwQ2hhcnMgPSB7CiAgICAgICAgIiAiOiB0cnVlLAogICAgICAgICJcdCI6IHRydWUsCiAgICAgICAgIlxuIjogdHJ1ZQogICAgfTsKICAKICAKICAgIGZ1bmN0aW9uIGlzQWxwaGEoY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICJhIiAmJiBjaCA8PSAieiIpIHx8CiAgICAgICAgICAgICAgIChjaCA+PSAiQSIgJiYgY2ggPD0gIloiKSB8fAogICAgICAgICAgICAgICBjaCA9PT0gIl8iOwogICAgfQogIAogICAgZnVuY3Rpb24gaXNOdW0oY2gpIHsKICAgICAgICByZXR1cm4gKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiLSI7CiAgICB9CiAgICBmdW5jdGlvbiBpc0FscGhhTnVtKGNoKSB7CiAgICAgICAgcmV0dXJuIChjaCA+PSAiYSIgJiYgY2ggPD0gInoiKSB8fAogICAgICAgICAgICAgICAoY2ggPj0gIkEiICYmIGNoIDw9ICJaIikgfHwKICAgICAgICAgICAgICAgKGNoID49ICIwIiAmJiBjaCA8PSAiOSIpIHx8CiAgICAgICAgICAgICAgIGNoID09PSAiXyI7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBMZXhlcigpIHsKICAgIH0KICAgIExleGVyLnByb3RvdHlwZSA9IHsKICAgICAgICB0b2tlbml6ZTogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciB0b2tlbnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IDA7CiAgICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgICAgdmFyIGlkZW50aWZpZXI7CiAgICAgICAgICAgIHZhciB0b2tlbjsKICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2N1cnJlbnQgPCBzdHJlYW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNBbHBoYShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lVW5xdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19VTlFVT1RFRElERU5USUZJRVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYmFzaWNUb2tlbnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IGJhc2ljVG9rZW5zW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN0cmVhbVt0aGlzLl9jdXJyZW50XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogdGhpcy5fY3VycmVudH0pOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZU51bWJlcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiWyIpIHsKICAgICAgICAgICAgICAgICAgICAvLyBObyBuZWVkIHRvIGluY3JlbWVudCB0aGlzLl9jdXJyZW50LiAgVGhpcyBoYXBwZW5zCiAgICAgICAgICAgICAgICAgICAgLy8gaW4gX2NvbnN1bWVMQnJhY2tldAogICAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZUxCcmFja2V0KHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJcIiIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHRoaXMuX2NvbnN1bWVRdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19RVU9URURJREVOVElGSUVSLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiciKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lUmF3U3RyaW5nTGl0ZXJhbChzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfTElURVJBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJgIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB2YXIgbGl0ZXJhbCA9IHRoaXMuX2NvbnN1bWVMaXRlcmFsKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19MSVRFUkFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbGl0ZXJhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wZXJhdG9yU3RhcnRUb2tlbltzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0aGlzLl9jb25zdW1lT3BlcmF0b3Ioc3RyZWFtKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNraXBDaGFyc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgd2hpdGVzcGFjZS4KICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0FORCwgdmFsdWU6ICImJiIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfRVhQUkVGLCB2YWx1ZTogIiYiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gInwiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAifCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX09SLCB2YWx1ZTogInx8Iiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19QSVBFLCB2YWx1ZTogInwiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiVW5rbm93biBjaGFyYWN0ZXI6IiArIHN0cmVhbVt0aGlzLl9jdXJyZW50XSk7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJMZXhlckVycm9yIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdG9rZW5zOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVVbnF1b3RlZElkZW50aWZpZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jdXJyZW50IDwgc3RyZWFtLmxlbmd0aCAmJiBpc0FscGhhTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lUXVvdGVkSWRlbnRpZmllcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICJcIiIgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBkb3VibGUgcXVvdGUgYW5kIHlvdSBjYW4gZXNjYXBlIGFuIGVzY2FwZS4KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bY3VycmVudF0gPT09ICJcXCIgJiYgKHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcXCIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcIiIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVSYXdTdHJpbmdMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gIiciICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgc2luZ2xlIHF1b3RlIGFuZCB5b3UgY2FuIGVzY2FwZSBhbiBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiJyIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBsaXRlcmFsID0gc3RyZWFtLnNsaWNlKHN0YXJ0ICsgMSwgdGhpcy5fY3VycmVudCAtIDEpOwogICAgICAgICAgICByZXR1cm4gbGl0ZXJhbC5yZXBsYWNlKCJcXCciLCAiJyIpOwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVOdW1iZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VJbnQoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05VTUJFUiwgdmFsdWU6IHZhbHVlLCBzdGFydDogc3RhcnR9OwogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVMQnJhY2tldDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GSUxURVIsIHZhbHVlOiAiWz8iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIl0iKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19GTEFUVEVOLCB2YWx1ZTogIltdIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xCUkFDS0VULCB2YWx1ZTogIlsiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZU9wZXJhdG9yOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdmFyIHN0YXJ0aW5nQ2hhciA9IHN0cmVhbVtzdGFydF07CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTkUsIHZhbHVlOiAiIT0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTk9ULCB2YWx1ZTogIiEiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFRFLCB2YWx1ZTogIjw9Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFQsIHZhbHVlOiAiPCIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVEUsIHZhbHVlOiAiPj0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19HVCwgdmFsdWU6ICI+Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI9IikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0VRLCB2YWx1ZTogIj09Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVMaXRlcmFsOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGxpdGVyYWw7CiAgICAgICAgICAgIHdoaWxlKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gImAiICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgbGl0ZXJhbCBjaGFyIG9yIHlvdSBjYW4gZXNjYXBlIHRoZSBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiYCIpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGl0ZXJhbFN0cmluZyA9IHRyaW1MZWZ0KHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgICAgICBsaXRlcmFsU3RyaW5nID0gbGl0ZXJhbFN0cmluZy5yZXBsYWNlKCJcXGAiLCAiYCIpOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va3NMaWtlSlNPTihsaXRlcmFsU3RyaW5nKSkgewogICAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gSlNPTiBwYXJzZSBpdCBhcyAiPGxpdGVyYWw+IgogICAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UoIlwiIiArIGxpdGVyYWxTdHJpbmcgKyAiXCIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyArMSBnZXRzIHVzIHRvIHRoZSBlbmRpbmcgImAiLCArMSB0byBtb3ZlIG9uIHRvIHRoZSBuZXh0IGNoYXIuCiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgcmV0dXJuIGxpdGVyYWw7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9va3NMaWtlSlNPTjogZnVuY3Rpb24obGl0ZXJhbFN0cmluZykgewogICAgICAgICAgICB2YXIgc3RhcnRpbmdDaGFycyA9ICJbe1wiIjsKICAgICAgICAgICAgdmFyIGpzb25MaXRlcmFscyA9IFsidHJ1ZSIsICJmYWxzZSIsICJudWxsIl07CiAgICAgICAgICAgIHZhciBudW1iZXJMb29raW5nID0gIi0wMTIzNDU2Nzg5IjsKICAKICAgICAgICAgICAgaWYgKGxpdGVyYWxTdHJpbmcgPT09ICIiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFycy5pbmRleE9mKGxpdGVyYWxTdHJpbmdbMF0pID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGpzb25MaXRlcmFscy5pbmRleE9mKGxpdGVyYWxTdHJpbmcpID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKG51bWJlckxvb2tpbmcuaW5kZXhPZihsaXRlcmFsU3RyaW5nWzBdKSA+PSAwKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgCiAgICAgICAgdmFyIGJpbmRpbmdQb3dlciA9IHt9OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRU9GXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19VTlFVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1FVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1JCUkFDS0VUXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SUEFSRU5dID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0NPTU1BXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SQlJBQ0VdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX05VTUJFUl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQ1VSUkVOVF0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRVhQUkVGXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19QSVBFXSA9IDE7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19PUl0gPSAyOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfQU5EXSA9IDM7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19FUV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfR1RdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xUXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19HVEVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xURV0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTkVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0ZMQVRURU5dID0gOTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX1NUQVJdID0gMjA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19GSUxURVJdID0gMjE7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19ET1RdID0gNDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19OT1RdID0gNDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0VdID0gNTA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0tFVF0gPSA1NTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0xQQVJFTl0gPSA2MDsKICAKICAgIGZ1bmN0aW9uIFBhcnNlcigpIHsKICAgIH0KICAKICAgIFBhcnNlci5wcm90b3R5cGUgPSB7CiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgdGhpcy5fbG9hZFRva2VucyhleHByZXNzaW9uKTsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBhc3QgPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19FT0YpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlVuZXhwZWN0ZWQgdG9rZW4gdHlwZTogIiArIHQudHlwZSArICIsIHZhbHVlOiAiICsgdC52YWx1ZSk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3Q7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9hZFRva2VuczogZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgICAgICAgdmFyIHRva2VucyA9IGxleGVyLnRva2VuaXplKGV4cHJlc3Npb24pOwogICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0VPRiwgdmFsdWU6ICIiLCBzdGFydDogZXhwcmVzc2lvbi5sZW5ndGh9KTsKICAgICAgICAgICAgdGhpcy50b2tlbnMgPSB0b2tlbnM7CiAgICAgICAgfSwKICAKICAgICAgICBleHByZXNzaW9uOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIGxlZnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIHZhciBsZWZ0ID0gdGhpcy5udWQobGVmdFRva2VuKTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgd2hpbGUgKHJicCA8IGJpbmRpbmdQb3dlcltjdXJyZW50VG9rZW5dKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy5sZWQoY3VycmVudFRva2VuLCBsZWZ0KTsKICAgICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rYWhlYWQ6IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b2tlbnNbdGhpcy5pbmRleCArIG51bWJlcl0udHlwZTsKICAgICAgICB9LAogIAogICAgICAgIF9sb29rYWhlYWRUb2tlbjogZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRva2Vuc1t0aGlzLmluZGV4ICsgbnVtYmVyXTsKICAgICAgICB9LAogIAogICAgICAgIF9hZHZhbmNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgIH0sCiAgCiAgICAgICAgbnVkOiBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgdmFyIGxlZnQ7CiAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICB2YXIgZXhwcmVzc2lvbjsKICAgICAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgewogICAgICAgICAgICBjYXNlIFRPS19MSVRFUkFMOgogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkxpdGVyYWwiLCB2YWx1ZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICBjYXNlIFRPS19VTlFVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmllbGQiLCBuYW1lOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICAgIGNhc2UgVE9LX1FVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB7dHlwZTogIkZpZWxkIiwgbmFtZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19MUEFSRU4pIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJRdW90ZWQgaWRlbnRpZmllciBub3QgYWxsb3dlZCBmb3IgZnVuY3Rpb24gbmFtZXMuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19OT1Q6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLk5vdCk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTm90RXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfU1RBUjoKICAgICAgICAgICAgICBsZWZ0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIHJpZ2h0ID0gbnVsbDsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIGluIGEgbXVsdGlzZWxlY3QsCiAgICAgICAgICAgICAgICAgIC8vIFthLCBiLCAqXQogICAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlZhbHVlUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfRklMVEVSOgogICAgICAgICAgICAgIHJldHVybiB0aGlzLmxlZCh0b2tlbi50eXBlLCB7dHlwZTogIklkZW50aXR5In0pOwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0U6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RIYXNoKCk7CiAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgbGVmdCA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFt7dHlwZTogIklkZW50aXR5In1dfTsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfTEJSQUNLRVQ6CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX05VTUJFUiB8fCB0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlSW5kZXhFeHByZXNzaW9uKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0SWZTbGljZSh7dHlwZTogIklkZW50aXR5In0sIHJpZ2h0KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1NUQVIgJiYKICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvb2thaGVhZCgxKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbe3R5cGU6ICJJZGVudGl0eSJ9LCByaWdodF19OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgY2FzZSBUT0tfRVhQUkVGOgogICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkV4cHJlZik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRXhwcmVzc2lvblJlZmVyZW5jZSIsIGNoaWxkcmVuOiBbZXhwcmVzc2lvbl19OwogICAgICAgICAgICBjYXNlIFRPS19MUEFSRU46CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUlBBUkVOKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ1VSUkVOVCkgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0ge3R5cGU6IFRPS19DVVJSRU5UfTsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhpcy5fZXJyb3JUb2tlbih0b2tlbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBsZWQ6IGZ1bmN0aW9uKHRva2VuTmFtZSwgbGVmdCkgewogICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgc3dpdGNoKHRva2VuTmFtZSkgewogICAgICAgICAgICBjYXNlIFRPS19ET1Q6CiAgICAgICAgICAgICAgdmFyIHJicCA9IGJpbmRpbmdQb3dlci5Eb3Q7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1NUQVIpIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJTdWJleHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIENyZWF0aW5nIGEgcHJvamVjdGlvbi4KICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhyYnApOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJWYWx1ZVByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5QaXBlKTsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19QSVBFLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX09SOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5Pcik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiT3JFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19BTkQ6CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLkFuZCk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiQW5kRXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfTFBBUkVOOgogICAgICAgICAgICAgIHZhciBuYW1lID0gbGVmdC5uYW1lOwogICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24sIG5vZGU7CiAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JQQVJFTikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NVUlJFTlQpIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JQQVJFTik7CiAgICAgICAgICAgICAgbm9kZSA9IHt0eXBlOiAiRnVuY3Rpb24iLCBuYW1lOiBuYW1lLCBjaGlsZHJlbjogYXJnc307CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIGNhc2UgVE9LX0ZJTFRFUjoKICAgICAgICAgICAgICB2YXIgY29uZGl0aW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZMQVRURU4pIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmlsdGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiRmlsdGVyUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHQsIGNvbmRpdGlvbl19OwogICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgIHZhciBsZWZ0Tm9kZSA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFtsZWZ0XX07CiAgICAgICAgICAgICAgdmFyIHJpZ2h0Tm9kZSA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuRmxhdHRlbik7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdE5vZGUsIHJpZ2h0Tm9kZV19OwogICAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgICAgY2FzZSBUT0tfTkU6CiAgICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICAgIGNhc2UgVE9LX0xUOgogICAgICAgICAgICBjYXNlIFRPS19MVEU6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlQ29tcGFyYXRvcihsZWZ0LCB0b2tlbk5hbWUpOwogICAgICAgICAgICBjYXNlIFRPS19MQlJBQ0tFVDoKICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVE9LX05VTUJFUiB8fCB0b2tlbi50eXBlID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZUluZGV4RXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdElmU2xpY2UobGVmdCwgcmlnaHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19TVEFSKTsKICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aGlzLl9lcnJvclRva2VuKHRoaXMuX2xvb2thaGVhZFRva2VuKDApKTsKICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9tYXRjaDogZnVuY3Rpb24odG9rZW5UeXBlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IHRva2VuVHlwZSkgewogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiRXhwZWN0ZWQgIiArIHRva2VuVHlwZSArICIsIGdvdDogIiArIHQudHlwZSk7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfZXJyb3JUb2tlbjogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJJbnZhbGlkIHRva2VuICgiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnR5cGUgKyAiKTogXCIiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlICsgIlwiIik7CiAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9LAogIAogIAogICAgICAgIF9wYXJzZUluZGV4RXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT0xPTiB8fCB0aGlzLl9sb29rYWhlYWQoMSkgPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlU2xpY2VFeHByZXNzaW9uKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiSW5kZXgiLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLl9sb29rYWhlYWRUb2tlbigwKS52YWx1ZX07CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9wcm9qZWN0SWZTbGljZTogZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgICAgICAgdmFyIGluZGV4RXhwciA9IHt0eXBlOiAiSW5kZXhFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBpZiAocmlnaHQudHlwZSA9PT0gIlNsaWNlIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiUHJvamVjdGlvbiIsCiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFtpbmRleEV4cHIsIHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3RhcildCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4RXhwcjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlU2xpY2VFeHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gW3N0YXJ0OmVuZDpzdGVwXSB3aGVyZSBlYWNoIHBhcnQgaXMgb3B0aW9uYWwsIGFzIHdlbGwgYXMgdGhlIGxhc3QKICAgICAgICAgICAgLy8gY29sb24uCiAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRUb2tlbiAhPT0gVE9LX1JCUkFDS0VUICYmIGluZGV4IDwgMykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRUb2tlbiA9PT0gVE9LX05VTUJFUikgewogICAgICAgICAgICAgICAgICAgIHBhcnRzW2luZGV4XSA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJTeW50YXggZXJyb3IsIHVuZXhwZWN0ZWQgdG9rZW46ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlcmVycm9yIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgdHlwZTogIlNsaWNlIiwKICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBwYXJ0cwogICAgICAgICAgICB9OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlQ29tcGFyYXRvcjogZnVuY3Rpb24obGVmdCwgY29tcGFyYXRvcikgewogICAgICAgICAgdmFyIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlcltjb21wYXJhdG9yXSk7CiAgICAgICAgICByZXR1cm4ge3R5cGU6ICJDb21wYXJhdG9yIiwgbmFtZTogY29tcGFyYXRvciwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlRG90UkhTOiBmdW5jdGlvbihyYnApIHsKICAgICAgICAgICAgdmFyIGxvb2thaGVhZCA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgICAgdmFyIGV4cHJUb2tlbnMgPSBbVE9LX1VOUVVPVEVESURFTlRJRklFUiwgVE9LX1FVT1RFRElERU5USUZJRVIsIFRPS19TVEFSXTsKICAgICAgICAgICAgaWYgKGV4cHJUb2tlbnMuaW5kZXhPZihsb29rYWhlYWQpID49IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsb29rYWhlYWQgPT09IFRPS19MQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDS0VUKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGxvb2thaGVhZCA9PT0gVE9LX0xCUkFDRSkgewogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0xCUkFDRSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdEhhc2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlUHJvamVjdGlvblJIUzogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgICAgaWYgKGJpbmRpbmdQb3dlclt0aGlzLl9sb29rYWhlYWQoMCldIDwgMTApIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0xCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0ZJTFRFUikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19ET1QpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19ET1QpOwogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiU3l0YW54IGVycm9yLCB1bmV4cGVjdGVkIHRva2VuOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUGFyc2VyRXJyb3IiOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJpZ2h0OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlTXVsdGlzZWxlY3RMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGV4cHJlc3Npb25zID0gW107CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgdmFyIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICBleHByZXNzaW9ucy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCB0b2tlbiBSYnJhY2tldCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdExpc3QiLCBjaGlsZHJlbjogZXhwcmVzc2lvbnN9OwogICAgICAgIH0sCiAgCiAgICAgICAgX3BhcnNlTXVsdGlzZWxlY3RIYXNoOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBwYWlycyA9IFtdOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJUeXBlcyA9IFtUT0tfVU5RVU9URURJREVOVElGSUVSLCBUT0tfUVVPVEVESURFTlRJRklFUl07CiAgICAgICAgICB2YXIga2V5VG9rZW4sIGtleU5hbWUsIHZhbHVlLCBub2RlOwogICAgICAgICAgZm9yICg7OykgewogICAgICAgICAgICBrZXlUb2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICBpZiAoaWRlbnRpZmllclR5cGVzLmluZGV4T2Yoa2V5VG9rZW4udHlwZSkgPCAwKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RpbmcgYW4gaWRlbnRpZmllciB0b2tlbiwgZ290OiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5VG9rZW4udHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5TmFtZSA9IGtleVRva2VuLnZhbHVlOwogICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT0xPTik7CiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICBub2RlID0ge3R5cGU6ICJLZXlWYWx1ZVBhaXIiLCBuYW1lOiBrZXlOYW1lLCB2YWx1ZTogdmFsdWV9OwogICAgICAgICAgICBwYWlycy5wdXNoKG5vZGUpOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09NTUEpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDRSkgewogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4ge3R5cGU6ICJNdWx0aVNlbGVjdEhhc2giLCBjaGlsZHJlbjogcGFpcnN9OwogICAgICAgIH0KICAgIH07CiAgCiAgCiAgICBmdW5jdGlvbiBUcmVlSW50ZXJwcmV0ZXIocnVudGltZSkgewogICAgICB0aGlzLnJ1bnRpbWUgPSBydW50aW1lOwogICAgfQogIAogICAgVHJlZUludGVycHJldGVyLnByb3RvdHlwZSA9IHsKICAgICAgICBzZWFyY2g6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUsIHZhbHVlKTsKICAgICAgICB9LAogIAogICAgICAgIHZpc2l0OiBmdW5jdGlvbihub2RlLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgbWF0Y2hlZCwgY3VycmVudCwgcmVzdWx0LCBmaXJzdCwgc2Vjb25kLCBmaWVsZCwgbGVmdCwgcmlnaHQsIGNvbGxlY3RlZCwgaTsKICAgICAgICAgICAgc3dpdGNoIChub2RlLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlICJGaWVsZCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIGZpZWxkID0gdmFsdWVbbm9kZS5uYW1lXTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmllbGQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJTdWJleHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIkluZGV4RXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBsZWZ0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByaWdodCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmlnaHQ7CiAgICAgICAgICAgICAgY2FzZSAiSW5kZXgiOgogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IG5vZGUudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gdmFsdWUubGVuZ3RoICsgaW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXN1bHQgPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgY2FzZSAiU2xpY2UiOgogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzbGljZVBhcmFtcyA9IG5vZGUuY2hpbGRyZW4uc2xpY2UoMCk7CiAgICAgICAgICAgICAgICB2YXIgY29tcHV0ZWQgPSB0aGlzLmNvbXB1dGVTbGljZVBhcmFtcyh2YWx1ZS5sZW5ndGgsIHNsaWNlUGFyYW1zKTsKICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IGNvbXB1dGVkWzBdOwogICAgICAgICAgICAgICAgdmFyIHN0b3AgPSBjb21wdXRlZFsxXTsKICAgICAgICAgICAgICAgIHZhciBzdGVwID0gY29tcHV0ZWRbMl07CiAgICAgICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICAgIGlmIChzdGVwID4gMCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpIDwgc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpID4gc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIlByb2plY3Rpb24iOgogICAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICAgIHZhciBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoYmFzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYXNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGJhc2VbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIlZhbHVlUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgICAvLyBFdmFsdWF0ZSBsZWZ0IGNoaWxkLgogICAgICAgICAgICAgICAgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc09iamVjdChiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IG9ialZhbHVlcyhiYXNlKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWVzW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJGaWx0ZXJQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAgIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShiYXNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IFtdOwogICAgICAgICAgICAgICAgdmFyIGZpbmFsUmVzdWx0cyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJhc2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsyXSwgYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIGlmICghaXNGYWxzZShtYXRjaGVkKSkgewogICAgICAgICAgICAgICAgICAgIGZpbHRlcmVkLnB1c2goYmFzZVtpXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZmlsdGVyZWQubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgZmlsdGVyZWRbal0pOwogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGZpbmFsUmVzdWx0cy5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmluYWxSZXN1bHRzOwogICAgICAgICAgICAgIGNhc2UgIkNvbXBhcmF0b3IiOgogICAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHNlY29uZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgc3dpdGNoKG5vZGUubmFtZSkgewogICAgICAgICAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX05FOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9ICFzdHJpY3REZWVwRXF1YWwoZmlyc3QsIHNlY29uZCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0dUOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0ID4gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPj0gc2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19MVDoKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA8IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfTFRFOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0IDw9IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gY29tcGFyYXRvcjogIiArIG5vZGUubmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWwgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheShvcmlnaW5hbCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgbWVyZ2VkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3JpZ2luYWwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IG9yaWdpbmFsW2ldOwogICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjdXJyZW50KSkgewogICAgICAgICAgICAgICAgICAgIG1lcmdlZC5wdXNoLmFwcGx5KG1lcmdlZCwgY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICAgICAgICAgICAgY2FzZSAiSWRlbnRpdHkiOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgIGNhc2UgIk11bHRpU2VsZWN0TGlzdCI6CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2godGhpcy52aXNpdChub2RlLmNoaWxkcmVuW2ldLCB2YWx1ZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJNdWx0aVNlbGVjdEhhc2giOgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0ge307CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjaGlsZCA9IG5vZGUuY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZFtjaGlsZC5uYW1lXSA9IHRoaXMudmlzaXQoY2hpbGQudmFsdWUsIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiT3JFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChpc0ZhbHNlKG1hdGNoZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZWQ7CiAgICAgICAgICAgICAgY2FzZSAiQW5kRXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogIAogICAgICAgICAgICAgICAgaWYgKGlzRmFsc2UoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICBjYXNlICJOb3RFeHByZXNzaW9uIjoKICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNGYWxzZShmaXJzdCk7CiAgICAgICAgICAgICAgY2FzZSAiTGl0ZXJhbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICBjYXNlICJGdW5jdGlvbiI6CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRBcmdzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmVkQXJncy5wdXNoKHRoaXMudmlzaXQobm9kZS5jaGlsZHJlbltpXSwgdmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1bnRpbWUuY2FsbEZ1bmN0aW9uKG5vZGUubmFtZSwgcmVzb2x2ZWRBcmdzKTsKICAgICAgICAgICAgICBjYXNlICJFeHByZXNzaW9uUmVmZXJlbmNlIjoKICAgICAgICAgICAgICAgIHZhciByZWZOb2RlID0gbm9kZS5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIC8vIFRhZyB0aGUgbm9kZSB3aXRoIGEgc3BlY2lmaWMgYXR0cmlidXRlIHNvIHRoZSB0eXBlCiAgICAgICAgICAgICAgICAvLyBjaGVja2VyIHZlcmlmeSB0aGUgdHlwZS4KICAgICAgICAgICAgICAgIHJlZk5vZGUuam1lc3BhdGhUeXBlID0gVE9LX0VYUFJFRjsKICAgICAgICAgICAgICAgIHJldHVybiByZWZOb2RlOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbm9kZSB0eXBlOiAiICsgbm9kZS50eXBlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgY29tcHV0ZVNsaWNlUGFyYW1zOiBmdW5jdGlvbihhcnJheUxlbmd0aCwgc2xpY2VQYXJhbXMpIHsKICAgICAgICAgIHZhciBzdGFydCA9IHNsaWNlUGFyYW1zWzBdOwogICAgICAgICAgdmFyIHN0b3AgPSBzbGljZVBhcmFtc1sxXTsKICAgICAgICAgIHZhciBzdGVwID0gc2xpY2VQYXJhbXNbMl07CiAgICAgICAgICB2YXIgY29tcHV0ZWQgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgICBpZiAoc3RlcCA9PT0gbnVsbCkgewogICAgICAgICAgICBzdGVwID0gMTsKICAgICAgICAgIH0gZWxzZSBpZiAoc3RlcCA9PT0gMCkgewogICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkludmFsaWQgc2xpY2UsIHN0ZXAgY2Fubm90IGJlIDAiKTsKICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJSdW50aW1lRXJyb3IiOwogICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGVwVmFsdWVOZWdhdGl2ZSA9IHN0ZXAgPCAwID8gdHJ1ZSA6IGZhbHNlOwogIAogICAgICAgICAgaWYgKHN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgc3RhcnQgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IGFycmF5TGVuZ3RoIC0gMSA6IDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5jYXBTbGljZVJhbmdlKGFycmF5TGVuZ3RoLCBzdGFydCwgc3RlcCk7CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoc3RvcCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHN0b3AgPSBzdGVwVmFsdWVOZWdhdGl2ZSA/IC0xIDogYXJyYXlMZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3AgPSB0aGlzLmNhcFNsaWNlUmFuZ2UoYXJyYXlMZW5ndGgsIHN0b3AsIHN0ZXApOwogICAgICAgICAgfQogICAgICAgICAgY29tcHV0ZWRbMF0gPSBzdGFydDsKICAgICAgICAgIGNvbXB1dGVkWzFdID0gc3RvcDsKICAgICAgICAgIGNvbXB1dGVkWzJdID0gc3RlcDsKICAgICAgICAgIHJldHVybiBjb21wdXRlZDsKICAgICAgICB9LAogIAogICAgICAgIGNhcFNsaWNlUmFuZ2U6IGZ1bmN0aW9uKGFycmF5TGVuZ3RoLCBhY3R1YWxWYWx1ZSwgc3RlcCkgewogICAgICAgICAgICBpZiAoYWN0dWFsVmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSArPSBhcnJheUxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChhY3R1YWxWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gLTEgOiAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFjdHVhbFZhbHVlID49IGFycmF5TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gYXJyYXlMZW5ndGggLSAxIDogYXJyYXlMZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFjdHVhbFZhbHVlOwogICAgICAgIH0KICAKICAgIH07CiAgCiAgICBmdW5jdGlvbiBSdW50aW1lKGludGVycHJldGVyKSB7CiAgICAgIHRoaXMuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICAgIHRoaXMuZnVuY3Rpb25UYWJsZSA9IHsKICAgICAgICAgIC8vIG5hbWU6IFtmdW5jdGlvbiwgPHNpZ25hdHVyZT5dCiAgICAgICAgICAvLyBUaGUgPHNpZ25hdHVyZT4gY2FuIGJlOgogICAgICAgICAgLy8KICAgICAgICAgIC8vIHsKICAgICAgICAgIC8vICAgYXJnczogW1t0eXBlMSwgdHlwZTJdLCBbdHlwZTEsIHR5cGUyXV0sCiAgICAgICAgICAvLyAgIHZhcmlhZGljOiB0cnVlfGZhbHNlCiAgICAgICAgICAvLyB9CiAgICAgICAgICAvLwogICAgICAgICAgLy8gRWFjaCBhcmcgaW4gdGhlIGFyZyBsaXN0IGlzIGEgbGlzdCBvZiB2YWxpZCB0eXBlcwogICAgICAgICAgLy8gKGlmIHRoZSBmdW5jdGlvbiBpcyBvdmVybG9hZGVkIGFuZCBzdXBwb3J0cyBtdWx0aXBsZQogICAgICAgICAgLy8gdHlwZXMuICBJZiB0aGUgdHlwZSBpcyAiYW55IiB0aGVuIG5vIHR5cGUgY2hlY2tpbmcKICAgICAgICAgIC8vIG9jY3VycyBvbiB0aGUgYXJndW1lbnQuICBWYXJpYWRpYyBpcyBvcHRpb25hbAogICAgICAgICAgLy8gYW5kIGlmIG5vdCBwcm92aWRlZCBpcyBhc3N1bWVkIHRvIGJlIGZhbHNlLgogICAgICAgICAgYWJzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQWJzLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgICAgYXZnOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQXZnLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICAgY2VpbDoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkNlaWwsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBjb250YWluczogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkNvbnRhaW5zLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19LAogICAgICAgICAgICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJlbmRzX3dpdGgiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRW5kc1dpdGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HXX0sIHt0eXBlczogW1RZUEVfU1RSSU5HXX1dfSwKICAgICAgICAgIGZsb29yOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRmxvb3IsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgICBsZW5ndGg6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25MZW5ndGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZLCBUWVBFX09CSkVDVF19XX0sCiAgICAgICAgICBtYXA6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXAsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfRVhQUkVGXX0sIHt0eXBlczogW1RZUEVfQVJSQVldfV19LAogICAgICAgICAgbWF4OiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWF4LAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICAgIm1lcmdlIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1lcmdlLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF0sIHZhcmlhZGljOiB0cnVlfV0KICAgICAgICAgIH0sCiAgICAgICAgICAibWF4X2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXhCeSwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICAgIH0sCiAgICAgICAgICBzdW06IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25TdW0sIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgICAic3RhcnRzX3dpdGgiOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU3RhcnRzV2l0aCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkddfSwge3R5cGVzOiBbVFlQRV9TVFJJTkddfV19LAogICAgICAgICAgbWluOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICAgIm1pbl9ieSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWluQnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgdHlwZToge19mdW5jOiB0aGlzLl9mdW5jdGlvblR5cGUsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICBrZXlzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uS2V5cywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIHZhbHVlczoge19mdW5jOiB0aGlzLl9mdW5jdGlvblZhbHVlcywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICAgIHNvcnQ6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0LCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9TVFJJTkcsIFRZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAgICJzb3J0X2J5IjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Tb3J0QnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgam9pbjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkpvaW4sCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogWwogICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX1NUUklOR119LAogICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX0FSUkFZX1NUUklOR119CiAgICAgICAgICAgICAgXQogICAgICAgICAgfSwKICAgICAgICAgIHJldmVyc2U6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25SZXZlcnNlLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWV19XX0sCiAgICAgICAgICAidG9fYXJyYXkiOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9BcnJheSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJ0b19zdHJpbmciOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9TdHJpbmcsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAidG9fbnVtYmVyIjoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvTnVtYmVyLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgIm5vdF9udWxsIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk5vdE51bGwsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXSwgdmFyaWFkaWM6IHRydWV9XQogICAgICAgICAgfQogICAgICB9OwogICAgfQogIAogICAgUnVudGltZS5wcm90b3R5cGUgPSB7CiAgICAgIGNhbGxGdW5jdGlvbjogZnVuY3Rpb24obmFtZSwgcmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uRW50cnkgPSB0aGlzLmZ1bmN0aW9uVGFibGVbbmFtZV07CiAgICAgICAgaWYgKGZ1bmN0aW9uRW50cnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZnVuY3Rpb246ICIgKyBuYW1lICsgIigpIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3ZhbGlkYXRlQXJncyhuYW1lLCByZXNvbHZlZEFyZ3MsIGZ1bmN0aW9uRW50cnkuX3NpZ25hdHVyZSk7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uRW50cnkuX2Z1bmMuY2FsbCh0aGlzLCByZXNvbHZlZEFyZ3MpOwogICAgICB9LAogIAogICAgICBfdmFsaWRhdGVBcmdzOiBmdW5jdGlvbihuYW1lLCBhcmdzLCBzaWduYXR1cmUpIHsKICAgICAgICAgIC8vIFZhbGlkYXRpbmcgdGhlIGFyZ3MgcmVxdWlyZXMgdmFsaWRhdGluZwogICAgICAgICAgLy8gdGhlIGNvcnJlY3QgYXJpdHkgYW5kIHRoZSBjb3JyZWN0IHR5cGUgb2YgZWFjaCBhcmcuCiAgICAgICAgICAvLyBJZiB0aGUgbGFzdCBhcmd1bWVudCBpcyBkZWNsYXJlZCBhcyB2YXJpYWRpYywgdGhlbiB3ZSBuZWVkCiAgICAgICAgICAvLyBhIG1pbmltdW0gbnVtYmVyIG9mIGFyZ3MgdG8gYmUgcmVxdWlyZWQuICBPdGhlcndpc2UgaXQgaGFzIHRvCiAgICAgICAgICAvLyBiZSBhbiBleGFjdCBhbW91bnQuCiAgICAgICAgICB2YXIgcGx1cmFsaXplZDsKICAgICAgICAgIGlmIChzaWduYXR1cmVbc2lnbmF0dXJlLmxlbmd0aCAtIDFdLnZhcmlhZGljKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBwbHVyYWxpemVkID0gc2lnbmF0dXJlLmxlbmd0aCA9PT0gMSA/ICIgYXJndW1lbnQiIDogIiBhcmd1bWVudHMiOwogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50RXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzIGF0IGxlYXN0IiArIHNpZ25hdHVyZS5sZW5ndGggKyBwbHVyYWxpemVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCAhPT0gc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICAgIHBsdXJhbGl6ZWQgPSBzaWduYXR1cmUubGVuZ3RoID09PSAxID8gIiBhcmd1bWVudCIgOiAiIGFyZ3VtZW50cyI7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudEVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzICIgKyBzaWduYXR1cmUubGVuZ3RoICsgcGx1cmFsaXplZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkICIgKyBhcmdzLmxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNwZWM7CiAgICAgICAgICB2YXIgYWN0dWFsVHlwZTsKICAgICAgICAgIHZhciB0eXBlTWF0Y2hlZDsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2lnbmF0dXJlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdHlwZU1hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBjdXJyZW50U3BlYyA9IHNpZ25hdHVyZVtpXS50eXBlczsKICAgICAgICAgICAgICBhY3R1YWxUeXBlID0gdGhpcy5fZ2V0VHlwZU5hbWUoYXJnc1tpXSk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjdXJyZW50U3BlYy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdHlwZU1hdGNoZXMoYWN0dWFsVHlwZSwgY3VycmVudFNwZWNbal0sIGFyZ3NbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXR5cGVNYXRjaGVkKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJleHBlY3RlZCBhcmd1bWVudCAiICsgKGkgKyAxKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIHRvIGJlIHR5cGUgIiArIGN1cnJlbnRTcGVjICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkIHR5cGUgIiArIGFjdHVhbFR5cGUgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX3R5cGVNYXRjaGVzOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBhcmdWYWx1ZSkgewogICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FOWSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX1NUUklORyB8fAogICAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUiB8fAogICAgICAgICAgICAgIGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgLy8gVGhlIGV4cGVjdGVkIHR5cGUgY2FuIGVpdGhlciBqdXN0IGJlIGFycmF5LAogICAgICAgICAgICAgIC8vIG9yIGl0IGNhbiByZXF1aXJlIGEgc3BlY2lmaWMgc3VidHlwZSAoYXJyYXkgb2YgbnVtYmVycykuCiAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAvLyBUaGUgc2ltcGxlc3QgY2FzZSBpcyBpZiAiYXJyYXkiIHdpdGggbm8gc3VidHlwZSBpcyBzcGVjaWZpZWQuCiAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IFRZUEVfQVJSQVk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChhY3R1YWwgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlIHdlIG5lZWQgdG8gY2hlY2sgc3VidHlwZXMuCiAgICAgICAgICAgICAgICAgIC8vIEkgdGhpbmsgdGhpcyBoYXMgcG90ZW50aWFsIHRvIGJlIGltcHJvdmVkLgogICAgICAgICAgICAgICAgICB2YXIgc3VidHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX05VTUJFUikgewogICAgICAgICAgICAgICAgICAgIHN1YnR5cGUgPSBUWVBFX05VTUJFUjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9TVFJJTkcpIHsKICAgICAgICAgICAgICAgICAgICBzdWJ0eXBlID0gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdWYWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl90eXBlTWF0Y2hlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZ2V0VHlwZU5hbWUoYXJnVmFsdWVbaV0pLCBzdWJ0eXBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ1ZhbHVlW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBhY3R1YWwgPT09IGV4cGVjdGVkOwogICAgICAgICAgfQogICAgICB9LAogICAgICBfZ2V0VHlwZU5hbWU6IGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgc3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSkgewogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgU3RyaW5nXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9TVFJJTkc7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdW1iZXJdIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX05VTUJFUjsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IEFycmF5XSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9BUlJBWTsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IEJvb2xlYW5dIjoKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0JPT0xFQU47CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBOdWxsXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OVUxMOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgT2JqZWN0XSI6CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBpdCdzIGFuIGV4cHJlZi4gIElmIGl0IGhhcywgaXQncyBiZWVuCiAgICAgICAgICAgICAgICAvLyB0YWdnZWQgd2l0aCBhIGptZXNwYXRoVHlwZSBhdHRyIG9mICdFeHByZWYnOwogICAgICAgICAgICAgICAgaWYgKG9iai5qbWVzcGF0aFR5cGUgPT09IFRPS19FWFBSRUYpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfRVhQUkVGOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfT0JKRUNUOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25TdGFydHNXaXRoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGFzdEluZGV4T2YocmVzb2x2ZWRBcmdzWzFdKSA9PT0gMDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uRW5kc1dpdGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHNlYXJjaFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBzdWZmaXggPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgICByZXR1cm4gc2VhcmNoU3RyLmluZGV4T2Yoc3VmZml4LCBzZWFyY2hTdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aCkgIT09IC0xOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25SZXZlcnNlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFN0ciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgdmFyIHJldmVyc2VkU3RyID0gIiI7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBvcmlnaW5hbFN0ci5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgcmV2ZXJzZWRTdHIgKz0gb3JpZ2luYWxTdHJbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VkU3RyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJldmVyc2VkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICAgIHJldmVyc2VkQXJyYXkucmV2ZXJzZSgpOwogICAgICAgICAgICByZXR1cm4gcmV2ZXJzZWRBcnJheTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQWJzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gTWF0aC5hYnMocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uQ2VpbDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkF2ZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc3VtID0gMDsKICAgICAgICAgIHZhciBpbnB1dEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnB1dEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgc3VtICs9IGlucHV0QXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3VtIC8gaW5wdXRBcnJheS5sZW5ndGg7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkNvbnRhaW5zOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0uaW5kZXhPZihyZXNvbHZlZEFyZ3NbMV0pID49IDA7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkZsb29yOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkxlbmd0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgIGlmICghaXNPYmplY3QocmVzb2x2ZWRBcmdzWzBdKSkgewogICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoOwogICAgICAgICB9IGVsc2UgewogICAgICAgICAgIC8vIEFzIGZhciBhcyBJIGNhbiB0ZWxsLCB0aGVyZSdzIG5vIHdheSB0byBnZXQgdGhlIGxlbmd0aAogICAgICAgICAgIC8vIG9mIGFuIG9iamVjdCB3aXRob3V0IE8obikgaXRlcmF0aW9uIHRocm91Z2ggdGhlIG9iamVjdC4KICAgICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVzb2x2ZWRBcmdzWzBdKS5sZW5ndGg7CiAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWFwOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgbWFwcGVkID0gW107CiAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbWFwcGVkLnB1c2goaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgZWxlbWVudHNbaV0pKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hcHBlZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWVyZ2U6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBtZXJnZWQgPSB7fTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGN1cnJlbnQgPSByZXNvbHZlZEFyZ3NbaV07CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY3VycmVudCkgewogICAgICAgICAgICBtZXJnZWRba2V5XSA9IGN1cnJlbnRba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lcmdlZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWF4OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBpZiAocmVzb2x2ZWRBcmdzWzBdLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXVswXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCByZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICB2YXIgbWF4RWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobWF4RWxlbWVudC5sb2NhbGVDb21wYXJlKGVsZW1lbnRzW2ldKSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBtYXhFbGVtZW50ID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heEVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIGlmIChyZXNvbHZlZEFyZ3NbMF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdWzBdKTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIHZhciBtaW5FbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50c1tpXS5sb2NhbGVDb21wYXJlKG1pbkVsZW1lbnQpIDwgMCkgewogICAgICAgICAgICAgICAgICAgIG1pbkVsZW1lbnQgPSBlbGVtZW50c1tpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWluRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25TdW06IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBzdW0gPSAwOwogICAgICAgIHZhciBsaXN0VG9TdW0gPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0VG9TdW0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHN1bSArPSBsaXN0VG9TdW1baV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdW07CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblR5cGU6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgc3dpdGNoICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pKSB7CiAgICAgICAgICAgIGNhc2UgVFlQRV9OVU1CRVI6CiAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgICBjYXNlIFRZUEVfU1RSSU5HOgogICAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgICAgY2FzZSBUWVBFX0FSUkFZOgogICAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgICAgICBjYXNlIFRZUEVfT0JKRUNUOgogICAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKICAgICAgICAgICAgY2FzZSBUWVBFX0JPT0xFQU46CiAgICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsKICAgICAgICAgICAgY2FzZSBUWVBFX0VYUFJFRjoKICAgICAgICAgICAgICByZXR1cm4gImV4cHJlZiI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9OVUxMOgogICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbktleXM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblZhbHVlczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgb2JqID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvYmopOwogICAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsdWVzLnB1c2gob2JqW2tleXNbaV1dKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkpvaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIGpvaW5DaGFyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIGxpc3RKb2luID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgcmV0dXJuIGxpc3RKb2luLmpvaW4oam9pbkNoYXIpOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub0FycmF5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIFtyZXNvbHZlZEFyZ3NbMF1dOwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ub1N0cmluZzogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVG9OdW1iZXI6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIHZhciBjb252ZXJ0ZWRWYWx1ZTsKICAgICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgICBjb252ZXJ0ZWRWYWx1ZSA9ICtyZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgICAgaWYgKCFpc05hTihjb252ZXJ0ZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnRlZFZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Ob3ROdWxsOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1tpXSkgIT09IFRZUEVfTlVMTCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Tb3J0OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgIHNvcnRlZEFycmF5LnNvcnQoKTsKICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU29ydEJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzb3J0ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgIGlmIChzb3J0ZWRBcnJheS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgdmFyIHJlcXVpcmVkVHlwZSA9IHRoaXMuX2dldFR5cGVOYW1lKAogICAgICAgICAgICAgIGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIHNvcnRlZEFycmF5WzBdKSk7CiAgICAgICAgICBpZiAoW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10uaW5kZXhPZihyZXF1aXJlZFR5cGUpIDwgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgICAvLyBJbiBvcmRlciB0byBnZXQgYSBzdGFibGUgc29ydCBvdXQgb2YgYW4gdW5zdGFibGUKICAgICAgICAgIC8vIHNvcnQgYWxnb3JpdGhtLCB3ZSBkZWNvcmF0ZS9zb3J0L3VuZGVjb3JhdGUgKERTVSkKICAgICAgICAgIC8vIGJ5IGNyZWF0aW5nIGEgbmV3IGxpc3Qgb2YgW2luZGV4LCBlbGVtZW50XSBwYWlycy4KICAgICAgICAgIC8vIEluIHRoZSBjbXAgZnVuY3Rpb24sIGlmIHRoZSBldmFsdWF0ZWQgZWxlbWVudHMgYXJlCiAgICAgICAgICAvLyBlcXVhbCwgdGhlbiB0aGUgaW5kZXggd2lsbCBiZSB1c2VkIGFzIHRoZSB0aWVicmVha2VyLgogICAgICAgICAgLy8gQWZ0ZXIgdGhlIGRlY29yYXRlZCBsaXN0IGhhcyBiZWVuIHNvcnRlZCwgaXQgd2lsbCBiZQogICAgICAgICAgLy8gdW5kZWNvcmF0ZWQgdG8gZXh0cmFjdCB0aGUgb3JpZ2luYWwgZWxlbWVudHMuCiAgICAgICAgICB2YXIgZGVjb3JhdGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGRlY29yYXRlZC5wdXNoKFtpLCBzb3J0ZWRBcnJheVtpXV0pOwogICAgICAgICAgfQogICAgICAgICAgZGVjb3JhdGVkLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICB2YXIgZXhwckEgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBhWzFdKTsKICAgICAgICAgICAgdmFyIGV4cHJCID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgYlsxXSk7CiAgICAgICAgICAgIGlmICh0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkgIT09IHJlcXVpcmVkVHlwZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAgICJUeXBlRXJyb3I6IGV4cGVjdGVkICIgKyByZXF1aXJlZFR5cGUgKyAiLCByZWNlaXZlZCAiICsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSAhPT0gcmVxdWlyZWRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgICAgICAgIlR5cGVFcnJvcjogZXhwZWN0ZWQgIiArIHJlcXVpcmVkVHlwZSArICIsIHJlY2VpdmVkICIgKwogICAgICAgICAgICAgICAgICAgIHRoYXQuX2dldFR5cGVOYW1lKGV4cHJCKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4cHJBID4gZXhwckIpIHsKICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChleHByQSA8IGV4cHJCKSB7CiAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIHRoZXkncmUgZXF1YWwgY29tcGFyZSB0aGUgaXRlbXMgYnkgdGhlaXIKICAgICAgICAgICAgICAvLyBvcmRlciB0byBtYWludGFpbiByZWxhdGl2ZSBvcmRlciBvZiBlcXVhbCBrZXlzCiAgICAgICAgICAgICAgLy8gKGkuZS4gdG8gZ2V0IGEgc3RhYmxlIHNvcnQpLgogICAgICAgICAgICAgIHJldHVybiBhWzBdIC0gYlswXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICAvLyBVbmRlY29yYXRlOiBleHRyYWN0IG91dCB0aGUgb3JpZ2luYWwgbGlzdCBlbGVtZW50cy4KICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGVjb3JhdGVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHNvcnRlZEFycmF5W2pdID0gZGVjb3JhdGVkW2pdWzFdOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25NYXhCeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIGV4cHJlZk5vZGUgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgdmFyIHJlc29sdmVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgdmFyIGtleUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVLZXlGdW5jdGlvbihleHByZWZOb2RlLCBbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXSk7CiAgICAgICAgdmFyIG1heE51bWJlciA9IC1JbmZpbml0eTsKICAgICAgICB2YXIgbWF4UmVjb3JkOwogICAgICAgIHZhciBjdXJyZW50OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgICAgaWYgKGN1cnJlbnQgPiBtYXhOdW1iZXIpIHsKICAgICAgICAgICAgbWF4TnVtYmVyID0gY3VycmVudDsKICAgICAgICAgICAgbWF4UmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1heFJlY29yZDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWluQnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHZhciByZXNvbHZlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBrZXlGdW5jdGlvbiA9IHRoaXMuY3JlYXRlS2V5RnVuY3Rpb24oZXhwcmVmTm9kZSwgW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10pOwogICAgICAgIHZhciBtaW5OdW1iZXIgPSBJbmZpbml0eTsKICAgICAgICB2YXIgbWluUmVjb3JkOwogICAgICAgIHZhciBjdXJyZW50OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgY3VycmVudCA9IGtleUZ1bmN0aW9uKHJlc29sdmVkQXJyYXlbaV0pOwogICAgICAgICAgaWYgKGN1cnJlbnQgPCBtaW5OdW1iZXIpIHsKICAgICAgICAgICAgbWluTnVtYmVyID0gY3VycmVudDsKICAgICAgICAgICAgbWluUmVjb3JkID0gcmVzb2x2ZWRBcnJheVtpXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1pblJlY29yZDsKICAgICAgfSwKICAKICAgICAgY3JlYXRlS2V5RnVuY3Rpb246IGZ1bmN0aW9uKGV4cHJlZk5vZGUsIGFsbG93ZWRUeXBlcykgewogICAgICAgIHZhciB0aGF0ID0gdGhpczsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgICB2YXIga2V5RnVuYyA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgeCk7CiAgICAgICAgICBpZiAoYWxsb3dlZFR5cGVzLmluZGV4T2YodGhhdC5fZ2V0VHlwZU5hbWUoY3VycmVudCkpIDwgMCkgewogICAgICAgICAgICB2YXIgbXNnID0gIlR5cGVFcnJvcjogZXhwZWN0ZWQgb25lIG9mICIgKyBhbGxvd2VkVHlwZXMgKwogICAgICAgICAgICAgICAgICAgICAgIiwgcmVjZWl2ZWQgIiArIHRoYXQuX2dldFR5cGVOYW1lKGN1cnJlbnQpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGtleUZ1bmM7CiAgICAgIH0KICAKICAgIH07CiAgCiAgICBmdW5jdGlvbiBjb21waWxlKHN0cmVhbSkgewogICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcigpOwogICAgICB2YXIgYXN0ID0gcGFyc2VyLnBhcnNlKHN0cmVhbSk7CiAgICAgIHJldHVybiBhc3Q7CiAgICB9CiAgCiAgICBmdW5jdGlvbiB0b2tlbml6ZShzdHJlYW0pIHsKICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoKTsKICAgICAgICByZXR1cm4gbGV4ZXIudG9rZW5pemUoc3RyZWFtKTsKICAgIH0KICAKICAgIGZ1bmN0aW9uIHNlYXJjaChkYXRhLCBleHByZXNzaW9uKSB7CiAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIoKTsKICAgICAgICAvLyBUaGlzIG5lZWRzIHRvIGJlIGltcHJvdmVkLiAgQm90aCB0aGUgaW50ZXJwcmV0ZXIgYW5kIHJ1bnRpbWUgZGVwZW5kIG9uCiAgICAgICAgLy8gZWFjaCBvdGhlci4gIFRoZSBydW50aW1lIG5lZWRzIHRoZSBpbnRlcnByZXRlciB0byBzdXBwb3J0IGV4cHJlZnMuCiAgICAgICAgLy8gVGhlcmUncyBsaWtlbHkgYSBjbGVhbiB3YXkgdG8gYXZvaWQgdGhlIGN5Y2xpYyBkZXBlbmRlbmN5LgogICAgICAgIHZhciBydW50aW1lID0gbmV3IFJ1bnRpbWUoKTsKICAgICAgICB2YXIgaW50ZXJwcmV0ZXIgPSBuZXcgVHJlZUludGVycHJldGVyKHJ1bnRpbWUpOwogICAgICAgIHJ1bnRpbWUuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIG5vZGUgPSBwYXJzZXIucGFyc2UoZXhwcmVzc2lvbik7CiAgICAgICAgcmV0dXJuIGludGVycHJldGVyLnNlYXJjaChub2RlLCBkYXRhKTsKICAgIH0KICAKICAgIGV4cG9ydHMudG9rZW5pemUgPSB0b2tlbml6ZTsKICAgIGV4cG9ydHMuY29tcGlsZSA9IGNvbXBpbGU7CiAgICBleHBvcnRzLnNlYXJjaCA9IHNlYXJjaDsKICAgIGV4cG9ydHMuc3RyaWN0RGVlcEVxdWFsID0gc3RyaWN0RGVlcEVxdWFsOwogIH0pKHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiA/IHRoaXMuam1lc3BhdGggPSB7fSA6IGV4cG9ydHMpOwogIAogIH0se31dLDg2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBzaGltIGZvciB1c2luZyBwcm9jZXNzIGluIGJyb3dzZXIKICB2YXIgcHJvY2VzcyA9IG1vZHVsZS5leHBvcnRzID0ge307CiAgCiAgLy8gY2FjaGVkIGZyb20gd2hhdGV2ZXIgZ2xvYmFsIGlzIHByZXNlbnQgc28gdGhhdCB0ZXN0IHJ1bm5lcnMgdGhhdCBzdHViIGl0CiAgLy8gZG9uJ3QgYnJlYWsgdGhpbmdzLiAgQnV0IHdlIG5lZWQgdG8gd3JhcCBpdCBpbiBhIHRyeSBjYXRjaCBpbiBjYXNlIGl0IGlzCiAgLy8gd3JhcHBlZCBpbiBzdHJpY3QgbW9kZSBjb2RlIHdoaWNoIGRvZXNuJ3QgZGVmaW5lIGFueSBnbG9iYWxzLiAgSXQncyBpbnNpZGUgYQogIC8vIGZ1bmN0aW9uIGJlY2F1c2UgdHJ5L2NhdGNoZXMgZGVvcHRpbWl6ZSBpbiBjZXJ0YWluIGVuZ2luZXMuCiAgCiAgdmFyIGNhY2hlZFNldFRpbWVvdXQ7CiAgdmFyIGNhY2hlZENsZWFyVGltZW91dDsKICAKICBmdW5jdGlvbiBkZWZhdWx0U2V0VGltb3V0KCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQnKTsKICB9CiAgZnVuY3Rpb24gZGVmYXVsdENsZWFyVGltZW91dCAoKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignY2xlYXJUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7CiAgfQogIChmdW5jdGlvbiAoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodHlwZW9mIHNldFRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IGRlZmF1bHRTZXRUaW1vdXQ7CiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0OwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNsZWFyVGltZW91dCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gZGVmYXVsdENsZWFyVGltZW91dDsKICAgICAgfQogIH0gKCkpCiAgZnVuY3Rpb24gcnVuVGltZW91dChmdW4pIHsKICAgICAgaWYgKGNhY2hlZFNldFRpbWVvdXQgPT09IHNldFRpbWVvdXQpIHsKICAgICAgICAgIC8vbm9ybWFsIGVudmlyb21lbnRzIGluIHNhbmUgc2l0dWF0aW9ucwogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfQogICAgICAvLyBpZiBzZXRUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgICBpZiAoKGNhY2hlZFNldFRpbWVvdXQgPT09IGRlZmF1bHRTZXRUaW1vdXQgfHwgIWNhY2hlZFNldFRpbWVvdXQpICYmIHNldFRpbWVvdXQpIHsKICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQoZnVuLCAwKTsKICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0IHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5CiAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbChudWxsLCBmdW4sIDApOwogICAgICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvcgogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwodGhpcywgZnVuLCAwKTsKICAgICAgICAgIH0KICAgICAgfQogIAogIAogIH0KICBmdW5jdGlvbiBydW5DbGVhclRpbWVvdXQobWFya2VyKSB7CiAgICAgIGlmIChjYWNoZWRDbGVhclRpbWVvdXQgPT09IGNsZWFyVGltZW91dCkgewogICAgICAgICAgLy9ub3JtYWwgZW52aXJvbWVudHMgaW4gc2FuZSBzaXR1YXRpb25zCiAgICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0KICAgICAgLy8gaWYgY2xlYXJUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgICBpZiAoKGNhY2hlZENsZWFyVGltZW91dCA9PT0gZGVmYXVsdENsZWFyVGltZW91dCB8fCAhY2FjaGVkQ2xlYXJUaW1lb3V0KSAmJiBjbGVhclRpbWVvdXQpIHsKICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgICAgcmV0dXJuIGNhY2hlZENsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBhcmUgaW4gSS5FLiBidXQgdGhlIHNjcmlwdCBoYXMgYmVlbiBldmFsZWQgc28gSS5FLiBkb2Vzbid0ICB0cnVzdCB0aGUgZ2xvYmFsIG9iamVjdCB3aGVuIGNhbGxlZCBub3JtYWxseQogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbChudWxsLCBtYXJrZXIpOwogICAgICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2hlbiBpdCdzIGEgdmVyc2lvbiBvZiBJLkUuIHRoYXQgbXVzdCBoYXZlIHRoZSBnbG9iYWwgb2JqZWN0IGZvciAndGhpcycsIGhvcGZ1bGx5IG91ciBjb250ZXh0IGNvcnJlY3Qgb3RoZXJ3aXNlIGl0IHdpbGwgdGhyb3cgYSBnbG9iYWwgZXJyb3IuCiAgICAgICAgICAgICAgLy8gU29tZSB2ZXJzaW9ucyBvZiBJLkUuIGhhdmUgZGlmZmVyZW50IHJ1bGVzIGZvciBjbGVhclRpbWVvdXQgdnMgc2V0VGltZW91dAogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbCh0aGlzLCBtYXJrZXIpOwogICAgICAgICAgfQogICAgICB9CiAgCiAgCiAgCiAgfQogIHZhciBxdWV1ZSA9IFtdOwogIHZhciBkcmFpbmluZyA9IGZhbHNlOwogIHZhciBjdXJyZW50UXVldWU7CiAgdmFyIHF1ZXVlSW5kZXggPSAtMTsKICAKICBmdW5jdGlvbiBjbGVhblVwTmV4dFRpY2soKSB7CiAgICAgIGlmICghZHJhaW5pbmcgfHwgIWN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGRyYWluaW5nID0gZmFsc2U7CiAgICAgIGlmIChjdXJyZW50UXVldWUubGVuZ3RoKSB7CiAgICAgICAgICBxdWV1ZSA9IGN1cnJlbnRRdWV1ZS5jb25jYXQocXVldWUpOwogICAgICB9IGVsc2UgewogICAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICB9CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgIGRyYWluUXVldWUoKTsKICAgICAgfQogIH0KICAKICBmdW5jdGlvbiBkcmFpblF1ZXVlKCkgewogICAgICBpZiAoZHJhaW5pbmcpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGltZW91dCA9IHJ1blRpbWVvdXQoY2xlYW5VcE5leHRUaWNrKTsKICAgICAgZHJhaW5pbmcgPSB0cnVlOwogIAogICAgICB2YXIgbGVuID0gcXVldWUubGVuZ3RoOwogICAgICB3aGlsZShsZW4pIHsKICAgICAgICAgIGN1cnJlbnRRdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgcXVldWUgPSBbXTsKICAgICAgICAgIHdoaWxlICgrK3F1ZXVlSW5kZXggPCBsZW4pIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRRdWV1ZVtxdWV1ZUluZGV4XS5ydW4oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZUluZGV4ID0gLTE7CiAgICAgICAgICBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICAgIH0KICAgICAgY3VycmVudFF1ZXVlID0gbnVsbDsKICAgICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgICAgcnVuQ2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogIH0KICAKICBwcm9jZXNzLm5leHRUaWNrID0gZnVuY3Rpb24gKGZ1bikgewogICAgICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoIC0gMSk7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBhcmdzW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgIH0KICAgICAgfQogICAgICBxdWV1ZS5wdXNoKG5ldyBJdGVtKGZ1biwgYXJncykpOwogICAgICBpZiAocXVldWUubGVuZ3RoID09PSAxICYmICFkcmFpbmluZykgewogICAgICAgICAgcnVuVGltZW91dChkcmFpblF1ZXVlKTsKICAgICAgfQogIH07CiAgCiAgLy8gdjggbGlrZXMgcHJlZGljdGlibGUgb2JqZWN0cwogIGZ1bmN0aW9uIEl0ZW0oZnVuLCBhcnJheSkgewogICAgICB0aGlzLmZ1biA9IGZ1bjsKICAgICAgdGhpcy5hcnJheSA9IGFycmF5OwogIH0KICBJdGVtLnByb3RvdHlwZS5ydW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuZnVuLmFwcGx5KG51bGwsIHRoaXMuYXJyYXkpOwogIH07CiAgcHJvY2Vzcy50aXRsZSA9ICdicm93c2VyJzsKICBwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwogIHByb2Nlc3MuZW52ID0ge307CiAgcHJvY2Vzcy5hcmd2ID0gW107CiAgcHJvY2Vzcy52ZXJzaW9uID0gJyc7IC8vIGVtcHR5IHN0cmluZyB0byBhdm9pZCByZWdleHAgaXNzdWVzCiAgcHJvY2Vzcy52ZXJzaW9ucyA9IHt9OwogIAogIGZ1bmN0aW9uIG5vb3AoKSB7fQogIAogIHByb2Nlc3Mub24gPSBub29wOwogIHByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3Mub25jZSA9IG5vb3A7CiAgcHJvY2Vzcy5vZmYgPSBub29wOwogIHByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wOwogIHByb2Nlc3MucmVtb3ZlQWxsTGlzdGVuZXJzID0gbm9vcDsKICBwcm9jZXNzLmVtaXQgPSBub29wOwogIHByb2Nlc3MucHJlcGVuZExpc3RlbmVyID0gbm9vcDsKICBwcm9jZXNzLnByZXBlbmRPbmNlTGlzdGVuZXIgPSBub29wOwogIAogIHByb2Nlc3MubGlzdGVuZXJzID0gZnVuY3Rpb24gKG5hbWUpIHsgcmV0dXJuIFtdIH0KICAKICBwcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfTsKICAKICBwcm9jZXNzLmN3ZCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICcvJyB9OwogIHByb2Nlc3MuY2hkaXIgPSBmdW5jdGlvbiAoZGlyKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7CiAgfTsKICBwcm9jZXNzLnVtYXNrID0gZnVuY3Rpb24oKSB7IHJldHVybiAwOyB9OwogIAogIH0se31dLDg3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgLy8gSWYgb2JqLmhhc093blByb3BlcnR5IGhhcyBiZWVuIG92ZXJyaWRkZW4sIHRoZW4gY2FsbGluZwogIC8vIG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSB3aWxsIGJyZWFrLgogIC8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CiAgZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocXMsIHNlcCwgZXEsIG9wdGlvbnMpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIHZhciBvYmogPSB7fTsKICAKICAgIGlmICh0eXBlb2YgcXMgIT09ICdzdHJpbmcnIHx8IHFzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gb2JqOwogICAgfQogIAogICAgdmFyIHJlZ2V4cCA9IC9cKy9nOwogICAgcXMgPSBxcy5zcGxpdChzZXApOwogIAogICAgdmFyIG1heEtleXMgPSAxMDAwOwogICAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgICAgbWF4S2V5cyA9IG9wdGlvbnMubWF4S2V5czsKICAgIH0KICAKICAgIHZhciBsZW4gPSBxcy5sZW5ndGg7CiAgICAvLyBtYXhLZXlzIDw9IDAgbWVhbnMgdGhhdCB3ZSBzaG91bGQgbm90IGxpbWl0IGtleXMgY291bnQKICAgIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICAgIGxlbiA9IG1heEtleXM7CiAgICB9CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciB4ID0gcXNbaV0ucmVwbGFjZShyZWdleHAsICclMjAnKSwKICAgICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAgICBrc3RyLCB2c3RyLCBrLCB2OwogIAogICAgICBpZiAoaWR4ID49IDApIHsKICAgICAgICBrc3RyID0geC5zdWJzdHIoMCwgaWR4KTsKICAgICAgICB2c3RyID0geC5zdWJzdHIoaWR4ICsgMSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAga3N0ciA9IHg7CiAgICAgICAgdnN0ciA9ICcnOwogICAgICB9CiAgCiAgICAgIGsgPSBkZWNvZGVVUklDb21wb25lbnQoa3N0cik7CiAgICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CiAgCiAgICAgIGlmICghaGFzT3duUHJvcGVydHkob2JqLCBrKSkgewogICAgICAgIG9ialtrXSA9IHY7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgb2JqW2tdLnB1c2godik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2JqW2tdID0gW29ialtrXSwgdl07CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBvYmo7CiAgfTsKICAKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKHhzKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIAogIH0se31dLDg4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICAgIHN3aXRjaCAodHlwZW9mIHYpIHsKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gdjsKICAKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwogIAogICAgICBjYXNlICdudW1iZXInOgogICAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKICAKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gJyc7CiAgICB9CiAgfTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9iaiwgc2VwLCBlcSwgbmFtZSkgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICBvYmogPSB1bmRlZmluZWQ7CiAgICB9CiAgCiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIG1hcChvYmplY3RLZXlzKG9iaiksIGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIga3MgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKGspKSArIGVxOwogICAgICAgIGlmIChpc0FycmF5KG9ialtrXSkpIHsKICAgICAgICAgIHJldHVybiBtYXAob2JqW2tdLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUodikpOwogICAgICAgICAgfSkuam9pbihzZXApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9ialtrXSkpOwogICAgICAgIH0KICAgICAgfSkuam9pbihzZXApOwogIAogICAgfQogIAogICAgaWYgKCFuYW1lKSByZXR1cm4gJyc7CiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShuYW1lKSkgKyBlcSArCiAgICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKICB9OwogIAogIHZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoeHMpID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CiAgCiAgZnVuY3Rpb24gbWFwICh4cywgZikgewogICAgaWYgKHhzLm1hcCkgcmV0dXJuIHhzLm1hcChmKTsKICAgIHZhciByZXMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgeHMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzLnB1c2goZih4c1tpXSwgaSkpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9CiAgCiAgdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSByZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIHJlczsKICB9OwogIAogIH0se31dLDg5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAndXNlIHN0cmljdCc7CiAgCiAgZXhwb3J0cy5kZWNvZGUgPSBleHBvcnRzLnBhcnNlID0gcmVxdWlyZSgnLi9kZWNvZGUnKTsKICBleHBvcnRzLmVuY29kZSA9IGV4cG9ydHMuc3RyaW5naWZ5ID0gcmVxdWlyZSgnLi9lbmNvZGUnKTsKICAKICB9LHsiLi9kZWNvZGUiOjg3LCIuL2VuY29kZSI6ODh9XSw5MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIC8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKICAvLyBvYmouaGFzT3duUHJvcGVydHkocHJvcCkgd2lsbCBicmVhay4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb3llbnQvbm9kZS9pc3N1ZXMvMTcwNwogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKHFzLCBzZXAsIGVxLCBvcHRpb25zKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICB2YXIgb2JqID0ge307CiAgCiAgICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICAKICAgIHZhciByZWdleHAgPSAvXCsvZzsKICAgIHFzID0gcXMuc3BsaXQoc2VwKTsKICAKICAgIHZhciBtYXhLZXlzID0gMTAwMDsKICAgIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLm1heEtleXMgPT09ICdudW1iZXInKSB7CiAgICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgICB9CiAgCiAgICB2YXIgbGVuID0gcXMubGVuZ3RoOwogICAgLy8gbWF4S2V5cyA8PSAwIG1lYW5zIHRoYXQgd2Ugc2hvdWxkIG5vdCBsaW1pdCBrZXlzIGNvdW50CiAgICBpZiAobWF4S2V5cyA+IDAgJiYgbGVuID4gbWF4S2V5cykgewogICAgICBsZW4gPSBtYXhLZXlzOwogICAgfQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICB2YXIgeCA9IHFzW2ldLnJlcGxhY2UocmVnZXhwLCAnJTIwJyksCiAgICAgICAgICBpZHggPSB4LmluZGV4T2YoZXEpLAogICAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKICAKICAgICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgICAgdnN0ciA9IHguc3Vic3RyKGlkeCArIDEpOwogICAgICB9IGVsc2UgewogICAgICAgIGtzdHIgPSB4OwogICAgICAgIHZzdHIgPSAnJzsKICAgICAgfQogIAogICAgICBrID0gZGVjb2RlVVJJQ29tcG9uZW50KGtzdHIpOwogICAgICB2ID0gZGVjb2RlVVJJQ29tcG9uZW50KHZzdHIpOwogIAogICAgICBpZiAoIWhhc093blByb3BlcnR5KG9iaiwgaykpIHsKICAgICAgICBvYmpba10gPSB2OwogICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIG9ialtrXS5wdXNoKHYpOwogICAgICB9IGVsc2UgewogICAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gb2JqOwogIH07CiAgCiAgfSx7fV0sOTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICB2YXIgc3RyaW5naWZ5UHJpbWl0aXZlID0gZnVuY3Rpb24odikgewogICAgc3dpdGNoICh0eXBlb2YgdikgewogICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgIHJldHVybiB2OwogIAogICAgICBjYXNlICdib29sZWFuJzoKICAgICAgICByZXR1cm4gdiA/ICd0cnVlJyA6ICdmYWxzZSc7CiAgCiAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgcmV0dXJuIGlzRmluaXRlKHYpID8gdiA6ICcnOwogIAogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiAnJzsKICAgIH0KICB9OwogIAogIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ob2JqLCBzZXAsIGVxLCBuYW1lKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICBpZiAob2JqID09PSBudWxsKSB7CiAgICAgIG9iaiA9IHVuZGVmaW5lZDsKICAgIH0KICAKICAgIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5tYXAoZnVuY3Rpb24oaykgewogICAgICAgIHZhciBrcyA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUoaykpICsgZXE7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgICAgcmV0dXJuIG9ialtrXS5tYXAoZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgICB9CiAgICAgIH0pLmpvaW4oc2VwKTsKICAKICAgIH0KICAKICAgIGlmICghbmFtZSkgcmV0dXJuICcnOwogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUobmFtZSkpICsgZXEgKwogICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqKSk7CiAgfTsKICAKICB9LHt9XSw5MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgYXJndW1lbnRzWzRdWzg5XVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKICB9LHsiLi9kZWNvZGUiOjkwLCIuL2VuY29kZSI6OTEsImR1cCI6ODl9XSw5MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChzZXRJbW1lZGlhdGUsY2xlYXJJbW1lZGlhdGUpeyhmdW5jdGlvbiAoKXsKICB2YXIgbmV4dFRpY2sgPSByZXF1aXJlKCdwcm9jZXNzL2Jyb3dzZXIuanMnKS5uZXh0VGljazsKICB2YXIgYXBwbHkgPSBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHk7CiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogIHZhciBpbW1lZGlhdGVJZHMgPSB7fTsKICB2YXIgbmV4dEltbWVkaWF0ZUlkID0gMDsKICAKICAvLyBET00gQVBJcywgZm9yIGNvbXBsZXRlbmVzcwogIAogIGV4cG9ydHMuc2V0VGltZW91dCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0VGltZW91dCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhclRpbWVvdXQpOwogIH07CiAgZXhwb3J0cy5zZXRJbnRlcnZhbCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBUaW1lb3V0KGFwcGx5LmNhbGwoc2V0SW50ZXJ2YWwsIHdpbmRvdywgYXJndW1lbnRzKSwgY2xlYXJJbnRlcnZhbCk7CiAgfTsKICBleHBvcnRzLmNsZWFyVGltZW91dCA9CiAgZXhwb3J0cy5jbGVhckludGVydmFsID0gZnVuY3Rpb24odGltZW91dCkgeyB0aW1lb3V0LmNsb3NlKCk7IH07CiAgCiAgZnVuY3Rpb24gVGltZW91dChpZCwgY2xlYXJGbikgewogICAgdGhpcy5faWQgPSBpZDsKICAgIHRoaXMuX2NsZWFyRm4gPSBjbGVhckZuOwogIH0KICBUaW1lb3V0LnByb3RvdHlwZS51bnJlZiA9IFRpbWVvdXQucHJvdG90eXBlLnJlZiA9IGZ1bmN0aW9uKCkge307CiAgVGltZW91dC5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NsZWFyRm4uY2FsbCh3aW5kb3csIHRoaXMuX2lkKTsKICB9OwogIAogIC8vIERvZXMgbm90IHN0YXJ0IHRoZSB0aW1lLCBqdXN0IHNldHMgdXAgdGhlIG1lbWJlcnMgbmVlZGVkLgogIGV4cG9ydHMuZW5yb2xsID0gZnVuY3Rpb24oaXRlbSwgbXNlY3MpIHsKICAgIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICAgIGl0ZW0uX2lkbGVUaW1lb3V0ID0gbXNlY3M7CiAgfTsKICAKICBleHBvcnRzLnVuZW5yb2xsID0gZnVuY3Rpb24oaXRlbSkgewogICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogICAgaXRlbS5faWRsZVRpbWVvdXQgPSAtMTsKICB9OwogIAogIGV4cG9ydHMuX3VucmVmQWN0aXZlID0gZXhwb3J0cy5hY3RpdmUgPSBmdW5jdGlvbihpdGVtKSB7CiAgICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgCiAgICB2YXIgbXNlY3MgPSBpdGVtLl9pZGxlVGltZW91dDsKICAgIGlmIChtc2VjcyA+PSAwKSB7CiAgICAgIGl0ZW0uX2lkbGVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uIG9uVGltZW91dCgpIHsKICAgICAgICBpZiAoaXRlbS5fb25UaW1lb3V0KQogICAgICAgICAgaXRlbS5fb25UaW1lb3V0KCk7CiAgICAgIH0sIG1zZWNzKTsKICAgIH0KICB9OwogIAogIC8vIFRoYXQncyBub3QgaG93IG5vZGUuanMgaW1wbGVtZW50cyBpdCBidXQgdGhlIGV4cG9zZWQgYXBpIGlzIHRoZSBzYW1lLgogIGV4cG9ydHMuc2V0SW1tZWRpYXRlID0gdHlwZW9mIHNldEltbWVkaWF0ZSA9PT0gImZ1bmN0aW9uIiA/IHNldEltbWVkaWF0ZSA6IGZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgaWQgPSBuZXh0SW1tZWRpYXRlSWQrKzsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA8IDIgPyBmYWxzZSA6IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAKICAgIGltbWVkaWF0ZUlkc1tpZF0gPSB0cnVlOwogIAogICAgbmV4dFRpY2soZnVuY3Rpb24gb25OZXh0VGljaygpIHsKICAgICAgaWYgKGltbWVkaWF0ZUlkc1tpZF0pIHsKICAgICAgICAvLyBmbi5jYWxsKCkgaXMgZmFzdGVyIHNvIHdlIG9wdGltaXplIGZvciB0aGUgY29tbW9uIHVzZS1jYXNlCiAgICAgICAgLy8gQHNlZSBodHRwOi8vanNwZXJmLmNvbS9jYWxsLWFwcGx5LXNlZ3UKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZuLmNhbGwobnVsbCk7CiAgICAgICAgfQogICAgICAgIC8vIFByZXZlbnQgaWRzIGZyb20gbGVha2luZwogICAgICAgIGV4cG9ydHMuY2xlYXJJbW1lZGlhdGUoaWQpOwogICAgICB9CiAgICB9KTsKICAKICAgIHJldHVybiBpZDsKICB9OwogIAogIGV4cG9ydHMuY2xlYXJJbW1lZGlhdGUgPSB0eXBlb2YgY2xlYXJJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBjbGVhckltbWVkaWF0ZSA6IGZ1bmN0aW9uKGlkKSB7CiAgICBkZWxldGUgaW1tZWRpYXRlSWRzW2lkXTsKICB9OwogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlLHJlcXVpcmUoInRpbWVycyIpLmNsZWFySW1tZWRpYXRlKQogIH0seyJwcm9jZXNzL2Jyb3dzZXIuanMiOjg2LCJ0aW1lcnMiOjkzfV0sOTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIHZhciBwdW55Y29kZSA9IHJlcXVpcmUoJ3B1bnljb2RlJyk7CiAgCiAgZXhwb3J0cy5wYXJzZSA9IHVybFBhcnNlOwogIGV4cG9ydHMucmVzb2x2ZSA9IHVybFJlc29sdmU7CiAgZXhwb3J0cy5yZXNvbHZlT2JqZWN0ID0gdXJsUmVzb2x2ZU9iamVjdDsKICBleHBvcnRzLmZvcm1hdCA9IHVybEZvcm1hdDsKICAKICBleHBvcnRzLlVybCA9IFVybDsKICAKICBmdW5jdGlvbiBVcmwoKSB7CiAgICB0aGlzLnByb3RvY29sID0gbnVsbDsKICAgIHRoaXMuc2xhc2hlcyA9IG51bGw7CiAgICB0aGlzLmF1dGggPSBudWxsOwogICAgdGhpcy5ob3N0ID0gbnVsbDsKICAgIHRoaXMucG9ydCA9IG51bGw7CiAgICB0aGlzLmhvc3RuYW1lID0gbnVsbDsKICAgIHRoaXMuaGFzaCA9IG51bGw7CiAgICB0aGlzLnNlYXJjaCA9IG51bGw7CiAgICB0aGlzLnF1ZXJ5ID0gbnVsbDsKICAgIHRoaXMucGF0aG5hbWUgPSBudWxsOwogICAgdGhpcy5wYXRoID0gbnVsbDsKICAgIHRoaXMuaHJlZiA9IG51bGw7CiAgfQogIAogIC8vIFJlZmVyZW5jZTogUkZDIDM5ODYsIFJGQyAxODA4LCBSRkMgMjM5NgogIAogIC8vIGRlZmluZSB0aGVzZSBoZXJlIHNvIGF0IGxlYXN0IHRoZXkgb25seSBoYXZlIHRvIGJlCiAgLy8gY29tcGlsZWQgb25jZSBvbiB0aGUgZmlyc3QgbW9kdWxlIGxvYWQuCiAgdmFyIHByb3RvY29sUGF0dGVybiA9IC9eKFthLXowLTkuKy1dKzopL2ksCiAgICAgIHBvcnRQYXR0ZXJuID0gLzpbMC05XSokLywKICAKICAgICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgcmVzZXJ2ZWQgZm9yIGRlbGltaXRpbmcgVVJMcy4KICAgICAgLy8gV2UgYWN0dWFsbHkganVzdCBhdXRvLWVzY2FwZSB0aGVzZS4KICAgICAgZGVsaW1zID0gWyc8JywgJz4nLCAnIicsICdgJywgJyAnLCAnXHInLCAnXG4nLCAnXHQnXSwKICAKICAgICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgbm90IGFsbG93ZWQgZm9yIHZhcmlvdXMgcmVhc29ucy4KICAgICAgdW53aXNlID0gWyd7JywgJ30nLCAnfCcsICdcXCcsICdeJywgJ2AnXS5jb25jYXQoZGVsaW1zKSwKICAKICAgICAgLy8gQWxsb3dlZCBieSBSRkNzLCBidXQgY2F1c2Ugb2YgWFNTIGF0dGFja3MuICBBbHdheXMgZXNjYXBlIHRoZXNlLgogICAgICBhdXRvRXNjYXBlID0gWydcJyddLmNvbmNhdCh1bndpc2UpLAogICAgICAvLyBDaGFyYWN0ZXJzIHRoYXQgYXJlIG5ldmVyIGV2ZXIgYWxsb3dlZCBpbiBhIGhvc3RuYW1lLgogICAgICAvLyBOb3RlIHRoYXQgYW55IGludmFsaWQgY2hhcnMgYXJlIGFsc28gaGFuZGxlZCwgYnV0IHRoZXNlCiAgICAgIC8vIGFyZSB0aGUgb25lcyB0aGF0IGFyZSAqZXhwZWN0ZWQqIHRvIGJlIHNlZW4sIHNvIHdlIGZhc3QtcGF0aAogICAgICAvLyB0aGVtLgogICAgICBub25Ib3N0Q2hhcnMgPSBbJyUnLCAnLycsICc/JywgJzsnLCAnIyddLmNvbmNhdChhdXRvRXNjYXBlKSwKICAgICAgaG9zdEVuZGluZ0NoYXJzID0gWycvJywgJz8nLCAnIyddLAogICAgICBob3N0bmFtZU1heExlbiA9IDI1NSwKICAgICAgaG9zdG5hbWVQYXJ0UGF0dGVybiA9IC9eW2EtejAtOUEtWl8tXXswLDYzfSQvLAogICAgICBob3N0bmFtZVBhcnRTdGFydCA9IC9eKFthLXowLTlBLVpfLV17MCw2M30pKC4qKSQvLAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBjYW4gYWxsb3cgInVuc2FmZSIgYW5kICJ1bndpc2UiIGNoYXJzLgogICAgICB1bnNhZmVQcm90b2NvbCA9IHsKICAgICAgICAnamF2YXNjcmlwdCc6IHRydWUsCiAgICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgICB9LAogICAgICAvLyBwcm90b2NvbHMgdGhhdCBuZXZlciBoYXZlIGEgaG9zdG5hbWUuCiAgICAgIGhvc3RsZXNzUHJvdG9jb2wgPSB7CiAgICAgICAgJ2phdmFzY3JpcHQnOiB0cnVlLAogICAgICAgICdqYXZhc2NyaXB0Oic6IHRydWUKICAgICAgfSwKICAgICAgLy8gcHJvdG9jb2xzIHRoYXQgYWx3YXlzIGNvbnRhaW4gYSAvLyBiaXQuCiAgICAgIHNsYXNoZWRQcm90b2NvbCA9IHsKICAgICAgICAnaHR0cCc6IHRydWUsCiAgICAgICAgJ2h0dHBzJzogdHJ1ZSwKICAgICAgICAnZnRwJzogdHJ1ZSwKICAgICAgICAnZ29waGVyJzogdHJ1ZSwKICAgICAgICAnZmlsZSc6IHRydWUsCiAgICAgICAgJ2h0dHA6JzogdHJ1ZSwKICAgICAgICAnaHR0cHM6JzogdHJ1ZSwKICAgICAgICAnZnRwOic6IHRydWUsCiAgICAgICAgJ2dvcGhlcjonOiB0cnVlLAogICAgICAgICdmaWxlOic6IHRydWUKICAgICAgfSwKICAgICAgcXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZycpOwogIAogIGZ1bmN0aW9uIHVybFBhcnNlKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpIHsKICAgIGlmICh1cmwgJiYgaXNPYmplY3QodXJsKSAmJiB1cmwgaW5zdGFuY2VvZiBVcmwpIHJldHVybiB1cmw7CiAgCiAgICB2YXIgdSA9IG5ldyBVcmw7CiAgICB1LnBhcnNlKHVybCwgcGFyc2VRdWVyeVN0cmluZywgc2xhc2hlc0Rlbm90ZUhvc3QpOwogICAgcmV0dXJuIHU7CiAgfQogIAogIFVybC5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgICBpZiAoIWlzU3RyaW5nKHVybCkpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiUGFyYW1ldGVyICd1cmwnIG11c3QgYmUgYSBzdHJpbmcsIG5vdCAiICsgdHlwZW9mIHVybCk7CiAgICB9CiAgCiAgICB2YXIgcmVzdCA9IHVybDsKICAKICAgIC8vIHRyaW0gYmVmb3JlIHByb2NlZWRpbmcuCiAgICAvLyBUaGlzIGlzIHRvIHN1cHBvcnQgcGFyc2Ugc3R1ZmYgbGlrZSAiICBodHRwOi8vZm9vLmNvbSAgXG4iCiAgICByZXN0ID0gcmVzdC50cmltKCk7CiAgCiAgICB2YXIgcHJvdG8gPSBwcm90b2NvbFBhdHRlcm4uZXhlYyhyZXN0KTsKICAgIGlmIChwcm90bykgewogICAgICBwcm90byA9IHByb3RvWzBdOwogICAgICB2YXIgbG93ZXJQcm90byA9IHByb3RvLnRvTG93ZXJDYXNlKCk7CiAgICAgIHRoaXMucHJvdG9jb2wgPSBsb3dlclByb3RvOwogICAgICByZXN0ID0gcmVzdC5zdWJzdHIocHJvdG8ubGVuZ3RoKTsKICAgIH0KICAKICAgIC8vIGZpZ3VyZSBvdXQgaWYgaXQncyBnb3QgYSBob3N0CiAgICAvLyB1c2VyQHNlcnZlciBpcyAqYWx3YXlzKiBpbnRlcnByZXRlZCBhcyBhIGhvc3RuYW1lLCBhbmQgdXJsCiAgICAvLyByZXNvbHV0aW9uIHdpbGwgdHJlYXQgLy9mb28vYmFyIGFzIGhvc3Q9Zm9vLHBhdGg9YmFyIGJlY2F1c2UgdGhhdCdzCiAgICAvLyBob3cgdGhlIGJyb3dzZXIgcmVzb2x2ZXMgcmVsYXRpdmUgVVJMcy4KICAgIGlmIChzbGFzaGVzRGVub3RlSG9zdCB8fCBwcm90byB8fCByZXN0Lm1hdGNoKC9eXC9cL1teQFwvXStAW15AXC9dKy8pKSB7CiAgICAgIHZhciBzbGFzaGVzID0gcmVzdC5zdWJzdHIoMCwgMikgPT09ICcvLyc7CiAgICAgIGlmIChzbGFzaGVzICYmICEocHJvdG8gJiYgaG9zdGxlc3NQcm90b2NvbFtwcm90b10pKSB7CiAgICAgICAgcmVzdCA9IHJlc3Quc3Vic3RyKDIpOwogICAgICAgIHRoaXMuc2xhc2hlcyA9IHRydWU7CiAgICAgIH0KICAgIH0KICAKICAgIGlmICghaG9zdGxlc3NQcm90b2NvbFtwcm90b10gJiYKICAgICAgICAoc2xhc2hlcyB8fCAocHJvdG8gJiYgIXNsYXNoZWRQcm90b2NvbFtwcm90b10pKSkgewogIAogICAgICAvLyB0aGVyZSdzIGEgaG9zdG5hbWUuCiAgICAgIC8vIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiAvLCA/LCA7LCBvciAjIGVuZHMgdGhlIGhvc3QuCiAgICAgIC8vCiAgICAgIC8vIElmIHRoZXJlIGlzIGFuIEAgaW4gdGhlIGhvc3RuYW1lLCB0aGVuIG5vbi1ob3N0IGNoYXJzICphcmUqIGFsbG93ZWQKICAgICAgLy8gdG8gdGhlIGxlZnQgb2YgdGhlIGxhc3QgQCBzaWduLCB1bmxlc3Mgc29tZSBob3N0LWVuZGluZyBjaGFyYWN0ZXIKICAgICAgLy8gY29tZXMgKmJlZm9yZSogdGhlIEAtc2lnbi4KICAgICAgLy8gVVJMcyBhcmUgb2Jub3hpb3VzLgogICAgICAvLwogICAgICAvLyBleDoKICAgICAgLy8gaHR0cDovL2FAYkBjLyA9PiB1c2VyOmFAYiBob3N0OmMKICAgICAgLy8gaHR0cDovL2FAYj9AYyA9PiB1c2VyOmEgaG9zdDpjIHBhdGg6Lz9AYwogIAogICAgICAvLyB2MC4xMiBUT0RPKGlzYWFjcyk6IFRoaXMgaXMgbm90IHF1aXRlIGhvdyBDaHJvbWUgZG9lcyB0aGluZ3MuCiAgICAgIC8vIFJldmlldyBvdXIgdGVzdCBjYXNlIGFnYWluc3QgYnJvd3NlcnMgbW9yZSBjb21wcmVoZW5zaXZlbHkuCiAgCiAgICAgIC8vIGZpbmQgdGhlIGZpcnN0IGluc3RhbmNlIG9mIGFueSBob3N0RW5kaW5nQ2hhcnMKICAgICAgdmFyIGhvc3RFbmQgPSAtMTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob3N0RW5kaW5nQ2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaGVjID0gcmVzdC5pbmRleE9mKGhvc3RFbmRpbmdDaGFyc1tpXSk7CiAgICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgICAgfQogIAogICAgICAvLyBhdCB0aGlzIHBvaW50LCBlaXRoZXIgd2UgaGF2ZSBhbiBleHBsaWNpdCBwb2ludCB3aGVyZSB0aGUKICAgICAgLy8gYXV0aCBwb3J0aW9uIGNhbm5vdCBnbyBwYXN0LCBvciB0aGUgbGFzdCBAIGNoYXIgaXMgdGhlIGRlY2lkZXIuCiAgICAgIHZhciBhdXRoLCBhdFNpZ247CiAgICAgIGlmIChob3N0RW5kID09PSAtMSkgewogICAgICAgIC8vIGF0U2lnbiBjYW4gYmUgYW55d2hlcmUuCiAgICAgICAgYXRTaWduID0gcmVzdC5sYXN0SW5kZXhPZignQCcpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGF0U2lnbiBtdXN0IGJlIGluIGF1dGggcG9ydGlvbi4KICAgICAgICAvLyBodHRwOi8vYUBiL2NAZCA9PiBob3N0OmIgYXV0aDphIHBhdGg6L2NAZAogICAgICAgIGF0U2lnbiA9IHJlc3QubGFzdEluZGV4T2YoJ0AnLCBob3N0RW5kKTsKICAgICAgfQogIAogICAgICAvLyBOb3cgd2UgaGF2ZSBhIHBvcnRpb24gd2hpY2ggaXMgZGVmaW5pdGVseSB0aGUgYXV0aC4KICAgICAgLy8gUHVsbCB0aGF0IG9mZi4KICAgICAgaWYgKGF0U2lnbiAhPT0gLTEpIHsKICAgICAgICBhdXRoID0gcmVzdC5zbGljZSgwLCBhdFNpZ24pOwogICAgICAgIHJlc3QgPSByZXN0LnNsaWNlKGF0U2lnbiArIDEpOwogICAgICAgIHRoaXMuYXV0aCA9IGRlY29kZVVSSUNvbXBvbmVudChhdXRoKTsKICAgICAgfQogIAogICAgICAvLyB0aGUgaG9zdCBpcyB0aGUgcmVtYWluaW5nIHRvIHRoZSBsZWZ0IG9mIHRoZSBmaXJzdCBub24taG9zdCBjaGFyCiAgICAgIGhvc3RFbmQgPSAtMTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub25Ib3N0Q2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgaGVjID0gcmVzdC5pbmRleE9mKG5vbkhvc3RDaGFyc1tpXSk7CiAgICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgICAgfQogICAgICAvLyBpZiB3ZSBzdGlsbCBoYXZlIG5vdCBoaXQgaXQsIHRoZW4gdGhlIGVudGlyZSB0aGluZyBpcyBhIGhvc3QuCiAgICAgIGlmIChob3N0RW5kID09PSAtMSkKICAgICAgICBob3N0RW5kID0gcmVzdC5sZW5ndGg7CiAgCiAgICAgIHRoaXMuaG9zdCA9IHJlc3Quc2xpY2UoMCwgaG9zdEVuZCk7CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKGhvc3RFbmQpOwogIAogICAgICAvLyBwdWxsIG91dCBwb3J0LgogICAgICB0aGlzLnBhcnNlSG9zdCgpOwogIAogICAgICAvLyB3ZSd2ZSBpbmRpY2F0ZWQgdGhhdCB0aGVyZSBpcyBhIGhvc3RuYW1lLAogICAgICAvLyBzbyBldmVuIGlmIGl0J3MgZW1wdHksIGl0IGhhcyB0byBiZSBwcmVzZW50LgogICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKICAKICAgICAgLy8gaWYgaG9zdG5hbWUgYmVnaW5zIHdpdGggWyBhbmQgZW5kcyB3aXRoIF0KICAgICAgLy8gYXNzdW1lIHRoYXQgaXQncyBhbiBJUHY2IGFkZHJlc3MuCiAgICAgIHZhciBpcHY2SG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lWzBdID09PSAnWycgJiYKICAgICAgICAgIHRoaXMuaG9zdG5hbWVbdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAxXSA9PT0gJ10nOwogIAogICAgICAvLyB2YWxpZGF0ZSBhIGxpdHRsZS4KICAgICAgaWYgKCFpcHY2SG9zdG5hbWUpIHsKICAgICAgICB2YXIgaG9zdHBhcnRzID0gdGhpcy5ob3N0bmFtZS5zcGxpdCgvXC4vKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGhvc3RwYXJ0cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHZhciBwYXJ0ID0gaG9zdHBhcnRzW2ldOwogICAgICAgICAgaWYgKCFwYXJ0KSBjb250aW51ZTsKICAgICAgICAgIGlmICghcGFydC5tYXRjaChob3N0bmFtZVBhcnRQYXR0ZXJuKSkgewogICAgICAgICAgICB2YXIgbmV3cGFydCA9ICcnOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgayA9IHBhcnQubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgaWYgKHBhcnQuY2hhckNvZGVBdChqKSA+IDEyNykgewogICAgICAgICAgICAgICAgLy8gd2UgcmVwbGFjZSBub24tQVNDSUkgY2hhciB3aXRoIGEgdGVtcG9yYXJ5IHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRoaXMgdG8gbWFrZSBzdXJlIHNpemUgb2YgaG9zdG5hbWUgaXMgbm90CiAgICAgICAgICAgICAgICAvLyBicm9rZW4gYnkgcmVwbGFjaW5nIG5vbi1BU0NJSSBieSBub3RoaW5nCiAgICAgICAgICAgICAgICBuZXdwYXJ0ICs9ICd4JzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3cGFydCArPSBwYXJ0W2pdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB3ZSB0ZXN0IGFnYWluIHdpdGggQVNDSUkgY2hhciBvbmx5CiAgICAgICAgICAgIGlmICghbmV3cGFydC5tYXRjaChob3N0bmFtZVBhcnRQYXR0ZXJuKSkgewogICAgICAgICAgICAgIHZhciB2YWxpZFBhcnRzID0gaG9zdHBhcnRzLnNsaWNlKDAsIGkpOwogICAgICAgICAgICAgIHZhciBub3RIb3N0ID0gaG9zdHBhcnRzLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICB2YXIgYml0ID0gcGFydC5tYXRjaChob3N0bmFtZVBhcnRTdGFydCk7CiAgICAgICAgICAgICAgaWYgKGJpdCkgewogICAgICAgICAgICAgICAgdmFsaWRQYXJ0cy5wdXNoKGJpdFsxXSk7CiAgICAgICAgICAgICAgICBub3RIb3N0LnVuc2hpZnQoYml0WzJdKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vdEhvc3QubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICByZXN0ID0gJy8nICsgbm90SG9zdC5qb2luKCcuJykgKyByZXN0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmhvc3RuYW1lID0gdmFsaWRQYXJ0cy5qb2luKCcuJyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMuaG9zdG5hbWUubGVuZ3RoID4gaG9zdG5hbWVNYXhMZW4pIHsKICAgICAgICB0aGlzLmhvc3RuYW1lID0gJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaG9zdG5hbWVzIGFyZSBhbHdheXMgbG93ZXIgY2FzZS4KICAgICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICB9CiAgCiAgICAgIGlmICghaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgLy8gSUROQSBTdXBwb3J0OiBSZXR1cm5zIGEgcHVueSBjb2RlZCByZXByZXNlbnRhdGlvbiBvZiAiZG9tYWluIi4KICAgICAgICAvLyBJdCBvbmx5IGNvbnZlcnRzIHRoZSBwYXJ0IG9mIHRoZSBkb21haW4gbmFtZSB0aGF0CiAgICAgICAgLy8gaGFzIG5vbiBBU0NJSSBjaGFyYWN0ZXJzLiBJLmUuIGl0IGRvc2VudCBtYXR0ZXIgaWYKICAgICAgICAvLyB5b3UgY2FsbCBpdCB3aXRoIGEgZG9tYWluIHRoYXQgYWxyZWFkeSBpcyBpbiBBU0NJSS4KICAgICAgICB2YXIgZG9tYWluQXJyYXkgPSB0aGlzLmhvc3RuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgdmFyIG5ld091dCA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZG9tYWluQXJyYXkubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIHZhciBzID0gZG9tYWluQXJyYXlbaV07CiAgICAgICAgICBuZXdPdXQucHVzaChzLm1hdGNoKC9bXkEtWmEtejAtOV8tXS8pID8KICAgICAgICAgICAgICAneG4tLScgKyBwdW55Y29kZS5lbmNvZGUocykgOiBzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IG5ld091dC5qb2luKCcuJyk7CiAgICAgIH0KICAKICAgICAgdmFyIHAgPSB0aGlzLnBvcnQgPyAnOicgKyB0aGlzLnBvcnQgOiAnJzsKICAgICAgdmFyIGggPSB0aGlzLmhvc3RuYW1lIHx8ICcnOwogICAgICB0aGlzLmhvc3QgPSBoICsgcDsKICAgICAgdGhpcy5ocmVmICs9IHRoaXMuaG9zdDsKICAKICAgICAgLy8gc3RyaXAgWyBhbmQgXSBmcm9tIHRoZSBob3N0bmFtZQogICAgICAvLyB0aGUgaG9zdCBmaWVsZCBzdGlsbCByZXRhaW5zIHRoZW0sIHRob3VnaAogICAgICBpZiAoaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUuc3Vic3RyKDEsIHRoaXMuaG9zdG5hbWUubGVuZ3RoIC0gMik7CiAgICAgICAgaWYgKHJlc3RbMF0gIT09ICcvJykgewogICAgICAgICAgcmVzdCA9ICcvJyArIHJlc3Q7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICAvLyBub3cgcmVzdCBpcyBzZXQgdG8gdGhlIHBvc3QtaG9zdCBzdHVmZi4KICAgIC8vIGNob3Agb2ZmIGFueSBkZWxpbSBjaGFycy4KICAgIGlmICghdW5zYWZlUHJvdG9jb2xbbG93ZXJQcm90b10pIHsKICAKICAgICAgLy8gRmlyc3QsIG1ha2UgMTAwJSBzdXJlIHRoYXQgYW55ICJhdXRvRXNjYXBlIiBjaGFycyBnZXQKICAgICAgLy8gZXNjYXBlZCwgZXZlbiBpZiBlbmNvZGVVUklDb21wb25lbnQgZG9lc24ndCB0aGluayB0aGV5CiAgICAgIC8vIG5lZWQgdG8gYmUuCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXV0b0VzY2FwZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2YXIgYWUgPSBhdXRvRXNjYXBlW2ldOwogICAgICAgIHZhciBlc2MgPSBlbmNvZGVVUklDb21wb25lbnQoYWUpOwogICAgICAgIGlmIChlc2MgPT09IGFlKSB7CiAgICAgICAgICBlc2MgPSBlc2NhcGUoYWUpOwogICAgICAgIH0KICAgICAgICByZXN0ID0gcmVzdC5zcGxpdChhZSkuam9pbihlc2MpOwogICAgICB9CiAgICB9CiAgCiAgCiAgICAvLyBjaG9wIG9mZiBmcm9tIHRoZSB0YWlsIGZpcnN0LgogICAgdmFyIGhhc2ggPSByZXN0LmluZGV4T2YoJyMnKTsKICAgIGlmIChoYXNoICE9PSAtMSkgewogICAgICAvLyBnb3QgYSBmcmFnbWVudCBzdHJpbmcuCiAgICAgIHRoaXMuaGFzaCA9IHJlc3Quc3Vic3RyKGhhc2gpOwogICAgICByZXN0ID0gcmVzdC5zbGljZSgwLCBoYXNoKTsKICAgIH0KICAgIHZhciBxbSA9IHJlc3QuaW5kZXhPZignPycpOwogICAgaWYgKHFtICE9PSAtMSkgewogICAgICB0aGlzLnNlYXJjaCA9IHJlc3Quc3Vic3RyKHFtKTsKICAgICAgdGhpcy5xdWVyeSA9IHJlc3Quc3Vic3RyKHFtICsgMSk7CiAgICAgIGlmIChwYXJzZVF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHRoaXMucXVlcnkpOwogICAgICB9CiAgICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIHFtKTsKICAgIH0gZWxzZSBpZiAocGFyc2VRdWVyeVN0cmluZykgewogICAgICAvLyBubyBxdWVyeSBzdHJpbmcsIGJ1dCBwYXJzZVF1ZXJ5U3RyaW5nIHN0aWxsIHJlcXVlc3RlZAogICAgICB0aGlzLnNlYXJjaCA9ICcnOwogICAgICB0aGlzLnF1ZXJ5ID0ge307CiAgICB9CiAgICBpZiAocmVzdCkgdGhpcy5wYXRobmFtZSA9IHJlc3Q7CiAgICBpZiAoc2xhc2hlZFByb3RvY29sW2xvd2VyUHJvdG9dICYmCiAgICAgICAgdGhpcy5ob3N0bmFtZSAmJiAhdGhpcy5wYXRobmFtZSkgewogICAgICB0aGlzLnBhdGhuYW1lID0gJy8nOwogICAgfQogIAogICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgaWYgKHRoaXMucGF0aG5hbWUgfHwgdGhpcy5zZWFyY2gpIHsKICAgICAgdmFyIHAgPSB0aGlzLnBhdGhuYW1lIHx8ICcnOwogICAgICB2YXIgcyA9IHRoaXMuc2VhcmNoIHx8ICcnOwogICAgICB0aGlzLnBhdGggPSBwICsgczsKICAgIH0KICAKICAgIC8vIGZpbmFsbHksIHJlY29uc3RydWN0IHRoZSBocmVmIGJhc2VkIG9uIHdoYXQgaGFzIGJlZW4gdmFsaWRhdGVkLgogICAgdGhpcy5ocmVmID0gdGhpcy5mb3JtYXQoKTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgLy8gZm9ybWF0IGEgcGFyc2VkIG9iamVjdCBpbnRvIGEgdXJsIHN0cmluZwogIGZ1bmN0aW9uIHVybEZvcm1hdChvYmopIHsKICAgIC8vIGVuc3VyZSBpdCdzIGFuIG9iamVjdCwgYW5kIG5vdCBhIHN0cmluZyB1cmwuCiAgICAvLyBJZiBpdCdzIGFuIG9iaiwgdGhpcyBpcyBhIG5vLW9wLgogICAgLy8gdGhpcyB3YXksIHlvdSBjYW4gY2FsbCB1cmxfZm9ybWF0KCkgb24gc3RyaW5ncwogICAgLy8gdG8gY2xlYW4gdXAgcG90ZW50aWFsbHkgd29ua3kgdXJscy4KICAgIGlmIChpc1N0cmluZyhvYmopKSBvYmogPSB1cmxQYXJzZShvYmopOwogICAgaWYgKCEob2JqIGluc3RhbmNlb2YgVXJsKSkgcmV0dXJuIFVybC5wcm90b3R5cGUuZm9ybWF0LmNhbGwob2JqKTsKICAgIHJldHVybiBvYmouZm9ybWF0KCk7CiAgfQogIAogIFVybC5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXV0aCA9IHRoaXMuYXV0aCB8fCAnJzsKICAgIGlmIChhdXRoKSB7CiAgICAgIGF1dGggPSBlbmNvZGVVUklDb21wb25lbnQoYXV0aCk7CiAgICAgIGF1dGggPSBhdXRoLnJlcGxhY2UoLyUzQS9pLCAnOicpOwogICAgICBhdXRoICs9ICdAJzsKICAgIH0KICAKICAgIHZhciBwcm90b2NvbCA9IHRoaXMucHJvdG9jb2wgfHwgJycsCiAgICAgICAgcGF0aG5hbWUgPSB0aGlzLnBhdGhuYW1lIHx8ICcnLAogICAgICAgIGhhc2ggPSB0aGlzLmhhc2ggfHwgJycsCiAgICAgICAgaG9zdCA9IGZhbHNlLAogICAgICAgIHF1ZXJ5ID0gJyc7CiAgCiAgICBpZiAodGhpcy5ob3N0KSB7CiAgICAgIGhvc3QgPSBhdXRoICsgdGhpcy5ob3N0OwogICAgfSBlbHNlIGlmICh0aGlzLmhvc3RuYW1lKSB7CiAgICAgIGhvc3QgPSBhdXRoICsgKHRoaXMuaG9zdG5hbWUuaW5kZXhPZignOicpID09PSAtMSA/CiAgICAgICAgICB0aGlzLmhvc3RuYW1lIDoKICAgICAgICAgICdbJyArIHRoaXMuaG9zdG5hbWUgKyAnXScpOwogICAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgICAgaG9zdCArPSAnOicgKyB0aGlzLnBvcnQ7CiAgICAgIH0KICAgIH0KICAKICAgIGlmICh0aGlzLnF1ZXJ5ICYmCiAgICAgICAgaXNPYmplY3QodGhpcy5xdWVyeSkgJiYKICAgICAgICBPYmplY3Qua2V5cyh0aGlzLnF1ZXJ5KS5sZW5ndGgpIHsKICAgICAgcXVlcnkgPSBxdWVyeXN0cmluZy5zdHJpbmdpZnkodGhpcy5xdWVyeSk7CiAgICB9CiAgCiAgICB2YXIgc2VhcmNoID0gdGhpcy5zZWFyY2ggfHwgKHF1ZXJ5ICYmICgnPycgKyBxdWVyeSkpIHx8ICcnOwogIAogICAgaWYgKHByb3RvY29sICYmIHByb3RvY29sLnN1YnN0cigtMSkgIT09ICc6JykgcHJvdG9jb2wgKz0gJzonOwogIAogICAgLy8gb25seSB0aGUgc2xhc2hlZFByb3RvY29scyBnZXQgdGhlIC8vLiAgTm90IG1haWx0bzosIHhtcHA6LCBldGMuCiAgICAvLyB1bmxlc3MgdGhleSBoYWQgdGhlbSB0byBiZWdpbiB3aXRoLgogICAgaWYgKHRoaXMuc2xhc2hlcyB8fAogICAgICAgICghcHJvdG9jb2wgfHwgc2xhc2hlZFByb3RvY29sW3Byb3RvY29sXSkgJiYgaG9zdCAhPT0gZmFsc2UpIHsKICAgICAgaG9zdCA9ICcvLycgKyAoaG9zdCB8fCAnJyk7CiAgICAgIGlmIChwYXRobmFtZSAmJiBwYXRobmFtZS5jaGFyQXQoMCkgIT09ICcvJykgcGF0aG5hbWUgPSAnLycgKyBwYXRobmFtZTsKICAgIH0gZWxzZSBpZiAoIWhvc3QpIHsKICAgICAgaG9zdCA9ICcnOwogICAgfQogIAogICAgaWYgKGhhc2ggJiYgaGFzaC5jaGFyQXQoMCkgIT09ICcjJykgaGFzaCA9ICcjJyArIGhhc2g7CiAgICBpZiAoc2VhcmNoICYmIHNlYXJjaC5jaGFyQXQoMCkgIT09ICc/Jykgc2VhcmNoID0gJz8nICsgc2VhcmNoOwogIAogICAgcGF0aG5hbWUgPSBwYXRobmFtZS5yZXBsYWNlKC9bPyNdL2csIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQobWF0Y2gpOwogICAgfSk7CiAgICBzZWFyY2ggPSBzZWFyY2gucmVwbGFjZSgnIycsICclMjMnKTsKICAKICAgIHJldHVybiBwcm90b2NvbCArIGhvc3QgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CiAgfTsKICAKICBmdW5jdGlvbiB1cmxSZXNvbHZlKHNvdXJjZSwgcmVsYXRpdmUpIHsKICAgIHJldHVybiB1cmxQYXJzZShzb3VyY2UsIGZhbHNlLCB0cnVlKS5yZXNvbHZlKHJlbGF0aXZlKTsKICB9CiAgCiAgVXJsLnByb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24ocmVsYXRpdmUpIHsKICAgIHJldHVybiB0aGlzLnJlc29sdmVPYmplY3QodXJsUGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKSkuZm9ybWF0KCk7CiAgfTsKICAKICBmdW5jdGlvbiB1cmxSZXNvbHZlT2JqZWN0KHNvdXJjZSwgcmVsYXRpdmUpIHsKICAgIGlmICghc291cmNlKSByZXR1cm4gcmVsYXRpdmU7CiAgICByZXR1cm4gdXJsUGFyc2Uoc291cmNlLCBmYWxzZSwgdHJ1ZSkucmVzb2x2ZU9iamVjdChyZWxhdGl2ZSk7CiAgfQogIAogIFVybC5wcm90b3R5cGUucmVzb2x2ZU9iamVjdCA9IGZ1bmN0aW9uKHJlbGF0aXZlKSB7CiAgICBpZiAoaXNTdHJpbmcocmVsYXRpdmUpKSB7CiAgICAgIHZhciByZWwgPSBuZXcgVXJsKCk7CiAgICAgIHJlbC5wYXJzZShyZWxhdGl2ZSwgZmFsc2UsIHRydWUpOwogICAgICByZWxhdGl2ZSA9IHJlbDsKICAgIH0KICAKICAgIHZhciByZXN1bHQgPSBuZXcgVXJsKCk7CiAgICBPYmplY3Qua2V5cyh0aGlzKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgcmVzdWx0W2tdID0gdGhpc1trXTsKICAgIH0sIHRoaXMpOwogIAogICAgLy8gaGFzaCBpcyBhbHdheXMgb3ZlcnJpZGRlbiwgbm8gbWF0dGVyIHdoYXQuCiAgICAvLyBldmVuIGhyZWY9IiIgd2lsbCByZW1vdmUgaXQuCiAgICByZXN1bHQuaGFzaCA9IHJlbGF0aXZlLmhhc2g7CiAgCiAgICAvLyBpZiB0aGUgcmVsYXRpdmUgdXJsIGlzIGVtcHR5LCB0aGVuIHRoZXJlJ3Mgbm90aGluZyBsZWZ0IHRvIGRvIGhlcmUuCiAgICBpZiAocmVsYXRpdmUuaHJlZiA9PT0gJycpIHsKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICAvLyBocmVmcyBsaWtlIC8vZm9vL2JhciBhbHdheXMgY3V0IHRvIHRoZSBwcm90b2NvbC4KICAgIGlmIChyZWxhdGl2ZS5zbGFzaGVzICYmICFyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgICAvLyB0YWtlIGV2ZXJ5dGhpbmcgZXhjZXB0IHRoZSBwcm90b2NvbCBmcm9tIHJlbGF0aXZlCiAgICAgIE9iamVjdC5rZXlzKHJlbGF0aXZlKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgICBpZiAoayAhPT0gJ3Byb3RvY29sJykKICAgICAgICAgIHJlc3VsdFtrXSA9IHJlbGF0aXZlW2tdOwogICAgICB9KTsKICAKICAgICAgLy91cmxQYXJzZSBhcHBlbmRzIHRyYWlsaW5nIC8gdG8gdXJscyBsaWtlIGh0dHA6Ly93d3cuZXhhbXBsZS5jb20KICAgICAgaWYgKHNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdICYmCiAgICAgICAgICByZXN1bHQuaG9zdG5hbWUgJiYgIXJlc3VsdC5wYXRobmFtZSkgewogICAgICAgIHJlc3VsdC5wYXRoID0gcmVzdWx0LnBhdGhuYW1lID0gJy8nOwogICAgICB9CiAgCiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgaWYgKHJlbGF0aXZlLnByb3RvY29sICYmIHJlbGF0aXZlLnByb3RvY29sICE9PSByZXN1bHQucHJvdG9jb2wpIHsKICAgICAgLy8gaWYgaXQncyBhIGtub3duIHVybCBwcm90b2NvbCwgdGhlbiBjaGFuZ2luZwogICAgICAvLyB0aGUgcHJvdG9jb2wgZG9lcyB3ZWlyZCB0aGluZ3MKICAgICAgLy8gZmlyc3QsIGlmIGl0J3Mgbm90IGZpbGU6LCB0aGVuIHdlIE1VU1QgaGF2ZSBhIGhvc3QsCiAgICAgIC8vIGFuZCBpZiB0aGVyZSB3YXMgYSBwYXRoCiAgICAgIC8vIHRvIGJlZ2luIHdpdGgsIHRoZW4gd2UgTVVTVCBoYXZlIGEgcGF0aC4KICAgICAgLy8gaWYgaXQgaXMgZmlsZTosIHRoZW4gdGhlIGhvc3QgaXMgZHJvcHBlZCwKICAgICAgLy8gYmVjYXVzZSB0aGF0J3Mga25vd24gdG8gYmUgaG9zdGxlc3MuCiAgICAgIC8vIGFueXRoaW5nIGVsc2UgaXMgYXNzdW1lZCB0byBiZSBhYnNvbHV0ZS4KICAgICAgaWYgKCFzbGFzaGVkUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgICAgcmVzdWx0W2tdID0gcmVsYXRpdmVba107CiAgICAgICAgfSk7CiAgICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogIAogICAgICByZXN1bHQucHJvdG9jb2wgPSByZWxhdGl2ZS5wcm90b2NvbDsKICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0ICYmICFob3N0bGVzc1Byb3RvY29sW3JlbGF0aXZlLnByb3RvY29sXSkgewogICAgICAgIHZhciByZWxQYXRoID0gKHJlbGF0aXZlLnBhdGhuYW1lIHx8ICcnKS5zcGxpdCgnLycpOwogICAgICAgIHdoaWxlIChyZWxQYXRoLmxlbmd0aCAmJiAhKHJlbGF0aXZlLmhvc3QgPSByZWxQYXRoLnNoaWZ0KCkpKTsKICAgICAgICBpZiAoIXJlbGF0aXZlLmhvc3QpIHJlbGF0aXZlLmhvc3QgPSAnJzsKICAgICAgICBpZiAoIXJlbGF0aXZlLmhvc3RuYW1lKSByZWxhdGl2ZS5ob3N0bmFtZSA9ICcnOwogICAgICAgIGlmIChyZWxQYXRoWzBdICE9PSAnJykgcmVsUGF0aC51bnNoaWZ0KCcnKTsKICAgICAgICBpZiAocmVsUGF0aC5sZW5ndGggPCAyKSByZWxQYXRoLnVuc2hpZnQoJycpOwogICAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbFBhdGguam9pbignLycpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbGF0aXZlLnBhdGhuYW1lOwogICAgICB9CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgICByZXN1bHQuaG9zdCA9IHJlbGF0aXZlLmhvc3QgfHwgJyc7CiAgICAgIHJlc3VsdC5hdXRoID0gcmVsYXRpdmUuYXV0aDsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdDsKICAgICAgcmVzdWx0LnBvcnQgPSByZWxhdGl2ZS5wb3J0OwogICAgICAvLyB0byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgICBpZiAocmVzdWx0LnBhdGhuYW1lIHx8IHJlc3VsdC5zZWFyY2gpIHsKICAgICAgICB2YXIgcCA9IHJlc3VsdC5wYXRobmFtZSB8fCAnJzsKICAgICAgICB2YXIgcyA9IHJlc3VsdC5zZWFyY2ggfHwgJyc7CiAgICAgICAgcmVzdWx0LnBhdGggPSBwICsgczsKICAgICAgfQogICAgICByZXN1bHQuc2xhc2hlcyA9IHJlc3VsdC5zbGFzaGVzIHx8IHJlbGF0aXZlLnNsYXNoZXM7CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgdmFyIGlzU291cmNlQWJzID0gKHJlc3VsdC5wYXRobmFtZSAmJiByZXN1bHQucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycpLAogICAgICAgIGlzUmVsQWJzID0gKAogICAgICAgICAgICByZWxhdGl2ZS5ob3N0IHx8CiAgICAgICAgICAgIHJlbGF0aXZlLnBhdGhuYW1lICYmIHJlbGF0aXZlLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nCiAgICAgICAgKSwKICAgICAgICBtdXN0RW5kQWJzID0gKGlzUmVsQWJzIHx8IGlzU291cmNlQWJzIHx8CiAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0Lmhvc3QgJiYgcmVsYXRpdmUucGF0aG5hbWUpKSwKICAgICAgICByZW1vdmVBbGxEb3RzID0gbXVzdEVuZEFicywKICAgICAgICBzcmNQYXRoID0gcmVzdWx0LnBhdGhuYW1lICYmIHJlc3VsdC5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICAgIHJlbFBhdGggPSByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICAgIHBzeWNob3RpYyA9IHJlc3VsdC5wcm90b2NvbCAmJiAhc2xhc2hlZFByb3RvY29sW3Jlc3VsdC5wcm90b2NvbF07CiAgCiAgICAvLyBpZiB0aGUgdXJsIGlzIGEgbm9uLXNsYXNoZWQgdXJsLCB0aGVuIHJlbGF0aXZlCiAgICAvLyBsaW5rcyBsaWtlIC4uLy4uIHNob3VsZCBiZSBhYmxlCiAgICAvLyB0byBjcmF3bCB1cCB0byB0aGUgaG9zdG5hbWUsIGFzIHdlbGwuICBUaGlzIGlzIHN0cmFuZ2UuCiAgICAvLyByZXN1bHQucHJvdG9jb2wgaGFzIGFscmVhZHkgYmVlbiBzZXQgYnkgbm93LgogICAgLy8gTGF0ZXIgb24sIHB1dCB0aGUgZmlyc3QgcGF0aCBwYXJ0IGludG8gdGhlIGhvc3QgZmllbGQuCiAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9ICcnOwogICAgICByZXN1bHQucG9ydCA9IG51bGw7CiAgICAgIGlmIChyZXN1bHQuaG9zdCkgewogICAgICAgIGlmIChzcmNQYXRoWzBdID09PSAnJykgc3JjUGF0aFswXSA9IHJlc3VsdC5ob3N0OwogICAgICAgIGVsc2Ugc3JjUGF0aC51bnNoaWZ0KHJlc3VsdC5ob3N0KTsKICAgICAgfQogICAgICByZXN1bHQuaG9zdCA9ICcnOwogICAgICBpZiAocmVsYXRpdmUucHJvdG9jb2wpIHsKICAgICAgICByZWxhdGl2ZS5ob3N0bmFtZSA9IG51bGw7CiAgICAgICAgcmVsYXRpdmUucG9ydCA9IG51bGw7CiAgICAgICAgaWYgKHJlbGF0aXZlLmhvc3QpIHsKICAgICAgICAgIGlmIChyZWxQYXRoWzBdID09PSAnJykgcmVsUGF0aFswXSA9IHJlbGF0aXZlLmhvc3Q7CiAgICAgICAgICBlbHNlIHJlbFBhdGgudW5zaGlmdChyZWxhdGl2ZS5ob3N0KTsKICAgICAgICB9CiAgICAgICAgcmVsYXRpdmUuaG9zdCA9IG51bGw7CiAgICAgIH0KICAgICAgbXVzdEVuZEFicyA9IG11c3RFbmRBYnMgJiYgKHJlbFBhdGhbMF0gPT09ICcnIHx8IHNyY1BhdGhbMF0gPT09ICcnKTsKICAgIH0KICAKICAgIGlmIChpc1JlbEFicykgewogICAgICAvLyBpdCdzIGFic29sdXRlLgogICAgICByZXN1bHQuaG9zdCA9IChyZWxhdGl2ZS5ob3N0IHx8IHJlbGF0aXZlLmhvc3QgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmUuaG9zdCA6IHJlc3VsdC5ob3N0OwogICAgICByZXN1bHQuaG9zdG5hbWUgPSAocmVsYXRpdmUuaG9zdG5hbWUgfHwgcmVsYXRpdmUuaG9zdG5hbWUgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3RuYW1lIDogcmVzdWx0Lmhvc3RuYW1lOwogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgICAgc3JjUGF0aCA9IHJlbFBhdGg7CiAgICAgIC8vIGZhbGwgdGhyb3VnaCB0byB0aGUgZG90LWhhbmRsaW5nIGJlbG93LgogICAgfSBlbHNlIGlmIChyZWxQYXRoLmxlbmd0aCkgewogICAgICAvLyBpdCdzIHJlbGF0aXZlCiAgICAgIC8vIHRocm93IGF3YXkgdGhlIGV4aXN0aW5nIGZpbGUsIGFuZCB0YWtlIHRoZSBuZXcgcGF0aCBpbnN0ZWFkLgogICAgICBpZiAoIXNyY1BhdGgpIHNyY1BhdGggPSBbXTsKICAgICAgc3JjUGF0aC5wb3AoKTsKICAgICAgc3JjUGF0aCA9IHNyY1BhdGguY29uY2F0KHJlbFBhdGgpOwogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgIH0gZWxzZSBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKHJlbGF0aXZlLnNlYXJjaCkpIHsKICAgICAgLy8ganVzdCBwdWxsIG91dCB0aGUgc2VhcmNoLgogICAgICAvLyBsaWtlIGhyZWY9Jz9mb28nLgogICAgICAvLyBQdXQgdGhpcyBhZnRlciB0aGUgb3RoZXIgdHdvIGNhc2VzIGJlY2F1c2UgaXQgc2ltcGxpZmllcyB0aGUgYm9vbGVhbnMKICAgICAgaWYgKHBzeWNob3RpYykgewogICAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gc3JjUGF0aC5zaGlmdCgpOwogICAgICAgIC8vb2NjYXRpb25hbHkgdGhlIGF1dGggY2FuIGdldCBzdHVjayBvbmx5IGluIGhvc3QKICAgICAgICAvL3RoaXMgZXNwZWNpYWx5IGhhcHBlbnMgaW4gY2FzZXMgbGlrZQogICAgICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICAgICAgdmFyIGF1dGhJbkhvc3QgPSByZXN1bHQuaG9zdCAmJiByZXN1bHQuaG9zdC5pbmRleE9mKCdAJykgPiAwID8KICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5ob3N0LnNwbGl0KCdAJykgOiBmYWxzZTsKICAgICAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICAgICAgcmVzdWx0LmF1dGggPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgICByZXN1bHQuaG9zdCA9IHJlc3VsdC5ob3N0bmFtZSA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgICAgaWYgKCFpc051bGwocmVzdWx0LnBhdGhuYW1lKSB8fCAhaXNOdWxsKHJlc3VsdC5zZWFyY2gpKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgICAgIChyZXN1bHQuc2VhcmNoID8gcmVzdWx0LnNlYXJjaCA6ICcnKTsKICAgICAgfQogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIGlmICghc3JjUGF0aC5sZW5ndGgpIHsKICAgICAgLy8gbm8gcGF0aCBhdCBhbGwuICBlYXN5LgogICAgICAvLyB3ZSd2ZSBhbHJlYWR5IGhhbmRsZWQgdGhlIG90aGVyIHN0dWZmIGFib3ZlLgogICAgICByZXN1bHQucGF0aG5hbWUgPSBudWxsOwogICAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICAgIGlmIChyZXN1bHQuc2VhcmNoKSB7CiAgICAgICAgcmVzdWx0LnBhdGggPSAnLycgKyByZXN1bHQuc2VhcmNoOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3VsdC5wYXRoID0gbnVsbDsKICAgICAgfQogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIC8vIGlmIGEgdXJsIEVORHMgaW4gLiBvciAuLiwgdGhlbiBpdCBtdXN0IGdldCBhIHRyYWlsaW5nIHNsYXNoLgogICAgLy8gaG93ZXZlciwgaWYgaXQgZW5kcyBpbiBhbnl0aGluZyBlbHNlIG5vbi1zbGFzaHksCiAgICAvLyB0aGVuIGl0IG11c3QgTk9UIGdldCBhIHRyYWlsaW5nIHNsYXNoLgogICAgdmFyIGxhc3QgPSBzcmNQYXRoLnNsaWNlKC0xKVswXTsKICAgIHZhciBoYXNUcmFpbGluZ1NsYXNoID0gKAogICAgICAgIChyZXN1bHQuaG9zdCB8fCByZWxhdGl2ZS5ob3N0KSAmJiAobGFzdCA9PT0gJy4nIHx8IGxhc3QgPT09ICcuLicpIHx8CiAgICAgICAgbGFzdCA9PT0gJycpOwogIAogICAgLy8gc3RyaXAgc2luZ2xlIGRvdHMsIHJlc29sdmUgZG91YmxlIGRvdHMgdG8gcGFyZW50IGRpcgogICAgLy8gaWYgdGhlIHBhdGggdHJpZXMgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIGB1cGAgZW5kcyB1cCA+IDAKICAgIHZhciB1cCA9IDA7CiAgICBmb3IgKHZhciBpID0gc3JjUGF0aC5sZW5ndGg7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGxhc3QgPSBzcmNQYXRoW2ldOwogICAgICBpZiAobGFzdCA9PSAnLicpIHsKICAgICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgfSBlbHNlIGlmIChsYXN0ID09PSAnLi4nKSB7CiAgICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgICAgdXArKzsKICAgICAgfSBlbHNlIGlmICh1cCkgewogICAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICAgIHVwLS07CiAgICAgIH0KICAgIH0KICAKICAgIC8vIGlmIHRoZSBwYXRoIGlzIGFsbG93ZWQgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIHJlc3RvcmUgbGVhZGluZyAuLnMKICAgIGlmICghbXVzdEVuZEFicyAmJiAhcmVtb3ZlQWxsRG90cykgewogICAgICBmb3IgKDsgdXAtLTsgdXApIHsKICAgICAgICBzcmNQYXRoLnVuc2hpZnQoJy4uJyk7CiAgICAgIH0KICAgIH0KICAKICAgIGlmIChtdXN0RW5kQWJzICYmIHNyY1BhdGhbMF0gIT09ICcnICYmCiAgICAgICAgKCFzcmNQYXRoWzBdIHx8IHNyY1BhdGhbMF0uY2hhckF0KDApICE9PSAnLycpKSB7CiAgICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgICB9CiAgCiAgICBpZiAoaGFzVHJhaWxpbmdTbGFzaCAmJiAoc3JjUGF0aC5qb2luKCcvJykuc3Vic3RyKC0xKSAhPT0gJy8nKSkgewogICAgICBzcmNQYXRoLnB1c2goJycpOwogICAgfQogIAogICAgdmFyIGlzQWJzb2x1dGUgPSBzcmNQYXRoWzBdID09PSAnJyB8fAogICAgICAgIChzcmNQYXRoWzBdICYmIHNyY1BhdGhbMF0uY2hhckF0KDApID09PSAnLycpOwogIAogICAgLy8gcHV0IHRoZSBob3N0IGJhY2sKICAgIGlmIChwc3ljaG90aWMpIHsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVzdWx0Lmhvc3QgPSBpc0Fic29sdXRlID8gJycgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyY1BhdGgubGVuZ3RoID8gc3JjUGF0aC5zaGlmdCgpIDogJyc7CiAgICAgIC8vb2NjYXRpb25hbHkgdGhlIGF1dGggY2FuIGdldCBzdHVjayBvbmx5IGluIGhvc3QKICAgICAgLy90aGlzIGVzcGVjaWFseSBoYXBwZW5zIGluIGNhc2VzIGxpa2UKICAgICAgLy91cmwucmVzb2x2ZU9iamVjdCgnbWFpbHRvOmxvY2FsMUBkb21haW4xJywgJ2xvY2FsMkBkb21haW4yJykKICAgICAgdmFyIGF1dGhJbkhvc3QgPSByZXN1bHQuaG9zdCAmJiByZXN1bHQuaG9zdC5pbmRleE9mKCdAJykgPiAwID8KICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuaG9zdC5zcGxpdCgnQCcpIDogZmFsc2U7CiAgICAgIGlmIChhdXRoSW5Ib3N0KSB7CiAgICAgICAgcmVzdWx0LmF1dGggPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgcmVzdWx0Lmhvc3QgPSByZXN1bHQuaG9zdG5hbWUgPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgIH0KICAgIH0KICAKICAgIG11c3RFbmRBYnMgPSBtdXN0RW5kQWJzIHx8IChyZXN1bHQuaG9zdCAmJiBzcmNQYXRoLmxlbmd0aCk7CiAgCiAgICBpZiAobXVzdEVuZEFicyAmJiAhaXNBYnNvbHV0ZSkgewogICAgICBzcmNQYXRoLnVuc2hpZnQoJycpOwogICAgfQogIAogICAgaWYgKCFzcmNQYXRoLmxlbmd0aCkgewogICAgICByZXN1bHQucGF0aG5hbWUgPSBudWxsOwogICAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQucGF0aG5hbWUgPSBzcmNQYXRoLmpvaW4oJy8nKTsKICAgIH0KICAKICAgIC8vdG8gc3VwcG9ydCByZXF1ZXN0Lmh0dHAKICAgIGlmICghaXNOdWxsKHJlc3VsdC5wYXRobmFtZSkgfHwgIWlzTnVsbChyZXN1bHQuc2VhcmNoKSkgewogICAgICByZXN1bHQucGF0aCA9IChyZXN1bHQucGF0aG5hbWUgPyByZXN1bHQucGF0aG5hbWUgOiAnJykgKwogICAgICAgICAgICAgICAgICAgIChyZXN1bHQuc2VhcmNoID8gcmVzdWx0LnNlYXJjaCA6ICcnKTsKICAgIH0KICAgIHJlc3VsdC5hdXRoID0gcmVsYXRpdmUuYXV0aCB8fCByZXN1bHQuYXV0aDsKICAgIHJlc3VsdC5zbGFzaGVzID0gcmVzdWx0LnNsYXNoZXMgfHwgcmVsYXRpdmUuc2xhc2hlczsKICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIAogIFVybC5wcm90b3R5cGUucGFyc2VIb3N0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgaG9zdCA9IHRoaXMuaG9zdDsKICAgIHZhciBwb3J0ID0gcG9ydFBhdHRlcm4uZXhlYyhob3N0KTsKICAgIGlmIChwb3J0KSB7CiAgICAgIHBvcnQgPSBwb3J0WzBdOwogICAgICBpZiAocG9ydCAhPT0gJzonKSB7CiAgICAgICAgdGhpcy5wb3J0ID0gcG9ydC5zdWJzdHIoMSk7CiAgICAgIH0KICAgICAgaG9zdCA9IGhvc3Quc3Vic3RyKDAsIGhvc3QubGVuZ3RoIC0gcG9ydC5sZW5ndGgpOwogICAgfQogICAgaWYgKGhvc3QpIHRoaXMuaG9zdG5hbWUgPSBob3N0OwogIH07CiAgCiAgZnVuY3Rpb24gaXNTdHJpbmcoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gInN0cmluZyI7CiAgfQogIAogIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKICB9CiAgCiAgZnVuY3Rpb24gaXNOdWxsKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKICB9CiAgZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gIGFyZyA9PSBudWxsOwogIH0KICAKICB9LHsicHVueWNvZGUiOjgwLCJxdWVyeXN0cmluZyI6ODl9XSw5NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgaWYgKHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAvLyBpbXBsZW1lbnRhdGlvbiBmcm9tIHN0YW5kYXJkIG5vZGUuanMgJ3V0aWwnIG1vZHVsZQogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgICAgY3Rvci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ3Rvci5wcm90b3R5cGUsIHsKICAgICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgICAgdmFsdWU6IGN0b3IsCiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgfSBlbHNlIHsKICAgIC8vIG9sZCBzY2hvb2wgc2hpbSBmb3Igb2xkIGJyb3dzZXJzCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgICBjdG9yLnN1cGVyXyA9IHN1cGVyQ3RvcgogICAgICB2YXIgVGVtcEN0b3IgPSBmdW5jdGlvbiAoKSB7fQogICAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlCiAgICAgIGN0b3IucHJvdG90eXBlID0gbmV3IFRlbXBDdG9yKCkKICAgICAgY3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yCiAgICB9CiAgfQogIAogIH0se31dLDk2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGlzQnVmZmVyKGFyZykgewogICAgcmV0dXJuIGFyZyAmJiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JwogICAgICAmJiB0eXBlb2YgYXJnLmNvcHkgPT09ICdmdW5jdGlvbicKICAgICAgJiYgdHlwZW9mIGFyZy5maWxsID09PSAnZnVuY3Rpb24nCiAgICAgICYmIHR5cGVvZiBhcmcucmVhZFVJbnQ4ID09PSAnZnVuY3Rpb24nOwogIH0KICB9LHt9XSw5NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzLGdsb2JhbCl7KGZ1bmN0aW9uICgpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogIHZhciBmb3JtYXRSZWdFeHAgPSAvJVtzZGolXS9nOwogIGV4cG9ydHMuZm9ybWF0ID0gZnVuY3Rpb24oZikgewogICAgaWYgKCFpc1N0cmluZyhmKSkgewogICAgICB2YXIgb2JqZWN0cyA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIG9iamVjdHMucHVzaChpbnNwZWN0KGFyZ3VtZW50c1tpXSkpOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3RzLmpvaW4oJyAnKTsKICAgIH0KICAKICAgIHZhciBpID0gMTsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgdmFyIGxlbiA9IGFyZ3MubGVuZ3RoOwogICAgdmFyIHN0ciA9IFN0cmluZyhmKS5yZXBsYWNlKGZvcm1hdFJlZ0V4cCwgZnVuY3Rpb24oeCkgewogICAgICBpZiAoeCA9PT0gJyUlJykgcmV0dXJuICclJzsKICAgICAgaWYgKGkgPj0gbGVuKSByZXR1cm4geDsKICAgICAgc3dpdGNoICh4KSB7CiAgICAgICAgY2FzZSAnJXMnOiByZXR1cm4gU3RyaW5nKGFyZ3NbaSsrXSk7CiAgICAgICAgY2FzZSAnJWQnOiByZXR1cm4gTnVtYmVyKGFyZ3NbaSsrXSk7CiAgICAgICAgY2FzZSAnJWonOgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGFyZ3NbaSsrXSk7CiAgICAgICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgICAgIHJldHVybiAnW0NpcmN1bGFyXSc7CiAgICAgICAgICB9CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB4OwogICAgICB9CiAgICB9KTsKICAgIGZvciAodmFyIHggPSBhcmdzW2ldOyBpIDwgbGVuOyB4ID0gYXJnc1srK2ldKSB7CiAgICAgIGlmIChpc051bGwoeCkgfHwgIWlzT2JqZWN0KHgpKSB7CiAgICAgICAgc3RyICs9ICcgJyArIHg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyICs9ICcgJyArIGluc3BlY3QoeCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzdHI7CiAgfTsKICAKICAKICAvLyBNYXJrIHRoYXQgYSBtZXRob2Qgc2hvdWxkIG5vdCBiZSB1c2VkLgogIC8vIFJldHVybnMgYSBtb2RpZmllZCBmdW5jdGlvbiB3aGljaCB3YXJucyBvbmNlIGJ5IGRlZmF1bHQuCiAgLy8gSWYgLS1uby1kZXByZWNhdGlvbiBpcyBzZXQsIHRoZW4gaXQgaXMgYSBuby1vcC4KICBleHBvcnRzLmRlcHJlY2F0ZSA9IGZ1bmN0aW9uKGZuLCBtc2cpIHsKICAgIC8vIEFsbG93IGZvciBkZXByZWNhdGluZyB0aGluZ3MgaW4gdGhlIHByb2Nlc3Mgb2Ygc3RhcnRpbmcgdXAuCiAgICBpZiAoaXNVbmRlZmluZWQoZ2xvYmFsLnByb2Nlc3MpKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5kZXByZWNhdGUoZm4sIG1zZykuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAKICAgIGlmIChwcm9jZXNzLm5vRGVwcmVjYXRpb24gPT09IHRydWUpIHsKICAgICAgcmV0dXJuIGZuOwogICAgfQogIAogICAgdmFyIHdhcm5lZCA9IGZhbHNlOwogICAgZnVuY3Rpb24gZGVwcmVjYXRlZCgpIHsKICAgICAgaWYgKCF3YXJuZWQpIHsKICAgICAgICBpZiAocHJvY2Vzcy50aHJvd0RlcHJlY2F0aW9uKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MudHJhY2VEZXByZWNhdGlvbikgewogICAgICAgICAgY29uc29sZS50cmFjZShtc2cpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKG1zZyk7CiAgICAgICAgfQogICAgICAgIHdhcm5lZCA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgCiAgICByZXR1cm4gZGVwcmVjYXRlZDsKICB9OwogIAogIAogIHZhciBkZWJ1Z3MgPSB7fTsKICB2YXIgZGVidWdFbnZpcm9uOwogIGV4cG9ydHMuZGVidWdsb2cgPSBmdW5jdGlvbihzZXQpIHsKICAgIGlmIChpc1VuZGVmaW5lZChkZWJ1Z0Vudmlyb24pKQogICAgICBkZWJ1Z0Vudmlyb24gPSBwcm9jZXNzLmVudi5OT0RFX0RFQlVHIHx8ICcnOwogICAgc2V0ID0gc2V0LnRvVXBwZXJDYXNlKCk7CiAgICBpZiAoIWRlYnVnc1tzZXRdKSB7CiAgICAgIGlmIChuZXcgUmVnRXhwKCdcXGInICsgc2V0ICsgJ1xcYicsICdpJykudGVzdChkZWJ1Z0Vudmlyb24pKSB7CiAgICAgICAgdmFyIHBpZCA9IHByb2Nlc3MucGlkOwogICAgICAgIGRlYnVnc1tzZXRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbXNnID0gZXhwb3J0cy5mb3JtYXQuYXBwbHkoZXhwb3J0cywgYXJndW1lbnRzKTsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJyVzICVkOiAlcycsIHNldCwgcGlkLCBtc2cpOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVidWdzW3NldF0gPSBmdW5jdGlvbigpIHt9OwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZGVidWdzW3NldF07CiAgfTsKICAKICAKICAvKioKICAgKiBFY2hvcyB0aGUgdmFsdWUgb2YgYSB2YWx1ZS4gVHJ5cyB0byBwcmludCB0aGUgdmFsdWUgb3V0CiAgICogaW4gdGhlIGJlc3Qgd2F5IHBvc3NpYmxlIGdpdmVuIHRoZSBkaWZmZXJlbnQgdHlwZXMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSBvYmplY3QgdG8gcHJpbnQgb3V0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIE9wdGlvbmFsIG9wdGlvbnMgb2JqZWN0IHRoYXQgYWx0ZXJzIHRoZSBvdXRwdXQuCiAgICovCiAgLyogbGVnYWN5OiBvYmosIHNob3dIaWRkZW4sIGRlcHRoLCBjb2xvcnMqLwogIGZ1bmN0aW9uIGluc3BlY3Qob2JqLCBvcHRzKSB7CiAgICAvLyBkZWZhdWx0IG9wdGlvbnMKICAgIHZhciBjdHggPSB7CiAgICAgIHNlZW46IFtdLAogICAgICBzdHlsaXplOiBzdHlsaXplTm9Db2xvcgogICAgfTsKICAgIC8vIGxlZ2FjeS4uLgogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gMykgY3R4LmRlcHRoID0gYXJndW1lbnRzWzJdOwogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gNCkgY3R4LmNvbG9ycyA9IGFyZ3VtZW50c1szXTsKICAgIGlmIChpc0Jvb2xlYW4ob3B0cykpIHsKICAgICAgLy8gbGVnYWN5Li4uCiAgICAgIGN0eC5zaG93SGlkZGVuID0gb3B0czsKICAgIH0gZWxzZSBpZiAob3B0cykgewogICAgICAvLyBnb3QgYW4gIm9wdGlvbnMiIG9iamVjdAogICAgICBleHBvcnRzLl9leHRlbmQoY3R4LCBvcHRzKTsKICAgIH0KICAgIC8vIHNldCBkZWZhdWx0IG9wdGlvbnMKICAgIGlmIChpc1VuZGVmaW5lZChjdHguc2hvd0hpZGRlbikpIGN0eC5zaG93SGlkZGVuID0gZmFsc2U7CiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LmRlcHRoKSkgY3R4LmRlcHRoID0gMjsKICAgIGlmIChpc1VuZGVmaW5lZChjdHguY29sb3JzKSkgY3R4LmNvbG9ycyA9IGZhbHNlOwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5jdXN0b21JbnNwZWN0KSkgY3R4LmN1c3RvbUluc3BlY3QgPSB0cnVlOwogICAgaWYgKGN0eC5jb2xvcnMpIGN0eC5zdHlsaXplID0gc3R5bGl6ZVdpdGhDb2xvcjsKICAgIHJldHVybiBmb3JtYXRWYWx1ZShjdHgsIG9iaiwgY3R4LmRlcHRoKTsKICB9CiAgZXhwb3J0cy5pbnNwZWN0ID0gaW5zcGVjdDsKICAKICAKICAvLyBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0FOU0lfZXNjYXBlX2NvZGUjZ3JhcGhpY3MKICBpbnNwZWN0LmNvbG9ycyA9IHsKICAgICdib2xkJyA6IFsxLCAyMl0sCiAgICAnaXRhbGljJyA6IFszLCAyM10sCiAgICAndW5kZXJsaW5lJyA6IFs0LCAyNF0sCiAgICAnaW52ZXJzZScgOiBbNywgMjddLAogICAgJ3doaXRlJyA6IFszNywgMzldLAogICAgJ2dyZXknIDogWzkwLCAzOV0sCiAgICAnYmxhY2snIDogWzMwLCAzOV0sCiAgICAnYmx1ZScgOiBbMzQsIDM5XSwKICAgICdjeWFuJyA6IFszNiwgMzldLAogICAgJ2dyZWVuJyA6IFszMiwgMzldLAogICAgJ21hZ2VudGEnIDogWzM1LCAzOV0sCiAgICAncmVkJyA6IFszMSwgMzldLAogICAgJ3llbGxvdycgOiBbMzMsIDM5XQogIH07CiAgCiAgLy8gRG9uJ3QgdXNlICdibHVlJyBub3QgdmlzaWJsZSBvbiBjbWQuZXhlCiAgaW5zcGVjdC5zdHlsZXMgPSB7CiAgICAnc3BlY2lhbCc6ICdjeWFuJywKICAgICdudW1iZXInOiAneWVsbG93JywKICAgICdib29sZWFuJzogJ3llbGxvdycsCiAgICAndW5kZWZpbmVkJzogJ2dyZXknLAogICAgJ251bGwnOiAnYm9sZCcsCiAgICAnc3RyaW5nJzogJ2dyZWVuJywKICAgICdkYXRlJzogJ21hZ2VudGEnLAogICAgLy8gIm5hbWUiOiBpbnRlbnRpb25hbGx5IG5vdCBzdHlsaW5nCiAgICAncmVnZXhwJzogJ3JlZCcKICB9OwogIAogIAogIGZ1bmN0aW9uIHN0eWxpemVXaXRoQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICAgIHZhciBzdHlsZSA9IGluc3BlY3Quc3R5bGVzW3N0eWxlVHlwZV07CiAgCiAgICBpZiAoc3R5bGUpIHsKICAgICAgcmV0dXJuICdcdTAwMWJbJyArIGluc3BlY3QuY29sb3JzW3N0eWxlXVswXSArICdtJyArIHN0ciArCiAgICAgICAgICAgICAnXHUwMDFiWycgKyBpbnNwZWN0LmNvbG9yc1tzdHlsZV1bMV0gKyAnbSc7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gc3RyOwogICAgfQogIH0KICAKICAKICBmdW5jdGlvbiBzdHlsaXplTm9Db2xvcihzdHIsIHN0eWxlVHlwZSkgewogICAgcmV0dXJuIHN0cjsKICB9CiAgCiAgCiAgZnVuY3Rpb24gYXJyYXlUb0hhc2goYXJyYXkpIHsKICAgIHZhciBoYXNoID0ge307CiAgCiAgICBhcnJheS5mb3JFYWNoKGZ1bmN0aW9uKHZhbCwgaWR4KSB7CiAgICAgIGhhc2hbdmFsXSA9IHRydWU7CiAgICB9KTsKICAKICAgIHJldHVybiBoYXNoOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRWYWx1ZShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMpIHsKICAgIC8vIFByb3ZpZGUgYSBob29rIGZvciB1c2VyLXNwZWNpZmllZCBpbnNwZWN0IGZ1bmN0aW9ucy4KICAgIC8vIENoZWNrIHRoYXQgdmFsdWUgaXMgYW4gb2JqZWN0IHdpdGggYW4gaW5zcGVjdCBmdW5jdGlvbiBvbiBpdAogICAgaWYgKGN0eC5jdXN0b21JbnNwZWN0ICYmCiAgICAgICAgdmFsdWUgJiYKICAgICAgICBpc0Z1bmN0aW9uKHZhbHVlLmluc3BlY3QpICYmCiAgICAgICAgLy8gRmlsdGVyIG91dCB0aGUgdXRpbCBtb2R1bGUsIGl0J3MgaW5zcGVjdCBmdW5jdGlvbiBpcyBzcGVjaWFsCiAgICAgICAgdmFsdWUuaW5zcGVjdCAhPT0gZXhwb3J0cy5pbnNwZWN0ICYmCiAgICAgICAgLy8gQWxzbyBmaWx0ZXIgb3V0IGFueSBwcm90b3R5cGUgb2JqZWN0cyB1c2luZyB0aGUgY2lyY3VsYXIgY2hlY2suCiAgICAgICAgISh2YWx1ZS5jb25zdHJ1Y3RvciAmJiB2YWx1ZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUgPT09IHZhbHVlKSkgewogICAgICB2YXIgcmV0ID0gdmFsdWUuaW5zcGVjdChyZWN1cnNlVGltZXMsIGN0eCk7CiAgICAgIGlmICghaXNTdHJpbmcocmV0KSkgewogICAgICAgIHJldCA9IGZvcm1hdFZhbHVlKGN0eCwgcmV0LCByZWN1cnNlVGltZXMpOwogICAgICB9CiAgICAgIHJldHVybiByZXQ7CiAgICB9CiAgCiAgICAvLyBQcmltaXRpdmUgdHlwZXMgY2Fubm90IGhhdmUgcHJvcGVydGllcwogICAgdmFyIHByaW1pdGl2ZSA9IGZvcm1hdFByaW1pdGl2ZShjdHgsIHZhbHVlKTsKICAgIGlmIChwcmltaXRpdmUpIHsKICAgICAgcmV0dXJuIHByaW1pdGl2ZTsKICAgIH0KICAKICAgIC8vIExvb2sgdXAgdGhlIGtleXMgb2YgdGhlIG9iamVjdC4KICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModmFsdWUpOwogICAgdmFyIHZpc2libGVLZXlzID0gYXJyYXlUb0hhc2goa2V5cyk7CiAgCiAgICBpZiAoY3R4LnNob3dIaWRkZW4pIHsKICAgICAga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIElFIGRvZXNuJ3QgbWFrZSBlcnJvciBmaWVsZHMgbm9uLWVudW1lcmFibGUKICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9kd3c1MnNidCh2PXZzLjk0KS5hc3B4CiAgICBpZiAoaXNFcnJvcih2YWx1ZSkKICAgICAgICAmJiAoa2V5cy5pbmRleE9mKCdtZXNzYWdlJykgPj0gMCB8fCBrZXlzLmluZGV4T2YoJ2Rlc2NyaXB0aW9uJykgPj0gMCkpIHsKICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIFNvbWUgdHlwZSBvZiBvYmplY3Qgd2l0aG91dCBwcm9wZXJ0aWVzIGNhbiBiZSBzaG9ydGN1dHRlZC4KICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICB2YXIgbmFtZSA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW0Z1bmN0aW9uJyArIG5hbWUgKyAnXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZShSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAncmVnZXhwJyk7CiAgICAgIH0KICAgICAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoRGF0ZS5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdkYXRlJyk7CiAgICAgIH0KICAgICAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgICAgfQogICAgfQogIAogICAgdmFyIGJhc2UgPSAnJywgYXJyYXkgPSBmYWxzZSwgYnJhY2VzID0gWyd7JywgJ30nXTsKICAKICAgIC8vIE1ha2UgQXJyYXkgc2F5IHRoYXQgdGhleSBhcmUgQXJyYXkKICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICBhcnJheSA9IHRydWU7CiAgICAgIGJyYWNlcyA9IFsnWycsICddJ107CiAgICB9CiAgCiAgICAvLyBNYWtlIGZ1bmN0aW9ucyBzYXkgdGhhdCB0aGV5IGFyZSBmdW5jdGlvbnMKICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICB2YXIgbiA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICBiYXNlID0gJyBbRnVuY3Rpb24nICsgbiArICddJzsKICAgIH0KICAKICAgIC8vIE1ha2UgUmVnRXhwcyBzYXkgdGhhdCB0aGV5IGFyZSBSZWdFeHBzCiAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgIGJhc2UgPSAnICcgKyBSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgfQogIAogICAgLy8gTWFrZSBkYXRlcyB3aXRoIHByb3BlcnRpZXMgZmlyc3Qgc2F5IHRoZSBkYXRlCiAgICBpZiAoaXNEYXRlKHZhbHVlKSkgewogICAgICBiYXNlID0gJyAnICsgRGF0ZS5wcm90b3R5cGUudG9VVENTdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBNYWtlIGVycm9yIHdpdGggbWVzc2FnZSBmaXJzdCBzYXkgdGhlIGVycm9yCiAgICBpZiAoaXNFcnJvcih2YWx1ZSkpIHsKICAgICAgYmFzZSA9ICcgJyArIGZvcm1hdEVycm9yKHZhbHVlKTsKICAgIH0KICAKICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCAmJiAoIWFycmF5IHx8IHZhbHVlLmxlbmd0aCA9PSAwKSkgewogICAgICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArIGJyYWNlc1sxXTsKICAgIH0KICAKICAgIGlmIChyZWN1cnNlVGltZXMgPCAwKSB7CiAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ3JlZ2V4cCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW09iamVjdF0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9CiAgCiAgICBjdHguc2Vlbi5wdXNoKHZhbHVlKTsKICAKICAgIHZhciBvdXRwdXQ7CiAgICBpZiAoYXJyYXkpIHsKICAgICAgb3V0cHV0ID0gZm9ybWF0QXJyYXkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5cyk7CiAgICB9IGVsc2UgewogICAgICBvdXRwdXQgPSBrZXlzLm1hcChmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSk7CiAgICAgIH0pOwogICAgfQogIAogICAgY3R4LnNlZW4ucG9wKCk7CiAgCiAgICByZXR1cm4gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRQcmltaXRpdmUoY3R4LCB2YWx1ZSkgewogICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCd1bmRlZmluZWQnLCAndW5kZWZpbmVkJyk7CiAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgIHZhciBzaW1wbGUgPSAnXCcnICsgSlNPTi5zdHJpbmdpZnkodmFsdWUpLnJlcGxhY2UoL14ifCIkL2csICcnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJyInKSArICdcJyc7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZShzaW1wbGUsICdzdHJpbmcnKTsKICAgIH0KICAgIGlmIChpc051bWJlcih2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnbnVtYmVyJyk7CiAgICBpZiAoaXNCb29sZWFuKHZhbHVlKSkKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdib29sZWFuJyk7CiAgICAvLyBGb3Igc29tZSByZWFzb24gdHlwZW9mIG51bGwgaXMgIm9iamVjdCIsIHNvIHNwZWNpYWwgY2FzZSBoZXJlLgogICAgaWYgKGlzTnVsbCh2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnbnVsbCcsICdudWxsJyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIGZvcm1hdEVycm9yKHZhbHVlKSB7CiAgICByZXR1cm4gJ1snICsgRXJyb3IucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpICsgJ10nOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKSB7CiAgICB2YXIgb3V0cHV0ID0gW107CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICBpZiAoaGFzT3duUHJvcGVydHkodmFsdWUsIFN0cmluZyhpKSkpIHsKICAgICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAgICBTdHJpbmcoaSksIHRydWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRwdXQucHVzaCgnJyk7CiAgICAgIH0KICAgIH0KICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgaWYgKCFrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAgICBrZXksIHRydWUpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIGFycmF5KSB7CiAgICB2YXIgbmFtZSwgc3RyLCBkZXNjOwogICAgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodmFsdWUsIGtleSkgfHwgeyB2YWx1ZTogdmFsdWVba2V5XSB9OwogICAgaWYgKGRlc2MuZ2V0KSB7CiAgICAgIGlmIChkZXNjLnNldCkgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyL1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChkZXNjLnNldCkgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbU2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0KICAgIGlmICghaGFzT3duUHJvcGVydHkodmlzaWJsZUtleXMsIGtleSkpIHsKICAgICAgbmFtZSA9ICdbJyArIGtleSArICddJzsKICAgIH0KICAgIGlmICghc3RyKSB7CiAgICAgIGlmIChjdHguc2Vlbi5pbmRleE9mKGRlc2MudmFsdWUpIDwgMCkgewogICAgICAgIGlmIChpc051bGwocmVjdXJzZVRpbWVzKSkgewogICAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCBudWxsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCByZWN1cnNlVGltZXMgLSAxKTsKICAgICAgICB9CiAgICAgICAgaWYgKHN0ci5pbmRleE9mKCdcbicpID4gLTEpIHsKICAgICAgICAgIGlmIChhcnJheSkgewogICAgICAgICAgICBzdHIgPSBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gJyAgJyArIGxpbmU7CiAgICAgICAgICAgIH0pLmpvaW4oJ1xuJykuc3Vic3RyKDIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RyID0gJ1xuJyArIHN0ci5zcGxpdCgnXG4nKS5tYXAoZnVuY3Rpb24obGluZSkgewogICAgICAgICAgICAgIHJldHVybiAnICAgJyArIGxpbmU7CiAgICAgICAgICAgIH0pLmpvaW4oJ1xuJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbQ2lyY3VsYXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfQogICAgaWYgKGlzVW5kZWZpbmVkKG5hbWUpKSB7CiAgICAgIGlmIChhcnJheSAmJiBrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgICByZXR1cm4gc3RyOwogICAgICB9CiAgICAgIG5hbWUgPSBKU09OLnN0cmluZ2lmeSgnJyArIGtleSk7CiAgICAgIGlmIChuYW1lLm1hdGNoKC9eIihbYS16QS1aX11bYS16QS1aXzAtOV0qKSIkLykpIHsKICAgICAgICBuYW1lID0gbmFtZS5zdWJzdHIoMSwgbmFtZS5sZW5ndGggLSAyKTsKICAgICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ25hbWUnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC8nL2csICJcXCciKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnIicpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvKF4ifCIkKS9nLCAiJyIpOwogICAgICAgIG5hbWUgPSBjdHguc3R5bGl6ZShuYW1lLCAnc3RyaW5nJyk7CiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBuYW1lICsgJzogJyArIHN0cjsKICB9CiAgCiAgCiAgZnVuY3Rpb24gcmVkdWNlVG9TaW5nbGVTdHJpbmcob3V0cHV0LCBiYXNlLCBicmFjZXMpIHsKICAgIHZhciBudW1MaW5lc0VzdCA9IDA7CiAgICB2YXIgbGVuZ3RoID0gb3V0cHV0LnJlZHVjZShmdW5jdGlvbihwcmV2LCBjdXIpIHsKICAgICAgbnVtTGluZXNFc3QrKzsKICAgICAgaWYgKGN1ci5pbmRleE9mKCdcbicpID49IDApIG51bUxpbmVzRXN0Kys7CiAgICAgIHJldHVybiBwcmV2ICsgY3VyLnJlcGxhY2UoL1x1MDAxYlxbXGRcZD9tL2csICcnKS5sZW5ndGggKyAxOwogICAgfSwgMCk7CiAgCiAgICBpZiAobGVuZ3RoID4gNjApIHsKICAgICAgcmV0dXJuIGJyYWNlc1swXSArCiAgICAgICAgICAgICAoYmFzZSA9PT0gJycgPyAnJyA6IGJhc2UgKyAnXG4gJykgKwogICAgICAgICAgICAgJyAnICsKICAgICAgICAgICAgIG91dHB1dC5qb2luKCcsXG4gICcpICsKICAgICAgICAgICAgICcgJyArCiAgICAgICAgICAgICBicmFjZXNbMV07CiAgICB9CiAgCiAgICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArICcgJyArIG91dHB1dC5qb2luKCcsICcpICsgJyAnICsgYnJhY2VzWzFdOwogIH0KICAKICAKICAvLyBOT1RFOiBUaGVzZSB0eXBlIGNoZWNraW5nIGZ1bmN0aW9ucyBpbnRlbnRpb25hbGx5IGRvbid0IHVzZSBgaW5zdGFuY2VvZmAKICAvLyBiZWNhdXNlIGl0IGlzIGZyYWdpbGUgYW5kIGNhbiBiZSBlYXNpbHkgZmFrZWQgd2l0aCBgT2JqZWN0LmNyZWF0ZSgpYC4KICBmdW5jdGlvbiBpc0FycmF5KGFyKSB7CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShhcik7CiAgfQogIGV4cG9ydHMuaXNBcnJheSA9IGlzQXJyYXk7CiAgCiAgZnVuY3Rpb24gaXNCb29sZWFuKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJzsKICB9CiAgZXhwb3J0cy5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CiAgCiAgZnVuY3Rpb24gaXNOdWxsKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbDsKICB9CiAgZXhwb3J0cy5pc051bGwgPSBpc051bGw7CiAgCiAgZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gYXJnID09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNOdWxsT3JVbmRlZmluZWQgPSBpc051bGxPclVuZGVmaW5lZDsKICAKICBmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKICB9CiAgZXhwb3J0cy5pc051bWJlciA9IGlzTnVtYmVyOwogIAogIGZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnOwogIH0KICBleHBvcnRzLmlzU3RyaW5nID0gaXNTdHJpbmc7CiAgCiAgZnVuY3Rpb24gaXNTeW1ib2woYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCc7CiAgfQogIGV4cG9ydHMuaXNTeW1ib2wgPSBpc1N5bWJvbDsKICAKICBmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IHZvaWQgMDsKICB9CiAgZXhwb3J0cy5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogIAogIGZ1bmN0aW9uIGlzUmVnRXhwKHJlKSB7CiAgICByZXR1cm4gaXNPYmplY3QocmUpICYmIG9iamVjdFRvU3RyaW5nKHJlKSA9PT0gJ1tvYmplY3QgUmVnRXhwXSc7CiAgfQogIGV4cG9ydHMuaXNSZWdFeHAgPSBpc1JlZ0V4cDsKICAKICBmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKICAKICBmdW5jdGlvbiBpc0RhdGUoZCkgewogICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmIG9iamVjdFRvU3RyaW5nKGQpID09PSAnW29iamVjdCBEYXRlXSc7CiAgfQogIGV4cG9ydHMuaXNEYXRlID0gaXNEYXRlOwogIAogIGZ1bmN0aW9uIGlzRXJyb3IoZSkgewogICAgcmV0dXJuIGlzT2JqZWN0KGUpICYmCiAgICAgICAgKG9iamVjdFRvU3RyaW5nKGUpID09PSAnW29iamVjdCBFcnJvcl0nIHx8IGUgaW5zdGFuY2VvZiBFcnJvcik7CiAgfQogIGV4cG9ydHMuaXNFcnJvciA9IGlzRXJyb3I7CiAgCiAgZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOwogIH0KICBleHBvcnRzLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogIAogIGZ1bmN0aW9uIGlzUHJpbWl0aXZlKGFyZykgewogICAgcmV0dXJuIGFyZyA9PT0gbnVsbCB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJyB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdudW1iZXInIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnc3ltYm9sJyB8fCAgLy8gRVM2IHN5bWJvbAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnOwogIH0KICBleHBvcnRzLmlzUHJpbWl0aXZlID0gaXNQcmltaXRpdmU7CiAgCiAgZXhwb3J0cy5pc0J1ZmZlciA9IHJlcXVpcmUoJy4vc3VwcG9ydC9pc0J1ZmZlcicpOwogIAogIGZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKG8pIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobyk7CiAgfQogIAogIAogIGZ1bmN0aW9uIHBhZChuKSB7CiAgICByZXR1cm4gbiA8IDEwID8gJzAnICsgbi50b1N0cmluZygxMCkgOiBuLnRvU3RyaW5nKDEwKTsKICB9CiAgCiAgCiAgdmFyIG1vbnRocyA9IFsnSmFuJywgJ0ZlYicsICdNYXInLCAnQXByJywgJ01heScsICdKdW4nLCAnSnVsJywgJ0F1ZycsICdTZXAnLAogICAgICAgICAgICAgICAgJ09jdCcsICdOb3YnLCAnRGVjJ107CiAgCiAgLy8gMjYgRmViIDE2OjE5OjM0CiAgZnVuY3Rpb24gdGltZXN0YW1wKCkgewogICAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogICAgdmFyIHRpbWUgPSBbcGFkKGQuZ2V0SG91cnMoKSksCiAgICAgICAgICAgICAgICBwYWQoZC5nZXRNaW51dGVzKCkpLAogICAgICAgICAgICAgICAgcGFkKGQuZ2V0U2Vjb25kcygpKV0uam9pbignOicpOwogICAgcmV0dXJuIFtkLmdldERhdGUoKSwgbW9udGhzW2QuZ2V0TW9udGgoKV0sIHRpbWVdLmpvaW4oJyAnKTsKICB9CiAgCiAgCiAgLy8gbG9nIGlzIGp1c3QgYSB0aGluIHdyYXBwZXIgdG8gY29uc29sZS5sb2cgdGhhdCBwcmVwZW5kcyBhIHRpbWVzdGFtcAogIGV4cG9ydHMubG9nID0gZnVuY3Rpb24oKSB7CiAgICBjb25zb2xlLmxvZygnJXMgLSAlcycsIHRpbWVzdGFtcCgpLCBleHBvcnRzLmZvcm1hdC5hcHBseShleHBvcnRzLCBhcmd1bWVudHMpKTsKICB9OwogIAogIAogIC8qKgogICAqIEluaGVyaXQgdGhlIHByb3RvdHlwZSBtZXRob2RzIGZyb20gb25lIGNvbnN0cnVjdG9yIGludG8gYW5vdGhlci4KICAgKgogICAqIFRoZSBGdW5jdGlvbi5wcm90b3R5cGUuaW5oZXJpdHMgZnJvbSBsYW5nLmpzIHJld3JpdHRlbiBhcyBhIHN0YW5kYWxvbmUKICAgKiBmdW5jdGlvbiAobm90IG9uIEZ1bmN0aW9uLnByb3RvdHlwZSkuIE5PVEU6IElmIHRoaXMgZmlsZSBpcyB0byBiZSBsb2FkZWQKICAgKiBkdXJpbmcgYm9vdHN0cmFwcGluZyB0aGlzIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIHJld3JpdHRlbiB1c2luZyBzb21lIG5hdGl2ZQogICAqIGZ1bmN0aW9ucyBhcyBwcm90b3R5cGUgc2V0dXAgdXNpbmcgbm9ybWFsIEphdmFTY3JpcHQgZG9lcyBub3Qgd29yayBhcwogICAqIGV4cGVjdGVkIGR1cmluZyBib290c3RyYXBwaW5nIChzZWUgbWlycm9yLmpzIGluIHIxMTQ5MDMpLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbn0gY3RvciBDb25zdHJ1Y3RvciBmdW5jdGlvbiB3aGljaCBuZWVkcyB0byBpbmhlcml0IHRoZQogICAqICAgICBwcm90b3R5cGUuCiAgICogQHBhcmFtIHtmdW5jdGlvbn0gc3VwZXJDdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIHRvIGluaGVyaXQgcHJvdG90eXBlIGZyb20uCiAgICovCiAgZXhwb3J0cy5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CiAgCiAgZXhwb3J0cy5fZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luLCBhZGQpIHsKICAgIC8vIERvbid0IGRvIGFueXRoaW5nIGlmIGFkZCBpc24ndCBhbiBvYmplY3QKICAgIGlmICghYWRkIHx8ICFpc09iamVjdChhZGQpKSByZXR1cm4gb3JpZ2luOwogIAogICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhhZGQpOwogICAgdmFyIGkgPSBrZXlzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgb3JpZ2luW2tleXNbaV1dID0gYWRkW2tleXNbaV1dOwogICAgfQogICAgcmV0dXJuIG9yaWdpbjsKICB9OwogIAogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJyksdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKICB9LHsiLi9zdXBwb3J0L2lzQnVmZmVyIjo5NiwiX3Byb2Nlc3MiOjg2LCJpbmhlcml0cyI6OTV9XSw5ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHYxID0gcmVxdWlyZSgnLi92MScpOwogIHZhciB2NCA9IHJlcXVpcmUoJy4vdjQnKTsKICAKICB2YXIgdXVpZCA9IHY0OwogIHV1aWQudjEgPSB2MTsKICB1dWlkLnY0ID0gdjQ7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB1dWlkOwogIAogIH0seyIuL3YxIjoxMDEsIi4vdjQiOjEwMn1dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBDb252ZXJ0IGFycmF5IG9mIDE2IGJ5dGUgdmFsdWVzIHRvIFVVSUQgc3RyaW5nIGZvcm1hdCBvZiB0aGUgZm9ybToKICAgKiBYWFhYWFhYWC1YWFhYLVhYWFgtWFhYWC1YWFhYWFhYWFhYWFgKICAgKi8KICB2YXIgYnl0ZVRvSGV4ID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogICAgYnl0ZVRvSGV4W2ldID0gKGkgKyAweDEwMCkudG9TdHJpbmcoMTYpLnN1YnN0cigxKTsKICB9CiAgCiAgZnVuY3Rpb24gYnl0ZXNUb1V1aWQoYnVmLCBvZmZzZXQpIHsKICAgIHZhciBpID0gb2Zmc2V0IHx8IDA7CiAgICB2YXIgYnRoID0gYnl0ZVRvSGV4OwogICAgLy8gam9pbiB1c2VkIHRvIGZpeCBtZW1vcnkgaXNzdWUgY2F1c2VkIGJ5IGNvbmNhdGVuYXRpb246IGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTMxNzUjYzQKICAgIHJldHVybiAoW2J0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dXSkuam9pbignJyk7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gYnl0ZXNUb1V1aWQ7CiAgCiAgfSx7fV0sMTAwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBVbmlxdWUgSUQgY3JlYXRpb24gcmVxdWlyZXMgYSBoaWdoIHF1YWxpdHkgcmFuZG9tICMgZ2VuZXJhdG9yLiAgSW4gdGhlCiAgLy8gYnJvd3NlciB0aGlzIGlzIGEgbGl0dGxlIGNvbXBsaWNhdGVkIGR1ZSB0byB1bmtub3duIHF1YWxpdHkgb2YgTWF0aC5yYW5kb20oKQogIC8vIGFuZCBpbmNvbnNpc3RlbnQgc3VwcG9ydCBmb3IgdGhlIGBjcnlwdG9gIEFQSS4gIFdlIGRvIHRoZSBiZXN0IHdlIGNhbiB2aWEKICAvLyBmZWF0dXJlLWRldGVjdGlvbgogIAogIC8vIGdldFJhbmRvbVZhbHVlcyBuZWVkcyB0byBiZSBpbnZva2VkIGluIGEgY29udGV4dCB3aGVyZSAidGhpcyIgaXMgYSBDcnlwdG8KICAvLyBpbXBsZW1lbnRhdGlvbi4gQWxzbywgZmluZCB0aGUgY29tcGxldGUgaW1wbGVtZW50YXRpb24gb2YgY3J5cHRvIG9uIElFMTEuCiAgdmFyIGdldFJhbmRvbVZhbHVlcyA9ICh0eXBlb2YoY3J5cHRvKSAhPSAndW5kZWZpbmVkJyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzICYmIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChjcnlwdG8pKSB8fAogICAgICAgICAgICAgICAgICAgICAgICAodHlwZW9mKG1zQ3J5cHRvKSAhPSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygd2luZG93Lm1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcyA9PSAnZnVuY3Rpb24nICYmIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKG1zQ3J5cHRvKSk7CiAgCiAgaWYgKGdldFJhbmRvbVZhbHVlcykgewogICAgLy8gV0hBVFdHIGNyeXB0byBSTkcgLSBodHRwOi8vd2lraS53aGF0d2cub3JnL3dpa2kvQ3J5cHRvCiAgICB2YXIgcm5kczggPSBuZXcgVWludDhBcnJheSgxNik7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW5kZWYKICAKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gd2hhdHdnUk5HKCkgewogICAgICBnZXRSYW5kb21WYWx1ZXMocm5kczgpOwogICAgICByZXR1cm4gcm5kczg7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBNYXRoLnJhbmRvbSgpLWJhc2VkIChSTkcpCiAgICAvLwogICAgLy8gSWYgYWxsIGVsc2UgZmFpbHMsIHVzZSBNYXRoLnJhbmRvbSgpLiAgSXQncyBmYXN0LCBidXQgaXMgb2YgdW5zcGVjaWZpZWQKICAgIC8vIHF1YWxpdHkuCiAgICB2YXIgcm5kcyA9IG5ldyBBcnJheSgxNik7CiAgCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIG1hdGhSTkcoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCByOyBpIDwgMTY7IGkrKykgewogICAgICAgIGlmICgoaSAmIDB4MDMpID09PSAwKSByID0gTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwOwogICAgICAgIHJuZHNbaV0gPSByID4+PiAoKGkgJiAweDAzKSA8PCAzKSAmIDB4ZmY7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJuZHM7CiAgICB9OwogIH0KICAKICB9LHt9XSwxMDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBybmcgPSByZXF1aXJlKCcuL2xpYi9ybmcnKTsKICB2YXIgYnl0ZXNUb1V1aWQgPSByZXF1aXJlKCcuL2xpYi9ieXRlc1RvVXVpZCcpOwogIAogIC8vICoqYHYxKClgIC0gR2VuZXJhdGUgdGltZS1iYXNlZCBVVUlEKioKICAvLwogIC8vIEluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9MaW9zSy9VVUlELmpzCiAgLy8gYW5kIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS91dWlkLmh0bWwKICAKICB2YXIgX25vZGVJZDsKICB2YXIgX2Nsb2Nrc2VxOwogIAogIC8vIFByZXZpb3VzIHV1aWQgY3JlYXRpb24gdGltZQogIHZhciBfbGFzdE1TZWNzID0gMDsKICB2YXIgX2xhc3ROU2VjcyA9IDA7CiAgCiAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9icm9vZmEvbm9kZS11dWlkIGZvciBBUEkgZGV0YWlscwogIGZ1bmN0aW9uIHYxKG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICAgIHZhciBiID0gYnVmIHx8IFtdOwogIAogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB2YXIgbm9kZSA9IG9wdGlvbnMubm9kZSB8fCBfbm9kZUlkOwogICAgdmFyIGNsb2Nrc2VxID0gb3B0aW9ucy5jbG9ja3NlcSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5jbG9ja3NlcSA6IF9jbG9ja3NlcTsKICAKICAgIC8vIG5vZGUgYW5kIGNsb2Nrc2VxIG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgdG8gcmFuZG9tIHZhbHVlcyBpZiB0aGV5J3JlIG5vdAogICAgLy8gc3BlY2lmaWVkLiAgV2UgZG8gdGhpcyBsYXppbHkgdG8gbWluaW1pemUgaXNzdWVzIHJlbGF0ZWQgdG8gaW5zdWZmaWNpZW50CiAgICAvLyBzeXN0ZW0gZW50cm9weS4gIFNlZSAjMTg5CiAgICBpZiAobm9kZSA9PSBudWxsIHx8IGNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgdmFyIHNlZWRCeXRlcyA9IHJuZygpOwogICAgICBpZiAobm9kZSA9PSBudWxsKSB7CiAgICAgICAgLy8gUGVyIDQuNSwgY3JlYXRlIGFuZCA0OC1iaXQgbm9kZSBpZCwgKDQ3IHJhbmRvbSBiaXRzICsgbXVsdGljYXN0IGJpdCA9IDEpCiAgICAgICAgbm9kZSA9IF9ub2RlSWQgPSBbCiAgICAgICAgICBzZWVkQnl0ZXNbMF0gfCAweDAxLAogICAgICAgICAgc2VlZEJ5dGVzWzFdLCBzZWVkQnl0ZXNbMl0sIHNlZWRCeXRlc1szXSwgc2VlZEJ5dGVzWzRdLCBzZWVkQnl0ZXNbNV0KICAgICAgICBdOwogICAgICB9CiAgICAgIGlmIChjbG9ja3NlcSA9PSBudWxsKSB7CiAgICAgICAgLy8gUGVyIDQuMi4yLCByYW5kb21pemUgKDE0IGJpdCkgY2xvY2tzZXEKICAgICAgICBjbG9ja3NlcSA9IF9jbG9ja3NlcSA9IChzZWVkQnl0ZXNbNl0gPDwgOCB8IHNlZWRCeXRlc1s3XSkgJiAweDNmZmY7CiAgICAgIH0KICAgIH0KICAKICAgIC8vIFVVSUQgdGltZXN0YW1wcyBhcmUgMTAwIG5hbm8tc2Vjb25kIHVuaXRzIHNpbmNlIHRoZSBHcmVnb3JpYW4gZXBvY2gsCiAgICAvLyAoMTU4Mi0xMC0xNSAwMDowMCkuICBKU051bWJlcnMgYXJlbid0IHByZWNpc2UgZW5vdWdoIGZvciB0aGlzLCBzbwogICAgLy8gdGltZSBpcyBoYW5kbGVkIGludGVybmFsbHkgYXMgJ21zZWNzJyAoaW50ZWdlciBtaWxsaXNlY29uZHMpIGFuZCAnbnNlY3MnCiAgICAvLyAoMTAwLW5hbm9zZWNvbmRzIG9mZnNldCBmcm9tIG1zZWNzKSBzaW5jZSB1bml4IGVwb2NoLCAxOTcwLTAxLTAxIDAwOjAwLgogICAgdmFyIG1zZWNzID0gb3B0aW9ucy5tc2VjcyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5tc2VjcyA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIAogICAgLy8gUGVyIDQuMi4xLjIsIHVzZSBjb3VudCBvZiB1dWlkJ3MgZ2VuZXJhdGVkIGR1cmluZyB0aGUgY3VycmVudCBjbG9jawogICAgLy8gY3ljbGUgdG8gc2ltdWxhdGUgaGlnaGVyIHJlc29sdXRpb24gY2xvY2sKICAgIHZhciBuc2VjcyA9IG9wdGlvbnMubnNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubnNlY3MgOiBfbGFzdE5TZWNzICsgMTsKICAKICAgIC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKICAgIHZhciBkdCA9IChtc2VjcyAtIF9sYXN0TVNlY3MpICsgKG5zZWNzIC0gX2xhc3ROU2VjcykvMTAwMDA7CiAgCiAgICAvLyBQZXIgNC4yLjEuMiwgQnVtcCBjbG9ja3NlcSBvbiBjbG9jayByZWdyZXNzaW9uCiAgICBpZiAoZHQgPCAwICYmIG9wdGlvbnMuY2xvY2tzZXEgPT09IHVuZGVmaW5lZCkgewogICAgICBjbG9ja3NlcSA9IGNsb2Nrc2VxICsgMSAmIDB4M2ZmZjsKICAgIH0KICAKICAgIC8vIFJlc2V0IG5zZWNzIGlmIGNsb2NrIHJlZ3Jlc3NlcyAobmV3IGNsb2Nrc2VxKSBvciB3ZSd2ZSBtb3ZlZCBvbnRvIGEgbmV3CiAgICAvLyB0aW1lIGludGVydmFsCiAgICBpZiAoKGR0IDwgMCB8fCBtc2VjcyA+IF9sYXN0TVNlY3MpICYmIG9wdGlvbnMubnNlY3MgPT09IHVuZGVmaW5lZCkgewogICAgICBuc2VjcyA9IDA7CiAgICB9CiAgCiAgICAvLyBQZXIgNC4yLjEuMiBUaHJvdyBlcnJvciBpZiB0b28gbWFueSB1dWlkcyBhcmUgcmVxdWVzdGVkCiAgICBpZiAobnNlY3MgPj0gMTAwMDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCd1dWlkLnYxKCk6IENhblwndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMnKTsKICAgIH0KICAKICAgIF9sYXN0TVNlY3MgPSBtc2VjczsKICAgIF9sYXN0TlNlY3MgPSBuc2VjczsKICAgIF9jbG9ja3NlcSA9IGNsb2Nrc2VxOwogIAogICAgLy8gUGVyIDQuMS40IC0gQ29udmVydCBmcm9tIHVuaXggZXBvY2ggdG8gR3JlZ29yaWFuIGVwb2NoCiAgICBtc2VjcyArPSAxMjIxOTI5MjgwMDAwMDsKICAKICAgIC8vIGB0aW1lX2xvd2AKICAgIHZhciB0bCA9ICgobXNlY3MgJiAweGZmZmZmZmYpICogMTAwMDAgKyBuc2VjcykgJSAweDEwMDAwMDAwMDsKICAgIGJbaSsrXSA9IHRsID4+PiAyNCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDggJiAweGZmOwogICAgYltpKytdID0gdGwgJiAweGZmOwogIAogICAgLy8gYHRpbWVfbWlkYAogICAgdmFyIHRtaCA9IChtc2VjcyAvIDB4MTAwMDAwMDAwICogMTAwMDApICYgMHhmZmZmZmZmOwogICAgYltpKytdID0gdG1oID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRtaCAmIDB4ZmY7CiAgCiAgICAvLyBgdGltZV9oaWdoX2FuZF92ZXJzaW9uYAogICAgYltpKytdID0gdG1oID4+PiAyNCAmIDB4ZiB8IDB4MTA7IC8vIGluY2x1ZGUgdmVyc2lvbgogICAgYltpKytdID0gdG1oID4+PiAxNiAmIDB4ZmY7CiAgCiAgICAvLyBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAgKFBlciA0LjIuMiAtIGluY2x1ZGUgdmFyaWFudCkKICAgIGJbaSsrXSA9IGNsb2Nrc2VxID4+PiA4IHwgMHg4MDsKICAKICAgIC8vIGBjbG9ja19zZXFfbG93YAogICAgYltpKytdID0gY2xvY2tzZXEgJiAweGZmOwogIAogICAgLy8gYG5vZGVgCiAgICBmb3IgKHZhciBuID0gMDsgbiA8IDY7ICsrbikgewogICAgICBiW2kgKyBuXSA9IG5vZGVbbl07CiAgICB9CiAgCiAgICByZXR1cm4gYnVmID8gYnVmIDogYnl0ZXNUb1V1aWQoYik7CiAgfQogIAogIG1vZHVsZS5leHBvcnRzID0gdjE7CiAgCiAgfSx7Ii4vbGliL2J5dGVzVG9VdWlkIjo5OSwiLi9saWIvcm5nIjoxMDB9XSwxMDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBybmcgPSByZXF1aXJlKCcuL2xpYi9ybmcnKTsKICB2YXIgYnl0ZXNUb1V1aWQgPSByZXF1aXJlKCcuL2xpYi9ieXRlc1RvVXVpZCcpOwogIAogIGZ1bmN0aW9uIHY0KG9wdGlvbnMsIGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICAKICAgIGlmICh0eXBlb2Yob3B0aW9ucykgPT0gJ3N0cmluZycpIHsKICAgICAgYnVmID0gb3B0aW9ucyA9PT0gJ2JpbmFyeScgPyBuZXcgQXJyYXkoMTYpIDogbnVsbDsKICAgICAgb3B0aW9ucyA9IG51bGw7CiAgICB9CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHZhciBybmRzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IHJuZykoKTsKICAKICAgIC8vIFBlciA0LjQsIHNldCBiaXRzIGZvciB2ZXJzaW9uIGFuZCBgY2xvY2tfc2VxX2hpX2FuZF9yZXNlcnZlZGAKICAgIHJuZHNbNl0gPSAocm5kc1s2XSAmIDB4MGYpIHwgMHg0MDsKICAgIHJuZHNbOF0gPSAocm5kc1s4XSAmIDB4M2YpIHwgMHg4MDsKICAKICAgIC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAogICAgaWYgKGJ1ZikgewogICAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgMTY7ICsraWkpIHsKICAgICAgICBidWZbaSArIGlpXSA9IHJuZHNbaWldOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gYnVmIHx8IGJ5dGVzVG9VdWlkKHJuZHMpOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHY0OwogIAogIH0seyIuL2xpYi9ieXRlc1RvVXVpZCI6OTksIi4vbGliL3JuZyI6MTAwfV0sMTAzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAidXNlIHN0cmljdCI7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICB2YXIgTFJVXzEgPSByZXF1aXJlKCIuL3V0aWxzL0xSVSIpOwogIHZhciBDQUNIRV9TSVpFID0gMTAwMDsKICAvKioKICAgKiBJbnNwaXJlZCBub2RlLWxydS1jYWNoZVtodHRwczovL2dpdGh1Yi5jb20vaXNhYWNzL25vZGUtbHJ1LWNhY2hlXQogICAqLwogIHZhciBFbmRwb2ludENhY2hlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBFbmRwb2ludENhY2hlKG1heFNpemUpIHsKICAgICAgICAgIGlmIChtYXhTaXplID09PSB2b2lkIDApIHsgbWF4U2l6ZSA9IENBQ0hFX1NJWkU7IH0KICAgICAgICAgIHRoaXMubWF4U2l6ZSA9IG1heFNpemU7CiAgICAgICAgICB0aGlzLmNhY2hlID0gbmV3IExSVV8xLkxSVUNhY2hlKG1heFNpemUpOwogICAgICB9CiAgICAgIDsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLCAic2l6ZSIsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmNhY2hlLmxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5wdXQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgICB2YXIgZW5kcG9pbnRSZWNvcmQgPSB0aGlzLnBvcHVsYXRlVmFsdWUodmFsdWUpOwogICAgICAgICAgdGhpcy5jYWNoZS5wdXQoa2V5U3RyaW5nLCBlbmRwb2ludFJlY29yZCk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuY2FjaGUuZ2V0KGtleVN0cmluZyk7CiAgICAgICAgICBpZiAocmVjb3JkcykgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3Jkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgcmVjb3JkID0gcmVjb3Jkc1tpXTsKICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5FeHBpcmUgPCBub3cpIHsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2FjaGUucmVtb3ZlKGtleVN0cmluZyk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlY29yZHM7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgdmFyIGlkZW50aWZpZXJzID0gW107CiAgICAgICAgICB2YXIgaWRlbnRpZmllck5hbWVzID0gT2JqZWN0LmtleXMoa2V5KS5zb3J0KCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlkZW50aWZpZXJOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpZGVudGlmaWVyTmFtZSA9IGlkZW50aWZpZXJOYW1lc1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5W2lkZW50aWZpZXJOYW1lXSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICBpZGVudGlmaWVycy5wdXNoKGtleVtpZGVudGlmaWVyTmFtZV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlkZW50aWZpZXJzLmpvaW4oJyAnKTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucG9wdWxhdGVWYWx1ZSA9IGZ1bmN0aW9uIChlbmRwb2ludHMpIHsKICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpOwogICAgICAgICAgcmV0dXJuIGVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7IHJldHVybiAoewogICAgICAgICAgICAgIEFkZHJlc3M6IGVuZHBvaW50LkFkZHJlc3MgfHwgJycsCiAgICAgICAgICAgICAgRXhwaXJlOiBub3cgKyAoZW5kcG9pbnQuQ2FjaGVQZXJpb2RJbk1pbnV0ZXMgfHwgMSkgKiA2MCAqIDEwMDAKICAgICAgICAgIH0pOyB9KTsKICAgICAgfTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0aGlzLmNhY2hlLmVtcHR5KCk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgICAgfTsKICAgICAgcmV0dXJuIEVuZHBvaW50Q2FjaGU7CiAgfSgpKTsKICBleHBvcnRzLkVuZHBvaW50Q2FjaGUgPSBFbmRwb2ludENhY2hlOwogIH0seyIuL3V0aWxzL0xSVSI6MTA0fV0sMTA0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAidXNlIHN0cmljdCI7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKICB2YXIgTGlua2VkTGlzdE5vZGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpIHsKICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBMaW5rZWRMaXN0Tm9kZTsKICB9KCkpOwogIHZhciBMUlVDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gTFJVQ2FjaGUoc2l6ZSkgewogICAgICAgICAgdGhpcy5ub2RlTWFwID0ge307CiAgICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJyB8fCBzaXplIDwgMSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FjaGUgc2l6ZSBjYW4gb25seSBiZSBwb3NpdGl2ZSBudW1iZXInKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc2l6ZUxpbWl0ID0gc2l6ZTsKICAgICAgfQogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTFJVQ2FjaGUucHJvdG90eXBlLCAibGVuZ3RoIiwgewogICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2l6ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucHJlcGVuZFRvTGlzdCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICBpZiAoIXRoaXMuaGVhZGVyTm9kZSkgewogICAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlLnByZXYgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUubmV4dCA9IHRoaXMuaGVhZGVyTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGU7CiAgICAgICAgICB0aGlzLnNpemUrKzsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZUZyb21UYWlsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCF0aGlzLnRhaWxOb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlID0gdGhpcy50YWlsTm9kZTsKICAgICAgICAgIHZhciBwcmV2Tm9kZSA9IG5vZGUucHJldjsKICAgICAgICAgIGlmIChwcmV2Tm9kZSkgewogICAgICAgICAgICAgIHByZXZOb2RlLm5leHQgPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gcHJldk5vZGU7CiAgICAgICAgICB0aGlzLnNpemUtLTsKICAgICAgICAgIHJldHVybiBub2RlOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZGV0YWNoRnJvbUxpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgaWYgKHRoaXMuaGVhZGVyTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGUubmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnRhaWxOb2RlID09PSBub2RlKSB7CiAgICAgICAgICAgICAgdGhpcy50YWlsTm9kZSA9IG5vZGUucHJldjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnByZXYpIHsKICAgICAgICAgICAgICBub2RlLnByZXYubmV4dCA9IG5vZGUubmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLm5leHQpIHsKICAgICAgICAgICAgICBub2RlLm5leHQucHJldiA9IG5vZGUucHJldjsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICAgIG5vZGUucHJldiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGtleSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgICB0aGlzLmRldGFjaEZyb21MaXN0KG5vZGUpOwogICAgICAgICAgICAgIHRoaXMucHJlcGVuZFRvTGlzdChub2RlKTsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICAgIH0KICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVNYXBba2V5XSkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5wdXQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICAgICAgaWYgKHRoaXMubm9kZU1hcFtrZXldKSB7CiAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgaWYgKHRoaXMuc2l6ZSA9PT0gdGhpcy5zaXplTGltaXQpIHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSB0aGlzLnJlbW92ZUZyb21UYWlsKCk7CiAgICAgICAgICAgICAgdmFyIGtleV8xID0gdGFpbE5vZGUua2V5OwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XzFdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld05vZGUgPSBuZXcgTGlua2VkTGlzdE5vZGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLm5vZGVNYXBba2V5XSA9IG5ld05vZGU7CiAgICAgICAgICB0aGlzLnByZXBlbmRUb0xpc3QobmV3Tm9kZSk7CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5lbXB0eSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5ub2RlTWFwKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIHJldHVybiBMUlVDYWNoZTsKICB9KCkpOwogIGV4cG9ydHMuTFJVQ2FjaGUgPSBMUlVDYWNoZTsKICB9LHt9XSwxMDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuNTUzLjAKICAvLyBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICAvLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CiAgcmVxdWlyZSgnLi9icm93c2VyX2xvYWRlcicpOwogIAogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHdpbmRvdy5BV1MgPSBBV1M7CiAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIC8qKgogICAgICAgKiBAYXBpIHByaXZhdGUKICAgICAgICovCiAgICAgIG1vZHVsZS5leHBvcnRzID0gQVdTOwogIH0KICBpZiAodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnKSBzZWxmLkFXUyA9IEFXUzsKICAKICAvKioKICAgKiBAcHJpdmF0ZQogICAqIERPIE5PVCBSRU1PVkUKICAgKiBicm93c2VyIGJ1aWxkZXIgd2lsbCBzdHJpcCBvdXQgdGhpcyBsaW5lIGlmIHNlcnZpY2VzIGFyZSBzdXBwbGllZCBvbiB0aGUgY29tbWFuZCBsaW5lLgogICAqL2lmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUywgJ0Nvbm5lY3QnKSkgewogICAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snY29ubmVjdCddID0ge307CiAgICBBV1MuQ29ubmVjdCA9IEFXUy5TZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2Nvbm5lY3QnLCBbICcyMDE3LTAyLTE1JyBdKTsKICB9CiAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snY29ubmVjdCddWycyMDE3LTAyLTE1J10gPSByZXF1aXJlKCcuLi9hcGlzL2Nvbm5lY3QtMjAxNy0wMi0xNS5taW4nKTsKICAKICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MsICdTVFMnKSkgewogICAgQVdTLmFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10gPSB7fTsKICAgIEFXUy5TVFMgPSBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdzdHMnLCBbICcyMDExLTA2LTE1JyBdKTsKICAgIHJlcXVpcmUoJy4vc2VydmljZXMvc3RzJyk7CiAgfQogIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddWycyMDExLTA2LTE1J10gPSByZXF1aXJlKCcuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbicpOwogIAogIAogIH0seyIuLi9hcGlzL2Nvbm5lY3QtMjAxNy0wMi0xNS5taW4iOjMsIi4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluIjo1LCIuL2Jyb3dzZXJfbG9hZGVyIjoxNiwiLi9jb3JlIjoxOCwiLi9zZXJ2aWNlcy9zdHMiOjYxfV19LHt9LFsxMDVdKTsKCi8qKiovIH0pLAoKLyoqKi8gNzU0OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIENsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuQ2xpZW50TWV0aG9kcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgICAgICAnZ2V0QWdlbnRTbmFwc2hvdCcsCiAgICAgICAgICdwdXRBZ2VudFN0YXRlJywKICAgICAgICAgJ2dldEFnZW50U3RhdGVzJywKICAgICAgICAgJ2dldERpYWxhYmxlQ291bnRyeUNvZGVzJywKICAgICAgICAgJ2dldFJvdXRpbmdQcm9maWxlUXVldWVzJywKICAgICAgICAgJ2dldEFnZW50UGVybWlzc2lvbnMnLAogICAgICAgICAnZ2V0QWdlbnRDb25maWd1cmF0aW9uJywKICAgICAgICAgJ3VwZGF0ZUFnZW50Q29uZmlndXJhdGlvbicsCiAgICAgICAgICdhY2NlcHRDb250YWN0JywKICAgICAgICAgJ2NyZWF0ZU91dGJvdW5kQ29udGFjdCcsCiAgICAgICAgICdjcmVhdGVUYXNrQ29udGFjdCcsCiAgICAgICAgICdjbGVhckNvbnRhY3QnLAogICAgICAgICAnY29tcGxldGVDb250YWN0JywKICAgICAgICAgJ2Rlc3Ryb3lDb250YWN0JywKICAgICAgICAgJ3JlamVjdENvbnRhY3QnLAogICAgICAgICAnbm90aWZ5Q29udGFjdElzc3VlJywKICAgICAgICAgJ3VwZGF0ZUNvbnRhY3RBdHRyaWJ1dGVzJywKICAgICAgICAgJ2NyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uJywKICAgICAgICAgJ2Rlc3Ryb3lDb25uZWN0aW9uJywKICAgICAgICAgJ2hvbGRDb25uZWN0aW9uJywKICAgICAgICAgJ3Jlc3VtZUNvbm5lY3Rpb24nLAogICAgICAgICAndG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMnLAogICAgICAgICAnY29uZmVyZW5jZUNvbm5lY3Rpb25zJywKICAgICAgICAgJ3NlbmRDbGllbnRMb2dzJywKICAgICAgICAgJ3NlbmREaWdpdHMnLAogICAgICAgICAnc2VuZFNvZnRwaG9uZUNhbGxSZXBvcnQnLAogICAgICAgICAnc2VuZFNvZnRwaG9uZUNhbGxNZXRyaWNzJywKICAgICAgICAgJ2dldEVuZHBvaW50cycsCiAgICAgICAgICdnZXROZXdBdXRoVG9rZW4nLAogICAgICAgICAnY3JlYXRlVHJhbnNwb3J0JywKICAgICAgICAgJ211dGVQYXJ0aWNpcGFudCcsCiAgICAgICAgICd1bm11dGVQYXJ0aWNpcGFudCcsCiAgICAgICAgICd1cGRhdGVNb25pdG9yUGFydGljaXBhbnRTdGF0ZScKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBBZ2VudEFwcENsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzID0gewogICAgICBHRVRfQ09OVEFDVDogIkFnZW50QXBwU2VydmljZS5MY21zLmdldENvbnRhY3QiLAogICAgICBERUxFVEVfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlbGV0ZVNwZWFrZXIiLAogICAgICBFTlJPTExfQllfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmVucm9sbEJ5U2Vzc2lvbiIsCiAgICAgIEVWQUxVQVRFX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5ldmFsdWF0ZVNlc3Npb24iLAogICAgICBERVNDUklCRV9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZGVzY3JpYmVTcGVha2VyIiwKICAgICAgT1BUX09VVF9TUEVBS0VSOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQub3B0T3V0U3BlYWtlciIsCiAgICAgIFVQREFURV9WT0lDRV9JRF9EQVRBOiAiQWdlbnRBcHBTZXJ2aWNlLkxjbXMudXBkYXRlVm9pY2VJZERhdGEiLAogICAgICBERVNDUklCRV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZGVzY3JpYmVTZXNzaW9uIiwKICAgICAgVVBEQVRFX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC51cGRhdGVTZXNzaW9uIiwKICAgICAgU1RBUlRfVk9JQ0VfSURfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5OYXNhLnN0YXJ0Vm9pY2VJZFNlc3Npb24iLAogICAgICBMSVNUX0lOVEVHUkFUSU9OX0FTU09DSUFUSU9OUzogIkFnZW50QXBwU2VydmljZS5BY3MubGlzdEludGVncmF0aW9uQXNzb2NpYXRpb25zIiwKICAgICAgU1RBUlRfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlN0YXJ0Q29udGFjdFJlY29yZGluZyIsCiAgICAgIFNUT1BfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlN0b3BDb250YWN0UmVjb3JkaW5nIiwKICAgICAgU1VTUEVORF9DT05UQUNUX1JFQ09SRElORzogIkFnZW50QXBwU2VydmljZS5BY3MuU3VzcGVuZENvbnRhY3RSZWNvcmRpbmciLAogICAgICBSRVNVTUVfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlJlc3VtZUNvbnRhY3RSZWNvcmRpbmciCiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBNYXN0ZXJNZXRob2RzCiAgICAqLwogICBjb25uZWN0Lk1hc3Rlck1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2JlY29tZU1hc3RlcicsCiAgICAgICAgICdjaGVja01hc3RlcicKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBUYXNrVGVtcGxhdGVzQ2xpZW50TWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50TWV0aG9kcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgICAnbGlzdFRhc2tUZW1wbGF0ZXMnLAogICAgICAnZ2V0VGFza1RlbXBsYXRlJywKICAgICAgJ2NyZWF0ZVRlbXBsYXRlZFRhc2snLAogICAgICAndXBkYXRlQ29udGFjdCcKICAgXSk7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIENsaWVudEJhc2UgPSBmdW5jdGlvbigpIHt9OwogICBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUyA9IHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7IH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKCkgeyB9CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5jYWxsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXNJbiwgY2FsbGJhY2tzSW4pIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICAgIHZhciBjYWxsYmFja3MgPSBjYWxsYmFja3NJbiB8fCBDbGllbnRCYXNlLkVNUFRZX0NBTExCQUNLUzsKICAgICAgdGhpcy5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcyk7CiAgIH07CgogICBDbGllbnRCYXNlLnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIE51bGxDbGllbnQgPSBmdW5jdGlvbigpIHsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICB9OwogICBOdWxsQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE51bGxDbGllbnQ7CgogICBOdWxsQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgdmFyIG1lc3NhZ2UgPSBjb25uZWN0LnNwcmludGYoJ05vIHN1Y2ggbWV0aG9kIGV4aXN0cyBvbiBOVUxMIGNsaWVudDogJXMnLCBtZXRob2QpOwogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpLCB7bWVzc2FnZTogbWVzc2FnZX0pOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogYWJzdHJhY3QgY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlID0gZnVuY3Rpb24oY29uZHVpdCwgcmVxdWVzdEV2ZW50LCByZXNwb25zZUV2ZW50KSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgICAgdGhpcy5yZXF1ZXN0RXZlbnQgPSByZXF1ZXN0RXZlbnQ7CiAgICAgIHRoaXMucmVzcG9uc2VFdmVudCA9IHJlc3BvbnNlRXZlbnQ7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcCA9IHt9OwoKICAgICAgdGhpcy5jb25kdWl0Lm9uVXBzdHJlYW0ocmVzcG9uc2VFdmVudCwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9oYW5kbGVSZXNwb25zZSkpOwogICB9OwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlOwoKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB2YXIgcmVxdWVzdCA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QodGhpcy5yZXF1ZXN0RXZlbnQsIG1ldGhvZCwgcGFyYW1zKTsKICAgICAgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3QucmVxdWVzdElkXSA9IGNhbGxiYWNrczsKICAgICAgdGhpcy5jb25kdWl0LnNlbmRVcHN0cmVhbShyZXF1ZXN0LmV2ZW50LCByZXF1ZXN0KTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0ID0gZnVuY3Rpb24ocmVxdWVzdElkKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXSB8fCBudWxsOwoKICAgICAgaWYgKGNhbGxiYWNrcyAhPSBudWxsKSB7CiAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXBbcmVxdWVzdElkXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGNhbGxiYWNrczsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9oYW5kbGVSZXNwb25zZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2dldENhbGxiYWNrc0ZvclJlcXVlc3QoZGF0YS5yZXF1ZXN0SWQpOwogICAgICBpZiAoY2FsbGJhY2tzID09IG51bGwpIHsKICAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoZGF0YS5lcnIgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZGF0YS5lcnIsIGRhdGEuZGF0YSk7CgogICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdENsaWVudDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLmNhbGwodGhpcywgY29uZHVpdCwgY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSk7CiAgIH07CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudDsKICAgCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50QXBwQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogICB2YXIgQWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbihhdXRoQ29va2llTmFtZSwgYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aENvb2tpZU5hbWUsICdhdXRoQ29va2llTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50Jyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5lbmRwb2ludFVybCA9IGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sKGVuZHBvaW50KTsKICAgICAgdGhpcy5hdXRoVG9rZW4gPSBhdXRoVG9rZW47CiAgICAgIHRoaXMuYXV0aENvb2tpZU5hbWUgPSBhdXRoQ29va2llTmFtZQogICB9OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50QXBwQ2xpZW50OwoKICAgQWdlbnRBcHBDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgYmVhciA9IHt9OwogICAgICBiZWFyW3NlbGYuYXV0aENvb2tpZU5hbWVdID0gc2VsZi5hdXRoVG9rZW47CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICBtZXRob2Q6ICdwb3N0JywKICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGFyYW1zIHx8IHt9KSwKICAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgICAgICAgICAnWC1BbXotdGFyZ2V0JzogbWV0aG9kLAogICAgICAgICAgICAgICAnWC1BbXotQmVhcmVyJzogSlNPTi5zdHJpbmdpZnkoYmVhcikKICAgICAgICAgfQogICAgICB9OwogICAgICBjb25uZWN0LmZldGNoKHNlbGYuZW5kcG9pbnRVcmwsIG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocmVzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgY29uc3QgcmVhZGVyID0gZXJyLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgICAgIGxldCBib2R5ID0gJyc7CiAgICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHsgZG9uZSwgdmFsdWUgfSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBlcnIuc3RhdHVzOwogICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkKCkudGhlbihwcm9jZXNzVGV4dCk7CiAgICAgICAgIH0pOwogICAgICB9KQogICB9OwogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQVdTQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIEFXU0NsaWVudCA9IGZ1bmN0aW9uKGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludEluKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhdXRoVG9rZW4sICdhdXRoVG9rZW4nKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZ2lvbiwgJ3JlZ2lvbicpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHt9KTsKICAgICAgQVdTLmNvbmZpZy5yZWdpb24gPSByZWdpb247CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB2YXIgYmFzZVVybCA9IGNvbm5lY3QuZ2V0QmFzZVVybCgpOwogICAgICB2YXIgZW5kcG9pbnRVcmwgPSBlbmRwb2ludEluIHx8ICggCiAgICAgICAgIGJhc2VVcmwuaW5jbHVkZXMoIi5hd3NhcHBzLmNvbSIpCiAgICAgICAgICAgID8gYmFzZVVybCArICcvY29ubmVjdC9hcGknCiAgICAgICAgICAgIDogYmFzZVVybCArICcvYXBpJwogICAgICApOwogICAgICB2YXIgZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50VXJsKTsKICAgICAgdGhpcy5jbGllbnQgPSBuZXcgQVdTLkNvbm5lY3Qoe2VuZHBvaW50OiBlbmRwb2ludH0pOwogICB9OwogICBBV1NDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIEFXU0NsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBV1NDbGllbnQ7CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CgogICAgICBpZiAoISBjb25uZWN0LmNvbnRhaW5zKHRoaXMuY2xpZW50LCBtZXRob2QpKSB7CiAgICAgICAgIHZhciBtZXNzYWdlID0gY29ubmVjdC5zcHJpbnRmKCdObyBzdWNoIG1ldGhvZCBleGlzdHMgb24gQVdTIGNsaWVudDogJXMnLCBtZXRob2QpOwogICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpLCB7bWVzc2FnZTogbWVzc2FnZX0pOwoKICAgICAgfSBlbHNlIHsKICAgICAgICAgcGFyYW1zID0gdGhpcy5fdHJhbnNsYXRlUGFyYW1zKG1ldGhvZCwgcGFyYW1zKTsKCiAgICAgICAgIGxvZy50cmFjZSgiQVdTQ2xpZW50OiAtLT4gQ2FsbGluZyBvcGVyYXRpb24gJyVzJyIsIG1ldGhvZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgICAgIHRoaXMuY2xpZW50W21ldGhvZF0ocGFyYW1zKQogICAgICAgICAgICAub24oJ2J1aWxkJywgZnVuY3Rpb24ocmVxdWVzdCkgewogICAgICAgICAgICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUJlYXJlciddID0gc2VsZi5hdXRoVG9rZW47CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gY29ubmVjdC5DVElFeGNlcHRpb25zLlVOQVVUSE9SSVpFRF9FWENFUFRJT04pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmF1dGhGYWlsdXJlKCk7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCAmJiAoZXJyLmNvZGUgPT09IGNvbm5lY3QuQ1RJRXhjZXB0aW9ucy5BQ0NFU1NfREVOSUVEX0VYQ0VQVElPTiB8fCBlcnIuc3RhdHVzQ29kZSA9PT0gNDAzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MuYWNjZXNzRGVuaWVkKCk7CiAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENhbid0IHBhc3MgZXJyIGRpcmVjdGx5IHRvIHBvc3RNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBvc3RNZXNzYWdlKCkgdHJpZXMgdG8gY2xvbmUgdGhlIGVyciBvYmplY3QgYW5kIGZhaWxlZC4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVmZXIgdG8gaHR0cHM6Ly9naXRodWIuY29tL2dvYXRzbGFja2VyL2FsdC1kZXZ0b29sL2lzc3Vlcy81CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci50eXBlID0gZXJyLmNvZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVyci5zdGFjayl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlcnIuc3RhY2spKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBlcnIuc3RhY2s7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnIuc3RhY2sgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBbSlNPTi5zdHJpbmdpZnkoZXJyLnN0YWNrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnIuc3RhY2sgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc3RhY2sgPSBlcnIuc3RhY2suc3BsaXQoJ1xuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2gge30KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogPC0tIE9wZXJhdGlvbiAnJXMnIGZhaWxlZDogJXMiLCBtZXRob2QsIEpTT04uc3RyaW5naWZ5KGVycikpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogPC0tIE9wZXJhdGlvbiAnJXMnIHN1Y2NlZWRlZC4iLCBtZXRob2QpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gaGFuZGxlIEFXUyBBUEkgcmVxdWVzdCBmb3IgbWV0aG9kICVzIiwgbWV0aG9kKQogICAgICAgICAgICAgICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICB9CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl9yZXF1aXJlc0F1dGhlbnRpY2F0aW9uUGFyYW0gPSBmdW5jdGlvbiAobWV0aG9kKSB7CiAgICAgIHJldHVybiBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DT01QTEVURV9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNMRUFSX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVKRUNUX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RBU0tfQ09OVEFDVDsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVBhcmFtcyA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zKSB7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OOgogICAgICAgICAgICBwYXJhbXMuY29uZmlndXJhdGlvbiA9IHRoaXMuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbihwYXJhbXMuY29uZmlndXJhdGlvbik7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9NRVRSSUNTOgogICAgICAgICAgICBwYXJhbXMuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MoCiAgICAgICAgICAgICAgICAgIHBhcmFtcy5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX1JFUE9SVDoKICAgICAgICAgICAgcGFyYW1zLnJlcG9ydCA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQocGFyYW1zLnJlcG9ydCk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLl9yZXF1aXJlc0F1dGhlbnRpY2F0aW9uUGFyYW0obWV0aG9kKSkgewogICAgICAgICBwYXJhbXMuYXV0aGVudGljYXRpb24gPSB7CiAgICAgICAgICAgIGF1dGhUb2tlbjogdGhpcy5hdXRoVG9rZW4KICAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZUFnZW50Q29uZmlndXJhdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICByZXR1cm4gewogICAgICAgICBuYW1lOiBjb25maWcubmFtZSwKICAgICAgICAgc29mdHBob25lRW5hYmxlZDogY29uZmlnLnNvZnRwaG9uZUVuYWJsZWQsCiAgICAgICAgIHNvZnRwaG9uZUF1dG9BY2NlcHQ6IGNvbmZpZy5zb2Z0cGhvbmVBdXRvQWNjZXB0LAogICAgICAgICBleHRlbnNpb246IGNvbmZpZy5leHRlbnNpb24sCiAgICAgICAgIHJvdXRpbmdQcm9maWxlOiB0aGlzLl90cmFuc2xhdGVSb3V0aW5nUHJvZmlsZShjb25maWcucm91dGluZ1Byb2ZpbGUpLAogICAgICAgICBhZ2VudFByZWZlcmVuY2VzOiBjb25maWcuYWdlbnRQcmVmZXJlbmNlcwogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUm91dGluZ1Byb2ZpbGUgPSBmdW5jdGlvbihwcm9maWxlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgIG5hbWU6IHByb2ZpbGUubmFtZSwKICAgICAgICAgcm91dGluZ1Byb2ZpbGVBUk46IHByb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk4sCiAgICAgICAgIGRlZmF1bHRPdXRib3VuZFF1ZXVlOiB0aGlzLl90cmFuc2xhdGVRdWV1ZShwcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlKQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlUXVldWUgPSBmdW5jdGlvbihxdWV1ZSkgewogICAgICByZXR1cm4gewogICAgICAgICBxdWV1ZUFSTjogICBxdWV1ZS5xdWV1ZUFSTiwKICAgICAgICAgbmFtZTogICAgICAgcXVldWUubmFtZQogICAgICB9OwogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICAgIHN0YXRzLmZvckVhY2goZnVuY3Rpb24oc3RhdCkgewogICAgICAgICBpZiAoJ3BhY2tldHNDb3VudCcgaW4gc3RhdCkgewogICAgICAgICAgICBzdGF0LnBhY2tldENvdW50ID0gc3RhdC5wYWNrZXRzQ291bnQ7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0LnBhY2tldHNDb3VudDsKICAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHJldHVybiBzdGF0czsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVNvZnRwaG9uZUNhbGxSZXBvcnQgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgICAgaWYgKCdoYW5kc2hha2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQuaGFuZHNoYWtlVGltZU1pbGxpcyA9IHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ3ByZVRhbGtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LnByZVRhbGtUaW1lTWlsbGlzID0gcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICBpZiAoJ2hhbmRzaGFraW5nRmFpbHVyZScgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5oYW5kc2hha2VGYWlsdXJlID0gcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZTsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmU7CiAgICAgIH0KCiAgICAgIGlmICgndGFsa2luZ1RpbWVNaWxsaXMnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQudGFsa1RpbWVNaWxsaXMgPSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXM7CiAgICAgIH0KCiAgICAgIHJlcG9ydC5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzID0gdGhpcy5fdHJhbnNsYXRlU29mdHBob25lU3RyZWFtU3RhdGlzdGljcygKICAgICAgICAgICAgcmVwb3J0LnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MpOwoKICAgICAgcmV0dXJuIHJlcG9ydDsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIFRhc2tUZW1wbGF0ZXNDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICovCiAgIHZhciBUYXNrVGVtcGxhdGVzQ2xpZW50ID0gZnVuY3Rpb24oZW5kcG9pbnQpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKTsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICBpZiAoZW5kcG9pbnQuaW5jbHVkZXMoJy90YXNrLXRlbXBsYXRlcycpKSB7CiAgICAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbChlbmRwb2ludCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgIHZhciBBV1NFbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICB2YXIgQ0ZQcmVmaXggPSBlbmRwb2ludC5pbmNsdWRlcygnLmF3c2FwcHMuY29tJykgPyAnL2Nvbm5lY3QnIDogJyc7CiAgICAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbChgJHtBV1NFbmRwb2ludC5ob3N0fSR7Q0ZQcmVmaXh9L3Rhc2stdGVtcGxhdGVzL2FwaS9jY3BgKTsKICAgICAgfQogICB9OwoKICAgVGFza1RlbXBsYXRlc0NsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgVGFza1RlbXBsYXRlc0NsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUYXNrVGVtcGxhdGVzQ2xpZW50OwoKICAgVGFza1RlbXBsYXRlc0NsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWV0aG9kLCAnbWV0aG9kJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgJ3gtY3NyZi10b2tlbic6ICdjc3JmJyAgICAgICAgIAogICAgICAgICB9CiAgICAgIH07CiAgICAgIHZhciBpbnN0YW5jZUlkID0gcGFyYW1zLmluc3RhbmNlSWQ7CiAgICAgIHZhciB1cmwgPSB0aGlzLmVuZHBvaW50VXJsOwogICAgICB2YXIgbWV0aG9kcyA9IGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHM7CiAgICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgICAgIGNhc2UgbWV0aG9kcy5MSVNUX1RBU0tfVEVNUExBVEVTOiAKICAgICAgICAgICAgdXJsICs9IGAvcHJveHkvaW5zdGFuY2UvJHtpbnN0YW5jZUlkfS90YXNrL3RlbXBsYXRlYDsKICAgICAgICAgICAgaWYgKHBhcmFtcy5xdWVyeVBhcmFtcykgewogICAgICAgICAgICAgICBjb25zdCBxdWVyeVN0cmluZyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMocGFyYW1zLnF1ZXJ5UGFyYW1zKS50b1N0cmluZygpOwogICAgICAgICAgICAgICBpZiAocXVlcnlTdHJpbmcpIHsKICAgICAgICAgICAgICAgICAgdXJsICs9IGA/JHtxdWVyeVN0cmluZ31gOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIGNhc2UgbWV0aG9kcy5HRVRfVEFTS19URU1QTEFURTogCiAgICAgICAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMudGVtcGxhdGVQYXJhbXMsICdwYXJhbXMudGVtcGxhdGVQYXJhbXMnKTsKICAgICAgICAgICAgY29uc3QgaWQgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnRlbXBsYXRlUGFyYW1zLmlkLCAncGFyYW1zLnRlbXBsYXRlUGFyYW1zLmlkJyk7CiAgICAgICAgICAgIGNvbnN0IHZlcnNpb24gPSBwYXJhbXMudGVtcGxhdGVQYXJhbXMudmVyc2lvbjsKICAgICAgICAgICAgdXJsICs9IGAvcHJveHkvaW5zdGFuY2UvJHtpbnN0YW5jZUlkfS90YXNrL3RlbXBsYXRlLyR7aWR9YDsKICAgICAgICAgICAgaWYgKHZlcnNpb24pIHsKICAgICAgICAgICAgICAgdXJsICs9IGA/c25hcHNob3RWZXJzaW9uPSR7dmVyc2lvbn1gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuQ1JFQVRFX1RFTVBMQVRFRF9UQVNLOiAKICAgICAgICAgICAgdXJsICs9IGAvJHttZXRob2R9YDsKICAgICAgICAgICAgb3B0aW9ucy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTsKICAgICAgICAgICAgb3B0aW9ucy5tZXRob2QgPSAnUFVUJzsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIGNhc2UgbWV0aG9kcy5VUERBVEVfQ09OVEFDVDogCiAgICAgICAgICAgIHVybCArPSBgLyR7bWV0aG9kfWA7CiAgICAgICAgICAgIG9wdGlvbnMuYm9keSA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7CiAgICAgICAgICAgIG9wdGlvbnMubWV0aG9kID0gJ1BPU1QnOwogICAgICB9CiAgICAgIGNvbm5lY3QuZmV0Y2godXJsLCBvcHRpb25zKQogICAgICAudGhlbihmdW5jdGlvbihyZXMpewogICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhyZXMpOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgICBjb25zdCByZWFkZXIgPSBlcnIuYm9keS5nZXRSZWFkZXIoKTsKICAgICAgICAgbGV0IGJvZHkgPSAnJzsKICAgICAgICAgY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcigpOwogICAgICAgICByZWFkZXIucmVhZCgpLnRoZW4oZnVuY3Rpb24gcHJvY2Vzc1RleHQoeyBkb25lLCB2YWx1ZSB9KSB7CiAgICAgICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICAgICAgIHZhciBlcnJvciA9IEpTT04ucGFyc2UoYm9keSk7CiAgICAgICAgICAgICAgIGVycm9yLnN0YXR1cyA9IGVyci5zdGF0dXM7CiAgICAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yKTsKICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkgKz0gZGVjb2Rlci5kZWNvZGUodmFsdWUpOwogICAgICAgICAgICByZXR1cm4gcmVhZGVyLnJlYWQoKS50aGVuKHByb2Nlc3NUZXh0KTsKICAgICAgICAgfSk7CiAgICAgIH0pCiAgIH07CgogICBjb25uZWN0LkNsaWVudEJhc2UgPSBDbGllbnRCYXNlOwogICBjb25uZWN0Lk51bGxDbGllbnQgPSBOdWxsQ2xpZW50OwogICBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudCA9IFVwc3RyZWFtQ29uZHVpdENsaWVudDsKICAgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQgPSBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQ7CiAgIGNvbm5lY3QuQVdTQ2xpZW50ID0gQVdTQ2xpZW50OwogICBjb25uZWN0LkFnZW50QXBwQ2xpZW50ID0gQWdlbnRBcHBDbGllbnQ7CiAgIGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudCA9IFRhc2tUZW1wbGF0ZXNDbGllbnQ7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4OTU6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICBjb25uZWN0LmNvcmUgPSB7fTsKICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICBjb25uZWN0LnZlcnNpb24gPSAiU1RSRUFNU19WRVJTSU9OIjsKICBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRSA9IDUwMDsKIAogIHZhciBDQ1BfU1lOX1RJTUVPVVQgPSAxMDAwOyAvLyAxIHNlYwogIHZhciBDQ1BfQUNLX1RJTUVPVVQgPSAzMDAwOyAvLyAzIHNlYwogIHZhciBDQ1BfTE9BRF9USU1FT1VUID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gMTAwMDA7IC8vMTAgcwogIHZhciBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQgPSA2OyAvLyA2IGF0dGVtcHRzCiAgdmFyIENDUF9JRlJBTUVfTkFNRSA9ICdBbWF6b24gQ29ubmVjdCBDQ1AnOwogCiAgdmFyIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTiA9ICJodHRwczovL3thbGlhc30uYXdzYXBwcy5jb20vYXV0aC8/Y2xpZW50X2lkPXtjbGllbnRfaWR9JnJlZGlyZWN0X3VyaT17cmVkaXJlY3R9IjsKICB2YXIgQ0xJRU5UX0lEX01BUCA9IHsKICAgICJ1cy1lYXN0LTEiOiAiMDY5MTlmNGZkOGVkMzI0ZSIKICB9OwogCiAgdmFyIEFVVEhPUklaRV9FTkRQT0lOVCA9ICIvYXV0aC9hdXRob3JpemUiOwogIHZhciBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UID0gIi9jb25uZWN0L2F1dGgvYXV0aG9yaXplIjsKICB2YXIgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgQVVUSE9SSVpFX01BWF9SRVRSWSA9IDU7CiAKICB2YXIgTEVHQUNZX1dISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL2Nvbm5lY3Qvd2hpdGVsaXN0ZWQtb3JpZ2lucyI7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkgPSA1OwoKICB2YXIgQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTID0gJ0lmcmFtZVJlZnJlc2hBdHRlbXB0cyc7CiAgdmFyIENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUyA9ICdJZnJhbWVJbml0aWFsaXphdGlvblN1Y2Nlc3MnOwogIHZhciBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1RJTUUgPSAnSWZyYW1lSW5pdGlhbGl6YXRpb25UaW1lJzsKCiAgdmFyIENPTk5FQ1RFRF9DQ1BTX1NJTkdMRV9UQUIgPSAnQ29ubmVjdGVkQ0NQU2luZ2xlVGFiQ291bnQnOwogIHZhciBDQ1BfVEFCU19BQ1JPU1NfQlJPV1NFUl9DT1VOVCA9ICdDQ1BUYWJzQWNyb3NzQnJvd3NlckNvdW50JzsKCiAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSAwOwogIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID0gMDsKCiAgY29ubmVjdC5jb3JlLk1BWF9BVVRIT1JJWkVfUkVUUllfQ09VTlRfRk9SX1NFU1NJT04gPSAzOwogIGNvbm5lY3QuY29yZS5NQVhfQ1RJX0FVVEhfUkVUUllfQ09VTlQgPSAxMDsKICBjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgPSAwOwogIGNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQgPSBudWxsOwogIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBudWxsOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNlc3Npb25TdG9yYWdlS2V5cwogICAqLwogIGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndGFiX2lkJywKICAgICdhdXRob3JpemVfcmV0cnlfY291bnQnLAogIF0pOwoKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFRoaXMgZnVuY3Rpb24gd2FzIG9ubHkgbWVhbnQgZm9yIGludGVybmFsIHVzZS4gCiAgICogVGhlIG5hbWUgaXMgbWlzbGVhZGluZyBmb3Igd2hhdCBpdCBzaG91bGQgZG8uCiAgICogSW50ZXJuYWxseSB3ZSBoYXZlIHJlcGxhY2VkIGl0cyB1c2FnZSB3aXRoIGBnZXRMb2dpblVybGAuCiAgICovCiAgdmFyIGNyZWF0ZUxvZ2luVXJsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIHJlZGlyZWN0ID0gImh0dHBzOi8vbGlseS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS90YXcvYXV0aC9jb2RlIjsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWRpcmVjdCk7CiAKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgbG9nLndhcm4oIlRoZSBgYWxpYXNgIHBhcmFtIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZXhwZWN0ZWQgdG8gZnVuY3Rpb24gcHJvcGVybHkuIFBsZWFzZSB1c2UgYGNjcFVybGAgb3IgYGxvZ2luVXJsYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWF6b24tY29ubmVjdC9hbWF6b24tY29ubmVjdC1zdHJlYW1zL2Jsb2IvbWFzdGVyL1JFQURNRS5tZCNjb25uZWN0Y29yZWluaXRjY3AgZm9yIHZhbGlkIHBhcmFtZXRlcnMuIik7CiAgICAgIHJldHVybiBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVwbGFjZXMgYGNyZWF0ZUxvZ2luVXJsYCwgYXMgdGhhdCBmdW5jdGlvbidzIG5hbWUgd2FzIG1pc2xlYWRpbmcuCiAgICogVGhlIGBwYXJhbXMuYWxpYXNgIHBhcmFtZXRlciBpcyBkZXByZWNhdGVkLiBQbGVhc2UgcmVmcmFpbiBmcm9tIHVzaW5nIGl0LgogICAqLwogIHZhciBnZXRMb2dpblVybCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciByZWRpcmVjdCA9ICJodHRwczovL2xpbHkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGF3L2F1dGgvY29kZSI7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVkaXJlY3QpOwogICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICByZXR1cm4gcGFyYW1zLmxvZ2luVXJsCiAgICB9IGVsc2UgaWYgKHBhcmFtcy5hbGlhcykgewogICAgICBsb2cud2FybigiVGhlIGBhbGlhc2AgcGFyYW0gaXMgZGVwcmVjYXRlZCBhbmQgc2hvdWxkIG5vdCBiZSBleHBlY3RlZCB0byBmdW5jdGlvbiBwcm9wZXJseS4gUGxlYXNlIHVzZSBgY2NwVXJsYCBvciBgbG9naW5VcmxgLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FtYXpvbi1jb25uZWN0L2FtYXpvbi1jb25uZWN0LXN0cmVhbXMvYmxvYi9tYXN0ZXIvUkVBRE1FLm1kI2Nvbm5lY3Rjb3JlaW5pdGNjcCBmb3IgdmFsaWQgcGFyYW1ldGVycy4iKTsKICAgICAgcmV0dXJuIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTgogICAgICAgIC5yZXBsYWNlKCJ7YWxpYXN9IiwgcGFyYW1zLmFsaWFzKQogICAgICAgIC5yZXBsYWNlKCJ7Y2xpZW50X2lkfSIsIENMSUVOVF9JRF9NQVBbInVzLWVhc3QtMSJdKQogICAgICAgIC5yZXBsYWNlKCJ7cmVkaXJlY3R9IiwgZ2xvYmFsLmVuY29kZVVSSUNvbXBvbmVudCgKICAgICAgICAgIHJlZGlyZWN0KSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcGFyYW1zLmNjcFVybDsKICAgIH0KICB9OwoKICAvKioKICAgKiBzb2Z0cGhvbmVQYXJhbXNTdG9yYWdlIG1vZHVsZSB0byBzdG9yZSBuZWNlc3Nhcnkgc29mdHBob25lIHBhcmFtcyBpbiBsb2NhbCBzdG9yYWdlCiAgICogVXNlZCBtYWlubHkgZm9yIGNhc2VzIHdoZXJlIGVtYmVkZGVkIENDUCBnZXRzIHJlZnJlc2hlZC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fQogICAqLwoKICB2YXIgc29mdHBob25lUGFyYW1zU3RvcmFnZSA9IChmdW5jdGlvbiAoKSB7CiAgICBsZXQga2V5ID0gYFNvZnRwaG9uZVBhcmFtc1N0b3JhZ2U6OiR7Z2xvYmFsLmxvY2F0aW9uLm9yaWdpbn1gOwogICAgcmV0dXJuIHsKICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFsdWUgJiYgZ2xvYmFsLmxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJTb2Z0cGhvbmVQYXJhbXNTdG9yYWdlOjogRmFpbGVkIHRvIHNldCBzb2Z0cGhvbmUgcGFyYW1zIHRvIGxvY2FsIHN0b3JhZ2UhIikKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0cnkgewogICAgICAgICAgbGV0IGl0ZW0gPSBnbG9iYWwubG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTsKICAgICAgICAgIHJldHVybiBpdGVtICYmIEpTT04ucGFyc2UoaXRlbSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiU29mdHBob25lUGFyYW1zU3RvcmFnZTo6IEZhaWxlZCB0byBnZXQgc29mdHBob25lIHBhcmFtcyBmcm9tIGxvY2FsIHN0b3JhZ2UhIikKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCgogICAgICBjbGVhbjogZnVuY3Rpb24gKCkgewogICAgICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogICAgICB9CiAgICB9CiAgfSkoKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogUmV0dXJucyBzY2hlbWU6Ly9ob3N0OnBvcnQgZm9yIGEgZ2l2ZW4gdXJsCiAgKi8KICBmdW5jdGlvbiBzYW5pdGl6ZURvbWFpbih1cmwpIHsKICAgIHZhciBkb21haW4gPSB1cmwubWF0Y2goL14oPzpodHRwcz86XC9cLyk/KD86W15AXG5dK0ApPyg/Ond3d1wuKT8oW146XC9cbj9dKykvaWcpOwogICAgcmV0dXJuIGRvbWFpbi5sZW5ndGggPyBkb21haW5bMF0gOiAiIjsKICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIFByaW50IGEgd2FybmluZyBtZXNzYWdlIGlmIHRoZSBDb25uZWN0IGNvcmUgaXMgbm90IGluaXRpYWxpemVkLgogICAgKi8KICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICAgIGxvZy53YXJuKCJDb25uZWN0IGNvcmUgYWxyZWFkeSBpbml0aWFsaXplZCwgb25seSBuZWVkcyB0byBiZSBpbml0aWFsaXplZCBvbmNlLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKIAogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogRElTQVNURVIgUkVDT1ZFUlkgCiAgKi8KICAKICB2YXIgbWFrZUFnZW50T2ZmbGluZSA9IGZ1bmN0aW9uKGFnZW50LCBjYWxsYmFja3MpIHsKICAgIHZhciBvZmZsaW5lU3RhdGUgPSBhZ2VudC5nZXRBZ2VudFN0YXRlcygpLmZpbmQoZnVuY3Rpb24gKHN0YXRlKSB7CiAgICAgIHJldHVybiBzdGF0ZS50eXBlID09PSBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk9GRkxJTkU7CiAgICB9KTsKICAgIGFnZW50LnNldFN0YXRlKG9mZmxpbmVTdGF0ZSwgY2FsbGJhY2tzKTsgICAKICB9CiAKICAvLyBTdXBwcmVzcyBDb250YWN0cyBmdW5jdGlvbiAKICAvLyBUaGlzIGlzIHVzZWQgYnkgRGlzYXN0ZXIgUmVjb3ZlcnkgYXMgYSBzYWZlZ3VhcmQgdG8gbm90IHN1cmZhY2UgaW5jb21pbmcgY2FsbHMvY2hhdHMgdG8gVUkKICAvLyAKICB2YXIgc3VwcHJlc3NDb250YWN0cyA9IGZ1bmN0aW9uIChpc1N1cHByZXNzZWQpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTaWduYWwgc2hhcmVkd29ya2VyIHRvIHNldCBjb250YWN0cyBzdXBwcmVzc29yIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgaXNTdXBwcmVzc2VkLCBjb25uZWN0LmNvcmUucmVnaW9uCiAgICApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNVUFBSRVNTLCB7CiAgICAgIHN1cHByZXNzOiBpc1N1cHByZXNzZWQKICAgIH0pOwogIH0KIAogIHZhciBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbSA9IGZ1bmN0aW9uKG9mZmxpbmUpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW0RJU0FTVEVSIFJFQ09WRVJZXSBTaWduYWwgc2hhcmVkd29ya2VyIHRvIHNldCBmb3JjZU9mZmxpbmUgdG8gJXMgZm9yIGluc3RhbmNlICVzLiIsIAogICAgICBvZmZsaW5lLCBjb25uZWN0LmNvcmUucmVnaW9uCiAgICApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIHsKICAgICAgb2ZmbGluZTogb2ZmbGluZQogICAgfSk7CiAgfQogCiAgLy8gRm9yY2UgdGhlIGluc3RhbmNlIHRvIGJlIG9mZmxpbmUuIAogIC8vIFRoaXMgdHJpZXMgdG8gZGlzY29ubmVjdCBhbGwgY29udGFjdHMgKEhhcmQgc3RvcCkKICAvLyBpZiBkdWUgdG8gYSBmYWlsdXJlICh0aGUgYmFja2VuZCBpcyBub3QgcmVhY2hhYmxlKSwgc2lnbmFsIHRoZSBzaGFyZWQgd29ya2VyIHRvIGZvcmNlX29mZmxpbmUgd2hlbiBpdCB3YWtlcyB1cCBhZ2FpbgogIC8vIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgcmFuIGZyb20gbmF0aXZlIENDUCBmb3IgZGlzY29ubmVjdGluZyBjaGF0cy4KICB2YXIgZm9yY2VPZmZsaW5lID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgbG9nID0gY29ubmVjdC5nZXRMb2coKTsKICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEF0dGVtcHRpbmcgdG8gZm9yY2UgaW5zdGFuY2UgJXMgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uKGFnZW50KSB7CiAgICAgIHZhciBjb250YWN0Q2xvc2VkID0gMDsKICAgICAgdmFyIGNvbnRhY3RzID0gYWdlbnQuZ2V0Q29udGFjdHMoKTsKICAgICAgaWYgKGNvbnRhY3RzLmxlbmd0aCkgewogICAgICAgIGNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24oY29udGFjdCkgCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuZGVzdHJveSh7CiAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiBhbGwgYWN0aXZlIGNvbnRhY3RzIGFyZSBjbG9zZWQKICAgICAgICAgICAgICAgIGlmICgrK2NvbnRhY3RDbG9zZWQgPT09IGNvbnRhY3RzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbShmYWxzZSk7CiAgICAgICAgICAgICAgICAgIC8vIEl0J3Mgb2sgaWYgd2UncmUgbm90IGFibGUgdG8gcHV0IHRoZSBhZ2VudCBvZmZsaW5lLiAKICAgICAgICAgICAgICAgICAgLy8gc2luY2Ugd2UncmUgc3VwcHJlc3NpbmcgdGhlIGFnZW50cyBjb250YWN0cyBhbHJlYWR5LiAKICAgICAgICAgICAgICAgICAgbWFrZUFnZW50T2ZmbGluZShhZ2VudCk7CiAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluc3RhbmNlICVzIGlzIG5vdyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgICAgbG9nLndhcm4oIltEaXNhc3RlciBSZWNvdmVyeV0gQW4gZXJyb3Igb2NjdXJlZCB3aGlsZSBhdHRlbXB0aW5nIHRvIGZvcmNlIHRoaXMgaW5zdGFuY2UgdG8gb2ZmbGluZSBpbiByZWdpb24gJXMiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgbG9nLndhcm4oZXJyKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgLy8gc2lnbmFsIHRoZSBzaGFyZWR3b3JrZXIgdG8gY2FsbCBmb3JjZU9mZmxpbmUgYWdhaW4gd2hlbiBuZXR3b3JrIGNvbm5lY3Rpb24gCiAgICAgICAgICAgICAgICAvLyBoYXMgYmVlbiByZS1lc3RhYmxpc2hlZCAodGhpcyBoYXBwZW5zIGluIGNhc2Ugb2YgbmV0d29yayBvciBiYWNrZW5kIGZhaWx1cmVzKQogICAgICAgICAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0odHJ1ZSk7CiAgICAgICAgICAgIH19KTsKICAgICAgICAgIH0KICAgICAgICApICAgICAgICAKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRGb3JjZU9mZmxpbmVVcHN0cmVhbShmYWxzZSk7CiAgICAgICAgbWFrZUFnZW50T2ZmbGluZShhZ2VudCk7CiAgICAgICAgbG9nLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gSW5zdGFuY2UgJXMgaXMgbm93IG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICB9CiAKICAvL0luaXRpYXRlIERpc2FzdGVyIFJlY292ZXJ5IChUaGlzIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBmcm9tIGN1c3RvbUNDUCB0aGF0IGFyZSBEUiBlbmFibGVkKQogIGNvbm5lY3QuY29yZS5pbml0RGlzYXN0ZXJSZWNvdmVyeSA9IGZ1bmN0aW9uKHBhcmFtcykgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBjb25uZWN0LmNvcmUucmVnaW9uID0gcGFyYW1zLnJlZ2lvbjsKICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzID0gc3VwcHJlc3NDb250YWN0czsgIAogICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSA9IGZvcmNlT2ZmbGluZTsKCiAgICAvL1JlZ2lzdGVyIGlmcmFtZSBsaXN0bmVyIHRvIHNldCBuYXRpdmUgQ0NQIG9mZmxpbmUKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuU0VUX09GRkxJTkUsIGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICB9KTsKIAogICAgLy8gUmVnaXN0ZXIgRXZlbnQgbGlzdG5lciB0byBGb3JjZSB0aGUgQWdlbnQgdG8gYmUgb2ZmbGluZSB3aGVuIHNoYXJlZCB3b3JrZXIgcmVjb3ZlcnMgZnJvbSBuZXR3b3JrIGZhaWx1cmUKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICB9KTsKCiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluaXRpYWxpemluZyByZWdpb24gJXMgYXMgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwgCiAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGFscmVhZHkgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CgogICAgaWYgKCFwYXJhbXMuaXNQcmltYXJ5KSB7CiAgICAgIGNvbm5lY3QuY29yZS5zdXBwcmVzc0NvbnRhY3RzKHRydWUpOwogICAgICBjb25uZWN0LmNvcmUuZm9yY2VPZmZsaW5lKCk7CiAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGluc3RhbmNlIGlzIHNldCB0byBzdGFuZC1ieSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyhmYWxzZSk7CiAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldICVzIGluc3RhbmNlIGlzIHNldCB0byBwcmltYXJ5IiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogQmFzaWMgQ29ubmVjdCBjbGllbnQgaW5pdGlhbGl6YXRpb24uCiAgICogU2hvdWxkIGJlIHVzZWQgb25seSBieSB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdFRhc2tUZW1wbGF0ZXNDbGllbnQocGFyYW1zKTsKICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IHRydWU7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplZCBBV1MgY2xpZW50CiAgICogU2hvdWxkIGJlIHVzZWQgYnkgU2hhcmVkIFdvcmtlciB0byB1cGRhdGUgQVdTIGNsaWVudCB3aXRoIG5ldyBjcmVkZW50aWFscwogICAqIGFmdGVyIHJlZnJlc2hlZCBhdXRoZW50aWNhdGlvbi4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENsaWVudCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKICAgIAogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIHJlZ2lvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMucmVnaW9uLCAncGFyYW1zLnJlZ2lvbicpOwogICAgdmFyIGVuZHBvaW50ID0gcGFyYW1zLmVuZHBvaW50IHx8IG51bGw7CiAKICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5BV1NDbGllbnQoYXV0aFRva2VuLCByZWdpb24sIGVuZHBvaW50KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgQWdlbnRBcHAgY2xpZW50CiAgICogU2hvdWxkIGJlIHVzZWQgYnkgU2hhcmVkIFdvcmtlciB0byB1cGRhdGUgQWdlbnRBcHAgY2xpZW50IHdpdGggbmV3IGNyZWRlbnRpYWxzCiAgICogYWZ0ZXIgcmVmcmVzaGVkIGF1dGhlbnRpY2F0aW9uLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7ICAgIAogICAgdmFyIGF1dGhUb2tlbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuLCAncGFyYW1zLmF1dGhUb2tlbicpOwogICAgdmFyIGF1dGhDb29raWVOYW1lID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoQ29va2llTmFtZSwgJ3BhcmFtcy5hdXRoQ29va2llTmFtZScpOwogICAgdmFyIGVuZHBvaW50ID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hZ2VudEFwcEVuZHBvaW50LCAncGFyYW1zLmFnZW50QXBwRW5kcG9pbnQnKTsKICAgIAogICAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbmV3IGNvbm5lY3QuQWdlbnRBcHBDbGllbnQoYXV0aENvb2tpZU5hbWUsIGF1dGhUb2tlbiwgZW5kcG9pbnQpOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplZCBUYXNrVGVtcGxhdGVzIGNsaWVudAogICAqLwogIGNvbm5lY3QuY29yZS5pbml0VGFza1RlbXBsYXRlc0NsaWVudCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICdwYXJhbXMnKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy50YXNrVGVtcGxhdGVzRW5kcG9pbnQgfHwgcGFyYW1zLmVuZHBvaW50OwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAndGFza1RlbXBsYXRlc0VuZHBvaW50Jyk7CiAgICBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCA9IG5ldyBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnQoZW5kcG9pbnQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVW5pbml0aWFsaXplIENvbm5lY3QuCiAgICovCiAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCA9IG5ldyBjb25uZWN0Lk51bGxDbGllbnQoKTsKICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBpZiAoYnVzKSBidXMudW5zdWJzY3JpYmVBbGwoKTsKICAgIGNvbm5lY3QuY29yZS5idXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbnVsbDsKICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gZmFsc2U7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSBmYWxzZTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFNldHVwIHRoZSBTb2Z0cGhvbmVNYW5hZ2VyIHRvIGJlIGluaXRpYWxpemVkIHdoZW4gdGhlIGFnZW50CiAgICogaXMgZGV0ZXJtaW5lZCB0byBoYXZlIHNvZnRwaG9uZSBlbmFibGVkLgogICAqLwogIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBudWxsOwogCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtOwogIH07CiAKICBjb25uZWN0LmNvcmUuc2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gZnVuY3Rpb24gKHN0cmVhbSkgewogICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IHN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLmluaXRSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAicGFyYW1zIik7CiAKICAgIHZhciBzZXR1cFJpbmd0b25lRW5naW5lcyA9IGZ1bmN0aW9uIChyaW5ndG9uZVNldHRpbmdzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZVNldHRpbmdzLCAicmluZ3RvbmVTZXR0aW5ncyIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy52b2ljZSwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UiKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnZvaWNlLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjaywgInJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2siKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgfHwgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCwgInJpbmd0b25lU2V0dGluZ3Mudm9pY2UucmluZ3RvbmVVcmwgbXVzdCBiZSBwcm92aWRlZCBvciByaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkIG11c3QgYmUgdHJ1ZSIpOwogCiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMgPSB7fTsKIAogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgIGFnZW50Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlJJTkdUT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy52b2ljZSkgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVm9pY2VSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlKTsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlZvaWNlUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5jaGF0LmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLmNoYXQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLmNoYXQgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuQ2hhdFJpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MuY2hhdCk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDaGF0UmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy50YXNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2spIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnRhc2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuVGFza1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MudGFzayk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlRhc2tSaW5ndG9uZUVuZ2luZSBpbml0aWFsaXplZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAKICAgICAgICAgICAgaWYgKCFyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkICYmICFjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnF1ZXVlX2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjayA9CiAgICAgICAgICAgICAgICBuZXcgY29ubmVjdC5RdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjayk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgaGFuZGxlUmluZ2VyRGV2aWNlQ2hhbmdlKCk7CiAgICB9OwogCiAgICB2YXIgbWVyZ2VQYXJhbXMgPSBmdW5jdGlvbiAocGFyYW1zLCBvdGhlclBhcmFtcykgewogICAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHk6IHN1cHBvcnQgcHVsbGluZyBkaXNhYmxlZCBmbGFnIGFuZCByaW5ndG9uZVVybAogICAgICAvLyBmcm9tIHNvZnRwaG9uZSBjb25maWcgaWYgaXQgZXhpc3RzIGZyb20gZG93bnN0cmVhbSBpbnRvIHRoZSByaW5ndG9uZSBjb25maWcuCiAgICAgIHBhcmFtcy5yaW5ndG9uZSA9IHBhcmFtcy5yaW5ndG9uZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gcGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0ID0gcGFyYW1zLnJpbmd0b25lLmNoYXQgfHwgeyBkaXNhYmxlZDogdHJ1ZSB9OwogICAgICBwYXJhbXMucmluZ3RvbmUudGFzayA9IHBhcmFtcy5yaW5ndG9uZS50YXNrIHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKIAogICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lKSB7CiAgICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZS5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2suZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmwpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZS5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjay5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLnNvZnRwaG9uZS5yaW5ndG9uZVVybDsKICAgICAgICB9CiAgICAgIH0KIAogICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdCkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LmRpc2FibGVSaW5ndG9uZSkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIH0KIAogICAgICAgIGlmIChvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdC5yaW5ndG9uZVVybCA9IG90aGVyUGFyYW1zLmNoYXQucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgLy8gTWVyZ2UgaW4gcmluZ3RvbmUgc2V0dGluZ3MgZnJvbSBkb3duc3RyZWFtLgogICAgICBpZiAob3RoZXJQYXJhbXMucmluZ3RvbmUpIHsKICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS52b2ljZSwKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5xdWV1ZV9jYWxsYmFjaywKICAgICAgICAgIG90aGVyUGFyYW1zLnJpbmd0b25lLnZvaWNlIHx8IHt9KTsKICAgICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnJpbmd0b25lLmNoYXQsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHt9KTsKICAgICAgfQogICAgfTsKIAogICAgLy8gTWVyZ2UgcGFyYW1zIGZyb20gcGFyYW1zLnNvZnRwaG9uZSBhbmQgcGFyYW1zLmNoYXQgaW50byBwYXJhbXMucmluZ3RvbmUKICAgIC8vIGZvciBlbWJlZGRlZCBhbmQgbm9uLWVtYmVkZGVkIHVzZSBjYXNlcyBzbyB0aGF0IGRlZmF1bHRzIGFyZSBwaWNrZWQgdXAuCiAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIHBhcmFtcyk7CiAKICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgLy8gSWYgdGhlIENDUCBpcyBpbiBhIGZyYW1lLCB3YWl0IGZvciBjb25maWd1cmF0aW9uIGZyb20gZG93bnN0cmVhbS4KICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgLy8gTWVyZ2UgYWxsIHBhcmFtcyBmcm9tIGRhdGEgaW50byBwYXJhbXMgZm9yIGFueSBvdmVycmlkZGVuCiAgICAgICAgLy8gdmFsdWVzIGluIGVpdGhlciBsZWdhY3kgInNvZnRwaG9uZSIgb3IgInJpbmd0b25lIiBzZXR0aW5ncy4KICAgICAgICBtZXJnZVBhcmFtcyhwYXJhbXMsIGRhdGEpOwogICAgICAgIHNldHVwUmluZ3RvbmVFbmdpbmVzKHBhcmFtcy5yaW5ndG9uZSk7CiAgICAgIH0pOwogCiAgICB9IGVsc2UgewogICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgfQogIH07CgogIHZhciBoYW5kbGVSaW5nZXJEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9SSU5HRVJfREVWSUNFLCBzZXRSaW5nZXJEZXZpY2UpOwogIH0KCiAgdmFyIHNldFJpbmdlckRldmljZSA9IGZ1bmN0aW9uIChkYXRhKXsKICAgIGlmKGNvbm5lY3Qua2V5cyhjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzKS5sZW5ndGggPT09IDAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgZm9yICh2YXIgcmluZ3RvbmVUeXBlIGluIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMpIHsKICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lc1tyaW5ndG9uZVR5cGVdLnNldE91dHB1dERldmljZShkZXZpY2VJZCk7CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICBjb25uZWN0LmNvcmUuaW5pdFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBpbml0U29mdHBob25lTWFuYWdlciBzdGFydGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB2YXIgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUgPSBmdW5jdGlvbiAoc29mdHBob25lUGFyYW1zSW4pIHsKICAgICAgdmFyIHNvZnRwaG9uZVBhcmFtcyA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnNvZnRwaG9uZSB8fCB7fSwgc29mdHBob25lUGFyYW1zSW4pOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgIGlmICghYWdlbnQuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5KGNvbm5lY3QuQ2hhbm5lbFR5cGUuVk9JQ0UpKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGFnZW50Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgc3ViID0gdGhpczsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBhZ2VudCByZWZyZXNoIGhhbmRsZXIgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogCiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gY29uZmlybWVkIGFzIHNvZnRwaG9uZSBtYXN0ZXIgdG9waWMiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICBpZiAoIWNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyICYmIGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpKSB7CiAgICAgICAgICAgICAgLy8gQmVjb21lIG1hc3RlciB0byBzZW5kIGxvZ3MsIHNpbmNlIHdlIG5lZWQgbG9ncyBmcm9tIHNvZnRwaG9uZSB0YWIuCiAgICAgICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIoc29mdHBob25lUGFyYW1zKTsKICAgICAgICAgICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfTsKCiAgICAvKioKICAgICAgKiBJZiB0aGUgd2luZG93IGlzIGZyYW1lZCBhbmQgaWYgaXQncyB0aGUgQ0NQIGFwcCB0aGVuIHdlIG5lZWQgdG8gd2FpdCBmb3IgYSBDT05GSUdVUkUgbWVzc2FnZSBmcm9tIGRvd25zdHJlYW0gYmVmb3JlIHdlIGluaXRpYWxpemUgc29mdHBob25lIG1hbmFnZXIuCiAgICAgICogQWxsIG1lZGlhbGVzcyBzb2Z0cGhvbmUgaW5pdGlhbGl6YXRpb24gY2FzZXMgZ29lcyB0byBlbHNlIGNoZWNrIGFuZCBkb2Vzbid0IHdhaXQgZm9yIENPTkZJR1VSRSBtZXNzYWdlCiAgICAgKi8KICAgIAogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiBjb25uZWN0LmlzQ0NQKCkpIHsKICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gQ29uZmlndXJlIGV2ZW50IGhhbmRsZXIgZXhlY3V0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIC8vIGFsd2F5cyBvdmVyd3JpdGUvc3RvcmUgdGhlIHNvZnRwaG9uZSBwYXJhbXMgdmFsdWUgaWYgdGhlcmUgaXMgYSBjb25maWd1cmUgZXZlbnQKICAgICAgICBzb2Z0cGhvbmVQYXJhbXNTdG9yYWdlLnNldChkYXRhLnNvZnRwaG9uZSk7CiAgICAgICAgaWYgKGRhdGEuc29mdHBob25lICYmIGRhdGEuc29mdHBob25lLmFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZShkYXRhLnNvZnRwaG9uZSk7CiAgICAgICAgfQogICAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChkYXRhLnNvZnRwaG9uZSk7CiAgICAgIH0pOwoKICAgICAgLyoqCiAgICAgICAqIFRoaXMgaXMgdGhlIGNhc2Ugd2hlcmUgQ0NQIGlzIGp1c3QgcmVmcmVzaGVkIGFmdGVyIGl0IGdldHMgaW5pdGlsYWl6ZWQgdmlhIGluaXRDQ1AKICAgICAgICogVGhpcyBzbmlwcGV0IG5lZWRzIGF0bGVhc3Qgb25lIGluaXRDQ1AgaW52b2NhdGlvbiB3aGljaCBzZXRzIHRoZSBwYXJhbXMgdG8gdGhlIHN0b3JlCiAgICAgICAqLwogICAgICBpZiAoIWNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyKSB7CiAgICAgICAgbGV0IHNvZnRwaG9uZVBhcmFtc0Zyb21Mb2NhbFN0b3JhZ2UgPSBzb2Z0cGhvbmVQYXJhbXNTdG9yYWdlLmdldCgpOyAKICAgICAgICBpZihzb2Z0cGhvbmVQYXJhbXNGcm9tTG9jYWxTdG9yYWdlKXsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBFbWJlZGRlZCBDQ1AgaXMgcmVmcmVzaGVkIHdpdGhvdXQgaW5pdENDUCBjYWxsIGFuZCBzbyBwaWNraW5nIGFsbG93RnJhbWVkU29mdHBob25lIHZhbHVlIGZyb20gbG9jYWxTdG9yYWdlIHdoaWNoIGlzIHNldCB0byAgIiArIHNvZnRwaG9uZVBhcmFtc0Zyb21Mb2NhbFN0b3JhZ2UuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICBuYW1lOiAiRW1iZWRkZWRDQ1BSZWZyZXNoZWRXaXRob3V0SW5pdENDUCIsCiAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IDEgfQogICAgICAgICAgfSk7CiAgICAgICAgfSAKICAgICAgICBpZiAoc29mdHBob25lUGFyYW1zRnJvbUxvY2FsU3RvcmFnZSAmJiBzb2Z0cGhvbmVQYXJhbXNGcm9tTG9jYWxTdG9yYWdlLmFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gSW5pdCBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZSBmcm9tIGxvY2FsU3RvcmFnZSBzb2Z0cGhvbmUgcGFyYW1zIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKHNvZnRwaG9uZVBhcmFtc0Zyb21Mb2NhbFN0b3JhZ2UpOwogICAgICAgIH0gZWxzZSBpZiAoc29mdHBob25lUGFyYW1zRnJvbUxvY2FsU3RvcmFnZSkgewogICAgICAgICAgc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KHNvZnRwaG9uZVBhcmFtc0Zyb21Mb2NhbFN0b3JhZ2UpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY29tcGV0ZUZvck1hc3Rlck9uQWdlbnRVcGRhdGUocGFyYW1zKTsKICAgICAgc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KHBhcmFtcyk7CiAgICB9CgogICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgLy8gU3luYyBtdXRlIGFjcm9zcyBhbGwgdGFicyAKICAgICAgaWYgKGFnZW50LmlzU29mdHBob25lRW5hYmxlZCgpICYmIGFnZW50LmdldENoYW5uZWxDb25jdXJyZW5jeShjb25uZWN0LkNoYW5uZWxUeXBlLlZPSUNFKSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFCiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgZnVuY3Rpb24gc2V0dXBFdmVudExpc3RlbmVyc0Zvck11bHRpVGFiVXNlSW5GaXJlZm94KHNvZnRwaG9uZVBhcmFtc0luKSB7CiAgICAgIHZhciBzb2Z0cGhvbmVQYXJhbXMgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5zb2Z0cGhvbmUgfHwge30sIHNvZnRwaG9uZVBhcmFtc0luKTsKCiAgICAgIC8vIGtlZXAgdGhlIHNvZnRwaG9uZSBwYXJhbXMgZm9yIGV4dGVybmFsIHVzZQogICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zID0gc29mdHBob25lUGFyYW1zOwoKICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpKSB7CiAgICAgICAgLy8gSW4gRmlyZWZveCwgd2hlbiBhIHRhYiB0YWtlcyBvdmVyIGFub3RoZXIgdGFiJ3Mgc29mdHBob25lIHByaW1hcnksCiAgICAgICAgLy8gdGhlIHByZXZpb3VzIHByaW1hcnkgdGFiIHNob3VsZCBkZWxldGUgc29mcGhvbmUgbWFuYWdlciBhbmQgc3RvcCBtaWNyb3Bob25lCiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMuZGF0YSAmJiByZXMuZGF0YS50b3BpYyA9PT0gY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FICYmIHJlcy5kYXRhLnRha2VPdmVyICYmIChyZXMuZGF0YS5tYXN0ZXJJZCAhPT0gY29ubmVjdC5jb3JlLnBvcnRTdHJlYW1JZCkpIHsKICAgICAgICAgICAgaWYgKGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIub25Jbml0Q29udGFjdFN1Yi51bnN1YnNjcmliZSgpOwogICAgICAgICAgICAgIGRlbGV0ZSBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdXNlck1lZGlhU3RyZWFtID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpOwogICAgICAgICAgICBpZiAodXNlck1lZGlhU3RyZWFtKSB7CiAgICAgICAgICAgICAgdXNlck1lZGlhU3RyZWFtLmdldFRyYWNrcygpLmZvckVhY2goZnVuY3Rpb24odHJhY2spIHsgdHJhY2suc3RvcCgpOyB9KTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIEluIEZpcmVmb3gsIHdoZW4gbXVsdGlwbGUgdGFicyBhcmUgb3BlbiwKICAgICAgICAvLyB3ZWJydGMgc2Vzc2lvbiBpcyBub3Qgc3RhcnRlZCB1bnRpbCBSRUFEWV9UT19TVEFSVF9TRVNTSU9OIGV2ZW50IGlzIHRyaWdnZXJlZAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIuc3RhcnRTZXNzaW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICAgICAgICAgIGlmICghY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgJiYgYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkpIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyKHNvZnRwaG9uZVBhcmFtcyk7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyLnN0YXJ0U2Vzc2lvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAvLyBoYW5kbGluZyBvdXRib3VuZC1jYWxsIGFuZCBhdXRvLWFjY2VwdCBjYXNlcyBmb3IgcGVuZGluZyBzZXNzaW9uCiAgICAgICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgICAgICBjLm9uUmVmcmVzaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzKCkgJiYKICAgICAgICAgICAgICAgIGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gJ3Zpc2libGUnICYmCiAgICAgICAgICAgICAgICAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgfHwgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIGlzT3V0Qm91bmRDYWxsID0gY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiAhY29udGFjdC5pc0luYm91bmQoKTsKICAgICAgICAgICAgICAgIHZhciBpc0F1dG9BY2NlcHRFbmFibGVkID0gY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiBhZ2VudC5nZXRDb25maWd1cmF0aW9uKCkuc29mdHBob25lQXV0b0FjY2VwdDsKICAgICAgICAgICAgICAgIHZhciBpc1F1ZXVlZENhbGxiYWNrID0gY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuUVVFVUVfQ0FMTEJBQ0s7CiAgICAgICAgICAgICAgICBpZiAoaXNPdXRCb3VuZENhbGwgfHwgaXNBdXRvQWNjZXB0RW5hYmxlZCB8fCBpc1F1ZXVlZENhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKCiAgLy8gdHJpZ2dlciBSRUFEWV9UT19TVEFSVF9TRVNTSU9OIGV2ZW50IGluIGEgY29udGV4dCB3aXRoIFNvZnRwaG9uZSBNYW5hZ2VyCiAgLy8gaW50ZXJuYWwgdXNlIG9ubHkKICBjb25uZWN0LmNvcmUudHJpZ2dlclJlYWR5VG9TdGFydFNlc3Npb25FdmVudCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhbGxvd0ZyYW1lZFNvZnRwaG9uZSA9IGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMgJiYgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcy5hbGxvd0ZyYW1lZFNvZnRwaG9uZTsKICAgIGlmIChjb25uZWN0LmlzQ0NQKCkpIHsKICAgICAgaWYgKGFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgLy8gdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBpbiB0aGlzIGlmcmFtZWQgQ0NQIGNvbnRleHQKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgICAgICAvLyBpZiB0aGlzIGlzIGFuIGlmcmFtZWQgQ0NQLCB0aGUgZXZlbnQgaXMgc2VuZCB0byBkb3duc3RyZWFtIChDUk0pCiAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kRG93bnN0cmVhbShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGlmIHRoaXMgaXMgYSBzdGFuZGFsb25lIENDUCwgdHJpZ2dlciB0aGlzIGV2ZW50IGluIHRoaXMgQ0NQIGNvbnRleHQKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgICAgLy8gdGhlIGV2ZW50IGlzIHNlbmQgdG8gdGhlIHVwc3RyZWFtIChpZnJhbWVkIENDUCkKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgaW4gdGhpcyBDUk0gY29udGV4dAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICB9CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb3JlLmluaXRQYWdlT3B0aW9ucyA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMsICJwYXJhbXMiKTsKICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgLy8gSWYgdGhlIENDUCBpcyBpbiBhIGZyYW1lLCB3YWl0IGZvciBjb25maWd1cmF0aW9uIGZyb20gZG93bnN0cmVhbS4KICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULAogICAgICAgICAgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLkNPTkZJR1VSRSwKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICAvLyBMaXN0ZW4gZm9yIGlmcmFtZSBtZWRpYSBkZXZpY2VzIHJlcXVlc3QgZnJvbSBDUk0KICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVRVUVTVCwgZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIHNlbmREZXZpY2VzKGRldmljZXMpIHsKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVNQT05TRSwgZGV2aWNlcyk7CiAgICAgICAgfQogICAgICAgIGlmIChuYXZpZ2F0b3IgJiYgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcykgewogICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKCkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkZXZpY2VzSW4pIHsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXNJbiB8fCBbXTsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXMubWFwKGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQudG9KU09OKCkgfSk7CiAgICAgICAgICAgIHNlbmREZXZpY2VzKGRldmljZXMpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIHNlbmREZXZpY2VzKHtlcnJvcjogZXJyLm1lc3NhZ2V9KTsKICAgICAgICAgIH0pOyAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VuZERldmljZXMoe2Vycm9yOiAiTm8gbmF2aWdhdG9yIG9yIG5hdmlnYXRvci5tZWRpYURldmljZXMgb2JqZWN0IGZvdW5kIn0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEdldCB0aGUgbGlzdCBvZiBtZWRpYSBkZXZpY2VzIGZyb20gaWZyYW1lZCBDQ1AKICAgKiBUaW1lb3V0IGZvciB0aGUgcmVxdWVzdCBpcyBwYXNzZWQgYW4gYW4gb3B0aW9uYWwgYXJndW1lbnQKICAgKiBUaGUgZGVmYXVsdCB0aW1lb3V0IGlzIDEwMDBtcwogICAqLwogIGNvbm5lY3QuY29yZS5nZXRGcmFtZU1lZGlhRGV2aWNlcyA9IGZ1bmN0aW9uICh0aW1lb3V0SW4pIHsKICAgIHZhciBzdWIgPSBudWxsOwogICAgdmFyIHRpbWVvdXQgPSB0aW1lb3V0SW4gfHwgMTAwMDsKICAgIHZhciB0aW1lb3V0UHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IAogICAgICAgIHJlamVjdChuZXcgRXJyb3IoIlRpbWVvdXQgZXhjZWVkZWQiKSk7IAogICAgICB9LCB0aW1lb3V0KTsKICAgIH0pOwogICAgdmFyIG1lZGlhRGV2aWNlc1Byb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7IAogICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpIHx8IGNvbm5lY3QuaXNDQ1AoKSkgewogICAgICAgIGlmIChuYXZpZ2F0b3IgJiYgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcykgewogICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKCkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkZXZpY2VzSW4pIHsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXNJbiB8fCBbXTsKICAgICAgICAgICAgZGV2aWNlcyA9IGRldmljZXMubWFwKGZ1bmN0aW9uIChkKSB7IHJldHVybiBkLnRvSlNPTigpIH0pOwogICAgICAgICAgICByZXNvbHZlKGRldmljZXMpOwogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoIk5vIG5hdmlnYXRvciBvciBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzIG9iamVjdCBmb3VuZCIpKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgICAgIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFU1BPTlNFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEuZXJyb3IpIHsKICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihkYXRhLmVycm9yKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVRVUVTVCk7CiAgICAgIH0KICAgIH0pCiAgICByZXR1cm4gUHJvbWlzZS5yYWNlKFttZWRpYURldmljZXNQcm9taXNlLCB0aW1lb3V0UHJvbWlzZV0pCiAgICAuZmluYWxseShmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChzdWIpIHsKICAgICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvL0ludGVybmFsIHVzZSBvbmx5LgogIGNvbm5lY3QuY29yZS5hdXRob3JpemUgPSBmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgIHZhciBvcHRpb25zID0gewogICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnCiAgICB9OwoKICAgIHZhciBhdXRob3JpemVFbmRwb2ludCA9IGVuZHBvaW50OwogICAgaWYgKCFhdXRob3JpemVFbmRwb2ludCkgewogICAgICBhdXRob3JpemVFbmRwb2ludCA9IGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbigpCiAgICAgICAgPyBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UCiAgICAgICAgOiBBVVRIT1JJWkVfRU5EUE9JTlQ7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5mZXRjaChhdXRob3JpemVFbmRwb2ludCwgb3B0aW9ucywgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMLCBBVVRIT1JJWkVfTUFYX1JFVFJZKTsKICB9OwogCiAgLyoqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBUaGlzIHVzZWQgdG8gYmUgdXNlZCBpbnRlcm5hbGx5LCBidXQgaXMgbm8gbG9uZ2VyIG5lZWRlZC4KICAgKi8KICBjb25uZWN0LmNvcmUudmVyaWZ5RG9tYWluQWNjZXNzID0gZnVuY3Rpb24gKGF1dGhUb2tlbiwgZW5kcG9pbnQpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhpcyBBUEkgd2lsbCBiZSBkZXByZWNhdGVkIGluIHRoZSBuZXh0IG1ham9yIHZlcnNpb24gcmVsZWFzZSIpOwogICAgaWYgKCFjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpOwogICAgfQogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIGhlYWRlcnM6IHsKICAgICAgICAnWC1BbXotQmVhcmVyJzogYXV0aFRva2VuCiAgICAgIH0KICAgIH07CiAgICB2YXIgd2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQgPSBudWxsOwogICAgaWYgKGVuZHBvaW50KXsKICAgICAgd2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQgPSBlbmRwb2ludDsKICAgIH0KICAgIGVsc2UgewogICAgICB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbigpIAogICAgICAgID8gTEVHQUNZX1dISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQKICAgICAgICA6IFdISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQ7CiAgICB9CiAgICAKICAgIHJldHVybiBjb25uZWN0LmZldGNoKHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50LCBvcHRpb25zLCBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMLCBXSElURUxJU1RFRF9PUklHSU5TX01BWF9SRVRSWSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgdmFyIHRvcERvbWFpbiA9IHNhbml0aXplRG9tYWluKHdpbmRvdy5kb2N1bWVudC5yZWZlcnJlcik7CiAgICAgIHZhciBpc0FsbG93ZWQgPSByZXNwb25zZS53aGl0ZWxpc3RlZE9yaWdpbnMuc29tZShmdW5jdGlvbiAob3JpZ2luKSB7CiAgICAgICAgcmV0dXJuIHRvcERvbWFpbiA9PT0gc2FuaXRpemVEb21haW4ob3JpZ2luKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBpc0FsbG93ZWQgPyBQcm9taXNlLnJlc29sdmUoKSA6IFByb21pc2UucmVqZWN0KCk7CiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogUmV0dXJucyB0cnVlIGlmIHRoaXMgd2luZG93J3MgaHJlZiBpcyBvbiB0aGUgbGVnYWN5IGNvbm5lY3QgZG9tYWluLiAKICAgKiBPbmx5IHVzZWZ1bCBmb3IgaW50ZXJuYWwgdXNlLiAKICAgKi8KICBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4gPSBmdW5jdGlvbih1cmwpIHsKICAgIHVybCA9IHVybCB8fCB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgIHJldHVybiB1cmwuaW5jbHVkZXMoJy5hd3NhcHBzLmNvbScpOwogIH0KIAoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZXMgQ29ubmVjdCBieSBjcmVhdGluZyBvciBjb25uZWN0aW5nIHRvIHRoZSBBUEkgU2hhcmVkIFdvcmtlci4KICAgKiBVc2VkIG9ubHkgYnkgdGhlIENDUAogICAqLwogIGNvbm5lY3QuY29yZS5pbml0U2hhcmVkV29ya2VyID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQoKTsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOwogCiAgICB2YXIgc2hhcmVkV29ya2VyVXJsID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5zaGFyZWRXb3JrZXJVcmwsICdwYXJhbXMuc2hhcmVkV29ya2VyVXJsJyk7CiAgICB2YXIgYXV0aFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW4sICdwYXJhbXMuYXV0aFRva2VuJyk7CiAgICB2YXIgcmVmcmVzaFRva2VuID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5yZWZyZXNoVG9rZW4sICdwYXJhbXMucmVmcmVzaFRva2VuJyk7CiAgICB2YXIgYXV0aFRva2VuRXhwaXJhdGlvbiA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aFRva2VuRXhwaXJhdGlvbiwgJ3BhcmFtcy5hdXRoVG9rZW5FeHBpcmF0aW9uJyk7CiAgICB2YXIgcmVnaW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5yZWdpb24sICdwYXJhbXMucmVnaW9uJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMuZW5kcG9pbnQgfHwgbnVsbDsKICAgIHZhciBhdXRob3JpemVFbmRwb2ludCA9IHBhcmFtcy5hdXRob3JpemVFbmRwb2ludDsKICAgIGlmICghYXV0aG9yaXplRW5kcG9pbnQpIHsKICAgICAgYXV0aG9yaXplRW5kcG9pbnQgPSBjb25uZWN0LmNvcmUuaXNMZWdhY3lEb21haW4oKQogICAgICAgID8gTEVHQUNZX0FVVEhPUklaRV9FTkRQT0lOVAogICAgICAgIDogQVVUSE9SSVpFX0VORFBPSU5UOwogICAgfQogICAgdmFyIGFnZW50QXBwRW5kcG9pbnQgPSBwYXJhbXMuYWdlbnRBcHBFbmRwb2ludCB8fCBudWxsOwogICAgdmFyIHRhc2tUZW1wbGF0ZXNFbmRwb2ludCA9IHBhcmFtcy50YXNrVGVtcGxhdGVzRW5kcG9pbnQgfHwgbnVsbDsKICAgIHZhciBhdXRoQ29va2llTmFtZSA9IHBhcmFtcy5hdXRoQ29va2llTmFtZSB8fCBudWxsOwogCiAgICB0cnkgewogICAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cyh7IGxvZ0V2ZW50czogdHJ1ZSB9KTsKICAgICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeSA9IG5ldyBjb25uZWN0Lk1lZGlhRmFjdG9yeShwYXJhbXMpOwogICAgICAKICAgICAgLy8gQ3JlYXRlIHRoZSBzaGFyZWQgd29ya2VyIGFuZCB1cHN0cmVhbSBjb25kdWl0LgogICAgICB2YXIgd29ya2VyID0gbmV3IFNoYXJlZFdvcmtlcihzaGFyZWRXb3JrZXJVcmwsICJDb25uZWN0U2hhcmVkV29ya2VyIik7CiAgICAgIHZhciBjb25kdWl0ID0gbmV3IGNvbm5lY3QuQ29uZHVpdCgiQ29ubmVjdFNoYXJlZFdvcmtlckNvbmR1aXQiLAogICAgICAgIG5ldyBjb25uZWN0LlBvcnRTdHJlYW0od29ya2VyLnBvcnQpLAogICAgICAgIG5ldyBjb25uZWN0LldpbmRvd0lPU3RyZWFtKHdpbmRvdywgcGFyZW50KSk7CiAKICAgICAgLy8gU2V0IHRoZSBnbG9iYWwgdXBzdHJlYW0gY29uZHVpdCBmb3IgZXh0ZXJuYWwgdXNlLgogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBjb25kdWl0OwogICAgICBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXIgPSBuZXcgV2ViU29ja2V0UHJvdmlkZXIoKTsKIAogICAgICAvLyBDbG9zZSBvdXIgcG9ydCB0byB0aGUgc2hhcmVkIHdvcmtlciBiZWZvcmUgdGhlIHdpbmRvdyBjbG9zZXMuCiAgICAgIGdsb2JhbC5vbnVubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DTE9TRSk7CiAgICAgICAgd29ya2VyLnBvcnQuY2xvc2UoKTsKICAgICAgfTsKIAogICAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoKGNvbmR1aXQpOwogICAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlRG93bnN0cmVhbUNsaWVudFNpZGVMb2dzUHVzaCgpOwogICAgICAvLyBCcmlkZ2UgYWxsIHVwc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKICAgICAgLy8gUGFzcyBhbGwgdXBzdHJlYW0gbWVzc2FnZXMgKGZyb20gc2hhcmVkIHdvcmtlcikgZG93bnN0cmVhbSAodG8gQ0NQIGNvbnN1bWVyKS4KICAgICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbmR1aXQucGFzc0Rvd25zdHJlYW0oKSk7CgogICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgICAgLy8gQnJpZGdlIGFsbCBkb3duc3RyZWFtIG1lc3NhZ2VzIGludG8gdGhlIGV2ZW50IGJ1cy4KICAgICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAgICAgICAgLy8gUGFzcyBhbGwgZG93bnN0cmVhbSBtZXNzYWdlcyAoZnJvbSBDQ1AgY29uc3VtZXIpIHVwc3RyZWFtICh0byBzaGFyZWQgd29ya2VyKS4KICAgICAgICBjb25kdWl0Lm9uQWxsRG93bnN0cmVhbShjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICAgfQoKICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBzaGFyZWQgd29ya2VyLgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIHsKICAgICAgICBhdXRoVG9rZW46IGF1dGhUb2tlbiwKICAgICAgICBhdXRoVG9rZW5FeHBpcmF0aW9uOiBhdXRoVG9rZW5FeHBpcmF0aW9uLAogICAgICAgIGVuZHBvaW50OiBlbmRwb2ludCwKICAgICAgICByZWZyZXNoVG9rZW46IHJlZnJlc2hUb2tlbiwKICAgICAgICByZWdpb246IHJlZ2lvbiwKICAgICAgICBhdXRob3JpemVFbmRwb2ludDogYXV0aG9yaXplRW5kcG9pbnQsCiAgICAgICAgYWdlbnRBcHBFbmRwb2ludDogYWdlbnRBcHBFbmRwb2ludCwKICAgICAgICB0YXNrVGVtcGxhdGVzRW5kcG9pbnQ6IHRhc2tUZW1wbGF0ZXNFbmRwb2ludCwKICAgICAgICBhdXRoQ29va2llTmFtZTogYXV0aENvb2tpZU5hbWUsCiAgICAgICAgbG9uZ1BvbGxpbmdPcHRpb25zOiBwYXJhbXMubG9uZ1BvbGxpbmdPcHRpb25zIHx8IHVuZGVmaW5lZAogICAgICB9KTsKIAogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENvbm5lY3RTaGFyZWRXb3JrZXIhIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgIGNvbm5lY3QuY29yZS5fc2V0VGFiSWQoKTsKICAgICAgICBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkID0gZGF0YS5pZDsKICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIH0pOwogICAgICAvLyBBZGQgYWxsIHVwc3RyZWFtIGxvZyBlbnRyaWVzIHRvIG91ciBvd24gbG9nZ2VyLgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgICBpZiAobG9nRW50cnkubG9nZ2VySWQgIT09IGNvbm5lY3QuZ2V0TG9nKCkuZ2V0TG9nZ2VySWQoKSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBHZXQgd29ya2VyIGxvZ3MKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlcihjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgfSk7CiAgICAgIC8vIEdldCBvdXRlciBjb250ZXh0IGxvZ3MKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgZnVuY3Rpb24gKGxvZ3MpIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmIEFycmF5LmlzQXJyYXkobG9ncykpIHsKICAgICAgICAgIGxvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlcihjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICAvLyBHZXQgbG9nIGZyb20gb3V0ZXIgY29udGV4dAogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2cpIHsKICAgICAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpICYmIGxvZy5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7IAogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nKSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGNvbm5lY3QuY29yZS5vbkF1dGhGYWlsKGNvbm5lY3QuaGl0Y2goY29ubmVjdC5jb3JlLCBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhGYWlsLCBwYXJhbXMubG9naW5FbmRwb2ludCB8fCBudWxsLCBhdXRob3JpemVFbmRwb2ludCkpOyAvLyBGb3IgYXV0aCByZXRyeSBsb2dpYyBvbiA0MDFzLgogICAgICBjb25uZWN0LmNvcmUub25BdXRob3JpemVTdWNjZXNzKGNvbm5lY3QuaGl0Y2goY29ubmVjdC5jb3JlLCBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZVN1Y2Nlc3MpKTsgLy8gRm9yIGF1dGggcmV0cnkgbG9naWMgb24gNDAxcy4KCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiVXNlciBBZ2VudDogIiArIG5hdmlnYXRvci51c2VyQWdlbnQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiaXNDQ1B2MjogIiArIHRydWUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiaXNGcmFtZWQ6ICIgKyBjb25uZWN0LmlzRnJhbWVkKCkpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbS5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuT1VURVJfQ09OVEVYVF9JTkZPLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciBzdHJlYW1zVmVyc2lvbiA9IGRhdGEuc3RyZWFtc1ZlcnNpb247CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTdHJlYW1zSlMgVmVyc2lvbjogIiArIHN0cmVhbXNWZXJzaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJOdW1iZXIgb2YgY29ubmVjdGVkIENDUHMgdXBkYXRlZDogIiArIGRhdGEubGVuZ3RoKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gZGF0YS5sZW5ndGg7CiAgICAgICAgaWYgKGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXSAmJiAhaXNOYU4oZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdLmxlbmd0aCkpewogICAgICAgICAgaWYgKGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiICE9PSBkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0ubGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID0gZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID4gMSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhlcmUgYXJlICIgKyBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiArICIgY29ubmVjdGVkIENDUHMgaW4gdGhpcyB0YWIuIFBsZWFzZSBhZGp1c3QgeW91ciBpbXBsZW1lbnRhdGlvbiB0byBhdm9pZCBjb21wbGljYXRpb25zLiBJZiB5b3UgYXJlIGVtYmVkZGluZyBDQ1AsIHBsZWFzZSBkbyBzbyBleGNsdXNpdmVseSB3aXRoIGluaXRDQ1AuIEluaXRDQ1Agd2lsbCBub3QgbGV0IHlvdSBlbWJlZCBtb3JlIHRoYW4gb25lIENDUC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgICAgbmFtZTogQ09OTkVDVEVEX0NDUFNfU0lOR0xFX1RBQiwKICAgICAgICAgICAgICBkYXRhOiB7IGNvdW50OiBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYn0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkYXRhLnRhYklkICYmIGRhdGEuc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLk1FVFJJQ1MsICgpID0+CiAgICAgICAgICAgIGNvbm5lY3QuYWdlbnQoKCkgPT4gY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgICBuYW1lOiBDQ1BfVEFCU19BQ1JPU1NfQlJPV1NFUl9DT1VOVCwKICAgICAgICAgICAgICBkYXRhOiB7IHRhYklkOiBkYXRhLnRhYklkLCBjb3VudDogZGF0YS5zdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgfQogICAgICAgICAgICB9KSkKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQoY29uZHVpdCk7CiAKICAgICAgLy8gUGFzcyB0aGUgVEVSTUlOQVRFIHJlcXVlc3QgdXBzdHJlYW0gdG8gdGhlIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEUsCiAgICAgICAgY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAKICAgICAgLy8gUmVmcmVzaCB0aGUgcGFnZSB3aGVuIHdlIHJlY2VpdmUgdGhlIFRFUk1JTkFURUQgcmVzcG9uc2UgZnJvbSB0aGUKICAgICAgLy8gc2hhcmVkIHdvcmtlci4KICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsIGZ1bmN0aW9uICgpIHsKICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKHRydWUpOwogICAgICB9KTsKIAogICAgICB3b3JrZXIucG9ydC5zdGFydCgpOwoKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEuZG9tYWluSWQpIHsKICAgICAgICAgIGNvbm5lY3QuY29yZS52b2ljZUlkRG9tYWluSWQgPSBkYXRhLmRvbWFpbklkOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyB0cnkgZmV0Y2hpbmcgdm9pY2VJZCdzIGRvbWFpbklkIG9uY2UgdGhlIGFnZW50IGlzIGluaXRpYWxpemVkCiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB2b2ljZUlkID0gbmV3IGNvbm5lY3QuVm9pY2VJZCgpOwogICAgICAgIHZvaWNlSWQuZ2V0RG9tYWluSWQoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJ2b2ljZUlkIGRvbWFpbklkIHN1Y2Nlc3NmdWxseSBmZXRjaGVkIGF0IGFnZW50IGluaXRpYWxpemF0aW9uOiAiICsgZG9tYWluSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInZvaWNlSWQgZG9tYWluSWQgbm90IGZldGNoZWQgYXQgYWdlbnQgaW5pdGlhbGl6YXRpb24iKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIH0pOwogICAgICB9KTsKIAogICAgICAvLyBBdHRlbXB0IHRvIGdldCBwZXJtaXNzaW9uIHRvIHNob3cgbm90aWZpY2F0aW9ucy4KICAgICAgdmFyIG5tID0gY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgICAgbm0ucmVxdWVzdFBlcm1pc3Npb24oKTsKIAogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXREaXNhc3RlclJlY292ZXJ5KHBhcmFtcyk7CiAgICAgIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBpbml0aWFsaXplIHRoZSBBUEkgc2hhcmVkIHdvcmtlciwgd2UncmUgZGVhZCEiKQogICAgICAgIC53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb3JlLl9zZXRUYWJJZCA9IGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgY29ubmVjdC5jb3JlLnRhYklkID0gd2luZG93LnNlc3Npb25TdG9yYWdlLmdldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuVEFCX0lEKTsKICAgICAgaWYgKCFjb25uZWN0LmNvcmUudGFiSWQpewogICAgICAgIGNvbm5lY3QuY29yZS50YWJJZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5UQUJfSUQsIGNvbm5lY3QuY29yZS50YWJJZCk7CiAgICAgIH0KICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5UQUJfSUQsIHt0YWJJZDogY29ubmVjdC5jb3JlLnRhYklkfSk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiW1RhYiBJZF0gVGhlcmUgd2FzIGFuIGlzc3VlIHNldHRpbmcgdGhlIHRhYiBJZCIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZXMgQ29ubmVjdCBieSBjcmVhdGluZyBvciBjb25uZWN0aW5nIHRvIHRoZSBBUEkgU2hhcmVkIFdvcmtlci4KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGxvYWRpbmcgdGhlIENDUCBpbiBhbiBpZnJhbWUgYW5kIGNvbm5lY3RpbmcgdG8gaXQuCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRDQ1AgPSBmdW5jdGlvbiAoY29udGFpbmVyRGl2LCBwYXJhbXNJbikgewogICAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQoKTsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJJZnJhbWUgaW5pdGlhbGl6YXRpb24gc3RhcnRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgaW5pdFN0YXJ0VGltZSA9IERhdGUubm93KCk7CiAgICAvLyBDaGVjayBpZiBDQ1AgaWZyYW1lIGhhcyBhbHJlYWR5IGJlZW4gaW5pdGlhbGl6ZWQgdGhyb3VnaCBpbml0Q0NQCiAgICB0cnkgewogICAgICBpZiAoY29ubmVjdC5jb3JlLl9nZXRDQ1BJZnJhbWUoKSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignQXR0ZW1wdGVkIHRvIGNhbGwgaW5pdENDUCB3aGVuIGFuIGlmcmFtZSBnZW5lcmF0ZWQgYnkgaW5pdENDUCBhbHJlYWR5IGV4aXN0cycpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoJ0Vycm9yIHdoaWxlIGNoZWNraW5nIGlmIGluaXRDQ1AgaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQnKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAKICAgIC8vIEZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgd2hlbiBpbnN0ZWFkIG9mIHRha2luZyBhIHBhcmFtcyBvYmplY3QKICAgIC8vIGFzIGlucHV0IHdlIG9ubHkgYWNjZXB0ZWQgY2NwVXJsLgogICAgdmFyIHBhcmFtcyA9IHt9OwogICAgaWYgKHR5cGVvZiAocGFyYW1zSW4pID09PSAnc3RyaW5nJykgewogICAgICBwYXJhbXMuY2NwVXJsID0gcGFyYW1zSW47CiAgICB9IGVsc2UgewogICAgICBwYXJhbXMgPSBwYXJhbXNJbjsKICAgIH0KIAogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5jY3BVcmwsICdwYXJhbXMuY2NwVXJsJyk7CgogICAgLy8gQ2xlYW4gdXAgdGhlIFNvZnRwaG9uZSBwYXJhbXMgc3RvcmUgdG8gbWFrZSBzdXJlIHdlIGFsd2F5cyBwdWxsIHRoZSBsYXRlc3QgcGFyYW1zCiAgICBzb2Z0cGhvbmVQYXJhbXNTdG9yYWdlLmNsZWFuKCk7CiAKICAgIC8vIENyZWF0ZSB0aGUgQ0NQIGlmcmFtZSBhbmQgYXBwZW5kIGl0IHRvIHRoZSBjb250YWluZXIgZGl2LgogICAgdmFyIGlmcmFtZSA9IGNvbm5lY3QuY29yZS5fY3JlYXRlQ0NQSWZyYW1lKGNvbnRhaW5lckRpdiwgcGFyYW1zKTsKCiAgICAvLyBJbml0aWFsaXplIHRoZSBldmVudCBidXMgYW5kIGFnZW50IGRhdGEgcHJvdmlkZXJzLgogICAgLy8gTk9URTogU2V0dGluZyBsb2dFdmVudHMgaGVyZSB0byBGQUxTRSBpbiBvcmRlciB0byBhdm9pZCBkdXBsaWNhdGluZwogICAgLy8gZXZlbnRzIHdoaWNoIGFyZSBsb2dnZWQgaW4gQ0NQLgogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoeyBsb2dFdmVudHM6IGZhbHNlIH0pOwogICAgY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyID0gbmV3IEFnZW50RGF0YVByb3ZpZGVyKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpKTsKICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkgPSBuZXcgY29ubmVjdC5NZWRpYUZhY3RvcnkocGFyYW1zKTsKIAogICAgLy8gQnVpbGQgdGhlIHVwc3RyZWFtIGNvbmR1aXQgY29tbXVuaWNhdGluZyB3aXRoIHRoZSBDQ1AgaWZyYW1lLgogICAgdmFyIGNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KHBhcmFtcy5jY3BVcmwsIHdpbmRvdywgaWZyYW1lKTsKIAogICAgLy8gTGV0IENDUCBrbm93IGlmIGlmcmFtZSBpcyB2aXNpYmxlCiAgICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lKGlmcmFtZSwgY29uZHVpdCk7CiAKICAgIC8vIFNldCB0aGUgZ2xvYmFsIHVwc3RyZWFtIGNvbmR1aXQgZm9yIGV4dGVybmFsIHVzZS4KICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IGNvbmR1aXQ7CiAKICAgIC8vIEluaXQgd2ViU29ja2V0UHJvdmlkZXIKICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogCiAgICAvLyBJbml0aWFsaXplIHRoZSBrZWVwYWxpdmUgbWFuYWdlci4KICAgIGNvbm5lY3QuY29yZS5rZWVwYWxpdmVNYW5hZ2VyID0gbmV3IEtlZXBhbGl2ZU1hbmFnZXIoY29uZHVpdCwKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCksCiAgICAgIHBhcmFtcy5jY3BTeW5UaW1lb3V0IHx8IENDUF9TWU5fVElNRU9VVCwKICAgICAgcGFyYW1zLmNjcEFja1RpbWVvdXQgfHwgQ0NQX0FDS19USU1FT1VUKQogICAgICA7CiAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPSBudWxsOwogCiAgICAvLyBBbGxvdyA1IHNlYyAoZGVmYXVsdCkgYmVmb3JlIHJlY2VpdmluZyB0aGUgZmlyc3QgQUNLIGZyb20gdGhlIENDUC4KICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IG51bGw7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQpOwogICAgfSwgcGFyYW1zLmNjcExvYWRUaW1lb3V0IHx8IENDUF9MT0FEX1RJTUVPVVQpOwoKICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUExvZ3NQdXNoKGNvbmR1aXQpOwogICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzUHVzaChjb25kdWl0KTsKIAogICAgLy8gT25jZSB3ZSByZWNlaXZlIHRoZSBmaXJzdCBBQ0ssIHNldHVwIG91ciB1cHN0cmVhbSBBUEkgY2xpZW50IGFuZCBlc3RhYmxpc2gKICAgIC8vIHRoZSBTWU4vQUNLIHJlZnJlc2ggZmxvdy4KICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBY2tub3dsZWRnZWQgYnkgdGhlIENDUCEiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0Q2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50KGNvbmR1aXQpOwogICAgICBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkID0gZGF0YS5pZDsKCiAgICAgIGlmIChwYXJhbXMuc29mdHBob25lIHx8IHBhcmFtcy5jaGF0IHx8IHBhcmFtcy5wYWdlT3B0aW9ucyB8fCBwYXJhbXMuc2hvdWxkQWRkTmFtZXNwYWNlVG9Mb2dzKSB7CiAgICAgICAgLy8gU2VuZCBjb25maWd1cmF0aW9uIHVwIHRvIHRoZSBDQ1AuCiAgICAgICAgLy9zZXQgaXQgdG8gZmFsc2UgaWYgc2Vjb25kYXJ5CiAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCB7CiAgICAgICAgICBzb2Z0cGhvbmU6IHBhcmFtcy5zb2Z0cGhvbmUsCiAgICAgICAgICBjaGF0OiBwYXJhbXMuY2hhdCwKICAgICAgICAgIHBhZ2VPcHRpb25zOiBwYXJhbXMucGFnZU9wdGlvbnMsCiAgICAgICAgICBzaG91bGRBZGROYW1lc3BhY2VUb0xvZ3M6IHBhcmFtcy5zaG91bGRBZGROYW1lc3BhY2VUb0xvZ3MsCiAgICAgICAgfSk7CiAgICAgIH0KIAogICAgICAvLyBJZiBEUiBlbmFibGVkLCBzZXQgdGhpcyBDQ1AgaW5zdGFuY2UgYXMgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0CiAgICAgIGlmIChwYXJhbXMuZGlzYXN0ZXJSZWNvdmVyeU9uKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLnJlZ2lvbiA9IHBhcmFtcy5yZWdpb247CiAgICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMgPSBzdXBwcmVzc0NvbnRhY3RzOwogICAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TRVRfT0ZGTElORSk7CiAgICAgICAgfSAgICAgICAKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgcGFyYW1zKTsKICAgICAgfQogCiAgICAgIGlmIChjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSkgewogICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgICAgfQoKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuT1VURVJfQ09OVEVYVF9JTkZPLCB7IHN0cmVhbXNWZXJzaW9uOiBjb25uZWN0LnZlcnNpb24gfSk7CiAKICAgICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIuc3RhcnQoKTsKICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwoKICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5JTklUKTsKICAgICAgaWYgKGluaXRTdGFydFRpbWUpIHsKICAgICAgICB2YXIgaW5pdFRpbWUgPSBEYXRlLm5vdygpIC0gaW5pdFN0YXJ0VGltZTsKICAgICAgICB2YXIgcmVmcmVzaEF0dGVtcHRzID0gY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDA7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCdJZnJhbWUgaW5pdGlhbGl6YXRpb24gc3VjY2VlZGVkJykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYElmcmFtZSBpbml0aWFsaXphdGlvbiB0aW1lICR7aW5pdFRpbWV9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYElmcmFtZSByZWZyZXNoIGF0dGVtcHRzICR7cmVmcmVzaEF0dGVtcHRzfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX1JFRlJFU0hfQVRURU1QVFMsCiAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IHJlZnJlc2hBdHRlbXB0c30gCiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUywKICAgICAgICAgICAgZGF0YTogeyBjb3VudDogMX0gCiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fVElNRSwKICAgICAgICAgICAgZGF0YTogeyBjb3VudDogaW5pdFRpbWV9IAogICAgICAgICAgfSk7CiAgICAgICAgICAvL3RvIGF2b2lkIG1ldHJpYyBlbWlzc2lvbiBhZnRlciBpbml0aWFsaXphdGlvbgogICAgICAgICAgaW5pdFN0YXJ0VGltZSA9IG51bGw7CiAgICAgICAgfSwxMDAwKQogICAgICB9CiAgICB9KTsKIAogICAgLy8gQWRkIGFueSBsb2dzIGZyb20gdGhlIHVwc3RyZWFtIHRvIG91ciBvd24gbG9nZ2VyLgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgIGlmIChsb2dFbnRyeS5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgfQogICAgfSk7CiAKICAgIC8vIFBvcCBhIGxvZ2luIHBhZ2Ugd2hlbiB3ZSBlbmNvdW50ZXIgYW4gQUNLIHRpbWVvdXQuCiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQsIGZ1bmN0aW9uICgpIHsKICAgICAgLy8gbG9naW5Qb3B1cCBpcyB0cnVlIGJ5IGRlZmF1bHQsIG9ubHkgZmFsc2UgaWYgZXhwbGljaXRseSBzZXQgdG8gZmFsc2UuCiAgICAgIGlmIChwYXJhbXMubG9naW5Qb3B1cCAhPT0gZmFsc2UpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGxvZ2luVXJsID0gZ2V0TG9naW5VcmwocGFyYW1zKTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiQUNLX1RJTUVPVVQgb2NjdXJyZWQsIGF0dGVtcHRpbmcgdG8gcG9wIHRoZSBsb2dpbiBwYWdlIGlmIG5vdCBhbHJlYWR5IG9wZW4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIC8vIGNsZWFyIG91dCBsYXN0IG9wZW5lZCB0aW1lc3RhbXAgZm9yIFNBTUwgYXV0aGVudGljYXRpb24gd2hlbiB0aGVyZSBpcyBBQ0tfVElNRU9VVAogICAgICAgICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkuY2xlYXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogICAgICAgICAgfQogICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93ID0gY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLm9wZW4obG9naW5VcmwsIGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQLCBwYXJhbXMubG9naW5PcHRpb25zKTsKIAogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkFDS19USU1FT1VUIG9jY3VycmVkIGJ1dCB3ZSBhcmUgdW5hYmxlIHRvIG9wZW4gdGhlIGxvZ2luIHBvcHVwLiIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPT0gbnVsbCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCk7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICAgIGlmICgocGFyYW1zLmxvZ2luUG9wdXBBdXRvQ2xvc2UgfHwgKHBhcmFtcy5sb2dpbk9wdGlvbnMgJiYgcGFyYW1zLmxvZ2luT3B0aW9ucy5hdXRvQ2xvc2UpKSAmJiBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cuY2xvc2UoKTsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbm5lY3QuY29yZS5fcmVmcmVzaElmcmFtZU9uVGltZW91dChwYXJhbXMsIGNvbnRhaW5lckRpdik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRXJyb3Igb2NjdXJyZWQgd2hpbGUgcmVmcmVzaGluZyBpZnJhbWUiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKIAogICAgaWYgKHBhcmFtcy5vblZpZXdDb250YWN0KSB7CiAgICAgIGNvbm5lY3QuY29yZS5vblZpZXdDb250YWN0KHBhcmFtcy5vblZpZXdDb250YWN0KTsKICAgIH0KCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA9IGRhdGEubGVuZ3RoOwogICAgfSk7CgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAoZGF0YSAmJiBkYXRhLmRvbWFpbklkKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCA9IGRhdGEuZG9tYWluSWQ7CiAgICAgIH0KICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfUkVUUklFU19FWEhBVVNURUQsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGluaXRTdGFydFRpbWUpIHsKICAgICAgICB2YXIgcmVmcmVzaEF0dGVtcHRzID0gY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IC0gMTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oJ0lmcmFtZSBpbml0aWFsaXphdGlvbiBmYWlsZWQnKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgVGltZSBhZnRlciBpZnJhbWUgaW5pdGlhbGl6YXRpb24gc3RhcnRlZCAke0RhdGUubm93KCkgLSBpbml0U3RhcnRUaW1lfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBJZnJhbWUgcmVmcmVzaCBhdHRlbXB0cyAke3JlZnJlc2hBdHRlbXB0c31gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX1JFRlJFU0hfQVRURU1QVFMsCiAgICAgICAgICBkYXRhOiB7IGNvdW50OiByZWZyZXNoQXR0ZW1wdHN9CiAgICAgICAgfSk7CiAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUywKICAgICAgICAgIGRhdGE6IHsgY291bnQ6IDB9CiAgICAgICAgfSk7CiAgICAgICAgaW5pdFN0YXJ0VGltZSA9IG51bGw7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIGtlZXAgdGhlIHNvZnRwaG9uZSBwYXJhbXMgZm9yIGV4dGVybmFsIHVzZQogICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyA9IHBhcmFtcy5zb2Z0cGhvbmU7CiAgfTsKCiAgY29ubmVjdC5jb3JlLm9uSWZyYW1lUmV0cmllc0V4aGF1c3RlZCA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfUkVUUklFU19FWEhBVVNURUQsIGYpOwogIH0KCiAgY29ubmVjdC5jb3JlLl9yZWZyZXNoSWZyYW1lT25UaW1lb3V0ID0gZnVuY3Rpb24oaW5pdENDUFBhcmFtcywgY29udGFpbmVyRGl2KSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaW5pdENDUFBhcmFtcywgJ2luaXRDQ1BQYXJhbXMnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWluZXJEaXYsICdjb250YWluZXJEaXYnKTsKICAgIHZhciBjY3BJZnJhbWVSZWZyZXNoSW50ZXJ2YWwgPSAoaW5pdENDUFBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pID8gQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMIDogQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMOwogICAgdmFyIHJldHJ5RGVsYXkgPSBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCB8fCAwLCB7IGJhc2U6IDIwMDAgfSk7CiAgICB2YXIgdGltZW91dCA9IGNjcElmcmFtZVJlZnJlc2hJbnRlcnZhbCArIHJldHJ5RGVsYXk7CiAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCk7CiAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0ID0gKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCB8fCAwKSArIDE7CiAgICAgIGlmIChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgPD0gQ0NQX0lGUkFNRV9SRUZSRVNIX0xJTUlUKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBpZnJhbWUgPSBjb25uZWN0LmNvcmUuX2dldENDUElmcmFtZSgpOwogICAgICAgICAgaWYgKGlmcmFtZSkgewogICAgICAgICAgICBpZnJhbWUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChpZnJhbWUpOyAvLyBUaGUgb25seSB3YXkgdG8gZm9yY2UgYSBzeW5jaHJvbm91cyByZWxvYWQgb2YgdGhlIGlmcmFtZSB3aXRob3V0IHRoZSBvbGQgaWZyYW1lIGNvbnRpbnVpbmcgdG8gZnVuY3Rpb24gaXMgdG8gcmVtb3ZlIHRoZSBvbGQgaWZyYW1lIGVudGlyZWx5LgogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0lmcmFtZSA9IGNvbm5lY3QuY29yZS5fY3JlYXRlQ0NQSWZyYW1lKGNvbnRhaW5lckRpdiwgaW5pdENDUFBhcmFtcyk7CiAgICAgICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0udXBzdHJlYW0ub3V0cHV0ID0gbmV3SWZyYW1lLmNvbnRlbnRXaW5kb3c7IC8vcmVwbGFjZXMgdGhlIG91dHB1dCB3aW5kb3cgKG9sZCBpZnJhbWUncyBjb250ZW50V2luZG93KSBvZiB0aGUgV2luZG93SU9TdHJlYW0gKHdpdGhpbiB0aGUgSUZyYW1lQ29uZHVpdCkgd2l0aCB0aGUgbmV3IGlmcmFtZSdzIGNvbnRlbnRXaW5kb3cuCiAgICAgICAgICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lKG5ld0lmcmFtZSwgY29ubmVjdC5jb3JlLnVwc3RyZWFtKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoJ0Vycm9yIHdoaWxlIGNoZWNraW5nIGZvciwgYW5kIHJlY3JlYXRpbmcsIHRoZSBDQ1AgSUZyYW1lJykud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgICBjb25uZWN0LmNvcmUuX3JlZnJlc2hJZnJhbWVPblRpbWVvdXQoaW5pdENDUFBhcmFtcywgY29udGFpbmVyRGl2KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9SRVRSSUVTX0VYSEFVU1RFRCk7CiAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQpOwogICAgICB9CiAgICB9LCB0aW1lb3V0KTsKICB9CgoKICBjb25uZWN0LmNvcmUuX2dldENDUElmcmFtZSA9IGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgaWZyYW1lIG9mIHdpbmRvdy5kb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaWZyYW1lJykpIHsKICAgICAgaWYgKGlmcmFtZS5uYW1lID09PSBDQ1BfSUZSQU1FX05BTUUpIHsKICAgICAgICByZXR1cm4gaWZyYW1lOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9CgogIGNvbm5lY3QuY29yZS5fY3JlYXRlQ0NQSWZyYW1lID0gZnVuY3Rpb24oY29udGFpbmVyRGl2LCBpbml0Q0NQUGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaW5pdENDUFBhcmFtcywgJ2luaXRDQ1BQYXJhbXMnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWluZXJEaXYsICdjb250YWluZXJEaXYnKTsKICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgIGlmcmFtZS5zcmMgPSBpbml0Q0NQUGFyYW1zLmNjcFVybDsKICAgIGlmcmFtZS5hbGxvdyA9ICJtaWNyb3Bob25lOyBhdXRvcGxheSI7CiAgICBpZnJhbWUuc3R5bGUgPSBpbml0Q0NQUGFyYW1zLnN0eWxlIHx8ICJ3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlIjsKICAgIGlmcmFtZS50aXRsZSA9IGluaXRDQ1BQYXJhbXMuaWZyYW1lVGl0bGUgfHwgQ0NQX0lGUkFNRV9OQU1FOwogICAgaWZyYW1lLm5hbWUgPSBDQ1BfSUZSQU1FX05BTUU7CiAgICBjb250YWluZXJEaXYuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgIHJldHVybiBpZnJhbWU7CiAgfQoKICBjb25uZWN0LmNvcmUuX3NlbmRJZnJhbWVTdHlsZURhdGFVcHN0cmVhbUFmdGVyUmVhc29uYWJsZVdhaXRUaW1lID0gZnVuY3Rpb24oaWZyYW1lLCBjb25kdWl0KSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWZyYW1lLCAnaWZyYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29uZHVpdCwgJ2NvbmR1aXQnKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGlmcmFtZSwgbnVsbCk7CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIGRpc3BsYXk6IHN0eWxlLmRpc3BsYXksCiAgICAgICAgb2Zmc2V0V2lkdGg6IGlmcmFtZS5vZmZzZXRXaWR0aCwKICAgICAgICBvZmZzZXRIZWlnaHQ6IGlmcmFtZS5vZmZzZXRIZWlnaHQsCiAgICAgICAgY2xpZW50UmVjdHNMZW5ndGg6IGlmcmFtZS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aAogICAgICB9OwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfU1RZTEUsIGRhdGEpOwogICAgfSwgMTAwMDApOwogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgS2VlcGFsaXZlTWFuYWdlciA9IGZ1bmN0aW9uIChjb25kdWl0LCBldmVudEJ1cywgc3luVGltZW91dCwgYWNrVGltZW91dCkgewogICAgdGhpcy5jb25kdWl0ID0gY29uZHVpdDsKICAgIHRoaXMuZXZlbnRCdXMgPSBldmVudEJ1czsKICAgIHRoaXMuc3luVGltZW91dCA9IHN5blRpbWVvdXQ7CiAgICB0aGlzLmFja1RpbWVvdXQgPSBhY2tUaW1lb3V0OwogICAgdGhpcy5hY2tUaW1lciA9IG51bGw7CiAgICB0aGlzLnN5blRpbWVyID0gbnVsbDsKICAgIHRoaXMuYWNrU3ViID0gbnVsbDsKICB9OwogCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAKICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUpOwogICAgdGhpcy5hY2tTdWIgPSB0aGlzLmNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoc2VsZi5hY2tUaW1lcik7CiAgICAgIHNlbGYuX2RlZmVyU3RhcnQoKTsKICAgIH0pOwogICAgdGhpcy5hY2tUaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5hY2tTdWIudW5zdWJzY3JpYmUoKTsKICAgICAgc2VsZi5ldmVudEJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VUKTsKICAgICAgc2VsZi5fZGVmZXJTdGFydCgpOwogICAgfSwgdGhpcy5hY2tUaW1lb3V0KTsKICB9OwoKICAvL0ZpeGVzIHRoZSBrZWVwYWxpdmVtYW5hZ2VyLgogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLl9kZWZlclN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zeW5UaW1lciA9IGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5zdGFydCksIHRoaXMuc3luVGltZW91dCk7CiAgfTsKCiAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IG9ubHksIGluIGNhc2UgY3VzdG9tZXJzIGFyZSB1c2luZyB0aGlzIHRvIHN0YXJ0IHRoZSBrZWVwYWxpdmVtYW5hZ2VyIGZvciBzb21lIHJlYXNvbi4KICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5kZWZlclN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuc3luVGltZXIgPT0gbnVsbCkgewogICAgICB0aGlzLnN5blRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnN0YXJ0KSwgdGhpcy5zeW5UaW1lb3V0KTsKICAgIH0KICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogCiAgdmFyIFdlYlNvY2tldFByb3ZpZGVyID0gZnVuY3Rpb24gKCkgewogCiAgICB2YXIgY2FsbGJhY2tzID0gewogICAgICBpbml0RmFpbHVyZTogbmV3IFNldCgpLAogICAgICBzdWJzY3JpcHRpb25VcGRhdGU6IG5ldyBTZXQoKSwKICAgICAgc3Vic2NyaXB0aW9uRmFpbHVyZTogbmV3IFNldCgpLAogICAgICB0b3BpYzogbmV3IE1hcCgpLAogICAgICBhbGxNZXNzYWdlOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25HYWluOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25Mb3N0OiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25PcGVuOiBuZXcgU2V0KCksCiAgICAgIGNvbm5lY3Rpb25DbG9zZTogbmV3IFNldCgpCiAgICB9OwogCiAgICB2YXIgaW52b2tlQ2FsbGJhY2tzID0gZnVuY3Rpb24gKGNhbGxiYWNrcywgcmVzcG9uc2UpIHsKICAgICAgY2FsbGJhY2tzLmZvckVhY2goZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2socmVzcG9uc2UpOwogICAgICB9KTsKICAgIH07CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFLCBmdW5jdGlvbiAoKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuaW5pdEZhaWx1cmUpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX09QRU4sIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLCByZXNwb25zZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fQ0xPU0UsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZSwgcmVzcG9uc2UpOwogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0dBSU4sIGZ1bmN0aW9uICgpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbik7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fTE9TVCwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9VUERBVEUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZSwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX0ZBSUxVUkUsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUsIHJlc3BvbnNlKTsKICAgIH0pOwogCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkFMTF9NRVNTQUdFLCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5hbGxNZXNzYWdlLCByZXNwb25zZSk7CiAgICAgIGlmIChjYWxsYmFja3MudG9waWMuaGFzKHJlc3BvbnNlLnRvcGljKSkgewogICAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MudG9waWMuZ2V0KHJlc3BvbnNlLnRvcGljKSwgcmVzcG9uc2UpOwogICAgICB9CiAgICB9KTsKIAogICAgdGhpcy5zZW5kTWVzc2FnZSA9IGZ1bmN0aW9uICh3ZWJTb2NrZXRQYXlsb2FkKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TRU5ELCB3ZWJTb2NrZXRQYXlsb2FkKTsKICAgIH07CiAKICAgIHRoaXMub25Jbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmluaXRGYWlsdXJlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5pbml0RmFpbHVyZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbk9wZW4gPSBmdW5jdGlvbihjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uT3Blbi5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkNsb3NlID0gZnVuY3Rpb24oY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uQ2xvc2UuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKCiAgICB0aGlzLm9uQ29ubmVjdGlvbkdhaW4gPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbi5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkdhaW4uZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25Db25uZWN0aW9uTG9zdCA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdC5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vblN1YnNjcmlwdGlvblVwZGF0ZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvblVwZGF0ZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uU3Vic2NyaXB0aW9uRmFpbHVyZSA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMuc3Vic2NyaWJlVG9waWNzID0gZnVuY3Rpb24gKHRvcGljcykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWNzLCAndG9waWNzJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzQXJyYXkodG9waWNzKSwgJ3RvcGljcyBtdXN0IGJlIGEgYXJyYXknKTsKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklCRSwgdG9waWNzKTsKICAgIH07CiAKICAgIHRoaXMub25NZXNzYWdlID0gZnVuY3Rpb24gKHRvcGljTmFtZSwgY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljTmFtZSwgJ3RvcGljTmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgaWYgKGNhbGxiYWNrcy50b3BpYy5oYXModG9waWNOYW1lKSkgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5nZXQodG9waWNOYW1lKS5hZGQoY2IpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy50b3BpYy5zZXQodG9waWNOYW1lLCBuZXcgU2V0KFtjYl0pKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MudG9waWMuZ2V0KHRvcGljTmFtZSkuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25BbGxNZXNzYWdlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuYWxsTWVzc2FnZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuYWxsTWVzc2FnZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIEFnZW50RGF0YVByb3ZpZGVyID0gZnVuY3Rpb24gKGJ1cykgewogICAgdmFyIGFnZW50RGF0YSA9IG51bGw7CiAgICB0aGlzLmJ1cyA9IGJ1czsKICAgIHRoaXMuYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnVwZGF0ZUFnZW50RGF0YSkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUudXBkYXRlQWdlbnREYXRhID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgdmFyIG9sZEFnZW50RGF0YSA9IHRoaXMuYWdlbnREYXRhOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAKICAgIGlmIChvbGRBZ2VudERhdGEgPT0gbnVsbCkgewogICAgICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgfQogCiAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAKICAgIHRoaXMuX2ZpcmVBZ2VudFVwZGF0ZUV2ZW50cyhvbGRBZ2VudERhdGEpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0QWdlbnREYXRhID0gZnVuY3Rpb24gKCkgewogICAgaWYgKHRoaXMuYWdlbnREYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignTm8gYWdlbnQgZGF0YSBpcyBhdmFpbGFibGUgeWV0IScpOwogICAgfQogCiAgICByZXR1cm4gdGhpcy5hZ2VudERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb250YWN0RGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHZhciBhZ2VudERhdGEgPSB0aGlzLmdldEFnZW50RGF0YSgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5maW5kKGFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGN0ZGF0YSkgewogICAgICByZXR1cm4gY3RkYXRhLmNvbnRhY3RJZCA9PT0gY29udGFjdElkOwogICAgfSk7CiAKICAgIGlmIChjb250YWN0RGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0NvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb250YWN0SWQpOwogICAgfQogCiAgICByZXR1cm4gY29udGFjdERhdGE7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRDb25uZWN0aW9uRGF0YSA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdmFyIGNvbnRhY3REYXRhID0gdGhpcy5nZXRDb250YWN0RGF0YShjb250YWN0SWQpOwogICAgdmFyIGNvbm5lY3Rpb25EYXRhID0gY29ubmVjdC5maW5kKGNvbnRhY3REYXRhLmNvbm5lY3Rpb25zLCBmdW5jdGlvbiAoY2RhdGEpIHsKICAgICAgcmV0dXJuIGNkYXRhLmNvbm5lY3Rpb25JZCA9PT0gY29ubmVjdGlvbklkOwogICAgfSk7CiAKICAgIGlmIChjb25uZWN0aW9uRGF0YSA9PSBudWxsKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ0Nvbm5lY3Rpb24gJXMgZm9yIGNvbnRhY3QgJXMgbm8gbG9uZ2VyIGV4aXN0cy4nLCBjb25uZWN0aW9uSWQsIGNvbnRhY3RJZCk7CiAgICB9CiAKICAgIHJldHVybiBjb25uZWN0aW9uRGF0YTsKICB9OwoKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuZ2V0SW5zdGFuY2VJZCA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gdGhpcy5nZXRBZ2VudERhdGEoKS5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQubWF0Y2goL2luc3RhbmNlXC8oWzAtOWEtZkEtRnwtXSspXC8vKVsxXTsKICB9CgogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRBV1NBY2NvdW50SWQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuZ2V0QWdlbnREYXRhKCkuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUlkLm1hdGNoKC86KFswLTldKyk6aW5zdGFuY2UvKVsxXTsKICB9CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2RpZmZDb250YWN0cyA9IGZ1bmN0aW9uIChvbGRBZ2VudERhdGEpIHsKICAgIHZhciBkaWZmID0gewogICAgICBhZGRlZDoge30sCiAgICAgIHJlbW92ZWQ6IHt9LAogICAgICBjb21tb246IHt9LAogICAgICBvbGRNYXA6IGNvbm5lY3QuaW5kZXgob2xkQWdlbnREYXRhID09IG51bGwgPyBbXSA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICB9OwogCiAgICBjb25uZWN0LmtleXMoZGlmZi5vbGRNYXApLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgICBpZiAoY29ubmVjdC5jb250YWlucyhkaWZmLm5ld01hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuY29tbW9uW2NvbnRhY3RJZF0gPSBkaWZmLm5ld01hcFtjb250YWN0SWRdOwogICAgICB9IGVsc2UgewogICAgICAgIGRpZmYucmVtb3ZlZFtjb250YWN0SWRdID0gZGlmZi5vbGRNYXBbY29udGFjdElkXTsKICAgICAgfQogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLm5ld01hcCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIGlmICghY29ubmVjdC5jb250YWlucyhkaWZmLm9sZE1hcCwgY29udGFjdElkKSkgewogICAgICAgIGRpZmYuYWRkZWRbY29udGFjdElkXSA9IGRpZmYubmV3TWFwW2NvbnRhY3RJZF07CiAgICAgIH0KICAgIH0pOwogCiAgICByZXR1cm4gZGlmZjsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9maXJlQWdlbnRVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAob2xkQWdlbnREYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZGlmZiA9IG51bGw7CiAgICB2YXIgb2xkQWdlbnRTdGF0ZSA9IG9sZEFnZW50RGF0YSA9PSBudWxsID8gY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzLklOSVQgOiBvbGRBZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBuZXdBZ2VudFN0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3Quc3RhdGUubmFtZTsKICAgIHZhciBvbGRSb3V0aW5nU3RhdGUgPSBvbGRBZ2VudERhdGEgPT0gbnVsbCA/IGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuSU5JVCA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS50eXBlOwogICAgdmFyIG5ld1JvdXRpbmdTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLnR5cGU7CiAKICAgIGlmIChvbGRSb3V0aW5nU3RhdGUgIT09IG5ld1JvdXRpbmdTdGF0ZSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRSb3V0aW5nRXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRSb3V0aW5nU3RhdGUsIG5ld1JvdXRpbmdTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CiAKICAgIGlmIChvbGRBZ2VudFN0YXRlICE9PSBuZXdBZ2VudFN0YXRlKSB7CiAgICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIHsKICAgICAgICBhZ2VudDogbmV3IGNvbm5lY3QuQWdlbnQoKSwKICAgICAgICBvbGRTdGF0ZTogb2xkQWdlbnRTdGF0ZSwKICAgICAgICBuZXdTdGF0ZTogbmV3QWdlbnRTdGF0ZQogCiAgICAgIH0pOwogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGgoKS5nZXRBc3NvY2lhdGlvbnModGhpcywgb2xkQWdlbnRTdGF0ZSwgbmV3QWdlbnRTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIG9sZE5leHRTdGF0ZSA9IG9sZEFnZW50RGF0YSAmJiBvbGRBZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlID8gb2xkQWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZS5uYW1lIDogbnVsbDsKICAgIHZhciBuZXdOZXh0U3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUgPyB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUubmFtZSA6IG51bGw7CiAgICBpZiAob2xkTmV4dFN0YXRlICE9PSBuZXdOZXh0U3RhdGUgJiYgbmV3TmV4dFN0YXRlKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5FTlFVRVVFRF9ORVhUX1NUQVRFLCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KCiAgICBpZiAob2xkQWdlbnREYXRhICE9PSBudWxsKSB7CiAgICAgIGRpZmYgPSB0aGlzLl9kaWZmQ29udGFjdHMob2xkQWdlbnREYXRhKTsKIAogICAgfSBlbHNlIHsKICAgICAgZGlmZiA9IHsKICAgICAgICBhZGRlZDogY29ubmVjdC5pbmRleCh0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5jb250YWN0cywgZnVuY3Rpb24gKGNvbnRhY3QpIHsgcmV0dXJuIGNvbnRhY3QuY29udGFjdElkOyB9KSwKICAgICAgICByZW1vdmVkOiB7fSwKICAgICAgICBjb21tb246IHt9LAogICAgICAgIG9sZE1hcDoge30sCiAgICAgICAgbmV3TWFwOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pCiAgICAgIH07CiAgICB9CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYuYWRkZWQpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdERhdGEuY29udGFjdElkKSk7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3REYXRhLmNvbnRhY3RJZCwgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOSVQsIGNvbnRhY3REYXRhLnN0YXRlLnR5cGUpOwogICAgfSk7CiAKICAgIGNvbm5lY3QudmFsdWVzKGRpZmYucmVtb3ZlZCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVELCBjb250YWN0RGF0YS5jb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0U25hcHNob3QoY29udGFjdERhdGEpKTsKICAgICAgc2VsZi5fdW5zdWJBbGxDb250YWN0RXZlbnRzRm9yQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpOwogICAgfSk7CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLmNvbW1vbikuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIHNlbGYuX2ZpcmVDb250YWN0VXBkYXRlRXZlbnRzKGNvbnRhY3RJZCwgZGlmZi5vbGRNYXBbY29udGFjdElkXS5zdGF0ZS50eXBlLCBkaWZmLm5ld01hcFtjb250YWN0SWRdLnN0YXRlLnR5cGUpOwogICAgfSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMgPSBmdW5jdGlvbiAoY29udGFjdElkLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKG9sZENvbnRhY3RTdGF0ZSAhPT0gbmV3Q29udGFjdFN0YXRlKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRDb250YWN0U3RhdGUsIG5ld0NvbnRhY3RTdGF0ZSkuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICBzZWxmLmJ1cy50cmlnZ2VyKGV2ZW50LCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnQsIGNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICAgIH0pOwogICAgfQoKICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5SRUZSRVNILCBjb250YWN0SWQpLCBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkpOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX3Vuc3ViQWxsQ29udGFjdEV2ZW50c0ZvckNvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RFdmVudHMpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgICBzZWxmLmJ1cy5nZXRTdWJzY3JpcHRpb25zKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgY29udGFjdElkKSkKICAgICAgICAubWFwKGZ1bmN0aW9uIChzdWIpIHsgc3ViLnVuc3Vic2NyaWJlKCk7IH0pOwogICAgfSk7CiAgfTsKIAogIC8qKiAtLS0tLSBtaW5pbWFsIHZpZXcgbGF5ZXIgZXZlbnQgaGFuZGxpbmcgKiovCiAKICBjb25uZWN0LmNvcmUub25WaWV3Q29udGFjdCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5WSUVXLCBmKTsKICB9OwogCiAgLyoqCiAgICogVXNlZCBvZiBhZ2VudCBpbnRlcmZhY2UgY29udHJvbC4gCiAgICogY29ubmVjdC5jb3JlLnZpZXdDb250YWN0KCJjb250YWN0SWQiKSAtPiAgdGhpcyBpcyBjdXJlbnRseSBwcm9ncmFtbWVkIHRvIGdldCB0aGUgY29udGFjdCBpbnRvIHZpZXcuCiAgICovCiAgY29ubmVjdC5jb3JlLnZpZXdDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLlZJRVcsCiAgICAgIGRhdGE6IHsKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZAogICAgICB9CiAgICB9KTsKICB9OwoKICAvKiogLS0tLS0gbWluaW1hbCB2aWV3IGxheWVyIGV2ZW50IGhhbmRsaW5nICoqLwogCiAgY29ubmVjdC5jb3JlLm9uQWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cy5BQ1RJVkFURV9DSEFOTkVMX1dJVEhfVklFV19UWVBFLCBmKTsKICB9OwogCiAgLyoqCiAgICogVXNlZCBvZiBhZ2VudCBpbnRlcmZhY2UgY29udHJvbC4gCiAgICogY29ubmVjdC5jb3JlLmFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSgpIC0+ICB0aGlzIGlzIGN1cmVudGx5IHByb2dyYW1tZWQgdG8gZ2V0IGVpdGhlciB0aGUgbnVtYmVyIHBhZCwgcXVpY2sgY29ubmVjdHMsIG9yIGNyZWF0ZSB0YXNrIGludG8gdmlldy4KICAgKiB0aGUgdmFsaWQgY29tYmluYXRpb25zIGFyZSAoImNyZWF0ZV90YXNrIiwgInRhc2siKSwgKCJudW1iZXJfcGFkIiwgInNvZnRwaG9uZSIpLCAoImNyZWF0ZV90YXNrIiwgInNvZnRwaG9uZSIpLCAoInF1aWNrX2Nvbm5lY3RzIiwgInNvZnRwaG9uZSIpCiAgICogdGhlIHNvZnRwaG9uZSB3aXRoIGNyZWF0ZV90YXNrIGNvbWJvIGlzIGEgc3BlY2lhbCBjYXNlIGluIHRoZSBjaGFubmVsIHZpZXcgdG8gYWxsb3cgYWxsIHRocmVlIHZpZXcgdHlwZSBidXR0b25zIHRvIGFwcGVhciBvbiB0aGUgc29mdHBob25lIHNjcmVlbgogICAqCiAgICogVGhlICdzb3VyY2UnIGlzIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB3aGljaCBpbmRpY2F0ZXMgdGhlIHJlcXVlc3Rlci4gRm9yIGV4YW1wbGUsIGlmIGludm9rZWQgd2l0aCAoImNyZWF0ZV90YXNrIiwgInRhc2siLCAiYWdlbnRhcHAiKSB3ZSB3b3VsZCBrbm93IGFnZW50YXBwIHJlcXVlc3RlZCBvcGVuIHRhc2sgdmlldy4KICAgKiAKICAgKiAiY2FzZUlkIiBpcyBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgd2hpY2ggaXMgcGFzc2VkIHdoZW4gYSB0YXNrIGlzIGNyZWF0ZWQgZnJvbSBhIEtlc3l0b25lIGNhc2UKICAgKi8KICAgY29ubmVjdC5jb3JlLmFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSA9IGZ1bmN0aW9uICh2aWV3VHlwZSwgbWVkaWFUeXBlLCBzb3VyY2UsIGNhc2VJZCkgewogICAgY29uc3QgZGF0YSA9IHsgdmlld1R5cGUsIG1lZGlhVHlwZSB9OwogICAgaWYgKHNvdXJjZSkgewogICAgICBkYXRhLnNvdXJjZSA9IHNvdXJjZTsKICAgIH0KICAgIGlmIChjYXNlSWQpIHsKICAgICAgZGF0YS5jYXNlSWQgPSBjYXNlSWQ7CiAgICB9CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNoYW5uZWxWaWV3RXZlbnRzLkFDVElWQVRFX0NIQU5ORUxfV0lUSF9WSUVXX1RZUEUsCiAgICAgIGRhdGEKICAgIH0pOwogIH07CgogIC8qKgogICAqIFVzZWQgdG8gcHVibGlzaCAndGFzayBjcmVhdGVkJyBldmVudAogICAqLwogIGNvbm5lY3QuY29yZS50cmlnZ2VyVGFza0NyZWF0ZWQgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkudXBzdHJlYW1CdXMudHJpZ2dlcihjb25uZWN0LlRhc2tFdmVudHMuQ1JFQVRFRCwgZGF0YSk7CiAgfTsKCiAgLyoqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KIAogIC8qKgogICogVGhpcyB3aWxsIGJlIGhlbHBmdWwgZm9yIHRoZSBjdXN0b20gYW5kIGVtYmVkZGVkIENDUHMgCiAgKiB0byBoYW5kbGUgdGhlIGFjY2VzcyBkZW5pZWQgdXNlIGNhc2UuIAogICovCiAgY29ubmVjdC5jb3JlLm9uQWNjZXNzRGVuaWVkID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNDRVNTX0RFTklFRCwgZik7CiAgfTsKIAogIC8qKgogICogVGhpcyB3aWxsIGJlIGhlbHBmdWwgZm9yIFNBTUwgdXNlIGNhc2VzIHRvIGhhbmRsZSB0aGUgY3VzdG9tIGxvZ2lucy4gCiAgKi8KICBjb25uZWN0LmNvcmUub25BdXRoRmFpbCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZik7CiAgfTsKCiAgY29ubmVjdC5jb3JlLm9uQXV0aG9yaXplU3VjY2VzcyA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9TVUNDRVNTLCBmKTsKICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplU3VjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5ULCAwKTsKICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aEZhaWwgPSBmdW5jdGlvbihsb2dpblVybCwgYXV0aG9yaXplRW5kcG9pbnQsIGF1dGhGYWlsRGF0YSkgewogICAgaWYgKGF1dGhGYWlsRGF0YSAmJiBhdXRoRmFpbERhdGEuYXV0aG9yaXplKSB7CiAgICAgIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplRmFpbChsb2dpblVybCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLl9oYW5kbGVDVElBdXRoRmFpbChhdXRob3JpemVFbmRwb2ludCk7CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZUZhaWwgPSBmdW5jdGlvbihsb2dpblVybCkgewogICAgbGV0IGF1dGhSZXRyeUNvdW50ID0gY29ubmVjdC5jb3JlLl9nZXRBdXRoUmV0cnlDb3VudCgpCiAgICBpZiAoIWNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQpIHsKICAgICAgaWYgKGF1dGhSZXRyeUNvdW50IDwgY29ubmVjdC5jb3JlLk1BWF9BVVRIT1JJWkVfUkVUUllfQ09VTlRfRk9SX1NFU1NJT04pIHsKICAgICAgICBjb25uZWN0LmNvcmUuX2luY3JlbWVudEF1dGhSZXRyeUNvdW50KCk7CiAgICAgICAgbGV0IHJldHJ5RGVsYXkgPSBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KGF1dGhSZXRyeUNvdW50ICsgMSB8fCAwLCB7IGJhc2U6IDIwMDAgfSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgY29ubmVjdC5jb3JlLl9yZWRpcmVjdFRvTG9naW4obG9naW5VcmwpOwogICAgICAgIH0sIHJldHJ5RGVsYXkpOyAvL1dlIGRvbid0IGhhdmUgdG8gY2xlYXIgdGhlIHRpbWVvdXRJZCBiZWNhdXNlIHdlIGFyZSByZWRpcmVjdGluZyBhd2F5IGZyb20gdGhpcyBvcmlnaW4gb25jZSB0aGUgdGltZW91dCBjb21wbGV0ZXMuCiAgICAgIH0KICAgICAgZWxzZSAgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiV2UgaGF2ZSBleGhhdXN0ZWQgb3VyIGF1dGhvcml6YXRpb24gcmV0cmllcyBkdWUgdG8gNDAxcyBmcm9tIHRoZSBhdXRob3JpemUgYXBpLiBObyBtb3JlIHJldHJpZXMgd2lsbCBiZSBhdHRlbXB0ZWQgaW4gdGhpcyBzZXNzaW9uIHVudGlsIHRoZSBhdXRob3JpemUgYXBpIHJldHVybnMgMjAwLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQpOwogICAgICB9CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX3JlZGlyZWN0VG9Mb2dpbiA9IGZ1bmN0aW9uKGxvZ2luVXJsKSB7CiAgICBpZiAodHlwZW9mKGxvZ2luVXJsKSA9PT0gJ3N0cmluZycpIHsKICAgICAgbG9jYXRpb24uYXNzaWduKGxvZ2luVXJsKTsKICAgIH0gZWxzZSB7CiAgICAgIGxvY2F0aW9uLnJlbG9hZCgpOwogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVDVElBdXRoRmFpbCA9IGZ1bmN0aW9uKGF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQpIHsKICAgICAgaWYgKGNvbm5lY3QuY29yZS5jdGlBdXRoUmV0cnlDb3VudCA8IGNvbm5lY3QuY29yZS5NQVhfQ1RJX0FVVEhfUkVUUllfQ09VTlQpIHsKICAgICAgICBjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQrKzsKICAgICAgICBsZXQgcmV0cnlEZWxheSA9IEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkoY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50IHx8IDAsIHsgYmFzZTogNTAwIH0pOwogICAgICAgIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGNvbm5lY3QuY29yZS5hdXRob3JpemUoYXV0aG9yaXplRW5kcG9pbnQpLnRoZW4oY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aG9yaXplU3VjY2Vzcy5iaW5kKGNvbm5lY3QuY29yZSkpLmNhdGNoKGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhGYWlsLmJpbmQoY29ubmVjdC5jb3JlLCB7YXV0aG9yaXplOiB0cnVlfSkpOwogICAgICAgICAgY29ubmVjdC5jb3JlLmN0aVRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgfSwgcmV0cnlEZWxheSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBoYXZlIGV4aGF1c3RlZCBvdXIgYXV0aG9yaXphdGlvbiByZXRyaWVzIGR1ZSB0byA0MDFzIGZyb20gdGhlIENUSSBzZXJ2aWNlLiBObyBtb3JlIHJldHJpZXMgd2lsbCBiZSBhdHRlbXB0ZWQgdW50aWwgdGhlIHBhZ2UgaXMgcmVmcmVzaGVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5DVElfQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVEKTsKICAgICAgfQogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aG9yaXplU3VjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkudXBzdHJlYW1CdXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfU1VDQ0VTUyk7CiAgfQoKICBjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRoRmFpbCA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnVwc3RyZWFtQnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBkYXRhKTsKICB9CgogIGNvbm5lY3QuY29yZS5fZ2V0QXV0aFJldHJ5Q291bnQgPSBmdW5jdGlvbigpIHsKICAgIGxldCBpdGVtID0gd2luZG93LnNlc3Npb25TdG9yYWdlLmdldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5UKTsKICAgIGlmIChpdGVtICE9PSBudWxsKSB7CiAgICAgIGlmICghaXNOYU4ocGFyc2VJbnQoaXRlbSkpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlSW50KGl0ZW0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoIlRoZSBzZXNzaW9uIHN0b3JhZ2UgdmFsdWUgZm9yIGF1dGggcmV0cnkgY291bnQgd2FzIE5hTiIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQsIDApOwogICAgICByZXR1cm4gMDsKICAgIH0gCiAgfQoKICBjb25uZWN0LmNvcmUuX2luY3JlbWVudEF1dGhSZXRyeUNvdW50ID0gZnVuY3Rpb24oKSB7CiAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQsIChjb25uZWN0LmNvcmUuX2dldEF1dGhSZXRyeUNvdW50KCkrMSkudG9TdHJpbmcoKSk7CiAgfQoKICBjb25uZWN0LmNvcmUub25BdXRob3JpemVSZXRyaWVzRXhoYXVzdGVkID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCwgZik7CiAgfQoKICBjb25uZWN0LmNvcmUub25DVElBdXRob3JpemVSZXRyaWVzRXhoYXVzdGVkID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLkNUSV9BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQsIGYpOwogIH0KIAogIC8qKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAKICAvKioKICAgKiBVc2VkIGZvciBoYW5kbGluZyB0aGUgcnRjIHNlc3Npb24gc3RhdHMuCiAgICogVXNhZ2UKICAgKiBjb25uZWN0LmNvcmUub25Tb2Z0cGhvbmVTZXNzaW9uSW5pdChmdW5jdGlvbih7IGNvbm5lY3Rpb25JZCB9KSB7CiAgICogICAgIHZhciBzb2Z0cGhvbmVNYW5hZ2VyID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIoKTsKICAgKiAgICAgaWYoc29mdHBob25lTWFuYWdlcil7CiAgICogICAgICAgIC8vIGFjY2VzcyBzZXNzaW9uCiAgICogICAgICAgIHZhciBzZXNzaW9uID0gc29mdHBob25lTWFuYWdlci5nZXRTZXNzaW9uKGNvbm5lY3Rpb25JZCk7IAogICAqICAgICAgfQogICAqIH0pOwogICAqLwogCiAgY29ubmVjdC5jb3JlLm9uU29mdHBob25lU2Vzc2lvbkluaXQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuU0VTU0lPTl9JTklULCBmKTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5vbkNvbmZpZ3VyZSA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLkNPTkZJR1VSRSwgZik7CiAgfQoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICBjb25uZWN0LmNvcmUub25Jbml0aWFsaXplZCA9IGZ1bmN0aW9uKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuSU5JVCwgZik7CiAgfQoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWN0SWQsICdjb250YWN0SWQnKTsKICAgIGlmICghY29ubmVjdC5jb250YWlucyhjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RFdmVudHMpLCBldmVudE5hbWUpKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlZhbHVlRXJyb3IoJyVzIGlzIG5vdCBhIHZhbGlkIGNvbnRhY3QgZXZlbnQuJywgZXZlbnROYW1lKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoJyVzOjolcycsIGV2ZW50TmFtZSwgY29udGFjdElkKTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZXZlbnRCdXM7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXI7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50RGF0YVByb3ZpZGVyOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldExvY2FsVGltZXN0YW1wID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpLnNuYXBzaG90LmxvY2FsVGltZXN0YW1wOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFNrZXcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCkuc25hcHNob3Quc2tldzsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudFJvdXRpbmdFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudFJvdXRpbmdFdmVudEdyYXBoOwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50Um91dGluZ0V2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLlJPVVRBQkxFLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuTk9UX1JPVVRBQkxFLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLk5PVF9ST1VUQUJMRSkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk9GRkxJTkUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuT0ZGTElORSk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50U3RhdGVFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudFN0YXRlRXZlbnRHcmFwaDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudFN0YXRlRXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQWdlbnRFcnJvclN0YXRlcyksCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzLkFGVEVSX0NBTExfV09SSywKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1cpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuY29udGFjdEV2ZW50R3JhcGg7CiAgfTsKIAogIGNvbm5lY3QuY29yZS5jb250YWN0RXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTkNPTUlORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5QRU5ESU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RFRCkKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5JTkNPTUlORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FTkRFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkFDVykKICAgIC5hc3NvYyhjb25uZWN0LnZhbHVlcyhjb25uZWN0LkNPTlRBQ1RfQUNUSVZFX1NUQVRFUyksCiAgICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QucmVsYXRpdmVDb21wbGVtZW50KGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTLCBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUpKSwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLkVSUk9SKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuTUlTU0VELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuTUlTU0VEKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5jbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgY29yZSBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmNsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5jbGllbnQgPSBudWxsOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgQWdlbnRBcHAgQ2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRBcHBDbGllbnQgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRUYXNrVGVtcGxhdGVzQ2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBUYXNrVGVtcGxhdGVzIENsaWVudCBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudCA9IG51bGw7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0TWFzdGVyQ2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IG1hc3RlciBjbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Tm90aWZpY2F0aW9uTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIpIHsKICAgICAgY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIgPSBuZXcgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyKCk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlciA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUucG9wdXBNYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLnBvcHVwTWFuYWdlciA9IG5ldyBjb25uZWN0LlBvcHVwTWFuYWdlcigpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLnVwc3RyZWFtKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZXJlIGlzIG5vIHVwc3RyZWFtIGNvbmR1aXQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnVwc3RyZWFtOwogIH07CiAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuQWdlbnREYXRhUHJvdmlkZXIgPSBBZ2VudERhdGFQcm92aWRlcjsKIAp9KSgpOwoKLyoqKi8gfSksCgovKioqLyA1OTI6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBTExfRVZFTlRTID0gJzw8YWxsPj4nOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEV2ZW50VHlwZQogICAqLwogIHZhciBFdmVudFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdhY2tub3dsZWRnZScsCiAgICAnYWNrX3RpbWVvdXQnLAogICAgJ2luaXQnLAogICAgJ2FwaV9yZXF1ZXN0JywKICAgICdhcGlfcmVzcG9uc2UnLAogICAgJ2F1dGhfZmFpbCcsCiAgICAnYWNjZXNzX2RlbmllZCcsCiAgICAnY2xvc2UnLAogICAgJ2NvbmZpZ3VyZScsCiAgICAnbG9nJywKICAgICdtYXN0ZXJfcmVxdWVzdCcsCiAgICAnbWFzdGVyX3Jlc3BvbnNlJywKICAgICdzeW5jaHJvbml6ZScsCiAgICAndGVybWluYXRlJywKICAgICd0ZXJtaW5hdGVkJywKICAgICdzZW5kX2xvZ3MnLAogICAgJ3JlbG9hZF9hZ2VudF9jb25maWd1cmF0aW9uJywKICAgICdicm9hZGNhc3QnLAogICAgJ2FwaV9tZXRyaWMnLAogICAgJ2NsaWVudF9tZXRyaWMnLAogICAgJ3NvZnRwaG9uZV9zdGF0cycsCiAgICAnc29mdHBob25lX3JlcG9ydCcsCiAgICAnY2xpZW50X3NpZGVfbG9ncycsCiAgICAnc2VydmVyX2JvdW5kX2ludGVybmFsX2xvZycsCiAgICAnbXV0ZScsCiAgICAiaWZyYW1lX3N0eWxlIiwKICAgICJpZnJhbWVfcmV0cmllc19leGhhdXN0ZWQiLAogICAgInVwZGF0ZV9jb25uZWN0ZWRfY2NwcyIsCiAgICAib3V0ZXJfY29udGV4dF9pbmZvIiwKICAgICJtZWRpYV9kZXZpY2VfcmVxdWVzdCIsCiAgICAibWVkaWFfZGV2aWNlX3Jlc3BvbnNlIiwKICAgICJ0YWJfaWQiLAogICAgJ2F1dGhvcml6ZV9zdWNjZXNzJywKICAgICdhdXRob3JpemVfcmV0cmllc19leGhhdXN0ZWQnLAogICAgJ2N0aV9hdXRob3JpemVfcmV0cmllc19leGhhdXN0ZWQnLAogICAgJ2NsaWNrX3N0cmVhbV9kYXRhJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIE1hc3RlclRvcGljcwogICAqLwogIHZhciBNYXN0ZXJUb3BpY3MgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29ubmVjdCcsIFsKICAgICdsb2dpblBvcHVwJywKICAgICdzZW5kTG9ncycsCiAgICAnc29mdHBob25lJywKICAgICdyaW5ndG9uZScsCiAgICAnbWV0cmljcycKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudEV2ZW50cwogICAqLwogIHZhciBBZ2VudEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdhZ2VudCcsIFsKICAgICdpbml0JywKICAgICd1cGRhdGUnLAogICAgJ3JlZnJlc2gnLAogICAgJ3JvdXRhYmxlJywKICAgICdub3Rfcm91dGFibGUnLAogICAgJ3BlbmRpbmcnLAogICAgJ2NvbnRhY3RfcGVuZGluZycsCiAgICAnb2ZmbGluZScsCiAgICAnZXJyb3InLAogICAgJ3NvZnRwaG9uZV9lcnJvcicsCiAgICAnd2Vic29ja2V0X2Nvbm5lY3Rpb25fbG9zdCcsCiAgICAnd2Vic29ja2V0X2Nvbm5lY3Rpb25fZ2FpbmVkJywKICAgICdzdGF0ZV9jaGFuZ2UnLAogICAgJ2FjdycsCiAgICAnbXV0ZV90b2dnbGUnLAogICAgJ2xvY2FsX21lZGlhX3N0cmVhbV9jcmVhdGVkJywKICAgICdlbnF1ZXVlZF9uZXh0X3N0YXRlJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gV2ViU29ja2V0RXZlbnRzCiAgKi8KICB2YXIgV2ViU29ja2V0RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3dlYlNvY2tldCcsIFsKICAgICdpbml0X2ZhaWx1cmUnLAogICAgJ2Nvbm5lY3Rpb25fb3BlbicsCiAgICAnY29ubmVjdGlvbl9jbG9zZScsCiAgICAnY29ubmVjdGlvbl9lcnJvcicsCiAgICAnY29ubmVjdGlvbl9nYWluJywKICAgICdjb25uZWN0aW9uX2xvc3QnLAogICAgJ3N1YnNjcmlwdGlvbl91cGRhdGUnLAogICAgJ3N1YnNjcmlwdGlvbl9mYWlsdXJlJywKICAgICdhbGxfbWVzc2FnZScsCiAgICAnc2VuZCcsCiAgICAnc3Vic2NyaWJlJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBDb250YWN0RXZlbnRzCiAgICAqLwogIHZhciBDb250YWN0RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbnRhY3QnLCBbCiAgICAnaW5pdCcsCiAgICAncmVmcmVzaCcsCiAgICAnZGVzdHJveWVkJywKICAgICdpbmNvbWluZycsCiAgICAncGVuZGluZycsCiAgICAnY29ubmVjdGluZycsCiAgICAnY29ubmVjdGVkJywKICAgICdtaXNzZWQnLAogICAgJ2FjdycsCiAgICAndmlldycsCiAgICAnZW5kZWQnLAogICAgJ2Vycm9yJywKICAgICdhY2NlcHRlZCcKICBdKTsKCiAgdmFyIENoYW5uZWxWaWV3RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3Rhc2tMaXN0JywgWwogICAgJ2FjdGl2YXRlX2NoYW5uZWxfd2l0aF92aWV3X3R5cGUnCiAgXSk7CiAgCiAgdmFyIFRhc2tFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgndGFzaycsIFsKICAgICAgJ2NyZWF0ZWQnCiAgXSk7CgoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gQ29ubmVjdGlvbkV2ZW50cwogICovCiAgdmFyIENvbm5lY3Rpb25FdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29ubmVjdGlvbicsIFsKICAgICdzZXNzaW9uX2luaXQnLAogICAgJ3JlYWR5X3RvX3N0YXJ0X3Nlc3Npb24nCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29uZmlndXJhdGlvbiBFdmVudHMKICAgKi8KICB2YXIgQ29uZmlndXJhdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25maWd1cmF0aW9uJywgWwogICAgJ2NvbmZpZ3VyZScsCiAgICAnc2V0X3NwZWFrZXJfZGV2aWNlJywKICAgICdzZXRfbWljcm9waG9uZV9kZXZpY2UnLAogICAgJ3NldF9yaW5nZXJfZGV2aWNlJywKICAgICdzcGVha2VyX2RldmljZV9jaGFuZ2VkJywKICAgICdtaWNyb3Bob25lX2RldmljZV9jaGFuZ2VkJywKICAgICdyaW5nZXJfZGV2aWNlX2NoYW5nZWQnCiAgXSk7CgogIHZhciBEaXNhc3RlclJlY292ZXJ5RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Rpc2FzdGVyUmVjb3ZlcnknLCBbCiAgICAnc3VwcHJlc3MnLAogICAgJ2ZvcmNlX29mZmxpbmUnLCAvLyBsZXR0aW5nIHRoZSBzaGFyZWR3b3JrZXIga25vdyB0byBmb3JjZSBvZmZsaW5lIAogICAgJ3NldF9vZmZsaW5lJywgLy8gaWZyYW1lIGxldHRpbmcgdGhlIG5hdGl2ZSBjY3AgdG8gc2V0IG9mZmxpbmUKICAgICdpbml0X2Rpc2FzdGVyX3JlY292ZXJ5JywKICAgICdmYWlsb3ZlcicgLy8gdXNlZCB0byBwcm9wYWdhdGUgZmFpbG92ZXIgc3RhdGUgdG8gb3RoZXIgd2luZG93cwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbmZpZ3VyYXRpb24gRXZlbnRzCiAgICovCiAgdmFyIENvbmZpZ3VyYXRpb25FdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29uZmlndXJhdGlvbicsIFsKICAgICdjb25maWd1cmUnLAogICAgJ3NldF9zcGVha2VyX2RldmljZScsCiAgICAnc2V0X21pY3JvcGhvbmVfZGV2aWNlJywKICAgICdzZXRfcmluZ2VyX2RldmljZScsCiAgICAnc3BlYWtlcl9kZXZpY2VfY2hhbmdlZCcsCiAgICAnbWljcm9waG9uZV9kZXZpY2VfY2hhbmdlZCcsCiAgICAncmluZ2VyX2RldmljZV9jaGFuZ2VkJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFZvaWNlSWQgRXZlbnRzCiAgICovCiAgIHZhciBWb2ljZUlkRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3ZvaWNlSWQnLCBbCiAgICAndXBkYXRlX2RvbWFpbl9pZCcKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgRXZlbnRGYWN0b3J5CiAgICovCiAgdmFyIEV2ZW50RmFjdG9yeSA9IGZ1bmN0aW9uICgpIHsgfTsKICBFdmVudEZhY3RvcnkuY3JlYXRlUmVxdWVzdCA9IGZ1bmN0aW9uICh0eXBlLCBtZXRob2QsIHBhcmFtcykgewogICAgcmV0dXJuIHsKICAgICAgZXZlbnQ6IHR5cGUsCiAgICAgIHJlcXVlc3RJZDogY29ubmVjdC5yYW5kb21JZCgpLAogICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgcGFyYW1zOiBwYXJhbXMKICAgIH07CiAgfTsKCiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlID0gZnVuY3Rpb24gKHR5cGUsIHJlcXVlc3QsIGRhdGEsIGVycikgewogICAgcmV0dXJuIHsKICAgICAgZXZlbnQ6IHR5cGUsCiAgICAgIHJlcXVlc3RJZDogcmVxdWVzdC5yZXF1ZXN0SWQsCiAgICAgIGRhdGE6IGRhdGEsCiAgICAgIGVycjogZXJyIHx8IG51bGwKICAgIH07CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHJlcHJlc2VudGluZyBhbiBldmVudCBzdWJzY3JpcHRpb24gaW4gYW4gRXZlbnRCdXMuCiAgICovCiAgdmFyIFN1YnNjcmlwdGlvbiA9IGZ1bmN0aW9uIChzdWJNYXAsIGV2ZW50TmFtZSwgZikgewogICAgdGhpcy5zdWJNYXAgPSBzdWJNYXA7CiAgICB0aGlzLmlkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICB0aGlzLmYgPSBmOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIHRoZSBoYW5kbGVyIG9mIHRoaXMgc3Vic2NyaXB0aW9uIGZyb20gdGhlIEV2ZW50QnVzCiAgICogZnJvbSB3aGljaCBpdCB3YXMgY3JlYXRlZC4KICAgKi8KICBTdWJzY3JpcHRpb24ucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJNYXAudW5zdWJzY3JpYmUodGhpcy5ldmVudE5hbWUsIHRoaXMuaWQpOwogIH07CgogIC8qKgogICAqIEEgbWFwIG9mIGV2ZW50IHN1YnNjcmlwdGlvbnMsIHVzZWQgYnkgdGhlIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb25NYXAgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1YklkTWFwID0ge307CiAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcCA9IHt9OwogIH07CgogIC8qKgogICAqIEFkZCBhIHN1YnNjcmlwdGlvbiBmb3IgdGhlIG5hbWVkIGV2ZW50LiAgQ3JlYXRlcyBhIG5ldyBTdWJzY3JpcHRpb24KICAgKiBvYmplY3QgYW5kIHJldHVybnMgaXQuICBUaGlzIG9iamVjdCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGYpIHsKICAgIHZhciBzdWIgPSBuZXcgU3Vic2NyaXB0aW9uKHRoaXMsIGV2ZW50TmFtZSwgZik7CgogICAgdGhpcy5zdWJJZE1hcFtzdWIuaWRdID0gc3ViOwogICAgdmFyIHN1Ykxpc3QgPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdIHx8IFtdOwogICAgc3ViTGlzdC5wdXNoKHN1Yik7CiAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdID0gc3ViTGlzdDsKICAgIHJldHVybiBzdWI7CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgYSBzdWJzY3JpcHRpb24gbWF0Y2hpbmcgdGhlIGdpdmVuIGV2ZW50IG5hbWUgYW5kIGlkLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBzdWJJZCkgewogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJFdmVudE5hbWVNYXAsIGV2ZW50TmFtZSkpIHsKICAgICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0uZmlsdGVyKGZ1bmN0aW9uIChzKSB7IHJldHVybiBzLmlkICE9PSBzdWJJZDsgfSk7CgogICAgICBpZiAodGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXS5sZW5ndGggPCAxKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV07CiAgICAgIH0KICAgIH0KCiAgICBpZiAoY29ubmVjdC5jb250YWlucyh0aGlzLnN1YklkTWFwLCBzdWJJZCkpIHsKICAgICAgZGVsZXRlIHRoaXMuc3ViSWRNYXBbc3ViSWRdOwogICAgfQogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2YgYWxsIHN1YnNjcmlwdGlvbnMgaW4gdGhlIHN1YnNjcmlwdGlvbiBtYXAuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRBbGxTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QudmFsdWVzKHRoaXMuc3ViRXZlbnROYW1lTWFwKS5yZWR1Y2UoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEuY29uY2F0KGIpOwogICAgfSwgW10pOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLmdldFN1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICB9OwoKICAvKioKICAgKiBBbiBvYmplY3Qgd2hpY2ggbWFpbnRhaW5zIGEgbWFwIG9mIHN1YnNjcmlwdGlvbnMgYW5kIHNlcnZlcyBhcyB0aGUKICAgKiBtZWNoYW5pc20gZm9yIHRyaWdnZXJpbmcgZXZlbnRzIHRvIGJlIGhhbmRsZWQgYnkgc3Vic2NyaWJlcnMuCiAgICovCiAgdmFyIEV2ZW50QnVzID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CgogICAgdGhpcy5zdWJNYXAgPSBuZXcgU3Vic2NyaXB0aW9uTWFwKCk7CiAgICB0aGlzLmxvZ0V2ZW50cyA9IHBhcmFtcy5sb2dFdmVudHMgfHwgZmFsc2U7CiAgfTsKCiAgLyoqCiAgICogU3Vic2NyaWJlIHRvIHRoZSBuYW1lZCBldmVudC4gIFJldHVybnMgYSBuZXcgU3Vic2NyaXB0aW9uIG9iamVjdAogICAqIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgcmV0dXJuIHRoaXMuc3ViTWFwLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBvbiBhbGwgZXZlbnRzLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5zdWJzY3JpYmVBbGwgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoQUxMX0VWRU5UUywgZik7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGZvciB0aGUgZ2l2ZW4gZXZlbnQgbmFtZSwgb3IgYW4gZW1wdHkKICAgKiBsaXN0IGlmIHRoZXJlIGFyZSBubyBzdWJzY3JpcHRpb25zLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKICB9OwoKICAvKioKICAgKiBUcmlnZ2VyIHRoZSBnaXZlbiBldmVudCB3aXRoIHRoZSBnaXZlbiBkYXRhLiAgQWxsIG1ldGhvZHMgc3Vic2NyaWJlZAogICAqIHRvIHRoaXMgZXZlbnQgd2lsbCBiZSBjYWxsZWQgYW5kIGFyZSBwcm92aWRlZCB3aXRoIHRoZSBnaXZlbiBhcmJpdHJhcnkKICAgKiBkYXRhIG9iamVjdCBhbmQgdGhlIG5hbWUgb2YgdGhlIGV2ZW50LCBpbiB0aGF0IG9yZGVyLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS50cmlnZ2VyID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGFsbEV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoQUxMX0VWRU5UUyk7CiAgICB2YXIgZXZlbnRTdWJzID0gdGhpcy5zdWJNYXAuZ2V0U3Vic2NyaXB0aW9ucyhldmVudE5hbWUpOwoKICAgIGlmICh0aGlzLmxvZ0V2ZW50cyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTE9HICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9NRVRSSUMgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLlNFUlZFUl9CT1VORF9JTlRFUk5BTF9MT0cKICAgICkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJQdWJsaXNoaW5nIGV2ZW50OiAlcyIsIGV2ZW50TmFtZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KCiAgICBpZiAoCiAgICAgIGV2ZW50TmFtZS5zdGFydHNXaXRoKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ0NFUFRFRCkgJiYKICAgICAgZGF0YSAmJgogICAgICBkYXRhLmNvbnRhY3RJZCAmJgogICAgICAhKGRhdGEgaW5zdGFuY2VvZiBjb25uZWN0LkNvbnRhY3QpCiAgICApIHsKICAgICAgZGF0YSA9IG5ldyBjb25uZWN0LkNvbnRhY3QoZGF0YS5jb250YWN0SWQpOwogICAgfQoKICAgIGFsbEV2ZW50U3Vicy5jb25jYXQoZXZlbnRTdWJzKS5mb3JFYWNoKGZ1bmN0aW9uIChzdWIpIHsKICAgICAgdHJ5IHsKICAgICAgICBzdWIuZihkYXRhIHx8IG51bGwsIGV2ZW50TmFtZSwgc2VsZik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCInJXMnIGV2ZW50IGhhbmRsZXIgZmFpbGVkLiIsIGV2ZW50TmFtZSkud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBicmlkZ2VzIGFuIGV2ZW50IGZyb20gYW5vdGhlciBFdmVudEJ1cyB0byB0aGlzIGJ1cy4KICAgKgogICAqIFVzYWdlOgogICAqIGNvbmR1aXQub25VcHN0cmVhbSgiTXlFdmVudCIsIGJ1cy5icmlkZ2UoKSk7CiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLmJyaWRnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBmdW5jdGlvbiAoZGF0YSwgZXZlbnQpIHsKICAgICAgc2VsZi50cmlnZ2VyKGV2ZW50LCBkYXRhKTsKICAgIH07CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgYWxsIGV2ZW50cyBpbiB0aGUgZXZlbnQgYnVzLgogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS51bnN1YnNjcmliZUFsbCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLmdldEFsbFN1YnNjcmlwdGlvbnMoKS5mb3JFYWNoKGZ1bmN0aW9uIChzdWIpIHsKICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBjb25uZWN0LkV2ZW50QnVzID0gRXZlbnRCdXM7CiAgY29ubmVjdC5FdmVudEZhY3RvcnkgPSBFdmVudEZhY3Rvcnk7CiAgY29ubmVjdC5FdmVudFR5cGUgPSBFdmVudFR5cGU7CiAgY29ubmVjdC5BZ2VudEV2ZW50cyA9IEFnZW50RXZlbnRzOwogIGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cyA9IENvbmZpZ3VyYXRpb25FdmVudHM7CiAgY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzID0gQ29ubmVjdGlvbkV2ZW50czsKICBjb25uZWN0LkNvbm5uZWN0aW9uRXZlbnRzID0gQ29ubmVjdGlvbkV2ZW50czsgLy9kZXByZWNhdGUgb24gbmV4dCBtYWpvciB2ZXJzaW9uIHJlbGVhc2UuCiAgY29ubmVjdC5Db250YWN0RXZlbnRzID0gQ29udGFjdEV2ZW50czsKICBjb25uZWN0LkNoYW5uZWxWaWV3RXZlbnRzID0gQ2hhbm5lbFZpZXdFdmVudHM7CiAgY29ubmVjdC5UYXNrRXZlbnRzID0gVGFza0V2ZW50czsKICBjb25uZWN0LlZvaWNlSWRFdmVudHMgPSBWb2ljZUlkRXZlbnRzOwogIGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzID0gV2ViU29ja2V0RXZlbnRzOwogIGNvbm5lY3QuTWFzdGVyVG9waWNzID0gTWFzdGVyVG9waWNzOwogIGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cyA9IERpc2FzdGVyUmVjb3ZlcnlFdmVudHM7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAyODY6Ci8qKiovICgoKSA9PiB7CgohZnVuY3Rpb24oZSl7dmFyIG49e307ZnVuY3Rpb24gdChvKXtpZihuW29dKXJldHVybiBuW29dLmV4cG9ydHM7dmFyIHI9bltvXT17aTpvLGw6ITEsZXhwb3J0czp7fX07cmV0dXJuIGVbb10uY2FsbChyLmV4cG9ydHMscixyLmV4cG9ydHMsdCksci5sPSEwLHIuZXhwb3J0c310Lm09ZSx0LmM9bix0LmQ9ZnVuY3Rpb24oZSxuLG8pe3QubyhlLG4pfHxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxuLHtlbnVtZXJhYmxlOiEwLGdldDpvfSl9LHQucj1mdW5jdGlvbihlKXsidW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmU3ltYm9sLnRvU3RyaW5nVGFnJiZPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxTeW1ib2wudG9TdHJpbmdUYWcse3ZhbHVlOiJNb2R1bGUifSksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pfSx0LnQ9ZnVuY3Rpb24oZSxuKXtpZigxJm4mJihlPXQoZSkpLDgmbilyZXR1cm4gZTtpZig0Jm4mJiJvYmplY3QiPT10eXBlb2YgZSYmZSYmZS5fX2VzTW9kdWxlKXJldHVybiBlO3ZhciBvPU9iamVjdC5jcmVhdGUobnVsbCk7aWYodC5yKG8pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCJkZWZhdWx0Iix7ZW51bWVyYWJsZTohMCx2YWx1ZTplfSksMiZuJiYic3RyaW5nIiE9dHlwZW9mIGUpZm9yKHZhciByIGluIGUpdC5kKG8scixmdW5jdGlvbihuKXtyZXR1cm4gZVtuXX0uYmluZChudWxsLHIpKTtyZXR1cm4gb30sdC5uPWZ1bmN0aW9uKGUpe3ZhciBuPWUmJmUuX19lc01vZHVsZT9mdW5jdGlvbigpe3JldHVybiBlLmRlZmF1bHR9OmZ1bmN0aW9uKCl7cmV0dXJuIGV9O3JldHVybiB0LmQobiwiYSIsbiksbn0sdC5vPWZ1bmN0aW9uKGUsbil7cmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChlLG4pfSx0LnA9IiIsdCh0LnM9Mil9KFtmdW5jdGlvbihlLG4sdCl7InVzZSBzdHJpY3QiO3ZhciBvPXQoMSkscj0iTlVMTCIsaT0iQ0xJRU5UX0xPR0dFUiIsYz0iREVCVUciLGE9MmUzLHM9IkFNWl9XRUJfU09DS0VUX01BTkFHRVI6Iix1PSJOZXR3b3JrIG9mZmxpbmUiLGw9Ik5ldHdvcmsgb25saW5lLCBjb25uZWN0aW5nIHRvIFdlYlNvY2tldCBzZXJ2ZXIiLGY9Ik5ldHdvcmsgb2ZmbGluZSwgaWdub3JpbmcgdGhpcyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QiLGQ9IkhlYXJ0YmVhdCByZXNwb25zZSBub3QgcmVjZWl2ZWQiLHA9IkhlYXJ0YmVhdCByZXNwb25zZSByZWNlaXZlZCIsZz0iU2VuZGluZyBoZWFydGJlYXQiLGI9IkZhaWxlZCB0byBzZW5kIGhlYXJ0YmVhdCBzaW5jZSBXZWJTb2NrZXQgaXMgbm90IG9wZW4iLHk9IldlYlNvY2tldCBjb25uZWN0aW9uIGVzdGFibGlzaGVkISIsbT0iV2ViU29ja2V0IGNvbm5lY3Rpb24gaXMgY2xvc2VkIix2PSJXZWJTb2NrZXRNYW5hZ2VyIEVycm9yLCBlcnJvcl9ldmVudDogIixTPSJTY2hlZHVsaW5nIFdlYlNvY2tldCByZWluaXRpYWxpemF0aW9uLCBhZnRlciBkZWxheSAiLGg9IldlYlNvY2tldCBVUkwgY2Fubm90IGJlIHVzZWQgdG8gZXN0YWJsaXNoIGNvbm5lY3Rpb24iLGs9IldlYlNvY2tldCBJbml0aWFsaXphdGlvbiBmYWlsZWQgLSBUZXJtaW5hdGluZyBhbmQgY2xlYW5pbmcgc3Vic2NyaXB0aW9ucyIsdz0iVGVybWluYXRpbmcgV2ViU29ja2V0IE1hbmFnZXIiLEM9IkZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixMPSJTdWNjZXNzZnVsbHkgZmV0Y2hlZCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixUPSJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsTz0iUmV0cnlpbmcgZmV0Y2hpbmcgbmV3IFdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLFc9IkluaXRpYWxpemluZyBXZWJzb2NrZXQgTWFuYWdlciIsST0iSW5pdGlhbGl6aW5nIFdlYnNvY2tldCBNYW5hZ2VyIEZhaWxlZCEiLE49IldlYnNvY2tldCBjb25uZWN0aW9uIG9wZW4iLF89IldlYnNvY2tldCBjb25uZWN0aW9uIGNsb3NlIixFPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBnYWluIixGPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBsb3N0IixBPSJXZWJzb2NrZXQgc3Vic2NyaXB0aW9uIGZhaWx1cmUiLFI9IlJlc2V0IFdlYnNvY2tldCBzdGF0ZSIseD0iV2ViU29ja2V0TWFuYWdlciBNZXNzYWdlIEVycm9yIixEPSJNZXNzYWdlIHJlY2VpdmVkIGZvciB0b3BpYyAiLGo9IkludmFsaWQgaW5jb21pbmcgbWVzc2FnZSIsTT0iV2Vic29ja2V0TWFuYWdlciBpbnZva2UgY2FsbGJhY2tzIGZvciB0b3BpYyBzdWNjZXNzICIsRz0iYXdzL3N1YnNjcmliZSIsej0iYXdzL3Vuc3Vic2NyaWJlIixQPSJhd3MvaGVhcnRiZWF0IixIPSJjb25uZWN0ZWQiLFU9ImRpc2Nvbm5lY3RlZCI7ZnVuY3Rpb24gcShlKXtyZXR1cm4ocT0iZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiYic3ltYm9sIj09dHlwZW9mIFN5bWJvbC5pdGVyYXRvcj9mdW5jdGlvbihlKXtyZXR1cm4gdHlwZW9mIGV9OmZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiZlLmNvbnN0cnVjdG9yPT09U3ltYm9sJiZlIT09U3ltYm9sLnByb3RvdHlwZT8ic3ltYm9sIjp0eXBlb2YgZX0pKGUpfXZhciBKPXthc3NlcnRUcnVlOmZ1bmN0aW9uKGUsbil7aWYoIWUpdGhyb3cgbmV3IEVycm9yKG4pfSxhc3NlcnROb3ROdWxsOmZ1bmN0aW9uKGUsbil7cmV0dXJuIEouYXNzZXJ0VHJ1ZShudWxsIT09ZSYmdm9pZCAwIT09cShlKSxPYmplY3Qoby5zcHJpbnRmKSgiJXMgbXVzdCBiZSBwcm92aWRlZCIsbnx8IkEgdmFsdWUiKSksZX0saXNOb25FbXB0eVN0cmluZzpmdW5jdGlvbihlKXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIGUmJmUubGVuZ3RoPjB9LGFzc2VydElzTGlzdDpmdW5jdGlvbihlLG4pe2lmKCFBcnJheS5pc0FycmF5KGUpKXRocm93IG5ldyBFcnJvcihuKyIgaXMgbm90IGFuIGFycmF5Iil9LGlzRnVuY3Rpb246ZnVuY3Rpb24oZSl7cmV0dXJuISEoZSYmZS5jb25zdHJ1Y3RvciYmZS5jYWxsJiZlLmFwcGx5KX0saXNPYmplY3Q6ZnVuY3Rpb24oZSl7cmV0dXJuISgib2JqZWN0IiE9PXEoZSl8fG51bGw9PT1lKX0saXNTdHJpbmc6ZnVuY3Rpb24oZSl7cmV0dXJuInN0cmluZyI9PXR5cGVvZiBlfSxpc051bWJlcjpmdW5jdGlvbihlKXtyZXR1cm4ibnVtYmVyIj09dHlwZW9mIGV9fSxCPW5ldyBSZWdFeHAoIl4od3NzOi8vKVxcdyoiKTtKLnZhbGlkV1NVcmw9ZnVuY3Rpb24oZSl7cmV0dXJuIEIudGVzdChlKX0sSi5nZXRTdWJzY3JpcHRpb25SZXNwb25zZT1mdW5jdGlvbihlLG4sdCl7cmV0dXJue3RvcGljOmUsY29udGVudDp7c3RhdHVzOm4/InN1Y2Nlc3MiOiJmYWlsdXJlIix0b3BpY3M6dH19fSxKLmFzc2VydElzT2JqZWN0PWZ1bmN0aW9uKGUsbil7aWYoIUouaXNPYmplY3QoZSkpdGhyb3cgbmV3IEVycm9yKG4rIiBpcyBub3QgYW4gb2JqZWN0ISIpfSxKLmFkZEppdHRlcj1mdW5jdGlvbihlKXt2YXIgbj1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06MTtuPU1hdGgubWluKG4sMSk7dmFyIHQ9TWF0aC5yYW5kb20oKT4uNT8xOi0xO3JldHVybiBNYXRoLmZsb29yKGUrdCplKk1hdGgucmFuZG9tKCkqbil9LEouaXNOZXR3b3JrT25saW5lPWZ1bmN0aW9uKCl7cmV0dXJuIG5hdmlnYXRvci5vbkxpbmV9LEouaXNOZXR3b3JrRmFpbHVyZT1mdW5jdGlvbihlKXtyZXR1cm4hKCFlLl9kZWJ1Z3x8IWUuX2RlYnVnLnR5cGUpJiYiTmV0d29ya2luZ0Vycm9yIj09PWUuX2RlYnVnLnR5cGV9O3ZhciBWPUo7ZnVuY3Rpb24gWChlLG4pe3JldHVybiFufHwib2JqZWN0IiE9PVoobikmJiJmdW5jdGlvbiIhPXR5cGVvZiBuP2Z1bmN0aW9uKGUpe2lmKHZvaWQgMD09PWUpdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTtyZXR1cm4gZX0oZSk6bn1mdW5jdGlvbiAkKGUpe3JldHVybigkPU9iamVjdC5zZXRQcm90b3R5cGVPZj9PYmplY3QuZ2V0UHJvdG90eXBlT2Y6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuX19wcm90b19ffHxPYmplY3QuZ2V0UHJvdG90eXBlT2YoZSl9KShlKX1mdW5jdGlvbiBLKGUsbil7cmV0dXJuKEs9T2JqZWN0LnNldFByb3RvdHlwZU9mfHxmdW5jdGlvbihlLG4pe3JldHVybiBlLl9fcHJvdG9fXz1uLGV9KShlLG4pfWZ1bmN0aW9uIFooZSl7cmV0dXJuKFo9ImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3I/ZnVuY3Rpb24oZSl7cmV0dXJuIHR5cGVvZiBlfTpmdW5jdGlvbihlKXtyZXR1cm4gZSYmImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmZS5jb25zdHJ1Y3Rvcj09PVN5bWJvbCYmZSE9PVN5bWJvbC5wcm90b3R5cGU/InN5bWJvbCI6dHlwZW9mIGV9KShlKX1mdW5jdGlvbiBRKGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9ZnVuY3Rpb24gWShlLG4pe2Zvcih2YXIgdD0wO3Q8bi5sZW5ndGg7dCsrKXt2YXIgbz1uW3RdO28uZW51bWVyYWJsZT1vLmVudW1lcmFibGV8fCExLG8uY29uZmlndXJhYmxlPSEwLCJ2YWx1ZSJpbiBvJiYoby53cml0YWJsZT0hMCksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsby5rZXksbyl9fWZ1bmN0aW9uIGVlKGUsbix0KXtyZXR1cm4gbiYmWShlLnByb3RvdHlwZSxuKSx0JiZZKGUsdCksZX12YXIgbmU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7USh0aGlzLGUpfXJldHVybiBlZShlLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6ImFkdmFuY2VkTG9nIix2YWx1ZTpmdW5jdGlvbihlKXt9fV0pLGV9KCksdGU9cyxvZT17REVCVUc6MTAsSU5GTzoyMCxXQVJOOjMwLEVSUk9SOjQwLEFEVkFOQ0VEX0xPRzo1MH0scmU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7USh0aGlzLGUpLHRoaXMudXBkYXRlTG9nZ2VyQ29uZmlnKCksdGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcj1hZSgpfXJldHVybiBlZShlLFt7a2V5OiJ3cml0ZVRvQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlLG4pe2lmKHRoaXMuaGFzQ2xpZW50TG9nZ2VyKCkpc3dpdGNoKGUpe2Nhc2Ugb2UuREVCVUc6cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5kZWJ1ZyhuKXx8bjtjYXNlIG9lLklORk86cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5pbmZvKG4pfHxuO2Nhc2Ugb2UuV0FSTjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLndhcm4obil8fG47Y2FzZSBvZS5FUlJPUjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmVycm9yKG4pfHxuO2Nhc2Ugb2UuQURWQU5DRURfTE9HOnJldHVybiB0aGlzLl9hZHZhbmNlZExvZ1dyaXRlcj90aGlzLl9jbGllbnRMb2dnZXJbdGhpcy5fYWR2YW5jZWRMb2dXcml0ZXJdKG4pfHxuOiIifX19LHtrZXk6ImlzTGV2ZWxFbmFibGVkIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gZT49dGhpcy5fbGV2ZWx9fSx7a2V5OiJoYXNDbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJuIG51bGwhPT10aGlzLl9jbGllbnRMb2dnZXJ9fSx7a2V5OiJnZXRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWUucHJlZml4fHx0ZTtyZXR1cm4gdGhpcy5fbG9nc0Rlc3RpbmF0aW9uPT09Yz90aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyOm5ldyBjZShuKX19LHtrZXk6InVwZGF0ZUxvZ2dlckNvbmZpZyIsdmFsdWU6ZnVuY3Rpb24oZSl7dmFyIG49ZXx8e307dGhpcy5fbGV2ZWw9bi5sZXZlbHx8b2UuSU5GTyx0aGlzLl9hZHZhbmNlZExvZ1dyaXRlcj0id2FybiIsbi5hZHZhbmNlZExvZ1dyaXRlciYmKHRoaXMuX2FkdmFuY2VkTG9nV3JpdGVyPW4uYWR2YW5jZWRMb2dXcml0ZXIpLG4uY3VzdG9taXplZExvZ2dlciYmIm9iamVjdCI9PT1aKG4uY3VzdG9taXplZExvZ2dlcikmJih0aGlzLnVzZUNsaWVudExvZ2dlcj0hMCksdGhpcy5fY2xpZW50TG9nZ2VyPW4ubG9nZ2VyfHx0aGlzLnNlbGVjdExvZ2dlcihuKSx0aGlzLl9sb2dzRGVzdGluYXRpb249cixuLmRlYnVnJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPWMpLG4ubG9nZ2VyJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPWkpfX0se2tleToic2VsZWN0TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gZS5jdXN0b21pemVkTG9nZ2VyJiYib2JqZWN0Ij09PVooZS5jdXN0b21pemVkTG9nZ2VyKT9lLmN1c3RvbWl6ZWRMb2dnZXI6ZS51c2VEZWZhdWx0TG9nZ2VyPyh0aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyPWFlKCksdGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcik6bnVsbH19XSksZX0oKSxpZT1mdW5jdGlvbigpe2Z1bmN0aW9uIGUoKXtRKHRoaXMsZSl9cmV0dXJuIGVlKGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJhZHZhbmNlZExvZyIsdmFsdWU6ZnVuY3Rpb24oKXt9fV0pLGV9KCksY2U9ZnVuY3Rpb24oZSl7ZnVuY3Rpb24gbihlKXt2YXIgdDtyZXR1cm4gUSh0aGlzLG4pLCh0PVgodGhpcywkKG4pLmNhbGwodGhpcykpKS5wcmVmaXg9ZXx8dGUsdH1yZXR1cm4gZnVuY3Rpb24oZSxuKXtpZigiZnVuY3Rpb24iIT10eXBlb2YgbiYmbnVsbCE9PW4pdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24iKTtlLnByb3RvdHlwZT1PYmplY3QuY3JlYXRlKG4mJm4ucHJvdG90eXBlLHtjb25zdHJ1Y3Rvcjp7dmFsdWU6ZSx3cml0YWJsZTohMCxjb25maWd1cmFibGU6ITB9fSksbiYmSyhlLG4pfShuLGllKSxlZShuLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLkRFQlVHLG4pfX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLklORk8sbil9fSx7a2V5OiJ3YXJuIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2cob2UuV0FSTixuKX19LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2cob2UuRVJST1Isbil9fSx7a2V5OiJhZHZhbmNlZExvZyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLkFEVkFOQ0VEX0xPRyxuKX19LHtrZXk6Il9zaG91bGRMb2ciLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBzZS5oYXNDbGllbnRMb2dnZXIoKSYmc2UuaXNMZXZlbEVuYWJsZWQoZSl9fSx7a2V5OiJfd3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtyZXR1cm4gc2Uud3JpdGVUb0NsaWVudExvZ2dlcihlLG4pfX0se2tleToiX2xvZyIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLl9zaG91bGRMb2coZSkpe3ZhciB0PXNlLnVzZUNsaWVudExvZ2dlcj9uOnRoaXMuX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudChuLGUpO3JldHVybiB0aGlzLl93cml0ZVRvQ2xpZW50TG9nZ2VyKGUsdCl9fX0se2tleToiX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudCIsdmFsdWU6ZnVuY3Rpb24oZSxuKXt2YXIgdD1uZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpLG89dGhpcy5fZ2V0TG9nTGV2ZWxCeVZhbHVlKG4pLHI9IlsiLmNvbmNhdCh0LCJdWyIpLmNvbmNhdChvLCJdIik7dGhpcy5wcmVmaXgmJihyKz10aGlzLnByZWZpeCsiICIpLHRoaXMub3B0aW9ucyYmKHRoaXMub3B0aW9ucy5wcmVmaXg/cis9IiAiK3RoaXMub3B0aW9ucy5wcmVmaXgrIjoiOnIrPSIiLHRoaXMub3B0aW9ucy5sb2dNZXRhRGF0YT9yKz0iIE1ldGEgZGF0YTogIitKU09OLnN0cmluZ2lmeSh0aGlzLm9wdGlvbnMubG9nTWV0YURhdGEpOnIrPSIiKTtmb3IodmFyIGk9MDtpPGUubGVuZ3RoO2krKyl7dmFyIGM9ZVtpXTtyKz10aGlzLl9jb252ZXJ0VG9TdHJpbmcoYykrIiAifXJldHVybiByfX0se2tleToiX2dldExvZ0xldmVsQnlWYWx1ZSIsdmFsdWU6ZnVuY3Rpb24oZSl7c3dpdGNoKGUpe2Nhc2UgMTA6cmV0dXJuIkRFQlVHIjtjYXNlIDIwOnJldHVybiJJTkZPIjtjYXNlIDMwOnJldHVybiJXQVJOIjtjYXNlIDQwOnJldHVybiJFUlJPUiI7Y2FzZSA1MDpyZXR1cm4iQURWQU5DRURfTE9HIn19fSx7a2V5OiJfY29udmVydFRvU3RyaW5nIix2YWx1ZTpmdW5jdGlvbihlKXt0cnl7aWYoIWUpcmV0dXJuIiI7aWYoVi5pc1N0cmluZyhlKSlyZXR1cm4gZTtpZihWLmlzT2JqZWN0KGUpJiZWLmlzRnVuY3Rpb24oZS50b1N0cmluZykpe3ZhciBuPWUudG9TdHJpbmcoKTtpZigiW29iamVjdCBPYmplY3RdIiE9PW4pcmV0dXJuIG59cmV0dXJuIEpTT04uc3RyaW5naWZ5KGUpfWNhdGNoKG4pe3JldHVybiBjb25zb2xlLmVycm9yKCJFcnJvciB3aGlsZSBjb252ZXJ0aW5nIGFyZ3VtZW50IHRvIHN0cmluZyIsZSxuKSwiIn19fV0pLG59KCksYWU9ZnVuY3Rpb24oKXt2YXIgZT1uZXcgaWU7cmV0dXJuIGUuZGVidWc9ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS5kZWJ1Zy5hcHBseSh3aW5kb3cuY29uc29sZSxbXS5jb25jYXQobikpfSxlLmluZm89ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS5pbmZvLmFwcGx5KHdpbmRvdy5jb25zb2xlLFtdLmNvbmNhdChuKSl9LGUud2Fybj1mdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiBjb25zb2xlLndhcm4uYXBwbHkod2luZG93LmNvbnNvbGUsW10uY29uY2F0KG4pKX0sZS5lcnJvcj1mdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiBjb25zb2xlLmVycm9yLmFwcGx5KHdpbmRvdy5jb25zb2xlLFtdLmNvbmNhdChuKSl9LGV9LHNlPW5ldyByZTtmdW5jdGlvbiB1ZShlLG4pe2Zvcih2YXIgdD0wO3Q8bi5sZW5ndGg7dCsrKXt2YXIgbz1uW3RdO28uZW51bWVyYWJsZT1vLmVudW1lcmFibGV8fCExLG8uY29uZmlndXJhYmxlPSEwLCJ2YWx1ZSJpbiBvJiYoby53cml0YWJsZT0hMCksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsby5rZXksbyl9fXZhciBsZT1mdW5jdGlvbigpe2Z1bmN0aW9uIGUobil7dmFyIHQ9YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOmE7IWZ1bmN0aW9uKGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9KHRoaXMsZSksdGhpcy5udW1BdHRlbXB0cz0wLHRoaXMuZXhlY3V0b3I9bix0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbj0hMSx0aGlzLmRlZmF1bHRSZXRyeT10fXZhciBuLHQsbztyZXR1cm4gbj1lLCh0PVt7a2V5OiJyZXRyeSIsdmFsdWU6ZnVuY3Rpb24oKXt2YXIgZT10aGlzO3RoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9ufHwodGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITAsc2V0VGltZW91dChmdW5jdGlvbigpe2UuX2V4ZWN1dGUoKX0sdGhpcy5fZ2V0RGVsYXkoKSkpfX0se2tleToiX2V4ZWN1dGUiLHZhbHVlOmZ1bmN0aW9uKCl7dGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITEsdGhpcy5leGVjdXRvcigpLHRoaXMubnVtQXR0ZW1wdHMrK319LHtrZXk6ImNvbm5lY3RlZCIsdmFsdWU6ZnVuY3Rpb24oKXt0aGlzLm51bUF0dGVtcHRzPTB9fSx7a2V5OiJfZ2V0RGVsYXkiLHZhbHVlOmZ1bmN0aW9uKCl7dmFyIGU9TWF0aC5wb3coMix0aGlzLm51bUF0dGVtcHRzKSp0aGlzLmRlZmF1bHRSZXRyeTtyZXR1cm4gZTw9M2U0P2U6M2U0fX0se2tleToiZ2V0SXNDb25uZWN0ZWQiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJuIXRoaXMubnVtQXR0ZW1wdHN9fV0pJiZ1ZShuLnByb3RvdHlwZSx0KSxvJiZ1ZShuLG8pLGV9KCk7dC5kKG4sImEiLGZ1bmN0aW9uKCl7cmV0dXJuIGRlfSk7dmFyIGZlPWZ1bmN0aW9uKCl7dmFyIGU9c2UuZ2V0TG9nZ2VyKHtwcmVmaXg6c30pLG49Vi5pc05ldHdvcmtPbmxpbmUoKSx0PXtwcmltYXJ5Om51bGwsc2Vjb25kYXJ5Om51bGx9LG89e3JlY29ubmVjdFdlYlNvY2tldDohMCx3ZWJzb2NrZXRJbml0RmFpbGVkOiExLGV4cG9uZW50aWFsQmFja09mZlRpbWU6MWUzLGV4cG9uZW50aWFsVGltZW91dEhhbmRsZTpudWxsLGxpZmVUaW1lVGltZW91dEhhbmRsZTpudWxsLHdlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkOm51bGwsY29ublN0YXRlOm51bGx9LHI9e2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OjAsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6bnVsbCxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSxpPXtwZW5kaW5nUmVzcG9uc2U6ITEsaW50ZXJ2YWxIYW5kbGU6bnVsbH0sYz17aW5pdEZhaWx1cmU6bmV3IFNldCxnZXRXZWJTb2NrZXRUcmFuc3BvcnQ6bnVsbCxzdWJzY3JpcHRpb25VcGRhdGU6bmV3IFNldCxzdWJzY3JpcHRpb25GYWlsdXJlOm5ldyBTZXQsdG9waWM6bmV3IE1hcCxhbGxNZXNzYWdlOm5ldyBTZXQsY29ubmVjdGlvbkdhaW46bmV3IFNldCxjb25uZWN0aW9uTG9zdDpuZXcgU2V0LGNvbm5lY3Rpb25PcGVuOm5ldyBTZXQsY29ubmVjdGlvbkNsb3NlOm5ldyBTZXR9LGE9e2Nvbm5Db25maWc6bnVsbCxwcm9taXNlSGFuZGxlOm51bGwscHJvbWlzZUNvbXBsZXRlZDohMH0scT17c3Vic2NyaWJlZDpuZXcgU2V0LHBlbmRpbmc6bmV3IFNldCxzdWJzY3JpcHRpb25IaXN0b3J5Om5ldyBTZXR9LEo9e3Jlc3BvbnNlQ2hlY2tJbnRlcnZhbElkOm51bGwscmVxdWVzdENvbXBsZXRlZDohMCxyZVN1YnNjcmliZUludGVydmFsSWQ6bnVsbCxjb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzOjAsY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdDowfSxCPW5ldyBsZShmdW5jdGlvbigpe2hlKCl9KSxYPW5ldyBTZXQoW0cseixQXSksJD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe2lmKG4hPT1WLmlzTmV0d29ya09ubGluZSgpKXtpZighKG49Vi5pc05ldHdvcmtPbmxpbmUoKSkpcmV0dXJuIGUuYWR2YW5jZWRMb2codSksdm9pZCBDZShlLmluZm8odSkpO3ZhciB0PXRlKCk7biYmKCF0fHxZKHQsV2ViU29ja2V0LkNMT1NJTkcpfHxZKHQsV2ViU29ja2V0LkNMT1NFRCkpJiYoZS5hZHZhbmNlZExvZyhsKSxDZShlLmluZm8obCkpLGhlKCkpfX0sMjUwKSxLPWZ1bmN0aW9uKG4sdCl7bi5mb3JFYWNoKGZ1bmN0aW9uKG4pe3RyeXtuKHQpfWNhdGNoKG4pe0NlKGUuZXJyb3IoIkVycm9yIGV4ZWN1dGluZyBjYWxsYmFjayIsbikpfX0pfSxaPWZ1bmN0aW9uKGUpe2lmKG51bGw9PT1lKXJldHVybiJOVUxMIjtzd2l0Y2goZS5yZWFkeVN0YXRlKXtjYXNlIFdlYlNvY2tldC5DT05ORUNUSU5HOnJldHVybiJDT05ORUNUSU5HIjtjYXNlIFdlYlNvY2tldC5PUEVOOnJldHVybiJPUEVOIjtjYXNlIFdlYlNvY2tldC5DTE9TSU5HOnJldHVybiJDTE9TSU5HIjtjYXNlIFdlYlNvY2tldC5DTE9TRUQ6cmV0dXJuIkNMT1NFRCI7ZGVmYXVsdDpyZXR1cm4iVU5ERUZJTkVEIn19LFE9ZnVuY3Rpb24oKXt2YXIgbj1hcmd1bWVudHMubGVuZ3RoPjAmJnZvaWQgMCE9PWFyZ3VtZW50c1swXT9hcmd1bWVudHNbMF06IiI7Q2UoZS5kZWJ1ZygiWyIrbisiXSBQcmltYXJ5IFdlYlNvY2tldDogIitaKHQucHJpbWFyeSkrIiB8IFNlY29uZGFyeSBXZWJTb2NrZXQ6ICIrWih0LnNlY29uZGFyeSkpKX0sWT1mdW5jdGlvbihlLG4pe3JldHVybiBlJiZlLnJlYWR5U3RhdGU9PT1ufSxlZT1mdW5jdGlvbihlKXtyZXR1cm4gWShlLFdlYlNvY2tldC5PUEVOKX0sbmU9ZnVuY3Rpb24oZSl7cmV0dXJuIG51bGw9PT1lfHx2b2lkIDA9PT1lLnJlYWR5U3RhdGV8fFkoZSxXZWJTb2NrZXQuQ0xPU0VEKX0sdGU9ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXQuc2Vjb25kYXJ5P3Quc2Vjb25kYXJ5OnQucHJpbWFyeX0sb2U9ZnVuY3Rpb24oKXtyZXR1cm4gZWUodGUoKSl9LHJlPWZ1bmN0aW9uKCl7aWYoaS5wZW5kaW5nUmVzcG9uc2UpcmV0dXJuIGUuYWR2YW5jZWRMb2coZCksQ2UoZS53YXJuKGQpKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGkucGVuZGluZ1Jlc3BvbnNlPSExLHZvaWQgaGUoKTtvZSgpPyhDZShlLmRlYnVnKGcpKSx0ZSgpLnNlbmQodmUoUCkpLGkucGVuZGluZ1Jlc3BvbnNlPSEwKTooZS5hZHZhbmNlZExvZyhiKSxDZShlLndhcm4oYikpLFEoInNlbmRIZWFydEJlYXQiKSxoZSgpKX0saWU9ZnVuY3Rpb24oKXtlLmFkdmFuY2VkTG9nKFIpLG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZT0xZTMsaS5wZW5kaW5nUmVzcG9uc2U9ITEsby5yZWNvbm5lY3RXZWJTb2NrZXQ9ITAsY2xlYXJUaW1lb3V0KG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGNsZWFyVGltZW91dChvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZSksY2xlYXJUaW1lb3V0KG8ud2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQpfSxjZT1mdW5jdGlvbigpe0ouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wLEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLGNsZWFySW50ZXJ2YWwoSi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZCksY2xlYXJJbnRlcnZhbChKLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZCl9LGFlPWZ1bmN0aW9uKCl7ci5jb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudD0wLHIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU9bnVsbCxyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wPW51bGx9LHVlPWZ1bmN0aW9uKCl7Qi5jb25uZWN0ZWQoKTt0cnl7ZS5hZHZhbmNlZExvZyh5KSxDZShlLmluZm8oeSkpLFEoIndlYlNvY2tldE9uT3BlbiIpLG51bGwhPT1vLmNvbm5TdGF0ZSYmby5jb25uU3RhdGUhPT1VfHxLKGMuY29ubmVjdGlvbkdhaW4pLG8uY29ublN0YXRlPUg7dmFyIG49RGF0ZS5ub3coKTtLKGMuY29ubmVjdGlvbk9wZW4se2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OnIuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpyLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wLGNvbm5lY3Rpb25Fc3RhYmxpc2hlZFRpbWU6bix0aW1lVG9Db25uZWN0Om4tci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSx0aW1lV2l0aG91dENvbm5lY3Rpb246ci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD9uLXIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6bnVsbH0pLGFlKCksaWUoKSx0ZSgpLm9wZW5UaW1lc3RhbXA9RGF0ZS5ub3coKSwwPT09cS5zdWJzY3JpYmVkLnNpemUmJmVlKHQuc2Vjb25kYXJ5KSYmZ2UodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IiksKHEuc3Vic2NyaWJlZC5zaXplPjB8fHEucGVuZGluZy5zaXplPjApJiYoZWUodC5zZWNvbmRhcnkpJiZDZShlLmluZm8oIlN1YnNjcmliaW5nIHNlY29uZGFyeSB3ZWJzb2NrZXQgdG8gdG9waWNzIG9mIHByaW1hcnkgd2Vic29ja2V0IikpLHEuc3Vic2NyaWJlZC5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Euc3Vic2NyaXB0aW9uSGlzdG9yeS5hZGQoZSkscS5wZW5kaW5nLmFkZChlKX0pLHEuc3Vic2NyaWJlZC5jbGVhcigpLHBlKCkpLHJlKCksaS5pbnRlcnZhbEhhbmRsZT1zZXRJbnRlcnZhbChyZSwxZTQpO3ZhciBzPTFlMyphLmNvbm5Db25maWcud2ViU29ja2V0VHJhbnNwb3J0LnRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzO0NlKGUuZGVidWcoIlNjaGVkdWxpbmcgV2ViU29ja2V0IG1hbmFnZXIgcmVjb25uZWN0aW9uLCBhZnRlciBkZWxheSAiK3MrIiBtcyIpKSxvLmxpZmVUaW1lVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7Q2UoZS5kZWJ1ZygiU3RhcnRpbmcgc2NoZWR1bGVkIFdlYlNvY2tldCBtYW5hZ2VyIHJlY29ubmVjdGlvbiIpKSxoZSgpfSxzKX1jYXRjaChuKXtDZShlLmVycm9yKCJFcnJvciBhZnRlciBlc3RhYmxpc2hpbmcgV2ViU29ja2V0IGNvbm5lY3Rpb24iLG4pKX19LGZlPWZ1bmN0aW9uKG4pe1EoIndlYlNvY2tldE9uRXJyb3IiKSxlLmFkdmFuY2VkTG9nKHYsSlNPTi5zdHJpbmdpZnkobikpLENlKGUuZXJyb3IodixKU09OLnN0cmluZ2lmeShuKSkpLEIuZ2V0SXNDb25uZWN0ZWQoKT9oZSgpOkIucmV0cnkoKX0sZGU9ZnVuY3Rpb24obil7dmFyIG89SlNPTi5wYXJzZShuLmRhdGEpO3N3aXRjaChvLnRvcGljKXtjYXNlIEc6aWYoQ2UoZS5kZWJ1ZygiU3Vic2NyaXB0aW9uIE1lc3NhZ2UgcmVjZWl2ZWQgZnJvbSB3ZWJTb2NrZXQgc2VydmVyIixuLmRhdGEpKSxKLnJlcXVlc3RDb21wbGV0ZWQ9ITAsSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsInN1Y2Nlc3MiPT09by5jb250ZW50LnN0YXR1cylKLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCxvLmNvbnRlbnQudG9waWNzLmZvckVhY2goZnVuY3Rpb24oZSl7cS5zdWJzY3JpcHRpb25IaXN0b3J5LmRlbGV0ZShlKSxxLnBlbmRpbmcuZGVsZXRlKGUpLHEuc3Vic2NyaWJlZC5hZGQoZSl9KSwwPT09cS5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemU/ZWUodC5zZWNvbmRhcnkpJiYoQ2UoZS5pbmZvKCJTdWNjZXNzZnVsbHkgc3Vic2NyaWJlZCBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIGFsbCB0b3BpY3Mgb2YgcHJpbWFyeSB3ZWJzb2NrZXQiKSksZ2UodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IikpOnBlKCksSyhjLnN1YnNjcmlwdGlvblVwZGF0ZSxvKTtlbHNle2lmKGNsZWFySW50ZXJ2YWwoSi5yZVN1YnNjcmliZUludGVydmFsSWQpLCsrSi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzLDU9PT1KLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHMpcmV0dXJuIEsoYy5zdWJzY3JpcHRpb25GYWlsdXJlLG8pLHZvaWQoSi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTApO0oucmVTdWJzY3JpYmVJbnRlcnZhbElkPXNldEludGVydmFsKGZ1bmN0aW9uKCl7cGUoKX0sNTAwKX1icmVhaztjYXNlIFA6Q2UoZS5kZWJ1ZyhwKSksaS5wZW5kaW5nUmVzcG9uc2U9ITE7YnJlYWs7ZGVmYXVsdDppZihvLnRvcGljKXtpZihlLmFkdmFuY2VkTG9nKEQsby50b3BpYyksQ2UoZS5kZWJ1ZyhEK28udG9waWMpKSxlZSh0LnByaW1hcnkpJiZlZSh0LnNlY29uZGFyeSkmJjA9PT1xLnN1YnNjcmlwdGlvbkhpc3Rvcnkuc2l6ZSYmdGhpcz09PXQucHJpbWFyeSlyZXR1cm4gdm9pZCBDZShlLndhcm4oIklnbm9yaW5nIE1lc3NhZ2UgZm9yIFRvcGljICIrby50b3BpYysiLCB0byBhdm9pZCBkdXBsaWNhdGVzIikpO2lmKDA9PT1jLmFsbE1lc3NhZ2Uuc2l6ZSYmMD09PWMudG9waWMuc2l6ZSlyZXR1cm4gdm9pZCBDZShlLndhcm4oIk5vIHJlZ2lzdGVyZWQgY2FsbGJhY2sgbGlzdGVuZXIgZm9yIFRvcGljIixvLnRvcGljKSk7ZS5hZHZhbmNlZExvZyhNLG8udG9waWMpLEsoYy5hbGxNZXNzYWdlLG8pLGMudG9waWMuaGFzKG8udG9waWMpJiZLKGMudG9waWMuZ2V0KG8udG9waWMpLG8pfWVsc2Ugby5tZXNzYWdlPyhlLmFkdmFuY2VkTG9nKHgsbyksQ2UoZS53YXJuKHgsbykpKTooZS5hZHZhbmNlZExvZyhqLG8pLENlKGUud2FybihqLG8pKSl9fSxwZT1mdW5jdGlvbiBuKCl7aWYoSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PjMpcmV0dXJuIENlKGUud2FybigiSWdub3Jpbmcgc3Vic2NyaWJlUGVuZGluZ1RvcGljcyBzaW5jZSB3ZSBoYXZlIGV4aGF1c3RlZCBtYXggc3Vic2NyaXB0aW9uIHJldHJpZXMgd2l0aCBubyByZXNwb25zZSIpKSx2b2lkIEsoYy5zdWJzY3JpcHRpb25GYWlsdXJlLFYuZ2V0U3Vic2NyaXB0aW9uUmVzcG9uc2UoRywhMSxBcnJheS5mcm9tKHEucGVuZGluZykpKTtvZSgpPzAhPT1BcnJheS5mcm9tKHEucGVuZGluZykubGVuZ3RoJiYoY2xlYXJJbnRlcnZhbChKLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkKSx0ZSgpLnNlbmQodmUoRyx7dG9waWNzOkFycmF5LmZyb20ocS5wZW5kaW5nKX0pKSxKLnJlcXVlc3RDb21wbGV0ZWQ9ITEsSi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe0oucmVxdWVzdENvbXBsZXRlZHx8KCsrSi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0LG4oKSl9LDFlMykpOkNlKGUud2FybigiSWdub3Jpbmcgc3Vic2NyaWJlUGVuZGluZ1RvcGljcyBjYWxsIHNpbmNlIERlZmF1bHQgV2ViU29ja2V0IGlzIG5vdCBvcGVuIikpfSxnZT1mdW5jdGlvbihuLHQpe1kobixXZWJTb2NrZXQuQ09OTkVDVElORyl8fFkobixXZWJTb2NrZXQuT1BFTik/bi5jbG9zZSgxZTMsdCk6Q2UoZS53YXJuKCJJZ25vcmluZyBXZWJTb2NrZXQgQ2xvc2UgcmVxdWVzdCwgV2ViU29ja2V0IFN0YXRlOiAiK1oobikpKX0sYmU9ZnVuY3Rpb24oZSl7Z2UodC5wcmltYXJ5LCJbUHJpbWFyeV0gV2ViU29ja2V0ICIrZSksZ2UodC5zZWNvbmRhcnksIltTZWNvbmRhcnldIFdlYlNvY2tldCAiK2UpfSx5ZT1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQrKzt2YXIgbj1WLmFkZEppdHRlcihvLmV4cG9uZW50aWFsQmFja09mZlRpbWUsLjMpO0RhdGUubm93KCkrbjw9YS5jb25uQ29uZmlnLnVybENvbm5WYWxpZFRpbWU/KGUuYWR2YW5jZWRMb2coUyksQ2UoZS5kZWJ1ZyhTK24rIiBtcyIpKSxvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZT1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7cmV0dXJuIGtlKCl9LG4pLG8uZXhwb25lbnRpYWxCYWNrT2ZmVGltZSo9Mik6KGUuYWR2YW5jZWRMb2coaCksQ2UoZS53YXJuKGgpKSxoZSgpKX0sbWU9ZnVuY3Rpb24obil7aWUoKSxjZSgpLGUuYWR2YW5jZWRMb2coayxuKSxDZShlLmVycm9yKGspKSxvLndlYnNvY2tldEluaXRGYWlsZWQ9ITAsYmUodyksY2xlYXJJbnRlcnZhbCgkKSxLKGMuaW5pdEZhaWx1cmUse2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OnIuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZSxyZWFzb246bn0pLGFlKCl9LHZlPWZ1bmN0aW9uKGUsbil7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHt0b3BpYzplLGNvbnRlbnQ6bn0pfSxTZT1mdW5jdGlvbihuKXtyZXR1cm4hIShWLmlzT2JqZWN0KG4pJiZWLmlzT2JqZWN0KG4ud2ViU29ja2V0VHJhbnNwb3J0KSYmVi5pc05vbkVtcHR5U3RyaW5nKG4ud2ViU29ja2V0VHJhbnNwb3J0LnVybCkmJlYudmFsaWRXU1VybChuLndlYlNvY2tldFRyYW5zcG9ydC51cmwpJiYxZTMqbi53ZWJTb2NrZXRUcmFuc3BvcnQudHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHM+PTNlNSl8fChDZShlLmVycm9yKCJJbnZhbGlkIFdlYlNvY2tldCBDb25uZWN0aW9uIENvbmZpZ3VyYXRpb24iLG4pKSwhMSl9LGhlPWZ1bmN0aW9uKCl7aWYoIVYuaXNOZXR3b3JrT25saW5lKCkpcmV0dXJuIGUuYWR2YW5jZWRMb2coZiksdm9pZCBDZShlLmluZm8oZikpO2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClDZShlLmRlYnVnKCJXZWJTb2NrZXQgSW5pdCBoYWQgZmFpbGVkLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpKTtlbHNle2lmKGEucHJvbWlzZUNvbXBsZXRlZClyZXR1cm4gaWUoKSxlLmFkdmFuY2VkTG9nKEMpLENlKGUuaW5mbyhDKSksci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZT1yLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lfHxEYXRlLm5vdygpLGEucHJvbWlzZUNvbXBsZXRlZD0hMSxhLnByb21pc2VIYW5kbGU9Yy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQoKSxhLnByb21pc2VIYW5kbGUudGhlbihmdW5jdGlvbihuKXtyZXR1cm4gYS5wcm9taXNlQ29tcGxldGVkPSEwLGUuYWR2YW5jZWRMb2coTCksQ2UoZS5kZWJ1ZyhMLG4pKSxTZShuKT8oYS5jb25uQ29uZmlnPW4sYS5jb25uQ29uZmlnLnVybENvbm5WYWxpZFRpbWU9RGF0ZS5ub3coKSs4NWUzLGtlKCkpOihtZSgiSW52YWxpZCBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK24pLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfSl9LGZ1bmN0aW9uKG4pe3JldHVybiBhLnByb21pc2VDb21wbGV0ZWQ9ITAsZS5hZHZhbmNlZExvZyhUKSxDZShlLmVycm9yKFQsbikpLFYuaXNOZXR3b3JrRmFpbHVyZShuKT8oZS5hZHZhbmNlZExvZyhPK0pTT04uc3RyaW5naWZ5KG4pKSxDZShlLmluZm8oTytKU09OLnN0cmluZ2lmeShuKSkpLEIucmV0cnkoKSk6bWUoIkZhaWxlZCB0byBmZXRjaCB3ZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK0pTT04uc3RyaW5naWZ5KG4pKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH19KTtDZShlLmRlYnVnKCJUaGVyZSBpcyBhbiBvbmdvaW5nIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCwgdGhpcyByZXF1ZXN0IHdpbGwgYmUgaWdub3JlZCIpKX19LGtlPWZ1bmN0aW9uKCl7aWYoby53ZWJzb2NrZXRJbml0RmFpbGVkKXJldHVybiBDZShlLmluZm8oIndlYi1zb2NrZXQgaW5pdGlhbGl6aW5nIGhhZCBmYWlsZWQsIGFib3J0aW5nIHJlLWluaXQiKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2lmKCFWLmlzTmV0d29ya09ubGluZSgpKXJldHVybiBDZShlLndhcm4oIlN5c3RlbSBpcyBvZmZsaW5lIGFib3J0aW5nIHdlYi1zb2NrZXQgaW5pdCIpKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH07ZS5hZHZhbmNlZExvZyhXKSxDZShlLmluZm8oVykpLFEoImluaXRXZWJTb2NrZXQiKTt0cnl7aWYoU2UoYS5jb25uQ29uZmlnKSl7dmFyIG49bnVsbDtyZXR1cm4gZWUodC5wcmltYXJ5KT8oQ2UoZS5kZWJ1ZygiUHJpbWFyeSBTb2NrZXQgY29ubmVjdGlvbiBpcyBhbHJlYWR5IG9wZW4iKSksWSh0LnNlY29uZGFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChDZShlLmRlYnVnKCJFc3RhYmxpc2hpbmcgYSBzZWNvbmRhcnkgd2ViLXNvY2tldCBjb25uZWN0aW9uIikpLEIubnVtQXR0ZW1wdHM9MCx0LnNlY29uZGFyeT13ZSgpKSxuPXQuc2Vjb25kYXJ5KTooWSh0LnByaW1hcnksV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHwoQ2UoZS5kZWJ1ZygiRXN0YWJsaXNoaW5nIGEgcHJpbWFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSksdC5wcmltYXJ5PXdlKCkpLG49dC5wcmltYXJ5KSxvLndlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtlZShuKXx8eWUoKX0sMWUzKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMX19fWNhdGNoKG4pe3JldHVybiBDZShlLmVycm9yKCJFcnJvciBJbml0aWFsaXppbmcgd2ViLXNvY2tldC1tYW5hZ2VyIixuKSksbWUoIkZhaWxlZCB0byBpbml0aWFsaXplIG5ldyBXZWJTb2NrZXQ6ICIrbi5tZXNzYWdlKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH19fSx3ZT1mdW5jdGlvbigpe3ZhciBuPW5ldyBXZWJTb2NrZXQoYS5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC51cmwpO3JldHVybiBuLmFkZEV2ZW50TGlzdGVuZXIoIm9wZW4iLHVlKSxuLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLGRlKSxuLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIixmZSksbi5hZGRFdmVudExpc3RlbmVyKCJjbG9zZSIsZnVuY3Rpb24oaSl7cmV0dXJuIGZ1bmN0aW9uKG4saSl7ZS5hZHZhbmNlZExvZyhtLEpTT04uc3RyaW5naWZ5KG4pKSxDZShlLmluZm8obSxKU09OLnN0cmluZ2lmeShuKSkpLFEoIndlYlNvY2tldE9uQ2xvc2UgYmVmb3JlLWNsZWFudXAiKSxLKGMuY29ubmVjdGlvbkNsb3NlLHtvcGVuVGltZXN0YW1wOmkub3BlblRpbWVzdGFtcCxjbG9zZVRpbWVzdGFtcDpEYXRlLm5vdygpLGNvbm5lY3Rpb25EdXJhdGlvbjpEYXRlLm5vdygpLWkub3BlblRpbWVzdGFtcCxjb2RlOm4uY29kZSxyZWFzb246bi5yZWFzb259KSxuZSh0LnByaW1hcnkpJiYodC5wcmltYXJ5PW51bGwpLG5lKHQuc2Vjb25kYXJ5KSYmKHQuc2Vjb25kYXJ5PW51bGwpLG8ucmVjb25uZWN0V2ViU29ja2V0JiYoZWUodC5wcmltYXJ5KXx8ZWUodC5zZWNvbmRhcnkpP25lKHQucHJpbWFyeSkmJmVlKHQuc2Vjb25kYXJ5KSYmKENlKGUuaW5mbygiW1ByaW1hcnldIFdlYlNvY2tldCBDbGVhbmx5IENsb3NlZCIpKSx0LnByaW1hcnk9dC5zZWNvbmRhcnksdC5zZWNvbmRhcnk9bnVsbCk6KENlKGUud2FybigiTmVpdGhlciBwcmltYXJ5IHdlYnNvY2tldCBhbmQgbm9yIHNlY29uZGFyeSB3ZWJzb2NrZXQgaGF2ZSBvcGVuIGNvbm5lY3Rpb25zLCBhdHRlbXB0aW5nIHRvIHJlLWVzdGFibGlzaCBjb25uZWN0aW9uIikpLG8uY29ublN0YXRlPT09VT9DZShlLmluZm8oIklnbm9yaW5nIGNvbm5lY3Rpb25Mb3N0IGNhbGxiYWNrIGludm9jYXRpb24iKSk6KEsoYy5jb25uZWN0aW9uTG9zdCx7b3BlblRpbWVzdGFtcDppLm9wZW5UaW1lc3RhbXAsY2xvc2VUaW1lc3RhbXA6RGF0ZS5ub3coKSxjb25uZWN0aW9uRHVyYXRpb246RGF0ZS5ub3coKS1pLm9wZW5UaW1lc3RhbXAsY29kZTpuLmNvZGUscmVhc29uOm4ucmVhc29ufSksci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD1EYXRlLm5vdygpKSxvLmNvbm5TdGF0ZT1VLGhlKCkpLFEoIndlYlNvY2tldE9uQ2xvc2UgYWZ0ZXItY2xlYW51cCIpKX0oaSxuKX0pLG59LENlPWZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlciYmZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpLGV9O3RoaXMuaW5pdD1mdW5jdGlvbihuKXtpZihWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJ0cmFuc3BvcnRIYW5kbGUgbXVzdCBiZSBhIGZ1bmN0aW9uIiksbnVsbD09PWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KXJldHVybiBjLmdldFdlYlNvY2tldFRyYW5zcG9ydD1uLGhlKCk7Q2UoZS53YXJuKCJXZWIgU29ja2V0IE1hbmFnZXIgd2FzIGFscmVhZHkgaW5pdGlhbGl6ZWQiKSl9LHRoaXMub25Jbml0RmFpbHVyZT1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhJKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmluaXRGYWlsdXJlLmFkZChuKSxvLndlYnNvY2tldEluaXRGYWlsZWQmJm4oKSxmdW5jdGlvbigpe3JldHVybiBjLmluaXRGYWlsdXJlLmRlbGV0ZShuKX19LHRoaXMub25Db25uZWN0aW9uT3Blbj1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhOKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25PcGVuLmFkZChuKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShuKX19LHRoaXMub25Db25uZWN0aW9uQ2xvc2U9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coXyksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uQ2xvc2UuYWRkKG4pLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkNsb3NlLmRlbGV0ZShuKX19LHRoaXMub25Db25uZWN0aW9uR2Fpbj1mdW5jdGlvbihuKXtyZXR1cm4gZS5hZHZhbmNlZExvZyhFKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmNvbm5lY3Rpb25HYWluLmFkZChuKSxvZSgpJiZuKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uR2Fpbi5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbkxvc3Q9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coRiksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uTG9zdC5hZGQobiksby5jb25uU3RhdGU9PT1VJiZuKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uTG9zdC5kZWxldGUobil9fSx0aGlzLm9uU3Vic2NyaXB0aW9uVXBkYXRlPWZ1bmN0aW9uKGUpe3JldHVybiBWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnN1YnNjcmlwdGlvblVwZGF0ZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5zdWJzY3JpcHRpb25VcGRhdGUuZGVsZXRlKGUpfX0sdGhpcy5vblN1YnNjcmlwdGlvbkZhaWx1cmU9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coQSksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25GYWlsdXJlLmFkZChuKSxmdW5jdGlvbigpe3JldHVybiBjLnN1YnNjcmlwdGlvbkZhaWx1cmUuZGVsZXRlKG4pfX0sdGhpcy5vbk1lc3NhZ2U9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gVi5hc3NlcnROb3ROdWxsKGUsInRvcGljTmFtZSIpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMudG9waWMuaGFzKGUpP2MudG9waWMuZ2V0KGUpLmFkZChuKTpjLnRvcGljLnNldChlLG5ldyBTZXQoW25dKSksZnVuY3Rpb24oKXtyZXR1cm4gYy50b3BpYy5nZXQoZSkuZGVsZXRlKG4pfX0sdGhpcy5vbkFsbE1lc3NhZ2U9ZnVuY3Rpb24oZSl7cmV0dXJuIFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuYWxsTWVzc2FnZS5hZGQoZSksZnVuY3Rpb24oKXtyZXR1cm4gYy5hbGxNZXNzYWdlLmRlbGV0ZShlKX19LHRoaXMuc3Vic2NyaWJlVG9waWNzPWZ1bmN0aW9uKGUpe1YuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY3MiKSxWLmFzc2VydElzTGlzdChlKSxlLmZvckVhY2goZnVuY3Rpb24oZSl7cS5zdWJzY3JpYmVkLmhhcyhlKXx8cS5wZW5kaW5nLmFkZChlKX0pLEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLHBlKCl9LHRoaXMuc2VuZE1lc3NhZ2U9ZnVuY3Rpb24obil7aWYoVi5hc3NlcnRJc09iamVjdChuLCJwYXlsb2FkIiksdm9pZCAwPT09bi50b3BpY3x8WC5oYXMobi50b3BpYykpQ2UoZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCBJbnZhbGlkIHRvcGljIixuKSk7ZWxzZXt0cnl7bj1KU09OLnN0cmluZ2lmeShuKX1jYXRjaCh0KXtyZXR1cm4gdm9pZCBDZShlLndhcm4oIkVycm9yIHN0cmluZ2lmeSBtZXNzYWdlIixuKSl9b2UoKT90ZSgpLnNlbmQobik6Q2UoZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gaXMgbm90IG9wZW4iKSl9fSx0aGlzLmNsb3NlV2ViU29ja2V0PWZ1bmN0aW9uKCl7aWUoKSxjZSgpLG8ucmVjb25uZWN0V2ViU29ja2V0PSExLGNsZWFySW50ZXJ2YWwoJCksYmUoIlVzZXIgcmVxdWVzdCB0byBjbG9zZSBXZWJTb2NrZXQiKX0sdGhpcy50ZXJtaW5hdGVXZWJTb2NrZXRNYW5hZ2VyPW1lfSxkZT17Y3JlYXRlOmZ1bmN0aW9uKCl7cmV0dXJuIG5ldyBmZX0sc2V0R2xvYmFsQ29uZmlnOmZ1bmN0aW9uKGUpe3ZhciBuPWUmJmUubG9nZ2VyQ29uZmlnO3NlLnVwZGF0ZUxvZ2dlckNvbmZpZyhuKX0sTG9nTGV2ZWw6b2UsTG9nZ2VyOm5lfX0sZnVuY3Rpb24oZSxuLHQpe3ZhciBvOyFmdW5jdGlvbigpeyJ1c2Ugc3RyaWN0Ijt2YXIgcj17bm90X3N0cmluZzovW15zXS8sbm90X2Jvb2w6L1tedF0vLG5vdF90eXBlOi9bXlRdLyxub3RfcHJpbWl0aXZlOi9bXnZdLyxudW1iZXI6L1tkaWVmZ10vLG51bWVyaWNfYXJnOi9bYmNkaWVmZ3V4WF0vLGpzb246L1tqXS8sbm90X2pzb246L1teal0vLHRleHQ6L15bXlx4MjVdKy8sbW9kdWxvOi9eXHgyNXsyfS8scGxhY2Vob2xkZXI6L15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWdpam9zdFR1dnhYXSkvLGtleTovXihbYS16X11bYS16X1xkXSopL2ksa2V5X2FjY2VzczovXlwuKFthLXpfXVthLXpfXGRdKikvaSxpbmRleF9hY2Nlc3M6L15cWyhcZCspXF0vLHNpZ246L15bKy1dL307ZnVuY3Rpb24gaShlKXtyZXR1cm4gZnVuY3Rpb24oZSxuKXt2YXIgdCxvLGMsYSxzLHUsbCxmLGQscD0xLGc9ZS5sZW5ndGgsYj0iIjtmb3Iobz0wO288ZztvKyspaWYoInN0cmluZyI9PXR5cGVvZiBlW29dKWIrPWVbb107ZWxzZSBpZigib2JqZWN0Ij09dHlwZW9mIGVbb10pe2lmKChhPWVbb10pLmtleXMpZm9yKHQ9bltwXSxjPTA7YzxhLmtleXMubGVuZ3RoO2MrKyl7aWYobnVsbD09dCl0aHJvdyBuZXcgRXJyb3IoaSgnW3NwcmludGZdIENhbm5vdCBhY2Nlc3MgcHJvcGVydHkgIiVzIiBvZiB1bmRlZmluZWQgdmFsdWUgIiVzIicsYS5rZXlzW2NdLGEua2V5c1tjLTFdKSk7dD10W2Eua2V5c1tjXV19ZWxzZSB0PWEucGFyYW1fbm8/blthLnBhcmFtX25vXTpuW3ArK107aWYoci5ub3RfdHlwZS50ZXN0KGEudHlwZSkmJnIubm90X3ByaW1pdGl2ZS50ZXN0KGEudHlwZSkmJnQgaW5zdGFuY2VvZiBGdW5jdGlvbiYmKHQ9dCgpKSxyLm51bWVyaWNfYXJnLnRlc3QoYS50eXBlKSYmIm51bWJlciIhPXR5cGVvZiB0JiZpc05hTih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKGkoIltzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlVCIsdCkpO3N3aXRjaChyLm51bWJlci50ZXN0KGEudHlwZSkmJihmPXQ+PTApLGEudHlwZSl7Y2FzZSJiIjp0PXBhcnNlSW50KHQsMTApLnRvU3RyaW5nKDIpO2JyZWFrO2Nhc2UiYyI6dD1TdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KHQsMTApKTticmVhaztjYXNlImQiOmNhc2UiaSI6dD1wYXJzZUludCh0LDEwKTticmVhaztjYXNlImoiOnQ9SlNPTi5zdHJpbmdpZnkodCxudWxsLGEud2lkdGg/cGFyc2VJbnQoYS53aWR0aCk6MCk7YnJlYWs7Y2FzZSJlIjp0PWEucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbChhLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KS50b0V4cG9uZW50aWFsKCk7YnJlYWs7Y2FzZSJmIjp0PWEucHJlY2lzaW9uP3BhcnNlRmxvYXQodCkudG9GaXhlZChhLnByZWNpc2lvbik6cGFyc2VGbG9hdCh0KTticmVhaztjYXNlImciOnQ9YS5wcmVjaXNpb24/U3RyaW5nKE51bWJlcih0LnRvUHJlY2lzaW9uKGEucHJlY2lzaW9uKSkpOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJvIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDgpO2JyZWFrO2Nhc2UicyI6dD1TdHJpbmcodCksdD1hLnByZWNpc2lvbj90LnN1YnN0cmluZygwLGEucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UidCI6dD1TdHJpbmcoISF0KSx0PWEucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAsYS5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJUIjp0PU9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh0KS5zbGljZSg4LC0xKS50b0xvd2VyQ2FzZSgpLHQ9YS5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxhLnByZWNpc2lvbik6dDticmVhaztjYXNlInUiOnQ9cGFyc2VJbnQodCwxMCk+Pj4wO2JyZWFrO2Nhc2UidiI6dD10LnZhbHVlT2YoKSx0PWEucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAsYS5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ4Ijp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KTticmVhaztjYXNlIlgiOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCl9ci5qc29uLnRlc3QoYS50eXBlKT9iKz10Oighci5udW1iZXIudGVzdChhLnR5cGUpfHxmJiYhYS5zaWduP2Q9IiI6KGQ9Zj8iKyI6Ii0iLHQ9dC50b1N0cmluZygpLnJlcGxhY2Uoci5zaWduLCIiKSksdT1hLnBhZF9jaGFyPyIwIj09PWEucGFkX2NoYXI/IjAiOmEucGFkX2NoYXIuY2hhckF0KDEpOiIgIixsPWEud2lkdGgtKGQrdCkubGVuZ3RoLHM9YS53aWR0aCYmbD4wP3UucmVwZWF0KGwpOiIiLGIrPWEuYWxpZ24/ZCt0K3M6IjAiPT09dT9kK3MrdDpzK2QrdCl9cmV0dXJuIGJ9KGZ1bmN0aW9uKGUpe2lmKGFbZV0pcmV0dXJuIGFbZV07dmFyIG4sdD1lLG89W10saT0wO2Zvcig7dDspe2lmKG51bGwhPT0obj1yLnRleHQuZXhlYyh0KSkpby5wdXNoKG5bMF0pO2Vsc2UgaWYobnVsbCE9PShuPXIubW9kdWxvLmV4ZWModCkpKW8ucHVzaCgiJSIpO2Vsc2V7aWYobnVsbD09PShuPXIucGxhY2Vob2xkZXIuZXhlYyh0KSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gdW5leHBlY3RlZCBwbGFjZWhvbGRlciIpO2lmKG5bMl0pe2l8PTE7dmFyIGM9W10scz1uWzJdLHU9W107aWYobnVsbD09PSh1PXIua2V5LmV4ZWMocykpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtmb3IoYy5wdXNoKHVbMV0pOyIiIT09KHM9cy5zdWJzdHJpbmcodVswXS5sZW5ndGgpKTspaWYobnVsbCE9PSh1PXIua2V5X2FjY2Vzcy5leGVjKHMpKSljLnB1c2godVsxXSk7ZWxzZXtpZihudWxsPT09KHU9ci5pbmRleF9hY2Nlc3MuZXhlYyhzKSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gZmFpbGVkIHRvIHBhcnNlIG5hbWVkIGFyZ3VtZW50IGtleSIpO2MucHVzaCh1WzFdKX1uWzJdPWN9ZWxzZSBpfD0yO2lmKDM9PT1pKXRocm93IG5ldyBFcnJvcigiW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCIpO28ucHVzaCh7cGxhY2Vob2xkZXI6blswXSxwYXJhbV9ubzpuWzFdLGtleXM6blsyXSxzaWduOm5bM10scGFkX2NoYXI6bls0XSxhbGlnbjpuWzVdLHdpZHRoOm5bNl0scHJlY2lzaW9uOm5bN10sdHlwZTpuWzhdfSl9dD10LnN1YnN0cmluZyhuWzBdLmxlbmd0aCl9cmV0dXJuIGFbZV09b30oZSksYXJndW1lbnRzKX1mdW5jdGlvbiBjKGUsbil7cmV0dXJuIGkuYXBwbHkobnVsbCxbZV0uY29uY2F0KG58fFtdKSl9dmFyIGE9T2JqZWN0LmNyZWF0ZShudWxsKTtuLnNwcmludGY9aSxuLnZzcHJpbnRmPWMsInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJih3aW5kb3cuc3ByaW50Zj1pLHdpbmRvdy52c3ByaW50Zj1jLHZvaWQgMD09PShvPWZ1bmN0aW9uKCl7cmV0dXJue3NwcmludGY6aSx2c3ByaW50ZjpjfX0uY2FsbChuLHQsbixlKSl8fChlLmV4cG9ydHM9bykpfSgpfSxmdW5jdGlvbihlLG4sdCl7InVzZSBzdHJpY3QiO3QucihuKSxmdW5jdGlvbihlKXt0LmQobiwiV2ViU29ja2V0TWFuYWdlciIsZnVuY3Rpb24oKXtyZXR1cm4gcn0pO3ZhciBvPXQoMCk7ZS5jb25uZWN0PWUuY29ubmVjdHx8e30sY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyPW8uYTt2YXIgcj1vLmF9LmNhbGwodGhpcyx0KDMpKX0sZnVuY3Rpb24oZSxuKXt2YXIgdDt0PWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3Q9dHx8bmV3IEZ1bmN0aW9uKCJyZXR1cm4gdGhpcyIpKCl9Y2F0Y2goZSl7Im9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJih0PXdpbmRvdyl9ZS5leHBvcnRzPXR9XSk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPWFtYXpvbi1jb25uZWN0LXdlYnNvY2tldC1tYW5hZ2VyLmpzLm1hcAoKCi8qKiovIH0pLAoKLyoqKi8gMTUxOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgc29mdHBob25lIGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgcmVwb3J0ZWQgdG8gc2hhcmVkIHdvcmtlci4KICB2YXIgU09GVFBIT05FX0xPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gSG93IGZyZXF1ZW50bHkgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCBzZW50IGRvd25zdHJlYW0KICB2YXIgTE9HU19SRVBPUlRfSU5URVJWQUxfTUlMTElTID0gNTAwMDsKCiAgLy8gVGhlIGRlZmF1bHQgbG9nIHJvbGwgaW50ZXJ2YWwgKDMwbWluKQogIHZhciBERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMID0gMTgwMDAwMDsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgbGV2ZWxzLgogICAqLwogIHZhciBMb2dMZXZlbCA9IHsKICAgIFRFU1Q6ICJURVNUIiwKICAgIFRSQUNFOiAiVFJBQ0UiLAogICAgREVCVUc6ICJERUJVRyIsCiAgICBJTkZPOiAiSU5GTyIsCiAgICBMT0c6ICJMT0ciLAogICAgV0FSTjogIldBUk4iLAogICAgRVJST1I6ICJFUlJPUiIsCiAgICBDUklUSUNBTDogIkNSSVRJQ0FMIgogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIGNvbW1vbiBsb2dnaW5nIGNvbXBvbmVudHMuCiAgICovCiAgdmFyIExvZ0NvbXBvbmVudCA9IHsKICAgIENDUDogImNjcCIsCiAgICBTT0ZUUEhPTkU6ICJzb2Z0cGhvbmUiLAogICAgQ0hBVDogImNoYXQiLAogICAgVEFTSzogInRhc2siCiAgfTsKCiAgLyoqCiAgICogVGhlIG51bWVyaWMgb3JkZXIgb2YgdGhlIGxvZ2dpbmcgbGV2ZWxzIGFib3ZlLgogICAqIFRoZXkgYXJlIHNwYWNlZCB0byBhbGxvdyB0aGUgYWRkaXRpb24gb2Ygb3RoZXIgbG9nCiAgICogbGV2ZWxzIGF0IGEgbGF0ZXIgdGltZS4KICAgKi8KICB2YXIgTG9nTGV2ZWxPcmRlciA9IHsKICAgIFRFU1Q6IDAsCiAgICBUUkFDRTogMTAsCiAgICBERUJVRzogMjAsCiAgICBJTkZPOiAzMCwKICAgIExPRzogNDAsCiAgICBXQVJOOiA1MCwKICAgIEVSUk9SOiAxMDAsCiAgICBDUklUSUNBTDogMjAwCgogIH07CgogIC8qKgogICAqIEEgbWFwIGZyb20gbG9nIGxldmVsIHRvIGNvbnNvbGUgbG9nZ2VyIGZ1bmN0aW9uLgogICAqLwogIHZhciBDT05TT0xFX0xPR0dFUl9NQVAgPSB7CiAgICBUUkFDRTogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgREVCVUc6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIElORk86IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIExPRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5sb2codGV4dCk7IH0sCiAgICBURVNUOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFdBUk46IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUud2Fybih0ZXh0KTsgfSwKICAgIEVSUk9SOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmVycm9yKHRleHQpOyB9LAogICAgQ1JJVElDQUw6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0KICB9OwoKICAvKioKICAqIENoZWNrcyBpZiBpdCBpcyBhIHZhbGlkIGxvZyBjb21wb25lbnQgZW51bQogICovCgogIHZhciBpc1ZhbGlkTG9nQ29tcG9uZW50ID0gZnVuY3Rpb24gKGNvbXBvbmVudCkgewogICAgcmV0dXJuIE9iamVjdC52YWx1ZXMoTG9nQ29tcG9uZW50KS5pbmRleE9mKGNvbXBvbmVudCkgIT09IC0xOwogIH07CgogIC8qKgogICogRXh0cmFjdCB0aGUgY3VzdG9tIGFyZ3VtZW50cyBhcyByZXF1aXJlZCBieSB0aGUgbG9nZ2VyCiAgKi8KICB2YXIgZXh0cmFjdExvZ2dlckFyZ3MgPSBmdW5jdGlvbiAobG9nZ2VyQXJncykgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsb2dnZXJBcmdzLCAwKTsKICAgIHZhciBmaXJzdEFyZyA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBmb3JtYXQ7CiAgICB2YXIgY29tcG9uZW50OwoKICAgIGlmIChpc1ZhbGlkTG9nQ29tcG9uZW50KGZpcnN0QXJnKSkgewogICAgICBjb21wb25lbnQgPSBmaXJzdEFyZzsKICAgICAgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgLy9kZWZhdWx0IHRvIENDUCBjb21wb25lbnQKICAgICAgZm9ybWF0ID0gZmlyc3RBcmc7CiAgICAgIGNvbXBvbmVudCA9IExvZ0NvbXBvbmVudC5DQ1A7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZm9ybWF0OiBmb3JtYXQsCiAgICAgIGNvbXBvbmVudDogY29tcG9uZW50LAogICAgICBhcmdzOiBhcmdzCiAgICB9OwogIH07CgogIC8qKgogICAqIEEgbG9nIGVudHJ5LgogICAqCiAgICogQHBhcmFtIGNvbXBvbmVudCBUaGUgbG9nZ2luZyBjb21wb25lbnQuCiAgICogQHBhcmFtIGxldmVsIFRoZSBsb2cgbGV2ZWwgb2YgdGhpcyBsb2cgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGFpbmVkIGluIHRoZSBsb2cgZW50cnkuCiAgICogQHBhcmFtIGxvZ2dlcklkIFRoZSByb290IGxvZ2dlciBpZC4KICAgKgogICAqIExvZyBlbnRyaWVzIGFyZSBhd2FyZSBvZiB0aGVpciB0aW1lc3RhbXAsIG9yZGVyLAogICAqIGFuZCBjYW4gY29udGFpbiBvYmplY3RzIGFuZCBleGNlcHRpb24gc3RhY2sgdHJhY2VzLgogICAqLwogIHZhciBMb2dFbnRyeSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0LCBsb2dnZXJJZCkgewogICAgdGhpcy5jb21wb25lbnQgPSBjb21wb25lbnQ7CiAgICB0aGlzLmxldmVsID0gbGV2ZWw7CiAgICB0aGlzLnRleHQgPSB0ZXh0OwogICAgdGhpcy50aW1lID0gbmV3IERhdGUoKTsKICAgIHRoaXMuZXhjZXB0aW9uID0gbnVsbDsKICAgIHRoaXMub2JqZWN0cyA9IFtdOwogICAgdGhpcy5saW5lID0gMDsKICAgIHRoaXMuYWdlbnRSZXNvdXJjZUlkID0gbnVsbDsKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKXsKICAgICAgICB0aGlzLmFnZW50UmVzb3VyY2VJZCA9IG5ldyBjb25uZWN0LkFnZW50KCkuX2dldFJlc291cmNlSWQoKTsKICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbnNvbGUubG9nKCJJc3N1ZSBmaW5kaW5nIGFnZW50UmVzb3VyY2VJZDogIiwgZSk7IC8vY2FuJ3QgdXNlIG91ciBsb2dnZXIgaGVyZSBhcyB3ZSBtaWdodCBpbmZpbml0ZWx5IGF0dGVtcHQgdG8gbG9nIHRoaXMgZXJyb3IuCiAgICB9CiAgICB0aGlzLmxvZ2dlcklkID0gbG9nZ2VySWQ7CiAgfTsKCiAgTG9nRW50cnkuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBlbnRyeSA9IG5ldyBMb2dFbnRyeShMb2dDb21wb25lbnQuQ0NQLCBvYmoubGV2ZWwsIG9iai50ZXh0LCBvYmoubG9nZ2VySWQpOwoKICAgIC8vIFJlcXVpcmVkIHRvIGNoZWNrIGZvciBEYXRlIG9iamVjdHMgc2VudCBhY3Jvc3MgZnJhbWUgYm91bmRhcmllcwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmoudGltZSkgPT09ICdbb2JqZWN0IERhdGVdJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUuZ2V0VGltZSgpKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai50aW1lID09PSAnbnVtYmVyJykgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUob2JqLnRpbWUpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBEYXRlLnBhcnNlKG9iai50aW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZSgpOwogICAgfQogICAgZW50cnkuZXhjZXB0aW9uID0gb2JqLmV4Y2VwdGlvbjsKICAgIGVudHJ5Lm9iamVjdHMgPSBvYmoub2JqZWN0czsKICAgIHJldHVybiBlbnRyeTsKICB9OwoKICAvKioKICAgKiBQcml2YXRlIG1ldGhvZCB0byByZW1vdmUgc2Vuc2l0aXZlIGluZm8gZnJvbSBjbGllbnQgbG9nCiAgICovCiAgdmFyIHJlZGFjdFNlbnNpdGl2ZUluZm8gPSBmdW5jdGlvbihkYXRhKSB7CiAgICB2YXIgcmVnZXggPSAvQXV0aFRva2VuLipcPS9nOwogICAgaWYoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHsKICAgICAgT2JqZWN0LmtleXMoZGF0YSkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgICBpZiAodHlwZW9mIGRhdGFba2V5XSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oZGF0YVtrZXldKQogICAgICAgIH0gZWxzZSBpZih0eXBlb2YgZGF0YVtrZXldID09PSAnc3RyaW5nJykgewogICAgICAgICAgaWYgKGtleSA9PT0gInVybCIgfHwga2V5ID09PSAidGV4dCIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gZGF0YVtrZXldLnJlcGxhY2UocmVnZXgsICJbcmVkYWN0ZWRdIik7CiAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gInF1aWNrQ29ubmVjdE5hbWUiKSB7CiAgICAgICAgICAgIGRhdGFba2V5XSA9ICJbcmVkYWN0ZWRdIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOyAKICAgIH0KICB9CgogIC8qKgogICAqIFB1bGxzIHRoZSB0eXBlLCBtZXNzYWdlLCBhbmQgc3RhY2sgdHJhY2UKICAgKiBvdXQgb2YgdGhlIGdpdmVuIGV4Y2VwdGlvbiBmb3IgSlNPTiBzZXJpYWxpemF0aW9uLgogICAqLwogIHZhciBMb2dnZWRFeGNlcHRpb24gPSBmdW5jdGlvbiAoZSkgewogICAgdGhpcy50eXBlID0gKGUgaW5zdGFuY2VvZiBFcnJvcikgPyBlLm5hbWUgOiBlLmNvZGUgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGUpOwogICAgdGhpcy5tZXNzYWdlID0gZS5tZXNzYWdlOwogICAgdGhpcy5zdGFjayA9IFtdOwogICAgaWYgKGUuc3RhY2spewogICAgICB0cnkgewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZS5zdGFjaykpIHsKICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gZS5zdGFjazsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGUuc3RhY2sgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgdGhpcy5zdGFjayA9IFtKU09OLnN0cmluZ2lmeShlLnN0YWNrKV07CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlLnN0YWNrID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBlLnN0YWNrLnNwbGl0KCdcbicpOwogICAgICAgICAgfQogICAgICB9IGNhdGNoIHt9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogTWluaW1hbGx5IHN0cmluZ2lmeSB0aGlzIGxvZyBlbnRyeSBmb3IgcHJpbnRpbmcKICAgKiB0byB0aGUgY29uc29sZS4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCJbJXNdIFslc10gWyVzXTogJXMiLAogICAgICB0aGlzLmdldFRpbWUoKSAmJiB0aGlzLmdldFRpbWUoKS50b0lTT1N0cmluZyA/IHRoaXMuZ2V0VGltZSgpLnRvSVNPU3RyaW5nKCkgOiAiPz8/IiwKICAgICAgdGhpcy5nZXRMZXZlbCgpLAogICAgICB0aGlzLmdldEFnZW50UmVzb3VyY2VJZCgpLAogICAgICB0aGlzLmdldFRleHQoKSk7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsb2cgZW50cnkgdGltZXN0YW1wLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRUaW1lID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudGltZTsKICB9OwoKICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0QWdlbnRSZXNvdXJjZUlkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnRSZXNvdXJjZUlkOwogIH0KCiAgLyoqCiAgICogR2V0IHRoZSBsZXZlbCBvZiB0aGUgbG9nIGVudHJ5LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRMZXZlbCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmxldmVsOwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IHRleHQuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldFRleHQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy50ZXh0OwogIH07CgogIC8qKgogICAqIEdldCB0aGUgbG9nIGVudHJ5IGNvbXBvbmVudC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0Q29tcG9uZW50ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29tcG9uZW50OwogIH07CgogIC8qKgogICAqIEFkZCBhbiBleGNlcHRpb24gc3RhY2sgdHJhY2UgdG8gdGhpcyBsb2cgZW50cnkuCiAgICogQSBsb2cgZW50cnkgbWF5IGNvbnRhaW4gb25seSBvbmUgZXhjZXB0aW9uIHN0YWNrIHRyYWNlLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoRXhjZXB0aW9uID0gZnVuY3Rpb24gKGUpIHsKICAgIHRoaXMuZXhjZXB0aW9uID0gbmV3IExvZ2dlZEV4Y2VwdGlvbihlKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEFkZCBhbiBhcmJpdHJhcnkgb2JqZWN0IHRvIHRoZSBsb2cgZW50cnkuICBBIGxvZyBlbnRyeQogICAqIG1heSBjb250YWluIGFueSBudW1iZXIgb2Ygb2JqZWN0cy4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUud2l0aE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3BpZWRPYmogPSBjb25uZWN0LmRlZXBjb3B5KG9iaik7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGNvcGllZE9iaik7CiAgICB0aGlzLm9iamVjdHMucHVzaChjb3BpZWRPYmopOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogQWRkIGEgY3Jvc3Mgb3JpZ2luIGV2ZW50IG9iamVjdCB0byB0aGUgbG9nIGVudHJ5LiAgQSBsb2cgZW50cnkKICAgKiBtYXkgY29udGFpbiBhbnkgbnVtYmVyIG9mIG9iamVjdHMuCiAgICovCiAgIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoQ3Jvc3NPcmlnaW5FdmVudE9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHZhciBjb3BpZWRPYmogPSBjb25uZWN0LmRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudChvYmopOwogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhjb3BpZWRPYmopOwogICAgdGhpcy5vYmplY3RzLnB1c2goY29waWVkT2JqKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEluZGljYXRlIHRoYXQgdGhpcyBsb2cgZW50cnkgc2hvdWxkIGJlIHNlbnQgdG8gdGhlIHNlcnZlcgogICAqIE5PVEU6IFRoaXMgc2hvdWxkIGJlIHVzZWQgZm9yIGludGVybmFsIGxvZ3Mgb25seQogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlciA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLnB1c2godGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBUaGUgbG9nZ2VyIGluc3RhbmNlLgogICAqLwogIHZhciBMb2dnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLl9sb2dzID0gW107CiAgICB0aGlzLl9yb2xsZWRMb2dzID0gW107CiAgICB0aGlzLl9sb2dzVG9QdXNoID0gW107CiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgdGhpcy5fZWNob0xldmVsID0gTG9nTGV2ZWxPcmRlci5JTkZPOwogICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9saW5lQ291bnQgPSAwOwogICAgdGhpcy5fbG9nUm9sbEludGVydmFsID0gMDsKICAgIHRoaXMuX2xvZ1JvbGxUaW1lciA9IG51bGw7CiAgICB0aGlzLl9sb2dnZXJJZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIi0iICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICB0aGlzLnNldExvZ1JvbGxJbnRlcnZhbChERUZBVUxUX0xPR19ST0xMX0lOVEVSVkFMKTsKICAgIHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2ggPSAwOwogIH07CgogIC8qKgogICAqIFNldHMgdGhlIGludGVydmFsIGluIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBsb2dzIHdpbGwgYmUgcm90YXRlZC4KICAgKiBMb2dzIGFyZSByb3RhdGVkIG91dCBjb21wbGV0ZWx5IGF0IHRoZSBlbmQgb2YgdGhlIHNlY29uZCByb2xsCiAgICogYW5kIHdpbGwgZXZlbnR1YWxseSBiZSBnYXJiYWdlIGNvbGxlY3RlZC4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldExvZ1JvbGxJbnRlcnZhbCA9IGZ1bmN0aW9uIChpbnRlcnZhbCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGlmICghKHRoaXMuX2xvZ1JvbGxUaW1lcikgfHwgaW50ZXJ2YWwgIT09IHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCkgewogICAgICBpZiAodGhpcy5fbG9nUm9sbFRpbWVyKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwodGhpcy5fbG9nUm9sbFRpbWVyKTsKICAgICAgfQogICAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSBpbnRlcnZhbDsKICAgICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gZ2xvYmFsLnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9yb2xsZWRMb2dzID0gdGhpcy5fbG9nczsKICAgICAgICB0aGlzLl9sb2dzID0gW107CiAgICAgICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IDA7CiAgICAgICAgc2VsZi5pbmZvKCJMb2cgcm9sbCBpbnRlcnZhbCBvY2N1cnJlZC4iKTsKICAgICAgfSwgdGhpcy5fbG9nUm9sbEludGVydmFsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMud2FybigiTG9nZ2VyIGlzIGFscmVhZHkgc2V0IHRvIHRoZSBnaXZlbiBpbnRlcnZhbDogJWQiLCB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgbG9nIGxldmVsLiAgVGhpcyBpcyB0aGUgbWluaW11bSBsZXZlbCBhdCB3aGljaCBsb2dzIHdpbGwKICAgKiBiZSBrZXB0IGZvciBsYXRlciBhcmNoaXZpbmcuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRMb2dMZXZlbCA9IGZ1bmN0aW9uIChsZXZlbCkgewogICAgaWYgKGxldmVsIGluIExvZ0xldmVsT3JkZXIpIHsKICAgICAgdGhpcy5fbG9nTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFNldCB0aGUgZWNobyBsZXZlbC4gIFRoaXMgaXMgdGhlIG1pbmltdW0gbGV2ZWwgYXQgd2hpY2ggbG9ncyB3aWxsCiAgICogYmUgcHJpbnRlZCB0byB0aGUgamF2YXNjcmlwdCBjb25zb2xlLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0RWNob0xldmVsID0gZnVuY3Rpb24gKGxldmVsKSB7CiAgICBpZiAobGV2ZWwgaW4gTG9nTGV2ZWxPcmRlcikgewogICAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyW2xldmVsXTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBsb2dnaW5nIGxldmVsOiAiICsgbGV2ZWwpOwogICAgfQogIH07CgogIC8qKgogICAqIFdyaXRlIGEgcGFydGljdWxhciBsb2cgZW50cnkuCiAgICoKICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxvZ2dpbmcgbGV2ZWwgb2YgdGhlIGVudHJ5LgogICAqIEBwYXJhbSB0ZXh0IFRoZSB0ZXh0IGNvbnRlbnRzIG9mIHRoZSBlbnRyeS4KICAgKgogICAqIEByZXR1cm5zIFRoZSBuZXcgbG9nIGVudHJ5LgogICAqLwogIExvZ2dlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBsZXZlbCwgdGV4dCkgewogICAgdmFyIGxvZ0VudHJ5ID0gbmV3IExvZ0VudHJ5KGNvbXBvbmVudCwgbGV2ZWwsIHRleHQsIHRoaXMuZ2V0TG9nZ2VySWQoKSk7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGxvZ0VudHJ5KTsKICAgIHRoaXMuYWRkTG9nRW50cnkobG9nRW50cnkpOwogICAgcmV0dXJuIGxvZ0VudHJ5OwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuYWRkTG9nRW50cnkgPSBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgIC8vIENhbGwgdGhpcyBzZWNvbmQgdGltZSBhcyBpbiBzb21lIHBsYWNlcyB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBkaXJlY3RseQogICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhsb2dFbnRyeSk7CiAgICB0aGlzLl9sb2dzLnB1c2gobG9nRW50cnkpOwoKICAgIC8vRm9yIG5vdyBvbmx5IHNlbmQgc29mdHBob25lIGxvZ3Mgb25seS4KICAgIC8vVE9ETyBhZGQgQ0NQIGxvZ3Mgb25jZSB3ZSBhcmUgc3VyZSB0aGF0IG5vIHNlbnNpdGl2ZSBkYXRhIGlzIGJlaW5nIGxvZ2dlZC4KICAgIGlmIChMb2dDb21wb25lbnQuU09GVFBIT05FID09PSBsb2dFbnRyeS5jb21wb25lbnQpIHsKICAgICAgdGhpcy5fbG9nc1RvUHVzaC5wdXNoKGxvZ0VudHJ5KTsKICAgIH0KCiAgICBpZiAobG9nRW50cnkubGV2ZWwgaW4gTG9nTGV2ZWxPcmRlciAmJgogICAgICBMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9sb2dMZXZlbCkgewoKICAgICAgaWYgKExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2VjaG9MZXZlbCkgewogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUFtsb2dFbnRyeS5nZXRMZXZlbCgpXShsb2dFbnRyeS50b1N0cmluZygpKTsKICAgICAgfQoKICAgICAgbG9nRW50cnkubGluZSA9IHRoaXMuX2xpbmVDb3VudCsrOwogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2VuZEludGVybmFsTG9nRW50cnlUb1NlcnZlciA9IGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MucHVzaChsb2dFbnRyeSk7CgogICAgaWYgKGxvZ0VudHJ5LmxldmVsIGluIExvZ0xldmVsT3JkZXIgJiYKICAgICAgTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fbG9nTGV2ZWwpIHsKCiAgICAgIGlmIChMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9lY2hvTGV2ZWwpIHsKICAgICAgICBDT05TT0xFX0xPR0dFUl9NQVBbbG9nRW50cnkuZ2V0TGV2ZWwoKV0obG9nRW50cnkudG9TdHJpbmcoKSk7CiAgICAgIH0KCiAgICAgIGxvZ0VudHJ5LmxpbmUgPSB0aGlzLl9saW5lQ291bnQrKzsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZW1vdmUgYWxsIG9iamVjdHMgZnJvbSBhbGwgbG9nIGVudHJpZXMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5jbGVhck9iamVjdHMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbeF0ub2JqZWN0cykgewogICAgICAgIGRlbGV0ZSB0aGlzLl9sb2dzW3hdLm9iamVjdHM7CiAgICAgIH0KICAgIH0KICB9OwoKICAvKioKICAgKiBSZW1vdmUgYWxsIGV4Y2VwdGlvbiBzdGFjayB0cmFjZXMgZnJvbSB0aGUgbG9nIGVudHJpZXMuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5jbGVhckV4Y2VwdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbeF0uZXhjZXB0aW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ3NbeF0uZXhjZXB0aW9uOwogICAgICB9CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS50cmFjZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5UUkFDRSwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5ERUJVRywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLklORk8sIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUubG9nID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkxPRywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS50ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLlRFU1QsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUud2FybiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dBcmdzID0gZXh0cmFjdExvZ2dlckFyZ3MoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzLndyaXRlKGxvZ0FyZ3MuY29tcG9uZW50LCBMb2dMZXZlbC5XQVJOLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkVSUk9SLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmNyaXRpY2FsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkVSUk9SLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICAvKioKICAgKiBDcmVhdGUgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGxvZ2dlciBjb250ZW50cy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxpbmVzID0gW107CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMuX2xvZ3MubGVuZ3RoOyB4KyspIHsKICAgICAgbGluZXMucHVzaCh0aGlzLl9sb2dzW3hdLnRvU3RyaW5nKCkpOwogICAgfQoKICAgIHJldHVybiBsaW5lcy5qb2luKCJcbiIpOwogIH07CiAgCiAgLyoqCiAgICogRG93bmxvYWQvQXJjaGl2ZSBsb2dzIHRvIGEgZmlsZSwgCiAgICogQnkgZGVmYXVsdCwgaXQgcmV0dXJucyBhbGwgbG9ncy4KICAgKiBUbyBmaWx0ZXIgbG9ncyBieSB0aGUgbWluaW11bSBsb2cgbGV2ZWwgc2V0IGJ5IHNldExvZ0xldmVsIG9yIHRoZSBkZWZhdWx0IHNldCBpbiBfbG9nTGV2ZWwsIAogICAqIHBhc3MgaW4gZmlsdGVyQnlMb2dMZXZlbCB0byB0cnVlIGluIG9wdGlvbnMKICAgKiAKICAgKiBAcGFyYW0gb3B0aW9ucyBkb3dubG9hZCBvcHRpb25zIFtPYmplY3R8U3RyaW5nXS4gCiAgICogLSBvZiB0eXBlIE9iamVjdDogCiAgICogICB7IGxvZ05hbWU6ICdteS1sb2ctbmFtZScsCiAgICogICAgIGZpbHRlckJ5TG9nTGV2ZWw6IGZhbHNlLCAvL2Rvd25sb2FkIGFsbCBsb2dzCiAgICogICB9CiAgICogLSBvZiB0eXBlIFN0cmluZyAoZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkpLCB0aGUgZmlsZSdzIG5hbWUKICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmRvd25sb2FkID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIGxvZ05hbWUgPSAnYWdlbnQtbG9nJzsKICAgIHZhciBmaWx0ZXJCeUxvZ0xldmVsID0gZmFsc2U7CgogICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JykgewogICAgICBsb2dOYW1lID0gb3B0aW9ucy5sb2dOYW1lIHx8IGxvZ05hbWU7CiAgICAgIGZpbHRlckJ5TG9nTGV2ZWwgPSBvcHRpb25zLmZpbHRlckJ5TG9nTGV2ZWwgfHwgZmlsdGVyQnlMb2dMZXZlbDsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICBsb2dOYW1lID0gb3B0aW9ucyB8fCBsb2dOYW1lOwogICAgfQoKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBsb2dzID0gdGhpcy5fcm9sbGVkTG9ncy5jb25jYXQodGhpcy5fbG9ncyk7CiAgICBpZiAoZmlsdGVyQnlMb2dMZXZlbCkgewogICAgICBsb2dzID0gbG9ncy5maWx0ZXIoZnVuY3Rpb24oZW50cnkpIHsKICAgICAgICByZXR1cm4gTG9nTGV2ZWxPcmRlcltlbnRyeS5sZXZlbF0gPj0gc2VsZi5fbG9nTGV2ZWw7CiAgICAgIH0pOwogICAgfQoKICAgIHZhciBsb2dCbG9iID0gbmV3IGdsb2JhbC5CbG9iKFtKU09OLnN0cmluZ2lmeShsb2dzLCB1bmRlZmluZWQsIDQpXSwgWyd0ZXh0L3BsYWluJ10pOwogICAgdmFyIGRvd25sb2FkTGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIHZhciBsb2dOYW1lID0gbG9nTmFtZSB8fCAnYWdlbnQtbG9nJzsKICAgIGRvd25sb2FkTGluay5ocmVmID0gZ2xvYmFsLlVSTC5jcmVhdGVPYmplY3RVUkwobG9nQmxvYik7CiAgICBkb3dubG9hZExpbmsuZG93bmxvYWQgPSBsb2dOYW1lICsgJy50eHQnOwogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChkb3dubG9hZExpbmspOwogICAgZG93bmxvYWRMaW5rLmNsaWNrKCk7CiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGRvd25sb2FkTGluayk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtTG9nUHVzaCA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBpZiAoIWNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkKSB7CiAgICAgIGNvbm5lY3QudXBzdHJlYW1Mb2dQdXNoU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgLyoqIFNjaGVkdWxlIHB1c2hpbmcgbG9ncyBmcmVxdWVudGx5IHRvIHNoYXJlZHdvcmtlciB1cHN0cmVhbSwgc2hhcmVkd29ya2VyIHdpbGwgcmVwb3J0IHRvIHRoZSBDVEkgYmFja2VuZCovCiAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMucmVwb3J0TWFzdGVyTG9nc1VwU3RyZWFtLCBjb25kdWl0KSwgU09GVFBIT05FX0xPR19SRVBPUlRfSU5URVJWQUxfTUlMTElTKTsKICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnJlcG9ydE1hc3RlckxvZ3NVcFN0cmVhbSA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICB2YXIgbG9nc1RvUHVzaCA9IHRoaXMuX2xvZ3NUb1B1c2guc2xpY2UoKTsKICAgIHRoaXMuX2xvZ3NUb1B1c2ggPSBbXTsKICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTLCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChsb2dzVG9QdXNoLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRU5EX0xPR1MsIGxvZ3NUb1B1c2gpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NQdXNoID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoT3V0ZXJDb250ZXh0Q0NQc2VydmVyQm91bmRMb2dzVXBzdHJlYW0sIGNvbmR1aXQpLCAxMDAwKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUExvZ3NQdXNoID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoT3V0ZXJDb250ZXh0Q0NQTG9nc1Vwc3RyZWFtLCBjb25kdWl0KSwgMTAwMCk7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hPdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NVcHN0cmVhbSA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPiAwKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nc1tpXS50ZXh0ID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0udGV4dDsKICAgICAgfQoKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MpOwogICAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyA9IFtdOwogICAgfQogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoT3V0ZXJDb250ZXh0Q0NQTG9nc1Vwc3RyZWFtID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgZm9yICh2YXIgaSA9IHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2g7IGkgPCB0aGlzLl9sb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0aGlzLl9sb2dzW2ldLmxvZ2dlcklkICE9PSB0aGlzLl9sb2dnZXJJZCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgdGhpcy5fbG9nc1tpXSk7CiAgICB9CiAgICB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoID0gdGhpcy5fbG9ncy5sZW5ndGg7CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLmdldExvZ2dlcklkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2xvZ2dlcklkOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVEb3duc3RyZWFtQ2xpZW50U2lkZUxvZ3NQdXNoID0gZnVuY3Rpb24gKCkgewogICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5wdXNoQ2xpZW50U2lkZUxvZ3NEb3duc3RyZWFtKSwgTE9HU19SRVBPUlRfSU5URVJWQUxfTUlMTElTKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaENsaWVudFNpZGVMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2dzID0gW107CgogICAgLy8gV2UgZG8gbm90IHNlbmQgYSByZXF1ZXN0IGlmIHdlIGhhdmUgbGVzcyB0aGFuIDUwIHJlY29yZHMgc28gdGhhdCB3ZSBtaW5pbWl6ZSB0aGUgbnVtYmVyIG9mCiAgICAvLyByZXF1ZXN0cyBwZXIgc2Vjb25kLiAKICAgIC8vIDUwMCBpcyB0aGUgbWF4IHdlIGFjY2VwdCBvbiB0aGUgc2VydmVyLiAKICAgIC8vIFdlIGNob3NlIDUwMCBiZWNhdXNlIHRoaXMgaXMgdGhlIGxpbWl0IGltcG9zZWQgYnkgRmlyZWhvc2UgZm9yIGEgcHV0IGJhdGNoIHJlcXVlc3QKICAgIGlmICh0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGggPCA1MCkgewogICAgICByZXR1cm47CiAgICB9IGVsc2UgaWYgKHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aCA+IDUwMCkgewogICAgICBsb2dzID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3Muc3BsaWNlKDAsIDUwMCk7CiAgICB9IGVsc2UgewogICAgICBsb2dzID0gdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3M7CiAgICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB9CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpZW50U2lkZUxvZ3MobG9ncyk7CiAgfQoKICB2YXIgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIgPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgTG9nZ2VyLmNhbGwodGhpcyk7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgCiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9wdXNoTG9nc0Rvd25zdHJlYW0pLAogICAgICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5MT0dfUFVTSF9JTlRFUlZBTCk7CgogICAgLy8gRGlzYWJsZSBsb2cgcm9sbGluZywgd2Ugd2lsbCBwdXJnZSBvdXIgb3duIGxvZ3Mgb25jZSB0aGV5IGhhdmUKICAgIC8vIGJlZW4gcHVzaGVkIGRvd25zdHJlYW0uCiAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbCh0aGlzLl9sb2dSb2xsVGltZXIpOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICB9OwogIC8vIEhvdyBmcmVxdWVudGx5IGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgZGVsaXZlcmVkIGRvd25zdHJlYW0uCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIuTE9HX1BVU0hfSU5URVJWQUwgPSAxMDAwOwogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoTG9nZ2VyLnByb3RvdHlwZSk7CiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRG93bnN0cmVhbUNvbmR1aXRMb2dnZXI7CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5wdXNoTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAobG9ncykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgbG9nKTsKICAgIH0pOwogIH07CgogIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLnByb3RvdHlwZS5fcHVzaExvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgCiAgICB0aGlzLl9sb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBsb2cpOwogICAgfSk7CiAgICB0aGlzLl9sb2dzID0gW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGg7IGkrKykgewogICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3NbaV0pOwogICAgfQoKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgfTsKCiAgLyoqCiAgICogV3JhcCBhIGZ1bmN0aW9uIHdpdGggdHJ5IGNhdGNoIGJsb2NrCiAgICovCiAgdmFyIHRyeUNhdGNoV3JhcHBlck1ldGhvZCA9IGZ1bmN0aW9uIChmbikgewogICAgdmFyIHdyYXBwZWRmdW5jdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgLy8gU2luY2UgdGhpcyB3cmFwcyBMb2dnZXIgY2xhc3MsIHdlIGNhbiBvbmx5IHByaW50IGl0IGluIHRoZSBjb25zb2xlIGFuZCBlYXQgaXQuCiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQLkVSUk9SKGUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gd3JhcHBlZGZ1bmN0aW9uOwogIH0KICAvKioKICAgKiBUaGlzIGlzIGEgd3JhcHBlciBtZXRob2QgdG8gd3JhcCBlYWNoIGZ1bmN0aW9uCiAgICogaW4gYW4gb2JqZWN0IHdpdGggdHJ5IGNhdGNoIGJsb2NrLgogICAqLwogIHZhciB0cnlDYXRjaFdyYXBwZXJPYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBmb3IgKHZhciBtZXRob2QgaW4gb2JqKSB7CiAgICAgIGlmICh0eXBlb2Yob2JqW21ldGhvZF0pID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgb2JqW21ldGhvZF0gPSB0cnlDYXRjaFdyYXBwZXJNZXRob2Qob2JqW21ldGhvZF0pOwogICAgICB9CiAgICB9CiAgfQoKICAvKiogQ3JlYXRlIHRoZSBzaW5nbGV0b24gbG9nZ2VyIGluc3RhbmNlLiAqLwogIGNvbm5lY3Qucm9vdExvZ2dlciA9IG5ldyBMb2dnZXIoKTsKICB0cnlDYXRjaFdyYXBwZXJPYmplY3QoY29ubmVjdC5yb290TG9nZ2VyKTsKCgogIC8qKiBGZXRjaCB0aGUgc2luZ2xldG9uIGxvZ2dlciBpbnN0YW5jZS4gKi8KICB2YXIgZ2V0TG9nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qucm9vdExvZ2dlcjsKICB9OwoKICBjb25uZWN0ID0gY29ubmVjdCB8fCB7fTsKICBjb25uZWN0LmdldExvZyA9IGdldExvZzsKICBjb25uZWN0LkxvZ0VudHJ5ID0gTG9nRW50cnk7CiAgY29ubmVjdC5Mb2dnZXIgPSBMb2dnZXI7CiAgY29ubmVjdC5Mb2dMZXZlbCA9IExvZ0xldmVsOwogIGNvbm5lY3QuTG9nQ29tcG9uZW50ID0gTG9nQ29tcG9uZW50OwogIGNvbm5lY3QuRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIgPSBEb3duc3RyZWFtQ29uZHVpdExvZ2dlcjsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDQzOToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICBjb25uZWN0LkNoYXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAobWVkaWFJbmZvLCBtZXRhZGF0YSkgewogICAgdmFyIGxvZ2dlciA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICB2YXIgbG9nQ29tcG9uZW50ID0gY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVDsKCiAgICB2YXIgY3JlYXRlTWVkaWFJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJDaGF0IG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIpCiAgICAgICAgLndpdGhPYmplY3QobWVkaWFJbmZvKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgY29ubmVjdC5DaGF0U2Vzc2lvbi5zZXRHbG9iYWxDb25maWcoewogICAgICAgIGxvZ2dlckNvbmZpZzogewogICAgICAgICAgbG9nZ2VyOiBsb2dnZXIKICAgICAgICB9LAogICAgICAgIHJlZ2lvbjogbWV0YWRhdGEucmVnaW9uCiAgICAgIH0pOwoKICAgICAgLyoqIENvdWxkIGJlIGFsc28gQ1VTVE9NRVIgLSAgRm9yIG5vdyB3ZSBhcmUgY3JlYXRpbmcgb25seSBBZ2VudCBjb25uZWN0aW9uIG1lZGlhIG9iamVjdCAqLwogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuQ2hhdFNlc3Npb24uY3JlYXRlKHsKICAgICAgICBjaGF0RGV0YWlsczogbWVkaWFJbmZvLAogICAgICAgIHR5cGU6ICJBR0VOVCIsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKQogICAgICB9KTsKICAgICAgCiAgICAgIHRyYWNrQ2hhdENvbm5lY3Rpb25TdGF0dXMoY29udHJvbGxlcik7CiAgICAgIHJldHVybiBjb250cm9sbGVyCiAgICAgICAgLmNvbm5lY3QoKQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIGZvciBjb250YWN0SWQgJXMiLCBtZWRpYUluZm8uY29udGFjdElkKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCBmb3IgY29udGFjdCAlcyIsIG1lZGlhSW5mby5jb250YWN0SWQpCiAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGVycm9yKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCwgZXJyb3IpOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICBkYXRhOiBkYXRhIHx8IG1lZGlhSW5mbwogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrQ2hhdENvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iKQogICAgICAgICAgLndpdGhFeGNlcHRpb24oZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIsIGRhdGEpOwogICAgICB9KTsKCiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uRXN0YWJsaXNoZWQoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZU1lZGlhSW5zdGFuY2UoKTsKICAgICAgfQogICAgfQogIH0KfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDI3OToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICBjb25uZWN0Lk1lZGlhRmFjdG9yeSA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIC8qKiBjb250cm9sbGVyIGhvbGRlciAqLwogICAgdmFyIG1lZGlhQ29udHJvbGxlcnMgPSB7fTsKICAgIHZhciB0b0JlRGVzdHJveWVkID0gbmV3IFNldCgpOwoKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQ7CgogICAgdmFyIG1ldGFkYXRhID0gY29ubmVjdC5tZXJnZSh7fSwgcGFyYW1zKSB8fCB7fTsKICAgIG1ldGFkYXRhLnJlZ2lvbiA9ICBtZXRhZGF0YS5yZWdpb24gfHwgInVzLXdlc3QtMiI7IC8vIERlZmF1bHQgaXQgdG8gdXMtd2VzdC0yCgogICAgdmFyIGdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIHZhciBjb25uZWN0aW9uSWQgPSBjb25uZWN0aW9uT2JqLmdldENvbm5lY3Rpb25JZCgpOwogICAgICB2YXIgbWVkaWFJbmZvID0gY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKTsKICAgICAgLyoqIGlmIHdlIGRvIG5vdCBoYXZlIHRoZSBtZWRpYSBpbmZvIHRoZW4ganVzdCByZWplY3QgdGhlIHJlcXVlc3QgKi8KICAgICAgaWYgKCFtZWRpYUluZm8pIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdCBmb3IgYSBtZWRpYSB0eXBlICVzIiwgY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkKICAgICAgICAgIC53aXRoT2JqZWN0KGNvbm5lY3Rpb25PYmopLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBpbmZvIGRvZXMgbm90IGV4aXN0IGZvciB0aGlzIGNvbm5lY3Rpb24iKTsKICAgICAgfQoKICAgICAgaWYgKCFtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0pIHsKICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJtZWRpYSBjb250cm9sbGVyIG9mIHR5cGUgJXMgaW5pdCIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAud2l0aE9iamVjdChjb25uZWN0aW9uT2JqKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHN3aXRjaCAoY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuQ2hhdE1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpLCBtZXRhZGF0YSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORToKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpKS5nZXQoKTsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuVEFTSzoKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LlRhc2tNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSkuZ2V0KCk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiVW5yZWNvZ25pemVkIG1lZGlhIHR5cGUgJXMgIiwgY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgIH0KICAgIH07CgogICAgLyoqIENoZWNrIGFsbCB0aGUgYWN0aXZlIHN0YXRlcyBmb3IgdGhlIGNvbm5lY3Rpb24gKi8KICAgIHZhciBpZkNvbm5lY3Rpb25BY3RpdmUgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICByZXR1cm4gY29ubmVjdGlvbk9iai5pc0FjdGl2ZSgpOwogICAgfTsKCiAgICB2YXIgZ2V0ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgaWYgKGlmQ29ubmVjdGlvbkFjdGl2ZShjb25uZWN0aW9uT2JqKSkgewogICAgICAgIHJldHVybiBnZXRNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iaik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVzdHJveShjb25uZWN0aW9uT2JqLmdldENvbm5lY3Rpb25JZCgpKTsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk1lZGlhIENvbnRyb2xsZXIgaXMgbm8gbG9uZ2VyIGF2YWlsYWJsZSBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KICAgIH07CgogICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gJiYgIXRvQmVEZXN0cm95ZWQuaGFzKGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICJEZXN0cm95aW5nIG1lZGlhQ29udHJvbGxlciBmb3IgJXMiLAogICAgICAgICAgY29ubmVjdGlvbklkCiAgICAgICAgKTsKICAgICAgICB0b0JlRGVzdHJveWVkLmFkZChjb25uZWN0aW9uSWQpOwogICAgICAgIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udHJvbGxlci5jbGVhblVwID09PSAiZnVuY3Rpb24iKSBjb250cm9sbGVyLmNsZWFuVXAoKTsKICAgICAgICAgICAgZGVsZXRlIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXTsKICAgICAgICAgICAgdG9CZURlc3Ryb3llZC5kZWxldGUoY29ubmVjdGlvbklkKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgICAgICAgIHRvQmVEZXN0cm95ZWQuZGVsZXRlKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gewogICAgICBnZXQ6IGdldCwKICAgICAgZGVzdHJveTogZGVzdHJveQogICAgfTsKICB9Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA0MTg6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgLy8gVE9ETyBtb3ZlIHNvZnRwaG9uZSBpbXBsZW1lbnRhdGlvbnMgaGVyZSAtIFdpbCBkbyB0aGlzIGZvciBHQQogIGNvbm5lY3QuU29mdHBob25lTWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbykgewogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtZWRpYUluZm8pCiAgICAgIH0KICAgIH0KICB9Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAxODc6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5UYXNrTWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbykgewogICAgdmFyIGxvZ2dlciA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICB2YXIgbG9nQ29tcG9uZW50ID0gY29ubmVjdC5Mb2dDb21wb25lbnQuVEFTSzsKCiAgICB2YXIgY3JlYXRlTWVkaWFJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICBsb2dnZXIKICAgICAgICAuaW5mbyhsb2dDb21wb25lbnQsICJUYXNrIG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIpCiAgICAgICAgLndpdGhPYmplY3QobWVkaWFJbmZvKTsKCiAgICAgIHZhciBjb250cm9sbGVyID0gY29ubmVjdC5UYXNrU2Vzc2lvbi5jcmVhdGUoewogICAgICAgIGNvbnRhY3RJZDogbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICBpbml0aWFsQ29udGFjdElkOiBtZWRpYUluZm8uaW5pdGlhbENvbnRhY3RJZCwKICAgICAgICB3ZWJzb2NrZXRNYW5hZ2VyOiBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpLAogICAgICB9KTsKCiAgICAgIHRyYWNrVGFza0Nvbm5lY3Rpb25TdGF0dXMoY29udHJvbGxlcik7CgogICAgICByZXR1cm4gY29udHJvbGxlcgogICAgICAgIC5jb25uZWN0KCkKICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgbG9nQ29tcG9uZW50LAogICAgICAgICAgICAiVGFzayBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCBmb3IgY29udGFjdElkICVzIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgKICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQiLAogICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBsb2dnZXIKICAgICAgICAgICAgLmVycm9yKAogICAgICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICAgICAiVGFzayBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCBmb3IgY29udGFjdCAlcyIsCiAgICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgICApCiAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGVycm9yKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgKICAgICAgICAgICAgIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQiLAogICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgICAgICBlcnJvcgogICAgICAgICAgKTsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgZGF0YTogZGF0YSB8fCBtZWRpYUluZm8sCiAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgdHJhY2tUYXNrQ29ubmVjdGlvblN0YXR1cyA9IGZ1bmN0aW9uIChjb250cm9sbGVyKSB7CiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uQnJva2VuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyCiAgICAgICAgICAuZXJyb3IobG9nQ29tcG9uZW50LCAiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIikKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIiwgZGF0YSk7CiAgICAgIH0pOwoKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Fc3RhYmxpc2hlZChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlcgogICAgICAgICAgLmluZm8obG9nQ29tcG9uZW50LCAiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIsIGRhdGEpOwogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZU1lZGlhSW5zdGFuY2UoKTsKICAgICAgfSwKICAgIH07CiAgfTsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDc0MzoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgUmluZ3RvbmVFbmdpbmVCYXNlID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl9wcmV2Q29udGFjdElkID0gbnVsbDsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVDb25maWcsICJyaW5ndG9uZUNvbmZpZyIpOwogICAgaWYgKCFyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoInJpbmd0b25lVXJsIGlzIHJlcXVpcmVkISIpOwogICAgfQoKICAgIGlmIChnbG9iYWwuQXVkaW8gJiYgdHlwZW9mIGdsb2JhbC5Qcm9taXNlICE9PSAidW5kZWZpbmVkIikgewogICAgICB0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBzZWxmLl9hdWRpbyA9IG5ldyBBdWRpbyhyaW5ndG9uZUNvbmZpZy5yaW5ndG9uZVVybCk7CiAgICAgICAgc2VsZi5fYXVkaW8ubG9vcCA9IHRydWU7CiAgICAgICAgc2VsZi5fYXVkaW8uYWRkRXZlbnRMaXN0ZW5lcigiY2FucGxheSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNlbGYuX2F1ZGlvUGxheWFibGUgPSB0cnVlOwogICAgICAgICAgcmVzb2x2ZShzZWxmLl9hdWRpbyk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2F1ZGlvID0gbnVsbDsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiVW5hYmxlIHRvIHByb3ZpZGUgYSByaW5ndG9uZS4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQoKICAgIHNlbGYuX2RyaXZlUmluZ3RvbmUoKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgaW1wbGVtZW50ZWQuIik7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fc3RhcnRSaW5ndG9uZSA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAodGhpcy5fYXVkaW8pIHsKICAgICAgdGhpcy5fYXVkaW8ucGxheSgpCiAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiUmluZ3RvbmUgUGxheWJhY2sgRmFpbHVyZSIsIGNvbnRhY3QpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiUmluZ3RvbmUgUGxheWJhY2sgRmFpbHVyZSIpLndpdGhFeGNlcHRpb24oZSkud2l0aE9iamVjdCh7Y3VycmVudFNyYzogc2VsZi5fYXVkaW8uY3VycmVudFNyYywgc2lua0lkOiBzZWxmLl9hdWRpby5zaW5rSWQsIHZvbHVtZTogc2VsZi5fYXVkaW8udm9sdW1lfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9KTsKICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBTdGFydCIsIGNvbnRhY3QpOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIFN0YXJ0Iikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9zdG9wUmluZ3RvbmUgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgaWYgKHRoaXMuX2F1ZGlvKSB7CiAgICAgIHRoaXMuX2F1ZGlvLnBhdXNlKCk7CiAgICAgIHRoaXMuX2F1ZGlvLmN1cnJlbnRUaW1lID0gMDsKICAgICAgdGhpcy5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBTdG9wIiwgY29udGFjdCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgU3RvcCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU3RvcCByaW5ndG9uZS4KICAgKi8KICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLnN0b3BSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX3N0b3BSaW5ndG9uZSgpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3Jpbmd0b25lU2V0dXAgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICBzZWxmLl9zdGFydFJpbmd0b25lKGNvbnRhY3QpOwogICAgICBzZWxmLl9wcmV2Q29udGFjdElkID0gY29udGFjdC5nZXRDb250YWN0SWQoKTsKCiAgICAgIGNvbnRhY3Qub25Db25uZWN0ZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgY29udGFjdC5vbkFjY2VwdGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIGNvbnRhY3Qub25FbmRlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICAvLyBKdXN0IHRvIG1ha2Ugc3VyZSB0byBzdG9wIHRoZSByaW5ndG9uZSBpbiBjYXNlIG9mIHRoZSBmYWlsdXJlcyBvZiBzcGVjaWZpYyBjYWxsYmFja3Mob25BY2NlcHRlZCxvbkNvbm5lY3RlZCk7CiAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSAhPT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HICYmCiAgICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgIT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpIHsKICAgICAgICAgIHNlbGYuX3N0b3BSaW5ndG9uZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0KSB7CiAgICBpZiAoY29udGFjdCAmJiBjb250YWN0LmdldENvbnRhY3RJZCgpKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogY29udGFjdC5nZXRDb250YWN0SWQoKQogICAgICB9KTsKICAgIH0KICB9OwoKICAvKioKICAgKiBDaGFuZ2UgdGhlIGF1ZGlvIGRldmljZSB1c2VkIHRvIHBsYXkgcmluZ3RvbmUuCiAgICogSWYgYXVkaW8gZWxlbWVudCBpcyBub3QgZnVsbHkgaW5pdGlhbGl6ZWQsIHRoZSBBUEkgd2lsbCB3YWl0IF9hdWRpb1BsYXlhYmxlUHJvbWlzZSBmb3IgMyBzZWNvbmRzIGFuZCBmYWlsIG9uIHRpbWVvdXQuCiAgICogVGhpcyBBUEkgaXMgc3VwcG9ydGVkIG9ubHkgYnkgYnJvd3NlcnMgdGhhdCBpbXBsZW1lbnRlZCBFUzYgUHJvbWlzZSBhbmQgaHR0cDovL3d3dy53My5vcmcvVFIvYXVkaW8tb3V0cHV0LwogICAqIFJldHVybiBhIFByb21pc2UgdGhhdCBpbmRpY2F0ZXMgdGhlIHJlc3VsdCBvZiBjaGFuZ2luZyBvdXRwdXQgZGV2aWNlLgogICAqLwogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuc2V0T3V0cHV0RGV2aWNlID0gZnVuY3Rpb24gKGRldmljZUlkKSB7CiAgICBpZiAodGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UpIHsKICAgICAgdmFyIHBsYXlhYmxlQXVkaW9XaXRoVGltZW91dCA9IFByb21pc2UucmFjZShbCiAgICAgICAgdGhpcy5fcGxheWFibGVBdWRpb1Byb21pc2UsCiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyByZWplY3QoIlRpbWVkIG91dCB3YWl0aW5nIGZvciBwbGF5YWJsZSBhdWRpbyIpOyB9LCAzMDAwLyptcyovKTsKICAgICAgICB9KQogICAgICBdKTsKICAgICAgcmV0dXJuIHBsYXlhYmxlQXVkaW9XaXRoVGltZW91dC50aGVuKGZ1bmN0aW9uIChhdWRpbykgewogICAgICAgIGlmIChhdWRpbykgewogICAgICAgICAgaWYgKGF1ZGlvLnNldFNpbmtJZCkgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGF1ZGlvLnNldFNpbmtJZChkZXZpY2VJZCkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJOb3Qgc3VwcG9ydGVkIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm8gYXVkaW8gZm91bmQiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGlmIChnbG9iYWwuUHJvbWlzZSkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vdCBlbGlnaWJsZSByaW5ndG9uZSBvd25lciIpOwogICAgfQogIH07CgogIHZhciBWb2ljZVJpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBWb2ljZVJpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgVm9pY2VSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBWb2ljZVJpbmd0b25lRW5naW5lOwoKICBWb2ljZVJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5WT0lDRSAmJgogICAgICAgIGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKCiAgICBuZXcgY29ubmVjdC5BZ2VudCgpLmdldENvbnRhY3RzKCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcpIHsKICAgICAgICBvbkNvbnRhY3RDb25uZWN0KGNvbnRhY3QpOwogICAgICB9CiAgICB9KTsKICB9OwoKCiAgdmFyIENoYXRSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENoYXRSaW5ndG9uZUVuZ2luZTsKCiAgQ2hhdFJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5DSEFUICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDaGF0IFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uQ29ubmVjdGluZyhvbkNvbnRhY3RDb25uZWN0KTsKICAgIH0pOwogIH07CgogIHZhciBUYXNrUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFRhc2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUpOwogIFRhc2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBUYXNrUmluZ3RvbmVFbmdpbmU7CgogIFRhc2tSaW5ndG9uZUVuZ2luZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdmFyIG9uQ29udGFjdENvbm5lY3QgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuVEFTSyAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiVGFzayBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkNvbm5lY3Rpbmcob25Db250YWN0Q29ubmVjdCk7CiAgICB9KTsKICB9OwoKCiAgdmFyIFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZTsKCiAgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgY29udGFjdC5vbkluY29taW5nKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoY29udGFjdC5nZXRUeXBlKCkgPT09IGxpbHkuQ29udGFjdFR5cGUuUVVFVUVfQ0FMTEJBQ0spIHsKICAgICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNhbGxiYWNrIFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2FsbGJhY2sgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8qIGV4cG9ydCBjb25uZWN0LlJpbmd0b25lRW5naW5lICovCiAgY29ubmVjdC5Wb2ljZVJpbmd0b25lRW5naW5lID0gVm9pY2VSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZSA9IENoYXRSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LlRhc2tSaW5ndG9uZUVuZ2luZSA9IFRhc2tSaW5ndG9uZUVuZ2luZTsKICBjb25uZWN0LlF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZSA9IFF1ZXVlQ2FsbGJhY2tSaW5ndG9uZUVuZ2luZTsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDY0MjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmNjcFZlcnNpb24gPSAiVjIiOwoKICB2YXIgUlRQSm9iSW50ZXJ2YWxNcyA9IDEwMDA7CiAgdmFyIHN0YXRzUmVwb3J0aW5nSm9iSW50ZXJ2YWxNcyA9IDMwMDAwOwogIHZhciBzdHJlYW1CdWZmZXJTaXplID0gNTAwOwogIHZhciBDYWxsVHlwZU1hcCA9IHt9OwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuQVVESU9fT05MWV0gPSAnQXVkaW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuVklERU9fT05MWV0gPSAnVmlkZW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuQVVESU9fVklERU9dID0gJ0F1ZGlvVmlkZW8nOwogIENhbGxUeXBlTWFwW2Nvbm5lY3QuU29mdHBob25lQ2FsbFR5cGUuTk9ORV0gPSAnTm9uZSc7CiAgdmFyIEFVRElPX0lOUFVUID0gJ2F1ZGlvX2lucHV0JzsKICB2YXIgQVVESU9fT1VUUFVUID0gJ2F1ZGlvX291dHB1dCc7CgogIHZhciBNZWRpYVR5cGVNYXAgPSB7fTsKICBNZWRpYVR5cGVNYXBbY29ubmVjdC5Db250YWN0VHlwZS5WT0lDRV0gPSAiVm9pY2UiOwogIHZhciBVTktOT1dOX01FRElBX1RZUEUgPSAiVW5rbm93biI7CgogIHZhciB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICB2YXIgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0ge307CiAgdmFyIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0ge307CiAgdmFyIHJ0cFN0YXRzSm9iID0gbnVsbDsKICB2YXIgcmVwb3J0U3RhdHNKb2IgPSBudWxsOwogIC8vTG9nZ2VyIHNwZWNpZmljIHRvIHNvZnRwaG9uZS4KICB2YXIgbG9nZ2VyID0gbnVsbDsKICB2YXIgU29mdHBob25lRXJyb3JUeXBlcyA9IGNvbm5lY3QuU29mdHBob25lRXJyb3JUeXBlczsKICB2YXIgSEFOR19VUF9NVUxUSVBMRV9TRVNTSU9OU19FVkVOVCA9ICJNdWx0aVNlc3Npb25IYW5nVXAiOwogIHZhciBNVUxUSVBMRV9TRVNTSU9OU19FVkVOVCA9ICJNdWx0aVNlc3Npb25zIjsKCiAgdmFyIGxvY2FsTWVkaWFTdHJlYW0gPSB7fTsKCiAgdmFyIHNvZnRwaG9uZUNsaWVudElkID0gY29ubmVjdC5yYW5kb21JZCgpOwoKICB2YXIgcmVxdWVzdEljZUFjY2VzcyA9IGZ1bmN0aW9uICh0cmFuc3BvcnQpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKS5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB0cmFuc3BvcnQsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgcmVzb2x2ZShkYXRhLnNvZnRwaG9uZVRyYW5zcG9ydC5zb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChyZWFzb24pIHsKICAgICAgICAgIGlmIChyZWFzb24ubWVzc2FnZSAmJiByZWFzb24ubWVzc2FnZS5pbmNsdWRlcygiU29mdHBob25lQ29ubmVjdGlvbkxpbWl0QnJlYWNoZWRFeGNlcHRpb24iKSkgewogICAgICAgICAgICBwdWJsaXNoRXJyb3IoIm11bHRpcGxlX3NvZnRwaG9uZV9hY3RpdmVfc2Vzc2lvbnMiLCAiTnVtYmVyIG9mIGFjdGl2ZSBzZXNzaW9ucyBhcmUgbW9yZSB0aGVuIGFsbG93ZWQgbGltaXQuIiwgIiIpOwogICAgICAgICAgfQogICAgICAgICAgcmVqZWN0KEVycm9yKCJyZXF1ZXN0SWNlQWNjZXNzIGZhaWxlZCIpKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkF1dGhlbnRpY2F0aW9uIGZhaWxlZCB3aGlsZSByZXF1ZXN0SWNlQWNjZXNzIikpOwogICAgICAgIH0sCiAgICAgICAgYWNjZXNzRGVuaWVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkFjY2VzcyBEZW5pZWQgd2hpbGUgcmVxdWVzdEljZUFjY2VzcyIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAoc29mdHBob25lUGFyYW1zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBsb2dnZXIgPSBuZXcgU29mdHBob25lTG9nZ2VyKGNvbm5lY3QuZ2V0TG9nKCkpOwogICAgbG9nZ2VyLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gc29mdHBob25lIG1hbmFnZXIgaW5pdGlhbGl6YXRpb24gaGFzIGJlZ3VuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBydGNQZWVyQ29ubmVjdGlvbkZhY3Rvcnk7CiAgICBpZiAoY29ubmVjdC5SdGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkpIHsKICAgICAgcnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5ID0gbmV3IGNvbm5lY3QuUnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KGxvZ2dlciwKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpLAogICAgICAgIHNvZnRwaG9uZUNsaWVudElkLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgcmVxdWVzdEljZUFjY2VzcywgewogICAgICAgICAgdHJhbnNwb3J0VHlwZTogInNvZnRwaG9uZSIsCiAgICAgICAgICBzb2Z0cGhvbmVDbGllbnRJZDogc29mdHBob25lQ2xpZW50SWQKICAgICAgICB9KSwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHB1Ymxpc2hFcnJvcikpOwogICAgfQogICAgaWYgKCFpc0Jyb3dzZXJTb2Z0UGhvbmVTdXBwb3J0ZWQoKSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSLAogICAgICAgICJDb25uZWN0IGRvZXMgbm90IHN1cHBvcnQgdGhpcyBicm93c2VyLiBTb21lIGZ1bmN0aW9uYWxpdHkgbWF5IG5vdCB3b3JrLiAiLAogICAgICAgICIiKTsKICAgIH0KICAgIHZhciBndW1Qcm9taXNlID0gZmV0Y2hVc2VyTWVkaWEoewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDb25uZWN0aXZpdHlDaGVja1Jlc3VsdCIsIG51bGwsIAogICAgICAgIHsKICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgIHN0YXR1czogImdyYW50ZWQiCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBwdWJsaXNoRXJyb3IoZXJyLCAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwgIiIpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICB7CiAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNaWNyb3Bob25lUGVybWlzc2lvbiIsCiAgICAgICAgICBzdGF0dXM6ICJkZW5pZWQiCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgCiAgICBoYW5kbGVTb2Z0UGhvbmVNdXRlVG9nZ2xlKCk7CiAgICBoYW5kbGVTcGVha2VyRGV2aWNlQ2hhbmdlKCk7CiAgICBoYW5kbGVNaWNyb3Bob25lRGV2aWNlQ2hhbmdlKCk7CiAgICBtb25pdG9yTWljcm9waG9uZVBlcm1pc3Npb24oKTsKCiAgICB0aGlzLnJpbmd0b25lRW5naW5lID0gbnVsbDsKICAgIHZhciBydGNTZXNzaW9ucyA9IHt9OwogICAgLy8gVHJhY2tzIHRoZSBhZ2VudCBjb25uZWN0aW9uIElELCBzbyB0aGF0IGlmIHRoZSBzYW1lIGNvbnRhY3QgZ2V0cyByZS1yb3V0ZWQgdG8gdGhlIHNhbWUgYWdlbnQsIGl0J2xsIHN0aWxsIHNldCB1cCBzb2Z0cGhvbmUKICAgIHZhciBjYWxsc0RldGVjdGVkID0ge307CiAgICB0aGlzLm9uSW5pdENvbnRhY3RTdWIgPSB7fTsKICAgIHRoaXMub25Jbml0Q29udGFjdFN1Yi51bnN1YnNjcmliZSA9IGZ1bmN0aW9uKCkge307CgogICAgLy8gdmFyaWFibGVzIGZvciBmaXJlZm94IG11bHRpdGFiCiAgICB2YXIgaXNTZXNzaW9uUGVuZGluZyA9IGZhbHNlOwogICAgdmFyIHBlbmRpbmdDb250YWN0ID0gbnVsbDsKICAgIHZhciBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBudWxsOwogICAgdmFyIHBvc3Rwb25lU3RhcnRpbmdTZXNzaW9uID0gZnVuY3Rpb24gKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlzU2Vzc2lvblBlbmRpbmcgPSB0cnVlOwogICAgICBwZW5kaW5nQ29udGFjdCA9IGNvbnRhY3Q7CiAgICAgIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IGFnZW50Q29ubmVjdGlvbklkOwogICAgfQogICAgdmFyIGNhbmNlbFBlbmRpbmdTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgICBpc1Nlc3Npb25QZW5kaW5nID0gZmFsc2U7CiAgICAgIHBlbmRpbmdDb250YWN0ID0gbnVsbDsKICAgICAgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gbnVsbDsKICAgIH0KCiAgICAvLyBoZWxwZXIgbWV0aG9kIHRvIHByb3ZpZGUgYWNjZXNzIHRvIHJ0YyBzZXNzaW9ucwogICAgdGhpcy5nZXRTZXNzaW9uID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25JZCkgewogICAgICByZXR1cm4gcnRjU2Vzc2lvbnNbY29ubmVjdGlvbklkXTsKICAgIH0KCiAgICB0aGlzLnJlcGxhY2VMb2NhbE1lZGlhVHJhY2sgPSBmdW5jdGlvbihjb25uZWN0aW9uSWQsIHRyYWNrKSB7CiAgICAgIHZhciBzdHJlYW0gPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0uc3RyZWFtOwogICAgICBpZihzdHJlYW0pewogICAgICAgIHZhciBvbGRUcmFjayA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgIHRyYWNrLmVuYWJsZWQgPSBvbGRUcmFjay5lbmFibGVkOwogICAgICAgIG9sZFRyYWNrLmVuYWJsZWQgPSBmYWxzZTsKICAgICAgICBzdHJlYW0ucmVtb3ZlVHJhY2sob2xkVHJhY2spOwogICAgICAgIHN0cmVhbS5hZGRUcmFjayh0cmFjayk7CiAgICAgIH0KICAgIH07CgogICAgdmFyIGlzQ29udGFjdFRlcm1pbmF0ZWQgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVOREVEIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkVSUk9SIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLk1JU1NFRDsKICAgIH07CgogICAgdmFyIGRlc3Ryb3lTZXNzaW9uID0gZnVuY3Rpb24gKGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShhZ2VudENvbm5lY3Rpb25JZCkpIHsKICAgICAgICB2YXIgc2Vzc2lvbiA9IHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAvLyBDdXJyZW50bHkgdGhlIGFzc3VtcHRpb24gaXMgaXQgd2lsbCB0aHJvdyBhbiBleGNlcHRpb24gb25seSBhbmQgaWYgb25seSBpdCBhbHJlYWR5IGhhcyBiZWVuIGh1bmcgdXAuCiAgICAgICAgLy8gVE9ETzogVXBkYXRlIG9uY2UgdGhlIGhhbmd1cCBBUEkgZG9lcyBub3QgdGhyb3cgZXhjZXB0aW9ucwogICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgICBzZXNzaW9uLmhhbmd1cCgpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgIGxpbHkuZ2V0TG9nKCkud2FybigiQ2xlYW4gdXAgdGhlIHNlc3Npb24gbG9jYWxseSAiICsgYWdlbnRDb25uZWN0aW9uSWQsIGVyci5tZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIC8vIFdoZW4gbXVsdGlwbGUgUlRDIHNlc3Npb25zIGRldGVjdGVkLCBpZ25vcmUgdGhlIG5ldyBjYWxsIGFuZCBoYW5nIHVwIHRoZSBwcmV2aW91cyBzZXNzaW9ucy4KICAgIC8vIFRPRE86IFVwZGF0ZSB3aGVuIGNvbm5lY3QtcnRjIGV4cG9zZXMgYW4gQVBJIHRvIGRldGVjdCBzZXNzaW9uIHN0YXR1cy4KICAgIHZhciBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb25zKSB7CiAgICAgIGlmIChPYmplY3Qua2V5cyhydGNTZXNzaW9ucykubGVuZ3RoID4gMCkgewogICAgICAgIC8vIEVycm9yISBvdXIgc3RhdGUgZG9lc24ndCBtYXRjaCwgdGVhciBpdCBhbGwgZG93bi4KICAgICAgICBmb3IgKHZhciBjb25uZWN0aW9uSWQgaW4gcnRjU2Vzc2lvbnMpIHsKICAgICAgICAgIGlmIChydGNTZXNzaW9ucy5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgICAgIC8vIExvZyBhbiBlcnJvciBmb3IgdGhlIHNlc3Npb24gd2UgYXJlIGFib3V0IHRvIGVuZC4KICAgICAgICAgICAgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudChIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5ULCBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdLmNhbGxJZCwgY29ubmVjdGlvbklkKTsKICAgICAgICAgICAgZGVzdHJveVNlc3Npb24oY29ubmVjdGlvbklkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkdXBsaWNhdGUgc2Vzc2lvbiBkZXRlY3RlZCwgcmVmdXNpbmcgdG8gc2V0dXAgbmV3IGNvbm5lY3Rpb24iKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLnN0YXJ0U2Vzc2lvbiA9IGZ1bmN0aW9uIChfY29udGFjdCwgX2FnZW50Q29ubmVjdGlvbklkKSB7CiAgICAgIHZhciBjb250YWN0ID0gaXNTZXNzaW9uUGVuZGluZyA/IHBlbmRpbmdDb250YWN0IDogX2NvbnRhY3Q7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGlzU2Vzc2lvblBlbmRpbmcgPyBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgOiBfYWdlbnRDb25uZWN0aW9uSWQ7CiAgICAgIGlmICghY29udGFjdCB8fCAhYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY2FuY2VsUGVuZGluZ1Nlc3Npb24oKTsKICAgICAgCiAgICAgIC8vIFNldCB0byB0cnVlLCB0aGlzIHdpbGwgYmxvY2sgc3Vic2VxdWVudCBpbnZva2VzIGZyb20gZW50ZXJpbmcuCiAgICAgIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdID0gdHJ1ZTsKICAgICAgbG9nZ2VyLmluZm8oIlNvZnRwaG9uZSBjYWxsIGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgLy8gRW5zdXJlIG91ciBzZXNzaW9uIHN0YXRlIG1hdGNoZXMgb3VyIGNvbnRhY3Qgc3RhdGUgdG8gcHJldmVudCBpc3N1ZXMgc2hvdWxkIHdlIGxvc2UgdHJhY2sgb2YgYSBjb250YWN0LgogICAgICBzYW5pdHlDaGVja0FjdGl2ZVNlc3Npb25zKHJ0Y1Nlc3Npb25zKTsKCiAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORykgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIENvbm5lY3RpbmciLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgfQoKICAgICAgaW5pdGlhbGl6ZVBhcmFtcygpOwogICAgICB2YXIgc29mdHBob25lSW5mbyA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuZ2V0U29mdHBob25lTWVkaWFJbmZvKCk7CiAgICAgIHZhciBjYWxsQ29uZmlnID0gcGFyc2VDYWxsQ29uZmlnKHNvZnRwaG9uZUluZm8uY2FsbENvbmZpZ0pzb24pOwogICAgICB2YXIgd2ViU29ja2V0UHJvdmlkZXI7CiAgICAgIGlmIChjYWxsQ29uZmlnLnVzZVdlYlNvY2tldFByb3ZpZGVyKSB7CiAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIgPSBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpOwogICAgICB9CiAgICAgIHZhciBzZXNzaW9uID0gbmV3IGNvbm5lY3QuUlRDU2Vzc2lvbigKICAgICAgICBjYWxsQ29uZmlnLnNpZ25hbGluZ0VuZHBvaW50LAogICAgICAgIGNhbGxDb25maWcuaWNlU2VydmVycywKICAgICAgICBzb2Z0cGhvbmVJbmZvLmNhbGxDb250ZXh0VG9rZW4sCiAgICAgICAgbG9nZ2VyLAogICAgICAgIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksCiAgICAgICAgYWdlbnRDb25uZWN0aW9uSWQsCiAgICAgICAgd2ViU29ja2V0UHJvdmlkZXIpOwoKICAgICAgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdID0gc2Vzc2lvbjsKCiAgICAgIGlmIChjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCkpIHsKICAgICAgICBzZXNzaW9uLm1lZGlhU3RyZWFtID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSgpOwogICAgICB9CgogICAgICAvLyBDdXN0b20gRXZlbnQgdG8gaW5kaWNhdGUgdGhlIHNlc3Npb24gaW5pdCBvcGVyYXRpb25zCiAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwKICAgICAgICBkYXRhOiB7CiAgICAgICAgICBjb25uZWN0aW9uSWQ6IGFnZW50Q29ubmVjdGlvbklkCiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIHNlc3Npb24ub25TZXNzaW9uRmFpbGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgICAgIGRlbGV0ZSBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgZGVsZXRlIGNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIHB1Ymxpc2hTb2Z0cGhvbmVGYWlsdXJlTG9ncyhydGNTZXNzaW9uLCByZWFzb24pOwogICAgICAgIHB1Ymxpc2hTZXNzaW9uRmFpbHVyZVRlbGVtZXRyeUV2ZW50KGNvbnRhY3QuZ2V0Q29udGFjdElkKCksIHJlYXNvbik7CiAgICAgICAgc3RvcEpvYnNBbmRSZXBvcnQoY29udGFjdCwgcnRjU2Vzc2lvbi5zZXNzaW9uUmVwb3J0KTsKICAgICAgfTsKICAgICAgc2Vzc2lvbi5vblNlc3Npb25Db25uZWN0ZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiU29mdHBob25lIFNlc3Npb24gQ29ubmVjdGVkIiwgY29udGFjdC5nZXRDb250YWN0SWQoKSk7CiAgICAgICAgLy8gQmVjb21lIG1hc3RlciB0byBzZW5kIGxvZ3MsIHNpbmNlIHdlIG5lZWQgbG9ncyBmcm9tIHNvZnRwaG9uZSB0YWIuCiAgICAgICAgY29ubmVjdC5iZWNvbWVNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU0VORF9MT0dTKTsKICAgICAgICAvL3N0YXJ0IHN0YXRzIGNvbGxlY3Rpb24gYW5kIHJlcG9ydGluZyBqb2JzCiAgICAgICAgc3RhcnRTdGF0c0NvbGxlY3Rpb25Kb2IocnRjU2Vzc2lvbik7CiAgICAgICAgc3RhcnRTdGF0c1JlcG9ydGluZ0pvYihjb250YWN0KTsKICAgICAgICBmaXJlQ29udGFjdEFjY2VwdGVkRXZlbnQoY29udGFjdCk7CiAgICAgIH07CgogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbXBsZXRlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb21wbGV0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKCiAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgLy8gU3RvcCBhbGwgam9icyBhbmQgcGVyZm9ybSBvbmUgbGFzdCBqb2IuCiAgICAgICAgc3RvcEpvYnNBbmRSZXBvcnQoY29udGFjdCwgcnRjU2Vzc2lvbi5zZXNzaW9uUmVwb3J0KTsKCiAgICAgICAgLy8gQ2xlYW51cCB0aGUgY2FjaGVkIHN0cmVhbXMKICAgICAgICBkZWxldGVMb2NhbE1lZGlhU3RyZWFtKGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ub25Mb2NhbFN0cmVhbUFkZGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHN0cmVhbSkgewogICAgICAgIC8vIENhY2hlIHRoZSBzdHJlYW1zIGZvciBtdXRlL3VubXV0ZQogICAgICAgIGxvY2FsTWVkaWFTdHJlYW1bYWdlbnRDb25uZWN0aW9uSWRdID0gewogICAgICAgICAgc3RyZWFtOiBzdHJlYW0KICAgICAgICB9OwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLkxPQ0FMX01FRElBX1NUUkVBTV9DUkVBVEVELAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBjb25uZWN0aW9uSWQ6IGFnZW50Q29ubmVjdGlvbklkCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICBzZXNzaW9uLnJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGUtYXVkaW8nKTsKICAgICAgaWYgKHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSkgewogICAgICAgIHNlc3Npb24uY29ubmVjdChydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkuZ2V0KGNhbGxDb25maWcuaWNlU2VydmVycykpOwogICAgICB9IGVsc2UgewogICAgICAgIHNlc3Npb24uY29ubmVjdCgpOwogICAgICB9CiAgICB9CgogICAgdmFyIG9uUmVmcmVzaENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXSAmJiBpc0NvbnRhY3RUZXJtaW5hdGVkKGNvbnRhY3QpKSB7CiAgICAgICAgZGVzdHJveVNlc3Npb24oYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIGNhbmNlbFBlbmRpbmdTZXNzaW9uKCk7CiAgICAgIH0KICAgICAgaWYgKGNvbnRhY3QuaXNTb2Z0cGhvbmVDYWxsKCkgJiYgIWNhbGxzRGV0ZWN0ZWRbYWdlbnRDb25uZWN0aW9uSWRdICYmICgKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyB8fAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykpIHsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb25uZWN0Lmhhc090aGVyQ29ubmVjdGVkQ0NQcygpKSB7CiAgICAgICAgICAgIHBvc3Rwb25lU3RhcnRpbmdTZXNzaW9uKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICB2YXIgb25Jbml0Q29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuY29ubmVjdGlvbklkOwogICAgICBsb2dnZXIuaW5mbygiQ29udGFjdCBkZXRlY3RlZDoiLCAiY29udGFjdElkICIgKyBjb250YWN0LmdldENvbnRhY3RJZCgpLCAiYWdlbnQgY29ubmVjdGlvbklkICIgKyBhZ2VudENvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgIGlmICghY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0pIHsKICAgICAgICBjb250YWN0Lm9uUmVmcmVzaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvblJlZnJlc2hDb250YWN0KGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICBzZWxmLm9uSW5pdENvbnRhY3RTdWIgPSBjb25uZWN0LmNvbnRhY3Qob25Jbml0Q29udGFjdCk7CgogICAgLy8gQ29udGFjdCBhbHJlYWR5IGluIGNvbm5lY3Rpbmcgc3RhdGUgc2NlbmFyaW8gLSBJbiB0aGlzIGNhc2UgY29udGFjdCBJTklUIGlzIG1pc3NlZCBoZW5jZSB0aGUgT25SZWZyZXNoIGNhbGxiYWNrIGlzIG1pc3NlZC4gCiAgICBuZXcgY29ubmVjdC5BZ2VudCgpLmdldENvbnRhY3RzKCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICB2YXIgYWdlbnRDb25uZWN0aW9uSWQgPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmNvbm5lY3Rpb25JZDsKICAgICAgbG9nZ2VyLmluZm8oIkNvbnRhY3QgZXhpc3QgaW4gdGhlIHNuYXBzaG90LiBSZWluaXRpYXRlIHRoZSBDb250YWN0IGFuZCBSVEMgc2Vzc2lvbiBjcmVhdGlvbiBmb3IgY29udGFjdElkIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBvbkluaXRDb250YWN0KGNvbnRhY3QpOwogICAgICBvblJlZnJlc2hDb250YWN0KGNvbnRhY3QsIGFnZW50Q29ubmVjdGlvbklkKTsKICAgIH0pOwogIH07CgogIHZhciBmaXJlQ29udGFjdEFjY2VwdGVkRXZlbnQgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgIHZhciBhZ2VudENvbm5lY3Rpb24gPSBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpOwogICAgaWYgKCFhZ2VudENvbm5lY3Rpb24pIHsKICAgICAgbG9nZ2VyLmluZm8oIk5vdCBhYmxlIHRvIHJldHJpZXZlIHRoZSBhdXRvLWFjY2VwdCBzZXR0aW5nIGZyb20gbnVsbCBBZ2VudENvbm5lY3Rpb24sIGlnbm9yaW5nIGV2ZW50IHB1Ymxpc2guLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzb2Z0cGhvbmVNZWRpYUluZm8gPSBhZ2VudENvbm5lY3Rpb24uZ2V0U29mdHBob25lTWVkaWFJbmZvKCk7CiAgICBpZiAoIXNvZnRwaG9uZU1lZGlhSW5mbykgewogICAgICBsb2dnZXIuaW5mbygiTm90IGFibGUgdG8gcmV0cmlldmUgdGhlIGF1dG8tYWNjZXB0IHNldHRpbmcgZnJvbSBudWxsIFNvZnRwaG9uZU1lZGlhSW5mbywgaWdub3JpbmcgZXZlbnQgcHVibGlzaC4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHNvZnRwaG9uZU1lZGlhSW5mby5hdXRvQWNjZXB0ID09PSB0cnVlKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJBdXRvLWFjY2VwdCBpcyBlbmFibGVkLCBzZW5kaW5nIG91dCBBY2NlcHRlZCBldmVudCB0byBzdG9wIHJpbmd0b25lLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgIGRhdGE6IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdC5jb250YWN0SWQpCiAgICAgIH0pOwogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICBldmVudDogY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELCBjb250YWN0LmNvbnRhY3RJZCksCiAgICAgICAgZGF0YTogbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0LmNvbnRhY3RJZCkKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBsb2dnZXIuaW5mbygiQXV0by1hY2NlcHQgaXMgZGlzYWJsZWQsIHJpbmd0b25lIHdpbGwgYmUgc3RvcHBlZCBieSB1c2VyIGFjdGlvbi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIC8vIEJpbmQgZXZlbnRzIGZvciBtdXRlCiAgdmFyIGhhbmRsZVNvZnRQaG9uZU11dGVUb2dnbGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUsIG11dGVUb2dnbGUpOwogIH07CgogIHZhciBoYW5kbGVTcGVha2VyRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfU1BFQUtFUl9ERVZJQ0UsIHNldFNwZWFrZXJEZXZpY2UpOwogIH0KCiAgdmFyIGhhbmRsZU1pY3JvcGhvbmVEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsIHNldE1pY3JvcGhvbmVEZXZpY2UpOwogIH0KCiAgdmFyIG1vbml0b3JNaWNyb3Bob25lUGVybWlzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmlzQ2hyb21lQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0Q2hyb21lQnJvd3NlclZlcnNpb24oKSA+IDQzKXsKICAgICAgICBuYXZpZ2F0b3IucGVybWlzc2lvbnMucXVlcnkoe25hbWU6ICdtaWNyb3Bob25lJ30pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocGVybWlzc2lvblN0YXR1cyl7CiAgICAgICAgICBwZXJtaXNzaW9uU3RhdHVzLm9uY2hhbmdlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk1pY3JvcGhvbmUgUGVybWlzc2lvbjogIiArIHBlcm1pc3Npb25TdGF0dXMuc3RhdGUpOwogICAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0IiwgbnVsbCwgCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb25uZWN0aXZpdHlDaGVja1R5cGU6ICJNaWNyb3Bob25lUGVybWlzc2lvbiIsCiAgICAgICAgICAgICAgc3RhdHVzOiBwZXJtaXNzaW9uU3RhdHVzLnN0YXRlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZihwZXJtaXNzaW9uU3RhdHVzLnN0YXRlID09PSAnZGVuaWVkJyl7CiAgICAgICAgICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVELAogICAgICAgICAgICAgICAgIllvdXIgbWljcm9waG9uZSBpcyBub3QgZW5hYmxlZCBpbiB5b3VyIGJyb3dzZXIuICIsCiAgICAgICAgICAgICAgICAiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGxvZ2dlci5lcnJvcigiRmFpbGVkIGluIGRldGVjdGluZyBtaWNyb3Bob25lIHBlcm1pc3Npb24gc3RhdHVzOiAiICsgZSk7CiAgICB9CiAgfQoKICAvLyBNYWtlIHN1cmUgb25jZSB3ZSBkaXNjb25uZWN0ZWQgd2UgZ2V0IHRoZSBtdXRlIHN0YXRlIGJhY2sgdG8gbm9ybWFsCiAgdmFyIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICBkZWxldGUgbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogZmFsc2UgfQogICAgfSk7CiAgfTsKCiAgLy8gQ2hlY2sgZm9yIHRoZSBsb2NhbCBzdHJlYW1zIGlmIGV4aXN0cyAgLSAgcmV2ZXJ0IGl0CiAgLy8gQW5kIGluZm9ybSBvdGhlciBjbGllbnRzIGFib3V0IHRoZSBjaGFuZ2UgCiAgdmFyIG11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHN0YXR1czsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZGF0YSAmJiBkYXRhLm11dGUgIT09IHVuZGVmaW5lZCkgewogICAgICBzdGF0dXMgPSBkYXRhLm11dGU7CiAgICB9CgogICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICBpZiAobG9jYWxNZWRpYSkgewogICAgICAgICAgdmFyIGF1ZGlvVHJhY2tzID0gbG9jYWxNZWRpYS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgaWYgKHN0YXR1cyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGF1ZGlvVHJhY2tzLmVuYWJsZWQgPSAhc3RhdHVzOwogICAgICAgICAgICBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgPSBzdGF0dXM7CgogICAgICAgICAgICBpZiAoc3RhdHVzKSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyBtdXRlZCB0aGUgY29udGFjdCwgY29ubmVjdGlvbklkIC0gICIgKyBjb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFnZW50IGhhcyB1bm11dGVkIHRoZSBjb250YWN0LCBjb25uZWN0aW9uSWQgLSAiICsgY29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdHVzID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLm11dGVkIHx8IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTVVURV9UT0dHTEUsCiAgICAgIGRhdGE6IHsgbXV0ZWQ6IHN0YXR1cyB9CiAgICB9KTsKICB9OwoKICB2YXIgc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCB8fCAhZGF0YSB8fCAhZGF0YS5kZXZpY2VJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgdmFyIHJlbW90ZUF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGUtYXVkaW8nKTsKICAgIHRyeSB7CiAgICAgIGxvZ2dlci5pbmZvKCJUcnlpbmcgdG8gc2V0IHNwZWFrZXIgdG8gZGV2aWNlICIgKyBkZXZpY2VJZCk7CiAgICAgIGlmIChyZW1vdGVBdWRpb0VsZW1lbnQgJiYgdHlwZW9mIHJlbW90ZUF1ZGlvRWxlbWVudC5zZXRTaW5rSWQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZW1vdGVBdWRpb0VsZW1lbnQuc2V0U2lua0lkKGRldmljZUlkKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgc3BlYWtlciB0byBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU1BFQUtFUl9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgc2V0TWljcm9waG9uZURldmljZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBpZiAoY29ubmVjdC5rZXlzKGxvY2FsTWVkaWFTdHJlYW0pLmxlbmd0aCA9PT0gMCAgfHwgIWRhdGEgfHwgIWRhdGEuZGV2aWNlSWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIHZhciBzb2Z0cGhvbmVNYW5hZ2VyID0gY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIoKTsKICAgIHRyeSB7CiAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsgYXVkaW86IHsgZGV2aWNlSWQ6IHsgZXhhY3Q6IGRldmljZUlkIH0gfSB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChuZXdNaWNyb3Bob25lU3RyZWFtKSB7CiAgICAgICAgICB2YXIgbmV3TWljcm9waG9uZVRyYWNrID0gbmV3TWljcm9waG9uZVN0cmVhbS5nZXRBdWRpb1RyYWNrcygpWzBdOwogICAgICAgICAgZm9yICh2YXIgY29ubmVjdGlvbklkIGluIGxvY2FsTWVkaWFTdHJlYW0pIHsKICAgICAgICAgICAgaWYgKGxvY2FsTWVkaWFTdHJlYW0uaGFzT3duUHJvcGVydHkoY29ubmVjdGlvbklkKSkgewogICAgICAgICAgICAgIHZhciBsb2NhbE1lZGlhID0gbG9jYWxNZWRpYVN0cmVhbVtjb25uZWN0aW9uSWRdLnN0cmVhbTsKICAgICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgICAgIC8vUmVwbGFjZSB0aGUgYXVkaW8gdHJhY2sgaW4gdGhlIFJ0Y1BlZXJDb25uZWN0aW9uCiAgICAgICAgICAgICAgc2Vzc2lvbi5fcGMuZ2V0U2VuZGVycygpWzBdLnJlcGxhY2VUcmFjayhuZXdNaWNyb3Bob25lVHJhY2spLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgLy9SZXBsYWNlIHRoZSBhdWRpbyB0cmFjayBpbiB0aGUgbG9jYWwgbWVkaWEgc3RyZWFtIChmb3IgbXV0ZSAvIHVubXV0ZSkKICAgICAgICAgICAgICAgIHNvZnRwaG9uZU1hbmFnZXIucmVwbGFjZUxvY2FsTWVkaWFUcmFjayhjb25uZWN0aW9uSWQsIG5ld01pY3JvcGhvbmVUcmFjayk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0gY2F0Y2goZSkgewogICAgICBsb2dnZXIuZXJyb3IoIkZhaWxlZCB0byBzZXQgbWljcm9waG9uZSBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgIH0KCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuTUlDUk9QSE9ORV9ERVZJQ0VfQ0hBTkdFRCwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfQoKICB2YXIgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24sIHJlYXNvbikgewogICAgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCkgewogICAgICB2YXIgZW5kUG9pbnRVcmwgPSAiXG4iOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJscy5sZW5ndGg7IGorKykgewogICAgICAgICAgZW5kUG9pbnRVcmwgPSBlbmRQb2ludFVybCArIHJ0Y1Nlc3Npb24uX2ljZVNlcnZlcnNbaV0udXJsc1tqXSArICJcbiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLklDRV9DT0xMRUNUSU9OX1RJTUVPVVQsICJJY2UgY29sbGVjdGlvbiB0aW1lZG91dC4gIiwgZW5kUG9pbnRVcmwpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlVTRVJfQlVTWSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5VU0VSX0JVU1lfRVJST1IsCiAgICAgICAgIlNvZnRwaG9uZSBjYWxsIFVzZXJCdXN5IGVycm9yLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0hBTkRTSEFLRV9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUsCiAgICAgICAgIkhhbmRzaGFraW5nIHdpdGggU2lnbmFsbGluZyBTZXJ2ZXIgIiArIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSArICIgZmFpbGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX1RJTUVPVVRfRkFJTFVSRSB8fCByZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkdVTV9PVEhFUl9GQUlMVVJFKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCwKICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAiIik7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19DT05ORUNUSU9OX0ZBSUxVUkUsCiAgICAgICAgIlVSTCAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBjYW5ub3QgYmUgcmVhY2hlZC4gIiwKICAgICAgICBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLkNBTExfTk9UX0ZPVU5EKSB7CiAgICAgIC8vIE5vIG5lZWQgdG8gcHVibGlzaCBhbnkgc29mdHBob25lIGVycm9yIGZvciB0aGlzIGNhc2UuIENDUCBVWCB3aWxsIGhhbmRsZSB0aGlzIGNhc2UuCiAgICAgIGxvZ2dlci5lcnJvcigiU29mdHBob25lIGNhbGwgZmFpbGVkIGR1ZSB0byBDYWxsTm90Rm91bmRFeGNlcHRpb24uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0gZWxzZSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLldFQlJUQ19FUlJPUiwKICAgICAgICAid2VicnRjIHN5c3RlbSBlcnJvci4gIiwKICAgICAgICAiIik7CiAgICB9CiAgfTsKCiAgLyoqIFBhcnNlIHRoZSBKU09OIGVuY29kZWQgd2ViIGNhbGwgY29uZmlnIGludG8gdGhlIGRhdGEgaXQgcmVwcmVzZW50cy4gKi8KICB2YXIgcGFyc2VDYWxsQ29uZmlnID0gZnVuY3Rpb24gKHNlcmlhbGl6ZWRDb25maWcpIHsKICAgIC8vIE91ciB1bmRlcnNjb3JlIGlzIHRvbyBvbGQgZm9yIHVuZXNjYXBlCiAgICAvLyBodHRwczovL2lzc3Vlcy5hbWF6b24uY29tL2lzc3Vlcy9DU1dGLTE0NjcKICAgIHZhciBkZWNvZGVkSlNPTiA9IHNlcmlhbGl6ZWRDb25maWcucmVwbGFjZSgvJnF1b3Q7L2csICciJyk7CiAgICByZXR1cm4gSlNPTi5wYXJzZShkZWNvZGVkSlNPTik7CiAgfTsKCiAgdmFyIGZldGNoVXNlck1lZGlhID0gZnVuY3Rpb24gKGNhbGxiYWNrc0luKSB7CiAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwge307CiAgICBjYWxsYmFja3Muc3VjY2VzcyA9IGNhbGxiYWNrcy5zdWNjZXNzIHx8IGZ1bmN0aW9uICgpIHsgfTsKICAgIGNhbGxiYWNrcy5mYWlsdXJlID0gY2FsbGJhY2tzLmZhaWx1cmUgfHwgZnVuY3Rpb24gKCkgeyB9OwoKICAgIHZhciBDT05TVFJBSU5UID0gewogICAgICBhdWRpbzogdHJ1ZQogICAgfTsKCiAgICB2YXIgcHJvbWlzZSA9IG51bGw7CgogICAgaWYgKHR5cGVvZiBQcm9taXNlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuVU5TVVBQT1JURURfQlJPV1NFUik7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAodHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMgPT09ICJvYmplY3QiICYmIHR5cGVvZiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCk7CgogICAgfSBlbHNlIGlmICh0eXBlb2YgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYSA9PT0gImZ1bmN0aW9uIikgewogICAgICBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIG5hdmlnYXRvci53ZWJraXRHZXRVc2VyTWVkaWEoQ09OU1RSQUlOVCwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHByb21pc2UudGhlbihmdW5jdGlvbiAoc3RyZWFtKSB7CiAgICAgIHZhciBhdWRpb1RyYWNrcyA9IHN0cmVhbS5nZXRBdWRpb1RyYWNrcygpOwogICAgICBpZiAoYXVkaW9UcmFja3MgJiYgYXVkaW9UcmFja3MubGVuZ3RoID4gMCkgewogICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHN0cmVhbSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVEKTsKICAgIH0pOwogICAgcmV0dXJuIHByb21pc2U7CiAgfTsKCiAgdmFyIHB1Ymxpc2hFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICBsb2dnZXIuZXJyb3IoIlNvZnRwaG9uZSBlcnJvciBvY2N1cnJlZCA6ICIsIGVycm9yVHlwZSwKICAgICAgbWVzc2FnZSB8fCAiIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLlNPRlRQSE9ORV9FUlJPUiwKICAgICAgZGF0YTogbmV3IGNvbm5lY3QuU29mdHBob25lRXJyb3IoZXJyb3JUeXBlLCBtZXNzYWdlLCBlbmRQb2ludFVybCkKICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoU2Vzc2lvbkZhaWx1cmVUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0SWQsIHJlYXNvbikgewogICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBGYWlsZWQiLCBjb250YWN0SWQsIHsKICAgICAgZmFpbGVkUmVhc29uOiByZWFzb24KICAgIH0pOwogIH07CgogIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGRhdGEpIHsKICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgY29udGFjdElkOiBjb250YWN0SWQsCiAgICAgIGRhdGE6IGRhdGEKICAgIH0pOwogIH07CgogIC8vIFB1Ymxpc2ggdGhlIGNvbnRhY3QgYW5kIGFnZW50IGluZm9ybWF0aW9uIGluIGEgbXVsdGlwbGUgc2Vzc2lvbnMgc2NlbmFyaW9zCiAgdmFyIHB1Ymxpc2hNdWx0aXBsZVNlc3Npb25zRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjb250YWN0SWQsIGFnZW50Q29ubmVjdGlvbklkKSB7CiAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoZXZlbnROYW1lLCBjb250YWN0SWQsIFt7CiAgICAgIG5hbWU6ICJBZ2VudENvbm5lY3Rpb25JZCIsCiAgICAgIHZhbHVlOiBhZ2VudENvbm5lY3Rpb25JZAogICAgfV0pOwogICAgbG9nZ2VyLmluZm8oIlB1Ymxpc2ggbXVsdGlwbGUgc2Vzc2lvbiBlcnJvciBtZXRyaWNzIiwgZXZlbnROYW1lLCAiY29udGFjdElkICIgKyBjb250YWN0SWQsICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKQogICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICB9OwoKICB2YXIgaXNCcm93c2VyU29mdFBob25lU3VwcG9ydGVkID0gZnVuY3Rpb24gKCkgewogICAgLy8gSW4gT3BlcmEsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIk9wZXJhIiBvciBhZnRlciAiVmVyc2lvbiIKICAgIGlmIChjb25uZWN0LmlzT3BlcmFCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uKCkgPiAxNykgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIENocm9tZSwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiQ2hyb21lIgogICAgZWxzZSBpZiAoY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uKCkgPiAyMikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIEluIEZpcmVmb3gsIHRoZSB0cnVlIHZlcnNpb24gaXMgYWZ0ZXIgIkZpcmVmb3giCiAgICBlbHNlIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb25uZWN0LmdldEZpcmVmb3hCcm93c2VyVmVyc2lvbigpID4gMjEpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKCiAgdmFyIHNlbmRTb2Z0cGhvbmVNZXRyaWNzID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzdHJlYW1TdGF0cyA9IHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlci5zbGljZSgpOwogICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyID0gW107CiAgICBpZiAoc3RyZWFtU3RhdHMubGVuZ3RoID4gMCkgewogICAgICBjb250YWN0LnNlbmRTb2Z0cGhvbmVNZXRyaWNzKHN0cmVhbVN0YXRzLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9nZ2VyLmluZm8oInNlbmRTb2Z0cGhvbmVNZXRyaWNzIHN1Y2Nlc3MiICsgSlNPTi5zdHJpbmdpZnkoc3RyZWFtU3RhdHMpKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBsb2dnZXIuZXJyb3IoInNlbmRTb2Z0cGhvbmVNZXRyaWNzIGZhaWxlZC4iKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIHZhciBzZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKGNvbnRhY3QsIHJlcG9ydCwgdXNlckF1ZGlvU3RhdHMsIHJlbW90ZUF1ZGlvU3RhdHMpIHsKICAgIHJlcG9ydC5zdHJlYW1TdGF0cyA9IFthZGRTdHJlYW1UeXBlVG9TdGF0cyh1c2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLAogICAgYWRkU3RyZWFtVHlwZVRvU3RhdHMocmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKV07CiAgICB2YXIgY2FsbFJlcG9ydCA9IHsKICAgICAgY2FsbFN0YXJ0VGltZTogcmVwb3J0LnNlc3Npb25TdGFydFRpbWUsCiAgICAgIGNhbGxFbmRUaW1lOiByZXBvcnQuc2Vzc2lvbkVuZFRpbWUsCiAgICAgIGd1bVRpbWVNaWxsaXM6IHJlcG9ydC5ndW1UaW1lTWlsbGlzLAogICAgICBpbml0aWFsaXphdGlvblRpbWVNaWxsaXM6IHJlcG9ydC5pbml0aWFsaXphdGlvblRpbWVNaWxsaXMsCiAgICAgIGljZUNvbGxlY3Rpb25UaW1lTWlsbGlzOiByZXBvcnQuaWNlQ29sbGVjdGlvblRpbWVNaWxsaXMsCiAgICAgIHNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpczogcmVwb3J0LnNpZ25hbGxpbmdDb25uZWN0VGltZU1pbGxpcywKICAgICAgaGFuZHNoYWtpbmdUaW1lTWlsbGlzOiByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzLAogICAgICBwcmVUYWxraW5nVGltZU1pbGxpczogcmVwb3J0LnByZVRhbGtpbmdUaW1lTWlsbGlzLAogICAgICB0YWxraW5nVGltZU1pbGxpczogcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzLAogICAgICBjbGVhbnVwVGltZU1pbGxpczogcmVwb3J0LmNsZWFudXBUaW1lTWlsbGlzLAogICAgICBpY2VDb2xsZWN0aW9uRmFpbHVyZTogcmVwb3J0LmljZUNvbGxlY3Rpb25GYWlsdXJlLAogICAgICBzaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmU6IHJlcG9ydC5zaWduYWxsaW5nQ29ubmVjdGlvbkZhaWx1cmUsCiAgICAgIGhhbmRzaGFraW5nRmFpbHVyZTogcmVwb3J0LmhhbmRzaGFraW5nRmFpbHVyZSwKICAgICAgZ3VtT3RoZXJGYWlsdXJlOiByZXBvcnQuZ3VtT3RoZXJGYWlsdXJlLAogICAgICBndW1UaW1lb3V0RmFpbHVyZTogcmVwb3J0Lmd1bVRpbWVvdXRGYWlsdXJlLAogICAgICBjcmVhdGVPZmZlckZhaWx1cmU6IHJlcG9ydC5jcmVhdGVPZmZlckZhaWx1cmUsCiAgICAgIHNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlOiByZXBvcnQuc2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHVzZXJCdXN5RmFpbHVyZTogcmVwb3J0LnVzZXJCdXN5RmFpbHVyZSwKICAgICAgaW52YWxpZFJlbW90ZVNEUEZhaWx1cmU6IHJlcG9ydC5pbnZhbGlkUmVtb3RlU0RQRmFpbHVyZSwKICAgICAgbm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlOiByZXBvcnQubm9SZW1vdGVJY2VDYW5kaWRhdGVGYWlsdXJlLAogICAgICBzZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmU6IHJlcG9ydC5zZXRSZW1vdGVEZXNjcmlwdGlvbkZhaWx1cmUsCiAgICAgIHNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3M6IHJlcG9ydC5zdHJlYW1TdGF0cwogICAgfTsKICAgIGNvbnRhY3Quc2VuZFNvZnRwaG9uZVJlcG9ydChjYWxsUmVwb3J0LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICBsb2dnZXIuaW5mbygic2VuZFNvZnRwaG9uZVJlcG9ydCBzdWNjZXNzIiArIEpTT04uc3RyaW5naWZ5KGNhbGxSZXBvcnQpKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKCJzZW5kU29mdHBob25lUmVwb3J0IGZhaWxlZC4iKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c0NvbGxlY3Rpb25Kb2IgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbikgewogICAgcnRwU3RhdHNKb2IgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICBydGNTZXNzaW9uLmdldFVzZXJBdWRpb1N0YXRzKCkudGhlbihmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICB2YXIgcHJldmlvdXNVc2VyU3RhdHMgPSBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHM7CiAgICAgICAgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0gc3RhdHM7CiAgICAgICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnB1c2goZ2V0VGltZVNlcmllc1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgcHJldmlvdXNVc2VyU3RhdHMsIEFVRElPX0lOUFVUKSk7CiAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgIGxvZ2dlci5kZWJ1ZygiRmFpbGVkIHRvIGdldCB1c2VyIGF1ZGlvIHN0YXRzLiIsIGVycm9yKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKICAgICAgcnRjU2Vzc2lvbi5nZXRSZW1vdGVBdWRpb1N0YXRzKCkudGhlbihmdW5jdGlvbiAoc3RhdHMpIHsKICAgICAgICB2YXIgcHJldmlvdXNSZW1vdGVTdGF0cyA9IGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzOwogICAgICAgIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0gc3RhdHM7CiAgICAgICAgdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnB1c2goZ2V0VGltZVNlcmllc1N0YXRzKGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzLCBwcmV2aW91c1JlbW90ZVN0YXRzLCBBVURJT19PVVRQVVQpKTsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgbG9nZ2VyLmRlYnVnKCJGYWlsZWQgdG8gZ2V0IHJlbW90ZSBhdWRpbyBzdGF0cy4iLCBlcnJvcikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSk7CiAgICB9LCAxMDAwKTsKICB9OwoKICB2YXIgc3RhcnRTdGF0c1JlcG9ydGluZ0pvYiA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICByZXBvcnRTdGF0c0pvYiA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbmRTb2Z0cGhvbmVNZXRyaWNzKGNvbnRhY3QpOwogICAgfSwgc3RhdHNSZXBvcnRpbmdKb2JJbnRlcnZhbE1zKTsKICB9OwoKICB2YXIgaW5pdGlhbGl6ZVBhcmFtcyA9IGZ1bmN0aW9uICgpIHsKICAgIGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cyA9IG51bGw7CiAgICBhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cyA9IG51bGw7CiAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICAgIHJ0cFN0YXRzSm9iID0gbnVsbDsKICAgIHJlcG9ydFN0YXRzSm9iID0gbnVsbDsKICB9OwoKICB2YXIgZ2V0VGltZVNlcmllc1N0YXRzID0gZnVuY3Rpb24gKGN1cnJlbnRTdGF0cywgcHJldmlvdXNTdGF0cywgc3RyZWFtVHlwZSkgewogICAgaWYgKHByZXZpb3VzU3RhdHMgJiYgY3VycmVudFN0YXRzKSB7CiAgICAgIHZhciBwYWNrZXRzTG9zdCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCA+IHByZXZpb3VzU3RhdHMucGFja2V0c0xvc3QgPyBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNMb3N0IDogMDsKICAgICAgdmFyIHBhY2tldHNDb3VudCA9IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgPiBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA/IGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQgLSBwcmV2aW91c1N0YXRzLnBhY2tldHNDb3VudCA6IDA7CiAgICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoY3VycmVudFN0YXRzLnRpbWVzdGFtcCwKICAgICAgICBwYWNrZXRzTG9zdCwKICAgICAgICBwYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IFJUUFN0cmVhbVN0YXRzKGN1cnJlbnRTdGF0cy50aW1lc3RhbXAsCiAgICAgICAgY3VycmVudFN0YXRzLnBhY2tldHNMb3N0LAogICAgICAgIGN1cnJlbnRTdGF0cy5wYWNrZXRzQ291bnQsCiAgICAgICAgc3RyZWFtVHlwZSwKICAgICAgICBjdXJyZW50U3RhdHMuYXVkaW9MZXZlbCwKICAgICAgICBjdXJyZW50U3RhdHMuamJNaWxsaXNlY29uZHMsCiAgICAgICAgY3VycmVudFN0YXRzLnJ0dE1pbGxpc2Vjb25kcyk7CiAgICB9CiAgfTsKCiAgdmFyIHN0b3BKb2IgPSBmdW5jdGlvbiAodGFzaykgewogICAgaWYgKHRhc2sgIT09IG51bGwpIHsKICAgICAgd2luZG93LmNsZWFySW50ZXJ2YWwodGFzayk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKICB9OwoKICB2YXIgc3RvcEpvYnNBbmRSZXBvcnQgPSBmdW5jdGlvbiAoY29udGFjdCwgc2Vzc2lvblJlcG9ydCkgewogICAgcnRwU3RhdHNKb2IgPSBzdG9wSm9iKHJ0cFN0YXRzSm9iKTsKICAgIHJlcG9ydFN0YXRzSm9iID0gc3RvcEpvYihyZXBvcnRTdGF0c0pvYik7CiAgICBzZW5kU29mdHBob25lUmVwb3J0KGNvbnRhY3QsIHNlc3Npb25SZXBvcnQsIGFkZFN0cmVhbVR5cGVUb1N0YXRzKGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0cywgQVVESU9fSU5QVVQpLCBhZGRTdHJlYW1UeXBlVG9TdGF0cyhhZ2dyZWdhdGVkUmVtb3RlQXVkaW9TdGF0cywgQVVESU9fT1VUUFVUKSk7CiAgICBzZW5kU29mdHBob25lTWV0cmljcyhjb250YWN0KTsKICB9OwoKICAvKioKICAqICAgQWRkaW5nIHN0cmVhbXR5cGUgcGFyYW1ldGVyIG9uIHRvcCBvZiBSVENKUyBSVFN0YXRzIG9iamVjdC4KICAqLwogIHZhciBSVFBTdHJlYW1TdGF0cyA9IGZ1bmN0aW9uICh0aW1lc3RhbXAsIHBhY2tldHNMb3N0LCBwYWNrZXRzQ291bnQsIHN0cmVhbVR5cGUsIGF1ZGlvTGV2ZWwsIGppdHRlckJ1ZmZlck1pbGxpcywgcm91bmRUcmlwVGltZU1pbGxpcykgewogICAgdGhpcy5zb2Z0cGhvbmVTdHJlYW1UeXBlID0gc3RyZWFtVHlwZTsKICAgIHRoaXMudGltZXN0YW1wID0gdGltZXN0YW1wOwogICAgdGhpcy5wYWNrZXRzTG9zdCA9IHBhY2tldHNMb3N0OwogICAgdGhpcy5wYWNrZXRzQ291bnQgPSBwYWNrZXRzQ291bnQ7CiAgICB0aGlzLmF1ZGlvTGV2ZWwgPSBhdWRpb0xldmVsOwogICAgdGhpcy5qaXR0ZXJCdWZmZXJNaWxsaXMgPSBqaXR0ZXJCdWZmZXJNaWxsaXM7CiAgICB0aGlzLnJvdW5kVHJpcFRpbWVNaWxsaXMgPSByb3VuZFRyaXBUaW1lTWlsbGlzOwogIH07CgogIHZhciBhZGRTdHJlYW1UeXBlVG9TdGF0cyA9IGZ1bmN0aW9uIChzdGF0cywgc3RyZWFtVHlwZSkgewogICAgc3RhdHMgPSBzdGF0cyB8fCB7fTsKICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoc3RhdHMudGltZXN0YW1wLCBzdGF0cy5wYWNrZXRzTG9zdCwgc3RhdHMucGFja2V0c0NvdW50LCBzdHJlYW1UeXBlLCBzdGF0cy5hdWRpb0xldmVsKTsKICB9OwoKICB2YXIgU29mdHBob25lTG9nZ2VyID0gZnVuY3Rpb24gKGxvZ2dlcikgewogICAgdGhpcy5fb3JpZ2luYWxMb2dnZXIgPSBsb2dnZXI7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLl90ZWUgPSBmdW5jdGlvbiAobGV2ZWwsIG1ldGhvZCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGNhbGwgdGhlIG9yaWdpbmFsIGxvZ2dlciBvYmplY3QgdG8gb3V0cHV0IHRvIGJyb3dzZXIKICAgICAgICAvL0Nvbm5lY3QgbG9nZ2VyIGZvbGxvd3MgJXMgZm9ybWF0IHRvIHByaW50IG9iamVjdHMgdG8gY29uc29sZS4KICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50c1swXSk7CiAgICAgICAgdmFyIGZvcm1hdCA9ICIiOwogICAgICAgIGFyZ3MuZm9yRWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3JtYXQgPSBmb3JtYXQgKyAiICVzIjsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHNlbGYuX29yaWdpbmFsTG9nZ2VyLCBbY29ubmVjdC5Mb2dDb21wb25lbnQuU09GVFBIT05FLCBmb3JtYXRdLmNvbmNhdChhcmdzKSk7CiAgICAgIH07CiAgICB9OwogIH07CgogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDEsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmRlYnVnKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5pbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSgyLCB0aGlzLl9vcmlnaW5hbExvZ2dlci5pbmZvKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDMsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmxvZykoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUud2FybiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoNCwgdGhpcy5fb3JpZ2luYWxMb2dnZXIud2FybikoYXJndW1lbnRzKTsKICB9OwogIFNvZnRwaG9uZUxvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDUsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmVycm9yKShhcmd1bWVudHMpOwogIH07CgogIGNvbm5lY3QuU29mdHBob25lTWFuYWdlciA9IFNvZnRwaG9uZU1hbmFnZXI7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA5NDQ6Ci8qKiovICgoKSA9PiB7CgovKiEgQGxpY2Vuc2Ugc3ByaW50Zi5qcyB8IENvcHlyaWdodCAoYykgMjAwNy0yMDEzIEFsZXhhbmRydSBNYXJhc3RlYW51IDxoZWxsbyBhdCBhbGV4ZWkgZG90IHJvPiB8IDMgY2xhdXNlIEJTRCBsaWNlbnNlICovCgooZnVuY3Rpb24oKSB7CiAgIHZhciBjdHggPSB0aGlzOwoKCXZhciBzcHJpbnRmID0gZnVuY3Rpb24oKSB7CgkJaWYgKCFzcHJpbnRmLmNhY2hlLmhhc093blByb3BlcnR5KGFyZ3VtZW50c1swXSkpIHsKCQkJc3ByaW50Zi5jYWNoZVthcmd1bWVudHNbMF1dID0gc3ByaW50Zi5wYXJzZShhcmd1bWVudHNbMF0pOwoJCX0KCQlyZXR1cm4gc3ByaW50Zi5mb3JtYXQuY2FsbChudWxsLCBzcHJpbnRmLmNhY2hlW2FyZ3VtZW50c1swXV0sIGFyZ3VtZW50cyk7Cgl9OwoKCXNwcmludGYuZm9ybWF0ID0gZnVuY3Rpb24ocGFyc2VfdHJlZSwgYXJndikgewoJCXZhciBjdXJzb3IgPSAxLCB0cmVlX2xlbmd0aCA9IHBhcnNlX3RyZWUubGVuZ3RoLCBub2RlX3R5cGUgPSAnJywgYXJnLCBvdXRwdXQgPSBbXSwgaSwgaywgbWF0Y2gsIHBhZCwgcGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aDsKCQlmb3IgKGkgPSAwOyBpIDwgdHJlZV9sZW5ndGg7IGkrKykgewoJCQlub2RlX3R5cGUgPSBnZXRfdHlwZShwYXJzZV90cmVlW2ldKTsKCQkJaWYgKG5vZGVfdHlwZSA9PT0gJ3N0cmluZycpIHsKCQkJCW91dHB1dC5wdXNoKHBhcnNlX3RyZWVbaV0pOwoJCQl9CgkJCWVsc2UgaWYgKG5vZGVfdHlwZSA9PT0gJ2FycmF5JykgewoJCQkJbWF0Y2ggPSBwYXJzZV90cmVlW2ldOyAvLyBjb252ZW5pZW5jZSBwdXJwb3NlcyBvbmx5CgkJCQlpZiAobWF0Y2hbMl0pIHsgLy8ga2V5d29yZCBhcmd1bWVudAoJCQkJCWFyZyA9IGFyZ3ZbY3Vyc29yXTsKCQkJCQlmb3IgKGsgPSAwOyBrIDwgbWF0Y2hbMl0ubGVuZ3RoOyBrKyspIHsKCQkJCQkJaWYgKCFhcmcuaGFzT3duUHJvcGVydHkobWF0Y2hbMl1ba10pKSB7CgkJCQkJCQl0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gcHJvcGVydHkgIiVzIiBkb2VzIG5vdCBleGlzdCcsIG1hdGNoWzJdW2tdKSk7CgkJCQkJCX0KCQkJCQkJYXJnID0gYXJnW21hdGNoWzJdW2tdXTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChtYXRjaFsxXSkgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChleHBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W21hdGNoWzFdXTsKCQkJCX0KCQkJCWVsc2UgeyAvLyBwb3NpdGlvbmFsIGFyZ3VtZW50IChpbXBsaWNpdCkKCQkJCQlhcmcgPSBhcmd2W2N1cnNvcisrXTsKCQkJCX0KCgkJCQlpZiAoL1tec10vLnRlc3QobWF0Y2hbOF0pICYmIChnZXRfdHlwZShhcmcpICE9ICdudW1iZXInKSkgewoJCQkJCXRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBleHBlY3RpbmcgbnVtYmVyIGJ1dCBmb3VuZCAlcycsIGdldF90eXBlKGFyZykpKTsKCQkJCX0KCQkJCXN3aXRjaCAobWF0Y2hbOF0pIHsKCQkJCQljYXNlICdiJzogYXJnID0gYXJnLnRvU3RyaW5nKDIpOyBicmVhazsKCQkJCQljYXNlICdjJzogYXJnID0gU3RyaW5nLmZyb21DaGFyQ29kZShhcmcpOyBicmVhazsKCQkJCQljYXNlICdkJzogYXJnID0gcGFyc2VJbnQoYXJnLCAxMCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2UnOiBhcmcgPSBtYXRjaFs3XSA/IGFyZy50b0V4cG9uZW50aWFsKG1hdGNoWzddKSA6IGFyZy50b0V4cG9uZW50aWFsKCk7IGJyZWFrOwoJCQkJCWNhc2UgJ2YnOiBhcmcgPSBtYXRjaFs3XSA/IHBhcnNlRmxvYXQoYXJnKS50b0ZpeGVkKG1hdGNoWzddKSA6IHBhcnNlRmxvYXQoYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAnbyc6IGFyZyA9IGFyZy50b1N0cmluZyg4KTsgYnJlYWs7CgkJCQkJY2FzZSAncyc6IGFyZyA9ICgoYXJnID0gU3RyaW5nKGFyZykpICYmIG1hdGNoWzddID8gYXJnLnN1YnN0cmluZygwLCBtYXRjaFs3XSkgOiBhcmcpOyBicmVhazsKCQkJCQljYXNlICd1JzogYXJnID0gYXJnID4+PiAwOyBicmVhazsKCQkJCQljYXNlICd4JzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KTsgYnJlYWs7CgkJCQkJY2FzZSAnWCc6IGFyZyA9IGFyZy50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsgYnJlYWs7CgkJCQl9CgkJCQlhcmcgPSAoL1tkZWZdLy50ZXN0KG1hdGNoWzhdKSAmJiBtYXRjaFszXSAmJiBhcmcgPj0gMCA/ICcrJysgYXJnIDogYXJnKTsKCQkJCXBhZF9jaGFyYWN0ZXIgPSBtYXRjaFs0XSA/IG1hdGNoWzRdID09ICcwJyA/ICcwJyA6IG1hdGNoWzRdLmNoYXJBdCgxKSA6ICcgJzsKCQkJCXBhZF9sZW5ndGggPSBtYXRjaFs2XSAtIFN0cmluZyhhcmcpLmxlbmd0aDsKCQkJCXBhZCA9IG1hdGNoWzZdID8gc3RyX3JlcGVhdChwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoKSA6ICcnOwoJCQkJb3V0cHV0LnB1c2gobWF0Y2hbNV0gPyBhcmcgKyBwYWQgOiBwYWQgKyBhcmcpOwoJCQl9CgkJfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9OwoKCXNwcmludGYuY2FjaGUgPSB7fTsKCglzcHJpbnRmLnBhcnNlID0gZnVuY3Rpb24oZm10KSB7CgkJdmFyIF9mbXQgPSBmbXQsIG1hdGNoID0gW10sIHBhcnNlX3RyZWUgPSBbXSwgYXJnX25hbWVzID0gMDsKCQl3aGlsZSAoX2ZtdCkgewoJCQlpZiAoKG1hdGNoID0gL15bXlx4MjVdKy8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCXBhcnNlX3RyZWUucHVzaChtYXRjaFswXSk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1ezJ9Ly5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJcGFyc2VfdHJlZS5wdXNoKCclJyk7CgkJCX0KCQkJZWxzZSBpZiAoKG1hdGNoID0gL15ceDI1KD86KFsxLTldXGQqKVwkfFwoKFteXCldKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1mb3N1eFhdKS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCWlmIChtYXRjaFsyXSkgewoJCQkJCWFyZ19uYW1lcyB8PSAxOwoJCQkJCXZhciBmaWVsZF9saXN0ID0gW10sIHJlcGxhY2VtZW50X2ZpZWxkID0gbWF0Y2hbMl0sIGZpZWxkX21hdGNoID0gW107CgkJCQkJaWYgKChmaWVsZF9tYXRjaCA9IC9eKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJd2hpbGUgKChyZXBsYWNlbWVudF9maWVsZCA9IHJlcGxhY2VtZW50X2ZpZWxkLnN1YnN0cmluZyhmaWVsZF9tYXRjaFswXS5sZW5ndGgpKSAhPT0gJycpIHsKCQkJCQkJCWlmICgoZmllbGRfbWF0Y2ggPSAvXlwuKFthLXpfXVthLXpfXGRdKikvaS5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSBpZiAoKGZpZWxkX21hdGNoID0gL15cWyhcZCspXF0vLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCQkJfQoJCQkJCW1hdGNoWzJdID0gZmllbGRfbGlzdDsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWFyZ19uYW1lcyB8PSAyOwoJCQkJfQoJCQkJaWYgKGFyZ19uYW1lcyA9PT0gMykgewoJCQkJCXRocm93KCdbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkJyk7CgkJCQl9CgkJCQlwYXJzZV90cmVlLnB1c2gobWF0Y2gpOwoJCQl9CgkJCWVsc2UgewoJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCX0KCQkJX2ZtdCA9IF9mbXQuc3Vic3RyaW5nKG1hdGNoWzBdLmxlbmd0aCk7CgkJfQoJCXJldHVybiBwYXJzZV90cmVlOwoJfTsKCgl2YXIgdnNwcmludGYgPSBmdW5jdGlvbihmbXQsIGFyZ3YsIF9hcmd2KSB7CgkJX2FyZ3YgPSBhcmd2LnNsaWNlKDApOwoJCV9hcmd2LnNwbGljZSgwLCAwLCBmbXQpOwoJCXJldHVybiBzcHJpbnRmLmFwcGx5KG51bGwsIF9hcmd2KTsKCX07CgoJLyoqCgkgKiBoZWxwZXJzCgkgKi8KCWZ1bmN0aW9uIGdldF90eXBlKHZhcmlhYmxlKSB7CgkJcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YXJpYWJsZSkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCk7Cgl9CgoJZnVuY3Rpb24gc3RyX3JlcGVhdChpbnB1dCwgbXVsdGlwbGllcikgewoJCWZvciAodmFyIG91dHB1dCA9IFtdOyBtdWx0aXBsaWVyID4gMDsgb3V0cHV0Wy0tbXVsdGlwbGllcl0gPSBpbnB1dCkgey8qIGRvIG5vdGhpbmcgKi99CgkJcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKCX0KCgkvKioKCSAqIGV4cG9ydCB0byBlaXRoZXIgYnJvd3NlciBvciBub2RlLmpzCgkgKi8KCWN0eC5zcHJpbnRmID0gc3ByaW50ZjsKCWN0eC52c3ByaW50ZiA9IHZzcHJpbnRmOwp9KSgpOwoKCgovKioqLyB9KSwKCi8qKiovIDgyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpczsKICAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW0KICAgICoKICAgICogUmVwcmVzZW50cyBhbiBvYmplY3QgZnJvbSB3aGljaCBtZXNzYWdlcyBjYW4gYmUgcmVhZCBhbmQgdG8gd2hpY2gKICAgICogbWVzc2FnZXMgY2FuIGJlIHNlbnQuCiAgICAqLwogICB2YXIgU3RyZWFtID0gZnVuY3Rpb24oKSB7fTsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byB0aGUgc3RyZWFtLiAgVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKioKICAgICogUHJvdmlkZSBhIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiBtZXNzYWdlcyBhcmUgcmVjZWl2ZWQgZnJvbSB0aGlzIHN0cmVhbS4KICAgICogVGhpcyBtZXRob2QgbXVzdCBiZSBpbXBsZW1lbnRlZCBieSBzdWJjbGFzc2VzLgogICAgKi8KICAgU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBOdWxsU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgbnVsbCBzdHJlYW0gd2hpY2ggcHJvdmlkZXMgbm8gbWVzc2FnZSBzZW5kaW5nIG9yIHJlY2VpdmluZyBmYWNpbGl0aWVzLgogICAgKi8KICAgdmFyIE51bGxTdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgIH07CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsU3RyZWFtOwoKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikge307CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7fTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBXaW5kb3dTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gZm9yIGNvbW11bmljYXRpbmcgd2l0aCBhIHdpbmRvdyBvYmplY3QuICBUaGUgZG9tYWluIHByb3ZpZGVkCiAgICAqIG11c3QgbWF0Y2ggdGhlIGFsbG93ZWQgbWVzc2FnZSBkb21haW5zIG9mIHRoZSBkb3duc3RyZWFtIHJlY2VpdmVyCiAgICAqIG9yIG1lc3NhZ2VzIHdpbGwgYmUgcmVqZWN0ZWQsIHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvV2luZG93L3Bvc3RNZXNzYWdlCiAgICAqIGZvciBtb3JlIGluZm8uCiAgICAqLwogICB2YXIgV2luZG93U3RyZWFtID0gZnVuY3Rpb24od2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMud2luZG93ID0gd2luOwogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiB8fCAnKic7CiAgIH07CiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93U3RyZWFtOwoKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLndpbmRvdy5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLmRvbWFpbik7CiAgIH07CgogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFdpbmRvd0lPU3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIHVzZWQgYnkgSUZyYW1lL3BvcHVwIHdpbmRvd3MgdG8gY29tbXVuaWNhdGUgd2l0aCB0aGVpciBwYXJlbnRzCiAgICAqIGFuZCB2aXNlIHZlcnNhLgogICAgKgogICAgKiBUaGlzIG9iamVjdCBlbmNhcHN1bGF0ZXMgdGhlIGZhY3QgdGhhdCBpbmNvbWluZyBhbmQgb3V0Z29pbmcgbWVzc2FnZXMKICAgICogYXJyaXZlIG9uIGRpZmZlcmVudCB3aW5kb3dzIGFuZCBhbGxvd3MgdGhpcyB0byBiZSBtYW5hZ2VkIGFzIGEgc2luZ2xlCiAgICAqIFN0cmVhbSBvYmplY3QuCiAgICAqLwogICB2YXIgV2luZG93SU9TdHJlYW0gPSBmdW5jdGlvbihpbnB1dHdpbiwgb3V0cHV0d2luLCBkb21haW4pIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dHdpbjsKICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXR3aW47CiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluIHx8ICcqJzsKICAgfTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV2luZG93SU9TdHJlYW07CgogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5vdXRwdXQucG9zdE1lc3NhZ2UobWVzc2FnZSwgdGhpcy5kb21haW4pOwogICB9OwoKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgKG1lc3NhZ2UpID0+IHsKICAgICAgICAgaWYgKG1lc3NhZ2Uuc291cmNlID09PSB0aGlzLm91dHB1dCkgewogICAgICAgICAgICBmKG1lc3NhZ2UpOwogICAgICAgICB9CiAgICAgIH0pOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFBvcnRTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gd3JhcHBpbmcgYW4gSFRNTDUgV29ya2VyIHBvcnQuICBUaGlzIGNvdWxkIGJlIHRoZSBwb3J0CiAgICAqIHVzZWQgdG8gY29ubmVjdCB0byBhIFdvcmtlciBvciBvbmUgb2YgdGhlIG11bHRpdHVkZSBvZiBwb3J0cwogICAgKiBtYWRlIGF2YWlsYWJsZSB0byBhIFNoYXJlZFdvcmtlciBmb3IgY29tbXVuaWNhdGlvbiBiYWNrIHRvCiAgICAqIGl0cyBjb25uZWN0ZWQgY2xpZW50cy4KICAgICovCiAgIHZhciBQb3J0U3RyZWFtID0gZnVuY3Rpb24ocG9ydCkgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5wb3J0ID0gcG9ydDsKICAgICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgfTsKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBvcnRTdHJlYW07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UobWVzc2FnZSk7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMucG9ydC5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICBQb3J0U3RyZWFtLnByb3RvdHlwZS5nZXRJZCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5pZDsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBTdHJlYW1NdWx0aXBsZXhlciBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHdyYXBwZXIgZm9yIG11bHRpcGxleGVkIGRvd25zdHJlYW0gY29tbXVuaWNhdGlvbiB3aXRoCiAgICAqIG11bHRpcGxlIHN0cmVhbXMgYXQgb25jZS4gIE1haW5seSB1c2VmdWwgZm9yIHRoZSBTaGFyZWRXb3JrZXIgdG8KICAgICogYnJvYWRjYXN0IGV2ZW50cyB0byBtYW55IFBvcnRTdHJlYW0gb2JqZWN0cyBhdCBvbmNlLgogICAgKi8KICAgdmFyIFN0cmVhbU11bHRpcGxleGVyID0gZnVuY3Rpb24oc3RyZWFtcykgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5zdHJlYW1NYXAgPSBzdHJlYW1zID8KICAgICAgICAgY29ubmVjdC5pbmRleChzdHJlYW1zLCBmdW5jdGlvbihzKSB7IHJldHVybiBzLmdldElkKCk7IH0pIDoge307CiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycyA9IFtdOwogICB9OwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTdHJlYW1NdWx0aXBsZXhlcjsKCiAgIC8qKgogICAgKiBTZW5kIGEgbWVzc2FnZSB0byBhbGwgcG9ydHMgaW4gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMuZ2V0U3RyZWFtcygpLmZvckVhY2goZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHN0cmVhbS5zZW5kKG1lc3NhZ2UpOwoKICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBDb3VsZG4ndCBzZW5kIG1lc3NhZ2UgdG8gb25lIG9mIHRoZSBkb3duc3RyZWFtcyBmb3Igc29tZSByZWFzb24uLi4KICAgICAgICAgICAgLy8gTm8gcmVsaWFibGUgbG9nZ2luZyBwb3NzaWJsZSB3aXRob3V0IGZ1cnRoZXIgZmFpbHVyZXMsCiAgICAgICAgICAgIC8vIG5vIHJlY292ZXJ5LCBqdXN0IGVhdCBpdC4KICAgICAgICAgfQogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZWdpc3RlciBhIG1ldGhvZCB3aGljaCB3aWxsIGJlIGNhbGxlZCB3aGVuIGEgbWVzc2FnZSBpcyByZWNlaXZlZCBmcm9tCiAgICAqIGFueSBvZiB0aGUgZG93bnN0cmVhbXMuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMucHVzaChmKTsKCiAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyBzdHJlYW1zIHdpdGggdGhlIG5ldyBsaXN0ZW5lci4KICAgICAgdGhpcy5nZXRTdHJlYW1zKCkuZm9yRWFjaChmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShmKTsKICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogQWRkIGEgc3RyZWFtIHRvIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5hZGRTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB0aGlzLnN0cmVhbU1hcFtzdHJlYW0uZ2V0SWQoKV0gPSBzdHJlYW07CgogICAgICAvLyBVcGRhdGUgc3RyZWFtIHdpdGggZXhpc3RpbmcgbGlzdGVuZXJzLgogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbihtZXNzYWdlTGlzdGVuZXIpIHsKICAgICAgICAgc3RyZWFtLm9uTWVzc2FnZShtZXNzYWdlTGlzdGVuZXIpOwogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBSZW1vdmUgdGhlIGdpdmVuIGRvd25zdHJlYW0uICBUaGlzIGlzIHR5cGljYWxseSB1c2VkIGluIHJlc3BvbnNlCiAgICAqIHRvIHRoZSBTaGFyZWRXb3JrZXIncyBvbmNsb3NlIGV2ZW50LCBpbmRpY2F0aW5nIHRoYXQgYSBjb25zdW1lcgogICAgKiB0YWIgaGFzIGJlZW4gY2xvc2VkLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLnJlbW92ZVN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICBkZWxldGUgdGhpcy5zdHJlYW1NYXBbc3RyZWFtLmdldElkKCldOwogICB9OwoKICAgLyoqCiAgICAqIEdldCBhIGxpc3Qgb2Ygc3RyZWFtcyBpbiB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuZ2V0U3RyZWFtcyA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICByZXR1cm4gY29ubmVjdC52YWx1ZXModGhpcy5zdHJlYW1NYXApOwogICB9OwoKICAgLyoqCiAgICAqIEdldCB0aGUgc3RyZWFtIG1hdGNoaW5nIHRoZSBnaXZlbiBwb3J0LgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmdldFN0cmVhbUZvclBvcnQgPSBmdW5jdGlvbihwb3J0KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRTdHJlYW1zKCksIGZ1bmN0aW9uKHMpIHsKICAgICAgICAgcmV0dXJuIHMucG9ydCA9PT0gcG9ydDsKICAgICAgfSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgQ29uZHVpdAogICAgKgogICAgKiBBbiBvYmplY3Qgd2hpY2ggYnJpZGdlcyBhbiB1cHN0cmVhbSBhbmQgYSBkb3duc3RyZWFtLCBhbGxvd2luZyBtZXNzYWdlcwogICAgKiB0byBiZSBwYXNzZWQgdG8gYW5kIGZyb20gZWFjaCBhbmQgcHJvdmlkaW5nIGFuIGV2ZW50IGJ1cyBmb3IgZXZlbnQKICAgICogc3Vic2NyaXB0aW9ucyB0byBiZSBtYWRlIHVwc3RyZWFtIGFuZCBkb3duc3RyZWFtLgogICAgKi8KICAgdmFyIENvbmR1aXQgPSBmdW5jdGlvbihuYW1lLCB1cHN0cmVhbSwgZG93bnN0cmVhbSkgewogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLnVwc3RyZWFtID0gdXBzdHJlYW0gfHwgbmV3IE51bGxTdHJlYW0oKTsKICAgICAgdGhpcy5kb3duc3RyZWFtID0gZG93bnN0cmVhbSB8fCBuZXcgTnVsbFN0cmVhbSgpOwogICAgICB0aGlzLmRvd25zdHJlYW1CdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwogICAgICB0aGlzLnVwc3RyZWFtQnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKCiAgICAgIHRoaXMudXBzdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy51cHN0cmVhbUJ1cykpOwogICAgICB0aGlzLmRvd25zdHJlYW0ub25NZXNzYWdlKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5fZGlzcGF0Y2hFdmVudCwgdGhpcy5kb3duc3RyZWFtQnVzKSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vblVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy51cHN0cmVhbUJ1cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uQWxsVXBzdHJlYW0gPSBmdW5jdGlvbihmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMudXBzdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25Eb3duc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy5kb3duc3RyZWFtQnVzLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25BbGxEb3duc3RyZWFtID0gZnVuY3Rpb24oZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLmRvd25zdHJlYW1CdXMuc3Vic2NyaWJlQWxsKGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuc2VuZFVwc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgdGhpcy51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5zZW5kRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIHRoaXMuZG93bnN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5fZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uKGJ1cywgbWVzc2FnZUV2ZW50KSB7CiAgICAgIHZhciBtZXNzYWdlID0gbWVzc2FnZUV2ZW50LmRhdGE7CiAgICAgIGlmIChtZXNzYWdlLmV2ZW50KSB7CiAgICAgICAgIGJ1cy50cmlnZ2VyKG1lc3NhZ2UuZXZlbnQsIG1lc3NhZ2UuZGF0YSk7CiAgICAgIH0KICAgfTsKCiAgIC8qKgogICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBwYXNzZXMgZXZlbnRzIHVwc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vbkRvd25zdHJlYW0oIk15RXZlbnQiLCBjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NVcHN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhLCBldmVudE5hbWUpIHsKICAgICAgICAgc2VsZi51cHN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgICAgIH07CiAgIH07CgogICAvKioKICAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggcGFzc2VzIGV2ZW50cyBkb3duc3RyZWFtLgogICAgKgogICAgKiBVc2FnZToKICAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgY29uZHVpdC5wYXNzRG93bnN0cmVhbSgpKTsKICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnBhc3NEb3duc3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEsIGV2ZW50TmFtZSkgewogICAgICAgICBzZWxmLmRvd25zdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICAgICB9OwogICB9OwoKICAgLyoqCiAgICAqIFNodXRkb3duIHRoZSBjb25kdWl0J3MgZXZlbnQgYnVzc2VzIGFuZCByZW1vdmUgYWxsIHN1YnNjcmlwdGlvbnMuCiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5zaHV0ZG93biA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnVwc3RyZWFtQnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbUJ1cy51bnN1YnNjcmliZUFsbCgpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIElGcmFtZUNvbmR1aXQgZXh0ZW5kcyBDb25kdWl0CiAgICAqCiAgICAqIENyZWF0ZXMgYSBjb25kdWl0IGZvciB0aGUgZ2l2ZW4gSUZyYW1lIGVsZW1lbnQuCiAgICAqLwogICB2YXIgSUZyYW1lQ29uZHVpdCA9IGZ1bmN0aW9uKG5hbWUsIHdpbmRvdywgaWZyYW1lLCBkb21haW4pIHsKICAgICAgQ29uZHVpdC5jYWxsKHRoaXMsIG5hbWUsIG5ldyBXaW5kb3dJT1N0cmVhbSh3aW5kb3csIGlmcmFtZS5jb250ZW50V2luZG93LCBkb21haW4gfHwgJyonKSwgbnVsbCk7CiAgIH07CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25kdWl0LnByb3RvdHlwZSk7CiAgIElGcmFtZUNvbmR1aXQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gSUZyYW1lQ29uZHVpdDsKCiAgIGNvbm5lY3QuU3RyZWFtID0gU3RyZWFtOwogICBjb25uZWN0Lk51bGxTdHJlYW0gPSBOdWxsU3RyZWFtOwogICBjb25uZWN0LldpbmRvd1N0cmVhbSA9IFdpbmRvd1N0cmVhbTsKICAgY29ubmVjdC5XaW5kb3dJT1N0cmVhbSA9IFdpbmRvd0lPU3RyZWFtOwogICBjb25uZWN0LlBvcnRTdHJlYW0gPSBQb3J0U3RyZWFtOwogICBjb25uZWN0LlN0cmVhbU11bHRpcGxleGVyID0gU3RyZWFtTXVsdGlwbGV4ZXI7CiAgIGNvbm5lY3QuQ29uZHVpdCA9IENvbmR1aXQ7CiAgIGNvbm5lY3QuSUZyYW1lQ29uZHVpdCA9IElGcmFtZUNvbmR1aXQ7Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4MzM6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzOwogICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBHcmFwaExpbmsgPDxhYnN0cmFjdCBjbGFzcz4+CiAgICAqCiAgICAqIFJlcHJlc2VudHMgdGhlIGFzc29jaWF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYSBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICB0aGlzLmZyb21TdGF0ZSA9IGZyb21TdGF0ZTsKICAgICAgdGhpcy50b1N0YXRlID0gdG9TdGF0ZTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICB0aHJvdyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0RnJvbVN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmZyb21TdGF0ZTsKICAgfTsKCiAgIEdyYXBoTGluay5wcm90b3R5cGUuZ2V0VG9TdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy50b1N0YXRlOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBEaXJlY3RHcmFwaExpbmsgPDxjb25jcmV0ZSBjbGFzcz4+IGV4dGVuZHMgR3JhcGhMaW5rCiAgICAqCiAgICAqIFJlcHJlc2VudHMgdGhlIGJ5LXZhbHVlIHJlcHJlc2VudGF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYQogICAgKiBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIERpcmVjdEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSwgYXNzb2NpYXRpb25zKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChhc3NvY2lhdGlvbnMsICdhc3NvY2lhdGlvbnMnKTsKICAgICAgR3JhcGhMaW5rLmNhbGwodGhpcywgZnJvbVN0YXRlLCB0b1N0YXRlKTsKICAgICAgdGhpcy5hc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnM7CiAgIH07CiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEdyYXBoTGluay5wcm90b3R5cGUpOwogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGlyZWN0R3JhcGhMaW5rOwoKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLmFzc29jaWF0aW9uczsKICAgfTsKCiAgIC8qKgogICAgKiBGdW5jdGlvbmFsR3JhcGhMaW5rIDw8Y29uY3JldGUgY2xhc3M+PiBleHRlbmRzIEdyYXBoTGluawogICAgKgogICAgKiBSZXByZXNlbnRzIGEgZnVuY3Rpb25hbCBhc3NvY2lhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEKICAgICogc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBGdW5jdGlvbmFsR3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlLCBjbG9zdXJlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjbG9zdXJlLCAnY2xvc3VyZScpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNsb3N1cmUpLCAnY2xvc3VyZSBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgR3JhcGhMaW5rLmNhbGwodGhpcywgZnJvbVN0YXRlLCB0b1N0YXRlKTsKICAgICAgdGhpcy5jbG9zdXJlID0gY2xvc3VyZTsKICAgfTsKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKEdyYXBoTGluay5wcm90b3R5cGUpOwogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEZ1bmN0aW9uYWxHcmFwaExpbms7CgogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHJldHVybiB0aGlzLmNsb3N1cmUoY29udGV4dCwgdGhpcy5nZXRGcm9tU3RhdGUoKSwgdGhpcy5nZXRUb1N0YXRlKCkpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBFdmVudEdyYXBoIDw8Y2xhc3M+PgogICAgKgogICAgKiBCdWlsZHMgYSBtYXAgb2YgYXNzb2NpYXRpb25zIGZyb20gb25lIHN0YXRlIHRvIGFub3RoZXIgaW4gY29udGV4dCBvZiBhCiAgICAqIHBhcnRpY3VsYXIgb2JqZWN0LiAgVGhlIGFzc29jaWF0aW9ucyBjYW4gYmUgZGlyZWN0IChvbmUgb3IgbW9yZSB2YWx1ZXMpCiAgICAqIG9yIGZ1bmN0aW9uYWwgKGEgbWV0aG9kIHJldHVybmluZyBvbmUgb3IgbW9yZSB2YWx1ZXMpLCBhbmQgYXJlIHVzZWQgdG8KICAgICogcHJvdmlkZSBhZGRpdGlvbmFsIGNvbnRleHR1YWwgZXZlbnQgaG9va3MgZm9yIHRoZSBVSSB0byBjb25zdW1lLgogICAgKi8KICAgdmFyIEV2ZW50R3JhcGggPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5mcm9tTWFwID0ge307CiAgIH07CiAgIEV2ZW50R3JhcGguQU5ZID0gIjw8YW55Pj4iOwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuYXNzb2MgPSBmdW5jdGlvbihmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIGlmICghIGZyb21TdGF0ZU9iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImZyb21TdGF0ZU9iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKCEgdG9TdGF0ZU9iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRvU3RhdGVPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmICghIGFzc29jT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXNzb2NPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmIChmcm9tU3RhdGVPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICBmcm9tU3RhdGVPYmouZm9yRWFjaChmdW5jdGlvbihmcm9tU3RhdGUpIHsKICAgICAgICAgICAgc2VsZi5hc3NvYyhmcm9tU3RhdGUsIHRvU3RhdGVPYmosIGFzc29jT2JqKTsKICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAodG9TdGF0ZU9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgIHRvU3RhdGVPYmouZm9yRWFjaChmdW5jdGlvbih0b1N0YXRlKSB7CiAgICAgICAgICAgIHNlbGYuYXNzb2MoZnJvbVN0YXRlT2JqLCB0b1N0YXRlLCBhc3NvY09iaik7CiAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgICBpZiAodHlwZW9mIGFzc29jT2JqID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBGdW5jdGlvbmFsR3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopKTsKICAgICAgICAgfSBlbHNlIGlmIChhc3NvY09iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBEaXJlY3RHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikpOwogICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRGlyZWN0R3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgW2Fzc29jT2JqXSkpOwogICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgdmFyIGFzc29jaWF0aW9ucyA9IFtdOwoKICAgICAgdmFyIHRvTWFwRnJvbUFueSA9IHRoaXMuZnJvbU1hcFtFdmVudEdyYXBoLkFOWV0gfHwge307CiAgICAgIHZhciB0b01hcCA9IHRoaXMuZnJvbU1hcFtmcm9tU3RhdGVdIHx8IHt9OwoKICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCh0aGlzLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwKAogICAgICAgICAgICAgICB0b01hcEZyb21BbnksIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkpOwogICAgICBhc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnMuY29uY2F0KHRoaXMuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAoCiAgICAgICAgICAgICAgIHRvTWFwLCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpKTsKCiAgICAgIHJldHVybiBhc3NvY2lhdGlvbnM7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5fYWRkQXNzb2NpYXRpb24gPSBmdW5jdGlvbihhc3NvYykgewogICAgICB2YXIgdG9NYXAgPSB0aGlzLmZyb21NYXBbYXNzb2MuZ2V0RnJvbVN0YXRlKCldOwoKICAgICAgaWYgKCEgdG9NYXApIHsKICAgICAgICAgdG9NYXAgPSB0aGlzLmZyb21NYXBbYXNzb2MuZ2V0RnJvbVN0YXRlKCldID0ge307CiAgICAgIH0KCiAgICAgIHZhciBhc3NvY0xpc3QgPSB0b01hcFthc3NvYy5nZXRUb1N0YXRlKCldOwoKICAgICAgaWYgKCEgYXNzb2NMaXN0KSB7CiAgICAgICAgIGFzc29jTGlzdCA9IHRvTWFwW2Fzc29jLmdldFRvU3RhdGUoKV0gPSBbXTsKICAgICAgfQoKICAgICAgYXNzb2NMaXN0LnB1c2goYXNzb2MpOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAgPSBmdW5jdGlvbihtYXAsIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICB2YXIgYXNzb2NMaXN0ID0gKG1hcFtFdmVudEdyYXBoLkFOWV0gfHwgW10pLmNvbmNhdChtYXBbdG9TdGF0ZV0gfHwgW10pOwogICAgICByZXR1cm4gYXNzb2NMaXN0LnJlZHVjZShmdW5jdGlvbihwcmV2LCBhc3NvYykgewogICAgICAgICByZXR1cm4gcHJldi5jb25jYXQoYXNzb2MuZ2V0QXNzb2NpYXRpb25zKGNvbnRleHQpKTsKICAgICAgfSwgW10pOwogICB9OwoKICAgY29ubmVjdC5FdmVudEdyYXBoID0gRXZlbnRHcmFwaDsKCn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA4OTE6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICB2YXIgdXNlckFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICB2YXIgT05FX0RBWV9NSUxMSVMgPSAyNCAqIDYwICogNjAgKiAxMDAwOwogIHZhciBERUZBVUxUX1BPUFVQX0hFSUdIVCA9IDU3ODsKICB2YXIgREVGQVVMVF9QT1BVUF9XSURUSCA9IDQzMzsKICB2YXIgQ09QWUFCTEVfRVZFTlRfRklFTERTID0gWyJidWJibGVzIiwgImNhbmNlbEJ1YmJsZSIsICJjYW5jZWxhYmxlIiwgImNvbXBvc2VkIiwgImRhdGEiLCAiZGVmYXVsdFByZXZlbnRlZCIsICJldmVudFBoYXNlIiwgImlzVHJ1c3RlZCIsICJsYXN0RXZlbnRJZCIsICJvcmlnaW4iLCAicmV0dXJuVmFsdWUiLCAidGltZVN0YW1wIiwgInR5cGUiXTsKCiAgLyoqCiAgICogVW5wb2xsdXRlIHNwcmludGYgZnVuY3Rpb25zIGZyb20gdGhlIGdsb2JhbCBuYW1lc3BhY2UuCiAgICovCiAgY29ubmVjdC5zcHJpbnRmID0gZ2xvYmFsLnNwcmludGY7CiAgY29ubmVjdC52c3ByaW50ZiA9IGdsb2JhbC52c3ByaW50ZjsKICBkZWxldGUgZ2xvYmFsLnNwcmludGY7CiAgZGVsZXRlIGdsb2JhbC52c3ByaW50ZjsKCiAgY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUyA9IHsKICAgIFNVQ0NFU1M6IDIwMCwKICAgIFRPT19NQU5ZX1JFUVVFU1RTOiA0MjksCiAgICBJTlRFUk5BTF9TRVJWRVJfRVJST1I6IDUwMAogIH07CgogIGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTID0gewogICAgQ0hBVF9UT0tFTjogImNoYXRfdG9rZW4iLAogICAgV0VCX1NPQ0tFVDogIndlYl9zb2NrZXQiCiAgfTsKCiAgLyoqCiAgICogQmluZHMgdGhlIGdpdmVuIGluc3RhbmNlIG9iamVjdCBhcyB0aGUgY29udGV4dCBmb3IKICAgKiB0aGUgbWV0aG9kIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIHNjb3BlIFRoZSBpbnN0YW5jZSBvYmplY3QgdG8gYmUgc2V0IGFzIHRoZSBzY29wZQogICAqICAgIG9mIHRoZSBmdW5jdGlvbi4KICAgKiBAcGFyYW0gbWV0aG9kIFRoZSBtZXRob2QgdG8gYmUgZW5jYXBzdWxhdGVkLgogICAqCiAgICogQWxsIG90aGVyIGFyZ3VtZW50cywgaWYgYW55LCBhcmUgYm91bmQgdG8gdGhlIG1ldGhvZAogICAqIGludm9jYXRpb24gaW5zaWRlIHRoZSBjbG9zdXJlLgogICAqCiAgICogQHJldHVybiBBIGNsb3N1cmUgZW5jYXBzdWxhdGluZyB0aGUgaW52b2NhdGlvbiBvZiB0aGUKICAgKiAgICBtZXRob2QgcHJvdmlkZWQgaW4gY29udGV4dCBvZiB0aGUgZ2l2ZW4gaW5zdGFuY2UuCiAgICovCiAgY29ubmVjdC5oaXRjaCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIHZhciBzY29wZSA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBtZXRob2QgPSBhcmdzLnNoaWZ0KCk7CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHNjb3BlLCAnc2NvcGUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24obWV0aG9kKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY2xvc3VyZUFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICByZXR1cm4gbWV0aG9kLmFwcGx5KHNjb3BlLCBhcmdzLmNvbmNhdChjbG9zdXJlQXJncykpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGEgY2FsbGFibGUgZnVuY3Rpb24gdHlwZS4KICAgKiBCb3Jyb3dlZCBmcm9tIFVuZGVyc2NvcmUuanMuCiAgICovCiAgY29ubmVjdC5pc0Z1bmN0aW9uID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuICEhKG9iaiAmJiBvYmouY29uc3RydWN0b3IgJiYgb2JqLmNhbGwgJiYgb2JqLmFwcGx5KTsKICB9OwoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGFuIGFycmF5LgogICAqLwogIGNvbm5lY3QuaXNBcnJheSA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGtleXMgZnJvbSBhIEphdmFzY3JpcHQgb2JqZWN0IHVzZWQKICAgKiBhcyBhIGhhc2ggbWFwLgogICAqLwogIGNvbm5lY3Qua2V5cyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciBrZXlzID0gW107CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1hcCwgJ21hcCcpOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIGtleXMucHVzaChrKTsKICAgIH0KCiAgICByZXR1cm4ga2V5czsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHZhbHVlcyBmcm9tIGEgSmF2YXNjcmlwdCBvYmplY3QgdXNlZAogICAqIGFzIGEgaGFzaCBtYXAuCiAgICovCiAgY29ubmVjdC52YWx1ZXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIgdmFsdWVzID0gW107CgogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1hcCwgJ21hcCcpOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIHZhbHVlcy5wdXNoKG1hcFtrXSk7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGtleS92YWx1ZSBwYWlycyBmcm9tIHRoZSBnaXZlbiBtYXAuCiAgICovCiAgY29ubmVjdC5lbnRyaWVzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIGVudHJpZXMgPSBbXTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICBlbnRyaWVzLnB1c2goeyBrZXk6IGssIHZhbHVlOiBtYXBba10gfSk7CiAgICB9CgogICAgcmV0dXJuIGVudHJpZXM7CiAgfTsKCiAgLyoqCiAgICogTWVyZ2UgdHdvIG9yIG1vcmUgbWFwcyB0b2dldGhlciBpbnRvIGEgbmV3IG1hcCwKICAgKiBvciBzaW1wbHkgY29weSBhIHNpbmdsZSBtYXAuCiAgICovCiAgY29ubmVjdC5tZXJnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdNYXBzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciByZXN1bHRNYXAgPSB7fTsKCiAgICBhcmdNYXBzLmZvckVhY2goZnVuY3Rpb24gKG1hcCkgewogICAgICBjb25uZWN0LmVudHJpZXMobWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChrdikgewogICAgICAgIHJlc3VsdE1hcFtrdi5rZXldID0ga3YudmFsdWU7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHJlc3VsdE1hcDsKICB9OwoKICBjb25uZWN0Lm5vdyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICB9OwoKICBjb25uZWN0LmZpbmQgPSBmdW5jdGlvbiAoYXJyYXksIHByZWRpY2F0ZSkgewogICAgZm9yICh2YXIgeCA9IDA7IHggPCBhcnJheS5sZW5ndGg7IHgrKykgewogICAgICBpZiAocHJlZGljYXRlKGFycmF5W3hdKSkgewogICAgICAgIHJldHVybiBhcnJheVt4XTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBudWxsOwogIH07CgogIGNvbm5lY3QuY29udGFpbnMgPSBmdW5jdGlvbiAob2JqLCB2YWx1ZSkgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQob2JqLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICh2YWx1ZSBpbiBvYmopOwogICAgfQogIH07CgogIGNvbm5lY3QuY29udGFpbnNWYWx1ZSA9IGZ1bmN0aW9uIChvYmosIHZhbHVlKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChvYmosIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKGNvbm5lY3QudmFsdWVzKG9iaiksIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZW5lcmF0ZSBhIHJhbmRvbSBJRCBjb25zaXN0aW5nIG9mIHRoZSBjdXJyZW50IHRpbWVzdGFtcAogICAqIGFuZCBhIHJhbmRvbSBiYXNlLTM2IG51bWJlciBiYXNlZCBvbiBNYXRoLnJhbmRvbSgpLgogICAqLwogIGNvbm5lY3QucmFuZG9tSWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy0lcyIsIGNvbm5lY3Qubm93KCksIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpKTsKICB9OwoKICAvKioKICAgKiBHZW5lcmF0ZSBhbiBlbnVtIGZyb20gdGhlIGdpdmVuIGxpc3Qgb2YgbG93ZXItY2FzZSBlbnVtIHZhbHVlcywKICAgKiB3aGVyZSB0aGUgZW51bSBrZXlzIHdpbGwgYmUgdXBwZXIgY2FzZS4KICAgKgogICAqIENvbnZlcnNpb24gZnJvbSBwYXNjYWwgY2FzZSBiYXNlZCBvbiBjb2RlIGZyb20gaGVyZToKICAgKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMwNTIxMjI0CiAgICovCiAgY29ubmVjdC5tYWtlRW51bSA9IGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgIHZhciBlbnVtT2JqID0ge307CgogICAgdmFsdWVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBrZXkgPSB2YWx1ZS5yZXBsYWNlKC9cLj8oW2Etel0rKV8/L2csIGZ1bmN0aW9uICh4LCB5KSB7IHJldHVybiB5LnRvVXBwZXJDYXNlKCkgKyAiXyI7IH0pCiAgICAgICAgLnJlcGxhY2UoL18kLywgIiIpOwoKICAgICAgZW51bU9ialtrZXldID0gdmFsdWU7CiAgICB9KTsKCiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSA9IGZ1bmN0aW9uIChwcmVmaXgsIHZhbHVlcykgewogICAgdmFyIGVudW1PYmogPSBjb25uZWN0Lm1ha2VFbnVtKHZhbHVlcyk7CiAgICBjb25uZWN0LmtleXMoZW51bU9iaikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGVudW1PYmpba2V5XSA9IGNvbm5lY3Quc3ByaW50ZigiJXM6OiVzIiwgcHJlZml4LCBlbnVtT2JqW2tleV0pOwogICAgfSk7CiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICBjb25uZWN0Lm1ha2VHZW5lcmljTmFtZXNwYWNlZEVudW0gPSBmdW5jdGlvbiAocHJlZml4LCB2YWx1ZXMsIGRlbGltaXRlcikgewogICAgdmFyIGVudW1PYmogPSBjb25uZWN0Lm1ha2VFbnVtKHZhbHVlcyk7CiAgICBjb25uZWN0LmtleXMoZW51bU9iaikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGVudW1PYmpba2V5XSA9IGNvbm5lY3Quc3ByaW50ZigiJXMiK2RlbGltaXRlcisiJXMiLCBwcmVmaXgsIGVudW1PYmpba2V5XSk7CiAgICB9KTsKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIC8qKgogICogTWV0aG9kcyB0byBkZXRlcm1pbmUgYnJvd3NlciB0eXBlIGFuZCB2ZXJzaW9ucywgdXNlZCBmb3Igc29mdHBob25lIGluaXRpYWxpemF0aW9uLgogICovCiAgY29ubmVjdC5pc0Nocm9tZUJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5pc09wZXJhQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjaHJvbWVWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgKyA3KTsKICAgIGlmIChjaHJvbWVWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KGNocm9tZVZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuZ2V0RmlyZWZveEJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGZpcmVmb3hWZXJzaW9uID0gdXNlckFnZW50LnN1YnN0cmluZyh1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICsgOCk7CiAgICBpZiAoZmlyZWZveFZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoZmlyZWZveFZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIGNvbm5lY3QuaXNWYWxpZExvY2FsZSA9IGZ1bmN0aW9uIChsb2NhbGUpIHsKICAgIHZhciBsYW5ndWFnZXMgPSBbCiAgICAgIHsKICAgICAgICBpZDogJ2VuX1VTJywKICAgICAgICBsYWJlbDogJ0VuZ2xpc2gnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2RlX0RFJywKICAgICAgICBsYWJlbDogJ0RldXRzY2gnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2VzX0VTJywKICAgICAgICBsYWJlbDogJ0VzcGHDsW9sJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdmcl9GUicsCiAgICAgICAgbGFiZWw6ICdGcmFuw6dhaXMnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2phX0pQJywKICAgICAgICBsYWJlbDogJ+aXpeacrOiqnicKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnaXRfSVQnLAogICAgICAgIGxhYmVsOiAnSXRhbGlhbm8nCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2tvX0tSJywKICAgICAgICBsYWJlbDogJ+2VnOq1reyWtCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAncHRfQlInLAogICAgICAgIGxhYmVsOiAnUG9ydHVndcOqcycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnemhfQ04nLAogICAgICAgIGxhYmVsOiAn5Lit5paHKOeugOS9kyknCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ3poX1RXJywKICAgICAgICBsYWJlbDogJ+S4reaWhyjnuYHpq5QpJwogICAgICB9CiAgICBdOwogICAgcmV0dXJuIGxhbmd1YWdlcy5tYXAoZnVuY3Rpb24obGFuZ3VhZ2UpeyByZXR1cm4gbGFuZ3VhZ2UuaWR9KS5pbmNsdWRlcyhsb2NhbGUpOwogIH0KCiAgY29ubmVjdC5nZXRPcGVyYUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZlcnNpb25PZmZzZXQgPSB1c2VyQWdlbnQuaW5kZXhPZigiT3BlcmEiKTsKICAgIHZhciBvcGVyYVZlcnNpb24gPSAodXNlckFnZW50LmluZGV4T2YoIlZlcnNpb24iKSAhPT0gLTEpID8gdXNlckFnZW50LnN1YnN0cmluZyh2ZXJzaW9uT2Zmc2V0ICsgOCkgOiB1c2VyQWdlbnQuc3Vic3RyaW5nKHZlcnNpb25PZmZzZXQgKyA2KTsKICAgIGlmIChvcGVyYVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQob3BlcmFWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICAvKioKICAgKiBSZXR1cm4gYSBtYXAgb2YgaXRlbXMgaW4gdGhlIGdpdmVuIGxpc3QgaW5kZXhlZCBieQogICAqIGtleXMgZGV0ZXJtaW5lZCBieSB0aGUgY2xvc3VyZSBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSBpdGVyYWJsZSBBIGxpc3QtbGlrZSBvYmplY3QuCiAgICogQHBhcmFtIGNsb3N1cmUgQSBjbG9zdXJlIHRvIGRldGVybWluZSB0aGUgaW5kZXggZm9yIHRoZQogICAqICAgIGl0ZW1zIGluIHRoZSBpdGVyYWJsZS4KICAgKiBAcmV0dXJuIEEgbWFwIGZyb20gaW5kZXggdG8gaXRlbSBmb3IgZWFjaCBpdGVtIGluIHRoZSBpdGVyYWJsZS4KICAgKi8KICBjb25uZWN0LmluZGV4ID0gZnVuY3Rpb24gKGl0ZXJhYmxlLCBjbG9zdXJlKSB7CiAgICB2YXIgbWFwID0ge307CgogICAgaXRlcmFibGUuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICBtYXBbY2xvc3VyZShpdGVtKV0gPSBpdGVtOwogICAgfSk7CgogICAgcmV0dXJuIG1hcDsKICB9OwoKICAvKioKICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gYXJyYXkgaW50byBhIG1hcCBhcyBhIHNldCwKICAgKiB3aGVyZSBlbGVtZW50cyBpbiB0aGUgYXJyYXkgYXJlIG1hcHBlZCB0byAxLgogICAqLwogIGNvbm5lY3Quc2V0ID0gZnVuY3Rpb24gKGFycmF5SW4pIHsKICAgIHZhciBzZXRNYXAgPSB7fTsKCiAgICBhcnJheUluLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBzZXRNYXBba2V5XSA9IDE7CiAgICB9KTsKCiAgICByZXR1cm4gc2V0TWFwOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBtYXAgZm9yIGVhY2gga2V5IGluIG1hcEIgd2hpY2gKICAgKiBpcyBOT1QgaW4gbWFwQS4KICAgKi8KICBjb25uZWN0LnJlbGF0aXZlQ29tcGxlbWVudCA9IGZ1bmN0aW9uIChtYXBBLCBtYXBCKSB7CiAgICB2YXIgY29tcE1hcCA9IHt9OwoKICAgIGNvbm5lY3Qua2V5cyhtYXBCKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgaWYgKCEoa2V5IGluIG1hcEEpKSB7CiAgICAgICAgY29tcE1hcFtrZXldID0gbWFwQltrZXldOwogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gY29tcE1hcDsKICB9OwoKICAvKioKICAgKiBBc3NlcnRzIHRoYXQgYSBwcmVtaXNlIGlzIHRydWUuCiAgICovCiAgY29ubmVjdC5hc3NlcnRUcnVlID0gZnVuY3Rpb24gKHByZW1pc2UsIG1lc3NhZ2UpIHsKICAgIGlmICghcHJlbWlzZSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5WYWx1ZUVycm9yKG1lc3NhZ2UpOwogICAgfQogIH07CgogIC8qKgogICAqIEFzc2VydHMgdGhhdCBhIHZhbHVlIGlzIG5vdCBudWxsIG9yIHVuZGVmaW5lZC4KICAgKi8KICBjb25uZWN0LmFzc2VydE5vdE51bGwgPSBmdW5jdGlvbiAodmFsdWUsIG5hbWUpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZSh2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSAhPT0gdW5kZWZpbmVkLAogICAgICBjb25uZWN0LnNwcmludGYoIiVzIG11c3QgYmUgcHJvdmlkZWQiLCBuYW1lIHx8ICdBIHZhbHVlJykpOwogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIGNvbm5lY3QuZGVlcGNvcHkgPSBmdW5jdGlvbiAoc3JjKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShzcmMpKTsKICB9OwoKICBjb25uZWN0LmRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICBjb25zdCBvYmogPSB7fTsKICAgIGNvbnN0IGxpc3RPZkFjY2VwdGFibGVLZXlzID0gQ09QWUFCTEVfRVZFTlRfRklFTERTOwogICAgbGlzdE9mQWNjZXB0YWJsZUtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgb2JqW2tleV0gPSBldmVudFtrZXldOwogICAgICB9CiAgICAgIGNhdGNoKGUpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlZXBjb3B5Q3Jvc3NPcmlnaW5FdmVudCBmYWlsZWQgb24ga2V5OiAiLCBrZXkpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNvbm5lY3QuZGVlcGNvcHkob2JqKTsKICB9CgogIC8qKgogICAqIEdldCB0aGUgY3VycmVudCBiYXNlIHVybCBvZiB0aGUgb3BlbiBwYWdlLCBlLmcuIGlmIHRoZSBwYWdlIGlzCiAgICogaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0L29yYW5nZXMsIHRoaXMgd2lsbCBiZSAiaHR0cHM6Ly9leGFtcGxlLmNvbTo5NDk0Ii4KICAgKi8KICBjb25uZWN0LmdldEJhc2VVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9jYXRpb24gPSBnbG9iYWwubG9jYXRpb247CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXM6JXMiLCBsb2NhdGlvbi5wcm90b2NvbCwgbG9jYXRpb24uaG9zdG5hbWUsIGxvY2F0aW9uLnBvcnQpOwogIH07CgogIGNvbm5lY3QuZ2V0VXJsV2l0aFByb3RvY29sID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgcHJvdG9jb2wgPSBnbG9iYWwubG9jYXRpb24ucHJvdG9jb2w7CiAgICBpZiAodXJsLnN1YnN0cigwLCBwcm90b2NvbC5sZW5ndGgpICE9PSBwcm90b2NvbCkgewogICAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCIlcy8vJXMiLCBwcm90b2NvbCwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfQoKICAvKioKICAgKiBEZXRlcm1pbmUgaWYgdGhlIGN1cnJlbnQgd2luZG93IGlzIGluIGFuIGlmcmFtZS4KICAgKiBDb3VydGVzeTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMjYwNjkvCiAgICovCiAgY29ubmVjdC5pc0ZyYW1lZCA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiB3aW5kb3cuc2VsZiAhPT0gd2luZG93LnRvcDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPiAxOwogIH0KCiAgY29ubmVjdC5mZXRjaCA9IGZ1bmN0aW9uIChlbmRwb2ludCwgb3B0aW9ucywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnkpIHsKICAgIG1heFJldHJ5ID0gbWF4UmV0cnkgfHwgNTsKICAgIG1pbGxpSW50ZXJ2YWwgPSBtaWxsaUludGVydmFsIHx8IDEwMDA7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGZldGNoRGF0YShtYXhSZXRyeSkgewogICAgICAgIGZldGNoKGVuZHBvaW50LCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgIGlmIChyZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlNVQ0NFU1MpIHsKICAgICAgICAgICAgcmVzLmpzb24oKS50aGVuKGpzb24gPT4gcmVzb2x2ZShqc29uKSkuY2F0Y2goKCkgPT4gcmVzb2x2ZSh7fSkpOwogICAgICAgICAgfSBlbHNlIGlmIChtYXhSZXRyeSAhPT0gMSAmJiAocmVzLnN0YXR1cyA+PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLklOVEVSTkFMX1NFUlZFUl9FUlJPUiB8fCByZXMuc3RhdHVzID09PSBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTLlRPT19NQU5ZX1JFUVVFU1RTKSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBmZXRjaERhdGEoLS1tYXhSZXRyeSk7CiAgICAgICAgICAgIH0sIG1pbGxpSW50ZXJ2YWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVqZWN0KHJlcyk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBmZXRjaERhdGEobWF4UmV0cnkpOwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQ2FsbGluZyBhIGZ1bmN0aW9uIHdpdGggZXhwb25lbnRpYWwgYmFja29mZiB3aXRoIGZ1bGwgaml0dGVyIHJldHJ5IHN0cmF0ZWd5CiAgICogSXQgd2lsbCByZXRyeSBjYWxsaW5nIHRoZSBmdW5jdGlvbiBmb3IgbWF4aW11bSBtYXhSZXRyeSB0aW1lcyBpZiBpdCBmYWlscy4KICAgKiBTdWNjZXNzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBmdW5jdGlvbiBzdWNjZWVkZWQuCiAgICogRmFpbHVyZSBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBvbmx5IGlmIHRoZSBsYXN0IHRyeSBmYWlsZWQuCiAgICovCiAgY29ubmVjdC5iYWNrb2ZmID0gZnVuY3Rpb24gKGZ1bmMsIG1pbGxpSW50ZXJ2YWwsIG1heFJldHJ5LCBjYWxsYmFja3MpIHsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZnVuYyksICJmdW5jIG11c3QgYmUgYSBGdW5jdGlvbiIpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJhdGlvID0gMjsKCiAgICBmdW5jKHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAobWF4UmV0cnkgPiAwKSB7CiAgICAgICAgICB2YXIgaW50ZXJ2YWwgPSBtaWxsaUludGVydmFsICogMiAqIE1hdGgucmFuZG9tKCk7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuYmFja29mZihmdW5jLCBpbnRlcnZhbCAqIHJhdGlvLCAtLW1heFJldHJ5LCBjYWxsYmFja3MpOwogICAgICAgICAgfSwgaW50ZXJ2YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVyciwgZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMgPSBmdW5jdGlvbiAobWV0cmljRGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX01FVFJJQywKICAgICAgZGF0YTogbWV0cmljRGF0YQogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lU3RhdHMgPSBmdW5jdGlvbihzdGF0cykgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuU09GVFBIT05FX1NUQVRTLAogICAgICBkYXRhOiBzdGF0cwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5TT0ZUUEhPTkVfUkVQT1JULAogICAgICBkYXRhOiByZXBvcnQKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuQ0xJQ0tfU1RSRUFNX0RBVEEsCiAgICAgIGRhdGE6IHJlcG9ydAogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoQ2xpZW50U2lkZUxvZ3MgPSBmdW5jdGlvbihsb2dzKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5DTElFTlRfU0lERV9MT0dTLCBsb2dzKTsKICB9OwoKICBjb25uZWN0LmFkZE5hbWVzcGFjZVRvTG9ncyA9IGZ1bmN0aW9uKG5hbWVzcGFjZSkgewogICAgY29uc3QgbWV0aG9kcyA9IFsnbG9nJywgJ2Vycm9yJywgJ3dhcm4nLCAnaW5mbycsICdkZWJ1ZyddOwoKICAgIG1ldGhvZHMuZm9yRWFjaCgobWV0aG9kKSA9PiB7CiAgICAgIGNvbnN0IGNvbnNvbGVNZXRob2QgPSB3aW5kb3cuY29uc29sZVttZXRob2RdOwogICAgICB3aW5kb3cuY29uc29sZVttZXRob2RdID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNvbnN0IGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3VtZW50cyk7CiAgICAgICAgYXJncy51bnNoaWZ0KGBbJHtuYW1lc3BhY2V9XWApOwogICAgICAgIGNvbnNvbGVNZXRob2QuYXBwbHkod2luZG93LmNvbnNvbGUsIGFyZ3MpOwogICAgICB9OwogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogQSB3cmFwcGVyIGFyb3VuZCBXaW5kb3cub3BlbigpIGZvciBtYW5hZ2luZyBzaW5nbGUgaW5zdGFuY2UgcG9wdXBzLgogICAqLwogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgeyB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUub3BlbiA9IGZ1bmN0aW9uICh1cmwsIG5hbWUsIG9wdGlvbnMpIHsKICAgIHZhciB0aGVuID0gdGhpcy5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lKTsKICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciB3aW4gPSBudWxsOwogICAgaWYgKG5vdyAtIHRoZW4gPiBPTkVfREFZX01JTExJUykgewogICAgICBpZiAob3B0aW9ucykgewogICAgICAgIC8vIGRlZmF1bHQgdmFsdWVzIGFyZSBjaG9zZW4gdG8gcHJvdmlkZSBhIG1pbmltdW0gaGVpZ2h0IHdpdGhvdXQgc2Nyb2xsaW5nCiAgICAgICAgLy8gYW5kIGEgdW5pZm9ybSBtYXJnaW4gYmFzZWQgb24gdGhlIGNzcyBvZiB0aGUgY2NwIGxvZ2luIHBhZ2UKICAgICAgICB2YXIgaGVpZ2h0ID0gb3B0aW9ucy5oZWlnaHQgfHwgREVGQVVMVF9QT1BVUF9IRUlHSFQ7CiAgICAgICAgdmFyIHdpZHRoID0gb3B0aW9ucy53aWR0aCB8fCBERUZBVUxUX1BPUFVQX1dJRFRIOwogICAgICAgIHZhciB0b3AgPSBvcHRpb25zLnRvcCB8fCAwOwogICAgICAgIHZhciBsZWZ0ID0gb3B0aW9ucy5sZWZ0IHx8IDA7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUsICJ3aWR0aD0iK3dpZHRoKyIsIGhlaWdodD0iK2hlaWdodCsiLCB0b3A9Iit0b3ArIiwgbGVmdD0iK2xlZnQpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lLCAid2lkdGg9Iit3aWR0aCsiLCBoZWlnaHQ9IitoZWlnaHQrIiwgdG9wPSIrdG9wKyIsIGxlZnQ9IitsZWZ0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luID0gd2luZG93Lm9wZW4oJycsIG5hbWUpOwogICAgICAgIGlmICh3aW4ubG9jYXRpb24gIT09IHVybCkgewogICAgICAgICAgd2luID0gd2luZG93Lm9wZW4odXJsLCBuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcChuYW1lLCBub3cpOwogICAgfQogICAgcmV0dXJuIHdpbjsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgdmFyIHZhbHVlID0gZ2xvYmFsLmxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7CgogICAgaWYgKHZhbHVlKSB7CiAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAwOwogICAgfQogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fc2V0TGFzdE9wZW5lZFRpbWVzdGFtcCA9IGZ1bmN0aW9uIChuYW1lLCB0cykgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIGdsb2JhbC5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksICcnICsgdHMpOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5fZ2V0TG9jYWxTdG9yYWdlS2V5ID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHJldHVybiAiY29ubmVjdFBvcHVwTWFuYWdlcjo6IiArIG5hbWU7CiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgdGhlIEhUTUw1IG5vdGlmaWNhdGlvbiBwZXJtaXNzaW9uIHZhbHVlcy4KICAgKi8KICB2YXIgTm90aWZpY2F0aW9uUGVybWlzc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2dyYW50ZWQnLAogICAgJ2RlbmllZCcsCiAgICAnZGVmYXVsdCcKICBdKTsKCiAgLyoqCiAgICogQSBzaW1wbGUgZW5naW5lIGZvciBzaG93aW5nIG5vdGlmaWNhdGlvbiBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERUZBVUxUOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUucmVxdWVzdFBlcm1pc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoISgiTm90aWZpY2F0aW9uIiBpbiBnbG9iYWwpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhpcyBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBub3RpZmljYXRpb25zLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEOwoKICAgIH0gZWxzZSBpZiAoZ2xvYmFsLk5vdGlmaWNhdGlvbi5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRCkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgdG8gbm90IHJlY2VpdmUgbm90aWZpY2F0aW9ucy4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiAhPT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIGdsb2JhbC5Ob3RpZmljYXRpb24ucmVxdWVzdFBlcm1pc3Npb24oKS50aGVuKGZ1bmN0aW9uIChwZXJtaXNzaW9uKSB7CiAgICAgICAgc2VsZi5wZXJtaXNzaW9uID0gcGVybWlzc2lvbjsKICAgICAgICBpZiAocGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgICAgICBzZWxmLl9zaG93UXVldWVkKCk7CgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnF1ZXVlID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnNob3cgPSBmdW5jdGlvbiAodGl0bGUsIG9wdGlvbnMpIHsKICAgIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICByZXR1cm4gdGhpcy5fc2hvd0ltcGwoeyB0aXRsZTogdGl0bGUsIG9wdGlvbnM6IG9wdGlvbnMgfSk7CgogICAgfSBlbHNlIGlmICh0aGlzLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVW5hYmxlIHRvIHNob3cgbm90aWZpY2F0aW9uLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICB0aXRsZTogdGl0bGUsCiAgICAgICAgICBvcHRpb25zOiBvcHRpb25zCiAgICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgdmFyIHBhcmFtcyA9IHsgdGl0bGU6IHRpdGxlLCBvcHRpb25zOiBvcHRpb25zIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiRGVmZXJyaW5nIG5vdGlmaWNhdGlvbiB1bnRpbCB1c2VyIGRlY2lkZXMgdG8gYWxsb3cgb3IgZGVueS4iKQogICAgICAgIC53aXRoT2JqZWN0KHBhcmFtcykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5xdWV1ZS5wdXNoKHBhcmFtcyk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd1F1ZXVlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBub3RpZmljYXRpb25zID0gdGhpcy5xdWV1ZS5tYXAoZnVuY3Rpb24gKHBhcmFtcykgewogICAgICByZXR1cm4gc2VsZi5fc2hvd0ltcGwocGFyYW1zKTsKICAgIH0pOwogICAgdGhpcy5xdWV1ZSA9IFtdOwogICAgcmV0dXJuIG5vdGlmaWNhdGlvbnM7CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5fc2hvd0ltcGwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgbm90aWZpY2F0aW9uID0gbmV3IGdsb2JhbC5Ob3RpZmljYXRpb24ocGFyYW1zLnRpdGxlLCBwYXJhbXMub3B0aW9ucyk7CiAgICBpZiAocGFyYW1zLm9wdGlvbnMuY2xpY2tlZCkgewogICAgICBub3RpZmljYXRpb24ub25jbGljayA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBwYXJhbXMub3B0aW9ucy5jbGlja2VkLmNhbGwobm90aWZpY2F0aW9uKTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBub3RpZmljYXRpb247CiAgfTsKCiAgY29ubmVjdC5WYWx1ZUVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBpbnN0YW5jZSA9IG5ldyBFcnJvcihjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlKTsKICAgIHJldHVybiBpbnN0YW5jZTsgCiAgfTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZSwgRXJyb3IucHJvdG90eXBlKTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5WYWx1ZUVycm9yLCBFcnJvcik7CiAgY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZS5uYW1lID0gJ1ZhbHVlRXJyb3InOwoKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGluc3RhbmNlID0gbmV3IEVycm9yKGNvbm5lY3QudnNwcmludGYoZm9ybWF0LCBhcmdzKSk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoaW5zdGFuY2UsIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUpOwogICAgcmV0dXJuIGluc3RhbmNlOyAKICB9OwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlLCBFcnJvci5wcm90b3R5cGUpOwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IsIEVycm9yKTsKICBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnTm90SW1wbGVtZW50ZWRFcnJvcic7CgogIGNvbm5lY3QuU3RhdGVFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgaW5zdGFuY2UgPSBuZXcgRXJyb3IoY29ubmVjdC52c3ByaW50Zihmb3JtYXQsIGFyZ3MpKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihpbnN0YW5jZSwgY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZSk7CiAgICByZXR1cm4gaW5zdGFuY2U7IAogIH0KICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZSwgRXJyb3IucHJvdG90eXBlKTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5TdGF0ZUVycm9yLCBFcnJvcik7CiAgY29ubmVjdC5TdGF0ZUVycm9yLnByb3RvdHlwZS5uYW1lID0gJ1N0YXRlRXJyb3InOwoKCgogIGNvbm5lY3QuVm9pY2VJZEVycm9yID0gZnVuY3Rpb24odHlwZSwgbWVzc2FnZSwgZXJyKXsKICAgIHZhciBlcnJvciA9IHt9OwogICAgZXJyb3IudHlwZSA9IHR5cGU7CiAgICBlcnJvci5tZXNzYWdlID0gbWVzc2FnZTsKICAgIGVycm9yLnN0YWNrID0gRXJyb3IobWVzc2FnZSkuc3RhY2s7CiAgICBlcnJvci5lcnIgPSBlcnI7CiAgICByZXR1cm4gZXJyb3I7CiAgfQoKICAvLyBpbnRlcm5hbCB1c2Ugb25seQogIGNvbm5lY3QuaXNDQ1AgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgcmV0dXJuIGNvbmR1aXQubmFtZSA9PT0gJ0Nvbm5lY3RTaGFyZWRXb3JrZXJDb25kdWl0JzsKICB9Cgp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNzM2OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC53b3JrZXIgPSB7fTsKCiAgdmFyIEdFVF9BR0VOVF9USU1FT1VUX01TID0gMzAwMDA7CiAgdmFyIEdFVF9BR0VOVF9SRUNPVkVSWV9USU1FT1VUX01TID0gNTAwMDsKICB2YXIgR0VUX0FHRU5UX1NVQ0NFU1NfVElNRU9VVF9NUyA9IDEwMDsKICB2YXIgTE9HX0JVRkZFUl9DQVBfU0laRSA9IDQwMDsKCiAgdmFyIENIRUNLX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMgPSAzMDAwMDA7IC8vIDUgbWludXRzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyA9IDEwMDAwOyAvLyAxMCBzZWNvbmRzCiAgdmFyIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZID0gNDsKCiAgdmFyIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TID0gMzAwMDA7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgTWFzdGVyVG9waWNDb29yZGluYXRvciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXAgPSB7fTsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5nZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgJ3RvcGljJyk7CiAgICByZXR1cm4gdGhpcy50b3BpY01hc3Rlck1hcFt0b3BpY10gfHwgbnVsbDsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5zZXRNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICd0b3BpYycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlkLCAnaWQnKTsKICAgIHRoaXMudG9waWNNYXN0ZXJNYXBbdG9waWNdID0gaWQ7CiAgfTsKCiAgTWFzdGVyVG9waWNDb29yZGluYXRvci5wcm90b3R5cGUucmVtb3ZlTWFzdGVyID0gZnVuY3Rpb24gKGlkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWQsICdpZCcpOwogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGNvbm5lY3QuZW50cmllcyh0aGlzLnRvcGljTWFzdGVyTWFwKS5maWx0ZXIoZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgIHJldHVybiBlbnRyeS52YWx1ZSA9PT0gaWQ7CiAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uIChlbnRyeSkgewogICAgICBkZWxldGUgc2VsZi50b3BpY01hc3Rlck1hcFtlbnRyeS5rZXldOwogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgV29ya2VyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogIHZhciBXb3JrZXJDbGllbnQgPSBmdW5jdGlvbiAoY29uZHVpdCkgewogICAgY29ubmVjdC5DbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogIH07CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoY29ubmVjdC5DbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdvcmtlckNsaWVudDsKCiAgV29ya2VyQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbiAobWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHJlcXVlc3Rfc3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIGlmKGNvbm5lY3QuY29udGFpbnNWYWx1ZShjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcywgbWV0aG9kKSkgewogICAgICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIGlmKGNvbm5lY3QuY29udGFpbnNWYWx1ZShjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnRNZXRob2RzLCBtZXRob2QpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRUYXNrVGVtcGxhdGVzQ2xpZW50KCkuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0KTsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyb3IpOwogICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IsIGRhdGEpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvciwgZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLmF1dGhGYWlsdXJlKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQgJiYgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICAKICB9OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9yZWNvcmRBUElMYXRlbmN5ID0gZnVuY3Rpb24gKG1ldGhvZCwgcmVxdWVzdF9zdGFydCwgZXJyKSB7CiAgICB2YXIgcmVxdWVzdF9lbmQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHZhciByZXF1ZXN0X3RpbWUgPSByZXF1ZXN0X2VuZCAtIHJlcXVlc3Rfc3RhcnQ7CiAgICB0aGlzLl9zZW5kQVBJTWV0cmljcyhtZXRob2QsIHJlcXVlc3RfdGltZSwgZXJyKTsKICB9OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9zZW5kQVBJTWV0cmljcyA9IGZ1bmN0aW9uIChtZXRob2QsIHRpbWUsIGVycikgewogICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9NRVRSSUMsIHsKICAgICAgbmFtZTogbWV0aG9kLAogICAgICB0aW1lOiB0aW1lLAogICAgICBkaW1lbnNpb25zOiBbCiAgICAgICAgewogICAgICAgICAgbmFtZTogIkNhdGVnb3J5IiwKICAgICAgICAgIHZhbHVlOiAiQVBJIgogICAgICAgIH0KICAgICAgXSwKICAgICAgZXJyb3I6IGVycgogICAgfSk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFRoZSBvYmplY3QgcmVzcG9uc2libGUgZm9yIHBvbGxpbmcgYW5kIHBhc3NpbmcgZGF0YSBkb3duc3RyZWFtIHRvIGFsbAogICAqIGNvbnN1bWVyIHBvcnRzLgogICAqLwogIHZhciBDbGllbnRFbmdpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5tdWx0aXBsZXhlciA9IG5ldyBjb25uZWN0LlN0cmVhbU11bHRpcGxleGVyKCk7CiAgICB0aGlzLmNvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KCJBbWF6b25Db25uZWN0U2hhcmVkV29ya2VyIiwgbnVsbCwgdGhpcy5tdWx0aXBsZXhlcik7CiAgICB0aGlzLmNsaWVudCA9IG5ldyBXb3JrZXJDbGllbnQodGhpcy5jb25kdWl0KTsKICAgIHRoaXMudGltZW91dCA9IG51bGw7CiAgICB0aGlzLmFnZW50ID0gbnVsbDsKICAgIHRoaXMubmV4dFRva2VuID0gbnVsbDsKICAgIHRoaXMuaW5pdERhdGEgPSB7fTsKICAgIHRoaXMucG9ydENvbmR1aXRNYXAgPSB7fTsKICAgIHRoaXMuc3RyZWFtTWFwQnlUYWJJZCA9IHt9OwogICAgdGhpcy5tYXN0ZXJDb29yZCA9IG5ldyBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yKCk7CiAgICB0aGlzLmxvZ3NCdWZmZXIgPSBbXTsKICAgIHRoaXMuc3VwcHJlc3MgPSBmYWxzZTsKICAgIHRoaXMuZm9yY2VPZmZsaW5lID0gZmFsc2U7CiAgICB0aGlzLmxvbmdQb2xsaW5nT3B0aW9ucyA9IHsKICAgICAgYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGU6IGZhbHNlLCAKICAgICAgYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlOiBmYWxzZSwKICAgIH0KCiAgICB2YXIgd2ViU29ja2V0TWFuYWdlciA9IG51bGw7CgogICAgY29ubmVjdC5yb290TG9nZ2VyID0gbmV3IGNvbm5lY3QuRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIodGhpcy5jb25kdWl0KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFTkRfTE9HUywgZnVuY3Rpb24gKGxvZ3NUb1VwbG9hZCkgewogICAgICAvLyBBZGQgc29mdHBob25lIGxvZ3MgZG93bnN0cmVhbQogICAgICBjb25uZWN0LmdldExvZygpLnB1c2hMb2dzRG93bnN0cmVhbShsb2dzVG9VcGxvYWQpOwoKICAgICAgc2VsZi5sb2dzQnVmZmVyID0gc2VsZi5sb2dzQnVmZmVyLmNvbmNhdChsb2dzVG9VcGxvYWQpOwogICAgICAvL29ubHkgY2FsbCBBUEkgdG8gc2VuZCBsb2dzIGlmIGJ1ZmZlciByZWFjaGVkIGNhcAogICAgICBpZiAoc2VsZi5sb2dzQnVmZmVyLmxlbmd0aCA+IExPR19CVUZGRVJfQ0FQX1NJWkUpIHsKICAgICAgICBzZWxmLmhhbmRsZVNlbmRMb2dzUmVxdWVzdChzZWxmLmxvZ3NCdWZmZXIpOwogICAgICB9CiAgICB9KTsKCiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgZnVuY3Rpb24gKGRhdGEpewogICAgICBjb25uZWN0LmdldExvZygpLmRlYnVnKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIFNldHRpbmcgU3VwcHJlc3MgdG8gJXMiLCBkYXRhLnN1cHByZXNzKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBzZWxmLnN1cHByZXNzID0gZGF0YS5zdXBwcmVzcyB8fCBmYWxzZTsKICAgICAgLy9zaWduYWwgb3RoZXIgd2luZG93cyB0aGF0IGEgZmFpbG92ZXIgaGFwcGVuZWQKICAgICAgaWYgKHNlbGYubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSkpIHsKICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZBSUxPVkVSLCB7CiAgICAgICAgICBpc1ByaW1hcnk6ICFzZWxmLnN1cHByZXNzCiAgICAgICAgfSk7ICAgICAgCiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZGVidWcoIltEaXNhc3RlciBSZWNvdmVyeV0gU2V0dGluZyBGT1JDRV9PRkZMSU5FIHRvICVzIiwgZGF0YS5vZmZsaW5lKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBzZWxmLmZvcmNlT2ZmbGluZSA9IGRhdGEub2ZmbGluZSB8fCBmYWxzZTsKICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAoZGF0YS5hdXRoVG9rZW4gJiYgZGF0YS5hdXRoVG9rZW4gIT09IHNlbGYuaW5pdERhdGEuYXV0aFRva2VuKSB7CiAgICAgICAgc2VsZi5pbml0RGF0YSA9IGRhdGE7CiAgICAgICAgY29ubmVjdC5jb3JlLmluaXQoZGF0YSk7CiAgICAgICAgaWYgKGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zKSB7CiAgICAgICAgICBpZiAodHlwZW9mIGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlID09ICJib29sZWFuIikgewogICAgICAgICAgICBzZWxmLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZSA9IGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBkYXRhLmxvbmdQb2xsaW5nT3B0aW9ucy5hbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGUgPT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIHNlbGYubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZSA9IGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gaW5pdCBvbmx5IG9uY2UuCiAgICAgICAgaWYgKCF3ZWJTb2NrZXRNYW5hZ2VyKSB7CgogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDcmVhdGluZyBhIG5ldyBXZWJzb2NrZXQgY29ubmVjdGlvbiBmb3IgQ0NQIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAgICAgY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyLnNldEdsb2JhbENvbmZpZyh7CiAgICAgICAgICAgIGxvZ2dlckNvbmZpZzogeyBsb2dnZXI6IGNvbm5lY3QuZ2V0TG9nKCkgfQogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlciA9IGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlci5jcmVhdGUoKTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uSW5pdEZhaWx1cmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uT3BlbihmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fT1BFTiwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25DbG9zZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fQ0xPU0UsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Db25uZWN0aW9uR2FpbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCk7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0dBSU4pOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25Mb3N0KGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCByZXNwb25zZSk7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5DT05ORUNUSU9OX0xPU1QsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25TdWJzY3JpcHRpb25VcGRhdGUoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fVVBEQVRFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uU3Vic2NyaXB0aW9uRmFpbHVyZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9GQUlMVVJFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQWxsTWVzc2FnZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkFMTF9NRVNTQUdFLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBzZWxmLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNFTkQsIGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuc2VuZE1lc3NhZ2UobWVzc2FnZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBzZWxmLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklCRSwgZnVuY3Rpb24gKHRvcGljcykgewogICAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLnN1YnNjcmliZVRvcGljcyh0b3BpY3MpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5pbml0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5nZXRXZWJTb2NrZXRVcmwpKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlICYmICFyZXNwb25zZS53ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkKSB7CiAgICAgICAgICAgICAgICAvLyBTdGFydCBwb2xsaW5nIGZvciBhZ2VudCBkYXRhLgogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJLaWNraW5nIG9mZiBhZ2VudCBwb2xsaW5nIikKICAgICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudCgpOwogIAogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJLaWNraW5nIG9mZiBjb25maWcgcG9sbGluZyIpCiAgICAgICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKHsgcmVwZWF0Rm9yZXZlcjogdHJ1ZSB9KTsKICAKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiS2lja2luZyBvZmYgYXV0aCB0b2tlbiBwb2xsaW5nIikKICAgICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmNoZWNrQXV0aFRva2VuKSwgQ0hFQ0tfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ZW50ID0gY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuSU5JVF9GQUlMVVJFOwogICAgICAgICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oZXZlbnQpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIldlYlNvY2tldCBmYWlsZWQgdG8gaW5pdGlhbGl6ZSIpCiAgICAgICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIk5vdCBJbml0aWFsaXppbmcgYSBuZXcgV2Vic29ja2V0TWFuYWdlciBpbnN0YW5jZSwgc2luY2Ugb25lIGFscmVhZHkgZXhpc3RzIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFLCBmdW5jdGlvbiAoKSB7CiAgICAgIC8vdXBsb2FkIHBlbmRpbmcgbG9ncyBiZWZvcmUgdGVybWluYXRpbmcuCiAgICAgIHNlbGYuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0KHNlbGYubG9nc0J1ZmZlcik7CiAgICAgIGNvbm5lY3QuY29yZS50ZXJtaW5hdGUoKTsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQpOwogICAgfSk7CiAgICB0aGlzLmNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNZTkNIUk9OSVpFLCBmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSk7CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oZGF0YS5ldmVudCwgZGF0YS5kYXRhKTsKICAgIH0pOwoKICAgIC8qKgogICAgICogQ2FsbGVkIHdoZW4gYSBjb25zdW1lciBwb3J0IGNvbm5lY3RzIHRvIHRoaXMgU2hhcmVkV29ya2VyLgogICAgICogTGV0J3MgYWRkIHRoZW0gdG8gb3VyIG11bHRpcGxleGVyLgogICAgICovCiAgICBnbG9iYWwub25jb25uZWN0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgIHZhciBwb3J0ID0gZXZlbnQucG9ydHNbMF07CiAgICAgIHZhciBzdHJlYW0gPSBuZXcgY29ubmVjdC5Qb3J0U3RyZWFtKHBvcnQpOwogICAgICBzZWxmLm11bHRpcGxleGVyLmFkZFN0cmVhbShzdHJlYW0pOwogICAgICBwb3J0LnN0YXJ0KCk7CgogICAgICB2YXIgcG9ydENvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KHN0cmVhbS5nZXRJZCgpLCBudWxsLCBzdHJlYW0pOwogICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgeyBpZDogc3RyZWFtLmdldElkKCkgfSk7CgogICAgICBzZWxmLnBvcnRDb25kdWl0TWFwW3N0cmVhbS5nZXRJZCgpXSA9IHBvcnRDb25kdWl0OwogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoIH0pOwoKICAgICAgaWYgKHNlbGYuYWdlbnQgIT09IG51bGwpIHsKICAgICAgICBzZWxmLnVwZGF0ZUFnZW50KCk7CiAgICAgIH0KCiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVRVUVTVCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQVBJUmVxdWVzdCwgcG9ydENvbmR1aXQpKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVFVRVNULAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVNYXN0ZXJSZXF1ZXN0LCBwb3J0Q29uZHVpdCwgc3RyZWFtLmdldElkKCkpKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlJFTE9BRF9BR0VOVF9DT05GSUdVUkFUSU9OLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5UQUJfSUQsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZVRhYklkRXZlbnQsIHN0cmVhbSkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQ0xPU0UsIAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVDbG9zZUV2ZW50LCBzdHJlYW0pKTsKICAgIH07CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1NOQVBTSE9ULCB7CiAgICAgIG5leHRUb2tlbjogc2VsZi5uZXh0VG9rZW4sCiAgICAgIHRpbWVvdXQ6IEdFVF9BR0VOVF9USU1FT1VUX01TCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNlbGYuYWdlbnQgPSBzZWxmLmFnZW50IHx8IHt9OwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90ID0gZGF0YS5zbmFwc2hvdDsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcCA9IGNvbm5lY3Qubm93KCk7CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3Quc2tldyA9IHNlbGYuYWdlbnQuc25hcHNob3Quc25hcHNob3RUaW1lc3RhbXAgLSBzZWxmLmFnZW50LnNuYXBzaG90LmxvY2FsVGltZXN0YW1wOwogICAgICAgICAgICBzZWxmLm5leHRUb2tlbiA9IGRhdGEubmV4dFRva2VuOwogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJHRVRfQUdFTlRfU05BUFNIT1Qgc3VjY2VlZGVkLiIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudCgpOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJMb25nIHBvbGwgZmFpbGVkIHRvIHVwZGF0ZSBhZ2VudC4iKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnQpLCBHRVRfQUdFTlRfU1VDQ0VTU19USU1FT1VUX01TKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBnZXQgYWdlbnQgZGF0YS4iKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudCksIEdFVF9BR0VOVF9SRUNPVkVSWV9USU1FT1VUX01TKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCgogICAgICB9KTsKCiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX0NPTkZJR1VSQVRJT04sIHt9LCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIGNvbmZpZ3VyYXRpb24gPSBkYXRhLmNvbmZpZ3VyYXRpb247CiAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFN0YXRlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2Rlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBzZWxmLnBvbGxGb3JSb3V0aW5nUHJvZmlsZVF1ZXVlcyhjb25maWd1cmF0aW9uKTsKICAgICAgICBpZiAocGFyYW1zLnJlcGVhdEZvcmV2ZXIpIHsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uLCBwYXJhbXMpLAogICAgICAgICAgICBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBjb25maWd1cmF0aW9uIGRhdGEuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChwYXJhbXMucmVwZWF0Rm9yZXZlcikgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50Q29uZmlndXJhdGlvbiksCiAgICAgICAgICAgICAgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMsIHBhcmFtcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgfSwKICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRTdGF0ZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1NUQVRFUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLm5leHRUb2tlbikgewogICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFN0YXRlcyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgc3RhdGVzOiAocGFyYW1zLnN0YXRlcyB8fCBbXSkuY29uY2F0KGRhdGEuc3RhdGVzKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRTdGF0ZXMgPSAocGFyYW1zLnN0YXRlcyB8fCBbXSkuY29uY2F0KGRhdGEuc3RhdGVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggYWdlbnQgc3RhdGVzIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckFnZW50UGVybWlzc2lvbnMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0FHRU5UX1BFUk1JU1NJT05TLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwoKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50UGVybWlzc2lvbnMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIHBlcm1pc3Npb25zOiAocGFyYW1zLnBlcm1pc3Npb25zIHx8IFtdKS5jb25jYXQoZGF0YS5wZXJtaXNzaW9ucyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLnBlcm1pc3Npb25zID0gKHBhcmFtcy5wZXJtaXNzaW9ucyB8fCBbXSkuY29uY2F0KGRhdGEucGVybWlzc2lvbnMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBwZXJtaXNzaW9ucyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JEaWFsYWJsZUNvdW50cnlDb2RlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfRElBTEFCTEVfQ09VTlRSWV9DT0RFUywgewogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBjb3VudHJ5Q29kZXM6IChwYXJhbXMuY291bnRyeUNvZGVzIHx8IFtdKS5jb25jYXQoZGF0YS5jb3VudHJ5Q29kZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5kaWFsYWJsZUNvdW50cmllcyA9IChwYXJhbXMuY291bnRyeUNvZGVzIHx8IFtdKS5jb25jYXQoZGF0YS5jb3VudHJ5Q29kZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBkaWFsYWJsZSBjb3VudHJ5IGNvZGVzIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9ST1VUSU5HX1BST0ZJTEVfUVVFVUVTLCB7CiAgICAgIHJvdXRpbmdQcm9maWxlQVJOOiBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOLAogICAgICBuZXh0VG9rZW46IHBhcmFtcy5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBjb3VudHJ5Q29kZXM6IChwYXJhbXMucXVldWVzIHx8IFtdKS5jb25jYXQoZGF0YS5xdWV1ZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMgPSAocGFyYW1zLnF1ZXVlcyB8fCBbXSkuY29uY2F0KGRhdGEucXVldWVzKTsKICAgICAgICAgICAgc2VsZi51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggcm91dGluZyBwcm9maWxlIHF1ZXVlcyBsaXN0LiIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCksCiAgICAgICAgYWNjZXNzRGVuaWVkOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKQogICAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUFQSVJlcXVlc3QgPSBmdW5jdGlvbiAocG9ydENvbmR1aXQsIHJlcXVlc3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLmNsaWVudC5jYWxsKHJlcXVlc3QubWV0aG9kLCByZXF1ZXN0LnBhcmFtcywgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIHZhciByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSwgcmVxdWVzdCwgZGF0YSk7CiAgICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIHZhciByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVNQT05TRSwgcmVxdWVzdCwgZGF0YSwgSlNPTi5zdHJpbmdpZnkoZXJyKSk7CiAgICAgICAgcG9ydENvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCInJXMnIEFQSSByZXF1ZXN0IGZhaWxlZCIsIHJlcXVlc3QubWV0aG9kKQogICAgICAgICAgLndpdGhPYmplY3QoeyByZXF1ZXN0OiBzZWxmLmZpbHRlckF1dGhUb2tlbihyZXF1ZXN0KSwgcmVzcG9uc2U6IHJlc3BvbnNlIH0pCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlcnIpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCwge2F1dGhvcml6ZTogdHJ1ZX0pCiAgICB9KTsKICB9OwoKICAvKioKICAgKiBIYW5kbGUgaW5jb21pbmcgbWFzdGVyIHF1ZXJ5IG9yIG1vZGlmaWNhdGlvbiByZXF1ZXN0cyBmcm9tIGNvbm5lY3RlZCB0YWIgcG9ydHMuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVNYXN0ZXJSZXF1ZXN0ID0gZnVuY3Rpb24gKHBvcnRDb25kdWl0LCBwb3J0SWQsIHJlcXVlc3QpIHsKICAgIHZhciBtdWx0aXBsZXhlckNvbmR1aXQgPSB0aGlzLmNvbmR1aXQ7CiAgICB2YXIgcmVzcG9uc2UgPSBudWxsOwoKICAgIHN3aXRjaCAocmVxdWVzdC5tZXRob2QpIHsKICAgICAgY2FzZSBjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQkVDT01FX01BU1RFUjoKICAgICAgICB2YXIgbWFzdGVySWQgPSB0aGlzLm1hc3RlckNvb3JkLmdldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYyk7CiAgICAgICAgdmFyIHRha2VPdmVyID0gQm9vbGVhbihtYXN0ZXJJZCkgJiYgbWFzdGVySWQgIT09IHBvcnRJZDsKICAgICAgICB0aGlzLm1hc3RlckNvb3JkLnNldE1hc3RlcihyZXF1ZXN0LnBhcmFtcy50b3BpYywgcG9ydElkKTsKICAgICAgICByZXNwb25zZSA9IGNvbm5lY3QuRXZlbnRGYWN0b3J5LmNyZWF0ZVJlc3BvbnNlKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgcmVxdWVzdCwgewogICAgICAgICAgbWFzdGVySWQ6IHBvcnRJZCwKICAgICAgICAgIHRha2VPdmVyOiB0YWtlT3ZlciwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwogICAgICAgIGlmICh0YWtlT3ZlcikgewogICAgICAgICAgbXVsdGlwbGV4ZXJDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQ0hFQ0tfTUFTVEVSOgogICAgICAgIHZhciBtYXN0ZXJJZCA9IHRoaXMubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljKTsKICAgICAgICBpZiAoIW1hc3RlcklkICYmICFyZXF1ZXN0LnBhcmFtcy5zaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUpIHsKICAgICAgICAgIHRoaXMubWFzdGVyQ29vcmQuc2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljLCBwb3J0SWQpOwogICAgICAgICAgbWFzdGVySWQgPSBwb3J0SWQ7CiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCByZXF1ZXN0LCB7CiAgICAgICAgICBtYXN0ZXJJZDogbWFzdGVySWQsCiAgICAgICAgICBpc01hc3RlcjogcG9ydElkID09PSBtYXN0ZXJJZCwKICAgICAgICAgIHRvcGljOiByZXF1ZXN0LnBhcmFtcy50b3BpYwogICAgICAgIH0pOwogICAgICAgIGJyZWFrOwoKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbWFzdGVyIG1ldGhvZDogIiArIHJlcXVlc3QubWV0aG9kKTsKICAgIH0KCiAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlVGFiSWRFdmVudCA9IGZ1bmN0aW9uIChzdHJlYW0sIGRhdGEpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRyeSB7CiAgICAgIGxldCB0YWJJZCA9IGRhdGEudGFiSWQ7CiAgICAgIGxldCBzdHJlYW1zSW5UaGlzVGFiID0gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXTsKICAgICAgbGV0IGN1cnJlbnRTdHJlYW1JZCA9IHN0cmVhbS5nZXRJZCgpOwogICAgICBsZXQgdGFiSWRzID0gT2JqZWN0LmtleXMoc2VsZi5zdHJlYW1NYXBCeVRhYklkKTsKICAgICAgbGV0IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciA9IHRhYklkcy5maWx0ZXIodGFiSWQgPT4gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5sZW5ndGggPiAwKS5sZW5ndGg7CiAgICAgIGlmIChzdHJlYW1zSW5UaGlzVGFiICYmIHN0cmVhbXNJblRoaXNUYWIubGVuZ3RoID4gMCl7CiAgICAgICAgaWYgKCFzdHJlYW1zSW5UaGlzVGFiLmluY2x1ZGVzKGN1cnJlbnRTdHJlYW1JZCkpIHsKICAgICAgICAgIHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ucHVzaChjdXJyZW50U3RyZWFtSWQpOwogICAgICAgICAgbGV0IHVwZGF0ZU9iamVjdCA9IHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGgsIHRhYklkLCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgfTsKICAgICAgICAgIHVwZGF0ZU9iamVjdFt0YWJJZF0gPSB7IGxlbmd0aDogc3RyZWFtc0luVGhpc1RhYi5sZW5ndGggfTsKICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHVwZGF0ZU9iamVjdCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0gPSBbc3RyZWFtLmdldElkKCldOwogICAgICAgIGxldCB1cGRhdGVPYmplY3QgPSB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoLCB0YWJJZCwgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyOiBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgKyAxIH07CiAgICAgICAgdXBkYXRlT2JqZWN0W3RhYklkXSA9IHsgbGVuZ3RoOiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCB9OwogICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHVwZGF0ZU9iamVjdCk7CiAgICAgIH0KICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJbVGFiIElkc10gSXNzdWUgdXBkYXRpbmcgY29ubmVjdGVkIENDUHMgd2l0aGluIHRoZSBzYW1lIHRhYiIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUNsb3NlRXZlbnQgPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYubXVsdGlwbGV4ZXIucmVtb3ZlU3RyZWFtKHN0cmVhbSk7CiAgICBkZWxldGUgc2VsZi5wb3J0Q29uZHVpdE1hcFtzdHJlYW0uZ2V0SWQoKV07CiAgICBzZWxmLm1hc3RlckNvb3JkLnJlbW92ZU1hc3RlcihzdHJlYW0uZ2V0SWQoKSk7CiAgICBsZXQgdXBkYXRlT2JqZWN0ID0geyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCB9OwogICAgbGV0IHRhYklkcyA9IE9iamVjdC5rZXlzKHNlbGYuc3RyZWFtTWFwQnlUYWJJZCk7CiAgICB0cnkgewogICAgICBsZXQgdGFiSWQgPSB0YWJJZHMuZmluZChrZXkgPT4gc2VsZi5zdHJlYW1NYXBCeVRhYklkW2tleV0uaW5jbHVkZXMoc3RyZWFtLmdldElkKCkpKTsKICAgICAgaWYgKHRhYklkKSB7CiAgICAgICAgbGV0IHN0cmVhbUluZGV4SW5NYXAgPSBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmZpbmRJbmRleCgodmFsdWUpID0+IHN0cmVhbS5nZXRJZCgpID09PSB2YWx1ZSk7CiAgICAgICAgc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5zcGxpY2Uoc3RyZWFtSW5kZXhJbk1hcCwgMSk7CiAgICAgICAgbGV0IHRhYkxlbmd0aCA9IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0gPyBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCA6IDA7CiAgICAgICAgdXBkYXRlT2JqZWN0W3RhYklkXSA9IHsgbGVuZ3RoOiB0YWJMZW5ndGggfTsKICAgICAgICB1cGRhdGVPYmplY3QudGFiSWQgPSB0YWJJZDsKICAgICAgfQogICAgICBsZXQgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyID0gdGFiSWRzLmZpbHRlcih0YWJJZCA9PiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCA+IDApLmxlbmd0aDsKICAgICAgdXBkYXRlT2JqZWN0LnN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciA9IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlcjsKICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJbVGFiIElkc10gSXNzdWUgdXBkYXRpbmcgdGFiSWQtc3BlY2lmaWMgc3RyZWFtIGRhdGEiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVVBEQVRFX0NPTk5FQ1RFRF9DQ1BTLCB1cGRhdGVPYmplY3QpOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24pIHsKICAgIGlmIChjb25maWd1cmF0aW9uLnBlcm1pc3Npb25zICYmCiAgICAgIGNvbmZpZ3VyYXRpb24uZGlhbGFibGVDb3VudHJpZXMgJiYKICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFN0YXRlcyAmJgogICAgICBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcykgewoKICAgICAgdGhpcy5hZ2VudCA9IHRoaXMuYWdlbnQgfHwge307CiAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247CiAgICAgIHRoaXMudXBkYXRlQWdlbnQoKTsKCiAgICB9IGVsc2UgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCBjb25maWd1cmF0aW9uIHVudGlsIGFsbCBjb25maWcgZGF0YSBoYXMgYmVlbiBmZXRjaGVkLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS51cGRhdGVBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGhpcy5hZ2VudCkgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgaGFzIGJlZW4gZnVsbHkgY29uc3RydWN0ZWQuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgaWYgKCF0aGlzLmFnZW50LnNuYXBzaG90KSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBzbmFwc2hvdCBpcyBhdmFpbGFibGUuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgaWYgKCF0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24pIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IGNvbmZpZ3VyYXRpb24gaXMgYXZhaWxhYmxlLiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgfSBlbHNlIHsKICAgICAgLy8gQWxpYXMgc29tZSBvZiB0aGUgcHJvcGVydGllcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3Quc3RhdHVzID0gdGhpcy5hZ2VudC5zdGF0ZTsKCiAgICAgIC8vIFNvcnQgdGhlIGNvbnRhY3RzIG9uIHRoZSB0aW1lc3RhbXAKICAgICAgaWYgKHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMgJiYgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5zb3J0KGZ1bmN0aW9uIChjb250YWN0QSwgY29udGFjdEIpIHsKICAgICAgICAgIHJldHVybiBjb250YWN0QS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpIC0gY29udGFjdEIuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgY29udGFjdC5zdGF0dXMgPSBjb250YWN0LnN0YXRlOwoKICAgICAgICBjb250YWN0LmNvbm5lY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gKGNvbm5lY3Rpb24pIHsKICAgICAgICAgIGNvbm5lY3Rpb24uYWRkcmVzcyA9IGNvbm5lY3Rpb24uZW5kcG9pbnQ7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlLnF1ZXVlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTjsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5mb3JFYWNoKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICAgIHF1ZXVlLnF1ZXVlSWQgPSBxdWV1ZS5xdWV1ZUFSTjsKICAgICAgfSk7CiAgICAgIHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICAgIC8vY29udGFjdC5xdWV1ZSBpcyBudWxsIHdoZW4gbW9uaXRvcmluZwogICAgICAgIGlmIChjb250YWN0LnF1ZXVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRhY3QucXVldWUucXVldWVJZCA9IGNvbnRhY3QucXVldWUucXVldWVBUk47CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQgPQogICAgICAgIHRoaXMuYWdlbnQuY29uZmlndXJhdGlvbi5yb3V0aW5nUHJvZmlsZS5yb3V0aW5nUHJvZmlsZUFSTjsKICAgICAgCiAgICAgIGlmICh0aGlzLnN1cHByZXNzKSB7CiAgICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cyA9IHRoaXMuYWdlbnQuc25hcHNob3QuY29udGFjdHMuZmlsdGVyKGZ1bmN0aW9uKGNvbnRhY3QpewogICAgICAgICAgcmV0dXJuIChjb250YWN0LnN0YXRlLnR5cGUgPT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQgfHwgY29udGFjdC5zdGF0ZS50eXBlID09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQpOwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmZvcmNlT2ZmbGluZSkgewogICAgICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FKTsKICAgICAgICB9CiAgICAgIH0gCiAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLlVQREFURSwgdGhpcy5hZ2VudCk7CiAgICB9CiAgfTsKCi8qKgogKiBQcm92aWRlcyBhIHdlYnNvY2tldCB1cmwgdGhyb3VnaCB0aGUgY3JlYXRlX3RyYW5zcG9ydCBBUEkuCiAqIEByZXR1cm5zIGEgcHJvbWlzZSB3aGljaCwgdXBvbiBzdWNjZXNzLCByZXR1cm5zIHRoZSByZXNwb25zZSBmcm9tIHRoZSBjcmVhdGVUcmFuc3BvcnQgQVBJLgogKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmdldFdlYlNvY2tldFVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgb25BdXRoRmFpbCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCk7CiAgICB2YXIgb25BY2Nlc3NEZW5pZWQgPSBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQWNjZXNzRGVuaWVkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfVFJBTlNQT1JULCB7IHRyYW5zcG9ydFR5cGU6IGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTLldFQl9TT0NLRVQgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFdlYlNvY2tldFVybCBzdWNjZWVkZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBmYWlsZWQiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgIHJlYXNvbjogJ2dldFdlYlNvY2tldFVybCBmYWlsZWQnLCAKICAgICAgICAgICAgX2RlYnVnOiBlcnIKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBBdXRoIEZhaWx1cmUiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBdXRoZW50aWNhdGlvbiBmYWlsZWQgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkF1dGhGYWlsKCk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFdlYlNvY2tldFVybCBBY2Nlc3MgRGVuaWVkIEZhaWx1cmUiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJBY2Nlc3MgRGVuaWVkIEZhaWx1cmUgd2hpbGUgZ2V0dGluZyBnZXRXZWJTb2NrZXRVcmwiKSk7CiAgICAgICAgICBvbkFjY2Vzc0RlbmllZCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKCiAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIGRvd25zdHJlYW0gdG8gYWxsIGNvbnN1bWVycyB3aGVuIHdlIGRldGVjdCB0aGF0IGF1dGhlbnRpY2F0aW9uCiAgICAqIGFnYWluc3Qgb25lIG9mIG91ciBBUElzIGhhcyBmYWlsZWQuCiAgICAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ0V2ZW50cyA9IFtdOwogICAgdmFyIGxvZ3NUb1NlbmQgPSBzZWxmLmxvZ3NCdWZmZXIuc2xpY2UoKTsKICAgIHNlbGYubG9nc0J1ZmZlciA9IFtdOwogICAgbG9nc1RvU2VuZC5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgbG9nRXZlbnRzLnB1c2goewogICAgICAgIHRpbWVzdGFtcDogbG9nLnRpbWUsCiAgICAgICAgY29tcG9uZW50OiBsb2cuY29tcG9uZW50LAogICAgICAgIG1lc3NhZ2U6IGxvZy50ZXh0CiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0NMSUVOVF9MT0dTLCB7IGxvZ0V2ZW50czogbG9nRXZlbnRzIH0sIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlNlbmRMb2dzIHJlcXVlc3Qgc3VjY2VlZGVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJTZW5kTG9ncyByZXF1ZXN0IGZhaWxlZC4iKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkud2l0aEV4Y2VwdGlvbihlcnIpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgYXV0aEZhaWx1cmU6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBdXRoRmFpbCkKICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQXV0aEZhaWwgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKGRhdGEpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZGF0YSk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCk7CiAgICB9CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBY2Nlc3NEZW5pZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNDRVNTX0RFTklFRCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5jaGVja0F1dGhUb2tlbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBleHBpcmF0aW9uRGF0ZSA9IG5ldyBEYXRlKHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbik7CiAgICB2YXIgY3VycmVudFRpbWVTdGFtcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHRoaXJ0eU1pbnMgPSAzMCAqIDYwICogMTAwMDsKCiAgICAvLyByZWZyZXNoIHRva2VuIDMwIG1pbnV0ZXMgYmVmb3JlIGV4cGlyYXRpb24KICAgIGlmIChleHBpcmF0aW9uRGF0ZS5nZXRUaW1lKCkgPCAoY3VycmVudFRpbWVTdGFtcCArIHRoaXJ0eU1pbnMpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aCB0b2tlbiBleHBpcmVzIGF0ICIgKyBleHBpcmF0aW9uRGF0ZSArICIgU3RhcnQgcmVmcmVzaGluZyB0b2tlbiB3aXRoIHJldHJ5LiIpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuYmFja29mZihjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuYXV0aG9yaXplKSwgUkVGUkVTSF9BVVRIX1RPS0VOX0lOVEVSVkFMX01TLCBSRUZSRVNIX0FVVEhfVE9LRU5fTUFYX1RSWSk7CiAgICB9CiAgfTsKCgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuYXV0aG9yaXplID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZSh0aGlzLmluaXREYXRhLmF1dGhvcml6ZUVuZHBvaW50KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICB2YXIgZXhwaXJhdGlvbiA9IG5ldyBEYXRlKHJlc3BvbnNlLmV4cGlyYXRpb24pOwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkF1dGhvcml6YXRpb24gc3VjY2VlZGVkIGFuZCB0aGUgdG9rZW4gZXhwaXJlcyBhdCAlcyIsIGV4cGlyYXRpb24pCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuID0gcmVzcG9uc2UuYWNjZXNzVG9rZW47CiAgICAgIHNlbGYuaW5pdERhdGEuYXV0aFRva2VuRXhwaXJhdGlvbiA9IGV4cGlyYXRpb247CiAgICAgIGNvbm5lY3QuY29yZS5pbml0Q2xpZW50KHNlbGYuaW5pdERhdGEpOwogICAgICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50KHNlbGYuaW5pdERhdGEpOwogICAgICBjYWxsYmFja3Muc3VjY2VzcygpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkF1dGhvcml6YXRpb24gZmFpbGVkIHdpdGggY29kZSAlcyIsIHJlc3BvbnNlLnN0YXR1cykKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxKSB7CiAgICAgICAgc2VsZi5oYW5kbGVBdXRoRmFpbCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIEZpbHRlciB0aGUgJ2F1dGhlbnRpY2F0aW9uJyBmaWVsZCBvZiB0aGUgcmVxdWVzdCBwYXJhbXMgZnJvbSB0aGUgZ2l2ZW4gQVBJX1JFUVVFU1QgZXZlbnQuCiAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5maWx0ZXJBdXRoVG9rZW4gPSBmdW5jdGlvbiAocmVxdWVzdCkgewogICAgdmFyIG5ld19yZXF1ZXN0ID0ge307CgogICAgZm9yICh2YXIga2V5QSBpbiByZXF1ZXN0KSB7CiAgICAgIGlmIChrZXlBID09PSAncGFyYW1zJykgewogICAgICAgIHZhciBuZXdfcGFyYW1zID0ge307CiAgICAgICAgZm9yICh2YXIga2V5QiBpbiByZXF1ZXN0LnBhcmFtcykgewogICAgICAgICAgaWYgKGtleUIgIT09ICdhdXRoZW50aWNhdGlvbicpIHsKICAgICAgICAgICAgbmV3X3BhcmFtc1trZXlCXSA9IHJlcXVlc3QucGFyYW1zW2tleUJdOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbmV3X3JlcXVlc3QucGFyYW1zID0gbmV3X3BhcmFtczsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXdfcmVxdWVzdFtrZXlBXSA9IHJlcXVlc3Rba2V5QV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbmV3X3JlcXVlc3Q7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3Qud29ya2VyLm1haW4gPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0Lndvcmtlci5jbGllbnRFbmdpbmUgPSBuZXcgQ2xpZW50RW5naW5lKCk7CiAgfTsKCn0pKCk7CgovKioqLyB9KQoKLyoqKioqKi8gCX0pOwovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqLyAJLy8gVGhlIG1vZHVsZSBjYWNoZQovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVfY2FjaGVfXyA9IHt9OwovKioqKioqLyAJCi8qKioqKiovIAkvLyBUaGUgcmVxdWlyZSBmdW5jdGlvbgovKioqKioqLyAJZnVuY3Rpb24gX193ZWJwYWNrX3JlcXVpcmVfXyhtb2R1bGVJZCkgewovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCXZhciBjYWNoZWRNb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdOwovKioqKioqLyAJCWlmIChjYWNoZWRNb2R1bGUgIT09IHVuZGVmaW5lZCkgewovKioqKioqLyAJCQlyZXR1cm4gY2FjaGVkTW9kdWxlLmV4cG9ydHM7Ci8qKioqKiovIAkJfQovKioqKioqLyAJCS8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpCi8qKioqKiovIAkJdmFyIG1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF0gPSB7Ci8qKioqKiovIAkJCS8vIG5vIG1vZHVsZS5pZCBuZWVkZWQKLyoqKioqKi8gCQkJLy8gbm8gbW9kdWxlLmxvYWRlZCBuZWVkZWQKLyoqKioqKi8gCQkJZXhwb3J0czoge30KLyoqKioqKi8gCQl9OwovKioqKioqLyAJCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uCi8qKioqKiovIAkJX193ZWJwYWNrX21vZHVsZXNfX1ttb2R1bGVJZF0obW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7Ci8qKioqKiovIAkKLyoqKioqKi8gCQkvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZQovKioqKioqLyAJCXJldHVybiBtb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCX0KLyoqKioqKi8gCQovKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwovKioqKioqLyAJLyogd2VicGFjay9ydW50aW1lL2dsb2JhbCAqLwovKioqKioqLyAJKCgpID0+IHsKLyoqKioqKi8gCQlfX3dlYnBhY2tfcmVxdWlyZV9fLmcgPSAoZnVuY3Rpb24oKSB7Ci8qKioqKiovIAkJCWlmICh0eXBlb2YgZ2xvYmFsVGhpcyA9PT0gJ29iamVjdCcpIHJldHVybiBnbG9iYWxUaGlzOwovKioqKioqLyAJCQl0cnkgewovKioqKioqLyAJCQkJcmV0dXJuIHRoaXMgfHwgbmV3IEZ1bmN0aW9uKCdyZXR1cm4gdGhpcycpKCk7Ci8qKioqKiovIAkJCX0gY2F0Y2ggKGUpIHsKLyoqKioqKi8gCQkJCWlmICh0eXBlb2Ygd2luZG93ID09PSAnb2JqZWN0JykgcmV0dXJuIHdpbmRvdzsKLyoqKioqKi8gCQkJfQovKioqKioqLyAJCX0pKCk7Ci8qKioqKiovIAl9KSgpOwovKioqKioqLyAJCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkKLyoqKioqKi8gCS8vIHN0YXJ0dXAKLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJLy8gVGhpcyBlbnRyeSBtb2R1bGUgdXNlZCAnbW9kdWxlJyBzbyBpdCBjYW4ndCBiZSBpbmxpbmVkCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgyNyk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDk0NCk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDE1MSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDg5MSk7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDU5Mik7Ci8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fKDgyKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNzU0KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODMzKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oOTY1KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMjg2KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODk1KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNzQzKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNjQyKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNzM2KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNDM5KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMjc5KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNDE4KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMTg3KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODIxKTsKLyoqKioqKi8gCXZhciBfX3dlYnBhY2tfZXhwb3J0c19fID0gX193ZWJwYWNrX3JlcXVpcmVfXyg1MDApOwovKioqKioqLyAJCi8qKioqKiovIH0pKCkKOw==";

  var LATEST_STREAMJS_CODE = window.atob(LATEST_STREAMJS_BASE64_CODE);


  /**
   Connect instance container
   It holds the connect api context within an iframe window.

   usage:
   var newContainer = new Container({ccpUrl: "bla", ...})
   */
  var Container = function(resource) {
      this.region = resource.region;
      this.id = this.region.replace(/-/g, '_');
      this.height = resource.height;
      this.style = resource.iframe_style; 
      this.ccp = this._createFramedCcp(JSON.stringify(resource));
  };

  Container.prototype._createFramedCcp = function (resource) {
    var permission = permission || "microphone; autoplay";
    var style = this.style || FRAME_DIMENSIONS;
    var iframe = document.createElement('iframe');
    iframe.srcdoc = this.getContent(resource);
    iframe.allow = permission;
    iframe.id = this.id;
    iframe.style = style;
    iframe.scrolling = "no";
    return iframe; 
  };

  Container.prototype.getContent = function(resource){
     return [
       "<!DOCTYPE html>",
       "<meta charset='UTF-8'>",
       "<html>",
         "<head>",
           "<script type='text/javascript'>",
             LATEST_STREAMJS_CODE,
           "</script>",
         "</head>",
         "<body onload='init()'>",
           "<div id=containerDiv style='width: 100%;height: " + this.height + "'></div>",
           "<script type='text/javascript'>",
             "function init() {",
               "connect.core.initCCP(containerDiv," + resource + ");",
            "}",
           "</script>",
         "</body>",
       "</html>"
     ].join('');
   };

  globalConnect.Container = Container;
})();
})();

// This entry need to be wrapped in an IIFE because it need to be isolated against other entry modules.
(() => {
/*
 * Copyright 2014-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Note: load utils before core.js
 */

(function () {
  var global = this;
  connect = global.connect || {};
  globalConnect = global.globalConnect || {};
  global.connect = connect;
  global.globalConnect = globalConnect;
  global.lily = connect;

  connect.core = {};
  globalConnect.core = { regions: {} };

  var IFRAME_STYLE = "margin: 0; border: 0; padding:0px;width: 0px;height: 0px";
  var GLOBALIFRAME_STYLE =
    "margin: 0; border: 0; padding:0px;width: 100%;height: 100%";
  var DIV_DEFAULT_HEIGHT = {
    height: "465px",
  };
  var uiFailoverEnabled = true;

  var extractCcpRegionParams = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.standByRegion, "ccpBackupResource");
    connect.assertNotNull(paramsIn.standByRegion.ccpUrl, "ccpUrl");
    connect.assertNotNull(paramsIn.standByRegion.loginUrl, "loginUrl");
    connect.assertNotNull(paramsIn.standByRegion.region, "region");

    var regionAParams = paramsIn;
    var regionBParams = Object.assign({}, paramsIn, {
      ccpUrl: paramsIn.standByRegion.ccpUrl,
      loginUrl: paramsIn.standByRegion.loginUrl,
      region: paramsIn.standByRegion.region,
    });

    var divStyle = extractDivStyle(globalContainerDiv);

    if (divStyle.display == "none") {
      uiFailoverEnabled = false;
    }

    if (parseInt(divStyle.height) <= 0) {
      globalContainerDiv.style.height = DIV_DEFAULT_HEIGHT.height; // populating ccp
      divStyle.height = DIV_DEFAULT_HEIGHT.height;
    }

    return [regionAParams, regionBParams].map(function (params) {
      connect.assertNotNull(params.ccpUrl, "ccpUrl");
      connect.assertNotNull(params.loginUrl, "loginUrl");
      connect.assertNotNull(params.region, "region");
      delete params.standByRegion;
      params.loginPopup = false;
      //signal CCP as part of a disaster recovery fleet
      params.disasterRecoveryOn = true;
      params.iframe_style = IFRAME_STYLE;
      params.height = divStyle.height;
      return params;
    });
  };

  var extractDivStyle = function (globalContainerDiv) {
    var style = window.getComputedStyle(globalContainerDiv);
    return {
      height: style.getPropertyValue("height"),
      width: style.getPropertyValue("width"),
      display: style.getPropertyValue("display"),
    };
  };

  var validateRegion = function (region, availableRegions) {
    connect.assertTrue(
      typeof region == "string",
      "Region provided " + region + " is not a valid string"
    );
    var regions = availableRegions || globalConnect.core.regions;
    if (!regions.hasOwnProperty(region)) {
      var message = "Region provided " + region + " is not found!";
      throw new connect.ValueError(message);
    }
  };

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it successfully gets the primary region.
   * 
   * @callback getPrimaryRegionSuccessCallback
   * @param {string} region -- A string representing an AWS region (e.g. "us-west-2") that is serving as the primary region in the disaster recovery setup.
   */

  /**
   * A callback that should be used by a getPrimaryRegionCallback when it fails to get the primary region.
   * 
   * @callback getPrimaryRegionFailureCallback
   *
   */

  /**
   * Callback for fetching the primary region in a disaster recovery setup.
   * 
   * @callback getPrimaryRegionCallback
   * @param {getPrimaryRegionSuccessCallback} success -- A success callback that getPrimaryRegionCallback should call upon successfully fetching the primary region string.
   * @param {getPrimaryRegionFailureCallback} failure -- A failure callback that getPrimaryRegionCalllback should call upon unsuccessfully fetching the primary region string.
   */


  /**
   * Particular to DR, the getPrimaryRegion paramsIn field is new, and required. It returns a promise that is resolved once the CCP and namespace are successfully initialized. 
   * It is recommended that you do not attempt to use the connect object before this promise is resolved.
   * @param {object} globalContainerDiv -- The container div for the active and secondary CCPs for use with DR.
   * @param {object} paramsIn -- Identical to connect.core.initCCP's paramsIn, save for one additional param.
   * @param {getPrimaryRegionCallback} paramsIn.getPrimaryRegion -- Required. A callback function that fetches the primary region for DR as a string (like "us-west-2") and feeds it into the success callback.
   */
  globalConnect.core.initCCP = function (globalContainerDiv, paramsIn) {
    connect.assertNotNull(paramsIn.getPrimaryRegion, "getPrimaryRegion");
    connect.assertTrue(
      connect.isFunction(paramsIn.getPrimaryRegion),
      "getPrimaryRegion must be a function"
    );
    var getPrimaryRegionFunc = paramsIn.getPrimaryRegion;
    delete paramsIn.getPrimaryRegion;

    var dualCcpResources = extractCcpRegionParams(globalContainerDiv, paramsIn);
    getPrimaryRegionFunc(
      function (primaryRegion) {
        return new Promise(resolve => {
          var regions = dualCcpResources.reduce(function (obj, resource) {
            obj[resource.region] = null;
            return obj;
          }, {});
          validateRegion(primaryRegion, regions);

          var containers = dualCcpResources.map(function (resource) {
            if (resource.region === primaryRegion) {
              resource.isPrimary = true;
            }
            return new globalConnect.Container(resource);
          });

          //Create global Iframe and attach ccp containers
          var ccpIframes = containers.map(function (container) {
            return container.ccp.outerHTML;
          });
          var globalIframe = document.createElement("iframe");
          globalIframe.style = GLOBALIFRAME_STYLE;
          globalIframe.id = "globalCCP";
          globalIframe.scrolling = "no";

          // surface single instance connect api in main window
          globalIframe.onload = function () {
            if (uiFailoverEnabled) {
              var secondaryRegion = Object.keys(regions).find(function (
                region
              ) {
                return region != primaryRegion;
              });

              activateUI(primaryRegion, globalIframe.id);
              deactivateUI(secondaryRegion, globalIframe.id);
            }
            containers.map(function (container) {
              globalConnect.core.regions[container.region] =
                globalIframe.contentDocument.getElementById(
                  container.id
                ).contentWindow.connect;
              //listen to failover state change from other window
              var regionalConnect =
                globalConnect.core.regions[container.region];
              regionalConnect.core
                .getUpstream()
                .onUpstream(
                  regionalConnect.DisasterRecoveryEvents.FAILOVER,
                  function (data) {
                    if (data.isPrimary) {
                      connect = regionalConnect;
                      primaryRegion = connect.core.region;
                      if (uiFailoverEnabled) {
                        activateUI(primaryRegion, globalIframe.id);
                      }
                    } else if (uiFailoverEnabled) {
                      secondaryRegion = regionalConnect.core.region;
                      deactivateUI(secondaryRegion, globalIframe.id);
                    }
                  }
                );
            });
            connect = globalConnect.core.regions[primaryRegion];
            resolve();
          };
          globalIframe.srcdoc = ccpIframes.join("");
          globalContainerDiv.appendChild(globalIframe);
        });
      },
      function (callback) {
        console.error(
          "[Disaster Recovery] An error occured, while attempting to retrieve your primary region;"
        );
        callback();
      }
    );
  };

  var deactivateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height: 0; width: 0; border: 0px";
  };

  var activateUI = function (regionID, globalIframeID) {
    regionID = regionID.replace(/-/g, "_");
    var renderedGlobalIframe = document.getElementById(globalIframeID);
    renderedGlobalIframe.contentDocument.getElementById(regionID).style =
      "height:800px;width:100%;border:0px";
  };

  var getFailoverRegion = function (primaryRegion) {
    var primaryRegion = primaryRegion || connect.core.region;
    return Object.keys(globalConnect.core.regions).find(function (r) {
      return r !== primaryRegion;
    });
  };

  globalConnect.core.failover = function () {
    globalConnect.core.failoverTo(getFailoverRegion());
  };

  globalConnect.core.failoverTo = function (electedNewPrimaryRegion) {
      validateRegion(electedNewPrimaryRegion);
      var currentPrimaryRegion = getFailoverRegion(electedNewPrimaryRegion);
      deactivate(currentPrimaryRegion);
      activate(electedNewPrimaryRegion);
      connect = globalConnect.core.regions[electedNewPrimaryRegion];
  };

  /**-------------------------------------------------------------------------
   * Deactivates a region
   */
  var deactivate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Deactivating %s region.", connect.core.region)
      .sendInternalLogToServer();
    // call this to suppress contacts
    connect.core.suppressContacts(true);
    connect.core.forceOffline();
  };

  /**-------------------------------------------------------------------------
   * Activates Stand-by region on failover using suppress==false event
   */
  var activate = function (region) {
    var connect = globalConnect.core.regions[region];
    connect
      .getLog()
      .info("[Disaster Recovery] Activating %s region.", connect.core.region)
      .sendInternalLogToServer();
    connect.core.suppressContacts(false);
  };

  //reference to globalConnect initCCP. This is to mimic the single initialization CCP behavior
  connect.core.initCCP = globalConnect.core.initCCP;
})();

})();

/******/ })()
;