!function(){var I=function(){return I.cache.hasOwnProperty(arguments[0])||(I.cache[arguments[0]]=I.parse(arguments[0])),I.format.call(null,I.cache[arguments[0]],arguments)};function g(I){return Object.prototype.toString.call(I).slice(8,-1).toLowerCase()}function C(I,g){for(var C=[];g>0;C[--g]=I);return C.join("")}I.format=function(A,Z){var l,b,G,d,c,V,W,m=1,B=A.length,i="",X=[];for(b=0;b<B;b++)if("string"===(i=g(A[b])))X.push(A[b]);else if("array"===i){if((d=A[b])[2])for(l=Z[m],G=0;G<d[2].length;G++){if(!l.hasOwnProperty(d[2][G]))throw I('[sprintf] property "%s" does not exist',d[2][G]);l=l[d[2][G]]}else l=d[1]?Z[d[1]]:Z[m++];if(/[^s]/.test(d[8])&&"number"!=g(l))throw I("[sprintf] expecting number but found %s",g(l));switch(d[8]){case"b":l=l.toString(2);break;case"c":l=String.fromCharCode(l);break;case"d":l=parseInt(l,10);break;case"e":l=d[7]?l.toExponential(d[7]):l.toExponential();break;case"f":l=d[7]?parseFloat(l).toFixed(d[7]):parseFloat(l);break;case"o":l=l.toString(8);break;case"s":l=(l=String(l))&&d[7]?l.substring(0,d[7]):l;break;case"u":l>>>=0;break;case"x":l=l.toString(16);break;case"X":l=l.toString(16).toUpperCase()}l=/[def]/.test(d[8])&&d[3]&&l>=0?"+"+l:l,V=d[4]?"0"==d[4]?"0":d[4].charAt(1):" ",W=d[6]-String(l).length,c=d[6]?C(V,W):"",X.push(d[5]?l+c:c+l)}return X.join("")},I.cache={},I.parse=function(I){for(var g=I,C=[],A=[],Z=0;g;){if(null!==(C=/^[^\x25]+/.exec(g)))A.push(C[0]);else if(null!==(C=/^\x25{2}/.exec(g)))A.push("%");else{if(null===(C=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(g)))throw"[sprintf] huh?";if(C[2]){Z|=1;var l=[],b=C[2],G=[];if(null===(G=/^([a-z_][a-z_\d]*)/i.exec(b)))throw"[sprintf] huh?";for(l.push(G[1]);""!==(b=b.substring(G[0].length));)if(null!==(G=/^\.([a-z_][a-z_\d]*)/i.exec(b)))l.push(G[1]);else{if(null===(G=/^\[(\d+)\]/.exec(b)))throw"[sprintf] huh?";l.push(G[1])}C[2]=l}else Z|=2;if(3===Z)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";A.push(C)}g=g.substring(C[0].length)}return A},this.sprintf=I,this.vsprintf=function(g,C,A){return(A=C.slice(0)).splice(0,0,g),I.apply(null,A)}}(),function(){var I=this;connect=I.connect||{},I.connect=connect,I.lily=connect;var g=navigator.userAgent,C=["bubbles","cancelBubble","cancelable","composed","data","defaultPrevented","eventPhase","isTrusted","lastEventId","origin","returnValue","timeStamp","type"];connect.sprintf=I.sprintf,connect.vsprintf=I.vsprintf,delete I.sprintf,delete I.vsprintf,connect.HTTP_STATUS_CODES={SUCCESS:200,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500},connect.TRANSPORT_TYPES={CHAT_TOKEN:"chat_token",WEB_SOCKET:"web_socket"},connect.hitch=function(){var I=Array.prototype.slice.call(arguments),g=I.shift(),C=I.shift();return connect.assertNotNull(g,"scope"),connect.assertNotNull(C,"method"),connect.assertTrue(connect.isFunction(C),"method must be a function"),function(){var A=Array.prototype.slice.call(arguments);return C.apply(g,I.concat(A))}},connect.isFunction=function(I){return!!(I&&I.constructor&&I.call&&I.apply)},connect.isArray=function(I){return"[object Array]"===Object.prototype.toString.call(I)},connect.keys=function(I){var g=[];for(var C in connect.assertNotNull(I,"map"),I)g.push(C);return g},connect.values=function(I){var g=[];for(var C in connect.assertNotNull(I,"map"),I)g.push(I[C]);return g},connect.entries=function(I){var g=[];for(var C in I)g.push({key:C,value:I[C]});return g},connect.merge=function(){var I=Array.prototype.slice.call(arguments,0),g={};return I.forEach((function(I){connect.entries(I).forEach((function(I){g[I.key]=I.value}))})),g},connect.now=function(){return(new Date).getTime()},connect.find=function(I,g){for(var C=0;C<I.length;C++)if(g(I[C]))return I[C];return null},connect.contains=function(I,g){return I instanceof Array?null!=connect.find(I,(function(I){return I===g})):g in I},connect.containsValue=function(I,g){return I instanceof Array?null!=connect.find(I,(function(I){return I===g})):null!=connect.find(connect.values(I),(function(I){return I===g}))},connect.randomId=function(){return connect.sprintf("%s-%s",connect.now(),Math.random().toString(36).slice(2))},connect.makeEnum=function(I){var g={};return I.forEach((function(I){var C=I.replace(/\.?([a-z]+)_?/g,(function(I,g){return g.toUpperCase()+"_"})).replace(/_$/,"");g[C]=I})),g},connect.makeNamespacedEnum=function(I,g){var C=connect.makeEnum(g);return connect.keys(C).forEach((function(g){C[g]=connect.sprintf("%s::%s",I,C[g])})),C},connect.makeGenericNamespacedEnum=function(I,g,C){var A=connect.makeEnum(g);return connect.keys(A).forEach((function(g){A[g]=connect.sprintf("%s"+C+"%s",I,A[g])})),A},connect.isChromeBrowser=function(){return-1!==g.indexOf("Chrome")},connect.isFirefoxBrowser=function(){return-1!==g.indexOf("Firefox")},connect.isOperaBrowser=function(){return-1!==g.indexOf("Opera")},connect.getChromeBrowserVersion=function(){var I=g.substring(g.indexOf("Chrome")+7);return I?parseFloat(I):-1},connect.getFirefoxBrowserVersion=function(){var I=g.substring(g.indexOf("Firefox")+8);return I?parseFloat(I):-1},connect.isValidLocale=function(I){return[{id:"en_US",label:"English"},{id:"de_DE",label:"Deutsch"},{id:"es_ES",label:"Español"},{id:"fr_FR",label:"Français"},{id:"ja_JP",label:"日本語"},{id:"it_IT",label:"Italiano"},{id:"ko_KR",label:"한국어"},{id:"pt_BR",label:"Português"},{id:"zh_CN",label:"中文(简体)"},{id:"zh_TW",label:"中文(繁體)"}].map((function(I){return I.id})).includes(I)},connect.getOperaBrowserVersion=function(){var I=g.indexOf("Opera"),C=-1!==g.indexOf("Version")?g.substring(I+8):g.substring(I+6);return C?parseFloat(C):-1},connect.index=function(I,g){var C={};return I.forEach((function(I){C[g(I)]=I})),C},connect.set=function(I){var g={};return I.forEach((function(I){g[I]=1})),g},connect.relativeComplement=function(I,g){var C={};return connect.keys(g).forEach((function(A){A in I||(C[A]=g[A])})),C},connect.assertTrue=function(I,g){if(!I)throw new connect.ValueError(g)},connect.assertNotNull=function(I,g){return connect.assertTrue(null!=I&&void 0!==typeof I,connect.sprintf("%s must be provided",g||"A value")),I},connect.deepcopy=function(I){return JSON.parse(JSON.stringify(I))},connect.deepcopyCrossOriginEvent=function(I){const g={};return C.forEach((C=>{try{g[C]=I[C]}catch(I){connect.getLog().info("deepcopyCrossOriginEvent failed on key: ",C).sendInternalLogToServer()}})),connect.deepcopy(g)},connect.getBaseUrl=function(){var g=I.location;return connect.sprintf("%s//%s:%s",g.protocol,g.hostname,g.port)},connect.getUrlWithProtocol=function(g){var C=I.location.protocol;return g.substr(0,C.length)!==C?connect.sprintf("%s//%s",C,g):g},connect.isFramed=function(){try{return window.self!==window.top}catch(I){return!0}},connect.hasOtherConnectedCCPs=function(){return connect.numberOfConnectedCCPs>1},connect.fetch=function(I,g,C,A){return A=A||5,C=C||1e3,g=g||{},new Promise((function(Z,l){!function A(b){fetch(I,g).then((function(I){I.status===connect.HTTP_STATUS_CODES.SUCCESS?I.json().then((I=>Z(I))).catch((()=>Z({}))):1!==b&&(I.status>=connect.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR||I.status===connect.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)?setTimeout((function(){A(--b)}),C):l(I)})).catch((function(I){l(I)}))}(A)}))},connect.backoff=function(g,C,A,Z){connect.assertTrue(connect.isFunction(g),"func must be a Function");var l=this;g({success:function(I){Z&&Z.success&&Z.success(I)},failure:function(b,G){if(A>0){var d=2*C*Math.random();I.setTimeout((function(){l.backoff(g,2*d,--A,Z)}),d)}else Z&&Z.failure&&Z.failure(b,G)}})},connect.publishMetric=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.CLIENT_METRIC,data:I})},connect.publishSoftphoneStats=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.SOFTPHONE_STATS,data:I})},connect.publishSoftphoneReport=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.SOFTPHONE_REPORT,data:I})},connect.publishClickStreamData=function(I){connect.core.getUpstream().sendUpstream(connect.EventType.BROADCAST,{event:connect.EventType.CLICK_STREAM_DATA,data:I})},connect.publishClientSideLogs=function(I){connect.core.getEventBus().trigger(connect.EventType.CLIENT_SIDE_LOGS,I)},connect.addNamespaceToLogs=function(I){["log","error","warn","info","debug"].forEach((g=>{const C=window.console[g];window.console[g]=function(){const g=Array.from(arguments);g.unshift(`[${I}]`),C.apply(window.console,g)}}))},connect.PopupManager=function(){},connect.PopupManager.prototype.open=function(I,g,C){var A=this._getLastOpenedTimestamp(g),Z=(new Date).getTime(),l=null;if(Z-A>864e5){if(C){var b=C.height||578,G=C.width||433,d=C.top||0,c=C.left||0;(l=window.open("",g,"width="+G+", height="+b+", top="+d+", left="+c)).location!==I&&(l=window.open(I,g,"width="+G+", height="+b+", top="+d+", left="+c))}else(l=window.open("",g)).location!==I&&(l=window.open(I,g));this._setLastOpenedTimestamp(g,Z)}return l},connect.PopupManager.prototype.clear=function(g){var C=this._getLocalStorageKey(g);I.localStorage.removeItem(C)},connect.PopupManager.prototype._getLastOpenedTimestamp=function(g){var C=this._getLocalStorageKey(g),A=I.localStorage.getItem(C);return A?parseInt(A,10):0},connect.PopupManager.prototype._setLastOpenedTimestamp=function(g,C){var A=this._getLocalStorageKey(g);I.localStorage.setItem(A,""+C)},connect.PopupManager.prototype._getLocalStorageKey=function(I){return"connectPopupManager::"+I};var A=connect.makeEnum(["granted","denied","default"]);connect.NotificationManager=function(){this.queue=[],this.permission=A.DEFAULT},connect.NotificationManager.prototype.requestPermission=function(){var g=this;"Notification"in I?I.Notification.permission===A.DENIED?(connect.getLog().warn("The user has requested to not receive notifications.").sendInternalLogToServer(),this.permission=A.DENIED):this.permission!==A.GRANTED&&I.Notification.requestPermission().then((function(I){g.permission=I,I===A.GRANTED?g._showQueued():g.queue=[]})):(connect.getLog().warn("This browser doesn't support notifications.").sendInternalLogToServer(),this.permission=A.DENIED)},connect.NotificationManager.prototype.show=function(I,g){if(this.permission===A.GRANTED)return this._showImpl({title:I,options:g});if(this.permission===A.DENIED)connect.getLog().warn("Unable to show notification.").sendInternalLogToServer().withObject({title:I,options:g});else{var C={title:I,options:g};connect.getLog().warn("Deferring notification until user decides to allow or deny.").withObject(C).sendInternalLogToServer(),this.queue.push(C)}},connect.NotificationManager.prototype._showQueued=function(){var I=this,g=this.queue.map((function(g){return I._showImpl(g)}));return this.queue=[],g},connect.NotificationManager.prototype._showImpl=function(g){var C=new I.Notification(g.title,g.options);return g.options.clicked&&(C.onclick=function(){g.options.clicked.call(C)}),C},connect.ValueError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift(),C=new Error(connect.vsprintf(g,I));return Object.setPrototypeOf(C,connect.ValueError.prototype),C},Object.setPrototypeOf(connect.ValueError.prototype,Error.prototype),Object.setPrototypeOf(connect.ValueError,Error),connect.ValueError.prototype.name="ValueError",connect.NotImplementedError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift(),C=new Error(connect.vsprintf(g,I));return Object.setPrototypeOf(C,connect.NotImplementedError.prototype),C},Object.setPrototypeOf(connect.NotImplementedError.prototype,Error.prototype),Object.setPrototypeOf(connect.NotImplementedError,Error),connect.NotImplementedError.prototype.name="NotImplementedError",connect.StateError=function(){var I=Array.prototype.slice.call(arguments,0),g=I.shift(),C=new Error(connect.vsprintf(g,I));return Object.setPrototypeOf(C,connect.StateError.prototype),C},Object.setPrototypeOf(connect.StateError.prototype,Error.prototype),Object.setPrototypeOf(connect.StateError,Error),connect.StateError.prototype.name="StateError",connect.VoiceIdError=function(I,g,C){var A={};return A.type=I,A.message=g,A.stack=Error(g).stack,A.err=C,A},connect.isCCP=function(){return"ConnectSharedWorkerConduit"===connect.core.getUpstream().name}}(),function(){var I=this;connect=I.connect||{},I.connect=connect,I.globalConnect={},I.lily=connect,globalConnect.Container=null;var g=window.atob("LyoqKioqKi8gKCgpID0+IHsgLy8gd2VicGFja0Jvb3RzdHJhcAovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVzX18gPSAoewoKLyoqKi8gODIxOgovKioqLyAoKCkgPT4gewoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5hZ2VudEFwcCA9IHt9OwoKICB2YXIgQVBQID0gewogICAgQ0NQOiAnY2NwJywKICB9OwoKICBjb25uZWN0LmFnZW50QXBwLmluaXRDQ1AgPSBjb25uZWN0LmNvcmUuaW5pdENDUDsKICBjb25uZWN0LmFnZW50QXBwLmlzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoaW5zdGFuY2VBbGlhcykge307CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcENvbW11bmljYXRpb24gPSBmdW5jdGlvbiAoaWZyYW1lSWQsIGVuZHBvaW50KSB7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWZyYW1lSWQpOwogICAgdmFyIGlmcmFtZUNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KGVuZHBvaW50LCB3aW5kb3csIGlmcmFtZSk7CiAgICB2YXIgQlJPQURDQVNUX1RZUEUgPSBbCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsCiAgICAgIGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsCiAgICAgIGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVECiAgICBdOwogICAgaWZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoZSkgewogICAgICBCUk9BRENBU1RfVFlQRS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbSh0eXBlLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWZyYW1lQ29uZHVpdC5zZW5kVXBzdHJlYW0odHlwZSwgZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIGdldENvbm5lY3RVcmwgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgcG9zID0gY2NwVXJsLmluZGV4T2YoJ2NjcC12MicpOwogICAgcmV0dXJuIGNjcFVybC5zbGljZSgwLCBwb3MgLSAxKTsKICB9OwoKICB2YXIgc2lnbk91dFRocm91Z2hDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgbG9nb3V0VXJsID0gZ2V0Q29ubmVjdFVybChjY3BVcmwpICsgJy9sb2dvdXQnOwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2gobG9nb3V0VXJsLCB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGV2ZW50QnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25uZWN0CiAgICAgICAgLmdldExvZygpCiAgICAgICAgLmVycm9yKCdBbiBlcnJvciBvY2N1cmVkIG9uIGxvZ291dC4nICsgZSkKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBsb2dvdXRVcmw7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogIH07CgogIHZhciBzaWduSW5UaHJvdWdoaW5pdENDUCA9IGZ1bmN0aW9uIChjY3BVcmwsIGNvbnRhaW5lciwgY29uZmlnKSB7CiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgY2NwVXJsOiBjY3BVcmwsCiAgICAgIGNjcExvYWRUaW1lb3V0OiAxMDAwMCwKICAgICAgbG9naW5Qb3B1cDogdHJ1ZSwKICAgICAgbG9naW5Vcmw6IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9naW4nLAogICAgICBzb2Z0cGhvbmU6IHsKICAgICAgICBhbGxvd0ZyYW1lZFNvZnRwaG9uZTogdHJ1ZSwKICAgICAgICBkaXNhYmxlUmluZ3RvbmU6IGZhbHNlLAogICAgICB9CiAgICB9OwogICAgdmFyIGNjcFBhcmFtcyA9IGNvbm5lY3QubWVyZ2UoZGVmYXVsdFBhcmFtcywgY29uZmlnLmNjcFBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENDUChjb250YWluZXIsIGNjcFBhcmFtcyk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwID0gZnVuY3Rpb24gKG5hbWUsIGNvbnRhaW5lcklkLCBhcHBVcmwsIGNvbmZpZykgewogICAgY29uZmlnID0gY29uZmlnID8gY29uZmlnIDoge307CiAgICB2YXIgZW5kcG9pbnQgPSBhcHBVcmwuZW5kc1dpdGgoJy8nKSA/IGFwcFVybCA6IGFwcFVybCArICcvJzsKICAgIHZhciBvbkxvYWQgPSBjb25maWcub25Mb2FkID8gY29uZmlnLm9uTG9hZCA6IG51bGw7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSwgb25Mb2FkOiBvbkxvYWQgfTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgcmVnaXN0ZXJDb25maWcsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKSk7CiAgICBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0YXJ0KG5hbWUsIGZ1bmN0aW9uIChtb2R1bGVEYXRhKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGEuZW5kcG9pbnQ7CiAgICAgIHZhciBjb250YWluZXJET00gPSBtb2R1bGVEYXRhLmNvbnRhaW5lckRPTTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgewogICAgICAgICAgICBjb25maWcuY2NwUGFyYW1zID0gY29uZmlnLmNjcFBhcmFtcyA/IGNvbmZpZy5jY3BQYXJhbXMgOiB7fTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5zdHlsZSkgY29uZmlnLmNjcFBhcmFtcy5zdHlsZSA9IGNvbmZpZy5zdHlsZTsKICAgICAgICAgICAgcmV0dXJuIHNpZ25JblRocm91Z2hpbml0Q0NQKGVuZHBvaW50LCBjb250YWluZXJET00sIGNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbihuYW1lLCBlbmRwb2ludCk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25PdXRUaHJvdWdoQ0NQKGVuZHBvaW50KTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuc3RvcEFwcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5zdG9wKG5hbWUpOwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA1MDA6Ci8qKiovICgoKSA9PiB7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGZ1bmN0aW9uIEFwcFJlZ2lzdHJ5KCkgewogICAgdmFyIG1vZHVsZURhdGEgPSB7fTsKICAgIHZhciBtYWtlQXBwSWZyYW1lID0gZnVuY3Rpb24gKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgICBvbkxvYWQ6IGNvbmZpZy5vbkxvYWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICB2YXIgb25Mb2FkID0gbW9kdWxlRGF0YVthcHBOYW1lXS5vbkxvYWQ7CiAgICAgICAgaWYgKGFwcE5hbWUgIT09IEFQUC5DQ1ApIHsKICAgICAgICAgIHZhciBhcHAgPSBtYWtlQXBwSWZyYW1lKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTY1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0ludmFsaWRMb2NhbGUnLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcKICBdKTsKICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0dXNUeXBlID0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlOwoKICBjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUyA9IGNvbm5lY3Quc2V0KFsKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCwKICAgIGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5IT0xECiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgICAnZGlzY29ubmVjdCcKICBdKTsKICAKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDb250YWN0UmVjb3JkaW5nIFZvaWNlIFRyYWNrIGNvbmZpZwogICAqLwogIGNvbm5lY3QuQ29udGFjdFJlY29yZGluZ1ZvaWNlVHJhY2tDb25maWcgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdBTEwnLAogICAgJ1RPX0FHRU5UJywKICAgICdGUk9NX0FHRU5UJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBNb25pdG9yaW5nTW9kZQogICAqLwogIGNvbm5lY3QuTW9uaXRvcmluZ01vZGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdTSUxFTlRfTU9OSVRPUicsCiAgICAnQkFSR0UnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIE1vbml0b3JpbmdFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Nb25pdG9yaW5nRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2ludmFsaWRfdGFyZ2V0X3N0YXRlJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIGVudW0gQ2hhbm5lbFR5cGUKICAqLwogIGNvbm5lY3QuQ2hhbm5lbFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdWT0lDRScsCiAgICAnQ0hBVCcsCiAgICAnVEFTSycKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIE1lZGlhVHlwZQogICovCiAgY29ubmVjdC5NZWRpYVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdzb2Z0cGhvbmUnLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gU29mdHBob25lQ2FsbFR5cGUKICAgKi8KICBjb25uZWN0LlNvZnRwaG9uZUNhbGxUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYXVkaW9fdmlkZW8nLAogICAgJ3ZpZGVvX29ubHknLAogICAgJ2F1ZGlvX29ubHknLAogICAgJ25vbmUnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFNvZnRwaG9uZUVycm9yVHlwZXMKICAgKi8KICBjb25uZWN0LlNvZnRwaG9uZUVycm9yVHlwZXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd1bnN1cHBvcnRlZF9icm93c2VyJywKICAgICdtaWNyb3Bob25lX25vdF9zaGFyZWQnLAogICAgJ3NpZ25hbGxpbmdfaGFuZHNoYWtlX2ZhaWx1cmUnLAogICAgJ3NpZ25hbGxpbmdfY29ubmVjdGlvbl9mYWlsdXJlJywKICAgICdpY2VfY29sbGVjdGlvbl90aW1lb3V0JywKICAgICd1c2VyX2J1c3lfZXJyb3InLAogICAgJ3dlYnJ0Y19lcnJvcicsCiAgICAncmVhbHRpbWVfY29tbXVuaWNhdGlvbl9lcnJvcicsCiAgICAnb3RoZXInCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIENsaWNrVHlwZQogICAqLwogIGNvbm5lY3QuQ2xpY2tUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnQWNjZXB0JywKICAgICdSZWplY3QnLAogICAgJ0hhbmd1cCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZEVycm9yVHlwZXMKICAgKi8KICBjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnbm9fc3BlYWtlcl9pZF9mb3VuZCcsCiAgICAnc3BlYWtlcl9pZF9ub3RfZW5yb2xsZWQnLAogICAgJ2dldF9zcGVha2VyX2lkX2ZhaWxlZCcsCiAgICAnZ2V0X3NwZWFrZXJfc3RhdHVzX2ZhaWxlZCcsCiAgICAnb3B0X291dF9zcGVha2VyX2ZhaWxlZCcsCiAgICAnb3B0X291dF9zcGVha2VyX2luX2xjbXNfZmFpbGVkJywKICAgICdkZWxldGVfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3N0YXJ0X3Nlc3Npb25fZmFpbGVkJywKICAgICdldmFsdWF0ZV9zcGVha2VyX2ZhaWxlZCcsCiAgICAnc2Vzc2lvbl9ub3RfZXhpc3RzJywKICAgICdkZXNjcmliZV9zZXNzaW9uX2ZhaWxlZCcsCiAgICAnZW5yb2xsX3NwZWFrZXJfZmFpbGVkJywKICAgICd1cGRhdGVfc3BlYWtlcl9pZF9mYWlsZWQnLAogICAgJ3VwZGF0ZV9zcGVha2VyX2lkX2luX2xjbXNfZmFpbGVkJywKICAgICdub3Rfc3VwcG9ydGVkX29uX2NvbmZlcmVuY2VfY2FsbHMnLAogICAgJ2Vucm9sbF9zcGVha2VyX3RpbWVvdXQnLAogICAgJ2V2YWx1YXRlX3NwZWFrZXJfdGltZW91dCcsCiAgICAnZ2V0X2RvbWFpbl9pZF9mYWlsZWQnLAogICAgJ25vX2RvbWFpbl9pZF9mb3VuZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ1RJIGV4Y2VwdGlvbnMKICAgKi8KICBjb25uZWN0LkNUSUV4Y2VwdGlvbnMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBY2Nlc3NEZW5pZWRFeGNlcHRpb24iLAogICAgIkludmFsaWRTdGF0ZUV4Y2VwdGlvbiIsCiAgICAiQmFkRW5kcG9pbnRFeGNlcHRpb24iLAogICAgIkludmFsaWRBZ2VudEFSTkV4Y2VwdGlvbiIsCiAgICAiSW52YWxpZENvbmZpZ3VyYXRpb25FeGNlcHRpb24iLAogICAgIkludmFsaWRDb250YWN0VHlwZUV4Y2VwdGlvbiIsCiAgICAiUGFnaW5hdGlvbkV4Y2VwdGlvbiIsCiAgICAiUmVmcmVzaFRva2VuRXhwaXJlZEV4Y2VwdGlvbiIsCiAgICAiU2VuZERhdGFGYWlsZWRFeGNlcHRpb24iLAogICAgIlVuYXV0aG9yaXplZEV4Y2VwdGlvbiIsCiAgICAiUXVvdGFFeGNlZWRlZEV4Y2VwdGlvbiIKICBdKTsKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIHN0cmVhbWluZyBzdGF0dXMKICAgKi8KICBjb25uZWN0LlZvaWNlSWRTdHJlYW1pbmdTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJPTkdPSU5HIiwKICAgICJFTkRFRCIsCiAgICAiUEVORElOR19DT05GSUdVUkFUSU9OIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIGF1dGhlbnRpY2F0aW9uIGRlY2lzaW9uCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbiA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIkFDQ0VQVCIsCiAgICAiUkVKRUNUIiwKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiU1BFQUtFUl9OT1RfRU5ST0xMRUQiLAogICAgIlNQRUFLRVJfT1BURURfT1VUIiwKICAgICJTUEVBS0VSX0lEX05PVF9QUk9WSURFRCIsCiAgICAiU1BFQUtFUl9FWFBJUkVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIGZyYXVkIGRldGVjdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSElHSF9SSVNLIiwKICAgICJMT1dfUklTSyIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgY29udGFjdCBmbG93IGF1dGhlbnRpY2F0aW9uIGRlY2lzaW9uIAogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQXV0aGVudGljYXRlZCIsCiAgICAiTm90QXV0aGVudGljYXRlZCIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbnJvbGxlZCIsCiAgICAiT3B0ZWRPdXQiLAogICAgIk5vdEVuYWJsZWQiLAogICAgIkVycm9yIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgIGZyYXVkIGRldGVjdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiSGlnaFJpc2siLAogICAgIkxvd1Jpc2siLAogICAgIkluY29uY2x1c2l2ZSIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgRW5yb2xsbWVudFJlcXVlc3QgU3RhdHVzIAogICAqLwogIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIklOX1BST0dSRVNTIiwKICAgICJDT01QTEVURUQiLAogICAgIkZBSUxFRCIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBTcGVha2VyIHN0YXR1cwogICAqLwogIGNvbm5lY3QuVm9pY2VJZFNwZWFrZXJTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJPUFRFRF9PVVQiLAogICAgIkVOUk9MTEVEIiwKICAgICJQRU5ESU5HIgogIF0pOwoKICBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMgPSB7CiAgICBFVkFMVUFURV9TRVNTSU9OX0RFTEFZOiAxMDAwMCwKICAgIEVWQUxVQVRJT05fTUFYX1BPTExfVElNRVM6IDI0LCAvLyBFdmFsdWF0ZVNwZWFrZXIgaXMgUG9sbGluZyBmb3IgbWF4aW11bSAyIG1pbnMuCiAgICBFVkFMVUFUSU9OX1BPTExJTkdfSU5URVJWQUw6IDUwMDAsCiAgICBFTlJPTExNRU5UX01BWF9QT0xMX1RJTUVTOiAxMjAsIC8vIEVucm9sbG1lbnRTcGVha2VyIGlzIFBvbGxpbmcgZm9yIG1heGltdW0gMTAgbWlucy4KICAgIEVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTDogNTAwMCwKICAgIFNUQVJUX1NFU1NJT05fREVMQVk6IDgwMDAKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNvbnN0YW50cyBmb3IgQWdlbnRQZXJtaXNzaW9ucwogICAqLwogIGNvbm5lY3QuQWdlbnRQZXJtaXNzaW9ucyA9IHsKICAgIE9VVEJPVU5EX0NBTEw6ICdvdXRib3VuZENhbGwnLAogICAgVk9JQ0VfSUQ6ICd2b2ljZUlkJywKICAgIENPTlRBQ1RfUkVDT1JESU5HOiAnY29udGFjdFJlY29yZGluZycKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudAogICAqLwogIHZhciBBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCJUaGUgYWdlbnQgaXMgbm90IHlldCBpbml0aWFsaXplZCEiKTsKICAgIH0KICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblJlZnJlc2ggPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJFRlJFU0gsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblJvdXRhYmxlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5ST1VUQUJMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uTm90Um91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLk5PVF9ST1VUQUJMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uT2ZmbGluZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuT0ZGTElORSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uRXJyb3IgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVSUk9SLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Tb2Z0cGhvbmVFcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuU09GVFBIT05FX0VSUk9SLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25XZWJTb2NrZXRDb25uZWN0aW9uTG9zdCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fTE9TVCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25XZWJTb2NrZXRDb25uZWN0aW9uR2FpbmVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9HQUlORUQsIGYpOwogIH0KCiAgQWdlbnQucHJvdG90eXBlLm9uQWZ0ZXJDYWxsV29yayA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuQUNXLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25TdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuU1RBVEVfQ0hBTkdFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25NdXRlVG9nZ2xlID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uTG9jYWxNZWRpYVN0cmVhbUNyZWF0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLkxPQ0FMX01FRElBX1NUUkVBTV9DUkVBVEVELCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25TcGVha2VyRGV2aWNlQ2hhbmdlZCA9IGZ1bmN0aW9uKGYpewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU1BFQUtFUl9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25NaWNyb3Bob25lRGV2aWNlQ2hhbmdlZCA9IGZ1bmN0aW9uKGYpewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuTUlDUk9QSE9ORV9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25SaW5nZXJEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5SSU5HRVJfREVWSUNFX0NIQU5HRUQsIGYpOwogIH0KCiAgQWdlbnQucHJvdG90eXBlLm11dGUgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULAogICAgICB7CiAgICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUsCiAgICAgICAgZGF0YTogeyBtdXRlOiB0cnVlIH0KICAgICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnVubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IGZhbHNlIH0KICAgICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFNwZWFrZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfU1BFQUtFUl9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRNaWNyb3Bob25lRGV2aWNlID0gZnVuY3Rpb24gKGRldmljZUlkKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX01JQ1JPUEhPTkVfREVWSUNFLAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0UmluZ2VyRGV2aWNlID0gZnVuY3Rpb24gKGRldmljZUlkKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuU0VUX1JJTkdFUl9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3Quc3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldE5leHRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3QubmV4dFN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBdmFpbGFiaWxpdHlTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3QuYWdlbnRBdmFpbGFiaWxpdHlTdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLmdldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm5vdygpIC0gdGhpcy5fZ2V0RGF0YSgpLnNuYXBzaG90LnN0YXRlLnN0YXJ0VGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXR1c0R1cmF0aW9uID0gQWdlbnQucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIEFnZW50LnByb3RvdHlwZS5nZXRQZXJtaXNzaW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5wZXJtaXNzaW9uczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q29udGFjdHMgPSBmdW5jdGlvbiAoY29udGFjdFR5cGVGaWx0ZXIpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc25hcHNob3QuY29udGFjdHMubWFwKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICByZXR1cm4gc2VsZi5fY3JlYXRlQ29udGFjdEFQSShjb250YWN0RGF0YSk7CiAgICB9KS5maWx0ZXIoZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgcmV0dXJuICghY29udGFjdFR5cGVGaWx0ZXIpIHx8IGNvbnRhY3QuZ2V0VHlwZSgpID09PSBjb250YWN0VHlwZUZpbHRlcjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb25maWd1cmF0aW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZ2VudFN0YXRlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5hZ2VudFN0YXRlczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Um91dGluZ1Byb2ZpbGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkucm91dGluZ1Byb2ZpbGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENoYW5uZWxDb25jdXJyZW5jeSA9IGZ1bmN0aW9uIChjaGFubmVsKSB7CiAgICB2YXIgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gdGhpcy5nZXRSb3V0aW5nUHJvZmlsZSgpLmNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICAgIGlmICghY2hhbm5lbENvbmN1cnJlbmN5TWFwKSB7CiAgICAgIGNoYW5uZWxDb25jdXJyZW5jeU1hcCA9IE9iamVjdC5rZXlzKGNvbm5lY3QuQ2hhbm5lbFR5cGUpLnJlZHVjZShmdW5jdGlvbiAoYWNjLCBrZXkpIHsKICAgICAgICAvLyBFeGNsdWRlIFRBU0sgZnJvbSBkZWZhdWx0IGNvbmN1cnJlbmN5LgogICAgICAgIGlmIChrZXkgIT09ICdUQVNLJykgewogICAgICAgICAgYWNjW2Nvbm5lY3QuQ2hhbm5lbFR5cGVba2V5XV0gPSAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYWNjOwogICAgICB9LCB7fSk7CiAgICB9CiAgICByZXR1cm4gY2hhbm5lbAogICAgICA/IChjaGFubmVsQ29uY3VycmVuY3lNYXBbY2hhbm5lbF0gfHwgMCkKICAgICAgOiBjaGFubmVsQ29uY3VycmVuY3lNYXA7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkubmFtZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RXh0ZW5zaW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmV4dGVuc2lvbjsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RGlhbGFibGVDb3VudHJpZXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZGlhbGFibGVDb3VudHJpZXM7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmlzU29mdHBob25lRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5zb2Z0cGhvbmVFbmFibGVkOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRDb25maWd1cmF0aW9uID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGlmIChjb25maWd1cmF0aW9uICYmIGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcyAmJiBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMuTEFOR1VBR0UgJiYgIWNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5sb2NhbGUpIHsKICAgICAgLy8gd29ya2Fyb3VuZCBmb3IgdGhlIGluY29uc2lzdGVuY3kgaXNzdWUgdGhhdCBnZXRBZ2VudENvbmZpZ3VyYXRpb24gcmV0dXJucyBhZ2VudFByZWZlcmVuY2VzLkxBTkdVQUdFIGJ1dCB1cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24gZXhwZWN0cyBhZ2VudFByZWZlcmVuY2VzLmxvY2FsZSB0byBiZSBzZXQuCiAgICAgIGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5sb2NhbGUgPSBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMuTEFOR1VBR0U7CiAgICB9CgogICAgaWYgKGNvbmZpZ3VyYXRpb24gJiYgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzICYmICFjb25uZWN0LmlzVmFsaWRMb2NhbGUoY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSkpIHsKICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGNvbm5lY3QuQWdlbnRFcnJvclN0YXRlcy5JTlZBTElEX0xPQ0FMRSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfQUdFTlRfQ09ORklHVVJBVElPTiwgewogICAgICAgIGNvbmZpZ3VyYXRpb246IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb25maWd1cmF0aW9uLCAnY29uZmlndXJhdGlvbicpCiAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gYXNrIHRoZSBzaGFyZWQgd29ya2VyIHRvIHJlbG9hZCBhZ2VudCBjb25maWcKICAgICAgICAgICAgLy8gb25jZSB3ZSBjaGFuZ2UgaXQgc28gZXZlcnkgdGFiIGhhcyBhY2N1cmF0ZSBjb25maWcuCiAgICAgICAgICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlJFTE9BRF9BR0VOVF9DT05GSUdVUkFUSU9OKTsKCiAgICAgICAgICAgIGlmIChjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogICAgfQogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uIChzdGF0ZSwgY2FsbGJhY2tzLCBvcHRpb25zKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlBVVF9BR0VOVF9TVEFURSwgewogICAgICBzdGF0ZTogY29ubmVjdC5hc3NlcnROb3ROdWxsKHN0YXRlLCAnc3RhdGUnKSwKICAgICAgZW5xdWV1ZU5leHRTdGF0ZTogb3B0aW9ucyAmJiAhIW9wdGlvbnMuZW5xdWV1ZU5leHRTdGF0ZQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwogIEFnZW50LnByb3RvdHlwZS5vbkVucXVldWVkTmV4dFN0YXRlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5FTlFVRVVFRF9ORVhUX1NUQVRFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdHVzID0gQWdlbnQucHJvdG90eXBlLnNldFN0YXRlOwoKICBBZ2VudC5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIChlbmRwb2ludEluLCBwYXJhbXMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgZW5kcG9pbnQgPSBuZXcgY29ubmVjdC5FbmRwb2ludChlbmRwb2ludEluKTsKICAgIC8vIEhhdmUgdG8gcmVtb3ZlIHRoZSBlbmRwb2ludElkIGZpZWxkIG9yIEFXUyBKUyBTREsgZ2V0cyBtYWQuCiAgICBkZWxldGUgZW5kcG9pbnQuZW5kcG9pbnRJZDsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX09VVEJPVU5EX0NPTlRBQ1QsIHsKICAgICAgZW5kcG9pbnQ6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50JyksCiAgICAgIHF1ZXVlQVJOOiAocGFyYW1zICYmIChwYXJhbXMucXVldWVBUk4gfHwgcGFyYW1zLnF1ZXVlSWQpKSB8fCB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVBUk4KICAgIH0sIHBhcmFtcyAmJiB7CiAgICAgICAgc3VjY2VzczogcGFyYW1zLnN1Y2Nlc3MsCiAgICAgICAgZmFpbHVyZTogcGFyYW1zLmZhaWx1cmUKICAgICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFsbFF1ZXVlQVJOcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZS5xdWV1ZXMubWFwKGZ1bmN0aW9uIChxdWV1ZSkgewogICAgICByZXR1cm4gcXVldWUucXVldWVBUk47CiAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzID0gZnVuY3Rpb24gKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCBwYWdlSW5mb0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcywgImNhbGxiYWNrcyIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNhbGxiYWNrcy5zdWNjZXNzLCAiY2FsbGJhY2tzLnN1Y2Nlc3MiKTsKICAgIHZhciBwYWdlSW5mbyA9IHBhZ2VJbmZvSW4gfHwgeyB9OwoKICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cyB8fCBbXTsKICAgIHBhZ2VJbmZvLm1heFJlc3VsdHMgPSBwYWdlSW5mby5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGFsbG93aW5nIGEgc2luZ2xlIHF1ZXVlQVJOIHRvIGJlIHNwZWNpZmllZAogICAgLy8gaW5zdGVhZCBvZiBhbiBhcnJheS4KICAgIGlmICghY29ubmVjdC5pc0FycmF5KHF1ZXVlQVJOcykpIHsKICAgICAgcXVldWVBUk5zID0gW3F1ZXVlQVJOc107CiAgICB9CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9FTkRQT0lOVFMsIHsKICAgICAgcXVldWVBUk5zOiBxdWV1ZUFSTnMsCiAgICAgIG5leHRUb2tlbjogcGFnZUluZm8ubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYuZ2V0RW5kcG9pbnRzKHF1ZXVlQVJOcywgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYWdlSW5mby5tYXhSZXN1bHRzLAogICAgICAgICAgICAgIGVuZHBvaW50czogcGFnZUluZm8uZW5kcG9pbnRzLmNvbmNhdChkYXRhLmVuZHBvaW50cykKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwYWdlSW5mby5lbmRwb2ludHMgPSBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKTsKICAgICAgICAgICAgdmFyIGVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5tYXAoZnVuY3Rpb24gKGVuZHBvaW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2Vzcyh7CiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBlbmRwb2ludHMsCiAgICAgICAgICAgICAgYWRkcmVzc2VzOiBlbmRwb2ludHMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWRkcmVzc2VzID0gQWdlbnQucHJvdG90eXBlLmdldEVuZHBvaW50czsKCiAgLy9JbnRlcm5hbCBpZGVudGlmaWVyLgogIEFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZCA9IGZ1bmN0aW9uKCkgewogICAgcXVldWVBcm5zID0gdGhpcy5nZXRBbGxRdWV1ZUFSTnMoKTsKICAgIGZvciAobGV0IHF1ZXVlQXJuIG9mIHF1ZXVlQXJucykgewogICAgICBjb25zdCBhZ2VudElkTWF0Y2ggPSBxdWV1ZUFybi5tYXRjaCgvXC9hZ2VudFwvKFteL10rKS8pOwogICAgICAKICAgICAgaWYgKGFnZW50SWRNYXRjaCkgewogICAgICAgIHJldHVybiBhZ2VudElkTWF0Y2hbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgRXJyb3IoIkFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZDogcXVldWVBcm5zIGRpZCBub3QgY29udGFpbiBhZ2VudFJlc291cmNlSWQ6ICIsIHF1ZXVlQXJucyk7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5BZ2VudFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRTbmFwc2hvdAogICAqLwogIHZhciBBZ2VudFNuYXBzaG90ID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgY29ubmVjdC5BZ2VudC5jYWxsKHRoaXMpOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAgfTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWdlbnQucHJvdG90eXBlKTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50U25hcHNob3Q7CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0CiAgICovCiAgdmFyIENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgdGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkluY29taW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0aW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbk1pc3NlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVuZGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKSwgZik7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BQ1cgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUiksIGYpOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsQ29udGFjdElkOwogIH07CiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbnRhY3RJZCA9IENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3REdXJhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RHVyYXRpb247CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZVRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWVUaW1lc3RhbXA7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbm5lY3Rpb25zLm1hcChmdW5jdGlvbiAoY29ubkRhdGEpIHsKICAgICAgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCk7CiAgICB9KSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFjdGl2ZUluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYWxDb25uID0gdGhpcy5nZXRJbml0aWFsQ29ubmVjdGlvbigpOwogICAgaWYgKGluaXRpYWxDb25uICE9IG51bGwgJiYgaW5pdGlhbENvbm4uaXNBY3RpdmUoKSkgewogICAgICByZXR1cm4gaW5pdGlhbENvbm47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gIWNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpICYmIGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U2luZ2xlQWN0aXZlVGhpcmRQYXJ0eUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgIH0pWzBdIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWdlbnRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHZhciBjb25uVHlwZSA9IGNvbm4uZ2V0VHlwZSgpOwogICAgICByZXR1cm4gY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgfHwgY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm5hbWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdE1ldGFkYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0TWV0YWRhdGE7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXREZXNjcmlwdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZGVzY3JpcHRpb247CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UmVmZXJlbmNlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucmVmZXJlbmNlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5hdHRyaWJ1dGVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdEZlYXR1cmVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENoYW5uZWxDb250ZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jaGFubmVsQ29udGV4dDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc1NvZnRwaG9uZUNhbGwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U29mdHBob25lTWVkaWFJbmZvKCkgIT0gbnVsbDsKICAgIH0pICE9IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuX2lzSW5ib3VuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbml0aWF0aW9uTWV0aG9kID0gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYXRpb25NZXRob2Q7CiAgICByZXR1cm4gKGluaXRpYXRpb25NZXRob2QgPT09IGNvbm5lY3QuQ29udGFjdEluaXRpYXRpb25NZXRob2QuT1VUQk9VTkQpID8gZmFsc2UgOiB0cnVlOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuaXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm4gPSB0aGlzLmdldEluaXRpYWxDb25uZWN0aW9uKCk7CgogICAgLy8gV2Ugd2lsbCBncmFkdWFsbHkgY2hhbmdlIGNoZWNraW5nIGluYm91bmQgYnkgcmVseWluZyBvbiBjb250YWN0IGluaXRpYXRpb25NZXRob2QKICAgIGlmIChjb25uLmdldE1lZGlhVHlwZSgpID09PSBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiB0aGlzLl9pc0luYm91bmQoKTsKICAgIH0KCiAgICByZXR1cm4gY29ubiA/IGNvbm4uZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLklOQk9VTkQgOiBmYWxzZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWNjZXB0ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjb250YWN0SWQgPSB0aGlzLmdldENvbnRhY3RJZCgpOwoKICAgIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2xpY2tUeXBlOiBjb25uZWN0LkNsaWNrVHlwZS5BQ0NFUFQsCiAgICAgIGNsaWNrVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICB9KTsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQUNDRVBUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIHNlbGYuZ2V0Q29udGFjdElkKCkpLAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEluIEZpcmVmb3gsIHRoZXJlJ3MgYSBicm93c2VyIHJlc3RyaWN0aW9uIHRoYXQgYW4gdW5mb2N1c2VkIGJyb3dzZXIgdGFiIGlzIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICAvLyBUaGUgcHJvYmxlbSBpcyB0aGF0IHRoZSByZXN0cmljdGlvbiBjb3VsZCBjYXVzZSBhIHdlYnJ0YyBzZXNzaW9uIGNyZWF0aW9uIHRpbWVvdXQgZXJyb3Igd2hlbiB5b3UgZ2V0IGFuIGluY29taW5nIGNhbGwgd2hpbGUgeW91IGFyZSBub3Qgb24gdGhlIHByaW1hcnkgdGFiLgogICAgICAgICAgLy8gSXQgd2FzIGhhcmQgdG8gd29ya2Fyb3VuZCB0aGUgaXNzdWUgZXNwZWNpYWxseSB3aGVuIHlvdSBoYXZlIG11bHRpcGxlIHRhYnMgb3BlbiBiZWNhdXNlIHlvdSBuZWVkZWQgdG8gZmluZCB0aGUgcmlnaHQgdGFiIGFuZCBhY2NlcHQgdGhlIGNvbnRhY3QgYmVmb3JlIHRoZSB0aW1lb3V0LgogICAgICAgICAgLy8gVG8gYXZvaWQgdGhlIGVycm9yLCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4gaW4gRmlyZWZveCwgYSB3ZWJydGMgc2Vzc2lvbiBpcyBub3QgaW1tZWRpYXRlbHkgY3JlYXRlZCBhcyBhbiBpbmNvbWluZyBzb2Z0cGhvbmUgY29udGFjdCBpcyBkZXRlY3RlZC4KICAgICAgICAgIC8vIEluc3RlYWQsIGl0IHdhaXRzIHVudGlsIGNvbnRhY3QuYWNjZXB0KCkgaXMgY2FsbGVkIG9uIGEgdGFiIGFuZCBsZXRzIHRoZSB0YWIgYmVjb21lIHRoZSBuZXcgcHJpbWFyeSB0YWIgYW5kIHN0YXJ0IHRoZSB3ZWIgcnRjIHNlc3Npb24gdGhlcmUKICAgICAgICAgIC8vIGJlY2F1c2UgdGhlIHRhYiBzaG91bGQgYmUgZm9jdXNlZCBhdCB0aGUgbW9tZW50IGFuZCBoYXZlIGFjY2VzcyB0byB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICB2YXIgY29udGFjdCA9IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKTsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcyA/IGNhbGxiYWNrcy5mYWlsdXJlIDogbnVsbAogICAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJjb250YWN0LmRlc3Ryb3koKSBoYXMgYmVlbiBkZXByZWNhdGVkLiIpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjbGlja1R5cGU6IGNvbm5lY3QuQ2xpY2tUeXBlLlJFSkVDVCwKICAgICAgY2xpY2tUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH0pOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY29tcGxldGUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DTEVBUl9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5ub3RpZnlJc3N1ZSA9IGZ1bmN0aW9uIChpc3N1ZUNvZGUsIGRlc2NyaXB0aW9uLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTk9USUZZX0NPTlRBQ1RfSVNTVUUsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBpc3N1ZUNvZGU6IGlzc3VlQ29kZSwKICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmFkZENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoZW5kcG9pbnRJbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGVuZHBvaW50ID0gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnRJbik7CiAgICAvLyBIYXZlIHRvIHJlbW92ZSB0aGUgZW5kcG9pbnRJZCBmaWVsZCBvciBBV1MgSlMgU0RLIGdldHMgbWFkLgogICAgZGVsZXRlIGVuZHBvaW50LmVuZHBvaW50SWQ7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9BRERJVElPTkFMX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBlbmRwb2ludDogZW5kcG9pbnQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUudG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB2YXIgaG9sZGluZ0Nvbm4gPSBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICAgIH0pOwoKICAgIGlmIChob2xkaW5nQ29ubiAhPSBudWxsKSB7CiAgICAgIGNvbm5lY3Rpb25JZCA9IGhvbGRpbmdDb25uLmdldENvbm5lY3Rpb25JZCgpOwoKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhY3RpdmVDb25ucyA9IHRoaXMuZ2V0Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgICByZXR1cm4gY29ubi5pc0FjdGl2ZSgpOwogICAgICB9KTsKICAgICAgaWYgKGFjdGl2ZUNvbm5zLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25uZWN0aW9uSWQgPSBhY3RpdmVDb25uc1swXS5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgfQogICAgfQoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5UT0dHTEVfQUNUSVZFX0NPTk5FQ1RJT05TLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiBjb25uZWN0aW9uSWQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuc2VuZFNvZnRwaG9uZU1ldHJpY3MgPSBmdW5jdGlvbiAoc29mdHBob25lU3RyZWFtU3RhdGlzdGljcywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX01FVFJJQ1MsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgc29mdHBob25lU3RyZWFtU3RhdGlzdGljczogc29mdHBob25lU3RyZWFtU3RhdGlzdGljcwogICAgfSwgY2FsbGJhY2tzKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVTdGF0cyh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHN0YXRzOiBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzCiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5zZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKHJlcG9ydCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfUkVQT1JULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9LCBjYWxsYmFja3MpOwoKICAgIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVJlcG9ydCh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jb25mZXJlbmNlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTkZFUkVOQ0VfQ09OTkVDVElPTlMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnRvU25hcHNob3QgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuaXNNdWx0aVBhcnR5Q29uZmVyZW5jZUVuYWJsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29udGFjdEZlYXR1cmVzID0gdGhpcy5nZXRDb250YWN0RmVhdHVyZXMoKTsKICAgIHJldHVybiAhIShjb250YWN0RmVhdHVyZXMgJiYgY29udGFjdEZlYXR1cmVzLm11bHRpUGFydHlDb25mZXJlbmNlRW5hYmxlZCk7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS51cGRhdGVNb25pdG9yUGFydGljaXBhbnRTdGF0ZSA9IGZ1bmN0aW9uICh0YXJnZXRTdGF0ZSwgY2FsbGJhY2tzKSB7CiAgICBpZighdGFyZ2V0U3RhdGUgfHwgIU9iamVjdC52YWx1ZXMoY29ubmVjdC5Nb25pdG9yaW5nTW9kZSkuaW5jbHVkZXModGFyZ2V0U3RhdGUpKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoYEludmFsaWQgdGFyZ2V0IHN0YXRlIHdhcyBwcm92aWRlZDogJHt0YXJnZXRTdGF0ZX1gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5Nb25pdG9yaW5nRXJyb3JUeXBlcy5JTlZBTElEX1RBUkdFVF9TVEFURSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfTU9OSVRPUl9QQVJUSUNJUEFOVF9TVEFURSwgewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgICB0YXJnZXRNb25pdG9yTW9kZTogdGFyZ2V0U3RhdGUKICAgICAgfSwgY2FsbGJhY2tzKTsKICAgIH0KICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3RTbmFwc2hvdAogICAqLwogIHZhciBDb250YWN0U25hcHNob3QgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIGNvbm5lY3QuQ29udGFjdC5jYWxsKHRoaXMsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB0aGlzLmNvbnRhY3REYXRhID0gY29udGFjdERhdGE7CiAgfTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb250YWN0LnByb3RvdHlwZSk7CiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbnRhY3RTbmFwc2hvdDsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3REYXRhOwogIH07CgogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbm5lY3Rpb25BUEkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QoY29ubmVjdGlvbkRhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb24KICAgKi8KICB2YXIgQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgICB0aGlzLmNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25JZDsKICAgIHRoaXMuX2luaXRNZWRpYUNvbnRyb2xsZXIoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb25uZWN0aW9uRGF0YSgKICAgICAgdGhpcy5nZXRDb250YWN0SWQoKSwgdGhpcy5nZXRDb25uZWN0aW9uSWQoKSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25JZDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5FbmRwb2ludCh0aGlzLl9nZXREYXRhKCkuZW5kcG9pbnQpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEFkZHJlc3MgPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludDsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXR1cyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWw7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNBY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgdGhpcy5nZXRTdGF0dXMoKS50eXBlKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNDb25uZWN0aW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkc7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNPbkhvbGQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICAvKioKICAgKiBHZXRzIHRoZSBjdXJyZW50bHkgbW9uaXRvcmVkIGNvbnRhY3QgaW5mbywgUmV0dXJucyBudWxsIGlmIGRvZXMgbm90IGV4aXN0cy4KICAgKiBAcmV0dXJuIHt7YWdlbnROYW1lOnN0cmluZywgY3VzdG9tZXJOYW1lOnN0cmluZywgam9pblRpbWU6RGF0ZX19CiAgICovCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvckluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm1vbml0b3JpbmdJbmZvOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICBjb25uZWN0LnB1Ymxpc2hDbGlja1N0cmVhbURhdGEoewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNsaWNrVHlwZTogY29ubmVjdC5DbGlja1R5cGUuSEFOR1VQLAogICAgICBjbGlja1RpbWU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQogICAgfSk7CgogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5ERVNUUk9ZX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuc2VuZERpZ2l0cyA9IGZ1bmN0aW9uIChkaWdpdHMsIGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX0RJR0lUUywgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKSwKICAgICAgZGlnaXRzOiBkaWdpdHMKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaG9sZCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuSE9MRF9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLnJlc3VtZSA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUkVTVU1FX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QodGhpcy5fZ2V0RGF0YSgpKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLmdldE1lZGlhSW5mbygpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpLmNhdGNoKGZ1bmN0aW9uICgpIHsgfSk7CiAgICB9CiAgfQoKICAvLyBNZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbiAKICAvLyAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVCAKICAgICAgfHwgY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICB9CgogIC8qKgogICAqIFV0aWxpdHkgbWV0aG9kIGZvciBjaGVja2luZyB3aGV0aGVyIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24gCiAgICogKHR5cGUgQUdFTlQgb3IgTU9OSVRPUklORykKICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24uIEZhbHNlIG90aGVyd2lzZS4KICAgKi8KICBDb25uZWN0aW9uLnByb3RvdHlwZS5faXNBZ2VudENvbm5lY3Rpb25UeXBlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm5lY3Rpb25UeXBlID0gdGhpcy5nZXRUeXBlKCk7CiAgICByZXR1cm4gY29ubmVjdGlvblR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgCiAgICAgIHx8IGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLk1PTklUT1JJTkc7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIENvbnRhY3QgcmVjb3JkaW5nCiAgKi8KICAKICB2YXIgQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHRoaXMuY29udGFjdElkID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoY29udGFjdElkKSA/IGNvbnRhY3RJZCA6IG51bGw7CiAgfQoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5zdGFydENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbih0cmFja0NvbmZpZykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCwgY29udGFjdERhdGE7CgogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCk7CiAgICB2YXIgcmVjb3JkaW5nVHJhY2sgPSAodHJhY2tDb25maWcgJiYgT2JqZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnKS5pbmNsdWRlcyh0cmFja0NvbmZpZykpID8gdHJhY2tDb25maWcgOiBjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnLkFMTDsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNUQVJUX0NPTlRBQ1RfUkVDT1JESU5HLCB7CiAgICAgICAgImluaXRpYWxDb250YWN0SWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHNlbGYuY29udGFjdElkLAogICAgICAgICJjb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiaW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAidm9pY2VSZWNvcmRpbmdDb25maWd1cmF0aW9uIjogewogICAgICAgICAgInZvaWNlUmVjb3JkaW5nVHJhY2siOiByZWNvcmRpbmdUcmFjawogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN0YXJ0Q29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Q29udGFjdFJlY29yZGluZyBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnIsCiAgICAgICAgICAgICAgZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigic3RhcnRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIsIHsgY2F1c2U6IGVyciB9KSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5zdG9wQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCwgY29udGFjdERhdGE7CgogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5TVE9QX0NPTlRBQ1RfUkVDT1JESU5HLCB7CiAgICAgICAgImluaXRpYWxDb250YWN0SWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHNlbGYuY29udGFjdElkLAogICAgICAgICJjb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiaW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygic3RvcENvbnRhY3RSZWNvcmRpbmcgc3VjY2VlZGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdG9wQ29udGFjdFJlY29yZGluZyBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnIsCiAgICAgICAgICAgICAgZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigic3RvcENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIiwgeyBjYXVzZTogZXJyIH0pKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH07CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNVU1BFTkRfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJzdXNwZW5kQ29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdXNwZW5kQ29udGFjdFJlY29yZGluZyBmYWlsZWQiLCB7IGNhdXNlOiBlcnIgfSkpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKCiAgQ29udGFjdFJlY29yZGluZy5wcm90b3R5cGUucmVzdW1lQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCwgY29udGFjdERhdGE7CgogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5SRVNVTUVfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigicmVzdW1lQ29udGFjdFJlY29yZGluZyBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnIsCiAgICAgICAgICAgICAgZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigicmVzdW1lQ29udGFjdFJlY29yZGluZyBmYWlsZWQiKSwgeyBjYXVzZTogZXJyIH0pOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKICAKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFZvaWNlIGF1dGhlbnRpY2F0b3IgVm9pY2VJZAogICovCiAKICB2YXIgVm9pY2VJZCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHRoaXMuY29udGFjdElkID0gY29udGFjdElkOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmdldFNwZWFrZXJJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkdFVF9DT05UQUNULCB7CiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJhd3NBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKQogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuY29udGFjdERhdGEuY3VzdG9tZXJJZCkgewogICAgICAgICAgICAgIHZhciBvYmogPSB7CiAgICAgICAgICAgICAgICBzcGVha2VySWQ6IGRhdGEuY29udGFjdERhdGEuY3VzdG9tZXJJZAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFNwZWFrZXJJZCBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVzb2x2ZShvYmopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuTk9fU1BFQUtFUl9JRF9GT1VORCwgIk5vIHNwZWFrZXJJZCBhc3NvdGlhdGVkIHdpdGggdGhpcyBjYWxsIik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkdldCBTcGVha2VySWQgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX1NQRUFLRVJfSURfRkFJTEVELCAiR2V0IFNwZWFrZXJJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0U3BlYWtlclN0YXR1cyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlcklkKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuREVTQ1JJQkVfU1BFQUtFUiwgewogICAgICAgICAgICAiU3BlYWtlcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGRhdGEuc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0U3BlYWtlclN0YXR1cyBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgICAgdmFyIGVycm9yOwogICAgICAgICAgICAgICAgdmFyIHBhcnNlZEVyciA9IEpTT04ucGFyc2UoZXJyKTsKICAgICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgNDAwOgogICAgICAgICAgICAgICAgICBjYXNlIDQwNDoKICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHBhcnNlZEVycjsKICAgICAgICAgICAgICAgICAgICBkYXRhLnR5cGUgPSBkYXRhLnR5cGUgPyBkYXRhLnR5cGUgOiBjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNQRUFLRVJfSURfTk9UX0VOUk9MTEVEOwogICAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiU3BlYWtlciBpcyBub3QgZW5yb2xsZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldFNwZWFrZXJTdGF0dXMgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfU1BFQUtFUl9TVEFUVVNfRkFJTEVELCAiR2V0IFNwZWFrZXJTdGF0dXMgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyBpbnRlcm5hbCBvbmx5CiAgVm9pY2VJZC5wcm90b3R5cGUuX29wdE91dFNwZWFrZXJJbkxjbXMgPSBmdW5jdGlvbiAoc3BlYWtlcklkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1ZPSUNFX0lEX0RBVEEsIHsKICAgICAgICAiQ29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgIkFXU0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpLAogICAgICAgICJDdXN0b21lcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICJWb2ljZUlkUmVzdWx0IjogewogICAgICAgICAgIlNwZWFrZXJPcHRlZE91dCI6IHRydWUKICAgICAgICB9CiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJvcHRPdXRTcGVha2VySW5MY21zIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIm9wdE91dFNwZWFrZXJJbkxjbXMgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuT1BUX09VVF9TUEVBS0VSX0lOX0xDTVNfRkFJTEVELCAib3B0T3V0U3BlYWtlckluTGNtcyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5vcHRPdXRTcGVha2VyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICB2YXIgc3BlYWtlcklkID0gZGF0YS5zcGVha2VySWQ7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5PUFRfT1VUX1NQRUFLRVIsIHsKICAgICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgc2VsZi5fb3B0T3V0U3BlYWtlckluTGNtcyhzcGVha2VySWQpLmNhdGNoKGZ1bmN0aW9uKCl7fSk7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIm9wdE91dFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfRkFJTEVELCAib3B0T3V0U3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlbGV0ZVNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFTEVURV9TUEVBS0VSLCB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJkZWxldGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJkZWxldGVTcGVha2VyIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuREVMRVRFX1NQRUFLRVJfRkFJTEVELCAiZGVsZXRlU3BlYWtlciBmYWlsZWQuIiwgZXJyKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLnN0YXJ0U2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuU1RBUlRfVk9JQ0VfSURfU0VTU0lPTiwgewogICAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgICAiY3VzdG9tZXJBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAgICJjbGllbnRUb2tlbiI6IEFXUy51dGlsLnV1aWQudjQoKSwKICAgICAgICAgICJkb21haW5JZCIgOiBkb21haW5JZAogICAgICAgICAgfSwgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGlmKGRhdGEuc2Vzc2lvbklkKSB7CiAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCwgbm8gc2Vzc2lvbiBpZCByZXR1cm5lZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNUQVJUX1NFU1NJT05fRkFJTEVELCAiTm8gc2Vzc2lvbiBpZCByZXR1cm5lZCBmcm9tIHN0YXJ0IHNlc3Npb24gYXBpIik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TVEFSVF9TRVNTSU9OX0ZBSUxFRCwgInN0YXJ0Vm9pY2VJZFNlc3Npb24gZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuZXZhbHVhdGVTcGVha2VyID0gZnVuY3Rpb24gKHN0YXJ0TmV3KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICB2YXIgcG9sbFRpbWVzID0gMDsgCiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBldmFsdWF0ZSgpIHsKICAgICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuRVZBTFVBVEVfU0VTU0lPTiwgewogICAgICAgICAgICAiU2Vzc2lvbk5hbWVPcklkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICB9LCB7CiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgaWYoKytwb2xsVGltZXMgPCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9NQVhfUE9MTF9USU1FUykgewogICAgICAgICAgICAgICAgaWYoZGF0YS5TdHJlYW1pbmdTdGF0dXMgPT09IGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cy5QRU5ESU5HX0NPTkZJR1VSQVRJT04pIHsKICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZighZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQgPSB7fTsKICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZSBpZiBib3RoIGF1dGhlbnRpY2F0aW9uIGFuZCBmcmF1ZCBkZXRlY3Rpb24gYXJlIG5vdCBlbmFibGVkLgogICAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhFbmFibGVkKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmIAogICAgICAgICAgICAgICAgICAgICFzZWxmLmlzRnJhdWRFbmFibGVkKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZihkYXRhLlN0cmVhbWluZ1N0YXR1cyA9PT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNGcmF1ZFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gVm9pY2UgcHJpbnQgaXMgbm90IGxvbmcgZW5vdWdoIGZvciBib3RoIGF1dGhlbnRpY2F0aW9uIGFuZCBmcmF1ZCBkZXRlY3Rpb24KICAgICAgICAgICAgICAgICAgaWYoc2VsZi5pc0F1dGhSZXN1bHRJbmNvbmNsdXNpdmUoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRSZXN1bHRJbmNvbmNsdXNpdmUoZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZXZhbHVhdGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJiAKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5BQ0NFUFQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5SRUpFQ1Q6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfQVVUSEVOVElDQVRFRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uU1BFQUtFUl9PUFRFRF9PVVQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5PUFRFRF9PVVQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlNQRUFLRVJfTk9UX0VOUk9MTEVEOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOUk9MTEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikgJiYgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pc0ZyYXVkRW5hYmxlZChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkhJR0hfUklTSzoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkhJR0hfUklTSzsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTE9XX1JJU0s6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uRVJST1I7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICAhc2VsZi5pc0ZyYXVkUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlIG9ubHkgd2hlbiBib3RoIGF1dGhlbnRpY2F0aW9uIGFuZCBmcmF1ZCBkZXRlY3Rpb24gaGF2ZSByZXN1bHRzLiBPdGhlcndpc2UsIGtlZXAgcG9sbGluZy4KICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZXZhbHVhdGVTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZXZhbHVhdGVTcGVha2VyIHRpbWVvdXQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5FVkFMVUFURV9TUEVBS0VSX1RJTUVPVVQsICJldmFsdWF0ZVNwZWFrZXIgdGltZW91dCIpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgdmFyIHBhcnNlZEVyciA9IEpTT04ucGFyc2UoZXJyKTsKICAgICAgICAgICAgICBzd2l0Y2gocGFyc2VkRXJyLnN0YXR1cykgewogICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICBjYXNlIDQwNDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlNFU1NJT05fTk9UX0VYSVNUUywgImV2YWx1YXRlU3BlYWtlciBmYWlsZWQsIHNlc3Npb24gbm90IGV4aXN0cyIsIGVycik7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciBmYWlsZWQsIHNlc3Npb24gbm90IGV4aXN0cyIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5FVkFMVUFURV9TUEVBS0VSX0ZBSUxFRCwgImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJldmFsdWF0ZVNwZWFrZXIgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7ICAgIAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgCiAgICAgIGlmKCFzdGFydE5ldykgewogICAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgZXZhbHVhdGUoKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzeW5jU3BlYWtlcklkIGZhaWxlZCB3aGVuIHNlc3Npb24gc3RhcnROZXc9ZmFsc2UiKQogICAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pCiAgICAgIH0gZWxzZSB7IAogICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRFX1NFU1NJT05fREVMQVkpOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN5bmNTcGVha2VySWQgZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz10cnVlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRTZXNzaW9uIGZhaWxlZCB3aGVuIHNlc3Npb24gc3RhcnROZXc9dHJ1ZSIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChlcnIpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlc2NyaWJlU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkRFU0NSSUJFX1NFU1NJT04sIHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKQogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkRFU0NSSUJFX1NFU1NJT05fRkFJTEVELCAiZGVzY3JpYmVTZXNzaW9uIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuY2hlY2tFbnJvbGxtZW50U3RhdHVzID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBvbGxpbmdUaW1lcyA9IDA7CiAgICB2YXIgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSBmYWxzZTsKCiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBkZXNjcmliZSAoKSB7CiAgICAgICAgaWYoKytwb2xsaW5nVGltZXMgPCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRU5ST0xMTUVOVF9NQVhfUE9MTF9USU1FUykgewogICAgICAgICAgc2VsZi5kZXNjcmliZVNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICBzd2l0Y2goZGF0YS5TZXNzaW9uLkVucm9sbG1lbnRSZXF1ZXN0RGV0YWlscy5TdGF0dXMpIHsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLkNPTVBMRVRFRDoKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLklOX1BST0dSRVNTOgogICAgICAgICAgICAgICAgaWYgKCFjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGVIYXNCZWVuSW52b2tlZCAmJiB0eXBlb2YgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlSGFzQmVlbkludm9rZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2V0VGltZW91dChkZXNjcmliZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEVucm9sbG1lbnRSZXF1ZXN0U3RhdHVzLk5PVF9FTk9VR0hfU1BFRUNIOgogICAgICAgICAgICAgICAgaWYoZGF0YS5TZXNzaW9uLlN0cmVhbWluZ1N0YXR1cyAhPT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLkVOREVEKSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZGVzY3JpYmUsY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVOUk9MTE1FTlRfUE9MTElOR19JTlRFUlZBTCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaWJlKCk7CiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9LCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuU1RBUlRfU0VTU0lPTl9ERUxBWSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgPyBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLk1lc3NhZ2UgOiAiZW5yb2xsU3BlYWtlciBmYWlsZWQuIFVua25vd24gZW5yb2xsbWVudCBzdGF0dXMgaGFzIGJlZW4gcmVjZWl2ZWQiOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihtZXNzYWdlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogIAkJICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCBtZXNzYWdlLCBkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLlN0YXR1cyk7CiAgCQkgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVOUk9MTF9TUEVBS0VSX1RJTUVPVVQsICJlbnJvbGxTcGVha2VyIHRpbWVvdXQiKTsKICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlc2NyaWJlKCk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5lbnJvbGxTcGVha2VyID0gZnVuY3Rpb24gKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuc3luY1NwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5nZXRTcGVha2VyU3RhdHVzKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBpZihkYXRhLlNwZWFrZXIgJiYgZGF0YS5TcGVha2VyLlN0YXR1cyA9PSBjb25uZWN0LlZvaWNlSWRTcGVha2VyU3RhdHVzLk9QVEVEX09VVCkgewogICAgICAgICAgICBzZWxmLmRlbGV0ZVNwZWFrZXIoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuZW5yb2xsU3BlYWtlckhlbHBlcihyZXNvbHZlLCByZWplY3QsIGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKQogICAgICB9KQogICAgfSkKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmVucm9sbFNwZWFrZXJIZWxwZXIgPSBmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0LCBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FTlJPTExfQllfU0VTU0lPTiwgewogICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5DT01QTEVURUQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5jaGVja0Vucm9sbG1lbnRTdGF0dXMoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJlbnJvbGxTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCAiZW5yb2xsU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHJlamVjdChlcnIpOwogICAgfSk7CiAgfTsKCiAgLy8gaW50ZXJuYWwgb25seQogIFZvaWNlSWQucHJvdG90eXBlLl91cGRhdGVTcGVha2VySWRJbkxjbXMgPSBmdW5jdGlvbiAoc3BlYWtlcklkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1ZPSUNFX0lEX0RBVEEsIHsKICAgICAgICAiQ29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgIkFXU0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpLAogICAgICAgICJDdXN0b21lcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICJWb2ljZUlkUmVzdWx0IjogewogICAgICAgICAgImdlbmVyYXRlZFNwZWFrZXJJZCI6IHNwZWFrZXJJZAogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInVwZGF0ZVNwZWFrZXJJZEluTGNtcyBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5MY21zIGZhaWxlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5VUERBVEVfU1BFQUtFUl9JRF9JTl9MQ01TX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluTGNtcyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS51cGRhdGVTcGVha2VySWRJblZvaWNlSWQgPSBmdW5jdGlvbiAoc3BlYWtlcklkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlVQREFURV9TRVNTSU9OLCB7CiAgICAgICAgICAiU2Vzc2lvbk5hbWVPcklkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3BlYWtlcklkLCAnc3BlYWtlcklkJyksCiAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlU3BlYWtlcklkSW5MY21zKHNwZWFrZXJJZCkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7ICAgIAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuc3luY1NwZWFrZXJJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYuZ2V0U3BlYWtlcklkKCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICBzZWxmLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZChkYXRhLnNwZWFrZXJJZCkudGhlbihmdW5jdGlvbihkYXRhKXsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pCiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5nZXREb21haW5JZCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29uc3QgYWdlbnQgPSBuZXcgY29ubmVjdC5BZ2VudCgpOwogICAgICBpZiAoIWFnZW50LmdldFBlcm1pc3Npb25zKCkuaW5jbHVkZXMoY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zLlZPSUNFX0lEKSkgewogICAgICAgIHJlamVjdChuZXcgRXJyb3IoIkFnZW50IGRvZXNuJ3QgaGF2ZSB0aGUgcGVybWlzc2lvbiBmb3IgVm9pY2UgSUQiKSk7CiAgICAgIH0gZWxzZSBpZiAoY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCkgewogICAgICAgIHJlc29sdmUoY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5MSVNUX0lOVEVHUkFUSU9OX0FTU09DSUFUSU9OUywgewogICAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgICAiSW50ZWdyYXRpb25UeXBlIjogIlZPSUNFX0lEIgogICAgICAgIH0sIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGRvbWFpbklkOwogICAgICAgICAgICAgIGlmIChkYXRhLkludGVncmF0aW9uQXNzb2NpYXRpb25TdW1tYXJ5TGlzdC5sZW5ndGggPj0gMSkgewogICAgICAgICAgICAgICAgdmFyIGludGVncmF0aW9uQXJuID0gZGF0YS5JbnRlZ3JhdGlvbkFzc29jaWF0aW9uU3VtbWFyeUxpc3RbMF0uSW50ZWdyYXRpb25Bcm47CiAgICAgICAgICAgICAgICBkb21haW5JZCA9IGludGVncmF0aW9uQXJuLnJlcGxhY2UoL14uKmRvbWFpblwvL2ksICcnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkb21haW5JZCkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXREb21haW5JZDogbm8gZG9tYWluSWQgZm91bmQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5OT19ET01BSU5fSURfRk9VTkQpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXREb21haW5JZCBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuVm9pY2VJZEV2ZW50cy5VUERBVEVfRE9NQUlOX0lELAogICAgICAgICAgICAgICAgZGF0YTogeyBkb21haW5JZDogZG9tYWluSWQgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlc29sdmUoZG9tYWluSWQpOwogICAgICAgICAgICB9IGNhdGNoKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldERvbWFpbklkIGZhaWxlZCIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuR0VUX0RPTUFJTl9JRF9GQUlMRUQsICJnZXREb21haW5JZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldERvbWFpbklkIGZhaWxlZCIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9ET01BSU5fSURfRkFJTEVELCAiZ2V0RG9tYWluSWQgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5jaGVja0NvbmZlcmVuY2VDYWxsID0gZnVuY3Rpb24oKXsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBpc0NvbmZlcmVuY2VDYWxsID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoc2VsZi5jb250YWN0SWQpLmNvbm5lY3Rpb25zLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgY29ubi5zdGF0ZS50eXBlKTsKICAgIH0pLmxlbmd0aCA+IDI7CiAgICBpZihpc0NvbmZlcmVuY2VDYWxsKXsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigiVm9pY2VJZCBpcyBub3Qgc3VwcG9ydGVkIGZvciBjb25mZXJlbmNlIGNhbGxzIik7CiAgICB9CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhFbmFibGVkID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgIT09IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgPT09IGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOT1VHSF9TUEVFQ0g7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0F1dGhSZXN1bHRJbmNvbmNsdXNpdmUgPSBmdW5jdGlvbihhdXRoUmVzdWx0KSB7CiAgICByZXR1cm4gYXV0aFJlc3VsdCA9PT0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZEVuYWJsZWQgPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ICE9PSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2ggPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ID09PSBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTk9VR0hfU1BFRUNIOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNGcmF1ZFJlc3VsdEluY29uY2x1c2l2ZSA9IGZ1bmN0aW9uKGZyYXVkUmVzdWx0KSB7CiAgICByZXR1cm4gZnJhdWRSZXN1bHQgPT09IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICB9CgogIC8qKgogICAqIEBjbGFzcyBWb2ljZUNvbm5lY3Rpb24KICAgKiBAcGFyYW0ge251bWJlcn0gY29udGFjdElkIAogICAqIEBwYXJhbSB7bnVtYmVyfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIC0gUHJvdmlkZXMgdm9pY2UgbWVkaWEgc3BlY2lmaWMgb3BlcmF0aW9ucwogICAqLwogIHZhciBWb2ljZUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoY29udGFjdElkLCBjb25uZWN0aW9uSWQpIHsKICAgIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yID0gbmV3IFZvaWNlSWQoY29udGFjdElkKTsKICAgIHRoaXMuX2NvbnRhY3RSZWNvcmRlciA9IG5ldyBDb250YWN0UmVjb3JkaW5nKGNvbnRhY3RJZCk7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVm9pY2VDb25uZWN0aW9uOwoKICAvKioKICAqIEBkZXByZWNhdGVkCiAgKiBQbGVhc2UgdXNlIGdldE1lZGlhSW5mbyAKICAqLwogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U29mdHBob25lTWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zb2Z0cGhvbmVNZWRpYUluZm87CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnNvZnRwaG9uZU1lZGlhSW5mbzsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5TT0ZUUEhPTkU7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldFZvaWNlSWRTcGVha2VySWQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5nZXRTcGVha2VySWQoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Vm9pY2VJZFNwZWFrZXJTdGF0dXMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5nZXRTcGVha2VyU3RhdHVzKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLm9wdE91dFZvaWNlSWRTcGVha2VyID0gZnVuY3Rpb24oKSB7CiAgICAKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5vcHRPdXRTcGVha2VyKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmRlbGV0ZVZvaWNlSWRTcGVha2VyID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZGVsZXRlU3BlYWtlcigpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5ldmFsdWF0ZVNwZWFrZXJXaXRoVm9pY2VJZCA9IGZ1bmN0aW9uKHN0YXJ0TmV3KSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZXZhbHVhdGVTcGVha2VyKHN0YXJ0TmV3KTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZW5yb2xsU3BlYWtlckluVm9pY2VJZCA9IGZ1bmN0aW9uKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmVucm9sbFNwZWFrZXIoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUudXBkYXRlVm9pY2VJZFNwZWFrZXJJZCA9IGZ1bmN0aW9uKHNwZWFrZXJJZCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZChzcGVha2VySWQpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRRdWlja0Nvbm5lY3ROYW1lID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWlja0Nvbm5lY3ROYW1lOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TW9uaXRvclN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5tb25pdG9yU3RhdGU7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNb25pdG9yQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5tb25pdG9yQ2FwYWJpbGl0aWVzOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNNdXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5tdXRlOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNGb3JjZWRNdXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5mb3JjZWRNdXRlOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUubXV0ZVBhcnRpY2lwYW50ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5NVVRFX1BBUlRJQ0lQQU5ULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUudW5tdXRlUGFydGljaXBhbnQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVOTVVURV9QQVJUSUNJUEFOVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnN0YXJ0Q29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN0YXJ0Q29udGFjdFJlY29yZGluZygpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdG9wQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN0b3BDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHJldHVybiB0aGlzLl9jb250YWN0UmVjb3JkZXIuc3VzcGVuZENvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUucmVzdW1lQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnJlc3VtZUNvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuY2hlY2tDb25mZXJlbmNlQ2FsbCA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgaXNDb25mZXJlbmNlQ2FsbCA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKS5jb25uZWN0aW9ucy5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuY29udGFpbnMoY29ubmVjdC5DT05ORUNUSU9OX0FDVElWRV9TVEFURVMsIGNvbm4uc3RhdGUudHlwZSk7CiAgICB9KS5sZW5ndGggPiAyOwogICAgaWYoaXNDb25mZXJlbmNlQ2FsbCl7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoIlZvaWNlSWQgYW5kIENvbnRhY3QgUmVjb3JkaW5nIGFyZSBub3Qgc3VwcG9ydGVkIGZvciBjb25mZXJlbmNlIGNhbGxzIik7CiAgICB9CiAgfQoKICAvKioKICAgKiBAY2xhc3MgQ2hhdENvbm5lY3Rpb24KICAgKiBAcGFyYW0geyp9IGNvbnRhY3RJZCAKICAgKiBAcGFyYW0geyp9IGNvbm5lY3Rpb25JZCAKICAgKiBAZGVzY3JpcHRpb24gYWRkcyB0aGUgY2hhdCBtZWRpYSBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5CiAgICovCiAgdmFyIENoYXRDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENoYXRDb25uZWN0aW9uOwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGRhdGEgPSB0aGlzLl9nZXREYXRhKCkuY2hhdE1lZGlhSW5mbzsKICAgIGlmICghZGF0YSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgICAgdmFyIG1lZGlhT2JqZWN0ID0gewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgICBnZXRDb25uZWN0aW9uVG9rZW46IGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5nZXRDb25uZWN0aW9uVG9rZW4pCiAgICAgIH07CiAgICAgIGlmIChkYXRhLmNvbm5lY3Rpb25EYXRhKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBKU09OLnBhcnNlKGRhdGEuY29ubmVjdGlvbkRhdGEpLkNvbm5lY3Rpb25BdXRoZW50aWNhdGlvblRva2VuOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVCwgIkNvbm5lY3Rpb24gZGF0YSBpcyBpbnZhbGlkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gfHwgbnVsbDsKICAgICAgLyoqIEp1c3QgdG8ga2VlcCB0aGUgZGF0YSBhY2Nlc3NpYmxlICovCiAgICAgIG1lZGlhT2JqZWN0Lm9yaWdpbmFsSW5mbyA9IHRoaXMuX2dldERhdGEoKS5jaGF0TWVkaWFJbmZvOwogICAgICByZXR1cm4gbWVkaWFPYmplY3Q7CiAgICB9CiAgfTsKCiAgLyoqCiAgKiBQcm92aWRlcyB0aGUgY2hhdCBjb25uZWN0aW9uVG9rZW4gdGhyb3VnaCB0aGUgY3JlYXRlX3RyYW5zcG9ydCBBUEkgZm9yIGEgc3BlY2lmaWMgY29udGFjdCBhbmQgcGFydGljaXBhbnQgSWQuIAogICogQHJldHVybnMgYSBwcm9taXNlIHdoaWNoLCB1cG9uIHN1Y2Nlc3MsIHJldHVybnMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNyZWF0ZVRyYW5zcG9ydCBBUEkuCiAgKiBVc2FnZToKICAqIGNvbm5lY3Rpb24uZ2V0Q29ubmVjdGlvblRva2VuKCkKICAqICAudGhlbihyZXNwb25zZSA9PiB7fSkKICAqICAuY2F0Y2goZXJyb3IgPT4ge30pCiAgKi8KICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvblRva2VuID0gZnVuY3Rpb24gKCkgewogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgdmFyIHRyYW5zcG9ydERldGFpbHMgPSB7CiAgICAgIHRyYW5zcG9ydFR5cGU6IGNvbm5lY3QuVFJBTlNQT1JUX1RZUEVTLkNIQVRfVE9LRU4sCiAgICAgIHBhcnRpY2lwYW50SWQ6IHRoaXMuY29ubmVjdGlvbklkLAogICAgICBjb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQKICAgIH07CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQ1JFQVRFX1RSQU5TUE9SVCwgdHJhbnNwb3J0RGV0YWlscywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldENvbm5lY3Rpb25Ub2tlbiBzdWNjZWVkZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImdldENvbm5lY3Rpb25Ub2tlbiBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJnZXRDb25uZWN0aW9uVG9rZW4gZmFpbGVkIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLkNIQVQ7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuX2luaXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBOb3RlIHRoYXQgYSBjaGF0IG1lZGlhIGNvbnRyb2xsZXIgb25seSBuZWVkcyB0byBiZSBwcm9kdWNlZCBmb3IgYWdlbnQgdHlwZSBjb25uZWN0aW9ucy4KICAgIGlmICh0aGlzLl9pc0FnZW50Q29ubmVjdGlvblR5cGUoKSkgewogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKS5jYXRjaChmdW5jdGlvbiAoKSB7IH0pOwogICAgfQogIH0KCiAgLyoqCiAgICogQGNsYXNzIFRhc2tDb25uZWN0aW9uCiAgICogQHBhcmFtIHsqfSBjb250YWN0SWQgCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQgCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIHRhc2sgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBUYXNrQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tDb25uZWN0aW9uOwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuTWVkaWFUeXBlLlRBU0s7CiAgfQoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgIH07CiAgICAgIHJldHVybiBtZWRpYU9iamVjdDsKICB9OwoKICBUYXNrQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb25TbmFwc2hvdAogICAqLwogIHZhciBDb25uZWN0aW9uU25hcHNob3QgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIGNvbm5lY3QuQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbm5lY3Rpb25EYXRhLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIHRoaXMuY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0aW9uRGF0YTsKICB9OwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ29ubmVjdGlvblNuYXBzaG90OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbkRhdGE7CiAgfTsKCiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZS5faW5pdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgdmFyIEVuZHBvaW50ID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICB0aGlzLmVuZHBvaW50QVJOID0gcGFyYW1zLmVuZHBvaW50SWQgfHwgcGFyYW1zLmVuZHBvaW50QVJOIHx8IG51bGw7CiAgICB0aGlzLmVuZHBvaW50SWQgPSB0aGlzLmVuZHBvaW50QVJOOwogICAgdGhpcy50eXBlID0gcGFyYW1zLnR5cGUgfHwgbnVsbDsKICAgIHRoaXMubmFtZSA9IHBhcmFtcy5uYW1lIHx8IG51bGw7CiAgICB0aGlzLnBob25lTnVtYmVyID0gcGFyYW1zLnBob25lTnVtYmVyIHx8IG51bGw7CiAgICB0aGlzLmFnZW50TG9naW4gPSBwYXJhbXMuYWdlbnRMb2dpbiB8fCBudWxsOwogICAgdGhpcy5xdWV1ZSA9IHBhcmFtcy5xdWV1ZSB8fCBudWxsOwogIH07CgogIC8qKgogICAqIFN0cmlwIHRoZSBTSVAgZW5kcG9pbnQgY29tcG9uZW50cyBmcm9tIHRoZSBwaG9uZU51bWJlciBmaWVsZC4KICAgKi8KICBFbmRwb2ludC5wcm90b3R5cGUuc3RyaXBQaG9uZU51bWJlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnBob25lTnVtYmVyID8gdGhpcy5waG9uZU51bWJlci5yZXBsYWNlKC9zaXA6KFteQF0qKUAuKi8sICIkMSIpIDogIiI7CiAgfTsKCiAgLyoqCiAgICogQ3JlYXRlIGFuIEVuZHBvaW50IG9iamVjdCBmcm9tIHRoZSBnaXZlbiBwaG9uZSBudW1iZXIgYW5kIG5hbWUuCiAgICovCiAgRW5kcG9pbnQuYnlQaG9uZU51bWJlciA9IGZ1bmN0aW9uIChudW1iZXIsIG5hbWUpIHsKICAgIHJldHVybiBuZXcgRW5kcG9pbnQoewogICAgICB0eXBlOiBjb25uZWN0LkVuZHBvaW50VHlwZS5QSE9ORV9OVU1CRVIsCiAgICAgIHBob25lTnVtYmVyOiBudW1iZXIsCiAgICAgIG5hbWU6IG5hbWUgfHwgbnVsbAogICAgfSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgU29mdHBob25lRXJyb3IKICAgKi8KICB2YXIgU29mdHBob25lRXJyb3IgPSBmdW5jdGlvbiAoZXJyb3JUeXBlLCBlcnJvck1lc3NhZ2UsIGVuZFBvaW50VXJsKSB7CiAgICB0aGlzLmVycm9yVHlwZSA9IGVycm9yVHlwZTsKICAgIHRoaXMuZXJyb3JNZXNzYWdlID0gZXJyb3JNZXNzYWdlOwogICAgdGhpcy5lbmRQb2ludFVybCA9IGVuZFBvaW50VXJsOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yVHlwZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFcnJvck1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lcnJvck1lc3NhZ2U7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RW5kUG9pbnRVcmwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5lbmRQb2ludFVybDsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSb290IFN1YnNjcmlwdGlvbiBBUElzLgogICAqLwogIGNvbm5lY3QuYWdlbnQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgdmFyIHN1YiA9IGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5JTklULCBmKTsKICAgIGlmIChjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIGYobmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CiAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwoKICBjb25uZWN0LmNvbnRhY3QgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgcmV0dXJuIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOSVQsIGYpOwogIH07CgogIGNvbm5lY3Qub25XZWJzb2NrZXRJbml0RmFpbHVyZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGYpOwogICAgaWYgKGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCkgewogICAgICBmKCk7CiAgICB9CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFN0YXJ0cyB0aGUgZ2l2ZW4gZnVuY3Rpb24gYXN5bmNocm9ub3VzbHkgb25seSBpZiB0aGUgc2hhcmVkIHdvcmtlcgogICAqIHNheXMgd2UgYXJlIHRoZSBtYXN0ZXIgZm9yIHRoZSBnaXZlbiB0b3BpYy4gIElmIHRoZXJlIGlzIG5vIG1hc3RlciBmb3IKICAgKiB0aGUgZ2l2ZW4gdG9waWMsIHdlIGJlY29tZSB0aGUgbWFzdGVyIGFuZCBzdGFydCB0aGUgZnVuY3Rpb24gdW5sZXNzCiAgICogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIGlzIHRydWUuCiAgICoKICAgKiBAcGFyYW0gdG9waWMgVGhlIG1hc3RlciB0b3BpYyB3ZSBhcmUgY29uY2VybmVkIGFib3V0LgogICAqIEBwYXJhbSBmX3RydWUgVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgaWYgd2UgYXJlIHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIGZfZWxzZSBbb3B0aW9uYWxdIEEgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgbm90IHRoZSBtYXN0ZXIuCiAgICogQHBhcmFtIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSBbb3B0aW9uYWxdIGlmIHRydWUsIHRoaXMgdGFiIHdvbid0IGJlY29tZSBtYXN0ZXIuCiAgICovCiAgY29ubmVjdC5pZk1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgZl90cnVlLCBmX2Vsc2UsIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZfdHJ1ZSwgIkEgdHJ1ZSBjYWxsYmFjayBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgaWYgKGZfZWxzZSkgewogICAgICAgIGZfZWxzZSgpOwogICAgICB9CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkNIRUNLX01BU1RFUiwgewogICAgICB0b3BpYzogdG9waWMsCiAgICAgIHNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZTogc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lCiAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGlmIChkYXRhLmlzTWFzdGVyKSB7CiAgICAgICAgICAgIGZfdHJ1ZSgpOwoKICAgICAgICAgIH0gZWxzZSBpZiAoZl9lbHNlKSB7CiAgICAgICAgICAgIGZfZWxzZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgfTsKCiAgLyoqCiAgICogTm90aWZ5IHRoZSBzaGFyZWQgd29ya2VyIGFuZCBvdGhlciBDQ1AgdGFicyB0aGF0IHdlIGFyZSBub3cgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLgogICAqLwogIGNvbm5lY3QuYmVjb21lTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAiQSB0b3BpYyBtdXN0IGJlIHByb3ZpZGVkLiIpOwoKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICAvLyBXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBjYW4ndCBiZSB0aGUgbWFzdGVyIGZvciB0b3BpYyAnJXMnIGJlY2F1c2UgdGhlcmUgaXMgbm8gbWFzdGVyIGNsaWVudCEiLCB0b3BpYyk7CiAgICAgIGlmIChmYWlsdXJlQ2FsbGJhY2spIHsKICAgICAgICBmYWlsdXJlQ2FsbGJhY2soKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIG1hc3RlckNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQoKTsKICAgICAgbWFzdGVyQ2xpZW50LmNhbGwoY29ubmVjdC5NYXN0ZXJNZXRob2RzLkJFQ09NRV9NQVNURVIsIHsKICAgICAgICB0b3BpYzogdG9waWMKICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChzdWNjZXNzQ2FsbGJhY2spIHsKICAgICAgICAgICAgc3VjY2Vzc0NhbGxiYWNrKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICBjb25uZWN0LkFnZW50ID0gQWdlbnQ7CiAgY29ubmVjdC5BZ2VudFNuYXBzaG90ID0gQWdlbnRTbmFwc2hvdDsKICBjb25uZWN0LkNvbnRhY3QgPSBDb250YWN0OwogIGNvbm5lY3QuQ29udGFjdFNuYXBzaG90ID0gQ29udGFjdFNuYXBzaG90OwogIC8qKiBEZWZhdWx0IHdpbGwgZ2V0IHRoZSBWb2ljZSBjb25uZWN0aW9uICovCiAgY29ubmVjdC5Db25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQmFzZUNvbm5lY3Rpb24gPSBDb25uZWN0aW9uOwogIGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uID0gVm9pY2VDb25uZWN0aW9uOwogIGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24gPSBDaGF0Q29ubmVjdGlvbjsKICBjb25uZWN0LlRhc2tDb25uZWN0aW9uID0gVGFza0Nvbm5lY3Rpb247CiAgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QgPSBDb25uZWN0aW9uU25hcHNob3Q7CiAgY29ubmVjdC5FbmRwb2ludCA9IEVuZHBvaW50OwogIGNvbm5lY3QuQWRkcmVzcyA9IEVuZHBvaW50OwogIGNvbm5lY3QuU29mdHBob25lRXJyb3IgPSBTb2Z0cGhvbmVFcnJvcjsKICBjb25uZWN0LlZvaWNlSWQgPSBWb2ljZUlkOwogIGNvbm5lY3QuQ29udGFjdFJlY29yZGluZyA9IENvbnRhY3RSZWNvcmRpbmc7Cn0pKCk7CgoKCi8qKiovIH0pLAoKLyoqKi8gODI3OgovKioqLyAoKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgPT4gewoKdmFyIF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fOy8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuNTUzLjAKLy8gQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCi8vIExpY2Vuc2UgYXQgaHR0cHM6Ly9zZGsuYW1hem9uYXdzLmNvbS9qcy9CVU5ETEVfTElDRU5TRS50eHQKKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9dW5kZWZpbmVkO2lmKCFmJiZjKXJldHVybiByZXF1aXJlKGksITApO2lmKHUpcmV0dXJuIHUoaSwhMCk7dmFyIGE9bmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIraSsiJyIpO3Rocm93IGEuY29kZT0iTU9EVUxFX05PVF9GT1VORCIsYX12YXIgcD1uW2ldPXtleHBvcnRzOnt9fTtlW2ldWzBdLmNhbGwocC5leHBvcnRzLGZ1bmN0aW9uKHIpe3ZhciBuPWVbaV1bMV1bcl07cmV0dXJuIG8obnx8cil9LHAscC5leHBvcnRzLHIsZSxuLHQpfXJldHVybiBuW2ldLmV4cG9ydHN9Zm9yKHZhciB1PXVuZGVmaW5lZCxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkoezE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTQtMDYtMzAiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29nbml0by1pZGVudGl0eSIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjEiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlRnVsbE5hbWUiOiAiQW1hem9uIENvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2VydmljZUlkIjogIkNvZ25pdG8gSWRlbnRpdHkiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAgICJ0YXJnZXRQcmVmaXgiOiAiQVdTQ29nbml0b0lkZW50aXR5U2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwIgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQ3JlYXRlSWRlbnRpdHlQb29sIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJPcGVuSWRDb25uZWN0UHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkNvZ25pdG9JZGVudGl0eVByb3ZpZGVycyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJTYW1sUHJvdmlkZXJBUk5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbFRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlbGV0ZUlkZW50aXRpZXMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkc1RvRGVsZXRlIjogewogICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVW5wcm9jZXNzZWRJZGVudGl0eUlkcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAgICAgICAiRXJyb3JDb2RlIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWxldGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkRlc2NyaWJlSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU3UiCiAgICAgICAgfQogICAgICB9LAogICAgICAiRGVzY3JpYmVJZGVudGl0eVBvb2wiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTaiIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJHZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkN1c3RvbVJvbGVBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAgICAgICAgICJTZWNyZXRLZXkiOiB7fSwKICAgICAgICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0SWQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjb3VudElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldElkZW50aXR5UG9vbFJvbGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0T3BlbklkVG9rZW4iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldE9wZW5JZFRva2VuRm9yRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICAgIkxvZ2lucyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlN6IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiVG9rZW5EdXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJNYXhSZXN1bHRzIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAiSGlkZURpc2FibGVkIjogewogICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlN1IgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTGlzdElkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkxpc3RUYWdzRm9yUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTG9va3VwRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyTGlzdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTWVyZ2VEZXZlbG9wZXJJZGVudGl0aWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJTb3VyY2VVc2VySWRlbnRpZmllciIsCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZXRJZGVudGl0eVBvb2xSb2xlcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgICAiUm9sZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxYiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzFkIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVbmxpbmtEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiSWRlbnRpdHlJZCIsCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiLAogICAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJEZXZlbG9wZXJVc2VySWRlbnRpZmllciI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW5saW5rSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIklkZW50aXR5SWQiLAogICAgICAgICAgICAiTG9naW5zIiwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTeiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkxvZ2luc1RvUmVtb3ZlIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVudGFnUmVzb3VyY2UiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fSwKICAgICAgICAgICAgIlRhZ0tleXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlVwZGF0ZUlkZW50aXR5UG9vbCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2oiCiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInNoYXBlIjogIlNqIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTNCI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzgiOiB7CiAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgIH0sCiAgICAgICJTYSI6IHsKICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAgICJDbGllbnRJZCI6IHt9LAogICAgICAgICAgICAiU2VydmVyU2lkZVRva2VuQ2hlY2siOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNmIjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU2ciOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlNqIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIiwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAgICJBbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlN1cHBvcnRlZExvZ2luUHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIkRldmVsb3BlclByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIk9wZW5JZENvbm5lY3RQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgIH0sCiAgICAgICAgICAiQ29nbml0b0lkZW50aXR5UHJvdmlkZXJzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2EiCiAgICAgICAgICB9LAogICAgICAgICAgIlNhbWxQcm92aWRlckFSTnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTZiIKICAgICAgICAgIH0sCiAgICAgICAgICAiSWRlbnRpdHlQb29sVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN1IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlN2IgogICAgICAgICAgfSwKICAgICAgICAgICJDcmVhdGlvbkRhdGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0sCiAgICAgICAgICAiTGFzdE1vZGlmaWVkRGF0ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlN2IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7fQogICAgICB9LAogICAgICAiU3oiOiB7CiAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAia2V5Ijoge30sCiAgICAgICAgInZhbHVlIjoge30KICAgICAgfSwKICAgICAgIlMxYiI6IHsKICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICJrZXkiOiB7fSwKICAgICAgICAidmFsdWUiOiB7fQogICAgICB9LAogICAgICAiUzFkIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJUeXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiVHlwZSI6IHt9LAogICAgICAgICAgICAiQW1iaWd1b3VzUm9sZVJlc29sdXRpb24iOiB7fSwKICAgICAgICAgICAgIlJ1bGVzQ29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJSdWxlcyIKICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIlJ1bGVzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJDbGFpbSIsCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIiwKICAgICAgICAgICAgICAgICAgICAgICJWYWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAiUm9sZUFSTiIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgIkNsYWltIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiVmFsdWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIjoge30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgfSx7fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHM9ewogICAgInBhZ2luYXRpb24iOiB7CiAgICB9CiAgfQogIAogIH0se31dLDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJ2ZXJzaW9uIjogIjIuMCIsCiAgICAibWV0YWRhdGEiOiB7CiAgICAgICJhcGlWZXJzaW9uIjogIjIwMTctMDItMTUiLAogICAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29ubmVjdCIsCiAgICAgICJqc29uVmVyc2lvbiI6ICIxLjAiLAogICAgICAicHJvdG9jb2wiOiAianNvbiIsCiAgICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkNvbm5lY3QiLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFtYXpvbkNvbm5lY3RDVElTZXJ2aWNlIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAiIiwKICAgICAgInRhcmdldFByZWZpeCI6ICJBbWF6b25Db25uZWN0Q1RJU2VydmljZSIsCiAgICAgICJ1aWQiOiAiY29ubmVjdC0yMDE3LTAyLTE1IgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQWNjZXB0Q29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNsZWFyQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbXBsZXRlQ29udGFjdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNvbmZlcmVuY2VDb25uZWN0aW9ucyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiZW5kcG9pbnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlT3V0Ym91bmRDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJlbmRwb2ludCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImVuZHBvaW50IjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInF1ZXVlQVJOIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkNyZWF0ZVRhc2tDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJlbmRwb2ludCIsCiAgICAgICAgICAgICJuYW1lIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicHJldmlvdXNDb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgImRlc2NyaXB0aW9uIjoge30sCiAgICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImlkZW1wb3RlbmN5VG9rZW4iOiB7fSwKICAgICAgICAgICAgInNjaGVkdWxlZFRpbWUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiQ3JlYXRlVHJhbnNwb3J0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJ0cmFuc3BvcnRUeXBlIiwKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidHJhbnNwb3J0VHlwZSI6IHt9LAogICAgICAgICAgICAicGFydGljaXBhbnRJZCI6IHt9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJzb2Z0cGhvbmVDbGllbnRJZCI6IHt9LAogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAid2ViU29ja2V0VHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInVybCIsCiAgICAgICAgICAgICAgICAidHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJ1cmwiOiB7fSwKICAgICAgICAgICAgICAgICJ0cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZXhwaXJ5Ijoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjaGF0VG9rZW5UcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiIsCiAgICAgICAgICAgICAgICAiZXhwaXJ5IgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAicGFydGljaXBhbnRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgImV4cGlyeSI6IHt9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAic29mdHBob25lVHJhbnNwb3J0IjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMiCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSIsCiAgICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCIsCiAgICAgICAgICAgICAgICAgICAgICAidXJscyIKICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInVybHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZXN0cm95Q29ubmVjdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50Q29uZmlndXJhdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiY29uZmlndXJhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMxaCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50UGVybWlzc2lvbnMiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAgICJtYXhSZXN1bHRzIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAicGVybWlzc2lvbnMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJwZXJtaXNzaW9ucyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0QWdlbnRTbmFwc2hvdCI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgInRpbWVvdXQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJzbmFwc2hvdCIsCiAgICAgICAgICAgICJuZXh0VG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJzbmFwc2hvdCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAiY29udGFjdHMiLAogICAgICAgICAgICAgICAgInNuYXBzaG90VGltZXN0YW1wIgogICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTMjAiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm5leHRTdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiYWdlbnRBdmFpbGFiaWxpdHlTdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgInN0YXRlIjoge30sCiAgICAgICAgICAgICAgICAgICAgInRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY29udGFjdHMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIiwKICAgICAgICAgICAgICAgICAgICAgICJhdHRyaWJ1dGVzIgogICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgInF1ZXVlVGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uSWQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbml0aWFsIgogICAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZW5kcG9pbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic29mdHBob25lTWVkaWFJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbFR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVkaWFMZWdDb250ZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbENvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsQ29uZmlnSnNvbiI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2hhdE1lZGlhSW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYXRBdXRvQWNjZXB0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb25uZWN0aW9uRGF0YSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjdXN0b21lck5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JpbmdJbmZvIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYWdlbnQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudE5hbWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvaW5UaW1lU3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm11dGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvcmNlZE11dGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInF1aWNrQ29ubmVjdE5hbWUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtb25pdG9yQ2FwYWJpbGl0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JTdGF0ZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidmFsdWUiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0RHVyYXRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJyZWZlcmVuY2VzIjogewogICAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU3IiCiAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgImluaXRpYXRpb25NZXRob2QiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICJjb250YWN0RmVhdHVyZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJhdHRhY2htZW50c0VuYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2luZ01hcmtkb3duRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibXVsdGlQYXJ0eUNvbmZlcmVuY2VFbmFibGVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAiY2hhbm5lbENvbnRleHQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJzY2hlZHVsZWRUaW1lIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0YXNrVGVtcGxhdGVJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0YXNrVGVtcGxhdGVWZXJzaW9uIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic25hcHNob3RUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFnZW50U3RhdGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgInN0YXRlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgInN0YXRlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldERpYWxhYmxlQ291bnRyeUNvZGVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImNvdW50cnlDb2RlcyIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImNvdW50cnlDb2RlcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RW5kcG9pbnRzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJxdWV1ZUFSTnMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJxdWV1ZUFSTnMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImVuZHBvaW50cyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0TmV3QXV0aFRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJyZWZyZXNoVG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJyZWZyZXNoVG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIm5ld0F1dGhUb2tlbiI6IHt9LAogICAgICAgICAgICAiZXhwaXJhdGlvbkRhdGVUaW1lIjogewogICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldFJvdXRpbmdQcm9maWxlUXVldWVzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJyb3V0aW5nUHJvZmlsZUFSTiIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fSwKICAgICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJxdWV1ZXMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJxdWV1ZXMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkhvbGRDb25uZWN0aW9uIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTXV0ZVBhcnRpY2lwYW50IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiTm90aWZ5Q29udGFjdElzc3VlIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImlzc3VlQ29kZSI6IHt9LAogICAgICAgICAgICAiZGVzY3JpcHRpb24iOiB7fSwKICAgICAgICAgICAgImNsaWVudExvZ3MiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUHV0QWdlbnRTdGF0ZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAic3RhdGUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiZW5xdWV1ZU5leHRTdGF0ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJSZWplY3RDb250YWN0IjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJjb250YWN0SWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUmVzdW1lQ29ubmVjdGlvbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICAgIF0sCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlbmRDbGllbnRMb2dzIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJsb2dFdmVudHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJsb2dFdmVudHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICJjb21wb25lbnQiOiB7fSwKICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiB7fQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZERpZ2l0cyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCIsCiAgICAgICAgICAgICJkaWdpdHMiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9LAogICAgICAgICAgICAiZGlnaXRzIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcyI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMzdiIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2VuZFNvZnRwaG9uZUNhbGxSZXBvcnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJyZXBvcnQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNjcFZlcnNpb24iOiB7fSwKICAgICAgICAgICAgInJlcG9ydCI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgImNhbGxTdGFydFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiY2FsbEVuZFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAgICAgInNoYXBlIjogIlMzdiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiZ3VtVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAiaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJoYW5kc2hha2VUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJwcmVUYWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAidGFsa1RpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNsZWFudXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJoYW5kc2hha2VGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJndW1PdGhlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImd1bVRpbWVvdXRGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJjcmVhdGVPZmZlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ1c2VyQnVzeUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImludmFsaWRSZW1vdGVTRFBGYWlsdXJlIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlRvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiVW5tdXRlUGFydGljaXBhbnQiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJVcGRhdGVBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICAgImNvbmZpZ3VyYXRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjb25maWd1cmF0aW9uIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTMWgiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJzaGFwZXMiOiB7CiAgICAgICJTMiI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50QVJOIjoge30sCiAgICAgICAgICAiYXV0aFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTZSI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJ0eXBlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiZW5kcG9pbnRBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInBob25lTnVtYmVyIjoge30sCiAgICAgICAgICAiYWdlbnRMb2dpbiI6IHt9LAogICAgICAgICAgInF1ZXVlIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiU2siOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJxdWV1ZUFSTiI6IHt9LAogICAgICAgICAgIm5hbWUiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNyIjogewogICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgImtleSI6IHt9LAogICAgICAgICJ2YWx1ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJ2YWx1ZSIsCiAgICAgICAgICAgICJ0eXBlIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAidmFsdWUiOiB7fSwKICAgICAgICAgICAgInR5cGUiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlMxaCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJuYW1lIiwKICAgICAgICAgICJzb2Z0cGhvbmVFbmFibGVkIiwKICAgICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IiwKICAgICAgICAgICJleHRlbnNpb24iLAogICAgICAgICAgInJvdXRpbmdQcm9maWxlIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgICAic29mdHBob25lRW5hYmxlZCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAic29mdHBob25lQXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiZXh0ZW5zaW9uIjoge30sCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICAgImRlZmF1bHRPdXRib3VuZFF1ZXVlIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNoYW5uZWxDb25jdXJyZW5jeU1hcCI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgICAidmFsdWUiOiB7CiAgICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgImFnZW50UHJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICAgInZhbHVlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJTMjAiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAibmFtZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImFnZW50U3RhdGVBUk4iOiB7fSwKICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAibmFtZSI6IHt9LAogICAgICAgICAgInN0YXJ0VGltZXN0YW1wIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiUzN2IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICB9LAogICAgICAgICAgICAic29mdHBob25lU3RyZWFtVHlwZSI6IHt9LAogICAgICAgICAgICAicGFja2V0Q291bnQiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgInBhY2tldHNMb3N0IjogewogICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJhdWRpb0xldmVsIjogewogICAgICAgICAgICAgICJ0eXBlIjogImRvdWJsZSIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgImppdHRlckJ1ZmZlck1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicm91bmRUcmlwVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIH0se31dLDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJhY20iOiB7CiAgICAgICJuYW1lIjogIkFDTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcGlnYXRld2F5IjogewogICAgICAibmFtZSI6ICJBUElHYXRld2F5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcGxpY2F0aW9uYXV0b3NjYWxpbmciOiB7CiAgICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24tYXV0b3NjYWxpbmciLAogICAgICAibmFtZSI6ICJBcHBsaWNhdGlvbkF1dG9TY2FsaW5nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImFwcHN0cmVhbSI6IHsKICAgICAgIm5hbWUiOiAiQXBwU3RyZWFtIgogICAgfSwKICAgICJhdXRvc2NhbGluZyI6IHsKICAgICAgIm5hbWUiOiAiQXV0b1NjYWxpbmciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYmF0Y2giOiB7CiAgICAgICJuYW1lIjogIkJhdGNoIgogICAgfSwKICAgICJidWRnZXRzIjogewogICAgICAibmFtZSI6ICJCdWRnZXRzIgogICAgfSwKICAgICJjbG91ZGRpcmVjdG9yeSI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWREaXJlY3RvcnkiLAogICAgICAidmVyc2lvbnMiOiBbCiAgICAgICAgIjIwMTYtMDUtMTAqIgogICAgICBdCiAgICB9LAogICAgImNsb3VkZm9ybWF0aW9uIjogewogICAgICAibmFtZSI6ICJDbG91ZEZvcm1hdGlvbiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZGZyb250IjogewogICAgICAibmFtZSI6ICJDbG91ZEZyb250IiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDEzLTA1LTEyKiIsCiAgICAgICAgIjIwMTMtMTEtMTEqIiwKICAgICAgICAiMjAxNC0wNS0zMSoiLAogICAgICAgICIyMDE0LTEwLTIxKiIsCiAgICAgICAgIjIwMTQtMTEtMDYqIiwKICAgICAgICAiMjAxNS0wNC0xNyoiLAogICAgICAgICIyMDE1LTA3LTI3KiIsCiAgICAgICAgIjIwMTUtMDktMTcqIiwKICAgICAgICAiMjAxNi0wMS0xMyoiLAogICAgICAgICIyMDE2LTAxLTI4KiIsCiAgICAgICAgIjIwMTYtMDgtMDEqIiwKICAgICAgICAiMjAxNi0wOC0yMCoiLAogICAgICAgICIyMDE2LTA5LTA3KiIsCiAgICAgICAgIjIwMTYtMDktMjkqIiwKICAgICAgICAiMjAxNi0xMS0yNSoiLAogICAgICAgICIyMDE3LTAzLTI1KiIsCiAgICAgICAgIjIwMTctMTAtMzAqIiwKICAgICAgICAiMjAxOC0wNi0xOCoiLAogICAgICAgICIyMDE4LTExLTA1KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3VkaHNtIjogewogICAgICAibmFtZSI6ICJDbG91ZEhTTSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHNlYXJjaCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRTZWFyY2giCiAgICB9LAogICAgImNsb3Vkc2VhcmNoZG9tYWluIjogewogICAgICAibmFtZSI6ICJDbG91ZFNlYXJjaERvbWFpbiIKICAgIH0sCiAgICAiY2xvdWR0cmFpbCI6IHsKICAgICAgIm5hbWUiOiAiQ2xvdWRUcmFpbCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNoIjogewogICAgICAicHJlZml4IjogIm1vbml0b3JpbmciLAogICAgICAibmFtZSI6ICJDbG91ZFdhdGNoIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNsb3Vkd2F0Y2hldmVudHMiOiB7CiAgICAgICJwcmVmaXgiOiAiZXZlbnRzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaEV2ZW50cyIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxNC0wMi0wMyoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjbG91ZHdhdGNobG9ncyI6IHsKICAgICAgInByZWZpeCI6ICJsb2dzIiwKICAgICAgIm5hbWUiOiAiQ2xvdWRXYXRjaExvZ3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWJ1aWxkIjogewogICAgICAibmFtZSI6ICJDb2RlQnVpbGQiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29kZWNvbW1pdCI6IHsKICAgICAgIm5hbWUiOiAiQ29kZUNvbW1pdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2RlZGVwbG95IjogewogICAgICAibmFtZSI6ICJDb2RlRGVwbG95IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZGVwaXBlbGluZSI6IHsKICAgICAgIm5hbWUiOiAiQ29kZVBpcGVsaW5lIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eSI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICAgIm5hbWUiOiAiQ29nbml0b0lkZW50aXR5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvZ25pdG9pZGVudGl0eXNlcnZpY2Vwcm92aWRlciI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLWlkcCIsCiAgICAgICJuYW1lIjogIkNvZ25pdG9JZGVudGl0eVNlcnZpY2VQcm92aWRlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb2duaXRvc3luYyI6IHsKICAgICAgInByZWZpeCI6ICJjb2duaXRvLXN5bmMiLAogICAgICAibmFtZSI6ICJDb2duaXRvU3luYyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjb25maWdzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImNvbmZpZyIsCiAgICAgICJuYW1lIjogIkNvbmZpZ1NlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiY29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiQ29ubmVjdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJjdXIiOiB7CiAgICAgICJuYW1lIjogIkNVUiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJkYXRhcGlwZWxpbmUiOiB7CiAgICAgICJuYW1lIjogIkRhdGFQaXBlbGluZSIKICAgIH0sCiAgICAiZGV2aWNlZmFybSI6IHsKICAgICAgIm5hbWUiOiAiRGV2aWNlRmFybSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJkaXJlY3Rjb25uZWN0IjogewogICAgICAibmFtZSI6ICJEaXJlY3RDb25uZWN0IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImRpcmVjdG9yeXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZHMiLAogICAgICAibmFtZSI6ICJEaXJlY3RvcnlTZXJ2aWNlIgogICAgfSwKICAgICJkaXNjb3ZlcnkiOiB7CiAgICAgICJuYW1lIjogIkRpc2NvdmVyeSIKICAgIH0sCiAgICAiZG1zIjogewogICAgICAibmFtZSI6ICJETVMiCiAgICB9LAogICAgImR5bmFtb2RiIjogewogICAgICAibmFtZSI6ICJEeW5hbW9EQiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJkeW5hbW9kYnN0cmVhbXMiOiB7CiAgICAgICJwcmVmaXgiOiAic3RyZWFtcy5keW5hbW9kYiIsCiAgICAgICJuYW1lIjogIkR5bmFtb0RCU3RyZWFtcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlYzIiOiB7CiAgICAgICJuYW1lIjogIkVDMiIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxMy0wNi0xNSoiLAogICAgICAgICIyMDEzLTEwLTE1KiIsCiAgICAgICAgIjIwMTQtMDItMDEqIiwKICAgICAgICAiMjAxNC0wNS0wMSoiLAogICAgICAgICIyMDE0LTA2LTE1KiIsCiAgICAgICAgIjIwMTQtMDktMDEqIiwKICAgICAgICAiMjAxNC0xMC0wMSoiLAogICAgICAgICIyMDE1LTAzLTAxKiIsCiAgICAgICAgIjIwMTUtMDQtMTUqIiwKICAgICAgICAiMjAxNS0xMC0wMSoiLAogICAgICAgICIyMDE2LTA0LTAxKiIsCiAgICAgICAgIjIwMTYtMDktMTUqIgogICAgICBdLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWNyIjogewogICAgICAibmFtZSI6ICJFQ1IiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWNzIjogewogICAgICAibmFtZSI6ICJFQ1MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZWZzIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNmaWxlc3lzdGVtIiwKICAgICAgIm5hbWUiOiAiRUZTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYXN0aWNhY2hlIjogewogICAgICAibmFtZSI6ICJFbGFzdGlDYWNoZSIsCiAgICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgICAiMjAxMi0xMS0xNSoiLAogICAgICAgICIyMDE0LTAzLTI0KiIsCiAgICAgICAgIjIwMTQtMDctMTUqIiwKICAgICAgICAiMjAxNC0wOS0zMCoiCiAgICAgIF0sCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGFzdGljYmVhbnN0YWxrIjogewogICAgICAibmFtZSI6ICJFbGFzdGljQmVhbnN0YWxrIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImVsYiI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljbG9hZGJhbGFuY2luZyIsCiAgICAgICJuYW1lIjogIkVMQiIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJlbGJ2MiI6IHsKICAgICAgInByZWZpeCI6ICJlbGFzdGljbG9hZGJhbGFuY2luZ3YyIiwKICAgICAgIm5hbWUiOiAiRUxCdjIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZW1yIjogewogICAgICAicHJlZml4IjogImVsYXN0aWNtYXByZWR1Y2UiLAogICAgICAibmFtZSI6ICJFTVIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZXMiOiB7CiAgICAgICJuYW1lIjogIkVTIgogICAgfSwKICAgICJlbGFzdGljdHJhbnNjb2RlciI6IHsKICAgICAgIm5hbWUiOiAiRWxhc3RpY1RyYW5zY29kZXIiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZmlyZWhvc2UiOiB7CiAgICAgICJuYW1lIjogIkZpcmVob3NlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImdhbWVsaWZ0IjogewogICAgICAibmFtZSI6ICJHYW1lTGlmdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJnbGFjaWVyIjogewogICAgICAibmFtZSI6ICJHbGFjaWVyIgogICAgfSwKICAgICJoZWFsdGgiOiB7CiAgICAgICJuYW1lIjogIkhlYWx0aCIKICAgIH0sCiAgICAiaWFtIjogewogICAgICAibmFtZSI6ICJJQU0iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiaW1wb3J0ZXhwb3J0IjogewogICAgICAibmFtZSI6ICJJbXBvcnRFeHBvcnQiCiAgICB9LAogICAgImluc3BlY3RvciI6IHsKICAgICAgIm5hbWUiOiAiSW5zcGVjdG9yIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE1LTA4LTE4KiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImlvdCI6IHsKICAgICAgIm5hbWUiOiAiSW90IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImlvdGRhdGEiOiB7CiAgICAgICJwcmVmaXgiOiAiaW90LWRhdGEiLAogICAgICAibmFtZSI6ICJJb3REYXRhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXMiOiB7CiAgICAgICJuYW1lIjogIktpbmVzaXMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc2FuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiS2luZXNpc0FuYWx5dGljcyIKICAgIH0sCiAgICAia21zIjogewogICAgICAibmFtZSI6ICJLTVMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibGFtYmRhIjogewogICAgICAibmFtZSI6ICJMYW1iZGEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibGV4cnVudGltZSI6IHsKICAgICAgInByZWZpeCI6ICJydW50aW1lLmxleCIsCiAgICAgICJuYW1lIjogIkxleFJ1bnRpbWUiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibGlnaHRzYWlsIjogewogICAgICAibmFtZSI6ICJMaWdodHNhaWwiCiAgICB9LAogICAgIm1hY2hpbmVsZWFybmluZyI6IHsKICAgICAgIm5hbWUiOiAiTWFjaGluZUxlYXJuaW5nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm1hcmtldHBsYWNlY29tbWVyY2VhbmFseXRpY3MiOiB7CiAgICAgICJuYW1lIjogIk1hcmtldHBsYWNlQ29tbWVyY2VBbmFseXRpY3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibWFya2V0cGxhY2VtZXRlcmluZyI6IHsKICAgICAgInByZWZpeCI6ICJtZXRlcmluZ21hcmtldHBsYWNlIiwKICAgICAgIm5hbWUiOiAiTWFya2V0cGxhY2VNZXRlcmluZyIKICAgIH0sCiAgICAibXR1cmsiOiB7CiAgICAgICJwcmVmaXgiOiAibXR1cmstcmVxdWVzdGVyIiwKICAgICAgIm5hbWUiOiAiTVR1cmsiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAibW9iaWxlYW5hbHl0aWNzIjogewogICAgICAibmFtZSI6ICJNb2JpbGVBbmFseXRpY3MiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAib3Bzd29ya3MiOiB7CiAgICAgICJuYW1lIjogIk9wc1dvcmtzIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgIm9wc3dvcmtzY20iOiB7CiAgICAgICJuYW1lIjogIk9wc1dvcmtzQ00iCiAgICB9LAogICAgIm9yZ2FuaXphdGlvbnMiOiB7CiAgICAgICJuYW1lIjogIk9yZ2FuaXphdGlvbnMiCiAgICB9LAogICAgInBpbnBvaW50IjogewogICAgICAibmFtZSI6ICJQaW5wb2ludCIKICAgIH0sCiAgICAicG9sbHkiOiB7CiAgICAgICJuYW1lIjogIlBvbGx5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJkcyI6IHsKICAgICAgIm5hbWUiOiAiUkRTIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE0LTA5LTAxKiIKICAgICAgXSwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInJlZHNoaWZ0IjogewogICAgICAibmFtZSI6ICJSZWRzaGlmdCIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJyZWtvZ25pdGlvbiI6IHsKICAgICAgIm5hbWUiOiAiUmVrb2duaXRpb24iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVzb3VyY2Vncm91cHN0YWdnaW5nYXBpIjogewogICAgICAibmFtZSI6ICJSZXNvdXJjZUdyb3Vwc1RhZ2dpbmdBUEkiCiAgICB9LAogICAgInJvdXRlNTMiOiB7CiAgICAgICJuYW1lIjogIlJvdXRlNTMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicm91dGU1M2RvbWFpbnMiOiB7CiAgICAgICJuYW1lIjogIlJvdXRlNTNEb21haW5zIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInMzIjogewogICAgICAibmFtZSI6ICJTMyIsCiAgICAgICJkdWFsc3RhY2tBdmFpbGFibGUiOiB0cnVlLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiczNjb250cm9sIjogewogICAgICAibmFtZSI6ICJTM0NvbnRyb2wiLAogICAgICAiZHVhbHN0YWNrQXZhaWxhYmxlIjogdHJ1ZQogICAgfSwKICAgICJzZXJ2aWNlY2F0YWxvZyI6IHsKICAgICAgIm5hbWUiOiAiU2VydmljZUNhdGFsb2ciLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic2VzIjogewogICAgICAicHJlZml4IjogImVtYWlsIiwKICAgICAgIm5hbWUiOiAiU0VTIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNoaWVsZCI6IHsKICAgICAgIm5hbWUiOiAiU2hpZWxkIgogICAgfSwKICAgICJzaW1wbGVkYiI6IHsKICAgICAgInByZWZpeCI6ICJzZGIiLAogICAgICAibmFtZSI6ICJTaW1wbGVEQiIKICAgIH0sCiAgICAic21zIjogewogICAgICAibmFtZSI6ICJTTVMiCiAgICB9LAogICAgInNub3diYWxsIjogewogICAgICAibmFtZSI6ICJTbm93YmFsbCIKICAgIH0sCiAgICAic25zIjogewogICAgICAibmFtZSI6ICJTTlMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic3FzIjogewogICAgICAibmFtZSI6ICJTUVMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic3NtIjogewogICAgICAibmFtZSI6ICJTU00iLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic3RvcmFnZWdhdGV3YXkiOiB7CiAgICAgICJuYW1lIjogIlN0b3JhZ2VHYXRld2F5IiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInN0ZXBmdW5jdGlvbnMiOiB7CiAgICAgICJwcmVmaXgiOiAic3RhdGVzIiwKICAgICAgIm5hbWUiOiAiU3RlcEZ1bmN0aW9ucyIKICAgIH0sCiAgICAic3RzIjogewogICAgICAibmFtZSI6ICJTVFMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAic3VwcG9ydCI6IHsKICAgICAgIm5hbWUiOiAiU3VwcG9ydCIKICAgIH0sCiAgICAic3dmIjogewogICAgICAibmFtZSI6ICJTV0YiCiAgICB9LAogICAgInhyYXkiOiB7CiAgICAgICJuYW1lIjogIlhSYXkiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAid2FmIjogewogICAgICAibmFtZSI6ICJXQUYiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAid2FmcmVnaW9uYWwiOiB7CiAgICAgICJwcmVmaXgiOiAid2FmLXJlZ2lvbmFsIiwKICAgICAgIm5hbWUiOiAiV0FGUmVnaW9uYWwiCiAgICB9LAogICAgIndvcmtkb2NzIjogewogICAgICAibmFtZSI6ICJXb3JrRG9jcyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJ3b3Jrc3BhY2VzIjogewogICAgICAibmFtZSI6ICJXb3JrU3BhY2VzIgogICAgfSwKICAgICJjb2Rlc3RhciI6IHsKICAgICAgIm5hbWUiOiAiQ29kZVN0YXIiCiAgICB9LAogICAgImxleG1vZGVsYnVpbGRpbmdzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogImxleC1tb2RlbHMiLAogICAgICAibmFtZSI6ICJMZXhNb2RlbEJ1aWxkaW5nU2VydmljZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtYXJrZXRwbGFjZWVudGl0bGVtZW50c2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJlbnRpdGxlbWVudC5tYXJrZXRwbGFjZSIsCiAgICAgICJuYW1lIjogIk1hcmtldHBsYWNlRW50aXRsZW1lbnRTZXJ2aWNlIgogICAgfSwKICAgICJhdGhlbmEiOiB7CiAgICAgICJuYW1lIjogIkF0aGVuYSIKICAgIH0sCiAgICAiZ3JlZW5ncmFzcyI6IHsKICAgICAgIm5hbWUiOiAiR3JlZW5ncmFzcyIKICAgIH0sCiAgICAiZGF4IjogewogICAgICAibmFtZSI6ICJEQVgiCiAgICB9LAogICAgIm1pZ3JhdGlvbmh1YiI6IHsKICAgICAgInByZWZpeCI6ICJBV1NNaWdyYXRpb25IdWIiLAogICAgICAibmFtZSI6ICJNaWdyYXRpb25IdWIiCiAgICB9LAogICAgImNsb3VkaHNtdjIiOiB7CiAgICAgICJuYW1lIjogIkNsb3VkSFNNVjIiCiAgICB9LAogICAgImdsdWUiOiB7CiAgICAgICJuYW1lIjogIkdsdWUiCiAgICB9LAogICAgIm1vYmlsZSI6IHsKICAgICAgIm5hbWUiOiAiTW9iaWxlIgogICAgfSwKICAgICJwcmljaW5nIjogewogICAgICAibmFtZSI6ICJQcmljaW5nIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImNvc3RleHBsb3JlciI6IHsKICAgICAgInByZWZpeCI6ICJjZSIsCiAgICAgICJuYW1lIjogIkNvc3RFeHBsb3JlciIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJtZWRpYWNvbnZlcnQiOiB7CiAgICAgICJuYW1lIjogIk1lZGlhQ29udmVydCIKICAgIH0sCiAgICAibWVkaWFsaXZlIjogewogICAgICAibmFtZSI6ICJNZWRpYUxpdmUiCiAgICB9LAogICAgIm1lZGlhcGFja2FnZSI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFQYWNrYWdlIgogICAgfSwKICAgICJtZWRpYXN0b3JlIjogewogICAgICAibmFtZSI6ICJNZWRpYVN0b3JlIgogICAgfSwKICAgICJtZWRpYXN0b3JlZGF0YSI6IHsKICAgICAgInByZWZpeCI6ICJtZWRpYXN0b3JlLWRhdGEiLAogICAgICAibmFtZSI6ICJNZWRpYVN0b3JlRGF0YSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcHBzeW5jIjogewogICAgICAibmFtZSI6ICJBcHBTeW5jIgogICAgfSwKICAgICJndWFyZGR1dHkiOiB7CiAgICAgICJuYW1lIjogIkd1YXJkRHV0eSIKICAgIH0sCiAgICAibXEiOiB7CiAgICAgICJuYW1lIjogIk1RIgogICAgfSwKICAgICJjb21wcmVoZW5kIjogewogICAgICAibmFtZSI6ICJDb21wcmVoZW5kIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImlvdGpvYnNkYXRhcGxhbmUiOiB7CiAgICAgICJwcmVmaXgiOiAiaW90LWpvYnMtZGF0YSIsCiAgICAgICJuYW1lIjogIklvVEpvYnNEYXRhUGxhbmUiCiAgICB9LAogICAgImtpbmVzaXN2aWRlb2FyY2hpdmVkbWVkaWEiOiB7CiAgICAgICJwcmVmaXgiOiAia2luZXNpcy12aWRlby1hcmNoaXZlZC1tZWRpYSIsCiAgICAgICJuYW1lIjogIktpbmVzaXNWaWRlb0FyY2hpdmVkTWVkaWEiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc3ZpZGVvbWVkaWEiOiB7CiAgICAgICJwcmVmaXgiOiAia2luZXNpcy12aWRlby1tZWRpYSIsCiAgICAgICJuYW1lIjogIktpbmVzaXNWaWRlb01lZGlhIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImtpbmVzaXN2aWRlbyI6IHsKICAgICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInNhZ2VtYWtlcnJ1bnRpbWUiOiB7CiAgICAgICJwcmVmaXgiOiAicnVudGltZS5zYWdlbWFrZXIiLAogICAgICAibmFtZSI6ICJTYWdlTWFrZXJSdW50aW1lIgogICAgfSwKICAgICJzYWdlbWFrZXIiOiB7CiAgICAgICJuYW1lIjogIlNhZ2VNYWtlciIKICAgIH0sCiAgICAidHJhbnNsYXRlIjogewogICAgICAibmFtZSI6ICJUcmFuc2xhdGUiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAicmVzb3VyY2Vncm91cHMiOiB7CiAgICAgICJwcmVmaXgiOiAicmVzb3VyY2UtZ3JvdXBzIiwKICAgICAgIm5hbWUiOiAiUmVzb3VyY2VHcm91cHMiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiYWxleGFmb3JidXNpbmVzcyI6IHsKICAgICAgIm5hbWUiOiAiQWxleGFGb3JCdXNpbmVzcyIKICAgIH0sCiAgICAiY2xvdWQ5IjogewogICAgICAibmFtZSI6ICJDbG91ZDkiCiAgICB9LAogICAgInNlcnZlcmxlc3NhcHBsaWNhdGlvbnJlcG9zaXRvcnkiOiB7CiAgICAgICJwcmVmaXgiOiAic2VydmVybGVzc3JlcG8iLAogICAgICAibmFtZSI6ICJTZXJ2ZXJsZXNzQXBwbGljYXRpb25SZXBvc2l0b3J5IgogICAgfSwKICAgICJzZXJ2aWNlZGlzY292ZXJ5IjogewogICAgICAibmFtZSI6ICJTZXJ2aWNlRGlzY292ZXJ5IgogICAgfSwKICAgICJ3b3JrbWFpbCI6IHsKICAgICAgIm5hbWUiOiAiV29ya01haWwiCiAgICB9LAogICAgImF1dG9zY2FsaW5ncGxhbnMiOiB7CiAgICAgICJwcmVmaXgiOiAiYXV0b3NjYWxpbmctcGxhbnMiLAogICAgICAibmFtZSI6ICJBdXRvU2NhbGluZ1BsYW5zIgogICAgfSwKICAgICJ0cmFuc2NyaWJlc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJ0cmFuc2NyaWJlIiwKICAgICAgIm5hbWUiOiAiVHJhbnNjcmliZVNlcnZpY2UiCiAgICB9LAogICAgImNvbm5lY3QiOiB7CiAgICAgICJuYW1lIjogIkNvbm5lY3QiCiAgICB9LAogICAgImFjbXBjYSI6IHsKICAgICAgInByZWZpeCI6ICJhY20tcGNhIiwKICAgICAgIm5hbWUiOiAiQUNNUENBIgogICAgfSwKICAgICJmbXMiOiB7CiAgICAgICJuYW1lIjogIkZNUyIKICAgIH0sCiAgICAic2VjcmV0c21hbmFnZXIiOiB7CiAgICAgICJuYW1lIjogIlNlY3JldHNNYW5hZ2VyIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgImlvdGFuYWx5dGljcyI6IHsKICAgICAgIm5hbWUiOiAiSW9UQW5hbHl0aWNzIiwKICAgICAgImNvcnMiOiB0cnVlCQogICAgfSwKICAgICJpb3QxY2xpY2tkZXZpY2Vzc2VydmljZSI6IHsKICAgICAgInByZWZpeCI6ICJpb3QxY2xpY2stZGV2aWNlcyIsCiAgICAgICJuYW1lIjogIklvVDFDbGlja0RldmljZXNTZXJ2aWNlIgogICAgfSwKICAgICJpb3QxY2xpY2twcm9qZWN0cyI6IHsKICAgICAgInByZWZpeCI6ICJpb3QxY2xpY2stcHJvamVjdHMiLAogICAgICAibmFtZSI6ICJJb1QxQ2xpY2tQcm9qZWN0cyIKICAgIH0sCiAgICAicGkiOiB7CiAgICAgICJuYW1lIjogIlBJIgogICAgfSwKICAgICJuZXB0dW5lIjogewogICAgICAibmFtZSI6ICJOZXB0dW5lIgogICAgfSwKICAgICJtZWRpYXRhaWxvciI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFUYWlsb3IiCiAgICB9LAogICAgImVrcyI6IHsKICAgICAgIm5hbWUiOiAiRUtTIgogICAgfSwKICAgICJtYWNpZSI6IHsKICAgICAgIm5hbWUiOiAiTWFjaWUiCiAgICB9LAogICAgImRsbSI6IHsKICAgICAgIm5hbWUiOiAiRExNIgogICAgfSwKICAgICJzaWduZXIiOiB7CiAgICAgICJuYW1lIjogIlNpZ25lciIKICAgIH0sCiAgICAiY2hpbWUiOiB7CiAgICAgICJuYW1lIjogIkNoaW1lIgogICAgfSwKICAgICJwaW5wb2ludGVtYWlsIjogewogICAgICAicHJlZml4IjogInBpbnBvaW50LWVtYWlsIiwKICAgICAgIm5hbWUiOiAiUGlucG9pbnRFbWFpbCIKICAgIH0sCiAgICAicmFtIjogewogICAgICAibmFtZSI6ICJSQU0iCiAgICB9LAogICAgInJvdXRlNTNyZXNvbHZlciI6IHsKICAgICAgIm5hbWUiOiAiUm91dGU1M1Jlc29sdmVyIgogICAgfSwKICAgICJwaW5wb2ludHNtc3ZvaWNlIjogewogICAgICAicHJlZml4IjogInNtcy12b2ljZSIsCiAgICAgICJuYW1lIjogIlBpbnBvaW50U01TVm9pY2UiCiAgICB9LAogICAgInF1aWNrc2lnaHQiOiB7CiAgICAgICJuYW1lIjogIlF1aWNrU2lnaHQiCiAgICB9LAogICAgInJkc2RhdGFzZXJ2aWNlIjogewogICAgICAicHJlZml4IjogInJkcy1kYXRhIiwKICAgICAgIm5hbWUiOiAiUkRTRGF0YVNlcnZpY2UiCiAgICB9LAogICAgImFtcGxpZnkiOiB7CiAgICAgICJuYW1lIjogIkFtcGxpZnkiCiAgICB9LAogICAgImRhdGFzeW5jIjogewogICAgICAibmFtZSI6ICJEYXRhU3luYyIKICAgIH0sCiAgICAicm9ib21ha2VyIjogewogICAgICAibmFtZSI6ICJSb2JvTWFrZXIiCiAgICB9LAogICAgInRyYW5zZmVyIjogewogICAgICAibmFtZSI6ICJUcmFuc2ZlciIKICAgIH0sCiAgICAiZ2xvYmFsYWNjZWxlcmF0b3IiOiB7CiAgICAgICJuYW1lIjogIkdsb2JhbEFjY2VsZXJhdG9yIgogICAgfSwKICAgICJjb21wcmVoZW5kbWVkaWNhbCI6IHsKICAgICAgIm5hbWUiOiAiQ29tcHJlaGVuZE1lZGljYWwiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAia2luZXNpc2FuYWx5dGljc3YyIjogewogICAgICAibmFtZSI6ICJLaW5lc2lzQW5hbHl0aWNzVjIiCiAgICB9LAogICAgIm1lZGlhY29ubmVjdCI6IHsKICAgICAgIm5hbWUiOiAiTWVkaWFDb25uZWN0IgogICAgfSwKICAgICJmc3giOiB7CiAgICAgICJuYW1lIjogIkZTeCIKICAgIH0sCiAgICAic2VjdXJpdHlodWIiOiB7CiAgICAgICJuYW1lIjogIlNlY3VyaXR5SHViIgogICAgfSwKICAgICJhcHBtZXNoIjogewogICAgICAibmFtZSI6ICJBcHBNZXNoIiwKICAgICAgInZlcnNpb25zIjogWwogICAgICAgICIyMDE4LTEwLTAxKiIKICAgICAgXQogICAgfSwKICAgICJsaWNlbnNlbWFuYWdlciI6IHsKICAgICAgInByZWZpeCI6ICJsaWNlbnNlLW1hbmFnZXIiLAogICAgICAibmFtZSI6ICJMaWNlbnNlTWFuYWdlciIKICAgIH0sCiAgICAia2Fma2EiOiB7CiAgICAgICJuYW1lIjogIkthZmthIgogICAgfSwKICAgICJhcGlnYXRld2F5bWFuYWdlbWVudGFwaSI6IHsKICAgICAgIm5hbWUiOiAiQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkiCiAgICB9LAogICAgImFwaWdhdGV3YXl2MiI6IHsKICAgICAgIm5hbWUiOiAiQXBpR2F0ZXdheVYyIgogICAgfSwKICAgICJkb2NkYiI6IHsKICAgICAgIm5hbWUiOiAiRG9jREIiCiAgICB9LAogICAgImJhY2t1cCI6IHsKICAgICAgIm5hbWUiOiAiQmFja3VwIgogICAgfSwKICAgICJ3b3JrbGluayI6IHsKICAgICAgIm5hbWUiOiAiV29ya0xpbmsiCiAgICB9LAogICAgInRleHRyYWN0IjogewogICAgICAibmFtZSI6ICJUZXh0cmFjdCIKICAgIH0sCiAgICAibWFuYWdlZGJsb2NrY2hhaW4iOiB7CiAgICAgICJuYW1lIjogIk1hbmFnZWRCbG9ja2NoYWluIgogICAgfSwKICAgICJtZWRpYXBhY2thZ2V2b2QiOiB7CiAgICAgICJwcmVmaXgiOiAibWVkaWFwYWNrYWdlLXZvZCIsCiAgICAgICJuYW1lIjogIk1lZGlhUGFja2FnZVZvZCIKICAgIH0sCiAgICAiZ3JvdW5kc3RhdGlvbiI6IHsKICAgICAgIm5hbWUiOiAiR3JvdW5kU3RhdGlvbiIKICAgIH0sCiAgICAiaW90dGhpbmdzZ3JhcGgiOiB7CiAgICAgICJuYW1lIjogIklvVFRoaW5nc0dyYXBoIgogICAgfSwKICAgICJpb3RldmVudHMiOiB7CiAgICAgICJuYW1lIjogIklvVEV2ZW50cyIKICAgIH0sCiAgICAiaW90ZXZlbnRzZGF0YSI6IHsKICAgICAgInByZWZpeCI6ICJpb3RldmVudHMtZGF0YSIsCiAgICAgICJuYW1lIjogIklvVEV2ZW50c0RhdGEiCiAgICB9LAogICAgInBlcnNvbmFsaXplIjogewogICAgICAibmFtZSI6ICJQZXJzb25hbGl6ZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJwZXJzb25hbGl6ZWV2ZW50cyI6IHsKICAgICAgInByZWZpeCI6ICJwZXJzb25hbGl6ZS1ldmVudHMiLAogICAgICAibmFtZSI6ICJQZXJzb25hbGl6ZUV2ZW50cyIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJwZXJzb25hbGl6ZXJ1bnRpbWUiOiB7CiAgICAgICJwcmVmaXgiOiAicGVyc29uYWxpemUtcnVudGltZSIsCiAgICAgICJuYW1lIjogIlBlcnNvbmFsaXplUnVudGltZSIsCiAgICAgICJjb3JzIjogdHJ1ZQogICAgfSwKICAgICJhcHBsaWNhdGlvbmluc2lnaHRzIjogewogICAgICAicHJlZml4IjogImFwcGxpY2F0aW9uLWluc2lnaHRzIiwKICAgICAgIm5hbWUiOiAiQXBwbGljYXRpb25JbnNpZ2h0cyIKICAgIH0sCiAgICAic2VydmljZXF1b3RhcyI6IHsKICAgICAgInByZWZpeCI6ICJzZXJ2aWNlLXF1b3RhcyIsCiAgICAgICJuYW1lIjogIlNlcnZpY2VRdW90YXMiCiAgICB9LAogICAgImVjMmluc3RhbmNlY29ubmVjdCI6IHsKICAgICAgInByZWZpeCI6ICJlYzItaW5zdGFuY2UtY29ubmVjdCIsCiAgICAgICJuYW1lIjogIkVDMkluc3RhbmNlQ29ubmVjdCIKICAgIH0sCiAgICAiZXZlbnRicmlkZ2UiOiB7CiAgICAgICJuYW1lIjogIkV2ZW50QnJpZGdlIgogICAgfSwKICAgICJsYWtlZm9ybWF0aW9uIjogewogICAgICAibmFtZSI6ICJMYWtlRm9ybWF0aW9uIgogICAgfSwKICAgICJmb3JlY2FzdHNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZm9yZWNhc3QiLAogICAgICAibmFtZSI6ICJGb3JlY2FzdFNlcnZpY2UiLAogICAgICAiY29ycyI6IHRydWUKICAgIH0sCiAgICAiZm9yZWNhc3RxdWVyeXNlcnZpY2UiOiB7CiAgICAgICJwcmVmaXgiOiAiZm9yZWNhc3RxdWVyeSIsCiAgICAgICJuYW1lIjogIkZvcmVjYXN0UXVlcnlTZXJ2aWNlIiwKICAgICAgImNvcnMiOiB0cnVlCiAgICB9LAogICAgInFsZGIiOiB7CiAgICAgICJuYW1lIjogIlFMREIiCiAgICB9LAogICAgInFsZGJzZXNzaW9uIjogewogICAgICAicHJlZml4IjogInFsZGItc2Vzc2lvbiIsCiAgICAgICJuYW1lIjogIlFMREJTZXNzaW9uIgogICAgfSwKICAgICJ3b3JrbWFpbG1lc3NhZ2VmbG93IjogewogICAgICAibmFtZSI6ICJXb3JrTWFpbE1lc3NhZ2VGbG93IgogICAgfQogIH0KICAKICB9LHt9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cz17CiAgICAidmVyc2lvbiI6ICIyLjAiLAogICAgIm1ldGFkYXRhIjogewogICAgICAiYXBpVmVyc2lvbiI6ICIyMDExLTA2LTE1IiwKICAgICAgImVuZHBvaW50UHJlZml4IjogInN0cyIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6ICJzdHMuYW1hem9uYXdzLmNvbSIsCiAgICAgICJwcm90b2NvbCI6ICJxdWVyeSIsCiAgICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkFXUyBTVFMiLAogICAgICAic2VydmljZUZ1bGxOYW1lIjogIkFXUyBTZWN1cml0eSBUb2tlbiBTZXJ2aWNlIiwKICAgICAgInNlcnZpY2VJZCI6ICJTVFMiLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAgICJ1aWQiOiAic3RzLTIwMTEtMDYtMTUiLAogICAgICAieG1sTmFtZXNwYWNlIjogImh0dHBzOi8vc3RzLmFtYXpvbmF3cy5jb20vZG9jLzIwMTEtMDYtMTUvIgogICAgfSwKICAgICJvcGVyYXRpb25zIjogewogICAgICAiQXNzdW1lUm9sZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkV4dGVybmFsSWQiOiB7fSwKICAgICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgICAiVG9rZW5Db2RlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJBc3N1bWVSb2xlUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJBc3N1bWVSb2xlV2l0aFNBTUwiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgICAiUHJpbmNpcGFsQXJuIiwKICAgICAgICAgICAgIlNBTUxBc3NlcnRpb24iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJQcmluY2lwYWxBcm4iOiB7fSwKICAgICAgICAgICAgIlNBTUxBc3NlcnRpb24iOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoU0FNTFJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2MiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3ViamVjdCI6IHt9LAogICAgICAgICAgICAiU3ViamVjdFR5cGUiOiB7fSwKICAgICAgICAgICAgIklzc3VlciI6IHt9LAogICAgICAgICAgICAiQXVkaWVuY2UiOiB7fSwKICAgICAgICAgICAgIk5hbWVRdWFsaWZpZXIiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIlJvbGVBcm4iLAogICAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIiwKICAgICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiOiB7fSwKICAgICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICAgIlByb3ZpZGVySWQiOiB7fSwKICAgICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiU3ViamVjdEZyb21XZWJJZGVudGl0eVRva2VuIjoge30sCiAgICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9LAogICAgICAgICAgICAiUHJvdmlkZXIiOiB7fSwKICAgICAgICAgICAgIkF1ZGllbmNlIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJEZWNvZGVBdXRob3JpemF0aW9uTWVzc2FnZSI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAiRW5jb2RlZE1lc3NhZ2UiCiAgICAgICAgICBdLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiRGVjb2RlQXV0aG9yaXphdGlvbk1lc3NhZ2VSZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiRGVjb2RlZE1lc3NhZ2UiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldEFjY2Vzc0tleUluZm8iOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgIkFjY2Vzc0tleUlkIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm91dHB1dCI6IHsKICAgICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldEFjY2Vzc0tleUluZm9SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQWNjb3VudCI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0Q2FsbGVySWRlbnRpdHkiOiB7CiAgICAgICAgImlucHV0IjogewogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjoge30KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRDYWxsZXJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJVc2VySWQiOiB7fSwKICAgICAgICAgICAgIkFjY291bnQiOiB7fSwKICAgICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAiR2V0RmVkZXJhdGlvblRva2VuIjogewogICAgICAgICJpbnB1dCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICJOYW1lIgogICAgICAgICAgXSwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiTmFtZSI6IHt9LAogICAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAib3V0cHV0IjogewogICAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0RmVkZXJhdGlvblRva2VuUmVzdWx0IiwKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTYyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIkZlZGVyYXRlZFVzZXIiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAiRmVkZXJhdGVkVXNlcklkIiwKICAgICAgICAgICAgICAgICJBcm4iCiAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICJGZWRlcmF0ZWRVc2VySWQiOiB7fSwKICAgICAgICAgICAgICAgICJBcm4iOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIkdldFNlc3Npb25Ub2tlbiI6IHsKICAgICAgICAiaW5wdXQiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgICAiVG9rZW5Db2RlIjoge30KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgICAicmVzdWx0V3JhcHBlciI6ICJHZXRTZXNzaW9uVG9rZW5SZXN1bHQiLAogICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNjIgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgInNoYXBlcyI6IHsKICAgICAgIlM0IjogewogICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICJhcm4iOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNjIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkFjY2Vzc0tleUlkIiwKICAgICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiLAogICAgICAgICAgIlNlc3Npb25Ub2tlbiIsCiAgICAgICAgICAiRXhwaXJhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFjY2Vzc0tleUlkIjoge30sCiAgICAgICAgICAiU2VjcmV0QWNjZXNzS2V5Ijoge30sCiAgICAgICAgICAiU2Vzc2lvblRva2VuIjoge30sCiAgICAgICAgICAiRXhwaXJhdGlvbiI6IHsKICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIlNoIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIkFzc3VtZWRSb2xlSWQiLAogICAgICAgICAgIkFybiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkFzc3VtZWRSb2xlSWQiOiB7fSwKICAgICAgICAgICJBcm4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICB9LHt9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBhcmd1bWVudHNbNF1bMl1bMF0uYXBwbHkoZXhwb3J0cyxhcmd1bWVudHMpCiAgfSx7ImR1cCI6Mn1dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwogIHZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CiAgdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CiAgCiAgYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSA9IHt9OwogIEFXUy5Db2duaXRvSWRlbnRpdHkgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ2NvZ25pdG9pZGVudGl0eScsIFsnMjAxNC0wNi0zMCddKTsKICByZXF1aXJlKCcuLi9saWIvc2VydmljZXMvY29nbml0b2lkZW50aXR5Jyk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snY29nbml0b2lkZW50aXR5J10sICcyMDE0LTA2LTMwJywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLm1pbi5qc29uJyk7CiAgICAgIG1vZGVsLnBhZ2luYXRvcnMgPSByZXF1aXJlKCcuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5wYWdpbmF0b3JzLmpzb24nKS5wYWdpbmF0aW9uOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwogIAogIG1vZHVsZS5leHBvcnRzID0gQVdTLkNvZ25pdG9JZGVudGl0eTsKICAKICB9LHsiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAubWluLmpzb24iOjEsIi4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbiI6MiwiLi4vbGliL2NvcmUiOjE4LCIuLi9saWIvbm9kZV9sb2FkZXIiOjE2LCIuLi9saWIvc2VydmljZXMvY29nbml0b2lkZW50aXR5Ijo2MH1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHJlcXVpcmUoJy4uL2xpYi9ub2RlX2xvYWRlcicpOwogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwogIHZhciBTZXJ2aWNlID0gQVdTLlNlcnZpY2U7CiAgdmFyIGFwaUxvYWRlciA9IEFXUy5hcGlMb2FkZXI7CiAgCiAgYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXSA9IHt9OwogIEFXUy5TVFMgPSBTZXJ2aWNlLmRlZmluZVNlcnZpY2UoJ3N0cycsIFsnMjAxMS0wNi0xNSddKTsKICByZXF1aXJlKCcuLi9saWIvc2VydmljZXMvc3RzJyk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10sICcyMDExLTA2LTE1JywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24nKTsKICAgICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uJykucGFnaW5hdGlvbjsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9KTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TVFM7CiAgCiAgfSx7Ii4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24iOjUsIi4uL2FwaXMvc3RzLTIwMTEtMDYtMTUucGFnaW5hdG9ycy5qc29uIjo2LCIuLi9saWIvY29yZSI6MTgsIi4uL2xpYi9ub2RlX2xvYWRlciI6MTYsIi4uL2xpYi9zZXJ2aWNlcy9zdHMiOjYxfV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgZnVuY3Rpb24gYXBpTG9hZGVyKHN2YywgdmVyc2lvbikgewogICAgaWYgKCFhcGlMb2FkZXIuc2VydmljZXMuaGFzT3duUHJvcGVydHkoc3ZjKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWRTZXJ2aWNlOiBGYWlsZWQgdG8gbG9hZCBhcGkgZm9yICcgKyBzdmMpOwogICAgfQogICAgcmV0dXJuIGFwaUxvYWRlci5zZXJ2aWNlc1tzdmNdW3ZlcnNpb25dOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKgogICAqIFRoaXMgbWVtYmVyIG9mIEFXUy5hcGlMb2FkZXIgaXMgcHJpdmF0ZSwgYnV0IGNoYW5naW5nIGl0IHdpbGwgbmVjZXNzaXRhdGUgYQogICAqIGNoYW5nZSB0byAuLi9zY3JpcHRzL3NlcnZpY2VzLXRhYmxlLWdlbmVyYXRvci50cwogICAqLwogIGFwaUxvYWRlci5zZXJ2aWNlcyA9IHt9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gYXBpTG9hZGVyOwogIAogIH0se31dLDEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgSG1hYyA9IHJlcXVpcmUoJy4vYnJvd3NlckhtYWMnKTsKICB2YXIgTWQ1ID0gcmVxdWlyZSgnLi9icm93c2VyTWQ1Jyk7CiAgdmFyIFNoYTEgPSByZXF1aXJlKCcuL2Jyb3dzZXJTaGExJyk7CiAgdmFyIFNoYTI1NiA9IHJlcXVpcmUoJy4vYnJvd3NlclNoYTI1NicpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IHsKICAgICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gY3JlYXRlSGFzaChhbGcpIHsKICAgICAgICBhbGcgPSBhbGcudG9Mb3dlckNhc2UoKTsKICAgICAgICBpZiAoYWxnID09PSAnbWQ1JykgewogICAgICAgICAgcmV0dXJuIG5ldyBNZDUoKTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTI1NicpIHsKICAgICAgICAgIHJldHVybiBuZXcgU2hhMjU2KCk7CiAgICAgICAgfSBlbHNlIGlmIChhbGcgPT09ICdzaGExJykgewogICAgICAgICAgcmV0dXJuIG5ldyBTaGExKCk7CiAgICAgICAgfQogIAogICAgICAgIHRocm93IG5ldyBFcnJvcignSGFzaCBhbGdvcml0aG0gJyArIGFsZyArICcgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBTREsnKTsKICAgICAgfSwKICAgICAgY3JlYXRlSG1hYzogZnVuY3Rpb24gY3JlYXRlSG1hYyhhbGcsIGtleSkgewogICAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICAgIGlmIChhbGcgPT09ICdtZDUnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoTWQ1LCBrZXkpOwogICAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgICAgcmV0dXJuIG5ldyBIbWFjKFNoYTI1Niwga2V5KTsKICAgICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMSwga2V5KTsKICAgICAgICB9CiAgCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdITUFDIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgICB9LAogICAgICBjcmVhdGVTaWduOiBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyZWF0ZVNpZ24gaXMgbm90IGltcGxlbWVudGVkIGluIHRoZSBicm93c2VyJyk7CiAgICAgIH0KICAgIH07CiAgCiAgfSx7Ii4vYnJvd3NlckhtYWMiOjEyLCIuL2Jyb3dzZXJNZDUiOjEzLCIuL2Jyb3dzZXJTaGExIjoxNCwiLi9icm93c2VyU2hhMjU2IjoxNX1dLDExOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICAKICAvKioKICAgKiBUaGlzIGlzIGEgcG9seWZpbGwgZm9yIHRoZSBzdGF0aWMgbWV0aG9kIGBpc1ZpZXdgIG9mIGBBcnJheUJ1ZmZlcmAsIHdoaWNoIGlzCiAgICogZS5nLiBtaXNzaW5nIGluIElFIDEwLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaWYgKAogICAgICB0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICAgIHR5cGVvZiBBcnJheUJ1ZmZlci5pc1ZpZXcgPT09ICd1bmRlZmluZWQnCiAgKSB7CiAgICAgIEFycmF5QnVmZmVyLmlzVmlldyA9IGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgcmV0dXJuIHZpZXdTdHJpbmdzLmluZGV4T2YoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFyZykpID4gLTE7CiAgICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciB2aWV3U3RyaW5ncyA9IFsKICAgICAgJ1tvYmplY3QgSW50OEFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQ4QXJyYXldJywKICAgICAgJ1tvYmplY3QgVWludDhDbGFtcGVkQXJyYXldJywKICAgICAgJ1tvYmplY3QgSW50MTZBcnJheV0nLAogICAgICAnW29iamVjdCBVaW50MTZBcnJheV0nLAogICAgICAnW29iamVjdCBJbnQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IFVpbnQzMkFycmF5XScsCiAgICAgICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nLAogICAgICAnW29iamVjdCBGbG9hdDY0QXJyYXldJywKICAgICAgJ1tvYmplY3QgRGF0YVZpZXddJywKICBdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGlzRW1wdHlEYXRhKGRhdGEpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgICAgcmV0dXJuIGRhdGEubGVuZ3RoID09PSAwOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhLmJ5dGVMZW5ndGggPT09IDA7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIGNvbnZlcnRUb0J1ZmZlcihkYXRhKSB7CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGRhdGEgPSBuZXcgQnVmZmVyKGRhdGEsICd1dGY4Jyk7CiAgICAgIH0KICAKICAgICAgaWYgKEFycmF5QnVmZmVyLmlzVmlldyhkYXRhKSkgewogICAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCAvIFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgICBpc0VtcHR5RGF0YTogaXNFbXB0eURhdGEsCiAgICAgIGNvbnZlcnRUb0J1ZmZlcjogY29udmVydFRvQnVmZmVyLAogIH07CiAgCiAgfSx7ImJ1ZmZlci8iOjgxfV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBIbWFjKGhhc2hDdG9yLCBzZWNyZXQpIHsKICAgICAgdGhpcy5oYXNoID0gbmV3IGhhc2hDdG9yKCk7CiAgICAgIHRoaXMub3V0ZXIgPSBuZXcgaGFzaEN0b3IoKTsKICAKICAgICAgdmFyIGlubmVyID0gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KTsKICAgICAgdmFyIG91dGVyID0gbmV3IFVpbnQ4QXJyYXkoaGFzaEN0b3IuQkxPQ0tfU0laRSk7CiAgICAgIG91dGVyLnNldChpbm5lcik7CiAgCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFzaEN0b3IuQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICBpbm5lcltpXSBePSAweDM2OwogICAgICAgICAgb3V0ZXJbaV0gXj0gMHg1YzsKICAgICAgfQogIAogICAgICB0aGlzLmhhc2gudXBkYXRlKGlubmVyKTsKICAgICAgdGhpcy5vdXRlci51cGRhdGUob3V0ZXIpOwogIAogICAgICAvLyBaZXJvIG91dCB0aGUgY29waWVkIGtleSBidWZmZXIuCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5uZXIuYnl0ZUxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpbm5lcltpXSA9IDA7CiAgICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gSG1hYzsKICAKICBIbWFjLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAodG9IYXNoKSB7CiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEodG9IYXNoKSB8fCB0aGlzLmVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICB0cnkgewogICAgICAgICAgdGhpcy5oYXNoLnVwZGF0ZShoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHRvSGFzaCkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB0aGlzLmVycm9yID0gZTsKICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICB9OwogIAogIEhtYWMucHJvdG90eXBlLmRpZ2VzdCA9IGZ1bmN0aW9uIChlbmNvZGluZykgewogICAgICBpZiAoIXRoaXMub3V0ZXIuZmluaXNoZWQpIHsKICAgICAgICAgIHRoaXMub3V0ZXIudXBkYXRlKHRoaXMuaGFzaC5kaWdlc3QoKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXMub3V0ZXIuZGlnZXN0KGVuY29kaW5nKTsKICB9OwogIAogIGZ1bmN0aW9uIGJ1ZmZlckZyb21TZWNyZXQoaGFzaEN0b3IsIHNlY3JldCkgewogICAgICB2YXIgaW5wdXQgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNlY3JldCk7CiAgICAgIGlmIChpbnB1dC5ieXRlTGVuZ3RoID4gaGFzaEN0b3IuQkxPQ0tfU0laRSkgewogICAgICAgICAgdmFyIGJ1ZmZlckhhc2ggPSBuZXcgaGFzaEN0b3I7CiAgICAgICAgICBidWZmZXJIYXNoLnVwZGF0ZShpbnB1dCk7CiAgICAgICAgICBpbnB1dCA9IGJ1ZmZlckhhc2guZGlnZXN0KCk7CiAgICAgIH0KICAgICAgdmFyIGJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KGhhc2hDdG9yLkJMT0NLX1NJWkUpOwogICAgICBidWZmZXIuc2V0KGlucHV0KTsKICAgICAgcmV0dXJuIGJ1ZmZlcjsKICB9CiAgCiAgfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTF9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIGhhc2hVdGlscyA9IHJlcXVpcmUoJy4vYnJvd3Nlckhhc2hVdGlscycpOwogIHZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwogIAogIHZhciBCTE9DS19TSVpFID0gNjQ7CiAgCiAgdmFyIERJR0VTVF9MRU5HVEggPSAxNjsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2NzQ1MjMwMSwKICAgICAgMHhlZmNkYWI4OSwKICAgICAgMHg5OGJhZGNmZSwKICAgICAgMHgxMDMyNTQ3NiwKICBdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIE1kNSgpIHsKICAgICAgdGhpcy5zdGF0ZSA9IFsKICAgICAgICAgIDB4Njc0NTIzMDEsCiAgICAgICAgICAweGVmY2RhYjg5LAogICAgICAgICAgMHg5OGJhZGNmZSwKICAgICAgICAgIDB4MTAzMjU0NzYsCiAgICAgIF07CiAgICAgIHRoaXMuYnVmZmVyID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihCTE9DS19TSVpFKSk7CiAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCA9IDA7CiAgICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gTWQ1OwogIAogIE1kNS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBNZDUucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uIChzb3VyY2VEYXRhKSB7CiAgICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoc291cmNlRGF0YSkpIHsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICAgIH0KICAKICAgICAgdmFyIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNvdXJjZURhdGEpOwogICAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgICB2YXIgYnl0ZUxlbmd0aCA9IGRhdGEuYnl0ZUxlbmd0aDsKICAgICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDApIHsKICAgICAgICAgIHRoaXMuYnVmZmVyLnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIGRhdGFbcG9zaXRpb24rK10pOwogICAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgTWQ1LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB2YXIgX2EgPSB0aGlzLCBidWZmZXIgPSBfYS5idWZmZXIsIHVuZGVjb3JhdGVkTGVuZ3RoID0gX2EuYnVmZmVyTGVuZ3RoLCBieXRlc0hhc2hlZCA9IF9hLmJ5dGVzSGFzaGVkOwogICAgICAgICAgdmFyIGJpdHNIYXNoZWQgPSBieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgICBidWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgMTI4KTsKICAgICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICBidWZmZXIuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBiaXRzSGFzaGVkID4+PiAwLCB0cnVlKTsKICAgICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgICB9CiAgICAgIHZhciBvdXQgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKERJR0VTVF9MRU5HVEgpKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCA0OyBpKyspIHsKICAgICAgICAgIG91dC5zZXRVaW50MzIoaSAqIDQsIHRoaXMuc3RhdGVbaV0sIHRydWUpOwogICAgICB9CiAgICAgIHZhciBidWZmID0gbmV3IEJ1ZmZlcihvdXQuYnVmZmVyLCBvdXQuYnl0ZU9mZnNldCwgb3V0LmJ5dGVMZW5ndGgpOwogICAgICByZXR1cm4gZW5jb2RpbmcgPyBidWZmLnRvU3RyaW5nKGVuY29kaW5nKSA6IGJ1ZmY7CiAgfTsKICAKICBNZDUucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsIGJ1ZmZlciA9IF9hLmJ1ZmZlciwgc3RhdGUgPSBfYS5zdGF0ZTsKICAgICAgdmFyIGEgPSBzdGF0ZVswXSwgYiA9IHN0YXRlWzFdLCBjID0gc3RhdGVbMl0sIGQgPSBzdGF0ZVszXTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDcsIDB4ZDc2YWE0NzgpOwogICAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgMTIsIDB4ZThjN2I3NTYpOwogICAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMTcsIDB4MjQyMDcwZGIpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDIyLCAweGMxYmRjZWVlKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA3LCAweGY1N2MwZmFmKTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAxMiwgMHg0Nzg3YzYyYSk7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTcsIDB4YTgzMDQ2MTMpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDIyLCAweGZkNDY5NTAxKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA3LCAweDY5ODA5OGQ4KTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAxMiwgMHg4YjQ0ZjdhZik7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQwLCB0cnVlKSwgMTcsIDB4ZmZmZjViYjEpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDIyLCAweDg5NWNkN2JlKTsKICAgICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA3LCAweDZiOTAxMTIyKTsKICAgICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNTIsIHRydWUpLCAxMiwgMHhmZDk4NzE5Myk7CiAgICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTcsIDB4YTY3OTQzOGUpOwogICAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDIyLCAweDQ5YjQwODIxKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDUsIDB4ZjYxZTI1NjIpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDksIDB4YzA0MGIzNDApOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE0LCAweDI2NWU1YTUxKTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDIwLCAweGU5YjZjN2FhKTsKICAgICAgYSA9IGdnKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCA1LCAweGQ2MmYxMDVkKTsKICAgICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCA5LCAweDAyNDQxNDUzKTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxNCwgMHhkOGExZTY4MSk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMjAsIDB4ZTdkM2ZiYzgpOwogICAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDUsIDB4MjFlMWNkZTYpOwogICAgICBkID0gZ2coZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDksIDB4YzMzNzA3ZDYpOwogICAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDE0LCAweGY0ZDUwZDg3KTsKICAgICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCAyMCwgMHg0NTVhMTRlZCk7CiAgICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNSwgMHhhOWUzZTkwNSk7CiAgICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCA5LCAweGZjZWZhM2Y4KTsKICAgICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxNCwgMHg2NzZmMDJkOSk7CiAgICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgMjAsIDB4OGQyYTRjOGEpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDQsIDB4ZmZmYTM5NDIpOwogICAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDExLCAweDg3NzFmNjgxKTsKICAgICAgYyA9IGhoKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxNiwgMHg2ZDlkNjEyMik7CiAgICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMjMsIDB4ZmRlNTM4MGMpOwogICAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNCwgMHhhNGJlZWE0NCk7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgMTEsIDB4NGJkZWNmYTkpOwogICAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDE2LCAweGY2YmI0YjYwKTsKICAgICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAyMywgMHhiZWJmYmM3MCk7CiAgICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgNCwgMHgyODliN2VjNik7CiAgICAgIGQgPSBoaChkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCAxMSwgMHhlYWExMjdmYSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTYsIDB4ZDRlZjMwODUpOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDIzLCAweDA0ODgxZDA1KTsKICAgICAgYSA9IGhoKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCA0LCAweGQ5ZDRkMDM5KTsKICAgICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAxMSwgMHhlNmRiOTllNSk7CiAgICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTYsIDB4MWZhMjdjZjgpOwogICAgICBiID0gaGgoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig4LCB0cnVlKSwgMjMsIDB4YzRhYzU2NjUpOwogICAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNiwgMHhmNDI5MjI0NCk7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTAsIDB4NDMyYWZmOTcpOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig1NiwgdHJ1ZSksIDE1LCAweGFiOTQyM2E3KTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAyMSwgMHhmYzkzYTAzOSk7CiAgICAgIGEgPSBpaShhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQ4LCB0cnVlKSwgNiwgMHg2NTViNTljMyk7CiAgICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTAsIDB4OGYwY2NjOTIpOwogICAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDE1LCAweGZmZWZmNDdkKTsKICAgICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDIxLCAweDg1ODQ1ZGQxKTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCA2LCAweDZmYTg3ZTRmKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxMCwgMHhmZTJjZTZlMCk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTUsIDB4YTMwMTQzMTQpOwogICAgICBiID0gaWkoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDIxLCAweDRlMDgxMWExKTsKICAgICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA2LCAweGY3NTM3ZTgyKTsKICAgICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDQsIHRydWUpLCAxMCwgMHhiZDNhZjIzNSk7CiAgICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNSwgMHgyYWQ3ZDJiYik7CiAgICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgMjEsIDB4ZWI4NmQzOTEpOwogICAgICBzdGF0ZVswXSA9IChhICsgc3RhdGVbMF0pICYgMHhGRkZGRkZGRjsKICAgICAgc3RhdGVbMV0gPSAoYiArIHN0YXRlWzFdKSAmIDB4RkZGRkZGRkY7CiAgICAgIHN0YXRlWzJdID0gKGMgKyBzdGF0ZVsyXSkgJiAweEZGRkZGRkZGOwogICAgICBzdGF0ZVszXSA9IChkICsgc3RhdGVbM10pICYgMHhGRkZGRkZGRjsKICB9OwogIAogIGZ1bmN0aW9uIGNtbihxLCBhLCBiLCB4LCBzLCB0KSB7CiAgICAgIGEgPSAoKChhICsgcSkgJiAweEZGRkZGRkZGKSArICgoeCArIHQpICYgMHhGRkZGRkZGRikpICYgMHhGRkZGRkZGRjsKICAgICAgcmV0dXJuICgoKGEgPDwgcykgfCAoYSA+Pj4gKDMyIC0gcykpKSArIGIpICYgMHhGRkZGRkZGRjsKICB9CiAgCiAgZnVuY3Rpb24gZmYoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKChiICYgYykgfCAoKH5iKSAmIGQpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gZ2coYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKChiICYgZCkgfCAoYyAmICh+ZCkpLCBhLCBiLCB4LCBzLCB0KTsKICB9CiAgCiAgZnVuY3Rpb24gaGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgICByZXR1cm4gY21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIGZ1bmN0aW9uIGlpKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgICAgcmV0dXJuIGNtbihjIF4gKGIgfCAofmQpKSwgYSwgYiwgeCwgcywgdCk7CiAgfQogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MX1dLDE0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDIwOwogIAogIHZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgICAweDVhODI3OTk5LAogICAgICAweDZlZDllYmExLAogICAgICAweDhmMWJiY2RjIHwgMCwKICAgICAgMHhjYTYyYzFkNiB8IDAKICBdKTsKICAKICB2YXIgSU5JVCA9IFsKICAgICAgMHg2YTA5ZTY2NywKICAgICAgMHhiYjY3YWU4NSwKICAgICAgMHgzYzZlZjM3MiwKICAgICAgMHhhNTRmZjUzYSwKICAgICAgMHg1MTBlNTI3ZiwKICAgICAgMHg5YjA1Njg4YywKICAgICAgMHgxZjgzZDlhYiwKICAgICAgMHg1YmUwY2QxOSwKICBdOwogIAogIHZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBTaGExKCkgewogICAgICB0aGlzLmgwID0gMHg2NzQ1MjMwMTsKICAgICAgdGhpcy5oMSA9IDB4RUZDREFCODk7CiAgICAgIHRoaXMuaDIgPSAweDk4QkFEQ0ZFOwogICAgICB0aGlzLmgzID0gMHgxMDMyNTQ3NjsKICAgICAgdGhpcy5oNCA9IDB4QzNEMkUxRjA7CiAgICAgIC8vIFRoZSBmaXJzdCA2NCBieXRlcyAoMTYgd29yZHMpIGlzIHRoZSBkYXRhIGNodW5rCiAgICAgIHRoaXMuYmxvY2sgPSBuZXcgVWludDMyQXJyYXkoODApOwogICAgICB0aGlzLm9mZnNldCA9IDA7CiAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgICAgdGhpcy50b3RhbExlbmd0aCA9IDA7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTE7CiAgCiAgU2hhMS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKICAKICBTaGExLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKICAKICAgICAgdmFyIGxlbmd0aCA9IGRhdGEubGVuZ3RoOwogICAgICB0aGlzLnRvdGFsTGVuZ3RoICs9IGxlbmd0aCAqIDg7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRoaXMud3JpdGUoZGF0YVtpXSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBTaGExLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlKGJ5dGUpIHsKICAgICAgdGhpcy5ibG9ja1t0aGlzLm9mZnNldF0gfD0gKGJ5dGUgJiAweGZmKSA8PCB0aGlzLnNoaWZ0OwogICAgICBpZiAodGhpcy5zaGlmdCkgewogICAgICAgICAgdGhpcy5zaGlmdCAtPSA4OwogICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5vZmZzZXQgPT09IDE2KSB0aGlzLnByb2Nlc3NCbG9jaygpOwogIH07CiAgCiAgU2hhMS5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAgIC8vIFBhZAogICAgICB0aGlzLndyaXRlKDB4ODApOwogICAgICBpZiAodGhpcy5vZmZzZXQgPiAxNCB8fCAodGhpcy5vZmZzZXQgPT09IDE0ICYmIHRoaXMuc2hpZnQgPCAyNCkpIHsKICAgICAgICB0aGlzLnByb2Nlc3NCbG9jaygpOwogICAgICB9CiAgICAgIHRoaXMub2Zmc2V0ID0gMTQ7CiAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAKICAgICAgLy8gNjQtYml0IGxlbmd0aCBiaWctZW5kaWFuCiAgICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIG51bWJlcnMgdGhpcyBiaWcgYXJlbid0IGFjY3VyYXRlIGluIGphdmFzY3JpcHQgYW55d2F5CiAgICAgIHRoaXMud3JpdGUoMHgwMCk7IC8vIC4uU28ganVzdCBoYXJkLWNvZGUgdG8gemVyby4KICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwMDAgOiAweDAwKTsKICAgICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZiA/IHRoaXMudG90YWxMZW5ndGggLyAweDEwMDAwMDAwMCA6IDB4MDApOwogICAgICBmb3IgKHZhciBzID0gMjQ7IHMgPj0gMDsgcyAtPSA4KSB7CiAgICAgICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPj4gcyk7CiAgICAgIH0KICAgICAgLy8gVGhlIHZhbHVlIGluIHN0YXRlIGlzIGxpdHRsZS1lbmRpYW4gcmF0aGVyIHRoYW4gYmlnLWVuZGlhbiwgc28gZmxpcAogICAgICAvLyBlYWNoIHdvcmQgaW50byBhIG5ldyBVaW50OEFycmF5CiAgICAgIHZhciBvdXQgPSBuZXcgQnVmZmVyKERJR0VTVF9MRU5HVEgpOwogICAgICB2YXIgb3V0VmlldyA9IG5ldyBEYXRhVmlldyhvdXQuYnVmZmVyKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMCwgdGhpcy5oMCwgZmFsc2UpOwogICAgICBvdXRWaWV3LnNldFVpbnQzMig0LCB0aGlzLmgxLCBmYWxzZSk7CiAgICAgIG91dFZpZXcuc2V0VWludDMyKDgsIHRoaXMuaDIsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMTIsIHRoaXMuaDMsIGZhbHNlKTsKICAgICAgb3V0Vmlldy5zZXRVaW50MzIoMTYsIHRoaXMuaDQsIGZhbHNlKTsKICAKICAgICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKICB9OwogIAogIFNoYTEucHJvdG90eXBlLnByb2Nlc3NCbG9jayA9IGZ1bmN0aW9uIHByb2Nlc3NCbG9jaygpIHsKICAgICAgLy8gRXh0ZW5kIHRoZSBzaXh0ZWVuIDMyLWJpdCB3b3JkcyBpbnRvIGVpZ2h0eSAzMi1iaXQgd29yZHM6CiAgICAgIGZvciAodmFyIGkgPSAxNjsgaSA8IDgwOyBpKyspIHsKICAgICAgICB2YXIgdyA9IHRoaXMuYmxvY2tbaSAtIDNdIF4gdGhpcy5ibG9ja1tpIC0gOF0gXiB0aGlzLmJsb2NrW2kgLSAxNF0gXiB0aGlzLmJsb2NrW2kgLSAxNl07CiAgICAgICAgdGhpcy5ibG9ja1tpXSA9ICh3IDw8IDEpIHwgKHcgPj4+IDMxKTsKICAgICAgfQogIAogICAgICAvLyBJbml0aWFsaXplIGhhc2ggdmFsdWUgZm9yIHRoaXMgY2h1bms6CiAgICAgIHZhciBhID0gdGhpcy5oMDsKICAgICAgdmFyIGIgPSB0aGlzLmgxOwogICAgICB2YXIgYyA9IHRoaXMuaDI7CiAgICAgIHZhciBkID0gdGhpcy5oMzsKICAgICAgdmFyIGUgPSB0aGlzLmg0OwogICAgICB2YXIgZiwgazsKICAKICAgICAgLy8gTWFpbiBsb29wOgogICAgICBmb3IgKGkgPSAwOyBpIDwgODA7IGkrKykgewogICAgICAgIGlmIChpIDwgMjApIHsKICAgICAgICAgIGYgPSBkIF4gKGIgJiAoYyBeIGQpKTsKICAgICAgICAgIGsgPSAweDVBODI3OTk5OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpIDwgNDApIHsKICAgICAgICAgIGYgPSBiIF4gYyBeIGQ7CiAgICAgICAgICBrID0gMHg2RUQ5RUJBMTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaSA8IDYwKSB7CiAgICAgICAgICBmID0gKGIgJiBjKSB8IChkICYgKGIgfCBjKSk7CiAgICAgICAgICBrID0gMHg4RjFCQkNEQzsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBmID0gYiBeIGMgXiBkOwogICAgICAgICAgayA9IDB4Q0E2MkMxRDY7CiAgICAgICAgfQogICAgICAgIHZhciB0ZW1wID0gKGEgPDwgNSB8IGEgPj4+IDI3KSArIGYgKyBlICsgayArICh0aGlzLmJsb2NrW2ldfDApOwogICAgICAgIGUgPSBkOwogICAgICAgIGQgPSBjOwogICAgICAgIGMgPSAoYiA8PCAzMCB8IGIgPj4+IDIpOwogICAgICAgIGIgPSBhOwogICAgICAgIGEgPSB0ZW1wOwogICAgICB9CiAgCiAgICAgIC8vIEFkZCB0aGlzIGNodW5rJ3MgaGFzaCB0byByZXN1bHQgc28gZmFyOgogICAgICB0aGlzLmgwID0gKHRoaXMuaDAgKyBhKSB8IDA7CiAgICAgIHRoaXMuaDEgPSAodGhpcy5oMSArIGIpIHwgMDsKICAgICAgdGhpcy5oMiA9ICh0aGlzLmgyICsgYykgfCAwOwogICAgICB0aGlzLmgzID0gKHRoaXMuaDMgKyBkKSB8IDA7CiAgICAgIHRoaXMuaDQgPSAodGhpcy5oNCArIGUpIHwgMDsKICAKICAgICAgLy8gVGhlIGJsb2NrIGlzIG5vdyByZXVzYWJsZS4KICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICBmb3IgKGkgPSAwOyBpIDwgMTY7IGkrKykgewogICAgICAgICAgdGhpcy5ibG9ja1tpXSA9IDA7CiAgICAgIH0KICB9OwogIAogIH0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4MX1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKICB2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7CiAgCiAgdmFyIEJMT0NLX1NJWkUgPSA2NDsKICAKICB2YXIgRElHRVNUX0xFTkdUSCA9IDMyOwogIAogIHZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgICAweDQyOGEyZjk4LAogICAgICAweDcxMzc0NDkxLAogICAgICAweGI1YzBmYmNmLAogICAgICAweGU5YjVkYmE1LAogICAgICAweDM5NTZjMjViLAogICAgICAweDU5ZjExMWYxLAogICAgICAweDkyM2Y4MmE0LAogICAgICAweGFiMWM1ZWQ1LAogICAgICAweGQ4MDdhYTk4LAogICAgICAweDEyODM1YjAxLAogICAgICAweDI0MzE4NWJlLAogICAgICAweDU1MGM3ZGMzLAogICAgICAweDcyYmU1ZDc0LAogICAgICAweDgwZGViMWZlLAogICAgICAweDliZGMwNmE3LAogICAgICAweGMxOWJmMTc0LAogICAgICAweGU0OWI2OWMxLAogICAgICAweGVmYmU0Nzg2LAogICAgICAweDBmYzE5ZGM2LAogICAgICAweDI0MGNhMWNjLAogICAgICAweDJkZTkyYzZmLAogICAgICAweDRhNzQ4NGFhLAogICAgICAweDVjYjBhOWRjLAogICAgICAweDc2Zjk4OGRhLAogICAgICAweDk4M2U1MTUyLAogICAgICAweGE4MzFjNjZkLAogICAgICAweGIwMDMyN2M4LAogICAgICAweGJmNTk3ZmM3LAogICAgICAweGM2ZTAwYmYzLAogICAgICAweGQ1YTc5MTQ3LAogICAgICAweDA2Y2E2MzUxLAogICAgICAweDE0MjkyOTY3LAogICAgICAweDI3YjcwYTg1LAogICAgICAweDJlMWIyMTM4LAogICAgICAweDRkMmM2ZGZjLAogICAgICAweDUzMzgwZDEzLAogICAgICAweDY1MGE3MzU0LAogICAgICAweDc2NmEwYWJiLAogICAgICAweDgxYzJjOTJlLAogICAgICAweDkyNzIyYzg1LAogICAgICAweGEyYmZlOGExLAogICAgICAweGE4MWE2NjRiLAogICAgICAweGMyNGI4YjcwLAogICAgICAweGM3NmM1MWEzLAogICAgICAweGQxOTJlODE5LAogICAgICAweGQ2OTkwNjI0LAogICAgICAweGY0MGUzNTg1LAogICAgICAweDEwNmFhMDcwLAogICAgICAweDE5YTRjMTE2LAogICAgICAweDFlMzc2YzA4LAogICAgICAweDI3NDg3NzRjLAogICAgICAweDM0YjBiY2I1LAogICAgICAweDM5MWMwY2IzLAogICAgICAweDRlZDhhYTRhLAogICAgICAweDViOWNjYTRmLAogICAgICAweDY4MmU2ZmYzLAogICAgICAweDc0OGY4MmVlLAogICAgICAweDc4YTU2MzZmLAogICAgICAweDg0Yzg3ODE0LAogICAgICAweDhjYzcwMjA4LAogICAgICAweDkwYmVmZmZhLAogICAgICAweGE0NTA2Y2ViLAogICAgICAweGJlZjlhM2Y3LAogICAgICAweGM2NzE3OGYyCiAgXSk7CiAgCiAgdmFyIElOSVQgPSBbCiAgICAgIDB4NmEwOWU2NjcsCiAgICAgIDB4YmI2N2FlODUsCiAgICAgIDB4M2M2ZWYzNzIsCiAgICAgIDB4YTU0ZmY1M2EsCiAgICAgIDB4NTEwZTUyN2YsCiAgICAgIDB4OWIwNTY4OGMsCiAgICAgIDB4MWY4M2Q5YWIsCiAgICAgIDB4NWJlMGNkMTksCiAgXTsKICAKICB2YXIgTUFYX0hBU0hBQkxFX0xFTkdUSCA9IE1hdGgucG93KDIsIDUzKSAtIDE7CiAgCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBTaGEyNTYoKSB7CiAgICAgIHRoaXMuc3RhdGUgPSBbCiAgICAgICAgICAweDZhMDllNjY3LAogICAgICAgICAgMHhiYjY3YWU4NSwKICAgICAgICAgIDB4M2M2ZWYzNzIsCiAgICAgICAgICAweGE1NGZmNTNhLAogICAgICAgICAgMHg1MTBlNTI3ZiwKICAgICAgICAgIDB4OWIwNTY4OGMsCiAgICAgICAgICAweDFmODNkOWFiLAogICAgICAgICAgMHg1YmUwY2QxOSwKICAgICAgXTsKICAgICAgdGhpcy50ZW1wID0gbmV3IEludDMyQXJyYXkoNjQpOwogICAgICB0aGlzLmJ1ZmZlciA9IG5ldyBVaW50OEFycmF5KDY0KTsKICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICB0aGlzLmJ5dGVzSGFzaGVkID0gMDsKICAgICAgLyoqCiAgICAgICAqIEBwcml2YXRlCiAgICAgICAqLwogICAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTI1NjsKICAKICBTaGEyNTYuQkxPQ0tfU0laRSA9IEJMT0NLX1NJWkU7CiAgCiAgU2hhMjU2LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgICAgfQogIAogICAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogIAogICAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKICAKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGJ5dGVMZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICAgIHRoaXMuYnl0ZXNIYXNoZWQgKz0gYnl0ZUxlbmd0aDsKICAgICAgaWYgKHRoaXMuYnl0ZXNIYXNoZWQgKiA4ID4gTUFYX0hBU0hBQkxFX0xFTkdUSCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGFzaCBtb3JlIHRoYW4gMl41MyAtIDEgYml0cycpOwogICAgICB9CiAgCiAgICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgICAgdGhpcy5idWZmZXJbdGhpcy5idWZmZXJMZW5ndGgrK10gPSBkYXRhW3Bvc2l0aW9uKytdOwogICAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgU2hhMjU2LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgICAgaWYgKCF0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgICB2YXIgYml0c0hhc2hlZCA9IHRoaXMuYnl0ZXNIYXNoZWQgKiA4OwogICAgICAgICAgdmFyIGJ1ZmZlclZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIuYnVmZmVyLCB0aGlzLmJ1ZmZlci5ieXRlT2Zmc2V0LCB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgICAgICAgIHZhciB1bmRlY29yYXRlZExlbmd0aCA9IHRoaXMuYnVmZmVyTGVuZ3RoOwogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAweDgwKTsKICAgICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgICAgaWYgKHVuZGVjb3JhdGVkTGVuZ3RoICUgQkxPQ0tfU0laRSA+PSBCTE9DS19TSVpFIC0gOCkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkU7IGkrKykgewogICAgICAgICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5idWZmZXJMZW5ndGg7IGkgPCBCTE9DS19TSVpFIC0gODsgaSsrKSB7CiAgICAgICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OChpLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIGJ1ZmZlclZpZXcuc2V0VWludDMyKEJMT0NLX1NJWkUgLSA4LCBNYXRoLmZsb29yKGJpdHNIYXNoZWQgLyAweDEwMDAwMDAwMCksIHRydWUpOwogICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIGJpdHNIYXNoZWQpOwogICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgfQogICAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAgIC8vIGVhY2ggd29yZCBpbnRvIGEgbmV3IFVpbnQ4QXJyYXkKICAgICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgICBvdXRbaSAqIDRdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDI0KSAmIDB4ZmY7CiAgICAgICAgICBvdXRbaSAqIDQgKyAxXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAxNikgJiAweGZmOwogICAgICAgICAgb3V0W2kgKiA0ICsgMl0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gOCkgJiAweGZmOwogICAgICAgICAgb3V0W2kgKiA0ICsgM10gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMCkgJiAweGZmOwogICAgICB9CiAgICAgIHJldHVybiBlbmNvZGluZyA/IG91dC50b1N0cmluZyhlbmNvZGluZykgOiBvdXQ7CiAgfTsKICAKICBTaGEyNTYucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBfYSA9IHRoaXMsCiAgICAgICAgICBidWZmZXIgPSBfYS5idWZmZXIsCiAgICAgICAgICBzdGF0ZSA9IF9hLnN0YXRlOwogICAgICB2YXIgc3RhdGUwID0gc3RhdGVbMF0sCiAgICAgICAgICBzdGF0ZTEgPSBzdGF0ZVsxXSwKICAgICAgICAgIHN0YXRlMiA9IHN0YXRlWzJdLAogICAgICAgICAgc3RhdGUzID0gc3RhdGVbM10sCiAgICAgICAgICBzdGF0ZTQgPSBzdGF0ZVs0XSwKICAgICAgICAgIHN0YXRlNSA9IHN0YXRlWzVdLAogICAgICAgICAgc3RhdGU2ID0gc3RhdGVbNl0sCiAgICAgICAgICBzdGF0ZTcgPSBzdGF0ZVs3XTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBCTE9DS19TSVpFOyBpKyspIHsKICAgICAgICAgIGlmIChpIDwgMTYpIHsKICAgICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAoKChidWZmZXJbaSAqIDRdICYgMHhmZikgPDwgMjQpIHwKICAgICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDFdICYgMHhmZikgPDwgMTYpIHwKICAgICAgICAgICAgICAgICAgKChidWZmZXJbKGkgKiA0KSArIDJdICYgMHhmZikgPDwgOCkgfAogICAgICAgICAgICAgICAgICAoYnVmZmVyWyhpICogNCkgKyAzXSAmIDB4ZmYpKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHZhciB1ID0gdGhpcy50ZW1wW2kgLSAyXTsKICAgICAgICAgICAgICB2YXIgdDFfMSA9ICh1ID4+PiAxNyB8IHUgPDwgMTUpIF4KICAgICAgICAgICAgICAgICAgKHUgPj4+IDE5IHwgdSA8PCAxMykgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTApOwogICAgICAgICAgICAgIHUgPSB0aGlzLnRlbXBbaSAtIDE1XTsKICAgICAgICAgICAgICB2YXIgdDJfMSA9ICh1ID4+PiA3IHwgdSA8PCAyNSkgXgogICAgICAgICAgICAgICAgICAodSA+Pj4gMTggfCB1IDw8IDE0KSBeCiAgICAgICAgICAgICAgICAgICh1ID4+PiAzKTsKICAgICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAodDFfMSArIHRoaXMudGVtcFtpIC0gN10gfCAwKSArCiAgICAgICAgICAgICAgICAgICh0Ml8xICsgdGhpcy50ZW1wW2kgLSAxNl0gfCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0MSA9ICgoKCgoc3RhdGU0ID4+PiA2IHwgc3RhdGU0IDw8IDI2KSBeCiAgICAgICAgICAgICAgKHN0YXRlNCA+Pj4gMTEgfCBzdGF0ZTQgPDwgMjEpIF4KICAgICAgICAgICAgICAoc3RhdGU0ID4+PiAyNSB8IHN0YXRlNCA8PCA3KSkKICAgICAgICAgICAgICArICgoc3RhdGU0ICYgc3RhdGU1KSBeICh+c3RhdGU0ICYgc3RhdGU2KSkpIHwgMCkKICAgICAgICAgICAgICArICgoc3RhdGU3ICsgKChLRVlbaV0gKyB0aGlzLnRlbXBbaV0pIHwgMCkpIHwgMCkpIHwgMDsKICAgICAgICAgIHZhciB0MiA9ICgoKHN0YXRlMCA+Pj4gMiB8IHN0YXRlMCA8PCAzMCkgXgogICAgICAgICAgICAgIChzdGF0ZTAgPj4+IDEzIHwgc3RhdGUwIDw8IDE5KSBeCiAgICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMjIgfCBzdGF0ZTAgPDwgMTApKSArICgoc3RhdGUwICYgc3RhdGUxKSBeIChzdGF0ZTAgJiBzdGF0ZTIpIF4gKHN0YXRlMSAmIHN0YXRlMikpKSB8IDA7CiAgICAgICAgICBzdGF0ZTcgPSBzdGF0ZTY7CiAgICAgICAgICBzdGF0ZTYgPSBzdGF0ZTU7CiAgICAgICAgICBzdGF0ZTUgPSBzdGF0ZTQ7CiAgICAgICAgICBzdGF0ZTQgPSAoc3RhdGUzICsgdDEpIHwgMDsKICAgICAgICAgIHN0YXRlMyA9IHN0YXRlMjsKICAgICAgICAgIHN0YXRlMiA9IHN0YXRlMTsKICAgICAgICAgIHN0YXRlMSA9IHN0YXRlMDsKICAgICAgICAgIHN0YXRlMCA9ICh0MSArIHQyKSB8IDA7CiAgICAgIH0KICAgICAgc3RhdGVbMF0gKz0gc3RhdGUwOwogICAgICBzdGF0ZVsxXSArPSBzdGF0ZTE7CiAgICAgIHN0YXRlWzJdICs9IHN0YXRlMjsKICAgICAgc3RhdGVbM10gKz0gc3RhdGUzOwogICAgICBzdGF0ZVs0XSArPSBzdGF0ZTQ7CiAgICAgIHN0YXRlWzVdICs9IHN0YXRlNTsKICAgICAgc3RhdGVbNl0gKz0gc3RhdGU2OwogICAgICBzdGF0ZVs3XSArPSBzdGF0ZTc7CiAgfTsKICAKICB9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODF9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKICAKICAvLyBicm93c2VyIHNwZWNpZmljIG1vZHVsZXMKICB1dGlsLmNyeXB0by5saWIgPSByZXF1aXJlKCcuL2Jyb3dzZXJDcnlwdG9MaWInKTsKICB1dGlsLkJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7CiAgdXRpbC51cmwgPSByZXF1aXJlKCd1cmwvJyk7CiAgdXRpbC5xdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nLycpOwogIHV0aWwucmVhbENsb2NrID0gcmVxdWlyZSgnLi9yZWFsY2xvY2svYnJvd3NlckNsb2NrJyk7CiAgdXRpbC5lbnZpcm9ubWVudCA9ICdqcyc7CiAgdXRpbC5jcmVhdGVFdmVudFN0cmVhbSA9IHJlcXVpcmUoJy4vZXZlbnQtc3RyZWFtL2J1ZmZlcmVkLWNyZWF0ZS1ldmVudC1zdHJlYW0nKS5jcmVhdGVFdmVudFN0cmVhbTsKICB1dGlsLmlzQnJvd3NlciA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfTsKICB1dGlsLmlzTm9kZSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH07CiAgCiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTOwogIAogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4nKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3RlbXBvcmFyeV9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY2hhaW5hYmxlX3RlbXBvcmFyeV9jcmVkZW50aWFscycpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMvd2ViX2lkZW50aXR5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jb2duaXRvX2lkZW50aXR5X2NyZWRlbnRpYWxzJyk7CiAgcmVxdWlyZSgnLi9jcmVkZW50aWFscy9zYW1sX2NyZWRlbnRpYWxzJyk7CiAgCiAgLy8gTG9hZCB0aGUgRE9NUGFyc2VyIFhNTCBwYXJzZXIKICBBV1MuWE1MLlBhcnNlciA9IHJlcXVpcmUoJy4veG1sL2Jyb3dzZXJfcGFyc2VyJyk7CiAgCiAgLy8gTG9hZCB0aGUgWEhSIEh0dHBDbGllbnQKICByZXF1aXJlKCcuL2h0dHAveGhyJyk7CiAgCiAgaWYgKHR5cGVvZiBwcm9jZXNzID09PSAndW5kZWZpbmVkJykgewogICAgdmFyIHByb2Nlc3MgPSB7CiAgICAgIGJyb3dzZXI6IHRydWUKICAgIH07CiAgfQogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9icm93c2VyQ3J5cHRvTGliIjoxMCwiLi9jb3JlIjoxOCwiLi9jcmVkZW50aWFscyI6MTksIi4vY3JlZGVudGlhbHMvY2hhaW5hYmxlX3RlbXBvcmFyeV9jcmVkZW50aWFscyI6MjAsIi4vY3JlZGVudGlhbHMvY29nbml0b19pZGVudGl0eV9jcmVkZW50aWFscyI6MjEsIi4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbiI6MjIsIi4vY3JlZGVudGlhbHMvc2FtbF9jcmVkZW50aWFscyI6MjMsIi4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzIjoyNCwiLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMiOjI1LCIuL2V2ZW50LXN0cmVhbS9idWZmZXJlZC1jcmVhdGUtZXZlbnQtc3RyZWFtIjoyNywiLi9odHRwL3hociI6MzUsIi4vcmVhbGNsb2NrL2Jyb3dzZXJDbG9jayI6NTIsIi4vdXRpbCI6NzEsIi4veG1sL2Jyb3dzZXJfcGFyc2VyIjo3MiwiX3Byb2Nlc3MiOjg2LCJidWZmZXIvIjo4MSwicXVlcnlzdHJpbmcvIjo5MiwidXJsLyI6OTR9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHJlcXVpcmUoJy4vY3JlZGVudGlhbHMnKTsKICByZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4nKTsKICB2YXIgUHJvbWlzZXNEZXBlbmRlbmN5OwogIAogIC8qKgogICAqIFRoZSBtYWluIGNvbmZpZ3VyYXRpb24gY2xhc3MgdXNlZCBieSBhbGwgc2VydmljZSBvYmplY3RzIHRvIHNldAogICAqIHRoZSByZWdpb24sIGNyZWRlbnRpYWxzLCBhbmQgb3RoZXIgb3B0aW9ucyBmb3IgcmVxdWVzdHMuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBjcmVkZW50aWFscyBhbmQgcmVnaW9uIHNldHRpbmdzIGFyZSBsZWZ0IHVuY29uZmlndXJlZC4KICAgKiBUaGlzIHNob3VsZCBiZSBjb25maWd1cmVkIGJ5IHRoZSBhcHBsaWNhdGlvbiBiZWZvcmUgdXNpbmcgYW55CiAgICogQVdTIHNlcnZpY2UgQVBJcy4KICAgKgogICAqIEluIG9yZGVyIHRvIHNldCBnbG9iYWwgY29uZmlndXJhdGlvbiBvcHRpb25zLCBwcm9wZXJ0aWVzIHNob3VsZAogICAqIGJlIGFzc2lnbmVkIHRvIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IG9iamVjdC4KICAgKgogICAqIEBzZWUgQVdTLmNvbmZpZwogICAqCiAgICogQCFncm91cCBHZW5lcmFsIENvbmZpZ3VyYXRpb24gT3B0aW9ucwogICAqCiAgICogQCFhdHRyaWJ1dGUgY3JlZGVudGlhbHMKICAgKiAgIEByZXR1cm4gW0FXUy5DcmVkZW50aWFsc10gdGhlIEFXUyBjcmVkZW50aWFscyB0byBzaWduIHJlcXVlc3RzIHdpdGguCiAgICoKICAgKiBAIWF0dHJpYnV0ZSByZWdpb24KICAgKiAgIEBleGFtcGxlIFNldCB0aGUgZ2xvYmFsIHJlZ2lvbiBzZXR0aW5nIHRvIHVzLXdlc3QtMgogICAqICAgICBBV1MuY29uZmlnLnVwZGF0ZSh7cmVnaW9uOiAndXMtd2VzdC0yJ30pOwogICAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSBUaGUgcmVnaW9uIHRvIHNlbmQgc2VydmljZSByZXF1ZXN0cyB0by4KICAgKiAgIEBzZWUgaHR0cDovL2RvY3MuYW1hem9ud2Vic2VydmljZXMuY29tL2dlbmVyYWwvbGF0ZXN0L2dyL3JhbmRlLmh0bWwKICAgKiAgICAgQSBsaXN0IG9mIGF2YWlsYWJsZSBlbmRwb2ludHMgZm9yIGVhY2ggQVdTIHNlcnZpY2UKICAgKgogICAqIEAhYXR0cmlidXRlIG1heFJldHJpZXMKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZXRyaWVzIHRvIHBlcmZvcm0gZm9yIGEKICAgKiAgICAgc2VydmljZSByZXF1ZXN0LiBCeSBkZWZhdWx0IHRoaXMgdmFsdWUgaXMgY2FsY3VsYXRlZCBieSB0aGUgc3BlY2lmaWMKICAgKiAgICAgc2VydmljZSBvYmplY3QgdGhhdCB0aGUgcmVxdWVzdCBpcyBiZWluZyBtYWRlIHRvLgogICAqCiAgICogQCFhdHRyaWJ1dGUgbWF4UmVkaXJlY3RzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmVkaXJlY3RzIHRvIGZvbGxvdyBmb3IgYQogICAqICAgICBzZXJ2aWNlIHJlcXVlc3QuIERlZmF1bHRzIHRvIDEwLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1WYWxpZGF0aW9uCiAgICogICBAcmV0dXJuIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzIHNob3VsZCBiZSB2YWxpZGF0ZWQgYWdhaW5zdAogICAqICAgICB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZSByZXF1ZXN0LiBEZWZhdWx0cyB0byB0cnVlLgogICAqICAgICBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlIGZvbGxvd2luZyBzcGVjaWZpYyB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAqCiAgICogICAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgKiAgICAgICBjb25zdHJhaW50LiBUaGlzIGlzIGVuYWJsZWQgYnkgZGVmYXVsdCB3aGVuIHBhcmFtVmFsaWRhdGlvbiBpcyBzZXQKICAgKiAgICAgICB0byBgdHJ1ZWAuCiAgICogICAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgKiAgICAgICBjb25zdHJhaW50LgogICAqICAgICAqICoqcGF0dGVybioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgYQogICAqICAgICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgKiAgICAgKiAqKmVudW0qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIG9uZQogICAqICAgICAgIG9mIHRoZSBhbGxvd2FibGUgZW51bSB2YWx1ZXMuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjb21wdXRlQ2hlY2tzdW1zCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbXB1dGUgY2hlY2tzdW1zIGZvciBwYXlsb2FkIGJvZGllcyB3aGVuCiAgICogICAgIHRoZSBzZXJ2aWNlIGFjY2VwdHMgaXQgKGN1cnJlbnRseSBzdXBwb3J0ZWQgaW4gUzMgb25seSkuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBjb252ZXJ0UmVzcG9uc2VUeXBlcwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0eXBlcyBhcmUgY29udmVydGVkIHdoZW4gcGFyc2luZyByZXNwb25zZSBkYXRhLgogICAqICAgICBDdXJyZW50bHkgb25seSBzdXBwb3J0ZWQgZm9yIEpTT04gYmFzZWQgc2VydmljZXMuIFR1cm5pbmcgdGhpcyBvZmYgbWF5CiAgICogICAgIGltcHJvdmUgcGVyZm9ybWFuY2Ugb24gbGFyZ2UgcmVzcG9uc2UgcGF5bG9hZHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIGNvcnJlY3RDbG9ja1NrZXcKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gYXBwbHkgYSBjbG9jayBza2V3IGNvcnJlY3Rpb24gYW5kIHJldHJ5CiAgICogICAgIHJlcXVlc3RzIHRoYXQgZmFpbCBiZWNhdXNlIG9mIGFuIHNrZXdlZCBjbGllbnQgY2xvY2suIERlZmF1bHRzIHRvCiAgICogICAgIGBmYWxzZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzc2xFbmFibGVkCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIFNTTCBpcyBlbmFibGVkIGZvciByZXF1ZXN0cwogICAqCiAgICogQCFhdHRyaWJ1dGUgczNGb3JjZVBhdGhTdHlsZQogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBmb3JjZSBwYXRoIHN0eWxlIFVSTHMgZm9yIFMzIG9iamVjdHMKICAgKgogICAqIEAhYXR0cmlidXRlIHMzQnVja2V0RW5kcG9pbnQKICAgKiAgIEBub3RlIFNldHRpbmcgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiByZXF1aXJlcyBhbiBgZW5kcG9pbnRgIHRvIGJlCiAgICogICAgIHByb3ZpZGVkIGV4cGxpY2l0bHkgdG8gdGhlIHNlcnZpY2UgY29uc3RydWN0b3IuCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBwcm92aWRlZCBlbmRwb2ludCBhZGRyZXNzZXMgYW4gaW5kaXZpZHVhbAogICAqICAgICBidWNrZXQgKGZhbHNlIGlmIGl0IGFkZHJlc3NlcyB0aGUgcm9vdCBBUEkgZW5kcG9pbnQpLgogICAqCiAgICogQCFhdHRyaWJ1dGUgczNEaXNhYmxlQm9keVNpZ25pbmcKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZGlzYWJsZSBTMyBib2R5IHNpZ25pbmcgd2hlbiB1c2luZyBzaWduYXR1cmUgdmVyc2lvbiBgdjRgLgogICAqICAgICBCb2R5IHNpZ25pbmcgY2FuIG9ubHkgYmUgZGlzYWJsZWQgd2hlbiB1c2luZyBodHRwcy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqCiAgICogQCFhdHRyaWJ1dGUgdXNlQWNjZWxlcmF0ZUVuZHBvaW50CiAgICogICBAbm90ZSBUaGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIGlzIG9ubHkgY29tcGF0aWJsZSB3aXRoIFMzIHdoaWxlIGFjY2Vzc2luZwogICAqICAgICBkbnMtY29tcGF0aWJsZSBidWNrZXRzLgogICAqICAgQHJldHVybiBbQm9vbGVhbl0gV2hldGhlciB0byB1c2UgdGhlIEFjY2VsZXJhdGUgZW5kcG9pbnQgd2l0aCB0aGUgUzMgc2VydmljZS4KICAgKiAgICAgRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJldHJ5RGVsYXlPcHRpb25zCiAgICogICBAZXhhbXBsZSBTZXQgdGhlIGJhc2UgcmV0cnkgZGVsYXkgZm9yIGFsbCBzZXJ2aWNlcyB0byAzMDAgbXMKICAgKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JldHJ5RGVsYXlPcHRpb25zOiB7YmFzZTogMzAwfX0pOwogICAqICAgICAvLyBEZWxheXMgd2l0aCBtYXhSZXRyaWVzID0gMzogMzAwLCA2MDAsIDEyMDAKICAgKiAgIEBleGFtcGxlIFNldCBhIGN1c3RvbSBiYWNrb2ZmIGZ1bmN0aW9uIHRvIHByb3ZpZGUgZGVsYXkgdmFsdWVzIG9uIHJldHJpZXMKICAgKiAgICAgQVdTLmNvbmZpZy51cGRhdGUoe3JldHJ5RGVsYXlPcHRpb25zOiB7Y3VzdG9tQmFja29mZjogZnVuY3Rpb24ocmV0cnlDb3VudCkgewogICAqICAgICAgIC8vIHJldHVybnMgZGVsYXkgaW4gbXMKICAgKiAgICAgfX19KTsKICAgKiAgIEByZXR1cm4gW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBjb25maWd1cmUgdGhlIHJldHJ5IGRlbGF5IG9uIHJldHJ5YWJsZSBlcnJvcnMuCiAgICogICAgIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICoKICAgKiAgICAgKiAqKmJhc2UqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgYmFzZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHVzZSBpbiB0aGUKICAgKiAgICAgICBleHBvbmVudGlhbCBiYWNrb2ZmIGZvciBvcGVyYXRpb24gcmV0cmllcy4gRGVmYXVsdHMgdG8gMTAwIG1zIGZvciBhbGwgc2VydmljZXMgZXhjZXB0CiAgICogICAgICAgRHluYW1vREIsIHdoZXJlIGl0IGRlZmF1bHRzIHRvIDUwbXMuCiAgICogICAgICogKipjdXN0b21CYWNrb2ZmICoqIFtmdW5jdGlvbl0gJm1kYXNoOyBBIGN1c3RvbSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYSByZXRyeSBjb3VudAogICAqICAgICAgIGFuZCByZXR1cm5zIHRoZSBhbW91bnQgb2YgdGltZSB0byBkZWxheSBpbiBtaWxsaXNlY29uZHMuIFRoZSBgYmFzZWAgb3B0aW9uIHdpbGwgYmUKICAgKiAgICAgICBpZ25vcmVkIGlmIHRoaXMgb3B0aW9uIGlzIHN1cHBsaWVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cE9wdGlvbnMKICAgKiAgIEByZXR1cm4gW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBwYXNzIHRvIHRoZSBsb3ctbGV2ZWwgSFRUUCByZXF1ZXN0LgogICAqICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAqCiAgICogICAgICogKipwcm94eSoqIFtTdHJpbmddICZtZGFzaDsgdGhlIFVSTCB0byBwcm94eSByZXF1ZXN0cyB0aHJvdWdoCiAgICogICAgICogKiphZ2VudCoqIFtodHRwLkFnZW50LCBodHRwcy5BZ2VudF0gJm1kYXNoOyB0aGUgQWdlbnQgb2JqZWN0IHRvIHBlcmZvcm0KICAgKiAgICAgICBIVFRQIHJlcXVlc3RzIHdpdGguIFVzZWQgZm9yIGNvbm5lY3Rpb24gcG9vbGluZy4gTm90ZSB0aGF0IGZvcgogICAqICAgICAgIFNTTCBjb25uZWN0aW9ucywgYSBzcGVjaWFsIEFnZW50IG9iamVjdCBpcyB1c2VkIGluIG9yZGVyIHRvIGVuYWJsZQogICAqICAgICAgIHBlZXIgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uLiBUaGlzIGZlYXR1cmUgaXMgb25seSBzdXBwb3J0ZWQgaW4gdGhlCiAgICogICAgICAgTm9kZS5qcyBlbnZpcm9ubWVudC4KICAgKiAgICAgKiAqKmNvbm5lY3RUaW1lb3V0KiogW0ludGVnZXJdICZtZGFzaDsgU2V0cyB0aGUgc29ja2V0IHRvIHRpbWVvdXQgYWZ0ZXIKICAgKiAgICAgICBmYWlsaW5nIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyIGFmdGVyCiAgICogICAgICAgYGNvbm5lY3RUaW1lb3V0YCBtaWxsaXNlY29uZHMuIFRoaXMgdGltZW91dCBoYXMgbm8gZWZmZWN0IG9uY2UgYSBzb2NrZXQKICAgKiAgICAgICBjb25uZWN0aW9uIGhhcyBiZWVuIGVzdGFibGlzaGVkLgogICAqICAgICAqICoqdGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyIHRpbWVvdXQKICAgKiAgICAgICBtaWxsaXNlY29uZHMgb2YgaW5hY3Rpdml0eSBvbiB0aGUgc29ja2V0LiBEZWZhdWx0cyB0byB0d28gbWludXRlcwogICAqICAgICAgICgxMjAwMDApCiAgICogICAgICogKip4aHJBc3luYyoqIFtCb29sZWFuXSAmbWRhc2g7IFdoZXRoZXIgdGhlIFNESyB3aWxsIHNlbmQgYXN5bmNocm9ub3VzCiAgICogICAgICAgSFRUUCByZXF1ZXN0cy4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvbmx5LiBTZXQgdG8gZmFsc2UgdG8KICAgKiAgICAgICBzZW5kIHJlcXVlc3RzIHN5bmNocm9ub3VzbHkuIERlZmF1bHRzIHRvIHRydWUgKGFzeW5jIG9uKS4KICAgKiAgICAgKiAqKnhocldpdGhDcmVkZW50aWFscyoqIFtCb29sZWFuXSAmbWRhc2g7IFNldHMgdGhlICJ3aXRoQ3JlZGVudGlhbHMiCiAgICogICAgICAgcHJvcGVydHkgb2YgYW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0LiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50CiAgICogICAgICAgb25seS4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICogQCFhdHRyaWJ1dGUgbG9nZ2VyCiAgICogICBAcmV0dXJuIFsjd3JpdGUsI2xvZ10gYW4gb2JqZWN0IHRoYXQgcmVzcG9uZHMgdG8gLndyaXRlKCkgKGxpa2UgYSBzdHJlYW0pCiAgICogICAgIG9yIC5sb2coKSAobGlrZSB0aGUgY29uc29sZSBvYmplY3QpIGluIG9yZGVyIHRvIGxvZyBpbmZvcm1hdGlvbiBhYm91dAogICAqICAgICByZXF1ZXN0cwogICAqCiAgICogQCFhdHRyaWJ1dGUgc3lzdGVtQ2xvY2tPZmZzZXQKICAgKiAgIEByZXR1cm4gW051bWJlcl0gYW4gb2Zmc2V0IHZhbHVlIGluIG1pbGxpc2Vjb25kcyB0byBhcHBseSB0byBhbGwgc2lnbmluZwogICAqICAgICB0aW1lcy4gVXNlIHRoaXMgdG8gY29tcGVuc2F0ZSBmb3IgY2xvY2sgc2tldyB3aGVuIHlvdXIgc3lzdGVtIG1heSBiZQogICAqICAgICBvdXQgb2Ygc3luYyB3aXRoIHRoZSBzZXJ2aWNlIHRpbWUuIE5vdGUgdGhhdCB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uCiAgICogICAgIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gdGhlIGdsb2JhbCBgQVdTLmNvbmZpZ2Agb2JqZWN0IGFuZCBjYW5ub3QgYmUKICAgKiAgICAgb3ZlcnJpZGRlbiBpbiBzZXJ2aWNlLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24uIERlZmF1bHRzIHRvIDAgbWlsbGlzZWNvbmRzLgogICAqCiAgICogQCFhdHRyaWJ1dGUgc2lnbmF0dXJlVmVyc2lvbgogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgc2lnbmF0dXJlIHZlcnNpb24gdG8gc2lnbiByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nCiAgICogICAgIHRoZSBBUEkgY29uZmlndXJhdGlvbikuIFBvc3NpYmxlIHZhbHVlcyBhcmU6ICd2MicsICd2MycsICd2NCcuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzaWduYXR1cmVDYWNoZQogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgc2lnbmF0dXJlIHRvIHNpZ24gcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZwogICAqICAgICB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pIGlzIGNhY2hlZC4gT25seSBhcHBsaWVzIHRvIHRoZSBzaWduYXR1cmUgdmVyc2lvbiAndjQnLgogICAqICAgICBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQKICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZW5hYmxlIGVuZHBvaW50IGRpc2NvdmVyeSBmb3Igb3BlcmF0aW9ucyB0aGF0CiAgICogICAgIGFsbG93IG9wdGlvbmFsbHkgdXNpbmcgYW4gZW5kcG9pbnQgcmV0dXJuZWQgYnkgdGhlIHNlcnZpY2UuCiAgICogICAgIERlZmF1bHRzIHRvICdmYWxzZScKICAgKgogICAqIEAhYXR0cmlidXRlIGVuZHBvaW50Q2FjaGVTaXplCiAgICogICBAcmV0dXJuIFtOdW1iZXJdIHRoZSBzaXplIG9mIHRoZSBnbG9iYWwgY2FjaGUgc3RvcmluZyBlbmRwb2ludHMgZnJvbSBlbmRwb2ludAogICAqICAgICBkaXNjb3Zlcnkgb3BlcmF0aW9ucy4gT25jZSBlbmRwb2ludCBjYWNoZSBpcyBjcmVhdGVkLCB1cGRhdGluZyB0aGlzIHNldHRpbmcKICAgKiAgICAgY2Fubm90IGNoYW5nZSBleGlzdGluZyBjYWNoZSBzaXplLgogICAqICAgICBEZWZhdWx0cyB0byAxMDAwCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBob3N0UHJlZml4RW5hYmxlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBtYXJzaGFsIHJlcXVlc3QgcGFyYW1ldGVycyB0byB0aGUgcHJlZml4IG9mCiAgICogICAgIGhvc3RuYW1lLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBzdHNSZWdpb25hbEVuZHBvaW50cwogICAqICAgQHJldHVybiBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hldGhlciB0byBzZW5kIHN0cyByZXF1ZXN0IHRvIGdsb2JhbCBlbmRwb2ludHMgb3IKICAgKiAgICAgcmVnaW9uYWwgZW5kcG9pbnRzLgogICAqICAgICBEZWZhdWx0cyB0byAnbGVnYWN5JwogICAqLwogIEFXUy5Db25maWcgPSBBV1MudXRpbC5pbmhlcml0KHsKICAgIC8qKgogICAgICogQCFlbmRncm91cAogICAgICovCiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY29uZmlndXJhdGlvbiBvYmplY3QuIFRoaXMgaXMgdGhlIG9iamVjdCB0aGF0IHBhc3NlcwogICAgICogb3B0aW9uIGRhdGEgYWxvbmcgdG8gc2VydmljZSByZXF1ZXN0cywgaW5jbHVkaW5nIGNyZWRlbnRpYWxzLCBzZWN1cml0eSwKICAgICAqIHJlZ2lvbiBpbmZvcm1hdGlvbiwgYW5kIHNvbWUgc2VydmljZSBzcGVjaWZpYyBzZXR0aW5ncy4KICAgICAqCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjb25maWd1cmF0aW9uIG9iamVjdCB3aXRoIGNyZWRlbnRpYWxzIGFuZCByZWdpb24KICAgICAqICAgdmFyIGNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKHsKICAgICAqICAgICBhY2Nlc3NLZXlJZDogJ0FLSUQnLCBzZWNyZXRBY2Nlc3NLZXk6ICdTRUNSRVQnLCByZWdpb246ICd1cy13ZXN0LTInCiAgICAgKiAgIH0pOwogICAgICogQG9wdGlvbiBvcHRpb25zIGFjY2Vzc0tleUlkIFtTdHJpbmddIHlvdXIgQVdTIGFjY2VzcyBrZXkgSUQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHlvdXIgQVdTIHNlY3JldCBhY2Nlc3Mga2V5LgogICAgICogQG9wdGlvbiBvcHRpb25zIHNlc3Npb25Ub2tlbiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgb3B0aW9uYWwgQVdTCiAgICAgKiAgIHNlc3Npb24gdG9rZW4gdG8gc2lnbiByZXF1ZXN0cyB3aXRoLgogICAgICogQG9wdGlvbiBvcHRpb25zIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBBV1MgY3JlZGVudGlhbHMKICAgICAqICAgdG8gc2lnbiByZXF1ZXN0cyB3aXRoLiBZb3UgY2FuIGVpdGhlciBzcGVjaWZ5IHRoaXMgb2JqZWN0LCBvcgogICAgICogICBzcGVjaWZ5IHRoZSBhY2Nlc3NLZXlJZCBhbmQgc2VjcmV0QWNjZXNzS2V5IG9wdGlvbnMgZGlyZWN0bHkuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY3JlZGVudGlhbFByb3ZpZGVyIFtBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dIHRoZQogICAgICogICBwcm92aWRlciBjaGFpbiB1c2VkIHRvIHJlc29sdmUgY3JlZGVudGlhbHMgaWYgbm8gc3RhdGljIGBjcmVkZW50aWFsc2AKICAgICAqICAgcHJvcGVydHkgaXMgc2V0LgogICAgICogQG9wdGlvbiBvcHRpb25zIHJlZ2lvbiBbU3RyaW5nXSB0aGUgcmVnaW9uIHRvIHNlbmQgc2VydmljZSByZXF1ZXN0cyB0by4KICAgICAqICAgU2VlIHtyZWdpb259IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIG1heFJldHJpZXMgW0ludGVnZXJdIHRoZSBtYXhpbXVtIGFtb3VudCBvZiByZXRyaWVzIHRvCiAgICAgKiAgIGF0dGVtcHQgd2l0aCBhIHJlcXVlc3QuIFNlZSB7bWF4UmV0cmllc30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgbWF4UmVkaXJlY3RzIFtJbnRlZ2VyXSB0aGUgbWF4aW11bSBhbW91bnQgb2YgcmVkaXJlY3RzIHRvCiAgICAgKiAgIGZvbGxvdyB3aXRoIGEgcmVxdWVzdC4gU2VlIHttYXhSZWRpcmVjdHN9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIHNzbEVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZW5hYmxlIFNTTCBmb3IKICAgICAqICAgcmVxdWVzdHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcGFyYW1WYWxpZGF0aW9uIFtCb29sZWFufG1hcF0gd2hldGhlciBpbnB1dCBwYXJhbWV0ZXJzCiAgICAgKiAgIHNob3VsZCBiZSB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nCiAgICAgKiAgIHRoZSByZXF1ZXN0LiBEZWZhdWx0cyB0byB0cnVlLiBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlCiAgICAgKiAgIGZvbGxvd2luZyBzcGVjaWZpYyB2YWxpZGF0aW9uIGZlYXR1cmVzOgogICAgICoKICAgICAqICAgKiAqKm1pbioqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1pbgogICAgICogICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogICAgICogICAgIHRvIGB0cnVlYC4KICAgICAqICAgKiAqKm1heCoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgdmFsdWUgbWVldHMgdGhlIG1heAogICAgICogICAgIGNvbnN0cmFpbnQuCiAgICAgKiAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICAgKiAgICAgcmVndWxhciBleHByZXNzaW9uLgogICAgICogICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAgICAgKiAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjb21wdXRlQ2hlY2tzdW1zIFtCb29sZWFuXSB3aGV0aGVyIHRvIGNvbXB1dGUgY2hlY2tzdW1zCiAgICAgKiAgIGZvciBwYXlsb2FkIGJvZGllcyB3aGVuIHRoZSBzZXJ2aWNlIGFjY2VwdHMgaXQgKGN1cnJlbnRseSBzdXBwb3J0ZWQKICAgICAqICAgaW4gUzMgb25seSkKICAgICAqIEBvcHRpb24gb3B0aW9ucyBjb252ZXJ0UmVzcG9uc2VUeXBlcyBbQm9vbGVhbl0gd2hldGhlciB0eXBlcyBhcmUgY29udmVydGVkCiAgICAgKiAgICAgd2hlbiBwYXJzaW5nIHJlc3BvbnNlIGRhdGEuIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCBmb3IgSlNPTiBiYXNlZAogICAgICogICAgIHNlcnZpY2VzLiBUdXJuaW5nIHRoaXMgb2ZmIG1heSBpbXByb3ZlIHBlcmZvcm1hbmNlIG9uIGxhcmdlIHJlc3BvbnNlCiAgICAgKiAgICAgcGF5bG9hZHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBjb3JyZWN0Q2xvY2tTa2V3IFtCb29sZWFuXSB3aGV0aGVyIHRvIGFwcGx5IGEgY2xvY2sgc2tldwogICAgICogICAgIGNvcnJlY3Rpb24gYW5kIHJldHJ5IHJlcXVlc3RzIHRoYXQgZmFpbCBiZWNhdXNlIG9mIGFuIHNrZXdlZCBjbGllbnQKICAgICAqICAgICBjbG9jay4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzM0ZvcmNlUGF0aFN0eWxlIFtCb29sZWFuXSB3aGV0aGVyIHRvIGZvcmNlIHBhdGgKICAgICAqICAgc3R5bGUgVVJMcyBmb3IgUzMgb2JqZWN0cy4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzM0J1Y2tldEVuZHBvaW50IFtCb29sZWFuXSB3aGV0aGVyIHRoZSBwcm92aWRlZCBlbmRwb2ludAogICAgICogICBhZGRyZXNzZXMgYW4gaW5kaXZpZHVhbCBidWNrZXQgKGZhbHNlIGlmIGl0IGFkZHJlc3NlcyB0aGUgcm9vdCBBUEkKICAgICAqICAgZW5kcG9pbnQpLiBOb3RlIHRoYXQgc2V0dGluZyB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIHJlcXVpcmVzIGFuCiAgICAgKiAgIGBlbmRwb2ludGAgdG8gYmUgcHJvdmlkZWQgZXhwbGljaXRseSB0byB0aGUgc2VydmljZSBjb25zdHJ1Y3Rvci4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBzM0Rpc2FibGVCb2R5U2lnbmluZyBbQm9vbGVhbl0gd2hldGhlciBTMyBib2R5IHNpZ25pbmcKICAgICAqICAgc2hvdWxkIGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgc2lnbmF0dXJlIHZlcnNpb24gYHY0YC4gQm9keSBzaWduaW5nCiAgICAgKiAgIGNhbiBvbmx5IGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgaHR0cHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICAgICAqCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgcmV0cnlEZWxheU9wdGlvbnMgW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBjb25maWd1cmUKICAgICAqICAgdGhlIHJldHJ5IGRlbGF5IG9uIHJldHJ5YWJsZSBlcnJvcnMuIEN1cnJlbnRseSBzdXBwb3J0ZWQgb3B0aW9ucyBhcmU6CiAgICAgKgogICAgICogICAqICoqYmFzZSoqIFtJbnRlZ2VyXSAmbWRhc2g7IFRoZSBiYXNlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdXNlIGluIHRoZQogICAgICogICAgIGV4cG9uZW50aWFsIGJhY2tvZmYgZm9yIG9wZXJhdGlvbiByZXRyaWVzLiBEZWZhdWx0cyB0byAxMDAgbXMgZm9yIGFsbAogICAgICogICAgIHNlcnZpY2VzIGV4Y2VwdCBEeW5hbW9EQiwgd2hlcmUgaXQgZGVmYXVsdHMgdG8gNTBtcy4KICAgICAqICAgKiAqKmN1c3RvbUJhY2tvZmYgKiogW2Z1bmN0aW9uXSAmbWRhc2g7IEEgY3VzdG9tIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBhIHJldHJ5IGNvdW50CiAgICAgKiAgICAgYW5kIHJldHVybnMgdGhlIGFtb3VudCBvZiB0aW1lIHRvIGRlbGF5IGluIG1pbGxpc2Vjb25kcy4gVGhlIGBiYXNlYCBvcHRpb24gd2lsbCBiZQogICAgICogICAgIGlnbm9yZWQgaWYgdGhpcyBvcHRpb24gaXMgc3VwcGxpZWQuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgaHR0cE9wdGlvbnMgW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBwYXNzIHRvIHRoZSBsb3ctbGV2ZWwKICAgICAqICAgSFRUUCByZXF1ZXN0LiBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAgICoKICAgICAqICAgKiAqKnByb3h5KiogW1N0cmluZ10gJm1kYXNoOyB0aGUgVVJMIHRvIHByb3h5IHJlcXVlc3RzIHRocm91Z2gKICAgICAqICAgKiAqKmFnZW50KiogW2h0dHAuQWdlbnQsIGh0dHBzLkFnZW50XSAmbWRhc2g7IHRoZSBBZ2VudCBvYmplY3QgdG8gcGVyZm9ybQogICAgICogICAgIEhUVFAgcmVxdWVzdHMgd2l0aC4gVXNlZCBmb3IgY29ubmVjdGlvbiBwb29saW5nLiBEZWZhdWx0cyB0byB0aGUgZ2xvYmFsCiAgICAgKiAgICAgYWdlbnQgKGBodHRwLmdsb2JhbEFnZW50YCkgZm9yIG5vbi1TU0wgY29ubmVjdGlvbnMuIE5vdGUgdGhhdCBmb3IKICAgICAqICAgICBTU0wgY29ubmVjdGlvbnMsIGEgc3BlY2lhbCBBZ2VudCBvYmplY3QgaXMgdXNlZCBpbiBvcmRlciB0byBlbmFibGUKICAgICAqICAgICBwZWVyIGNlcnRpZmljYXRlIHZlcmlmaWNhdGlvbi4gVGhpcyBmZWF0dXJlIGlzIG9ubHkgYXZhaWxhYmxlIGluIHRoZQogICAgICogICAgIE5vZGUuanMgZW52aXJvbm1lbnQuCiAgICAgKiAgICogKipjb25uZWN0VGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyCiAgICAgKiAgICAgZmFpbGluZyB0byBlc3RhYmxpc2ggYSBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlciBhZnRlcgogICAgICogICAgIGBjb25uZWN0VGltZW91dGAgbWlsbGlzZWNvbmRzLiBUaGlzIHRpbWVvdXQgaGFzIG5vIGVmZmVjdCBvbmNlIGEgc29ja2V0CiAgICAgKiAgICAgY29ubmVjdGlvbiBoYXMgYmVlbiBlc3RhYmxpc2hlZC4KICAgICAqICAgKiAqKnRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlciB0aW1lb3V0CiAgICAgKiAgICAgbWlsbGlzZWNvbmRzIG9mIGluYWN0aXZpdHkgb24gdGhlIHNvY2tldC4gRGVmYXVsdHMgdG8gdHdvIG1pbnV0ZXMKICAgICAqICAgICAoMTIwMDAwKS4KICAgICAqICAgKiAqKnhockFzeW5jKiogW0Jvb2xlYW5dICZtZGFzaDsgV2hldGhlciB0aGUgU0RLIHdpbGwgc2VuZCBhc3luY2hyb25vdXMKICAgICAqICAgICBIVFRQIHJlcXVlc3RzLiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9ubHkuIFNldCB0byBmYWxzZSB0bwogICAgICogICAgIHNlbmQgcmVxdWVzdHMgc3luY2hyb25vdXNseS4gRGVmYXVsdHMgdG8gdHJ1ZSAoYXN5bmMgb24pLgogICAgICogICAqICoqeGhyV2l0aENyZWRlbnRpYWxzKiogW0Jvb2xlYW5dICZtZGFzaDsgU2V0cyB0aGUgIndpdGhDcmVkZW50aWFscyIKICAgICAqICAgICBwcm9wZXJ0eSBvZiBhbiBYTUxIdHRwUmVxdWVzdCBvYmplY3QuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQKICAgICAqICAgICBvbmx5LiBEZWZhdWx0cyB0byBmYWxzZS4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBhcGlWZXJzaW9uIFtTdHJpbmcsIERhdGVdIGEgU3RyaW5nIGluIFlZWVktTU0tREQgZm9ybWF0CiAgICAgKiAgIChvciBhIGRhdGUpIHRoYXQgcmVwcmVzZW50cyB0aGUgbGF0ZXN0IHBvc3NpYmxlIEFQSSB2ZXJzaW9uIHRoYXQgY2FuIGJlCiAgICAgKiAgIHVzZWQgaW4gYWxsIHNlcnZpY2VzICh1bmxlc3Mgb3ZlcnJpZGRlbiBieSBgYXBpVmVyc2lvbnNgKS4gU3BlY2lmeQogICAgICogICAnbGF0ZXN0JyB0byB1c2UgdGhlIGxhdGVzdCBwb3NzaWJsZSB2ZXJzaW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIGFwaVZlcnNpb25zIFttYXA8U3RyaW5nLCBTdHJpbmd8RGF0ZT5dIGEgbWFwIG9mIHNlcnZpY2UKICAgICAqICAgaWRlbnRpZmllcnMgKHRoZSBsb3dlcmNhc2Ugc2VydmljZSBjbGFzcyBuYW1lKSB3aXRoIHRoZSBBUEkgdmVyc2lvbiB0bwogICAgICogICB1c2Ugd2hlbiBpbnN0YW50aWF0aW5nIGEgc2VydmljZS4gU3BlY2lmeSAnbGF0ZXN0JyBmb3IgZWFjaCBpbmRpdmlkdWFsCiAgICAgKiAgIHRoYXQgY2FuIHVzZSB0aGUgbGF0ZXN0IGF2YWlsYWJsZSB2ZXJzaW9uLgogICAgICogQG9wdGlvbiBvcHRpb25zIGxvZ2dlciBbI3dyaXRlLCNsb2ddIGFuIG9iamVjdCB0aGF0IHJlc3BvbmRzIHRvIC53cml0ZSgpCiAgICAgKiAgIChsaWtlIGEgc3RyZWFtKSBvciAubG9nKCkgKGxpa2UgdGhlIGNvbnNvbGUgb2JqZWN0KSBpbiBvcmRlciB0byBsb2cKICAgICAqICAgaW5mb3JtYXRpb24gYWJvdXQgcmVxdWVzdHMKICAgICAqIEBvcHRpb24gb3B0aW9ucyBzeXN0ZW1DbG9ja09mZnNldCBbTnVtYmVyXSBhbiBvZmZzZXQgdmFsdWUgaW4gbWlsbGlzZWNvbmRzCiAgICAgKiAgIHRvIGFwcGx5IHRvIGFsbCBzaWduaW5nIHRpbWVzLiBVc2UgdGhpcyB0byBjb21wZW5zYXRlIGZvciBjbG9jayBza2V3CiAgICAgKiAgIHdoZW4geW91ciBzeXN0ZW0gbWF5IGJlIG91dCBvZiBzeW5jIHdpdGggdGhlIHNlcnZpY2UgdGltZS4gTm90ZSB0aGF0CiAgICAgKiAgIHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24gY2FuIG9ubHkgYmUgYXBwbGllZCB0byB0aGUgZ2xvYmFsIGBBV1MuY29uZmlnYAogICAgICogICBvYmplY3QgYW5kIGNhbm5vdCBiZSBvdmVycmlkZGVuIGluIHNlcnZpY2Utc3BlY2lmaWMgY29uZmlndXJhdGlvbi4KICAgICAqICAgRGVmYXVsdHMgdG8gMCBtaWxsaXNlY29uZHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2lnbmF0dXJlVmVyc2lvbiBbU3RyaW5nXSB0aGUgc2lnbmF0dXJlIHZlcnNpb24gdG8gc2lnbgogICAgICogICByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nIHRoZSBBUEkgY29uZmlndXJhdGlvbikuIFBvc3NpYmxlIHZhbHVlcyBhcmU6CiAgICAgKiAgICd2MicsICd2MycsICd2NCcuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc2lnbmF0dXJlQ2FjaGUgW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHNpZ25hdHVyZSB0byBzaWduCiAgICAgKiAgIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcgdGhlIEFQSSBjb25maWd1cmF0aW9uKSBpcyBjYWNoZWQuIE9ubHkgYXBwbGllcwogICAgICogICB0byB0aGUgc2lnbmF0dXJlIHZlcnNpb24gJ3Y0Jy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAgICogQG9wdGlvbiBvcHRpb25zIGR5bmFtb0RiQ3JjMzIgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gdmFsaWRhdGUgdGhlIENSQzMyCiAgICAgKiAgIGNoZWNrc3VtIG9mIEhUVFAgcmVzcG9uc2UgYm9kaWVzIHJldHVybmVkIGJ5IER5bmFtb0RCLiBEZWZhdWx0OiBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgdXNlQWNjZWxlcmF0ZUVuZHBvaW50IFtCb29sZWFuXSBXaGV0aGVyIHRvIHVzZSB0aGUKICAgICAqICAgUzMgVHJhbnNmZXIgQWNjZWxlcmF0aW9uIGVuZHBvaW50IHdpdGggdGhlIFMzIHNlcnZpY2UuIERlZmF1bHQ6IGBmYWxzZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgY2xpZW50U2lkZU1vbml0b3JpbmcgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29sbGVjdCBhbmQKICAgICAqICAgcHVibGlzaCB0aGlzIGNsaWVudCdzIHBlcmZvcm1hbmNlIG1ldHJpY3Mgb2YgYWxsIGl0cyBBUEkgcmVxdWVzdHMuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkIFtCb29sZWFuXSB3aGV0aGVyIHRvIGVuYWJsZSBlbmRwb2ludAogICAgICogICBkaXNjb3ZlcnkgZm9yIG9wZXJhdGlvbnMgdGhhdCBhbGxvdyBvcHRpb25hbGx5IHVzaW5nIGFuIGVuZHBvaW50IHJldHVybmVkIGJ5CiAgICAgKiAgIHRoZSBzZXJ2aWNlLgogICAgICogICBEZWZhdWx0cyB0byAnZmFsc2UnCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgZW5kcG9pbnRDYWNoZVNpemUgW051bWJlcl0gdGhlIHNpemUgb2YgdGhlIGdsb2JhbCBjYWNoZSBzdG9yaW5nCiAgICAgKiAgIGVuZHBvaW50cyBmcm9tIGVuZHBvaW50IGRpc2NvdmVyeSBvcGVyYXRpb25zLiBPbmNlIGVuZHBvaW50IGNhY2hlIGlzIGNyZWF0ZWQsCiAgICAgKiAgIHVwZGF0aW5nIHRoaXMgc2V0dGluZyBjYW5ub3QgY2hhbmdlIGV4aXN0aW5nIGNhY2hlIHNpemUuCiAgICAgKiAgIERlZmF1bHRzIHRvIDEwMDAKICAgICAqIEBvcHRpb24gb3B0aW9ucyBob3N0UHJlZml4RW5hYmxlZCBbQm9vbGVhbl0gd2hldGhlciB0byBtYXJzaGFsIHJlcXVlc3QKICAgICAqICAgcGFyYW1ldGVycyB0byB0aGUgcHJlZml4IG9mIGhvc3RuYW1lLgogICAgICogICBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICAgKiBAb3B0aW9uIG9wdGlvbnMgc3RzUmVnaW9uYWxFbmRwb2ludHMgWydsZWdhY3knfCdyZWdpb25hbCddIHdoZXRoZXIgdG8gc2VuZCBzdHMgcmVxdWVzdAogICAgICogICB0byBnbG9iYWwgZW5kcG9pbnRzIG9yIHJlZ2lvbmFsIGVuZHBvaW50cy4KICAgICAqICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDb25maWcob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdW5kZWZpbmVkKSBvcHRpb25zID0ge307CiAgICAgIG9wdGlvbnMgPSB0aGlzLmV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKTsKICAKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMua2V5cywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICB0aGlzLnNldChrZXksIG9wdGlvbnNba2V5XSwgdmFsdWUpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhZ3JvdXAgTWFuYWdpbmcgQ3JlZGVudGlhbHMKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBMb2FkcyBjcmVkZW50aWFscyBmcm9tIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4gVGhpcyBpcyB1c2VkIGludGVybmFsbHkKICAgICAqIGJ5IHRoZSBTREsgdG8gZW5zdXJlIHRoYXQgcmVmcmVzaGFibGUge0NyZWRlbnRpYWxzfSBvYmplY3RzIGFyZSBwcm9wZXJseQogICAgICogcmVmcmVzaGVkIGFuZCBsb2FkZWQgd2hlbiBzZW5kaW5nIGEgcmVxdWVzdC4gSWYgeW91IHdhbnQgdG8gZW5zdXJlIHRoYXQKICAgICAqIHlvdXIgY3JlZGVudGlhbHMgYXJlIGxvYWRlZCBwcmlvciB0byBhIHJlcXVlc3QsIHlvdSBjYW4gdXNlIHRoaXMgbWV0aG9kCiAgICAgKiBkaXJlY3RseSB0byBwcm92aWRlIGFjY3VyYXRlIGNyZWRlbnRpYWwgZGF0YSBzdG9yZWQgaW4gdGhlIG9iamVjdC4KICAgICAqCiAgICAgKiBAbm90ZSBJZiB5b3UgY29uZmlndXJlIHRoZSBTREsgd2l0aCBzdGF0aWMgb3IgZW52aXJvbm1lbnQgY3JlZGVudGlhbHMsCiAgICAgKiAgIHRoZSBjcmVkZW50aWFsIGRhdGEgc2hvdWxkIGFscmVhZHkgYmUgcHJlc2VudCBpbiB7Y3JlZGVudGlhbHN9IGF0dHJpYnV0ZS4KICAgICAqICAgVGhpcyBtZXRob2QgaXMgcHJpbWFyaWx5IG5lY2Vzc2FyeSB0byBsb2FkIGNyZWRlbnRpYWxzIGZyb20gYXN5bmNocm9ub3VzCiAgICAgKiAgIHNvdXJjZXMsIG9yIHNvdXJjZXMgdGhhdCBjYW4gcmVmcmVzaCBjcmVkZW50aWFscyBwZXJpb2RpY2FsbHkuCiAgICAgKiBAZXhhbXBsZSBHZXR0aW5nIHlvdXIgYWNjZXNzIGtleQogICAgICogICBBV1MuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uKGVycikgewogICAgICogICAgIGlmIChlcnIpIGNvbnNvbGUubG9nKGVyci5zdGFjayk7IC8vIGNyZWRlbnRpYWxzIG5vdCBsb2FkZWQKICAgICAqICAgICBlbHNlIGNvbnNvbGUubG9nKCJBY2Nlc3MgS2V5OiIsIEFXUy5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQpOwogICAgICogICB9KQogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIHtjcmVkZW50aWFsc30gaGF2ZSBiZWVuIHByb3Blcmx5IHNldCBvbiB0aGUgY29uZmlndXJhdGlvbgogICAgICogICBvYmplY3QuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgdGhpcyBpcyBzZXQsIGNyZWRlbnRpYWxzIHdlcmUgbm90IHN1Y2Nlc3NmdWxseQogICAgICogICAgIGxvYWRlZCBhbmQgdGhpcyBlcnJvciBwcm92aWRlcyBpbmZvcm1hdGlvbiB3aHkuCiAgICAgKiBAc2VlIGNyZWRlbnRpYWxzCiAgICAgKiBAc2VlIENyZWRlbnRpYWxzCiAgICAgKi8KICAgIGdldENyZWRlbnRpYWxzOiBmdW5jdGlvbiBnZXRDcmVkZW50aWFscyhjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICAgIGZ1bmN0aW9uIGZpbmlzaChlcnIpIHsKICAgICAgICBjYWxsYmFjayhlcnIsIGVyciA/IG51bGwgOiBzZWxmLmNyZWRlbnRpYWxzKTsKICAgICAgfQogIAogICAgICBmdW5jdGlvbiBjcmVkRXJyb3IobXNnLCBlcnIpIHsKICAgICAgICByZXR1cm4gbmV3IEFXUy51dGlsLmVycm9yKGVyciB8fCBuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0NyZWRlbnRpYWxzRXJyb3InLAogICAgICAgICAgbWVzc2FnZTogbXNnLAogICAgICAgICAgbmFtZTogJ0NyZWRlbnRpYWxzRXJyb3InCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgZnVuY3Rpb24gZ2V0QXN5bmNDcmVkZW50aWFscygpIHsKICAgICAgICBzZWxmLmNyZWRlbnRpYWxzLmdldChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgdmFyIG1zZyA9ICdDb3VsZCBub3QgbG9hZCBjcmVkZW50aWFscyBmcm9tICcgKwogICAgICAgICAgICAgIHNlbGYuY3JlZGVudGlhbHMuY29uc3RydWN0b3IubmFtZTsKICAgICAgICAgICAgZXJyID0gY3JlZEVycm9yKG1zZywgZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIGZpbmlzaChlcnIpOwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIGZ1bmN0aW9uIGdldFN0YXRpY0NyZWRlbnRpYWxzKCkgewogICAgICAgIHZhciBlcnIgPSBudWxsOwogICAgICAgIGlmICghc2VsZi5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCB8fCAhc2VsZi5jcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkpIHsKICAgICAgICAgIGVyciA9IGNyZWRFcnJvcignTWlzc2luZyBjcmVkZW50aWFscycpOwogICAgICAgIH0KICAgICAgICBmaW5pc2goZXJyKTsKICAgICAgfQogIAogICAgICBpZiAoc2VsZi5jcmVkZW50aWFscykgewogICAgICAgIGlmICh0eXBlb2Ygc2VsZi5jcmVkZW50aWFscy5nZXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGdldEFzeW5jQ3JlZGVudGlhbHMoKTsKICAgICAgICB9IGVsc2UgeyAvLyBzdGF0aWMgY3JlZGVudGlhbHMKICAgICAgICAgIGdldFN0YXRpY0NyZWRlbnRpYWxzKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKHNlbGYuY3JlZGVudGlhbFByb3ZpZGVyKSB7CiAgICAgICAgc2VsZi5jcmVkZW50aWFsUHJvdmlkZXIucmVzb2x2ZShmdW5jdGlvbihlcnIsIGNyZWRzKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIGVyciA9IGNyZWRFcnJvcignQ291bGQgbm90IGxvYWQgY3JlZGVudGlhbHMgZnJvbSBhbnkgcHJvdmlkZXJzJywgZXJyKTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGYuY3JlZGVudGlhbHMgPSBjcmVkczsKICAgICAgICAgIGZpbmlzaChlcnIpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGZpbmlzaChjcmVkRXJyb3IoJ05vIGNyZWRlbnRpYWxzIHRvIGxvYWQnKSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhZ3JvdXAgTG9hZGluZyBhbmQgU2V0dGluZyBDb25maWd1cmF0aW9uIE9wdGlvbnMKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgdXBkYXRlKG9wdGlvbnMsIGFsbG93VW5rbm93bktleXMgPSBmYWxzZSkKICAgICAqICAgVXBkYXRlcyB0aGUgY3VycmVudCBjb25maWd1cmF0aW9uIG9iamVjdCB3aXRoIG5ldyBvcHRpb25zLgogICAgICoKICAgICAqICAgQGV4YW1wbGUgVXBkYXRlIG1heFJldHJpZXMgcHJvcGVydHkgb2YgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICogICAgIGNvbmZpZy51cGRhdGUoe21heFJldHJpZXM6IDEwfSk7CiAgICAgKiAgIEBwYXJhbSBbT2JqZWN0XSBvcHRpb25zIGEgbWFwIG9mIG9wdGlvbiBrZXlzIGFuZCB2YWx1ZXMuCiAgICAgKiAgIEBwYXJhbSBbQm9vbGVhbl0gYWxsb3dVbmtub3duS2V5cyB3aGV0aGVyIHVua25vd24ga2V5cyBjYW4gYmUgc2V0IG9uCiAgICAgKiAgICAgdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAgICogICBAc2VlIGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9wdGlvbnMsIGFsbG93VW5rbm93bktleXMpIHsKICAgICAgYWxsb3dVbmtub3duS2V5cyA9IGFsbG93VW5rbm93bktleXMgfHwgZmFsc2U7CiAgICAgIG9wdGlvbnMgPSB0aGlzLmV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKTsKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGFsbG93VW5rbm93bktleXMgfHwgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMua2V5cywga2V5KSB8fAogICAgICAgICAgICBBV1MuU2VydmljZS5oYXNTZXJ2aWNlKGtleSkpIHsKICAgICAgICAgIHRoaXMuc2V0KGtleSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBMb2FkcyBjb25maWd1cmF0aW9uIGRhdGEgZnJvbSBhIEpTT04gZmlsZSBpbnRvIHRoaXMgY29uZmlnIG9iamVjdC4KICAgICAqIEBub3RlIExvYWRpbmcgY29uZmlndXJhdGlvbiB3aWxsIHJlc2V0IGFsbCBleGlzdGluZyBjb25maWd1cmF0aW9uCiAgICAgKiAgIG9uIHRoZSBvYmplY3QuCiAgICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAgICogQHBhcmFtIHBhdGggW1N0cmluZ10gdGhlIHBhdGggcmVsYXRpdmUgdG8geW91ciBwcm9jZXNzJ3MgY3VycmVudAogICAgICogICAgd29ya2luZyBkaXJlY3RvcnkgdG8gbG9hZCBjb25maWd1cmF0aW9uIGZyb20uCiAgICAgKiBAcmV0dXJuIFtBV1MuQ29uZmlnXSB0aGUgc2FtZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICovCiAgICBsb2FkRnJvbVBhdGg6IGZ1bmN0aW9uIGxvYWRGcm9tUGF0aChwYXRoKSB7CiAgICAgIHRoaXMuY2xlYXIoKTsKICAKICAgICAgdmFyIG9wdGlvbnMgPSBKU09OLnBhcnNlKEFXUy51dGlsLnJlYWRGaWxlU3luYyhwYXRoKSk7CiAgICAgIHZhciBmaWxlU3lzdGVtQ3JlZHMgPSBuZXcgQVdTLkZpbGVTeXN0ZW1DcmVkZW50aWFscyhwYXRoKTsKICAgICAgdmFyIGNoYWluID0gbmV3IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbigpOwogICAgICBjaGFpbi5wcm92aWRlcnMudW5zaGlmdChmaWxlU3lzdGVtQ3JlZHMpOwogICAgICBjaGFpbi5yZXNvbHZlKGZ1bmN0aW9uIChlcnIsIGNyZWRzKSB7CiAgICAgICAgaWYgKGVycikgdGhyb3cgZXJyOwogICAgICAgIGVsc2Ugb3B0aW9ucy5jcmVkZW50aWFscyA9IGNyZWRzOwogICAgICB9KTsKICAKICAgICAgdGhpcy5jb25zdHJ1Y3RvcihvcHRpb25zKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDbGVhcnMgY29uZmlndXJhdGlvbiBkYXRhIG9uIHRoaXMgb2JqZWN0CiAgICAgKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNsZWFyOiBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgLypqc2hpbnQgZm9yaW46ZmFsc2UgKi8KICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMua2V5cywgZnVuY3Rpb24gKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzW2tleV07CiAgICAgIH0pOwogIAogICAgICAvLyByZXNldCBjcmVkZW50aWFsIHByb3ZpZGVyCiAgICAgIHRoaXMuc2V0KCdjcmVkZW50aWFscycsIHVuZGVmaW5lZCk7CiAgICAgIHRoaXMuc2V0KCdjcmVkZW50aWFsUHJvdmlkZXInLCB1bmRlZmluZWQpOwogICAgfSwKICAKICAgIC8qKgogICAgICogU2V0cyBhIHByb3BlcnR5IG9uIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCwgYWxsb3dpbmcgZm9yIGEKICAgICAqIGRlZmF1bHQgdmFsdWUKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChwcm9wZXJ0eSwgdmFsdWUsIGRlZmF1bHRWYWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmIChkZWZhdWx0VmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZGVmYXVsdFZhbHVlID0gdGhpcy5rZXlzW3Byb3BlcnR5XTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBkZWZhdWx0VmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gZGVmYXVsdFZhbHVlLmNhbGwodGhpcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eSA9PT0gJ2h0dHBPcHRpb25zJyAmJiB0aGlzW3Byb3BlcnR5XSkgewogICAgICAgIC8vIGRlZXAgbWVyZ2UgaHR0cE9wdGlvbnMKICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IEFXUy51dGlsLm1lcmdlKHRoaXNbcHJvcGVydHldLCB2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQWxsIG9mIHRoZSBrZXlzIHdpdGggdGhlaXIgZGVmYXVsdCB2YWx1ZXMuCiAgICAgKgogICAgICogQGNvbnN0YW50CiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAga2V5czogewogICAgICBjcmVkZW50aWFsczogbnVsbCwKICAgICAgY3JlZGVudGlhbFByb3ZpZGVyOiBudWxsLAogICAgICByZWdpb246IG51bGwsCiAgICAgIGxvZ2dlcjogbnVsbCwKICAgICAgYXBpVmVyc2lvbnM6IHt9LAogICAgICBhcGlWZXJzaW9uOiBudWxsLAogICAgICBlbmRwb2ludDogdW5kZWZpbmVkLAogICAgICBodHRwT3B0aW9uczogewogICAgICAgIHRpbWVvdXQ6IDEyMDAwMAogICAgICB9LAogICAgICBtYXhSZXRyaWVzOiB1bmRlZmluZWQsCiAgICAgIG1heFJlZGlyZWN0czogMTAsCiAgICAgIHBhcmFtVmFsaWRhdGlvbjogdHJ1ZSwKICAgICAgc3NsRW5hYmxlZDogdHJ1ZSwKICAgICAgczNGb3JjZVBhdGhTdHlsZTogZmFsc2UsCiAgICAgIHMzQnVja2V0RW5kcG9pbnQ6IGZhbHNlLAogICAgICBzM0Rpc2FibGVCb2R5U2lnbmluZzogdHJ1ZSwKICAgICAgY29tcHV0ZUNoZWNrc3VtczogdHJ1ZSwKICAgICAgY29udmVydFJlc3BvbnNlVHlwZXM6IHRydWUsCiAgICAgIGNvcnJlY3RDbG9ja1NrZXc6IGZhbHNlLAogICAgICBjdXN0b21Vc2VyQWdlbnQ6IG51bGwsCiAgICAgIGR5bmFtb0RiQ3JjMzI6IHRydWUsCiAgICAgIHN5c3RlbUNsb2NrT2Zmc2V0OiAwLAogICAgICBzaWduYXR1cmVWZXJzaW9uOiBudWxsLAogICAgICBzaWduYXR1cmVDYWNoZTogdHJ1ZSwKICAgICAgcmV0cnlEZWxheU9wdGlvbnM6IHt9LAogICAgICB1c2VBY2NlbGVyYXRlRW5kcG9pbnQ6IGZhbHNlLAogICAgICBjbGllbnRTaWRlTW9uaXRvcmluZzogZmFsc2UsCiAgICAgIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZDogZmFsc2UsCiAgICAgIGVuZHBvaW50Q2FjaGVTaXplOiAxMDAwLAogICAgICBob3N0UHJlZml4RW5hYmxlZDogdHJ1ZSwKICAgICAgc3RzUmVnaW9uYWxFbmRwb2ludHM6IG51bGwKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEV4dHJhY3RzIGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXkgYW5kIHNlc3Npb25Ub2tlbgogICAgICogZnJvbSBhIGNvbmZpZ3VyYXRpb24gaGFzaC4KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXh0cmFjdENyZWRlbnRpYWxzOiBmdW5jdGlvbiBleHRyYWN0Q3JlZGVudGlhbHMob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucy5hY2Nlc3NLZXlJZCAmJiBvcHRpb25zLnNlY3JldEFjY2Vzc0tleSkgewogICAgICAgIG9wdGlvbnMgPSBBV1MudXRpbC5jb3B5KG9wdGlvbnMpOwogICAgICAgIG9wdGlvbnMuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBvcHRpb25zOwogICAgfSwKICAKICAgIC8qKgogICAgICogU2V0cyB0aGUgcHJvbWlzZSBkZXBlbmRlbmN5IHRoZSBTREsgd2lsbCB1c2Ugd2hlcmV2ZXIgUHJvbWlzZXMgYXJlIHJldHVybmVkLgogICAgICogUGFzc2luZyBgbnVsbGAgd2lsbCBmb3JjZSB0aGUgU0RLIHRvIHVzZSBuYXRpdmUgUHJvbWlzZXMgaWYgdGhleSBhcmUgYXZhaWxhYmxlLgogICAgICogSWYgbmF0aXZlIFByb21pc2VzIGFyZSBub3QgYXZhaWxhYmxlLCBwYXNzaW5nIGBudWxsYCB3aWxsIGhhdmUgbm8gZWZmZWN0LgogICAgICogQHBhcmFtIFtDb25zdHJ1Y3Rvcl0gZGVwIEEgcmVmZXJlbmNlIHRvIGEgUHJvbWlzZSBjb25zdHJ1Y3RvcgogICAgICovCiAgICBzZXRQcm9taXNlc0RlcGVuZGVuY3k6IGZ1bmN0aW9uIHNldFByb21pc2VzRGVwZW5kZW5jeShkZXApIHsKICAgICAgUHJvbWlzZXNEZXBlbmRlbmN5ID0gZGVwOwogICAgICAvLyBpZiBudWxsIHdhcyBwYXNzZWQgaW4sIHdlIHNob3VsZCB0cnkgdG8gdXNlIG5hdGl2ZSBwcm9taXNlcwogICAgICBpZiAoZGVwID09PSBudWxsICYmIHR5cGVvZiBQcm9taXNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgUHJvbWlzZXNEZXBlbmRlbmN5ID0gUHJvbWlzZTsKICAgICAgfQogICAgICB2YXIgY29uc3RydWN0b3JzID0gW0FXUy5SZXF1ZXN0LCBBV1MuQ3JlZGVudGlhbHMsIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl07CiAgICAgIGlmIChBV1MuUzMpIHsKICAgICAgICBjb25zdHJ1Y3RvcnMucHVzaChBV1MuUzMpOwogICAgICAgIGlmIChBV1MuUzMuTWFuYWdlZFVwbG9hZCkgewogICAgICAgICAgY29uc3RydWN0b3JzLnB1c2goQVdTLlMzLk1hbmFnZWRVcGxvYWQpOwogICAgICAgIH0KICAgICAgfQogICAgICBBV1MudXRpbC5hZGRQcm9taXNlcyhjb25zdHJ1Y3RvcnMsIFByb21pc2VzRGVwZW5kZW5jeSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBwcm9taXNlIGRlcGVuZGVuY3kgc2V0IGJ5IGBBV1MuY29uZmlnLnNldFByb21pc2VzRGVwZW5kZW5jeWAuCiAgICAgKi8KICAgIGdldFByb21pc2VzRGVwZW5kZW5jeTogZnVuY3Rpb24gZ2V0UHJvbWlzZXNEZXBlbmRlbmN5KCkgewogICAgICByZXR1cm4gUHJvbWlzZXNEZXBlbmRlbmN5OwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEByZXR1cm4gW0FXUy5Db25maWddIFRoZSBnbG9iYWwgY29uZmlndXJhdGlvbiBvYmplY3Qgc2luZ2xldG9uIGluc3RhbmNlCiAgICogQHJlYWRvbmx5CiAgICogQHNlZSBBV1MuQ29uZmlnCiAgICovCiAgQVdTLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKCk7CiAgCiAgfSx7Ii4vY29yZSI6MTgsIi4vY3JlZGVudGlhbHMiOjE5LCIuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4iOjIyfV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8qKgogICAqIFRoZSBtYWluIEFXUyBuYW1lc3BhY2UKICAgKi8KICB2YXIgQVdTID0geyB1dGlsOiByZXF1aXJlKCcuL3V0aWwnKSB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEAhbWFjcm8gW25ld10gbm9icm93c2VyCiAgICogICBAbm90ZSBUaGlzIGZlYXR1cmUgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvZiB0aGUgU0RLLgogICAqLwogIHZhciBfaGlkZGVuID0ge307IF9oaWRkZW4udG9TdHJpbmcoKTsgLy8gaGFjayB0byBwYXJzZSBtYWNybwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MsIHsKICAKICAgIC8qKgogICAgICogQGNvbnN0YW50CiAgICAgKi8KICAgIFZFUlNJT046ICcyLjU1My4wJywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIFNpZ25lcnM6IHt9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgUHJvdG9jb2w6IHsKICAgICAgSnNvbjogcmVxdWlyZSgnLi9wcm90b2NvbC9qc29uJyksCiAgICAgIFF1ZXJ5OiByZXF1aXJlKCcuL3Byb3RvY29sL3F1ZXJ5JyksCiAgICAgIFJlc3Q6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdCcpLAogICAgICBSZXN0SnNvbjogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X2pzb24nKSwKICAgICAgUmVzdFhtbDogcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0X3htbCcpCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgWE1MOiB7CiAgICAgIEJ1aWxkZXI6IHJlcXVpcmUoJy4veG1sL2J1aWxkZXInKSwKICAgICAgUGFyc2VyOiBudWxsIC8vIGNvbmRpdGlvbmFsbHkgc2V0IGJhc2VkIG9uIGVudmlyb25tZW50CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgSlNPTjogewogICAgICBCdWlsZGVyOiByZXF1aXJlKCcuL2pzb24vYnVpbGRlcicpLAogICAgICBQYXJzZXI6IHJlcXVpcmUoJy4vanNvbi9wYXJzZXInKQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIE1vZGVsOiB7CiAgICAgIEFwaTogcmVxdWlyZSgnLi9tb2RlbC9hcGknKSwKICAgICAgT3BlcmF0aW9uOiByZXF1aXJlKCcuL21vZGVsL29wZXJhdGlvbicpLAogICAgICBTaGFwZTogcmVxdWlyZSgnLi9tb2RlbC9zaGFwZScpLAogICAgICBQYWdpbmF0b3I6IHJlcXVpcmUoJy4vbW9kZWwvcGFnaW5hdG9yJyksCiAgICAgIFJlc291cmNlV2FpdGVyOiByZXF1aXJlKCcuL21vZGVsL3Jlc291cmNlX3dhaXRlcicpCiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBpTG9hZGVyOiByZXF1aXJlKCcuL2FwaV9sb2FkZXInKSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIEVuZHBvaW50Q2FjaGU6IHJlcXVpcmUoJy4uL3ZlbmRvci9lbmRwb2ludC1jYWNoZScpLkVuZHBvaW50Q2FjaGUKICB9KTsKICByZXF1aXJlKCcuL3NlcXVlbnRpYWxfZXhlY3V0b3InKTsKICByZXF1aXJlKCcuL3NlcnZpY2UnKTsKICByZXF1aXJlKCcuL2NvbmZpZycpOwogIHJlcXVpcmUoJy4vaHR0cCcpOwogIHJlcXVpcmUoJy4vZXZlbnRfbGlzdGVuZXJzJyk7CiAgcmVxdWlyZSgnLi9yZXF1ZXN0Jyk7CiAgcmVxdWlyZSgnLi9yZXNwb25zZScpOwogIHJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CiAgcmVxdWlyZSgnLi9zaWduZXJzL3JlcXVlc3Rfc2lnbmVyJyk7CiAgcmVxdWlyZSgnLi9wYXJhbV92YWxpZGF0b3InKTsKICAKICAvKioKICAgKiBAcmVhZG9ubHkKICAgKiBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSBhIGNvbGxlY3Rpb24gb2YgZ2xvYmFsIGV2ZW50IGxpc3RlbmVycyB0aGF0CiAgICogICBhcmUgYXR0YWNoZWQgdG8gZXZlcnkgc2VudCByZXF1ZXN0LgogICAqIEBzZWUgQVdTLlJlcXVlc3QgQVdTLlJlcXVlc3QgZm9yIGEgbGlzdCBvZiBldmVudHMgdG8gbGlzdGVuIGZvcgogICAqIEBleGFtcGxlIExvZ2dpbmcgdGhlIHRpbWUgdGFrZW4gdG8gc2VuZCBhIHJlcXVlc3QKICAgKiAgIEFXUy5ldmVudHMub24oJ3NlbmQnLCBmdW5jdGlvbiBzdGFydFNlbmQocmVzcCkgewogICAqICAgICByZXNwLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAqICAgfSkub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24gY2FsY3VsYXRlVGltZShyZXNwKSB7CiAgICogICAgIHZhciB0aW1lID0gKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gcmVzcC5zdGFydFRpbWUpIC8gMTAwMDsKICAgKiAgICAgY29uc29sZS5sb2coJ1JlcXVlc3QgdG9vayAnICsgdGltZSArICcgc2Vjb25kcycpOwogICAqICAgfSk7CiAgICoKICAgKiAgIG5ldyBBV1MuUzMoKS5saXN0QnVja2V0cygpOyAvLyBwcmludHMgJ1JlcXVlc3QgdG9vayAwLjI4NSBzZWNvbmRzJwogICAqLwogIEFXUy5ldmVudHMgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogIAogIC8vY3JlYXRlIGVuZHBvaW50IGNhY2hlIGxhemlseQogIEFXUy51dGlsLm1lbW9pemVkUHJvcGVydHkoQVdTLCAnZW5kcG9pbnRDYWNoZScsIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBBV1MuRW5kcG9pbnRDYWNoZShBV1MuY29uZmlnLmVuZHBvaW50Q2FjaGVTaXplKTsKICB9LCB0cnVlKTsKICAKICB9LHsiLi4vdmVuZG9yL2VuZHBvaW50LWNhY2hlIjoxMDMsIi4vYXBpX2xvYWRlciI6OSwiLi9jb25maWciOjE3LCIuL2V2ZW50X2xpc3RlbmVycyI6MzMsIi4vaHR0cCI6MzQsIi4vanNvbi9idWlsZGVyIjozNiwiLi9qc29uL3BhcnNlciI6MzcsIi4vbW9kZWwvYXBpIjozOCwiLi9tb2RlbC9vcGVyYXRpb24iOjQwLCIuL21vZGVsL3BhZ2luYXRvciI6NDEsIi4vbW9kZWwvcmVzb3VyY2Vfd2FpdGVyIjo0MiwiLi9tb2RlbC9zaGFwZSI6NDMsIi4vcGFyYW1fdmFsaWRhdG9yIjo0NCwiLi9wcm90b2NvbC9qc29uIjo0NiwiLi9wcm90b2NvbC9xdWVyeSI6NDcsIi4vcHJvdG9jb2wvcmVzdCI6NDgsIi4vcHJvdG9jb2wvcmVzdF9qc29uIjo0OSwiLi9wcm90b2NvbC9yZXN0X3htbCI6NTAsIi4vcmVxdWVzdCI6NTUsIi4vcmVzb3VyY2Vfd2FpdGVyIjo1NiwiLi9yZXNwb25zZSI6NTcsIi4vc2VxdWVudGlhbF9leGVjdXRvciI6NTgsIi4vc2VydmljZSI6NTksIi4vc2lnbmVycy9yZXF1ZXN0X3NpZ25lciI6NjMsIi4vdXRpbCI6NzEsIi4veG1sL2J1aWxkZXIiOjczfV0sMTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIHlvdXIgQVdTIHNlY3VyaXR5IGNyZWRlbnRpYWxzLCBzcGVjaWZpY2FsbHkgdGhlCiAgICoge2FjY2Vzc0tleUlkfSwge3NlY3JldEFjY2Vzc0tleX0sIGFuZCBvcHRpb25hbCB7c2Vzc2lvblRva2VufS4KICAgKiBDcmVhdGluZyBhIGBDcmVkZW50aWFsc2Agb2JqZWN0IGFsbG93cyB5b3UgdG8gcGFzcyBhcm91bmQgeW91cgogICAqIHNlY3VyaXR5IGluZm9ybWF0aW9uIHRvIGNvbmZpZ3VyYXRpb24gYW5kIHNlcnZpY2Ugb2JqZWN0cy4KICAgKgogICAqIE5vdGUgdGhhdCB0aGlzIGNsYXNzIHR5cGljYWxseSBkb2VzIG5vdCBuZWVkIHRvIGJlIGNvbnN0cnVjdGVkIG1hbnVhbGx5LAogICAqIGFzIHRoZSB7QVdTLkNvbmZpZ30gYW5kIHtBV1MuU2VydmljZX0gY2xhc3NlcyBib3RoIGFjY2VwdCBzaW1wbGUKICAgKiBvcHRpb25zIGhhc2hlcyB3aXRoIHRoZSB0aHJlZSBrZXlzLiBUaGVzZSBzdHJ1Y3R1cmVzIHdpbGwgYmUgY29udmVydGVkCiAgICogaW50byBDcmVkZW50aWFscyBvYmplY3RzIGF1dG9tYXRpY2FsbHkuCiAgICoKICAgKiAjIyBFeHBpcmluZyBhbmQgUmVmcmVzaGluZyBDcmVkZW50aWFscwogICAqCiAgICogT2NjYXNpb25hbGx5IGNyZWRlbnRpYWxzIGNhbiBleHBpcmUgaW4gdGhlIG1pZGRsZSBvZiBhIGxvbmctcnVubmluZwogICAqIGFwcGxpY2F0aW9uLiBJbiB0aGlzIGNhc2UsIHRoZSBTREsgd2lsbCBhdXRvbWF0aWNhbGx5IGF0dGVtcHQgdG8KICAgKiByZWZyZXNoIHRoZSBjcmVkZW50aWFscyBmcm9tIHRoZSBzdG9yYWdlIGxvY2F0aW9uIGlmIHRoZSBDcmVkZW50aWFscwogICAqIGNsYXNzIGltcGxlbWVudHMgdGhlIHtyZWZyZXNofSBtZXRob2QuCiAgICoKICAgKiBJZiB5b3UgYXJlIGltcGxlbWVudGluZyBhIGNyZWRlbnRpYWwgc3RvcmFnZSBsb2NhdGlvbiwgeW91CiAgICogd2lsbCB3YW50IHRvIGNyZWF0ZSBhIHN1YmNsYXNzIG9mIHRoZSBgQ3JlZGVudGlhbHNgIGNsYXNzIGFuZAogICAqIG92ZXJyaWRlIHRoZSB7cmVmcmVzaH0gbWV0aG9kLiBUaGlzIG1ldGhvZCBhbGxvd3MgY3JlZGVudGlhbHMgdG8gYmUKICAgKiByZXRyaWV2ZWQgZnJvbSB0aGUgYmFja2luZyBzdG9yZSwgYmUgaXQgYSBmaWxlIHN5c3RlbSwgZGF0YWJhc2UsIG9yCiAgICogc29tZSBuZXR3b3JrIHN0b3JhZ2UuIFRoZSBtZXRob2Qgc2hvdWxkIHJlc2V0IHRoZSBjcmVkZW50aWFsIGF0dHJpYnV0ZXMKICAgKiBvbiB0aGUgb2JqZWN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgZXhwaXJlZAogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGUgY3JlZGVudGlhbHMgaGF2ZSBiZWVuIGV4cGlyZWQgYW5kCiAgICogICAgIHJlcXVpcmUgYSByZWZyZXNoLiBVc2VkIGluIGNvbmp1bmN0aW9uIHdpdGgge2V4cGlyZVRpbWV9LgogICAqIEAhYXR0cmlidXRlIGV4cGlyZVRpbWUKICAgKiAgIEByZXR1cm4gW0RhdGVdIGEgdGltZSB3aGVuIGNyZWRlbnRpYWxzIHNob3VsZCBiZSBjb25zaWRlcmVkIGV4cGlyZWQuIFVzZWQKICAgKiAgICAgaW4gY29uanVuY3Rpb24gd2l0aCB7ZXhwaXJlZH0uCiAgICogQCFhdHRyaWJ1dGUgYWNjZXNzS2V5SWQKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIEFXUyBhY2Nlc3Mga2V5IElECiAgICogQCFhdHRyaWJ1dGUgc2VjcmV0QWNjZXNzS2V5CiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgKiBAIWF0dHJpYnV0ZSBzZXNzaW9uVG9rZW4KICAgKiAgIEByZXR1cm4gW1N0cmluZ10gYW4gb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgKi8KICBBV1MuQ3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KHsKICAgIC8qKgogICAgICogQSBjcmVkZW50aWFscyBvYmplY3QgY2FuIGJlIGNyZWF0ZWQgdXNpbmcgcG9zaXRpb25hbCBhcmd1bWVudHMgb3IgYW4gb3B0aW9ucwogICAgICogaGFzaC4KICAgICAqCiAgICAgKiBAb3ZlcmxvYWQgQVdTLkNyZWRlbnRpYWxzKGFjY2Vzc0tleUlkLCBzZWNyZXRBY2Nlc3NLZXksIHNlc3Npb25Ub2tlbj1udWxsKQogICAgICogICBDcmVhdGVzIGEgQ3JlZGVudGlhbHMgb2JqZWN0IHdpdGggYSBnaXZlbiBzZXQgb2YgY3JlZGVudGlhbCBpbmZvcm1hdGlvbgogICAgICogICBhcyBwb3NpdGlvbmFsIGFyZ3VtZW50cy4KICAgICAqICAgQHBhcmFtIGFjY2Vzc0tleUlkIFtTdHJpbmddIHRoZSBBV1MgYWNjZXNzIGtleSBJRAogICAgICogICBAcGFyYW0gc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHRoZSBBV1Mgc2VjcmV0IGFjY2VzcyBrZXkKICAgICAqICAgQHBhcmFtIHNlc3Npb25Ub2tlbiBbU3RyaW5nXSB0aGUgb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgICAqICAgQGV4YW1wbGUgQ3JlYXRlIGEgY3JlZGVudGlhbHMgb2JqZWN0IHdpdGggQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIGNyZWRzID0gbmV3IEFXUy5DcmVkZW50aWFscygnYWtpZCcsICdzZWNyZXQnLCAnc2Vzc2lvbicpOwogICAgICogQG92ZXJsb2FkIEFXUy5DcmVkZW50aWFscyhvcHRpb25zKQogICAgICogICBDcmVhdGVzIGEgQ3JlZGVudGlhbHMgb2JqZWN0IHdpdGggYSBnaXZlbiBzZXQgb2YgY3JlZGVudGlhbCBpbmZvcm1hdGlvbgogICAgICogICBhcyBhbiBvcHRpb25zIGhhc2guCiAgICAgKiAgIEBvcHRpb24gb3B0aW9ucyBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgICAqICAgQG9wdGlvbiBvcHRpb25zIHNlY3JldEFjY2Vzc0tleSBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAgICAgKiAgIEBvcHRpb24gb3B0aW9ucyBzZXNzaW9uVG9rZW4gW1N0cmluZ10gdGhlIG9wdGlvbmFsIEFXUyBzZXNzaW9uIHRva2VuCiAgICAgKiAgIEBleGFtcGxlIENyZWF0ZSBhIGNyZWRlbnRpYWxzIG9iamVjdCB3aXRoIEFXUyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBjcmVkcyA9IG5ldyBBV1MuQ3JlZGVudGlhbHMoewogICAgICogICAgICAgYWNjZXNzS2V5SWQ6ICdha2lkJywgc2VjcmV0QWNjZXNzS2V5OiAnc2VjcmV0Jywgc2Vzc2lvblRva2VuOiAnc2Vzc2lvbicKICAgICAqICAgICB9KTsKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENyZWRlbnRpYWxzKCkgewogICAgICAvLyBoaWRlIHNlY3JldEFjY2Vzc0tleSBmcm9tIGJlaW5nIGRpc3BsYXllZCB3aXRoIHV0aWwuaW5zcGVjdAogICAgICBBV1MudXRpbC5oaWRlUHJvcGVydGllcyh0aGlzLCBbJ3NlY3JldEFjY2Vzc0tleSddKTsKICAKICAgICAgdGhpcy5leHBpcmVkID0gZmFsc2U7CiAgICAgIHRoaXMuZXhwaXJlVGltZSA9IG51bGw7CiAgICAgIHRoaXMucmVmcmVzaENhbGxiYWNrcyA9IFtdOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnb2JqZWN0JykgewogICAgICAgIHZhciBjcmVkcyA9IGFyZ3VtZW50c1swXS5jcmVkZW50aWFscyB8fCBhcmd1bWVudHNbMF07CiAgICAgICAgdGhpcy5hY2Nlc3NLZXlJZCA9IGNyZWRzLmFjY2Vzc0tleUlkOwogICAgICAgIHRoaXMuc2VjcmV0QWNjZXNzS2V5ID0gY3JlZHMuc2VjcmV0QWNjZXNzS2V5OwogICAgICAgIHRoaXMuc2Vzc2lvblRva2VuID0gY3JlZHMuc2Vzc2lvblRva2VuOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYWNjZXNzS2V5SWQgPSBhcmd1bWVudHNbMF07CiAgICAgICAgdGhpcy5zZWNyZXRBY2Nlc3NLZXkgPSBhcmd1bWVudHNbMV07CiAgICAgICAgdGhpcy5zZXNzaW9uVG9rZW4gPSBhcmd1bWVudHNbMl07CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2Ygc2Vjb25kcyBiZWZvcmUge2V4cGlyZVRpbWV9IGR1cmluZyB3aGljaAogICAgICogICB0aGUgY3JlZGVudGlhbHMgd2lsbCBiZSBjb25zaWRlcmVkIGV4cGlyZWQuCiAgICAgKi8KICAgIGV4cGlyeVdpbmRvdzogMTUsCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIGNyZWRlbnRpYWxzIG9iamVjdCBzaG91bGQgY2FsbCB7cmVmcmVzaH0KICAgICAqIEBub3RlIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHByb3ZpZGUgY3VzdG9tIHJlZnJlc2gKICAgICAqICAgbG9naWMuCiAgICAgKi8KICAgIG5lZWRzUmVmcmVzaDogZnVuY3Rpb24gbmVlZHNSZWZyZXNoKCkgewogICAgICB2YXIgY3VycmVudFRpbWUgPSBBV1MudXRpbC5kYXRlLmdldERhdGUoKS5nZXRUaW1lKCk7CiAgICAgIHZhciBhZGp1c3RlZFRpbWUgPSBuZXcgRGF0ZShjdXJyZW50VGltZSArIHRoaXMuZXhwaXJ5V2luZG93ICogMTAwMCk7CiAgCiAgICAgIGlmICh0aGlzLmV4cGlyZVRpbWUgJiYgYWRqdXN0ZWRUaW1lID4gdGhpcy5leHBpcmVUaW1lKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZXhwaXJlZCB8fCAhdGhpcy5hY2Nlc3NLZXlJZCB8fCAhdGhpcy5zZWNyZXRBY2Nlc3NLZXk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEdldHMgdGhlIGV4aXN0aW5nIGNyZWRlbnRpYWxzLCByZWZyZXNoaW5nIHRoZW0gaWYgdGhleSBhcmUgbm90IHlldCBsb2FkZWQKICAgICAqIG9yIGhhdmUgZXhwaXJlZC4gVXNlcnMgc2hvdWxkIGNhbGwgdGhpcyBtZXRob2QgYmVmb3JlIHVzaW5nIHtyZWZyZXNofSwKICAgICAqIGFzIHRoaXMgd2lsbCBub3QgYXR0ZW1wdCB0byByZWxvYWQgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGFyZSBhbHJlYWR5CiAgICAgKiBsb2FkZWQgaW50byB0aGUgb2JqZWN0LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgZWl0aGVyIGNyZWRlbnRpYWxzCiAgICAgKiAgIGRvIG5vdCBuZWVkIHRvIGJlIHJlZnJlc2hlZCBvciByZWZyZXNoZWQgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzCiAgICAgKiAgIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLAogICAgICogICBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uIGdldChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmICh0aGlzLm5lZWRzUmVmcmVzaCgpKSB7CiAgICAgICAgdGhpcy5yZWZyZXNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgaWYgKCFlcnIpIHNlbGYuZXhwaXJlZCA9IGZhbHNlOyAvLyByZXNldCBleHBpcmVkIGZsYWcKICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChjYWxsYmFjaykgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICBnZXRQcm9taXNlKCkKICAgICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgICAqICAgR2V0cyB0aGUgZXhpc3RpbmcgY3JlZGVudGlhbHMsIHJlZnJlc2hpbmcgdGhlbSBpZiB0aGV5IGFyZSBub3QgeWV0IGxvYWRlZAogICAgICogICBvciBoYXZlIGV4cGlyZWQuIFVzZXJzIHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZSB1c2luZyB7cmVmcmVzaH0sCiAgICAgKiAgIGFzIHRoaXMgd2lsbCBub3QgYXR0ZW1wdCB0byByZWxvYWQgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGFyZSBhbHJlYWR5CiAgICAgKiAgIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QuCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbigpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4gV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCwgaXQKICAgICAqICAgICBtZWFucyBlaXRoZXIgY3JlZGVudGlhbHMgZG8gbm90IG5lZWQgdG8gYmUgcmVmcmVzaGVkIG9yIHJlZnJlc2hlZAogICAgICogICAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZQogICAgICogICAgIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgZ2V0YCBjYWxsLgogICAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgZ2V0UHJvbWlzZWAgbWV0aG9kLgogICAgICogICAgIHZhciBwcm9taXNlID0gY3JlZFByb3ZpZGVyLmdldFByb21pc2UoKTsKICAgICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICByZWZyZXNoUHJvbWlzZSgpCiAgICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKiAgIFJlZnJlc2hlcyB0aGUgY3JlZGVudGlhbHMuIFVzZXJzIHNob3VsZCBjYWxsIHtnZXR9IGJlZm9yZSBhdHRlbXB0aW5nCiAgICAgKiAgIHRvIGZvcmNpYmx5IHJlZnJlc2ggY3JlZGVudGlhbHMuCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbigpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4gV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCwgaXQKICAgICAqICAgICBtZWFucyByZWZyZXNoZWQgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdAogICAgICogICAgIChhcyB0aGUgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIGByZWZyZXNoYCBjYWxsLgogICAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgcmVmcmVzaFByb21pc2VgIG1ldGhvZC4KICAgICAqICAgICB2YXIgcHJvbWlzZSA9IGNyZWRQcm92aWRlci5yZWZyZXNoUHJvbWlzZSgpOwogICAgICogICAgIHByb21pc2UudGhlbihmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICAgKi8KICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIHRoZSBjcmVkZW50aWFscy4gVXNlcnMgc2hvdWxkIGNhbGwge2dldH0gYmVmb3JlIGF0dGVtcHRpbmcKICAgICAqIHRvIGZvcmNpYmx5IHJlZnJlc2ggY3JlZGVudGlhbHMuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyByZWZyZXNoZWQKICAgICAqICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlCiAgICAgKiAgIGBhY2Nlc3NLZXlJZGAsIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQG5vdGUgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcyBjbGFzcyB0byByZXNldCB0aGUKICAgICAqICAge2FjY2Vzc0tleUlkfSwge3NlY3JldEFjY2Vzc0tleX0gYW5kIG9wdGlvbmFsIHtzZXNzaW9uVG9rZW59CiAgICAgKiAgIG9uIHRoZSBjcmVkZW50aWFscyBvYmplY3QgYW5kIHRoZW4gY2FsbCB0aGUgY2FsbGJhY2sgd2l0aAogICAgICogICBhbnkgZXJyb3IgaW5mb3JtYXRpb24uCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuZXhwaXJlZCA9IGZhbHNlOwogICAgICBjYWxsYmFjaygpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgY29hbGVzY2VSZWZyZXNoOiBmdW5jdGlvbiBjb2FsZXNjZVJlZnJlc2goY2FsbGJhY2ssIHN5bmMpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spID09PSAxKSB7CiAgICAgICAgc2VsZi5sb2FkKGZ1bmN0aW9uIG9uTG9hZChlcnIpIHsKICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzZWxmLnJlZnJlc2hDYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmIChzeW5jKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBjYWxsYmFjayBjb3VsZCB0aHJvdywgc28gZGVmZXIgdG8gZW5zdXJlIGFsbCBjYWxsYmFja3MgYXJlIG5vdGlmaWVkCiAgICAgICAgICAgICAgQVdTLnV0aWwuZGVmZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBzZWxmLnJlZnJlc2hDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICBjYWxsYmFjaygpOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFscy5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHRoaXMucHJvdG90eXBlLmdldFByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ2dldCcsIFByb21pc2VEZXBlbmRlbmN5KTsKICAgIHRoaXMucHJvdG90eXBlLnJlZnJlc2hQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdyZWZyZXNoJywgUHJvbWlzZURlcGVuZGVuY3kpOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxzLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUuZ2V0UHJvbWlzZTsKICAgIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5yZWZyZXNoUHJvbWlzZTsKICB9OwogIAogIEFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5DcmVkZW50aWFscyk7CiAgCiAgfSx7Ii4vY29yZSI6MTh9XSwyMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKICAKICAvKioKICAgKiBSZXByZXNlbnRzIHRlbXBvcmFyeSBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSB7QVdTLlNUU30uIFdpdGhvdXQgYW55CiAgICogZXh0cmEgcGFyYW1ldGVycywgY3JlZGVudGlhbHMgd2lsbCBiZSBmZXRjaGVkIGZyb20gdGhlCiAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb24uIElmIGFuIElBTSByb2xlIGlzIHByb3ZpZGVkLCB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcGVyYXRpb24gd2lsbCBiZSB1c2VkIHRvIGZldGNoIGNyZWRlbnRpYWxzIGZvciB0aGUKICAgKiByb2xlIGluc3RlYWQuCiAgICoKICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgZGlmZmVycyBmcm9tIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBpbgogICAqIHRoZSB3YXkgbWFzdGVyQ3JlZGVudGlhbHMgYW5kIHJlZnJlc2hlcyBhcmUgaGFuZGxlZC4KICAgKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgcmVmcmVzaGVzIGV4cGlyZWQgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICogbWFzdGVyQ3JlZGVudGlhbHMgcGFzc2VkIGJ5IHRoZSB1c2VyIHRvIHN1cHBvcnQgY2hhaW5pbmcgb2YgU1RTIGNyZWRlbnRpYWxzLgogICAqIEhvd2V2ZXIsIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyByZWN1cnNpdmVseSBjb2xsYXBzZXMgdGhlIG1hc3RlckNyZWRlbnRpYWxzCiAgICogZHVyaW5nIGluc3RhbnRpYXRpb24sIHByZWNsdWRpbmcgdGhlIGFiaWxpdHkgdG8gcmVmcmVzaCBjcmVkZW50aWFscyB3aGljaAogICAqIHJlcXVpcmUgaW50ZXJtZWRpYXRlLCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgaWYgdGhlIGFwcGxpY2F0aW9uIHNob3VsZCB1c2UgUm9sZUEsIHdoaWNoIG11c3QgYmUgYXNzdW1lZCBmcm9tCiAgICogUm9sZUIsIGFuZCB0aGUgZW52aXJvbm1lbnQgcHJvdmlkZXMgY3JlZGVudGlhbHMgd2hpY2ggY2FuIGFzc3VtZSBSb2xlQiwgdGhlbgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBtdXN0IGJlIHVzZWQgdG8gc3VwcG9ydCByZWZyZXNoaW5nIHRoZQogICAqIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmb3IgUm9sZUE6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogdmFyIHJvbGVBQ3JlZHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgIHBhcmFtczoge1JvbGVBcm46ICdSb2xlQSd9LAogICAqICAgbWFzdGVyQ3JlZGVudGlhbHM6IG5ldyBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMoewogICAqICAgICBwYXJhbXM6IHtSb2xlQXJuOiAnUm9sZUInfSwKICAgKiAgICAgbWFzdGVyQ3JlZGVudGlhbHM6IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJykKICAgKiAgIH0pCiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKiBJZiBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaGFkIGJlZW4gdXNlZCBpbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwKICAgKiBgcm9sZUFDcmVkc2Agd291bGQgZmFpbCB0byByZWZyZXNoIGJlY2F1c2UgYHJvbGVBQ3JlZHNgIHdvdWxkCiAgICogdXNlIHRoZSBlbnZpcm9ubWVudCBjcmVkZW50aWFscyBmb3IgdGhlIEFzc3VtZVJvbGUgcmVxdWVzdC4KICAgKgogICAqIEFub3RoZXIgZGlmZmVyZW5jZSBpcyB0aGF0IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyBjcmVhdGVzIHRoZSBTVFMKICAgKiBzZXJ2aWNlIGluc3RhbmNlIGR1cmluZyBpbnN0YW50aWF0aW9uIHdoaWxlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBjcmVhdGVzCiAgICogdGhlIFNUUyBzZXJ2aWNlIGluc3RhbmNlIGR1cmluZyB0aGUgZmlyc3QgcmVmcmVzaC4gQ3JlYXRpbmcgdGhlIHNlcnZpY2UKICAgKiBpbnN0YW5jZSBkdXJpbmcgaW5zdGFudGlhdGlvbiBlZmZlY3RpdmVseSBjYXB0dXJlcyB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICogZnJvbSB0aGUgZ2xvYmFsIGNvbmZpZywgc28gdGhhdCBzdWJzZXF1ZW50IGNoYW5nZXMgdG8gdGhlIGdsb2JhbCBjb25maWcgZG8KICAgKiBub3QgYWZmZWN0IHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMgdXNlZCB0byByZWZyZXNoIHRoZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAgICoKICAgKiBUaGlzIGFsbG93cyBhbiBpbnN0YW5jZSBvZiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgdG8gYmUgYXNzaWduZWQKICAgKiB0byBBV1MuY29uZmlnLmNyZWRlbnRpYWxzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciBlbnZDcmVkcyA9IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IGVudkNyZWRzOwogICAqIC8vIG1hc3RlckNyZWRlbnRpYWxzIHdpbGwgYmUgZW52Q3JlZHMKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICogICBwYXJhbXM6IHtSb2xlQXJuOiAnLi4uJ30KICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIFNpbWlsYXJseSwgdG8gdXNlIHRoZSBDcmVkZW50aWFsUHJvdmlkZXJDaGFpbidzIGRlZmF1bHQgcHJvdmlkZXJzIGFzIHRoZQogICAqIG1hc3RlciBjcmVkZW50aWFscywgc2ltcGx5IGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogICAqIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IENoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgIHBhcmFtczoge1JvbGVBcm46ICcuLi4nfQogICAqIH0pOwogICAqIGBgYAogICAqCiAgICogQCFhdHRyaWJ1dGUgc2VydmljZQogICAqICAgQHJldHVybiBbQVdTLlNUU10gdGhlIFNUUyBzZXJ2aWNlIGluc3RhbmNlIHVzZWQgdG8KICAgKiAgICAgZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuCiAgICogQG5vdGUgKHNlZSBjb25zdHJ1Y3RvcikKICAgKi8KICBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIG9wdGlvbnMgW21hcF0gYSBzZXQgb2Ygb3B0aW9ucwogICAgICogQG9wdGlvbiBvcHRpb25zIHBhcmFtcyBbbWFwXSAoe30pIGEgbWFwIG9mIG9wdGlvbnMgdGhhdCBhcmUgcGFzc2VkIHRvIHRoZQogICAgICogICB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvciB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbnMuCiAgICAgKiAgIElmIGEgYFJvbGVBcm5gIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIGNyZWRlbnRpYWxzIHdpbGwgYmUgYmFzZWQgb24gdGhlCiAgICAgKiAgIElBTSByb2xlLiBJZiBhIGBTZXJpYWxOdW1iZXJgIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIHt0b2tlbkNvZGVGbn0gbXVzdAogICAgICogICBhbHNvIGJlIHBhc3NlZCBpbiBvciBhbiBlcnJvciB3aWxsIGJlIHRocm93bi4KICAgICAqIEBvcHRpb24gb3B0aW9ucyBtYXN0ZXJDcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICAgKiAgIHVzZWQgdG8gZ2V0IGFuZCByZWZyZXNoIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmcm9tIEFXUyBTVFMuIEJ5IGRlZmF1bHQsCiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgb3IgQVdTLmNvbmZpZy5jcmVkZW50aWFsUHJvdmlkZXIgd2lsbCBiZSB1c2VkLgogICAgICogQG9wdGlvbiBvcHRpb25zIHRva2VuQ29kZUZuIFtGdW5jdGlvbl0gKG51bGwpIEZ1bmN0aW9uIHRvIHByb3ZpZGUKICAgICAqICAgYFRva2VuQ29kZWAsIGlmIGBTZXJpYWxOdW1iZXJgIGlzIHByb3ZpZGVkIGZvciBwcm9maWxlIGluIHtwYXJhbXN9LiBGdW5jdGlvbgogICAgICogICBpcyBjYWxsZWQgd2l0aCB2YWx1ZSBvZiBgU2VyaWFsTnVtYmVyYCBhbmQgYGNhbGxiYWNrYCwgYW5kIHNob3VsZCBwcm92aWRlCiAgICAgKiAgIHRoZSBgVG9rZW5Db2RlYCBvciBhbiBlcnJvciB0byB0aGUgY2FsbGJhY2sgaW4gdGhlIGZvcm1hdAogICAgICogICBgY2FsbGJhY2soZXJyLCB0b2tlbilgLgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBnZW5lcmljIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBhbiBJQU0gcm9sZQogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICAgKiAgICAgcGFyYW1zOiB7CiAgICAgKiAgICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9UZW1wb3JhcnlDcmVkZW50aWFscycKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGUKICAgICAqIEBzZWUgQVdTLlNUUy5nZXRTZXNzaW9uVG9rZW4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKG9wdGlvbnMpIHsKICAgICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLmVycm9yQ29kZSA9ICdDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsc1Byb3ZpZGVyRmFpbHVyZSc7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICAgIHRoaXMudG9rZW5Db2RlRm4gPSBudWxsOwogIAogICAgICB2YXIgcGFyYW1zID0gQVdTLnV0aWwuY29weShvcHRpb25zLnBhcmFtcykgfHwge307CiAgICAgIGlmIChwYXJhbXMuUm9sZUFybikgewogICAgICAgIHBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgPSBwYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd0ZW1wb3JhcnktY3JlZGVudGlhbHMnOwogICAgICB9CiAgICAgIGlmIChwYXJhbXMuU2VyaWFsTnVtYmVyKSB7CiAgICAgICAgaWYgKCFvcHRpb25zLnRva2VuQ29kZUZuIHx8ICh0eXBlb2Ygb3B0aW9ucy50b2tlbkNvZGVGbiAhPT0gJ2Z1bmN0aW9uJykpIHsKICAgICAgICAgIHRocm93IG5ldyBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgbmV3IEVycm9yKCd0b2tlbkNvZGVGbiBtdXN0IGJlIGEgZnVuY3Rpb24gd2hlbiBwYXJhbXMuU2VyaWFsTnVtYmVyIGlzIGdpdmVuJyksCiAgICAgICAgICAgIHtjb2RlOiB0aGlzLmVycm9yQ29kZX0KICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudG9rZW5Db2RlRm4gPSBvcHRpb25zLnRva2VuQ29kZUZuOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgY29uZmlnID0gQVdTLnV0aWwubWVyZ2UoCiAgICAgICAgewogICAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgICBjcmVkZW50aWFsczogb3B0aW9ucy5tYXN0ZXJDcmVkZW50aWFscyB8fCBBV1MuY29uZmlnLmNyZWRlbnRpYWxzCiAgICAgICAgfSwKICAgICAgICBvcHRpb25zLnN0c0NvbmZpZyB8fCB7fQogICAgICApOwogICAgICB0aGlzLnNlcnZpY2UgPSBuZXcgU1RTKGNvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3IKICAgICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0sIGRlcGVuZGluZyBvbiB3aGV0aGVyIGFuIElBTSByb2xlIEFSTiB3YXMgcGFzc2VkCiAgICAgKiB0byB0aGUgY3JlZGVudGlhbHMge2NvbnN0cnVjdG9yfS4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIEFXUy5DcmVkZW50aWFscy5nZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIEBwYXJhbSBjYWxsYmFjawogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHNlbGYuc2VydmljZS5jb25maWcucGFyYW1zLlJvbGVBcm4gPyAnYXNzdW1lUm9sZScgOiAnZ2V0U2Vzc2lvblRva2VuJzsKICAgICAgdGhpcy5nZXRUb2tlbkNvZGUoZnVuY3Rpb24gKGVyciwgdG9rZW5Db2RlKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IHt9OwogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0b2tlbkNvZGUpIHsKICAgICAgICAgIHBhcmFtcy5Ub2tlbkNvZGUgPSB0b2tlbkNvZGU7CiAgICAgICAgfQogICAgICAgIHNlbGYuc2VydmljZVtvcGVyYXRpb25dKHBhcmFtcywgZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFRva2VuQ29kZTogZnVuY3Rpb24gZ2V0VG9rZW5Db2RlKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHRoaXMudG9rZW5Db2RlRm4pIHsKICAgICAgICB0aGlzLnRva2VuQ29kZUZuKHRoaXMuc2VydmljZS5jb25maWcucGFyYW1zLlNlcmlhbE51bWJlciwgZnVuY3Rpb24gKGVyciwgdG9rZW4pIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBlcnI7CiAgICAgICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgICAgIG1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFjaygKICAgICAgICAgICAgICBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgICAgIG5ldyBFcnJvcignRXJyb3IgZmV0Y2hpbmcgTUZBIHRva2VuOiAnICsgbWVzc2FnZSksCiAgICAgICAgICAgICAgICB7IGNvZGU6IHNlbGYuZXJyb3JDb2RlfQogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2sobnVsbCwgdG9rZW4pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrKG51bGwpOwogICAgICB9CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBDb2duaXRvSWRlbnRpdHkgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL2NvZ25pdG9pZGVudGl0eScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFdlYiBJZGVudGl0eSBGZWRlcmF0aW9uIHVzaW5nCiAgICogdGhlIEFtYXpvbiBDb2duaXRvIElkZW50aXR5IHNlcnZpY2UuCiAgICoKICAgKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbiwgd2hpY2gKICAgKiByZXF1aXJlcyBlaXRoZXIgYW4gYElkZW50aXR5SWRgIG9yIGFuIGBJZGVudGl0eVBvb2xJZGAgKEFtYXpvbiBDb2duaXRvCiAgICogSWRlbnRpdHkgUG9vbCBJRCksIHdoaWNoIGlzIHVzZWQgdG8gY2FsbCB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZH0gdG8KICAgKiBvYnRhaW4gYW4gYElkZW50aXR5SWRgLiBJZiB0aGUgaWRlbnRpdHkgb3IgaWRlbnRpdHkgcG9vbCBpcyBub3QgY29uZmlndXJlZCBpbgogICAqIHRoZSBBbWF6b24gQ29nbml0byBDb25zb2xlIHRvIHVzZSBJQU0gcm9sZXMgd2l0aCB0aGUgYXBwcm9wcmlhdGUgcGVybWlzc2lvbnMsCiAgICogdGhlbiBhZGRpdGlvbmFsbHkgYSBgUm9sZUFybmAgaXMgcmVxdWlyZWQgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QKICAgKiBwb2xpY3kgZm9yIHRoZSBBbWF6b24gQ29nbml0byByb2xlIHRoYXQgdGhlIHVzZXIgd2lsbCBsb2cgaW50by4gSWYgYSBgUm9sZUFybmAKICAgKiBpcyBwcm92aWRlZCwgdGhlbiB0aGlzIHByb3ZpZGVyIGdldHMgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAgICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24sIGFmdGVyIGZpcnN0IGdldHRpbmcgYW4KICAgKiBPcGVuIElEIHRva2VuIGZyb20ge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0T3BlbklkVG9rZW59LgogICAqCiAgICogSW4gYWRkaXRpb24sIGlmIHRoaXMgY3JlZGVudGlhbCBwcm92aWRlciBpcyB1c2VkIHRvIHByb3ZpZGUgYXV0aGVudGljYXRlZAogICAqIGxvZ2luLCB0aGUgYExvZ2luc2AgbWFwIG1heSBiZSBzZXQgdG8gdGhlIHRva2VucyBwcm92aWRlZCBieSB0aGUgcmVzcGVjdGl2ZQogICAqIGlkZW50aXR5IHByb3ZpZGVycy4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogICAqIG9iamVjdCB3aXRoIHByb3BlciBwcm9wZXJ0eSB2YWx1ZXMuCiAgICoKICAgKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogICAqCiAgICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogICAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogICAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICAgKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAgICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogICAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAgICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogICAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogICAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFdlYklkZW50aXR5VG9rZW4sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAgICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuTG9naW5zWydncmFwaC5mYWNlYm9vay5jb20nXSA9IHVwZGF0ZWRUb2tlbjsKICAgKiBgYGAKICAgKgogICAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtcwogICAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWR9LAogICAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0sIGFuZAogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4gVG8gdXBkYXRlIHRoZSB0b2tlbiwgc2V0IHRoZQogICAqICAgICBgcGFyYW1zLldlYklkZW50aXR5VG9rZW5gIHByb3BlcnR5LgogICAqIEAhYXR0cmlidXRlIGRhdGEKICAgKiAgIEByZXR1cm4gW21hcF0gdGhlIHJhdyBkYXRhIHJlc3BvbnNlIGZyb20gdGhlIGNhbGwgdG8KICAgKiAgICAge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0sIG9yCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBVc2UgdGhpcyBpZiB5b3Ugd2FudCB0byBnZXQKICAgKiAgICAgYWNjZXNzIHRvIG90aGVyIHByb3BlcnRpZXMgZnJvbSB0aGUgcmVzcG9uc2UuCiAgICogQCFhdHRyaWJ1dGUgaWRlbnRpdHlJZAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQ29nbml0byBJRCByZXR1cm5lZCBieSB0aGUgbGFzdCBjYWxsIHRvCiAgICogICAgIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufS4gVGhpcyBJRCByZXByZXNlbnRzIHRoZSBhY3R1YWwKICAgKiAgICAgZmluYWwgcmVzb2x2ZWQgaWRlbnRpdHkgSUQgZnJvbSBBbWF6b24gQ29nbml0by4KICAgKi8KICBBV1MuQ29nbml0b0lkZW50aXR5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9jYWxTdG9yYWdlS2V5OiB7CiAgICAgIGlkOiAnYXdzLmNvZ25pdG8uaWRlbnRpdHktaWQuJywKICAgICAgcHJvdmlkZXJzOiAnYXdzLmNvZ25pdG8uaWRlbnRpdHktcHJvdmlkZXJzLicKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzKHsKICAgICAqCiAgICAgKiAgICAgLy8gZWl0aGVyIElkZW50aXR5UG9vbElkIG9yIElkZW50aXR5SWQgaXMgcmVxdWlyZWQKICAgICAqICAgICAvLyBTZWUgdGhlIElkZW50aXR5UG9vbElkIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldElEIChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgLy8gU2VlIHRoZSBJZGVudGl0eUlkIHBhcmFtIGZvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkKICAgICAqICAgICAvLyBvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VuIChsaW5rZWQgYmVsb3cpCiAgICAgKiAgICAgSWRlbnRpdHlQb29sSWQ6ICd1cy1lYXN0LTE6MTY5OWViYzAtNzkwMC00MDk5LWI5MTAtMmRmOTRmNTJhMDMwJywKICAgICAqICAgICBJZGVudGl0eUlkOiAndXMtZWFzdC0xOjEyOGQwYTc0LWM4MmYtNDU1My05MTZkLTkwMDUzZTRhOGIwZicKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwsIG9ubHkgbmVjZXNzYXJ5IHdoZW4gdGhlIGlkZW50aXR5IHBvb2wgaXMgbm90IGNvbmZpZ3VyZWQKICAgICAqICAgICAvLyB0byB1c2UgSUFNIHJvbGVzIGluIHRoZSBBbWF6b24gQ29nbml0byBDb25zb2xlCiAgICAgKiAgICAgLy8gU2VlIHRoZSBSb2xlQXJuIHBhcmFtIGZvciBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgKGxpbmtlZCBiZWxvdykKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9NWUFQUC1Db2duaXRvSWRlbnRpdHknLAogICAgICoKICAgICAqICAgICAvLyBvcHRpb25hbCB0b2tlbnMsIHVzZWQgZm9yIGF1dGhlbnRpY2F0ZWQgbG9naW4KICAgICAqICAgICAvLyBTZWUgdGhlIExvZ2lucyBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJRCAobGlua2VkIGJlbG93KQogICAgICogICAgIExvZ2luczogewogICAgICogICAgICAgJ2dyYXBoLmZhY2Vib29rLmNvbSc6ICdGQlRPS0VOJywKICAgICAqICAgICAgICd3d3cuYW1hem9uLmNvbSc6ICdBTUFaT05UT0tFTicsCiAgICAgKiAgICAgICAnYWNjb3VudHMuZ29vZ2xlLmNvbSc6ICdHT09HTEVUT0tFTicsCiAgICAgKiAgICAgICAnYXBpLnR3aXR0ZXIuY29tJzogJ1RXSVRURVJUT0tFTicsCiAgICAgKiAgICAgICAnd3d3LmRpZ2l0cy5jb20nOiAnRElHSVRTVE9LRU4nCiAgICAgKiAgICAgfSwKICAgICAqCiAgICAgKiAgICAgLy8gb3B0aW9uYWwgbmFtZSwgZGVmYXVsdHMgdG8gd2ViLWlkZW50aXR5CiAgICAgKiAgICAgLy8gU2VlIHRoZSBSb2xlU2Vzc2lvbk5hbWUgcGFyYW0gZm9yIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSAobGlua2VkIGJlbG93KQogICAgICogICAgIFJvbGVTZXNzaW9uTmFtZTogJ3dlYicsCiAgICAgKgogICAgICogICAgIC8vIG9wdGlvbmFsLCBvbmx5IG5lY2Vzc2FyeSB3aGVuIGFwcGxpY2F0aW9uIHJ1bnMgaW4gYSBicm93c2VyCiAgICAgKiAgICAgLy8gYW5kIG11bHRpcGxlIHVzZXJzIGFyZSBzaWduZWQgaW4gYXQgb25jZSwgdXNlZCBmb3IgY2FjaGluZwogICAgICogICAgIExvZ2luSWQ6ICdleGFtcGxlQGdtYWlsLmNvbScKICAgICAqCiAgICAgKiAgIH0sIHsKICAgICAqICAgICAgLy8gb3B0aW9uYWxseSBwcm92aWRlIGNvbmZpZ3VyYXRpb24gdG8gYXBwbHkgdG8gdGhlIHVuZGVybHlpbmcgc2VydmljZSBjbGllbnRzCiAgICAgKiAgICAgIC8vIGlmIGNvbmZpZ3VyYXRpb24gaXMgbm90IHByb3ZpZGVkLCB0aGVuIGNvbmZpZ3VyYXRpb24gd2lsbCBiZSBwdWxsZWQgZnJvbSBBV1MuY29uZmlnCiAgICAgKgogICAgICogICAgICAvLyByZWdpb24gc2hvdWxkIG1hdGNoIHRoZSByZWdpb24geW91ciBpZGVudGl0eSBwb29sIGlzIGxvY2F0ZWQgaW4KICAgICAqICAgICAgcmVnaW9uOiAndXMtZWFzdC0xJywKICAgICAqCiAgICAgKiAgICAgIC8vIHNwZWNpZnkgdGltZW91dCBvcHRpb25zCiAgICAgKiAgICAgIGh0dHBPcHRpb25zOiB7CiAgICAgKiAgICAgICAgdGltZW91dDogMTAwCiAgICAgKiAgICAgIH0KICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWQKICAgICAqIEBzZWUgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eQogICAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VuCiAgICAgKiBAc2VlIEFXUy5Db25maWcKICAgICAqIEBub3RlIElmIGEgcmVnaW9uIGlzIG5vdCBwcm92aWRlZCBpbiB0aGUgZ2xvYmFsIEFXUy5jb25maWcsIG9yCiAgICAgKiAgIHNwZWNpZmllZCBpbiB0aGUgYGNsaWVudENvbmZpZ2AgdG8gdGhlIENvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzCiAgICAgKiAgIGNvbnN0cnVjdG9yLCB5b3UgbWF5IGVuY291bnRlciBhICdNaXNzaW5nIGNyZWRlbnRpYWxzIGluIGNvbmZpZycgZXJyb3IKICAgICAqICAgd2hlbiBjYWxsaW5nIG1ha2luZyBhIHNlcnZpY2UgY2FsbC4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzKHBhcmFtcywgY2xpZW50Q29uZmlnKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5faWRlbnRpdHlJZCA9IG51bGw7CiAgICAgIHRoaXMuX2NsaWVudENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY2xpZW50Q29uZmlnIHx8IHt9KTsKICAgICAgdGhpcy5sb2FkQ2FjaGVkSWQoKTsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2lkZW50aXR5SWQnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYubG9hZENhY2hlZElkKCk7CiAgICAgICAgICByZXR1cm4gc2VsZi5faWRlbnRpdHlJZCB8fCBzZWxmLnBhcmFtcy5JZGVudGl0eUlkOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihpZGVudGl0eUlkKSB7CiAgICAgICAgICBzZWxmLl9pZGVudGl0eUlkID0gaWRlbnRpdHlJZDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogUmVmcmVzaGVzIGNyZWRlbnRpYWxzIHVzaW5nIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHl9LAogICAgICogb3Ige0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBBV1MuQ3JlZGVudGlhbHMuZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLmRhdGEgPSBudWxsOwogICAgICBzZWxmLl9pZGVudGl0eUlkID0gbnVsbDsKICAgICAgc2VsZi5nZXRJZChmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgaWYgKCFzZWxmLnBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgICAgICAgIHNlbGYuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShjYWxsYmFjayk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLmdldENyZWRlbnRpYWxzRnJvbVNUUyhjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQ2xlYXJzIHRoZSBjYWNoZWQgQ29nbml0byBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIGN1cnJlbnRseSBjb25maWd1cmVkCiAgICAgKiBpZGVudGl0eSBwb29sIElELiBVc2UgdGhpcyB0byBtYW51YWxseSBpbnZhbGlkYXRlIHlvdXIgY2FjaGUgaWYKICAgICAqIHRoZSBpZGVudGl0eSBwb29sIElEIHdhcyBkZWxldGVkLgogICAgICovCiAgICBjbGVhckNhY2hlZElkOiBmdW5jdGlvbiBjbGVhckNhY2hlKCkgewogICAgICB0aGlzLl9pZGVudGl0eUlkID0gbnVsbDsKICAgICAgZGVsZXRlIHRoaXMucGFyYW1zLklkZW50aXR5SWQ7CiAgCiAgICAgIHZhciBwb29sSWQgPSB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZDsKICAgICAgdmFyIGxvZ2luSWQgPSB0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnOwogICAgICBkZWxldGUgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5LmlkICsgcG9vbElkICsgbG9naW5JZF07CiAgICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXkucHJvdmlkZXJzICsgcG9vbElkICsgbG9naW5JZF07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2xlYXJJZE9uTm90QXV0aG9yaXplZDogZnVuY3Rpb24gY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBpZiAoZXJyLmNvZGUgPT0gJ05vdEF1dGhvcml6ZWRFeGNlcHRpb24nKSB7CiAgICAgICAgc2VsZi5jbGVhckNhY2hlZElkKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJldHJpZXZlcyBhIENvZ25pdG8gSUQsIGxvYWRpbmcgZnJvbSBjYWNoZSBpZiBpdCB3YXMgYWxyZWFkeSByZXRyaWV2ZWQKICAgICAqIG9uIHRoaXMgZGV2aWNlLgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGlkZW50aXR5SWQpCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yLCBudWxsXSBhbiBlcnJvciBvYmplY3QgaWYgdGhlIGNhbGwgZmFpbGVkIG9yIG51bGwgaWYKICAgICAqICAgICBpdCBzdWNjZWVkZWQuCiAgICAgKiAgIEBwYXJhbSBpZGVudGl0eUlkIFtTdHJpbmcsIG51bGxdIGlmIHN1Y2Nlc3NmdWwsIHRoZSBjYWxsYmFjayB3aWxsIHJldHVybgogICAgICogICAgIHRoZSBDb2duaXRvIElELgogICAgICogQG5vdGUgSWYgbm90IGxvYWRlZCBleHBsaWNpdGx5LCB0aGUgQ29nbml0byBJRCBpcyBsb2FkZWQgYW5kIHN0b3JlZCBpbgogICAgICogICBsb2NhbFN0b3JhZ2UgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb2YgYSBkZXZpY2UuCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0SWQ6IGZ1bmN0aW9uIGdldElkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYgKHR5cGVvZiBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBjYWxsYmFjayhudWxsLCBzZWxmLnBhcmFtcy5JZGVudGl0eUlkKTsKICAgICAgfQogIAogICAgICBzZWxmLmNvZ25pdG8uZ2V0SWQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIgJiYgZGF0YS5JZGVudGl0eUlkKSB7CiAgICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gZGF0YS5JZGVudGl0eUlkOwogICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGF0YS5JZGVudGl0eUlkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRDcmVkZW50aWFsczogZnVuY3Rpb24gbG9hZENyZWRlbnRpYWxzKGRhdGEsIGNyZWRlbnRpYWxzKSB7CiAgICAgIGlmICghZGF0YSB8fCAhY3JlZGVudGlhbHMpIHJldHVybjsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlZCA9IGZhbHNlOwogICAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCA9IGRhdGEuQ3JlZGVudGlhbHMuQWNjZXNzS2V5SWQ7CiAgICAgIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSA9IGRhdGEuQ3JlZGVudGlhbHMuU2VjcmV0S2V5OwogICAgICBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4gPSBkYXRhLkNyZWRlbnRpYWxzLlNlc3Npb25Ub2tlbjsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlVGltZSA9IGRhdGEuQ3JlZGVudGlhbHMuRXhwaXJhdGlvbjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5OiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jb2duaXRvLmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuY2FjaGVJZChkYXRhKTsKICAgICAgICAgIHNlbGYuZGF0YSA9IGRhdGE7CiAgICAgICAgICBzZWxmLmxvYWRDcmVkZW50aWFscyhzZWxmLmRhdGEsIHNlbGYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0Q3JlZGVudGlhbHNGcm9tU1RTOiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0Zyb21TVFMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBzZWxmLmNvZ25pdG8uZ2V0T3BlbklkVG9rZW4oZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuY2FjaGVJZChkYXRhKTsKICAgICAgICAgIHNlbGYucGFyYW1zLldlYklkZW50aXR5VG9rZW4gPSBkYXRhLlRva2VuOwogICAgICAgICAgc2VsZi53ZWJJZGVudGl0eUNyZWRlbnRpYWxzLnJlZnJlc2goZnVuY3Rpb24od2ViRXJyKSB7CiAgICAgICAgICAgIGlmICghd2ViRXJyKSB7CiAgICAgICAgICAgICAgc2VsZi5kYXRhID0gc2VsZi53ZWJJZGVudGl0eUNyZWRlbnRpYWxzLmRhdGE7CiAgICAgICAgICAgICAgc2VsZi5zdHMuY3JlZGVudGlhbHNGcm9tKHNlbGYuZGF0YSwgc2VsZik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2sod2ViRXJyKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkQ2FjaGVkSWQ6IGZ1bmN0aW9uIGxvYWRDYWNoZWRJZCgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogIAogICAgICAvLyBpbiB0aGUgYnJvd3NlciB3ZSBzb3VyY2UgZGVmYXVsdCBJZGVudGl0eUlkIGZyb20gbG9jYWxTdG9yYWdlCiAgICAgIGlmIChBV1MudXRpbC5pc0Jyb3dzZXIoKSAmJiAhc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCkgewogICAgICAgIHZhciBpZCA9IHNlbGYuZ2V0U3RvcmFnZSgnaWQnKTsKICAgICAgICBpZiAoaWQgJiYgc2VsZi5wYXJhbXMuTG9naW5zKSB7CiAgICAgICAgICB2YXIgYWN0dWFsUHJvdmlkZXJzID0gT2JqZWN0LmtleXMoc2VsZi5wYXJhbXMuTG9naW5zKTsKICAgICAgICAgIHZhciBjYWNoZWRQcm92aWRlcnMgPQogICAgICAgICAgICAoc2VsZi5nZXRTdG9yYWdlKCdwcm92aWRlcnMnKSB8fCAnJykuc3BsaXQoJywnKTsKICAKICAgICAgICAgIC8vIG9ubHkgbG9hZCBJRCBpZiBhdCBsZWFzdCBvbmUgcHJvdmlkZXIgdXNlZCB0aGlzIElEIGJlZm9yZQogICAgICAgICAgdmFyIGludGVyc2VjdCA9IGNhY2hlZFByb3ZpZGVycy5maWx0ZXIoZnVuY3Rpb24obikgewogICAgICAgICAgICByZXR1cm4gYWN0dWFsUHJvdmlkZXJzLmluZGV4T2YobikgIT09IC0xOwogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoaW50ZXJzZWN0Lmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gaWQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpZCkgewogICAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGlkOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNyZWF0ZUNsaWVudHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY2xpZW50Q29uZmlnID0gdGhpcy5fY2xpZW50Q29uZmlnOwogICAgICB0aGlzLndlYklkZW50aXR5Q3JlZGVudGlhbHMgPSB0aGlzLndlYklkZW50aXR5Q3JlZGVudGlhbHMgfHwKICAgICAgICBuZXcgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHModGhpcy5wYXJhbXMsIGNsaWVudENvbmZpZyk7CiAgICAgIGlmICghdGhpcy5jb2duaXRvKSB7CiAgICAgICAgdmFyIGNvZ25pdG9Db25maWcgPSBBV1MudXRpbC5tZXJnZSh7fSwgY2xpZW50Q29uZmlnKTsKICAgICAgICBjb2duaXRvQ29uZmlnLnBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgICAgIHRoaXMuY29nbml0byA9IG5ldyBDb2duaXRvSWRlbnRpdHkoY29nbml0b0NvbmZpZyk7CiAgICAgIH0KICAgICAgdGhpcy5zdHMgPSB0aGlzLnN0cyB8fCBuZXcgU1RTKGNsaWVudENvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FjaGVJZDogZnVuY3Rpb24gY2FjaGVJZChkYXRhKSB7CiAgICAgIHRoaXMuX2lkZW50aXR5SWQgPSBkYXRhLklkZW50aXR5SWQ7CiAgICAgIHRoaXMucGFyYW1zLklkZW50aXR5SWQgPSB0aGlzLl9pZGVudGl0eUlkOwogIAogICAgICAvLyBjYWNoZSB0aGlzIElkZW50aXR5SWQgaW4gYnJvd3NlciBsb2NhbFN0b3JhZ2UgaWYgcG9zc2libGUKICAgICAgaWYgKEFXUy51dGlsLmlzQnJvd3NlcigpKSB7CiAgICAgICAgdGhpcy5zZXRTdG9yYWdlKCdpZCcsIGRhdGEuSWRlbnRpdHlJZCk7CiAgCiAgICAgICAgaWYgKHRoaXMucGFyYW1zLkxvZ2lucykgewogICAgICAgICAgdGhpcy5zZXRTdG9yYWdlKCdwcm92aWRlcnMnLCBPYmplY3Qua2V5cyh0aGlzLnBhcmFtcy5Mb2dpbnMpLmpvaW4oJywnKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0U3RvcmFnZTogZnVuY3Rpb24gZ2V0U3RvcmFnZShrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZVt0aGlzLmxvY2FsU3RvcmFnZUtleVtrZXldICsgdGhpcy5wYXJhbXMuSWRlbnRpdHlQb29sSWQgKyAodGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJyldOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNldFN0b3JhZ2U6IGZ1bmN0aW9uIHNldFN0b3JhZ2Uoa2V5LCB2YWwpIHsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXlba2V5XSArIHRoaXMucGFyYW1zLklkZW50aXR5UG9vbElkICsgKHRoaXMucGFyYW1zLkxvZ2luSWQgfHwgJycpXSA9IHZhbDsKICAgICAgfSBjYXRjaCAoXykge30KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzdG9yYWdlOiAoZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHN0b3JhZ2UgPSBBV1MudXRpbC5pc0Jyb3dzZXIoKSAmJiB3aW5kb3cubG9jYWxTdG9yYWdlICE9PSBudWxsICYmIHR5cGVvZiB3aW5kb3cubG9jYWxTdG9yYWdlID09PSAnb2JqZWN0JyA/CiAgICAgICAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2UgOiB7fTsKICAKICAgICAgICAvLyBUZXN0IHNldC9yZW1vdmUgd2hpY2ggd291bGQgdGhyb3cgYW4gZXJyb3IgaW4gU2FmYXJpJ3MgcHJpdmF0ZSBicm93c2luZwogICAgICAgIHN0b3JhZ2VbJ2F3cy50ZXN0LXN0b3JhZ2UnXSA9ICdmb29iYXInOwogICAgICAgIGRlbGV0ZSBzdG9yYWdlWydhd3MudGVzdC1zdG9yYWdlJ107CiAgCiAgICAgICAgcmV0dXJuIHN0b3JhZ2U7CiAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAgIH0pKCkKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9jb2duaXRvaWRlbnRpdHkiOjcsIi4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDIyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIC8qKgogICAqIENyZWF0ZXMgYSBjcmVkZW50aWFsIHByb3ZpZGVyIGNoYWluIHRoYXQgc2VhcmNoZXMgZm9yIEFXUyBjcmVkZW50aWFscwogICAqIGluIGEgbGlzdCBvZiBjcmVkZW50aWFsIHByb3ZpZGVycyBzcGVjaWZpZWQgYnkgdGhlIHtwcm92aWRlcnN9IHByb3BlcnR5LgogICAqCiAgICogQnkgZGVmYXVsdCwgdGhlIGNoYWluIHdpbGwgdXNlIHRoZSB7ZGVmYXVsdFByb3ZpZGVyc30gdG8gcmVzb2x2ZSBjcmVkZW50aWFscy4KICAgKiBUaGVzZSBwcm92aWRlcnMgd2lsbCBsb29rIGluIHRoZSBlbnZpcm9ubWVudCB1c2luZyB0aGUKICAgKiB7QVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHN9IGNsYXNzIHdpdGggdGhlICdBV1MnIGFuZCAnQU1BWk9OJyBwcmVmaXhlcy4KICAgKgogICAqICMjIFNldHRpbmcgUHJvdmlkZXJzCiAgICoKICAgKiBFYWNoIHByb3ZpZGVyIGluIHRoZSB7cHJvdmlkZXJzfSBsaXN0IHNob3VsZCBiZSBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucwogICAqIGEge0FXUy5DcmVkZW50aWFsc30gb2JqZWN0LCBvciBhIGhhcmRjb2RlZCBjcmVkZW50aWFscyBvYmplY3QuIFRoZSBmdW5jdGlvbgogICAqIGZvcm0gYWxsb3dzIGZvciBkZWxheWVkIGV4ZWN1dGlvbiBvZiB0aGUgY3JlZGVudGlhbCBjb25zdHJ1Y3Rpb24uCiAgICoKICAgKiAjIyBSZXNvbHZpbmcgQ3JlZGVudGlhbHMgZnJvbSBhIENoYWluCiAgICoKICAgKiBDYWxsIHtyZXNvbHZlfSB0byByZXR1cm4gdGhlIGZpcnN0IHZhbGlkIGNyZWRlbnRpYWwgb2JqZWN0IHRoYXQgY2FuIGJlCiAgICogbG9hZGVkIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgKgogICAqIEZvciBleGFtcGxlLCB0byByZXNvbHZlIGEgY2hhaW4gd2l0aCBhIGN1c3RvbSBwcm92aWRlciB0aGF0IGNoZWNrcyBhIGZpbGUKICAgKiBvbiBkaXNrIGFmdGVyIHRoZSBzZXQgb2Yge2RlZmF1bHRQcm92aWRlcnN9OgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciBkaXNrUHJvdmlkZXIgPSBuZXcgQVdTLkZpbGVTeXN0ZW1DcmVkZW50aWFscygnLi9jcmVkcy5qc29uJyk7CiAgICogdmFyIGNoYWluID0gbmV3IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbigpOwogICAqIGNoYWluLnByb3ZpZGVycy5wdXNoKGRpc2tQcm92aWRlcik7CiAgICogY2hhaW4ucmVzb2x2ZSgpOwogICAqIGBgYAogICAqCiAgICogVGhlIGFib3ZlIGNvZGUgd2lsbCByZXR1cm4gdGhlIGBkaXNrUHJvdmlkZXJgIG9iamVjdCBpZiB0aGUKICAgKiBmaWxlIGNvbnRhaW5zIGNyZWRlbnRpYWxzIGFuZCB0aGUgYGRlZmF1bHRQcm92aWRlcnNgIGRvIG5vdCBjb250YWluCiAgICogYW55IGNyZWRlbnRpYWwgc2V0dGluZ3MuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBwcm92aWRlcnMKICAgKiAgIEByZXR1cm4gW0FycmF5PEFXUy5DcmVkZW50aWFscywgRnVuY3Rpb24+XQogICAqICAgICBhIGxpc3Qgb2YgY3JlZGVudGlhbHMgb2JqZWN0cyBvciBmdW5jdGlvbnMgdGhhdCByZXR1cm4gY3JlZGVudGlhbHMKICAgKiAgICAgb2JqZWN0cy4gSWYgdGhlIHByb3ZpZGVyIGlzIGEgZnVuY3Rpb24sIHRoZSBmdW5jdGlvbiB3aWxsIGJlCiAgICogICAgIGV4ZWN1dGVkIGxhemlseSB3aGVuIHRoZSBwcm92aWRlciBuZWVkcyB0byBiZSBjaGVja2VkIGZvciB2YWxpZAogICAqICAgICBjcmVkZW50aWFscy4gQnkgZGVmYXVsdCwgdGhpcyBvYmplY3Qgd2lsbCBiZSBzZXQgdG8gdGhlCiAgICogICAgIHtkZWZhdWx0UHJvdmlkZXJzfS4KICAgKiAgIEBzZWUgZGVmYXVsdFByb3ZpZGVycwogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbiA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gd2l0aCBhIGRlZmF1bHQgc2V0IG9mIHByb3ZpZGVycwogICAgICogc3BlY2lmaWVkIGJ5IHtkZWZhdWx0UHJvdmlkZXJzfS4KICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENyZWRlbnRpYWxQcm92aWRlckNoYWluKHByb3ZpZGVycykgewogICAgICBpZiAocHJvdmlkZXJzKSB7CiAgICAgICAgdGhpcy5wcm92aWRlcnMgPSBwcm92aWRlcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5wcm92aWRlcnMgPSBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycy5zbGljZSgwKTsKICAgICAgfQogICAgICB0aGlzLnJlc29sdmVDYWxsYmFja3MgPSBbXTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEAhbWV0aG9kICByZXNvbHZlUHJvbWlzZSgpCiAgICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICAgKiAgIFJlc29sdmVzIHRoZSBwcm92aWRlciBjaGFpbiBieSBzZWFyY2hpbmcgZm9yIHRoZSBmaXJzdCBzZXQgb2YKICAgICAqICAgY3JlZGVudGlhbHMgaW4ge3Byb3ZpZGVyc30uCiAgICAgKgogICAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgICAqICAgVGhlIGZpcnN0IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCwgYW5kIHRoZSBzZWNvbmQKICAgICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbihjcmVkZW50aWFscykKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkIGFuZCB0aGUgcHJvdmlkZXIgcmVzb2x2ZXMgdGhlIGNoYWluCiAgICAgKiAgICAgdG8gYSBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCByZXNvbHZlZAogICAgICogICAgICAgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAgICogICBAY2FsbGJhY2sgcmVqZWN0ZWRDYWxsYmFjayBmdW5jdGlvbihlcnJvcikKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgaWYgbm8gY3JlZGVudGlhbHMgYXJlIGZvdW5kLgogICAgICogICBAcmV0dXJuIFtQcm9taXNlXSBBIHByb21pc2UgdGhhdCByZXByZXNlbnRzIHRoZSBzdGF0ZSBvZiB0aGUgYHJlc29sdmVgIG1ldGhvZCBjYWxsLgogICAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgcmVzb2x2ZVByb21pc2VgIG1ldGhvZC4KICAgICAqICAgICB2YXIgcHJvbWlzZSA9IGNoYWluLnJlc29sdmVQcm9taXNlKCk7CiAgICAgKiAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGNyZWRlbnRpYWxzKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAgICovCiAgCiAgICAvKioKICAgICAqIFJlc29sdmVzIHRoZSBwcm92aWRlciBjaGFpbiBieSBzZWFyY2hpbmcgZm9yIHRoZSBmaXJzdCBzZXQgb2YKICAgICAqIGNyZWRlbnRpYWxzIGluIHtwcm92aWRlcnN9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGNyZWRlbnRpYWxzKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgcHJvdmlkZXIgcmVzb2x2ZXMgdGhlIGNoYWluIHRvIGEgY3JlZGVudGlhbHMgb2JqZWN0CiAgICAgKiAgIG9yIG51bGwgaWYgbm8gY3JlZGVudGlhbHMgY2FuIGJlIGZvdW5kLgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgaWYgbm8gY3JlZGVudGlhbHMgYXJlCiAgICAgKiAgICAgZm91bmQuCiAgICAgKiAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHJlc29sdmVkCiAgICAgKiAgICAgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogICAgICogQHJldHVybiBbQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluXSB0aGUgcHJvdmlkZXIsIGZvciBjaGFpbmluZy4KICAgICAqLwogICAgcmVzb2x2ZTogZnVuY3Rpb24gcmVzb2x2ZShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmIChzZWxmLnByb3ZpZGVycy5sZW5ndGggPT09IDApIHsKICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ05vIHByb3ZpZGVycycpKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgfQogIAogICAgICBpZiAoc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spID09PSAxKSB7CiAgICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgICB2YXIgcHJvdmlkZXJzID0gc2VsZi5wcm92aWRlcnMuc2xpY2UoMCk7CiAgCiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZU5leHQoZXJyLCBjcmVkcykgewogICAgICAgICAgaWYgKCghZXJyICYmIGNyZWRzKSB8fCBpbmRleCA9PT0gcHJvdmlkZXJzLmxlbmd0aCkgewogICAgICAgICAgICBBV1MudXRpbC5hcnJheUVhY2goc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLCBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIGNyZWRzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNlbGYucmVzb2x2ZUNhbGxiYWNrcy5sZW5ndGggPSAwOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgCiAgICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlcnNbaW5kZXgrK107CiAgICAgICAgICBpZiAodHlwZW9mIHByb3ZpZGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNyZWRzID0gcHJvdmlkZXIuY2FsbCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3JlZHMgPSBwcm92aWRlcjsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChjcmVkcy5nZXQpIHsKICAgICAgICAgICAgY3JlZHMuZ2V0KGZ1bmN0aW9uIChnZXRFcnIpIHsKICAgICAgICAgICAgICByZXNvbHZlTmV4dChnZXRFcnIsIGdldEVyciA/IG51bGwgOiBjcmVkcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZU5leHQobnVsbCwgY3JlZHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICByZXNvbHZlTmV4dCgpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBzZWxmOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIFRoZSBkZWZhdWx0IHNldCBvZiBwcm92aWRlcnMgdXNlZCBieSBhIHZhbmlsbGEgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uCiAgICoKICAgKiBJbiB0aGUgYnJvd3NlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFtdCiAgICogYGBgCiAgICoKICAgKiBJbiBOb2RlLmpzOgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gWwogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQU1BWk9OJyk7IH0sCiAgICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlNoYXJlZEluaUZpbGVDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FQ1NDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5Qcm9jZXNzQ3JlZGVudGlhbHMoKTsgfSwKICAgKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuVG9rZW5GaWxlV2ViSWRlbnRpdHlDcmVkZW50aWFscygpOyB9LAogICAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FQzJNZXRhZGF0YUNyZWRlbnRpYWxzKCkgfQogICAqIF0KICAgKiBgYGAKICAgKi8KICBBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVmYXVsdFByb3ZpZGVycyA9IFtdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5hZGRQcm9taXNlc1RvQ2xhc3MgPSBmdW5jdGlvbiBhZGRQcm9taXNlc1RvQ2xhc3MoUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHRoaXMucHJvdG90eXBlLnJlc29sdmVQcm9taXNlID0gQVdTLnV0aWwucHJvbWlzaWZ5TWV0aG9kKCdyZXNvbHZlJywgUHJvbWlzZURlcGVuZGVuY3kpOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzID0gZnVuY3Rpb24gZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MoKSB7CiAgICBkZWxldGUgdGhpcy5wcm90b3R5cGUucmVzb2x2ZVByb21pc2U7CiAgfTsKICAKICBBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4pOwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDIzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFNBTUwgc3VwcG9ydC4KICAgKgogICAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTH0gc2VydmljZSBvcGVyYXRpb24uIFRoaXMgb3BlcmF0aW9uCiAgICogcmVxdWlyZXMgYSBgUm9sZUFybmAgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QgcG9saWN5IGZvciB0aGUKICAgKiBhcHBsaWNhdGlvbiBmb3Igd2hpY2ggY3JlZGVudGlhbHMgd2lsbCBiZSBnaXZlbiwgYXMgd2VsbCBhcyBhIGBQcmluY2lwYWxBcm5gCiAgICogcmVwcmVzZW50aW5nIHRoZSBBUk4gZm9yIHRoZSBTQU1MIGlkZW50aXR5IHByb3ZpZGVyLiBJbiBhZGRpdGlvbiwgdGhlCiAgICogYFNBTUxBc3NlcnRpb25gIG11c3QgYmUgc2V0IHRvIHRoZSB0b2tlbiBwcm92aWRlZCBieSB0aGUgaWRlbnRpdHkKICAgKiBwcm92aWRlci4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogICAqIG9iamVjdCB3aXRoIHByb3BlciBgUm9sZUFybmAsIGBQcmluY2lwYWxBcm5gLCBhbmQgYFNBTUxBc3NlcnRpb25gIHZhbHVlcy4KICAgKgogICAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAgICoKICAgKiBJbiBhZGRpdGlvbiB0byBBV1MgY3JlZGVudGlhbHMgZXhwaXJpbmcgYWZ0ZXIgYSBnaXZlbiBhbW91bnQgb2YgdGltZSwgdGhlCiAgICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAgICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogICAqIHRva2VuIHdpbGwgYmUgbmVlZGVkLiBUaGUgU0RLIGRvZXMgbm90IG1hbmFnZSByZWZyZXNoaW5nIG9mIHRoZSB0b2tlbiB2YWx1ZSwKICAgKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAgICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICAgKiB0b2tlbnMuIE9uY2UgdGhlIHJlZnJlc2hlZCB0b2tlbiBpcyBhY3F1aXJlZCwgeW91IHNob3VsZCBtYWtlIHN1cmUgdG8gdXBkYXRlCiAgICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAgICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgU0FNTEFzc2VydGlvbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICAgKiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlcjoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzLnBhcmFtcy5TQU1MQXNzZXJ0aW9uID0gdXBkYXRlZFRva2VuOwogICAqIGBgYAogICAqCiAgICogRnV0dXJlIGNhbGxzIHRvIGBjcmVkZW50aWFscy5yZWZyZXNoKClgIHdpbGwgbm93IHVzZSB0aGUgbmV3IHRva2VuLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSBtYXAgb2YgcGFyYW1zIHBhc3NlZCB0bwogICAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAgICogICAgIGBwYXJhbXMuU0FNTEFzc2VydGlvbmAgcHJvcGVydHkuCiAgICovCiAgQVdTLlNBTUxDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICogQHBhcmFtIChzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUwpCiAgICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QKICAgICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuU0FNTENyZWRlbnRpYWxzKHsKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9TQU1MUm9sZScsCiAgICAgKiAgICAgUHJpbmNpcGFsQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9TQU1MUHJpbmNpcGFsJywKICAgICAqICAgICBTQU1MQXNzZXJ0aW9uOiAnYmFzZTY0LXRva2VuJywgLy8gYmFzZTY0LWVuY29kZWQgdG9rZW4gZnJvbSBJZFAKICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTQU1MQ3JlZGVudGlhbHMocGFyYW1zKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9CiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAgICogQHNlZSBnZXQKICAgICAqLwogICAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZVdpdGhTQU1MKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoIWVycikgewogICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc2VydmljZSA9IHRoaXMuc2VydmljZSB8fCBuZXcgU1RTKHtwYXJhbXM6IHRoaXMucGFyYW1zfSk7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDI0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIHtBV1MuU1RTfS4gV2l0aG91dCBhbnkKICAgKiBleHRyYSBwYXJhbWV0ZXJzLCBjcmVkZW50aWFscyB3aWxsIGJlIGZldGNoZWQgZnJvbSB0aGUKICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbi4gSWYgYW4gSUFNIHJvbGUgaXMgcHJvdmlkZWQsIHRoZQogICAqIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9wZXJhdGlvbiB3aWxsIGJlIHVzZWQgdG8gZmV0Y2ggY3JlZGVudGlhbHMgZm9yIHRoZQogICAqIHJvbGUgaW5zdGVhZC4KICAgKgogICAqIEBub3RlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyBpcyBkZXByZWNhdGVkLCBidXQgcmVtYWlucyBhdmFpbGFibGUgZm9yCiAgICogICBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4ge0FXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFsc30gaXMgdGhlCiAgICogICBwcmVmZXJyZWQgY2xhc3MgZm9yIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICAgKgogICAqIFRvIHNldHVwIHRlbXBvcmFyeSBjcmVkZW50aWFscywgY29uZmlndXJlIGEgc2V0IG9mIG1hc3RlciBjcmVkZW50aWFscwogICAqIHVzaW5nIHRoZSBzdGFuZGFyZCBjcmVkZW50aWFscyBwcm92aWRlcnMgKGVudmlyb25tZW50LCBFQzIgaW5zdGFuY2UgbWV0YWRhdGEsCiAgICogb3IgZnJvbSB0aGUgZmlsZXN5c3RlbSksIHRoZW4gc2V0IHRoZSBnbG9iYWwgY3JlZGVudGlhbHMgdG8gYSBuZXcKICAgKiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0OgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIC8vIE5vdGUgdGhhdCBlbnZpcm9ubWVudCBjcmVkZW50aWFscyBhcmUgbG9hZGVkIGJ5IGRlZmF1bHQsCiAgICogLy8gdGhlIGZvbGxvd2luZyBsaW5lIGlzIHNob3duIGZvciBjbGFyaXR5OgogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpOwogICAqCiAgICogLy8gTm93IHNldCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgc2VlZGVkIGZyb20gdGhlIG1hc3RlciBjcmVkZW50aWFscwogICAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICoKICAgKiAvLyBzdWJzZXF1ZW50IHJlcXVlc3RzIHdpbGwgbm93IHVzZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIG5ldyBBV1MuUzMoKS5saXN0QnVja2V0KGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAgICogYGBgCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBtYXN0ZXJDcmVkZW50aWFscwogICAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIChub24tdGVtcG9yYXJ5KSBjcmVkZW50aWFscyB1c2VkIHRvCiAgICogICAgIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAqIEBub3RlIChzZWUgY29uc3RydWN0b3IpCiAgICovCiAgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0LgogICAgICoKICAgICAqIEBub3RlIEluIG9yZGVyIHRvIGNyZWF0ZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsIHlvdSBmaXJzdCBuZWVkIHRvIGhhdmUKICAgICAqICAgIm1hc3RlciIgY3JlZGVudGlhbHMgY29uZmlndXJlZCBpbiB7QVdTLkNvbmZpZy5jcmVkZW50aWFsc30uIFRoZXNlCiAgICAgKiAgIG1hc3RlciBjcmVkZW50aWFscyBhcmUgbmVjZXNzYXJ5IHRvIHJldHJpZXZlIHRoZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsCiAgICAgKiAgIGFzIHdlbGwgYXMgcmVmcmVzaCB0aGUgY3JlZGVudGlhbHMgd2hlbiB0aGV5IGV4cGlyZS4KICAgICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2Ygb3B0aW9ucyB0aGF0IGFyZSBwYXNzZWQgdG8gdGhlCiAgICAgKiAgIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9ucy4KICAgICAqICAgSWYgYSBgUm9sZUFybmAgcGFyYW1ldGVyIGlzIHBhc3NlZCBpbiwgY3JlZGVudGlhbHMgd2lsbCBiZSBiYXNlZCBvbiB0aGUKICAgICAqICAgSUFNIHJvbGUuCiAgICAgKiBAcGFyYW0gbWFzdGVyQ3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciAobm9uLXRlbXBvcmFyeSkgY3JlZGVudGlhbHMKICAgICAqICB1c2VkIHRvIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBnZW5lcmljIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0IGZvciBhbiBJQU0gcm9sZQogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscyh7CiAgICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvVGVtcG9yYXJ5Q3JlZGVudGlhbHMnLAogICAgICogICB9KTsKICAgICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlCiAgICAgKiBAc2VlIEFXUy5TVFMuZ2V0U2Vzc2lvblRva2VuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBUZW1wb3JhcnlDcmVkZW50aWFscyhwYXJhbXMsIG1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmxvYWRNYXN0ZXJDcmVkZW50aWFscyhtYXN0ZXJDcmVkZW50aWFscyk7CiAgICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgCiAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICBpZiAodGhpcy5wYXJhbXMuUm9sZUFybikgewogICAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9CiAgICAgICAgICB0aGlzLnBhcmFtcy5Sb2xlU2Vzc2lvbk5hbWUgfHwgJ3RlbXBvcmFyeS1jcmVkZW50aWFscyc7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcgogICAgICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSwgZGVwZW5kaW5nIG9uIHdoZXRoZXIgYW4gSUFNIHJvbGUgQVJOIHdhcyBwYXNzZWQKICAgICAqIHRvIHRoZSBjcmVkZW50aWFscyB7Y29uc3RydWN0b3J9LgogICAgICoKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgICAqIEBzZWUgZ2V0CiAgICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2ggKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkIChjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgICBzZWxmLm1hc3RlckNyZWRlbnRpYWxzLmdldChmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscyA9IHNlbGYubWFzdGVyQ3JlZGVudGlhbHM7CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHNlbGYucGFyYW1zLlJvbGVBcm4gPwogICAgICAgICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGUgOiBzZWxmLnNlcnZpY2UuZ2V0U2Vzc2lvblRva2VuOwogICAgICAgIG9wZXJhdGlvbi5jYWxsKHNlbGYuc2VydmljZSwgZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRNYXN0ZXJDcmVkZW50aWFsczogZnVuY3Rpb24gbG9hZE1hc3RlckNyZWRlbnRpYWxzIChtYXN0ZXJDcmVkZW50aWFscykgewogICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gbWFzdGVyQ3JlZGVudGlhbHMgfHwgQVdTLmNvbmZpZy5jcmVkZW50aWFsczsKICAgICAgd2hpbGUgKHRoaXMubWFzdGVyQ3JlZGVudGlhbHMubWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgICAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gdGhpcy5tYXN0ZXJDcmVkZW50aWFscy5tYXN0ZXJDcmVkZW50aWFsczsKICAgICAgfQogIAogICAgICBpZiAodHlwZW9mIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMuZ2V0ICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IG5ldyBBV1MuQ3JlZGVudGlhbHModGhpcy5tYXN0ZXJDcmVkZW50aWFscyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMuc2VydmljZSA9IHRoaXMuc2VydmljZSB8fCBuZXcgU1RTKHtwYXJhbXM6IHRoaXMucGFyYW1zfSk7CiAgICB9CiAgCiAgfSk7CiAgCiAgfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOH1dLDI1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFdlYiBJZGVudGl0eSBGZWRlcmF0aW9uIHN1cHBvcnQuCiAgICoKICAgKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICAgKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbi4gVGhpcyBvcGVyYXRpb24KICAgKiByZXF1aXJlcyBhIGBSb2xlQXJuYCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdCBwb2xpY3kgZm9yIHRoZQogICAqIGFwcGxpY2F0aW9uIGZvciB3aGljaCBjcmVkZW50aWFscyB3aWxsIGJlIGdpdmVuLiBJbiBhZGRpdGlvbiwgdGhlCiAgICogYFdlYklkZW50aXR5VG9rZW5gIG11c3QgYmUgc2V0IHRvIHRoZSB0b2tlbiBwcm92aWRlZCBieSB0aGUgaWRlbnRpdHkKICAgKiBwcm92aWRlci4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogICAqIG9iamVjdCB3aXRoIHByb3BlciBgUm9sZUFybmAgYW5kIGBXZWJJZGVudGl0eVRva2VuYCB2YWx1ZXMuCiAgICoKICAgKiAjIyBSZWZyZXNoaW5nIENyZWRlbnRpYWxzIGZyb20gSWRlbnRpdHkgU2VydmljZQogICAqCiAgICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogICAqIGxvZ2luIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyIHdpbGwgYWxzbyBleHBpcmUuIE9uY2UgdGhpcyB0b2tlbgogICAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICAgKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAgICogYnV0IHRoaXMgY2FuIGJlIGRvbmUgdGhyb3VnaCBhICJyZWZyZXNoIHRva2VuIiBzdXBwb3J0ZWQgYnkgbW9zdCBpZGVudGl0eQogICAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAgICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogICAqIHRoaXMgbmV3IHRva2VuIGluIHRoZSBjcmVkZW50aWFscyBvYmplY3QncyB7cGFyYW1zfSBwcm9wZXJ0eS4gVGhlIGZvbGxvd2luZwogICAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFdlYklkZW50aXR5VG9rZW4sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAgICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAgICoKICAgKiBgYGBqYXZhc2NyaXB0CiAgICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuV2ViSWRlbnRpdHlUb2tlbiA9IHVwZGF0ZWRUb2tlbjsKICAgKiBgYGAKICAgKgogICAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICAgKgogICAqIEAhYXR0cmlidXRlIHBhcmFtcwogICAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICAgKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICAgKiAgICAgYHBhcmFtcy5XZWJJZGVudGl0eVRva2VuYCBwcm9wZXJ0eS4KICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmV0dXJuIFttYXBdIHRoZSByYXcgZGF0YSByZXNwb25zZSBmcm9tIHRoZSBjYWxsIHRvCiAgICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBVc2UgdGhpcyBpZiB5b3Ugd2FudCB0byBnZXQKICAgKiAgICAgYWNjZXNzIHRvIG90aGVyIHByb3BlcnRpZXMgZnJvbSB0aGUgcmVzcG9uc2UuCiAgICovCiAgQVdTLldlYklkZW50aXR5Q3JlZGVudGlhbHMgPSBBV1MudXRpbC5pbmhlcml0KEFXUy5DcmVkZW50aWFscywgewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdC4KICAgICAqIEBwYXJhbSAoc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSkKICAgICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5XZWJJZGVudGl0eUNyZWRlbnRpYWxzKHsKICAgICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9XZWJJZGVudGl0eScsCiAgICAgKiAgICAgV2ViSWRlbnRpdHlUb2tlbjogJ0FCQ0RFRkdISUpLTE1OT1AnLCAvLyB0b2tlbiBmcm9tIGlkZW50aXR5IHNlcnZpY2UKICAgICAqICAgICBSb2xlU2Vzc2lvbk5hbWU6ICd3ZWInIC8vIG9wdGlvbmFsIG5hbWUsIGRlZmF1bHRzIHRvIHdlYi1pZGVudGl0eQogICAgICogICB9LCB7CiAgICAgKiAgICAgLy8gb3B0aW9uYWxseSBwcm92aWRlIGNvbmZpZ3VyYXRpb24gdG8gYXBwbHkgdG8gdGhlIHVuZGVybHlpbmcgQVdTLlNUUyBzZXJ2aWNlIGNsaWVudAogICAgICogICAgIC8vIGlmIGNvbmZpZ3VyYXRpb24gaXMgbm90IHByb3ZpZGVkLCB0aGVuIGNvbmZpZ3VyYXRpb24gd2lsbCBiZSBwdWxsZWQgZnJvbSBBV1MuY29uZmlnCiAgICAgKgogICAgICogICAgIC8vIHNwZWNpZnkgdGltZW91dCBvcHRpb25zCiAgICAgKiAgICAgaHR0cE9wdGlvbnM6IHsKICAgICAqICAgICAgIHRpbWVvdXQ6IDEwMAogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgKiBAc2VlIEFXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eQogICAgICogQHNlZSBBV1MuQ29uZmlnCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBXZWJJZGVudGl0eUNyZWRlbnRpYWxzKHBhcmFtcywgY2xpZW50Q29uZmlnKSB7CiAgICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lID0gdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd3ZWItaWRlbnRpdHknOwogICAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgICB0aGlzLl9jbGllbnRDb25maWcgPSBBV1MudXRpbC5jb3B5KGNsaWVudENvbmZpZyB8fCB7fSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICAgKiBAc2VlIGdldAogICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICBzZWxmLmRhdGEgPSBudWxsOwogICAgICAgIGlmICghZXJyKSB7CiAgICAgICAgICBzZWxmLmRhdGEgPSBkYXRhOwogICAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5zZXJ2aWNlKSB7CiAgICAgICAgdmFyIHN0c0NvbmZpZyA9IEFXUy51dGlsLm1lcmdlKHt9LCB0aGlzLl9jbGllbnRDb25maWcpOwogICAgICAgIHN0c0NvbmZpZy5wYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgICB0aGlzLnNlcnZpY2UgPSBuZXcgU1RTKHN0c0NvbmZpZyk7CiAgICAgIH0KICAgIH0KICAKICB9KTsKICAKICB9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE4fV0sMjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4vdXRpbCcpOwogIHZhciBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWRFbnZzID0gWydBV1NfRU5BQkxFX0VORFBPSU5UX0RJU0NPVkVSWScsICdBV1NfRU5EUE9JTlRfRElTQ09WRVJZX0VOQUJMRUQnXTsKICAKICAvKioKICAgKiBHZW5lcmF0ZSBrZXkgKGV4Y2VwdCByZXNvdXJjZXMgYW5kIG9wZXJhdGlvbiBwYXJ0KSB0byBpbmRleCB0aGUgZW5kcG9pbnRzIGluIHRoZSBjYWNoZQogICAqIElmIGlucHV0IHNoYXBlIGhhcyBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAgICogICBhY2Nlc3NLZXkgKyBvcGVyYXRpb24gKyByZXNvdXJjZXMgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogICAqIElmIGlucHV0IHNoYXBlIGRvZXNuJ3QgaGF2ZSBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAgICogICBhY2Nlc3NLZXkgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogICAqIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0gb2JqZWN0IHdpdGgga2V5cyB0byBpbmRleCBlbmRwb2ludHMuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZ2V0Q2FjaGVLZXkocmVxdWVzdCkgewogICAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2U7CiAgICB2YXIgYXBpID0gc2VydmljZS5hcGkgfHwge307CiAgICB2YXIgb3BlcmF0aW9ucyA9IGFwaS5vcGVyYXRpb25zOwogICAgdmFyIGlkZW50aWZpZXJzID0ge307CiAgICBpZiAoc2VydmljZS5jb25maWcucmVnaW9uKSB7CiAgICAgIGlkZW50aWZpZXJzLnJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIH0KICAgIGlmIChhcGkuc2VydmljZUlkKSB7CiAgICAgIGlkZW50aWZpZXJzLnNlcnZpY2VJZCA9IGFwaS5zZXJ2aWNlSWQ7CiAgICB9CiAgICBpZiAoc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQpIHsKICAgICAgaWRlbnRpZmllcnMuYWNjZXNzS2V5SWQgPSBzZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAgIH0KICAgIHJldHVybiBpZGVudGlmaWVyczsKICB9CiAgCiAgLyoqCiAgICogUmVjdXJzaXZlIGhlbHBlciBmb3IgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycygpLgogICAqIExvb2tzIGZvciByZXF1aXJlZCBzdHJpbmcgaW5wdXQgbWVtYmVycyB0aGF0IGhhdmUgJ2VuZHBvaW50ZGlzY292ZXJ5aWQnIHRyYWl0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXMsIHNoYXBlKSB7CiAgICBpZiAoIXNoYXBlIHx8IHBhcmFtcyA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtcyA9PT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKHNoYXBlLnR5cGUgPT09ICdzdHJ1Y3R1cmUnICYmIHNoYXBlLnJlcXVpcmVkICYmIHNoYXBlLnJlcXVpcmVkLmxlbmd0aCA+IDApIHsKICAgICAgdXRpbC5hcnJheUVhY2goc2hhcGUucmVxdWlyZWQsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW25hbWVdOwogICAgICAgIGlmIChtZW1iZXJTaGFwZS5lbmRwb2ludERpc2NvdmVyeUlkID09PSB0cnVlKSB7CiAgICAgICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgICAgIHJlc3VsdFtsb2NhdGlvbk5hbWVdID0gU3RyaW5nKHBhcmFtc1tuYW1lXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnNIZWxwZXIocmVzdWx0LCBwYXJhbXNbbmFtZV0sIG1lbWJlclNoYXBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAKICAvKioKICAgKiBHZXQgY3VzdG9tIGlkZW50aWZpZXJzIGZvciBjYWNoZSBrZXkuCiAgICogSWRlbnRpZmllcyBjdXN0b20gaWRlbnRpZmllcnMgYnkgY2hlY2tpbmcgZWFjaCBzaGFwZSdzIGBlbmRwb2ludERpc2NvdmVyeUlkYCB0cmFpdC4KICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICAgKiBAcGFyYW0gW29iamVjdF0gaW5wdXQgc2hhcGUgb2YgdGhlIGdpdmVuIG9wZXJhdGlvbidzIGFwaQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgc2hhcGUpIHsKICAgIHZhciBpZGVudGlmaWVycyA9IHt9OwogICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihpZGVudGlmaWVycywgcmVxdWVzdC5wYXJhbXMsIHNoYXBlKTsKICAgIHJldHVybiBpZGVudGlmaWVyczsKICB9CiAgCiAgLyoqCiAgICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyBvcHRpb25hbC4KICAgKiBXaGVuIGVuZHBvaW50IGlzIGF2YWlsYWJsZSBpbiBjYWNoZSB0aGVuIHVzZSB0aGUgY2FjaGVkIGVuZHBvaW50cy4gSWYgZW5kcG9pbnRzCiAgICogYXJlIHVuYXZhaWxhYmxlIHRoZW4gdXNlIHJlZ2lvbmFsIGVuZHBvaW50cyBhbmQgY2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAgICogYXN5bmNocm9ub3VzbHkuIFRoaXMgaXMgdHVybmVkIG9mZiBieSBkZWZhdWx0LgogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwogIAogICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogICAgfQogICAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleSk7CiAgICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAgIC8vZW5kcG9pbnQgb3BlcmF0aW9uIGlzIGJlaW5nIG1hZGUgYnV0IHJlc3BvbnNlIG5vdCB5ZXQgcmVjZWl2ZWQKICAgICAgLy9vciBlbmRwb2ludCBvcGVyYXRpb24ganVzdCBmYWlsZWQgaW4gMSBtaW51dGUKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgLy9mb3VuZCBlbmRwb2ludCByZWNvcmQgZnJvbSBjYWNoZQogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vZW5kcG9pbnQgcmVjb3JkIG5vdCBpbiBjYWNoZSBvciBvdXRkYXRlZC4gbWFrZSBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAgICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICAgIH0pOwogICAgICBhZGRBcGlWZXJzaW9uSGVhZGVyKGVuZHBvaW50UmVxdWVzdCk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdyZXRyeScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlJFVFJZX0NIRUNLKTsKICAgICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgW3sKICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogMQogICAgICB9XSk7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICAgIGlmIChkYXRhICYmIGRhdGEuRW5kcG9pbnRzKSB7CiAgICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgICB9IGVsc2UgaWYgKGVycikgewogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5LCBbewogICAgICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICAgICAgQ2FjaGVQZXJpb2RJbk1pbnV0ZXM6IDEgLy9ub3QgdG8gbWFrZSBtb3JlIGVuZHBvaW50IG9wZXJhdGlvbiBpbiBuZXh0IDEgbWludXRlCiAgICAgICAgICB9XSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgCiAgdmFyIHJlcXVlc3RRdWV1ZSA9IHt9OwogIAogIC8qKgogICAqIENhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbiB3aGVuIGl0J3MgcmVxdWlyZWQuCiAgICogV2hlbiBlbmRwb2ludCBpcyBhdmFpbGFibGUgaW4gY2FjaGUgdGhlbiB1c2UgY2FjaGVkIG9uZXMuIElmIGVuZHBvaW50cyBhcmUKICAgKiB1bmF2YWlsYWJsZSB0aGVuIFNESyBzaG91bGQgY2FsbCBlbmRwb2ludCBvcGVyYXRpb24gdGhlbiB1c2UgcmV0dXJuZWQgbmV3CiAgICogZW5kcG9pbnQgZm9yIHRoZSBhcGkgY2FsbC4gU0RLIHdpbGwgYXV0b21hdGljYWxseSBhdHRlbXB0IHRvIGRvIGVuZHBvaW50CiAgICogZGlzY292ZXJ5LiBUaGlzIGlzIHR1cm5lZCBvZmYgYnkgZGVmYXVsdAogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgIHZhciBvcGVyYXRpb25Nb2RlbCA9IGFwaS5vcGVyYXRpb25zID8gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dIDogdW5kZWZpbmVkOwogICAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwogIAogICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogICAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogICAgfQogICAgdmFyIGNhY2hlS2V5U3RyID0gQVdTLkVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGNhY2hlS2V5KTsKICAgIHZhciBlbmRwb2ludHMgPSBBV1MuZW5kcG9pbnRDYWNoZS5nZXQoY2FjaGVLZXlTdHIpOyAvL2VuZHBvaW50IGNhY2hlIGFsc28gYWNjZXB0cyBzdHJpbmcga2V5cwogICAgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID09PSAxICYmIGVuZHBvaW50c1swXS5BZGRyZXNzID09PSAnJykgewogICAgICAvL2VuZHBvaW50IG9wZXJhdGlvbiBpcyBiZWluZyBtYWRlIGJ1dCByZXNwb25zZSBub3QgeWV0IHJlY2VpdmVkCiAgICAgIC8vcHVzaCByZXF1ZXN0IG9iamVjdCB0byBhIHBlbmRpbmcgcXVldWUKICAgICAgaWYgKCFyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdID0gW107CiAgICAgIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl0ucHVzaCh7cmVxdWVzdDogcmVxdWVzdCwgY2FsbGJhY2s6IGRvbmV9KTsKICAgICAgcmV0dXJuOwogICAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChlbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgICAgIGRvbmUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uTW9kZWwubmFtZSwKICAgICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICAgIH0pOwogICAgICBlbmRwb2ludFJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKICAKICAgICAgLy9wdXQgaW4gYSBwbGFjZWhvbGRlciBmb3IgZW5kcG9pbnRzIGFscmVhZHkgcmVxdWVzdGVkLCBwcmV2ZW50CiAgICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleVN0ciwgW3sKICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICBDYWNoZVBlcmlvZEluTWludXRlczogNjAgLy9sb25nLWxpdmUgY2FjaGUKICAgICAgfV0pOwogICAgICBlbmRwb2ludFJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICB2YXIgZXJyb3JQYXJhbXMgPSB7CiAgICAgICAgICAgIGNvZGU6ICdFbmRwb2ludERpc2NvdmVyeUV4Y2VwdGlvbicsCiAgICAgICAgICAgIG1lc3NhZ2U6ICdSZXF1ZXN0IGNhbm5vdCBiZSBmdWxmaWxsZWQgd2l0aG91dCBzcGVjaWZ5aW5nIGFuIGVuZHBvaW50JywKICAgICAgICAgICAgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UuZXJyb3IgPSB1dGlsLmVycm9yKGVyciwgZXJyb3JQYXJhbXMpOwogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKICAKICAgICAgICAgIC8vZmFpbCBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCBlcnJvclBhcmFtcyk7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQuY2FsbGJhY2soKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRlbGV0ZSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoZGF0YSkgewogICAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBkYXRhLkVuZHBvaW50cyk7CiAgICAgICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGRhdGEuRW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogIAogICAgICAgICAgLy91cGRhdGUgdGhlIGVuZHBvaW50IGZvciBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nUmVxdWVzdHMgPSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChkYXRhLkVuZHBvaW50c1swXS5BZGRyZXNzKTsKICAgICAgICAgICAgICByZXF1ZXN0Q29udGV4dC5jYWxsYmFjaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRvbmUoKTsKICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIGFkZCBhcGkgdmVyc2lvbiBoZWFkZXIgdG8gZW5kcG9pbnQgb3BlcmF0aW9uCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpIHsKICAgIHZhciBhcGkgPSBlbmRwb2ludFJlcXVlc3Quc2VydmljZS5hcGk7CiAgICB2YXIgYXBpVmVyc2lvbiA9IGFwaS5hcGlWZXJzaW9uOwogICAgaWYgKGFwaVZlcnNpb24gJiYgIWVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddKSB7CiAgICAgIGVuZHBvaW50UmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1hcGktdmVyc2lvbiddID0gYXBpVmVyc2lvbjsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogSWYgYXBpIGNhbGwgZ2V0cyBpbnZhbGlkIGVuZHBvaW50IGV4Y2VwdGlvbiwgU0RLIHNob3VsZCBhdHRlbXB0IHRvIHJlbW92ZSB0aGUgaW52YWxpZAogICAqIGVuZHBvaW50IGZyb20gY2FjaGUuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cyhyZXNwb25zZSkgewogICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICB2YXIgaHR0cFJlc3BvbnNlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlOwogICAgaWYgKGVycm9yICYmCiAgICAgIChlcnJvci5jb2RlID09PSAnSW52YWxpZEVuZHBvaW50RXhjZXB0aW9uJyB8fCBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDIxKQogICAgKSB7CiAgICAgIHZhciByZXF1ZXN0ID0gcmVzcG9uc2UucmVxdWVzdDsKICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgIHZhciBpbnB1dFNoYXBlID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gPyBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXS5pbnB1dCA6IHVuZGVmaW5lZDsKICAgICAgdmFyIGlkZW50aWZpZXJzID0gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycyhyZXF1ZXN0LCBpbnB1dFNoYXBlKTsKICAgICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICAgIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgICAgIGNhY2hlS2V5ID0gdXRpbC51cGRhdGUoY2FjaGVLZXksIGlkZW50aWZpZXJzKTsKICAgICAgICBpZiAob3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0pIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLm5hbWU7CiAgICAgIH0KICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogSWYgZW5kcG9pbnQgaXMgZXhwbGljaXRseSBjb25maWd1cmVkLCBTREsgc2hvdWxkIG5vdCBkbyBlbmRwb2ludCBkaXNjb3ZlcnkgaW4gYW55dGltZS4KICAgKiBAcGFyYW0gW29iamVjdF0gY2xpZW50IFNlcnZpY2UgY2xpZW50IG9iamVjdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBoYXNDdXN0b21FbmRwb2ludChjbGllbnQpIHsKICAgIC8vaWYgc2V0IGVuZHBvaW50IGlzIHNldCBmb3Igc3BlY2lmaWMgY2xpZW50LCBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5IHdpbGwgcmFpc2UgYW4gZXJyb3IuCiAgICBpZiAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50ICYmIGNsaWVudC5fb3JpZ2luYWxDb25maWcuZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkID09PSB0cnVlKSB7CiAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgbWVzc2FnZTogJ0N1c3RvbSBlbmRwb2ludCBpcyBzdXBwbGllZDsgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkIG11c3Qgbm90IGJlIHRydWUuJwogICAgICB9KTsKICAgIH07CiAgICB2YXIgc3ZjQ29uZmlnID0gQVdTLmNvbmZpZ1tjbGllbnQuc2VydmljZUlkZW50aWZpZXJdIHx8IHt9OwogICAgcmV0dXJuIEJvb2xlYW4oQVdTLmNvbmZpZy5lbmRwb2ludCB8fCBzdmNDb25maWcuZW5kcG9pbnQgfHwgKGNsaWVudC5fb3JpZ2luYWxDb25maWcgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludCkpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0ZhbHN5KHZhbHVlKSB7CiAgICByZXR1cm4gWydmYWxzZScsICcwJ10uaW5kZXhPZih2YWx1ZSkgPj0gMDsKICB9CiAgCiAgLyoqCiAgICogSWYgZW5kcG9pbnQgZGlzY292ZXJ5IHNob3VsZCBwZXJmb3JtIGZvciB0aGlzIHJlcXVlc3Qgd2hlbiBlbmRwb2ludCBkaXNjb3ZlcnkgaXMgb3B0aW9uYWwuCiAgICogU0RLIHBlcmZvcm1zIGNvbmZpZyByZXNvbHV0aW9uIGluIG9yZGVyIGxpa2UgYmVsb3c6CiAgICogMS4gSWYgdHVybmVkIG9uIGNsaWVudCBjb25maWd1cmF0aW9uKGRlZmF1bHQgdG8gb2ZmKSB0aGVuIHR1cm4gb24gZW5kcG9pbnQgZGlzY292ZXJ5LgogICAqIDIuIElmIHR1cm5lZCBvbiBpbiBlbnYgQVdTX0VOQUJMRV9FTkRQT0lOVF9ESVNDT1ZFUlkgdGhlbiB0dXJuIG9uIGVuZHBvaW50IGRpc2NvdmVyeS4KICAgKiAzLiBJZiB0dXJuZWQgb24gaW4gc2hhcmVkIGluaSBjb25maWcgZmlsZSB3aXRoIGtleSAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnLCB0aGVuCiAgICogICB0dXJuIG9uIGVuZHBvaW50IGRpc2NvdmVyeS4KICAgKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCByZXF1ZXN0IG9iamVjdC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBpc0VuZHBvaW50RGlzY292ZXJ5QXBwbGljYWJsZShyZXF1ZXN0KSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5lbmRwb2ludERpc2NvdmVyeUVuYWJsZWQgPT09IHRydWUpIHJldHVybiB0cnVlOwogIAogICAgLy9zaGFyZWQgaW5pIGZpbGUgaXMgb25seSBhdmFpbGFibGUgaW4gTm9kZQogICAgLy9ub3QgdG8gY2hlY2sgZW52IGluIGJyb3dzZXIKICAgIGlmICh1dGlsLmlzQnJvd3NlcigpKSByZXR1cm4gZmFsc2U7CiAgCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGVudiA9IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnNbaV07CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvY2Vzcy5lbnYsIGVudikpIHsKICAgICAgICBpZiAocHJvY2Vzcy5lbnZbZW52XSA9PT0gJycgfHwgcHJvY2Vzcy5lbnZbZW52XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICAgICAgbWVzc2FnZTogJ2Vudmlyb25tZW50YWwgdmFyaWFibGUgJyArIGVudiArICcgY2Fubm90IGJlIHNldCB0byBub3RoaW5nJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghaXNGYWxzeShwcm9jZXNzLmVudltlbnZdKSkgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAKICAgIHZhciBjb25maWdGaWxlID0ge307CiAgICB0cnkgewogICAgICBjb25maWdGaWxlID0gQVdTLnV0aWwuaW5pTG9hZGVyID8gQVdTLnV0aWwuaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICBpc0NvbmZpZzogdHJ1ZSwKICAgICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbQVdTLnV0aWwuc2hhcmVkQ29uZmlnRmlsZUVudl0KICAgICAgfSkgOiB7fTsKICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB2YXIgc2hhcmVkRmlsZUNvbmZpZyA9IGNvbmZpZ0ZpbGVbCiAgICAgIHByb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IEFXUy51dGlsLmRlZmF1bHRQcm9maWxlCiAgICBdIHx8IHt9OwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFyZWRGaWxlQ29uZmlnLCAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnKSkgewogICAgICBpZiAoc2hhcmVkRmlsZUNvbmZpZy5lbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgICAgbWVzc2FnZTogJ2NvbmZpZyBmaWxlIGVudHJ5IFwnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWRcJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFpc0ZhbHN5KHNoYXJlZEZpbGVDb25maWcuZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQpKSByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CiAgCiAgLyoqCiAgICogYXR0YWNoIGVuZHBvaW50IGRpc2NvdmVyeSBsb2dpYyB0byByZXF1ZXN0IG9iamVjdAogICAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0CiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKSB7CiAgICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICAgIGlmIChoYXNDdXN0b21FbmRwb2ludChzZXJ2aWNlKSB8fCByZXF1ZXN0LmlzUHJlc2lnbmVkKCkpIHJldHVybiBkb25lKCk7CiAgCiAgICBpZiAoIWlzRW5kcG9pbnREaXNjb3ZlcnlBcHBsaWNhYmxlKHJlcXVlc3QpKSByZXR1cm4gZG9uZSgpOwogIAogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5hcHBlbmRUb1VzZXJBZ2VudCgnZW5kcG9pbnQtZGlzY292ZXJ5Jyk7CiAgCiAgICB2YXIgb3BlcmF0aW9ucyA9IHNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBpc0VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgOiAnTlVMTCc7CiAgICBzd2l0Y2ggKGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCkgewogICAgICBjYXNlICdPUFRJT05BTCc6CiAgICAgICAgb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpOwogICAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICAgIGRvbmUoKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnUkVRVUlSRUQnOgogICAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICAgIHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0LCBkb25lKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAnTlVMTCc6CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgZG9uZSgpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGRpc2NvdmVyRW5kcG9pbnQ6IGRpc2NvdmVyRW5kcG9pbnQsCiAgICByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQ6IHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludCwKICAgIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludDogb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50LAogICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyczogbWFyc2hhbGxDdXN0b21JZGVudGlmaWVycywKICAgIGdldENhY2hlS2V5OiBnZXRDYWNoZUtleSwKICAgIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludDogaW52YWxpZGF0ZUNhY2hlZEVuZHBvaW50cywKICB9OwogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9jb3JlIjoxOCwiLi91dGlsIjo3MSwiX3Byb2Nlc3MiOjg2fV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBldmVudE1lc3NhZ2VDaHVua2VyID0gcmVxdWlyZSgnLi4vZXZlbnQtc3RyZWFtL2V2ZW50LW1lc3NhZ2UtY2h1bmtlcicpLmV2ZW50TWVzc2FnZUNodW5rZXI7CiAgdmFyIHBhcnNlRXZlbnQgPSByZXF1aXJlKCcuL3BhcnNlLWV2ZW50JykucGFyc2VFdmVudDsKICAKICBmdW5jdGlvbiBjcmVhdGVFdmVudFN0cmVhbShib2R5LCBwYXJzZXIsIG1vZGVsKSB7CiAgICAgIHZhciBldmVudE1lc3NhZ2VzID0gZXZlbnRNZXNzYWdlQ2h1bmtlcihib2R5KTsKICAKICAgICAgdmFyIGV2ZW50cyA9IFtdOwogIAogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50TWVzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGV2ZW50cy5wdXNoKHBhcnNlRXZlbnQocGFyc2VyLCBldmVudE1lc3NhZ2VzW2ldLCBtb2RlbCkpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBldmVudHM7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGVFdmVudFN0cmVhbTogY3JlYXRlRXZlbnRTdHJlYW0KICB9OwogIAogIH0seyIuLi9ldmVudC1zdHJlYW0vZXZlbnQtbWVzc2FnZS1jaHVua2VyIjoyOCwiLi9wYXJzZS1ldmVudCI6MzB9XSwyODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogVGFrZXMgaW4gYSBidWZmZXIgb2YgZXZlbnQgbWVzc2FnZXMgYW5kIHNwbGl0cyB0aGVtIGludG8gaW5kaXZpZHVhbCBtZXNzYWdlcy4KICAgKiBAcGFyYW0ge0J1ZmZlcn0gYnVmZmVyCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZXZlbnRNZXNzYWdlQ2h1bmtlcihidWZmZXIpIHsKICAgICAgLyoqIEB0eXBlIEJ1ZmZlcltdICovCiAgICAgIHZhciBtZXNzYWdlcyA9IFtdOwogICAgICB2YXIgb2Zmc2V0ID0gMDsKICAKICAgICAgd2hpbGUgKG9mZnNldCA8IGJ1ZmZlci5sZW5ndGgpIHsKICAgICAgICAgIHZhciB0b3RhbExlbmd0aCA9IGJ1ZmZlci5yZWFkSW50MzJCRShvZmZzZXQpOwogIAogICAgICAgICAgLy8gY3JlYXRlIG5ldyBidWZmZXIgZm9yIGluZGl2aWR1YWwgbWVzc2FnZSAoc2hhcmVzIG1lbW9yeSB3aXRoIG9yaWdpbmFsKQogICAgICAgICAgdmFyIG1lc3NhZ2UgPSBidWZmZXIuc2xpY2Uob2Zmc2V0LCB0b3RhbExlbmd0aCArIG9mZnNldCk7CiAgICAgICAgICAvLyBpbmNyZW1lbnQgb2Zmc2V0IHRvIGl0IHN0YXJ0cyBhdCB0aGUgbmV4dCBtZXNzYWdlCiAgICAgICAgICBvZmZzZXQgKz0gdG90YWxMZW5ndGg7CiAgCiAgICAgICAgICBtZXNzYWdlcy5wdXNoKG1lc3NhZ2UpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBtZXNzYWdlczsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGV2ZW50TWVzc2FnZUNodW5rZXI6IGV2ZW50TWVzc2FnZUNodW5rZXIKICB9OwogIAogIH0se31dLDI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL2NvcmUnKS51dGlsOwogIHZhciB0b0J1ZmZlciA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyOwogIAogIC8qKgogICAqIEEgbG9zc2xlc3MgcmVwcmVzZW50YXRpb24gb2YgYSBzaWduZWQsIDY0LWJpdCBpbnRlZ2VyLiBJbnN0YW5jZXMgb2YgdGhpcwogICAqIGNsYXNzIG1heSBiZSB1c2VkIGluIGFyaXRobWV0aWMgZXhwcmVzc2lvbnMgYXMgaWYgdGhleSB3ZXJlIG51bWVyaWMKICAgKiBwcmltaXRpdmVzLCBidXQgdGhlIGJpbmFyeSByZXByZXNlbnRhdGlvbiB3aWxsIGJlIHByZXNlcnZlZCB1bmNoYW5nZWQgYXMgdGhlCiAgICogYGJ5dGVzYCBwcm9wZXJ0eSBvZiB0aGUgb2JqZWN0LiBUaGUgYnl0ZXMgc2hvdWxkIGJlIGVuY29kZWQgYXMgYmlnLWVuZGlhbiwKICAgKiB0d28ncyBjb21wbGVtZW50IGludGVnZXJzLgogICAqIEBwYXJhbSB7QnVmZmVyfSBieXRlcwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gSW50NjQoYnl0ZXMpIHsKICAgICAgaWYgKGJ5dGVzLmxlbmd0aCAhPT0gOCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnQ2NCBidWZmZXJzIG11c3QgYmUgZXhhY3RseSA4IGJ5dGVzJyk7CiAgICAgIH0KICAgICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihieXRlcykpIGJ5dGVzID0gdG9CdWZmZXIoYnl0ZXMpOwogIAogICAgICB0aGlzLmJ5dGVzID0gYnl0ZXM7CiAgfQogIAogIC8qKgogICAqIEBwYXJhbSB7bnVtYmVyfSBudW1iZXIKICAgKiBAcmV0dXJucyB7SW50NjR9CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBJbnQ2NC5mcm9tTnVtYmVyID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgIGlmIChudW1iZXIgPiA5MjIzMzcyMDM2ODU0Nzc1ODA3IHx8IG51bWJlciA8IC05MjIzMzcyMDM2ODU0Nzc1ODA4KSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgbnVtYmVyICsgJyBpcyB0b28gbGFyZ2UgKG9yLCBpZiBuZWdhdGl2ZSwgdG9vIHNtYWxsKSB0byByZXByZXNlbnQgYXMgYW4gSW50NjQnCiAgICAgICAgICApOwogICAgICB9CiAgCiAgICAgIHZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KDgpOwogICAgICBmb3IgKAogICAgICAgICAgdmFyIGkgPSA3LCByZW1haW5pbmcgPSBNYXRoLmFicyhNYXRoLnJvdW5kKG51bWJlcikpOwogICAgICAgICAgaSA+IC0xICYmIHJlbWFpbmluZyA+IDA7CiAgICAgICAgICBpLS0sIHJlbWFpbmluZyAvPSAyNTYKICAgICAgKSB7CiAgICAgICAgICBieXRlc1tpXSA9IHJlbWFpbmluZzsKICAgICAgfQogIAogICAgICBpZiAobnVtYmVyIDwgMCkgewogICAgICAgICAgbmVnYXRlKGJ5dGVzKTsKICAgICAgfQogIAogICAgICByZXR1cm4gbmV3IEludDY0KGJ5dGVzKTsKICB9OwogIAogIC8qKgogICAqIEByZXR1cm5zIHtudW1iZXJ9CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBJbnQ2NC5wcm90b3R5cGUudmFsdWVPZiA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYnl0ZXMgPSB0aGlzLmJ5dGVzLnNsaWNlKDApOwogICAgICB2YXIgbmVnYXRpdmUgPSBieXRlc1swXSAmIDEyODsKICAgICAgaWYgKG5lZ2F0aXZlKSB7CiAgICAgICAgICBuZWdhdGUoYnl0ZXMpOwogICAgICB9CiAgCiAgICAgIHJldHVybiBwYXJzZUludChieXRlcy50b1N0cmluZygnaGV4JyksIDE2KSAqIChuZWdhdGl2ZSA/IC0xIDogMSk7CiAgfTsKICAKICBJbnQ2NC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzLnZhbHVlT2YoKSk7CiAgfTsKICAKICAvKioKICAgKiBAcGFyYW0ge0J1ZmZlcn0gYnl0ZXMKICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG5lZ2F0ZShieXRlcykgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDg7IGkrKykgewogICAgICAgICAgYnl0ZXNbaV0gXj0gMHhGRjsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gNzsgaSA+IC0xOyBpLS0pIHsKICAgICAgICAgIGJ5dGVzW2ldKys7CiAgICAgICAgICBpZiAoYnl0ZXNbaV0gIT09IDApIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgSW50NjQ6IEludDY0CiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSwzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHBhcnNlTWVzc2FnZSA9IHJlcXVpcmUoJy4vcGFyc2UtbWVzc2FnZScpLnBhcnNlTWVzc2FnZTsKICAKICAvKioKICAgKgogICAqIEBwYXJhbSB7Kn0gcGFyc2VyCiAgICogQHBhcmFtIHtCdWZmZXJ9IG1lc3NhZ2UKICAgKiBAcGFyYW0geyp9IHNoYXBlCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcGFyc2VFdmVudChwYXJzZXIsIG1lc3NhZ2UsIHNoYXBlKSB7CiAgICAgIHZhciBwYXJzZWRNZXNzYWdlID0gcGFyc2VNZXNzYWdlKG1lc3NhZ2UpOwogIAogICAgICAvLyBjaGVjayBpZiBtZXNzYWdlIGlzIGFuIGV2ZW50IG9yIGVycm9yCiAgICAgIHZhciBtZXNzYWdlVHlwZSA9IHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1snOm1lc3NhZ2UtdHlwZSddOwogICAgICBpZiAobWVzc2FnZVR5cGUpIHsKICAgICAgICAgIGlmIChtZXNzYWdlVHlwZS52YWx1ZSA9PT0gJ2Vycm9yJykgewogICAgICAgICAgICAgIHRocm93IHBhcnNlRXJyb3IocGFyc2VkTWVzc2FnZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG1lc3NhZ2VUeXBlLnZhbHVlICE9PSAnZXZlbnQnKSB7CiAgICAgICAgICAgICAgLy8gbm90IHN1cmUgaG93IHRvIHBhcnNlIG5vbi1ldmVudHMvbm9uLWVycm9ycywgaWdub3JlIGZvciBub3cKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgLy8gZGV0ZXJtaW5lIGV2ZW50IHR5cGUKICAgICAgdmFyIGV2ZW50VHlwZSA9IHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1snOmV2ZW50LXR5cGUnXTsKICAgICAgLy8gY2hlY2sgdGhhdCB0aGUgZXZlbnQgdHlwZSBpcyBtb2RlbGVkCiAgICAgIHZhciBldmVudE1vZGVsID0gc2hhcGUubWVtYmVyc1tldmVudFR5cGUudmFsdWVdOwogICAgICBpZiAoIWV2ZW50TW9kZWwpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogIAogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIC8vIGNoZWNrIGlmIGFuIGV2ZW50IHBheWxvYWQgZXhpc3RzCiAgICAgIHZhciBldmVudFBheWxvYWRNZW1iZXJOYW1lID0gZXZlbnRNb2RlbC5ldmVudFBheWxvYWRNZW1iZXJOYW1lOwogICAgICBpZiAoZXZlbnRQYXlsb2FkTWVtYmVyTmFtZSkgewogICAgICAgICAgdmFyIHBheWxvYWRTaGFwZSA9IGV2ZW50TW9kZWwubWVtYmVyc1tldmVudFBheWxvYWRNZW1iZXJOYW1lXTsKICAgICAgICAgIC8vIGlmIHRoZSBzaGFwZSBpcyBiaW5hcnksIHJldHVybiB0aGUgYnl0ZSBhcnJheQogICAgICAgICAgaWYgKHBheWxvYWRTaGFwZS50eXBlID09PSAnYmluYXJ5JykgewogICAgICAgICAgICAgIHJlc3VsdFtldmVudFBheWxvYWRNZW1iZXJOYW1lXSA9IHBhcnNlZE1lc3NhZ2UuYm9keTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdWx0W2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdID0gcGFyc2VyLnBhcnNlKHBhcnNlZE1lc3NhZ2UuYm9keS50b1N0cmluZygpLCBwYXlsb2FkU2hhcGUpOwogICAgICAgICAgfQogICAgICB9CiAgCiAgICAgIC8vIHJlYWQgZXZlbnQgaGVhZGVycwogICAgICB2YXIgZXZlbnRIZWFkZXJOYW1lcyA9IGV2ZW50TW9kZWwuZXZlbnRIZWFkZXJNZW1iZXJOYW1lczsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudEhlYWRlck5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGV2ZW50SGVhZGVyTmFtZXNbaV07CiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZS5oZWFkZXJzW25hbWVdKSB7CiAgICAgICAgICAgICAgLy8gcGFyc2UgdGhlIGhlYWRlciEKICAgICAgICAgICAgICByZXN1bHRbbmFtZV0gPSBldmVudE1vZGVsLm1lbWJlcnNbbmFtZV0udG9UeXBlKHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1tuYW1lXS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdmFyIG91dHB1dCA9IHt9OwogICAgICBvdXRwdXRbZXZlbnRUeXBlLnZhbHVlXSA9IHJlc3VsdDsKICAgICAgcmV0dXJuIG91dHB1dDsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VFcnJvcihtZXNzYWdlKSB7CiAgICAgIHZhciBlcnJvckNvZGUgPSBtZXNzYWdlLmhlYWRlcnNbJzplcnJvci1jb2RlJ107CiAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSBtZXNzYWdlLmhlYWRlcnNbJzplcnJvci1tZXNzYWdlJ107CiAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UudmFsdWUgfHwgZXJyb3JNZXNzYWdlKTsKICAgICAgZXJyb3IuY29kZSA9IGVycm9yLm5hbWUgPSBlcnJvckNvZGUudmFsdWUgfHwgZXJyb3JDb2RlOwogICAgICByZXR1cm4gZXJyb3I7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgICBwYXJzZUV2ZW50OiBwYXJzZUV2ZW50CiAgfTsKICAKICB9LHsiLi9wYXJzZS1tZXNzYWdlIjozMX1dLDMxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgSW50NjQgPSByZXF1aXJlKCcuL2ludDY0JykuSW50NjQ7CiAgCiAgdmFyIHNwbGl0TWVzc2FnZSA9IHJlcXVpcmUoJy4vc3BsaXQtbWVzc2FnZScpLnNwbGl0TWVzc2FnZTsKICAKICB2YXIgQk9PTEVBTl9UQUcgPSAnYm9vbGVhbic7CiAgdmFyIEJZVEVfVEFHID0gJ2J5dGUnOwogIHZhciBTSE9SVF9UQUcgPSAnc2hvcnQnOwogIHZhciBJTlRfVEFHID0gJ2ludGVnZXInOwogIHZhciBMT05HX1RBRyA9ICdsb25nJzsKICB2YXIgQklOQVJZX1RBRyA9ICdiaW5hcnknOwogIHZhciBTVFJJTkdfVEFHID0gJ3N0cmluZyc7CiAgdmFyIFRJTUVTVEFNUF9UQUcgPSAndGltZXN0YW1wJzsKICB2YXIgVVVJRF9UQUcgPSAndXVpZCc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBAcGFyYW0ge0J1ZmZlcn0gaGVhZGVycwogICAqLwogIGZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgICAgIHZhciBvdXQgPSB7fTsKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgd2hpbGUgKHBvc2l0aW9uIDwgaGVhZGVycy5sZW5ndGgpIHsKICAgICAgICAgIHZhciBuYW1lTGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDgocG9zaXRpb24rKyk7CiAgICAgICAgICB2YXIgbmFtZSA9IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgbmFtZUxlbmd0aCkudG9TdHJpbmcoKTsKICAgICAgICAgIHBvc2l0aW9uICs9IG5hbWVMZW5ndGg7CiAgICAgICAgICBzd2l0Y2ggKGhlYWRlcnMucmVhZFVJbnQ4KHBvc2l0aW9uKyspKSB7CiAgICAgICAgICAgICAgY2FzZSAwIC8qIGJvb2xUcnVlICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCT09MRUFOX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0cnVlCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMSAvKiBib29sRmFsc2UgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IEJPT0xFQU5fVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZhbHNlCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMiAvKiBieXRlICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBCWVRFX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQ4KHBvc2l0aW9uKyspCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgMyAvKiBzaG9ydCAqLzoKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogU0hPUlRfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDE2QkUocG9zaXRpb24pCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNCAvKiBpbnRlZ2VyICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBJTlRfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDMyQkUocG9zaXRpb24pCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgNSAvKiBsb25nICovOgogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBMT05HX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBuZXcgSW50NjQoaGVhZGVycy5zbGljZShwb3NpdGlvbiwgcG9zaXRpb24gKyA4KSkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gODsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA2IC8qIGJ5dGVBcnJheSAqLzoKICAgICAgICAgICAgICAgICAgdmFyIGJpbmFyeUxlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQxNkJFKHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogQklOQVJZX1RBRywKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIGJpbmFyeUxlbmd0aCkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gYmluYXJ5TGVuZ3RoOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIDcgLyogc3RyaW5nICovOgogICAgICAgICAgICAgICAgICB2YXIgc3RyaW5nTGVuZ3RoID0gaGVhZGVycy5yZWFkVUludDE2QkUocG9zaXRpb24pOwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBTVFJJTkdfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMuc2xpY2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKyBzdHJpbmdMZW5ndGgKICAgICAgICAgICAgICAgICAgICAgICkudG9TdHJpbmcoKQogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSBzdHJpbmdMZW5ndGg7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgOCAvKiB0aW1lc3RhbXAgKi86CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRJTUVTVEFNUF9UQUcsCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3IERhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IEludDY0KGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgOCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC52YWx1ZU9mKCkKICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gODsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSA5IC8qIHV1aWQgKi86CiAgICAgICAgICAgICAgICAgIHZhciB1dWlkQ2hhcnMgPSBoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDE2KQogICAgICAgICAgICAgICAgICAgICAgLnRvU3RyaW5nKCdoZXgnKTsKICAgICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMTY7CiAgICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFVVSURfVEFHLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHV1aWRDaGFycy5zdWJzdHIoMCwgOCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoOCwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMTIsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDE2LCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigyMCkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnJlY29nbml6ZWQgaGVhZGVyIHR5cGUgdGFnJyk7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VNZXNzYWdlKG1lc3NhZ2UpIHsKICAgICAgdmFyIHBhcnNlZCA9IHNwbGl0TWVzc2FnZShtZXNzYWdlKTsKICAgICAgcmV0dXJuIHsgaGVhZGVyczogcGFyc2VIZWFkZXJzKHBhcnNlZC5oZWFkZXJzKSwgYm9keTogcGFyc2VkLmJvZHkgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHBhcnNlTWVzc2FnZTogcGFyc2VNZXNzYWdlCiAgfTsKICAKICB9LHsiLi9pbnQ2NCI6MjksIi4vc3BsaXQtbWVzc2FnZSI6MzJ9XSwzMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlJykudXRpbDsKICB2YXIgdG9CdWZmZXIgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcjsKICAKICAvLyBBbGwgcHJlbHVkZSBjb21wb25lbnRzIGFyZSB1bnNpZ25lZCwgMzItYml0IGludGVnZXJzCiAgdmFyIFBSRUxVREVfTUVNQkVSX0xFTkdUSCA9IDQ7CiAgLy8gVGhlIHByZWx1ZGUgY29uc2lzdHMgb2YgdHdvIGNvbXBvbmVudHMKICB2YXIgUFJFTFVERV9MRU5HVEggPSBQUkVMVURFX01FTUJFUl9MRU5HVEggKiAyOwogIC8vIENoZWNrc3VtcyBhcmUgYWx3YXlzIENSQzMyIGhhc2hlcy4KICB2YXIgQ0hFQ0tTVU1fTEVOR1RIID0gNDsKICAvLyBNZXNzYWdlcyBtdXN0IGluY2x1ZGUgYSBmdWxsIHByZWx1ZGUsIGEgcHJlbHVkZSBjaGVja3N1bSwgYW5kIGEgbWVzc2FnZSBjaGVja3N1bQogIHZhciBNSU5JTVVNX01FU1NBR0VfTEVOR1RIID0gUFJFTFVERV9MRU5HVEggKyBDSEVDS1NVTV9MRU5HVEggKiAyOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogQHBhcmFtIHtCdWZmZXJ9IG1lc3NhZ2UKICAgKi8KICBmdW5jdGlvbiBzcGxpdE1lc3NhZ2UobWVzc2FnZSkgewogICAgICBpZiAoIXV0aWwuQnVmZmVyLmlzQnVmZmVyKG1lc3NhZ2UpKSBtZXNzYWdlID0gdG9CdWZmZXIobWVzc2FnZSk7CiAgCiAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCA8IE1JTklNVU1fTUVTU0FHRV9MRU5HVEgpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUHJvdmlkZWQgbWVzc2FnZSB0b28gc2hvcnQgdG8gYWNjb21tb2RhdGUgZXZlbnQgc3RyZWFtIG1lc3NhZ2Ugb3ZlcmhlYWQnKTsKICAgICAgfQogIAogICAgICBpZiAobWVzc2FnZS5sZW5ndGggIT09IG1lc3NhZ2UucmVhZFVJbnQzMkJFKDApKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcG9ydGVkIG1lc3NhZ2UgbGVuZ3RoIGRvZXMgbm90IG1hdGNoIHJlY2VpdmVkIG1lc3NhZ2UgbGVuZ3RoJyk7CiAgICAgIH0KICAKICAgICAgdmFyIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtID0gbWVzc2FnZS5yZWFkVUludDMyQkUoUFJFTFVERV9MRU5HVEgpOwogIAogICAgICBpZiAoCiAgICAgICAgICBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSAhPT0gdXRpbC5jcnlwdG8uY3JjMzIoCiAgICAgICAgICAgICAgbWVzc2FnZS5zbGljZSgwLCBQUkVMVURFX0xFTkdUSCkKICAgICAgICAgICkKICAgICAgKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgJ1RoZSBwcmVsdWRlIGNoZWNrc3VtIHNwZWNpZmllZCBpbiB0aGUgbWVzc2FnZSAoJyArCiAgICAgICAgICAgICAgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gKwogICAgICAgICAgICAgICcpIGRvZXMgbm90IG1hdGNoIHRoZSBjYWxjdWxhdGVkIENSQzMyIGNoZWNrc3VtLicKICAgICAgICAgICk7CiAgICAgIH0KICAKICAgICAgdmFyIGV4cGVjdGVkTWVzc2FnZUNoZWNrc3VtID0gbWVzc2FnZS5yZWFkVUludDMyQkUobWVzc2FnZS5sZW5ndGggLSBDSEVDS1NVTV9MRU5HVEgpOwogIAogICAgICBpZiAoCiAgICAgICAgICBleHBlY3RlZE1lc3NhZ2VDaGVja3N1bSAhPT0gdXRpbC5jcnlwdG8uY3JjMzIoCiAgICAgICAgICAgICAgbWVzc2FnZS5zbGljZSgwLCBtZXNzYWdlLmxlbmd0aCAtIENIRUNLU1VNX0xFTkdUSCkKICAgICAgICAgICkKICAgICAgKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICAgJ1RoZSBtZXNzYWdlIGNoZWNrc3VtIGRpZCBub3QgbWF0Y2ggdGhlIGV4cGVjdGVkIHZhbHVlIG9mICcgKwogICAgICAgICAgICAgICAgICBleHBlY3RlZE1lc3NhZ2VDaGVja3N1bQogICAgICAgICAgKTsKICAgICAgfQogIAogICAgICB2YXIgaGVhZGVyc1N0YXJ0ID0gUFJFTFVERV9MRU5HVEggKyBDSEVDS1NVTV9MRU5HVEg7CiAgICAgIHZhciBoZWFkZXJzRW5kID0gaGVhZGVyc1N0YXJ0ICsgbWVzc2FnZS5yZWFkVUludDMyQkUoUFJFTFVERV9NRU1CRVJfTEVOR1RIKTsKICAKICAgICAgcmV0dXJuIHsKICAgICAgICAgIGhlYWRlcnM6IG1lc3NhZ2Uuc2xpY2UoaGVhZGVyc1N0YXJ0LCBoZWFkZXJzRW5kKSwKICAgICAgICAgIGJvZHk6IG1lc3NhZ2Uuc2xpY2UoaGVhZGVyc0VuZCwgbWVzc2FnZS5sZW5ndGggLSBDSEVDS1NVTV9MRU5HVEgpLAogICAgICB9OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgc3BsaXRNZXNzYWdlOiBzcGxpdE1lc3NhZ2UKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOH1dLDMzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIFNlcXVlbnRpYWxFeGVjdXRvciA9IHJlcXVpcmUoJy4vc2VxdWVudGlhbF9leGVjdXRvcicpOwogIHZhciBESVNDT1ZFUl9FTkRQT0lOVCA9IHJlcXVpcmUoJy4vZGlzY292ZXJfZW5kcG9pbnQnKS5kaXNjb3ZlckVuZHBvaW50OwogIC8qKgogICAqIFRoZSBuYW1lc3BhY2UgdXNlZCB0byByZWdpc3RlciBnbG9iYWwgZXZlbnQgbGlzdGVuZXJzIGZvciByZXF1ZXN0IGJ1aWxkaW5nCiAgICogYW5kIHNlbmRpbmcuCiAgICovCiAgQVdTLkV2ZW50TGlzdGVuZXJzID0gewogICAgLyoqCiAgICAgKiBAIWF0dHJpYnV0ZSBWQUxJREFURV9DUkVERU5USUFMUwogICAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgd2hldGhlciB0aGUgcmVxdWVzdCBpcyBiZWluZwogICAgICogICBzZW50IHdpdGggY3JlZGVudGlhbHMuCiAgICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyBjcmVkZW50aWFscwogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgbGlzdGVuZXIpOwogICAgICogICBAcmVhZG9ubHkKICAgICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICAgKiBAIWF0dHJpYnV0ZSBWQUxJREFURV9SRUdJT04KICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIHdoZXRoZXIgdGhlIHJlZ2lvbiBpcyBzZXQKICAgICAqICAgZm9yIGEgcmVxdWVzdC4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIHJlZ2lvbiBjb25maWd1cmF0aW9uCiAgICAgKiAgICAgdmFyIGxpc3RlbmVyID0gQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUkVHSU9OOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgbGlzdGVuZXIpOwogICAgICogICBAcmVhZG9ubHkKICAgICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICAgKiBAIWF0dHJpYnV0ZSBWQUxJREFURV9QQVJBTUVURVJTCiAgICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyBpbnB1dCBwYXJhbWV0ZXJzIGluIGEgcmVxdWVzdC4KICAgICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIHBhcmFtZXRlcnMKICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywgbGlzdGVuZXIpOwogICAgICogICBAZXhhbXBsZSBEaXNhYmxlIHBhcmFtZXRlciB2YWxpZGF0aW9uIGdsb2JhbGx5CiAgICAgKiAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywKICAgICAqICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTik7CiAgICAgKiAgIEByZWFkb25seQogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqIEAhYXR0cmlidXRlIFNFTkQKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgaW5pdGlhdGVzIHRoZSBIVFRQIGNvbm5lY3Rpb24gZm9yIGEKICAgICAqICAgcmVxdWVzdCBiZWluZyBzZW50LiBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+c2VuZCAnc2VuZCcgUmVxdWVzdCBldmVudH0KICAgICAqICAgQGV4YW1wbGUgUmVwbGFjaW5nIHRoZSBIVFRQIGhhbmRsZXIKICAgICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5EOwogICAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3NlbmQnLCBsaXN0ZW5lcik7CiAgICAgKiAgICAgcmVxdWVzdC5vbignc2VuZCcsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgKiAgICAgICBjdXN0b21IYW5kbGVyLnNlbmQocmVzcG9uc2UpOwogICAgICogICAgIH0pOwogICAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgICAqICAgQHJlYWRvbmx5CiAgICAgKiBAIWF0dHJpYnV0ZSBIVFRQX0RBVEEKICAgICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgcmVhZHMgZGF0YSBmcm9tIHRoZSBIVFRQIGNvbm5lY3Rpb24gaW4gb3JkZXIKICAgICAqICAgdG8gYnVpbGQgdGhlIHJlc3BvbnNlIGRhdGEuCiAgICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH5odHRwRGF0YSAnaHR0cERhdGEnIFJlcXVlc3QgZXZlbnR9LgogICAgICogICBSZW1vdmUgdGhpcyBoYW5kbGVyIGlmIHlvdSBhcmUgb3ZlcnJpZGluZyB0aGUgJ2h0dHBEYXRhJyBldmVudCBhbmQKICAgICAqICAgZG8gbm90IHdhbnQgZXh0cmEgZGF0YSBwcm9jZXNzaW5nIGFuZCBidWZmZXJpbmcgb3ZlcmhlYWQuCiAgICAgKiAgIEBleGFtcGxlIERpc2FibGluZyBkZWZhdWx0IGRhdGEgcHJvY2Vzc2luZwogICAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQTsKICAgICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdodHRwRGF0YScsIGxpc3RlbmVyKTsKICAgICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICAgKiAgIEByZWFkb25seQogICAgICovCiAgICBDb3JlOiB7fSAvKiBkb2MgaGFjayAqLwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZ2V0T3BlcmF0aW9uQXV0aHR5cGUocmVxKSB7CiAgICBpZiAoIXJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zKSB7CiAgICAgIHJldHVybiAnJzsKICAgIH0KICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHJldHVybiBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICB9CiAgCiAgQVdTLkV2ZW50TGlzdGVuZXJzID0gewogICAgQ29yZTogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCwgYWRkQXN5bmMpIHsKICAgICAgYWRkQXN5bmMoJ1ZBTElEQVRFX0NSRURFTlRJQUxTJywgJ3ZhbGlkYXRlJywKICAgICAgICAgIGZ1bmN0aW9uIFZBTElEQVRFX0NSRURFTlRJQUxTKHJlcSwgZG9uZSkgewogICAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24gJiYgIXJlcS5zZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgICAgICAgcmVxLnNlcnZpY2UuY29uZmlnLmdldENyZWRlbnRpYWxzKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnIsCiAgICAgICAgICAgICAge2NvZGU6ICdDcmVkZW50aWFsc0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgY3JlZGVudGlhbHMgaW4gY29uZmlnJ30pOwogICAgICAgICAgfQogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0pOwogICAgICB9KTsKICAKICAgICAgYWRkKCdWQUxJREFURV9SRUdJT04nLCAndmFsaWRhdGUnLCBmdW5jdGlvbiBWQUxJREFURV9SRUdJT04ocmVxKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5jb25maWcucmVnaW9uICYmICFyZXEuc2VydmljZS5pc0dsb2JhbEVuZHBvaW50KSB7CiAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdDb25maWdFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIHJlZ2lvbiBpbiBjb25maWcnfSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdCVUlMRF9JREVNUE9URU5DWV9UT0tFTlMnLCAndmFsaWRhdGUnLCBmdW5jdGlvbiBCVUlMRF9JREVNUE9URU5DWV9UT0tFTlMocmVxKSB7CiAgICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgICAgaWYgKCFvcGVyYXRpb24pIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGlkZW1wb3RlbnRNZW1iZXJzID0gb3BlcmF0aW9uLmlkZW1wb3RlbnRNZW1iZXJzOwogICAgICAgIGlmICghaWRlbXBvdGVudE1lbWJlcnMubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIGNyZWF0ZXMgYSBjb3B5IG9mIHBhcmFtcyBzbyB1c2VyJ3MgcGFyYW0gb2JqZWN0IGlzbid0IG11dGF0ZWQKICAgICAgICB2YXIgcGFyYW1zID0gQVdTLnV0aWwuY29weShyZXEucGFyYW1zKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGlkZW1wb3RlbnRNZW1iZXJzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgaWYgKCFwYXJhbXNbaWRlbXBvdGVudE1lbWJlcnNbaV1dKSB7CiAgICAgICAgICAgIC8vIGFkZCB0aGUgbWVtYmVyCiAgICAgICAgICAgIHBhcmFtc1tpZGVtcG90ZW50TWVtYmVyc1tpXV0gPSBBV1MudXRpbC51dWlkLnY0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlcS5wYXJhbXMgPSBwYXJhbXM7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1ZBTElEQVRFX1BBUkFNRVRFUlMnLCAndmFsaWRhdGUnLCBmdW5jdGlvbiBWQUxJREFURV9QQVJBTUVURVJTKHJlcSkgewogICAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgICAgICAgdmFyIHZhbGlkYXRpb24gPSByZXEuc2VydmljZS5jb25maWcucGFyYW1WYWxpZGF0aW9uOwogICAgICAgIG5ldyBBV1MuUGFyYW1WYWxpZGF0b3IodmFsaWRhdGlvbikudmFsaWRhdGUocnVsZXMsIHJlcS5wYXJhbXMpOwogICAgICB9KTsKICAKICAgICAgYWRkQXN5bmMoJ0NPTVBVVEVfU0hBMjU2JywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBDT01QVVRFX1NIQTI1NihyZXEsIGRvbmUpIHsKICAgICAgICByZXEuaGFsdEhhbmRsZXJzT25FcnJvcigpOwogICAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICAgIHZhciBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24gJiYgIWF1dGh0eXBlICYmICFyZXEuc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQogICAgICAgIGlmIChyZXEuc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXEpID09PSBBV1MuU2lnbmVycy5WNCkgewogICAgICAgICAgdmFyIGJvZHkgPSByZXEuaHR0cFJlcXVlc3QuYm9keSB8fCAnJzsKICAgICAgICAgIGlmIChhdXRodHlwZS5pbmRleE9mKCd1bnNpZ25lZC1ib2R5JykgPj0gMCkgewogICAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXSA9ICdVTlNJR05FRC1QQVlMT0FEJzsKICAgICAgICAgICAgcmV0dXJuIGRvbmUoKTsKICAgICAgICAgIH0KICAgICAgICAgIEFXUy51dGlsLmNvbXB1dGVTaGEyNTYoYm9keSwgZnVuY3Rpb24oZXJyLCBzaGEpIHsKICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgIGRvbmUoZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXSA9IHNoYTsKICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdTRVRfQ09OVEVOVF9MRU5HVEgnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIFNFVF9DT05URU5UX0xFTkdUSChyZXEpIHsKICAgICAgICB2YXIgYXV0aHR5cGUgPSBnZXRPcGVyYXRpb25BdXRodHlwZShyZXEpOwogICAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gQVdTLnV0aWwuZ2V0UmVxdWVzdFBheWxvYWRTaGFwZShyZXEpOwogICAgICAgIGlmIChyZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbGVuZ3RoID0gQVdTLnV0aWwuc3RyaW5nLmJ5dGVMZW5ndGgocmVxLmh0dHBSZXF1ZXN0LmJvZHkpOwogICAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9IGxlbmd0aDsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBpZiAocGF5bG9hZE1lbWJlciAmJiBwYXlsb2FkTWVtYmVyLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWRNZW1iZXIucmVxdWlyZXNMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vc3RyZWFtaW5nIHBheWxvYWQgcmVxdWlyZXMgbGVuZ3RoKHMzLCBnbGFjaWVyKQogICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXV0aHR5cGUuaW5kZXhPZigndW5zaWduZWQtYm9keScpID49IDApIHsKICAgICAgICAgICAgICAgIC8vdW5ib3VuZGVkIHN0cmVhbWluZyBwYXlsb2FkKGxleCwgbWVkaWFzdG9yZSkKICAgICAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydUcmFuc2Zlci1FbmNvZGluZyddID0gJ2NodW5rZWQnOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1NFVF9IVFRQX0hPU1QnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIFNFVF9IVFRQX0hPU1QocmVxKSB7CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0hvc3QnXSA9IHJlcS5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0OwogICAgICB9KTsKICAKICAgICAgYWRkKCdSRVNUQVJUJywgJ3Jlc3RhcnQnLCBmdW5jdGlvbiBSRVNUQVJUKCkgewogICAgICAgIHZhciBlcnIgPSB0aGlzLnJlc3BvbnNlLmVycm9yOwogICAgICAgIGlmICghZXJyIHx8ICFlcnIucmV0cnlhYmxlKSByZXR1cm47CiAgCiAgICAgICAgdGhpcy5odHRwUmVxdWVzdCA9IG5ldyBBV1MuSHR0cFJlcXVlc3QoCiAgICAgICAgICB0aGlzLnNlcnZpY2UuZW5kcG9pbnQsCiAgICAgICAgICB0aGlzLnNlcnZpY2UucmVnaW9uCiAgICAgICAgKTsKICAKICAgICAgICBpZiAodGhpcy5yZXNwb25zZS5yZXRyeUNvdW50IDwgdGhpcy5zZXJ2aWNlLmNvbmZpZy5tYXhSZXRyaWVzKSB7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlLnJldHJ5Q291bnQrKzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgdmFyIGFkZFRvSGVhZCA9IHRydWU7CiAgICAgIGFkZEFzeW5jKCdESVNDT1ZFUl9FTkRQT0lOVCcsICdzaWduJywgRElTQ09WRVJfRU5EUE9JTlQsIGFkZFRvSGVhZCk7CiAgCiAgICAgIGFkZEFzeW5jKCdTSUdOJywgJ3NpZ24nLCBmdW5jdGlvbiBTSUdOKHJlcSwgZG9uZSkgewogICAgICAgIHZhciBzZXJ2aWNlID0gcmVxLnNlcnZpY2U7CiAgICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucyB8fCB7fTsKICAgICAgICB2YXIgb3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgICAgICB2YXIgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgICAgICBpZiAoIXNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24gJiYgIWF1dGh0eXBlICYmICFzZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgCiAgICAgICAgc2VydmljZS5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24gKGVyciwgY3JlZGVudGlhbHMpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgICAgfQogIAogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGRhdGUgPSBzZXJ2aWNlLmdldFNrZXdDb3JyZWN0ZWREYXRlKCk7CiAgICAgICAgICAgIHZhciBTaWduZXJDbGFzcyA9IHNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxKTsKICAgICAgICAgICAgdmFyIHNpZ25lciA9IG5ldyBTaWduZXJDbGFzcyhyZXEuaHR0cFJlcXVlc3QsCiAgICAgICAgICAgICAgc2VydmljZS5hcGkuc2lnbmluZ05hbWUgfHwgc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2lnbmF0dXJlQ2FjaGU6IHNlcnZpY2UuY29uZmlnLnNpZ25hdHVyZUNhY2hlLAogICAgICAgICAgICAgICAgb3BlcmF0aW9uOiBvcGVyYXRpb24sCiAgICAgICAgICAgICAgICBzaWduYXR1cmVWZXJzaW9uOiBzZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHNpZ25lci5zZXRTZXJ2aWNlQ2xpZW50SWQoc2VydmljZS5fY2xpZW50SWQpOwogIAogICAgICAgICAgICAvLyBjbGVhciBvbGQgYXV0aG9yaXphdGlvbiBoZWFkZXJzCiAgICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddOwogICAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0RhdGUnXTsKICAgICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ107CiAgCiAgICAgICAgICAgIC8vIGFkZCBuZXcgYXV0aG9yaXphdGlvbgogICAgICAgICAgICBzaWduZXIuYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSk7CiAgICAgICAgICAgIHJlcS5zaWduZWRBdCA9IGRhdGU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJlcS5yZXNwb25zZS5lcnJvciA9IGU7CiAgICAgICAgICB9CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICBhZGQoJ1ZBTElEQVRFX1JFU1BPTlNFJywgJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbiBWQUxJREFURV9SRVNQT05TRShyZXNwKSB7CiAgICAgICAgaWYgKHRoaXMuc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgdGhpcykpIHsKICAgICAgICAgIHJlc3AuZGF0YSA9IHt9OwogICAgICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgICAgICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgIHtjb2RlOiAnVW5rbm93bkVycm9yJywgbWVzc2FnZTogJ0FuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuJ30pOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZEFzeW5jKCdTRU5EJywgJ3NlbmQnLCBmdW5jdGlvbiBTRU5EKHJlc3AsIGRvbmUpIHsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5fYWJvcnRDYWxsYmFjayA9IGRvbmU7CiAgICAgICAgcmVzcC5lcnJvciA9IG51bGw7CiAgICAgICAgcmVzcC5kYXRhID0gbnVsbDsKICAKICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhodHRwUmVzcCkgewogICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtID0gaHR0cFJlc3A7CiAgICAgICAgICB2YXIgc3RyZWFtID0gcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnN0cmVhbTsKICAgICAgICAgIHZhciBzZXJ2aWNlID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgICAgICB2YXIgYXBpID0gc2VydmljZS5hcGk7CiAgICAgICAgICB2YXIgb3BlcmF0aW9uTmFtZSA9IHJlc3AucmVxdWVzdC5vcGVyYXRpb247CiAgICAgICAgICB2YXIgb3BlcmF0aW9uID0gYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uTmFtZV0gfHwge307CiAgCiAgICAgICAgICBodHRwUmVzcC5vbignaGVhZGVycycsIGZ1bmN0aW9uIG9uSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCBzdGF0dXNNZXNzYWdlKSB7CiAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KAogICAgICAgICAgICAgICdodHRwSGVhZGVycycsCiAgICAgICAgICAgICAgW3N0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3AsIHN0YXR1c01lc3NhZ2VdCiAgICAgICAgICAgICk7CiAgCiAgICAgICAgICAgIGlmICghcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtaW5nKSB7CiAgICAgICAgICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7IC8vIHN0cmVhbXMyIEFQSSBjaGVjawogICAgICAgICAgICAgICAgLy8gaWYgd2UgZGV0ZWN0IGV2ZW50IHN0cmVhbXMsIHdlJ3JlIGdvaW5nIHRvIGhhdmUgdG8KICAgICAgICAgICAgICAgIC8vIHJldHVybiB0aGUgc3RyZWFtIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBpZiAob3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0ICYmIHNlcnZpY2Uuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApKSB7CiAgICAgICAgICAgICAgICAgIC8vIHNraXAgcmVhZGluZyB0aGUgSW5jb21pbmdTdHJlYW0KICAgICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb25lJyk7CiAgICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogIAogICAgICAgICAgICAgICAgaHR0cFJlc3Aub24oJ3JlYWRhYmxlJywgZnVuY3Rpb24gb25SZWFkYWJsZSgpIHsKICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBodHRwUmVzcC5yZWFkKCk7CiAgICAgICAgICAgICAgICAgIGlmIChkYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEYXRhJywgW2RhdGEsIHJlc3BdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gbGVnYWN5IHN0cmVhbXMgQVBJCiAgICAgICAgICAgICAgICBodHRwUmVzcC5vbignZGF0YScsIGZ1bmN0aW9uIG9uRGF0YShkYXRhKSB7CiAgICAgICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRGF0YScsIFtkYXRhLCByZXNwXSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogIAogICAgICAgICAgaHR0cFJlc3Aub24oJ2VuZCcsIGZ1bmN0aW9uIG9uRW5kKCkgewogICAgICAgICAgICBpZiAoIXN0cmVhbSB8fCAhc3RyZWFtLmRpZENhbGxiYWNrKSB7CiAgICAgICAgICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyICYmIChvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQgJiYgc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkpKSB7CiAgICAgICAgICAgICAgICAvLyBkb24ndCBjb25jYXRlbmF0ZSByZXNwb25zZSBjaHVua3Mgd2hlbiBzdHJlYW1pbmcgZXZlbnQgc3RyZWFtIGRhdGEgd2hlbiByZXNwb25zZSBpcyBzdWNjZXNzZnVsCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG9uZScpOwogICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogIAogICAgICAgIGZ1bmN0aW9uIHByb2dyZXNzKGh0dHBSZXNwKSB7CiAgICAgICAgICBodHRwUmVzcC5vbignc2VuZFByb2dyZXNzJywgZnVuY3Rpb24gb25TZW5kUHJvZ3Jlc3ModmFsdWUpIHsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBVcGxvYWRQcm9ncmVzcycsIFt2YWx1ZSwgcmVzcF0pOwogICAgICAgICAgfSk7CiAgCiAgICAgICAgICBodHRwUmVzcC5vbigncmVjZWl2ZVByb2dyZXNzJywgZnVuY3Rpb24gb25SZWNlaXZlUHJvZ3Jlc3ModmFsdWUpIHsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb3dubG9hZFByb2dyZXNzJywgW3ZhbHVlLCByZXNwXSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZXJyKSB7CiAgICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdSZXF1ZXN0QWJvcnRlZEVycm9yJykgewogICAgICAgICAgICB2YXIgZXJyQ29kZSA9IGVyci5jb2RlID09PSAnVGltZW91dEVycm9yJyA/IGVyci5jb2RlIDogJ05ldHdvcmtpbmdFcnJvcic7CiAgICAgICAgICAgIGVyciA9IEFXUy51dGlsLmVycm9yKGVyciwgewogICAgICAgICAgICAgIGNvZGU6IGVyckNvZGUsCiAgICAgICAgICAgICAgcmVnaW9uOiByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uLAogICAgICAgICAgICAgIGhvc3RuYW1lOiByZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmVzcC5lcnJvciA9IGVycjsKICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRXJyb3InLCBbcmVzcC5lcnJvciwgcmVzcF0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZVNlbmQoKSB7CiAgICAgICAgICB2YXIgaHR0cCA9IEFXUy5IdHRwQ2xpZW50LmdldEluc3RhbmNlKCk7CiAgICAgICAgICB2YXIgaHR0cE9wdGlvbnMgPSByZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuaHR0cE9wdGlvbnMgfHwge307CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgc3RyZWFtID0gaHR0cC5oYW5kbGVSZXF1ZXN0KHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2ssIGVycm9yKTsKICAgICAgICAgICAgcHJvZ3Jlc3Moc3RyZWFtKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBlcnJvcihlcnIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdGltZURpZmYgPSAocmVzcC5yZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKSAtIHRoaXMuc2lnbmVkQXQpIC8gMTAwMDsKICAgICAgICBpZiAodGltZURpZmYgPj0gNjAgKiAxMCkgeyAvLyBpZiB3ZSBzaWduZWQgMTBtaW4gYWdvLCByZS1zaWduCiAgICAgICAgICB0aGlzLmVtaXQoJ3NpZ24nLCBbdGhpc10sIGZ1bmN0aW9uKGVycikgewogICAgICAgICAgICBpZiAoZXJyKSBkb25lKGVycik7CiAgICAgICAgICAgIGVsc2UgZXhlY3V0ZVNlbmQoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBleGVjdXRlU2VuZCgpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSFRUUF9IRUFERVJTJywgJ2h0dHBIZWFkZXJzJywKICAgICAgICAgIGZ1bmN0aW9uIEhUVFBfSEVBREVSUyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwLCBzdGF0dXNNZXNzYWdlKSB7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZSA9IHN0YXR1c01lc3NhZ2U7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYm9keSA9IEFXUy51dGlsLmJ1ZmZlci50b0J1ZmZlcignJyk7CiAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVycyA9IFtdOwogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLm51bUJ5dGVzID0gMDsKICAgICAgICB2YXIgZGF0ZUhlYWRlciA9IGhlYWRlcnMuZGF0ZSB8fCBoZWFkZXJzLkRhdGU7CiAgICAgICAgdmFyIHNlcnZpY2UgPSByZXNwLnJlcXVlc3Quc2VydmljZTsKICAgICAgICBpZiAoZGF0ZUhlYWRlcikgewogICAgICAgICAgdmFyIHNlcnZlclRpbWUgPSBEYXRlLnBhcnNlKGRhdGVIZWFkZXIpOwogICAgICAgICAgaWYgKHNlcnZpY2UuY29uZmlnLmNvcnJlY3RDbG9ja1NrZXcKICAgICAgICAgICAgICAmJiBzZXJ2aWNlLmlzQ2xvY2tTa2V3ZWQoc2VydmVyVGltZSkpIHsKICAgICAgICAgICAgc2VydmljZS5hcHBseUNsb2NrT2Zmc2V0KHNlcnZlclRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnSFRUUF9EQVRBJywgJ2h0dHBEYXRhJywgZnVuY3Rpb24gSFRUUF9EQVRBKGNodW5rLCByZXNwKSB7CiAgICAgICAgaWYgKGNodW5rKSB7CiAgICAgICAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkpIHsKICAgICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMgKz0gY2h1bmsubGVuZ3RoOwogIAogICAgICAgICAgICB2YXIgdG90YWwgPSByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydjb250ZW50LWxlbmd0aCddOwogICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSB7IGxvYWRlZDogcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMsIHRvdGFsOiB0b3RhbCB9OwogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvd25sb2FkUHJvZ3Jlc3MnLCBbcHJvZ3Jlc3MsIHJlc3BdKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMucHVzaChBV1MudXRpbC5idWZmZXIudG9CdWZmZXIoY2h1bmspKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0hUVFBfRE9ORScsICdodHRwRG9uZScsIGZ1bmN0aW9uIEhUVFBfRE9ORShyZXNwKSB7CiAgICAgICAgLy8gY29udmVydCBidWZmZXJzIGFycmF5IGludG8gc2luZ2xlIGJ1ZmZlcgogICAgICAgIGlmIChyZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzICYmIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyIGJvZHkgPSBBV1MudXRpbC5idWZmZXIuY29uY2F0KHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMpOwogICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYm9keSA9IGJvZHk7CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlczsKICAgICAgICBkZWxldGUgcmVzcC5odHRwUmVzcG9uc2UuYnVmZmVyczsKICAgICAgfSk7CiAgCiAgICAgIGFkZCgnRklOQUxJWkVfRVJST1InLCAncmV0cnknLCBmdW5jdGlvbiBGSU5BTElaRV9FUlJPUihyZXNwKSB7CiAgICAgICAgaWYgKHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICAgIHJlc3AuZXJyb3Iuc3RhdHVzQ29kZSA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgICBpZiAocmVzcC5lcnJvci5yZXRyeWFibGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRoaXMuc2VydmljZS5yZXRyeWFibGVFcnJvcihyZXNwLmVycm9yLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICBhZGQoJ0lOVkFMSURBVEVfQ1JFREVOVElBTFMnLCAncmV0cnknLCBmdW5jdGlvbiBJTlZBTElEQVRFX0NSRURFTlRJQUxTKHJlc3ApIHsKICAgICAgICBpZiAoIXJlc3AuZXJyb3IpIHJldHVybjsKICAgICAgICBzd2l0Y2ggKHJlc3AuZXJyb3IuY29kZSkgewogICAgICAgICAgY2FzZSAnUmVxdWVzdEV4cGlyZWQnOiAvLyBFQzIgb25seQogICAgICAgICAgY2FzZSAnRXhwaXJlZFRva2VuRXhjZXB0aW9uJzoKICAgICAgICAgIGNhc2UgJ0V4cGlyZWRUb2tlbic6CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmV4cGlyZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnRVhQSVJFRF9TSUdOQVRVUkUnLCAncmV0cnknLCBmdW5jdGlvbiBFWFBJUkVEX1NJR05BVFVSRShyZXNwKSB7CiAgICAgICAgdmFyIGVyciA9IHJlc3AuZXJyb3I7CiAgICAgICAgaWYgKCFlcnIpIHJldHVybjsKICAgICAgICBpZiAodHlwZW9mIGVyci5jb2RlID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgZXJyLm1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpZiAoZXJyLmNvZGUubWF0Y2goL1NpZ25hdHVyZS8pICYmIGVyci5tZXNzYWdlLm1hdGNoKC9leHBpcmVkLykpIHsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnQ0xPQ0tfU0tFV0VEJywgJ3JldHJ5JywgZnVuY3Rpb24gQ0xPQ0tfU0tFV0VEKHJlc3ApIHsKICAgICAgICBpZiAoIXJlc3AuZXJyb3IpIHJldHVybjsKICAgICAgICBpZiAodGhpcy5zZXJ2aWNlLmNsb2NrU2tld0Vycm9yKHJlc3AuZXJyb3IpCiAgICAgICAgICAgICYmIHRoaXMuc2VydmljZS5jb25maWcuY29ycmVjdENsb2NrU2tldykgewogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnUkVESVJFQ1QnLCAncmV0cnknLCBmdW5jdGlvbiBSRURJUkVDVChyZXNwKSB7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IgJiYgcmVzcC5lcnJvci5zdGF0dXNDb2RlID49IDMwMCAmJgogICAgICAgICAgICByZXNwLmVycm9yLnN0YXR1c0NvZGUgPCA0MDAgJiYgcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1snbG9jYXRpb24nXSkgewogICAgICAgICAgdGhpcy5odHRwUmVxdWVzdC5lbmRwb2ludCA9CiAgICAgICAgICAgIG5ldyBBV1MuRW5kcG9pbnQocmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1snbG9jYXRpb24nXSk7CiAgICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0hvc3QnXSA9IHRoaXMuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdDsKICAgICAgICAgIHJlc3AuZXJyb3IucmVkaXJlY3QgPSB0cnVlOwogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZCgnUkVUUllfQ0hFQ0snLCAncmV0cnknLCBmdW5jdGlvbiBSRVRSWV9DSEVDSyhyZXNwKSB7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICAgIGlmIChyZXNwLmVycm9yLnJlZGlyZWN0ICYmIHJlc3AucmVkaXJlY3RDb3VudCA8IHJlc3AubWF4UmVkaXJlY3RzKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9IDA7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3AucmV0cnlDb3VudCA8IHJlc3AubWF4UmV0cmllcykgewogICAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSB0aGlzLnNlcnZpY2UucmV0cnlEZWxheXMocmVzcC5yZXRyeUNvdW50KSB8fCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIGFkZEFzeW5jKCdSRVNFVF9SRVRSWV9TVEFURScsICdhZnRlclJldHJ5JywgZnVuY3Rpb24gUkVTRVRfUkVUUllfU1RBVEUocmVzcCwgZG9uZSkgewogICAgICAgIHZhciBkZWxheSwgd2lsbFJldHJ5ID0gZmFsc2U7CiAgCiAgICAgICAgaWYgKHJlc3AuZXJyb3IpIHsKICAgICAgICAgIGRlbGF5ID0gcmVzcC5lcnJvci5yZXRyeURlbGF5IHx8IDA7CiAgICAgICAgICBpZiAocmVzcC5lcnJvci5yZXRyeWFibGUgJiYgcmVzcC5yZXRyeUNvdW50IDwgcmVzcC5tYXhSZXRyaWVzKSB7CiAgICAgICAgICAgIHJlc3AucmV0cnlDb3VudCsrOwogICAgICAgICAgICB3aWxsUmV0cnkgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChyZXNwLmVycm9yLnJlZGlyZWN0ICYmIHJlc3AucmVkaXJlY3RDb3VudCA8IHJlc3AubWF4UmVkaXJlY3RzKSB7CiAgICAgICAgICAgIHJlc3AucmVkaXJlY3RDb3VudCsrOwogICAgICAgICAgICB3aWxsUmV0cnkgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICBpZiAod2lsbFJldHJ5KSB7CiAgICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICAgIHNldFRpbWVvdXQoZG9uZSwgZGVsYXkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pLAogIAogICAgQ29yZVBvc3Q6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgYWRkKCdFWFRSQUNUX1JFUVVFU1RfSUQnLCAnZXh0cmFjdERhdGEnLCBBV1MudXRpbC5leHRyYWN0UmVxdWVzdElkKTsKICAgICAgYWRkKCdFWFRSQUNUX1JFUVVFU1RfSUQnLCAnZXh0cmFjdEVycm9yJywgQVdTLnV0aWwuZXh0cmFjdFJlcXVlc3RJZCk7CiAgCiAgICAgIGFkZCgnRU5PVEZPVU5EX0VSUk9SJywgJ2h0dHBFcnJvcicsIGZ1bmN0aW9uIEVOT1RGT1VORF9FUlJPUihlcnIpIHsKICAgICAgICBpZiAoZXJyLmNvZGUgPT09ICdOZXR3b3JraW5nRXJyb3InICYmIGVyci5lcnJubyA9PT0gJ0VOT1RGT1VORCcpIHsKICAgICAgICAgIHZhciBtZXNzYWdlID0gJ0luYWNjZXNzaWJsZSBob3N0OiBgJyArIGVyci5ob3N0bmFtZSArCiAgICAgICAgICAgICdcJy4gVGhpcyBzZXJ2aWNlIG1heSBub3QgYmUgYXZhaWxhYmxlIGluIHRoZSBgJyArIGVyci5yZWdpb24gKwogICAgICAgICAgICAnXCcgcmVnaW9uLic7CiAgICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1lc3NhZ2UpLCB7CiAgICAgICAgICAgIGNvZGU6ICdVbmtub3duRW5kcG9pbnQnLAogICAgICAgICAgICByZWdpb246IGVyci5yZWdpb24sCiAgICAgICAgICAgIGhvc3RuYW1lOiBlcnIuaG9zdG5hbWUsCiAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZSwKICAgICAgICAgICAgb3JpZ2luYWxFcnJvcjogZXJyCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSksCiAgCiAgICBMb2dnZXI6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgICAgYWRkKCdMT0dfUkVRVUVTVCcsICdjb21wbGV0ZScsIGZ1bmN0aW9uIExPR19SRVFVRVNUKHJlc3ApIHsKICAgICAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgICAgIHZhciBsb2dnZXIgPSByZXEuc2VydmljZS5jb25maWcubG9nZ2VyOwogICAgICAgIGlmICghbG9nZ2VyKSByZXR1cm47CiAgICAgICAgZnVuY3Rpb24gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUsIHNoYXBlKSB7CiAgICAgICAgICBpZiAoIXNoYXBlKSB7CiAgICAgICAgICAgIHJldHVybiBzaGFwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoaW5wdXRTaGFwZS50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6CiAgICAgICAgICAgICAgdmFyIHN0cnVjdCA9IHt9OwogICAgICAgICAgICAgIEFXUy51dGlsLmVhY2goc2hhcGUsIGZ1bmN0aW9uKHN1YlNoYXBlTmFtZSwgc3ViU2hhcGUpIHsKICAgICAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaW5wdXRTaGFwZS5tZW1iZXJzLCBzdWJTaGFwZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIHN0cnVjdFtzdWJTaGFwZU5hbWVdID0gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUubWVtYmVyc1tzdWJTaGFwZU5hbWVdLCBzdWJTaGFwZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdHJ1Y3Rbc3ViU2hhcGVOYW1lXSA9IHN1YlNoYXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJldHVybiBzdHJ1Y3Q7CiAgICAgICAgICAgIGNhc2UgJ2xpc3QnOgogICAgICAgICAgICAgIHZhciBsaXN0ID0gW107CiAgICAgICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNoYXBlLCBmdW5jdGlvbihzdWJTaGFwZSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIGxpc3QucHVzaChmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZS5tZW1iZXIsIHN1YlNoYXBlKSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgICAgICAgIGNhc2UgJ21hcCc6CiAgICAgICAgICAgICAgdmFyIG1hcCA9IHt9OwogICAgICAgICAgICAgIEFXUy51dGlsLmVhY2goc2hhcGUsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIG1hcFtrZXldID0gZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUudmFsdWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmIChpbnB1dFNoYXBlLmlzU2Vuc2l0aXZlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJyoqKlNlbnNpdGl2ZUluZm9ybWF0aW9uKioqJzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgCiAgICAgICAgZnVuY3Rpb24gYnVpbGRNZXNzYWdlKCkgewogICAgICAgICAgdmFyIHRpbWUgPSByZXNwLnJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICAgIHZhciBkZWx0YSA9ICh0aW1lIC0gcmVxLnN0YXJ0VGltZS5nZXRUaW1lKCkpIC8gMTAwMDsKICAgICAgICAgIHZhciBhbnNpID0gbG9nZ2VyLmlzVFRZID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgdmFyIHN0YXR1cyA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgICB2YXIgY2Vuc29yZWRQYXJhbXMgPSByZXEucGFyYW1zOwogICAgICAgICAgaWYgKAogICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucyAmJgogICAgICAgICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0gJiYKICAgICAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0CiAgICAgICAgICApIHsKICAgICAgICAgICAgdmFyIGlucHV0U2hhcGUgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgICAgICAgICAgY2Vuc29yZWRQYXJhbXMgPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZSwgcmVxLnBhcmFtcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyYW1zID0gcmVxdWlyZSgndXRpbCcpLmluc3BlY3QoY2Vuc29yZWRQYXJhbXMsIHRydWUsIG51bGwpOwogICAgICAgICAgdmFyIG1lc3NhZ2UgPSAnJzsKICAgICAgICAgIGlmIChhbnNpKSBtZXNzYWdlICs9ICdceDFCWzMzbSc7CiAgICAgICAgICBtZXNzYWdlICs9ICdbQVdTICcgKyByZXEuc2VydmljZS5zZXJ2aWNlSWRlbnRpZmllciArICcgJyArIHN0YXR1czsKICAgICAgICAgIG1lc3NhZ2UgKz0gJyAnICsgZGVsdGEudG9TdHJpbmcoKSArICdzICcgKyByZXNwLnJldHJ5Q291bnQgKyAnIHJldHJpZXNdJzsKICAgICAgICAgIGlmIChhbnNpKSBtZXNzYWdlICs9ICdceDFCWzA7MW0nOwogICAgICAgICAgbWVzc2FnZSArPSAnICcgKyBBV1MudXRpbC5zdHJpbmcubG93ZXJGaXJzdChyZXEub3BlcmF0aW9uKTsKICAgICAgICAgIG1lc3NhZ2UgKz0gJygnICsgcGFyYW1zICsgJyknOwogICAgICAgICAgaWYgKGFuc2kpIG1lc3NhZ2UgKz0gJ1x4MUJbMG0nOwogICAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgICAgfQogIAogICAgICAgIHZhciBsaW5lID0gYnVpbGRNZXNzYWdlKCk7CiAgICAgICAgaWYgKHR5cGVvZiBsb2dnZXIubG9nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBsb2dnZXIubG9nKGxpbmUpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGxvZ2dlci53cml0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgbG9nZ2VyLndyaXRlKGxpbmUgKyAnXG4nKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSksCiAgCiAgICBKc29uOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL2pzb24nKTsKICAgICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICAgIH0pLAogIAogICAgUmVzdDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9yZXN0Jyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFJlc3RKc29uOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfanNvbicpOwogICAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogICAgfSksCiAgCiAgICBSZXN0WG1sOiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfeG1sJyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KSwKICAKICAgIFF1ZXJ5OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3F1ZXJ5Jyk7CiAgICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgICB9KQogIH07CiAgCiAgfSx7Ii4vY29yZSI6MTgsIi4vZGlzY292ZXJfZW5kcG9pbnQiOjI2LCIuL3Byb3RvY29sL2pzb24iOjQ2LCIuL3Byb3RvY29sL3F1ZXJ5Ijo0NywiLi9wcm90b2NvbC9yZXN0Ijo0OCwiLi9wcm90b2NvbC9yZXN0X2pzb24iOjQ5LCIuL3Byb3RvY29sL3Jlc3RfeG1sIjo1MCwiLi9zZXF1ZW50aWFsX2V4ZWN1dG9yIjo1OCwidXRpbCI6OTd9XSwzNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICAKICAvKioKICAgKiBUaGUgZW5kcG9pbnQgdGhhdCBhIHNlcnZpY2Ugd2lsbCB0YWxrIHRvLCBmb3IgZXhhbXBsZSwKICAgKiBgJ2h0dHBzOi8vZWMyLmFwLXNvdXRoZWFzdC0xLmFtYXpvbmF3cy5jb20nYC4gSWYKICAgKiB5b3UgbmVlZCB0byBvdmVycmlkZSBhbiBlbmRwb2ludCBmb3IgYSBzZXJ2aWNlLCB5b3UgY2FuCiAgICogc2V0IHRoZSBlbmRwb2ludCBvbiBhIHNlcnZpY2UgYnkgcGFzc2luZyB0aGUgZW5kcG9pbnQKICAgKiBvYmplY3Qgd2l0aCB0aGUgYGVuZHBvaW50YCBvcHRpb24ga2V5OgogICAqCiAgICogYGBgamF2YXNjcmlwdAogICAqIHZhciBlcCA9IG5ldyBBV1MuRW5kcG9pbnQoJ2F3c3Byb3h5LmV4YW1wbGUuY29tJyk7CiAgICogdmFyIHMzID0gbmV3IEFXUy5TMyh7ZW5kcG9pbnQ6IGVwfSk7CiAgICogczMuc2VydmljZS5lbmRwb2ludC5ob3N0bmFtZSA9PSAnYXdzcHJveHkuZXhhbXBsZS5jb20nCiAgICogYGBgCiAgICoKICAgKiBOb3RlIHRoYXQgaWYgeW91IGRvIG5vdCBzcGVjaWZ5IGEgcHJvdG9jb2wsIHRoZSBwcm90b2NvbCB3aWxsCiAgICogYmUgc2VsZWN0ZWQgYmFzZWQgb24geW91ciBjdXJyZW50IHtBV1MuY29uZmlnfSBjb25maWd1cmF0aW9uLgogICAqCiAgICogQCFhdHRyaWJ1dGUgcHJvdG9jb2wKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHByb3RvY29sIChodHRwIG9yIGh0dHBzKSBvZiB0aGUgZW5kcG9pbnQKICAgKiAgICAgVVJMCiAgICogQCFhdHRyaWJ1dGUgaG9zdG5hbWUKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGhvc3QgcG9ydGlvbiBvZiB0aGUgZW5kcG9pbnQsIGUuZy4sCiAgICogICAgIGV4YW1wbGUuY29tCiAgICogQCFhdHRyaWJ1dGUgaG9zdAogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgaG9zdCBwb3J0aW9uIG9mIHRoZSBlbmRwb2ludCBpbmNsdWRpbmcKICAgKiAgICAgdGhlIHBvcnQsIGUuZy4sIGV4YW1wbGUuY29tOjgwCiAgICogQCFhdHRyaWJ1dGUgcG9ydAogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIHBvcnQgb2YgdGhlIGVuZHBvaW50CiAgICogQCFhdHRyaWJ1dGUgaHJlZgogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgZnVsbCBVUkwgb2YgdGhlIGVuZHBvaW50CiAgICovCiAgQVdTLkVuZHBvaW50ID0gaW5oZXJpdCh7CiAgCiAgICAvKioKICAgICAqIEBvdmVybG9hZCBFbmRwb2ludChlbmRwb2ludCkKICAgICAqICAgQ29uc3RydWN0cyBhIG5ldyBlbmRwb2ludCBnaXZlbiBhbiBlbmRwb2ludCBVUkwuIElmIHRoZQogICAgICogICBVUkwgb21pdHMgYSBwcm90b2NvbCAoaHR0cCBvciBodHRwcyksIHRoZSBkZWZhdWx0IHByb3RvY29sCiAgICAgKiAgIHNldCBpbiB0aGUgZ2xvYmFsIHtBV1MuY29uZmlnfSB3aWxsIGJlIHVzZWQuCiAgICAgKiAgIEBwYXJhbSBlbmRwb2ludCBbU3RyaW5nXSB0aGUgVVJMIHRvIGNvbnN0cnVjdCBhbiBlbmRwb2ludCBmcm9tCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBFbmRwb2ludChlbmRwb2ludCwgY29uZmlnKSB7CiAgICAgIEFXUy51dGlsLmhpZGVQcm9wZXJ0aWVzKHRoaXMsIFsnc2xhc2hlcycsICdhdXRoJywgJ2hhc2gnLCAnc2VhcmNoJywgJ3F1ZXJ5J10pOwogIAogICAgICBpZiAodHlwZW9mIGVuZHBvaW50ID09PSAndW5kZWZpbmVkJyB8fCBlbmRwb2ludCA9PT0gbnVsbCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBlbmRwb2ludDogJyArIGVuZHBvaW50KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZW5kcG9pbnQgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIEFXUy51dGlsLmNvcHkoZW5kcG9pbnQpOwogICAgICB9CiAgCiAgICAgIGlmICghZW5kcG9pbnQubWF0Y2goL15odHRwLykpIHsKICAgICAgICB2YXIgdXNlU1NMID0gY29uZmlnICYmIGNvbmZpZy5zc2xFbmFibGVkICE9PSB1bmRlZmluZWQgPwogICAgICAgICAgY29uZmlnLnNzbEVuYWJsZWQgOiBBV1MuY29uZmlnLnNzbEVuYWJsZWQ7CiAgICAgICAgZW5kcG9pbnQgPSAodXNlU1NMID8gJ2h0dHBzJyA6ICdodHRwJykgKyAnOi8vJyArIGVuZHBvaW50OwogICAgICB9CiAgCiAgICAgIEFXUy51dGlsLnVwZGF0ZSh0aGlzLCBBV1MudXRpbC51cmxQYXJzZShlbmRwb2ludCkpOwogIAogICAgICAvLyBFbnN1cmUgdGhlIHBvcnQgcHJvcGVydHkgaXMgc2V0IGFzIGFuIGludGVnZXIKICAgICAgaWYgKHRoaXMucG9ydCkgewogICAgICAgIHRoaXMucG9ydCA9IHBhcnNlSW50KHRoaXMucG9ydCwgMTApOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucG9ydCA9IHRoaXMucHJvdG9jb2wgPT09ICdodHRwczonID8gNDQzIDogODA7CiAgICAgIH0KICAgIH0KICAKICB9KTsKICAKICAvKioKICAgKiBUaGUgbG93IGxldmVsIEhUVFAgcmVxdWVzdCBvYmplY3QsIGVuY2Fwc3VsYXRpbmcgYWxsIEhUVFAgaGVhZGVyCiAgICogYW5kIGJvZHkgZGF0YSBzZW50IGJ5IGEgc2VydmljZSByZXF1ZXN0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgbWV0aG9kCiAgICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBIVFRQIG1ldGhvZCBvZiB0aGUgcmVxdWVzdAogICAqIEAhYXR0cmlidXRlIHBhdGgKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHBhdGggcG9ydGlvbiBvZiB0aGUgVVJJLCBlLmcuLAogICAqICAgICAiL2xpc3QvP3N0YXJ0PTUmbnVtPTEwIgogICAqIEAhYXR0cmlidXRlIGhlYWRlcnMKICAgKiAgIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0KICAgKiAgICAgYSBtYXAgb2YgaGVhZGVyIGtleXMgYW5kIHRoZWlyIHJlc3BlY3RpdmUgdmFsdWVzCiAgICogQCFhdHRyaWJ1dGUgYm9keQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVxdWVzdCBib2R5IHBheWxvYWQKICAgKiBAIWF0dHJpYnV0ZSBlbmRwb2ludAogICAqICAgQHJldHVybiBbQVdTLkVuZHBvaW50XSB0aGUgZW5kcG9pbnQgZm9yIHRoZSByZXF1ZXN0CiAgICogQCFhdHRyaWJ1dGUgcmVnaW9uCiAgICogICBAYXBpIHByaXZhdGUKICAgKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlZ2lvbiwgZm9yIHNpZ25pbmcgcHVycG9zZXMgb25seS4KICAgKi8KICBBV1MuSHR0cFJlcXVlc3QgPSBpbmhlcml0KHsKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBIdHRwUmVxdWVzdChlbmRwb2ludCwgcmVnaW9uKSB7CiAgICAgIGVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludCk7CiAgICAgIHRoaXMubWV0aG9kID0gJ1BPU1QnOwogICAgICB0aGlzLnBhdGggPSBlbmRwb2ludC5wYXRoIHx8ICcvJzsKICAgICAgdGhpcy5oZWFkZXJzID0ge307CiAgICAgIHRoaXMuYm9keSA9ICcnOwogICAgICB0aGlzLmVuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICAgIHRoaXMucmVnaW9uID0gcmVnaW9uOwogICAgICB0aGlzLl91c2VyQWdlbnQgPSAnJzsKICAgICAgdGhpcy5zZXRVc2VyQWdlbnQoKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzZXRVc2VyQWdlbnQ6IGZ1bmN0aW9uIHNldFVzZXJBZ2VudCgpIHsKICAgICAgdGhpcy5fdXNlckFnZW50ID0gdGhpcy5oZWFkZXJzW3RoaXMuZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpXSA9IEFXUy51dGlsLnVzZXJBZ2VudCgpOwogICAgfSwKICAKICAgIGdldFVzZXJBZ2VudEhlYWRlck5hbWU6IGZ1bmN0aW9uIGdldFVzZXJBZ2VudEhlYWRlck5hbWUoKSB7CiAgICAgIHZhciBwcmVmaXggPSBBV1MudXRpbC5pc0Jyb3dzZXIoKSA/ICdYLUFtei0nIDogJyc7CiAgICAgIHJldHVybiBwcmVmaXggKyAnVXNlci1BZ2VudCc7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYXBwZW5kVG9Vc2VyQWdlbnQ6IGZ1bmN0aW9uIGFwcGVuZFRvVXNlckFnZW50KGFnZW50UGFydGlhbCkgewogICAgICBpZiAodHlwZW9mIGFnZW50UGFydGlhbCA9PT0gJ3N0cmluZycgJiYgYWdlbnRQYXJ0aWFsKSB7CiAgICAgICAgdGhpcy5fdXNlckFnZW50ICs9ICcgJyArIGFnZW50UGFydGlhbDsKICAgICAgfQogICAgICB0aGlzLmhlYWRlcnNbdGhpcy5nZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCldID0gdGhpcy5fdXNlckFnZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFVzZXJBZ2VudDogZnVuY3Rpb24gZ2V0VXNlckFnZW50KCkgewogICAgICByZXR1cm4gdGhpcy5fdXNlckFnZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgcGFydCBvZiB0aGUge3BhdGh9IGV4Y2x1ZGluZyB0aGUKICAgICAqICAgcXVlcnkgc3RyaW5nCiAgICAgKi8KICAgIHBhdGhuYW1lOiBmdW5jdGlvbiBwYXRobmFtZSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGF0aC5zcGxpdCgnPycsIDEpWzBdOwogICAgfSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgcXVlcnkgc3RyaW5nIHBvcnRpb24gb2YgdGhlIHtwYXRofQogICAgICovCiAgICBzZWFyY2g6IGZ1bmN0aW9uIHNlYXJjaCgpIHsKICAgICAgdmFyIHF1ZXJ5ID0gdGhpcy5wYXRoLnNwbGl0KCc/JywgMilbMV07CiAgICAgIGlmIChxdWVyeSkgewogICAgICAgIHF1ZXJ5ID0gQVdTLnV0aWwucXVlcnlTdHJpbmdQYXJzZShxdWVyeSk7CiAgICAgICAgcmV0dXJuIEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXVlcnkpOwogICAgICB9CiAgICAgIHJldHVybiAnJzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICogdXBkYXRlIGh0dHBSZXF1ZXN0IGVuZHBvaW50IHdpdGggZW5kcG9pbnQgc3RyaW5nCiAgICAgKi8KICAgIHVwZGF0ZUVuZHBvaW50OiBmdW5jdGlvbiB1cGRhdGVFbmRwb2ludChlbmRwb2ludFN0cikgewogICAgICB2YXIgbmV3RW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50U3RyKTsKICAgICAgdGhpcy5lbmRwb2ludCA9IG5ld0VuZHBvaW50OwogICAgICB0aGlzLnBhdGggPSBuZXdFbmRwb2ludC5wYXRoIHx8ICcvJzsKICAgIH0KICB9KTsKICAKICAvKioKICAgKiBUaGUgbG93IGxldmVsIEhUVFAgcmVzcG9uc2Ugb2JqZWN0LCBlbmNhcHN1bGF0aW5nIGFsbCBIVFRQIGhlYWRlcgogICAqIGFuZCBib2R5IGRhdGEgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgKgogICAqIEAhYXR0cmlidXRlIHN0YXR1c0NvZGUKICAgKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZSAoZS5nLiwgMjAwLCA0MDQpCiAgICogQCFhdHRyaWJ1dGUgaGVhZGVycwogICAqICAgQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XQogICAqICAgICAgYSBtYXAgb2YgcmVzcG9uc2UgaGVhZGVyIGtleXMgYW5kIHRoZWlyIHJlc3BlY3RpdmUgdmFsdWVzCiAgICogQCFhdHRyaWJ1dGUgYm9keQogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcmVzcG9uc2UgYm9keSBwYXlsb2FkCiAgICogQCFhdHRyaWJ1dGUgW3JdIHN0cmVhbWluZwogICAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGlzIHJlc3BvbnNlIGlzIGJlaW5nIHN0cmVhbWVkIGF0IGEgbG93LWxldmVsLgogICAqICAgICBEZWZhdWx0cyB0byBgZmFsc2VgIChidWZmZXJlZCByZWFkcykuIERvIG5vdCBtb2RpZnkgdGhpcyBtYW51YWxseSwgdXNlCiAgICogICAgIHtjcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtfSB0byBjb252ZXJ0IHRoZSBzdHJlYW0gdG8gdW5idWZmZXJlZCBtb2RlCiAgICogICAgIGluc3RlYWQuCiAgICovCiAgQVdTLkh0dHBSZXNwb25zZSA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEh0dHBSZXNwb25zZSgpIHsKICAgICAgdGhpcy5zdGF0dXNDb2RlID0gdW5kZWZpbmVkOwogICAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgICAgdGhpcy5ib2R5ID0gdW5kZWZpbmVkOwogICAgICB0aGlzLnN0cmVhbWluZyA9IGZhbHNlOwogICAgICB0aGlzLnN0cmVhbSA9IG51bGw7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBEaXNhYmxlcyBidWZmZXJpbmcgb24gdGhlIEhUVFAgcmVzcG9uc2UgYW5kIHJldHVybnMgdGhlIHN0cmVhbSBmb3IgcmVhZGluZy4KICAgICAqIEByZXR1cm4gW1N0cmVhbSwgWE1MSHR0cFJlcXVlc3QsIG51bGxdIHRoZSB1bmRlcmx5aW5nIHN0cmVhbSBvYmplY3QuCiAgICAgKiAgIFVzZSB0aGlzIG9iamVjdCB0byBkaXJlY3RseSByZWFkIGRhdGEgb2ZmIG9mIHRoZSBzdHJlYW0uCiAgICAgKiBAbm90ZSBUaGlzIG9iamVjdCBpcyBvbmx5IGF2YWlsYWJsZSBhZnRlciB0aGUge0FXUy5SZXF1ZXN0fmh0dHBIZWFkZXJzfQogICAgICogICBldmVudCBoYXMgZmlyZWQuIFRoaXMgbWV0aG9kIG11c3QgYmUgY2FsbGVkIHByaW9yIHRvCiAgICAgKiAgIHtBV1MuUmVxdWVzdH5odHRwRGF0YX0uCiAgICAgKiBAZXhhbXBsZSBUYWtpbmcgY29udHJvbCBvZiBhIHN0cmVhbQogICAgICogICByZXF1ZXN0Lm9uKCdodHRwSGVhZGVycycsIGZ1bmN0aW9uKHN0YXR1c0NvZGUsIGhlYWRlcnMpIHsKICAgICAqICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICogICAgICAgaWYgKGhlYWRlcnMuZXRhZyA9PT0gJ3h5eicpIHsKICAgICAqICAgICAgICAgLy8gcGlwZSB0aGUgc3RyZWFtLCBkaXNhYmxpbmcgYnVmZmVyaW5nCiAgICAgKiAgICAgICAgIHZhciBzdHJlYW0gPSB0aGlzLnJlc3BvbnNlLmh0dHBSZXNwb25zZS5jcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtKCk7CiAgICAgKiAgICAgICAgIHN0cmVhbS5waXBlKHByb2Nlc3Muc3Rkb3V0KTsKICAgICAqICAgICAgIH0gZWxzZSB7IC8vIGFib3J0IHRoaXMgcmVxdWVzdCBhbmQgc2V0IGEgYmV0dGVyIGVycm9yIG1lc3NhZ2UKICAgICAqICAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICogICAgICAgICB0aGlzLnJlc3BvbnNlLmVycm9yID0gbmV3IEVycm9yKCdJbnZhbGlkIEVUYWcnKTsKICAgICAqICAgICAgIH0KICAgICAqICAgICB9CiAgICAgKiAgIH0pLnNlbmQoY29uc29sZS5sb2cpOwogICAgICovCiAgICBjcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtOiBmdW5jdGlvbiBjcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtKCkgewogICAgICB0aGlzLnN0cmVhbWluZyA9IHRydWU7CiAgICAgIHJldHVybiB0aGlzLnN0cmVhbTsKICAgIH0KICB9KTsKICAKICAKICBBV1MuSHR0cENsaWVudCA9IGluaGVyaXQoe30pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5IdHRwQ2xpZW50LmdldEluc3RhbmNlID0gZnVuY3Rpb24gZ2V0SW5zdGFuY2UoKSB7CiAgICBpZiAodGhpcy5zaW5nbGV0b24gPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzLnNpbmdsZXRvbiA9IG5ldyB0aGlzKCk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5zaW5nbGV0b247CiAgfTsKICAKICB9LHsiLi9jb3JlIjoxOH1dLDM1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIHZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CiAgcmVxdWlyZSgnLi4vaHR0cCcpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5YSFJDbGllbnQgPSBBV1MudXRpbC5pbmhlcml0KHsKICAgIGhhbmRsZVJlcXVlc3Q6IGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3QoaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLCBjYWxsYmFjaywgZXJyQ2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgZW5kcG9pbnQgPSBodHRwUmVxdWVzdC5lbmRwb2ludDsKICAgICAgdmFyIGVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7CiAgICAgIHZhciBocmVmID0gZW5kcG9pbnQucHJvdG9jb2wgKyAnLy8nICsgZW5kcG9pbnQuaG9zdG5hbWU7CiAgICAgIGlmIChlbmRwb2ludC5wb3J0ICE9PSA4MCAmJiBlbmRwb2ludC5wb3J0ICE9PSA0NDMpIHsKICAgICAgICBocmVmICs9ICc6JyArIGVuZHBvaW50LnBvcnQ7CiAgICAgIH0KICAgICAgaHJlZiArPSBodHRwUmVxdWVzdC5wYXRoOwogIAogICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCksIGhlYWRlcnNFbWl0dGVkID0gZmFsc2U7CiAgICAgIGh0dHBSZXF1ZXN0LnN0cmVhbSA9IHhocjsKICAKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDApIHJldHVybjsgLy8gMCBjb2RlIGlzIGludmFsaWQKICAgICAgICB9IGNhdGNoIChlKSB7IHJldHVybjsgfQogIAogICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPj0gdGhpcy5IRUFERVJTX1JFQ0VJVkVEICYmICFoZWFkZXJzRW1pdHRlZCkgewogICAgICAgICAgZW1pdHRlci5zdGF0dXNDb2RlID0geGhyLnN0YXR1czsKICAgICAgICAgIGVtaXR0ZXIuaGVhZGVycyA9IHNlbGYucGFyc2VIZWFkZXJzKHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSk7CiAgICAgICAgICBlbWl0dGVyLmVtaXQoCiAgICAgICAgICAgICdoZWFkZXJzJywKICAgICAgICAgICAgZW1pdHRlci5zdGF0dXNDb2RlLAogICAgICAgICAgICBlbWl0dGVyLmhlYWRlcnMsCiAgICAgICAgICAgIHhoci5zdGF0dXNUZXh0CiAgICAgICAgICApOwogICAgICAgICAgaGVhZGVyc0VtaXR0ZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkRPTkUpIHsKICAgICAgICAgIHNlbGYuZmluaXNoUmVxdWVzdCh4aHIsIGVtaXR0ZXIpOwogICAgICAgIH0KICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIudXBsb2FkLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgIGVtaXR0ZXIuZW1pdCgnc2VuZFByb2dyZXNzJywgZXZ0KTsKICAgICAgfSk7CiAgICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICBlbWl0dGVyLmVtaXQoJ3JlY2VpdmVQcm9ncmVzcycsIGV2dCk7CiAgICAgIH0sIGZhbHNlKTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ3RpbWVvdXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdUaW1lb3V0JyksIHtjb2RlOiAnVGltZW91dEVycm9yJ30pKTsKICAgICAgfSwgZmFsc2UpOwogICAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZXJyQ2FsbGJhY2soQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdOZXR3b3JrIEZhaWx1cmUnKSwgewogICAgICAgICAgY29kZTogJ05ldHdvcmtpbmdFcnJvcicKICAgICAgICB9KSk7CiAgICAgIH0sIGZhbHNlKTsKICAgICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0JywgZnVuY3Rpb24gKCkgewogICAgICAgIGVyckNhbGxiYWNrKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignUmVxdWVzdCBhYm9ydGVkJyksIHsKICAgICAgICAgIGNvZGU6ICdSZXF1ZXN0QWJvcnRlZEVycm9yJwogICAgICAgIH0pKTsKICAgICAgfSwgZmFsc2UpOwogIAogICAgICBjYWxsYmFjayhlbWl0dGVyKTsKICAgICAgeGhyLm9wZW4oaHR0cFJlcXVlc3QubWV0aG9kLCBocmVmLCBodHRwT3B0aW9ucy54aHJBc3luYyAhPT0gZmFsc2UpOwogICAgICBBV1MudXRpbC5lYWNoKGh0dHBSZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGtleSAhPT0gJ0NvbnRlbnQtTGVuZ3RoJyAmJiBrZXkgIT09ICdVc2VyLUFnZW50JyAmJiBrZXkgIT09ICdIb3N0JykgewogICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoa2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgaWYgKGh0dHBPcHRpb25zLnRpbWVvdXQgJiYgaHR0cE9wdGlvbnMueGhyQXN5bmMgIT09IGZhbHNlKSB7CiAgICAgICAgeGhyLnRpbWVvdXQgPSBodHRwT3B0aW9ucy50aW1lb3V0OwogICAgICB9CiAgCiAgICAgIGlmIChodHRwT3B0aW9ucy54aHJXaXRoQ3JlZGVudGlhbHMpIHsKICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgfQogICAgICB0cnkgeyB4aHIucmVzcG9uc2VUeXBlID0gJ2FycmF5YnVmZmVyJzsgfSBjYXRjaCAoZSkge30KICAKICAgICAgdHJ5IHsKICAgICAgICBpZiAoaHR0cFJlcXVlc3QuYm9keSkgewogICAgICAgICAgeGhyLnNlbmQoaHR0cFJlcXVlc3QuYm9keSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHhoci5zZW5kKCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBpZiAoaHR0cFJlcXVlc3QuYm9keSAmJiB0eXBlb2YgaHR0cFJlcXVlc3QuYm9keS5idWZmZXIgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICB4aHIuc2VuZChodHRwUmVxdWVzdC5ib2R5LmJ1ZmZlcik7IC8vIHNlbmQgQXJyYXlCdWZmZXIgZGlyZWN0bHkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gZW1pdHRlcjsKICAgIH0sCiAgCiAgICBwYXJzZUhlYWRlcnM6IGZ1bmN0aW9uIHBhcnNlSGVhZGVycyhyYXdIZWFkZXJzKSB7CiAgICAgIHZhciBoZWFkZXJzID0ge307CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaChyYXdIZWFkZXJzLnNwbGl0KC9ccj9cbi8pLCBmdW5jdGlvbiAobGluZSkgewogICAgICAgIHZhciBrZXkgPSBsaW5lLnNwbGl0KCc6JywgMSlbMF07CiAgICAgICAgdmFyIHZhbHVlID0gbGluZS5zdWJzdHJpbmcoa2V5Lmxlbmd0aCArIDIpOwogICAgICAgIGlmIChrZXkubGVuZ3RoID4gMCkgaGVhZGVyc1trZXkudG9Mb3dlckNhc2UoKV0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICAgIHJldHVybiBoZWFkZXJzOwogICAgfSwKICAKICAgIGZpbmlzaFJlcXVlc3Q6IGZ1bmN0aW9uIGZpbmlzaFJlcXVlc3QoeGhyLCBlbWl0dGVyKSB7CiAgICAgIHZhciBidWZmZXI7CiAgICAgIGlmICh4aHIucmVzcG9uc2VUeXBlID09PSAnYXJyYXlidWZmZXInICYmIHhoci5yZXNwb25zZSkgewogICAgICAgIHZhciBhYiA9IHhoci5yZXNwb25zZTsKICAgICAgICBidWZmZXIgPSBuZXcgQVdTLnV0aWwuQnVmZmVyKGFiLmJ5dGVMZW5ndGgpOwogICAgICAgIHZhciB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYWIpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYnVmZmVyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBidWZmZXJbaV0gPSB2aWV3W2ldOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB0cnkgewogICAgICAgIGlmICghYnVmZmVyICYmIHR5cGVvZiB4aHIucmVzcG9uc2VUZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgYnVmZmVyID0gbmV3IEFXUy51dGlsLkJ1ZmZlcih4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgCiAgICAgIGlmIChidWZmZXIpIGVtaXR0ZXIuZW1pdCgnZGF0YScsIGJ1ZmZlcik7CiAgICAgIGVtaXR0ZXIuZW1pdCgnZW5kJyk7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkh0dHBDbGllbnQucHJvdG90eXBlID0gQVdTLlhIUkNsaWVudC5wcm90b3R5cGU7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPSAxOwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vaHR0cCI6MzQsImV2ZW50cyI6ODJ9XSwzNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgCiAgZnVuY3Rpb24gSnNvbkJ1aWxkZXIoKSB7IH0KICAKICBKc29uQnVpbGRlci5wcm90b3R5cGUuYnVpbGQgPSBmdW5jdGlvbih2YWx1ZSwgc2hhcGUpIHsKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0cmFuc2xhdGUodmFsdWUsIHNoYXBlKSk7CiAgfTsKICAKICBmdW5jdGlvbiB0cmFuc2xhdGUodmFsdWUsIHNoYXBlKSB7CiAgICBpZiAoIXNoYXBlIHx8IHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHRyYW5zbGF0ZVN0cnVjdHVyZSh2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdtYXAnOiByZXR1cm4gdHJhbnNsYXRlTWFwKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gdHJhbnNsYXRlTGlzdCh2YWx1ZSwgc2hhcGUpOwogICAgICBkZWZhdWx0OiByZXR1cm4gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVN0cnVjdHVyZShzdHJ1Y3R1cmUsIHNoYXBlKSB7CiAgICB2YXIgc3RydWN0ID0ge307CiAgICB1dGlsLmVhY2goc3RydWN0dXJlLCBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW25hbWVdOwogICAgICBpZiAobWVtYmVyU2hhcGUpIHsKICAgICAgICBpZiAobWVtYmVyU2hhcGUubG9jYXRpb24gIT09ICdib2R5JykgcmV0dXJuOwogICAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHN0cnVjdFtsb2NhdGlvbk5hbWVdID0gcmVzdWx0OwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBzdHJ1Y3Q7CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZUxpc3QobGlzdCwgc2hhcGUpIHsKICAgIHZhciBvdXQgPSBbXTsKICAgIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgb3V0LnB1c2gocmVzdWx0KTsKICAgIH0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgCiAgZnVuY3Rpb24gdHJhbnNsYXRlTWFwKG1hcCwgc2hhcGUpIHsKICAgIHZhciBvdXQgPSB7fTsKICAgIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIG91dFtrZXldID0gcmVzdWx0OwogICAgfSk7CiAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKSB7CiAgICByZXR1cm4gc2hhcGUudG9XaXJlRm9ybWF0KHZhbHVlKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBKc29uQnVpbGRlcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSwzNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgCiAgZnVuY3Rpb24gSnNvblBhcnNlcigpIHsgfQogIAogIEpzb25QYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24odmFsdWUsIHNoYXBlKSB7CiAgICByZXR1cm4gdHJhbnNsYXRlKEpTT04ucGFyc2UodmFsdWUpLCBzaGFwZSk7CiAgfTsKICAKICBmdW5jdGlvbiB0cmFuc2xhdGUodmFsdWUsIHNoYXBlKSB7CiAgICBpZiAoIXNoYXBlIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHRyYW5zbGF0ZVN0cnVjdHVyZSh2YWx1ZSwgc2hhcGUpOwogICAgICBjYXNlICdtYXAnOiByZXR1cm4gdHJhbnNsYXRlTWFwKHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gdHJhbnNsYXRlTGlzdCh2YWx1ZSwgc2hhcGUpOwogICAgICBkZWZhdWx0OiByZXR1cm4gdHJhbnNsYXRlU2NhbGFyKHZhbHVlLCBzaGFwZSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHRyYW5zbGF0ZVN0cnVjdHVyZShzdHJ1Y3R1cmUsIHNoYXBlKSB7CiAgICBpZiAoc3RydWN0dXJlID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgCiAgICB2YXIgc3RydWN0ID0ge307CiAgICB2YXIgc2hhcGVNZW1iZXJzID0gc2hhcGUubWVtYmVyczsKICAgIHV0aWwuZWFjaChzaGFwZU1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlclNoYXBlKSB7CiAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN0cnVjdHVyZSwgbG9jYXRpb25OYW1lKSkgewogICAgICAgIHZhciB2YWx1ZSA9IHN0cnVjdHVyZVtsb2NhdGlvbk5hbWVdOwogICAgICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHN0cnVjdFtuYW1lXSA9IHJlc3VsdDsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gc3RydWN0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVMaXN0KGxpc3QsIHNoYXBlKSB7CiAgICBpZiAobGlzdCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgdmFyIG91dCA9IFtdOwogICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBvdXQucHVzaChudWxsKTsKICAgICAgZWxzZSBvdXQucHVzaChyZXN1bHQpOwogICAgfSk7CiAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVNYXAobWFwLCBzaGFwZSkgewogICAgaWYgKG1hcCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogIAogICAgdmFyIG91dCA9IHt9OwogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS52YWx1ZSk7CiAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgb3V0W2tleV0gPSBudWxsOwogICAgICBlbHNlIG91dFtrZXldID0gcmVzdWx0OwogICAgfSk7CiAgICByZXR1cm4gb3V0OwogIH0KICAKICBmdW5jdGlvbiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKSB7CiAgICByZXR1cm4gc2hhcGUudG9UeXBlKHZhbHVlKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBKc29uUGFyc2VyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDM4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwogIHZhciBPcGVyYXRpb24gPSByZXF1aXJlKCcuL29wZXJhdGlvbicpOwogIHZhciBTaGFwZSA9IHJlcXVpcmUoJy4vc2hhcGUnKTsKICB2YXIgUGFnaW5hdG9yID0gcmVxdWlyZSgnLi9wYWdpbmF0b3InKTsKICB2YXIgUmVzb3VyY2VXYWl0ZXIgPSByZXF1aXJlKCcuL3Jlc291cmNlX3dhaXRlcicpOwogIAogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CiAgdmFyIG1lbW9pemVkUHJvcGVydHkgPSB1dGlsLm1lbW9pemVkUHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gQXBpKGFwaSwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgYXBpID0gYXBpIHx8IHt9OwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBvcHRpb25zLmFwaSA9IHRoaXM7CiAgCiAgICBhcGkubWV0YWRhdGEgPSBhcGkubWV0YWRhdGEgfHwge307CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNBcGknLCB0cnVlLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXBpVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5hcGlWZXJzaW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICdlbmRwb2ludFByZWZpeCcsIGFwaS5tZXRhZGF0YS5lbmRwb2ludFByZWZpeCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnc2lnbmluZ05hbWUnLCBhcGkubWV0YWRhdGEuc2lnbmluZ05hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ2dsb2JhbEVuZHBvaW50JywgYXBpLm1ldGFkYXRhLmdsb2JhbEVuZHBvaW50KTsKICAgIHByb3BlcnR5KHRoaXMsICdzaWduYXR1cmVWZXJzaW9uJywgYXBpLm1ldGFkYXRhLnNpZ25hdHVyZVZlcnNpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2pzb25WZXJzaW9uJywgYXBpLm1ldGFkYXRhLmpzb25WZXJzaW9uKTsKICAgIHByb3BlcnR5KHRoaXMsICd0YXJnZXRQcmVmaXgnLCBhcGkubWV0YWRhdGEudGFyZ2V0UHJlZml4KTsKICAgIHByb3BlcnR5KHRoaXMsICdwcm90b2NvbCcsIGFwaS5tZXRhZGF0YS5wcm90b2NvbCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgYXBpLm1ldGFkYXRhLnRpbWVzdGFtcEZvcm1hdCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlVXJpJywgYXBpLm1ldGFkYXRhLnhtbE5hbWVzcGFjZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYWJicmV2aWF0aW9uJywgYXBpLm1ldGFkYXRhLnNlcnZpY2VBYmJyZXZpYXRpb24pOwogICAgcHJvcGVydHkodGhpcywgJ2Z1bGxOYW1lJywgYXBpLm1ldGFkYXRhLnNlcnZpY2VGdWxsTmFtZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnc2VydmljZUlkJywgYXBpLm1ldGFkYXRhLnNlcnZpY2VJZCk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdjbGFzc05hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5hbWUgPSBhcGkubWV0YWRhdGEuc2VydmljZUFiYnJldmlhdGlvbiB8fCBhcGkubWV0YWRhdGEuc2VydmljZUZ1bGxOYW1lOwogICAgICBpZiAoIW5hbWUpIHJldHVybiBudWxsOwogIAogICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC9eQW1hem9ufEFXU1xzKnxcKC4qfFxzK3xcVysvZywgJycpOwogICAgICBpZiAobmFtZSA9PT0gJ0VsYXN0aWNMb2FkQmFsYW5jaW5nJykgbmFtZSA9ICdFTEInOwogICAgICByZXR1cm4gbmFtZTsKICAgIH0pOwogIAogICAgZnVuY3Rpb24gYWRkRW5kcG9pbnRPcGVyYXRpb24obmFtZSwgb3BlcmF0aW9uKSB7CiAgICAgIGlmIChvcGVyYXRpb24uZW5kcG9pbnRvcGVyYXRpb24gPT09IHRydWUpIHsKICAgICAgICBwcm9wZXJ0eShzZWxmLCAnZW5kcG9pbnRPcGVyYXRpb24nLCB1dGlsLnN0cmluZy5sb3dlckZpcnN0KG5hbWUpKTsKICAgICAgfQogICAgfQogIAogICAgcHJvcGVydHkodGhpcywgJ29wZXJhdGlvbnMnLCBuZXcgQ29sbGVjdGlvbihhcGkub3BlcmF0aW9ucywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgb3BlcmF0aW9uKSB7CiAgICAgIHJldHVybiBuZXcgT3BlcmF0aW9uKG5hbWUsIG9wZXJhdGlvbiwgb3B0aW9ucyk7CiAgICB9LCB1dGlsLnN0cmluZy5sb3dlckZpcnN0LCBhZGRFbmRwb2ludE9wZXJhdGlvbikpOwogIAogICAgcHJvcGVydHkodGhpcywgJ3NoYXBlcycsIG5ldyBDb2xsZWN0aW9uKGFwaS5zaGFwZXMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHNoYXBlKSB7CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUsIG9wdGlvbnMpOwogICAgfSkpOwogIAogICAgcHJvcGVydHkodGhpcywgJ3BhZ2luYXRvcnMnLCBuZXcgQ29sbGVjdGlvbihhcGkucGFnaW5hdG9ycywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgcGFnaW5hdG9yKSB7CiAgICAgIHJldHVybiBuZXcgUGFnaW5hdG9yKG5hbWUsIHBhZ2luYXRvciwgb3B0aW9ucyk7CiAgICB9KSk7CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnd2FpdGVycycsIG5ldyBDb2xsZWN0aW9uKGFwaS53YWl0ZXJzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCB3YWl0ZXIpIHsKICAgICAgcmV0dXJuIG5ldyBSZXNvdXJjZVdhaXRlcihuYW1lLCB3YWl0ZXIsIG9wdGlvbnMpOwogICAgfSwgdXRpbC5zdHJpbmcubG93ZXJGaXJzdCkpOwogIAogICAgaWYgKG9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvbicsIGFwaS5kb2N1bWVudGF0aW9uKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb25VcmwnLCBhcGkuZG9jdW1lbnRhdGlvblVybCk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQXBpOwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9jb2xsZWN0aW9uIjozOSwiLi9vcGVyYXRpb24iOjQwLCIuL3BhZ2luYXRvciI6NDEsIi4vcmVzb3VyY2Vfd2FpdGVyIjo0MiwiLi9zaGFwZSI6NDN9XSwzOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIG1lbW9pemVkUHJvcGVydHkgPSByZXF1aXJlKCcuLi91dGlsJykubWVtb2l6ZWRQcm9wZXJ0eTsKICAKICBmdW5jdGlvbiBtZW1vaXplKG5hbWUsIHZhbHVlLCBmYWN0b3J5LCBuYW1lVHIpIHsKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgbmFtZVRyKG5hbWUpLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWUpOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIENvbGxlY3Rpb24oaXRlcmFibGUsIG9wdGlvbnMsIGZhY3RvcnksIG5hbWVUciwgY2FsbGJhY2spIHsKICAgIG5hbWVUciA9IG5hbWVUciB8fCBTdHJpbmc7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICBmb3IgKHZhciBpZCBpbiBpdGVyYWJsZSkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpZCkpIHsKICAgICAgICBtZW1vaXplLmNhbGwoc2VsZiwgaWQsIGl0ZXJhYmxlW2lkXSwgZmFjdG9yeSwgbmFtZVRyKTsKICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGlkLCBpdGVyYWJsZVtpZF0pOwogICAgICB9CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQ29sbGVjdGlvbjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSw0MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi9zaGFwZScpOwogIAogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CiAgdmFyIG1lbW9pemVkUHJvcGVydHkgPSB1dGlsLm1lbW9pemVkUHJvcGVydHk7CiAgCiAgZnVuY3Rpb24gT3BlcmF0aW9uKG5hbWUsIG9wZXJhdGlvbiwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgCiAgICBwcm9wZXJ0eSh0aGlzLCAnbmFtZScsIG9wZXJhdGlvbi5uYW1lIHx8IG5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CiAgCiAgICBvcGVyYXRpb24uaHR0cCA9IG9wZXJhdGlvbi5odHRwIHx8IHt9OwogICAgcHJvcGVydHkodGhpcywgJ2VuZHBvaW50Jywgb3BlcmF0aW9uLmVuZHBvaW50KTsKICAgIHByb3BlcnR5KHRoaXMsICdodHRwTWV0aG9kJywgb3BlcmF0aW9uLmh0dHAubWV0aG9kIHx8ICdQT1NUJyk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaHR0cFBhdGgnLCBvcGVyYXRpb24uaHR0cC5yZXF1ZXN0VXJpIHx8ICcvJyk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnYXV0aHR5cGUnLCBvcGVyYXRpb24uYXV0aHR5cGUgfHwgJycpOwogICAgcHJvcGVydHkoCiAgICAgIHRoaXMsCiAgICAgICdlbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkJywKICAgICAgb3BlcmF0aW9uLmVuZHBvaW50ZGlzY292ZXJ5ID8KICAgICAgICAob3BlcmF0aW9uLmVuZHBvaW50ZGlzY292ZXJ5LnJlcXVpcmVkID8gJ1JFUVVJUkVEJyA6ICdPUFRJT05BTCcpIDoKICAgICAgJ05VTEwnCiAgICApOwogIAogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnaW5wdXQnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKCFvcGVyYXRpb24uaW5wdXQpIHsKICAgICAgICByZXR1cm4gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cnVjdHVyZSd9LCBvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5pbnB1dCwgb3B0aW9ucyk7CiAgICB9KTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ291dHB1dCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIW9wZXJhdGlvbi5vdXRwdXQpIHsKICAgICAgICByZXR1cm4gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cnVjdHVyZSd9LCBvcHRpb25zKTsKICAgICAgfQogICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5vdXRwdXQsIG9wdGlvbnMpOwogICAgfSk7CiAgCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdlcnJvcnMnLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgaWYgKCFvcGVyYXRpb24uZXJyb3JzKSByZXR1cm4gbnVsbDsKICAKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvcGVyYXRpb24uZXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGlzdC5wdXNoKFNoYXBlLmNyZWF0ZShvcGVyYXRpb24uZXJyb3JzW2ldLCBvcHRpb25zKSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGxpc3Q7CiAgICB9KTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ3BhZ2luYXRvcicsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gb3B0aW9ucy5hcGkucGFnaW5hdG9yc1tuYW1lXTsKICAgIH0pOwogIAogICAgaWYgKG9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvbicsIG9wZXJhdGlvbi5kb2N1bWVudGF0aW9uKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb25VcmwnLCBvcGVyYXRpb24uZG9jdW1lbnRhdGlvblVybCk7CiAgICB9CiAgCiAgICAvLyBpZGVtcG90ZW50TWVtYmVycyBvbmx5IHRyYWNrcyB0b3AtbGV2ZWwgaW5wdXQgc2hhcGVzCiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdpZGVtcG90ZW50TWVtYmVycycsIGZ1bmN0aW9uKCkgewogICAgICB2YXIgaWRlbXBvdGVudE1lbWJlcnMgPSBbXTsKICAgICAgdmFyIGlucHV0ID0gc2VsZi5pbnB1dDsKICAgICAgdmFyIG1lbWJlcnMgPSBpbnB1dC5tZW1iZXJzOwogICAgICBpZiAoIWlucHV0Lm1lbWJlcnMpIHsKICAgICAgICByZXR1cm4gaWRlbXBvdGVudE1lbWJlcnM7CiAgICAgIH0KICAgICAgZm9yICh2YXIgbmFtZSBpbiBtZW1iZXJzKSB7CiAgICAgICAgaWYgKCFtZW1iZXJzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKG1lbWJlcnNbbmFtZV0uaXNJZGVtcG90ZW50ID09PSB0cnVlKSB7CiAgICAgICAgICBpZGVtcG90ZW50TWVtYmVycy5wdXNoKG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaWRlbXBvdGVudE1lbWJlcnM7CiAgICB9KTsKICAKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2hhc0V2ZW50T3V0cHV0JywgZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvdXRwdXQgPSBzZWxmLm91dHB1dDsKICAgICAgcmV0dXJuIGhhc0V2ZW50U3RyZWFtKG91dHB1dCk7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gaGFzRXZlbnRTdHJlYW0odG9wTGV2ZWxTaGFwZSkgewogICAgdmFyIG1lbWJlcnMgPSB0b3BMZXZlbFNoYXBlLm1lbWJlcnM7CiAgICB2YXIgcGF5bG9hZCA9IHRvcExldmVsU2hhcGUucGF5bG9hZDsKICAKICAgIGlmICghdG9wTGV2ZWxTaGFwZS5tZW1iZXJzKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAKICAgIGlmIChwYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gbWVtYmVyc1twYXlsb2FkXTsKICAgICAgcmV0dXJuIHBheWxvYWRNZW1iZXIuaXNFdmVudFN0cmVhbTsKICAgIH0KICAKICAgIC8vIGNoZWNrIGlmIGFueSBtZW1iZXIgaXMgYW4gZXZlbnQgc3RyZWFtCiAgICBmb3IgKHZhciBuYW1lIGluIG1lbWJlcnMpIHsKICAgICAgaWYgKCFtZW1iZXJzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgaWYgKG1lbWJlcnNbbmFtZV0uaXNFdmVudFN0cmVhbSA9PT0gdHJ1ZSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gT3BlcmF0aW9uOwogIAogIH0seyIuLi91dGlsIjo3MSwiLi9zaGFwZSI6NDN9XSw0MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHByb3BlcnR5ID0gcmVxdWlyZSgnLi4vdXRpbCcpLnByb3BlcnR5OwogIAogIGZ1bmN0aW9uIFBhZ2luYXRvcihuYW1lLCBwYWdpbmF0b3IpIHsKICAgIHByb3BlcnR5KHRoaXMsICdpbnB1dFRva2VuJywgcGFnaW5hdG9yLmlucHV0X3Rva2VuKTsKICAgIHByb3BlcnR5KHRoaXMsICdsaW1pdEtleScsIHBhZ2luYXRvci5saW1pdF9rZXkpOwogICAgcHJvcGVydHkodGhpcywgJ21vcmVSZXN1bHRzJywgcGFnaW5hdG9yLm1vcmVfcmVzdWx0cyk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnb3V0cHV0VG9rZW4nLCBwYWdpbmF0b3Iub3V0cHV0X3Rva2VuKTsKICAgIHByb3BlcnR5KHRoaXMsICdyZXN1bHRLZXknLCBwYWdpbmF0b3IucmVzdWx0X2tleSk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gUGFnaW5hdG9yOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDQyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgcHJvcGVydHkgPSB1dGlsLnByb3BlcnR5OwogIAogIGZ1bmN0aW9uIFJlc291cmNlV2FpdGVyKG5hbWUsIHdhaXRlciwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBwcm9wZXJ0eSh0aGlzLCAnbmFtZScsIG5hbWUpOwogICAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CiAgCiAgICBpZiAod2FpdGVyLm9wZXJhdGlvbikgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnb3BlcmF0aW9uJywgdXRpbC5zdHJpbmcubG93ZXJGaXJzdCh3YWl0ZXIub3BlcmF0aW9uKSk7CiAgICB9CiAgCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIga2V5cyA9IFsKICAgICAgJ3R5cGUnLAogICAgICAnZGVzY3JpcHRpb24nLAogICAgICAnZGVsYXknLAogICAgICAnbWF4QXR0ZW1wdHMnLAogICAgICAnYWNjZXB0b3JzJwogICAgXTsKICAKICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gd2FpdGVyW2tleV07CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIHByb3BlcnR5KHNlbGYsIGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9KTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBSZXNvdXJjZVdhaXRlcjsKICAKICB9LHsiLi4vdXRpbCI6NzF9XSw0MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIENvbGxlY3Rpb24gPSByZXF1aXJlKCcuL2NvbGxlY3Rpb24nKTsKICAKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICAKICBmdW5jdGlvbiBwcm9wZXJ0eShvYmosIG5hbWUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICB1dGlsLnByb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIG1lbW9pemVkUHJvcGVydHkob2JqLCBuYW1lKSB7CiAgICBpZiAoIW9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGVbbmFtZV0pIHsKICAgICAgdXRpbC5tZW1vaXplZFByb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIFNoYXBlKHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAKICAgIHByb3BlcnR5KHRoaXMsICdzaGFwZScsIHNoYXBlLnNoYXBlKTsKICAgIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ3R5cGUnLCBzaGFwZS50eXBlKTsKICAgIHByb3BlcnR5KHRoaXMsICdlbnVtJywgc2hhcGUuZW51bSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbWluJywgc2hhcGUubWluKTsKICAgIHByb3BlcnR5KHRoaXMsICdtYXgnLCBzaGFwZS5tYXgpOwogICAgcHJvcGVydHkodGhpcywgJ3BhdHRlcm4nLCBzaGFwZS5wYXR0ZXJuKTsKICAgIHByb3BlcnR5KHRoaXMsICdsb2NhdGlvbicsIHNoYXBlLmxvY2F0aW9uIHx8IHRoaXMubG9jYXRpb24gfHwgJ2JvZHknKTsKICAgIHByb3BlcnR5KHRoaXMsICduYW1lJywgdGhpcy5uYW1lIHx8IHNoYXBlLnhtbE5hbWUgfHwgc2hhcGUucXVlcnlOYW1lIHx8CiAgICAgIHNoYXBlLmxvY2F0aW9uTmFtZSB8fCBtZW1iZXJOYW1lKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1N0cmVhbWluZycsIHNoYXBlLnN0cmVhbWluZyB8fCB0aGlzLmlzU3RyZWFtaW5nIHx8IGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlc0xlbmd0aCcsIHNoYXBlLnJlcXVpcmVzTGVuZ3RoLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNDb21wb3NpdGUnLCBzaGFwZS5pc0NvbXBvc2l0ZSB8fCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNTaGFwZScsIHRydWUsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc1F1ZXJ5TmFtZScsIEJvb2xlYW4oc2hhcGUucXVlcnlOYW1lKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzTG9jYXRpb25OYW1lJywgQm9vbGVhbihzaGFwZS5sb2NhdGlvbk5hbWUpLCBmYWxzZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNJZGVtcG90ZW50Jywgc2hhcGUuaWRlbXBvdGVuY3lUb2tlbiA9PT0gdHJ1ZSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNKc29uVmFsdWUnLCBzaGFwZS5qc29udmFsdWUgPT09IHRydWUpOwogICAgcHJvcGVydHkodGhpcywgJ2lzU2Vuc2l0aXZlJywgc2hhcGUuc2Vuc2l0aXZlID09PSB0cnVlIHx8IHNoYXBlLnByb3RvdHlwZSAmJiBzaGFwZS5wcm90b3R5cGUuc2Vuc2l0aXZlID09PSB0cnVlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50U3RyZWFtJywgQm9vbGVhbihzaGFwZS5ldmVudHN0cmVhbSksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50JywgQm9vbGVhbihzaGFwZS5ldmVudCksIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50UGF5bG9hZCcsIEJvb2xlYW4oc2hhcGUuZXZlbnRwYXlsb2FkKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRIZWFkZXInLCBCb29sZWFuKHNoYXBlLmV2ZW50aGVhZGVyKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2lzVGltZXN0YW1wRm9ybWF0U2V0JywgQm9vbGVhbihzaGFwZS50aW1lc3RhbXBGb3JtYXQpIHx8IHNoYXBlLnByb3RvdHlwZSAmJiBzaGFwZS5wcm90b3R5cGUuaXNUaW1lc3RhbXBGb3JtYXRTZXQgPT09IHRydWUsIGZhbHNlKTsKICAgIHByb3BlcnR5KHRoaXMsICdlbmRwb2ludERpc2NvdmVyeUlkJywgQm9vbGVhbihzaGFwZS5lbmRwb2ludGRpc2NvdmVyeWlkKSwgZmFsc2UpOwogICAgcHJvcGVydHkodGhpcywgJ2hvc3RMYWJlbCcsIEJvb2xlYW4oc2hhcGUuaG9zdExhYmVsKSwgZmFsc2UpOwogIAogICAgaWYgKG9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvbicsIHNoYXBlLmRvY3VtZW50YXRpb24pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIHNoYXBlLmRvY3VtZW50YXRpb25VcmwpOwogICAgfQogIAogICAgaWYgKHNoYXBlLnhtbEF0dHJpYnV0ZSkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnaXNYbWxBdHRyaWJ1dGUnLCBzaGFwZS54bWxBdHRyaWJ1dGUgfHwgZmFsc2UpOwogICAgfQogIAogICAgLy8gdHlwZSBjb252ZXJzaW9uIGFuZCBwYXJzaW5nCiAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgbnVsbCk7CiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJyc7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH07CiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7IHJldHVybiB2YWx1ZTsgfTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgU2hhcGUubm9ybWFsaXplZFR5cGVzID0gewogICAgY2hhcmFjdGVyOiAnc3RyaW5nJywKICAgIGRvdWJsZTogJ2Zsb2F0JywKICAgIGxvbmc6ICdpbnRlZ2VyJywKICAgIHNob3J0OiAnaW50ZWdlcicsCiAgICBiaWdpbnRlZ2VyOiAnaW50ZWdlcicsCiAgICBiaWdkZWNpbWFsOiAnZmxvYXQnLAogICAgYmxvYjogJ2JpbmFyeScKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIFNoYXBlLnR5cGVzID0gewogICAgJ3N0cnVjdHVyZSc6IFN0cnVjdHVyZVNoYXBlLAogICAgJ2xpc3QnOiBMaXN0U2hhcGUsCiAgICAnbWFwJzogTWFwU2hhcGUsCiAgICAnYm9vbGVhbic6IEJvb2xlYW5TaGFwZSwKICAgICd0aW1lc3RhbXAnOiBUaW1lc3RhbXBTaGFwZSwKICAgICdmbG9hdCc6IEZsb2F0U2hhcGUsCiAgICAnaW50ZWdlcic6IEludGVnZXJTaGFwZSwKICAgICdzdHJpbmcnOiBTdHJpbmdTaGFwZSwKICAgICdiYXNlNjQnOiBCYXNlNjRTaGFwZSwKICAgICdiaW5hcnknOiBCaW5hcnlTaGFwZQogIH07CiAgCiAgU2hhcGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIGlmIChzaGFwZS5zaGFwZSkgewogICAgICB2YXIgcmVmU2hhcGUgPSBvcHRpb25zLmFwaS5zaGFwZXNbc2hhcGUuc2hhcGVdOwogICAgICBpZiAoIXJlZlNoYXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZmluZCBzaGFwZSByZWZlcmVuY2U6ICcgKyBzaGFwZS5zaGFwZSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJlZlNoYXBlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfTsKICAKICBTaGFwZS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUoc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpIHsKICAgIGlmIChzaGFwZS5pc1NoYXBlKSByZXR1cm4gc2hhcGU7CiAgCiAgICB2YXIgcmVmU2hhcGUgPSBTaGFwZS5yZXNvbHZlKHNoYXBlLCBvcHRpb25zKTsKICAgIGlmIChyZWZTaGFwZSkgewogICAgICB2YXIgZmlsdGVyZWRLZXlzID0gT2JqZWN0LmtleXMoc2hhcGUpOwogICAgICBpZiAoIW9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgICAgIGZpbHRlcmVkS2V5cyA9IGZpbHRlcmVkS2V5cy5maWx0ZXIoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuICFuYW1lLm1hdGNoKC9kb2N1bWVudGF0aW9uLyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgLy8gY3JlYXRlIGFuIGlubGluZSBzaGFwZSB3aXRoIGV4dHJhIG1lbWJlcnMKICAgICAgdmFyIElubGluZVNoYXBlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmVmU2hhcGUuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSk7CiAgICAgIH07CiAgICAgIElubGluZVNoYXBlLnByb3RvdHlwZSA9IHJlZlNoYXBlOwogICAgICByZXR1cm4gbmV3IElubGluZVNoYXBlKCk7CiAgICB9IGVsc2UgewogICAgICAvLyBzZXQgdHlwZSBpZiBub3Qgc2V0CiAgICAgIGlmICghc2hhcGUudHlwZSkgewogICAgICAgIGlmIChzaGFwZS5tZW1iZXJzKSBzaGFwZS50eXBlID0gJ3N0cnVjdHVyZSc7CiAgICAgICAgZWxzZSBpZiAoc2hhcGUubWVtYmVyKSBzaGFwZS50eXBlID0gJ2xpc3QnOwogICAgICAgIGVsc2UgaWYgKHNoYXBlLmtleSkgc2hhcGUudHlwZSA9ICdtYXAnOwogICAgICAgIGVsc2Ugc2hhcGUudHlwZSA9ICdzdHJpbmcnOwogICAgICB9CiAgCiAgICAgIC8vIG5vcm1hbGl6ZSB0eXBlcwogICAgICB2YXIgb3JpZ1R5cGUgPSBzaGFwZS50eXBlOwogICAgICBpZiAoU2hhcGUubm9ybWFsaXplZFR5cGVzW3NoYXBlLnR5cGVdKSB7CiAgICAgICAgc2hhcGUudHlwZSA9IFNoYXBlLm5vcm1hbGl6ZWRUeXBlc1tzaGFwZS50eXBlXTsKICAgICAgfQogIAogICAgICBpZiAoU2hhcGUudHlwZXNbc2hhcGUudHlwZV0pIHsKICAgICAgICByZXR1cm4gbmV3IFNoYXBlLnR5cGVzW3NoYXBlLnR5cGVdKHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VucmVjb2duaXplZCBzaGFwZSB0eXBlOiAnICsgb3JpZ1R5cGUpOwogICAgICB9CiAgICB9CiAgfTsKICAKICBmdW5jdGlvbiBDb21wb3NpdGVTaGFwZShzaGFwZSkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHByb3BlcnR5KHRoaXMsICdpc0NvbXBvc2l0ZScsIHRydWUpOwogIAogICAgaWYgKHNoYXBlLmZsYXR0ZW5lZCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZmxhdHRlbmVkJywgc2hhcGUuZmxhdHRlbmVkIHx8IGZhbHNlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gU3RydWN0dXJlU2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciByZXF1aXJlZE1hcCA9IG51bGwsIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgCiAgICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKGZpcnN0SW5pdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiB7fTsgfSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJzJywge30pOwogICAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVyTmFtZXMnLCBbXSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlZCcsIFtdKTsKICAgICAgcHJvcGVydHkodGhpcywgJ2lzUmVxdWlyZWQnLCBmdW5jdGlvbigpIHsgcmV0dXJuIGZhbHNlOyB9KTsKICAgIH0KICAKICAgIGlmIChzaGFwZS5tZW1iZXJzKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdtZW1iZXJzJywgbmV3IENvbGxlY3Rpb24oc2hhcGUubWVtYmVycywgb3B0aW9ucywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShtZW1iZXIsIG9wdGlvbnMsIG5hbWUpOwogICAgICB9KSk7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ21lbWJlck5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNoYXBlLnhtbE9yZGVyIHx8IE9iamVjdC5rZXlzKHNoYXBlLm1lbWJlcnMpOwogICAgICB9KTsKICAKICAgICAgaWYgKHNoYXBlLmV2ZW50KSB7CiAgICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnZXZlbnRQYXlsb2FkTWVtYmVyTmFtZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG1lbWJlcnMgPSBzZWxmLm1lbWJlcnM7CiAgICAgICAgICB2YXIgbWVtYmVyTmFtZXMgPSBzZWxmLm1lbWJlck5hbWVzOwogICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIG1lbWJlcnMgdG8gZmluZCBvbmVzIHRoYXQgYXJlIGV2ZW50IHBheWxvYWRzCiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IG1lbWJlck5hbWVzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICAgICAgICBpZiAobWVtYmVyc1ttZW1iZXJOYW1lc1tpXV0uaXNFdmVudFBheWxvYWQpIHsKICAgICAgICAgICAgICByZXR1cm4gbWVtYmVyTmFtZXNbaV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAKICAgICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdldmVudEhlYWRlck1lbWJlck5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbWVtYmVycyA9IHNlbGYubWVtYmVyczsKICAgICAgICAgIHZhciBtZW1iZXJOYW1lcyA9IHNlbGYubWVtYmVyTmFtZXM7CiAgICAgICAgICB2YXIgZXZlbnRIZWFkZXJNZW1iZXJOYW1lcyA9IFtdOwogICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIG1lbWJlcnMgdG8gZmluZCBvbmVzIHRoYXQgYXJlIGV2ZW50IGhlYWRlcnMKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbWVtYmVyTmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtZW1iZXJzW21lbWJlck5hbWVzW2ldXS5pc0V2ZW50SGVhZGVyKSB7CiAgICAgICAgICAgICAgZXZlbnRIZWFkZXJNZW1iZXJOYW1lcy5wdXNoKG1lbWJlck5hbWVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXM7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAKICAgIGlmIChzaGFwZS5yZXF1aXJlZCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZWQnLCBzaGFwZS5yZXF1aXJlZCk7CiAgICAgIHByb3BlcnR5KHRoaXMsICdpc1JlcXVpcmVkJywgZnVuY3Rpb24obmFtZSkgewogICAgICAgIGlmICghcmVxdWlyZWRNYXApIHsKICAgICAgICAgIHJlcXVpcmVkTWFwID0ge307CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNoYXBlLnJlcXVpcmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHJlcXVpcmVkTWFwW3NoYXBlLnJlcXVpcmVkW2ldXSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiByZXF1aXJlZE1hcFtuYW1lXTsKICAgICAgfSwgZmFsc2UsIHRydWUpOwogICAgfQogIAogICAgcHJvcGVydHkodGhpcywgJ3Jlc3VsdFdyYXBwZXInLCBzaGFwZS5yZXN1bHRXcmFwcGVyIHx8IG51bGwpOwogIAogICAgaWYgKHNoYXBlLnBheWxvYWQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3BheWxvYWQnLCBzaGFwZS5wYXlsb2FkKTsKICAgIH0KICAKICAgIGlmICh0eXBlb2Ygc2hhcGUueG1sTmFtZXNwYWNlID09PSAnc3RyaW5nJykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlVXJpJywgc2hhcGUueG1sTmFtZXNwYWNlKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHNoYXBlLnhtbE5hbWVzcGFjZSA9PT0gJ29iamVjdCcpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ3htbE5hbWVzcGFjZVByZWZpeCcsIHNoYXBlLnhtbE5hbWVzcGFjZS5wcmVmaXgpOwogICAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlVXJpJywgc2hhcGUueG1sTmFtZXNwYWNlLnVyaSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIExpc3RTaGFwZShzaGFwZSwgb3B0aW9ucykgewogICAgdmFyIHNlbGYgPSB0aGlzLCBmaXJzdEluaXQgPSAhdGhpcy5pc1NoYXBlOwogICAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIGlmIChmaXJzdEluaXQpIHsKICAgICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4gW107IH0pOwogICAgfQogIAogICAgaWYgKHNoYXBlLm1lbWJlcikgewogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdtZW1iZXInLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLm1lbWJlciwgb3B0aW9ucyk7CiAgICAgIH0pOwogICAgfQogIAogICAgaWYgKHRoaXMuZmxhdHRlbmVkKSB7CiAgICAgIHZhciBvbGROYW1lID0gdGhpcy5uYW1lOwogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICduYW1lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNlbGYubWVtYmVyLm5hbWUgfHwgb2xkTmFtZTsKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIE1hcFNoYXBlKHNoYXBlLCBvcHRpb25zKSB7CiAgICB2YXIgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICAgIENvbXBvc2l0ZVNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICBpZiAoZmlyc3RJbml0KSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBmdW5jdGlvbigpIHsgcmV0dXJuIHt9OyB9KTsKICAgICAgcHJvcGVydHkodGhpcywgJ2tleScsIFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cmluZyd9LCBvcHRpb25zKSk7CiAgICAgIHByb3BlcnR5KHRoaXMsICd2YWx1ZScsIFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cmluZyd9LCBvcHRpb25zKSk7CiAgICB9CiAgCiAgICBpZiAoc2hhcGUua2V5KSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2tleScsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUua2V5LCBvcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgICBpZiAoc2hhcGUudmFsdWUpIHsKICAgICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAndmFsdWUnLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLnZhbHVlLCBvcHRpb25zKTsKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIFRpbWVzdGFtcFNoYXBlKHNoYXBlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgaWYgKHNoYXBlLnRpbWVzdGFtcEZvcm1hdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0Jywgc2hhcGUudGltZXN0YW1wRm9ybWF0KTsKICAgIH0gZWxzZSBpZiAoc2VsZi5pc1RpbWVzdGFtcEZvcm1hdFNldCAmJiB0aGlzLnRpbWVzdGFtcEZvcm1hdCkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgdGhpcy50aW1lc3RhbXBGb3JtYXQpOwogICAgfSBlbHNlIGlmICh0aGlzLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ3JmYzgyMicpOwogICAgfSBlbHNlIGlmICh0aGlzLmxvY2F0aW9uID09PSAncXVlcnlzdHJpbmcnKSB7CiAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAnaXNvODYwMScpOwogICAgfSBlbHNlIGlmICh0aGlzLmFwaSkgewogICAgICBzd2l0Y2ggKHRoaXMuYXBpLnByb3RvY29sKSB7CiAgICAgICAgY2FzZSAnanNvbic6CiAgICAgICAgY2FzZSAncmVzdC1qc29uJzoKICAgICAgICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCAndW5peFRpbWVzdGFtcCcpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncmVzdC14bWwnOgogICAgICAgIGNhc2UgJ3F1ZXJ5JzoKICAgICAgICBjYXNlICdlYzInOgogICAgICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdpc284NjAxJyk7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUudG9VVENTdHJpbmcgPT09ICdmdW5jdGlvbicpIHJldHVybiB2YWx1ZTsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/CiAgICAgICAgICAgICB1dGlsLmRhdGUucGFyc2VUaW1lc3RhbXAodmFsdWUpIDogbnVsbDsKICAgIH07CiAgCiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB1dGlsLmRhdGUuZm9ybWF0KHZhbHVlLCBzZWxmLnRpbWVzdGFtcEZvcm1hdCk7CiAgICB9OwogIH0KICAKICBmdW5jdGlvbiBTdHJpbmdTaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICB2YXIgbnVsbExlc3NQcm90b2NvbHMgPSBbJ3Jlc3QteG1sJywgJ3F1ZXJ5JywgJ2VjMiddOwogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YWx1ZSA9IHRoaXMuYXBpICYmIG51bGxMZXNzUHJvdG9jb2xzLmluZGV4T2YodGhpcy5hcGkucHJvdG9jb2wpID4gLTEgPwogICAgICAgIHZhbHVlIHx8ICcnIDogdmFsdWU7CiAgICAgIGlmICh0aGlzLmlzSnNvblZhbHVlKSB7CiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogICAgICB9CiAgCiAgICAgIHJldHVybiB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUudG9TdHJpbmcgPT09ICdmdW5jdGlvbicgPwogICAgICAgIHZhbHVlLnRvU3RyaW5nKCkgOiB2YWx1ZTsKICAgIH07CiAgCiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzLmlzSnNvblZhbHVlID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CiAgICB9OwogIH0KICAKICBmdW5jdGlvbiBGbG9hdFNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgICB9OwogICAgdGhpcy50b1dpcmVGb3JtYXQgPSB0aGlzLnRvVHlwZTsKICB9CiAgCiAgZnVuY3Rpb24gSW50ZWdlclNoYXBlKCkgewogICAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAKICAgIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKTsKICAgIH07CiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IHRoaXMudG9UeXBlOwogIH0KICAKICBmdW5jdGlvbiBCaW5hcnlTaGFwZSgpIHsKICAgIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHZhciBidWYgPSB1dGlsLmJhc2U2NC5kZWNvZGUodmFsdWUpOwogICAgICBpZiAodGhpcy5pc1NlbnNpdGl2ZSAmJiB1dGlsLmlzTm9kZSgpICYmIHR5cGVvZiB1dGlsLkJ1ZmZlci5hbGxvYyA9PT0gJ2Z1bmN0aW9uJykgewogICAgLyogTm9kZS5qcyBjYW4gY3JlYXRlIGEgQnVmZmVyIHRoYXQgaXMgbm90IGlzb2xhdGVkLgogICAgICogaS5lLiBidWYuYnl0ZUxlbmd0aCAhPT0gYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoCiAgICAgKiBUaGlzIG1lYW5zIHRoYXQgdGhlIHNlbnNpdGl2ZSBkYXRhIGlzIGFjY2Vzc2libGUgdG8gYW55b25lIHdpdGggYWNjZXNzIHRvIGJ1Zi5idWZmZXIuCiAgICAgKiBJZiB0aGlzIGlzIHRoZSBub2RlIHNoYXJlZCBCdWZmZXIsIHRoZW4gb3RoZXIgY29kZSB3aXRoaW4gdGhpcyBwcm9jZXNzIF9jb3VsZF8gZmluZCB0aGlzIHNlY3JldC4KICAgICAqIENvcHkgc2Vuc2l0aXZlIGRhdGEgdG8gYW4gaXNvbGF0ZWQgQnVmZmVyIGFuZCB6ZXJvIHRoZSBzZW5zaXRpdmUgZGF0YS4KICAgICAqIFdoaWxlIHRoaXMgaXMgc2FmZSB0byBkbyBoZXJlLCBjb3B5aW5nIHRoaXMgY29kZSBzb21ld2hlcmUgZWxzZSBtYXkgcHJvZHVjZSB1bmV4cGVjdGVkIHJlc3VsdHMuCiAgICAgKi8KICAgICAgICB2YXIgc2VjdXJlQnVmID0gdXRpbC5CdWZmZXIuYWxsb2MoYnVmLmxlbmd0aCwgYnVmKTsKICAgICAgICBidWYuZmlsbCgwKTsKICAgICAgICBidWYgPSBzZWN1cmVCdWY7CiAgICAgIH0KICAgICAgcmV0dXJuIGJ1ZjsKICAgIH07CiAgICB0aGlzLnRvV2lyZUZvcm1hdCA9IHV0aWwuYmFzZTY0LmVuY29kZTsKICB9CiAgCiAgZnVuY3Rpb24gQmFzZTY0U2hhcGUoKSB7CiAgICBCaW5hcnlTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KICAKICBmdW5jdGlvbiBCb29sZWFuU2hhcGUoKSB7CiAgICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHJldHVybiB2YWx1ZTsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdmFsdWUgPT09ICd0cnVlJzsKICAgIH07CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIFNoYXBlLnNoYXBlcyA9IHsKICAgIFN0cnVjdHVyZVNoYXBlOiBTdHJ1Y3R1cmVTaGFwZSwKICAgIExpc3RTaGFwZTogTGlzdFNoYXBlLAogICAgTWFwU2hhcGU6IE1hcFNoYXBlLAogICAgU3RyaW5nU2hhcGU6IFN0cmluZ1NoYXBlLAogICAgQm9vbGVhblNoYXBlOiBCb29sZWFuU2hhcGUsCiAgICBCYXNlNjRTaGFwZTogQmFzZTY0U2hhcGUKICB9OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gU2hhcGU7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL2NvbGxlY3Rpb24iOjM5fV0sNDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUGFyYW1WYWxpZGF0b3IgPSBBV1MudXRpbC5pbmhlcml0KHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IHZhbGlkYXRvciBvYmplY3QuCiAgICAgKgogICAgICogQHBhcmFtIHZhbGlkYXRpb24gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMgc2hvdWxkIGJlCiAgICAgKiAgICAgdmFsaWRhdGVkIGFnYWluc3QgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZyB0aGUKICAgICAqICAgICByZXF1ZXN0LiBQYXNzIGEgbWFwIHRvIGVuYWJsZSBhbnkgb2YgdGhlIGZvbGxvd2luZyBzcGVjaWZpYwogICAgICogICAgIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAgICAgKgogICAgICogICAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgICAqICAgICAgIGNvbnN0cmFpbnQuIFRoaXMgaXMgZW5hYmxlZCBieSBkZWZhdWx0IHdoZW4gcGFyYW1WYWxpZGF0aW9uIGlzIHNldAogICAgICogICAgICAgdG8gYHRydWVgLgogICAgICogICAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgICAqICAgICAgIGNvbnN0cmFpbnQuCiAgICAgKiAgICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgICAqICAgICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgICAqICAgICAqICoqZW51bSoqIFtCb29sZWFuXSAmbWRhc2g7IFZhbGlkYXRlcyB0aGF0IGEgc3RyaW5nIHZhbHVlIG1hdGNoZXMgb25lCiAgICAgKiAgICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUGFyYW1WYWxpZGF0b3IodmFsaWRhdGlvbikgewogICAgICBpZiAodmFsaWRhdGlvbiA9PT0gdHJ1ZSB8fCB2YWxpZGF0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICB2YWxpZGF0aW9uID0geydtaW4nOiB0cnVlfTsKICAgICAgfQogICAgICB0aGlzLnZhbGlkYXRpb24gPSB2YWxpZGF0aW9uOwogICAgfSwKICAKICAgIHZhbGlkYXRlOiBmdW5jdGlvbiB2YWxpZGF0ZShzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIHRoaXMuZXJyb3JzID0gW107CiAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUsIHBhcmFtcyB8fCB7fSwgY29udGV4dCB8fCAncGFyYW1zJyk7CiAgCiAgICAgIGlmICh0aGlzLmVycm9ycy5sZW5ndGggPiAxKSB7CiAgICAgICAgdmFyIG1zZyA9IHRoaXMuZXJyb3JzLmpvaW4oJ1xuKiAnKTsKICAgICAgICBtc2cgPSAnVGhlcmUgd2VyZSAnICsgdGhpcy5lcnJvcnMubGVuZ3RoICsKICAgICAgICAgICcgdmFsaWRhdGlvbiBlcnJvcnM6XG4qICcgKyBtc2c7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKG1zZyksCiAgICAgICAgICB7Y29kZTogJ011bHRpcGxlVmFsaWRhdGlvbkVycm9ycycsIGVycm9yczogdGhpcy5lcnJvcnN9KTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmVycm9ycy5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aHJvdyB0aGlzLmVycm9yc1swXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSwKICAKICAgIGZhaWw6IGZ1bmN0aW9uIGZhaWwoY29kZSwgbWVzc2FnZSkgewogICAgICB0aGlzLmVycm9ycy5wdXNoKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtZXNzYWdlKSwge2NvZGU6IGNvZGV9KSk7CiAgICB9LAogIAogICAgdmFsaWRhdGVTdHJ1Y3R1cmU6IGZ1bmN0aW9uIHZhbGlkYXRlU3RydWN0dXJlKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgICAgdGhpcy52YWxpZGF0ZVR5cGUocGFyYW1zLCBjb250ZXh0LCBbJ29iamVjdCddLCAnc3RydWN0dXJlJyk7CiAgCiAgICAgIHZhciBwYXJhbU5hbWU7CiAgICAgIGZvciAodmFyIGkgPSAwOyBzaGFwZS5yZXF1aXJlZCAmJiBpIDwgc2hhcGUucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICBwYXJhbU5hbWUgPSBzaGFwZS5yZXF1aXJlZFtpXTsKICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbcGFyYW1OYW1lXTsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgdGhpcy5mYWlsKCdNaXNzaW5nUmVxdWlyZWRQYXJhbWV0ZXInLAogICAgICAgICAgICAnTWlzc2luZyByZXF1aXJlZCBrZXkgXCcnICsgcGFyYW1OYW1lICsgJ1wnIGluICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgLy8gdmFsaWRhdGUgaGFzaCBtZW1iZXJzCiAgICAgIGZvciAocGFyYW1OYW1lIGluIHBhcmFtcykgewogICAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtcywgcGFyYW1OYW1lKSkgY29udGludWU7CiAgCiAgICAgICAgdmFyIHBhcmFtVmFsdWUgPSBwYXJhbXNbcGFyYW1OYW1lXSwKICAgICAgICAgICAgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW3BhcmFtTmFtZV07CiAgCiAgICAgICAgaWYgKG1lbWJlclNoYXBlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHZhciBtZW1iZXJDb250ZXh0ID0gW2NvbnRleHQsIHBhcmFtTmFtZV0uam9pbignLicpOwogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihtZW1iZXJTaGFwZSwgcGFyYW1WYWx1ZSwgbWVtYmVyQ29udGV4dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuZmFpbCgnVW5leHBlY3RlZFBhcmFtZXRlcicsCiAgICAgICAgICAgICdVbmV4cGVjdGVkIGtleSBcJycgKyBwYXJhbU5hbWUgKyAnXCcgZm91bmQgaW4gJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZU1lbWJlcjogZnVuY3Rpb24gdmFsaWRhdGVNZW1iZXIoc2hhcGUsIHBhcmFtLCBjb250ZXh0KSB7CiAgICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVN0cnVjdHVyZShzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2xpc3QnOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVMaXN0KHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnbWFwJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlTWFwKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU2NhbGFyKHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZUxpc3Q6IGZ1bmN0aW9uIHZhbGlkYXRlTGlzdChzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFtBcnJheV0pKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCBwYXJhbXMubGVuZ3RoLCBjb250ZXh0LCAnbGlzdCBtZW1iZXIgY291bnQnKTsKICAgICAgICAvLyB2YWxpZGF0ZSBhcnJheSBtZW1iZXJzCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUubWVtYmVyLCBwYXJhbXNbaV0sIGNvbnRleHQgKyAnWycgKyBpICsgJ10nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZU1hcDogZnVuY3Rpb24gdmFsaWRhdGVNYXAoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgICBpZiAodGhpcy52YWxpZGF0ZVR5cGUocGFyYW1zLCBjb250ZXh0LCBbJ29iamVjdCddLCAnbWFwJykpIHsKICAgICAgICAvLyBCdWlsZCB1cCBhIGNvdW50IG9mIG1hcCBtZW1iZXJzIHRvIHZhbGlkYXRlIHJhbmdlIHRyYWl0cy4KICAgICAgICB2YXIgbWFwQ291bnQgPSAwOwogICAgICAgIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykgewogICAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocGFyYW1zLCBwYXJhbSkpIGNvbnRpbnVlOwogICAgICAgICAgLy8gVmFsaWRhdGUgYW55IG1hcCBrZXkgdHJhaXQgY29uc3RyYWludHMKICAgICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIoc2hhcGUua2V5LCBwYXJhbSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCArICdba2V5PVwnJyArIHBhcmFtICsgJ1wnXScpOwogICAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS52YWx1ZSwgcGFyYW1zW3BhcmFtXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCArICdbXCcnICsgcGFyYW0gKyAnXCddJyk7CiAgICAgICAgICBtYXBDb3VudCsrOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIG1hcENvdW50LCBjb250ZXh0LCAnbWFwIG1lbWJlciBjb3VudCcpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVTY2FsYXI6IGZ1bmN0aW9uIHZhbGlkYXRlU2NhbGFyKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgICBjYXNlIG51bGw6CiAgICAgICAgY2FzZSB1bmRlZmluZWQ6CiAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlU3RyaW5nKHNoYXBlLCB2YWx1ZSwgY29udGV4dCk7CiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICBjYXNlICdiaW5hcnknOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVQYXlsb2FkKHZhbHVlLCBjb250ZXh0KTsKICAgICAgICBjYXNlICdpbnRlZ2VyJzoKICAgICAgICBjYXNlICdmbG9hdCc6CiAgICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZU51bWJlcihzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbJ2Jvb2xlYW4nXSk7CiAgICAgICAgY2FzZSAndGltZXN0YW1wJzoKICAgICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgW0RhdGUsCiAgICAgICAgICAgIC9eXGR7NH0tXGR7Mn0tXGR7Mn1UXGR7Mn06XGR7Mn06XGR7Mn0oXC5cZCspP1okLywgJ251bWJlciddLAogICAgICAgICAgICAnRGF0ZSBvYmplY3QsIElTTy04NjAxIHN0cmluZywgb3IgYSBVTklYIHRpbWVzdGFtcCcpOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gdGhpcy5mYWlsKCdVbmtvd25UeXBlJywgJ1VuaGFuZGxlZCB0eXBlICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZS50eXBlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVTdHJpbmc6IGZ1bmN0aW9uIHZhbGlkYXRlU3RyaW5nKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICB2YXIgdmFsaWRUeXBlcyA9IFsnc3RyaW5nJ107CiAgICAgIGlmIChzaGFwZS5pc0pzb25WYWx1ZSkgewogICAgICAgIHZhbGlkVHlwZXMgPSB2YWxpZFR5cGVzLmNvbmNhdChbJ251bWJlcicsICdvYmplY3QnLCAnYm9vbGVhbiddKTsKICAgICAgfQogICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdGhpcy52YWxpZGF0ZVR5cGUodmFsdWUsIGNvbnRleHQsIHZhbGlkVHlwZXMpKSB7CiAgICAgICAgdGhpcy52YWxpZGF0ZUVudW0oc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLmxlbmd0aCwgY29udGV4dCwgJ3N0cmluZyBsZW5ndGgnKTsKICAgICAgICB0aGlzLnZhbGlkYXRlUGF0dGVybihzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICAgIHRoaXMudmFsaWRhdGVVcmkoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlVXJpOiBmdW5jdGlvbiB2YWxpZGF0ZVVyaShzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHNoYXBlWydsb2NhdGlvbiddID09PSAndXJpJykgewogICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHRoaXMuZmFpbCgnVXJpUGFyYW1ldGVyRXJyb3InLCAnRXhwZWN0ZWQgdXJpIHBhcmFtZXRlciB0byBoYXZlIGxlbmd0aCA+PSAxLCcKICAgICAgICAgICAgKyAnIGJ1dCBmb3VuZCAiJyArIHZhbHVlICsnIiBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlUGF0dGVybjogZnVuY3Rpb24gdmFsaWRhdGVQYXR0ZXJuKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgICBpZiAodGhpcy52YWxpZGF0aW9uWydwYXR0ZXJuJ10gJiYgc2hhcGVbJ3BhdHRlcm4nXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKCEobmV3IFJlZ0V4cChzaGFwZVsncGF0dGVybiddKSkudGVzdCh2YWx1ZSkpIHsKICAgICAgICAgIHRoaXMuZmFpbCgnUGF0dGVybk1hdGNoRXJyb3InLCAnUHJvdmlkZWQgdmFsdWUgIicgKyB2YWx1ZSArICciICcKICAgICAgICAgICAgKyAnZG9lcyBub3QgbWF0Y2ggcmVnZXggcGF0dGVybiAvJyArIHNoYXBlWydwYXR0ZXJuJ10gKyAnLyBmb3IgJwogICAgICAgICAgICArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlUmFuZ2U6IGZ1bmN0aW9uIHZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLCBjb250ZXh0LCBkZXNjcmlwdG9yKSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ21pbiddKSB7CiAgICAgICAgaWYgKHNoYXBlWydtaW4nXSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlIDwgc2hhcGVbJ21pbiddKSB7CiAgICAgICAgICB0aGlzLmZhaWwoJ01pblJhbmdlRXJyb3InLCAnRXhwZWN0ZWQgJyArIGRlc2NyaXB0b3IgKyAnID49ICcKICAgICAgICAgICAgKyBzaGFwZVsnbWluJ10gKyAnLCBidXQgZm91bmQgJyArIHZhbHVlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAodGhpcy52YWxpZGF0aW9uWydtYXgnXSkgewogICAgICAgIGlmIChzaGFwZVsnbWF4J10gIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA+IHNoYXBlWydtYXgnXSkgewogICAgICAgICAgdGhpcy5mYWlsKCdNYXhSYW5nZUVycm9yJywgJ0V4cGVjdGVkICcgKyBkZXNjcmlwdG9yICsgJyA8PSAnCiAgICAgICAgICAgICsgc2hhcGVbJ21heCddICsgJywgYnV0IGZvdW5kICcgKyB2YWx1ZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZUVudW06IGZ1bmN0aW9uIHZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ2VudW0nXSAmJiBzaGFwZVsnZW51bSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBGYWlsIGlmIHRoZSBzdHJpbmcgdmFsdWUgaXMgbm90IHByZXNlbnQgaW4gdGhlIGVudW0gbGlzdAogICAgICAgIGlmIChzaGFwZVsnZW51bSddLmluZGV4T2YodmFsdWUpID09PSAtMSkgewogICAgICAgICAgdGhpcy5mYWlsKCdFbnVtRXJyb3InLCAnRm91bmQgc3RyaW5nIHZhbHVlIG9mICcgKyB2YWx1ZSArICcsIGJ1dCAnCiAgICAgICAgICAgICsgJ2V4cGVjdGVkICcgKyBzaGFwZVsnZW51bSddLmpvaW4oJ3wnKSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB2YWxpZGF0ZVR5cGU6IGZ1bmN0aW9uIHZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgYWNjZXB0ZWRUeXBlcywgdHlwZSkgewogICAgICAvLyBXZSB3aWxsIG5vdCBsb2cgYW4gZXJyb3IgZm9yIG51bGwgb3IgdW5kZWZpbmVkLCBidXQgd2Ugd2lsbCByZXR1cm4KICAgICAgLy8gZmFsc2Ugc28gdGhhdCBjYWxsZXJzIGtub3cgdGhhdCB0aGUgZXhwZWN0ZWQgdHlwZSB3YXMgbm90IHN0cmljdGx5IG1ldC4KICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBmYWxzZTsKICAKICAgICAgdmFyIGZvdW5kSW52YWxpZFR5cGUgPSBmYWxzZTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhY2NlcHRlZFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHR5cGVvZiBhY2NlcHRlZFR5cGVzW2ldID09PSAnc3RyaW5nJykgewogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gYWNjZXB0ZWRUeXBlc1tpXSkgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIGlmIChhY2NlcHRlZFR5cGVzW2ldIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICBpZiAoKHZhbHVlIHx8ICcnKS50b1N0cmluZygpLm1hdGNoKGFjY2VwdGVkVHlwZXNbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgYWNjZXB0ZWRUeXBlc1tpXSkgcmV0dXJuIHRydWU7CiAgICAgICAgICBpZiAoQVdTLnV0aWwuaXNUeXBlKHZhbHVlLCBhY2NlcHRlZFR5cGVzW2ldKSkgcmV0dXJuIHRydWU7CiAgICAgICAgICBpZiAoIXR5cGUgJiYgIWZvdW5kSW52YWxpZFR5cGUpIGFjY2VwdGVkVHlwZXMgPSBhY2NlcHRlZFR5cGVzLnNsaWNlKCk7CiAgICAgICAgICBhY2NlcHRlZFR5cGVzW2ldID0gQVdTLnV0aWwudHlwZU5hbWUoYWNjZXB0ZWRUeXBlc1tpXSk7CiAgICAgICAgfQogICAgICAgIGZvdW5kSW52YWxpZFR5cGUgPSB0cnVlOwogICAgICB9CiAgCiAgICAgIHZhciBhY2NlcHRlZFR5cGUgPSB0eXBlOwogICAgICBpZiAoIWFjY2VwdGVkVHlwZSkgewogICAgICAgIGFjY2VwdGVkVHlwZSA9IGFjY2VwdGVkVHlwZXMuam9pbignLCAnKS5yZXBsYWNlKC8sKFteLF0rKSQvLCAnLCBvciQxJyk7CiAgICAgIH0KICAKICAgICAgdmFyIHZvd2VsID0gYWNjZXB0ZWRUeXBlLm1hdGNoKC9eW2FlaW91XS9pKSA/ICduJyA6ICcnOwogICAgICB0aGlzLmZhaWwoJ0ludmFsaWRQYXJhbWV0ZXJUeXBlJywgJ0V4cGVjdGVkICcgKyBjb250ZXh0ICsgJyB0byBiZSBhJyArCiAgICAgICAgICAgICAgICB2b3dlbCArICcgJyArIGFjY2VwdGVkVHlwZSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgCiAgICB2YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24gdmFsaWRhdGVOdW1iZXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFyIGNhc3RlZFZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgICAgICAgaWYgKGNhc3RlZFZhbHVlLnRvU3RyaW5nKCkgPT09IHZhbHVlKSB2YWx1ZSA9IGNhc3RlZFZhbHVlOwogICAgICB9CiAgICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgWydudW1iZXInXSkpIHsKICAgICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLCBjb250ZXh0LCAnbnVtZXJpYyB2YWx1ZScpOwogICAgICB9CiAgICB9LAogIAogICAgdmFsaWRhdGVQYXlsb2FkOiBmdW5jdGlvbiB2YWxpZGF0ZVBheWxvYWQodmFsdWUsIGNvbnRleHQpIHsKICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHJldHVybjsKICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZS5ieXRlTGVuZ3RoID09PSAnbnVtYmVyJykgcmV0dXJuOyAvLyB0eXBlZCBhcnJheXMKICAgICAgaWYgKEFXUy51dGlsLmlzTm9kZSgpKSB7IC8vIHNwZWNpYWwgY2hlY2sgZm9yIGJ1ZmZlci9zdHJlYW0gaW4gTm9kZS5qcwogICAgICAgIHZhciBTdHJlYW0gPSBBV1MudXRpbC5zdHJlYW0uU3RyZWFtOwogICAgICAgIGlmIChBV1MudXRpbC5CdWZmZXIuaXNCdWZmZXIodmFsdWUpIHx8IHZhbHVlIGluc3RhbmNlb2YgU3RyZWFtKSByZXR1cm47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZiBCbG9iICE9PSB2b2lkIDAgJiYgdmFsdWUgaW5zdGFuY2VvZiBCbG9iKSByZXR1cm47CiAgICAgIH0KICAKICAgICAgdmFyIHR5cGVzID0gWydCdWZmZXInLCAnU3RyZWFtJywgJ0ZpbGUnLCAnQmxvYicsICdBcnJheUJ1ZmZlcicsICdEYXRhVmlldyddOwogICAgICBpZiAodmFsdWUpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAoQVdTLnV0aWwuaXNUeXBlKHZhbHVlLCB0eXBlc1tpXSkpIHJldHVybjsKICAgICAgICAgIGlmIChBV1MudXRpbC50eXBlTmFtZSh2YWx1ZS5jb25zdHJ1Y3RvcikgPT09IHR5cGVzW2ldKSByZXR1cm47CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIHRoaXMuZmFpbCgnSW52YWxpZFBhcmFtZXRlclR5cGUnLCAnRXhwZWN0ZWQgJyArIGNvbnRleHQgKyAnIHRvIGJlIGEgJyArCiAgICAgICAgJ3N0cmluZywgQnVmZmVyLCBTdHJlYW0sIEJsb2IsIG9yIHR5cGVkIGFycmF5IG9iamVjdCcpOwogICAgfQogIH0pOwogIAogIH0seyIuL2NvcmUiOjE4fV0sNDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gIHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIC8qKgogICAqIFByZXBlbmQgcHJlZml4IGRlZmluZWQgYnkgQVBJIG1vZGVsIHRvIGVuZHBvaW50IHRoYXQncyBhbHJlYWR5CiAgICogY29uc3RydWN0ZWQuIFRoaXMgZmVhdHVyZSBkb2VzIG5vdCBhcHBseSB0byBvcGVyYXRpb25zIHVzaW5nCiAgICogZW5kcG9pbnQgZGlzY292ZXJ5IGFuZCBjYW4gYmUgZGlzYWJsZWQuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcG9wdWxhdGVIb3N0UHJlZml4KHJlcXVlc3QpICB7CiAgICB2YXIgZW5hYmxlZCA9IHJlcXVlc3Quc2VydmljZS5jb25maWcuaG9zdFByZWZpeEVuYWJsZWQ7CiAgICBpZiAoIWVuYWJsZWQpIHJldHVybiByZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIC8vZG9uJ3QgbWFyc2hhbCBob3N0IHByZWZpeCB3aGVuIG9wZXJhdGlvbiBoYXMgZW5kcG9pbnQgZGlzY292ZXJ5IHRyYWl0cwogICAgaWYgKGhhc0VuZHBvaW50RGlzY292ZXIocmVxdWVzdCkpIHJldHVybiByZXF1ZXN0OwogICAgaWYgKG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50ICYmIG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50Lmhvc3RQcmVmaXgpIHsKICAgICAgdmFyIGhvc3RQcmVmaXhOb3RhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50Lmhvc3RQcmVmaXg7CiAgICAgIHZhciBob3N0UHJlZml4ID0gZXhwYW5kSG9zdFByZWZpeChob3N0UHJlZml4Tm90YXRpb24sIHJlcXVlc3QucGFyYW1zLCBvcGVyYXRpb25Nb2RlbC5pbnB1dCk7CiAgICAgIHByZXBlbmRFbmRwb2ludFByZWZpeChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50LCBob3N0UHJlZml4KTsKICAgICAgdmFsaWRhdGVIb3N0bmFtZShyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3RuYW1lKTsKICAgIH0KICAgIHJldHVybiByZXF1ZXN0OwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBoYXNFbmRwb2ludERpc2NvdmVyKHJlcXVlc3QpIHsKICAgIHZhciBhcGkgPSByZXF1ZXN0LnNlcnZpY2UuYXBpOwogICAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgdmFyIGlzRW5kcG9pbnRPcGVyYXRpb24gPSBhcGkuZW5kcG9pbnRPcGVyYXRpb24gJiYgKGFwaS5lbmRwb2ludE9wZXJhdGlvbiA9PT0gdXRpbC5zdHJpbmcubG93ZXJGaXJzdChvcGVyYXRpb25Nb2RlbC5uYW1lKSk7CiAgICByZXR1cm4gKG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQgIT09ICdOVUxMJyB8fCBpc0VuZHBvaW50T3BlcmF0aW9uID09PSB0cnVlKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gZXhwYW5kSG9zdFByZWZpeChob3N0UHJlZml4Tm90YXRpb24sIHBhcmFtcywgc2hhcGUpIHsKICAgIHV0aWwuZWFjaChzaGFwZS5tZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgaWYgKG1lbWJlci5ob3N0TGFiZWwgPT09IHRydWUpIHsKICAgICAgICBpZiAodHlwZW9mIHBhcmFtc1tuYW1lXSAhPT0gJ3N0cmluZycgfHwgcGFyYW1zW25hbWVdID09PSAnJykgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgICBtZXNzYWdlOiAnUGFyYW1ldGVyICcgKyBuYW1lICsgJyBzaG91bGQgYmUgYSBub24tZW1wdHkgc3RyaW5nLicsCiAgICAgICAgICAgIGNvZGU6ICdJbnZhbGlkUGFyYW1ldGVyJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoJ1xceycgKyBuYW1lICsgJ1xcfScsICdnJyk7CiAgICAgICAgaG9zdFByZWZpeE5vdGF0aW9uID0gaG9zdFByZWZpeE5vdGF0aW9uLnJlcGxhY2UocmVnZXgsIHBhcmFtc1tuYW1lXSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGhvc3RQcmVmaXhOb3RhdGlvbjsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gcHJlcGVuZEVuZHBvaW50UHJlZml4KGVuZHBvaW50LCBwcmVmaXgpIHsKICAgIGlmIChlbmRwb2ludC5ob3N0KSB7CiAgICAgIGVuZHBvaW50Lmhvc3QgPSBwcmVmaXggKyBlbmRwb2ludC5ob3N0OwogICAgfQogICAgaWYgKGVuZHBvaW50Lmhvc3RuYW1lKSB7CiAgICAgIGVuZHBvaW50Lmhvc3RuYW1lID0gcHJlZml4ICsgZW5kcG9pbnQuaG9zdG5hbWU7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHZhbGlkYXRlSG9zdG5hbWUoaG9zdG5hbWUpIHsKICAgIHZhciBsYWJlbHMgPSBob3N0bmFtZS5zcGxpdCgnLicpOwogICAgLy9SZWZlcmVuY2U6IGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMxMTIzI3NlY3Rpb24tMgogICAgdmFyIGhvc3RQYXR0ZXJuID0gL15bYS16QS1aMC05XXsxfSR8XlthLXpBLVowLTldW2EtekEtWjAtOVwtXSpbYS16QS1aMC05XSQvOwogICAgdXRpbC5hcnJheUVhY2gobGFiZWxzLCBmdW5jdGlvbihsYWJlbCkgewogICAgICBpZiAoIWxhYmVsLmxlbmd0aCB8fCBsYWJlbC5sZW5ndGggPCAxIHx8IGxhYmVsLmxlbmd0aCA+IDYzKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgICAgY29kZTogJ1ZhbGlkYXRpb25FcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnSG9zdG5hbWUgbGFiZWwgbGVuZ3RoIHNob3VsZCBiZSBiZXR3ZWVuIDEgdG8gNjMgY2hhcmFjdGVycywgaW5jbHVzaXZlLicKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIWhvc3RQYXR0ZXJuLnRlc3QobGFiZWwpKSB7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICB7Y29kZTogJ1ZhbGlkYXRpb25FcnJvcicsIG1lc3NhZ2U6IGxhYmVsICsgJyBpcyBub3QgaG9zdG5hbWUgY29tcGF0aWJsZS4nfSk7CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIHBvcHVsYXRlSG9zdFByZWZpeDogcG9wdWxhdGVIb3N0UHJlZml4CiAgfTsKICAKICB9LHsiLi4vY29yZSI6MTgsIi4uL3V0aWwiOjcxfV0sNDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBKc29uQnVpbGRlciA9IHJlcXVpcmUoJy4uL2pzb24vYnVpbGRlcicpOwogIHZhciBKc29uUGFyc2VyID0gcmVxdWlyZSgnLi4vanNvbi9wYXJzZXInKTsKICB2YXIgcG9wdWxhdGVIb3N0UHJlZml4ID0gcmVxdWlyZSgnLi9oZWxwZXJzJykucG9wdWxhdGVIb3N0UHJlZml4OwogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIHZhciBodHRwUmVxdWVzdCA9IHJlcS5odHRwUmVxdWVzdDsKICAgIHZhciBhcGkgPSByZXEuc2VydmljZS5hcGk7CiAgICB2YXIgdGFyZ2V0ID0gYXBpLnRhcmdldFByZWZpeCArICcuJyArIGFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLm5hbWU7CiAgICB2YXIgdmVyc2lvbiA9IGFwaS5qc29uVmVyc2lvbiB8fCAnMS4wJzsKICAgIHZhciBpbnB1dCA9IGFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgdmFyIGJ1aWxkZXIgPSBuZXcgSnNvbkJ1aWxkZXIoKTsKICAKICAgIGlmICh2ZXJzaW9uID09PSAxKSB2ZXJzaW9uID0gJzEuMCc7CiAgICBodHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci5idWlsZChyZXEucGFyYW1zIHx8IHt9LCBpbnB1dCk7CiAgICBodHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LWFtei1qc29uLScgKyB2ZXJzaW9uOwogICAgaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotVGFyZ2V0J10gPSB0YXJnZXQ7CiAgCiAgICBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxKTsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICAgIHZhciBlcnJvciA9IHt9OwogICAgdmFyIGh0dHBSZXNwb25zZSA9IHJlc3AuaHR0cFJlc3BvbnNlOwogIAogICAgZXJyb3IuY29kZSA9IGh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tZXJyb3J0eXBlJ10gfHwgJ1Vua25vd25FcnJvcic7CiAgICBpZiAodHlwZW9mIGVycm9yLmNvZGUgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVycm9yLmNvZGUgPSBlcnJvci5jb2RlLnNwbGl0KCc6JylbMF07CiAgICB9CiAgCiAgICBpZiAoaHR0cFJlc3BvbnNlLmJvZHkubGVuZ3RoID4gMCkgewogICAgICB0cnkgewogICAgICAgIHZhciBlID0gSlNPTi5wYXJzZShodHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpKTsKICAgICAgICBpZiAoZS5fX3R5cGUgfHwgZS5jb2RlKSB7CiAgICAgICAgICBlcnJvci5jb2RlID0gKGUuX190eXBlIHx8IGUuY29kZSkuc3BsaXQoJyMnKS5wb3AoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdSZXF1ZXN0RW50aXR5VG9vTGFyZ2UnKSB7CiAgICAgICAgICBlcnJvci5tZXNzYWdlID0gJ1JlcXVlc3QgYm9keSBtdXN0IGJlIGxlc3MgdGhhbiAxIE1CJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXJyb3IubWVzc2FnZSA9IChlLm1lc3NhZ2UgfHwgZS5NZXNzYWdlIHx8IG51bGwpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGVycm9yLnN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICBlcnJvci5tZXNzYWdlID0gaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2U7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVycm9yLnN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgZXJyb3IubWVzc2FnZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLnRvU3RyaW5nKCk7CiAgICB9CiAgCiAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgZXJyb3IpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICB2YXIgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSB8fCAne30nOwogICAgaWYgKHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jb252ZXJ0UmVzcG9uc2VUeXBlcyA9PT0gZmFsc2UpIHsKICAgICAgcmVzcC5kYXRhID0gSlNPTi5wYXJzZShib2R5KTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBvcGVyYXRpb24gPSByZXNwLnJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXNwLnJlcXVlc3Qub3BlcmF0aW9uXTsKICAgICAgdmFyIHNoYXBlID0gb3BlcmF0aW9uLm91dHB1dCB8fCB7fTsKICAgICAgdmFyIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgIHJlc3AuZGF0YSA9IHBhcnNlci5wYXJzZShib2R5LCBzaGFwZSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQogIH07CiAgCiAgfSx7Ii4uL2pzb24vYnVpbGRlciI6MzYsIi4uL2pzb24vcGFyc2VyIjozNywiLi4vdXRpbCI6NzEsIi4vaGVscGVycyI6NDV9XSw0NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgUXVlcnlQYXJhbVNlcmlhbGl6ZXIgPSByZXF1aXJlKCcuLi9xdWVyeS9xdWVyeV9wYXJhbV9zZXJpYWxpemVyJyk7CiAgdmFyIFNoYXBlID0gcmVxdWlyZSgnLi4vbW9kZWwvc2hhcGUnKTsKICB2YXIgcG9wdWxhdGVIb3N0UHJlZml4ID0gcmVxdWlyZSgnLi9oZWxwZXJzJykucG9wdWxhdGVIb3N0UHJlZml4OwogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBodHRwUmVxdWVzdCA9IHJlcS5odHRwUmVxdWVzdDsKICAgIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0KICAgICAgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD11dGYtOCc7CiAgICBodHRwUmVxdWVzdC5wYXJhbXMgPSB7CiAgICAgIFZlcnNpb246IHJlcS5zZXJ2aWNlLmFwaS5hcGlWZXJzaW9uLAogICAgICBBY3Rpb246IG9wZXJhdGlvbi5uYW1lCiAgICB9OwogIAogICAgLy8gY29udmVydCB0aGUgcmVxdWVzdCBwYXJhbWV0ZXJzIGludG8gYSBsaXN0IG9mIHF1ZXJ5IHBhcmFtcywKICAgIC8vIGUuZy4gRGVlcGx5Lk5lc3RlZFBhcmFtLjAuTmFtZT12YWx1ZQogICAgdmFyIGJ1aWxkZXIgPSBuZXcgUXVlcnlQYXJhbVNlcmlhbGl6ZXIoKTsKICAgIGJ1aWxkZXIuc2VyaWFsaXplKHJlcS5wYXJhbXMsIG9wZXJhdGlvbi5pbnB1dCwgZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgaHR0cFJlcXVlc3QucGFyYW1zW25hbWVdID0gdmFsdWU7CiAgICB9KTsKICAgIGh0dHBSZXF1ZXN0LmJvZHkgPSB1dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcoaHR0cFJlcXVlc3QucGFyYW1zKTsKICAKICAgIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgdmFyIGRhdGEsIGJvZHkgPSByZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCk7CiAgICBpZiAoYm9keS5tYXRjaCgnPFVua25vd25PcGVyYXRpb25FeGNlcHRpb24nKSkgewogICAgICBkYXRhID0gewogICAgICAgIENvZGU6ICdVbmtub3duT3BlcmF0aW9uJywKICAgICAgICBNZXNzYWdlOiAnVW5rbm93biBvcGVyYXRpb24gJyArIHJlc3AucmVxdWVzdC5vcGVyYXRpb24KICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIHRyeSB7CiAgICAgICAgZGF0YSA9IG5ldyBBV1MuWE1MLlBhcnNlcigpLnBhcnNlKGJvZHkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgZGF0YSA9IHsKICAgICAgICAgIENvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgICAgICBNZXNzYWdlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlCiAgICAgICAgfTsKICAgICAgfQogICAgfQogIAogICAgaWYgKGRhdGEucmVxdWVzdElkICYmICFyZXNwLnJlcXVlc3RJZCkgcmVzcC5yZXF1ZXN0SWQgPSBkYXRhLnJlcXVlc3RJZDsKICAgIGlmIChkYXRhLkVycm9ycykgZGF0YSA9IGRhdGEuRXJyb3JzOwogICAgaWYgKGRhdGEuRXJyb3IpIGRhdGEgPSBkYXRhLkVycm9yOwogICAgaWYgKGRhdGEuQ29kZSkgewogICAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6IGRhdGEuQ29kZSwKICAgICAgICBtZXNzYWdlOiBkYXRhLk1lc3NhZ2UKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgICAgbWVzc2FnZTogbnVsbAogICAgICB9KTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBzaGFwZSA9IG9wZXJhdGlvbi5vdXRwdXQgfHwge307CiAgICB2YXIgb3JpZ1J1bGVzID0gc2hhcGU7CiAgCiAgICBpZiAob3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXIpIHsKICAgICAgdmFyIHRtcCA9IFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cnVjdHVyZSd9KTsKICAgICAgdG1wLm1lbWJlcnNbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdID0gc2hhcGU7CiAgICAgIHRtcC5tZW1iZXJOYW1lcyA9IFtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl07CiAgICAgIHV0aWwucHJvcGVydHkoc2hhcGUsICduYW1lJywgc2hhcGUucmVzdWx0V3JhcHBlcik7CiAgICAgIHNoYXBlID0gdG1wOwogICAgfQogIAogICAgdmFyIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwogIAogICAgLy8gVE9ETzogUmVmYWN0b3IgWE1MIFBhcnNlciB0byBwYXJzZSBSZXF1ZXN0SWQgZnJvbSByZXNwb25zZS4KICAgIGlmIChzaGFwZSAmJiBzaGFwZS5tZW1iZXJzICYmICFzaGFwZS5tZW1iZXJzLl9YQU1aUmVxdWVzdElkKSB7CiAgICAgIHZhciByZXF1ZXN0SWRTaGFwZSA9IFNoYXBlLmNyZWF0ZSgKICAgICAgICB7IHR5cGU6ICdzdHJpbmcnIH0sCiAgICAgICAgeyBhcGk6IHsgcHJvdG9jb2w6ICdxdWVyeScgfSB9LAogICAgICAgICdyZXF1ZXN0SWQnCiAgICAgICk7CiAgICAgIHNoYXBlLm1lbWJlcnMuX1hBTVpSZXF1ZXN0SWQgPSByZXF1ZXN0SWRTaGFwZTsKICAgIH0KICAKICAgIHZhciBkYXRhID0gcGFyc2VyLnBhcnNlKHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSwgc2hhcGUpOwogICAgcmVzcC5yZXF1ZXN0SWQgPSBkYXRhLl9YQU1aUmVxdWVzdElkIHx8IGRhdGEucmVxdWVzdElkOwogIAogICAgaWYgKGRhdGEuX1hBTVpSZXF1ZXN0SWQpIGRlbGV0ZSBkYXRhLl9YQU1aUmVxdWVzdElkOwogIAogICAgaWYgKG9yaWdSdWxlcy5yZXN1bHRXcmFwcGVyKSB7CiAgICAgIGlmIChkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSkgewogICAgICAgIHV0aWwudXBkYXRlKGRhdGEsIGRhdGFbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdKTsKICAgICAgICBkZWxldGUgZGF0YVtvcmlnUnVsZXMucmVzdWx0V3JhcHBlcl07CiAgICAgIH0KICAgIH0KICAKICAgIHJlc3AuZGF0YSA9IGRhdGE7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuLi9tb2RlbC9zaGFwZSI6NDMsIi4uL3F1ZXJ5L3F1ZXJ5X3BhcmFtX3NlcmlhbGl6ZXIiOjUxLCIuLi91dGlsIjo3MSwiLi9oZWxwZXJzIjo0NX1dLDQ4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgcG9wdWxhdGVIb3N0UHJlZml4ID0gcmVxdWlyZSgnLi9oZWxwZXJzJykucG9wdWxhdGVIb3N0UHJlZml4OwogIAogIGZ1bmN0aW9uIHBvcHVsYXRlTWV0aG9kKHJlcSkgewogICAgcmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmh0dHBNZXRob2Q7CiAgfQogIAogIGZ1bmN0aW9uIGdlbmVyYXRlVVJJKGVuZHBvaW50UGF0aCwgb3BlcmF0aW9uUGF0aCwgaW5wdXQsIHBhcmFtcykgewogICAgdmFyIHVyaSA9IFtlbmRwb2ludFBhdGgsIG9wZXJhdGlvblBhdGhdLmpvaW4oJy8nKTsKICAgIHVyaSA9IHVyaS5yZXBsYWNlKC9cLysvZywgJy8nKTsKICAKICAgIHZhciBxdWVyeVN0cmluZyA9IHt9LCBxdWVyeVN0cmluZ1NldCA9IGZhbHNlOwogICAgdXRpbC5lYWNoKGlucHV0Lm1lbWJlcnMsIGZ1bmN0aW9uIChuYW1lLCBtZW1iZXIpIHsKICAgICAgdmFyIHBhcmFtVmFsdWUgPSBwYXJhbXNbbmFtZV07CiAgICAgIGlmIChwYXJhbVZhbHVlID09PSBudWxsIHx8IHBhcmFtVmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgICBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAndXJpJykgewogICAgICAgIHZhciByZWdleCA9IG5ldyBSZWdFeHAoJ1xceycgKyBtZW1iZXIubmFtZSArICcoXFwrKT9cXH0nKTsKICAgICAgICB1cmkgPSB1cmkucmVwbGFjZShyZWdleCwgZnVuY3Rpb24oXywgcGx1cykgewogICAgICAgICAgdmFyIGZuID0gcGx1cyA/IHV0aWwudXJpRXNjYXBlUGF0aCA6IHV0aWwudXJpRXNjYXBlOwogICAgICAgICAgcmV0dXJuIGZuKFN0cmluZyhwYXJhbVZhbHVlKSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAncXVlcnlzdHJpbmcnKSB7CiAgICAgICAgcXVlcnlTdHJpbmdTZXQgPSB0cnVlOwogIAogICAgICAgIGlmIChtZW1iZXIudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgICAgICBxdWVyeVN0cmluZ1ttZW1iZXIubmFtZV0gPSBwYXJhbVZhbHVlLm1hcChmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIHV0aWwudXJpRXNjYXBlKG1lbWJlci5tZW1iZXIudG9XaXJlRm9ybWF0KHZhbCkudG9TdHJpbmcoKSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICAgICAgdXRpbC5lYWNoKHBhcmFtVmFsdWUsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgcXVlcnlTdHJpbmdba2V5XSA9IHZhbHVlLm1hcChmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLnVyaUVzY2FwZShTdHJpbmcodmFsKSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcXVlcnlTdHJpbmdba2V5XSA9IHV0aWwudXJpRXNjYXBlKFN0cmluZyh2YWx1ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcXVlcnlTdHJpbmdbbWVtYmVyLm5hbWVdID0gdXRpbC51cmlFc2NhcGUobWVtYmVyLnRvV2lyZUZvcm1hdChwYXJhbVZhbHVlKS50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIAogICAgaWYgKHF1ZXJ5U3RyaW5nU2V0KSB7CiAgICAgIHVyaSArPSAodXJpLmluZGV4T2YoJz8nKSA+PSAwID8gJyYnIDogJz8nKTsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHV0aWwuYXJyYXlFYWNoKE9iamVjdC5rZXlzKHF1ZXJ5U3RyaW5nKS5zb3J0KCksIGZ1bmN0aW9uKGtleSkgewogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShxdWVyeVN0cmluZ1trZXldKSkgewogICAgICAgICAgcXVlcnlTdHJpbmdba2V5XSA9IFtxdWVyeVN0cmluZ1trZXldXTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWVyeVN0cmluZ1trZXldLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwYXJ0cy5wdXNoKHV0aWwudXJpRXNjYXBlKFN0cmluZyhrZXkpKSArICc9JyArIHF1ZXJ5U3RyaW5nW2tleV1baV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHVyaSArPSBwYXJ0cy5qb2luKCcmJyk7CiAgICB9CiAgCiAgICByZXR1cm4gdXJpOwogIH0KICAKICBmdW5jdGlvbiBwb3B1bGF0ZVVSSShyZXEpIHsKICAgIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICAgIHZhciBpbnB1dCA9IG9wZXJhdGlvbi5pbnB1dDsKICAKICAgIHZhciB1cmkgPSBnZW5lcmF0ZVVSSShyZXEuaHR0cFJlcXVlc3QuZW5kcG9pbnQucGF0aCwgb3BlcmF0aW9uLmh0dHBQYXRoLCBpbnB1dCwgcmVxLnBhcmFtcyk7CiAgICByZXEuaHR0cFJlcXVlc3QucGF0aCA9IHVyaTsKICB9CiAgCiAgZnVuY3Rpb24gcG9wdWxhdGVIZWFkZXJzKHJlcSkgewogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgdXRpbC5lYWNoKG9wZXJhdGlvbi5pbnB1dC5tZW1iZXJzLCBmdW5jdGlvbiAobmFtZSwgbWVtYmVyKSB7CiAgICAgIHZhciB2YWx1ZSA9IHJlcS5wYXJhbXNbbmFtZV07CiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgCiAgICAgIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXJzJyAmJiBtZW1iZXIudHlwZSA9PT0gJ21hcCcpIHsKICAgICAgICB1dGlsLmVhY2godmFsdWUsIGZ1bmN0aW9uKGtleSwgbWVtYmVyVmFsdWUpIHsKICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW21lbWJlci5uYW1lICsga2V5XSA9IG1lbWJlclZhbHVlOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgICB2YWx1ZSA9IG1lbWJlci50b1dpcmVGb3JtYXQodmFsdWUpLnRvU3RyaW5nKCk7CiAgICAgICAgaWYgKG1lbWJlci5pc0pzb25WYWx1ZSkgewogICAgICAgICAgdmFsdWUgPSB1dGlsLmJhc2U2NC5lbmNvZGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1ttZW1iZXIubmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICAgIHBvcHVsYXRlTWV0aG9kKHJlcSk7CiAgICBwb3B1bGF0ZVVSSShyZXEpOwogICAgcG9wdWxhdGVIZWFkZXJzKHJlcSk7CiAgICBwb3B1bGF0ZUhvc3RQcmVmaXgocmVxKTsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdEVycm9yKCkgewogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIGRhdGEgPSB7fTsKICAgIHZhciByID0gcmVzcC5odHRwUmVzcG9uc2U7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgb3V0cHV0ID0gb3BlcmF0aW9uLm91dHB1dDsKICAKICAgIC8vIG5vcm1hbGl6ZSBoZWFkZXJzIG5hbWVzIHRvIGxvd2VyLWNhc2VkIGtleXMgZm9yIG1hdGNoaW5nCiAgICB2YXIgaGVhZGVycyA9IHt9OwogICAgdXRpbC5lYWNoKHIuaGVhZGVycywgZnVuY3Rpb24gKGssIHYpIHsKICAgICAgaGVhZGVyc1trLnRvTG93ZXJDYXNlKCldID0gdjsKICAgIH0pOwogIAogICAgdXRpbC5lYWNoKG91dHB1dC5tZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgdmFyIGhlYWRlciA9IChtZW1iZXIubmFtZSB8fCBuYW1lKS50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVycycgJiYgbWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgZGF0YVtuYW1lXSA9IHt9OwogICAgICAgIHZhciBsb2NhdGlvbiA9IG1lbWJlci5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlci5uYW1lIDogJyc7CiAgICAgICAgdmFyIHBhdHRlcm4gPSBuZXcgUmVnRXhwKCdeJyArIGxvY2F0aW9uICsgJyguKyknLCAnaScpOwogICAgICAgIHV0aWwuZWFjaChyLmhlYWRlcnMsIGZ1bmN0aW9uIChrLCB2KSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gay5tYXRjaChwYXR0ZXJuKTsKICAgICAgICAgIGlmIChyZXN1bHQgIT09IG51bGwpIHsKICAgICAgICAgICAgZGF0YVtuYW1lXVtyZXN1bHRbMV1dID0gdjsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmIChtZW1iZXIubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICAgICAgaWYgKGhlYWRlcnNbaGVhZGVyXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBtZW1iZXIuaXNKc29uVmFsdWUgPwogICAgICAgICAgICB1dGlsLmJhc2U2NC5kZWNvZGUoaGVhZGVyc1toZWFkZXJdKSA6CiAgICAgICAgICAgIGhlYWRlcnNbaGVhZGVyXTsKICAgICAgICAgIGRhdGFbbmFtZV0gPSBtZW1iZXIudG9UeXBlKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnc3RhdHVzQ29kZScpIHsKICAgICAgICBkYXRhW25hbWVdID0gcGFyc2VJbnQoci5zdGF0dXNDb2RlLCAxMCk7CiAgICAgIH0KICAgIH0pOwogIAogICAgcmVzcC5kYXRhID0gZGF0YTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICAgIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogICAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhLAogICAgZ2VuZXJhdGVVUkk6IGdlbmVyYXRlVVJJCiAgfTsKICAKICB9LHsiLi4vdXRpbCI6NzEsIi4vaGVscGVycyI6NDV9XSw0OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFJlc3QgPSByZXF1aXJlKCcuL3Jlc3QnKTsKICB2YXIgSnNvbiA9IHJlcXVpcmUoJy4vanNvbicpOwogIHZhciBKc29uQnVpbGRlciA9IHJlcXVpcmUoJy4uL2pzb24vYnVpbGRlcicpOwogIHZhciBKc29uUGFyc2VyID0gcmVxdWlyZSgnLi4vanNvbi9wYXJzZXInKTsKICAKICBmdW5jdGlvbiBwb3B1bGF0ZUJvZHkocmVxKSB7CiAgICB2YXIgYnVpbGRlciA9IG5ldyBKc29uQnVpbGRlcigpOwogICAgdmFyIGlucHV0ID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgCiAgICBpZiAoaW5wdXQucGF5bG9hZCkgewogICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgIHZhciBwYXlsb2FkU2hhcGUgPSBpbnB1dC5tZW1iZXJzW2lucHV0LnBheWxvYWRdOwogICAgICBwYXJhbXMgPSByZXEucGFyYW1zW2lucHV0LnBheWxvYWRdOwogICAgICBpZiAocGFyYW1zID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgaWYgKHBheWxvYWRTaGFwZS50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci5idWlsZChwYXJhbXMsIHBheWxvYWRTaGFwZSk7CiAgICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEpOwogICAgICB9IGVsc2UgeyAvLyBub24tSlNPTiBwYXlsb2FkCiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBwYXJhbXM7CiAgICAgICAgaWYgKHBheWxvYWRTaGFwZS50eXBlID09PSAnYmluYXJ5JyB8fCBwYXlsb2FkU2hhcGUuaXNTdHJlYW1pbmcpIHsKICAgICAgICAgIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBib2R5ID0gYnVpbGRlci5idWlsZChyZXEucGFyYW1zLCBpbnB1dCk7CiAgICAgIGlmIChib2R5ICE9PSAne30nIHx8IHJlcS5odHRwUmVxdWVzdC5tZXRob2QgIT09ICdHRVQnKSB7IC8vZG9uJ3Qgc2VuZCBlbXB0eSBib2R5IGZvciBHRVQgbWV0aG9kCiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBib2R5OwogICAgICB9CiAgICAgIGFwcGx5Q29udGVudFR5cGVIZWFkZXIocmVxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEsIGlzQmluYXJ5KSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgaW5wdXQgPSBvcGVyYXRpb24uaW5wdXQ7CiAgCiAgICBpZiAoIXJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSkgewogICAgICB2YXIgdHlwZSA9IGlzQmluYXJ5ID8gJ2JpbmFyeS9vY3RldC1zdHJlYW0nIDogJ2FwcGxpY2F0aW9uL2pzb24nOwogICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSB0eXBlOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgICBSZXN0LmJ1aWxkUmVxdWVzdChyZXEpOwogIAogICAgLy8gbmV2ZXIgc2VuZCBib2R5IHBheWxvYWQgb24gSEVBRC9ERUxFVEUKICAgIGlmIChbJ0hFQUQnLCAnREVMRVRFJ10uaW5kZXhPZihyZXEuaHR0cFJlcXVlc3QubWV0aG9kKSA8IDApIHsKICAgICAgcG9wdWxhdGVCb2R5KHJlcSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgICBKc29uLmV4dHJhY3RFcnJvcihyZXNwKTsKICB9CiAgCiAgZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogICAgUmVzdC5leHRyYWN0RGF0YShyZXNwKTsKICAKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5vdXRwdXQgfHwge307CiAgICB2YXIgcGFyc2VyOwogICAgdmFyIGhhc0V2ZW50T3V0cHV0ID0gb3BlcmF0aW9uLmhhc0V2ZW50T3V0cHV0OwogIAogICAgaWYgKHJ1bGVzLnBheWxvYWQpIHsKICAgICAgdmFyIHBheWxvYWRNZW1iZXIgPSBydWxlcy5tZW1iZXJzW3J1bGVzLnBheWxvYWRdOwogICAgICB2YXIgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHk7CiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW0pIHsKICAgICAgICBwYXJzZXIgPSBuZXcgSnNvblBhcnNlcigpOwogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHV0aWwuY3JlYXRlRXZlbnRTdHJlYW0oCiAgICAgICAgICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiA/IHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA6IGJvZHksCiAgICAgICAgICBwYXJzZXIsCiAgICAgICAgICBwYXlsb2FkTWVtYmVyCiAgICAgICAgKTsKICAgICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnIHx8IHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2xpc3QnKSB7CiAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcGFyc2VyLnBhcnNlKGJvZHksIHBheWxvYWRNZW1iZXIpOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IGJvZHk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcGF5bG9hZE1lbWJlci50b1R5cGUoYm9keSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHZhciBkYXRhID0gcmVzcC5kYXRhOwogICAgICBKc29uLmV4dHJhY3REYXRhKHJlc3ApOwogICAgICByZXNwLmRhdGEgPSB1dGlsLm1lcmdlKGRhdGEsIHJlc3AuZGF0YSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gewogICAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICAgIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQogIH07CiAgCiAgfSx7Ii4uL2pzb24vYnVpbGRlciI6MzYsIi4uL2pzb24vcGFyc2VyIjozNywiLi4vdXRpbCI6NzEsIi4vanNvbiI6NDYsIi4vcmVzdCI6NDh9XSw1MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKICB2YXIgUmVzdCA9IHJlcXVpcmUoJy4vcmVzdCcpOwogIAogIGZ1bmN0aW9uIHBvcHVsYXRlQm9keShyZXEpIHsKICAgIHZhciBpbnB1dCA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgdmFyIGJ1aWxkZXIgPSBuZXcgQVdTLlhNTC5CdWlsZGVyKCk7CiAgICB2YXIgcGFyYW1zID0gcmVxLnBhcmFtczsKICAKICAgIHZhciBwYXlsb2FkID0gaW5wdXQucGF5bG9hZDsKICAgIGlmIChwYXlsb2FkKSB7CiAgICAgIHZhciBwYXlsb2FkTWVtYmVyID0gaW5wdXQubWVtYmVyc1twYXlsb2FkXTsKICAgICAgcGFyYW1zID0gcGFyYW1zW3BheWxvYWRdOwogICAgICBpZiAocGFyYW1zID09PSB1bmRlZmluZWQpIHJldHVybjsKICAKICAgICAgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgICB2YXIgcm9vdEVsZW1lbnQgPSBwYXlsb2FkTWVtYmVyLm5hbWU7CiAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLnRvWE1MKHBhcmFtcywgcGF5bG9hZE1lbWJlciwgcm9vdEVsZW1lbnQsIHRydWUpOwogICAgICB9IGVsc2UgeyAvLyBub24teG1sIHBheWxvYWQKICAgICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IHBhcmFtczsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLnRvWE1MKHBhcmFtcywgaW5wdXQsIGlucHV0Lm5hbWUgfHwKICAgICAgICBpbnB1dC5zaGFwZSB8fCB1dGlsLnN0cmluZy51cHBlckZpcnN0KHJlcS5vcGVyYXRpb24pICsgJ1JlcXVlc3QnKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KHJlcSkgewogICAgUmVzdC5idWlsZFJlcXVlc3QocmVxKTsKICAKICAgIC8vIG5ldmVyIHNlbmQgYm9keSBwYXlsb2FkIG9uIEdFVC9IRUFECiAgICBpZiAoWydHRVQnLCAnSEVBRCddLmluZGV4T2YocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCkgPCAwKSB7CiAgICAgIHBvcHVsYXRlQm9keShyZXEpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogICAgUmVzdC5leHRyYWN0RXJyb3IocmVzcCk7CiAgCiAgICB2YXIgZGF0YTsKICAgIHRyeSB7CiAgICAgIGRhdGEgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKS5wYXJzZShyZXNwLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKCkpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBkYXRhID0gewogICAgICAgIENvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgICAgTWVzc2FnZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZQogICAgICB9OwogICAgfQogIAogICAgaWYgKGRhdGEuRXJyb3JzKSBkYXRhID0gZGF0YS5FcnJvcnM7CiAgICBpZiAoZGF0YS5FcnJvcikgZGF0YSA9IGRhdGEuRXJyb3I7CiAgICBpZiAoZGF0YS5Db2RlKSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogZGF0YS5Db2RlLAogICAgICAgIG1lc3NhZ2U6IGRhdGEuTWVzc2FnZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgICBtZXNzYWdlOiBudWxsCiAgICAgIH0pOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgICBSZXN0LmV4dHJhY3REYXRhKHJlc3ApOwogIAogICAgdmFyIHBhcnNlcjsKICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICB2YXIgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHk7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICB2YXIgb3V0cHV0ID0gb3BlcmF0aW9uLm91dHB1dDsKICAKICAgIHZhciBoYXNFdmVudE91dHB1dCA9IG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dDsKICAKICAgIHZhciBwYXlsb2FkID0gb3V0cHV0LnBheWxvYWQ7CiAgICBpZiAocGF5bG9hZCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG91dHB1dC5tZW1iZXJzW3BheWxvYWRdOwogICAgICBpZiAocGF5bG9hZE1lbWJlci5pc0V2ZW50U3RyZWFtKSB7CiAgICAgICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gdXRpbC5jcmVhdGVFdmVudFN0cmVhbSgKICAgICAgICAgIEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyID8gcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtIDogcmVzcC5odHRwUmVzcG9uc2UuYm9keSwKICAgICAgICAgIHBhcnNlciwKICAgICAgICAgIHBheWxvYWRNZW1iZXIKICAgICAgICApOwogICAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSBwYXJzZXIucGFyc2UoYm9keS50b1N0cmluZygpLCBwYXlsb2FkTWVtYmVyKTsKICAgICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgICByZXNwLmRhdGFbcGF5bG9hZF0gPSBib2R5OwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHBheWxvYWRNZW1iZXIudG9UeXBlKGJvZHkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGJvZHkubGVuZ3RoID4gMCkgewogICAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgICAgdmFyIGRhdGEgPSBwYXJzZXIucGFyc2UoYm9keS50b1N0cmluZygpLCBvdXRwdXQpOwogICAgICB1dGlsLnVwZGF0ZShyZXNwLmRhdGEsIGRhdGEpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogICAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKICB9OwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi4vdXRpbCI6NzEsIi4vcmVzdCI6NDh9XSw1MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgCiAgZnVuY3Rpb24gUXVlcnlQYXJhbVNlcmlhbGl6ZXIoKSB7CiAgfQogIAogIFF1ZXJ5UGFyYW1TZXJpYWxpemVyLnByb3RvdHlwZS5zZXJpYWxpemUgPSBmdW5jdGlvbihwYXJhbXMsIHNoYXBlLCBmbikgewogICAgc2VyaWFsaXplU3RydWN0dXJlKCcnLCBwYXJhbXMsIHNoYXBlLCBmbik7CiAgfTsKICAKICBmdW5jdGlvbiB1Y2ZpcnN0KHNoYXBlKSB7CiAgICBpZiAoc2hhcGUuaXNRdWVyeU5hbWUgfHwgc2hhcGUuYXBpLnByb3RvY29sICE9PSAnZWMyJykgewogICAgICByZXR1cm4gc2hhcGUubmFtZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBzaGFwZS5uYW1lWzBdLnRvVXBwZXJDYXNlKCkgKyBzaGFwZS5uYW1lLnN1YnN0cigxKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplU3RydWN0dXJlKHByZWZpeCwgc3RydWN0LCBydWxlcywgZm4pIHsKICAgIHV0aWwuZWFjaChydWxlcy5tZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgdmFyIHZhbHVlID0gc3RydWN0W25hbWVdOwogICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogIAogICAgICB2YXIgbWVtYmVyTmFtZSA9IHVjZmlyc3QobWVtYmVyKTsKICAgICAgbWVtYmVyTmFtZSA9IHByZWZpeCA/IHByZWZpeCArICcuJyArIG1lbWJlck5hbWUgOiBtZW1iZXJOYW1lOwogICAgICBzZXJpYWxpemVNZW1iZXIobWVtYmVyTmFtZSwgdmFsdWUsIG1lbWJlciwgZm4pOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZU1hcChuYW1lLCBtYXAsIHJ1bGVzLCBmbikgewogICAgdmFyIGkgPSAxOwogICAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIHByZWZpeCA9IHJ1bGVzLmZsYXR0ZW5lZCA/ICcuJyA6ICcuZW50cnkuJzsKICAgICAgdmFyIHBvc2l0aW9uID0gcHJlZml4ICsgKGkrKykgKyAnLic7CiAgICAgIHZhciBrZXlOYW1lID0gcG9zaXRpb24gKyAocnVsZXMua2V5Lm5hbWUgfHwgJ2tleScpOwogICAgICB2YXIgdmFsdWVOYW1lID0gcG9zaXRpb24gKyAocnVsZXMudmFsdWUubmFtZSB8fCAndmFsdWUnKTsKICAgICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyBrZXlOYW1lLCBrZXksIHJ1bGVzLmtleSwgZm4pOwogICAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIHZhbHVlTmFtZSwgdmFsdWUsIHJ1bGVzLnZhbHVlLCBmbik7CiAgICB9KTsKICB9CiAgCiAgZnVuY3Rpb24gc2VyaWFsaXplTGlzdChuYW1lLCBsaXN0LCBydWxlcywgZm4pIHsKICAgIHZhciBtZW1iZXJSdWxlcyA9IHJ1bGVzLm1lbWJlciB8fCB7fTsKICAKICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICBmbi5jYWxsKHRoaXMsIG5hbWUsIG51bGwpOwogICAgICByZXR1cm47CiAgICB9CiAgCiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbiAodiwgbikgewogICAgICB2YXIgc3VmZml4ID0gJy4nICsgKG4gKyAxKTsKICAgICAgaWYgKHJ1bGVzLmFwaS5wcm90b2NvbCA9PT0gJ2VjMicpIHsKICAgICAgICAvLyBEbyBub3RoaW5nIGZvciBFQzIKICAgICAgICBzdWZmaXggPSBzdWZmaXggKyAnJzsgLy8gbWFrZSBsaW50ZXIgaGFwcHkKICAgICAgfSBlbHNlIGlmIChydWxlcy5mbGF0dGVuZWQpIHsKICAgICAgICBpZiAobWVtYmVyUnVsZXMubmFtZSkgewogICAgICAgICAgdmFyIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpOwogICAgICAgICAgcGFydHMucG9wKCk7CiAgICAgICAgICBwYXJ0cy5wdXNoKHVjZmlyc3QobWVtYmVyUnVsZXMpKTsKICAgICAgICAgIG5hbWUgPSBwYXJ0cy5qb2luKCcuJyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHN1ZmZpeCA9ICcuJyArIChtZW1iZXJSdWxlcy5uYW1lID8gbWVtYmVyUnVsZXMubmFtZSA6ICdtZW1iZXInKSArIHN1ZmZpeDsKICAgICAgfQogICAgICBzZXJpYWxpemVNZW1iZXIobmFtZSArIHN1ZmZpeCwgdiwgbWVtYmVyUnVsZXMsIGZuKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVNZW1iZXIobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbikgewogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgIGlmIChydWxlcy50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICBzZXJpYWxpemVTdHJ1Y3R1cmUobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgICB9IGVsc2UgaWYgKHJ1bGVzLnR5cGUgPT09ICdsaXN0JykgewogICAgICBzZXJpYWxpemVMaXN0KG5hbWUsIHZhbHVlLCBydWxlcywgZm4pOwogICAgfSBlbHNlIGlmIChydWxlcy50eXBlID09PSAnbWFwJykgewogICAgICBzZXJpYWxpemVNYXAobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgICB9IGVsc2UgewogICAgICBmbihuYW1lLCBydWxlcy50b1dpcmVGb3JtYXQodmFsdWUpLnRvU3RyaW5nKCkpOwogICAgfQogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFF1ZXJ5UGFyYW1TZXJpYWxpemVyOwogIAogIH0seyIuLi91dGlsIjo3MX1dLDUyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgIC8vcHJvdmlkZSByZWFsdGltZSBjbG9jayBmb3IgcGVyZm9ybWFuY2UgbWVhc3VyZW1lbnQKICAgIG5vdzogZnVuY3Rpb24gbm93KCkgewogICAgICBpZiAodHlwZW9mIHBlcmZvcm1hbmNlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9CiAgICAgIHJldHVybiBEYXRlLm5vdygpOwogICAgfQogIH07CiAgCiAgfSx7fV0sNTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CiAgdmFyIHJlZ2lvbkNvbmZpZyA9IHJlcXVpcmUoJy4vcmVnaW9uX2NvbmZpZ19kYXRhLmpzb24nKTsKICAKICBmdW5jdGlvbiBnZW5lcmF0ZVJlZ2lvblByZWZpeChyZWdpb24pIHsKICAgIGlmICghcmVnaW9uKSByZXR1cm4gbnVsbDsKICAKICAgIHZhciBwYXJ0cyA9IHJlZ2lvbi5zcGxpdCgnLScpOwogICAgaWYgKHBhcnRzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwogICAgcmV0dXJuIHBhcnRzLnNsaWNlKDAsIHBhcnRzLmxlbmd0aCAtIDIpLmpvaW4oJy0nKSArICctKic7CiAgfQogIAogIGZ1bmN0aW9uIGRlcml2ZWRLZXlzKHNlcnZpY2UpIHsKICAgIHZhciByZWdpb24gPSBzZXJ2aWNlLmNvbmZpZy5yZWdpb247CiAgICB2YXIgcmVnaW9uUHJlZml4ID0gZ2VuZXJhdGVSZWdpb25QcmVmaXgocmVnaW9uKTsKICAgIHZhciBlbmRwb2ludFByZWZpeCA9IHNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4OwogIAogICAgcmV0dXJuIFsKICAgICAgW3JlZ2lvbiwgZW5kcG9pbnRQcmVmaXhdLAogICAgICBbcmVnaW9uUHJlZml4LCBlbmRwb2ludFByZWZpeF0sCiAgICAgIFtyZWdpb24sICcqJ10sCiAgICAgIFtyZWdpb25QcmVmaXgsICcqJ10sCiAgICAgIFsnKicsIGVuZHBvaW50UHJlZml4XSwKICAgICAgWycqJywgJyonXQogICAgXS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICByZXR1cm4gaXRlbVswXSAmJiBpdGVtWzFdID8gaXRlbS5qb2luKCcvJykgOiBudWxsOwogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIGFwcGx5Q29uZmlnKHNlcnZpY2UsIGNvbmZpZykgewogICAgdXRpbC5lYWNoKGNvbmZpZywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICBpZiAoa2V5ID09PSAnZ2xvYmFsRW5kcG9pbnQnKSByZXR1cm47CiAgICAgIGlmIChzZXJ2aWNlLmNvbmZpZ1trZXldID09PSB1bmRlZmluZWQgfHwgc2VydmljZS5jb25maWdba2V5XSA9PT0gbnVsbCkgewogICAgICAgIHNlcnZpY2UuY29uZmlnW2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgfQogIAogIGZ1bmN0aW9uIGNvbmZpZ3VyZUVuZHBvaW50KHNlcnZpY2UpIHsKICAgIHZhciBrZXlzID0gZGVyaXZlZEtleXMoc2VydmljZSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgIGlmICgha2V5KSBjb250aW51ZTsKICAKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChyZWdpb25Db25maWcucnVsZXMsIGtleSkpIHsKICAgICAgICB2YXIgY29uZmlnID0gcmVnaW9uQ29uZmlnLnJ1bGVzW2tleV07CiAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBjb25maWcgPSByZWdpb25Db25maWcucGF0dGVybnNbY29uZmlnXTsKICAgICAgICB9CiAgCiAgICAgICAgLy8gc2V0IGR1YWxzdGFjayBlbmRwb2ludAogICAgICAgIGlmIChzZXJ2aWNlLmNvbmZpZy51c2VEdWFsc3RhY2sgJiYgdXRpbC5pc0R1YWxzdGFja0F2YWlsYWJsZShzZXJ2aWNlKSkgewogICAgICAgICAgY29uZmlnID0gdXRpbC5jb3B5KGNvbmZpZyk7CiAgICAgICAgICBjb25maWcuZW5kcG9pbnQgPSAne3NlcnZpY2V9LmR1YWxzdGFjay57cmVnaW9ufS5hbWF6b25hd3MuY29tJzsKICAgICAgICB9CiAgCiAgICAgICAgLy8gc2V0IGdsb2JhbCBlbmRwb2ludAogICAgICAgIHNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCA9ICEhY29uZmlnLmdsb2JhbEVuZHBvaW50OwogIAogICAgICAgIC8vIHNpZ25hdHVyZSB2ZXJzaW9uCiAgICAgICAgaWYgKCFjb25maWcuc2lnbmF0dXJlVmVyc2lvbikgY29uZmlnLnNpZ25hdHVyZVZlcnNpb24gPSAndjQnOwogIAogICAgICAgIC8vIG1lcmdlIGNvbmZpZwogICAgICAgIGFwcGx5Q29uZmlnKHNlcnZpY2UsIGNvbmZpZyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gY29uZmlndXJlRW5kcG9pbnQ7CiAgCiAgfSx7Ii4vcmVnaW9uX2NvbmZpZ19kYXRhLmpzb24iOjU0LCIuL3V0aWwiOjcxfV0sNTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzPXsKICAgICJydWxlcyI6IHsKICAgICAgIiovKiI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICAgIH0sCiAgICAgICJjbi0qLyoiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tLmNuIgogICAgICB9LAogICAgICAiKi9idWRnZXRzIjogImdsb2JhbFNTTCIsCiAgICAgICIqL2Nsb3VkZnJvbnQiOiAiZ2xvYmFsU1NMIiwKICAgICAgIiovaWFtIjogImdsb2JhbFNTTCIsCiAgICAgICIqL3N0cyI6ICJnbG9iYWxTU0wiLAogICAgICAiKi9pbXBvcnRleHBvcnQiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIsCiAgICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZQogICAgICB9LAogICAgICAiKi9yb3V0ZTUzIjogewogICAgICAgICJlbmRwb2ludCI6ICJodHRwczovL3tzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2M2h0dHBzIiwKICAgICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlCiAgICAgIH0sCiAgICAgICIqL3dhZiI6ICJnbG9iYWxTU0wiLAogICAgICAidXMtZ292LSovaWFtIjogImdsb2JhbEdvdkNsb3VkIiwKICAgICAgInVzLWdvdi0qL3N0cyI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICAgIH0sCiAgICAgICJ1cy1nb3Ytd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInVzLXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJ1cy13ZXN0LTIvczMiOiAiczNzaWduYXR1cmUiLAogICAgICAiZXUtd2VzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgImFwLXNvdXRoZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgImFwLXNvdXRoZWFzdC0yL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgImFwLW5vcnRoZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICAgInNhLWVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAgICJ1cy1lYXN0LTEvczMiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJzMyIKICAgICAgfSwKICAgICAgInVzLWVhc3QtMS9zZGIiOiB7CiAgICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIKICAgICAgfSwKICAgICAgIiovc2RiIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIsCiAgICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiCiAgICAgIH0KICAgIH0sCiAgCiAgICAicGF0dGVybnMiOiB7CiAgICAgICJnbG9iYWxTU0wiOiB7CiAgICAgICAgImVuZHBvaW50IjogImh0dHBzOi8ve3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgICAgfSwKICAgICAgImdsb2JhbEdvdkNsb3VkIjogewogICAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0udXMtZ292LmFtYXpvbmF3cy5jb20iCiAgICAgIH0sCiAgICAgICJzM3NpZ25hdHVyZSI6IHsKICAgICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iLAogICAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInMzIgogICAgICB9CiAgICB9CiAgfQogIAogIH0se31dLDU1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIEFjY2VwdG9yU3RhdGVNYWNoaW5lID0gcmVxdWlyZSgnLi9zdGF0ZV9tYWNoaW5lJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBkb21haW4gPSBBV1MudXRpbC5kb21haW47CiAgdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgaGFyZEVycm9yU3RhdGVzID0ge3N1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMX07CiAgCiAgZnVuY3Rpb24gaXNUZXJtaW5hbFN0YXRlKG1hY2hpbmUpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaGFyZEVycm9yU3RhdGVzLCBtYWNoaW5lLl9hc20uY3VycmVudFN0YXRlKTsKICB9CiAgCiAgdmFyIGZzbSA9IG5ldyBBY2NlcHRvclN0YXRlTWFjaGluZSgpOwogIGZzbS5zZXR1cFN0YXRlcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHRyYW5zaXRpb24gPSBmdW5jdGlvbihfLCBkb25lKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvciA9IGZhbHNlOwogIAogICAgICBzZWxmLmVtaXQoc2VsZi5fYXNtLmN1cnJlbnRTdGF0ZSwgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgaWYgKGlzVGVybWluYWxTdGF0ZShzZWxmKSkgewogICAgICAgICAgICBpZiAoZG9tYWluICYmIHNlbGYuZG9tYWluIGluc3RhbmNlb2YgZG9tYWluLkRvbWFpbikgewogICAgICAgICAgICAgIGVyci5kb21haW5FbWl0dGVyID0gc2VsZjsKICAgICAgICAgICAgICBlcnIuZG9tYWluID0gc2VsZi5kb21haW47CiAgICAgICAgICAgICAgZXJyLmRvbWFpblRocm93biA9IGZhbHNlOwogICAgICAgICAgICAgIHNlbGYuZG9tYWluLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICAgIGRvbmUoZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9uZShzZWxmLnJlc3BvbnNlLmVycm9yKTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgfTsKICAKICAgIHRoaXMuYWRkU3RhdGUoJ3ZhbGlkYXRlJywgJ2J1aWxkJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdidWlsZCcsICdhZnRlckJ1aWxkJywgJ3Jlc3RhcnQnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2FmdGVyQnVpbGQnLCAnc2lnbicsICdyZXN0YXJ0JywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdzaWduJywgJ3NlbmQnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3JldHJ5JywgJ2FmdGVyUmV0cnknLCAnYWZ0ZXJSZXRyeScsIHRyYW5zaXRpb24pOwogICAgdGhpcy5hZGRTdGF0ZSgnYWZ0ZXJSZXRyeScsICdzaWduJywgJ2Vycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdzZW5kJywgJ3ZhbGlkYXRlUmVzcG9uc2UnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3ZhbGlkYXRlUmVzcG9uc2UnLCAnZXh0cmFjdERhdGEnLCAnZXh0cmFjdEVycm9yJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdleHRyYWN0RXJyb3InLCAnZXh0cmFjdERhdGEnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2V4dHJhY3REYXRhJywgJ3N1Y2Nlc3MnLCAncmV0cnknLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3Jlc3RhcnQnLCAnYnVpbGQnLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ3N1Y2Nlc3MnLCAnY29tcGxldGUnLCAnY29tcGxldGUnLCB0cmFuc2l0aW9uKTsKICAgIHRoaXMuYWRkU3RhdGUoJ2Vycm9yJywgJ2NvbXBsZXRlJywgJ2NvbXBsZXRlJywgdHJhbnNpdGlvbik7CiAgICB0aGlzLmFkZFN0YXRlKCdjb21wbGV0ZScsIG51bGwsIG51bGwsIHRyYW5zaXRpb24pOwogIH07CiAgZnNtLnNldHVwU3RhdGVzKCk7CiAgCiAgLyoqCiAgICogIyMgQXN5bmNocm9ub3VzIFJlcXVlc3RzCiAgICoKICAgKiBBbGwgcmVxdWVzdHMgbWFkZSB0aHJvdWdoIHRoZSBTREsgYXJlIGFzeW5jaHJvbm91cyBhbmQgdXNlIGEKICAgKiBjYWxsYmFjayBpbnRlcmZhY2UuIEVhY2ggc2VydmljZSBtZXRob2QgdGhhdCBraWNrcyBvZmYgYSByZXF1ZXN0CiAgICogcmV0dXJucyBhbiBgQVdTLlJlcXVlc3RgIG9iamVjdCB0aGF0IHlvdSBjYW4gdXNlIHRvIHJlZ2lzdGVyCiAgICogY2FsbGJhY2tzLgogICAqCiAgICogRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgc2VydmljZSBtZXRob2QgcmV0dXJucyB0aGUgcmVxdWVzdAogICAqIG9iamVjdCBhcyAicmVxdWVzdCIsIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHJlZ2lzdGVyIGNhbGxiYWNrczoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiAvLyByZXF1ZXN0IGlzIGFuIEFXUy5SZXF1ZXN0IG9iamVjdAogICAqIHZhciByZXF1ZXN0ID0gZWMyLmRlc2NyaWJlSW5zdGFuY2VzKCk7CiAgICoKICAgKiAvLyByZWdpc3RlciBjYWxsYmFja3Mgb24gcmVxdWVzdCB0byByZXRyaWV2ZSByZXNwb25zZSBkYXRhCiAgICogcmVxdWVzdC5vbignc3VjY2VzcycsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICogICBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhKTsKICAgKiB9KTsKICAgKiBgYGAKICAgKgogICAqIFdoZW4gYSByZXF1ZXN0IGlzIHJlYWR5IHRvIGJlIHNlbnQsIHRoZSB7c2VuZH0gbWV0aG9kIHNob3VsZAogICAqIGJlIGNhbGxlZDoKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiByZXF1ZXN0LnNlbmQoKTsKICAgKiBgYGAKICAgKgogICAqIFNpbmNlIHJlZ2lzdGVyZWQgY2FsbGJhY2tzIG1heSBvciBtYXkgbm90IGJlIGlkZW1wb3RlbnQsIHJlcXVlc3RzIHNob3VsZCBvbmx5CiAgICogYmUgc2VudCBvbmNlLiBUbyBwZXJmb3JtIHRoZSBzYW1lIG9wZXJhdGlvbiBtdWx0aXBsZSB0aW1lcywgeW91IHdpbGwgbmVlZCB0bwogICAqIGNyZWF0ZSBtdWx0aXBsZSByZXF1ZXN0IG9iamVjdHMsIGVhY2ggd2l0aCBpdHMgb3duIHJlZ2lzdGVyZWQgY2FsbGJhY2tzLgogICAqCiAgICogIyMgUmVtb3ZpbmcgRGVmYXVsdCBMaXN0ZW5lcnMgZm9yIEV2ZW50cwogICAqCiAgICogUmVxdWVzdCBvYmplY3RzIGFyZSBidWlsdCB3aXRoIGRlZmF1bHQgbGlzdGVuZXJzIGZvciB0aGUgdmFyaW91cyBldmVudHMsCiAgICogZGVwZW5kaW5nIG9uIHRoZSBzZXJ2aWNlIHR5cGUuIEluIHNvbWUgY2FzZXMsIHlvdSBtYXkgd2FudCB0byByZW1vdmUKICAgKiBzb21lIGJ1aWx0LWluIGxpc3RlbmVycyB0byBjdXN0b21pemUgYmVoYXZpb3VyLiBEb2luZyB0aGlzIHJlcXVpcmVzCiAgICogYWNjZXNzIHRvIHRoZSBidWlsdC1pbiBsaXN0ZW5lciBmdW5jdGlvbnMsIHdoaWNoIGFyZSBleHBvc2VkIHRocm91Z2gKICAgKiB0aGUge0FXUy5FdmVudExpc3RlbmVycy5Db3JlfSBuYW1lc3BhY2UuIEZvciBpbnN0YW5jZSwgeW91IG1heQogICAqIHdhbnQgdG8gY3VzdG9taXplIHRoZSBIVFRQIGhhbmRsZXIgdXNlZCB3aGVuIHNlbmRpbmcgYSByZXF1ZXN0LiBJbiB0aGlzCiAgICogY2FzZSwgeW91IGNhbiByZW1vdmUgdGhlIGJ1aWx0LWluIGxpc3RlbmVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgJ3NlbmQnCiAgICogZXZlbnQsIHRoZSB7QVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORH0gbGlzdGVuZXIgYW5kIGFkZCB5b3VyIG93bi4KICAgKgogICAqICMjIE11bHRpcGxlIENhbGxiYWNrcyBhbmQgQ2hhaW5pbmcKICAgKgogICAqIFlvdSBjYW4gcmVnaXN0ZXIgbXVsdGlwbGUgY2FsbGJhY2tzIG9uIGFueSByZXF1ZXN0IG9iamVjdC4gVGhlCiAgICogY2FsbGJhY2tzIGNhbiBiZSByZWdpc3RlcmVkIGZvciBkaWZmZXJlbnQgZXZlbnRzLCBvciBhbGwgZm9yIHRoZQogICAqIHNhbWUgZXZlbnQuIEluIGFkZGl0aW9uLCB5b3UgY2FuIGNoYWluIGNhbGxiYWNrIHJlZ2lzdHJhdGlvbiwgZm9yCiAgICogZXhhbXBsZToKICAgKgogICAqIGBgYGphdmFzY3JpcHQKICAgKiByZXF1ZXN0LgogICAqICAgb24oJ3N1Y2Nlc3MnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgICBjb25zb2xlLmxvZygiU3VjY2VzcyEiKTsKICAgKiAgIH0pLgogICAqICAgb24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyb3IsIHJlc3BvbnNlKSB7CiAgICogICAgIGNvbnNvbGUubG9nKCJFcnJvciEiKTsKICAgKiAgIH0pLgogICAqICAgb24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgY29uc29sZS5sb2coIkFsd2F5cyEiKTsKICAgKiAgIH0pLgogICAqICAgc2VuZCgpOwogICAqIGBgYAogICAqCiAgICogVGhlIGFib3ZlIGV4YW1wbGUgd2lsbCBwcmludCBlaXRoZXIgIlN1Y2Nlc3MhIEFsd2F5cyEiLCBvciAiRXJyb3IhIEFsd2F5cyEiLAogICAqIGRlcGVuZGluZyBvbiB3aGV0aGVyIHRoZSByZXF1ZXN0IHN1Y2NlZWRlZCBvciBub3QuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBodHRwUmVxdWVzdAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIEhUVFAgUHJvcGVydGllcwogICAqICAgQHJldHVybiBbQVdTLkh0dHBSZXF1ZXN0XSB0aGUgcmF3IEhUVFAgcmVxdWVzdCBvYmplY3QKICAgKiAgICAgY29udGFpbmluZyByZXF1ZXN0IGhlYWRlcnMgYW5kIGJvZHkgaW5mb3JtYXRpb24KICAgKiAgICAgc2VudCBieSB0aGUgc2VydmljZS4KICAgKgogICAqIEAhYXR0cmlidXRlIHN0YXJ0VGltZQogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtEYXRlXSB0aGUgdGltZSB0aGF0IHRoZSByZXF1ZXN0IHN0YXJ0ZWQKICAgKgogICAqIEAhZ3JvdXAgUmVxdWVzdCBCdWlsZGluZyBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgdmFsaWRhdGUocmVxdWVzdCkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGEgcmVxdWVzdCBpcyBiZWluZyB2YWxpZGF0ZWQuIExpc3RlbmVycwogICAqICAgc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIHRoZSByZXF1ZXN0IHNob3VsZCBub3QgYmUgc2VudC4KICAgKiAgIEBwYXJhbSByZXF1ZXN0IFtSZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgYmVpbmcgc2VudAogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUwogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT04KICAgKiAgIEBleGFtcGxlIEVuc3VyaW5nIHRoYXQgYSBjZXJ0YWluIHBhcmFtZXRlciBpcyBzZXQgYmVmb3JlIHNlbmRpbmcgYSByZXF1ZXN0CiAgICogICAgIHZhciByZXEgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgKiAgICAgcmVxLm9uKCd2YWxpZGF0ZScsIGZ1bmN0aW9uKCkgewogICAqICAgICAgIGlmICghcmVxLnBhcmFtcy5Cb2R5Lm1hdGNoKC9eSGVsbG9ccy8pKSB7CiAgICogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JvZHkgbXVzdCBzdGFydCB3aXRoICJIZWxsbyAiJyk7CiAgICogICAgICAgfQogICAqICAgICB9KTsKICAgKiAgICAgcmVxLnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IC4uLiB9KTsKICAgKgogICAqIEAhZXZlbnQgYnVpbGQocmVxdWVzdCkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IHBheWxvYWQgaXMgYmVpbmcgYnVpbHQuIExpc3RlbmVycwogICAqICAgc2hvdWxkIGZpbGwgdGhlIG5lY2Vzc2FyeSBpbmZvcm1hdGlvbiB0byBzZW5kIHRoZSByZXF1ZXN0CiAgICogICBvdmVyIEhUVFAuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH52YWxpZGF0ZSkKICAgKiAgIEBleGFtcGxlIEFkZCBhIGN1c3RvbSBIVFRQIGhlYWRlciB0byBhIHJlcXVlc3QKICAgKiAgICAgdmFyIHJlcSA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogICAqICAgICByZXEub24oJ2J1aWxkJywgZnVuY3Rpb24oKSB7CiAgICogICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0N1c3RvbS1IZWFkZXInXSA9ICd2YWx1ZSc7CiAgICogICAgIH0pOwogICAqICAgICByZXEuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogICAqCiAgICogQCFldmVudCBzaWduKHJlcXVlc3QpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyBiZWluZyBzaWduZWQuIExpc3RlbmVycyBzaG91bGQKICAgKiAgIGFkZCB0aGUgY29ycmVjdCBhdXRoZW50aWNhdGlvbiBoZWFkZXJzIGFuZC9vciBhZGp1c3QgdGhlIGJvZHksCiAgICogICBkZXBlbmRpbmcgb24gdGhlIGF1dGhlbnRpY2F0aW9uIG1lY2hhbmlzbSBiZWluZyB1c2VkLgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+dmFsaWRhdGUpCiAgICoKICAgKiBAIWdyb3VwIFJlcXVlc3QgU2VuZGluZyBFdmVudHMKICAgKgogICAqIEAhZXZlbnQgc2VuZChyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGlzIHJlYWR5IHRvIGJlIHNlbnQuIExpc3RlbmVycwogICAqICAgc2hvdWxkIGNhbGwgdGhlIHVuZGVybHlpbmcgdHJhbnNwb3J0IGxheWVyIHRvIGluaXRpYXRlCiAgICogICB0aGUgc2VuZGluZyBvZiB0aGUgcmVxdWVzdC4KICAgKiAgIEBwYXJhbSByZXNwb25zZSBbUmVzcG9uc2VdIHRoZSByZXNwb25zZSBvYmplY3QKICAgKiAgIEBjb250ZXh0IFtSZXF1ZXN0XSB0aGUgcmVxdWVzdCBvYmplY3QgdGhhdCB3YXMgc2VudAogICAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5ECiAgICoKICAgKiBAIWV2ZW50IHJldHJ5KHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gYSByZXF1ZXN0IGZhaWxlZCBhbmQgbWlnaHQgbmVlZCB0byBiZSByZXRyaWVkIG9yIHJlZGlyZWN0ZWQuCiAgICogICBJZiB0aGUgcmVzcG9uc2UgaXMgcmV0cnlhYmxlLCB0aGUgbGlzdGVuZXIgc2hvdWxkIHNldCB0aGUKICAgKiAgIGByZXNwb25zZS5lcnJvci5yZXRyeWFibGVgIHByb3BlcnR5IHRvIGB0cnVlYCwgYW5kIG9wdGlvbmFsbHkgc2V0CiAgICogICBgcmVzcG9uc2UuZXJyb3IucmV0cnlEZWxheWAgdG8gdGhlIG1pbGxpc2Vjb25kIGRlbGF5IGZvciB0aGUgbmV4dCBhdHRlbXB0LgogICAqICAgSW4gdGhlIGNhc2Ugb2YgYSByZWRpcmVjdCwgYHJlc3BvbnNlLmVycm9yLnJlZGlyZWN0YCBzaG91bGQgYmUgc2V0IHRvCiAgICogICBgdHJ1ZWAgd2l0aCBgcmV0cnlEZWxheWAgc2V0IHRvIGFuIG9wdGlvbmFsIGRlbGF5IG9uIHRoZSBuZXh0IHJlcXVlc3QuCiAgICoKICAgKiAgIElmIGEgbGlzdGVuZXIgZGVjaWRlcyB0aGF0IGEgcmVxdWVzdCBzaG91bGQgbm90IGJlIHJldHJpZWQsCiAgICogICBpdCBzaG91bGQgc2V0IGJvdGggYHJldHJ5YWJsZWAgYW5kIGByZWRpcmVjdGAgdG8gZmFsc2UuCiAgICoKICAgKiAgIE5vdGUgdGhhdCBhIHJldHJ5YWJsZSBlcnJvciB3aWxsIGJlIHJldHJpZWQgYXQgbW9zdAogICAqICAge0FXUy5Db25maWcubWF4UmV0cmllc30gdGltZXMgKGJhc2VkIG9uIHRoZSBzZXJ2aWNlIG9iamVjdCdzIGNvbmZpZykuCiAgICogICBTaW1pbGFybHksIGEgcmVxdWVzdCB0aGF0IGlzIHJlZGlyZWN0ZWQgd2lsbCBvbmx5IHJlZGlyZWN0IGF0IG1vc3QKICAgKiAgIHtBV1MuQ29uZmlnLm1heFJlZGlyZWN0c30gdGltZXMuCiAgICoKICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAZXhhbXBsZSBBZGRpbmcgYSBjdXN0b20gcmV0cnkgZm9yIGEgNDA0IHJlc3BvbnNlCiAgICogICAgIHJlcXVlc3Qub24oJ3JldHJ5JywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgKiAgICAgICAvLyB0aGlzIHJlc291cmNlIGlzIG5vdCB5ZXQgYXZhaWxhYmxlLCB3YWl0IDEwIHNlY29uZHMgdG8gZ2V0IGl0IGFnYWluCiAgICogICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID09PSA0MDQgJiYgcmVzcG9uc2UuZXJyb3IpIHsKICAgKiAgICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7ICAgLy8gcmV0cnkgdGhpcyBlcnJvcgogICAqICAgICAgICAgcmVzcG9uc2UuZXJyb3IucmV0cnlEZWxheSA9IDEwMDAwOyAvLyB3YWl0IDEwIHNlY29uZHMKICAgKiAgICAgICB9CiAgICogICAgIH0pOwogICAqCiAgICogQCFncm91cCBEYXRhIFBhcnNpbmcgRXZlbnRzCiAgICoKICAgKiBAIWV2ZW50IGV4dHJhY3RFcnJvcihyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCBvbiBhbGwgbm9uLTJ4eCByZXF1ZXN0cyBzbyB0aGF0IGxpc3RlbmVycyBjYW4gZXh0cmFjdAogICAqICAgZXJyb3IgZGV0YWlscyBmcm9tIHRoZSByZXNwb25zZSBib2R5LiBMaXN0ZW5lcnMgdG8gdGhpcyBldmVudAogICAqICAgc2hvdWxkIHNldCB0aGUgYHJlc3BvbnNlLmVycm9yYCBwcm9wZXJ0eS4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGV4dHJhY3REYXRhKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIGluIHN1Y2Nlc3NmdWwgcmVxdWVzdHMgdG8gYWxsb3cgbGlzdGVuZXJzIHRvCiAgICogICBkZS1zZXJpYWxpemUgdGhlIHJlc3BvbnNlIGJvZHkgaW50byBgcmVzcG9uc2UuZGF0YWAuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFncm91cCBDb21wbGV0aW9uIEV2ZW50cwogICAqCiAgICogQCFldmVudCBzdWNjZXNzKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgY29tcGxldGVkIHN1Y2Nlc3NmdWxseS4KICAgKiAgIGByZXNwb25zZS5kYXRhYCB3aWxsIGNvbnRhaW4gdGhlIHJlc3BvbnNlIGRhdGEgYW5kCiAgICogICBgcmVzcG9uc2UuZXJyb3JgIHdpbGwgYmUgbnVsbC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGVycm9yKGVycm9yLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGFuIGVycm9yIG9jY3VycyBhdCBhbnkgcG9pbnQgZHVyaW5nIHRoZQogICAqICAgcmVxdWVzdC4gYHJlc3BvbnNlLmVycm9yYCB3aWxsIGNvbnRhaW4gZGV0YWlscyBhYm91dCB0aGUgZXJyb3IKICAgKiAgIHRoYXQgb2NjdXJyZWQuIGByZXNwb25zZS5kYXRhYCB3aWxsIGJlIG51bGwuCiAgICogICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dAogICAqICAgICB0aGUgZXJyb3IgdGhhdCBvY2N1cnJlZC4KICAgKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAgICoKICAgKiBAIWV2ZW50IGNvbXBsZXRlKHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW5ldmVyIGEgcmVxdWVzdCBjeWNsZSBjb21wbGV0ZXMuIGByZXNwb25zZS5lcnJvcmAKICAgKiAgIHNob3VsZCBiZSBjaGVja2VkLCBzaW5jZSB0aGUgcmVxdWVzdCBtYXkgaGF2ZSBmYWlsZWQuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFncm91cCBIVFRQIEV2ZW50cwogICAqCiAgICogQCFldmVudCBodHRwSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwb25zZSwgc3RhdHVzTWVzc2FnZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIGhlYWRlcnMgYXJlIHNlbnQgYnkgdGhlIHJlbW90ZSBzZXJ2ZXIKICAgKiAgIEBwYXJhbSBzdGF0dXNDb2RlIFtJbnRlZ2VyXSB0aGUgSFRUUCByZXNwb25zZSBjb2RlCiAgICogICBAcGFyYW0gaGVhZGVycyBbbWFwPFN0cmluZyxTdHJpbmc+XSB0aGUgcmVzcG9uc2UgaGVhZGVycwogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBwYXJhbSBzdGF0dXNNZXNzYWdlIFtTdHJpbmddIEEgc3RhdHVzIG1lc3NhZ2UgY29ycmVzcG9uZGluZyB0byB0aGUgSFRUUAogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgY29kZQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBodHRwRGF0YShjaHVuaywgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiBkYXRhIGlzIHNlbnQgYnkgdGhlIHJlbW90ZSBzZXJ2ZXIKICAgKiAgIEBwYXJhbSBjaHVuayBbQnVmZmVyXSB0aGUgYnVmZmVyIGRhdGEgY29udGFpbmluZyB0aGUgbmV4dCBkYXRhIGNodW5rCiAgICogICAgIGZyb20gdGhlIHNlcnZlcgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBzZWUgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9EQVRBCiAgICoKICAgKiBAIWV2ZW50IGh0dHBVcGxvYWRQcm9ncmVzcyhwcm9ncmVzcywgcmVzcG9uc2UpCiAgICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGhhcyB1cGxvYWRlZCBtb3JlIGRhdGEKICAgKiAgIEBwYXJhbSBwcm9ncmVzcyBbbWFwXSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgYGxvYWRlZGAgYW5kIGB0b3RhbGAgYnl0ZXMKICAgKiAgICAgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQG5vdGUgVGhpcyBldmVudCB3aWxsIG5vdCBiZSBlbWl0dGVkIGluIE5vZGUuanMgMC44LnguCiAgICoKICAgKiBAIWV2ZW50IGh0dHBEb3dubG9hZFByb2dyZXNzKHByb2dyZXNzLCByZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgaGFzIGRvd25sb2FkZWQgbW9yZSBkYXRhCiAgICogICBAcGFyYW0gcHJvZ3Jlc3MgW21hcF0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGBsb2FkZWRgIGFuZCBgdG90YWxgIGJ5dGVzCiAgICogICAgIG9mIHRoZSByZXF1ZXN0LgogICAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICAgKiAgIEBub3RlIFRoaXMgZXZlbnQgd2lsbCBub3QgYmUgZW1pdHRlZCBpbiBOb2RlLmpzIDAuOC54LgogICAqCiAgICogQCFldmVudCBodHRwRXJyb3IoZXJyb3IsIHJlc3BvbnNlKQogICAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBmYWlsZWQKICAgKiAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgdGhhdCB3YXMgdGhyb3duCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQCFldmVudCBodHRwRG9uZShyZXNwb25zZSkKICAgKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBzZXJ2ZXIgaXMgZmluaXNoZWQgc2VuZGluZyBkYXRhCiAgICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogICAqCiAgICogQHNlZSBBV1MuUmVzcG9uc2UKICAgKi8KICBBV1MuUmVxdWVzdCA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgcmVxdWVzdCBmb3IgYW4gb3BlcmF0aW9uIG9uIGEgZ2l2ZW4gc2VydmljZSB3aXRoCiAgICAgKiBhIHNldCBvZiBpbnB1dCBwYXJhbWV0ZXJzLgogICAgICoKICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtBV1MuU2VydmljZV0gdGhlIHNlcnZpY2UgdG8gcGVyZm9ybSB0aGUgb3BlcmF0aW9uIG9uCiAgICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBvcGVyYXRpb24gdG8gcGVyZm9ybSBvbiB0aGUgc2VydmljZQogICAgICogQHBhcmFtIHBhcmFtcyBbT2JqZWN0XSBwYXJhbWV0ZXJzIHRvIHNlbmQgdG8gdGhlIG9wZXJhdGlvbi4KICAgICAqICAgU2VlIHRoZSBvcGVyYXRpb24ncyBkb2N1bWVudGF0aW9uIGZvciB0aGUgZm9ybWF0IG9mIHRoZQogICAgICogICBwYXJhbWV0ZXJzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gUmVxdWVzdChzZXJ2aWNlLCBvcGVyYXRpb24sIHBhcmFtcykgewogICAgICB2YXIgZW5kcG9pbnQgPSBzZXJ2aWNlLmVuZHBvaW50OwogICAgICB2YXIgcmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogICAgICB2YXIgY3VzdG9tVXNlckFnZW50ID0gc2VydmljZS5jb25maWcuY3VzdG9tVXNlckFnZW50OwogIAogICAgICAvLyBnbG9iYWwgZW5kcG9pbnRzIHNpZ24gYXMgdXMtZWFzdC0xCiAgICAgIGlmIChzZXJ2aWNlLmlzR2xvYmFsRW5kcG9pbnQpIHJlZ2lvbiA9ICd1cy1lYXN0LTEnOwogIAogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiAmJiBkb21haW4uYWN0aXZlOwogICAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlOwogICAgICB0aGlzLm9wZXJhdGlvbiA9IG9wZXJhdGlvbjsKICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICAgIHRoaXMuaHR0cFJlcXVlc3QgPSBuZXcgQVdTLkh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pOwogICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KGN1c3RvbVVzZXJBZ2VudCk7CiAgICAgIHRoaXMuc3RhcnRUaW1lID0gc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpOwogIAogICAgICB0aGlzLnJlc3BvbnNlID0gbmV3IEFXUy5SZXNwb25zZSh0aGlzKTsKICAgICAgdGhpcy5fYXNtID0gbmV3IEFjY2VwdG9yU3RhdGVNYWNoaW5lKGZzbS5zdGF0ZXMsICd2YWxpZGF0ZScpOwogICAgICB0aGlzLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gZmFsc2U7CiAgCiAgICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzKTsKICAgICAgdGhpcy5lbWl0ID0gdGhpcy5lbWl0RXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIWdyb3VwIFNlbmRpbmcgYSBSZXF1ZXN0CiAgICAgKi8KICAKICAgIC8qKgogICAgICogQG92ZXJsb2FkIHNlbmQoY2FsbGJhY2sgPSBudWxsKQogICAgICogICBTZW5kcyB0aGUgcmVxdWVzdCBvYmplY3QuCiAgICAgKgogICAgICogICBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgICBmcm9tIHRoZSBzZXJ2aWNlLgogICAgICogICAgIEBjb250ZXh0IFtBV1MuUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGJlaW5nIHNlbnQuCiAgICAgKiAgICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgICAqICAgICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgICAqICAgICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGggYSBjYWxsYmFjawogICAgICogICAgIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgICAqICAgICByZXF1ZXN0LnNlbmQoZnVuY3Rpb24oZXJyLCBkYXRhKSB7IGNvbnNvbGUubG9nKGVyciwgZGF0YSk7IH0pOwogICAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRoIG5vIGNhbGxiYWNrICh1c2luZyBldmVudCBoYW5kbGVycykKICAgICAqICAgICByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICAgKiAgICAgcmVxdWVzdC5vbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwb25zZSkgeyAuLi4gfSk7IC8vIHJlZ2lzdGVyIGEgY2FsbGJhY2sKICAgICAqICAgICByZXF1ZXN0LnNlbmQoKTsKICAgICAqLwogICAgc2VuZDogZnVuY3Rpb24gc2VuZChjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAvLyBhcHBlbmQgdG8gdXNlciBhZ2VudAogICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ2NhbGxiYWNrJyk7CiAgICAgICAgdGhpcy5vbignY29tcGxldGUnLCBmdW5jdGlvbiAocmVzcCkgewogICAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwLCByZXNwLmVycm9yLCByZXNwLmRhdGEpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHRoaXMucnVuVG8oKTsKICAKICAgICAgcmV0dXJuIHRoaXMucmVzcG9uc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAIW1ldGhvZCAgcHJvbWlzZSgpCiAgICAgKiAgIFNlbmRzIHRoZSByZXF1ZXN0IGFuZCByZXR1cm5zIGEgJ3RoZW5hYmxlJyBwcm9taXNlLgogICAgICoKICAgICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICAgKiAgIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oZGF0YSkKICAgICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLgogICAgICogICAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IpCiAgICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAgICogICAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIHJlcXVlc3QuCiAgICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHVzaW5nIHByb21pc2VzLgogICAgICogICAgIHZhciByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICAgKiAgICAgdmFyIHJlc3VsdCA9IHJlcXVlc3QucHJvbWlzZSgpOwogICAgICogICAgIHJlc3VsdC50aGVuKGZ1bmN0aW9uKGRhdGEpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycm9yKSB7IC4uLiB9KTsKICAgICAqLwogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYnVpbGQ6IGZ1bmN0aW9uIGJ1aWxkKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLnJ1blRvKCdzZW5kJywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHJ1blRvOiBmdW5jdGlvbiBydW5UbyhzdGF0ZSwgZG9uZSkgewogICAgICB0aGlzLl9hc20ucnVuVG8oc3RhdGUsIGRvbmUsIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEFib3J0cyBhIHJlcXVlc3QsIGVtaXR0aW5nIHRoZSBlcnJvciBhbmQgY29tcGxldGUgZXZlbnRzLgogICAgICoKICAgICAqIEAhbWFjcm8gbm9icm93c2VyCiAgICAgKiBAZXhhbXBsZSBBYm9ydGluZyBhIHJlcXVlc3QgYWZ0ZXIgc2VuZGluZwogICAgICogICB2YXIgcGFyYW1zID0gewogICAgICogICAgIEJ1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleScsCiAgICAgKiAgICAgQm9keTogQnVmZmVyLmFsbG9jKDEwMjQgKiAxMDI0ICogNSkgLy8gNU1CIHBheWxvYWQKICAgICAqICAgfTsKICAgICAqICAgdmFyIHJlcXVlc3QgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICAgICAqICAgcmVxdWVzdC5zZW5kKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAqICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZygiRXJyb3I6IiwgZXJyLmNvZGUsIGVyci5tZXNzYWdlKTsKICAgICAqICAgICBlbHNlIGNvbnNvbGUubG9nKGRhdGEpOwogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIGFib3J0IHJlcXVlc3QgaW4gMSBzZWNvbmQKICAgICAqICAgc2V0VGltZW91dChyZXF1ZXN0LmFib3J0LmJpbmQocmVxdWVzdCksIDEwMDApOwogICAgICoKICAgICAqICAgLy8gcHJpbnRzICJFcnJvcjogUmVxdWVzdEFib3J0ZWRFcnJvciBSZXF1ZXN0IGFib3J0ZWQgYnkgdXNlciIKICAgICAqIEByZXR1cm4gW0FXUy5SZXF1ZXN0XSB0aGUgc2FtZSByZXF1ZXN0IG9iamVjdCwgZm9yIGNoYWluaW5nLgogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBhYm9ydDogZnVuY3Rpb24gYWJvcnQoKSB7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCd2YWxpZGF0ZVJlc3BvbnNlJyk7CiAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdleHRyYWN0RXJyb3InKTsKICAgICAgdGhpcy5vbigndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uIGFkZEFib3J0ZWRFcnJvcihyZXNwKSB7CiAgICAgICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignUmVxdWVzdCBhYm9ydGVkIGJ5IHVzZXInKSwgewogICAgICAgICAgIGNvZGU6ICdSZXF1ZXN0QWJvcnRlZEVycm9yJywgcmV0cnlhYmxlOiBmYWxzZQogICAgICAgIH0pOwogICAgICB9KTsKICAKICAgICAgaWYgKHRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtICYmICF0aGlzLmh0dHBSZXF1ZXN0LnN0cmVhbS5kaWRDYWxsYmFjaykgeyAvLyBhYm9ydCBIVFRQIHN0cmVhbQogICAgICAgIHRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtLmFib3J0KCk7CiAgICAgICAgaWYgKHRoaXMuaHR0cFJlcXVlc3QuX2Fib3J0Q2FsbGJhY2spIHsKICAgICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0Ll9hYm9ydENhbGxiYWNrKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdzZW5kJyk7IC8vIGhhdmVuJ3Qgc2VudCB5ZXQsIHNvIGxldCdzIG5vdAogICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIG92ZXIgZWFjaCBwYWdlIG9mIHJlc3VsdHMgZ2l2ZW4gYSBwYWdlYWJsZSByZXF1ZXN0LCBjYWxsaW5nCiAgICAgKiB0aGUgcHJvdmlkZWQgY2FsbGJhY2sgd2l0aCBlYWNoIHBhZ2Ugb2YgZGF0YS4gQWZ0ZXIgYWxsIHBhZ2VzIGhhdmUgYmVlbgogICAgICogcmV0cmlldmVkLCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggYG51bGxgIGRhdGEuCiAgICAgKgogICAgICogQG5vdGUgVGhpcyBvcGVyYXRpb24gY2FuIGdlbmVyYXRlIG11bHRpcGxlIHJlcXVlc3RzIHRvIGEgc2VydmljZS4KICAgICAqIEBleGFtcGxlIEl0ZXJhdGluZyBvdmVyIG11bHRpcGxlIHBhZ2VzIG9mIG9iamVjdHMgaW4gYW4gUzMgYnVja2V0CiAgICAgKiAgIHZhciBwYWdlcyA9IDE7CiAgICAgKiAgIHMzLmxpc3RPYmplY3RzKCkuZWFjaFBhZ2UoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgKiAgICAgaWYgKGVycikgcmV0dXJuOwogICAgICogICAgIGNvbnNvbGUubG9nKCJQYWdlIiwgcGFnZXMrKyk7CiAgICAgKiAgICAgY29uc29sZS5sb2coZGF0YSk7CiAgICAgKiAgIH0pOwogICAgICogQGV4YW1wbGUgSXRlcmF0aW5nIG92ZXIgbXVsdGlwbGUgcGFnZXMgd2l0aCBhbiBhc3luY2hyb25vdXMgY2FsbGJhY2sKICAgICAqICAgczMubGlzdE9iamVjdHMocGFyYW1zKS5lYWNoUGFnZShmdW5jdGlvbihlcnIsIGRhdGEsIGRvbmUpIHsKICAgICAqICAgICBkb1NvbWV0aGluZ0FzeW5jQW5kT3JFeHBlbnNpdmUoZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAvLyBUaGUgbmV4dCBwYWdlIG9mIHJlc3VsdHMgaXNuJ3QgZmV0Y2hlZCB1bnRpbCBkb25lIGlzIGNhbGxlZAogICAgICogICAgICAgZG9uZSgpOwogICAgICogICAgIH0pOwogICAgICogICB9KTsKICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEsIFtkb25lQ2FsbGJhY2tdKQogICAgICogICBDYWxsZWQgd2l0aCBlYWNoIHBhZ2Ugb2YgcmVzdWx0aW5nIGRhdGEgZnJvbSB0aGUgcmVxdWVzdC4gSWYgdGhlCiAgICAgKiAgIG9wdGlvbmFsIGBkb25lQ2FsbGJhY2tgIGlzIHByb3ZpZGVkIGluIHRoZSBmdW5jdGlvbiwgaXQgbXVzdCBiZSBjYWxsZWQKICAgICAqICAgd2hlbiB0aGUgY2FsbGJhY2sgaXMgY29tcGxldGUuCiAgICAgKgogICAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gYW4gZXJyb3Igb2JqZWN0LCBpZiBhbiBlcnJvciBvY2N1cnJlZC4KICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gYSBzaW5nbGUgcGFnZSBvZiByZXNwb25zZSBkYXRhLiBJZiB0aGVyZSBpcyBubwogICAgICogICAgIG1vcmUgZGF0YSwgdGhpcyBvYmplY3Qgd2lsbCBiZSBgbnVsbGAuCiAgICAgKiAgIEBwYXJhbSBkb25lQ2FsbGJhY2sgW0Z1bmN0aW9uXSBhbiBvcHRpb25hbCBkb25lIGNhbGxiYWNrLiBJZiB0aGlzCiAgICAgKiAgICAgYXJndW1lbnQgaXMgZGVmaW5lZCBpbiB0aGUgZnVuY3Rpb24gZGVjbGFyYXRpb24sIGl0IHNob3VsZCBiZSBjYWxsZWQKICAgICAqICAgICB3aGVuIHRoZSBuZXh0IHBhZ2UgaXMgcmVhZHkgdG8gYmUgcmV0cmlldmVkLiBUaGlzIGlzIHVzZWZ1bCBmb3IKICAgICAqICAgICBjb250cm9sbGluZyBzZXJpYWwgcGFnaW5hdGlvbiBhY3Jvc3MgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMuCiAgICAgKiAgIEByZXR1cm4gW0Jvb2xlYW5dIGlmIHRoZSBjYWxsYmFjayByZXR1cm5zIGBmYWxzZWAsIHBhZ2luYXRpb24gd2lsbAogICAgICogICAgIHN0b3AuCiAgICAgKgogICAgICogQHNlZSBBV1MuUmVxdWVzdC5lYWNoSXRlbQogICAgICogQHNlZSBBV1MuUmVzcG9uc2UubmV4dFBhZ2UKICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgZWFjaFBhZ2U6IGZ1bmN0aW9uIGVhY2hQYWdlKGNhbGxiYWNrKSB7CiAgICAgIC8vIE1ha2UgYWxsIGNhbGxiYWNrcyBhc3luYy1pc2gKICAgICAgY2FsbGJhY2sgPSBBV1MudXRpbC5mbi5tYWtlQXN5bmMoY2FsbGJhY2ssIDMpOwogIAogICAgICBmdW5jdGlvbiB3cmFwcGVkQ2FsbGJhY2socmVzcG9uc2UpIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3BvbnNlLCByZXNwb25zZS5lcnJvciwgcmVzcG9uc2UuZGF0YSwgZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHJldHVybjsKICAKICAgICAgICAgIGlmIChyZXNwb25zZS5oYXNOZXh0UGFnZSgpKSB7CiAgICAgICAgICAgIHJlc3BvbnNlLm5leHRQYWdlKCkub24oJ2NvbXBsZXRlJywgd3JhcHBlZENhbGxiYWNrKS5zZW5kKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjYWxsYmFjay5jYWxsKHJlc3BvbnNlLCBudWxsLCBudWxsLCBBV1MudXRpbC5mbi5ub29wKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLm9uKCdjb21wbGV0ZScsIHdyYXBwZWRDYWxsYmFjaykuc2VuZCgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogRW51bWVyYXRlcyBvdmVyIGluZGl2aWR1YWwgaXRlbXMgb2YgYSByZXF1ZXN0LCBwYWdpbmcgdGhlIHJlc3BvbnNlcyBpZgogICAgICogbmVjZXNzYXJ5LgogICAgICoKICAgICAqIEBhcGkgZXhwZXJpbWVudGFsCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGVhY2hJdGVtOiBmdW5jdGlvbiBlYWNoSXRlbShjYWxsYmFjaykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGZ1bmN0aW9uIHdyYXBwZWRDYWxsYmFjayhlcnIsIGRhdGEpIHsKICAgICAgICBpZiAoZXJyKSByZXR1cm4gY2FsbGJhY2soZXJyLCBudWxsKTsKICAgICAgICBpZiAoZGF0YSA9PT0gbnVsbCkgcmV0dXJuIGNhbGxiYWNrKG51bGwsIG51bGwpOwogIAogICAgICAgIHZhciBjb25maWcgPSBzZWxmLnNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyhzZWxmLm9wZXJhdGlvbik7CiAgICAgICAgdmFyIHJlc3VsdEtleSA9IGNvbmZpZy5yZXN1bHRLZXk7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0S2V5KSkgcmVzdWx0S2V5ID0gcmVzdWx0S2V5WzBdOwogICAgICAgIHZhciBpdGVtcyA9IGptZXNwYXRoLnNlYXJjaChkYXRhLCByZXN1bHRLZXkpOwogICAgICAgIHZhciBjb250aW51ZUl0ZXJhdGlvbiA9IHRydWU7CiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKGl0ZW1zLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICBjb250aW51ZUl0ZXJhdGlvbiA9IGNhbGxiYWNrKG51bGwsIGl0ZW0pOwogICAgICAgICAgaWYgKGNvbnRpbnVlSXRlcmF0aW9uID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gQVdTLnV0aWwuYWJvcnQ7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNvbnRpbnVlSXRlcmF0aW9uOwogICAgICB9CiAgCiAgICAgIHRoaXMuZWFjaFBhZ2Uod3JhcHBlZENhbGxiYWNrKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIG9wZXJhdGlvbiBjYW4gcmV0dXJuIG11bHRpcGxlIHBhZ2VzIG9mCiAgICAgKiAgIHJlc3BvbnNlIGRhdGEuCiAgICAgKiBAc2VlIEFXUy5SZXNwb25zZS5lYWNoUGFnZQogICAgICogQHNpbmNlIHYxLjQuMAogICAgICovCiAgICBpc1BhZ2VhYmxlOiBmdW5jdGlvbiBpc1BhZ2VhYmxlKCkgewogICAgICByZXR1cm4gdGhpcy5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcodGhpcy5vcGVyYXRpb24pID8gdHJ1ZSA6IGZhbHNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogU2VuZHMgdGhlIHJlcXVlc3QgYW5kIGNvbnZlcnRzIHRoZSByZXF1ZXN0IG9iamVjdCBpbnRvIGEgcmVhZGFibGUgc3RyZWFtCiAgICAgKiB0aGF0IGNhbiBiZSByZWFkIGZyb20gb3IgcGlwZWQgaW50byBhIHdyaXRhYmxlIHN0cmVhbS4KICAgICAqCiAgICAgKiBAbm90ZSBUaGUgZGF0YSByZWFkIGZyb20gYSByZWFkYWJsZSBzdHJlYW0gY29udGFpbnMgb25seQogICAgICogICB0aGUgcmF3IEhUVFAgYm9keSBjb250ZW50cy4KICAgICAqIEBleGFtcGxlIE1hbnVhbGx5IHJlYWRpbmcgZnJvbSBhIHN0cmVhbQogICAgICogICByZXF1ZXN0LmNyZWF0ZVJlYWRTdHJlYW0oKS5vbignZGF0YScsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAqICAgICBjb25zb2xlLmxvZygiR290IGRhdGE6IiwgZGF0YS50b1N0cmluZygpKTsKICAgICAqICAgfSk7CiAgICAgKiBAZXhhbXBsZSBQaXBpbmcgYSByZXF1ZXN0IGJvZHkgaW50byBhIGZpbGUKICAgICAqICAgdmFyIG91dCA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKCcvcGF0aC90by9vdXRmaWxlLmpwZycpOwogICAgICogICBzMy5zZXJ2aWNlLmdldE9iamVjdChwYXJhbXMpLmNyZWF0ZVJlYWRTdHJlYW0oKS5waXBlKG91dCk7CiAgICAgKiBAcmV0dXJuIFtTdHJlYW1dIHRoZSByZWFkYWJsZSBzdHJlYW0gb2JqZWN0IHRoYXQgY2FuIGJlIHBpcGVkCiAgICAgKiAgIG9yIHJlYWQgZnJvbSAoYnkgcmVnaXN0ZXJpbmcgJ2RhdGEnIGV2ZW50IGxpc3RlbmVycykuCiAgICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAgICovCiAgICBjcmVhdGVSZWFkU3RyZWFtOiBmdW5jdGlvbiBjcmVhdGVSZWFkU3RyZWFtKCkgewogICAgICB2YXIgc3RyZWFtcyA9IEFXUy51dGlsLnN0cmVhbTsKICAgICAgdmFyIHJlcSA9IHRoaXM7CiAgICAgIHZhciBzdHJlYW0gPSBudWxsOwogIAogICAgICBpZiAoQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIpIHsKICAgICAgICBzdHJlYW0gPSBuZXcgc3RyZWFtcy5QYXNzVGhyb3VnaCgpOwogICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7IHJlcS5zZW5kKCk7IH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHN0cmVhbSA9IG5ldyBzdHJlYW1zLlN0cmVhbSgpOwogICAgICAgIHN0cmVhbS5yZWFkYWJsZSA9IHRydWU7CiAgCiAgICAgICAgc3RyZWFtLnNlbnQgPSBmYWxzZTsKICAgICAgICBzdHJlYW0ub24oJ25ld0xpc3RlbmVyJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGlmICghc3RyZWFtLnNlbnQgJiYgZXZlbnQgPT09ICdkYXRhJykgewogICAgICAgICAgICBzdHJlYW0uc2VudCA9IHRydWU7CiAgICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7IHJlcS5zZW5kKCk7IH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHRoaXMub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24gc3RyZWFtSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCByZXNwKSB7CiAgICAgICAgaWYgKHN0YXR1c0NvZGUgPCAzMDApIHsKICAgICAgICAgIHJlcS5yZW1vdmVMaXN0ZW5lcignaHR0cERhdGEnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEEpOwogICAgICAgICAgcmVxLnJlbW92ZUxpc3RlbmVyKCdodHRwRXJyb3InLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0VSUk9SKTsKICAgICAgICAgIHJlcS5vbignaHR0cEVycm9yJywgZnVuY3Rpb24gc3RyZWFtSHR0cEVycm9yKGVycm9yKSB7CiAgICAgICAgICAgIHJlc3AuZXJyb3IgPSBlcnJvcjsKICAgICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSBmYWxzZTsKICAgICAgICAgIH0pOwogIAogICAgICAgICAgdmFyIHNob3VsZENoZWNrQ29udGVudExlbmd0aCA9IGZhbHNlOwogICAgICAgICAgdmFyIGV4cGVjdGVkTGVuOwogICAgICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5tZXRob2QgIT09ICdIRUFEJykgewogICAgICAgICAgICBleHBlY3RlZExlbiA9IHBhcnNlSW50KGhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ10sIDEwKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHBlY3RlZExlbiAhPT0gdW5kZWZpbmVkICYmICFpc05hTihleHBlY3RlZExlbikgJiYgZXhwZWN0ZWRMZW4gPj0gMCkgewogICAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSB0cnVlOwogICAgICAgICAgICB2YXIgcmVjZWl2ZWRMZW4gPSAwOwogICAgICAgICAgfQogIAogICAgICAgICAgdmFyIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQgPSBmdW5jdGlvbiBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KCkgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoICYmIHJlY2VpdmVkTGVuICE9PSBleHBlY3RlZExlbikgewogICAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIEFXUy51dGlsLmVycm9yKAogICAgICAgICAgICAgICAgbmV3IEVycm9yKCdTdHJlYW0gY29udGVudCBsZW5ndGggbWlzbWF0Y2guIFJlY2VpdmVkICcgKwogICAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArICcgb2YgJyArIGV4cGVjdGVkTGVuICsgJyBieXRlcy4nKSwKICAgICAgICAgICAgICAgIHsgY29kZTogJ1N0cmVhbUNvbnRlbnRMZW5ndGhNaXNtYXRjaCcgfQogICAgICAgICAgICAgICkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgICAgICAgc3RyZWFtLmVuZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAKICAgICAgICAgIHZhciBodHRwU3RyZWFtID0gcmVzcC5odHRwUmVzcG9uc2UuY3JlYXRlVW5idWZmZXJlZFN0cmVhbSgpOwogIAogICAgICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbGVuZ3RoQWNjdW11bGF0b3IgPSBuZXcgc3RyZWFtcy5QYXNzVGhyb3VnaCgpOwogICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLl93cml0ZSA9IGZ1bmN0aW9uKGNodW5rKSB7CiAgICAgICAgICAgICAgICBpZiAoY2h1bmsgJiYgY2h1bmsubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICs9IGNodW5rLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBzdHJlYW1zLlBhc3NUaHJvdWdoLnByb3RvdHlwZS5fd3JpdGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICB9OwogIAogICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLm9uKCdlbmQnLCBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KTsKICAgICAgICAgICAgICBzdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgICAgICAgIGh0dHBTdHJlYW0udW5waXBlKGxlbmd0aEFjY3VtdWxhdG9yKTsKICAgICAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLmVtaXQoJ2VuZCcpOwogICAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuZW5kKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaHR0cFN0cmVhbS5waXBlKGxlbmd0aEFjY3VtdWxhdG9yKS5waXBlKHN0cmVhbSwgeyBlbmQ6IGZhbHNlIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGh0dHBTdHJlYW0ucGlwZShzdHJlYW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogIAogICAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoKSB7CiAgICAgICAgICAgICAgaHR0cFN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgICAgaWYgKGFyZyAmJiBhcmcubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIHJlY2VpdmVkTGVuICs9IGFyZy5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgaHR0cFN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdkYXRhJywgYXJnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2VuZCcsIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQpOwogICAgICAgICAgfQogIAogICAgICAgICAgaHR0cFN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gZmFsc2U7CiAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gc3RyZWFtOwogICAgfSwKICAKICAgIC8qKgogICAgICogQHBhcmFtIFtBcnJheSxSZXNwb25zZV0gYXJncyBUaGlzIHNob3VsZCBiZSB0aGUgcmVzcG9uc2Ugb2JqZWN0LAogICAgICogICBvciBhbiBhcnJheSBvZiBhcmdzIHRvIHNlbmQgdG8gdGhlIGV2ZW50LgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGVtaXRFdmVudDogZnVuY3Rpb24gZW1pdChldmVudE5hbWUsIGFyZ3MsIGRvbmUpIHsKICAgICAgaWYgKHR5cGVvZiBhcmdzID09PSAnZnVuY3Rpb24nKSB7IGRvbmUgPSBhcmdzOyBhcmdzID0gbnVsbDsgfQogICAgICBpZiAoIWRvbmUpIGRvbmUgPSBmdW5jdGlvbigpIHsgfTsKICAgICAgaWYgKCFhcmdzKSBhcmdzID0gdGhpcy5ldmVudFBhcmFtZXRlcnMoZXZlbnROYW1lLCB0aGlzLnJlc3BvbnNlKTsKICAKICAgICAgdmFyIG9yaWdFbWl0ID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUuZW1pdDsKICAgICAgb3JpZ0VtaXQuY2FsbCh0aGlzLCBldmVudE5hbWUsIGFyZ3MsIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICBpZiAoZXJyKSB0aGlzLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgIGRvbmUuY2FsbCh0aGlzLCBlcnIpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBldmVudFBhcmFtZXRlcnM6IGZ1bmN0aW9uIGV2ZW50UGFyYW1ldGVycyhldmVudE5hbWUpIHsKICAgICAgc3dpdGNoIChldmVudE5hbWUpIHsKICAgICAgICBjYXNlICdyZXN0YXJ0JzoKICAgICAgICBjYXNlICd2YWxpZGF0ZSc6CiAgICAgICAgY2FzZSAnc2lnbic6CiAgICAgICAgY2FzZSAnYnVpbGQnOgogICAgICAgIGNhc2UgJ2FmdGVyVmFsaWRhdGUnOgogICAgICAgIGNhc2UgJ2FmdGVyQnVpbGQnOgogICAgICAgICAgcmV0dXJuIFt0aGlzXTsKICAgICAgICBjYXNlICdlcnJvcic6CiAgICAgICAgICByZXR1cm4gW3RoaXMucmVzcG9uc2UuZXJyb3IsIHRoaXMucmVzcG9uc2VdOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gW3RoaXMucmVzcG9uc2VdOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcHJlc2lnbjogZnVuY3Rpb24gcHJlc2lnbihleHBpcmVzLCBjYWxsYmFjaykgewogICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBleHBpcmVzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBleHBpcmVzOwogICAgICAgIGV4cGlyZXMgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgQVdTLlNpZ25lcnMuUHJlc2lnbigpLnNpZ24odGhpcy50b0dldCgpLCBleHBpcmVzLCBjYWxsYmFjayk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNQcmVzaWduZWQ6IGZ1bmN0aW9uIGlzUHJlc2lnbmVkKCkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuaHR0cFJlcXVlc3QuaGVhZGVycywgJ3ByZXNpZ25lZC1leHBpcmVzJyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdG9VbmF1dGhlbnRpY2F0ZWQ6IGZ1bmN0aW9uIHRvVW5hdXRoZW50aWNhdGVkKCkgewogICAgICB0aGlzLl91bkF1dGhlbnRpY2F0ZWQgPSB0cnVlOwogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTKTsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignc2lnbicsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNJR04pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0b0dldDogZnVuY3Rpb24gdG9HZXQoKSB7CiAgICAgIGlmICh0aGlzLnNlcnZpY2UuYXBpLnByb3RvY29sID09PSAncXVlcnknIHx8CiAgICAgICAgICB0aGlzLnNlcnZpY2UuYXBpLnByb3RvY29sID09PSAnZWMyJykgewogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ2J1aWxkJywgdGhpcy5idWlsZEFzR2V0KTsKICAgICAgICB0aGlzLmFkZExpc3RlbmVyKCdidWlsZCcsIHRoaXMuYnVpbGRBc0dldCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYnVpbGRBc0dldDogZnVuY3Rpb24gYnVpbGRBc0dldChyZXF1ZXN0KSB7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QubWV0aG9kID0gJ0dFVCc7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QucGF0aCA9IHJlcXVlc3Quc2VydmljZS5lbmRwb2ludC5wYXRoICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJz8nICsgcmVxdWVzdC5odHRwUmVxdWVzdC5ib2R5OwogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmJvZHkgPSAnJzsKICAKICAgICAgLy8gZG9uJ3QgbmVlZCB0aGVzZSBoZWFkZXJzIG9uIGEgR0VUIHJlcXVlc3QKICAgICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXTsKICAgICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGFsdEhhbmRsZXJzT25FcnJvcjogZnVuY3Rpb24gaGFsdEhhbmRsZXJzT25FcnJvcigpIHsKICAgICAgdGhpcy5faGFsdEhhbmRsZXJzT25FcnJvciA9IHRydWU7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlcXVlc3QuYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgICB0aGlzLnByb3RvdHlwZS5wcm9taXNlID0gZnVuY3Rpb24gcHJvbWlzZSgpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAvLyBhcHBlbmQgdG8gdXNlciBhZ2VudAogICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdwcm9taXNlJyk7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZURlcGVuZGVuY3koZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgc2VsZi5vbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgICBpZiAocmVzcC5lcnJvcikgewogICAgICAgICAgICByZWplY3QocmVzcC5lcnJvcik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBkZWZpbmUgJHJlc3BvbnNlIHByb3BlcnR5IHNvIHRoYXQgaXQgaXMgbm90IGVudW1iZXJhYmxlCiAgICAgICAgICAgIC8vIHRoaXMgcHJldmVudHMgY2lyY3VsYXIgcmVmZXJlbmNlIGVycm9ycyB3aGVuIHN0cmluZ2lmeWluZyB0aGUgSlNPTiBvYmplY3QKICAgICAgICAgICAgcmVzb2x2ZShPYmplY3QuZGVmaW5lUHJvcGVydHkoCiAgICAgICAgICAgICAgcmVzcC5kYXRhIHx8IHt9LAogICAgICAgICAgICAgICckcmVzcG9uc2UnLAogICAgICAgICAgICAgIHt2YWx1ZTogcmVzcH0KICAgICAgICAgICAgKSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgc2VsZi5ydW5UbygpOwogICAgICB9KTsKICAgIH07CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuUmVxdWVzdC5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogICAgZGVsZXRlIHRoaXMucHJvdG90eXBlLnByb21pc2U7CiAgfTsKICAKICBBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuUmVxdWVzdCk7CiAgCiAgQVdTLnV0aWwubWl4aW4oQVdTLlJlcXVlc3QsIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IpOwogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi9jb3JlIjoxOCwiLi9zdGF0ZV9tYWNoaW5lIjo3MCwiX3Byb2Nlc3MiOjg2LCJqbWVzcGF0aCI6ODV9XSw1NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogQ29weXJpZ2h0IDIwMTItMjAxMyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogICAqCiAgICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlICJMaWNlbnNlIikuIFlvdQogICAqIG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YKICAgKiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0CiAgICoKICAgKiAgICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FwYWNoZTIuMC8KICAgKgogICAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMKICAgKiBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRgogICAqIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYwogICAqIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAgICovCiAgCiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwogIHZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKICB2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIENIRUNLX0FDQ0VQVE9SUyhyZXNwKSB7CiAgICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgICB2YXIgYWNjZXB0b3JzID0gd2FpdGVyLmNvbmZpZy5hY2NlcHRvcnM7CiAgICB2YXIgYWNjZXB0b3JNYXRjaGVkID0gZmFsc2U7CiAgICB2YXIgc3RhdGUgPSAncmV0cnknOwogIAogICAgYWNjZXB0b3JzLmZvckVhY2goZnVuY3Rpb24oYWNjZXB0b3IpIHsKICAgICAgaWYgKCFhY2NlcHRvck1hdGNoZWQpIHsKICAgICAgICB2YXIgbWF0Y2hlciA9IHdhaXRlci5tYXRjaGVyc1thY2NlcHRvci5tYXRjaGVyXTsKICAgICAgICBpZiAobWF0Y2hlciAmJiBtYXRjaGVyKHJlc3AsIGFjY2VwdG9yLmV4cGVjdGVkLCBhY2NlcHRvci5hcmd1bWVudCkpIHsKICAgICAgICAgIGFjY2VwdG9yTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICBzdGF0ZSA9IGFjY2VwdG9yLnN0YXRlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCAmJiByZXNwLmVycm9yKSBzdGF0ZSA9ICdmYWlsdXJlJzsKICAKICAgIGlmIChzdGF0ZSA9PT0gJ3N1Y2Nlc3MnKSB7CiAgICAgIHdhaXRlci5zZXRTdWNjZXNzKHJlc3ApOwogICAgfSBlbHNlIHsKICAgICAgd2FpdGVyLnNldEVycm9yKHJlc3AsIHN0YXRlID09PSAncmV0cnknKTsKICAgIH0KICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlJlc291cmNlV2FpdGVyID0gaW5oZXJpdCh7CiAgICAvKioKICAgICAqIFdhaXRzIGZvciBhIGdpdmVuIHN0YXRlIG9uIGEgc2VydmljZSBvYmplY3QKICAgICAqIEBwYXJhbSBzZXJ2aWNlIFtTZXJ2aWNlXSB0aGUgc2VydmljZSBvYmplY3QgdG8gd2FpdCBvbgogICAgICogQHBhcmFtIHN0YXRlIFtTdHJpbmddIHRoZSBzdGF0ZSAoZGVmaW5lZCBpbiB3YWl0ZXIgY29uZmlndXJhdGlvbikgdG8gd2FpdAogICAgICogICBmb3IuCiAgICAgKiBAZXhhbXBsZSBDcmVhdGUgYSB3YWl0ZXIgZm9yIHJ1bm5pbmcgRUMyIGluc3RhbmNlcwogICAgICogICB2YXIgZWMyID0gbmV3IEFXUy5FQzI7CiAgICAgKiAgIHZhciB3YWl0ZXIgPSBuZXcgQVdTLlJlc291cmNlV2FpdGVyKGVjMiwgJ2luc3RhbmNlUnVubmluZycpOwogICAgICovCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gY29uc3RydWN0b3Ioc2VydmljZSwgc3RhdGUpIHsKICAgICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlOwogICAgICB0aGlzLmxvYWRXYWl0ZXJDb25maWcodGhpcy5zdGF0ZSk7CiAgICB9LAogIAogICAgc2VydmljZTogbnVsbCwKICAKICAgIHN0YXRlOiBudWxsLAogIAogICAgY29uZmlnOiBudWxsLAogIAogICAgbWF0Y2hlcnM6IHsKICAgICAgcGF0aDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHQgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiBqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0LGV4cGVjdGVkKTsKICAgICAgfSwKICAKICAgICAgcGF0aEFsbDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAKICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVzdWx0cykpIHJlc3VsdHMgPSBbcmVzdWx0c107CiAgICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgICBpZiAoIW51bVJlc3VsdHMpIHJldHVybiBmYWxzZTsKICAgICAgICBmb3IgKHZhciBpbmQgPSAwIDsgaW5kIDwgbnVtUmVzdWx0czsgaW5kKyspIHsKICAgICAgICAgIGlmICgham1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCiAgCiAgICAgIHBhdGhBbnk6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgcmVzdWx0cyA9IGptZXNwYXRoLnNlYXJjaChyZXNwLmRhdGEsIGFyZ3VtZW50KTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdHMpKSByZXN1bHRzID0gW3Jlc3VsdHNdOwogICAgICAgIHZhciBudW1SZXN1bHRzID0gcmVzdWx0cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaW5kID0gMCA7IGluZCA8IG51bVJlc3VsdHM7IGluZCsrKSB7CiAgICAgICAgICBpZiAoam1lc3BhdGguc3RyaWN0RGVlcEVxdWFsKHJlc3VsdHNbaW5kXSwgZXhwZWN0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgCiAgICAgIHN0YXR1czogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQpIHsKICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgcmV0dXJuICh0eXBlb2Ygc3RhdHVzQ29kZSA9PT0gJ251bWJlcicpICYmIChzdGF0dXNDb2RlID09PSBleHBlY3RlZCk7CiAgICAgIH0sCiAgCiAgICAgIGVycm9yOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICAgIGlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdzdHJpbmcnICYmIHJlc3AuZXJyb3IpIHsKICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gcmVzcC5lcnJvci5jb2RlOwogICAgICAgIH0KICAgICAgICAvLyBpZiBleHBlY3RlZCBpcyBub3Qgc3RyaW5nLCBjYW4gYmUgYm9vbGVhbiBpbmRpY2F0aW5nIHByZXNlbmNlIG9mIGVycm9yCiAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSAhIXJlc3AuZXJyb3I7CiAgICAgIH0KICAgIH0sCiAgCiAgICBsaXN0ZW5lcnM6IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICAgIGFkZCgnUkVUUllfQ0hFQ0snLCAncmV0cnknLCBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIHdhaXRlciA9IHJlc3AucmVxdWVzdC5fd2FpdGVyOwogICAgICAgIGlmIChyZXNwLmVycm9yICYmIHJlc3AuZXJyb3IuY29kZSA9PT0gJ1Jlc291cmNlTm90UmVhZHknKSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5RGVsYXkgPSAod2FpdGVyLmNvbmZpZy5kZWxheSB8fCAwKSAqIDEwMDA7CiAgICAgICAgfQogICAgICB9KTsKICAKICAgICAgYWRkKCdDSEVDS19PVVRQVVQnLCAnZXh0cmFjdERhdGEnLCBDSEVDS19BQ0NFUFRPUlMpOwogIAogICAgICBhZGQoJ0NIRUNLX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIENIRUNLX0FDQ0VQVE9SUyk7CiAgICB9KSwKICAKICAgIC8qKgogICAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdCiAgICAgKi8KICAgIHdhaXQ6IGZ1bmN0aW9uIHdhaXQocGFyYW1zLCBjYWxsYmFjaykgewogICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGNhbGxiYWNrID0gcGFyYW1zOyBwYXJhbXMgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuJHdhaXRlcikgewogICAgICAgIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocGFyYW1zKTsKICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLmRlbGF5ID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhpcy5jb25maWcuZGVsYXkgPSBwYXJhbXMuJHdhaXRlci5kZWxheTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0cyA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHRoaXMuY29uZmlnLm1heEF0dGVtcHRzID0gcGFyYW1zLiR3YWl0ZXIubWF4QXR0ZW1wdHM7CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSBwYXJhbXMuJHdhaXRlcjsKICAgICAgfQogIAogICAgICB2YXIgcmVxdWVzdCA9IHRoaXMuc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLmNvbmZpZy5vcGVyYXRpb24sIHBhcmFtcyk7CiAgICAgIHJlcXVlc3QuX3dhaXRlciA9IHRoaXM7CiAgICAgIHJlcXVlc3QucmVzcG9uc2UubWF4UmV0cmllcyA9IHRoaXMuY29uZmlnLm1heEF0dGVtcHRzOwogICAgICByZXF1ZXN0LmFkZExpc3RlbmVycyh0aGlzLmxpc3RlbmVycyk7CiAgCiAgICAgIGlmIChjYWxsYmFjaykgcmVxdWVzdC5zZW5kKGNhbGxiYWNrKTsKICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICB9LAogIAogICAgc2V0U3VjY2VzczogZnVuY3Rpb24gc2V0U3VjY2VzcyhyZXNwKSB7CiAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICByZXNwLmRhdGEgPSByZXNwLmRhdGEgfHwge307CiAgICAgIHJlc3AucmVxdWVzdC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4dHJhY3REYXRhJyk7CiAgICB9LAogIAogICAgc2V0RXJyb3I6IGZ1bmN0aW9uIHNldEVycm9yKHJlc3AsIHJldHJ5YWJsZSkgewogICAgICByZXNwLmRhdGEgPSBudWxsOwogICAgICByZXNwLmVycm9yID0gQVdTLnV0aWwuZXJyb3IocmVzcC5lcnJvciB8fCBuZXcgRXJyb3IoKSwgewogICAgICAgIGNvZGU6ICdSZXNvdXJjZU5vdFJlYWR5JywKICAgICAgICBtZXNzYWdlOiAnUmVzb3VyY2UgaXMgbm90IGluIHRoZSBzdGF0ZSAnICsgdGhpcy5zdGF0ZSwKICAgICAgICByZXRyeWFibGU6IHJldHJ5YWJsZQogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIExvYWRzIHdhaXRlciBjb25maWd1cmF0aW9uIGZyb20gQVBJIGNvbmZpZ3VyYXRpb24KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbG9hZFdhaXRlckNvbmZpZzogZnVuY3Rpb24gbG9hZFdhaXRlckNvbmZpZyhzdGF0ZSkgewogICAgICBpZiAoIXRoaXMuc2VydmljZS5hcGkud2FpdGVyc1tzdGF0ZV0pIHsKICAgICAgICB0aHJvdyBuZXcgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdTdGF0ZU5vdEZvdW5kRXJyb3InLAogICAgICAgICAgbWVzc2FnZTogJ1N0YXRlICcgKyBzdGF0ZSArICcgbm90IGZvdW5kLicKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICB0aGlzLmNvbmZpZyA9IEFXUy51dGlsLmNvcHkodGhpcy5zZXJ2aWNlLmFwaS53YWl0ZXJzW3N0YXRlXSk7CiAgICB9CiAgfSk7CiAgCiAgfSx7Ii4vY29yZSI6MTgsImptZXNwYXRoIjo4NX1dLDU3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBqbWVzcGF0aCA9IHJlcXVpcmUoJ2ptZXNwYXRoJyk7CiAgCiAgLyoqCiAgICogVGhpcyBjbGFzcyBlbmNhcHN1bGF0ZXMgdGhlIHJlc3BvbnNlIGluZm9ybWF0aW9uCiAgICogZnJvbSBhIHNlcnZpY2UgcmVxdWVzdCBvcGVyYXRpb24gc2VudCB0aHJvdWdoIHtBV1MuUmVxdWVzdH0uCiAgICogVGhlIHJlc3BvbnNlIG9iamVjdCBoYXMgdHdvIG1haW4gcHJvcGVydGllcyBmb3IgZ2V0dGluZyBpbmZvcm1hdGlvbgogICAqIGJhY2sgZnJvbSBhIHJlcXVlc3Q6CiAgICoKICAgKiAjIyBUaGUgYGRhdGFgIHByb3BlcnR5CiAgICoKICAgKiBUaGUgYHJlc3BvbnNlLmRhdGFgIHByb3BlcnR5IGNvbnRhaW5zIHRoZSBzZXJpYWxpemVkIG9iamVjdCBkYXRhCiAgICogcmV0cmlldmVkIGZyb20gdGhlIHNlcnZpY2UgcmVxdWVzdC4gRm9yIGluc3RhbmNlLCBmb3IgYW4KICAgKiBBbWF6b24gRHluYW1vREIgYGxpc3RUYWJsZXNgIG1ldGhvZCBjYWxsLCB0aGUgcmVzcG9uc2UgZGF0YSBtaWdodAogICAqIGxvb2sgbGlrZToKICAgKgogICAqIGBgYAogICAqID4gcmVzcC5kYXRhCiAgICogeyBUYWJsZU5hbWVzOgogICAqICAgIFsgJ3RhYmxlMScsICd0YWJsZTInLCAuLi4gXSB9CiAgICogYGBgCiAgICoKICAgKiBUaGUgYGRhdGFgIHByb3BlcnR5IGNhbiBiZSBudWxsIGlmIGFuIGVycm9yIG9jY3VycyAoc2VlIGJlbG93KS4KICAgKgogICAqICMjIFRoZSBgZXJyb3JgIHByb3BlcnR5CiAgICoKICAgKiBJbiB0aGUgZXZlbnQgb2YgYSBzZXJ2aWNlIGVycm9yIChvciB0cmFuc2ZlciBlcnJvciksIHRoZQogICAqIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkgd2lsbCBiZSBmaWxsZWQgd2l0aCB0aGUgZ2l2ZW4KICAgKiBlcnJvciBkYXRhIGluIHRoZSBmb3JtOgogICAqCiAgICogYGBgCiAgICogeyBjb2RlOiAnU0hPUlRfVU5JUVVFX0VSUk9SX0NPREUnLAogICAqICAgbWVzc2FnZTogJ1NvbWUgaHVtYW4gcmVhZGFibGUgZXJyb3IgbWVzc2FnZScgfQogICAqIGBgYAogICAqCiAgICogSW4gdGhlIGNhc2Ugb2YgYW4gZXJyb3IsIHRoZSBgZGF0YWAgcHJvcGVydHkgd2lsbCBiZSBgbnVsbGAuCiAgICogTm90ZSB0aGF0IGlmIHlvdSBoYW5kbGUgZXZlbnRzIHRoYXQgY2FuIGJlIGluIGEgZmFpbHVyZSBzdGF0ZSwKICAgKiB5b3Ugc2hvdWxkIGFsd2F5cyBjaGVjayB3aGV0aGVyIGByZXNwb25zZS5lcnJvcmAgaXMgc2V0CiAgICogYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIHRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBkYXRhCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAbm90ZSBJbnNpZGUgb2YgYSB7QVdTLlJlcXVlc3R+aHR0cERhdGF9IGV2ZW50LCB0aGlzCiAgICogICAgIHByb3BlcnR5IGNvbnRhaW5zIGEgc2luZ2xlIHJhdyBwYWNrZXQgaW5zdGVhZCBvZiB0aGUKICAgKiAgICAgZnVsbCBkZS1zZXJpYWxpemVkIHNlcnZpY2UgcmVzcG9uc2UuCiAgICogICBAcmV0dXJuIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIHJlc3BvbnNlIGRhdGEKICAgKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICAgKgogICAqIEAhYXR0cmlidXRlIGVycm9yCiAgICogICBBbiBzdHJ1Y3R1cmUgY29udGFpbmluZyBpbmZvcm1hdGlvbiBhYm91dCBhIHNlcnZpY2UKICAgKiAgIG9yIG5ldHdvcmtpbmcgZXJyb3IuCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAgICogICBAbm90ZSBUaGlzIGF0dHJpYnV0ZSBpcyBvbmx5IGZpbGxlZCBpZiBhIHNlcnZpY2Ugb3IKICAgKiAgICAgbmV0d29ya2luZyBlcnJvciBvY2N1cnMuCiAgICogICBAcmV0dXJuIFtFcnJvcl0KICAgKiAgICAgKiBjb2RlIFtTdHJpbmddIGEgdW5pcXVlIHNob3J0IGNvZGUgcmVwcmVzZW50aW5nIHRoZQogICAqICAgICAgIGVycm9yIHRoYXQgd2FzIGVtaXR0ZWQuCiAgICogICAgICogbWVzc2FnZSBbU3RyaW5nXSBhIGxvbmdlciBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlCiAgICogICAgICogcmV0cnlhYmxlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBlcnJvciBtZXNzYWdlIGlzCiAgICogICAgICAgcmV0cnlhYmxlLgogICAqICAgICAqIHN0YXR1c0NvZGUgW051bWVyaWNdIGluIHRoZSBjYXNlIG9mIGEgcmVxdWVzdCB0aGF0IHJlYWNoZWQgdGhlIHNlcnZpY2UsCiAgICogICAgICAgdGhpcyB2YWx1ZSBjb250YWlucyB0aGUgcmVzcG9uc2Ugc3RhdHVzIGNvZGUuCiAgICogICAgICogdGltZSBbRGF0ZV0gdGhlIGRhdGUgdGltZSBvYmplY3Qgd2hlbiB0aGUgZXJyb3Igb2NjdXJyZWQuCiAgICogICAgICogaG9zdG5hbWUgW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICAgKiAgICAgICBpZGVudGlmeSB0aGUgZW5kcG9pbnQgb2YgdGhlIHJlcXVlc3QuCiAgICogICAgICogcmVnaW9uIFtTdHJpbmddIHNldCB3aGVuIGEgbmV0d29ya2luZyBlcnJvciBvY2N1cnMgdG8gZWFzaWx5CiAgICogICAgICAgaWRlbnRpZnkgdGhlIHJlZ2lvbiBvZiB0aGUgcmVxdWVzdC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlcXVlc3RJZAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogICAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgdW5pcXVlIHJlcXVlc3QgSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSByZXNwb25zZS4KICAgKiAgICAgTG9nIHRoaXMgdmFsdWUgd2hlbiBkZWJ1Z2dpbmcgcmVxdWVzdHMgZm9yIEFXUyBzdXBwb3J0LgogICAqCiAgICogQCFhdHRyaWJ1dGUgcmV0cnlDb3VudAogICAqICAgQHJlYWRvbmx5CiAgICogICBAIWdyb3VwIE9wZXJhdGlvbiBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJldHJpZXMgdGhhdCB3ZXJlCiAgICogICAgIGF0dGVtcHRlZCBiZWZvcmUgdGhlIHJlcXVlc3Qgd2FzIGNvbXBsZXRlZC4KICAgKgogICAqIEAhYXR0cmlidXRlIHJlZGlyZWN0Q291bnQKICAgKiAgIEByZWFkb25seQogICAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogICAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG51bWJlciBvZiByZWRpcmVjdHMgdGhhdCB3ZXJlCiAgICogICAgIGZvbGxvd2VkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogICAqCiAgICogQCFhdHRyaWJ1dGUgaHR0cFJlc3BvbnNlCiAgICogICBAcmVhZG9ubHkKICAgKiAgIEAhZ3JvdXAgSFRUUCBQcm9wZXJ0aWVzCiAgICogICBAcmV0dXJuIFtBV1MuSHR0cFJlc3BvbnNlXSB0aGUgcmF3IEhUVFAgcmVzcG9uc2Ugb2JqZWN0CiAgICogICAgIGNvbnRhaW5pbmcgdGhlIHJlc3BvbnNlIGhlYWRlcnMgYW5kIGJvZHkgaW5mb3JtYXRpb24KICAgKiAgICAgZnJvbSB0aGUgc2VydmVyLgogICAqCiAgICogQHNlZSBBV1MuUmVxdWVzdAogICAqLwogIEFXUy5SZXNwb25zZSA9IGluaGVyaXQoewogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFJlc3BvbnNlKHJlcXVlc3QpIHsKICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgdGhpcy5lcnJvciA9IG51bGw7CiAgICAgIHRoaXMucmV0cnlDb3VudCA9IDA7CiAgICAgIHRoaXMucmVkaXJlY3RDb3VudCA9IDA7CiAgICAgIHRoaXMuaHR0cFJlc3BvbnNlID0gbmV3IEFXUy5IdHRwUmVzcG9uc2UoKTsKICAgICAgaWYgKHJlcXVlc3QpIHsKICAgICAgICB0aGlzLm1heFJldHJpZXMgPSByZXF1ZXN0LnNlcnZpY2UubnVtUmV0cmllcygpOwogICAgICAgIHRoaXMubWF4UmVkaXJlY3RzID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5tYXhSZWRpcmVjdHM7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgcmVxdWVzdCBmb3IgdGhlIG5leHQgcGFnZSBvZiByZXNwb25zZSBkYXRhLCBjYWxsaW5nIHRoZQogICAgICogY2FsbGJhY2sgd2l0aCB0aGUgcGFnZSBkYXRhIGlmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQuCiAgICAgKgogICAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgICAqICAgQ2FsbGVkIHdoZW4gYSBwYWdlIG9mIGRhdGEgaXMgcmV0dXJuZWQgZnJvbSB0aGUgbmV4dCByZXF1ZXN0LgogICAgICoKICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQgaW4gdGhlIHJlcXVlc3QKICAgICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIG5leHQgcGFnZSBvZiBkYXRhLCBvciBudWxsLCBpZiB0aGVyZSBhcmUgbm8KICAgICAqICAgICBtb3JlIHBhZ2VzIGxlZnQuCiAgICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIGRhdGEKICAgICAqIEByZXR1cm4gW251bGxdIGlmIG5vIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGFuZCB0aGVyZSBhcmUgbm8gcGFnZXMgbGVmdAogICAgICogICB0byByZXRyaWV2ZS4KICAgICAqIEBzaW5jZSB2MS40LjAKICAgICAqLwogICAgbmV4dFBhZ2U6IGZ1bmN0aW9uIG5leHRQYWdlKGNhbGxiYWNrKSB7CiAgICAgIHZhciBjb25maWc7CiAgICAgIHZhciBzZXJ2aWNlID0gdGhpcy5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgIHZhciBvcGVyYXRpb24gPSB0aGlzLnJlcXVlc3Qub3BlcmF0aW9uOwogICAgICB0cnkgewogICAgICAgIGNvbmZpZyA9IHNlcnZpY2UucGFnaW5hdGlvbkNvbmZpZyhvcGVyYXRpb24sIHRydWUpOwogICAgICB9IGNhdGNoIChlKSB7IHRoaXMuZXJyb3IgPSBlOyB9CiAgCiAgICAgIGlmICghdGhpcy5oYXNOZXh0UGFnZSgpKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayh0aGlzLmVycm9yLCBudWxsKTsKICAgICAgICBlbHNlIGlmICh0aGlzLmVycm9yKSB0aHJvdyB0aGlzLmVycm9yOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgCiAgICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHRoaXMucmVxdWVzdC5wYXJhbXMpOwogICAgICBpZiAoIXRoaXMubmV4dFBhZ2VUb2tlbnMpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2sgPyBjYWxsYmFjayhudWxsLCBudWxsKSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGlucHV0VG9rZW5zID0gY29uZmlnLmlucHV0VG9rZW47CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dFRva2VucyA9PT0gJ3N0cmluZycpIGlucHV0VG9rZW5zID0gW2lucHV0VG9rZW5zXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlucHV0VG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBwYXJhbXNbaW5wdXRUb2tlbnNbaV1dID0gdGhpcy5uZXh0UGFnZVRva2Vuc1tpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlcnZpY2UubWFrZVJlcXVlc3QodGhpcy5yZXF1ZXN0Lm9wZXJhdGlvbiwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgbW9yZSBwYWdlcyBvZiBkYXRhIGNhbiBiZSByZXR1cm5lZCBieSBmdXJ0aGVyCiAgICAgKiAgIHJlcXVlc3RzCiAgICAgKiBAc2luY2UgdjEuNC4wCiAgICAgKi8KICAgIGhhc05leHRQYWdlOiBmdW5jdGlvbiBoYXNOZXh0UGFnZSgpIHsKICAgICAgdGhpcy5jYWNoZU5leHRQYWdlVG9rZW5zKCk7CiAgICAgIGlmICh0aGlzLm5leHRQYWdlVG9rZW5zKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMubmV4dFBhZ2VUb2tlbnMgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgZWxzZSByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY2FjaGVOZXh0UGFnZVRva2VuczogZnVuY3Rpb24gY2FjaGVOZXh0UGFnZVRva2VucygpIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnbmV4dFBhZ2VUb2tlbnMnKSkgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSB1bmRlZmluZWQ7CiAgCiAgICAgIHZhciBjb25maWcgPSB0aGlzLnJlcXVlc3Quc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMucmVxdWVzdC5vcGVyYXRpb24pOwogICAgICBpZiAoIWNvbmZpZykgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgCiAgICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSBudWxsOwogICAgICBpZiAoY29uZmlnLm1vcmVSZXN1bHRzKSB7CiAgICAgICAgaWYgKCFqbWVzcGF0aC5zZWFyY2godGhpcy5kYXRhLCBjb25maWcubW9yZVJlc3VsdHMpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdmFyIGV4cHJzID0gY29uZmlnLm91dHB1dFRva2VuOwogICAgICBpZiAodHlwZW9mIGV4cHJzID09PSAnc3RyaW5nJykgZXhwcnMgPSBbZXhwcnNdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBleHBycywgZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICB2YXIgb3V0cHV0ID0gam1lc3BhdGguc2VhcmNoKHRoaXMuZGF0YSwgZXhwcik7CiAgICAgICAgaWYgKG91dHB1dCkgewogICAgICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHRoaXMubmV4dFBhZ2VUb2tlbnMgfHwgW107CiAgICAgICAgICB0aGlzLm5leHRQYWdlVG9rZW5zLnB1c2gob3V0cHV0KTsKICAgICAgICB9CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgIH0KICAKICB9KTsKICAKICB9LHsiLi9jb3JlIjoxOCwiam1lc3BhdGgiOjg1fV0sNTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAIW1ldGhvZCBvbihldmVudE5hbWUsIGNhbGxiYWNrKQogICAqICAgUmVnaXN0ZXJzIGFuIGV2ZW50IGxpc3RlbmVyIGNhbGxiYWNrIGZvciB0aGUgZXZlbnQgZ2l2ZW4gYnkgYGV2ZW50TmFtZWAuCiAgICogICBQYXJhbWV0ZXJzIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gZGVwZW5kIG9uIHRoZSBpbmRpdmlkdWFsIGV2ZW50CiAgICogICBiZWluZyB0cmlnZ2VyZWQuIFNlZSB0aGUgZXZlbnQgZG9jdW1lbnRhdGlvbiBmb3IgdGhvc2UgcGFyYW1ldGVycy4KICAgKgogICAqICAgQHBhcmFtIGV2ZW50TmFtZSBbU3RyaW5nXSB0aGUgZXZlbnQgbmFtZSB0byByZWdpc3RlciB0aGUgbGlzdGVuZXIgZm9yCiAgICogICBAcGFyYW0gY2FsbGJhY2sgW0Z1bmN0aW9uXSB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgZnVuY3Rpb24KICAgKiAgIEBwYXJhbSB0b0hlYWQgW0Jvb2xlYW5dIGF0dGFjaCB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgdG8gdGhlIGhlYWQgb2YgY2FsbGJhY2sgYXJyYXkgaWYgc2V0IHRvIHRydWUuCiAgICogICAgIERlZmF1bHQgdG8gYmUgZmFsc2UuCiAgICogICBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgc2FtZSBvYmplY3QgZm9yIGNoYWluaW5nCiAgICovCiAgQVdTLlNlcXVlbnRpYWxFeGVjdXRvciA9IEFXUy51dGlsLmluaGVyaXQoewogIAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNlcXVlbnRpYWxFeGVjdXRvcigpIHsKICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbGlzdGVuZXJzOiBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICAgIHJldHVybiB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA/IHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnNsaWNlKDApIDogW107CiAgICB9LAogIAogICAgb246IGZ1bmN0aW9uIG9uKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCkgewogICAgICBpZiAodGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0pIHsKICAgICAgICB0b0hlYWQgPwogICAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0udW5zaGlmdChsaXN0ZW5lcikgOgogICAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChsaXN0ZW5lcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0gPSBbbGlzdGVuZXJdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIG9uQXN5bmM6IGZ1bmN0aW9uIG9uQXN5bmMoZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKSB7CiAgICAgIGxpc3RlbmVyLl9pc0FzeW5jID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMub24oZXZlbnROYW1lLCBsaXN0ZW5lciwgdG9IZWFkKTsKICAgIH0sCiAgCiAgICByZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIoZXZlbnROYW1lLCBsaXN0ZW5lcikgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsKICAgICAgICB2YXIgcG9zaXRpb24gPSAtMTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lcikgewogICAgICAgICAgICBwb3NpdGlvbiA9IGk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwb3NpdGlvbiA+IC0xKSB7CiAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgcmVtb3ZlQWxsTGlzdGVuZXJzOiBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICAgIGlmIChldmVudE5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZW1pdDogZnVuY3Rpb24gZW1pdChldmVudE5hbWUsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKSB7CiAgICAgIGlmICghZG9uZUNhbGxiYWNrKSBkb25lQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHsgfTsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMubGlzdGVuZXJzKGV2ZW50TmFtZSk7CiAgICAgIHZhciBjb3VudCA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgIHRoaXMuY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKTsKICAgICAgcmV0dXJuIGNvdW50ID4gMDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjYWxsTGlzdGVuZXJzOiBmdW5jdGlvbiBjYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBwcmV2RXJyb3IpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgZXJyb3IgPSBwcmV2RXJyb3IgfHwgbnVsbDsKICAKICAgICAgZnVuY3Rpb24gY2FsbE5leHRMaXN0ZW5lcihlcnIpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICBlcnJvciA9IEFXUy51dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCBlcnIpOwogICAgICAgICAgaWYgKHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIGRvbmVDYWxsYmFjay5jYWxsKHNlbGYsIGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2VsZi5jYWxsTGlzdGVuZXJzKGxpc3RlbmVycywgYXJncywgZG9uZUNhbGxiYWNrLCBlcnJvcik7CiAgICAgIH0KICAKICAgICAgd2hpbGUgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGxpc3RlbmVyID0gbGlzdGVuZXJzLnNoaWZ0KCk7CiAgICAgICAgaWYgKGxpc3RlbmVyLl9pc0FzeW5jKSB7IC8vIGFzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoW2NhbGxOZXh0TGlzdGVuZXJdKSk7CiAgICAgICAgICByZXR1cm47IC8vIHN0b3AgaGVyZSwgY2FsbE5leHRMaXN0ZW5lciB3aWxsIGNvbnRpbnVlCiAgICAgICAgfSBlbHNlIHsgLy8gc3luY2hyb25vdXMgbGlzdGVuZXIKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXJyb3IgJiYgc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgICBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQWRkcyBvciBjb3BpZXMgYSBzZXQgb2YgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBsaXN0IG9mCiAgICAgKiBsaXN0ZW5lcnMgb3IgU2VxdWVudGlhbEV4ZWN1dG9yIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0gbGlzdGVuZXJzIFttYXA8U3RyaW5nLEFycmF5PEZ1bmN0aW9uPj4sIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3JdCiAgICAgKiAgIGEgbGlzdCBvZiBldmVudHMgYW5kIGNhbGxiYWNrcywgb3IgYW4gZXZlbnQgZW1pdHRlciBvYmplY3QKICAgICAqICAgY29udGFpbmluZyBsaXN0ZW5lcnMgdG8gYWRkIHRvIHRoaXMgZW1pdHRlciBvYmplY3QuCiAgICAgKiBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgZW1pdHRlciBvYmplY3QsIGZvciBjaGFpbmluZy4KICAgICAqIEBleGFtcGxlIEFkZGluZyBsaXN0ZW5lcnMgZnJvbSBhIG1hcCBvZiBsaXN0ZW5lcnMKICAgICAqICAgZW1pdHRlci5hZGRMaXN0ZW5lcnMoewogICAgICogICAgIGV2ZW50MTogW2Z1bmN0aW9uKCkgeyAuLi4gfSwgZnVuY3Rpb24oKSB7IC4uLiB9XSwKICAgICAqICAgICBldmVudDI6IFtmdW5jdGlvbigpIHsgLi4uIH1dCiAgICAgKiAgIH0pOwogICAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyIGhhcyBldmVudDEKICAgICAqICAgZW1pdHRlci5lbWl0KCdldmVudDInKTsgLy8gZW1pdHRlciBoYXMgZXZlbnQyCiAgICAgKiBAZXhhbXBsZSBBZGRpbmcgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBlbWl0dGVyIG9iamVjdAogICAgICogICB2YXIgZW1pdHRlcjEgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogICAgICogICBlbWl0dGVyMS5vbignZXZlbnQxJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgZW1pdHRlcjEub24oJ2V2ZW50MicsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICAgKiAgIHZhciBlbWl0dGVyMiA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CiAgICAgKiAgIGVtaXR0ZXIyLmFkZExpc3RlbmVycyhlbWl0dGVyMSk7CiAgICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQxCiAgICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQyCiAgICAgKi8KICAgIGFkZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTGlzdGVuZXJzKGxpc3RlbmVycykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgCiAgICAgIC8vIGV4dHJhY3QgbGlzdGVuZXJzIGlmIHBhcmFtZXRlciBpcyBhbiBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0CiAgICAgIGlmIChsaXN0ZW5lcnMuX2V2ZW50cykgbGlzdGVuZXJzID0gbGlzdGVuZXJzLl9ldmVudHM7CiAgCiAgICAgIEFXUy51dGlsLmVhY2gobGlzdGVuZXJzLCBmdW5jdGlvbihldmVudCwgY2FsbGJhY2tzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFja3MgPT09ICdmdW5jdGlvbicpIGNhbGxiYWNrcyA9IFtjYWxsYmFja3NdOwogICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChjYWxsYmFja3MsIGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICBzZWxmLm9uKGV2ZW50LCBjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gc2VsZjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIFJlZ2lzdGVycyBhbiBldmVudCB3aXRoIHtvbn0gYW5kIHNhdmVzIHRoZSBjYWxsYmFjayBoYW5kbGUgZnVuY3Rpb24KICAgICAqIGFzIGEgcHJvcGVydHkgb24gdGhlIGVtaXR0ZXIgb2JqZWN0IHVzaW5nIGEgZ2l2ZW4gYG5hbWVgLgogICAgICoKICAgICAqIEBwYXJhbSBuYW1lIFtTdHJpbmddIHRoZSBwcm9wZXJ0eSBuYW1lIHRvIHNldCBvbiB0aGlzIG9iamVjdCBjb250YWluaW5nCiAgICAgKiAgIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBoYW5kbGUgc28gdGhhdCB0aGUgbGlzdGVuZXIgY2FuIGJlIHJlbW92ZWQgaW4KICAgICAqICAgdGhlIGZ1dHVyZS4KICAgICAqIEBwYXJhbSAoc2VlIG9uKQogICAgICogQHJldHVybiAoc2VlIG9uKQogICAgICogQGV4YW1wbGUgQWRkaW5nIGEgbmFtZWQgbGlzdGVuZXIgREFUQV9DQUxMQkFDSwogICAgICogICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbigpIHsgZG9Tb21ldGhpbmcoKTsgfTsKICAgICAqICAgZW1pdHRlci5hZGROYW1lZExpc3RlbmVyKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBsaXN0ZW5lcik7CiAgICAgKgogICAgICogICAvLyB0aGUgZm9sbG93aW5nIHByaW50czogdHJ1ZQogICAgICogICBjb25zb2xlLmxvZyhlbWl0dGVyLkRBVEFfQ0FMTEJBQ0sgPT0gbGlzdGVuZXIpOwogICAgICovCiAgICBhZGROYW1lZExpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZExpc3RlbmVyKG5hbWUsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCkgewogICAgICB0aGlzW25hbWVdID0gY2FsbGJhY2s7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXIoZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkTmFtZWRBc3luY0xpc3RlbmVyOiBmdW5jdGlvbiBhZGROYW1lZEFzeW5jTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICAgIGNhbGxiYWNrLl9pc0FzeW5jID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpOwogICAgfSwKICAKICAgIC8qKgogICAgICogSGVscGVyIG1ldGhvZCB0byBhZGQgYSBzZXQgb2YgbmFtZWQgbGlzdGVuZXJzIHVzaW5nCiAgICAgKiB7YWRkTmFtZWRMaXN0ZW5lcn0uIFRoZSBjYWxsYmFjayBjb250YWlucyBhIHBhcmFtZXRlcgogICAgICogd2l0aCBhIGhhbmRsZSB0byB0aGUgYGFkZE5hbWVkTGlzdGVuZXJgIG1ldGhvZC4KICAgICAqCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oYWRkKQogICAgICogICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gaXMgY2FsbGVkIGltbWVkaWF0ZWx5IGluIG9yZGVyIHRvIHByb3ZpZGUKICAgICAqICAgdGhlIGBhZGRgIGZ1bmN0aW9uIHRvIHRoZSBibG9jay4gVGhpcyBzaW1wbGlmaWVzIHRoZSBhZGRpdGlvbiBvZgogICAgICogICBhIGxhcmdlIGdyb3VwIG9mIG5hbWVkIGxpc3RlbmVycy4KICAgICAqICAgQHBhcmFtIGFkZCBbRnVuY3Rpb25dIHRoZSB7YWRkTmFtZWRMaXN0ZW5lcn0gZnVuY3Rpb24gdG8gY2FsbAogICAgICogICAgIHdoZW4gcmVnaXN0ZXJpbmcgbGlzdGVuZXJzLgogICAgICogQGV4YW1wbGUgQWRkaW5nIGEgc2V0IG9mIG5hbWVkIGxpc3RlbmVycwogICAgICogICBlbWl0dGVyLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgICogICAgIGFkZCgnREFUQV9DQUxMQkFDSycsICdkYXRhJywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgICAqICAgICBhZGQoJ09USEVSJywgJ290aGVyRXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICAgIGFkZCgnTEFTVCcsICdsYXN0RXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAgICogICB9KTsKICAgICAqCiAgICAgKiAgIC8vIHRoZXNlIHByb3BlcnRpZXMgYXJlIG5vdyBzZXQ6CiAgICAgKiAgIGVtaXR0ZXIuREFUQV9DQUxMQkFDSzsKICAgICAqICAgZW1pdHRlci5PVEhFUjsKICAgICAqICAgZW1pdHRlci5MQVNUOwogICAgICovCiAgICBhZGROYW1lZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTmFtZWRMaXN0ZW5lcnMoY2FsbGJhY2spIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICBjYWxsYmFjaygKICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYuYWRkTmFtZWRMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgIH0sCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLmFkZE5hbWVkQXN5bmNMaXN0ZW5lci5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICoge29ufSBpcyB0aGUgcHJlZmVyZWQgbWV0aG9kLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmFkZExpc3RlbmVyID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUub247CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yOwogIAogIH0seyIuL2NvcmUiOjE4fV0sNTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2Vzcyl7KGZ1bmN0aW9uICgpewogIHZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKICB2YXIgQXBpID0gcmVxdWlyZSgnLi9tb2RlbC9hcGknKTsKICB2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi9yZWdpb25fY29uZmlnJyk7CiAgCiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIHZhciBjbGllbnRDb3VudCA9IDA7CiAgCiAgLyoqCiAgICogVGhlIHNlcnZpY2UgY2xhc3MgcmVwcmVzZW50aW5nIGFuIEFXUyBzZXJ2aWNlLgogICAqCiAgICogQGNsYXNzX2Fic3RyYWN0IFRoaXMgY2xhc3MgaXMgYW4gYWJzdHJhY3QgY2xhc3MuCiAgICoKICAgKiBAIWF0dHJpYnV0ZSBhcGlWZXJzaW9ucwogICAqICAgQHJldHVybiBbQXJyYXk8U3RyaW5nPl0gdGhlIGxpc3Qgb2YgQVBJIHZlcnNpb25zIHN1cHBvcnRlZCBieSB0aGlzIHNlcnZpY2UuCiAgICogICBAcmVhZG9ubHkKICAgKi8KICBBV1MuU2VydmljZSA9IGluaGVyaXQoewogICAgLyoqCiAgICAgKiBDcmVhdGUgYSBuZXcgc2VydmljZSBvYmplY3Qgd2l0aCBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgKgogICAgICogQHBhcmFtIGNvbmZpZyBbbWFwXSBhIG1hcCBvZiBjb25maWd1cmF0aW9uIG9wdGlvbnMKICAgICAqLwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFNlcnZpY2UoY29uZmlnKSB7CiAgICAgIGlmICghdGhpcy5sb2FkU2VydmljZUNsYXNzKSB7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAnU2VydmljZSBtdXN0IGJlIGNvbnN0cnVjdGVkIHdpdGggYG5ld1wnIG9wZXJhdG9yJyk7CiAgICAgIH0KICAgICAgdmFyIFNlcnZpY2VDbGFzcyA9IHRoaXMubG9hZFNlcnZpY2VDbGFzcyhjb25maWcgfHwge30pOwogICAgICBpZiAoU2VydmljZUNsYXNzKSB7CiAgICAgICAgdmFyIG9yaWdpbmFsQ29uZmlnID0gQVdTLnV0aWwuY29weShjb25maWcpOwogICAgICAgIHZhciBzdmMgPSBuZXcgU2VydmljZUNsYXNzKGNvbmZpZyk7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHN2YywgJ19vcmlnaW5hbENvbmZpZycsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7IHJldHVybiBvcmlnaW5hbENvbmZpZzsgfSwKICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgc3ZjLl9jbGllbnRJZCA9ICsrY2xpZW50Q291bnQ7CiAgICAgICAgcmV0dXJuIHN2YzsKICAgICAgfQogICAgICB0aGlzLmluaXRpYWxpemUoY29uZmlnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKGNvbmZpZykgewogICAgICB2YXIgc3ZjQ29uZmlnID0gQVdTLmNvbmZpZ1t0aGlzLnNlcnZpY2VJZGVudGlmaWVyXTsKICAgICAgdGhpcy5jb25maWcgPSBuZXcgQVdTLkNvbmZpZyhBV1MuY29uZmlnKTsKICAgICAgaWYgKHN2Y0NvbmZpZykgdGhpcy5jb25maWcudXBkYXRlKHN2Y0NvbmZpZywgdHJ1ZSk7CiAgICAgIGlmIChjb25maWcpIHRoaXMuY29uZmlnLnVwZGF0ZShjb25maWcsIHRydWUpOwogIAogICAgICB0aGlzLnZhbGlkYXRlU2VydmljZSgpOwogICAgICBpZiAoIXRoaXMuY29uZmlnLmVuZHBvaW50KSByZWdpb25Db25maWcodGhpcyk7CiAgCiAgICAgIHRoaXMuY29uZmlnLmVuZHBvaW50ID0gdGhpcy5lbmRwb2ludEZyb21UZW1wbGF0ZSh0aGlzLmNvbmZpZy5lbmRwb2ludCk7CiAgICAgIHRoaXMuc2V0RW5kcG9pbnQodGhpcy5jb25maWcuZW5kcG9pbnQpOwogICAgICAvL2VuYWJsZSBhdHRhY2hpbmcgbGlzdGVuZXJzIHRvIHNlcnZpY2UgY2xpZW50CiAgICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzKTsKICAgICAgQVdTLlNlcnZpY2UuYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnModGhpcyk7CiAgICAgIGlmICgodGhpcy5jb25maWcuY2xpZW50U2lkZU1vbml0b3JpbmcgfHwgQVdTLlNlcnZpY2UuX2NsaWVudFNpZGVNb25pdG9yaW5nKSAmJiB0aGlzLnB1Ymxpc2hlcikgewogICAgICAgIHZhciBwdWJsaXNoZXIgPSB0aGlzLnB1Ymxpc2hlcjsKICAgICAgICB0aGlzLmFkZE5hbWVkTGlzdGVuZXIoJ1BVQkxJU0hfQVBJX0NBTEwnLCAnYXBpQ2FsbCcsIGZ1bmN0aW9uIFBVQkxJU0hfQVBJX0NBTEwoZXZlbnQpIHsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7cHVibGlzaGVyLmV2ZW50SGFuZGxlcihldmVudCk7fSk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5hZGROYW1lZExpc3RlbmVyKCdQVUJMSVNIX0FQSV9BVFRFTVBUJywgJ2FwaUNhbGxBdHRlbXB0JywgZnVuY3Rpb24gUFVCTElTSF9BUElfQVRURU1QVChldmVudCkgewogICAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtwdWJsaXNoZXIuZXZlbnRIYW5kbGVyKGV2ZW50KTt9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHZhbGlkYXRlU2VydmljZTogZnVuY3Rpb24gdmFsaWRhdGVTZXJ2aWNlKCkgewogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGxvYWRTZXJ2aWNlQ2xhc3M6IGZ1bmN0aW9uIGxvYWRTZXJ2aWNlQ2xhc3Moc2VydmljZUNvbmZpZykgewogICAgICB2YXIgY29uZmlnID0gc2VydmljZUNvbmZpZzsKICAgICAgaWYgKCFBV1MudXRpbC5pc0VtcHR5KHRoaXMuYXBpKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgaWYgKGNvbmZpZy5hcGlDb25maWcpIHsKICAgICAgICByZXR1cm4gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZUFwaSh0aGlzLmNvbnN0cnVjdG9yLCBjb25maWcuYXBpQ29uZmlnKTsKICAgICAgfSBlbHNlIGlmICghdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcykgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKEFXUy5jb25maWcpOwogICAgICAgIGNvbmZpZy51cGRhdGUoc2VydmljZUNvbmZpZywgdHJ1ZSk7CiAgICAgICAgdmFyIHZlcnNpb24gPSBjb25maWcuYXBpVmVyc2lvbnNbdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlSWRlbnRpZmllcl07CiAgICAgICAgdmVyc2lvbiA9IHZlcnNpb24gfHwgY29uZmlnLmFwaVZlcnNpb247CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TGF0ZXN0U2VydmljZUNsYXNzKHZlcnNpb24pOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0TGF0ZXN0U2VydmljZUNsYXNzOiBmdW5jdGlvbiBnZXRMYXRlc3RTZXJ2aWNlQ2xhc3ModmVyc2lvbikgewogICAgICB2ZXJzaW9uID0gdGhpcy5nZXRMYXRlc3RTZXJ2aWNlVmVyc2lvbih2ZXJzaW9uKTsKICAgICAgaWYgKHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXNbdmVyc2lvbl0gPT09IG51bGwpIHsKICAgICAgICBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlQXBpKHRoaXMuY29uc3RydWN0b3IsIHZlcnNpb24pOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzW3ZlcnNpb25dOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldExhdGVzdFNlcnZpY2VWZXJzaW9uOiBmdW5jdGlvbiBnZXRMYXRlc3RTZXJ2aWNlVmVyc2lvbih2ZXJzaW9uKSB7CiAgICAgIGlmICghdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcyB8fCB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2VydmljZXMgZGVmaW5lZCBvbiAnICsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlSWRlbnRpZmllcik7CiAgICAgIH0KICAKICAgICAgaWYgKCF2ZXJzaW9uKSB7CiAgICAgICAgdmVyc2lvbiA9ICdsYXRlc3QnOwogICAgICB9IGVsc2UgaWYgKEFXUy51dGlsLmlzVHlwZSh2ZXJzaW9uLCBEYXRlKSkgewogICAgICAgIHZlcnNpb24gPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEodmVyc2lvbikuc3BsaXQoJ1QnKVswXTsKICAgICAgfQogIAogICAgICBpZiAoT2JqZWN0Lmhhc093blByb3BlcnR5KHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMsIHZlcnNpb24pKSB7CiAgICAgICAgcmV0dXJuIHZlcnNpb247CiAgICAgIH0KICAKICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzKS5zb3J0KCk7CiAgICAgIHZhciBzZWxlY3RlZFZlcnNpb24gPSBudWxsOwogICAgICBmb3IgKHZhciBpID0ga2V5cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIC8vIHZlcnNpb25zIHRoYXQgZW5kIGluICIqIiBhcmUgbm90IGF2YWlsYWJsZSBvbiBkaXNrIGFuZCBjYW4gYmUKICAgICAgICAvLyBza2lwcGVkLCBzbyBkbyBub3QgY2hvb3NlIHRoZXNlIGFzIHNlbGVjdGVkVmVyc2lvbnMKICAgICAgICBpZiAoa2V5c1tpXVtrZXlzW2ldLmxlbmd0aCAtIDFdICE9PSAnKicpIHsKICAgICAgICAgIHNlbGVjdGVkVmVyc2lvbiA9IGtleXNbaV07CiAgICAgICAgfQogICAgICAgIGlmIChrZXlzW2ldLnN1YnN0cigwLCAxMCkgPD0gdmVyc2lvbikgewogICAgICAgICAgcmV0dXJuIHNlbGVjdGVkVmVyc2lvbjsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCAnICsgdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlSWRlbnRpZmllciArCiAgICAgICAgICAgICAgICAgICAgICAnIEFQSSB0byBzYXRpc2Z5IHZlcnNpb24gY29uc3RyYWludCBgJyArIHZlcnNpb24gKyAnXCcnKTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcGk6IHt9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmYXVsdFJldHJ5Q291bnQ6IDMsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBjdXN0b21pemVSZXF1ZXN0czogZnVuY3Rpb24gY3VzdG9taXplUmVxdWVzdHMoY2FsbGJhY2spIHsKICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPSBudWxsOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPSBjYWxsYmFjazsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY2FsbGJhY2sgdHlwZSBcJycgKyB0eXBlb2YgY2FsbGJhY2sgKyAnXCcgcHJvdmlkZWQgaW4gY3VzdG9taXplUmVxdWVzdHMnKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQ2FsbHMgYW4gb3BlcmF0aW9uIG9uIGEgc2VydmljZSB3aXRoIHRoZSBnaXZlbiBpbnB1dCBwYXJhbWV0ZXJzLgogICAgICoKICAgICAqIEBwYXJhbSBvcGVyYXRpb24gW1N0cmluZ10gdGhlIG5hbWUgb2YgdGhlIG9wZXJhdGlvbiB0byBjYWxsIG9uIHRoZSBzZXJ2aWNlLgogICAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBpbnB1dCBvcHRpb25zIGZvciB0aGUgb3BlcmF0aW9uCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICAgKiAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgICAqICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAgICovCiAgICBtYWtlUmVxdWVzdDogZnVuY3Rpb24gbWFrZVJlcXVlc3Qob3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgICAgcGFyYW1zID0gbnVsbDsKICAgICAgfQogIAogICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICAgIGlmICh0aGlzLmNvbmZpZy5wYXJhbXMpIHsgLy8gY29weSBvbmx5IHRvcGxldmVsIGJvdW5kIHBhcmFtcwogICAgICAgIHZhciBydWxlcyA9IHRoaXMuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXTsKICAgICAgICBpZiAocnVsZXMpIHsKICAgICAgICAgIHBhcmFtcyA9IEFXUy51dGlsLmNvcHkocGFyYW1zKTsKICAgICAgICAgIEFXUy51dGlsLmVhY2godGhpcy5jb25maWcucGFyYW1zLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChydWxlcy5pbnB1dC5tZW1iZXJzW2tleV0pIHsKICAgICAgICAgICAgICBpZiAocGFyYW1zW2tleV0gPT09IHVuZGVmaW5lZCB8fCBwYXJhbXNba2V5XSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcGFyYW1zW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogIAogICAgICB2YXIgcmVxdWVzdCA9IG5ldyBBV1MuUmVxdWVzdCh0aGlzLCBvcGVyYXRpb24sIHBhcmFtcyk7CiAgICAgIHRoaXMuYWRkQWxsUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KTsKICAgICAgdGhpcy5hdHRhY2hNb25pdG9yaW5nRW1pdHRlcihyZXF1ZXN0KTsKICAgICAgaWYgKGNhbGxiYWNrKSByZXF1ZXN0LnNlbmQoY2FsbGJhY2spOwogICAgICByZXR1cm4gcmVxdWVzdDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIENhbGxzIGFuIG9wZXJhdGlvbiBvbiBhIHNlcnZpY2Ugd2l0aCB0aGUgZ2l2ZW4gaW5wdXQgcGFyYW1ldGVycywgd2l0aG91dAogICAgICogYW55IGF1dGhlbnRpY2F0aW9uIGRhdGEuIFRoaXMgbWV0aG9kIGlzIHVzZWZ1bCBmb3IgInB1YmxpYyIgQVBJIG9wZXJhdGlvbnMuCiAgICAgKgogICAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgbmFtZSBvZiB0aGUgb3BlcmF0aW9uIHRvIGNhbGwgb24gdGhlIHNlcnZpY2UuCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIGlucHV0IG9wdGlvbnMgZm9yIHRoZSBvcGVyYXRpb24KICAgICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICAgKi8KICAgIG1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0OiBmdW5jdGlvbiBtYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgICBwYXJhbXMgPSB7fTsKICAgICAgfQogIAogICAgICB2YXIgcmVxdWVzdCA9IHRoaXMubWFrZVJlcXVlc3Qob3BlcmF0aW9uLCBwYXJhbXMpLnRvVW5hdXRoZW50aWNhdGVkKCk7CiAgICAgIHJldHVybiBjYWxsYmFjayA/IHJlcXVlc3Quc2VuZChjYWxsYmFjaykgOiByZXF1ZXN0OwogICAgfSwKICAKICAgIC8qKgogICAgICogV2FpdHMgZm9yIGEgZ2l2ZW4gc3RhdGUKICAgICAqCiAgICAgKiBAcGFyYW0gc3RhdGUgW1N0cmluZ10gdGhlIHN0YXRlIG9uIHRoZSBzZXJ2aWNlIHRvIHdhaXQgZm9yCiAgICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIHBhcmFtZXRlcnMgdG8gcGFzcyB3aXRoIGVhY2ggcmVxdWVzdAogICAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlciBbbWFwXSBhIG1hcCBvZiBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSB3YWl0ZXIKICAgICAqIEBvcHRpb24gcGFyYW1zICR3YWl0ZXIuZGVsYXkgW051bWJlcl0gVGhlIG51bWJlciBvZiBzZWNvbmRzIHRvIHdhaXQgYmV0d2VlbgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0cwogICAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlci5tYXhBdHRlbXB0cyBbTnVtYmVyXSBUaGUgbWF4aW11bSBudW1iZXIgb2YgcmVxdWVzdHMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gc2VuZCB3aGlsZSB3YWl0aW5nCiAgICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAgICogICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICAgKiAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICAgKiAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgICAqICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAgICovCiAgICB3YWl0Rm9yOiBmdW5jdGlvbiB3YWl0Rm9yKHN0YXRlLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgIHZhciB3YWl0ZXIgPSBuZXcgQVdTLlJlc291cmNlV2FpdGVyKHRoaXMsIHN0YXRlKTsKICAgICAgcmV0dXJuIHdhaXRlci53YWl0KHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZEFsbFJlcXVlc3RMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZEFsbFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogICAgICB2YXIgbGlzdCA9IFtBV1MuZXZlbnRzLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZSwgdGhpcy5zZXJ2aWNlSW50ZXJmYWNlKCksCiAgICAgICAgICAgICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlUG9zdF07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChsaXN0W2ldKSByZXF1ZXN0LmFkZExpc3RlbmVycyhsaXN0W2ldKTsKICAgICAgfQogIAogICAgICAvLyBkaXNhYmxlIHBhcmFtZXRlciB2YWxpZGF0aW9uCiAgICAgIGlmICghdGhpcy5jb25maWcucGFyYW1WYWxpZGF0aW9uKSB7CiAgICAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLAogICAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuVkFMSURBVEVfUEFSQU1FVEVSUyk7CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMuY29uZmlnLmxvZ2dlcikgeyAvLyBhZGQgbG9nZ2luZyBldmVudHMKICAgICAgICByZXF1ZXN0LmFkZExpc3RlbmVycyhBV1MuRXZlbnRMaXN0ZW5lcnMuTG9nZ2VyKTsKICAgICAgfQogIAogICAgICB0aGlzLnNldHVwUmVxdWVzdExpc3RlbmVycyhyZXF1ZXN0KTsKICAgICAgLy8gY2FsbCBwcm90b3R5cGUncyBjdXN0b21SZXF1ZXN0SGFuZGxlcgogICAgICBpZiAodHlwZW9mIHRoaXMuY29uc3RydWN0b3IucHJvdG90eXBlLmN1c3RvbVJlcXVlc3RIYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuY3VzdG9tUmVxdWVzdEhhbmRsZXIocmVxdWVzdCk7CiAgICAgIH0KICAgICAgLy8gY2FsbCBpbnN0YW5jZSdzIGN1c3RvbVJlcXVlc3RIYW5kbGVyCiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcywgJ2N1c3RvbVJlcXVlc3RIYW5kbGVyJykgJiYgdHlwZW9mIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyKHJlcXVlc3QpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBFdmVudCByZWNvcmRpbmcgbWV0cmljcyBmb3IgYSB3aG9sZSBBUEkgY2FsbC4KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IGEgc3Vic2V0IG9mIGFwaSBjYWxsIG1ldHJpY3MKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcGlDYWxsRXZlbnQ6IGZ1bmN0aW9uIGFwaUNhbGxFdmVudChyZXF1ZXN0KSB7CiAgICAgIHZhciBhcGkgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgICB2YXIgbW9uaXRvcmluZ0V2ZW50ID0gewogICAgICAgIFR5cGU6ICdBcGlDYWxsJywKICAgICAgICBBcGk6IGFwaSA/IGFwaS5uYW1lIDogcmVxdWVzdC5vcGVyYXRpb24sCiAgICAgICAgVmVyc2lvbjogMSwKICAgICAgICBTZXJ2aWNlOiByZXF1ZXN0LnNlcnZpY2UuYXBpLnNlcnZpY2VJZCB8fCByZXF1ZXN0LnNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICAgIFJlZ2lvbjogcmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb24sCiAgICAgICAgTWF4UmV0cmllc0V4Y2VlZGVkOiAwLAogICAgICAgIFVzZXJBZ2VudDogcmVxdWVzdC5odHRwUmVxdWVzdC5nZXRVc2VyQWdlbnQoKSwKICAgICAgfTsKICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LkZpbmFsSHR0cFN0YXR1c0NvZGUgPSByZXNwb25zZS5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHsKICAgICAgICB2YXIgZXJyb3IgPSByZXNwb25zZS5lcnJvcjsKICAgICAgICB2YXIgc3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIGlmIChzdGF0dXNDb2RlID4gMjk5KSB7CiAgICAgICAgICBpZiAoZXJyb3IuY29kZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsQXdzRXhjZXB0aW9uID0gZXJyb3IuY29kZTsKICAgICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuRmluYWxBd3NFeGNlcHRpb25NZXNzYWdlID0gZXJyb3IubWVzc2FnZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsU2RrRXhjZXB0aW9uID0gZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lOwogICAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5GaW5hbFNka0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgfSwKICAKICAgIC8qKgogICAgICogRXZlbnQgcmVjb3JkaW5nIG1ldHJpY3MgZm9yIGFuIEFQSSBjYWxsIGF0dGVtcHQuCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBhIHN1YnNldCBvZiBhcGkgY2FsbCBhdHRlbXB0IG1ldHJpY3MKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhcGlBdHRlbXB0RXZlbnQ6IGZ1bmN0aW9uIGFwaUF0dGVtcHRFdmVudChyZXF1ZXN0KSB7CiAgICAgIHZhciBhcGkgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dOwogICAgICB2YXIgbW9uaXRvcmluZ0V2ZW50ID0gewogICAgICAgIFR5cGU6ICdBcGlDYWxsQXR0ZW1wdCcsCiAgICAgICAgQXBpOiBhcGkgPyBhcGkubmFtZSA6IHJlcXVlc3Qub3BlcmF0aW9uLAogICAgICAgIFZlcnNpb246IDEsCiAgICAgICAgU2VydmljZTogcmVxdWVzdC5zZXJ2aWNlLmFwaS5zZXJ2aWNlSWQgfHwgcmVxdWVzdC5zZXJ2aWNlLmFwaS5lbmRwb2ludFByZWZpeCwKICAgICAgICBGcWRuOiByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50Lmhvc3RuYW1lLAogICAgICAgIFVzZXJBZ2VudDogcmVxdWVzdC5odHRwUmVxdWVzdC5nZXRVc2VyQWdlbnQoKSwKICAgICAgfTsKICAgICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50Lkh0dHBTdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIH0KICAgICAgaWYgKAogICAgICAgICFyZXF1ZXN0Ll91bkF1dGhlbnRpY2F0ZWQgJiYKICAgICAgICByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzICYmCiAgICAgICAgcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZAogICAgICApIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuQWNjZXNzS2V5ID0gcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZDsKICAgICAgfQogICAgICBpZiAoIXJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzKSByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogICAgICBpZiAocmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddKSB7CiAgICAgICAgbW9uaXRvcmluZ0V2ZW50LlNlc3Npb25Ub2tlbiA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXTsKICAgICAgfQogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1yZXF1ZXN0aWQnXSkgewogICAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16blJlcXVlc3RJZCA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ107CiAgICAgIH0KICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuWEFtelJlcXVlc3RJZCA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ107CiAgICAgIH0KICAgICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1pZC0yJ10pIHsKICAgICAgICBtb25pdG9yaW5nRXZlbnQuWEFteklkMiA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1pZC0yJ107CiAgICAgIH0KICAgICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEFkZCBtZXRyaWNzIG9mIGZhaWxlZCByZXF1ZXN0LgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGF0dGVtcHRGYWlsRXZlbnQ6IGZ1bmN0aW9uIGF0dGVtcHRGYWlsRXZlbnQocmVxdWVzdCkgewogICAgICB2YXIgbW9uaXRvcmluZ0V2ZW50ID0gdGhpcy5hcGlBdHRlbXB0RXZlbnQocmVxdWVzdCk7CiAgICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPiAyOTkgKSB7CiAgICAgICAgaWYgKGVycm9yLmNvZGUpIG1vbml0b3JpbmdFdmVudC5Bd3NFeGNlcHRpb24gPSBlcnJvci5jb2RlOwogICAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuQXdzRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZSkgbW9uaXRvcmluZ0V2ZW50LlNka0V4Y2VwdGlvbiA9IGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZTsKICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LlNka0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICB9CiAgICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBBdHRhY2ggbGlzdGVuZXJzIHRvIHJlcXVlc3Qgb2JqZWN0IHRvIGZldGNoIG1ldHJpY3Mgb2YgZWFjaCByZXF1ZXN0CiAgICAgKiBhbmQgZW1pdCBkYXRhIG9iamVjdCB0aHJvdWdoIFwnQXBpQ2FsbFwnIGFuZCBcJ0FwaUNhbGxBdHRlbXB0XCcgZXZlbnRzLgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGF0dGFjaE1vbml0b3JpbmdFbWl0dGVyOiBmdW5jdGlvbiBhdHRhY2hNb25pdG9yaW5nRW1pdHRlcihyZXF1ZXN0KSB7CiAgICAgIHZhciBhdHRlbXB0VGltZXN0YW1wOyAvL3RpbWVzdGFtcCBtYXJraW5nIHRoZSBiZWdpbm5pbmcgb2YgYSByZXF1ZXN0IGF0dGVtcHQKICAgICAgdmFyIGF0dGVtcHRTdGFydFJlYWxUaW1lOyAvL1N0YXJ0IHRpbWUgb2YgcmVxdWVzdCBhdHRlbXB0LiBVc2VkIHRvIGNhbGN1bGF0aW5nIGF0dGVtcHRMYXRlbmN5CiAgICAgIHZhciBhdHRlbXB0TGF0ZW5jeTsgLy9sYXRlbmN5IGZyb20gcmVxdWVzdCBzZW50IG91dCB0byBodHRwIHJlc3BvbnNlIHJlYWNoaW5nIFNESwogICAgICB2YXIgY2FsbFN0YXJ0UmVhbFRpbWU7IC8vU3RhcnQgdGltZSBvZiBBUEkgY2FsbC4gVXNlZCB0byBjYWxjdWxhdGluZyBBUEkgY2FsbCBsYXRlbmN5CiAgICAgIHZhciBhdHRlbXB0Q291bnQgPSAwOyAvL3JlcXVlc3QucmV0cnlDb3VudCBpcyBub3QgcmVsaWFibGUgaGVyZQogICAgICB2YXIgcmVnaW9uOyAvL3JlZ2lvbiBjYWNoZSByZWdpb24gZm9yIGVhY2ggYXR0ZW1wdCBzaW5jZSBpdCBjYW4gYmUgdXBkYXRlZCBpbiBwbGFzZSAoZS5nLiBzMykKICAgICAgdmFyIGNhbGxUaW1lc3RhbXA7IC8vdGltZXN0YW1wIHdoZW4gdGhlIHJlcXVlc3QgaXMgY3JlYXRlZAogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhZGRUb0hlYWQgPSB0cnVlOwogIAogICAgICByZXF1ZXN0Lm9uKCd2YWxpZGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICBjYWxsU3RhcnRSZWFsVGltZSA9IEFXUy51dGlsLnJlYWxDbG9jay5ub3coKTsKICAgICAgICBjYWxsVGltZXN0YW1wID0gRGF0ZS5ub3coKTsKICAgICAgfSwgYWRkVG9IZWFkKTsKICAgICAgcmVxdWVzdC5vbignc2lnbicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBhdHRlbXB0U3RhcnRSZWFsVGltZSA9IEFXUy51dGlsLnJlYWxDbG9jay5ub3coKTsKICAgICAgICBhdHRlbXB0VGltZXN0YW1wID0gRGF0ZS5ub3coKTsKICAgICAgICByZWdpb24gPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbjsKICAgICAgICBhdHRlbXB0Q291bnQrKzsKICAgICAgfSwgYWRkVG9IZWFkKTsKICAgICAgcmVxdWVzdC5vbigndmFsaWRhdGVSZXNwb25zZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGF0dGVtcHRMYXRlbmN5ID0gTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBhdHRlbXB0U3RhcnRSZWFsVGltZSk7CiAgICAgIH0pOwogICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMX0FUVEVNUFQnLCAnc3VjY2VzcycsIGZ1bmN0aW9uIEFQSV9DQUxMX0FUVEVNUFQoKSB7CiAgICAgICAgdmFyIGFwaUF0dGVtcHRFdmVudCA9IHNlbGYuYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5UaW1lc3RhbXAgPSBhdHRlbXB0VGltZXN0YW1wOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5BdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5ID49IDAgPyBhdHRlbXB0TGF0ZW5jeSA6IDA7CiAgICAgICAgYXBpQXR0ZW1wdEV2ZW50LlJlZ2lvbiA9IHJlZ2lvbjsKICAgICAgICBzZWxmLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2FwaUF0dGVtcHRFdmVudF0pOwogICAgICB9KTsKICAgICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTF9BVFRFTVBUX1JFVFJZJywgJ3JldHJ5JywgZnVuY3Rpb24gQVBJX0NBTExfQVRURU1QVF9SRVRSWSgpIHsKICAgICAgICB2YXIgYXBpQXR0ZW1wdEV2ZW50ID0gc2VsZi5hdHRlbXB0RmFpbEV2ZW50KHJlcXVlc3QpOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5UaW1lc3RhbXAgPSBhdHRlbXB0VGltZXN0YW1wOwogICAgICAgIC8vYXR0ZW1wdExhdGVuY3kgbWF5IG5vdCBiZSBhdmFpbGFibGUgaWYgZmFpbCBiZWZvcmUgcmVzcG9uc2UKICAgICAgICBhdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5IHx8CiAgICAgICAgICBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGF0dGVtcHRTdGFydFJlYWxUaW1lKTsKICAgICAgICBhcGlBdHRlbXB0RXZlbnQuQXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSA+PSAwID8gYXR0ZW1wdExhdGVuY3kgOiAwOwogICAgICAgIGFwaUF0dGVtcHRFdmVudC5SZWdpb24gPSByZWdpb247CiAgICAgICAgc2VsZi5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFthcGlBdHRlbXB0RXZlbnRdKTsKICAgICAgfSk7CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTEwnLCAnY29tcGxldGUnLCBmdW5jdGlvbiBBUElfQ0FMTCgpIHsKICAgICAgICB2YXIgYXBpQ2FsbEV2ZW50ID0gc2VsZi5hcGlDYWxsRXZlbnQocmVxdWVzdCk7CiAgICAgICAgYXBpQ2FsbEV2ZW50LkF0dGVtcHRDb3VudCA9IGF0dGVtcHRDb3VudDsKICAgICAgICBpZiAoYXBpQ2FsbEV2ZW50LkF0dGVtcHRDb3VudCA8PSAwKSByZXR1cm47CiAgICAgICAgYXBpQ2FsbEV2ZW50LlRpbWVzdGFtcCA9IGNhbGxUaW1lc3RhbXA7CiAgICAgICAgdmFyIGxhdGVuY3kgPSBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGNhbGxTdGFydFJlYWxUaW1lKTsKICAgICAgICBhcGlDYWxsRXZlbnQuTGF0ZW5jeSA9IGxhdGVuY3kgPj0gMCA/IGxhdGVuY3kgOiAwOwogICAgICAgIHZhciByZXNwb25zZSA9IHJlcXVlc3QucmVzcG9uc2U7CiAgICAgICAgaWYgKAogICAgICAgICAgdHlwZW9mIHJlc3BvbnNlLnJldHJ5Q291bnQgPT09ICdudW1iZXInICYmCiAgICAgICAgICB0eXBlb2YgcmVzcG9uc2UubWF4UmV0cmllcyA9PT0gJ251bWJlcicgJiYKICAgICAgICAgIChyZXNwb25zZS5yZXRyeUNvdW50ID49IHJlc3BvbnNlLm1heFJldHJpZXMpCiAgICAgICAgKSB7CiAgICAgICAgICBhcGlDYWxsRXZlbnQuTWF4UmV0cmllc0V4Y2VlZGVkID0gMTsKICAgICAgICB9CiAgICAgICAgc2VsZi5lbWl0KCdhcGlDYWxsJywgW2FwaUNhbGxFdmVudF0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHNldHVwIGFueSBjdXN0b20gcmVxdWVzdCBsaXN0ZW5lcnMgZm9yIGVhY2gKICAgICAqIG5ldyByZXF1ZXN0IHRvIHRoZSBzZXJ2aWNlLgogICAgICoKICAgICAqIEBtZXRob2RfYWJzdHJhY3QgVGhpcyBpcyBhbiBhYnN0cmFjdCBtZXRob2QuCiAgICAgKi8KICAgIHNldHVwUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpIHsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEdldHMgdGhlIHNpZ25lciBjbGFzcyBmb3IgYSBnaXZlbiByZXF1ZXN0CiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZ2V0U2lnbmVyQ2xhc3M6IGZ1bmN0aW9uIGdldFNpZ25lckNsYXNzKHJlcXVlc3QpIHsKICAgICAgdmFyIHZlcnNpb247CiAgICAgIC8vIGdldCBvcGVyYXRpb24gYXV0aHR5cGUgaWYgcHJlc2VudAogICAgICB2YXIgb3BlcmF0aW9uID0gbnVsbDsKICAgICAgdmFyIGF1dGh0eXBlID0gJyc7CiAgICAgIGlmIChyZXF1ZXN0KSB7CiAgICAgICAgdmFyIG9wZXJhdGlvbnMgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgICAgb3BlcmF0aW9uID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gfHwgbnVsbDsKICAgICAgICBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgICB9CiAgICAgIGlmICh0aGlzLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSB7CiAgICAgICAgdmVyc2lvbiA9IHRoaXMuY29uZmlnLnNpZ25hdHVyZVZlcnNpb247CiAgICAgIH0gZWxzZSBpZiAoYXV0aHR5cGUgPT09ICd2NCcgfHwgYXV0aHR5cGUgPT09ICd2NC11bnNpZ25lZC1ib2R5JykgewogICAgICAgIHZlcnNpb24gPSAndjQnOwogICAgICB9IGVsc2UgewogICAgICAgIHZlcnNpb24gPSB0aGlzLmFwaS5zaWduYXR1cmVWZXJzaW9uOwogICAgICB9CiAgICAgIHJldHVybiBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmdldFZlcnNpb24odmVyc2lvbik7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2VydmljZUludGVyZmFjZTogZnVuY3Rpb24gc2VydmljZUludGVyZmFjZSgpIHsKICAgICAgc3dpdGNoICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICAgIGNhc2UgJ2VjMic6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUXVlcnk7CiAgICAgICAgY2FzZSAncXVlcnknOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlF1ZXJ5OwogICAgICAgIGNhc2UgJ2pzb24nOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLkpzb247CiAgICAgICAgY2FzZSAncmVzdC1qc29uJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5SZXN0SnNvbjsKICAgICAgICBjYXNlICdyZXN0LXhtbCc6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUmVzdFhtbDsKICAgICAgfQogICAgICBpZiAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2VydmljZSBgcHJvdG9jb2xcJyAnICsKICAgICAgICAgIHRoaXMuYXBpLnByb3RvY29sICsgJyBpbiBBUEkgY29uZmlnJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzdWNjZXNzZnVsUmVzcG9uc2U6IGZ1bmN0aW9uIHN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSB7CiAgICAgIHJldHVybiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlIDwgMzAwOwogICAgfSwKICAKICAgIC8qKgogICAgICogSG93IG1hbnkgdGltZXMgYSBmYWlsZWQgcmVxdWVzdCBzaG91bGQgYmUgcmV0cmllZCBiZWZvcmUgZ2l2aW5nIHVwLgogICAgICogdGhlIGRlZmF1bHRSZXRyeUNvdW50IGNhbiBiZSBvdmVycmlkZW4gYnkgc2VydmljZSBjbGFzc2VzLgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBudW1SZXRyaWVzOiBmdW5jdGlvbiBudW1SZXRyaWVzKCkgewogICAgICBpZiAodGhpcy5jb25maWcubWF4UmV0cmllcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLm1heFJldHJpZXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVmYXVsdFJldHJ5Q291bnQ7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICByZXRyeURlbGF5czogZnVuY3Rpb24gcmV0cnlEZWxheXMocmV0cnlDb3VudCkgewogICAgICByZXR1cm4gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCB0aGlzLmNvbmZpZy5yZXRyeURlbGF5T3B0aW9ucyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcmV0cnlhYmxlRXJyb3I6IGZ1bmN0aW9uIHJldHJ5YWJsZUVycm9yKGVycm9yKSB7CiAgICAgIGlmICh0aGlzLnRpbWVvdXRFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgICBpZiAodGhpcy5uZXR3b3JraW5nRXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMuZXhwaXJlZENyZWRlbnRpYWxzRXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKHRoaXMudGhyb3R0bGVkRXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgICAgaWYgKGVycm9yLnN0YXR1c0NvZGUgPj0gNTAwKSByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIG5ldHdvcmtpbmdFcnJvcjogZnVuY3Rpb24gbmV0d29ya2luZ0Vycm9yKGVycm9yKSB7CiAgICAgIHJldHVybiBlcnJvci5jb2RlID09PSAnTmV0d29ya2luZ0Vycm9yJzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB0aW1lb3V0RXJyb3I6IGZ1bmN0aW9uIHRpbWVvdXRFcnJvcihlcnJvcikgewogICAgICByZXR1cm4gZXJyb3IuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcic7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZXhwaXJlZENyZWRlbnRpYWxzRXJyb3I6IGZ1bmN0aW9uIGV4cGlyZWRDcmVkZW50aWFsc0Vycm9yKGVycm9yKSB7CiAgICAgIC8vIFRPRE8gOiB0aGlzIG9ubHkgaGFuZGxlcyAqb25lKiBvZiB0aGUgZXhwaXJlZCBjcmVkZW50aWFsIGNvZGVzCiAgICAgIHJldHVybiAoZXJyb3IuY29kZSA9PT0gJ0V4cGlyZWRUb2tlbkV4Y2VwdGlvbicpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNsb2NrU2tld0Vycm9yOiBmdW5jdGlvbiBjbG9ja1NrZXdFcnJvcihlcnJvcikgewogICAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHsKICAgICAgICBjYXNlICdSZXF1ZXN0VGltZVRvb1NrZXdlZCc6CiAgICAgICAgY2FzZSAnUmVxdWVzdEV4cGlyZWQnOgogICAgICAgIGNhc2UgJ0ludmFsaWRTaWduYXR1cmVFeGNlcHRpb24nOgogICAgICAgIGNhc2UgJ1NpZ25hdHVyZURvZXNOb3RNYXRjaCc6CiAgICAgICAgY2FzZSAnQXV0aEZhaWx1cmUnOgogICAgICAgIGNhc2UgJ1JlcXVlc3RJblRoZUZ1dHVyZSc6CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBnZXRTa2V3Q29ycmVjdGVkRGF0ZTogZnVuY3Rpb24gZ2V0U2tld0NvcnJlY3RlZERhdGUoKSB7CiAgICAgIHJldHVybiBuZXcgRGF0ZShEYXRlLm5vdygpICsgdGhpcy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFwcGx5Q2xvY2tPZmZzZXQ6IGZ1bmN0aW9uIGFwcGx5Q2xvY2tPZmZzZXQobmV3U2VydmVyVGltZSkgewogICAgICBpZiAobmV3U2VydmVyVGltZSkgewogICAgICAgIHRoaXMuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0ID0gbmV3U2VydmVyVGltZSAtIERhdGUubm93KCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc0Nsb2NrU2tld2VkOiBmdW5jdGlvbiBpc0Nsb2NrU2tld2VkKG5ld1NlcnZlclRpbWUpIHsKICAgICAgaWYgKG5ld1NlcnZlclRpbWUpIHsKICAgICAgICByZXR1cm4gTWF0aC5hYnModGhpcy5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpLmdldFRpbWUoKSAtIG5ld1NlcnZlclRpbWUpID49IDMwMDAwOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdGhyb3R0bGVkRXJyb3I6IGZ1bmN0aW9uIHRocm90dGxlZEVycm9yKGVycm9yKSB7CiAgICAgIC8vIHRoaXMgbG9naWMgdmFyaWVzIGJldHdlZW4gc2VydmljZXMKICAgICAgaWYgKGVycm9yLnN0YXR1c0NvZGUgPT09IDQyOSkgcmV0dXJuIHRydWU7CiAgICAgIHN3aXRjaCAoZXJyb3IuY29kZSkgewogICAgICAgIGNhc2UgJ1Byb3Zpc2lvbmVkVGhyb3VnaHB1dEV4Y2VlZGVkRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdUaHJvdHRsaW5nJzoKICAgICAgICBjYXNlICdUaHJvdHRsaW5nRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdSZXF1ZXN0TGltaXRFeGNlZWRlZCc6CiAgICAgICAgY2FzZSAnUmVxdWVzdFRocm90dGxlZCc6CiAgICAgICAgY2FzZSAnUmVxdWVzdFRocm90dGxlZEV4Y2VwdGlvbic6CiAgICAgICAgY2FzZSAnVG9vTWFueVJlcXVlc3RzRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdUcmFuc2FjdGlvbkluUHJvZ3Jlc3NFeGNlcHRpb24nOiAvL2R5bmFtb2RiCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZW5kcG9pbnRGcm9tVGVtcGxhdGU6IGZ1bmN0aW9uIGVuZHBvaW50RnJvbVRlbXBsYXRlKGVuZHBvaW50KSB7CiAgICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgIT09ICdzdHJpbmcnKSByZXR1cm4gZW5kcG9pbnQ7CiAgCiAgICAgIHZhciBlID0gZW5kcG9pbnQ7CiAgICAgIGUgPSBlLnJlcGxhY2UoL1x7c2VydmljZVx9L2csIHRoaXMuYXBpLmVuZHBvaW50UHJlZml4KTsKICAgICAgZSA9IGUucmVwbGFjZSgvXHtyZWdpb25cfS9nLCB0aGlzLmNvbmZpZy5yZWdpb24pOwogICAgICBlID0gZS5yZXBsYWNlKC9ce3NjaGVtZVx9L2csIHRoaXMuY29uZmlnLnNzbEVuYWJsZWQgPyAnaHR0cHMnIDogJ2h0dHAnKTsKICAgICAgcmV0dXJuIGU7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2V0RW5kcG9pbnQ6IGZ1bmN0aW9uIHNldEVuZHBvaW50KGVuZHBvaW50KSB7CiAgICAgIHRoaXMuZW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50LCB0aGlzLmNvbmZpZyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcGFnaW5hdGlvbkNvbmZpZzogZnVuY3Rpb24gcGFnaW5hdGlvbkNvbmZpZyhvcGVyYXRpb24sIHRocm93RXhjZXB0aW9uKSB7CiAgICAgIHZhciBwYWdpbmF0b3IgPSB0aGlzLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbl0ucGFnaW5hdG9yOwogICAgICBpZiAoIXBhZ2luYXRvcikgewogICAgICAgIGlmICh0aHJvd0V4Y2VwdGlvbikgewogICAgICAgICAgdmFyIGUgPSBuZXcgRXJyb3IoKTsKICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKGUsICdObyBwYWdpbmF0aW9uIGNvbmZpZ3VyYXRpb24gZm9yICcgKyBvcGVyYXRpb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogIAogICAgICByZXR1cm4gcGFnaW5hdG9yOwogICAgfQogIH0pOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MuU2VydmljZSwgewogIAogICAgLyoqCiAgICAgKiBBZGRzIG9uZSBtZXRob2QgZm9yIGVhY2ggb3BlcmF0aW9uIGRlc2NyaWJlZCBpbiB0aGUgYXBpIGNvbmZpZ3VyYXRpb24KICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmaW5lTWV0aG9kczogZnVuY3Rpb24gZGVmaW5lTWV0aG9kcyhzdmMpIHsKICAgICAgQVdTLnV0aWwuZWFjaChzdmMucHJvdG90eXBlLmFwaS5vcGVyYXRpb25zLCBmdW5jdGlvbiBpdGVyYXRvcihtZXRob2QpIHsKICAgICAgICBpZiAoc3ZjLnByb3RvdHlwZVttZXRob2RdKSByZXR1cm47CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IHN2Yy5wcm90b3R5cGUuYXBpLm9wZXJhdGlvbnNbbWV0aG9kXTsKICAgICAgICBpZiAob3BlcmF0aW9uLmF1dGh0eXBlID09PSAnbm9uZScpIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdmMucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbiAocGFyYW1zLCBjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tYWtlUmVxdWVzdChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2spOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8qKgogICAgICogRGVmaW5lcyBhIG5ldyBTZXJ2aWNlIGNsYXNzIHVzaW5nIGEgc2VydmljZSBpZGVudGlmaWVyIGFuZCBsaXN0IG9mIHZlcnNpb25zCiAgICAgKiBpbmNsdWRpbmcgYW4gb3B0aW9uYWwgc2V0IG9mIGZlYXR1cmVzIChmdW5jdGlvbnMpIHRvIGFwcGx5IHRvIHRoZSBjbGFzcwogICAgICogcHJvdG90eXBlLgogICAgICoKICAgICAqIEBwYXJhbSBzZXJ2aWNlSWRlbnRpZmllciBbU3RyaW5nXSB0aGUgaWRlbnRpZmllciBmb3IgdGhlIHNlcnZpY2UKICAgICAqIEBwYXJhbSB2ZXJzaW9ucyBbQXJyYXk8U3RyaW5nPl0gYSBsaXN0IG9mIHZlcnNpb25zIHRoYXQgd29yayB3aXRoIHRoaXMKICAgICAqICAgc2VydmljZQogICAgICogQHBhcmFtIGZlYXR1cmVzIFtPYmplY3RdIGFuIG9iamVjdCB0byBhdHRhY2ggdG8gdGhlIHByb3RvdHlwZQogICAgICogQHJldHVybiBbQ2xhc3M8U2VydmljZT5dIHRoZSBzZXJ2aWNlIGNsYXNzIGRlZmluZWQgYnkgdGhpcyBmdW5jdGlvbi4KICAgICAqLwogICAgZGVmaW5lU2VydmljZTogZnVuY3Rpb24gZGVmaW5lU2VydmljZShzZXJ2aWNlSWRlbnRpZmllciwgdmVyc2lvbnMsIGZlYXR1cmVzKSB7CiAgICAgIEFXUy5TZXJ2aWNlLl9zZXJ2aWNlTWFwW3NlcnZpY2VJZGVudGlmaWVyXSA9IHRydWU7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2ZXJzaW9ucykpIHsKICAgICAgICBmZWF0dXJlcyA9IHZlcnNpb25zOwogICAgICAgIHZlcnNpb25zID0gW107CiAgICAgIH0KICAKICAgICAgdmFyIHN2YyA9IGluaGVyaXQoQVdTLlNlcnZpY2UsIGZlYXR1cmVzIHx8IHt9KTsKICAKICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlSWRlbnRpZmllciA9PT0gJ3N0cmluZycpIHsKICAgICAgICBBV1MuU2VydmljZS5hZGRWZXJzaW9ucyhzdmMsIHZlcnNpb25zKTsKICAKICAgICAgICB2YXIgaWRlbnRpZmllciA9IHN2Yy5zZXJ2aWNlSWRlbnRpZmllciB8fCBzZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgICBzdmMuc2VydmljZUlkZW50aWZpZXIgPSBpZGVudGlmaWVyOwogICAgICB9IGVsc2UgeyAvLyBkZWZpbmVTZXJ2aWNlIGNhbGxlZCB3aXRoIGFuIEFQSQogICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gc2VydmljZUlkZW50aWZpZXI7CiAgICAgICAgQVdTLlNlcnZpY2UuZGVmaW5lTWV0aG9kcyhzdmMpOwogICAgICB9CiAgICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzLnByb3RvdHlwZSk7CiAgICAgIC8vdXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZyBpcyBvbmx5IGF2YWlsYWJsZSBpbiBub2RlCiAgICAgIGlmICghdGhpcy5wcm90b3R5cGUucHVibGlzaGVyICYmIEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nKSB7CiAgICAgICAgdmFyIFB1Ymxpc2hlciA9IEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nLlB1Ymxpc2hlcjsKICAgICAgICB2YXIgY29uZmlnUHJvdmlkZXIgPSBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZy5jb25maWdQcm92aWRlcjsKICAgICAgICB2YXIgcHVibGlzaGVyQ29uZmlnID0gY29uZmlnUHJvdmlkZXIoKTsKICAgICAgICB0aGlzLnByb3RvdHlwZS5wdWJsaXNoZXIgPSBuZXcgUHVibGlzaGVyKHB1Ymxpc2hlckNvbmZpZyk7CiAgICAgICAgaWYgKHB1Ymxpc2hlckNvbmZpZy5lbmFibGVkKSB7CiAgICAgICAgICAvL2lmIGNzbSBpcyBlbmFibGVkIGluIGVudmlyb25tZW50LCBTREsgc2hvdWxkIHNlbmQgYWxsIG1ldHJpY3MKICAgICAgICAgIEFXUy5TZXJ2aWNlLl9jbGllbnRTaWRlTW9uaXRvcmluZyA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbChzdmMucHJvdG90eXBlKTsKICAgICAgQVdTLlNlcnZpY2UuYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnMoc3ZjLnByb3RvdHlwZSk7CiAgICAgIHJldHVybiBzdmM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgYWRkVmVyc2lvbnM6IGZ1bmN0aW9uIGFkZFZlcnNpb25zKHN2YywgdmVyc2lvbnMpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZlcnNpb25zKSkgdmVyc2lvbnMgPSBbdmVyc2lvbnNdOwogIAogICAgICBzdmMuc2VydmljZXMgPSBzdmMuc2VydmljZXMgfHwge307CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmVyc2lvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoc3ZjLnNlcnZpY2VzW3ZlcnNpb25zW2ldXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzdmMuc2VydmljZXNbdmVyc2lvbnNbaV1dID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAKICAgICAgc3ZjLmFwaVZlcnNpb25zID0gT2JqZWN0LmtleXMoc3ZjLnNlcnZpY2VzKS5zb3J0KCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmaW5lU2VydmljZUFwaTogZnVuY3Rpb24gZGVmaW5lU2VydmljZUFwaShzdXBlcmNsYXNzLCB2ZXJzaW9uLCBhcGlDb25maWcpIHsKICAgICAgdmFyIHN2YyA9IGluaGVyaXQoc3VwZXJjbGFzcywgewogICAgICAgIHNlcnZpY2VJZGVudGlmaWVyOiBzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyCiAgICAgIH0pOwogIAogICAgICBmdW5jdGlvbiBzZXRBcGkoYXBpKSB7CiAgICAgICAgaWYgKGFwaS5pc0FwaSkgewogICAgICAgICAgc3ZjLnByb3RvdHlwZS5hcGkgPSBhcGk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN2Yy5wcm90b3R5cGUuYXBpID0gbmV3IEFwaShhcGkpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAodHlwZW9mIHZlcnNpb24gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgaWYgKGFwaUNvbmZpZykgewogICAgICAgICAgc2V0QXBpKGFwaUNvbmZpZyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEFwaShBV1MuYXBpTG9hZGVyKHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIsIHZlcnNpb24pKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihlcnIsIHsKICAgICAgICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IGZpbmQgQVBJIGNvbmZpZ3VyYXRpb24gJyArCiAgICAgICAgICAgICAgICBzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyICsgJy0nICsgdmVyc2lvbgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc3VwZXJjbGFzcy5zZXJ2aWNlcywgdmVyc2lvbikpIHsKICAgICAgICAgIHN1cGVyY2xhc3MuYXBpVmVyc2lvbnMgPSBzdXBlcmNsYXNzLmFwaVZlcnNpb25zLmNvbmNhdCh2ZXJzaW9uKS5zb3J0KCk7CiAgICAgICAgfQogICAgICAgIHN1cGVyY2xhc3Muc2VydmljZXNbdmVyc2lvbl0gPSBzdmM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0QXBpKHZlcnNpb24pOwogICAgICB9CiAgCiAgICAgIEFXUy5TZXJ2aWNlLmRlZmluZU1ldGhvZHMoc3ZjKTsKICAgICAgcmV0dXJuIHN2YzsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBoYXNTZXJ2aWNlOiBmdW5jdGlvbihpZGVudGlmaWVyKSB7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoQVdTLlNlcnZpY2UuX3NlcnZpY2VNYXAsIGlkZW50aWZpZXIpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQHBhcmFtIGF0dGFjaE9uIGF0dGFjaCBkZWZhdWx0IG1vbml0b3JpbmcgbGlzdGVuZXJzIHRvIG9iamVjdAogICAgICoKICAgICAqIEVhY2ggbW9uaXRvcmluZyBldmVudCBzaG91bGQgYmUgZW1pdHRlZCBmcm9tIHNlcnZpY2UgY2xpZW50IHRvIHNlcnZpY2UgY29uc3RydWN0b3IgcHJvdG90eXBlIGFuZCB0aGVuCiAgICAgKiB0byBnbG9iYWwgc2VydmljZSBwcm90b3R5cGUgbGlrZSBidWJibGluZyB1cC4gVGhlc2UgZGVmYXVsdCBtb25pdG9yaW5nIGV2ZW50cyBsaXN0ZW5lciB3aWxsIHRyYW5zZmVyCiAgICAgKiB0aGUgbW9uaXRvcmluZyBldmVudHMgdG8gdGhlIHVwcGVyIGxheWVyLgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzOiBmdW5jdGlvbiBhZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyhhdHRhY2hPbikgewogICAgICBhdHRhY2hPbi5hZGROYW1lZExpc3RlbmVyKCdNT05JVE9SX0VWRU5UU19CVUJCTEUnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBFVkVOVFNfQlVCQkxFKGV2ZW50KSB7CiAgICAgICAgdmFyIGJhc2VDbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihhdHRhY2hPbik7CiAgICAgICAgaWYgKGJhc2VDbGFzcy5fZXZlbnRzKSBiYXNlQ2xhc3MuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbZXZlbnRdKTsKICAgICAgfSk7CiAgICAgIGF0dGFjaE9uLmFkZE5hbWVkTGlzdGVuZXIoJ0NBTExfRVZFTlRTX0JVQkJMRScsICdhcGlDYWxsJywgZnVuY3Rpb24gQ0FMTF9FVkVOVFNfQlVCQkxFKGV2ZW50KSB7CiAgICAgICAgdmFyIGJhc2VDbGFzcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihhdHRhY2hPbik7CiAgICAgICAgaWYgKGJhc2VDbGFzcy5fZXZlbnRzKSBiYXNlQ2xhc3MuZW1pdCgnYXBpQ2FsbCcsIFtldmVudF0pOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBfc2VydmljZU1hcDoge30KICB9KTsKICAKICBBV1MudXRpbC5taXhpbihBV1MuU2VydmljZSwgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcik7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2VydmljZTsKICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCiAgfSx7Ii4vY29yZSI6MTgsIi4vbW9kZWwvYXBpIjozOCwiLi9yZWdpb25fY29uZmlnIjo1MywiX3Byb2Nlc3MiOjg2fV0sNjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgQVdTLnV0aWwudXBkYXRlKEFXUy5Db2duaXRvSWRlbnRpdHkucHJvdG90eXBlLCB7CiAgICBnZXRPcGVuSWRUb2tlbjogZnVuY3Rpb24gZ2V0T3BlbklkVG9rZW4ocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnZ2V0T3BlbklkVG9rZW4nLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICBnZXRJZDogZnVuY3Rpb24gZ2V0SWQocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnZ2V0SWQnLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0sCiAgCiAgICBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5OiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5KHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2dldENyZWRlbnRpYWxzRm9ySWRlbnRpdHknLCBwYXJhbXMsIGNhbGxiYWNrKTsKICAgIH0KICB9KTsKICAKICB9LHsiLi4vY29yZSI6MTh9XSw2MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgcmVnaW9uQ29uZmlnID0gcmVxdWlyZSgnLi4vcmVnaW9uX2NvbmZpZycpOwogIHZhciBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCA9ICdBV1NfU1RTX1JFR0lPTkFMX0VORFBPSU5UUyc7CiAgdmFyIENPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEID0gJ3N0c19yZWdpb25hbF9lbmRwb2ludHMnOwogIAogIEFXUy51dGlsLnVwZGF0ZShBV1MuU1RTLnByb3RvdHlwZSwgewogICAgLyoqCiAgICAgKiBAb3ZlcmxvYWQgY3JlZGVudGlhbHNGcm9tKGRhdGEsIGNyZWRlbnRpYWxzID0gbnVsbCkKICAgICAqICAgQ3JlYXRlcyBhIGNyZWRlbnRpYWxzIG9iamVjdCBmcm9tIFNUUyByZXNwb25zZSBkYXRhIGNvbnRhaW5pbmcKICAgICAqICAgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24uIFVzZWZ1bCBmb3IgcXVpY2tseSBzZXR0aW5nIEFXUyBjcmVkZW50aWFscy4KICAgICAqCiAgICAgKiAgIEBub3RlIFRoaXMgaXMgYSBsb3ctbGV2ZWwgdXRpbGl0eSBmdW5jdGlvbi4gSWYgeW91IHdhbnQgdG8gbG9hZCB0ZW1wb3JhcnkKICAgICAqICAgICBjcmVkZW50aWFscyBpbnRvIHlvdXIgcHJvY2VzcyBmb3Igc3Vic2VxdWVudCByZXF1ZXN0cyB0byBBV1MgcmVzb3VyY2VzLAogICAgICogICAgIHlvdSBzaG91bGQgdXNlIHtBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHN9IGluc3RlYWQuCiAgICAgKiAgIEBwYXJhbSBkYXRhIFttYXBdIGRhdGEgcmV0cmlldmVkIGZyb20gYSBjYWxsIHRvIHtnZXRGZWRlcmF0ZWRUb2tlbn0sCiAgICAgKiAgICAge2dldFNlc3Npb25Ub2tlbn0sIHthc3N1bWVSb2xlfSwgb3Ige2Fzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LgogICAgICogICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gYW4gb3B0aW9uYWwgY3JlZGVudGlhbHMgb2JqZWN0IHRvCiAgICAgKiAgICAgZmlsbCBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9iamVjdC4gVXNlZnVsIHdoZW4gbW9kaWZ5aW5nIGFuCiAgICAgKiAgICAgZXhpc3RpbmcgY3JlZGVudGlhbHMgb2JqZWN0IGZyb20gYSByZWZyZXNoIGNhbGwuCiAgICAgKiAgIEByZXR1cm4gW0FXUy5UZW1wb3JhcnlDcmVkZW50aWFsc10gdGhlIHNldCBvZiB0ZW1wb3JhcnkgY3JlZGVudGlhbHMKICAgICAqICAgICBsb2FkZWQgZnJvbSBhIHJhdyBTVFMgb3BlcmF0aW9uIHJlc3BvbnNlLgogICAgICogICBAZXhhbXBsZSBVc2luZyBjcmVkZW50aWFsc0Zyb20gdG8gbG9hZCBnbG9iYWwgQVdTIGNyZWRlbnRpYWxzCiAgICAgKiAgICAgdmFyIHN0cyA9IG5ldyBBV1MuU1RTKCk7CiAgICAgKiAgICAgc3RzLmdldFNlc3Npb25Ub2tlbihmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgKiAgICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZygiRXJyb3IgZ2V0dGluZyBjcmVkZW50aWFscyIpOwogICAgICogICAgICAgZWxzZSB7CiAgICAgKiAgICAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBzdHMuY3JlZGVudGlhbHNGcm9tKGRhdGEpOwogICAgICogICAgICAgfQogICAgICogICAgIH0pOwogICAgICogICBAc2VlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscwogICAgICovCiAgICBjcmVkZW50aWFsc0Zyb206IGZ1bmN0aW9uIGNyZWRlbnRpYWxzRnJvbShkYXRhLCBjcmVkZW50aWFscykgewogICAgICBpZiAoIWRhdGEpIHJldHVybiBudWxsOwogICAgICBpZiAoIWNyZWRlbnRpYWxzKSBjcmVkZW50aWFscyA9IG5ldyBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMoKTsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlZCA9IGZhbHNlOwogICAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCA9IGRhdGEuQ3JlZGVudGlhbHMuQWNjZXNzS2V5SWQ7CiAgICAgIGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSA9IGRhdGEuQ3JlZGVudGlhbHMuU2VjcmV0QWNjZXNzS2V5OwogICAgICBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4gPSBkYXRhLkNyZWRlbnRpYWxzLlNlc3Npb25Ub2tlbjsKICAgICAgY3JlZGVudGlhbHMuZXhwaXJlVGltZSA9IGRhdGEuQ3JlZGVudGlhbHMuRXhwaXJhdGlvbjsKICAgICAgcmV0dXJuIGNyZWRlbnRpYWxzOwogICAgfSwKICAKICAgIGFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHk6IGZ1bmN0aW9uIGFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkocGFyYW1zLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdCgnYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eScsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIGFzc3VtZVJvbGVXaXRoU0FNTDogZnVuY3Rpb24gYXNzdW1lUm9sZVdpdGhTQU1MKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2Fzc3VtZVJvbGVXaXRoU0FNTCcsIHBhcmFtcywgY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWU6IGZ1bmN0aW9uIHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoY29uZmlnVmFsdWUsIGVycm9yT3B0aW9ucykgewogICAgICBpZiAodHlwZW9mIGNvbmZpZ1ZhbHVlID09PSAnc3RyaW5nJyAmJiBbJ2xlZ2FjeScsICdyZWdpb25hbCddLmluZGV4T2YoY29uZmlnVmFsdWUudG9Mb3dlckNhc2UoKSkgPj0gMCkgewogICAgICAgIHRoaXMuY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzID0gY29uZmlnVmFsdWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIGVycm9yT3B0aW9ucyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICB2YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZzogZnVuY3Rpb24gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWcoKSB7CiAgICAgIC8vdmFsaWRhdGUgY29uZmlnIHZhbHVlCiAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZzsKICAgICAgaWYgKGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cykgewogICAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMsIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkQ29uZmlndXJhdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnaW52YWxpZCAic3RzUmVnaW9uYWxFbmRwb2ludHMiIGNvbmZpZ3VyYXRpb24uIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzICsgJyIuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghQVdTLnV0aWwuaXNOb2RlKCkpIHJldHVybjsKICAgICAgLy92YWxpZGF0ZSBlbnZpcm9ubWVudGFsIHZhcmlhYmxlCiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocHJvY2Vzcy5lbnYsIEVOVl9SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEKSkgewogICAgICAgIHZhciBlbnZGbGFnID0gcHJvY2Vzcy5lbnZbRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdOwogICAgICAgIHRoaXMudmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShlbnZGbGFnLCB7CiAgICAgICAgICBjb2RlOiAnSW52YWxpZEVudmlyb25tZW50YWxWYXJpYWJsZScsCiAgICAgICAgICBtZXNzYWdlOiAnaW52YWxpZCAnICsgRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRUQgKyAnIGVudmlyb25tZW50YWwgdmFyaWFibGUuIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgcHJvY2Vzcy5lbnZbRU5WX1JFR0lPTkFMX0VORFBPSU5UX0VOQUJMRURdICsgJyIuJwogICAgICAgIH0pOwogICAgICB9CiAgICAgIC8vdmFsaWRhdGUgc2hhcmVkIGNvbmZpZyBmaWxlCiAgICAgIHZhciBwcm9maWxlID0ge307CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHByb2ZpbGVzID0gQVdTLnV0aWwuZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnKEFXUy51dGlsLmluaUxvYWRlcik7CiAgICAgICAgcHJvZmlsZSA9IHByb2ZpbGVzW3Byb2Nlc3MuZW52LkFXU19QUk9GSUxFIHx8IEFXUy51dGlsLmRlZmF1bHRQcm9maWxlXTsKICAgICAgfSBjYXRjaCAoZSkge307CiAgICAgIGlmIChwcm9maWxlICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9maWxlLCBDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCkpIHsKICAgICAgICB2YXIgZmlsZUZsYWcgPSBwcm9maWxlW0NPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEXTsKICAgICAgICB0aGlzLnZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoZmlsZUZsYWcsIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkQ29uZmlndXJhdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnaW52YWxpZCAnK0NPTkZJR19SRUdJT05BTF9FTkRQT0lOVF9FTkFCTEVEKycgcHJvZmlsZSBjb25maWcuIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgcHJvZmlsZVtDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRF0gKyAnIi4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBvcHRJblJlZ2lvbmFsRW5kcG9pbnQ6IGZ1bmN0aW9uIG9wdEluUmVnaW9uYWxFbmRwb2ludCgpIHsKICAgICAgdGhpcy52YWxpZGF0ZVJlZ2lvbmFsRW5kcG9pbnRzRmxhZygpOwogICAgICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgICAgIGlmIChjb25maWcuc3RzUmVnaW9uYWxFbmRwb2ludHMgPT09ICdyZWdpb25hbCcpIHsKICAgICAgICByZWdpb25Db25maWcodGhpcyk7CiAgICAgICAgaWYgKCF0aGlzLmlzR2xvYmFsRW5kcG9pbnQpIHJldHVybjsKICAgICAgICB0aGlzLmlzR2xvYmFsRW5kcG9pbnQgPSBmYWxzZTsKICAgICAgICAvL2NsaWVudCB3aWxsIHRocm93IGlmIHJlZ2lvbiBpcyBub3Qgc3VwcGxpZWQ7IHJlcXVlc3Qgd2lsbCBiZSBzaWduZWQgd2l0aCBzcGVjaWZpZWQgcmVnaW9uCiAgICAgICAgaWYgKCFjb25maWcucmVnaW9uKSB7CiAgICAgICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdDb25maWdFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIHJlZ2lvbiBpbiBjb25maWcnfSk7CiAgICAgICAgfQogICAgICAgIHZhciBpbnNlcnRQb2ludCA9IGNvbmZpZy5lbmRwb2ludC5pbmRleE9mKCcuYW1hem9uYXdzLmNvbScpOwogICAgICAgIGNvbmZpZy5lbmRwb2ludCA9IGNvbmZpZy5lbmRwb2ludC5zdWJzdHJpbmcoMCwgaW5zZXJ0UG9pbnQpICsKICAgICAgICAgICcuJyArIGNvbmZpZy5yZWdpb24gKyBjb25maWcuZW5kcG9pbnQuc3Vic3RyaW5nKGluc2VydFBvaW50KTsKICAgICAgfQogICAgfSwKICAKICAgIHZhbGlkYXRlU2VydmljZTogZnVuY3Rpb24gdmFsaWRhdGVTZXJ2aWNlKCkgewogICAgICB0aGlzLm9wdEluUmVnaW9uYWxFbmRwb2ludCgpOwogICAgfQogIAogIH0pOwogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKICB9LHsiLi4vY29yZSI6MTgsIi4uL3JlZ2lvbl9jb25maWciOjUzLCJfcHJvY2VzcyI6ODZ9XSw2MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGV4cGlyZXNIZWFkZXIgPSAncHJlc2lnbmVkLWV4cGlyZXMnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNpZ25lZFVybEJ1aWxkZXIocmVxdWVzdCkgewogICAgdmFyIGV4cGlyZXMgPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl07CiAgICB2YXIgc2lnbmVyQ2xhc3MgPSByZXF1ZXN0LnNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCk7CiAgCiAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydVc2VyLUFnZW50J107CiAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Vc2VyLUFnZW50J107CiAgCiAgICBpZiAoc2lnbmVyQ2xhc3MgPT09IEFXUy5TaWduZXJzLlY0KSB7CiAgICAgIGlmIChleHBpcmVzID4gNjA0ODAwKSB7IC8vIG9uZSB3ZWVrIGV4cGlyeSBpcyBpbnZhbGlkCiAgICAgICAgdmFyIG1lc3NhZ2UgPSAnUHJlc2lnbmluZyBkb2VzIG5vdCBzdXBwb3J0IGV4cGlyeSB0aW1lIGdyZWF0ZXIgJyArCiAgICAgICAgICAgICAgICAgICAgICAndGhhbiBhIHdlZWsgd2l0aCBTaWdWNCBzaWduaW5nLic7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdJbnZhbGlkRXhwaXJ5VGltZScsIG1lc3NhZ2U6IG1lc3NhZ2UsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBleHBpcmVzOwogICAgfSBlbHNlIGlmIChzaWduZXJDbGFzcyA9PT0gQVdTLlNpZ25lcnMuUzMpIHsKICAgICAgdmFyIG5vdyA9IHJlcXVlc3Quc2VydmljZSA/IHJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIDogQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCk7CiAgICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSA9IHBhcnNlSW50KAogICAgICAgIEFXUy51dGlsLmRhdGUudW5peFRpbWVzdGFtcChub3cpICsgZXhwaXJlcywgMTApLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICAgIG1lc3NhZ2U6ICdQcmVzaWduaW5nIG9ubHkgc3VwcG9ydHMgUzMgb3IgU2lnVjQgc2lnbmluZy4nLAogICAgICAgIGNvZGU6ICdVbnN1cHBvcnRlZFNpZ25lcicsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgfSk7CiAgICB9CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIHNpZ25lZFVybFNpZ25lcihyZXF1ZXN0KSB7CiAgICB2YXIgZW5kcG9pbnQgPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50OwogICAgdmFyIHBhcnNlZFVybCA9IEFXUy51dGlsLnVybFBhcnNlKHJlcXVlc3QuaHR0cFJlcXVlc3QucGF0aCk7CiAgICB2YXIgcXVlcnlQYXJhbXMgPSB7fTsKICAKICAgIGlmIChwYXJzZWRVcmwuc2VhcmNoKSB7CiAgICAgIHF1ZXJ5UGFyYW1zID0gQVdTLnV0aWwucXVlcnlTdHJpbmdQYXJzZShwYXJzZWRVcmwuc2VhcmNoLnN1YnN0cigxKSk7CiAgICB9CiAgCiAgICB2YXIgYXV0aCA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddLnNwbGl0KCcgJyk7CiAgICBpZiAoYXV0aFswXSA9PT0gJ0FXUycpIHsKICAgICAgYXV0aCA9IGF1dGhbMV0uc3BsaXQoJzonKTsKICAgICAgcXVlcnlQYXJhbXNbJ0FXU0FjY2Vzc0tleUlkJ10gPSBhdXRoWzBdOwogICAgICBxdWVyeVBhcmFtc1snU2lnbmF0dXJlJ10gPSBhdXRoWzFdOwogIAogICAgICBBV1MudXRpbC5lYWNoKHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ID09PSBleHBpcmVzSGVhZGVyKSBrZXkgPSAnRXhwaXJlcyc7CiAgICAgICAgaWYgKGtleS5pbmRleE9mKCd4LWFtei1tZXRhLScpID09PSAwKSB7CiAgICAgICAgICAvLyBEZWxldGUgZXhpc3RpbmcsIHBvdGVudGlhbGx5IG5vdCBub3JtYWxpemVkIGtleQogICAgICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zW2tleV07CiAgICAgICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CiAgICAgICAgcXVlcnlQYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXTsKICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydBdXRob3JpemF0aW9uJ107CiAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snSG9zdCddOwogICAgfSBlbHNlIGlmIChhdXRoWzBdID09PSAnQVdTNC1ITUFDLVNIQTI1NicpIHsgLy8gU2lnVjQgc2lnbmluZwogICAgICBhdXRoLnNoaWZ0KCk7CiAgICAgIHZhciByZXN0ID0gYXV0aC5qb2luKCcgJyk7CiAgICAgIHZhciBzaWduYXR1cmUgPSByZXN0Lm1hdGNoKC9TaWduYXR1cmU9KC4qPykoPzosfFxzfFxyP1xufCQpLylbMV07CiAgICAgIHF1ZXJ5UGFyYW1zWydYLUFtei1TaWduYXR1cmUnXSA9IHNpZ25hdHVyZTsKICAgICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydFeHBpcmVzJ107CiAgICB9CiAgCiAgICAvLyBidWlsZCBVUkwKICAgIGVuZHBvaW50LnBhdGhuYW1lID0gcGFyc2VkVXJsLnBhdGhuYW1lOwogICAgZW5kcG9pbnQuc2VhcmNoID0gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxdWVyeVBhcmFtcyk7CiAgfQogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlByZXNpZ24gPSBpbmhlcml0KHsKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIHNpZ246IGZ1bmN0aW9uIHNpZ24ocmVxdWVzdCwgZXhwaXJlVGltZSwgY2FsbGJhY2spIHsKICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gZXhwaXJlVGltZSB8fCAzNjAwOwogICAgICByZXF1ZXN0Lm9uKCdidWlsZCcsIHNpZ25lZFVybEJ1aWxkZXIpOwogICAgICByZXF1ZXN0Lm9uKCdzaWduJywgc2lnbmVkVXJsU2lnbmVyKTsKICAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignYWZ0ZXJCdWlsZCcsCiAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VUX0NPTlRFTlRfTEVOR1RIKTsKICAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignYWZ0ZXJCdWlsZCcsCiAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuQ09NUFVURV9TSEEyNTYpOwogIAogICAgICByZXF1ZXN0LmVtaXQoJ2JlZm9yZVByZXNpZ24nLCBbcmVxdWVzdF0pOwogIAogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICByZXF1ZXN0LmJ1aWxkKGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHRoaXMucmVzcG9uc2UuZXJyb3IpIGNhbGxiYWNrKHRoaXMucmVzcG9uc2UuZXJyb3IpOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIEFXUy51dGlsLnVybEZvcm1hdChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50KSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVxdWVzdC5idWlsZCgpOwogICAgICAgIGlmIChyZXF1ZXN0LnJlc3BvbnNlLmVycm9yKSB0aHJvdyByZXF1ZXN0LnJlc3BvbnNlLmVycm9yOwogICAgICAgIHJldHVybiBBV1MudXRpbC51cmxGb3JtYXQocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludCk7CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IEFXUy5TaWduZXJzLlByZXNpZ247CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgCiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIgPSBpbmhlcml0KHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXF1ZXN0U2lnbmVyKHJlcXVlc3QpIHsKICAgICAgdGhpcy5yZXF1ZXN0ID0gcmVxdWVzdDsKICAgIH0sCiAgCiAgICBzZXRTZXJ2aWNlQ2xpZW50SWQ6IGZ1bmN0aW9uIHNldFNlcnZpY2VDbGllbnRJZChpZCkgewogICAgICB0aGlzLnNlcnZpY2VDbGllbnRJZCA9IGlkOwogICAgfSwKICAKICAgIGdldFNlcnZpY2VDbGllbnRJZDogZnVuY3Rpb24gZ2V0U2VydmljZUNsaWVudElkKCkgewogICAgICByZXR1cm4gdGhpcy5zZXJ2aWNlQ2xpZW50SWQ7CiAgICB9CiAgfSk7CiAgCiAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5nZXRWZXJzaW9uID0gZnVuY3Rpb24gZ2V0VmVyc2lvbih2ZXJzaW9uKSB7CiAgICBzd2l0Y2ggKHZlcnNpb24pIHsKICAgICAgY2FzZSAndjInOiByZXR1cm4gQVdTLlNpZ25lcnMuVjI7CiAgICAgIGNhc2UgJ3YzJzogcmV0dXJuIEFXUy5TaWduZXJzLlYzOwogICAgICBjYXNlICdzM3Y0JzogcmV0dXJuIEFXUy5TaWduZXJzLlY0OwogICAgICBjYXNlICd2NCc6IHJldHVybiBBV1MuU2lnbmVycy5WNDsKICAgICAgY2FzZSAnczMnOiByZXR1cm4gQVdTLlNpZ25lcnMuUzM7CiAgICAgIGNhc2UgJ3YzaHR0cHMnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjNIdHRwczsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBzaWduaW5nIHZlcnNpb24gJyArIHZlcnNpb24pOwogIH07CiAgCiAgcmVxdWlyZSgnLi92MicpOwogIHJlcXVpcmUoJy4vdjMnKTsKICByZXF1aXJlKCcuL3YzaHR0cHMnKTsKICByZXF1aXJlKCcuL3Y0Jyk7CiAgcmVxdWlyZSgnLi9zMycpOwogIHJlcXVpcmUoJy4vcHJlc2lnbicpOwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi9wcmVzaWduIjo2MiwiLi9zMyI6NjQsIi4vdjIiOjY1LCIuL3YzIjo2NiwiLi92M2h0dHBzIjo2NywiLi92NCI6Njh9XSw2NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgQVdTLlNpZ25lcnMuUzMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAgIC8qKgogICAgICogV2hlbiBidWlsZGluZyB0aGUgc3RyaW5nVG9TaWduLCB0aGVzZSBzdWIgcmVzb3VyY2UgcGFyYW1zIHNob3VsZCBiZQogICAgICogcGFydCBvZiB0aGUgY2Fub25pY2FsIHJlc291cmNlIHN0cmluZyB3aXRoIHRoZWlyIE5PTi1kZWNvZGVkIHZhbHVlcwogICAgICovCiAgICBzdWJSZXNvdXJjZXM6IHsKICAgICAgJ2FjbCc6IDEsCiAgICAgICdhY2NlbGVyYXRlJzogMSwKICAgICAgJ2FuYWx5dGljcyc6IDEsCiAgICAgICdjb3JzJzogMSwKICAgICAgJ2xpZmVjeWNsZSc6IDEsCiAgICAgICdkZWxldGUnOiAxLAogICAgICAnaW52ZW50b3J5JzogMSwKICAgICAgJ2xvY2F0aW9uJzogMSwKICAgICAgJ2xvZ2dpbmcnOiAxLAogICAgICAnbWV0cmljcyc6IDEsCiAgICAgICdub3RpZmljYXRpb24nOiAxLAogICAgICAncGFydE51bWJlcic6IDEsCiAgICAgICdwb2xpY3knOiAxLAogICAgICAncmVxdWVzdFBheW1lbnQnOiAxLAogICAgICAncmVwbGljYXRpb24nOiAxLAogICAgICAncmVzdG9yZSc6IDEsCiAgICAgICd0YWdnaW5nJzogMSwKICAgICAgJ3RvcnJlbnQnOiAxLAogICAgICAndXBsb2FkSWQnOiAxLAogICAgICAndXBsb2Fkcyc6IDEsCiAgICAgICd2ZXJzaW9uSWQnOiAxLAogICAgICAndmVyc2lvbmluZyc6IDEsCiAgICAgICd2ZXJzaW9ucyc6IDEsCiAgICAgICd3ZWJzaXRlJzogMQogICAgfSwKICAKICAgIC8vIHdoZW4gYnVpbGRpbmcgdGhlIHN0cmluZ1RvU2lnbiwgdGhlc2UgcXVlcnlzdHJpbmcgcGFyYW1zIHNob3VsZCBiZQogICAgLy8gcGFydCBvZiB0aGUgY2Fub25pY2FsIHJlc291cmNlIHN0cmluZyB3aXRoIHRoZWlyIE5PTi1lbmNvZGVkIHZhbHVlcwogICAgcmVzcG9uc2VIZWFkZXJzOiB7CiAgICAgICdyZXNwb25zZS1jb250ZW50LXR5cGUnOiAxLAogICAgICAncmVzcG9uc2UtY29udGVudC1sYW5ndWFnZSc6IDEsCiAgICAgICdyZXNwb25zZS1leHBpcmVzJzogMSwKICAgICAgJ3Jlc3BvbnNlLWNhY2hlLWNvbnRyb2wnOiAxLAogICAgICAncmVzcG9uc2UtY29udGVudC1kaXNwb3NpdGlvbic6IDEsCiAgICAgICdyZXNwb25zZS1jb250ZW50LWVuY29kaW5nJzogMQogICAgfSwKICAKICAgIGFkZEF1dGhvcml6YXRpb246IGZ1bmN0aW9uIGFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpIHsKICAgICAgaWYgKCF0aGlzLnJlcXVlc3QuaGVhZGVyc1sncHJlc2lnbmVkLWV4cGlyZXMnXSkgewogICAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBBV1MudXRpbC5kYXRlLnJmYzgyMihkYXRlKTsKICAgICAgfQogIAogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgLy8gcHJlc2lnbmVkIFVSTHMgcmVxdWlyZSB0aGlzIGhlYWRlciB0byBiZSBsb3dlcmNhc2VkCiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAKICAgICAgdmFyIHNpZ25hdHVyZSA9IHRoaXMuc2lnbihjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIHRoaXMuc3RyaW5nVG9TaWduKCkpOwogICAgICB2YXIgYXV0aCA9ICdBV1MgJyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJzonICsgc2lnbmF0dXJlOwogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQXV0aG9yaXphdGlvbiddID0gYXV0aDsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CiAgCiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKHIubWV0aG9kKTsKICAgICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10gfHwgJycpOwogICAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gfHwgJycpOwogIAogICAgICAvLyBUaGlzIGlzIHRoZSAiRGF0ZSIgaGVhZGVyLCBidXQgd2UgdXNlIFgtQW16LURhdGUuCiAgICAgIC8vIFRoZSBTMyBzaWduaW5nIG1lY2hhbmlzbSByZXF1aXJlcyB1cyB0byBwYXNzIGFuIGVtcHR5CiAgICAgIC8vIHN0cmluZyBmb3IgdGhpcyBEYXRlIGhlYWRlciByZWdhcmRsZXNzLgogICAgICBwYXJ0cy5wdXNoKHIuaGVhZGVyc1sncHJlc2lnbmVkLWV4cGlyZXMnXSB8fCAnJyk7CiAgCiAgICAgIHZhciBoZWFkZXJzID0gdGhpcy5jYW5vbmljYWxpemVkQW16SGVhZGVycygpOwogICAgICBpZiAoaGVhZGVycykgcGFydHMucHVzaChoZWFkZXJzKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmNhbm9uaWNhbGl6ZWRSZXNvdXJjZSgpKTsKICAKICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJ1xuJyk7CiAgCiAgICB9LAogIAogICAgY2Fub25pY2FsaXplZEFtekhlYWRlcnM6IGZ1bmN0aW9uIGNhbm9uaWNhbGl6ZWRBbXpIZWFkZXJzKCkgewogIAogICAgICB2YXIgYW16SGVhZGVycyA9IFtdOwogIAogICAgICBBV1MudXRpbC5lYWNoKHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGlmIChuYW1lLm1hdGNoKC9eeC1hbXotL2kpKQogICAgICAgICAgYW16SGVhZGVycy5wdXNoKG5hbWUpOwogICAgICB9KTsKICAKICAgICAgYW16SGVhZGVycy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEudG9Mb3dlckNhc2UoKSA8IGIudG9Mb3dlckNhc2UoKSA/IC0xIDogMTsKICAgICAgfSk7CiAgCiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBhbXpIZWFkZXJzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHBhcnRzLnB1c2gobmFtZS50b0xvd2VyQ2FzZSgpICsgJzonICsgU3RyaW5nKHRoaXMucmVxdWVzdC5oZWFkZXJzW25hbWVdKSk7CiAgICAgIH0pOwogIAogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAKICAgIH0sCiAgCiAgICBjYW5vbmljYWxpemVkUmVzb3VyY2U6IGZ1bmN0aW9uIGNhbm9uaWNhbGl6ZWRSZXNvdXJjZSgpIHsKICAKICAgICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CiAgCiAgICAgIHZhciBwYXJ0cyA9IHIucGF0aC5zcGxpdCgnPycpOwogICAgICB2YXIgcGF0aCA9IHBhcnRzWzBdOwogICAgICB2YXIgcXVlcnlzdHJpbmcgPSBwYXJ0c1sxXTsKICAKICAgICAgdmFyIHJlc291cmNlID0gJyc7CiAgCiAgICAgIGlmIChyLnZpcnR1YWxIb3N0ZWRCdWNrZXQpCiAgICAgICAgcmVzb3VyY2UgKz0gJy8nICsgci52aXJ0dWFsSG9zdGVkQnVja2V0OwogIAogICAgICByZXNvdXJjZSArPSBwYXRoOwogIAogICAgICBpZiAocXVlcnlzdHJpbmcpIHsKICAKICAgICAgICAvLyBjb2xsZWN0IGEgbGlzdCBvZiBzdWIgcmVzb3VyY2VzIGFuZCBxdWVyeSBwYXJhbXMgdGhhdCBuZWVkIHRvIGJlIHNpZ25lZAogICAgICAgIHZhciByZXNvdXJjZXMgPSBbXTsKICAKICAgICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBxdWVyeXN0cmluZy5zcGxpdCgnJicpLCBmdW5jdGlvbiAocGFyYW0pIHsKICAgICAgICAgIHZhciBuYW1lID0gcGFyYW0uc3BsaXQoJz0nKVswXTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcmFtLnNwbGl0KCc9JylbMV07CiAgICAgICAgICBpZiAodGhpcy5zdWJSZXNvdXJjZXNbbmFtZV0gfHwgdGhpcy5yZXNwb25zZUhlYWRlcnNbbmFtZV0pIHsKICAgICAgICAgICAgdmFyIHN1YnJlc291cmNlID0geyBuYW1lOiBuYW1lIH07CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuc3ViUmVzb3VyY2VzW25hbWVdKSB7CiAgICAgICAgICAgICAgICBzdWJyZXNvdXJjZS52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdWJyZXNvdXJjZS52YWx1ZSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc291cmNlcy5wdXNoKHN1YnJlc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAKICAgICAgICByZXNvdXJjZXMuc29ydChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gYS5uYW1lIDwgYi5uYW1lID8gLTEgOiAxOyB9KTsKICAKICAgICAgICBpZiAocmVzb3VyY2VzLmxlbmd0aCkgewogIAogICAgICAgICAgcXVlcnlzdHJpbmcgPSBbXTsKICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChyZXNvdXJjZXMsIGZ1bmN0aW9uIChyZXMpIHsKICAgICAgICAgICAgaWYgKHJlcy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgcXVlcnlzdHJpbmcucHVzaChyZXMubmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcXVlcnlzdHJpbmcucHVzaChyZXMubmFtZSArICc9JyArIHJlcy52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogIAogICAgICAgICAgcmVzb3VyY2UgKz0gJz8nICsgcXVlcnlzdHJpbmcuam9pbignJicpOwogICAgICAgIH0KICAKICAgICAgfQogIAogICAgICByZXR1cm4gcmVzb3VyY2U7CiAgCiAgICB9LAogIAogICAgc2lnbjogZnVuY3Rpb24gc2lnbihzZWNyZXQsIHN0cmluZykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoc2VjcmV0LCBzdHJpbmcsICdiYXNlNjQnLCAnc2hhMScpOwogICAgfQogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuUzM7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlYyID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgCiAgICAgIGlmICghZGF0ZSkgZGF0ZSA9IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpOwogIAogICAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKICAKICAgICAgci5wYXJhbXMuVGltZXN0YW1wID0gQVdTLnV0aWwuZGF0ZS5pc284NjAxKGRhdGUpOwogICAgICByLnBhcmFtcy5TaWduYXR1cmVWZXJzaW9uID0gJzInOwogICAgICByLnBhcmFtcy5TaWduYXR1cmVNZXRob2QgPSAnSG1hY1NIQTI1Nic7CiAgICAgIHIucGFyYW1zLkFXU0FjY2Vzc0tleUlkID0gY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICByLnBhcmFtcy5TZWN1cml0eVRva2VuID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgICB9CiAgCiAgICAgIGRlbGV0ZSByLnBhcmFtcy5TaWduYXR1cmU7IC8vIGRlbGV0ZSBvbGQgU2lnbmF0dXJlIGZvciByZS1zaWduaW5nCiAgICAgIHIucGFyYW1zLlNpZ25hdHVyZSA9IHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICAKICAgICAgci5ib2R5ID0gQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhyLnBhcmFtcyk7CiAgICAgIHIuaGVhZGVyc1snQ29udGVudC1MZW5ndGgnXSA9IHIuYm9keS5sZW5ndGg7CiAgICB9LAogIAogICAgc2lnbmF0dXJlOiBmdW5jdGlvbiBzaWduYXR1cmUoY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSwgJ2Jhc2U2NCcpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QubWV0aG9kKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QuZW5kcG9pbnQuaG9zdC50b0xvd2VyQ2FzZSgpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QucGF0aG5hbWUoKSk7CiAgICAgIHBhcnRzLnB1c2goQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyh0aGlzLnJlcXVlc3QucGFyYW1zKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjI7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlYzID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgCiAgICAgIHZhciBkYXRldGltZSA9IEFXUy51dGlsLmRhdGUucmZjODIyKGRhdGUpOwogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gZGF0ZXRpbWU7CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXpuLUF1dGhvcml6YXRpb24nXSA9CiAgICAgICAgdGhpcy5hdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgCiAgICB9LAogIAogICAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscykgewogICAgICByZXR1cm4gJ0FXUzMgJyArCiAgICAgICAgJ0FXU0FjY2Vzc0tleUlkPScgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcsJyArCiAgICAgICAgJ0FsZ29yaXRobT1IbWFjU0hBMjU2LCcgKwogICAgICAgICdTaWduZWRIZWFkZXJzPScgKyB0aGlzLnNpZ25lZEhlYWRlcnMoKSArICcsJyArCiAgICAgICAgJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwogICAgfSwKICAKICAgIHNpZ25lZEhlYWRlcnM6IGZ1bmN0aW9uIHNpZ25lZEhlYWRlcnMoKSB7CiAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgIEFXUy51dGlsLmFycmF5RWFjaCh0aGlzLmhlYWRlcnNUb1NpZ24oKSwgZnVuY3Rpb24gaXRlcmF0b3IoaCkgewogICAgICAgIGhlYWRlcnMucHVzaChoLnRvTG93ZXJDYXNlKCkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGhlYWRlcnMuc29ydCgpLmpvaW4oJzsnKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJzKCkgewogICAgICB2YXIgaGVhZGVycyA9IHRoaXMucmVxdWVzdC5oZWFkZXJzOwogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHRoaXMuaGVhZGVyc1RvU2lnbigpLCBmdW5jdGlvbiBpdGVyYXRvcihoKSB7CiAgICAgICAgcGFydHMucHVzaChoLnRvTG93ZXJDYXNlKCkudHJpbSgpICsgJzonICsgU3RyaW5nKGhlYWRlcnNbaF0pLnRyaW0oKSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcGFydHMuc29ydCgpLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgfSwKICAKICAgIGhlYWRlcnNUb1NpZ246IGZ1bmN0aW9uIGhlYWRlcnNUb1NpZ24oKSB7CiAgICAgIHZhciBoZWFkZXJzID0gW107CiAgICAgIEFXUy51dGlsLmVhY2godGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIGl0ZXJhdG9yKGspIHsKICAgICAgICBpZiAoayA9PT0gJ0hvc3QnIHx8IGsgPT09ICdDb250ZW50LUVuY29kaW5nJyB8fCBrLm1hdGNoKC9eWC1BbXovaSkpIHsKICAgICAgICAgIGhlYWRlcnMucHVzaChrKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gaGVhZGVyczsKICAgIH0sCiAgCiAgICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscykgewogICAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpLCAnYmFzZTY0Jyk7CiAgICB9LAogIAogICAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKCcvJyk7CiAgICAgIHBhcnRzLnB1c2goJycpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsSGVhZGVycygpKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QuYm9keSk7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uc2hhMjU2KHBhcnRzLmpvaW4oJ1xuJykpOwogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjM7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CiAgdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwogIAogIHJlcXVpcmUoJy4vdjMnKTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBBV1MuU2lnbmVycy5WM0h0dHBzID0gaW5oZXJpdChBV1MuU2lnbmVycy5WMywgewogICAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscykgewogICAgICByZXR1cm4gJ0FXUzMtSFRUUFMgJyArCiAgICAgICAgJ0FXU0FjY2Vzc0tleUlkPScgKyBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcsJyArCiAgICAgICAgJ0FsZ29yaXRobT1IbWFjU0hBMjU2LCcgKwogICAgICAgICdTaWduYXR1cmU9JyArIHRoaXMuc2lnbmF0dXJlKGNyZWRlbnRpYWxzKTsKICAgIH0sCiAgCiAgICBzdHJpbmdUb1NpZ246IGZ1bmN0aW9uIHN0cmluZ1RvU2lnbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ107CiAgICB9CiAgfSk7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WM0h0dHBzOwogIAogIH0seyIuLi9jb3JlIjoxOCwiLi92MyI6NjZ9XSw2ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKICB2YXIgdjRDcmVkZW50aWFscyA9IHJlcXVpcmUoJy4vdjRfY3JlZGVudGlhbHMnKTsKICB2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdmFyIGV4cGlyZXNIZWFkZXIgPSAncHJlc2lnbmVkLWV4cGlyZXMnOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFXUy5TaWduZXJzLlY0ID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gVjQocmVxdWVzdCwgc2VydmljZU5hbWUsIG9wdGlvbnMpIHsKICAgICAgQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lci5jYWxsKHRoaXMsIHJlcXVlc3QpOwogICAgICB0aGlzLnNlcnZpY2VOYW1lID0gc2VydmljZU5hbWU7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB0aGlzLnNpZ25hdHVyZUNhY2hlID0gdHlwZW9mIG9wdGlvbnMuc2lnbmF0dXJlQ2FjaGUgPT09ICdib29sZWFuJyA/IG9wdGlvbnMuc2lnbmF0dXJlQ2FjaGUgOiB0cnVlOwogICAgICB0aGlzLm9wZXJhdGlvbiA9IG9wdGlvbnMub3BlcmF0aW9uOwogICAgICB0aGlzLnNpZ25hdHVyZVZlcnNpb24gPSBvcHRpb25zLnNpZ25hdHVyZVZlcnNpb247CiAgICB9LAogIAogICAgYWxnb3JpdGhtOiAnQVdTNC1ITUFDLVNIQTI1NicsCiAgCiAgICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgICAgIHZhciBkYXRldGltZSA9IEFXUy51dGlsLmRhdGUuaXNvODYwMShkYXRlKS5yZXBsYWNlKC9bOlwtXXxcLlxkezN9L2csICcnKTsKICAKICAgICAgaWYgKHRoaXMuaXNQcmVzaWduZWQoKSkgewogICAgICAgIHRoaXMudXBkYXRlRm9yUHJlc2lnbmVkKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hZGRIZWFkZXJzKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICAgIH0KICAKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9CiAgICAgICAgdGhpcy5hdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICB9LAogIAogICAgYWRkSGVhZGVyczogZnVuY3Rpb24gYWRkSGVhZGVycyhjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IGRhdGV0aW1lOwogICAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICAgIH0KICAgIH0sCiAgCiAgICB1cGRhdGVGb3JQcmVzaWduZWQ6IGZ1bmN0aW9uIHVwZGF0ZUZvclByZXNpZ25lZChjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdmFyIGNyZWRTdHJpbmcgPSB0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpOwogICAgICB2YXIgcXMgPSB7CiAgICAgICAgJ1gtQW16LURhdGUnOiBkYXRldGltZSwKICAgICAgICAnWC1BbXotQWxnb3JpdGhtJzogdGhpcy5hbGdvcml0aG0sCiAgICAgICAgJ1gtQW16LUNyZWRlbnRpYWwnOiBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcvJyArIGNyZWRTdHJpbmcsCiAgICAgICAgJ1gtQW16LUV4cGlyZXMnOiB0aGlzLnJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXSwKICAgICAgICAnWC1BbXotU2lnbmVkSGVhZGVycyc6IHRoaXMuc2lnbmVkSGVhZGVycygpCiAgICAgIH07CiAgCiAgICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgICBxc1snWC1BbXotU2VjdXJpdHktVG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgICAgfQogIAogICAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7CiAgICAgICAgcXNbJ0NvbnRlbnQtVHlwZSddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddOwogICAgICB9CiAgICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1NRDUnXSkgewogICAgICAgIHFzWydDb250ZW50LU1ENSddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J107CiAgICAgIH0KICAgICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDYWNoZS1Db250cm9sJ10pIHsKICAgICAgICBxc1snQ2FjaGUtQ29udHJvbCddID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NhY2hlLUNvbnRyb2wnXTsKICAgICAgfQogIAogICAgICAvLyBuZWVkIHRvIHB1bGwgaW4gYW55IG90aGVyIFgtQW16LSogaGVhZGVycwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoa2V5ID09PSBleHBpcmVzSGVhZGVyKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSB7CiAgICAgICAgICB2YXIgbG93ZXJLZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIC8vIE1ldGFkYXRhIHNob3VsZCBiZSBub3JtYWxpemVkCiAgICAgICAgICBpZiAobG93ZXJLZXkuaW5kZXhPZigneC1hbXotbWV0YS0nKSA9PT0gMCkgewogICAgICAgICAgICBxc1tsb3dlcktleV0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAobG93ZXJLZXkuaW5kZXhPZigneC1hbXotJykgPT09IDApIHsKICAgICAgICAgICAgcXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIHZhciBzZXAgPSB0aGlzLnJlcXVlc3QucGF0aC5pbmRleE9mKCc/JykgPj0gMCA/ICcmJyA6ICc/JzsKICAgICAgdGhpcy5yZXF1ZXN0LnBhdGggKz0gc2VwICsgQVdTLnV0aWwucXVlcnlQYXJhbXNUb1N0cmluZyhxcyk7CiAgICB9LAogIAogICAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpIHsKICAgICAgdmFyIHBhcnRzID0gW107CiAgICAgIHZhciBjcmVkU3RyaW5nID0gdGhpcy5jcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKTsKICAgICAgcGFydHMucHVzaCh0aGlzLmFsZ29yaXRobSArICcgQ3JlZGVudGlhbD0nICsKICAgICAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcvJyArIGNyZWRTdHJpbmcpOwogICAgICBwYXJ0cy5wdXNoKCdTaWduZWRIZWFkZXJzPScgKyB0aGlzLnNpZ25lZEhlYWRlcnMoKSk7CiAgICAgIHBhcnRzLnB1c2goJ1NpZ25hdHVyZT0nICsgdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcsICcpOwogICAgfSwKICAKICAgIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgICB2YXIgc2lnbmluZ0tleSA9IHY0Q3JlZGVudGlhbHMuZ2V0U2lnbmluZ0tleSgKICAgICAgICBjcmVkZW50aWFscywKICAgICAgICBkYXRldGltZS5zdWJzdHIoMCwgOCksCiAgICAgICAgdGhpcy5yZXF1ZXN0LnJlZ2lvbiwKICAgICAgICB0aGlzLnNlcnZpY2VOYW1lLAogICAgICAgIHRoaXMuc2lnbmF0dXJlQ2FjaGUKICAgICAgKTsKICAgICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKHNpZ25pbmdLZXksIHRoaXMuc3RyaW5nVG9TaWduKGRhdGV0aW1lKSwgJ2hleCcpOwogICAgfSwKICAKICAgIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKGRhdGV0aW1lKSB7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBwYXJ0cy5wdXNoKCdBV1M0LUhNQUMtU0hBMjU2Jyk7CiAgICAgIHBhcnRzLnB1c2goZGF0ZXRpbWUpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuaGV4RW5jb2RlZEhhc2godGhpcy5jYW5vbmljYWxTdHJpbmcoKSkpOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxTdHJpbmc6IGZ1bmN0aW9uIGNhbm9uaWNhbFN0cmluZygpIHsKICAgICAgdmFyIHBhcnRzID0gW10sIHBhdGhuYW1lID0gdGhpcy5yZXF1ZXN0LnBhdGhuYW1lKCk7CiAgICAgIGlmICh0aGlzLnNlcnZpY2VOYW1lICE9PSAnczMnICYmIHRoaXMuc2lnbmF0dXJlVmVyc2lvbiAhPT0gJ3MzdjQnKSBwYXRobmFtZSA9IEFXUy51dGlsLnVyaUVzY2FwZVBhdGgocGF0aG5hbWUpOwogIAogICAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgICBwYXJ0cy5wdXNoKHBhdGhuYW1lKTsKICAgICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3Quc2VhcmNoKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsSGVhZGVycygpICsgJ1xuJyk7CiAgICAgIHBhcnRzLnB1c2godGhpcy5zaWduZWRIZWFkZXJzKCkpOwogICAgICBwYXJ0cy5wdXNoKHRoaXMuaGV4RW5jb2RlZEJvZHlIYXNoKCkpOwogICAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICAgIH0sCiAgCiAgICBjYW5vbmljYWxIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJzKCkgewogICAgICB2YXIgaGVhZGVycyA9IFtdOwogICAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIChrZXksIGl0ZW0pIHsKICAgICAgICBoZWFkZXJzLnB1c2goW2tleSwgaXRlbV0pOwogICAgICB9KTsKICAgICAgaGVhZGVycy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGFbMF0udG9Mb3dlckNhc2UoKSA8IGJbMF0udG9Mb3dlckNhc2UoKSA/IC0xIDogMTsKICAgICAgfSk7CiAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBoZWFkZXJzLCBmdW5jdGlvbiAoaXRlbSkgewogICAgICAgIHZhciBrZXkgPSBpdGVtWzBdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBpdGVtWzFdOwogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgdmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlLnRvU3RyaW5nICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignSGVhZGVyICcgKyBrZXkgKyAnIGNvbnRhaW5zIGludmFsaWQgdmFsdWUnKSwgewogICAgICAgICAgICAgIGNvZGU6ICdJbnZhbGlkSGVhZGVyJwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcnRzLnB1c2goa2V5ICsgJzonICsKICAgICAgICAgICAgdGhpcy5jYW5vbmljYWxIZWFkZXJWYWx1ZXModmFsdWUudG9TdHJpbmcoKSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogICAgfSwKICAKICAgIGNhbm9uaWNhbEhlYWRlclZhbHVlczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVyVmFsdWVzKHZhbHVlcykgewogICAgICByZXR1cm4gdmFsdWVzLnJlcGxhY2UoL1xzKy9nLCAnICcpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7CiAgICB9LAogIAogICAgc2lnbmVkSGVhZGVyczogZnVuY3Rpb24gc2lnbmVkSGVhZGVycygpIHsKICAgICAgdmFyIGtleXMgPSBbXTsKICAgICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAga2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7CiAgICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSBrZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHJldHVybiBrZXlzLnNvcnQoKS5qb2luKCc7Jyk7CiAgICB9LAogIAogICAgY3JlZGVudGlhbFN0cmluZzogZnVuY3Rpb24gY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSkgewogICAgICByZXR1cm4gdjRDcmVkZW50aWFscy5jcmVhdGVTY29wZSgKICAgICAgICBkYXRldGltZS5zdWJzdHIoMCwgOCksCiAgICAgICAgdGhpcy5yZXF1ZXN0LnJlZ2lvbiwKICAgICAgICB0aGlzLnNlcnZpY2VOYW1lCiAgICAgICk7CiAgICB9LAogIAogICAgaGV4RW5jb2RlZEhhc2g6IGZ1bmN0aW9uIGhhc2goc3RyaW5nKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uc2hhMjU2KHN0cmluZywgJ2hleCcpOwogICAgfSwKICAKICAgIGhleEVuY29kZWRCb2R5SGFzaDogZnVuY3Rpb24gaGV4RW5jb2RlZEJvZHlIYXNoKCkgewogICAgICB2YXIgcmVxdWVzdCA9IHRoaXMucmVxdWVzdDsKICAgICAgaWYgKHRoaXMuaXNQcmVzaWduZWQoKSAmJiB0aGlzLnNlcnZpY2VOYW1lID09PSAnczMnICYmICFyZXF1ZXN0LmJvZHkpIHsKICAgICAgICByZXR1cm4gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgICB9IGVsc2UgaWYgKHJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXSkgewogICAgICAgIHJldHVybiByZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J107CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaGV4RW5jb2RlZEhhc2godGhpcy5yZXF1ZXN0LmJvZHkgfHwgJycpOwogICAgICB9CiAgICB9LAogIAogICAgdW5zaWduYWJsZUhlYWRlcnM6IFsKICAgICAgJ2F1dGhvcml6YXRpb24nLAogICAgICAnY29udGVudC10eXBlJywKICAgICAgJ2NvbnRlbnQtbGVuZ3RoJywKICAgICAgJ3VzZXItYWdlbnQnLAogICAgICBleHBpcmVzSGVhZGVyLAogICAgICAnZXhwZWN0JywKICAgICAgJ3gtYW16bi10cmFjZS1pZCcKICAgIF0sCiAgCiAgICBpc1NpZ25hYmxlSGVhZGVyOiBmdW5jdGlvbiBpc1NpZ25hYmxlSGVhZGVyKGtleSkgewogICAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkuaW5kZXhPZigneC1hbXotJykgPT09IDApIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gdGhpcy51bnNpZ25hYmxlSGVhZGVycy5pbmRleE9mKGtleSkgPCAwOwogICAgfSwKICAKICAgIGlzUHJlc2lnbmVkOiBmdW5jdGlvbiBpc1ByZXNpZ25lZCgpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID8gdHJ1ZSA6IGZhbHNlOwogICAgfQogIAogIH0pOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjQ7CiAgCiAgfSx7Ii4uL2NvcmUiOjE4LCIuL3Y0X2NyZWRlbnRpYWxzIjo2OX1dLDY5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBjYWNoZWRTZWNyZXQgPSB7fTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgY2FjaGVRdWV1ZSA9IFtdOwogIAogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHZhciBtYXhDYWNoZUVudHJpZXMgPSA1MDsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgdjRJZGVudGlmaWVyID0gJ2F3czRfcmVxdWVzdCc7CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICoKICAgICAqIEBwYXJhbSBkYXRlIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gcmVnaW9uIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gc2VydmljZU5hbWUgW1N0cmluZ10KICAgICAqIEByZXR1cm4gW1N0cmluZ10KICAgICAqLwogICAgY3JlYXRlU2NvcGU6IGZ1bmN0aW9uIGNyZWF0ZVNjb3BlKGRhdGUsIHJlZ2lvbiwgc2VydmljZU5hbWUpIHsKICAgICAgcmV0dXJuIFsKICAgICAgICBkYXRlLnN1YnN0cigwLCA4KSwKICAgICAgICByZWdpb24sCiAgICAgICAgc2VydmljZU5hbWUsCiAgICAgICAgdjRJZGVudGlmaWVyCiAgICAgIF0uam9pbignLycpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKgogICAgICogQHBhcmFtIGNyZWRlbnRpYWxzIFtDcmVkZW50aWFsc10KICAgICAqIEBwYXJhbSBkYXRlIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gcmVnaW9uIFtTdHJpbmddCiAgICAgKiBAcGFyYW0gc2VydmljZSBbU3RyaW5nXQogICAgICogQHBhcmFtIHNob3VsZENhY2hlIFtCb29sZWFuXQogICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICovCiAgICBnZXRTaWduaW5nS2V5OiBmdW5jdGlvbiBnZXRTaWduaW5nS2V5KAogICAgICBjcmVkZW50aWFscywKICAgICAgZGF0ZSwKICAgICAgcmVnaW9uLAogICAgICBzZXJ2aWNlLAogICAgICBzaG91bGRDYWNoZQogICAgKSB7CiAgICAgIHZhciBjcmVkc0lkZW50aWZpZXIgPSBBV1MudXRpbC5jcnlwdG8KICAgICAgICAuaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkLCAnYmFzZTY0Jyk7CiAgICAgIHZhciBjYWNoZUtleSA9IFtjcmVkc0lkZW50aWZpZXIsIGRhdGUsIHJlZ2lvbiwgc2VydmljZV0uam9pbignXycpOwogICAgICBzaG91bGRDYWNoZSA9IHNob3VsZENhY2hlICE9PSBmYWxzZTsKICAgICAgaWYgKHNob3VsZENhY2hlICYmIChjYWNoZUtleSBpbiBjYWNoZWRTZWNyZXQpKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlZFNlY3JldFtjYWNoZUtleV07CiAgICAgIH0KICAKICAgICAgdmFyIGtEYXRlID0gQVdTLnV0aWwuY3J5cHRvLmhtYWMoCiAgICAgICAgJ0FXUzQnICsgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LAogICAgICAgIGRhdGUsCiAgICAgICAgJ2J1ZmZlcicKICAgICAgKTsKICAgICAgdmFyIGtSZWdpb24gPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrRGF0ZSwgcmVnaW9uLCAnYnVmZmVyJyk7CiAgICAgIHZhciBrU2VydmljZSA9IEFXUy51dGlsLmNyeXB0by5obWFjKGtSZWdpb24sIHNlcnZpY2UsICdidWZmZXInKTsKICAKICAgICAgdmFyIHNpZ25pbmdLZXkgPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrU2VydmljZSwgdjRJZGVudGlmaWVyLCAnYnVmZmVyJyk7CiAgICAgIGlmIChzaG91bGRDYWNoZSkgewogICAgICAgIGNhY2hlZFNlY3JldFtjYWNoZUtleV0gPSBzaWduaW5nS2V5OwogICAgICAgIGNhY2hlUXVldWUucHVzaChjYWNoZUtleSk7CiAgICAgICAgaWYgKGNhY2hlUXVldWUubGVuZ3RoID4gbWF4Q2FjaGVFbnRyaWVzKSB7CiAgICAgICAgICAvLyByZW1vdmUgdGhlIG9sZGVzdCBlbnRyeSAobm90IHRoZSBsZWFzdCByZWNlbnRseSB1c2VkKQogICAgICAgICAgZGVsZXRlIGNhY2hlZFNlY3JldFtjYWNoZVF1ZXVlLnNoaWZ0KCldOwogICAgICAgIH0KICAgICAgfQogIAogICAgICByZXR1cm4gc2lnbmluZ0tleTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICoKICAgICAqIEVtcHRpZXMgdGhlIGRlcml2ZWQgc2lnbmluZyBrZXkgY2FjaGUuIE1hZGUgYXZhaWxhYmxlIGZvciB0ZXN0aW5nIHB1cnBvc2VzCiAgICAgKiBvbmx5LgogICAgICovCiAgICBlbXB0eUNhY2hlOiBmdW5jdGlvbiBlbXB0eUNhY2hlKCkgewogICAgICBjYWNoZWRTZWNyZXQgPSB7fTsKICAgICAgY2FjaGVRdWV1ZSA9IFtdOwogICAgfQogIH07CiAgCiAgfSx7Ii4uL2NvcmUiOjE4fV0sNzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGZ1bmN0aW9uIEFjY2VwdG9yU3RhdGVNYWNoaW5lKHN0YXRlcywgc3RhdGUpIHsKICAgIHRoaXMuY3VycmVudFN0YXRlID0gc3RhdGUgfHwgbnVsbDsKICAgIHRoaXMuc3RhdGVzID0gc3RhdGVzIHx8IHt9OwogIH0KICAKICBBY2NlcHRvclN0YXRlTWFjaGluZS5wcm90b3R5cGUucnVuVG8gPSBmdW5jdGlvbiBydW5UbyhmaW5hbFN0YXRlLCBkb25lLCBiaW5kT2JqZWN0LCBpbnB1dEVycm9yKSB7CiAgICBpZiAodHlwZW9mIGZpbmFsU3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgaW5wdXRFcnJvciA9IGJpbmRPYmplY3Q7IGJpbmRPYmplY3QgPSBkb25lOwogICAgICBkb25lID0gZmluYWxTdGF0ZTsgZmluYWxTdGF0ZSA9IG51bGw7CiAgICB9CiAgCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgc3RhdGUgPSBzZWxmLnN0YXRlc1tzZWxmLmN1cnJlbnRTdGF0ZV07CiAgICBzdGF0ZS5mbi5jYWxsKGJpbmRPYmplY3QgfHwgc2VsZiwgaW5wdXRFcnJvciwgZnVuY3Rpb24oZXJyKSB7CiAgICAgIGlmIChlcnIpIHsKICAgICAgICBpZiAoc3RhdGUuZmFpbCkgc2VsZi5jdXJyZW50U3RhdGUgPSBzdGF0ZS5mYWlsOwogICAgICAgIGVsc2UgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCwgZXJyKSA6IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHN0YXRlLmFjY2VwdCkgc2VsZi5jdXJyZW50U3RhdGUgPSBzdGF0ZS5hY2NlcHQ7CiAgICAgICAgZWxzZSByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0KSA6IG51bGw7CiAgICAgIH0KICAgICAgaWYgKHNlbGYuY3VycmVudFN0YXRlID09PSBmaW5hbFN0YXRlKSB7CiAgICAgICAgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCwgZXJyKSA6IG51bGw7CiAgICAgIH0KICAKICAgICAgc2VsZi5ydW5UbyhmaW5hbFN0YXRlLCBkb25lLCBiaW5kT2JqZWN0LCBlcnIpOwogICAgfSk7CiAgfTsKICAKICBBY2NlcHRvclN0YXRlTWFjaGluZS5wcm90b3R5cGUuYWRkU3RhdGUgPSBmdW5jdGlvbiBhZGRTdGF0ZShuYW1lLCBhY2NlcHRTdGF0ZSwgZmFpbFN0YXRlLCBmbikgewogICAgaWYgKHR5cGVvZiBhY2NlcHRTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBmbiA9IGFjY2VwdFN0YXRlOyBhY2NlcHRTdGF0ZSA9IG51bGw7IGZhaWxTdGF0ZSA9IG51bGw7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBmYWlsU3RhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgZm4gPSBmYWlsU3RhdGU7IGZhaWxTdGF0ZSA9IG51bGw7CiAgICB9CiAgCiAgICBpZiAoIXRoaXMuY3VycmVudFN0YXRlKSB0aGlzLmN1cnJlbnRTdGF0ZSA9IG5hbWU7CiAgICB0aGlzLnN0YXRlc1tuYW1lXSA9IHsgYWNjZXB0OiBhY2NlcHRTdGF0ZSwgZmFpbDogZmFpbFN0YXRlLCBmbjogZm4gfTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBBY2NlcHRvclN0YXRlTWFjaGluZTsKICAKICB9LHt9XSw3MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgKGZ1bmN0aW9uIChwcm9jZXNzLHNldEltbWVkaWF0ZSl7KGZ1bmN0aW9uICgpewogIC8qIGVzbGludCBndWFyZC1mb3ItaW46MCAqLwogIHZhciBBV1M7CiAgCiAgLyoqCiAgICogQSBzZXQgb2YgdXRpbGl0eSBtZXRob2RzIGZvciB1c2Ugd2l0aCB0aGUgQVdTIFNESy4KICAgKgogICAqIEAhYXR0cmlidXRlIGFib3J0CiAgICogICBSZXR1cm4gdGhpcyB2YWx1ZSBmcm9tIGFuIGl0ZXJhdG9yIGZ1bmN0aW9uIHtlYWNofSBvciB7YXJyYXlFYWNofQogICAqICAgdG8gYnJlYWsgb3V0IG9mIHRoZSBpdGVyYXRpb24uCiAgICogICBAZXhhbXBsZSBCcmVha2luZyBvdXQgb2YgYW4gaXRlcmF0b3IgZnVuY3Rpb24KICAgKiAgICAgQVdTLnV0aWwuZWFjaCh7YTogMSwgYjogMiwgYzogM30sIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgKiAgICAgICBpZiAoa2V5ID09ICdiJykgcmV0dXJuIEFXUy51dGlsLmFib3J0OwogICAqICAgICB9KTsKICAgKiAgIEBzZWUgZWFjaAogICAqICAgQHNlZSBhcnJheUVhY2gKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YXIgdXRpbCA9IHsKICAgIGVudmlyb25tZW50OiAnbm9kZWpzJywKICAgIGVuZ2luZTogZnVuY3Rpb24gZW5naW5lKCkgewogICAgICBpZiAodXRpbC5pc0Jyb3dzZXIoKSAmJiB0eXBlb2YgbmF2aWdhdG9yICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBuYXZpZ2F0b3IudXNlckFnZW50OwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBlbmdpbmUgPSBwcm9jZXNzLnBsYXRmb3JtICsgJy8nICsgcHJvY2Vzcy52ZXJzaW9uOwogICAgICAgIGlmIChwcm9jZXNzLmVudi5BV1NfRVhFQ1VUSU9OX0VOVikgewogICAgICAgICAgZW5naW5lICs9ICcgZXhlYy1lbnYvJyArIHByb2Nlc3MuZW52LkFXU19FWEVDVVRJT05fRU5WOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZW5naW5lOwogICAgICB9CiAgICB9LAogIAogICAgdXNlckFnZW50OiBmdW5jdGlvbiB1c2VyQWdlbnQoKSB7CiAgICAgIHZhciBuYW1lID0gdXRpbC5lbnZpcm9ubWVudDsKICAgICAgdmFyIGFnZW50ID0gJ2F3cy1zZGstJyArIG5hbWUgKyAnLycgKyByZXF1aXJlKCcuL2NvcmUnKS5WRVJTSU9OOwogICAgICBpZiAobmFtZSA9PT0gJ25vZGVqcycpIGFnZW50ICs9ICcgJyArIHV0aWwuZW5naW5lKCk7CiAgICAgIHJldHVybiBhZ2VudDsKICAgIH0sCiAgCiAgICB1cmlFc2NhcGU6IGZ1bmN0aW9uIHVyaUVzY2FwZShzdHJpbmcpIHsKICAgICAgdmFyIG91dHB1dCA9IGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmcpOwogICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvW15BLVphLXowLTlfLn5cLSVdKy9nLCBlc2NhcGUpOwogIAogICAgICAvLyBBV1MgcGVyY2VudC1lbmNvZGVzIHNvbWUgZXh0cmEgbm9uLXN0YW5kYXJkIGNoYXJhY3RlcnMgaW4gYSBVUkkKICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoL1sqXS9nLCBmdW5jdGlvbihjaCkgewogICAgICAgIHJldHVybiAnJScgKyBjaC5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0sCiAgCiAgICB1cmlFc2NhcGVQYXRoOiBmdW5jdGlvbiB1cmlFc2NhcGVQYXRoKHN0cmluZykgewogICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgdXRpbC5hcnJheUVhY2goc3RyaW5nLnNwbGl0KCcvJyksIGZ1bmN0aW9uIChwYXJ0KSB7CiAgICAgICAgcGFydHMucHVzaCh1dGlsLnVyaUVzY2FwZShwYXJ0KSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcGFydHMuam9pbignLycpOwogICAgfSwKICAKICAgIHVybFBhcnNlOiBmdW5jdGlvbiB1cmxQYXJzZSh1cmwpIHsKICAgICAgcmV0dXJuIHV0aWwudXJsLnBhcnNlKHVybCk7CiAgICB9LAogIAogICAgdXJsRm9ybWF0OiBmdW5jdGlvbiB1cmxGb3JtYXQodXJsKSB7CiAgICAgIHJldHVybiB1dGlsLnVybC5mb3JtYXQodXJsKTsKICAgIH0sCiAgCiAgICBxdWVyeVN0cmluZ1BhcnNlOiBmdW5jdGlvbiBxdWVyeVN0cmluZ1BhcnNlKHFzKSB7CiAgICAgIHJldHVybiB1dGlsLnF1ZXJ5c3RyaW5nLnBhcnNlKHFzKTsKICAgIH0sCiAgCiAgICBxdWVyeVBhcmFtc1RvU3RyaW5nOiBmdW5jdGlvbiBxdWVyeVBhcmFtc1RvU3RyaW5nKHBhcmFtcykgewogICAgICB2YXIgaXRlbXMgPSBbXTsKICAgICAgdmFyIGVzY2FwZSA9IHV0aWwudXJpRXNjYXBlOwogICAgICB2YXIgc29ydGVkS2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcykuc29ydCgpOwogIAogICAgICB1dGlsLmFycmF5RWFjaChzb3J0ZWRLZXlzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW25hbWVdOwogICAgICAgIHZhciBlbmFtZSA9IGVzY2FwZShuYW1lKTsKICAgICAgICB2YXIgcmVzdWx0ID0gZW5hbWUgKyAnPSc7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICB2YXIgdmFscyA9IFtdOwogICAgICAgICAgdXRpbC5hcnJheUVhY2godmFsdWUsIGZ1bmN0aW9uKGl0ZW0pIHsgdmFscy5wdXNoKGVzY2FwZShpdGVtKSk7IH0pOwogICAgICAgICAgcmVzdWx0ID0gZW5hbWUgKyAnPScgKyB2YWxzLnNvcnQoKS5qb2luKCcmJyArIGVuYW1lICsgJz0nKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgIHJlc3VsdCA9IGVuYW1lICsgJz0nICsgZXNjYXBlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaXRlbXMucHVzaChyZXN1bHQpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIGl0ZW1zLmpvaW4oJyYnKTsKICAgIH0sCiAgCiAgICByZWFkRmlsZVN5bmM6IGZ1bmN0aW9uIHJlYWRGaWxlU3luYyhwYXRoKSB7CiAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHBhdGgsICd1dGYtOCcpOwogICAgfSwKICAKICAgIGJhc2U2NDogewogICAgICBlbmNvZGU6IGZ1bmN0aW9uIGVuY29kZTY0KHN0cmluZykgewogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBiYXNlNjQgZW5jb2RlIG51bWJlciAnICsgc3RyaW5nKSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgdHlwZW9mIHN0cmluZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBidWYgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogICAgICAgIHJldHVybiBidWYudG9TdHJpbmcoJ2Jhc2U2NCcpOwogICAgICB9LAogIAogICAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZTY0KHN0cmluZykgewogICAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnbnVtYmVyJykgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBiYXNlNjQgZGVjb2RlIG51bWJlciAnICsgc3RyaW5nKSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHJpbmcgPT09IG51bGwgfHwgdHlwZW9mIHN0cmluZyA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcsICdiYXNlNjQnKTsKICAgICAgfQogIAogICAgfSwKICAKICAgIGJ1ZmZlcjogewogICAgICAvKioKICAgICAgICogQnVmZmVyIGNvbnN0cnVjdG9yIGZvciBOb2RlIGJ1ZmZlciBhbmQgYnVmZmVyIHBvbGx5ZmlsbAogICAgICAgKi8KICAgICAgdG9CdWZmZXI6IGZ1bmN0aW9uKGRhdGEsIGVuY29kaW5nKSB7CiAgICAgICAgcmV0dXJuICh0eXBlb2YgdXRpbC5CdWZmZXIuZnJvbSA9PT0gJ2Z1bmN0aW9uJyAmJiB1dGlsLkJ1ZmZlci5mcm9tICE9PSBVaW50OEFycmF5LmZyb20pID8KICAgICAgICAgIHV0aWwuQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpIDogbmV3IHV0aWwuQnVmZmVyKGRhdGEsIGVuY29kaW5nKTsKICAgICAgfSwKICAKICAgICAgYWxsb2M6IGZ1bmN0aW9uKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzaXplIHBhc3NlZCB0byBhbGxvYyBtdXN0IGJlIGEgbnVtYmVyLicpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHV0aWwuQnVmZmVyLmFsbG9jID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICByZXR1cm4gdXRpbC5CdWZmZXIuYWxsb2Moc2l6ZSwgZmlsbCwgZW5jb2RpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgYnVmID0gbmV3IHV0aWwuQnVmZmVyKHNpemUpOwogICAgICAgICAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYnVmLmZpbGwgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgYnVmLmZpbGwoZmlsbCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGVuY29kaW5nKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBidWY7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICB0b1N0cmVhbTogZnVuY3Rpb24gdG9TdHJlYW0oYnVmZmVyKSB7CiAgICAgICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihidWZmZXIpKSBidWZmZXIgPSAgdXRpbC5idWZmZXIudG9CdWZmZXIoYnVmZmVyKTsKICAKICAgICAgICB2YXIgcmVhZGFibGUgPSBuZXcgKHV0aWwuc3RyZWFtLlJlYWRhYmxlKSgpOwogICAgICAgIHZhciBwb3MgPSAwOwogICAgICAgIHJlYWRhYmxlLl9yZWFkID0gZnVuY3Rpb24oc2l6ZSkgewogICAgICAgICAgaWYgKHBvcyA+PSBidWZmZXIubGVuZ3RoKSByZXR1cm4gcmVhZGFibGUucHVzaChudWxsKTsKICAKICAgICAgICAgIHZhciBlbmQgPSBwb3MgKyBzaXplOwogICAgICAgICAgaWYgKGVuZCA+IGJ1ZmZlci5sZW5ndGgpIGVuZCA9IGJ1ZmZlci5sZW5ndGg7CiAgICAgICAgICByZWFkYWJsZS5wdXNoKGJ1ZmZlci5zbGljZShwb3MsIGVuZCkpOwogICAgICAgICAgcG9zID0gZW5kOwogICAgICAgIH07CiAgCiAgICAgICAgcmV0dXJuIHJlYWRhYmxlOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQ29uY2F0ZW5hdGVzIGEgbGlzdCBvZiBCdWZmZXIgb2JqZWN0cy4KICAgICAgICovCiAgICAgIGNvbmNhdDogZnVuY3Rpb24oYnVmZmVycykgewogICAgICAgIHZhciBsZW5ndGggPSAwLAogICAgICAgICAgICBvZmZzZXQgPSAwLAogICAgICAgICAgICBidWZmZXIgPSBudWxsLCBpOwogIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBidWZmZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBsZW5ndGggKz0gYnVmZmVyc1tpXS5sZW5ndGg7CiAgICAgICAgfQogIAogICAgICAgIGJ1ZmZlciA9IHV0aWwuYnVmZmVyLmFsbG9jKGxlbmd0aCk7CiAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1ZmZlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGJ1ZmZlcnNbaV0uY29weShidWZmZXIsIG9mZnNldCk7CiAgICAgICAgICBvZmZzZXQgKz0gYnVmZmVyc1tpXS5sZW5ndGg7CiAgICAgICAgfQogIAogICAgICAgIHJldHVybiBidWZmZXI7CiAgICAgIH0KICAgIH0sCiAgCiAgICBzdHJpbmc6IHsKICAgICAgYnl0ZUxlbmd0aDogZnVuY3Rpb24gYnl0ZUxlbmd0aChzdHJpbmcpIHsKICAgICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gMDsKICAgICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ3N0cmluZycpIHN0cmluZyA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgCiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgIHJldHVybiBzdHJpbmcuYnl0ZUxlbmd0aDsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdHJpbmcubGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIHN0cmluZy5sZW5ndGg7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLnNpemUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICByZXR1cm4gc3RyaW5nLnNpemU7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLnBhdGggPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICByZXR1cm4gcmVxdWlyZSgnZnMnKS5sc3RhdFN5bmMoc3RyaW5nLnBhdGgpLnNpemU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgZGV0ZXJtaW5lIGxlbmd0aCBvZiAnICsgc3RyaW5nKSwKICAgICAgICAgICAgeyBvYmplY3Q6IHN0cmluZyB9KTsKICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIHVwcGVyRmlyc3Q6IGZ1bmN0aW9uIHVwcGVyRmlyc3Qoc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZ1swXS50b1VwcGVyQ2FzZSgpICsgc3RyaW5nLnN1YnN0cigxKTsKICAgICAgfSwKICAKICAgICAgbG93ZXJGaXJzdDogZnVuY3Rpb24gbG93ZXJGaXJzdChzdHJpbmcpIHsKICAgICAgICByZXR1cm4gc3RyaW5nWzBdLnRvTG93ZXJDYXNlKCkgKyBzdHJpbmcuc3Vic3RyKDEpOwogICAgICB9CiAgICB9LAogIAogICAgaW5pOiB7CiAgICAgIHBhcnNlOiBmdW5jdGlvbiBzdHJpbmcoaW5pKSB7CiAgICAgICAgdmFyIGN1cnJlbnRTZWN0aW9uLCBtYXAgPSB7fTsKICAgICAgICB1dGlsLmFycmF5RWFjaChpbmkuc3BsaXQoL1xyP1xuLyksIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgIGxpbmUgPSBsaW5lLnNwbGl0KC8oXnxccylbOyNdLylbMF07IC8vIHJlbW92ZSBjb21tZW50cwogICAgICAgICAgdmFyIHNlY3Rpb24gPSBsaW5lLm1hdGNoKC9eXHMqXFsoW15cW1xdXSspXF1ccyokLyk7CiAgICAgICAgICBpZiAoc2VjdGlvbikgewogICAgICAgICAgICBjdXJyZW50U2VjdGlvbiA9IHNlY3Rpb25bMV07CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTZWN0aW9uKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gbGluZS5tYXRjaCgvXlxzKiguKz8pXHMqPVxzKiguKz8pXHMqJC8pOwogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl0gPSBtYXBbY3VycmVudFNlY3Rpb25dIHx8IHt9OwogICAgICAgICAgICAgIG1hcFtjdXJyZW50U2VjdGlvbl1baXRlbVsxXV0gPSBpdGVtWzJdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgCiAgICAgICAgcmV0dXJuIG1hcDsKICAgICAgfQogICAgfSwKICAKICAgIGZuOiB7CiAgICAgIG5vb3A6IGZ1bmN0aW9uKCkge30sCiAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbiAoZXJyKSB7IGlmIChlcnIpIHRocm93IGVycjsgfSwKICAKICAgICAgLyoqCiAgICAgICAqIFR1cm4gYSBzeW5jaHJvbm91cyBmdW5jdGlvbiBpbnRvIGFzICJhc3luYyIgZnVuY3Rpb24gYnkgbWFraW5nIGl0IGNhbGwKICAgICAgICogYSBjYWxsYmFjay4gVGhlIHVuZGVybHlpbmcgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGggYWxsIGJ1dCB0aGUgbGFzdCBhcmd1bWVudCwKICAgICAgICogd2hpY2ggaXMgdHJlYXRlZCBhcyB0aGUgY2FsbGJhY2suIFRoZSBjYWxsYmFjayBpcyBwYXNzZWQgcGFzc2VkIGEgZmlyc3QgYXJndW1lbnQKICAgICAgICogb2YgbnVsbCBvbiBzdWNjZXNzIHRvIG1pbWljayBzdGFuZGFyZCBub2RlIGNhbGxiYWNrcy4KICAgICAgICovCiAgICAgIG1ha2VBc3luYzogZnVuY3Rpb24gbWFrZUFzeW5jKGZuLCBleHBlY3RlZEFyZ3MpIHsKICAgICAgICBpZiAoZXhwZWN0ZWRBcmdzICYmIGV4cGVjdGVkQXJncyA8PSBmbi5sZW5ndGgpIHsKICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9CiAgCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgICAgdmFyIGNhbGxiYWNrID0gYXJncy5wb3AoKTsKICAgICAgICAgIHZhciByZXN1bHQgPSBmbi5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICAgIGNhbGxiYWNrKHJlc3VsdCk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogRGF0ZSBhbmQgdGltZSB1dGlsaXR5IGZ1bmN0aW9ucy4KICAgICAqLwogICAgZGF0ZTogewogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbRGF0ZV0gdGhlIGN1cnJlbnQgSmF2YVNjcmlwdCBkYXRlIG9iamVjdC4gU2luY2UgYWxsCiAgICAgICAqICAgQVdTIHNlcnZpY2VzIHJlbHkgb24gdGhpcyBkYXRlIG9iamVjdCwgeW91IGNhbiBvdmVycmlkZQogICAgICAgKiAgIHRoaXMgZnVuY3Rpb24gdG8gcHJvdmlkZSBhIHNwZWNpYWwgdGltZSB2YWx1ZSB0byBBV1Mgc2VydmljZQogICAgICAgKiAgIHJlcXVlc3RzLgogICAgICAgKi8KICAgICAgZ2V0RGF0ZTogZnVuY3Rpb24gZ2V0RGF0ZSgpIHsKICAgICAgICBpZiAoIUFXUykgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgICAgICAgaWYgKEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpIHsgLy8gdXNlIG9mZnNldCB3aGVuIG5vbi16ZXJvCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUobmV3IERhdGUoKS5nZXRUaW1lKCkgKyBBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKCk7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgZGF0ZSBpbiBJU08tODYwMSBmb3JtYXQKICAgICAgICovCiAgICAgIGlzbzg2MDE6IGZ1bmN0aW9uIGlzbzg2MDEoZGF0ZSkgewogICAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgICByZXR1cm4gZGF0ZS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1wuXGR7M31aJC8sICdaJyk7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBkYXRlIGluIFJGQyA4MjIgZm9ybWF0CiAgICAgICAqLwogICAgICByZmM4MjI6IGZ1bmN0aW9uIHJmYzgyMihkYXRlKSB7CiAgICAgICAgaWYgKGRhdGUgPT09IHVuZGVmaW5lZCkgeyBkYXRlID0gdXRpbC5kYXRlLmdldERhdGUoKTsgfQogICAgICAgIHJldHVybiBkYXRlLnRvVVRDU3RyaW5nKCk7CiAgICAgIH0sCiAgCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgVU5JWCB0aW1lc3RhbXAgdmFsdWUgZm9yIHRoZSBjdXJyZW50IHRpbWUKICAgICAgICovCiAgICAgIHVuaXhUaW1lc3RhbXA6IGZ1bmN0aW9uIHVuaXhUaW1lc3RhbXAoZGF0ZSkgewogICAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgICByZXR1cm4gZGF0ZS5nZXRUaW1lKCkgLyAxMDAwOwogICAgICB9LAogIAogICAgICAvKioKICAgICAgICogQHBhcmFtIFtTdHJpbmcsbnVtYmVyLERhdGVdIGRhdGUKICAgICAgICogQHJldHVybiBbRGF0ZV0KICAgICAgICovCiAgICAgIGZyb206IGZ1bmN0aW9uIGZvcm1hdChkYXRlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRlID09PSAnbnVtYmVyJykgewogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUgKiAxMDAwKTsgLy8gdW5peCB0aW1lc3RhbXAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUpOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgLyoqCiAgICAgICAqIEdpdmVuIGEgRGF0ZSBvciBkYXRlLWxpa2UgdmFsdWUsIHRoaXMgZnVuY3Rpb24gZm9ybWF0cyB0aGUKICAgICAgICogZGF0ZSBpbnRvIGEgc3RyaW5nIG9mIHRoZSByZXF1ZXN0ZWQgdmFsdWUuCiAgICAgICAqIEBwYXJhbSBbU3RyaW5nLG51bWJlcixEYXRlXSBkYXRlCiAgICAgICAqIEBwYXJhbSBbU3RyaW5nXSBmb3JtYXR0ZXIgVmFsaWQgZm9ybWF0cyBhcmU6CiAgICAgICAjICAgKiAnaXNvODYwMScKICAgICAgICMgICAqICdyZmM4MjInCiAgICAgICAjICAgKiAndW5peFRpbWVzdGFtcCcKICAgICAgICogQHJldHVybiBbU3RyaW5nXQogICAgICAgKi8KICAgICAgZm9ybWF0OiBmdW5jdGlvbiBmb3JtYXQoZGF0ZSwgZm9ybWF0dGVyKSB7CiAgICAgICAgaWYgKCFmb3JtYXR0ZXIpIGZvcm1hdHRlciA9ICdpc284NjAxJzsKICAgICAgICByZXR1cm4gdXRpbC5kYXRlW2Zvcm1hdHRlcl0odXRpbC5kYXRlLmZyb20oZGF0ZSkpOwogICAgICB9LAogIAogICAgICBwYXJzZVRpbWVzdGFtcDogZnVuY3Rpb24gcGFyc2VUaW1lc3RhbXAodmFsdWUpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgeyAvLyB1bml4IHRpbWVzdGFtcCAobnVtYmVyKQogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlICogMTAwMCk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlxkKyQvKSkgeyAvLyB1bml4IHRpbWVzdGFtcAogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlICogMTAwMCk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5tYXRjaCgvXlxkezR9LykpIHsgLy8gaXNvODYwMQogICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXHd7M30sLykpIHsgLy8gcmZjODIyCiAgICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyB1dGlsLmVycm9yKAogICAgICAgICAgICBuZXcgRXJyb3IoJ3VuaGFuZGxlZCB0aW1lc3RhbXAgZm9ybWF0OiAnICsgdmFsdWUpLAogICAgICAgICAgICB7Y29kZTogJ1RpbWVzdGFtcFBhcnNlckVycm9yJ30pOwogICAgICAgIH0KICAgICAgfQogIAogICAgfSwKICAKICAgIGNyeXB0bzogewogICAgICBjcmMzMlRhYmxlOiBbCiAgICAgICAweDAwMDAwMDAwLCAweDc3MDczMDk2LCAweEVFMEU2MTJDLCAweDk5MDk1MUJBLCAweDA3NkRDNDE5LAogICAgICAgMHg3MDZBRjQ4RiwgMHhFOTYzQTUzNSwgMHg5RTY0OTVBMywgMHgwRURCODgzMiwgMHg3OURDQjhBNCwKICAgICAgIDB4RTBENUU5MUUsIDB4OTdEMkQ5ODgsIDB4MDlCNjRDMkIsIDB4N0VCMTdDQkQsIDB4RTdCODJEMDcsCiAgICAgICAweDkwQkYxRDkxLCAweDFEQjcxMDY0LCAweDZBQjAyMEYyLCAweEYzQjk3MTQ4LCAweDg0QkU0MURFLAogICAgICAgMHgxQURBRDQ3RCwgMHg2RERERTRFQiwgMHhGNEQ0QjU1MSwgMHg4M0QzODVDNywgMHgxMzZDOTg1NiwKICAgICAgIDB4NjQ2QkE4QzAsIDB4RkQ2MkY5N0EsIDB4OEE2NUM5RUMsIDB4MTQwMTVDNEYsIDB4NjMwNjZDRDksCiAgICAgICAweEZBMEYzRDYzLCAweDhEMDgwREY1LCAweDNCNkUyMEM4LCAweDRDNjkxMDVFLCAweEQ1NjA0MUU0LAogICAgICAgMHhBMjY3NzE3MiwgMHgzQzAzRTREMSwgMHg0QjA0RDQ0NywgMHhEMjBEODVGRCwgMHhBNTBBQjU2QiwKICAgICAgIDB4MzVCNUE4RkEsIDB4NDJCMjk4NkMsIDB4REJCQkM5RDYsIDB4QUNCQ0Y5NDAsIDB4MzJEODZDRTMsCiAgICAgICAweDQ1REY1Qzc1LCAweERDRDYwRENGLCAweEFCRDEzRDU5LCAweDI2RDkzMEFDLCAweDUxREUwMDNBLAogICAgICAgMHhDOEQ3NTE4MCwgMHhCRkQwNjExNiwgMHgyMUI0RjRCNSwgMHg1NkIzQzQyMywgMHhDRkJBOTU5OSwKICAgICAgIDB4QjhCREE1MEYsIDB4MjgwMkI4OUUsIDB4NUYwNTg4MDgsIDB4QzYwQ0Q5QjIsIDB4QjEwQkU5MjQsCiAgICAgICAweDJGNkY3Qzg3LCAweDU4Njg0QzExLCAweEMxNjExREFCLCAweEI2NjYyRDNELCAweDc2REM0MTkwLAogICAgICAgMHgwMURCNzEwNiwgMHg5OEQyMjBCQywgMHhFRkQ1MTAyQSwgMHg3MUIxODU4OSwgMHgwNkI2QjUxRiwKICAgICAgIDB4OUZCRkU0QTUsIDB4RThCOEQ0MzMsIDB4NzgwN0M5QTIsIDB4MEYwMEY5MzQsIDB4OTYwOUE4OEUsCiAgICAgICAweEUxMEU5ODE4LCAweDdGNkEwREJCLCAweDA4NkQzRDJELCAweDkxNjQ2Qzk3LCAweEU2NjM1QzAxLAogICAgICAgMHg2QjZCNTFGNCwgMHgxQzZDNjE2MiwgMHg4NTY1MzBEOCwgMHhGMjYyMDA0RSwgMHg2QzA2OTVFRCwKICAgICAgIDB4MUIwMUE1N0IsIDB4ODIwOEY0QzEsIDB4RjUwRkM0NTcsIDB4NjVCMEQ5QzYsIDB4MTJCN0U5NTAsCiAgICAgICAweDhCQkVCOEVBLCAweEZDQjk4ODdDLCAweDYyREQxRERGLCAweDE1REEyRDQ5LCAweDhDRDM3Q0YzLAogICAgICAgMHhGQkQ0NEM2NSwgMHg0REIyNjE1OCwgMHgzQUI1NTFDRSwgMHhBM0JDMDA3NCwgMHhENEJCMzBFMiwKICAgICAgIDB4NEFERkE1NDEsIDB4M0REODk1RDcsIDB4QTREMUM0NkQsIDB4RDNENkY0RkIsIDB4NDM2OUU5NkEsCiAgICAgICAweDM0NkVEOUZDLCAweEFENjc4ODQ2LCAweERBNjBCOEQwLCAweDQ0MDQyRDczLCAweDMzMDMxREU1LAogICAgICAgMHhBQTBBNEM1RiwgMHhERDBEN0NDOSwgMHg1MDA1NzEzQywgMHgyNzAyNDFBQSwgMHhCRTBCMTAxMCwKICAgICAgIDB4QzkwQzIwODYsIDB4NTc2OEI1MjUsIDB4MjA2Rjg1QjMsIDB4Qjk2NkQ0MDksIDB4Q0U2MUU0OUYsCiAgICAgICAweDVFREVGOTBFLCAweDI5RDlDOTk4LCAweEIwRDA5ODIyLCAweEM3RDdBOEI0LCAweDU5QjMzRDE3LAogICAgICAgMHgyRUI0MEQ4MSwgMHhCN0JENUMzQiwgMHhDMEJBNkNBRCwgMHhFREI4ODMyMCwgMHg5QUJGQjNCNiwKICAgICAgIDB4MDNCNkUyMEMsIDB4NzRCMUQyOUEsIDB4RUFENTQ3MzksIDB4OUREMjc3QUYsIDB4MDREQjI2MTUsCiAgICAgICAweDczREMxNjgzLCAweEUzNjMwQjEyLCAweDk0NjQzQjg0LCAweDBENkQ2QTNFLCAweDdBNkE1QUE4LAogICAgICAgMHhFNDBFQ0YwQiwgMHg5MzA5RkY5RCwgMHgwQTAwQUUyNywgMHg3RDA3OUVCMSwgMHhGMDBGOTM0NCwKICAgICAgIDB4ODcwOEEzRDIsIDB4MUUwMUYyNjgsIDB4NjkwNkMyRkUsIDB4Rjc2MjU3NUQsIDB4ODA2NTY3Q0IsCiAgICAgICAweDE5NkMzNjcxLCAweDZFNkIwNkU3LCAweEZFRDQxQjc2LCAweDg5RDMyQkUwLCAweDEwREE3QTVBLAogICAgICAgMHg2N0RENEFDQywgMHhGOUI5REY2RiwgMHg4RUJFRUZGOSwgMHgxN0I3QkU0MywgMHg2MEIwOEVENSwKICAgICAgIDB4RDZENkEzRTgsIDB4QTFEMTkzN0UsIDB4MzhEOEMyQzQsIDB4NEZERkYyNTIsIDB4RDFCQjY3RjEsCiAgICAgICAweEE2QkM1NzY3LCAweDNGQjUwNkRELCAweDQ4QjIzNjRCLCAweEQ4MEQyQkRBLCAweEFGMEExQjRDLAogICAgICAgMHgzNjAzNEFGNiwgMHg0MTA0N0E2MCwgMHhERjYwRUZDMywgMHhBODY3REY1NSwgMHgzMTZFOEVFRiwKICAgICAgIDB4NDY2OUJFNzksIDB4Q0I2MUIzOEMsIDB4QkM2NjgzMUEsIDB4MjU2RkQyQTAsIDB4NTI2OEUyMzYsCiAgICAgICAweENDMEM3Nzk1LCAweEJCMEI0NzAzLCAweDIyMDIxNkI5LCAweDU1MDUyNjJGLCAweEM1QkEzQkJFLAogICAgICAgMHhCMkJEMEIyOCwgMHgyQkI0NUE5MiwgMHg1Q0IzNkEwNCwgMHhDMkQ3RkZBNywgMHhCNUQwQ0YzMSwKICAgICAgIDB4MkNEOTlFOEIsIDB4NUJERUFFMUQsIDB4OUI2NEMyQjAsIDB4RUM2M0YyMjYsIDB4NzU2QUEzOUMsCiAgICAgICAweDAyNkQ5MzBBLCAweDlDMDkwNkE5LCAweEVCMEUzNjNGLCAweDcyMDc2Nzg1LCAweDA1MDA1NzEzLAogICAgICAgMHg5NUJGNEE4MiwgMHhFMkI4N0ExNCwgMHg3QkIxMkJBRSwgMHgwQ0I2MUIzOCwgMHg5MkQyOEU5QiwKICAgICAgIDB4RTVENUJFMEQsIDB4N0NEQ0VGQjcsIDB4MEJEQkRGMjEsIDB4ODZEM0QyRDQsIDB4RjFENEUyNDIsCiAgICAgICAweDY4RERCM0Y4LCAweDFGREE4MzZFLCAweDgxQkUxNkNELCAweEY2QjkyNjVCLCAweDZGQjA3N0UxLAogICAgICAgMHgxOEI3NDc3NywgMHg4ODA4NUFFNiwgMHhGRjBGNkE3MCwgMHg2NjA2M0JDQSwgMHgxMTAxMEI1QywKICAgICAgIDB4OEY2NTlFRkYsIDB4Rjg2MkFFNjksIDB4NjE2QkZGRDMsIDB4MTY2Q0NGNDUsIDB4QTAwQUUyNzgsCiAgICAgICAweEQ3MEREMkVFLCAweDRFMDQ4MzU0LCAweDM5MDNCM0MyLCAweEE3NjcyNjYxLCAweEQwNjAxNkY3LAogICAgICAgMHg0OTY5NDc0RCwgMHgzRTZFNzdEQiwgMHhBRUQxNkE0QSwgMHhEOUQ2NUFEQywgMHg0MERGMEI2NiwKICAgICAgIDB4MzdEODNCRjAsIDB4QTlCQ0FFNTMsIDB4REVCQjlFQzUsIDB4NDdCMkNGN0YsIDB4MzBCNUZGRTksCiAgICAgICAweEJEQkRGMjFDLCAweENBQkFDMjhBLCAweDUzQjM5MzMwLCAweDI0QjRBM0E2LCAweEJBRDAzNjA1LAogICAgICAgMHhDREQ3MDY5MywgMHg1NERFNTcyOSwgMHgyM0Q5NjdCRiwgMHhCMzY2N0EyRSwgMHhDNDYxNEFCOCwKICAgICAgIDB4NUQ2ODFCMDIsIDB4MkE2RjJCOTQsIDB4QjQwQkJFMzcsIDB4QzMwQzhFQTEsIDB4NUEwNURGMUIsCiAgICAgICAweDJEMDJFRjhEXSwKICAKICAgICAgY3JjMzI6IGZ1bmN0aW9uIGNyYzMyKGRhdGEpIHsKICAgICAgICB2YXIgdGJsID0gdXRpbC5jcnlwdG8uY3JjMzJUYWJsZTsKICAgICAgICB2YXIgY3JjID0gMCBeIC0xOwogIAogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGRhdGEgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihkYXRhKTsKICAgICAgICB9CiAgCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgY29kZSA9IGRhdGEucmVhZFVJbnQ4KGkpOwogICAgICAgICAgY3JjID0gKGNyYyA+Pj4gOCkgXiB0YmxbKGNyYyBeIGNvZGUpICYgMHhGRl07CiAgICAgICAgfQogICAgICAgIHJldHVybiAoY3JjIF4gLTEpID4+PiAwOwogICAgICB9LAogIAogICAgICBobWFjOiBmdW5jdGlvbiBobWFjKGtleSwgc3RyaW5nLCBkaWdlc3QsIGZuKSB7CiAgICAgICAgaWYgKCFkaWdlc3QpIGRpZ2VzdCA9ICdiaW5hcnknOwogICAgICAgIGlmIChkaWdlc3QgPT09ICdidWZmZXInKSB7IGRpZ2VzdCA9IHVuZGVmaW5lZDsgfQogICAgICAgIGlmICghZm4pIGZuID0gJ3NoYTI1Nic7CiAgICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdzdHJpbmcnKSBzdHJpbmcgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5saWIuY3JlYXRlSG1hYyhmbiwga2V5KS51cGRhdGUoc3RyaW5nKS5kaWdlc3QoZGlnZXN0KTsKICAgICAgfSwKICAKICAgICAgbWQ1OiBmdW5jdGlvbiBtZDUoZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5oYXNoKCdtZDUnLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKTsKICAgICAgfSwKICAKICAgICAgc2hhMjU2OiBmdW5jdGlvbiBzaGEyNTYoZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICAgIHJldHVybiB1dGlsLmNyeXB0by5oYXNoKCdzaGEyNTYnLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKTsKICAgICAgfSwKICAKICAgICAgaGFzaDogZnVuY3Rpb24oYWxnb3JpdGhtLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGhhc2ggPSB1dGlsLmNyeXB0by5jcmVhdGVIYXNoKGFsZ29yaXRobSk7CiAgICAgICAgaWYgKCFkaWdlc3QpIHsgZGlnZXN0ID0gJ2JpbmFyeSc7IH0KICAgICAgICBpZiAoZGlnZXN0ID09PSAnYnVmZmVyJykgeyBkaWdlc3QgPSB1bmRlZmluZWQ7IH0KICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSBkYXRhID0gdXRpbC5idWZmZXIudG9CdWZmZXIoZGF0YSk7CiAgICAgICAgdmFyIHNsaWNlRm4gPSB1dGlsLmFycmF5U2xpY2VGbihkYXRhKTsKICAgICAgICB2YXIgaXNCdWZmZXIgPSB1dGlsLkJ1ZmZlci5pc0J1ZmZlcihkYXRhKTsKICAgICAgICAvL0lkZW50aWZ5aW5nIG9iamVjdHMgd2l0aCBhbiBBcnJheUJ1ZmZlciBhcyBidWZmZXJzCiAgICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiBkYXRhICYmIGRhdGEuYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIGlzQnVmZmVyID0gdHJ1ZTsKICAKICAgICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmCiAgICAgICAgICAgIHR5cGVvZiBkYXRhLm9uID09PSAnZnVuY3Rpb24nICYmICFpc0J1ZmZlcikgewogICAgICAgICAgZGF0YS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7IGhhc2gudXBkYXRlKGNodW5rKTsgfSk7CiAgICAgICAgICBkYXRhLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikgeyBjYWxsYmFjayhlcnIpOyB9KTsKICAgICAgICAgIGRhdGEub24oJ2VuZCcsIGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhudWxsLCBoYXNoLmRpZ2VzdChkaWdlc3QpKTsgfSk7CiAgICAgICAgfSBlbHNlIGlmIChjYWxsYmFjayAmJiBzbGljZUZuICYmICFpc0J1ZmZlciAmJgogICAgICAgICAgICAgICAgICAgdHlwZW9mIEZpbGVSZWFkZXIgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAvLyB0aGlzIG1pZ2h0IGJlIGEgRmlsZS9CbG9iCiAgICAgICAgICB2YXIgaW5kZXggPSAwLCBzaXplID0gMTAyNCAqIDUxMjsKICAgICAgICAgIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogICAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdGYWlsZWQgdG8gcmVhZCBkYXRhLicpKTsKICAgICAgICAgIH07CiAgICAgICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBidWYgPSBuZXcgdXRpbC5CdWZmZXIobmV3IFVpbnQ4QXJyYXkocmVhZGVyLnJlc3VsdCkpOwogICAgICAgICAgICBoYXNoLnVwZGF0ZShidWYpOwogICAgICAgICAgICBpbmRleCArPSBidWYubGVuZ3RoOwogICAgICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZygpOwogICAgICAgICAgfTsKICAgICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChpbmRleCA+PSBkYXRhLnNpemUpIHsKICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBoYXNoLmRpZ2VzdChkaWdlc3QpKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgdmFyIGJhY2sgPSBpbmRleCArIHNpemU7CiAgICAgICAgICAgIGlmIChiYWNrID4gZGF0YS5zaXplKSBiYWNrID0gZGF0YS5zaXplOwogICAgICAgICAgICByZWFkZXIucmVhZEFzQXJyYXlCdWZmZXIoc2xpY2VGbi5jYWxsKGRhdGEsIGluZGV4LCBiYWNrKSk7CiAgICAgICAgICB9OwogIAogICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmICFpc0J1ZmZlcikgewogICAgICAgICAgICBkYXRhID0gbmV3IHV0aWwuQnVmZmVyKG5ldyBVaW50OEFycmF5KGRhdGEpKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBvdXQgPSBoYXNoLnVwZGF0ZShkYXRhKS5kaWdlc3QoZGlnZXN0KTsKICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sobnVsbCwgb3V0KTsKICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfQogICAgICB9LAogIAogICAgICB0b0hleDogZnVuY3Rpb24gdG9IZXgoZGF0YSkgewogICAgICAgIHZhciBvdXQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG91dC5wdXNoKCgnMCcgKyBkYXRhLmNoYXJDb2RlQXQoaSkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTIsIDIpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dC5qb2luKCcnKTsKICAgICAgfSwKICAKICAgICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gY3JlYXRlSGFzaChhbGdvcml0aG0pIHsKICAgICAgICByZXR1cm4gdXRpbC5jcnlwdG8ubGliLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTsKICAgICAgfQogIAogICAgfSwKICAKICAgIC8qKiBAIWlnbm9yZSAqLwogIAogICAgLyogQWJvcnQgY29uc3RhbnQgKi8KICAgIGFib3J0OiB7fSwKICAKICAgIGVhY2g6IGZ1bmN0aW9uIGVhY2gob2JqZWN0LCBpdGVyRnVuY3Rpb24pIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB7CiAgICAgICAgICB2YXIgcmV0ID0gaXRlckZ1bmN0aW9uLmNhbGwodGhpcywga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgICAgICBpZiAocmV0ID09PSB1dGlsLmFib3J0KSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICBhcnJheUVhY2g6IGZ1bmN0aW9uIGFycmF5RWFjaChhcnJheSwgaXRlckZ1bmN0aW9uKSB7CiAgICAgIGZvciAodmFyIGlkeCBpbiBhcnJheSkgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYXJyYXksIGlkeCkpIHsKICAgICAgICAgIHZhciByZXQgPSBpdGVyRnVuY3Rpb24uY2FsbCh0aGlzLCBhcnJheVtpZHhdLCBwYXJzZUludChpZHgsIDEwKSk7CiAgICAgICAgICBpZiAocmV0ID09PSB1dGlsLmFib3J0KSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvYmoxLCBvYmoyKSB7CiAgICAgIHV0aWwuZWFjaChvYmoyLCBmdW5jdGlvbiBpdGVyYXRvcihrZXksIGl0ZW0pIHsKICAgICAgICBvYmoxW2tleV0gPSBpdGVtOwogICAgICB9KTsKICAgICAgcmV0dXJuIG9iajE7CiAgICB9LAogIAogICAgbWVyZ2U6IGZ1bmN0aW9uIG1lcmdlKG9iajEsIG9iajIpIHsKICAgICAgcmV0dXJuIHV0aWwudXBkYXRlKHV0aWwuY29weShvYmoxKSwgb2JqMik7CiAgICB9LAogIAogICAgY29weTogZnVuY3Rpb24gY29weShvYmplY3QpIHsKICAgICAgaWYgKG9iamVjdCA9PT0gbnVsbCB8fCBvYmplY3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG9iamVjdDsKICAgICAgdmFyIGR1cGUgPSB7fTsKICAgICAgLy8ganNoaW50IGZvcmluOmZhbHNlCiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICBkdXBlW2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgfQogICAgICByZXR1cm4gZHVwZTsKICAgIH0sCiAgCiAgICBpc0VtcHR5OiBmdW5jdGlvbiBpc0VtcHR5KG9iaikgewogICAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgCiAgICBhcnJheVNsaWNlRm46IGZ1bmN0aW9uIGFycmF5U2xpY2VGbihvYmopIHsKICAgICAgdmFyIGZuID0gb2JqLnNsaWNlIHx8IG9iai53ZWJraXRTbGljZSB8fCBvYmoubW96U2xpY2U7CiAgICAgIHJldHVybiB0eXBlb2YgZm4gPT09ICdmdW5jdGlvbicgPyBmbiA6IG51bGw7CiAgICB9LAogIAogICAgaXNUeXBlOiBmdW5jdGlvbiBpc1R5cGUob2JqLCB0eXBlKSB7CiAgICAgIC8vIGhhbmRsZSBjcm9zcy0iZnJhbWUiIG9iamVjdHMKICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAnZnVuY3Rpb24nKSB0eXBlID0gdXRpbC50eXBlTmFtZSh0eXBlKTsKICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCAnICsgdHlwZSArICddJzsKICAgIH0sCiAgCiAgICB0eXBlTmFtZTogZnVuY3Rpb24gdHlwZU5hbWUodHlwZSkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHR5cGUsICduYW1lJykpIHJldHVybiB0eXBlLm5hbWU7CiAgICAgIHZhciBzdHIgPSB0eXBlLnRvU3RyaW5nKCk7CiAgICAgIHZhciBtYXRjaCA9IHN0ci5tYXRjaCgvXlxzKmZ1bmN0aW9uICguKylcKC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IHN0cjsKICAgIH0sCiAgCiAgICBlcnJvcjogZnVuY3Rpb24gZXJyb3IoZXJyLCBvcHRpb25zKSB7CiAgICAgIHZhciBvcmlnaW5hbEVycm9yID0gbnVsbDsKICAgICAgaWYgKHR5cGVvZiBlcnIubWVzc2FnZSA9PT0gJ3N0cmluZycgJiYgZXJyLm1lc3NhZ2UgIT09ICcnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJyB8fCAob3B0aW9ucyAmJiBvcHRpb25zLm1lc3NhZ2UpKSB7CiAgICAgICAgICBvcmlnaW5hbEVycm9yID0gdXRpbC5jb3B5KGVycik7CiAgICAgICAgICBvcmlnaW5hbEVycm9yLm1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZXJyLm1lc3NhZ2UgPSBlcnIubWVzc2FnZSB8fCBudWxsOwogIAogICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZXJyLm1lc3NhZ2UgPSBvcHRpb25zOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JyAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgdXRpbC51cGRhdGUoZXJyLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy5tZXNzYWdlKQogICAgICAgICAgZXJyLm1lc3NhZ2UgPSBvcHRpb25zLm1lc3NhZ2U7CiAgICAgICAgaWYgKG9wdGlvbnMuY29kZSB8fCBvcHRpb25zLm5hbWUpCiAgICAgICAgICBlcnIuY29kZSA9IG9wdGlvbnMuY29kZSB8fCBvcHRpb25zLm5hbWU7CiAgICAgICAgaWYgKG9wdGlvbnMuc3RhY2spCiAgICAgICAgICBlcnIuc3RhY2sgPSBvcHRpb25zLnN0YWNrOwogICAgICB9CiAgCiAgICAgIGlmICh0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnR5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVyciwgJ25hbWUnLCB7d3JpdGFibGU6IHRydWUsIGVudW1lcmFibGU6IGZhbHNlfSk7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVyciwgJ21lc3NhZ2UnLCB7ZW51bWVyYWJsZTogdHJ1ZX0pOwogICAgICB9CiAgCiAgICAgIGVyci5uYW1lID0gb3B0aW9ucyAmJiBvcHRpb25zLm5hbWUgfHwgZXJyLm5hbWUgfHwgZXJyLmNvZGUgfHwgJ0Vycm9yJzsKICAgICAgZXJyLnRpbWUgPSBuZXcgRGF0ZSgpOwogIAogICAgICBpZiAob3JpZ2luYWxFcnJvcikgZXJyLm9yaWdpbmFsRXJyb3IgPSBvcmlnaW5hbEVycm9yOwogIAogICAgICByZXR1cm4gZXJyOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGluaGVyaXQ6IGZ1bmN0aW9uIGluaGVyaXQoa2xhc3MsIGZlYXR1cmVzKSB7CiAgICAgIHZhciBuZXdPYmplY3QgPSBudWxsOwogICAgICBpZiAoZmVhdHVyZXMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGZlYXR1cmVzID0ga2xhc3M7CiAgICAgICAga2xhc3MgPSBPYmplY3Q7CiAgICAgICAgbmV3T2JqZWN0ID0ge307CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGN0b3IgPSBmdW5jdGlvbiBDb25zdHJ1Y3RvcldyYXBwZXIoKSB7fTsKICAgICAgICBjdG9yLnByb3RvdHlwZSA9IGtsYXNzLnByb3RvdHlwZTsKICAgICAgICBuZXdPYmplY3QgPSBuZXcgY3RvcigpOwogICAgICB9CiAgCiAgICAgIC8vIGNvbnN0cnVjdG9yIG5vdCBzdXBwbGllZCwgY3JlYXRlIHBhc3MtdGhyb3VnaCBjdG9yCiAgICAgIGlmIChmZWF0dXJlcy5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KSB7CiAgICAgICAgZmVhdHVyZXMuY29uc3RydWN0b3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChrbGFzcyAhPT0gT2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBrbGFzcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAKICAgICAgZmVhdHVyZXMuY29uc3RydWN0b3IucHJvdG90eXBlID0gbmV3T2JqZWN0OwogICAgICB1dGlsLnVwZGF0ZShmZWF0dXJlcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsIGZlYXR1cmVzKTsKICAgICAgZmVhdHVyZXMuY29uc3RydWN0b3IuX19zdXBlcl9fID0ga2xhc3M7CiAgICAgIHJldHVybiBmZWF0dXJlcy5jb25zdHJ1Y3RvcjsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBtaXhpbjogZnVuY3Rpb24gbWl4aW4oKSB7CiAgICAgIHZhciBrbGFzcyA9IGFyZ3VtZW50c1swXTsKICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAvLyBqc2hpbnQgZm9yaW46ZmFsc2UKICAgICAgICBmb3IgKHZhciBwcm9wIGluIGFyZ3VtZW50c1tpXS5wcm90b3R5cGUpIHsKICAgICAgICAgIHZhciBmbiA9IGFyZ3VtZW50c1tpXS5wcm90b3R5cGVbcHJvcF07CiAgICAgICAgICBpZiAocHJvcCAhPT0gJ2NvbnN0cnVjdG9yJykgewogICAgICAgICAgICBrbGFzcy5wcm90b3R5cGVbcHJvcF0gPSBmbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGtsYXNzOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGhpZGVQcm9wZXJ0aWVzOiBmdW5jdGlvbiBoaWRlUHJvcGVydGllcyhvYmosIHByb3BzKSB7CiAgICAgIGlmICh0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnR5ICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgCiAgICAgIHV0aWwuYXJyYXlFYWNoKHByb3BzLCBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9KTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgcHJvcGVydHk6IGZ1bmN0aW9uIHByb3BlcnR5KG9iaiwgbmFtZSwgdmFsdWUsIGVudW1lcmFibGUsIGlzVmFsdWUpIHsKICAgICAgdmFyIG9wdHMgPSB7CiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIGVudW1lcmFibGU6IGVudW1lcmFibGUgIT09IHVuZGVmaW5lZCA/IGVudW1lcmFibGUgOiB0cnVlCiAgICAgIH07CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicgJiYgIWlzVmFsdWUpIHsKICAgICAgICBvcHRzLmdldCA9IHZhbHVlOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIG9wdHMudmFsdWUgPSB2YWx1ZTsgb3B0cy53cml0YWJsZSA9IHRydWU7CiAgICAgIH0KICAKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgbmFtZSwgb3B0cyk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgbWVtb2l6ZWRQcm9wZXJ0eTogZnVuY3Rpb24gbWVtb2l6ZWRQcm9wZXJ0eShvYmosIG5hbWUsIGdldCwgZW51bWVyYWJsZSkgewogICAgICB2YXIgY2FjaGVkVmFsdWUgPSBudWxsOwogIAogICAgICAvLyBidWlsZCBlbnVtZXJhYmxlIGF0dHJpYnV0ZSBmb3IgZWFjaCB2YWx1ZSB3aXRoIGxhenkgYWNjZXNzb3IuCiAgICAgIHV0aWwucHJvcGVydHkob2JqLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoY2FjaGVkVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgIGNhY2hlZFZhbHVlID0gZ2V0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjYWNoZWRWYWx1ZTsKICAgICAgfSwgZW51bWVyYWJsZSk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBUT0RPIFJlbW92ZSBpbiBtYWpvciB2ZXJzaW9uIHJldmlzaW9uCiAgICAgKiBUaGlzIGJhY2tmaWxsIHBvcHVsYXRlcyByZXNwb25zZSBkYXRhIHdpdGhvdXQgdGhlCiAgICAgKiB0b3AtbGV2ZWwgcGF5bG9hZCBuYW1lLgogICAgICoKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBob2lzdFBheWxvYWRNZW1iZXI6IGZ1bmN0aW9uIGhvaXN0UGF5bG9hZE1lbWJlcihyZXNwKSB7CiAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgIHZhciBvcGVyYXRpb25OYW1lID0gcmVxLm9wZXJhdGlvbjsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbk5hbWVdOwogICAgICB2YXIgb3V0cHV0ID0gb3BlcmF0aW9uLm91dHB1dDsKICAgICAgaWYgKG91dHB1dC5wYXlsb2FkICYmICFvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQpIHsKICAgICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG91dHB1dC5tZW1iZXJzW291dHB1dC5wYXlsb2FkXTsKICAgICAgICB2YXIgcmVzcG9uc2VQYXlsb2FkID0gcmVzcC5kYXRhW291dHB1dC5wYXlsb2FkXTsKICAgICAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICAgICAgdXRpbC5lYWNoKHJlc3BvbnNlUGF5bG9hZCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICB1dGlsLnByb3BlcnR5KHJlc3AuZGF0YSwga2V5LCB2YWx1ZSwgZmFsc2UpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBDb21wdXRlIFNIQS0yNTYgY2hlY2tzdW1zIG9mIHN0cmVhbXMKICAgICAqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgY29tcHV0ZVNoYTI1NjogZnVuY3Rpb24gY29tcHV0ZVNoYTI1Nihib2R5LCBkb25lKSB7CiAgICAgIGlmICh1dGlsLmlzTm9kZSgpKSB7CiAgICAgICAgdmFyIFN0cmVhbSA9IHV0aWwuc3RyZWFtLlN0cmVhbTsKICAgICAgICB2YXIgZnMgPSByZXF1aXJlKCdmcycpOwogICAgICAgIGlmICh0eXBlb2YgU3RyZWFtID09PSAnZnVuY3Rpb24nICYmIGJvZHkgaW5zdGFuY2VvZiBTdHJlYW0pIHsKICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5wYXRoID09PSAnc3RyaW5nJykgeyAvLyBhc3N1bWUgZmlsZSBvYmplY3QKICAgICAgICAgICAgdmFyIHNldHRpbmdzID0ge307CiAgICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5zdGFydCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICBzZXR0aW5ncy5zdGFydCA9IGJvZHkuc3RhcnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBib2R5LmVuZCA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICBzZXR0aW5ncy5lbmQgPSBib2R5LmVuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ID0gZnMuY3JlYXRlUmVhZFN0cmVhbShib2R5LnBhdGgsIHNldHRpbmdzKTsKICAgICAgICAgIH0gZWxzZSB7IC8vIFRPRE8gc3VwcG9ydCBvdGhlciBzdHJlYW0gdHlwZXMKICAgICAgICAgICAgcmV0dXJuIGRvbmUobmV3IEVycm9yKCdOb24tZmlsZSBzdHJlYW0gb2JqZWN0cyBhcmUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbm90IHN1cHBvcnRlZCB3aXRoIFNpZ1Y0JykpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogIAogICAgICB1dGlsLmNyeXB0by5zaGEyNTYoYm9keSwgJ2hleCcsIGZ1bmN0aW9uKGVyciwgc2hhKSB7CiAgICAgICAgaWYgKGVycikgZG9uZShlcnIpOwogICAgICAgIGVsc2UgZG9uZShudWxsLCBzaGEpOwogICAgICB9KTsKICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpc0Nsb2NrU2tld2VkOiBmdW5jdGlvbiBpc0Nsb2NrU2tld2VkKHNlcnZlclRpbWUpIHsKICAgICAgaWYgKHNlcnZlclRpbWUpIHsKICAgICAgICB1dGlsLnByb3BlcnR5KEFXUy5jb25maWcsICdpc0Nsb2NrU2tld2VkJywKICAgICAgICAgIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gc2VydmVyVGltZSkgPj0gMzAwMDAwLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIEFXUy5jb25maWcuaXNDbG9ja1NrZXdlZDsKICAgICAgfQogICAgfSwKICAKICAgIGFwcGx5Q2xvY2tPZmZzZXQ6IGZ1bmN0aW9uIGFwcGx5Q2xvY2tPZmZzZXQoc2VydmVyVGltZSkgewogICAgICBpZiAoc2VydmVyVGltZSkKICAgICAgICBBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0ID0gc2VydmVyVGltZSAtIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGV4dHJhY3RSZXF1ZXN0SWQ6IGZ1bmN0aW9uIGV4dHJhY3RSZXF1ZXN0SWQocmVzcCkgewogICAgICB2YXIgcmVxdWVzdElkID0gcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXotcmVxdWVzdC1pZCddIHx8CiAgICAgICAgICAgICAgICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddOwogIAogICAgICBpZiAoIXJlcXVlc3RJZCAmJiByZXNwLmRhdGEgJiYgcmVzcC5kYXRhLlJlc3BvbnNlTWV0YWRhdGEpIHsKICAgICAgICByZXF1ZXN0SWQgPSByZXNwLmRhdGEuUmVzcG9uc2VNZXRhZGF0YS5SZXF1ZXN0SWQ7CiAgICAgIH0KICAKICAgICAgaWYgKHJlcXVlc3RJZCkgewogICAgICAgIHJlc3AucmVxdWVzdElkID0gcmVxdWVzdElkOwogICAgICB9CiAgCiAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgcmVzcC5lcnJvci5yZXF1ZXN0SWQgPSByZXF1ZXN0SWQ7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBhZGRQcm9taXNlczogZnVuY3Rpb24gYWRkUHJvbWlzZXMoY29uc3RydWN0b3JzLCBQcm9taXNlRGVwZW5kZW5jeSkgewogICAgICB2YXIgZGVsZXRlUHJvbWlzZXMgPSBmYWxzZTsKICAgICAgaWYgKFByb21pc2VEZXBlbmRlbmN5ID09PSB1bmRlZmluZWQgJiYgQVdTICYmIEFXUy5jb25maWcpIHsKICAgICAgICBQcm9taXNlRGVwZW5kZW5jeSA9IEFXUy5jb25maWcuZ2V0UHJvbWlzZXNEZXBlbmRlbmN5KCk7CiAgICAgIH0KICAgICAgaWYgKFByb21pc2VEZXBlbmRlbmN5ID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIFByb21pc2UgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgUHJvbWlzZURlcGVuZGVuY3kgPSBQcm9taXNlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgUHJvbWlzZURlcGVuZGVuY3kgIT09ICdmdW5jdGlvbicpIGRlbGV0ZVByb21pc2VzID0gdHJ1ZTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbnN0cnVjdG9ycykpIGNvbnN0cnVjdG9ycyA9IFtjb25zdHJ1Y3RvcnNdOwogIAogICAgICBmb3IgKHZhciBpbmQgPSAwOyBpbmQgPCBjb25zdHJ1Y3RvcnMubGVuZ3RoOyBpbmQrKykgewogICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yc1tpbmRdOwogICAgICAgIGlmIChkZWxldGVQcm9taXNlcykgewogICAgICAgICAgaWYgKGNvbnN0cnVjdG9yLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKSB7CiAgICAgICAgICAgIGNvbnN0cnVjdG9yLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChjb25zdHJ1Y3Rvci5hZGRQcm9taXNlc1RvQ2xhc3MpIHsKICAgICAgICAgIGNvbnN0cnVjdG9yLmFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZXR1cm4gYSBwcm9taXNlIHdob3NlIGZhdGUgaXMgZGVjaWRlZCBieSB0aGUKICAgICAqIGNhbGxiYWNrIGJlaGF2aW9yIG9mIHRoZSBnaXZlbiBtZXRob2Qgd2l0aCBgbWV0aG9kTmFtZWAuIFRoZSBtZXRob2QgdG8gYmUKICAgICAqIHByb21pc2lmaWVkIHNob3VsZCBjb25mb3JtIHRvIG5vZGUuanMgY29udmVudGlvbiBvZiBhY2NlcHRpbmcgYSBjYWxsYmFjayBhcwogICAgICogbGFzdCBhcmd1bWVudCBhbmQgY2FsbGluZyB0aGF0IGNhbGxiYWNrIHdpdGggZXJyb3IgYXMgdGhlIGZpcnN0IGFyZ3VtZW50CiAgICAgKiBhbmQgc3VjY2VzcyB2YWx1ZSBvbiB0aGUgc2Vjb25kIGFyZ3VtZW50LgogICAgICovCiAgICBwcm9taXNpZnlNZXRob2Q6IGZ1bmN0aW9uIHByb21pc2lmeU1ldGhvZChtZXRob2ROYW1lLCBQcm9taXNlRGVwZW5kZW5jeSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gcHJvbWlzZSgpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZURlcGVuZGVuY3koZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBhcmdzLnB1c2goZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHNlbGZbbWV0aG9kTmFtZV0uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaXNEdWFsc3RhY2tBdmFpbGFibGU6IGZ1bmN0aW9uIGlzRHVhbHN0YWNrQXZhaWxhYmxlKHNlcnZpY2UpIHsKICAgICAgaWYgKCFzZXJ2aWNlKSByZXR1cm4gZmFsc2U7CiAgICAgIHZhciBtZXRhZGF0YSA9IHJlcXVpcmUoJy4uL2FwaXMvbWV0YWRhdGEuanNvbicpOwogICAgICBpZiAodHlwZW9mIHNlcnZpY2UgIT09ICdzdHJpbmcnKSBzZXJ2aWNlID0gc2VydmljZS5zZXJ2aWNlSWRlbnRpZmllcjsKICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlICE9PSAnc3RyaW5nJyB8fCAhbWV0YWRhdGEuaGFzT3duUHJvcGVydHkoc2VydmljZSkpIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuICEhbWV0YWRhdGFbc2VydmljZV0uZHVhbHN0YWNrQXZhaWxhYmxlOwogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNhbGN1bGF0ZVJldHJ5RGVsYXk6IGZ1bmN0aW9uIGNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgcmV0cnlEZWxheU9wdGlvbnMpIHsKICAgICAgaWYgKCFyZXRyeURlbGF5T3B0aW9ucykgcmV0cnlEZWxheU9wdGlvbnMgPSB7fTsKICAgICAgdmFyIGN1c3RvbUJhY2tvZmYgPSByZXRyeURlbGF5T3B0aW9ucy5jdXN0b21CYWNrb2ZmIHx8IG51bGw7CiAgICAgIGlmICh0eXBlb2YgY3VzdG9tQmFja29mZiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBjdXN0b21CYWNrb2ZmKHJldHJ5Q291bnQpOwogICAgICB9CiAgICAgIHZhciBiYXNlID0gdHlwZW9mIHJldHJ5RGVsYXlPcHRpb25zLmJhc2UgPT09ICdudW1iZXInID8gcmV0cnlEZWxheU9wdGlvbnMuYmFzZSA6IDEwMDsKICAgICAgdmFyIGRlbGF5ID0gTWF0aC5yYW5kb20oKSAqIChNYXRoLnBvdygyLCByZXRyeUNvdW50KSAqIGJhc2UpOwogICAgICByZXR1cm4gZGVsYXk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgaGFuZGxlUmVxdWVzdFdpdGhSZXRyaWVzOiBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0V2l0aFJldHJpZXMoaHR0cFJlcXVlc3QsIG9wdGlvbnMsIGNiKSB7CiAgICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwogICAgICB2YXIgaHR0cCA9IEFXUy5IdHRwQ2xpZW50LmdldEluc3RhbmNlKCk7CiAgICAgIHZhciBodHRwT3B0aW9ucyA9IG9wdGlvbnMuaHR0cE9wdGlvbnMgfHwge307CiAgICAgIHZhciByZXRyeUNvdW50ID0gMDsKICAKICAgICAgdmFyIGVyckNhbGxiYWNrID0gZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgdmFyIG1heFJldHJpZXMgPSBvcHRpb25zLm1heFJldHJpZXMgfHwgMDsKICAgICAgICBpZiAoZXJyICYmIGVyci5jb2RlID09PSAnVGltZW91dEVycm9yJykgZXJyLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgICAgaWYgKGVyciAmJiBlcnIucmV0cnlhYmxlICYmIHJldHJ5Q291bnQgPCBtYXhSZXRyaWVzKSB7CiAgICAgICAgICByZXRyeUNvdW50Kys7CiAgICAgICAgICB2YXIgZGVsYXkgPSB1dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgb3B0aW9ucy5yZXRyeURlbGF5T3B0aW9ucyk7CiAgICAgICAgICBzZXRUaW1lb3V0KHNlbmRSZXF1ZXN0LCBkZWxheSArIChlcnIucmV0cnlBZnRlciB8fCAwKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNiKGVycik7CiAgICAgICAgfQogICAgICB9OwogIAogICAgICB2YXIgc2VuZFJlcXVlc3QgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGF0YSA9ICcnOwogICAgICAgIGh0dHAuaGFuZGxlUmVxdWVzdChodHRwUmVxdWVzdCwgaHR0cE9wdGlvbnMsIGZ1bmN0aW9uKGh0dHBSZXNwb25zZSkgewogICAgICAgICAgaHR0cFJlc3BvbnNlLm9uKCdkYXRhJywgZnVuY3Rpb24oY2h1bmspIHsgZGF0YSArPSBjaHVuay50b1N0cmluZygpOyB9KTsKICAgICAgICAgIGh0dHBSZXNwb25zZS5vbignZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgICAgICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgICAgICAgICAgY2IobnVsbCwgZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJldHJ5QWZ0ZXIgPSBwYXJzZUludChodHRwUmVzcG9uc2UuaGVhZGVyc1sncmV0cnktYWZ0ZXInXSwgMTApICogMTAwMCB8fCAwOwogICAgICAgICAgICAgIHZhciBlcnIgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAgICAgICAgeyByZXRyeWFibGU6IHN0YXR1c0NvZGUgPj0gNTAwIHx8IHN0YXR1c0NvZGUgPT09IDQyOSB9CiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAocmV0cnlBZnRlciAmJiBlcnIucmV0cnlhYmxlKSBlcnIucmV0cnlBZnRlciA9IHJldHJ5QWZ0ZXI7CiAgICAgICAgICAgICAgZXJyQ2FsbGJhY2soZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSwgZXJyQ2FsbGJhY2spOwogICAgICB9OwogIAogICAgICBBV1MudXRpbC5kZWZlcihzZW5kUmVxdWVzdCk7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgdXVpZDogewogICAgICB2NDogZnVuY3Rpb24gdXVpZFY0KCkgewogICAgICAgIHJldHVybiByZXF1aXJlKCd1dWlkJykudjQoKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbnZlcnRQYXlsb2FkVG9TdHJpbmc6IGZ1bmN0aW9uIGNvbnZlcnRQYXlsb2FkVG9TdHJpbmcocmVzcCkgewogICAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLm9wZXJhdGlvbjsKICAgICAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXS5vdXRwdXQgfHwge307CiAgICAgIGlmIChydWxlcy5wYXlsb2FkICYmIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSkgewogICAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXS50b1N0cmluZygpOwogICAgICB9CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmZXI6IGZ1bmN0aW9uIGRlZmVyKGNhbGxiYWNrKSB7CiAgICAgIGlmICh0eXBlb2YgcHJvY2VzcyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHByb2Nlc3MubmV4dFRpY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGNhbGxiYWNrKTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgc2V0SW1tZWRpYXRlKGNhbGxiYWNrKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRUaW1lb3V0KGNhbGxiYWNrLCAwKTsKICAgICAgfQogICAgfSwKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGdldFJlcXVlc3RQYXlsb2FkU2hhcGU6IGZ1bmN0aW9uIGdldFJlcXVlc3RQYXlsb2FkU2hhcGUocmVxKSB7CiAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnM7CiAgICAgIGlmICghb3BlcmF0aW9ucykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgdmFyIG9wZXJhdGlvbiA9IChvcGVyYXRpb25zIHx8IHt9KVtyZXEub3BlcmF0aW9uXTsKICAgICAgaWYgKCFvcGVyYXRpb24gfHwgIW9wZXJhdGlvbi5pbnB1dCB8fCAhb3BlcmF0aW9uLmlucHV0LnBheWxvYWQpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiBvcGVyYXRpb24uaW5wdXQubWVtYmVyc1tvcGVyYXRpb24uaW5wdXQucGF5bG9hZF07CiAgICB9LAogIAogICAgZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnOiBmdW5jdGlvbiBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWcoaW5pTG9hZGVyLCBmaWxlbmFtZSkgewogICAgICB2YXIgcHJvZmlsZXMgPSB7fTsKICAgICAgdmFyIHByb2ZpbGVzRnJvbUNvbmZpZyA9IHt9OwogICAgICBpZiAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0pIHsKICAgICAgICB2YXIgcHJvZmlsZXNGcm9tQ29uZmlnID0gaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICAgIGlzQ29uZmlnOiB0cnVlLAogICAgICAgICAgZmlsZW5hbWU6IHByb2Nlc3MuZW52W3V0aWwuc2hhcmVkQ29uZmlnRmlsZUVudl0KICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgcHJvZmlsZXNGcm9tQ3JlZHMgPSBpbmlMb2FkZXIubG9hZEZyb20oewogICAgICAgIGZpbGVuYW1lOiBmaWxlbmFtZSB8fAogICAgICAgICAgKHByb2Nlc3MuZW52W3V0aWwuY29uZmlnT3B0SW5FbnZdICYmIHByb2Nlc3MuZW52W3V0aWwuc2hhcmVkQ3JlZGVudGlhbHNGaWxlRW52XSkKICAgICAgfSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBwcm9maWxlTmFtZXMgPSBPYmplY3Qua2V5cyhwcm9maWxlc0Zyb21Db25maWcpOyBpIDwgcHJvZmlsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSA9IHByb2ZpbGVzRnJvbUNvbmZpZ1twcm9maWxlTmFtZXNbaV1dOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwLCBwcm9maWxlTmFtZXMgPSBPYmplY3Qua2V5cyhwcm9maWxlc0Zyb21DcmVkcyk7IGkgPCBwcm9maWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dID0gcHJvZmlsZXNGcm9tQ3JlZHNbcHJvZmlsZU5hbWVzW2ldXTsKICAgICAgfQogICAgICByZXR1cm4gcHJvZmlsZXM7CiAgICB9LAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgZGVmYXVsdFByb2ZpbGU6ICdkZWZhdWx0JywKICAKICAgIC8qKgogICAgICogQGFwaSBwcml2YXRlCiAgICAgKi8KICAgIGNvbmZpZ09wdEluRW52OiAnQVdTX1NES19MT0FEX0NPTkZJRycsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBzaGFyZWRDcmVkZW50aWFsc0ZpbGVFbnY6ICdBV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUnLAogIAogICAgLyoqCiAgICAgKiBAYXBpIHByaXZhdGUKICAgICAqLwogICAgc2hhcmVkQ29uZmlnRmlsZUVudjogJ0FXU19DT05GSUdfRklMRScsCiAgCiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBpbWRzRGlzYWJsZWRFbnY6ICdBV1NfRUMyX01FVEFEQVRBX0RJU0FCTEVEJwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB1dGlsOwogIAogIH0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSxyZXF1aXJlKCJ0aW1lcnMiKS5zZXRJbW1lZGlhdGUpCiAgfSx7Ii4uL2FwaXMvbWV0YWRhdGEuanNvbiI6NCwiLi9jb3JlIjoxOCwiX3Byb2Nlc3MiOjg2LCJmcyI6NzksInRpbWVycyI6OTMsInV1aWQiOjk4fV0sNzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwogIHZhciBTaGFwZSA9IHJlcXVpcmUoJy4uL21vZGVsL3NoYXBlJyk7CiAgCiAgZnVuY3Rpb24gRG9tWG1sUGFyc2VyKCkgeyB9CiAgCiAgRG9tWG1sUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKHhtbCwgc2hhcGUpIHsKICAgIGlmICh4bWwucmVwbGFjZSgvXlxzKy8sICcnKSA9PT0gJycpIHJldHVybiB7fTsKICAKICAgIHZhciByZXN1bHQsIGVycm9yOwogICAgdHJ5IHsKICAgICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKICAgICAgICAgIHJlc3VsdCA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoeG1sLCAndGV4dC94bWwnKTsKICAgICAgICB9IGNhdGNoIChzeW50YXhFcnJvcikgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ1BhcnNlIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yOiBzeW50YXhFcnJvciwKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQgPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgcGFyc2UgZW1wdHkgZG9jdW1lbnQuJyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgICAgdmFyIGlzRXJyb3IgPSByZXN1bHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3BhcnNlcmVycm9yJylbMF07CiAgICAgICAgaWYgKGlzRXJyb3IgJiYgKGlzRXJyb3IucGFyZW50Tm9kZSA9PT0gcmVzdWx0IHx8CiAgICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5ub2RlTmFtZSA9PT0gJ2JvZHknIHx8CiAgICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSByZXN1bHQgfHwKICAgICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLnBhcmVudE5vZGUubm9kZU5hbWUgPT09ICdib2R5JykpIHsKICAgICAgICAgIHZhciBlcnJvckVsZW1lbnQgPSBpc0Vycm9yLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkaXYnKVswXSB8fCBpc0Vycm9yOwogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoZXJyb3JFbGVtZW50LnRleHRDb250ZW50IHx8ICdQYXJzZXIgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgewogICAgICAgIHJlc3VsdCA9IG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTERPTScpOwogICAgICAgIHJlc3VsdC5hc3luYyA9IGZhbHNlOwogIAogICAgICAgIGlmICghcmVzdWx0LmxvYWRYTUwoeG1sKSkgewogICAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ1BhcnNlIGVycm9yIGluIGRvY3VtZW50JyksCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb2RlOiAnWE1MUGFyc2VyRXJyb3InLAogICAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbG9hZCBYTUwgcGFyc2VyJyk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZXJyb3IgPSBlOwogICAgfQogIAogICAgaWYgKHJlc3VsdCAmJiByZXN1bHQuZG9jdW1lbnRFbGVtZW50ICYmICFlcnJvcikgewogICAgICB2YXIgZGF0YSA9IHBhcnNlWG1sKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQsIHNoYXBlKTsKICAgICAgdmFyIG1ldGFkYXRhID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShyZXN1bHQuZG9jdW1lbnRFbGVtZW50LCAnUmVzcG9uc2VNZXRhZGF0YScpOwogICAgICBpZiAobWV0YWRhdGEpIHsKICAgICAgICBkYXRhLlJlc3BvbnNlTWV0YWRhdGEgPSBwYXJzZVhtbChtZXRhZGF0YSwge30pOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfSBlbHNlIGlmIChlcnJvcikgewogICAgICB0aHJvdyB1dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCB7Y29kZTogJ1hNTFBhcnNlckVycm9yJywgcmV0cnlhYmxlOiB0cnVlfSk7CiAgICB9IGVsc2UgeyAvLyBlbXB0eSB4bWwgZG9jdW1lbnQKICAgICAgcmV0dXJuIHt9OwogICAgfQogIH07CiAgCiAgZnVuY3Rpb24gZ2V0RWxlbWVudEJ5VGFnTmFtZSh4bWwsIHRhZykgewogICAgdmFyIGVsZW1lbnRzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CiAgICBmb3IgKHZhciBpID0gMCwgaUxlbiA9IGVsZW1lbnRzLmxlbmd0aDsgaSA8IGlMZW47IGkrKykgewogICAgICBpZiAoZWxlbWVudHNbaV0ucGFyZW50Tm9kZSA9PT0geG1sKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRzW2ldOwogICAgICB9CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlWG1sKHhtbCwgc2hhcGUpIHsKICAgIGlmICghc2hhcGUpIHNoYXBlID0ge307CiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpOwogICAgICBjYXNlICdtYXAnOiByZXR1cm4gcGFyc2VNYXAoeG1sLCBzaGFwZSk7CiAgICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gcGFyc2VMaXN0KHhtbCwgc2hhcGUpOwogICAgICBjYXNlIHVuZGVmaW5lZDogY2FzZSBudWxsOiByZXR1cm4gcGFyc2VVbmtub3duKHhtbCk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiBwYXJzZVNjYWxhcih4bWwsIHNoYXBlKTsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSkgewogICAgdmFyIGRhdGEgPSB7fTsKICAgIGlmICh4bWwgPT09IG51bGwpIHJldHVybiBkYXRhOwogIAogICAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG1lbWJlck5hbWUsIG1lbWJlclNoYXBlKSB7CiAgICAgIGlmIChtZW1iZXJTaGFwZS5pc1htbEF0dHJpYnV0ZSkgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoeG1sLmF0dHJpYnV0ZXMsIG1lbWJlclNoYXBlLm5hbWUpKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSB4bWwuYXR0cmlidXRlc1ttZW1iZXJTaGFwZS5uYW1lXS52YWx1ZTsKICAgICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBwYXJzZVhtbCh7dGV4dENvbnRlbnQ6IHZhbHVlfSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgeG1sQ2hpbGQgPSBtZW1iZXJTaGFwZS5mbGF0dGVuZWQgPyB4bWwgOgogICAgICAgICAgZ2V0RWxlbWVudEJ5VGFnTmFtZSh4bWwsIG1lbWJlclNoYXBlLm5hbWUpOwogICAgICAgIGlmICh4bWxDaGlsZCkgewogICAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IHBhcnNlWG1sKHhtbENoaWxkLCBtZW1iZXJTaGFwZSk7CiAgICAgICAgfSBlbHNlIGlmICghbWVtYmVyU2hhcGUuZmxhdHRlbmVkICYmIG1lbWJlclNoYXBlLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IG1lbWJlclNoYXBlLmRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIGRhdGE7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlTWFwKHhtbCwgc2hhcGUpIHsKICAgIHZhciBkYXRhID0ge307CiAgICB2YXIgeG1sS2V5ID0gc2hhcGUua2V5Lm5hbWUgfHwgJ2tleSc7CiAgICB2YXIgeG1sVmFsdWUgPSBzaGFwZS52YWx1ZS5uYW1lIHx8ICd2YWx1ZSc7CiAgICB2YXIgdGFnTmFtZSA9IHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAnZW50cnknOwogIAogICAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PT0gdGFnTmFtZSkgewogICAgICAgIHZhciBrZXkgPSBnZXRFbGVtZW50QnlUYWdOYW1lKGNoaWxkLCB4bWxLZXkpLnRleHRDb250ZW50OwogICAgICAgIHZhciB2YWx1ZSA9IGdldEVsZW1lbnRCeVRhZ05hbWUoY2hpbGQsIHhtbFZhbHVlKTsKICAgICAgICBkYXRhW2tleV0gPSBwYXJzZVhtbCh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgICB9CiAgICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlTGlzdCh4bWwsIHNoYXBlKSB7CiAgICB2YXIgZGF0YSA9IFtdOwogICAgdmFyIHRhZ05hbWUgPSBzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogKHNoYXBlLm1lbWJlci5uYW1lIHx8ICdtZW1iZXInKTsKICAKICAgIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICAgIHdoaWxlIChjaGlsZCkgewogICAgICBpZiAoY2hpbGQubm9kZU5hbWUgPT09IHRhZ05hbWUpIHsKICAgICAgICBkYXRhLnB1c2gocGFyc2VYbWwoY2hpbGQsIHNoYXBlLm1lbWJlcikpOwogICAgICB9CiAgICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgfQogICAgcmV0dXJuIGRhdGE7CiAgfQogIAogIGZ1bmN0aW9uIHBhcnNlU2NhbGFyKHhtbCwgc2hhcGUpIHsKICAgIGlmICh4bWwuZ2V0QXR0cmlidXRlKSB7CiAgICAgIHZhciBlbmNvZGluZyA9IHhtbC5nZXRBdHRyaWJ1dGUoJ2VuY29kaW5nJyk7CiAgICAgIGlmIChlbmNvZGluZyA9PT0gJ2Jhc2U2NCcpIHsKICAgICAgICBzaGFwZSA9IG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6IGVuY29kaW5nfSk7CiAgICAgIH0KICAgIH0KICAKICAgIHZhciB0ZXh0ID0geG1sLnRleHRDb250ZW50OwogICAgaWYgKHRleHQgPT09ICcnKSB0ZXh0ID0gbnVsbDsKICAgIGlmICh0eXBlb2Ygc2hhcGUudG9UeXBlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBzaGFwZS50b1R5cGUodGV4dCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGV4dDsKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gcGFyc2VVbmtub3duKHhtbCkgewogICAgaWYgKHhtbCA9PT0gdW5kZWZpbmVkIHx8IHhtbCA9PT0gbnVsbCkgcmV0dXJuICcnOwogIAogICAgLy8gZW1wdHkgb2JqZWN0CiAgICBpZiAoIXhtbC5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgICBpZiAoeG1sLnBhcmVudE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgcmV0dXJuIHt9OwogICAgICBpZiAoeG1sLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwKSByZXR1cm4gJyc7CiAgICAgIGVsc2UgcmV0dXJuIHhtbC50ZXh0Q29udGVudDsKICAgIH0KICAKICAgIC8vIG9iamVjdCwgcGFyc2UgYXMgc3RydWN0dXJlCiAgICB2YXIgc2hhcGUgPSB7dHlwZTogJ3N0cnVjdHVyZScsIG1lbWJlcnM6IHt9fTsKICAgIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICAgIHdoaWxlIChjaGlsZCkgewogICAgICB2YXIgdGFnID0gY2hpbGQubm9kZU5hbWU7CiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc2hhcGUubWVtYmVycywgdGFnKSkgewogICAgICAgIC8vIG11bHRpcGxlIHRhZ3Mgb2YgdGhlIHNhbWUgbmFtZSBtYWtlcyBpdCBhIGxpc3QKICAgICAgICBzaGFwZS5tZW1iZXJzW3RhZ10udHlwZSA9ICdsaXN0JzsKICAgICAgfSBlbHNlIHsKICAgICAgICBzaGFwZS5tZW1iZXJzW3RhZ10gPSB7bmFtZTogdGFnfTsKICAgICAgfQogICAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICAgIH0KICAgIHJldHVybiBwYXJzZVN0cnVjdHVyZSh4bWwsIHNoYXBlKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSBEb21YbWxQYXJzZXI7CiAgCiAgfSx7Ii4uL21vZGVsL3NoYXBlIjo0MywiLi4vdXRpbCI6NzF9XSw3MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CiAgdmFyIFhtbE5vZGUgPSByZXF1aXJlKCcuL3htbC1ub2RlJykuWG1sTm9kZTsKICB2YXIgWG1sVGV4dCA9IHJlcXVpcmUoJy4veG1sLXRleHQnKS5YbWxUZXh0OwogIAogIGZ1bmN0aW9uIFhtbEJ1aWxkZXIoKSB7IH0KICAKICBYbWxCdWlsZGVyLnByb3RvdHlwZS50b1hNTCA9IGZ1bmN0aW9uKHBhcmFtcywgc2hhcGUsIHJvb3RFbGVtZW50LCBub0VtcHR5KSB7CiAgICB2YXIgeG1sID0gbmV3IFhtbE5vZGUocm9vdEVsZW1lbnQpOwogICAgYXBwbHlOYW1lc3BhY2VzKHhtbCwgc2hhcGUsIHRydWUpOwogICAgc2VyaWFsaXplKHhtbCwgcGFyYW1zLCBzaGFwZSk7CiAgICByZXR1cm4geG1sLmNoaWxkcmVuLmxlbmd0aCA+IDAgfHwgbm9FbXB0eSA/IHhtbC50b1N0cmluZygpIDogJyc7CiAgfTsKICAKICBmdW5jdGlvbiBzZXJpYWxpemUoeG1sLCB2YWx1ZSwgc2hhcGUpIHsKICAgIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gc2VyaWFsaXplU3RydWN0dXJlKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgICAgY2FzZSAnbWFwJzogcmV0dXJuIHNlcmlhbGl6ZU1hcCh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gc2VyaWFsaXplTGlzdCh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICAgIGRlZmF1bHQ6IHJldHVybiBzZXJpYWxpemVTY2FsYXIoeG1sLCB2YWx1ZSwgc2hhcGUpOwogICAgfQogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVTdHJ1Y3R1cmUoeG1sLCBwYXJhbXMsIHNoYXBlKSB7CiAgICB1dGlsLmFycmF5RWFjaChzaGFwZS5tZW1iZXJOYW1lcywgZnVuY3Rpb24obWVtYmVyTmFtZSkgewogICAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW21lbWJlck5hbWVdOwogICAgICBpZiAobWVtYmVyU2hhcGUubG9jYXRpb24gIT09ICdib2R5JykgcmV0dXJuOwogIAogICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbbWVtYmVyTmFtZV07CiAgICAgIHZhciBuYW1lID0gbWVtYmVyU2hhcGUubmFtZTsKICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICBpZiAobWVtYmVyU2hhcGUuaXNYbWxBdHRyaWJ1dGUpIHsKICAgICAgICAgIHhtbC5hZGRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAobWVtYmVyU2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgICAgICBzZXJpYWxpemUoeG1sLCB2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgICAgeG1sLmFkZENoaWxkTm9kZShlbGVtZW50KTsKICAgICAgICAgIGFwcGx5TmFtZXNwYWNlcyhlbGVtZW50LCBtZW1iZXJTaGFwZSk7CiAgICAgICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVNYXAoeG1sLCBtYXAsIHNoYXBlKSB7CiAgICB2YXIgeG1sS2V5ID0gc2hhcGUua2V5Lm5hbWUgfHwgJ2tleSc7CiAgICB2YXIgeG1sVmFsdWUgPSBzaGFwZS52YWx1ZS5uYW1lIHx8ICd2YWx1ZSc7CiAgCiAgICB1dGlsLmVhY2gobWFwLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHZhciBlbnRyeSA9IG5ldyBYbWxOb2RlKHNoYXBlLmZsYXR0ZW5lZCA/IHNoYXBlLm5hbWUgOiAnZW50cnknKTsKICAgICAgeG1sLmFkZENoaWxkTm9kZShlbnRyeSk7CiAgCiAgICAgIHZhciBlbnRyeUtleSA9IG5ldyBYbWxOb2RlKHhtbEtleSk7CiAgICAgIHZhciBlbnRyeVZhbHVlID0gbmV3IFhtbE5vZGUoeG1sVmFsdWUpOwogICAgICBlbnRyeS5hZGRDaGlsZE5vZGUoZW50cnlLZXkpOwogICAgICBlbnRyeS5hZGRDaGlsZE5vZGUoZW50cnlWYWx1ZSk7CiAgCiAgICAgIHNlcmlhbGl6ZShlbnRyeUtleSwga2V5LCBzaGFwZS5rZXkpOwogICAgICBzZXJpYWxpemUoZW50cnlWYWx1ZSwgdmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgIH0pOwogIH0KICAKICBmdW5jdGlvbiBzZXJpYWxpemVMaXN0KHhtbCwgbGlzdCwgc2hhcGUpIHsKICAgIGlmIChzaGFwZS5mbGF0dGVuZWQpIHsKICAgICAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgbmFtZSA9IHNoYXBlLm1lbWJlci5uYW1lIHx8IHNoYXBlLm5hbWU7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBuYW1lID0gc2hhcGUubWVtYmVyLm5hbWUgfHwgJ21lbWJlcic7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgWG1sTm9kZShuYW1lKTsKICAgICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgICAgfSk7CiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIHNlcmlhbGl6ZVNjYWxhcih4bWwsIHZhbHVlLCBzaGFwZSkgewogICAgeG1sLmFkZENoaWxkTm9kZSgKICAgICAgbmV3IFhtbFRleHQoc2hhcGUudG9XaXJlRm9ybWF0KHZhbHVlKSkKICAgICk7CiAgfQogIAogIGZ1bmN0aW9uIGFwcGx5TmFtZXNwYWNlcyh4bWwsIHNoYXBlLCBpc1Jvb3QpIHsKICAgIHZhciB1cmksIHByZWZpeCA9ICd4bWxucyc7CiAgICBpZiAoc2hhcGUueG1sTmFtZXNwYWNlVXJpKSB7CiAgICAgIHVyaSA9IHNoYXBlLnhtbE5hbWVzcGFjZVVyaTsKICAgICAgaWYgKHNoYXBlLnhtbE5hbWVzcGFjZVByZWZpeCkgcHJlZml4ICs9ICc6JyArIHNoYXBlLnhtbE5hbWVzcGFjZVByZWZpeDsKICAgIH0gZWxzZSBpZiAoaXNSb290ICYmIHNoYXBlLmFwaS54bWxOYW1lc3BhY2VVcmkpIHsKICAgICAgdXJpID0gc2hhcGUuYXBpLnhtbE5hbWVzcGFjZVVyaTsKICAgIH0KICAKICAgIGlmICh1cmkpIHhtbC5hZGRBdHRyaWJ1dGUocHJlZml4LCB1cmkpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IFhtbEJ1aWxkZXI7CiAgCiAgfSx7Ii4uL3V0aWwiOjcxLCIuL3htbC1ub2RlIjo3NiwiLi94bWwtdGV4dCI6Nzd9XSw3NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogRXNjYXBlcyBjaGFyYWN0ZXJzIHRoYXQgY2FuIG5vdCBiZSBpbiBhbiBYTUwgYXR0cmlidXRlLgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZUF0dHJpYnV0ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC8nL2csICcmYXBvczsnKS5yZXBsYWNlKC88L2csICcmbHQ7JykucmVwbGFjZSgvPi9nLCAnJmd0OycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwogIH0KICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZXNjYXBlQXR0cmlidXRlOiBlc2NhcGVBdHRyaWJ1dGUKICB9OwogIAogIH0se31dLDc1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvKioKICAgKiBFc2NhcGVzIGNoYXJhY3RlcnMgdGhhdCBjYW4gbm90IGJlIGluIGFuIFhNTCBlbGVtZW50LgogICAqLwogIGZ1bmN0aW9uIGVzY2FwZUVsZW1lbnQodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKTsKICB9CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGVzY2FwZUVsZW1lbnQ6IGVzY2FwZUVsZW1lbnQKICB9OwogIAogIH0se31dLDc2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgZXNjYXBlQXR0cmlidXRlID0gcmVxdWlyZSgnLi9lc2NhcGUtYXR0cmlidXRlJykuZXNjYXBlQXR0cmlidXRlOwogIAogIC8qKgogICAqIFJlcHJlc2VudHMgYW4gWE1MIG5vZGUuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZnVuY3Rpb24gWG1sTm9kZShuYW1lLCBjaGlsZHJlbikgewogICAgICBpZiAoY2hpbGRyZW4gPT09IHZvaWQgMCkgeyBjaGlsZHJlbiA9IFtdOyB9CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgfQogIFhtbE5vZGUucHJvdG90eXBlLmFkZEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSkgewogICAgICB0aGlzLmF0dHJpYnV0ZXNbbmFtZV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICBYbWxOb2RlLnByb3RvdHlwZS5hZGRDaGlsZE5vZGUgPSBmdW5jdGlvbiAoY2hpbGQpIHsKICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgfTsKICBYbWxOb2RlLnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICBkZWxldGUgdGhpcy5hdHRyaWJ1dGVzW25hbWVdOwogICAgICByZXR1cm4gdGhpczsKICB9OwogIFhtbE5vZGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgaGFzQ2hpbGRyZW4gPSBCb29sZWFuKHRoaXMuY2hpbGRyZW4ubGVuZ3RoKTsKICAgICAgdmFyIHhtbFRleHQgPSAnPCcgKyB0aGlzLm5hbWU7CiAgICAgIC8vIGFkZCBhdHRyaWJ1dGVzCiAgICAgIHZhciBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgICBmb3IgKHZhciBpID0gMCwgYXR0cmlidXRlTmFtZXMgPSBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKTsgaSA8IGF0dHJpYnV0ZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgYXR0cmlidXRlTmFtZSA9IGF0dHJpYnV0ZU5hbWVzW2ldOwogICAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlTmFtZV07CiAgICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgYXR0cmlidXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgeG1sVGV4dCArPSAnICcgKyBhdHRyaWJ1dGVOYW1lICsgJz1cIicgKyBlc2NhcGVBdHRyaWJ1dGUoJycgKyBhdHRyaWJ1dGUpICsgJ1wiJzsKICAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4geG1sVGV4dCArPSAhaGFzQ2hpbGRyZW4gPyAnLz4nIDogJz4nICsgdGhpcy5jaGlsZHJlbi5tYXAoZnVuY3Rpb24gKGMpIHsgcmV0dXJuIGMudG9TdHJpbmcoKTsgfSkuam9pbignJykgKyAnPC8nICsgdGhpcy5uYW1lICsgJz4nOwogIH07CiAgCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFhtbE5vZGU6IFhtbE5vZGUKICB9OwogIAogIH0seyIuL2VzY2FwZS1hdHRyaWJ1dGUiOjc0fV0sNzc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciBlc2NhcGVFbGVtZW50ID0gcmVxdWlyZSgnLi9lc2NhcGUtZWxlbWVudCcpLmVzY2FwZUVsZW1lbnQ7CiAgCiAgLyoqCiAgICogUmVwcmVzZW50cyBhbiBYTUwgdGV4dCB2YWx1ZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBmdW5jdGlvbiBYbWxUZXh0KHZhbHVlKSB7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICB9CiAgCiAgWG1sVGV4dC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBlc2NhcGVFbGVtZW50KCcnICsgdGhpcy52YWx1ZSk7CiAgfTsKICAKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgWG1sVGV4dDogWG1sVGV4dAogIH07CiAgCiAgfSx7Ii4vZXNjYXBlLWVsZW1lbnQiOjc1fV0sNzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogICd1c2Ugc3RyaWN0JwogIAogIGV4cG9ydHMuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKICBleHBvcnRzLnRvQnl0ZUFycmF5ID0gdG9CeXRlQXJyYXkKICBleHBvcnRzLmZyb21CeXRlQXJyYXkgPSBmcm9tQnl0ZUFycmF5CiAgCiAgdmFyIGxvb2t1cCA9IFtdCiAgdmFyIHJldkxvb2t1cCA9IFtdCiAgdmFyIEFyciA9IHR5cGVvZiBVaW50OEFycmF5ICE9PSAndW5kZWZpbmVkJyA/IFVpbnQ4QXJyYXkgOiBBcnJheQogIAogIHZhciBjb2RlID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8nCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNvZGUubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgIGxvb2t1cFtpXSA9IGNvZGVbaV0KICAgIHJldkxvb2t1cFtjb2RlLmNoYXJDb2RlQXQoaSldID0gaQogIH0KICAKICAvLyBTdXBwb3J0IGRlY29kaW5nIFVSTC1zYWZlIGJhc2U2NCBzdHJpbmdzLCBhcyBOb2RlLmpzIGRvZXMuCiAgLy8gU2VlOiBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9CYXNlNjQjVVJMX2FwcGxpY2F0aW9ucwogIHJldkxvb2t1cFsnLScuY2hhckNvZGVBdCgwKV0gPSA2MgogIHJldkxvb2t1cFsnXycuY2hhckNvZGVBdCgwKV0gPSA2MwogIAogIGZ1bmN0aW9uIGdldExlbnMgKGI2NCkgewogICAgdmFyIGxlbiA9IGI2NC5sZW5ndGgKICAKICAgIGlmIChsZW4gJSA0ID4gMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc3RyaW5nLiBMZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDQnKQogICAgfQogIAogICAgLy8gVHJpbSBvZmYgZXh0cmEgYnl0ZXMgYWZ0ZXIgcGxhY2Vob2xkZXIgYnl0ZXMgYXJlIGZvdW5kCiAgICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9iZWF0Z2FtbWl0L2Jhc2U2NC1qcy9pc3N1ZXMvNDIKICAgIHZhciB2YWxpZExlbiA9IGI2NC5pbmRleE9mKCc9JykKICAgIGlmICh2YWxpZExlbiA9PT0gLTEpIHZhbGlkTGVuID0gbGVuCiAgCiAgICB2YXIgcGxhY2VIb2xkZXJzTGVuID0gdmFsaWRMZW4gPT09IGxlbgogICAgICA/IDAKICAgICAgOiA0IC0gKHZhbGlkTGVuICUgNCkKICAKICAgIHJldHVybiBbdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbl0KICB9CiAgCiAgLy8gYmFzZTY0IGlzIDQvMyArIHVwIHRvIHR3byBjaGFyYWN0ZXJzIG9mIHRoZSBvcmlnaW5hbCBkYXRhCiAgZnVuY3Rpb24gYnl0ZUxlbmd0aCAoYjY0KSB7CiAgICB2YXIgbGVucyA9IGdldExlbnMoYjY0KQogICAgdmFyIHZhbGlkTGVuID0gbGVuc1swXQogICAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IGxlbnNbMV0KICAgIHJldHVybiAoKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0KSAtIHBsYWNlSG9sZGVyc0xlbgogIH0KICAKICBmdW5jdGlvbiBfYnl0ZUxlbmd0aCAoYjY0LCB2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuKSB7CiAgICByZXR1cm4gKCh2YWxpZExlbiArIHBsYWNlSG9sZGVyc0xlbikgKiAzIC8gNCkgLSBwbGFjZUhvbGRlcnNMZW4KICB9CiAgCiAgZnVuY3Rpb24gdG9CeXRlQXJyYXkgKGI2NCkgewogICAgdmFyIHRtcAogICAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCkKICAgIHZhciB2YWxpZExlbiA9IGxlbnNbMF0KICAgIHZhciBwbGFjZUhvbGRlcnNMZW4gPSBsZW5zWzFdCiAgCiAgICB2YXIgYXJyID0gbmV3IEFycihfYnl0ZUxlbmd0aChiNjQsIHZhbGlkTGVuLCBwbGFjZUhvbGRlcnNMZW4pKQogIAogICAgdmFyIGN1ckJ5dGUgPSAwCiAgCiAgICAvLyBpZiB0aGVyZSBhcmUgcGxhY2Vob2xkZXJzLCBvbmx5IGdldCB1cCB0byB0aGUgbGFzdCBjb21wbGV0ZSA0IGNoYXJzCiAgICB2YXIgbGVuID0gcGxhY2VIb2xkZXJzTGVuID4gMAogICAgICA/IHZhbGlkTGVuIC0gNAogICAgICA6IHZhbGlkTGVuCiAgCiAgICB2YXIgaQogICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSArPSA0KSB7CiAgICAgIHRtcCA9CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMTgpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPDwgMTIpIHwKICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAyKV0gPDwgNikgfAogICAgICAgIHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMyldCiAgICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiAxNikgJiAweEZGCiAgICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiA4KSAmIDB4RkYKICAgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgICB9CiAgCiAgICBpZiAocGxhY2VIb2xkZXJzTGVuID09PSAyKSB7CiAgICAgIHRtcCA9CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpKV0gPDwgMikgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA+PiA0KQogICAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICAgIH0KICAKICAgIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDEpIHsKICAgICAgdG1wID0KICAgICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxMCkgfAogICAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCA0KSB8CiAgICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildID4+IDIpCiAgICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiA4KSAmIDB4RkYKICAgICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gYXJyCiAgfQogIAogIGZ1bmN0aW9uIHRyaXBsZXRUb0Jhc2U2NCAobnVtKSB7CiAgICByZXR1cm4gbG9va3VwW251bSA+PiAxOCAmIDB4M0ZdICsKICAgICAgbG9va3VwW251bSA+PiAxMiAmIDB4M0ZdICsKICAgICAgbG9va3VwW251bSA+PiA2ICYgMHgzRl0gKwogICAgICBsb29rdXBbbnVtICYgMHgzRl0KICB9CiAgCiAgZnVuY3Rpb24gZW5jb2RlQ2h1bmsgKHVpbnQ4LCBzdGFydCwgZW5kKSB7CiAgICB2YXIgdG1wCiAgICB2YXIgb3V0cHV0ID0gW10KICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgaSArPSAzKSB7CiAgICAgIHRtcCA9CiAgICAgICAgKCh1aW50OFtpXSA8PCAxNikgJiAweEZGMDAwMCkgKwogICAgICAgICgodWludDhbaSArIDFdIDw8IDgpICYgMHhGRjAwKSArCiAgICAgICAgKHVpbnQ4W2kgKyAyXSAmIDB4RkYpCiAgICAgIG91dHB1dC5wdXNoKHRyaXBsZXRUb0Jhc2U2NCh0bXApKQogICAgfQogICAgcmV0dXJuIG91dHB1dC5qb2luKCcnKQogIH0KICAKICBmdW5jdGlvbiBmcm9tQnl0ZUFycmF5ICh1aW50OCkgewogICAgdmFyIHRtcAogICAgdmFyIGxlbiA9IHVpbnQ4Lmxlbmd0aAogICAgdmFyIGV4dHJhQnl0ZXMgPSBsZW4gJSAzIC8vIGlmIHdlIGhhdmUgMSBieXRlIGxlZnQsIHBhZCAyIGJ5dGVzCiAgICB2YXIgcGFydHMgPSBbXQogICAgdmFyIG1heENodW5rTGVuZ3RoID0gMTYzODMgLy8gbXVzdCBiZSBtdWx0aXBsZSBvZiAzCiAgCiAgICAvLyBnbyB0aHJvdWdoIHRoZSBhcnJheSBldmVyeSB0aHJlZSBieXRlcywgd2UnbGwgZGVhbCB3aXRoIHRyYWlsaW5nIHN0dWZmIGxhdGVyCiAgICBmb3IgKHZhciBpID0gMCwgbGVuMiA9IGxlbiAtIGV4dHJhQnl0ZXM7IGkgPCBsZW4yOyBpICs9IG1heENodW5rTGVuZ3RoKSB7CiAgICAgIHBhcnRzLnB1c2goZW5jb2RlQ2h1bmsodWludDgsIGksIChpICsgbWF4Q2h1bmtMZW5ndGgpID4gbGVuMiA/IGxlbjIgOiAoaSArIG1heENodW5rTGVuZ3RoKSkpCiAgICB9CiAgCiAgICAvLyBwYWQgdGhlIGVuZCB3aXRoIHplcm9zLCBidXQgbWFrZSBzdXJlIHRvIG5vdCBmb3JnZXQgdGhlIGV4dHJhIGJ5dGVzCiAgICBpZiAoZXh0cmFCeXRlcyA9PT0gMSkgewogICAgICB0bXAgPSB1aW50OFtsZW4gLSAxXQogICAgICBwYXJ0cy5wdXNoKAogICAgICAgIGxvb2t1cFt0bXAgPj4gMl0gKwogICAgICAgIGxvb2t1cFsodG1wIDw8IDQpICYgMHgzRl0gKwogICAgICAgICc9PScKICAgICAgKQogICAgfSBlbHNlIGlmIChleHRyYUJ5dGVzID09PSAyKSB7CiAgICAgIHRtcCA9ICh1aW50OFtsZW4gLSAyXSA8PCA4KSArIHVpbnQ4W2xlbiAtIDFdCiAgICAgIHBhcnRzLnB1c2goCiAgICAgICAgbG9va3VwW3RtcCA+PiAxMF0gKwogICAgICAgIGxvb2t1cFsodG1wID4+IDQpICYgMHgzRl0gKwogICAgICAgIGxvb2t1cFsodG1wIDw8IDIpICYgMHgzRl0gKwogICAgICAgICc9JwogICAgICApCiAgICB9CiAgCiAgICByZXR1cm4gcGFydHMuam9pbignJykKICB9CiAgCiAgfSx7fV0sNzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIAogIH0se31dLDgwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKGdsb2JhbCl7KGZ1bmN0aW9uICgpewogIC8qISBodHRwczovL210aHMuYmUvcHVueWNvZGUgdjEuMy4yIGJ5IEBtYXRoaWFzICovCiAgOyhmdW5jdGlvbihyb290KSB7CiAgCiAgICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGVzICovCiAgICB2YXIgZnJlZUV4cG9ydHMgPSB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JyAmJiBleHBvcnRzICYmCiAgICAgICFleHBvcnRzLm5vZGVUeXBlICYmIGV4cG9ydHM7CiAgICB2YXIgZnJlZU1vZHVsZSA9IHR5cGVvZiBtb2R1bGUgPT0gJ29iamVjdCcgJiYgbW9kdWxlICYmCiAgICAgICFtb2R1bGUubm9kZVR5cGUgJiYgbW9kdWxlOwogICAgdmFyIGZyZWVHbG9iYWwgPSB0eXBlb2YgZ2xvYmFsID09ICdvYmplY3QnICYmIGdsb2JhbDsKICAgIGlmICgKICAgICAgZnJlZUdsb2JhbC5nbG9iYWwgPT09IGZyZWVHbG9iYWwgfHwKICAgICAgZnJlZUdsb2JhbC53aW5kb3cgPT09IGZyZWVHbG9iYWwgfHwKICAgICAgZnJlZUdsb2JhbC5zZWxmID09PSBmcmVlR2xvYmFsCiAgICApIHsKICAgICAgcm9vdCA9IGZyZWVHbG9iYWw7CiAgICB9CiAgCiAgICAvKioKICAgICAqIFRoZSBgcHVueWNvZGVgIG9iamVjdC4KICAgICAqIEBuYW1lIHB1bnljb2RlCiAgICAgKiBAdHlwZSBPYmplY3QKICAgICAqLwogICAgdmFyIHB1bnljb2RlLAogIAogICAgLyoqIEhpZ2hlc3QgcG9zaXRpdmUgc2lnbmVkIDMyLWJpdCBmbG9hdCB2YWx1ZSAqLwogICAgbWF4SW50ID0gMjE0NzQ4MzY0NywgLy8gYWthLiAweDdGRkZGRkZGIG9yIDJeMzEtMQogIAogICAgLyoqIEJvb3RzdHJpbmcgcGFyYW1ldGVycyAqLwogICAgYmFzZSA9IDM2LAogICAgdE1pbiA9IDEsCiAgICB0TWF4ID0gMjYsCiAgICBza2V3ID0gMzgsCiAgICBkYW1wID0gNzAwLAogICAgaW5pdGlhbEJpYXMgPSA3MiwKICAgIGluaXRpYWxOID0gMTI4LCAvLyAweDgwCiAgICBkZWxpbWl0ZXIgPSAnLScsIC8vICdceDJEJwogIAogICAgLyoqIFJlZ3VsYXIgZXhwcmVzc2lvbnMgKi8KICAgIHJlZ2V4UHVueWNvZGUgPSAvXnhuLS0vLAogICAgcmVnZXhOb25BU0NJSSA9IC9bXlx4MjAtXHg3RV0vLCAvLyB1bnByaW50YWJsZSBBU0NJSSBjaGFycyArIG5vbi1BU0NJSSBjaGFycwogICAgcmVnZXhTZXBhcmF0b3JzID0gL1tceDJFXHUzMDAyXHVGRjBFXHVGRjYxXS9nLCAvLyBSRkMgMzQ5MCBzZXBhcmF0b3JzCiAgCiAgICAvKiogRXJyb3IgbWVzc2FnZXMgKi8KICAgIGVycm9ycyA9IHsKICAgICAgJ292ZXJmbG93JzogJ092ZXJmbG93OiBpbnB1dCBuZWVkcyB3aWRlciBpbnRlZ2VycyB0byBwcm9jZXNzJywKICAgICAgJ25vdC1iYXNpYyc6ICdJbGxlZ2FsIGlucHV0ID49IDB4ODAgKG5vdCBhIGJhc2ljIGNvZGUgcG9pbnQpJywKICAgICAgJ2ludmFsaWQtaW5wdXQnOiAnSW52YWxpZCBpbnB1dCcKICAgIH0sCiAgCiAgICAvKiogQ29udmVuaWVuY2Ugc2hvcnRjdXRzICovCiAgICBiYXNlTWludXNUTWluID0gYmFzZSAtIHRNaW4sCiAgICBmbG9vciA9IE1hdGguZmxvb3IsCiAgICBzdHJpbmdGcm9tQ2hhckNvZGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLAogIAogICAgLyoqIFRlbXBvcmFyeSB2YXJpYWJsZSAqLwogICAga2V5OwogIAogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgCiAgICAvKioKICAgICAqIEEgZ2VuZXJpYyBlcnJvciB1dGlsaXR5IGZ1bmN0aW9uLgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBlcnJvciB0eXBlLgogICAgICogQHJldHVybnMge0Vycm9yfSBUaHJvd3MgYSBgUmFuZ2VFcnJvcmAgd2l0aCB0aGUgYXBwbGljYWJsZSBlcnJvciBtZXNzYWdlLgogICAgICovCiAgICBmdW5jdGlvbiBlcnJvcih0eXBlKSB7CiAgICAgIHRocm93IFJhbmdlRXJyb3IoZXJyb3JzW3R5cGVdKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQSBnZW5lcmljIGBBcnJheSNtYXBgIHV0aWxpdHkgZnVuY3Rpb24uCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0aGF0IGdldHMgY2FsbGVkIGZvciBldmVyeSBhcnJheQogICAgICogaXRlbS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gQSBuZXcgYXJyYXkgb2YgdmFsdWVzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gbWFwKGFycmF5LCBmbikgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIHJlc3VsdFtsZW5ndGhdID0gZm4oYXJyYXlbbGVuZ3RoXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIC8qKgogICAgICogQSBzaW1wbGUgYEFycmF5I21hcGAtbGlrZSB3cmFwcGVyIHRvIHdvcmsgd2l0aCBkb21haW4gbmFtZSBzdHJpbmdzIG9yIGVtYWlsCiAgICAgKiBhZGRyZXNzZXMuCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGRvbWFpbiBUaGUgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0aGF0IGdldHMgY2FsbGVkIGZvciBldmVyeQogICAgICogY2hhcmFjdGVyLgogICAgICogQHJldHVybnMge0FycmF5fSBBIG5ldyBzdHJpbmcgb2YgY2hhcmFjdGVycyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2sKICAgICAqIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBtYXBEb21haW4oc3RyaW5nLCBmbikgewogICAgICB2YXIgcGFydHMgPSBzdHJpbmcuc3BsaXQoJ0AnKTsKICAgICAgdmFyIHJlc3VsdCA9ICcnOwogICAgICBpZiAocGFydHMubGVuZ3RoID4gMSkgewogICAgICAgIC8vIEluIGVtYWlsIGFkZHJlc3Nlcywgb25seSB0aGUgZG9tYWluIG5hbWUgc2hvdWxkIGJlIHB1bnljb2RlZC4gTGVhdmUKICAgICAgICAvLyB0aGUgbG9jYWwgcGFydCAoaS5lLiBldmVyeXRoaW5nIHVwIHRvIGBAYCkgaW50YWN0LgogICAgICAgIHJlc3VsdCA9IHBhcnRzWzBdICsgJ0AnOwogICAgICAgIHN0cmluZyA9IHBhcnRzWzFdOwogICAgICB9CiAgICAgIC8vIEF2b2lkIGBzcGxpdChyZWdleClgIGZvciBJRTggY29tcGF0aWJpbGl0eS4gU2VlICMxNy4KICAgICAgc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVnZXhTZXBhcmF0b3JzLCAnXHgyRScpOwogICAgICB2YXIgbGFiZWxzID0gc3RyaW5nLnNwbGl0KCcuJyk7CiAgICAgIHZhciBlbmNvZGVkID0gbWFwKGxhYmVscywgZm4pLmpvaW4oJy4nKTsKICAgICAgcmV0dXJuIHJlc3VsdCArIGVuY29kZWQ7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgY29udGFpbmluZyB0aGUgbnVtZXJpYyBjb2RlIHBvaW50cyBvZiBlYWNoIFVuaWNvZGUKICAgICAqIGNoYXJhY3RlciBpbiB0aGUgc3RyaW5nLiBXaGlsZSBKYXZhU2NyaXB0IHVzZXMgVUNTLTIgaW50ZXJuYWxseSwKICAgICAqIHRoaXMgZnVuY3Rpb24gd2lsbCBjb252ZXJ0IGEgcGFpciBvZiBzdXJyb2dhdGUgaGFsdmVzIChlYWNoIG9mIHdoaWNoCiAgICAgKiBVQ1MtMiBleHBvc2VzIGFzIHNlcGFyYXRlIGNoYXJhY3RlcnMpIGludG8gYSBzaW5nbGUgY29kZSBwb2ludCwKICAgICAqIG1hdGNoaW5nIFVURi0xNi4KICAgICAqIEBzZWUgYHB1bnljb2RlLnVjczIuZW5jb2RlYAogICAgICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUudWNzMgogICAgICogQG5hbWUgZGVjb2RlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyaW5nIFRoZSBVbmljb2RlIGlucHV0IHN0cmluZyAoVUNTLTIpLgogICAgICogQHJldHVybnMge0FycmF5fSBUaGUgbmV3IGFycmF5IG9mIGNvZGUgcG9pbnRzLgogICAgICovCiAgICBmdW5jdGlvbiB1Y3MyZGVjb2RlKHN0cmluZykgewogICAgICB2YXIgb3V0cHV0ID0gW10sCiAgICAgICAgICBjb3VudGVyID0gMCwKICAgICAgICAgIGxlbmd0aCA9IHN0cmluZy5sZW5ndGgsCiAgICAgICAgICB2YWx1ZSwKICAgICAgICAgIGV4dHJhOwogICAgICB3aGlsZSAoY291bnRlciA8IGxlbmd0aCkgewogICAgICAgIHZhbHVlID0gc3RyaW5nLmNoYXJDb2RlQXQoY291bnRlcisrKTsKICAgICAgICBpZiAodmFsdWUgPj0gMHhEODAwICYmIHZhbHVlIDw9IDB4REJGRiAmJiBjb3VudGVyIDwgbGVuZ3RoKSB7CiAgICAgICAgICAvLyBoaWdoIHN1cnJvZ2F0ZSwgYW5kIHRoZXJlIGlzIGEgbmV4dCBjaGFyYWN0ZXIKICAgICAgICAgIGV4dHJhID0gc3RyaW5nLmNoYXJDb2RlQXQoY291bnRlcisrKTsKICAgICAgICAgIGlmICgoZXh0cmEgJiAweEZDMDApID09IDB4REMwMCkgeyAvLyBsb3cgc3Vycm9nYXRlCiAgICAgICAgICAgIG91dHB1dC5wdXNoKCgodmFsdWUgJiAweDNGRikgPDwgMTApICsgKGV4dHJhICYgMHgzRkYpICsgMHgxMDAwMCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB1bm1hdGNoZWQgc3Vycm9nYXRlOyBvbmx5IGFwcGVuZCB0aGlzIGNvZGUgdW5pdCwgaW4gY2FzZSB0aGUgbmV4dAogICAgICAgICAgICAvLyBjb2RlIHVuaXQgaXMgdGhlIGhpZ2ggc3Vycm9nYXRlIG9mIGEgc3Vycm9nYXRlIHBhaXIKICAgICAgICAgICAgb3V0cHV0LnB1c2godmFsdWUpOwogICAgICAgICAgICBjb3VudGVyLS07CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KICAKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHN0cmluZyBiYXNlZCBvbiBhbiBhcnJheSBvZiBudW1lcmljIGNvZGUgcG9pbnRzLgogICAgICogQHNlZSBgcHVueWNvZGUudWNzMi5kZWNvZGVgCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUudWNzMgogICAgICogQG5hbWUgZW5jb2RlCiAgICAgKiBAcGFyYW0ge0FycmF5fSBjb2RlUG9pbnRzIFRoZSBhcnJheSBvZiBudW1lcmljIGNvZGUgcG9pbnRzLgogICAgICogQHJldHVybnMge1N0cmluZ30gVGhlIG5ldyBVbmljb2RlIHN0cmluZyAoVUNTLTIpLgogICAgICovCiAgICBmdW5jdGlvbiB1Y3MyZW5jb2RlKGFycmF5KSB7CiAgICAgIHJldHVybiBtYXAoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG91dHB1dCA9ICcnOwogICAgICAgIGlmICh2YWx1ZSA+IDB4RkZGRikgewogICAgICAgICAgdmFsdWUgLT0gMHgxMDAwMDsKICAgICAgICAgIG91dHB1dCArPSBzdHJpbmdGcm9tQ2hhckNvZGUodmFsdWUgPj4+IDEwICYgMHgzRkYgfCAweEQ4MDApOwogICAgICAgICAgdmFsdWUgPSAweERDMDAgfCB2YWx1ZSAmIDB4M0ZGOwogICAgICAgIH0KICAgICAgICBvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlKTsKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICB9KS5qb2luKCcnKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBiYXNpYyBjb2RlIHBvaW50IGludG8gYSBkaWdpdC9pbnRlZ2VyLgogICAgICogQHNlZSBgZGlnaXRUb0Jhc2ljKClgCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGNvZGVQb2ludCBUaGUgYmFzaWMgbnVtZXJpYyBjb2RlIHBvaW50IHZhbHVlLgogICAgICogQHJldHVybnMge051bWJlcn0gVGhlIG51bWVyaWMgdmFsdWUgb2YgYSBiYXNpYyBjb2RlIHBvaW50IChmb3IgdXNlIGluCiAgICAgKiByZXByZXNlbnRpbmcgaW50ZWdlcnMpIGluIHRoZSByYW5nZSBgMGAgdG8gYGJhc2UgLSAxYCwgb3IgYGJhc2VgIGlmCiAgICAgKiB0aGUgY29kZSBwb2ludCBkb2VzIG5vdCByZXByZXNlbnQgYSB2YWx1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzaWNUb0RpZ2l0KGNvZGVQb2ludCkgewogICAgICBpZiAoY29kZVBvaW50IC0gNDggPCAxMCkgewogICAgICAgIHJldHVybiBjb2RlUG9pbnQgLSAyMjsKICAgICAgfQogICAgICBpZiAoY29kZVBvaW50IC0gNjUgPCAyNikgewogICAgICAgIHJldHVybiBjb2RlUG9pbnQgLSA2NTsKICAgICAgfQogICAgICBpZiAoY29kZVBvaW50IC0gOTcgPCAyNikgewogICAgICAgIHJldHVybiBjb2RlUG9pbnQgLSA5NzsKICAgICAgfQogICAgICByZXR1cm4gYmFzZTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBkaWdpdC9pbnRlZ2VyIGludG8gYSBiYXNpYyBjb2RlIHBvaW50LgogICAgICogQHNlZSBgYmFzaWNUb0RpZ2l0KClgCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGRpZ2l0IFRoZSBudW1lcmljIHZhbHVlIG9mIGEgYmFzaWMgY29kZSBwb2ludC4KICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBiYXNpYyBjb2RlIHBvaW50IHdob3NlIHZhbHVlICh3aGVuIHVzZWQgZm9yCiAgICAgKiByZXByZXNlbnRpbmcgaW50ZWdlcnMpIGlzIGBkaWdpdGAsIHdoaWNoIG5lZWRzIHRvIGJlIGluIHRoZSByYW5nZQogICAgICogYDBgIHRvIGBiYXNlIC0gMWAuIElmIGBmbGFnYCBpcyBub24temVybywgdGhlIHVwcGVyY2FzZSBmb3JtIGlzCiAgICAgKiB1c2VkOyBlbHNlLCB0aGUgbG93ZXJjYXNlIGZvcm0gaXMgdXNlZC4gVGhlIGJlaGF2aW9yIGlzIHVuZGVmaW5lZAogICAgICogaWYgYGZsYWdgIGlzIG5vbi16ZXJvIGFuZCBgZGlnaXRgIGhhcyBubyB1cHBlcmNhc2UgZm9ybS4KICAgICAqLwogICAgZnVuY3Rpb24gZGlnaXRUb0Jhc2ljKGRpZ2l0LCBmbGFnKSB7CiAgICAgIC8vICAwLi4yNSBtYXAgdG8gQVNDSUkgYS4ueiBvciBBLi5aCiAgICAgIC8vIDI2Li4zNSBtYXAgdG8gQVNDSUkgMC4uOQogICAgICByZXR1cm4gZGlnaXQgKyAyMiArIDc1ICogKGRpZ2l0IDwgMjYpIC0gKChmbGFnICE9IDApIDw8IDUpOwogICAgfQogIAogICAgLyoqCiAgICAgKiBCaWFzIGFkYXB0YXRpb24gZnVuY3Rpb24gYXMgcGVyIHNlY3Rpb24gMy40IG9mIFJGQyAzNDkyLgogICAgICogaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzQ5MiNzZWN0aW9uLTMuNAogICAgICogQHByaXZhdGUKICAgICAqLwogICAgZnVuY3Rpb24gYWRhcHQoZGVsdGEsIG51bVBvaW50cywgZmlyc3RUaW1lKSB7CiAgICAgIHZhciBrID0gMDsKICAgICAgZGVsdGEgPSBmaXJzdFRpbWUgPyBmbG9vcihkZWx0YSAvIGRhbXApIDogZGVsdGEgPj4gMTsKICAgICAgZGVsdGEgKz0gZmxvb3IoZGVsdGEgLyBudW1Qb2ludHMpOwogICAgICBmb3IgKC8qIG5vIGluaXRpYWxpemF0aW9uICovOyBkZWx0YSA+IGJhc2VNaW51c1RNaW4gKiB0TWF4ID4+IDE7IGsgKz0gYmFzZSkgewogICAgICAgIGRlbHRhID0gZmxvb3IoZGVsdGEgLyBiYXNlTWludXNUTWluKTsKICAgICAgfQogICAgICByZXR1cm4gZmxvb3IoayArIChiYXNlTWludXNUTWluICsgMSkgKiBkZWx0YSAvIChkZWx0YSArIHNrZXcpKTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzIHRvIGEgc3RyaW5nIG9mIFVuaWNvZGUKICAgICAqIHN5bWJvbHMuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSByZXN1bHRpbmcgc3RyaW5nIG9mIFVuaWNvZGUgc3ltYm9scy4KICAgICAqLwogICAgZnVuY3Rpb24gZGVjb2RlKGlucHV0KSB7CiAgICAgIC8vIERvbid0IHVzZSBVQ1MtMgogICAgICB2YXIgb3V0cHV0ID0gW10sCiAgICAgICAgICBpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKICAgICAgICAgIG91dCwKICAgICAgICAgIGkgPSAwLAogICAgICAgICAgbiA9IGluaXRpYWxOLAogICAgICAgICAgYmlhcyA9IGluaXRpYWxCaWFzLAogICAgICAgICAgYmFzaWMsCiAgICAgICAgICBqLAogICAgICAgICAgaW5kZXgsCiAgICAgICAgICBvbGRpLAogICAgICAgICAgdywKICAgICAgICAgIGssCiAgICAgICAgICBkaWdpdCwKICAgICAgICAgIHQsCiAgICAgICAgICAvKiogQ2FjaGVkIGNhbGN1bGF0aW9uIHJlc3VsdHMgKi8KICAgICAgICAgIGJhc2VNaW51c1Q7CiAgCiAgICAgIC8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHM6IGxldCBgYmFzaWNgIGJlIHRoZSBudW1iZXIgb2YgaW5wdXQgY29kZQogICAgICAvLyBwb2ludHMgYmVmb3JlIHRoZSBsYXN0IGRlbGltaXRlciwgb3IgYDBgIGlmIHRoZXJlIGlzIG5vbmUsIHRoZW4gY29weQogICAgICAvLyB0aGUgZmlyc3QgYmFzaWMgY29kZSBwb2ludHMgdG8gdGhlIG91dHB1dC4KICAKICAgICAgYmFzaWMgPSBpbnB1dC5sYXN0SW5kZXhPZihkZWxpbWl0ZXIpOwogICAgICBpZiAoYmFzaWMgPCAwKSB7CiAgICAgICAgYmFzaWMgPSAwOwogICAgICB9CiAgCiAgICAgIGZvciAoaiA9IDA7IGogPCBiYXNpYzsgKytqKSB7CiAgICAgICAgLy8gaWYgaXQncyBub3QgYSBiYXNpYyBjb2RlIHBvaW50CiAgICAgICAgaWYgKGlucHV0LmNoYXJDb2RlQXQoaikgPj0gMHg4MCkgewogICAgICAgICAgZXJyb3IoJ25vdC1iYXNpYycpOwogICAgICAgIH0KICAgICAgICBvdXRwdXQucHVzaChpbnB1dC5jaGFyQ29kZUF0KGopKTsKICAgICAgfQogIAogICAgICAvLyBNYWluIGRlY29kaW5nIGxvb3A6IHN0YXJ0IGp1c3QgYWZ0ZXIgdGhlIGxhc3QgZGVsaW1pdGVyIGlmIGFueSBiYXNpYyBjb2RlCiAgICAgIC8vIHBvaW50cyB3ZXJlIGNvcGllZDsgc3RhcnQgYXQgdGhlIGJlZ2lubmluZyBvdGhlcndpc2UuCiAgCiAgICAgIGZvciAoaW5kZXggPSBiYXNpYyA+IDAgPyBiYXNpYyArIDEgOiAwOyBpbmRleCA8IGlucHV0TGVuZ3RoOyAvKiBubyBmaW5hbCBleHByZXNzaW9uICovKSB7CiAgCiAgICAgICAgLy8gYGluZGV4YCBpcyB0aGUgaW5kZXggb2YgdGhlIG5leHQgY2hhcmFjdGVyIHRvIGJlIGNvbnN1bWVkLgogICAgICAgIC8vIERlY29kZSBhIGdlbmVyYWxpemVkIHZhcmlhYmxlLWxlbmd0aCBpbnRlZ2VyIGludG8gYGRlbHRhYCwKICAgICAgICAvLyB3aGljaCBnZXRzIGFkZGVkIHRvIGBpYC4gVGhlIG92ZXJmbG93IGNoZWNraW5nIGlzIGVhc2llcgogICAgICAgIC8vIGlmIHdlIGluY3JlYXNlIGBpYCBhcyB3ZSBnbywgdGhlbiBzdWJ0cmFjdCBvZmYgaXRzIHN0YXJ0aW5nCiAgICAgICAgLy8gdmFsdWUgYXQgdGhlIGVuZCB0byBvYnRhaW4gYGRlbHRhYC4KICAgICAgICBmb3IgKG9sZGkgPSBpLCB3ID0gMSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CiAgCiAgICAgICAgICBpZiAoaW5kZXggPj0gaW5wdXRMZW5ndGgpIHsKICAgICAgICAgICAgZXJyb3IoJ2ludmFsaWQtaW5wdXQnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGRpZ2l0ID0gYmFzaWNUb0RpZ2l0KGlucHV0LmNoYXJDb2RlQXQoaW5kZXgrKykpOwogIAogICAgICAgICAgaWYgKGRpZ2l0ID49IGJhc2UgfHwgZGlnaXQgPiBmbG9vcigobWF4SW50IC0gaSkgLyB3KSkgewogICAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGkgKz0gZGlnaXQgKiB3OwogICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiAoayA+PSBiaWFzICsgdE1heCA/IHRNYXggOiBrIC0gYmlhcyk7CiAgCiAgICAgICAgICBpZiAoZGlnaXQgPCB0KSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogIAogICAgICAgICAgYmFzZU1pbnVzVCA9IGJhc2UgLSB0OwogICAgICAgICAgaWYgKHcgPiBmbG9vcihtYXhJbnQgLyBiYXNlTWludXNUKSkgewogICAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIHcgKj0gYmFzZU1pbnVzVDsKICAKICAgICAgICB9CiAgCiAgICAgICAgb3V0ID0gb3V0cHV0Lmxlbmd0aCArIDE7CiAgICAgICAgYmlhcyA9IGFkYXB0KGkgLSBvbGRpLCBvdXQsIG9sZGkgPT0gMCk7CiAgCiAgICAgICAgLy8gYGlgIHdhcyBzdXBwb3NlZCB0byB3cmFwIGFyb3VuZCBmcm9tIGBvdXRgIHRvIGAwYCwKICAgICAgICAvLyBpbmNyZW1lbnRpbmcgYG5gIGVhY2ggdGltZSwgc28gd2UnbGwgZml4IHRoYXQgbm93OgogICAgICAgIGlmIChmbG9vcihpIC8gb3V0KSA+IG1heEludCAtIG4pIHsKICAgICAgICAgIGVycm9yKCdvdmVyZmxvdycpOwogICAgICAgIH0KICAKICAgICAgICBuICs9IGZsb29yKGkgLyBvdXQpOwogICAgICAgIGkgJT0gb3V0OwogIAogICAgICAgIC8vIEluc2VydCBgbmAgYXQgcG9zaXRpb24gYGlgIG9mIHRoZSBvdXRwdXQKICAgICAgICBvdXRwdXQuc3BsaWNlKGkrKywgMCwgbik7CiAgCiAgICAgIH0KICAKICAgICAgcmV0dXJuIHVjczJlbmNvZGUob3V0cHV0KTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBzdHJpbmcgb2YgVW5pY29kZSBzeW1ib2xzIChlLmcuIGEgZG9tYWluIG5hbWUgbGFiZWwpIHRvIGEKICAgICAqIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgc3RyaW5nIG9mIFVuaWNvZGUgc3ltYm9scy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSByZXN1bHRpbmcgUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scy4KICAgICAqLwogICAgZnVuY3Rpb24gZW5jb2RlKGlucHV0KSB7CiAgICAgIHZhciBuLAogICAgICAgICAgZGVsdGEsCiAgICAgICAgICBoYW5kbGVkQ1BDb3VudCwKICAgICAgICAgIGJhc2ljTGVuZ3RoLAogICAgICAgICAgYmlhcywKICAgICAgICAgIGosCiAgICAgICAgICBtLAogICAgICAgICAgcSwKICAgICAgICAgIGssCiAgICAgICAgICB0LAogICAgICAgICAgY3VycmVudFZhbHVlLAogICAgICAgICAgb3V0cHV0ID0gW10sCiAgICAgICAgICAvKiogYGlucHV0TGVuZ3RoYCB3aWxsIGhvbGQgdGhlIG51bWJlciBvZiBjb2RlIHBvaW50cyBpbiBgaW5wdXRgLiAqLwogICAgICAgICAgaW5wdXRMZW5ndGgsCiAgICAgICAgICAvKiogQ2FjaGVkIGNhbGN1bGF0aW9uIHJlc3VsdHMgKi8KICAgICAgICAgIGhhbmRsZWRDUENvdW50UGx1c09uZSwKICAgICAgICAgIGJhc2VNaW51c1QsCiAgICAgICAgICBxTWludXNUOwogIAogICAgICAvLyBDb252ZXJ0IHRoZSBpbnB1dCBpbiBVQ1MtMiB0byBVbmljb2RlCiAgICAgIGlucHV0ID0gdWNzMmRlY29kZShpbnB1dCk7CiAgCiAgICAgIC8vIENhY2hlIHRoZSBsZW5ndGgKICAgICAgaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGg7CiAgCiAgICAgIC8vIEluaXRpYWxpemUgdGhlIHN0YXRlCiAgICAgIG4gPSBpbml0aWFsTjsKICAgICAgZGVsdGEgPSAwOwogICAgICBiaWFzID0gaW5pdGlhbEJpYXM7CiAgCiAgICAgIC8vIEhhbmRsZSB0aGUgYmFzaWMgY29kZSBwb2ludHMKICAgICAgZm9yIChqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAgICAgICBpZiAoY3VycmVudFZhbHVlIDwgMHg4MCkgewogICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGN1cnJlbnRWYWx1ZSkpOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBoYW5kbGVkQ1BDb3VudCA9IGJhc2ljTGVuZ3RoID0gb3V0cHV0Lmxlbmd0aDsKICAKICAgICAgLy8gYGhhbmRsZWRDUENvdW50YCBpcyB0aGUgbnVtYmVyIG9mIGNvZGUgcG9pbnRzIHRoYXQgaGF2ZSBiZWVuIGhhbmRsZWQ7CiAgICAgIC8vIGBiYXNpY0xlbmd0aGAgaXMgdGhlIG51bWJlciBvZiBiYXNpYyBjb2RlIHBvaW50cy4KICAKICAgICAgLy8gRmluaXNoIHRoZSBiYXNpYyBzdHJpbmcgLSBpZiBpdCBpcyBub3QgZW1wdHkgLSB3aXRoIGEgZGVsaW1pdGVyCiAgICAgIGlmIChiYXNpY0xlbmd0aCkgewogICAgICAgIG91dHB1dC5wdXNoKGRlbGltaXRlcik7CiAgICAgIH0KICAKICAgICAgLy8gTWFpbiBlbmNvZGluZyBsb29wOgogICAgICB3aGlsZSAoaGFuZGxlZENQQ291bnQgPCBpbnB1dExlbmd0aCkgewogIAogICAgICAgIC8vIEFsbCBub24tYmFzaWMgY29kZSBwb2ludHMgPCBuIGhhdmUgYmVlbiBoYW5kbGVkIGFscmVhZHkuIEZpbmQgdGhlIG5leHQKICAgICAgICAvLyBsYXJnZXIgb25lOgogICAgICAgIGZvciAobSA9IG1heEludCwgaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CiAgICAgICAgICBjdXJyZW50VmFsdWUgPSBpbnB1dFtqXTsKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPj0gbiAmJiBjdXJyZW50VmFsdWUgPCBtKSB7CiAgICAgICAgICAgIG0gPSBjdXJyZW50VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgIC8vIEluY3JlYXNlIGBkZWx0YWAgZW5vdWdoIHRvIGFkdmFuY2UgdGhlIGRlY29kZXIncyA8bixpPiBzdGF0ZSB0byA8bSwwPiwKICAgICAgICAvLyBidXQgZ3VhcmQgYWdhaW5zdCBvdmVyZmxvdwogICAgICAgIGhhbmRsZWRDUENvdW50UGx1c09uZSA9IGhhbmRsZWRDUENvdW50ICsgMTsKICAgICAgICBpZiAobSAtIG4gPiBmbG9vcigobWF4SW50IC0gZGVsdGEpIC8gaGFuZGxlZENQQ291bnRQbHVzT25lKSkgewogICAgICAgICAgZXJyb3IoJ292ZXJmbG93Jyk7CiAgICAgICAgfQogIAogICAgICAgIGRlbHRhICs9IChtIC0gbikgKiBoYW5kbGVkQ1BDb3VudFBsdXNPbmU7CiAgICAgICAgbiA9IG07CiAgCiAgICAgICAgZm9yIChqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwogIAogICAgICAgICAgaWYgKGN1cnJlbnRWYWx1ZSA8IG4gJiYgKytkZWx0YSA+IG1heEludCkgewogICAgICAgICAgICBlcnJvcignb3ZlcmZsb3cnKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChjdXJyZW50VmFsdWUgPT0gbikgewogICAgICAgICAgICAvLyBSZXByZXNlbnQgZGVsdGEgYXMgYSBnZW5lcmFsaXplZCB2YXJpYWJsZS1sZW5ndGggaW50ZWdlcgogICAgICAgICAgICBmb3IgKHEgPSBkZWx0YSwgayA9IGJhc2U7IC8qIG5vIGNvbmRpdGlvbiAqLzsgayArPSBiYXNlKSB7CiAgICAgICAgICAgICAgdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiAoayA+PSBiaWFzICsgdE1heCA/IHRNYXggOiBrIC0gYmlhcyk7CiAgICAgICAgICAgICAgaWYgKHEgPCB0KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcU1pbnVzVCA9IHEgLSB0OwogICAgICAgICAgICAgIGJhc2VNaW51c1QgPSBiYXNlIC0gdDsKICAgICAgICAgICAgICBvdXRwdXQucHVzaCgKICAgICAgICAgICAgICAgIHN0cmluZ0Zyb21DaGFyQ29kZShkaWdpdFRvQmFzaWModCArIHFNaW51c1QgJSBiYXNlTWludXNULCAwKSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHEgPSBmbG9vcihxTWludXNUIC8gYmFzZU1pbnVzVCk7CiAgICAgICAgICAgIH0KICAKICAgICAgICAgICAgb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyhxLCAwKSkpOwogICAgICAgICAgICBiaWFzID0gYWRhcHQoZGVsdGEsIGhhbmRsZWRDUENvdW50UGx1c09uZSwgaGFuZGxlZENQQ291bnQgPT0gYmFzaWNMZW5ndGgpOwogICAgICAgICAgICBkZWx0YSA9IDA7CiAgICAgICAgICAgICsraGFuZGxlZENQQ291bnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogIAogICAgICAgICsrZGVsdGE7CiAgICAgICAgKytuOwogIAogICAgICB9CiAgICAgIHJldHVybiBvdXRwdXQuam9pbignJyk7CiAgICB9CiAgCiAgICAvKioKICAgICAqIENvbnZlcnRzIGEgUHVueWNvZGUgc3RyaW5nIHJlcHJlc2VudGluZyBhIGRvbWFpbiBuYW1lIG9yIGFuIGVtYWlsIGFkZHJlc3MKICAgICAqIHRvIFVuaWNvZGUuIE9ubHkgdGhlIFB1bnljb2RlZCBwYXJ0cyBvZiB0aGUgaW5wdXQgd2lsbCBiZSBjb252ZXJ0ZWQsIGkuZS4KICAgICAqIGl0IGRvZXNuJ3QgbWF0dGVyIGlmIHlvdSBjYWxsIGl0IG9uIGEgc3RyaW5nIHRoYXQgaGFzIGFscmVhZHkgYmVlbgogICAgICogY29udmVydGVkIHRvIFVuaWNvZGUuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgUHVueWNvZGVkIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MgdG8KICAgICAqIGNvbnZlcnQgdG8gVW5pY29kZS4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBVbmljb2RlIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBQdW55Y29kZQogICAgICogc3RyaW5nLgogICAgICovCiAgICBmdW5jdGlvbiB0b1VuaWNvZGUoaW5wdXQpIHsKICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHJlZ2V4UHVueWNvZGUudGVzdChzdHJpbmcpCiAgICAgICAgICA/IGRlY29kZShzdHJpbmcuc2xpY2UoNCkudG9Mb3dlckNhc2UoKSkKICAgICAgICAgIDogc3RyaW5nOwogICAgICB9KTsKICAgIH0KICAKICAgIC8qKgogICAgICogQ29udmVydHMgYSBVbmljb2RlIHN0cmluZyByZXByZXNlbnRpbmcgYSBkb21haW4gbmFtZSBvciBhbiBlbWFpbCBhZGRyZXNzIHRvCiAgICAgKiBQdW55Y29kZS4gT25seSB0aGUgbm9uLUFTQ0lJIHBhcnRzIG9mIHRoZSBkb21haW4gbmFtZSB3aWxsIGJlIGNvbnZlcnRlZCwKICAgICAqIGkuZS4gaXQgZG9lc24ndCBtYXR0ZXIgaWYgeW91IGNhbGwgaXQgd2l0aCBhIGRvbWFpbiB0aGF0J3MgYWxyZWFkeSBpbgogICAgICogQVNDSUkuCiAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbnB1dCBUaGUgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcyB0byBjb252ZXJ0LCBhcyBhCiAgICAgKiBVbmljb2RlIHN0cmluZy4KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9IFRoZSBQdW55Y29kZSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gZG9tYWluIG5hbWUgb3IKICAgICAqIGVtYWlsIGFkZHJlc3MuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRvQVNDSUkoaW5wdXQpIHsKICAgICAgcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgcmV0dXJuIHJlZ2V4Tm9uQVNDSUkudGVzdChzdHJpbmcpCiAgICAgICAgICA/ICd4bi0tJyArIGVuY29kZShzdHJpbmcpCiAgICAgICAgICA6IHN0cmluZzsKICAgICAgfSk7CiAgICB9CiAgCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAKICAgIC8qKiBEZWZpbmUgdGhlIHB1YmxpYyBBUEkgKi8KICAgIHB1bnljb2RlID0gewogICAgICAvKioKICAgICAgICogQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IFB1bnljb2RlLmpzIHZlcnNpb24gbnVtYmVyLgogICAgICAgKiBAbWVtYmVyT2YgcHVueWNvZGUKICAgICAgICogQHR5cGUgU3RyaW5nCiAgICAgICAqLwogICAgICAndmVyc2lvbic6ICcxLjMuMicsCiAgICAgIC8qKgogICAgICAgKiBBbiBvYmplY3Qgb2YgbWV0aG9kcyB0byBjb252ZXJ0IGZyb20gSmF2YVNjcmlwdCdzIGludGVybmFsIGNoYXJhY3RlcgogICAgICAgKiByZXByZXNlbnRhdGlvbiAoVUNTLTIpIHRvIFVuaWNvZGUgY29kZSBwb2ludHMsIGFuZCBiYWNrLgogICAgICAgKiBAc2VlIDxodHRwczovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZz4KICAgICAgICogQG1lbWJlck9mIHB1bnljb2RlCiAgICAgICAqIEB0eXBlIE9iamVjdAogICAgICAgKi8KICAgICAgJ3VjczInOiB7CiAgICAgICAgJ2RlY29kZSc6IHVjczJkZWNvZGUsCiAgICAgICAgJ2VuY29kZSc6IHVjczJlbmNvZGUKICAgICAgfSwKICAgICAgJ2RlY29kZSc6IGRlY29kZSwKICAgICAgJ2VuY29kZSc6IGVuY29kZSwKICAgICAgJ3RvQVNDSUknOiB0b0FTQ0lJLAogICAgICAndG9Vbmljb2RlJzogdG9Vbmljb2RlCiAgICB9OwogIAogICAgLyoqIEV4cG9zZSBgcHVueWNvZGVgICovCiAgICAvLyBTb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBzcGVjaWZpYyBjb25kaXRpb24gcGF0dGVybnMKICAgIC8vIGxpa2UgdGhlIGZvbGxvd2luZzoKICAgIGlmICgKICAgICAgdHJ1ZQogICAgKSB7CiAgICAgICEoX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHB1bnljb2RlOwogICAgICB9KS5jYWxsKGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18sIGV4cG9ydHMsIG1vZHVsZSksCgkJX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX18gIT09IHVuZGVmaW5lZCAmJiAobW9kdWxlLmV4cG9ydHMgPSBfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXykpOwogICAgfSBlbHNlIHt9CiAgCiAgfSh0aGlzKSk7CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyx0eXBlb2YgX193ZWJwYWNrX3JlcXVpcmVfXy5nICE9PSAidW5kZWZpbmVkIiA/IF9fd2VicGFja19yZXF1aXJlX18uZyA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQogIH0se31dLDgxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24gKGdsb2JhbCxCdWZmZXIpeyhmdW5jdGlvbiAoKXsKICAvKiEKICAgKiBUaGUgYnVmZmVyIG1vZHVsZSBmcm9tIG5vZGUuanMsIGZvciB0aGUgYnJvd3Nlci4KICAgKgogICAqIEBhdXRob3IgICBGZXJvc3MgQWJvdWtoYWRpamVoIDxmZXJvc3NAZmVyb3NzLm9yZz4gPGh0dHA6Ly9mZXJvc3Mub3JnPgogICAqIEBsaWNlbnNlICBNSVQKICAgKi8KICAvKiBlc2xpbnQtZGlzYWJsZSBuby1wcm90byAqLwogIAogICd1c2Ugc3RyaWN0JwogIAogIHZhciBiYXNlNjQgPSByZXF1aXJlKCdiYXNlNjQtanMnKQogIHZhciBpZWVlNzU0ID0gcmVxdWlyZSgnaWVlZTc1NCcpCiAgdmFyIGlzQXJyYXkgPSByZXF1aXJlKCdpc2FycmF5JykKICAKICBleHBvcnRzLkJ1ZmZlciA9IEJ1ZmZlcgogIGV4cG9ydHMuU2xvd0J1ZmZlciA9IFNsb3dCdWZmZXIKICBleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTID0gNTAKICAKICAvKioKICAgKiBJZiBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgOgogICAqICAgPT09IHRydWUgICAgVXNlIFVpbnQ4QXJyYXkgaW1wbGVtZW50YXRpb24gKGZhc3Rlc3QpCiAgICogICA9PT0gZmFsc2UgICBVc2UgT2JqZWN0IGltcGxlbWVudGF0aW9uIChtb3N0IGNvbXBhdGlibGUsIGV2ZW4gSUU2KQogICAqCiAgICogQnJvd3NlcnMgdGhhdCBzdXBwb3J0IHR5cGVkIGFycmF5cyBhcmUgSUUgMTArLCBGaXJlZm94IDQrLCBDaHJvbWUgNyssIFNhZmFyaSA1LjErLAogICAqIE9wZXJhIDExLjYrLCBpT1MgNC4yKy4KICAgKgogICAqIER1ZSB0byB2YXJpb3VzIGJyb3dzZXIgYnVncywgc29tZXRpbWVzIHRoZSBPYmplY3QgaW1wbGVtZW50YXRpb24gd2lsbCBiZSB1c2VkIGV2ZW4KICAgKiB3aGVuIHRoZSBicm93c2VyIHN1cHBvcnRzIHR5cGVkIGFycmF5cy4KICAgKgogICAqIE5vdGU6CiAgICoKICAgKiAgIC0gRmlyZWZveCA0LTI5IGxhY2tzIHN1cHBvcnQgZm9yIGFkZGluZyBuZXcgcHJvcGVydGllcyB0byBgVWludDhBcnJheWAgaW5zdGFuY2VzLAogICAqICAgICBTZWU6IGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY5NTQzOC4KICAgKgogICAqICAgLSBDaHJvbWUgOS0xMCBpcyBtaXNzaW5nIHRoZSBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uLgogICAqCiAgICogICAtIElFMTAgaGFzIGEgYnJva2VuIGBUeXBlZEFycmF5LnByb3RvdHlwZS5zdWJhcnJheWAgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhcnJheXMgb2YKICAgKiAgICAgaW5jb3JyZWN0IGxlbmd0aCBpbiBzb21lIHNpdHVhdGlvbnMuCiAgCiAgICogV2UgZGV0ZWN0IHRoZXNlIGJ1Z2d5IGJyb3dzZXJzIGFuZCBzZXQgYEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUYCB0byBgZmFsc2VgIHNvIHRoZXkKICAgKiBnZXQgdGhlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiwgd2hpY2ggaXMgc2xvd2VyIGJ1dCBiZWhhdmVzIGNvcnJlY3RseS4KICAgKi8KICBCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCA9IGdsb2JhbC5UWVBFRF9BUlJBWV9TVVBQT1JUICE9PSB1bmRlZmluZWQKICAgID8gZ2xvYmFsLlRZUEVEX0FSUkFZX1NVUFBPUlQKICAgIDogdHlwZWRBcnJheVN1cHBvcnQoKQogIAogIC8qCiAgICogRXhwb3J0IGtNYXhMZW5ndGggYWZ0ZXIgdHlwZWQgYXJyYXkgc3VwcG9ydCBpcyBkZXRlcm1pbmVkLgogICAqLwogIGV4cG9ydHMua01heExlbmd0aCA9IGtNYXhMZW5ndGgoKQogIAogIGZ1bmN0aW9uIHR5cGVkQXJyYXlTdXBwb3J0ICgpIHsKICAgIHRyeSB7CiAgICAgIHZhciBhcnIgPSBuZXcgVWludDhBcnJheSgxKQogICAgICBhcnIuX19wcm90b19fID0ge19fcHJvdG9fXzogVWludDhBcnJheS5wcm90b3R5cGUsIGZvbzogZnVuY3Rpb24gKCkgeyByZXR1cm4gNDIgfX0KICAgICAgcmV0dXJuIGFyci5mb28oKSA9PT0gNDIgJiYgLy8gdHlwZWQgYXJyYXkgaW5zdGFuY2VzIGNhbiBiZSBhdWdtZW50ZWQKICAgICAgICAgIHR5cGVvZiBhcnIuc3ViYXJyYXkgPT09ICdmdW5jdGlvbicgJiYgLy8gY2hyb21lIDktMTAgbGFjayBgc3ViYXJyYXlgCiAgICAgICAgICBhcnIuc3ViYXJyYXkoMSwgMSkuYnl0ZUxlbmd0aCA9PT0gMCAvLyBpZTEwIGhhcyBicm9rZW4gYHN1YmFycmF5YAogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4gZmFsc2UKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24ga01heExlbmd0aCAoKSB7CiAgICByZXR1cm4gQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQKICAgICAgPyAweDdmZmZmZmZmCiAgICAgIDogMHgzZmZmZmZmZgogIH0KICAKICBmdW5jdGlvbiBjcmVhdGVCdWZmZXIgKHRoYXQsIGxlbmd0aCkgewogICAgaWYgKGtNYXhMZW5ndGgoKSA8IGxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW52YWxpZCB0eXBlZCBhcnJheSBsZW5ndGgnKQogICAgfQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlLCBmb3IgYmVzdCBwZXJmb3JtYW5jZQogICAgICB0aGF0ID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKQogICAgICB0aGF0Ll9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIH0gZWxzZSB7CiAgICAgIC8vIEZhbGxiYWNrOiBSZXR1cm4gYW4gb2JqZWN0IGluc3RhbmNlIG9mIHRoZSBCdWZmZXIgY2xhc3MKICAgICAgaWYgKHRoYXQgPT09IG51bGwpIHsKICAgICAgICB0aGF0ID0gbmV3IEJ1ZmZlcihsZW5ndGgpCiAgICAgIH0KICAgICAgdGhhdC5sZW5ndGggPSBsZW5ndGgKICAgIH0KICAKICAgIHJldHVybiB0aGF0CiAgfQogIAogIC8qKgogICAqIFRoZSBCdWZmZXIgY29uc3RydWN0b3IgcmV0dXJucyBpbnN0YW5jZXMgb2YgYFVpbnQ4QXJyYXlgIHRoYXQgaGF2ZSB0aGVpcgogICAqIHByb3RvdHlwZSBjaGFuZ2VkIHRvIGBCdWZmZXIucHJvdG90eXBlYC4gRnVydGhlcm1vcmUsIGBCdWZmZXJgIGlzIGEgc3ViY2xhc3Mgb2YKICAgKiBgVWludDhBcnJheWAsIHNvIHRoZSByZXR1cm5lZCBpbnN0YW5jZXMgd2lsbCBoYXZlIGFsbCB0aGUgbm9kZSBgQnVmZmVyYCBtZXRob2RzCiAgICogYW5kIHRoZSBgVWludDhBcnJheWAgbWV0aG9kcy4gU3F1YXJlIGJyYWNrZXQgbm90YXRpb24gd29ya3MgYXMgZXhwZWN0ZWQgLS0gaXQKICAgKiByZXR1cm5zIGEgc2luZ2xlIG9jdGV0LgogICAqCiAgICogVGhlIGBVaW50OEFycmF5YCBwcm90b3R5cGUgcmVtYWlucyB1bm1vZGlmaWVkLgogICAqLwogIAogIGZ1bmN0aW9uIEJ1ZmZlciAoYXJnLCBlbmNvZGluZ09yT2Zmc2V0LCBsZW5ndGgpIHsKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgJiYgISh0aGlzIGluc3RhbmNlb2YgQnVmZmVyKSkgewogICAgICByZXR1cm4gbmV3IEJ1ZmZlcihhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICAgIH0KICAKICAgIC8vIENvbW1vbiBjYXNlLgogICAgaWYgKHR5cGVvZiBhcmcgPT09ICdudW1iZXInKSB7CiAgICAgIGlmICh0eXBlb2YgZW5jb2RpbmdPck9mZnNldCA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAnSWYgZW5jb2RpbmcgaXMgc3BlY2lmaWVkIHRoZW4gdGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnCiAgICAgICAgKQogICAgICB9CiAgICAgIHJldHVybiBhbGxvY1Vuc2FmZSh0aGlzLCBhcmcpCiAgICB9CiAgICByZXR1cm4gZnJvbSh0aGlzLCBhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgQnVmZmVyLnBvb2xTaXplID0gODE5MiAvLyBub3QgdXNlZCBieSB0aGlzIGltcGxlbWVudGF0aW9uCiAgCiAgLy8gVE9ETzogTGVnYWN5LCBub3QgbmVlZGVkIGFueW1vcmUuIFJlbW92ZSBpbiBuZXh0IG1ham9yIHZlcnNpb24uCiAgQnVmZmVyLl9hdWdtZW50ID0gZnVuY3Rpb24gKGFycikgewogICAgYXJyLl9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICAgIHJldHVybiBhcnIKICB9CiAgCiAgZnVuY3Rpb24gZnJvbSAodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignInZhbHVlIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBhIG51bWJlcicpCiAgICB9CiAgCiAgICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB7CiAgICAgIHJldHVybiBmcm9tQXJyYXlCdWZmZXIodGhhdCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICAgIH0KICAKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBmcm9tU3RyaW5nKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0KQogICAgfQogIAogICAgcmV0dXJuIGZyb21PYmplY3QodGhhdCwgdmFsdWUpCiAgfQogIAogIC8qKgogICAqIEZ1bmN0aW9uYWxseSBlcXVpdmFsZW50IHRvIEJ1ZmZlcihhcmcsIGVuY29kaW5nKSBidXQgdGhyb3dzIGEgVHlwZUVycm9yCiAgICogaWYgdmFsdWUgaXMgYSBudW1iZXIuCiAgICogQnVmZmVyLmZyb20oc3RyWywgZW5jb2RpbmddKQogICAqIEJ1ZmZlci5mcm9tKGFycmF5KQogICAqIEJ1ZmZlci5mcm9tKGJ1ZmZlcikKICAgKiBCdWZmZXIuZnJvbShhcnJheUJ1ZmZlclssIGJ5dGVPZmZzZXRbLCBsZW5ndGhdXSkKICAgKiovCiAgQnVmZmVyLmZyb20gPSBmdW5jdGlvbiAodmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGZyb20obnVsbCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICBCdWZmZXIucHJvdG90eXBlLl9fcHJvdG9fXyA9IFVpbnQ4QXJyYXkucHJvdG90eXBlCiAgICBCdWZmZXIuX19wcm90b19fID0gVWludDhBcnJheQogICAgaWYgKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC5zcGVjaWVzICYmCiAgICAgICAgQnVmZmVyW1N5bWJvbC5zcGVjaWVzXSA9PT0gQnVmZmVyKSB7CiAgICAgIC8vIEZpeCBzdWJhcnJheSgpIGluIEVTMjAxNi4gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL2J1ZmZlci9wdWxsLzk3CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShCdWZmZXIsIFN5bWJvbC5zcGVjaWVzLCB7CiAgICAgICAgdmFsdWU6IG51bGwsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0pCiAgICB9CiAgfQogIAogIGZ1bmN0aW9uIGFzc2VydFNpemUgKHNpemUpIHsKICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3QgYmUgYSBudW1iZXInKQogICAgfSBlbHNlIGlmIChzaXplIDwgMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIG5lZ2F0aXZlJykKICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gYWxsb2MgKHRoYXQsIHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICBhc3NlcnRTaXplKHNpemUpCiAgICBpZiAoc2l6ZSA8PSAwKSB7CiAgICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkKICAgIH0KICAgIGlmIChmaWxsICE9PSB1bmRlZmluZWQpIHsKICAgICAgLy8gT25seSBwYXkgYXR0ZW50aW9uIHRvIGVuY29kaW5nIGlmIGl0J3MgYSBzdHJpbmcuIFRoaXMKICAgICAgLy8gcHJldmVudHMgYWNjaWRlbnRhbGx5IHNlbmRpbmcgaW4gYSBudW1iZXIgdGhhdCB3b3VsZAogICAgICAvLyBiZSBpbnRlcnByZXR0ZWQgYXMgYSBzdGFydCBvZmZzZXQuCiAgICAgIHJldHVybiB0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnCiAgICAgICAgPyBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkuZmlsbChmaWxsLCBlbmNvZGluZykKICAgICAgICA6IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKS5maWxsKGZpbGwpCiAgICB9CiAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpCiAgfQogIAogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICAgKiBhbGxvYyhzaXplWywgZmlsbFssIGVuY29kaW5nXV0pCiAgICoqLwogIEJ1ZmZlci5hbGxvYyA9IGZ1bmN0aW9uIChzaXplLCBmaWxsLCBlbmNvZGluZykgewogICAgcmV0dXJuIGFsbG9jKG51bGwsIHNpemUsIGZpbGwsIGVuY29kaW5nKQogIH0KICAKICBmdW5jdGlvbiBhbGxvY1Vuc2FmZSAodGhhdCwgc2l6ZSkgewogICAgYXNzZXJ0U2l6ZShzaXplKQogICAgdGhhdCA9IGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplIDwgMCA/IDAgOiBjaGVja2VkKHNpemUpIHwgMCkKICAgIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaXplOyArK2kpIHsKICAgICAgICB0aGF0W2ldID0gMAogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhhdAogIH0KICAKICAvKioKICAgKiBFcXVpdmFsZW50IHRvIEJ1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgogICAqICovCiAgQnVmZmVyLmFsbG9jVW5zYWZlID0gZnVuY3Rpb24gKHNpemUpIHsKICAgIHJldHVybiBhbGxvY1Vuc2FmZShudWxsLCBzaXplKQogIH0KICAvKioKICAgKiBFcXVpdmFsZW50IHRvIFNsb3dCdWZmZXIobnVtKSwgYnkgZGVmYXVsdCBjcmVhdGVzIGEgbm9uLXplcm8tZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICAgKi8KICBCdWZmZXIuYWxsb2NVbnNhZmVTbG93ID0gZnVuY3Rpb24gKHNpemUpIHsKICAgIHJldHVybiBhbGxvY1Vuc2FmZShudWxsLCBzaXplKQogIH0KICAKICBmdW5jdGlvbiBmcm9tU3RyaW5nICh0aGF0LCBzdHJpbmcsIGVuY29kaW5nKSB7CiAgICBpZiAodHlwZW9mIGVuY29kaW5nICE9PSAnc3RyaW5nJyB8fCBlbmNvZGluZyA9PT0gJycpIHsKICAgICAgZW5jb2RpbmcgPSAndXRmOCcKICAgIH0KICAKICAgIGlmICghQnVmZmVyLmlzRW5jb2RpbmcoZW5jb2RpbmcpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJlbmNvZGluZyIgbXVzdCBiZSBhIHZhbGlkIHN0cmluZyBlbmNvZGluZycpCiAgICB9CiAgCiAgICB2YXIgbGVuZ3RoID0gYnl0ZUxlbmd0aChzdHJpbmcsIGVuY29kaW5nKSB8IDAKICAgIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuZ3RoKQogIAogICAgdmFyIGFjdHVhbCA9IHRoYXQud3JpdGUoc3RyaW5nLCBlbmNvZGluZykKICAKICAgIGlmIChhY3R1YWwgIT09IGxlbmd0aCkgewogICAgICAvLyBXcml0aW5nIGEgaGV4IHN0cmluZywgZm9yIGV4YW1wbGUsIHRoYXQgY29udGFpbnMgaW52YWxpZCBjaGFyYWN0ZXJzIHdpbGwKICAgICAgLy8gY2F1c2UgZXZlcnl0aGluZyBhZnRlciB0aGUgZmlyc3QgaW52YWxpZCBjaGFyYWN0ZXIgdG8gYmUgaWdub3JlZC4gKGUuZy4KICAgICAgLy8gJ2FieHhjZCcgd2lsbCBiZSB0cmVhdGVkIGFzICdhYicpCiAgICAgIHRoYXQgPSB0aGF0LnNsaWNlKDAsIGFjdHVhbCkKICAgIH0KICAKICAgIHJldHVybiB0aGF0CiAgfQogIAogIGZ1bmN0aW9uIGZyb21BcnJheUxpa2UgKHRoYXQsIGFycmF5KSB7CiAgICB2YXIgbGVuZ3RoID0gYXJyYXkubGVuZ3RoIDwgMCA/IDAgOiBjaGVja2VkKGFycmF5Lmxlbmd0aCkgfCAwCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbmd0aCkKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgdGhhdFtpXSA9IGFycmF5W2ldICYgMjU1CiAgICB9CiAgICByZXR1cm4gdGhhdAogIH0KICAKICBmdW5jdGlvbiBmcm9tQXJyYXlCdWZmZXIgKHRoYXQsIGFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpIHsKICAgIGFycmF5LmJ5dGVMZW5ndGggLy8gdGhpcyB0aHJvd3MgaWYgYGFycmF5YCBpcyBub3QgYSB2YWxpZCBBcnJheUJ1ZmZlcgogIAogICAgaWYgKGJ5dGVPZmZzZXQgPCAwIHx8IGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0KSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdcJ29mZnNldFwnIGlzIG91dCBvZiBib3VuZHMnKQogICAgfQogIAogICAgaWYgKGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0ICsgKGxlbmd0aCB8fCAwKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignXCdsZW5ndGhcJyBpcyBvdXQgb2YgYm91bmRzJykKICAgIH0KICAKICAgIGlmIChieXRlT2Zmc2V0ID09PSB1bmRlZmluZWQgJiYgbGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSkKICAgIH0gZWxzZSBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQpIHsKICAgICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSwgYnl0ZU9mZnNldCkKICAgIH0gZWxzZSB7CiAgICAgIGFycmF5ID0gbmV3IFVpbnQ4QXJyYXkoYXJyYXksIGJ5dGVPZmZzZXQsIGxlbmd0aCkKICAgIH0KICAKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZSwgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgICAgdGhhdCA9IGFycmF5CiAgICAgIHRoYXQuX19wcm90b19fID0gQnVmZmVyLnByb3RvdHlwZQogICAgfSBlbHNlIHsKICAgICAgLy8gRmFsbGJhY2s6IFJldHVybiBhbiBvYmplY3QgaW5zdGFuY2Ugb2YgdGhlIEJ1ZmZlciBjbGFzcwogICAgICB0aGF0ID0gZnJvbUFycmF5TGlrZSh0aGF0LCBhcnJheSkKICAgIH0KICAgIHJldHVybiB0aGF0CiAgfQogIAogIGZ1bmN0aW9uIGZyb21PYmplY3QgKHRoYXQsIG9iaikgewogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihvYmopKSB7CiAgICAgIHZhciBsZW4gPSBjaGVja2VkKG9iai5sZW5ndGgpIHwgMAogICAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbikKICAKICAgICAgaWYgKHRoYXQubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRoYXQKICAgICAgfQogIAogICAgICBvYmouY29weSh0aGF0LCAwLCAwLCBsZW4pCiAgICAgIHJldHVybiB0aGF0CiAgICB9CiAgCiAgICBpZiAob2JqKSB7CiAgICAgIGlmICgodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJgogICAgICAgICAgb2JqLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB8fCAnbGVuZ3RoJyBpbiBvYmopIHsKICAgICAgICBpZiAodHlwZW9mIG9iai5sZW5ndGggIT09ICdudW1iZXInIHx8IGlzbmFuKG9iai5sZW5ndGgpKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQnVmZmVyKHRoYXQsIDApCiAgICAgICAgfQogICAgICAgIHJldHVybiBmcm9tQXJyYXlMaWtlKHRoYXQsIG9iaikKICAgICAgfQogIAogICAgICBpZiAob2JqLnR5cGUgPT09ICdCdWZmZXInICYmIGlzQXJyYXkob2JqLmRhdGEpKSB7CiAgICAgICAgcmV0dXJuIGZyb21BcnJheUxpa2UodGhhdCwgb2JqLmRhdGEpCiAgICAgIH0KICAgIH0KICAKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCBvciBhcnJheS1saWtlIG9iamVjdC4nKQogIH0KICAKICBmdW5jdGlvbiBjaGVja2VkIChsZW5ndGgpIHsKICAgIC8vIE5vdGU6IGNhbm5vdCB1c2UgYGxlbmd0aCA8IGtNYXhMZW5ndGgoKWAgaGVyZSBiZWNhdXNlIHRoYXQgZmFpbHMgd2hlbgogICAgLy8gbGVuZ3RoIGlzIE5hTiAod2hpY2ggaXMgb3RoZXJ3aXNlIGNvZXJjZWQgdG8gemVyby4pCiAgICBpZiAobGVuZ3RoID49IGtNYXhMZW5ndGgoKSkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byBhbGxvY2F0ZSBCdWZmZXIgbGFyZ2VyIHRoYW4gbWF4aW11bSAnICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NpemU6IDB4JyArIGtNYXhMZW5ndGgoKS50b1N0cmluZygxNikgKyAnIGJ5dGVzJykKICAgIH0KICAgIHJldHVybiBsZW5ndGggfCAwCiAgfQogIAogIGZ1bmN0aW9uIFNsb3dCdWZmZXIgKGxlbmd0aCkgewogICAgaWYgKCtsZW5ndGggIT0gbGVuZ3RoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgZXFlcWVxCiAgICAgIGxlbmd0aCA9IDAKICAgIH0KICAgIHJldHVybiBCdWZmZXIuYWxsb2MoK2xlbmd0aCkKICB9CiAgCiAgQnVmZmVyLmlzQnVmZmVyID0gZnVuY3Rpb24gaXNCdWZmZXIgKGIpIHsKICAgIHJldHVybiAhIShiICE9IG51bGwgJiYgYi5faXNCdWZmZXIpCiAgfQogIAogIEJ1ZmZlci5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSAoYSwgYikgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYSkgfHwgIUJ1ZmZlci5pc0J1ZmZlcihiKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudHMgbXVzdCBiZSBCdWZmZXJzJykKICAgIH0KICAKICAgIGlmIChhID09PSBiKSByZXR1cm4gMAogIAogICAgdmFyIHggPSBhLmxlbmd0aAogICAgdmFyIHkgPSBiLmxlbmd0aAogIAogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IE1hdGgubWluKHgsIHkpOyBpIDwgbGVuOyArK2kpIHsKICAgICAgaWYgKGFbaV0gIT09IGJbaV0pIHsKICAgICAgICB4ID0gYVtpXQogICAgICAgIHkgPSBiW2ldCiAgICAgICAgYnJlYWsKICAgICAgfQogICAgfQogIAogICAgaWYgKHggPCB5KSByZXR1cm4gLTEKICAgIGlmICh5IDwgeCkgcmV0dXJuIDEKICAgIHJldHVybiAwCiAgfQogIAogIEJ1ZmZlci5pc0VuY29kaW5nID0gZnVuY3Rpb24gaXNFbmNvZGluZyAoZW5jb2RpbmcpIHsKICAgIHN3aXRjaCAoU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgIGNhc2UgJ2hleCc6CiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICBjYXNlICd1dGYtOCc6CiAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgY2FzZSAndWNzMic6CiAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICByZXR1cm4gdHJ1ZQogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0KICAKICBCdWZmZXIuY29uY2F0ID0gZnVuY3Rpb24gY29uY2F0IChsaXN0LCBsZW5ndGgpIHsKICAgIGlmICghaXNBcnJheShsaXN0KSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJykKICAgIH0KICAKICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gQnVmZmVyLmFsbG9jKDApCiAgICB9CiAgCiAgICB2YXIgaQogICAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGxlbmd0aCA9IDAKICAgICAgZm9yIChpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyArK2kpIHsKICAgICAgICBsZW5ndGggKz0gbGlzdFtpXS5sZW5ndGgKICAgICAgfQogICAgfQogIAogICAgdmFyIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShsZW5ndGgpCiAgICB2YXIgcG9zID0gMAogICAgZm9yIChpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyArK2kpIHsKICAgICAgdmFyIGJ1ZiA9IGxpc3RbaV0KICAgICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKQogICAgICB9CiAgICAgIGJ1Zi5jb3B5KGJ1ZmZlciwgcG9zKQogICAgICBwb3MgKz0gYnVmLmxlbmd0aAogICAgfQogICAgcmV0dXJuIGJ1ZmZlcgogIH0KICAKICBmdW5jdGlvbiBieXRlTGVuZ3RoIChzdHJpbmcsIGVuY29kaW5nKSB7CiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKHN0cmluZykpIHsKICAgICAgcmV0dXJuIHN0cmluZy5sZW5ndGgKICAgIH0KICAgIGlmICh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBBcnJheUJ1ZmZlci5pc1ZpZXcgPT09ICdmdW5jdGlvbicgJiYKICAgICAgICAoQXJyYXlCdWZmZXIuaXNWaWV3KHN0cmluZykgfHwgc3RyaW5nIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpKSB7CiAgICAgIHJldHVybiBzdHJpbmcuYnl0ZUxlbmd0aAogICAgfQogICAgaWYgKHR5cGVvZiBzdHJpbmcgIT09ICdzdHJpbmcnKSB7CiAgICAgIHN0cmluZyA9ICcnICsgc3RyaW5nCiAgICB9CiAgCiAgICB2YXIgbGVuID0gc3RyaW5nLmxlbmd0aAogICAgaWYgKGxlbiA9PT0gMCkgcmV0dXJuIDAKICAKICAgIC8vIFVzZSBhIGZvciBsb29wIHRvIGF2b2lkIHJlY3Vyc2lvbgogICAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICAgIGZvciAoOzspIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gbGVuCiAgICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgIGNhc2UgdW5kZWZpbmVkOgogICAgICAgICAgcmV0dXJuIHV0ZjhUb0J5dGVzKHN0cmluZykubGVuZ3RoCiAgICAgICAgY2FzZSAndWNzMic6CiAgICAgICAgY2FzZSAndWNzLTInOgogICAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICAgIHJldHVybiBsZW4gKiAyCiAgICAgICAgY2FzZSAnaGV4JzoKICAgICAgICAgIHJldHVybiBsZW4gPj4+IDEKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgICAgcmV0dXJuIGJhc2U2NFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGgKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgaWYgKGxvd2VyZWRDYXNlKSByZXR1cm4gdXRmOFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGggLy8gYXNzdW1lIHV0ZjgKICAgICAgICAgIGVuY29kaW5nID0gKCcnICsgZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgICB9CiAgICB9CiAgfQogIEJ1ZmZlci5ieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aAogIAogIGZ1bmN0aW9uIHNsb3dUb1N0cmluZyAoZW5jb2RpbmcsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgCiAgICAvLyBObyBuZWVkIHRvIHZlcmlmeSB0aGF0ICJ0aGlzLmxlbmd0aCA8PSBNQVhfVUlOVDMyIiBzaW5jZSBpdCdzIGEgcmVhZC1vbmx5CiAgICAvLyBwcm9wZXJ0eSBvZiBhIHR5cGVkIGFycmF5LgogIAogICAgLy8gVGhpcyBiZWhhdmVzIG5laXRoZXIgbGlrZSBTdHJpbmcgbm9yIFVpbnQ4QXJyYXkgaW4gdGhhdCB3ZSBzZXQgc3RhcnQvZW5kCiAgICAvLyB0byB0aGVpciB1cHBlci9sb3dlciBib3VuZHMgaWYgdGhlIHZhbHVlIHBhc3NlZCBpcyBvdXQgb2YgcmFuZ2UuCiAgICAvLyB1bmRlZmluZWQgaXMgaGFuZGxlZCBzcGVjaWFsbHkgYXMgcGVyIEVDTUEtMjYyIDZ0aCBFZGl0aW9uLAogICAgLy8gU2VjdGlvbiAxMy4zLjMuNyBSdW50aW1lIFNlbWFudGljczogS2V5ZWRCaW5kaW5nSW5pdGlhbGl6YXRpb24uCiAgICBpZiAoc3RhcnQgPT09IHVuZGVmaW5lZCB8fCBzdGFydCA8IDApIHsKICAgICAgc3RhcnQgPSAwCiAgICB9CiAgICAvLyBSZXR1cm4gZWFybHkgaWYgc3RhcnQgPiB0aGlzLmxlbmd0aC4gRG9uZSBoZXJlIHRvIHByZXZlbnQgcG90ZW50aWFsIHVpbnQzMgogICAgLy8gY29lcmNpb24gZmFpbCBiZWxvdy4KICAgIGlmIChzdGFydCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHJldHVybiAnJwogICAgfQogIAogICAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkIHx8IGVuZCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICB9CiAgCiAgICBpZiAoZW5kIDw9IDApIHsKICAgICAgcmV0dXJuICcnCiAgICB9CiAgCiAgICAvLyBGb3JjZSBjb2Vyc2lvbiB0byB1aW50MzIuIFRoaXMgd2lsbCBhbHNvIGNvZXJjZSBmYWxzZXkvTmFOIHZhbHVlcyB0byAwLgogICAgZW5kID4+Pj0gMAogICAgc3RhcnQgPj4+PSAwCiAgCiAgICBpZiAoZW5kIDw9IHN0YXJ0KSB7CiAgICAgIHJldHVybiAnJwogICAgfQogIAogICAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCcKICAKICAgIHdoaWxlICh0cnVlKSB7CiAgICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgICBjYXNlICdoZXgnOgogICAgICAgICAgcmV0dXJuIGhleFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAndXRmOCc6CiAgICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgICAgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICAgIHJldHVybiBhc2NpaVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgICBjYXNlICdiaW5hcnknOgogICAgICAgICAgcmV0dXJuIGxhdGluMVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICAgIHJldHVybiBiYXNlNjRTbGljZSh0aGlzLCBzdGFydCwgZW5kKQogIAogICAgICAgIGNhc2UgJ3VjczInOgogICAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgICByZXR1cm4gdXRmMTZsZVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCiAgCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICAgICAgZW5jb2RpbmcgPSAoZW5jb2RpbmcgKyAnJykudG9Mb3dlckNhc2UoKQogICAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CiAgCiAgLy8gVGhlIHByb3BlcnR5IGlzIHVzZWQgYnkgYEJ1ZmZlci5pc0J1ZmZlcmAgYW5kIGBpcy1idWZmZXJgIChpbiBTYWZhcmkgNS03KSB0byBkZXRlY3QKICAvLyBCdWZmZXIgaW5zdGFuY2VzLgogIEJ1ZmZlci5wcm90b3R5cGUuX2lzQnVmZmVyID0gdHJ1ZQogIAogIGZ1bmN0aW9uIHN3YXAgKGIsIG4sIG0pIHsKICAgIHZhciBpID0gYltuXQogICAgYltuXSA9IGJbbV0KICAgIGJbbV0gPSBpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc3dhcDE2ID0gZnVuY3Rpb24gc3dhcDE2ICgpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgaWYgKGxlbiAlIDIgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAxNi1iaXRzJykKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDIpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgMSkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuc3dhcDMyID0gZnVuY3Rpb24gc3dhcDMyICgpIHsKICAgIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogICAgaWYgKGxlbiAlIDQgIT09IDApIHsKICAgICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0J1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzJykKICAgIH0KICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDQpIHsKICAgICAgc3dhcCh0aGlzLCBpLCBpICsgMykKICAgICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDIpCiAgICB9CiAgICByZXR1cm4gdGhpcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnN3YXA2NCA9IGZ1bmN0aW9uIHN3YXA2NCAoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIGlmIChsZW4gJSA4ICE9PSAwKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNjQtYml0cycpCiAgICB9CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSA4KSB7CiAgICAgIHN3YXAodGhpcywgaSwgaSArIDcpCiAgICAgIHN3YXAodGhpcywgaSArIDEsIGkgKyA2KQogICAgICBzd2FwKHRoaXMsIGkgKyAyLCBpICsgNSkKICAgICAgc3dhcCh0aGlzLCBpICsgMywgaSArIDQpCiAgICB9CiAgICByZXR1cm4gdGhpcwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcgKCkgewogICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoIHwgMAogICAgaWYgKGxlbmd0aCA9PT0gMCkgcmV0dXJuICcnCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCAwLCBsZW5ndGgpCiAgICByZXR1cm4gc2xvd1RvU3RyaW5nLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbiBlcXVhbHMgKGIpIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGIpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICAgIGlmICh0aGlzID09PSBiKSByZXR1cm4gdHJ1ZQogICAgcmV0dXJuIEJ1ZmZlci5jb21wYXJlKHRoaXMsIGIpID09PSAwCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuaW5zcGVjdCA9IGZ1bmN0aW9uIGluc3BlY3QgKCkgewogICAgdmFyIHN0ciA9ICcnCiAgICB2YXIgbWF4ID0gZXhwb3J0cy5JTlNQRUNUX01BWF9CWVRFUwogICAgaWYgKHRoaXMubGVuZ3RoID4gMCkgewogICAgICBzdHIgPSB0aGlzLnRvU3RyaW5nKCdoZXgnLCAwLCBtYXgpLm1hdGNoKC8uezJ9L2cpLmpvaW4oJyAnKQogICAgICBpZiAodGhpcy5sZW5ndGggPiBtYXgpIHN0ciArPSAnIC4uLiAnCiAgICB9CiAgICByZXR1cm4gJzxCdWZmZXIgJyArIHN0ciArICc+JwogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiBjb21wYXJlICh0YXJnZXQsIHN0YXJ0LCBlbmQsIHRoaXNTdGFydCwgdGhpc0VuZCkgewogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIodGFyZ2V0KSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICAgIH0KICAKICAgIGlmIChzdGFydCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHN0YXJ0ID0gMAogICAgfQogICAgaWYgKGVuZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGVuZCA9IHRhcmdldCA/IHRhcmdldC5sZW5ndGggOiAwCiAgICB9CiAgICBpZiAodGhpc1N0YXJ0ID09PSB1bmRlZmluZWQpIHsKICAgICAgdGhpc1N0YXJ0ID0gMAogICAgfQogICAgaWYgKHRoaXNFbmQgPT09IHVuZGVmaW5lZCkgewogICAgICB0aGlzRW5kID0gdGhpcy5sZW5ndGgKICAgIH0KICAKICAgIGlmIChzdGFydCA8IDAgfHwgZW5kID4gdGFyZ2V0Lmxlbmd0aCB8fCB0aGlzU3RhcnQgPCAwIHx8IHRoaXNFbmQgPiB0aGlzLmxlbmd0aCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb3V0IG9mIHJhbmdlIGluZGV4JykKICAgIH0KICAKICAgIGlmICh0aGlzU3RhcnQgPj0gdGhpc0VuZCAmJiBzdGFydCA+PSBlbmQpIHsKICAgICAgcmV0dXJuIDAKICAgIH0KICAgIGlmICh0aGlzU3RhcnQgPj0gdGhpc0VuZCkgewogICAgICByZXR1cm4gLTEKICAgIH0KICAgIGlmIChzdGFydCA+PSBlbmQpIHsKICAgICAgcmV0dXJuIDEKICAgIH0KICAKICAgIHN0YXJ0ID4+Pj0gMAogICAgZW5kID4+Pj0gMAogICAgdGhpc1N0YXJ0ID4+Pj0gMAogICAgdGhpc0VuZCA+Pj49IDAKICAKICAgIGlmICh0aGlzID09PSB0YXJnZXQpIHJldHVybiAwCiAgCiAgICB2YXIgeCA9IHRoaXNFbmQgLSB0aGlzU3RhcnQKICAgIHZhciB5ID0gZW5kIC0gc3RhcnQKICAgIHZhciBsZW4gPSBNYXRoLm1pbih4LCB5KQogIAogICAgdmFyIHRoaXNDb3B5ID0gdGhpcy5zbGljZSh0aGlzU3RhcnQsIHRoaXNFbmQpCiAgICB2YXIgdGFyZ2V0Q29weSA9IHRhcmdldC5zbGljZShzdGFydCwgZW5kKQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICBpZiAodGhpc0NvcHlbaV0gIT09IHRhcmdldENvcHlbaV0pIHsKICAgICAgICB4ID0gdGhpc0NvcHlbaV0KICAgICAgICB5ID0gdGFyZ2V0Q29weVtpXQogICAgICAgIGJyZWFrCiAgICAgIH0KICAgIH0KICAKICAgIGlmICh4IDwgeSkgcmV0dXJuIC0xCiAgICBpZiAoeSA8IHgpIHJldHVybiAxCiAgICByZXR1cm4gMAogIH0KICAKICAvLyBGaW5kcyBlaXRoZXIgdGhlIGZpcnN0IGluZGV4IG9mIGB2YWxgIGluIGBidWZmZXJgIGF0IG9mZnNldCA+PSBgYnl0ZU9mZnNldGAsCiAgLy8gT1IgdGhlIGxhc3QgaW5kZXggb2YgYHZhbGAgaW4gYGJ1ZmZlcmAgYXQgb2Zmc2V0IDw9IGBieXRlT2Zmc2V0YC4KICAvLwogIC8vIEFyZ3VtZW50czoKICAvLyAtIGJ1ZmZlciAtIGEgQnVmZmVyIHRvIHNlYXJjaAogIC8vIC0gdmFsIC0gYSBzdHJpbmcsIEJ1ZmZlciwgb3IgbnVtYmVyCiAgLy8gLSBieXRlT2Zmc2V0IC0gYW4gaW5kZXggaW50byBgYnVmZmVyYDsgd2lsbCBiZSBjbGFtcGVkIHRvIGFuIGludDMyCiAgLy8gLSBlbmNvZGluZyAtIGFuIG9wdGlvbmFsIGVuY29kaW5nLCByZWxldmFudCBpcyB2YWwgaXMgYSBzdHJpbmcKICAvLyAtIGRpciAtIHRydWUgZm9yIGluZGV4T2YsIGZhbHNlIGZvciBsYXN0SW5kZXhPZgogIGZ1bmN0aW9uIGJpZGlyZWN0aW9uYWxJbmRleE9mIChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewogICAgLy8gRW1wdHkgYnVmZmVyIG1lYW5zIG5vIG1hdGNoCiAgICBpZiAoYnVmZmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuIC0xCiAgCiAgICAvLyBOb3JtYWxpemUgYnl0ZU9mZnNldAogICAgaWYgKHR5cGVvZiBieXRlT2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IGJ5dGVPZmZzZXQKICAgICAgYnl0ZU9mZnNldCA9IDAKICAgIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA+IDB4N2ZmZmZmZmYpIHsKICAgICAgYnl0ZU9mZnNldCA9IDB4N2ZmZmZmZmYKICAgIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA8IC0weDgwMDAwMDAwKSB7CiAgICAgIGJ5dGVPZmZzZXQgPSAtMHg4MDAwMDAwMAogICAgfQogICAgYnl0ZU9mZnNldCA9ICtieXRlT2Zmc2V0ICAvLyBDb2VyY2UgdG8gTnVtYmVyLgogICAgaWYgKGlzTmFOKGJ5dGVPZmZzZXQpKSB7CiAgICAgIC8vIGJ5dGVPZmZzZXQ6IGl0IGl0J3MgdW5kZWZpbmVkLCBudWxsLCBOYU4sICJmb28iLCBldGMsIHNlYXJjaCB3aG9sZSBidWZmZXIKICAgICAgYnl0ZU9mZnNldCA9IGRpciA/IDAgOiAoYnVmZmVyLmxlbmd0aCAtIDEpCiAgICB9CiAgCiAgICAvLyBOb3JtYWxpemUgYnl0ZU9mZnNldDogbmVnYXRpdmUgb2Zmc2V0cyBzdGFydCBmcm9tIHRoZSBlbmQgb2YgdGhlIGJ1ZmZlcgogICAgaWYgKGJ5dGVPZmZzZXQgPCAwKSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCArIGJ5dGVPZmZzZXQKICAgIGlmIChieXRlT2Zmc2V0ID49IGJ1ZmZlci5sZW5ndGgpIHsKICAgICAgaWYgKGRpcikgcmV0dXJuIC0xCiAgICAgIGVsc2UgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggLSAxCiAgICB9IGVsc2UgaWYgKGJ5dGVPZmZzZXQgPCAwKSB7CiAgICAgIGlmIChkaXIpIGJ5dGVPZmZzZXQgPSAwCiAgICAgIGVsc2UgcmV0dXJuIC0xCiAgICB9CiAgCiAgICAvLyBOb3JtYWxpemUgdmFsCiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFsID0gQnVmZmVyLmZyb20odmFsLCBlbmNvZGluZykKICAgIH0KICAKICAgIC8vIEZpbmFsbHksIHNlYXJjaCBlaXRoZXIgaW5kZXhPZiAoaWYgZGlyIGlzIHRydWUpIG9yIGxhc3RJbmRleE9mCiAgICBpZiAoQnVmZmVyLmlzQnVmZmVyKHZhbCkpIHsKICAgICAgLy8gU3BlY2lhbCBjYXNlOiBsb29raW5nIGZvciBlbXB0eSBzdHJpbmcvYnVmZmVyIGFsd2F5cyBmYWlscwogICAgICBpZiAodmFsLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiAtMQogICAgICB9CiAgICAgIHJldHVybiBhcnJheUluZGV4T2YoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpCiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICAgIHZhbCA9IHZhbCAmIDB4RkYgLy8gU2VhcmNoIGZvciBhIGJ5dGUgdmFsdWUgWzAtMjU1XQogICAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQgJiYKICAgICAgICAgIHR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgaWYgKGRpcikgewogICAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFVpbnQ4QXJyYXkucHJvdG90eXBlLmxhc3RJbmRleE9mLmNhbGwoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQpCiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhcnJheUluZGV4T2YoYnVmZmVyLCBbIHZhbCBdLCBieXRlT2Zmc2V0LCBlbmNvZGluZywgZGlyKQogICAgfQogIAogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigndmFsIG11c3QgYmUgc3RyaW5nLCBudW1iZXIgb3IgQnVmZmVyJykKICB9CiAgCiAgZnVuY3Rpb24gYXJyYXlJbmRleE9mIChhcnIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikgewogICAgdmFyIGluZGV4U2l6ZSA9IDEKICAgIHZhciBhcnJMZW5ndGggPSBhcnIubGVuZ3RoCiAgICB2YXIgdmFsTGVuZ3RoID0gdmFsLmxlbmd0aAogIAogICAgaWYgKGVuY29kaW5nICE9PSB1bmRlZmluZWQpIHsKICAgICAgZW5jb2RpbmcgPSBTdHJpbmcoZW5jb2RpbmcpLnRvTG93ZXJDYXNlKCkKICAgICAgaWYgKGVuY29kaW5nID09PSAndWNzMicgfHwgZW5jb2RpbmcgPT09ICd1Y3MtMicgfHwKICAgICAgICAgIGVuY29kaW5nID09PSAndXRmMTZsZScgfHwgZW5jb2RpbmcgPT09ICd1dGYtMTZsZScpIHsKICAgICAgICBpZiAoYXJyLmxlbmd0aCA8IDIgfHwgdmFsLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIHJldHVybiAtMQogICAgICAgIH0KICAgICAgICBpbmRleFNpemUgPSAyCiAgICAgICAgYXJyTGVuZ3RoIC89IDIKICAgICAgICB2YWxMZW5ndGggLz0gMgogICAgICAgIGJ5dGVPZmZzZXQgLz0gMgogICAgICB9CiAgICB9CiAgCiAgICBmdW5jdGlvbiByZWFkIChidWYsIGkpIHsKICAgICAgaWYgKGluZGV4U2l6ZSA9PT0gMSkgewogICAgICAgIHJldHVybiBidWZbaV0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYnVmLnJlYWRVSW50MTZCRShpICogaW5kZXhTaXplKQogICAgICB9CiAgICB9CiAgCiAgICB2YXIgaQogICAgaWYgKGRpcikgewogICAgICB2YXIgZm91bmRJbmRleCA9IC0xCiAgICAgIGZvciAoaSA9IGJ5dGVPZmZzZXQ7IGkgPCBhcnJMZW5ndGg7IGkrKykgewogICAgICAgIGlmIChyZWFkKGFyciwgaSkgPT09IHJlYWQodmFsLCBmb3VuZEluZGV4ID09PSAtMSA/IDAgOiBpIC0gZm91bmRJbmRleCkpIHsKICAgICAgICAgIGlmIChmb3VuZEluZGV4ID09PSAtMSkgZm91bmRJbmRleCA9IGkKICAgICAgICAgIGlmIChpIC0gZm91bmRJbmRleCArIDEgPT09IHZhbExlbmd0aCkgcmV0dXJuIGZvdW5kSW5kZXggKiBpbmRleFNpemUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGZvdW5kSW5kZXggIT09IC0xKSBpIC09IGkgLSBmb3VuZEluZGV4CiAgICAgICAgICBmb3VuZEluZGV4ID0gLTEKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChieXRlT2Zmc2V0ICsgdmFsTGVuZ3RoID4gYXJyTGVuZ3RoKSBieXRlT2Zmc2V0ID0gYXJyTGVuZ3RoIC0gdmFsTGVuZ3RoCiAgICAgIGZvciAoaSA9IGJ5dGVPZmZzZXQ7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgdmFyIGZvdW5kID0gdHJ1ZQogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdmFsTGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChyZWFkKGFyciwgaSArIGopICE9PSByZWFkKHZhbCwgaikpIHsKICAgICAgICAgICAgZm91bmQgPSBmYWxzZQogICAgICAgICAgICBicmVhawogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZm91bmQpIHJldHVybiBpCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiAtMQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmluY2x1ZGVzID0gZnVuY3Rpb24gaW5jbHVkZXMgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiB0aGlzLmluZGV4T2YodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgIT09IC0xCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uIGluZGV4T2YgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBiaWRpcmVjdGlvbmFsSW5kZXhPZih0aGlzLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCB0cnVlKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLmxhc3RJbmRleE9mID0gZnVuY3Rpb24gbGFzdEluZGV4T2YgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICAgIHJldHVybiBiaWRpcmVjdGlvbmFsSW5kZXhPZih0aGlzLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBmYWxzZSkKICB9CiAgCiAgZnVuY3Rpb24gaGV4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgb2Zmc2V0ID0gTnVtYmVyKG9mZnNldCkgfHwgMAogICAgdmFyIHJlbWFpbmluZyA9IGJ1Zi5sZW5ndGggLSBvZmZzZXQKICAgIGlmICghbGVuZ3RoKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgfSBlbHNlIHsKICAgICAgbGVuZ3RoID0gTnVtYmVyKGxlbmd0aCkKICAgICAgaWYgKGxlbmd0aCA+IHJlbWFpbmluZykgewogICAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgICB9CiAgICB9CiAgCiAgICAvLyBtdXN0IGJlIGFuIGV2ZW4gbnVtYmVyIG9mIGRpZ2l0cwogICAgdmFyIHN0ckxlbiA9IHN0cmluZy5sZW5ndGgKICAgIGlmIChzdHJMZW4gJSAyICE9PSAwKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIGhleCBzdHJpbmcnKQogIAogICAgaWYgKGxlbmd0aCA+IHN0ckxlbiAvIDIpIHsKICAgICAgbGVuZ3RoID0gc3RyTGVuIC8gMgogICAgfQogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICB2YXIgcGFyc2VkID0gcGFyc2VJbnQoc3RyaW5nLnN1YnN0cihpICogMiwgMiksIDE2KQogICAgICBpZiAoaXNOYU4ocGFyc2VkKSkgcmV0dXJuIGkKICAgICAgYnVmW29mZnNldCArIGldID0gcGFyc2VkCiAgICB9CiAgICByZXR1cm4gaQogIH0KICAKICBmdW5jdGlvbiB1dGY4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGJsaXRCdWZmZXIodXRmOFRvQnl0ZXMoc3RyaW5nLCBidWYubGVuZ3RoIC0gb2Zmc2V0KSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gYXNjaWlXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcihhc2NpaVRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICB9CiAgCiAgZnVuY3Rpb24gbGF0aW4xV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogICAgcmV0dXJuIGFzY2lpV3JpdGUoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBmdW5jdGlvbiBiYXNlNjRXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcihiYXNlNjRUb0J5dGVzKHN0cmluZyksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCiAgfQogIAogIGZ1bmN0aW9uIHVjczJXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgICByZXR1cm4gYmxpdEJ1ZmZlcih1dGYxNmxlVG9CeXRlcyhzdHJpbmcsIGJ1Zi5sZW5ndGggLSBvZmZzZXQpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24gd3JpdGUgKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKSB7CiAgICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nKQogICAgaWYgKG9mZnNldCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGVuY29kaW5nID0gJ3V0ZjgnCiAgICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICAgIG9mZnNldCA9IDAKICAgIC8vIEJ1ZmZlciN3cml0ZShzdHJpbmcsIGVuY29kaW5nKQogICAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICBlbmNvZGluZyA9IG9mZnNldAogICAgICBsZW5ndGggPSB0aGlzLmxlbmd0aAogICAgICBvZmZzZXQgPSAwCiAgICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nLCBvZmZzZXRbLCBsZW5ndGhdWywgZW5jb2RpbmddKQogICAgfSBlbHNlIGlmIChpc0Zpbml0ZShvZmZzZXQpKSB7CiAgICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgICAgaWYgKGlzRmluaXRlKGxlbmd0aCkpIHsKICAgICAgICBsZW5ndGggPSBsZW5ndGggfCAwCiAgICAgICAgaWYgKGVuY29kaW5nID09PSB1bmRlZmluZWQpIGVuY29kaW5nID0gJ3V0ZjgnCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5jb2RpbmcgPSBsZW5ndGgKICAgICAgICBsZW5ndGggPSB1bmRlZmluZWQKICAgICAgfQogICAgLy8gbGVnYWN5IHdyaXRlKHN0cmluZywgZW5jb2RpbmcsIG9mZnNldCwgbGVuZ3RoKSAtIHJlbW92ZSBpbiB2MC4xMwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICdCdWZmZXIud3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0WywgbGVuZ3RoXSkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCcKICAgICAgKQogICAgfQogIAogICAgdmFyIHJlbWFpbmluZyA9IHRoaXMubGVuZ3RoIC0gb2Zmc2V0CiAgICBpZiAobGVuZ3RoID09PSB1bmRlZmluZWQgfHwgbGVuZ3RoID4gcmVtYWluaW5nKSBsZW5ndGggPSByZW1haW5pbmcKICAKICAgIGlmICgoc3RyaW5nLmxlbmd0aCA+IDAgJiYgKGxlbmd0aCA8IDAgfHwgb2Zmc2V0IDwgMCkpIHx8IG9mZnNldCA+IHRoaXMubGVuZ3RoKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdBdHRlbXB0IHRvIHdyaXRlIG91dHNpZGUgYnVmZmVyIGJvdW5kcycpCiAgICB9CiAgCiAgICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwogIAogICAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICAgIGZvciAoOzspIHsKICAgICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgICByZXR1cm4gaGV4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICd1dGY4JzoKICAgICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgICByZXR1cm4gdXRmOFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgICAgcmV0dXJuIGFzY2lpV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICdsYXRpbjEnOgogICAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgICByZXR1cm4gbGF0aW4xV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAKICAgICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgICAgLy8gV2FybmluZzogbWF4TGVuZ3RoIG5vdCB0YWtlbiBpbnRvIGFjY291bnQgaW4gYmFzZTY0V3JpdGUKICAgICAgICAgIHJldHVybiBiYXNlNjRXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogIAogICAgICAgIGNhc2UgJ3VjczInOgogICAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgICByZXR1cm4gdWNzMldyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICAgIH0KICAgIH0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04gKCkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogJ0J1ZmZlcicsCiAgICAgIGRhdGE6IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMuX2FyciB8fCB0aGlzLCAwKQogICAgfQogIH0KICAKICBmdW5jdGlvbiBiYXNlNjRTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICBpZiAoc3RhcnQgPT09IDAgJiYgZW5kID09PSBidWYubGVuZ3RoKSB7CiAgICAgIHJldHVybiBiYXNlNjQuZnJvbUJ5dGVBcnJheShidWYpCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYmFzZTY0LmZyb21CeXRlQXJyYXkoYnVmLnNsaWNlKHN0YXJ0LCBlbmQpKQogICAgfQogIH0KICAKICBmdW5jdGlvbiB1dGY4U2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQogICAgdmFyIHJlcyA9IFtdCiAgCiAgICB2YXIgaSA9IHN0YXJ0CiAgICB3aGlsZSAoaSA8IGVuZCkgewogICAgICB2YXIgZmlyc3RCeXRlID0gYnVmW2ldCiAgICAgIHZhciBjb2RlUG9pbnQgPSBudWxsCiAgICAgIHZhciBieXRlc1BlclNlcXVlbmNlID0gKGZpcnN0Qnl0ZSA+IDB4RUYpID8gNAogICAgICAgIDogKGZpcnN0Qnl0ZSA+IDB4REYpID8gMwogICAgICAgIDogKGZpcnN0Qnl0ZSA+IDB4QkYpID8gMgogICAgICAgIDogMQogIAogICAgICBpZiAoaSArIGJ5dGVzUGVyU2VxdWVuY2UgPD0gZW5kKSB7CiAgICAgICAgdmFyIHNlY29uZEJ5dGUsIHRoaXJkQnl0ZSwgZm91cnRoQnl0ZSwgdGVtcENvZGVQb2ludAogIAogICAgICAgIHN3aXRjaCAoYnl0ZXNQZXJTZXF1ZW5jZSkgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBpZiAoZmlyc3RCeXRlIDwgMHg4MCkgewogICAgICAgICAgICAgIGNvZGVQb2ludCA9IGZpcnN0Qnl0ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweDFGKSA8PCAweDYgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweDdGKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICAgIHRoaXJkQnl0ZSA9IGJ1ZltpICsgMl0KICAgICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweEYpIDw8IDB4QyB8IChzZWNvbmRCeXRlICYgMHgzRikgPDwgMHg2IHwgKHRoaXJkQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweDdGRiAmJiAodGVtcENvZGVQb2ludCA8IDB4RDgwMCB8fCB0ZW1wQ29kZVBvaW50ID4gMHhERkZGKSkgewogICAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhawogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgICB0aGlyZEJ5dGUgPSBidWZbaSArIDJdCiAgICAgICAgICAgIGZvdXJ0aEJ5dGUgPSBidWZbaSArIDNdCiAgICAgICAgICAgIGlmICgoc2Vjb25kQnl0ZSAmIDB4QzApID09PSAweDgwICYmICh0aGlyZEJ5dGUgJiAweEMwKSA9PT0gMHg4MCAmJiAoZm91cnRoQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweEYpIDw8IDB4MTIgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpIDw8IDB4QyB8ICh0aGlyZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAoZm91cnRoQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgICAgaWYgKHRlbXBDb2RlUG9pbnQgPiAweEZGRkYgJiYgdGVtcENvZGVQb2ludCA8IDB4MTEwMDAwKSB7CiAgICAgICAgICAgICAgICBjb2RlUG9pbnQgPSB0ZW1wQ29kZVBvaW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmIChjb2RlUG9pbnQgPT09IG51bGwpIHsKICAgICAgICAvLyB3ZSBkaWQgbm90IGdlbmVyYXRlIGEgdmFsaWQgY29kZVBvaW50IHNvIGluc2VydCBhCiAgICAgICAgLy8gcmVwbGFjZW1lbnQgY2hhciAoVStGRkZEKSBhbmQgYWR2YW5jZSBvbmx5IDEgYnl0ZQogICAgICAgIGNvZGVQb2ludCA9IDB4RkZGRAogICAgICAgIGJ5dGVzUGVyU2VxdWVuY2UgPSAxCiAgICAgIH0gZWxzZSBpZiAoY29kZVBvaW50ID4gMHhGRkZGKSB7CiAgICAgICAgLy8gZW5jb2RlIHRvIHV0ZjE2IChzdXJyb2dhdGUgcGFpciBkYW5jZSkKICAgICAgICBjb2RlUG9pbnQgLT0gMHgxMDAwMAogICAgICAgIHJlcy5wdXNoKGNvZGVQb2ludCA+Pj4gMTAgJiAweDNGRiB8IDB4RDgwMCkKICAgICAgICBjb2RlUG9pbnQgPSAweERDMDAgfCBjb2RlUG9pbnQgJiAweDNGRgogICAgICB9CiAgCiAgICAgIHJlcy5wdXNoKGNvZGVQb2ludCkKICAgICAgaSArPSBieXRlc1BlclNlcXVlbmNlCiAgICB9CiAgCiAgICByZXR1cm4gZGVjb2RlQ29kZVBvaW50c0FycmF5KHJlcykKICB9CiAgCiAgLy8gQmFzZWQgb24gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjI3NDcyNzIvNjgwNzQyLCB0aGUgYnJvd3NlciB3aXRoCiAgLy8gdGhlIGxvd2VzdCBsaW1pdCBpcyBDaHJvbWUsIHdpdGggMHgxMDAwMCBhcmdzLgogIC8vIFdlIGdvIDEgbWFnbml0dWRlIGxlc3MsIGZvciBzYWZldHkKICB2YXIgTUFYX0FSR1VNRU5UU19MRU5HVEggPSAweDEwMDAKICAKICBmdW5jdGlvbiBkZWNvZGVDb2RlUG9pbnRzQXJyYXkgKGNvZGVQb2ludHMpIHsKICAgIHZhciBsZW4gPSBjb2RlUG9pbnRzLmxlbmd0aAogICAgaWYgKGxlbiA8PSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkgewogICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNvZGVQb2ludHMpIC8vIGF2b2lkIGV4dHJhIHNsaWNlKCkKICAgIH0KICAKICAgIC8vIERlY29kZSBpbiBjaHVua3MgdG8gYXZvaWQgImNhbGwgc3RhY2sgc2l6ZSBleGNlZWRlZCIuCiAgICB2YXIgcmVzID0gJycKICAgIHZhciBpID0gMAogICAgd2hpbGUgKGkgPCBsZW4pIHsKICAgICAgcmVzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoCiAgICAgICAgU3RyaW5nLAogICAgICAgIGNvZGVQb2ludHMuc2xpY2UoaSwgaSArPSBNQVhfQVJHVU1FTlRTX0xFTkdUSCkKICAgICAgKQogICAgfQogICAgcmV0dXJuIHJlcwogIH0KICAKICBmdW5jdGlvbiBhc2NpaVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciByZXQgPSAnJwogICAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQogIAogICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldICYgMHg3RikKICAgIH0KICAgIHJldHVybiByZXQKICB9CiAgCiAgZnVuY3Rpb24gbGF0aW4xU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogICAgdmFyIHJldCA9ICcnCiAgICBlbmQgPSBNYXRoLm1pbihidWYubGVuZ3RoLCBlbmQpCiAgCiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICByZXQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0pCiAgICB9CiAgICByZXR1cm4gcmV0CiAgfQogIAogIGZ1bmN0aW9uIGhleFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICAgIHZhciBsZW4gPSBidWYubGVuZ3RoCiAgCiAgICBpZiAoIXN0YXJ0IHx8IHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgICBpZiAoIWVuZCB8fCBlbmQgPCAwIHx8IGVuZCA+IGxlbikgZW5kID0gbGVuCiAgCiAgICB2YXIgb3V0ID0gJycKICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIG91dCArPSB0b0hleChidWZbaV0pCiAgICB9CiAgICByZXR1cm4gb3V0CiAgfQogIAogIGZ1bmN0aW9uIHV0ZjE2bGVTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgICB2YXIgYnl0ZXMgPSBidWYuc2xpY2Uoc3RhcnQsIGVuZCkKICAgIHZhciByZXMgPSAnJwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBieXRlcy5sZW5ndGg7IGkgKz0gMikgewogICAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1tpXSArIGJ5dGVzW2kgKyAxXSAqIDI1NikKICAgIH0KICAgIHJldHVybiByZXMKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5zbGljZSA9IGZ1bmN0aW9uIHNsaWNlIChzdGFydCwgZW5kKSB7CiAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICAgIHN0YXJ0ID0gfn5zdGFydAogICAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyBsZW4gOiB+fmVuZAogIAogICAgaWYgKHN0YXJ0IDwgMCkgewogICAgICBzdGFydCArPSBsZW4KICAgICAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgICB9IGVsc2UgaWYgKHN0YXJ0ID4gbGVuKSB7CiAgICAgIHN0YXJ0ID0gbGVuCiAgICB9CiAgCiAgICBpZiAoZW5kIDwgMCkgewogICAgICBlbmQgKz0gbGVuCiAgICAgIGlmIChlbmQgPCAwKSBlbmQgPSAwCiAgICB9IGVsc2UgaWYgKGVuZCA+IGxlbikgewogICAgICBlbmQgPSBsZW4KICAgIH0KICAKICAgIGlmIChlbmQgPCBzdGFydCkgZW5kID0gc3RhcnQKICAKICAgIHZhciBuZXdCdWYKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICBuZXdCdWYgPSB0aGlzLnN1YmFycmF5KHN0YXJ0LCBlbmQpCiAgICAgIG5ld0J1Zi5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgICB9IGVsc2UgewogICAgICB2YXIgc2xpY2VMZW4gPSBlbmQgLSBzdGFydAogICAgICBuZXdCdWYgPSBuZXcgQnVmZmVyKHNsaWNlTGVuLCB1bmRlZmluZWQpCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpY2VMZW47ICsraSkgewogICAgICAgIG5ld0J1ZltpXSA9IHRoaXNbaSArIHN0YXJ0XQogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gbmV3QnVmCiAgfQogIAogIC8qCiAgICogTmVlZCB0byBtYWtlIHN1cmUgdGhhdCBidWZmZXIgaXNuJ3QgdHJ5aW5nIHRvIHdyaXRlIG91dCBvZiBib3VuZHMuCiAgICovCiAgZnVuY3Rpb24gY2hlY2tPZmZzZXQgKG9mZnNldCwgZXh0LCBsZW5ndGgpIHsKICAgIGlmICgob2Zmc2V0ICUgMSkgIT09IDAgfHwgb2Zmc2V0IDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ29mZnNldCBpcyBub3QgdWludCcpCiAgICBpZiAob2Zmc2V0ICsgZXh0ID4gbGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignVHJ5aW5nIHRvIGFjY2VzcyBiZXlvbmQgYnVmZmVyIGxlbmd0aCcpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRMRSA9IGZ1bmN0aW9uIHJlYWRVSW50TEUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCBieXRlTGVuZ3RoLCB0aGlzLmxlbmd0aCkKICAKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldF0KICAgIHZhciBtdWwgPSAxCiAgICB2YXIgaSA9IDAKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIGldICogbXVsCiAgICB9CiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnRCRSA9IGZ1bmN0aW9uIHJlYWRVSW50QkUgKG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogICAgfQogIAogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgLS1ieXRlTGVuZ3RoXQogICAgdmFyIG11bCA9IDEKICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdICogbXVsCiAgICB9CiAgCiAgICByZXR1cm4gdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQ4ID0gZnVuY3Rpb24gcmVhZFVJbnQ4IChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIHRoaXNbb2Zmc2V0XQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MTZMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiB0aGlzW29mZnNldF0gfCAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRVSW50MTZCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiAodGhpc1tvZmZzZXRdIDw8IDgpIHwgdGhpc1tvZmZzZXQgKyAxXQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJMRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAKICAgIHJldHVybiAoKHRoaXNbb2Zmc2V0XSkgfAogICAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKICAgICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikpICsKICAgICAgICAodGhpc1tvZmZzZXQgKyAzXSAqIDB4MTAwMDAwMCkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyQkUgPSBmdW5jdGlvbiByZWFkVUludDMyQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSAqIDB4MTAwMDAwMCkgKwogICAgICAoKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgICB0aGlzW29mZnNldCArIDNdKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnRMRSA9IGZ1bmN0aW9uIHJlYWRJbnRMRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIAogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XQogICAgdmFyIG11bCA9IDEKICAgIHZhciBpID0gMAogICAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgaV0gKiBtdWwKICAgIH0KICAgIG11bCAqPSAweDgwCiAgCiAgICBpZiAodmFsID49IG11bCkgdmFsIC09IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnRCRSA9IGZ1bmN0aW9uIHJlYWRJbnRCRSAob2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGggfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIGJ5dGVMZW5ndGgsIHRoaXMubGVuZ3RoKQogIAogICAgdmFyIGkgPSBieXRlTGVuZ3RoCiAgICB2YXIgbXVsID0gMQogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgLS1pXQogICAgd2hpbGUgKGkgPiAwICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0taV0gKiBtdWwKICAgIH0KICAgIG11bCAqPSAweDgwCiAgCiAgICBpZiAodmFsID49IG11bCkgdmFsIC09IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKQogIAogICAgcmV0dXJuIHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQ4ID0gZnVuY3Rpb24gcmVhZEludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgICBpZiAoISh0aGlzW29mZnNldF0gJiAweDgwKSkgcmV0dXJuICh0aGlzW29mZnNldF0pCiAgICByZXR1cm4gKCgweGZmIC0gdGhpc1tvZmZzZXRdICsgMSkgKiAtMSkKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZMRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogICAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEludDE2QkUgPSBmdW5jdGlvbiByZWFkSW50MTZCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICAgIHZhciB2YWwgPSB0aGlzW29mZnNldCArIDFdIHwgKHRoaXNbb2Zmc2V0XSA8PCA4KQogICAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkxFID0gZnVuY3Rpb24gcmVhZEludDMyTEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSkgfAogICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDNdIDw8IDI0KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkJFID0gZnVuY3Rpb24gcmVhZEludDMyQkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCAyNCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCAxNikgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCA4KSB8CiAgICAgICh0aGlzW29mZnNldCArIDNdKQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdExFID0gZnVuY3Rpb24gcmVhZEZsb2F0TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgMjMsIDQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0QkUgPSBmdW5jdGlvbiByZWFkRmxvYXRCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgMjMsIDQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUucmVhZERvdWJsZUxFID0gZnVuY3Rpb24gcmVhZERvdWJsZUxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDgsIHRoaXMubGVuZ3RoKQogICAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDUyLCA4KQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVCRSA9IGZ1bmN0aW9uIHJlYWREb3VibGVCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA4LCB0aGlzLmxlbmd0aCkKICAgIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgNTIsIDgpCiAgfQogIAogIGZ1bmN0aW9uIGNoZWNrSW50IChidWYsIHZhbHVlLCBvZmZzZXQsIGV4dCwgbWF4LCBtaW4pIHsKICAgIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHRocm93IG5ldyBUeXBlRXJyb3IoJyJidWZmZXIiIGFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIgaW5zdGFuY2UnKQogICAgaWYgKHZhbHVlID4gbWF4IHx8IHZhbHVlIDwgbWluKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignInZhbHVlIiBhcmd1bWVudCBpcyBvdXQgb2YgYm91bmRzJykKICAgIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignSW5kZXggb3V0IG9mIHJhbmdlJykKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlVUludExFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG1heEJ5dGVzLCAwKQogICAgfQogIAogICAgdmFyIG11bCA9IDEKICAgIHZhciBpID0gMAogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoKytpIDwgYnl0ZUxlbmd0aCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgICB0aGlzW29mZnNldCArIGldID0gKHZhbHVlIC8gbXVsKSAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50QkUgPSBmdW5jdGlvbiB3cml0ZVVJbnRCRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIG1heEJ5dGVzID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGgpIC0gMQogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBtYXhCeXRlcywgMCkKICAgIH0KICAKICAgIHZhciBpID0gYnl0ZUxlbmd0aCAtIDEKICAgIHZhciBtdWwgPSAxCiAgICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCkgJiAweEZGCiAgICB9CiAgCiAgICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDggPSBmdW5jdGlvbiB3cml0ZVVJbnQ4ICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4ZmYsIDApCiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpCiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgcmV0dXJuIG9mZnNldCArIDEKICB9CiAgCiAgZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MTYgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZiArIHZhbHVlICsgMQogICAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCAyKTsgaSA8IGo7ICsraSkgewogICAgICBidWZbb2Zmc2V0ICsgaV0gPSAodmFsdWUgJiAoMHhmZiA8PCAoOCAqIChsaXR0bGVFbmRpYW4gPyBpIDogMSAtIGkpKSkpID4+PgogICAgICAgIChsaXR0bGVFbmRpYW4gPyBpIDogMSAtIGkpICogOAogICAgfQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQxNkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4ZmZmZiwgMCkKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZCRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHhmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICB9IGVsc2UgewogICAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyAyCiAgfQogIAogIGZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDMyIChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKGJ1Zi5sZW5ndGggLSBvZmZzZXQsIDQpOyBpIDwgajsgKytpKSB7CiAgICAgIGJ1ZltvZmZzZXQgKyBpXSA9ICh2YWx1ZSA+Pj4gKGxpdHRsZUVuZGlhbiA/IGkgOiAzIC0gaSkgKiA4KSAmIDB4ZmYKICAgIH0KICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkxFID0gZnVuY3Rpb24gd3JpdGVVSW50MzJMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogICAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogICAgICB0aGlzW29mZnNldCArIDJdID0gKHZhbHVlID4+PiAxNikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyQkUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4ZmZmZmZmZmYsIDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50TEUgPSBmdW5jdGlvbiB3cml0ZUludExFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgdmFyIGxpbWl0ID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGggLSAxKQogIAogICAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBsaW1pdCAtIDEsIC1saW1pdCkKICAgIH0KICAKICAgIHZhciBpID0gMAogICAgdmFyIG11bCA9IDEKICAgIHZhciBzdWIgPSAwCiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZSAmIDB4RkYKICAgIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICAgIGlmICh2YWx1ZSA8IDAgJiYgc3ViID09PSAwICYmIHRoaXNbb2Zmc2V0ICsgaSAtIDFdICE9PSAwKSB7CiAgICAgICAgc3ViID0gMQogICAgICB9CiAgICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAoKHZhbHVlIC8gbXVsKSA+PiAwKSAtIHN1YiAmIDB4RkYKICAgIH0KICAKICAgIHJldHVybiBvZmZzZXQgKyBieXRlTGVuZ3RoCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlSW50QkUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgewogICAgICB2YXIgbGltaXQgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCAtIDEpCiAgCiAgICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KQogICAgfQogIAogICAgdmFyIGkgPSBieXRlTGVuZ3RoIC0gMQogICAgdmFyIG11bCA9IDEKICAgIHZhciBzdWIgPSAwCiAgICB0aGlzW29mZnNldCArIGldID0gdmFsdWUgJiAweEZGCiAgICB3aGlsZSAoLS1pID49IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgICAgaWYgKHZhbHVlIDwgMCAmJiBzdWIgPT09IDAgJiYgdGhpc1tvZmZzZXQgKyBpICsgMV0gIT09IDApIHsKICAgICAgICBzdWIgPSAxCiAgICAgIH0KICAgICAgdGhpc1tvZmZzZXQgKyBpXSA9ICgodmFsdWUgLyBtdWwpID4+IDApIC0gc3ViICYgMHhGRgogICAgfQogIAogICAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDggPSBmdW5jdGlvbiB3cml0ZUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMHg3ZiwgLTB4ODApCiAgICBpZiAoIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB2YWx1ZSA9IE1hdGguZmxvb3IodmFsdWUpCiAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmYgKyB2YWx1ZSArIDEKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgICByZXR1cm4gb2Zmc2V0ICsgMQogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlSW50MTZMRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgMgogIH0KICAKICBCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MTZCRSA9IGZ1bmN0aW9uIHdyaXRlSW50MTZCRSAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICAgIHZhbHVlID0gK3ZhbHVlCiAgICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgICBpZiAoIW5vQXNzZXJ0KSBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KQogICAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlICYgMHhmZikKICAgIH0gZWxzZSB7CiAgICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogICAgfQogICAgcmV0dXJuIG9mZnNldCArIDIKICB9CiAgCiAgQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZUludDMyTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICB2YWx1ZSA9ICt2YWx1ZQogICAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogICAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHg3ZmZmZmZmZiwgLTB4ODAwMDAwMDApCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICAgIH0KICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkJFID0gZnVuY3Rpb24gd3JpdGVJbnQzMkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgdmFsdWUgPSArdmFsdWUKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogICAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDgpCiAgICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgJiAweGZmKQogICAgfSBlbHNlIHsKICAgICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgICB9CiAgICByZXR1cm4gb2Zmc2V0ICsgNAogIH0KICAKICBmdW5jdGlvbiBjaGVja0lFRUU3NTQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogICAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogICAgaWYgKG9mZnNldCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQogIH0KICAKICBmdW5jdGlvbiB3cml0ZUZsb2F0IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICAgIGlmICghbm9Bc3NlcnQpIHsKICAgICAgY2hlY2tJRUVFNzU0KGJ1ZiwgdmFsdWUsIG9mZnNldCwgNCwgMy40MDI4MjM0NjYzODUyODg2ZSszOCwgLTMuNDAyODIzNDY2Mzg1Mjg4NmUrMzgpCiAgICB9CiAgICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCAyMywgNCkKICAgIHJldHVybiBvZmZzZXQgKyA0CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVGbG9hdExFID0gZnVuY3Rpb24gd3JpdGVGbG9hdExFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRmxvYXQodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVGbG9hdEJFID0gZnVuY3Rpb24gd3JpdGVGbG9hdEJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogICAgcmV0dXJuIHdyaXRlRmxvYXQodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UsIG5vQXNzZXJ0KQogIH0KICAKICBmdW5jdGlvbiB3cml0ZURvdWJsZSAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIG5vQXNzZXJ0KSB7CiAgICBpZiAoIW5vQXNzZXJ0KSB7CiAgICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDgsIDEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4LCAtMS43OTc2OTMxMzQ4NjIzMTU3RSszMDgpCiAgICB9CiAgICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCA1MiwgOCkKICAgIHJldHVybiBvZmZzZXQgKyA4CiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVMRSA9IGZ1bmN0aW9uIHdyaXRlRG91YmxlTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCiAgfQogIAogIEJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVCRSA9IGZ1bmN0aW9uIHdyaXRlRG91YmxlQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgICByZXR1cm4gd3JpdGVEb3VibGUodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UsIG5vQXNzZXJ0KQogIH0KICAKICAvLyBjb3B5KHRhcmdldEJ1ZmZlciwgdGFyZ2V0U3RhcnQ9MCwgc291cmNlU3RhcnQ9MCwgc291cmNlRW5kPWJ1ZmZlci5sZW5ndGgpCiAgQnVmZmVyLnByb3RvdHlwZS5jb3B5ID0gZnVuY3Rpb24gY29weSAodGFyZ2V0LCB0YXJnZXRTdGFydCwgc3RhcnQsIGVuZCkgewogICAgaWYgKCFzdGFydCkgc3RhcnQgPSAwCiAgICBpZiAoIWVuZCAmJiBlbmQgIT09IDApIGVuZCA9IHRoaXMubGVuZ3RoCiAgICBpZiAodGFyZ2V0U3RhcnQgPj0gdGFyZ2V0Lmxlbmd0aCkgdGFyZ2V0U3RhcnQgPSB0YXJnZXQubGVuZ3RoCiAgICBpZiAoIXRhcmdldFN0YXJ0KSB0YXJnZXRTdGFydCA9IDAKICAgIGlmIChlbmQgPiAwICYmIGVuZCA8IHN0YXJ0KSBlbmQgPSBzdGFydAogIAogICAgLy8gQ29weSAwIGJ5dGVzOyB3ZSdyZSBkb25lCiAgICBpZiAoZW5kID09PSBzdGFydCkgcmV0dXJuIDAKICAgIGlmICh0YXJnZXQubGVuZ3RoID09PSAwIHx8IHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm4gMAogIAogICAgLy8gRmF0YWwgZXJyb3IgY29uZGl0aW9ucwogICAgaWYgKHRhcmdldFN0YXJ0IDwgMCkgewogICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigndGFyZ2V0U3RhcnQgb3V0IG9mIGJvdW5kcycpCiAgICB9CiAgICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHRoaXMubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlU3RhcnQgb3V0IG9mIGJvdW5kcycpCiAgICBpZiAoZW5kIDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3NvdXJjZUVuZCBvdXQgb2YgYm91bmRzJykKICAKICAgIC8vIEFyZSB3ZSBvb2I/CiAgICBpZiAoZW5kID4gdGhpcy5sZW5ndGgpIGVuZCA9IHRoaXMubGVuZ3RoCiAgICBpZiAodGFyZ2V0Lmxlbmd0aCAtIHRhcmdldFN0YXJ0IDwgZW5kIC0gc3RhcnQpIHsKICAgICAgZW5kID0gdGFyZ2V0Lmxlbmd0aCAtIHRhcmdldFN0YXJ0ICsgc3RhcnQKICAgIH0KICAKICAgIHZhciBsZW4gPSBlbmQgLSBzdGFydAogICAgdmFyIGkKICAKICAgIGlmICh0aGlzID09PSB0YXJnZXQgJiYgc3RhcnQgPCB0YXJnZXRTdGFydCAmJiB0YXJnZXRTdGFydCA8IGVuZCkgewogICAgICAvLyBkZXNjZW5kaW5nIGNvcHkgZnJvbSBlbmQKICAgICAgZm9yIChpID0gbGVuIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICB0YXJnZXRbaSArIHRhcmdldFN0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgICB9CiAgICB9IGVsc2UgaWYgKGxlbiA8IDEwMDAgfHwgIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAgIC8vIGFzY2VuZGluZyBjb3B5IGZyb20gc3RhcnQKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdGFyZ2V0W2kgKyB0YXJnZXRTdGFydF0gPSB0aGlzW2kgKyBzdGFydF0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgVWludDhBcnJheS5wcm90b3R5cGUuc2V0LmNhbGwoCiAgICAgICAgdGFyZ2V0LAogICAgICAgIHRoaXMuc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ICsgbGVuKSwKICAgICAgICB0YXJnZXRTdGFydAogICAgICApCiAgICB9CiAgCiAgICByZXR1cm4gbGVuCiAgfQogIAogIC8vIFVzYWdlOgogIC8vICAgIGJ1ZmZlci5maWxsKG51bWJlclssIG9mZnNldFssIGVuZF1dKQogIC8vICAgIGJ1ZmZlci5maWxsKGJ1ZmZlclssIG9mZnNldFssIGVuZF1dKQogIC8vICAgIGJ1ZmZlci5maWxsKHN0cmluZ1ssIG9mZnNldFssIGVuZF1dWywgZW5jb2RpbmddKQogIEJ1ZmZlci5wcm90b3R5cGUuZmlsbCA9IGZ1bmN0aW9uIGZpbGwgKHZhbCwgc3RhcnQsIGVuZCwgZW5jb2RpbmcpIHsKICAgIC8vIEhhbmRsZSBzdHJpbmcgY2FzZXM6CiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBlbmNvZGluZyA9IHN0YXJ0CiAgICAgICAgc3RhcnQgPSAwCiAgICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZW5kID09PSAnc3RyaW5nJykgewogICAgICAgIGVuY29kaW5nID0gZW5kCiAgICAgICAgZW5kID0gdGhpcy5sZW5ndGgKICAgICAgfQogICAgICBpZiAodmFsLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHZhciBjb2RlID0gdmFsLmNoYXJDb2RlQXQoMCkKICAgICAgICBpZiAoY29kZSA8IDI1NikgewogICAgICAgICAgdmFsID0gY29kZQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgZW5jb2RpbmcgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZycpCiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycgJiYgIUJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgICB2YWwgPSB2YWwgJiAyNTUKICAgIH0KICAKICAgIC8vIEludmFsaWQgcmFuZ2VzIGFyZSBub3Qgc2V0IHRvIGEgZGVmYXVsdCwgc28gY2FuIHJhbmdlIGNoZWNrIGVhcmx5LgogICAgaWYgKHN0YXJ0IDwgMCB8fCB0aGlzLmxlbmd0aCA8IHN0YXJ0IHx8IHRoaXMubGVuZ3RoIDwgZW5kKSB7CiAgICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdPdXQgb2YgcmFuZ2UgaW5kZXgnKQogICAgfQogIAogICAgaWYgKGVuZCA8PSBzdGFydCkgewogICAgICByZXR1cm4gdGhpcwogICAgfQogIAogICAgc3RhcnQgPSBzdGFydCA+Pj4gMAogICAgZW5kID0gZW5kID09PSB1bmRlZmluZWQgPyB0aGlzLmxlbmd0aCA6IGVuZCA+Pj4gMAogIAogICAgaWYgKCF2YWwpIHZhbCA9IDAKICAKICAgIHZhciBpCiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQ7ICsraSkgewogICAgICAgIHRoaXNbaV0gPSB2YWwKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGJ5dGVzID0gQnVmZmVyLmlzQnVmZmVyKHZhbCkKICAgICAgICA/IHZhbAogICAgICAgIDogdXRmOFRvQnl0ZXMobmV3IEJ1ZmZlcih2YWwsIGVuY29kaW5nKS50b1N0cmluZygpKQogICAgICB2YXIgbGVuID0gYnl0ZXMubGVuZ3RoCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbmQgLSBzdGFydDsgKytpKSB7CiAgICAgICAgdGhpc1tpICsgc3RhcnRdID0gYnl0ZXNbaSAlIGxlbl0KICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIHRoaXMKICB9CiAgCiAgLy8gSEVMUEVSIEZVTkNUSU9OUwogIC8vID09PT09PT09PT09PT09PT0KICAKICB2YXIgSU5WQUxJRF9CQVNFNjRfUkUgPSAvW14rXC8wLTlBLVphLXotX10vZwogIAogIGZ1bmN0aW9uIGJhc2U2NGNsZWFuIChzdHIpIHsKICAgIC8vIE5vZGUgc3RyaXBzIG91dCBpbnZhbGlkIGNoYXJhY3RlcnMgbGlrZSBcbiBhbmQgXHQgZnJvbSB0aGUgc3RyaW5nLCBiYXNlNjQtanMgZG9lcyBub3QKICAgIHN0ciA9IHN0cmluZ3RyaW0oc3RyKS5yZXBsYWNlKElOVkFMSURfQkFTRTY0X1JFLCAnJykKICAgIC8vIE5vZGUgY29udmVydHMgc3RyaW5ncyB3aXRoIGxlbmd0aCA8IDIgdG8gJycKICAgIGlmIChzdHIubGVuZ3RoIDwgMikgcmV0dXJuICcnCiAgICAvLyBOb2RlIGFsbG93cyBmb3Igbm9uLXBhZGRlZCBiYXNlNjQgc3RyaW5ncyAobWlzc2luZyB0cmFpbGluZyA9PT0pLCBiYXNlNjQtanMgZG9lcyBub3QKICAgIHdoaWxlIChzdHIubGVuZ3RoICUgNCAhPT0gMCkgewogICAgICBzdHIgPSBzdHIgKyAnPScKICAgIH0KICAgIHJldHVybiBzdHIKICB9CiAgCiAgZnVuY3Rpb24gc3RyaW5ndHJpbSAoc3RyKSB7CiAgICBpZiAoc3RyLnRyaW0pIHJldHVybiBzdHIudHJpbSgpCiAgICByZXR1cm4gc3RyLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykKICB9CiAgCiAgZnVuY3Rpb24gdG9IZXggKG4pIHsKICAgIGlmIChuIDwgMTYpIHJldHVybiAnMCcgKyBuLnRvU3RyaW5nKDE2KQogICAgcmV0dXJuIG4udG9TdHJpbmcoMTYpCiAgfQogIAogIGZ1bmN0aW9uIHV0ZjhUb0J5dGVzIChzdHJpbmcsIHVuaXRzKSB7CiAgICB1bml0cyA9IHVuaXRzIHx8IEluZmluaXR5CiAgICB2YXIgY29kZVBvaW50CiAgICB2YXIgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aAogICAgdmFyIGxlYWRTdXJyb2dhdGUgPSBudWxsCiAgICB2YXIgYnl0ZXMgPSBbXQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBjb2RlUG9pbnQgPSBzdHJpbmcuY2hhckNvZGVBdChpKQogIAogICAgICAvLyBpcyBzdXJyb2dhdGUgY29tcG9uZW50CiAgICAgIGlmIChjb2RlUG9pbnQgPiAweEQ3RkYgJiYgY29kZVBvaW50IDwgMHhFMDAwKSB7CiAgICAgICAgLy8gbGFzdCBjaGFyIHdhcyBhIGxlYWQKICAgICAgICBpZiAoIWxlYWRTdXJyb2dhdGUpIHsKICAgICAgICAgIC8vIG5vIGxlYWQgeWV0CiAgICAgICAgICBpZiAoY29kZVBvaW50ID4gMHhEQkZGKSB7CiAgICAgICAgICAgIC8vIHVuZXhwZWN0ZWQgdHJhaWwKICAgICAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICB9IGVsc2UgaWYgKGkgKyAxID09PSBsZW5ndGgpIHsKICAgICAgICAgICAgLy8gdW5wYWlyZWQgbGVhZAogICAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIH0KICAKICAgICAgICAgIC8vIHZhbGlkIGxlYWQKICAgICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQKICAKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogIAogICAgICAgIC8vIDIgbGVhZHMgaW4gYSByb3cKICAgICAgICBpZiAoY29kZVBvaW50IDwgMHhEQzAwKSB7CiAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgIGxlYWRTdXJyb2dhdGUgPSBjb2RlUG9pbnQKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQogIAogICAgICAgIC8vIHZhbGlkIHN1cnJvZ2F0ZSBwYWlyCiAgICAgICAgY29kZVBvaW50ID0gKGxlYWRTdXJyb2dhdGUgLSAweEQ4MDAgPDwgMTAgfCBjb2RlUG9pbnQgLSAweERDMDApICsgMHgxMDAwMAogICAgICB9IGVsc2UgaWYgKGxlYWRTdXJyb2dhdGUpIHsKICAgICAgICAvLyB2YWxpZCBibXAgY2hhciwgYnV0IGxhc3QgY2hhciB3YXMgYSBsZWFkCiAgICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICAgIH0KICAKICAgICAgbGVhZFN1cnJvZ2F0ZSA9IG51bGwKICAKICAgICAgLy8gZW5jb2RlIHV0ZjgKICAgICAgaWYgKGNvZGVQb2ludCA8IDB4ODApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDEpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKGNvZGVQb2ludCkKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDgwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gMikgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHg2IHwgMHhDMCwKICAgICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICAgKQogICAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTAwMDApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDMpIDwgMCkgYnJlYWsKICAgICAgICBieXRlcy5wdXNoKAogICAgICAgICAgY29kZVBvaW50ID4+IDB4QyB8IDB4RTAsCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHg2ICYgMHgzRiB8IDB4ODAsCiAgICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICAgICkKICAgICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDExMDAwMCkgewogICAgICAgIGlmICgodW5pdHMgLT0gNCkgPCAwKSBicmVhawogICAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHgxMiB8IDB4RjAsCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHhDICYgMHgzRiB8IDB4ODAsCiAgICAgICAgICBjb2RlUG9pbnQgPj4gMHg2ICYgMHgzRiB8IDB4ODAsCiAgICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICAgICkKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY29kZSBwb2ludCcpCiAgICAgIH0KICAgIH0KICAKICAgIHJldHVybiBieXRlcwogIH0KICAKICBmdW5jdGlvbiBhc2NpaVRvQnl0ZXMgKHN0cikgewogICAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICAvLyBOb2RlJ3MgY29kZSBzZWVtcyB0byBiZSBkb2luZyB0aGlzIGFuZCBub3QgJiAweDdGLi4KICAgICAgYnl0ZUFycmF5LnB1c2goc3RyLmNoYXJDb2RlQXQoaSkgJiAweEZGKQogICAgfQogICAgcmV0dXJuIGJ5dGVBcnJheQogIH0KICAKICBmdW5jdGlvbiB1dGYxNmxlVG9CeXRlcyAoc3RyLCB1bml0cykgewogICAgdmFyIGMsIGhpLCBsbwogICAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7ICsraSkgewogICAgICBpZiAoKHVuaXRzIC09IDIpIDwgMCkgYnJlYWsKICAKICAgICAgYyA9IHN0ci5jaGFyQ29kZUF0KGkpCiAgICAgIGhpID0gYyA+PiA4CiAgICAgIGxvID0gYyAlIDI1NgogICAgICBieXRlQXJyYXkucHVzaChsbykKICAgICAgYnl0ZUFycmF5LnB1c2goaGkpCiAgICB9CiAgCiAgICByZXR1cm4gYnl0ZUFycmF5CiAgfQogIAogIGZ1bmN0aW9uIGJhc2U2NFRvQnl0ZXMgKHN0cikgewogICAgcmV0dXJuIGJhc2U2NC50b0J5dGVBcnJheShiYXNlNjRjbGVhbihzdHIpKQogIH0KICAKICBmdW5jdGlvbiBibGl0QnVmZmVyIChzcmMsIGRzdCwgb2Zmc2V0LCBsZW5ndGgpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKChpICsgb2Zmc2V0ID49IGRzdC5sZW5ndGgpIHx8IChpID49IHNyYy5sZW5ndGgpKSBicmVhawogICAgICBkc3RbaSArIG9mZnNldF0gPSBzcmNbaV0KICAgIH0KICAgIHJldHVybiBpCiAgfQogIAogIGZ1bmN0aW9uIGlzbmFuICh2YWwpIHsKICAgIHJldHVybiB2YWwgIT09IHZhbCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXNlbGYtY29tcGFyZQogIH0KICAKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHR5cGVvZiBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgIT09ICJ1bmRlZmluZWQiID8gX193ZWJwYWNrX3JlcXVpcmVfXy5nIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30scmVxdWlyZSgiYnVmZmVyIikuQnVmZmVyKQogIH0seyJiYXNlNjQtanMiOjc4LCJidWZmZXIiOjgxLCJpZWVlNzU0Ijo4MywiaXNhcnJheSI6ODR9XSw4MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewogICAgdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwogICAgdGhpcy5fbWF4TGlzdGVuZXJzID0gdGhpcy5fbWF4TGlzdGVuZXJzIHx8IHVuZGVmaW5lZDsKICB9CiAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7CiAgCiAgLy8gQmFja3dhcmRzLWNvbXBhdCB3aXRoIG5vZGUgMC4xMC54CiAgRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9ldmVudHMgPSB1bmRlZmluZWQ7CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdW5kZWZpbmVkOwogIAogIC8vIEJ5IGRlZmF1bHQgRXZlbnRFbWl0dGVycyB3aWxsIHByaW50IGEgd2FybmluZyBpZiBtb3JlIHRoYW4gMTAgbGlzdGVuZXJzIGFyZQogIC8vIGFkZGVkIHRvIGl0LiBUaGlzIGlzIGEgdXNlZnVsIGRlZmF1bHQgd2hpY2ggaGVscHMgZmluZGluZyBtZW1vcnkgbGVha3MuCiAgRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnMgPSAxMDsKICAKICAvLyBPYnZpb3VzbHkgbm90IGFsbCBFbWl0dGVycyBzaG91bGQgYmUgbGltaXRlZCB0byAxMC4gVGhpcyBmdW5jdGlvbiBhbGxvd3MKICAvLyB0aGF0IHRvIGJlIGluY3JlYXNlZC4gU2V0IHRvIHplcm8gZm9yIHVubGltaXRlZC4KICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uKG4pIHsKICAgIGlmICghaXNOdW1iZXIobikgfHwgbiA8IDAgfHwgaXNOYU4obikpCiAgICAgIHRocm93IFR5cGVFcnJvcignbiBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyJyk7CiAgICB0aGlzLl9tYXhMaXN0ZW5lcnMgPSBuOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbih0eXBlKSB7CiAgICB2YXIgZXIsIGhhbmRsZXIsIGxlbiwgYXJncywgaSwgbGlzdGVuZXJzOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogIAogICAgLy8gSWYgdGhlcmUgaXMgbm8gJ2Vycm9yJyBldmVudCBsaXN0ZW5lciB0aGVuIHRocm93LgogICAgaWYgKHR5cGUgPT09ICdlcnJvcicpIHsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMuZXJyb3IgfHwKICAgICAgICAgIChpc09iamVjdCh0aGlzLl9ldmVudHMuZXJyb3IpICYmICF0aGlzLl9ldmVudHMuZXJyb3IubGVuZ3RoKSkgewogICAgICAgIGVyID0gYXJndW1lbnRzWzFdOwogICAgICAgIGlmIChlciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcjsgLy8gVW5oYW5kbGVkICdlcnJvcicgZXZlbnQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gQXQgbGVhc3QgZ2l2ZSBzb21lIGtpbmQgb2YgY29udGV4dCB0byB0aGUgdXNlcgogICAgICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcignVW5jYXVnaHQsIHVuc3BlY2lmaWVkICJlcnJvciIgZXZlbnQuICgnICsgZXIgKyAnKScpOwogICAgICAgICAgZXJyLmNvbnRleHQgPSBlcjsKICAgICAgICAgIHRocm93IGVycjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAKICAgIGhhbmRsZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgCiAgICBpZiAoaXNVbmRlZmluZWQoaGFuZGxlcikpCiAgICAgIHJldHVybiBmYWxzZTsKICAKICAgIGlmIChpc0Z1bmN0aW9uKGhhbmRsZXIpKSB7CiAgICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIC8vIGZhc3QgY2FzZXMKICAgICAgICBjYXNlIDE6CiAgICAgICAgICBoYW5kbGVyLmNhbGwodGhpcyk7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMzoKICAgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICAvLyBzbG93ZXIKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGhhbmRsZXIpKSB7CiAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBsaXN0ZW5lcnMgPSBoYW5kbGVyLnNsaWNlKCk7CiAgICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykKICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkodGhpcywgYXJncyk7CiAgICB9CiAgCiAgICByZXR1cm4gdHJ1ZTsKICB9OwogIAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgdmFyIG07CiAgCiAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogIAogICAgLy8gVG8gYXZvaWQgcmVjdXJzaW9uIGluIHRoZSBjYXNlIHRoYXQgdHlwZSA9PT0gIm5ld0xpc3RlbmVyIiEgQmVmb3JlCiAgICAvLyBhZGRpbmcgaXQgdG8gdGhlIGxpc3RlbmVycywgZmlyc3QgZW1pdCAibmV3TGlzdGVuZXIiLgogICAgaWYgKHRoaXMuX2V2ZW50cy5uZXdMaXN0ZW5lcikKICAgICAgdGhpcy5lbWl0KCduZXdMaXN0ZW5lcicsIHR5cGUsCiAgICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGxpc3RlbmVyLmxpc3RlbmVyKSA/CiAgICAgICAgICAgICAgICBsaXN0ZW5lci5saXN0ZW5lciA6IGxpc3RlbmVyKTsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICAvLyBPcHRpbWl6ZSB0aGUgY2FzZSBvZiBvbmUgbGlzdGVuZXIuIERvbid0IG5lZWQgdGhlIGV4dHJhIGFycmF5IG9iamVjdC4KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gbGlzdGVuZXI7CiAgICBlbHNlIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgICAvLyBJZiB3ZSd2ZSBhbHJlYWR5IGdvdCBhbiBhcnJheSwganVzdCBhcHBlbmQuCiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKICAgIGVsc2UKICAgICAgLy8gQWRkaW5nIHRoZSBzZWNvbmQgZWxlbWVudCwgbmVlZCB0byBjaGFuZ2UgdG8gYXJyYXkuCiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IFt0aGlzLl9ldmVudHNbdHlwZV0sIGxpc3RlbmVyXTsKICAKICAgIC8vIENoZWNrIGZvciBsaXN0ZW5lciBsZWFrCiAgICBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSAmJiAhdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCkgewogICAgICBpZiAoIWlzVW5kZWZpbmVkKHRoaXMuX21heExpc3RlbmVycykpIHsKICAgICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOwogICAgICB9IGVsc2UgewogICAgICAgIG0gPSBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVyczsKICAgICAgfQogIAogICAgICBpZiAobSAmJiBtID4gMCAmJiB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoID4gbSkgewogICAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQgPSB0cnVlOwogICAgICAgIGNvbnNvbGUuZXJyb3IoJyhub2RlKSB3YXJuaW5nOiBwb3NzaWJsZSBFdmVudEVtaXR0ZXIgbWVtb3J5ICcgKwogICAgICAgICAgICAgICAgICAgICAgJ2xlYWsgZGV0ZWN0ZWQuICVkIGxpc3RlbmVycyBhZGRlZC4gJyArCiAgICAgICAgICAgICAgICAgICAgICAnVXNlIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzKCkgdG8gaW5jcmVhc2UgbGltaXQuJywKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGgpOwogICAgICAgIGlmICh0eXBlb2YgY29uc29sZS50cmFjZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgLy8gbm90IHN1cHBvcnRlZCBpbiBJRSAxMAogICAgICAgICAgY29uc29sZS50cmFjZSgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAKICAgIHZhciBmaXJlZCA9IGZhbHNlOwogIAogICAgZnVuY3Rpb24gZygpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsKICAKICAgICAgaWYgKCFmaXJlZCkgewogICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICBsaXN0ZW5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9CiAgCiAgICBnLmxpc3RlbmVyID0gbGlzdGVuZXI7CiAgICB0aGlzLm9uKHR5cGUsIGcpOwogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICAvLyBlbWl0cyBhICdyZW1vdmVMaXN0ZW5lcicgZXZlbnQgaWZmIHRoZSBsaXN0ZW5lciB3YXMgcmVtb3ZlZAogIEV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogICAgdmFyIGxpc3QsIHBvc2l0aW9uLCBsZW5ndGgsIGk7CiAgCiAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwogIAogICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgcmV0dXJuIHRoaXM7CiAgCiAgICBsaXN0ID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgbGVuZ3RoID0gbGlzdC5sZW5ndGg7CiAgICBwb3NpdGlvbiA9IC0xOwogIAogICAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8CiAgICAgICAgKGlzRnVuY3Rpb24obGlzdC5saXN0ZW5lcikgJiYgbGlzdC5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCiAgICAgICAgdGhpcy5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIHR5cGUsIGxpc3RlbmVyKTsKICAKICAgIH0gZWxzZSBpZiAoaXNPYmplY3QobGlzdCkpIHsKICAgICAgZm9yIChpID0gbGVuZ3RoOyBpLS0gPiAwOykgewogICAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fAogICAgICAgICAgICAobGlzdFtpXS5saXN0ZW5lciAmJiBsaXN0W2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogIAogICAgICBpZiAocG9zaXRpb24gPCAwKQogICAgICAgIHJldHVybiB0aGlzOwogIAogICAgICBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKICAgICAgICBsaXN0Lmxlbmd0aCA9IDA7CiAgICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsaXN0LnNwbGljZShwb3NpdGlvbiwgMSk7CiAgICAgIH0KICAKICAgICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikKICAgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogICAgfQogIAogICAgcmV0dXJuIHRoaXM7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICAgIHZhciBrZXksIGxpc3RlbmVyczsKICAKICAgIGlmICghdGhpcy5fZXZlbnRzKQogICAgICByZXR1cm4gdGhpczsKICAKICAgIC8vIG5vdCBsaXN0ZW5pbmcgZm9yIHJlbW92ZUxpc3RlbmVyLCBubyBuZWVkIHRvIGVtaXQKICAgIGlmICghdGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICBlbHNlIGlmICh0aGlzLl9ldmVudHNbdHlwZV0pCiAgICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgCiAgICAvLyBlbWl0IHJlbW92ZUxpc3RlbmVyIGZvciBhbGwgbGlzdGVuZXJzIG9uIGFsbCBldmVudHMKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgIGZvciAoa2V5IGluIHRoaXMuX2V2ZW50cykgewogICAgICAgIGlmIChrZXkgPT09ICdyZW1vdmVMaXN0ZW5lcicpIGNvbnRpbnVlOwogICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CiAgICAgIH0KICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3JlbW92ZUxpc3RlbmVyJyk7CiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAKICAgIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgIGlmIChpc0Z1bmN0aW9uKGxpc3RlbmVycykpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnMpOwogICAgfSBlbHNlIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgLy8gTElGTyBvcmRlcgogICAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCkKICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVyc1tsaXN0ZW5lcnMubGVuZ3RoIC0gMV0pOwogICAgfQogICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAKICAgIHJldHVybiB0aGlzOwogIH07CiAgCiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgICB2YXIgcmV0OwogICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgcmV0ID0gW107CiAgICBlbHNlIGlmIChpc0Z1bmN0aW9uKHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOwogICAgZWxzZQogICAgICByZXQgPSB0aGlzLl9ldmVudHNbdHlwZV0uc2xpY2UoKTsKICAgIHJldHVybiByZXQ7CiAgfTsKICAKICBFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbih0eXBlKSB7CiAgICBpZiAodGhpcy5fZXZlbnRzKSB7CiAgICAgIHZhciBldmxpc3RlbmVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIAogICAgICBpZiAoaXNGdW5jdGlvbihldmxpc3RlbmVyKSkKICAgICAgICByZXR1cm4gMTsKICAgICAgZWxzZSBpZiAoZXZsaXN0ZW5lcikKICAgICAgICByZXR1cm4gZXZsaXN0ZW5lci5sZW5ndGg7CiAgICB9CiAgICByZXR1cm4gMDsKICB9OwogIAogIEV2ZW50RW1pdHRlci5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSkgewogICAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJDb3VudCh0eXBlKTsKICB9OwogIAogIGZ1bmN0aW9uIGlzRnVuY3Rpb24oYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKICB9CiAgCiAgZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7CiAgfQogIAogIGZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKICB9CiAgCiAgZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSB2b2lkIDA7CiAgfQogIAogIH0se31dLDgzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICBleHBvcnRzLnJlYWQgPSBmdW5jdGlvbiAoYnVmZmVyLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogICAgdmFyIGUsIG0KICAgIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDEKICAgIHZhciBlTWF4ID0gKDEgPDwgZUxlbikgLSAxCiAgICB2YXIgZUJpYXMgPSBlTWF4ID4+IDEKICAgIHZhciBuQml0cyA9IC03CiAgICB2YXIgaSA9IGlzTEUgPyAobkJ5dGVzIC0gMSkgOiAwCiAgICB2YXIgZCA9IGlzTEUgPyAtMSA6IDEKICAgIHZhciBzID0gYnVmZmVyW29mZnNldCArIGldCiAgCiAgICBpICs9IGQKICAKICAgIGUgPSBzICYgKCgxIDw8ICgtbkJpdHMpKSAtIDEpCiAgICBzID4+PSAoLW5CaXRzKQogICAgbkJpdHMgKz0gZUxlbgogICAgZm9yICg7IG5CaXRzID4gMDsgZSA9IChlICogMjU2KSArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KSB7fQogIAogICAgbSA9IGUgJiAoKDEgPDwgKC1uQml0cykpIC0gMSkKICAgIGUgPj49ICgtbkJpdHMpCiAgICBuQml0cyArPSBtTGVuCiAgICBmb3IgKDsgbkJpdHMgPiAwOyBtID0gKG0gKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CiAgCiAgICBpZiAoZSA9PT0gMCkgewogICAgICBlID0gMSAtIGVCaWFzCiAgICB9IGVsc2UgaWYgKGUgPT09IGVNYXgpIHsKICAgICAgcmV0dXJuIG0gPyBOYU4gOiAoKHMgPyAtMSA6IDEpICogSW5maW5pdHkpCiAgICB9IGVsc2UgewogICAgICBtID0gbSArIE1hdGgucG93KDIsIG1MZW4pCiAgICAgIGUgPSBlIC0gZUJpYXMKICAgIH0KICAgIHJldHVybiAocyA/IC0xIDogMSkgKiBtICogTWF0aC5wb3coMiwgZSAtIG1MZW4pCiAgfQogIAogIGV4cG9ydHMud3JpdGUgPSBmdW5jdGlvbiAoYnVmZmVyLCB2YWx1ZSwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICAgIHZhciBlLCBtLCBjCiAgICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxCiAgICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMQogICAgdmFyIGVCaWFzID0gZU1heCA+PiAxCiAgICB2YXIgcnQgPSAobUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDApCiAgICB2YXIgaSA9IGlzTEUgPyAwIDogKG5CeXRlcyAtIDEpCiAgICB2YXIgZCA9IGlzTEUgPyAxIDogLTEKICAgIHZhciBzID0gdmFsdWUgPCAwIHx8ICh2YWx1ZSA9PT0gMCAmJiAxIC8gdmFsdWUgPCAwKSA/IDEgOiAwCiAgCiAgICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKQogIAogICAgaWYgKGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA9PT0gSW5maW5pdHkpIHsKICAgICAgbSA9IGlzTmFOKHZhbHVlKSA/IDEgOiAwCiAgICAgIGUgPSBlTWF4CiAgICB9IGVsc2UgewogICAgICBlID0gTWF0aC5mbG9vcihNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMikKICAgICAgaWYgKHZhbHVlICogKGMgPSBNYXRoLnBvdygyLCAtZSkpIDwgMSkgewogICAgICAgIGUtLQogICAgICAgIGMgKj0gMgogICAgICB9CiAgICAgIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICAgIHZhbHVlICs9IHJ0IC8gYwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlICs9IHJ0ICogTWF0aC5wb3coMiwgMSAtIGVCaWFzKQogICAgICB9CiAgICAgIGlmICh2YWx1ZSAqIGMgPj0gMikgewogICAgICAgIGUrKwogICAgICAgIGMgLz0gMgogICAgICB9CiAgCiAgICAgIGlmIChlICsgZUJpYXMgPj0gZU1heCkgewogICAgICAgIG0gPSAwCiAgICAgICAgZSA9IGVNYXgKICAgICAgfSBlbHNlIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICAgIG0gPSAoKHZhbHVlICogYykgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pCiAgICAgICAgZSA9IGUgKyBlQmlhcwogICAgICB9IGVsc2UgewogICAgICAgIG0gPSB2YWx1ZSAqIE1hdGgucG93KDIsIGVCaWFzIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKQogICAgICAgIGUgPSAwCiAgICAgIH0KICAgIH0KICAKICAgIGZvciAoOyBtTGVuID49IDg7IGJ1ZmZlcltvZmZzZXQgKyBpXSA9IG0gJiAweGZmLCBpICs9IGQsIG0gLz0gMjU2LCBtTGVuIC09IDgpIHt9CiAgCiAgICBlID0gKGUgPDwgbUxlbikgfCBtCiAgICBlTGVuICs9IG1MZW4KICAgIGZvciAoOyBlTGVuID4gMDsgYnVmZmVyW29mZnNldCArIGldID0gZSAmIDB4ZmYsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCkge30KICAKICAgIGJ1ZmZlcltvZmZzZXQgKyBpIC0gZF0gfD0gcyAqIDEyOAogIH0KICAKICB9LHt9XSw4NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgdmFyIHRvU3RyaW5nID0ge30udG9TdHJpbmc7CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChhcnIpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKGFycikgPT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIAogIH0se31dLDg1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAoZnVuY3Rpb24oZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogIAogICAgZnVuY3Rpb24gaXNBcnJheShvYmopIHsKICAgICAgaWYgKG9iaiAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgQXJyYXldIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIGlzT2JqZWN0KG9iaikgewogICAgICBpZiAob2JqICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBPYmplY3RdIjsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAKICAgIGZ1bmN0aW9uIHN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKSB7CiAgICAgIC8vIENoZWNrIHRoZSBzY2FsYXIgY2FzZSBmaXJzdC4KICAgICAgaWYgKGZpcnN0ID09PSBzZWNvbmQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogIAogICAgICAvLyBDaGVjayBpZiB0aGV5IGFyZSB0aGUgc2FtZSB0eXBlLgogICAgICB2YXIgZmlyc3RUeXBlID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZpcnN0KTsKICAgICAgaWYgKGZpcnN0VHlwZSAhPT0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHNlY29uZCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gV2Uga25vdyB0aGF0IGZpcnN0IGFuZCBzZWNvbmQgaGF2ZSB0aGUgc2FtZSB0eXBlIHNvIHdlIGNhbiBqdXN0IGNoZWNrIHRoZQogICAgICAvLyBmaXJzdCB0eXBlIGZyb20gbm93IG9uLgogICAgICBpZiAoaXNBcnJheShmaXJzdCkgPT09IHRydWUpIHsKICAgICAgICAvLyBTaG9ydCBjaXJjdWl0IGlmIHRoZXkncmUgbm90IHRoZSBzYW1lIGxlbmd0aDsKICAgICAgICBpZiAoZmlyc3QubGVuZ3RoICE9PSBzZWNvbmQubGVuZ3RoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZmlyc3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChzdHJpY3REZWVwRXF1YWwoZmlyc3RbaV0sIHNlY29uZFtpXSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzT2JqZWN0KGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgIC8vIEFuIG9iamVjdCBpcyBlcXVhbCBpZiBpdCBoYXMgdGhlIHNhbWUga2V5L3ZhbHVlIHBhaXJzLgogICAgICAgIHZhciBrZXlzU2VlbiA9IHt9OwogICAgICAgIGZvciAodmFyIGtleSBpbiBmaXJzdCkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoZmlyc3QsIGtleSkpIHsKICAgICAgICAgICAgaWYgKHN0cmljdERlZXBFcXVhbChmaXJzdFtrZXldLCBzZWNvbmRba2V5XSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGtleXNTZWVuW2tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBOb3cgY2hlY2sgdGhhdCB0aGVyZSBhcmVuJ3QgYW55IGtleXMgaW4gc2Vjb25kIHRoYXQgd2VyZW4ndAogICAgICAgIC8vIGluIGZpcnN0LgogICAgICAgIGZvciAodmFyIGtleTIgaW4gc2Vjb25kKSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzZWNvbmQsIGtleTIpKSB7CiAgICAgICAgICAgIGlmIChrZXlzU2VlbltrZXkyXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBpc0ZhbHNlKG9iaikgewogICAgICAvLyBGcm9tIHRoZSBzcGVjOgogICAgICAvLyBBIGZhbHNlIHZhbHVlIGNvcnJlc3BvbmRzIHRvIHRoZSBmb2xsb3dpbmcgdmFsdWVzOgogICAgICAvLyBFbXB0eSBsaXN0CiAgICAgIC8vIEVtcHR5IG9iamVjdAogICAgICAvLyBFbXB0eSBzdHJpbmcKICAgICAgLy8gRmFsc2UgYm9vbGVhbgogICAgICAvLyBudWxsIHZhbHVlCiAgCiAgICAgIC8vIEZpcnN0IGNoZWNrIHRoZSBzY2FsYXIgdmFsdWVzLgogICAgICBpZiAob2JqID09PSAiIiB8fCBvYmogPT09IGZhbHNlIHx8IG9iaiA9PT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvYmopICYmIG9iai5sZW5ndGggPT09IDApIHsKICAgICAgICAgIC8vIENoZWNrIGZvciBhbiBlbXB0eSBhcnJheS4KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgICAgICAgIC8vIENoZWNrIGZvciBhbiBlbXB0eSBvYmplY3QuCiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIGFueSBrZXlzLCB0aGVuCiAgICAgICAgICAgICAgLy8gdGhlIG9iamVjdCBpcyBub3QgZW1wdHkgc28gdGhlIG9iamVjdAogICAgICAgICAgICAgIC8vIGlzIG5vdCBmYWxzZS4KICAgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gb2JqVmFsdWVzKG9iaikgewogICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFsdWVzLnB1c2gob2JqW2tleXNbaV1dKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWVzOwogICAgfQogIAogICAgZnVuY3Rpb24gbWVyZ2UoYSwgYikgewogICAgICAgIHZhciBtZXJnZWQgPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgICAgICBtZXJnZWRba2V5XSA9IGFba2V5XTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIga2V5MiBpbiBiKSB7CiAgICAgICAgICAgIG1lcmdlZFtrZXkyXSA9IGJba2V5Ml07CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICB9CiAgCiAgICB2YXIgdHJpbUxlZnQ7CiAgICBpZiAodHlwZW9mIFN0cmluZy5wcm90b3R5cGUudHJpbUxlZnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdHJpbUxlZnQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLnRyaW1MZWZ0KCk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICB0cmltTGVmdCA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBzdHIubWF0Y2goL15ccyooLiopLylbMV07CiAgICAgIH07CiAgICB9CiAgCiAgICAvLyBUeXBlIGNvbnN0YW50cyB1c2VkIHRvIGRlZmluZSBmdW5jdGlvbnMuCiAgICB2YXIgVFlQRV9OVU1CRVIgPSAwOwogICAgdmFyIFRZUEVfQU5ZID0gMTsKICAgIHZhciBUWVBFX1NUUklORyA9IDI7CiAgICB2YXIgVFlQRV9BUlJBWSA9IDM7CiAgICB2YXIgVFlQRV9PQkpFQ1QgPSA0OwogICAgdmFyIFRZUEVfQk9PTEVBTiA9IDU7CiAgICB2YXIgVFlQRV9FWFBSRUYgPSA2OwogICAgdmFyIFRZUEVfTlVMTCA9IDc7CiAgICB2YXIgVFlQRV9BUlJBWV9OVU1CRVIgPSA4OwogICAgdmFyIFRZUEVfQVJSQVlfU1RSSU5HID0gOTsKICAKICAgIHZhciBUT0tfRU9GID0gIkVPRiI7CiAgICB2YXIgVE9LX1VOUVVPVEVESURFTlRJRklFUiA9ICJVbnF1b3RlZElkZW50aWZpZXIiOwogICAgdmFyIFRPS19RVU9URURJREVOVElGSUVSID0gIlF1b3RlZElkZW50aWZpZXIiOwogICAgdmFyIFRPS19SQlJBQ0tFVCA9ICJSYnJhY2tldCI7CiAgICB2YXIgVE9LX1JQQVJFTiA9ICJScGFyZW4iOwogICAgdmFyIFRPS19DT01NQSA9ICJDb21tYSI7CiAgICB2YXIgVE9LX0NPTE9OID0gIkNvbG9uIjsKICAgIHZhciBUT0tfUkJSQUNFID0gIlJicmFjZSI7CiAgICB2YXIgVE9LX05VTUJFUiA9ICJOdW1iZXIiOwogICAgdmFyIFRPS19DVVJSRU5UID0gIkN1cnJlbnQiOwogICAgdmFyIFRPS19FWFBSRUYgPSAiRXhwcmVmIjsKICAgIHZhciBUT0tfUElQRSA9ICJQaXBlIjsKICAgIHZhciBUT0tfT1IgPSAiT3IiOwogICAgdmFyIFRPS19BTkQgPSAiQW5kIjsKICAgIHZhciBUT0tfRVEgPSAiRVEiOwogICAgdmFyIFRPS19HVCA9ICJHVCI7CiAgICB2YXIgVE9LX0xUID0gIkxUIjsKICAgIHZhciBUT0tfR1RFID0gIkdURSI7CiAgICB2YXIgVE9LX0xURSA9ICJMVEUiOwogICAgdmFyIFRPS19ORSA9ICJORSI7CiAgICB2YXIgVE9LX0ZMQVRURU4gPSAiRmxhdHRlbiI7CiAgICB2YXIgVE9LX1NUQVIgPSAiU3RhciI7CiAgICB2YXIgVE9LX0ZJTFRFUiA9ICJGaWx0ZXIiOwogICAgdmFyIFRPS19ET1QgPSAiRG90IjsKICAgIHZhciBUT0tfTk9UID0gIk5vdCI7CiAgICB2YXIgVE9LX0xCUkFDRSA9ICJMYnJhY2UiOwogICAgdmFyIFRPS19MQlJBQ0tFVCA9ICJMYnJhY2tldCI7CiAgICB2YXIgVE9LX0xQQVJFTj0gIkxwYXJlbiI7CiAgICB2YXIgVE9LX0xJVEVSQUw9ICJMaXRlcmFsIjsKICAKICAgIC8vIFRoZSAiJiIsICJbIiwgIjwiLCAiPiIgdG9rZW5zCiAgICAvLyBhcmUgbm90IGluIGJhc2ljVG9rZW4gYmVjYXVzZQogICAgLy8gdGhlcmUgYXJlIHR3byB0b2tlbiB2YXJpYW50cwogICAgLy8gKCImJiIsICJbPyIsICI8PSIsICI+PSIpLiAgVGhpcyBpcyBzcGVjaWFsbHkgaGFuZGxlZAogICAgLy8gYmVsb3cuCiAgCiAgICB2YXIgYmFzaWNUb2tlbnMgPSB7CiAgICAgICIuIjogVE9LX0RPVCwKICAgICAgIioiOiBUT0tfU1RBUiwKICAgICAgIiwiOiBUT0tfQ09NTUEsCiAgICAgICI6IjogVE9LX0NPTE9OLAogICAgICAieyI6IFRPS19MQlJBQ0UsCiAgICAgICJ9IjogVE9LX1JCUkFDRSwKICAgICAgIl0iOiBUT0tfUkJSQUNLRVQsCiAgICAgICIoIjogVE9LX0xQQVJFTiwKICAgICAgIikiOiBUT0tfUlBBUkVOLAogICAgICAiQCI6IFRPS19DVVJSRU5UCiAgICB9OwogIAogICAgdmFyIG9wZXJhdG9yU3RhcnRUb2tlbiA9IHsKICAgICAgICAiPCI6IHRydWUsCiAgICAgICAgIj4iOiB0cnVlLAogICAgICAgICI9IjogdHJ1ZSwKICAgICAgICAiISI6IHRydWUKICAgIH07CiAgCiAgICB2YXIgc2tpcENoYXJzID0gewogICAgICAgICIgIjogdHJ1ZSwKICAgICAgICAiXHQiOiB0cnVlLAogICAgICAgICJcbiI6IHRydWUKICAgIH07CiAgCiAgCiAgICBmdW5jdGlvbiBpc0FscGhhKGNoKSB7CiAgICAgICAgcmV0dXJuIChjaCA+PSAiYSIgJiYgY2ggPD0gInoiKSB8fAogICAgICAgICAgICAgICAoY2ggPj0gIkEiICYmIGNoIDw9ICJaIikgfHwKICAgICAgICAgICAgICAgY2ggPT09ICJfIjsKICAgIH0KICAKICAgIGZ1bmN0aW9uIGlzTnVtKGNoKSB7CiAgICAgICAgcmV0dXJuIChjaCA+PSAiMCIgJiYgY2ggPD0gIjkiKSB8fAogICAgICAgICAgICAgICBjaCA9PT0gIi0iOwogICAgfQogICAgZnVuY3Rpb24gaXNBbHBoYU51bShjaCkgewogICAgICAgIHJldHVybiAoY2ggPj0gImEiICYmIGNoIDw9ICJ6IikgfHwKICAgICAgICAgICAgICAgKGNoID49ICJBIiAmJiBjaCA8PSAiWiIpIHx8CiAgICAgICAgICAgICAgIChjaCA+PSAiMCIgJiYgY2ggPD0gIjkiKSB8fAogICAgICAgICAgICAgICBjaCA9PT0gIl8iOwogICAgfQogIAogICAgZnVuY3Rpb24gTGV4ZXIoKSB7CiAgICB9CiAgICBMZXhlci5wcm90b3R5cGUgPSB7CiAgICAgICAgdG9rZW5pemU6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSAwOwogICAgICAgICAgICB2YXIgc3RhcnQ7CiAgICAgICAgICAgIHZhciBpZGVudGlmaWVyOwogICAgICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jdXJyZW50IDwgc3RyZWFtLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKGlzQWxwaGEoc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVVucXVvdGVkSWRlbnRpZmllcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfVU5RVU9URURJREVOVElGSUVSLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGJhc2ljVG9rZW5zW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBiYXNpY1Rva2Vuc1tzdHJlYW1bdGhpcy5fY3VycmVudF1dLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdHJlYW1bdGhpcy5fY3VycmVudF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHRoaXMuX2N1cnJlbnR9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkpIHsKICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2NvbnN1bWVOdW1iZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIlsiKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBpbmNyZW1lbnQgdGhpcy5fY3VycmVudC4gIFRoaXMgaGFwcGVucwogICAgICAgICAgICAgICAgICAgIC8vIGluIF9jb25zdW1lTEJyYWNrZXQKICAgICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2NvbnN1bWVMQnJhY2tldChzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiXCIiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lUXVvdGVkSWRlbnRpZmllcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfUVVPVEVESURFTlRJRklFUiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICInIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVJhd1N0cmluZ0xpdGVyYWwoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0xJVEVSQUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpZGVudGlmaWVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiYCIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpdGVyYWwgPSB0aGlzLl9jb25zdW1lTGl0ZXJhbChzdHJlYW0pOwogICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfTElURVJBTCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGxpdGVyYWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcGVyYXRvclN0YXJ0VG9rZW5bc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godGhpcy5fY29uc3VtZU9wZXJhdG9yKHN0cmVhbSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChza2lwQ2hhcnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHdoaXRlc3BhY2UuCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICImIikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19BTkQsIHZhbHVlOiAiJiYiLCBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0VYUFJFRiwgdmFsdWU6ICImIiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJ8IikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gInwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19PUiwgdmFsdWU6ICJ8fCIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfUElQRSwgdmFsdWU6ICJ8Iiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlVua25vd24gY2hhcmFjdGVyOiIgKyBzdHJlYW1bdGhpcy5fY3VycmVudF0pOwogICAgICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiTGV4ZXJFcnJvciI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRva2VuczsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lVW5xdW90ZWRJZGVudGlmaWVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fY3VycmVudCA8IHN0cmVhbS5sZW5ndGggJiYgaXNBbHBoYU51bShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCk7CiAgICAgICAgfSwKICAKICAgICAgICBfY29uc3VtZVF1b3RlZElkZW50aWZpZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdICE9PSAiXCIiICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIFlvdSBjYW4gZXNjYXBlIGEgZG91YmxlIHF1b3RlIGFuZCB5b3UgY2FuIGVzY2FwZSBhbiBlc2NhcGUuCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJlYW1bY3VycmVudCArIDFdID09PSAiXCIiKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lUmF3U3RyaW5nTGl0ZXJhbDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICInIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIHNpbmdsZSBxdW90ZSBhbmQgeW91IGNhbiBlc2NhcGUgYW4gZXNjYXBlLgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIiciKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbGl0ZXJhbCA9IHN0cmVhbS5zbGljZShzdGFydCArIDEsIHRoaXMuX2N1cnJlbnQgLSAxKTsKICAgICAgICAgICAgcmV0dXJuIGxpdGVyYWwucmVwbGFjZSgiXFwnIiwgIiciKTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lTnVtYmVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgICAgd2hpbGUgKGlzTnVtKHN0cmVhbVt0aGlzLl9jdXJyZW50XSkgJiYgdGhpcy5fY3VycmVudCA8IG1heExlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlSW50KHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19OVU1CRVIsIHZhbHVlOiB2YWx1ZSwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lTEJyYWNrZXQ6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI/IikgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRklMVEVSLCB2YWx1ZTogIls/Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJdIikgewogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfRkxBVFRFTiwgdmFsdWU6ICJbXSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MQlJBQ0tFVCwgdmFsdWU6ICJbIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX2NvbnN1bWVPcGVyYXRvcjogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgIHZhciBzdGFydGluZ0NoYXIgPSBzdHJlYW1bc3RhcnRdOwogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIGlmIChzdGFydGluZ0NoYXIgPT09ICIhIikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05FLCB2YWx1ZTogIiE9Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05PVCwgdmFsdWU6ICIhIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI8IikgewogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xURSwgdmFsdWU6ICI8PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xULCB2YWx1ZTogIjwiLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiPSIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfR1RFLCB2YWx1ZTogIj49Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfR1QsIHZhbHVlOiAiPiIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRpbmdDaGFyID09PSAiPSIpIHsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19FUSwgdmFsdWU6ICI9PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9jb25zdW1lTGl0ZXJhbDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9IHN0cmVhbS5sZW5ndGg7CiAgICAgICAgICAgIHZhciBsaXRlcmFsOwogICAgICAgICAgICB3aGlsZShzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICJgIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIGxpdGVyYWwgY2hhciBvciB5b3UgY2FuIGVzY2FwZSB0aGUgZXNjYXBlLgogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gImAiKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxpdGVyYWxTdHJpbmcgPSB0cmltTGVmdChzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICAgICAgbGl0ZXJhbFN0cmluZyA9IGxpdGVyYWxTdHJpbmcucmVwbGFjZSgiXFxgIiwgImAiKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2tzTGlrZUpTT04obGl0ZXJhbFN0cmluZykpIHsKICAgICAgICAgICAgICAgIGxpdGVyYWwgPSBKU09OLnBhcnNlKGxpdGVyYWxTdHJpbmcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVHJ5IHRvIEpTT04gcGFyc2UgaXQgYXMgIjxsaXRlcmFsPiIKICAgICAgICAgICAgICAgIGxpdGVyYWwgPSBKU09OLnBhcnNlKCJcIiIgKyBsaXRlcmFsU3RyaW5nICsgIlwiIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gKzEgZ2V0cyB1cyB0byB0aGUgZW5kaW5nICJgIiwgKzEgdG8gbW92ZSBvbiB0byB0aGUgbmV4dCBjaGFyLgogICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgIHJldHVybiBsaXRlcmFsOwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvb2tzTGlrZUpTT046IGZ1bmN0aW9uKGxpdGVyYWxTdHJpbmcpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0aW5nQ2hhcnMgPSAiW3tcIiI7CiAgICAgICAgICAgIHZhciBqc29uTGl0ZXJhbHMgPSBbInRydWUiLCAiZmFsc2UiLCAibnVsbCJdOwogICAgICAgICAgICB2YXIgbnVtYmVyTG9va2luZyA9ICItMDEyMzQ1Njc4OSI7CiAgCiAgICAgICAgICAgIGlmIChsaXRlcmFsU3RyaW5nID09PSAiIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0aW5nQ2hhcnMuaW5kZXhPZihsaXRlcmFsU3RyaW5nWzBdKSA+PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChqc29uTGl0ZXJhbHMuaW5kZXhPZihsaXRlcmFsU3RyaW5nKSA+PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChudW1iZXJMb29raW5nLmluZGV4T2YobGl0ZXJhbFN0cmluZ1swXSkgPj0gMCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBKU09OLnBhcnNlKGxpdGVyYWxTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogIAogICAgICAgIHZhciBiaW5kaW5nUG93ZXIgPSB7fTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0VPRl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfVU5RVU9URURJREVOVElGSUVSXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19RVU9URURJREVOVElGSUVSXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19SQlJBQ0tFVF0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUlBBUkVOXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19DT01NQV0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUkJSQUNFXSA9IDA7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19OVU1CRVJdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0NVUlJFTlRdID0gMDsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0VYUFJFRl0gPSAwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfUElQRV0gPSAxOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfT1JdID0gMjsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0FORF0gPSAzOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRVFdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX0dUXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MVF0gPSA1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfR1RFXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MVEVdID0gNTsKICAgICAgICBiaW5kaW5nUG93ZXJbVE9LX05FXSA9IDU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19GTEFUVEVOXSA9IDk7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19TVEFSXSA9IDIwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRklMVEVSXSA9IDIxOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfRE9UXSA9IDQwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTk9UXSA9IDQ1OwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTEJSQUNFXSA9IDUwOwogICAgICAgIGJpbmRpbmdQb3dlcltUT0tfTEJSQUNLRVRdID0gNTU7CiAgICAgICAgYmluZGluZ1Bvd2VyW1RPS19MUEFSRU5dID0gNjA7CiAgCiAgICBmdW5jdGlvbiBQYXJzZXIoKSB7CiAgICB9CiAgCiAgICBQYXJzZXIucHJvdG90eXBlID0gewogICAgICAgIHBhcnNlOiBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICAgICAgICAgIHRoaXMuX2xvYWRUb2tlbnMoZXhwcmVzc2lvbik7CiAgICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgICB2YXIgYXN0ID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfRU9GKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAgICJVbmV4cGVjdGVkIHRva2VuIHR5cGU6ICIgKyB0LnR5cGUgKyAiLCB2YWx1ZTogIiArIHQudmFsdWUpOwogICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYXN0OwogICAgICAgIH0sCiAgCiAgICAgICAgX2xvYWRUb2tlbnM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCk7CiAgICAgICAgICAgIHZhciB0b2tlbnMgPSBsZXhlci50b2tlbml6ZShleHByZXNzaW9uKTsKICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19FT0YsIHZhbHVlOiAiIiwgc3RhcnQ6IGV4cHJlc3Npb24ubGVuZ3RofSk7CiAgICAgICAgICAgIHRoaXMudG9rZW5zID0gdG9rZW5zOwogICAgICAgIH0sCiAgCiAgICAgICAgZXhwcmVzc2lvbjogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICAgIHZhciBsZWZ0VG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICB2YXIgbGVmdCA9IHRoaXMubnVkKGxlZnRUb2tlbik7CiAgICAgICAgICAgIHZhciBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIHdoaWxlIChyYnAgPCBiaW5kaW5nUG93ZXJbY3VycmVudFRva2VuXSkgewogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMubGVkKGN1cnJlbnRUb2tlbiwgbGVmdCk7CiAgICAgICAgICAgICAgICBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9va2FoZWFkOiBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9rZW5zW3RoaXMuaW5kZXggKyBudW1iZXJdLnR5cGU7CiAgICAgICAgfSwKICAKICAgICAgICBfbG9va2FoZWFkVG9rZW46IGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy50b2tlbnNbdGhpcy5pbmRleCArIG51bWJlcl07CiAgICAgICAgfSwKICAKICAgICAgICBfYWR2YW5jZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICB9LAogIAogICAgICAgIG51ZDogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgIHZhciBsZWZ0OwogICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgdmFyIGV4cHJlc3Npb247CiAgICAgICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSBUT0tfTElURVJBTDoKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJMaXRlcmFsIiwgdmFsdWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgICAgY2FzZSBUT0tfVU5RVU9URURJREVOVElGSUVSOgogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkZpZWxkIiwgbmFtZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICBjYXNlIFRPS19RVU9URURJREVOVElGSUVSOgogICAgICAgICAgICAgIHZhciBub2RlID0ge3R5cGU6ICJGaWVsZCIsIG5hbWU6IHRva2VuLnZhbHVlfTsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTFBBUkVOKSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUXVvdGVkIGlkZW50aWZpZXIgbm90IGFsbG93ZWQgZm9yIGZ1bmN0aW9uIG5hbWVzLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUT0tfTk9UOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5Ob3QpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk5vdEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW3JpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX1NUQVI6CiAgICAgICAgICAgICAgbGVmdCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgICByaWdodCA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FuIGhhcHBlbiBpbiBhIG11bHRpc2VsZWN0LAogICAgICAgICAgICAgICAgICAvLyBbYSwgYiwgKl0KICAgICAgICAgICAgICAgICAgcmlnaHQgPSB7dHlwZTogIklkZW50aXR5In07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJWYWx1ZVByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0ZJTFRFUjoKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sZWQodG9rZW4udHlwZSwge3R5cGU6ICJJZGVudGl0eSJ9KTsKICAgICAgICAgICAgY2FzZSBUT0tfTEJSQUNFOgogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0SGFzaCgpOwogICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgIGxlZnQgPSB7dHlwZTogVE9LX0ZMQVRURU4sIGNoaWxkcmVuOiBbe3R5cGU6ICJJZGVudGl0eSJ9XX07CiAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZsYXR0ZW4pOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0xCUkFDS0VUOgogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19OVU1CRVIgfHwgdGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZUluZGV4RXhwcmVzc2lvbigpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvamVjdElmU2xpY2Uoe3R5cGU6ICJJZGVudGl0eSJ9LCByaWdodCk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19TVEFSICYmCiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb29rYWhlYWQoMSkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW3t0eXBlOiAiSWRlbnRpdHkifSwgcmlnaHRdfTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdExpc3QoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVE9LX0NVUlJFTlQ6CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgIGNhc2UgVE9LX0VYUFJFRjoKICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5FeHByZWYpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkV4cHJlc3Npb25SZWZlcmVuY2UiLCBjaGlsZHJlbjogW2V4cHJlc3Npb25dfTsKICAgICAgICAgICAgY2FzZSBUT0tfTFBBUkVOOgogICAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX1JQQVJFTikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NVUlJFTlQpIHsKICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhcmdzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SUEFSRU4pOwogICAgICAgICAgICAgIHJldHVybiBhcmdzWzBdOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRoaXMuX2Vycm9yVG9rZW4odG9rZW4pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgbGVkOiBmdW5jdGlvbih0b2tlbk5hbWUsIGxlZnQpIHsKICAgICAgICAgIHZhciByaWdodDsKICAgICAgICAgIHN3aXRjaCh0b2tlbk5hbWUpIHsKICAgICAgICAgICAgY2FzZSBUT0tfRE9UOgogICAgICAgICAgICAgIHZhciByYnAgPSBiaW5kaW5nUG93ZXIuRG90OwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19TVEFSKSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VEb3RSSFMocmJwKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiU3ViZXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvLyBDcmVhdGluZyBhIHByb2plY3Rpb24uCiAgICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMocmJwKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiVmFsdWVQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUT0tfUElQRToKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuUGlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfUElQRSwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgICBjYXNlIFRPS19PUjoKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuT3IpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk9yRXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgY2FzZSBUT0tfQU5EOgogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5BbmQpOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkFuZEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICAgIGNhc2UgVE9LX0xQQVJFTjoKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGxlZnQubmFtZTsKICAgICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICAgIHZhciBleHByZXNzaW9uLCBub2RlOwogICAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SUEFSRU4pIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DVVJSRU5UKSB7CiAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhcmdzLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SUEFSRU4pOwogICAgICAgICAgICAgIG5vZGUgPSB7dHlwZTogIkZ1bmN0aW9uIiwgbmFtZTogbmFtZSwgY2hpbGRyZW46IGFyZ3N9OwogICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICBjYXNlIFRPS19GSUxURVI6CiAgICAgICAgICAgICAgdmFyIGNvbmRpdGlvbiA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19GTEFUVEVOKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZpbHRlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkZpbHRlclByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0LCBjb25kaXRpb25dfTsKICAgICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgICB2YXIgbGVmdE5vZGUgPSB7dHlwZTogVE9LX0ZMQVRURU4sIGNoaWxkcmVuOiBbbGVmdF19OwogICAgICAgICAgICAgIHZhciByaWdodE5vZGUgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZsYXR0ZW4pOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnROb2RlLCByaWdodE5vZGVdfTsKICAgICAgICAgICAgY2FzZSBUT0tfRVE6CiAgICAgICAgICAgIGNhc2UgVE9LX05FOgogICAgICAgICAgICBjYXNlIFRPS19HVDoKICAgICAgICAgICAgY2FzZSBUT0tfR1RFOgogICAgICAgICAgICBjYXNlIFRPS19MVDoKICAgICAgICAgICAgY2FzZSBUT0tfTFRFOgogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZUNvbXBhcmF0b3IobGVmdCwgdG9rZW5OYW1lKTsKICAgICAgICAgICAgY2FzZSBUT0tfTEJSQUNLRVQ6CiAgICAgICAgICAgICAgdmFyIHRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgaWYgKHRva2VuLnR5cGUgPT09IFRPS19OVU1CRVIgfHwgdG9rZW4udHlwZSA9PT0gVE9LX0NPTE9OKSB7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VJbmRleEV4cHJlc3Npb24oKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Byb2plY3RJZlNsaWNlKGxlZnQsIHJpZ2h0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfU1RBUik7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhpcy5fZXJyb3JUb2tlbih0aGlzLl9sb29rYWhlYWRUb2tlbigwKSk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfbWF0Y2g6IGZ1bmN0aW9uKHRva2VuVHlwZSkgewogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSB0b2tlblR5cGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkV4cGVjdGVkICIgKyB0b2tlblR5cGUgKyAiLCBnb3Q6ICIgKyB0LnR5cGUpOwogICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgCiAgICAgICAgX2Vycm9yVG9rZW46IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiSW52YWxpZCB0b2tlbiAoIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi50eXBlICsgIik6IFwiIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b2tlbi52YWx1ZSArICJcIiIpOwogICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSwKICAKICAKICAgICAgICBfcGFyc2VJbmRleEV4cHJlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09MT04gfHwgdGhpcy5fbG9va2FoZWFkKDEpID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZVNsaWNlRXhwcmVzc2lvbigpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkluZGV4IiwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdGhpcy5fbG9va2FoZWFkVG9rZW4oMCkudmFsdWV9OwogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAKICAgICAgICBfcHJvamVjdElmU2xpY2U6IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgICAgIHZhciBpbmRleEV4cHIgPSB7dHlwZTogIkluZGV4RXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgaWYgKHJpZ2h0LnR5cGUgPT09ICJTbGljZSIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogIlByb2plY3Rpb24iLAogICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbaW5kZXhFeHByLCB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpXQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBpbmRleEV4cHI7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZVNsaWNlRXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIFtzdGFydDplbmQ6c3RlcF0gd2hlcmUgZWFjaCBwYXJ0IGlzIG9wdGlvbmFsLCBhcyB3ZWxsIGFzIHRoZSBsYXN0CiAgICAgICAgICAgIC8vIGNvbG9uLgogICAgICAgICAgICB2YXIgcGFydHMgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgICAgIHZhciBpbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50VG9rZW4gIT09IFRPS19SQlJBQ0tFVCAmJiBpbmRleCA8IDMpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VG9rZW4gPT09IFRPS19DT0xPTikgewogICAgICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50VG9rZW4gPT09IFRPS19OVU1CRVIpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0c1tpbmRleF0gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKS52YWx1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiU3ludGF4IGVycm9yLCB1bmV4cGVjdGVkIHRva2VuOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC52YWx1ZSArICIoIiArIHQudHlwZSArICIpIik7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJlcnJvciI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VG9rZW4gPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHR5cGU6ICJTbGljZSIsCiAgICAgICAgICAgICAgICBjaGlsZHJlbjogcGFydHMKICAgICAgICAgICAgfTsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZUNvbXBhcmF0b3I6IGZ1bmN0aW9uKGxlZnQsIGNvbXBhcmF0b3IpIHsKICAgICAgICAgIHZhciByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXJbY29tcGFyYXRvcl0pOwogICAgICAgICAgcmV0dXJuIHt0eXBlOiAiQ29tcGFyYXRvciIsIG5hbWU6IGNvbXBhcmF0b3IsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZURvdFJIUzogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICAgIHZhciBsb29rYWhlYWQgPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgIHZhciBleHByVG9rZW5zID0gW1RPS19VTlFVT1RFRElERU5USUZJRVIsIFRPS19RVU9URURJREVOVElGSUVSLCBUT0tfU1RBUl07CiAgICAgICAgICAgIGlmIChleHByVG9rZW5zLmluZGV4T2YobG9va2FoZWFkKSA+PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobG9va2FoZWFkID09PSBUT0tfTEJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19MQlJBQ0tFVCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdExpc3QoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsb29rYWhlYWQgPT09IFRPS19MQlJBQ0UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19MQlJBQ0UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlTXVsdGlzZWxlY3RIYXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZVByb2plY3Rpb25SSFM6IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgICB2YXIgcmlnaHQ7CiAgICAgICAgICAgIGlmIChiaW5kaW5nUG93ZXJbdGhpcy5fbG9va2FoZWFkKDApXSA8IDEwKSB7CiAgICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19MQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19GSUxURVIpIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5leHByZXNzaW9uKHJicCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRE9UKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfRE9UKTsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VEb3RSSFMocmJwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIlN5dGFueCBlcnJvciwgdW5leHBlY3RlZCB0b2tlbjogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC52YWx1ZSArICIoIiArIHQudHlwZSArICIpIik7CiAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByaWdodDsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZU11bHRpc2VsZWN0TGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBleHByZXNzaW9ucyA9IFtdOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIHZhciBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgICAgZXhwcmVzc2lvbnMucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19DT01NQSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX1JCUkFDS0VUKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgdG9rZW4gUmJyYWNrZXQiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTXVsdGlTZWxlY3RMaXN0IiwgY2hpbGRyZW46IGV4cHJlc3Npb25zfTsKICAgICAgICB9LAogIAogICAgICAgIF9wYXJzZU11bHRpc2VsZWN0SGFzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgcGFpcnMgPSBbXTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyVHlwZXMgPSBbVE9LX1VOUVVPVEVESURFTlRJRklFUiwgVE9LX1FVT1RFRElERU5USUZJRVJdOwogICAgICAgICAgdmFyIGtleVRva2VuLCBrZXlOYW1lLCB2YWx1ZSwgbm9kZTsKICAgICAgICAgIGZvciAoOzspIHsKICAgICAgICAgICAga2V5VG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgICAgaWYgKGlkZW50aWZpZXJUeXBlcy5pbmRleE9mKGtleVRva2VuLnR5cGUpIDwgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0aW5nIGFuIGlkZW50aWZpZXIgdG9rZW4sIGdvdDogIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleVRva2VuLnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGtleU5hbWUgPSBrZXlUb2tlbi52YWx1ZTsKICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfQ09MT04pOwogICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZXhwcmVzc2lvbigwKTsKICAgICAgICAgICAgbm9kZSA9IHt0eXBlOiAiS2V5VmFsdWVQYWlyIiwgbmFtZToga2V5TmFtZSwgdmFsdWU6IHZhbHVlfTsKICAgICAgICAgICAgcGFpcnMucHVzaChub2RlKTsKICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0UpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNFKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTXVsdGlTZWxlY3RIYXNoIiwgY2hpbGRyZW46IHBhaXJzfTsKICAgICAgICB9CiAgICB9OwogIAogIAogICAgZnVuY3Rpb24gVHJlZUludGVycHJldGVyKHJ1bnRpbWUpIHsKICAgICAgdGhpcy5ydW50aW1lID0gcnVudGltZTsKICAgIH0KICAKICAgIFRyZWVJbnRlcnByZXRlci5wcm90b3R5cGUgPSB7CiAgICAgICAgc2VhcmNoOiBmdW5jdGlvbihub2RlLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLCB2YWx1ZSk7CiAgICAgICAgfSwKICAKICAgICAgICB2aXNpdDogZnVuY3Rpb24obm9kZSwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIG1hdGNoZWQsIGN1cnJlbnQsIHJlc3VsdCwgZmlyc3QsIHNlY29uZCwgZmllbGQsIGxlZnQsIHJpZ2h0LCBjb2xsZWN0ZWQsIGk7CiAgICAgICAgICAgIHN3aXRjaCAobm9kZS50eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAiRmllbGQiOgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsICkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZCA9IHZhbHVlW25vZGUubmFtZV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAiU3ViZXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICByZXN1bHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDE7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCByZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlICJJbmRleEV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgbGVmdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGxlZnQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJpZ2h0OwogICAgICAgICAgICAgIGNhc2UgIkluZGV4IjoKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBub2RlLnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgICBpbmRleCA9IHZhbHVlLmxlbmd0aCArIGluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWVbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIGNhc2UgIlNsaWNlIjoKICAgICAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc2xpY2VQYXJhbXMgPSBub2RlLmNoaWxkcmVuLnNsaWNlKDApOwogICAgICAgICAgICAgICAgdmFyIGNvbXB1dGVkID0gdGhpcy5jb21wdXRlU2xpY2VQYXJhbXModmFsdWUubGVuZ3RoLCBzbGljZVBhcmFtcyk7CiAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBjb21wdXRlZFswXTsKICAgICAgICAgICAgICAgIHZhciBzdG9wID0gY29tcHV0ZWRbMV07CiAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNvbXB1dGVkWzJdOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgICAgICAgICBpZiAoc3RlcCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA8IHN0b3A7IGkgKz0gc3RlcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZVtpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzdGFydDsgaSA+IHN0b3A7IGkgKz0gc3RlcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZVtpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlICJQcm9qZWN0aW9uIjoKICAgICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGxlZnQgY2hpbGQuCiAgICAgICAgICAgICAgICB2YXIgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KGJhc2UpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYmFzZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBiYXNlW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgICBjYXNlICJWYWx1ZVByb2plY3Rpb24iOgogICAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICAgIGJhc2UgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmICghaXNPYmplY3QoYmFzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBvYmpWYWx1ZXMoYmFzZSk7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29sbGVjdGVkLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiRmlsdGVyUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgICBiYXNlID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkoYmFzZSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgICAgICAgICAgICAgIHZhciBmaW5hbFJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYXNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMl0sIGJhc2VbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoIWlzRmFsc2UobWF0Y2hlZCkpIHsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXJlZC5wdXNoKGJhc2VbaV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZpbHRlcmVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGZpbHRlcmVkW2pdKTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmaW5hbFJlc3VsdHMucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0czsKICAgICAgICAgICAgICBjYXNlICJDb21wYXJhdG9yIjoKICAgICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBzZWNvbmQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHN3aXRjaChub2RlLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfRVE6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19ORToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSAhc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIFRPS19HVDoKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA+IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfR1RFOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0ID49IHNlY29uZDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBUT0tfTFQ6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPCBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgVE9LX0xURToKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA8PSBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGNvbXBhcmF0b3I6ICIgKyBub2RlLm5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICBjYXNlIFRPS19GTEFUVEVOOgogICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkob3JpZ2luYWwpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG1lcmdlZCA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9yaWdpbmFsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBvcmlnaW5hbFtpXTsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY3VycmVudCkpIHsKICAgICAgICAgICAgICAgICAgICBtZXJnZWQucHVzaC5hcHBseShtZXJnZWQsIGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1lcmdlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWVyZ2VkOwogICAgICAgICAgICAgIGNhc2UgIklkZW50aXR5IjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICBjYXNlICJNdWx0aVNlbGVjdExpc3QiOgogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sbGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZS5jaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKHRoaXMudmlzaXQobm9kZS5jaGlsZHJlbltpXSwgdmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBjb2xsZWN0ZWQ7CiAgICAgICAgICAgICAgY2FzZSAiTXVsdGlTZWxlY3RIYXNoIjoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbGxlY3RlZCA9IHt9OwogICAgICAgICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBub2RlLmNoaWxkcmVuW2ldOwogICAgICAgICAgICAgICAgICBjb2xsZWN0ZWRbY2hpbGQubmFtZV0gPSB0aGlzLnZpc2l0KGNoaWxkLnZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICAgIGNhc2UgIk9yRXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgICBpZiAoaXNGYWxzZShtYXRjaGVkKSkgewogICAgICAgICAgICAgICAgICAgIG1hdGNoZWQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaGVkOwogICAgICAgICAgICAgIGNhc2UgIkFuZEV4cHJlc3Npb24iOgogICAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAKICAgICAgICAgICAgICAgIGlmIChpc0ZhbHNlKGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgY2FzZSAiTm90RXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgICBmaXJzdCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGlzRmFsc2UoZmlyc3QpOwogICAgICAgICAgICAgIGNhc2UgIkxpdGVyYWwiOgogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWU7CiAgICAgICAgICAgICAgY2FzZSBUT0tfUElQRToKICAgICAgICAgICAgICAgIGxlZnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIGxlZnQpOwogICAgICAgICAgICAgIGNhc2UgVE9LX0NVUlJFTlQ6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgY2FzZSAiRnVuY3Rpb24iOgogICAgICAgICAgICAgICAgdmFyIHJlc29sdmVkQXJncyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlZEFyZ3MucHVzaCh0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5baV0sIHZhbHVlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ydW50aW1lLmNhbGxGdW5jdGlvbihub2RlLm5hbWUsIHJlc29sdmVkQXJncyk7CiAgICAgICAgICAgICAgY2FzZSAiRXhwcmVzc2lvblJlZmVyZW5jZSI6CiAgICAgICAgICAgICAgICB2YXIgcmVmTm9kZSA9IG5vZGUuY2hpbGRyZW5bMF07CiAgICAgICAgICAgICAgICAvLyBUYWcgdGhlIG5vZGUgd2l0aCBhIHNwZWNpZmljIGF0dHJpYnV0ZSBzbyB0aGUgdHlwZQogICAgICAgICAgICAgICAgLy8gY2hlY2tlciB2ZXJpZnkgdGhlIHR5cGUuCiAgICAgICAgICAgICAgICByZWZOb2RlLmptZXNwYXRoVHlwZSA9IFRPS19FWFBSRUY7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVmTm9kZTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIG5vZGUgdHlwZTogIiArIG5vZGUudHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogIAogICAgICAgIGNvbXB1dGVTbGljZVBhcmFtczogZnVuY3Rpb24oYXJyYXlMZW5ndGgsIHNsaWNlUGFyYW1zKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSBzbGljZVBhcmFtc1swXTsKICAgICAgICAgIHZhciBzdG9wID0gc2xpY2VQYXJhbXNbMV07CiAgICAgICAgICB2YXIgc3RlcCA9IHNsaWNlUGFyYW1zWzJdOwogICAgICAgICAgdmFyIGNvbXB1dGVkID0gW251bGwsIG51bGwsIG51bGxdOwogICAgICAgICAgaWYgKHN0ZXAgPT09IG51bGwpIHsKICAgICAgICAgICAgc3RlcCA9IDE7CiAgICAgICAgICB9IGVsc2UgaWYgKHN0ZXAgPT09IDApIHsKICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJJbnZhbGlkIHNsaWNlLCBzdGVwIGNhbm5vdCBiZSAwIik7CiAgICAgICAgICAgIGVycm9yLm5hbWUgPSAiUnVudGltZUVycm9yIjsKICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RlcFZhbHVlTmVnYXRpdmUgPSBzdGVwIDwgMCA/IHRydWUgOiBmYWxzZTsKICAKICAgICAgICAgIGlmIChzdGFydCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHN0YXJ0ID0gc3RlcFZhbHVlTmVnYXRpdmUgPyBhcnJheUxlbmd0aCAtIDEgOiAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuY2FwU2xpY2VSYW5nZShhcnJheUxlbmd0aCwgc3RhcnQsIHN0ZXApOwogICAgICAgICAgfQogIAogICAgICAgICAgaWYgKHN0b3AgPT09IG51bGwpIHsKICAgICAgICAgICAgICBzdG9wID0gc3RlcFZhbHVlTmVnYXRpdmUgPyAtMSA6IGFycmF5TGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdG9wID0gdGhpcy5jYXBTbGljZVJhbmdlKGFycmF5TGVuZ3RoLCBzdG9wLCBzdGVwKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbXB1dGVkWzBdID0gc3RhcnQ7CiAgICAgICAgICBjb21wdXRlZFsxXSA9IHN0b3A7CiAgICAgICAgICBjb21wdXRlZFsyXSA9IHN0ZXA7CiAgICAgICAgICByZXR1cm4gY29tcHV0ZWQ7CiAgICAgICAgfSwKICAKICAgICAgICBjYXBTbGljZVJhbmdlOiBmdW5jdGlvbihhcnJheUxlbmd0aCwgYWN0dWFsVmFsdWUsIHN0ZXApIHsKICAgICAgICAgICAgaWYgKGFjdHVhbFZhbHVlIDwgMCkgewogICAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgKz0gYXJyYXlMZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoYWN0dWFsVmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgPSBzdGVwIDwgMCA/IC0xIDogMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChhY3R1YWxWYWx1ZSA+PSBhcnJheUxlbmd0aCkgewogICAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgPSBzdGVwIDwgMCA/IGFycmF5TGVuZ3RoIC0gMSA6IGFycmF5TGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhY3R1YWxWYWx1ZTsKICAgICAgICB9CiAgCiAgICB9OwogIAogICAgZnVuY3Rpb24gUnVudGltZShpbnRlcnByZXRlcikgewogICAgICB0aGlzLl9pbnRlcnByZXRlciA9IGludGVycHJldGVyOwogICAgICB0aGlzLmZ1bmN0aW9uVGFibGUgPSB7CiAgICAgICAgICAvLyBuYW1lOiBbZnVuY3Rpb24sIDxzaWduYXR1cmU+XQogICAgICAgICAgLy8gVGhlIDxzaWduYXR1cmU+IGNhbiBiZToKICAgICAgICAgIC8vCiAgICAgICAgICAvLyB7CiAgICAgICAgICAvLyAgIGFyZ3M6IFtbdHlwZTEsIHR5cGUyXSwgW3R5cGUxLCB0eXBlMl1dLAogICAgICAgICAgLy8gICB2YXJpYWRpYzogdHJ1ZXxmYWxzZQogICAgICAgICAgLy8gfQogICAgICAgICAgLy8KICAgICAgICAgIC8vIEVhY2ggYXJnIGluIHRoZSBhcmcgbGlzdCBpcyBhIGxpc3Qgb2YgdmFsaWQgdHlwZXMKICAgICAgICAgIC8vIChpZiB0aGUgZnVuY3Rpb24gaXMgb3ZlcmxvYWRlZCBhbmQgc3VwcG9ydHMgbXVsdGlwbGUKICAgICAgICAgIC8vIHR5cGVzLiAgSWYgdGhlIHR5cGUgaXMgImFueSIgdGhlbiBubyB0eXBlIGNoZWNraW5nCiAgICAgICAgICAvLyBvY2N1cnMgb24gdGhlIGFyZ3VtZW50LiAgVmFyaWFkaWMgaXMgb3B0aW9uYWwKICAgICAgICAgIC8vIGFuZCBpZiBub3QgcHJvdmlkZWQgaXMgYXNzdW1lZCB0byBiZSBmYWxzZS4KICAgICAgICAgIGFiczoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkFicywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfTlVNQkVSXX1dfSwKICAgICAgICAgIGF2Zzoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkF2ZywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfTlVNQkVSXX1dfSwKICAgICAgICAgIGNlaWw6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25DZWlsLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgICAgY29udGFpbnM6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Db250YWlucywKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVldfSwKICAgICAgICAgICAgICAgICAgICAgICAgICB7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAiZW5kc193aXRoIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkVuZHNXaXRoLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklOR119LCB7dHlwZXM6IFtUWVBFX1NUUklOR119XX0sCiAgICAgICAgICBmbG9vcjoge19mdW5jOiB0aGlzLl9mdW5jdGlvbkZsb29yLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTGVuZ3RoLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX1NUUklORywgVFlQRV9BUlJBWSwgVFlQRV9PQkpFQ1RdfV19LAogICAgICAgICAgbWFwOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWFwLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0VYUFJFRl19LCB7dHlwZXM6IFtUWVBFX0FSUkFZXX1dfSwKICAgICAgICAgIG1heDogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1heCwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVIsIFRZUEVfQVJSQVlfU1RSSU5HXX1dfSwKICAgICAgICAgICJtZXJnZSI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NZXJnZSwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9PQkpFQ1RdLCB2YXJpYWRpYzogdHJ1ZX1dCiAgICAgICAgICB9LAogICAgICAgICAgIm1heF9ieSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWF4QnksCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgICB9LAogICAgICAgICAgc3VtOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU3VtLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICAgInN0YXJ0c193aXRoIjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvblN0YXJ0c1dpdGgsCiAgICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HXX0sIHt0eXBlczogW1RZUEVfU1RSSU5HXX1dfSwKICAgICAgICAgIG1pbjogewogICAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1pbiwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVIsIFRZUEVfQVJSQVlfU1RSSU5HXX1dfSwKICAgICAgICAgICJtaW5fYnkiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1pbkJ5LAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgICAgfSwKICAgICAgICAgIHR5cGU6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25UeXBlLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAga2V5czoge19mdW5jOiB0aGlzLl9mdW5jdGlvbktleXMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF19XX0sCiAgICAgICAgICB2YWx1ZXM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25WYWx1ZXMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF19XX0sCiAgICAgICAgICBzb3J0OiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU29ydCwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVlfU1RSSU5HLCBUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgICAic29ydF9ieSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU29ydEJ5LAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV19LCB7dHlwZXM6IFtUWVBFX0VYUFJFRl19XQogICAgICAgICAgfSwKICAgICAgICAgIGpvaW46IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Kb2luLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFsKICAgICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9TVFJJTkddfSwKICAgICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9BUlJBWV9TVFJJTkddfQogICAgICAgICAgICAgIF0KICAgICAgICAgIH0sCiAgICAgICAgICByZXZlcnNlOiB7CiAgICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uUmV2ZXJzZSwKICAgICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVldfV19LAogICAgICAgICAgInRvX2FycmF5Ijoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvQXJyYXksIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgICAidG9fc3RyaW5nIjoge19mdW5jOiB0aGlzLl9mdW5jdGlvblRvU3RyaW5nLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICAgInRvX251bWJlciI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub051bWJlciwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAgICJub3RfbnVsbCI6IHsKICAgICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25Ob3ROdWxsLAogICAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV0sIHZhcmlhZGljOiB0cnVlfV0KICAgICAgICAgIH0KICAgICAgfTsKICAgIH0KICAKICAgIFJ1bnRpbWUucHJvdG90eXBlID0gewogICAgICBjYWxsRnVuY3Rpb246IGZ1bmN0aW9uKG5hbWUsIHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBmdW5jdGlvbkVudHJ5ID0gdGhpcy5mdW5jdGlvblRhYmxlW25hbWVdOwogICAgICAgIGlmIChmdW5jdGlvbkVudHJ5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGZ1bmN0aW9uOiAiICsgbmFtZSArICIoKSIpOwogICAgICAgIH0KICAgICAgICB0aGlzLl92YWxpZGF0ZUFyZ3MobmFtZSwgcmVzb2x2ZWRBcmdzLCBmdW5jdGlvbkVudHJ5Ll9zaWduYXR1cmUpOwogICAgICAgIHJldHVybiBmdW5jdGlvbkVudHJ5Ll9mdW5jLmNhbGwodGhpcywgcmVzb2x2ZWRBcmdzKTsKICAgICAgfSwKICAKICAgICAgX3ZhbGlkYXRlQXJnczogZnVuY3Rpb24obmFtZSwgYXJncywgc2lnbmF0dXJlKSB7CiAgICAgICAgICAvLyBWYWxpZGF0aW5nIHRoZSBhcmdzIHJlcXVpcmVzIHZhbGlkYXRpbmcKICAgICAgICAgIC8vIHRoZSBjb3JyZWN0IGFyaXR5IGFuZCB0aGUgY29ycmVjdCB0eXBlIG9mIGVhY2ggYXJnLgogICAgICAgICAgLy8gSWYgdGhlIGxhc3QgYXJndW1lbnQgaXMgZGVjbGFyZWQgYXMgdmFyaWFkaWMsIHRoZW4gd2UgbmVlZAogICAgICAgICAgLy8gYSBtaW5pbXVtIG51bWJlciBvZiBhcmdzIHRvIGJlIHJlcXVpcmVkLiAgT3RoZXJ3aXNlIGl0IGhhcyB0bwogICAgICAgICAgLy8gYmUgYW4gZXhhY3QgYW1vdW50LgogICAgICAgICAgdmFyIHBsdXJhbGl6ZWQ7CiAgICAgICAgICBpZiAoc2lnbmF0dXJlW3NpZ25hdHVyZS5sZW5ndGggLSAxXS52YXJpYWRpYykgewogICAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IHNpZ25hdHVyZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgcGx1cmFsaXplZCA9IHNpZ25hdHVyZS5sZW5ndGggPT09IDEgPyAiIGFyZ3VtZW50IiA6ICIgYXJndW1lbnRzIjsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBcmd1bWVudEVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0YWtlcyBhdCBsZWFzdCIgKyBzaWduYXR1cmUubGVuZ3RoICsgcGx1cmFsaXplZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCAiICsgYXJncy5sZW5ndGgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYXJncy5sZW5ndGggIT09IHNpZ25hdHVyZS5sZW5ndGgpIHsKICAgICAgICAgICAgICBwbHVyYWxpemVkID0gc2lnbmF0dXJlLmxlbmd0aCA9PT0gMSA/ICIgYXJndW1lbnQiIDogIiBhcmd1bWVudHMiOwogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnRFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0YWtlcyAiICsgc2lnbmF0dXJlLmxlbmd0aCArIHBsdXJhbGl6ZWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCAiICsgYXJncy5sZW5ndGgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRTcGVjOwogICAgICAgICAgdmFyIGFjdHVhbFR5cGU7CiAgICAgICAgICB2YXIgdHlwZU1hdGNoZWQ7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpZ25hdHVyZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHR5cGVNYXRjaGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgY3VycmVudFNwZWMgPSBzaWduYXR1cmVbaV0udHlwZXM7CiAgICAgICAgICAgICAgYWN0dWFsVHlwZSA9IHRoaXMuX2dldFR5cGVOYW1lKGFyZ3NbaV0pOwogICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY3VycmVudFNwZWMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3R5cGVNYXRjaGVzKGFjdHVhbFR5cGUsIGN1cnJlbnRTcGVjW2pdLCBhcmdzW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgdHlwZU1hdGNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCF0eXBlTWF0Y2hlZCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlR5cGVFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXhwZWN0ZWQgYXJndW1lbnQgIiArIChpICsgMSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIiB0byBiZSB0eXBlICIgKyBjdXJyZW50U3BlYyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCB0eXBlICIgKyBhY3R1YWxUeXBlICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF90eXBlTWF0Y2hlczogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgYXJnVmFsdWUpIHsKICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BTlkpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9TVFJJTkcgfHwKICAgICAgICAgICAgICBleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9OVU1CRVIgfHwKICAgICAgICAgICAgICBleHBlY3RlZCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgIC8vIFRoZSBleHBlY3RlZCB0eXBlIGNhbiBlaXRoZXIganVzdCBiZSBhcnJheSwKICAgICAgICAgICAgICAvLyBvciBpdCBjYW4gcmVxdWlyZSBhIHNwZWNpZmljIHN1YnR5cGUgKGFycmF5IG9mIG51bWJlcnMpLgogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgLy8gVGhlIHNpbXBsZXN0IGNhc2UgaXMgaWYgImFycmF5IiB3aXRoIG5vIHN1YnR5cGUgaXMgc3BlY2lmaWVkLgogICAgICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsID09PSBUWVBFX0FSUkFZOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0dWFsID09PSBUWVBFX0FSUkFZKSB7CiAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSB3ZSBuZWVkIHRvIGNoZWNrIHN1YnR5cGVzLgogICAgICAgICAgICAgICAgICAvLyBJIHRoaW5rIHRoaXMgaGFzIHBvdGVudGlhbCB0byBiZSBpbXByb3ZlZC4KICAgICAgICAgICAgICAgICAgdmFyIHN1YnR5cGU7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9OVU1CRVIpIHsKICAgICAgICAgICAgICAgICAgICBzdWJ0eXBlID0gVFlQRV9OVU1CRVI7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVlfU1RSSU5HKSB7CiAgICAgICAgICAgICAgICAgICAgc3VidHlwZSA9IFRZUEVfU1RSSU5HOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnVmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fdHlwZU1hdGNoZXMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2dldFR5cGVOYW1lKGFyZ1ZhbHVlW2ldKSwgc3VidHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdWYWx1ZVtpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsID09PSBleHBlY3RlZDsKICAgICAgICAgIH0KICAgICAgfSwKICAgICAgX2dldFR5cGVOYW1lOiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpIHsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IFN0cmluZ10iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfU1RSSU5HOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgTnVtYmVyXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OVU1CRVI7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBBcnJheV0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfQVJSQVk7CiAgICAgICAgICAgICAgY2FzZSAiW29iamVjdCBCb29sZWFuXSI6CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9CT09MRUFOOwogICAgICAgICAgICAgIGNhc2UgIltvYmplY3QgTnVsbF0iOgogICAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfTlVMTDsKICAgICAgICAgICAgICBjYXNlICJbb2JqZWN0IE9iamVjdF0iOgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgaXQncyBhbiBleHByZWYuICBJZiBpdCBoYXMsIGl0J3MgYmVlbgogICAgICAgICAgICAgICAgLy8gdGFnZ2VkIHdpdGggYSBqbWVzcGF0aFR5cGUgYXR0ciBvZiAnRXhwcmVmJzsKICAgICAgICAgICAgICAgIGlmIChvYmouam1lc3BhdGhUeXBlID09PSBUT0tfRVhQUkVGKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX0VYUFJFRjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX09CSkVDVDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU3RhcnRzV2l0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmxhc3RJbmRleE9mKHJlc29sdmVkQXJnc1sxXSkgPT09IDA7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkVuZHNXaXRoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBzZWFyY2hTdHIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIgc3VmZml4ID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgICAgcmV0dXJuIHNlYXJjaFN0ci5pbmRleE9mKHN1ZmZpeCwgc2VhcmNoU3RyLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uUmV2ZXJzZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX1NUUklORykgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxTdHIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICAgIHZhciByZXZlcnNlZFN0ciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBpID0gb3JpZ2luYWxTdHIubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIHJldmVyc2VkU3RyICs9IG9yaWdpbmFsU3RyW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXZlcnNlZFN0cjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByZXZlcnNlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdLnNsaWNlKDApOwogICAgICAgICAgICByZXZlcnNlZEFycmF5LnJldmVyc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VkQXJyYXk7CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkFiczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgcmV0dXJuIE1hdGguYWJzKHJlc29sdmVkQXJnc1swXSk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbkNlaWw6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgcmV0dXJuIE1hdGguY2VpbChyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Bdmc6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIHN1bSA9IDA7CiAgICAgICAgICB2YXIgaW5wdXRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHN1bSArPSBpbnB1dEFycmF5W2ldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1bSAvIGlucHV0QXJyYXkubGVuZ3RoOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Db250YWluczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmluZGV4T2YocmVzb2x2ZWRBcmdzWzFdKSA+PSAwOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25GbG9vcjogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25MZW5ndGg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICBpZiAoIWlzT2JqZWN0KHJlc29sdmVkQXJnc1swXSkpIHsKICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmxlbmd0aDsKICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAvLyBBcyBmYXIgYXMgSSBjYW4gdGVsbCwgdGhlcmUncyBubyB3YXkgdG8gZ2V0IHRoZSBsZW5ndGgKICAgICAgICAgICAvLyBvZiBhbiBvYmplY3Qgd2l0aG91dCBPKG4pIGl0ZXJhdGlvbiB0aHJvdWdoIHRoZSBvYmplY3QuCiAgICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHJlc29sdmVkQXJnc1swXSkubGVuZ3RoOwogICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1hcDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIG1hcHBlZCA9IFtdOwogICAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG1hcHBlZC5wdXNoKGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGVsZW1lbnRzW2ldKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXBwZWQ7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1lcmdlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgbWVyZ2VkID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlZEFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gcmVzb2x2ZWRBcmdzW2ldOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIGN1cnJlbnQpIHsKICAgICAgICAgICAgbWVyZ2VkW2tleV0gPSBjdXJyZW50W2tleV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXJnZWQ7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1heDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgaWYgKHJlc29sdmVkQXJnc1swXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF1bMF0pOwogICAgICAgICAgaWYgKHR5cGVOYW1lID09PSBUWVBFX05VTUJFUikgewogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXguYXBwbHkoTWF0aCwgcmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50cyA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgICAgdmFyIG1heEVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG1heEVsZW1lbnQubG9jYWxlQ29tcGFyZShlbGVtZW50c1tpXSkgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4RWxlbWVudCA9IGVsZW1lbnRzW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXhFbGVtZW50OwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWluOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBpZiAocmVzb2x2ZWRBcmdzWzBdLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXVswXSk7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCByZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICB2YXIgbWluRWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudHNbaV0ubG9jYWxlQ29tcGFyZShtaW5FbGVtZW50KSA8IDApIHsKICAgICAgICAgICAgICAgICAgICBtaW5FbGVtZW50ID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1pbkVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU3VtOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgc3VtID0gMDsKICAgICAgICB2YXIgbGlzdFRvU3VtID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdFRvU3VtLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBzdW0gKz0gbGlzdFRvU3VtW2ldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VtOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25UeXBlOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHN3aXRjaCAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSkgewogICAgICAgICAgICBjYXNlIFRZUEVfTlVNQkVSOgogICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgY2FzZSBUWVBFX1NUUklORzoKICAgICAgICAgICAgICByZXR1cm4gInN0cmluZyI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9BUlJBWToKICAgICAgICAgICAgICByZXR1cm4gImFycmF5IjsKICAgICAgICAgICAgY2FzZSBUWVBFX09CSkVDVDoKICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9CT09MRUFOOgogICAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7CiAgICAgICAgICAgIGNhc2UgVFlQRV9FWFBSRUY6CiAgICAgICAgICAgICAgcmV0dXJuICJleHByZWYiOwogICAgICAgICAgICBjYXNlIFRZUEVfTlVMTDoKICAgICAgICAgICAgICByZXR1cm4gIm51bGwiOwogICAgICAgICAgfQogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25LZXlzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhyZXNvbHZlZEFyZ3NbMF0pOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25WYWx1ZXM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgdmFyIG9iaiA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhbHVlcy5wdXNoKG9ialtrZXlzW2ldXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICB9LAogIAogICAgICBfZnVuY3Rpb25Kb2luOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciBqb2luQ2hhciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIHZhciBsaXN0Sm9pbiA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICAgIHJldHVybiBsaXN0Sm9pbi5qb2luKGpvaW5DaGFyKTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVG9BcnJheTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBbcmVzb2x2ZWRBcmdzWzBdXTsKICAgICAgICAgIH0KICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uVG9TdHJpbmc6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgICAgaWYgKHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSkgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB9CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblRvTnVtYmVyOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICAgIHZhciB0eXBlTmFtZSA9IHRoaXMuX2dldFR5cGVOYW1lKHJlc29sdmVkQXJnc1swXSk7CiAgICAgICAgICB2YXIgY29udmVydGVkVmFsdWU7CiAgICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZU5hbWUgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICAgICAgY29udmVydGVkVmFsdWUgPSArcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICAgIGlmICghaXNOYU4oY29udmVydGVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb252ZXJ0ZWRWYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTm90TnVsbDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmICh0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbaV0pICE9PSBUWVBFX05VTEwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1tpXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uU29ydDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc29ydGVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICBzb3J0ZWRBcnJheS5zb3J0KCk7CiAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvblNvcnRCeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgICB2YXIgc29ydGVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgICBpZiAoc29ydGVkQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICAgIHZhciByZXF1aXJlZFR5cGUgPSB0aGlzLl9nZXRUeXBlTmFtZSgKICAgICAgICAgICAgICBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBzb3J0ZWRBcnJheVswXSkpOwogICAgICAgICAgaWYgKFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddLmluZGV4T2YocmVxdWlyZWRUeXBlKSA8IDApIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlR5cGVFcnJvciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICAgICAgLy8gSW4gb3JkZXIgdG8gZ2V0IGEgc3RhYmxlIHNvcnQgb3V0IG9mIGFuIHVuc3RhYmxlCiAgICAgICAgICAvLyBzb3J0IGFsZ29yaXRobSwgd2UgZGVjb3JhdGUvc29ydC91bmRlY29yYXRlIChEU1UpCiAgICAgICAgICAvLyBieSBjcmVhdGluZyBhIG5ldyBsaXN0IG9mIFtpbmRleCwgZWxlbWVudF0gcGFpcnMuCiAgICAgICAgICAvLyBJbiB0aGUgY21wIGZ1bmN0aW9uLCBpZiB0aGUgZXZhbHVhdGVkIGVsZW1lbnRzIGFyZQogICAgICAgICAgLy8gZXF1YWwsIHRoZW4gdGhlIGluZGV4IHdpbGwgYmUgdXNlZCBhcyB0aGUgdGllYnJlYWtlci4KICAgICAgICAgIC8vIEFmdGVyIHRoZSBkZWNvcmF0ZWQgbGlzdCBoYXMgYmVlbiBzb3J0ZWQsIGl0IHdpbGwgYmUKICAgICAgICAgIC8vIHVuZGVjb3JhdGVkIHRvIGV4dHJhY3QgdGhlIG9yaWdpbmFsIGVsZW1lbnRzLgogICAgICAgICAgdmFyIGRlY29yYXRlZCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBkZWNvcmF0ZWQucHVzaChbaSwgc29ydGVkQXJyYXlbaV1dKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlY29yYXRlZC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgdmFyIGV4cHJBID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgYVsxXSk7CiAgICAgICAgICAgIHZhciBleHByQiA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGJbMV0pOwogICAgICAgICAgICBpZiAodGhhdC5fZ2V0VHlwZU5hbWUoZXhwckEpICE9PSByZXF1aXJlZFR5cGUpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAiVHlwZUVycm9yOiBleHBlY3RlZCAiICsgcmVxdWlyZWRUeXBlICsgIiwgcmVjZWl2ZWQgIiArCiAgICAgICAgICAgICAgICAgICAgdGhhdC5fZ2V0VHlwZU5hbWUoZXhwckEpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGF0Ll9nZXRUeXBlTmFtZShleHByQikgIT09IHJlcXVpcmVkVHlwZSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAgICJUeXBlRXJyb3I6IGV4cGVjdGVkICIgKyByZXF1aXJlZFR5cGUgKyAiLCByZWNlaXZlZCAiICsKICAgICAgICAgICAgICAgICAgICB0aGF0Ll9nZXRUeXBlTmFtZShleHByQikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleHByQSA+IGV4cHJCKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwckEgPCBleHByQikgewogICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBJZiB0aGV5J3JlIGVxdWFsIGNvbXBhcmUgdGhlIGl0ZW1zIGJ5IHRoZWlyCiAgICAgICAgICAgICAgLy8gb3JkZXIgdG8gbWFpbnRhaW4gcmVsYXRpdmUgb3JkZXIgb2YgZXF1YWwga2V5cwogICAgICAgICAgICAgIC8vIChpLmUuIHRvIGdldCBhIHN0YWJsZSBzb3J0KS4KICAgICAgICAgICAgICByZXR1cm4gYVswXSAtIGJbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgLy8gVW5kZWNvcmF0ZTogZXh0cmFjdCBvdXQgdGhlIG9yaWdpbmFsIGxpc3QgZWxlbWVudHMuCiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGRlY29yYXRlZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICBzb3J0ZWRBcnJheVtqXSA9IGRlY29yYXRlZFtqXVsxXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgICAgfSwKICAKICAgICAgX2Z1bmN0aW9uTWF4Qnk6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHZhciByZXNvbHZlZEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBrZXlGdW5jdGlvbiA9IHRoaXMuY3JlYXRlS2V5RnVuY3Rpb24oZXhwcmVmTm9kZSwgW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10pOwogICAgICAgIHZhciBtYXhOdW1iZXIgPSAtSW5maW5pdHk7CiAgICAgICAgdmFyIG1heFJlY29yZDsKICAgICAgICB2YXIgY3VycmVudDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGN1cnJlbnQgPSBrZXlGdW5jdGlvbihyZXNvbHZlZEFycmF5W2ldKTsKICAgICAgICAgIGlmIChjdXJyZW50ID4gbWF4TnVtYmVyKSB7CiAgICAgICAgICAgIG1heE51bWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICAgIG1heFJlY29yZCA9IHJlc29sdmVkQXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXhSZWNvcmQ7CiAgICAgIH0sCiAgCiAgICAgIF9mdW5jdGlvbk1pbkJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgZXhwcmVmTm9kZSA9IHJlc29sdmVkQXJnc1sxXTsKICAgICAgICB2YXIgcmVzb2x2ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIga2V5RnVuY3Rpb24gPSB0aGlzLmNyZWF0ZUtleUZ1bmN0aW9uKGV4cHJlZk5vZGUsIFtUWVBFX05VTUJFUiwgVFlQRV9TVFJJTkddKTsKICAgICAgICB2YXIgbWluTnVtYmVyID0gSW5maW5pdHk7CiAgICAgICAgdmFyIG1pblJlY29yZDsKICAgICAgICB2YXIgY3VycmVudDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGN1cnJlbnQgPSBrZXlGdW5jdGlvbihyZXNvbHZlZEFycmF5W2ldKTsKICAgICAgICAgIGlmIChjdXJyZW50IDwgbWluTnVtYmVyKSB7CiAgICAgICAgICAgIG1pbk51bWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICAgIG1pblJlY29yZCA9IHJlc29sdmVkQXJyYXlbaV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtaW5SZWNvcmQ7CiAgICAgIH0sCiAgCiAgICAgIGNyZWF0ZUtleUZ1bmN0aW9uOiBmdW5jdGlvbihleHByZWZOb2RlLCBhbGxvd2VkVHlwZXMpIHsKICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgICAgdmFyIGtleUZ1bmMgPSBmdW5jdGlvbih4KSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIHgpOwogICAgICAgICAgaWYgKGFsbG93ZWRUeXBlcy5pbmRleE9mKHRoYXQuX2dldFR5cGVOYW1lKGN1cnJlbnQpKSA8IDApIHsKICAgICAgICAgICAgdmFyIG1zZyA9ICJUeXBlRXJyb3I6IGV4cGVjdGVkIG9uZSBvZiAiICsgYWxsb3dlZFR5cGVzICsKICAgICAgICAgICAgICAgICAgICAgICIsIHJlY2VpdmVkICIgKyB0aGF0Ll9nZXRUeXBlTmFtZShjdXJyZW50KTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3VycmVudDsKICAgICAgICB9OwogICAgICAgIHJldHVybiBrZXlGdW5jOwogICAgICB9CiAgCiAgICB9OwogIAogICAgZnVuY3Rpb24gY29tcGlsZShzdHJlYW0pIHsKICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIoKTsKICAgICAgdmFyIGFzdCA9IHBhcnNlci5wYXJzZShzdHJlYW0pOwogICAgICByZXR1cm4gYXN0OwogICAgfQogIAogICAgZnVuY3Rpb24gdG9rZW5pemUoc3RyZWFtKSB7CiAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCk7CiAgICAgICAgcmV0dXJuIGxleGVyLnRva2VuaXplKHN0cmVhbSk7CiAgICB9CiAgCiAgICBmdW5jdGlvbiBzZWFyY2goZGF0YSwgZXhwcmVzc2lvbikgewogICAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKCk7CiAgICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBpbXByb3ZlZC4gIEJvdGggdGhlIGludGVycHJldGVyIGFuZCBydW50aW1lIGRlcGVuZCBvbgogICAgICAgIC8vIGVhY2ggb3RoZXIuICBUaGUgcnVudGltZSBuZWVkcyB0aGUgaW50ZXJwcmV0ZXIgdG8gc3VwcG9ydCBleHByZWZzLgogICAgICAgIC8vIFRoZXJlJ3MgbGlrZWx5IGEgY2xlYW4gd2F5IHRvIGF2b2lkIHRoZSBjeWNsaWMgZGVwZW5kZW5jeS4KICAgICAgICB2YXIgcnVudGltZSA9IG5ldyBSdW50aW1lKCk7CiAgICAgICAgdmFyIGludGVycHJldGVyID0gbmV3IFRyZWVJbnRlcnByZXRlcihydW50aW1lKTsKICAgICAgICBydW50aW1lLl9pbnRlcnByZXRlciA9IGludGVycHJldGVyOwogICAgICAgIHZhciBub2RlID0gcGFyc2VyLnBhcnNlKGV4cHJlc3Npb24pOwogICAgICAgIHJldHVybiBpbnRlcnByZXRlci5zZWFyY2gobm9kZSwgZGF0YSk7CiAgICB9CiAgCiAgICBleHBvcnRzLnRva2VuaXplID0gdG9rZW5pemU7CiAgICBleHBvcnRzLmNvbXBpbGUgPSBjb21waWxlOwogICAgZXhwb3J0cy5zZWFyY2ggPSBzZWFyY2g7CiAgICBleHBvcnRzLnN0cmljdERlZXBFcXVhbCA9IHN0cmljdERlZXBFcXVhbDsKICB9KSh0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgPyB0aGlzLmptZXNwYXRoID0ge30gOiBleHBvcnRzKTsKICAKICB9LHt9XSw4NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gc2hpbSBmb3IgdXNpbmcgcHJvY2VzcyBpbiBicm93c2VyCiAgdmFyIHByb2Nlc3MgPSBtb2R1bGUuZXhwb3J0cyA9IHt9OwogIAogIC8vIGNhY2hlZCBmcm9tIHdoYXRldmVyIGdsb2JhbCBpcyBwcmVzZW50IHNvIHRoYXQgdGVzdCBydW5uZXJzIHRoYXQgc3R1YiBpdAogIC8vIGRvbid0IGJyZWFrIHRoaW5ncy4gIEJ1dCB3ZSBuZWVkIHRvIHdyYXAgaXQgaW4gYSB0cnkgY2F0Y2ggaW4gY2FzZSBpdCBpcwogIC8vIHdyYXBwZWQgaW4gc3RyaWN0IG1vZGUgY29kZSB3aGljaCBkb2Vzbid0IGRlZmluZSBhbnkgZ2xvYmFscy4gIEl0J3MgaW5zaWRlIGEKICAvLyBmdW5jdGlvbiBiZWNhdXNlIHRyeS9jYXRjaGVzIGRlb3B0aW1pemUgaW4gY2VydGFpbiBlbmdpbmVzLgogIAogIHZhciBjYWNoZWRTZXRUaW1lb3V0OwogIHZhciBjYWNoZWRDbGVhclRpbWVvdXQ7CiAgCiAgZnVuY3Rpb24gZGVmYXVsdFNldFRpbW91dCgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdzZXRUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7CiAgfQogIGZ1bmN0aW9uIGRlZmF1bHRDbGVhclRpbWVvdXQgKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NsZWFyVGltZW91dCBoYXMgbm90IGJlZW4gZGVmaW5lZCcpOwogIH0KICAoZnVuY3Rpb24gKCkgewogICAgICB0cnkgewogICAgICAgICAgaWYgKHR5cGVvZiBzZXRUaW1lb3V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0OwogICAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gZGVmYXVsdFNldFRpbW91dDsKICAgICAgfQogICAgICB0cnkgewogICAgICAgICAgaWYgKHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGRlZmF1bHRDbGVhclRpbWVvdXQ7CiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGRlZmF1bHRDbGVhclRpbWVvdXQ7CiAgICAgIH0KICB9ICgpKQogIGZ1bmN0aW9uIHJ1blRpbWVvdXQoZnVuKSB7CiAgICAgIGlmIChjYWNoZWRTZXRUaW1lb3V0ID09PSBzZXRUaW1lb3V0KSB7CiAgICAgICAgICAvL25vcm1hbCBlbnZpcm9tZW50cyBpbiBzYW5lIHNpdHVhdGlvbnMKICAgICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0KICAgICAgLy8gaWYgc2V0VGltZW91dCB3YXNuJ3QgYXZhaWxhYmxlIGJ1dCB3YXMgbGF0dGVyIGRlZmluZWQKICAgICAgaWYgKChjYWNoZWRTZXRUaW1lb3V0ID09PSBkZWZhdWx0U2V0VGltb3V0IHx8ICFjYWNoZWRTZXRUaW1lb3V0KSAmJiBzZXRUaW1lb3V0KSB7CiAgICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gc2V0VGltZW91dDsKICAgICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICAgIC8vIHdoZW4gd2hlbiBzb21lYm9keSBoYXMgc2NyZXdlZCB3aXRoIHNldFRpbWVvdXQgYnV0IG5vIEkuRS4gbWFkZG5lc3MKICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0KGZ1biwgMCk7CiAgICAgIH0gY2F0Y2goZSl7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIC8vIFdoZW4gd2UgYXJlIGluIEkuRS4gYnV0IHRoZSBzY3JpcHQgaGFzIGJlZW4gZXZhbGVkIHNvIEkuRS4gZG9lc24ndCB0cnVzdCB0aGUgZ2xvYmFsIG9iamVjdCB3aGVuIGNhbGxlZCBub3JtYWxseQogICAgICAgICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0LmNhbGwobnVsbCwgZnVuLCAwKTsKICAgICAgICAgIH0gY2F0Y2goZSl7CiAgICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2hlbiBpdCdzIGEgdmVyc2lvbiBvZiBJLkUuIHRoYXQgbXVzdCBoYXZlIHRoZSBnbG9iYWwgb2JqZWN0IGZvciAndGhpcycsIGhvcGZ1bGx5IG91ciBjb250ZXh0IGNvcnJlY3Qgb3RoZXJ3aXNlIGl0IHdpbGwgdGhyb3cgYSBnbG9iYWwgZXJyb3IKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dC5jYWxsKHRoaXMsIGZ1biwgMCk7CiAgICAgICAgICB9CiAgICAgIH0KICAKICAKICB9CiAgZnVuY3Rpb24gcnVuQ2xlYXJUaW1lb3V0KG1hcmtlcikgewogICAgICBpZiAoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBjbGVhclRpbWVvdXQpIHsKICAgICAgICAgIC8vbm9ybWFsIGVudmlyb21lbnRzIGluIHNhbmUgc2l0dWF0aW9ucwogICAgICAgICAgcmV0dXJuIGNsZWFyVGltZW91dChtYXJrZXIpOwogICAgICB9CiAgICAgIC8vIGlmIGNsZWFyVGltZW91dCB3YXNuJ3QgYXZhaWxhYmxlIGJ1dCB3YXMgbGF0dGVyIGRlZmluZWQKICAgICAgaWYgKChjYWNoZWRDbGVhclRpbWVvdXQgPT09IGRlZmF1bHRDbGVhclRpbWVvdXQgfHwgIWNhY2hlZENsZWFyVGltZW91dCkgJiYgY2xlYXJUaW1lb3V0KSB7CiAgICAgICAgICBjYWNoZWRDbGVhclRpbWVvdXQgPSBjbGVhclRpbWVvdXQ7CiAgICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICAgIC8vIHdoZW4gd2hlbiBzb21lYm9keSBoYXMgc2NyZXdlZCB3aXRoIHNldFRpbWVvdXQgYnV0IG5vIEkuRS4gbWFkZG5lc3MKICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQobWFya2VyKTsKICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIC8vIFdoZW4gd2UgYXJlIGluIEkuRS4gYnV0IHRoZSBzY3JpcHQgaGFzIGJlZW4gZXZhbGVkIHNvIEkuRS4gZG9lc24ndCAgdHJ1c3QgdGhlIGdsb2JhbCBvYmplY3Qgd2hlbiBjYWxsZWQgbm9ybWFsbHkKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0LmNhbGwobnVsbCwgbWFya2VyKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUgYnV0IHdoZW4gaXQncyBhIHZlcnNpb24gb2YgSS5FLiB0aGF0IG11c3QgaGF2ZSB0aGUgZ2xvYmFsIG9iamVjdCBmb3IgJ3RoaXMnLCBob3BmdWxseSBvdXIgY29udGV4dCBjb3JyZWN0IG90aGVyd2lzZSBpdCB3aWxsIHRocm93IGEgZ2xvYmFsIGVycm9yLgogICAgICAgICAgICAgIC8vIFNvbWUgdmVyc2lvbnMgb2YgSS5FLiBoYXZlIGRpZmZlcmVudCBydWxlcyBmb3IgY2xlYXJUaW1lb3V0IHZzIHNldFRpbWVvdXQKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0LmNhbGwodGhpcywgbWFya2VyKTsKICAgICAgICAgIH0KICAgICAgfQogIAogIAogIAogIH0KICB2YXIgcXVldWUgPSBbXTsKICB2YXIgZHJhaW5pbmcgPSBmYWxzZTsKICB2YXIgY3VycmVudFF1ZXVlOwogIHZhciBxdWV1ZUluZGV4ID0gLTE7CiAgCiAgZnVuY3Rpb24gY2xlYW5VcE5leHRUaWNrKCkgewogICAgICBpZiAoIWRyYWluaW5nIHx8ICFjdXJyZW50UXVldWUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBkcmFpbmluZyA9IGZhbHNlOwogICAgICBpZiAoY3VycmVudFF1ZXVlLmxlbmd0aCkgewogICAgICAgICAgcXVldWUgPSBjdXJyZW50UXVldWUuY29uY2F0KHF1ZXVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHF1ZXVlSW5kZXggPSAtMTsKICAgICAgfQogICAgICBpZiAocXVldWUubGVuZ3RoKSB7CiAgICAgICAgICBkcmFpblF1ZXVlKCk7CiAgICAgIH0KICB9CiAgCiAgZnVuY3Rpb24gZHJhaW5RdWV1ZSgpIHsKICAgICAgaWYgKGRyYWluaW5nKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRpbWVvdXQgPSBydW5UaW1lb3V0KGNsZWFuVXBOZXh0VGljayk7CiAgICAgIGRyYWluaW5nID0gdHJ1ZTsKICAKICAgICAgdmFyIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgICAgd2hpbGUobGVuKSB7CiAgICAgICAgICBjdXJyZW50UXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHF1ZXVlID0gW107CiAgICAgICAgICB3aGlsZSAoKytxdWV1ZUluZGV4IDwgbGVuKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50UXVldWVbcXVldWVJbmRleF0ucnVuKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgICAgICAgbGVuID0gcXVldWUubGVuZ3RoOwogICAgICB9CiAgICAgIGN1cnJlbnRRdWV1ZSA9IG51bGw7CiAgICAgIGRyYWluaW5nID0gZmFsc2U7CiAgICAgIHJ1bkNsZWFyVGltZW91dCh0aW1lb3V0KTsKICB9CiAgCiAgcHJvY2Vzcy5uZXh0VGljayA9IGZ1bmN0aW9uIChmdW4pIHsKICAgICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCAtIDEpOwogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcXVldWUucHVzaChuZXcgSXRlbShmdW4sIGFyZ3MpKTsKICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA9PT0gMSAmJiAhZHJhaW5pbmcpIHsKICAgICAgICAgIHJ1blRpbWVvdXQoZHJhaW5RdWV1ZSk7CiAgICAgIH0KICB9OwogIAogIC8vIHY4IGxpa2VzIHByZWRpY3RpYmxlIG9iamVjdHMKICBmdW5jdGlvbiBJdGVtKGZ1biwgYXJyYXkpIHsKICAgICAgdGhpcy5mdW4gPSBmdW47CiAgICAgIHRoaXMuYXJyYXkgPSBhcnJheTsKICB9CiAgSXRlbS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKCkgewogICAgICB0aGlzLmZ1bi5hcHBseShudWxsLCB0aGlzLmFycmF5KTsKICB9OwogIHByb2Nlc3MudGl0bGUgPSAnYnJvd3Nlcic7CiAgcHJvY2Vzcy5icm93c2VyID0gdHJ1ZTsKICBwcm9jZXNzLmVudiA9IHt9OwogIHByb2Nlc3MuYXJndiA9IFtdOwogIHByb2Nlc3MudmVyc2lvbiA9ICcnOyAvLyBlbXB0eSBzdHJpbmcgdG8gYXZvaWQgcmVnZXhwIGlzc3VlcwogIHByb2Nlc3MudmVyc2lvbnMgPSB7fTsKICAKICBmdW5jdGlvbiBub29wKCkge30KICAKICBwcm9jZXNzLm9uID0gbm9vcDsKICBwcm9jZXNzLmFkZExpc3RlbmVyID0gbm9vcDsKICBwcm9jZXNzLm9uY2UgPSBub29wOwogIHByb2Nlc3Mub2ZmID0gbm9vcDsKICBwcm9jZXNzLnJlbW92ZUxpc3RlbmVyID0gbm9vcDsKICBwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7CiAgcHJvY2Vzcy5lbWl0ID0gbm9vcDsKICBwcm9jZXNzLnByZXBlbmRMaXN0ZW5lciA9IG5vb3A7CiAgcHJvY2Vzcy5wcmVwZW5kT25jZUxpc3RlbmVyID0gbm9vcDsKICAKICBwcm9jZXNzLmxpc3RlbmVycyA9IGZ1bmN0aW9uIChuYW1lKSB7IHJldHVybiBbXSB9CiAgCiAgcHJvY2Vzcy5iaW5kaW5nID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmJpbmRpbmcgaXMgbm90IHN1cHBvcnRlZCcpOwogIH07CiAgCiAgcHJvY2Vzcy5jd2QgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAnLycgfTsKICBwcm9jZXNzLmNoZGlyID0gZnVuY3Rpb24gKGRpcikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuY2hkaXIgaXMgbm90IHN1cHBvcnRlZCcpOwogIH07CiAgcHJvY2Vzcy51bWFzayA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gMDsgfTsKICAKICB9LHt9XSw4NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIC8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKICAvLyBvYmouaGFzT3duUHJvcGVydHkocHJvcCkgd2lsbCBicmVhay4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb3llbnQvbm9kZS9pc3N1ZXMvMTcwNwogIGZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKHFzLCBzZXAsIGVxLCBvcHRpb25zKSB7CiAgICBzZXAgPSBzZXAgfHwgJyYnOwogICAgZXEgPSBlcSB8fCAnPSc7CiAgICB2YXIgb2JqID0ge307CiAgCiAgICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG9iajsKICAgIH0KICAKICAgIHZhciByZWdleHAgPSAvXCsvZzsKICAgIHFzID0gcXMuc3BsaXQoc2VwKTsKICAKICAgIHZhciBtYXhLZXlzID0gMTAwMDsKICAgIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLm1heEtleXMgPT09ICdudW1iZXInKSB7CiAgICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgICB9CiAgCiAgICB2YXIgbGVuID0gcXMubGVuZ3RoOwogICAgLy8gbWF4S2V5cyA8PSAwIG1lYW5zIHRoYXQgd2Ugc2hvdWxkIG5vdCBsaW1pdCBrZXlzIGNvdW50CiAgICBpZiAobWF4S2V5cyA+IDAgJiYgbGVuID4gbWF4S2V5cykgewogICAgICBsZW4gPSBtYXhLZXlzOwogICAgfQogIAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICB2YXIgeCA9IHFzW2ldLnJlcGxhY2UocmVnZXhwLCAnJTIwJyksCiAgICAgICAgICBpZHggPSB4LmluZGV4T2YoZXEpLAogICAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKICAKICAgICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgICAgdnN0ciA9IHguc3Vic3RyKGlkeCArIDEpOwogICAgICB9IGVsc2UgewogICAgICAgIGtzdHIgPSB4OwogICAgICAgIHZzdHIgPSAnJzsKICAgICAgfQogIAogICAgICBrID0gZGVjb2RlVVJJQ29tcG9uZW50KGtzdHIpOwogICAgICB2ID0gZGVjb2RlVVJJQ29tcG9uZW50KHZzdHIpOwogIAogICAgICBpZiAoIWhhc093blByb3BlcnR5KG9iaiwgaykpIHsKICAgICAgICBvYmpba10gPSB2OwogICAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIG9ialtrXS5wdXNoKHYpOwogICAgICB9IGVsc2UgewogICAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gb2JqOwogIH07CiAgCiAgdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uICh4cykgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh4cykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKICAKICB9LHt9XSw4ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCiAgLy8KICAvLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQogIC8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKICAvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiAgLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAogIC8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKICAvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKICAvLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKICAvLwogIC8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCiAgLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAgLy8KICAvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwogIC8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKICAvLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCiAgLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCiAgLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCiAgLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQogIC8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiAgCiAgJ3VzZSBzdHJpY3QnOwogIAogIHZhciBzdHJpbmdpZnlQcmltaXRpdmUgPSBmdW5jdGlvbih2KSB7CiAgICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgcmV0dXJuIHY7CiAgCiAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgIHJldHVybiB2ID8gJ3RydWUnIDogJ2ZhbHNlJzsKICAKICAgICAgY2FzZSAnbnVtYmVyJzoKICAgICAgICByZXR1cm4gaXNGaW5pdGUodikgPyB2IDogJyc7CiAgCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuICcnOwogICAgfQogIH07CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICAgIHNlcCA9IHNlcCB8fCAnJic7CiAgICBlcSA9IGVxIHx8ICc9JzsKICAgIGlmIChvYmogPT09IG51bGwpIHsKICAgICAgb2JqID0gdW5kZWZpbmVkOwogICAgfQogIAogICAgaWYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnKSB7CiAgICAgIHJldHVybiBtYXAob2JqZWN0S2V5cyhvYmopLCBmdW5jdGlvbihrKSB7CiAgICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgICBpZiAoaXNBcnJheShvYmpba10pKSB7CiAgICAgICAgICByZXR1cm4gbWFwKG9ialtrXSwgZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgICB9CiAgICAgIH0pLmpvaW4oc2VwKTsKICAKICAgIH0KICAKICAgIGlmICghbmFtZSkgcmV0dXJuICcnOwogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUobmFtZSkpICsgZXEgKwogICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqKSk7CiAgfTsKICAKICB2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKHhzKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9OwogIAogIGZ1bmN0aW9uIG1hcCAoeHMsIGYpIHsKICAgIGlmICh4cy5tYXApIHJldHVybiB4cy5tYXAoZik7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHJlcy5wdXNoKGYoeHNbaV0sIGkpKTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfQogIAogIHZhciBvYmplY3RLZXlzID0gT2JqZWN0LmtleXMgfHwgZnVuY3Rpb24gKG9iaikgewogICAgdmFyIHJlcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgcmVzLnB1c2goa2V5KTsKICAgIH0KICAgIHJldHVybiByZXM7CiAgfTsKICAKICB9LHt9XSw4OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgJ3VzZSBzdHJpY3QnOwogIAogIGV4cG9ydHMuZGVjb2RlID0gZXhwb3J0cy5wYXJzZSA9IHJlcXVpcmUoJy4vZGVjb2RlJyk7CiAgZXhwb3J0cy5lbmNvZGUgPSBleHBvcnRzLnN0cmluZ2lmeSA9IHJlcXVpcmUoJy4vZW5jb2RlJyk7CiAgCiAgfSx7Ii4vZGVjb2RlIjo4NywiLi9lbmNvZGUiOjg4fV0sOTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIC8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgogIC8vCiAgLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKICAvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiAgLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwogIC8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKICAvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CiAgLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCiAgLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAgLy8KICAvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAogIC8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogIC8vCiAgLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKICAvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiAgLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgogIC8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAogIC8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgogIC8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKICAvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgogIAogICd1c2Ugc3RyaWN0JzsKICAKICAvLyBJZiBvYmouaGFzT3duUHJvcGVydHkgaGFzIGJlZW4gb3ZlcnJpZGRlbiwgdGhlbiBjYWxsaW5nCiAgLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCiAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vam95ZW50L25vZGUvaXNzdWVzLzE3MDcKICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgdmFyIG9iaiA9IHt9OwogIAogICAgaWYgKHR5cGVvZiBxcyAhPT0gJ3N0cmluZycgfHwgcXMubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiBvYmo7CiAgICB9CiAgCiAgICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgICBxcyA9IHFzLnNwbGl0KHNlcCk7CiAgCiAgICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgICBpZiAob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5tYXhLZXlzID09PSAnbnVtYmVyJykgewogICAgICBtYXhLZXlzID0gb3B0aW9ucy5tYXhLZXlzOwogICAgfQogIAogICAgdmFyIGxlbiA9IHFzLmxlbmd0aDsKICAgIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogICAgaWYgKG1heEtleXMgPiAwICYmIGxlbiA+IG1heEtleXMpIHsKICAgICAgbGVuID0gbWF4S2V5czsKICAgIH0KICAKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgICAgaWR4ID0geC5pbmRleE9mKGVxKSwKICAgICAgICAgIGtzdHIsIHZzdHIsIGssIHY7CiAgCiAgICAgIGlmIChpZHggPj0gMCkgewogICAgICAgIGtzdHIgPSB4LnN1YnN0cigwLCBpZHgpOwogICAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBrc3RyID0geDsKICAgICAgICB2c3RyID0gJyc7CiAgICAgIH0KICAKICAgICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgICAgdiA9IGRlY29kZVVSSUNvbXBvbmVudCh2c3RyKTsKICAKICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgICAgb2JqW2tdID0gdjsKICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG9ialtrXSkpIHsKICAgICAgICBvYmpba10ucHVzaCh2KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpba10gPSBbb2JqW2tdLCB2XTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIG9iajsKICB9OwogIAogIH0se31dLDkxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICAndXNlIHN0cmljdCc7CiAgCiAgdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICAgIHN3aXRjaCAodHlwZW9mIHYpIHsKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gdjsKICAKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwogIAogICAgICBjYXNlICdudW1iZXInOgogICAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKICAKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gJyc7CiAgICB9CiAgfTsKICAKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKG9iaiwgc2VwLCBlcSwgbmFtZSkgewogICAgc2VwID0gc2VwIHx8ICcmJzsKICAgIGVxID0gZXEgfHwgJz0nOwogICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICBvYmogPSB1bmRlZmluZWQ7CiAgICB9CiAgCiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iaikubWFwKGZ1bmN0aW9uKGspIHsKICAgICAgICB2YXIga3MgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKGspKSArIGVxOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KG9ialtrXSkpIHsKICAgICAgICAgIHJldHVybiBvYmpba10ubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZSh2KSk7CiAgICAgICAgICB9KS5qb2luKHNlcCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUob2JqW2tdKSk7CiAgICAgICAgfQogICAgICB9KS5qb2luKHNlcCk7CiAgCiAgICB9CiAgCiAgICBpZiAoIW5hbWUpIHJldHVybiAnJzsKICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG5hbWUpKSArIGVxICsKICAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9iaikpOwogIH07CiAgCiAgfSx7fV0sOTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGFyZ3VtZW50c1s0XVs4OV1bMF0uYXBwbHkoZXhwb3J0cyxhcmd1bWVudHMpCiAgfSx7Ii4vZGVjb2RlIjo5MCwiLi9lbmNvZGUiOjkxLCJkdXAiOjg5fV0sOTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAoc2V0SW1tZWRpYXRlLGNsZWFySW1tZWRpYXRlKXsoZnVuY3Rpb24gKCl7CiAgdmFyIG5leHRUaWNrID0gcmVxdWlyZSgncHJvY2Vzcy9icm93c2VyLmpzJykubmV4dFRpY2s7CiAgdmFyIGFwcGx5ID0gRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5OwogIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICB2YXIgaW1tZWRpYXRlSWRzID0ge307CiAgdmFyIG5leHRJbW1lZGlhdGVJZCA9IDA7CiAgCiAgLy8gRE9NIEFQSXMsIGZvciBjb21wbGV0ZW5lc3MKICAKICBleHBvcnRzLnNldFRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgVGltZW91dChhcHBseS5jYWxsKHNldFRpbWVvdXQsIHdpbmRvdywgYXJndW1lbnRzKSwgY2xlYXJUaW1lb3V0KTsKICB9OwogIGV4cG9ydHMuc2V0SW50ZXJ2YWwgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgVGltZW91dChhcHBseS5jYWxsKHNldEludGVydmFsLCB3aW5kb3csIGFyZ3VtZW50cyksIGNsZWFySW50ZXJ2YWwpOwogIH07CiAgZXhwb3J0cy5jbGVhclRpbWVvdXQgPQogIGV4cG9ydHMuY2xlYXJJbnRlcnZhbCA9IGZ1bmN0aW9uKHRpbWVvdXQpIHsgdGltZW91dC5jbG9zZSgpOyB9OwogIAogIGZ1bmN0aW9uIFRpbWVvdXQoaWQsIGNsZWFyRm4pIHsKICAgIHRoaXMuX2lkID0gaWQ7CiAgICB0aGlzLl9jbGVhckZuID0gY2xlYXJGbjsKICB9CiAgVGltZW91dC5wcm90b3R5cGUudW5yZWYgPSBUaW1lb3V0LnByb3RvdHlwZS5yZWYgPSBmdW5jdGlvbigpIHt9OwogIFRpbWVvdXQucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9jbGVhckZuLmNhbGwod2luZG93LCB0aGlzLl9pZCk7CiAgfTsKICAKICAvLyBEb2VzIG5vdCBzdGFydCB0aGUgdGltZSwganVzdCBzZXRzIHVwIHRoZSBtZW1iZXJzIG5lZWRlZC4KICBleHBvcnRzLmVucm9sbCA9IGZ1bmN0aW9uKGl0ZW0sIG1zZWNzKSB7CiAgICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgICBpdGVtLl9pZGxlVGltZW91dCA9IG1zZWNzOwogIH07CiAgCiAgZXhwb3J0cy51bmVucm9sbCA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICAgIGl0ZW0uX2lkbGVUaW1lb3V0ID0gLTE7CiAgfTsKICAKICBleHBvcnRzLl91bnJlZkFjdGl2ZSA9IGV4cG9ydHMuYWN0aXZlID0gZnVuY3Rpb24oaXRlbSkgewogICAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwogIAogICAgdmFyIG1zZWNzID0gaXRlbS5faWRsZVRpbWVvdXQ7CiAgICBpZiAobXNlY3MgPj0gMCkgewogICAgICBpdGVtLl9pZGxlVGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbiBvblRpbWVvdXQoKSB7CiAgICAgICAgaWYgKGl0ZW0uX29uVGltZW91dCkKICAgICAgICAgIGl0ZW0uX29uVGltZW91dCgpOwogICAgICB9LCBtc2Vjcyk7CiAgICB9CiAgfTsKICAKICAvLyBUaGF0J3Mgbm90IGhvdyBub2RlLmpzIGltcGxlbWVudHMgaXQgYnV0IHRoZSBleHBvc2VkIGFwaSBpcyB0aGUgc2FtZS4KICBleHBvcnRzLnNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBzZXRJbW1lZGlhdGUgOiBmdW5jdGlvbihmbikgewogICAgdmFyIGlkID0gbmV4dEltbWVkaWF0ZUlkKys7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPCAyID8gZmFsc2UgOiBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgCiAgICBpbW1lZGlhdGVJZHNbaWRdID0gdHJ1ZTsKICAKICAgIG5leHRUaWNrKGZ1bmN0aW9uIG9uTmV4dFRpY2soKSB7CiAgICAgIGlmIChpbW1lZGlhdGVJZHNbaWRdKSB7CiAgICAgICAgLy8gZm4uY2FsbCgpIGlzIGZhc3RlciBzbyB3ZSBvcHRpbWl6ZSBmb3IgdGhlIGNvbW1vbiB1c2UtY2FzZQogICAgICAgIC8vIEBzZWUgaHR0cDovL2pzcGVyZi5jb20vY2FsbC1hcHBseS1zZWd1CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgIGZuLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmbi5jYWxsKG51bGwpOwogICAgICAgIH0KICAgICAgICAvLyBQcmV2ZW50IGlkcyBmcm9tIGxlYWtpbmcKICAgICAgICBleHBvcnRzLmNsZWFySW1tZWRpYXRlKGlkKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXR1cm4gaWQ7CiAgfTsKICAKICBleHBvcnRzLmNsZWFySW1tZWRpYXRlID0gdHlwZW9mIGNsZWFySW1tZWRpYXRlID09PSAiZnVuY3Rpb24iID8gY2xlYXJJbW1lZGlhdGUgOiBmdW5jdGlvbihpZCkgewogICAgZGVsZXRlIGltbWVkaWF0ZUlkc1tpZF07CiAgfTsKICB9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoInRpbWVycyIpLnNldEltbWVkaWF0ZSxyZXF1aXJlKCJ0aW1lcnMiKS5jbGVhckltbWVkaWF0ZSkKICB9LHsicHJvY2Vzcy9icm93c2VyLmpzIjo4NiwidGltZXJzIjo5M31dLDk0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICB2YXIgcHVueWNvZGUgPSByZXF1aXJlKCdwdW55Y29kZScpOwogIAogIGV4cG9ydHMucGFyc2UgPSB1cmxQYXJzZTsKICBleHBvcnRzLnJlc29sdmUgPSB1cmxSZXNvbHZlOwogIGV4cG9ydHMucmVzb2x2ZU9iamVjdCA9IHVybFJlc29sdmVPYmplY3Q7CiAgZXhwb3J0cy5mb3JtYXQgPSB1cmxGb3JtYXQ7CiAgCiAgZXhwb3J0cy5VcmwgPSBVcmw7CiAgCiAgZnVuY3Rpb24gVXJsKCkgewogICAgdGhpcy5wcm90b2NvbCA9IG51bGw7CiAgICB0aGlzLnNsYXNoZXMgPSBudWxsOwogICAgdGhpcy5hdXRoID0gbnVsbDsKICAgIHRoaXMuaG9zdCA9IG51bGw7CiAgICB0aGlzLnBvcnQgPSBudWxsOwogICAgdGhpcy5ob3N0bmFtZSA9IG51bGw7CiAgICB0aGlzLmhhc2ggPSBudWxsOwogICAgdGhpcy5zZWFyY2ggPSBudWxsOwogICAgdGhpcy5xdWVyeSA9IG51bGw7CiAgICB0aGlzLnBhdGhuYW1lID0gbnVsbDsKICAgIHRoaXMucGF0aCA9IG51bGw7CiAgICB0aGlzLmhyZWYgPSBudWxsOwogIH0KICAKICAvLyBSZWZlcmVuY2U6IFJGQyAzOTg2LCBSRkMgMTgwOCwgUkZDIDIzOTYKICAKICAvLyBkZWZpbmUgdGhlc2UgaGVyZSBzbyBhdCBsZWFzdCB0aGV5IG9ubHkgaGF2ZSB0byBiZQogIC8vIGNvbXBpbGVkIG9uY2Ugb24gdGhlIGZpcnN0IG1vZHVsZSBsb2FkLgogIHZhciBwcm90b2NvbFBhdHRlcm4gPSAvXihbYS16MC05ListXSs6KS9pLAogICAgICBwb3J0UGF0dGVybiA9IC86WzAtOV0qJC8sCiAgCiAgICAgIC8vIFJGQyAyMzk2OiBjaGFyYWN0ZXJzIHJlc2VydmVkIGZvciBkZWxpbWl0aW5nIFVSTHMuCiAgICAgIC8vIFdlIGFjdHVhbGx5IGp1c3QgYXV0by1lc2NhcGUgdGhlc2UuCiAgICAgIGRlbGltcyA9IFsnPCcsICc+JywgJyInLCAnYCcsICcgJywgJ1xyJywgJ1xuJywgJ1x0J10sCiAgCiAgICAgIC8vIFJGQyAyMzk2OiBjaGFyYWN0ZXJzIG5vdCBhbGxvd2VkIGZvciB2YXJpb3VzIHJlYXNvbnMuCiAgICAgIHVud2lzZSA9IFsneycsICd9JywgJ3wnLCAnXFwnLCAnXicsICdgJ10uY29uY2F0KGRlbGltcyksCiAgCiAgICAgIC8vIEFsbG93ZWQgYnkgUkZDcywgYnV0IGNhdXNlIG9mIFhTUyBhdHRhY2tzLiAgQWx3YXlzIGVzY2FwZSB0aGVzZS4KICAgICAgYXV0b0VzY2FwZSA9IFsnXCcnXS5jb25jYXQodW53aXNlKSwKICAgICAgLy8gQ2hhcmFjdGVycyB0aGF0IGFyZSBuZXZlciBldmVyIGFsbG93ZWQgaW4gYSBob3N0bmFtZS4KICAgICAgLy8gTm90ZSB0aGF0IGFueSBpbnZhbGlkIGNoYXJzIGFyZSBhbHNvIGhhbmRsZWQsIGJ1dCB0aGVzZQogICAgICAvLyBhcmUgdGhlIG9uZXMgdGhhdCBhcmUgKmV4cGVjdGVkKiB0byBiZSBzZWVuLCBzbyB3ZSBmYXN0LXBhdGgKICAgICAgLy8gdGhlbS4KICAgICAgbm9uSG9zdENoYXJzID0gWyclJywgJy8nLCAnPycsICc7JywgJyMnXS5jb25jYXQoYXV0b0VzY2FwZSksCiAgICAgIGhvc3RFbmRpbmdDaGFycyA9IFsnLycsICc/JywgJyMnXSwKICAgICAgaG9zdG5hbWVNYXhMZW4gPSAyNTUsCiAgICAgIGhvc3RuYW1lUGFydFBhdHRlcm4gPSAvXlthLXowLTlBLVpfLV17MCw2M30kLywKICAgICAgaG9zdG5hbWVQYXJ0U3RhcnQgPSAvXihbYS16MC05QS1aXy1dezAsNjN9KSguKikkLywKICAgICAgLy8gcHJvdG9jb2xzIHRoYXQgY2FuIGFsbG93ICJ1bnNhZmUiIGFuZCAidW53aXNlIiBjaGFycy4KICAgICAgdW5zYWZlUHJvdG9jb2wgPSB7CiAgICAgICAgJ2phdmFzY3JpcHQnOiB0cnVlLAogICAgICAgICdqYXZhc2NyaXB0Oic6IHRydWUKICAgICAgfSwKICAgICAgLy8gcHJvdG9jb2xzIHRoYXQgbmV2ZXIgaGF2ZSBhIGhvc3RuYW1lLgogICAgICBob3N0bGVzc1Byb3RvY29sID0gewogICAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgICAnamF2YXNjcmlwdDonOiB0cnVlCiAgICAgIH0sCiAgICAgIC8vIHByb3RvY29scyB0aGF0IGFsd2F5cyBjb250YWluIGEgLy8gYml0LgogICAgICBzbGFzaGVkUHJvdG9jb2wgPSB7CiAgICAgICAgJ2h0dHAnOiB0cnVlLAogICAgICAgICdodHRwcyc6IHRydWUsCiAgICAgICAgJ2Z0cCc6IHRydWUsCiAgICAgICAgJ2dvcGhlcic6IHRydWUsCiAgICAgICAgJ2ZpbGUnOiB0cnVlLAogICAgICAgICdodHRwOic6IHRydWUsCiAgICAgICAgJ2h0dHBzOic6IHRydWUsCiAgICAgICAgJ2Z0cDonOiB0cnVlLAogICAgICAgICdnb3BoZXI6JzogdHJ1ZSwKICAgICAgICAnZmlsZTonOiB0cnVlCiAgICAgIH0sCiAgICAgIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcnKTsKICAKICBmdW5jdGlvbiB1cmxQYXJzZSh1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgICBpZiAodXJsICYmIGlzT2JqZWN0KHVybCkgJiYgdXJsIGluc3RhbmNlb2YgVXJsKSByZXR1cm4gdXJsOwogIAogICAgdmFyIHUgPSBuZXcgVXJsOwogICAgdS5wYXJzZSh1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KTsKICAgIHJldHVybiB1OwogIH0KICAKICBVcmwucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24odXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCkgewogICAgaWYgKCFpc1N0cmluZyh1cmwpKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlBhcmFtZXRlciAndXJsJyBtdXN0IGJlIGEgc3RyaW5nLCBub3QgIiArIHR5cGVvZiB1cmwpOwogICAgfQogIAogICAgdmFyIHJlc3QgPSB1cmw7CiAgCiAgICAvLyB0cmltIGJlZm9yZSBwcm9jZWVkaW5nLgogICAgLy8gVGhpcyBpcyB0byBzdXBwb3J0IHBhcnNlIHN0dWZmIGxpa2UgIiAgaHR0cDovL2Zvby5jb20gIFxuIgogICAgcmVzdCA9IHJlc3QudHJpbSgpOwogIAogICAgdmFyIHByb3RvID0gcHJvdG9jb2xQYXR0ZXJuLmV4ZWMocmVzdCk7CiAgICBpZiAocHJvdG8pIHsKICAgICAgcHJvdG8gPSBwcm90b1swXTsKICAgICAgdmFyIGxvd2VyUHJvdG8gPSBwcm90by50b0xvd2VyQ2FzZSgpOwogICAgICB0aGlzLnByb3RvY29sID0gbG93ZXJQcm90bzsKICAgICAgcmVzdCA9IHJlc3Quc3Vic3RyKHByb3RvLmxlbmd0aCk7CiAgICB9CiAgCiAgICAvLyBmaWd1cmUgb3V0IGlmIGl0J3MgZ290IGEgaG9zdAogICAgLy8gdXNlckBzZXJ2ZXIgaXMgKmFsd2F5cyogaW50ZXJwcmV0ZWQgYXMgYSBob3N0bmFtZSwgYW5kIHVybAogICAgLy8gcmVzb2x1dGlvbiB3aWxsIHRyZWF0IC8vZm9vL2JhciBhcyBob3N0PWZvbyxwYXRoPWJhciBiZWNhdXNlIHRoYXQncwogICAgLy8gaG93IHRoZSBicm93c2VyIHJlc29sdmVzIHJlbGF0aXZlIFVSTHMuCiAgICBpZiAoc2xhc2hlc0Rlbm90ZUhvc3QgfHwgcHJvdG8gfHwgcmVzdC5tYXRjaCgvXlwvXC9bXkBcL10rQFteQFwvXSsvKSkgewogICAgICB2YXIgc2xhc2hlcyA9IHJlc3Quc3Vic3RyKDAsIDIpID09PSAnLy8nOwogICAgICBpZiAoc2xhc2hlcyAmJiAhKHByb3RvICYmIGhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dKSkgewogICAgICAgIHJlc3QgPSByZXN0LnN1YnN0cigyKTsKICAgICAgICB0aGlzLnNsYXNoZXMgPSB0cnVlOwogICAgICB9CiAgICB9CiAgCiAgICBpZiAoIWhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dICYmCiAgICAgICAgKHNsYXNoZXMgfHwgKHByb3RvICYmICFzbGFzaGVkUHJvdG9jb2xbcHJvdG9dKSkpIHsKICAKICAgICAgLy8gdGhlcmUncyBhIGhvc3RuYW1lLgogICAgICAvLyB0aGUgZmlyc3QgaW5zdGFuY2Ugb2YgLywgPywgOywgb3IgIyBlbmRzIHRoZSBob3N0LgogICAgICAvLwogICAgICAvLyBJZiB0aGVyZSBpcyBhbiBAIGluIHRoZSBob3N0bmFtZSwgdGhlbiBub24taG9zdCBjaGFycyAqYXJlKiBhbGxvd2VkCiAgICAgIC8vIHRvIHRoZSBsZWZ0IG9mIHRoZSBsYXN0IEAgc2lnbiwgdW5sZXNzIHNvbWUgaG9zdC1lbmRpbmcgY2hhcmFjdGVyCiAgICAgIC8vIGNvbWVzICpiZWZvcmUqIHRoZSBALXNpZ24uCiAgICAgIC8vIFVSTHMgYXJlIG9ibm94aW91cy4KICAgICAgLy8KICAgICAgLy8gZXg6CiAgICAgIC8vIGh0dHA6Ly9hQGJAYy8gPT4gdXNlcjphQGIgaG9zdDpjCiAgICAgIC8vIGh0dHA6Ly9hQGI/QGMgPT4gdXNlcjphIGhvc3Q6YyBwYXRoOi8/QGMKICAKICAgICAgLy8gdjAuMTIgVE9ETyhpc2FhY3MpOiBUaGlzIGlzIG5vdCBxdWl0ZSBob3cgQ2hyb21lIGRvZXMgdGhpbmdzLgogICAgICAvLyBSZXZpZXcgb3VyIHRlc3QgY2FzZSBhZ2FpbnN0IGJyb3dzZXJzIG1vcmUgY29tcHJlaGVuc2l2ZWx5LgogIAogICAgICAvLyBmaW5kIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiBhbnkgaG9zdEVuZGluZ0NoYXJzCiAgICAgIHZhciBob3N0RW5kID0gLTE7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaG9zdEVuZGluZ0NoYXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGhlYyA9IHJlc3QuaW5kZXhPZihob3N0RW5kaW5nQ2hhcnNbaV0pOwogICAgICAgIGlmIChoZWMgIT09IC0xICYmIChob3N0RW5kID09PSAtMSB8fCBoZWMgPCBob3N0RW5kKSkKICAgICAgICAgIGhvc3RFbmQgPSBoZWM7CiAgICAgIH0KICAKICAgICAgLy8gYXQgdGhpcyBwb2ludCwgZWl0aGVyIHdlIGhhdmUgYW4gZXhwbGljaXQgcG9pbnQgd2hlcmUgdGhlCiAgICAgIC8vIGF1dGggcG9ydGlvbiBjYW5ub3QgZ28gcGFzdCwgb3IgdGhlIGxhc3QgQCBjaGFyIGlzIHRoZSBkZWNpZGVyLgogICAgICB2YXIgYXV0aCwgYXRTaWduOwogICAgICBpZiAoaG9zdEVuZCA9PT0gLTEpIHsKICAgICAgICAvLyBhdFNpZ24gY2FuIGJlIGFueXdoZXJlLgogICAgICAgIGF0U2lnbiA9IHJlc3QubGFzdEluZGV4T2YoJ0AnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBhdFNpZ24gbXVzdCBiZSBpbiBhdXRoIHBvcnRpb24uCiAgICAgICAgLy8gaHR0cDovL2FAYi9jQGQgPT4gaG9zdDpiIGF1dGg6YSBwYXRoOi9jQGQKICAgICAgICBhdFNpZ24gPSByZXN0Lmxhc3RJbmRleE9mKCdAJywgaG9zdEVuZCk7CiAgICAgIH0KICAKICAgICAgLy8gTm93IHdlIGhhdmUgYSBwb3J0aW9uIHdoaWNoIGlzIGRlZmluaXRlbHkgdGhlIGF1dGguCiAgICAgIC8vIFB1bGwgdGhhdCBvZmYuCiAgICAgIGlmIChhdFNpZ24gIT09IC0xKSB7CiAgICAgICAgYXV0aCA9IHJlc3Quc2xpY2UoMCwgYXRTaWduKTsKICAgICAgICByZXN0ID0gcmVzdC5zbGljZShhdFNpZ24gKyAxKTsKICAgICAgICB0aGlzLmF1dGggPSBkZWNvZGVVUklDb21wb25lbnQoYXV0aCk7CiAgICAgIH0KICAKICAgICAgLy8gdGhlIGhvc3QgaXMgdGhlIHJlbWFpbmluZyB0byB0aGUgbGVmdCBvZiB0aGUgZmlyc3Qgbm9uLWhvc3QgY2hhcgogICAgICBob3N0RW5kID0gLTE7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9uSG9zdENoYXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGhlYyA9IHJlc3QuaW5kZXhPZihub25Ib3N0Q2hhcnNbaV0pOwogICAgICAgIGlmIChoZWMgIT09IC0xICYmIChob3N0RW5kID09PSAtMSB8fCBoZWMgPCBob3N0RW5kKSkKICAgICAgICAgIGhvc3RFbmQgPSBoZWM7CiAgICAgIH0KICAgICAgLy8gaWYgd2Ugc3RpbGwgaGF2ZSBub3QgaGl0IGl0LCB0aGVuIHRoZSBlbnRpcmUgdGhpbmcgaXMgYSBob3N0LgogICAgICBpZiAoaG9zdEVuZCA9PT0gLTEpCiAgICAgICAgaG9zdEVuZCA9IHJlc3QubGVuZ3RoOwogIAogICAgICB0aGlzLmhvc3QgPSByZXN0LnNsaWNlKDAsIGhvc3RFbmQpOwogICAgICByZXN0ID0gcmVzdC5zbGljZShob3N0RW5kKTsKICAKICAgICAgLy8gcHVsbCBvdXQgcG9ydC4KICAgICAgdGhpcy5wYXJzZUhvc3QoKTsKICAKICAgICAgLy8gd2UndmUgaW5kaWNhdGVkIHRoYXQgdGhlcmUgaXMgYSBob3N0bmFtZSwKICAgICAgLy8gc28gZXZlbiBpZiBpdCdzIGVtcHR5LCBpdCBoYXMgdG8gYmUgcHJlc2VudC4KICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUgfHwgJyc7CiAgCiAgICAgIC8vIGlmIGhvc3RuYW1lIGJlZ2lucyB3aXRoIFsgYW5kIGVuZHMgd2l0aCBdCiAgICAgIC8vIGFzc3VtZSB0aGF0IGl0J3MgYW4gSVB2NiBhZGRyZXNzLgogICAgICB2YXIgaXB2Nkhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZVswXSA9PT0gJ1snICYmCiAgICAgICAgICB0aGlzLmhvc3RuYW1lW3RoaXMuaG9zdG5hbWUubGVuZ3RoIC0gMV0gPT09ICddJzsKICAKICAgICAgLy8gdmFsaWRhdGUgYSBsaXR0bGUuCiAgICAgIGlmICghaXB2Nkhvc3RuYW1lKSB7CiAgICAgICAgdmFyIGhvc3RwYXJ0cyA9IHRoaXMuaG9zdG5hbWUuc3BsaXQoL1wuLyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBob3N0cGFydHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICB2YXIgcGFydCA9IGhvc3RwYXJ0c1tpXTsKICAgICAgICAgIGlmICghcGFydCkgY29udGludWU7CiAgICAgICAgICBpZiAoIXBhcnQubWF0Y2goaG9zdG5hbWVQYXJ0UGF0dGVybikpIHsKICAgICAgICAgICAgdmFyIG5ld3BhcnQgPSAnJzsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGsgPSBwYXJ0Lmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGlmIChwYXJ0LmNoYXJDb2RlQXQoaikgPiAxMjcpIHsKICAgICAgICAgICAgICAgIC8vIHdlIHJlcGxhY2Ugbm9uLUFTQ0lJIGNoYXIgd2l0aCBhIHRlbXBvcmFyeSBwbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0aGlzIHRvIG1ha2Ugc3VyZSBzaXplIG9mIGhvc3RuYW1lIGlzIG5vdAogICAgICAgICAgICAgICAgLy8gYnJva2VuIGJ5IHJlcGxhY2luZyBub24tQVNDSUkgYnkgbm90aGluZwogICAgICAgICAgICAgICAgbmV3cGFydCArPSAneCc7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld3BhcnQgKz0gcGFydFtqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gd2UgdGVzdCBhZ2FpbiB3aXRoIEFTQ0lJIGNoYXIgb25seQogICAgICAgICAgICBpZiAoIW5ld3BhcnQubWF0Y2goaG9zdG5hbWVQYXJ0UGF0dGVybikpIHsKICAgICAgICAgICAgICB2YXIgdmFsaWRQYXJ0cyA9IGhvc3RwYXJ0cy5zbGljZSgwLCBpKTsKICAgICAgICAgICAgICB2YXIgbm90SG9zdCA9IGhvc3RwYXJ0cy5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgdmFyIGJpdCA9IHBhcnQubWF0Y2goaG9zdG5hbWVQYXJ0U3RhcnQpOwogICAgICAgICAgICAgIGlmIChiaXQpIHsKICAgICAgICAgICAgICAgIHZhbGlkUGFydHMucHVzaChiaXRbMV0pOwogICAgICAgICAgICAgICAgbm90SG9zdC51bnNoaWZ0KGJpdFsyXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub3RIb3N0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVzdCA9ICcvJyArIG5vdEhvc3Quam9pbignLicpICsgcmVzdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHZhbGlkUGFydHMuam9pbignLicpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgCiAgICAgIGlmICh0aGlzLmhvc3RuYW1lLmxlbmd0aCA+IGhvc3RuYW1lTWF4TGVuKSB7CiAgICAgICAgdGhpcy5ob3N0bmFtZSA9ICcnOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIGhvc3RuYW1lcyBhcmUgYWx3YXlzIGxvd2VyIGNhc2UuCiAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHRoaXMuaG9zdG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfQogIAogICAgICBpZiAoIWlwdjZIb3N0bmFtZSkgewogICAgICAgIC8vIElETkEgU3VwcG9ydDogUmV0dXJucyBhIHB1bnkgY29kZWQgcmVwcmVzZW50YXRpb24gb2YgImRvbWFpbiIuCiAgICAgICAgLy8gSXQgb25seSBjb252ZXJ0cyB0aGUgcGFydCBvZiB0aGUgZG9tYWluIG5hbWUgdGhhdAogICAgICAgIC8vIGhhcyBub24gQVNDSUkgY2hhcmFjdGVycy4gSS5lLiBpdCBkb3NlbnQgbWF0dGVyIGlmCiAgICAgICAgLy8geW91IGNhbGwgaXQgd2l0aCBhIGRvbWFpbiB0aGF0IGFscmVhZHkgaXMgaW4gQVNDSUkuCiAgICAgICAgdmFyIGRvbWFpbkFycmF5ID0gdGhpcy5ob3N0bmFtZS5zcGxpdCgnLicpOwogICAgICAgIHZhciBuZXdPdXQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvbWFpbkFycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICB2YXIgcyA9IGRvbWFpbkFycmF5W2ldOwogICAgICAgICAgbmV3T3V0LnB1c2gocy5tYXRjaCgvW15BLVphLXowLTlfLV0vKSA/CiAgICAgICAgICAgICAgJ3huLS0nICsgcHVueWNvZGUuZW5jb2RlKHMpIDogcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaG9zdG5hbWUgPSBuZXdPdXQuam9pbignLicpOwogICAgICB9CiAgCiAgICAgIHZhciBwID0gdGhpcy5wb3J0ID8gJzonICsgdGhpcy5wb3J0IDogJyc7CiAgICAgIHZhciBoID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKICAgICAgdGhpcy5ob3N0ID0gaCArIHA7CiAgICAgIHRoaXMuaHJlZiArPSB0aGlzLmhvc3Q7CiAgCiAgICAgIC8vIHN0cmlwIFsgYW5kIF0gZnJvbSB0aGUgaG9zdG5hbWUKICAgICAgLy8gdGhlIGhvc3QgZmllbGQgc3RpbGwgcmV0YWlucyB0aGVtLCB0aG91Z2gKICAgICAgaWYgKGlwdjZIb3N0bmFtZSkgewogICAgICAgIHRoaXMuaG9zdG5hbWUgPSB0aGlzLmhvc3RuYW1lLnN1YnN0cigxLCB0aGlzLmhvc3RuYW1lLmxlbmd0aCAtIDIpOwogICAgICAgIGlmIChyZXN0WzBdICE9PSAnLycpIHsKICAgICAgICAgIHJlc3QgPSAnLycgKyByZXN0OwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgLy8gbm93IHJlc3QgaXMgc2V0IHRvIHRoZSBwb3N0LWhvc3Qgc3R1ZmYuCiAgICAvLyBjaG9wIG9mZiBhbnkgZGVsaW0gY2hhcnMuCiAgICBpZiAoIXVuc2FmZVByb3RvY29sW2xvd2VyUHJvdG9dKSB7CiAgCiAgICAgIC8vIEZpcnN0LCBtYWtlIDEwMCUgc3VyZSB0aGF0IGFueSAiYXV0b0VzY2FwZSIgY2hhcnMgZ2V0CiAgICAgIC8vIGVzY2FwZWQsIGV2ZW4gaWYgZW5jb2RlVVJJQ29tcG9uZW50IGRvZXNuJ3QgdGhpbmsgdGhleQogICAgICAvLyBuZWVkIHRvIGJlLgogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGF1dG9Fc2NhcGUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdmFyIGFlID0gYXV0b0VzY2FwZVtpXTsKICAgICAgICB2YXIgZXNjID0gZW5jb2RlVVJJQ29tcG9uZW50KGFlKTsKICAgICAgICBpZiAoZXNjID09PSBhZSkgewogICAgICAgICAgZXNjID0gZXNjYXBlKGFlKTsKICAgICAgICB9CiAgICAgICAgcmVzdCA9IHJlc3Quc3BsaXQoYWUpLmpvaW4oZXNjKTsKICAgICAgfQogICAgfQogIAogIAogICAgLy8gY2hvcCBvZmYgZnJvbSB0aGUgdGFpbCBmaXJzdC4KICAgIHZhciBoYXNoID0gcmVzdC5pbmRleE9mKCcjJyk7CiAgICBpZiAoaGFzaCAhPT0gLTEpIHsKICAgICAgLy8gZ290IGEgZnJhZ21lbnQgc3RyaW5nLgogICAgICB0aGlzLmhhc2ggPSByZXN0LnN1YnN0cihoYXNoKTsKICAgICAgcmVzdCA9IHJlc3Quc2xpY2UoMCwgaGFzaCk7CiAgICB9CiAgICB2YXIgcW0gPSByZXN0LmluZGV4T2YoJz8nKTsKICAgIGlmIChxbSAhPT0gLTEpIHsKICAgICAgdGhpcy5zZWFyY2ggPSByZXN0LnN1YnN0cihxbSk7CiAgICAgIHRoaXMucXVlcnkgPSByZXN0LnN1YnN0cihxbSArIDEpOwogICAgICBpZiAocGFyc2VRdWVyeVN0cmluZykgewogICAgICAgIHRoaXMucXVlcnkgPSBxdWVyeXN0cmluZy5wYXJzZSh0aGlzLnF1ZXJ5KTsKICAgICAgfQogICAgICByZXN0ID0gcmVzdC5zbGljZSgwLCBxbSk7CiAgICB9IGVsc2UgaWYgKHBhcnNlUXVlcnlTdHJpbmcpIHsKICAgICAgLy8gbm8gcXVlcnkgc3RyaW5nLCBidXQgcGFyc2VRdWVyeVN0cmluZyBzdGlsbCByZXF1ZXN0ZWQKICAgICAgdGhpcy5zZWFyY2ggPSAnJzsKICAgICAgdGhpcy5xdWVyeSA9IHt9OwogICAgfQogICAgaWYgKHJlc3QpIHRoaXMucGF0aG5hbWUgPSByZXN0OwogICAgaWYgKHNsYXNoZWRQcm90b2NvbFtsb3dlclByb3RvXSAmJgogICAgICAgIHRoaXMuaG9zdG5hbWUgJiYgIXRoaXMucGF0aG5hbWUpIHsKICAgICAgdGhpcy5wYXRobmFtZSA9ICcvJzsKICAgIH0KICAKICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgIGlmICh0aGlzLnBhdGhuYW1lIHx8IHRoaXMuc2VhcmNoKSB7CiAgICAgIHZhciBwID0gdGhpcy5wYXRobmFtZSB8fCAnJzsKICAgICAgdmFyIHMgPSB0aGlzLnNlYXJjaCB8fCAnJzsKICAgICAgdGhpcy5wYXRoID0gcCArIHM7CiAgICB9CiAgCiAgICAvLyBmaW5hbGx5LCByZWNvbnN0cnVjdCB0aGUgaHJlZiBiYXNlZCBvbiB3aGF0IGhhcyBiZWVuIHZhbGlkYXRlZC4KICAgIHRoaXMuaHJlZiA9IHRoaXMuZm9ybWF0KCk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIAogIC8vIGZvcm1hdCBhIHBhcnNlZCBvYmplY3QgaW50byBhIHVybCBzdHJpbmcKICBmdW5jdGlvbiB1cmxGb3JtYXQob2JqKSB7CiAgICAvLyBlbnN1cmUgaXQncyBhbiBvYmplY3QsIGFuZCBub3QgYSBzdHJpbmcgdXJsLgogICAgLy8gSWYgaXQncyBhbiBvYmosIHRoaXMgaXMgYSBuby1vcC4KICAgIC8vIHRoaXMgd2F5LCB5b3UgY2FuIGNhbGwgdXJsX2Zvcm1hdCgpIG9uIHN0cmluZ3MKICAgIC8vIHRvIGNsZWFuIHVwIHBvdGVudGlhbGx5IHdvbmt5IHVybHMuCiAgICBpZiAoaXNTdHJpbmcob2JqKSkgb2JqID0gdXJsUGFyc2Uob2JqKTsKICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIFVybCkpIHJldHVybiBVcmwucHJvdG90eXBlLmZvcm1hdC5jYWxsKG9iaik7CiAgICByZXR1cm4gb2JqLmZvcm1hdCgpOwogIH0KICAKICBVcmwucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGF1dGggPSB0aGlzLmF1dGggfHwgJyc7CiAgICBpZiAoYXV0aCkgewogICAgICBhdXRoID0gZW5jb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgICBhdXRoID0gYXV0aC5yZXBsYWNlKC8lM0EvaSwgJzonKTsKICAgICAgYXV0aCArPSAnQCc7CiAgICB9CiAgCiAgICB2YXIgcHJvdG9jb2wgPSB0aGlzLnByb3RvY29sIHx8ICcnLAogICAgICAgIHBhdGhuYW1lID0gdGhpcy5wYXRobmFtZSB8fCAnJywKICAgICAgICBoYXNoID0gdGhpcy5oYXNoIHx8ICcnLAogICAgICAgIGhvc3QgPSBmYWxzZSwKICAgICAgICBxdWVyeSA9ICcnOwogIAogICAgaWYgKHRoaXMuaG9zdCkgewogICAgICBob3N0ID0gYXV0aCArIHRoaXMuaG9zdDsKICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0bmFtZSkgewogICAgICBob3N0ID0gYXV0aCArICh0aGlzLmhvc3RuYW1lLmluZGV4T2YoJzonKSA9PT0gLTEgPwogICAgICAgICAgdGhpcy5ob3N0bmFtZSA6CiAgICAgICAgICAnWycgKyB0aGlzLmhvc3RuYW1lICsgJ10nKTsKICAgICAgaWYgKHRoaXMucG9ydCkgewogICAgICAgIGhvc3QgKz0gJzonICsgdGhpcy5wb3J0OwogICAgICB9CiAgICB9CiAgCiAgICBpZiAodGhpcy5xdWVyeSAmJgogICAgICAgIGlzT2JqZWN0KHRoaXMucXVlcnkpICYmCiAgICAgICAgT2JqZWN0LmtleXModGhpcy5xdWVyeSkubGVuZ3RoKSB7CiAgICAgIHF1ZXJ5ID0gcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHRoaXMucXVlcnkpOwogICAgfQogIAogICAgdmFyIHNlYXJjaCA9IHRoaXMuc2VhcmNoIHx8IChxdWVyeSAmJiAoJz8nICsgcXVlcnkpKSB8fCAnJzsKICAKICAgIGlmIChwcm90b2NvbCAmJiBwcm90b2NvbC5zdWJzdHIoLTEpICE9PSAnOicpIHByb3RvY29sICs9ICc6JzsKICAKICAgIC8vIG9ubHkgdGhlIHNsYXNoZWRQcm90b2NvbHMgZ2V0IHRoZSAvLy4gIE5vdCBtYWlsdG86LCB4bXBwOiwgZXRjLgogICAgLy8gdW5sZXNzIHRoZXkgaGFkIHRoZW0gdG8gYmVnaW4gd2l0aC4KICAgIGlmICh0aGlzLnNsYXNoZXMgfHwKICAgICAgICAoIXByb3RvY29sIHx8IHNsYXNoZWRQcm90b2NvbFtwcm90b2NvbF0pICYmIGhvc3QgIT09IGZhbHNlKSB7CiAgICAgIGhvc3QgPSAnLy8nICsgKGhvc3QgfHwgJycpOwogICAgICBpZiAocGF0aG5hbWUgJiYgcGF0aG5hbWUuY2hhckF0KDApICE9PSAnLycpIHBhdGhuYW1lID0gJy8nICsgcGF0aG5hbWU7CiAgICB9IGVsc2UgaWYgKCFob3N0KSB7CiAgICAgIGhvc3QgPSAnJzsKICAgIH0KICAKICAgIGlmIChoYXNoICYmIGhhc2guY2hhckF0KDApICE9PSAnIycpIGhhc2ggPSAnIycgKyBoYXNoOwogICAgaWYgKHNlYXJjaCAmJiBzZWFyY2guY2hhckF0KDApICE9PSAnPycpIHNlYXJjaCA9ICc/JyArIHNlYXJjaDsKICAKICAgIHBhdGhuYW1lID0gcGF0aG5hbWUucmVwbGFjZSgvWz8jXS9nLCBmdW5jdGlvbihtYXRjaCkgewogICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KG1hdGNoKTsKICAgIH0pOwogICAgc2VhcmNoID0gc2VhcmNoLnJlcGxhY2UoJyMnLCAnJTIzJyk7CiAgCiAgICByZXR1cm4gcHJvdG9jb2wgKyBob3N0ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwogIH07CiAgCiAgZnVuY3Rpb24gdXJsUmVzb2x2ZShzb3VyY2UsIHJlbGF0aXZlKSB7CiAgICByZXR1cm4gdXJsUGFyc2Uoc291cmNlLCBmYWxzZSwgdHJ1ZSkucmVzb2x2ZShyZWxhdGl2ZSk7CiAgfQogIAogIFVybC5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKHJlbGF0aXZlKSB7CiAgICByZXR1cm4gdGhpcy5yZXNvbHZlT2JqZWN0KHVybFBhcnNlKHJlbGF0aXZlLCBmYWxzZSwgdHJ1ZSkpLmZvcm1hdCgpOwogIH07CiAgCiAgZnVuY3Rpb24gdXJsUmVzb2x2ZU9iamVjdChzb3VyY2UsIHJlbGF0aXZlKSB7CiAgICBpZiAoIXNvdXJjZSkgcmV0dXJuIHJlbGF0aXZlOwogICAgcmV0dXJuIHVybFBhcnNlKHNvdXJjZSwgZmFsc2UsIHRydWUpLnJlc29sdmVPYmplY3QocmVsYXRpdmUpOwogIH0KICAKICBVcmwucHJvdG90eXBlLnJlc29sdmVPYmplY3QgPSBmdW5jdGlvbihyZWxhdGl2ZSkgewogICAgaWYgKGlzU3RyaW5nKHJlbGF0aXZlKSkgewogICAgICB2YXIgcmVsID0gbmV3IFVybCgpOwogICAgICByZWwucGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKTsKICAgICAgcmVsYXRpdmUgPSByZWw7CiAgICB9CiAgCiAgICB2YXIgcmVzdWx0ID0gbmV3IFVybCgpOwogICAgT2JqZWN0LmtleXModGhpcykuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICAgIHJlc3VsdFtrXSA9IHRoaXNba107CiAgICB9LCB0aGlzKTsKICAKICAgIC8vIGhhc2ggaXMgYWx3YXlzIG92ZXJyaWRkZW4sIG5vIG1hdHRlciB3aGF0LgogICAgLy8gZXZlbiBocmVmPSIiIHdpbGwgcmVtb3ZlIGl0LgogICAgcmVzdWx0Lmhhc2ggPSByZWxhdGl2ZS5oYXNoOwogIAogICAgLy8gaWYgdGhlIHJlbGF0aXZlIHVybCBpcyBlbXB0eSwgdGhlbiB0aGVyZSdzIG5vdGhpbmcgbGVmdCB0byBkbyBoZXJlLgogICAgaWYgKHJlbGF0aXZlLmhyZWYgPT09ICcnKSB7CiAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIAogICAgLy8gaHJlZnMgbGlrZSAvL2Zvby9iYXIgYWx3YXlzIGN1dCB0byB0aGUgcHJvdG9jb2wuCiAgICBpZiAocmVsYXRpdmUuc2xhc2hlcyAmJiAhcmVsYXRpdmUucHJvdG9jb2wpIHsKICAgICAgLy8gdGFrZSBldmVyeXRoaW5nIGV4Y2VwdCB0aGUgcHJvdG9jb2wgZnJvbSByZWxhdGl2ZQogICAgICBPYmplY3Qua2V5cyhyZWxhdGl2ZSkuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICAgICAgaWYgKGsgIT09ICdwcm90b2NvbCcpCiAgICAgICAgICByZXN1bHRba10gPSByZWxhdGl2ZVtrXTsKICAgICAgfSk7CiAgCiAgICAgIC8vdXJsUGFyc2UgYXBwZW5kcyB0cmFpbGluZyAvIHRvIHVybHMgbGlrZSBodHRwOi8vd3d3LmV4YW1wbGUuY29tCiAgICAgIGlmIChzbGFzaGVkUHJvdG9jb2xbcmVzdWx0LnByb3RvY29sXSAmJgogICAgICAgICAgcmVzdWx0Lmhvc3RuYW1lICYmICFyZXN1bHQucGF0aG5hbWUpIHsKICAgICAgICByZXN1bHQucGF0aCA9IHJlc3VsdC5wYXRobmFtZSA9ICcvJzsKICAgICAgfQogIAogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIGlmIChyZWxhdGl2ZS5wcm90b2NvbCAmJiByZWxhdGl2ZS5wcm90b2NvbCAhPT0gcmVzdWx0LnByb3RvY29sKSB7CiAgICAgIC8vIGlmIGl0J3MgYSBrbm93biB1cmwgcHJvdG9jb2wsIHRoZW4gY2hhbmdpbmcKICAgICAgLy8gdGhlIHByb3RvY29sIGRvZXMgd2VpcmQgdGhpbmdzCiAgICAgIC8vIGZpcnN0LCBpZiBpdCdzIG5vdCBmaWxlOiwgdGhlbiB3ZSBNVVNUIGhhdmUgYSBob3N0LAogICAgICAvLyBhbmQgaWYgdGhlcmUgd2FzIGEgcGF0aAogICAgICAvLyB0byBiZWdpbiB3aXRoLCB0aGVuIHdlIE1VU1QgaGF2ZSBhIHBhdGguCiAgICAgIC8vIGlmIGl0IGlzIGZpbGU6LCB0aGVuIHRoZSBob3N0IGlzIGRyb3BwZWQsCiAgICAgIC8vIGJlY2F1c2UgdGhhdCdzIGtub3duIHRvIGJlIGhvc3RsZXNzLgogICAgICAvLyBhbnl0aGluZyBlbHNlIGlzIGFzc3VtZWQgdG8gYmUgYWJzb2x1dGUuCiAgICAgIGlmICghc2xhc2hlZFByb3RvY29sW3JlbGF0aXZlLnByb3RvY29sXSkgewogICAgICAgIE9iamVjdC5rZXlzKHJlbGF0aXZlKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgICAgICAgIHJlc3VsdFtrXSA9IHJlbGF0aXZlW2tdOwogICAgICAgIH0pOwogICAgICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAKICAgICAgcmVzdWx0LnByb3RvY29sID0gcmVsYXRpdmUucHJvdG9jb2w7CiAgICAgIGlmICghcmVsYXRpdmUuaG9zdCAmJiAhaG9zdGxlc3NQcm90b2NvbFtyZWxhdGl2ZS5wcm90b2NvbF0pIHsKICAgICAgICB2YXIgcmVsUGF0aCA9IChyZWxhdGl2ZS5wYXRobmFtZSB8fCAnJykuc3BsaXQoJy8nKTsKICAgICAgICB3aGlsZSAocmVsUGF0aC5sZW5ndGggJiYgIShyZWxhdGl2ZS5ob3N0ID0gcmVsUGF0aC5zaGlmdCgpKSk7CiAgICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0KSByZWxhdGl2ZS5ob3N0ID0gJyc7CiAgICAgICAgaWYgKCFyZWxhdGl2ZS5ob3N0bmFtZSkgcmVsYXRpdmUuaG9zdG5hbWUgPSAnJzsKICAgICAgICBpZiAocmVsUGF0aFswXSAhPT0gJycpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgICAgaWYgKHJlbFBhdGgubGVuZ3RoIDwgMikgcmVsUGF0aC51bnNoaWZ0KCcnKTsKICAgICAgICByZXN1bHQucGF0aG5hbWUgPSByZWxQYXRoLmpvaW4oJy8nKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucGF0aG5hbWUgPSByZWxhdGl2ZS5wYXRobmFtZTsKICAgICAgfQogICAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICAgICAgcmVzdWx0Lmhvc3QgPSByZWxhdGl2ZS5ob3N0IHx8ICcnOwogICAgICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGg7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlbGF0aXZlLmhvc3RuYW1lIHx8IHJlbGF0aXZlLmhvc3Q7CiAgICAgIHJlc3VsdC5wb3J0ID0gcmVsYXRpdmUucG9ydDsKICAgICAgLy8gdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgICAgaWYgKHJlc3VsdC5wYXRobmFtZSB8fCByZXN1bHQuc2VhcmNoKSB7CiAgICAgICAgdmFyIHAgPSByZXN1bHQucGF0aG5hbWUgfHwgJyc7CiAgICAgICAgdmFyIHMgPSByZXN1bHQuc2VhcmNoIHx8ICcnOwogICAgICAgIHJlc3VsdC5wYXRoID0gcCArIHM7CiAgICAgIH0KICAgICAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogICAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAKICAgIHZhciBpc1NvdXJjZUFicyA9IChyZXN1bHQucGF0aG5hbWUgJiYgcmVzdWx0LnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nKSwKICAgICAgICBpc1JlbEFicyA9ICgKICAgICAgICAgICAgcmVsYXRpdmUuaG9zdCB8fAogICAgICAgICAgICByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJwogICAgICAgICksCiAgICAgICAgbXVzdEVuZEFicyA9IChpc1JlbEFicyB8fCBpc1NvdXJjZUFicyB8fAogICAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5ob3N0ICYmIHJlbGF0aXZlLnBhdGhuYW1lKSksCiAgICAgICAgcmVtb3ZlQWxsRG90cyA9IG11c3RFbmRBYnMsCiAgICAgICAgc3JjUGF0aCA9IHJlc3VsdC5wYXRobmFtZSAmJiByZXN1bHQucGF0aG5hbWUuc3BsaXQoJy8nKSB8fCBbXSwKICAgICAgICByZWxQYXRoID0gcmVsYXRpdmUucGF0aG5hbWUgJiYgcmVsYXRpdmUucGF0aG5hbWUuc3BsaXQoJy8nKSB8fCBbXSwKICAgICAgICBwc3ljaG90aWMgPSByZXN1bHQucHJvdG9jb2wgJiYgIXNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdOwogIAogICAgLy8gaWYgdGhlIHVybCBpcyBhIG5vbi1zbGFzaGVkIHVybCwgdGhlbiByZWxhdGl2ZQogICAgLy8gbGlua3MgbGlrZSAuLi8uLiBzaG91bGQgYmUgYWJsZQogICAgLy8gdG8gY3Jhd2wgdXAgdG8gdGhlIGhvc3RuYW1lLCBhcyB3ZWxsLiAgVGhpcyBpcyBzdHJhbmdlLgogICAgLy8gcmVzdWx0LnByb3RvY29sIGhhcyBhbHJlYWR5IGJlZW4gc2V0IGJ5IG5vdy4KICAgIC8vIExhdGVyIG9uLCBwdXQgdGhlIGZpcnN0IHBhdGggcGFydCBpbnRvIHRoZSBob3N0IGZpZWxkLgogICAgaWYgKHBzeWNob3RpYykgewogICAgICByZXN1bHQuaG9zdG5hbWUgPSAnJzsKICAgICAgcmVzdWx0LnBvcnQgPSBudWxsOwogICAgICBpZiAocmVzdWx0Lmhvc3QpIHsKICAgICAgICBpZiAoc3JjUGF0aFswXSA9PT0gJycpIHNyY1BhdGhbMF0gPSByZXN1bHQuaG9zdDsKICAgICAgICBlbHNlIHNyY1BhdGgudW5zaGlmdChyZXN1bHQuaG9zdCk7CiAgICAgIH0KICAgICAgcmVzdWx0Lmhvc3QgPSAnJzsKICAgICAgaWYgKHJlbGF0aXZlLnByb3RvY29sKSB7CiAgICAgICAgcmVsYXRpdmUuaG9zdG5hbWUgPSBudWxsOwogICAgICAgIHJlbGF0aXZlLnBvcnQgPSBudWxsOwogICAgICAgIGlmIChyZWxhdGl2ZS5ob3N0KSB7CiAgICAgICAgICBpZiAocmVsUGF0aFswXSA9PT0gJycpIHJlbFBhdGhbMF0gPSByZWxhdGl2ZS5ob3N0OwogICAgICAgICAgZWxzZSByZWxQYXRoLnVuc2hpZnQocmVsYXRpdmUuaG9zdCk7CiAgICAgICAgfQogICAgICAgIHJlbGF0aXZlLmhvc3QgPSBudWxsOwogICAgICB9CiAgICAgIG11c3RFbmRBYnMgPSBtdXN0RW5kQWJzICYmIChyZWxQYXRoWzBdID09PSAnJyB8fCBzcmNQYXRoWzBdID09PSAnJyk7CiAgICB9CiAgCiAgICBpZiAoaXNSZWxBYnMpIHsKICAgICAgLy8gaXQncyBhYnNvbHV0ZS4KICAgICAgcmVzdWx0Lmhvc3QgPSAocmVsYXRpdmUuaG9zdCB8fCByZWxhdGl2ZS5ob3N0ID09PSAnJykgPwogICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3QgOiByZXN1bHQuaG9zdDsKICAgICAgcmVzdWx0Lmhvc3RuYW1lID0gKHJlbGF0aXZlLmhvc3RuYW1lIHx8IHJlbGF0aXZlLmhvc3RuYW1lID09PSAnJykgPwogICAgICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZS5ob3N0bmFtZSA6IHJlc3VsdC5ob3N0bmFtZTsKICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAgIHNyY1BhdGggPSByZWxQYXRoOwogICAgICAvLyBmYWxsIHRocm91Z2ggdG8gdGhlIGRvdC1oYW5kbGluZyBiZWxvdy4KICAgIH0gZWxzZSBpZiAocmVsUGF0aC5sZW5ndGgpIHsKICAgICAgLy8gaXQncyByZWxhdGl2ZQogICAgICAvLyB0aHJvdyBhd2F5IHRoZSBleGlzdGluZyBmaWxlLCBhbmQgdGFrZSB0aGUgbmV3IHBhdGggaW5zdGVhZC4KICAgICAgaWYgKCFzcmNQYXRoKSBzcmNQYXRoID0gW107CiAgICAgIHNyY1BhdGgucG9wKCk7CiAgICAgIHNyY1BhdGggPSBzcmNQYXRoLmNvbmNhdChyZWxQYXRoKTsKICAgICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICB9IGVsc2UgaWYgKCFpc051bGxPclVuZGVmaW5lZChyZWxhdGl2ZS5zZWFyY2gpKSB7CiAgICAgIC8vIGp1c3QgcHVsbCBvdXQgdGhlIHNlYXJjaC4KICAgICAgLy8gbGlrZSBocmVmPSc/Zm9vJy4KICAgICAgLy8gUHV0IHRoaXMgYWZ0ZXIgdGhlIG90aGVyIHR3byBjYXNlcyBiZWNhdXNlIGl0IHNpbXBsaWZpZXMgdGhlIGJvb2xlYW5zCiAgICAgIGlmIChwc3ljaG90aWMpIHsKICAgICAgICByZXN1bHQuaG9zdG5hbWUgPSByZXN1bHQuaG9zdCA9IHNyY1BhdGguc2hpZnQoKTsKICAgICAgICAvL29jY2F0aW9uYWx5IHRoZSBhdXRoIGNhbiBnZXQgc3R1Y2sgb25seSBpbiBob3N0CiAgICAgICAgLy90aGlzIGVzcGVjaWFseSBoYXBwZW5zIGluIGNhc2VzIGxpa2UKICAgICAgICAvL3VybC5yZXNvbHZlT2JqZWN0KCdtYWlsdG86bG9jYWwxQGRvbWFpbjEnLCAnbG9jYWwyQGRvbWFpbjInKQogICAgICAgIHZhciBhdXRoSW5Ib3N0ID0gcmVzdWx0Lmhvc3QgJiYgcmVzdWx0Lmhvc3QuaW5kZXhPZignQCcpID4gMCA/CiAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQuaG9zdC5zcGxpdCgnQCcpIDogZmFsc2U7CiAgICAgICAgaWYgKGF1dGhJbkhvc3QpIHsKICAgICAgICAgIHJlc3VsdC5hdXRoID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgICAgcmVzdWx0Lmhvc3QgPSByZXN1bHQuaG9zdG5hbWUgPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICAgIGlmICghaXNOdWxsKHJlc3VsdC5wYXRobmFtZSkgfHwgIWlzTnVsbChyZXN1bHQuc2VhcmNoKSkgewogICAgICAgIHJlc3VsdC5wYXRoID0gKHJlc3VsdC5wYXRobmFtZSA/IHJlc3VsdC5wYXRobmFtZSA6ICcnKSArCiAgICAgICAgICAgICAgICAgICAgICAocmVzdWx0LnNlYXJjaCA/IHJlc3VsdC5zZWFyY2ggOiAnJyk7CiAgICAgIH0KICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICBpZiAoIXNyY1BhdGgubGVuZ3RoKSB7CiAgICAgIC8vIG5vIHBhdGggYXQgYWxsLiAgZWFzeS4KICAgICAgLy8gd2UndmUgYWxyZWFkeSBoYW5kbGVkIHRoZSBvdGhlciBzdHVmZiBhYm92ZS4KICAgICAgcmVzdWx0LnBhdGhuYW1lID0gbnVsbDsKICAgICAgLy90byBzdXBwb3J0IGh0dHAucmVxdWVzdAogICAgICBpZiAocmVzdWx0LnNlYXJjaCkgewogICAgICAgIHJlc3VsdC5wYXRoID0gJy8nICsgcmVzdWx0LnNlYXJjaDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgICAgIH0KICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgCiAgICAvLyBpZiBhIHVybCBFTkRzIGluIC4gb3IgLi4sIHRoZW4gaXQgbXVzdCBnZXQgYSB0cmFpbGluZyBzbGFzaC4KICAgIC8vIGhvd2V2ZXIsIGlmIGl0IGVuZHMgaW4gYW55dGhpbmcgZWxzZSBub24tc2xhc2h5LAogICAgLy8gdGhlbiBpdCBtdXN0IE5PVCBnZXQgYSB0cmFpbGluZyBzbGFzaC4KICAgIHZhciBsYXN0ID0gc3JjUGF0aC5zbGljZSgtMSlbMF07CiAgICB2YXIgaGFzVHJhaWxpbmdTbGFzaCA9ICgKICAgICAgICAocmVzdWx0Lmhvc3QgfHwgcmVsYXRpdmUuaG9zdCkgJiYgKGxhc3QgPT09ICcuJyB8fCBsYXN0ID09PSAnLi4nKSB8fAogICAgICAgIGxhc3QgPT09ICcnKTsKICAKICAgIC8vIHN0cmlwIHNpbmdsZSBkb3RzLCByZXNvbHZlIGRvdWJsZSBkb3RzIHRvIHBhcmVudCBkaXIKICAgIC8vIGlmIHRoZSBwYXRoIHRyaWVzIHRvIGdvIGFib3ZlIHRoZSByb290LCBgdXBgIGVuZHMgdXAgPiAwCiAgICB2YXIgdXAgPSAwOwogICAgZm9yICh2YXIgaSA9IHNyY1BhdGgubGVuZ3RoOyBpID49IDA7IGktLSkgewogICAgICBsYXN0ID0gc3JjUGF0aFtpXTsKICAgICAgaWYgKGxhc3QgPT0gJy4nKSB7CiAgICAgICAgc3JjUGF0aC5zcGxpY2UoaSwgMSk7CiAgICAgIH0gZWxzZSBpZiAobGFzdCA9PT0gJy4uJykgewogICAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICAgIHVwKys7CiAgICAgIH0gZWxzZSBpZiAodXApIHsKICAgICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgICB1cC0tOwogICAgICB9CiAgICB9CiAgCiAgICAvLyBpZiB0aGUgcGF0aCBpcyBhbGxvd2VkIHRvIGdvIGFib3ZlIHRoZSByb290LCByZXN0b3JlIGxlYWRpbmcgLi5zCiAgICBpZiAoIW11c3RFbmRBYnMgJiYgIXJlbW92ZUFsbERvdHMpIHsKICAgICAgZm9yICg7IHVwLS07IHVwKSB7CiAgICAgICAgc3JjUGF0aC51bnNoaWZ0KCcuLicpOwogICAgICB9CiAgICB9CiAgCiAgICBpZiAobXVzdEVuZEFicyAmJiBzcmNQYXRoWzBdICE9PSAnJyAmJgogICAgICAgICghc3JjUGF0aFswXSB8fCBzcmNQYXRoWzBdLmNoYXJBdCgwKSAhPT0gJy8nKSkgewogICAgICBzcmNQYXRoLnVuc2hpZnQoJycpOwogICAgfQogIAogICAgaWYgKGhhc1RyYWlsaW5nU2xhc2ggJiYgKHNyY1BhdGguam9pbignLycpLnN1YnN0cigtMSkgIT09ICcvJykpIHsKICAgICAgc3JjUGF0aC5wdXNoKCcnKTsKICAgIH0KICAKICAgIHZhciBpc0Fic29sdXRlID0gc3JjUGF0aFswXSA9PT0gJycgfHwKICAgICAgICAoc3JjUGF0aFswXSAmJiBzcmNQYXRoWzBdLmNoYXJBdCgwKSA9PT0gJy8nKTsKICAKICAgIC8vIHB1dCB0aGUgaG9zdCBiYWNrCiAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gaXNBYnNvbHV0ZSA/ICcnIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmNQYXRoLmxlbmd0aCA/IHNyY1BhdGguc2hpZnQoKSA6ICcnOwogICAgICAvL29jY2F0aW9uYWx5IHRoZSBhdXRoIGNhbiBnZXQgc3R1Y2sgb25seSBpbiBob3N0CiAgICAgIC8vdGhpcyBlc3BlY2lhbHkgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICAgIHZhciBhdXRoSW5Ib3N0ID0gcmVzdWx0Lmhvc3QgJiYgcmVzdWx0Lmhvc3QuaW5kZXhPZignQCcpID4gMCA/CiAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmhvc3Quc3BsaXQoJ0AnKSA6IGZhbHNlOwogICAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICAgIHJlc3VsdC5hdXRoID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgIHJlc3VsdC5ob3N0ID0gcmVzdWx0Lmhvc3RuYW1lID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICB9CiAgICB9CiAgCiAgICBtdXN0RW5kQWJzID0gbXVzdEVuZEFicyB8fCAocmVzdWx0Lmhvc3QgJiYgc3JjUGF0aC5sZW5ndGgpOwogIAogICAgaWYgKG11c3RFbmRBYnMgJiYgIWlzQWJzb2x1dGUpIHsKICAgICAgc3JjUGF0aC51bnNoaWZ0KCcnKTsKICAgIH0KICAKICAgIGlmICghc3JjUGF0aC5sZW5ndGgpIHsKICAgICAgcmVzdWx0LnBhdGhuYW1lID0gbnVsbDsKICAgICAgcmVzdWx0LnBhdGggPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0LnBhdGhuYW1lID0gc3JjUGF0aC5qb2luKCcvJyk7CiAgICB9CiAgCiAgICAvL3RvIHN1cHBvcnQgcmVxdWVzdC5odHRwCiAgICBpZiAoIWlzTnVsbChyZXN1bHQucGF0aG5hbWUpIHx8ICFpc051bGwocmVzdWx0LnNlYXJjaCkpIHsKICAgICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgICAocmVzdWx0LnNlYXJjaCA/IHJlc3VsdC5zZWFyY2ggOiAnJyk7CiAgICB9CiAgICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGggfHwgcmVzdWx0LmF1dGg7CiAgICByZXN1bHQuc2xhc2hlcyA9IHJlc3VsdC5zbGFzaGVzIHx8IHJlbGF0aXZlLnNsYXNoZXM7CiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKICAKICBVcmwucHJvdG90eXBlLnBhcnNlSG9zdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGhvc3QgPSB0aGlzLmhvc3Q7CiAgICB2YXIgcG9ydCA9IHBvcnRQYXR0ZXJuLmV4ZWMoaG9zdCk7CiAgICBpZiAocG9ydCkgewogICAgICBwb3J0ID0gcG9ydFswXTsKICAgICAgaWYgKHBvcnQgIT09ICc6JykgewogICAgICAgIHRoaXMucG9ydCA9IHBvcnQuc3Vic3RyKDEpOwogICAgICB9CiAgICAgIGhvc3QgPSBob3N0LnN1YnN0cigwLCBob3N0Lmxlbmd0aCAtIHBvcnQubGVuZ3RoKTsKICAgIH0KICAgIGlmIChob3N0KSB0aGlzLmhvc3RuYW1lID0gaG9zdDsKICB9OwogIAogIGZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICJzdHJpbmciOwogIH0KICAKICBmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7CiAgfQogIAogIGZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IG51bGw7CiAgfQogIGZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuICBhcmcgPT0gbnVsbDsKICB9CiAgCiAgfSx7InB1bnljb2RlIjo4MCwicXVlcnlzdHJpbmciOjg5fV0sOTU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIGlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgLy8gaW1wbGVtZW50YXRpb24gZnJvbSBzdGFuZGFyZCBub2RlLmpzICd1dGlsJyBtb2R1bGUKICAgIG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaW5oZXJpdHMoY3Rvciwgc3VwZXJDdG9yKSB7CiAgICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICAgIGN0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckN0b3IucHJvdG90eXBlLCB7CiAgICAgICAgY29uc3RydWN0b3I6IHsKICAgICAgICAgIHZhbHVlOiBjdG9yLAogICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9OwogIH0gZWxzZSB7CiAgICAvLyBvbGQgc2Nob29sIHNoaW0gZm9yIG9sZCBicm93c2VycwogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgICAgdmFyIFRlbXBDdG9yID0gZnVuY3Rpb24gKCkge30KICAgICAgVGVtcEN0b3IucHJvdG90eXBlID0gc3VwZXJDdG9yLnByb3RvdHlwZQogICAgICBjdG9yLnByb3RvdHlwZSA9IG5ldyBUZW1wQ3RvcigpCiAgICAgIGN0b3IucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY3RvcgogICAgfQogIH0KICAKICB9LHt9XSw5NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpc0J1ZmZlcihhcmcpIHsKICAgIHJldHVybiBhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcKICAgICAgJiYgdHlwZW9mIGFyZy5jb3B5ID09PSAnZnVuY3Rpb24nCiAgICAgICYmIHR5cGVvZiBhcmcuZmlsbCA9PT0gJ2Z1bmN0aW9uJwogICAgICAmJiB0eXBlb2YgYXJnLnJlYWRVSW50OCA9PT0gJ2Z1bmN0aW9uJzsKICB9CiAgfSx7fV0sOTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIChmdW5jdGlvbiAocHJvY2VzcyxnbG9iYWwpeyhmdW5jdGlvbiAoKXsKICAvLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KICAvLwogIC8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCiAgLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQogIC8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKICAvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCiAgLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAogIC8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQogIC8vIGZvbGxvd2luZyBjb25kaXRpb25zOgogIC8vCiAgLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKICAvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICAvLwogIC8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCiAgLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgogIC8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KICAvLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKICAvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKICAvLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCiAgLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KICAKICB2YXIgZm9ybWF0UmVnRXhwID0gLyVbc2RqJV0vZzsKICBleHBvcnRzLmZvcm1hdCA9IGZ1bmN0aW9uKGYpIHsKICAgIGlmICghaXNTdHJpbmcoZikpIHsKICAgICAgdmFyIG9iamVjdHMgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvYmplY3RzLnB1c2goaW5zcGVjdChhcmd1bWVudHNbaV0pKTsKICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0cy5qb2luKCcgJyk7CiAgICB9CiAgCiAgICB2YXIgaSA9IDE7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgIHZhciBsZW4gPSBhcmdzLmxlbmd0aDsKICAgIHZhciBzdHIgPSBTdHJpbmcoZikucmVwbGFjZShmb3JtYXRSZWdFeHAsIGZ1bmN0aW9uKHgpIHsKICAgICAgaWYgKHggPT09ICclJScpIHJldHVybiAnJSc7CiAgICAgIGlmIChpID49IGxlbikgcmV0dXJuIHg7CiAgICAgIHN3aXRjaCAoeCkgewogICAgICAgIGNhc2UgJyVzJzogcmV0dXJuIFN0cmluZyhhcmdzW2krK10pOwogICAgICAgIGNhc2UgJyVkJzogcmV0dXJuIE51bWJlcihhcmdzW2krK10pOwogICAgICAgIGNhc2UgJyVqJzoKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhcmdzW2krK10pOwogICAgICAgICAgfSBjYXRjaCAoXykgewogICAgICAgICAgICByZXR1cm4gJ1tDaXJjdWxhcl0nOwogICAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4geDsKICAgICAgfQogICAgfSk7CiAgICBmb3IgKHZhciB4ID0gYXJnc1tpXTsgaSA8IGxlbjsgeCA9IGFyZ3NbKytpXSkgewogICAgICBpZiAoaXNOdWxsKHgpIHx8ICFpc09iamVjdCh4KSkgewogICAgICAgIHN0ciArPSAnICcgKyB4OwogICAgICB9IGVsc2UgewogICAgICAgIHN0ciArPSAnICcgKyBpbnNwZWN0KHgpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc3RyOwogIH07CiAgCiAgCiAgLy8gTWFyayB0aGF0IGEgbWV0aG9kIHNob3VsZCBub3QgYmUgdXNlZC4KICAvLyBSZXR1cm5zIGEgbW9kaWZpZWQgZnVuY3Rpb24gd2hpY2ggd2FybnMgb25jZSBieSBkZWZhdWx0LgogIC8vIElmIC0tbm8tZGVwcmVjYXRpb24gaXMgc2V0LCB0aGVuIGl0IGlzIGEgbm8tb3AuCiAgZXhwb3J0cy5kZXByZWNhdGUgPSBmdW5jdGlvbihmbiwgbXNnKSB7CiAgICAvLyBBbGxvdyBmb3IgZGVwcmVjYXRpbmcgdGhpbmdzIGluIHRoZSBwcm9jZXNzIG9mIHN0YXJ0aW5nIHVwLgogICAgaWYgKGlzVW5kZWZpbmVkKGdsb2JhbC5wcm9jZXNzKSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuZGVwcmVjYXRlKGZuLCBtc2cpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgCiAgICBpZiAocHJvY2Vzcy5ub0RlcHJlY2F0aW9uID09PSB0cnVlKSB7CiAgICAgIHJldHVybiBmbjsKICAgIH0KICAKICAgIHZhciB3YXJuZWQgPSBmYWxzZTsKICAgIGZ1bmN0aW9uIGRlcHJlY2F0ZWQoKSB7CiAgICAgIGlmICghd2FybmVkKSB7CiAgICAgICAgaWYgKHByb2Nlc3MudGhyb3dEZXByZWNhdGlvbikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLnRyYWNlRGVwcmVjYXRpb24pIHsKICAgICAgICAgIGNvbnNvbGUudHJhY2UobXNnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgICAgIH0KICAgICAgICB3YXJuZWQgPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIAogICAgcmV0dXJuIGRlcHJlY2F0ZWQ7CiAgfTsKICAKICAKICB2YXIgZGVidWdzID0ge307CiAgdmFyIGRlYnVnRW52aXJvbjsKICBleHBvcnRzLmRlYnVnbG9nID0gZnVuY3Rpb24oc2V0KSB7CiAgICBpZiAoaXNVbmRlZmluZWQoZGVidWdFbnZpcm9uKSkKICAgICAgZGVidWdFbnZpcm9uID0gcHJvY2Vzcy5lbnYuTk9ERV9ERUJVRyB8fCAnJzsKICAgIHNldCA9IHNldC50b1VwcGVyQ2FzZSgpOwogICAgaWYgKCFkZWJ1Z3Nbc2V0XSkgewogICAgICBpZiAobmV3IFJlZ0V4cCgnXFxiJyArIHNldCArICdcXGInLCAnaScpLnRlc3QoZGVidWdFbnZpcm9uKSkgewogICAgICAgIHZhciBwaWQgPSBwcm9jZXNzLnBpZDsKICAgICAgICBkZWJ1Z3Nbc2V0XSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG1zZyA9IGV4cG9ydHMuZm9ybWF0LmFwcGx5KGV4cG9ydHMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCclcyAlZDogJXMnLCBzZXQsIHBpZCwgbXNnKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGRlYnVnc1tzZXRdID0gZnVuY3Rpb24oKSB7fTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlYnVnc1tzZXRdOwogIH07CiAgCiAgCiAgLyoqCiAgICogRWNob3MgdGhlIHZhbHVlIG9mIGEgdmFsdWUuIFRyeXMgdG8gcHJpbnQgdGhlIHZhbHVlIG91dAogICAqIGluIHRoZSBiZXN0IHdheSBwb3NzaWJsZSBnaXZlbiB0aGUgZGlmZmVyZW50IHR5cGVzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHByaW50IG91dC4KICAgKiBAcGFyYW0ge09iamVjdH0gb3B0cyBPcHRpb25hbCBvcHRpb25zIG9iamVjdCB0aGF0IGFsdGVycyB0aGUgb3V0cHV0LgogICAqLwogIC8qIGxlZ2FjeTogb2JqLCBzaG93SGlkZGVuLCBkZXB0aCwgY29sb3JzKi8KICBmdW5jdGlvbiBpbnNwZWN0KG9iaiwgb3B0cykgewogICAgLy8gZGVmYXVsdCBvcHRpb25zCiAgICB2YXIgY3R4ID0gewogICAgICBzZWVuOiBbXSwKICAgICAgc3R5bGl6ZTogc3R5bGl6ZU5vQ29sb3IKICAgIH07CiAgICAvLyBsZWdhY3kuLi4KICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID49IDMpIGN0eC5kZXB0aCA9IGFyZ3VtZW50c1syXTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID49IDQpIGN0eC5jb2xvcnMgPSBhcmd1bWVudHNbM107CiAgICBpZiAoaXNCb29sZWFuKG9wdHMpKSB7CiAgICAgIC8vIGxlZ2FjeS4uLgogICAgICBjdHguc2hvd0hpZGRlbiA9IG9wdHM7CiAgICB9IGVsc2UgaWYgKG9wdHMpIHsKICAgICAgLy8gZ290IGFuICJvcHRpb25zIiBvYmplY3QKICAgICAgZXhwb3J0cy5fZXh0ZW5kKGN0eCwgb3B0cyk7CiAgICB9CiAgICAvLyBzZXQgZGVmYXVsdCBvcHRpb25zCiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LnNob3dIaWRkZW4pKSBjdHguc2hvd0hpZGRlbiA9IGZhbHNlOwogICAgaWYgKGlzVW5kZWZpbmVkKGN0eC5kZXB0aCkpIGN0eC5kZXB0aCA9IDI7CiAgICBpZiAoaXNVbmRlZmluZWQoY3R4LmNvbG9ycykpIGN0eC5jb2xvcnMgPSBmYWxzZTsKICAgIGlmIChpc1VuZGVmaW5lZChjdHguY3VzdG9tSW5zcGVjdCkpIGN0eC5jdXN0b21JbnNwZWN0ID0gdHJ1ZTsKICAgIGlmIChjdHguY29sb3JzKSBjdHguc3R5bGl6ZSA9IHN0eWxpemVXaXRoQ29sb3I7CiAgICByZXR1cm4gZm9ybWF0VmFsdWUoY3R4LCBvYmosIGN0eC5kZXB0aCk7CiAgfQogIGV4cG9ydHMuaW5zcGVjdCA9IGluc3BlY3Q7CiAgCiAgCiAgLy8gaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9BTlNJX2VzY2FwZV9jb2RlI2dyYXBoaWNzCiAgaW5zcGVjdC5jb2xvcnMgPSB7CiAgICAnYm9sZCcgOiBbMSwgMjJdLAogICAgJ2l0YWxpYycgOiBbMywgMjNdLAogICAgJ3VuZGVybGluZScgOiBbNCwgMjRdLAogICAgJ2ludmVyc2UnIDogWzcsIDI3XSwKICAgICd3aGl0ZScgOiBbMzcsIDM5XSwKICAgICdncmV5JyA6IFs5MCwgMzldLAogICAgJ2JsYWNrJyA6IFszMCwgMzldLAogICAgJ2JsdWUnIDogWzM0LCAzOV0sCiAgICAnY3lhbicgOiBbMzYsIDM5XSwKICAgICdncmVlbicgOiBbMzIsIDM5XSwKICAgICdtYWdlbnRhJyA6IFszNSwgMzldLAogICAgJ3JlZCcgOiBbMzEsIDM5XSwKICAgICd5ZWxsb3cnIDogWzMzLCAzOV0KICB9OwogIAogIC8vIERvbid0IHVzZSAnYmx1ZScgbm90IHZpc2libGUgb24gY21kLmV4ZQogIGluc3BlY3Quc3R5bGVzID0gewogICAgJ3NwZWNpYWwnOiAnY3lhbicsCiAgICAnbnVtYmVyJzogJ3llbGxvdycsCiAgICAnYm9vbGVhbic6ICd5ZWxsb3cnLAogICAgJ3VuZGVmaW5lZCc6ICdncmV5JywKICAgICdudWxsJzogJ2JvbGQnLAogICAgJ3N0cmluZyc6ICdncmVlbicsCiAgICAnZGF0ZSc6ICdtYWdlbnRhJywKICAgIC8vICJuYW1lIjogaW50ZW50aW9uYWxseSBub3Qgc3R5bGluZwogICAgJ3JlZ2V4cCc6ICdyZWQnCiAgfTsKICAKICAKICBmdW5jdGlvbiBzdHlsaXplV2l0aENvbG9yKHN0ciwgc3R5bGVUeXBlKSB7CiAgICB2YXIgc3R5bGUgPSBpbnNwZWN0LnN0eWxlc1tzdHlsZVR5cGVdOwogIAogICAgaWYgKHN0eWxlKSB7CiAgICAgIHJldHVybiAnXHUwMDFiWycgKyBpbnNwZWN0LmNvbG9yc1tzdHlsZV1bMF0gKyAnbScgKyBzdHIgKwogICAgICAgICAgICAgJ1x1MDAxYlsnICsgaW5zcGVjdC5jb2xvcnNbc3R5bGVdWzFdICsgJ20nOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICB9CiAgCiAgCiAgZnVuY3Rpb24gc3R5bGl6ZU5vQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICAgIHJldHVybiBzdHI7CiAgfQogIAogIAogIGZ1bmN0aW9uIGFycmF5VG9IYXNoKGFycmF5KSB7CiAgICB2YXIgaGFzaCA9IHt9OwogIAogICAgYXJyYXkuZm9yRWFjaChmdW5jdGlvbih2YWwsIGlkeCkgewogICAgICBoYXNoW3ZhbF0gPSB0cnVlOwogICAgfSk7CiAgCiAgICByZXR1cm4gaGFzaDsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0VmFsdWUoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzKSB7CiAgICAvLyBQcm92aWRlIGEgaG9vayBmb3IgdXNlci1zcGVjaWZpZWQgaW5zcGVjdCBmdW5jdGlvbnMuCiAgICAvLyBDaGVjayB0aGF0IHZhbHVlIGlzIGFuIG9iamVjdCB3aXRoIGFuIGluc3BlY3QgZnVuY3Rpb24gb24gaXQKICAgIGlmIChjdHguY3VzdG9tSW5zcGVjdCAmJgogICAgICAgIHZhbHVlICYmCiAgICAgICAgaXNGdW5jdGlvbih2YWx1ZS5pbnNwZWN0KSAmJgogICAgICAgIC8vIEZpbHRlciBvdXQgdGhlIHV0aWwgbW9kdWxlLCBpdCdzIGluc3BlY3QgZnVuY3Rpb24gaXMgc3BlY2lhbAogICAgICAgIHZhbHVlLmluc3BlY3QgIT09IGV4cG9ydHMuaW5zcGVjdCAmJgogICAgICAgIC8vIEFsc28gZmlsdGVyIG91dCBhbnkgcHJvdG90eXBlIG9iamVjdHMgdXNpbmcgdGhlIGNpcmN1bGFyIGNoZWNrLgogICAgICAgICEodmFsdWUuY29uc3RydWN0b3IgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlID09PSB2YWx1ZSkpIHsKICAgICAgdmFyIHJldCA9IHZhbHVlLmluc3BlY3QocmVjdXJzZVRpbWVzLCBjdHgpOwogICAgICBpZiAoIWlzU3RyaW5nKHJldCkpIHsKICAgICAgICByZXQgPSBmb3JtYXRWYWx1ZShjdHgsIHJldCwgcmVjdXJzZVRpbWVzKTsKICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfQogIAogICAgLy8gUHJpbWl0aXZlIHR5cGVzIGNhbm5vdCBoYXZlIHByb3BlcnRpZXMKICAgIHZhciBwcmltaXRpdmUgPSBmb3JtYXRQcmltaXRpdmUoY3R4LCB2YWx1ZSk7CiAgICBpZiAocHJpbWl0aXZlKSB7CiAgICAgIHJldHVybiBwcmltaXRpdmU7CiAgICB9CiAgCiAgICAvLyBMb29rIHVwIHRoZSBrZXlzIG9mIHRoZSBvYmplY3QuCiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICAgIHZhciB2aXNpYmxlS2V5cyA9IGFycmF5VG9IYXNoKGtleXMpOwogIAogICAgaWYgKGN0eC5zaG93SGlkZGVuKSB7CiAgICAgIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBJRSBkb2Vzbid0IG1ha2UgZXJyb3IgZmllbGRzIG5vbi1lbnVtZXJhYmxlCiAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvZHd3NTJzYnQodj12cy45NCkuYXNweAogICAgaWYgKGlzRXJyb3IodmFsdWUpCiAgICAgICAgJiYgKGtleXMuaW5kZXhPZignbWVzc2FnZScpID49IDAgfHwga2V5cy5pbmRleE9mKCdkZXNjcmlwdGlvbicpID49IDApKSB7CiAgICAgIHJldHVybiBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICB9CiAgCiAgICAvLyBTb21lIHR5cGUgb2Ygb2JqZWN0IHdpdGhvdXQgcHJvcGVydGllcyBjYW4gYmUgc2hvcnRjdXR0ZWQuCiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHsKICAgICAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICAgICAgdmFyIG5hbWUgPSB2YWx1ZS5uYW1lID8gJzogJyArIHZhbHVlLm5hbWUgOiAnJzsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ1tGdW5jdGlvbicgKyBuYW1lICsgJ10nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ3JlZ2V4cCcpOwogICAgICB9CiAgICAgIGlmIChpc0RhdGUodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKERhdGUucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAnZGF0ZScpOwogICAgICB9CiAgICAgIGlmIChpc0Vycm9yKHZhbHVlKSkgewogICAgICAgIHJldHVybiBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAKICAgIHZhciBiYXNlID0gJycsIGFycmF5ID0gZmFsc2UsIGJyYWNlcyA9IFsneycsICd9J107CiAgCiAgICAvLyBNYWtlIEFycmF5IHNheSB0aGF0IHRoZXkgYXJlIEFycmF5CiAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgYXJyYXkgPSB0cnVlOwogICAgICBicmFjZXMgPSBbJ1snLCAnXSddOwogICAgfQogIAogICAgLy8gTWFrZSBmdW5jdGlvbnMgc2F5IHRoYXQgdGhleSBhcmUgZnVuY3Rpb25zCiAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgdmFyIG4gPSB2YWx1ZS5uYW1lID8gJzogJyArIHZhbHVlLm5hbWUgOiAnJzsKICAgICAgYmFzZSA9ICcgW0Z1bmN0aW9uJyArIG4gKyAnXSc7CiAgICB9CiAgCiAgICAvLyBNYWtlIFJlZ0V4cHMgc2F5IHRoYXQgdGhleSBhcmUgUmVnRXhwcwogICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICBiYXNlID0gJyAnICsgUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAKICAgIC8vIE1ha2UgZGF0ZXMgd2l0aCBwcm9wZXJ0aWVzIGZpcnN0IHNheSB0aGUgZGF0ZQogICAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgYmFzZSA9ICcgJyArIERhdGUucHJvdG90eXBlLnRvVVRDU3RyaW5nLmNhbGwodmFsdWUpOwogICAgfQogIAogICAgLy8gTWFrZSBlcnJvciB3aXRoIG1lc3NhZ2UgZmlyc3Qgc2F5IHRoZSBlcnJvcgogICAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICAgIGJhc2UgPSAnICcgKyBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICB9CiAgCiAgICBpZiAoa2V5cy5sZW5ndGggPT09IDAgJiYgKCFhcnJheSB8fCB2YWx1ZS5sZW5ndGggPT0gMCkpIHsKICAgICAgcmV0dXJuIGJyYWNlc1swXSArIGJhc2UgKyBicmFjZXNbMV07CiAgICB9CiAgCiAgICBpZiAocmVjdXJzZVRpbWVzIDwgMCkgewogICAgICBpZiAoaXNSZWdFeHAodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdyZWdleHAnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ1tPYmplY3RdJywgJ3NwZWNpYWwnKTsKICAgICAgfQogICAgfQogIAogICAgY3R4LnNlZW4ucHVzaCh2YWx1ZSk7CiAgCiAgICB2YXIgb3V0cHV0OwogICAgaWYgKGFycmF5KSB7CiAgICAgIG91dHB1dCA9IGZvcm1hdEFycmF5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleXMpOwogICAgfSBlbHNlIHsKICAgICAgb3V0cHV0ID0ga2V5cy5tYXAoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleSwgYXJyYXkpOwogICAgICB9KTsKICAgIH0KICAKICAgIGN0eC5zZWVuLnBvcCgpOwogIAogICAgcmV0dXJuIHJlZHVjZVRvU2luZ2xlU3RyaW5nKG91dHB1dCwgYmFzZSwgYnJhY2VzKTsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0UHJpbWl0aXZlKGN0eCwgdmFsdWUpIHsKICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgndW5kZWZpbmVkJywgJ3VuZGVmaW5lZCcpOwogICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICB2YXIgc2ltcGxlID0gJ1wnJyArIEpTT04uc3RyaW5naWZ5KHZhbHVlKS5yZXBsYWNlKC9eInwiJC9nLCAnJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJy9nLCAiXFwnIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXFwiL2csICciJykgKyAnXCcnOwogICAgICByZXR1cm4gY3R4LnN0eWxpemUoc2ltcGxlLCAnc3RyaW5nJyk7CiAgICB9CiAgICBpZiAoaXNOdW1iZXIodmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJycgKyB2YWx1ZSwgJ251bWJlcicpOwogICAgaWYgKGlzQm9vbGVhbih2YWx1ZSkpCiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnJyArIHZhbHVlLCAnYm9vbGVhbicpOwogICAgLy8gRm9yIHNvbWUgcmVhc29uIHR5cGVvZiBudWxsIGlzICJvYmplY3QiLCBzbyBzcGVjaWFsIGNhc2UgaGVyZS4KICAgIGlmIChpc051bGwodmFsdWUpKQogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ251bGwnLCAnbnVsbCcpOwogIH0KICAKICAKICBmdW5jdGlvbiBmb3JtYXRFcnJvcih2YWx1ZSkgewogICAgcmV0dXJuICdbJyArIEVycm9yLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSArICddJzsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0QXJyYXkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5cykgewogICAgdmFyIG91dHB1dCA9IFtdOwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB2YWx1ZS5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgaWYgKGhhc093blByb3BlcnR5KHZhbHVlLCBTdHJpbmcoaSkpKSB7CiAgICAgICAgb3V0cHV0LnB1c2goZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywKICAgICAgICAgICAgU3RyaW5nKGkpLCB0cnVlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0cHV0LnB1c2goJycpOwogICAgICB9CiAgICB9CiAgICBrZXlzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmICgha2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgICAgb3V0cHV0LnB1c2goZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywKICAgICAgICAgICAga2V5LCB0cnVlKSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG91dHB1dDsKICB9CiAgCiAgCiAgZnVuY3Rpb24gZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywga2V5LCBhcnJheSkgewogICAgdmFyIG5hbWUsIHN0ciwgZGVzYzsKICAgIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHZhbHVlLCBrZXkpIHx8IHsgdmFsdWU6IHZhbHVlW2tleV0gfTsKICAgIGlmIChkZXNjLmdldCkgewogICAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0dldHRlci9TZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0dldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoZGVzYy5zZXQpIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgICB9CiAgICB9CiAgICBpZiAoIWhhc093blByb3BlcnR5KHZpc2libGVLZXlzLCBrZXkpKSB7CiAgICAgIG5hbWUgPSAnWycgKyBrZXkgKyAnXSc7CiAgICB9CiAgICBpZiAoIXN0cikgewogICAgICBpZiAoY3R4LnNlZW4uaW5kZXhPZihkZXNjLnZhbHVlKSA8IDApIHsKICAgICAgICBpZiAoaXNOdWxsKHJlY3Vyc2VUaW1lcykpIHsKICAgICAgICAgIHN0ciA9IGZvcm1hdFZhbHVlKGN0eCwgZGVzYy52YWx1ZSwgbnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0ciA9IGZvcm1hdFZhbHVlKGN0eCwgZGVzYy52YWx1ZSwgcmVjdXJzZVRpbWVzIC0gMSk7CiAgICAgICAgfQogICAgICAgIGlmIChzdHIuaW5kZXhPZignXG4nKSA+IC0xKSB7CiAgICAgICAgICBpZiAoYXJyYXkpIHsKICAgICAgICAgICAgc3RyID0gc3RyLnNwbGl0KCdcbicpLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICcgICcgKyBsaW5lOwogICAgICAgICAgICB9KS5qb2luKCdcbicpLnN1YnN0cigyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0ciA9ICdcbicgKyBzdHIuc3BsaXQoJ1xuJykubWFwKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gJyAgICcgKyBsaW5lOwogICAgICAgICAgICB9KS5qb2luKCdcbicpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0NpcmN1bGFyXScsICdzcGVjaWFsJyk7CiAgICAgIH0KICAgIH0KICAgIGlmIChpc1VuZGVmaW5lZChuYW1lKSkgewogICAgICBpZiAoYXJyYXkgJiYga2V5Lm1hdGNoKC9eXGQrJC8pKSB7CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfQogICAgICBuYW1lID0gSlNPTi5zdHJpbmdpZnkoJycgKyBrZXkpOwogICAgICBpZiAobmFtZS5tYXRjaCgvXiIoW2EtekEtWl9dW2EtekEtWl8wLTldKikiJC8pKSB7CiAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDEsIG5hbWUubGVuZ3RoIC0gMik7CiAgICAgICAgbmFtZSA9IGN0eC5zdHlsaXplKG5hbWUsICduYW1lJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgvJy9nLCAiXFwnIikKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJyInKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyheInwiJCkvZywgIiciKTsKICAgICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ3N0cmluZycpOwogICAgICB9CiAgICB9CiAgCiAgICByZXR1cm4gbmFtZSArICc6ICcgKyBzdHI7CiAgfQogIAogIAogIGZ1bmN0aW9uIHJlZHVjZVRvU2luZ2xlU3RyaW5nKG91dHB1dCwgYmFzZSwgYnJhY2VzKSB7CiAgICB2YXIgbnVtTGluZXNFc3QgPSAwOwogICAgdmFyIGxlbmd0aCA9IG91dHB1dC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgY3VyKSB7CiAgICAgIG51bUxpbmVzRXN0Kys7CiAgICAgIGlmIChjdXIuaW5kZXhPZignXG4nKSA+PSAwKSBudW1MaW5lc0VzdCsrOwogICAgICByZXR1cm4gcHJldiArIGN1ci5yZXBsYWNlKC9cdTAwMWJcW1xkXGQ/bS9nLCAnJykubGVuZ3RoICsgMTsKICAgIH0sIDApOwogIAogICAgaWYgKGxlbmd0aCA+IDYwKSB7CiAgICAgIHJldHVybiBicmFjZXNbMF0gKwogICAgICAgICAgICAgKGJhc2UgPT09ICcnID8gJycgOiBiYXNlICsgJ1xuICcpICsKICAgICAgICAgICAgICcgJyArCiAgICAgICAgICAgICBvdXRwdXQuam9pbignLFxuICAnKSArCiAgICAgICAgICAgICAnICcgKwogICAgICAgICAgICAgYnJhY2VzWzFdOwogICAgfQogIAogICAgcmV0dXJuIGJyYWNlc1swXSArIGJhc2UgKyAnICcgKyBvdXRwdXQuam9pbignLCAnKSArICcgJyArIGJyYWNlc1sxXTsKICB9CiAgCiAgCiAgLy8gTk9URTogVGhlc2UgdHlwZSBjaGVja2luZyBmdW5jdGlvbnMgaW50ZW50aW9uYWxseSBkb24ndCB1c2UgYGluc3RhbmNlb2ZgCiAgLy8gYmVjYXVzZSBpdCBpcyBmcmFnaWxlIGFuZCBjYW4gYmUgZWFzaWx5IGZha2VkIHdpdGggYE9iamVjdC5jcmVhdGUoKWAuCiAgZnVuY3Rpb24gaXNBcnJheShhcikgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXIpOwogIH0KICBleHBvcnRzLmlzQXJyYXkgPSBpc0FycmF5OwogIAogIGZ1bmN0aW9uIGlzQm9vbGVhbihhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnYm9vbGVhbic7CiAgfQogIGV4cG9ydHMuaXNCb29sZWFuID0gaXNCb29sZWFuOwogIAogIGZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IG51bGw7CiAgfQogIGV4cG9ydHMuaXNOdWxsID0gaXNOdWxsOwogIAogIGZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKGFyZykgewogICAgcmV0dXJuIGFyZyA9PSBudWxsOwogIH0KICBleHBvcnRzLmlzTnVsbE9yVW5kZWZpbmVkID0gaXNOdWxsT3JVbmRlZmluZWQ7CiAgCiAgZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ251bWJlcic7CiAgfQogIGV4cG9ydHMuaXNOdW1iZXIgPSBpc051bWJlcjsKICAKICBmdW5jdGlvbiBpc1N0cmluZyhhcmcpIHsKICAgIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJzsKICB9CiAgZXhwb3J0cy5pc1N0cmluZyA9IGlzU3RyaW5nOwogIAogIGZ1bmN0aW9uIGlzU3ltYm9sKGFyZykgewogICAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnOwogIH0KICBleHBvcnRzLmlzU3ltYm9sID0gaXNTeW1ib2w7CiAgCiAgZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgICByZXR1cm4gYXJnID09PSB2b2lkIDA7CiAgfQogIGV4cG9ydHMuaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKICAKICBmdW5jdGlvbiBpc1JlZ0V4cChyZSkgewogICAgcmV0dXJuIGlzT2JqZWN0KHJlKSAmJiBvYmplY3RUb1N0cmluZyhyZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwogIH0KICBleHBvcnRzLmlzUmVnRXhwID0gaXNSZWdFeHA7CiAgCiAgZnVuY3Rpb24gaXNPYmplY3QoYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwogIH0KICBleHBvcnRzLmlzT2JqZWN0ID0gaXNPYmplY3Q7CiAgCiAgZnVuY3Rpb24gaXNEYXRlKGQpIHsKICAgIHJldHVybiBpc09iamVjdChkKSAmJiBvYmplY3RUb1N0cmluZyhkKSA9PT0gJ1tvYmplY3QgRGF0ZV0nOwogIH0KICBleHBvcnRzLmlzRGF0ZSA9IGlzRGF0ZTsKICAKICBmdW5jdGlvbiBpc0Vycm9yKGUpIHsKICAgIHJldHVybiBpc09iamVjdChlKSAmJgogICAgICAgIChvYmplY3RUb1N0cmluZyhlKSA9PT0gJ1tvYmplY3QgRXJyb3JdJyB8fCBlIGluc3RhbmNlb2YgRXJyb3IpOwogIH0KICBleHBvcnRzLmlzRXJyb3IgPSBpc0Vycm9yOwogIAogIGZ1bmN0aW9uIGlzRnVuY3Rpb24oYXJnKSB7CiAgICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKICB9CiAgZXhwb3J0cy5pc0Z1bmN0aW9uID0gaXNGdW5jdGlvbjsKICAKICBmdW5jdGlvbiBpc1ByaW1pdGl2ZShhcmcpIHsKICAgIHJldHVybiBhcmcgPT09IG51bGwgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnYm9vbGVhbicgfHwKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAnbnVtYmVyJyB8fAogICAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnIHx8CiAgICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCcgfHwgIC8vIEVTNiBzeW1ib2wKICAgICAgICAgICB0eXBlb2YgYXJnID09PSAndW5kZWZpbmVkJzsKICB9CiAgZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwogIAogIGV4cG9ydHMuaXNCdWZmZXIgPSByZXF1aXJlKCcuL3N1cHBvcnQvaXNCdWZmZXInKTsKICAKICBmdW5jdGlvbiBvYmplY3RUb1N0cmluZyhvKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pOwogIH0KICAKICAKICBmdW5jdGlvbiBwYWQobikgewogICAgcmV0dXJuIG4gPCAxMCA/ICcwJyArIG4udG9TdHJpbmcoMTApIDogbi50b1N0cmluZygxMCk7CiAgfQogIAogIAogIHZhciBtb250aHMgPSBbJ0phbicsICdGZWInLCAnTWFyJywgJ0FwcicsICdNYXknLCAnSnVuJywgJ0p1bCcsICdBdWcnLCAnU2VwJywKICAgICAgICAgICAgICAgICdPY3QnLCAnTm92JywgJ0RlYyddOwogIAogIC8vIDI2IEZlYiAxNjoxOTozNAogIGZ1bmN0aW9uIHRpbWVzdGFtcCgpIHsKICAgIHZhciBkID0gbmV3IERhdGUoKTsKICAgIHZhciB0aW1lID0gW3BhZChkLmdldEhvdXJzKCkpLAogICAgICAgICAgICAgICAgcGFkKGQuZ2V0TWludXRlcygpKSwKICAgICAgICAgICAgICAgIHBhZChkLmdldFNlY29uZHMoKSldLmpvaW4oJzonKTsKICAgIHJldHVybiBbZC5nZXREYXRlKCksIG1vbnRoc1tkLmdldE1vbnRoKCldLCB0aW1lXS5qb2luKCcgJyk7CiAgfQogIAogIAogIC8vIGxvZyBpcyBqdXN0IGEgdGhpbiB3cmFwcGVyIHRvIGNvbnNvbGUubG9nIHRoYXQgcHJlcGVuZHMgYSB0aW1lc3RhbXAKICBleHBvcnRzLmxvZyA9IGZ1bmN0aW9uKCkgewogICAgY29uc29sZS5sb2coJyVzIC0gJXMnLCB0aW1lc3RhbXAoKSwgZXhwb3J0cy5mb3JtYXQuYXBwbHkoZXhwb3J0cywgYXJndW1lbnRzKSk7CiAgfTsKICAKICAKICAvKioKICAgKiBJbmhlcml0IHRoZSBwcm90b3R5cGUgbWV0aG9kcyBmcm9tIG9uZSBjb25zdHJ1Y3RvciBpbnRvIGFub3RoZXIuCiAgICoKICAgKiBUaGUgRnVuY3Rpb24ucHJvdG90eXBlLmluaGVyaXRzIGZyb20gbGFuZy5qcyByZXdyaXR0ZW4gYXMgYSBzdGFuZGFsb25lCiAgICogZnVuY3Rpb24gKG5vdCBvbiBGdW5jdGlvbi5wcm90b3R5cGUpLiBOT1RFOiBJZiB0aGlzIGZpbGUgaXMgdG8gYmUgbG9hZGVkCiAgICogZHVyaW5nIGJvb3RzdHJhcHBpbmcgdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZXdyaXR0ZW4gdXNpbmcgc29tZSBuYXRpdmUKICAgKiBmdW5jdGlvbnMgYXMgcHJvdG90eXBlIHNldHVwIHVzaW5nIG5vcm1hbCBKYXZhU2NyaXB0IGRvZXMgbm90IHdvcmsgYXMKICAgKiBleHBlY3RlZCBkdXJpbmcgYm9vdHN0cmFwcGluZyAoc2VlIG1pcnJvci5qcyBpbiByMTE0OTAzKS4KICAgKgogICAqIEBwYXJhbSB7ZnVuY3Rpb259IGN0b3IgQ29uc3RydWN0b3IgZnVuY3Rpb24gd2hpY2ggbmVlZHMgdG8gaW5oZXJpdCB0aGUKICAgKiAgICAgcHJvdG90eXBlLgogICAqIEBwYXJhbSB7ZnVuY3Rpb259IHN1cGVyQ3RvciBDb25zdHJ1Y3RvciBmdW5jdGlvbiB0byBpbmhlcml0IHByb3RvdHlwZSBmcm9tLgogICAqLwogIGV4cG9ydHMuaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwogIAogIGV4cG9ydHMuX2V4dGVuZCA9IGZ1bmN0aW9uKG9yaWdpbiwgYWRkKSB7CiAgICAvLyBEb24ndCBkbyBhbnl0aGluZyBpZiBhZGQgaXNuJ3QgYW4gb2JqZWN0CiAgICBpZiAoIWFkZCB8fCAhaXNPYmplY3QoYWRkKSkgcmV0dXJuIG9yaWdpbjsKICAKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoYWRkKTsKICAgIHZhciBpID0ga2V5cy5sZW5ndGg7CiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIG9yaWdpbltrZXlzW2ldXSA9IGFkZFtrZXlzW2ldXTsKICAgIH0KICAgIHJldHVybiBvcmlnaW47CiAgfTsKICAKICBmdW5jdGlvbiBoYXNPd25Qcm9wZXJ0eShvYmosIHByb3ApIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKICB9CiAgCiAgfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpLHR5cGVvZiBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgIT09ICJ1bmRlZmluZWQiID8gX193ZWJwYWNrX3JlcXVpcmVfXy5nIDogdHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge30pCiAgfSx7Ii4vc3VwcG9ydC9pc0J1ZmZlciI6OTYsIl9wcm9jZXNzIjo4NiwiaW5oZXJpdHMiOjk1fV0sOTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewogIHZhciB2MSA9IHJlcXVpcmUoJy4vdjEnKTsKICB2YXIgdjQgPSByZXF1aXJlKCcuL3Y0Jyk7CiAgCiAgdmFyIHV1aWQgPSB2NDsKICB1dWlkLnYxID0gdjE7CiAgdXVpZC52NCA9IHY0OwogIAogIG1vZHVsZS5leHBvcnRzID0gdXVpZDsKICAKICB9LHsiLi92MSI6MTAxLCIuL3Y0IjoxMDJ9XSw5OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLyoqCiAgICogQ29udmVydCBhcnJheSBvZiAxNiBieXRlIHZhbHVlcyB0byBVVUlEIHN0cmluZyBmb3JtYXQgb2YgdGhlIGZvcm06CiAgICogWFhYWFhYWFgtWFhYWC1YWFhYLVhYWFgtWFhYWFhYWFhYWFhYCiAgICovCiAgdmFyIGJ5dGVUb0hleCA9IFtdOwogIGZvciAodmFyIGkgPSAwOyBpIDwgMjU2OyArK2kpIHsKICAgIGJ5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7CiAgfQogIAogIGZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ1Ziwgb2Zmc2V0KSB7CiAgICB2YXIgaSA9IG9mZnNldCB8fCAwOwogICAgdmFyIGJ0aCA9IGJ5dGVUb0hleDsKICAgIC8vIGpvaW4gdXNlZCB0byBmaXggbWVtb3J5IGlzc3VlIGNhdXNlZCBieSBjb25jYXRlbmF0aW9uOiBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvdjgvaXNzdWVzL2RldGFpbD9pZD0zMTc1I2M0CiAgICByZXR1cm4gKFtidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywKICAgIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sCiAgICBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLAogICAgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXV0pLmpvaW4oJycpOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IGJ5dGVzVG9VdWlkOwogIAogIH0se31dLDEwMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgLy8gVW5pcXVlIElEIGNyZWF0aW9uIHJlcXVpcmVzIGEgaGlnaCBxdWFsaXR5IHJhbmRvbSAjIGdlbmVyYXRvci4gIEluIHRoZQogIC8vIGJyb3dzZXIgdGhpcyBpcyBhIGxpdHRsZSBjb21wbGljYXRlZCBkdWUgdG8gdW5rbm93biBxdWFsaXR5IG9mIE1hdGgucmFuZG9tKCkKICAvLyBhbmQgaW5jb25zaXN0ZW50IHN1cHBvcnQgZm9yIHRoZSBgY3J5cHRvYCBBUEkuICBXZSBkbyB0aGUgYmVzdCB3ZSBjYW4gdmlhCiAgLy8gZmVhdHVyZS1kZXRlY3Rpb24KICAKICAvLyBnZXRSYW5kb21WYWx1ZXMgbmVlZHMgdG8gYmUgaW52b2tlZCBpbiBhIGNvbnRleHQgd2hlcmUgInRoaXMiIGlzIGEgQ3J5cHRvCiAgLy8gaW1wbGVtZW50YXRpb24uIEFsc28sIGZpbmQgdGhlIGNvbXBsZXRlIGltcGxlbWVudGF0aW9uIG9mIGNyeXB0byBvbiBJRTExLgogIHZhciBnZXRSYW5kb21WYWx1ZXMgPSAodHlwZW9mKGNyeXB0bykgIT0gJ3VuZGVmaW5lZCcgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQoY3J5cHRvKSkgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGVvZihtc0NyeXB0bykgIT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHdpbmRvdy5tc0NyeXB0by5nZXRSYW5kb21WYWx1ZXMgPT0gJ2Z1bmN0aW9uJyAmJiBtc0NyeXB0by5nZXRSYW5kb21WYWx1ZXMuYmluZChtc0NyeXB0bykpOwogIAogIGlmIChnZXRSYW5kb21WYWx1ZXMpIHsKICAgIC8vIFdIQVRXRyBjcnlwdG8gUk5HIC0gaHR0cDovL3dpa2kud2hhdHdnLm9yZy93aWtpL0NyeXB0bwogICAgdmFyIHJuZHM4ID0gbmV3IFVpbnQ4QXJyYXkoMTYpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmCiAgCiAgICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIHdoYXR3Z1JORygpIHsKICAgICAgZ2V0UmFuZG9tVmFsdWVzKHJuZHM4KTsKICAgICAgcmV0dXJuIHJuZHM4OwogICAgfTsKICB9IGVsc2UgewogICAgLy8gTWF0aC5yYW5kb20oKS1iYXNlZCAoUk5HKQogICAgLy8KICAgIC8vIElmIGFsbCBlbHNlIGZhaWxzLCB1c2UgTWF0aC5yYW5kb20oKS4gIEl0J3MgZmFzdCwgYnV0IGlzIG9mIHVuc3BlY2lmaWVkCiAgICAvLyBxdWFsaXR5LgogICAgdmFyIHJuZHMgPSBuZXcgQXJyYXkoMTYpOwogIAogICAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBtYXRoUk5HKCkgewogICAgICBmb3IgKHZhciBpID0gMCwgcjsgaSA8IDE2OyBpKyspIHsKICAgICAgICBpZiAoKGkgJiAweDAzKSA9PT0gMCkgciA9IE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMDsKICAgICAgICBybmRzW2ldID0gciA+Pj4gKChpICYgMHgwMykgPDwgMykgJiAweGZmOwogICAgICB9CiAgCiAgICAgIHJldHVybiBybmRzOwogICAgfTsKICB9CiAgCiAgfSx7fV0sMTAxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcm5nID0gcmVxdWlyZSgnLi9saWIvcm5nJyk7CiAgdmFyIGJ5dGVzVG9VdWlkID0gcmVxdWlyZSgnLi9saWIvYnl0ZXNUb1V1aWQnKTsKICAKICAvLyAqKmB2MSgpYCAtIEdlbmVyYXRlIHRpbWUtYmFzZWQgVVVJRCoqCiAgLy8KICAvLyBJbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vTGlvc0svVVVJRC5qcwogIC8vIGFuZCBodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvdXVpZC5odG1sCiAgCiAgdmFyIF9ub2RlSWQ7CiAgdmFyIF9jbG9ja3NlcTsKICAKICAvLyBQcmV2aW91cyB1dWlkIGNyZWF0aW9uIHRpbWUKICB2YXIgX2xhc3RNU2VjcyA9IDA7CiAgdmFyIF9sYXN0TlNlY3MgPSAwOwogIAogIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYnJvb2ZhL25vZGUtdXVpZCBmb3IgQVBJIGRldGFpbHMKICBmdW5jdGlvbiB2MShvcHRpb25zLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgICB2YXIgYiA9IGJ1ZiB8fCBbXTsKICAKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIG5vZGUgPSBvcHRpb25zLm5vZGUgfHwgX25vZGVJZDsKICAgIHZhciBjbG9ja3NlcSA9IG9wdGlvbnMuY2xvY2tzZXEgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY2xvY2tzZXEgOiBfY2xvY2tzZXE7CiAgCiAgICAvLyBub2RlIGFuZCBjbG9ja3NlcSBuZWVkIHRvIGJlIGluaXRpYWxpemVkIHRvIHJhbmRvbSB2YWx1ZXMgaWYgdGhleSdyZSBub3QKICAgIC8vIHNwZWNpZmllZC4gIFdlIGRvIHRoaXMgbGF6aWx5IHRvIG1pbmltaXplIGlzc3VlcyByZWxhdGVkIHRvIGluc3VmZmljaWVudAogICAgLy8gc3lzdGVtIGVudHJvcHkuICBTZWUgIzE4OQogICAgaWYgKG5vZGUgPT0gbnVsbCB8fCBjbG9ja3NlcSA9PSBudWxsKSB7CiAgICAgIHZhciBzZWVkQnl0ZXMgPSBybmcoKTsKICAgICAgaWYgKG5vZGUgPT0gbnVsbCkgewogICAgICAgIC8vIFBlciA0LjUsIGNyZWF0ZSBhbmQgNDgtYml0IG5vZGUgaWQsICg0NyByYW5kb20gYml0cyArIG11bHRpY2FzdCBiaXQgPSAxKQogICAgICAgIG5vZGUgPSBfbm9kZUlkID0gWwogICAgICAgICAgc2VlZEJ5dGVzWzBdIHwgMHgwMSwKICAgICAgICAgIHNlZWRCeXRlc1sxXSwgc2VlZEJ5dGVzWzJdLCBzZWVkQnl0ZXNbM10sIHNlZWRCeXRlc1s0XSwgc2VlZEJ5dGVzWzVdCiAgICAgICAgXTsKICAgICAgfQogICAgICBpZiAoY2xvY2tzZXEgPT0gbnVsbCkgewogICAgICAgIC8vIFBlciA0LjIuMiwgcmFuZG9taXplICgxNCBiaXQpIGNsb2Nrc2VxCiAgICAgICAgY2xvY2tzZXEgPSBfY2xvY2tzZXEgPSAoc2VlZEJ5dGVzWzZdIDw8IDggfCBzZWVkQnl0ZXNbN10pICYgMHgzZmZmOwogICAgICB9CiAgICB9CiAgCiAgICAvLyBVVUlEIHRpbWVzdGFtcHMgYXJlIDEwMCBuYW5vLXNlY29uZCB1bml0cyBzaW5jZSB0aGUgR3JlZ29yaWFuIGVwb2NoLAogICAgLy8gKDE1ODItMTAtMTUgMDA6MDApLiAgSlNOdW1iZXJzIGFyZW4ndCBwcmVjaXNlIGVub3VnaCBmb3IgdGhpcywgc28KICAgIC8vIHRpbWUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5IGFzICdtc2VjcycgKGludGVnZXIgbWlsbGlzZWNvbmRzKSBhbmQgJ25zZWNzJwogICAgLy8gKDEwMC1uYW5vc2Vjb25kcyBvZmZzZXQgZnJvbSBtc2Vjcykgc2luY2UgdW5peCBlcG9jaCwgMTk3MC0wMS0wMSAwMDowMC4KICAgIHZhciBtc2VjcyA9IG9wdGlvbnMubXNlY3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMubXNlY3MgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAKICAgIC8vIFBlciA0LjIuMS4yLCB1c2UgY291bnQgb2YgdXVpZCdzIGdlbmVyYXRlZCBkdXJpbmcgdGhlIGN1cnJlbnQgY2xvY2sKICAgIC8vIGN5Y2xlIHRvIHNpbXVsYXRlIGhpZ2hlciByZXNvbHV0aW9uIGNsb2NrCiAgICB2YXIgbnNlY3MgPSBvcHRpb25zLm5zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm5zZWNzIDogX2xhc3ROU2VjcyArIDE7CiAgCiAgICAvLyBUaW1lIHNpbmNlIGxhc3QgdXVpZCBjcmVhdGlvbiAoaW4gbXNlY3MpCiAgICB2YXIgZHQgPSAobXNlY3MgLSBfbGFzdE1TZWNzKSArIChuc2VjcyAtIF9sYXN0TlNlY3MpLzEwMDAwOwogIAogICAgLy8gUGVyIDQuMi4xLjIsIEJ1bXAgY2xvY2tzZXEgb24gY2xvY2sgcmVncmVzc2lvbgogICAgaWYgKGR0IDwgMCAmJiBvcHRpb25zLmNsb2Nrc2VxID09PSB1bmRlZmluZWQpIHsKICAgICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CiAgICB9CiAgCiAgICAvLyBSZXNldCBuc2VjcyBpZiBjbG9jayByZWdyZXNzZXMgKG5ldyBjbG9ja3NlcSkgb3Igd2UndmUgbW92ZWQgb250byBhIG5ldwogICAgLy8gdGltZSBpbnRlcnZhbAogICAgaWYgKChkdCA8IDAgfHwgbXNlY3MgPiBfbGFzdE1TZWNzKSAmJiBvcHRpb25zLm5zZWNzID09PSB1bmRlZmluZWQpIHsKICAgICAgbnNlY3MgPSAwOwogICAgfQogIAogICAgLy8gUGVyIDQuMi4xLjIgVGhyb3cgZXJyb3IgaWYgdG9vIG1hbnkgdXVpZHMgYXJlIHJlcXVlc3RlZAogICAgaWYgKG5zZWNzID49IDEwMDAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndXVpZC52MSgpOiBDYW5cJ3QgY3JlYXRlIG1vcmUgdGhhbiAxME0gdXVpZHMvc2VjJyk7CiAgICB9CiAgCiAgICBfbGFzdE1TZWNzID0gbXNlY3M7CiAgICBfbGFzdE5TZWNzID0gbnNlY3M7CiAgICBfY2xvY2tzZXEgPSBjbG9ja3NlcTsKICAKICAgIC8vIFBlciA0LjEuNCAtIENvbnZlcnQgZnJvbSB1bml4IGVwb2NoIHRvIEdyZWdvcmlhbiBlcG9jaAogICAgbXNlY3MgKz0gMTIyMTkyOTI4MDAwMDA7CiAgCiAgICAvLyBgdGltZV9sb3dgCiAgICB2YXIgdGwgPSAoKG1zZWNzICYgMHhmZmZmZmZmKSAqIDEwMDAwICsgbnNlY3MpICUgMHgxMDAwMDAwMDA7CiAgICBiW2krK10gPSB0bCA+Pj4gMjQgJiAweGZmOwogICAgYltpKytdID0gdGwgPj4+IDE2ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsID4+PiA4ICYgMHhmZjsKICAgIGJbaSsrXSA9IHRsICYgMHhmZjsKICAKICAgIC8vIGB0aW1lX21pZGAKICAgIHZhciB0bWggPSAobXNlY3MgLyAweDEwMDAwMDAwMCAqIDEwMDAwKSAmIDB4ZmZmZmZmZjsKICAgIGJbaSsrXSA9IHRtaCA+Pj4gOCAmIDB4ZmY7CiAgICBiW2krK10gPSB0bWggJiAweGZmOwogIAogICAgLy8gYHRpbWVfaGlnaF9hbmRfdmVyc2lvbmAKICAgIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOyAvLyBpbmNsdWRlIHZlcnNpb24KICAgIGJbaSsrXSA9IHRtaCA+Pj4gMTYgJiAweGZmOwogIAogICAgLy8gYGNsb2NrX3NlcV9oaV9hbmRfcmVzZXJ2ZWRgIChQZXIgNC4yLjIgLSBpbmNsdWRlIHZhcmlhbnQpCiAgICBiW2krK10gPSBjbG9ja3NlcSA+Pj4gOCB8IDB4ODA7CiAgCiAgICAvLyBgY2xvY2tfc2VxX2xvd2AKICAgIGJbaSsrXSA9IGNsb2Nrc2VxICYgMHhmZjsKICAKICAgIC8vIGBub2RlYAogICAgZm9yICh2YXIgbiA9IDA7IG4gPCA2OyArK24pIHsKICAgICAgYltpICsgbl0gPSBub2RlW25dOwogICAgfQogIAogICAgcmV0dXJuIGJ1ZiA/IGJ1ZiA6IGJ5dGVzVG9VdWlkKGIpOwogIH0KICAKICBtb2R1bGUuZXhwb3J0cyA9IHYxOwogIAogIH0seyIuL2xpYi9ieXRlc1RvVXVpZCI6OTksIi4vbGliL3JuZyI6MTAwfV0sMTAyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICB2YXIgcm5nID0gcmVxdWlyZSgnLi9saWIvcm5nJyk7CiAgdmFyIGJ5dGVzVG9VdWlkID0gcmVxdWlyZSgnLi9saWIvYnl0ZXNUb1V1aWQnKTsKICAKICBmdW5jdGlvbiB2NChvcHRpb25zLCBidWYsIG9mZnNldCkgewogICAgdmFyIGkgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgCiAgICBpZiAodHlwZW9mKG9wdGlvbnMpID09ICdzdHJpbmcnKSB7CiAgICAgIGJ1ZiA9IG9wdGlvbnMgPT09ICdiaW5hcnknID8gbmV3IEFycmF5KDE2KSA6IG51bGw7CiAgICAgIG9wdGlvbnMgPSBudWxsOwogICAgfQogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgCiAgICB2YXIgcm5kcyA9IG9wdGlvbnMucmFuZG9tIHx8IChvcHRpb25zLnJuZyB8fCBybmcpKCk7CiAgCiAgICAvLyBQZXIgNC40LCBzZXQgYml0cyBmb3IgdmVyc2lvbiBhbmQgYGNsb2NrX3NlcV9oaV9hbmRfcmVzZXJ2ZWRgCiAgICBybmRzWzZdID0gKHJuZHNbNl0gJiAweDBmKSB8IDB4NDA7CiAgICBybmRzWzhdID0gKHJuZHNbOF0gJiAweDNmKSB8IDB4ODA7CiAgCiAgICAvLyBDb3B5IGJ5dGVzIHRvIGJ1ZmZlciwgaWYgcHJvdmlkZWQKICAgIGlmIChidWYpIHsKICAgICAgZm9yICh2YXIgaWkgPSAwOyBpaSA8IDE2OyArK2lpKSB7CiAgICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgICAgfQogICAgfQogIAogICAgcmV0dXJuIGJ1ZiB8fCBieXRlc1RvVXVpZChybmRzKTsKICB9CiAgCiAgbW9kdWxlLmV4cG9ydHMgPSB2NDsKICAKICB9LHsiLi9saWIvYnl0ZXNUb1V1aWQiOjk5LCIuL2xpYi9ybmciOjEwMH1dLDEwMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgInVzZSBzdHJpY3QiOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CiAgdmFyIExSVV8xID0gcmVxdWlyZSgiLi91dGlscy9MUlUiKTsKICB2YXIgQ0FDSEVfU0laRSA9IDEwMDA7CiAgLyoqCiAgICogSW5zcGlyZWQgbm9kZS1scnUtY2FjaGVbaHR0cHM6Ly9naXRodWIuY29tL2lzYWFjcy9ub2RlLWxydS1jYWNoZV0KICAgKi8KICB2YXIgRW5kcG9pbnRDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgICAgZnVuY3Rpb24gRW5kcG9pbnRDYWNoZShtYXhTaXplKSB7CiAgICAgICAgICBpZiAobWF4U2l6ZSA9PT0gdm9pZCAwKSB7IG1heFNpemUgPSBDQUNIRV9TSVpFOyB9CiAgICAgICAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplOwogICAgICAgICAgdGhpcy5jYWNoZSA9IG5ldyBMUlVfMS5MUlVDYWNoZShtYXhTaXplKTsKICAgICAgfQogICAgICA7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShFbmRwb2ludENhY2hlLnByb3RvdHlwZSwgInNpemUiLCB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jYWNoZS5sZW5ndGg7CiAgICAgICAgICB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KTsKICAgICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIga2V5U3RyaW5nID0gdHlwZW9mIGtleSAhPT0gJ3N0cmluZycgPyBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhrZXkpIDoga2V5OwogICAgICAgICAgdmFyIGVuZHBvaW50UmVjb3JkID0gdGhpcy5wb3B1bGF0ZVZhbHVlKHZhbHVlKTsKICAgICAgICAgIHRoaXMuY2FjaGUucHV0KGtleVN0cmluZywgZW5kcG9pbnRSZWNvcmQpOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpOwogICAgICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLmNhY2hlLmdldChrZXlTdHJpbmcpOwogICAgICAgICAgaWYgKHJlY29yZHMpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY29yZHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIHJlY29yZCA9IHJlY29yZHNbaV07CiAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuRXhwaXJlIDwgbm93KSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnJlbW92ZShrZXlTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWNvcmRzOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHZhciBpZGVudGlmaWVycyA9IFtdOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJOYW1lcyA9IE9iamVjdC5rZXlzKGtleSkuc29ydCgpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpZGVudGlmaWVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaWRlbnRpZmllck5hbWUgPSBpZGVudGlmaWVyTmFtZXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleVtpZGVudGlmaWVyTmFtZV0gPT09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgaWRlbnRpZmllcnMucHVzaChrZXlbaWRlbnRpZmllck5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpZGVudGlmaWVycy5qb2luKCcgJyk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLnBvcHVsYXRlVmFsdWUgPSBmdW5jdGlvbiAoZW5kcG9pbnRzKSB7CiAgICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgIHJldHVybiBlbmRwb2ludHMubWFwKGZ1bmN0aW9uIChlbmRwb2ludCkgeyByZXR1cm4gKHsKICAgICAgICAgICAgICBBZGRyZXNzOiBlbmRwb2ludC5BZGRyZXNzIHx8ICcnLAogICAgICAgICAgICAgIEV4cGlyZTogbm93ICsgKGVuZHBvaW50LkNhY2hlUGVyaW9kSW5NaW51dGVzIHx8IDEpICogNjAgKiAxMDAwCiAgICAgICAgICB9KTsgfSk7CiAgICAgIH07CiAgICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgdGhpcy5jYWNoZS5lbXB0eSgpOwogICAgICB9OwogICAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICAgIHRoaXMuY2FjaGUucmVtb3ZlKGtleVN0cmluZyk7CiAgICAgIH07CiAgICAgIHJldHVybiBFbmRwb2ludENhY2hlOwogIH0oKSk7CiAgZXhwb3J0cy5FbmRwb2ludENhY2hlID0gRW5kcG9pbnRDYWNoZTsKICB9LHsiLi91dGlscy9MUlUiOjEwNH1dLDEwNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiAgInVzZSBzdHJpY3QiOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CiAgdmFyIExpbmtlZExpc3ROb2RlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkgewogICAgICBmdW5jdGlvbiBMaW5rZWRMaXN0Tm9kZShrZXksIHZhbHVlKSB7CiAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gTGlua2VkTGlzdE5vZGU7CiAgfSgpKTsKICB2YXIgTFJVQ2FjaGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICAgIGZ1bmN0aW9uIExSVUNhY2hlKHNpemUpIHsKICAgICAgICAgIHRoaXMubm9kZU1hcCA9IHt9OwogICAgICAgICAgdGhpcy5zaXplID0gMDsKICAgICAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicgfHwgc2l6ZSA8IDEpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhY2hlIHNpemUgY2FuIG9ubHkgYmUgcG9zaXRpdmUgbnVtYmVyJyk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNpemVMaW1pdCA9IHNpemU7CiAgICAgIH0KICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KExSVUNhY2hlLnByb3RvdHlwZSwgImxlbmd0aCIsIHsKICAgICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNpemU7CiAgICAgICAgICB9LAogICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLnByZXBlbmRUb0xpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgaWYgKCF0aGlzLmhlYWRlck5vZGUpIHsKICAgICAgICAgICAgICB0aGlzLnRhaWxOb2RlID0gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHRoaXMuaGVhZGVyTm9kZS5wcmV2ID0gbm9kZTsKICAgICAgICAgICAgICBub2RlLm5leHQgPSB0aGlzLmhlYWRlck5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmhlYWRlck5vZGUgPSBub2RlOwogICAgICAgICAgdGhpcy5zaXplKys7CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5yZW1vdmVGcm9tVGFpbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmICghdGhpcy50YWlsTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMudGFpbE5vZGU7CiAgICAgICAgICB2YXIgcHJldk5vZGUgPSBub2RlLnByZXY7CiAgICAgICAgICBpZiAocHJldk5vZGUpIHsKICAgICAgICAgICAgICBwcmV2Tm9kZS5uZXh0ID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgICAgbm9kZS5wcmV2ID0gdW5kZWZpbmVkOwogICAgICAgICAgdGhpcy50YWlsTm9kZSA9IHByZXZOb2RlOwogICAgICAgICAgdGhpcy5zaXplLS07CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLmRldGFjaEZyb21MaXN0ID0gZnVuY3Rpb24gKG5vZGUpIHsKICAgICAgICAgIGlmICh0aGlzLmhlYWRlck5vZGUgPT09IG5vZGUpIHsKICAgICAgICAgICAgICB0aGlzLmhlYWRlck5vZGUgPSBub2RlLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy50YWlsTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlLnByZXY7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS5wcmV2KSB7CiAgICAgICAgICAgICAgbm9kZS5wcmV2Lm5leHQgPSBub2RlLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS5uZXh0KSB7CiAgICAgICAgICAgICAgbm9kZS5uZXh0LnByZXYgPSBub2RlLnByZXY7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLm5leHQgPSB1bmRlZmluZWQ7CiAgICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgICB0aGlzLnNpemUtLTsKICAgICAgfTsKICAgICAgTFJVQ2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVNYXBba2V5XSkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgICB0aGlzLnByZXBlbmRUb0xpc3Qobm9kZSk7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUudmFsdWU7CiAgICAgICAgICB9CiAgICAgIH07CiAgICAgIExSVUNhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgfQogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgIGlmICh0aGlzLm5vZGVNYXBba2V5XSkgewogICAgICAgICAgICAgIHRoaXMucmVtb3ZlKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICh0aGlzLnNpemUgPT09IHRoaXMuc2l6ZUxpbWl0KSB7CiAgICAgICAgICAgICAgdmFyIHRhaWxOb2RlID0gdGhpcy5yZW1vdmVGcm9tVGFpbCgpOwogICAgICAgICAgICAgIHZhciBrZXlfMSA9IHRhaWxOb2RlLmtleTsKICAgICAgICAgICAgICBkZWxldGUgdGhpcy5ub2RlTWFwW2tleV8xXTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdOb2RlID0gbmV3IExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpOwogICAgICAgICAgdGhpcy5ub2RlTWFwW2tleV0gPSBuZXdOb2RlOwogICAgICAgICAgdGhpcy5wcmVwZW5kVG9MaXN0KG5ld05vZGUpOwogICAgICB9OwogICAgICBMUlVDYWNoZS5wcm90b3R5cGUuZW1wdHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMubm9kZU1hcCk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgICAgfQogICAgICB9OwogICAgICByZXR1cm4gTFJVQ2FjaGU7CiAgfSgpKTsKICBleHBvcnRzLkxSVUNhY2hlID0gTFJVQ2FjaGU7CiAgfSx7fV0sMTA1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKICAvLyBBV1MgU0RLIGZvciBKYXZhU2NyaXB0IHYyLjU1My4wCiAgLy8gQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAgLy8gTGljZW5zZSBhdCBodHRwczovL3Nkay5hbWF6b25hd3MuY29tL2pzL0JVTkRMRV9MSUNFTlNFLnR4dAogIHJlcXVpcmUoJy4vYnJvd3Nlcl9sb2FkZXInKTsKICAKICB2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgCiAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB3aW5kb3cuQVdTID0gQVdTOwogIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgewogICAgICAvKioKICAgICAgICogQGFwaSBwcml2YXRlCiAgICAgICAqLwogICAgICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKICB9CiAgaWYgKHR5cGVvZiBzZWxmICE9PSAndW5kZWZpbmVkJykgc2VsZi5BV1MgPSBBV1M7CiAgCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBETyBOT1QgUkVNT1ZFCiAgICogYnJvd3NlciBidWlsZGVyIHdpbGwgc3RyaXAgb3V0IHRoaXMgbGluZSBpZiBzZXJ2aWNlcyBhcmUgc3VwcGxpZWQgb24gdGhlIGNvbW1hbmQgbGluZS4KICAgKi9pZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChBV1MsICdDb25uZWN0JykpIHsKICAgIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXSA9IHt9OwogICAgQVdTLkNvbm5lY3QgPSBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlKCdjb25uZWN0JywgWyAnMjAxNy0wMi0xNScgXSk7CiAgfQogIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXVsnMjAxNy0wMi0xNSddID0gcmVxdWlyZSgnLi4vYXBpcy9jb25uZWN0LTIwMTctMDItMTUubWluJyk7CiAgCiAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoQVdTLCAnU1RTJykpIHsKICAgIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddID0ge307CiAgICBBV1MuU1RTID0gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZSgnc3RzJywgWyAnMjAxMS0wNi0xNScgXSk7CiAgICByZXF1aXJlKCcuL3NlcnZpY2VzL3N0cycpOwogIH0KICBBV1MuYXBpTG9hZGVyLnNlcnZpY2VzWydzdHMnXVsnMjAxMS0wNi0xNSddID0gcmVxdWlyZSgnLi4vYXBpcy9zdHMtMjAxMS0wNi0xNS5taW4nKTsKICAKICAKICB9LHsiLi4vYXBpcy9jb25uZWN0LTIwMTctMDItMTUubWluIjozLCIuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbiI6NSwiLi9icm93c2VyX2xvYWRlciI6MTYsIi4vY29yZSI6MTgsIi4vc2VydmljZXMvc3RzIjo2MX1dfSx7fSxbMTA1XSk7CgovKioqLyB9KSwKCi8qKiovIDc1NDoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LkNsaWVudE1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2dldEFnZW50U25hcHNob3QnLAogICAgICAgICAncHV0QWdlbnRTdGF0ZScsCiAgICAgICAgICdnZXRBZ2VudFN0YXRlcycsCiAgICAgICAgICdnZXREaWFsYWJsZUNvdW50cnlDb2RlcycsCiAgICAgICAgICdnZXRSb3V0aW5nUHJvZmlsZVF1ZXVlcycsCiAgICAgICAgICdnZXRBZ2VudFBlcm1pc3Npb25zJywKICAgICAgICAgJ2dldEFnZW50Q29uZmlndXJhdGlvbicsCiAgICAgICAgICd1cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24nLAogICAgICAgICAnYWNjZXB0Q29udGFjdCcsCiAgICAgICAgICdjcmVhdGVPdXRib3VuZENvbnRhY3QnLAogICAgICAgICAnY3JlYXRlVGFza0NvbnRhY3QnLAogICAgICAgICAnY2xlYXJDb250YWN0JywKICAgICAgICAgJ2NvbXBsZXRlQ29udGFjdCcsCiAgICAgICAgICdkZXN0cm95Q29udGFjdCcsCiAgICAgICAgICdyZWplY3RDb250YWN0JywKICAgICAgICAgJ25vdGlmeUNvbnRhY3RJc3N1ZScsCiAgICAgICAgICd1cGRhdGVDb250YWN0QXR0cmlidXRlcycsCiAgICAgICAgICdjcmVhdGVBZGRpdGlvbmFsQ29ubmVjdGlvbicsCiAgICAgICAgICdkZXN0cm95Q29ubmVjdGlvbicsCiAgICAgICAgICdob2xkQ29ubmVjdGlvbicsCiAgICAgICAgICdyZXN1bWVDb25uZWN0aW9uJywKICAgICAgICAgJ3RvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zJywKICAgICAgICAgJ2NvbmZlcmVuY2VDb25uZWN0aW9ucycsCiAgICAgICAgICdzZW5kQ2xpZW50TG9ncycsCiAgICAgICAgICdzZW5kRGlnaXRzJywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsUmVwb3J0JywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcycsCiAgICAgICAgICdnZXRFbmRwb2ludHMnLAogICAgICAgICAnZ2V0TmV3QXV0aFRva2VuJywKICAgICAgICAgJ2NyZWF0ZVRyYW5zcG9ydCcsCiAgICAgICAgICdtdXRlUGFydGljaXBhbnQnLAogICAgICAgICAndW5tdXRlUGFydGljaXBhbnQnLAogICAgICAgICAndXBkYXRlTW9uaXRvclBhcnRpY2lwYW50U3RhdGUnCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQWdlbnRBcHBDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcyA9IHsKICAgICAgR0VUX0NPTlRBQ1Q6ICJBZ2VudEFwcFNlcnZpY2UuTGNtcy5nZXRDb250YWN0IiwKICAgICAgREVMRVRFX1NQRUFLRVI6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5kZWxldGVTcGVha2VyIiwKICAgICAgRU5ST0xMX0JZX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5lbnJvbGxCeVNlc3Npb24iLAogICAgICBFVkFMVUFURV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZXZhbHVhdGVTZXNzaW9uIiwKICAgICAgREVTQ1JJQkVfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU3BlYWtlciIsCiAgICAgIE9QVF9PVVRfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLm9wdE91dFNwZWFrZXIiLAogICAgICBVUERBVEVfVk9JQ0VfSURfREFUQTogIkFnZW50QXBwU2VydmljZS5MY21zLnVwZGF0ZVZvaWNlSWREYXRhIiwKICAgICAgREVTQ1JJQkVfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU2Vzc2lvbiIsCiAgICAgIFVQREFURV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQudXBkYXRlU2Vzc2lvbiIsCiAgICAgIFNUQVJUX1ZPSUNFX0lEX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuTmFzYS5zdGFydFZvaWNlSWRTZXNzaW9uIiwKICAgICAgTElTVF9JTlRFR1JBVElPTl9BU1NPQ0lBVElPTlM6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLmxpc3RJbnRlZ3JhdGlvbkFzc29jaWF0aW9ucyIsCiAgICAgIFNUQVJUX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5TdGFydENvbnRhY3RSZWNvcmRpbmciLAogICAgICBTVE9QX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5TdG9wQ29udGFjdFJlY29yZGluZyIsCiAgICAgIFNVU1BFTkRfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlN1c3BlbmRDb250YWN0UmVjb3JkaW5nIiwKICAgICAgUkVTVU1FX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5SZXN1bWVDb250YWN0UmVjb3JkaW5nIgogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gTWFzdGVyTWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5NYXN0ZXJNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICAgICdiZWNvbWVNYXN0ZXInLAogICAgICAgICAnY2hlY2tNYXN0ZXInCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgJ2xpc3RUYXNrVGVtcGxhdGVzJywKICAgICAgJ2dldFRhc2tUZW1wbGF0ZScsCiAgICAgICdjcmVhdGVUZW1wbGF0ZWRUYXNrJywKICAgICAgJ3VwZGF0ZUNvbnRhY3QnCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBDbGllbnRCYXNlID0gZnVuY3Rpb24oKSB7fTsKICAgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1MgPSB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgeyB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHsgfQogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuY2FsbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zSW4sIGNhbGxiYWNrc0luKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1M7CiAgICAgIHRoaXMuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpOwogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgTnVsbENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBOdWxsQ2xpZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgfTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsQ2xpZW50OwoKICAgTnVsbENsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIHZhciBtZXNzYWdlID0gY29ubmVjdC5zcHJpbnRmKCdObyBzdWNoIG1ldGhvZCBleGlzdHMgb24gTlVMTCBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKICAgICAgfQogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSA9IGZ1bmN0aW9uKGNvbmR1aXQsIHJlcXVlc3RFdmVudCwgcmVzcG9uc2VFdmVudCkgewogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICAgIHRoaXMucmVxdWVzdEV2ZW50ID0gcmVxdWVzdEV2ZW50OwogICAgICB0aGlzLnJlc3BvbnNlRXZlbnQgPSByZXNwb25zZUV2ZW50OwogICAgICB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXAgPSB7fTsKCiAgICAgIHRoaXMuY29uZHVpdC5vblVwc3RyZWFtKHJlc3BvbnNlRXZlbnQsIGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5faGFuZGxlUmVzcG9uc2UpKTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHJlcXVlc3QgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXF1ZXN0KHRoaXMucmVxdWVzdEV2ZW50LCBtZXRob2QsIHBhcmFtcyk7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0LnJlcXVlc3RJZF0gPSBjYWxsYmFja3M7CiAgICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0ocmVxdWVzdC5ldmVudCwgcmVxdWVzdCk7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5fZ2V0Q2FsbGJhY2tzRm9yUmVxdWVzdCA9IGZ1bmN0aW9uKHJlcXVlc3RJZCkgewogICAgICB2YXIgY2FsbGJhY2tzID0gdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF0gfHwgbnVsbDsKCiAgICAgIGlmIChjYWxsYmFja3MgIT0gbnVsbCkgewogICAgICAgICBkZWxldGUgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF07CiAgICAgIH0KCiAgICAgIHJldHVybiBjYWxsYmFja3M7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5faGFuZGxlUmVzcG9uc2UgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0KGRhdGEucmVxdWVzdElkKTsKICAgICAgaWYgKGNhbGxiYWNrcyA9PSBudWxsKSB7CiAgICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGRhdGEuZXJyICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGRhdGEuZXJyLCBkYXRhLmRhdGEpOwoKICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhLmRhdGEpOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdENsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQ7CiAgIAogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudEFwcENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgKi8KICAgdmFyIEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24oYXV0aENvb2tpZU5hbWUsIGF1dGhUb2tlbiwgZW5kcG9pbnQpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGF1dGhDb29raWVOYW1lLCAnYXV0aENvb2tpZU5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGF1dGhUb2tlbiwgJ2F1dGhUb2tlbicpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZW5kcG9pbnQsICdlbmRwb2ludCcpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbChlbmRwb2ludCk7CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB0aGlzLmF1dGhDb29raWVOYW1lID0gYXV0aENvb2tpZU5hbWUKICAgfTsKCiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBBZ2VudEFwcENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBZ2VudEFwcENsaWVudDsKCiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGJlYXIgPSB7fTsKICAgICAgYmVhcltzZWxmLmF1dGhDb29raWVOYW1lXSA9IHNlbGYuYXV0aFRva2VuOwogICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgbWV0aG9kOiAncG9zdCcsCiAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHBhcmFtcyB8fCB7fSksCiAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgJ1gtQW16LXRhcmdldCc6IG1ldGhvZCwKICAgICAgICAgICAgICAgJ1gtQW16LUJlYXJlcic6IEpTT04uc3RyaW5naWZ5KGJlYXIpCiAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29ubmVjdC5mZXRjaChzZWxmLmVuZHBvaW50VXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHJlcyk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgIGNvbnN0IHJlYWRlciA9IGVyci5ib2R5LmdldFJlYWRlcigpOwogICAgICAgICBsZXQgYm9keSA9ICcnOwogICAgICAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7CiAgICAgICAgIHJlYWRlci5yZWFkKCkudGhlbihmdW5jdGlvbiBwcm9jZXNzVGV4dCh7IGRvbmUsIHZhbHVlIH0pIHsKICAgICAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgICAgICAgdmFyIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTsKICAgICAgICAgICAgICAgZXJyb3Iuc3RhdHVzID0gZXJyLnN0YXR1czsKICAgICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYm9keSArPSBkZWNvZGVyLmRlY29kZSh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiByZWFkZXIucmVhZCgpLnRoZW4ocHJvY2Vzc1RleHQpOwogICAgICAgICB9KTsKICAgICAgfSkKICAgfTsKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIEFXU0NsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBBV1NDbGllbnQgPSBmdW5jdGlvbihhdXRoVG9rZW4sIHJlZ2lvbiwgZW5kcG9pbnRJbikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWdpb24sICdyZWdpb24nKTsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyh7fSk7CiAgICAgIEFXUy5jb25maWcucmVnaW9uID0gcmVnaW9uOwogICAgICB0aGlzLmF1dGhUb2tlbiA9IGF1dGhUb2tlbjsKICAgICAgdmFyIGJhc2VVcmwgPSBjb25uZWN0LmdldEJhc2VVcmwoKTsKICAgICAgdmFyIGVuZHBvaW50VXJsID0gZW5kcG9pbnRJbiB8fCAoIAogICAgICAgICBiYXNlVXJsLmluY2x1ZGVzKCIuYXdzYXBwcy5jb20iKQogICAgICAgICAgICA/IGJhc2VVcmwgKyAnL2Nvbm5lY3QvYXBpJwogICAgICAgICAgICA6IGJhc2VVcmwgKyAnL2FwaScKICAgICAgKTsKICAgICAgdmFyIGVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludFVybCk7CiAgICAgIHRoaXMuY2xpZW50ID0gbmV3IEFXUy5Db25uZWN0KHtlbmRwb2ludDogZW5kcG9pbnR9KTsKICAgfTsKICAgQVdTQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBBV1NDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQVdTQ2xpZW50OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CgogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwoKICAgICAgaWYgKCEgY29ubmVjdC5jb250YWlucyh0aGlzLmNsaWVudCwgbWV0aG9kKSkgewogICAgICAgICB2YXIgbWVzc2FnZSA9IGNvbm5lY3Quc3ByaW50ZignTm8gc3VjaCBtZXRob2QgZXhpc3RzIG9uIEFXUyBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgIHBhcmFtcyA9IHRoaXMuX3RyYW5zbGF0ZVBhcmFtcyhtZXRob2QsIHBhcmFtcyk7CgogICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogLS0+IENhbGxpbmcgb3BlcmF0aW9uICclcyciLCBtZXRob2QpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAgICB0aGlzLmNsaWVudFttZXRob2RdKHBhcmFtcykKICAgICAgICAgICAgLm9uKCdidWlsZCcsIGZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgICAgICAgICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1CZWFyZXInXSA9IHNlbGYuYXV0aFRva2VuOwogICAgICAgICAgICB9KQogICAgICAgICAgICAuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09IGNvbm5lY3QuQ1RJRXhjZXB0aW9ucy5VTkFVVEhPUklaRURfRVhDRVBUSU9OKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5hdXRoRmFpbHVyZSgpOwogICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQgJiYgKGVyci5jb2RlID09PSBjb25uZWN0LkNUSUV4Y2VwdGlvbnMuQUNDRVNTX0RFTklFRF9FWENFUFRJT04gfHwgZXJyLnN0YXR1c0NvZGUgPT09IDQwMykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCgpOwogICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW4ndCBwYXNzIGVyciBkaXJlY3RseSB0byBwb3N0TWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBwb3N0TWVzc2FnZSgpIHRyaWVzIHRvIGNsb25lIHRoZSBlcnIgb2JqZWN0IGFuZCBmYWlsZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZmVyIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS9nb2F0c2xhY2tlci9hbHQtZGV2dG9vbC9pc3N1ZXMvNQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IudHlwZSA9IGVyci5jb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5tZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIuc3RhY2spewogICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXJyLnN0YWNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gZXJyLnN0YWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyLnN0YWNrID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gW0pTT04uc3RyaW5naWZ5KGVyci5zdGFjayldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyLnN0YWNrID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gZXJyLnN0YWNrLnNwbGl0KCdcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHt9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IDwtLSBPcGVyYXRpb24gJyVzJyBmYWlsZWQ6ICVzIiwgbWV0aG9kLCBKU09OLnN0cmluZ2lmeShlcnIpKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IDwtLSBPcGVyYXRpb24gJyVzJyBzdWNjZWVkZWQuIiwgbWV0aG9kKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGhhbmRsZSBBV1MgQVBJIHJlcXVlc3QgZm9yIG1ldGhvZCAlcyIsIG1ldGhvZCkKICAgICAgICAgICAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgfQogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fcmVxdWlyZXNBdXRoZW50aWNhdGlvblBhcmFtID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICByZXR1cm4gbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09NUExFVEVfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DTEVBUl9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLlJFSkVDVF9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UQVNLX0NPTlRBQ1Q7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVQYXJhbXMgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcykgewogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfQUdFTlRfQ09ORklHVVJBVElPTjoKICAgICAgICAgICAgcGFyYW1zLmNvbmZpZ3VyYXRpb24gPSB0aGlzLl90cmFuc2xhdGVBZ2VudENvbmZpZ3VyYXRpb24ocGFyYW1zLmNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfTUVUUklDUzoKICAgICAgICAgICAgcGFyYW1zLnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKAogICAgICAgICAgICAgICAgICBwYXJhbXMuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9SRVBPUlQ6CiAgICAgICAgICAgIHBhcmFtcy5yZXBvcnQgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVDYWxsUmVwb3J0KHBhcmFtcy5yZXBvcnQpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBpZiAodGhpcy5fcmVxdWlyZXNBdXRoZW50aWNhdGlvblBhcmFtKG1ldGhvZCkpIHsKICAgICAgICAgcGFyYW1zLmF1dGhlbnRpY2F0aW9uID0gewogICAgICAgICAgICBhdXRoVG9rZW46IHRoaXMuYXV0aFRva2VuCiAgICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXJhbXM7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgbmFtZTogY29uZmlnLm5hbWUsCiAgICAgICAgIHNvZnRwaG9uZUVuYWJsZWQ6IGNvbmZpZy5zb2Z0cGhvbmVFbmFibGVkLAogICAgICAgICBzb2Z0cGhvbmVBdXRvQWNjZXB0OiBjb25maWcuc29mdHBob25lQXV0b0FjY2VwdCwKICAgICAgICAgZXh0ZW5zaW9uOiBjb25maWcuZXh0ZW5zaW9uLAogICAgICAgICByb3V0aW5nUHJvZmlsZTogdGhpcy5fdHJhbnNsYXRlUm91dGluZ1Byb2ZpbGUoY29uZmlnLnJvdXRpbmdQcm9maWxlKSwKICAgICAgICAgYWdlbnRQcmVmZXJlbmNlczogY29uZmlnLmFnZW50UHJlZmVyZW5jZXMKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVJvdXRpbmdQcm9maWxlID0gZnVuY3Rpb24ocHJvZmlsZSkgewogICAgICByZXR1cm4gewogICAgICAgICBuYW1lOiBwcm9maWxlLm5hbWUsCiAgICAgICAgIHJvdXRpbmdQcm9maWxlQVJOOiBwcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOLAogICAgICAgICBkZWZhdWx0T3V0Ym91bmRRdWV1ZTogdGhpcy5fdHJhbnNsYXRlUXVldWUocHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZSkKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVF1ZXVlID0gZnVuY3Rpb24ocXVldWUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgcXVldWVBUk46ICAgcXVldWUucXVldWVBUk4sCiAgICAgICAgIG5hbWU6ICAgICAgIHF1ZXVlLm5hbWUKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSBmdW5jdGlvbihzdGF0cykgewogICAgICBzdGF0cy5mb3JFYWNoKGZ1bmN0aW9uKHN0YXQpIHsKICAgICAgICAgaWYgKCdwYWNrZXRzQ291bnQnIGluIHN0YXQpIHsKICAgICAgICAgICAgc3RhdC5wYWNrZXRDb3VudCA9IHN0YXQucGFja2V0c0NvdW50OwogICAgICAgICAgICBkZWxldGUgc3RhdC5wYWNrZXRzQ291bnQ7CiAgICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gc3RhdHM7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVTb2Z0cGhvbmVDYWxsUmVwb3J0ID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICAgIGlmICgnaGFuZHNoYWtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LmhhbmRzaGFrZVRpbWVNaWxsaXMgPSByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgaWYgKCdwcmVUYWxraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5wcmVUYWxrVGltZU1pbGxpcyA9IHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgaWYgKCdoYW5kc2hha2luZ0ZhaWx1cmUnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQuaGFuZHNoYWtlRmFpbHVyZSA9IHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmU7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlOwogICAgICB9CgogICAgICBpZiAoJ3RhbGtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LnRhbGtUaW1lTWlsbGlzID0gcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICByZXBvcnQuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MoCiAgICAgICAgICAgIHJlcG9ydC5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKTsKCiAgICAgIHJldHVybiByZXBvcnQ7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBUYXNrVGVtcGxhdGVzQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogICB2YXIgVGFza1RlbXBsYXRlc0NsaWVudCA9IGZ1bmN0aW9uKGVuZHBvaW50KSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50Jyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgaWYgKGVuZHBvaW50LmluY2x1ZGVzKCcvdGFzay10ZW1wbGF0ZXMnKSkgewogICAgICAgICB0aGlzLmVuZHBvaW50VXJsID0gY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2woZW5kcG9pbnQpOwogICAgICB9IGVsc2UgewogICAgICAgICB2YXIgQVdTRW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgICAgdmFyIENGUHJlZml4ID0gZW5kcG9pbnQuaW5jbHVkZXMoJy5hd3NhcHBzLmNvbScpID8gJy9jb25uZWN0JyA6ICcnOwogICAgICAgICB0aGlzLmVuZHBvaW50VXJsID0gY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2woYCR7QVdTRW5kcG9pbnQuaG9zdH0ke0NGUHJlZml4fS90YXNrLXRlbXBsYXRlcy9hcGkvY2NwYCk7CiAgICAgIH0KICAgfTsKCiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1RlbXBsYXRlc0NsaWVudDsKCiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLAogICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICd4LWNzcmYtdG9rZW4nOiAnY3NyZicgICAgICAgICAKICAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgaW5zdGFuY2VJZCA9IHBhcmFtcy5pbnN0YW5jZUlkOwogICAgICB2YXIgdXJsID0gdGhpcy5lbmRwb2ludFVybDsKICAgICAgdmFyIG1ldGhvZHMgPSBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnRNZXRob2RzOwogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICAgICBjYXNlIG1ldGhvZHMuTElTVF9UQVNLX1RFTVBMQVRFUzogCiAgICAgICAgICAgIHVybCArPSBgL3Byb3h5L2luc3RhbmNlLyR7aW5zdGFuY2VJZH0vdGFzay90ZW1wbGF0ZWA7CiAgICAgICAgICAgIGlmIChwYXJhbXMucXVlcnlQYXJhbXMpIHsKICAgICAgICAgICAgICAgY29uc3QgcXVlcnlTdHJpbmcgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHBhcmFtcy5xdWVyeVBhcmFtcykudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgaWYgKHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgIHVybCArPSBgPyR7cXVlcnlTdHJpbmd9YDsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuR0VUX1RBU0tfVEVNUExBVEU6IAogICAgICAgICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnRlbXBsYXRlUGFyYW1zLCAncGFyYW1zLnRlbXBsYXRlUGFyYW1zJyk7CiAgICAgICAgICAgIGNvbnN0IGlkID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy50ZW1wbGF0ZVBhcmFtcy5pZCwgJ3BhcmFtcy50ZW1wbGF0ZVBhcmFtcy5pZCcpOwogICAgICAgICAgICBjb25zdCB2ZXJzaW9uID0gcGFyYW1zLnRlbXBsYXRlUGFyYW1zLnZlcnNpb247CiAgICAgICAgICAgIHVybCArPSBgL3Byb3h5L2luc3RhbmNlLyR7aW5zdGFuY2VJZH0vdGFzay90ZW1wbGF0ZS8ke2lkfWA7CiAgICAgICAgICAgIGlmICh2ZXJzaW9uKSB7CiAgICAgICAgICAgICAgIHVybCArPSBgP3NuYXBzaG90VmVyc2lvbj0ke3ZlcnNpb259YDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgY2FzZSBtZXRob2RzLkNSRUFURV9URU1QTEFURURfVEFTSzogCiAgICAgICAgICAgIHVybCArPSBgLyR7bWV0aG9kfWA7CiAgICAgICAgICAgIG9wdGlvbnMuYm9keSA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7CiAgICAgICAgICAgIG9wdGlvbnMubWV0aG9kID0gJ1BVVCc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuVVBEQVRFX0NPTlRBQ1Q6IAogICAgICAgICAgICB1cmwgKz0gYC8ke21ldGhvZH1gOwogICAgICAgICAgICBvcHRpb25zLmJvZHkgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpOwogICAgICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICdQT1NUJzsKICAgICAgfQogICAgICBjb25uZWN0LmZldGNoKHVybCwgb3B0aW9ucykKICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocmVzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgY29uc3QgcmVhZGVyID0gZXJyLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgICAgIGxldCBib2R5ID0gJyc7CiAgICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHsgZG9uZSwgdmFsdWUgfSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBlcnIuc3RhdHVzOwogICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkKCkudGhlbihwcm9jZXNzVGV4dCk7CiAgICAgICAgIH0pOwogICAgICB9KQogICB9OwoKICAgY29ubmVjdC5DbGllbnRCYXNlID0gQ2xpZW50QmFzZTsKICAgY29ubmVjdC5OdWxsQ2xpZW50ID0gTnVsbENsaWVudDsKICAgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50OwogICBjb25uZWN0LkFXU0NsaWVudCA9IEFXU0NsaWVudDsKICAgY29ubmVjdC5BZ2VudEFwcENsaWVudCA9IEFnZW50QXBwQ2xpZW50OwogICBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnQgPSBUYXNrVGVtcGxhdGVzQ2xpZW50Owp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gODk1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5jb3JlID0ge307CiAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgY29ubmVjdC52ZXJzaW9uID0gIlNUUkVBTVNfVkVSU0lPTiI7CiAgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkUgPSA1MDA7CiAKICB2YXIgQ0NQX1NZTl9USU1FT1VUID0gMTAwMDsgLy8gMSBzZWMKICB2YXIgQ0NQX0FDS19USU1FT1VUID0gMzAwMDsgLy8gMyBzZWMKICB2YXIgQ0NQX0xPQURfVElNRU9VVCA9IDUwMDA7IC8vIDUgc2VjCiAgdmFyIENDUF9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTCA9IDUwMDA7IC8vIDUgc2VjCiAgdmFyIENDUF9EUl9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTCA9IDEwMDAwOyAvLzEwIHMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0xJTUlUID0gNjsgLy8gNiBhdHRlbXB0cwogIHZhciBDQ1BfSUZSQU1FX05BTUUgPSAnQW1hem9uIENvbm5lY3QgQ0NQJzsKIAogIHZhciBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4gPSAiaHR0cHM6Ly97YWxpYXN9LmF3c2FwcHMuY29tL2F1dGgvP2NsaWVudF9pZD17Y2xpZW50X2lkfSZyZWRpcmVjdF91cmk9e3JlZGlyZWN0fSI7CiAgdmFyIENMSUVOVF9JRF9NQVAgPSB7CiAgICAidXMtZWFzdC0xIjogIjA2OTE5ZjRmZDhlZDMyNGUiCiAgfTsKIAogIHZhciBBVVRIT1JJWkVfRU5EUE9JTlQgPSAiL2F1dGgvYXV0aG9yaXplIjsKICB2YXIgTEVHQUNZX0FVVEhPUklaRV9FTkRQT0lOVCA9ICIvY29ubmVjdC9hdXRoL2F1dGhvcml6ZSI7CiAgdmFyIEFVVEhPUklaRV9SRVRSWV9JTlRFUlZBTCA9IDIwMDA7CiAgdmFyIEFVVEhPUklaRV9NQVhfUkVUUlkgPSA1OwogCiAgdmFyIExFR0FDWV9XSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UID0gIi9jb25uZWN0L3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX0VORFBPSU5UID0gIi93aGl0ZWxpc3RlZC1vcmlnaW5zIjsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19SRVRSWV9JTlRFUlZBTCA9IDIwMDA7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfTUFYX1JFVFJZID0gNTsKCiAgdmFyIENTTV9JRlJBTUVfUkVGUkVTSF9BVFRFTVBUUyA9ICdJZnJhbWVSZWZyZXNoQXR0ZW1wdHMnOwogIHZhciBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1NVQ0NFU1MgPSAnSWZyYW1lSW5pdGlhbGl6YXRpb25TdWNjZXNzJzsKICB2YXIgQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9USU1FID0gJ0lmcmFtZUluaXRpYWxpemF0aW9uVGltZSc7CgogIHZhciBDT05ORUNURURfQ0NQU19TSU5HTEVfVEFCID0gJ0Nvbm5lY3RlZENDUFNpbmdsZVRhYkNvdW50JzsKICB2YXIgQ0NQX1RBQlNfQUNST1NTX0JST1dTRVJfQ09VTlQgPSAnQ0NQVGFic0Fjcm9zc0Jyb3dzZXJDb3VudCc7CgogIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gMDsKICBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQc0luVGhpc1RhYiA9IDA7CgogIGNvbm5lY3QuY29yZS5NQVhfQVVUSE9SSVpFX1JFVFJZX0NPVU5UX0ZPUl9TRVNTSU9OID0gMzsKICBjb25uZWN0LmNvcmUuTUFYX0NUSV9BVVRIX1JFVFJZX0NPVU5UID0gMTA7CiAgY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50ID0gMDsKICBjb25uZWN0LmNvcmUuYXV0aG9yaXplVGltZW91dElkID0gbnVsbDsKICBjb25uZWN0LmNvcmUuY3RpVGltZW91dElkID0gbnVsbDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBTZXNzaW9uU3RvcmFnZUtleXMKICAgKi8KICBjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ3RhYl9pZCcsCiAgICAnYXV0aG9yaXplX3JldHJ5X2NvdW50JywKICBdKTsKCiAgLyoqCiAgICogQGRlcHJlY2F0ZWQKICAgKiBUaGlzIGZ1bmN0aW9uIHdhcyBvbmx5IG1lYW50IGZvciBpbnRlcm5hbCB1c2UuIAogICAqIFRoZSBuYW1lIGlzIG1pc2xlYWRpbmcgZm9yIHdoYXQgaXQgc2hvdWxkIGRvLgogICAqIEludGVybmFsbHkgd2UgaGF2ZSByZXBsYWNlZCBpdHMgdXNhZ2Ugd2l0aCBgZ2V0TG9naW5VcmxgLgogICAqLwogIHZhciBjcmVhdGVMb2dpblVybCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciByZWRpcmVjdCA9ICJodHRwczovL2xpbHkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGF3L2F1dGgvY29kZSI7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVkaXJlY3QpOwogCiAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgIHJldHVybiBwYXJhbXMubG9naW5VcmwKICAgIH0gZWxzZSBpZiAocGFyYW1zLmFsaWFzKSB7CiAgICAgIGxvZy53YXJuKCJUaGUgYGFsaWFzYCBwYXJhbSBpcyBkZXByZWNhdGVkIGFuZCBzaG91bGQgbm90IGJlIGV4cGVjdGVkIHRvIGZ1bmN0aW9uIHByb3Blcmx5LiBQbGVhc2UgdXNlIGBjY3BVcmxgIG9yIGBsb2dpblVybGAuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW1hem9uLWNvbm5lY3QvYW1hem9uLWNvbm5lY3Qtc3RyZWFtcy9ibG9iL21hc3Rlci9SRUFETUUubWQjY29ubmVjdGNvcmVpbml0Y2NwIGZvciB2YWxpZCBwYXJhbWV0ZXJzLiIpOwogICAgICByZXR1cm4gTEVHQUNZX0xPR0lOX1VSTF9QQVRURVJOCiAgICAgICAgLnJlcGxhY2UoInthbGlhc30iLCBwYXJhbXMuYWxpYXMpCiAgICAgICAgLnJlcGxhY2UoIntjbGllbnRfaWR9IiwgQ0xJRU5UX0lEX01BUFsidXMtZWFzdC0xIl0pCiAgICAgICAgLnJlcGxhY2UoIntyZWRpcmVjdH0iLCBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50KAogICAgICAgICAgcmVkaXJlY3QpKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBwYXJhbXMuY2NwVXJsOwogICAgfQogIH07CgogIC8qKgogICAqIFJlcGxhY2VzIGBjcmVhdGVMb2dpblVybGAsIGFzIHRoYXQgZnVuY3Rpb24ncyBuYW1lIHdhcyBtaXNsZWFkaW5nLgogICAqIFRoZSBgcGFyYW1zLmFsaWFzYCBwYXJhbWV0ZXIgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHJlZnJhaW4gZnJvbSB1c2luZyBpdC4KICAgKi8KICB2YXIgZ2V0TG9naW5VcmwgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICB2YXIgcmVkaXJlY3QgPSAiaHR0cHM6Ly9saWx5LnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL3Rhdy9hdXRoL2NvZGUiOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJlZGlyZWN0KTsKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgbG9nLndhcm4oIlRoZSBgYWxpYXNgIHBhcmFtIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZXhwZWN0ZWQgdG8gZnVuY3Rpb24gcHJvcGVybHkuIFBsZWFzZSB1c2UgYGNjcFVybGAgb3IgYGxvZ2luVXJsYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWF6b24tY29ubmVjdC9hbWF6b24tY29ubmVjdC1zdHJlYW1zL2Jsb2IvbWFzdGVyL1JFQURNRS5tZCNjb25uZWN0Y29yZWluaXRjY3AgZm9yIHZhbGlkIHBhcmFtZXRlcnMuIik7CiAgICAgIHJldHVybiBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIFJldHVybnMgc2NoZW1lOi8vaG9zdDpwb3J0IGZvciBhIGdpdmVuIHVybAogICovCiAgZnVuY3Rpb24gc2FuaXRpemVEb21haW4odXJsKSB7CiAgICB2YXIgZG9tYWluID0gdXJsLm1hdGNoKC9eKD86aHR0cHM/OlwvXC8pPyg/OlteQFxuXStAKT8oPzp3d3dcLik/KFteOlwvXG4/XSspL2lnKTsKICAgIHJldHVybiBkb21haW4ubGVuZ3RoID8gZG9tYWluWzBdIDogIiI7CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBQcmludCBhIHdhcm5pbmcgbWVzc2FnZSBpZiB0aGUgQ29ubmVjdCBjb3JlIGlzIG5vdCBpbml0aWFsaXplZC4KICAgICovCiAgY29ubmVjdC5jb3JlLmNoZWNrTm90SW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgICBsb2cud2FybigiQ29ubmVjdCBjb3JlIGFscmVhZHkgaW5pdGlhbGl6ZWQsIG9ubHkgbmVlZHMgdG8gYmUgaW5pdGlhbGl6ZWQgb25jZS4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CiAKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqIERJU0FTVEVSIFJFQ09WRVJZIAogICovCiAgCiAgdmFyIG1ha2VBZ2VudE9mZmxpbmUgPSBmdW5jdGlvbihhZ2VudCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgb2ZmbGluZVN0YXRlID0gYWdlbnQuZ2V0QWdlbnRTdGF0ZXMoKS5maW5kKGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGUudHlwZSA9PT0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5PRkZMSU5FOwogICAgfSk7CiAgICBhZ2VudC5zZXRTdGF0ZShvZmZsaW5lU3RhdGUsIGNhbGxiYWNrcyk7ICAgCiAgfQogCiAgLy8gU3VwcHJlc3MgQ29udGFjdHMgZnVuY3Rpb24gCiAgLy8gVGhpcyBpcyB1c2VkIGJ5IERpc2FzdGVyIFJlY292ZXJ5IGFzIGEgc2FmZWd1YXJkIHRvIG5vdCBzdXJmYWNlIGluY29taW5nIGNhbGxzL2NoYXRzIHRvIFVJCiAgLy8gCiAgdmFyIHN1cHByZXNzQ29udGFjdHMgPSBmdW5jdGlvbiAoaXNTdXBwcmVzc2VkKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgY29udGFjdHMgc3VwcHJlc3NvciB0byAlcyBmb3IgaW5zdGFuY2UgJXMuIiwgCiAgICAgIGlzU3VwcHJlc3NlZCwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgewogICAgICBzdXBwcmVzczogaXNTdXBwcmVzc2VkCiAgICB9KTsKICB9CiAKICB2YXIgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0gPSBmdW5jdGlvbihvZmZsaW5lKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltESVNBU1RFUiBSRUNPVkVSWV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgZm9yY2VPZmZsaW5lIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgb2ZmbGluZSwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCB7CiAgICAgIG9mZmxpbmU6IG9mZmxpbmUKICAgIH0pOwogIH0KIAogIC8vIEZvcmNlIHRoZSBpbnN0YW5jZSB0byBiZSBvZmZsaW5lLiAKICAvLyBUaGlzIHRyaWVzIHRvIGRpc2Nvbm5lY3QgYWxsIGNvbnRhY3RzIChIYXJkIHN0b3ApCiAgLy8gaWYgZHVlIHRvIGEgZmFpbHVyZSAodGhlIGJhY2tlbmQgaXMgbm90IHJlYWNoYWJsZSksIHNpZ25hbCB0aGUgc2hhcmVkIHdvcmtlciB0byBmb3JjZV9vZmZsaW5lIHdoZW4gaXQgd2FrZXMgdXAgYWdhaW4KICAvLyBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIHJhbiBmcm9tIG5hdGl2ZSBDQ1AgZm9yIGRpc2Nvbm5lY3RpbmcgY2hhdHMuCiAgdmFyIGZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBBdHRlbXB0aW5nIHRvIGZvcmNlIGluc3RhbmNlICVzIG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbihhZ2VudCkgewogICAgICB2YXIgY29udGFjdENsb3NlZCA9IDA7CiAgICAgIHZhciBjb250YWN0cyA9IGFnZW50LmdldENvbnRhY3RzKCk7CiAgICAgIGlmIChjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICBjb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnRhY3QpIAogICAgICAgICAgewogICAgICAgICAgICBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmRlc3Ryb3koewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgYWxsIGFjdGl2ZSBjb250YWN0cyBhcmUgY2xvc2VkCiAgICAgICAgICAgICAgICBpZiAoKytjb250YWN0Q2xvc2VkID09PSBjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgICAgICAgICAgICAvLyBJdCdzIG9rIGlmIHdlJ3JlIG5vdCBhYmxlIHRvIHB1dCB0aGUgYWdlbnQgb2ZmbGluZS4gCiAgICAgICAgICAgICAgICAgIC8vIHNpbmNlIHdlJ3JlIHN1cHByZXNzaW5nIHRoZSBhZ2VudHMgY29udGFjdHMgYWxyZWFkeS4gCiAgICAgICAgICAgICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgICAgICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbnN0YW5jZSAlcyBpcyBub3cgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIGxvZy53YXJuKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEFuIGVycm9yIG9jY3VyZWQgd2hpbGUgYXR0ZW1wdGluZyB0byBmb3JjZSB0aGlzIGluc3RhbmNlIHRvIG9mZmxpbmUgaW4gcmVnaW9uICVzIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIGxvZy53YXJuKGVycikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIC8vIHNpZ25hbCB0aGUgc2hhcmVkd29ya2VyIHRvIGNhbGwgZm9yY2VPZmZsaW5lIGFnYWluIHdoZW4gbmV0d29yayBjb25uZWN0aW9uIAogICAgICAgICAgICAgICAgLy8gaGFzIGJlZW4gcmUtZXN0YWJsaXNoZWQgKHRoaXMgaGFwcGVucyBpbiBjYXNlIG9mIG5ldHdvcmsgb3IgYmFja2VuZCBmYWlsdXJlcykKICAgICAgICAgICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKHRydWUpOwogICAgICAgICAgICB9fSk7CiAgICAgICAgICB9CiAgICAgICAgKSAgICAgICAgCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluc3RhbmNlICVzIGlzIG5vdyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfQogCiAgLy9Jbml0aWF0ZSBEaXNhc3RlciBSZWNvdmVyeSAoVGhpcyBzaG91bGQgb25seSBiZSBjYWxsZWQgZnJvbSBjdXN0b21DQ1AgdGhhdCBhcmUgRFIgZW5hYmxlZCkKICBjb25uZWN0LmNvcmUuaW5pdERpc2FzdGVyUmVjb3ZlcnkgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgY29ubmVjdC5jb3JlLnJlZ2lvbiA9IHBhcmFtcy5yZWdpb247CiAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7ICAKICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUgPSBmb3JjZU9mZmxpbmU7CgogICAgLy9SZWdpc3RlciBpZnJhbWUgbGlzdG5lciB0byBzZXQgbmF0aXZlIENDUCBvZmZsaW5lCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CiAKICAgIC8vIFJlZ2lzdGVyIEV2ZW50IGxpc3RuZXIgdG8gRm9yY2UgdGhlIEFnZW50IHRvIGJlIG9mZmxpbmUgd2hlbiBzaGFyZWQgd29ya2VyIHJlY292ZXJzIGZyb20gbmV0d29yayBmYWlsdXJlCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CgogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbml0aWFsaXppbmcgcmVnaW9uICVzIGFzIHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBhbHJlYWR5IHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwoKICAgIGlmICghcGFyYW1zLmlzUHJpbWFyeSkgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyh0cnVlKTsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gc3RhbmQtYnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMoZmFsc2UpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gcHJpbWFyeSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEJhc2ljIENvbm5lY3QgY2xpZW50IGluaXRpYWxpemF0aW9uLgogICAqIFNob3VsZCBiZSB1c2VkIG9ubHkgYnkgdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRUYXNrVGVtcGxhdGVzQ2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgQVdTIGNsaWVudAogICAqIFNob3VsZCBiZSB1c2VkIGJ5IFNoYXJlZCBXb3JrZXIgdG8gdXBkYXRlIEFXUyBjbGllbnQgd2l0aCBuZXcgY3JlZGVudGlhbHMKICAgKiBhZnRlciByZWZyZXNoZWQgYXV0aGVudGljYXRpb24uCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICAKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogCiAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuQVdTQ2xpZW50KGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludCk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVkIEFnZW50QXBwIGNsaWVudAogICAqIFNob3VsZCBiZSB1c2VkIGJ5IFNoYXJlZCBXb3JrZXIgdG8gdXBkYXRlIEFnZW50QXBwIGNsaWVudCB3aXRoIG5ldyBjcmVkZW50aWFscwogICAqIGFmdGVyIHJlZnJlc2hlZCBhdXRoZW50aWNhdGlvbi4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOyAgICAKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciBhdXRoQ29va2llTmFtZSA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aENvb2tpZU5hbWUsICdwYXJhbXMuYXV0aENvb2tpZU5hbWUnKTsKICAgIHZhciBlbmRwb2ludCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYWdlbnRBcHBFbmRwb2ludCwgJ3BhcmFtcy5hZ2VudEFwcEVuZHBvaW50Jyk7CiAgICAKICAgIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG5ldyBjb25uZWN0LkFnZW50QXBwQ2xpZW50KGF1dGhDb29raWVOYW1lLCBhdXRoVG9rZW4sIGVuZHBvaW50KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgVGFza1RlbXBsYXRlcyBjbGllbnQKICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdFRhc2tUZW1wbGF0ZXNDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMudGFza1RlbXBsYXRlc0VuZHBvaW50IHx8IHBhcmFtcy5lbmRwb2ludDsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ3Rhc2tUZW1wbGF0ZXNFbmRwb2ludCcpOwogICAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBuZXcgY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50KGVuZHBvaW50KTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFVuaW5pdGlhbGl6ZSBDb25uZWN0LgogICAqLwogIGNvbm5lY3QuY29yZS50ZXJtaW5hdGUgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgaWYgKGJ1cykgYnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICBjb25uZWN0LmNvcmUuYnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBudWxsOwogICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBTZXR1cCB0aGUgU29mdHBob25lTWFuYWdlciB0byBiZSBpbml0aWFsaXplZCB3aGVuIHRoZSBhZ2VudAogICAqIGlzIGRldGVybWluZWQgdG8gaGF2ZSBzb2Z0cGhvbmUgZW5hYmxlZC4KICAgKi8KICBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gbnVsbDsKIAogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBzdHJlYW07CiAgfTsKIAogIGNvbm5lY3QuY29yZS5pbml0UmluZ3RvbmVFbmdpbmVzID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogCiAgICB2YXIgc2V0dXBSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocmluZ3RvbmVTZXR0aW5ncykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncywgInJpbmd0b25lU2V0dGluZ3MiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2ssICJyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2suZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKIAogICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzID0ge307CiAKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnZvaWNlID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy52b2ljZSk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJWb2ljZVJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MuY2hhdC5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0KSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0ID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLmNoYXQpOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdFJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MudGFzay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlRhc2tSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnRhc2spOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJUYXNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjaykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMucXVldWVfY2FsbGJhY2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2spOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIGhhbmRsZVJpbmdlckRldmljZUNoYW5nZSgpOwogICAgfTsKIAogICAgdmFyIG1lcmdlUGFyYW1zID0gZnVuY3Rpb24gKHBhcmFtcywgb3RoZXJQYXJhbXMpIHsKICAgICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5OiBzdXBwb3J0IHB1bGxpbmcgZGlzYWJsZWQgZmxhZyBhbmQgcmluZ3RvbmVVcmwKICAgICAgLy8gZnJvbSBzb2Z0cGhvbmUgY29uZmlnIGlmIGl0IGV4aXN0cyBmcm9tIGRvd25zdHJlYW0gaW50byB0aGUgcmluZ3RvbmUgY29uZmlnLgogICAgICBwYXJhbXMucmluZ3RvbmUgPSBwYXJhbXMucmluZ3RvbmUgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZSA9IHBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IHBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnRhc2sgPSBwYXJhbXMucmluZ3RvbmUudGFzayB8fCB7IGRpc2FibGVkOiB0cnVlIH07CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZSkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUuZGlzYWJsZVJpbmd0b25lKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQpIHsKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0LmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5yaW5ndG9uZVVybCkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsOwogICAgICAgIH0KICAgICAgfQogCiAgICAgIC8vIE1lcmdlIGluIHJpbmd0b25lIHNldHRpbmdzIGZyb20gZG93bnN0cmVhbS4KICAgICAgaWYgKG90aGVyUGFyYW1zLnJpbmd0b25lKSB7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUudm9pY2UsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2ssCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5jaGF0LAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUuY2hhdCB8fCB7fSk7CiAgICAgIH0KICAgIH07CiAKICAgIC8vIE1lcmdlIHBhcmFtcyBmcm9tIHBhcmFtcy5zb2Z0cGhvbmUgYW5kIHBhcmFtcy5jaGF0IGludG8gcGFyYW1zLnJpbmd0b25lCiAgICAvLyBmb3IgZW1iZWRkZWQgYW5kIG5vbi1lbWJlZGRlZCB1c2UgY2FzZXMgc28gdGhhdCBkZWZhdWx0cyBhcmUgcGlja2VkIHVwLgogICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBwYXJhbXMpOwogCiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIC8vIElmIHRoZSBDQ1AgaXMgaW4gYSBmcmFtZSwgd2FpdCBmb3IgY29uZmlndXJhdGlvbiBmcm9tIGRvd25zdHJlYW0uCiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgIC8vIE1lcmdlIGFsbCBwYXJhbXMgZnJvbSBkYXRhIGludG8gcGFyYW1zIGZvciBhbnkgb3ZlcnJpZGRlbgogICAgICAgIC8vIHZhbHVlcyBpbiBlaXRoZXIgbGVnYWN5ICJzb2Z0cGhvbmUiIG9yICJyaW5ndG9uZSIgc2V0dGluZ3MuCiAgICAgICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBkYXRhKTsKICAgICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgICB9KTsKIAogICAgfSBlbHNlIHsKICAgICAgc2V0dXBSaW5ndG9uZUVuZ2luZXMocGFyYW1zLnJpbmd0b25lKTsKICAgIH0KICB9OwoKICB2YXIgaGFuZGxlUmluZ2VyRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwgc2V0UmluZ2VyRGV2aWNlKTsKICB9CgogIHZhciBzZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSl7CiAgICBpZihjb25uZWN0LmtleXMoY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcykubGVuZ3RoID09PSAwIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKXsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIGZvciAodmFyIHJpbmd0b25lVHlwZSBpbiBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzKSB7CiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXNbcmluZ3RvbmVUeXBlXS5zZXRPdXRwdXREZXZpY2UoZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5SSU5HRVJfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgY29ubmVjdC5jb3JlLmluaXRTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gaW5pdFNvZnRwaG9uZU1hbmFnZXIgc3RhcnRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAKICAgIHZhciBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZSA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVQYXJhbXNJbikgewogICAgICB2YXIgc29mdHBob25lUGFyYW1zID0gY29ubmVjdC5tZXJnZShwYXJhbXMuc29mdHBob25lIHx8IHt9LCBzb2Z0cGhvbmVQYXJhbXNJbik7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZSBleGVjdXRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgaWYgKCFhZ2VudC5nZXRDaGFubmVsQ29uY3VycmVuY3koY29ubmVjdC5DaGFubmVsVHlwZS5WT0lDRSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYWdlbnQub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBzdWIgPSB0aGlzOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGFnZW50IHJlZnJlc2ggaGFuZGxlciBleGVjdXRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBjb25maXJtZWQgYXMgc29mdHBob25lIG1hc3RlciB0b3BpYyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIGlmICghY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgJiYgYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkpIHsKICAgICAgICAgICAgICAvLyBCZWNvbWUgbWFzdGVyIHRvIHNlbmQgbG9ncywgc2luY2Ugd2UgbmVlZCBsb2dzIGZyb20gc29mdHBob25lIHRhYi4KICAgICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWFuYWdlcihzb2Z0cGhvbmVQYXJhbXMpOwogICAgICAgICAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9OwogCiAgICAvKioKICAgICAqIElmIHRoZSB3aW5kb3cgaXMgZnJhbWVkLCB3ZSBuZWVkIHRvIHdhaXQgZm9yIGEgQ09ORklHVVJFIG1lc3NhZ2UgZnJvbQogICAgICogZG93bnN0cmVhbSBiZWZvcmUgd2UgdHJ5IHRvIGluaXRpYWxpemUsIHVubGVzcyBwYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmUgaXMgdHJ1ZS4KICAgICAqLwogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiAhcGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIENvbmZpZ3VyZSBldmVudCBoYW5kbGVyIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBpZiAoZGF0YS5zb2Z0cGhvbmUgJiYgZGF0YS5zb2Z0cGhvbmUuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKGRhdGEuc29mdHBob25lKTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgICBzZXR1cEV2ZW50TGlzdGVuZXJzRm9yTXVsdGlUYWJVc2VJbkZpcmVmb3goZGF0YS5zb2Z0cGhvbmUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKHBhcmFtcyk7CiAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChwYXJhbXMpOwogICAgfQogCiAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAvLyBTeW5jIG11dGUgYWNyb3NzIGFsbCB0YWJzIAogICAgICBpZiAoYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkgJiYgYWdlbnQuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5KGNvbm5lY3QuQ2hhbm5lbFR5cGUuVk9JQ0UpKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgICAgIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBzZXR1cEV2ZW50TGlzdGVuZXJzRm9yTXVsdGlUYWJVc2VJbkZpcmVmb3goc29mdHBob25lUGFyYW1zSW4pIHsKICAgICAgdmFyIHNvZnRwaG9uZVBhcmFtcyA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnNvZnRwaG9uZSB8fCB7fSwgc29mdHBob25lUGFyYW1zSW4pOwoKICAgICAgLy8ga2VlcCB0aGUgc29mdHBob25lIHBhcmFtcyBmb3IgZXh0ZXJuYWwgdXNlCiAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMgPSBzb2Z0cGhvbmVQYXJhbXM7CgogICAgICBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkpIHsKICAgICAgICAvLyBJbiBGaXJlZm94LCB3aGVuIGEgdGFiIHRha2VzIG92ZXIgYW5vdGhlciB0YWIncyBzb2Z0cGhvbmUgcHJpbWFyeSwKICAgICAgICAvLyB0aGUgcHJldmlvdXMgcHJpbWFyeSB0YWIgc2hvdWxkIGRlbGV0ZSBzb2ZwaG9uZSBtYW5hZ2VyIGFuZCBzdG9wIG1pY3JvcGhvbmUKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgaWYgKHJlcy5kYXRhICYmIHJlcy5kYXRhLnRvcGljID09PSBjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUgJiYgcmVzLmRhdGEudGFrZU92ZXIgJiYgKHJlcy5kYXRhLm1hc3RlcklkICE9PSBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkKSkgewogICAgICAgICAgICBpZiAoY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5vbkluaXRDb250YWN0U3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgICAgZGVsZXRlIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1c2VyTWVkaWFTdHJlYW0gPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCk7CiAgICAgICAgICAgIGlmICh1c2VyTWVkaWFTdHJlYW0pIHsKICAgICAgICAgICAgICB1c2VyTWVkaWFTdHJlYW0uZ2V0VHJhY2tzKCkuZm9yRWFjaChmdW5jdGlvbih0cmFjaykgeyB0cmFjay5zdG9wKCk7IH0pOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0obnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gSW4gRmlyZWZveCwgd2hlbiBtdWx0aXBsZSB0YWJzIGFyZSBvcGVuLAogICAgICAgIC8vIHdlYnJ0YyBzZXNzaW9uIGlzIG5vdCBzdGFydGVkIHVudGlsIFJFQURZX1RPX1NUQVJUX1NFU1NJT04gZXZlbnQgaXMgdHJpZ2dlcmVkCiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5zdGFydFNlc3Npb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciAmJiBhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIoc29mdHBob25lUGFyYW1zKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIuc3RhcnRTZXNzaW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhhbmRsaW5nIG91dGJvdW5kLWNhbGwgYW5kIGF1dG8tYWNjZXB0IGNhc2VzIGZvciBwZW5kaW5nIHNlc3Npb24KICAgICAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGMpIHsKICAgICAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgICAgIGMub25SZWZyZXNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMoKSAmJgogICAgICAgICAgICAgICAgZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlID09PSAndmlzaWJsZScgJiYKICAgICAgICAgICAgICAgIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyB8fCBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNPdXRCb3VuZENhbGwgPSBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmICFjb250YWN0LmlzSW5ib3VuZCgpOwogICAgICAgICAgICAgICAgdmFyIGlzQXV0b0FjY2VwdEVuYWJsZWQgPSBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGFnZW50LmdldENvbmZpZ3VyYXRpb24oKS5zb2Z0cGhvbmVBdXRvQWNjZXB0OwogICAgICAgICAgICAgICAgdmFyIGlzUXVldWVkQ2FsbGJhY2sgPSBjb250YWN0LmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5RVUVVRV9DQUxMQkFDSzsKICAgICAgICAgICAgICAgIGlmIChpc091dEJvdW5kQ2FsbCB8fCBpc0F1dG9BY2NlcHRFbmFibGVkIHx8IGlzUXVldWVkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyB0cmlnZ2VyIFJFQURZX1RPX1NUQVJUX1NFU1NJT04gZXZlbnQgaW4gYSBjb250ZXh0IHdpdGggU29mdHBob25lIE1hbmFnZXIKICAvLyBpbnRlcm5hbCB1c2Ugb25seQogIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFsbG93RnJhbWVkU29mdHBob25lID0gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyAmJiBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lOwogICAgaWYgKGNvbm5lY3QuaXNDQ1AoKSkgewogICAgICBpZiAoYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIGluIHRoaXMgaWZyYW1lZCBDQ1AgY29udGV4dAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgICAgIC8vIGlmIHRoaXMgaXMgYW4gaWZyYW1lZCBDQ1AsIHRoZSBldmVudCBpcyBzZW5kIHRvIGRvd25zdHJlYW0gKENSTSkKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyBhIHN0YW5kYWxvbmUgQ0NQLCB0cmlnZ2VyIHRoaXMgZXZlbnQgaW4gdGhpcyBDQ1AgY29udGV4dAogICAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgc2VuZCB0byB0aGUgdXBzdHJlYW0gKGlmcmFtZWQgQ0NQKQogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBpbiB0aGlzIENSTSBjb250ZXh0CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0KICAgIH0KICB9OwoKICBjb25uZWN0LmNvcmUuaW5pdFBhZ2VPcHRpb25zID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAvLyBJZiB0aGUgQ0NQIGlzIGluIGEgZnJhbWUsIHdhaXQgZm9yIGNvbmZpZ3VyYXRpb24gZnJvbSBkb3duc3RyZWFtLgogICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuQ09ORklHVVJFLAogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIC8vIExpc3RlbiBmb3IgaWZyYW1lIG1lZGlhIGRldmljZXMgcmVxdWVzdCBmcm9tIENSTQogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVFVRVNULCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gc2VuZERldmljZXMoZGV2aWNlcykgewogICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFU1BPTlNFLCBkZXZpY2VzKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRldmljZXNJbikgewogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlc0luIHx8IFtdOwogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlcy5tYXAoZnVuY3Rpb24oZCkgeyByZXR1cm4gZC50b0pTT04oKSB9KTsKICAgICAgICAgICAgc2VuZERldmljZXMoZGV2aWNlcyk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgc2VuZERldmljZXMoe2Vycm9yOiBlcnIubWVzc2FnZX0pOwogICAgICAgICAgfSk7IAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZW5kRGV2aWNlcyh7ZXJyb3I6ICJObyBuYXZpZ2F0b3Igb3IgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBvYmplY3QgZm91bmQifSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogR2V0IHRoZSBsaXN0IG9mIG1lZGlhIGRldmljZXMgZnJvbSBpZnJhbWVkIENDUAogICAqIFRpbWVvdXQgZm9yIHRoZSByZXF1ZXN0IGlzIHBhc3NlZCBhbiBhbiBvcHRpb25hbCBhcmd1bWVudAogICAqIFRoZSBkZWZhdWx0IHRpbWVvdXQgaXMgMTAwMG1zCiAgICovCiAgY29ubmVjdC5jb3JlLmdldEZyYW1lTWVkaWFEZXZpY2VzID0gZnVuY3Rpb24gKHRpbWVvdXRJbikgewogICAgdmFyIHN1YiA9IG51bGw7CiAgICB2YXIgdGltZW91dCA9IHRpbWVvdXRJbiB8fCAxMDAwOwogICAgdmFyIHRpbWVvdXRQcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgCiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiVGltZW91dCBleGNlZWRlZCIpKTsgCiAgICAgIH0sIHRpbWVvdXQpOwogICAgfSk7CiAgICB2YXIgbWVkaWFEZXZpY2VzUHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsgCiAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgfHwgY29ubmVjdC5pc0NDUCgpKSB7CiAgICAgICAgaWYgKG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRldmljZXNJbikgewogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlc0luIHx8IFtdOwogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlcy5tYXAoZnVuY3Rpb24gKGQpIHsgcmV0dXJuIGQudG9KU09OKCkgfSk7CiAgICAgICAgICAgIHJlc29sdmUoZGV2aWNlcyk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiTm8gbmF2aWdhdG9yIG9yIG5hdmlnYXRvci5tZWRpYURldmljZXMgb2JqZWN0IGZvdW5kIikpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgICAgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVTUE9OU0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5lcnJvcikgewogICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGRhdGEuZXJyb3IpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVFVRVNUKTsKICAgICAgfQogICAgfSkKICAgIHJldHVybiBQcm9taXNlLnJhY2UoW21lZGlhRGV2aWNlc1Byb21pc2UsIHRpbWVvdXRQcm9taXNlXSkKICAgIC5maW5hbGx5KGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHN1YikgewogICAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgICB9CiAgICB9KTsKICB9CgogIC8vSW50ZXJuYWwgdXNlIG9ubHkuCiAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZSA9IGZ1bmN0aW9uIChlbmRwb2ludCkgewogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScKICAgIH07CgogICAgdmFyIGF1dGhvcml6ZUVuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICBpZiAoIWF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICAgIGF1dGhvcml6ZUVuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkKICAgICAgICA/IExFR0FDWV9BVVRIT1JJWkVfRU5EUE9JTlQKICAgICAgICA6IEFVVEhPUklaRV9FTkRQT0lOVDsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmZldGNoKGF1dGhvcml6ZUVuZHBvaW50LCBvcHRpb25zLCBBVVRIT1JJWkVfUkVUUllfSU5URVJWQUwsIEFVVEhPUklaRV9NQVhfUkVUUlkpOwogIH07CiAKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFRoaXMgdXNlZCB0byBiZSB1c2VkIGludGVybmFsbHksIGJ1dCBpcyBubyBsb25nZXIgbmVlZGVkLgogICAqLwogIGNvbm5lY3QuY29yZS52ZXJpZnlEb21haW5BY2Nlc3MgPSBmdW5jdGlvbiAoYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGlzIEFQSSB3aWxsIGJlIGRlcHJlY2F0ZWQgaW4gdGhlIG5leHQgbWFqb3IgdmVyc2lvbiByZWxlYXNlIik7CiAgICBpZiAoIWNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgaGVhZGVyczogewogICAgICAgICdYLUFtei1CZWFyZXInOiBhdXRoVG9rZW4KICAgICAgfQogICAgfTsKICAgIHZhciB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IG51bGw7CiAgICBpZiAoZW5kcG9pbnQpewogICAgICB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IGVuZHBvaW50OwogICAgfQogICAgZWxzZSB7CiAgICAgIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkgCiAgICAgICAgPyBMRUdBQ1lfV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVAogICAgICAgIDogV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVDsKICAgIH0KICAgIAogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2god2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQsIG9wdGlvbnMsIFdISVRFTElTVEVEX09SSUdJTlNfUkVUUllfSU5URVJWQUwsIFdISVRFTElTVEVEX09SSUdJTlNfTUFYX1JFVFJZKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICB2YXIgdG9wRG9tYWluID0gc2FuaXRpemVEb21haW4od2luZG93LmRvY3VtZW50LnJlZmVycmVyKTsKICAgICAgdmFyIGlzQWxsb3dlZCA9IHJlc3BvbnNlLndoaXRlbGlzdGVkT3JpZ2lucy5zb21lKGZ1bmN0aW9uIChvcmlnaW4pIHsKICAgICAgICByZXR1cm4gdG9wRG9tYWluID09PSBzYW5pdGl6ZURvbWFpbihvcmlnaW4pOwogICAgICB9KTsKICAgICAgcmV0dXJuIGlzQWxsb3dlZCA/IFByb21pc2UucmVzb2x2ZSgpIDogUHJvbWlzZS5yZWplY3QoKTsKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSZXR1cm5zIHRydWUgaWYgdGhpcyB3aW5kb3cncyBocmVmIGlzIG9uIHRoZSBsZWdhY3kgY29ubmVjdCBkb21haW4uIAogICAqIE9ubHkgdXNlZnVsIGZvciBpbnRlcm5hbCB1c2UuIAogICAqLwogIGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbiA9IGZ1bmN0aW9uKHVybCkgewogICAgdXJsID0gdXJsIHx8IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuIHVybC5pbmNsdWRlcygnLmF3c2FwcHMuY29tJyk7CiAgfQogCgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIFVzZWQgb25seSBieSB0aGUgQ0NQCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRTaGFyZWRXb3JrZXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAKICAgIHZhciBzaGFyZWRXb3JrZXJVcmwgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnNoYXJlZFdvcmtlclVybCwgJ3BhcmFtcy5zaGFyZWRXb3JrZXJVcmwnKTsKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWZyZXNoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZnJlc2hUb2tlbiwgJ3BhcmFtcy5yZWZyZXNoVG9rZW4nKTsKICAgIHZhciBhdXRoVG9rZW5FeHBpcmF0aW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW5FeHBpcmF0aW9uLCAncGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogICAgdmFyIGF1dGhvcml6ZUVuZHBvaW50ID0gcGFyYW1zLmF1dGhvcml6ZUVuZHBvaW50OwogICAgaWYgKCFhdXRob3JpemVFbmRwb2ludCkgewogICAgICBhdXRob3JpemVFbmRwb2ludCA9IGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbigpCiAgICAgICAgPyBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UCiAgICAgICAgOiBBVVRIT1JJWkVfRU5EUE9JTlQ7CiAgICB9CiAgICB2YXIgYWdlbnRBcHBFbmRwb2ludCA9IHBhcmFtcy5hZ2VudEFwcEVuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgdGFza1RlbXBsYXRlc0VuZHBvaW50ID0gcGFyYW1zLnRhc2tUZW1wbGF0ZXNFbmRwb2ludCB8fCBudWxsOwogICAgdmFyIGF1dGhDb29raWVOYW1lID0gcGFyYW1zLmF1dGhDb29raWVOYW1lIHx8IG51bGw7CiAKICAgIHRyeSB7CiAgICAgIC8vIEluaXRpYWxpemUgdGhlIGV2ZW50IGJ1cyBhbmQgYWdlbnQgZGF0YSBwcm92aWRlcnMuCiAgICAgIGNvbm5lY3QuY29yZS5ldmVudEJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKHsgbG9nRXZlbnRzOiB0cnVlIH0pOwogICAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5ID0gbmV3IGNvbm5lY3QuTWVkaWFGYWN0b3J5KHBhcmFtcyk7CiAgICAgIAogICAgICAvLyBDcmVhdGUgdGhlIHNoYXJlZCB3b3JrZXIgYW5kIHVwc3RyZWFtIGNvbmR1aXQuCiAgICAgIHZhciB3b3JrZXIgPSBuZXcgU2hhcmVkV29ya2VyKHNoYXJlZFdvcmtlclVybCwgIkNvbm5lY3RTaGFyZWRXb3JrZXIiKTsKICAgICAgdmFyIGNvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KCJDb25uZWN0U2hhcmVkV29ya2VyQ29uZHVpdCIsCiAgICAgICAgbmV3IGNvbm5lY3QuUG9ydFN0cmVhbSh3b3JrZXIucG9ydCksCiAgICAgICAgbmV3IGNvbm5lY3QuV2luZG93SU9TdHJlYW0od2luZG93LCBwYXJlbnQpKTsKIAogICAgICAvLyBTZXQgdGhlIGdsb2JhbCB1cHN0cmVhbSBjb25kdWl0IGZvciBleHRlcm5hbCB1c2UuCiAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IGNvbmR1aXQ7CiAgICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICAgIC8vIENsb3NlIG91ciBwb3J0IHRvIHRoZSBzaGFyZWQgd29ya2VyIGJlZm9yZSB0aGUgd2luZG93IGNsb3Nlcy4KICAgICAgZ2xvYmFsLm9udW5sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNMT1NFKTsKICAgICAgICB3b3JrZXIucG9ydC5jbG9zZSgpOwogICAgICB9OwogCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbUxvZ1B1c2goY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVEb3duc3RyZWFtQ2xpZW50U2lkZUxvZ3NQdXNoKCk7CiAgICAgIC8vIEJyaWRnZSBhbGwgdXBzdHJlYW0gbWVzc2FnZXMgaW50byB0aGUgZXZlbnQgYnVzLgogICAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogICAgICAvLyBQYXNzIGFsbCB1cHN0cmVhbSBtZXNzYWdlcyAoZnJvbSBzaGFyZWQgd29ya2VyKSBkb3duc3RyZWFtICh0byBDQ1AgY29uc3VtZXIpLgogICAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29uZHVpdC5wYXNzRG93bnN0cmVhbSgpKTsKCiAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgICAvLyBCcmlkZ2UgYWxsIGRvd25zdHJlYW0gbWVzc2FnZXMgaW50byB0aGUgZXZlbnQgYnVzLgogICAgICAgIGNvbmR1aXQub25BbGxEb3duc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKICAgICAgICAvLyBQYXNzIGFsbCBkb3duc3RyZWFtIG1lc3NhZ2VzIChmcm9tIENDUCBjb25zdW1lcikgdXBzdHJlYW0gKHRvIHNoYXJlZCB3b3JrZXIpLgogICAgICAgIGNvbmR1aXQub25BbGxEb3duc3RyZWFtKGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogICAgICB9CgogICAgICAvLyBTZW5kIGNvbmZpZ3VyYXRpb24gdXAgdG8gdGhlIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgIGF1dGhUb2tlbjogYXV0aFRva2VuLAogICAgICAgIGF1dGhUb2tlbkV4cGlyYXRpb246IGF1dGhUb2tlbkV4cGlyYXRpb24sCiAgICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50LAogICAgICAgIHJlZnJlc2hUb2tlbjogcmVmcmVzaFRva2VuLAogICAgICAgIHJlZ2lvbjogcmVnaW9uLAogICAgICAgIGF1dGhvcml6ZUVuZHBvaW50OiBhdXRob3JpemVFbmRwb2ludCwKICAgICAgICBhZ2VudEFwcEVuZHBvaW50OiBhZ2VudEFwcEVuZHBvaW50LAogICAgICAgIHRhc2tUZW1wbGF0ZXNFbmRwb2ludDogdGFza1RlbXBsYXRlc0VuZHBvaW50LAogICAgICAgIGF1dGhDb29raWVOYW1lOiBhdXRoQ29va2llTmFtZSwKICAgICAgICBsb25nUG9sbGluZ09wdGlvbnM6IHBhcmFtcy5sb25nUG9sbGluZ09wdGlvbnMgfHwgdW5kZWZpbmVkCiAgICAgIH0pOwogCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkFja25vd2xlZGdlZCBieSB0aGUgQ29ubmVjdFNoYXJlZFdvcmtlciEiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgY29ubmVjdC5jb3JlLl9zZXRUYWJJZCgpOwogICAgICAgIGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQgPSBkYXRhLmlkOwogICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgfSk7CiAgICAgIC8vIEFkZCBhbGwgdXBzdHJlYW0gbG9nIGVudHJpZXMgdG8gb3VyIG93biBsb2dnZXIuCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGlmIChsb2dFbnRyeS5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEdldCB3b3JrZXIgbG9ncwogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyKGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICB9KTsKICAgICAgLy8gR2V0IG91dGVyIGNvbnRleHQgbG9ncwogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCBmdW5jdGlvbiAobG9ncykgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgQXJyYXkuaXNBcnJheShsb2dzKSkgewogICAgICAgICAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyKGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2cpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEdldCBsb2cgZnJvbSBvdXRlciBjb250ZXh0CiAgICAgIGNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZykgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgbG9nLmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsgCiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2cpKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgY29ubmVjdC5jb3JlLm9uQXV0aEZhaWwoY29ubmVjdC5oaXRjaChjb25uZWN0LmNvcmUsIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aEZhaWwsIHBhcmFtcy5sb2dpbkVuZHBvaW50IHx8IG51bGwsIGF1dGhvcml6ZUVuZHBvaW50KSk7IC8vIEZvciBhdXRoIHJldHJ5IGxvZ2ljIG9uIDQwMXMuCiAgICAgIGNvbm5lY3QuY29yZS5vbkF1dGhvcml6ZVN1Y2Nlc3MoY29ubmVjdC5oaXRjaChjb25uZWN0LmNvcmUsIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplU3VjY2VzcykpOyAvLyBGb3IgYXV0aCByZXRyeSBsb2dpYyBvbiA0MDFzLgoKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJVc2VyIEFnZW50OiAiICsgbmF2aWdhdG9yLnVzZXJBZ2VudCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJpc0NDUHYyOiAiICsgdHJ1ZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJpc0ZyYW1lZDogIiArIGNvbm5lY3QuaXNGcmFtZWQoKSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtLm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5PVVRFUl9DT05URVhUX0lORk8sIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIHN0cmVhbXNWZXJzaW9uID0gZGF0YS5zdHJlYW1zVmVyc2lvbjsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlN0cmVhbXNKUyBWZXJzaW9uOiAiICsgc3RyZWFtc1ZlcnNpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwoKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIk51bWJlciBvZiBjb25uZWN0ZWQgQ0NQcyB1cGRhdGVkOiAiICsgZGF0YS5sZW5ndGgpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSBkYXRhLmxlbmd0aDsKICAgICAgICBpZiAoZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdICYmICFpc05hTihkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0ubGVuZ3RoKSl7CiAgICAgICAgICBpZiAoY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgIT09IGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXS5sZW5ndGgpIHsKICAgICAgICAgICAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgPSBkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0ubGVuZ3RoOwogICAgICAgICAgICBpZiAoY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgPiAxKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGVyZSBhcmUgIiArIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiICsgIiBjb25uZWN0ZWQgQ0NQcyBpbiB0aGlzIHRhYi4gUGxlYXNlIGFkanVzdCB5b3VyIGltcGxlbWVudGF0aW9uIHRvIGF2b2lkIGNvbXBsaWNhdGlvbnMuIElmIHlvdSBhcmUgZW1iZWRkaW5nIENDUCwgcGxlYXNlIGRvIHNvIGV4Y2x1c2l2ZWx5IHdpdGggaW5pdENDUC4gSW5pdENDUCB3aWxsIG5vdCBsZXQgeW91IGVtYmVkIG1vcmUgdGhhbiBvbmUgQ0NQLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgICBuYW1lOiBDT05ORUNURURfQ0NQU19TSU5HTEVfVEFCLAogICAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFifQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRhdGEudGFiSWQgJiYgZGF0YS5zdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIpIHsKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTUVUUklDUywgKCkgPT4KICAgICAgICAgICAgY29ubmVjdC5hZ2VudCgoKSA9PiBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICAgIG5hbWU6IENDUF9UQUJTX0FDUk9TU19CUk9XU0VSX0NPVU5ULAogICAgICAgICAgICAgIGRhdGE6IHsgdGFiSWQ6IGRhdGEudGFiSWQsIGNvdW50OiBkYXRhLnN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciB9CiAgICAgICAgICAgIH0pKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudChjb25kdWl0KTsKIAogICAgICAvLyBQYXNzIHRoZSBURVJNSU5BVEUgcmVxdWVzdCB1cHN0cmVhbSB0byB0aGUgc2hhcmVkIHdvcmtlci4KICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURSwKICAgICAgICBjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKIAogICAgICAvLyBSZWZyZXNoIHRoZSBwYWdlIHdoZW4gd2UgcmVjZWl2ZSB0aGUgVEVSTUlOQVRFRCByZXNwb25zZSBmcm9tIHRoZQogICAgICAvLyBzaGFyZWQgd29ya2VyLgogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFRCwgZnVuY3Rpb24gKCkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQodHJ1ZSk7CiAgICAgIH0pOwogCiAgICAgIHdvcmtlci5wb3J0LnN0YXJ0KCk7CgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5kb21haW5JZCkgewogICAgICAgICAgY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCA9IGRhdGEuZG9tYWluSWQ7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIHRyeSBmZXRjaGluZyB2b2ljZUlkJ3MgZG9tYWluSWQgb25jZSB0aGUgYWdlbnQgaXMgaW5pdGlhbGl6ZWQKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHZvaWNlSWQgPSBuZXcgY29ubmVjdC5Wb2ljZUlkKCk7CiAgICAgICAgdm9pY2VJZC5nZXREb21haW5JZCgpCiAgICAgICAgICAudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInZvaWNlSWQgZG9tYWluSWQgc3VjY2Vzc2Z1bGx5IGZldGNoZWQgYXQgYWdlbnQgaW5pdGlhbGl6YXRpb246ICIgKyBkb21haW5JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidm9pY2VJZCBkb21haW5JZCBub3QgZmV0Y2hlZCBhdCBhZ2VudCBpbml0aWFsaXphdGlvbiIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgfSk7CiAgICAgIH0pOwogCiAgICAgIC8vIEF0dGVtcHQgdG8gZ2V0IHBlcm1pc3Npb24gdG8gc2hvdyBub3RpZmljYXRpb25zLgogICAgICB2YXIgbm0gPSBjb25uZWN0LmNvcmUuZ2V0Tm90aWZpY2F0aW9uTWFuYWdlcigpOwogICAgICBubS5yZXF1ZXN0UGVybWlzc2lvbigpOwogCiAgICAgIGNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5JTklUX0RJU0FTVEVSX1JFQ09WRVJZLCBmdW5jdGlvbihwYXJhbXMpIHsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdERpc2FzdGVyUmVjb3ZlcnkocGFyYW1zKTsKICAgICAgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGluaXRpYWxpemUgdGhlIEFQSSBzaGFyZWQgd29ya2VyLCB3ZSdyZSBkZWFkISIpCiAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBjb25uZWN0LmNvcmUuX3NldFRhYklkID0gZnVuY3Rpb24oKSB7CiAgICB0cnkgewogICAgICBjb25uZWN0LmNvcmUudGFiSWQgPSB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5UQUJfSUQpOwogICAgICBpZiAoIWNvbm5lY3QuY29yZS50YWJJZCl7CiAgICAgICAgY29ubmVjdC5jb3JlLnRhYklkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLlRBQl9JRCwgY29ubmVjdC5jb3JlLnRhYklkKTsKICAgICAgfQogICAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0uc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRBQl9JRCwge3RhYklkOiBjb25uZWN0LmNvcmUudGFiSWR9KTsKICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJbVGFiIElkXSBUaGVyZSB3YXMgYW4gaXNzdWUgc2V0dGluZyB0aGUgdGFiIElkIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH0KIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgbG9hZGluZyB0aGUgQ0NQIGluIGFuIGlmcmFtZSBhbmQgY29ubmVjdGluZyB0byBpdC4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdENDUCA9IGZ1bmN0aW9uIChjb250YWluZXJEaXYsIHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIklmcmFtZSBpbml0aWFsaXphdGlvbiBzdGFydGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBpbml0U3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKICAgIC8vIENoZWNrIGlmIENDUCBpZnJhbWUgaGFzIGFscmVhZHkgYmVlbiBpbml0aWFsaXplZCB0aHJvdWdoIGluaXRDQ1AKICAgIHRyeSB7CiAgICAgIGlmIChjb25uZWN0LmNvcmUuX2dldENDUElmcmFtZSgpKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCdBdHRlbXB0ZWQgdG8gY2FsbCBpbml0Q0NQIHdoZW4gYW4gaWZyYW1lIGdlbmVyYXRlZCBieSBpbml0Q0NQIGFscmVhZHkgZXhpc3RzJykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignRXJyb3Igd2hpbGUgY2hlY2tpbmcgaWYgaW5pdENDUCBoYXMgYWxyZWFkeSBiZWVuIGNhbGxlZCcpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KIAogICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCB3aGVuIGluc3RlYWQgb2YgdGFraW5nIGEgcGFyYW1zIG9iamVjdAogICAgLy8gYXMgaW5wdXQgd2Ugb25seSBhY2NlcHRlZCBjY3BVcmwuCiAgICB2YXIgcGFyYW1zID0ge307CiAgICBpZiAodHlwZW9mIChwYXJhbXNJbikgPT09ICdzdHJpbmcnKSB7CiAgICAgIHBhcmFtcy5jY3BVcmwgPSBwYXJhbXNJbjsKICAgIH0gZWxzZSB7CiAgICAgIHBhcmFtcyA9IHBhcmFtc0luOwogICAgfQogCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFpbmVyRGl2LCAnY29udGFpbmVyRGl2Jyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmNjcFVybCwgJ3BhcmFtcy5jY3BVcmwnKTsKIAogICAgLy8gQ3JlYXRlIHRoZSBDQ1AgaWZyYW1lIGFuZCBhcHBlbmQgaXQgdG8gdGhlIGNvbnRhaW5lciBkaXYuCiAgICB2YXIgaWZyYW1lID0gY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUoY29udGFpbmVyRGl2LCBwYXJhbXMpOwoKICAgIC8vIEluaXRpYWxpemUgdGhlIGV2ZW50IGJ1cyBhbmQgYWdlbnQgZGF0YSBwcm92aWRlcnMuCiAgICAvLyBOT1RFOiBTZXR0aW5nIGxvZ0V2ZW50cyBoZXJlIHRvIEZBTFNFIGluIG9yZGVyIHRvIGF2b2lkIGR1cGxpY2F0aW5nCiAgICAvLyBldmVudHMgd2hpY2ggYXJlIGxvZ2dlZCBpbiBDQ1AuCiAgICBjb25uZWN0LmNvcmUuZXZlbnRCdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cyh7IGxvZ0V2ZW50czogZmFsc2UgfSk7CiAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeSA9IG5ldyBjb25uZWN0Lk1lZGlhRmFjdG9yeShwYXJhbXMpOwogCiAgICAvLyBCdWlsZCB0aGUgdXBzdHJlYW0gY29uZHVpdCBjb21tdW5pY2F0aW5nIHdpdGggdGhlIENDUCBpZnJhbWUuCiAgICB2YXIgY29uZHVpdCA9IG5ldyBjb25uZWN0LklGcmFtZUNvbmR1aXQocGFyYW1zLmNjcFVybCwgd2luZG93LCBpZnJhbWUpOwogCiAgICAvLyBMZXQgQ0NQIGtub3cgaWYgaWZyYW1lIGlzIHZpc2libGUKICAgIGNvbm5lY3QuY29yZS5fc2VuZElmcmFtZVN0eWxlRGF0YVVwc3RyZWFtQWZ0ZXJSZWFzb25hYmxlV2FpdFRpbWUoaWZyYW1lLCBjb25kdWl0KTsKIAogICAgLy8gU2V0IHRoZSBnbG9iYWwgdXBzdHJlYW0gY29uZHVpdCBmb3IgZXh0ZXJuYWwgdXNlLgogICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtID0gY29uZHVpdDsKIAogICAgLy8gSW5pdCB3ZWJTb2NrZXRQcm92aWRlcgogICAgY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyID0gbmV3IFdlYlNvY2tldFByb3ZpZGVyKCk7CiAKICAgIGNvbmR1aXQub25BbGxVcHN0cmVhbShjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5icmlkZ2UoKSk7CiAKICAgIC8vIEluaXRpYWxpemUgdGhlIGtlZXBhbGl2ZSBtYW5hZ2VyLgogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBuZXcgS2VlcGFsaXZlTWFuYWdlcihjb25kdWl0LAogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSwKICAgICAgcGFyYW1zLmNjcFN5blRpbWVvdXQgfHwgQ0NQX1NZTl9USU1FT1VULAogICAgICBwYXJhbXMuY2NwQWNrVGltZW91dCB8fCBDQ1BfQUNLX1RJTUVPVVQpCiAgICAgIDsKICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9IG51bGw7CiAKICAgIC8vIEFsbG93IDUgc2VjIChkZWZhdWx0KSBiZWZvcmUgcmVjZWl2aW5nIHRoZSBmaXJzdCBBQ0sgZnJvbSB0aGUgQ0NQLgogICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCk7CiAgICB9LCBwYXJhbXMuY2NwTG9hZFRpbWVvdXQgfHwgQ0NQX0xPQURfVElNRU9VVCk7CgogICAgY29ubmVjdC5nZXRMb2coKS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQTG9nc1B1c2goY29uZHVpdCk7CiAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NQdXNoKGNvbmR1aXQpOwogCiAgICAvLyBPbmNlIHdlIHJlY2VpdmUgdGhlIGZpcnN0IEFDSywgc2V0dXAgb3VyIHVwc3RyZWFtIEFQSSBjbGllbnQgYW5kIGVzdGFibGlzaAogICAgLy8gdGhlIFNZTi9BQ0sgcmVmcmVzaCBmbG93LgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkFja25vd2xlZGdlZCBieSB0aGUgQ0NQISIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuY29yZS5jbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBuZXcgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQoY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQgPSBkYXRhLmlkOwoKICAgICAgaWYgKHBhcmFtcy5zb2Z0cGhvbmUgfHwgcGFyYW1zLmNoYXQgfHwgcGFyYW1zLnBhZ2VPcHRpb25zIHx8IHBhcmFtcy5zaG91bGRBZGROYW1lc3BhY2VUb0xvZ3MpIHsKICAgICAgICAvLyBTZW5kIGNvbmZpZ3VyYXRpb24gdXAgdG8gdGhlIENDUC4KICAgICAgICAvL3NldCBpdCB0byBmYWxzZSBpZiBzZWNvbmRhcnkKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIHsKICAgICAgICAgIHNvZnRwaG9uZTogcGFyYW1zLnNvZnRwaG9uZSwKICAgICAgICAgIGNoYXQ6IHBhcmFtcy5jaGF0LAogICAgICAgICAgcGFnZU9wdGlvbnM6IHBhcmFtcy5wYWdlT3B0aW9ucywKICAgICAgICAgIHNob3VsZEFkZE5hbWVzcGFjZVRvTG9nczogcGFyYW1zLnNob3VsZEFkZE5hbWVzcGFjZVRvTG9ncywKICAgICAgICB9KTsKICAgICAgfQogCiAgICAgIC8vIElmIERSIGVuYWJsZWQsIHNldCB0aGlzIENDUCBpbnN0YW5jZSBhcyBwYXJ0IG9mIGEgRGlzYXN0ZXIgUmVjb3ZlcnkgZmxlZXQKICAgICAgaWYgKHBhcmFtcy5kaXNhc3RlclJlY292ZXJ5T24pIHsKICAgICAgICBjb25uZWN0LmNvcmUucmVnaW9uID0gcGFyYW1zLnJlZ2lvbjsKICAgICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7CiAgICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FKTsKICAgICAgICB9ICAgICAgIAogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5JTklUX0RJU0FTVEVSX1JFQ09WRVJZLCBwYXJhbXMpOwogICAgICB9CiAKICAgICAgaWYgKGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlKSB7CiAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICB9CgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5PVVRFUl9DT05URVhUX0lORk8sIHsgc3RyZWFtc1ZlcnNpb246IGNvbm5lY3QudmVyc2lvbiB9KTsKIAogICAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlci5zdGFydCgpOwogICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CgogICAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLklOSVQpOwogICAgICBpZiAoaW5pdFN0YXJ0VGltZSkgewogICAgICAgIHZhciBpbml0VGltZSA9IERhdGUubm93KCkgLSBpbml0U3RhcnRUaW1lOwogICAgICAgIHZhciByZWZyZXNoQXR0ZW1wdHMgPSBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgfHwgMDsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oJ0lmcmFtZSBpbml0aWFsaXphdGlvbiBzdWNjZWVkZWQnKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgSWZyYW1lIGluaXRpYWxpemF0aW9uIHRpbWUgJHtpbml0VGltZX1gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgSWZyYW1lIHJlZnJlc2ggYXR0ZW1wdHMgJHtyZWZyZXNoQXR0ZW1wdHN9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfUkVGUkVTSF9BVFRFTVBUUywKICAgICAgICAgICAgZGF0YTogeyBjb3VudDogcmVmcmVzaEF0dGVtcHRzfSAKICAgICAgICAgIH0pOwogICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9TVUNDRVNTLAogICAgICAgICAgICBkYXRhOiB7IGNvdW50OiAxfSAKICAgICAgICAgIH0pOwogICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9USU1FLAogICAgICAgICAgICBkYXRhOiB7IGNvdW50OiBpbml0VGltZX0gCiAgICAgICAgICB9KTsKICAgICAgICAgIC8vdG8gYXZvaWQgbWV0cmljIGVtaXNzaW9uIGFmdGVyIGluaXRpYWxpemF0aW9uCiAgICAgICAgICBpbml0U3RhcnRUaW1lID0gbnVsbDsKICAgICAgICB9LDEwMDApCiAgICAgIH0KICAgIH0pOwogCiAgICAvLyBBZGQgYW55IGxvZ3MgZnJvbSB0aGUgdXBzdHJlYW0gdG8gb3VyIG93biBsb2dnZXIuCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBmdW5jdGlvbiAobG9nRW50cnkpIHsKICAgICAgaWYgKGxvZ0VudHJ5LmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICB9CiAgICB9KTsKIAogICAgLy8gUG9wIGEgbG9naW4gcGFnZSB3aGVuIHdlIGVuY291bnRlciBhbiBBQ0sgdGltZW91dC4KICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCwgZnVuY3Rpb24gKCkgewogICAgICAvLyBsb2dpblBvcHVwIGlzIHRydWUgYnkgZGVmYXVsdCwgb25seSBmYWxzZSBpZiBleHBsaWNpdGx5IHNldCB0byBmYWxzZS4KICAgICAgaWYgKHBhcmFtcy5sb2dpblBvcHVwICE9PSBmYWxzZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbG9naW5VcmwgPSBnZXRMb2dpblVybChwYXJhbXMpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJBQ0tfVElNRU9VVCBvY2N1cnJlZCwgYXR0ZW1wdGluZyB0byBwb3AgdGhlIGxvZ2luIHBhZ2UgaWYgbm90IGFscmVhZHkgb3Blbi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgLy8gY2xlYXIgb3V0IGxhc3Qgb3BlbmVkIHRpbWVzdGFtcCBmb3IgU0FNTCBhdXRoZW50aWNhdGlvbiB3aGVuIHRoZXJlIGlzIEFDS19USU1FT1VUCiAgICAgICAgICBpZiAocGFyYW1zLmxvZ2luVXJsKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIoKS5jbGVhcihjb25uZWN0Lk1hc3RlclRvcGljcy5MT0dJTl9QT1BVUCk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25uZWN0LmNvcmUubG9naW5XaW5kb3cgPSBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkub3Blbihsb2dpblVybCwgY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVAsIHBhcmFtcy5sb2dpbk9wdGlvbnMpOwogCiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQUNLX1RJTUVPVVQgb2NjdXJyZWQgYnV0IHdlIGFyZSB1bmFibGUgdG8gb3BlbiB0aGUgbG9naW4gcG9wdXAuIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9PSBudWxsKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLmNsZWFyKGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQKTsKICAgICAgICAgICAgaWYgKChwYXJhbXMubG9naW5Qb3B1cEF1dG9DbG9zZSB8fCAocGFyYW1zLmxvZ2luT3B0aW9ucyAmJiBwYXJhbXMubG9naW5PcHRpb25zLmF1dG9DbG9zZSkpICYmIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdy5jbG9zZSgpOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5sb2dpbldpbmRvdyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgY29ubmVjdC5jb3JlLl9yZWZyZXNoSWZyYW1lT25UaW1lb3V0KHBhcmFtcywgY29udGFpbmVyRGl2KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJFcnJvciBvY2N1cnJlZCB3aGlsZSByZWZyZXNoaW5nIGlmcmFtZSIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogCiAgICBpZiAocGFyYW1zLm9uVmlld0NvbnRhY3QpIHsKICAgICAgY29ubmVjdC5jb3JlLm9uVmlld0NvbnRhY3QocGFyYW1zLm9uVmlld0NvbnRhY3QpOwogICAgfQoKICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID0gZGF0YS5sZW5ndGg7CiAgICB9KTsKCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmIChkYXRhICYmIGRhdGEuZG9tYWluSWQpIHsKICAgICAgICBjb25uZWN0LmNvcmUudm9pY2VJZERvbWFpbklkID0gZGF0YS5kb21haW5JZDsKICAgICAgfQogICAgfSk7CgogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9SRVRSSUVTX0VYSEFVU1RFRCwgZnVuY3Rpb24gKCkgewogICAgICBpZiAoaW5pdFN0YXJ0VGltZSkgewogICAgICAgIHZhciByZWZyZXNoQXR0ZW1wdHMgPSBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgLSAxOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygnSWZyYW1lIGluaXRpYWxpemF0aW9uIGZhaWxlZCcpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKGBUaW1lIGFmdGVyIGlmcmFtZSBpbml0aWFsaXphdGlvbiBzdGFydGVkICR7RGF0ZS5ub3coKSAtIGluaXRTdGFydFRpbWV9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYElmcmFtZSByZWZyZXNoIGF0dGVtcHRzICR7cmVmcmVzaEF0dGVtcHRzfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfUkVGUkVTSF9BVFRFTVBUUywKICAgICAgICAgIGRhdGE6IHsgY291bnQ6IHJlZnJlc2hBdHRlbXB0c30KICAgICAgICB9KTsKICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9JTklUSUFMSVpBVElPTl9TVUNDRVNTLAogICAgICAgICAgZGF0YTogeyBjb3VudDogMH0KICAgICAgICB9KTsKICAgICAgICBpbml0U3RhcnRUaW1lID0gbnVsbDsKICAgICAgfQogICAgfSk7CgogICAgLy8ga2VlcCB0aGUgc29mdHBob25lIHBhcmFtcyBmb3IgZXh0ZXJuYWwgdXNlCiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zID0gcGFyYW1zLnNvZnRwaG9uZTsKICB9OwoKICBjb25uZWN0LmNvcmUub25JZnJhbWVSZXRyaWVzRXhoYXVzdGVkID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9SRVRSSUVTX0VYSEFVU1RFRCwgZik7CiAgfQoKICBjb25uZWN0LmNvcmUuX3JlZnJlc2hJZnJhbWVPblRpbWVvdXQgPSBmdW5jdGlvbihpbml0Q0NQUGFyYW1zLCBjb250YWluZXJEaXYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpbml0Q0NQUGFyYW1zLCAnaW5pdENDUFBhcmFtcycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgdmFyIGNjcElmcmFtZVJlZnJlc2hJbnRlcnZhbCA9IChpbml0Q0NQUGFyYW1zLmRpc2FzdGVyUmVjb3ZlcnlPbikgPyBDQ1BfRFJfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUwgOiBDQ1BfSUZSQU1FX1JFRlJFU0hfSU5URVJWQUw7CiAgICB2YXIgcmV0cnlEZWxheSA9IEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDAsIHsgYmFzZTogMjAwMCB9KTsKICAgIHZhciB0aW1lb3V0ID0gY2NwSWZyYW1lUmVmcmVzaEludGVydmFsICsgcmV0cnlEZWxheTsKICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgPSAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDApICsgMTsKICAgICAgaWYgKGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCA8PSBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGlmcmFtZSA9IGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lKCk7CiAgICAgICAgICBpZiAoaWZyYW1lKSB7CiAgICAgICAgICAgIGlmcmFtZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGlmcmFtZSk7IC8vIFRoZSBvbmx5IHdheSB0byBmb3JjZSBhIHN5bmNocm9ub3VzIHJlbG9hZCBvZiB0aGUgaWZyYW1lIHdpdGhvdXQgdGhlIG9sZCBpZnJhbWUgY29udGludWluZyB0byBmdW5jdGlvbiBpcyB0byByZW1vdmUgdGhlIG9sZCBpZnJhbWUgZW50aXJlbHkuCiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3SWZyYW1lID0gY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUoY29udGFpbmVyRGl2LCBpbml0Q0NQUGFyYW1zKTsKICAgICAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbS51cHN0cmVhbS5vdXRwdXQgPSBuZXdJZnJhbWUuY29udGVudFdpbmRvdzsgLy9yZXBsYWNlcyB0aGUgb3V0cHV0IHdpbmRvdyAob2xkIGlmcmFtZSdzIGNvbnRlbnRXaW5kb3cpIG9mIHRoZSBXaW5kb3dJT1N0cmVhbSAod2l0aGluIHRoZSBJRnJhbWVDb25kdWl0KSB3aXRoIHRoZSBuZXcgaWZyYW1lJ3MgY29udGVudFdpbmRvdy4KICAgICAgICAgIGNvbm5lY3QuY29yZS5fc2VuZElmcmFtZVN0eWxlRGF0YVVwc3RyZWFtQWZ0ZXJSZWFzb25hYmxlV2FpdFRpbWUobmV3SWZyYW1lLCBjb25uZWN0LmNvcmUudXBzdHJlYW0pOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcignRXJyb3Igd2hpbGUgY2hlY2tpbmcgZm9yLCBhbmQgcmVjcmVhdGluZywgdGhlIENDUCBJRnJhbWUnKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICAgIGNvbm5lY3QuY29yZS5fcmVmcmVzaElmcmFtZU9uVGltZW91dChpbml0Q0NQUGFyYW1zLCBjb250YWluZXJEaXYpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1JFVFJJRVNfRVhIQVVTVEVEKTsKICAgICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoVGltZW91dCk7CiAgICAgIH0KICAgIH0sIHRpbWVvdXQpOwogIH0KCgogIGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lID0gZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBpZnJhbWUgb2Ygd2luZG93LmRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKSkgewogICAgICBpZiAoaWZyYW1lLm5hbWUgPT09IENDUF9JRlJBTUVfTkFNRSkgewogICAgICAgIHJldHVybiBpZnJhbWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBudWxsOwogIH0KCiAgY29ubmVjdC5jb3JlLl9jcmVhdGVDQ1BJZnJhbWUgPSBmdW5jdGlvbihjb250YWluZXJEaXYsIGluaXRDQ1BQYXJhbXMpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpbml0Q0NQUGFyYW1zLCAnaW5pdENDUFBhcmFtcycpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhaW5lckRpdiwgJ2NvbnRhaW5lckRpdicpOwogICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwogICAgaWZyYW1lLnNyYyA9IGluaXRDQ1BQYXJhbXMuY2NwVXJsOwogICAgaWZyYW1lLmFsbG93ID0gIm1pY3JvcGhvbmU7IGF1dG9wbGF5IjsKICAgIGlmcmFtZS5zdHlsZSA9IGluaXRDQ1BQYXJhbXMuc3R5bGUgfHwgIndpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUiOwogICAgaWZyYW1lLnRpdGxlID0gaW5pdENDUFBhcmFtcy5pZnJhbWVUaXRsZSB8fCBDQ1BfSUZSQU1FX05BTUU7CiAgICBpZnJhbWUubmFtZSA9IENDUF9JRlJBTUVfTkFNRTsKICAgIGNvbnRhaW5lckRpdi5hcHBlbmRDaGlsZChpZnJhbWUpOwogICAgcmV0dXJuIGlmcmFtZTsKICB9CgogIGNvbm5lY3QuY29yZS5fc2VuZElmcmFtZVN0eWxlRGF0YVVwc3RyZWFtQWZ0ZXJSZWFzb25hYmxlV2FpdFRpbWUgPSBmdW5jdGlvbihpZnJhbWUsIGNvbmR1aXQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZnJhbWUsICdpZnJhbWUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb25kdWl0LCAnY29uZHVpdCcpOwogICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoaWZyYW1lLCBudWxsKTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgZGlzcGxheTogc3R5bGUuZGlzcGxheSwKICAgICAgICBvZmZzZXRXaWR0aDogaWZyYW1lLm9mZnNldFdpZHRoLAogICAgICAgIG9mZnNldEhlaWdodDogaWZyYW1lLm9mZnNldEhlaWdodCwKICAgICAgICBjbGllbnRSZWN0c0xlbmd0aDogaWZyYW1lLmdldENsaWVudFJlY3RzKCkubGVuZ3RoCiAgICAgIH07CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLklGUkFNRV9TVFlMRSwgZGF0YSk7CiAgICB9LCAxMDAwMCk7CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBLZWVwYWxpdmVNYW5hZ2VyID0gZnVuY3Rpb24gKGNvbmR1aXQsIGV2ZW50QnVzLCBzeW5UaW1lb3V0LCBhY2tUaW1lb3V0KSB7CiAgICB0aGlzLmNvbmR1aXQgPSBjb25kdWl0OwogICAgdGhpcy5ldmVudEJ1cyA9IGV2ZW50QnVzOwogICAgdGhpcy5zeW5UaW1lb3V0ID0gc3luVGltZW91dDsKICAgIHRoaXMuYWNrVGltZW91dCA9IGFja1RpbWVvdXQ7CiAgICB0aGlzLmFja1RpbWVyID0gbnVsbDsKICAgIHRoaXMuc3luVGltZXIgPSBudWxsOwogICAgdGhpcy5hY2tTdWIgPSBudWxsOwogIH07CiAKICBLZWVwYWxpdmVNYW5hZ2VyLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKIAogICAgdGhpcy5jb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TWU5DSFJPTklaRSk7CiAgICB0aGlzLmFja1N1YiA9IHRoaXMuY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoKSB7CiAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChzZWxmLmFja1RpbWVyKTsKICAgICAgc2VsZi5fZGVmZXJTdGFydCgpOwogICAgfSk7CiAgICB0aGlzLmFja1RpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBzZWxmLmFja1N1Yi51bnN1YnNjcmliZSgpOwogICAgICBzZWxmLmV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQpOwogICAgICBzZWxmLl9kZWZlclN0YXJ0KCk7CiAgICB9LCB0aGlzLmFja1RpbWVvdXQpOwogIH07CgogIC8vRml4ZXMgdGhlIGtlZXBhbGl2ZW1hbmFnZXIuCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuX2RlZmVyU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN5blRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnN0YXJ0KSwgdGhpcy5zeW5UaW1lb3V0KTsKICB9OwoKICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgb25seSwgaW4gY2FzZSBjdXN0b21lcnMgYXJlIHVzaW5nIHRoaXMgdG8gc3RhcnQgdGhlIGtlZXBhbGl2ZW1hbmFnZXIgZm9yIHNvbWUgcmVhc29uLgogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLmRlZmVyU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5zeW5UaW1lciA9PSBudWxsKSB7CiAgICAgIHRoaXMuc3luVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuc3RhcnQpLCB0aGlzLnN5blRpbWVvdXQpOwogICAgfQogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAKICB2YXIgV2ViU29ja2V0UHJvdmlkZXIgPSBmdW5jdGlvbiAoKSB7CiAKICAgIHZhciBjYWxsYmFja3MgPSB7CiAgICAgIGluaXRGYWlsdXJlOiBuZXcgU2V0KCksCiAgICAgIHN1YnNjcmlwdGlvblVwZGF0ZTogbmV3IFNldCgpLAogICAgICBzdWJzY3JpcHRpb25GYWlsdXJlOiBuZXcgU2V0KCksCiAgICAgIHRvcGljOiBuZXcgTWFwKCksCiAgICAgIGFsbE1lc3NhZ2U6IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkdhaW46IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkxvc3Q6IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbk9wZW46IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkNsb3NlOiBuZXcgU2V0KCkKICAgIH07CiAKICAgIHZhciBpbnZva2VDYWxsYmFja3MgPSBmdW5jdGlvbiAoY2FsbGJhY2tzLCByZXNwb25zZSkgewogICAgICBjYWxsYmFja3MuZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayhyZXNwb25zZSk7CiAgICAgIH0pOwogICAgfTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGZ1bmN0aW9uICgpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5pbml0RmFpbHVyZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fT1BFTiwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4sIHJlc3BvbnNlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9DTE9TRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLCByZXNwb25zZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fR0FJTiwgZnVuY3Rpb24gKCkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdCwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZSwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQUxMX01FU1NBR0UsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmFsbE1lc3NhZ2UsIHJlc3BvbnNlKTsKICAgICAgaWYgKGNhbGxiYWNrcy50b3BpYy5oYXMocmVzcG9uc2UudG9waWMpKSB7CiAgICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy50b3BpYy5nZXQocmVzcG9uc2UudG9waWMpLCByZXNwb25zZSk7CiAgICAgIH0KICAgIH0pOwogCiAgICB0aGlzLnNlbmRNZXNzYWdlID0gZnVuY3Rpb24gKHdlYlNvY2tldFBheWxvYWQpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNFTkQsIHdlYlNvY2tldFBheWxvYWQpOwogICAgfTsKIAogICAgdGhpcy5vbkluaXRGYWlsdXJlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuaW5pdEZhaWx1cmUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmluaXRGYWlsdXJlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uT3BlbiA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4uYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uQ2xvc2UgPSBmdW5jdGlvbihjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uR2FpbiA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbi5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vbkNvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uU3Vic2NyaXB0aW9uVXBkYXRlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25TdWJzY3JpcHRpb25GYWlsdXJlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5zdWJzY3JpYmVUb3BpY3MgPSBmdW5jdGlvbiAodG9waWNzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpY3MsICd0b3BpY3MnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNBcnJheSh0b3BpY3MpLCAndG9waWNzIG11c3QgYmUgYSBhcnJheScpOwogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSUJFLCB0b3BpY3MpOwogICAgfTsKIAogICAgdGhpcy5vbk1lc3NhZ2UgPSBmdW5jdGlvbiAodG9waWNOYW1lLCBjYikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWNOYW1lLCAndG9waWNOYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBpZiAoY2FsbGJhY2tzLnRvcGljLmhhcyh0b3BpY05hbWUpKSB7CiAgICAgICAgY2FsbGJhY2tzLnRvcGljLmdldCh0b3BpY05hbWUpLmFkZChjYik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLnRvcGljLnNldCh0b3BpY05hbWUsIG5ldyBTZXQoW2NiXSkpOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy50b3BpYy5nZXQodG9waWNOYW1lKS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vbkFsbE1lc3NhZ2UgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5hbGxNZXNzYWdlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5hbGxNZXNzYWdlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgQWdlbnREYXRhUHJvdmlkZXIgPSBmdW5jdGlvbiAoYnVzKSB7CiAgICB2YXIgYWdlbnREYXRhID0gbnVsbDsKICAgIHRoaXMuYnVzID0gYnVzOwogICAgdGhpcy5idXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLCBjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMudXBkYXRlQWdlbnREYXRhKSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS51cGRhdGVBZ2VudERhdGEgPSBmdW5jdGlvbiAoYWdlbnREYXRhKSB7CiAgICB2YXIgb2xkQWdlbnREYXRhID0gdGhpcy5hZ2VudERhdGE7CiAgICB0aGlzLmFnZW50RGF0YSA9IGFnZW50RGF0YTsKIAogICAgaWYgKG9sZEFnZW50RGF0YSA9PSBudWxsKSB7CiAgICAgIGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuSU5JVCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAKICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5SRUZSRVNILCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKIAogICAgdGhpcy5fZmlyZUFnZW50VXBkYXRlRXZlbnRzKG9sZEFnZW50RGF0YSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRBZ2VudERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5hZ2VudERhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdObyBhZ2VudCBkYXRhIGlzIGF2YWlsYWJsZSB5ZXQhJyk7CiAgICB9CiAKICAgIHJldHVybiB0aGlzLmFnZW50RGF0YTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldENvbnRhY3REYXRhID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdmFyIGFnZW50RGF0YSA9IHRoaXMuZ2V0QWdlbnREYXRhKCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmZpbmQoYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY3RkYXRhKSB7CiAgICAgIHJldHVybiBjdGRhdGEuY29udGFjdElkID09PSBjb250YWN0SWQ7CiAgICB9KTsKIAogICAgaWYgKGNvbnRhY3REYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignQ29udGFjdCAlcyBubyBsb25nZXIgZXhpc3RzLicsIGNvbnRhY3RJZCk7CiAgICB9CiAKICAgIHJldHVybiBjb250YWN0RGF0YTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldENvbm5lY3Rpb25EYXRhID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICB2YXIgY29udGFjdERhdGEgPSB0aGlzLmdldENvbnRhY3REYXRhKGNvbnRhY3RJZCk7CiAgICB2YXIgY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0LmZpbmQoY29udGFjdERhdGEuY29ubmVjdGlvbnMsIGZ1bmN0aW9uIChjZGF0YSkgewogICAgICByZXR1cm4gY2RhdGEuY29ubmVjdGlvbklkID09PSBjb25uZWN0aW9uSWQ7CiAgICB9KTsKIAogICAgaWYgKGNvbm5lY3Rpb25EYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignQ29ubmVjdGlvbiAlcyBmb3IgY29udGFjdCAlcyBubyBsb25nZXIgZXhpc3RzLicsIGNvbm5lY3Rpb25JZCwgY29udGFjdElkKTsKICAgIH0KIAogICAgcmV0dXJuIGNvbm5lY3Rpb25EYXRhOwogIH07CgogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRJbnN0YW5jZUlkID0gZnVuY3Rpb24oKXsKICAgIHJldHVybiB0aGlzLmdldEFnZW50RGF0YSgpLmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZC5tYXRjaCgvaW5zdGFuY2VcLyhbMC05YS1mQS1GfC1dKylcLy8pWzFdOwogIH0KCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEFXU0FjY291bnRJZCA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gdGhpcy5nZXRBZ2VudERhdGEoKS5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQubWF0Y2goLzooWzAtOV0rKTppbnN0YW5jZS8pWzFdOwogIH0KIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZGlmZkNvbnRhY3RzID0gZnVuY3Rpb24gKG9sZEFnZW50RGF0YSkgewogICAgdmFyIGRpZmYgPSB7CiAgICAgIGFkZGVkOiB7fSwKICAgICAgcmVtb3ZlZDoge30sCiAgICAgIGNvbW1vbjoge30sCiAgICAgIG9sZE1hcDogY29ubmVjdC5pbmRleChvbGRBZ2VudERhdGEgPT0gbnVsbCA/IFtdIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pLAogICAgICBuZXdNYXA6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSkKICAgIH07CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLm9sZE1hcCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKGRpZmYubmV3TWFwLCBjb250YWN0SWQpKSB7CiAgICAgICAgZGlmZi5jb21tb25bY29udGFjdElkXSA9IGRpZmYubmV3TWFwW2NvbnRhY3RJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlmZi5yZW1vdmVkW2NvbnRhY3RJZF0gPSBkaWZmLm9sZE1hcFtjb250YWN0SWRdOwogICAgICB9CiAgICB9KTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYubmV3TWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgaWYgKCFjb25uZWN0LmNvbnRhaW5zKGRpZmYub2xkTWFwLCBjb250YWN0SWQpKSB7CiAgICAgICAgZGlmZi5hZGRlZFtjb250YWN0SWRdID0gZGlmZi5uZXdNYXBbY29udGFjdElkXTsKICAgICAgfQogICAgfSk7CiAKICAgIHJldHVybiBkaWZmOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2ZpcmVBZ2VudFVwZGF0ZUV2ZW50cyA9IGZ1bmN0aW9uIChvbGRBZ2VudERhdGEpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBkaWZmID0gbnVsbDsKICAgIHZhciBvbGRBZ2VudFN0YXRlID0gb2xkQWdlbnREYXRhID09IG51bGwgPyBjb25uZWN0LkFnZW50QXZhaWxTdGF0ZXMuSU5JVCA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS5uYW1lOwogICAgdmFyIG5ld0FnZW50U3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS5uYW1lOwogICAgdmFyIG9sZFJvdXRpbmdTdGF0ZSA9IG9sZEFnZW50RGF0YSA9PSBudWxsID8gY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5JTklUIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLnR5cGU7CiAgICB2YXIgbmV3Um91dGluZ1N0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3Quc3RhdGUudHlwZTsKIAogICAgaWYgKG9sZFJvdXRpbmdTdGF0ZSAhPT0gbmV3Um91dGluZ1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRBZ2VudFJvdXRpbmdFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZFJvdXRpbmdTdGF0ZSwgbmV3Um91dGluZ1N0YXRlKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoZXZlbnQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgICB9KTsKICAgIH0KIAogICAgaWYgKG9sZEFnZW50U3RhdGUgIT09IG5ld0FnZW50U3RhdGUpIHsKICAgICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLlNUQVRFX0NIQU5HRSwgewogICAgICAgIGFnZW50OiBuZXcgY29ubmVjdC5BZ2VudCgpLAogICAgICAgIG9sZFN0YXRlOiBvbGRBZ2VudFN0YXRlLAogICAgICAgIG5ld1N0YXRlOiBuZXdBZ2VudFN0YXRlCiAKICAgICAgfSk7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRBZ2VudFN0YXRlRXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRBZ2VudFN0YXRlLCBuZXdBZ2VudFN0YXRlKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoZXZlbnQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgICB9KTsKICAgIH0KCiAgICB2YXIgb2xkTmV4dFN0YXRlID0gb2xkQWdlbnREYXRhICYmIG9sZEFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUgPyBvbGRBZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlLm5hbWUgOiBudWxsOwogICAgdmFyIG5ld05leHRTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZSA/IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZS5uYW1lIDogbnVsbDsKICAgIGlmIChvbGROZXh0U3RhdGUgIT09IG5ld05leHRTdGF0ZSAmJiBuZXdOZXh0U3RhdGUpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLkVOUVVFVUVEX05FWFRfU1RBVEUsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgfQoKICAgIGlmIChvbGRBZ2VudERhdGEgIT09IG51bGwpIHsKICAgICAgZGlmZiA9IHRoaXMuX2RpZmZDb250YWN0cyhvbGRBZ2VudERhdGEpOwogCiAgICB9IGVsc2UgewogICAgICBkaWZmID0gewogICAgICAgIGFkZGVkOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pLAogICAgICAgIHJlbW92ZWQ6IHt9LAogICAgICAgIGNvbW1vbjoge30sCiAgICAgICAgb2xkTWFwOiB7fSwKICAgICAgICBuZXdNYXA6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSkKICAgICAgfTsKICAgIH0KIAogICAgY29ubmVjdC52YWx1ZXMoZGlmZi5hZGRlZCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5JVCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpKTsKICAgICAgc2VsZi5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMoY29udGFjdERhdGEuY29udGFjdElkLCBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5JVCwgY29udGFjdERhdGEuc3RhdGUudHlwZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC52YWx1ZXMoZGlmZi5yZW1vdmVkKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQsIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdChjb250YWN0RGF0YSkpOwogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdChjb250YWN0RGF0YSkpOwogICAgICBzZWxmLl91bnN1YkFsbENvbnRhY3RFdmVudHNGb3JDb250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB9KTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYuY29tbW9uKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgc2VsZi5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMoY29udGFjdElkLCBkaWZmLm9sZE1hcFtjb250YWN0SWRdLnN0YXRlLnR5cGUsIGRpZmYubmV3TWFwW2NvbnRhY3RJZF0uc3RhdGUudHlwZSk7CiAgICB9KTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyA9IGZ1bmN0aW9uIChjb250YWN0SWQsIG9sZENvbnRhY3RTdGF0ZSwgbmV3Q29udGFjdFN0YXRlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAob2xkQ29udGFjdFN0YXRlICE9PSBuZXdDb250YWN0U3RhdGUpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZENvbnRhY3RTdGF0ZSwgbmV3Q29udGFjdFN0YXRlKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoZXZlbnQsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudCwgY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgICAgfSk7CiAgICB9CgogICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gsIGNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fdW5zdWJBbGxDb250YWN0RXZlbnRzRm9yQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdEV2ZW50cykuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICAgIHNlbGYuYnVzLmdldFN1YnNjcmlwdGlvbnMoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnROYW1lLCBjb250YWN0SWQpKQogICAgICAgIC5tYXAoZnVuY3Rpb24gKHN1YikgeyBzdWIudW5zdWJzY3JpYmUoKTsgfSk7CiAgICB9KTsKICB9OwogCiAgLyoqIC0tLS0tIG1pbmltYWwgdmlldyBsYXllciBldmVudCBoYW5kbGluZyAqKi8KIAogIGNvbm5lY3QuY29yZS5vblZpZXdDb250YWN0ID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db250YWN0RXZlbnRzLlZJRVcsIGYpOwogIH07CiAKICAvKioKICAgKiBVc2VkIG9mIGFnZW50IGludGVyZmFjZSBjb250cm9sLiAKICAgKiBjb25uZWN0LmNvcmUudmlld0NvbnRhY3QoImNvbnRhY3RJZCIpIC0+ICB0aGlzIGlzIGN1cmVudGx5IHByb2dyYW1tZWQgdG8gZ2V0IHRoZSBjb250YWN0IGludG8gdmlldy4KICAgKi8KICBjb25uZWN0LmNvcmUudmlld0NvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgZGF0YTogewogICAgICAgIGNvbnRhY3RJZDogY29udGFjdElkCiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKiAtLS0tLSBtaW5pbWFsIHZpZXcgbGF5ZXIgZXZlbnQgaGFuZGxpbmcgKiovCiAKICBjb25uZWN0LmNvcmUub25BY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNoYW5uZWxWaWV3RXZlbnRzLkFDVElWQVRFX0NIQU5ORUxfV0lUSF9WSUVXX1RZUEUsIGYpOwogIH07CiAKICAvKioKICAgKiBVc2VkIG9mIGFnZW50IGludGVyZmFjZSBjb250cm9sLiAKICAgKiBjb25uZWN0LmNvcmUuYWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlKCkgLT4gIHRoaXMgaXMgY3VyZW50bHkgcHJvZ3JhbW1lZCB0byBnZXQgZWl0aGVyIHRoZSBudW1iZXIgcGFkLCBxdWljayBjb25uZWN0cywgb3IgY3JlYXRlIHRhc2sgaW50byB2aWV3LgogICAqIHRoZSB2YWxpZCBjb21iaW5hdGlvbnMgYXJlICgiY3JlYXRlX3Rhc2siLCAidGFzayIpLCAoIm51bWJlcl9wYWQiLCAic29mdHBob25lIiksICgiY3JlYXRlX3Rhc2siLCAic29mdHBob25lIiksICgicXVpY2tfY29ubmVjdHMiLCAic29mdHBob25lIikKICAgKiB0aGUgc29mdHBob25lIHdpdGggY3JlYXRlX3Rhc2sgY29tYm8gaXMgYSBzcGVjaWFsIGNhc2UgaW4gdGhlIGNoYW5uZWwgdmlldyB0byBhbGxvdyBhbGwgdGhyZWUgdmlldyB0eXBlIGJ1dHRvbnMgdG8gYXBwZWFyIG9uIHRoZSBzb2Z0cGhvbmUgc2NyZWVuCiAgICoKICAgKiBUaGUgJ3NvdXJjZScgaXMgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHdoaWNoIGluZGljYXRlcyB0aGUgcmVxdWVzdGVyLiBGb3IgZXhhbXBsZSwgaWYgaW52b2tlZCB3aXRoICgiY3JlYXRlX3Rhc2siLCAidGFzayIsICJhZ2VudGFwcCIpIHdlIHdvdWxkIGtub3cgYWdlbnRhcHAgcmVxdWVzdGVkIG9wZW4gdGFzayB2aWV3LgogICAqIAogICAqICJjYXNlSWQiIGlzIGFuIG9wdGlvbmFsIHBhcmFtZXRlciB3aGljaCBpcyBwYXNzZWQgd2hlbiBhIHRhc2sgaXMgY3JlYXRlZCBmcm9tIGEgS2VzeXRvbmUgY2FzZQogICAqLwogICBjb25uZWN0LmNvcmUuYWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlID0gZnVuY3Rpb24gKHZpZXdUeXBlLCBtZWRpYVR5cGUsIHNvdXJjZSwgY2FzZUlkKSB7CiAgICBjb25zdCBkYXRhID0geyB2aWV3VHlwZSwgbWVkaWFUeXBlIH07CiAgICBpZiAoc291cmNlKSB7CiAgICAgIGRhdGEuc291cmNlID0gc291cmNlOwogICAgfQogICAgaWYgKGNhc2VJZCkgewogICAgICBkYXRhLmNhc2VJZCA9IGNhc2VJZDsKICAgIH0KICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ2hhbm5lbFZpZXdFdmVudHMuQUNUSVZBVEVfQ0hBTk5FTF9XSVRIX1ZJRVdfVFlQRSwKICAgICAgZGF0YQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogVXNlZCB0byBwdWJsaXNoICd0YXNrIGNyZWF0ZWQnIGV2ZW50CiAgICovCiAgY29ubmVjdC5jb3JlLnRyaWdnZXJUYXNrQ3JlYXRlZCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS51cHN0cmVhbUJ1cy50cmlnZ2VyKGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVELCBkYXRhKTsKICB9OwoKICAvKiogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogCiAgLyoqCiAgKiBUaGlzIHdpbGwgYmUgaGVscGZ1bCBmb3IgdGhlIGN1c3RvbSBhbmQgZW1iZWRkZWQgQ0NQcyAKICAqIHRvIGhhbmRsZSB0aGUgYWNjZXNzIGRlbmllZCB1c2UgY2FzZS4gCiAgKi8KICBjb25uZWN0LmNvcmUub25BY2Nlc3NEZW5pZWQgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0NFU1NfREVOSUVELCBmKTsKICB9OwogCiAgLyoqCiAgKiBUaGlzIHdpbGwgYmUgaGVscGZ1bCBmb3IgU0FNTCB1c2UgY2FzZXMgdG8gaGFuZGxlIHRoZSBjdXN0b20gbG9naW5zLiAKICAqLwogIGNvbm5lY3QuY29yZS5vbkF1dGhGYWlsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBmKTsKICB9OwoKICBjb25uZWN0LmNvcmUub25BdXRob3JpemVTdWNjZXNzID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1NVQ0NFU1MsIGYpOwogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVTdWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICB3aW5kb3cuc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQsIDApOwogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRoRmFpbCA9IGZ1bmN0aW9uKGxvZ2luVXJsLCBhdXRob3JpemVFbmRwb2ludCwgYXV0aEZhaWxEYXRhKSB7CiAgICBpZiAoYXV0aEZhaWxEYXRhICYmIGF1dGhGYWlsRGF0YS5hdXRob3JpemUpIHsKICAgICAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVGYWlsKGxvZ2luVXJsKTsKICAgIH0KICAgIGVsc2UgewogICAgICBjb25uZWN0LmNvcmUuX2hhbmRsZUNUSUF1dGhGYWlsKGF1dGhvcml6ZUVuZHBvaW50KTsKICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplRmFpbCA9IGZ1bmN0aW9uKGxvZ2luVXJsKSB7CiAgICBsZXQgYXV0aFJldHJ5Q291bnQgPSBjb25uZWN0LmNvcmUuX2dldEF1dGhSZXRyeUNvdW50KCkKICAgIGlmICghY29ubmVjdC5jb3JlLmF1dGhvcml6ZVRpbWVvdXRJZCkgewogICAgICBpZiAoYXV0aFJldHJ5Q291bnQgPCBjb25uZWN0LmNvcmUuTUFYX0FVVEhPUklaRV9SRVRSWV9DT1VOVF9GT1JfU0VTU0lPTikgewogICAgICAgIGNvbm5lY3QuY29yZS5faW5jcmVtZW50QXV0aFJldHJ5Q291bnQoKTsKICAgICAgICBsZXQgcmV0cnlEZWxheSA9IEFXUy51dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkoYXV0aFJldHJ5Q291bnQgKyAxIHx8IDAsIHsgYmFzZTogMjAwMCB9KTsKICAgICAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBjb25uZWN0LmNvcmUuX3JlZGlyZWN0VG9Mb2dpbihsb2dpblVybCk7CiAgICAgICAgfSwgcmV0cnlEZWxheSk7IC8vV2UgZG9uJ3QgaGF2ZSB0byBjbGVhciB0aGUgdGltZW91dElkIGJlY2F1c2Ugd2UgYXJlIHJlZGlyZWN0aW5nIGF3YXkgZnJvbSB0aGlzIG9yaWdpbiBvbmNlIHRoZSB0aW1lb3V0IGNvbXBsZXRlcy4KICAgICAgfQogICAgICBlbHNlICB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJXZSBoYXZlIGV4aGF1c3RlZCBvdXIgYXV0aG9yaXphdGlvbiByZXRyaWVzIGR1ZSB0byA0MDFzIGZyb20gdGhlIGF1dGhvcml6ZSBhcGkuIE5vIG1vcmUgcmV0cmllcyB3aWxsIGJlIGF0dGVtcHRlZCBpbiB0aGlzIHNlc3Npb24gdW50aWwgdGhlIGF1dGhvcml6ZSBhcGkgcmV0dXJucyAyMDAuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCk7CiAgICAgIH0KICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5fcmVkaXJlY3RUb0xvZ2luID0gZnVuY3Rpb24obG9naW5VcmwpIHsKICAgIGlmICh0eXBlb2YobG9naW5VcmwpID09PSAnc3RyaW5nJykgewogICAgICBsb2NhdGlvbi5hc3NpZ24obG9naW5VcmwpOwogICAgfSBlbHNlIHsKICAgICAgbG9jYXRpb24ucmVsb2FkKCk7CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUNUSUF1dGhGYWlsID0gZnVuY3Rpb24oYXV0aG9yaXplRW5kcG9pbnQpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmN0aVRpbWVvdXRJZCkgewogICAgICBpZiAoY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50IDwgY29ubmVjdC5jb3JlLk1BWF9DVElfQVVUSF9SRVRSWV9DT1VOVCkgewogICAgICAgIGNvbm5lY3QuY29yZS5jdGlBdXRoUmV0cnlDb3VudCsrOwogICAgICAgIGxldCByZXRyeURlbGF5ID0gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgfHwgMCwgeyBiYXNlOiA1MDAgfSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmN0aVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZShhdXRob3JpemVFbmRwb2ludCkudGhlbihjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRob3JpemVTdWNjZXNzLmJpbmQoY29ubmVjdC5jb3JlKSkuY2F0Y2goY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aEZhaWwuYmluZChjb25uZWN0LmNvcmUsIHthdXRob3JpemU6IHRydWV9KSk7CiAgICAgICAgICBjb25uZWN0LmNvcmUuY3RpVGltZW91dElkID0gbnVsbDsKICAgICAgICB9LCByZXRyeURlbGF5KTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGhhdmUgZXhoYXVzdGVkIG91ciBhdXRob3JpemF0aW9uIHJldHJpZXMgZHVlIHRvIDQwMXMgZnJvbSB0aGUgQ1RJIHNlcnZpY2UuIE5vIG1vcmUgcmV0cmllcyB3aWxsIGJlIGF0dGVtcHRlZCB1bnRpbCB0aGUgcGFnZSBpcyByZWZyZXNoZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkNUSV9BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQpOwogICAgICB9CiAgICB9CiAgfQoKICBjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRob3JpemVTdWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS51cHN0cmVhbUJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhPUklaRV9TVUNDRVNTKTsKICB9CgogIGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhGYWlsID0gZnVuY3Rpb24oZGF0YSkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkudXBzdHJlYW1CdXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGRhdGEpOwogIH0KCiAgY29ubmVjdC5jb3JlLl9nZXRBdXRoUmV0cnlDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgbGV0IGl0ZW0gPSB3aW5kb3cuc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShjb25uZWN0LlNlc3Npb25TdG9yYWdlS2V5cy5BVVRIT1JJWkVfUkVUUllfQ09VTlQpOwogICAgaWYgKGl0ZW0gIT09IG51bGwpIHsKICAgICAgaWYgKCFpc05hTihwYXJzZUludChpdGVtKSkpIHsKICAgICAgICByZXR1cm4gcGFyc2VJbnQoaXRlbSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcigiVGhlIHNlc3Npb24gc3RvcmFnZSB2YWx1ZSBmb3IgYXV0aCByZXRyeSBjb3VudCB3YXMgTmFOIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCwgMCk7CiAgICAgIHJldHVybiAwOwogICAgfSAKICB9CgogIGNvbm5lY3QuY29yZS5faW5jcmVtZW50QXV0aFJldHJ5Q291bnQgPSBmdW5jdGlvbigpIHsKICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCwgKGNvbm5lY3QuY29yZS5fZ2V0QXV0aFJldHJ5Q291bnQoKSsxKS50b1N0cmluZygpKTsKICB9CgogIGNvbm5lY3QuY29yZS5vbkF1dGhvcml6ZVJldHJpZXNFeGhhdXN0ZWQgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVELCBmKTsKICB9CgogIGNvbm5lY3QuY29yZS5vbkNUSUF1dGhvcml6ZVJldHJpZXNFeGhhdXN0ZWQgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ1RJX0FVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCwgZik7CiAgfQogCiAgLyoqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KIAogIC8qKgogICAqIFVzZWQgZm9yIGhhbmRsaW5nIHRoZSBydGMgc2Vzc2lvbiBzdGF0cy4KICAgKiBVc2FnZQogICAqIGNvbm5lY3QuY29yZS5vblNvZnRwaG9uZVNlc3Npb25Jbml0KGZ1bmN0aW9uKHsgY29ubmVjdGlvbklkIH0pIHsKICAgKiAgICAgdmFyIHNvZnRwaG9uZU1hbmFnZXIgPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlcigpOwogICAqICAgICBpZihzb2Z0cGhvbmVNYW5hZ2VyKXsKICAgKiAgICAgICAgLy8gYWNjZXNzIHNlc3Npb24KICAgKiAgICAgICAgdmFyIHNlc3Npb24gPSBzb2Z0cGhvbmVNYW5hZ2VyLmdldFNlc3Npb24oY29ubmVjdGlvbklkKTsgCiAgICogICAgICB9CiAgICogfSk7CiAgICovCiAKICBjb25uZWN0LmNvcmUub25Tb2Z0cGhvbmVTZXNzaW9uSW5pdCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5TRVNTSU9OX0lOSVQsIGYpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLm9uQ29uZmlndXJlID0gZnVuY3Rpb24oZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuQ09ORklHVVJFLCBmKTsKICB9CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgIGNvbm5lY3QuY29yZS5vbkluaXRpYWxpemVkID0gZnVuY3Rpb24oZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5JTklULCBmKTsKICB9CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbnRhY3RJZCwgJ2NvbnRhY3RJZCcpOwogICAgaWYgKCFjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdEV2ZW50cyksIGV2ZW50TmFtZSkpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuVmFsdWVFcnJvcignJXMgaXMgbm90IGEgdmFsaWQgY29udGFjdCBldmVudC4nLCBldmVudE5hbWUpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZignJXM6OiVzJywgZXZlbnROYW1lLCBjb250YWN0SWQpOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ldmVudEJ1czsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlcjsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXI7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0TG9jYWxUaW1lc3RhbXAgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0QWdlbnREYXRhKCkuc25hcHNob3QubG9jYWxUaW1lc3RhbXA7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0U2tldyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKS5zbmFwc2hvdC5za2V3OwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50Um91dGluZ0V2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50Um91dGluZ0V2ZW50R3JhcGg7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRSb3V0aW5nRXZlbnRHcmFwaCA9IG5ldyBjb25uZWN0LkV2ZW50R3JhcGgoKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuUk9VVEFCTEUpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5OT1RfUk9VVEFCTEUsCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUuT0ZGTElORSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRTdGF0ZUV2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoOwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50U3RhdGVFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzKSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5FUlJPUikKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50QXZhaWxTdGF0ZXMuQUZURVJfQ0FMTF9XT1JLLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLkFDVyk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudEdyYXBoID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5jb250YWN0RXZlbnRHcmFwaDsKICB9OwogCiAgY29ubmVjdC5jb3JlLmNvbnRhY3RFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5DT01JTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLlBFTkRJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5QRU5ESU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVElORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKQogICAgLmFzc29jKGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNUSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLklOQ09NSU5HLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVOREVELAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKQogICAgLmFzc29jKGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTKSwKICAgICAgY29ubmVjdC52YWx1ZXMoY29ubmVjdC5yZWxhdGl2ZUNvbXBsZW1lbnQoY29ubmVjdC5DT05UQUNUX0FDVElWRV9TVEFURVMsIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSkpLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRU5ERUQpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkVSUk9SLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuRVJST1IpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5NSVNTRUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldENsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBjb3JlIGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUuY2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG51bGw7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRBcHBDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBBZ2VudEFwcCBDbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFRhc2tUZW1wbGF0ZXNDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IFRhc2tUZW1wbGF0ZXMgQ2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUudGFza1RlbXBsYXRlc0NsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50ID0gbnVsbDsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRNYXN0ZXJDbGllbnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgbWFzdGVyIGNsaWVudCBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudDsKICB9OwogIGNvbm5lY3QuY29yZS5tYXN0ZXJDbGllbnQgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXROb3RpZmljYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlcikgewogICAgICBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlciA9IG5ldyBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIoKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUubm90aWZpY2F0aW9uTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5wb3B1cE1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUucG9wdXBNYW5hZ2VyID0gbmV3IGNvbm5lY3QuUG9wdXBNYW5hZ2VyKCk7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUudXBzdHJlYW0pIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlcmUgaXMgbm8gdXBzdHJlYW0gY29uZHVpdCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUudXBzdHJlYW07CiAgfTsKICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5BZ2VudERhdGFQcm92aWRlciA9IEFnZW50RGF0YVByb3ZpZGVyOwogCn0pKCk7CgovKioqLyB9KSwKCi8qKiovIDU5MjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgdmFyIEFMTF9FVkVOVFMgPSAnPDxhbGw+Pic7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gRXZlbnRUeXBlCiAgICovCiAgdmFyIEV2ZW50VHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2Fja25vd2xlZGdlJywKICAgICdhY2tfdGltZW91dCcsCiAgICAnaW5pdCcsCiAgICAnYXBpX3JlcXVlc3QnLAogICAgJ2FwaV9yZXNwb25zZScsCiAgICAnYXV0aF9mYWlsJywKICAgICdhY2Nlc3NfZGVuaWVkJywKICAgICdjbG9zZScsCiAgICAnY29uZmlndXJlJywKICAgICdsb2cnLAogICAgJ21hc3Rlcl9yZXF1ZXN0JywKICAgICdtYXN0ZXJfcmVzcG9uc2UnLAogICAgJ3N5bmNocm9uaXplJywKICAgICd0ZXJtaW5hdGUnLAogICAgJ3Rlcm1pbmF0ZWQnLAogICAgJ3NlbmRfbG9ncycsCiAgICAncmVsb2FkX2FnZW50X2NvbmZpZ3VyYXRpb24nLAogICAgJ2Jyb2FkY2FzdCcsCiAgICAnYXBpX21ldHJpYycsCiAgICAnY2xpZW50X21ldHJpYycsCiAgICAnc29mdHBob25lX3N0YXRzJywKICAgICdzb2Z0cGhvbmVfcmVwb3J0JywKICAgICdjbGllbnRfc2lkZV9sb2dzJywKICAgICdzZXJ2ZXJfYm91bmRfaW50ZXJuYWxfbG9nJywKICAgICdtdXRlJywKICAgICJpZnJhbWVfc3R5bGUiLAogICAgImlmcmFtZV9yZXRyaWVzX2V4aGF1c3RlZCIsCiAgICAidXBkYXRlX2Nvbm5lY3RlZF9jY3BzIiwKICAgICJvdXRlcl9jb250ZXh0X2luZm8iLAogICAgIm1lZGlhX2RldmljZV9yZXF1ZXN0IiwKICAgICJtZWRpYV9kZXZpY2VfcmVzcG9uc2UiLAogICAgInRhYl9pZCIsCiAgICAnYXV0aG9yaXplX3N1Y2Nlc3MnLAogICAgJ2F1dGhvcml6ZV9yZXRyaWVzX2V4aGF1c3RlZCcsCiAgICAnY3RpX2F1dGhvcml6ZV9yZXRyaWVzX2V4aGF1c3RlZCcsCiAgICAnY2xpY2tfc3RyZWFtX2RhdGEnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gTWFzdGVyVG9waWNzCiAgICovCiAgdmFyIE1hc3RlclRvcGljcyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25uZWN0JywgWwogICAgJ2xvZ2luUG9wdXAnLAogICAgJ3NlbmRMb2dzJywKICAgICdzb2Z0cGhvbmUnLAogICAgJ3Jpbmd0b25lJywKICAgICdtZXRyaWNzJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFnZW50RXZlbnRzCiAgICovCiAgdmFyIEFnZW50RXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2FnZW50JywgWwogICAgJ2luaXQnLAogICAgJ3VwZGF0ZScsCiAgICAncmVmcmVzaCcsCiAgICAncm91dGFibGUnLAogICAgJ25vdF9yb3V0YWJsZScsCiAgICAncGVuZGluZycsCiAgICAnY29udGFjdF9wZW5kaW5nJywKICAgICdvZmZsaW5lJywKICAgICdlcnJvcicsCiAgICAnc29mdHBob25lX2Vycm9yJywKICAgICd3ZWJzb2NrZXRfY29ubmVjdGlvbl9sb3N0JywKICAgICd3ZWJzb2NrZXRfY29ubmVjdGlvbl9nYWluZWQnLAogICAgJ3N0YXRlX2NoYW5nZScsCiAgICAnYWN3JywKICAgICdtdXRlX3RvZ2dsZScsCiAgICAnbG9jYWxfbWVkaWFfc3RyZWFtX2NyZWF0ZWQnLAogICAgJ2VucXVldWVkX25leHRfc3RhdGUnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBXZWJTb2NrZXRFdmVudHMKICAqLwogIHZhciBXZWJTb2NrZXRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnd2ViU29ja2V0JywgWwogICAgJ2luaXRfZmFpbHVyZScsCiAgICAnY29ubmVjdGlvbl9vcGVuJywKICAgICdjb25uZWN0aW9uX2Nsb3NlJywKICAgICdjb25uZWN0aW9uX2Vycm9yJywKICAgICdjb25uZWN0aW9uX2dhaW4nLAogICAgJ2Nvbm5lY3Rpb25fbG9zdCcsCiAgICAnc3Vic2NyaXB0aW9uX3VwZGF0ZScsCiAgICAnc3Vic2NyaXB0aW9uX2ZhaWx1cmUnLAogICAgJ2FsbF9tZXNzYWdlJywKICAgICdzZW5kJywKICAgICdzdWJzY3JpYmUnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBlbnVtIENvbnRhY3RFdmVudHMKICAgICovCiAgdmFyIENvbnRhY3RFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29udGFjdCcsIFsKICAgICdpbml0JywKICAgICdyZWZyZXNoJywKICAgICdkZXN0cm95ZWQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnYWN3JywKICAgICd2aWV3JywKICAgICdlbmRlZCcsCiAgICAnZXJyb3InLAogICAgJ2FjY2VwdGVkJwogIF0pOwoKICB2YXIgQ2hhbm5lbFZpZXdFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgndGFza0xpc3QnLCBbCiAgICAnYWN0aXZhdGVfY2hhbm5lbF93aXRoX3ZpZXdfdHlwZScKICBdKTsKICAKICB2YXIgVGFza0V2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd0YXNrJywgWwogICAgICAnY3JlYXRlZCcKICBdKTsKCgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBDb25uZWN0aW9uRXZlbnRzCiAgKi8KICB2YXIgQ29ubmVjdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25uZWN0aW9uJywgWwogICAgJ3Nlc3Npb25faW5pdCcsCiAgICAncmVhZHlfdG9fc3RhcnRfc2Vzc2lvbicKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb25maWd1cmF0aW9uIEV2ZW50cwogICAqLwogIHZhciBDb25maWd1cmF0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2NvbmZpZ3VyYXRpb24nLCBbCiAgICAnY29uZmlndXJlJywKICAgICdzZXRfc3BlYWtlcl9kZXZpY2UnLAogICAgJ3NldF9taWNyb3Bob25lX2RldmljZScsCiAgICAnc2V0X3Jpbmdlcl9kZXZpY2UnLAogICAgJ3NwZWFrZXJfZGV2aWNlX2NoYW5nZWQnLAogICAgJ21pY3JvcGhvbmVfZGV2aWNlX2NoYW5nZWQnLAogICAgJ3Jpbmdlcl9kZXZpY2VfY2hhbmdlZCcKICBdKTsKCiAgdmFyIERpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnZGlzYXN0ZXJSZWNvdmVyeScsIFsKICAgICdzdXBwcmVzcycsCiAgICAnZm9yY2Vfb2ZmbGluZScsIC8vIGxldHRpbmcgdGhlIHNoYXJlZHdvcmtlciBrbm93IHRvIGZvcmNlIG9mZmxpbmUgCiAgICAnc2V0X29mZmxpbmUnLCAvLyBpZnJhbWUgbGV0dGluZyB0aGUgbmF0aXZlIGNjcCB0byBzZXQgb2ZmbGluZQogICAgJ2luaXRfZGlzYXN0ZXJfcmVjb3ZlcnknLAogICAgJ2ZhaWxvdmVyJyAvLyB1c2VkIHRvIHByb3BhZ2F0ZSBmYWlsb3ZlciBzdGF0ZSB0byBvdGhlciB3aW5kb3dzCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29uZmlndXJhdGlvbiBFdmVudHMKICAgKi8KICB2YXIgQ29uZmlndXJhdGlvbkV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb25maWd1cmF0aW9uJywgWwogICAgJ2NvbmZpZ3VyZScsCiAgICAnc2V0X3NwZWFrZXJfZGV2aWNlJywKICAgICdzZXRfbWljcm9waG9uZV9kZXZpY2UnLAogICAgJ3NldF9yaW5nZXJfZGV2aWNlJywKICAgICdzcGVha2VyX2RldmljZV9jaGFuZ2VkJywKICAgICdtaWNyb3Bob25lX2RldmljZV9jaGFuZ2VkJywKICAgICdyaW5nZXJfZGV2aWNlX2NoYW5nZWQnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gVm9pY2VJZCBFdmVudHMKICAgKi8KICAgdmFyIFZvaWNlSWRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgndm9pY2VJZCcsIFsKICAgICd1cGRhdGVfZG9tYWluX2lkJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBFdmVudEZhY3RvcnkKICAgKi8KICB2YXIgRXZlbnRGYWN0b3J5ID0gZnVuY3Rpb24gKCkgeyB9OwogIEV2ZW50RmFjdG9yeS5jcmVhdGVSZXF1ZXN0ID0gZnVuY3Rpb24gKHR5cGUsIG1ldGhvZCwgcGFyYW1zKSB7CiAgICByZXR1cm4gewogICAgICBldmVudDogdHlwZSwKICAgICAgcmVxdWVzdElkOiBjb25uZWN0LnJhbmRvbUlkKCksCiAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICBwYXJhbXM6IHBhcmFtcwogICAgfTsKICB9OwoKICBFdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UgPSBmdW5jdGlvbiAodHlwZSwgcmVxdWVzdCwgZGF0YSwgZXJyKSB7CiAgICByZXR1cm4gewogICAgICBldmVudDogdHlwZSwKICAgICAgcmVxdWVzdElkOiByZXF1ZXN0LnJlcXVlc3RJZCwKICAgICAgZGF0YTogZGF0YSwKICAgICAgZXJyOiBlcnIgfHwgbnVsbAogICAgfTsKICB9OwoKICAvKioKICAgKiBBbiBvYmplY3QgcmVwcmVzZW50aW5nIGFuIGV2ZW50IHN1YnNjcmlwdGlvbiBpbiBhbiBFdmVudEJ1cy4KICAgKi8KICB2YXIgU3Vic2NyaXB0aW9uID0gZnVuY3Rpb24gKHN1Yk1hcCwgZXZlbnROYW1lLCBmKSB7CiAgICB0aGlzLnN1Yk1hcCA9IHN1Yk1hcDsKICAgIHRoaXMuaWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CiAgICB0aGlzLmV2ZW50TmFtZSA9IGV2ZW50TmFtZTsKICAgIHRoaXMuZiA9IGY7CiAgfTsKCiAgLyoqCiAgICogVW5zdWJzY3JpYmUgdGhlIGhhbmRsZXIgb2YgdGhpcyBzdWJzY3JpcHRpb24gZnJvbSB0aGUgRXZlbnRCdXMKICAgKiBmcm9tIHdoaWNoIGl0IHdhcyBjcmVhdGVkLgogICAqLwogIFN1YnNjcmlwdGlvbi5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1Yk1hcC51bnN1YnNjcmliZSh0aGlzLmV2ZW50TmFtZSwgdGhpcy5pZCk7CiAgfTsKCiAgLyoqCiAgICogQSBtYXAgb2YgZXZlbnQgc3Vic2NyaXB0aW9ucywgdXNlZCBieSB0aGUgRXZlbnRCdXMuCiAgICovCiAgdmFyIFN1YnNjcmlwdGlvbk1hcCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViSWRNYXAgPSB7fTsKICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwID0ge307CiAgfTsKCiAgLyoqCiAgICogQWRkIGEgc3Vic2NyaXB0aW9uIGZvciB0aGUgbmFtZWQgZXZlbnQuICBDcmVhdGVzIGEgbmV3IFN1YnNjcmlwdGlvbgogICAqIG9iamVjdCBhbmQgcmV0dXJucyBpdC4gIFRoaXMgb2JqZWN0IGNhbiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZikgewogICAgdmFyIHN1YiA9IG5ldyBTdWJzY3JpcHRpb24odGhpcywgZXZlbnROYW1lLCBmKTsKCiAgICB0aGlzLnN1YklkTWFwW3N1Yi5pZF0gPSBzdWI7CiAgICB2YXIgc3ViTGlzdCA9IHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gfHwgW107CiAgICBzdWJMaXN0LnB1c2goc3ViKTsKICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gPSBzdWJMaXN0OwogICAgcmV0dXJuIHN1YjsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSBhIHN1YnNjcmlwdGlvbiBtYXRjaGluZyB0aGUgZ2l2ZW4gZXZlbnQgbmFtZSBhbmQgaWQuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIHN1YklkKSB7CiAgICBpZiAoY29ubmVjdC5jb250YWlucyh0aGlzLnN1YkV2ZW50TmFtZU1hcCwgZXZlbnROYW1lKSkgewogICAgICB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdID0gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXS5maWx0ZXIoZnVuY3Rpb24gKHMpIHsgcmV0dXJuIHMuaWQgIT09IHN1YklkOyB9KTsKCiAgICAgIGlmICh0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdLmxlbmd0aCA8IDEpIHsKICAgICAgICBkZWxldGUgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXTsKICAgICAgfQogICAgfQoKICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKHRoaXMuc3ViSWRNYXAsIHN1YklkKSkgewogICAgICBkZWxldGUgdGhpcy5zdWJJZE1hcFtzdWJJZF07CiAgICB9CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBhbGwgc3Vic2NyaXB0aW9ucyBpbiB0aGUgc3Vic2NyaXB0aW9uIG1hcC4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLmdldEFsbFN1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC52YWx1ZXModGhpcy5zdWJFdmVudE5hbWVNYXApLnJlZHVjZShmdW5jdGlvbiAoYSwgYikgewogICAgICByZXR1cm4gYS5jb25jYXQoYik7CiAgICB9LCBbXSk7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBzdWJzY3JpcHRpb25zIGZvciB0aGUgZ2l2ZW4gZXZlbnQgbmFtZSwgb3IgYW4gZW1wdHkKICAgKiBsaXN0IGlmIHRoZXJlIGFyZSBubyBzdWJzY3JpcHRpb25zLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuZ2V0U3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdIHx8IFtdOwogIH07CgogIC8qKgogICAqIEFuIG9iamVjdCB3aGljaCBtYWludGFpbnMgYSBtYXAgb2Ygc3Vic2NyaXB0aW9ucyBhbmQgc2VydmVzIGFzIHRoZQogICAqIG1lY2hhbmlzbSBmb3IgdHJpZ2dlcmluZyBldmVudHMgdG8gYmUgaGFuZGxlZCBieSBzdWJzY3JpYmVycy4KICAgKi8KICB2YXIgRXZlbnRCdXMgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKCiAgICB0aGlzLnN1Yk1hcCA9IG5ldyBTdWJzY3JpcHRpb25NYXAoKTsKICAgIHRoaXMubG9nRXZlbnRzID0gcGFyYW1zLmxvZ0V2ZW50cyB8fCBmYWxzZTsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmUgdG8gdGhlIG5hbWVkIGV2ZW50LiAgUmV0dXJucyBhIG5ldyBTdWJzY3JpcHRpb24gb2JqZWN0CiAgICogd2hpY2ggY2FuIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnN1YnNjcmliZSA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgfTsKCiAgLyoqCiAgICogU3Vic2NyaWJlIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uIGFsbCBldmVudHMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnN1YnNjcmliZUFsbCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgcmV0dXJuIHRoaXMuc3ViTWFwLnN1YnNjcmliZShBTExfRVZFTlRTLCBmKTsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHRoZSBnaXZlbiBldmVudCBuYW1lLCBvciBhbiBlbXB0eQogICAqIGxpc3QgaWYgdGhlcmUgYXJlIG5vIHN1YnNjcmlwdGlvbnMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLmdldFN1YnNjcmlwdGlvbnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuZ2V0U3Vic2NyaXB0aW9ucyhldmVudE5hbWUpOwogIH07CgogIC8qKgogICAqIFRyaWdnZXIgdGhlIGdpdmVuIGV2ZW50IHdpdGggdGhlIGdpdmVuIGRhdGEuICBBbGwgbWV0aG9kcyBzdWJzY3JpYmVkCiAgICogdG8gdGhpcyBldmVudCB3aWxsIGJlIGNhbGxlZCBhbmQgYXJlIHByb3ZpZGVkIHdpdGggdGhlIGdpdmVuIGFyYml0cmFyeQogICAqIGRhdGEgb2JqZWN0IGFuZCB0aGUgbmFtZSBvZiB0aGUgZXZlbnQsIGluIHRoYXQgb3JkZXIuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnRyaWdnZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgYWxsRXZlbnRTdWJzID0gdGhpcy5zdWJNYXAuZ2V0U3Vic2NyaXB0aW9ucyhBTExfRVZFTlRTKTsKICAgIHZhciBldmVudFN1YnMgPSB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKGV2ZW50TmFtZSk7CgogICAgaWYgKHRoaXMubG9nRXZlbnRzICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5MT0cgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuQVBJX01FVFJJQyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRwogICAgKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIlB1Ymxpc2hpbmcgZXZlbnQ6ICVzIiwgZXZlbnROYW1lKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQoKICAgIGlmICgKICAgICAgZXZlbnROYW1lLnN0YXJ0c1dpdGgoY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVEKSAmJgogICAgICBkYXRhICYmCiAgICAgIGRhdGEuY29udGFjdElkICYmCiAgICAgICEoZGF0YSBpbnN0YW5jZW9mIGNvbm5lY3QuQ29udGFjdCkKICAgICkgewogICAgICBkYXRhID0gbmV3IGNvbm5lY3QuQ29udGFjdChkYXRhLmNvbnRhY3RJZCk7CiAgICB9CgogICAgYWxsRXZlbnRTdWJzLmNvbmNhdChldmVudFN1YnMpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICB0cnkgewogICAgICAgIHN1Yi5mKGRhdGEgfHwgbnVsbCwgZXZlbnROYW1lLCBzZWxmKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIiclcycgZXZlbnQgaGFuZGxlciBmYWlsZWQuIiwgZXZlbnROYW1lKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIC8qKgogICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIGJyaWRnZXMgYW4gZXZlbnQgZnJvbSBhbm90aGVyIEV2ZW50QnVzIHRvIHRoaXMgYnVzLgogICAqCiAgICogVXNhZ2U6CiAgICogY29uZHVpdC5vblVwc3RyZWFtKCJNeUV2ZW50IiwgYnVzLmJyaWRnZSgpKTsKICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuYnJpZGdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhLCBldmVudCkgewogICAgICBzZWxmLnRyaWdnZXIoZXZlbnQsIGRhdGEpOwogICAgfTsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSBhbGwgZXZlbnRzIGluIHRoZSBldmVudCBidXMuCiAgICovCiAgRXZlbnRCdXMucHJvdG90eXBlLnVuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJNYXAuZ2V0QWxsU3Vic2NyaXB0aW9ucygpLmZvckVhY2goZnVuY3Rpb24gKHN1YikgewogICAgICBzdWIudW5zdWJzY3JpYmUoKTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuRXZlbnRCdXMgPSBFdmVudEJ1czsKICBjb25uZWN0LkV2ZW50RmFjdG9yeSA9IEV2ZW50RmFjdG9yeTsKICBjb25uZWN0LkV2ZW50VHlwZSA9IEV2ZW50VHlwZTsKICBjb25uZWN0LkFnZW50RXZlbnRzID0gQWdlbnRFdmVudHM7CiAgY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzID0gQ29uZmlndXJhdGlvbkV2ZW50czsKICBjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMgPSBDb25uZWN0aW9uRXZlbnRzOwogIGNvbm5lY3QuQ29ubm5lY3Rpb25FdmVudHMgPSBDb25uZWN0aW9uRXZlbnRzOyAvL2RlcHJlY2F0ZSBvbiBuZXh0IG1ham9yIHZlcnNpb24gcmVsZWFzZS4KICBjb25uZWN0LkNvbnRhY3RFdmVudHMgPSBDb250YWN0RXZlbnRzOwogIGNvbm5lY3QuQ2hhbm5lbFZpZXdFdmVudHMgPSBDaGFubmVsVmlld0V2ZW50czsKICBjb25uZWN0LlRhc2tFdmVudHMgPSBUYXNrRXZlbnRzOwogIGNvbm5lY3QuVm9pY2VJZEV2ZW50cyA9IFZvaWNlSWRFdmVudHM7CiAgY29ubmVjdC5XZWJTb2NrZXRFdmVudHMgPSBXZWJTb2NrZXRFdmVudHM7CiAgY29ubmVjdC5NYXN0ZXJUb3BpY3MgPSBNYXN0ZXJUb3BpY3M7CiAgY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzID0gRGlzYXN0ZXJSZWNvdmVyeUV2ZW50czsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDI4NjoKLyoqKi8gKCgpID0+IHsKCiFmdW5jdGlvbihlKXt2YXIgbj17fTtmdW5jdGlvbiB0KG8pe2lmKG5bb10pcmV0dXJuIG5bb10uZXhwb3J0czt2YXIgcj1uW29dPXtpOm8sbDohMSxleHBvcnRzOnt9fTtyZXR1cm4gZVtvXS5jYWxsKHIuZXhwb3J0cyxyLHIuZXhwb3J0cyx0KSxyLmw9ITAsci5leHBvcnRzfXQubT1lLHQuYz1uLHQuZD1mdW5jdGlvbihlLG4sbyl7dC5vKGUsbil8fE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG4se2VudW1lcmFibGU6ITAsZ2V0Om99KX0sdC5yPWZ1bmN0aW9uKGUpeyJ1bmRlZmluZWQiIT10eXBlb2YgU3ltYm9sJiZTeW1ib2wudG9TdHJpbmdUYWcmJk9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLFN5bWJvbC50b1N0cmluZ1RhZyx7dmFsdWU6Ik1vZHVsZSJ9KSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwiX19lc01vZHVsZSIse3ZhbHVlOiEwfSl9LHQudD1mdW5jdGlvbihlLG4pe2lmKDEmbiYmKGU9dChlKSksOCZuKXJldHVybiBlO2lmKDQmbiYmIm9iamVjdCI9PXR5cGVvZiBlJiZlJiZlLl9fZXNNb2R1bGUpcmV0dXJuIGU7dmFyIG89T2JqZWN0LmNyZWF0ZShudWxsKTtpZih0LnIobyksT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sImRlZmF1bHQiLHtlbnVtZXJhYmxlOiEwLHZhbHVlOmV9KSwyJm4mJiJzdHJpbmciIT10eXBlb2YgZSlmb3IodmFyIHIgaW4gZSl0LmQobyxyLGZ1bmN0aW9uKG4pe3JldHVybiBlW25dfS5iaW5kKG51bGwscikpO3JldHVybiBvfSx0Lm49ZnVuY3Rpb24oZSl7dmFyIG49ZSYmZS5fX2VzTW9kdWxlP2Z1bmN0aW9uKCl7cmV0dXJuIGUuZGVmYXVsdH06ZnVuY3Rpb24oKXtyZXR1cm4gZX07cmV0dXJuIHQuZChuLCJhIixuKSxufSx0Lm89ZnVuY3Rpb24oZSxuKXtyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGUsbil9LHQucD0iIix0KHQucz0yKX0oW2Z1bmN0aW9uKGUsbix0KXsidXNlIHN0cmljdCI7dmFyIG89dCgxKSxyPSJOVUxMIixpPSJDTElFTlRfTE9HR0VSIixjPSJERUJVRyIscz0yZTMsYT0iYXdzL3N1YnNjcmliZSIsdT0iYXdzL3Vuc3Vic2NyaWJlIixsPSJhd3MvaGVhcnRiZWF0IixmPSJjb25uZWN0ZWQiLHA9ImRpc2Nvbm5lY3RlZCI7ZnVuY3Rpb24gZChlKXtyZXR1cm4oZD0iZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiYic3ltYm9sIj09dHlwZW9mIFN5bWJvbC5pdGVyYXRvcj9mdW5jdGlvbihlKXtyZXR1cm4gdHlwZW9mIGV9OmZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiZlLmNvbnN0cnVjdG9yPT09U3ltYm9sJiZlIT09U3ltYm9sLnByb3RvdHlwZT8ic3ltYm9sIjp0eXBlb2YgZX0pKGUpfXZhciBiPXthc3NlcnRUcnVlOmZ1bmN0aW9uKGUsbil7aWYoIWUpdGhyb3cgbmV3IEVycm9yKG4pfSxhc3NlcnROb3ROdWxsOmZ1bmN0aW9uKGUsbil7cmV0dXJuIGIuYXNzZXJ0VHJ1ZShudWxsIT09ZSYmdm9pZCAwIT09ZChlKSxPYmplY3Qoby5zcHJpbnRmKSgiJXMgbXVzdCBiZSBwcm92aWRlZCIsbnx8IkEgdmFsdWUiKSksZX0saXNOb25FbXB0eVN0cmluZzpmdW5jdGlvbihlKXtyZXR1cm4ic3RyaW5nIj09dHlwZW9mIGUmJmUubGVuZ3RoPjB9LGFzc2VydElzTGlzdDpmdW5jdGlvbihlLG4pe2lmKCFBcnJheS5pc0FycmF5KGUpKXRocm93IG5ldyBFcnJvcihuKyIgaXMgbm90IGFuIGFycmF5Iil9LGlzRnVuY3Rpb246ZnVuY3Rpb24oZSl7cmV0dXJuISEoZSYmZS5jb25zdHJ1Y3RvciYmZS5jYWxsJiZlLmFwcGx5KX0saXNPYmplY3Q6ZnVuY3Rpb24oZSl7cmV0dXJuISgib2JqZWN0IiE9PWQoZSl8fG51bGw9PT1lKX0saXNTdHJpbmc6ZnVuY3Rpb24oZSl7cmV0dXJuInN0cmluZyI9PXR5cGVvZiBlfSxpc051bWJlcjpmdW5jdGlvbihlKXtyZXR1cm4ibnVtYmVyIj09dHlwZW9mIGV9fSxnPW5ldyBSZWdFeHAoIl4od3NzOi8vKVxcdyoiKTtiLnZhbGlkV1NVcmw9ZnVuY3Rpb24oZSl7cmV0dXJuIGcudGVzdChlKX0sYi5nZXRTdWJzY3JpcHRpb25SZXNwb25zZT1mdW5jdGlvbihlLG4sdCl7cmV0dXJue3RvcGljOmUsY29udGVudDp7c3RhdHVzOm4/InN1Y2Nlc3MiOiJmYWlsdXJlIix0b3BpY3M6dH19fSxiLmFzc2VydElzT2JqZWN0PWZ1bmN0aW9uKGUsbil7aWYoIWIuaXNPYmplY3QoZSkpdGhyb3cgbmV3IEVycm9yKG4rIiBpcyBub3QgYW4gb2JqZWN0ISIpfSxiLmFkZEppdHRlcj1mdW5jdGlvbihlKXt2YXIgbj1hcmd1bWVudHMubGVuZ3RoPjEmJnZvaWQgMCE9PWFyZ3VtZW50c1sxXT9hcmd1bWVudHNbMV06MTtuPU1hdGgubWluKG4sMSk7dmFyIHQ9TWF0aC5yYW5kb20oKT4uNT8xOi0xO3JldHVybiBNYXRoLmZsb29yKGUrdCplKk1hdGgucmFuZG9tKCkqbil9LGIuaXNOZXR3b3JrT25saW5lPWZ1bmN0aW9uKCl7cmV0dXJuIG5hdmlnYXRvci5vbkxpbmV9LGIuaXNOZXR3b3JrRmFpbHVyZT1mdW5jdGlvbihlKXtyZXR1cm4hKCFlLl9kZWJ1Z3x8IWUuX2RlYnVnLnR5cGUpJiYiTmV0d29ya2luZ0Vycm9yIj09PWUuX2RlYnVnLnR5cGV9O3ZhciBtPWI7ZnVuY3Rpb24geShlKXtyZXR1cm4oeT0iZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiYic3ltYm9sIj09dHlwZW9mIFN5bWJvbC5pdGVyYXRvcj9mdW5jdGlvbihlKXtyZXR1cm4gdHlwZW9mIGV9OmZ1bmN0aW9uKGUpe3JldHVybiBlJiYiZnVuY3Rpb24iPT10eXBlb2YgU3ltYm9sJiZlLmNvbnN0cnVjdG9yPT09U3ltYm9sJiZlIT09U3ltYm9sLnByb3RvdHlwZT8ic3ltYm9sIjp0eXBlb2YgZX0pKGUpfWZ1bmN0aW9uIFMoZSxuKXtyZXR1cm4hbnx8Im9iamVjdCIhPT15KG4pJiYiZnVuY3Rpb24iIT10eXBlb2Ygbj9mdW5jdGlvbihlKXtpZih2b2lkIDA9PT1lKXRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7cmV0dXJuIGV9KGUpOm59ZnVuY3Rpb24gaChlKXtyZXR1cm4oaD1PYmplY3Quc2V0UHJvdG90eXBlT2Y/T2JqZWN0LmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKGUpe3JldHVybiBlLl9fcHJvdG9fX3x8T2JqZWN0LmdldFByb3RvdHlwZU9mKGUpfSkoZSl9ZnVuY3Rpb24gayhlLG4pe3JldHVybihrPU9iamVjdC5zZXRQcm90b3R5cGVPZnx8ZnVuY3Rpb24oZSxuKXtyZXR1cm4gZS5fX3Byb3RvX189bixlfSkoZSxuKX1mdW5jdGlvbiB2KGUsbil7aWYoIShlIGluc3RhbmNlb2YgbikpdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIil9ZnVuY3Rpb24gdyhlLG4pe2Zvcih2YXIgdD0wO3Q8bi5sZW5ndGg7dCsrKXt2YXIgbz1uW3RdO28uZW51bWVyYWJsZT1vLmVudW1lcmFibGV8fCExLG8uY29uZmlndXJhYmxlPSEwLCJ2YWx1ZSJpbiBvJiYoby53cml0YWJsZT0hMCksT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsby5rZXksbyl9fWZ1bmN0aW9uIEMoZSxuLHQpe3JldHVybiBuJiZ3KGUucHJvdG90eXBlLG4pLHQmJncoZSx0KSxlfXZhciBUPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZSgpe3YodGhpcyxlKX1yZXR1cm4gQyhlLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiaW5mbyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oZSl7fX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKGUpe319XSksZX0oKSxPPXtERUJVRzoxMCxJTkZPOjIwLFdBUk46MzAsRVJST1I6NDB9LEk9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7dih0aGlzLGUpLHRoaXMudXBkYXRlTG9nZ2VyQ29uZmlnKCksdGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcj1fKCl9cmV0dXJuIEMoZSxbe2tleToid3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLmhhc0NsaWVudExvZ2dlcigpKXN3aXRjaChlKXtjYXNlIE8uREVCVUc6cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5kZWJ1ZyhuKTtjYXNlIE8uSU5GTzpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmluZm8obik7Y2FzZSBPLldBUk46cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci53YXJuKG4pO2Nhc2UgTy5FUlJPUjpyZXR1cm4gdGhpcy5fY2xpZW50TG9nZ2VyLmVycm9yKG4pfX19LHtrZXk6ImlzTGV2ZWxFbmFibGVkIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gZT49dGhpcy5fbGV2ZWx9fSx7a2V5OiJoYXNDbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKCl7cmV0dXJuIG51bGwhPT10aGlzLl9jbGllbnRMb2dnZXJ9fSx7a2V5OiJnZXRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWUucHJlZml4fHwiIjtyZXR1cm4gdGhpcy5fbG9nc0Rlc3RpbmF0aW9uPT09Yz90aGlzLmNvbnNvbGVMb2dnZXJXcmFwcGVyOm5ldyBOKG4pfX0se2tleToidXBkYXRlTG9nZ2VyQ29uZmlnIix2YWx1ZTpmdW5jdGlvbihlKXt2YXIgbj1lfHx7fTt0aGlzLl9sZXZlbD1uLmxldmVsfHxPLkRFQlVHLHRoaXMuX2NsaWVudExvZ2dlcj1uLmxvZ2dlcnx8bnVsbCx0aGlzLl9sb2dzRGVzdGluYXRpb249cixuLmRlYnVnJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPWMpLG4ubG9nZ2VyJiYodGhpcy5fbG9nc0Rlc3RpbmF0aW9uPWkpfX1dKSxlfSgpLFc9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7dih0aGlzLGUpfXJldHVybiBDKGUsW3trZXk6ImRlYnVnIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oKXt9fV0pLGV9KCksTj1mdW5jdGlvbihlKXtmdW5jdGlvbiBuKGUpe3ZhciB0O3JldHVybiB2KHRoaXMsbiksKHQ9Uyh0aGlzLGgobikuY2FsbCh0aGlzKSkpLnByZWZpeD1lfHwiIix0fXJldHVybiBmdW5jdGlvbihlLG4pe2lmKCJmdW5jdGlvbiIhPXR5cGVvZiBuJiZudWxsIT09bil0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiIpO2UucHJvdG90eXBlPU9iamVjdC5jcmVhdGUobiYmbi5wcm90b3R5cGUse2NvbnN0cnVjdG9yOnt2YWx1ZTplLHdyaXRhYmxlOiEwLGNvbmZpZ3VyYWJsZTohMH19KSxuJiZrKGUsbil9KG4sVyksQyhuLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKE8uREVCVUcsbil9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2coTy5JTkZPLG4pfX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKE8uV0FSTixuKX19LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbigpe2Zvcih2YXIgZT1hcmd1bWVudHMubGVuZ3RoLG49bmV3IEFycmF5KGUpLHQ9MDt0PGU7dCsrKW5bdF09YXJndW1lbnRzW3RdO3JldHVybiB0aGlzLl9sb2coTy5FUlJPUixuKX19LHtrZXk6Il9zaG91bGRMb2ciLHZhbHVlOmZ1bmN0aW9uKGUpe3JldHVybiBFLmhhc0NsaWVudExvZ2dlcigpJiZFLmlzTGV2ZWxFbmFibGVkKGUpfX0se2tleToiX3dyaXRlVG9DbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUsbil7cmV0dXJuIEUud3JpdGVUb0NsaWVudExvZ2dlcihlLG4pfX0se2tleToiX2xvZyIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLl9zaG91bGRMb2coZSkpe3ZhciB0PXRoaXMuX2NvbnZlcnRUb1NpbmdsZVN0YXRlbWVudChuKTtyZXR1cm4gdGhpcy5fd3JpdGVUb0NsaWVudExvZ2dlcihlLHQpfX19LHtrZXk6Il9jb252ZXJ0VG9TaW5nbGVTdGF0ZW1lbnQiLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPSIiO3RoaXMucHJlZml4JiYobis9dGhpcy5wcmVmaXgrIiAiKTtmb3IodmFyIHQ9MDt0PGUubGVuZ3RoO3QrKyl7dmFyIG89ZVt0XTtuKz10aGlzLl9jb252ZXJ0VG9TdHJpbmcobykrIiAifXJldHVybiBufX0se2tleToiX2NvbnZlcnRUb1N0cmluZyIsdmFsdWU6ZnVuY3Rpb24oZSl7dHJ5e2lmKCFlKXJldHVybiIiO2lmKG0uaXNTdHJpbmcoZSkpcmV0dXJuIGU7aWYobS5pc09iamVjdChlKSYmbS5pc0Z1bmN0aW9uKGUudG9TdHJpbmcpKXt2YXIgbj1lLnRvU3RyaW5nKCk7aWYoIltvYmplY3QgT2JqZWN0XSIhPT1uKXJldHVybiBufXJldHVybiBKU09OLnN0cmluZ2lmeShlKX1jYXRjaChuKXtyZXR1cm4gY29uc29sZS5lcnJvcigiRXJyb3Igd2hpbGUgY29udmVydGluZyBhcmd1bWVudCB0byBzdHJpbmciLGUsbiksIiJ9fX1dKSxufSgpLF89ZnVuY3Rpb24oKXt2YXIgZT1uZXcgVztyZXR1cm4gZS5kZWJ1Zz1jb25zb2xlLmRlYnVnLGUuaW5mbz1jb25zb2xlLmluZm8sZS53YXJuPWNvbnNvbGUud2FybixlLmVycm9yPWNvbnNvbGUuZXJyb3IsZX0sRT1uZXcgSTtmdW5jdGlvbiBGKGUsbil7Zm9yKHZhciB0PTA7dDxuLmxlbmd0aDt0Kyspe3ZhciBvPW5bdF07by5lbnVtZXJhYmxlPW8uZW51bWVyYWJsZXx8ITEsby5jb25maWd1cmFibGU9ITAsInZhbHVlImluIG8mJihvLndyaXRhYmxlPSEwKSxPYmplY3QuZGVmaW5lUHJvcGVydHkoZSxvLmtleSxvKX19dmFyIEw9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKG4pe3ZhciB0PWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXTpzOyFmdW5jdGlvbihlLG4pe2lmKCEoZSBpbnN0YW5jZW9mIG4pKXRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpfSh0aGlzLGUpLHRoaXMubnVtQXR0ZW1wdHM9MCx0aGlzLmV4ZWN1dG9yPW4sdGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITEsdGhpcy5kZWZhdWx0UmV0cnk9dH12YXIgbix0LG87cmV0dXJuIG49ZSwodD1be2tleToicmV0cnkiLHZhbHVlOmZ1bmN0aW9uKCl7dmFyIGU9dGhpczt0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbnx8KHRoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9uPSEwLHNldFRpbWVvdXQoZnVuY3Rpb24oKXtlLl9leGVjdXRlKCl9LHRoaXMuX2dldERlbGF5KCkpKX19LHtrZXk6Il9leGVjdXRlIix2YWx1ZTpmdW5jdGlvbigpe3RoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9uPSExLHRoaXMuZXhlY3V0b3IoKSx0aGlzLm51bUF0dGVtcHRzKyt9fSx7a2V5OiJjb25uZWN0ZWQiLHZhbHVlOmZ1bmN0aW9uKCl7dGhpcy5udW1BdHRlbXB0cz0wfX0se2tleToiX2dldERlbGF5Iix2YWx1ZTpmdW5jdGlvbigpe3ZhciBlPU1hdGgucG93KDIsdGhpcy5udW1BdHRlbXB0cykqdGhpcy5kZWZhdWx0UmV0cnk7cmV0dXJuIGU8PTNlND9lOjNlNH19LHtrZXk6ImdldElzQ29ubmVjdGVkIix2YWx1ZTpmdW5jdGlvbigpe3JldHVybiF0aGlzLm51bUF0dGVtcHRzfX1dKSYmRihuLnByb3RvdHlwZSx0KSxvJiZGKG4sbyksZX0oKTt0LmQobiwiYSIsZnVuY3Rpb24oKXtyZXR1cm4gUn0pO3ZhciB4PWZ1bmN0aW9uKCl7dmFyIGU9RS5nZXRMb2dnZXIoe30pLG49bS5pc05ldHdvcmtPbmxpbmUoKSx0PXtwcmltYXJ5Om51bGwsc2Vjb25kYXJ5Om51bGx9LG89e3JlY29ubmVjdFdlYlNvY2tldDohMCx3ZWJzb2NrZXRJbml0RmFpbGVkOiExLGV4cG9uZW50aWFsQmFja09mZlRpbWU6MWUzLGV4cG9uZW50aWFsVGltZW91dEhhbmRsZTpudWxsLGxpZmVUaW1lVGltZW91dEhhbmRsZTpudWxsLHdlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkOm51bGwsY29ublN0YXRlOm51bGx9LHI9e2Nvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50OjAsY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU6bnVsbCxub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcDpudWxsfSxpPXtwZW5kaW5nUmVzcG9uc2U6ITEsaW50ZXJ2YWxIYW5kbGU6bnVsbH0sYz17aW5pdEZhaWx1cmU6bmV3IFNldCxnZXRXZWJTb2NrZXRUcmFuc3BvcnQ6bnVsbCxzdWJzY3JpcHRpb25VcGRhdGU6bmV3IFNldCxzdWJzY3JpcHRpb25GYWlsdXJlOm5ldyBTZXQsdG9waWM6bmV3IE1hcCxhbGxNZXNzYWdlOm5ldyBTZXQsY29ubmVjdGlvbkdhaW46bmV3IFNldCxjb25uZWN0aW9uTG9zdDpuZXcgU2V0LGNvbm5lY3Rpb25PcGVuOm5ldyBTZXQsY29ubmVjdGlvbkNsb3NlOm5ldyBTZXR9LHM9e2Nvbm5Db25maWc6bnVsbCxwcm9taXNlSGFuZGxlOm51bGwscHJvbWlzZUNvbXBsZXRlZDohMH0sZD17c3Vic2NyaWJlZDpuZXcgU2V0LHBlbmRpbmc6bmV3IFNldCxzdWJzY3JpcHRpb25IaXN0b3J5Om5ldyBTZXR9LGI9e3Jlc3BvbnNlQ2hlY2tJbnRlcnZhbElkOm51bGwscmVxdWVzdENvbXBsZXRlZDohMCxyZVN1YnNjcmliZUludGVydmFsSWQ6bnVsbCxjb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzOjAsY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdDowfSxnPW5ldyBMKGZ1bmN0aW9uKCl7VSgpfSkseT1uZXcgU2V0KFthLHUsbF0pLFM9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtpZihuIT09bS5pc05ldHdvcmtPbmxpbmUoKSl7aWYoIShuPW0uaXNOZXR3b3JrT25saW5lKCkpKXJldHVybiB2b2lkIEooZS5pbmZvKCJOZXR3b3JrIG9mZmxpbmUiKSk7dmFyIHQ9TygpO24mJighdHx8dyh0LFdlYlNvY2tldC5DTE9TSU5HKXx8dyh0LFdlYlNvY2tldC5DTE9TRUQpKSYmKEooZS5pbmZvKCJOZXR3b3JrIG9ubGluZSwgY29ubmVjdGluZyB0byBXZWJTb2NrZXQgc2VydmVyIikpLFUoKSl9fSwyNTApLGg9ZnVuY3Rpb24obix0KXtuLmZvckVhY2goZnVuY3Rpb24obil7dHJ5e24odCl9Y2F0Y2gobil7SihlLmVycm9yKCJFcnJvciBleGVjdXRpbmcgY2FsbGJhY2siLG4pKX19KX0saz1mdW5jdGlvbihlKXtpZihudWxsPT09ZSlyZXR1cm4iTlVMTCI7c3dpdGNoKGUucmVhZHlTdGF0ZSl7Y2FzZSBXZWJTb2NrZXQuQ09OTkVDVElORzpyZXR1cm4iQ09OTkVDVElORyI7Y2FzZSBXZWJTb2NrZXQuT1BFTjpyZXR1cm4iT1BFTiI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0lORzpyZXR1cm4iQ0xPU0lORyI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0VEOnJldHVybiJDTE9TRUQiO2RlZmF1bHQ6cmV0dXJuIlVOREVGSU5FRCJ9fSx2PWZ1bmN0aW9uKCl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOiIiO0ooZS5kZWJ1ZygiWyIrbisiXSBQcmltYXJ5IFdlYlNvY2tldDogIitrKHQucHJpbWFyeSkrIiB8IFNlY29uZGFyeSBXZWJTb2NrZXQ6ICIrayh0LnNlY29uZGFyeSkpKX0sdz1mdW5jdGlvbihlLG4pe3JldHVybiBlJiZlLnJlYWR5U3RhdGU9PT1ufSxDPWZ1bmN0aW9uKGUpe3JldHVybiB3KGUsV2ViU29ja2V0Lk9QRU4pfSxUPWZ1bmN0aW9uKGUpe3JldHVybiBudWxsPT09ZXx8dm9pZCAwPT09ZS5yZWFkeVN0YXRlfHx3KGUsV2ViU29ja2V0LkNMT1NFRCl9LE89ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbCE9PXQuc2Vjb25kYXJ5P3Quc2Vjb25kYXJ5OnQucHJpbWFyeX0sST1mdW5jdGlvbigpe3JldHVybiBDKE8oKSl9LFc9ZnVuY3Rpb24oKXtpZihpLnBlbmRpbmdSZXNwb25zZSlyZXR1cm4gSihlLndhcm4oIkhlYXJ0YmVhdCByZXNwb25zZSBub3QgcmVjZWl2ZWQiKSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxpLnBlbmRpbmdSZXNwb25zZT0hMSx2b2lkIFUoKTtJKCk/KEooZS5kZWJ1ZygiU2VuZGluZyBoZWFydGJlYXQiKSksTygpLnNlbmQoRyhsKSksaS5wZW5kaW5nUmVzcG9uc2U9ITApOihKKGUud2FybigiRmFpbGVkIHRvIHNlbmQgaGVhcnRiZWF0IHNpbmNlIFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpKSx2KCJzZW5kSGVhcnRCZWF0IiksVSgpKX0sTj1mdW5jdGlvbigpe28uZXhwb25lbnRpYWxCYWNrT2ZmVGltZT0xZTMsaS5wZW5kaW5nUmVzcG9uc2U9ITEsby5yZWNvbm5lY3RXZWJTb2NrZXQ9ITAsY2xlYXJUaW1lb3V0KG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlKSxjbGVhckludGVydmFsKGkuaW50ZXJ2YWxIYW5kbGUpLGNsZWFyVGltZW91dChvLmV4cG9uZW50aWFsVGltZW91dEhhbmRsZSksY2xlYXJUaW1lb3V0KG8ud2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQpfSxfPWZ1bmN0aW9uKCl7Yi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTAsYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsY2xlYXJJbnRlcnZhbChiLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkKSxjbGVhckludGVydmFsKGIucmVTdWJzY3JpYmVJbnRlcnZhbElkKX0sRj1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ9MCxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPW51bGwsci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD1udWxsfSx4PWZ1bmN0aW9uKCl7Zy5jb25uZWN0ZWQoKTt0cnl7SihlLmluZm8oIldlYlNvY2tldCBjb25uZWN0aW9uIGVzdGFibGlzaGVkISIpKSx2KCJ3ZWJTb2NrZXRPbk9wZW4iKSxudWxsIT09by5jb25uU3RhdGUmJm8uY29ublN0YXRlIT09cHx8aChjLmNvbm5lY3Rpb25HYWluKSxvLmNvbm5TdGF0ZT1mO3ZhciBuPURhdGUubm93KCk7aChjLmNvbm5lY3Rpb25PcGVuLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsbm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6ci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcCxjb25uZWN0aW9uRXN0YWJsaXNoZWRUaW1lOm4sdGltZVRvQ29ubmVjdDpuLXIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsdGltZVdpdGhvdXRDb25uZWN0aW9uOnIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA/bi1yLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOm51bGx9KSxGKCksTigpLE8oKS5vcGVuVGltZXN0YW1wPURhdGUubm93KCksMD09PWQuc3Vic2NyaWJlZC5zaXplJiZDKHQuc2Vjb25kYXJ5KSYmRCh0LnByaW1hcnksIltQcmltYXJ5IFdlYlNvY2tldF0gQ2xvc2luZyBXZWJTb2NrZXQiKSwoZC5zdWJzY3JpYmVkLnNpemU+MHx8ZC5wZW5kaW5nLnNpemU+MCkmJihDKHQuc2Vjb25kYXJ5KSYmSihlLmluZm8oIlN1YnNjcmliaW5nIHNlY29uZGFyeSB3ZWJzb2NrZXQgdG8gdG9waWNzIG9mIHByaW1hcnkgd2Vic29ja2V0IikpLGQuc3Vic2NyaWJlZC5mb3JFYWNoKGZ1bmN0aW9uKGUpe2Quc3Vic2NyaXB0aW9uSGlzdG9yeS5hZGQoZSksZC5wZW5kaW5nLmFkZChlKX0pLGQuc3Vic2NyaWJlZC5jbGVhcigpLGooKSksVygpLGkuaW50ZXJ2YWxIYW5kbGU9c2V0SW50ZXJ2YWwoVywxZTQpO3ZhciBhPTFlMypzLmNvbm5Db25maWcud2ViU29ja2V0VHJhbnNwb3J0LnRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzO0ooZS5kZWJ1ZygiU2NoZWR1bGluZyBXZWJTb2NrZXQgbWFuYWdlciByZWNvbm5lY3Rpb24sIGFmdGVyIGRlbGF5ICIrYSsiIG1zIikpLG8ubGlmZVRpbWVUaW1lb3V0SGFuZGxlPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtKKGUuZGVidWcoIlN0YXJ0aW5nIHNjaGVkdWxlZCBXZWJTb2NrZXQgbWFuYWdlciByZWNvbm5lY3Rpb24iKSksVSgpfSxhKX1jYXRjaChuKXtKKGUuZXJyb3IoIkVycm9yIGFmdGVyIGVzdGFibGlzaGluZyBXZWJTb2NrZXQgY29ubmVjdGlvbiIsbikpfX0sUj1mdW5jdGlvbihuKXt2KCJ3ZWJTb2NrZXRPbkVycm9yIiksSihlLmVycm9yKCJXZWJTb2NrZXRNYW5hZ2VyIEVycm9yLCBlcnJvcl9ldmVudDogIixKU09OLnN0cmluZ2lmeShuKSkpLGcuZ2V0SXNDb25uZWN0ZWQoKT9VKCk6Zy5yZXRyeSgpfSxBPWZ1bmN0aW9uKG4pe3ZhciBvPUpTT04ucGFyc2Uobi5kYXRhKTtzd2l0Y2goby50b3BpYyl7Y2FzZSBhOmlmKEooZS5kZWJ1ZygiU3Vic2NyaXB0aW9uIE1lc3NhZ2UgcmVjZWl2ZWQgZnJvbSB3ZWJTb2NrZXQgc2VydmVyIixuLmRhdGEpKSxiLnJlcXVlc3RDb21wbGV0ZWQ9ITAsYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsInN1Y2Nlc3MiPT09by5jb250ZW50LnN0YXR1cyliLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCxvLmNvbnRlbnQudG9waWNzLmZvckVhY2goZnVuY3Rpb24oZSl7ZC5zdWJzY3JpcHRpb25IaXN0b3J5LmRlbGV0ZShlKSxkLnBlbmRpbmcuZGVsZXRlKGUpLGQuc3Vic2NyaWJlZC5hZGQoZSl9KSwwPT09ZC5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemU/Qyh0LnNlY29uZGFyeSkmJihKKGUuaW5mbygiU3VjY2Vzc2Z1bGx5IHN1YnNjcmliZWQgc2Vjb25kYXJ5IHdlYnNvY2tldCB0byBhbGwgdG9waWNzIG9mIHByaW1hcnkgd2Vic29ja2V0IikpLEQodC5wcmltYXJ5LCJbUHJpbWFyeSBXZWJTb2NrZXRdIENsb3NpbmcgV2ViU29ja2V0IikpOmooKSxoKGMuc3Vic2NyaXB0aW9uVXBkYXRlLG8pO2Vsc2V7aWYoY2xlYXJJbnRlcnZhbChiLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZCksKytiLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHMsNT09PWIuY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cylyZXR1cm4gaChjLnN1YnNjcmlwdGlvbkZhaWx1cmUsbyksdm9pZChiLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCk7Yi5yZVN1YnNjcmliZUludGVydmFsSWQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtqKCl9LDUwMCl9YnJlYWs7Y2FzZSBsOkooZS5kZWJ1ZygiSGVhcnRiZWF0IHJlc3BvbnNlIHJlY2VpdmVkIikpLGkucGVuZGluZ1Jlc3BvbnNlPSExO2JyZWFrO2RlZmF1bHQ6aWYoby50b3BpYyl7aWYoSihlLmRlYnVnKCJNZXNzYWdlIHJlY2VpdmVkIGZvciB0b3BpYyAiK28udG9waWMpKSxDKHQucHJpbWFyeSkmJkModC5zZWNvbmRhcnkpJiYwPT09ZC5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemUmJnRoaXM9PT10LnByaW1hcnkpcmV0dXJuIHZvaWQgSihlLndhcm4oIklnbm9yaW5nIE1lc3NhZ2UgZm9yIFRvcGljICIrby50b3BpYysiLCB0byBhdm9pZCBkdXBsaWNhdGVzIikpO2lmKDA9PT1jLmFsbE1lc3NhZ2Uuc2l6ZSYmMD09PWMudG9waWMuc2l6ZSlyZXR1cm4gdm9pZCBKKGUud2FybigiTm8gcmVnaXN0ZXJlZCBjYWxsYmFjayBsaXN0ZW5lciBmb3IgVG9waWMiLG8udG9waWMpKTtoKGMuYWxsTWVzc2FnZSxvKSxjLnRvcGljLmhhcyhvLnRvcGljKSYmaChjLnRvcGljLmdldChvLnRvcGljKSxvKX1lbHNlIG8ubWVzc2FnZT9KKGUud2FybigiV2ViU29ja2V0TWFuYWdlciBNZXNzYWdlIEVycm9yIixvKSk6SihlLndhcm4oIkludmFsaWQgaW5jb21pbmcgbWVzc2FnZSIsbykpfX0saj1mdW5jdGlvbiBuKCl7aWYoYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PjMpcmV0dXJuIEooZS53YXJuKCJJZ25vcmluZyBzdWJzY3JpYmVQZW5kaW5nVG9waWNzIHNpbmNlIHdlIGhhdmUgZXhoYXVzdGVkIG1heCBzdWJzY3JpcHRpb24gcmV0cmllcyB3aXRoIG5vIHJlc3BvbnNlIikpLHZvaWQgaChjLnN1YnNjcmlwdGlvbkZhaWx1cmUsbS5nZXRTdWJzY3JpcHRpb25SZXNwb25zZShhLCExLEFycmF5LmZyb20oZC5wZW5kaW5nKSkpO0koKT8wIT09QXJyYXkuZnJvbShkLnBlbmRpbmcpLmxlbmd0aCYmKGNsZWFySW50ZXJ2YWwoYi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZCksTygpLnNlbmQoRyhhLHt0b3BpY3M6QXJyYXkuZnJvbShkLnBlbmRpbmcpfSkpLGIucmVxdWVzdENvbXBsZXRlZD0hMSxiLnJlc3BvbnNlQ2hlY2tJbnRlcnZhbElkPXNldEludGVydmFsKGZ1bmN0aW9uKCl7Yi5yZXF1ZXN0Q29tcGxldGVkfHwoKytiLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3QsbigpKX0sMWUzKSk6SihlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3MgY2FsbCBzaW5jZSBEZWZhdWx0IFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpKX0sRD1mdW5jdGlvbihuLHQpe3cobixXZWJTb2NrZXQuQ09OTkVDVElORyl8fHcobixXZWJTb2NrZXQuT1BFTik/bi5jbG9zZSgxZTMsdCk6SihlLndhcm4oIklnbm9yaW5nIFdlYlNvY2tldCBDbG9zZSByZXF1ZXN0LCBXZWJTb2NrZXQgU3RhdGU6ICIrayhuKSkpfSxNPWZ1bmN0aW9uKGUpe0QodC5wcmltYXJ5LCJbUHJpbWFyeV0gV2ViU29ja2V0ICIrZSksRCh0LnNlY29uZGFyeSwiW1NlY29uZGFyeV0gV2ViU29ja2V0ICIrZSl9LFA9ZnVuY3Rpb24oKXtyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50Kys7dmFyIG49bS5hZGRKaXR0ZXIoby5leHBvbmVudGlhbEJhY2tPZmZUaW1lLC4zKTtEYXRlLm5vdygpK248PXMuY29ubkNvbmZpZy51cmxDb25uVmFsaWRUaW1lPyhKKGUuZGVidWcoIlNjaGVkdWxpbmcgV2ViU29ja2V0IHJlaW5pdGlhbGl6YXRpb24sIGFmdGVyIGRlbGF5ICIrbisiIG1zIikpLG8uZXhwb25lbnRpYWxUaW1lb3V0SGFuZGxlPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtyZXR1cm4gcSgpfSxuKSxvLmV4cG9uZW50aWFsQmFja09mZlRpbWUqPTIpOihKKGUud2FybigiV2ViU29ja2V0IFVSTCBjYW5ub3QgYmUgdXNlZCB0byBlc3RhYmxpc2ggY29ubmVjdGlvbiIpKSxVKCkpfSxIPWZ1bmN0aW9uKG4pe04oKSxfKCksSihlLmVycm9yKCJXZWJTb2NrZXQgSW5pdGlhbGl6YXRpb24gZmFpbGVkIikpLG8ud2Vic29ja2V0SW5pdEZhaWxlZD0hMCxNKCJUZXJtaW5hdGluZyBXZWJTb2NrZXQgTWFuYWdlciIpLGNsZWFySW50ZXJ2YWwoUyksaChjLmluaXRGYWlsdXJlLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUscmVhc29uOm59KSxGKCl9LEc9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkoe3RvcGljOmUsY29udGVudDpufSl9LHo9ZnVuY3Rpb24obil7cmV0dXJuISEobS5pc09iamVjdChuKSYmbS5pc09iamVjdChuLndlYlNvY2tldFRyYW5zcG9ydCkmJm0uaXNOb25FbXB0eVN0cmluZyhuLndlYlNvY2tldFRyYW5zcG9ydC51cmwpJiZtLnZhbGlkV1NVcmwobi53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKSYmMWUzKm4ud2ViU29ja2V0VHJhbnNwb3J0LnRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzPj0zZTUpfHwoSihlLmVycm9yKCJJbnZhbGlkIFdlYlNvY2tldCBDb25uZWN0aW9uIENvbmZpZ3VyYXRpb24iLG4pKSwhMSl9LFU9ZnVuY3Rpb24oKXtpZihtLmlzTmV0d29ya09ubGluZSgpKWlmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClKKGUuZGVidWcoIldlYlNvY2tldCBJbml0IGhhZCBmYWlsZWQsIGlnbm9yaW5nIHRoaXMgZ2V0V2ViU29ja2V0Q29ubkNvbmZpZyByZXF1ZXN0IikpO2Vsc2V7aWYocy5wcm9taXNlQ29tcGxldGVkKXJldHVybiBOKCksSihlLmluZm8oIkZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIikpLHIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU9ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZXx8RGF0ZS5ub3coKSxzLnByb21pc2VDb21wbGV0ZWQ9ITEscy5wcm9taXNlSGFuZGxlPWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KCkscy5wcm9taXNlSGFuZGxlLnRoZW4oZnVuY3Rpb24obil7cmV0dXJuIHMucHJvbWlzZUNvbXBsZXRlZD0hMCxKKGUuZGVidWcoIlN1Y2Nlc3NmdWxseSBmZXRjaGVkIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLG4pKSx6KG4pPyhzLmNvbm5Db25maWc9bixzLmNvbm5Db25maWcudXJsQ29ublZhbGlkVGltZT1EYXRlLm5vdygpKzg1ZTMscSgpKTooSCgiSW52YWxpZCBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uOiAiK24pLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfSl9LGZ1bmN0aW9uKG4pe3JldHVybiBzLnByb21pc2VDb21wbGV0ZWQ9ITAsSihlLmVycm9yKCJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsbikpLG0uaXNOZXR3b3JrRmFpbHVyZShuKT8oSihlLmluZm8oIlJldHJ5aW5nIGZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIikpLGcucmV0cnkoKSk6SCgiRmFpbGVkIHRvIGZldGNoIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb246ICIrSlNPTi5zdHJpbmdpZnkobikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfX0pO0ooZS5kZWJ1ZygiVGhlcmUgaXMgYW4gb25nb2luZyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QsIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQiKSl9ZWxzZSBKKGUuaW5mbygiTmV0d29yayBvZmZsaW5lLCBpZ25vcmluZyB0aGlzIGdldFdlYlNvY2tldENvbm5Db25maWcgcmVxdWVzdCIpKX0scT1mdW5jdGlvbigpe2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClyZXR1cm4gSihlLmluZm8oIndlYi1zb2NrZXQgaW5pdGlhbGl6aW5nIGhhZCBmYWlsZWQsIGFib3J0aW5nIHJlLWluaXQiKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2lmKCFtLmlzTmV0d29ya09ubGluZSgpKXJldHVybiBKKGUud2FybigiU3lzdGVtIGlzIG9mZmxpbmUgYWJvcnRpbmcgd2ViLXNvY2tldCBpbml0IikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfTtKKGUuaW5mbygiSW5pdGlhbGl6aW5nIFdlYnNvY2tldCBNYW5hZ2VyIikpLHYoImluaXRXZWJTb2NrZXQiKTt0cnl7aWYoeihzLmNvbm5Db25maWcpKXt2YXIgbj1udWxsO3JldHVybiBDKHQucHJpbWFyeSk/KEooZS5kZWJ1ZygiUHJpbWFyeSBTb2NrZXQgY29ubmVjdGlvbiBpcyBhbHJlYWR5IG9wZW4iKSksdyh0LnNlY29uZGFyeSxXZWJTb2NrZXQuQ09OTkVDVElORyl8fChKKGUuZGVidWcoIkVzdGFibGlzaGluZyBhIHNlY29uZGFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSksZy5udW1BdHRlbXB0cz0wLHQuc2Vjb25kYXJ5PUIoKSksbj10LnNlY29uZGFyeSk6KHcodC5wcmltYXJ5LFdlYlNvY2tldC5DT05ORUNUSU5HKXx8KEooZS5kZWJ1ZygiRXN0YWJsaXNoaW5nIGEgcHJpbWFyeSB3ZWItc29ja2V0IGNvbm5lY3Rpb24iKSksdC5wcmltYXJ5PUIoKSksbj10LnByaW1hcnkpLG8ud2ViU29ja2V0SW5pdENoZWNrZXJUaW1lb3V0SWQ9c2V0VGltZW91dChmdW5jdGlvbigpe0Mobil8fFAoKX0sMWUzKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMX19fWNhdGNoKG4pe3JldHVybiBKKGUuZXJyb3IoIkVycm9yIEluaXRpYWxpemluZyB3ZWItc29ja2V0LW1hbmFnZXIiLG4pKSxIKCJGYWlsZWQgdG8gaW5pdGlhbGl6ZSBuZXcgV2ViU29ja2V0OiAiK24ubWVzc2FnZSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9fX0sQj1mdW5jdGlvbigpe3ZhciBuPW5ldyBXZWJTb2NrZXQocy5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC51cmwpO3JldHVybiBuLmFkZEV2ZW50TGlzdGVuZXIoIm9wZW4iLHgpLG4uYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsQSksbi5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsUiksbi5hZGRFdmVudExpc3RlbmVyKCJjbG9zZSIsZnVuY3Rpb24oaSl7cmV0dXJuIGZ1bmN0aW9uKG4saSl7SihlLmluZm8oIlNvY2tldCBjb25uZWN0aW9uIGlzIGNsb3NlZCIsSlNPTi5zdHJpbmdpZnkobikpKSx2KCJ3ZWJTb2NrZXRPbkNsb3NlIGJlZm9yZS1jbGVhbnVwIiksaChjLmNvbm5lY3Rpb25DbG9zZSx7b3BlblRpbWVzdGFtcDppLm9wZW5UaW1lc3RhbXAsY2xvc2VUaW1lc3RhbXA6RGF0ZS5ub3coKSxjb25uZWN0aW9uRHVyYXRpb246RGF0ZS5ub3coKS1pLm9wZW5UaW1lc3RhbXAsY29kZTpuLmNvZGUscmVhc29uOm4ucmVhc29ufSksVCh0LnByaW1hcnkpJiYodC5wcmltYXJ5PW51bGwpLFQodC5zZWNvbmRhcnkpJiYodC5zZWNvbmRhcnk9bnVsbCksby5yZWNvbm5lY3RXZWJTb2NrZXQmJihDKHQucHJpbWFyeSl8fEModC5zZWNvbmRhcnkpP1QodC5wcmltYXJ5KSYmQyh0LnNlY29uZGFyeSkmJihKKGUuaW5mbygiW1ByaW1hcnldIFdlYlNvY2tldCBDbGVhbmx5IENsb3NlZCIpKSx0LnByaW1hcnk9dC5zZWNvbmRhcnksdC5zZWNvbmRhcnk9bnVsbCk6KEooZS53YXJuKCJOZWl0aGVyIHByaW1hcnkgd2Vic29ja2V0IGFuZCBub3Igc2Vjb25kYXJ5IHdlYnNvY2tldCBoYXZlIG9wZW4gY29ubmVjdGlvbnMsIGF0dGVtcHRpbmcgdG8gcmUtZXN0YWJsaXNoIGNvbm5lY3Rpb24iKSksby5jb25uU3RhdGU9PT1wP0ooZS5pbmZvKCJJZ25vcmluZyBjb25uZWN0aW9uTG9zdCBjYWxsYmFjayBpbnZvY2F0aW9uIikpOihoKGMuY29ubmVjdGlvbkxvc3Qse29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLHIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA9RGF0ZS5ub3coKSksby5jb25uU3RhdGU9cCxVKCkpLHYoIndlYlNvY2tldE9uQ2xvc2UgYWZ0ZXItY2xlYW51cCIpKX0oaSxuKX0pLG59LEo9ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBlLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyJiZlLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCksZX07dGhpcy5pbml0PWZ1bmN0aW9uKG4pe2lmKG0uYXNzZXJ0VHJ1ZShtLmlzRnVuY3Rpb24obiksInRyYW5zcG9ydEhhbmRsZSBtdXN0IGJlIGEgZnVuY3Rpb24iKSxudWxsPT09Yy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQpcmV0dXJuIGMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0PW4sVSgpO0ooZS53YXJuKCJXZWIgU29ja2V0IE1hbmFnZXIgd2FzIGFscmVhZHkgaW5pdGlhbGl6ZWQiKSl9LHRoaXMub25Jbml0RmFpbHVyZT1mdW5jdGlvbihlKXtyZXR1cm4gbS5hc3NlcnRUcnVlKG0uaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5pbml0RmFpbHVyZS5hZGQoZSksby53ZWJzb2NrZXRJbml0RmFpbGVkJiZlKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5pbml0RmFpbHVyZS5kZWxldGUoZSl9fSx0aGlzLm9uQ29ubmVjdGlvbk9wZW49ZnVuY3Rpb24oZSl7cmV0dXJuIG0uYXNzZXJ0VHJ1ZShtLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbk9wZW4uYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbk9wZW4uZGVsZXRlKGUpfX0sdGhpcy5vbkNvbm5lY3Rpb25DbG9zZT1mdW5jdGlvbihlKXtyZXR1cm4gbS5hc3NlcnRUcnVlKG0uaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uQ2xvc2UuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkNsb3NlLmRlbGV0ZShlKX19LHRoaXMub25Db25uZWN0aW9uR2Fpbj1mdW5jdGlvbihlKXtyZXR1cm4gbS5hc3NlcnRUcnVlKG0uaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uR2Fpbi5hZGQoZSksSSgpJiZlKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uR2Fpbi5kZWxldGUoZSl9fSx0aGlzLm9uQ29ubmVjdGlvbkxvc3Q9ZnVuY3Rpb24oZSl7cmV0dXJuIG0uYXNzZXJ0VHJ1ZShtLmlzRnVuY3Rpb24oZSksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkxvc3QuYWRkKGUpLG8uY29ublN0YXRlPT09cCYmZSgpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkxvc3QuZGVsZXRlKGUpfX0sdGhpcy5vblN1YnNjcmlwdGlvblVwZGF0ZT1mdW5jdGlvbihlKXtyZXR1cm4gbS5hc3NlcnRUcnVlKG0uaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25VcGRhdGUuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuc3Vic2NyaXB0aW9uVXBkYXRlLmRlbGV0ZShlKX19LHRoaXMub25TdWJzY3JpcHRpb25GYWlsdXJlPWZ1bmN0aW9uKGUpe3JldHVybiBtLmFzc2VydFRydWUobS5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnN1YnNjcmlwdGlvbkZhaWx1cmUuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuc3Vic2NyaXB0aW9uRmFpbHVyZS5kZWxldGUoZSl9fSx0aGlzLm9uTWVzc2FnZT1mdW5jdGlvbihlLG4pe3JldHVybiBtLmFzc2VydE5vdE51bGwoZSwidG9waWNOYW1lIiksbS5hc3NlcnRUcnVlKG0uaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy50b3BpYy5oYXMoZSk/Yy50b3BpYy5nZXQoZSkuYWRkKG4pOmMudG9waWMuc2V0KGUsbmV3IFNldChbbl0pKSxmdW5jdGlvbigpe3JldHVybiBjLnRvcGljLmdldChlKS5kZWxldGUobil9fSx0aGlzLm9uQWxsTWVzc2FnZT1mdW5jdGlvbihlKXtyZXR1cm4gbS5hc3NlcnRUcnVlKG0uaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5hbGxNZXNzYWdlLmFkZChlKSxmdW5jdGlvbigpe3JldHVybiBjLmFsbE1lc3NhZ2UuZGVsZXRlKGUpfX0sdGhpcy5zdWJzY3JpYmVUb3BpY3M9ZnVuY3Rpb24oZSl7bS5hc3NlcnROb3ROdWxsKGUsInRvcGljcyIpLG0uYXNzZXJ0SXNMaXN0KGUpLGUuZm9yRWFjaChmdW5jdGlvbihlKXtkLnN1YnNjcmliZWQuaGFzKGUpfHxkLnBlbmRpbmcuYWRkKGUpfSksYi5jb25zZWN1dGl2ZU5vUmVzcG9uc2VSZXF1ZXN0PTAsaigpfSx0aGlzLnNlbmRNZXNzYWdlPWZ1bmN0aW9uKG4pe2lmKG0uYXNzZXJ0SXNPYmplY3QobiwicGF5bG9hZCIpLHZvaWQgMD09PW4udG9waWN8fHkuaGFzKG4udG9waWMpKUooZS53YXJuKCJDYW5ub3Qgc2VuZCBtZXNzYWdlLCBJbnZhbGlkIHRvcGljIixuKSk7ZWxzZXt0cnl7bj1KU09OLnN0cmluZ2lmeShuKX1jYXRjaCh0KXtyZXR1cm4gdm9pZCBKKGUud2FybigiRXJyb3Igc3RyaW5naWZ5IG1lc3NhZ2UiLG4pKX1JKCk/TygpLnNlbmQobik6SihlLndhcm4oIkNhbm5vdCBzZW5kIG1lc3NhZ2UsIHdlYiBzb2NrZXQgY29ubmVjdGlvbiBpcyBub3Qgb3BlbiIpKX19LHRoaXMuY2xvc2VXZWJTb2NrZXQ9ZnVuY3Rpb24oKXtOKCksXygpLG8ucmVjb25uZWN0V2ViU29ja2V0PSExLGNsZWFySW50ZXJ2YWwoUyksTSgiVXNlciByZXF1ZXN0IHRvIGNsb3NlIFdlYlNvY2tldCIpfSx0aGlzLnRlcm1pbmF0ZVdlYlNvY2tldE1hbmFnZXI9SH0sUj17Y3JlYXRlOmZ1bmN0aW9uKCl7cmV0dXJuIG5ldyB4fSxzZXRHbG9iYWxDb25maWc6ZnVuY3Rpb24oZSl7dmFyIG49ZS5sb2dnZXJDb25maWc7RS51cGRhdGVMb2dnZXJDb25maWcobil9LExvZ0xldmVsOk8sTG9nZ2VyOlR9fSxmdW5jdGlvbihlLG4sdCl7dmFyIG87IWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO3ZhciByPXtub3Rfc3RyaW5nOi9bXnNdLyxub3RfYm9vbDovW150XS8sbm90X3R5cGU6L1teVF0vLG5vdF9wcmltaXRpdmU6L1tedl0vLG51bWJlcjovW2RpZWZnXS8sbnVtZXJpY19hcmc6L1tiY2RpZWZndXhYXS8sanNvbjovW2pdLyxub3RfanNvbjovW15qXS8sdGV4dDovXlteXHgyNV0rLyxtb2R1bG86L15ceDI1ezJ9LyxwbGFjZWhvbGRlcjovXlx4MjUoPzooWzEtOV1cZCopXCR8XCgoW14pXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZ2lqb3N0VHV2eFhdKS8sa2V5Oi9eKFthLXpfXVthLXpfXGRdKikvaSxrZXlfYWNjZXNzOi9eXC4oW2Etel9dW2Etel9cZF0qKS9pLGluZGV4X2FjY2VzczovXlxbKFxkKylcXS8sc2lnbjovXlsrLV0vfTtmdW5jdGlvbiBpKGUpe3JldHVybiBmdW5jdGlvbihlLG4pe3ZhciB0LG8sYyxzLGEsdSxsLGYscCxkPTEsYj1lLmxlbmd0aCxnPSIiO2ZvcihvPTA7bzxiO28rKylpZigic3RyaW5nIj09dHlwZW9mIGVbb10pZys9ZVtvXTtlbHNlIGlmKCJvYmplY3QiPT10eXBlb2YgZVtvXSl7aWYoKHM9ZVtvXSkua2V5cylmb3IodD1uW2RdLGM9MDtjPHMua2V5cy5sZW5ndGg7YysrKXtpZihudWxsPT10KXRocm93IG5ldyBFcnJvcihpKCdbc3ByaW50Zl0gQ2Fubm90IGFjY2VzcyBwcm9wZXJ0eSAiJXMiIG9mIHVuZGVmaW5lZCB2YWx1ZSAiJXMiJyxzLmtleXNbY10scy5rZXlzW2MtMV0pKTt0PXRbcy5rZXlzW2NdXX1lbHNlIHQ9cy5wYXJhbV9ubz9uW3MucGFyYW1fbm9dOm5bZCsrXTtpZihyLm5vdF90eXBlLnRlc3Qocy50eXBlKSYmci5ub3RfcHJpbWl0aXZlLnRlc3Qocy50eXBlKSYmdCBpbnN0YW5jZW9mIEZ1bmN0aW9uJiYodD10KCkpLHIubnVtZXJpY19hcmcudGVzdChzLnR5cGUpJiYibnVtYmVyIiE9dHlwZW9mIHQmJmlzTmFOKHQpKXRocm93IG5ldyBUeXBlRXJyb3IoaSgiW3NwcmludGZdIGV4cGVjdGluZyBudW1iZXIgYnV0IGZvdW5kICVUIix0KSk7c3dpdGNoKHIubnVtYmVyLnRlc3Qocy50eXBlKSYmKGY9dD49MCkscy50eXBlKXtjYXNlImIiOnQ9cGFyc2VJbnQodCwxMCkudG9TdHJpbmcoMik7YnJlYWs7Y2FzZSJjIjp0PVN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQodCwxMCkpO2JyZWFrO2Nhc2UiZCI6Y2FzZSJpIjp0PXBhcnNlSW50KHQsMTApO2JyZWFrO2Nhc2UiaiI6dD1KU09OLnN0cmluZ2lmeSh0LG51bGwscy53aWR0aD9wYXJzZUludChzLndpZHRoKTowKTticmVhaztjYXNlImUiOnQ9cy5wcmVjaXNpb24/cGFyc2VGbG9hdCh0KS50b0V4cG9uZW50aWFsKHMucHJlY2lzaW9uKTpwYXJzZUZsb2F0KHQpLnRvRXhwb25lbnRpYWwoKTticmVhaztjYXNlImYiOnQ9cy5wcmVjaXNpb24/cGFyc2VGbG9hdCh0KS50b0ZpeGVkKHMucHJlY2lzaW9uKTpwYXJzZUZsb2F0KHQpO2JyZWFrO2Nhc2UiZyI6dD1zLnByZWNpc2lvbj9TdHJpbmcoTnVtYmVyKHQudG9QcmVjaXNpb24ocy5wcmVjaXNpb24pKSk6cGFyc2VGbG9hdCh0KTticmVhaztjYXNlIm8iOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoOCk7YnJlYWs7Y2FzZSJzIjp0PVN0cmluZyh0KSx0PXMucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAscy5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ0Ijp0PVN0cmluZyghIXQpLHQ9cy5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxzLnByZWNpc2lvbik6dDticmVhaztjYXNlIlQiOnQ9T2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHQpLnNsaWNlKDgsLTEpLnRvTG93ZXJDYXNlKCksdD1zLnByZWNpc2lvbj90LnN1YnN0cmluZygwLHMucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UidSI6dD1wYXJzZUludCh0LDEwKT4+PjA7YnJlYWs7Y2FzZSJ2Ijp0PXQudmFsdWVPZigpLHQ9cy5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxzLnByZWNpc2lvbik6dDticmVhaztjYXNlIngiOnQ9KHBhcnNlSW50KHQsMTApPj4+MCkudG9TdHJpbmcoMTYpO2JyZWFrO2Nhc2UiWCI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKX1yLmpzb24udGVzdChzLnR5cGUpP2crPXQ6KCFyLm51bWJlci50ZXN0KHMudHlwZSl8fGYmJiFzLnNpZ24/cD0iIjoocD1mPyIrIjoiLSIsdD10LnRvU3RyaW5nKCkucmVwbGFjZShyLnNpZ24sIiIpKSx1PXMucGFkX2NoYXI/IjAiPT09cy5wYWRfY2hhcj8iMCI6cy5wYWRfY2hhci5jaGFyQXQoMSk6IiAiLGw9cy53aWR0aC0ocCt0KS5sZW5ndGgsYT1zLndpZHRoJiZsPjA/dS5yZXBlYXQobCk6IiIsZys9cy5hbGlnbj9wK3QrYToiMCI9PT11P3ArYSt0OmErcCt0KX1yZXR1cm4gZ30oZnVuY3Rpb24oZSl7aWYoc1tlXSlyZXR1cm4gc1tlXTt2YXIgbix0PWUsbz1bXSxpPTA7Zm9yKDt0Oyl7aWYobnVsbCE9PShuPXIudGV4dC5leGVjKHQpKSlvLnB1c2goblswXSk7ZWxzZSBpZihudWxsIT09KG49ci5tb2R1bG8uZXhlYyh0KSkpby5wdXNoKCIlIik7ZWxzZXtpZihudWxsPT09KG49ci5wbGFjZWhvbGRlci5leGVjKHQpKSl0aHJvdyBuZXcgU3ludGF4RXJyb3IoIltzcHJpbnRmXSB1bmV4cGVjdGVkIHBsYWNlaG9sZGVyIik7aWYoblsyXSl7aXw9MTt2YXIgYz1bXSxhPW5bMl0sdT1bXTtpZihudWxsPT09KHU9ci5rZXkuZXhlYyhhKSkpdGhyb3cgbmV3IFN5bnRheEVycm9yKCJbc3ByaW50Zl0gZmFpbGVkIHRvIHBhcnNlIG5hbWVkIGFyZ3VtZW50IGtleSIpO2ZvcihjLnB1c2godVsxXSk7IiIhPT0oYT1hLnN1YnN0cmluZyh1WzBdLmxlbmd0aCkpOylpZihudWxsIT09KHU9ci5rZXlfYWNjZXNzLmV4ZWMoYSkpKWMucHVzaCh1WzFdKTtlbHNle2lmKG51bGw9PT0odT1yLmluZGV4X2FjY2Vzcy5leGVjKGEpKSl0aHJvdyBuZXcgU3ludGF4RXJyb3IoIltzcHJpbnRmXSBmYWlsZWQgdG8gcGFyc2UgbmFtZWQgYXJndW1lbnQga2V5Iik7Yy5wdXNoKHVbMV0pfW5bMl09Y31lbHNlIGl8PTI7aWYoMz09PWkpdGhyb3cgbmV3IEVycm9yKCJbc3ByaW50Zl0gbWl4aW5nIHBvc2l0aW9uYWwgYW5kIG5hbWVkIHBsYWNlaG9sZGVycyBpcyBub3QgKHlldCkgc3VwcG9ydGVkIik7by5wdXNoKHtwbGFjZWhvbGRlcjpuWzBdLHBhcmFtX25vOm5bMV0sa2V5czpuWzJdLHNpZ246blszXSxwYWRfY2hhcjpuWzRdLGFsaWduOm5bNV0sd2lkdGg6bls2XSxwcmVjaXNpb246bls3XSx0eXBlOm5bOF19KX10PXQuc3Vic3RyaW5nKG5bMF0ubGVuZ3RoKX1yZXR1cm4gc1tlXT1vfShlKSxhcmd1bWVudHMpfWZ1bmN0aW9uIGMoZSxuKXtyZXR1cm4gaS5hcHBseShudWxsLFtlXS5jb25jYXQobnx8W10pKX12YXIgcz1PYmplY3QuY3JlYXRlKG51bGwpO24uc3ByaW50Zj1pLG4udnNwcmludGY9YywidW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdyYmKHdpbmRvdy5zcHJpbnRmPWksd2luZG93LnZzcHJpbnRmPWMsdm9pZCAwPT09KG89ZnVuY3Rpb24oKXtyZXR1cm57c3ByaW50ZjppLHZzcHJpbnRmOmN9fS5jYWxsKG4sdCxuLGUpKXx8KGUuZXhwb3J0cz1vKSl9KCl9LGZ1bmN0aW9uKGUsbix0KXsidXNlIHN0cmljdCI7dC5yKG4pLGZ1bmN0aW9uKGUpe3QuZChuLCJXZWJTb2NrZXRNYW5hZ2VyIixmdW5jdGlvbigpe3JldHVybiByfSk7dmFyIG89dCgwKTtlLmNvbm5lY3Q9ZS5jb25uZWN0fHx7fSxjb25uZWN0LldlYlNvY2tldE1hbmFnZXI9by5hO3ZhciByPW8uYX0uY2FsbCh0aGlzLHQoMykpfSxmdW5jdGlvbihlLG4pe3ZhciB0O3Q9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpc30oKTt0cnl7dD10fHxuZXcgRnVuY3Rpb24oInJldHVybiB0aGlzIikoKX1jYXRjaChlKXsib2JqZWN0Ij09dHlwZW9mIHdpbmRvdyYmKHQ9d2luZG93KX1lLmV4cG9ydHM9dH1dKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9YW1hem9uLWNvbm5lY3Qtd2Vic29ja2V0LW1hbmFnZXIuanMubWFwCgoKLyoqKi8gfSksCgovKioqLyAxNTE6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAvLyBIb3cgZnJlcXVlbnRseSBzb2Z0cGhvbmUgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCByZXBvcnRlZCB0byBzaGFyZWQgd29ya2VyLgogIHZhciBTT0ZUUEhPTkVfTE9HX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMgPSA1MDAwOwoKICAvLyBIb3cgZnJlcXVlbnRseSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIHNlbnQgZG93bnN0cmVhbQogIHZhciBMT0dTX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMgPSA1MDAwOwoKICAvLyBUaGUgZGVmYXVsdCBsb2cgcm9sbCBpbnRlcnZhbCAoMzBtaW4pCiAgdmFyIERFRkFVTFRfTE9HX1JPTExfSU5URVJWQUwgPSAxODAwMDAwOwoKICAvKioKICAgKiBBbiBlbnVtZXJhdGlvbiBvZiBjb21tb24gbG9nZ2luZyBsZXZlbHMuCiAgICovCiAgdmFyIExvZ0xldmVsID0gewogICAgVEVTVDogIlRFU1QiLAogICAgVFJBQ0U6ICJUUkFDRSIsCiAgICBERUJVRzogIkRFQlVHIiwKICAgIElORk86ICJJTkZPIiwKICAgIExPRzogIkxPRyIsCiAgICBXQVJOOiAiV0FSTiIsCiAgICBFUlJPUjogIkVSUk9SIiwKICAgIENSSVRJQ0FMOiAiQ1JJVElDQUwiCiAgfTsKCiAgLyoqCiAgICogQW4gZW51bWVyYXRpb24gb2YgY29tbW9uIGxvZ2dpbmcgY29tcG9uZW50cy4KICAgKi8KICB2YXIgTG9nQ29tcG9uZW50ID0gewogICAgQ0NQOiAiY2NwIiwKICAgIFNPRlRQSE9ORTogInNvZnRwaG9uZSIsCiAgICBDSEFUOiAiY2hhdCIsCiAgICBUQVNLOiAidGFzayIKICB9OwoKICAvKioKICAgKiBUaGUgbnVtZXJpYyBvcmRlciBvZiB0aGUgbG9nZ2luZyBsZXZlbHMgYWJvdmUuCiAgICogVGhleSBhcmUgc3BhY2VkIHRvIGFsbG93IHRoZSBhZGRpdGlvbiBvZiBvdGhlciBsb2cKICAgKiBsZXZlbHMgYXQgYSBsYXRlciB0aW1lLgogICAqLwogIHZhciBMb2dMZXZlbE9yZGVyID0gewogICAgVEVTVDogMCwKICAgIFRSQUNFOiAxMCwKICAgIERFQlVHOiAyMCwKICAgIElORk86IDMwLAogICAgTE9HOiA0MCwKICAgIFdBUk46IDUwLAogICAgRVJST1I6IDEwMCwKICAgIENSSVRJQ0FMOiAyMDAKCiAgfTsKCiAgLyoqCiAgICogQSBtYXAgZnJvbSBsb2cgbGV2ZWwgdG8gY29uc29sZSBsb2dnZXIgZnVuY3Rpb24uCiAgICovCiAgdmFyIENPTlNPTEVfTE9HR0VSX01BUCA9IHsKICAgIFRSQUNFOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmluZm8odGV4dCk7IH0sCiAgICBERUJVRzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgSU5GTzogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5pbmZvKHRleHQpOyB9LAogICAgTE9HOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwKICAgIFRFU1Q6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUubG9nKHRleHQpOyB9LAogICAgV0FSTjogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS53YXJuKHRleHQpOyB9LAogICAgRVJST1I6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuZXJyb3IodGV4dCk7IH0sCiAgICBDUklUSUNBTDogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5lcnJvcih0ZXh0KTsgfQogIH07CgogIC8qKgogICogQ2hlY2tzIGlmIGl0IGlzIGEgdmFsaWQgbG9nIGNvbXBvbmVudCBlbnVtCiAgKi8KCiAgdmFyIGlzVmFsaWRMb2dDb21wb25lbnQgPSBmdW5jdGlvbiAoY29tcG9uZW50KSB7CiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhMb2dDb21wb25lbnQpLmluZGV4T2YoY29tcG9uZW50KSAhPT0gLTE7CiAgfTsKCiAgLyoqCiAgKiBFeHRyYWN0IHRoZSBjdXN0b20gYXJndW1lbnRzIGFzIHJlcXVpcmVkIGJ5IHRoZSBsb2dnZXIKICAqLwogIHZhciBleHRyYWN0TG9nZ2VyQXJncyA9IGZ1bmN0aW9uIChsb2dnZXJBcmdzKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGxvZ2dlckFyZ3MsIDApOwogICAgdmFyIGZpcnN0QXJnID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGZvcm1hdDsKICAgIHZhciBjb21wb25lbnQ7CgogICAgaWYgKGlzVmFsaWRMb2dDb21wb25lbnQoZmlyc3RBcmcpKSB7CiAgICAgIGNvbXBvbmVudCA9IGZpcnN0QXJnOwogICAgICBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB9IGVsc2UgewogICAgICAvL2RlZmF1bHQgdG8gQ0NQIGNvbXBvbmVudAogICAgICBmb3JtYXQgPSBmaXJzdEFyZzsKICAgICAgY29tcG9uZW50ID0gTG9nQ29tcG9uZW50LkNDUDsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBmb3JtYXQ6IGZvcm1hdCwKICAgICAgY29tcG9uZW50OiBjb21wb25lbnQsCiAgICAgIGFyZ3M6IGFyZ3MKICAgIH07CiAgfTsKCiAgLyoqCiAgICogQSBsb2cgZW50cnkuCiAgICoKICAgKiBAcGFyYW0gY29tcG9uZW50IFRoZSBsb2dnaW5nIGNvbXBvbmVudC4KICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxvZyBsZXZlbCBvZiB0aGlzIGxvZyBlbnRyeS4KICAgKiBAcGFyYW0gdGV4dCBUaGUgdGV4dCBjb250YWluZWQgaW4gdGhlIGxvZyBlbnRyeS4KICAgKiBAcGFyYW0gbG9nZ2VySWQgVGhlIHJvb3QgbG9nZ2VyIGlkLgogICAqCiAgICogTG9nIGVudHJpZXMgYXJlIGF3YXJlIG9mIHRoZWlyIHRpbWVzdGFtcCwgb3JkZXIsCiAgICogYW5kIGNhbiBjb250YWluIG9iamVjdHMgYW5kIGV4Y2VwdGlvbiBzdGFjayB0cmFjZXMuCiAgICovCiAgdmFyIExvZ0VudHJ5ID0gZnVuY3Rpb24gKGNvbXBvbmVudCwgbGV2ZWwsIHRleHQsIGxvZ2dlcklkKSB7CiAgICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudDsKICAgIHRoaXMubGV2ZWwgPSBsZXZlbDsKICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICB0aGlzLnRpbWUgPSBuZXcgRGF0ZSgpOwogICAgdGhpcy5leGNlcHRpb24gPSBudWxsOwogICAgdGhpcy5vYmplY3RzID0gW107CiAgICB0aGlzLmxpbmUgPSAwOwogICAgdGhpcy5hZ2VudFJlc291cmNlSWQgPSBudWxsOwogICAgdHJ5IHsKICAgICAgaWYgKGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQpewogICAgICAgIHRoaXMuYWdlbnRSZXNvdXJjZUlkID0gbmV3IGNvbm5lY3QuQWdlbnQoKS5fZ2V0UmVzb3VyY2VJZCgpOwogICAgICB9CiAgICB9IGNhdGNoKGUpIHsKICAgICAgY29uc29sZS5sb2coIklzc3VlIGZpbmRpbmcgYWdlbnRSZXNvdXJjZUlkOiAiLCBlKTsgLy9jYW4ndCB1c2Ugb3VyIGxvZ2dlciBoZXJlIGFzIHdlIG1pZ2h0IGluZmluaXRlbHkgYXR0ZW1wdCB0byBsb2cgdGhpcyBlcnJvci4KICAgIH0KICAgIHRoaXMubG9nZ2VySWQgPSBsb2dnZXJJZDsKICB9OwoKICBMb2dFbnRyeS5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGVudHJ5ID0gbmV3IExvZ0VudHJ5KExvZ0NvbXBvbmVudC5DQ1AsIG9iai5sZXZlbCwgb2JqLnRleHQsIG9iai5sb2dnZXJJZCk7CgogICAgLy8gUmVxdWlyZWQgdG8gY2hlY2sgZm9yIERhdGUgb2JqZWN0cyBzZW50IGFjcm9zcyBmcmFtZSBib3VuZGFyaWVzCiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iai50aW1lKSA9PT0gJ1tvYmplY3QgRGF0ZV0nKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZShvYmoudGltZS5nZXRUaW1lKCkpOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnRpbWUgPT09ICdudW1iZXInKSB7CiAgICAgIGVudHJ5LnRpbWUgPSBuZXcgRGF0ZShvYmoudGltZSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmoudGltZSA9PT0gJ3N0cmluZycpIHsKICAgICAgZW50cnkudGltZSA9IERhdGUucGFyc2Uob2JqLnRpbWUpOwogICAgfSBlbHNlIHsKICAgICAgZW50cnkudGltZSA9IG5ldyBEYXRlKCk7CiAgICB9CiAgICBlbnRyeS5leGNlcHRpb24gPSBvYmouZXhjZXB0aW9uOwogICAgZW50cnkub2JqZWN0cyA9IG9iai5vYmplY3RzOwogICAgcmV0dXJuIGVudHJ5OwogIH07CgogIC8qKgogICAqIFByaXZhdGUgbWV0aG9kIHRvIHJlbW92ZSBzZW5zaXRpdmUgaW5mbyBmcm9tIGNsaWVudCBsb2cKICAgKi8KICB2YXIgcmVkYWN0U2Vuc2l0aXZlSW5mbyA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHZhciByZWdleCA9IC9BdXRoVG9rZW4uKlw9L2c7CiAgICBpZihkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JykgewogICAgICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewogICAgICAgIGlmICh0eXBlb2YgZGF0YVtrZXldID09PSAnb2JqZWN0JykgewogICAgICAgICAgcmVkYWN0U2Vuc2l0aXZlSW5mbyhkYXRhW2tleV0pCiAgICAgICAgfSBlbHNlIGlmKHR5cGVvZiBkYXRhW2tleV0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBpZiAoa2V5ID09PSAidXJsIiB8fCBrZXkgPT09ICJ0ZXh0IikgewogICAgICAgICAgICBkYXRhW2tleV0gPSBkYXRhW2tleV0ucmVwbGFjZShyZWdleCwgIltyZWRhY3RlZF0iKTsKICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAicXVpY2tDb25uZWN0TmFtZSIpIHsKICAgICAgICAgICAgZGF0YVtrZXldID0gIltyZWRhY3RlZF0iOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7IAogICAgfQogIH0KCiAgLyoqCiAgICogUHVsbHMgdGhlIHR5cGUsIG1lc3NhZ2UsIGFuZCBzdGFjayB0cmFjZQogICAqIG91dCBvZiB0aGUgZ2l2ZW4gZXhjZXB0aW9uIGZvciBKU09OIHNlcmlhbGl6YXRpb24uCiAgICovCiAgdmFyIExvZ2dlZEV4Y2VwdGlvbiA9IGZ1bmN0aW9uIChlKSB7CiAgICB0aGlzLnR5cGUgPSAoZSBpbnN0YW5jZW9mIEVycm9yKSA/IGUubmFtZSA6IGUuY29kZSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZSk7CiAgICB0aGlzLm1lc3NhZ2UgPSBlLm1lc3NhZ2U7CiAgICB0aGlzLnN0YWNrID0gW107CiAgICBpZiAoZS5zdGFjayl7CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlLnN0YWNrKSkgewogICAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBlLnN0YWNrOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZS5zdGFjayA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gW0pTT04uc3RyaW5naWZ5KGUuc3RhY2spXTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGUuc3RhY2sgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgdGhpcy5zdGFjayA9IGUuc3RhY2suc3BsaXQoJ1xuJyk7CiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2gge30KICAgIH0KICB9OwoKICAvKioKICAgKiBNaW5pbWFsbHkgc3RyaW5naWZ5IHRoaXMgbG9nIGVudHJ5IGZvciBwcmludGluZwogICAqIHRvIHRoZSBjb25zb2xlLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIlslc10gWyVzXSBbJXNdOiAlcyIsCiAgICAgIHRoaXMuZ2V0VGltZSgpICYmIHRoaXMuZ2V0VGltZSgpLnRvSVNPU3RyaW5nID8gdGhpcy5nZXRUaW1lKCkudG9JU09TdHJpbmcoKSA6ICI/Pz8iLAogICAgICB0aGlzLmdldExldmVsKCksCiAgICAgIHRoaXMuZ2V0QWdlbnRSZXNvdXJjZUlkKCksCiAgICAgIHRoaXMuZ2V0VGV4dCgpKTsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSB0aW1lc3RhbXAuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldFRpbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy50aW1lOwogIH07CgogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRBZ2VudFJlc291cmNlSWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5hZ2VudFJlc291cmNlSWQ7CiAgfQoKICAvKioKICAgKiBHZXQgdGhlIGxldmVsIG9mIHRoZSBsb2cgZW50cnkuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldExldmVsID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubGV2ZWw7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsb2cgZW50cnkgdGV4dC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0VGV4dCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnRleHQ7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsb2cgZW50cnkgY29tcG9uZW50LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRDb21wb25lbnQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb21wb25lbnQ7CiAgfTsKCiAgLyoqCiAgICogQWRkIGFuIGV4Y2VwdGlvbiBzdGFjayB0cmFjZSB0byB0aGlzIGxvZyBlbnRyeS4KICAgKiBBIGxvZyBlbnRyeSBtYXkgY29udGFpbiBvbmx5IG9uZSBleGNlcHRpb24gc3RhY2sgdHJhY2UuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLndpdGhFeGNlcHRpb24gPSBmdW5jdGlvbiAoZSkgewogICAgdGhpcy5leGNlcHRpb24gPSBuZXcgTG9nZ2VkRXhjZXB0aW9uKGUpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogQWRkIGFuIGFyYml0cmFyeSBvYmplY3QgdG8gdGhlIGxvZyBlbnRyeS4gIEEgbG9nIGVudHJ5CiAgICogbWF5IGNvbnRhaW4gYW55IG51bWJlciBvZiBvYmplY3RzLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcGllZE9iaiA9IGNvbm5lY3QuZGVlcGNvcHkob2JqKTsKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oY29waWVkT2JqKTsKICAgIHRoaXMub2JqZWN0cy5wdXNoKGNvcGllZE9iaik7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBBZGQgYSBjcm9zcyBvcmlnaW4gZXZlbnQgb2JqZWN0IHRvIHRoZSBsb2cgZW50cnkuICBBIGxvZyBlbnRyeQogICAqIG1heSBjb250YWluIGFueSBudW1iZXIgb2Ygb2JqZWN0cy4KICAgKi8KICAgTG9nRW50cnkucHJvdG90eXBlLndpdGhDcm9zc09yaWdpbkV2ZW50T2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcGllZE9iaiA9IGNvbm5lY3QuZGVlcGNvcHlDcm9zc09yaWdpbkV2ZW50KG9iaik7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGNvcGllZE9iaik7CiAgICB0aGlzLm9iamVjdHMucHVzaChjb3BpZWRPYmopOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogSW5kaWNhdGUgdGhhdCB0aGlzIGxvZyBlbnRyeSBzaG91bGQgYmUgc2VudCB0byB0aGUgc2VydmVyCiAgICogTk9URTogVGhpcyBzaG91bGQgYmUgdXNlZCBmb3IgaW50ZXJuYWwgbG9ncyBvbmx5CiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MucHVzaCh0aGlzKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIFRoZSBsb2dnZXIgaW5zdGFuY2UuCiAgICovCiAgdmFyIExvZ2dlciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX2xvZ3MgPSBbXTsKICAgIHRoaXMuX3JvbGxlZExvZ3MgPSBbXTsKICAgIHRoaXMuX2xvZ3NUb1B1c2ggPSBbXTsKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9sb2dMZXZlbCA9IExvZ0xldmVsT3JkZXIuSU5GTzsKICAgIHRoaXMuX2xpbmVDb3VudCA9IDA7CiAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSAwOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICAgIHRoaXMuX2xvZ2dlcklkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiLSIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgIHRoaXMuc2V0TG9nUm9sbEludGVydmFsKERFRkFVTFRfTE9HX1JPTExfSU5URVJWQUwpOwogICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IDA7CiAgfTsKCiAgLyoqCiAgICogU2V0cyB0aGUgaW50ZXJ2YWwgaW4gbWlsbGlzZWNvbmRzIHRoYXQgdGhlIGxvZ3Mgd2lsbCBiZSByb3RhdGVkLgogICAqIExvZ3MgYXJlIHJvdGF0ZWQgb3V0IGNvbXBsZXRlbHkgYXQgdGhlIGVuZCBvZiB0aGUgc2Vjb25kIHJvbGwKICAgKiBhbmQgd2lsbCBldmVudHVhbGx5IGJlIGdhcmJhZ2UgY29sbGVjdGVkLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0TG9nUm9sbEludGVydmFsID0gZnVuY3Rpb24gKGludGVydmFsKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgaWYgKCEodGhpcy5fbG9nUm9sbFRpbWVyKSB8fCBpbnRlcnZhbCAhPT0gdGhpcy5fbG9nUm9sbEludGVydmFsKSB7CiAgICAgIGlmICh0aGlzLl9sb2dSb2xsVGltZXIpIHsKICAgICAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbCh0aGlzLl9sb2dSb2xsVGltZXIpOwogICAgICB9CiAgICAgIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCA9IGludGVydmFsOwogICAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBnbG9iYWwuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuX3JvbGxlZExvZ3MgPSB0aGlzLl9sb2dzOwogICAgICAgIHRoaXMuX2xvZ3MgPSBbXTsKICAgICAgICB0aGlzLl9zdGFydExvZ0luZGV4VG9QdXNoID0gMDsKICAgICAgICBzZWxmLmluZm8oIkxvZyByb2xsIGludGVydmFsIG9jY3VycmVkLiIpOwogICAgICB9LCB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy53YXJuKCJMb2dnZXIgaXMgYWxyZWFkeSBzZXQgdG8gdGhlIGdpdmVuIGludGVydmFsOiAlZCIsIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2V0IHRoZSBsb2cgbGV2ZWwuICBUaGlzIGlzIHRoZSBtaW5pbXVtIGxldmVsIGF0IHdoaWNoIGxvZ3Mgd2lsbAogICAqIGJlIGtlcHQgZm9yIGxhdGVyIGFyY2hpdmluZy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldExvZ0xldmVsID0gZnVuY3Rpb24gKGxldmVsKSB7CiAgICBpZiAobGV2ZWwgaW4gTG9nTGV2ZWxPcmRlcikgewogICAgICB0aGlzLl9sb2dMZXZlbCA9IExvZ0xldmVsT3JkZXJbbGV2ZWxdOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGxvZ2dpbmcgbGV2ZWw6ICIgKyBsZXZlbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2V0IHRoZSBlY2hvIGxldmVsLiAgVGhpcyBpcyB0aGUgbWluaW11bSBsZXZlbCBhdCB3aGljaCBsb2dzIHdpbGwKICAgKiBiZSBwcmludGVkIHRvIHRoZSBqYXZhc2NyaXB0IGNvbnNvbGUuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRFY2hvTGV2ZWwgPSBmdW5jdGlvbiAobGV2ZWwpIHsKICAgIGlmIChsZXZlbCBpbiBMb2dMZXZlbE9yZGVyKSB7CiAgICAgIHRoaXMuX2VjaG9MZXZlbCA9IExvZ0xldmVsT3JkZXJbbGV2ZWxdOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGxvZ2dpbmcgbGV2ZWw6ICIgKyBsZXZlbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogV3JpdGUgYSBwYXJ0aWN1bGFyIGxvZyBlbnRyeS4KICAgKgogICAqIEBwYXJhbSBsZXZlbCBUaGUgbG9nZ2luZyBsZXZlbCBvZiB0aGUgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGVudHMgb2YgdGhlIGVudHJ5LgogICAqCiAgICogQHJldHVybnMgVGhlIG5ldyBsb2cgZW50cnkuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0KSB7CiAgICB2YXIgbG9nRW50cnkgPSBuZXcgTG9nRW50cnkoY29tcG9uZW50LCBsZXZlbCwgdGV4dCwgdGhpcy5nZXRMb2dnZXJJZCgpKTsKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8obG9nRW50cnkpOwogICAgdGhpcy5hZGRMb2dFbnRyeShsb2dFbnRyeSk7CiAgICByZXR1cm4gbG9nRW50cnk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5hZGRMb2dFbnRyeSA9IGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgLy8gQ2FsbCB0aGlzIHNlY29uZCB0aW1lIGFzIGluIHNvbWUgcGxhY2VzIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGRpcmVjdGx5CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGxvZ0VudHJ5KTsKICAgIHRoaXMuX2xvZ3MucHVzaChsb2dFbnRyeSk7CgogICAgLy9Gb3Igbm93IG9ubHkgc2VuZCBzb2Z0cGhvbmUgbG9ncyBvbmx5LgogICAgLy9UT0RPIGFkZCBDQ1AgbG9ncyBvbmNlIHdlIGFyZSBzdXJlIHRoYXQgbm8gc2Vuc2l0aXZlIGRhdGEgaXMgYmVpbmcgbG9nZ2VkLgogICAgaWYgKExvZ0NvbXBvbmVudC5TT0ZUUEhPTkUgPT09IGxvZ0VudHJ5LmNvbXBvbmVudCkgewogICAgICB0aGlzLl9sb2dzVG9QdXNoLnB1c2gobG9nRW50cnkpOwogICAgfQoKICAgIGlmIChsb2dFbnRyeS5sZXZlbCBpbiBMb2dMZXZlbE9yZGVyICYmCiAgICAgIExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2xvZ0xldmVsKSB7CgogICAgICBpZiAoTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fZWNob0xldmVsKSB7CiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQW2xvZ0VudHJ5LmdldExldmVsKCldKGxvZ0VudHJ5LnRvU3RyaW5nKCkpOwogICAgICB9CgogICAgICBsb2dFbnRyeS5saW5lID0gdGhpcy5fbGluZUNvdW50Kys7CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyID0gZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5wdXNoKGxvZ0VudHJ5KTsKCiAgICBpZiAobG9nRW50cnkubGV2ZWwgaW4gTG9nTGV2ZWxPcmRlciAmJgogICAgICBMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9sb2dMZXZlbCkgewoKICAgICAgaWYgKExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2VjaG9MZXZlbCkgewogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUFtsb2dFbnRyeS5nZXRMZXZlbCgpXShsb2dFbnRyeS50b1N0cmluZygpKTsKICAgICAgfQoKICAgICAgbG9nRW50cnkubGluZSA9IHRoaXMuX2xpbmVDb3VudCsrOwogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgb2JqZWN0cyBmcm9tIGFsbCBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyT2JqZWN0cyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5vYmplY3RzKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ3NbeF0ub2JqZWN0czsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgZXhjZXB0aW9uIHN0YWNrIHRyYWNlcyBmcm9tIHRoZSBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyRXhjZXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5leGNlcHRpb24pIHsKICAgICAgICBkZWxldGUgdGhpcy5fbG9nc1t4XS5leGNlcHRpb247CiAgICAgIH0KICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRyYWNlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLlRSQUNFLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkRFQlVHLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuSU5GTywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuTE9HLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuVEVTVCwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS53YXJuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLldBUk4sIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuY3JpdGljYWwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIC8qKgogICAqIENyZWF0ZSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgbG9nZ2VyIGNvbnRlbnRzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbGluZXMgPSBbXTsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBsaW5lcy5wdXNoKHRoaXMuX2xvZ3NbeF0udG9TdHJpbmcoKSk7CiAgICB9CgogICAgcmV0dXJuIGxpbmVzLmpvaW4oIlxuIik7CiAgfTsKICAKICAvKioKICAgKiBEb3dubG9hZC9BcmNoaXZlIGxvZ3MgdG8gYSBmaWxlLCAKICAgKiBCeSBkZWZhdWx0LCBpdCByZXR1cm5zIGFsbCBsb2dzLgogICAqIFRvIGZpbHRlciBsb2dzIGJ5IHRoZSBtaW5pbXVtIGxvZyBsZXZlbCBzZXQgYnkgc2V0TG9nTGV2ZWwgb3IgdGhlIGRlZmF1bHQgc2V0IGluIF9sb2dMZXZlbCwgCiAgICogcGFzcyBpbiBmaWx0ZXJCeUxvZ0xldmVsIHRvIHRydWUgaW4gb3B0aW9ucwogICAqIAogICAqIEBwYXJhbSBvcHRpb25zIGRvd25sb2FkIG9wdGlvbnMgW09iamVjdHxTdHJpbmddLiAKICAgKiAtIG9mIHR5cGUgT2JqZWN0OiAKICAgKiAgIHsgbG9nTmFtZTogJ215LWxvZy1uYW1lJywKICAgKiAgICAgZmlsdGVyQnlMb2dMZXZlbDogZmFsc2UsIC8vZG93bmxvYWQgYWxsIGxvZ3MKICAgKiAgIH0KICAgKiAtIG9mIHR5cGUgU3RyaW5nIChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSksIHRoZSBmaWxlJ3MgbmFtZQogICAqLwogIExvZ2dlci5wcm90b3R5cGUuZG93bmxvYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgbG9nTmFtZSA9ICdhZ2VudC1sb2cnOwogICAgdmFyIGZpbHRlckJ5TG9nTGV2ZWwgPSBmYWxzZTsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zLmxvZ05hbWUgfHwgbG9nTmFtZTsKICAgICAgZmlsdGVyQnlMb2dMZXZlbCA9IG9wdGlvbnMuZmlsdGVyQnlMb2dMZXZlbCB8fCBmaWx0ZXJCeUxvZ0xldmVsOwogICAgfQogICAgZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zIHx8IGxvZ05hbWU7CiAgICB9CgogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ3MgPSB0aGlzLl9yb2xsZWRMb2dzLmNvbmNhdCh0aGlzLl9sb2dzKTsKICAgIGlmIChmaWx0ZXJCeUxvZ0xldmVsKSB7CiAgICAgIGxvZ3MgPSBsb2dzLmZpbHRlcihmdW5jdGlvbihlbnRyeSkgewogICAgICAgIHJldHVybiBMb2dMZXZlbE9yZGVyW2VudHJ5LmxldmVsXSA+PSBzZWxmLl9sb2dMZXZlbDsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIGxvZ0Jsb2IgPSBuZXcgZ2xvYmFsLkJsb2IoW0pTT04uc3RyaW5naWZ5KGxvZ3MsIHVuZGVmaW5lZCwgNCldLCBbJ3RleHQvcGxhaW4nXSk7CiAgICB2YXIgZG93bmxvYWRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgdmFyIGxvZ05hbWUgPSBsb2dOYW1lIHx8ICdhZ2VudC1sb2cnOwogICAgZG93bmxvYWRMaW5rLmhyZWYgPSBnbG9iYWwuVVJMLmNyZWF0ZU9iamVjdFVSTChsb2dCbG9iKTsKICAgIGRvd25sb2FkTGluay5kb3dubG9hZCA9IGxvZ05hbWUgKyAnLnR4dCc7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRvd25sb2FkTGluayk7CiAgICBkb3dubG9hZExpbmsuY2xpY2soKTsKICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZG93bmxvYWRMaW5rKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIGlmICghY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQpIHsKICAgICAgY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQgPSB0cnVlOwogICAgICAvKiogU2NoZWR1bGUgcHVzaGluZyBsb2dzIGZyZXF1ZW50bHkgdG8gc2hhcmVkd29ya2VyIHVwc3RyZWFtLCBzaGFyZWR3b3JrZXIgd2lsbCByZXBvcnQgdG8gdGhlIENUSSBiYWNrZW5kKi8KICAgICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5yZXBvcnRNYXN0ZXJMb2dzVXBTdHJlYW0sIGNvbmR1aXQpLCBTT0ZUUEhPTkVfTE9HX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMpOwogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUucmVwb3J0TWFzdGVyTG9nc1VwU3RyZWFtID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIHZhciBsb2dzVG9QdXNoID0gdGhpcy5fbG9nc1RvUHVzaC5zbGljZSgpOwogICAgdGhpcy5fbG9nc1RvUHVzaCA9IFtdOwogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGxvZ3NUb1B1c2gubGVuZ3RoID4gMCkgewogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFTkRfTE9HUywgbG9nc1RvUHVzaCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1B1c2ggPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnB1c2hPdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NVcHN0cmVhbSwgY29uZHVpdCksIDEwMDApOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQTG9nc1B1c2ggPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnB1c2hPdXRlckNvbnRleHRDQ1BMb2dzVXBzdHJlYW0sIGNvbmR1aXQpLCAxMDAwKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaE91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1Vwc3RyZWFtID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgaWYgKHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aCA+IDApIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldLnRleHQgPSB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nc1tpXS50ZXh0OwogICAgICB9CgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyk7CiAgICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB9CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hPdXRlckNvbnRleHRDQ1BMb2dzVXBzdHJlYW0gPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBmb3IgKHZhciBpID0gdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaDsgaSA8IHRoaXMuX2xvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbaV0ubG9nZ2VySWQgIT09IHRoaXMuX2xvZ2dlcklkKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCB0aGlzLl9sb2dzW2ldKTsKICAgIH0KICAgIHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2ggPSB0aGlzLl9sb2dzLmxlbmd0aDsKICB9CgogIExvZ2dlci5wcm90b3R5cGUuZ2V0TG9nZ2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9nZ2VySWQ7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZURvd25zdHJlYW1DbGllbnRTaWRlTG9nc1B1c2ggPSBmdW5jdGlvbiAoKSB7CiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnB1c2hDbGllbnRTaWRlTG9nc0Rvd25zdHJlYW0pLCBMT0dTX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMpOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoQ2xpZW50U2lkZUxvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ3MgPSBbXTsKCiAgICAvLyBXZSBkbyBub3Qgc2VuZCBhIHJlcXVlc3QgaWYgd2UgaGF2ZSBsZXNzIHRoYW4gNTAgcmVjb3JkcyBzbyB0aGF0IHdlIG1pbmltaXplIHRoZSBudW1iZXIgb2YKICAgIC8vIHJlcXVlc3RzIHBlciBzZWNvbmQuIAogICAgLy8gNTAwIGlzIHRoZSBtYXggd2UgYWNjZXB0IG9uIHRoZSBzZXJ2ZXIuIAogICAgLy8gV2UgY2hvc2UgNTAwIGJlY2F1c2UgdGhpcyBpcyB0aGUgbGltaXQgaW1wb3NlZCBieSBGaXJlaG9zZSBmb3IgYSBwdXQgYmF0Y2ggcmVxdWVzdAogICAgaWYgKHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aCA8IDUwKSB7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoID4gNTAwKSB7CiAgICAgIGxvZ3MgPSB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5zcGxpY2UoMCwgNTAwKTsKICAgIH0gZWxzZSB7CiAgICAgIGxvZ3MgPSB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nczsKICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICAgIH0KCiAgICBjb25uZWN0LnB1Ymxpc2hDbGllbnRTaWRlTG9ncyhsb2dzKTsKICB9CgogIHZhciBEb3duc3RyZWFtQ29uZHVpdExvZ2dlciA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBMb2dnZXIuY2FsbCh0aGlzKTsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICAKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX3B1c2hMb2dzRG93bnN0cmVhbSksCiAgICAgIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLkxPR19QVVNIX0lOVEVSVkFMKTsKCiAgICAvLyBEaXNhYmxlIGxvZyByb2xsaW5nLCB3ZSB3aWxsIHB1cmdlIG91ciBvd24gbG9ncyBvbmNlIHRoZXkgaGF2ZQogICAgLy8gYmVlbiBwdXNoZWQgZG93bnN0cmVhbS4KICAgIGdsb2JhbC5jbGVhckludGVydmFsKHRoaXMuX2xvZ1JvbGxUaW1lcik7CiAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBudWxsOwogIH07CiAgLy8gSG93IGZyZXF1ZW50bHkgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCBkZWxpdmVyZWQgZG93bnN0cmVhbS4KICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5MT0dfUFVTSF9JTlRFUlZBTCA9IDEwMDA7CiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShMb2dnZXIucHJvdG90eXBlKTsKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEb3duc3RyZWFtQ29uZHVpdExvZ2dlcjsKCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLnB1c2hMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uIChsb2dzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBsb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBsb2cpOwogICAgfSk7CiAgfTsKCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLl9wdXNoTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAKICAgIHRoaXMuX2xvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGxvZyk7CiAgICB9KTsKICAgIHRoaXMuX2xvZ3MgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nc1tpXSk7CiAgICB9CgogICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICB9OwoKICAvKioKICAgKiBXcmFwIGEgZnVuY3Rpb24gd2l0aCB0cnkgY2F0Y2ggYmxvY2sKICAgKi8KICB2YXIgdHJ5Q2F0Y2hXcmFwcGVyTWV0aG9kID0gZnVuY3Rpb24gKGZuKSB7CiAgICB2YXIgd3JhcHBlZGZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAvLyBTaW5jZSB0aGlzIHdyYXBzIExvZ2dlciBjbGFzcywgd2UgY2FuIG9ubHkgcHJpbnQgaXQgaW4gdGhlIGNvbnNvbGUgYW5kIGVhdCBpdC4KICAgICAgICBDT05TT0xFX0xPR0dFUl9NQVAuRVJST1IoZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB3cmFwcGVkZnVuY3Rpb247CiAgfQogIC8qKgogICAqIFRoaXMgaXMgYSB3cmFwcGVyIG1ldGhvZCB0byB3cmFwIGVhY2ggZnVuY3Rpb24KICAgKiBpbiBhbiBvYmplY3Qgd2l0aCB0cnkgY2F0Y2ggYmxvY2suCiAgICovCiAgdmFyIHRyeUNhdGNoV3JhcHBlck9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGZvciAodmFyIG1ldGhvZCBpbiBvYmopIHsKICAgICAgaWYgKHR5cGVvZihvYmpbbWV0aG9kXSkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBvYmpbbWV0aG9kXSA9IHRyeUNhdGNoV3JhcHBlck1ldGhvZChvYmpbbWV0aG9kXSk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKiBDcmVhdGUgdGhlIHNpbmdsZXRvbiBsb2dnZXIgaW5zdGFuY2UuICovCiAgY29ubmVjdC5yb290TG9nZ2VyID0gbmV3IExvZ2dlcigpOwogIHRyeUNhdGNoV3JhcHBlck9iamVjdChjb25uZWN0LnJvb3RMb2dnZXIpOwoKCiAgLyoqIEZldGNoIHRoZSBzaW5nbGV0b24gbG9nZ2VyIGluc3RhbmNlLiAqLwogIHZhciBnZXRMb2cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5yb290TG9nZ2VyOwogIH07CgogIGNvbm5lY3QgPSBjb25uZWN0IHx8IHt9OwogIGNvbm5lY3QuZ2V0TG9nID0gZ2V0TG9nOwogIGNvbm5lY3QuTG9nRW50cnkgPSBMb2dFbnRyeTsKICBjb25uZWN0LkxvZ2dlciA9IExvZ2dlcjsKICBjb25uZWN0LkxvZ0xldmVsID0gTG9nTGV2ZWw7CiAgY29ubmVjdC5Mb2dDb21wb25lbnQgPSBMb2dDb21wb25lbnQ7CiAgY29ubmVjdC5Eb3duc3RyZWFtQ29uZHVpdExvZ2dlciA9IERvd25zdHJlYW1Db25kdWl0TG9nZ2VyOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNDM5OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuQ2hhdE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChtZWRpYUluZm8sIG1ldGFkYXRhKSB7CiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5DSEFUOwoKICAgIHZhciBjcmVhdGVNZWRpYUluc3RhbmNlID0gZnVuY3Rpb24gKCkgewogICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgbWVkaWEgY29udHJvbGxlciBpbml0IiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgbWVkaWEgY29udHJvbGxlciBpbml0IikKICAgICAgICAud2l0aE9iamVjdChtZWRpYUluZm8pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICBjb25uZWN0LkNoYXRTZXNzaW9uLnNldEdsb2JhbENvbmZpZyh7CiAgICAgICAgbG9nZ2VyQ29uZmlnOiB7CiAgICAgICAgICBsb2dnZXI6IGxvZ2dlcgogICAgICAgIH0sCiAgICAgICAgcmVnaW9uOiBtZXRhZGF0YS5yZWdpb24KICAgICAgfSk7CgogICAgICAvKiogQ291bGQgYmUgYWxzbyBDVVNUT01FUiAtICBGb3Igbm93IHdlIGFyZSBjcmVhdGluZyBvbmx5IEFnZW50IGNvbm5lY3Rpb24gbWVkaWEgb2JqZWN0ICovCiAgICAgIHZhciBjb250cm9sbGVyID0gY29ubmVjdC5DaGF0U2Vzc2lvbi5jcmVhdGUoewogICAgICAgIGNoYXREZXRhaWxzOiBtZWRpYUluZm8sCiAgICAgICAgdHlwZTogIkFHRU5UIiwKICAgICAgICB3ZWJzb2NrZXRNYW5hZ2VyOiBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpCiAgICAgIH0pOwogICAgICAKICAgICAgdHJhY2tDaGF0Q29ubmVjdGlvblN0YXR1cyhjb250cm9sbGVyKTsKICAgICAgcmV0dXJuIGNvbnRyb2xsZXIKICAgICAgICAuY29ubmVjdCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQgZm9yIGNvbnRhY3RJZCAlcyIsIG1lZGlhSW5mby5jb250YWN0SWQpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgICAgICByZXR1cm4gY29udHJvbGxlcjsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIGZvciBjb250YWN0ICVzIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCkKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZXJyb3IpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQiLCBtZWRpYUluZm8uY29udGFjdElkLCBlcnJvcik7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9KTsKICAgIH07CgogICAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGRhdGE6IGRhdGEgfHwgbWVkaWFJbmZvCiAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgdHJhY2tDaGF0Q29ubmVjdGlvblN0YXR1cyA9IGZ1bmN0aW9uIChjb250cm9sbGVyKSB7CiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uQnJva2VuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyLmVycm9yKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIpCiAgICAgICAgICAud2l0aEV4Y2VwdGlvbihkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIiwgZGF0YSk7CiAgICAgIH0pOwoKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Fc3RhYmxpc2hlZChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIikKICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIsIGRhdGEpOwogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY3JlYXRlTWVkaWFJbnN0YW5jZSgpOwogICAgICB9CiAgICB9CiAgfQp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMjc5OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQW1hem9uIFNvZnR3YXJlIExpY2Vuc2UgKHRoZSAiTGljZW5zZSIpLiBZb3UgbWF5IG5vdCB1c2UKICogdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcwogKiBsb2NhdGVkIGF0CiAqCiAqICAgIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hc2wvCiAqCiAqIG9yIGluIHRoZSAibGljZW5zZSIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQKICogb24gYW4gIkFTIElTIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3MKICogb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zCiAqIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIGNvbm5lY3QuTWVkaWFGYWN0b3J5ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgLyoqIGNvbnRyb2xsZXIgaG9sZGVyICovCiAgICB2YXIgbWVkaWFDb250cm9sbGVycyA9IHt9OwogICAgdmFyIHRvQmVEZXN0cm95ZWQgPSBuZXcgU2V0KCk7CgogICAgdmFyIGxvZ2dlciA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICB2YXIgbG9nQ29tcG9uZW50ID0gY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVDsKCiAgICB2YXIgbWV0YWRhdGEgPSBjb25uZWN0Lm1lcmdlKHt9LCBwYXJhbXMpIHx8IHt9OwogICAgbWV0YWRhdGEucmVnaW9uID0gIG1ldGFkYXRhLnJlZ2lvbiB8fCAidXMtd2VzdC0yIjsgLy8gRGVmYXVsdCBpdCB0byB1cy13ZXN0LTIKCiAgICB2YXIgZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgdmFyIGNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25PYmouZ2V0Q29ubmVjdGlvbklkKCk7CiAgICAgIHZhciBtZWRpYUluZm8gPSBjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpOwogICAgICAvKiogaWYgd2UgZG8gbm90IGhhdmUgdGhlIG1lZGlhIGluZm8gdGhlbiBqdXN0IHJlamVjdCB0aGUgcmVxdWVzdCAqLwogICAgICBpZiAoIW1lZGlhSW5mbykgewogICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJNZWRpYSBpbmZvIGRvZXMgbm90IGV4aXN0IGZvciBhIG1lZGlhIHR5cGUgJXMiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgLndpdGhPYmplY3QoY29ubmVjdGlvbk9iaikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk1lZGlhIGluZm8gZG9lcyBub3QgZXhpc3QgZm9yIHRoaXMgY29ubmVjdGlvbiIpOwogICAgICB9CgogICAgICBpZiAoIW1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSkgewogICAgICAgIGxvZ2dlci5pbmZvKGxvZ0NvbXBvbmVudCwgIm1lZGlhIGNvbnRyb2xsZXIgb2YgdHlwZSAlcyBpbml0IiwgY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkKICAgICAgICAgIC53aXRoT2JqZWN0KGNvbm5lY3Rpb25PYmopLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgc3dpdGNoIChjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKSB7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLkNIQVQ6CiAgICAgICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gPSBuZXcgY29ubmVjdC5DaGF0TWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCksIG1ldGFkYXRhKS5nZXQoKTsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuU09GVFBIT05FOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWVkaWFDb250cm9sbGVyKGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFJbmZvKCkpLmdldCgpOwogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuVGFza01lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpKS5nZXQoKTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJVbnJlY29nbml6ZWQgbWVkaWEgdHlwZSAlcyAiLCBjb25uZWN0aW9uT2JqLmdldE1lZGlhVHlwZSgpKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXTsKICAgICAgfQogICAgfTsKCiAgICAvKiogQ2hlY2sgYWxsIHRoZSBhY3RpdmUgc3RhdGVzIGZvciB0aGUgY29ubmVjdGlvbiAqLwogICAgdmFyIGlmQ29ubmVjdGlvbkFjdGl2ZSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIHJldHVybiBjb25uZWN0aW9uT2JqLmlzQWN0aXZlKCk7CiAgICB9OwoKICAgIHZhciBnZXQgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICBpZiAoaWZDb25uZWN0aW9uQWN0aXZlKGNvbm5lY3Rpb25PYmopKSB7CiAgICAgICAgcmV0dXJuIGdldE1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZXN0cm95KGNvbm5lY3Rpb25PYmouZ2V0Q29ubmVjdGlvbklkKCkpOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTWVkaWEgQ29udHJvbGxlciBpcyBubyBsb25nZXIgYXZhaWxhYmxlIGZvciB0aGlzIGNvbm5lY3Rpb24iKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSAmJiAhdG9CZURlc3Ryb3llZC5oYXMoY29ubmVjdGlvbklkKSkgewogICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgbG9nQ29tcG9uZW50LAogICAgICAgICAgIkRlc3Ryb3lpbmcgbWVkaWFDb250cm9sbGVyIGZvciAlcyIsCiAgICAgICAgICBjb25uZWN0aW9uSWQKICAgICAgICApOwogICAgICAgIHRvQmVEZXN0cm95ZWQuYWRkKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdCiAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250cm9sbGVyLmNsZWFuVXAgPT09ICJmdW5jdGlvbiIpIGNvbnRyb2xsZXIuY2xlYW5VcCgpOwogICAgICAgICAgICBkZWxldGUgbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdOwogICAgICAgICAgICB0b0JlRGVzdHJveWVkLmRlbGV0ZShjb25uZWN0aW9uSWQpOwogICAgICAgICAgfSkKICAgICAgICAgIC5jYXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGVsZXRlIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXTsKICAgICAgICAgICAgdG9CZURlc3Ryb3llZC5kZWxldGUoY29ubmVjdGlvbklkKTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIGdldDogZ2V0LAogICAgICBkZXN0cm95OiBkZXN0cm95CiAgICB9OwogIH0KfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDQxODoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICAvLyBUT0RPIG1vdmUgc29mdHBob25lIGltcGxlbWVudGF0aW9ucyBoZXJlIC0gV2lsIGRvIHRoaXMgZm9yIEdBCiAgY29ubmVjdC5Tb2Z0cGhvbmVNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAobWVkaWFJbmZvKSB7CiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG1lZGlhSW5mbykKICAgICAgfQogICAgfQogIH0KfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDE4NzoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICBjb25uZWN0LlRhc2tNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAobWVkaWFJbmZvKSB7CiAgICB2YXIgbG9nZ2VyID0gY29ubmVjdC5nZXRMb2coKTsKICAgIHZhciBsb2dDb21wb25lbnQgPSBjb25uZWN0LkxvZ0NvbXBvbmVudC5UQVNLOwoKICAgIHZhciBjcmVhdGVNZWRpYUluc3RhbmNlID0gZnVuY3Rpb24gKCkgewogICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgbWVkaWEgY29udHJvbGxlciBpbml0IiwgbWVkaWFJbmZvLmNvbnRhY3RJZCk7CiAgICAgIGxvZ2dlcgogICAgICAgIC5pbmZvKGxvZ0NvbXBvbmVudCwgIlRhc2sgbWVkaWEgY29udHJvbGxlciBpbml0IikKICAgICAgICAud2l0aE9iamVjdChtZWRpYUluZm8pOwoKICAgICAgdmFyIGNvbnRyb2xsZXIgPSBjb25uZWN0LlRhc2tTZXNzaW9uLmNyZWF0ZSh7CiAgICAgICAgY29udGFjdElkOiBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IG1lZGlhSW5mby5pbml0aWFsQ29udGFjdElkLAogICAgICAgIHdlYnNvY2tldE1hbmFnZXI6IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCksCiAgICAgIH0pOwoKICAgICAgdHJhY2tUYXNrQ29ubmVjdGlvblN0YXR1cyhjb250cm9sbGVyKTsKCiAgICAgIHJldHVybiBjb250cm9sbGVyCiAgICAgICAgLmNvbm5lY3QoKQogICAgICAgIC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxvZ2dlci5pbmZvKAogICAgICAgICAgICBsb2dDb21wb25lbnQsCiAgICAgICAgICAgICJUYXNrIFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIGZvciBjb250YWN0SWQgJXMiLAogICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkCiAgICAgICAgICApOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KAogICAgICAgICAgICAiVGFzayBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm4gY29udHJvbGxlcjsKICAgICAgICB9KQogICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIGxvZ2dlcgogICAgICAgICAgICAuZXJyb3IoCiAgICAgICAgICAgICAgbG9nQ29tcG9uZW50LAogICAgICAgICAgICAgICJUYXNrIFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIGZvciBjb250YWN0ICVzIiwKICAgICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkCiAgICAgICAgICAgICkKICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZXJyb3IpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KAogICAgICAgICAgICAiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCIsCiAgICAgICAgICAgIG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgICAgIGVycm9yCiAgICAgICAgICApOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICBkYXRhOiBkYXRhIHx8IG1lZGlhSW5mbywKICAgICAgfSk7CiAgICB9OwoKICAgIHZhciB0cmFja1Rhc2tDb25uZWN0aW9uU3RhdHVzID0gZnVuY3Rpb24gKGNvbnRyb2xsZXIpIHsKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Ccm9rZW4oZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIKICAgICAgICAgIC5lcnJvcihsb2dDb21wb25lbnQsICJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iKQogICAgICAgICAgLndpdGhFeGNlcHRpb24oZGF0YSk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iLCBkYXRhKTsKICAgICAgfSk7CgogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkVzdGFibGlzaGVkKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyCiAgICAgICAgICAuaW5mbyhsb2dDb21wb25lbnQsICJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlRhc2sgU2Vzc2lvbiBjb25uZWN0aW9uIGVzdGFibGlzaGVkIiwgZGF0YSk7CiAgICAgIH0pOwogICAgfTsKCiAgICByZXR1cm4gewogICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY3JlYXRlTWVkaWFJbnN0YW5jZSgpOwogICAgICB9LAogICAgfTsKICB9Owp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNzQzOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIHZhciBSaW5ndG9uZUVuZ2luZUJhc2UgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMuX3ByZXZDb250YWN0SWQgPSBudWxsOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZUNvbmZpZywgInJpbmd0b25lQ29uZmlnIik7CiAgICBpZiAoIXJpbmd0b25lQ29uZmlnLnJpbmd0b25lVXJsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigicmluZ3RvbmVVcmwgaXMgcmVxdWlyZWQhIik7CiAgICB9CgogICAgaWYgKGdsb2JhbC5BdWRpbyAmJiB0eXBlb2YgZ2xvYmFsLlByb21pc2UgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHNlbGYuX2F1ZGlvID0gbmV3IEF1ZGlvKHJpbmd0b25lQ29uZmlnLnJpbmd0b25lVXJsKTsKICAgICAgICBzZWxmLl9hdWRpby5sb29wID0gdHJ1ZTsKICAgICAgICBzZWxmLl9hdWRpby5hZGRFdmVudExpc3RlbmVyKCJjYW5wbGF5IiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgc2VsZi5fYXVkaW9QbGF5YWJsZSA9IHRydWU7CiAgICAgICAgICByZXNvbHZlKHNlbGYuX2F1ZGlvKTsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fYXVkaW8gPSBudWxsOwogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJVbmFibGUgdG8gcHJvdmlkZSBhIHJpbmd0b25lLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CgogICAgc2VsZi5fZHJpdmVSaW5ndG9uZSgpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZC4iKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9zdGFydFJpbmd0b25lID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmICh0aGlzLl9hdWRpbykgewogICAgICB0aGlzLl9hdWRpby5wbGF5KCkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBQbGF5YmFjayBGYWlsdXJlIiwgY29udGFjdCk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJSaW5ndG9uZSBQbGF5YmFjayBGYWlsdXJlIikud2l0aEV4Y2VwdGlvbihlKS53aXRoT2JqZWN0KHtjdXJyZW50U3JjOiBzZWxmLl9hdWRpby5jdXJyZW50U3JjLCBzaW5rSWQ6IHNlbGYuX2F1ZGlvLnNpbmtJZCwgdm9sdW1lOiBzZWxmLl9hdWRpby52b2x1bWV9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0pOwogICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFN0YXJ0IiwgY29udGFjdCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgU3RhcnQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3N0b3BSaW5ndG9uZSA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICBpZiAodGhpcy5fYXVkaW8pIHsKICAgICAgdGhpcy5fYXVkaW8ucGF1c2UoKTsKICAgICAgdGhpcy5fYXVkaW8uY3VycmVudFRpbWUgPSAwOwogICAgICB0aGlzLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFN0b3AiLCBjb250YWN0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBTdG9wIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTdG9wIHJpbmd0b25lLgogICAqLwogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuc3RvcFJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fc3RvcFJpbmd0b25lKCk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fcmluZ3RvbmVTZXR1cCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlJJTkdUT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuX3N0YXJ0UmluZ3RvbmUoY29udGFjdCk7CiAgICAgIHNlbGYuX3ByZXZDb250YWN0SWQgPSBjb250YWN0LmdldENvbnRhY3RJZCgpOwoKICAgICAgY29udGFjdC5vbkNvbm5lY3RlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICBjb250YWN0Lm9uQWNjZXB0ZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgY29udGFjdC5vbkVuZGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIC8vIEp1c3QgdG8gbWFrZSBzdXJlIHRvIHN0b3AgdGhlIHJpbmd0b25lIGluIGNhc2Ugb2YgdGhlIGZhaWx1cmVzIG9mIHNwZWNpZmljIGNhbGxiYWNrcyhvbkFjY2VwdGVkLG9uQ29ubmVjdGVkKTsKICAgICAgY29udGFjdC5vblJlZnJlc2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlICE9PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgJiYKICAgICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSAhPT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykgewogICAgICAgICAgc2VsZi5fc3RvcFJpbmd0b25lKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3QpIHsKICAgIGlmIChjb250YWN0ICYmIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBjb250YWN0LmdldENvbnRhY3RJZCgpCiAgICAgIH0pOwogICAgfQogIH07CgogIC8qKgogICAqIENoYW5nZSB0aGUgYXVkaW8gZGV2aWNlIHVzZWQgdG8gcGxheSByaW5ndG9uZS4KICAgKiBJZiBhdWRpbyBlbGVtZW50IGlzIG5vdCBmdWxseSBpbml0aWFsaXplZCwgdGhlIEFQSSB3aWxsIHdhaXQgX2F1ZGlvUGxheWFibGVQcm9taXNlIGZvciAzIHNlY29uZHMgYW5kIGZhaWwgb24gdGltZW91dC4KICAgKiBUaGlzIEFQSSBpcyBzdXBwb3J0ZWQgb25seSBieSBicm93c2VycyB0aGF0IGltcGxlbWVudGVkIEVTNiBQcm9taXNlIGFuZCBodHRwOi8vd3d3LnczLm9yZy9UUi9hdWRpby1vdXRwdXQvCiAgICogUmV0dXJuIGEgUHJvbWlzZSB0aGF0IGluZGljYXRlcyB0aGUgcmVzdWx0IG9mIGNoYW5naW5nIG91dHB1dCBkZXZpY2UuCiAgICovCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5zZXRPdXRwdXREZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGlmICh0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSkgewogICAgICB2YXIgcGxheWFibGVBdWRpb1dpdGhUaW1lb3V0ID0gUHJvbWlzZS5yYWNlKFsKICAgICAgICB0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSwKICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJlamVjdCgiVGltZWQgb3V0IHdhaXRpbmcgZm9yIHBsYXlhYmxlIGF1ZGlvIik7IH0sIDMwMDAvKm1zKi8pOwogICAgICAgIH0pCiAgICAgIF0pOwogICAgICByZXR1cm4gcGxheWFibGVBdWRpb1dpdGhUaW1lb3V0LnRoZW4oZnVuY3Rpb24gKGF1ZGlvKSB7CiAgICAgICAgaWYgKGF1ZGlvKSB7CiAgICAgICAgICBpZiAoYXVkaW8uc2V0U2lua0lkKSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYXVkaW8uc2V0U2lua0lkKGRldmljZUlkKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vdCBzdXBwb3J0ZWQiKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJObyBhdWRpbyBmb3VuZCIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgaWYgKGdsb2JhbC5Qcm9taXNlKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IGVsaWdpYmxlIHJpbmd0b25lIG93bmVyIik7CiAgICB9CiAgfTsKCiAgdmFyIFZvaWNlUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBWb2ljZVJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFZvaWNlUmluZ3RvbmVFbmdpbmU7CgogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlZPSUNFICYmCiAgICAgICAgY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uQ29ubmVjdGluZyhvbkNvbnRhY3RDb25uZWN0KTsKICAgIH0pOwoKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORykgewogICAgICAgIG9uQ29udGFjdENvbm5lY3QoY29udGFjdCk7CiAgICAgIH0KICAgIH0pOwogIH07CgoKICB2YXIgQ2hhdFJpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ2hhdFJpbmd0b25lRW5naW5lOwoKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLkNIQVQgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNoYXQgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCiAgdmFyIFRhc2tSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tSaW5ndG9uZUVuZ2luZTsKCiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5UQVNLICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJUYXNrIFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uQ29ubmVjdGluZyhvbkNvbnRhY3RDb25uZWN0KTsKICAgIH0pOwogIH07CgoKICB2YXIgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lOwoKICBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uSW5jb21pbmcoZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5RVUVVRV9DQUxMQkFDSykgewogICAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2FsbGJhY2sgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDYWxsYmFjayBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgLyogZXhwb3J0IGNvbm5lY3QuUmluZ3RvbmVFbmdpbmUgKi8KICBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUgPSBWb2ljZVJpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuQ2hhdFJpbmd0b25lRW5naW5lID0gQ2hhdFJpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuVGFza1Jpbmd0b25lRW5naW5lID0gVGFza1Jpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lID0gUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNjQyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpczsKICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKICBnbG9iYWwuY2NwVmVyc2lvbiA9ICJWMiI7CgogIHZhciBSVFBKb2JJbnRlcnZhbE1zID0gMTAwMDsKICB2YXIgc3RhdHNSZXBvcnRpbmdKb2JJbnRlcnZhbE1zID0gMzAwMDA7CiAgdmFyIHN0cmVhbUJ1ZmZlclNpemUgPSA1MDA7CiAgdmFyIENhbGxUeXBlTWFwID0ge307CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19PTkxZXSA9ICdBdWRpbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5WSURFT19PTkxZXSA9ICdWaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19WSURFT10gPSAnQXVkaW9WaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5OT05FXSA9ICdOb25lJzsKICB2YXIgQVVESU9fSU5QVVQgPSAnYXVkaW9faW5wdXQnOwogIHZhciBBVURJT19PVVRQVVQgPSAnYXVkaW9fb3V0cHV0JzsKCiAgdmFyIE1lZGlhVHlwZU1hcCA9IHt9OwogIE1lZGlhVHlwZU1hcFtjb25uZWN0LkNvbnRhY3RUeXBlLlZPSUNFXSA9ICJWb2ljZSI7CiAgdmFyIFVOS05PV05fTUVESUFfVFlQRSA9ICJVbmtub3duIjsKCiAgdmFyIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogIHZhciBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgcnRwU3RhdHNKb2IgPSBudWxsOwogIHZhciByZXBvcnRTdGF0c0pvYiA9IG51bGw7CiAgLy9Mb2dnZXIgc3BlY2lmaWMgdG8gc29mdHBob25lLgogIHZhciBsb2dnZXIgPSBudWxsOwogIHZhciBTb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzOwogIHZhciBIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbkhhbmdVcCI7CiAgdmFyIE1VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbnMiOwoKICB2YXIgbG9jYWxNZWRpYVN0cmVhbSA9IHt9OwoKICB2YXIgc29mdHBob25lQ2xpZW50SWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CgogIHZhciByZXF1ZXN0SWNlQWNjZXNzID0gZnVuY3Rpb24gKHRyYW5zcG9ydCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHRyYW5zcG9ydCwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICByZXNvbHZlKGRhdGEuc29mdHBob25lVHJhbnNwb3J0LnNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgaWYgKHJlYXNvbi5tZXNzYWdlICYmIHJlYXNvbi5tZXNzYWdlLmluY2x1ZGVzKCJTb2Z0cGhvbmVDb25uZWN0aW9uTGltaXRCcmVhY2hlZEV4Y2VwdGlvbiIpKSB7CiAgICAgICAgICAgIHB1Ymxpc2hFcnJvcigibXVsdGlwbGVfc29mdHBob25lX2FjdGl2ZV9zZXNzaW9ucyIsICJOdW1iZXIgb2YgYWN0aXZlIHNlc3Npb25zIGFyZSBtb3JlIHRoZW4gYWxsb3dlZCBsaW1pdC4iLCAiIik7CiAgICAgICAgICB9CiAgICAgICAgICByZWplY3QoRXJyb3IoInJlcXVlc3RJY2VBY2Nlc3MgZmFpbGVkIikpOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIHJlcXVlc3RJY2VBY2Nlc3MiKSk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCB3aGlsZSByZXF1ZXN0SWNlQWNjZXNzIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICB2YXIgU29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVQYXJhbXMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGxvZ2dlciA9IG5ldyBTb2Z0cGhvbmVMb2dnZXIoY29ubmVjdC5nZXRMb2coKSk7CiAgICBsb2dnZXIuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBzb2Z0cGhvbmUgbWFuYWdlciBpbml0aWFsaXphdGlvbiBoYXMgYmVndW4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgdmFyIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeTsKICAgIGlmIChjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSkgewogICAgICBydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkgPSBuZXcgY29ubmVjdC5SdGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkobG9nZ2VyLAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCksCiAgICAgICAgc29mdHBob25lQ2xpZW50SWQsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCByZXF1ZXN0SWNlQWNjZXNzLCB7CiAgICAgICAgICB0cmFuc3BvcnRUeXBlOiAic29mdHBob25lIiwKICAgICAgICAgIHNvZnRwaG9uZUNsaWVudElkOiBzb2Z0cGhvbmVDbGllbnRJZAogICAgICAgIH0pLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgcHVibGlzaEVycm9yKSk7CiAgICB9CiAgICBpZiAoIWlzQnJvd3NlclNvZnRQaG9uZVN1cHBvcnRlZCgpKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIsCiAgICAgICAgIkNvbm5lY3QgZG9lcyBub3Qgc3VwcG9ydCB0aGlzIGJyb3dzZXIuIFNvbWUgZnVuY3Rpb25hbGl0eSBtYXkgbm90IHdvcmsuICIsCiAgICAgICAgIiIpOwogICAgfQogICAgdmFyIGd1bVByb21pc2UgPSBmZXRjaFVzZXJNZWRpYSh7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0IiwgbnVsbCwgCiAgICAgICAgewogICAgICAgICAgY29ubmVjdGl2aXR5Q2hlY2tUeXBlOiAiTWljcm9waG9uZVBlcm1pc3Npb24iLAogICAgICAgICAgc3RhdHVzOiAiZ3JhbnRlZCIKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgIHB1Ymxpc2hFcnJvcihlcnIsICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLCAiIik7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDb25uZWN0aXZpdHlDaGVja1Jlc3VsdCIsIG51bGwsIAogICAgICAgIHsKICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgIHN0YXR1czogImRlbmllZCIKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIGhhbmRsZVNvZnRQaG9uZU11dGVUb2dnbGUoKTsKICAgIGhhbmRsZVNwZWFrZXJEZXZpY2VDaGFuZ2UoKTsKICAgIGhhbmRsZU1pY3JvcGhvbmVEZXZpY2VDaGFuZ2UoKTsKICAgIG1vbml0b3JNaWNyb3Bob25lUGVybWlzc2lvbigpOwoKICAgIHRoaXMucmluZ3RvbmVFbmdpbmUgPSBudWxsOwogICAgdmFyIHJ0Y1Nlc3Npb25zID0ge307CiAgICAvLyBUcmFja3MgdGhlIGFnZW50IGNvbm5lY3Rpb24gSUQsIHNvIHRoYXQgaWYgdGhlIHNhbWUgY29udGFjdCBnZXRzIHJlLXJvdXRlZCB0byB0aGUgc2FtZSBhZ2VudCwgaXQnbGwgc3RpbGwgc2V0IHVwIHNvZnRwaG9uZQogICAgdmFyIGNhbGxzRGV0ZWN0ZWQgPSB7fTsKICAgIHRoaXMub25Jbml0Q29udGFjdFN1YiA9IHt9OwogICAgdGhpcy5vbkluaXRDb250YWN0U3ViLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24oKSB7fTsKCiAgICAvLyB2YXJpYWJsZXMgZm9yIGZpcmVmb3ggbXVsdGl0YWIKICAgIHZhciBpc1Nlc3Npb25QZW5kaW5nID0gZmFsc2U7CiAgICB2YXIgcGVuZGluZ0NvbnRhY3QgPSBudWxsOwogICAgdmFyIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB2YXIgcG9zdHBvbmVTdGFydGluZ1Nlc3Npb24gPSBmdW5jdGlvbiAoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaXNTZXNzaW9uUGVuZGluZyA9IHRydWU7CiAgICAgIHBlbmRpbmdDb250YWN0ID0gY29udGFjdDsKICAgICAgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gYWdlbnRDb25uZWN0aW9uSWQ7CiAgICB9CiAgICB2YXIgY2FuY2VsUGVuZGluZ1Nlc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlzU2Vzc2lvblBlbmRpbmcgPSBmYWxzZTsKICAgICAgcGVuZGluZ0NvbnRhY3QgPSBudWxsOwogICAgICBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBudWxsOwogICAgfQoKICAgIC8vIGhlbHBlciBtZXRob2QgdG8gcHJvdmlkZSBhY2Nlc3MgdG8gcnRjIHNlc3Npb25zCiAgICB0aGlzLmdldFNlc3Npb24gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICAgIHJldHVybiBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdOwogICAgfQoKICAgIHRoaXMucmVwbGFjZUxvY2FsTWVkaWFUcmFjayA9IGZ1bmN0aW9uKGNvbm5lY3Rpb25JZCwgdHJhY2spIHsKICAgICAgdmFyIHN0cmVhbSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgIGlmKHN0cmVhbSl7CiAgICAgICAgdmFyIG9sZFRyYWNrID0gc3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF07CiAgICAgICAgdHJhY2suZW5hYmxlZCA9IG9sZFRyYWNrLmVuYWJsZWQ7CiAgICAgICAgb2xkVHJhY2suZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5yZW1vdmVUcmFjayhvbGRUcmFjayk7CiAgICAgICAgc3RyZWFtLmFkZFRyYWNrKHRyYWNrKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgaXNDb250YWN0VGVybWluYXRlZCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHJldHVybiBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuRU5ERUQgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuRVJST1IgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuTUlTU0VEOwogICAgfTsKCiAgICB2YXIgZGVzdHJveVNlc3Npb24gPSBmdW5jdGlvbiAoYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKHJ0Y1Nlc3Npb25zLmhhc093blByb3BlcnR5KGFnZW50Q29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBzZXNzaW9uID0gcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIC8vIEN1cnJlbnRseSB0aGUgYXNzdW1wdGlvbiBpcyBpdCB3aWxsIHRocm93IGFuIGV4Y2VwdGlvbiBvbmx5IGFuZCBpZiBvbmx5IGl0IGFscmVhZHkgaGFzIGJlZW4gaHVuZyB1cC4KICAgICAgICAvLyBUT0RPOiBVcGRhdGUgb25jZSB0aGUgaGFuZ3VwIEFQSSBkb2VzIG5vdCB0aHJvdyBleGNlcHRpb25zCiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIHNlc3Npb24uaGFuZ3VwKCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgbGlseS5nZXRMb2coKS53YXJuKCJDbGVhbiB1cCB0aGUgc2Vzc2lvbiBsb2NhbGx5ICIgKyBhZ2VudENvbm5lY3Rpb25JZCwgZXJyLm1lc3NhZ2UpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgLy8gV2hlbiBtdWx0aXBsZSBSVEMgc2Vzc2lvbnMgZGV0ZWN0ZWQsIGlnbm9yZSB0aGUgbmV3IGNhbGwgYW5kIGhhbmcgdXAgdGhlIHByZXZpb3VzIHNlc3Npb25zLgogICAgLy8gVE9ETzogVXBkYXRlIHdoZW4gY29ubmVjdC1ydGMgZXhwb3NlcyBhbiBBUEkgdG8gZGV0ZWN0IHNlc3Npb24gc3RhdHVzLgogICAgdmFyIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbnMpIHsKICAgICAgaWYgKE9iamVjdC5rZXlzKHJ0Y1Nlc3Npb25zKS5sZW5ndGggPiAwKSB7CiAgICAgICAgLy8gRXJyb3IhIG91ciBzdGF0ZSBkb2Vzbid0IG1hdGNoLCB0ZWFyIGl0IGFsbCBkb3duLgogICAgICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBydGNTZXNzaW9ucykgewogICAgICAgICAgaWYgKHJ0Y1Nlc3Npb25zLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICAgICAgLy8gTG9nIGFuIGVycm9yIGZvciB0aGUgc2Vzc2lvbiB3ZSBhcmUgYWJvdXQgdG8gZW5kLgogICAgICAgICAgICBwdWJsaXNoTXVsdGlwbGVTZXNzaW9uc0V2ZW50KEhBTkdfVVBfTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQsIHJ0Y1Nlc3Npb25zW2Nvbm5lY3Rpb25JZF0uY2FsbElkLCBjb25uZWN0aW9uSWQpOwogICAgICAgICAgICBkZXN0cm95U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImR1cGxpY2F0ZSBzZXNzaW9uIGRldGVjdGVkLCByZWZ1c2luZyB0byBzZXR1cCBuZXcgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuc3RhcnRTZXNzaW9uID0gZnVuY3Rpb24gKF9jb250YWN0LCBfYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgdmFyIGNvbnRhY3QgPSBpc1Nlc3Npb25QZW5kaW5nID8gcGVuZGluZ0NvbnRhY3QgOiBfY29udGFjdDsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gaXNTZXNzaW9uUGVuZGluZyA/IHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA6IF9hZ2VudENvbm5lY3Rpb25JZDsKICAgICAgaWYgKCFjb250YWN0IHx8ICFhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjYW5jZWxQZW5kaW5nU2Vzc2lvbigpOwogICAgICAKICAgICAgLy8gU2V0IHRvIHRydWUsIHRoaXMgd2lsbCBibG9jayBzdWJzZXF1ZW50IGludm9rZXMgZnJvbSBlbnRlcmluZy4KICAgICAgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gPSB0cnVlOwogICAgICBsb2dnZXIuaW5mbygiU29mdHBob25lIGNhbGwgZGV0ZWN0ZWQ6IiwgImNvbnRhY3RJZCAiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAvLyBFbnN1cmUgb3VyIHNlc3Npb24gc3RhdGUgbWF0Y2hlcyBvdXIgY29udGFjdCBzdGF0ZSB0byBwcmV2ZW50IGlzc3VlcyBzaG91bGQgd2UgbG9zZSB0cmFjayBvZiBhIGNvbnRhY3QuCiAgICAgIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMocnRjU2Vzc2lvbnMpOwoKICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwogICAgICB9CgogICAgICBpbml0aWFsaXplUGFyYW1zKCk7CiAgICAgIHZhciBzb2Z0cGhvbmVJbmZvID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgICAgdmFyIGNhbGxDb25maWcgPSBwYXJzZUNhbGxDb25maWcoc29mdHBob25lSW5mby5jYWxsQ29uZmlnSnNvbik7CiAgICAgIHZhciB3ZWJTb2NrZXRQcm92aWRlcjsKICAgICAgaWYgKGNhbGxDb25maWcudXNlV2ViU29ja2V0UHJvdmlkZXIpIHsKICAgICAgICB3ZWJTb2NrZXRQcm92aWRlciA9IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCk7CiAgICAgIH0KICAgICAgdmFyIHNlc3Npb24gPSBuZXcgY29ubmVjdC5SVENTZXNzaW9uKAogICAgICAgIGNhbGxDb25maWcuc2lnbmFsaW5nRW5kcG9pbnQsCiAgICAgICAgY2FsbENvbmZpZy5pY2VTZXJ2ZXJzLAogICAgICAgIHNvZnRwaG9uZUluZm8uY2FsbENvbnRleHRUb2tlbiwKICAgICAgICBsb2dnZXIsCiAgICAgICAgY29udGFjdC5nZXRDb250YWN0SWQoKSwKICAgICAgICBhZ2VudENvbm5lY3Rpb25JZCwKICAgICAgICB3ZWJTb2NrZXRQcm92aWRlcik7CgogICAgICBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF0gPSBzZXNzaW9uOwoKICAgICAgaWYgKGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKSkgewogICAgICAgIHNlc3Npb24ubWVkaWFTdHJlYW0gPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCk7CiAgICAgIH0KCiAgICAgIC8vIEN1c3RvbSBFdmVudCB0byBpbmRpY2F0ZSB0aGUgc2Vzc2lvbiBpbml0IG9wZXJhdGlvbnMKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuU0VTU0lPTl9JTklULAogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGNvbm5lY3Rpb25JZDogYWdlbnRDb25uZWN0aW9uSWQKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgc2Vzc2lvbi5vblNlc3Npb25GYWlsZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgcmVhc29uKSB7CiAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzKHJ0Y1Nlc3Npb24sIHJlYXNvbik7CiAgICAgICAgcHVibGlzaFNlc3Npb25GYWlsdXJlVGVsZW1ldHJ5RXZlbnQoY29udGFjdC5nZXRDb250YWN0SWQoKSwgcmVhc29uKTsKICAgICAgICBzdG9wSm9ic0FuZFJlcG9ydChjb250YWN0LCBydGNTZXNzaW9uLnNlc3Npb25SZXBvcnQpOwogICAgICB9OwogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbm5lY3RlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb25uZWN0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgICAvLyBCZWNvbWUgbWFzdGVyIHRvIHNlbmQgbG9ncywgc2luY2Ugd2UgbmVlZCBsb2dzIGZyb20gc29mdHBob25lIHRhYi4KICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgIC8vc3RhcnQgc3RhdHMgY29sbGVjdGlvbiBhbmQgcmVwb3J0aW5nIGpvYnMKICAgICAgICBzdGFydFN0YXRzQ29sbGVjdGlvbkpvYihydGNTZXNzaW9uKTsKICAgICAgICBzdGFydFN0YXRzUmVwb3J0aW5nSm9iKGNvbnRhY3QpOwogICAgICAgIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudChjb250YWN0KTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ub25TZXNzaW9uQ29tcGxldGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIENvbXBsZXRlZCIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwoKICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAvLyBTdG9wIGFsbCBqb2JzIGFuZCBwZXJmb3JtIG9uZSBsYXN0IGpvYi4KICAgICAgICBzdG9wSm9ic0FuZFJlcG9ydChjb250YWN0LCBydGNTZXNzaW9uLnNlc3Npb25SZXBvcnQpOwoKICAgICAgICAvLyBDbGVhbnVwIHRoZSBjYWNoZWQgc3RyZWFtcwogICAgICAgIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0oYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5vbkxvY2FsU3RyZWFtQWRkZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgc3RyZWFtKSB7CiAgICAgICAgLy8gQ2FjaGUgdGhlIHN0cmVhbXMgZm9yIG11dGUvdW5tdXRlCiAgICAgICAgbG9jYWxNZWRpYVN0cmVhbVthZ2VudENvbm5lY3Rpb25JZF0gPSB7CiAgICAgICAgICBzdHJlYW06IHN0cmVhbQogICAgICAgIH07CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogYWdlbnRDb25uZWN0aW9uSWQKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ucmVtb3RlQXVkaW9FbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW90ZS1hdWRpbycpOwogICAgICBpZiAocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeS5nZXQoY2FsbENvbmZpZy5pY2VTZXJ2ZXJzKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KCk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgb25SZWZyZXNoQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdICYmIGlzQ29udGFjdFRlcm1pbmF0ZWQoY29udGFjdCkpIHsKICAgICAgICBkZXN0cm95U2Vzc2lvbihhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgY2FuY2VsUGVuZGluZ1Nlc3Npb24oKTsKICAgICAgfQogICAgICBpZiAoY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiAhY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gJiYgKAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSkgewogICAgICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzKCkpIHsKICAgICAgICAgICAgcG9zdHBvbmVTdGFydGluZ1Nlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHZhciBvbkluaXRDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5jb25uZWN0aW9uSWQ7CiAgICAgIGxvZ2dlci5pbmZvKCJDb250YWN0IGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgaWYgKCFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSkgewogICAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHNlbGYub25Jbml0Q29udGFjdFN1YiA9IGNvbm5lY3QuY29udGFjdChvbkluaXRDb250YWN0KTsKCiAgICAvLyBDb250YWN0IGFscmVhZHkgaW4gY29ubmVjdGluZyBzdGF0ZSBzY2VuYXJpbyAtIEluIHRoaXMgY2FzZSBjb250YWN0IElOSVQgaXMgbWlzc2VkIGhlbmNlIHRoZSBPblJlZnJlc2ggY2FsbGJhY2sgaXMgbWlzc2VkLiAKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuY29ubmVjdGlvbklkOwogICAgICBsb2dnZXIuaW5mbygiQ29udGFjdCBleGlzdCBpbiB0aGUgc25hcHNob3QuIFJlaW5pdGlhdGUgdGhlIENvbnRhY3QgYW5kIFJUQyBzZXNzaW9uIGNyZWF0aW9uIGZvciBjb250YWN0SWQiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIG9uSW5pdENvbnRhY3QoY29udGFjdCk7CiAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgfSk7CiAgfTsKCiAgdmFyIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgdmFyIGFnZW50Q29ubmVjdGlvbiA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCk7CiAgICBpZiAoIWFnZW50Q29ubmVjdGlvbikgewogICAgICBsb2dnZXIuaW5mbygiTm90IGFibGUgdG8gcmV0cmlldmUgdGhlIGF1dG8tYWNjZXB0IHNldHRpbmcgZnJvbSBudWxsIEFnZW50Q29ubmVjdGlvbiwgaWdub3JpbmcgZXZlbnQgcHVibGlzaC4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHNvZnRwaG9uZU1lZGlhSW5mbyA9IGFnZW50Q29ubmVjdGlvbi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgIGlmICghc29mdHBob25lTWVkaWFJbmZvKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgU29mdHBob25lTWVkaWFJbmZvLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc29mdHBob25lTWVkaWFJbmZvLmF1dG9BY2NlcHQgPT09IHRydWUpIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGVuYWJsZWQsIHNlbmRpbmcgb3V0IEFjY2VwdGVkIGV2ZW50IHRvIHN0b3AgcmluZ3RvbmUuLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsCiAgICAgICAgZGF0YTogbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0LmNvbnRhY3RJZCkKICAgICAgfSk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIGNvbnRhY3QuY29udGFjdElkKSwKICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3QuY29udGFjdElkKQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGxvZ2dlci5pbmZvKCJBdXRvLWFjY2VwdCBpcyBkaXNhYmxlZCwgcmluZ3RvbmUgd2lsbCBiZSBzdG9wcGVkIGJ5IHVzZXIgYWN0aW9uLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLy8gQmluZCBldmVudHMgZm9yIG11dGUKICB2YXIgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTVVURSwgbXV0ZVRvZ2dsZSk7CiAgfTsKCiAgdmFyIGhhbmRsZVNwZWFrZXJEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwgc2V0U3BlYWtlckRldmljZSk7CiAgfQoKICB2YXIgaGFuZGxlTWljcm9waG9uZURldmljZUNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9NSUNST1BIT05FX0RFVklDRSwgc2V0TWljcm9waG9uZURldmljZSk7CiAgfQoKICB2YXIgbW9uaXRvck1pY3JvcGhvbmVQZXJtaXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgaWYgKGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbigpID4gNDMpewogICAgICAgIG5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeSh7bmFtZTogJ21pY3JvcGhvbmUnfSkKICAgICAgICAudGhlbihmdW5jdGlvbihwZXJtaXNzaW9uU3RhdHVzKXsKICAgICAgICAgIHBlcm1pc3Npb25TdGF0dXMub25jaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWljcm9waG9uZSBQZXJtaXNzaW9uOiAiICsgcGVybWlzc2lvblN0YXR1cy5zdGF0ZSk7CiAgICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgICAgICBzdGF0dXM6IHBlcm1pc3Npb25TdGF0dXMuc3RhdGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHBlcm1pc3Npb25TdGF0dXMuc3RhdGUgPT09ICdkZW5pZWQnKXsKICAgICAgICAgICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQsCiAgICAgICAgICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAgICAgICAgICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgaW4gZGV0ZWN0aW5nIG1pY3JvcGhvbmUgcGVybWlzc2lvbiBzdGF0dXM6ICIgKyBlKTsKICAgIH0KICB9CgogIC8vIE1ha2Ugc3VyZSBvbmNlIHdlIGRpc2Nvbm5lY3RlZCB3ZSBnZXQgdGhlIG11dGUgc3RhdGUgYmFjayB0byBub3JtYWwKICB2YXIgZGVsZXRlTG9jYWxNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQpIHsKICAgIGRlbGV0ZSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF07CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLAogICAgICBkYXRhOiB7IG11dGVkOiBmYWxzZSB9CiAgICB9KTsKICB9OwoKICAvLyBDaGVjayBmb3IgdGhlIGxvY2FsIHN0cmVhbXMgaWYgZXhpc3RzICAtICByZXZlcnQgaXQKICAvLyBBbmQgaW5mb3JtIG90aGVyIGNsaWVudHMgYWJvdXQgdGhlIGNoYW5nZSAKICB2YXIgbXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICB2YXIgc3RhdHVzOwogICAgaWYgKGNvbm5lY3Qua2V5cyhsb2NhbE1lZGlhU3RyZWFtKS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChkYXRhICYmIGRhdGEubXV0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHN0YXR1cyA9IGRhdGEubXV0ZTsKICAgIH0KCiAgICBmb3IgKHZhciBjb25uZWN0aW9uSWQgaW4gbG9jYWxNZWRpYVN0cmVhbSkgewogICAgICBpZiAobG9jYWxNZWRpYVN0cmVhbS5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgdmFyIGxvY2FsTWVkaWEgPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0uc3RyZWFtOwogICAgICAgIGlmIChsb2NhbE1lZGlhKSB7CiAgICAgICAgICB2YXIgYXVkaW9UcmFja3MgPSBsb2NhbE1lZGlhLmdldEF1ZGlvVHJhY2tzKClbMF07CiAgICAgICAgICBpZiAoc3RhdHVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgYXVkaW9UcmFja3MuZW5hYmxlZCA9ICFzdGF0dXM7CiAgICAgICAgICAgIGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5tdXRlZCA9IHN0YXR1czsKCiAgICAgICAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQWdlbnQgaGFzIG11dGVkIHRoZSBjb250YWN0LCBjb25uZWN0aW9uSWQgLSAgIiArIGNvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQWdlbnQgaGFzIHVubXV0ZWQgdGhlIGNvbnRhY3QsIGNvbm5lY3Rpb25JZCAtICIgKyBjb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0dXMgPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgfHwgZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogc3RhdHVzIH0KICAgIH0pOwogIH07CgogIHZhciBzZXRTcGVha2VyRGV2aWNlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkZXZpY2VJZCA9IGRhdGEuZGV2aWNlSWQ7CiAgICB2YXIgcmVtb3RlQXVkaW9FbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW90ZS1hdWRpbycpOwogICAgdHJ5IHsKICAgICAgbG9nZ2VyLmluZm8oIlRyeWluZyB0byBzZXQgc3BlYWtlciB0byBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgICAgaWYgKHJlbW90ZUF1ZGlvRWxlbWVudCAmJiB0eXBlb2YgcmVtb3RlQXVkaW9FbGVtZW50LnNldFNpbmtJZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJlbW90ZUF1ZGlvRWxlbWVudC5zZXRTaW5rSWQoZGV2aWNlSWQpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGxvZ2dlci5lcnJvcigiRmFpbGVkIHRvIHNldCBzcGVha2VyIHRvIGRldmljZSAiICsgZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9CgogIHZhciBzZXRNaWNyb3Bob25lRGV2aWNlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwICB8fCAhZGF0YSB8fCAhZGF0YS5kZXZpY2VJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgdmFyIHNvZnRwaG9uZU1hbmFnZXIgPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlcigpOwogICAgdHJ5IHsKICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoeyBhdWRpbzogeyBkZXZpY2VJZDogeyBleGFjdDogZGV2aWNlSWQgfSB9IH0pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKG5ld01pY3JvcGhvbmVTdHJlYW0pIHsKICAgICAgICAgIHZhciBuZXdNaWNyb3Bob25lVHJhY2sgPSBuZXdNaWNyb3Bob25lU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF07CiAgICAgICAgICBmb3IgKHZhciBjb25uZWN0aW9uSWQgaW4gbG9jYWxNZWRpYVN0cmVhbSkgewogICAgICAgICAgICBpZiAobG9jYWxNZWRpYVN0cmVhbS5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgICAgICAgdmFyIGxvY2FsTWVkaWEgPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0uc3RyZWFtOwogICAgICAgICAgICAgIHZhciBzZXNzaW9uID0gc29mdHBob25lTWFuYWdlci5nZXRTZXNzaW9uKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICAgICAgLy9SZXBsYWNlIHRoZSBhdWRpbyB0cmFjayBpbiB0aGUgUnRjUGVlckNvbm5lY3Rpb24KICAgICAgICAgICAgICBzZXNzaW9uLl9wYy5nZXRTZW5kZXJzKClbMF0ucmVwbGFjZVRyYWNrKG5ld01pY3JvcGhvbmVUcmFjaykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvL1JlcGxhY2UgdGhlIGF1ZGlvIHRyYWNrIGluIHRoZSBsb2NhbCBtZWRpYSBzdHJlYW0gKGZvciBtdXRlIC8gdW5tdXRlKQogICAgICAgICAgICAgICAgc29mdHBob25lTWFuYWdlci5yZXBsYWNlTG9jYWxNZWRpYVRyYWNrKGNvbm5lY3Rpb25JZCwgbmV3TWljcm9waG9uZVRyYWNrKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSBjYXRjaChlKSB7CiAgICAgIGxvZ2dlci5lcnJvcigiRmFpbGVkIHRvIHNldCBtaWNyb3Bob25lIGRldmljZSAiICsgZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9CgogIHZhciBwdWJsaXNoU29mdHBob25lRmFpbHVyZUxvZ3MgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgcmVhc29uKSB7CiAgICBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5JQ0VfQ09MTEVDVElPTl9USU1FT1VUKSB7CiAgICAgIHZhciBlbmRQb2ludFVybCA9ICJcbiI7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcnRjU2Vzc2lvbi5faWNlU2VydmVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcnRjU2Vzc2lvbi5faWNlU2VydmVyc1tpXS51cmxzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBlbmRQb2ludFVybCA9IGVuZFBvaW50VXJsICsgcnRjU2Vzc2lvbi5faWNlU2VydmVyc1tpXS51cmxzW2pdICsgIlxuIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCwgIkljZSBjb2xsZWN0aW9uIHRpbWVkb3V0LiAiLCBlbmRQb2ludFVybCk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuVVNFUl9CVVNZKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlVTRVJfQlVTWV9FUlJPUiwKICAgICAgICAiU29mdHBob25lIGNhbGwgVXNlckJ1c3kgZXJyb3IuICIsCiAgICAgICAgIiIpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19IQU5EU0hBS0VfRkFJTFVSRSwKICAgICAgICAiSGFuZHNoYWtpbmcgd2l0aCBTaWduYWxsaW5nIFNlcnZlciAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBmYWlsZWQuICIsCiAgICAgICAgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5HVU1fVElNRU9VVF9GQUlMVVJFIHx8IHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX09USEVSX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVELAogICAgICAgICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0NPTk5FQ1RJT05fRkFJTFVSRSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5TSUdOQUxMSU5HX0NPTk5FQ1RJT05fRkFJTFVSRSwKICAgICAgICAiVVJMICIgKyBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkgKyAiIGNhbm5vdCBiZSByZWFjaGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuQ0FMTF9OT1RfRk9VTkQpIHsKICAgICAgLy8gTm8gbmVlZCB0byBwdWJsaXNoIGFueSBzb2Z0cGhvbmUgZXJyb3IgZm9yIHRoaXMgY2FzZS4gQ0NQIFVYIHdpbGwgaGFuZGxlIHRoaXMgY2FzZS4KICAgICAgbG9nZ2VyLmVycm9yKCJTb2Z0cGhvbmUgY2FsbCBmYWlsZWQgZHVlIHRvIENhbGxOb3RGb3VuZEV4Y2VwdGlvbi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfSBlbHNlIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuV0VCUlRDX0VSUk9SLAogICAgICAgICJ3ZWJydGMgc3lzdGVtIGVycm9yLiAiLAogICAgICAgICIiKTsKICAgIH0KICB9OwoKICAvKiogUGFyc2UgdGhlIEpTT04gZW5jb2RlZCB3ZWIgY2FsbCBjb25maWcgaW50byB0aGUgZGF0YSBpdCByZXByZXNlbnRzLiAqLwogIHZhciBwYXJzZUNhbGxDb25maWcgPSBmdW5jdGlvbiAoc2VyaWFsaXplZENvbmZpZykgewogICAgLy8gT3VyIHVuZGVyc2NvcmUgaXMgdG9vIG9sZCBmb3IgdW5lc2NhcGUKICAgIC8vIGh0dHBzOi8vaXNzdWVzLmFtYXpvbi5jb20vaXNzdWVzL0NTV0YtMTQ2NwogICAgdmFyIGRlY29kZWRKU09OID0gc2VyaWFsaXplZENvbmZpZy5yZXBsYWNlKC8mcXVvdDsvZywgJyInKTsKICAgIHJldHVybiBKU09OLnBhcnNlKGRlY29kZWRKU09OKTsKICB9OwoKICB2YXIgZmV0Y2hVc2VyTWVkaWEgPSBmdW5jdGlvbiAoY2FsbGJhY2tzSW4pIHsKICAgIHZhciBjYWxsYmFja3MgPSBjYWxsYmFja3NJbiB8fCB7fTsKICAgIGNhbGxiYWNrcy5zdWNjZXNzID0gY2FsbGJhY2tzLnN1Y2Nlc3MgfHwgZnVuY3Rpb24gKCkgeyB9OwogICAgY2FsbGJhY2tzLmZhaWx1cmUgPSBjYWxsYmFja3MuZmFpbHVyZSB8fCBmdW5jdGlvbiAoKSB7IH07CgogICAgdmFyIENPTlNUUkFJTlQgPSB7CiAgICAgIGF1ZGlvOiB0cnVlCiAgICB9OwoKICAgIHZhciBwcm9taXNlID0gbnVsbDsKCiAgICBpZiAodHlwZW9mIFByb21pc2UgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHByb21pc2UgPSBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYShDT05TVFJBSU5UKTsKCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYShDT05TVFJBSU5ULCByZXNvbHZlLCByZWplY3QpOwogICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgICAgdmFyIGF1ZGlvVHJhY2tzID0gc3RyZWFtLmdldEF1ZGlvVHJhY2tzKCk7CiAgICAgIGlmIChhdWRpb1RyYWNrcyAmJiBhdWRpb1RyYWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3Moc3RyZWFtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCk7CiAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQpOwogICAgfSk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9OwoKICB2YXIgcHVibGlzaEVycm9yID0gZnVuY3Rpb24gKGVycm9yVHlwZSwgbWVzc2FnZSwgZW5kUG9pbnRVcmwpIHsKICAgIGxvZ2dlci5lcnJvcigiU29mdHBob25lIGVycm9yIG9jY3VycmVkIDogIiwgZXJyb3JUeXBlLAogICAgICBtZXNzYWdlIHx8ICIiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuU09GVFBIT05FX0VSUk9SLAogICAgICBkYXRhOiBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvcihlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKQogICAgfSk7CiAgfTsKCiAgdmFyIHB1Ymxpc2hTZXNzaW9uRmFpbHVyZVRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgcmVhc29uKSB7CiAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIEZhaWxlZCIsIGNvbnRhY3RJZCwgewogICAgICBmYWlsZWRSZWFzb246IHJlYXNvbgogICAgfSk7CiAgfTsKCiAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCwgZGF0YSkgewogICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZCwKICAgICAgZGF0YTogZGF0YQogICAgfSk7CiAgfTsKCiAgLy8gUHVibGlzaCB0aGUgY29udGFjdCBhbmQgYWdlbnQgaW5mb3JtYXRpb24gaW4gYSBtdWx0aXBsZSBzZXNzaW9ucyBzY2VuYXJpb3MKICB2YXIgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudChldmVudE5hbWUsIGNvbnRhY3RJZCwgW3sKICAgICAgbmFtZTogIkFnZW50Q29ubmVjdGlvbklkIiwKICAgICAgdmFsdWU6IGFnZW50Q29ubmVjdGlvbklkCiAgICB9XSk7CiAgICBsb2dnZXIuaW5mbygiUHVibGlzaCBtdWx0aXBsZSBzZXNzaW9uIGVycm9yIG1ldHJpY3MiLCBldmVudE5hbWUsICJjb250YWN0SWQgIiArIGNvbnRhY3RJZCwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpCiAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogIH07CgogIHZhciBpc0Jyb3dzZXJTb2Z0UGhvbmVTdXBwb3J0ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBJbiBPcGVyYSwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiT3BlcmEiIG9yIGFmdGVyICJWZXJzaW9uIgogICAgaWYgKGNvbm5lY3QuaXNPcGVyYUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldE9wZXJhQnJvd3NlclZlcnNpb24oKSA+IDE3KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gSW4gQ2hyb21lLCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJDaHJvbWUiCiAgICBlbHNlIGlmIChjb25uZWN0LmlzQ2hyb21lQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0Q2hyb21lQnJvd3NlclZlcnNpb24oKSA+IDIyKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gSW4gRmlyZWZveCwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiRmlyZWZveCIKICAgIGVsc2UgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0RmlyZWZveEJyb3dzZXJWZXJzaW9uKCkgPiAyMSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9OwoKICB2YXIgc2VuZFNvZnRwaG9uZU1ldHJpY3MgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHN0cmVhbVN0YXRzID0gdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnNsaWNlKCk7CiAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICAgIGlmIChzdHJlYW1TdGF0cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnRhY3Quc2VuZFNvZnRwaG9uZU1ldHJpY3Moc3RyZWFtU3RhdHMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbygic2VuZFNvZnRwaG9uZU1ldHJpY3Mgc3VjY2VzcyIgKyBKU09OLnN0cmluZ2lmeShzdHJlYW1TdGF0cykpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGxvZ2dlci5lcnJvcigic2VuZFNvZnRwaG9uZU1ldHJpY3MgZmFpbGVkLiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgdmFyIHNlbmRTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbiAoY29udGFjdCwgcmVwb3J0LCB1c2VyQXVkaW9TdGF0cywgcmVtb3RlQXVkaW9TdGF0cykgewogICAgcmVwb3J0LnN0cmVhbVN0YXRzID0gW2FkZFN0cmVhbVR5cGVUb1N0YXRzKHVzZXJBdWRpb1N0YXRzLCBBVURJT19JTlBVVCksCiAgICBhZGRTdHJlYW1UeXBlVG9TdGF0cyhyZW1vdGVBdWRpb1N0YXRzLCBBVURJT19PVVRQVVQpXTsKICAgIHZhciBjYWxsUmVwb3J0ID0gewogICAgICBjYWxsU3RhcnRUaW1lOiByZXBvcnQuc2Vzc2lvblN0YXJ0VGltZSwKICAgICAgY2FsbEVuZFRpbWU6IHJlcG9ydC5zZXNzaW9uRW5kVGltZSwKICAgICAgZ3VtVGltZU1pbGxpczogcmVwb3J0Lmd1bVRpbWVNaWxsaXMsCiAgICAgIGluaXRpYWxpemF0aW9uVGltZU1pbGxpczogcmVwb3J0LmluaXRpYWxpemF0aW9uVGltZU1pbGxpcywKICAgICAgaWNlQ29sbGVjdGlvblRpbWVNaWxsaXM6IHJlcG9ydC5pY2VDb2xsZWN0aW9uVGltZU1pbGxpcywKICAgICAgc2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzOiByZXBvcnQuc2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzLAogICAgICBoYW5kc2hha2luZ1RpbWVNaWxsaXM6IHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXMsCiAgICAgIHByZVRhbGtpbmdUaW1lTWlsbGlzOiByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXMsCiAgICAgIHRhbGtpbmdUaW1lTWlsbGlzOiByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXMsCiAgICAgIGNsZWFudXBUaW1lTWlsbGlzOiByZXBvcnQuY2xlYW51cFRpbWVNaWxsaXMsCiAgICAgIGljZUNvbGxlY3Rpb25GYWlsdXJlOiByZXBvcnQuaWNlQ29sbGVjdGlvbkZhaWx1cmUsCiAgICAgIHNpZ25hbGxpbmdDb25uZWN0aW9uRmFpbHVyZTogcmVwb3J0LnNpZ25hbGxpbmdDb25uZWN0aW9uRmFpbHVyZSwKICAgICAgaGFuZHNoYWtpbmdGYWlsdXJlOiByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlLAogICAgICBndW1PdGhlckZhaWx1cmU6IHJlcG9ydC5ndW1PdGhlckZhaWx1cmUsCiAgICAgIGd1bVRpbWVvdXRGYWlsdXJlOiByZXBvcnQuZ3VtVGltZW91dEZhaWx1cmUsCiAgICAgIGNyZWF0ZU9mZmVyRmFpbHVyZTogcmVwb3J0LmNyZWF0ZU9mZmVyRmFpbHVyZSwKICAgICAgc2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmU6IHJlcG9ydC5zZXRMb2NhbERlc2NyaXB0aW9uRmFpbHVyZSwKICAgICAgdXNlckJ1c3lGYWlsdXJlOiByZXBvcnQudXNlckJ1c3lGYWlsdXJlLAogICAgICBpbnZhbGlkUmVtb3RlU0RQRmFpbHVyZTogcmVwb3J0LmludmFsaWRSZW1vdGVTRFBGYWlsdXJlLAogICAgICBub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmU6IHJlcG9ydC5ub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmUsCiAgICAgIHNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZTogcmVwb3J0LnNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZSwKICAgICAgc29mdHBob25lU3RyZWFtU3RhdGlzdGljczogcmVwb3J0LnN0cmVhbVN0YXRzCiAgICB9OwogICAgY29udGFjdC5zZW5kU29mdHBob25lUmVwb3J0KGNhbGxSZXBvcnQsIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgIGxvZ2dlci5pbmZvKCJzZW5kU29mdHBob25lUmVwb3J0IHN1Y2Nlc3MiICsgSlNPTi5zdHJpbmdpZnkoY2FsbFJlcG9ydCkpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuZXJyb3IoInNlbmRTb2Z0cGhvbmVSZXBvcnQgZmFpbGVkLiIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIHZhciBzdGFydFN0YXRzQ29sbGVjdGlvbkpvYiA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICBydHBTdGF0c0pvYiA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgIHJ0Y1Nlc3Npb24uZ2V0VXNlckF1ZGlvU3RhdHMoKS50aGVuKGZ1bmN0aW9uIChzdGF0cykgewogICAgICAgIHZhciBwcmV2aW91c1VzZXJTdGF0cyA9IGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0czsKICAgICAgICBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSBzdGF0czsKICAgICAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIucHVzaChnZXRUaW1lU2VyaWVzU3RhdHMoYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzLCBwcmV2aW91c1VzZXJTdGF0cywgQVVESU9fSU5QVVQpKTsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgbG9nZ2VyLmRlYnVnKCJGYWlsZWQgdG8gZ2V0IHVzZXIgYXVkaW8gc3RhdHMuIiwgZXJyb3IpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwogICAgICBydGNTZXNzaW9uLmdldFJlbW90ZUF1ZGlvU3RhdHMoKS50aGVuKGZ1bmN0aW9uIChzdGF0cykgewogICAgICAgIHZhciBwcmV2aW91c1JlbW90ZVN0YXRzID0gYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHM7CiAgICAgICAgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSBzdGF0czsKICAgICAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIucHVzaChnZXRUaW1lU2VyaWVzU3RhdHMoYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMsIHByZXZpb3VzUmVtb3RlU3RhdHMsIEFVRElPX09VVFBVVCkpOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBsb2dnZXIuZGVidWcoIkZhaWxlZCB0byBnZXQgcmVtb3RlIGF1ZGlvIHN0YXRzLiIsIGVycm9yKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKICAgIH0sIDEwMDApOwogIH07CgogIHZhciBzdGFydFN0YXRzUmVwb3J0aW5nSm9iID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHJlcG9ydFN0YXRzSm9iID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgc2VuZFNvZnRwaG9uZU1ldHJpY3MoY29udGFjdCk7CiAgICB9LCBzdGF0c1JlcG9ydGluZ0pvYkludGVydmFsTXMpOwogIH07CgogIHZhciBpbml0aWFsaXplUGFyYW1zID0gZnVuY3Rpb24gKCkgewogICAgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0gbnVsbDsKICAgIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0gbnVsbDsKICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogICAgcnRwU3RhdHNKb2IgPSBudWxsOwogICAgcmVwb3J0U3RhdHNKb2IgPSBudWxsOwogIH07CgogIHZhciBnZXRUaW1lU2VyaWVzU3RhdHMgPSBmdW5jdGlvbiAoY3VycmVudFN0YXRzLCBwcmV2aW91c1N0YXRzLCBzdHJlYW1UeXBlKSB7CiAgICBpZiAocHJldmlvdXNTdGF0cyAmJiBjdXJyZW50U3RhdHMpIHsKICAgICAgdmFyIHBhY2tldHNMb3N0ID0gY3VycmVudFN0YXRzLnBhY2tldHNMb3N0ID4gcHJldmlvdXNTdGF0cy5wYWNrZXRzTG9zdCA/IGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCAtIHByZXZpb3VzU3RhdHMucGFja2V0c0xvc3QgOiAwOwogICAgICB2YXIgcGFja2V0c0NvdW50ID0gY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCA+IHByZXZpb3VzU3RhdHMucGFja2V0c0NvdW50ID8gY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCAtIHByZXZpb3VzU3RhdHMucGFja2V0c0NvdW50IDogMDsKICAgICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhjdXJyZW50U3RhdHMudGltZXN0YW1wLAogICAgICAgIHBhY2tldHNMb3N0LAogICAgICAgIHBhY2tldHNDb3VudCwKICAgICAgICBzdHJlYW1UeXBlLAogICAgICAgIGN1cnJlbnRTdGF0cy5hdWRpb0xldmVsLAogICAgICAgIGN1cnJlbnRTdGF0cy5qYk1pbGxpc2Vjb25kcywKICAgICAgICBjdXJyZW50U3RhdHMucnR0TWlsbGlzZWNvbmRzKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoY3VycmVudFN0YXRzLnRpbWVzdGFtcCwKICAgICAgICBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QsCiAgICAgICAgY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCwKICAgICAgICBzdHJlYW1UeXBlLAogICAgICAgIGN1cnJlbnRTdGF0cy5hdWRpb0xldmVsLAogICAgICAgIGN1cnJlbnRTdGF0cy5qYk1pbGxpc2Vjb25kcywKICAgICAgICBjdXJyZW50U3RhdHMucnR0TWlsbGlzZWNvbmRzKTsKICAgIH0KICB9OwoKICB2YXIgc3RvcEpvYiA9IGZ1bmN0aW9uICh0YXNrKSB7CiAgICBpZiAodGFzayAhPT0gbnVsbCkgewogICAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0YXNrKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH07CgogIHZhciBzdG9wSm9ic0FuZFJlcG9ydCA9IGZ1bmN0aW9uIChjb250YWN0LCBzZXNzaW9uUmVwb3J0KSB7CiAgICBydHBTdGF0c0pvYiA9IHN0b3BKb2IocnRwU3RhdHNKb2IpOwogICAgcmVwb3J0U3RhdHNKb2IgPSBzdG9wSm9iKHJlcG9ydFN0YXRzSm9iKTsKICAgIHNlbmRTb2Z0cGhvbmVSZXBvcnQoY29udGFjdCwgc2Vzc2lvblJlcG9ydCwgYWRkU3RyZWFtVHlwZVRvU3RhdHMoYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzLCBBVURJT19JTlBVVCksIGFkZFN0cmVhbVR5cGVUb1N0YXRzKGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzLCBBVURJT19PVVRQVVQpKTsKICAgIHNlbmRTb2Z0cGhvbmVNZXRyaWNzKGNvbnRhY3QpOwogIH07CgogIC8qKgogICogICBBZGRpbmcgc3RyZWFtdHlwZSBwYXJhbWV0ZXIgb24gdG9wIG9mIFJUQ0pTIFJUU3RhdHMgb2JqZWN0LgogICovCiAgdmFyIFJUUFN0cmVhbVN0YXRzID0gZnVuY3Rpb24gKHRpbWVzdGFtcCwgcGFja2V0c0xvc3QsIHBhY2tldHNDb3VudCwgc3RyZWFtVHlwZSwgYXVkaW9MZXZlbCwgaml0dGVyQnVmZmVyTWlsbGlzLCByb3VuZFRyaXBUaW1lTWlsbGlzKSB7CiAgICB0aGlzLnNvZnRwaG9uZVN0cmVhbVR5cGUgPSBzdHJlYW1UeXBlOwogICAgdGhpcy50aW1lc3RhbXAgPSB0aW1lc3RhbXA7CiAgICB0aGlzLnBhY2tldHNMb3N0ID0gcGFja2V0c0xvc3Q7CiAgICB0aGlzLnBhY2tldHNDb3VudCA9IHBhY2tldHNDb3VudDsKICAgIHRoaXMuYXVkaW9MZXZlbCA9IGF1ZGlvTGV2ZWw7CiAgICB0aGlzLmppdHRlckJ1ZmZlck1pbGxpcyA9IGppdHRlckJ1ZmZlck1pbGxpczsKICAgIHRoaXMucm91bmRUcmlwVGltZU1pbGxpcyA9IHJvdW5kVHJpcFRpbWVNaWxsaXM7CiAgfTsKCiAgdmFyIGFkZFN0cmVhbVR5cGVUb1N0YXRzID0gZnVuY3Rpb24gKHN0YXRzLCBzdHJlYW1UeXBlKSB7CiAgICBzdGF0cyA9IHN0YXRzIHx8IHt9OwogICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhzdGF0cy50aW1lc3RhbXAsIHN0YXRzLnBhY2tldHNMb3N0LCBzdGF0cy5wYWNrZXRzQ291bnQsIHN0cmVhbVR5cGUsIHN0YXRzLmF1ZGlvTGV2ZWwpOwogIH07CgogIHZhciBTb2Z0cGhvbmVMb2dnZXIgPSBmdW5jdGlvbiAobG9nZ2VyKSB7CiAgICB0aGlzLl9vcmlnaW5hbExvZ2dlciA9IGxvZ2dlcjsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMuX3RlZSA9IGZ1bmN0aW9uIChsZXZlbCwgbWV0aG9kKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gY2FsbCB0aGUgb3JpZ2luYWwgbG9nZ2VyIG9iamVjdCB0byBvdXRwdXQgdG8gYnJvd3NlcgogICAgICAgIC8vQ29ubmVjdCBsb2dnZXIgZm9sbG93cyAlcyBmb3JtYXQgdG8gcHJpbnQgb2JqZWN0cyB0byBjb25zb2xlLgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzWzBdKTsKICAgICAgICB2YXIgZm9ybWF0ID0gIiI7CiAgICAgICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCArICIgJXMiOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkoc2VsZi5fb3JpZ2luYWxMb2dnZXIsIFtjb25uZWN0LkxvZ0NvbXBvbmVudC5TT0ZUUEhPTkUsIGZvcm1hdF0uY29uY2F0KGFyZ3MpKTsKICAgICAgfTsKICAgIH07CiAgfTsKCiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoMSwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuZGVidWcpKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDIsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmluZm8pKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmxvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoMywgdGhpcy5fb3JpZ2luYWxMb2dnZXIubG9nKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS53YXJuID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSg0LCB0aGlzLl9vcmlnaW5hbExvZ2dlci53YXJuKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoNSwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuZXJyb3IpKGFyZ3VtZW50cyk7CiAgfTsKCiAgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyID0gU29mdHBob25lTWFuYWdlcjsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDk0NDoKLyoqKi8gKCgpID0+IHsKCi8qISBAbGljZW5zZSBzcHJpbnRmLmpzIHwgQ29weXJpZ2h0IChjKSAyMDA3LTIwMTMgQWxleGFuZHJ1IE1hcmFzdGVhbnUgPGhlbGxvIGF0IGFsZXhlaSBkb3Qgcm8+IHwgMyBjbGF1c2UgQlNEIGxpY2Vuc2UgKi8KCihmdW5jdGlvbigpIHsKICAgdmFyIGN0eCA9IHRoaXM7CgoJdmFyIHNwcmludGYgPSBmdW5jdGlvbigpIHsKCQlpZiAoIXNwcmludGYuY2FjaGUuaGFzT3duUHJvcGVydHkoYXJndW1lbnRzWzBdKSkgewoJCQlzcHJpbnRmLmNhY2hlW2FyZ3VtZW50c1swXV0gPSBzcHJpbnRmLnBhcnNlKGFyZ3VtZW50c1swXSk7CgkJfQoJCXJldHVybiBzcHJpbnRmLmZvcm1hdC5jYWxsKG51bGwsIHNwcmludGYuY2FjaGVbYXJndW1lbnRzWzBdXSwgYXJndW1lbnRzKTsKCX07CgoJc3ByaW50Zi5mb3JtYXQgPSBmdW5jdGlvbihwYXJzZV90cmVlLCBhcmd2KSB7CgkJdmFyIGN1cnNvciA9IDEsIHRyZWVfbGVuZ3RoID0gcGFyc2VfdHJlZS5sZW5ndGgsIG5vZGVfdHlwZSA9ICcnLCBhcmcsIG91dHB1dCA9IFtdLCBpLCBrLCBtYXRjaCwgcGFkLCBwYWRfY2hhcmFjdGVyLCBwYWRfbGVuZ3RoOwoJCWZvciAoaSA9IDA7IGkgPCB0cmVlX2xlbmd0aDsgaSsrKSB7CgkJCW5vZGVfdHlwZSA9IGdldF90eXBlKHBhcnNlX3RyZWVbaV0pOwoJCQlpZiAobm9kZV90eXBlID09PSAnc3RyaW5nJykgewoJCQkJb3V0cHV0LnB1c2gocGFyc2VfdHJlZVtpXSk7CgkJCX0KCQkJZWxzZSBpZiAobm9kZV90eXBlID09PSAnYXJyYXknKSB7CgkJCQltYXRjaCA9IHBhcnNlX3RyZWVbaV07IC8vIGNvbnZlbmllbmNlIHB1cnBvc2VzIG9ubHkKCQkJCWlmIChtYXRjaFsyXSkgeyAvLyBrZXl3b3JkIGFyZ3VtZW50CgkJCQkJYXJnID0gYXJndltjdXJzb3JdOwoJCQkJCWZvciAoayA9IDA7IGsgPCBtYXRjaFsyXS5sZW5ndGg7IGsrKykgewoJCQkJCQlpZiAoIWFyZy5oYXNPd25Qcm9wZXJ0eShtYXRjaFsyXVtrXSkpIHsKCQkJCQkJCXRocm93KHNwcmludGYoJ1tzcHJpbnRmXSBwcm9wZXJ0eSAiJXMiIGRvZXMgbm90IGV4aXN0JywgbWF0Y2hbMl1ba10pKTsKCQkJCQkJfQoJCQkJCQlhcmcgPSBhcmdbbWF0Y2hbMl1ba11dOwoJCQkJCX0KCQkJCX0KCQkJCWVsc2UgaWYgKG1hdGNoWzFdKSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGV4cGxpY2l0KQoJCQkJCWFyZyA9IGFyZ3ZbbWF0Y2hbMV1dOwoJCQkJfQoJCQkJZWxzZSB7IC8vIHBvc2l0aW9uYWwgYXJndW1lbnQgKGltcGxpY2l0KQoJCQkJCWFyZyA9IGFyZ3ZbY3Vyc29yKytdOwoJCQkJfQoKCQkJCWlmICgvW15zXS8udGVzdChtYXRjaFs4XSkgJiYgKGdldF90eXBlKGFyZykgIT0gJ251bWJlcicpKSB7CgkJCQkJdGhyb3coc3ByaW50ZignW3NwcmludGZdIGV4cGVjdGluZyBudW1iZXIgYnV0IGZvdW5kICVzJywgZ2V0X3R5cGUoYXJnKSkpOwoJCQkJfQoJCQkJc3dpdGNoIChtYXRjaFs4XSkgewoJCQkJCWNhc2UgJ2InOiBhcmcgPSBhcmcudG9TdHJpbmcoMik7IGJyZWFrOwoJCQkJCWNhc2UgJ2MnOiBhcmcgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ2QnOiBhcmcgPSBwYXJzZUludChhcmcsIDEwKTsgYnJlYWs7CgkJCQkJY2FzZSAnZSc6IGFyZyA9IG1hdGNoWzddID8gYXJnLnRvRXhwb25lbnRpYWwobWF0Y2hbN10pIDogYXJnLnRvRXhwb25lbnRpYWwoKTsgYnJlYWs7CgkJCQkJY2FzZSAnZic6IGFyZyA9IG1hdGNoWzddID8gcGFyc2VGbG9hdChhcmcpLnRvRml4ZWQobWF0Y2hbN10pIDogcGFyc2VGbG9hdChhcmcpOyBicmVhazsKCQkJCQljYXNlICdvJzogYXJnID0gYXJnLnRvU3RyaW5nKDgpOyBicmVhazsKCQkJCQljYXNlICdzJzogYXJnID0gKChhcmcgPSBTdHJpbmcoYXJnKSkgJiYgbWF0Y2hbN10gPyBhcmcuc3Vic3RyaW5nKDAsIG1hdGNoWzddKSA6IGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ3UnOiBhcmcgPSBhcmcgPj4+IDA7IGJyZWFrOwoJCQkJCWNhc2UgJ3gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpOyBicmVhazsKCQkJCQljYXNlICdYJzogYXJnID0gYXJnLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOyBicmVhazsKCQkJCX0KCQkJCWFyZyA9ICgvW2RlZl0vLnRlc3QobWF0Y2hbOF0pICYmIG1hdGNoWzNdICYmIGFyZyA+PSAwID8gJysnKyBhcmcgOiBhcmcpOwoJCQkJcGFkX2NoYXJhY3RlciA9IG1hdGNoWzRdID8gbWF0Y2hbNF0gPT0gJzAnID8gJzAnIDogbWF0Y2hbNF0uY2hhckF0KDEpIDogJyAnOwoJCQkJcGFkX2xlbmd0aCA9IG1hdGNoWzZdIC0gU3RyaW5nKGFyZykubGVuZ3RoOwoJCQkJcGFkID0gbWF0Y2hbNl0gPyBzdHJfcmVwZWF0KHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGgpIDogJyc7CgkJCQlvdXRwdXQucHVzaChtYXRjaFs1XSA/IGFyZyArIHBhZCA6IHBhZCArIGFyZyk7CgkJCX0KCQl9CgkJcmV0dXJuIG91dHB1dC5qb2luKCcnKTsKCX07CgoJc3ByaW50Zi5jYWNoZSA9IHt9OwoKCXNwcmludGYucGFyc2UgPSBmdW5jdGlvbihmbXQpIHsKCQl2YXIgX2ZtdCA9IGZtdCwgbWF0Y2ggPSBbXSwgcGFyc2VfdHJlZSA9IFtdLCBhcmdfbmFtZXMgPSAwOwoJCXdoaWxlIChfZm10KSB7CgkJCWlmICgobWF0Y2ggPSAvXlteXHgyNV0rLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJcGFyc2VfdHJlZS5wdXNoKG1hdGNoWzBdKTsKCQkJfQoJCQllbHNlIGlmICgobWF0Y2ggPSAvXlx4MjV7Mn0vLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlwYXJzZV90cmVlLnB1c2goJyUnKTsKCQkJfQoJCQllbHNlIGlmICgobWF0Y2ggPSAvXlx4MjUoPzooWzEtOV1cZCopXCR8XCgoW15cKV0rKVwpKT8oXCspPygwfCdbXiRdKT8oLSk/KFxkKyk/KD86XC4oXGQrKSk/KFtiLWZvc3V4WF0pLy5leGVjKF9mbXQpKSAhPT0gbnVsbCkgewoJCQkJaWYgKG1hdGNoWzJdKSB7CgkJCQkJYXJnX25hbWVzIHw9IDE7CgkJCQkJdmFyIGZpZWxkX2xpc3QgPSBbXSwgcmVwbGFjZW1lbnRfZmllbGQgPSBtYXRjaFsyXSwgZmllbGRfbWF0Y2ggPSBbXTsKCQkJCQlpZiAoKGZpZWxkX21hdGNoID0gL14oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQl3aGlsZSAoKHJlcGxhY2VtZW50X2ZpZWxkID0gcmVwbGFjZW1lbnRfZmllbGQuc3Vic3RyaW5nKGZpZWxkX21hdGNoWzBdLmxlbmd0aCkpICE9PSAnJykgewoJCQkJCQkJaWYgKChmaWVsZF9tYXRjaCA9IC9eXC4oW2Etel9dW2Etel9cZF0qKS9pLmV4ZWMocmVwbGFjZW1lbnRfZmllbGQpKSAhPT0gbnVsbCkgewoJCQkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIGlmICgoZmllbGRfbWF0Y2ggPSAvXlxbKFxkKylcXS8uZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgewoJCQkJCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJCQl9CgkJCQkJbWF0Y2hbMl0gPSBmaWVsZF9saXN0OwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJYXJnX25hbWVzIHw9IDI7CgkJCQl9CgkJCQlpZiAoYXJnX25hbWVzID09PSAzKSB7CgkJCQkJdGhyb3coJ1tzcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQnKTsKCQkJCX0KCQkJCXBhcnNlX3RyZWUucHVzaChtYXRjaCk7CgkJCX0KCQkJZWxzZSB7CgkJCQl0aHJvdygnW3NwcmludGZdIGh1aD8nKTsKCQkJfQoJCQlfZm10ID0gX2ZtdC5zdWJzdHJpbmcobWF0Y2hbMF0ubGVuZ3RoKTsKCQl9CgkJcmV0dXJuIHBhcnNlX3RyZWU7Cgl9OwoKCXZhciB2c3ByaW50ZiA9IGZ1bmN0aW9uKGZtdCwgYXJndiwgX2FyZ3YpIHsKCQlfYXJndiA9IGFyZ3Yuc2xpY2UoMCk7CgkJX2FyZ3Yuc3BsaWNlKDAsIDAsIGZtdCk7CgkJcmV0dXJuIHNwcmludGYuYXBwbHkobnVsbCwgX2FyZ3YpOwoJfTsKCgkvKioKCSAqIGhlbHBlcnMKCSAqLwoJZnVuY3Rpb24gZ2V0X3R5cGUodmFyaWFibGUpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhcmlhYmxlKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKTsKCX0KCglmdW5jdGlvbiBzdHJfcmVwZWF0KGlucHV0LCBtdWx0aXBsaWVyKSB7CgkJZm9yICh2YXIgb3V0cHV0ID0gW107IG11bHRpcGxpZXIgPiAwOyBvdXRwdXRbLS1tdWx0aXBsaWVyXSA9IGlucHV0KSB7LyogZG8gbm90aGluZyAqL30KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfQoKCS8qKgoJICogZXhwb3J0IHRvIGVpdGhlciBicm93c2VyIG9yIG5vZGUuanMKCSAqLwoJY3R4LnNwcmludGYgPSBzcHJpbnRmOwoJY3R4LnZzcHJpbnRmID0gdnNwcmludGY7Cn0pKCk7CgoKCi8qKiovIH0pLAoKLyoqKi8gODI6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24oKSB7CiAgIHZhciBnbG9iYWwgPSB0aGlzOwogICBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFN0cmVhbQogICAgKgogICAgKiBSZXByZXNlbnRzIGFuIG9iamVjdCBmcm9tIHdoaWNoIG1lc3NhZ2VzIGNhbiBiZSByZWFkIGFuZCB0byB3aGljaAogICAgKiBtZXNzYWdlcyBjYW4gYmUgc2VudC4KICAgICovCiAgIHZhciBTdHJlYW0gPSBmdW5jdGlvbigpIHt9OwoKICAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIHRoZSBzdHJlYW0uICBUaGlzIG1ldGhvZCBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzZXMuCiAgICAqLwogICBTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoKTsKICAgfTsKCiAgIC8qKgogICAgKiBQcm92aWRlIGEgbWV0aG9kIHRvIGJlIGNhbGxlZCB3aGVuIG1lc3NhZ2VzIGFyZSByZWNlaXZlZCBmcm9tIHRoaXMgc3RyZWFtLgogICAgKiBUaGlzIG1ldGhvZCBtdXN0IGJlIGltcGxlbWVudGVkIGJ5IHN1YmNsYXNzZXMuCiAgICAqLwogICBTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIE51bGxTdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBudWxsIHN0cmVhbSB3aGljaCBwcm92aWRlcyBubyBtZXNzYWdlIHNlbmRpbmcgb3IgcmVjZWl2aW5nIGZhY2lsaXRpZXMuCiAgICAqLwogICB2YXIgTnVsbFN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgfTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IE51bGxTdHJlYW07CgogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7fTsKICAgTnVsbFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHt9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFdpbmRvd1N0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSBmb3IgY29tbXVuaWNhdGluZyB3aXRoIGEgd2luZG93IG9iamVjdC4gIFRoZSBkb21haW4gcHJvdmlkZWQKICAgICogbXVzdCBtYXRjaCB0aGUgYWxsb3dlZCBtZXNzYWdlIGRvbWFpbnMgb2YgdGhlIGRvd25zdHJlYW0gcmVjZWl2ZXIKICAgICogb3IgbWVzc2FnZXMgd2lsbCBiZSByZWplY3RlZCwgc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9XaW5kb3cvcG9zdE1lc3NhZ2UKICAgICogZm9yIG1vcmUgaW5mby4KICAgICovCiAgIHZhciBXaW5kb3dTdHJlYW0gPSBmdW5jdGlvbih3aW4sIGRvbWFpbikgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy53aW5kb3cgPSB3aW47CiAgICAgIHRoaXMuZG9tYWluID0gZG9tYWluIHx8ICcqJzsKICAgfTsKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXaW5kb3dTdHJlYW07CgogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMud2luZG93LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRoaXMuZG9tYWluKTsKICAgfTsKCiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLndpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwgZik7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgV2luZG93SU9TdHJlYW0gZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSBzdHJlYW0gdXNlZCBieSBJRnJhbWUvcG9wdXAgd2luZG93cyB0byBjb21tdW5pY2F0ZSB3aXRoIHRoZWlyIHBhcmVudHMKICAgICogYW5kIHZpc2UgdmVyc2EuCiAgICAqCiAgICAqIFRoaXMgb2JqZWN0IGVuY2Fwc3VsYXRlcyB0aGUgZmFjdCB0aGF0IGluY29taW5nIGFuZCBvdXRnb2luZyBtZXNzYWdlcwogICAgKiBhcnJpdmUgb24gZGlmZmVyZW50IHdpbmRvd3MgYW5kIGFsbG93cyB0aGlzIHRvIGJlIG1hbmFnZWQgYXMgYSBzaW5nbGUKICAgICogU3RyZWFtIG9iamVjdC4KICAgICovCiAgIHZhciBXaW5kb3dJT1N0cmVhbSA9IGZ1bmN0aW9uKGlucHV0d2luLCBvdXRwdXR3aW4sIGRvbWFpbikgewogICAgICBTdHJlYW0uY2FsbCh0aGlzKTsKICAgICAgdGhpcy5pbnB1dCA9IGlucHV0d2luOwogICAgICB0aGlzLm91dHB1dCA9IG91dHB1dHdpbjsKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gfHwgJyonOwogICB9OwogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFN0cmVhbS5wcm90b3R5cGUpOwogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBXaW5kb3dJT1N0cmVhbTsKCiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLm91dHB1dC5wb3N0TWVzc2FnZShtZXNzYWdlLCB0aGlzLmRvbWFpbik7CiAgIH07CgogICBXaW5kb3dJT1N0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLmlucHV0LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCAobWVzc2FnZSkgPT4gewogICAgICAgICBpZiAobWVzc2FnZS5zb3VyY2UgPT09IHRoaXMub3V0cHV0KSB7CiAgICAgICAgICAgIGYobWVzc2FnZSk7CiAgICAgICAgIH0KICAgICAgfSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgUG9ydFN0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSB3cmFwcGluZyBhbiBIVE1MNSBXb3JrZXIgcG9ydC4gIFRoaXMgY291bGQgYmUgdGhlIHBvcnQKICAgICogdXNlZCB0byBjb25uZWN0IHRvIGEgV29ya2VyIG9yIG9uZSBvZiB0aGUgbXVsdGl0dWRlIG9mIHBvcnRzCiAgICAqIG1hZGUgYXZhaWxhYmxlIHRvIGEgU2hhcmVkV29ya2VyIGZvciBjb21tdW5pY2F0aW9uIGJhY2sgdG8KICAgICogaXRzIGNvbm5lY3RlZCBjbGllbnRzLgogICAgKi8KICAgdmFyIFBvcnRTdHJlYW0gPSBmdW5jdGlvbihwb3J0KSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLnBvcnQgPSBwb3J0OwogICAgICB0aGlzLmlkID0gY29ubmVjdC5yYW5kb21JZCgpOwogICB9OwogICBQb3J0U3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUG9ydFN0cmVhbTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMucG9ydC5wb3N0TWVzc2FnZShtZXNzYWdlKTsKICAgfTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5wb3J0LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmKTsKICAgfTsKCiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlLmdldElkID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIFN0cmVhbU11bHRpcGxleGVyIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgd3JhcHBlciBmb3IgbXVsdGlwbGV4ZWQgZG93bnN0cmVhbSBjb21tdW5pY2F0aW9uIHdpdGgKICAgICogbXVsdGlwbGUgc3RyZWFtcyBhdCBvbmNlLiAgTWFpbmx5IHVzZWZ1bCBmb3IgdGhlIFNoYXJlZFdvcmtlciB0bwogICAgKiBicm9hZGNhc3QgZXZlbnRzIHRvIG1hbnkgUG9ydFN0cmVhbSBvYmplY3RzIGF0IG9uY2UuCiAgICAqLwogICB2YXIgU3RyZWFtTXVsdGlwbGV4ZXIgPSBmdW5jdGlvbihzdHJlYW1zKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLnN0cmVhbU1hcCA9IHN0cmVhbXMgPwogICAgICAgICBjb25uZWN0LmluZGV4KHN0cmVhbXMsIGZ1bmN0aW9uKHMpIHsgcmV0dXJuIHMuZ2V0SWQoKTsgfSkgOiB7fTsKICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzID0gW107CiAgIH07CiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFN0cmVhbU11bHRpcGxleGVyOwoKICAgLyoqCiAgICAqIFNlbmQgYSBtZXNzYWdlIHRvIGFsbCBwb3J0cyBpbiB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5nZXRTdHJlYW1zKCkuZm9yRWFjaChmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc3RyZWFtLnNlbmQobWVzc2FnZSk7CgogICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIENvdWxkbid0IHNlbmQgbWVzc2FnZSB0byBvbmUgb2YgdGhlIGRvd25zdHJlYW1zIGZvciBzb21lIHJlYXNvbi4uLgogICAgICAgICAgICAvLyBObyByZWxpYWJsZSBsb2dnaW5nIHBvc3NpYmxlIHdpdGhvdXQgZnVydGhlciBmYWlsdXJlcywKICAgICAgICAgICAgLy8gbm8gcmVjb3ZlcnksIGp1c3QgZWF0IGl0LgogICAgICAgICB9CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIFJlZ2lzdGVyIGEgbWV0aG9kIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHdoZW4gYSBtZXNzYWdlIGlzIHJlY2VpdmVkIGZyb20KICAgICogYW55IG9mIHRoZSBkb3duc3RyZWFtcy4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycy5wdXNoKGYpOwoKICAgICAgLy8gVXBkYXRlIGV4aXN0aW5nIHN0cmVhbXMgd2l0aCB0aGUgbmV3IGxpc3RlbmVyLgogICAgICB0aGlzLmdldFN0cmVhbXMoKS5mb3JFYWNoKGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICBzdHJlYW0ub25NZXNzYWdlKGYpOwogICAgICB9KTsKICAgfTsKCiAgIC8qKgogICAgKiBBZGQgYSBzdHJlYW0gdG8gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmFkZFN0cmVhbSA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHRoaXMuc3RyZWFtTWFwW3N0cmVhbS5nZXRJZCgpXSA9IHN0cmVhbTsKCiAgICAgIC8vIFVwZGF0ZSBzdHJlYW0gd2l0aCBleGlzdGluZyBsaXN0ZW5lcnMuCiAgICAgIHRoaXMubWVzc2FnZUxpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uKG1lc3NhZ2VMaXN0ZW5lcikgewogICAgICAgICBzdHJlYW0ub25NZXNzYWdlKG1lc3NhZ2VMaXN0ZW5lcik7CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIFJlbW92ZSB0aGUgZ2l2ZW4gZG93bnN0cmVhbS4gIFRoaXMgaXMgdHlwaWNhbGx5IHVzZWQgaW4gcmVzcG9uc2UKICAgICogdG8gdGhlIFNoYXJlZFdvcmtlcidzIG9uY2xvc2UgZXZlbnQsIGluZGljYXRpbmcgdGhhdCBhIGNvbnN1bWVyCiAgICAqIHRhYiBoYXMgYmVlbiBjbG9zZWQuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUucmVtb3ZlU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN0cmVhbU1hcFtzdHJlYW0uZ2V0SWQoKV07CiAgIH07CgogICAvKioKICAgICogR2V0IGEgbGlzdCBvZiBzdHJlYW1zIGluIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5nZXRTdHJlYW1zID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN0cmVhbU1hcCk7CiAgIH07CgogICAvKioKICAgICogR2V0IHRoZSBzdHJlYW0gbWF0Y2hpbmcgdGhlIGdpdmVuIHBvcnQuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuZ2V0U3RyZWFtRm9yUG9ydCA9IGZ1bmN0aW9uKHBvcnQpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldFN0cmVhbXMoKSwgZnVuY3Rpb24ocykgewogICAgICAgICByZXR1cm4gcy5wb3J0ID09PSBwb3J0OwogICAgICB9KTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBDb25kdWl0CiAgICAqCiAgICAqIEFuIG9iamVjdCB3aGljaCBicmlkZ2VzIGFuIHVwc3RyZWFtIGFuZCBhIGRvd25zdHJlYW0sIGFsbG93aW5nIG1lc3NhZ2VzCiAgICAqIHRvIGJlIHBhc3NlZCB0byBhbmQgZnJvbSBlYWNoIGFuZCBwcm92aWRpbmcgYW4gZXZlbnQgYnVzIGZvciBldmVudAogICAgKiBzdWJzY3JpcHRpb25zIHRvIGJlIG1hZGUgdXBzdHJlYW0gYW5kIGRvd25zdHJlYW0uCiAgICAqLwogICB2YXIgQ29uZHVpdCA9IGZ1bmN0aW9uKG5hbWUsIHVwc3RyZWFtLCBkb3duc3RyZWFtKSB7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMudXBzdHJlYW0gPSB1cHN0cmVhbSB8fCBuZXcgTnVsbFN0cmVhbSgpOwogICAgICB0aGlzLmRvd25zdHJlYW0gPSBkb3duc3RyZWFtIHx8IG5ldyBOdWxsU3RyZWFtKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbUJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CiAgICAgIHRoaXMudXBzdHJlYW1CdXMgPSBuZXcgY29ubmVjdC5FdmVudEJ1cygpOwoKICAgICAgdGhpcy51cHN0cmVhbS5vbk1lc3NhZ2UoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9kaXNwYXRjaEV2ZW50LCB0aGlzLnVwc3RyZWFtQnVzKSk7CiAgICAgIHRoaXMuZG93bnN0cmVhbS5vbk1lc3NhZ2UoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLl9kaXNwYXRjaEV2ZW50LCB0aGlzLmRvd25zdHJlYW1CdXMpKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uVXBzdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLnVwc3RyZWFtQnVzLnN1YnNjcmliZShldmVudE5hbWUsIGYpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25BbGxVcHN0cmVhbSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy51cHN0cmVhbUJ1cy5zdWJzY3JpYmVBbGwoZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkRvd25zdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLmRvd25zdHJlYW1CdXMuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkFsbERvd25zdHJlYW0gPSBmdW5jdGlvbihmKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMuZG93bnN0cmVhbUJ1cy5zdWJzY3JpYmVBbGwoZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5zZW5kVXBzdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICB0aGlzLnVwc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLnNlbmREb3duc3RyZWFtID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgICAgdGhpcy5kb3duc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLl9kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24oYnVzLCBtZXNzYWdlRXZlbnQpIHsKICAgICAgdmFyIG1lc3NhZ2UgPSBtZXNzYWdlRXZlbnQuZGF0YTsKICAgICAgaWYgKG1lc3NhZ2UuZXZlbnQpIHsKICAgICAgICAgYnVzLnRyaWdnZXIobWVzc2FnZS5ldmVudCwgbWVzc2FnZS5kYXRhKTsKICAgICAgfQogICB9OwoKICAgLyoqCiAgICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIHBhc3NlcyBldmVudHMgdXBzdHJlYW0uCiAgICAqCiAgICAqIFVzYWdlOgogICAgKiBjb25kdWl0Lm9uRG93bnN0cmVhbSgiTXlFdmVudCIsIGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUucGFzc1Vwc3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEsIGV2ZW50TmFtZSkgewogICAgICAgICBzZWxmLnVwc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgICAgfTsKICAgfTsKCiAgIC8qKgogICAgKiBSZXR1cm5zIGEgY2xvc3VyZSB3aGljaCBwYXNzZXMgZXZlbnRzIGRvd25zdHJlYW0uCiAgICAqCiAgICAqIFVzYWdlOgogICAgKiBjb25kdWl0Lm9uVXBzdHJlYW0oIk15RXZlbnQiLCBjb25kdWl0LnBhc3NEb3duc3RyZWFtKCkpOwogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUucGFzc0Rvd25zdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSwgZXZlbnROYW1lKSB7CiAgICAgICAgIHNlbGYuZG93bnN0cmVhbS5zZW5kKHtldmVudDogZXZlbnROYW1lLCBkYXRhOiBkYXRhfSk7CiAgICAgIH07CiAgIH07CgogICAvKioKICAgICogU2h1dGRvd24gdGhlIGNvbmR1aXQncyBldmVudCBidXNzZXMgYW5kIHJlbW92ZSBhbGwgc3Vic2NyaXB0aW9ucy4KICAgICovCiAgIENvbmR1aXQucHJvdG90eXBlLnNodXRkb3duID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMudXBzdHJlYW1CdXMudW5zdWJzY3JpYmVBbGwoKTsKICAgICAgdGhpcy5kb3duc3RyZWFtQnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgSUZyYW1lQ29uZHVpdCBleHRlbmRzIENvbmR1aXQKICAgICoKICAgICogQ3JlYXRlcyBhIGNvbmR1aXQgZm9yIHRoZSBnaXZlbiBJRnJhbWUgZWxlbWVudC4KICAgICovCiAgIHZhciBJRnJhbWVDb25kdWl0ID0gZnVuY3Rpb24obmFtZSwgd2luZG93LCBpZnJhbWUsIGRvbWFpbikgewogICAgICBDb25kdWl0LmNhbGwodGhpcywgbmFtZSwgbmV3IFdpbmRvd0lPU3RyZWFtKHdpbmRvdywgaWZyYW1lLmNvbnRlbnRXaW5kb3csIGRvbWFpbiB8fCAnKicpLCBudWxsKTsKICAgfTsKICAgSUZyYW1lQ29uZHVpdC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbmR1aXQucHJvdG90eXBlKTsKICAgSUZyYW1lQ29uZHVpdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBJRnJhbWVDb25kdWl0OwoKICAgY29ubmVjdC5TdHJlYW0gPSBTdHJlYW07CiAgIGNvbm5lY3QuTnVsbFN0cmVhbSA9IE51bGxTdHJlYW07CiAgIGNvbm5lY3QuV2luZG93U3RyZWFtID0gV2luZG93U3RyZWFtOwogICBjb25uZWN0LldpbmRvd0lPU3RyZWFtID0gV2luZG93SU9TdHJlYW07CiAgIGNvbm5lY3QuUG9ydFN0cmVhbSA9IFBvcnRTdHJlYW07CiAgIGNvbm5lY3QuU3RyZWFtTXVsdGlwbGV4ZXIgPSBTdHJlYW1NdWx0aXBsZXhlcjsKICAgY29ubmVjdC5Db25kdWl0ID0gQ29uZHVpdDsKICAgY29ubmVjdC5JRnJhbWVDb25kdWl0ID0gSUZyYW1lQ29uZHVpdDsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDgzMzoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIEdyYXBoTGluayA8PGFic3RyYWN0IGNsYXNzPj4KICAgICoKICAgICogUmVwcmVzZW50cyB0aGUgYXNzb2NpYXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgR3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIHRoaXMuZnJvbVN0YXRlID0gZnJvbVN0YXRlOwogICAgICB0aGlzLnRvU3RhdGUgPSB0b1N0YXRlOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRBc3NvY2lhdGlvbnMgPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgIHRocm93IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRGcm9tU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZnJvbVN0YXRlOwogICB9OwoKICAgR3JhcGhMaW5rLnByb3RvdHlwZS5nZXRUb1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnRvU3RhdGU7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIERpcmVjdEdyYXBoTGluayA8PGNvbmNyZXRlIGNsYXNzPj4gZXh0ZW5kcyBHcmFwaExpbmsKICAgICoKICAgICogUmVwcmVzZW50cyB0aGUgYnktdmFsdWUgcmVwcmVzZW50YXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhCiAgICAqIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgRGlyZWN0R3JhcGhMaW5rID0gZnVuY3Rpb24oZnJvbVN0YXRlLCB0b1N0YXRlLCBhc3NvY2lhdGlvbnMpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGFzc29jaWF0aW9ucywgJ2Fzc29jaWF0aW9ucycpOwogICAgICBHcmFwaExpbmsuY2FsbCh0aGlzLCBmcm9tU3RhdGUsIHRvU3RhdGUpOwogICAgICB0aGlzLmFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9uczsKICAgfTsKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3JhcGhMaW5rLnByb3RvdHlwZSk7CiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEaXJlY3RHcmFwaExpbms7CgogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuYXNzb2NpYXRpb25zOwogICB9OwoKICAgLyoqCiAgICAqIEZ1bmN0aW9uYWxHcmFwaExpbmsgPDxjb25jcmV0ZSBjbGFzcz4+IGV4dGVuZHMgR3JhcGhMaW5rCiAgICAqCiAgICAqIFJlcHJlc2VudHMgYSBmdW5jdGlvbmFsIGFzc29jaWF0aW9uIG9mIG9uZSBvciBtb3JlIGF0dHJpYnV0ZXMgdG8gYQogICAgKiBzdGF0ZSB0cmFuc2l0aW9uLgogICAgKi8KICAgdmFyIEZ1bmN0aW9uYWxHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUsIGNsb3N1cmUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNsb3N1cmUsICdjbG9zdXJlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2xvc3VyZSksICdjbG9zdXJlIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBHcmFwaExpbmsuY2FsbCh0aGlzLCBmcm9tU3RhdGUsIHRvU3RhdGUpOwogICAgICB0aGlzLmNsb3N1cmUgPSBjbG9zdXJlOwogICB9OwogICBGdW5jdGlvbmFsR3JhcGhMaW5rLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoR3JhcGhMaW5rLnByb3RvdHlwZSk7CiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRnVuY3Rpb25hbEdyYXBoTGluazsKCiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMuY2xvc3VyZShjb250ZXh0LCB0aGlzLmdldEZyb21TdGF0ZSgpLCB0aGlzLmdldFRvU3RhdGUoKSk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIEV2ZW50R3JhcGggPDxjbGFzcz4+CiAgICAqCiAgICAqIEJ1aWxkcyBhIG1hcCBvZiBhc3NvY2lhdGlvbnMgZnJvbSBvbmUgc3RhdGUgdG8gYW5vdGhlciBpbiBjb250ZXh0IG9mIGEKICAgICogcGFydGljdWxhciBvYmplY3QuICBUaGUgYXNzb2NpYXRpb25zIGNhbiBiZSBkaXJlY3QgKG9uZSBvciBtb3JlIHZhbHVlcykKICAgICogb3IgZnVuY3Rpb25hbCAoYSBtZXRob2QgcmV0dXJuaW5nIG9uZSBvciBtb3JlIHZhbHVlcyksIGFuZCBhcmUgdXNlZCB0bwogICAgKiBwcm92aWRlIGFkZGl0aW9uYWwgY29udGV4dHVhbCBldmVudCBob29rcyBmb3IgdGhlIFVJIHRvIGNvbnN1bWUuCiAgICAqLwogICB2YXIgRXZlbnRHcmFwaCA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmZyb21NYXAgPSB7fTsKICAgfTsKICAgRXZlbnRHcmFwaC5BTlkgPSAiPDxhbnk+PiI7CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5hc3NvYyA9IGZ1bmN0aW9uKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgaWYgKCEgZnJvbVN0YXRlT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZnJvbVN0YXRlT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoISB0b1N0YXRlT2JqKSB7CiAgICAgICAgIHRocm93IG5ldyBFcnJvcigidG9TdGF0ZU9iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKCEgYXNzb2NPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhc3NvY09iaiBpcyBub3QgZGVmaW5lZC4iKTsKICAgICAgfQoKICAgICAgaWYgKGZyb21TdGF0ZU9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgIGZyb21TdGF0ZU9iai5mb3JFYWNoKGZ1bmN0aW9uKGZyb21TdGF0ZSkgewogICAgICAgICAgICBzZWxmLmFzc29jKGZyb21TdGF0ZSwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopOwogICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0b1N0YXRlT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgdG9TdGF0ZU9iai5mb3JFYWNoKGZ1bmN0aW9uKHRvU3RhdGUpIHsKICAgICAgICAgICAgc2VsZi5hc3NvYyhmcm9tU3RhdGVPYmosIHRvU3RhdGUsIGFzc29jT2JqKTsKICAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgIGlmICh0eXBlb2YgYXNzb2NPYmogPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IEZ1bmN0aW9uYWxHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikpOwogICAgICAgICB9IGVsc2UgaWYgKGFzc29jT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IERpcmVjdEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSk7CiAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX2FkZEFzc29jaWF0aW9uKG5ldyBEaXJlY3RHcmFwaExpbmsoZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBbYXNzb2NPYmpdKSk7CiAgICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICB2YXIgYXNzb2NpYXRpb25zID0gW107CgogICAgICB2YXIgdG9NYXBGcm9tQW55ID0gdGhpcy5mcm9tTWFwW0V2ZW50R3JhcGguQU5ZXSB8fCB7fTsKICAgICAgdmFyIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Zyb21TdGF0ZV0gfHwge307CgogICAgICBhc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnMuY29uY2F0KHRoaXMuX2dldEFzc29jaWF0aW9uc0Zyb21NYXAoCiAgICAgICAgICAgICAgIHRvTWFwRnJvbUFueSwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSk7CiAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQodGhpcy5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCgKICAgICAgICAgICAgICAgdG9NYXAsIGNvbnRleHQsIGZyb21TdGF0ZSwgdG9TdGF0ZSkpOwoKICAgICAgcmV0dXJuIGFzc29jaWF0aW9uczsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLl9hZGRBc3NvY2lhdGlvbiA9IGZ1bmN0aW9uKGFzc29jKSB7CiAgICAgIHZhciB0b01hcCA9IHRoaXMuZnJvbU1hcFthc3NvYy5nZXRGcm9tU3RhdGUoKV07CgogICAgICBpZiAoISB0b01hcCkgewogICAgICAgICB0b01hcCA9IHRoaXMuZnJvbU1hcFthc3NvYy5nZXRGcm9tU3RhdGUoKV0gPSB7fTsKICAgICAgfQoKICAgICAgdmFyIGFzc29jTGlzdCA9IHRvTWFwW2Fzc29jLmdldFRvU3RhdGUoKV07CgogICAgICBpZiAoISBhc3NvY0xpc3QpIHsKICAgICAgICAgYXNzb2NMaXN0ID0gdG9NYXBbYXNzb2MuZ2V0VG9TdGF0ZSgpXSA9IFtdOwogICAgICB9CgogICAgICBhc3NvY0xpc3QucHVzaChhc3NvYyk7CiAgIH07CgogICBFdmVudEdyYXBoLnByb3RvdHlwZS5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCA9IGZ1bmN0aW9uKG1hcCwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIHZhciBhc3NvY0xpc3QgPSAobWFwW0V2ZW50R3JhcGguQU5ZXSB8fCBbXSkuY29uY2F0KG1hcFt0b1N0YXRlXSB8fCBbXSk7CiAgICAgIHJldHVybiBhc3NvY0xpc3QucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGFzc29jKSB7CiAgICAgICAgIHJldHVybiBwcmV2LmNvbmNhdChhc3NvYy5nZXRBc3NvY2lhdGlvbnMoY29udGV4dCkpOwogICAgICB9LCBbXSk7CiAgIH07CgogICBjb25uZWN0LkV2ZW50R3JhcGggPSBFdmVudEdyYXBoOwoKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDg5MToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXM7CiAgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIHZhciB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogIHZhciBPTkVfREFZX01JTExJUyA9IDI0ICogNjAgKiA2MCAqIDEwMDA7CiAgdmFyIERFRkFVTFRfUE9QVVBfSEVJR0hUID0gNTc4OwogIHZhciBERUZBVUxUX1BPUFVQX1dJRFRIID0gNDMzOwogIHZhciBDT1BZQUJMRV9FVkVOVF9GSUVMRFMgPSBbImJ1YmJsZXMiLCAiY2FuY2VsQnViYmxlIiwgImNhbmNlbGFibGUiLCAiY29tcG9zZWQiLCAiZGF0YSIsICJkZWZhdWx0UHJldmVudGVkIiwgImV2ZW50UGhhc2UiLCAiaXNUcnVzdGVkIiwgImxhc3RFdmVudElkIiwgIm9yaWdpbiIsICJyZXR1cm5WYWx1ZSIsICJ0aW1lU3RhbXAiLCAidHlwZSJdOwoKICAvKioKICAgKiBVbnBvbGx1dGUgc3ByaW50ZiBmdW5jdGlvbnMgZnJvbSB0aGUgZ2xvYmFsIG5hbWVzcGFjZS4KICAgKi8KICBjb25uZWN0LnNwcmludGYgPSBnbG9iYWwuc3ByaW50ZjsKICBjb25uZWN0LnZzcHJpbnRmID0gZ2xvYmFsLnZzcHJpbnRmOwogIGRlbGV0ZSBnbG9iYWwuc3ByaW50ZjsKICBkZWxldGUgZ2xvYmFsLnZzcHJpbnRmOwoKICBjb25uZWN0LkhUVFBfU1RBVFVTX0NPREVTID0gewogICAgU1VDQ0VTUzogMjAwLAogICAgVE9PX01BTllfUkVRVUVTVFM6IDQyOSwKICAgIElOVEVSTkFMX1NFUlZFUl9FUlJPUjogNTAwCiAgfTsKCiAgY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMgPSB7CiAgICBDSEFUX1RPS0VOOiAiY2hhdF90b2tlbiIsCiAgICBXRUJfU09DS0VUOiAid2ViX3NvY2tldCIKICB9OwoKICAvKioKICAgKiBCaW5kcyB0aGUgZ2l2ZW4gaW5zdGFuY2Ugb2JqZWN0IGFzIHRoZSBjb250ZXh0IGZvcgogICAqIHRoZSBtZXRob2QgcHJvdmlkZWQuCiAgICoKICAgKiBAcGFyYW0gc2NvcGUgVGhlIGluc3RhbmNlIG9iamVjdCB0byBiZSBzZXQgYXMgdGhlIHNjb3BlCiAgICogICAgb2YgdGhlIGZ1bmN0aW9uLgogICAqIEBwYXJhbSBtZXRob2QgVGhlIG1ldGhvZCB0byBiZSBlbmNhcHN1bGF0ZWQuCiAgICoKICAgKiBBbGwgb3RoZXIgYXJndW1lbnRzLCBpZiBhbnksIGFyZSBib3VuZCB0byB0aGUgbWV0aG9kCiAgICogaW52b2NhdGlvbiBpbnNpZGUgdGhlIGNsb3N1cmUuCiAgICoKICAgKiBAcmV0dXJuIEEgY2xvc3VyZSBlbmNhcHN1bGF0aW5nIHRoZSBpbnZvY2F0aW9uIG9mIHRoZQogICAqICAgIG1ldGhvZCBwcm92aWRlZCBpbiBjb250ZXh0IG9mIHRoZSBnaXZlbiBpbnN0YW5jZS4KICAgKi8KICBjb25uZWN0LmhpdGNoID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgdmFyIHNjb3BlID0gYXJncy5zaGlmdCgpOwogICAgdmFyIG1ldGhvZCA9IGFyZ3Muc2hpZnQoKTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoc2NvcGUsICdzY29wZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihtZXRob2QpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjbG9zdXJlQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBtZXRob2QuYXBwbHkoc2NvcGUsIGFyZ3MuY29uY2F0KGNsb3N1cmVBcmdzKSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYSBjYWxsYWJsZSBmdW5jdGlvbiB0eXBlLgogICAqIEJvcnJvd2VkIGZyb20gVW5kZXJzY29yZS5qcy4KICAgKi8KICBjb25uZWN0LmlzRnVuY3Rpb24gPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5jb25zdHJ1Y3RvciAmJiBvYmouY2FsbCAmJiBvYmouYXBwbHkpOwogIH07CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYW4gYXJyYXkuCiAgICovCiAgY29ubmVjdC5pc0FycmF5ID0gZnVuY3Rpb24gKG9iaikgewogICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5cyBmcm9tIGEgSmF2YXNjcmlwdCBvYmplY3QgdXNlZAogICAqIGFzIGEgaGFzaCBtYXAuCiAgICovCiAgY29ubmVjdC5rZXlzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIGtleXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAga2V5cy5wdXNoKGspOwogICAgfQoKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2YgdmFsdWVzIGZyb20gYSBKYXZhc2NyaXB0IG9iamVjdCB1c2VkCiAgICogYXMgYSBoYXNoIG1hcC4KICAgKi8KICBjb25uZWN0LnZhbHVlcyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciB2YWx1ZXMgPSBbXTsKCiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWFwLCAnbWFwJyk7CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAgdmFsdWVzLnB1c2gobWFwW2tdKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Yga2V5L3ZhbHVlIHBhaXJzIGZyb20gdGhlIGdpdmVuIG1hcC4KICAgKi8KICBjb25uZWN0LmVudHJpZXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIgZW50cmllcyA9IFtdOwoKICAgIGZvciAodmFyIGsgaW4gbWFwKSB7CiAgICAgIGVudHJpZXMucHVzaCh7IGtleTogaywgdmFsdWU6IG1hcFtrXSB9KTsKICAgIH0KCiAgICByZXR1cm4gZW50cmllczsKICB9OwoKICAvKioKICAgKiBNZXJnZSB0d28gb3IgbW9yZSBtYXBzIHRvZ2V0aGVyIGludG8gYSBuZXcgbWFwLAogICAqIG9yIHNpbXBseSBjb3B5IGEgc2luZ2xlIG1hcC4KICAgKi8KICBjb25uZWN0Lm1lcmdlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ01hcHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIHJlc3VsdE1hcCA9IHt9OwoKICAgIGFyZ01hcHMuZm9yRWFjaChmdW5jdGlvbiAobWFwKSB7CiAgICAgIGNvbm5lY3QuZW50cmllcyhtYXApLmZvckVhY2goZnVuY3Rpb24gKGt2KSB7CiAgICAgICAgcmVzdWx0TWFwW2t2LmtleV0gPSBrdi52YWx1ZTsKICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4gcmVzdWx0TWFwOwogIH07CgogIGNvbm5lY3Qubm93ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CgogIGNvbm5lY3QuZmluZCA9IGZ1bmN0aW9uIChhcnJheSwgcHJlZGljYXRlKSB7CiAgICBmb3IgKHZhciB4ID0gMDsgeCA8IGFycmF5Lmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmIChwcmVkaWNhdGUoYXJyYXlbeF0pKSB7CiAgICAgICAgcmV0dXJuIGFycmF5W3hdOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfTsKCiAgY29ubmVjdC5jb250YWlucyA9IGZ1bmN0aW9uIChvYmosIHZhbHVlKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChvYmosIGZ1bmN0aW9uICh2KSB7IHJldHVybiB2ID09PSB2YWx1ZTsgfSkgIT0gbnVsbDsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gKHZhbHVlIGluIG9iaik7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5jb250YWluc1ZhbHVlID0gZnVuY3Rpb24gKG9iaiwgdmFsdWUpIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKG9iaiwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQoY29ubmVjdC52YWx1ZXMob2JqKSwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwogICAgfQogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGEgcmFuZG9tIElEIGNvbnNpc3Rpbmcgb2YgdGhlIGN1cnJlbnQgdGltZXN0YW1wCiAgICogYW5kIGEgcmFuZG9tIGJhc2UtMzYgbnVtYmVyIGJhc2VkIG9uIE1hdGgucmFuZG9tKCkuCiAgICovCiAgY29ubmVjdC5yYW5kb21JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLSVzIiwgY29ubmVjdC5ub3coKSwgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMikpOwogIH07CgogIC8qKgogICAqIEdlbmVyYXRlIGFuIGVudW0gZnJvbSB0aGUgZ2l2ZW4gbGlzdCBvZiBsb3dlci1jYXNlIGVudW0gdmFsdWVzLAogICAqIHdoZXJlIHRoZSBlbnVtIGtleXMgd2lsbCBiZSB1cHBlciBjYXNlLgogICAqCiAgICogQ29udmVyc2lvbiBmcm9tIHBhc2NhbCBjYXNlIGJhc2VkIG9uIGNvZGUgZnJvbSBoZXJlOgogICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzA1MjEyMjQKICAgKi8KICBjb25uZWN0Lm1ha2VFbnVtID0gZnVuY3Rpb24gKHZhbHVlcykgewogICAgdmFyIGVudW1PYmogPSB7fTsKCiAgICB2YWx1ZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgdmFyIGtleSA9IHZhbHVlLnJlcGxhY2UoL1wuPyhbYS16XSspXz8vZywgZnVuY3Rpb24gKHgsIHkpIHsgcmV0dXJuIHkudG9VcHBlckNhc2UoKSArICJfIjsgfSkKICAgICAgICAucmVwbGFjZSgvXyQvLCAiIik7CgogICAgICBlbnVtT2JqW2tleV0gPSB2YWx1ZTsKICAgIH0pOwoKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtID0gZnVuY3Rpb24gKHByZWZpeCwgdmFsdWVzKSB7CiAgICB2YXIgZW51bU9iaiA9IGNvbm5lY3QubWFrZUVudW0odmFsdWVzKTsKICAgIGNvbm5lY3Qua2V5cyhlbnVtT2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZW51bU9ialtrZXldID0gY29ubmVjdC5zcHJpbnRmKCIlczo6JXMiLCBwcmVmaXgsIGVudW1PYmpba2V5XSk7CiAgICB9KTsKICAgIHJldHVybiBlbnVtT2JqOwogIH07CgogIGNvbm5lY3QubWFrZUdlbmVyaWNOYW1lc3BhY2VkRW51bSA9IGZ1bmN0aW9uIChwcmVmaXgsIHZhbHVlcywgZGVsaW1pdGVyKSB7CiAgICB2YXIgZW51bU9iaiA9IGNvbm5lY3QubWFrZUVudW0odmFsdWVzKTsKICAgIGNvbm5lY3Qua2V5cyhlbnVtT2JqKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgZW51bU9ialtrZXldID0gY29ubmVjdC5zcHJpbnRmKCIlcyIrZGVsaW1pdGVyKyIlcyIsIHByZWZpeCwgZW51bU9ialtrZXldKTsKICAgIH0pOwogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgLyoqCiAgKiBNZXRob2RzIHRvIGRldGVybWluZSBicm93c2VyIHR5cGUgYW5kIHZlcnNpb25zLCB1c2VkIGZvciBzb2Z0cGhvbmUgaW5pdGlhbGl6YXRpb24uCiAgKi8KICBjb25uZWN0LmlzQ2hyb21lQnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB1c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmlzT3BlcmFCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJPcGVyYSIpICE9PSAtMTsKICB9OwoKICBjb25uZWN0LmdldENocm9tZUJyb3dzZXJWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNocm9tZVZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSArIDcpOwogICAgaWYgKGNocm9tZVZlcnNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQoY2hyb21lVmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5nZXRGaXJlZm94QnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZmlyZWZveFZlcnNpb24gPSB1c2VyQWdlbnQuc3Vic3RyaW5nKHVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgKyA4KTsKICAgIGlmIChmaXJlZm94VmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChmaXJlZm94VmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5pc1ZhbGlkTG9jYWxlID0gZnVuY3Rpb24gKGxvY2FsZSkgewogICAgdmFyIGxhbmd1YWdlcyA9IFsKICAgICAgewogICAgICAgIGlkOiAnZW5fVVMnLAogICAgICAgIGxhYmVsOiAnRW5nbGlzaCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZGVfREUnLAogICAgICAgIGxhYmVsOiAnRGV1dHNjaCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZXNfRVMnLAogICAgICAgIGxhYmVsOiAnRXNwYcOxb2wnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2ZyX0ZSJywKICAgICAgICBsYWJlbDogJ0ZyYW7Dp2FpcycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnamFfSlAnLAogICAgICAgIGxhYmVsOiAn5pel5pys6KqeJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdpdF9JVCcsCiAgICAgICAgbGFiZWw6ICdJdGFsaWFubycKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAna29fS1InLAogICAgICAgIGxhYmVsOiAn7ZWc6rWt7Ja0JwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdwdF9CUicsCiAgICAgICAgbGFiZWw6ICdQb3J0dWd1w6pzJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICd6aF9DTicsCiAgICAgICAgbGFiZWw6ICfkuK3mloco566A5L2TKScKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnemhfVFcnLAogICAgICAgIGxhYmVsOiAn5Lit5paHKOe5gemrlCknCiAgICAgIH0KICAgIF07CiAgICByZXR1cm4gbGFuZ3VhZ2VzLm1hcChmdW5jdGlvbihsYW5ndWFnZSl7IHJldHVybiBsYW5ndWFnZS5pZH0pLmluY2x1ZGVzKGxvY2FsZSk7CiAgfQoKICBjb25uZWN0LmdldE9wZXJhQnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdmVyc2lvbk9mZnNldCA9IHVzZXJBZ2VudC5pbmRleE9mKCJPcGVyYSIpOwogICAgdmFyIG9wZXJhVmVyc2lvbiA9ICh1c2VyQWdlbnQuaW5kZXhPZigiVmVyc2lvbiIpICE9PSAtMSkgPyB1c2VyQWdlbnQuc3Vic3RyaW5nKHZlcnNpb25PZmZzZXQgKyA4KSA6IHVzZXJBZ2VudC5zdWJzdHJpbmcodmVyc2lvbk9mZnNldCArIDYpOwogICAgaWYgKG9wZXJhVmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChvcGVyYVZlcnNpb24pOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIC0xOwogICAgfQogIH07CgogIC8qKgogICAqIFJldHVybiBhIG1hcCBvZiBpdGVtcyBpbiB0aGUgZ2l2ZW4gbGlzdCBpbmRleGVkIGJ5CiAgICoga2V5cyBkZXRlcm1pbmVkIGJ5IHRoZSBjbG9zdXJlIHByb3ZpZGVkLgogICAqCiAgICogQHBhcmFtIGl0ZXJhYmxlIEEgbGlzdC1saWtlIG9iamVjdC4KICAgKiBAcGFyYW0gY2xvc3VyZSBBIGNsb3N1cmUgdG8gZGV0ZXJtaW5lIHRoZSBpbmRleCBmb3IgdGhlCiAgICogICAgaXRlbXMgaW4gdGhlIGl0ZXJhYmxlLgogICAqIEByZXR1cm4gQSBtYXAgZnJvbSBpbmRleCB0byBpdGVtIGZvciBlYWNoIGl0ZW0gaW4gdGhlIGl0ZXJhYmxlLgogICAqLwogIGNvbm5lY3QuaW5kZXggPSBmdW5jdGlvbiAoaXRlcmFibGUsIGNsb3N1cmUpIHsKICAgIHZhciBtYXAgPSB7fTsKCiAgICBpdGVyYWJsZS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgIG1hcFtjbG9zdXJlKGl0ZW0pXSA9IGl0ZW07CiAgICB9KTsKCiAgICByZXR1cm4gbWFwOwogIH07CgogIC8qKgogICAqIENvbnZlcnRzIHRoZSBnaXZlbiBhcnJheSBpbnRvIGEgbWFwIGFzIGEgc2V0LAogICAqIHdoZXJlIGVsZW1lbnRzIGluIHRoZSBhcnJheSBhcmUgbWFwcGVkIHRvIDEuCiAgICovCiAgY29ubmVjdC5zZXQgPSBmdW5jdGlvbiAoYXJyYXlJbikgewogICAgdmFyIHNldE1hcCA9IHt9OwoKICAgIGFycmF5SW4uZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHNldE1hcFtrZXldID0gMTsKICAgIH0pOwoKICAgIHJldHVybiBzZXRNYXA7CiAgfTsKCiAgLyoqCiAgICogUmV0dXJucyBhIG1hcCBmb3IgZWFjaCBrZXkgaW4gbWFwQiB3aGljaAogICAqIGlzIE5PVCBpbiBtYXBBLgogICAqLwogIGNvbm5lY3QucmVsYXRpdmVDb21wbGVtZW50ID0gZnVuY3Rpb24gKG1hcEEsIG1hcEIpIHsKICAgIHZhciBjb21wTWFwID0ge307CgogICAgY29ubmVjdC5rZXlzKG1hcEIpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBpZiAoIShrZXkgaW4gbWFwQSkpIHsKICAgICAgICBjb21wTWFwW2tleV0gPSBtYXBCW2tleV07CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBjb21wTWFwOwogIH07CgogIC8qKgogICAqIEFzc2VydHMgdGhhdCBhIHByZW1pc2UgaXMgdHJ1ZS4KICAgKi8KICBjb25uZWN0LmFzc2VydFRydWUgPSBmdW5jdGlvbiAocHJlbWlzZSwgbWVzc2FnZSkgewogICAgaWYgKCFwcmVtaXNlKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlZhbHVlRXJyb3IobWVzc2FnZSk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQXNzZXJ0cyB0aGF0IGEgdmFsdWUgaXMgbm90IG51bGwgb3IgdW5kZWZpbmVkLgogICAqLwogIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCA9IGZ1bmN0aW9uICh2YWx1ZSwgbmFtZSkgewogICAgY29ubmVjdC5hc3NlcnRUcnVlKHZhbHVlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9PSB1bmRlZmluZWQsCiAgICAgIGNvbm5lY3Quc3ByaW50ZigiJXMgbXVzdCBiZSBwcm92aWRlZCIsIG5hbWUgfHwgJ0EgdmFsdWUnKSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgY29ubmVjdC5kZWVwY29weSA9IGZ1bmN0aW9uIChzcmMpIHsKICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHNyYykpOwogIH07CgogIGNvbm5lY3QuZGVlcGNvcHlDcm9zc09yaWdpbkV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIGNvbnN0IG9iaiA9IHt9OwogICAgY29uc3QgbGlzdE9mQWNjZXB0YWJsZUtleXMgPSBDT1BZQUJMRV9FVkVOVF9GSUVMRFM7CiAgICBsaXN0T2ZBY2NlcHRhYmxlS2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBvYmpba2V5XSA9IGV2ZW50W2tleV07CiAgICAgIH0KICAgICAgY2F0Y2goZSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZGVlcGNvcHlDcm9zc09yaWdpbkV2ZW50IGZhaWxlZCBvbiBrZXk6ICIsIGtleSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gY29ubmVjdC5kZWVwY29weShvYmopOwogIH0KCiAgLyoqCiAgICogR2V0IHRoZSBjdXJyZW50IGJhc2UgdXJsIG9mIHRoZSBvcGVuIHBhZ2UsIGUuZy4gaWYgdGhlIHBhZ2UgaXMKICAgKiBodHRwczovL2V4YW1wbGUuY29tOjk0OTQvb3JhbmdlcywgdGhpcyB3aWxsIGJlICJodHRwczovL2V4YW1wbGUuY29tOjk0OTQiLgogICAqLwogIGNvbm5lY3QuZ2V0QmFzZVVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBsb2NhdGlvbiA9IGdsb2JhbC5sb2NhdGlvbjsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLy8lczolcyIsIGxvY2F0aW9uLnByb3RvY29sLCBsb2NhdGlvbi5ob3N0bmFtZSwgbG9jYXRpb24ucG9ydCk7CiAgfTsKCiAgY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2wgPSBmdW5jdGlvbih1cmwpIHsKICAgIHZhciBwcm90b2NvbCA9IGdsb2JhbC5sb2NhdGlvbi5wcm90b2NvbDsKICAgIGlmICh1cmwuc3Vic3RyKDAsIHByb3RvY29sLmxlbmd0aCkgIT09IHByb3RvY29sKSB7CiAgICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIiVzLy8lcyIsIHByb3RvY29sLCB1cmwpOwogICAgfQogICAgcmV0dXJuIHVybDsKICB9CgogIC8qKgogICAqIERldGVybWluZSBpZiB0aGUgY3VycmVudCB3aW5kb3cgaXMgaW4gYW4gaWZyYW1lLgogICAqIENvdXJ0ZXN5OiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzMyNjA2OS8KICAgKi8KICBjb25uZWN0LmlzRnJhbWVkID0gZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIHdpbmRvdy5zZWxmICE9PSB3aW5kb3cudG9wOwogICAgfSBjYXRjaCAoZSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9OwoKICBjb25uZWN0Lmhhc090aGVyQ29ubmVjdGVkQ0NQcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lm51bWJlck9mQ29ubmVjdGVkQ0NQcyA+IDE7CiAgfQoKICBjb25uZWN0LmZldGNoID0gZnVuY3Rpb24gKGVuZHBvaW50LCBvcHRpb25zLCBtaWxsaUludGVydmFsLCBtYXhSZXRyeSkgewogICAgbWF4UmV0cnkgPSBtYXhSZXRyeSB8fCA1OwogICAgbWlsbGlJbnRlcnZhbCA9IG1pbGxpSW50ZXJ2YWwgfHwgMTAwMDsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgZnVuY3Rpb24gZmV0Y2hEYXRhKG1heFJldHJ5KSB7CiAgICAgICAgZmV0Y2goZW5kcG9pbnQsIG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuU1VDQ0VTUykgewogICAgICAgICAgICByZXMuanNvbigpLnRoZW4oanNvbiA9PiByZXNvbHZlKGpzb24pKS5jYXRjaCgoKSA9PiByZXNvbHZlKHt9KSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG1heFJldHJ5ICE9PSAxICYmIChyZXMuc3RhdHVzID49IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuSU5URVJOQUxfU0VSVkVSX0VSUk9SIHx8IHJlcy5zdGF0dXMgPT09IGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMuVE9PX01BTllfUkVRVUVTVFMpKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGZldGNoRGF0YSgtLW1heFJldHJ5KTsKICAgICAgICAgICAgfSwgbWlsbGlJbnRlcnZhbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWplY3QocmVzKTsKICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmVqZWN0KGUpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGZldGNoRGF0YShtYXhSZXRyeSk7CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBDYWxsaW5nIGEgZnVuY3Rpb24gd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmIHdpdGggZnVsbCBqaXR0ZXIgcmV0cnkgc3RyYXRlZ3kKICAgKiBJdCB3aWxsIHJldHJ5IGNhbGxpbmcgdGhlIGZ1bmN0aW9uIGZvciBtYXhpbXVtIG1heFJldHJ5IHRpbWVzIGlmIGl0IGZhaWxzLgogICAqIFN1Y2Nlc3MgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIGZ1bmN0aW9uIHN1Y2NlZWRlZC4KICAgKiBGYWlsdXJlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIG9ubHkgaWYgdGhlIGxhc3QgdHJ5IGZhaWxlZC4KICAgKi8KICBjb25uZWN0LmJhY2tvZmYgPSBmdW5jdGlvbiAoZnVuYywgbWlsbGlJbnRlcnZhbCwgbWF4UmV0cnksIGNhbGxiYWNrcykgewogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmdW5jKSwgImZ1bmMgbXVzdCBiZSBhIEZ1bmN0aW9uIik7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmF0aW8gPSAyOwoKICAgIGZ1bmMoewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLnN1Y2Nlc3MpIHsKICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGlmIChtYXhSZXRyeSA+IDApIHsKICAgICAgICAgIHZhciBpbnRlcnZhbCA9IG1pbGxpSW50ZXJ2YWwgKiAyICogTWF0aC5yYW5kb20oKTsKICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5iYWNrb2ZmKGZ1bmMsIGludGVydmFsICogcmF0aW8sIC0tbWF4UmV0cnksIGNhbGxiYWNrcyk7CiAgICAgICAgICB9LCBpbnRlcnZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyLCBkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaE1ldHJpYyA9IGZ1bmN0aW9uIChtZXRyaWNEYXRhKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5DTElFTlRfTUVUUklDLAogICAgICBkYXRhOiBtZXRyaWNEYXRhCiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVTdGF0cyA9IGZ1bmN0aW9uKHN0YXRzKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5TT0ZUUEhPTkVfU1RBVFMsCiAgICAgIGRhdGE6IHN0YXRzCiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLlNPRlRQSE9ORV9SRVBPUlQsCiAgICAgIGRhdGE6IHJlcG9ydAogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5DTElDS19TVFJFQU1fREFUQSwKICAgICAgZGF0YTogcmVwb3J0CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hDbGllbnRTaWRlTG9ncyA9IGZ1bmN0aW9uKGxvZ3MpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkNMSUVOVF9TSURFX0xPR1MsIGxvZ3MpOwogIH07CgogIGNvbm5lY3QuYWRkTmFtZXNwYWNlVG9Mb2dzID0gZnVuY3Rpb24obmFtZXNwYWNlKSB7CiAgICBjb25zdCBtZXRob2RzID0gWydsb2cnLCAnZXJyb3InLCAnd2FybicsICdpbmZvJywgJ2RlYnVnJ107CgogICAgbWV0aG9kcy5mb3JFYWNoKChtZXRob2QpID0+IHsKICAgICAgY29uc3QgY29uc29sZU1ldGhvZCA9IHdpbmRvdy5jb25zb2xlW21ldGhvZF07CiAgICAgIHdpbmRvdy5jb25zb2xlW21ldGhvZF0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgY29uc3QgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKICAgICAgICBhcmdzLnVuc2hpZnQoYFske25hbWVzcGFjZX1dYCk7CiAgICAgICAgY29uc29sZU1ldGhvZC5hcHBseSh3aW5kb3cuY29uc29sZSwgYXJncyk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvKioKICAgKiBBIHdyYXBwZXIgYXJvdW5kIFdpbmRvdy5vcGVuKCkgZm9yIG1hbmFnaW5nIHNpbmdsZSBpbnN0YW5jZSBwb3B1cHMuCiAgICovCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7IH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24gKHVybCwgbmFtZSwgb3B0aW9ucykgewogICAgdmFyIHRoZW4gPSB0aGlzLl9nZXRMYXN0T3BlbmVkVGltZXN0YW1wKG5hbWUpOwogICAgdmFyIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHdpbiA9IG51bGw7CiAgICBpZiAobm93IC0gdGhlbiA+IE9ORV9EQVlfTUlMTElTKSB7CiAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgLy8gZGVmYXVsdCB2YWx1ZXMgYXJlIGNob3NlbiB0byBwcm92aWRlIGEgbWluaW11bSBoZWlnaHQgd2l0aG91dCBzY3JvbGxpbmcKICAgICAgICAvLyBhbmQgYSB1bmlmb3JtIG1hcmdpbiBiYXNlZCBvbiB0aGUgY3NzIG9mIHRoZSBjY3AgbG9naW4gcGFnZQogICAgICAgIHZhciBoZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCBERUZBVUxUX1BPUFVQX0hFSUdIVDsKICAgICAgICB2YXIgd2lkdGggPSBvcHRpb25zLndpZHRoIHx8IERFRkFVTFRfUE9QVVBfV0lEVEg7CiAgICAgICAgdmFyIHRvcCA9IG9wdGlvbnMudG9wIHx8IDA7CiAgICAgICAgdmFyIGxlZnQgPSBvcHRpb25zLmxlZnQgfHwgMDsKICAgICAgICB3aW4gPSB3aW5kb3cub3BlbignJywgbmFtZSwgIndpZHRoPSIrd2lkdGgrIiwgaGVpZ2h0PSIraGVpZ2h0KyIsIHRvcD0iK3RvcCsiLCBsZWZ0PSIrbGVmdCk7CiAgICAgICAgaWYgKHdpbi5sb2NhdGlvbiAhPT0gdXJsKSB7CiAgICAgICAgICB3aW4gPSB3aW5kb3cub3Blbih1cmwsIG5hbWUsICJ3aWR0aD0iK3dpZHRoKyIsIGhlaWdodD0iK2hlaWdodCsiLCB0b3A9Iit0b3ArIiwgbGVmdD0iK2xlZnQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB3aW4gPSB3aW5kb3cub3BlbignJywgbmFtZSk7CiAgICAgICAgaWYgKHdpbi5sb2NhdGlvbiAhPT0gdXJsKSB7CiAgICAgICAgICB3aW4gPSB3aW5kb3cub3Blbih1cmwsIG5hbWUpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9zZXRMYXN0T3BlbmVkVGltZXN0YW1wKG5hbWUsIG5vdyk7CiAgICB9CiAgICByZXR1cm4gd2luOwogIH07CgogIGNvbm5lY3QuUG9wdXBNYW5hZ2VyLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgZ2xvYmFsLmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLl9nZXRMYXN0T3BlbmVkVGltZXN0YW1wID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICB2YXIgdmFsdWUgPSBnbG9iYWwubG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTsKCiAgICBpZiAodmFsdWUpIHsKICAgICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMCk7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLl9zZXRMYXN0T3BlbmVkVGltZXN0YW1wID0gZnVuY3Rpb24gKG5hbWUsIHRzKSB7CiAgICB2YXIga2V5ID0gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlS2V5KG5hbWUpOwogICAgZ2xvYmFsLmxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgJycgKyB0cyk7CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLl9nZXRMb2NhbFN0b3JhZ2VLZXkgPSBmdW5jdGlvbiAobmFtZSkgewogICAgcmV0dXJuICJjb25uZWN0UG9wdXBNYW5hZ2VyOjoiICsgbmFtZTsKICB9OwoKICAvKioKICAgKiBBbiBlbnVtZXJhdGlvbiBvZiB0aGUgSFRNTDUgbm90aWZpY2F0aW9uIHBlcm1pc3Npb24gdmFsdWVzLgogICAqLwogIHZhciBOb3RpZmljYXRpb25QZXJtaXNzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnZ3JhbnRlZCcsCiAgICAnZGVuaWVkJywKICAgICdkZWZhdWx0JwogIF0pOwoKICAvKioKICAgKiBBIHNpbXBsZSBlbmdpbmUgZm9yIHNob3dpbmcgbm90aWZpY2F0aW9uIHBvcHVwcy4KICAgKi8KICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnF1ZXVlID0gW107CiAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFRkFVTFQ7CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5yZXF1ZXN0UGVybWlzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmICghKCJOb3RpZmljYXRpb24iIGluIGdsb2JhbCkpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGlzIGJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IG5vdGlmaWNhdGlvbnMuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQ7CgogICAgfSBlbHNlIGlmIChnbG9iYWwuTm90aWZpY2F0aW9uLnBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiVGhlIHVzZXIgaGFzIHJlcXVlc3RlZCB0byBub3QgcmVjZWl2ZSBub3RpZmljYXRpb25zLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVOSUVEOwoKICAgIH0gZWxzZSBpZiAodGhpcy5wZXJtaXNzaW9uICE9PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgZ2xvYmFsLk5vdGlmaWNhdGlvbi5yZXF1ZXN0UGVybWlzc2lvbigpLnRoZW4oZnVuY3Rpb24gKHBlcm1pc3Npb24pIHsKICAgICAgICBzZWxmLnBlcm1pc3Npb24gPSBwZXJtaXNzaW9uOwogICAgICAgIGlmIChwZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgICAgIHNlbGYuX3Nob3dRdWV1ZWQoKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlbGYucXVldWUgPSBbXTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuc2hvdyA9IGZ1bmN0aW9uICh0aXRsZSwgb3B0aW9ucykgewogICAgaWYgKHRoaXMucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5HUkFOVEVEKSB7CiAgICAgIHJldHVybiB0aGlzLl9zaG93SW1wbCh7IHRpdGxlOiB0aXRsZSwgb3B0aW9uczogb3B0aW9ucyB9KTsKCiAgICB9IGVsc2UgaWYgKHRoaXMucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJVbmFibGUgdG8gc2hvdyBub3RpZmljYXRpb24uIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgIHRpdGxlOiB0aXRsZSwKICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMKICAgICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICB2YXIgcGFyYW1zID0geyB0aXRsZTogdGl0bGUsIG9wdGlvbnM6IG9wdGlvbnMgfTsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJEZWZlcnJpbmcgbm90aWZpY2F0aW9uIHVudGlsIHVzZXIgZGVjaWRlcyB0byBhbGxvdyBvciBkZW55LiIpCiAgICAgICAgLndpdGhPYmplY3QocGFyYW1zKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnF1ZXVlLnB1c2gocGFyYW1zKTsKICAgIH0KICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLl9zaG93UXVldWVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG5vdGlmaWNhdGlvbnMgPSB0aGlzLnF1ZXVlLm1hcChmdW5jdGlvbiAocGFyYW1zKSB7CiAgICAgIHJldHVybiBzZWxmLl9zaG93SW1wbChwYXJhbXMpOwogICAgfSk7CiAgICB0aGlzLnF1ZXVlID0gW107CiAgICByZXR1cm4gbm90aWZpY2F0aW9uczsKICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLl9zaG93SW1wbCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciBub3RpZmljYXRpb24gPSBuZXcgZ2xvYmFsLk5vdGlmaWNhdGlvbihwYXJhbXMudGl0bGUsIHBhcmFtcy5vcHRpb25zKTsKICAgIGlmIChwYXJhbXMub3B0aW9ucy5jbGlja2VkKSB7CiAgICAgIG5vdGlmaWNhdGlvbi5vbmNsaWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIHBhcmFtcy5vcHRpb25zLmNsaWNrZWQuY2FsbChub3RpZmljYXRpb24pOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIG5vdGlmaWNhdGlvbjsKICB9OwoKICBjb25uZWN0LlZhbHVlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGluc3RhbmNlID0gbmV3IEVycm9yKGNvbm5lY3QudnNwcmludGYoZm9ybWF0LCBhcmdzKSk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoaW5zdGFuY2UsIGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUpOwogICAgcmV0dXJuIGluc3RhbmNlOyAKICB9OwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlLCBFcnJvci5wcm90b3R5cGUpOwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlZhbHVlRXJyb3IsIEVycm9yKTsKICBjb25uZWN0LlZhbHVlRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnVmFsdWVFcnJvcic7CgogIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgaW5zdGFuY2UgPSBuZXcgRXJyb3IoY29ubmVjdC52c3ByaW50Zihmb3JtYXQsIGFyZ3MpKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihpbnN0YW5jZSwgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZSk7CiAgICByZXR1cm4gaW5zdGFuY2U7IAogIH07CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUsIEVycm9yLnByb3RvdHlwZSk7CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvciwgRXJyb3IpOwogIGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvci5wcm90b3R5cGUubmFtZSA9ICdOb3RJbXBsZW1lbnRlZEVycm9yJzsKCiAgY29ubmVjdC5TdGF0ZUVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBpbnN0YW5jZSA9IG5ldyBFcnJvcihjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlKTsKICAgIHJldHVybiBpbnN0YW5jZTsgCiAgfQogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlLCBFcnJvci5wcm90b3R5cGUpOwogIE9iamVjdC5zZXRQcm90b3R5cGVPZihjb25uZWN0LlN0YXRlRXJyb3IsIEVycm9yKTsKICBjb25uZWN0LlN0YXRlRXJyb3IucHJvdG90eXBlLm5hbWUgPSAnU3RhdGVFcnJvcic7CgoKCiAgY29ubmVjdC5Wb2ljZUlkRXJyb3IgPSBmdW5jdGlvbih0eXBlLCBtZXNzYWdlLCBlcnIpewogICAgdmFyIGVycm9yID0ge307CiAgICBlcnJvci50eXBlID0gdHlwZTsKICAgIGVycm9yLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgZXJyb3Iuc3RhY2sgPSBFcnJvcihtZXNzYWdlKS5zdGFjazsKICAgIGVycm9yLmVyciA9IGVycjsKICAgIHJldHVybiBlcnJvcjsKICB9CgogIC8vIGludGVybmFsIHVzZSBvbmx5CiAgY29ubmVjdC5pc0NDUCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25kdWl0ID0gY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCk7CiAgICByZXR1cm4gY29uZHVpdC5uYW1lID09PSAnQ29ubmVjdFNoYXJlZFdvcmtlckNvbmR1aXQnOwogIH0KCn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA3MzY6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wCiAqLwooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzOwogIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgZ2xvYmFsLmxpbHkgPSBjb25uZWN0OwoKICBjb25uZWN0LndvcmtlciA9IHt9OwoKICB2YXIgR0VUX0FHRU5UX1RJTUVPVVRfTVMgPSAzMDAwMDsKICB2YXIgR0VUX0FHRU5UX1JFQ09WRVJZX1RJTUVPVVRfTVMgPSA1MDAwOwogIHZhciBHRVRfQUdFTlRfU1VDQ0VTU19USU1FT1VUX01TID0gMTAwOwogIHZhciBMT0dfQlVGRkVSX0NBUF9TSVpFID0gNDAwOwoKICB2YXIgQ0hFQ0tfQVVUSF9UT0tFTl9JTlRFUlZBTF9NUyA9IDMwMDAwMDsgLy8gNSBtaW51dHMKICB2YXIgUkVGUkVTSF9BVVRIX1RPS0VOX0lOVEVSVkFMX01TID0gMTAwMDA7IC8vIDEwIHNlY29uZHMKICB2YXIgUkVGUkVTSF9BVVRIX1RPS0VOX01BWF9UUlkgPSA0OwoKICB2YXIgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMgPSAzMDAwMDsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy50b3BpY01hc3Rlck1hcCA9IHt9OwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLmdldE1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAndG9waWMnKTsKICAgIHJldHVybiB0aGlzLnRvcGljTWFzdGVyTWFwW3RvcGljXSB8fCBudWxsOwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLnNldE1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgaWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgJ3RvcGljJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWQsICdpZCcpOwogICAgdGhpcy50b3BpY01hc3Rlck1hcFt0b3BpY10gPSBpZDsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5yZW1vdmVNYXN0ZXIgPSBmdW5jdGlvbiAoaWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZCwgJ2lkJyk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5lbnRyaWVzKHRoaXMudG9waWNNYXN0ZXJNYXApLmZpbHRlcihmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgcmV0dXJuIGVudHJ5LnZhbHVlID09PSBpZDsKICAgIH0pLmZvckVhY2goZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgIGRlbGV0ZSBzZWxmLnRvcGljTWFzdGVyTWFwW2VudHJ5LmtleV07CiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBXb3JrZXJDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICovCiAgdmFyIFdvcmtlckNsaWVudCA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBjb25uZWN0LkNsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgfTsKICBXb3JrZXJDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShjb25uZWN0LkNsaWVudEJhc2UucHJvdG90eXBlKTsKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV29ya2VyQ2xpZW50OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uIChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmVxdWVzdF9zdGFydCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgaWYoY29ubmVjdC5jb250YWluc1ZhbHVlKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLCBtZXRob2QpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRBZ2VudEFwcENsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9IGVsc2UgaWYoY29ubmVjdC5jb250YWluc1ZhbHVlKGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMsIG1ldGhvZCkpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldFRhc2tUZW1wbGF0ZXNDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvciwgZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCAmJiBjYWxsYmFja3MuYWNjZXNzRGVuaWVkKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIAogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3JlY29yZEFQSUxhdGVuY3kgPSBmdW5jdGlvbiAobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnIpIHsKICAgIHZhciByZXF1ZXN0X2VuZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHJlcXVlc3RfdGltZSA9IHJlcXVlc3RfZW5kIC0gcmVxdWVzdF9zdGFydDsKICAgIHRoaXMuX3NlbmRBUElNZXRyaWNzKG1ldGhvZCwgcmVxdWVzdF90aW1lLCBlcnIpOwogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3NlbmRBUElNZXRyaWNzID0gZnVuY3Rpb24gKG1ldGhvZCwgdGltZSwgZXJyKSB7CiAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVBJX01FVFJJQywgewogICAgICBuYW1lOiBtZXRob2QsCiAgICAgIHRpbWU6IHRpbWUsCiAgICAgIGRpbWVuc2lvbnM6IFsKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAiQ2F0ZWdvcnkiLAogICAgICAgICAgdmFsdWU6ICJBUEkiCiAgICAgICAgfQogICAgICBdLAogICAgICBlcnJvcjogZXJyCiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVGhlIG9iamVjdCByZXNwb25zaWJsZSBmb3IgcG9sbGluZyBhbmQgcGFzc2luZyBkYXRhIGRvd25zdHJlYW0gdG8gYWxsCiAgICogY29uc3VtZXIgcG9ydHMuCiAgICovCiAgdmFyIENsaWVudEVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLm11bHRpcGxleGVyID0gbmV3IGNvbm5lY3QuU3RyZWFtTXVsdGlwbGV4ZXIoKTsKICAgIHRoaXMuY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkFtYXpvbkNvbm5lY3RTaGFyZWRXb3JrZXIiLCBudWxsLCB0aGlzLm11bHRpcGxleGVyKTsKICAgIHRoaXMuY2xpZW50ID0gbmV3IFdvcmtlckNsaWVudCh0aGlzLmNvbmR1aXQpOwogICAgdGhpcy50aW1lb3V0ID0gbnVsbDsKICAgIHRoaXMuYWdlbnQgPSBudWxsOwogICAgdGhpcy5uZXh0VG9rZW4gPSBudWxsOwogICAgdGhpcy5pbml0RGF0YSA9IHt9OwogICAgdGhpcy5wb3J0Q29uZHVpdE1hcCA9IHt9OwogICAgdGhpcy5zdHJlYW1NYXBCeVRhYklkID0ge307CiAgICB0aGlzLm1hc3RlckNvb3JkID0gbmV3IE1hc3RlclRvcGljQ29vcmRpbmF0b3IoKTsKICAgIHRoaXMubG9nc0J1ZmZlciA9IFtdOwogICAgdGhpcy5zdXBwcmVzcyA9IGZhbHNlOwogICAgdGhpcy5mb3JjZU9mZmxpbmUgPSBmYWxzZTsKICAgIHRoaXMubG9uZ1BvbGxpbmdPcHRpb25zID0gewogICAgICBhbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZTogZmFsc2UsIAogICAgICBhbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGU6IGZhbHNlLAogICAgfQoKICAgIHZhciB3ZWJTb2NrZXRNYW5hZ2VyID0gbnVsbDsKCiAgICBjb25uZWN0LnJvb3RMb2dnZXIgPSBuZXcgY29ubmVjdC5Eb3duc3RyZWFtQ29uZHVpdExvZ2dlcih0aGlzLmNvbmR1aXQpOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VORF9MT0dTLCBmdW5jdGlvbiAobG9nc1RvVXBsb2FkKSB7CiAgICAgIC8vIEFkZCBzb2Z0cGhvbmUgbG9ncyBkb3duc3RyZWFtCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkucHVzaExvZ3NEb3duc3RyZWFtKGxvZ3NUb1VwbG9hZCk7CgogICAgICBzZWxmLmxvZ3NCdWZmZXIgPSBzZWxmLmxvZ3NCdWZmZXIuY29uY2F0KGxvZ3NUb1VwbG9hZCk7CiAgICAgIC8vb25seSBjYWxsIEFQSSB0byBzZW5kIGxvZ3MgaWYgYnVmZmVyIHJlYWNoZWQgY2FwCiAgICAgIGlmIChzZWxmLmxvZ3NCdWZmZXIubGVuZ3RoID4gTE9HX0JVRkZFUl9DQVBfU0laRSkgewogICAgICAgIHNlbGYuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0KHNlbGYubG9nc0J1ZmZlcik7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNVUFBSRVNTLCBmdW5jdGlvbiAoZGF0YSl7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZGVidWcoIltEaXNhc3RlciBSZWNvdmVyeV0gU2V0dGluZyBTdXBwcmVzcyB0byAlcyIsIGRhdGEuc3VwcHJlc3MpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHNlbGYuc3VwcHJlc3MgPSBkYXRhLnN1cHByZXNzIHx8IGZhbHNlOwogICAgICAvL3NpZ25hbCBvdGhlciB3aW5kb3dzIHRoYXQgYSBmYWlsb3ZlciBoYXBwZW5lZAogICAgICBpZiAoc2VsZi5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FKSkgewogICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRkFJTE9WRVIsIHsKICAgICAgICAgIGlzUHJpbWFyeTogIXNlbGYuc3VwcHJlc3MKICAgICAgICB9KTsgICAgICAKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5kZWJ1ZygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTZXR0aW5nIEZPUkNFX09GRkxJTkUgdG8gJXMiLCBkYXRhLm9mZmxpbmUpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHNlbGYuZm9yY2VPZmZsaW5lID0gZGF0YS5vZmZsaW5lIHx8IGZhbHNlOwogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmIChkYXRhLmF1dGhUb2tlbiAmJiBkYXRhLmF1dGhUb2tlbiAhPT0gc2VsZi5pbml0RGF0YS5hdXRoVG9rZW4pIHsKICAgICAgICBzZWxmLmluaXREYXRhID0gZGF0YTsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdChkYXRhKTsKICAgICAgICBpZiAoZGF0YS5sb25nUG9sbGluZ09wdGlvbnMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGUgPT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIHNlbGYubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlID0gZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZSA9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgc2VsZi5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlID0gZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBpbml0IG9ubHkgb25jZS4KICAgICAgICBpZiAoIXdlYlNvY2tldE1hbmFnZXIpIHsKCiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNyZWF0aW5nIGEgbmV3IFdlYnNvY2tldCBjb25uZWN0aW9uIGZvciBDQ1AiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgICAgICBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuc2V0R2xvYmFsQ29uZmlnKHsKICAgICAgICAgICAgbG9nZ2VyQ29uZmlnOiB7IGxvZ2dlcjogY29ubmVjdC5nZXRMb2coKSB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyID0gY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyLmNyZWF0ZSgpOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Jbml0RmFpbHVyZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25PcGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9PUEVOLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkNsb3NlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9DTE9TRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25HYWluKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fR0FJTkVEKTsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fR0FJTik7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkxvc3QoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0xPU1QsIHJlc3BvbnNlKTsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvblVwZGF0ZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9VUERBVEUsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25TdWJzY3JpcHRpb25GYWlsdXJlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX0ZBSUxVUkUsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25BbGxNZXNzYWdlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQUxMX01FU1NBR0UsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNlbGYuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU0VORCwgZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zZW5kTWVzc2FnZShtZXNzYWdlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNlbGYuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSUJFLCBmdW5jdGlvbiAodG9waWNzKSB7CiAgICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuc3Vic2NyaWJlVG9waWNzKHRvcGljcyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLmluaXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmdldFdlYlNvY2tldFVybCkpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgIXJlc3BvbnNlLndlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQpIHsKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IHBvbGxpbmcgZm9yIGFnZW50IGRhdGEuCiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGFnZW50IHBvbGxpbmciKQogICAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50KCk7CiAgCiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGNvbmZpZyBwb2xsaW5nIikKICAgICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24oeyByZXBlYXRGb3JldmVyOiB0cnVlIH0pOwogIAogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJLaWNraW5nIG9mZiBhdXRoIHRva2VuIHBvbGxpbmciKQogICAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuY2hlY2tBdXRoVG9rZW4pLCBDSEVDS19BVVRIX1RPS0VOX0lOVEVSVkFMX01TKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkU7CiAgICAgICAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShldmVudCk7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiV2ViU29ja2V0IGZhaWxlZCB0byBpbml0aWFsaXplIikKICAgICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpCiAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiTm90IEluaXRpYWxpemluZyBhIG5ldyBXZWJzb2NrZXRNYW5hZ2VyIGluc3RhbmNlLCBzaW5jZSBvbmUgYWxyZWFkeSBleGlzdHMiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEUsIGZ1bmN0aW9uICgpIHsKICAgICAgLy91cGxvYWQgcGVuZGluZyBsb2dzIGJlZm9yZSB0ZXJtaW5hdGluZy4KICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSgpOwogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFRCk7CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFKTsKICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShkYXRhLmV2ZW50LCBkYXRhLmRhdGEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDYWxsZWQgd2hlbiBhIGNvbnN1bWVyIHBvcnQgY29ubmVjdHMgdG8gdGhpcyBTaGFyZWRXb3JrZXIuCiAgICAgKiBMZXQncyBhZGQgdGhlbSB0byBvdXIgbXVsdGlwbGV4ZXIuCiAgICAgKi8KICAgIGdsb2JhbC5vbmNvbm5lY3QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIHBvcnQgPSBldmVudC5wb3J0c1swXTsKICAgICAgdmFyIHN0cmVhbSA9IG5ldyBjb25uZWN0LlBvcnRTdHJlYW0ocG9ydCk7CiAgICAgIHNlbGYubXVsdGlwbGV4ZXIuYWRkU3RyZWFtKHN0cmVhbSk7CiAgICAgIHBvcnQuc3RhcnQoKTsKCiAgICAgIHZhciBwb3J0Q29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoc3RyZWFtLmdldElkKCksIG51bGwsIHN0cmVhbSk7CiAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCB7IGlkOiBzdHJlYW0uZ2V0SWQoKSB9KTsKCiAgICAgIHNlbGYucG9ydENvbmR1aXRNYXBbc3RyZWFtLmdldElkKCldID0gcG9ydENvbmR1aXQ7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGggfSk7CgogICAgICBpZiAoc2VsZi5hZ2VudCAhPT0gbnVsbCkgewogICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgfQoKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBUElSZXF1ZXN0LCBwb3J0Q29uZHVpdCkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZU1hc3RlclJlcXVlc3QsIHBvcnRDb25kdWl0LCBzdHJlYW0uZ2V0SWQoKSkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04sCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRBQl9JRCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlVGFiSWRFdmVudCwgc3RyZWFtKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DTE9TRSwgCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUNsb3NlRXZlbnQsIHN0cmVhbSkpOwogICAgfTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfU05BUFNIT1QsIHsKICAgICAgbmV4dFRva2VuOiBzZWxmLm5leHRUb2tlbiwKICAgICAgdGltZW91dDogR0VUX0FHRU5UX1RJTUVPVVRfTVMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2VsZi5hZ2VudCA9IHNlbGYuYWdlbnQgfHwge307CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3QgPSBkYXRhLnNuYXBzaG90OwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90LmxvY2FsVGltZXN0YW1wID0gY29ubmVjdC5ub3coKTsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdC5za2V3ID0gc2VsZi5hZ2VudC5zbmFwc2hvdC5zbmFwc2hvdFRpbWVzdGFtcCAtIHNlbGYuYWdlbnQuc25hcHNob3QubG9jYWxUaW1lc3RhbXA7CiAgICAgICAgICAgIHNlbGYubmV4dFRva2VuID0gZGF0YS5uZXh0VG9rZW47CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIkdFVF9BR0VOVF9TTkFQU0hPVCBzdWNjZWVkZWQuIikKICAgICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkxvbmcgcG9sbCBmYWlsZWQgdG8gdXBkYXRlIGFnZW50LiIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudCksIEdFVF9BR0VOVF9TVUNDRVNTX1RJTUVPVVRfTVMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGdldCBhZ2VudCBkYXRhLiIpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50KSwgR0VUX0FHRU5UX1JFQ09WRVJZX1RJTUVPVVRfTVMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKCiAgICAgIH0pOwoKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfQ09ORklHVVJBVElPTiwge30sIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgY29uZmlndXJhdGlvbiA9IGRhdGEuY29uZmlndXJhdGlvbjsKICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvckFnZW50U3RhdGVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIGlmIChwYXJhbXMucmVwZWF0Rm9yZXZlcikgewogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24sIHBhcmFtcyksCiAgICAgICAgICAgIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IGNvbmZpZ3VyYXRpb24gZGF0YS4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKHBhcmFtcy5yZXBlYXRGb3JldmVyKSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKSwKICAgICAgICAgICAgICBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUywgcGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICB9LAogICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudFN0YXRlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfU1RBVEVTLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwoKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50U3RhdGVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBzdGF0ZXM6IChwYXJhbXMuc3RhdGVzIHx8IFtdKS5jb25jYXQoZGF0YS5zdGF0ZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFN0YXRlcyA9IChwYXJhbXMuc3RhdGVzIHx8IFtdKS5jb25jYXQoZGF0YS5zdGF0ZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBzdGF0ZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfUEVSTUlTU0lPTlMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCgogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgcGVybWlzc2lvbnM6IChwYXJhbXMucGVybWlzc2lvbnMgfHwgW10pLmNvbmNhdChkYXRhLnBlcm1pc3Npb25zKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGVybWlzc2lvbnMgPSAocGFyYW1zLnBlcm1pc3Npb25zIHx8IFtdKS5jb25jYXQoZGF0YS5wZXJtaXNzaW9ucyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IHBlcm1pc3Npb25zIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9ESUFMQUJMRV9DT1VOVFJZX0NPREVTLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIGNvdW50cnlDb2RlczogKHBhcmFtcy5jb3VudHJ5Q29kZXMgfHwgW10pLmNvbmNhdChkYXRhLmNvdW50cnlDb2RlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLmRpYWxhYmxlQ291bnRyaWVzID0gKHBhcmFtcy5jb3VudHJ5Q29kZXMgfHwgW10pLmNvbmNhdChkYXRhLmNvdW50cnlDb2Rlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGRpYWxhYmxlIGNvdW50cnkgY29kZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX1JPVVRJTkdfUFJPRklMRV9RVUVVRVMsIHsKICAgICAgcm91dGluZ1Byb2ZpbGVBUk46IGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk4sCiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIGNvdW50cnlDb2RlczogKHBhcmFtcy5xdWV1ZXMgfHwgW10pLmNvbmNhdChkYXRhLnF1ZXVlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcyA9IChwYXJhbXMucXVldWVzIHx8IFtdKS5jb25jYXQoZGF0YS5xdWV1ZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCByb3V0aW5nIHByb2ZpbGUgcXVldWVzIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQVBJUmVxdWVzdCA9IGZ1bmN0aW9uIChwb3J0Q29uZHVpdCwgcmVxdWVzdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMuY2xpZW50LmNhbGwocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGFyYW1zLCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFLCByZXF1ZXN0LCBkYXRhKTsKICAgICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFLCByZXF1ZXN0LCBkYXRhLCBKU09OLnN0cmluZ2lmeShlcnIpKTsKICAgICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIiclcycgQVBJIHJlcXVlc3QgZmFpbGVkIiwgcmVxdWVzdC5tZXRob2QpCiAgICAgICAgICAud2l0aE9iamVjdCh7IHJlcXVlc3Q6IHNlbGYuZmlsdGVyQXV0aFRva2VuKHJlcXVlc3QpLCByZXNwb25zZTogcmVzcG9uc2UgfSkKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGVycikKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsLCB7YXV0aG9yaXplOiB0cnVlfSkKICAgIH0pOwogIH07CgogIC8qKgogICAqIEhhbmRsZSBpbmNvbWluZyBtYXN0ZXIgcXVlcnkgb3IgbW9kaWZpY2F0aW9uIHJlcXVlc3RzIGZyb20gY29ubmVjdGVkIHRhYiBwb3J0cy4KICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZU1hc3RlclJlcXVlc3QgPSBmdW5jdGlvbiAocG9ydENvbmR1aXQsIHBvcnRJZCwgcmVxdWVzdCkgewogICAgdmFyIG11bHRpcGxleGVyQ29uZHVpdCA9IHRoaXMuY29uZHVpdDsKICAgIHZhciByZXNwb25zZSA9IG51bGw7CgogICAgc3dpdGNoIChyZXF1ZXN0Lm1ldGhvZCkgewogICAgICBjYXNlIGNvbm5lY3QuTWFzdGVyTWV0aG9kcy5CRUNPTUVfTUFTVEVSOgogICAgICAgIHZhciBtYXN0ZXJJZCA9IHRoaXMubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljKTsKICAgICAgICB2YXIgdGFrZU92ZXIgPSBCb29sZWFuKG1hc3RlcklkKSAmJiBtYXN0ZXJJZCAhPT0gcG9ydElkOwogICAgICAgIHRoaXMubWFzdGVyQ29vcmQuc2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljLCBwb3J0SWQpOwogICAgICAgIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCByZXF1ZXN0LCB7CiAgICAgICAgICBtYXN0ZXJJZDogcG9ydElkLAogICAgICAgICAgdGFrZU92ZXI6IHRha2VPdmVyLAogICAgICAgICAgdG9waWM6IHJlcXVlc3QucGFyYW1zLnRvcGljCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRha2VPdmVyKSB7CiAgICAgICAgICBtdWx0aXBsZXhlckNvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIGNvbm5lY3QuTWFzdGVyTWV0aG9kcy5DSEVDS19NQVNURVI6CiAgICAgICAgdmFyIG1hc3RlcklkID0gdGhpcy5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMpOwogICAgICAgIGlmICghbWFzdGVySWQgJiYgIXJlcXVlc3QucGFyYW1zLnNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSkgewogICAgICAgICAgdGhpcy5tYXN0ZXJDb29yZC5zZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMsIHBvcnRJZCk7CiAgICAgICAgICBtYXN0ZXJJZCA9IHBvcnRJZDsKICAgICAgICB9CiAgICAgICAgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIHJlcXVlc3QsIHsKICAgICAgICAgIG1hc3RlcklkOiBtYXN0ZXJJZCwKICAgICAgICAgIGlzTWFzdGVyOiBwb3J0SWQgPT09IG1hc3RlcklkLAogICAgICAgICAgdG9waWM6IHJlcXVlc3QucGFyYW1zLnRvcGljCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBtYXN0ZXIgbWV0aG9kOiAiICsgcmVxdWVzdC5tZXRob2QpOwogICAgfQoKICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVUYWJJZEV2ZW50ID0gZnVuY3Rpb24gKHN0cmVhbSwgZGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdHJ5IHsKICAgICAgbGV0IHRhYklkID0gZGF0YS50YWJJZDsKICAgICAgbGV0IHN0cmVhbXNJblRoaXNUYWIgPSBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdOwogICAgICBsZXQgY3VycmVudFN0cmVhbUlkID0gc3RyZWFtLmdldElkKCk7CiAgICAgIGxldCB0YWJJZHMgPSBPYmplY3Qua2V5cyhzZWxmLnN0cmVhbU1hcEJ5VGFiSWQpOwogICAgICBsZXQgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyID0gdGFiSWRzLmZpbHRlcih0YWJJZCA9PiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCA+IDApLmxlbmd0aDsKICAgICAgaWYgKHN0cmVhbXNJblRoaXNUYWIgJiYgc3RyZWFtc0luVGhpc1RhYi5sZW5ndGggPiAwKXsKICAgICAgICBpZiAoIXN0cmVhbXNJblRoaXNUYWIuaW5jbHVkZXMoY3VycmVudFN0cmVhbUlkKSkgewogICAgICAgICAgc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5wdXNoKGN1cnJlbnRTdHJlYW1JZCk7CiAgICAgICAgICBsZXQgdXBkYXRlT2JqZWN0ID0geyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCwgdGFiSWQsIHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciB9OwogICAgICAgICAgdXBkYXRlT2JqZWN0W3RhYklkXSA9IHsgbGVuZ3RoOiBzdHJlYW1zSW5UaGlzVGFiLmxlbmd0aCB9OwogICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgdXBkYXRlT2JqZWN0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXSA9IFtzdHJlYW0uZ2V0SWQoKV07CiAgICAgICAgbGV0IHVwZGF0ZU9iamVjdCA9IHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGgsIHRhYklkLCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXI6IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciArIDEgfTsKICAgICAgICB1cGRhdGVPYmplY3RbdGFiSWRdID0geyBsZW5ndGg6IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoIH07CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgdXBkYXRlT2JqZWN0KTsKICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIltUYWIgSWRzXSBJc3N1ZSB1cGRhdGluZyBjb25uZWN0ZWQgQ0NQcyB3aXRoaW4gdGhlIHNhbWUgdGFiIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQ2xvc2VFdmVudCA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5tdWx0aXBsZXhlci5yZW1vdmVTdHJlYW0oc3RyZWFtKTsKICAgIGRlbGV0ZSBzZWxmLnBvcnRDb25kdWl0TWFwW3N0cmVhbS5nZXRJZCgpXTsKICAgIHNlbGYubWFzdGVyQ29vcmQucmVtb3ZlTWFzdGVyKHN0cmVhbS5nZXRJZCgpKTsKICAgIGxldCB1cGRhdGVPYmplY3QgPSB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoIH07CiAgICBsZXQgdGFiSWRzID0gT2JqZWN0LmtleXMoc2VsZi5zdHJlYW1NYXBCeVRhYklkKTsKICAgIHRyeSB7CiAgICAgIGxldCB0YWJJZCA9IHRhYklkcy5maW5kKGtleSA9PiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRba2V5XS5pbmNsdWRlcyhzdHJlYW0uZ2V0SWQoKSkpOwogICAgICBpZiAodGFiSWQpIHsKICAgICAgICBsZXQgc3RyZWFtSW5kZXhJbk1hcCA9IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0uZmluZEluZGV4KCh2YWx1ZSkgPT4gc3RyZWFtLmdldElkKCkgPT09IHZhbHVlKTsKICAgICAgICBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLnNwbGljZShzdHJlYW1JbmRleEluTWFwLCAxKTsKICAgICAgICBsZXQgdGFiTGVuZ3RoID0gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXSA/IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoIDogMDsKICAgICAgICB1cGRhdGVPYmplY3RbdGFiSWRdID0geyBsZW5ndGg6IHRhYkxlbmd0aCB9OwogICAgICAgIHVwZGF0ZU9iamVjdC50YWJJZCA9IHRhYklkOwogICAgICB9CiAgICAgIGxldCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgPSB0YWJJZHMuZmlsdGVyKHRhYklkID0+IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoID4gMCkubGVuZ3RoOwogICAgICB1cGRhdGVPYmplY3Quc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyID0gc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyOwogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIltUYWIgSWRzXSBJc3N1ZSB1cGRhdGluZyB0YWJJZC1zcGVjaWZpYyBzdHJlYW0gZGF0YSIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHVwZGF0ZU9iamVjdCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbikgewogICAgaWYgKGNvbmZpZ3VyYXRpb24ucGVybWlzc2lvbnMgJiYKICAgICAgY29uZmlndXJhdGlvbi5kaWFsYWJsZUNvdW50cmllcyAmJgogICAgICBjb25maWd1cmF0aW9uLmFnZW50U3RhdGVzICYmCiAgICAgIGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzKSB7CgogICAgICB0aGlzLmFnZW50ID0gdGhpcy5hZ2VudCB8fCB7fTsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uID0gY29uZmlndXJhdGlvbjsKICAgICAgdGhpcy51cGRhdGVBZ2VudCgpOwoKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IGNvbmZpZ3VyYXRpb24gdW50aWwgYWxsIGNvbmZpZyBkYXRhIGhhcyBiZWVuIGZldGNoZWQuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnVwZGF0ZUFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzLmFnZW50KSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBoYXMgYmVlbiBmdWxseSBjb25zdHJ1Y3RlZC4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIH0gZWxzZSBpZiAoIXRoaXMuYWdlbnQuc25hcHNob3QpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IHNuYXBzaG90IGlzIGF2YWlsYWJsZS4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIH0gZWxzZSBpZiAoIXRoaXMuYWdlbnQuY29uZmlndXJhdGlvbikgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgY29uZmlndXJhdGlvbiBpcyBhdmFpbGFibGUuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgewogICAgICAvLyBBbGlhcyBzb21lIG9mIHRoZSBwcm9wZXJ0aWVzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5zdGF0dXMgPSB0aGlzLmFnZW50LnN0YXRlOwoKICAgICAgLy8gU29ydCB0aGUgY29udGFjdHMgb24gdGhlIHRpbWVzdGFtcAogICAgICBpZiAodGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cyAmJiB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmxlbmd0aCA+IDEpIHsKICAgICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLnNvcnQoZnVuY3Rpb24gKGNvbnRhY3RBLCBjb250YWN0QikgewogICAgICAgICAgcmV0dXJuIGNvbnRhY3RBLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCkgLSBjb250YWN0Qi5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICBjb250YWN0LnN0YXR1cyA9IGNvbnRhY3Quc3RhdGU7CgogICAgICAgIGNvbnRhY3QuY29ubmVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoY29ubmVjdGlvbikgewogICAgICAgICAgY29ubmVjdGlvbi5hZGRyZXNzID0gY29ubmVjdGlvbi5lbmRwb2ludDsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVJZCA9CiAgICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlLnF1ZXVlQVJOOwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzLmZvckVhY2goZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgICAgcXVldWUucXVldWVJZCA9IHF1ZXVlLnF1ZXVlQVJOOwogICAgICB9KTsKICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgLy9jb250YWN0LnF1ZXVlIGlzIG51bGwgd2hlbiBtb25pdG9yaW5nCiAgICAgICAgaWYgKGNvbnRhY3QucXVldWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgY29udGFjdC5xdWV1ZS5xdWV1ZUlkID0gY29udGFjdC5xdWV1ZS5xdWV1ZUFSTjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZCA9CiAgICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOOwogICAgICAKICAgICAgaWYgKHRoaXMuc3VwcHJlc3MpIHsKICAgICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzID0gdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5maWx0ZXIoZnVuY3Rpb24oY29udGFjdCl7CiAgICAgICAgICByZXR1cm4gKGNvbnRhY3Quc3RhdGUudHlwZSA9PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRCB8fCBjb250YWN0LnN0YXRlLnR5cGUgPT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCk7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuZm9yY2VPZmZsaW5lKSB7CiAgICAgICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUpOwogICAgICAgIH0KICAgICAgfSAKICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLCB0aGlzLmFnZW50KTsKICAgIH0KICB9OwoKLyoqCiAqIFByb3ZpZGVzIGEgd2Vic29ja2V0IHVybCB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSS4KICogQHJldHVybnMgYSBwcm9taXNlIHdoaWNoLCB1cG9uIHN1Y2Nlc3MsIHJldHVybnMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNyZWF0ZVRyYW5zcG9ydCBBUEkuCiAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuZ2V0V2ViU29ja2V0VXJsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKICAgIHZhciBvbkFjY2Vzc0RlbmllZCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHsgdHJhbnNwb3J0VHlwZTogY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMuV0VCX1NPQ0tFVCB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0V2ViU29ja2V0VXJsIHN1Y2NlZWRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIGZhaWxlZCIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgcmVhc29uOiAnZ2V0V2ViU29ja2V0VXJsIGZhaWxlZCcsIAogICAgICAgICAgICBfZGVidWc6IGVycgogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIEF1dGggRmFpbHVyZSIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkF1dGhlbnRpY2F0aW9uIGZhaWxlZCB3aGlsZSBnZXR0aW5nIGdldFdlYlNvY2tldFVybCIpKTsKICAgICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIEFjY2VzcyBEZW5pZWQgRmFpbHVyZSIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkFjY2VzcyBEZW5pZWQgRmFpbHVyZSB3aGlsZSBnZXR0aW5nIGdldFdlYlNvY2tldFVybCIpKTsKICAgICAgICAgIG9uQWNjZXNzRGVuaWVkKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgoKICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgZG93bnN0cmVhbSB0byBhbGwgY29uc3VtZXJzIHdoZW4gd2UgZGV0ZWN0IHRoYXQgYXV0aGVudGljYXRpb24KICAgICogYWdhaW5zdCBvbmUgb2Ygb3VyIEFQSXMgaGFzIGZhaWxlZC4KICAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVTZW5kTG9nc1JlcXVlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgbG9nRXZlbnRzID0gW107CiAgICB2YXIgbG9nc1RvU2VuZCA9IHNlbGYubG9nc0J1ZmZlci5zbGljZSgpOwogICAgc2VsZi5sb2dzQnVmZmVyID0gW107CiAgICBsb2dzVG9TZW5kLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBsb2dFdmVudHMucHVzaCh7CiAgICAgICAgdGltZXN0YW1wOiBsb2cudGltZSwKICAgICAgICBjb21wb25lbnQ6IGxvZy5jb21wb25lbnQsCiAgICAgICAgbWVzc2FnZTogbG9nLnRleHQKICAgICAgfSk7CiAgICB9KTsKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfQ0xJRU5UX0xPR1MsIHsgbG9nRXZlbnRzOiBsb2dFdmVudHMgfSwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiU2VuZExvZ3MgcmVxdWVzdCBzdWNjZWVkZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlNlbmRMb2dzIHJlcXVlc3QgZmFpbGVkLiIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS53aXRoRXhjZXB0aW9uKGVycikKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKQogICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBdXRoRmFpbCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoZGF0YSkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBkYXRhKTsKICAgIH0KICAgIGVsc2UgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMKTsKICAgIH0KICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUFjY2Vzc0RlbmllZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0NFU1NfREVOSUVEKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmNoZWNrQXV0aFRva2VuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGV4cGlyYXRpb25EYXRlID0gbmV3IERhdGUoc2VsZi5pbml0RGF0YS5hdXRoVG9rZW5FeHBpcmF0aW9uKTsKICAgIHZhciBjdXJyZW50VGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgdGhpcnR5TWlucyA9IDMwICogNjAgKiAxMDAwOwoKICAgIC8vIHJlZnJlc2ggdG9rZW4gMzAgbWludXRlcyBiZWZvcmUgZXhwaXJhdGlvbgogICAgaWYgKGV4cGlyYXRpb25EYXRlLmdldFRpbWUoKSA8IChjdXJyZW50VGltZVN0YW1wICsgdGhpcnR5TWlucykpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBdXRoIHRva2VuIGV4cGlyZXMgYXQgIiArIGV4cGlyYXRpb25EYXRlICsgIiBTdGFydCByZWZyZXNoaW5nIHRva2VuIHdpdGggcmV0cnkuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5iYWNrb2ZmKGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5hdXRob3JpemUpLCBSRUZSRVNIX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMsIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZKTsKICAgIH0KICB9OwoKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5hdXRob3JpemUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplKHRoaXMuaW5pdERhdGEuYXV0aG9yaXplRW5kcG9pbnQpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciBleHBpcmF0aW9uID0gbmV3IERhdGUocmVzcG9uc2UuZXhwaXJhdGlvbik7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aG9yaXphdGlvbiBzdWNjZWVkZWQgYW5kIHRoZSB0b2tlbiBleHBpcmVzIGF0ICVzIiwgZXhwaXJhdGlvbikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW4gPSByZXNwb25zZS5hY2Nlc3NUb2tlbjsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW5FeHBpcmF0aW9uID0gZXhwaXJhdGlvbjsKICAgICAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQoc2VsZi5pbml0RGF0YSk7CiAgICAgIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQoc2VsZi5pbml0RGF0YSk7CiAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQXV0aG9yaXphdGlvbiBmYWlsZWQgd2l0aCBjb2RlICVzIiwgcmVzcG9uc2Uuc3RhdHVzKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDEpIHsKICAgICAgICBzZWxmLmhhbmRsZUF1dGhGYWlsKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogRmlsdGVyIHRoZSAnYXV0aGVudGljYXRpb24nIGZpZWxkIG9mIHRoZSByZXF1ZXN0IHBhcmFtcyBmcm9tIHRoZSBnaXZlbiBBUElfUkVRVUVTVCBldmVudC4KICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmZpbHRlckF1dGhUb2tlbiA9IGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICB2YXIgbmV3X3JlcXVlc3QgPSB7fTsKCiAgICBmb3IgKHZhciBrZXlBIGluIHJlcXVlc3QpIHsKICAgICAgaWYgKGtleUEgPT09ICdwYXJhbXMnKSB7CiAgICAgICAgdmFyIG5ld19wYXJhbXMgPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXlCIGluIHJlcXVlc3QucGFyYW1zKSB7CiAgICAgICAgICBpZiAoa2V5QiAhPT0gJ2F1dGhlbnRpY2F0aW9uJykgewogICAgICAgICAgICBuZXdfcGFyYW1zW2tleUJdID0gcmVxdWVzdC5wYXJhbXNba2V5Ql07CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBuZXdfcmVxdWVzdC5wYXJhbXMgPSBuZXdfcGFyYW1zOwogICAgICB9IGVsc2UgewogICAgICAgIG5ld19yZXF1ZXN0W2tleUFdID0gcmVxdWVzdFtrZXlBXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBuZXdfcmVxdWVzdDsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC53b3JrZXIubWFpbiA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3Qud29ya2VyLmNsaWVudEVuZ2luZSA9IG5ldyBDbGllbnRFbmdpbmUoKTsKICB9OwoKfSkoKTsKCi8qKiovIH0pCgovKioqKioqLyAJfSk7Ci8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkvLyBUaGUgbW9kdWxlIGNhY2hlCi8qKioqKiovIAl2YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307Ci8qKioqKiovIAkKLyoqKioqKi8gCS8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uCi8qKioqKiovIAlmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7Ci8qKioqKiovIAkJLy8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlCi8qKioqKiovIAkJdmFyIGNhY2hlZE1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF07Ci8qKioqKiovIAkJaWYgKGNhY2hlZE1vZHVsZSAhPT0gdW5kZWZpbmVkKSB7Ci8qKioqKiovIAkJCXJldHVybiBjYWNoZWRNb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCQl9Ci8qKioqKiovIAkJLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSkKLyoqKioqKi8gCQl2YXIgbW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJLy8gbm8gbW9kdWxlLmlkIG5lZWRlZAovKioqKioqLyAJCQkvLyBubyBtb2R1bGUubG9hZGVkIG5lZWRlZAovKioqKioqLyAJCQlleHBvcnRzOiB7fQovKioqKioqLyAJCX07Ci8qKioqKiovIAkKLyoqKioqKi8gCQkvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb24KLyoqKioqKi8gCQlfX3dlYnBhY2tfbW9kdWxlc19fW21vZHVsZUlkXShtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTsKLyoqKioqKi8gCQovKioqKioqLyAJCS8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJfQovKioqKioqLyAJCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkvKiB3ZWJwYWNrL3J1bnRpbWUvZ2xvYmFsICovCi8qKioqKiovIAkoKCkgPT4gewovKioqKioqLyAJCV9fd2VicGFja19yZXF1aXJlX18uZyA9IChmdW5jdGlvbigpIHsKLyoqKioqKi8gCQkJaWYgKHR5cGVvZiBnbG9iYWxUaGlzID09PSAnb2JqZWN0JykgcmV0dXJuIGdsb2JhbFRoaXM7Ci8qKioqKiovIAkJCXRyeSB7Ci8qKioqKiovIAkJCQlyZXR1cm4gdGhpcyB8fCBuZXcgRnVuY3Rpb24oJ3JldHVybiB0aGlzJykoKTsKLyoqKioqKi8gCQkJfSBjYXRjaCAoZSkgewovKioqKioqLyAJCQkJaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSByZXR1cm4gd2luZG93OwovKioqKioqLyAJCQl9Ci8qKioqKiovIAkJfSkoKTsKLyoqKioqKi8gCX0pKCk7Ci8qKioqKiovIAkKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gCQovKioqKioqLyAJLy8gc3RhcnR1cAovKioqKioqLyAJLy8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzCi8qKioqKiovIAkvLyBUaGlzIGVudHJ5IG1vZHVsZSB1c2VkICdtb2R1bGUnIHNvIGl0IGNhbid0IGJlIGlubGluZWQKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODI3KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oOTQ0KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMTUxKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODkxKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNTkyKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3NTQpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MzMpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg5NjUpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygyODYpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4OTUpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3NDMpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg2NDIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3MzYpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg0MzkpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygyNzkpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg0MTgpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygxODcpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MjEpOwovKioqKioqLyAJdmFyIF9fd2VicGFja19leHBvcnRzX18gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUwMCk7Ci8qKioqKiovIAkKLyoqKioqKi8gfSkoKQo7"),C=function(I){this.region=I.region,this.id=this.region.replace(/-/g,"_"),this.height=I.height,this.style=I.iframe_style,this.ccp=this._createFramedCcp(JSON.stringify(I))};C.prototype._createFramedCcp=function(I){var g=g||"microphone; autoplay",C=this.style||"margin: 0; border: 0; padding: 0px; width: 0px; height: 0px",A=document.createElement("iframe");return A.srcdoc=this.getContent(I),A.allow=g,A.id=this.id,A.style=C,A.scrolling="no",A},C.prototype.getContent=function(I){return["<!DOCTYPE html>","<meta charset='UTF-8'>","<html>","<head>","<script type='text/javascript'>",g,"<\/script>","</head>","<body onload='init()'>","<div id=containerDiv style='width: 100%;height: "+this.height+"'></div>","<script type='text/javascript'>","function init() {","connect.core.initCCP(containerDiv,"+I+");","}","<\/script>","</body>","</html>"].join("")},globalConnect.Container=C}(),function(){var I=this;connect=I.connect||{},globalConnect=I.globalConnect||{},I.connect=connect,I.globalConnect=globalConnect,I.lily=connect,connect.core={},globalConnect.core={regions:{}};var g="465px",C=!0,A=function(I){var g=window.getComputedStyle(I);return{height:g.getPropertyValue("height"),width:g.getPropertyValue("width"),display:g.getPropertyValue("display")}},Z=function(I,g){if(connect.assertTrue("string"==typeof I,"Region provided "+I+" is not a valid string"),!(g||globalConnect.core.regions).hasOwnProperty(I)){var C="Region provided "+I+" is not found!";throw new connect.ValueError(C)}};globalConnect.core.initCCP=function(I,G){connect.assertNotNull(G.getPrimaryRegion,"getPrimaryRegion"),connect.assertTrue(connect.isFunction(G.getPrimaryRegion),"getPrimaryRegion must be a function");var d=G.getPrimaryRegion;delete G.getPrimaryRegion;var c=function(I,Z){connect.assertNotNull(Z.standByRegion,"ccpBackupResource"),connect.assertNotNull(Z.standByRegion.ccpUrl,"ccpUrl"),connect.assertNotNull(Z.standByRegion.loginUrl,"loginUrl"),connect.assertNotNull(Z.standByRegion.region,"region");var l=Z,b=Object.assign({},Z,{ccpUrl:Z.standByRegion.ccpUrl,loginUrl:Z.standByRegion.loginUrl,region:Z.standByRegion.region}),G=A(I);return"none"==G.display&&(C=!1),parseInt(G.height)<=0&&(I.style.height=g,G.height=g),[l,b].map((function(I){return connect.assertNotNull(I.ccpUrl,"ccpUrl"),connect.assertNotNull(I.loginUrl,"loginUrl"),connect.assertNotNull(I.region,"region"),delete I.standByRegion,I.loginPopup=!1,I.disasterRecoveryOn=!0,I.iframe_style="margin: 0; border: 0; padding:0px;width: 0px;height: 0px",I.height=G.height,I}))}(I,G);d((function(g){return new Promise((A=>{var G=c.reduce((function(I,g){return I[g.region]=null,I}),{});Z(g,G);var d=c.map((function(I){return I.region===g&&(I.isPrimary=!0),new globalConnect.Container(I)})),V=d.map((function(I){return I.ccp.outerHTML})),W=document.createElement("iframe");W.style="margin: 0; border: 0; padding:0px;width: 100%;height: 100%",W.id="globalCCP",W.scrolling="no",W.onload=function(){if(C){var I=Object.keys(G).find((function(I){return I!=g}));b(g,W.id),l(I,W.id)}d.map((function(A){globalConnect.core.regions[A.region]=W.contentDocument.getElementById(A.id).contentWindow.connect;var Z=globalConnect.core.regions[A.region];Z.core.getUpstream().onUpstream(Z.DisasterRecoveryEvents.FAILOVER,(function(A){A.isPrimary?(connect=Z,g=connect.core.region,C&&b(g,W.id)):C&&(I=Z.core.region,l(I,W.id))}))})),connect=globalConnect.core.regions[g],A()},W.srcdoc=V.join(""),I.appendChild(W)}))}),(function(I){console.error("[Disaster Recovery] An error occured, while attempting to retrieve your primary region;"),I()}))};var l=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height: 0; width: 0; border: 0px"},b=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height:800px;width:100%;border:0px"},G=function(I){return I=I||connect.core.region,Object.keys(globalConnect.core.regions).find((function(g){return g!==I}))};globalConnect.core.failover=function(){globalConnect.core.failoverTo(G())},globalConnect.core.failoverTo=function(I){Z(I);var g=G(I);d(g),c(I),connect=globalConnect.core.regions[I]};var d=function(I){var g=globalConnect.core.regions[I];g.getLog().info("[Disaster Recovery] Deactivating %s region.",g.core.region).sendInternalLogToServer(),g.core.suppressContacts(!0),g.core.forceOffline()},c=function(I){var g=globalConnect.core.regions[I];g.getLog().info("[Disaster Recovery] Activating %s region.",g.core.region).sendInternalLogToServer(),g.core.suppressContacts(!1)};connect.core.initCCP=globalConnect.core.initCCP}();