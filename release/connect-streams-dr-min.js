(()=>{var I;(I={772:()=>{!function(){var I=this||globalThis,g=I.connect||{};I.connect=g,I.globalConnect={},I.lily=g,globalConnect.Container=null;var C=window.atob("LyoqKioqKi8gKCgpID0+IHsgLy8gd2VicGFja0Jvb3RzdHJhcAovKioqKioqLyAJdmFyIF9fd2VicGFja19tb2R1bGVzX18gPSAoewoKLyoqKi8gODIxOgovKioqLyAoKCkgPT4gewoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5hZ2VudEFwcCA9IHt9OwoKICB2YXIgQVBQID0gewogICAgQ0NQOiAnY2NwJywKICB9OwoKICBjb25uZWN0LmFnZW50QXBwLmluaXRDQ1AgPSBjb25uZWN0LmNvcmUuaW5pdENDUDsKICBjb25uZWN0LmFnZW50QXBwLmlzSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbiAoaW5zdGFuY2VBbGlhcykge307CgogIGNvbm5lY3QuYWdlbnRBcHAuaW5pdEFwcENvbW11bmljYXRpb24gPSBmdW5jdGlvbiAoaWZyYW1lSWQsIGVuZHBvaW50KSB7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWZyYW1lSWQpOwogICAgdmFyIGlmcmFtZUNvbmR1aXQgPSBuZXcgY29ubmVjdC5JRnJhbWVDb25kdWl0KGVuZHBvaW50LCB3aW5kb3csIGlmcmFtZSk7CiAgICB2YXIgQlJPQURDQVNUX1RZUEUgPSBbCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLAogICAgICBjb25uZWN0LkNvbnRhY3RFdmVudHMuVklFVywKICAgICAgY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsCiAgICAgIGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURUQsCiAgICAgIGNvbm5lY3QuVGFza0V2ZW50cy5DUkVBVEVECiAgICBdOwogICAgaWZyYW1lLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmdW5jdGlvbiAoZSkgewogICAgICBCUk9BRENBU1RfVFlQRS5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbSh0eXBlLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWZyYW1lQ29uZHVpdC5zZW5kVXBzdHJlYW0odHlwZSwgZGF0YSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgdmFyIGdldENvbm5lY3RVcmwgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgcG9zID0gY2NwVXJsLmluZGV4T2YoJ2NjcC12MicpOwogICAgcmV0dXJuIGNjcFVybC5zbGljZSgwLCBwb3MgLSAxKTsKICB9OwoKICB2YXIgc2lnbk91dFRocm91Z2hDQ1AgPSBmdW5jdGlvbiAoY2NwVXJsKSB7CiAgICB2YXIgbG9nb3V0VXJsID0gZ2V0Q29ubmVjdFVybChjY3BVcmwpICsgJy9sb2dvdXQnOwogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2gobG9nb3V0VXJsLCB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsCiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGV2ZW50QnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGV2ZW50QnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkgewogICAgICBjb25uZWN0CiAgICAgICAgLmdldExvZygpCiAgICAgICAgLmVycm9yKCdBbiBlcnJvciBvY2N1cmVkIG9uIGxvZ291dC4nICsgZSkKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBsb2dvdXRVcmw7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwogIH07CgogIHZhciBzaWduSW5UaHJvdWdoaW5pdENDUCA9IGZ1bmN0aW9uIChjY3BVcmwsIGNvbnRhaW5lciwgY29uZmlnKSB7CiAgICB2YXIgZGVmYXVsdFBhcmFtcyA9IHsKICAgICAgY2NwVXJsOiBjY3BVcmwsCiAgICAgIGNjcExvYWRUaW1lb3V0OiAxMDAwMCwKICAgICAgbG9naW5Qb3B1cDogdHJ1ZSwKICAgICAgbG9naW5Vcmw6IGdldENvbm5lY3RVcmwoY2NwVXJsKSArICcvbG9naW4nLAogICAgICBzb2Z0cGhvbmU6IHsKICAgICAgICBhbGxvd0ZyYW1lZFNvZnRwaG9uZTogdHJ1ZSwKICAgICAgICBkaXNhYmxlUmluZ3RvbmU6IGZhbHNlLAogICAgICB9CiAgICB9OwogICAgdmFyIGNjcFBhcmFtcyA9IGNvbm5lY3QubWVyZ2UoZGVmYXVsdFBhcmFtcywgY29uZmlnLmNjcFBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENDUChjb250YWluZXIsIGNjcFBhcmFtcyk7CiAgfTsKCiAgY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwID0gZnVuY3Rpb24gKG5hbWUsIGNvbnRhaW5lcklkLCBhcHBVcmwsIGNvbmZpZykgewogICAgY29uZmlnID0gY29uZmlnID8gY29uZmlnIDoge307CiAgICB2YXIgZW5kcG9pbnQgPSBhcHBVcmwuZW5kc1dpdGgoJy8nKSA/IGFwcFVybCA6IGFwcFVybCArICcvJzsKICAgIHZhciBvbkxvYWQgPSBjb25maWcub25Mb2FkID8gY29uZmlnLm9uTG9hZCA6IG51bGw7CiAgICB2YXIgcmVnaXN0ZXJDb25maWcgPSB7IGVuZHBvaW50OiBlbmRwb2ludCwgc3R5bGU6IGNvbmZpZy5zdHlsZSwgb25Mb2FkOiBvbkxvYWQgfTsKICAgIGNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgcmVnaXN0ZXJDb25maWcsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNvbnRhaW5lcklkKSk7CiAgICBjb25uZWN0LmFnZW50QXBwLkFwcFJlZ2lzdHJ5LnN0YXJ0KG5hbWUsIGZ1bmN0aW9uIChtb2R1bGVEYXRhKSB7CiAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGEuZW5kcG9pbnQ7CiAgICAgIHZhciBjb250YWluZXJET00gPSBtb2R1bGVEYXRhLmNvbnRhaW5lckRPTTsKICAgICAgcmV0dXJuIHsKICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgewogICAgICAgICAgICBjb25maWcuY2NwUGFyYW1zID0gY29uZmlnLmNjcFBhcmFtcyA/IGNvbmZpZy5jY3BQYXJhbXMgOiB7fTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5zdHlsZSkgY29uZmlnLmNjcFBhcmFtcy5zdHlsZSA9IGNvbmZpZy5zdHlsZTsKICAgICAgICAgICAgcmV0dXJuIHNpZ25JblRocm91Z2hpbml0Q0NQKGVuZHBvaW50LCBjb250YWluZXJET00sIGNvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5pbml0QXBwQ29tbXVuaWNhdGlvbihuYW1lLCBlbmRwb2ludCk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gQVBQLkNDUCkgcmV0dXJuIHNpZ25PdXRUaHJvdWdoQ0NQKGVuZHBvaW50KTsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIH07CgogIGNvbm5lY3QuYWdlbnRBcHAuc3RvcEFwcCA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gY29ubmVjdC5hZ2VudEFwcC5BcHBSZWdpc3RyeS5zdG9wKG5hbWUpOwogIH07Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA1MDA6Ci8qKiovICgoKSA9PiB7CgooZnVuY3Rpb24gKCkgewogIHZhciBnbG9iYWwgPSB0aGlzIHx8IGdsb2JhbFRoaXM7CiAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CgogIHZhciBBUFAgPSB7CiAgICBDQ1A6ICdjY3AnLAogIH07CgogIGZ1bmN0aW9uIEFwcFJlZ2lzdHJ5KCkgewogICAgdmFyIG1vZHVsZURhdGEgPSB7fTsKICAgIHZhciBtYWtlQXBwSWZyYW1lID0gZnVuY3Rpb24gKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKSB7CiAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgaWZyYW1lLnNyYyA9IGVuZHBvaW50OwogICAgICBpZnJhbWUuc3R5bGUgPSBzdHlsZSB8fCAnd2lkdGg6IDEwMCU7IGhlaWdodDoxMDAlOyc7CiAgICAgIGlmcmFtZS5pZCA9IGFwcE5hbWU7CiAgICAgIGlmcmFtZVsnYXJpYS1sYWJlbCddID0gYXBwTmFtZTsKICAgICAgaWZyYW1lLm9ubG9hZCA9IG9uTG9hZDsKICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgKICAgICAgICAic2FuZGJveCIsCiAgICAgICAgImFsbG93LWZvcm1zIGFsbG93LXBvcHVwcyBhbGxvdy1wb3B1cHMtdG8tZXNjYXBlLXNhbmRib3ggYWxsb3ctc2FtZS1vcmlnaW4gYWxsb3ctc2NyaXB0cyIKICAgICAgKTsKICAgICAgLy8gVE9ETzogVXBkYXRlIHNhbmRib3ggb3B0aW9uIGZvciAzUCB3aWRnZXQKCiAgICAgIHJldHVybiBpZnJhbWU7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiAoYXBwTmFtZSwgY29uZmlnLCBjb250YWluZXJET00pIHsKICAgICAgICBtb2R1bGVEYXRhW2FwcE5hbWVdID0gewogICAgICAgICAgY29udGFpbmVyRE9NOiBjb250YWluZXJET00sCiAgICAgICAgICBlbmRwb2ludDogY29uZmlnLmVuZHBvaW50LAogICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSwKICAgICAgICAgIGluc3RhbmNlOiB1bmRlZmluZWQsCiAgICAgICAgICBvbkxvYWQ6IGNvbmZpZy5vbkxvYWQsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgc3RhcnQ6IGZ1bmN0aW9uIChhcHBOYW1lLCBjcmVhdG9yKSB7CiAgICAgICAgaWYgKCFtb2R1bGVEYXRhW2FwcE5hbWVdKSByZXR1cm47CiAgICAgICAgdmFyIGNvbnRhaW5lckRPTSA9IG1vZHVsZURhdGFbYXBwTmFtZV0uY29udGFpbmVyRE9NOwogICAgICAgIHZhciBlbmRwb2ludCA9IG1vZHVsZURhdGFbYXBwTmFtZV0uZW5kcG9pbnQ7CiAgICAgICAgdmFyIHN0eWxlID0gbW9kdWxlRGF0YVthcHBOYW1lXS5zdHlsZTsKICAgICAgICB2YXIgb25Mb2FkID0gbW9kdWxlRGF0YVthcHBOYW1lXS5vbkxvYWQ7CiAgICAgICAgaWYgKGFwcE5hbWUgIT09IEFQUC5DQ1ApIHsKICAgICAgICAgIHZhciBhcHAgPSBtYWtlQXBwSWZyYW1lKGFwcE5hbWUsIGVuZHBvaW50LCBzdHlsZSwgb25Mb2FkKTsKICAgICAgICAgIGNvbnRhaW5lckRPTS5hcHBlbmRDaGlsZChhcHApOwogICAgICAgIH0KCiAgICAgICAgbW9kdWxlRGF0YVthcHBOYW1lXS5pbnN0YW5jZSA9IGNyZWF0b3IobW9kdWxlRGF0YVthcHBOYW1lXSk7CiAgICAgICAgcmV0dXJuIG1vZHVsZURhdGFbYXBwTmFtZV0uaW5zdGFuY2UuaW5pdCgpOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbiAoYXBwTmFtZSkgewogICAgICAgIGlmICghbW9kdWxlRGF0YVthcHBOYW1lXSkgcmV0dXJuOwoKICAgICAgICB2YXIgZGF0YSA9IG1vZHVsZURhdGFbYXBwTmFtZV07CiAgICAgICAgdmFyIGFwcCA9IGRhdGEuY29udGFpbmVyRE9NLnF1ZXJ5U2VsZWN0b3IoJ2lmcmFtZScpOwogICAgICAgIGRhdGEuY29udGFpbmVyRE9NLnJlbW92ZUNoaWxkKGFwcCk7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgaWYgKGRhdGEuaW5zdGFuY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGRhdGEuaW5zdGFuY2UuZGVzdHJveSgpOwogICAgICAgICAgZGVsZXRlIGRhdGEuaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogIH0KCiAgZ2xvYmFsLmNvbm5lY3QuYWdlbnRBcHAuQXBwUmVnaXN0cnkgPSBBcHBSZWdpc3RyeSgpOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gOTY1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBBZ2VudFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQWdlbnRTdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdvZmZsaW5lJwogIF0pOwogIGNvbm5lY3QuQWdlbnRTdGF0dXNUeXBlID0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEF2YWlsU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEF2YWlsU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnSW5pdCcsCiAgICAnQnVzeScsCiAgICAnQWZ0ZXJDYWxsV29yaycsCiAgICAnQ2FsbGluZ0N1c3RvbWVyJywKICAgICdEaWFsaW5nJywKICAgICdKb2luaW5nJywKICAgICdQZW5kaW5nQXZhaWxhYmxlJywKICAgICdQZW5kaW5nQnVzeScKICBdKTsKCiAgLyoqCiAgICogZW51bSBBZ2VudEVycm9yU3RhdGVzCiAgICovCiAgY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnRXJyb3InLAogICAgJ0FnZW50SHVuZ1VwJywKICAgICdCYWRBZGRyZXNzQWdlbnQnLAogICAgJ0JhZEFkZHJlc3NDdXN0b21lcicsCiAgICAnRGVmYXVsdCcsCiAgICAnRmFpbGVkQ29ubmVjdEFnZW50JywKICAgICdGYWlsZWRDb25uZWN0Q3VzdG9tZXInLAogICAgJ0ludmFsaWRMb2NhbGUnLAogICAgJ0xpbmVFbmdhZ2VkQWdlbnQnLAogICAgJ0xpbmVFbmdhZ2VkQ3VzdG9tZXInLAogICAgJ01pc3NlZENhbGxBZ2VudCcsCiAgICAnTWlzc2VkQ2FsbEN1c3RvbWVyJywKICAgICdNdWx0aXBsZUNjcFdpbmRvd3MnLAogICAgJ1JlYWx0aW1lQ29tbXVuaWNhdGlvbkVycm9yJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIEFkZHJlc3NUeXBlCiAgICovCiAgY29ubmVjdC5FbmRwb2ludFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdwaG9uZV9udW1iZXInLAogICAgJ2FnZW50JywKICAgICdxdWV1ZScKICBdKTsKICBjb25uZWN0LkFkZHJlc3NUeXBlID0gY29ubmVjdC5FbmRwb2ludFR5cGU7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29ubmVjdGlvblR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25UeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWdlbnQnLAogICAgJ2luYm91bmQnLAogICAgJ291dGJvdW5kJywKICAgICdtb25pdG9yaW5nJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbm5lY3Rpb25TdGF0ZVR5cGUKICAgKi8KICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbml0JywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ2hvbGQnLAogICAgJ2Rpc2Nvbm5lY3RlZCcsCiAgICAnc2lsZW50X21vbml0b3InLAogICAgJ2JhcmdlJwogIF0pOwogIGNvbm5lY3QuQ29ubmVjdGlvblN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OTkVDVElPTl9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5zZXQoWwogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQsCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuU0lMRU5UX01PTklUT1IsCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQkFSR0UKICBdKTsKCiAgY29ubmVjdC5DT05ORUNUSU9OX0NPTk5FQ1RFRF9TVEFURVMgPSBjb25uZWN0LnNldChbCiAgICBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuQ09OTkVDVEVELAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLlNJTEVOVF9NT05JVE9SLAogICAgY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkJBUkdFCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdFN0YXRlVHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2luaXQnLAogICAgJ2luY29taW5nJywKICAgICdwZW5kaW5nJywKICAgICdjb25uZWN0aW5nJywKICAgICdjb25uZWN0ZWQnLAogICAgJ21pc3NlZCcsCiAgICAnZXJyb3InLAogICAgJ2VuZGVkJwogIF0pOwogIGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUgPSBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGU7CgogIGNvbm5lY3QuQ09OVEFDVF9BQ1RJVkVfU1RBVEVTID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBDb250YWN0VHlwZQogICAqLwogIGNvbm5lY3QuQ29udGFjdFR5cGUgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICd2b2ljZScsCiAgICAncXVldWVfY2FsbGJhY2snLAogICAgJ2NoYXQnLAogICAgJ3Rhc2snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQ29udGFjdEluaXRpYXRpb25NZXRob2QKICAgKi8KICBjb25uZWN0LkNvbnRhY3RJbml0aWF0aW9uTWV0aG9kID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnaW5ib3VuZCcsCiAgICAnb3V0Ym91bmQnLAogICAgJ3RyYW5zZmVyJywKICAgICdxdWV1ZV90cmFuc2ZlcicsCiAgICAnY2FsbGJhY2snLAogICAgJ2FwaScsCiAgICAnZGlzY29ubmVjdCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgQ29udGFjdFJlY29yZGluZyBWb2ljZSBUcmFjayBjb25maWcKICAgKi8KICBjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnQUxMJywKICAgICdUT19BR0VOVCcsCiAgICAnRlJPTV9BR0VOVCcKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgTW9uaXRvcmluZ01vZGUKICAgKi8KICBjb25uZWN0Lk1vbml0b3JpbmdNb2RlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnU0lMRU5UX01PTklUT1InLAogICAgJ0JBUkdFJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBNb25pdG9yaW5nRXJyb3JUeXBlcwogICAqLwogIGNvbm5lY3QuTW9uaXRvcmluZ0Vycm9yVHlwZXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdpbnZhbGlkX3RhcmdldF9zdGF0ZScKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENoYW5uZWxUeXBlCiAgKi8KICBjb25uZWN0LkNoYW5uZWxUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnVk9JQ0UnLAogICAgJ0NIQVQnLAogICAgJ1RBU0snCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogZW51bSBNZWRpYVR5cGUKICAqLwogIGNvbm5lY3QuTWVkaWFUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnc29mdHBob25lJywKICAgICdjaGF0JywKICAgICd0YXNrJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNvZnRwaG9uZUNhbGxUeXBlCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ2F1ZGlvX3ZpZGVvJywKICAgICd2aWRlb19vbmx5JywKICAgICdhdWRpb19vbmx5JywKICAgICdub25lJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBTb2Z0cGhvbmVFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndW5zdXBwb3J0ZWRfYnJvd3NlcicsCiAgICAnbWljcm9waG9uZV9ub3Rfc2hhcmVkJywKICAgICdzaWduYWxsaW5nX2hhbmRzaGFrZV9mYWlsdXJlJywKICAgICdzaWduYWxsaW5nX2Nvbm5lY3Rpb25fZmFpbHVyZScsCiAgICAnaWNlX2NvbGxlY3Rpb25fdGltZW91dCcsCiAgICAndXNlcl9idXN5X2Vycm9yJywKICAgICd3ZWJydGNfZXJyb3InLAogICAgJ3JlYWx0aW1lX2NvbW11bmljYXRpb25fZXJyb3InLAogICAgJ290aGVyJwogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBDbGlja1R5cGUKICAgKi8KICBjb25uZWN0LkNsaWNrVHlwZSA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ0FjY2VwdCcsCiAgICAnUmVqZWN0JywKICAgICdIYW5ndXAnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWRFcnJvclR5cGVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgJ25vX3NwZWFrZXJfaWRfZm91bmQnLAogICAgJ3NwZWFrZXJfaWRfbm90X2Vucm9sbGVkJywKICAgICdnZXRfc3BlYWtlcl9pZF9mYWlsZWQnLAogICAgJ2dldF9zcGVha2VyX3N0YXR1c19mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9mYWlsZWQnLAogICAgJ29wdF9vdXRfc3BlYWtlcl9pbl9sY21zX2ZhaWxlZCcsCiAgICAnZGVsZXRlX3NwZWFrZXJfZmFpbGVkJywKICAgICdzdGFydF9zZXNzaW9uX2ZhaWxlZCcsCiAgICAnZXZhbHVhdGVfc3BlYWtlcl9mYWlsZWQnLAogICAgJ3Nlc3Npb25fbm90X2V4aXN0cycsCiAgICAnZGVzY3JpYmVfc2Vzc2lvbl9mYWlsZWQnLAogICAgJ2Vucm9sbF9zcGVha2VyX2ZhaWxlZCcsCiAgICAndXBkYXRlX3NwZWFrZXJfaWRfZmFpbGVkJywKICAgICd1cGRhdGVfc3BlYWtlcl9pZF9pbl9sY21zX2ZhaWxlZCcsCiAgICAnbm90X3N1cHBvcnRlZF9vbl9jb25mZXJlbmNlX2NhbGxzJywKICAgICdlbnJvbGxfc3BlYWtlcl90aW1lb3V0JywKICAgICdldmFsdWF0ZV9zcGVha2VyX3RpbWVvdXQnLAogICAgJ2dldF9kb21haW5faWRfZmFpbGVkJywKICAgICdub19kb21haW5faWRfZm91bmQnCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIENUSSBleGNlcHRpb25zCiAgICovCiAgY29ubmVjdC5DVElFeGNlcHRpb25zID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQWNjZXNzRGVuaWVkRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkU3RhdGVFeGNlcHRpb24iLAogICAgIkJhZEVuZHBvaW50RXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQWdlbnRBUk5FeGNlcHRpb24iLAogICAgIkludmFsaWRDb25maWd1cmF0aW9uRXhjZXB0aW9uIiwKICAgICJJbnZhbGlkQ29udGFjdFR5cGVFeGNlcHRpb24iLAogICAgIlBhZ2luYXRpb25FeGNlcHRpb24iLAogICAgIlJlZnJlc2hUb2tlbkV4cGlyZWRFeGNlcHRpb24iLAogICAgIlNlbmREYXRhRmFpbGVkRXhjZXB0aW9uIiwKICAgICJVbmF1dGhvcml6ZWRFeGNlcHRpb24iLAogICAgIlF1b3RhRXhjZWVkZWRFeGNlcHRpb24iCiAgXSk7CiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBzdHJlYW1pbmcgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiT05HT0lORyIsCiAgICAiRU5ERUQiLAogICAgIlBFTkRJTkdfQ09ORklHVVJBVElPTiIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJBQ0NFUFQiLAogICAgIlJFSkVDVCIsCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIlNQRUFLRVJfTk9UX0VOUk9MTEVEIiwKICAgICJTUEVBS0VSX09QVEVEX09VVCIsCiAgICAiU1BFQUtFUl9JRF9OT1RfUFJPVklERUQiLAogICAgIlNQRUFLRVJfRVhQSVJFRCIKICBdKTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBmb3IgVm9pY2VJZCBmcmF1ZCBkZXRlY3Rpb24gZGVjaXNpb24KICAgKi8KICBjb25uZWN0LlZvaWNlSWRGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiTk9UX0VOT1VHSF9TUEVFQ0giLAogICAgIkhJR0hfUklTSyIsCiAgICAiTE9XX1JJU0siCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIGNvbnRhY3QgZmxvdyBhdXRoZW50aWNhdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiQXV0aGVudGljYXRlZCIsCiAgICAiTm90QXV0aGVudGljYXRlZCIsCiAgICAiSW5jb25jbHVzaXZlIiwKICAgICJOb3RFbnJvbGxlZCIsCiAgICAiT3B0ZWRPdXQiLAogICAgIk5vdEVuYWJsZWQiLAogICAgIkVycm9yIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBjb250YWN0IGZsb3cgIGZyYXVkIGRldGVjdGlvbiBkZWNpc2lvbgogICAqLwogIGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAiSGlnaFJpc2siLAogICAgIkxvd1Jpc2siLAogICAgIkluY29uY2x1c2l2ZSIsCiAgICAiTm90RW5hYmxlZCIsCiAgICAiRXJyb3IiCiAgXSk7CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gZm9yIFZvaWNlSWQgRW5yb2xsbWVudFJlcXVlc3QgU3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICJOT1RfRU5PVUdIX1NQRUVDSCIsCiAgICAiSU5fUFJPR1JFU1MiLAogICAgIkNPTVBMRVRFRCIsCiAgICAiRkFJTEVEIgogIF0pOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIGZvciBWb2ljZUlkIFNwZWFrZXIgc3RhdHVzCiAgICovCiAgY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cyA9IGNvbm5lY3QubWFrZUVudW0oWwogICAgIk9QVEVEX09VVCIsCiAgICAiRU5ST0xMRUQiLAogICAgIlBFTkRJTkciCiAgXSk7CgogIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cyA9IHsKICAgIEVWQUxVQVRFX1NFU1NJT05fREVMQVk6IDEwMDAwLAogICAgRVZBTFVBVElPTl9NQVhfUE9MTF9USU1FUzogMjQsIC8vIEV2YWx1YXRlU3BlYWtlciBpcyBQb2xsaW5nIGZvciBtYXhpbXVtIDIgbWlucy4KICAgIEVWQUxVQVRJT05fUE9MTElOR19JTlRFUlZBTDogNTAwMCwKICAgIEVOUk9MTE1FTlRfTUFYX1BPTExfVElNRVM6IDEyMCwgLy8gRW5yb2xsbWVudFNwZWFrZXIgaXMgUG9sbGluZyBmb3IgbWF4aW11bSAxMCBtaW5zLgogICAgRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMOiA1MDAwLAogICAgU1RBUlRfU0VTU0lPTl9ERUxBWTogODAwMAogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY29uc3RhbnRzIGZvciBBZ2VudFBlcm1pc3Npb25zCiAgICovCiAgY29ubmVjdC5BZ2VudFBlcm1pc3Npb25zID0gewogICAgT1VUQk9VTkRfQ0FMTDogJ291dGJvdW5kQ2FsbCcsCiAgICBWT0lDRV9JRDogJ3ZvaWNlSWQnLAogICAgQ09OVEFDVF9SRUNPUkRJTkc6ICdjb250YWN0UmVjb3JkaW5nJwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEFnZW50CiAgICovCiAgdmFyIEFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmFnZW50LmluaXRpYWxpemVkKSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoIlRoZSBhZ2VudCBpcyBub3QgeWV0IGluaXRpYWxpemVkISIpOwogICAgfQogIH07CgogIEFnZW50LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuX2NyZWF0ZUNvbnRhY3RBUEkgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUmVmcmVzaCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuUkVGUkVTSCwgZik7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLm9uUm91dGFibGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLlJPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Ob3RSb3V0YWJsZSA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuTk9UX1JPVVRBQkxFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25PZmZsaW5lID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5PRkZMSU5FLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNvZnRwaG9uZUVycm9yID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TT0ZUUEhPTkVfRVJST1IsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5XRUJTT0NLRVRfQ09OTkVDVElPTl9MT1NULCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbldlYlNvY2tldENvbm5lY3Rpb25HYWluZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0dBSU5FRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUub25BZnRlckNhbGxXb3JrID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5BQ1csIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblN0YXRlQ2hhbmdlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5BZ2VudEV2ZW50cy5TVEFURV9DSEFOR0UsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vbk11dGVUb2dnbGUgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLCBmKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUub25Mb2NhbE1lZGlhU3RyZWFtQ3JlYXRlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5vblNwZWFrZXJEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vbk1pY3JvcGhvbmVEZXZpY2VDaGFuZ2VkID0gZnVuY3Rpb24oZil7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELCBmKTsKICB9CgogIEFnZW50LnByb3RvdHlwZS5vblJpbmdlckRldmljZUNoYW5nZWQgPSBmdW5jdGlvbihmKXsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlJJTkdFUl9ERVZJQ0VfQ0hBTkdFRCwgZik7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUubXV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgIHsKICAgICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuTVVURSwKICAgICAgICBkYXRhOiB7IG11dGU6IHRydWUgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUudW5tdXRlID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkV2ZW50VHlwZS5NVVRFLAogICAgICAgIGRhdGE6IHsgbXV0ZTogZmFsc2UgfQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuc2V0U3BlYWtlckRldmljZSA9IGZ1bmN0aW9uIChkZXZpY2VJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldE1pY3JvcGhvbmVEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfTUlDUk9QSE9ORV9ERVZJQ0UsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwKICAgICAgZGF0YTogeyBkZXZpY2VJZDogZGV2aWNlSWQgfQogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5zdGF0ZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmV4dFN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5uZXh0U3RhdGU7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEF2YWlsYWJpbGl0eVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5hZ2VudEF2YWlsYWJpbGl0eVN0YXRlOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc25hcHNob3Quc3RhdGUuc3RhcnRUaW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBBZ2VudC5wcm90b3R5cGUuZ2V0U3RhdGVEdXJhdGlvbjsKCiAgQWdlbnQucHJvdG90eXBlLmdldFBlcm1pc3Npb25zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnBlcm1pc3Npb25zOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRDb250YWN0cyA9IGZ1bmN0aW9uIChjb250YWN0VHlwZUZpbHRlcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zbmFwc2hvdC5jb250YWN0cy5tYXAoZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVDb250YWN0QVBJKGNvbnRhY3REYXRhKTsKICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoY29udGFjdCkgewogICAgICByZXR1cm4gKCFjb250YWN0VHlwZUZpbHRlcikgfHwgY29udGFjdC5nZXRUeXBlKCkgPT09IGNvbnRhY3RUeXBlRmlsdGVyOwogICAgfSk7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbmZpZ3VyYXRpb247CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLmdldEFnZW50U3RhdGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLmFnZW50U3RhdGVzOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRSb3V0aW5nUHJvZmlsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5yb3V0aW5nUHJvZmlsZTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5ID0gZnVuY3Rpb24gKGNoYW5uZWwpIHsKICAgIHZhciBjaGFubmVsQ29uY3VycmVuY3lNYXAgPSB0aGlzLmdldFJvdXRpbmdQcm9maWxlKCkuY2hhbm5lbENvbmN1cnJlbmN5TWFwOwogICAgaWYgKCFjaGFubmVsQ29uY3VycmVuY3lNYXApIHsKICAgICAgY2hhbm5lbENvbmN1cnJlbmN5TWFwID0gT2JqZWN0LmtleXMoY29ubmVjdC5DaGFubmVsVHlwZSkucmVkdWNlKGZ1bmN0aW9uIChhY2MsIGtleSkgewogICAgICAgIC8vIEV4Y2x1ZGUgVEFTSyBmcm9tIGRlZmF1bHQgY29uY3VycmVuY3kuCiAgICAgICAgaWYgKGtleSAhPT0gJ1RBU0snKSB7CiAgICAgICAgICBhY2NbY29ubmVjdC5DaGFubmVsVHlwZVtrZXldXSA9IDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhY2M7CiAgICAgIH0sIHt9KTsKICAgIH0KICAgIHJldHVybiBjaGFubmVsCiAgICAgID8gKGNoYW5uZWxDb25jdXJyZW5jeU1hcFtjaGFubmVsXSB8fCAwKQogICAgICA6IGNoYW5uZWxDb25jdXJyZW5jeU1hcDsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0TmFtZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5uYW1lOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFeHRlbnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25maWd1cmF0aW9uKCkuZXh0ZW5zaW9uOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXREaWFsYWJsZUNvdW50cmllcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldENvbmZpZ3VyYXRpb24oKS5kaWFsYWJsZUNvdW50cmllczsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuaXNTb2Z0cGhvbmVFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnNvZnRwaG9uZUVuYWJsZWQ7CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgaWYgKGNvbmZpZ3VyYXRpb24gJiYgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzICYmIGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRSAmJiAhY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSkgewogICAgICAvLyB3b3JrYXJvdW5kIGZvciB0aGUgaW5jb25zaXN0ZW5jeSBpc3N1ZSB0aGF0IGdldEFnZW50Q29uZmlndXJhdGlvbiByZXR1cm5zIGFnZW50UHJlZmVyZW5jZXMuTEFOR1VBR0UgYnV0IHVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbiBleHBlY3RzIGFnZW50UHJlZmVyZW5jZXMubG9jYWxlIHRvIGJlIHNldC4KICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFByZWZlcmVuY2VzLmxvY2FsZSA9IGNvbmZpZ3VyYXRpb24uYWdlbnRQcmVmZXJlbmNlcy5MQU5HVUFHRTsKICAgIH0KCiAgICBpZiAoY29uZmlndXJhdGlvbiAmJiBjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMgJiYgIWNvbm5lY3QuaXNWYWxpZExvY2FsZShjb25maWd1cmF0aW9uLmFnZW50UHJlZmVyZW5jZXMubG9jYWxlKSkgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoY29ubmVjdC5BZ2VudEVycm9yU3RhdGVzLklOVkFMSURfTE9DQUxFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9BR0VOVF9DT05GSUdVUkFUSU9OLCB7CiAgICAgICAgY29uZmlndXJhdGlvbjogY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmZpZ3VyYXRpb24sICdjb25maWd1cmF0aW9uJykKICAgICAgfSwgewogICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgLy8gV2UgbmVlZCB0byBhc2sgdGhlIHNoYXJlZCB3b3JrZXIgdG8gcmVsb2FkIGFnZW50IGNvbmZpZwogICAgICAgICAgICAvLyBvbmNlIHdlIGNoYW5nZSBpdCBzbyBldmVyeSB0YWIgaGFzIGFjY3VyYXRlIGNvbmZpZy4KICAgICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04pOwoKICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgQWdlbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKHN0YXRlLCBjYWxsYmFja3MsIG9wdGlvbnMpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuUFVUX0FHRU5UX1NUQVRFLCB7CiAgICAgIHN0YXRlOiBjb25uZWN0LmFzc2VydE5vdE51bGwoc3RhdGUsICdzdGF0ZScpLAogICAgICBlbnF1ZXVlTmV4dFN0YXRlOiBvcHRpb25zICYmICEhb3B0aW9ucy5lbnF1ZXVlTmV4dFN0YXRlCiAgICB9LCBjYWxsYmFja3MpOwogIH07CiAgQWdlbnQucHJvdG90eXBlLm9uRW5xdWV1ZWROZXh0U3RhdGUgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLkVOUVVFVUVEX05FWFRfU1RBVEUsIGYpOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5zZXRTdGF0dXMgPSBBZ2VudC5wcm90b3R5cGUuc2V0U3RhdGU7CgogIEFnZW50LnByb3RvdHlwZS5jb25uZWN0ID0gZnVuY3Rpb24gKGVuZHBvaW50SW4sIHBhcmFtcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBlbmRwb2ludCA9IG5ldyBjb25uZWN0LkVuZHBvaW50KGVuZHBvaW50SW4pOwogICAgLy8gSGF2ZSB0byByZW1vdmUgdGhlIGVuZHBvaW50SWQgZmllbGQgb3IgQVdTIEpTIFNESyBnZXRzIG1hZC4KICAgIGRlbGV0ZSBlbmRwb2ludC5lbmRwb2ludElkOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DUkVBVEVfT1VUQk9VTkRfQ09OVEFDVCwgewogICAgICBlbmRwb2ludDogY29ubmVjdC5hc3NlcnROb3ROdWxsKGVuZHBvaW50LCAnZW5kcG9pbnQnKSwKICAgICAgcXVldWVBUk46IChwYXJhbXMgJiYgKHBhcmFtcy5xdWV1ZUFSTiB8fCBwYXJhbXMucXVldWVJZCkpIHx8IHRoaXMuZ2V0Um91dGluZ1Byb2ZpbGUoKS5kZWZhdWx0T3V0Ym91bmRRdWV1ZS5xdWV1ZUFSTgogICAgfSwgcGFyYW1zICYmIHsKICAgICAgICBzdWNjZXNzOiBwYXJhbXMuc3VjY2VzcywKICAgICAgICBmYWlsdXJlOiBwYXJhbXMuZmFpbHVyZQogICAgICB9KTsKICB9OwoKICBBZ2VudC5wcm90b3R5cGUuZ2V0QWxsUXVldWVBUk5zID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0Q29uZmlndXJhdGlvbigpLnJvdXRpbmdQcm9maWxlLnF1ZXVlcy5tYXAoZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgIHJldHVybiBxdWV1ZS5xdWV1ZUFSTjsKICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRFbmRwb2ludHMgPSBmdW5jdGlvbiAocXVldWVBUk5zLCBjYWxsYmFja3MsIHBhZ2VJbmZvSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLCAiY2FsbGJhY2tzIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2FsbGJhY2tzLnN1Y2Nlc3MsICJjYWxsYmFja3Muc3VjY2VzcyIpOwogICAgdmFyIHBhZ2VJbmZvID0gcGFnZUluZm9JbiB8fCB7IH07CgogICAgcGFnZUluZm8uZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzIHx8IFtdOwogICAgcGFnZUluZm8ubWF4UmVzdWx0cyA9IHBhZ2VJbmZvLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgYWxsb3dpbmcgYSBzaW5nbGUgcXVldWVBUk4gdG8gYmUgc3BlY2lmaWVkCiAgICAvLyBpbnN0ZWFkIG9mIGFuIGFycmF5LgogICAgaWYgKCFjb25uZWN0LmlzQXJyYXkocXVldWVBUk5zKSkgewogICAgICBxdWV1ZUFSTnMgPSBbcXVldWVBUk5zXTsKICAgIH0KCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX0VORFBPSU5UUywgewogICAgICBxdWV1ZUFSTnM6IHF1ZXVlQVJOcywKICAgICAgbmV4dFRva2VuOiBwYWdlSW5mby5uZXh0VG9rZW4gfHwgbnVsbCwKICAgICAgbWF4UmVzdWx0czogcGFnZUluZm8ubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5nZXRFbmRwb2ludHMocXVldWVBUk5zLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhZ2VJbmZvLm1heFJlc3VsdHMsCiAgICAgICAgICAgICAgZW5kcG9pbnRzOiBwYWdlSW5mby5lbmRwb2ludHMuY29uY2F0KGRhdGEuZW5kcG9pbnRzKQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZ2VJbmZvLmVuZHBvaW50cyA9IHBhZ2VJbmZvLmVuZHBvaW50cy5jb25jYXQoZGF0YS5lbmRwb2ludHMpOwogICAgICAgICAgICB2YXIgZW5kcG9pbnRzID0gcGFnZUluZm8uZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHsKICAgICAgICAgICAgICBlbmRwb2ludHM6IGVuZHBvaW50cywKICAgICAgICAgICAgICBhZGRyZXNzZXM6IGVuZHBvaW50cwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcy5mYWlsdXJlCiAgICAgIH0pOwogIH07CgogIEFnZW50LnByb3RvdHlwZS5nZXRBZGRyZXNzZXMgPSBBZ2VudC5wcm90b3R5cGUuZ2V0RW5kcG9pbnRzOwoKICAvL0ludGVybmFsIGlkZW50aWZpZXIuCiAgQWdlbnQucHJvdG90eXBlLl9nZXRSZXNvdXJjZUlkID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcXVldWVBcm5zID0gdGhpcy5nZXRBbGxRdWV1ZUFSTnMoKTsKICAgIGZvciAobGV0IHF1ZXVlQXJuIG9mIHF1ZXVlQXJucykgewogICAgICBjb25zdCBhZ2VudElkTWF0Y2ggPSBxdWV1ZUFybi5tYXRjaCgvXC9hZ2VudFwvKFteL10rKS8pOwoKICAgICAgaWYgKGFnZW50SWRNYXRjaCkgewogICAgICAgIHJldHVybiBhZ2VudElkTWF0Y2hbMV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgRXJyb3IoIkFnZW50LnByb3RvdHlwZS5fZ2V0UmVzb3VyY2VJZDogcXVldWVBcm5zIGRpZCBub3QgY29udGFpbiBhZ2VudFJlc291cmNlSWQ6ICIsIHF1ZXVlQXJucyk7CiAgfQoKICBBZ2VudC5wcm90b3R5cGUudG9TbmFwc2hvdCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5BZ2VudFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQWdlbnRTbmFwc2hvdAogICAqLwogIHZhciBBZ2VudFNuYXBzaG90ID0gZnVuY3Rpb24gKGFnZW50RGF0YSkgewogICAgY29ubmVjdC5BZ2VudC5jYWxsKHRoaXMpOwogICAgdGhpcy5hZ2VudERhdGEgPSBhZ2VudERhdGE7CiAgfTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQWdlbnQucHJvdG90eXBlKTsKICBBZ2VudFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFnZW50U25hcHNob3Q7CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9nZXREYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuYWdlbnREYXRhOwogIH07CgogIEFnZW50U25hcHNob3QucHJvdG90eXBlLl9jcmVhdGVDb250YWN0QVBJID0gZnVuY3Rpb24gKGNvbnRhY3REYXRhKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KGNvbnRhY3REYXRhKTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBDb250YWN0CiAgICovCiAgdmFyIENvbnRhY3QgPSBmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICB0aGlzLmNvbnRhY3RJZCA9IGNvbnRhY3RJZDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmdldENvbnRhY3RJZCgpKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5fY3JlYXRlQ29ubmVjdGlvbkFQSSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgaWYgKHRoaXMuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgcmV0dXJuIG5ldyBjb25uZWN0LkNoYXRDb25uZWN0aW9uKHRoaXMuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgfSBlbHNlIGlmICh0aGlzLmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbih0aGlzLmNvbnRhY3RJZCwgY29ubmVjdGlvbkRhdGEuY29ubmVjdGlvbklkKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24odGhpcy5jb250YWN0SWQsIGNvbm5lY3Rpb25EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICB9CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGV2ZW50TmFtZSwgdGhpcy5nZXRDb250YWN0SWQoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25SZWZyZXNoID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkluY29taW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLklOQ09NSU5HKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0aW5nID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkNPTk5FQ1RJTkcpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vblBlbmRpbmcgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuUEVORElORyksIGYpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLm9uQWNjZXB0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbk1pc3NlZCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5NSVNTRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkVuZGVkID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUodGhpcy5nZXRFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLkVOREVEKSwgZik7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQpLCBmKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuREVTVFJPWUVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25BQ1cgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNXKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25Db25uZWN0ZWQgPSBmdW5jdGlvbiAoZikgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnN1YnNjcmliZSh0aGlzLmdldEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQ09OTkVDVEVEKSwgZik7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKHRoaXMuZ2V0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUiksIGYpOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5pbml0aWFsQ29udGFjdElkOwogIH07CiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0SW5pdGlhbENvbnRhY3RJZCA9IENvbnRhY3QucHJvdG90eXBlLmdldE9yaWdpbmFsQ29udGFjdElkOwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3REdXJhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0RHVyYXRpb247CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc3RhdGU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdHVzID0gQ29udGFjdC5wcm90b3R5cGUuZ2V0U3RhdGU7CgogIENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5ub3coKSAtIHRoaXMuX2dldERhdGEoKS5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpICsgY29ubmVjdC5jb3JlLmdldFNrZXcoKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRTdGF0dXNEdXJhdGlvbiA9IENvbnRhY3QucHJvdG90eXBlLmdldFN0YXRlRHVyYXRpb247CgogIENvbnRhY3QucHJvdG90eXBlLmdldFF1ZXVlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWV1ZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRRdWV1ZVRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucXVldWVUaW1lc3RhbXA7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmNvbm5lY3Rpb25zLm1hcChmdW5jdGlvbiAoY29ubkRhdGEpIHsKICAgICAgaWYgKHNlbGYuZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbnRhY3RUeXBlLkNIQVQpIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ2hhdENvbm5lY3Rpb24oc2VsZi5jb250YWN0SWQsIGNvbm5EYXRhLmNvbm5lY3Rpb25JZCk7CiAgICAgIH0gZWxzZSBpZiAoc2VsZi5nZXRUeXBlKCkgPT09IGNvbm5lY3QuQ29udGFjdFR5cGUuVEFTSykgewogICAgICAgIHJldHVybiBuZXcgY29ubmVjdC5UYXNrQ29ubmVjdGlvbihzZWxmLmNvbnRhY3RJZCwgY29ubkRhdGEuY29ubmVjdGlvbklkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IGNvbm5lY3QuVm9pY2VDb25uZWN0aW9uKHNlbGYuY29udGFjdElkLCBjb25uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgICB9CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRJbml0aWFsQ29ubmVjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5pc0luaXRpYWxDb25uZWN0aW9uKCk7CiAgICB9KSB8fCBudWxsOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldEFjdGl2ZUluaXRpYWxDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGluaXRpYWxDb25uID0gdGhpcy5nZXRJbml0aWFsQ29ubmVjdGlvbigpOwogICAgaWYgKGluaXRpYWxDb25uICE9IG51bGwgJiYgaW5pdGlhbENvbm4uaXNBY3RpdmUoKSkgewogICAgICByZXR1cm4gaW5pdGlhbENvbm47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRDb25uZWN0aW9ucygpLmZpbHRlcihmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gIWNvbm4uaXNJbml0aWFsQ29ubmVjdGlvbigpICYmIGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UOwogICAgfSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0U2luZ2xlQWN0aXZlVGhpcmRQYXJ0eUNvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5nZXRUaGlyZFBhcnR5Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uaXNBY3RpdmUoKTsKICAgIH0pWzBdIHx8IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0QWdlbnRDb25uZWN0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuZmluZCh0aGlzLmdldENvbm5lY3Rpb25zKCksIGZ1bmN0aW9uIChjb25uKSB7CiAgICAgIHZhciBjb25uVHlwZSA9IGNvbm4uZ2V0VHlwZSgpOwogICAgICByZXR1cm4gY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuQUdFTlQgfHwgY29ublR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblR5cGUuTU9OSVRPUklORzsKICAgIH0pOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldE5hbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLm5hbWU7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0Q29udGFjdE1ldGFkYXRhID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jb250YWN0TWV0YWRhdGE7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5nZXREZXNjcmlwdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuZGVzY3JpcHRpb247CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuZ2V0UmVmZXJlbmNlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkucmVmZXJlbmNlczsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5hdHRyaWJ1dGVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENvbnRhY3RGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuY29udGFjdEZlYXR1cmVzOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmdldENoYW5uZWxDb250ZXh0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5jaGFubmVsQ29udGV4dDsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc1NvZnRwaG9uZUNhbGwgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0Q29ubmVjdGlvbnMoKSwgZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm4uZ2V0U29mdHBob25lTWVkaWFJbmZvKCkgIT0gbnVsbDsKICAgIH0pICE9IG51bGw7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuX2lzSW5ib3VuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbml0aWF0aW9uTWV0aG9kID0gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYXRpb25NZXRob2Q7CiAgICByZXR1cm4gKGluaXRpYXRpb25NZXRob2QgPT09IGNvbm5lY3QuQ29udGFjdEluaXRpYXRpb25NZXRob2QuT1VUQk9VTkQpID8gZmFsc2UgOiB0cnVlOwogIH0KCiAgQ29udGFjdC5wcm90b3R5cGUuaXNJbmJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbm4gPSB0aGlzLmdldEluaXRpYWxDb25uZWN0aW9uKCk7CgogICAgLy8gV2Ugd2lsbCBncmFkdWFsbHkgY2hhbmdlIGNoZWNraW5nIGluYm91bmQgYnkgcmVseWluZyBvbiBjb250YWN0IGluaXRpYXRpb25NZXRob2QKICAgIGlmIChjb25uLmdldE1lZGlhVHlwZSgpID09PSBjb25uZWN0Lk1lZGlhVHlwZS5UQVNLKSB7CiAgICAgIHJldHVybiB0aGlzLl9pc0luYm91bmQoKTsKICAgIH0KCiAgICByZXR1cm4gY29ubiA/IGNvbm4uZ2V0VHlwZSgpID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLklOQk9VTkQgOiBmYWxzZTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQ7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuYWNjZXB0ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjb250YWN0SWQgPSB0aGlzLmdldENvbnRhY3RJZCgpOwoKICAgIGNvbm5lY3QucHVibGlzaENsaWNrU3RyZWFtRGF0YSh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2xpY2tUeXBlOiBjb25uZWN0LkNsaWNrVHlwZS5BQ0NFUFQsCiAgICAgIGNsaWNrVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICB9KTsKCiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuQUNDRVBUX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiBjb250YWN0SWQKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLkFDQ0VQVEVELAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwogICAgICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIHNlbGYuZ2V0Q29udGFjdElkKCkpLAogICAgICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3RJZCkKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIEluIEZpcmVmb3gsIHRoZXJlJ3MgYSBicm93c2VyIHJlc3RyaWN0aW9uIHRoYXQgYW4gdW5mb2N1c2VkIGJyb3dzZXIgdGFiIGlzIG5vdCBhbGxvd2VkIHRvIGFjY2VzcyB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICAvLyBUaGUgcHJvYmxlbSBpcyB0aGF0IHRoZSByZXN0cmljdGlvbiBjb3VsZCBjYXVzZSBhIHdlYnJ0YyBzZXNzaW9uIGNyZWF0aW9uIHRpbWVvdXQgZXJyb3Igd2hlbiB5b3UgZ2V0IGFuIGluY29taW5nIGNhbGwgd2hpbGUgeW91IGFyZSBub3Qgb24gdGhlIHByaW1hcnkgdGFiLgogICAgICAgICAgLy8gSXQgd2FzIGhhcmQgdG8gd29ya2Fyb3VuZCB0aGUgaXNzdWUgZXNwZWNpYWxseSB3aGVuIHlvdSBoYXZlIG11bHRpcGxlIHRhYnMgb3BlbiBiZWNhdXNlIHlvdSBuZWVkZWQgdG8gZmluZCB0aGUgcmlnaHQgdGFiIGFuZCBhY2NlcHQgdGhlIGNvbnRhY3QgYmVmb3JlIHRoZSB0aW1lb3V0LgogICAgICAgICAgLy8gVG8gYXZvaWQgdGhlIGVycm9yLCB3aGVuIG11bHRpcGxlIHRhYnMgYXJlIG9wZW4gaW4gRmlyZWZveCwgYSB3ZWJydGMgc2Vzc2lvbiBpcyBub3QgaW1tZWRpYXRlbHkgY3JlYXRlZCBhcyBhbiBpbmNvbWluZyBzb2Z0cGhvbmUgY29udGFjdCBpcyBkZXRlY3RlZC4KICAgICAgICAgIC8vIEluc3RlYWQsIGl0IHdhaXRzIHVudGlsIGNvbnRhY3QuYWNjZXB0KCkgaXMgY2FsbGVkIG9uIGEgdGFiIGFuZCBsZXRzIHRoZSB0YWIgYmVjb21lIHRoZSBuZXcgcHJpbWFyeSB0YWIgYW5kIHN0YXJ0IHRoZSB3ZWIgcnRjIHNlc3Npb24gdGhlcmUKICAgICAgICAgIC8vIGJlY2F1c2UgdGhlIHRhYiBzaG91bGQgYmUgZm9jdXNlZCBhdCB0aGUgbW9tZW50IGFuZCBoYXZlIGFjY2VzcyB0byB0aGUgdXNlcidzIG1pY3JvcGhvbmUuCiAgICAgICAgICB2YXIgY29udGFjdCA9IG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKTsKICAgICAgICAgIGlmIChjb25uZWN0LmlzRmlyZWZveEJyb3dzZXIoKSAmJiBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpKSB7CiAgICAgICAgICAgIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50KCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGNhbGxiYWNrcyA/IGNhbGxiYWNrcy5mYWlsdXJlIDogbnVsbAogICAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJjb250YWN0LmRlc3Ryb3koKSBoYXMgYmVlbiBkZXByZWNhdGVkLiIpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIChjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CgogICAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjbGlja1R5cGU6IGNvbm5lY3QuQ2xpY2tUeXBlLlJFSkVDVCwKICAgICAgY2xpY2tUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH0pOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5SRUpFQ1RfQ09OVEFDVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCkKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuY29tcGxldGUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTVBMRVRFX0NPTlRBQ1QsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DTEVBUl9DT05UQUNULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5ub3RpZnlJc3N1ZSA9IGZ1bmN0aW9uIChpc3N1ZUNvZGUsIGRlc2NyaXB0aW9uLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuTk9USUZZX0NPTlRBQ1RfSVNTVUUsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBpc3N1ZUNvZGU6IGlzc3VlQ29kZSwKICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLmFkZENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoZW5kcG9pbnRJbiwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGVuZHBvaW50ID0gbmV3IGNvbm5lY3QuRW5kcG9pbnQoZW5kcG9pbnRJbik7CiAgICAvLyBIYXZlIHRvIHJlbW92ZSB0aGUgZW5kcG9pbnRJZCBmaWVsZCBvciBBV1MgSlMgU0RLIGdldHMgbWFkLgogICAgZGVsZXRlIGVuZHBvaW50LmVuZHBvaW50SWQ7CgogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9BRERJVElPTkFMX0NPTk5FQ1RJT04sIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBlbmRwb2ludDogZW5kcG9pbnQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUudG9nZ2xlQWN0aXZlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB2YXIgaG9sZGluZ0Nvbm4gPSBjb25uZWN0LmZpbmQodGhpcy5nZXRDb25uZWN0aW9ucygpLCBmdW5jdGlvbiAoY29ubikgewogICAgICByZXR1cm4gY29ubi5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRDsKICAgIH0pOwoKICAgIGlmIChob2xkaW5nQ29ubiAhPSBudWxsKSB7CiAgICAgIGNvbm5lY3Rpb25JZCA9IGhvbGRpbmdDb25uLmdldENvbm5lY3Rpb25JZCgpOwoKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhY3RpdmVDb25ucyA9IHRoaXMuZ2V0Q29ubmVjdGlvbnMoKS5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgICByZXR1cm4gY29ubi5pc0FjdGl2ZSgpOwogICAgICB9KTsKICAgICAgaWYgKGFjdGl2ZUNvbm5zLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25uZWN0aW9uSWQgPSBhY3RpdmVDb25uc1swXS5nZXRDb25uZWN0aW9uSWQoKTsKICAgICAgfQogICAgfQoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5UT0dHTEVfQUNUSVZFX0NPTk5FQ1RJT05TLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiBjb25uZWN0aW9uSWQKICAgIH0sIGNhbGxiYWNrcyk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuc2VuZFNvZnRwaG9uZU1ldHJpY3MgPSBmdW5jdGlvbiAoc29mdHBob25lU3RyZWFtU3RhdGlzdGljcywgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwoKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5TRU5EX1NPRlRQSE9ORV9DQUxMX01FVFJJQ1MsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjY3BWZXJzaW9uOiBnbG9iYWwuY2NwVmVyc2lvbiwKICAgICAgc29mdHBob25lU3RyZWFtU3RhdGlzdGljczogc29mdHBob25lU3RyZWFtU3RhdGlzdGljcwogICAgfSwgY2FsbGJhY2tzKTsKCiAgICBjb25uZWN0LnB1Ymxpc2hTb2Z0cGhvbmVTdGF0cyh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHN0YXRzOiBzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzCiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5zZW5kU29mdHBob25lUmVwb3J0ID0gZnVuY3Rpb24gKHJlcG9ydCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfUkVQT1JULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9LCBjYWxsYmFja3MpOwoKICAgIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVJlcG9ydCh7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY2NwVmVyc2lvbjogZ2xvYmFsLmNjcFZlcnNpb24sCiAgICAgIHJlcG9ydDogcmVwb3J0CiAgICB9KTsKICB9OwoKICBDb250YWN0LnByb3RvdHlwZS5jb25mZXJlbmNlQ29ubmVjdGlvbnMgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNPTkZFUkVOQ0VfQ09OTkVDVElPTlMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbnRhY3QucHJvdG90eXBlLnRvU25hcHNob3QgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29udGFjdFNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgQ29udGFjdC5wcm90b3R5cGUuaXNNdWx0aVBhcnR5Q29uZmVyZW5jZUVuYWJsZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29udGFjdEZlYXR1cmVzID0gdGhpcy5nZXRDb250YWN0RmVhdHVyZXMoKTsKICAgIHJldHVybiAhIShjb250YWN0RmVhdHVyZXMgJiYgY29udGFjdEZlYXR1cmVzLm11bHRpUGFydHlDb25mZXJlbmNlRW5hYmxlZCk7CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS51cGRhdGVNb25pdG9yUGFydGljaXBhbnRTdGF0ZSA9IGZ1bmN0aW9uICh0YXJnZXRTdGF0ZSwgY2FsbGJhY2tzKSB7CiAgICBpZighdGFyZ2V0U3RhdGUgfHwgIU9iamVjdC52YWx1ZXMoY29ubmVjdC5Nb25pdG9yaW5nTW9kZSkuaW5jbHVkZXModGFyZ2V0U3RhdGUudG9VcHBlckNhc2UoKSkpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcihgSW52YWxpZCB0YXJnZXQgc3RhdGUgd2FzIHByb3ZpZGVkOiAke3RhcmdldFN0YXRlfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGlmIChjYWxsYmFja3MgJiYgY2FsbGJhY2tzLmZhaWx1cmUpIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShjb25uZWN0Lk1vbml0b3JpbmdFcnJvclR5cGVzLklOVkFMSURfVEFSR0VUX1NUQVRFKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVQREFURV9NT05JVE9SX1BBUlRJQ0lQQU5UX1NUQVRFLCB7CiAgICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICAgIHRhcmdldE1vbml0b3JNb2RlOiB0YXJnZXRTdGF0ZS50b1VwcGVyQ2FzZSgpCiAgICAgIH0sIGNhbGxiYWNrcyk7CiAgICB9CiAgfQoKICBDb250YWN0LnByb3RvdHlwZS5pc1VuZGVyU3VwZXJ2aXNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbm9uQWdlbnRDb25uZWN0aW9ucyA9IHRoaXMuZ2V0Q29ubmVjdGlvbnMoKS5maWx0ZXIoKGNvbm4pID0+IGNvbm4uZ2V0VHlwZSgpICE9PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UKTsKICAgIHZhciBzdXBlcnZpc29yQ29ubmVjdGlvbiA9IG5vbkFnZW50Q29ubmVjdGlvbnMgJiYgbm9uQWdlbnRDb25uZWN0aW9ucy5maW5kKGNvbm4gPT4gY29ubi5nZXRTdGF0ZSgpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5CQVJHRSk7CiAgICByZXR1cm4gc3VwZXJ2aXNvckNvbm5lY3Rpb24gIT09IHVuZGVmaW5lZDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbnRhY3RTbmFwc2hvdAogICAqLwogIHZhciBDb250YWN0U25hcHNob3QgPSBmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgIGNvbm5lY3QuQ29udGFjdC5jYWxsKHRoaXMsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB0aGlzLmNvbnRhY3REYXRhID0gY29udGFjdERhdGE7CiAgfTsKICBDb250YWN0U25hcHNob3QucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb250YWN0LnByb3RvdHlwZSk7CiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IENvbnRhY3RTbmFwc2hvdDsKCiAgQ29udGFjdFNuYXBzaG90LnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbnRhY3REYXRhOwogIH07CgogIENvbnRhY3RTbmFwc2hvdC5wcm90b3R5cGUuX2NyZWF0ZUNvbm5lY3Rpb25BUEkgPSBmdW5jdGlvbiAoY29ubmVjdGlvbkRhdGEpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5Db25uZWN0aW9uU25hcHNob3QoY29ubmVjdGlvbkRhdGEpOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIENvbm5lY3Rpb24KICAgKi8KICB2YXIgQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdGhpcy5jb250YWN0SWQgPSBjb250YWN0SWQ7CiAgICB0aGlzLmNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb25JZDsKICAgIHRoaXMuX2luaXRNZWRpYUNvbnRyb2xsZXIoKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5fZ2V0RGF0YSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb25uZWN0aW9uRGF0YSgKICAgICAgdGhpcy5nZXRDb250YWN0SWQoKSwgdGhpcy5nZXRDb25uZWN0aW9uSWQoKSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29udGFjdElkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuY29udGFjdElkOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldENvbm5lY3Rpb25JZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmNvbm5lY3Rpb25JZDsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBuZXcgY29ubmVjdC5FbmRwb2ludCh0aGlzLl9nZXREYXRhKCkuZW5kcG9pbnQpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldEFkZHJlc3MgPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRFbmRwb2ludDsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLnN0YXRlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXR1cyA9IENvbm5lY3Rpb24ucHJvdG90eXBlLmdldFN0YXRlOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Qubm93KCkgLSB0aGlzLl9nZXREYXRhKCkuc3RhdGUudGltZXN0YW1wLmdldFRpbWUoKSArIGNvbm5lY3QuY29yZS5nZXRTa2V3KCk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U3RhdHVzRHVyYXRpb24gPSBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRTdGF0ZUR1cmF0aW9uOwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS50eXBlOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzSW5pdGlhbENvbm5lY3Rpb24gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZ2V0RGF0YSgpLmluaXRpYWw7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNBY3RpdmUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb250YWlucyhjb25uZWN0LkNPTk5FQ1RJT05fQUNUSVZFX1NUQVRFUywgdGhpcy5nZXRTdGF0dXMoKS50eXBlKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5pc0Nvbm5lY3RlZCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvbnRhaW5zKGNvbm5lY3QuQ09OTkVDVElPTl9DT05ORUNURURfU1RBVEVTLCB0aGlzLmdldFN0YXR1cygpLnR5cGUpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzQ29ubmVjdGluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5DT05ORUNUSU5HOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmlzT25Ib2xkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkhPTEQ7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0U29mdHBob25lTWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zb2Z0cGhvbmVNZWRpYUluZm87CiAgfTsKCiAgLyoqCiAgICogR2V0cyB0aGUgY3VycmVudGx5IG1vbml0b3JlZCBjb250YWN0IGluZm8sIFJldHVybnMgbnVsbCBpZiBkb2VzIG5vdCBleGlzdHMuCiAgICogQHJldHVybiB7e2FnZW50TmFtZTpzdHJpbmcsIGN1c3RvbWVyTmFtZTpzdHJpbmcsIGpvaW5UaW1lOkRhdGV9fQogICAqLwogIENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1vbml0b3JJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5tb25pdG9yaW5nSW5mbzsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgY29ubmVjdC5wdWJsaXNoQ2xpY2tTdHJlYW1EYXRhKHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjbGlja1R5cGU6IGNvbm5lY3QuQ2xpY2tUeXBlLkhBTkdVUCwKICAgICAgY2xpY2tUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkKICAgIH0pOwoKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuREVTVFJPWV9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLnNlbmREaWdpdHMgPSBmdW5jdGlvbiAoZGlnaXRzLCBjYWxsYmFja3MpIHsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9ESUdJVFMsIHsKICAgICAgY29udGFjdElkOiB0aGlzLmdldENvbnRhY3RJZCgpLAogICAgICBjb25uZWN0aW9uSWQ6IHRoaXMuZ2V0Q29ubmVjdGlvbklkKCksCiAgICAgIGRpZ2l0czogZGlnaXRzCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLmhvbGQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkhPTERfQ09OTkVDVElPTiwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBDb25uZWN0aW9uLnByb3RvdHlwZS5yZXN1bWUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlJFU1VNRV9DT05ORUNUSU9OLCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIENvbm5lY3Rpb24ucHJvdG90eXBlLnRvU25hcHNob3QgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IGNvbm5lY3QuQ29ubmVjdGlvblNuYXBzaG90KHRoaXMuX2dldERhdGEoKSk7CiAgfTsKCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2luaXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5nZXRNZWRpYUluZm8oKSkgewogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5LmdldCh0aGlzKS5jYXRjaChmdW5jdGlvbiAoKSB7IH0pOwogICAgfQogIH0KCiAgLy8gTWV0aG9kIGZvciBjaGVja2luZyB3aGV0aGVyIHRoaXMgY29ubmVjdGlvbiBpcyBhbiBhZ2VudC1zaWRlIGNvbm5lY3Rpb24KICAvLyAodHlwZSBBR0VOVCBvciBNT05JVE9SSU5HKQogIENvbm5lY3Rpb24ucHJvdG90eXBlLl9pc0FnZW50Q29ubmVjdGlvblR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY29ubmVjdGlvblR5cGUgPSB0aGlzLmdldFR5cGUoKTsKICAgIHJldHVybiBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5BR0VOVAogICAgICB8fCBjb25uZWN0aW9uVHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uVHlwZS5NT05JVE9SSU5HOwogIH0KCiAgLyoqCiAgICogVXRpbGl0eSBtZXRob2QgZm9yIGNoZWNraW5nIHdoZXRoZXIgdGhpcyBjb25uZWN0aW9uIGlzIGFuIGFnZW50LXNpZGUgY29ubmVjdGlvbgogICAqICh0eXBlIEFHRU5UIG9yIE1PTklUT1JJTkcpCiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGlzIGNvbm5lY3Rpb24gaXMgYW4gYWdlbnQtc2lkZSBjb25uZWN0aW9uLiBGYWxzZSBvdGhlcndpc2UuCiAgICovCiAgQ29ubmVjdGlvbi5wcm90b3R5cGUuX2lzQWdlbnRDb25uZWN0aW9uVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBjb25uZWN0aW9uVHlwZSA9IHRoaXMuZ2V0VHlwZSgpOwogICAgcmV0dXJuIGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLkFHRU5UCiAgICAgIHx8IGNvbm5lY3Rpb25UeXBlID09PSBjb25uZWN0LkNvbm5lY3Rpb25UeXBlLk1PTklUT1JJTkc7CiAgfQogIAogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogQ29udGFjdCByZWNvcmRpbmcKICAqLwoKICB2YXIgQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHRoaXMuY29udGFjdElkID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEoY29udGFjdElkKSA/IGNvbnRhY3RJZCA6IG51bGw7CiAgfQoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5zdGFydENvbnRhY3RSZWNvcmRpbmcgPSBmdW5jdGlvbih0cmFja0NvbmZpZykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCwgY29udGFjdERhdGE7CgogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCk7CiAgICB2YXIgcmVjb3JkaW5nVHJhY2sgPSAodHJhY2tDb25maWcgJiYgT2JqZWN0LnZhbHVlcyhjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnKS5pbmNsdWRlcyh0cmFja0NvbmZpZykpID8gdHJhY2tDb25maWcgOiBjb25uZWN0LkNvbnRhY3RSZWNvcmRpbmdWb2ljZVRyYWNrQ29uZmlnLkFMTDsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNUQVJUX0NPTlRBQ1RfUkVDT1JESU5HLCB7CiAgICAgICAgImluaXRpYWxDb250YWN0SWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHNlbGYuY29udGFjdElkLAogICAgICAgICJjb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiaW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAidm9pY2VSZWNvcmRpbmdDb25maWd1cmF0aW9uIjogewogICAgICAgICAgInZvaWNlUmVjb3JkaW5nVHJhY2siOiByZWNvcmRpbmdUcmFjawogICAgICAgIH0KICAgICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN0YXJ0Q29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN0YXJ0Q29udGFjdFJlY29yZGluZyBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnIsCiAgICAgICAgICAgICAgZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigic3RhcnRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIsIHsgY2F1c2U6IGVyciB9KSk7CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9OwoKICBDb250YWN0UmVjb3JkaW5nLnByb3RvdHlwZS5zdG9wQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCwgY29udGFjdERhdGE7CgogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5TVE9QX0NPTlRBQ1RfUkVDT1JESU5HLCB7CiAgICAgICAgImluaXRpYWxDb250YWN0SWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHNlbGYuY29udGFjdElkLAogICAgICAgICJjb250YWN0SWQiOiBzZWxmLmNvbnRhY3RJZCwKICAgICAgICAiaW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKQogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygic3RvcENvbnRhY3RSZWNvcmRpbmcgc3VjY2VlZGVkIikKICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdG9wQ29udGFjdFJlY29yZGluZyBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnIsCiAgICAgICAgICAgICAgZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigic3RvcENvbnRhY3RSZWNvcmRpbmcgZmFpbGVkIiwgeyBjYXVzZTogZXJyIH0pKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH07CgogIENvbnRhY3RSZWNvcmRpbmcucHJvdG90eXBlLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50LCBjb250YWN0RGF0YTsKCiAgICBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLlNVU1BFTkRfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJzdXNwZW5kQ29udGFjdFJlY29yZGluZyBzdWNjZWVkZWQiKQogICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN1c3BlbmRDb250YWN0UmVjb3JkaW5nIGZhaWxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVyciwKICAgICAgICAgICAgICBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KEVycm9yKCJzdXNwZW5kQ29udGFjdFJlY29yZGluZyBmYWlsZWQiLCB7IGNhdXNlOiBlcnIgfSkpOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKCiAgQ29udGFjdFJlY29yZGluZy5wcm90b3R5cGUucmVzdW1lQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCwgY29udGFjdERhdGE7CgogICAgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YShzZWxmLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5SRVNVTUVfQ09OVEFDVF9SRUNPUkRJTkcsIHsKICAgICAgICAiaW5pdGlhbENvbnRhY3RJZCI6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgc2VsZi5jb250YWN0SWQsCiAgICAgICAgImNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJpbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpCiAgICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJyZXN1bWVDb250YWN0UmVjb3JkaW5nIHN1Y2NlZWRlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigicmVzdW1lQ29udGFjdFJlY29yZGluZyBmYWlsZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnIsCiAgICAgICAgICAgICAgZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigicmVzdW1lQ29udGFjdFJlY29yZGluZyBmYWlsZWQiKSwgeyBjYXVzZTogZXJyIH0pOwogICAgICAgIH0KICAgICAgfSkKICAgIH0pCiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBWb2ljZSBhdXRoZW50aWNhdG9yIFZvaWNlSWQKICAqLwoKICB2YXIgVm9pY2VJZCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHRoaXMuY29udGFjdElkID0gY29udGFjdElkOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmdldFNwZWFrZXJJZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgImluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgImF3c0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpCiAgICAgIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0U3BlYWtlcklkIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5HRVRfQ09OVEFDVCwgcGFyYW1zLCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICBpZihkYXRhLmNvbnRhY3REYXRhLmN1c3RvbWVySWQpIHsKICAgICAgICAgICAgICB2YXIgb2JqID0gewogICAgICAgICAgICAgICAgc3BlYWtlcklkOiBkYXRhLmNvbnRhY3REYXRhLmN1c3RvbWVySWQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRTcGVha2VySWQgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHJlc29sdmUob2JqKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLk5PX1NQRUFLRVJfSURfRk9VTkQsICJObyBzcGVha2VySWQgYXNzb3RpYXRlZCB3aXRoIHRoaXMgY2FsbCIpOwogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJHZXQgU3BlYWtlcklkIGZhaWxlZCIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgZXJyOiBlcnIKICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9TUEVBS0VSX0lEX0ZBSUxFRCwgIkdldCBTcGVha2VySWQgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmdldFNwZWFrZXJTdGF0dXMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChkYXRhLnNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICAgICAiRG9tYWluSWQiIDogZG9tYWluSWQKICAgICAgICAgIH07CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImdldFNwZWFrZXJTdGF0dXMgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5ERVNDUklCRV9TUEVBS0VSLCBwYXJhbXMsIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRTcGVha2VyU3RhdHVzIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3I7CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgICAgc3dpdGNoKHBhcnNlZEVyci5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gcGFyc2VkRXJyOwogICAgICAgICAgICAgICAgICAgIGRhdGEudHlwZSA9IGRhdGEudHlwZSA/IGRhdGEudHlwZSA6IGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1BFQUtFUl9JRF9OT1RfRU5ST0xMRUQ7CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJTcGVha2VyIGlzIG5vdCBlbnJvbGxlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0U3BlYWtlclN0YXR1cyBmYWlsZWQiKQogICAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9TUEVBS0VSX1NUQVRVU19GQUlMRUQsICJHZXQgU3BlYWtlclN0YXR1cyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIGludGVybmFsIG9ubHkKICBWb2ljZUlkLnByb3RvdHlwZS5fb3B0T3V0U3BlYWtlckluTGNtcyA9IGZ1bmN0aW9uIChzcGVha2VySWQsIGdlbmVyYXRlZFNwZWFrZXJJZCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAiQ29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgIkFXU0FjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpLAogICAgICAgICJDdXN0b21lcklkIjogY29ubmVjdC5hc3NlcnROb3ROdWxsKHNwZWFrZXJJZCwgJ3NwZWFrZXJJZCcpLAogICAgICAgICJWb2ljZUlkUmVzdWx0IjogewogICAgICAgICAgIlNwZWFrZXJPcHRlZE91dCI6IHRydWUsCiAgICAgICAgICAiZ2VuZXJhdGVkU3BlYWtlcklkIjogZ2VuZXJhdGVkU3BlYWtlcklkCiAgICAgICAgfQogICAgICB9OwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIl9vcHRPdXRTcGVha2VySW5MY21zIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5VUERBVEVfVk9JQ0VfSURfREFUQSwgcGFyYW1zLCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIm9wdE91dFNwZWFrZXJJbkxjbXMgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigib3B0T3V0U3BlYWtlckluTGNtcyBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5PUFRfT1VUX1NQRUFLRVJfSU5fTENNU19GQUlMRUQsICJvcHRPdXRTcGVha2VySW5MY21zIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLm9wdE91dFNwZWFrZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICAgIHZhciBzcGVha2VySWQgPSBkYXRhLnNwZWFrZXJJZDsKICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICB9OwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJvcHRPdXRTcGVha2VyIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuT1BUX09VVF9TUEVBS0VSLCBwYXJhbXMsIHsKICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgc2VsZi5fb3B0T3V0U3BlYWtlckluTGNtcyhzcGVha2VySWQsIGRhdGEuZ2VuZXJhdGVkU3BlYWtlcklkKS5jYXRjaChmdW5jdGlvbigpe30pOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJvcHRPdXRTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJvcHRPdXRTcGVha2VyIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuT1BUX09VVF9TUEVBS0VSX0ZBSUxFRCwgIm9wdE91dFNwZWFrZXIgZmFpbGVkLiIsIGVycik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5kZWxldGVTcGVha2VyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXRTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHNlbGYuZ2V0RG9tYWluSWQoKS50aGVuKGZ1bmN0aW9uKGRvbWFpbklkKSB7CiAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAgICJTcGVha2VySWQiOiBjb25uZWN0LmFzc2VydE5vdE51bGwoZGF0YS5zcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICB9OwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJkZWxldGVTcGVha2VyIGNhbGxlZCIpLndpdGhPYmplY3QocGFyYW1zKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuREVMRVRFX1NQRUFLRVIsIHBhcmFtcywgewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlbGV0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImRlbGV0ZVNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5ERUxFVEVfU1BFQUtFUl9GQUlMRUQsICJkZWxldGVTcGVha2VyIGZhaWxlZC4iLCBlcnIpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgcmVqZWN0KGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgVm9pY2VJZC5wcm90b3R5cGUuc3RhcnRTZXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgICAiY29udGFjdElkIjogc2VsZi5jb250YWN0SWQsCiAgICAgICAgICAiaW5zdGFuY2VJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEluc3RhbmNlSWQoKSwKICAgICAgICAgICJjdXN0b21lckFjY291bnRJZCI6IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFXU0FjY291bnRJZCgpLAogICAgICAgICAgImNsaWVudFRva2VuIjogQVdTLnV0aWwudXVpZC52NCgpLAogICAgICAgICAgImRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgfTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInN0YXJ0U2Vzc2lvbiBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5TVEFSVF9WT0lDRV9JRF9TRVNTSU9OLCBwYXJhbXMsIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBpZihkYXRhLnNlc3Npb25JZCkgewogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRWb2ljZUlkU2Vzc2lvbiBmYWlsZWQsIG5vIHNlc3Npb24gaWQgcmV0dXJuZWQiKQogICAgICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5TVEFSVF9TRVNTSU9OX0ZBSUxFRCwgIk5vIHNlc3Npb24gaWQgcmV0dXJuZWQgZnJvbSBzdGFydCBzZXNzaW9uIGFwaSIpOwogICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCIpCiAgICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgICB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU1RBUlRfU0VTU0lPTl9GQUlMRUQsICJzdGFydFZvaWNlSWRTZXNzaW9uIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmV2YWx1YXRlU3BlYWtlciA9IGZ1bmN0aW9uIChzdGFydE5ldykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgdmFyIHBvbGxUaW1lcyA9IDA7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBldmFsdWF0ZSgpIHsKICAgICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgICAiU2Vzc2lvbk5hbWVPcklkIjogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgICB9OwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5FVkFMVUFURV9TRVNTSU9OLCBwYXJhbXMsIHsKICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICBpZigrK3BvbGxUaW1lcyA8IGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FVkFMVUFUSU9OX01BWF9QT0xMX1RJTUVTKSB7CiAgICAgICAgICAgICAgICBpZihkYXRhLlN0cmVhbWluZ1N0YXR1cyA9PT0gY29ubmVjdC5Wb2ljZUlkU3RyZWFtaW5nU3RhdHVzLlBFTkRJTkdfQ09ORklHVVJBVElPTikgewogICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmKCFkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoIWRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0ID0ge307CiAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLk5PVF9FTkFCTEVEOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlIGlmIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBhcmUgbm90IGVuYWJsZWQuCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICAhc2VsZi5pc0ZyYXVkRW5hYmxlZChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSkgewogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgaWYoZGF0YS5TdHJlYW1pbmdTdGF0dXMgPT09IGNvbm5lY3QuVm9pY2VJZFN0cmVhbWluZ1N0YXR1cy5FTkRFRCkgewogICAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0Tm90RW5vdWdoU3BlZWNoKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uSU5DT05DTFVTSVZFOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZihzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIC8vIFZvaWNlIHByaW50IGlzIG5vdCBsb25nIGVub3VnaCBmb3IgYm90aCBhdXRoZW50aWNhdGlvbiBhbmQgZnJhdWQgZGV0ZWN0aW9uCiAgICAgICAgICAgICAgICAgIGlmKHNlbGYuaXNBdXRoUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pc0ZyYXVkUmVzdWx0SW5jb25jbHVzaXZlKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImV2YWx1YXRlU3BlYWtlciBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZighc2VsZi5pc0F1dGhSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzQXV0aEVuYWJsZWQoZGF0YS5BdXRoZW50aWNhdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24pIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5BQ0NFUFQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5BVVRIRU5USUNBVEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkQXV0aGVudGljYXRpb25EZWNpc2lvbi5SRUpFQ1Q6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfQVVUSEVOVElDQVRFRDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEF1dGhlbnRpY2F0aW9uRGVjaXNpb24uU1BFQUtFUl9PUFRFRF9PVVQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5PUFRFRF9PVVQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLlNQRUFLRVJfTk9UX0VOUk9MTEVEOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0F1dGhlbnRpY2F0aW9uRGVjaXNpb24uTk9UX0VOUk9MTEVEOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuQXV0aGVudGljYXRpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikgJiYKICAgICAgICAgICAgICAgICAgICBzZWxmLmlzRnJhdWRFbmFibGVkKGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIGNvbm5lY3QuVm9pY2VJZEZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLkZyYXVkRGV0ZWN0aW9uUmVzdWx0LkRlY2lzaW9uID0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uSElHSF9SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5MT1dfUklTSzoKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbiA9IGNvbm5lY3QuQ29udGFjdEZsb3dGcmF1ZERldGVjdGlvbkRlY2lzaW9uLkxPV19SSVNLOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuRnJhdWREZXRlY3Rpb25SZXN1bHQuRGVjaXNpb24gPSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5FUlJPUjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmKCFzZWxmLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaChkYXRhLkF1dGhlbnRpY2F0aW9uUmVzdWx0LkRlY2lzaW9uKSAmJgogICAgICAgICAgICAgICAgICAgICFzZWxmLmlzRnJhdWRSZXN1bHROb3RFbm91Z2hTcGVlY2goZGF0YS5GcmF1ZERldGVjdGlvblJlc3VsdC5EZWNpc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmUgb25seSB3aGVuIGJvdGggYXV0aGVudGljYXRpb24gYW5kIGZyYXVkIGRldGVjdGlvbiBoYXZlIHJlc3VsdHMuIE90aGVyd2lzZSwga2VlcCBwb2xsaW5nLgogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJldmFsdWF0ZVNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGV2YWx1YXRlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRVZBTFVBVElPTl9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJldmFsdWF0ZVNwZWFrZXIgdGltZW91dCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfVElNRU9VVCwgImV2YWx1YXRlU3BlYWtlciB0aW1lb3V0Iik7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkVWQUxVQVRFX1NQRUFLRVJfRkFJTEVELCAiZXZhbHVhdGVTcGVha2VyIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImV2YWx1YXRlU3BlYWtlciBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSkKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZighc3RhcnROZXcpIHsKICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGV2YWx1YXRlKCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3luY1NwZWFrZXJJZCBmYWlsZWQgd2hlbiBzZXNzaW9uIHN0YXJ0TmV3PWZhbHNlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICB9KQogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuc3RhcnRTZXNzaW9uKCkudGhlbihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgc2V0VGltZW91dChldmFsdWF0ZSwgY29ubmVjdC5Wb2ljZUlkQ29uc3RhbnRzLkVWQUxVQVRFX1NFU1NJT05fREVMQVkpOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoInN5bmNTcGVha2VySWQgZmFpbGVkIHdoZW4gc2Vzc2lvbiBzdGFydE5ldz10cnVlIikKICAgICAgICAgICAgICAgIC53aXRoT2JqZWN0KHtlcnI6IGVycn0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigic3RhcnRTZXNzaW9uIGZhaWxlZCB3aGVuIHNlc3Npb24gc3RhcnROZXc9dHJ1ZSIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3Qoe2VycjogZXJyfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlamVjdChlcnIpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmRlc2NyaWJlU2Vzc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIkRvbWFpbklkIiA6IGRvbWFpbklkCiAgICAgICAgfTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImRlc2NyaWJlU2Vzc2lvbiBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5ERVNDUklCRV9TRVNTSU9OLCBwYXJhbXMsIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIHJlc29sdmUoZGF0YSkKICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImRlc2NyaWJlU2Vzc2lvbiBmYWlsZWQiKQogICAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICAgIGVycjogZXJyCiAgICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5ERVNDUklCRV9TRVNTSU9OX0ZBSUxFRCwgImRlc2NyaWJlU2Vzc2lvbiBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgIHJlamVjdChlcnIpOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmNoZWNrRW5yb2xsbWVudFN0YXR1cyA9IGZ1bmN0aW9uIChjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpIHsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiY2hlY2tFbnJvbGxtZW50U3RhdHVzIGNhbGxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcG9sbGluZ1RpbWVzID0gMDsKICAgIHZhciBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGVIYXNCZWVuSW52b2tlZCA9IGZhbHNlOwoKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlICgpIHsKICAgICAgICBpZigrK3BvbGxpbmdUaW1lcyA8IGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5FTlJPTExNRU5UX01BWF9QT0xMX1RJTUVTKSB7CiAgICAgICAgICBzZWxmLmRlc2NyaWJlU2Vzc2lvbigpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICAgIHN3aXRjaChkYXRhLlNlc3Npb24uRW5yb2xsbWVudFJlcXVlc3REZXRhaWxzLlN0YXR1cykgewogICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMuQ09NUExFVEVEOgogICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMuSU5fUFJPR1JFU1M6CiAgICAgICAgICAgICAgICBpZiAoIWNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZUhhc0JlZW5JbnZva2VkICYmIHR5cGVvZiBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKGRhdGEpOwogICAgICAgICAgICAgICAgICBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGVIYXNCZWVuSW52b2tlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGRlc2NyaWJlLCBjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgY29ubmVjdC5Wb2ljZUlkRW5yb2xsbWVudFJlcXVlc3RTdGF0dXMuTk9UX0VOT1VHSF9TUEVFQ0g6CiAgICAgICAgICAgICAgICBpZihkYXRhLlNlc3Npb24uU3RyZWFtaW5nU3RhdHVzICE9PSBjb25uZWN0LlZvaWNlSWRTdHJlYW1pbmdTdGF0dXMuRU5ERUQpIHsKICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChkZXNjcmliZSxjb25uZWN0LlZvaWNlSWRDb25zdGFudHMuRU5ST0xMTUVOVF9QT0xMSU5HX0lOVEVSVkFMKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBzZWxmLnN0YXJ0U2Vzc2lvbigpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgZGVzY3JpYmUoKTsKICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIsIGRhdGEpewogICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0sIGNvbm5lY3QuVm9pY2VJZENvbnN0YW50cy5TVEFSVF9TRVNTSU9OX0RFTEFZKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IGRhdGEuU2Vzc2lvbi5FbnJvbGxtZW50UmVxdWVzdERldGFpbHMuTWVzc2FnZSA/IGRhdGEuU2Vzc2lvbi5FbnJvbGxtZW50UmVxdWVzdERldGFpbHMuTWVzc2FnZSA6ICJlbnJvbGxTcGVha2VyIGZhaWxlZC4gVW5rbm93biBlbnJvbGxtZW50IHN0YXR1cyBoYXMgYmVlbiByZWNlaXZlZCI7CiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKG1lc3NhZ2UpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgCQkgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5FTlJPTExfU1BFQUtFUl9GQUlMRUQsIG1lc3NhZ2UsIGRhdGEuU2Vzc2lvbi5FbnJvbGxtZW50UmVxdWVzdERldGFpbHMuU3RhdHVzKTsKICAJCSAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZW5yb2xsU3BlYWtlciB0aW1lb3V0Iikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfVElNRU9VVCwgImVucm9sbFNwZWFrZXIgdGltZW91dCIpOwogICAgICAgICAgcmVqZWN0KGVycm9yKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZGVzY3JpYmUoKTsKICAgIH0pOwogIH07CgogIFZvaWNlSWQucHJvdG90eXBlLmVucm9sbFNwZWFrZXIgPSBmdW5jdGlvbiAoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgY2FsbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY2hlY2tDb25mZXJlbmNlQ2FsbCgpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLnN5bmNTcGVha2VySWQoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYuZ2V0U3BlYWtlclN0YXR1cygpLnRoZW4oZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgaWYoZGF0YS5TcGVha2VyICYmIGRhdGEuU3BlYWtlci5TdGF0dXMgPT0gY29ubmVjdC5Wb2ljZUlkU3BlYWtlclN0YXR1cy5PUFRFRF9PVVQpIHsKICAgICAgICAgICAgc2VsZi5kZWxldGVTcGVha2VyKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzZWxmLmVucm9sbFNwZWFrZXJIZWxwZXIocmVzb2x2ZSwgcmVqZWN0LCBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpOwogICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICByZWplY3QoZXJyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLmVucm9sbFNwZWFrZXJIZWxwZXIocmVzb2x2ZSwgcmVqZWN0LCBjYWxsYmFja09uQXVkaW9Db2xsZWN0aW9uQ29tcGxldGUpOwogICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgcmVqZWN0KGVycikKICAgICAgfSkKICAgIH0pCiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5lbnJvbGxTcGVha2VySGVscGVyID0gZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCwgY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgdmFyIGNvbnRhY3REYXRhID0gY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0Q29udGFjdERhdGEodGhpcy5jb250YWN0SWQpOwogICAgc2VsZi5nZXREb21haW5JZCgpLnRoZW4oZnVuY3Rpb24oZG9tYWluSWQpIHsKICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICB9OwogICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXJIZWxwZXIgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLkVOUk9MTF9CWV9TRVNTSU9OLCBwYXJhbXMsIHsKICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgIGlmKGRhdGEuU3RhdHVzID09PSBjb25uZWN0LlZvaWNlSWRFbnJvbGxtZW50UmVxdWVzdFN0YXR1cy5DT01QTEVURUQpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oImVucm9sbFNwZWFrZXIgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2VsZi5jaGVja0Vucm9sbG1lbnRTdGF0dXMoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKS50aGVuKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJlbnJvbGxTcGVha2VyIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoImVucm9sbFNwZWFrZXIgZmFpbGVkIikKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVycgogICAgICAgICAgICAgIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuRU5ST0xMX1NQRUFLRVJfRkFJTEVELCAiZW5yb2xsU3BlYWtlciBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHJlamVjdChlcnIpOwogICAgfSk7CiAgfTsKCiAgLy8gaW50ZXJuYWwgb25seQogIFZvaWNlSWQucHJvdG90eXBlLl91cGRhdGVTcGVha2VySWRJbkxjbXMgPSBmdW5jdGlvbiAoc3BlYWtlcklkLCBnZW5lcmF0ZWRTcGVha2VySWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBjb25zdCBwYXJhbXMgPSB7CiAgICAgICAgIkNvbnRhY3RJZCI6IHNlbGYuY29udGFjdElkLAogICAgICAgICJJbnN0YW5jZUlkIjogY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyKCkuZ2V0SW5zdGFuY2VJZCgpLAogICAgICAgICJBV1NBY2NvdW50SWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBV1NBY2NvdW50SWQoKSwKICAgICAgICAiQ3VzdG9tZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAiVm9pY2VJZFJlc3VsdCI6IHsKICAgICAgICAgICJnZW5lcmF0ZWRTcGVha2VySWQiOiBnZW5lcmF0ZWRTcGVha2VySWQKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiX3VwZGF0ZVNwZWFrZXJJZEluTGNtcyBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1ZPSUNFX0lEX0RBVEEsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInVwZGF0ZVNwZWFrZXJJZEluTGNtcyBzdWNjZWVkZWQiKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5MY21zIGZhaWxlZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5VUERBVEVfU1BFQUtFUl9JRF9JTl9MQ01TX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluTGNtcyBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS51cGRhdGVTcGVha2VySWRJblZvaWNlSWQgPSBmdW5jdGlvbiAoc3BlYWtlcklkKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldERvbWFpbklkKCkudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgIGNvbnN0IHBhcmFtcyA9IHsKICAgICAgICAgICJTZXNzaW9uTmFtZU9ySWQiOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkLAogICAgICAgICAgIlNwZWFrZXJJZCI6IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzcGVha2VySWQsICdzcGVha2VySWQnKSwKICAgICAgICAgICJEb21haW5JZCIgOiBkb21haW5JZAogICAgICAgIH07CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgY2FsbGVkIikud2l0aE9iamVjdChwYXJhbXMpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5BZ2VudEFwcENsaWVudE1ldGhvZHMuVVBEQVRFX1NFU1NJT04sIHBhcmFtcywgewogICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIHN1Y2NlZWRlZCIpLndpdGhPYmplY3QoZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICBzZWxmLl91cGRhdGVTcGVha2VySWRJbkxjbXMoc3BlYWtlcklkLCBkYXRhLmdlbmVyYXRlZFNwZWFrZXJJZCkKICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICAgIHZhciBlcnJvcjsKICAgICAgICAgICAgICB2YXIgcGFyc2VkRXJyID0gSlNPTi5wYXJzZShlcnIpOwogICAgICAgICAgICAgIHN3aXRjaChwYXJzZWRFcnIuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgIGNhc2UgNDA0OgogICAgICAgICAgICAgICAgICBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuU0VTU0lPTl9OT1RfRVhJU1RTLCAidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigidXBkYXRlU3BlYWtlcklkSW5Wb2ljZUlkIGZhaWxlZCwgc2Vzc2lvbiBub3QgZXhpc3RzIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLlVQREFURV9TUEVBS0VSX0lEX0ZBSUxFRCwgInVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZCBmYWlsZWQiLCBlcnIpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJ1cGRhdGVTcGVha2VySWRJblZvaWNlSWQgZmFpbGVkIikud2l0aE9iamVjdCh7IGVycjogZXJyIH0pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICBWb2ljZUlkLnByb3RvdHlwZS5zeW5jU3BlYWtlcklkID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJzeW5jU3BlYWtlcklkIGNhbGxlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZWxmLmdldFNwZWFrZXJJZCgpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgc2VsZi51cGRhdGVTcGVha2VySWRJblZvaWNlSWQoZGF0YS5zcGVha2VySWQpLnRoZW4oZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgICAgcmVqZWN0KGVycik7CiAgICAgICAgfSkKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICByZWplY3QoZXJyKTsKICAgICAgfSk7CiAgICB9KQogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuZ2V0RG9tYWluSWQgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIGNvbnN0IGFnZW50ID0gbmV3IGNvbm5lY3QuQWdlbnQoKTsKICAgICAgaWYgKCFhZ2VudC5nZXRQZXJtaXNzaW9ucygpLmluY2x1ZGVzKGNvbm5lY3QuQWdlbnRQZXJtaXNzaW9ucy5WT0lDRV9JRCkpIHsKICAgICAgICByZWplY3QobmV3IEVycm9yKCJBZ2VudCBkb2Vzbid0IGhhdmUgdGhlIHBlcm1pc3Npb24gZm9yIFZvaWNlIElEIikpOwogICAgICB9IGVsc2UgaWYgKGNvbm5lY3QuY29yZS52b2ljZUlkRG9tYWluSWQpIHsKICAgICAgICByZXNvbHZlKGNvbm5lY3QuY29yZS52b2ljZUlkRG9tYWluSWQpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBjbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50KCk7CiAgICAgICAgY29uc3QgcGFyYW1zID0gewogICAgICAgICAgIkluc3RhbmNlSWQiOiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRJbnN0YW5jZUlkKCksCiAgICAgICAgICAiSW50ZWdyYXRpb25UeXBlIjogIlZPSUNFX0lEIgogICAgICAgIH07CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXREb21haW5JZCBjYWxsZWQiKS53aXRoT2JqZWN0KHBhcmFtcykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjbGllbnQuY2FsbChjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcy5MSVNUX0lOVEVHUkFUSU9OX0FTU09DSUFUSU9OUywgcGFyYW1zLCB7CiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBkb21haW5JZDsKICAgICAgICAgICAgICBpZiAoZGF0YS5JbnRlZ3JhdGlvbkFzc29jaWF0aW9uU3VtbWFyeUxpc3QubGVuZ3RoID49IDEpIHsKICAgICAgICAgICAgICAgIHZhciBpbnRlZ3JhdGlvbkFybiA9IGRhdGEuSW50ZWdyYXRpb25Bc3NvY2lhdGlvblN1bW1hcnlMaXN0WzBdLkludGVncmF0aW9uQXJuOwogICAgICAgICAgICAgICAgZG9tYWluSWQgPSBpbnRlZ3JhdGlvbkFybi5yZXBsYWNlKC9eLipkb21haW5cLy9pLCAnJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZG9tYWluSWQpIHsKICAgICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0RG9tYWluSWQ6IG5vIGRvbWFpbklkIGZvdW5kIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IGNvbm5lY3QuVm9pY2VJZEVycm9yKGNvbm5lY3QuVm9pY2VJZEVycm9yVHlwZXMuTk9fRE9NQUlOX0lEX0ZPVU5EKTsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0RG9tYWluSWQgc3VjY2VlZGVkIikud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LlZvaWNlSWRFdmVudHMuVVBEQVRFX0RPTUFJTl9JRCwKICAgICAgICAgICAgICAgIGRhdGE6IHsgZG9tYWluSWQ6IGRvbWFpbklkIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXNvbHZlKGRvbWFpbklkKTsKICAgICAgICAgICAgfSBjYXRjaChlcnIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXREb21haW5JZCBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBjb25uZWN0LlZvaWNlSWRFcnJvcihjb25uZWN0LlZvaWNlSWRFcnJvclR5cGVzLkdFVF9ET01BSU5fSURfRkFJTEVELCAiZ2V0RG9tYWluSWQgZmFpbGVkIiwgZXJyKTsKICAgICAgICAgICAgICByZWplY3QoZXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXREb21haW5JZCBmYWlsZWQiKS53aXRoT2JqZWN0KHsgZXJyOiBlcnIgfSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgdmFyIGVycm9yID0gY29ubmVjdC5Wb2ljZUlkRXJyb3IoY29ubmVjdC5Wb2ljZUlkRXJyb3JUeXBlcy5HRVRfRE9NQUlOX0lEX0ZBSUxFRCwgImdldERvbWFpbklkIGZhaWxlZCIsIGVycik7CiAgICAgICAgICAgIHJlamVjdChlcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuY2hlY2tDb25mZXJlbmNlQ2FsbCA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgaXNDb25mZXJlbmNlQ2FsbCA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKS5jb25uZWN0aW9ucy5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuY29udGFpbnMoY29ubmVjdC5DT05ORUNUSU9OX0FDVElWRV9TVEFURVMsIGNvbm4uc3RhdGUudHlwZSk7CiAgICB9KS5sZW5ndGggPiAyOwogICAgaWYoaXNDb25mZXJlbmNlQ2FsbCl7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoIlZvaWNlSWQgaXMgbm90IHN1cHBvcnRlZCBmb3IgY29uZmVyZW5jZSBjYWxscyIpOwogICAgfQogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNBdXRoRW5hYmxlZCA9IGZ1bmN0aW9uKGF1dGhSZXN1bHQpIHsKICAgIHJldHVybiBhdXRoUmVzdWx0ICE9PSBjb25uZWN0LkNvbnRhY3RGbG93QXV0aGVudGljYXRpb25EZWNpc2lvbi5OT1RfRU5BQkxFRDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzQXV0aFJlc3VsdE5vdEVub3VnaFNwZWVjaCA9IGZ1bmN0aW9uKGF1dGhSZXN1bHQpIHsKICAgIHJldHVybiBhdXRoUmVzdWx0ID09PSBjb25uZWN0LlZvaWNlSWRBdXRoZW50aWNhdGlvbkRlY2lzaW9uLk5PVF9FTk9VR0hfU1BFRUNIOwogIH0KCiAgVm9pY2VJZC5wcm90b3R5cGUuaXNBdXRoUmVzdWx0SW5jb25jbHVzaXZlID0gZnVuY3Rpb24oYXV0aFJlc3VsdCkgewogICAgcmV0dXJuIGF1dGhSZXN1bHQgPT09IGNvbm5lY3QuQ29udGFjdEZsb3dBdXRoZW50aWNhdGlvbkRlY2lzaW9uLklOQ09OQ0xVU0lWRTsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzRnJhdWRFbmFibGVkID0gZnVuY3Rpb24oZnJhdWRSZXN1bHQpIHsKICAgIHJldHVybiBmcmF1ZFJlc3VsdCAhPT0gY29ubmVjdC5Db250YWN0Rmxvd0ZyYXVkRGV0ZWN0aW9uRGVjaXNpb24uTk9UX0VOQUJMRUQ7CiAgfQoKICBWb2ljZUlkLnByb3RvdHlwZS5pc0ZyYXVkUmVzdWx0Tm90RW5vdWdoU3BlZWNoID0gZnVuY3Rpb24oZnJhdWRSZXN1bHQpIHsKICAgIHJldHVybiBmcmF1ZFJlc3VsdCA9PT0gY29ubmVjdC5Wb2ljZUlkRnJhdWREZXRlY3Rpb25EZWNpc2lvbi5OT1RfRU5PVUdIX1NQRUVDSDsKICB9CgogIFZvaWNlSWQucHJvdG90eXBlLmlzRnJhdWRSZXN1bHRJbmNvbmNsdXNpdmUgPSBmdW5jdGlvbihmcmF1ZFJlc3VsdCkgewogICAgcmV0dXJuIGZyYXVkUmVzdWx0ID09PSBjb25uZWN0LkNvbnRhY3RGbG93RnJhdWREZXRlY3Rpb25EZWNpc2lvbi5JTkNPTkNMVVNJVkU7CiAgfQoKICAvKioKICAgKiBAY2xhc3MgVm9pY2VDb25uZWN0aW9uCiAgICogQHBhcmFtIHtudW1iZXJ9IGNvbnRhY3RJZAogICAqIEBwYXJhbSB7bnVtYmVyfSBjb25uZWN0aW9uSWQKICAgKiBAZGVzY3JpcHRpb24gLSBQcm92aWRlcyB2b2ljZSBtZWRpYSBzcGVjaWZpYyBvcGVyYXRpb25zCiAgICovCiAgdmFyIFZvaWNlQ29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IgPSBuZXcgVm9pY2VJZChjb250YWN0SWQpOwogICAgdGhpcy5fY29udGFjdFJlY29yZGVyID0gbmV3IENvbnRhY3RSZWNvcmRpbmcoY29udGFjdElkKTsKICAgIENvbm5lY3Rpb24uY2FsbCh0aGlzLCBjb250YWN0SWQsIGNvbm5lY3Rpb25JZCk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBWb2ljZUNvbm5lY3Rpb247CgogIC8qKgogICogQGRlcHJlY2F0ZWQKICAqIFBsZWFzZSB1c2UgZ2V0TWVkaWFJbmZvCiAgKi8KICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldFNvZnRwaG9uZU1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9nZXREYXRhKCkuc29mdHBob25lTWVkaWFJbmZvOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFJbmZvID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5zb2Z0cGhvbmVNZWRpYUluZm87CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5NZWRpYVR5cGUuU09GVFBIT05FOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5tZWRpYUZhY3RvcnkuZ2V0KHRoaXMpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRWb2ljZUlkU3BlYWtlcklkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZ2V0U3BlYWtlcklkKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmdldFZvaWNlSWRTcGVha2VyU3RhdHVzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZ2V0U3BlYWtlclN0YXR1cygpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5vcHRPdXRWb2ljZUlkU3BlYWtlciA9IGZ1bmN0aW9uKCkgewoKICAgIHJldHVybiB0aGlzLl9zcGVha2VyQXV0aGVudGljYXRvci5vcHRPdXRTcGVha2VyKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmRlbGV0ZVZvaWNlSWRTcGVha2VyID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZGVsZXRlU3BlYWtlcigpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5ldmFsdWF0ZVNwZWFrZXJXaXRoVm9pY2VJZCA9IGZ1bmN0aW9uKHN0YXJ0TmV3KSB7CiAgICByZXR1cm4gdGhpcy5fc3BlYWtlckF1dGhlbnRpY2F0b3IuZXZhbHVhdGVTcGVha2VyKHN0YXJ0TmV3KTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuZW5yb2xsU3BlYWtlckluVm9pY2VJZCA9IGZ1bmN0aW9uKGNhbGxiYWNrT25BdWRpb0NvbGxlY3Rpb25Db21wbGV0ZSkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLmVucm9sbFNwZWFrZXIoY2FsbGJhY2tPbkF1ZGlvQ29sbGVjdGlvbkNvbXBsZXRlKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUudXBkYXRlVm9pY2VJZFNwZWFrZXJJZCA9IGZ1bmN0aW9uKHNwZWFrZXJJZCkgewogICAgcmV0dXJuIHRoaXMuX3NwZWFrZXJBdXRoZW50aWNhdG9yLnVwZGF0ZVNwZWFrZXJJZEluVm9pY2VJZChzcGVha2VySWQpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRRdWlja0Nvbm5lY3ROYW1lID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5xdWlja0Nvbm5lY3ROYW1lOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNTaWxlbnRNb25pdG9yID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLlNJTEVOVF9NT05JVE9SOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNCYXJnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29ubmVjdGlvblN0YXRlVHlwZS5CQVJHRTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLmlzQmFyZ2VFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIG1vbml0b3JpbmdDYXBhYmlsaXRpZXMgPSB0aGlzLmdldE1vbml0b3JDYXBhYmlsaXRpZXMoKTsKICAgIHJldHVybiBtb25pdG9yaW5nQ2FwYWJpbGl0aWVzICYmIG1vbml0b3JpbmdDYXBhYmlsaXRpZXMuaW5jbHVkZXMoY29ubmVjdC5Nb25pdG9yaW5nTW9kZS5CQVJHRSk7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5pc1NpbGVudE1vbml0b3JFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgdmFyIG1vbml0b3JpbmdDYXBhYmlsaXRpZXMgPSB0aGlzLmdldE1vbml0b3JDYXBhYmlsaXRpZXMoKTsKICAgIHJldHVybiBtb25pdG9yaW5nQ2FwYWJpbGl0aWVzICYmIG1vbml0b3JpbmdDYXBhYmlsaXRpZXMuaW5jbHVkZXMoY29ubmVjdC5Nb25pdG9yaW5nTW9kZS5TSUxFTlRfTU9OSVRPUik7CiAgfTsKCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNb25pdG9yQ2FwYWJpbGl0aWVzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5tb25pdG9yQ2FwYWJpbGl0aWVzOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNNdXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5tdXRlOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuaXNGb3JjZWRNdXRlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2dldERhdGEoKS5mb3JjZWRNdXRlOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUubXV0ZVBhcnRpY2lwYW50ID0gZnVuY3Rpb24gKGNhbGxiYWNrcykgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIGNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5NVVRFX1BBUlRJQ0lQQU5ULCB7CiAgICAgIGNvbnRhY3RJZDogdGhpcy5nZXRDb250YWN0SWQoKSwKICAgICAgY29ubmVjdGlvbklkOiB0aGlzLmdldENvbm5lY3Rpb25JZCgpCiAgICB9LCBjYWxsYmFja3MpOwogIH07CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUudW5tdXRlUGFydGljaXBhbnQgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgY2xpZW50ID0gY29ubmVjdC5jb3JlLmdldENsaWVudCgpOwogICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlVOTVVURV9QQVJUSUNJUEFOVCwgewogICAgICBjb250YWN0SWQ6IHRoaXMuZ2V0Q29udGFjdElkKCksCiAgICAgIGNvbm5lY3Rpb25JZDogdGhpcy5nZXRDb25uZWN0aW9uSWQoKQogICAgfSwgY2FsbGJhY2tzKTsKICB9OwoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnN0YXJ0Q29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN0YXJ0Q29udGFjdFJlY29yZGluZygpOwogIH0KCiAgVm9pY2VDb25uZWN0aW9uLnByb3RvdHlwZS5zdG9wQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnN0b3BDb250YWN0UmVjb3JkaW5nKCk7CiAgfQoKICBWb2ljZUNvbm5lY3Rpb24ucHJvdG90eXBlLnN1c3BlbmRDb250YWN0UmVjb3JkaW5nID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNoZWNrQ29uZmVyZW5jZUNhbGwoKTsKICAgIHJldHVybiB0aGlzLl9jb250YWN0UmVjb3JkZXIuc3VzcGVuZENvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUucmVzdW1lQ29udGFjdFJlY29yZGluZyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jaGVja0NvbmZlcmVuY2VDYWxsKCk7CiAgICByZXR1cm4gdGhpcy5fY29udGFjdFJlY29yZGVyLnJlc3VtZUNvbnRhY3RSZWNvcmRpbmcoKTsKICB9CgogIFZvaWNlQ29ubmVjdGlvbi5wcm90b3R5cGUuY2hlY2tDb25mZXJlbmNlQ2FsbCA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgaXNDb25mZXJlbmNlQ2FsbCA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHNlbGYuY29udGFjdElkKS5jb25uZWN0aW9ucy5maWx0ZXIoZnVuY3Rpb24gKGNvbm4pIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuY29udGFpbnMoY29ubmVjdC5DT05ORUNUSU9OX0FDVElWRV9TVEFURVMsIGNvbm4uc3RhdGUudHlwZSk7CiAgICB9KS5sZW5ndGggPiAyOwogICAgaWYoaXNDb25mZXJlbmNlQ2FsbCl7CiAgICAgIHRocm93IG5ldyBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IoIlZvaWNlSWQgYW5kIENvbnRhY3QgUmVjb3JkaW5nIGFyZSBub3Qgc3VwcG9ydGVkIGZvciBjb25mZXJlbmNlIGNhbGxzIik7CiAgICB9CiAgfQoKICAvKioKICAgKiBAY2xhc3MgQ2hhdENvbm5lY3Rpb24KICAgKiBAcGFyYW0geyp9IGNvbnRhY3RJZAogICAqIEBwYXJhbSB7Kn0gY29ubmVjdGlvbklkCiAgICogQGRlc2NyaXB0aW9uIGFkZHMgdGhlIGNoYXQgbWVkaWEgc3BlY2lmaWMgZnVuY3Rpb25hbGl0eQogICAqLwogIHZhciBDaGF0Q29ubmVjdGlvbiA9IGZ1bmN0aW9uIChjb250YWN0SWQsIGNvbm5lY3Rpb25JZCkgewogICAgQ29ubmVjdGlvbi5jYWxsKHRoaXMsIGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKTsKICB9OwoKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENvbm5lY3Rpb24ucHJvdG90eXBlKTsKICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDaGF0Q29ubmVjdGlvbjsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhSW5mbyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBkYXRhID0gdGhpcy5fZ2V0RGF0YSgpLmNoYXRNZWRpYUluZm87CiAgICBpZiAoIWRhdGEpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgewogICAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRDb250YWN0RGF0YSh0aGlzLmNvbnRhY3RJZCk7CiAgICAgIHZhciBtZWRpYU9iamVjdCA9IHsKICAgICAgICBjb250YWN0SWQ6IHRoaXMuY29udGFjdElkLAogICAgICAgIGluaXRpYWxDb250YWN0SWQ6IGNvbnRhY3REYXRhLmluaXRpYWxDb250YWN0SWQgfHwgdGhpcy5jb250YWN0SWQsCiAgICAgICAgcGFydGljaXBhbnRJZDogdGhpcy5jb25uZWN0aW9uSWQsCiAgICAgICAgZ2V0Q29ubmVjdGlvblRva2VuOiBjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuZ2V0Q29ubmVjdGlvblRva2VuKQogICAgICB9OwogICAgICBpZiAoZGF0YS5jb25uZWN0aW9uRGF0YSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuID0gSlNPTi5wYXJzZShkYXRhLmNvbm5lY3Rpb25EYXRhKS5Db25uZWN0aW9uQXV0aGVudGljYXRpb25Ub2tlbjsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQsICJDb25uZWN0aW9uIGRhdGEgaXMgaW52YWxpZCIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgbWVkaWFPYmplY3QucGFydGljaXBhbnRUb2tlbiA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIG1lZGlhT2JqZWN0LnBhcnRpY2lwYW50VG9rZW4gPSBtZWRpYU9iamVjdC5wYXJ0aWNpcGFudFRva2VuIHx8IG51bGw7CiAgICAgIC8qKiBKdXN0IHRvIGtlZXAgdGhlIGRhdGEgYWNjZXNzaWJsZSAqLwogICAgICBtZWRpYU9iamVjdC5vcmlnaW5hbEluZm8gPSB0aGlzLl9nZXREYXRhKCkuY2hhdE1lZGlhSW5mbzsKICAgICAgcmV0dXJuIG1lZGlhT2JqZWN0OwogICAgfQogIH07CgogIC8qKgogICogUHJvdmlkZXMgdGhlIGNoYXQgY29ubmVjdGlvblRva2VuIHRocm91Z2ggdGhlIGNyZWF0ZV90cmFuc3BvcnQgQVBJIGZvciBhIHNwZWNpZmljIGNvbnRhY3QgYW5kIHBhcnRpY2lwYW50IElkLgogICogQHJldHVybnMgYSBwcm9taXNlIHdoaWNoLCB1cG9uIHN1Y2Nlc3MsIHJldHVybnMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNyZWF0ZVRyYW5zcG9ydCBBUEkuCiAgKiBVc2FnZToKICAqIGNvbm5lY3Rpb24uZ2V0Q29ubmVjdGlvblRva2VuKCkKICAqICAudGhlbihyZXNwb25zZSA9PiB7fSkKICAqICAuY2F0Y2goZXJyb3IgPT4ge30pCiAgKi8KICBDaGF0Q29ubmVjdGlvbi5wcm90b3R5cGUuZ2V0Q29ubmVjdGlvblRva2VuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgIHZhciB0cmFuc3BvcnREZXRhaWxzID0gewogICAgICB0cmFuc3BvcnRUeXBlOiBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUy5DSEFUX1RPS0VOLAogICAgICBwYXJ0aWNpcGFudElkOiB0aGlzLmNvbm5lY3Rpb25JZCwKICAgICAgY29udGFjdElkOiBjb250YWN0RGF0YS5pbml0aWFsQ29udGFjdElkIHx8IHRoaXMuY29udGFjdElkCiAgICB9OwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHRyYW5zcG9ydERldGFpbHMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJnZXRDb25uZWN0aW9uVG9rZW4gc3VjY2VlZGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJnZXRDb25uZWN0aW9uVG9rZW4gZmFpbGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIHJlamVjdChFcnJvcigiZ2V0Q29ubmVjdGlvblRva2VuIGZhaWxlZCIpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLmdldE1lZGlhVHlwZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOwogIH07CgogIENoYXRDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfTsKCiAgQ2hhdENvbm5lY3Rpb24ucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgewogICAgLy8gTm90ZSB0aGF0IGEgY2hhdCBtZWRpYSBjb250cm9sbGVyIG9ubHkgbmVlZHMgdG8gYmUgcHJvZHVjZWQgZm9yIGFnZW50IHR5cGUgY29ubmVjdGlvbnMuCiAgICBpZiAodGhpcy5faXNBZ2VudENvbm5lY3Rpb25UeXBlKCkpIHsKICAgICAgY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcykuY2F0Y2goZnVuY3Rpb24gKCkgeyB9KTsKICAgIH0KICB9CgogIC8qKgogICAqIEBjbGFzcyBUYXNrQ29ubmVjdGlvbgogICAqIEBwYXJhbSB7Kn0gY29udGFjdElkCiAgICogQHBhcmFtIHsqfSBjb25uZWN0aW9uSWQKICAgKiBAZGVzY3JpcHRpb24gYWRkcyB0aGUgdGFzayBtZWRpYSBzcGVjaWZpYyBmdW5jdGlvbmFsaXR5CiAgICovCiAgdmFyIFRhc2tDb25uZWN0aW9uID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICBDb25uZWN0aW9uLmNhbGwodGhpcywgY29udGFjdElkLCBjb25uZWN0aW9uSWQpOwogIH07CiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDb25uZWN0aW9uLnByb3RvdHlwZSk7CiAgVGFza0Nvbm5lY3Rpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza0Nvbm5lY3Rpb247CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYVR5cGUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5NZWRpYVR5cGUuVEFTSzsKICB9CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjb250YWN0RGF0YSA9IGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldENvbnRhY3REYXRhKHRoaXMuY29udGFjdElkKTsKICAgICAgdmFyIG1lZGlhT2JqZWN0ID0gewogICAgICAgIGNvbnRhY3RJZDogdGhpcy5jb250YWN0SWQsCiAgICAgICAgaW5pdGlhbENvbnRhY3RJZDogY29udGFjdERhdGEuaW5pdGlhbENvbnRhY3RJZCB8fCB0aGlzLmNvbnRhY3RJZCwKICAgICAgfTsKICAgICAgcmV0dXJuIG1lZGlhT2JqZWN0OwogIH07CgogIFRhc2tDb25uZWN0aW9uLnByb3RvdHlwZS5nZXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLm1lZGlhRmFjdG9yeS5nZXQodGhpcyk7CiAgfTsKCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogY2xhc3MgQ29ubmVjdGlvblNuYXBzaG90CiAgICovCiAgdmFyIENvbm5lY3Rpb25TbmFwc2hvdCA9IGZ1bmN0aW9uIChjb25uZWN0aW9uRGF0YSkgewogICAgY29ubmVjdC5Db25uZWN0aW9uLmNhbGwodGhpcywgY29ubmVjdGlvbkRhdGEuY29udGFjdElkLCBjb25uZWN0aW9uRGF0YS5jb25uZWN0aW9uSWQpOwogICAgdGhpcy5jb25uZWN0aW9uRGF0YSA9IGNvbm5lY3Rpb25EYXRhOwogIH07CiAgQ29ubmVjdGlvblNuYXBzaG90LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29ubmVjdGlvbi5wcm90b3R5cGUpOwogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDb25uZWN0aW9uU25hcHNob3Q7CgogIENvbm5lY3Rpb25TbmFwc2hvdC5wcm90b3R5cGUuX2dldERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uRGF0YTsKICB9OwoKICBDb25uZWN0aW9uU25hcHNob3QucHJvdG90eXBlLl9pbml0TWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKCkgeyB9OwoKICB2YXIgRW5kcG9pbnQgPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHRoaXMuZW5kcG9pbnRBUk4gPSBwYXJhbXMuZW5kcG9pbnRJZCB8fCBwYXJhbXMuZW5kcG9pbnRBUk4gfHwgbnVsbDsKICAgIHRoaXMuZW5kcG9pbnRJZCA9IHRoaXMuZW5kcG9pbnRBUk47CiAgICB0aGlzLnR5cGUgPSBwYXJhbXMudHlwZSB8fCBudWxsOwogICAgdGhpcy5uYW1lID0gcGFyYW1zLm5hbWUgfHwgbnVsbDsKICAgIHRoaXMucGhvbmVOdW1iZXIgPSBwYXJhbXMucGhvbmVOdW1iZXIgfHwgbnVsbDsKICAgIHRoaXMuYWdlbnRMb2dpbiA9IHBhcmFtcy5hZ2VudExvZ2luIHx8IG51bGw7CiAgICB0aGlzLnF1ZXVlID0gcGFyYW1zLnF1ZXVlIHx8IG51bGw7CiAgfTsKCiAgLyoqCiAgICogU3RyaXAgdGhlIFNJUCBlbmRwb2ludCBjb21wb25lbnRzIGZyb20gdGhlIHBob25lTnVtYmVyIGZpZWxkLgogICAqLwogIEVuZHBvaW50LnByb3RvdHlwZS5zdHJpcFBob25lTnVtYmVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMucGhvbmVOdW1iZXIgPyB0aGlzLnBob25lTnVtYmVyLnJlcGxhY2UoL3NpcDooW15AXSopQC4qLywgIiQxIikgOiAiIjsKICB9OwoKICAvKioKICAgKiBDcmVhdGUgYW4gRW5kcG9pbnQgb2JqZWN0IGZyb20gdGhlIGdpdmVuIHBob25lIG51bWJlciBhbmQgbmFtZS4KICAgKi8KICBFbmRwb2ludC5ieVBob25lTnVtYmVyID0gZnVuY3Rpb24gKG51bWJlciwgbmFtZSkgewogICAgcmV0dXJuIG5ldyBFbmRwb2ludCh7CiAgICAgIHR5cGU6IGNvbm5lY3QuRW5kcG9pbnRUeXBlLlBIT05FX05VTUJFUiwKICAgICAgcGhvbmVOdW1iZXI6IG51bWJlciwKICAgICAgbmFtZTogbmFtZSB8fCBudWxsCiAgICB9KTsKICB9OwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBTb2Z0cGhvbmVFcnJvcgogICAqLwogIHZhciBTb2Z0cGhvbmVFcnJvciA9IGZ1bmN0aW9uIChlcnJvclR5cGUsIGVycm9yTWVzc2FnZSwgZW5kUG9pbnRVcmwpIHsKICAgIHRoaXMuZXJyb3JUeXBlID0gZXJyb3JUeXBlOwogICAgdGhpcy5lcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2U7CiAgICB0aGlzLmVuZFBvaW50VXJsID0gZW5kUG9pbnRVcmw7CiAgfTsKICBTb2Z0cGhvbmVFcnJvci5wcm90b3R5cGUuZ2V0RXJyb3JUeXBlID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuZXJyb3JUeXBlOwogIH07CiAgU29mdHBob25lRXJyb3IucHJvdG90eXBlLmdldEVycm9yTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVycm9yTWVzc2FnZTsKICB9OwogIFNvZnRwaG9uZUVycm9yLnByb3RvdHlwZS5nZXRFbmRQb2ludFVybCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmVuZFBvaW50VXJsOwogIH07CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFJvb3QgU3Vic2NyaXB0aW9uIEFQSXMuCiAgICovCiAgY29ubmVjdC5hZ2VudCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICB2YXIgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LkFnZW50RXZlbnRzLklOSVQsIGYpOwogICAgaWYgKGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQpIHsKICAgICAgZihuZXcgY29ubmVjdC5BZ2VudCgpKTsKICAgIH0KICAgIHJldHVybiBzdWI7CiAgfTsKICBjb25uZWN0LmFnZW50LmluaXRpYWxpemVkID0gZmFsc2U7CgogIGNvbm5lY3QuY29udGFjdCA9IGZ1bmN0aW9uIChmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICByZXR1cm4gYnVzLnN1YnNjcmliZShjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5JVCwgZik7CiAgfTsKCiAgY29ubmVjdC5vbldlYnNvY2tldEluaXRGYWlsdXJlID0gZnVuY3Rpb24gKGYpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIHZhciBzdWIgPSBidXMuc3Vic2NyaWJlKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLklOSVRfRkFJTFVSRSwgZik7CiAgICBpZiAoY29ubmVjdC53ZWJTb2NrZXRJbml0RmFpbGVkKSB7CiAgICAgIGYoKTsKICAgIH0KICAgIHJldHVybiBzdWI7CiAgfTsKCiAgLyoqCiAgICogU3RhcnRzIHRoZSBnaXZlbiBmdW5jdGlvbiBhc3luY2hyb25vdXNseSBvbmx5IGlmIHRoZSBzaGFyZWQgd29ya2VyCiAgICogc2F5cyB3ZSBhcmUgdGhlIG1hc3RlciBmb3IgdGhlIGdpdmVuIHRvcGljLiAgSWYgdGhlcmUgaXMgbm8gbWFzdGVyIGZvcgogICAqIHRoZSBnaXZlbiB0b3BpYywgd2UgYmVjb21lIHRoZSBtYXN0ZXIgYW5kIHN0YXJ0IHRoZSBmdW5jdGlvbiB1bmxlc3MKICAgKiBzaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUgaXMgdHJ1ZS4KICAgKgogICAqIEBwYXJhbSB0b3BpYyBUaGUgbWFzdGVyIHRvcGljIHdlIGFyZSBjb25jZXJuZWQgYWJvdXQuCiAgICogQHBhcmFtIGZfdHJ1ZSBUaGUgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBpZiB3ZSBhcmUgdGhlIG1hc3Rlci4KICAgKiBAcGFyYW0gZl9lbHNlIFtvcHRpb25hbF0gQSBjYWxsYmFjayB0byBiZSBpbnZva2VkIGlmIHdlIGFyZSBub3QgdGhlIG1hc3Rlci4KICAgKiBAcGFyYW0gc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lIFtvcHRpb25hbF0gaWYgdHJ1ZSwgdGhpcyB0YWIgd29uJ3QgYmVjb21lIG1hc3Rlci4KICAgKi8KICBjb25uZWN0LmlmTWFzdGVyID0gZnVuY3Rpb24gKHRvcGljLCBmX3RydWUsIGZfZWxzZSwgc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZl90cnVlLCAiQSB0cnVlIGNhbGxiYWNrIG11c3QgYmUgcHJvdmlkZWQuIik7CgogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIC8vIFdlIGNhbid0IGJlIHRoZSBtYXN0ZXIgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50IQogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGNhbid0IGJlIHRoZSBtYXN0ZXIgZm9yIHRvcGljICclcycgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50ISIsIHRvcGljKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAoZl9lbHNlKSB7CiAgICAgICAgZl9lbHNlKCk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBtYXN0ZXJDbGllbnQgPSBjb25uZWN0LmNvcmUuZ2V0TWFzdGVyQ2xpZW50KCk7CiAgICBtYXN0ZXJDbGllbnQuY2FsbChjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQ0hFQ0tfTUFTVEVSLCB7CiAgICAgIHRvcGljOiB0b3BpYywKICAgICAgc2hvdWxkTm90QmVjb21lTWFzdGVySWZOb25lOiBzaG91bGROb3RCZWNvbWVNYXN0ZXJJZk5vbmUKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEuaXNNYXN0ZXIpIHsKICAgICAgICAgICAgZl90cnVlKCk7CgogICAgICAgICAgfSBlbHNlIGlmIChmX2Vsc2UpIHsKICAgICAgICAgICAgZl9lbHNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICB9OwoKICAvKioKICAgKiBOb3RpZnkgdGhlIHNoYXJlZCB3b3JrZXIgYW5kIG90aGVyIENDUCB0YWJzIHRoYXQgd2UgYXJlIG5vdyB0aGUgbWFzdGVyIGZvciB0aGUgZ2l2ZW4gdG9waWMuCiAgICovCiAgY29ubmVjdC5iZWNvbWVNYXN0ZXIgPSBmdW5jdGlvbiAodG9waWMsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWMsICJBIHRvcGljIG11c3QgYmUgcHJvdmlkZWQuIik7CgogICAgaWYgKCFjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50KSB7CiAgICAgIC8vIFdlIGNhbid0IGJlIHRoZSBtYXN0ZXIgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50IQogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGNhbid0IGJlIHRoZSBtYXN0ZXIgZm9yIHRvcGljICclcycgYmVjYXVzZSB0aGVyZSBpcyBubyBtYXN0ZXIgY2xpZW50ISIsIHRvcGljKTsKICAgICAgaWYgKGZhaWx1cmVDYWxsYmFjaykgewogICAgICAgIGZhaWx1cmVDYWxsYmFjaygpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgbWFzdGVyQ2xpZW50ID0gY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCgpOwogICAgICBtYXN0ZXJDbGllbnQuY2FsbChjb25uZWN0Lk1hc3Rlck1ldGhvZHMuQkVDT01FX01BU1RFUiwgewogICAgICAgIHRvcGljOiB0b3BpYwogICAgICB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHN1Y2Nlc3NDYWxsYmFjaykgewogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2soKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH07CgogIGNvbm5lY3QuQWdlbnQgPSBBZ2VudDsKICBjb25uZWN0LkFnZW50U25hcHNob3QgPSBBZ2VudFNuYXBzaG90OwogIGNvbm5lY3QuQ29udGFjdCA9IENvbnRhY3Q7CiAgY29ubmVjdC5Db250YWN0U25hcHNob3QgPSBDb250YWN0U25hcHNob3Q7CiAgLyoqIERlZmF1bHQgd2lsbCBnZXQgdGhlIFZvaWNlIGNvbm5lY3Rpb24gKi8KICBjb25uZWN0LkNvbm5lY3Rpb24gPSBWb2ljZUNvbm5lY3Rpb247CiAgY29ubmVjdC5CYXNlQ29ubmVjdGlvbiA9IENvbm5lY3Rpb247CiAgY29ubmVjdC5Wb2ljZUNvbm5lY3Rpb24gPSBWb2ljZUNvbm5lY3Rpb247CiAgY29ubmVjdC5DaGF0Q29ubmVjdGlvbiA9IENoYXRDb25uZWN0aW9uOwogIGNvbm5lY3QuVGFza0Nvbm5lY3Rpb24gPSBUYXNrQ29ubmVjdGlvbjsKICBjb25uZWN0LkNvbm5lY3Rpb25TbmFwc2hvdCA9IENvbm5lY3Rpb25TbmFwc2hvdDsKICBjb25uZWN0LkVuZHBvaW50ID0gRW5kcG9pbnQ7CiAgY29ubmVjdC5BZGRyZXNzID0gRW5kcG9pbnQ7CiAgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvciA9IFNvZnRwaG9uZUVycm9yOwogIGNvbm5lY3QuVm9pY2VJZCA9IFZvaWNlSWQ7CiAgY29ubmVjdC5Db250YWN0UmVjb3JkaW5nID0gQ29udGFjdFJlY29yZGluZzsKfSkoKTsKCgoKLyoqKi8gfSksCgovKioqLyA4Mjc6Ci8qKiovICgobW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSA9PiB7Cgp2YXIgX19XRUJQQUNLX0FNRF9ERUZJTkVfUkVTVUxUX187Ly8gQVdTIFNESyBmb3IgSmF2YVNjcmlwdCB2Mi4xMjAwLjAKLy8gQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCi8vIExpY2Vuc2UgYXQgaHR0cHM6Ly9zZGsuYW1hem9uYXdzLmNvbS9qcy9CVU5ETEVfTElDRU5TRS50eHQKKGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9dW5kZWZpbmVkO2lmKCFmJiZjKXJldHVybiByZXF1aXJlKGksITApO2lmKHUpcmV0dXJuIHUoaSwhMCk7dmFyIGE9bmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIraSsiJyIpO3Rocm93IGEuY29kZT0iTU9EVUxFX05PVF9GT1VORCIsYX12YXIgcD1uW2ldPXtleHBvcnRzOnt9fTtlW2ldWzBdLmNhbGwocC5leHBvcnRzLGZ1bmN0aW9uKHIpe3ZhciBuPWVbaV1bMV1bcl07cmV0dXJuIG8obnx8cil9LHAscC5leHBvcnRzLHIsZSxuLHQpfXJldHVybiBuW2ldLmV4cG9ydHN9Zm9yKHZhciB1PXVuZGVmaW5lZCxpPTA7aTx0Lmxlbmd0aDtpKyspbyh0W2ldKTtyZXR1cm4gb31yZXR1cm4gcn0pKCkoezE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz17CiAgInZlcnNpb24iOiAiMi4wIiwKICAibWV0YWRhdGEiOiB7CiAgICAiYXBpVmVyc2lvbiI6ICIyMDE0LTA2LTMwIiwKICAgICJlbmRwb2ludFByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICJqc29uVmVyc2lvbiI6ICIxLjEiLAogICAgInByb3RvY29sIjogImpzb24iLAogICAgInNlcnZpY2VGdWxsTmFtZSI6ICJBbWF6b24gQ29nbml0byBJZGVudGl0eSIsCiAgICAic2VydmljZUlkIjogIkNvZ25pdG8gSWRlbnRpdHkiLAogICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjQiLAogICAgInRhcmdldFByZWZpeCI6ICJBV1NDb2duaXRvSWRlbnRpdHlTZXJ2aWNlIiwKICAgICJ1aWQiOiAiY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwIgogIH0sCiAgIm9wZXJhdGlvbnMiOiB7CiAgICAiQ3JlYXRlSWRlbnRpdHlQb29sIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSIsCiAgICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSI6IHt9LAogICAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiQWxsb3dDbGFzc2ljRmxvdyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiU3VwcG9ydGVkTG9naW5Qcm92aWRlcnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTNSIKICAgICAgICAgIH0sCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiT3BlbklkQ29ubmVjdFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM5IgogICAgICAgICAgfSwKICAgICAgICAgICJDb2duaXRvSWRlbnRpdHlQcm92aWRlcnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTYiIKICAgICAgICAgIH0sCiAgICAgICAgICAiU2FtbFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNnIgogICAgICAgICAgfSwKICAgICAgICAgICJJZGVudGl0eVBvb2xUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2giCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgfQogICAgfSwKICAgICJEZWxldGVJZGVudGl0aWVzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlJZHNUb0RlbGV0ZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWRzVG9EZWxldGUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJVbnByb2Nlc3NlZElkZW50aXR5SWRzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHsKICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICAgICAgICJFcnJvckNvZGUiOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJEZWxldGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiRGVzY3JpYmVJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInNoYXBlIjogIlN2IgogICAgICB9CiAgICB9LAogICAgIkRlc2NyaWJlSWRlbnRpdHlQb29sIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgfQogICAgfSwKICAgICJHZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMTAiCiAgICAgICAgICB9LAogICAgICAgICAgIkN1c3RvbVJvbGVBcm4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgIkFjY2Vzc0tleUlkIjoge30sCiAgICAgICAgICAgICAgIlNlY3JldEtleSI6IHt9LAogICAgICAgICAgICAgICJTZXNzaW9uVG9rZW4iOiB7fSwKICAgICAgICAgICAgICAiRXhwaXJhdGlvbiI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJhdXRodHlwZSI6ICJub25lIgogICAgfSwKICAgICJHZXRJZCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQWNjb3VudElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMTAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAiYXV0aHR5cGUiOiAibm9uZSIKICAgIH0sCiAgICAiR2V0SWRlbnRpdHlQb29sUm9sZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIlJvbGVzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFjIgogICAgICAgICAgfSwKICAgICAgICAgICJSb2xlTWFwcGluZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMWUiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldE9wZW5JZFRva2VuIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAgICJMb2dpbnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMTAiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIlRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJhdXRodHlwZSI6ICJub25lIgogICAgfSwKICAgICJHZXRPcGVuSWRUb2tlbkZvckRldmVsb3BlcklkZW50aXR5IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgIkxvZ2lucyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkxvZ2lucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxMCIKICAgICAgICAgIH0sCiAgICAgICAgICAiUHJpbmNpcGFsVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxcyIKICAgICAgICAgIH0sCiAgICAgICAgICAiVG9rZW5EdXJhdGlvbiI6IHsKICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiVG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRQcmluY2lwYWxUYWdBdHRyaWJ1dGVNYXAiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIsCiAgICAgICAgICAiSWRlbnRpdHlQcm92aWRlck5hbWUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UHJvdmlkZXJOYW1lIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiVXNlRGVmYXVsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9LAogICAgICAgICAgIlByaW5jaXBhbFRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMXMiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkxpc3RJZGVudGl0aWVzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIk1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIk5leHRUb2tlbiI6IHt9LAogICAgICAgICAgIkhpZGVEaXNhYmxlZCI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCI6IHt9LAogICAgICAgICAgIklkZW50aXRpZXMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTdiIKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJMaXN0SWRlbnRpdHlQb29scyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIk1heFJlc3VsdHMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJNYXhSZXN1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJOZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICAgICAgICJJZGVudGl0eVBvb2xOYW1lIjoge30KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiTGlzdFRhZ3NGb3JSZXNvdXJjZSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIlJlc291cmNlQXJuIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiUmVzb3VyY2VBcm4iOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiTG9va3VwRGV2ZWxvcGVySWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJJZGVudGl0eVBvb2xJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAiTWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiTmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXJMaXN0IjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgIk5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIk1lcmdlRGV2ZWxvcGVySWRlbnRpdGllcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIlNvdXJjZVVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIiwKICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiLAogICAgICAgICAgIklkZW50aXR5UG9vbElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiU291cmNlVXNlcklkZW50aWZpZXIiOiB7fSwKICAgICAgICAgICJEZXN0aW5hdGlvblVzZXJJZGVudGlmaWVyIjoge30sCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5SWQiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTZXRJZGVudGl0eVBvb2xSb2xlcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJSb2xlcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiUm9sZXMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMWMiCiAgICAgICAgICB9LAogICAgICAgICAgIlJvbGVNYXBwaW5ncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxZSIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU2V0UHJpbmNpcGFsVGFnQXR0cmlidXRlTWFwIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiLAogICAgICAgICAgIklkZW50aXR5UHJvdmlkZXJOYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlQb29sSWQiOiB7fSwKICAgICAgICAgICJJZGVudGl0eVByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIlVzZURlZmF1bHRzIjogewogICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgfSwKICAgICAgICAgICJQcmluY2lwYWxUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzFzIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiSWRlbnRpdHlQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAgICJVc2VEZWZhdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiUHJpbmNpcGFsVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMxcyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiVGFnUmVzb3VyY2UiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJSZXNvdXJjZUFybiIsCiAgICAgICAgICAiVGFncyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlJlc291cmNlQXJuIjoge30sCiAgICAgICAgICAiVGFncyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJVbmxpbmtEZXZlbG9wZXJJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWQiLAogICAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiLAogICAgICAgICAgIkRldmVsb3BlclVzZXJJZGVudGlmaWVyIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiSWRlbnRpdHlJZCI6IHt9LAogICAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgICAiRGV2ZWxvcGVyUHJvdmlkZXJOYW1lIjoge30sCiAgICAgICAgICAiRGV2ZWxvcGVyVXNlcklkZW50aWZpZXIiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJVbmxpbmtJZGVudGl0eSI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIklkZW50aXR5SWQiLAogICAgICAgICAgIkxvZ2lucyIsCiAgICAgICAgICAiTG9naW5zVG9SZW1vdmUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJJZGVudGl0eUlkIjoge30sCiAgICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzEwIgogICAgICAgICAgfSwKICAgICAgICAgICJMb2dpbnNUb1JlbW92ZSI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlN3IgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgImF1dGh0eXBlIjogIm5vbmUiCiAgICB9LAogICAgIlVudGFnUmVzb3VyY2UiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJSZXNvdXJjZUFybiIsCiAgICAgICAgICAiVGFnS2V5cyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlJlc291cmNlQXJuIjoge30sCiAgICAgICAgICAiVGFnS2V5cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJVcGRhdGVJZGVudGl0eVBvb2wiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInNoYXBlIjogIlNrIgogICAgICB9CiAgICB9CiAgfSwKICAic2hhcGVzIjogewogICAgIlM1IjogewogICAgICAidHlwZSI6ICJtYXAiLAogICAgICAia2V5Ijoge30sCiAgICAgICJ2YWx1ZSI6IHt9CiAgICB9LAogICAgIlM5IjogewogICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgIm1lbWJlciI6IHt9CiAgICB9LAogICAgIlNiIjogewogICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgIm1lbWJlciI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlByb3ZpZGVyTmFtZSI6IHt9LAogICAgICAgICAgIkNsaWVudElkIjoge30sCiAgICAgICAgICAiU2VydmVyU2lkZVRva2VuQ2hlY2siOiB7CiAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlNnIjogewogICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgIm1lbWJlciI6IHt9CiAgICB9LAogICAgIlNoIjogewogICAgICAidHlwZSI6ICJtYXAiLAogICAgICAia2V5Ijoge30sCiAgICAgICJ2YWx1ZSI6IHt9CiAgICB9LAogICAgIlNrIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgIklkZW50aXR5UG9vbElkIiwKICAgICAgICAiSWRlbnRpdHlQb29sTmFtZSIsCiAgICAgICAgIkFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyIKICAgICAgXSwKICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgIklkZW50aXR5UG9vbElkIjoge30sCiAgICAgICAgIklkZW50aXR5UG9vbE5hbWUiOiB7fSwKICAgICAgICAiQWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzIjogewogICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICB9LAogICAgICAgICJBbGxvd0NsYXNzaWNGbG93IjogewogICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICB9LAogICAgICAgICJTdXBwb3J0ZWRMb2dpblByb3ZpZGVycyI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTNSIKICAgICAgICB9LAogICAgICAgICJEZXZlbG9wZXJQcm92aWRlck5hbWUiOiB7fSwKICAgICAgICAiT3BlbklkQ29ubmVjdFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTOSIKICAgICAgICB9LAogICAgICAgICJDb2duaXRvSWRlbnRpdHlQcm92aWRlcnMiOiB7CiAgICAgICAgICAic2hhcGUiOiAiU2IiCiAgICAgICAgfSwKICAgICAgICAiU2FtbFByb3ZpZGVyQVJOcyI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTZyIKICAgICAgICB9LAogICAgICAgICJJZGVudGl0eVBvb2xUYWdzIjogewogICAgICAgICAgInNoYXBlIjogIlNoIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTdiI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgIklkZW50aXR5SWQiOiB7fSwKICAgICAgICAiTG9naW5zIjogewogICAgICAgICAgInNoYXBlIjogIlN3IgogICAgICAgIH0sCiAgICAgICAgIkNyZWF0aW9uRGF0ZSI6IHsKICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICB9LAogICAgICAgICJMYXN0TW9kaWZpZWREYXRlIjogewogICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTdyI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7fQogICAgfSwKICAgICJTMTAiOiB7CiAgICAgICJ0eXBlIjogIm1hcCIsCiAgICAgICJrZXkiOiB7fSwKICAgICAgInZhbHVlIjoge30KICAgIH0sCiAgICAiUzFjIjogewogICAgICAidHlwZSI6ICJtYXAiLAogICAgICAia2V5Ijoge30sCiAgICAgICJ2YWx1ZSI6IHt9CiAgICB9LAogICAgIlMxZSI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiVHlwZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIlR5cGUiOiB7fSwKICAgICAgICAgICJBbWJpZ3VvdXNSb2xlUmVzb2x1dGlvbiI6IHt9LAogICAgICAgICAgIlJ1bGVzQ29uZmlndXJhdGlvbiI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICJSdWxlcyIKICAgICAgICAgICAgXSwKICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgIlJ1bGVzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgIkNsYWltIiwKICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIiwKICAgICAgICAgICAgICAgICAgICAiVmFsdWUiLAogICAgICAgICAgICAgICAgICAgICJSb2xlQVJOIgogICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAiQ2xhaW0iOiB7fSwKICAgICAgICAgICAgICAgICAgICAiTWF0Y2hUeXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgIlZhbHVlIjoge30sCiAgICAgICAgICAgICAgICAgICAgIlJvbGVBUk4iOiB7fQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlMxcyI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7fQogICAgfQogIH0KfQp9LHt9XSwyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJwYWdpbmF0aW9uIjogewogICAgIkxpc3RJZGVudGl0eVBvb2xzIjogewogICAgICAiaW5wdXRfdG9rZW4iOiAiTmV4dFRva2VuIiwKICAgICAgImxpbWl0X2tleSI6ICJNYXhSZXN1bHRzIiwKICAgICAgIm91dHB1dF90b2tlbiI6ICJOZXh0VG9rZW4iLAogICAgICAicmVzdWx0X2tleSI6ICJJZGVudGl0eVBvb2xzIgogICAgfQogIH0KfQp9LHt9XSwzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJ2ZXJzaW9uIjogIjIuMCIsCiAgIm1ldGFkYXRhIjogewogICAgImFwaVZlcnNpb24iOiAiMjAxNy0wMi0xNSIsCiAgICAiZW5kcG9pbnRQcmVmaXgiOiAiY29ubmVjdCIsCiAgICAianNvblZlcnNpb24iOiAiMS4wIiwKICAgICJwcm90b2NvbCI6ICJqc29uIiwKICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkNvbm5lY3QiLAogICAgInNlcnZpY2VGdWxsTmFtZSI6ICJBbWF6b25Db25uZWN0Q1RJU2VydmljZSIsCiAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICIiLAogICAgInRhcmdldFByZWZpeCI6ICJBbWF6b25Db25uZWN0Q1RJU2VydmljZSIsCiAgICAidWlkIjogImNvbm5lY3QtMjAxNy0wMi0xNSIKICB9LAogICJvcGVyYXRpb25zIjogewogICAgIkFjY2VwdENvbnRhY3QiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiQ2xlYXJDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiY29udGFjdElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiQ29tcGxldGVDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiY29udGFjdElkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiQ29uZmVyZW5jZUNvbm5lY3Rpb25zIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNyZWF0ZUFkZGl0aW9uYWxDb25uZWN0aW9uIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAiZW5kcG9pbnQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJDcmVhdGVPdXRib3VuZENvbnRhY3QiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiZW5kcG9pbnQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgfSwKICAgICAgICAgICJxdWV1ZUFSTiI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkNyZWF0ZVRhc2tDb250YWN0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiZW5kcG9pbnQiLAogICAgICAgICAgIm5hbWUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNlIgogICAgICAgICAgfSwKICAgICAgICAgICJwcmV2aW91c0NvbnRhY3RJZCI6IHt9LAogICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICJkZXNjcmlwdGlvbiI6IHt9LAogICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTciIKICAgICAgICAgIH0sCiAgICAgICAgICAiaWRlbXBvdGVuY3lUb2tlbiI6IHt9LAogICAgICAgICAgInNjaGVkdWxlZFRpbWUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiY29udGFjdElkIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiQ3JlYXRlVHJhbnNwb3J0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidHJhbnNwb3J0VHlwZSIsCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJ0cmFuc3BvcnRUeXBlIjoge30sCiAgICAgICAgICAicGFydGljaXBhbnRJZCI6IHt9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgInNvZnRwaG9uZUNsaWVudElkIjoge30sCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJ3ZWJTb2NrZXRUcmFuc3BvcnQiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAidXJsIiwKICAgICAgICAgICAgICAidHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMiCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJ1cmwiOiB7fSwKICAgICAgICAgICAgICAidHJhbnNwb3J0TGlmZVRpbWVJblNlY29uZHMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImV4cGlyeSI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAiY2hhdFRva2VuVHJhbnNwb3J0IjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgInBhcnRpY2lwYW50VG9rZW4iLAogICAgICAgICAgICAgICJleHBpcnkiCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJwYXJ0aWNpcGFudFRva2VuIjoge30sCiAgICAgICAgICAgICAgImV4cGlyeSI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAic29mdHBob25lVHJhbnNwb3J0IjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMiCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICJzb2Z0cGhvbmVNZWRpYUNvbm5lY3Rpb25zIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIiwKICAgICAgICAgICAgICAgICAgICAiY3JlZGVudGlhbCIsCiAgICAgICAgICAgICAgICAgICAgInVybHMiCiAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSI6IHt9LAogICAgICAgICAgICAgICAgICAgICJjcmVkZW50aWFsIjoge30sCiAgICAgICAgICAgICAgICAgICAgInVybHMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJEZXN0cm95Q29ubmVjdGlvbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJjb250YWN0SWQiLAogICAgICAgICAgImNvbm5lY3Rpb25JZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIkdldEFnZW50Q29uZmlndXJhdGlvbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiY29uZmlndXJhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMWgiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldEFnZW50UGVybWlzc2lvbnMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInBlcm1pc3Npb25zIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAicGVybWlzc2lvbnMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0QWdlbnRTbmFwc2hvdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAidGltZW91dCI6IHsKICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAic25hcHNob3QiLAogICAgICAgICAgIm5leHRUb2tlbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInNuYXBzaG90IjogewogICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgInN0YXRlIiwKICAgICAgICAgICAgICAiY29udGFjdHMiLAogICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCIKICAgICAgICAgICAgXSwKICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgInN0YXRlIjogewogICAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJuZXh0U3RhdGUiOiB7CiAgICAgICAgICAgICAgICAic2hhcGUiOiAiUzIwIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImFnZW50QXZhaWxhYmlsaXR5U3RhdGUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHt9LAogICAgICAgICAgICAgICAgICAidGltZVN0YW1wIjogewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNvbnRhY3RzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAgICAgICAgICAgInR5cGUiLAogICAgICAgICAgICAgICAgICAgICJzdGF0ZSIsCiAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25zIiwKICAgICAgICAgICAgICAgICAgICAiYXR0cmlidXRlcyIKICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICJpbml0aWFsQ29udGFjdElkIjoge30sCiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICBdLAogICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAicXVldWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAicXVldWVUaW1lc3RhbXAiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbklkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAiaW5pdGlhbCIKICAgICAgICAgICAgICAgICAgICAgICAgXSwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgImNvbm5lY3Rpb25JZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJlbmRwb2ludCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgImluaXRpYWwiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInNvZnRwaG9uZU1lZGlhSW5mbyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxUeXBlIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhdXRvQWNjZXB0IjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZWRpYUxlZ0NvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbENvbnRleHRUb2tlbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY2FsbENvbmZpZ0pzb24iOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgImNoYXRNZWRpYUluZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjaGF0QXV0b0FjY2VwdCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29ubmVjdGlvbkRhdGEiOiB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImN1c3RvbWVyTmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAibW9uaXRvcmluZ0luZm8iOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhZ2VudCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFnZW50TmFtZSI6IHt9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9pblRpbWVTdGFtcCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJtdXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJmb3JjZWRNdXRlIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICJxdWlja0Nvbm5lY3ROYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1vbml0b3JDYXBhYmlsaXRpZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXIiOiB7fQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImF0dHJpYnV0ZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJtYXAiLAogICAgICAgICAgICAgICAgICAgICAgImtleSI6IHt9LAogICAgICAgICAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm5hbWUiCiAgICAgICAgICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICAgICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgInZhbHVlIjoge30KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgImNvbnRhY3REdXJhdGlvbiI6IHt9LAogICAgICAgICAgICAgICAgICAgICJuYW1lIjoge30sCiAgICAgICAgICAgICAgICAgICAgImRlc2NyaXB0aW9uIjoge30sCiAgICAgICAgICAgICAgICAgICAgInJlZmVyZW5jZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAic2hhcGUiOiAiU3IiCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAiaW5pdGlhdGlvbk1ldGhvZCI6IHt9LAogICAgICAgICAgICAgICAgICAgICJjb250YWN0RmVhdHVyZXMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJhdHRhY2htZW50c0VuYWJsZWQiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2luZ01hcmtkb3duRW5hYmxlZCI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAibXVsdGlQYXJ0eUNvbmZlcmVuY2VFbmFibGVkIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICJjaGFubmVsQ29udGV4dCI6IHsKICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAgICAgICAgICAgInNjaGVkdWxlZFRpbWUiOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgInRhc2tUZW1wbGF0ZUlkIjoge30sCiAgICAgICAgICAgICAgICAgICAgICAgICJ0YXNrVGVtcGxhdGVWZXJzaW9uIjogewogICAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJzbmFwc2hvdFRpbWVzdGFtcCI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0QWdlbnRTdGF0ZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInN0YXRlcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInN0YXRlcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXREaWFsYWJsZUNvdW50cnlDb2RlcyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiY291bnRyeUNvZGVzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiY291bnRyeUNvZGVzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldEVuZHBvaW50cyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJxdWV1ZUFSTnMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJxdWV1ZUFSTnMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjoge30KICAgICAgICAgIH0sCiAgICAgICAgICAibmV4dFRva2VuIjoge30sCiAgICAgICAgICAibWF4UmVzdWx0cyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJlbmRwb2ludHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICJzaGFwZSI6ICJTZSIKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgICJuZXh0VG9rZW4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXROZXdBdXRoVG9rZW4iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAicmVmcmVzaFRva2VuIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAicmVmcmVzaFRva2VuIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJuZXdBdXRoVG9rZW4iOiB7fSwKICAgICAgICAgICJleHBpcmF0aW9uRGF0ZVRpbWUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInRpbWVzdGFtcCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0Um91dGluZ1Byb2ZpbGVRdWV1ZXMiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAicm91dGluZ1Byb2ZpbGVBUk4iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJyb3V0aW5nUHJvZmlsZUFSTiI6IHt9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9LAogICAgICAgICAgIm1heFJlc3VsdHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgInF1ZXVlcyIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgInF1ZXVlcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgICAgICAgInNoYXBlIjogIlNrIgogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgIm5leHRUb2tlbiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkhvbGRDb25uZWN0aW9uIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiTXV0ZVBhcnRpY2lwYW50IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiTm90aWZ5Q29udGFjdElzc3VlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgImlzc3VlQ29kZSI6IHt9LAogICAgICAgICAgImRlc2NyaXB0aW9uIjoge30sCiAgICAgICAgICAiY2xpZW50TG9ncyI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlB1dEFnZW50U3RhdGUiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAic3RhdGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyMCIKICAgICAgICAgIH0sCiAgICAgICAgICAiZW5xdWV1ZU5leHRTdGF0ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiUmVqZWN0Q29udGFjdCI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImNvbnRhY3RJZCIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlJlc3VtZUNvbm5lY3Rpb24iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJTZW5kQ2xpZW50TG9ncyI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIiwKICAgICAgICAgICJsb2dFdmVudHMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJsb2dFdmVudHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAgICAgICAibWVtYmVyIjogewogICAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgImNvbXBvbmVudCI6IHt9LAogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiB7fQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJTZW5kRGlnaXRzIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAiY29ubmVjdGlvbklkIiwKICAgICAgICAgICJkaWdpdHMiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fSwKICAgICAgICAgICJkaWdpdHMiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJTZW5kU29mdHBob25lQ2FsbE1ldHJpY3MiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJzb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTM3YiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlNlbmRTb2Z0cGhvbmVDYWxsUmVwb3J0IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAicmVwb3J0IgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY2NwVmVyc2lvbiI6IHt9LAogICAgICAgICAgInJlcG9ydCI6IHsKICAgICAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAgICAgImNhbGxTdGFydFRpbWUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiY2FsbEVuZFRpbWUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAic29mdHBob25lU3RyZWFtU3RhdGlzdGljcyI6IHsKICAgICAgICAgICAgICAgICJzaGFwZSI6ICJTM3YiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiZ3VtVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAiaW5pdGlhbGl6YXRpb25UaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJoYW5kc2hha2VUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJwcmVUYWxrVGltZU1pbGxpcyI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAidGFsa1RpbWVNaWxsaXMiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImNsZWFudXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJpY2VDb2xsZWN0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAic2lnbmFsbGluZ0Nvbm5lY3Rpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJoYW5kc2hha2VGYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJndW1PdGhlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImd1bVRpbWVvdXRGYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJjcmVhdGVPZmZlckZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInNldExvY2FsRGVzY3JpcHRpb25GYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJ1c2VyQnVzeUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgImludmFsaWRSZW1vdGVTRFBGYWlsdXJlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAiYm9vbGVhbiIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICJub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmUiOiB7CiAgICAgICAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgInNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZSI6IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogImJvb2xlYW4iCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlRvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiYXV0aGVudGljYXRpb24iLAogICAgICAgICAgImNvbnRhY3RJZCIsCiAgICAgICAgICAiY29ubmVjdGlvbklkIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiYXV0aGVudGljYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMiIKICAgICAgICAgIH0sCiAgICAgICAgICAiY29udGFjdElkIjoge30sCiAgICAgICAgICAiY29ubmVjdGlvbklkIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0sCiAgICAiVW5tdXRlUGFydGljaXBhbnQiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJjb25uZWN0aW9uSWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlMyIgogICAgICAgICAgfSwKICAgICAgICAgICJjb250YWN0SWQiOiB7fSwKICAgICAgICAgICJjb25uZWN0aW9uSWQiOiB7fQogICAgICAgIH0KICAgICAgfSwKICAgICAgIm91dHB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjoge30KICAgICAgfQogICAgfSwKICAgICJVcGRhdGVBZ2VudENvbmZpZ3VyYXRpb24iOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJhdXRoZW50aWNhdGlvbiIsCiAgICAgICAgICAiY29uZmlndXJhdGlvbiIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImF1dGhlbnRpY2F0aW9uIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzIiCiAgICAgICAgICB9LAogICAgICAgICAgImNvbmZpZ3VyYXRpb24iOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTMWgiCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7fQogICAgICB9CiAgICB9LAogICAgIlVwZGF0ZU1vbml0b3JQYXJ0aWNpcGFudFN0YXRlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiY29udGFjdElkIiwKICAgICAgICAgICJ0YXJnZXRNb25pdG9yTW9kZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgImNvbnRhY3RJZCI6IHt9LAogICAgICAgICAgInRhcmdldE1vbml0b3JNb2RlIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0KICAgIH0KICB9LAogICJzaGFwZXMiOiB7CiAgICAiUzIiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJhZ2VudEFSTiI6IHt9LAogICAgICAgICJhdXRoVG9rZW4iOiB7fQogICAgICB9CiAgICB9LAogICAgIlNlIjogewogICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgInR5cGUiCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJlbmRwb2ludEFSTiI6IHt9LAogICAgICAgICJ0eXBlIjoge30sCiAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAicGhvbmVOdW1iZXIiOiB7fSwKICAgICAgICAiYWdlbnRMb2dpbiI6IHt9LAogICAgICAgICJxdWV1ZSI6IHsKICAgICAgICAgICJzaGFwZSI6ICJTayIKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU2siOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJxdWV1ZUFSTiI6IHt9LAogICAgICAgICJuYW1lIjoge30KICAgICAgfQogICAgfSwKICAgICJTciI6IHsKICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgImtleSI6IHt9LAogICAgICAidmFsdWUiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAidmFsdWUiLAogICAgICAgICAgInR5cGUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJ2YWx1ZSI6IHt9LAogICAgICAgICAgInR5cGUiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTMWgiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAibmFtZSIsCiAgICAgICAgInNvZnRwaG9uZUVuYWJsZWQiLAogICAgICAgICJzb2Z0cGhvbmVBdXRvQWNjZXB0IiwKICAgICAgICAiZXh0ZW5zaW9uIiwKICAgICAgICAicm91dGluZ1Byb2ZpbGUiCiAgICAgIF0sCiAgICAgICJtZW1iZXJzIjogewogICAgICAgICJuYW1lIjoge30sCiAgICAgICAgInVzZXJuYW1lIjoge30sCiAgICAgICAgInNvZnRwaG9uZUVuYWJsZWQiOiB7CiAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgIH0sCiAgICAgICAgInNvZnRwaG9uZUF1dG9BY2NlcHQiOiB7CiAgICAgICAgICAidHlwZSI6ICJib29sZWFuIgogICAgICAgIH0sCiAgICAgICAgImV4dGVuc2lvbiI6IHt9LAogICAgICAgICJyb3V0aW5nUHJvZmlsZSI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgIm5hbWUiOiB7fSwKICAgICAgICAgICAgInJvdXRpbmdQcm9maWxlQVJOIjoge30sCiAgICAgICAgICAgICJkZWZhdWx0T3V0Ym91bmRRdWV1ZSI6IHsKICAgICAgICAgICAgICAic2hhcGUiOiAiU2siCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJjaGFubmVsQ29uY3VycmVuY3lNYXAiOiB7CiAgICAgICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICAgICAia2V5Ijoge30sCiAgICAgICAgICAgICAgInZhbHVlIjogewogICAgICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgICJhZ2VudFByZWZlcmVuY2VzIjogewogICAgICAgICAgInR5cGUiOiAibWFwIiwKICAgICAgICAgICJrZXkiOiB7fSwKICAgICAgICAgICJ2YWx1ZSI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIlMyMCI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICJ0eXBlIiwKICAgICAgICAibmFtZSIKICAgICAgXSwKICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgImFnZW50U3RhdGVBUk4iOiB7fSwKICAgICAgICAidHlwZSI6IHt9LAogICAgICAgICJuYW1lIjoge30sCiAgICAgICAgInN0YXJ0VGltZXN0YW1wIjogewogICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTM3YiOiB7CiAgICAgICJ0eXBlIjogImxpc3QiLAogICAgICAibWVtYmVyIjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAidGltZXN0YW1wIjogewogICAgICAgICAgICAidHlwZSI6ICJ0aW1lc3RhbXAiCiAgICAgICAgICB9LAogICAgICAgICAgInNvZnRwaG9uZVN0cmVhbVR5cGUiOiB7fSwKICAgICAgICAgICJwYWNrZXRDb3VudCI6IHsKICAgICAgICAgICAgInR5cGUiOiAibG9uZyIKICAgICAgICAgIH0sCiAgICAgICAgICAicGFja2V0c0xvc3QiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImxvbmciCiAgICAgICAgICB9LAogICAgICAgICAgImF1ZGlvTGV2ZWwiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImRvdWJsZSIKICAgICAgICAgIH0sCiAgICAgICAgICAiaml0dGVyQnVmZmVyTWlsbGlzIjogewogICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgfSwKICAgICAgICAgICJyb3VuZFRyaXBUaW1lTWlsbGlzIjogewogICAgICAgICAgICAidHlwZSI6ICJsb25nIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KfQp9LHt9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHM9ewogICJhY20iOiB7CiAgICAibmFtZSI6ICJBQ00iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYXBpZ2F0ZXdheSI6IHsKICAgICJuYW1lIjogIkFQSUdhdGV3YXkiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiYXBwbGljYXRpb25hdXRvc2NhbGluZyI6IHsKICAgICJwcmVmaXgiOiAiYXBwbGljYXRpb24tYXV0b3NjYWxpbmciLAogICAgIm5hbWUiOiAiQXBwbGljYXRpb25BdXRvU2NhbGluZyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJhcHBzdHJlYW0iOiB7CiAgICAibmFtZSI6ICJBcHBTdHJlYW0iCiAgfSwKICAiYXV0b3NjYWxpbmciOiB7CiAgICAibmFtZSI6ICJBdXRvU2NhbGluZyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJiYXRjaCI6IHsKICAgICJuYW1lIjogIkJhdGNoIgogIH0sCiAgImJ1ZGdldHMiOiB7CiAgICAibmFtZSI6ICJCdWRnZXRzIgogIH0sCiAgImNsb3VkZGlyZWN0b3J5IjogewogICAgIm5hbWUiOiAiQ2xvdWREaXJlY3RvcnkiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxNi0wNS0xMCoiCiAgICBdCiAgfSwKICAiY2xvdWRmb3JtYXRpb24iOiB7CiAgICAibmFtZSI6ICJDbG91ZEZvcm1hdGlvbiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb25uZWN0IjogewogICAibmFtZSI6ICJDb25uZWN0IiwKICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY2xvdWRmcm9udCI6IHsKICAgICJuYW1lIjogIkNsb3VkRnJvbnQiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxMy0wNS0xMioiLAogICAgICAiMjAxMy0xMS0xMSoiLAogICAgICAiMjAxNC0wNS0zMSoiLAogICAgICAiMjAxNC0xMC0yMSoiLAogICAgICAiMjAxNC0xMS0wNioiLAogICAgICAiMjAxNS0wNC0xNyoiLAogICAgICAiMjAxNS0wNy0yNyoiLAogICAgICAiMjAxNS0wOS0xNyoiLAogICAgICAiMjAxNi0wMS0xMyoiLAogICAgICAiMjAxNi0wMS0yOCoiLAogICAgICAiMjAxNi0wOC0wMSoiLAogICAgICAiMjAxNi0wOC0yMCoiLAogICAgICAiMjAxNi0wOS0wNyoiLAogICAgICAiMjAxNi0wOS0yOSoiLAogICAgICAiMjAxNi0xMS0yNSoiLAogICAgICAiMjAxNy0wMy0yNSoiLAogICAgICAiMjAxNy0xMC0zMCoiLAogICAgICAiMjAxOC0wNi0xOCoiLAogICAgICAiMjAxOC0xMS0wNSoiLAogICAgICAiMjAxOS0wMy0yNioiCiAgICBdLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY2xvdWRoc20iOiB7CiAgICAibmFtZSI6ICJDbG91ZEhTTSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjbG91ZHNlYXJjaCI6IHsKICAgICJuYW1lIjogIkNsb3VkU2VhcmNoIgogIH0sCiAgImNsb3Vkc2VhcmNoZG9tYWluIjogewogICAgIm5hbWUiOiAiQ2xvdWRTZWFyY2hEb21haW4iCiAgfSwKICAiY2xvdWR0cmFpbCI6IHsKICAgICJuYW1lIjogIkNsb3VkVHJhaWwiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY2xvdWR3YXRjaCI6IHsKICAgICJwcmVmaXgiOiAibW9uaXRvcmluZyIsCiAgICAibmFtZSI6ICJDbG91ZFdhdGNoIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNsb3Vkd2F0Y2hldmVudHMiOiB7CiAgICAicHJlZml4IjogImV2ZW50cyIsCiAgICAibmFtZSI6ICJDbG91ZFdhdGNoRXZlbnRzIiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTQtMDItMDMqIgogICAgXSwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNsb3Vkd2F0Y2hsb2dzIjogewogICAgInByZWZpeCI6ICJsb2dzIiwKICAgICJuYW1lIjogIkNsb3VkV2F0Y2hMb2dzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvZGVidWlsZCI6IHsKICAgICJuYW1lIjogIkNvZGVCdWlsZCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb2RlY29tbWl0IjogewogICAgIm5hbWUiOiAiQ29kZUNvbW1pdCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb2RlZGVwbG95IjogewogICAgIm5hbWUiOiAiQ29kZURlcGxveSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb2RlcGlwZWxpbmUiOiB7CiAgICAibmFtZSI6ICJDb2RlUGlwZWxpbmUiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiY29nbml0b2lkZW50aXR5IjogewogICAgInByZWZpeCI6ICJjb2duaXRvLWlkZW50aXR5IiwKICAgICJuYW1lIjogIkNvZ25pdG9JZGVudGl0eSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb2duaXRvaWRlbnRpdHlzZXJ2aWNlcHJvdmlkZXIiOiB7CiAgICAicHJlZml4IjogImNvZ25pdG8taWRwIiwKICAgICJuYW1lIjogIkNvZ25pdG9JZGVudGl0eVNlcnZpY2VQcm92aWRlciIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb2duaXRvc3luYyI6IHsKICAgICJwcmVmaXgiOiAiY29nbml0by1zeW5jIiwKICAgICJuYW1lIjogIkNvZ25pdG9TeW5jIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImNvbmZpZ3NlcnZpY2UiOiB7CiAgICAicHJlZml4IjogImNvbmZpZyIsCiAgICAibmFtZSI6ICJDb25maWdTZXJ2aWNlIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImN1ciI6IHsKICAgICJuYW1lIjogIkNVUiIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJkYXRhcGlwZWxpbmUiOiB7CiAgICAibmFtZSI6ICJEYXRhUGlwZWxpbmUiCiAgfSwKICAiZGV2aWNlZmFybSI6IHsKICAgICJuYW1lIjogIkRldmljZUZhcm0iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZGlyZWN0Y29ubmVjdCI6IHsKICAgICJuYW1lIjogIkRpcmVjdENvbm5lY3QiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZGlyZWN0b3J5c2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAiZHMiLAogICAgIm5hbWUiOiAiRGlyZWN0b3J5U2VydmljZSIKICB9LAogICJkaXNjb3ZlcnkiOiB7CiAgICAibmFtZSI6ICJEaXNjb3ZlcnkiCiAgfSwKICAiZG1zIjogewogICAgIm5hbWUiOiAiRE1TIgogIH0sCiAgImR5bmFtb2RiIjogewogICAgIm5hbWUiOiAiRHluYW1vREIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZHluYW1vZGJzdHJlYW1zIjogewogICAgInByZWZpeCI6ICJzdHJlYW1zLmR5bmFtb2RiIiwKICAgICJuYW1lIjogIkR5bmFtb0RCU3RyZWFtcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlYzIiOiB7CiAgICAibmFtZSI6ICJFQzIiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxMy0wNi0xNSoiLAogICAgICAiMjAxMy0xMC0xNSoiLAogICAgICAiMjAxNC0wMi0wMSoiLAogICAgICAiMjAxNC0wNS0wMSoiLAogICAgICAiMjAxNC0wNi0xNSoiLAogICAgICAiMjAxNC0wOS0wMSoiLAogICAgICAiMjAxNC0xMC0wMSoiLAogICAgICAiMjAxNS0wMy0wMSoiLAogICAgICAiMjAxNS0wNC0xNSoiLAogICAgICAiMjAxNS0xMC0wMSoiLAogICAgICAiMjAxNi0wNC0wMSoiLAogICAgICAiMjAxNi0wOS0xNSoiCiAgICBdLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZWNyIjogewogICAgIm5hbWUiOiAiRUNSIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVjcyI6IHsKICAgICJuYW1lIjogIkVDUyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlZnMiOiB7CiAgICAicHJlZml4IjogImVsYXN0aWNmaWxlc3lzdGVtIiwKICAgICJuYW1lIjogIkVGUyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJlbGFzdGljYWNoZSI6IHsKICAgICJuYW1lIjogIkVsYXN0aUNhY2hlIiwKICAgICJ2ZXJzaW9ucyI6IFsKICAgICAgIjIwMTItMTEtMTUqIiwKICAgICAgIjIwMTQtMDMtMjQqIiwKICAgICAgIjIwMTQtMDctMTUqIiwKICAgICAgIjIwMTQtMDktMzAqIgogICAgXSwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVsYXN0aWNiZWFuc3RhbGsiOiB7CiAgICAibmFtZSI6ICJFbGFzdGljQmVhbnN0YWxrIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVsYiI6IHsKICAgICJwcmVmaXgiOiAiZWxhc3RpY2xvYWRiYWxhbmNpbmciLAogICAgIm5hbWUiOiAiRUxCIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVsYnYyIjogewogICAgInByZWZpeCI6ICJlbGFzdGljbG9hZGJhbGFuY2luZ3YyIiwKICAgICJuYW1lIjogIkVMQnYyIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImVtciI6IHsKICAgICJwcmVmaXgiOiAiZWxhc3RpY21hcHJlZHVjZSIsCiAgICAibmFtZSI6ICJFTVIiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZXMiOiB7CiAgICAibmFtZSI6ICJFUyIKICB9LAogICJlbGFzdGljdHJhbnNjb2RlciI6IHsKICAgICJuYW1lIjogIkVsYXN0aWNUcmFuc2NvZGVyIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImZpcmVob3NlIjogewogICAgIm5hbWUiOiAiRmlyZWhvc2UiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiZ2FtZWxpZnQiOiB7CiAgICAibmFtZSI6ICJHYW1lTGlmdCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJnbGFjaWVyIjogewogICAgIm5hbWUiOiAiR2xhY2llciIKICB9LAogICJoZWFsdGgiOiB7CiAgICAibmFtZSI6ICJIZWFsdGgiCiAgfSwKICAiaWFtIjogewogICAgIm5hbWUiOiAiSUFNIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImltcG9ydGV4cG9ydCI6IHsKICAgICJuYW1lIjogIkltcG9ydEV4cG9ydCIKICB9LAogICJpbnNwZWN0b3IiOiB7CiAgICAibmFtZSI6ICJJbnNwZWN0b3IiLAogICAgInZlcnNpb25zIjogWwogICAgICAiMjAxNS0wOC0xOCoiCiAgICBdLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiaW90IjogewogICAgIm5hbWUiOiAiSW90IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImlvdGRhdGEiOiB7CiAgICAicHJlZml4IjogImlvdC1kYXRhIiwKICAgICJuYW1lIjogIklvdERhdGEiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAia2luZXNpcyI6IHsKICAgICJuYW1lIjogIktpbmVzaXMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAia2luZXNpc2FuYWx5dGljcyI6IHsKICAgICJuYW1lIjogIktpbmVzaXNBbmFseXRpY3MiCiAgfSwKICAia21zIjogewogICAgIm5hbWUiOiAiS01TIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImxhbWJkYSI6IHsKICAgICJuYW1lIjogIkxhbWJkYSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJsZXhydW50aW1lIjogewogICAgInByZWZpeCI6ICJydW50aW1lLmxleCIsCiAgICAibmFtZSI6ICJMZXhSdW50aW1lIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImxpZ2h0c2FpbCI6IHsKICAgICJuYW1lIjogIkxpZ2h0c2FpbCIKICB9LAogICJtYWNoaW5lbGVhcm5pbmciOiB7CiAgICAibmFtZSI6ICJNYWNoaW5lTGVhcm5pbmciLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibWFya2V0cGxhY2Vjb21tZXJjZWFuYWx5dGljcyI6IHsKICAgICJuYW1lIjogIk1hcmtldHBsYWNlQ29tbWVyY2VBbmFseXRpY3MiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibWFya2V0cGxhY2VtZXRlcmluZyI6IHsKICAgICJwcmVmaXgiOiAibWV0ZXJpbmdtYXJrZXRwbGFjZSIsCiAgICAibmFtZSI6ICJNYXJrZXRwbGFjZU1ldGVyaW5nIgogIH0sCiAgIm10dXJrIjogewogICAgInByZWZpeCI6ICJtdHVyay1yZXF1ZXN0ZXIiLAogICAgIm5hbWUiOiAiTVR1cmsiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibW9iaWxlYW5hbHl0aWNzIjogewogICAgIm5hbWUiOiAiTW9iaWxlQW5hbHl0aWNzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIm9wc3dvcmtzIjogewogICAgIm5hbWUiOiAiT3BzV29ya3MiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAib3Bzd29ya3NjbSI6IHsKICAgICJuYW1lIjogIk9wc1dvcmtzQ00iCiAgfSwKICAib3JnYW5pemF0aW9ucyI6IHsKICAgICJuYW1lIjogIk9yZ2FuaXphdGlvbnMiCiAgfSwKICAicGlucG9pbnQiOiB7CiAgICAibmFtZSI6ICJQaW5wb2ludCIKICB9LAogICJwb2xseSI6IHsKICAgICJuYW1lIjogIlBvbGx5IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInJkcyI6IHsKICAgICJuYW1lIjogIlJEUyIsCiAgICAidmVyc2lvbnMiOiBbCiAgICAgICIyMDE0LTA5LTAxKiIKICAgIF0sCiAgICAiY29ycyI6IHRydWUKICB9LAogICJyZWRzaGlmdCI6IHsKICAgICJuYW1lIjogIlJlZHNoaWZ0IiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInJla29nbml0aW9uIjogewogICAgIm5hbWUiOiAiUmVrb2duaXRpb24iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicmVzb3VyY2Vncm91cHN0YWdnaW5nYXBpIjogewogICAgIm5hbWUiOiAiUmVzb3VyY2VHcm91cHNUYWdnaW5nQVBJIgogIH0sCiAgInJvdXRlNTMiOiB7CiAgICAibmFtZSI6ICJSb3V0ZTUzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInJvdXRlNTNkb21haW5zIjogewogICAgIm5hbWUiOiAiUm91dGU1M0RvbWFpbnMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAiczMiOiB7CiAgICAibmFtZSI6ICJTMyIsCiAgICAiZHVhbHN0YWNrQXZhaWxhYmxlIjogdHJ1ZSwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInMzY29udHJvbCI6IHsKICAgICJuYW1lIjogIlMzQ29udHJvbCIsCiAgICAiZHVhbHN0YWNrQXZhaWxhYmxlIjogdHJ1ZSwKICAgICJ4bWxOb0RlZmF1bHRMaXN0cyI6IHRydWUKICB9LAogICJzZXJ2aWNlY2F0YWxvZyI6IHsKICAgICJuYW1lIjogIlNlcnZpY2VDYXRhbG9nIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInNlcyI6IHsKICAgICJwcmVmaXgiOiAiZW1haWwiLAogICAgIm5hbWUiOiAiU0VTIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInNoaWVsZCI6IHsKICAgICJuYW1lIjogIlNoaWVsZCIKICB9LAogICJzaW1wbGVkYiI6IHsKICAgICJwcmVmaXgiOiAic2RiIiwKICAgICJuYW1lIjogIlNpbXBsZURCIgogIH0sCiAgInNtcyI6IHsKICAgICJuYW1lIjogIlNNUyIKICB9LAogICJzbm93YmFsbCI6IHsKICAgICJuYW1lIjogIlNub3diYWxsIgogIH0sCiAgInNucyI6IHsKICAgICJuYW1lIjogIlNOUyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJzcXMiOiB7CiAgICAibmFtZSI6ICJTUVMiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic3NtIjogewogICAgIm5hbWUiOiAiU1NNIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInN0b3JhZ2VnYXRld2F5IjogewogICAgIm5hbWUiOiAiU3RvcmFnZUdhdGV3YXkiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAic3RlcGZ1bmN0aW9ucyI6IHsKICAgICJwcmVmaXgiOiAic3RhdGVzIiwKICAgICJuYW1lIjogIlN0ZXBGdW5jdGlvbnMiCiAgfSwKICAic3RzIjogewogICAgIm5hbWUiOiAiU1RTIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInN1cHBvcnQiOiB7CiAgICAibmFtZSI6ICJTdXBwb3J0IgogIH0sCiAgInN3ZiI6IHsKICAgICJuYW1lIjogIlNXRiIKICB9LAogICJ4cmF5IjogewogICAgIm5hbWUiOiAiWFJheSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJ3YWYiOiB7CiAgICAibmFtZSI6ICJXQUYiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAid2FmcmVnaW9uYWwiOiB7CiAgICAicHJlZml4IjogIndhZi1yZWdpb25hbCIsCiAgICAibmFtZSI6ICJXQUZSZWdpb25hbCIKICB9LAogICJ3b3JrZG9jcyI6IHsKICAgICJuYW1lIjogIldvcmtEb2NzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgIndvcmtzcGFjZXMiOiB7CiAgICAibmFtZSI6ICJXb3JrU3BhY2VzIgogIH0sCiAgImNvZGVzdGFyIjogewogICAgIm5hbWUiOiAiQ29kZVN0YXIiCiAgfSwKICAibGV4bW9kZWxidWlsZGluZ3NlcnZpY2UiOiB7CiAgICAicHJlZml4IjogImxleC1tb2RlbHMiLAogICAgIm5hbWUiOiAiTGV4TW9kZWxCdWlsZGluZ1NlcnZpY2UiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAibWFya2V0cGxhY2VlbnRpdGxlbWVudHNlcnZpY2UiOiB7CiAgICAicHJlZml4IjogImVudGl0bGVtZW50Lm1hcmtldHBsYWNlIiwKICAgICJuYW1lIjogIk1hcmtldHBsYWNlRW50aXRsZW1lbnRTZXJ2aWNlIgogIH0sCiAgImF0aGVuYSI6IHsKICAgICJuYW1lIjogIkF0aGVuYSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJncmVlbmdyYXNzIjogewogICAgIm5hbWUiOiAiR3JlZW5ncmFzcyIKICB9LAogICJkYXgiOiB7CiAgICAibmFtZSI6ICJEQVgiCiAgfSwKICAibWlncmF0aW9uaHViIjogewogICAgInByZWZpeCI6ICJBV1NNaWdyYXRpb25IdWIiLAogICAgIm5hbWUiOiAiTWlncmF0aW9uSHViIgogIH0sCiAgImNsb3VkaHNtdjIiOiB7CiAgICAibmFtZSI6ICJDbG91ZEhTTVYyIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImdsdWUiOiB7CiAgICAibmFtZSI6ICJHbHVlIgogIH0sCiAgIm1vYmlsZSI6IHsKICAgICJuYW1lIjogIk1vYmlsZSIKICB9LAogICJwcmljaW5nIjogewogICAgIm5hbWUiOiAiUHJpY2luZyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJjb3N0ZXhwbG9yZXIiOiB7CiAgICAicHJlZml4IjogImNlIiwKICAgICJuYW1lIjogIkNvc3RFeHBsb3JlciIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJtZWRpYWNvbnZlcnQiOiB7CiAgICAibmFtZSI6ICJNZWRpYUNvbnZlcnQiCiAgfSwKICAibWVkaWFsaXZlIjogewogICAgIm5hbWUiOiAiTWVkaWFMaXZlIgogIH0sCiAgIm1lZGlhcGFja2FnZSI6IHsKICAgICJuYW1lIjogIk1lZGlhUGFja2FnZSIKICB9LAogICJtZWRpYXN0b3JlIjogewogICAgIm5hbWUiOiAiTWVkaWFTdG9yZSIKICB9LAogICJtZWRpYXN0b3JlZGF0YSI6IHsKICAgICJwcmVmaXgiOiAibWVkaWFzdG9yZS1kYXRhIiwKICAgICJuYW1lIjogIk1lZGlhU3RvcmVEYXRhIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImFwcHN5bmMiOiB7CiAgICAibmFtZSI6ICJBcHBTeW5jIgogIH0sCiAgImd1YXJkZHV0eSI6IHsKICAgICJuYW1lIjogIkd1YXJkRHV0eSIKICB9LAogICJtcSI6IHsKICAgICJuYW1lIjogIk1RIgogIH0sCiAgImNvbXByZWhlbmQiOiB7CiAgICAibmFtZSI6ICJDb21wcmVoZW5kIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImlvdGpvYnNkYXRhcGxhbmUiOiB7CiAgICAicHJlZml4IjogImlvdC1qb2JzLWRhdGEiLAogICAgIm5hbWUiOiAiSW9USm9ic0RhdGFQbGFuZSIKICB9LAogICJraW5lc2lzdmlkZW9hcmNoaXZlZG1lZGlhIjogewogICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLWFyY2hpdmVkLW1lZGlhIiwKICAgICJuYW1lIjogIktpbmVzaXNWaWRlb0FyY2hpdmVkTWVkaWEiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAia2luZXNpc3ZpZGVvbWVkaWEiOiB7CiAgICAicHJlZml4IjogImtpbmVzaXMtdmlkZW8tbWVkaWEiLAogICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvTWVkaWEiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAia2luZXNpc3ZpZGVvIjogewogICAgIm5hbWUiOiAiS2luZXNpc1ZpZGVvIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInNhZ2VtYWtlcnJ1bnRpbWUiOiB7CiAgICAicHJlZml4IjogInJ1bnRpbWUuc2FnZW1ha2VyIiwKICAgICJuYW1lIjogIlNhZ2VNYWtlclJ1bnRpbWUiCiAgfSwKICAic2FnZW1ha2VyIjogewogICAgIm5hbWUiOiAiU2FnZU1ha2VyIgogIH0sCiAgInRyYW5zbGF0ZSI6IHsKICAgICJuYW1lIjogIlRyYW5zbGF0ZSIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJyZXNvdXJjZWdyb3VwcyI6IHsKICAgICJwcmVmaXgiOiAicmVzb3VyY2UtZ3JvdXBzIiwKICAgICJuYW1lIjogIlJlc291cmNlR3JvdXBzIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImFsZXhhZm9yYnVzaW5lc3MiOiB7CiAgICAibmFtZSI6ICJBbGV4YUZvckJ1c2luZXNzIgogIH0sCiAgImNsb3VkOSI6IHsKICAgICJuYW1lIjogIkNsb3VkOSIKICB9LAogICJzZXJ2ZXJsZXNzYXBwbGljYXRpb25yZXBvc2l0b3J5IjogewogICAgInByZWZpeCI6ICJzZXJ2ZXJsZXNzcmVwbyIsCiAgICAibmFtZSI6ICJTZXJ2ZXJsZXNzQXBwbGljYXRpb25SZXBvc2l0b3J5IgogIH0sCiAgInNlcnZpY2VkaXNjb3ZlcnkiOiB7CiAgICAibmFtZSI6ICJTZXJ2aWNlRGlzY292ZXJ5IgogIH0sCiAgIndvcmttYWlsIjogewogICAgIm5hbWUiOiAiV29ya01haWwiCiAgfSwKICAiYXV0b3NjYWxpbmdwbGFucyI6IHsKICAgICJwcmVmaXgiOiAiYXV0b3NjYWxpbmctcGxhbnMiLAogICAgIm5hbWUiOiAiQXV0b1NjYWxpbmdQbGFucyIKICB9LAogICJ0cmFuc2NyaWJlc2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAidHJhbnNjcmliZSIsCiAgICAibmFtZSI6ICJUcmFuc2NyaWJlU2VydmljZSIKICB9LAogICJjb25uZWN0IjogewogICAgIm5hbWUiOiAiQ29ubmVjdCIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJhY21wY2EiOiB7CiAgICAicHJlZml4IjogImFjbS1wY2EiLAogICAgIm5hbWUiOiAiQUNNUENBIgogIH0sCiAgImZtcyI6IHsKICAgICJuYW1lIjogIkZNUyIKICB9LAogICJzZWNyZXRzbWFuYWdlciI6IHsKICAgICJuYW1lIjogIlNlY3JldHNNYW5hZ2VyIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImlvdGFuYWx5dGljcyI6IHsKICAgICJuYW1lIjogIklvVEFuYWx5dGljcyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJpb3QxY2xpY2tkZXZpY2Vzc2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAiaW90MWNsaWNrLWRldmljZXMiLAogICAgIm5hbWUiOiAiSW9UMUNsaWNrRGV2aWNlc1NlcnZpY2UiCiAgfSwKICAiaW90MWNsaWNrcHJvamVjdHMiOiB7CiAgICAicHJlZml4IjogImlvdDFjbGljay1wcm9qZWN0cyIsCiAgICAibmFtZSI6ICJJb1QxQ2xpY2tQcm9qZWN0cyIKICB9LAogICJwaSI6IHsKICAgICJuYW1lIjogIlBJIgogIH0sCiAgIm5lcHR1bmUiOiB7CiAgICAibmFtZSI6ICJOZXB0dW5lIgogIH0sCiAgIm1lZGlhdGFpbG9yIjogewogICAgIm5hbWUiOiAiTWVkaWFUYWlsb3IiCiAgfSwKICAiZWtzIjogewogICAgIm5hbWUiOiAiRUtTIgogIH0sCiAgIm1hY2llIjogewogICAgIm5hbWUiOiAiTWFjaWUiCiAgfSwKICAiZGxtIjogewogICAgIm5hbWUiOiAiRExNIgogIH0sCiAgInNpZ25lciI6IHsKICAgICJuYW1lIjogIlNpZ25lciIKICB9LAogICJjaGltZSI6IHsKICAgICJuYW1lIjogIkNoaW1lIgogIH0sCiAgInBpbnBvaW50ZW1haWwiOiB7CiAgICAicHJlZml4IjogInBpbnBvaW50LWVtYWlsIiwKICAgICJuYW1lIjogIlBpbnBvaW50RW1haWwiCiAgfSwKICAicmFtIjogewogICAgIm5hbWUiOiAiUkFNIgogIH0sCiAgInJvdXRlNTNyZXNvbHZlciI6IHsKICAgICJuYW1lIjogIlJvdXRlNTNSZXNvbHZlciIKICB9LAogICJwaW5wb2ludHNtc3ZvaWNlIjogewogICAgInByZWZpeCI6ICJzbXMtdm9pY2UiLAogICAgIm5hbWUiOiAiUGlucG9pbnRTTVNWb2ljZSIKICB9LAogICJxdWlja3NpZ2h0IjogewogICAgIm5hbWUiOiAiUXVpY2tTaWdodCIKICB9LAogICJyZHNkYXRhc2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAicmRzLWRhdGEiLAogICAgIm5hbWUiOiAiUkRTRGF0YVNlcnZpY2UiCiAgfSwKICAiYW1wbGlmeSI6IHsKICAgICJuYW1lIjogIkFtcGxpZnkiCiAgfSwKICAiZGF0YXN5bmMiOiB7CiAgICAibmFtZSI6ICJEYXRhU3luYyIKICB9LAogICJyb2JvbWFrZXIiOiB7CiAgICAibmFtZSI6ICJSb2JvTWFrZXIiCiAgfSwKICAidHJhbnNmZXIiOiB7CiAgICAibmFtZSI6ICJUcmFuc2ZlciIKICB9LAogICJnbG9iYWxhY2NlbGVyYXRvciI6IHsKICAgICJuYW1lIjogIkdsb2JhbEFjY2VsZXJhdG9yIgogIH0sCiAgImNvbXByZWhlbmRtZWRpY2FsIjogewogICAgIm5hbWUiOiAiQ29tcHJlaGVuZE1lZGljYWwiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAia2luZXNpc2FuYWx5dGljc3YyIjogewogICAgIm5hbWUiOiAiS2luZXNpc0FuYWx5dGljc1YyIgogIH0sCiAgIm1lZGlhY29ubmVjdCI6IHsKICAgICJuYW1lIjogIk1lZGlhQ29ubmVjdCIKICB9LAogICJmc3giOiB7CiAgICAibmFtZSI6ICJGU3giCiAgfSwKICAic2VjdXJpdHlodWIiOiB7CiAgICAibmFtZSI6ICJTZWN1cml0eUh1YiIKICB9LAogICJhcHBtZXNoIjogewogICAgIm5hbWUiOiAiQXBwTWVzaCIsCiAgICAidmVyc2lvbnMiOiBbCiAgICAgICIyMDE4LTEwLTAxKiIKICAgIF0KICB9LAogICJsaWNlbnNlbWFuYWdlciI6IHsKICAgICJwcmVmaXgiOiAibGljZW5zZS1tYW5hZ2VyIiwKICAgICJuYW1lIjogIkxpY2Vuc2VNYW5hZ2VyIgogIH0sCiAgImthZmthIjogewogICAgIm5hbWUiOiAiS2Fma2EiCiAgfSwKICAiYXBpZ2F0ZXdheW1hbmFnZW1lbnRhcGkiOiB7CiAgICAibmFtZSI6ICJBcGlHYXRld2F5TWFuYWdlbWVudEFwaSIKICB9LAogICJhcGlnYXRld2F5djIiOiB7CiAgICAibmFtZSI6ICJBcGlHYXRld2F5VjIiCiAgfSwKICAiZG9jZGIiOiB7CiAgICAibmFtZSI6ICJEb2NEQiIKICB9LAogICJiYWNrdXAiOiB7CiAgICAibmFtZSI6ICJCYWNrdXAiCiAgfSwKICAid29ya2xpbmsiOiB7CiAgICAibmFtZSI6ICJXb3JrTGluayIKICB9LAogICJ0ZXh0cmFjdCI6IHsKICAgICJuYW1lIjogIlRleHRyYWN0IgogIH0sCiAgIm1hbmFnZWRibG9ja2NoYWluIjogewogICAgIm5hbWUiOiAiTWFuYWdlZEJsb2NrY2hhaW4iCiAgfSwKICAibWVkaWFwYWNrYWdldm9kIjogewogICAgInByZWZpeCI6ICJtZWRpYXBhY2thZ2Utdm9kIiwKICAgICJuYW1lIjogIk1lZGlhUGFja2FnZVZvZCIKICB9LAogICJncm91bmRzdGF0aW9uIjogewogICAgIm5hbWUiOiAiR3JvdW5kU3RhdGlvbiIKICB9LAogICJpb3R0aGluZ3NncmFwaCI6IHsKICAgICJuYW1lIjogIklvVFRoaW5nc0dyYXBoIgogIH0sCiAgImlvdGV2ZW50cyI6IHsKICAgICJuYW1lIjogIklvVEV2ZW50cyIKICB9LAogICJpb3RldmVudHNkYXRhIjogewogICAgInByZWZpeCI6ICJpb3RldmVudHMtZGF0YSIsCiAgICAibmFtZSI6ICJJb1RFdmVudHNEYXRhIgogIH0sCiAgInBlcnNvbmFsaXplIjogewogICAgIm5hbWUiOiAiUGVyc29uYWxpemUiLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAicGVyc29uYWxpemVldmVudHMiOiB7CiAgICAicHJlZml4IjogInBlcnNvbmFsaXplLWV2ZW50cyIsCiAgICAibmFtZSI6ICJQZXJzb25hbGl6ZUV2ZW50cyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJwZXJzb25hbGl6ZXJ1bnRpbWUiOiB7CiAgICAicHJlZml4IjogInBlcnNvbmFsaXplLXJ1bnRpbWUiLAogICAgIm5hbWUiOiAiUGVyc29uYWxpemVSdW50aW1lIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImFwcGxpY2F0aW9uaW5zaWdodHMiOiB7CiAgICAicHJlZml4IjogImFwcGxpY2F0aW9uLWluc2lnaHRzIiwKICAgICJuYW1lIjogIkFwcGxpY2F0aW9uSW5zaWdodHMiCiAgfSwKICAic2VydmljZXF1b3RhcyI6IHsKICAgICJwcmVmaXgiOiAic2VydmljZS1xdW90YXMiLAogICAgIm5hbWUiOiAiU2VydmljZVF1b3RhcyIKICB9LAogICJlYzJpbnN0YW5jZWNvbm5lY3QiOiB7CiAgICAicHJlZml4IjogImVjMi1pbnN0YW5jZS1jb25uZWN0IiwKICAgICJuYW1lIjogIkVDMkluc3RhbmNlQ29ubmVjdCIKICB9LAogICJldmVudGJyaWRnZSI6IHsKICAgICJuYW1lIjogIkV2ZW50QnJpZGdlIgogIH0sCiAgImxha2Vmb3JtYXRpb24iOiB7CiAgICAibmFtZSI6ICJMYWtlRm9ybWF0aW9uIgogIH0sCiAgImZvcmVjYXN0c2VydmljZSI6IHsKICAgICJwcmVmaXgiOiAiZm9yZWNhc3QiLAogICAgIm5hbWUiOiAiRm9yZWNhc3RTZXJ2aWNlIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImZvcmVjYXN0cXVlcnlzZXJ2aWNlIjogewogICAgInByZWZpeCI6ICJmb3JlY2FzdHF1ZXJ5IiwKICAgICJuYW1lIjogIkZvcmVjYXN0UXVlcnlTZXJ2aWNlIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgInFsZGIiOiB7CiAgICAibmFtZSI6ICJRTERCIgogIH0sCiAgInFsZGJzZXNzaW9uIjogewogICAgInByZWZpeCI6ICJxbGRiLXNlc3Npb24iLAogICAgIm5hbWUiOiAiUUxEQlNlc3Npb24iCiAgfSwKICAid29ya21haWxtZXNzYWdlZmxvdyI6IHsKICAgICJuYW1lIjogIldvcmtNYWlsTWVzc2FnZUZsb3ciCiAgfSwKICAiY29kZXN0YXJub3RpZmljYXRpb25zIjogewogICAgInByZWZpeCI6ICJjb2Rlc3Rhci1ub3RpZmljYXRpb25zIiwKICAgICJuYW1lIjogIkNvZGVTdGFyTm90aWZpY2F0aW9ucyIKICB9LAogICJzYXZpbmdzcGxhbnMiOiB7CiAgICAibmFtZSI6ICJTYXZpbmdzUGxhbnMiCiAgfSwKICAic3NvIjogewogICAgIm5hbWUiOiAiU1NPIgogIH0sCiAgInNzb29pZGMiOiB7CiAgICAicHJlZml4IjogInNzby1vaWRjIiwKICAgICJuYW1lIjogIlNTT09JREMiCiAgfSwKICAibWFya2V0cGxhY2VjYXRhbG9nIjogewogICAgInByZWZpeCI6ICJtYXJrZXRwbGFjZS1jYXRhbG9nIiwKICAgICJuYW1lIjogIk1hcmtldHBsYWNlQ2F0YWxvZyIKICB9LAogICJkYXRhZXhjaGFuZ2UiOiB7CiAgICAibmFtZSI6ICJEYXRhRXhjaGFuZ2UiCiAgfSwKICAic2VzdjIiOiB7CiAgICAibmFtZSI6ICJTRVNWMiIKICB9LAogICJtaWdyYXRpb25odWJjb25maWciOiB7CiAgICAicHJlZml4IjogIm1pZ3JhdGlvbmh1Yi1jb25maWciLAogICAgIm5hbWUiOiAiTWlncmF0aW9uSHViQ29uZmlnIgogIH0sCiAgImNvbm5lY3RwYXJ0aWNpcGFudCI6IHsKICAgICJuYW1lIjogIkNvbm5lY3RQYXJ0aWNpcGFudCIKICB9LAogICJhcHBjb25maWciOiB7CiAgICAibmFtZSI6ICJBcHBDb25maWciCiAgfSwKICAiaW90c2VjdXJldHVubmVsaW5nIjogewogICAgIm5hbWUiOiAiSW9UU2VjdXJlVHVubmVsaW5nIgogIH0sCiAgIndhZnYyIjogewogICAgIm5hbWUiOiAiV0FGVjIiCiAgfSwKICAiZWxhc3RpY2luZmVyZW5jZSI6IHsKICAgICJwcmVmaXgiOiAiZWxhc3RpYy1pbmZlcmVuY2UiLAogICAgIm5hbWUiOiAiRWxhc3RpY0luZmVyZW5jZSIKICB9LAogICJpbWFnZWJ1aWxkZXIiOiB7CiAgICAibmFtZSI6ICJJbWFnZWJ1aWxkZXIiCiAgfSwKICAic2NoZW1hcyI6IHsKICAgICJuYW1lIjogIlNjaGVtYXMiCiAgfSwKICAiYWNjZXNzYW5hbHl6ZXIiOiB7CiAgICAibmFtZSI6ICJBY2Nlc3NBbmFseXplciIKICB9LAogICJjb2RlZ3VydXJldmlld2VyIjogewogICAgInByZWZpeCI6ICJjb2RlZ3VydS1yZXZpZXdlciIsCiAgICAibmFtZSI6ICJDb2RlR3VydVJldmlld2VyIgogIH0sCiAgImNvZGVndXJ1cHJvZmlsZXIiOiB7CiAgICAibmFtZSI6ICJDb2RlR3VydVByb2ZpbGVyIgogIH0sCiAgImNvbXB1dGVvcHRpbWl6ZXIiOiB7CiAgICAicHJlZml4IjogImNvbXB1dGUtb3B0aW1pemVyIiwKICAgICJuYW1lIjogIkNvbXB1dGVPcHRpbWl6ZXIiCiAgfSwKICAiZnJhdWRkZXRlY3RvciI6IHsKICAgICJuYW1lIjogIkZyYXVkRGV0ZWN0b3IiCiAgfSwKICAia2VuZHJhIjogewogICAgIm5hbWUiOiAiS2VuZHJhIgogIH0sCiAgIm5ldHdvcmttYW5hZ2VyIjogewogICAgIm5hbWUiOiAiTmV0d29ya01hbmFnZXIiCiAgfSwKICAib3V0cG9zdHMiOiB7CiAgICAibmFtZSI6ICJPdXRwb3N0cyIKICB9LAogICJhdWdtZW50ZWRhaXJ1bnRpbWUiOiB7CiAgICAicHJlZml4IjogInNhZ2VtYWtlci1hMmktcnVudGltZSIsCiAgICAibmFtZSI6ICJBdWdtZW50ZWRBSVJ1bnRpbWUiCiAgfSwKICAiZWJzIjogewogICAgIm5hbWUiOiAiRUJTIgogIH0sCiAgImtpbmVzaXN2aWRlb3NpZ25hbGluZ2NoYW5uZWxzIjogewogICAgInByZWZpeCI6ICJraW5lc2lzLXZpZGVvLXNpZ25hbGluZyIsCiAgICAibmFtZSI6ICJLaW5lc2lzVmlkZW9TaWduYWxpbmdDaGFubmVscyIsCiAgICAiY29ycyI6IHRydWUKICB9LAogICJkZXRlY3RpdmUiOiB7CiAgICAibmFtZSI6ICJEZXRlY3RpdmUiCiAgfSwKICAiY29kZXN0YXJjb25uZWN0aW9ucyI6IHsKICAgICJwcmVmaXgiOiAiY29kZXN0YXItY29ubmVjdGlvbnMiLAogICAgIm5hbWUiOiAiQ29kZVN0YXJjb25uZWN0aW9ucyIKICB9LAogICJzeW50aGV0aWNzIjogewogICAgIm5hbWUiOiAiU3ludGhldGljcyIKICB9LAogICJpb3RzaXRld2lzZSI6IHsKICAgICJuYW1lIjogIklvVFNpdGVXaXNlIgogIH0sCiAgIm1hY2llMiI6IHsKICAgICJuYW1lIjogIk1hY2llMiIKICB9LAogICJjb2RlYXJ0aWZhY3QiOiB7CiAgICAibmFtZSI6ICJDb2RlQXJ0aWZhY3QiCiAgfSwKICAiaG9uZXljb2RlIjogewogICAgIm5hbWUiOiAiSG9uZXljb2RlIgogIH0sCiAgIml2cyI6IHsKICAgICJuYW1lIjogIklWUyIKICB9LAogICJicmFrZXQiOiB7CiAgICAibmFtZSI6ICJCcmFrZXQiCiAgfSwKICAiaWRlbnRpdHlzdG9yZSI6IHsKICAgICJuYW1lIjogIklkZW50aXR5U3RvcmUiCiAgfSwKICAiYXBwZmxvdyI6IHsKICAgICJuYW1lIjogIkFwcGZsb3ciCiAgfSwKICAicmVkc2hpZnRkYXRhIjogewogICAgInByZWZpeCI6ICJyZWRzaGlmdC1kYXRhIiwKICAgICJuYW1lIjogIlJlZHNoaWZ0RGF0YSIKICB9LAogICJzc29hZG1pbiI6IHsKICAgICJwcmVmaXgiOiAic3NvLWFkbWluIiwKICAgICJuYW1lIjogIlNTT0FkbWluIgogIH0sCiAgInRpbWVzdHJlYW1xdWVyeSI6IHsKICAgICJwcmVmaXgiOiAidGltZXN0cmVhbS1xdWVyeSIsCiAgICAibmFtZSI6ICJUaW1lc3RyZWFtUXVlcnkiCiAgfSwKICAidGltZXN0cmVhbXdyaXRlIjogewogICAgInByZWZpeCI6ICJ0aW1lc3RyZWFtLXdyaXRlIiwKICAgICJuYW1lIjogIlRpbWVzdHJlYW1Xcml0ZSIKICB9LAogICJzM291dHBvc3RzIjogewogICAgIm5hbWUiOiAiUzNPdXRwb3N0cyIKICB9LAogICJkYXRhYnJldyI6IHsKICAgICJuYW1lIjogIkRhdGFCcmV3IgogIH0sCiAgInNlcnZpY2VjYXRhbG9nYXBwcmVnaXN0cnkiOiB7CiAgICAicHJlZml4IjogInNlcnZpY2VjYXRhbG9nLWFwcHJlZ2lzdHJ5IiwKICAgICJuYW1lIjogIlNlcnZpY2VDYXRhbG9nQXBwUmVnaXN0cnkiCiAgfSwKICAibmV0d29ya2ZpcmV3YWxsIjogewogICAgInByZWZpeCI6ICJuZXR3b3JrLWZpcmV3YWxsIiwKICAgICJuYW1lIjogIk5ldHdvcmtGaXJld2FsbCIKICB9LAogICJtd2FhIjogewogICAgIm5hbWUiOiAiTVdBQSIKICB9LAogICJhbXBsaWZ5YmFja2VuZCI6IHsKICAgICJuYW1lIjogIkFtcGxpZnlCYWNrZW5kIgogIH0sCiAgImFwcGludGVncmF0aW9ucyI6IHsKICAgICJuYW1lIjogIkFwcEludGVncmF0aW9ucyIKICB9LAogICJjb25uZWN0Y29udGFjdGxlbnMiOiB7CiAgICAicHJlZml4IjogImNvbm5lY3QtY29udGFjdC1sZW5zIiwKICAgICJuYW1lIjogIkNvbm5lY3RDb250YWN0TGVucyIKICB9LAogICJkZXZvcHNndXJ1IjogewogICAgInByZWZpeCI6ICJkZXZvcHMtZ3VydSIsCiAgICAibmFtZSI6ICJEZXZPcHNHdXJ1IgogIH0sCiAgImVjcnB1YmxpYyI6IHsKICAgICJwcmVmaXgiOiAiZWNyLXB1YmxpYyIsCiAgICAibmFtZSI6ICJFQ1JQVUJMSUMiCiAgfSwKICAibG9va291dHZpc2lvbiI6IHsKICAgICJuYW1lIjogIkxvb2tvdXRWaXNpb24iCiAgfSwKICAic2FnZW1ha2VyZmVhdHVyZXN0b3JlcnVudGltZSI6IHsKICAgICJwcmVmaXgiOiAic2FnZW1ha2VyLWZlYXR1cmVzdG9yZS1ydW50aW1lIiwKICAgICJuYW1lIjogIlNhZ2VNYWtlckZlYXR1cmVTdG9yZVJ1bnRpbWUiCiAgfSwKICAiY3VzdG9tZXJwcm9maWxlcyI6IHsKICAgICJwcmVmaXgiOiAiY3VzdG9tZXItcHJvZmlsZXMiLAogICAgIm5hbWUiOiAiQ3VzdG9tZXJQcm9maWxlcyIKICB9LAogICJhdWRpdG1hbmFnZXIiOiB7CiAgICAibmFtZSI6ICJBdWRpdE1hbmFnZXIiCiAgfSwKICAiZW1yY29udGFpbmVycyI6IHsKICAgICJwcmVmaXgiOiAiZW1yLWNvbnRhaW5lcnMiLAogICAgIm5hbWUiOiAiRU1SY29udGFpbmVycyIKICB9LAogICJoZWFsdGhsYWtlIjogewogICAgIm5hbWUiOiAiSGVhbHRoTGFrZSIKICB9LAogICJzYWdlbWFrZXJlZGdlIjogewogICAgInByZWZpeCI6ICJzYWdlbWFrZXItZWRnZSIsCiAgICAibmFtZSI6ICJTYWdlbWFrZXJFZGdlIgogIH0sCiAgImFtcCI6IHsKICAgICJuYW1lIjogIkFtcCIKICB9LAogICJncmVlbmdyYXNzdjIiOiB7CiAgICAibmFtZSI6ICJHcmVlbmdyYXNzVjIiCiAgfSwKICAiaW90ZGV2aWNlYWR2aXNvciI6IHsKICAgICJuYW1lIjogIklvdERldmljZUFkdmlzb3IiCiAgfSwKICAiaW90ZmxlZXRodWIiOiB7CiAgICAibmFtZSI6ICJJb1RGbGVldEh1YiIKICB9LAogICJpb3R3aXJlbGVzcyI6IHsKICAgICJuYW1lIjogIklvVFdpcmVsZXNzIgogIH0sCiAgImxvY2F0aW9uIjogewogICAgIm5hbWUiOiAiTG9jYXRpb24iLAogICAgImNvcnMiOiB0cnVlCiAgfSwKICAid2VsbGFyY2hpdGVjdGVkIjogewogICAgIm5hbWUiOiAiV2VsbEFyY2hpdGVjdGVkIgogIH0sCiAgImxleG1vZGVsc3YyIjogewogICAgInByZWZpeCI6ICJtb2RlbHMubGV4LnYyIiwKICAgICJuYW1lIjogIkxleE1vZGVsc1YyIgogIH0sCiAgImxleHJ1bnRpbWV2MiI6IHsKICAgICJwcmVmaXgiOiAicnVudGltZS5sZXgudjIiLAogICAgIm5hbWUiOiAiTGV4UnVudGltZVYyIiwKICAgICJjb3JzIjogdHJ1ZQogIH0sCiAgImZpcyI6IHsKICAgICJuYW1lIjogIkZpcyIKICB9LAogICJsb29rb3V0bWV0cmljcyI6IHsKICAgICJuYW1lIjogIkxvb2tvdXRNZXRyaWNzIgogIH0sCiAgIm1nbiI6IHsKICAgICJuYW1lIjogIk1nbiIKICB9LAogICJsb29rb3V0ZXF1aXBtZW50IjogewogICAgIm5hbWUiOiAiTG9va291dEVxdWlwbWVudCIKICB9LAogICJuaW1ibGUiOiB7CiAgICAibmFtZSI6ICJOaW1ibGUiCiAgfSwKICAiZmluc3BhY2UiOiB7CiAgICAibmFtZSI6ICJGaW5zcGFjZSIKICB9LAogICJmaW5zcGFjZWRhdGEiOiB7CiAgICAicHJlZml4IjogImZpbnNwYWNlLWRhdGEiLAogICAgIm5hbWUiOiAiRmluc3BhY2VkYXRhIgogIH0sCiAgInNzbWNvbnRhY3RzIjogewogICAgInByZWZpeCI6ICJzc20tY29udGFjdHMiLAogICAgIm5hbWUiOiAiU1NNQ29udGFjdHMiCiAgfSwKICAic3NtaW5jaWRlbnRzIjogewogICAgInByZWZpeCI6ICJzc20taW5jaWRlbnRzIiwKICAgICJuYW1lIjogIlNTTUluY2lkZW50cyIKICB9LAogICJhcHBsaWNhdGlvbmNvc3Rwcm9maWxlciI6IHsKICAgICJuYW1lIjogIkFwcGxpY2F0aW9uQ29zdFByb2ZpbGVyIgogIH0sCiAgImFwcHJ1bm5lciI6IHsKICAgICJuYW1lIjogIkFwcFJ1bm5lciIKICB9LAogICJwcm90b24iOiB7CiAgICAibmFtZSI6ICJQcm90b24iCiAgfSwKICAicm91dGU1M3JlY292ZXJ5Y2x1c3RlciI6IHsKICAgICJwcmVmaXgiOiAicm91dGU1My1yZWNvdmVyeS1jbHVzdGVyIiwKICAgICJuYW1lIjogIlJvdXRlNTNSZWNvdmVyeUNsdXN0ZXIiCiAgfSwKICAicm91dGU1M3JlY292ZXJ5Y29udHJvbGNvbmZpZyI6IHsKICAgICJwcmVmaXgiOiAicm91dGU1My1yZWNvdmVyeS1jb250cm9sLWNvbmZpZyIsCiAgICAibmFtZSI6ICJSb3V0ZTUzUmVjb3ZlcnlDb250cm9sQ29uZmlnIgogIH0sCiAgInJvdXRlNTNyZWNvdmVyeXJlYWRpbmVzcyI6IHsKICAgICJwcmVmaXgiOiAicm91dGU1My1yZWNvdmVyeS1yZWFkaW5lc3MiLAogICAgIm5hbWUiOiAiUm91dGU1M1JlY292ZXJ5UmVhZGluZXNzIgogIH0sCiAgImNoaW1lc2RraWRlbnRpdHkiOiB7CiAgICAicHJlZml4IjogImNoaW1lLXNkay1pZGVudGl0eSIsCiAgICAibmFtZSI6ICJDaGltZVNES0lkZW50aXR5IgogIH0sCiAgImNoaW1lc2RrbWVzc2FnaW5nIjogewogICAgInByZWZpeCI6ICJjaGltZS1zZGstbWVzc2FnaW5nIiwKICAgICJuYW1lIjogIkNoaW1lU0RLTWVzc2FnaW5nIgogIH0sCiAgInNub3dkZXZpY2VtYW5hZ2VtZW50IjogewogICAgInByZWZpeCI6ICJzbm93LWRldmljZS1tYW5hZ2VtZW50IiwKICAgICJuYW1lIjogIlNub3dEZXZpY2VNYW5hZ2VtZW50IgogIH0sCiAgIm1lbW9yeWRiIjogewogICAgIm5hbWUiOiAiTWVtb3J5REIiCiAgfSwKICAib3BlbnNlYXJjaCI6IHsKICAgICJuYW1lIjogIk9wZW5TZWFyY2giCiAgfSwKICAia2Fma2Fjb25uZWN0IjogewogICAgIm5hbWUiOiAiS2Fma2FDb25uZWN0IgogIH0sCiAgInZvaWNlaWQiOiB7CiAgICAicHJlZml4IjogInZvaWNlLWlkIiwKICAgICJuYW1lIjogIlZvaWNlSUQiCiAgfSwKICAid2lzZG9tIjogewogICAgIm5hbWUiOiAiV2lzZG9tIgogIH0sCiAgImFjY291bnQiOiB7CiAgICAibmFtZSI6ICJBY2NvdW50IgogIH0sCiAgImNsb3VkY29udHJvbCI6IHsKICAgICJuYW1lIjogIkNsb3VkQ29udHJvbCIKICB9LAogICJncmFmYW5hIjogewogICAgIm5hbWUiOiAiR3JhZmFuYSIKICB9LAogICJwYW5vcmFtYSI6IHsKICAgICJuYW1lIjogIlBhbm9yYW1hIgogIH0sCiAgImNoaW1lc2RrbWVldGluZ3MiOiB7CiAgICAicHJlZml4IjogImNoaW1lLXNkay1tZWV0aW5ncyIsCiAgICAibmFtZSI6ICJDaGltZVNES01lZXRpbmdzIgogIH0sCiAgInJlc2lsaWVuY2VodWIiOiB7CiAgICAibmFtZSI6ICJSZXNpbGllbmNlaHViIgogIH0sCiAgIm1pZ3JhdGlvbmh1YnN0cmF0ZWd5IjogewogICAgIm5hbWUiOiAiTWlncmF0aW9uSHViU3RyYXRlZ3kiCiAgfSwKICAiYXBwY29uZmlnZGF0YSI6IHsKICAgICJuYW1lIjogIkFwcENvbmZpZ0RhdGEiCiAgfSwKICAiZHJzIjogewogICAgIm5hbWUiOiAiRHJzIgogIH0sCiAgIm1pZ3JhdGlvbmh1YnJlZmFjdG9yc3BhY2VzIjogewogICAgInByZWZpeCI6ICJtaWdyYXRpb24taHViLXJlZmFjdG9yLXNwYWNlcyIsCiAgICAibmFtZSI6ICJNaWdyYXRpb25IdWJSZWZhY3RvclNwYWNlcyIKICB9LAogICJldmlkZW50bHkiOiB7CiAgICAibmFtZSI6ICJFdmlkZW50bHkiCiAgfSwKICAiaW5zcGVjdG9yMiI6IHsKICAgICJuYW1lIjogIkluc3BlY3RvcjIiCiAgfSwKICAicmJpbiI6IHsKICAgICJuYW1lIjogIlJiaW4iCiAgfSwKICAicnVtIjogewogICAgIm5hbWUiOiAiUlVNIgogIH0sCiAgImJhY2t1cGdhdGV3YXkiOiB7CiAgICAicHJlZml4IjogImJhY2t1cC1nYXRld2F5IiwKICAgICJuYW1lIjogIkJhY2t1cEdhdGV3YXkiCiAgfSwKICAiaW90dHdpbm1ha2VyIjogewogICAgIm5hbWUiOiAiSW9UVHdpbk1ha2VyIgogIH0sCiAgIndvcmtzcGFjZXN3ZWIiOiB7CiAgICAicHJlZml4IjogIndvcmtzcGFjZXMtd2ViIiwKICAgICJuYW1lIjogIldvcmtTcGFjZXNXZWIiCiAgfSwKICAiYW1wbGlmeXVpYnVpbGRlciI6IHsKICAgICJuYW1lIjogIkFtcGxpZnlVSUJ1aWxkZXIiCiAgfSwKICAia2V5c3BhY2VzIjogewogICAgIm5hbWUiOiAiS2V5c3BhY2VzIgogIH0sCiAgImJpbGxpbmdjb25kdWN0b3IiOiB7CiAgICAibmFtZSI6ICJCaWxsaW5nY29uZHVjdG9yIgogIH0sCiAgImdhbWVzcGFya3MiOiB7CiAgICAibmFtZSI6ICJHYW1lU3BhcmtzIgogIH0sCiAgInBpbnBvaW50c21zdm9pY2V2MiI6IHsKICAgICJwcmVmaXgiOiAicGlucG9pbnQtc21zLXZvaWNlLXYyIiwKICAgICJuYW1lIjogIlBpbnBvaW50U01TVm9pY2VWMiIKICB9LAogICJpdnNjaGF0IjogewogICAgIm5hbWUiOiAiSXZzY2hhdCIKICB9LAogICJjaGltZXNka21lZGlhcGlwZWxpbmVzIjogewogICAgInByZWZpeCI6ICJjaGltZS1zZGstbWVkaWEtcGlwZWxpbmVzIiwKICAgICJuYW1lIjogIkNoaW1lU0RLTWVkaWFQaXBlbGluZXMiCiAgfSwKICAiZW1yc2VydmVybGVzcyI6IHsKICAgICJwcmVmaXgiOiAiZW1yLXNlcnZlcmxlc3MiLAogICAgIm5hbWUiOiAiRU1SU2VydmVybGVzcyIKICB9LAogICJtMiI6IHsKICAgICJuYW1lIjogIk0yIgogIH0sCiAgImNvbm5lY3RjYW1wYWlnbnMiOiB7CiAgICAibmFtZSI6ICJDb25uZWN0Q2FtcGFpZ25zIgogIH0sCiAgInJlZHNoaWZ0c2VydmVybGVzcyI6IHsKICAgICJwcmVmaXgiOiAicmVkc2hpZnQtc2VydmVybGVzcyIsCiAgICAibmFtZSI6ICJSZWRzaGlmdFNlcnZlcmxlc3MiCiAgfSwKICAicm9sZXNhbnl3aGVyZSI6IHsKICAgICJuYW1lIjogIlJvbGVzQW55d2hlcmUiCiAgfSwKICAibGljZW5zZW1hbmFnZXJ1c2Vyc3Vic2NyaXB0aW9ucyI6IHsKICAgICJwcmVmaXgiOiAibGljZW5zZS1tYW5hZ2VyLXVzZXItc3Vic2NyaXB0aW9ucyIsCiAgICAibmFtZSI6ICJMaWNlbnNlTWFuYWdlclVzZXJTdWJzY3JpcHRpb25zIgogIH0sCiAgImJhY2t1cHN0b3JhZ2UiOiB7CiAgICAibmFtZSI6ICJCYWNrdXBTdG9yYWdlIgogIH0sCiAgInByaXZhdGVuZXR3b3JrcyI6IHsKICAgICJuYW1lIjogIlByaXZhdGVOZXR3b3JrcyIKICB9LAogICJzdXBwb3J0YXBwIjogewogICAgInByZWZpeCI6ICJzdXBwb3J0LWFwcCIsCiAgICAibmFtZSI6ICJTdXBwb3J0QXBwIgogIH0KfQoKfSx7fV0sNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXsKICAidmVyc2lvbiI6ICIyLjAiLAogICJtZXRhZGF0YSI6IHsKICAgICJhcGlWZXJzaW9uIjogIjIwMTEtMDYtMTUiLAogICAgImVuZHBvaW50UHJlZml4IjogInN0cyIsCiAgICAiZ2xvYmFsRW5kcG9pbnQiOiAic3RzLmFtYXpvbmF3cy5jb20iLAogICAgInByb3RvY29sIjogInF1ZXJ5IiwKICAgICJzZXJ2aWNlQWJicmV2aWF0aW9uIjogIkFXUyBTVFMiLAogICAgInNlcnZpY2VGdWxsTmFtZSI6ICJBV1MgU2VjdXJpdHkgVG9rZW4gU2VydmljZSIsCiAgICAic2VydmljZUlkIjogIlNUUyIsCiAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2NCIsCiAgICAidWlkIjogInN0cy0yMDExLTA2LTE1IiwKICAgICJ4bWxOYW1lc3BhY2UiOiAiaHR0cHM6Ly9zdHMuYW1hem9uYXdzLmNvbS9kb2MvMjAxMS0wNi0xNS8iCiAgfSwKICAib3BlcmF0aW9ucyI6IHsKICAgICJBc3N1bWVSb2xlIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiUm9sZUFybiI6IHt9LAogICAgICAgICAgIlJvbGVTZXNzaW9uTmFtZSI6IHt9LAogICAgICAgICAgIlBvbGljeUFybnMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTNCIKICAgICAgICAgIH0sCiAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAiRHVyYXRpb25TZWNvbmRzIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJUYWdzIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzgiCiAgICAgICAgICB9LAogICAgICAgICAgIlRyYW5zaXRpdmVUYWdLZXlzIjogewogICAgICAgICAgICAidHlwZSI6ICJsaXN0IiwKICAgICAgICAgICAgIm1lbWJlciI6IHt9CiAgICAgICAgICB9LAogICAgICAgICAgIkV4dGVybmFsSWQiOiB7fSwKICAgICAgICAgICJTZXJpYWxOdW1iZXIiOiB7fSwKICAgICAgICAgICJUb2tlbkNvZGUiOiB7fSwKICAgICAgICAgICJTb3VyY2VJZGVudGl0eSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkFzc3VtZVJvbGVSZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQ3JlZGVudGlhbHMiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTaSIKICAgICAgICAgIH0sCiAgICAgICAgICAiQXNzdW1lZFJvbGVVc2VyIjogewogICAgICAgICAgICAic2hhcGUiOiAiU24iCiAgICAgICAgICB9LAogICAgICAgICAgIlBhY2tlZFBvbGljeVNpemUiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIlNvdXJjZUlkZW50aXR5Ijoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiQXNzdW1lUm9sZVdpdGhTQU1MIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiUm9sZUFybiIsCiAgICAgICAgICAiUHJpbmNpcGFsQXJuIiwKICAgICAgICAgICJTQU1MQXNzZXJ0aW9uIgogICAgICAgIF0sCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiUm9sZUFybiI6IHt9LAogICAgICAgICAgIlByaW5jaXBhbEFybiI6IHt9LAogICAgICAgICAgIlNBTUxBc3NlcnRpb24iOiB7fSwKICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhTQU1MUmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2kiCiAgICAgICAgICB9LAogICAgICAgICAgIkFzc3VtZWRSb2xlVXNlciI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNuIgogICAgICAgICAgfSwKICAgICAgICAgICJQYWNrZWRQb2xpY3lTaXplIjogewogICAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIgogICAgICAgICAgfSwKICAgICAgICAgICJTdWJqZWN0Ijoge30sCiAgICAgICAgICAiU3ViamVjdFR5cGUiOiB7fSwKICAgICAgICAgICJJc3N1ZXIiOiB7fSwKICAgICAgICAgICJBdWRpZW5jZSI6IHt9LAogICAgICAgICAgIk5hbWVRdWFsaWZpZXIiOiB7fSwKICAgICAgICAgICJTb3VyY2VJZGVudGl0eSI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJSb2xlQXJuIiwKICAgICAgICAgICJSb2xlU2Vzc2lvbk5hbWUiLAogICAgICAgICAgIldlYklkZW50aXR5VG9rZW4iCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJSb2xlQXJuIjoge30sCiAgICAgICAgICAiUm9sZVNlc3Npb25OYW1lIjoge30sCiAgICAgICAgICAiV2ViSWRlbnRpdHlUb2tlbiI6IHt9LAogICAgICAgICAgIlByb3ZpZGVySWQiOiB7fSwKICAgICAgICAgICJQb2xpY3lBcm5zIjogewogICAgICAgICAgICAic2hhcGUiOiAiUzQiCiAgICAgICAgICB9LAogICAgICAgICAgIlBvbGljeSI6IHt9LAogICAgICAgICAgIkR1cmF0aW9uU2Vjb25kcyI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiQXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eVJlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNpIgogICAgICAgICAgfSwKICAgICAgICAgICJTdWJqZWN0RnJvbVdlYklkZW50aXR5VG9rZW4iOiB7fSwKICAgICAgICAgICJBc3N1bWVkUm9sZVVzZXIiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTbiIKICAgICAgICAgIH0sCiAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0sCiAgICAgICAgICAiUHJvdmlkZXIiOiB7fSwKICAgICAgICAgICJBdWRpZW5jZSI6IHt9LAogICAgICAgICAgIlNvdXJjZUlkZW50aXR5Ijoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiRGVjb2RlQXV0aG9yaXphdGlvbk1lc3NhZ2UiOiB7CiAgICAgICJpbnB1dCI6IHsKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICJFbmNvZGVkTWVzc2FnZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkVuY29kZWRNZXNzYWdlIjoge30KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiRGVjb2RlQXV0aG9yaXphdGlvbk1lc3NhZ2VSZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiRGVjb2RlZE1lc3NhZ2UiOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJHZXRBY2Nlc3NLZXlJbmZvIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiQWNjZXNzS2V5SWQiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJBY2Nlc3NLZXlJZCI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldEFjY2Vzc0tleUluZm9SZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiQWNjb3VudCI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldENhbGxlcklkZW50aXR5IjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHt9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0Q2FsbGVySWRlbnRpdHlSZXN1bHQiLAogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgIm1lbWJlcnMiOiB7CiAgICAgICAgICAiVXNlcklkIjoge30sCiAgICAgICAgICAiQWNjb3VudCI6IHt9LAogICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgIkdldEZlZGVyYXRpb25Ub2tlbiI6IHsKICAgICAgImlucHV0IjogewogICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICAgIk5hbWUiCiAgICAgICAgXSwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJOYW1lIjoge30sCiAgICAgICAgICAiUG9saWN5Ijoge30sCiAgICAgICAgICAiUG9saWN5QXJucyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlM0IgogICAgICAgICAgfSwKICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIlRhZ3MiOiB7CiAgICAgICAgICAgICJzaGFwZSI6ICJTOCIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgICJvdXRwdXQiOiB7CiAgICAgICAgInJlc3VsdFdyYXBwZXIiOiAiR2V0RmVkZXJhdGlvblRva2VuUmVzdWx0IiwKICAgICAgICAidHlwZSI6ICJzdHJ1Y3R1cmUiLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIkNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAic2hhcGUiOiAiU2kiCiAgICAgICAgICB9LAogICAgICAgICAgIkZlZGVyYXRlZFVzZXIiOiB7CiAgICAgICAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAgICAgICAiRmVkZXJhdGVkVXNlcklkIiwKICAgICAgICAgICAgICAiQXJuIgogICAgICAgICAgICBdLAogICAgICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICAgICAiRmVkZXJhdGVkVXNlcklkIjoge30sCiAgICAgICAgICAgICAgIkFybiI6IHt9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAiUGFja2VkUG9saWN5U2l6ZSI6IHsKICAgICAgICAgICAgInR5cGUiOiAiaW50ZWdlciIKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiR2V0U2Vzc2lvblRva2VuIjogewogICAgICAiaW5wdXQiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJEdXJhdGlvblNlY29uZHMiOiB7CiAgICAgICAgICAgICJ0eXBlIjogImludGVnZXIiCiAgICAgICAgICB9LAogICAgICAgICAgIlNlcmlhbE51bWJlciI6IHt9LAogICAgICAgICAgIlRva2VuQ29kZSI6IHt9CiAgICAgICAgfQogICAgICB9LAogICAgICAib3V0cHV0IjogewogICAgICAgICJyZXN1bHRXcmFwcGVyIjogIkdldFNlc3Npb25Ub2tlblJlc3VsdCIsCiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJDcmVkZW50aWFscyI6IHsKICAgICAgICAgICAgInNoYXBlIjogIlNpIgogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sCiAgInNoYXBlcyI6IHsKICAgICJTNCI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAibWVtYmVycyI6IHsKICAgICAgICAgICJhcm4iOiB7fQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTOCI6IHsKICAgICAgInR5cGUiOiAibGlzdCIsCiAgICAgICJtZW1iZXIiOiB7CiAgICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgICAicmVxdWlyZWQiOiBbCiAgICAgICAgICAiS2V5IiwKICAgICAgICAgICJWYWx1ZSIKICAgICAgICBdLAogICAgICAgICJtZW1iZXJzIjogewogICAgICAgICAgIktleSI6IHt9LAogICAgICAgICAgIlZhbHVlIjoge30KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAiU2kiOiB7CiAgICAgICJ0eXBlIjogInN0cnVjdHVyZSIsCiAgICAgICJyZXF1aXJlZCI6IFsKICAgICAgICAiQWNjZXNzS2V5SWQiLAogICAgICAgICJTZWNyZXRBY2Nlc3NLZXkiLAogICAgICAgICJTZXNzaW9uVG9rZW4iLAogICAgICAgICJFeHBpcmF0aW9uIgogICAgICBdLAogICAgICAibWVtYmVycyI6IHsKICAgICAgICAiQWNjZXNzS2V5SWQiOiB7fSwKICAgICAgICAiU2VjcmV0QWNjZXNzS2V5Ijoge30sCiAgICAgICAgIlNlc3Npb25Ub2tlbiI6IHt9LAogICAgICAgICJFeHBpcmF0aW9uIjogewogICAgICAgICAgInR5cGUiOiAidGltZXN0YW1wIgogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgICJTbiI6IHsKICAgICAgInR5cGUiOiAic3RydWN0dXJlIiwKICAgICAgInJlcXVpcmVkIjogWwogICAgICAgICJBc3N1bWVkUm9sZUlkIiwKICAgICAgICAiQXJuIgogICAgICBdLAogICAgICAibWVtYmVycyI6IHsKICAgICAgICAiQXNzdW1lZFJvbGVJZCI6IHt9LAogICAgICAgICJBcm4iOiB7fQogICAgICB9CiAgICB9CiAgfQp9Cn0se31dLDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz17CiAgInBhZ2luYXRpb24iOiB7CiAgfQp9Cgp9LHt9XSw3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwp2YXIgU2VydmljZSA9IEFXUy5TZXJ2aWNlOwp2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKCmFwaUxvYWRlci5zZXJ2aWNlc1snY29nbml0b2lkZW50aXR5J10gPSB7fTsKQVdTLkNvZ25pdG9JZGVudGl0eSA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29nbml0b2lkZW50aXR5JywgWycyMDE0LTA2LTMwJ10pOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoYXBpTG9hZGVyLnNlcnZpY2VzWydjb2duaXRvaWRlbnRpdHknXSwgJzIwMTQtMDYtMzAnLCB7CiAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICB2YXIgbW9kZWwgPSByZXF1aXJlKCcuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5taW4uanNvbicpOwogICAgbW9kZWwucGFnaW5hdG9ycyA9IHJlcXVpcmUoJy4uL2FwaXMvY29nbml0by1pZGVudGl0eS0yMDE0LTA2LTMwLnBhZ2luYXRvcnMuanNvbicpLnBhZ2luYXRpb247CiAgICByZXR1cm4gbW9kZWw7CiAgfSwKICBlbnVtZXJhYmxlOiB0cnVlLAogIGNvbmZpZ3VyYWJsZTogdHJ1ZQp9KTsKCm1vZHVsZS5leHBvcnRzID0gQVdTLkNvZ25pdG9JZGVudGl0eTsKCn0seyIuLi9hcGlzL2NvZ25pdG8taWRlbnRpdHktMjAxNC0wNi0zMC5taW4uanNvbiI6MSwiLi4vYXBpcy9jb2duaXRvLWlkZW50aXR5LTIwMTQtMDYtMzAucGFnaW5hdG9ycy5qc29uIjoyLCIuLi9saWIvY29yZSI6MTksIi4uL2xpYi9ub2RlX2xvYWRlciI6MTZ9XSw4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKcmVxdWlyZSgnLi4vbGliL25vZGVfbG9hZGVyJyk7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9saWIvY29yZScpOwp2YXIgU2VydmljZSA9IEFXUy5TZXJ2aWNlOwp2YXIgYXBpTG9hZGVyID0gQVdTLmFwaUxvYWRlcjsKCmFwaUxvYWRlci5zZXJ2aWNlc1snc3RzJ10gPSB7fTsKQVdTLlNUUyA9IFNlcnZpY2UuZGVmaW5lU2VydmljZSgnc3RzJywgWycyMDExLTA2LTE1J10pOwpyZXF1aXJlKCcuLi9saWIvc2VydmljZXMvc3RzJyk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShhcGlMb2FkZXIuc2VydmljZXNbJ3N0cyddLCAnMjAxMS0wNi0xNScsIHsKICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgIHZhciBtb2RlbCA9IHJlcXVpcmUoJy4uL2FwaXMvc3RzLTIwMTEtMDYtMTUubWluLmpzb24nKTsKICAgIG1vZGVsLnBhZ2luYXRvcnMgPSByZXF1aXJlKCcuLi9hcGlzL3N0cy0yMDExLTA2LTE1LnBhZ2luYXRvcnMuanNvbicpLnBhZ2luYXRpb247CiAgICByZXR1cm4gbW9kZWw7CiAgfSwKICBlbnVtZXJhYmxlOiB0cnVlLAogIGNvbmZpZ3VyYWJsZTogdHJ1ZQp9KTsKCm1vZHVsZS5leHBvcnRzID0gQVdTLlNUUzsKCn0seyIuLi9hcGlzL3N0cy0yMDExLTA2LTE1Lm1pbi5qc29uIjo1LCIuLi9hcGlzL3N0cy0yMDExLTA2LTE1LnBhZ2luYXRvcnMuanNvbiI6NiwiLi4vbGliL2NvcmUiOjE5LCIuLi9saWIvbm9kZV9sb2FkZXIiOjE2LCIuLi9saWIvc2VydmljZXMvc3RzIjo2Mn1dLDk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpmdW5jdGlvbiBhcGlMb2FkZXIoc3ZjLCB2ZXJzaW9uKSB7CiAgaWYgKCFhcGlMb2FkZXIuc2VydmljZXMuaGFzT3duUHJvcGVydHkoc3ZjKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkU2VydmljZTogRmFpbGVkIHRvIGxvYWQgYXBpIGZvciAnICsgc3ZjKTsKICB9CiAgcmV0dXJuIGFwaUxvYWRlci5zZXJ2aWNlc1tzdmNdW3ZlcnNpb25dOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqCiAqIFRoaXMgbWVtYmVyIG9mIEFXUy5hcGlMb2FkZXIgaXMgcHJpdmF0ZSwgYnV0IGNoYW5naW5nIGl0IHdpbGwgbmVjZXNzaXRhdGUgYQogKiBjaGFuZ2UgdG8gLi4vc2NyaXB0cy9zZXJ2aWNlcy10YWJsZS1nZW5lcmF0b3IudHMKICovCmFwaUxvYWRlci5zZXJ2aWNlcyA9IHt9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBhcGlMb2FkZXI7Cgp9LHt9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBIbWFjID0gcmVxdWlyZSgnLi9icm93c2VySG1hYycpOwp2YXIgTWQ1ID0gcmVxdWlyZSgnLi9icm93c2VyTWQ1Jyk7CnZhciBTaGExID0gcmVxdWlyZSgnLi9icm93c2VyU2hhMScpOwp2YXIgU2hhMjU2ID0gcmVxdWlyZSgnLi9icm93c2VyU2hhMjU2Jyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IGV4cG9ydHMgPSB7CiAgICBjcmVhdGVIYXNoOiBmdW5jdGlvbiBjcmVhdGVIYXNoKGFsZykgewogICAgICBhbGcgPSBhbGcudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKGFsZyA9PT0gJ21kNScpIHsKICAgICAgICByZXR1cm4gbmV3IE1kNSgpOwogICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTI1NicpIHsKICAgICAgICByZXR1cm4gbmV3IFNoYTI1NigpOwogICAgICB9IGVsc2UgaWYgKGFsZyA9PT0gJ3NoYTEnKSB7CiAgICAgICAgcmV0dXJuIG5ldyBTaGExKCk7CiAgICAgIH0KCiAgICAgIHRocm93IG5ldyBFcnJvcignSGFzaCBhbGdvcml0aG0gJyArIGFsZyArICcgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGUgYnJvd3NlciBTREsnKTsKICAgIH0sCiAgICBjcmVhdGVIbWFjOiBmdW5jdGlvbiBjcmVhdGVIbWFjKGFsZywga2V5KSB7CiAgICAgIGFsZyA9IGFsZy50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAoYWxnID09PSAnbWQ1JykgewogICAgICAgIHJldHVybiBuZXcgSG1hYyhNZDUsIGtleSk7CiAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMjU2JykgewogICAgICAgIHJldHVybiBuZXcgSG1hYyhTaGEyNTYsIGtleSk7CiAgICAgIH0gZWxzZSBpZiAoYWxnID09PSAnc2hhMScpIHsKICAgICAgICByZXR1cm4gbmV3IEhtYWMoU2hhMSwga2V5KTsKICAgICAgfQoKICAgICAgdGhyb3cgbmV3IEVycm9yKCdITUFDIGFsZ29yaXRobSAnICsgYWxnICsgJyBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIFNESycpOwogICAgfSwKICAgIGNyZWF0ZVNpZ246IGZ1bmN0aW9uKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NyZWF0ZVNpZ24gaXMgbm90IGltcGxlbWVudGVkIGluIHRoZSBicm93c2VyJyk7CiAgICB9CiAgfTsKCn0seyIuL2Jyb3dzZXJIbWFjIjoxMiwiLi9icm93c2VyTWQ1IjoxMywiLi9icm93c2VyU2hhMSI6MTQsIi4vYnJvd3NlclNoYTI1NiI6MTV9XSwxMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwoKLyoqCiAqIFRoaXMgaXMgYSBwb2x5ZmlsbCBmb3IgdGhlIHN0YXRpYyBtZXRob2QgYGlzVmlld2Agb2YgYEFycmF5QnVmZmVyYCwgd2hpY2ggaXMKICogZS5nLiBtaXNzaW5nIGluIElFIDEwLgogKgogKiBAYXBpIHByaXZhdGUKICovCmlmICgKICAgIHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYKICAgIHR5cGVvZiBBcnJheUJ1ZmZlci5pc1ZpZXcgPT09ICd1bmRlZmluZWQnCikgewogICAgQXJyYXlCdWZmZXIuaXNWaWV3ID0gZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgcmV0dXJuIHZpZXdTdHJpbmdzLmluZGV4T2YoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFyZykpID4gLTE7CiAgICB9Owp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgdmlld1N0cmluZ3MgPSBbCiAgICAnW29iamVjdCBJbnQ4QXJyYXldJywKICAgICdbb2JqZWN0IFVpbnQ4QXJyYXldJywKICAgICdbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XScsCiAgICAnW29iamVjdCBJbnQxNkFycmF5XScsCiAgICAnW29iamVjdCBVaW50MTZBcnJheV0nLAogICAgJ1tvYmplY3QgSW50MzJBcnJheV0nLAogICAgJ1tvYmplY3QgVWludDMyQXJyYXldJywKICAgICdbb2JqZWN0IEZsb2F0MzJBcnJheV0nLAogICAgJ1tvYmplY3QgRmxvYXQ2NEFycmF5XScsCiAgICAnW29iamVjdCBEYXRhVmlld10nLApdOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gaXNFbXB0eURhdGEoZGF0YSkgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBkYXRhLmxlbmd0aCA9PT0gMDsKICAgIH0KICAgIHJldHVybiBkYXRhLmJ5dGVMZW5ndGggPT09IDA7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGNvbnZlcnRUb0J1ZmZlcihkYXRhKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZGF0YSA9IG5ldyBCdWZmZXIoZGF0YSwgJ3V0ZjgnKTsKICAgIH0KCiAgICBpZiAoQXJyYXlCdWZmZXIuaXNWaWV3KGRhdGEpKSB7CiAgICAgICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCAvIFVpbnQ4QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpOwogICAgfQoKICAgIHJldHVybiBuZXcgVWludDhBcnJheShkYXRhKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gewogICAgaXNFbXB0eURhdGE6IGlzRW1wdHlEYXRhLAogICAgY29udmVydFRvQnVmZmVyOiBjb252ZXJ0VG9CdWZmZXIsCn07Cgp9LHsiYnVmZmVyLyI6ODR9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIEhtYWMoaGFzaEN0b3IsIHNlY3JldCkgewogICAgdGhpcy5oYXNoID0gbmV3IGhhc2hDdG9yKCk7CiAgICB0aGlzLm91dGVyID0gbmV3IGhhc2hDdG9yKCk7CgogICAgdmFyIGlubmVyID0gYnVmZmVyRnJvbVNlY3JldChoYXNoQ3Rvciwgc2VjcmV0KTsKICAgIHZhciBvdXRlciA9IG5ldyBVaW50OEFycmF5KGhhc2hDdG9yLkJMT0NLX1NJWkUpOwogICAgb3V0ZXIuc2V0KGlubmVyKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGhhc2hDdG9yLkJMT0NLX1NJWkU7IGkrKykgewogICAgICAgIGlubmVyW2ldIF49IDB4MzY7CiAgICAgICAgb3V0ZXJbaV0gXj0gMHg1YzsKICAgIH0KCiAgICB0aGlzLmhhc2gudXBkYXRlKGlubmVyKTsKICAgIHRoaXMub3V0ZXIudXBkYXRlKG91dGVyKTsKCiAgICAvLyBaZXJvIG91dCB0aGUgY29waWVkIGtleSBidWZmZXIuCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGlubmVyLmJ5dGVMZW5ndGg7IGkrKykgewogICAgICAgIGlubmVyW2ldID0gMDsKICAgIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gSG1hYzsKCkhtYWMucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICh0b0hhc2gpIHsKICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEodG9IYXNoKSB8fCB0aGlzLmVycm9yKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgdHJ5IHsKICAgICAgICB0aGlzLmhhc2gudXBkYXRlKGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIodG9IYXNoKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgdGhpcy5lcnJvciA9IGU7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn07CgpIbWFjLnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgIGlmICghdGhpcy5vdXRlci5maW5pc2hlZCkgewogICAgICAgIHRoaXMub3V0ZXIudXBkYXRlKHRoaXMuaGFzaC5kaWdlc3QoKSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXMub3V0ZXIuZGlnZXN0KGVuY29kaW5nKTsKfTsKCmZ1bmN0aW9uIGJ1ZmZlckZyb21TZWNyZXQoaGFzaEN0b3IsIHNlY3JldCkgewogICAgdmFyIGlucHV0ID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihzZWNyZXQpOwogICAgaWYgKGlucHV0LmJ5dGVMZW5ndGggPiBoYXNoQ3Rvci5CTE9DS19TSVpFKSB7CiAgICAgICAgdmFyIGJ1ZmZlckhhc2ggPSBuZXcgaGFzaEN0b3I7CiAgICAgICAgYnVmZmVySGFzaC51cGRhdGUoaW5wdXQpOwogICAgICAgIGlucHV0ID0gYnVmZmVySGFzaC5kaWdlc3QoKTsKICAgIH0KICAgIHZhciBidWZmZXIgPSBuZXcgVWludDhBcnJheShoYXNoQ3Rvci5CTE9DS19TSVpFKTsKICAgIGJ1ZmZlci5zZXQoaW5wdXQpOwogICAgcmV0dXJuIGJ1ZmZlcjsKfQoKfSx7Ii4vYnJvd3Nlckhhc2hVdGlscyI6MTF9XSwxMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBoYXNoVXRpbHMgPSByZXF1aXJlKCcuL2Jyb3dzZXJIYXNoVXRpbHMnKTsKdmFyIEJ1ZmZlciA9IHJlcXVpcmUoJ2J1ZmZlci8nKS5CdWZmZXI7Cgp2YXIgQkxPQ0tfU0laRSA9IDY0OwoKdmFyIERJR0VTVF9MRU5HVEggPSAxNjsKCnZhciBJTklUID0gWwogICAgMHg2NzQ1MjMwMSwKICAgIDB4ZWZjZGFiODksCiAgICAweDk4YmFkY2ZlLAogICAgMHgxMDMyNTQ3NiwKXTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIE1kNSgpIHsKICAgIHRoaXMuc3RhdGUgPSBbCiAgICAgICAgMHg2NzQ1MjMwMSwKICAgICAgICAweGVmY2RhYjg5LAogICAgICAgIDB4OThiYWRjZmUsCiAgICAgICAgMHgxMDMyNTQ3NiwKICAgIF07CiAgICB0aGlzLmJ1ZmZlciA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoQkxPQ0tfU0laRSkpOwogICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgdGhpcy5ieXRlc0hhc2hlZCA9IDA7CiAgICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IE1kNTsKCk1kNS5CTE9DS19TSVpFID0gQkxPQ0tfU0laRTsKCk1kNS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKHNvdXJjZURhdGEpIHsKICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoc291cmNlRGF0YSkpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSBpZiAodGhpcy5maW5pc2hlZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQXR0ZW1wdGVkIHRvIHVwZGF0ZSBhbiBhbHJlYWR5IGZpbmlzaGVkIGhhc2guJyk7CiAgICB9CgogICAgdmFyIGRhdGEgPSBoYXNoVXRpbHMuY29udmVydFRvQnVmZmVyKHNvdXJjZURhdGEpOwogICAgdmFyIHBvc2l0aW9uID0gMDsKICAgIHZhciBieXRlTGVuZ3RoID0gZGF0YS5ieXRlTGVuZ3RoOwogICAgdGhpcy5ieXRlc0hhc2hlZCArPSBieXRlTGVuZ3RoOwogICAgd2hpbGUgKGJ5dGVMZW5ndGggPiAwKSB7CiAgICAgICAgdGhpcy5idWZmZXIuc2V0VWludDgodGhpcy5idWZmZXJMZW5ndGgrKywgZGF0YVtwb3NpdGlvbisrXSk7CiAgICAgICAgYnl0ZUxlbmd0aC0tOwogICAgICAgIGlmICh0aGlzLmJ1ZmZlckxlbmd0aCA9PT0gQkxPQ0tfU0laRSkgewogICAgICAgICAgICB0aGlzLmhhc2hCdWZmZXIoKTsKICAgICAgICAgICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpczsKfTsKCk1kNS5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICBpZiAoIXRoaXMuZmluaXNoZWQpIHsKICAgICAgICB2YXIgX2EgPSB0aGlzLCBidWZmZXIgPSBfYS5idWZmZXIsIHVuZGVjb3JhdGVkTGVuZ3RoID0gX2EuYnVmZmVyTGVuZ3RoLCBieXRlc0hhc2hlZCA9IF9hLmJ5dGVzSGFzaGVkOwogICAgICAgIHZhciBiaXRzSGFzaGVkID0gYnl0ZXNIYXNoZWQgKiA4OwogICAgICAgIGJ1ZmZlci5zZXRVaW50OCh0aGlzLmJ1ZmZlckxlbmd0aCsrLCAxMjgpOwogICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgIGlmICh1bmRlY29yYXRlZExlbmd0aCAlIEJMT0NLX1NJWkUgPj0gQkxPQ0tfU0laRSAtIDgpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgICAgIHRoaXMuYnVmZmVyTGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRSAtIDg7IGkrKykgewogICAgICAgICAgICBidWZmZXIuc2V0VWludDgoaSwgMCk7CiAgICAgICAgfQogICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIGJpdHNIYXNoZWQgPj4+IDAsIHRydWUpOwogICAgICAgIGJ1ZmZlci5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5oYXNoQnVmZmVyKCk7CiAgICAgICAgdGhpcy5maW5pc2hlZCA9IHRydWU7CiAgICB9CiAgICB2YXIgb3V0ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihESUdFU1RfTEVOR1RIKSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgIG91dC5zZXRVaW50MzIoaSAqIDQsIHRoaXMuc3RhdGVbaV0sIHRydWUpOwogICAgfQogICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKG91dC5idWZmZXIsIG91dC5ieXRlT2Zmc2V0LCBvdXQuYnl0ZUxlbmd0aCk7CiAgICByZXR1cm4gZW5jb2RpbmcgPyBidWZmLnRvU3RyaW5nKGVuY29kaW5nKSA6IGJ1ZmY7Cn07CgpNZDUucHJvdG90eXBlLmhhc2hCdWZmZXIgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgX2EgPSB0aGlzLCBidWZmZXIgPSBfYS5idWZmZXIsIHN0YXRlID0gX2Euc3RhdGU7CiAgICB2YXIgYSA9IHN0YXRlWzBdLCBiID0gc3RhdGVbMV0sIGMgPSBzdGF0ZVsyXSwgZCA9IHN0YXRlWzNdOwogICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDcsIDB4ZDc2YWE0NzgpOwogICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNCwgdHJ1ZSksIDEyLCAweGU4YzdiNzU2KTsKICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAxNywgMHgyNDIwNzBkYik7CiAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMigxMiwgdHJ1ZSksIDIyLCAweGMxYmRjZWVlKTsKICAgIGEgPSBmZihhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDE2LCB0cnVlKSwgNywgMHhmNTdjMGZhZik7CiAgICBkID0gZmYoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDEyLCAweDQ3ODdjNjJhKTsKICAgIGMgPSBmZihjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgMTcsIDB4YTgzMDQ2MTMpOwogICAgYiA9IGZmKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAyMiwgMHhmZDQ2OTUwMSk7CiAgICBhID0gZmYoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDcsIDB4Njk4MDk4ZDgpOwogICAgZCA9IGZmKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMzYsIHRydWUpLCAxMiwgMHg4YjQ0ZjdhZik7CiAgICBjID0gZmYoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDE3LCAweGZmZmY1YmIxKTsKICAgIGIgPSBmZihiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMjIsIDB4ODk1Y2Q3YmUpOwogICAgYSA9IGZmKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCA3LCAweDZiOTAxMTIyKTsKICAgIGQgPSBmZihkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgMTIsIDB4ZmQ5ODcxOTMpOwogICAgYyA9IGZmKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAxNywgMHhhNjc5NDM4ZSk7CiAgICBiID0gZmYoYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDIyLCAweDQ5YjQwODIxKTsKICAgIGEgPSBnZyhhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCA1LCAweGY2MWUyNTYyKTsKICAgIGQgPSBnZyhkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDI0LCB0cnVlKSwgOSwgMHhjMDQwYjM0MCk7CiAgICBjID0gZ2coYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0NCwgdHJ1ZSksIDE0LCAweDI2NWU1YTUxKTsKICAgIGIgPSBnZyhiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDAsIHRydWUpLCAyMCwgMHhlOWI2YzdhYSk7CiAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigyMCwgdHJ1ZSksIDUsIDB4ZDYyZjEwNWQpOwogICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCA5LCAweDAyNDQxNDUzKTsKICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDYwLCB0cnVlKSwgMTQsIDB4ZDhhMWU2ODEpOwogICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCAyMCwgMHhlN2QzZmJjOCk7CiAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDUsIDB4MjFlMWNkZTYpOwogICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCA5LCAweGMzMzcwN2Q2KTsKICAgIGMgPSBnZyhjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTQsIDB4ZjRkNTBkODcpOwogICAgYiA9IGdnKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMzIsIHRydWUpLCAyMCwgMHg0NTVhMTRlZCk7CiAgICBhID0gZ2coYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDUsIDB4YTllM2U5MDUpOwogICAgZCA9IGdnKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDksIDB4ZmNlZmEzZjgpOwogICAgYyA9IGdnKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoMjgsIHRydWUpLCAxNCwgMHg2NzZmMDJkOSk7CiAgICBiID0gZ2coYiwgYywgZCwgYSwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDIwLCAweDhkMmE0YzhhKTsKICAgIGEgPSBoaChhLCBiLCBjLCBkLCBidWZmZXIuZ2V0VWludDMyKDIwLCB0cnVlKSwgNCwgMHhmZmZhMzk0Mik7CiAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDExLCAweDg3NzFmNjgxKTsKICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTYsIDB4NmQ5ZDYxMjIpOwogICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNTYsIHRydWUpLCAyMywgMHhmZGU1MzgwYyk7CiAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0LCB0cnVlKSwgNCwgMHhhNGJlZWE0NCk7CiAgICBkID0gaGgoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigxNiwgdHJ1ZSksIDExLCAweDRiZGVjZmE5KTsKICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDI4LCB0cnVlKSwgMTYsIDB4ZjZiYjRiNjApOwogICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoNDAsIHRydWUpLCAyMywgMHhiZWJmYmM3MCk7CiAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig1MiwgdHJ1ZSksIDQsIDB4Mjg5YjdlYzYpOwogICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMCwgdHJ1ZSksIDExLCAweGVhYTEyN2ZhKTsKICAgIGMgPSBoaChjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDEyLCB0cnVlKSwgMTYsIDB4ZDRlZjMwODUpOwogICAgYiA9IGhoKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjQsIHRydWUpLCAyMywgMHgwNDg4MWQwNSk7CiAgICBhID0gaGgoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzNiwgdHJ1ZSksIDQsIDB4ZDlkNGQwMzkpOwogICAgZCA9IGhoKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNDgsIHRydWUpLCAxMSwgMHhlNmRiOTllNSk7CiAgICBjID0gaGgoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig2MCwgdHJ1ZSksIDE2LCAweDFmYTI3Y2Y4KTsKICAgIGIgPSBoaChiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDgsIHRydWUpLCAyMywgMHhjNGFjNTY2NSk7CiAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigwLCB0cnVlKSwgNiwgMHhmNDI5MjI0NCk7CiAgICBkID0gaWkoZCwgYSwgYiwgYywgYnVmZmVyLmdldFVpbnQzMigyOCwgdHJ1ZSksIDEwLCAweDQzMmFmZjk3KTsKICAgIGMgPSBpaShjLCBkLCBhLCBiLCBidWZmZXIuZ2V0VWludDMyKDU2LCB0cnVlKSwgMTUsIDB4YWI5NDIzYTcpOwogICAgYiA9IGlpKGIsIGMsIGQsIGEsIGJ1ZmZlci5nZXRVaW50MzIoMjAsIHRydWUpLCAyMSwgMHhmYzkzYTAzOSk7CiAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMig0OCwgdHJ1ZSksIDYsIDB4NjU1YjU5YzMpOwogICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoMTIsIHRydWUpLCAxMCwgMHg4ZjBjY2M5Mik7CiAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMig0MCwgdHJ1ZSksIDE1LCAweGZmZWZmNDdkKTsKICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDQsIHRydWUpLCAyMSwgMHg4NTg0NWRkMSk7CiAgICBhID0gaWkoYSwgYiwgYywgZCwgYnVmZmVyLmdldFVpbnQzMigzMiwgdHJ1ZSksIDYsIDB4NmZhODdlNGYpOwogICAgZCA9IGlpKGQsIGEsIGIsIGMsIGJ1ZmZlci5nZXRVaW50MzIoNjAsIHRydWUpLCAxMCwgMHhmZTJjZTZlMCk7CiAgICBjID0gaWkoYywgZCwgYSwgYiwgYnVmZmVyLmdldFVpbnQzMigyNCwgdHJ1ZSksIDE1LCAweGEzMDE0MzE0KTsKICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDUyLCB0cnVlKSwgMjEsIDB4NGUwODExYTEpOwogICAgYSA9IGlpKGEsIGIsIGMsIGQsIGJ1ZmZlci5nZXRVaW50MzIoMTYsIHRydWUpLCA2LCAweGY3NTM3ZTgyKTsKICAgIGQgPSBpaShkLCBhLCBiLCBjLCBidWZmZXIuZ2V0VWludDMyKDQ0LCB0cnVlKSwgMTAsIDB4YmQzYWYyMzUpOwogICAgYyA9IGlpKGMsIGQsIGEsIGIsIGJ1ZmZlci5nZXRVaW50MzIoOCwgdHJ1ZSksIDE1LCAweDJhZDdkMmJiKTsKICAgIGIgPSBpaShiLCBjLCBkLCBhLCBidWZmZXIuZ2V0VWludDMyKDM2LCB0cnVlKSwgMjEsIDB4ZWI4NmQzOTEpOwogICAgc3RhdGVbMF0gPSAoYSArIHN0YXRlWzBdKSAmIDB4RkZGRkZGRkY7CiAgICBzdGF0ZVsxXSA9IChiICsgc3RhdGVbMV0pICYgMHhGRkZGRkZGRjsKICAgIHN0YXRlWzJdID0gKGMgKyBzdGF0ZVsyXSkgJiAweEZGRkZGRkZGOwogICAgc3RhdGVbM10gPSAoZCArIHN0YXRlWzNdKSAmIDB4RkZGRkZGRkY7Cn07CgpmdW5jdGlvbiBjbW4ocSwgYSwgYiwgeCwgcywgdCkgewogICAgYSA9ICgoKGEgKyBxKSAmIDB4RkZGRkZGRkYpICsgKCh4ICsgdCkgJiAweEZGRkZGRkZGKSkgJiAweEZGRkZGRkZGOwogICAgcmV0dXJuICgoKGEgPDwgcykgfCAoYSA+Pj4gKDMyIC0gcykpKSArIGIpICYgMHhGRkZGRkZGRjsKfQoKZnVuY3Rpb24gZmYoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIGNtbigoYiAmIGMpIHwgKCh+YikgJiBkKSwgYSwgYiwgeCwgcywgdCk7Cn0KCmZ1bmN0aW9uIGdnKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBjbW4oKGIgJiBkKSB8IChjICYgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwp9CgpmdW5jdGlvbiBoaChhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgICByZXR1cm4gY21uKGIgXiBjIF4gZCwgYSwgYiwgeCwgcywgdCk7Cn0KCmZ1bmN0aW9uIGlpKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICAgIHJldHVybiBjbW4oYyBeIChiIHwgKH5kKSksIGEsIGIsIHgsIHMsIHQpOwp9Cgp9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODR9XSwxNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwp2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7Cgp2YXIgQkxPQ0tfU0laRSA9IDY0OwoKdmFyIERJR0VTVF9MRU5HVEggPSAyMDsKCnZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgMHg1YTgyNzk5OSwKICAgIDB4NmVkOWViYTEsCiAgICAweDhmMWJiY2RjIHwgMCwKICAgIDB4Y2E2MmMxZDYgfCAwCl0pOwoKdmFyIElOSVQgPSBbCiAgICAweDZhMDllNjY3LAogICAgMHhiYjY3YWU4NSwKICAgIDB4M2M2ZWYzNzIsCiAgICAweGE1NGZmNTNhLAogICAgMHg1MTBlNTI3ZiwKICAgIDB4OWIwNTY4OGMsCiAgICAweDFmODNkOWFiLAogICAgMHg1YmUwY2QxOSwKXTsKCnZhciBNQVhfSEFTSEFCTEVfTEVOR1RIID0gTWF0aC5wb3coMiwgNTMpIC0gMTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIFNoYTEoKSB7CiAgICB0aGlzLmgwID0gMHg2NzQ1MjMwMTsKICAgIHRoaXMuaDEgPSAweEVGQ0RBQjg5OwogICAgdGhpcy5oMiA9IDB4OThCQURDRkU7CiAgICB0aGlzLmgzID0gMHgxMDMyNTQ3NjsKICAgIHRoaXMuaDQgPSAweEMzRDJFMUYwOwogICAgLy8gVGhlIGZpcnN0IDY0IGJ5dGVzICgxNiB3b3JkcykgaXMgdGhlIGRhdGEgY2h1bmsKICAgIHRoaXMuYmxvY2sgPSBuZXcgVWludDMyQXJyYXkoODApOwogICAgdGhpcy5vZmZzZXQgPSAwOwogICAgdGhpcy5zaGlmdCA9IDI0OwogICAgdGhpcy50b3RhbExlbmd0aCA9IDA7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gZXhwb3J0cyA9IFNoYTE7CgpTaGExLkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwoKU2hhMS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGlmICh0aGlzLmZpbmlzaGVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgdG8gdXBkYXRlIGFuIGFscmVhZHkgZmluaXNoZWQgaGFzaC4nKTsKICAgIH0KCiAgICBpZiAoaGFzaFV0aWxzLmlzRW1wdHlEYXRhKGRhdGEpKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgZGF0YSA9IGhhc2hVdGlscy5jb252ZXJ0VG9CdWZmZXIoZGF0YSk7CgogICAgdmFyIGxlbmd0aCA9IGRhdGEubGVuZ3RoOwogICAgdGhpcy50b3RhbExlbmd0aCArPSBsZW5ndGggKiA4OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMud3JpdGUoZGF0YVtpXSk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn07CgpTaGExLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIHdyaXRlKGJ5dGUpIHsKICAgIHRoaXMuYmxvY2tbdGhpcy5vZmZzZXRdIHw9IChieXRlICYgMHhmZikgPDwgdGhpcy5zaGlmdDsKICAgIGlmICh0aGlzLnNoaWZ0KSB7CiAgICAgICAgdGhpcy5zaGlmdCAtPSA4OwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9mZnNldCsrOwogICAgICAgIHRoaXMuc2hpZnQgPSAyNDsKICAgIH0KCiAgICBpZiAodGhpcy5vZmZzZXQgPT09IDE2KSB0aGlzLnByb2Nlc3NCbG9jaygpOwp9OwoKU2hhMS5wcm90b3R5cGUuZGlnZXN0ID0gZnVuY3Rpb24gKGVuY29kaW5nKSB7CiAgICAvLyBQYWQKICAgIHRoaXMud3JpdGUoMHg4MCk7CiAgICBpZiAodGhpcy5vZmZzZXQgPiAxNCB8fCAodGhpcy5vZmZzZXQgPT09IDE0ICYmIHRoaXMuc2hpZnQgPCAyNCkpIHsKICAgICAgdGhpcy5wcm9jZXNzQmxvY2soKTsKICAgIH0KICAgIHRoaXMub2Zmc2V0ID0gMTQ7CiAgICB0aGlzLnNoaWZ0ID0gMjQ7CgogICAgLy8gNjQtYml0IGxlbmd0aCBiaWctZW5kaWFuCiAgICB0aGlzLndyaXRlKDB4MDApOyAvLyBudW1iZXJzIHRoaXMgYmlnIGFyZW4ndCBhY2N1cmF0ZSBpbiBqYXZhc2NyaXB0IGFueXdheQogICAgdGhpcy53cml0ZSgweDAwKTsgLy8gLi5TbyBqdXN0IGhhcmQtY29kZSB0byB6ZXJvLgogICAgdGhpcy53cml0ZSh0aGlzLnRvdGFsTGVuZ3RoID4gMHhmZmZmZmZmZmZmID8gdGhpcy50b3RhbExlbmd0aCAvIDB4MTAwMDAwMDAwMDAgOiAweDAwKTsKICAgIHRoaXMud3JpdGUodGhpcy50b3RhbExlbmd0aCA+IDB4ZmZmZmZmZmYgPyB0aGlzLnRvdGFsTGVuZ3RoIC8gMHgxMDAwMDAwMDAgOiAweDAwKTsKICAgIGZvciAodmFyIHMgPSAyNDsgcyA+PSAwOyBzIC09IDgpIHsKICAgICAgICB0aGlzLndyaXRlKHRoaXMudG90YWxMZW5ndGggPj4gcyk7CiAgICB9CiAgICAvLyBUaGUgdmFsdWUgaW4gc3RhdGUgaXMgbGl0dGxlLWVuZGlhbiByYXRoZXIgdGhhbiBiaWctZW5kaWFuLCBzbyBmbGlwCiAgICAvLyBlYWNoIHdvcmQgaW50byBhIG5ldyBVaW50OEFycmF5CiAgICB2YXIgb3V0ID0gbmV3IEJ1ZmZlcihESUdFU1RfTEVOR1RIKTsKICAgIHZhciBvdXRWaWV3ID0gbmV3IERhdGFWaWV3KG91dC5idWZmZXIpOwogICAgb3V0Vmlldy5zZXRVaW50MzIoMCwgdGhpcy5oMCwgZmFsc2UpOwogICAgb3V0Vmlldy5zZXRVaW50MzIoNCwgdGhpcy5oMSwgZmFsc2UpOwogICAgb3V0Vmlldy5zZXRVaW50MzIoOCwgdGhpcy5oMiwgZmFsc2UpOwogICAgb3V0Vmlldy5zZXRVaW50MzIoMTIsIHRoaXMuaDMsIGZhbHNlKTsKICAgIG91dFZpZXcuc2V0VWludDMyKDE2LCB0aGlzLmg0LCBmYWxzZSk7CgogICAgcmV0dXJuIGVuY29kaW5nID8gb3V0LnRvU3RyaW5nKGVuY29kaW5nKSA6IG91dDsKfTsKClNoYTEucHJvdG90eXBlLnByb2Nlc3NCbG9jayA9IGZ1bmN0aW9uIHByb2Nlc3NCbG9jaygpIHsKICAgIC8vIEV4dGVuZCB0aGUgc2l4dGVlbiAzMi1iaXQgd29yZHMgaW50byBlaWdodHkgMzItYml0IHdvcmRzOgogICAgZm9yICh2YXIgaSA9IDE2OyBpIDwgODA7IGkrKykgewogICAgICB2YXIgdyA9IHRoaXMuYmxvY2tbaSAtIDNdIF4gdGhpcy5ibG9ja1tpIC0gOF0gXiB0aGlzLmJsb2NrW2kgLSAxNF0gXiB0aGlzLmJsb2NrW2kgLSAxNl07CiAgICAgIHRoaXMuYmxvY2tbaV0gPSAodyA8PCAxKSB8ICh3ID4+PiAzMSk7CiAgICB9CgogICAgLy8gSW5pdGlhbGl6ZSBoYXNoIHZhbHVlIGZvciB0aGlzIGNodW5rOgogICAgdmFyIGEgPSB0aGlzLmgwOwogICAgdmFyIGIgPSB0aGlzLmgxOwogICAgdmFyIGMgPSB0aGlzLmgyOwogICAgdmFyIGQgPSB0aGlzLmgzOwogICAgdmFyIGUgPSB0aGlzLmg0OwogICAgdmFyIGYsIGs7CgogICAgLy8gTWFpbiBsb29wOgogICAgZm9yIChpID0gMDsgaSA8IDgwOyBpKyspIHsKICAgICAgaWYgKGkgPCAyMCkgewogICAgICAgIGYgPSBkIF4gKGIgJiAoYyBeIGQpKTsKICAgICAgICBrID0gMHg1QTgyNzk5OTsKICAgICAgfQogICAgICBlbHNlIGlmIChpIDwgNDApIHsKICAgICAgICBmID0gYiBeIGMgXiBkOwogICAgICAgIGsgPSAweDZFRDlFQkExOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGkgPCA2MCkgewogICAgICAgIGYgPSAoYiAmIGMpIHwgKGQgJiAoYiB8IGMpKTsKICAgICAgICBrID0gMHg4RjFCQkNEQzsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICBmID0gYiBeIGMgXiBkOwogICAgICAgIGsgPSAweENBNjJDMUQ2OwogICAgICB9CiAgICAgIHZhciB0ZW1wID0gKGEgPDwgNSB8IGEgPj4+IDI3KSArIGYgKyBlICsgayArICh0aGlzLmJsb2NrW2ldfDApOwogICAgICBlID0gZDsKICAgICAgZCA9IGM7CiAgICAgIGMgPSAoYiA8PCAzMCB8IGIgPj4+IDIpOwogICAgICBiID0gYTsKICAgICAgYSA9IHRlbXA7CiAgICB9CgogICAgLy8gQWRkIHRoaXMgY2h1bmsncyBoYXNoIHRvIHJlc3VsdCBzbyBmYXI6CiAgICB0aGlzLmgwID0gKHRoaXMuaDAgKyBhKSB8IDA7CiAgICB0aGlzLmgxID0gKHRoaXMuaDEgKyBiKSB8IDA7CiAgICB0aGlzLmgyID0gKHRoaXMuaDIgKyBjKSB8IDA7CiAgICB0aGlzLmgzID0gKHRoaXMuaDMgKyBkKSB8IDA7CiAgICB0aGlzLmg0ID0gKHRoaXMuaDQgKyBlKSB8IDA7CgogICAgLy8gVGhlIGJsb2NrIGlzIG5vdyByZXVzYWJsZS4KICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgIGZvciAoaSA9IDA7IGkgPCAxNjsgaSsrKSB7CiAgICAgICAgdGhpcy5ibG9ja1tpXSA9IDA7CiAgICB9Cn07Cgp9LHsiLi9icm93c2VySGFzaFV0aWxzIjoxMSwiYnVmZmVyLyI6ODR9XSwxNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXIvJykuQnVmZmVyOwp2YXIgaGFzaFV0aWxzID0gcmVxdWlyZSgnLi9icm93c2VySGFzaFV0aWxzJyk7Cgp2YXIgQkxPQ0tfU0laRSA9IDY0OwoKdmFyIERJR0VTVF9MRU5HVEggPSAzMjsKCnZhciBLRVkgPSBuZXcgVWludDMyQXJyYXkoWwogICAgMHg0MjhhMmY5OCwKICAgIDB4NzEzNzQ0OTEsCiAgICAweGI1YzBmYmNmLAogICAgMHhlOWI1ZGJhNSwKICAgIDB4Mzk1NmMyNWIsCiAgICAweDU5ZjExMWYxLAogICAgMHg5MjNmODJhNCwKICAgIDB4YWIxYzVlZDUsCiAgICAweGQ4MDdhYTk4LAogICAgMHgxMjgzNWIwMSwKICAgIDB4MjQzMTg1YmUsCiAgICAweDU1MGM3ZGMzLAogICAgMHg3MmJlNWQ3NCwKICAgIDB4ODBkZWIxZmUsCiAgICAweDliZGMwNmE3LAogICAgMHhjMTliZjE3NCwKICAgIDB4ZTQ5YjY5YzEsCiAgICAweGVmYmU0Nzg2LAogICAgMHgwZmMxOWRjNiwKICAgIDB4MjQwY2ExY2MsCiAgICAweDJkZTkyYzZmLAogICAgMHg0YTc0ODRhYSwKICAgIDB4NWNiMGE5ZGMsCiAgICAweDc2Zjk4OGRhLAogICAgMHg5ODNlNTE1MiwKICAgIDB4YTgzMWM2NmQsCiAgICAweGIwMDMyN2M4LAogICAgMHhiZjU5N2ZjNywKICAgIDB4YzZlMDBiZjMsCiAgICAweGQ1YTc5MTQ3LAogICAgMHgwNmNhNjM1MSwKICAgIDB4MTQyOTI5NjcsCiAgICAweDI3YjcwYTg1LAogICAgMHgyZTFiMjEzOCwKICAgIDB4NGQyYzZkZmMsCiAgICAweDUzMzgwZDEzLAogICAgMHg2NTBhNzM1NCwKICAgIDB4NzY2YTBhYmIsCiAgICAweDgxYzJjOTJlLAogICAgMHg5MjcyMmM4NSwKICAgIDB4YTJiZmU4YTEsCiAgICAweGE4MWE2NjRiLAogICAgMHhjMjRiOGI3MCwKICAgIDB4Yzc2YzUxYTMsCiAgICAweGQxOTJlODE5LAogICAgMHhkNjk5MDYyNCwKICAgIDB4ZjQwZTM1ODUsCiAgICAweDEwNmFhMDcwLAogICAgMHgxOWE0YzExNiwKICAgIDB4MWUzNzZjMDgsCiAgICAweDI3NDg3NzRjLAogICAgMHgzNGIwYmNiNSwKICAgIDB4MzkxYzBjYjMsCiAgICAweDRlZDhhYTRhLAogICAgMHg1YjljY2E0ZiwKICAgIDB4NjgyZTZmZjMsCiAgICAweDc0OGY4MmVlLAogICAgMHg3OGE1NjM2ZiwKICAgIDB4ODRjODc4MTQsCiAgICAweDhjYzcwMjA4LAogICAgMHg5MGJlZmZmYSwKICAgIDB4YTQ1MDZjZWIsCiAgICAweGJlZjlhM2Y3LAogICAgMHhjNjcxNzhmMgpdKTsKCnZhciBJTklUID0gWwogICAgMHg2YTA5ZTY2NywKICAgIDB4YmI2N2FlODUsCiAgICAweDNjNmVmMzcyLAogICAgMHhhNTRmZjUzYSwKICAgIDB4NTEwZTUyN2YsCiAgICAweDliMDU2ODhjLAogICAgMHgxZjgzZDlhYiwKICAgIDB4NWJlMGNkMTksCl07Cgp2YXIgTUFYX0hBU0hBQkxFX0xFTkdUSCA9IE1hdGgucG93KDIsIDUzKSAtIDE7CgovKioKICogQHByaXZhdGUKICovCmZ1bmN0aW9uIFNoYTI1NigpIHsKICAgIHRoaXMuc3RhdGUgPSBbCiAgICAgICAgMHg2YTA5ZTY2NywKICAgICAgICAweGJiNjdhZTg1LAogICAgICAgIDB4M2M2ZWYzNzIsCiAgICAgICAgMHhhNTRmZjUzYSwKICAgICAgICAweDUxMGU1MjdmLAogICAgICAgIDB4OWIwNTY4OGMsCiAgICAgICAgMHgxZjgzZDlhYiwKICAgICAgICAweDViZTBjZDE5LAogICAgXTsKICAgIHRoaXMudGVtcCA9IG5ldyBJbnQzMkFycmF5KDY0KTsKICAgIHRoaXMuYnVmZmVyID0gbmV3IFVpbnQ4QXJyYXkoNjQpOwogICAgdGhpcy5idWZmZXJMZW5ndGggPSAwOwogICAgdGhpcy5ieXRlc0hhc2hlZCA9IDA7CiAgICAvKioKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuZmluaXNoZWQgPSBmYWxzZTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBleHBvcnRzID0gU2hhMjU2OwoKU2hhMjU2LkJMT0NLX1NJWkUgPSBCTE9DS19TSVpFOwoKU2hhMjU2LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgaWYgKHRoaXMuZmluaXNoZWQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB0byB1cGRhdGUgYW4gYWxyZWFkeSBmaW5pc2hlZCBoYXNoLicpOwogICAgfQoKICAgIGlmIChoYXNoVXRpbHMuaXNFbXB0eURhdGEoZGF0YSkpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICBkYXRhID0gaGFzaFV0aWxzLmNvbnZlcnRUb0J1ZmZlcihkYXRhKTsKCiAgICB2YXIgcG9zaXRpb24gPSAwOwogICAgdmFyIGJ5dGVMZW5ndGggPSBkYXRhLmJ5dGVMZW5ndGg7CiAgICB0aGlzLmJ5dGVzSGFzaGVkICs9IGJ5dGVMZW5ndGg7CiAgICBpZiAodGhpcy5ieXRlc0hhc2hlZCAqIDggPiBNQVhfSEFTSEFCTEVfTEVOR1RIKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaGFzaCBtb3JlIHRoYW4gMl41MyAtIDEgYml0cycpOwogICAgfQoKICAgIHdoaWxlIChieXRlTGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuYnVmZmVyW3RoaXMuYnVmZmVyTGVuZ3RoKytdID0gZGF0YVtwb3NpdGlvbisrXTsKICAgICAgICBieXRlTGVuZ3RoLS07CiAgICAgICAgaWYgKHRoaXMuYnVmZmVyTGVuZ3RoID09PSBCTE9DS19TSVpFKSB7CiAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwp9OwoKU2hhMjU2LnByb3RvdHlwZS5kaWdlc3QgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICAgIGlmICghdGhpcy5maW5pc2hlZCkgewogICAgICAgIHZhciBiaXRzSGFzaGVkID0gdGhpcy5ieXRlc0hhc2hlZCAqIDg7CiAgICAgICAgdmFyIGJ1ZmZlclZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIuYnVmZmVyLCB0aGlzLmJ1ZmZlci5ieXRlT2Zmc2V0LCB0aGlzLmJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgICAgICB2YXIgdW5kZWNvcmF0ZWRMZW5ndGggPSB0aGlzLmJ1ZmZlckxlbmd0aDsKICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KHRoaXMuYnVmZmVyTGVuZ3RoKyssIDB4ODApOwogICAgICAgIC8vIEVuc3VyZSB0aGUgZmluYWwgYmxvY2sgaGFzIGVub3VnaCByb29tIGZvciB0aGUgaGFzaGVkIGxlbmd0aAogICAgICAgIGlmICh1bmRlY29yYXRlZExlbmd0aCAlIEJMT0NLX1NJWkUgPj0gQkxPQ0tfU0laRSAtIDgpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuYnVmZmVyTGVuZ3RoOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgICAgICAgICBidWZmZXJWaWV3LnNldFVpbnQ4KGksIDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgICAgICB0aGlzLmJ1ZmZlckxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmJ1ZmZlckxlbmd0aDsgaSA8IEJMT0NLX1NJWkUgLSA4OyBpKyspIHsKICAgICAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50OChpLCAwKTsKICAgICAgICB9CiAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDgsIE1hdGguZmxvb3IoYml0c0hhc2hlZCAvIDB4MTAwMDAwMDAwKSwgdHJ1ZSk7CiAgICAgICAgYnVmZmVyVmlldy5zZXRVaW50MzIoQkxPQ0tfU0laRSAtIDQsIGJpdHNIYXNoZWQpOwogICAgICAgIHRoaXMuaGFzaEJ1ZmZlcigpOwogICAgICAgIHRoaXMuZmluaXNoZWQgPSB0cnVlOwogICAgfQogICAgLy8gVGhlIHZhbHVlIGluIHN0YXRlIGlzIGxpdHRsZS1lbmRpYW4gcmF0aGVyIHRoYW4gYmlnLWVuZGlhbiwgc28gZmxpcAogICAgLy8gZWFjaCB3b3JkIGludG8gYSBuZXcgVWludDhBcnJheQogICAgdmFyIG91dCA9IG5ldyBCdWZmZXIoRElHRVNUX0xFTkdUSCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDg7IGkrKykgewogICAgICAgIG91dFtpICogNF0gPSAodGhpcy5zdGF0ZVtpXSA+Pj4gMjQpICYgMHhmZjsKICAgICAgICBvdXRbaSAqIDQgKyAxXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAxNikgJiAweGZmOwogICAgICAgIG91dFtpICogNCArIDJdID0gKHRoaXMuc3RhdGVbaV0gPj4+IDgpICYgMHhmZjsKICAgICAgICBvdXRbaSAqIDQgKyAzXSA9ICh0aGlzLnN0YXRlW2ldID4+PiAwKSAmIDB4ZmY7CiAgICB9CiAgICByZXR1cm4gZW5jb2RpbmcgPyBvdXQudG9TdHJpbmcoZW5jb2RpbmcpIDogb3V0Owp9OwoKU2hhMjU2LnByb3RvdHlwZS5oYXNoQnVmZmVyID0gZnVuY3Rpb24gKCkgewogICAgdmFyIF9hID0gdGhpcywKICAgICAgICBidWZmZXIgPSBfYS5idWZmZXIsCiAgICAgICAgc3RhdGUgPSBfYS5zdGF0ZTsKICAgIHZhciBzdGF0ZTAgPSBzdGF0ZVswXSwKICAgICAgICBzdGF0ZTEgPSBzdGF0ZVsxXSwKICAgICAgICBzdGF0ZTIgPSBzdGF0ZVsyXSwKICAgICAgICBzdGF0ZTMgPSBzdGF0ZVszXSwKICAgICAgICBzdGF0ZTQgPSBzdGF0ZVs0XSwKICAgICAgICBzdGF0ZTUgPSBzdGF0ZVs1XSwKICAgICAgICBzdGF0ZTYgPSBzdGF0ZVs2XSwKICAgICAgICBzdGF0ZTcgPSBzdGF0ZVs3XTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgQkxPQ0tfU0laRTsgaSsrKSB7CiAgICAgICAgaWYgKGkgPCAxNikgewogICAgICAgICAgICB0aGlzLnRlbXBbaV0gPSAoKChidWZmZXJbaSAqIDRdICYgMHhmZikgPDwgMjQpIHwKICAgICAgICAgICAgICAgICgoYnVmZmVyWyhpICogNCkgKyAxXSAmIDB4ZmYpIDw8IDE2KSB8CiAgICAgICAgICAgICAgICAoKGJ1ZmZlclsoaSAqIDQpICsgMl0gJiAweGZmKSA8PCA4KSB8CiAgICAgICAgICAgICAgICAoYnVmZmVyWyhpICogNCkgKyAzXSAmIDB4ZmYpKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciB1ID0gdGhpcy50ZW1wW2kgLSAyXTsKICAgICAgICAgICAgdmFyIHQxXzEgPSAodSA+Pj4gMTcgfCB1IDw8IDE1KSBeCiAgICAgICAgICAgICAgICAodSA+Pj4gMTkgfCB1IDw8IDEzKSBeCiAgICAgICAgICAgICAgICAodSA+Pj4gMTApOwogICAgICAgICAgICB1ID0gdGhpcy50ZW1wW2kgLSAxNV07CiAgICAgICAgICAgIHZhciB0Ml8xID0gKHUgPj4+IDcgfCB1IDw8IDI1KSBeCiAgICAgICAgICAgICAgICAodSA+Pj4gMTggfCB1IDw8IDE0KSBeCiAgICAgICAgICAgICAgICAodSA+Pj4gMyk7CiAgICAgICAgICAgIHRoaXMudGVtcFtpXSA9ICh0MV8xICsgdGhpcy50ZW1wW2kgLSA3XSB8IDApICsKICAgICAgICAgICAgICAgICh0Ml8xICsgdGhpcy50ZW1wW2kgLSAxNl0gfCAwKTsKICAgICAgICB9CiAgICAgICAgdmFyIHQxID0gKCgoKChzdGF0ZTQgPj4+IDYgfCBzdGF0ZTQgPDwgMjYpIF4KICAgICAgICAgICAgKHN0YXRlNCA+Pj4gMTEgfCBzdGF0ZTQgPDwgMjEpIF4KICAgICAgICAgICAgKHN0YXRlNCA+Pj4gMjUgfCBzdGF0ZTQgPDwgNykpCiAgICAgICAgICAgICsgKChzdGF0ZTQgJiBzdGF0ZTUpIF4gKH5zdGF0ZTQgJiBzdGF0ZTYpKSkgfCAwKQogICAgICAgICAgICArICgoc3RhdGU3ICsgKChLRVlbaV0gKyB0aGlzLnRlbXBbaV0pIHwgMCkpIHwgMCkpIHwgMDsKICAgICAgICB2YXIgdDIgPSAoKChzdGF0ZTAgPj4+IDIgfCBzdGF0ZTAgPDwgMzApIF4KICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMTMgfCBzdGF0ZTAgPDwgMTkpIF4KICAgICAgICAgICAgKHN0YXRlMCA+Pj4gMjIgfCBzdGF0ZTAgPDwgMTApKSArICgoc3RhdGUwICYgc3RhdGUxKSBeIChzdGF0ZTAgJiBzdGF0ZTIpIF4gKHN0YXRlMSAmIHN0YXRlMikpKSB8IDA7CiAgICAgICAgc3RhdGU3ID0gc3RhdGU2OwogICAgICAgIHN0YXRlNiA9IHN0YXRlNTsKICAgICAgICBzdGF0ZTUgPSBzdGF0ZTQ7CiAgICAgICAgc3RhdGU0ID0gKHN0YXRlMyArIHQxKSB8IDA7CiAgICAgICAgc3RhdGUzID0gc3RhdGUyOwogICAgICAgIHN0YXRlMiA9IHN0YXRlMTsKICAgICAgICBzdGF0ZTEgPSBzdGF0ZTA7CiAgICAgICAgc3RhdGUwID0gKHQxICsgdDIpIHwgMDsKICAgIH0KICAgIHN0YXRlWzBdICs9IHN0YXRlMDsKICAgIHN0YXRlWzFdICs9IHN0YXRlMTsKICAgIHN0YXRlWzJdICs9IHN0YXRlMjsKICAgIHN0YXRlWzNdICs9IHN0YXRlMzsKICAgIHN0YXRlWzRdICs9IHN0YXRlNDsKICAgIHN0YXRlWzVdICs9IHN0YXRlNTsKICAgIHN0YXRlWzZdICs9IHN0YXRlNjsKICAgIHN0YXRlWzddICs9IHN0YXRlNzsKfTsKCn0seyIuL2Jyb3dzZXJIYXNoVXRpbHMiOjExLCJidWZmZXIvIjo4NH1dLDE2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7CgovLyBicm93c2VyIHNwZWNpZmljIG1vZHVsZXMKdXRpbC5jcnlwdG8ubGliID0gcmVxdWlyZSgnLi9icm93c2VyQ3J5cHRvTGliJyk7CnV0aWwuQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyLycpLkJ1ZmZlcjsKdXRpbC51cmwgPSByZXF1aXJlKCd1cmwvJyk7CnV0aWwucXVlcnlzdHJpbmcgPSByZXF1aXJlKCdxdWVyeXN0cmluZy8nKTsKdXRpbC5yZWFsQ2xvY2sgPSByZXF1aXJlKCcuL3JlYWxjbG9jay9icm93c2VyQ2xvY2snKTsKdXRpbC5lbnZpcm9ubWVudCA9ICdqcyc7CnV0aWwuY3JlYXRlRXZlbnRTdHJlYW0gPSByZXF1aXJlKCcuL2V2ZW50LXN0cmVhbS9idWZmZXJlZC1jcmVhdGUtZXZlbnQtc3RyZWFtJykuY3JlYXRlRXZlbnRTdHJlYW07CnV0aWwuaXNCcm93c2VyID0gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9Owp1dGlsLmlzTm9kZSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH07Cgp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUzsKCnJlcXVpcmUoJy4vY3JlZGVudGlhbHMnKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzJyk7CnJlcXVpcmUoJy4vY3JlZGVudGlhbHMvY2hhaW5hYmxlX3RlbXBvcmFyeV9jcmVkZW50aWFscycpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzL3dlYl9pZGVudGl0eV9jcmVkZW50aWFscycpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NvZ25pdG9faWRlbnRpdHlfY3JlZGVudGlhbHMnKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscy9zYW1sX2NyZWRlbnRpYWxzJyk7CgovLyBMb2FkIHRoZSBET01QYXJzZXIgWE1MIHBhcnNlcgpBV1MuWE1MLlBhcnNlciA9IHJlcXVpcmUoJy4veG1sL2Jyb3dzZXJfcGFyc2VyJyk7CgovLyBMb2FkIHRoZSBYSFIgSHR0cENsaWVudApyZXF1aXJlKCcuL2h0dHAveGhyJyk7CgppZiAodHlwZW9mIHByb2Nlc3MgPT09ICd1bmRlZmluZWQnKSB7CiAgdmFyIHByb2Nlc3MgPSB7CiAgICBicm93c2VyOiB0cnVlCiAgfTsKfQoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9icm93c2VyQ3J5cHRvTGliIjoxMCwiLi9jb3JlIjoxOSwiLi9jcmVkZW50aWFscyI6MjAsIi4vY3JlZGVudGlhbHMvY2hhaW5hYmxlX3RlbXBvcmFyeV9jcmVkZW50aWFscyI6MjEsIi4vY3JlZGVudGlhbHMvY29nbml0b19pZGVudGl0eV9jcmVkZW50aWFscyI6MjIsIi4vY3JlZGVudGlhbHMvY3JlZGVudGlhbF9wcm92aWRlcl9jaGFpbiI6MjMsIi4vY3JlZGVudGlhbHMvc2FtbF9jcmVkZW50aWFscyI6MjQsIi4vY3JlZGVudGlhbHMvdGVtcG9yYXJ5X2NyZWRlbnRpYWxzIjoyNSwiLi9jcmVkZW50aWFscy93ZWJfaWRlbnRpdHlfY3JlZGVudGlhbHMiOjI2LCIuL2V2ZW50LXN0cmVhbS9idWZmZXJlZC1jcmVhdGUtZXZlbnQtc3RyZWFtIjoyOCwiLi9odHRwL3hociI6MzYsIi4vcmVhbGNsb2NrL2Jyb3dzZXJDbG9jayI6NTMsIi4vdXRpbCI6NzIsIi4veG1sL2Jyb3dzZXJfcGFyc2VyIjo3MywiX3Byb2Nlc3MiOjg5LCJidWZmZXIvIjo4NCwicXVlcnlzdHJpbmcvIjo5NiwidXJsLyI6OTh9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKcmVxdWlyZSgnLi9jcmVkZW50aWFscycpOwpyZXF1aXJlKCcuL2NyZWRlbnRpYWxzL2NyZWRlbnRpYWxfcHJvdmlkZXJfY2hhaW4nKTsKdmFyIFByb21pc2VzRGVwZW5kZW5jeTsKCi8qKgogKiBUaGUgbWFpbiBjb25maWd1cmF0aW9uIGNsYXNzIHVzZWQgYnkgYWxsIHNlcnZpY2Ugb2JqZWN0cyB0byBzZXQKICogdGhlIHJlZ2lvbiwgY3JlZGVudGlhbHMsIGFuZCBvdGhlciBvcHRpb25zIGZvciByZXF1ZXN0cy4KICoKICogQnkgZGVmYXVsdCwgY3JlZGVudGlhbHMgYW5kIHJlZ2lvbiBzZXR0aW5ncyBhcmUgbGVmdCB1bmNvbmZpZ3VyZWQuCiAqIFRoaXMgc2hvdWxkIGJlIGNvbmZpZ3VyZWQgYnkgdGhlIGFwcGxpY2F0aW9uIGJlZm9yZSB1c2luZyBhbnkKICogQVdTIHNlcnZpY2UgQVBJcy4KICoKICogSW4gb3JkZXIgdG8gc2V0IGdsb2JhbCBjb25maWd1cmF0aW9uIG9wdGlvbnMsIHByb3BlcnRpZXMgc2hvdWxkCiAqIGJlIGFzc2lnbmVkIHRvIHRoZSBnbG9iYWwge0FXUy5jb25maWd9IG9iamVjdC4KICoKICogQHNlZSBBV1MuY29uZmlnCiAqCiAqIEAhZ3JvdXAgR2VuZXJhbCBDb25maWd1cmF0aW9uIE9wdGlvbnMKICoKICogQCFhdHRyaWJ1dGUgY3JlZGVudGlhbHMKICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBBV1MgY3JlZGVudGlhbHMgdG8gc2lnbiByZXF1ZXN0cyB3aXRoLgogKgogKiBAIWF0dHJpYnV0ZSByZWdpb24KICogICBAZXhhbXBsZSBTZXQgdGhlIGdsb2JhbCByZWdpb24gc2V0dGluZyB0byB1cy13ZXN0LTIKICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZWdpb246ICd1cy13ZXN0LTInfSk7CiAqICAgQHJldHVybiBbQVdTLkNyZWRlbnRpYWxzXSBUaGUgcmVnaW9uIHRvIHNlbmQgc2VydmljZSByZXF1ZXN0cyB0by4KICogICBAc2VlIGh0dHA6Ly9kb2NzLmFtYXpvbndlYnNlcnZpY2VzLmNvbS9nZW5lcmFsL2xhdGVzdC9nci9yYW5kZS5odG1sCiAqICAgICBBIGxpc3Qgb2YgYXZhaWxhYmxlIGVuZHBvaW50cyBmb3IgZWFjaCBBV1Mgc2VydmljZQogKgogKiBAIWF0dHJpYnV0ZSBtYXhSZXRyaWVzCiAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJldHJpZXMgdG8gcGVyZm9ybSBmb3IgYQogKiAgICAgc2VydmljZSByZXF1ZXN0LiBCeSBkZWZhdWx0IHRoaXMgdmFsdWUgaXMgY2FsY3VsYXRlZCBieSB0aGUgc3BlY2lmaWMKICogICAgIHNlcnZpY2Ugb2JqZWN0IHRoYXQgdGhlIHJlcXVlc3QgaXMgYmVpbmcgbWFkZSB0by4KICoKICogQCFhdHRyaWJ1dGUgbWF4UmVkaXJlY3RzCiAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0byBmb2xsb3cgZm9yIGEKICogICAgIHNlcnZpY2UgcmVxdWVzdC4gRGVmYXVsdHMgdG8gMTAuCiAqCiAqIEAhYXR0cmlidXRlIHBhcmFtVmFsaWRhdGlvbgogKiAgIEByZXR1cm4gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMgc2hvdWxkIGJlIHZhbGlkYXRlZCBhZ2FpbnN0CiAqICAgICB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nIHRoZSByZXF1ZXN0LiBEZWZhdWx0cyB0byB0cnVlLgogKiAgICAgUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZSBmb2xsb3dpbmcgc3BlY2lmaWMgdmFsaWRhdGlvbiBmZWF0dXJlczoKICoKICogICAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAqICAgICAgIHRvIGB0cnVlYC4KICogICAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICogICAgICAgY29uc3RyYWludC4KICogICAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAqICAgICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICogICAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICoKICogQCFhdHRyaWJ1dGUgY29tcHV0ZUNoZWNrc3VtcwogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gY29tcHV0ZSBjaGVja3N1bXMgZm9yIHBheWxvYWQgYm9kaWVzIHdoZW4KICogICAgIHRoZSBzZXJ2aWNlIGFjY2VwdHMgaXQgKGN1cnJlbnRseSBzdXBwb3J0ZWQgaW4gUzMgYW5kIFNRUyBvbmx5KS4KICoKICogQCFhdHRyaWJ1dGUgY29udmVydFJlc3BvbnNlVHlwZXMKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHR5cGVzIGFyZSBjb252ZXJ0ZWQgd2hlbiBwYXJzaW5nIHJlc3BvbnNlIGRhdGEuCiAqICAgICBDdXJyZW50bHkgb25seSBzdXBwb3J0ZWQgZm9yIEpTT04gYmFzZWQgc2VydmljZXMuIFR1cm5pbmcgdGhpcyBvZmYgbWF5CiAqICAgICBpbXByb3ZlIHBlcmZvcm1hbmNlIG9uIGxhcmdlIHJlc3BvbnNlIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAqCiAqIEAhYXR0cmlidXRlIGNvcnJlY3RDbG9ja1NrZXcKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIGFwcGx5IGEgY2xvY2sgc2tldyBjb3JyZWN0aW9uIGFuZCByZXRyeQogKiAgICAgcmVxdWVzdHMgdGhhdCBmYWlsIGJlY2F1c2Ugb2YgYW4gc2tld2VkIGNsaWVudCBjbG9jay4gRGVmYXVsdHMgdG8KICogICAgIGBmYWxzZWAuCiAqCiAqIEAhYXR0cmlidXRlIHNzbEVuYWJsZWQKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIFNTTCBpcyBlbmFibGVkIGZvciByZXF1ZXN0cwogKgogKiBAIWF0dHJpYnV0ZSBzM0ZvcmNlUGF0aFN0eWxlCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBmb3JjZSBwYXRoIHN0eWxlIFVSTHMgZm9yIFMzIG9iamVjdHMKICoKICogQCFhdHRyaWJ1dGUgczNCdWNrZXRFbmRwb2ludAogKiAgIEBub3RlIFNldHRpbmcgdGhpcyBjb25maWd1cmF0aW9uIG9wdGlvbiByZXF1aXJlcyBhbiBgZW5kcG9pbnRgIHRvIGJlCiAqICAgICBwcm92aWRlZCBleHBsaWNpdGx5IHRvIHRoZSBzZXJ2aWNlIGNvbnN0cnVjdG9yLgogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdGhlIHByb3ZpZGVkIGVuZHBvaW50IGFkZHJlc3NlcyBhbiBpbmRpdmlkdWFsCiAqICAgICBidWNrZXQgKGZhbHNlIGlmIGl0IGFkZHJlc3NlcyB0aGUgcm9vdCBBUEkgZW5kcG9pbnQpLgogKgogKiBAIWF0dHJpYnV0ZSBzM0Rpc2FibGVCb2R5U2lnbmluZwogKiAgIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZGlzYWJsZSBTMyBib2R5IHNpZ25pbmcgd2hlbiB1c2luZyBzaWduYXR1cmUgdmVyc2lvbiBgdjRgLgogKiAgICAgQm9keSBzaWduaW5nIGNhbiBvbmx5IGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgaHR0cHMuIERlZmF1bHRzIHRvIGB0cnVlYC4KICoKICogQCFhdHRyaWJ1dGUgczNVc0Vhc3QxUmVnaW9uYWxFbmRwb2ludAogKiAgIEByZXR1cm4gWydsZWdhY3knfCdyZWdpb25hbCddIHdoZW4gcmVnaW9uIGlzIHNldCB0byAndXMtZWFzdC0xJywgd2hldGhlciB0byBzZW5kIHMzCiAqICAgICByZXF1ZXN0IHRvIGdsb2JhbCBlbmRwb2ludHMgb3IgJ3VzLWVhc3QtMScgcmVnaW9uYWwgZW5kcG9pbnRzLiBUaGlzIGNvbmZpZyBpcyBvbmx5CiAqICAgICBhcHBsaWNhYmxlIHRvIFMzIGNsaWVudDsKICogICAgIERlZmF1bHRzIHRvICdsZWdhY3knCiAqIEAhYXR0cmlidXRlIHMzVXNlQXJuUmVnaW9uCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0byBvdmVycmlkZSB0aGUgcmVxdWVzdCByZWdpb24gd2l0aCB0aGUgcmVnaW9uIGluZmVycmVkCiAqICAgICBmcm9tIHJlcXVlc3RlZCByZXNvdXJjZSdzIEFSTi4gT25seSBhdmFpbGFibGUgZm9yIFMzIGJ1Y2tldHMKICogICAgIERlZmF1bHRzIHRvIGB0cnVlYAogKgogKiBAIWF0dHJpYnV0ZSB1c2VBY2NlbGVyYXRlRW5kcG9pbnQKICogICBAbm90ZSBUaGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIGlzIG9ubHkgY29tcGF0aWJsZSB3aXRoIFMzIHdoaWxlIGFjY2Vzc2luZwogKiAgICAgZG5zLWNvbXBhdGlibGUgYnVja2V0cy4KICogICBAcmV0dXJuIFtCb29sZWFuXSBXaGV0aGVyIHRvIHVzZSB0aGUgQWNjZWxlcmF0ZSBlbmRwb2ludCB3aXRoIHRoZSBTMyBzZXJ2aWNlLgogKiAgICAgRGVmYXVsdHMgdG8gYGZhbHNlYC4KICoKICogQCFhdHRyaWJ1dGUgcmV0cnlEZWxheU9wdGlvbnMKICogICBAZXhhbXBsZSBTZXQgdGhlIGJhc2UgcmV0cnkgZGVsYXkgZm9yIGFsbCBzZXJ2aWNlcyB0byAzMDAgbXMKICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2Jhc2U6IDMwMH19KTsKICogICAgIC8vIERlbGF5cyB3aXRoIG1heFJldHJpZXMgPSAzOiAzMDAsIDYwMCwgMTIwMAogKiAgIEBleGFtcGxlIFNldCBhIGN1c3RvbSBiYWNrb2ZmIGZ1bmN0aW9uIHRvIHByb3ZpZGUgZGVsYXkgdmFsdWVzIG9uIHJldHJpZXMKICogICAgIEFXUy5jb25maWcudXBkYXRlKHtyZXRyeURlbGF5T3B0aW9uczoge2N1c3RvbUJhY2tvZmY6IGZ1bmN0aW9uKHJldHJ5Q291bnQsIGVycikgewogKiAgICAgICAvLyByZXR1cm5zIGRlbGF5IGluIG1zCiAqICAgICB9fX0pOwogKiAgIEByZXR1cm4gW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBjb25maWd1cmUgdGhlIHJldHJ5IGRlbGF5IG9uIHJldHJ5YWJsZSBlcnJvcnMuCiAqICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogKgogKiAgICAgKiAqKmJhc2UqKiBbSW50ZWdlcl0gJm1kYXNoOyBUaGUgYmFzZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHVzZSBpbiB0aGUKICogICAgICAgZXhwb25lbnRpYWwgYmFja29mZiBmb3Igb3BlcmF0aW9uIHJldHJpZXMuIERlZmF1bHRzIHRvIDEwMCBtcyBmb3IgYWxsIHNlcnZpY2VzIGV4Y2VwdAogKiAgICAgICBEeW5hbW9EQiwgd2hlcmUgaXQgZGVmYXVsdHMgdG8gNTBtcy4KICoKICogICAgICogKipjdXN0b21CYWNrb2ZmICoqIFtmdW5jdGlvbl0gJm1kYXNoOyBBIGN1c3RvbSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgYQogKiAgICAgICByZXRyeSBjb3VudCBhbmQgZXJyb3IgYW5kIHJldHVybnMgdGhlIGFtb3VudCBvZiB0aW1lIHRvIGRlbGF5IGluCiAqICAgICAgIG1pbGxpc2Vjb25kcy4gSWYgdGhlIHJlc3VsdCBpcyBhIG5vbi16ZXJvIG5lZ2F0aXZlIHZhbHVlLCBubyBmdXJ0aGVyCiAqICAgICAgIHJldHJ5IGF0dGVtcHRzIHdpbGwgYmUgbWFkZS4gVGhlIGBiYXNlYCBvcHRpb24gd2lsbCBiZSBpZ25vcmVkIGlmIHRoaXMKICogICAgICAgb3B0aW9uIGlzIHN1cHBsaWVkLiBUaGUgZnVuY3Rpb24gaXMgb25seSBjYWxsZWQgZm9yIHJldHJ5YWJsZSBlcnJvcnMuCiAqCiAqIEAhYXR0cmlidXRlIGh0dHBPcHRpb25zCiAqICAgQHJldHVybiBbbWFwXSBBIHNldCBvZiBvcHRpb25zIHRvIHBhc3MgdG8gdGhlIGxvdy1sZXZlbCBIVFRQIHJlcXVlc3QuCiAqICAgICBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogKgogKiAgICAgKiAqKnByb3h5KiogW1N0cmluZ10gJm1kYXNoOyB0aGUgVVJMIHRvIHByb3h5IHJlcXVlc3RzIHRocm91Z2gKICogICAgICogKiphZ2VudCoqIFtodHRwLkFnZW50LCBodHRwcy5BZ2VudF0gJm1kYXNoOyB0aGUgQWdlbnQgb2JqZWN0IHRvIHBlcmZvcm0KICogICAgICAgSFRUUCByZXF1ZXN0cyB3aXRoLiBVc2VkIGZvciBjb25uZWN0aW9uIHBvb2xpbmcuIE5vdGUgdGhhdCBmb3IKICogICAgICAgU1NMIGNvbm5lY3Rpb25zLCBhIHNwZWNpYWwgQWdlbnQgb2JqZWN0IGlzIHVzZWQgaW4gb3JkZXIgdG8gZW5hYmxlCiAqICAgICAgIHBlZXIgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uLiBUaGlzIGZlYXR1cmUgaXMgb25seSBzdXBwb3J0ZWQgaW4gdGhlCiAqICAgICAgIE5vZGUuanMgZW52aXJvbm1lbnQuCiAqICAgICAqICoqY29ubmVjdFRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlcgogKiAgICAgICBmYWlsaW5nIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyIGFmdGVyCiAqICAgICAgIGBjb25uZWN0VGltZW91dGAgbWlsbGlzZWNvbmRzLiBUaGlzIHRpbWVvdXQgaGFzIG5vIGVmZmVjdCBvbmNlIGEgc29ja2V0CiAqICAgICAgIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQuCiAqICAgICAqICoqdGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGEgcmVxdWVzdCBjYW4KICogICAgICAgdGFrZSBiZWZvcmUgYXV0b21hdGljYWxseSBiZWluZyB0ZXJtaW5hdGVkLgogKiAgICAgICBEZWZhdWx0cyB0byB0d28gbWludXRlcyAoMTIwMDAwKS4KICogICAgICogKip4aHJBc3luYyoqIFtCb29sZWFuXSAmbWRhc2g7IFdoZXRoZXIgdGhlIFNESyB3aWxsIHNlbmQgYXN5bmNocm9ub3VzCiAqICAgICAgIEhUVFAgcmVxdWVzdHMuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQgb25seS4gU2V0IHRvIGZhbHNlIHRvCiAqICAgICAgIHNlbmQgcmVxdWVzdHMgc3luY2hyb25vdXNseS4gRGVmYXVsdHMgdG8gdHJ1ZSAoYXN5bmMgb24pLgogKiAgICAgKiAqKnhocldpdGhDcmVkZW50aWFscyoqIFtCb29sZWFuXSAmbWRhc2g7IFNldHMgdGhlICJ3aXRoQ3JlZGVudGlhbHMiCiAqICAgICAgIHByb3BlcnR5IG9mIGFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdC4gVXNlZCBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudAogKiAgICAgICBvbmx5LiBEZWZhdWx0cyB0byBmYWxzZS4KICogQCFhdHRyaWJ1dGUgbG9nZ2VyCiAqICAgQHJldHVybiBbI3dyaXRlLCNsb2ddIGFuIG9iamVjdCB0aGF0IHJlc3BvbmRzIHRvIC53cml0ZSgpIChsaWtlIGEgc3RyZWFtKQogKiAgICAgb3IgLmxvZygpIChsaWtlIHRoZSBjb25zb2xlIG9iamVjdCkgaW4gb3JkZXIgdG8gbG9nIGluZm9ybWF0aW9uIGFib3V0CiAqICAgICByZXF1ZXN0cwogKgogKiBAIWF0dHJpYnV0ZSBzeXN0ZW1DbG9ja09mZnNldAogKiAgIEByZXR1cm4gW051bWJlcl0gYW4gb2Zmc2V0IHZhbHVlIGluIG1pbGxpc2Vjb25kcyB0byBhcHBseSB0byBhbGwgc2lnbmluZwogKiAgICAgdGltZXMuIFVzZSB0aGlzIHRvIGNvbXBlbnNhdGUgZm9yIGNsb2NrIHNrZXcgd2hlbiB5b3VyIHN5c3RlbSBtYXkgYmUKICogICAgIG91dCBvZiBzeW5jIHdpdGggdGhlIHNlcnZpY2UgdGltZS4gTm90ZSB0aGF0IHRoaXMgY29uZmlndXJhdGlvbiBvcHRpb24KICogICAgIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gdGhlIGdsb2JhbCBgQVdTLmNvbmZpZ2Agb2JqZWN0IGFuZCBjYW5ub3QgYmUKICogICAgIG92ZXJyaWRkZW4gaW4gc2VydmljZS1zcGVjaWZpYyBjb25maWd1cmF0aW9uLiBEZWZhdWx0cyB0byAwIG1pbGxpc2Vjb25kcy4KICoKICogQCFhdHRyaWJ1dGUgc2lnbmF0dXJlVmVyc2lvbgogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24gcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZwogKiAgICAgdGhlIEFQSSBjb25maWd1cmF0aW9uKS4gUG9zc2libGUgdmFsdWVzIGFyZTogJ3YyJywgJ3YzJywgJ3Y0Jy4KICoKICogQCFhdHRyaWJ1dGUgc2lnbmF0dXJlQ2FjaGUKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBzaWduYXR1cmUgdG8gc2lnbiByZXF1ZXN0cyB3aXRoIChvdmVycmlkaW5nCiAqICAgICB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pIGlzIGNhY2hlZC4gT25seSBhcHBsaWVzIHRvIHRoZSBzaWduYXR1cmUgdmVyc2lvbiAndjQnLgogKiAgICAgRGVmYXVsdHMgdG8gYHRydWVgLgogKgogKiBAIWF0dHJpYnV0ZSBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQKICogICBAcmV0dXJuIFtCb29sZWFufHVuZGVmaW5lZF0gd2hldGhlciB0byBjYWxsIG9wZXJhdGlvbnMgd2l0aCBlbmRwb2ludHMKICogICAgIGdpdmVuIGJ5IHNlcnZpY2UgZHluYW1pY2FsbHkuIFNldHRpbmcgdGhpcyBjb25maWcgdG8gYHRydWVgIHdpbGwgZW5hYmxlCiAqICAgICBlbmRwb2ludCBkaXNjb3ZlcnkgZm9yIGFsbCBhcHBsaWNhYmxlIG9wZXJhdGlvbnMuIFNldHRpbmcgaXQgdG8gYGZhbHNlYAogKiAgICAgd2lsbCBleHBsaWNpdGx5IGRpc2FibGUgZW5kcG9pbnQgZGlzY292ZXJ5IGV2ZW4gdGhvdWdoIG9wZXJhdGlvbnMgdGhhdAogKiAgICAgcmVxdWlyZSBlbmRwb2ludCBkaXNjb3Zlcnkgd2lsbCBwcmVzdW1hYmx5IGZhaWwuIExlYXZpbmcgaXQgdG8KICogICAgIGB1bmRlZmluZWRgIG1lYW5zIFNESyBvbmx5IGRvIGVuZHBvaW50IGRpc2NvdmVyeSB3aGVuIGl0J3MgcmVxdWlyZWQuCiAqICAgICBEZWZhdWx0cyB0byBgdW5kZWZpbmVkYAogKgogKiBAIWF0dHJpYnV0ZSBlbmRwb2ludENhY2hlU2l6ZQogKiAgIEByZXR1cm4gW051bWJlcl0gdGhlIHNpemUgb2YgdGhlIGdsb2JhbCBjYWNoZSBzdG9yaW5nIGVuZHBvaW50cyBmcm9tIGVuZHBvaW50CiAqICAgICBkaXNjb3Zlcnkgb3BlcmF0aW9ucy4gT25jZSBlbmRwb2ludCBjYWNoZSBpcyBjcmVhdGVkLCB1cGRhdGluZyB0aGlzIHNldHRpbmcKICogICAgIGNhbm5vdCBjaGFuZ2UgZXhpc3RpbmcgY2FjaGUgc2l6ZS4KICogICAgIERlZmF1bHRzIHRvIDEwMDAKICoKICogQCFhdHRyaWJ1dGUgaG9zdFByZWZpeEVuYWJsZWQKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRvIG1hcnNoYWwgcmVxdWVzdCBwYXJhbWV0ZXJzIHRvIHRoZSBwcmVmaXggb2YKICogICAgIGhvc3RuYW1lLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAqCiAqIEAhYXR0cmlidXRlIHN0c1JlZ2lvbmFsRW5kcG9pbnRzCiAqICAgQHJldHVybiBbJ2xlZ2FjeSd8J3JlZ2lvbmFsJ10gd2hldGhlciB0byBzZW5kIHN0cyByZXF1ZXN0IHRvIGdsb2JhbCBlbmRwb2ludHMgb3IKICogICAgIHJlZ2lvbmFsIGVuZHBvaW50cy4KICogICAgIERlZmF1bHRzIHRvICdsZWdhY3knLgogKgogKiBAIWF0dHJpYnV0ZSB1c2VGaXBzRW5kcG9pbnQKICogICBAcmV0dXJuIFtCb29sZWFuXSBFbmFibGVzIEZJUFMgY29tcGF0aWJsZSBlbmRwb2ludHMuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAqCiAqIEAhYXR0cmlidXRlIHVzZUR1YWxzdGFja0VuZHBvaW50CiAqICAgQHJldHVybiBbQm9vbGVhbl0gRW5hYmxlcyBJUHY2IGR1YWxzdGFjayBlbmRwb2ludC4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICovCkFXUy5Db25maWcgPSBBV1MudXRpbC5pbmhlcml0KHsKICAvKioKICAgKiBAIWVuZGdyb3VwCiAgICovCgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgY29uZmlndXJhdGlvbiBvYmplY3QuIFRoaXMgaXMgdGhlIG9iamVjdCB0aGF0IHBhc3NlcwogICAqIG9wdGlvbiBkYXRhIGFsb25nIHRvIHNlcnZpY2UgcmVxdWVzdHMsIGluY2x1ZGluZyBjcmVkZW50aWFscywgc2VjdXJpdHksCiAgICogcmVnaW9uIGluZm9ybWF0aW9uLCBhbmQgc29tZSBzZXJ2aWNlIHNwZWNpZmljIHNldHRpbmdzLgogICAqCiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBjcmVkZW50aWFscyBhbmQgcmVnaW9uCiAgICogICB2YXIgY29uZmlnID0gbmV3IEFXUy5Db25maWcoewogICAqICAgICBhY2Nlc3NLZXlJZDogJ0FLSUQnLCBzZWNyZXRBY2Nlc3NLZXk6ICdTRUNSRVQnLCByZWdpb246ICd1cy13ZXN0LTInCiAgICogICB9KTsKICAgKiBAb3B0aW9uIG9wdGlvbnMgYWNjZXNzS2V5SWQgW1N0cmluZ10geW91ciBBV1MgYWNjZXNzIGtleSBJRC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgc2VjcmV0QWNjZXNzS2V5IFtTdHJpbmddIHlvdXIgQVdTIHNlY3JldCBhY2Nlc3Mga2V5LgogICAqIEBvcHRpb24gb3B0aW9ucyBzZXNzaW9uVG9rZW4gW0FXUy5DcmVkZW50aWFsc10gdGhlIG9wdGlvbmFsIEFXUwogICAqICAgc2Vzc2lvbiB0b2tlbiB0byBzaWduIHJlcXVlc3RzIHdpdGguCiAgICogQG9wdGlvbiBvcHRpb25zIGNyZWRlbnRpYWxzIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBBV1MgY3JlZGVudGlhbHMKICAgKiAgIHRvIHNpZ24gcmVxdWVzdHMgd2l0aC4gWW91IGNhbiBlaXRoZXIgc3BlY2lmeSB0aGlzIG9iamVjdCwgb3IKICAgKiAgIHNwZWNpZnkgdGhlIGFjY2Vzc0tleUlkIGFuZCBzZWNyZXRBY2Nlc3NLZXkgb3B0aW9ucyBkaXJlY3RseS4KICAgKiBAb3B0aW9uIG9wdGlvbnMgY3JlZGVudGlhbFByb3ZpZGVyIFtBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dIHRoZQogICAqICAgcHJvdmlkZXIgY2hhaW4gdXNlZCB0byByZXNvbHZlIGNyZWRlbnRpYWxzIGlmIG5vIHN0YXRpYyBgY3JlZGVudGlhbHNgCiAgICogICBwcm9wZXJ0eSBpcyBzZXQuCiAgICogQG9wdGlvbiBvcHRpb25zIHJlZ2lvbiBbU3RyaW5nXSB0aGUgcmVnaW9uIHRvIHNlbmQgc2VydmljZSByZXF1ZXN0cyB0by4KICAgKiAgIFNlZSB7cmVnaW9ufSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgKiBAb3B0aW9uIG9wdGlvbnMgbWF4UmV0cmllcyBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJldHJpZXMgdG8KICAgKiAgIGF0dGVtcHQgd2l0aCBhIHJlcXVlc3QuIFNlZSB7bWF4UmV0cmllc30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICogQG9wdGlvbiBvcHRpb25zIG1heFJlZGlyZWN0cyBbSW50ZWdlcl0gdGhlIG1heGltdW0gYW1vdW50IG9mIHJlZGlyZWN0cyB0bwogICAqICAgZm9sbG93IHdpdGggYSByZXF1ZXN0LiBTZWUge21heFJlZGlyZWN0c30gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICogQG9wdGlvbiBvcHRpb25zIHNzbEVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZW5hYmxlIFNTTCBmb3IKICAgKiAgIHJlcXVlc3RzLgogICAqIEBvcHRpb24gb3B0aW9ucyBwYXJhbVZhbGlkYXRpb24gW0Jvb2xlYW58bWFwXSB3aGV0aGVyIGlucHV0IHBhcmFtZXRlcnMKICAgKiAgIHNob3VsZCBiZSB2YWxpZGF0ZWQgYWdhaW5zdCB0aGUgb3BlcmF0aW9uIGRlc2NyaXB0aW9uIGJlZm9yZSBzZW5kaW5nCiAgICogICB0aGUgcmVxdWVzdC4gRGVmYXVsdHMgdG8gdHJ1ZS4gUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZQogICAqICAgZm9sbG93aW5nIHNwZWNpZmljIHZhbGlkYXRpb24gZmVhdHVyZXM6CiAgICoKICAgKiAgICogKiptaW4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtaW4KICAgKiAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICogICAgIHRvIGB0cnVlYC4KICAgKiAgICogKiptYXgqKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHZhbHVlIG1lZXRzIHRoZSBtYXgKICAgKiAgICAgY29uc3RyYWludC4KICAgKiAgICogKipwYXR0ZXJuKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBhCiAgICogICAgIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgKiAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgKiAgICAgb2YgdGhlIGFsbG93YWJsZSBlbnVtIHZhbHVlcy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgY29tcHV0ZUNoZWNrc3VtcyBbQm9vbGVhbl0gd2hldGhlciB0byBjb21wdXRlIGNoZWNrc3VtcwogICAqICAgZm9yIHBheWxvYWQgYm9kaWVzIHdoZW4gdGhlIHNlcnZpY2UgYWNjZXB0cyBpdCAoY3VycmVudGx5IHN1cHBvcnRlZAogICAqICAgaW4gUzMgb25seSkKICAgKiBAb3B0aW9uIG9wdGlvbnMgY29udmVydFJlc3BvbnNlVHlwZXMgW0Jvb2xlYW5dIHdoZXRoZXIgdHlwZXMgYXJlIGNvbnZlcnRlZAogICAqICAgICB3aGVuIHBhcnNpbmcgcmVzcG9uc2UgZGF0YS4gQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGZvciBKU09OIGJhc2VkCiAgICogICAgIHNlcnZpY2VzLiBUdXJuaW5nIHRoaXMgb2ZmIG1heSBpbXByb3ZlIHBlcmZvcm1hbmNlIG9uIGxhcmdlIHJlc3BvbnNlCiAgICogICAgIHBheWxvYWRzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIGNvcnJlY3RDbG9ja1NrZXcgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gYXBwbHkgYSBjbG9jayBza2V3CiAgICogICAgIGNvcnJlY3Rpb24gYW5kIHJldHJ5IHJlcXVlc3RzIHRoYXQgZmFpbCBiZWNhdXNlIG9mIGFuIHNrZXdlZCBjbGllbnQKICAgKiAgICAgY2xvY2suIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIHMzRm9yY2VQYXRoU3R5bGUgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gZm9yY2UgcGF0aAogICAqICAgc3R5bGUgVVJMcyBmb3IgUzMgb2JqZWN0cy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgczNCdWNrZXRFbmRwb2ludCBbQm9vbGVhbl0gd2hldGhlciB0aGUgcHJvdmlkZWQgZW5kcG9pbnQKICAgKiAgIGFkZHJlc3NlcyBhbiBpbmRpdmlkdWFsIGJ1Y2tldCAoZmFsc2UgaWYgaXQgYWRkcmVzc2VzIHRoZSByb290IEFQSQogICAqICAgZW5kcG9pbnQpLiBOb3RlIHRoYXQgc2V0dGluZyB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIHJlcXVpcmVzIGFuCiAgICogICBgZW5kcG9pbnRgIHRvIGJlIHByb3ZpZGVkIGV4cGxpY2l0bHkgdG8gdGhlIHNlcnZpY2UgY29uc3RydWN0b3IuCiAgICogQG9wdGlvbiBvcHRpb25zIHMzRGlzYWJsZUJvZHlTaWduaW5nIFtCb29sZWFuXSB3aGV0aGVyIFMzIGJvZHkgc2lnbmluZwogICAqICAgc2hvdWxkIGJlIGRpc2FibGVkIHdoZW4gdXNpbmcgc2lnbmF0dXJlIHZlcnNpb24gYHY0YC4gQm9keSBzaWduaW5nCiAgICogICBjYW4gb25seSBiZSBkaXNhYmxlZCB3aGVuIHVzaW5nIGh0dHBzLiBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIHMzVXNFYXN0MVJlZ2lvbmFsRW5kcG9pbnQgWydsZWdhY3knfCdyZWdpb25hbCddIHdoZW4gcmVnaW9uCiAgICogICBpcyBzZXQgdG8gJ3VzLWVhc3QtMScsIHdoZXRoZXIgdG8gc2VuZCBzMyByZXF1ZXN0IHRvIGdsb2JhbCBlbmRwb2ludHMgb3IKICAgKiAgICd1cy1lYXN0LTEnIHJlZ2lvbmFsIGVuZHBvaW50cy4gVGhpcyBjb25maWcgaXMgb25seSBhcHBsaWNhYmxlIHRvIFMzIGNsaWVudC4KICAgKiAgIERlZmF1bHRzIHRvIGBsZWdhY3lgCiAgICogQG9wdGlvbiBvcHRpb25zIHMzVXNlQXJuUmVnaW9uIFtCb29sZWFuXSB3aGV0aGVyIHRvIG92ZXJyaWRlIHRoZSByZXF1ZXN0IHJlZ2lvbgogICAqICAgd2l0aCB0aGUgcmVnaW9uIGluZmVycmVkIGZyb20gcmVxdWVzdGVkIHJlc291cmNlJ3MgQVJOLiBPbmx5IGF2YWlsYWJsZSBmb3IgUzMgYnVja2V0cwogICAqICAgRGVmYXVsdHMgdG8gYHRydWVgCiAgICoKICAgKiBAb3B0aW9uIG9wdGlvbnMgcmV0cnlEZWxheU9wdGlvbnMgW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBjb25maWd1cmUKICAgKiAgIHRoZSByZXRyeSBkZWxheSBvbiByZXRyeWFibGUgZXJyb3JzLiBDdXJyZW50bHkgc3VwcG9ydGVkIG9wdGlvbnMgYXJlOgogICAqCiAgICogICAqICoqYmFzZSoqIFtJbnRlZ2VyXSAmbWRhc2g7IFRoZSBiYXNlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gdXNlIGluIHRoZQogICAqICAgICBleHBvbmVudGlhbCBiYWNrb2ZmIGZvciBvcGVyYXRpb24gcmV0cmllcy4gRGVmYXVsdHMgdG8gMTAwIG1zIGZvciBhbGwKICAgKiAgICAgc2VydmljZXMgZXhjZXB0IER5bmFtb0RCLCB3aGVyZSBpdCBkZWZhdWx0cyB0byA1MG1zLgogICAqICAgKiAqKmN1c3RvbUJhY2tvZmYgKiogW2Z1bmN0aW9uXSAmbWRhc2g7IEEgY3VzdG9tIGZ1bmN0aW9uIHRoYXQgYWNjZXB0cyBhCiAgICogICAgIHJldHJ5IGNvdW50IGFuZCBlcnJvciBhbmQgcmV0dXJucyB0aGUgYW1vdW50IG9mIHRpbWUgdG8gZGVsYXkgaW4KICAgKiAgICAgbWlsbGlzZWNvbmRzLiBJZiB0aGUgcmVzdWx0IGlzIGEgbm9uLXplcm8gbmVnYXRpdmUgdmFsdWUsIG5vIGZ1cnRoZXIKICAgKiAgICAgcmV0cnkgYXR0ZW1wdHMgd2lsbCBiZSBtYWRlLiBUaGUgYGJhc2VgIG9wdGlvbiB3aWxsIGJlIGlnbm9yZWQgaWYgdGhpcwogICAqICAgICBvcHRpb24gaXMgc3VwcGxpZWQuIFRoZSBmdW5jdGlvbiBpcyBvbmx5IGNhbGxlZCBmb3IgcmV0cnlhYmxlIGVycm9ycy4KICAgKiBAb3B0aW9uIG9wdGlvbnMgaHR0cE9wdGlvbnMgW21hcF0gQSBzZXQgb2Ygb3B0aW9ucyB0byBwYXNzIHRvIHRoZSBsb3ctbGV2ZWwKICAgKiAgIEhUVFAgcmVxdWVzdC4gQ3VycmVudGx5IHN1cHBvcnRlZCBvcHRpb25zIGFyZToKICAgKgogICAqICAgKiAqKnByb3h5KiogW1N0cmluZ10gJm1kYXNoOyB0aGUgVVJMIHRvIHByb3h5IHJlcXVlc3RzIHRocm91Z2gKICAgKiAgICogKiphZ2VudCoqIFtodHRwLkFnZW50LCBodHRwcy5BZ2VudF0gJm1kYXNoOyB0aGUgQWdlbnQgb2JqZWN0IHRvIHBlcmZvcm0KICAgKiAgICAgSFRUUCByZXF1ZXN0cyB3aXRoLiBVc2VkIGZvciBjb25uZWN0aW9uIHBvb2xpbmcuIERlZmF1bHRzIHRvIHRoZSBnbG9iYWwKICAgKiAgICAgYWdlbnQgKGBodHRwLmdsb2JhbEFnZW50YCkgZm9yIG5vbi1TU0wgY29ubmVjdGlvbnMuIE5vdGUgdGhhdCBmb3IKICAgKiAgICAgU1NMIGNvbm5lY3Rpb25zLCBhIHNwZWNpYWwgQWdlbnQgb2JqZWN0IGlzIHVzZWQgaW4gb3JkZXIgdG8gZW5hYmxlCiAgICogICAgIHBlZXIgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uLiBUaGlzIGZlYXR1cmUgaXMgb25seSBhdmFpbGFibGUgaW4gdGhlCiAgICogICAgIE5vZGUuanMgZW52aXJvbm1lbnQuCiAgICogICAqICoqY29ubmVjdFRpbWVvdXQqKiBbSW50ZWdlcl0gJm1kYXNoOyBTZXRzIHRoZSBzb2NrZXQgdG8gdGltZW91dCBhZnRlcgogICAqICAgICBmYWlsaW5nIHRvIGVzdGFibGlzaCBhIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyIGFmdGVyCiAgICogICAgIGBjb25uZWN0VGltZW91dGAgbWlsbGlzZWNvbmRzLiBUaGlzIHRpbWVvdXQgaGFzIG5vIGVmZmVjdCBvbmNlIGEgc29ja2V0CiAgICogICAgIGNvbm5lY3Rpb24gaGFzIGJlZW4gZXN0YWJsaXNoZWQuCiAgICogICAqICoqdGltZW91dCoqIFtJbnRlZ2VyXSAmbWRhc2g7IFNldHMgdGhlIHNvY2tldCB0byB0aW1lb3V0IGFmdGVyIHRpbWVvdXQKICAgKiAgICAgbWlsbGlzZWNvbmRzIG9mIGluYWN0aXZpdHkgb24gdGhlIHNvY2tldC4gRGVmYXVsdHMgdG8gdHdvIG1pbnV0ZXMKICAgKiAgICAgKDEyMDAwMCkuCiAgICogICAqICoqeGhyQXN5bmMqKiBbQm9vbGVhbl0gJm1kYXNoOyBXaGV0aGVyIHRoZSBTREsgd2lsbCBzZW5kIGFzeW5jaHJvbm91cwogICAqICAgICBIVFRQIHJlcXVlc3RzLiBVc2VkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9ubHkuIFNldCB0byBmYWxzZSB0bwogICAqICAgICBzZW5kIHJlcXVlc3RzIHN5bmNocm9ub3VzbHkuIERlZmF1bHRzIHRvIHRydWUgKGFzeW5jIG9uKS4KICAgKiAgICogKip4aHJXaXRoQ3JlZGVudGlhbHMqKiBbQm9vbGVhbl0gJm1kYXNoOyBTZXRzIHRoZSAid2l0aENyZWRlbnRpYWxzIgogICAqICAgICBwcm9wZXJ0eSBvZiBhbiBYTUxIdHRwUmVxdWVzdCBvYmplY3QuIFVzZWQgaW4gdGhlIGJyb3dzZXIgZW52aXJvbm1lbnQKICAgKiAgICAgb25seS4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICogQG9wdGlvbiBvcHRpb25zIGFwaVZlcnNpb24gW1N0cmluZywgRGF0ZV0gYSBTdHJpbmcgaW4gWVlZWS1NTS1ERCBmb3JtYXQKICAgKiAgIChvciBhIGRhdGUpIHRoYXQgcmVwcmVzZW50cyB0aGUgbGF0ZXN0IHBvc3NpYmxlIEFQSSB2ZXJzaW9uIHRoYXQgY2FuIGJlCiAgICogICB1c2VkIGluIGFsbCBzZXJ2aWNlcyAodW5sZXNzIG92ZXJyaWRkZW4gYnkgYGFwaVZlcnNpb25zYCkuIFNwZWNpZnkKICAgKiAgICdsYXRlc3QnIHRvIHVzZSB0aGUgbGF0ZXN0IHBvc3NpYmxlIHZlcnNpb24uCiAgICogQG9wdGlvbiBvcHRpb25zIGFwaVZlcnNpb25zIFttYXA8U3RyaW5nLCBTdHJpbmd8RGF0ZT5dIGEgbWFwIG9mIHNlcnZpY2UKICAgKiAgIGlkZW50aWZpZXJzICh0aGUgbG93ZXJjYXNlIHNlcnZpY2UgY2xhc3MgbmFtZSkgd2l0aCB0aGUgQVBJIHZlcnNpb24gdG8KICAgKiAgIHVzZSB3aGVuIGluc3RhbnRpYXRpbmcgYSBzZXJ2aWNlLiBTcGVjaWZ5ICdsYXRlc3QnIGZvciBlYWNoIGluZGl2aWR1YWwKICAgKiAgIHRoYXQgY2FuIHVzZSB0aGUgbGF0ZXN0IGF2YWlsYWJsZSB2ZXJzaW9uLgogICAqIEBvcHRpb24gb3B0aW9ucyBsb2dnZXIgWyN3cml0ZSwjbG9nXSBhbiBvYmplY3QgdGhhdCByZXNwb25kcyB0byAud3JpdGUoKQogICAqICAgKGxpa2UgYSBzdHJlYW0pIG9yIC5sb2coKSAobGlrZSB0aGUgY29uc29sZSBvYmplY3QpIGluIG9yZGVyIHRvIGxvZwogICAqICAgaW5mb3JtYXRpb24gYWJvdXQgcmVxdWVzdHMKICAgKiBAb3B0aW9uIG9wdGlvbnMgc3lzdGVtQ2xvY2tPZmZzZXQgW051bWJlcl0gYW4gb2Zmc2V0IHZhbHVlIGluIG1pbGxpc2Vjb25kcwogICAqICAgdG8gYXBwbHkgdG8gYWxsIHNpZ25pbmcgdGltZXMuIFVzZSB0aGlzIHRvIGNvbXBlbnNhdGUgZm9yIGNsb2NrIHNrZXcKICAgKiAgIHdoZW4geW91ciBzeXN0ZW0gbWF5IGJlIG91dCBvZiBzeW5jIHdpdGggdGhlIHNlcnZpY2UgdGltZS4gTm90ZSB0aGF0CiAgICogICB0aGlzIGNvbmZpZ3VyYXRpb24gb3B0aW9uIGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gdGhlIGdsb2JhbCBgQVdTLmNvbmZpZ2AKICAgKiAgIG9iamVjdCBhbmQgY2Fubm90IGJlIG92ZXJyaWRkZW4gaW4gc2VydmljZS1zcGVjaWZpYyBjb25maWd1cmF0aW9uLgogICAqICAgRGVmYXVsdHMgdG8gMCBtaWxsaXNlY29uZHMuCiAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZVZlcnNpb24gW1N0cmluZ10gdGhlIHNpZ25hdHVyZSB2ZXJzaW9uIHRvIHNpZ24KICAgKiAgIHJlcXVlc3RzIHdpdGggKG92ZXJyaWRpbmcgdGhlIEFQSSBjb25maWd1cmF0aW9uKS4gUG9zc2libGUgdmFsdWVzIGFyZToKICAgKiAgICd2MicsICd2MycsICd2NCcuCiAgICogQG9wdGlvbiBvcHRpb25zIHNpZ25hdHVyZUNhY2hlIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBzaWduYXR1cmUgdG8gc2lnbgogICAqICAgcmVxdWVzdHMgd2l0aCAob3ZlcnJpZGluZyB0aGUgQVBJIGNvbmZpZ3VyYXRpb24pIGlzIGNhY2hlZC4gT25seSBhcHBsaWVzCiAgICogICB0byB0aGUgc2lnbmF0dXJlIHZlcnNpb24gJ3Y0Jy4gRGVmYXVsdHMgdG8gYHRydWVgLgogICAqIEBvcHRpb24gb3B0aW9ucyBkeW5hbW9EYkNyYzMyIFtCb29sZWFuXSB3aGV0aGVyIHRvIHZhbGlkYXRlIHRoZSBDUkMzMgogICAqICAgY2hlY2tzdW0gb2YgSFRUUCByZXNwb25zZSBib2RpZXMgcmV0dXJuZWQgYnkgRHluYW1vREIuIERlZmF1bHQ6IGB0cnVlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgdXNlQWNjZWxlcmF0ZUVuZHBvaW50IFtCb29sZWFuXSBXaGV0aGVyIHRvIHVzZSB0aGUKICAgKiAgIFMzIFRyYW5zZmVyIEFjY2VsZXJhdGlvbiBlbmRwb2ludCB3aXRoIHRoZSBTMyBzZXJ2aWNlLiBEZWZhdWx0OiBgZmFsc2VgLgogICAqIEBvcHRpb24gb3B0aW9ucyBjbGllbnRTaWRlTW9uaXRvcmluZyBbQm9vbGVhbl0gd2hldGhlciB0byBjb2xsZWN0IGFuZAogICAqICAgcHVibGlzaCB0aGlzIGNsaWVudCdzIHBlcmZvcm1hbmNlIG1ldHJpY3Mgb2YgYWxsIGl0cyBBUEkgcmVxdWVzdHMuCiAgICogQG9wdGlvbiBvcHRpb25zIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCBbQm9vbGVhbnx1bmRlZmluZWRdIHdoZXRoZXIgdG8KICAgKiAgIGNhbGwgb3BlcmF0aW9ucyB3aXRoIGVuZHBvaW50cyBnaXZlbiBieSBzZXJ2aWNlIGR5bmFtaWNhbGx5LiBTZXR0aW5nIHRoaXMKICAgKiBjb25maWcgdG8gYHRydWVgIHdpbGwgZW5hYmxlIGVuZHBvaW50IGRpc2NvdmVyeSBmb3IgYWxsIGFwcGxpY2FibGUgb3BlcmF0aW9ucy4KICAgKiAgIFNldHRpbmcgaXQgdG8gYGZhbHNlYCB3aWxsIGV4cGxpY2l0bHkgZGlzYWJsZSBlbmRwb2ludCBkaXNjb3ZlcnkgZXZlbiB0aG91Z2gKICAgKiAgIG9wZXJhdGlvbnMgdGhhdCByZXF1aXJlIGVuZHBvaW50IGRpc2NvdmVyeSB3aWxsIHByZXN1bWFibHkgZmFpbC4gTGVhdmluZyBpdAogICAqICAgdG8gYHVuZGVmaW5lZGAgbWVhbnMgU0RLIHdpbGwgb25seSBkbyBlbmRwb2ludCBkaXNjb3Zlcnkgd2hlbiBpdCdzIHJlcXVpcmVkLgogICAqICAgRGVmYXVsdHMgdG8gYHVuZGVmaW5lZGAKICAgKiBAb3B0aW9uIG9wdGlvbnMgZW5kcG9pbnRDYWNoZVNpemUgW051bWJlcl0gdGhlIHNpemUgb2YgdGhlIGdsb2JhbCBjYWNoZSBzdG9yaW5nCiAgICogICBlbmRwb2ludHMgZnJvbSBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9ucy4gT25jZSBlbmRwb2ludCBjYWNoZSBpcyBjcmVhdGVkLAogICAqICAgdXBkYXRpbmcgdGhpcyBzZXR0aW5nIGNhbm5vdCBjaGFuZ2UgZXhpc3RpbmcgY2FjaGUgc2l6ZS4KICAgKiAgIERlZmF1bHRzIHRvIDEwMDAKICAgKiBAb3B0aW9uIG9wdGlvbnMgaG9zdFByZWZpeEVuYWJsZWQgW0Jvb2xlYW5dIHdoZXRoZXIgdG8gbWFyc2hhbCByZXF1ZXN0CiAgICogICBwYXJhbWV0ZXJzIHRvIHRoZSBwcmVmaXggb2YgaG9zdG5hbWUuCiAgICogICBEZWZhdWx0cyB0byBgdHJ1ZWAuCiAgICogQG9wdGlvbiBvcHRpb25zIHN0c1JlZ2lvbmFsRW5kcG9pbnRzIFsnbGVnYWN5J3wncmVnaW9uYWwnXSB3aGV0aGVyIHRvIHNlbmQgc3RzIHJlcXVlc3QKICAgKiAgIHRvIGdsb2JhbCBlbmRwb2ludHMgb3IgcmVnaW9uYWwgZW5kcG9pbnRzLgogICAqICAgRGVmYXVsdHMgdG8gJ2xlZ2FjeScuCiAgICogQG9wdGlvbiBvcHRpb25zIHVzZUZpcHNFbmRwb2ludCBbQm9vbGVhbl0gRW5hYmxlcyBGSVBTIGNvbXBhdGlibGUgZW5kcG9pbnRzLgogICAqICAgRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgKiBAb3B0aW9uIG9wdGlvbnMgdXNlRHVhbHN0YWNrRW5kcG9pbnQgW0Jvb2xlYW5dIEVuYWJsZXMgSVB2NiBkdWFsc3RhY2sgZW5kcG9pbnQuCiAgICogICBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDb25maWcob3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMgPT09IHVuZGVmaW5lZCkgb3B0aW9ucyA9IHt9OwogICAgb3B0aW9ucyA9IHRoaXMuZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpOwoKICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLmtleXMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgIHRoaXMuc2V0KGtleSwgb3B0aW9uc1trZXldLCB2YWx1ZSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAIWdyb3VwIE1hbmFnaW5nIENyZWRlbnRpYWxzCiAgICovCgogIC8qKgogICAqIExvYWRzIGNyZWRlbnRpYWxzIGZyb20gdGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0LiBUaGlzIGlzIHVzZWQgaW50ZXJuYWxseQogICAqIGJ5IHRoZSBTREsgdG8gZW5zdXJlIHRoYXQgcmVmcmVzaGFibGUge0NyZWRlbnRpYWxzfSBvYmplY3RzIGFyZSBwcm9wZXJseQogICAqIHJlZnJlc2hlZCBhbmQgbG9hZGVkIHdoZW4gc2VuZGluZyBhIHJlcXVlc3QuIElmIHlvdSB3YW50IHRvIGVuc3VyZSB0aGF0CiAgICogeW91ciBjcmVkZW50aWFscyBhcmUgbG9hZGVkIHByaW9yIHRvIGEgcmVxdWVzdCwgeW91IGNhbiB1c2UgdGhpcyBtZXRob2QKICAgKiBkaXJlY3RseSB0byBwcm92aWRlIGFjY3VyYXRlIGNyZWRlbnRpYWwgZGF0YSBzdG9yZWQgaW4gdGhlIG9iamVjdC4KICAgKgogICAqIEBub3RlIElmIHlvdSBjb25maWd1cmUgdGhlIFNESyB3aXRoIHN0YXRpYyBvciBlbnZpcm9ubWVudCBjcmVkZW50aWFscywKICAgKiAgIHRoZSBjcmVkZW50aWFsIGRhdGEgc2hvdWxkIGFscmVhZHkgYmUgcHJlc2VudCBpbiB7Y3JlZGVudGlhbHN9IGF0dHJpYnV0ZS4KICAgKiAgIFRoaXMgbWV0aG9kIGlzIHByaW1hcmlseSBuZWNlc3NhcnkgdG8gbG9hZCBjcmVkZW50aWFscyBmcm9tIGFzeW5jaHJvbm91cwogICAqICAgc291cmNlcywgb3Igc291cmNlcyB0aGF0IGNhbiByZWZyZXNoIGNyZWRlbnRpYWxzIHBlcmlvZGljYWxseS4KICAgKiBAZXhhbXBsZSBHZXR0aW5nIHlvdXIgYWNjZXNzIGtleQogICAqICAgQVdTLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbihlcnIpIHsKICAgKiAgICAgaWYgKGVycikgY29uc29sZS5sb2coZXJyLnN0YWNrKTsgLy8gY3JlZGVudGlhbHMgbm90IGxvYWRlZAogICAqICAgICBlbHNlIGNvbnNvbGUubG9nKCJBY2Nlc3MgS2V5OiIsIEFXUy5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQpOwogICAqICAgfSkKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgQ2FsbGVkIHdoZW4gdGhlIHtjcmVkZW50aWFsc30gaGF2ZSBiZWVuIHByb3Blcmx5IHNldCBvbiB0aGUgY29uZmlndXJhdGlvbgogICAqICAgb2JqZWN0LgogICAqCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgdGhpcyBpcyBzZXQsIGNyZWRlbnRpYWxzIHdlcmUgbm90IHN1Y2Nlc3NmdWxseQogICAqICAgICBsb2FkZWQgYW5kIHRoaXMgZXJyb3IgcHJvdmlkZXMgaW5mb3JtYXRpb24gd2h5LgogICAqIEBzZWUgY3JlZGVudGlhbHMKICAgKiBAc2VlIENyZWRlbnRpYWxzCiAgICovCiAgZ2V0Q3JlZGVudGlhbHM6IGZ1bmN0aW9uIGdldENyZWRlbnRpYWxzKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgZnVuY3Rpb24gZmluaXNoKGVycikgewogICAgICBjYWxsYmFjayhlcnIsIGVyciA/IG51bGwgOiBzZWxmLmNyZWRlbnRpYWxzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVkRXJyb3IobXNnLCBlcnIpIHsKICAgICAgcmV0dXJuIG5ldyBBV1MudXRpbC5lcnJvcihlcnIgfHwgbmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnQ3JlZGVudGlhbHNFcnJvcicsCiAgICAgICAgbWVzc2FnZTogbXNnLAogICAgICAgIG5hbWU6ICdDcmVkZW50aWFsc0Vycm9yJwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRBc3luY0NyZWRlbnRpYWxzKCkgewogICAgICBzZWxmLmNyZWRlbnRpYWxzLmdldChmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICB2YXIgbXNnID0gJ0NvdWxkIG5vdCBsb2FkIGNyZWRlbnRpYWxzIGZyb20gJyArCiAgICAgICAgICAgIHNlbGYuY3JlZGVudGlhbHMuY29uc3RydWN0b3IubmFtZTsKICAgICAgICAgIGVyciA9IGNyZWRFcnJvcihtc2csIGVycik7CiAgICAgICAgfQogICAgICAgIGZpbmlzaChlcnIpOwogICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRTdGF0aWNDcmVkZW50aWFscygpIHsKICAgICAgdmFyIGVyciA9IG51bGw7CiAgICAgIGlmICghc2VsZi5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZCB8fCAhc2VsZi5jcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkpIHsKICAgICAgICBlcnIgPSBjcmVkRXJyb3IoJ01pc3NpbmcgY3JlZGVudGlhbHMnKTsKICAgICAgfQogICAgICBmaW5pc2goZXJyKTsKICAgIH0KCiAgICBpZiAoc2VsZi5jcmVkZW50aWFscykgewogICAgICBpZiAodHlwZW9mIHNlbGYuY3JlZGVudGlhbHMuZ2V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgZ2V0QXN5bmNDcmVkZW50aWFscygpOwogICAgICB9IGVsc2UgeyAvLyBzdGF0aWMgY3JlZGVudGlhbHMKICAgICAgICBnZXRTdGF0aWNDcmVkZW50aWFscygpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHNlbGYuY3JlZGVudGlhbFByb3ZpZGVyKSB7CiAgICAgIHNlbGYuY3JlZGVudGlhbFByb3ZpZGVyLnJlc29sdmUoZnVuY3Rpb24oZXJyLCBjcmVkcykgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIGVyciA9IGNyZWRFcnJvcignQ291bGQgbm90IGxvYWQgY3JlZGVudGlhbHMgZnJvbSBhbnkgcHJvdmlkZXJzJywgZXJyKTsKICAgICAgICB9CiAgICAgICAgc2VsZi5jcmVkZW50aWFscyA9IGNyZWRzOwogICAgICAgIGZpbmlzaChlcnIpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGZpbmlzaChjcmVkRXJyb3IoJ05vIGNyZWRlbnRpYWxzIHRvIGxvYWQnKSk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQCFncm91cCBMb2FkaW5nIGFuZCBTZXR0aW5nIENvbmZpZ3VyYXRpb24gT3B0aW9ucwogICAqLwoKICAvKioKICAgKiBAb3ZlcmxvYWQgdXBkYXRlKG9wdGlvbnMsIGFsbG93VW5rbm93bktleXMgPSBmYWxzZSkKICAgKiAgIFVwZGF0ZXMgdGhlIGN1cnJlbnQgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBuZXcgb3B0aW9ucy4KICAgKgogICAqICAgQGV4YW1wbGUgVXBkYXRlIG1heFJldHJpZXMgcHJvcGVydHkgb2YgYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAqICAgICBjb25maWcudXBkYXRlKHttYXhSZXRyaWVzOiAxMH0pOwogICAqICAgQHBhcmFtIFtPYmplY3RdIG9wdGlvbnMgYSBtYXAgb2Ygb3B0aW9uIGtleXMgYW5kIHZhbHVlcy4KICAgKiAgIEBwYXJhbSBbQm9vbGVhbl0gYWxsb3dVbmtub3duS2V5cyB3aGV0aGVyIHVua25vd24ga2V5cyBjYW4gYmUgc2V0IG9uCiAgICogICAgIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdC4gRGVmYXVsdHMgdG8gYGZhbHNlYC4KICAgKiAgIEBzZWUgY29uc3RydWN0b3IKICAgKi8KICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShvcHRpb25zLCBhbGxvd1Vua25vd25LZXlzKSB7CiAgICBhbGxvd1Vua25vd25LZXlzID0gYWxsb3dVbmtub3duS2V5cyB8fCBmYWxzZTsKICAgIG9wdGlvbnMgPSB0aGlzLmV4dHJhY3RDcmVkZW50aWFscyhvcHRpb25zKTsKICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICBpZiAoYWxsb3dVbmtub3duS2V5cyB8fCBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5rZXlzLCBrZXkpIHx8CiAgICAgICAgICBBV1MuU2VydmljZS5oYXNTZXJ2aWNlKGtleSkpIHsKICAgICAgICB0aGlzLnNldChrZXksIHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogTG9hZHMgY29uZmlndXJhdGlvbiBkYXRhIGZyb20gYSBKU09OIGZpbGUgaW50byB0aGlzIGNvbmZpZyBvYmplY3QuCiAgICogQG5vdGUgTG9hZGluZyBjb25maWd1cmF0aW9uIHdpbGwgcmVzZXQgYWxsIGV4aXN0aW5nIGNvbmZpZ3VyYXRpb24KICAgKiAgIG9uIHRoZSBvYmplY3QuCiAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgKiBAcGFyYW0gcGF0aCBbU3RyaW5nXSB0aGUgcGF0aCByZWxhdGl2ZSB0byB5b3VyIHByb2Nlc3MncyBjdXJyZW50CiAgICogICAgd29ya2luZyBkaXJlY3RvcnkgdG8gbG9hZCBjb25maWd1cmF0aW9uIGZyb20uCiAgICogQHJldHVybiBbQVdTLkNvbmZpZ10gdGhlIHNhbWUgY29uZmlndXJhdGlvbiBvYmplY3QKICAgKi8KICBsb2FkRnJvbVBhdGg6IGZ1bmN0aW9uIGxvYWRGcm9tUGF0aChwYXRoKSB7CiAgICB0aGlzLmNsZWFyKCk7CgogICAgdmFyIG9wdGlvbnMgPSBKU09OLnBhcnNlKEFXUy51dGlsLnJlYWRGaWxlU3luYyhwYXRoKSk7CiAgICB2YXIgZmlsZVN5c3RlbUNyZWRzID0gbmV3IEFXUy5GaWxlU3lzdGVtQ3JlZGVudGlhbHMocGF0aCk7CiAgICB2YXIgY2hhaW4gPSBuZXcgQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluKCk7CiAgICBjaGFpbi5wcm92aWRlcnMudW5zaGlmdChmaWxlU3lzdGVtQ3JlZHMpOwogICAgY2hhaW4ucmVzb2x2ZShmdW5jdGlvbiAoZXJyLCBjcmVkcykgewogICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAgIGVsc2Ugb3B0aW9ucy5jcmVkZW50aWFscyA9IGNyZWRzOwogICAgfSk7CgogICAgdGhpcy5jb25zdHJ1Y3RvcihvcHRpb25zKTsKCiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBDbGVhcnMgY29uZmlndXJhdGlvbiBkYXRhIG9uIHRoaXMgb2JqZWN0CiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAvKmpzaGludCBmb3JpbjpmYWxzZSAqLwogICAgQVdTLnV0aWwuZWFjaC5jYWxsKHRoaXMsIHRoaXMua2V5cywgZnVuY3Rpb24gKGtleSkgewogICAgICBkZWxldGUgdGhpc1trZXldOwogICAgfSk7CgogICAgLy8gcmVzZXQgY3JlZGVudGlhbCBwcm92aWRlcgogICAgdGhpcy5zZXQoJ2NyZWRlbnRpYWxzJywgdW5kZWZpbmVkKTsKICAgIHRoaXMuc2V0KCdjcmVkZW50aWFsUHJvdmlkZXInLCB1bmRlZmluZWQpOwogIH0sCgogIC8qKgogICAqIFNldHMgYSBwcm9wZXJ0eSBvbiB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QsIGFsbG93aW5nIGZvciBhCiAgICogZGVmYXVsdCB2YWx1ZQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNldDogZnVuY3Rpb24gc2V0KHByb3BlcnR5LCB2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICBpZiAoZGVmYXVsdFZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBkZWZhdWx0VmFsdWUgPSB0aGlzLmtleXNbcHJvcGVydHldOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgZGVmYXVsdFZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdGhpc1twcm9wZXJ0eV0gPSBkZWZhdWx0VmFsdWUuY2FsbCh0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzW3Byb3BlcnR5XSA9IGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChwcm9wZXJ0eSA9PT0gJ2h0dHBPcHRpb25zJyAmJiB0aGlzW3Byb3BlcnR5XSkgewogICAgICAvLyBkZWVwIG1lcmdlIGh0dHBPcHRpb25zCiAgICAgIHRoaXNbcHJvcGVydHldID0gQVdTLnV0aWwubWVyZ2UodGhpc1twcm9wZXJ0eV0sIHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXNbcHJvcGVydHldID0gdmFsdWU7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQWxsIG9mIHRoZSBrZXlzIHdpdGggdGhlaXIgZGVmYXVsdCB2YWx1ZXMuCiAgICoKICAgKiBAY29uc3RhbnQKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBrZXlzOiB7CiAgICBjcmVkZW50aWFsczogbnVsbCwKICAgIGNyZWRlbnRpYWxQcm92aWRlcjogbnVsbCwKICAgIHJlZ2lvbjogbnVsbCwKICAgIGxvZ2dlcjogbnVsbCwKICAgIGFwaVZlcnNpb25zOiB7fSwKICAgIGFwaVZlcnNpb246IG51bGwsCiAgICBlbmRwb2ludDogdW5kZWZpbmVkLAogICAgaHR0cE9wdGlvbnM6IHsKICAgICAgdGltZW91dDogMTIwMDAwCiAgICB9LAogICAgbWF4UmV0cmllczogdW5kZWZpbmVkLAogICAgbWF4UmVkaXJlY3RzOiAxMCwKICAgIHBhcmFtVmFsaWRhdGlvbjogdHJ1ZSwKICAgIHNzbEVuYWJsZWQ6IHRydWUsCiAgICBzM0ZvcmNlUGF0aFN0eWxlOiBmYWxzZSwKICAgIHMzQnVja2V0RW5kcG9pbnQ6IGZhbHNlLAogICAgczNEaXNhYmxlQm9keVNpZ25pbmc6IHRydWUsCiAgICBzM1VzRWFzdDFSZWdpb25hbEVuZHBvaW50OiAnbGVnYWN5JywKICAgIHMzVXNlQXJuUmVnaW9uOiB1bmRlZmluZWQsCiAgICBjb21wdXRlQ2hlY2tzdW1zOiB0cnVlLAogICAgY29udmVydFJlc3BvbnNlVHlwZXM6IHRydWUsCiAgICBjb3JyZWN0Q2xvY2tTa2V3OiBmYWxzZSwKICAgIGN1c3RvbVVzZXJBZ2VudDogbnVsbCwKICAgIGR5bmFtb0RiQ3JjMzI6IHRydWUsCiAgICBzeXN0ZW1DbG9ja09mZnNldDogMCwKICAgIHNpZ25hdHVyZVZlcnNpb246IG51bGwsCiAgICBzaWduYXR1cmVDYWNoZTogdHJ1ZSwKICAgIHJldHJ5RGVsYXlPcHRpb25zOiB7fSwKICAgIHVzZUFjY2VsZXJhdGVFbmRwb2ludDogZmFsc2UsCiAgICBjbGllbnRTaWRlTW9uaXRvcmluZzogZmFsc2UsCiAgICBlbmRwb2ludERpc2NvdmVyeUVuYWJsZWQ6IHVuZGVmaW5lZCwKICAgIGVuZHBvaW50Q2FjaGVTaXplOiAxMDAwLAogICAgaG9zdFByZWZpeEVuYWJsZWQ6IHRydWUsCiAgICBzdHNSZWdpb25hbEVuZHBvaW50czogJ2xlZ2FjeScsCiAgICB1c2VGaXBzRW5kcG9pbnQ6IGZhbHNlLAogICAgdXNlRHVhbHN0YWNrRW5kcG9pbnQ6IGZhbHNlCiAgfSwKCiAgLyoqCiAgICogRXh0cmFjdHMgYWNjZXNzS2V5SWQsIHNlY3JldEFjY2Vzc0tleSBhbmQgc2Vzc2lvblRva2VuCiAgICogZnJvbSBhIGNvbmZpZ3VyYXRpb24gaGFzaC4KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGV4dHJhY3RDcmVkZW50aWFsczogZnVuY3Rpb24gZXh0cmFjdENyZWRlbnRpYWxzKG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmFjY2Vzc0tleUlkICYmIG9wdGlvbnMuc2VjcmV0QWNjZXNzS2V5KSB7CiAgICAgIG9wdGlvbnMgPSBBV1MudXRpbC5jb3B5KG9wdGlvbnMpOwogICAgICBvcHRpb25zLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyhvcHRpb25zKTsKICAgIH0KICAgIHJldHVybiBvcHRpb25zOwogIH0sCgogIC8qKgogICAqIFNldHMgdGhlIHByb21pc2UgZGVwZW5kZW5jeSB0aGUgU0RLIHdpbGwgdXNlIHdoZXJldmVyIFByb21pc2VzIGFyZSByZXR1cm5lZC4KICAgKiBQYXNzaW5nIGBudWxsYCB3aWxsIGZvcmNlIHRoZSBTREsgdG8gdXNlIG5hdGl2ZSBQcm9taXNlcyBpZiB0aGV5IGFyZSBhdmFpbGFibGUuCiAgICogSWYgbmF0aXZlIFByb21pc2VzIGFyZSBub3QgYXZhaWxhYmxlLCBwYXNzaW5nIGBudWxsYCB3aWxsIGhhdmUgbm8gZWZmZWN0LgogICAqIEBwYXJhbSBbQ29uc3RydWN0b3JdIGRlcCBBIHJlZmVyZW5jZSB0byBhIFByb21pc2UgY29uc3RydWN0b3IKICAgKi8KICBzZXRQcm9taXNlc0RlcGVuZGVuY3k6IGZ1bmN0aW9uIHNldFByb21pc2VzRGVwZW5kZW5jeShkZXApIHsKICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IGRlcDsKICAgIC8vIGlmIG51bGwgd2FzIHBhc3NlZCBpbiwgd2Ugc2hvdWxkIHRyeSB0byB1c2UgbmF0aXZlIHByb21pc2VzCiAgICBpZiAoZGVwID09PSBudWxsICYmIHR5cGVvZiBQcm9taXNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIFByb21pc2VzRGVwZW5kZW5jeSA9IFByb21pc2U7CiAgICB9CiAgICB2YXIgY29uc3RydWN0b3JzID0gW0FXUy5SZXF1ZXN0LCBBV1MuQ3JlZGVudGlhbHMsIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbl07CiAgICBpZiAoQVdTLlMzKSB7CiAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKEFXUy5TMyk7CiAgICAgIGlmIChBV1MuUzMuTWFuYWdlZFVwbG9hZCkgewogICAgICAgIGNvbnN0cnVjdG9ycy5wdXNoKEFXUy5TMy5NYW5hZ2VkVXBsb2FkKTsKICAgICAgfQogICAgfQogICAgQVdTLnV0aWwuYWRkUHJvbWlzZXMoY29uc3RydWN0b3JzLCBQcm9taXNlc0RlcGVuZGVuY3kpOwogIH0sCgogIC8qKgogICAqIEdldHMgdGhlIHByb21pc2UgZGVwZW5kZW5jeSBzZXQgYnkgYEFXUy5jb25maWcuc2V0UHJvbWlzZXNEZXBlbmRlbmN5YC4KICAgKi8KICBnZXRQcm9taXNlc0RlcGVuZGVuY3k6IGZ1bmN0aW9uIGdldFByb21pc2VzRGVwZW5kZW5jeSgpIHsKICAgIHJldHVybiBQcm9taXNlc0RlcGVuZGVuY3k7CiAgfQp9KTsKCi8qKgogKiBAcmV0dXJuIFtBV1MuQ29uZmlnXSBUaGUgZ2xvYmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHNpbmdsZXRvbiBpbnN0YW5jZQogKiBAcmVhZG9ubHkKICogQHNlZSBBV1MuQ29uZmlnCiAqLwpBV1MuY29uZmlnID0gbmV3IEFXUy5Db25maWcoKTsKCn0seyIuL2NvcmUiOjE5LCIuL2NyZWRlbnRpYWxzIjoyMCwiLi9jcmVkZW50aWFscy9jcmVkZW50aWFsX3Byb3ZpZGVyX2NoYWluIjoyM31dLDE4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShjb25maWdWYWx1ZSwgZXJyb3JPcHRpb25zKSB7CiAgaWYgKHR5cGVvZiBjb25maWdWYWx1ZSAhPT0gJ3N0cmluZycpIHJldHVybiB1bmRlZmluZWQ7CiAgZWxzZSBpZiAoWydsZWdhY3knLCAncmVnaW9uYWwnXS5pbmRleE9mKGNvbmZpZ1ZhbHVlLnRvTG93ZXJDYXNlKCkpID49IDApIHsKICAgIHJldHVybiBjb25maWdWYWx1ZS50b0xvd2VyQ2FzZSgpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgZXJyb3JPcHRpb25zKTsKICB9Cn0KCi8qKgogKiBSZXNvbHZlIHRoZSBjb25maWd1cmF0aW9uIHZhbHVlIGZvciByZWdpb25hbCBlbmRwb2ludCBmcm9tIGRpZmZlcmVuY2Ugc291cmNlczogY2xpZW50CiAqIGNvbmZpZywgZW52aXJvbm1lbnRhbCB2YXJpYWJsZSwgc2hhcmVkIGNvbmZpZyBmaWxlLiBWYWx1ZSBjYW4gYmUgY2FzZS1pbnNlbnNpdGl2ZQogKiAnbGVnYWN5JyBvciAncmVnaW5hbCcuCiAqIEBwYXJhbSBvcmlnaW5hbENvbmZpZyB1c2VyLXN1cHBsaWVkIGNvbmZpZyBvYmplY3QgdG8gcmVzb2x2ZQogKiBAcGFyYW0gb3B0aW9ucyBhIG1hcCBvZiBjb25maWcgcHJvcGVydHkgbmFtZXMgZnJvbSBpbmRpdmlkdWFsIGNvbmZpZ3VyYXRpb24gc291cmNlCiAqICAtIGVudjogbmFtZSBvZiBlbnZpcm9ubWVudGFsIHZhcmlhYmxlIHRoYXQgcmVmZXJzIHRvIHRoZSBjb25maWcKICogIC0gc2hhcmVkQ29uZmlnOiBuYW1lIG9mIHNoYXJlZCBjb25maWd1cmF0aW9uIGZpbGUgcHJvcGVydHkgdGhhdCByZWZlcnMgdG8gdGhlIGNvbmZpZwogKiAgLSBjbGllbnRDb25maWc6IG5hbWUgb2YgY2xpZW50IGNvbmZpZ3VyYXRpb24gcHJvcGVydHkgdGhhdCByZWZlcnMgdG8gdGhlIGNvbmZpZwogKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHJlc29sdmVSZWdpb25hbEVuZHBvaW50c0ZsYWcob3JpZ2luYWxDb25maWcsIG9wdGlvbnMpIHsKICBvcmlnaW5hbENvbmZpZyA9IG9yaWdpbmFsQ29uZmlnIHx8IHt9OwogIC8vdmFsaWRhdGUgY29uZmlnIHZhbHVlCiAgdmFyIHJlc29sdmVkOwogIGlmIChvcmlnaW5hbENvbmZpZ1tvcHRpb25zLmNsaWVudENvbmZpZ10pIHsKICAgIHJlc29sdmVkID0gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShvcmlnaW5hbENvbmZpZ1tvcHRpb25zLmNsaWVudENvbmZpZ10sIHsKICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgbWVzc2FnZTogJ2ludmFsaWQgIicgKyBvcHRpb25zLmNsaWVudENvbmZpZyArICciIGNvbmZpZ3VyYXRpb24uIEV4cGVjdCAibGVnYWN5IiAnICsKICAgICAgJyBvciAicmVnaW9uYWwiLiBHb3QgIicgKyBvcmlnaW5hbENvbmZpZ1tvcHRpb25zLmNsaWVudENvbmZpZ10gKyAnIi4nCiAgICB9KTsKICAgIGlmIChyZXNvbHZlZCkgcmV0dXJuIHJlc29sdmVkOwogIH0KICBpZiAoIUFXUy51dGlsLmlzTm9kZSgpKSByZXR1cm4gcmVzb2x2ZWQ7CiAgLy92YWxpZGF0ZSBlbnZpcm9ubWVudGFsIHZhcmlhYmxlCiAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwcm9jZXNzLmVudiwgb3B0aW9ucy5lbnYpKSB7CiAgICB2YXIgZW52RmxhZyA9IHByb2Nlc3MuZW52W29wdGlvbnMuZW52XTsKICAgIHJlc29sdmVkID0gdmFsaWRhdGVSZWdpb25hbEVuZHBvaW50c0ZsYWdWYWx1ZShlbnZGbGFnLCB7CiAgICAgIGNvZGU6ICdJbnZhbGlkRW52aXJvbm1lbnRhbFZhcmlhYmxlJywKICAgICAgbWVzc2FnZTogJ2ludmFsaWQgJyArIG9wdGlvbnMuZW52ICsgJyBlbnZpcm9ubWVudGFsIHZhcmlhYmxlLiBFeHBlY3QgImxlZ2FjeSIgJyArCiAgICAgICcgb3IgInJlZ2lvbmFsIi4gR290ICInICsgcHJvY2Vzcy5lbnZbb3B0aW9ucy5lbnZdICsgJyIuJwogICAgfSk7CiAgICBpZiAocmVzb2x2ZWQpIHJldHVybiByZXNvbHZlZDsKICB9CiAgLy92YWxpZGF0ZSBzaGFyZWQgY29uZmlnIGZpbGUKICB2YXIgcHJvZmlsZSA9IHt9OwogIHRyeSB7CiAgICB2YXIgcHJvZmlsZXMgPSBBV1MudXRpbC5nZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWcoQVdTLnV0aWwuaW5pTG9hZGVyKTsKICAgIHByb2ZpbGUgPSBwcm9maWxlc1twcm9jZXNzLmVudi5BV1NfUFJPRklMRSB8fCBBV1MudXRpbC5kZWZhdWx0UHJvZmlsZV07CiAgfSBjYXRjaCAoZSkge307CiAgaWYgKHByb2ZpbGUgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2ZpbGUsIG9wdGlvbnMuc2hhcmVkQ29uZmlnKSkgewogICAgdmFyIGZpbGVGbGFnID0gcHJvZmlsZVtvcHRpb25zLnNoYXJlZENvbmZpZ107CiAgICByZXNvbHZlZCA9IHZhbGlkYXRlUmVnaW9uYWxFbmRwb2ludHNGbGFnVmFsdWUoZmlsZUZsYWcsIHsKICAgICAgY29kZTogJ0ludmFsaWRDb25maWd1cmF0aW9uJywKICAgICAgbWVzc2FnZTogJ2ludmFsaWQgJyArIG9wdGlvbnMuc2hhcmVkQ29uZmlnICsgJyBwcm9maWxlIGNvbmZpZy4gRXhwZWN0ICJsZWdhY3kiICcgKwogICAgICAnIG9yICJyZWdpb25hbCIuIEdvdCAiJyArIHByb2ZpbGVbb3B0aW9ucy5zaGFyZWRDb25maWddICsgJyIuJwogICAgfSk7CiAgICBpZiAocmVzb2x2ZWQpIHJldHVybiByZXNvbHZlZDsKICB9CiAgcmV0dXJuIHJlc29sdmVkOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHJlc29sdmVSZWdpb25hbEVuZHBvaW50c0ZsYWc7Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2NvcmUiOjE5LCJfcHJvY2VzcyI6ODl9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgbWFpbiBBV1MgbmFtZXNwYWNlCiAqLwp2YXIgQVdTID0geyB1dGlsOiByZXF1aXJlKCcuL3V0aWwnKSB9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKiBAIW1hY3JvIFtuZXddIG5vYnJvd3NlcgogKiAgIEBub3RlIFRoaXMgZmVhdHVyZSBpcyBub3Qgc3VwcG9ydGVkIGluIHRoZSBicm93c2VyIGVudmlyb25tZW50IG9mIHRoZSBTREsuCiAqLwp2YXIgX2hpZGRlbiA9IHt9OyBfaGlkZGVuLnRvU3RyaW5nKCk7IC8vIGhhY2sgdG8gcGFyc2UgbWFjcm8KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTOwoKQVdTLnV0aWwudXBkYXRlKEFXUywgewoKICAvKioKICAgKiBAY29uc3RhbnQKICAgKi8KICBWRVJTSU9OOiAnMi4xMjAwLjAnLAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBTaWduZXJzOiB7fSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgUHJvdG9jb2w6IHsKICAgIEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvanNvbicpLAogICAgUXVlcnk6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcXVlcnknKSwKICAgIFJlc3Q6IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdCcpLAogICAgUmVzdEpzb246IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyksCiAgICBSZXN0WG1sOiByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfeG1sJykKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBYTUw6IHsKICAgIEJ1aWxkZXI6IHJlcXVpcmUoJy4veG1sL2J1aWxkZXInKSwKICAgIFBhcnNlcjogbnVsbCAvLyBjb25kaXRpb25hbGx5IHNldCBiYXNlZCBvbiBlbnZpcm9ubWVudAogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEpTT046IHsKICAgIEJ1aWxkZXI6IHJlcXVpcmUoJy4vanNvbi9idWlsZGVyJyksCiAgICBQYXJzZXI6IHJlcXVpcmUoJy4vanNvbi9wYXJzZXInKQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIE1vZGVsOiB7CiAgICBBcGk6IHJlcXVpcmUoJy4vbW9kZWwvYXBpJyksCiAgICBPcGVyYXRpb246IHJlcXVpcmUoJy4vbW9kZWwvb3BlcmF0aW9uJyksCiAgICBTaGFwZTogcmVxdWlyZSgnLi9tb2RlbC9zaGFwZScpLAogICAgUGFnaW5hdG9yOiByZXF1aXJlKCcuL21vZGVsL3BhZ2luYXRvcicpLAogICAgUmVzb3VyY2VXYWl0ZXI6IHJlcXVpcmUoJy4vbW9kZWwvcmVzb3VyY2Vfd2FpdGVyJykKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhcGlMb2FkZXI6IHJlcXVpcmUoJy4vYXBpX2xvYWRlcicpLAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBFbmRwb2ludENhY2hlOiByZXF1aXJlKCcuLi92ZW5kb3IvZW5kcG9pbnQtY2FjaGUnKS5FbmRwb2ludENhY2hlCn0pOwpyZXF1aXJlKCcuL3NlcXVlbnRpYWxfZXhlY3V0b3InKTsKcmVxdWlyZSgnLi9zZXJ2aWNlJyk7CnJlcXVpcmUoJy4vY29uZmlnJyk7CnJlcXVpcmUoJy4vaHR0cCcpOwpyZXF1aXJlKCcuL2V2ZW50X2xpc3RlbmVycycpOwpyZXF1aXJlKCcuL3JlcXVlc3QnKTsKcmVxdWlyZSgnLi9yZXNwb25zZScpOwpyZXF1aXJlKCcuL3Jlc291cmNlX3dhaXRlcicpOwpyZXF1aXJlKCcuL3NpZ25lcnMvcmVxdWVzdF9zaWduZXInKTsKcmVxdWlyZSgnLi9wYXJhbV92YWxpZGF0b3InKTsKCi8qKgogKiBAcmVhZG9ubHkKICogQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gYSBjb2xsZWN0aW9uIG9mIGdsb2JhbCBldmVudCBsaXN0ZW5lcnMgdGhhdAogKiAgIGFyZSBhdHRhY2hlZCB0byBldmVyeSBzZW50IHJlcXVlc3QuCiAqIEBzZWUgQVdTLlJlcXVlc3QgQVdTLlJlcXVlc3QgZm9yIGEgbGlzdCBvZiBldmVudHMgdG8gbGlzdGVuIGZvcgogKiBAZXhhbXBsZSBMb2dnaW5nIHRoZSB0aW1lIHRha2VuIHRvIHNlbmQgYSByZXF1ZXN0CiAqICAgQVdTLmV2ZW50cy5vbignc2VuZCcsIGZ1bmN0aW9uIHN0YXJ0U2VuZChyZXNwKSB7CiAqICAgICByZXNwLnN0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogKiAgIH0pLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIGNhbGN1bGF0ZVRpbWUocmVzcCkgewogKiAgICAgdmFyIHRpbWUgPSAobmV3IERhdGUoKS5nZXRUaW1lKCkgLSByZXNwLnN0YXJ0VGltZSkgLyAxMDAwOwogKiAgICAgY29uc29sZS5sb2coJ1JlcXVlc3QgdG9vayAnICsgdGltZSArICcgc2Vjb25kcycpOwogKiAgIH0pOwogKgogKiAgIG5ldyBBV1MuUzMoKS5saXN0QnVja2V0cygpOyAvLyBwcmludHMgJ1JlcXVlc3QgdG9vayAwLjI4NSBzZWNvbmRzJwogKi8KQVdTLmV2ZW50cyA9IG5ldyBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yKCk7CgovL2NyZWF0ZSBlbmRwb2ludCBjYWNoZSBsYXppbHkKQVdTLnV0aWwubWVtb2l6ZWRQcm9wZXJ0eShBV1MsICdlbmRwb2ludENhY2hlJywgZnVuY3Rpb24oKSB7CiAgcmV0dXJuIG5ldyBBV1MuRW5kcG9pbnRDYWNoZShBV1MuY29uZmlnLmVuZHBvaW50Q2FjaGVTaXplKTsKfSwgdHJ1ZSk7Cgp9LHsiLi4vdmVuZG9yL2VuZHBvaW50LWNhY2hlIjoxMDksIi4vYXBpX2xvYWRlciI6OSwiLi9jb25maWciOjE3LCIuL2V2ZW50X2xpc3RlbmVycyI6MzQsIi4vaHR0cCI6MzUsIi4vanNvbi9idWlsZGVyIjozNywiLi9qc29uL3BhcnNlciI6MzgsIi4vbW9kZWwvYXBpIjozOSwiLi9tb2RlbC9vcGVyYXRpb24iOjQxLCIuL21vZGVsL3BhZ2luYXRvciI6NDIsIi4vbW9kZWwvcmVzb3VyY2Vfd2FpdGVyIjo0MywiLi9tb2RlbC9zaGFwZSI6NDQsIi4vcGFyYW1fdmFsaWRhdG9yIjo0NSwiLi9wcm90b2NvbC9qc29uIjo0NywiLi9wcm90b2NvbC9xdWVyeSI6NDgsIi4vcHJvdG9jb2wvcmVzdCI6NDksIi4vcHJvdG9jb2wvcmVzdF9qc29uIjo1MCwiLi9wcm90b2NvbC9yZXN0X3htbCI6NTEsIi4vcmVxdWVzdCI6NTcsIi4vcmVzb3VyY2Vfd2FpdGVyIjo1OCwiLi9yZXNwb25zZSI6NTksIi4vc2VxdWVudGlhbF9leGVjdXRvciI6NjAsIi4vc2VydmljZSI6NjEsIi4vc2lnbmVycy9yZXF1ZXN0X3NpZ25lciI6NjQsIi4vdXRpbCI6NzIsIi4veG1sL2J1aWxkZXIiOjc0fV0sMjA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CgovKioKICogUmVwcmVzZW50cyB5b3VyIEFXUyBzZWN1cml0eSBjcmVkZW50aWFscywgc3BlY2lmaWNhbGx5IHRoZQogKiB7YWNjZXNzS2V5SWR9LCB7c2VjcmV0QWNjZXNzS2V5fSwgYW5kIG9wdGlvbmFsIHtzZXNzaW9uVG9rZW59LgogKiBDcmVhdGluZyBhIGBDcmVkZW50aWFsc2Agb2JqZWN0IGFsbG93cyB5b3UgdG8gcGFzcyBhcm91bmQgeW91cgogKiBzZWN1cml0eSBpbmZvcm1hdGlvbiB0byBjb25maWd1cmF0aW9uIGFuZCBzZXJ2aWNlIG9iamVjdHMuCiAqCiAqIE5vdGUgdGhhdCB0aGlzIGNsYXNzIHR5cGljYWxseSBkb2VzIG5vdCBuZWVkIHRvIGJlIGNvbnN0cnVjdGVkIG1hbnVhbGx5LAogKiBhcyB0aGUge0FXUy5Db25maWd9IGFuZCB7QVdTLlNlcnZpY2V9IGNsYXNzZXMgYm90aCBhY2NlcHQgc2ltcGxlCiAqIG9wdGlvbnMgaGFzaGVzIHdpdGggdGhlIHRocmVlIGtleXMuIFRoZXNlIHN0cnVjdHVyZXMgd2lsbCBiZSBjb252ZXJ0ZWQKICogaW50byBDcmVkZW50aWFscyBvYmplY3RzIGF1dG9tYXRpY2FsbHkuCiAqCiAqICMjIEV4cGlyaW5nIGFuZCBSZWZyZXNoaW5nIENyZWRlbnRpYWxzCiAqCiAqIE9jY2FzaW9uYWxseSBjcmVkZW50aWFscyBjYW4gZXhwaXJlIGluIHRoZSBtaWRkbGUgb2YgYSBsb25nLXJ1bm5pbmcKICogYXBwbGljYXRpb24uIEluIHRoaXMgY2FzZSwgdGhlIFNESyB3aWxsIGF1dG9tYXRpY2FsbHkgYXR0ZW1wdCB0bwogKiByZWZyZXNoIHRoZSBjcmVkZW50aWFscyBmcm9tIHRoZSBzdG9yYWdlIGxvY2F0aW9uIGlmIHRoZSBDcmVkZW50aWFscwogKiBjbGFzcyBpbXBsZW1lbnRzIHRoZSB7cmVmcmVzaH0gbWV0aG9kLgogKgogKiBJZiB5b3UgYXJlIGltcGxlbWVudGluZyBhIGNyZWRlbnRpYWwgc3RvcmFnZSBsb2NhdGlvbiwgeW91CiAqIHdpbGwgd2FudCB0byBjcmVhdGUgYSBzdWJjbGFzcyBvZiB0aGUgYENyZWRlbnRpYWxzYCBjbGFzcyBhbmQKICogb3ZlcnJpZGUgdGhlIHtyZWZyZXNofSBtZXRob2QuIFRoaXMgbWV0aG9kIGFsbG93cyBjcmVkZW50aWFscyB0byBiZQogKiByZXRyaWV2ZWQgZnJvbSB0aGUgYmFja2luZyBzdG9yZSwgYmUgaXQgYSBmaWxlIHN5c3RlbSwgZGF0YWJhc2UsIG9yCiAqIHNvbWUgbmV0d29yayBzdG9yYWdlLiBUaGUgbWV0aG9kIHNob3VsZCByZXNldCB0aGUgY3JlZGVudGlhbCBhdHRyaWJ1dGVzCiAqIG9uIHRoZSBvYmplY3QuCiAqCiAqIEAhYXR0cmlidXRlIGV4cGlyZWQKICogICBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBjcmVkZW50aWFscyBoYXZlIGJlZW4gZXhwaXJlZCBhbmQKICogICAgIHJlcXVpcmUgYSByZWZyZXNoLiBVc2VkIGluIGNvbmp1bmN0aW9uIHdpdGgge2V4cGlyZVRpbWV9LgogKiBAIWF0dHJpYnV0ZSBleHBpcmVUaW1lCiAqICAgQHJldHVybiBbRGF0ZV0gYSB0aW1lIHdoZW4gY3JlZGVudGlhbHMgc2hvdWxkIGJlIGNvbnNpZGVyZWQgZXhwaXJlZC4gVXNlZAogKiAgICAgaW4gY29uanVuY3Rpb24gd2l0aCB7ZXhwaXJlZH0uCiAqIEAhYXR0cmlidXRlIGFjY2Vzc0tleUlkCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICogQCFhdHRyaWJ1dGUgc2VjcmV0QWNjZXNzS2V5CiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQVdTIHNlY3JldCBhY2Nlc3Mga2V5CiAqIEAhYXR0cmlidXRlIHNlc3Npb25Ub2tlbgogKiAgIEByZXR1cm4gW1N0cmluZ10gYW4gb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICovCkFXUy5DcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoewogIC8qKgogICAqIEEgY3JlZGVudGlhbHMgb2JqZWN0IGNhbiBiZSBjcmVhdGVkIHVzaW5nIHBvc2l0aW9uYWwgYXJndW1lbnRzIG9yIGFuIG9wdGlvbnMKICAgKiBoYXNoLgogICAqCiAgICogQG92ZXJsb2FkIEFXUy5DcmVkZW50aWFscyhhY2Nlc3NLZXlJZCwgc2VjcmV0QWNjZXNzS2V5LCBzZXNzaW9uVG9rZW49bnVsbCkKICAgKiAgIENyZWF0ZXMgYSBDcmVkZW50aWFscyBvYmplY3Qgd2l0aCBhIGdpdmVuIHNldCBvZiBjcmVkZW50aWFsIGluZm9ybWF0aW9uCiAgICogICBhcyBwb3NpdGlvbmFsIGFyZ3VtZW50cy4KICAgKiAgIEBwYXJhbSBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgKiAgIEBwYXJhbSBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAqICAgQHBhcmFtIHNlc3Npb25Ub2tlbiBbU3RyaW5nXSB0aGUgb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgKiAgIEBleGFtcGxlIENyZWF0ZSBhIGNyZWRlbnRpYWxzIG9iamVjdCB3aXRoIEFXUyBjcmVkZW50aWFscwogICAqICAgICB2YXIgY3JlZHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKCdha2lkJywgJ3NlY3JldCcsICdzZXNzaW9uJyk7CiAgICogQG92ZXJsb2FkIEFXUy5DcmVkZW50aWFscyhvcHRpb25zKQogICAqICAgQ3JlYXRlcyBhIENyZWRlbnRpYWxzIG9iamVjdCB3aXRoIGEgZ2l2ZW4gc2V0IG9mIGNyZWRlbnRpYWwgaW5mb3JtYXRpb24KICAgKiAgIGFzIGFuIG9wdGlvbnMgaGFzaC4KICAgKiAgIEBvcHRpb24gb3B0aW9ucyBhY2Nlc3NLZXlJZCBbU3RyaW5nXSB0aGUgQVdTIGFjY2VzcyBrZXkgSUQKICAgKiAgIEBvcHRpb24gb3B0aW9ucyBzZWNyZXRBY2Nlc3NLZXkgW1N0cmluZ10gdGhlIEFXUyBzZWNyZXQgYWNjZXNzIGtleQogICAqICAgQG9wdGlvbiBvcHRpb25zIHNlc3Npb25Ub2tlbiBbU3RyaW5nXSB0aGUgb3B0aW9uYWwgQVdTIHNlc3Npb24gdG9rZW4KICAgKiAgIEBleGFtcGxlIENyZWF0ZSBhIGNyZWRlbnRpYWxzIG9iamVjdCB3aXRoIEFXUyBjcmVkZW50aWFscwogICAqICAgICB2YXIgY3JlZHMgPSBuZXcgQVdTLkNyZWRlbnRpYWxzKHsKICAgKiAgICAgICBhY2Nlc3NLZXlJZDogJ2FraWQnLCBzZWNyZXRBY2Nlc3NLZXk6ICdzZWNyZXQnLCBzZXNzaW9uVG9rZW46ICdzZXNzaW9uJwogICAqICAgICB9KTsKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gQ3JlZGVudGlhbHMoKSB7CiAgICAvLyBoaWRlIHNlY3JldEFjY2Vzc0tleSBmcm9tIGJlaW5nIGRpc3BsYXllZCB3aXRoIHV0aWwuaW5zcGVjdAogICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzZWNyZXRBY2Nlc3NLZXknXSk7CgogICAgdGhpcy5leHBpcmVkID0gZmFsc2U7CiAgICB0aGlzLmV4cGlyZVRpbWUgPSBudWxsOwogICAgdGhpcy5yZWZyZXNoQ2FsbGJhY2tzID0gW107CiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnb2JqZWN0JykgewogICAgICB2YXIgY3JlZHMgPSBhcmd1bWVudHNbMF0uY3JlZGVudGlhbHMgfHwgYXJndW1lbnRzWzBdOwogICAgICB0aGlzLmFjY2Vzc0tleUlkID0gY3JlZHMuYWNjZXNzS2V5SWQ7CiAgICAgIHRoaXMuc2VjcmV0QWNjZXNzS2V5ID0gY3JlZHMuc2VjcmV0QWNjZXNzS2V5OwogICAgICB0aGlzLnNlc3Npb25Ub2tlbiA9IGNyZWRzLnNlc3Npb25Ub2tlbjsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuYWNjZXNzS2V5SWQgPSBhcmd1bWVudHNbMF07CiAgICAgIHRoaXMuc2VjcmV0QWNjZXNzS2V5ID0gYXJndW1lbnRzWzFdOwogICAgICB0aGlzLnNlc3Npb25Ub2tlbiA9IGFyZ3VtZW50c1syXTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHNlY29uZHMgYmVmb3JlIHtleHBpcmVUaW1lfSBkdXJpbmcgd2hpY2gKICAgKiAgIHRoZSBjcmVkZW50aWFscyB3aWxsIGJlIGNvbnNpZGVyZWQgZXhwaXJlZC4KICAgKi8KICBleHBpcnlXaW5kb3c6IDE1LAoKICAvKioKICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBjcmVkZW50aWFscyBvYmplY3Qgc2hvdWxkIGNhbGwge3JlZnJlc2h9CiAgICogQG5vdGUgU3ViY2xhc3NlcyBzaG91bGQgb3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gcHJvdmlkZSBjdXN0b20gcmVmcmVzaAogICAqICAgbG9naWMuCiAgICovCiAgbmVlZHNSZWZyZXNoOiBmdW5jdGlvbiBuZWVkc1JlZnJlc2goKSB7CiAgICB2YXIgY3VycmVudFRpbWUgPSBBV1MudXRpbC5kYXRlLmdldERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgYWRqdXN0ZWRUaW1lID0gbmV3IERhdGUoY3VycmVudFRpbWUgKyB0aGlzLmV4cGlyeVdpbmRvdyAqIDEwMDApOwoKICAgIGlmICh0aGlzLmV4cGlyZVRpbWUgJiYgYWRqdXN0ZWRUaW1lID4gdGhpcy5leHBpcmVUaW1lKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuZXhwaXJlZCB8fCAhdGhpcy5hY2Nlc3NLZXlJZCB8fCAhdGhpcy5zZWNyZXRBY2Nlc3NLZXk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogR2V0cyB0aGUgZXhpc3RpbmcgY3JlZGVudGlhbHMsIHJlZnJlc2hpbmcgdGhlbSBpZiB0aGV5IGFyZSBub3QgeWV0IGxvYWRlZAogICAqIG9yIGhhdmUgZXhwaXJlZC4gVXNlcnMgc2hvdWxkIGNhbGwgdGhpcyBtZXRob2QgYmVmb3JlIHVzaW5nIHtyZWZyZXNofSwKICAgKiBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAqIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QuCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyBlaXRoZXIgY3JlZGVudGlhbHMKICAgKiAgIGRvIG5vdCBuZWVkIHRvIGJlIHJlZnJlc2hlZCBvciByZWZyZXNoZWQgY3JlZGVudGlhbHMgaW5mb3JtYXRpb24gaGFzCiAgICogICBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLCBgc2VjcmV0QWNjZXNzS2V5YCwKICAgKiAgIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqLwogIGdldDogZnVuY3Rpb24gZ2V0KGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAodGhpcy5uZWVkc1JlZnJlc2goKSkgewogICAgICB0aGlzLnJlZnJlc2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgaWYgKCFlcnIpIHNlbGYuZXhwaXJlZCA9IGZhbHNlOyAvLyByZXNldCBleHBpcmVkIGZsYWcKICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChjYWxsYmFjaykgewogICAgICBjYWxsYmFjaygpOwogICAgfQogIH0sCgogIC8qKgogICAqIEAhbWV0aG9kICBnZXRQcm9taXNlKCkKICAgKiAgIFJldHVybnMgYSAndGhlbmFibGUnIHByb21pc2UuCiAgICogICBHZXRzIHRoZSBleGlzdGluZyBjcmVkZW50aWFscywgcmVmcmVzaGluZyB0aGVtIGlmIHRoZXkgYXJlIG5vdCB5ZXQgbG9hZGVkCiAgICogICBvciBoYXZlIGV4cGlyZWQuIFVzZXJzIHNob3VsZCBjYWxsIHRoaXMgbWV0aG9kIGJlZm9yZSB1c2luZyB7cmVmcmVzaH0sCiAgICogICBhcyB0aGlzIHdpbGwgbm90IGF0dGVtcHQgdG8gcmVsb2FkIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBhcmUgYWxyZWFkeQogICAqICAgbG9hZGVkIGludG8gdGhlIG9iamVjdC4KICAgKgogICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLiBXaGVuIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkLCBpdAogICAqICAgICBtZWFucyBlaXRoZXIgY3JlZGVudGlhbHMgZG8gbm90IG5lZWQgdG8gYmUgcmVmcmVzaGVkIG9yIHJlZnJlc2hlZAogICAqICAgICBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUKICAgKiAgICAgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgZ2V0YCBjYWxsLgogICAqICAgQGV4YW1wbGUgQ2FsbGluZyB0aGUgYGdldFByb21pc2VgIG1ldGhvZC4KICAgKiAgICAgdmFyIHByb21pc2UgPSBjcmVkUHJvdmlkZXIuZ2V0UHJvbWlzZSgpOwogICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAqLwoKICAvKioKICAgKiBAIW1ldGhvZCAgcmVmcmVzaFByb21pc2UoKQogICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgKiAgIFJlZnJlc2hlcyB0aGUgY3JlZGVudGlhbHMuIFVzZXJzIHNob3VsZCBjYWxsIHtnZXR9IGJlZm9yZSBhdHRlbXB0aW5nCiAgICogICB0byBmb3JjaWJseSByZWZyZXNoIGNyZWRlbnRpYWxzLgogICAqCiAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbigpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQuIFdoZW4gdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQsIGl0CiAgICogICAgIG1lYW5zIHJlZnJlc2hlZCBjcmVkZW50aWFscyBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0CiAgICogICAgIChhcyB0aGUgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIHJlamVjdGVkLgogICAqICAgICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgcmVmcmVzaGAgY2FsbC4KICAgKiAgIEBleGFtcGxlIENhbGxpbmcgdGhlIGByZWZyZXNoUHJvbWlzZWAgbWV0aG9kLgogICAqICAgICB2YXIgcHJvbWlzZSA9IGNyZWRQcm92aWRlci5yZWZyZXNoUHJvbWlzZSgpOwogICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oKSB7IC4uLiB9LCBmdW5jdGlvbihlcnIpIHsgLi4uIH0pOwogICAqLwoKICAvKioKICAgKiBSZWZyZXNoZXMgdGhlIGNyZWRlbnRpYWxzLiBVc2VycyBzaG91bGQgY2FsbCB7Z2V0fSBiZWZvcmUgYXR0ZW1wdGluZwogICAqIHRvIGZvcmNpYmx5IHJlZnJlc2ggY3JlZGVudGlhbHMuCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgV2hlbiB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyByZWZyZXNoZWQKICAgKiAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZQogICAqICAgYGFjY2Vzc0tleUlkYCwgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqIEBub3RlIFN1YmNsYXNzZXMgc2hvdWxkIG92ZXJyaWRlIHRoaXMgY2xhc3MgdG8gcmVzZXQgdGhlCiAgICogICB7YWNjZXNzS2V5SWR9LCB7c2VjcmV0QWNjZXNzS2V5fSBhbmQgb3B0aW9uYWwge3Nlc3Npb25Ub2tlbn0KICAgKiAgIG9uIHRoZSBjcmVkZW50aWFscyBvYmplY3QgYW5kIHRoZW4gY2FsbCB0aGUgY2FsbGJhY2sgd2l0aAogICAqICAgYW55IGVycm9yIGluZm9ybWF0aW9uLgogICAqIEBzZWUgZ2V0CiAgICovCiAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgdGhpcy5leHBpcmVkID0gZmFsc2U7CiAgICBjYWxsYmFjaygpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBwYXJhbSBjYWxsYmFjawogICAqLwogIGNvYWxlc2NlUmVmcmVzaDogZnVuY3Rpb24gY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrLCBzeW5jKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoc2VsZi5yZWZyZXNoQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spID09PSAxKSB7CiAgICAgIHNlbGYubG9hZChmdW5jdGlvbiBvbkxvYWQoZXJyKSB7CiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNlbGYucmVmcmVzaENhbGxiYWNrcywgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChzeW5jKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBjYWxsYmFjayBjb3VsZCB0aHJvdywgc28gZGVmZXIgdG8gZW5zdXJlIGFsbCBjYWxsYmFja3MgYXJlIG5vdGlmaWVkCiAgICAgICAgICAgIEFXUy51dGlsLmRlZmVyKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBjYWxsYmFjayhlcnIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBzZWxmLnJlZnJlc2hDYWxsYmFja3MubGVuZ3RoID0gMDsKICAgICAgfSk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICogQHBhcmFtIGNhbGxiYWNrCiAgICovCiAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgY2FsbGJhY2soKTsKICB9Cn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLkNyZWRlbnRpYWxzLmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogIHRoaXMucHJvdG90eXBlLmdldFByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ2dldCcsIFByb21pc2VEZXBlbmRlbmN5KTsKICB0aGlzLnByb3RvdHlwZS5yZWZyZXNoUHJvbWlzZSA9IEFXUy51dGlsLnByb21pc2lmeU1ldGhvZCgncmVmcmVzaCcsIFByb21pc2VEZXBlbmRlbmN5KTsKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5DcmVkZW50aWFscy5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5nZXRQcm9taXNlOwogIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5yZWZyZXNoUHJvbWlzZTsKfTsKCkFXUy51dGlsLmFkZFByb21pc2VzKEFXUy5DcmVkZW50aWFscyk7Cgp9LHsiLi9jb3JlIjoxOX1dLDIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIFNUUyA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvc3RzJyk7CgovKioKICogUmVwcmVzZW50cyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20ge0FXUy5TVFN9LiBXaXRob3V0IGFueQogKiBleHRyYSBwYXJhbWV0ZXJzLCBjcmVkZW50aWFscyB3aWxsIGJlIGZldGNoZWQgZnJvbSB0aGUKICoge0FXUy5TVFMuZ2V0U2Vzc2lvblRva2VufSBvcGVyYXRpb24uIElmIGFuIElBTSByb2xlIGlzIHByb3ZpZGVkLCB0aGUKICoge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3BlcmF0aW9uIHdpbGwgYmUgdXNlZCB0byBmZXRjaCBjcmVkZW50aWFscyBmb3IgdGhlCiAqIHJvbGUgaW5zdGVhZC4KICoKICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIGRpZmZlcnMgZnJvbSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaW4KICogdGhlIHdheSBtYXN0ZXJDcmVkZW50aWFscyBhbmQgcmVmcmVzaGVzIGFyZSBoYW5kbGVkLgogKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgcmVmcmVzaGVzIGV4cGlyZWQgY3JlZGVudGlhbHMgdXNpbmcgdGhlCiAqIG1hc3RlckNyZWRlbnRpYWxzIHBhc3NlZCBieSB0aGUgdXNlciB0byBzdXBwb3J0IGNoYWluaW5nIG9mIFNUUyBjcmVkZW50aWFscy4KICogSG93ZXZlciwgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIHJlY3Vyc2l2ZWx5IGNvbGxhcHNlcyB0aGUgbWFzdGVyQ3JlZGVudGlhbHMKICogZHVyaW5nIGluc3RhbnRpYXRpb24sIHByZWNsdWRpbmcgdGhlIGFiaWxpdHkgdG8gcmVmcmVzaCBjcmVkZW50aWFscyB3aGljaAogKiByZXF1aXJlIGludGVybWVkaWF0ZSwgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLgogKgogKiBGb3IgZXhhbXBsZSwgaWYgdGhlIGFwcGxpY2F0aW9uIHNob3VsZCB1c2UgUm9sZUEsIHdoaWNoIG11c3QgYmUgYXNzdW1lZCBmcm9tCiAqIFJvbGVCLCBhbmQgdGhlIGVudmlyb25tZW50IHByb3ZpZGVzIGNyZWRlbnRpYWxzIHdoaWNoIGNhbiBhc3N1bWUgUm9sZUIsIHRoZW4KICogQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzIG11c3QgYmUgdXNlZCB0byBzdXBwb3J0IHJlZnJlc2hpbmcgdGhlCiAqIHRlbXBvcmFyeSBjcmVkZW50aWFscyBmb3IgUm9sZUE6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogdmFyIHJvbGVBQ3JlZHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICogICBwYXJhbXM6IHtSb2xlQXJuOiAnUm9sZUEnfSwKICogICBtYXN0ZXJDcmVkZW50aWFsczogbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAqICAgICBwYXJhbXM6IHtSb2xlQXJuOiAnUm9sZUInfSwKICogICAgIG1hc3RlckNyZWRlbnRpYWxzOiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FXUycpCiAqICAgfSkKICogfSk7CiAqIGBgYAogKgogKiBJZiBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaGFkIGJlZW4gdXNlZCBpbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwKICogYHJvbGVBQ3JlZHNgIHdvdWxkIGZhaWwgdG8gcmVmcmVzaCBiZWNhdXNlIGByb2xlQUNyZWRzYCB3b3VsZAogKiB1c2UgdGhlIGVudmlyb25tZW50IGNyZWRlbnRpYWxzIGZvciB0aGUgQXNzdW1lUm9sZSByZXF1ZXN0LgogKgogKiBBbm90aGVyIGRpZmZlcmVuY2UgaXMgdGhhdCBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgY3JlYXRlcyB0aGUgU1RTCiAqIHNlcnZpY2UgaW5zdGFuY2UgZHVyaW5nIGluc3RhbnRpYXRpb24gd2hpbGUgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzIGNyZWF0ZXMKICogdGhlIFNUUyBzZXJ2aWNlIGluc3RhbmNlIGR1cmluZyB0aGUgZmlyc3QgcmVmcmVzaC4gQ3JlYXRpbmcgdGhlIHNlcnZpY2UKICogaW5zdGFuY2UgZHVyaW5nIGluc3RhbnRpYXRpb24gZWZmZWN0aXZlbHkgY2FwdHVyZXMgdGhlIG1hc3RlciBjcmVkZW50aWFscwogKiBmcm9tIHRoZSBnbG9iYWwgY29uZmlnLCBzbyB0aGF0IHN1YnNlcXVlbnQgY2hhbmdlcyB0byB0aGUgZ2xvYmFsIGNvbmZpZyBkbwogKiBub3QgYWZmZWN0IHRoZSBtYXN0ZXIgY3JlZGVudGlhbHMgdXNlZCB0byByZWZyZXNoIHRoZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMuCiAqCiAqIFRoaXMgYWxsb3dzIGFuIGluc3RhbmNlIG9mIEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyB0byBiZSBhc3NpZ25lZAogKiB0byBBV1MuY29uZmlnLmNyZWRlbnRpYWxzOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIHZhciBlbnZDcmVkcyA9IG5ldyBBV1MuRW52aXJvbm1lbnRDcmVkZW50aWFscygnQVdTJyk7CiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBlbnZDcmVkczsKICogLy8gbWFzdGVyQ3JlZGVudGlhbHMgd2lsbCBiZSBlbnZDcmVkcwogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAqICAgcGFyYW1zOiB7Um9sZUFybjogJy4uLid9CiAqIH0pOwogKiBgYGAKICoKICogU2ltaWxhcmx5LCB0byB1c2UgdGhlIENyZWRlbnRpYWxQcm92aWRlckNoYWluJ3MgZGVmYXVsdCBwcm92aWRlcnMgYXMgdGhlCiAqIG1hc3RlciBjcmVkZW50aWFscywgc2ltcGx5IGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZgogKiBBV1MuQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHM6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyh7CiAqICAgcGFyYW1zOiB7Um9sZUFybjogJy4uLid9CiAqIH0pOwogKiBgYGAKICoKICogQCFhdHRyaWJ1dGUgc2VydmljZQogKiAgIEByZXR1cm4gW0FXUy5TVFNdIHRoZSBTVFMgc2VydmljZSBpbnN0YW5jZSB1c2VkIHRvCiAqICAgICBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICogQG5vdGUgKHNlZSBjb25zdHJ1Y3RvcikKICovCkFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIG9wdGlvbnMgW21hcF0gYSBzZXQgb2Ygb3B0aW9ucwogICAqIEBvcHRpb24gb3B0aW9ucyBwYXJhbXMgW21hcF0gKHt9KSBhIG1hcCBvZiBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUKICAgKiAgIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9ucy4KICAgKiAgIElmIGEgYFJvbGVBcm5gIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIGNyZWRlbnRpYWxzIHdpbGwgYmUgYmFzZWQgb24gdGhlCiAgICogICBJQU0gcm9sZS4gSWYgYSBgU2VyaWFsTnVtYmVyYCBwYXJhbWV0ZXIgaXMgcGFzc2VkIGluLCB7dG9rZW5Db2RlRm59IG11c3QKICAgKiAgIGFsc28gYmUgcGFzc2VkIGluIG9yIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duLgogICAqIEBvcHRpb24gb3B0aW9ucyBtYXN0ZXJDcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgbWFzdGVyIGNyZWRlbnRpYWxzCiAgICogICB1c2VkIHRvIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLiBCeSBkZWZhdWx0LAogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyBvciBBV1MuY29uZmlnLmNyZWRlbnRpYWxQcm92aWRlciB3aWxsIGJlIHVzZWQuCiAgICogQG9wdGlvbiBvcHRpb25zIHRva2VuQ29kZUZuIFtGdW5jdGlvbl0gKG51bGwpIEZ1bmN0aW9uIHRvIHByb3ZpZGUKICAgKiAgIGBUb2tlbkNvZGVgLCBpZiBgU2VyaWFsTnVtYmVyYCBpcyBwcm92aWRlZCBmb3IgcHJvZmlsZSBpbiB7cGFyYW1zfS4gRnVuY3Rpb24KICAgKiAgIGlzIGNhbGxlZCB3aXRoIHZhbHVlIG9mIGBTZXJpYWxOdW1iZXJgIGFuZCBgY2FsbGJhY2tgLCBhbmQgc2hvdWxkIHByb3ZpZGUKICAgKiAgIHRoZSBgVG9rZW5Db2RlYCBvciBhbiBlcnJvciB0byB0aGUgY2FsbGJhY2sgaW4gdGhlIGZvcm1hdAogICAqICAgYGNhbGxiYWNrKGVyciwgdG9rZW4pYC4KICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGdlbmVyaWMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgICAgcGFyYW1zOiB7CiAgICogICAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvVGVtcG9yYXJ5Q3JlZGVudGlhbHMnCiAgICogICAgIH0KICAgKiAgIH0pOwogICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlCiAgICogQHNlZSBBV1MuU1RTLmdldFNlc3Npb25Ub2tlbgogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDaGFpbmFibGVUZW1wb3JhcnlDcmVkZW50aWFscyhvcHRpb25zKSB7CiAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5lcnJvckNvZGUgPSAnQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHNQcm92aWRlckZhaWx1cmUnOwogICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgIHRoaXMudG9rZW5Db2RlRm4gPSBudWxsOwoKICAgIHZhciBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KG9wdGlvbnMucGFyYW1zKSB8fCB7fTsKICAgIGlmIChwYXJhbXMuUm9sZUFybikgewogICAgICBwYXJhbXMuUm9sZVNlc3Npb25OYW1lID0gcGFyYW1zLlJvbGVTZXNzaW9uTmFtZSB8fCAndGVtcG9yYXJ5LWNyZWRlbnRpYWxzJzsKICAgIH0KICAgIGlmIChwYXJhbXMuU2VyaWFsTnVtYmVyKSB7CiAgICAgIGlmICghb3B0aW9ucy50b2tlbkNvZGVGbiB8fCAodHlwZW9mIG9wdGlvbnMudG9rZW5Db2RlRm4gIT09ICdmdW5jdGlvbicpKSB7CiAgICAgICAgdGhyb3cgbmV3IEFXUy51dGlsLmVycm9yKAogICAgICAgICAgbmV3IEVycm9yKCd0b2tlbkNvZGVGbiBtdXN0IGJlIGEgZnVuY3Rpb24gd2hlbiBwYXJhbXMuU2VyaWFsTnVtYmVyIGlzIGdpdmVuJyksCiAgICAgICAgICB7Y29kZTogdGhpcy5lcnJvckNvZGV9CiAgICAgICAgKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRva2VuQ29kZUZuID0gb3B0aW9ucy50b2tlbkNvZGVGbjsKICAgICAgfQogICAgfQogICAgdmFyIGNvbmZpZyA9IEFXUy51dGlsLm1lcmdlKAogICAgICB7CiAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgY3JlZGVudGlhbHM6IG9wdGlvbnMubWFzdGVyQ3JlZGVudGlhbHMgfHwgQVdTLmNvbmZpZy5jcmVkZW50aWFscwogICAgICB9LAogICAgICBvcHRpb25zLnN0c0NvbmZpZyB8fCB7fQogICAgKTsKICAgIHRoaXMuc2VydmljZSA9IG5ldyBTVFMoY29uZmlnKTsKICB9LAoKICAvKioKICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZX0gb3IKICAgKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59LCBkZXBlbmRpbmcgb24gd2hldGhlciBhbiBJQU0gcm9sZSBBUk4gd2FzIHBhc3NlZAogICAqIHRvIHRoZSBjcmVkZW50aWFscyB7Y29uc3RydWN0b3J9LgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogQHNlZSBBV1MuQ3JlZGVudGlhbHMuZ2V0CiAgICovCiAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqIEBwYXJhbSBjYWxsYmFjawogICAqLwogIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBvcGVyYXRpb24gPSBzZWxmLnNlcnZpY2UuY29uZmlnLnBhcmFtcy5Sb2xlQXJuID8gJ2Fzc3VtZVJvbGUnIDogJ2dldFNlc3Npb25Ub2tlbic7CiAgICB0aGlzLmdldFRva2VuQ29kZShmdW5jdGlvbiAoZXJyLCB0b2tlbkNvZGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IHt9OwogICAgICBpZiAoZXJyKSB7CiAgICAgICAgY2FsbGJhY2soZXJyKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHRva2VuQ29kZSkgewogICAgICAgIHBhcmFtcy5Ub2tlbkNvZGUgPSB0b2tlbkNvZGU7CiAgICAgIH0KICAgICAgc2VsZi5zZXJ2aWNlW29wZXJhdGlvbl0ocGFyYW1zLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0VG9rZW5Db2RlOiBmdW5jdGlvbiBnZXRUb2tlbkNvZGUoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmICh0aGlzLnRva2VuQ29kZUZuKSB7CiAgICAgIHRoaXMudG9rZW5Db2RlRm4odGhpcy5zZXJ2aWNlLmNvbmZpZy5wYXJhbXMuU2VyaWFsTnVtYmVyLCBmdW5jdGlvbiAoZXJyLCB0b2tlbikgewogICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgIHZhciBtZXNzYWdlID0gZXJyOwogICAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICAgIG1lc3NhZ2UgPSBlcnIubWVzc2FnZTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKAogICAgICAgICAgICBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgICBuZXcgRXJyb3IoJ0Vycm9yIGZldGNoaW5nIE1GQSB0b2tlbjogJyArIG1lc3NhZ2UpLAogICAgICAgICAgICAgIHsgY29kZTogc2VsZi5lcnJvckNvZGV9CiAgICAgICAgICAgICkKICAgICAgICAgICk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKG51bGwsIHRva2VuKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayhudWxsKTsKICAgIH0KICB9Cn0pOwoKfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOX1dLDIyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIENvZ25pdG9JZGVudGl0eSA9IHJlcXVpcmUoJy4uLy4uL2NsaWVudHMvY29nbml0b2lkZW50aXR5Jyk7CnZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwoKLyoqCiAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFdlYiBJZGVudGl0eSBGZWRlcmF0aW9uIHVzaW5nCiAqIHRoZSBBbWF6b24gQ29nbml0byBJZGVudGl0eSBzZXJ2aWNlLgogKgogKiBCeSBkZWZhdWx0IHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICoge0FXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24sIHdoaWNoCiAqIHJlcXVpcmVzIGVpdGhlciBhbiBgSWRlbnRpdHlJZGAgb3IgYW4gYElkZW50aXR5UG9vbElkYCAoQW1hem9uIENvZ25pdG8KICogSWRlbnRpdHkgUG9vbCBJRCksIHdoaWNoIGlzIHVzZWQgdG8gY2FsbCB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZH0gdG8KICogb2J0YWluIGFuIGBJZGVudGl0eUlkYC4gSWYgdGhlIGlkZW50aXR5IG9yIGlkZW50aXR5IHBvb2wgaXMgbm90IGNvbmZpZ3VyZWQgaW4KICogdGhlIEFtYXpvbiBDb2duaXRvIENvbnNvbGUgdG8gdXNlIElBTSByb2xlcyB3aXRoIHRoZSBhcHByb3ByaWF0ZSBwZXJtaXNzaW9ucywKICogdGhlbiBhZGRpdGlvbmFsbHkgYSBgUm9sZUFybmAgaXMgcmVxdWlyZWQgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QKICogcG9saWN5IGZvciB0aGUgQW1hem9uIENvZ25pdG8gcm9sZSB0aGF0IHRoZSB1c2VyIHdpbGwgbG9nIGludG8uIElmIGEgYFJvbGVBcm5gCiAqIGlzIHByb3ZpZGVkLCB0aGVuIHRoaXMgcHJvdmlkZXIgZ2V0cyBjcmVkZW50aWFscyB1c2luZyB0aGUKICoge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0gc2VydmljZSBvcGVyYXRpb24sIGFmdGVyIGZpcnN0IGdldHRpbmcgYW4KICogT3BlbiBJRCB0b2tlbiBmcm9tIHtBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VufS4KICoKICogSW4gYWRkaXRpb24sIGlmIHRoaXMgY3JlZGVudGlhbCBwcm92aWRlciBpcyB1c2VkIHRvIHByb3ZpZGUgYXV0aGVudGljYXRlZAogKiBsb2dpbiwgdGhlIGBMb2dpbnNgIG1hcCBtYXkgYmUgc2V0IHRvIHRoZSB0b2tlbnMgcHJvdmlkZWQgYnkgdGhlIHJlc3BlY3RpdmUKICogaWRlbnRpdHkgcHJvdmlkZXJzLiBTZWUge2NvbnN0cnVjdG9yfSBmb3IgYW4gZXhhbXBsZSBvbiBjcmVhdGluZyBhIGNyZWRlbnRpYWxzCiAqIG9iamVjdCB3aXRoIHByb3BlciBwcm9wZXJ0eSB2YWx1ZXMuCiAqCiAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAqCiAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFdlYklkZW50aXR5VG9rZW4sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLkxvZ2luc1snZ3JhcGguZmFjZWJvb2suY29tJ10gPSB1cGRhdGVkVG9rZW47CiAqIGBgYAogKgogKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAqCiAqIEAhYXR0cmlidXRlIHBhcmFtcwogKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJZH0sCiAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0sIGFuZAogKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFRvIHVwZGF0ZSB0aGUgdG9rZW4sIHNldCB0aGUKICogICAgIGBwYXJhbXMuV2ViSWRlbnRpdHlUb2tlbmAgcHJvcGVydHkuCiAqIEAhYXR0cmlidXRlIGRhdGEKICogICBAcmV0dXJuIFttYXBdIHRoZSByYXcgZGF0YSByZXNwb25zZSBmcm9tIHRoZSBjYWxsIHRvCiAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSwgb3IKICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBVc2UgdGhpcyBpZiB5b3Ugd2FudCB0byBnZXQKICogICAgIGFjY2VzcyB0byBvdGhlciBwcm9wZXJ0aWVzIGZyb20gdGhlIHJlc3BvbnNlLgogKiBAIWF0dHJpYnV0ZSBpZGVudGl0eUlkCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgQ29nbml0byBJRCByZXR1cm5lZCBieSB0aGUgbGFzdCBjYWxsIHRvCiAqICAgICB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRPcGVuSWRUb2tlbn0uIFRoaXMgSUQgcmVwcmVzZW50cyB0aGUgYWN0dWFsCiAqICAgICBmaW5hbCByZXNvbHZlZCBpZGVudGl0eSBJRCBmcm9tIEFtYXpvbiBDb2duaXRvLgogKi8KQVdTLkNvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2NhbFN0b3JhZ2VLZXk6IHsKICAgIGlkOiAnYXdzLmNvZ25pdG8uaWRlbnRpdHktaWQuJywKICAgIHByb3ZpZGVyczogJ2F3cy5jb2duaXRvLmlkZW50aXR5LXByb3ZpZGVycy4nCiAgfSwKCiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5Db2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICoKICAgKiAgICAgLy8gZWl0aGVyIElkZW50aXR5UG9vbElkIG9yIElkZW50aXR5SWQgaXMgcmVxdWlyZWQKICAgKiAgICAgLy8gU2VlIHRoZSBJZGVudGl0eVBvb2xJZCBwYXJhbSBmb3IgQVdTLkNvZ25pdG9JZGVudGl0eS5nZXRJRCAobGlua2VkIGJlbG93KQogICAqICAgICAvLyBTZWUgdGhlIElkZW50aXR5SWQgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eQogICAqICAgICAvLyBvciBBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VuIChsaW5rZWQgYmVsb3cpCiAgICogICAgIElkZW50aXR5UG9vbElkOiAndXMtZWFzdC0xOjE2OTllYmMwLTc5MDAtNDA5OS1iOTEwLTJkZjk0ZjUyYTAzMCcsCiAgICogICAgIElkZW50aXR5SWQ6ICd1cy1lYXN0LTE6MTI4ZDBhNzQtYzgyZi00NTUzLTkxNmQtOTAwNTNlNGE4YjBmJwogICAqCiAgICogICAgIC8vIG9wdGlvbmFsLCBvbmx5IG5lY2Vzc2FyeSB3aGVuIHRoZSBpZGVudGl0eSBwb29sIGlzIG5vdCBjb25maWd1cmVkCiAgICogICAgIC8vIHRvIHVzZSBJQU0gcm9sZXMgaW4gdGhlIEFtYXpvbiBDb2duaXRvIENvbnNvbGUKICAgKiAgICAgLy8gU2VlIHRoZSBSb2xlQXJuIHBhcmFtIGZvciBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkgKGxpbmtlZCBiZWxvdykKICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvTVlBUFAtQ29nbml0b0lkZW50aXR5JywKICAgKgogICAqICAgICAvLyBvcHRpb25hbCB0b2tlbnMsIHVzZWQgZm9yIGF1dGhlbnRpY2F0ZWQgbG9naW4KICAgKiAgICAgLy8gU2VlIHRoZSBMb2dpbnMgcGFyYW0gZm9yIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SUQgKGxpbmtlZCBiZWxvdykKICAgKiAgICAgTG9naW5zOiB7CiAgICogICAgICAgJ2dyYXBoLmZhY2Vib29rLmNvbSc6ICdGQlRPS0VOJywKICAgKiAgICAgICAnd3d3LmFtYXpvbi5jb20nOiAnQU1BWk9OVE9LRU4nLAogICAqICAgICAgICdhY2NvdW50cy5nb29nbGUuY29tJzogJ0dPT0dMRVRPS0VOJywKICAgKiAgICAgICAnYXBpLnR3aXR0ZXIuY29tJzogJ1RXSVRURVJUT0tFTicsCiAgICogICAgICAgJ3d3dy5kaWdpdHMuY29tJzogJ0RJR0lUU1RPS0VOJwogICAqICAgICB9LAogICAqCiAgICogICAgIC8vIG9wdGlvbmFsIG5hbWUsIGRlZmF1bHRzIHRvIHdlYi1pZGVudGl0eQogICAqICAgICAvLyBTZWUgdGhlIFJvbGVTZXNzaW9uTmFtZSBwYXJhbSBmb3IgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5IChsaW5rZWQgYmVsb3cpCiAgICogICAgIFJvbGVTZXNzaW9uTmFtZTogJ3dlYicsCiAgICoKICAgKiAgICAgLy8gb3B0aW9uYWwsIG9ubHkgbmVjZXNzYXJ5IHdoZW4gYXBwbGljYXRpb24gcnVucyBpbiBhIGJyb3dzZXIKICAgKiAgICAgLy8gYW5kIG11bHRpcGxlIHVzZXJzIGFyZSBzaWduZWQgaW4gYXQgb25jZSwgdXNlZCBmb3IgY2FjaGluZwogICAqICAgICBMb2dpbklkOiAnZXhhbXBsZUBnbWFpbC5jb20nCiAgICoKICAgKiAgIH0sIHsKICAgKiAgICAgIC8vIG9wdGlvbmFsbHkgcHJvdmlkZSBjb25maWd1cmF0aW9uIHRvIGFwcGx5IHRvIHRoZSB1bmRlcmx5aW5nIHNlcnZpY2UgY2xpZW50cwogICAqICAgICAgLy8gaWYgY29uZmlndXJhdGlvbiBpcyBub3QgcHJvdmlkZWQsIHRoZW4gY29uZmlndXJhdGlvbiB3aWxsIGJlIHB1bGxlZCBmcm9tIEFXUy5jb25maWcKICAgKgogICAqICAgICAgLy8gcmVnaW9uIHNob3VsZCBtYXRjaCB0aGUgcmVnaW9uIHlvdXIgaWRlbnRpdHkgcG9vbCBpcyBsb2NhdGVkIGluCiAgICogICAgICByZWdpb246ICd1cy1lYXN0LTEnLAogICAqCiAgICogICAgICAvLyBzcGVjaWZ5IHRpbWVvdXQgb3B0aW9ucwogICAqICAgICAgaHR0cE9wdGlvbnM6IHsKICAgKiAgICAgICAgdGltZW91dDogMTAwCiAgICogICAgICB9CiAgICogICB9KTsKICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0SWQKICAgKiBAc2VlIEFXUy5Db2duaXRvSWRlbnRpdHkuZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eQogICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5CiAgICogQHNlZSBBV1MuQ29nbml0b0lkZW50aXR5LmdldE9wZW5JZFRva2VuCiAgICogQHNlZSBBV1MuQ29uZmlnCiAgICogQG5vdGUgSWYgYSByZWdpb24gaXMgbm90IHByb3ZpZGVkIGluIHRoZSBnbG9iYWwgQVdTLmNvbmZpZywgb3IKICAgKiAgIHNwZWNpZmllZCBpbiB0aGUgYGNsaWVudENvbmZpZ2AgdG8gdGhlIENvZ25pdG9JZGVudGl0eUNyZWRlbnRpYWxzCiAgICogICBjb25zdHJ1Y3RvciwgeW91IG1heSBlbmNvdW50ZXIgYSAnTWlzc2luZyBjcmVkZW50aWFscyBpbiBjb25maWcnIGVycm9yCiAgICogICB3aGVuIGNhbGxpbmcgbWFraW5nIGEgc2VydmljZSBjYWxsLgogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBDb2duaXRvSWRlbnRpdHlDcmVkZW50aWFscyhwYXJhbXMsIGNsaWVudENvbmZpZykgewogICAgQVdTLkNyZWRlbnRpYWxzLmNhbGwodGhpcyk7CiAgICB0aGlzLmV4cGlyZWQgPSB0cnVlOwogICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICB0aGlzLmRhdGEgPSBudWxsOwogICAgdGhpcy5faWRlbnRpdHlJZCA9IG51bGw7CiAgICB0aGlzLl9jbGllbnRDb25maWcgPSBBV1MudXRpbC5jb3B5KGNsaWVudENvbmZpZyB8fCB7fSk7CiAgICB0aGlzLmxvYWRDYWNoZWRJZCgpOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdpZGVudGl0eUlkJywgewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYubG9hZENhY2hlZElkKCk7CiAgICAgICAgcmV0dXJuIHNlbGYuX2lkZW50aXR5SWQgfHwgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZDsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbihpZGVudGl0eUlkKSB7CiAgICAgICAgc2VsZi5faWRlbnRpdHlJZCA9IGlkZW50aXR5SWQ7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIC8qKgogICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLkNvZ25pdG9JZGVudGl0eS5nZXRDcmVkZW50aWFsc0ZvcklkZW50aXR5fSwKICAgKiBvciB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqIEBzZWUgQVdTLkNyZWRlbnRpYWxzLmdldAogICAqLwogIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2goY2FsbGJhY2spIHsKICAgIHRoaXMuY29hbGVzY2VSZWZyZXNoKGNhbGxiYWNrIHx8IEFXUy51dGlsLmZuLmNhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBAcGFyYW0gY2FsbGJhY2sKICAgKi8KICBsb2FkOiBmdW5jdGlvbiBsb2FkKGNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLmNyZWF0ZUNsaWVudHMoKTsKICAgIHNlbGYuZGF0YSA9IG51bGw7CiAgICBzZWxmLl9pZGVudGl0eUlkID0gbnVsbDsKICAgIHNlbGYuZ2V0SWQoZnVuY3Rpb24oZXJyKSB7CiAgICAgIGlmICghZXJyKSB7CiAgICAgICAgaWYgKCFzZWxmLnBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgICAgICBzZWxmLmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoY2FsbGJhY2spOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLmdldENyZWRlbnRpYWxzRnJvbVNUUyhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIC8qKgogICAqIENsZWFycyB0aGUgY2FjaGVkIENvZ25pdG8gSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSBjdXJyZW50bHkgY29uZmlndXJlZAogICAqIGlkZW50aXR5IHBvb2wgSUQuIFVzZSB0aGlzIHRvIG1hbnVhbGx5IGludmFsaWRhdGUgeW91ciBjYWNoZSBpZgogICAqIHRoZSBpZGVudGl0eSBwb29sIElEIHdhcyBkZWxldGVkLgogICAqLwogIGNsZWFyQ2FjaGVkSWQ6IGZ1bmN0aW9uIGNsZWFyQ2FjaGUoKSB7CiAgICB0aGlzLl9pZGVudGl0eUlkID0gbnVsbDsKICAgIGRlbGV0ZSB0aGlzLnBhcmFtcy5JZGVudGl0eUlkOwoKICAgIHZhciBwb29sSWQgPSB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZDsKICAgIHZhciBsb2dpbklkID0gdGhpcy5wYXJhbXMuTG9naW5JZCB8fCAnJzsKICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXkuaWQgKyBwb29sSWQgKyBsb2dpbklkXTsKICAgIGRlbGV0ZSB0aGlzLnN0b3JhZ2VbdGhpcy5sb2NhbFN0b3JhZ2VLZXkucHJvdmlkZXJzICsgcG9vbElkICsgbG9naW5JZF07CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY2xlYXJJZE9uTm90QXV0aG9yaXplZDogZnVuY3Rpb24gY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChlcnIuY29kZSA9PSAnTm90QXV0aG9yaXplZEV4Y2VwdGlvbicpIHsKICAgICAgc2VsZi5jbGVhckNhY2hlZElkKCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogUmV0cmlldmVzIGEgQ29nbml0byBJRCwgbG9hZGluZyBmcm9tIGNhY2hlIGlmIGl0IHdhcyBhbHJlYWR5IHJldHJpZXZlZAogICAqIG9uIHRoaXMgZGV2aWNlLgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgaWRlbnRpdHlJZCkKICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yLCBudWxsXSBhbiBlcnJvciBvYmplY3QgaWYgdGhlIGNhbGwgZmFpbGVkIG9yIG51bGwgaWYKICAgKiAgICAgaXQgc3VjY2VlZGVkLgogICAqICAgQHBhcmFtIGlkZW50aXR5SWQgW1N0cmluZywgbnVsbF0gaWYgc3VjY2Vzc2Z1bCwgdGhlIGNhbGxiYWNrIHdpbGwgcmV0dXJuCiAgICogICAgIHRoZSBDb2duaXRvIElELgogICAqIEBub3RlIElmIG5vdCBsb2FkZWQgZXhwbGljaXRseSwgdGhlIENvZ25pdG8gSUQgaXMgbG9hZGVkIGFuZCBzdG9yZWQgaW4KICAgKiAgIGxvY2FsU3RvcmFnZSBpbiB0aGUgYnJvd3NlciBlbnZpcm9ubWVudCBvZiBhIGRldmljZS4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRJZDogZnVuY3Rpb24gZ2V0SWQoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmICh0eXBlb2Ygc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9PT0gJ3N0cmluZycpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrKG51bGwsIHNlbGYucGFyYW1zLklkZW50aXR5SWQpOwogICAgfQoKICAgIHNlbGYuY29nbml0by5nZXRJZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgaWYgKCFlcnIgJiYgZGF0YS5JZGVudGl0eUlkKSB7CiAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGRhdGEuSWRlbnRpdHlJZDsKICAgICAgICBjYWxsYmFjayhudWxsLCBkYXRhLklkZW50aXR5SWQpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0KICAgIH0pOwogIH0sCgoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkQ3JlZGVudGlhbHM6IGZ1bmN0aW9uIGxvYWRDcmVkZW50aWFscyhkYXRhLCBjcmVkZW50aWFscykgewogICAgaWYgKCFkYXRhIHx8ICFjcmVkZW50aWFscykgcmV0dXJuOwogICAgY3JlZGVudGlhbHMuZXhwaXJlZCA9IGZhbHNlOwogICAgY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgPSBkYXRhLkNyZWRlbnRpYWxzLkFjY2Vzc0tleUlkOwogICAgY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5ID0gZGF0YS5DcmVkZW50aWFscy5TZWNyZXRLZXk7CiAgICBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4gPSBkYXRhLkNyZWRlbnRpYWxzLlNlc3Npb25Ub2tlbjsKICAgIGNyZWRlbnRpYWxzLmV4cGlyZVRpbWUgPSBkYXRhLkNyZWRlbnRpYWxzLkV4cGlyYXRpb247CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eTogZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbHNGb3JJZGVudGl0eShjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jb2duaXRvLmdldENyZWRlbnRpYWxzRm9ySWRlbnRpdHkoZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgIGlmICghZXJyKSB7CiAgICAgICAgc2VsZi5jYWNoZUlkKGRhdGEpOwogICAgICAgIHNlbGYuZGF0YSA9IGRhdGE7CiAgICAgICAgc2VsZi5sb2FkQ3JlZGVudGlhbHMoc2VsZi5kYXRhLCBzZWxmKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZWxmLmNsZWFySWRPbk5vdEF1dGhvcml6ZWQoZXJyKTsKICAgICAgfQogICAgICBjYWxsYmFjayhlcnIpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0Q3JlZGVudGlhbHNGcm9tU1RTOiBmdW5jdGlvbiBnZXRDcmVkZW50aWFsc0Zyb21TVFMoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY29nbml0by5nZXRPcGVuSWRUb2tlbihmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgaWYgKCFlcnIpIHsKICAgICAgICBzZWxmLmNhY2hlSWQoZGF0YSk7CiAgICAgICAgc2VsZi5wYXJhbXMuV2ViSWRlbnRpdHlUb2tlbiA9IGRhdGEuVG9rZW47CiAgICAgICAgc2VsZi53ZWJJZGVudGl0eUNyZWRlbnRpYWxzLnJlZnJlc2goZnVuY3Rpb24od2ViRXJyKSB7CiAgICAgICAgICBpZiAoIXdlYkVycikgewogICAgICAgICAgICBzZWxmLmRhdGEgPSBzZWxmLndlYklkZW50aXR5Q3JlZGVudGlhbHMuZGF0YTsKICAgICAgICAgICAgc2VsZi5zdHMuY3JlZGVudGlhbHNGcm9tKHNlbGYuZGF0YSwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgICBjYWxsYmFjayh3ZWJFcnIpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHNlbGYuY2xlYXJJZE9uTm90QXV0aG9yaXplZChlcnIpOwogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0KICAgIH0pOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWRDYWNoZWRJZDogZnVuY3Rpb24gbG9hZENhY2hlZElkKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIGluIHRoZSBicm93c2VyIHdlIHNvdXJjZSBkZWZhdWx0IElkZW50aXR5SWQgZnJvbSBsb2NhbFN0b3JhZ2UKICAgIGlmIChBV1MudXRpbC5pc0Jyb3dzZXIoKSAmJiAhc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCkgewogICAgICB2YXIgaWQgPSBzZWxmLmdldFN0b3JhZ2UoJ2lkJyk7CiAgICAgIGlmIChpZCAmJiBzZWxmLnBhcmFtcy5Mb2dpbnMpIHsKICAgICAgICB2YXIgYWN0dWFsUHJvdmlkZXJzID0gT2JqZWN0LmtleXMoc2VsZi5wYXJhbXMuTG9naW5zKTsKICAgICAgICB2YXIgY2FjaGVkUHJvdmlkZXJzID0KICAgICAgICAgIChzZWxmLmdldFN0b3JhZ2UoJ3Byb3ZpZGVycycpIHx8ICcnKS5zcGxpdCgnLCcpOwoKICAgICAgICAvLyBvbmx5IGxvYWQgSUQgaWYgYXQgbGVhc3Qgb25lIHByb3ZpZGVyIHVzZWQgdGhpcyBJRCBiZWZvcmUKICAgICAgICB2YXIgaW50ZXJzZWN0ID0gY2FjaGVkUHJvdmlkZXJzLmZpbHRlcihmdW5jdGlvbihuKSB7CiAgICAgICAgICByZXR1cm4gYWN0dWFsUHJvdmlkZXJzLmluZGV4T2YobikgIT09IC0xOwogICAgICAgIH0pOwogICAgICAgIGlmIChpbnRlcnNlY3QubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICBzZWxmLnBhcmFtcy5JZGVudGl0eUlkID0gaWQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlkKSB7CiAgICAgICAgc2VsZi5wYXJhbXMuSWRlbnRpdHlJZCA9IGlkOwogICAgICB9CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICB2YXIgY2xpZW50Q29uZmlnID0gdGhpcy5fY2xpZW50Q29uZmlnOwogICAgdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzID0gdGhpcy53ZWJJZGVudGl0eUNyZWRlbnRpYWxzIHx8CiAgICAgIG5ldyBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyh0aGlzLnBhcmFtcywgY2xpZW50Q29uZmlnKTsKICAgIGlmICghdGhpcy5jb2duaXRvKSB7CiAgICAgIHZhciBjb2duaXRvQ29uZmlnID0gQVdTLnV0aWwubWVyZ2Uoe30sIGNsaWVudENvbmZpZyk7CiAgICAgIGNvZ25pdG9Db25maWcucGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICAgIHRoaXMuY29nbml0byA9IG5ldyBDb2duaXRvSWRlbnRpdHkoY29nbml0b0NvbmZpZyk7CiAgICB9CiAgICB0aGlzLnN0cyA9IHRoaXMuc3RzIHx8IG5ldyBTVFMoY2xpZW50Q29uZmlnKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjYWNoZUlkOiBmdW5jdGlvbiBjYWNoZUlkKGRhdGEpIHsKICAgIHRoaXMuX2lkZW50aXR5SWQgPSBkYXRhLklkZW50aXR5SWQ7CiAgICB0aGlzLnBhcmFtcy5JZGVudGl0eUlkID0gdGhpcy5faWRlbnRpdHlJZDsKCiAgICAvLyBjYWNoZSB0aGlzIElkZW50aXR5SWQgaW4gYnJvd3NlciBsb2NhbFN0b3JhZ2UgaWYgcG9zc2libGUKICAgIGlmIChBV1MudXRpbC5pc0Jyb3dzZXIoKSkgewogICAgICB0aGlzLnNldFN0b3JhZ2UoJ2lkJywgZGF0YS5JZGVudGl0eUlkKTsKCiAgICAgIGlmICh0aGlzLnBhcmFtcy5Mb2dpbnMpIHsKICAgICAgICB0aGlzLnNldFN0b3JhZ2UoJ3Byb3ZpZGVycycsIE9iamVjdC5rZXlzKHRoaXMucGFyYW1zLkxvZ2lucykuam9pbignLCcpKTsKICAgICAgfQogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldFN0b3JhZ2U6IGZ1bmN0aW9uIGdldFN0b3JhZ2Uoa2V5KSB7CiAgICByZXR1cm4gdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5W2tleV0gKyB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZCArICh0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnKV07CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2V0U3RvcmFnZTogZnVuY3Rpb24gc2V0U3RvcmFnZShrZXksIHZhbCkgewogICAgdHJ5IHsKICAgICAgdGhpcy5zdG9yYWdlW3RoaXMubG9jYWxTdG9yYWdlS2V5W2tleV0gKyB0aGlzLnBhcmFtcy5JZGVudGl0eVBvb2xJZCArICh0aGlzLnBhcmFtcy5Mb2dpbklkIHx8ICcnKV0gPSB2YWw7CiAgICB9IGNhdGNoIChfKSB7fQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHN0b3JhZ2U6IChmdW5jdGlvbigpIHsKICAgIHRyeSB7CiAgICAgIHZhciBzdG9yYWdlID0gQVdTLnV0aWwuaXNCcm93c2VyKCkgJiYgd2luZG93LmxvY2FsU3RvcmFnZSAhPT0gbnVsbCAmJiB0eXBlb2Ygd2luZG93LmxvY2FsU3RvcmFnZSA9PT0gJ29iamVjdCcgPwogICAgICAgICAgd2luZG93LmxvY2FsU3RvcmFnZSA6IHt9OwoKICAgICAgLy8gVGVzdCBzZXQvcmVtb3ZlIHdoaWNoIHdvdWxkIHRocm93IGFuIGVycm9yIGluIFNhZmFyaSdzIHByaXZhdGUgYnJvd3NpbmcKICAgICAgc3RvcmFnZVsnYXdzLnRlc3Qtc3RvcmFnZSddID0gJ2Zvb2Jhcic7CiAgICAgIGRlbGV0ZSBzdG9yYWdlWydhd3MudGVzdC1zdG9yYWdlJ107CgogICAgICByZXR1cm4gc3RvcmFnZTsKICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgcmV0dXJuIHt9OwogICAgfQogIH0pKCkKfSk7Cgp9LHsiLi4vLi4vY2xpZW50cy9jb2duaXRvaWRlbnRpdHkiOjcsIi4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOX1dLDIzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKCi8qKgogKiBDcmVhdGVzIGEgY3JlZGVudGlhbCBwcm92aWRlciBjaGFpbiB0aGF0IHNlYXJjaGVzIGZvciBBV1MgY3JlZGVudGlhbHMKICogaW4gYSBsaXN0IG9mIGNyZWRlbnRpYWwgcHJvdmlkZXJzIHNwZWNpZmllZCBieSB0aGUge3Byb3ZpZGVyc30gcHJvcGVydHkuCiAqCiAqIEJ5IGRlZmF1bHQsIHRoZSBjaGFpbiB3aWxsIHVzZSB0aGUge2RlZmF1bHRQcm92aWRlcnN9IHRvIHJlc29sdmUgY3JlZGVudGlhbHMuCiAqIFRoZXNlIHByb3ZpZGVycyB3aWxsIGxvb2sgaW4gdGhlIGVudmlyb25tZW50IHVzaW5nIHRoZQogKiB7QVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHN9IGNsYXNzIHdpdGggdGhlICdBV1MnIGFuZCAnQU1BWk9OJyBwcmVmaXhlcy4KICoKICogIyMgU2V0dGluZyBQcm92aWRlcnMKICoKICogRWFjaCBwcm92aWRlciBpbiB0aGUge3Byb3ZpZGVyc30gbGlzdCBzaG91bGQgYmUgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMKICogYSB7QVdTLkNyZWRlbnRpYWxzfSBvYmplY3QsIG9yIGEgaGFyZGNvZGVkIGNyZWRlbnRpYWxzIG9iamVjdC4gVGhlIGZ1bmN0aW9uCiAqIGZvcm0gYWxsb3dzIGZvciBkZWxheWVkIGV4ZWN1dGlvbiBvZiB0aGUgY3JlZGVudGlhbCBjb25zdHJ1Y3Rpb24uCiAqCiAqICMjIFJlc29sdmluZyBDcmVkZW50aWFscyBmcm9tIGEgQ2hhaW4KICoKICogQ2FsbCB7cmVzb2x2ZX0gdG8gcmV0dXJuIHRoZSBmaXJzdCB2YWxpZCBjcmVkZW50aWFsIG9iamVjdCB0aGF0IGNhbiBiZQogKiBsb2FkZWQgYnkgdGhlIHByb3ZpZGVyIGNoYWluLgogKgogKiBGb3IgZXhhbXBsZSwgdG8gcmVzb2x2ZSBhIGNoYWluIHdpdGggYSBjdXN0b20gcHJvdmlkZXIgdGhhdCBjaGVja3MgYSBmaWxlCiAqIG9uIGRpc2sgYWZ0ZXIgdGhlIHNldCBvZiB7ZGVmYXVsdFByb3ZpZGVyc306CiAqCiAqIGBgYGphdmFzY3JpcHQKICogdmFyIGRpc2tQcm92aWRlciA9IG5ldyBBV1MuRmlsZVN5c3RlbUNyZWRlbnRpYWxzKCcuL2NyZWRzLmpzb24nKTsKICogdmFyIGNoYWluID0gbmV3IEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbigpOwogKiBjaGFpbi5wcm92aWRlcnMucHVzaChkaXNrUHJvdmlkZXIpOwogKiBjaGFpbi5yZXNvbHZlKCk7CiAqIGBgYAogKgogKiBUaGUgYWJvdmUgY29kZSB3aWxsIHJldHVybiB0aGUgYGRpc2tQcm92aWRlcmAgb2JqZWN0IGlmIHRoZQogKiBmaWxlIGNvbnRhaW5zIGNyZWRlbnRpYWxzIGFuZCB0aGUgYGRlZmF1bHRQcm92aWRlcnNgIGRvIG5vdCBjb250YWluCiAqIGFueSBjcmVkZW50aWFsIHNldHRpbmdzLgogKgogKiBAIWF0dHJpYnV0ZSBwcm92aWRlcnMKICogICBAcmV0dXJuIFtBcnJheTxBV1MuQ3JlZGVudGlhbHMsIEZ1bmN0aW9uPl0KICogICAgIGEgbGlzdCBvZiBjcmVkZW50aWFscyBvYmplY3RzIG9yIGZ1bmN0aW9ucyB0aGF0IHJldHVybiBjcmVkZW50aWFscwogKiAgICAgb2JqZWN0cy4gSWYgdGhlIHByb3ZpZGVyIGlzIGEgZnVuY3Rpb24sIHRoZSBmdW5jdGlvbiB3aWxsIGJlCiAqICAgICBleGVjdXRlZCBsYXppbHkgd2hlbiB0aGUgcHJvdmlkZXIgbmVlZHMgdG8gYmUgY2hlY2tlZCBmb3IgdmFsaWQKICogICAgIGNyZWRlbnRpYWxzLiBCeSBkZWZhdWx0LCB0aGlzIG9iamVjdCB3aWxsIGJlIHNldCB0byB0aGUKICogICAgIHtkZWZhdWx0UHJvdmlkZXJzfS4KICogICBAc2VlIGRlZmF1bHRQcm92aWRlcnMKICovCkFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbiA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4gd2l0aCBhIGRlZmF1bHQgc2V0IG9mIHByb3ZpZGVycwogICAqIHNwZWNpZmllZCBieSB7ZGVmYXVsdFByb3ZpZGVyc30uCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIENyZWRlbnRpYWxQcm92aWRlckNoYWluKHByb3ZpZGVycykgewogICAgaWYgKHByb3ZpZGVycykgewogICAgICB0aGlzLnByb3ZpZGVycyA9IHByb3ZpZGVyczsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucHJvdmlkZXJzID0gQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMuc2xpY2UoMCk7CiAgICB9CiAgICB0aGlzLnJlc29sdmVDYWxsYmFja3MgPSBbXTsKICB9LAoKICAvKioKICAgKiBAIW1ldGhvZCAgcmVzb2x2ZVByb21pc2UoKQogICAqICAgUmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgKiAgIFJlc29sdmVzIHRoZSBwcm92aWRlciBjaGFpbiBieSBzZWFyY2hpbmcgZm9yIHRoZSBmaXJzdCBzZXQgb2YKICAgKiAgIGNyZWRlbnRpYWxzIGluIHtwcm92aWRlcnN9LgogICAqCiAgICogICBUd28gY2FsbGJhY2tzIGNhbiBiZSBwcm92aWRlZCB0byB0aGUgYHRoZW5gIG1ldGhvZCBvbiB0aGUgcmV0dXJuZWQgcHJvbWlzZS4KICAgKiAgIFRoZSBmaXJzdCBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyBmdWxmaWxsZWQsIGFuZCB0aGUgc2Vjb25kCiAgICogICBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgIEBjYWxsYmFjayBmdWxmaWxsZWRDYWxsYmFjayBmdW5jdGlvbihjcmVkZW50aWFscykKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZCBhbmQgdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbgogICAqICAgICB0byBhIGNyZWRlbnRpYWxzIG9iamVjdAogICAqICAgICBAcGFyYW0gY3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCByZXNvbHZlZAogICAqICAgICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgKiAgIEBjYWxsYmFjayByZWplY3RlZENhbGxiYWNrIGZ1bmN0aW9uKGVycm9yKQogICAqICAgICBDYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZSBmb3VuZC4KICAgKiAgIEByZXR1cm4gW1Byb21pc2VdIEEgcHJvbWlzZSB0aGF0IHJlcHJlc2VudHMgdGhlIHN0YXRlIG9mIHRoZSBgcmVzb2x2ZWAgbWV0aG9kIGNhbGwuCiAgICogICBAZXhhbXBsZSBDYWxsaW5nIHRoZSBgcmVzb2x2ZVByb21pc2VgIG1ldGhvZC4KICAgKiAgICAgdmFyIHByb21pc2UgPSBjaGFpbi5yZXNvbHZlUHJvbWlzZSgpOwogICAqICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24oY3JlZGVudGlhbHMpIHsgLi4uIH0sIGZ1bmN0aW9uKGVycikgeyAuLi4gfSk7CiAgICovCgogIC8qKgogICAqIFJlc29sdmVzIHRoZSBwcm92aWRlciBjaGFpbiBieSBzZWFyY2hpbmcgZm9yIHRoZSBmaXJzdCBzZXQgb2YKICAgKiBjcmVkZW50aWFscyBpbiB7cHJvdmlkZXJzfS4KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGNyZWRlbnRpYWxzKQogICAqICAgQ2FsbGVkIHdoZW4gdGhlIHByb3ZpZGVyIHJlc29sdmVzIHRoZSBjaGFpbiB0byBhIGNyZWRlbnRpYWxzIG9iamVjdAogICAqICAgb3IgbnVsbCBpZiBubyBjcmVkZW50aWFscyBjYW4gYmUgZm91bmQuCiAgICoKICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGlmIG5vIGNyZWRlbnRpYWxzIGFyZQogICAqICAgICBmb3VuZC4KICAgKiAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSB0aGUgY3JlZGVudGlhbHMgb2JqZWN0IHJlc29sdmVkCiAgICogICAgIGJ5IHRoZSBwcm92aWRlciBjaGFpbi4KICAgKiBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW5dIHRoZSBwcm92aWRlciwgZm9yIGNoYWluaW5nLgogICAqLwogIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmUoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmIChzZWxmLnByb3ZpZGVycy5sZW5ndGggPT09IDApIHsKICAgICAgY2FsbGJhY2sobmV3IEVycm9yKCdObyBwcm92aWRlcnMnKSk7CiAgICAgIHJldHVybiBzZWxmOwogICAgfQoKICAgIGlmIChzZWxmLnJlc29sdmVDYWxsYmFja3MucHVzaChjYWxsYmFjaykgPT09IDEpIHsKICAgICAgdmFyIGluZGV4ID0gMDsKICAgICAgdmFyIHByb3ZpZGVycyA9IHNlbGYucHJvdmlkZXJzLnNsaWNlKDApOwoKICAgICAgZnVuY3Rpb24gcmVzb2x2ZU5leHQoZXJyLCBjcmVkcykgewogICAgICAgIGlmICgoIWVyciAmJiBjcmVkcykgfHwgaW5kZXggPT09IHByb3ZpZGVycy5sZW5ndGgpIHsKICAgICAgICAgIEFXUy51dGlsLmFycmF5RWFjaChzZWxmLnJlc29sdmVDYWxsYmFja3MsIGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjayhlcnIsIGNyZWRzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgc2VsZi5yZXNvbHZlQ2FsbGJhY2tzLmxlbmd0aCA9IDA7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgcHJvdmlkZXIgPSBwcm92aWRlcnNbaW5kZXgrK107CiAgICAgICAgaWYgKHR5cGVvZiBwcm92aWRlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgY3JlZHMgPSBwcm92aWRlci5jYWxsKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNyZWRzID0gcHJvdmlkZXI7CiAgICAgICAgfQoKICAgICAgICBpZiAoY3JlZHMuZ2V0KSB7CiAgICAgICAgICBjcmVkcy5nZXQoZnVuY3Rpb24gKGdldEVycikgewogICAgICAgICAgICByZXNvbHZlTmV4dChnZXRFcnIsIGdldEVyciA/IG51bGwgOiBjcmVkcyk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzb2x2ZU5leHQobnVsbCwgY3JlZHMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmVzb2x2ZU5leHQoKTsKICAgIH0KCiAgICByZXR1cm4gc2VsZjsKICB9Cn0pOwoKLyoqCiAqIFRoZSBkZWZhdWx0IHNldCBvZiBwcm92aWRlcnMgdXNlZCBieSBhIHZhbmlsbGEgQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uCiAqCiAqIEluIHRoZSBicm93c2VyOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIEFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gW10KICogYGBgCiAqCiAqIEluIE5vZGUuanM6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogQVdTLkNyZWRlbnRpYWxQcm92aWRlckNoYWluLmRlZmF1bHRQcm92aWRlcnMgPSBbCiAqICAgZnVuY3Rpb24gKCkgeyByZXR1cm4gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsgfSwKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLkVudmlyb25tZW50Q3JlZGVudGlhbHMoJ0FNQVpPTicpOyB9LAogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuU3NvQ3JlZGVudGlhbHMoKTsgfSwKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlNoYXJlZEluaUZpbGVDcmVkZW50aWFscygpOyB9LAogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUNTQ3JlZGVudGlhbHMoKTsgfSwKICogICBmdW5jdGlvbiAoKSB7IHJldHVybiBuZXcgQVdTLlByb2Nlc3NDcmVkZW50aWFscygpOyB9LAogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuVG9rZW5GaWxlV2ViSWRlbnRpdHlDcmVkZW50aWFscygpOyB9LAogKiAgIGZ1bmN0aW9uICgpIHsgcmV0dXJuIG5ldyBBV1MuRUMyTWV0YWRhdGFDcmVkZW50aWFscygpIH0KICogXQogKiBgYGAKICovCkFXUy5DcmVkZW50aWFsUHJvdmlkZXJDaGFpbi5kZWZhdWx0UHJvdmlkZXJzID0gW107CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uYWRkUHJvbWlzZXNUb0NsYXNzID0gZnVuY3Rpb24gYWRkUHJvbWlzZXNUb0NsYXNzKFByb21pc2VEZXBlbmRlbmN5KSB7CiAgdGhpcy5wcm90b3R5cGUucmVzb2x2ZVByb21pc2UgPSBBV1MudXRpbC5wcm9taXNpZnlNZXRob2QoJ3Jlc29sdmUnLCBQcm9taXNlRGVwZW5kZW5jeSk7Cn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4uZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MgPSBmdW5jdGlvbiBkZWxldGVQcm9taXNlc0Zyb21DbGFzcygpIHsKICBkZWxldGUgdGhpcy5wcm90b3R5cGUucmVzb2x2ZVByb21pc2U7Cn07CgpBV1MudXRpbC5hZGRQcm9taXNlcyhBV1MuQ3JlZGVudGlhbFByb3ZpZGVyQ2hhaW4pOwoKfSx7Ii4uL2NvcmUiOjE5fV0sMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKCi8qKgogKiBSZXByZXNlbnRzIGNyZWRlbnRpYWxzIHJldHJpZXZlZCBmcm9tIFNUUyBTQU1MIHN1cHBvcnQuCiAqCiAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9IHNlcnZpY2Ugb3BlcmF0aW9uLiBUaGlzIG9wZXJhdGlvbgogKiByZXF1aXJlcyBhIGBSb2xlQXJuYCBjb250YWluaW5nIHRoZSBBUk4gb2YgdGhlIElBTSB0cnVzdCBwb2xpY3kgZm9yIHRoZQogKiBhcHBsaWNhdGlvbiBmb3Igd2hpY2ggY3JlZGVudGlhbHMgd2lsbCBiZSBnaXZlbiwgYXMgd2VsbCBhcyBhIGBQcmluY2lwYWxBcm5gCiAqIHJlcHJlc2VudGluZyB0aGUgQVJOIGZvciB0aGUgU0FNTCBpZGVudGl0eSBwcm92aWRlci4gSW4gYWRkaXRpb24sIHRoZQogKiBgU0FNTEFzc2VydGlvbmAgbXVzdCBiZSBzZXQgdG8gdGhlIHRva2VuIHByb3ZpZGVkIGJ5IHRoZSBpZGVudGl0eQogKiBwcm92aWRlci4gU2VlIHtjb25zdHJ1Y3Rvcn0gZm9yIGFuIGV4YW1wbGUgb24gY3JlYXRpbmcgYSBjcmVkZW50aWFscwogKiBvYmplY3Qgd2l0aCBwcm9wZXIgYFJvbGVBcm5gLCBgUHJpbmNpcGFsQXJuYCwgYW5kIGBTQU1MQXNzZXJ0aW9uYCB2YWx1ZXMuCiAqCiAqICMjIFJlZnJlc2hpbmcgQ3JlZGVudGlhbHMgZnJvbSBJZGVudGl0eSBTZXJ2aWNlCiAqCiAqIEluIGFkZGl0aW9uIHRvIEFXUyBjcmVkZW50aWFscyBleHBpcmluZyBhZnRlciBhIGdpdmVuIGFtb3VudCBvZiB0aW1lLCB0aGUKICogbG9naW4gdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgd2lsbCBhbHNvIGV4cGlyZS4gT25jZSB0aGlzIHRva2VuCiAqIGV4cGlyZXMsIGl0IHdpbGwgbm90IGJlIHVzYWJsZSB0byByZWZyZXNoIEFXUyBjcmVkZW50aWFscywgYW5kIGFub3RoZXIKICogdG9rZW4gd2lsbCBiZSBuZWVkZWQuIFRoZSBTREsgZG9lcyBub3QgbWFuYWdlIHJlZnJlc2hpbmcgb2YgdGhlIHRva2VuIHZhbHVlLAogKiBidXQgdGhpcyBjYW4gYmUgZG9uZSB0aHJvdWdoIGEgInJlZnJlc2ggdG9rZW4iIHN1cHBvcnRlZCBieSBtb3N0IGlkZW50aXR5CiAqIHByb3ZpZGVycy4gQ29uc3VsdCB0aGUgZG9jdW1lbnRhdGlvbiBmb3IgdGhlIGlkZW50aXR5IHByb3ZpZGVyIGZvciByZWZyZXNoaW5nCiAqIHRva2Vucy4gT25jZSB0aGUgcmVmcmVzaGVkIHRva2VuIGlzIGFjcXVpcmVkLCB5b3Ugc2hvdWxkIG1ha2Ugc3VyZSB0byB1cGRhdGUKICogdGhpcyBuZXcgdG9rZW4gaW4gdGhlIGNyZWRlbnRpYWxzIG9iamVjdCdzIHtwYXJhbXN9IHByb3BlcnR5LiBUaGUgZm9sbG93aW5nCiAqIGNvZGUgd2lsbCB1cGRhdGUgdGhlIFNBTUxBc3NlcnRpb24sIGFzc3VtaW5nIHlvdSBoYXZlIHJldHJpZXZlZCBhbiB1cGRhdGVkCiAqIHRva2VuIGZyb20gdGhlIGlkZW50aXR5IHByb3ZpZGVyOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIEFXUy5jb25maWcuY3JlZGVudGlhbHMucGFyYW1zLlNBTUxBc3NlcnRpb24gPSB1cGRhdGVkVG9rZW47CiAqIGBgYAogKgogKiBGdXR1cmUgY2FsbHMgdG8gYGNyZWRlbnRpYWxzLnJlZnJlc2goKWAgd2lsbCBub3cgdXNlIHRoZSBuZXcgdG9rZW4uCiAqCiAqIEAhYXR0cmlidXRlIHBhcmFtcwogKiAgIEByZXR1cm4gW21hcF0gdGhlIG1hcCBvZiBwYXJhbXMgcGFzc2VkIHRvCiAqICAgICB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUx9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAqICAgICBgcGFyYW1zLlNBTUxBc3NlcnRpb25gIHByb3BlcnR5LgogKi8KQVdTLlNBTUxDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICogQHBhcmFtIChzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFNBTUwpCiAgICogQGV4YW1wbGUgQ3JlYXRpbmcgYSBuZXcgY3JlZGVudGlhbHMgb2JqZWN0CiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5TQU1MQ3JlZGVudGlhbHMoewogICAqICAgICBSb2xlQXJuOiAnYXJuOmF3czppYW06OjEyMzQ1Njc4OTA6cm9sZS9TQU1MUm9sZScsCiAgICogICAgIFByaW5jaXBhbEFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvU0FNTFByaW5jaXBhbCcsCiAgICogICAgIFNBTUxBc3NlcnRpb246ICdiYXNlNjQtdG9rZW4nLCAvLyBiYXNlNjQtZW5jb2RlZCB0b2tlbiBmcm9tIElkUAogICAqICAgfSk7CiAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGVXaXRoU0FNTAogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTQU1MQ3JlZGVudGlhbHMocGFyYW1zKSB7CiAgICBBV1MuQ3JlZGVudGlhbHMuY2FsbCh0aGlzKTsKICAgIHRoaXMuZXhwaXJlZCA9IHRydWU7CiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICB9LAoKICAvKioKICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhTQU1MfQogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVycikKICAgKiAgIENhbGxlZCB3aGVuIHRoZSBTVFMgc2VydmljZSByZXNwb25kcyAob3IgZmFpbHMpLiBXaGVuCiAgICogICB0aGlzIGNhbGxiYWNrIGlzIGNhbGxlZCB3aXRoIG5vIGVycm9yLCBpdCBtZWFucyB0aGF0IHRoZSBjcmVkZW50aWFscwogICAqICAgaW5mb3JtYXRpb24gaGFzIGJlZW4gbG9hZGVkIGludG8gdGhlIG9iamVjdCAoYXMgdGhlIGBhY2Nlc3NLZXlJZGAsCiAgICogICBgc2VjcmV0QWNjZXNzS2V5YCwgYW5kIGBzZXNzaW9uVG9rZW5gIHByb3BlcnRpZXMpLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGlmIGFuIGVycm9yIG9jY3VycmVkLCB0aGlzIHZhbHVlIHdpbGwgYmUgZmlsbGVkCiAgICogQHNlZSBnZXQKICAgKi8KICByZWZyZXNoOiBmdW5jdGlvbiByZWZyZXNoKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZDogZnVuY3Rpb24gbG9hZChjYWxsYmFjaykgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5jcmVhdGVDbGllbnRzKCk7CiAgICBzZWxmLnNlcnZpY2UuYXNzdW1lUm9sZVdpdGhTQU1MKGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgaWYgKCFlcnIpIHsKICAgICAgICBzZWxmLnNlcnZpY2UuY3JlZGVudGlhbHNGcm9tKGRhdGEsIHNlbGYpOwogICAgICB9CiAgICAgIGNhbGxiYWNrKGVycik7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjcmVhdGVDbGllbnRzOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc2VydmljZSA9IHRoaXMuc2VydmljZSB8fCBuZXcgU1RTKHtwYXJhbXM6IHRoaXMucGFyYW1zfSk7CiAgfQoKfSk7Cgp9LHsiLi4vLi4vY2xpZW50cy9zdHMiOjgsIi4uL2NvcmUiOjE5fV0sMjU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgU1RTID0gcmVxdWlyZSgnLi4vLi4vY2xpZW50cy9zdHMnKTsKCi8qKgogKiBSZXByZXNlbnRzIHRlbXBvcmFyeSBjcmVkZW50aWFscyByZXRyaWV2ZWQgZnJvbSB7QVdTLlNUU30uIFdpdGhvdXQgYW55CiAqIGV4dHJhIHBhcmFtZXRlcnMsIGNyZWRlbnRpYWxzIHdpbGwgYmUgZmV0Y2hlZCBmcm9tIHRoZQogKiB7QVdTLlNUUy5nZXRTZXNzaW9uVG9rZW59IG9wZXJhdGlvbi4gSWYgYW4gSUFNIHJvbGUgaXMgcHJvdmlkZWQsIHRoZQogKiB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcGVyYXRpb24gd2lsbCBiZSB1c2VkIHRvIGZldGNoIGNyZWRlbnRpYWxzIGZvciB0aGUKICogcm9sZSBpbnN0ZWFkLgogKgogKiBAbm90ZSBBV1MuVGVtcG9yYXJ5Q3JlZGVudGlhbHMgaXMgZGVwcmVjYXRlZCwgYnV0IHJlbWFpbnMgYXZhaWxhYmxlIGZvcgogKiAgIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LiB7QVdTLkNoYWluYWJsZVRlbXBvcmFyeUNyZWRlbnRpYWxzfSBpcyB0aGUKICogICBwcmVmZXJyZWQgY2xhc3MgZm9yIHRlbXBvcmFyeSBjcmVkZW50aWFscy4KICoKICogVG8gc2V0dXAgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLCBjb25maWd1cmUgYSBzZXQgb2YgbWFzdGVyIGNyZWRlbnRpYWxzCiAqIHVzaW5nIHRoZSBzdGFuZGFyZCBjcmVkZW50aWFscyBwcm92aWRlcnMgKGVudmlyb25tZW50LCBFQzIgaW5zdGFuY2UgbWV0YWRhdGEsCiAqIG9yIGZyb20gdGhlIGZpbGVzeXN0ZW0pLCB0aGVuIHNldCB0aGUgZ2xvYmFsIGNyZWRlbnRpYWxzIHRvIGEgbmV3CiAqIHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3Q6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogLy8gTm90ZSB0aGF0IGVudmlyb25tZW50IGNyZWRlbnRpYWxzIGFyZSBsb2FkZWQgYnkgZGVmYXVsdCwKICogLy8gdGhlIGZvbGxvd2luZyBsaW5lIGlzIHNob3duIGZvciBjbGFyaXR5OgogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5FbnZpcm9ubWVudENyZWRlbnRpYWxzKCdBV1MnKTsKICoKICogLy8gTm93IHNldCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgc2VlZGVkIGZyb20gdGhlIG1hc3RlciBjcmVkZW50aWFscwogKiBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogKgogKiAvLyBzdWJzZXF1ZW50IHJlcXVlc3RzIHdpbGwgbm93IHVzZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogKiBuZXcgQVdTLlMzKCkubGlzdEJ1Y2tldChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogKiBgYGAKICoKICogQCFhdHRyaWJ1dGUgbWFzdGVyQ3JlZGVudGlhbHMKICogICBAcmV0dXJuIFtBV1MuQ3JlZGVudGlhbHNdIHRoZSBtYXN0ZXIgKG5vbi10ZW1wb3JhcnkpIGNyZWRlbnRpYWxzIHVzZWQgdG8KICogICAgIGdldCBhbmQgcmVmcmVzaCB0ZW1wb3JhcnkgY3JlZGVudGlhbHMgZnJvbSBBV1MgU1RTLgogKiBAbm90ZSAoc2VlIGNvbnN0cnVjdG9yKQogKi8KQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzID0gQVdTLnV0aWwuaW5oZXJpdChBV1MuQ3JlZGVudGlhbHMsIHsKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHRlbXBvcmFyeSBjcmVkZW50aWFscyBvYmplY3QuCiAgICoKICAgKiBAbm90ZSBJbiBvcmRlciB0byBjcmVhdGUgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzLCB5b3UgZmlyc3QgbmVlZCB0byBoYXZlCiAgICogICAibWFzdGVyIiBjcmVkZW50aWFscyBjb25maWd1cmVkIGluIHtBV1MuQ29uZmlnLmNyZWRlbnRpYWxzfS4gVGhlc2UKICAgKiAgIG1hc3RlciBjcmVkZW50aWFscyBhcmUgbmVjZXNzYXJ5IHRvIHJldHJpZXZlIHRoZSB0ZW1wb3JhcnkgY3JlZGVudGlhbHMsCiAgICogICBhcyB3ZWxsIGFzIHJlZnJlc2ggdGhlIGNyZWRlbnRpYWxzIHdoZW4gdGhleSBleHBpcmUuCiAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBvcHRpb25zIHRoYXQgYXJlIHBhc3NlZCB0byB0aGUKICAgKiAgIHtBV1MuU1RTLmFzc3VtZVJvbGV9IG9yIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0gb3BlcmF0aW9ucy4KICAgKiAgIElmIGEgYFJvbGVBcm5gIHBhcmFtZXRlciBpcyBwYXNzZWQgaW4sIGNyZWRlbnRpYWxzIHdpbGwgYmUgYmFzZWQgb24gdGhlCiAgICogICBJQU0gcm9sZS4KICAgKiBAcGFyYW0gbWFzdGVyQ3JlZGVudGlhbHMgW0FXUy5DcmVkZW50aWFsc10gdGhlIG1hc3RlciAobm9uLXRlbXBvcmFyeSkgY3JlZGVudGlhbHMKICAgKiAgdXNlZCB0byBnZXQgYW5kIHJlZnJlc2ggdGVtcG9yYXJ5IGNyZWRlbnRpYWxzIGZyb20gQVdTIFNUUy4KICAgKiBAZXhhbXBsZSBDcmVhdGluZyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QgZm9yIGdlbmVyaWMgdGVtcG9yYXJ5IGNyZWRlbnRpYWxzCiAgICogICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscygpOwogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdCBmb3IgYW4gSUFNIHJvbGUKICAgKiAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKHsKICAgKiAgICAgUm9sZUFybjogJ2Fybjphd3M6aWFtOjoxMjM0NTY3ODkwOnJvbGUvVGVtcG9yYXJ5Q3JlZGVudGlhbHMnLAogICAqICAgfSk7CiAgICogQHNlZSBBV1MuU1RTLmFzc3VtZVJvbGUKICAgKiBAc2VlIEFXUy5TVFMuZ2V0U2Vzc2lvblRva2VuCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFRlbXBvcmFyeUNyZWRlbnRpYWxzKHBhcmFtcywgbWFzdGVyQ3JlZGVudGlhbHMpIHsKICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgdGhpcy5sb2FkTWFzdGVyQ3JlZGVudGlhbHMobWFzdGVyQ3JlZGVudGlhbHMpOwogICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKCiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcyB8fCB7fTsKICAgIGlmICh0aGlzLnBhcmFtcy5Sb2xlQXJuKSB7CiAgICAgIHRoaXMucGFyYW1zLlJvbGVTZXNzaW9uTmFtZSA9CiAgICAgICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd0ZW1wb3JhcnktY3JlZGVudGlhbHMnOwogICAgfQogIH0sCgogIC8qKgogICAqIFJlZnJlc2hlcyBjcmVkZW50aWFscyB1c2luZyB7QVdTLlNUUy5hc3N1bWVSb2xlfSBvcgogICAqIHtBV1MuU1RTLmdldFNlc3Npb25Ub2tlbn0sIGRlcGVuZGluZyBvbiB3aGV0aGVyIGFuIElBTSByb2xlIEFSTiB3YXMgcGFzc2VkCiAgICogdG8gdGhlIGNyZWRlbnRpYWxzIHtjb25zdHJ1Y3Rvcn0uCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyKQogICAqICAgQ2FsbGVkIHdoZW4gdGhlIFNUUyBzZXJ2aWNlIHJlc3BvbmRzIChvciBmYWlscykuIFdoZW4KICAgKiAgIHRoaXMgY2FsbGJhY2sgaXMgY2FsbGVkIHdpdGggbm8gZXJyb3IsIGl0IG1lYW5zIHRoYXQgdGhlIGNyZWRlbnRpYWxzCiAgICogICBpbmZvcm1hdGlvbiBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgb2JqZWN0IChhcyB0aGUgYGFjY2Vzc0tleUlkYCwKICAgKiAgIGBzZWNyZXRBY2Nlc3NLZXlgLCBhbmQgYHNlc3Npb25Ub2tlbmAgcHJvcGVydGllcykuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gaWYgYW4gZXJyb3Igb2NjdXJyZWQsIHRoaXMgdmFsdWUgd2lsbCBiZSBmaWxsZWQKICAgKiBAc2VlIGdldAogICAqLwogIHJlZnJlc2g6IGZ1bmN0aW9uIHJlZnJlc2ggKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNvYWxlc2NlUmVmcmVzaChjYWxsYmFjayB8fCBBV1MudXRpbC5mbi5jYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZDogZnVuY3Rpb24gbG9hZCAoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgc2VsZi5tYXN0ZXJDcmVkZW50aWFscy5nZXQoZnVuY3Rpb24gKCkgewogICAgICBzZWxmLnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzID0gc2VsZi5tYXN0ZXJDcmVkZW50aWFsczsKICAgICAgdmFyIG9wZXJhdGlvbiA9IHNlbGYucGFyYW1zLlJvbGVBcm4gPwogICAgICAgIHNlbGYuc2VydmljZS5hc3N1bWVSb2xlIDogc2VsZi5zZXJ2aWNlLmdldFNlc3Npb25Ub2tlbjsKICAgICAgb3BlcmF0aW9uLmNhbGwoc2VsZi5zZXJ2aWNlLCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKCFlcnIpIHsKICAgICAgICAgIHNlbGYuc2VydmljZS5jcmVkZW50aWFsc0Zyb20oZGF0YSwgc2VsZik7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrKGVycik7CiAgICAgIH0pOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgbG9hZE1hc3RlckNyZWRlbnRpYWxzOiBmdW5jdGlvbiBsb2FkTWFzdGVyQ3JlZGVudGlhbHMgKG1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICB0aGlzLm1hc3RlckNyZWRlbnRpYWxzID0gbWFzdGVyQ3JlZGVudGlhbHMgfHwgQVdTLmNvbmZpZy5jcmVkZW50aWFsczsKICAgIHdoaWxlICh0aGlzLm1hc3RlckNyZWRlbnRpYWxzLm1hc3RlckNyZWRlbnRpYWxzKSB7CiAgICAgIHRoaXMubWFzdGVyQ3JlZGVudGlhbHMgPSB0aGlzLm1hc3RlckNyZWRlbnRpYWxzLm1hc3RlckNyZWRlbnRpYWxzOwogICAgfQoKICAgIGlmICh0eXBlb2YgdGhpcy5tYXN0ZXJDcmVkZW50aWFscy5nZXQgIT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5tYXN0ZXJDcmVkZW50aWFscyA9IG5ldyBBV1MuQ3JlZGVudGlhbHModGhpcy5tYXN0ZXJDcmVkZW50aWFscyk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24gKCkgewogICAgdGhpcy5zZXJ2aWNlID0gdGhpcy5zZXJ2aWNlIHx8IG5ldyBTVFMoe3BhcmFtczogdGhpcy5wYXJhbXN9KTsKICB9Cgp9KTsKCn0seyIuLi8uLi9jbGllbnRzL3N0cyI6OCwiLi4vY29yZSI6MTl9XSwyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBTVFMgPSByZXF1aXJlKCcuLi8uLi9jbGllbnRzL3N0cycpOwoKLyoqCiAqIFJlcHJlc2VudHMgY3JlZGVudGlhbHMgcmV0cmlldmVkIGZyb20gU1RTIFdlYiBJZGVudGl0eSBGZWRlcmF0aW9uIHN1cHBvcnQuCiAqCiAqIEJ5IGRlZmF1bHQgdGhpcyBwcm92aWRlciBnZXRzIGNyZWRlbnRpYWxzIHVzaW5nIHRoZQogKiB7QVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fSBzZXJ2aWNlIG9wZXJhdGlvbi4gVGhpcyBvcGVyYXRpb24KICogcmVxdWlyZXMgYSBgUm9sZUFybmAgY29udGFpbmluZyB0aGUgQVJOIG9mIHRoZSBJQU0gdHJ1c3QgcG9saWN5IGZvciB0aGUKICogYXBwbGljYXRpb24gZm9yIHdoaWNoIGNyZWRlbnRpYWxzIHdpbGwgYmUgZ2l2ZW4uIEluIGFkZGl0aW9uLCB0aGUKICogYFdlYklkZW50aXR5VG9rZW5gIG11c3QgYmUgc2V0IHRvIHRoZSB0b2tlbiBwcm92aWRlZCBieSB0aGUgaWRlbnRpdHkKICogcHJvdmlkZXIuIFNlZSB7Y29uc3RydWN0b3J9IGZvciBhbiBleGFtcGxlIG9uIGNyZWF0aW5nIGEgY3JlZGVudGlhbHMKICogb2JqZWN0IHdpdGggcHJvcGVyIGBSb2xlQXJuYCBhbmQgYFdlYklkZW50aXR5VG9rZW5gIHZhbHVlcy4KICoKICogIyMgUmVmcmVzaGluZyBDcmVkZW50aWFscyBmcm9tIElkZW50aXR5IFNlcnZpY2UKICoKICogSW4gYWRkaXRpb24gdG8gQVdTIGNyZWRlbnRpYWxzIGV4cGlyaW5nIGFmdGVyIGEgZ2l2ZW4gYW1vdW50IG9mIHRpbWUsIHRoZQogKiBsb2dpbiB0b2tlbiBmcm9tIHRoZSBpZGVudGl0eSBwcm92aWRlciB3aWxsIGFsc28gZXhwaXJlLiBPbmNlIHRoaXMgdG9rZW4KICogZXhwaXJlcywgaXQgd2lsbCBub3QgYmUgdXNhYmxlIHRvIHJlZnJlc2ggQVdTIGNyZWRlbnRpYWxzLCBhbmQgYW5vdGhlcgogKiB0b2tlbiB3aWxsIGJlIG5lZWRlZC4gVGhlIFNESyBkb2VzIG5vdCBtYW5hZ2UgcmVmcmVzaGluZyBvZiB0aGUgdG9rZW4gdmFsdWUsCiAqIGJ1dCB0aGlzIGNhbiBiZSBkb25lIHRocm91Z2ggYSAicmVmcmVzaCB0b2tlbiIgc3VwcG9ydGVkIGJ5IG1vc3QgaWRlbnRpdHkKICogcHJvdmlkZXJzLiBDb25zdWx0IHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgaWRlbnRpdHkgcHJvdmlkZXIgZm9yIHJlZnJlc2hpbmcKICogdG9rZW5zLiBPbmNlIHRoZSByZWZyZXNoZWQgdG9rZW4gaXMgYWNxdWlyZWQsIHlvdSBzaG91bGQgbWFrZSBzdXJlIHRvIHVwZGF0ZQogKiB0aGlzIG5ldyB0b2tlbiBpbiB0aGUgY3JlZGVudGlhbHMgb2JqZWN0J3Mge3BhcmFtc30gcHJvcGVydHkuIFRoZSBmb2xsb3dpbmcKICogY29kZSB3aWxsIHVwZGF0ZSB0aGUgV2ViSWRlbnRpdHlUb2tlbiwgYXNzdW1pbmcgeW91IGhhdmUgcmV0cmlldmVkIGFuIHVwZGF0ZWQKICogdG9rZW4gZnJvbSB0aGUgaWRlbnRpdHkgcHJvdmlkZXI6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogQVdTLmNvbmZpZy5jcmVkZW50aWFscy5wYXJhbXMuV2ViSWRlbnRpdHlUb2tlbiA9IHVwZGF0ZWRUb2tlbjsKICogYGBgCiAqCiAqIEZ1dHVyZSBjYWxscyB0byBgY3JlZGVudGlhbHMucmVmcmVzaCgpYCB3aWxsIG5vdyB1c2UgdGhlIG5ldyB0b2tlbi4KICoKICogQCFhdHRyaWJ1dGUgcGFyYW1zCiAqICAgQHJldHVybiBbbWFwXSB0aGUgbWFwIG9mIHBhcmFtcyBwYXNzZWQgdG8KICogICAgIHtBV1MuU1RTLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHl9LiBUbyB1cGRhdGUgdGhlIHRva2VuLCBzZXQgdGhlCiAqICAgICBgcGFyYW1zLldlYklkZW50aXR5VG9rZW5gIHByb3BlcnR5LgogKiBAIWF0dHJpYnV0ZSBkYXRhCiAqICAgQHJldHVybiBbbWFwXSB0aGUgcmF3IGRhdGEgcmVzcG9uc2UgZnJvbSB0aGUgY2FsbCB0bwogKiAgICAge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0uIFVzZSB0aGlzIGlmIHlvdSB3YW50IHRvIGdldAogKiAgICAgYWNjZXNzIHRvIG90aGVyIHByb3BlcnRpZXMgZnJvbSB0aGUgcmVzcG9uc2UuCiAqLwpBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyA9IEFXUy51dGlsLmluaGVyaXQoQVdTLkNyZWRlbnRpYWxzLCB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBjcmVkZW50aWFscyBvYmplY3QuCiAgICogQHBhcmFtIChzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KQogICAqIEBleGFtcGxlIENyZWF0aW5nIGEgbmV3IGNyZWRlbnRpYWxzIG9iamVjdAogICAqICAgQVdTLmNvbmZpZy5jcmVkZW50aWFscyA9IG5ldyBBV1MuV2ViSWRlbnRpdHlDcmVkZW50aWFscyh7CiAgICogICAgIFJvbGVBcm46ICdhcm46YXdzOmlhbTo6MTIzNDU2Nzg5MDpyb2xlL1dlYklkZW50aXR5JywKICAgKiAgICAgV2ViSWRlbnRpdHlUb2tlbjogJ0FCQ0RFRkdISUpLTE1OT1AnLCAvLyB0b2tlbiBmcm9tIGlkZW50aXR5IHNlcnZpY2UKICAgKiAgICAgUm9sZVNlc3Npb25OYW1lOiAnd2ViJyAvLyBvcHRpb25hbCBuYW1lLCBkZWZhdWx0cyB0byB3ZWItaWRlbnRpdHkKICAgKiAgIH0sIHsKICAgKiAgICAgLy8gb3B0aW9uYWxseSBwcm92aWRlIGNvbmZpZ3VyYXRpb24gdG8gYXBwbHkgdG8gdGhlIHVuZGVybHlpbmcgQVdTLlNUUyBzZXJ2aWNlIGNsaWVudAogICAqICAgICAvLyBpZiBjb25maWd1cmF0aW9uIGlzIG5vdCBwcm92aWRlZCwgdGhlbiBjb25maWd1cmF0aW9uIHdpbGwgYmUgcHVsbGVkIGZyb20gQVdTLmNvbmZpZwogICAqCiAgICogICAgIC8vIHNwZWNpZnkgdGltZW91dCBvcHRpb25zCiAgICogICAgIGh0dHBPcHRpb25zOiB7CiAgICogICAgICAgdGltZW91dDogMTAwCiAgICogICAgIH0KICAgKiAgIH0pOwogICAqIEBzZWUgQVdTLlNUUy5hc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5CiAgICogQHNlZSBBV1MuQ29uZmlnCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFdlYklkZW50aXR5Q3JlZGVudGlhbHMocGFyYW1zLCBjbGllbnRDb25maWcpIHsKICAgIEFXUy5DcmVkZW50aWFscy5jYWxsKHRoaXMpOwogICAgdGhpcy5leHBpcmVkID0gdHJ1ZTsKICAgIHRoaXMucGFyYW1zID0gcGFyYW1zOwogICAgdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lID0gdGhpcy5wYXJhbXMuUm9sZVNlc3Npb25OYW1lIHx8ICd3ZWItaWRlbnRpdHknOwogICAgdGhpcy5kYXRhID0gbnVsbDsKICAgIHRoaXMuX2NsaWVudENvbmZpZyA9IEFXUy51dGlsLmNvcHkoY2xpZW50Q29uZmlnIHx8IHt9KTsKICB9LAoKICAvKioKICAgKiBSZWZyZXNoZXMgY3JlZGVudGlhbHMgdXNpbmcge0FXUy5TVFMuYXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eX0KICAgKgogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIpCiAgICogICBDYWxsZWQgd2hlbiB0aGUgU1RTIHNlcnZpY2UgcmVzcG9uZHMgKG9yIGZhaWxzKS4gV2hlbgogICAqICAgdGhpcyBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBubyBlcnJvciwgaXQgbWVhbnMgdGhhdCB0aGUgY3JlZGVudGlhbHMKICAgKiAgIGluZm9ybWF0aW9uIGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBvYmplY3QgKGFzIHRoZSBgYWNjZXNzS2V5SWRgLAogICAqICAgYHNlY3JldEFjY2Vzc0tleWAsIGFuZCBgc2Vzc2lvblRva2VuYCBwcm9wZXJ0aWVzKS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSBpZiBhbiBlcnJvciBvY2N1cnJlZCwgdGhpcyB2YWx1ZSB3aWxsIGJlIGZpbGxlZAogICAqIEBzZWUgZ2V0CiAgICovCiAgcmVmcmVzaDogZnVuY3Rpb24gcmVmcmVzaChjYWxsYmFjaykgewogICAgdGhpcy5jb2FsZXNjZVJlZnJlc2goY2FsbGJhY2sgfHwgQVdTLnV0aWwuZm4uY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGxvYWQ6IGZ1bmN0aW9uIGxvYWQoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY3JlYXRlQ2xpZW50cygpOwogICAgc2VsZi5zZXJ2aWNlLmFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHkoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICBzZWxmLmRhdGEgPSBudWxsOwogICAgICBpZiAoIWVycikgewogICAgICAgIHNlbGYuZGF0YSA9IGRhdGE7CiAgICAgICAgc2VsZi5zZXJ2aWNlLmNyZWRlbnRpYWxzRnJvbShkYXRhLCBzZWxmKTsKICAgICAgfQogICAgICBjYWxsYmFjayhlcnIpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY3JlYXRlQ2xpZW50czogZnVuY3Rpb24oKSB7CiAgICBpZiAoIXRoaXMuc2VydmljZSkgewogICAgICB2YXIgc3RzQ29uZmlnID0gQVdTLnV0aWwubWVyZ2Uoe30sIHRoaXMuX2NsaWVudENvbmZpZyk7CiAgICAgIHN0c0NvbmZpZy5wYXJhbXMgPSB0aGlzLnBhcmFtczsKICAgICAgdGhpcy5zZXJ2aWNlID0gbmV3IFNUUyhzdHNDb25maWcpOwogICAgfQogIH0KCn0pOwoKfSx7Ii4uLy4uL2NsaWVudHMvc3RzIjo4LCIuLi9jb3JlIjoxOX1dLDI3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKdmFyIGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnMgPSBbJ0FXU19FTkFCTEVfRU5EUE9JTlRfRElTQ09WRVJZJywgJ0FXU19FTkRQT0lOVF9ESVNDT1ZFUllfRU5BQkxFRCddOwoKLyoqCiAqIEdlbmVyYXRlIGtleSAoZXhjZXB0IHJlc291cmNlcyBhbmQgb3BlcmF0aW9uIHBhcnQpIHRvIGluZGV4IHRoZSBlbmRwb2ludHMgaW4gdGhlIGNhY2hlCiAqIElmIGlucHV0IHNoYXBlIGhhcyBlbmRwb2ludGRpc2NvdmVyeWlkIHRyYWl0IHRoZW4gdXNlCiAqICAgYWNjZXNzS2V5ICsgb3BlcmF0aW9uICsgcmVzb3VyY2VzICsgcmVnaW9uICsgc2VydmljZSBhcyBjYWNoZSBrZXkKICogSWYgaW5wdXQgc2hhcGUgZG9lc24ndCBoYXZlIGVuZHBvaW50ZGlzY292ZXJ5aWQgdHJhaXQgdGhlbiB1c2UKICogICBhY2Nlc3NLZXkgKyByZWdpb24gKyBzZXJ2aWNlIGFzIGNhY2hlIGtleQogKiBAcmV0dXJuIFttYXA8U3RyaW5nLFN0cmluZz5dIG9iamVjdCB3aXRoIGtleXMgdG8gaW5kZXggZW5kcG9pbnRzLgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGdldENhY2hlS2V5KHJlcXVlc3QpIHsKICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICB2YXIgYXBpID0gc2VydmljZS5hcGkgfHwge307CiAgdmFyIG9wZXJhdGlvbnMgPSBhcGkub3BlcmF0aW9uczsKICB2YXIgaWRlbnRpZmllcnMgPSB7fTsKICBpZiAoc2VydmljZS5jb25maWcucmVnaW9uKSB7CiAgICBpZGVudGlmaWVycy5yZWdpb24gPSBzZXJ2aWNlLmNvbmZpZy5yZWdpb247CiAgfQogIGlmIChhcGkuc2VydmljZUlkKSB7CiAgICBpZGVudGlmaWVycy5zZXJ2aWNlSWQgPSBhcGkuc2VydmljZUlkOwogIH0KICBpZiAoc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQpIHsKICAgIGlkZW50aWZpZXJzLmFjY2Vzc0tleUlkID0gc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQ7CiAgfQogIHJldHVybiBpZGVudGlmaWVyczsKfQoKLyoqCiAqIFJlY3Vyc2l2ZSBoZWxwZXIgZm9yIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMoKS4KICogTG9va3MgZm9yIHJlcXVpcmVkIHN0cmluZyBpbnB1dCBtZW1iZXJzIHRoYXQgaGF2ZSAnZW5kcG9pbnRkaXNjb3ZlcnlpZCcgdHJhaXQuCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtcywgc2hhcGUpIHsKICBpZiAoIXNoYXBlIHx8IHBhcmFtcyA9PT0gdW5kZWZpbmVkIHx8IHBhcmFtcyA9PT0gbnVsbCkgcmV0dXJuOwogIGlmIChzaGFwZS50eXBlID09PSAnc3RydWN0dXJlJyAmJiBzaGFwZS5yZXF1aXJlZCAmJiBzaGFwZS5yZXF1aXJlZC5sZW5ndGggPiAwKSB7CiAgICB1dGlsLmFycmF5RWFjaChzaGFwZS5yZXF1aXJlZCwgZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW25hbWVdOwogICAgICBpZiAobWVtYmVyU2hhcGUuZW5kcG9pbnREaXNjb3ZlcnlJZCA9PT0gdHJ1ZSkgewogICAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBtZW1iZXJTaGFwZS5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlclNoYXBlLm5hbWUgOiBuYW1lOwogICAgICAgIHJlc3VsdFtsb2NhdGlvbk5hbWVdID0gU3RyaW5nKHBhcmFtc1tuYW1lXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWFyc2hhbGxDdXN0b21JZGVudGlmaWVyc0hlbHBlcihyZXN1bHQsIHBhcmFtc1tuYW1lXSwgbWVtYmVyU2hhcGUpOwogICAgICB9CiAgICB9KTsKICB9Cn0KCi8qKgogKiBHZXQgY3VzdG9tIGlkZW50aWZpZXJzIGZvciBjYWNoZSBrZXkuCiAqIElkZW50aWZpZXMgY3VzdG9tIGlkZW50aWZpZXJzIGJ5IGNoZWNraW5nIGVhY2ggc2hhcGUncyBgZW5kcG9pbnREaXNjb3ZlcnlJZGAgdHJhaXQuCiAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IG9iamVjdAogKiBAcGFyYW0gW29iamVjdF0gaW5wdXQgc2hhcGUgb2YgdGhlIGdpdmVuIG9wZXJhdGlvbidzIGFwaQogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgc2hhcGUpIHsKICB2YXIgaWRlbnRpZmllcnMgPSB7fTsKICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzSGVscGVyKGlkZW50aWZpZXJzLCByZXF1ZXN0LnBhcmFtcywgc2hhcGUpOwogIHJldHVybiBpZGVudGlmaWVyczsKfQoKLyoqCiAqIENhbGwgZW5kcG9pbnQgZGlzY292ZXJ5IG9wZXJhdGlvbiB3aGVuIGl0J3Mgb3B0aW9uYWwuCiAqIFdoZW4gZW5kcG9pbnQgaXMgYXZhaWxhYmxlIGluIGNhY2hlIHRoZW4gdXNlIHRoZSBjYWNoZWQgZW5kcG9pbnRzLiBJZiBlbmRwb2ludHMKICogYXJlIHVuYXZhaWxhYmxlIHRoZW4gdXNlIHJlZ2lvbmFsIGVuZHBvaW50cyBhbmQgY2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uCiAqIGFzeW5jaHJvbm91c2x5LiBUaGlzIGlzIHR1cm5lZCBvZmYgYnkgZGVmYXVsdC4KICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3Qgb2JqZWN0CiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gb3B0aW9uYWxEaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QpIHsKICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZTsKICB2YXIgYXBpID0gc2VydmljZS5hcGk7CiAgdmFyIG9wZXJhdGlvbk1vZGVsID0gYXBpLm9wZXJhdGlvbnMgPyBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0gOiB1bmRlZmluZWQ7CiAgdmFyIGlucHV0U2hhcGUgPSBvcGVyYXRpb25Nb2RlbCA/IG9wZXJhdGlvbk1vZGVsLmlucHV0IDogdW5kZWZpbmVkOwoKICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KHJlcXVlc3QpOwogIGlmIChPYmplY3Qua2V5cyhpZGVudGlmaWVycykubGVuZ3RoID4gMCkgewogICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgaWYgKG9wZXJhdGlvbk1vZGVsKSBjYWNoZUtleS5vcGVyYXRpb24gPSBvcGVyYXRpb25Nb2RlbC5uYW1lOwogIH0KICB2YXIgZW5kcG9pbnRzID0gQVdTLmVuZHBvaW50Q2FjaGUuZ2V0KGNhY2hlS2V5KTsKICBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPT09IDEgJiYgZW5kcG9pbnRzWzBdLkFkZHJlc3MgPT09ICcnKSB7CiAgICAvL2VuZHBvaW50IG9wZXJhdGlvbiBpcyBiZWluZyBtYWRlIGJ1dCByZXNwb25zZSBub3QgeWV0IHJlY2VpdmVkCiAgICAvL29yIGVuZHBvaW50IG9wZXJhdGlvbiBqdXN0IGZhaWxlZCBpbiAxIG1pbnV0ZQogICAgcmV0dXJuOwogIH0gZWxzZSBpZiAoZW5kcG9pbnRzICYmIGVuZHBvaW50cy5sZW5ndGggPiAwKSB7CiAgICAvL2ZvdW5kIGVuZHBvaW50IHJlY29yZCBmcm9tIGNhY2hlCiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LnVwZGF0ZUVuZHBvaW50KGVuZHBvaW50c1swXS5BZGRyZXNzKTsKICB9IGVsc2UgewogICAgLy9lbmRwb2ludCByZWNvcmQgbm90IGluIGNhY2hlIG9yIG91dGRhdGVkLiBtYWtlIGRpc2NvdmVyeSBvcGVyYXRpb24KICAgIHZhciBlbmRwb2ludFJlcXVlc3QgPSBzZXJ2aWNlLm1ha2VSZXF1ZXN0KGFwaS5lbmRwb2ludE9wZXJhdGlvbiwgewogICAgICBPcGVyYXRpb246IG9wZXJhdGlvbk1vZGVsLm5hbWUsCiAgICAgIElkZW50aWZpZXJzOiBpZGVudGlmaWVycywKICAgIH0pOwogICAgYWRkQXBpVmVyc2lvbkhlYWRlcihlbmRwb2ludFJlcXVlc3QpOwogICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgZW5kcG9pbnRSZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdyZXRyeScsIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlJFVFJZX0NIRUNLKTsKICAgIC8vcHV0IGluIGEgcGxhY2Vob2xkZXIgZm9yIGVuZHBvaW50cyBhbHJlYWR5IHJlcXVlc3RlZCwgcHJldmVudAogICAgLy90b28gbXVjaCBpbi1mbGlnaHQgY2FsbHMKICAgIEFXUy5lbmRwb2ludENhY2hlLnB1dChjYWNoZUtleSwgW3sKICAgICAgQWRkcmVzczogJycsCiAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiAxCiAgICB9XSk7CiAgICBlbmRwb2ludFJlcXVlc3Quc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgaWYgKGRhdGEgJiYgZGF0YS5FbmRwb2ludHMpIHsKICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIGRhdGEuRW5kcG9pbnRzKTsKICAgICAgfSBlbHNlIGlmIChlcnIpIHsKICAgICAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXksIFt7CiAgICAgICAgICBBZGRyZXNzOiAnJywKICAgICAgICAgIENhY2hlUGVyaW9kSW5NaW51dGVzOiAxIC8vbm90IHRvIG1ha2UgbW9yZSBlbmRwb2ludCBvcGVyYXRpb24gaW4gbmV4dCAxIG1pbnV0ZQogICAgICAgIH1dKTsKICAgICAgfQogICAgfSk7CiAgfQp9Cgp2YXIgcmVxdWVzdFF1ZXVlID0ge307CgovKioKICogQ2FsbCBlbmRwb2ludCBkaXNjb3Zlcnkgb3BlcmF0aW9uIHdoZW4gaXQncyByZXF1aXJlZC4KICogV2hlbiBlbmRwb2ludCBpcyBhdmFpbGFibGUgaW4gY2FjaGUgdGhlbiB1c2UgY2FjaGVkIG9uZXMuIElmIGVuZHBvaW50cyBhcmUKICogdW5hdmFpbGFibGUgdGhlbiBTREsgc2hvdWxkIGNhbGwgZW5kcG9pbnQgb3BlcmF0aW9uIHRoZW4gdXNlIHJldHVybmVkIG5ldwogKiBlbmRwb2ludCBmb3IgdGhlIGFwaSBjYWxsLiBTREsgd2lsbCBhdXRvbWF0aWNhbGx5IGF0dGVtcHQgdG8gZG8gZW5kcG9pbnQKICogZGlzY292ZXJ5LiBUaGlzIGlzIHR1cm5lZCBvZmYgYnkgZGVmYXVsdAogKiBAcGFyYW0gW29iamVjdF0gcmVxdWVzdCBvYmplY3QKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCwgZG9uZSkgewogIHZhciBzZXJ2aWNlID0gcmVxdWVzdC5zZXJ2aWNlOwogIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9ucyA/IGFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSA6IHVuZGVmaW5lZDsKICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuaW5wdXQgOiB1bmRlZmluZWQ7CgogIHZhciBpZGVudGlmaWVycyA9IG1hcnNoYWxsQ3VzdG9tSWRlbnRpZmllcnMocmVxdWVzdCwgaW5wdXRTaGFwZSk7CiAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgaWYgKE9iamVjdC5rZXlzKGlkZW50aWZpZXJzKS5sZW5ndGggPiAwKSB7CiAgICBjYWNoZUtleSA9IHV0aWwudXBkYXRlKGNhY2hlS2V5LCBpZGVudGlmaWVycyk7CiAgICBpZiAob3BlcmF0aW9uTW9kZWwpIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbk1vZGVsLm5hbWU7CiAgfQogIHZhciBjYWNoZUtleVN0ciA9IEFXUy5FbmRwb2ludENhY2hlLmdldEtleVN0cmluZyhjYWNoZUtleSk7CiAgdmFyIGVuZHBvaW50cyA9IEFXUy5lbmRwb2ludENhY2hlLmdldChjYWNoZUtleVN0cik7IC8vZW5kcG9pbnQgY2FjaGUgYWxzbyBhY2NlcHRzIHN0cmluZyBrZXlzCiAgaWYgKGVuZHBvaW50cyAmJiBlbmRwb2ludHMubGVuZ3RoID09PSAxICYmIGVuZHBvaW50c1swXS5BZGRyZXNzID09PSAnJykgewogICAgLy9lbmRwb2ludCBvcGVyYXRpb24gaXMgYmVpbmcgbWFkZSBidXQgcmVzcG9uc2Ugbm90IHlldCByZWNlaXZlZAogICAgLy9wdXNoIHJlcXVlc3Qgb2JqZWN0IHRvIGEgcGVuZGluZyBxdWV1ZQogICAgaWYgKCFyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdID0gW107CiAgICByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdLnB1c2goe3JlcXVlc3Q6IHJlcXVlc3QsIGNhbGxiYWNrOiBkb25lfSk7CiAgICByZXR1cm47CiAgfSBlbHNlIGlmIChlbmRwb2ludHMgJiYgZW5kcG9pbnRzLmxlbmd0aCA+IDApIHsKICAgIHJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRzWzBdLkFkZHJlc3MpOwogICAgZG9uZSgpOwogIH0gZWxzZSB7CiAgICB2YXIgZW5kcG9pbnRSZXF1ZXN0ID0gc2VydmljZS5tYWtlUmVxdWVzdChhcGkuZW5kcG9pbnRPcGVyYXRpb24sIHsKICAgICAgT3BlcmF0aW9uOiBvcGVyYXRpb25Nb2RlbC5uYW1lLAogICAgICBJZGVudGlmaWVyczogaWRlbnRpZmllcnMsCiAgICB9KTsKICAgIGVuZHBvaW50UmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTKTsKICAgIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KTsKCiAgICAvL3B1dCBpbiBhIHBsYWNlaG9sZGVyIGZvciBlbmRwb2ludHMgYWxyZWFkeSByZXF1ZXN0ZWQsIHByZXZlbnQKICAgIC8vdG9vIG11Y2ggaW4tZmxpZ2h0IGNhbGxzCiAgICBBV1MuZW5kcG9pbnRDYWNoZS5wdXQoY2FjaGVLZXlTdHIsIFt7CiAgICAgIEFkZHJlc3M6ICcnLAogICAgICBDYWNoZVBlcmlvZEluTWludXRlczogNjAgLy9sb25nLWxpdmUgY2FjaGUKICAgIH1dKTsKICAgIGVuZHBvaW50UmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgcmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCB7IHJldHJ5YWJsZTogZmFsc2UgfSk7CiAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucmVtb3ZlKGNhY2hlS2V5KTsKCiAgICAgICAgLy9mYWlsIGFsbCB0aGUgcGVuZGluZyByZXF1ZXN0cyBpbiBiYXRjaAogICAgICAgIGlmIChyZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ1JlcXVlc3RzID0gcmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXTsKICAgICAgICAgIHV0aWwuYXJyYXlFYWNoKHBlbmRpbmdSZXF1ZXN0cywgZnVuY3Rpb24ocmVxdWVzdENvbnRleHQpIHsKICAgICAgICAgICAgcmVxdWVzdENvbnRleHQucmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IoZXJyLCB7IHJldHJ5YWJsZTogZmFsc2UgfSk7CiAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LmNhbGxiYWNrKCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGRlbGV0ZSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChkYXRhKSB7CiAgICAgICAgQVdTLmVuZHBvaW50Q2FjaGUucHV0KGNhY2hlS2V5U3RyLCBkYXRhLkVuZHBvaW50cyk7CiAgICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC51cGRhdGVFbmRwb2ludChkYXRhLkVuZHBvaW50c1swXS5BZGRyZXNzKTsKCiAgICAgICAgLy91cGRhdGUgdGhlIGVuZHBvaW50IGZvciBhbGwgdGhlIHBlbmRpbmcgcmVxdWVzdHMgaW4gYmF0Y2gKICAgICAgICBpZiAocmVxdWVzdFF1ZXVlW2NhY2hlS2V5U3RyXSkgewogICAgICAgICAgdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IHJlcXVlc3RRdWV1ZVtjYWNoZUtleVN0cl07CiAgICAgICAgICB1dGlsLmFycmF5RWFjaChwZW5kaW5nUmVxdWVzdHMsIGZ1bmN0aW9uKHJlcXVlc3RDb250ZXh0KSB7CiAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LnJlcXVlc3QuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQoZGF0YS5FbmRwb2ludHNbMF0uQWRkcmVzcyk7CiAgICAgICAgICAgIHJlcXVlc3RDb250ZXh0LmNhbGxiYWNrKCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGRlbGV0ZSByZXF1ZXN0UXVldWVbY2FjaGVLZXlTdHJdOwogICAgICAgIH0KICAgICAgfQogICAgICBkb25lKCk7CiAgICB9KTsKICB9Cn0KCi8qKgogKiBhZGQgYXBpIHZlcnNpb24gaGVhZGVyIHRvIGVuZHBvaW50IG9wZXJhdGlvbgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGFkZEFwaVZlcnNpb25IZWFkZXIoZW5kcG9pbnRSZXF1ZXN0KSB7CiAgdmFyIGFwaSA9IGVuZHBvaW50UmVxdWVzdC5zZXJ2aWNlLmFwaTsKICB2YXIgYXBpVmVyc2lvbiA9IGFwaS5hcGlWZXJzaW9uOwogIGlmIChhcGlWZXJzaW9uICYmICFlbmRwb2ludFJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotYXBpLXZlcnNpb24nXSkgewogICAgZW5kcG9pbnRSZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LWFwaS12ZXJzaW9uJ10gPSBhcGlWZXJzaW9uOwogIH0KfQoKLyoqCiAqIElmIGFwaSBjYWxsIGdldHMgaW52YWxpZCBlbmRwb2ludCBleGNlcHRpb24sIFNESyBzaG91bGQgYXR0ZW1wdCB0byByZW1vdmUgdGhlIGludmFsaWQKICogZW5kcG9pbnQgZnJvbSBjYWNoZS4KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKHJlc3BvbnNlKSB7CiAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgdmFyIGh0dHBSZXNwb25zZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZTsKICBpZiAoZXJyb3IgJiYKICAgIChlcnJvci5jb2RlID09PSAnSW52YWxpZEVuZHBvaW50RXhjZXB0aW9uJyB8fCBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gNDIxKQogICkgewogICAgdmFyIHJlcXVlc3QgPSByZXNwb25zZS5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbnMgPSByZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICB2YXIgaW5wdXRTaGFwZSA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dID8gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0uaW5wdXQgOiB1bmRlZmluZWQ7CiAgICB2YXIgaWRlbnRpZmllcnMgPSBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzKHJlcXVlc3QsIGlucHV0U2hhcGUpOwogICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkocmVxdWVzdCk7CiAgICBpZiAoT2JqZWN0LmtleXMoaWRlbnRpZmllcnMpLmxlbmd0aCA+IDApIHsKICAgICAgY2FjaGVLZXkgPSB1dGlsLnVwZGF0ZShjYWNoZUtleSwgaWRlbnRpZmllcnMpOwogICAgICBpZiAob3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl0pIGNhY2hlS2V5Lm9wZXJhdGlvbiA9IG9wZXJhdGlvbnNbcmVxdWVzdC5vcGVyYXRpb25dLm5hbWU7CiAgICB9CiAgICBBV1MuZW5kcG9pbnRDYWNoZS5yZW1vdmUoY2FjaGVLZXkpOwogIH0KfQoKLyoqCiAqIElmIGVuZHBvaW50IGlzIGV4cGxpY2l0bHkgY29uZmlndXJlZCwgU0RLIHNob3VsZCBub3QgZG8gZW5kcG9pbnQgZGlzY292ZXJ5IGluIGFueXRpbWUuCiAqIEBwYXJhbSBbb2JqZWN0XSBjbGllbnQgU2VydmljZSBjbGllbnQgb2JqZWN0LgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGhhc0N1c3RvbUVuZHBvaW50KGNsaWVudCkgewogIC8vaWYgc2V0IGVuZHBvaW50IGlzIHNldCBmb3Igc3BlY2lmaWMgY2xpZW50LCBlbmFibGUgZW5kcG9pbnQgZGlzY292ZXJ5IHdpbGwgcmFpc2UgYW4gZXJyb3IuCiAgaWYgKGNsaWVudC5fb3JpZ2luYWxDb25maWcgJiYgY2xpZW50Ll9vcmlnaW5hbENvbmZpZy5lbmRwb2ludCAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCA9PT0gdHJ1ZSkgewogICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgIG1lc3NhZ2U6ICdDdXN0b20gZW5kcG9pbnQgaXMgc3VwcGxpZWQ7IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCBtdXN0IG5vdCBiZSB0cnVlLicKICAgIH0pOwogIH07CiAgdmFyIHN2Y0NvbmZpZyA9IEFXUy5jb25maWdbY2xpZW50LnNlcnZpY2VJZGVudGlmaWVyXSB8fCB7fTsKICByZXR1cm4gQm9vbGVhbihBV1MuY29uZmlnLmVuZHBvaW50IHx8IHN2Y0NvbmZpZy5lbmRwb2ludCB8fCAoY2xpZW50Ll9vcmlnaW5hbENvbmZpZyAmJiBjbGllbnQuX29yaWdpbmFsQ29uZmlnLmVuZHBvaW50KSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGlzRmFsc3kodmFsdWUpIHsKICByZXR1cm4gWydmYWxzZScsICcwJ10uaW5kZXhPZih2YWx1ZSkgPj0gMDsKfQoKLyoqCiAqIElmIGVuZHBvaW50IGRpc2NvdmVyeSBzaG91bGQgcGVyZm9ybSBmb3IgdGhpcyByZXF1ZXN0IHdoZW4gbm8gb3BlcmF0aW9uIHJlcXVpcmVzIGVuZHBvaW50CiAqIGRpc2NvdmVyeSBmb3IgdGhlIGdpdmVuIHNlcnZpY2UuCiAqIFNESyBwZXJmb3JtcyBjb25maWcgcmVzb2x1dGlvbiBpbiBvcmRlciBsaWtlIGJlbG93OgogKiAxLiBJZiBzZXQgaW4gY2xpZW50IGNvbmZpZ3VyYXRpb24uCiAqIDIuIElmIHNldCBpbiBlbnYgQVdTX0VOQUJMRV9FTkRQT0lOVF9ESVNDT1ZFUlkuCiAqIDMuIElmIHNldCBpbiBzaGFyZWQgaW5pIGNvbmZpZyBmaWxlIHdpdGgga2V5ICdlbmRwb2ludF9kaXNjb3ZlcnlfZW5hYmxlZCcuCiAqIEBwYXJhbSBbb2JqZWN0XSByZXF1ZXN0IHJlcXVlc3Qgb2JqZWN0LgogKiBAcmV0dXJucyBbYm9vbGVhbnx1bmRlZmluZWRdIGlmIGVuZHBvaW50IGRpc2NvdmVyeSBjb25maWcgaXMgbm90IHNldCBpbiBhbnkgc291cmNlLCB0aGlzCiAqICBmdW5jdGlvbiByZXR1cm5zIHVuZGVmaW5lZAogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIHJlc29sdmVFbmRwb2ludERpc2NvdmVyeUNvbmZpZyhyZXF1ZXN0KSB7CiAgdmFyIHNlcnZpY2UgPSByZXF1ZXN0LnNlcnZpY2UgfHwge307CiAgaWYgKHNlcnZpY2UuY29uZmlnLmVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZCAhPT0gdW5kZWZpbmVkKSB7CiAgICByZXR1cm4gc2VydmljZS5jb25maWcuZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkOwogIH0KCiAgLy9zaGFyZWQgaW5pIGZpbGUgaXMgb25seSBhdmFpbGFibGUgaW4gTm9kZQogIC8vbm90IHRvIGNoZWNrIGVudiBpbiBicm93c2VyCiAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiB1bmRlZmluZWQ7CgogIC8vIElmIGFueSBvZiByZWNvZ25pemVkIGVuZHBvaW50IGRpc2NvdmVyeSBjb25maWcgZW52IGlzIHNldAogIGZvciAodmFyIGkgPSAwOyBpIDwgZW5kcG9pbnREaXNjb3ZlcnlFbmFibGVkRW52cy5sZW5ndGg7IGkrKykgewogICAgdmFyIGVudiA9IGVuZHBvaW50RGlzY292ZXJ5RW5hYmxlZEVudnNbaV07CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb2Nlc3MuZW52LCBlbnYpKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudltlbnZdID09PSAnJyB8fCBwcm9jZXNzLmVudltlbnZdID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBjb2RlOiAnQ29uZmlndXJhdGlvbkV4Y2VwdGlvbicsCiAgICAgICAgICBtZXNzYWdlOiAnZW52aXJvbm1lbnRhbCB2YXJpYWJsZSAnICsgZW52ICsgJyBjYW5ub3QgYmUgc2V0IHRvIG5vdGhpbmcnCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuICFpc0ZhbHN5KHByb2Nlc3MuZW52W2Vudl0pOwogICAgfQogIH0KCiAgdmFyIGNvbmZpZ0ZpbGUgPSB7fTsKICB0cnkgewogICAgY29uZmlnRmlsZSA9IEFXUy51dGlsLmluaUxvYWRlciA/IEFXUy51dGlsLmluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgIGlzQ29uZmlnOiB0cnVlLAogICAgICBmaWxlbmFtZTogcHJvY2Vzcy5lbnZbQVdTLnV0aWwuc2hhcmVkQ29uZmlnRmlsZUVudl0KICAgIH0pIDoge307CiAgfSBjYXRjaCAoZSkge30KICB2YXIgc2hhcmVkRmlsZUNvbmZpZyA9IGNvbmZpZ0ZpbGVbCiAgICBwcm9jZXNzLmVudi5BV1NfUFJPRklMRSB8fCBBV1MudXRpbC5kZWZhdWx0UHJvZmlsZQogIF0gfHwge307CiAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFyZWRGaWxlQ29uZmlnLCAnZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQnKSkgewogICAgaWYgKHNoYXJlZEZpbGVDb25maWcuZW5kcG9pbnRfZGlzY292ZXJ5X2VuYWJsZWQgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ0NvbmZpZ3VyYXRpb25FeGNlcHRpb24nLAogICAgICAgIG1lc3NhZ2U6ICdjb25maWcgZmlsZSBlbnRyeSBcJ2VuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkXCcgY2Fubm90IGJlIHNldCB0byBub3RoaW5nJwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiAhaXNGYWxzeShzaGFyZWRGaWxlQ29uZmlnLmVuZHBvaW50X2Rpc2NvdmVyeV9lbmFibGVkKTsKICB9CiAgcmV0dXJuIHVuZGVmaW5lZDsKfQoKLyoqCiAqIGF0dGFjaCBlbmRwb2ludCBkaXNjb3ZlcnkgbG9naWMgdG8gcmVxdWVzdCBvYmplY3QKICogQHBhcmFtIFtvYmplY3RdIHJlcXVlc3QKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBkaXNjb3ZlckVuZHBvaW50KHJlcXVlc3QsIGRvbmUpIHsKICB2YXIgc2VydmljZSA9IHJlcXVlc3Quc2VydmljZSB8fCB7fTsKICBpZiAoaGFzQ3VzdG9tRW5kcG9pbnQoc2VydmljZSkgfHwgcmVxdWVzdC5pc1ByZXNpZ25lZCgpKSByZXR1cm4gZG9uZSgpOwoKICB2YXIgb3BlcmF0aW9ucyA9IHNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgdmFyIG9wZXJhdGlvbk1vZGVsID0gb3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgdmFyIGlzRW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA9IG9wZXJhdGlvbk1vZGVsID8gb3BlcmF0aW9uTW9kZWwuZW5kcG9pbnREaXNjb3ZlcnlSZXF1aXJlZCA6ICdOVUxMJzsKICB2YXIgaXNFbmFibGVkID0gcmVzb2x2ZUVuZHBvaW50RGlzY292ZXJ5Q29uZmlnKHJlcXVlc3QpOwogIHZhciBoYXNSZXF1aXJlZEVuZHBvaW50RGlzY292ZXJ5ID0gc2VydmljZS5hcGkuaGFzUmVxdWlyZWRFbmRwb2ludERpc2NvdmVyeTsKICBpZiAoaXNFbmFibGVkIHx8IGhhc1JlcXVpcmVkRW5kcG9pbnREaXNjb3ZlcnkpIHsKICAgIC8vIE9uY2UgYSBjdXN0b21lciBlbmFibGVzIGVuZHBvaW50IGRpc2NvdmVyeSwgdGhlIFNESyBzaG91bGQgc3RhcnQgYXBwZW5kaW5nCiAgICAvLyB0aGUgc3RyaW5nIGVuZHBvaW50LWRpc2NvdmVyeSB0byB0aGUgdXNlci1hZ2VudCBvbiBhbGwgcmVxdWVzdHMuCiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdlbmRwb2ludC1kaXNjb3ZlcnknKTsKICB9CiAgc3dpdGNoIChpc0VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQpIHsKICAgIGNhc2UgJ09QVElPTkFMJzoKICAgICAgaWYgKGlzRW5hYmxlZCB8fCBoYXNSZXF1aXJlZEVuZHBvaW50RGlzY292ZXJ5KSB7CiAgICAgICAgLy8gRm9yIGEgZ2l2ZW4gc2VydmljZTsgaWYgYXQgbGVhc3Qgb25lIG9wZXJhdGlvbiByZXF1aXJlcyBlbmRwb2ludCBkaXNjb3ZlcnkgdGhlbiB0aGUgU0RLIG11c3QgZW5hYmxlIGVuZHBvaW50IGRpc2NvdmVyeQogICAgICAgIC8vIGJ5IGRlZmF1bHQgZm9yIGFsbCBvcGVyYXRpb25zIG9mIHRoYXQgc2VydmljZSwgaW5jbHVkaW5nIG9wZXJhdGlvbnMgd2hlcmUgZW5kcG9pbnQgZGlzY292ZXJ5IGlzIG9wdGlvbmFsLgogICAgICAgIG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludChyZXF1ZXN0KTsKICAgICAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0lOVkFMSURBVEVfQ0FDSEVEX0VORFBPSU5UUycsICdleHRyYWN0RXJyb3InLCBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnRzKTsKICAgICAgfQogICAgICBkb25lKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnUkVRVUlSRUQnOgogICAgICBpZiAoaXNFbmFibGVkID09PSBmYWxzZSkgewogICAgICAgIC8vIEZvciBhIGdpdmVuIG9wZXJhdGlvbjsgaWYgZW5kcG9pbnQgZGlzY292ZXJ5IGlzIHJlcXVpcmVkIGFuZCBpdCBoYXMgYmVlbiBkaXNhYmxlZCBvbiB0aGUgU0RLIGNsaWVudCwKICAgICAgICAvLyB0aGVuIHRoZSBTREsgbXVzdCByZXR1cm4gYSBjbGVhciBhbmQgYWN0aW9uYWJsZSBleGNlcHRpb24uCiAgICAgICAgcmVxdWVzdC5yZXNwb25zZS5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICAgIGNvZGU6ICdDb25maWd1cmF0aW9uRXhjZXB0aW9uJywKICAgICAgICAgIG1lc3NhZ2U6ICdFbmRwb2ludCBEaXNjb3ZlcnkgaXMgZGlzYWJsZWQgYnV0ICcgKyBzZXJ2aWNlLmFwaS5jbGFzc05hbWUgKyAnLicgKyByZXF1ZXN0Lm9wZXJhdGlvbiArCiAgICAgICAgICAgICAgICAgICAgJygpIHJlcXVpcmVzIGl0LiBQbGVhc2UgY2hlY2sgeW91ciBjb25maWd1cmF0aW9ucy4nCiAgICAgICAgfSk7CiAgICAgICAgZG9uZSgpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignSU5WQUxJREFURV9DQUNIRURfRU5EUE9JTlRTJywgJ2V4dHJhY3RFcnJvcicsIGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMpOwogICAgICByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQocmVxdWVzdCwgZG9uZSk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnTlVMTCc6CiAgICBkZWZhdWx0OgogICAgICBkb25lKCk7CiAgICAgIGJyZWFrOwogIH0KfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgZGlzY292ZXJFbmRwb2ludDogZGlzY292ZXJFbmRwb2ludCwKICByZXF1aXJlZERpc2NvdmVyRW5kcG9pbnQ6IHJlcXVpcmVkRGlzY292ZXJFbmRwb2ludCwKICBvcHRpb25hbERpc2NvdmVyRW5kcG9pbnQ6IG9wdGlvbmFsRGlzY292ZXJFbmRwb2ludCwKICBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzOiBtYXJzaGFsbEN1c3RvbUlkZW50aWZpZXJzLAogIGdldENhY2hlS2V5OiBnZXRDYWNoZUtleSwKICBpbnZhbGlkYXRlQ2FjaGVkRW5kcG9pbnQ6IGludmFsaWRhdGVDYWNoZWRFbmRwb2ludHMsCn07Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2NvcmUiOjE5LCIuL3V0aWwiOjcyLCJfcHJvY2VzcyI6ODl9XSwyODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBldmVudE1lc3NhZ2VDaHVua2VyID0gcmVxdWlyZSgnLi4vZXZlbnQtc3RyZWFtL2V2ZW50LW1lc3NhZ2UtY2h1bmtlcicpLmV2ZW50TWVzc2FnZUNodW5rZXI7CnZhciBwYXJzZUV2ZW50ID0gcmVxdWlyZSgnLi9wYXJzZS1ldmVudCcpLnBhcnNlRXZlbnQ7CgpmdW5jdGlvbiBjcmVhdGVFdmVudFN0cmVhbShib2R5LCBwYXJzZXIsIG1vZGVsKSB7CiAgICB2YXIgZXZlbnRNZXNzYWdlcyA9IGV2ZW50TWVzc2FnZUNodW5rZXIoYm9keSk7CgogICAgdmFyIGV2ZW50cyA9IFtdOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRNZXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGV2ZW50cy5wdXNoKHBhcnNlRXZlbnQocGFyc2VyLCBldmVudE1lc3NhZ2VzW2ldLCBtb2RlbCkpOwogICAgfQoKICAgIHJldHVybiBldmVudHM7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgY3JlYXRlRXZlbnRTdHJlYW06IGNyZWF0ZUV2ZW50U3RyZWFtCn07Cgp9LHsiLi4vZXZlbnQtc3RyZWFtL2V2ZW50LW1lc3NhZ2UtY2h1bmtlciI6MjksIi4vcGFyc2UtZXZlbnQiOjMxfV0sMjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGFrZXMgaW4gYSBidWZmZXIgb2YgZXZlbnQgbWVzc2FnZXMgYW5kIHNwbGl0cyB0aGVtIGludG8gaW5kaXZpZHVhbCBtZXNzYWdlcy4KICogQHBhcmFtIHtCdWZmZXJ9IGJ1ZmZlcgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGV2ZW50TWVzc2FnZUNodW5rZXIoYnVmZmVyKSB7CiAgICAvKiogQHR5cGUgQnVmZmVyW10gKi8KICAgIHZhciBtZXNzYWdlcyA9IFtdOwogICAgdmFyIG9mZnNldCA9IDA7CgogICAgd2hpbGUgKG9mZnNldCA8IGJ1ZmZlci5sZW5ndGgpIHsKICAgICAgICB2YXIgdG90YWxMZW5ndGggPSBidWZmZXIucmVhZEludDMyQkUob2Zmc2V0KTsKCiAgICAgICAgLy8gY3JlYXRlIG5ldyBidWZmZXIgZm9yIGluZGl2aWR1YWwgbWVzc2FnZSAoc2hhcmVzIG1lbW9yeSB3aXRoIG9yaWdpbmFsKQogICAgICAgIHZhciBtZXNzYWdlID0gYnVmZmVyLnNsaWNlKG9mZnNldCwgdG90YWxMZW5ndGggKyBvZmZzZXQpOwogICAgICAgIC8vIGluY3JlbWVudCBvZmZzZXQgdG8gaXQgc3RhcnRzIGF0IHRoZSBuZXh0IG1lc3NhZ2UKICAgICAgICBvZmZzZXQgKz0gdG90YWxMZW5ndGg7CgogICAgICAgIG1lc3NhZ2VzLnB1c2gobWVzc2FnZSk7CiAgICB9CgogICAgcmV0dXJuIG1lc3NhZ2VzOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIGV2ZW50TWVzc2FnZUNodW5rZXI6IGV2ZW50TWVzc2FnZUNodW5rZXIKfTsKCn0se31dLDMwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlJykudXRpbDsKdmFyIHRvQnVmZmVyID0gdXRpbC5idWZmZXIudG9CdWZmZXI7CgovKioKICogQSBsb3NzbGVzcyByZXByZXNlbnRhdGlvbiBvZiBhIHNpZ25lZCwgNjQtYml0IGludGVnZXIuIEluc3RhbmNlcyBvZiB0aGlzCiAqIGNsYXNzIG1heSBiZSB1c2VkIGluIGFyaXRobWV0aWMgZXhwcmVzc2lvbnMgYXMgaWYgdGhleSB3ZXJlIG51bWVyaWMKICogcHJpbWl0aXZlcywgYnV0IHRoZSBiaW5hcnkgcmVwcmVzZW50YXRpb24gd2lsbCBiZSBwcmVzZXJ2ZWQgdW5jaGFuZ2VkIGFzIHRoZQogKiBgYnl0ZXNgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoZSBieXRlcyBzaG91bGQgYmUgZW5jb2RlZCBhcyBiaWctZW5kaWFuLAogKiB0d28ncyBjb21wbGVtZW50IGludGVnZXJzLgogKiBAcGFyYW0ge0J1ZmZlcn0gYnl0ZXMKICoKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBJbnQ2NChieXRlcykgewogICAgaWYgKGJ5dGVzLmxlbmd0aCAhPT0gOCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignSW50NjQgYnVmZmVycyBtdXN0IGJlIGV4YWN0bHkgOCBieXRlcycpOwogICAgfQogICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihieXRlcykpIGJ5dGVzID0gdG9CdWZmZXIoYnl0ZXMpOwoKICAgIHRoaXMuYnl0ZXMgPSBieXRlczsKfQoKLyoqCiAqIEBwYXJhbSB7bnVtYmVyfSBudW1iZXIKICogQHJldHVybnMge0ludDY0fQogKgogKiBAYXBpIHByaXZhdGUKICovCkludDY0LmZyb21OdW1iZXIgPSBmdW5jdGlvbihudW1iZXIpIHsKICAgIGlmIChudW1iZXIgPiA5MjIzMzcyMDM2ODU0Nzc1ODA3IHx8IG51bWJlciA8IC05MjIzMzcyMDM2ODU0Nzc1ODA4KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICBudW1iZXIgKyAnIGlzIHRvbyBsYXJnZSAob3IsIGlmIG5lZ2F0aXZlLCB0b28gc21hbGwpIHRvIHJlcHJlc2VudCBhcyBhbiBJbnQ2NCcKICAgICAgICApOwogICAgfQoKICAgIHZhciBieXRlcyA9IG5ldyBVaW50OEFycmF5KDgpOwogICAgZm9yICgKICAgICAgICB2YXIgaSA9IDcsIHJlbWFpbmluZyA9IE1hdGguYWJzKE1hdGgucm91bmQobnVtYmVyKSk7CiAgICAgICAgaSA+IC0xICYmIHJlbWFpbmluZyA+IDA7CiAgICAgICAgaS0tLCByZW1haW5pbmcgLz0gMjU2CiAgICApIHsKICAgICAgICBieXRlc1tpXSA9IHJlbWFpbmluZzsKICAgIH0KCiAgICBpZiAobnVtYmVyIDwgMCkgewogICAgICAgIG5lZ2F0ZShieXRlcyk7CiAgICB9CgogICAgcmV0dXJuIG5ldyBJbnQ2NChieXRlcyk7Cn07CgovKioKICogQHJldHVybnMge251bWJlcn0KICoKICogQGFwaSBwcml2YXRlCiAqLwpJbnQ2NC5wcm90b3R5cGUudmFsdWVPZiA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGJ5dGVzID0gdGhpcy5ieXRlcy5zbGljZSgwKTsKICAgIHZhciBuZWdhdGl2ZSA9IGJ5dGVzWzBdICYgMTI4OwogICAgaWYgKG5lZ2F0aXZlKSB7CiAgICAgICAgbmVnYXRlKGJ5dGVzKTsKICAgIH0KCiAgICByZXR1cm4gcGFyc2VJbnQoYnl0ZXMudG9TdHJpbmcoJ2hleCcpLCAxNikgKiAobmVnYXRpdmUgPyAtMSA6IDEpOwp9OwoKSW50NjQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gU3RyaW5nKHRoaXMudmFsdWVPZigpKTsKfTsKCi8qKgogKiBAcGFyYW0ge0J1ZmZlcn0gYnl0ZXMKICoKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBuZWdhdGUoYnl0ZXMpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgaSsrKSB7CiAgICAgICAgYnl0ZXNbaV0gXj0gMHhGRjsKICAgIH0KICAgIGZvciAodmFyIGkgPSA3OyBpID4gLTE7IGktLSkgewogICAgICAgIGJ5dGVzW2ldKys7CiAgICAgICAgaWYgKGJ5dGVzW2ldICE9PSAwKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBJbnQ2NDogSW50NjQKfTsKCn0seyIuLi9jb3JlIjoxOX1dLDMxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHBhcnNlTWVzc2FnZSA9IHJlcXVpcmUoJy4vcGFyc2UtbWVzc2FnZScpLnBhcnNlTWVzc2FnZTsKCi8qKgogKgogKiBAcGFyYW0geyp9IHBhcnNlcgogKiBAcGFyYW0ge0J1ZmZlcn0gbWVzc2FnZQogKiBAcGFyYW0geyp9IHNoYXBlCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gcGFyc2VFdmVudChwYXJzZXIsIG1lc3NhZ2UsIHNoYXBlKSB7CiAgICB2YXIgcGFyc2VkTWVzc2FnZSA9IHBhcnNlTWVzc2FnZShtZXNzYWdlKTsKCiAgICAvLyBjaGVjayBpZiBtZXNzYWdlIGlzIGFuIGV2ZW50IG9yIGVycm9yCiAgICB2YXIgbWVzc2FnZVR5cGUgPSBwYXJzZWRNZXNzYWdlLmhlYWRlcnNbJzptZXNzYWdlLXR5cGUnXTsKICAgIGlmIChtZXNzYWdlVHlwZSkgewogICAgICAgIGlmIChtZXNzYWdlVHlwZS52YWx1ZSA9PT0gJ2Vycm9yJykgewogICAgICAgICAgICB0aHJvdyBwYXJzZUVycm9yKHBhcnNlZE1lc3NhZ2UpOwogICAgICAgIH0gZWxzZSBpZiAobWVzc2FnZVR5cGUudmFsdWUgIT09ICdldmVudCcpIHsKICAgICAgICAgICAgLy8gbm90IHN1cmUgaG93IHRvIHBhcnNlIG5vbi1ldmVudHMvbm9uLWVycm9ycywgaWdub3JlIGZvciBub3cKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBkZXRlcm1pbmUgZXZlbnQgdHlwZQogICAgdmFyIGV2ZW50VHlwZSA9IHBhcnNlZE1lc3NhZ2UuaGVhZGVyc1snOmV2ZW50LXR5cGUnXTsKICAgIC8vIGNoZWNrIHRoYXQgdGhlIGV2ZW50IHR5cGUgaXMgbW9kZWxlZAogICAgdmFyIGV2ZW50TW9kZWwgPSBzaGFwZS5tZW1iZXJzW2V2ZW50VHlwZS52YWx1ZV07CiAgICBpZiAoIWV2ZW50TW9kZWwpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgLy8gY2hlY2sgaWYgYW4gZXZlbnQgcGF5bG9hZCBleGlzdHMKICAgIHZhciBldmVudFBheWxvYWRNZW1iZXJOYW1lID0gZXZlbnRNb2RlbC5ldmVudFBheWxvYWRNZW1iZXJOYW1lOwogICAgaWYgKGV2ZW50UGF5bG9hZE1lbWJlck5hbWUpIHsKICAgICAgICB2YXIgcGF5bG9hZFNoYXBlID0gZXZlbnRNb2RlbC5tZW1iZXJzW2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdOwogICAgICAgIC8vIGlmIHRoZSBzaGFwZSBpcyBiaW5hcnksIHJldHVybiB0aGUgYnl0ZSBhcnJheQogICAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ2JpbmFyeScpIHsKICAgICAgICAgICAgcmVzdWx0W2V2ZW50UGF5bG9hZE1lbWJlck5hbWVdID0gcGFyc2VkTWVzc2FnZS5ib2R5OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdFtldmVudFBheWxvYWRNZW1iZXJOYW1lXSA9IHBhcnNlci5wYXJzZShwYXJzZWRNZXNzYWdlLmJvZHkudG9TdHJpbmcoKSwgcGF5bG9hZFNoYXBlKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gcmVhZCBldmVudCBoZWFkZXJzCiAgICB2YXIgZXZlbnRIZWFkZXJOYW1lcyA9IGV2ZW50TW9kZWwuZXZlbnRIZWFkZXJNZW1iZXJOYW1lczsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRIZWFkZXJOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBuYW1lID0gZXZlbnRIZWFkZXJOYW1lc1tpXTsKICAgICAgICBpZiAocGFyc2VkTWVzc2FnZS5oZWFkZXJzW25hbWVdKSB7CiAgICAgICAgICAgIC8vIHBhcnNlIHRoZSBoZWFkZXIhCiAgICAgICAgICAgIHJlc3VsdFtuYW1lXSA9IGV2ZW50TW9kZWwubWVtYmVyc1tuYW1lXS50b1R5cGUocGFyc2VkTWVzc2FnZS5oZWFkZXJzW25hbWVdLnZhbHVlKTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIG91dHB1dCA9IHt9OwogICAgb3V0cHV0W2V2ZW50VHlwZS52YWx1ZV0gPSByZXN1bHQ7CiAgICByZXR1cm4gb3V0cHV0Owp9CgpmdW5jdGlvbiBwYXJzZUVycm9yKG1lc3NhZ2UpIHsKICAgIHZhciBlcnJvckNvZGUgPSBtZXNzYWdlLmhlYWRlcnNbJzplcnJvci1jb2RlJ107CiAgICB2YXIgZXJyb3JNZXNzYWdlID0gbWVzc2FnZS5oZWFkZXJzWyc6ZXJyb3ItbWVzc2FnZSddOwogICAgdmFyIGVycm9yID0gbmV3IEVycm9yKGVycm9yTWVzc2FnZS52YWx1ZSB8fCBlcnJvck1lc3NhZ2UpOwogICAgZXJyb3IuY29kZSA9IGVycm9yLm5hbWUgPSBlcnJvckNvZGUudmFsdWUgfHwgZXJyb3JDb2RlOwogICAgcmV0dXJuIGVycm9yOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIHBhcnNlRXZlbnQ6IHBhcnNlRXZlbnQKfTsKCn0seyIuL3BhcnNlLW1lc3NhZ2UiOjMyfV0sMzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgSW50NjQgPSByZXF1aXJlKCcuL2ludDY0JykuSW50NjQ7Cgp2YXIgc3BsaXRNZXNzYWdlID0gcmVxdWlyZSgnLi9zcGxpdC1tZXNzYWdlJykuc3BsaXRNZXNzYWdlOwoKdmFyIEJPT0xFQU5fVEFHID0gJ2Jvb2xlYW4nOwp2YXIgQllURV9UQUcgPSAnYnl0ZSc7CnZhciBTSE9SVF9UQUcgPSAnc2hvcnQnOwp2YXIgSU5UX1RBRyA9ICdpbnRlZ2VyJzsKdmFyIExPTkdfVEFHID0gJ2xvbmcnOwp2YXIgQklOQVJZX1RBRyA9ICdiaW5hcnknOwp2YXIgU1RSSU5HX1RBRyA9ICdzdHJpbmcnOwp2YXIgVElNRVNUQU1QX1RBRyA9ICd0aW1lc3RhbXAnOwp2YXIgVVVJRF9UQUcgPSAndXVpZCc7CgovKioKICogQGFwaSBwcml2YXRlCiAqCiAqIEBwYXJhbSB7QnVmZmVyfSBoZWFkZXJzCiAqLwpmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgdmFyIG91dCA9IHt9OwogICAgdmFyIHBvc2l0aW9uID0gMDsKICAgIHdoaWxlIChwb3NpdGlvbiA8IGhlYWRlcnMubGVuZ3RoKSB7CiAgICAgICAgdmFyIG5hbWVMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50OChwb3NpdGlvbisrKTsKICAgICAgICB2YXIgbmFtZSA9IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgbmFtZUxlbmd0aCkudG9TdHJpbmcoKTsKICAgICAgICBwb3NpdGlvbiArPSBuYW1lTGVuZ3RoOwogICAgICAgIHN3aXRjaCAoaGVhZGVycy5yZWFkVUludDgocG9zaXRpb24rKykpIHsKICAgICAgICAgICAgY2FzZSAwIC8qIGJvb2xUcnVlICovOgogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IEJPT0xFQU5fVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0cnVlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMSAvKiBib29sRmFsc2UgKi86CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogQk9PTEVBTl9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZhbHNlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMiAvKiBieXRlICovOgogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IEJZVEVfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQ4KHBvc2l0aW9uKyspCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMyAvKiBzaG9ydCAqLzoKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBTSE9SVF9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMucmVhZEludDE2QkUocG9zaXRpb24pCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDQgLyogaW50ZWdlciAqLzoKICAgICAgICAgICAgICAgIG91dFtuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiBJTlRfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBoZWFkZXJzLnJlYWRJbnQzMkJFKHBvc2l0aW9uKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSA1IC8qIGxvbmcgKi86CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogTE9OR19UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDg7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSA2IC8qIGJ5dGVBcnJheSAqLzoKICAgICAgICAgICAgICAgIHZhciBiaW5hcnlMZW5ndGggPSBoZWFkZXJzLnJlYWRVSW50MTZCRShwb3NpdGlvbik7CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSAyOwogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IEJJTkFSWV9UQUcsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgYmluYXJ5TGVuZ3RoKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IGJpbmFyeUxlbmd0aDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDcgLyogc3RyaW5nICovOgogICAgICAgICAgICAgICAgdmFyIHN0cmluZ0xlbmd0aCA9IGhlYWRlcnMucmVhZFVJbnQxNkJFKHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDI7CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogU1RSSU5HX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaGVhZGVycy5zbGljZSgKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uICsgc3RyaW5nTGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgKS50b1N0cmluZygpCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgcG9zaXRpb24gKz0gc3RyaW5nTGVuZ3RoOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgOCAvKiB0aW1lc3RhbXAgKi86CiAgICAgICAgICAgICAgICBvdXRbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogVElNRVNUQU1QX1RBRywKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3IERhdGUoCiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBJbnQ2NChoZWFkZXJzLnNsaWNlKHBvc2l0aW9uLCBwb3NpdGlvbiArIDgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLnZhbHVlT2YoKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBwb3NpdGlvbiArPSA4OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgOSAvKiB1dWlkICovOgogICAgICAgICAgICAgICAgdmFyIHV1aWRDaGFycyA9IGhlYWRlcnMuc2xpY2UocG9zaXRpb24sIHBvc2l0aW9uICsgMTYpCiAgICAgICAgICAgICAgICAgICAgLnRvU3RyaW5nKCdoZXgnKTsKICAgICAgICAgICAgICAgIHBvc2l0aW9uICs9IDE2OwogICAgICAgICAgICAgICAgb3V0W25hbWVdID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6IFVVSURfVEFHLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB1dWlkQ2hhcnMuc3Vic3RyKDAsIDgpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cig4LCA0KSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgIHV1aWRDaGFycy5zdWJzdHIoMTIsIDQpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgdXVpZENoYXJzLnN1YnN0cigxNiwgNCkgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICB1dWlkQ2hhcnMuc3Vic3RyKDIwKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnJlY29nbml6ZWQgaGVhZGVyIHR5cGUgdGFnJyk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG91dDsKfQoKZnVuY3Rpb24gcGFyc2VNZXNzYWdlKG1lc3NhZ2UpIHsKICAgIHZhciBwYXJzZWQgPSBzcGxpdE1lc3NhZ2UobWVzc2FnZSk7CiAgICByZXR1cm4geyBoZWFkZXJzOiBwYXJzZUhlYWRlcnMocGFyc2VkLmhlYWRlcnMpLCBib2R5OiBwYXJzZWQuYm9keSB9Owp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIHBhcnNlTWVzc2FnZTogcGFyc2VNZXNzYWdlCn07Cgp9LHsiLi9pbnQ2NCI6MzAsIi4vc3BsaXQtbWVzc2FnZSI6MzN9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vY29yZScpLnV0aWw7CnZhciB0b0J1ZmZlciA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyOwoKLy8gQWxsIHByZWx1ZGUgY29tcG9uZW50cyBhcmUgdW5zaWduZWQsIDMyLWJpdCBpbnRlZ2Vycwp2YXIgUFJFTFVERV9NRU1CRVJfTEVOR1RIID0gNDsKLy8gVGhlIHByZWx1ZGUgY29uc2lzdHMgb2YgdHdvIGNvbXBvbmVudHMKdmFyIFBSRUxVREVfTEVOR1RIID0gUFJFTFVERV9NRU1CRVJfTEVOR1RIICogMjsKLy8gQ2hlY2tzdW1zIGFyZSBhbHdheXMgQ1JDMzIgaGFzaGVzLgp2YXIgQ0hFQ0tTVU1fTEVOR1RIID0gNDsKLy8gTWVzc2FnZXMgbXVzdCBpbmNsdWRlIGEgZnVsbCBwcmVsdWRlLCBhIHByZWx1ZGUgY2hlY2tzdW0sIGFuZCBhIG1lc3NhZ2UgY2hlY2tzdW0KdmFyIE1JTklNVU1fTUVTU0FHRV9MRU5HVEggPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSCAqIDI7CgovKioKICogQGFwaSBwcml2YXRlCiAqCiAqIEBwYXJhbSB7QnVmZmVyfSBtZXNzYWdlCiAqLwpmdW5jdGlvbiBzcGxpdE1lc3NhZ2UobWVzc2FnZSkgewogICAgaWYgKCF1dGlsLkJ1ZmZlci5pc0J1ZmZlcihtZXNzYWdlKSkgbWVzc2FnZSA9IHRvQnVmZmVyKG1lc3NhZ2UpOwoKICAgIGlmIChtZXNzYWdlLmxlbmd0aCA8IE1JTklNVU1fTUVTU0FHRV9MRU5HVEgpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb3ZpZGVkIG1lc3NhZ2UgdG9vIHNob3J0IHRvIGFjY29tbW9kYXRlIGV2ZW50IHN0cmVhbSBtZXNzYWdlIG92ZXJoZWFkJyk7CiAgICB9CgogICAgaWYgKG1lc3NhZ2UubGVuZ3RoICE9PSBtZXNzYWdlLnJlYWRVSW50MzJCRSgwKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignUmVwb3J0ZWQgbWVzc2FnZSBsZW5ndGggZG9lcyBub3QgbWF0Y2ggcmVjZWl2ZWQgbWVzc2FnZSBsZW5ndGgnKTsKICAgIH0KCiAgICB2YXIgZXhwZWN0ZWRQcmVsdWRlQ2hlY2tzdW0gPSBtZXNzYWdlLnJlYWRVSW50MzJCRShQUkVMVURFX0xFTkdUSCk7CgogICAgaWYgKAogICAgICAgIGV4cGVjdGVkUHJlbHVkZUNoZWNrc3VtICE9PSB1dGlsLmNyeXB0by5jcmMzMigKICAgICAgICAgICAgbWVzc2FnZS5zbGljZSgwLCBQUkVMVURFX0xFTkdUSCkKICAgICAgICApCiAgICApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICdUaGUgcHJlbHVkZSBjaGVja3N1bSBzcGVjaWZpZWQgaW4gdGhlIG1lc3NhZ2UgKCcgKwogICAgICAgICAgICBleHBlY3RlZFByZWx1ZGVDaGVja3N1bSArCiAgICAgICAgICAgICcpIGRvZXMgbm90IG1hdGNoIHRoZSBjYWxjdWxhdGVkIENSQzMyIGNoZWNrc3VtLicKICAgICAgICApOwogICAgfQoKICAgIHZhciBleHBlY3RlZE1lc3NhZ2VDaGVja3N1bSA9IG1lc3NhZ2UucmVhZFVJbnQzMkJFKG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKTsKCiAgICBpZiAoCiAgICAgICAgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0gIT09IHV0aWwuY3J5cHRvLmNyYzMyKAogICAgICAgICAgICBtZXNzYWdlLnNsaWNlKDAsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKQogICAgICAgICkKICAgICkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgJ1RoZSBtZXNzYWdlIGNoZWNrc3VtIGRpZCBub3QgbWF0Y2ggdGhlIGV4cGVjdGVkIHZhbHVlIG9mICcgKwogICAgICAgICAgICAgICAgZXhwZWN0ZWRNZXNzYWdlQ2hlY2tzdW0KICAgICAgICApOwogICAgfQoKICAgIHZhciBoZWFkZXJzU3RhcnQgPSBQUkVMVURFX0xFTkdUSCArIENIRUNLU1VNX0xFTkdUSDsKICAgIHZhciBoZWFkZXJzRW5kID0gaGVhZGVyc1N0YXJ0ICsgbWVzc2FnZS5yZWFkVUludDMyQkUoUFJFTFVERV9NRU1CRVJfTEVOR1RIKTsKCiAgICByZXR1cm4gewogICAgICAgIGhlYWRlcnM6IG1lc3NhZ2Uuc2xpY2UoaGVhZGVyc1N0YXJ0LCBoZWFkZXJzRW5kKSwKICAgICAgICBib2R5OiBtZXNzYWdlLnNsaWNlKGhlYWRlcnNFbmQsIG1lc3NhZ2UubGVuZ3RoIC0gQ0hFQ0tTVU1fTEVOR1RIKSwKICAgIH07Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgc3BsaXRNZXNzYWdlOiBzcGxpdE1lc3NhZ2UKfTsKCn0seyIuLi9jb3JlIjoxOX1dLDM0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKdmFyIFNlcXVlbnRpYWxFeGVjdXRvciA9IHJlcXVpcmUoJy4vc2VxdWVudGlhbF9leGVjdXRvcicpOwp2YXIgRElTQ09WRVJfRU5EUE9JTlQgPSByZXF1aXJlKCcuL2Rpc2NvdmVyX2VuZHBvaW50JykuZGlzY292ZXJFbmRwb2ludDsKLyoqCiAqIFRoZSBuYW1lc3BhY2UgdXNlZCB0byByZWdpc3RlciBnbG9iYWwgZXZlbnQgbGlzdGVuZXJzIGZvciByZXF1ZXN0IGJ1aWxkaW5nCiAqIGFuZCBzZW5kaW5nLgogKi8KQVdTLkV2ZW50TGlzdGVuZXJzID0gewogIC8qKgogICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX0NSRURFTlRJQUxTCiAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCB2YWxpZGF0ZXMgd2hldGhlciB0aGUgcmVxdWVzdCBpcyBiZWluZwogICAqICAgc2VudCB3aXRoIGNyZWRlbnRpYWxzLgogICAqICAgSGFuZGxlcyB0aGUge0FXUy5SZXF1ZXN0fnZhbGlkYXRlICd2YWxpZGF0ZScgUmVxdWVzdCBldmVudH0KICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGhvdXQgdmFsaWRhdGluZyBjcmVkZW50aWFscwogICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUzsKICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1JFR0lPTgogICAqICAgQSByZXF1ZXN0IGxpc3RlbmVyIHRoYXQgdmFsaWRhdGVzIHdoZXRoZXIgdGhlIHJlZ2lvbiBpcyBzZXQKICAgKiAgIGZvciBhIHJlcXVlc3QuCiAgICogICBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+dmFsaWRhdGUgJ3ZhbGlkYXRlJyBSZXF1ZXN0IGV2ZW50fQogICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aG91dCB2YWxpZGF0aW5nIHJlZ2lvbiBjb25maWd1cmF0aW9uCiAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1JFR0lPTjsKICAgKiAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBsaXN0ZW5lcik7CiAgICogICBAcmVhZG9ubHkKICAgKiAgIEByZXR1cm4gW0Z1bmN0aW9uXQogICAqIEAhYXR0cmlidXRlIFZBTElEQVRFX1BBUkFNRVRFUlMKICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHZhbGlkYXRlcyBpbnB1dCBwYXJhbWV0ZXJzIGluIGEgcmVxdWVzdC4KICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH52YWxpZGF0ZSAndmFsaWRhdGUnIFJlcXVlc3QgZXZlbnR9CiAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB3aXRob3V0IHZhbGlkYXRpbmcgcGFyYW1ldGVycwogICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9QQVJBTUVURVJTOwogICAqICAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCd2YWxpZGF0ZScsIGxpc3RlbmVyKTsKICAgKiAgIEBleGFtcGxlIERpc2FibGUgcGFyYW1ldGVyIHZhbGlkYXRpb24gZ2xvYmFsbHkKICAgKiAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUucmVtb3ZlTGlzdGVuZXIoJ3ZhbGlkYXRlJywKICAgKiAgICAgICBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT04pOwogICAqICAgQHJlYWRvbmx5CiAgICogICBAcmV0dXJuIFtGdW5jdGlvbl0KICAgKiBAIWF0dHJpYnV0ZSBTRU5ECiAgICogICBBIHJlcXVlc3QgbGlzdGVuZXIgdGhhdCBpbml0aWF0ZXMgdGhlIEhUVFAgY29ubmVjdGlvbiBmb3IgYQogICAqICAgcmVxdWVzdCBiZWluZyBzZW50LiBIYW5kbGVzIHRoZSB7QVdTLlJlcXVlc3R+c2VuZCAnc2VuZCcgUmVxdWVzdCBldmVudH0KICAgKiAgIEBleGFtcGxlIFJlcGxhY2luZyB0aGUgSFRUUCBoYW5kbGVyCiAgICogICAgIHZhciBsaXN0ZW5lciA9IEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFTkQ7CiAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ3NlbmQnLCBsaXN0ZW5lcik7CiAgICogICAgIHJlcXVlc3Qub24oJ3NlbmQnLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAqICAgICAgIGN1c3RvbUhhbmRsZXIuc2VuZChyZXNwb25zZSk7CiAgICogICAgIH0pOwogICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICogICBAcmVhZG9ubHkKICAgKiBAIWF0dHJpYnV0ZSBIVFRQX0RBVEEKICAgKiAgIEEgcmVxdWVzdCBsaXN0ZW5lciB0aGF0IHJlYWRzIGRhdGEgZnJvbSB0aGUgSFRUUCBjb25uZWN0aW9uIGluIG9yZGVyCiAgICogICB0byBidWlsZCB0aGUgcmVzcG9uc2UgZGF0YS4KICAgKiAgIEhhbmRsZXMgdGhlIHtBV1MuUmVxdWVzdH5odHRwRGF0YSAnaHR0cERhdGEnIFJlcXVlc3QgZXZlbnR9LgogICAqICAgUmVtb3ZlIHRoaXMgaGFuZGxlciBpZiB5b3UgYXJlIG92ZXJyaWRpbmcgdGhlICdodHRwRGF0YScgZXZlbnQgYW5kCiAgICogICBkbyBub3Qgd2FudCBleHRyYSBkYXRhIHByb2Nlc3NpbmcgYW5kIGJ1ZmZlcmluZyBvdmVyaGVhZC4KICAgKiAgIEBleGFtcGxlIERpc2FibGluZyBkZWZhdWx0IGRhdGEgcHJvY2Vzc2luZwogICAqICAgICB2YXIgbGlzdGVuZXIgPSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEE7CiAgICogICAgIHJlcXVlc3QucmVtb3ZlTGlzdGVuZXIoJ2h0dHBEYXRhJywgbGlzdGVuZXIpOwogICAqICAgQHJldHVybiBbRnVuY3Rpb25dCiAgICogICBAcmVhZG9ubHkKICAgKi8KICBDb3JlOiB7fSAvKiBkb2MgaGFjayAqLwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gZ2V0T3BlcmF0aW9uQXV0aHR5cGUocmVxKSB7CiAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgcmV0dXJuICcnOwogIH0KICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgcmV0dXJuIG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwp9CgpBV1MuRXZlbnRMaXN0ZW5lcnMgPSB7CiAgQ29yZTogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCwgYWRkQXN5bmMpIHsKICAgIGFkZEFzeW5jKCdWQUxJREFURV9DUkVERU5USUFMUycsICd2YWxpZGF0ZScsCiAgICAgICAgZnVuY3Rpb24gVkFMSURBVEVfQ1JFREVOVElBTFMocmVxLCBkb25lKSB7CiAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLnNpZ25hdHVyZVZlcnNpb24gJiYgIXJlcS5zZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgICAgIHJlcS5zZXJ2aWNlLmNvbmZpZy5nZXRDcmVkZW50aWFscyhmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihlcnIsCiAgICAgICAgICAgIHtjb2RlOiAnQ3JlZGVudGlhbHNFcnJvcicsIG1lc3NhZ2U6ICdNaXNzaW5nIGNyZWRlbnRpYWxzIGluIGNvbmZpZywgaWYgdXNpbmcgQVdTX0NPTkZJR19GSUxFLCBzZXQgQVdTX1NES19MT0FEX0NPTkZJRz0xJ30pOwogICAgICAgIH0KICAgICAgICBkb25lKCk7CiAgICAgIH0pOwogICAgfSk7CgogICAgYWRkKCdWQUxJREFURV9SRUdJT04nLCAndmFsaWRhdGUnLCBmdW5jdGlvbiBWQUxJREFURV9SRUdJT04ocmVxKSB7CiAgICAgIGlmICghcmVxLnNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCkgewogICAgICAgIHZhciBkbnNIb3N0UmVnZXggPSBuZXcgUmVnRXhwKC9eKFthLXpBLVowLTldfFthLXpBLVowLTldW2EtekEtWjAtOS1dezAsNjF9W2EtekEtWjAtOV0pJC8pOwogICAgICAgIGlmICghcmVxLnNlcnZpY2UuY29uZmlnLnJlZ2lvbikgewogICAgICAgICAgcmVxLnJlc3BvbnNlLmVycm9yID0gQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICAgIHtjb2RlOiAnQ29uZmlnRXJyb3InLCBtZXNzYWdlOiAnTWlzc2luZyByZWdpb24gaW4gY29uZmlnJ30pOwogICAgICAgIH0gZWxzZSBpZiAoIWRuc0hvc3RSZWdleC50ZXN0KHJlcS5zZXJ2aWNlLmNvbmZpZy5yZWdpb24pKSB7CiAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAge2NvZGU6ICdDb25maWdFcnJvcicsIG1lc3NhZ2U6ICdJbnZhbGlkIHJlZ2lvbiBpbiBjb25maWcnfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0JVSUxEX0lERU1QT1RFTkNZX1RPS0VOUycsICd2YWxpZGF0ZScsIGZ1bmN0aW9uIEJVSUxEX0lERU1QT1RFTkNZX1RPS0VOUyhyZXEpIHsKICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgIGlmICghb3BlcmF0aW9uKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBpZGVtcG90ZW50TWVtYmVycyA9IG9wZXJhdGlvbi5pZGVtcG90ZW50TWVtYmVyczsKICAgICAgaWYgKCFpZGVtcG90ZW50TWVtYmVycy5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgLy8gY3JlYXRlcyBhIGNvcHkgb2YgcGFyYW1zIHNvIHVzZXIncyBwYXJhbSBvYmplY3QgaXNuJ3QgbXV0YXRlZAogICAgICB2YXIgcGFyYW1zID0gQVdTLnV0aWwuY29weShyZXEucGFyYW1zKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBpZGVtcG90ZW50TWVtYmVycy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICBpZiAoIXBhcmFtc1tpZGVtcG90ZW50TWVtYmVyc1tpXV0pIHsKICAgICAgICAgIC8vIGFkZCB0aGUgbWVtYmVyCiAgICAgICAgICBwYXJhbXNbaWRlbXBvdGVudE1lbWJlcnNbaV1dID0gQVdTLnV0aWwudXVpZC52NCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXEucGFyYW1zID0gcGFyYW1zOwogICAgfSk7CgogICAgYWRkKCdWQUxJREFURV9QQVJBTUVURVJTJywgJ3ZhbGlkYXRlJywgZnVuY3Rpb24gVkFMSURBVEVfUEFSQU1FVEVSUyhyZXEpIHsKICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgcnVsZXMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICAgICAgdmFyIHZhbGlkYXRpb24gPSByZXEuc2VydmljZS5jb25maWcucGFyYW1WYWxpZGF0aW9uOwogICAgICBuZXcgQVdTLlBhcmFtVmFsaWRhdG9yKHZhbGlkYXRpb24pLnZhbGlkYXRlKHJ1bGVzLCByZXEucGFyYW1zKTsKICAgIH0pOwoKICAgIGFkZCgnQ09NUFVURV9DSEVDS1NVTScsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gQ09NUFVURV9DSEVDS1NVTShyZXEpIHsKICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkub3BlcmF0aW9ucykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgICAgIGlmICghb3BlcmF0aW9uKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBib2R5ID0gcmVxLmh0dHBSZXF1ZXN0LmJvZHk7CiAgICAgIHZhciBpc05vblN0cmVhbWluZ1BheWxvYWQgPSBib2R5ICYmIChBV1MudXRpbC5CdWZmZXIuaXNCdWZmZXIoYm9keSkgfHwgdHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnKTsKICAgICAgdmFyIGhlYWRlcnMgPSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyczsKICAgICAgaWYgKAogICAgICAgIG9wZXJhdGlvbi5odHRwQ2hlY2tzdW1SZXF1aXJlZCAmJgogICAgICAgIHJlcS5zZXJ2aWNlLmNvbmZpZy5jb21wdXRlQ2hlY2tzdW1zICYmCiAgICAgICAgaXNOb25TdHJlYW1pbmdQYXlsb2FkICYmCiAgICAgICAgIWhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10KICAgICAgKSB7CiAgICAgICAgdmFyIG1kNSA9IEFXUy51dGlsLmNyeXB0by5tZDUoYm9keSwgJ2Jhc2U2NCcpOwogICAgICAgIGhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10gPSBtZDU7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZEFzeW5jKCdDT01QVVRFX1NIQTI1NicsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gQ09NUFVURV9TSEEyNTYocmVxLCBkb25lKSB7CiAgICAgIHJlcS5oYWx0SGFuZGxlcnNPbkVycm9yKCk7CiAgICAgIGlmICghcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICB2YXIgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgICAgaWYgKCFyZXEuc2VydmljZS5hcGkuc2lnbmF0dXJlVmVyc2lvbiAmJiAhYXV0aHR5cGUgJiYgIXJlcS5zZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSByZXR1cm4gZG9uZSgpOyAvLyBub25lCiAgICAgIGlmIChyZXEuc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXEpID09PSBBV1MuU2lnbmVycy5WNCkgewogICAgICAgIHZhciBib2R5ID0gcmVxLmh0dHBSZXF1ZXN0LmJvZHkgfHwgJyc7CiAgICAgICAgaWYgKGF1dGh0eXBlLmluZGV4T2YoJ3Vuc2lnbmVkLWJvZHknKSA+PSAwKSB7CiAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXSA9ICdVTlNJR05FRC1QQVlMT0FEJzsKICAgICAgICAgIHJldHVybiBkb25lKCk7CiAgICAgICAgfQogICAgICAgIEFXUy51dGlsLmNvbXB1dGVTaGEyNTYoYm9keSwgZnVuY3Rpb24oZXJyLCBzaGEpIHsKICAgICAgICAgIGlmIChlcnIpIHsKICAgICAgICAgICAgZG9uZShlcnIpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Db250ZW50LVNoYTI1NiddID0gc2hhOwogICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZG9uZSgpOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ1NFVF9DT05URU5UX0xFTkdUSCcsICdhZnRlckJ1aWxkJywgZnVuY3Rpb24gU0VUX0NPTlRFTlRfTEVOR1RIKHJlcSkgewogICAgICB2YXIgYXV0aHR5cGUgPSBnZXRPcGVyYXRpb25BdXRodHlwZShyZXEpOwogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IEFXUy51dGlsLmdldFJlcXVlc3RQYXlsb2FkU2hhcGUocmVxKTsKICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID09PSB1bmRlZmluZWQpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGxlbmd0aCA9IEFXUy51dGlsLnN0cmluZy5ieXRlTGVuZ3RoKHJlcS5odHRwUmVxdWVzdC5ib2R5KTsKICAgICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gbGVuZ3RoOwogICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgaWYgKHBheWxvYWRNZW1iZXIgJiYgcGF5bG9hZE1lbWJlci5pc1N0cmVhbWluZykgewogICAgICAgICAgICBpZiAocGF5bG9hZE1lbWJlci5yZXF1aXJlc0xlbmd0aCkgewogICAgICAgICAgICAgIC8vc3RyZWFtaW5nIHBheWxvYWQgcmVxdWlyZXMgbGVuZ3RoKHMzLCBnbGFjaWVyKQogICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgfSBlbHNlIGlmIChhdXRodHlwZS5pbmRleE9mKCd1bnNpZ25lZC1ib2R5JykgPj0gMCkgewogICAgICAgICAgICAgIC8vdW5ib3VuZGVkIHN0cmVhbWluZyBwYXlsb2FkKGxleCwgbWVkaWFzdG9yZSkKICAgICAgICAgICAgICByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snVHJhbnNmZXItRW5jb2RpbmcnXSA9ICdjaHVua2VkJzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ1NFVF9IVFRQX0hPU1QnLCAnYWZ0ZXJCdWlsZCcsIGZ1bmN0aW9uIFNFVF9IVFRQX0hPU1QocmVxKSB7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydIb3N0J10gPSByZXEuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdDsKICAgIH0pOwoKICAgIGFkZCgnU0VUX1RSQUNFX0lEJywgJ2FmdGVyQnVpbGQnLCBmdW5jdGlvbiBTRVRfVFJBQ0VfSUQocmVxKSB7CiAgICAgIHZhciB0cmFjZUlkSGVhZGVyTmFtZSA9ICdYLUFtem4tVHJhY2UtSWQnOwogICAgICBpZiAoQVdTLnV0aWwuaXNOb2RlKCkgJiYgIU9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzLCB0cmFjZUlkSGVhZGVyTmFtZSkpIHsKICAgICAgICB2YXIgRU5WX0xBTUJEQV9GVU5DVElPTl9OQU1FID0gJ0FXU19MQU1CREFfRlVOQ1RJT05fTkFNRSc7CiAgICAgICAgdmFyIEVOVl9UUkFDRV9JRCA9ICdfWF9BTVpOX1RSQUNFX0lEJzsKICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gcHJvY2Vzcy5lbnZbRU5WX0xBTUJEQV9GVU5DVElPTl9OQU1FXTsKICAgICAgICB2YXIgdHJhY2VJZCA9IHByb2Nlc3MuZW52W0VOVl9UUkFDRV9JRF07CiAgICAgICAgaWYgKAogICAgICAgICAgdHlwZW9mIGZ1bmN0aW9uTmFtZSA9PT0gJ3N0cmluZycgJiYKICAgICAgICAgIGZ1bmN0aW9uTmFtZS5sZW5ndGggPiAwICYmCiAgICAgICAgICB0eXBlb2YgdHJhY2VJZCA9PT0gJ3N0cmluZycgJiYKICAgICAgICAgIHRyYWNlSWQubGVuZ3RoID4gMAogICAgICAgICkgewogICAgICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbdHJhY2VJZEhlYWRlck5hbWVdID0gdHJhY2VJZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnUkVTVEFSVCcsICdyZXN0YXJ0JywgZnVuY3Rpb24gUkVTVEFSVCgpIHsKICAgICAgdmFyIGVyciA9IHRoaXMucmVzcG9uc2UuZXJyb3I7CiAgICAgIGlmICghZXJyIHx8ICFlcnIucmV0cnlhYmxlKSByZXR1cm47CgogICAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdCgKICAgICAgICB0aGlzLnNlcnZpY2UuZW5kcG9pbnQsCiAgICAgICAgdGhpcy5zZXJ2aWNlLnJlZ2lvbgogICAgICApOwoKICAgICAgaWYgKHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCA8IHRoaXMuc2VydmljZS5jb25maWcubWF4UmV0cmllcykgewogICAgICAgIHRoaXMucmVzcG9uc2UucmV0cnlDb3VudCsrOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBudWxsOwogICAgICB9CiAgICB9KTsKCiAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKICAgIGFkZEFzeW5jKCdESVNDT1ZFUl9FTkRQT0lOVCcsICdzaWduJywgRElTQ09WRVJfRU5EUE9JTlQsIGFkZFRvSGVhZCk7CgogICAgYWRkQXN5bmMoJ1NJR04nLCAnc2lnbicsIGZ1bmN0aW9uIFNJR04ocmVxLCBkb25lKSB7CiAgICAgIHZhciBzZXJ2aWNlID0gcmVxLnNlcnZpY2U7CiAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgfHwge307CiAgICAgIHZhciBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogICAgICB2YXIgYXV0aHR5cGUgPSBvcGVyYXRpb24gPyBvcGVyYXRpb24uYXV0aHR5cGUgOiAnJzsKICAgICAgaWYgKCFzZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uICYmICFhdXRodHlwZSAmJiAhc2VydmljZS5jb25maWcuc2lnbmF0dXJlVmVyc2lvbikgcmV0dXJuIGRvbmUoKTsgLy8gbm9uZQoKICAgICAgc2VydmljZS5jb25maWcuZ2V0Q3JlZGVudGlhbHMoZnVuY3Rpb24gKGVyciwgY3JlZGVudGlhbHMpIHsKICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgICAgICByZXR1cm4gZG9uZSgpOwogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBkYXRlID0gc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpOwogICAgICAgICAgdmFyIFNpZ25lckNsYXNzID0gc2VydmljZS5nZXRTaWduZXJDbGFzcyhyZXEpOwogICAgICAgICAgdmFyIHNpZ25lciA9IG5ldyBTaWduZXJDbGFzcyhyZXEuaHR0cFJlcXVlc3QsCiAgICAgICAgICAgIHNlcnZpY2UuZ2V0U2lnbmluZ05hbWUocmVxKSwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHNpZ25hdHVyZUNhY2hlOiBzZXJ2aWNlLmNvbmZpZy5zaWduYXR1cmVDYWNoZSwKICAgICAgICAgICAgICBvcGVyYXRpb246IG9wZXJhdGlvbiwKICAgICAgICAgICAgICBzaWduYXR1cmVWZXJzaW9uOiBzZXJ2aWNlLmFwaS5zaWduYXR1cmVWZXJzaW9uCiAgICAgICAgICAgIH0pOwogICAgICAgICAgc2lnbmVyLnNldFNlcnZpY2VDbGllbnRJZChzZXJ2aWNlLl9jbGllbnRJZCk7CgogICAgICAgICAgLy8gY2xlYXIgb2xkIGF1dGhvcml6YXRpb24gaGVhZGVycwogICAgICAgICAgZGVsZXRlIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ107CiAgICAgICAgICBkZWxldGUgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0RhdGUnXTsKICAgICAgICAgIGRlbGV0ZSByZXEuaHR0cFJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddOwoKICAgICAgICAgIC8vIGFkZCBuZXcgYXV0aG9yaXphdGlvbgogICAgICAgICAgc2lnbmVyLmFkZEF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGUpOwogICAgICAgICAgcmVxLnNpZ25lZEF0ID0gZGF0ZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXEucmVzcG9uc2UuZXJyb3IgPSBlOwogICAgICAgIH0KICAgICAgICBkb25lKCk7CiAgICAgIH0pOwogICAgfSk7CgogICAgYWRkKCdWQUxJREFURV9SRVNQT05TRScsICd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24gVkFMSURBVEVfUkVTUE9OU0UocmVzcCkgewogICAgICBpZiAodGhpcy5zZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCB0aGlzKSkgewogICAgICAgIHJlc3AuZGF0YSA9IHt9OwogICAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc3AuZGF0YSA9IG51bGw7CiAgICAgICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICAge2NvZGU6ICdVbmtub3duRXJyb3InLCBtZXNzYWdlOiAnQW4gdW5rbm93biBlcnJvciBvY2N1cnJlZC4nfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnRVJST1InLCAnZXJyb3InLCBmdW5jdGlvbiBFUlJPUihlcnIsIHJlc3ApIHsKICAgICAgdmFyIGVycm9yQ29kZU1hcHBpbmcgPSByZXNwLnJlcXVlc3Quc2VydmljZS5hcGkuZXJyb3JDb2RlTWFwcGluZzsKICAgICAgaWYgKGVycm9yQ29kZU1hcHBpbmcgJiYgZXJyICYmIGVyci5jb2RlKSB7CiAgICAgICAgdmFyIG1hcHBpbmcgPSBlcnJvckNvZGVNYXBwaW5nW2Vyci5jb2RlXTsKICAgICAgICBpZiAobWFwcGluZykgewogICAgICAgICAgcmVzcC5lcnJvci5jb2RlID0gbWFwcGluZy5jb2RlOwogICAgICAgIH0KICAgICAgfQogICAgfSwgdHJ1ZSk7CgogICAgYWRkQXN5bmMoJ1NFTkQnLCAnc2VuZCcsIGZ1bmN0aW9uIFNFTkQocmVzcCwgZG9uZSkgewogICAgICByZXNwLmh0dHBSZXNwb25zZS5fYWJvcnRDYWxsYmFjayA9IGRvbmU7CiAgICAgIHJlc3AuZXJyb3IgPSBudWxsOwogICAgICByZXNwLmRhdGEgPSBudWxsOwoKICAgICAgZnVuY3Rpb24gY2FsbGJhY2soaHR0cFJlc3ApIHsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gPSBodHRwUmVzcDsKICAgICAgICB2YXIgc3RyZWFtID0gcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnN0cmVhbTsKICAgICAgICB2YXIgc2VydmljZSA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlOwogICAgICAgIHZhciBhcGkgPSBzZXJ2aWNlLmFwaTsKICAgICAgICB2YXIgb3BlcmF0aW9uTmFtZSA9IHJlc3AucmVxdWVzdC5vcGVyYXRpb247CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IGFwaS5vcGVyYXRpb25zW29wZXJhdGlvbk5hbWVdIHx8IHt9OwoKICAgICAgICBodHRwUmVzcC5vbignaGVhZGVycycsIGZ1bmN0aW9uIG9uSGVhZGVycyhzdGF0dXNDb2RlLCBoZWFkZXJzLCBzdGF0dXNNZXNzYWdlKSB7CiAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgKICAgICAgICAgICAgJ2h0dHBIZWFkZXJzJywKICAgICAgICAgICAgW3N0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3AsIHN0YXR1c01lc3NhZ2VdCiAgICAgICAgICApOwoKICAgICAgICAgIGlmICghcmVzcC5odHRwUmVzcG9uc2Uuc3RyZWFtaW5nKSB7CiAgICAgICAgICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgeyAvLyBzdHJlYW1zMiBBUEkgY2hlY2sKICAgICAgICAgICAgICAvLyBpZiB3ZSBkZXRlY3QgZXZlbnQgc3RyZWFtcywgd2UncmUgZ29pbmcgdG8gaGF2ZSB0bwogICAgICAgICAgICAgIC8vIHJldHVybiB0aGUgc3RyZWFtIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgaWYgKG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCAmJiBzZXJ2aWNlLnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwKSkgewogICAgICAgICAgICAgICAgLy8gc2tpcCByZWFkaW5nIHRoZSBJbmNvbWluZ1N0cmVhbQogICAgICAgICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBEb25lJyk7CiAgICAgICAgICAgICAgICBkb25lKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBodHRwUmVzcC5vbigncmVhZGFibGUnLCBmdW5jdGlvbiBvblJlYWRhYmxlKCkgewogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBodHRwUmVzcC5yZWFkKCk7CiAgICAgICAgICAgICAgICBpZiAoZGF0YSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgeyAvLyBsZWdhY3kgc3RyZWFtcyBBUEkKICAgICAgICAgICAgICBodHRwUmVzcC5vbignZGF0YScsIGZ1bmN0aW9uIG9uRGF0YShkYXRhKSB7CiAgICAgICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERhdGEnLCBbZGF0YSwgcmVzcF0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGh0dHBSZXNwLm9uKCdlbmQnLCBmdW5jdGlvbiBvbkVuZCgpIHsKICAgICAgICAgIGlmICghc3RyZWFtIHx8ICFzdHJlYW0uZGlkQ2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyICYmIChvcGVyYXRpb24uaGFzRXZlbnRPdXRwdXQgJiYgc2VydmljZS5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCkpKSB7CiAgICAgICAgICAgICAgLy8gZG9uJ3QgY29uY2F0ZW5hdGUgcmVzcG9uc2UgY2h1bmtzIHdoZW4gc3RyZWFtaW5nIGV2ZW50IHN0cmVhbSBkYXRhIHdoZW4gcmVzcG9uc2UgaXMgc3VjY2Vzc2Z1bAogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvbmUnKTsKICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBwcm9ncmVzcyhodHRwUmVzcCkgewogICAgICAgIGh0dHBSZXNwLm9uKCdzZW5kUHJvZ3Jlc3MnLCBmdW5jdGlvbiBvblNlbmRQcm9ncmVzcyh2YWx1ZSkgewogICAgICAgICAgcmVzcC5yZXF1ZXN0LmVtaXQoJ2h0dHBVcGxvYWRQcm9ncmVzcycsIFt2YWx1ZSwgcmVzcF0pOwogICAgICAgIH0pOwoKICAgICAgICBodHRwUmVzcC5vbigncmVjZWl2ZVByb2dyZXNzJywgZnVuY3Rpb24gb25SZWNlaXZlUHJvZ3Jlc3ModmFsdWUpIHsKICAgICAgICAgIHJlc3AucmVxdWVzdC5lbWl0KCdodHRwRG93bmxvYWRQcm9ncmVzcycsIFt2YWx1ZSwgcmVzcF0pOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBmdW5jdGlvbiBlcnJvcihlcnIpIHsKICAgICAgICBpZiAoZXJyLmNvZGUgIT09ICdSZXF1ZXN0QWJvcnRlZEVycm9yJykgewogICAgICAgICAgdmFyIGVyckNvZGUgPSBlcnIuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcicgPyBlcnIuY29kZSA6ICdOZXR3b3JraW5nRXJyb3InOwogICAgICAgICAgZXJyID0gQVdTLnV0aWwuZXJyb3IoZXJyLCB7CiAgICAgICAgICAgIGNvZGU6IGVyckNvZGUsCiAgICAgICAgICAgIHJlZ2lvbjogcmVzcC5yZXF1ZXN0Lmh0dHBSZXF1ZXN0LnJlZ2lvbiwKICAgICAgICAgICAgaG9zdG5hbWU6IHJlc3AucmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSwKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmVzcC5lcnJvciA9IGVycjsKICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cEVycm9yJywgW3Jlc3AuZXJyb3IsIHJlc3BdLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGRvbmUoKTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZXhlY3V0ZVNlbmQoKSB7CiAgICAgICAgdmFyIGh0dHAgPSBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSgpOwogICAgICAgIHZhciBodHRwT3B0aW9ucyA9IHJlc3AucmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5odHRwT3B0aW9ucyB8fCB7fTsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIHN0cmVhbSA9IGh0dHAuaGFuZGxlUmVxdWVzdChyZXNwLnJlcXVlc3QuaHR0cFJlcXVlc3QsIGh0dHBPcHRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaywgZXJyb3IpOwogICAgICAgICAgcHJvZ3Jlc3Moc3RyZWFtKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIGVycm9yKGVycik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciB0aW1lRGlmZiA9IChyZXNwLnJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIC0gdGhpcy5zaWduZWRBdCkgLyAxMDAwOwogICAgICBpZiAodGltZURpZmYgPj0gNjAgKiAxMCkgeyAvLyBpZiB3ZSBzaWduZWQgMTBtaW4gYWdvLCByZS1zaWduCiAgICAgICAgdGhpcy5lbWl0KCdzaWduJywgW3RoaXNdLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgICAgIGVsc2UgZXhlY3V0ZVNlbmQoKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBleGVjdXRlU2VuZCgpOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0hUVFBfSEVBREVSUycsICdodHRwSGVhZGVycycsCiAgICAgICAgZnVuY3Rpb24gSFRUUF9IRUFERVJTKHN0YXR1c0NvZGUsIGhlYWRlcnMsIHJlc3AsIHN0YXR1c01lc3NhZ2UpIHsKICAgICAgcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7CiAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c01lc3NhZ2UgPSBzdGF0dXNNZXNzYWdlOwogICAgICByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzID0gaGVhZGVyczsKICAgICAgcmVzcC5odHRwUmVzcG9uc2UuYm9keSA9IEFXUy51dGlsLmJ1ZmZlci50b0J1ZmZlcignJyk7CiAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMgPSBbXTsKICAgICAgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXMgPSAwOwogICAgICB2YXIgZGF0ZUhlYWRlciA9IGhlYWRlcnMuZGF0ZSB8fCBoZWFkZXJzLkRhdGU7CiAgICAgIHZhciBzZXJ2aWNlID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2U7CiAgICAgIGlmIChkYXRlSGVhZGVyKSB7CiAgICAgICAgdmFyIHNlcnZlclRpbWUgPSBEYXRlLnBhcnNlKGRhdGVIZWFkZXIpOwogICAgICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3CiAgICAgICAgICAgICYmIHNlcnZpY2UuaXNDbG9ja1NrZXdlZChzZXJ2ZXJUaW1lKSkgewogICAgICAgICAgc2VydmljZS5hcHBseUNsb2NrT2Zmc2V0KHNlcnZlclRpbWUpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgYWRkKCdIVFRQX0RBVEEnLCAnaHR0cERhdGEnLCBmdW5jdGlvbiBIVFRQX0RBVEEoY2h1bmssIHJlc3ApIHsKICAgICAgaWYgKGNodW5rKSB7CiAgICAgICAgaWYgKEFXUy51dGlsLmlzTm9kZSgpKSB7CiAgICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcyArPSBjaHVuay5sZW5ndGg7CgogICAgICAgICAgdmFyIHRvdGFsID0gcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1snY29udGVudC1sZW5ndGgnXTsKICAgICAgICAgIHZhciBwcm9ncmVzcyA9IHsgbG9hZGVkOiByZXNwLmh0dHBSZXNwb25zZS5udW1CeXRlcywgdG90YWw6IHRvdGFsIH07CiAgICAgICAgICByZXNwLnJlcXVlc3QuZW1pdCgnaHR0cERvd25sb2FkUHJvZ3Jlc3MnLCBbcHJvZ3Jlc3MsIHJlc3BdKTsKICAgICAgICB9CgogICAgICAgIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMucHVzaChBV1MudXRpbC5idWZmZXIudG9CdWZmZXIoY2h1bmspKTsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdIVFRQX0RPTkUnLCAnaHR0cERvbmUnLCBmdW5jdGlvbiBIVFRQX0RPTkUocmVzcCkgewogICAgICAvLyBjb252ZXJ0IGJ1ZmZlcnMgYXJyYXkgaW50byBzaW5nbGUgYnVmZmVyCiAgICAgIGlmIChyZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzICYmIHJlc3AuaHR0cFJlc3BvbnNlLmJ1ZmZlcnMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBib2R5ID0gQVdTLnV0aWwuYnVmZmVyLmNvbmNhdChyZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzKTsKICAgICAgICByZXNwLmh0dHBSZXNwb25zZS5ib2R5ID0gYm9keTsKICAgICAgfQogICAgICBkZWxldGUgcmVzcC5odHRwUmVzcG9uc2UubnVtQnl0ZXM7CiAgICAgIGRlbGV0ZSByZXNwLmh0dHBSZXNwb25zZS5idWZmZXJzOwogICAgfSk7CgogICAgYWRkKCdGSU5BTElaRV9FUlJPUicsICdyZXRyeScsIGZ1bmN0aW9uIEZJTkFMSVpFX0VSUk9SKHJlc3ApIHsKICAgICAgaWYgKHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUpIHsKICAgICAgICByZXNwLmVycm9yLnN0YXR1c0NvZGUgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIGlmIChyZXNwLmVycm9yLnJldHJ5YWJsZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRoaXMuc2VydmljZS5yZXRyeWFibGVFcnJvcihyZXNwLmVycm9yLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnSU5WQUxJREFURV9DUkVERU5USUFMUycsICdyZXRyeScsIGZ1bmN0aW9uIElOVkFMSURBVEVfQ1JFREVOVElBTFMocmVzcCkgewogICAgICBpZiAoIXJlc3AuZXJyb3IpIHJldHVybjsKICAgICAgc3dpdGNoIChyZXNwLmVycm9yLmNvZGUpIHsKICAgICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6IC8vIEVDMiBvbmx5CiAgICAgICAgY2FzZSAnRXhwaXJlZFRva2VuRXhjZXB0aW9uJzoKICAgICAgICBjYXNlICdFeHBpcmVkVG9rZW4nOgogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgICAgcmVzcC5yZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmV4cGlyZWQgPSB0cnVlOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ0VYUElSRURfU0lHTkFUVVJFJywgJ3JldHJ5JywgZnVuY3Rpb24gRVhQSVJFRF9TSUdOQVRVUkUocmVzcCkgewogICAgICB2YXIgZXJyID0gcmVzcC5lcnJvcjsKICAgICAgaWYgKCFlcnIpIHJldHVybjsKICAgICAgaWYgKHR5cGVvZiBlcnIuY29kZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIGVyci5tZXNzYWdlID09PSAnc3RyaW5nJykgewogICAgICAgIGlmIChlcnIuY29kZS5tYXRjaCgvU2lnbmF0dXJlLykgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL2V4cGlyZWQvKSkgewogICAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgYWRkKCdDTE9DS19TS0VXRUQnLCAncmV0cnknLCBmdW5jdGlvbiBDTE9DS19TS0VXRUQocmVzcCkgewogICAgICBpZiAoIXJlc3AuZXJyb3IpIHJldHVybjsKICAgICAgaWYgKHRoaXMuc2VydmljZS5jbG9ja1NrZXdFcnJvcihyZXNwLmVycm9yKQogICAgICAgICAgJiYgdGhpcy5zZXJ2aWNlLmNvbmZpZy5jb3JyZWN0Q2xvY2tTa2V3KSB7CiAgICAgICAgcmVzcC5lcnJvci5yZXRyeWFibGUgPSB0cnVlOwogICAgICB9CiAgICB9KTsKCiAgICBhZGQoJ1JFRElSRUNUJywgJ3JldHJ5JywgZnVuY3Rpb24gUkVESVJFQ1QocmVzcCkgewogICAgICBpZiAocmVzcC5lcnJvciAmJiByZXNwLmVycm9yLnN0YXR1c0NvZGUgPj0gMzAwICYmCiAgICAgICAgICByZXNwLmVycm9yLnN0YXR1c0NvZGUgPCA0MDAgJiYgcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1snbG9jYXRpb24nXSkgewogICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuZW5kcG9pbnQgPQogICAgICAgICAgbmV3IEFXUy5FbmRwb2ludChyZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWydsb2NhdGlvbiddKTsKICAgICAgICB0aGlzLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0hvc3QnXSA9IHRoaXMuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdDsKICAgICAgICByZXNwLmVycm9yLnJlZGlyZWN0ID0gdHJ1ZTsKICAgICAgICByZXNwLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZCgnUkVUUllfQ0hFQ0snLCAncmV0cnknLCBmdW5jdGlvbiBSRVRSWV9DSEVDSyhyZXNwKSB7CiAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgaWYgKHJlc3AuZXJyb3IucmVkaXJlY3QgJiYgcmVzcC5yZWRpcmVjdENvdW50IDwgcmVzcC5tYXhSZWRpcmVjdHMpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9IDA7CiAgICAgICAgfSBlbHNlIGlmIChyZXNwLnJldHJ5Q291bnQgPCByZXNwLm1heFJldHJpZXMpIHsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9IHRoaXMuc2VydmljZS5yZXRyeURlbGF5cyhyZXNwLnJldHJ5Q291bnQsIHJlc3AuZXJyb3IpIHx8IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBhZGRBc3luYygnUkVTRVRfUkVUUllfU1RBVEUnLCAnYWZ0ZXJSZXRyeScsIGZ1bmN0aW9uIFJFU0VUX1JFVFJZX1NUQVRFKHJlc3AsIGRvbmUpIHsKICAgICAgdmFyIGRlbGF5LCB3aWxsUmV0cnkgPSBmYWxzZTsKCiAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgZGVsYXkgPSByZXNwLmVycm9yLnJldHJ5RGVsYXkgfHwgMDsKICAgICAgICBpZiAocmVzcC5lcnJvci5yZXRyeWFibGUgJiYgcmVzcC5yZXRyeUNvdW50IDwgcmVzcC5tYXhSZXRyaWVzKSB7CiAgICAgICAgICByZXNwLnJldHJ5Q291bnQrKzsKICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmIChyZXNwLmVycm9yLnJlZGlyZWN0ICYmIHJlc3AucmVkaXJlY3RDb3VudCA8IHJlc3AubWF4UmVkaXJlY3RzKSB7CiAgICAgICAgICByZXNwLnJlZGlyZWN0Q291bnQrKzsKICAgICAgICAgIHdpbGxSZXRyeSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBkZWxheSA8IDAgaXMgYSBzaWduYWwgZnJvbSBjdXN0b21CYWNrb2ZmIHRvIHNraXAgcmV0cmllcwogICAgICBpZiAod2lsbFJldHJ5ICYmIGRlbGF5ID49IDApIHsKICAgICAgICByZXNwLmVycm9yID0gbnVsbDsKICAgICAgICBzZXRUaW1lb3V0KGRvbmUsIGRlbGF5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb25lKCk7CiAgICAgIH0KICAgIH0pOwogIH0pLAoKICBDb3JlUG9zdDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgYWRkKCdFWFRSQUNUX1JFUVVFU1RfSUQnLCAnZXh0cmFjdERhdGEnLCBBV1MudXRpbC5leHRyYWN0UmVxdWVzdElkKTsKICAgIGFkZCgnRVhUUkFDVF9SRVFVRVNUX0lEJywgJ2V4dHJhY3RFcnJvcicsIEFXUy51dGlsLmV4dHJhY3RSZXF1ZXN0SWQpOwoKICAgIGFkZCgnRU5PVEZPVU5EX0VSUk9SJywgJ2h0dHBFcnJvcicsIGZ1bmN0aW9uIEVOT1RGT1VORF9FUlJPUihlcnIpIHsKICAgICAgZnVuY3Rpb24gaXNETlNFcnJvcihlcnIpIHsKICAgICAgICByZXR1cm4gZXJyLmVycm5vID09PSAnRU5PVEZPVU5EJyB8fAogICAgICAgICAgdHlwZW9mIGVyci5lcnJubyA9PT0gJ251bWJlcicgJiYKICAgICAgICAgIHR5cGVvZiBBV1MudXRpbC5nZXRTeXN0ZW1FcnJvck5hbWUgPT09ICdmdW5jdGlvbicgJiYKICAgICAgICAgIFsnRUFJX05PTkFNRScsICdFQUlfTk9EQVRBJ10uaW5kZXhPZihBV1MudXRpbC5nZXRTeXN0ZW1FcnJvck5hbWUoZXJyLmVycm5vKSA+PSAwKTsKICAgICAgfQogICAgICBpZiAoZXJyLmNvZGUgPT09ICdOZXR3b3JraW5nRXJyb3InICYmIGlzRE5TRXJyb3IoZXJyKSkgewogICAgICAgIHZhciBtZXNzYWdlID0gJ0luYWNjZXNzaWJsZSBob3N0OiBgJyArIGVyci5ob3N0bmFtZSArICdcJyBhdCBwb3J0IGAnICsgZXJyLnBvcnQgKwogICAgICAgICAgJ1wnLiBUaGlzIHNlcnZpY2UgbWF5IG5vdCBiZSBhdmFpbGFibGUgaW4gdGhlIGAnICsgZXJyLnJlZ2lvbiArCiAgICAgICAgICAnXCcgcmVnaW9uLic7CiAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtZXNzYWdlKSwgewogICAgICAgICAgY29kZTogJ1Vua25vd25FbmRwb2ludCcsCiAgICAgICAgICByZWdpb246IGVyci5yZWdpb24sCiAgICAgICAgICBob3N0bmFtZTogZXJyLmhvc3RuYW1lLAogICAgICAgICAgcmV0cnlhYmxlOiB0cnVlLAogICAgICAgICAgb3JpZ2luYWxFcnJvcjogZXJyCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0pLAoKICBMb2dnZXI6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIGFkZCgnTE9HX1JFUVVFU1QnLCAnY29tcGxldGUnLCBmdW5jdGlvbiBMT0dfUkVRVUVTVChyZXNwKSB7CiAgICAgIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgICAgIHZhciBsb2dnZXIgPSByZXEuc2VydmljZS5jb25maWcubG9nZ2VyOwogICAgICBpZiAoIWxvZ2dlcikgcmV0dXJuOwogICAgICBmdW5jdGlvbiBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZSwgc2hhcGUpIHsKICAgICAgICBpZiAoIXNoYXBlKSB7CiAgICAgICAgICByZXR1cm4gc2hhcGU7CiAgICAgICAgfQogICAgICAgIGlmIChpbnB1dFNoYXBlLmlzU2Vuc2l0aXZlKSB7CiAgICAgICAgICByZXR1cm4gJyoqKlNlbnNpdGl2ZUluZm9ybWF0aW9uKioqJzsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChpbnB1dFNoYXBlLnR5cGUpIHsKICAgICAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6CiAgICAgICAgICAgIHZhciBzdHJ1Y3QgPSB7fTsKICAgICAgICAgICAgQVdTLnV0aWwuZWFjaChzaGFwZSwgZnVuY3Rpb24oc3ViU2hhcGVOYW1lLCBzdWJTaGFwZSkgewogICAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaW5wdXRTaGFwZS5tZW1iZXJzLCBzdWJTaGFwZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBzdHJ1Y3Rbc3ViU2hhcGVOYW1lXSA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLm1lbWJlcnNbc3ViU2hhcGVOYW1lXSwgc3ViU2hhcGUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHJ1Y3Rbc3ViU2hhcGVOYW1lXSA9IHN1YlNoYXBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBzdHJ1Y3Q7CiAgICAgICAgICBjYXNlICdsaXN0JzoKICAgICAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHNoYXBlLCBmdW5jdGlvbihzdWJTaGFwZSwgaW5kZXgpIHsKICAgICAgICAgICAgICBsaXN0LnB1c2goZmlsdGVyU2Vuc2l0aXZlTG9nKGlucHV0U2hhcGUubWVtYmVyLCBzdWJTaGFwZSkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgICAgICBjYXNlICdtYXAnOgogICAgICAgICAgICB2YXIgbWFwID0ge307CiAgICAgICAgICAgIEFXUy51dGlsLmVhY2goc2hhcGUsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICBtYXBba2V5XSA9IGZpbHRlclNlbnNpdGl2ZUxvZyhpbnB1dFNoYXBlLnZhbHVlLCB2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gYnVpbGRNZXNzYWdlKCkgewogICAgICAgIHZhciB0aW1lID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuZ2V0U2tld0NvcnJlY3RlZERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgdmFyIGRlbHRhID0gKHRpbWUgLSByZXEuc3RhcnRUaW1lLmdldFRpbWUoKSkgLyAxMDAwOwogICAgICAgIHZhciBhbnNpID0gbG9nZ2VyLmlzVFRZID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgIHZhciBzdGF0dXMgPSByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgICAgIHZhciBjZW5zb3JlZFBhcmFtcyA9IHJlcS5wYXJhbXM7CiAgICAgICAgaWYgKAogICAgICAgICAgcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnMgJiYKICAgICAgICAgICAgICByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXSAmJgogICAgICAgICAgICAgIHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0CiAgICAgICAgKSB7CiAgICAgICAgICB2YXIgaW5wdXRTaGFwZSA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLmlucHV0OwogICAgICAgICAgY2Vuc29yZWRQYXJhbXMgPSBmaWx0ZXJTZW5zaXRpdmVMb2coaW5wdXRTaGFwZSwgcmVxLnBhcmFtcyk7CiAgICAgICAgfQogICAgICAgIHZhciBwYXJhbXMgPSByZXF1aXJlKCd1dGlsJykuaW5zcGVjdChjZW5zb3JlZFBhcmFtcywgdHJ1ZSwgbnVsbCk7CiAgICAgICAgdmFyIG1lc3NhZ2UgPSAnJzsKICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlszM20nOwogICAgICAgIG1lc3NhZ2UgKz0gJ1tBV1MgJyArIHJlcS5zZXJ2aWNlLnNlcnZpY2VJZGVudGlmaWVyICsgJyAnICsgc3RhdHVzOwogICAgICAgIG1lc3NhZ2UgKz0gJyAnICsgZGVsdGEudG9TdHJpbmcoKSArICdzICcgKyByZXNwLnJldHJ5Q291bnQgKyAnIHJldHJpZXNdJzsKICAgICAgICBpZiAoYW5zaSkgbWVzc2FnZSArPSAnXHgxQlswOzFtJzsKICAgICAgICBtZXNzYWdlICs9ICcgJyArIEFXUy51dGlsLnN0cmluZy5sb3dlckZpcnN0KHJlcS5vcGVyYXRpb24pOwogICAgICAgIG1lc3NhZ2UgKz0gJygnICsgcGFyYW1zICsgJyknOwogICAgICAgIGlmIChhbnNpKSBtZXNzYWdlICs9ICdceDFCWzBtJzsKICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgfQoKICAgICAgdmFyIGxpbmUgPSBidWlsZE1lc3NhZ2UoKTsKICAgICAgaWYgKHR5cGVvZiBsb2dnZXIubG9nID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgbG9nZ2VyLmxvZyhsaW5lKTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbG9nZ2VyLndyaXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgbG9nZ2VyLndyaXRlKGxpbmUgKyAnXG4nKTsKICAgICAgfQogICAgfSk7CiAgfSksCgogIEpzb246IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL2pzb24nKTsKICAgIGFkZCgnQlVJTEQnLCAnYnVpbGQnLCBzdmMuYnVpbGRSZXF1ZXN0KTsKICAgIGFkZCgnRVhUUkFDVF9EQVRBJywgJ2V4dHJhY3REYXRhJywgc3ZjLmV4dHJhY3REYXRhKTsKICAgIGFkZCgnRVhUUkFDVF9FUlJPUicsICdleHRyYWN0RXJyb3InLCBzdmMuZXh0cmFjdEVycm9yKTsKICB9KSwKCiAgUmVzdDogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdCcpOwogICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogIH0pLAoKICBSZXN0SnNvbjogbmV3IFNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgdmFyIHN2YyA9IHJlcXVpcmUoJy4vcHJvdG9jb2wvcmVzdF9qc29uJyk7CiAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgfSksCgogIFJlc3RYbWw6IG5ldyBTZXF1ZW50aWFsRXhlY3V0b3IoKS5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgIHZhciBzdmMgPSByZXF1aXJlKCcuL3Byb3RvY29sL3Jlc3RfeG1sJyk7CiAgICBhZGQoJ0JVSUxEJywgJ2J1aWxkJywgc3ZjLmJ1aWxkUmVxdWVzdCk7CiAgICBhZGQoJ0VYVFJBQ1RfREFUQScsICdleHRyYWN0RGF0YScsIHN2Yy5leHRyYWN0RGF0YSk7CiAgICBhZGQoJ0VYVFJBQ1RfRVJST1InLCAnZXh0cmFjdEVycm9yJywgc3ZjLmV4dHJhY3RFcnJvcik7CiAgfSksCgogIFF1ZXJ5OiBuZXcgU2VxdWVudGlhbEV4ZWN1dG9yKCkuYWRkTmFtZWRMaXN0ZW5lcnMoZnVuY3Rpb24oYWRkKSB7CiAgICB2YXIgc3ZjID0gcmVxdWlyZSgnLi9wcm90b2NvbC9xdWVyeScpOwogICAgYWRkKCdCVUlMRCcsICdidWlsZCcsIHN2Yy5idWlsZFJlcXVlc3QpOwogICAgYWRkKCdFWFRSQUNUX0RBVEEnLCAnZXh0cmFjdERhdGEnLCBzdmMuZXh0cmFjdERhdGEpOwogICAgYWRkKCdFWFRSQUNUX0VSUk9SJywgJ2V4dHJhY3RFcnJvcicsIHN2Yy5leHRyYWN0RXJyb3IpOwogIH0pCn07Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2NvcmUiOjE5LCIuL2Rpc2NvdmVyX2VuZHBvaW50IjoyNywiLi9wcm90b2NvbC9qc29uIjo0NywiLi9wcm90b2NvbC9xdWVyeSI6NDgsIi4vcHJvdG9jb2wvcmVzdCI6NDksIi4vcHJvdG9jb2wvcmVzdF9qc29uIjo1MCwiLi9wcm90b2NvbC9yZXN0X3htbCI6NTEsIi4vc2VxdWVudGlhbF9leGVjdXRvciI6NjAsIl9wcm9jZXNzIjo4OSwidXRpbCI6ODN9XSwzNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKLyoqCiAqIFRoZSBlbmRwb2ludCB0aGF0IGEgc2VydmljZSB3aWxsIHRhbGsgdG8sIGZvciBleGFtcGxlLAogKiBgJ2h0dHBzOi8vZWMyLmFwLXNvdXRoZWFzdC0xLmFtYXpvbmF3cy5jb20nYC4gSWYKICogeW91IG5lZWQgdG8gb3ZlcnJpZGUgYW4gZW5kcG9pbnQgZm9yIGEgc2VydmljZSwgeW91IGNhbgogKiBzZXQgdGhlIGVuZHBvaW50IG9uIGEgc2VydmljZSBieSBwYXNzaW5nIHRoZSBlbmRwb2ludAogKiBvYmplY3Qgd2l0aCB0aGUgYGVuZHBvaW50YCBvcHRpb24ga2V5OgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIHZhciBlcCA9IG5ldyBBV1MuRW5kcG9pbnQoJ2F3c3Byb3h5LmV4YW1wbGUuY29tJyk7CiAqIHZhciBzMyA9IG5ldyBBV1MuUzMoe2VuZHBvaW50OiBlcH0pOwogKiBzMy5zZXJ2aWNlLmVuZHBvaW50Lmhvc3RuYW1lID09ICdhd3Nwcm94eS5leGFtcGxlLmNvbScKICogYGBgCiAqCiAqIE5vdGUgdGhhdCBpZiB5b3UgZG8gbm90IHNwZWNpZnkgYSBwcm90b2NvbCwgdGhlIHByb3RvY29sIHdpbGwKICogYmUgc2VsZWN0ZWQgYmFzZWQgb24geW91ciBjdXJyZW50IHtBV1MuY29uZmlnfSBjb25maWd1cmF0aW9uLgogKgogKiBAIWF0dHJpYnV0ZSBwcm90b2NvbAogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHByb3RvY29sIChodHRwIG9yIGh0dHBzKSBvZiB0aGUgZW5kcG9pbnQKICogICAgIFVSTAogKiBAIWF0dHJpYnV0ZSBob3N0bmFtZQogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIGhvc3QgcG9ydGlvbiBvZiB0aGUgZW5kcG9pbnQsIGUuZy4sCiAqICAgICBleGFtcGxlLmNvbQogKiBAIWF0dHJpYnV0ZSBob3N0CiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgaG9zdCBwb3J0aW9uIG9mIHRoZSBlbmRwb2ludCBpbmNsdWRpbmcKICogICAgIHRoZSBwb3J0LCBlLmcuLCBleGFtcGxlLmNvbTo4MAogKiBAIWF0dHJpYnV0ZSBwb3J0CiAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIHBvcnQgb2YgdGhlIGVuZHBvaW50CiAqIEAhYXR0cmlidXRlIGhyZWYKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBmdWxsIFVSTCBvZiB0aGUgZW5kcG9pbnQKICovCkFXUy5FbmRwb2ludCA9IGluaGVyaXQoewoKICAvKioKICAgKiBAb3ZlcmxvYWQgRW5kcG9pbnQoZW5kcG9pbnQpCiAgICogICBDb25zdHJ1Y3RzIGEgbmV3IGVuZHBvaW50IGdpdmVuIGFuIGVuZHBvaW50IFVSTC4gSWYgdGhlCiAgICogICBVUkwgb21pdHMgYSBwcm90b2NvbCAoaHR0cCBvciBodHRwcyksIHRoZSBkZWZhdWx0IHByb3RvY29sCiAgICogICBzZXQgaW4gdGhlIGdsb2JhbCB7QVdTLmNvbmZpZ30gd2lsbCBiZSB1c2VkLgogICAqICAgQHBhcmFtIGVuZHBvaW50IFtTdHJpbmddIHRoZSBVUkwgdG8gY29uc3RydWN0IGFuIGVuZHBvaW50IGZyb20KICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gRW5kcG9pbnQoZW5kcG9pbnQsIGNvbmZpZykgewogICAgQVdTLnV0aWwuaGlkZVByb3BlcnRpZXModGhpcywgWydzbGFzaGVzJywgJ2F1dGgnLCAnaGFzaCcsICdzZWFyY2gnLCAncXVlcnknXSk7CgogICAgaWYgKHR5cGVvZiBlbmRwb2ludCA9PT0gJ3VuZGVmaW5lZCcgfHwgZW5kcG9pbnQgPT09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGVuZHBvaW50OiAnICsgZW5kcG9pbnQpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgZW5kcG9pbnQgIT09ICdzdHJpbmcnKSB7CiAgICAgIHJldHVybiBBV1MudXRpbC5jb3B5KGVuZHBvaW50KTsKICAgIH0KCiAgICBpZiAoIWVuZHBvaW50Lm1hdGNoKC9eaHR0cC8pKSB7CiAgICAgIHZhciB1c2VTU0wgPSBjb25maWcgJiYgY29uZmlnLnNzbEVuYWJsZWQgIT09IHVuZGVmaW5lZCA/CiAgICAgICAgY29uZmlnLnNzbEVuYWJsZWQgOiBBV1MuY29uZmlnLnNzbEVuYWJsZWQ7CiAgICAgIGVuZHBvaW50ID0gKHVzZVNTTCA/ICdodHRwcycgOiAnaHR0cCcpICsgJzovLycgKyBlbmRwb2ludDsKICAgIH0KCiAgICBBV1MudXRpbC51cGRhdGUodGhpcywgQVdTLnV0aWwudXJsUGFyc2UoZW5kcG9pbnQpKTsKCiAgICAvLyBFbnN1cmUgdGhlIHBvcnQgcHJvcGVydHkgaXMgc2V0IGFzIGFuIGludGVnZXIKICAgIGlmICh0aGlzLnBvcnQpIHsKICAgICAgdGhpcy5wb3J0ID0gcGFyc2VJbnQodGhpcy5wb3J0LCAxMCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnBvcnQgPSB0aGlzLnByb3RvY29sID09PSAnaHR0cHM6JyA/IDQ0MyA6IDgwOwogICAgfQogIH0KCn0pOwoKLyoqCiAqIFRoZSBsb3cgbGV2ZWwgSFRUUCByZXF1ZXN0IG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICogYW5kIGJvZHkgZGF0YSBzZW50IGJ5IGEgc2VydmljZSByZXF1ZXN0LgogKgogKiBAIWF0dHJpYnV0ZSBtZXRob2QKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSBIVFRQIG1ldGhvZCBvZiB0aGUgcmVxdWVzdAogKiBAIWF0dHJpYnV0ZSBwYXRoCiAqICAgQHJldHVybiBbU3RyaW5nXSB0aGUgcGF0aCBwb3J0aW9uIG9mIHRoZSBVUkksIGUuZy4sCiAqICAgICAiL2xpc3QvP3N0YXJ0PTUmbnVtPTEwIgogKiBAIWF0dHJpYnV0ZSBoZWFkZXJzCiAqICAgQHJldHVybiBbbWFwPFN0cmluZyxTdHJpbmc+XQogKiAgICAgYSBtYXAgb2YgaGVhZGVyIGtleXMgYW5kIHRoZWlyIHJlc3BlY3RpdmUgdmFsdWVzCiAqIEAhYXR0cmlidXRlIGJvZHkKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZXF1ZXN0IGJvZHkgcGF5bG9hZAogKiBAIWF0dHJpYnV0ZSBlbmRwb2ludAogKiAgIEByZXR1cm4gW0FXUy5FbmRwb2ludF0gdGhlIGVuZHBvaW50IGZvciB0aGUgcmVxdWVzdAogKiBAIWF0dHJpYnV0ZSByZWdpb24KICogICBAYXBpIHByaXZhdGUKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSByZWdpb24sIGZvciBzaWduaW5nIHB1cnBvc2VzIG9ubHkuCiAqLwpBV1MuSHR0cFJlcXVlc3QgPSBpbmhlcml0KHsKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIEh0dHBSZXF1ZXN0KGVuZHBvaW50LCByZWdpb24pIHsKICAgIGVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludCk7CiAgICB0aGlzLm1ldGhvZCA9ICdQT1NUJzsKICAgIHRoaXMucGF0aCA9IGVuZHBvaW50LnBhdGggfHwgJy8nOwogICAgdGhpcy5oZWFkZXJzID0ge307CiAgICB0aGlzLmJvZHkgPSAnJzsKICAgIHRoaXMuZW5kcG9pbnQgPSBlbmRwb2ludDsKICAgIHRoaXMucmVnaW9uID0gcmVnaW9uOwogICAgdGhpcy5fdXNlckFnZW50ID0gJyc7CiAgICB0aGlzLnNldFVzZXJBZ2VudCgpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNldFVzZXJBZ2VudDogZnVuY3Rpb24gc2V0VXNlckFnZW50KCkgewogICAgdGhpcy5fdXNlckFnZW50ID0gdGhpcy5oZWFkZXJzW3RoaXMuZ2V0VXNlckFnZW50SGVhZGVyTmFtZSgpXSA9IEFXUy51dGlsLnVzZXJBZ2VudCgpOwogIH0sCgogIGdldFVzZXJBZ2VudEhlYWRlck5hbWU6IGZ1bmN0aW9uIGdldFVzZXJBZ2VudEhlYWRlck5hbWUoKSB7CiAgICB2YXIgcHJlZml4ID0gQVdTLnV0aWwuaXNCcm93c2VyKCkgPyAnWC1BbXotJyA6ICcnOwogICAgcmV0dXJuIHByZWZpeCArICdVc2VyLUFnZW50JzsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhcHBlbmRUb1VzZXJBZ2VudDogZnVuY3Rpb24gYXBwZW5kVG9Vc2VyQWdlbnQoYWdlbnRQYXJ0aWFsKSB7CiAgICBpZiAodHlwZW9mIGFnZW50UGFydGlhbCA9PT0gJ3N0cmluZycgJiYgYWdlbnRQYXJ0aWFsKSB7CiAgICAgIHRoaXMuX3VzZXJBZ2VudCArPSAnICcgKyBhZ2VudFBhcnRpYWw7CiAgICB9CiAgICB0aGlzLmhlYWRlcnNbdGhpcy5nZXRVc2VyQWdlbnRIZWFkZXJOYW1lKCldID0gdGhpcy5fdXNlckFnZW50OwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldFVzZXJBZ2VudDogZnVuY3Rpb24gZ2V0VXNlckFnZW50KCkgewogICAgcmV0dXJuIHRoaXMuX3VzZXJBZ2VudDsKICB9LAoKICAvKioKICAgKiBAcmV0dXJuIFtTdHJpbmddIHRoZSBwYXJ0IG9mIHRoZSB7cGF0aH0gZXhjbHVkaW5nIHRoZQogICAqICAgcXVlcnkgc3RyaW5nCiAgICovCiAgcGF0aG5hbWU6IGZ1bmN0aW9uIHBhdGhuYW1lKCkgewogICAgcmV0dXJuIHRoaXMucGF0aC5zcGxpdCgnPycsIDEpWzBdOwogIH0sCgogIC8qKgogICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIHF1ZXJ5IHN0cmluZyBwb3J0aW9uIG9mIHRoZSB7cGF0aH0KICAgKi8KICBzZWFyY2g6IGZ1bmN0aW9uIHNlYXJjaCgpIHsKICAgIHZhciBxdWVyeSA9IHRoaXMucGF0aC5zcGxpdCgnPycsIDIpWzFdOwogICAgaWYgKHF1ZXJ5KSB7CiAgICAgIHF1ZXJ5ID0gQVdTLnV0aWwucXVlcnlTdHJpbmdQYXJzZShxdWVyeSk7CiAgICAgIHJldHVybiBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHF1ZXJ5KTsKICAgIH0KICAgIHJldHVybiAnJzsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiB1cGRhdGUgaHR0cFJlcXVlc3QgZW5kcG9pbnQgd2l0aCBlbmRwb2ludCBzdHJpbmcKICAgKi8KICB1cGRhdGVFbmRwb2ludDogZnVuY3Rpb24gdXBkYXRlRW5kcG9pbnQoZW5kcG9pbnRTdHIpIHsKICAgIHZhciBuZXdFbmRwb2ludCA9IG5ldyBBV1MuRW5kcG9pbnQoZW5kcG9pbnRTdHIpOwogICAgdGhpcy5lbmRwb2ludCA9IG5ld0VuZHBvaW50OwogICAgdGhpcy5wYXRoID0gbmV3RW5kcG9pbnQucGF0aCB8fCAnLyc7CiAgICBpZiAodGhpcy5oZWFkZXJzWydIb3N0J10pIHsKICAgICAgdGhpcy5oZWFkZXJzWydIb3N0J10gPSBuZXdFbmRwb2ludC5ob3N0OwogICAgfQogIH0KfSk7CgovKioKICogVGhlIGxvdyBsZXZlbCBIVFRQIHJlc3BvbnNlIG9iamVjdCwgZW5jYXBzdWxhdGluZyBhbGwgSFRUUCBoZWFkZXIKICogYW5kIGJvZHkgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogKgogKiBAIWF0dHJpYnV0ZSBzdGF0dXNDb2RlCiAqICAgQHJldHVybiBbSW50ZWdlcl0gdGhlIEhUVFAgc3RhdHVzIGNvZGUgb2YgdGhlIHJlc3BvbnNlIChlLmcuLCAyMDAsIDQwNCkKICogQCFhdHRyaWJ1dGUgaGVhZGVycwogKiAgIEByZXR1cm4gW21hcDxTdHJpbmcsU3RyaW5nPl0KICogICAgICBhIG1hcCBvZiByZXNwb25zZSBoZWFkZXIga2V5cyBhbmQgdGhlaXIgcmVzcGVjdGl2ZSB2YWx1ZXMKICogQCFhdHRyaWJ1dGUgYm9keQogKiAgIEByZXR1cm4gW1N0cmluZ10gdGhlIHJlc3BvbnNlIGJvZHkgcGF5bG9hZAogKiBAIWF0dHJpYnV0ZSBbcl0gc3RyZWFtaW5nCiAqICAgQHJldHVybiBbQm9vbGVhbl0gd2hldGhlciB0aGlzIHJlc3BvbnNlIGlzIGJlaW5nIHN0cmVhbWVkIGF0IGEgbG93LWxldmVsLgogKiAgICAgRGVmYXVsdHMgdG8gYGZhbHNlYCAoYnVmZmVyZWQgcmVhZHMpLiBEbyBub3QgbW9kaWZ5IHRoaXMgbWFudWFsbHksIHVzZQogKiAgICAge2NyZWF0ZVVuYnVmZmVyZWRTdHJlYW19IHRvIGNvbnZlcnQgdGhlIHN0cmVhbSB0byB1bmJ1ZmZlcmVkIG1vZGUKICogICAgIGluc3RlYWQuCiAqLwpBV1MuSHR0cFJlc3BvbnNlID0gaW5oZXJpdCh7CgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBIdHRwUmVzcG9uc2UoKSB7CiAgICB0aGlzLnN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgIHRoaXMuYm9keSA9IHVuZGVmaW5lZDsKICAgIHRoaXMuc3RyZWFtaW5nID0gZmFsc2U7CiAgICB0aGlzLnN0cmVhbSA9IG51bGw7CiAgfSwKCiAgLyoqCiAgICogRGlzYWJsZXMgYnVmZmVyaW5nIG9uIHRoZSBIVFRQIHJlc3BvbnNlIGFuZCByZXR1cm5zIHRoZSBzdHJlYW0gZm9yIHJlYWRpbmcuCiAgICogQHJldHVybiBbU3RyZWFtLCBYTUxIdHRwUmVxdWVzdCwgbnVsbF0gdGhlIHVuZGVybHlpbmcgc3RyZWFtIG9iamVjdC4KICAgKiAgIFVzZSB0aGlzIG9iamVjdCB0byBkaXJlY3RseSByZWFkIGRhdGEgb2ZmIG9mIHRoZSBzdHJlYW0uCiAgICogQG5vdGUgVGhpcyBvYmplY3QgaXMgb25seSBhdmFpbGFibGUgYWZ0ZXIgdGhlIHtBV1MuUmVxdWVzdH5odHRwSGVhZGVyc30KICAgKiAgIGV2ZW50IGhhcyBmaXJlZC4gVGhpcyBtZXRob2QgbXVzdCBiZSBjYWxsZWQgcHJpb3IgdG8KICAgKiAgIHtBV1MuUmVxdWVzdH5odHRwRGF0YX0uCiAgICogQGV4YW1wbGUgVGFraW5nIGNvbnRyb2wgb2YgYSBzdHJlYW0KICAgKiAgIHJlcXVlc3Qub24oJ2h0dHBIZWFkZXJzJywgZnVuY3Rpb24oc3RhdHVzQ29kZSwgaGVhZGVycykgewogICAqICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAqICAgICAgIGlmIChoZWFkZXJzLmV0YWcgPT09ICd4eXonKSB7CiAgICogICAgICAgICAvLyBwaXBlIHRoZSBzdHJlYW0sIGRpc2FibGluZyBidWZmZXJpbmcKICAgKiAgICAgICAgIHZhciBzdHJlYW0gPSB0aGlzLnJlc3BvbnNlLmh0dHBSZXNwb25zZS5jcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtKCk7CiAgICogICAgICAgICBzdHJlYW0ucGlwZShwcm9jZXNzLnN0ZG91dCk7CiAgICogICAgICAgfSBlbHNlIHsgLy8gYWJvcnQgdGhpcyByZXF1ZXN0IGFuZCBzZXQgYSBiZXR0ZXIgZXJyb3IgbWVzc2FnZQogICAqICAgICAgICAgdGhpcy5hYm9ydCgpOwogICAqICAgICAgICAgdGhpcy5yZXNwb25zZS5lcnJvciA9IG5ldyBFcnJvcignSW52YWxpZCBFVGFnJyk7CiAgICogICAgICAgfQogICAqICAgICB9CiAgICogICB9KS5zZW5kKGNvbnNvbGUubG9nKTsKICAgKi8KICBjcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtOiBmdW5jdGlvbiBjcmVhdGVVbmJ1ZmZlcmVkU3RyZWFtKCkgewogICAgdGhpcy5zdHJlYW1pbmcgPSB0cnVlOwogICAgcmV0dXJuIHRoaXMuc3RyZWFtOwogIH0KfSk7CgoKQVdTLkh0dHBDbGllbnQgPSBpbmhlcml0KHt9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5IdHRwQ2xpZW50LmdldEluc3RhbmNlID0gZnVuY3Rpb24gZ2V0SW5zdGFuY2UoKSB7CiAgaWYgKHRoaXMuc2luZ2xldG9uID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXMuc2luZ2xldG9uID0gbmV3IHRoaXMoKTsKICB9CiAgcmV0dXJuIHRoaXMuc2luZ2xldG9uOwp9OwoKfSx7Ii4vY29yZSI6MTl9XSwzNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CnJlcXVpcmUoJy4uL2h0dHAnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5YSFJDbGllbnQgPSBBV1MudXRpbC5pbmhlcml0KHsKICBoYW5kbGVSZXF1ZXN0OiBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0KGh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywgY2FsbGJhY2ssIGVyckNhbGxiYWNrKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgZW5kcG9pbnQgPSBodHRwUmVxdWVzdC5lbmRwb2ludDsKICAgIHZhciBlbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpOwogICAgdmFyIGhyZWYgPSBlbmRwb2ludC5wcm90b2NvbCArICcvLycgKyBlbmRwb2ludC5ob3N0bmFtZTsKICAgIGlmIChlbmRwb2ludC5wb3J0ICE9PSA4MCAmJiBlbmRwb2ludC5wb3J0ICE9PSA0NDMpIHsKICAgICAgaHJlZiArPSAnOicgKyBlbmRwb2ludC5wb3J0OwogICAgfQogICAgaHJlZiArPSBodHRwUmVxdWVzdC5wYXRoOwoKICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKSwgaGVhZGVyc0VtaXR0ZWQgPSBmYWxzZTsKICAgIGh0dHBSZXF1ZXN0LnN0cmVhbSA9IHhocjsKCiAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAwKSByZXR1cm47IC8vIDAgY29kZSBpcyBpbnZhbGlkCiAgICAgIH0gY2F0Y2ggKGUpIHsgcmV0dXJuOyB9CgogICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID49IHRoaXMuSEVBREVSU19SRUNFSVZFRCAmJiAhaGVhZGVyc0VtaXR0ZWQpIHsKICAgICAgICBlbWl0dGVyLnN0YXR1c0NvZGUgPSB4aHIuc3RhdHVzOwogICAgICAgIGVtaXR0ZXIuaGVhZGVycyA9IHNlbGYucGFyc2VIZWFkZXJzKHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSk7CiAgICAgICAgZW1pdHRlci5lbWl0KAogICAgICAgICAgJ2hlYWRlcnMnLAogICAgICAgICAgZW1pdHRlci5zdGF0dXNDb2RlLAogICAgICAgICAgZW1pdHRlci5oZWFkZXJzLAogICAgICAgICAgeGhyLnN0YXR1c1RleHQKICAgICAgICApOwogICAgICAgIGhlYWRlcnNFbWl0dGVkID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAodGhpcy5yZWFkeVN0YXRlID09PSB0aGlzLkRPTkUpIHsKICAgICAgICBzZWxmLmZpbmlzaFJlcXVlc3QoeGhyLCBlbWl0dGVyKTsKICAgICAgfQogICAgfSwgZmFsc2UpOwogICAgeGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgZW1pdHRlci5lbWl0KCdzZW5kUHJvZ3Jlc3MnLCBldnQpOwogICAgfSk7CiAgICB4aHIuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgIGVtaXR0ZXIuZW1pdCgncmVjZWl2ZVByb2dyZXNzJywgZXZ0KTsKICAgIH0sIGZhbHNlKTsKICAgIHhoci5hZGRFdmVudExpc3RlbmVyKCd0aW1lb3V0JywgZnVuY3Rpb24gKCkgewogICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1RpbWVvdXQnKSwge2NvZGU6ICdUaW1lb3V0RXJyb3InfSkpOwogICAgfSwgZmFsc2UpOwogICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZnVuY3Rpb24gKCkgewogICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ05ldHdvcmsgRmFpbHVyZScpLCB7CiAgICAgICAgY29kZTogJ05ldHdvcmtpbmdFcnJvcicKICAgICAgfSkpOwogICAgfSwgZmFsc2UpOwogICAgeGhyLmFkZEV2ZW50TGlzdGVuZXIoJ2Fib3J0JywgZnVuY3Rpb24gKCkgewogICAgICBlcnJDYWxsYmFjayhBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoJ1JlcXVlc3QgYWJvcnRlZCcpLCB7CiAgICAgICAgY29kZTogJ1JlcXVlc3RBYm9ydGVkRXJyb3InCiAgICAgIH0pKTsKICAgIH0sIGZhbHNlKTsKCiAgICBjYWxsYmFjayhlbWl0dGVyKTsKICAgIHhoci5vcGVuKGh0dHBSZXF1ZXN0Lm1ldGhvZCwgaHJlZiwgaHR0cE9wdGlvbnMueGhyQXN5bmMgIT09IGZhbHNlKTsKICAgIEFXUy51dGlsLmVhY2goaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGtleSAhPT0gJ0NvbnRlbnQtTGVuZ3RoJyAmJiBrZXkgIT09ICdVc2VyLUFnZW50JyAmJiBrZXkgIT09ICdIb3N0JykgewogICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAoaHR0cE9wdGlvbnMudGltZW91dCAmJiBodHRwT3B0aW9ucy54aHJBc3luYyAhPT0gZmFsc2UpIHsKICAgICAgeGhyLnRpbWVvdXQgPSBodHRwT3B0aW9ucy50aW1lb3V0OwogICAgfQoKICAgIGlmIChodHRwT3B0aW9ucy54aHJXaXRoQ3JlZGVudGlhbHMpIHsKICAgICAgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CiAgICB9CiAgICB0cnkgeyB4aHIucmVzcG9uc2VUeXBlID0gJ2FycmF5YnVmZmVyJzsgfSBjYXRjaCAoZSkge30KCiAgICB0cnkgewogICAgICBpZiAoaHR0cFJlcXVlc3QuYm9keSkgewogICAgICAgIHhoci5zZW5kKGh0dHBSZXF1ZXN0LmJvZHkpOwogICAgICB9IGVsc2UgewogICAgICAgIHhoci5zZW5kKCk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICBpZiAoaHR0cFJlcXVlc3QuYm9keSAmJiB0eXBlb2YgaHR0cFJlcXVlc3QuYm9keS5idWZmZXIgPT09ICdvYmplY3QnKSB7CiAgICAgICAgeGhyLnNlbmQoaHR0cFJlcXVlc3QuYm9keS5idWZmZXIpOyAvLyBzZW5kIEFycmF5QnVmZmVyIGRpcmVjdGx5CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGVtaXR0ZXI7CiAgfSwKCiAgcGFyc2VIZWFkZXJzOiBmdW5jdGlvbiBwYXJzZUhlYWRlcnMocmF3SGVhZGVycykgewogICAgdmFyIGhlYWRlcnMgPSB7fTsKICAgIEFXUy51dGlsLmFycmF5RWFjaChyYXdIZWFkZXJzLnNwbGl0KC9ccj9cbi8pLCBmdW5jdGlvbiAobGluZSkgewogICAgICB2YXIga2V5ID0gbGluZS5zcGxpdCgnOicsIDEpWzBdOwogICAgICB2YXIgdmFsdWUgPSBsaW5lLnN1YnN0cmluZyhrZXkubGVuZ3RoICsgMik7CiAgICAgIGlmIChrZXkubGVuZ3RoID4gMCkgaGVhZGVyc1trZXkudG9Mb3dlckNhc2UoKV0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIGhlYWRlcnM7CiAgfSwKCiAgZmluaXNoUmVxdWVzdDogZnVuY3Rpb24gZmluaXNoUmVxdWVzdCh4aHIsIGVtaXR0ZXIpIHsKICAgIHZhciBidWZmZXI7CiAgICBpZiAoeGhyLnJlc3BvbnNlVHlwZSA9PT0gJ2FycmF5YnVmZmVyJyAmJiB4aHIucmVzcG9uc2UpIHsKICAgICAgdmFyIGFiID0geGhyLnJlc3BvbnNlOwogICAgICBidWZmZXIgPSBuZXcgQVdTLnV0aWwuQnVmZmVyKGFiLmJ5dGVMZW5ndGgpOwogICAgICB2YXIgdmlldyA9IG5ldyBVaW50OEFycmF5KGFiKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidWZmZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICBidWZmZXJbaV0gPSB2aWV3W2ldOwogICAgICB9CiAgICB9CgogICAgdHJ5IHsKICAgICAgaWYgKCFidWZmZXIgJiYgdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgYnVmZmVyID0gbmV3IEFXUy51dGlsLkJ1ZmZlcih4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkge30KCiAgICBpZiAoYnVmZmVyKSBlbWl0dGVyLmVtaXQoJ2RhdGEnLCBidWZmZXIpOwogICAgZW1pdHRlci5lbWl0KCdlbmQnKTsKICB9Cn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLkh0dHBDbGllbnQucHJvdG90eXBlID0gQVdTLlhIUkNsaWVudC5wcm90b3R5cGU7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9IDE7Cgp9LHsiLi4vY29yZSI6MTksIi4uL2h0dHAiOjM1LCJldmVudHMiOjg1fV0sMzc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKCmZ1bmN0aW9uIEpzb25CdWlsZGVyKCkgeyB9CgpKc29uQnVpbGRlci5wcm90b3R5cGUuYnVpbGQgPSBmdW5jdGlvbih2YWx1ZSwgc2hhcGUpIHsKICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkpOwp9OwoKZnVuY3Rpb24gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZSkgewogIGlmICghc2hhcGUgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKCiAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gdHJhbnNsYXRlU3RydWN0dXJlKHZhbHVlLCBzaGFwZSk7CiAgICBjYXNlICdtYXAnOiByZXR1cm4gdHJhbnNsYXRlTWFwKHZhbHVlLCBzaGFwZSk7CiAgICBjYXNlICdsaXN0JzogcmV0dXJuIHRyYW5zbGF0ZUxpc3QodmFsdWUsIHNoYXBlKTsKICAgIGRlZmF1bHQ6IHJldHVybiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKTsKICB9Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZVN0cnVjdHVyZShzdHJ1Y3R1cmUsIHNoYXBlKSB7CiAgaWYgKHNoYXBlLmlzRG9jdW1lbnQpIHsKICAgIHJldHVybiBzdHJ1Y3R1cmU7CiAgfQogIHZhciBzdHJ1Y3QgPSB7fTsKICB1dGlsLmVhY2goc3RydWN0dXJlLCBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1tuYW1lXTsKICAgIGlmIChtZW1iZXJTaGFwZSkgewogICAgICBpZiAobWVtYmVyU2hhcGUubG9jYXRpb24gIT09ICdib2R5JykgcmV0dXJuOwogICAgICB2YXIgbG9jYXRpb25OYW1lID0gbWVtYmVyU2hhcGUuaXNMb2NhdGlvbk5hbWUgPyBtZW1iZXJTaGFwZS5uYW1lIDogbmFtZTsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHN0cnVjdFtsb2NhdGlvbk5hbWVdID0gcmVzdWx0OwogICAgfQogIH0pOwogIHJldHVybiBzdHJ1Y3Q7Cn0KCmZ1bmN0aW9uIHRyYW5zbGF0ZUxpc3QobGlzdCwgc2hhcGUpIHsKICB2YXIgb3V0ID0gW107CiAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24odmFsdWUpIHsKICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIG91dC5wdXNoKHJlc3VsdCk7CiAgfSk7CiAgcmV0dXJuIG91dDsKfQoKZnVuY3Rpb24gdHJhbnNsYXRlTWFwKG1hcCwgc2hhcGUpIHsKICB2YXIgb3V0ID0ge307CiAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkKSBvdXRba2V5XSA9IHJlc3VsdDsKICB9KTsKICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKSB7CiAgcmV0dXJuIHNoYXBlLnRvV2lyZUZvcm1hdCh2YWx1ZSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gSnNvbkJ1aWxkZXI7Cgp9LHsiLi4vdXRpbCI6NzJ9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKZnVuY3Rpb24gSnNvblBhcnNlcigpIHsgfQoKSnNvblBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih2YWx1ZSwgc2hhcGUpIHsKICByZXR1cm4gdHJhbnNsYXRlKEpTT04ucGFyc2UodmFsdWUpLCBzaGFwZSk7Cn07CgpmdW5jdGlvbiB0cmFuc2xhdGUodmFsdWUsIHNoYXBlKSB7CiAgaWYgKCFzaGFwZSB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gdW5kZWZpbmVkOwoKICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgIGNhc2UgJ3N0cnVjdHVyZSc6IHJldHVybiB0cmFuc2xhdGVTdHJ1Y3R1cmUodmFsdWUsIHNoYXBlKTsKICAgIGNhc2UgJ21hcCc6IHJldHVybiB0cmFuc2xhdGVNYXAodmFsdWUsIHNoYXBlKTsKICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gdHJhbnNsYXRlTGlzdCh2YWx1ZSwgc2hhcGUpOwogICAgZGVmYXVsdDogcmV0dXJuIHRyYW5zbGF0ZVNjYWxhcih2YWx1ZSwgc2hhcGUpOwogIH0KfQoKZnVuY3Rpb24gdHJhbnNsYXRlU3RydWN0dXJlKHN0cnVjdHVyZSwgc2hhcGUpIHsKICBpZiAoc3RydWN0dXJlID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgaWYgKHNoYXBlLmlzRG9jdW1lbnQpIHJldHVybiBzdHJ1Y3R1cmU7CgogIHZhciBzdHJ1Y3QgPSB7fTsKICB2YXIgc2hhcGVNZW1iZXJzID0gc2hhcGUubWVtYmVyczsKICB1dGlsLmVhY2goc2hhcGVNZW1iZXJzLCBmdW5jdGlvbihuYW1lLCBtZW1iZXJTaGFwZSkgewogICAgdmFyIGxvY2F0aW9uTmFtZSA9IG1lbWJlclNoYXBlLmlzTG9jYXRpb25OYW1lID8gbWVtYmVyU2hhcGUubmFtZSA6IG5hbWU7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN0cnVjdHVyZSwgbG9jYXRpb25OYW1lKSkgewogICAgICB2YXIgdmFsdWUgPSBzdHJ1Y3R1cmVbbG9jYXRpb25OYW1lXTsKICAgICAgdmFyIHJlc3VsdCA9IHRyYW5zbGF0ZSh2YWx1ZSwgbWVtYmVyU2hhcGUpOwogICAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHN0cnVjdFtuYW1lXSA9IHJlc3VsdDsKICAgIH0KICB9KTsKICByZXR1cm4gc3RydWN0Owp9CgpmdW5jdGlvbiB0cmFuc2xhdGVMaXN0KGxpc3QsIHNoYXBlKSB7CiAgaWYgKGxpc3QgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKCiAgdmFyIG91dCA9IFtdOwogIHV0aWwuYXJyYXlFYWNoKGxpc3QsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB2YXIgcmVzdWx0ID0gdHJhbnNsYXRlKHZhbHVlLCBzaGFwZS5tZW1iZXIpOwogICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSBvdXQucHVzaChudWxsKTsKICAgIGVsc2Ugb3V0LnB1c2gocmVzdWx0KTsKICB9KTsKICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiB0cmFuc2xhdGVNYXAobWFwLCBzaGFwZSkgewogIGlmIChtYXAgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKCiAgdmFyIG91dCA9IHt9OwogIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgIHZhciByZXN1bHQgPSB0cmFuc2xhdGUodmFsdWUsIHNoYXBlLnZhbHVlKTsKICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgb3V0W2tleV0gPSBudWxsOwogICAgZWxzZSBvdXRba2V5XSA9IHJlc3VsdDsKICB9KTsKICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiB0cmFuc2xhdGVTY2FsYXIodmFsdWUsIHNoYXBlKSB7CiAgcmV0dXJuIHNoYXBlLnRvVHlwZSh2YWx1ZSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gSnNvblBhcnNlcjsKCn0seyIuLi91dGlsIjo3Mn1dLDM5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIENvbGxlY3Rpb24gPSByZXF1aXJlKCcuL2NvbGxlY3Rpb24nKTsKdmFyIE9wZXJhdGlvbiA9IHJlcXVpcmUoJy4vb3BlcmF0aW9uJyk7CnZhciBTaGFwZSA9IHJlcXVpcmUoJy4vc2hhcGUnKTsKdmFyIFBhZ2luYXRvciA9IHJlcXVpcmUoJy4vcGFnaW5hdG9yJyk7CnZhciBSZXNvdXJjZVdhaXRlciA9IHJlcXVpcmUoJy4vcmVzb3VyY2Vfd2FpdGVyJyk7CnZhciBtZXRhZGF0YSA9IHJlcXVpcmUoJy4uLy4uL2FwaXMvbWV0YWRhdGEuanNvbicpOwoKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CnZhciBtZW1vaXplZFByb3BlcnR5ID0gdXRpbC5tZW1vaXplZFByb3BlcnR5OwoKZnVuY3Rpb24gQXBpKGFwaSwgb3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpczsKICBhcGkgPSBhcGkgfHwge307CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgb3B0aW9ucy5hcGkgPSB0aGlzOwoKICBhcGkubWV0YWRhdGEgPSBhcGkubWV0YWRhdGEgfHwge307CgogIHZhciBzZXJ2aWNlSWRlbnRpZmllciA9IG9wdGlvbnMuc2VydmljZUlkZW50aWZpZXI7CiAgZGVsZXRlIG9wdGlvbnMuc2VydmljZUlkZW50aWZpZXI7CgogIHByb3BlcnR5KHRoaXMsICdpc0FwaScsIHRydWUsIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnYXBpVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5hcGlWZXJzaW9uKTsKICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnRQcmVmaXgnLCBhcGkubWV0YWRhdGEuZW5kcG9pbnRQcmVmaXgpOwogIHByb3BlcnR5KHRoaXMsICdzaWduaW5nTmFtZScsIGFwaS5tZXRhZGF0YS5zaWduaW5nTmFtZSk7CiAgcHJvcGVydHkodGhpcywgJ2dsb2JhbEVuZHBvaW50JywgYXBpLm1ldGFkYXRhLmdsb2JhbEVuZHBvaW50KTsKICBwcm9wZXJ0eSh0aGlzLCAnc2lnbmF0dXJlVmVyc2lvbicsIGFwaS5tZXRhZGF0YS5zaWduYXR1cmVWZXJzaW9uKTsKICBwcm9wZXJ0eSh0aGlzLCAnanNvblZlcnNpb24nLCBhcGkubWV0YWRhdGEuanNvblZlcnNpb24pOwogIHByb3BlcnR5KHRoaXMsICd0YXJnZXRQcmVmaXgnLCBhcGkubWV0YWRhdGEudGFyZ2V0UHJlZml4KTsKICBwcm9wZXJ0eSh0aGlzLCAncHJvdG9jb2wnLCBhcGkubWV0YWRhdGEucHJvdG9jb2wpOwogIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBhcGkubWV0YWRhdGEudGltZXN0YW1wRm9ybWF0KTsKICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlVXJpJywgYXBpLm1ldGFkYXRhLnhtbE5hbWVzcGFjZSk7CiAgcHJvcGVydHkodGhpcywgJ2FiYnJldmlhdGlvbicsIGFwaS5tZXRhZGF0YS5zZXJ2aWNlQWJicmV2aWF0aW9uKTsKICBwcm9wZXJ0eSh0aGlzLCAnZnVsbE5hbWUnLCBhcGkubWV0YWRhdGEuc2VydmljZUZ1bGxOYW1lKTsKICBwcm9wZXJ0eSh0aGlzLCAnc2VydmljZUlkJywgYXBpLm1ldGFkYXRhLnNlcnZpY2VJZCk7CiAgaWYgKHNlcnZpY2VJZGVudGlmaWVyICYmIG1ldGFkYXRhW3NlcnZpY2VJZGVudGlmaWVyXSkgewogICAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTm9EZWZhdWx0TGlzdHMnLCBtZXRhZGF0YVtzZXJ2aWNlSWRlbnRpZmllcl0ueG1sTm9EZWZhdWx0TGlzdHMsIGZhbHNlKTsKICB9CgogIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2NsYXNzTmFtZScsIGZ1bmN0aW9uKCkgewogICAgdmFyIG5hbWUgPSBhcGkubWV0YWRhdGEuc2VydmljZUFiYnJldmlhdGlvbiB8fCBhcGkubWV0YWRhdGEuc2VydmljZUZ1bGxOYW1lOwogICAgaWYgKCFuYW1lKSByZXR1cm4gbnVsbDsKCiAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC9eQW1hem9ufEFXU1xzKnxcKC4qfFxzK3xcVysvZywgJycpOwogICAgaWYgKG5hbWUgPT09ICdFbGFzdGljTG9hZEJhbGFuY2luZycpIG5hbWUgPSAnRUxCJzsKICAgIHJldHVybiBuYW1lOwogIH0pOwoKICBmdW5jdGlvbiBhZGRFbmRwb2ludE9wZXJhdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgIGlmIChvcGVyYXRpb24uZW5kcG9pbnRvcGVyYXRpb24gPT09IHRydWUpIHsKICAgICAgcHJvcGVydHkoc2VsZiwgJ2VuZHBvaW50T3BlcmF0aW9uJywgdXRpbC5zdHJpbmcubG93ZXJGaXJzdChuYW1lKSk7CiAgICB9CiAgICBpZiAob3BlcmF0aW9uLmVuZHBvaW50ZGlzY292ZXJ5ICYmICFzZWxmLmhhc1JlcXVpcmVkRW5kcG9pbnREaXNjb3ZlcnkpIHsKICAgICAgcHJvcGVydHkoCiAgICAgICAgc2VsZiwKICAgICAgICAnaGFzUmVxdWlyZWRFbmRwb2ludERpc2NvdmVyeScsCiAgICAgICAgb3BlcmF0aW9uLmVuZHBvaW50ZGlzY292ZXJ5LnJlcXVpcmVkID09PSB0cnVlCiAgICAgICk7CiAgICB9CiAgfQoKICBwcm9wZXJ0eSh0aGlzLCAnb3BlcmF0aW9ucycsIG5ldyBDb2xsZWN0aW9uKGFwaS5vcGVyYXRpb25zLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBvcGVyYXRpb24pIHsKICAgIHJldHVybiBuZXcgT3BlcmF0aW9uKG5hbWUsIG9wZXJhdGlvbiwgb3B0aW9ucyk7CiAgfSwgdXRpbC5zdHJpbmcubG93ZXJGaXJzdCwgYWRkRW5kcG9pbnRPcGVyYXRpb24pKTsKCiAgcHJvcGVydHkodGhpcywgJ3NoYXBlcycsIG5ldyBDb2xsZWN0aW9uKGFwaS5zaGFwZXMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHNoYXBlKSB7CiAgICByZXR1cm4gU2hhcGUuY3JlYXRlKHNoYXBlLCBvcHRpb25zKTsKICB9KSk7CgogIHByb3BlcnR5KHRoaXMsICdwYWdpbmF0b3JzJywgbmV3IENvbGxlY3Rpb24oYXBpLnBhZ2luYXRvcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHBhZ2luYXRvcikgewogICAgcmV0dXJuIG5ldyBQYWdpbmF0b3IobmFtZSwgcGFnaW5hdG9yLCBvcHRpb25zKTsKICB9KSk7CgogIHByb3BlcnR5KHRoaXMsICd3YWl0ZXJzJywgbmV3IENvbGxlY3Rpb24oYXBpLndhaXRlcnMsIG9wdGlvbnMsIGZ1bmN0aW9uKG5hbWUsIHdhaXRlcikgewogICAgcmV0dXJuIG5ldyBSZXNvdXJjZVdhaXRlcihuYW1lLCB3YWl0ZXIsIG9wdGlvbnMpOwogIH0sIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3QpKTsKCiAgaWYgKG9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBhcGkuZG9jdW1lbnRhdGlvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIGFwaS5kb2N1bWVudGF0aW9uVXJsKTsKICB9CiAgcHJvcGVydHkodGhpcywgJ2Vycm9yQ29kZU1hcHBpbmcnLCBhcGkuYXdzUXVlcnlDb21wYXRpYmxlKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBcGk7Cgp9LHsiLi4vLi4vYXBpcy9tZXRhZGF0YS5qc29uIjo0LCIuLi91dGlsIjo3MiwiLi9jb2xsZWN0aW9uIjo0MCwiLi9vcGVyYXRpb24iOjQxLCIuL3BhZ2luYXRvciI6NDIsIi4vcmVzb3VyY2Vfd2FpdGVyIjo0MywiLi9zaGFwZSI6NDR9XSw0MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBtZW1vaXplZFByb3BlcnR5ID0gcmVxdWlyZSgnLi4vdXRpbCcpLm1lbW9pemVkUHJvcGVydHk7CgpmdW5jdGlvbiBtZW1vaXplKG5hbWUsIHZhbHVlLCBmYWN0b3J5LCBuYW1lVHIpIHsKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsIG5hbWVUcihuYW1lKSwgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIENvbGxlY3Rpb24oaXRlcmFibGUsIG9wdGlvbnMsIGZhY3RvcnksIG5hbWVUciwgY2FsbGJhY2spIHsKICBuYW1lVHIgPSBuYW1lVHIgfHwgU3RyaW5nOwogIHZhciBzZWxmID0gdGhpczsKCiAgZm9yICh2YXIgaWQgaW4gaXRlcmFibGUpIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGlkKSkgewogICAgICBtZW1vaXplLmNhbGwoc2VsZiwgaWQsIGl0ZXJhYmxlW2lkXSwgZmFjdG9yeSwgbmFtZVRyKTsKICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhpZCwgaXRlcmFibGVbaWRdKTsKICAgIH0KICB9Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQ29sbGVjdGlvbjsKCn0seyIuLi91dGlsIjo3Mn1dLDQxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIFNoYXBlID0gcmVxdWlyZSgnLi9zaGFwZScpOwoKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CnZhciBtZW1vaXplZFByb3BlcnR5ID0gdXRpbC5tZW1vaXplZFByb3BlcnR5OwoKZnVuY3Rpb24gT3BlcmF0aW9uKG5hbWUsIG9wZXJhdGlvbiwgb3B0aW9ucykgewogIHZhciBzZWxmID0gdGhpczsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgcHJvcGVydHkodGhpcywgJ25hbWUnLCBvcGVyYXRpb24ubmFtZSB8fCBuYW1lKTsKICBwcm9wZXJ0eSh0aGlzLCAnYXBpJywgb3B0aW9ucy5hcGksIGZhbHNlKTsKCiAgb3BlcmF0aW9uLmh0dHAgPSBvcGVyYXRpb24uaHR0cCB8fCB7fTsKICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnQnLCBvcGVyYXRpb24uZW5kcG9pbnQpOwogIHByb3BlcnR5KHRoaXMsICdodHRwTWV0aG9kJywgb3BlcmF0aW9uLmh0dHAubWV0aG9kIHx8ICdQT1NUJyk7CiAgcHJvcGVydHkodGhpcywgJ2h0dHBQYXRoJywgb3BlcmF0aW9uLmh0dHAucmVxdWVzdFVyaSB8fCAnLycpOwogIHByb3BlcnR5KHRoaXMsICdhdXRodHlwZScsIG9wZXJhdGlvbi5hdXRodHlwZSB8fCAnJyk7CiAgcHJvcGVydHkoCiAgICB0aGlzLAogICAgJ2VuZHBvaW50RGlzY292ZXJ5UmVxdWlyZWQnLAogICAgb3BlcmF0aW9uLmVuZHBvaW50ZGlzY292ZXJ5ID8KICAgICAgKG9wZXJhdGlvbi5lbmRwb2ludGRpc2NvdmVyeS5yZXF1aXJlZCA/ICdSRVFVSVJFRCcgOiAnT1BUSU9OQUwnKSA6CiAgICAnTlVMTCcKICApOwoKICAvLyBodHRwQ2hlY2tzdW0gcmVwbGFjZXMgdXNhZ2Ugb2YgaHR0cENoZWNrc3VtUmVxdWlyZWQsIGJ1dCBzb21lIEFQSXMKICAvLyAoczNjb250cm9sKSBzdGlsbCB1c2VzIG9sZCB0cmFpdC4KICB2YXIgaHR0cENoZWNrc3VtUmVxdWlyZWQgPSBvcGVyYXRpb24uaHR0cENoZWNrc3VtUmVxdWlyZWQKICAgIHx8IChvcGVyYXRpb24uaHR0cENoZWNrc3VtICYmIG9wZXJhdGlvbi5odHRwQ2hlY2tzdW0ucmVxdWVzdENoZWNrc3VtUmVxdWlyZWQpOwogIHByb3BlcnR5KHRoaXMsICdodHRwQ2hlY2tzdW1SZXF1aXJlZCcsIGh0dHBDaGVja3N1bVJlcXVpcmVkLCBmYWxzZSk7CgogIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2lucHV0JywgZnVuY3Rpb24oKSB7CiAgICBpZiAoIW9wZXJhdGlvbi5pbnB1dCkgewogICAgICByZXR1cm4gbmV3IFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cnVjdHVyZSd9LCBvcHRpb25zKTsKICAgIH0KICAgIHJldHVybiBTaGFwZS5jcmVhdGUob3BlcmF0aW9uLmlucHV0LCBvcHRpb25zKTsKICB9KTsKCiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnb3V0cHV0JywgZnVuY3Rpb24oKSB7CiAgICBpZiAoIW9wZXJhdGlvbi5vdXRwdXQpIHsKICAgICAgcmV0dXJuIG5ldyBTaGFwZS5jcmVhdGUoe3R5cGU6ICdzdHJ1Y3R1cmUnfSwgb3B0aW9ucyk7CiAgICB9CiAgICByZXR1cm4gU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5vdXRwdXQsIG9wdGlvbnMpOwogIH0pOwoKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdlcnJvcnMnLCBmdW5jdGlvbigpIHsKICAgIHZhciBsaXN0ID0gW107CiAgICBpZiAoIW9wZXJhdGlvbi5lcnJvcnMpIHJldHVybiBudWxsOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3BlcmF0aW9uLmVycm9ycy5sZW5ndGg7IGkrKykgewogICAgICBsaXN0LnB1c2goU2hhcGUuY3JlYXRlKG9wZXJhdGlvbi5lcnJvcnNbaV0sIG9wdGlvbnMpKTsKICAgIH0KCiAgICByZXR1cm4gbGlzdDsKICB9KTsKCiAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAncGFnaW5hdG9yJywgZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gb3B0aW9ucy5hcGkucGFnaW5hdG9yc1tuYW1lXTsKICB9KTsKCiAgaWYgKG9wdGlvbnMuZG9jdW1lbnRhdGlvbikgewogICAgcHJvcGVydHkodGhpcywgJ2RvY3VtZW50YXRpb24nLCBvcGVyYXRpb24uZG9jdW1lbnRhdGlvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIG9wZXJhdGlvbi5kb2N1bWVudGF0aW9uVXJsKTsKICB9CgogIC8vIGlkZW1wb3RlbnRNZW1iZXJzIG9ubHkgdHJhY2tzIHRvcC1sZXZlbCBpbnB1dCBzaGFwZXMKICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdpZGVtcG90ZW50TWVtYmVycycsIGZ1bmN0aW9uKCkgewogICAgdmFyIGlkZW1wb3RlbnRNZW1iZXJzID0gW107CiAgICB2YXIgaW5wdXQgPSBzZWxmLmlucHV0OwogICAgdmFyIG1lbWJlcnMgPSBpbnB1dC5tZW1iZXJzOwogICAgaWYgKCFpbnB1dC5tZW1iZXJzKSB7CiAgICAgIHJldHVybiBpZGVtcG90ZW50TWVtYmVyczsKICAgIH0KICAgIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgICBpZiAoIW1lbWJlcnMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBpZiAobWVtYmVyc1tuYW1lXS5pc0lkZW1wb3RlbnQgPT09IHRydWUpIHsKICAgICAgICBpZGVtcG90ZW50TWVtYmVycy5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gaWRlbXBvdGVudE1lbWJlcnM7CiAgfSk7CgogIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2hhc0V2ZW50T3V0cHV0JywgZnVuY3Rpb24oKSB7CiAgICB2YXIgb3V0cHV0ID0gc2VsZi5vdXRwdXQ7CiAgICByZXR1cm4gaGFzRXZlbnRTdHJlYW0ob3V0cHV0KTsKICB9KTsKfQoKZnVuY3Rpb24gaGFzRXZlbnRTdHJlYW0odG9wTGV2ZWxTaGFwZSkgewogIHZhciBtZW1iZXJzID0gdG9wTGV2ZWxTaGFwZS5tZW1iZXJzOwogIHZhciBwYXlsb2FkID0gdG9wTGV2ZWxTaGFwZS5wYXlsb2FkOwoKICBpZiAoIXRvcExldmVsU2hhcGUubWVtYmVycykgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgaWYgKHBheWxvYWQpIHsKICAgIHZhciBwYXlsb2FkTWVtYmVyID0gbWVtYmVyc1twYXlsb2FkXTsKICAgIHJldHVybiBwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW07CiAgfQoKICAvLyBjaGVjayBpZiBhbnkgbWVtYmVyIGlzIGFuIGV2ZW50IHN0cmVhbQogIGZvciAodmFyIG5hbWUgaW4gbWVtYmVycykgewogICAgaWYgKCFtZW1iZXJzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgIGlmIChtZW1iZXJzW25hbWVdLmlzRXZlbnRTdHJlYW0gPT09IHRydWUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gT3BlcmF0aW9uOwoKfSx7Ii4uL3V0aWwiOjcyLCIuL3NoYXBlIjo0NH1dLDQyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHByb3BlcnR5ID0gcmVxdWlyZSgnLi4vdXRpbCcpLnByb3BlcnR5OwoKZnVuY3Rpb24gUGFnaW5hdG9yKG5hbWUsIHBhZ2luYXRvcikgewogIHByb3BlcnR5KHRoaXMsICdpbnB1dFRva2VuJywgcGFnaW5hdG9yLmlucHV0X3Rva2VuKTsKICBwcm9wZXJ0eSh0aGlzLCAnbGltaXRLZXknLCBwYWdpbmF0b3IubGltaXRfa2V5KTsKICBwcm9wZXJ0eSh0aGlzLCAnbW9yZVJlc3VsdHMnLCBwYWdpbmF0b3IubW9yZV9yZXN1bHRzKTsKICBwcm9wZXJ0eSh0aGlzLCAnb3V0cHV0VG9rZW4nLCBwYWdpbmF0b3Iub3V0cHV0X3Rva2VuKTsKICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0S2V5JywgcGFnaW5hdG9yLnJlc3VsdF9rZXkpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IFBhZ2luYXRvcjsKCn0seyIuLi91dGlsIjo3Mn1dLDQzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBwcm9wZXJ0eSA9IHV0aWwucHJvcGVydHk7CgpmdW5jdGlvbiBSZXNvdXJjZVdhaXRlcihuYW1lLCB3YWl0ZXIsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBwcm9wZXJ0eSh0aGlzLCAnbmFtZScsIG5hbWUpOwogIHByb3BlcnR5KHRoaXMsICdhcGknLCBvcHRpb25zLmFwaSwgZmFsc2UpOwoKICBpZiAod2FpdGVyLm9wZXJhdGlvbikgewogICAgcHJvcGVydHkodGhpcywgJ29wZXJhdGlvbicsIHV0aWwuc3RyaW5nLmxvd2VyRmlyc3Qod2FpdGVyLm9wZXJhdGlvbikpOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzOwogIHZhciBrZXlzID0gWwogICAgJ3R5cGUnLAogICAgJ2Rlc2NyaXB0aW9uJywKICAgICdkZWxheScsCiAgICAnbWF4QXR0ZW1wdHMnLAogICAgJ2FjY2VwdG9ycycKICBdOwoKICBrZXlzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICB2YXIgdmFsdWUgPSB3YWl0ZXJba2V5XTsKICAgIGlmICh2YWx1ZSkgewogICAgICBwcm9wZXJ0eShzZWxmLCBrZXksIHZhbHVlKTsKICAgIH0KICB9KTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBSZXNvdXJjZVdhaXRlcjsKCn0seyIuLi91dGlsIjo3Mn1dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIENvbGxlY3Rpb24gPSByZXF1aXJlKCcuL2NvbGxlY3Rpb24nKTsKCnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKZnVuY3Rpb24gcHJvcGVydHkob2JqLCBuYW1lLCB2YWx1ZSkgewogIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICB1dGlsLnByb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQp9CgpmdW5jdGlvbiBtZW1vaXplZFByb3BlcnR5KG9iaiwgbmFtZSkgewogIGlmICghb2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZVtuYW1lXSkgewogICAgdXRpbC5tZW1vaXplZFByb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfQp9CgpmdW5jdGlvbiBTaGFwZShzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSkgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICBwcm9wZXJ0eSh0aGlzLCAnc2hhcGUnLCBzaGFwZS5zaGFwZSk7CiAgcHJvcGVydHkodGhpcywgJ2FwaScsIG9wdGlvbnMuYXBpLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ3R5cGUnLCBzaGFwZS50eXBlKTsKICBwcm9wZXJ0eSh0aGlzLCAnZW51bScsIHNoYXBlLmVudW0pOwogIHByb3BlcnR5KHRoaXMsICdtaW4nLCBzaGFwZS5taW4pOwogIHByb3BlcnR5KHRoaXMsICdtYXgnLCBzaGFwZS5tYXgpOwogIHByb3BlcnR5KHRoaXMsICdwYXR0ZXJuJywgc2hhcGUucGF0dGVybik7CiAgcHJvcGVydHkodGhpcywgJ2xvY2F0aW9uJywgc2hhcGUubG9jYXRpb24gfHwgdGhpcy5sb2NhdGlvbiB8fCAnYm9keScpOwogIHByb3BlcnR5KHRoaXMsICduYW1lJywgdGhpcy5uYW1lIHx8IHNoYXBlLnhtbE5hbWUgfHwgc2hhcGUucXVlcnlOYW1lIHx8CiAgICBzaGFwZS5sb2NhdGlvbk5hbWUgfHwgbWVtYmVyTmFtZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzU3RyZWFtaW5nJywgc2hhcGUuc3RyZWFtaW5nIHx8IHRoaXMuaXNTdHJlYW1pbmcgfHwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdyZXF1aXJlc0xlbmd0aCcsIHNoYXBlLnJlcXVpcmVzTGVuZ3RoLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgc2hhcGUuaXNDb21wb3NpdGUgfHwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc1NoYXBlJywgdHJ1ZSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc1F1ZXJ5TmFtZScsIEJvb2xlYW4oc2hhcGUucXVlcnlOYW1lKSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc0xvY2F0aW9uTmFtZScsIEJvb2xlYW4oc2hhcGUubG9jYXRpb25OYW1lKSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc0lkZW1wb3RlbnQnLCBzaGFwZS5pZGVtcG90ZW5jeVRva2VuID09PSB0cnVlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNKc29uVmFsdWUnLCBzaGFwZS5qc29udmFsdWUgPT09IHRydWUpOwogIHByb3BlcnR5KHRoaXMsICdpc1NlbnNpdGl2ZScsIHNoYXBlLnNlbnNpdGl2ZSA9PT0gdHJ1ZSB8fCBzaGFwZS5wcm90b3R5cGUgJiYgc2hhcGUucHJvdG90eXBlLnNlbnNpdGl2ZSA9PT0gdHJ1ZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzRXZlbnRTdHJlYW0nLCBCb29sZWFuKHNoYXBlLmV2ZW50c3RyZWFtKSwgZmFsc2UpOwogIHByb3BlcnR5KHRoaXMsICdpc0V2ZW50JywgQm9vbGVhbihzaGFwZS5ldmVudCksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudFBheWxvYWQnLCBCb29sZWFuKHNoYXBlLmV2ZW50cGF5bG9hZCksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaXNFdmVudEhlYWRlcicsIEJvb2xlYW4oc2hhcGUuZXZlbnRoZWFkZXIpLCBmYWxzZSk7CiAgcHJvcGVydHkodGhpcywgJ2lzVGltZXN0YW1wRm9ybWF0U2V0JywgQm9vbGVhbihzaGFwZS50aW1lc3RhbXBGb3JtYXQpIHx8IHNoYXBlLnByb3RvdHlwZSAmJiBzaGFwZS5wcm90b3R5cGUuaXNUaW1lc3RhbXBGb3JtYXRTZXQgPT09IHRydWUsIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnZW5kcG9pbnREaXNjb3ZlcnlJZCcsIEJvb2xlYW4oc2hhcGUuZW5kcG9pbnRkaXNjb3ZlcnlpZCksIGZhbHNlKTsKICBwcm9wZXJ0eSh0aGlzLCAnaG9zdExhYmVsJywgQm9vbGVhbihzaGFwZS5ob3N0TGFiZWwpLCBmYWxzZSk7CgogIGlmIChvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgIHByb3BlcnR5KHRoaXMsICdkb2N1bWVudGF0aW9uJywgc2hhcGUuZG9jdW1lbnRhdGlvbik7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZG9jdW1lbnRhdGlvblVybCcsIHNoYXBlLmRvY3VtZW50YXRpb25VcmwpOwogIH0KCiAgaWYgKHNoYXBlLnhtbEF0dHJpYnV0ZSkgewogICAgcHJvcGVydHkodGhpcywgJ2lzWG1sQXR0cmlidXRlJywgc2hhcGUueG1sQXR0cmlidXRlIHx8IGZhbHNlKTsKICB9CgogIC8vIHR5cGUgY29udmVyc2lvbiBhbmQgcGFyc2luZwogIHByb3BlcnR5KHRoaXMsICdkZWZhdWx0VmFsdWUnLCBudWxsKTsKICB0aGlzLnRvV2lyZUZvcm1hdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuICcnOwogICAgcmV0dXJuIHZhbHVlOwogIH07CiAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdmFsdWU7IH07Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovClNoYXBlLm5vcm1hbGl6ZWRUeXBlcyA9IHsKICBjaGFyYWN0ZXI6ICdzdHJpbmcnLAogIGRvdWJsZTogJ2Zsb2F0JywKICBsb25nOiAnaW50ZWdlcicsCiAgc2hvcnQ6ICdpbnRlZ2VyJywKICBiaWdpbnRlZ2VyOiAnaW50ZWdlcicsCiAgYmlnZGVjaW1hbDogJ2Zsb2F0JywKICBibG9iOiAnYmluYXJ5Jwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KU2hhcGUudHlwZXMgPSB7CiAgJ3N0cnVjdHVyZSc6IFN0cnVjdHVyZVNoYXBlLAogICdsaXN0JzogTGlzdFNoYXBlLAogICdtYXAnOiBNYXBTaGFwZSwKICAnYm9vbGVhbic6IEJvb2xlYW5TaGFwZSwKICAndGltZXN0YW1wJzogVGltZXN0YW1wU2hhcGUsCiAgJ2Zsb2F0JzogRmxvYXRTaGFwZSwKICAnaW50ZWdlcic6IEludGVnZXJTaGFwZSwKICAnc3RyaW5nJzogU3RyaW5nU2hhcGUsCiAgJ2Jhc2U2NCc6IEJhc2U2NFNoYXBlLAogICdiaW5hcnknOiBCaW5hcnlTaGFwZQp9OwoKU2hhcGUucmVzb2x2ZSA9IGZ1bmN0aW9uIHJlc29sdmUoc2hhcGUsIG9wdGlvbnMpIHsKICBpZiAoc2hhcGUuc2hhcGUpIHsKICAgIHZhciByZWZTaGFwZSA9IG9wdGlvbnMuYXBpLnNoYXBlc1tzaGFwZS5zaGFwZV07CiAgICBpZiAoIXJlZlNoYXBlKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGZpbmQgc2hhcGUgcmVmZXJlbmNlOiAnICsgc2hhcGUuc2hhcGUpOwogICAgfQoKICAgIHJldHVybiByZWZTaGFwZTsKICB9IGVsc2UgewogICAgcmV0dXJuIG51bGw7CiAgfQp9OwoKU2hhcGUuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlKHNoYXBlLCBvcHRpb25zLCBtZW1iZXJOYW1lKSB7CiAgaWYgKHNoYXBlLmlzU2hhcGUpIHJldHVybiBzaGFwZTsKCiAgdmFyIHJlZlNoYXBlID0gU2hhcGUucmVzb2x2ZShzaGFwZSwgb3B0aW9ucyk7CiAgaWYgKHJlZlNoYXBlKSB7CiAgICB2YXIgZmlsdGVyZWRLZXlzID0gT2JqZWN0LmtleXMoc2hhcGUpOwogICAgaWYgKCFvcHRpb25zLmRvY3VtZW50YXRpb24pIHsKICAgICAgZmlsdGVyZWRLZXlzID0gZmlsdGVyZWRLZXlzLmZpbHRlcihmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuICFuYW1lLm1hdGNoKC9kb2N1bWVudGF0aW9uLyk7CiAgICAgIH0pOwogICAgfQoKICAgIC8vIGNyZWF0ZSBhbiBpbmxpbmUgc2hhcGUgd2l0aCBleHRyYSBtZW1iZXJzCiAgICB2YXIgSW5saW5lU2hhcGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmVmU2hhcGUuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBzaGFwZSwgb3B0aW9ucywgbWVtYmVyTmFtZSk7CiAgICB9OwogICAgSW5saW5lU2hhcGUucHJvdG90eXBlID0gcmVmU2hhcGU7CiAgICByZXR1cm4gbmV3IElubGluZVNoYXBlKCk7CiAgfSBlbHNlIHsKICAgIC8vIHNldCB0eXBlIGlmIG5vdCBzZXQKICAgIGlmICghc2hhcGUudHlwZSkgewogICAgICBpZiAoc2hhcGUubWVtYmVycykgc2hhcGUudHlwZSA9ICdzdHJ1Y3R1cmUnOwogICAgICBlbHNlIGlmIChzaGFwZS5tZW1iZXIpIHNoYXBlLnR5cGUgPSAnbGlzdCc7CiAgICAgIGVsc2UgaWYgKHNoYXBlLmtleSkgc2hhcGUudHlwZSA9ICdtYXAnOwogICAgICBlbHNlIHNoYXBlLnR5cGUgPSAnc3RyaW5nJzsKICAgIH0KCiAgICAvLyBub3JtYWxpemUgdHlwZXMKICAgIHZhciBvcmlnVHlwZSA9IHNoYXBlLnR5cGU7CiAgICBpZiAoU2hhcGUubm9ybWFsaXplZFR5cGVzW3NoYXBlLnR5cGVdKSB7CiAgICAgIHNoYXBlLnR5cGUgPSBTaGFwZS5ub3JtYWxpemVkVHlwZXNbc2hhcGUudHlwZV07CiAgICB9CgogICAgaWYgKFNoYXBlLnR5cGVzW3NoYXBlLnR5cGVdKSB7CiAgICAgIHJldHVybiBuZXcgU2hhcGUudHlwZXNbc2hhcGUudHlwZV0oc2hhcGUsIG9wdGlvbnMsIG1lbWJlck5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbnJlY29nbml6ZWQgc2hhcGUgdHlwZTogJyArIG9yaWdUeXBlKTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBDb21wb3NpdGVTaGFwZShzaGFwZSkgewogIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgcHJvcGVydHkodGhpcywgJ2lzQ29tcG9zaXRlJywgdHJ1ZSk7CgogIGlmIChzaGFwZS5mbGF0dGVuZWQpIHsKICAgIHByb3BlcnR5KHRoaXMsICdmbGF0dGVuZWQnLCBzaGFwZS5mbGF0dGVuZWQgfHwgZmFsc2UpOwogIH0KfQoKZnVuY3Rpb24gU3RydWN0dXJlU2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyIHJlcXVpcmVkTWFwID0gbnVsbCwgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKCiAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgaWYgKGZpcnN0SW5pdCkgewogICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4ge307IH0pOwogICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCB7fSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnbWVtYmVyTmFtZXMnLCBbXSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAncmVxdWlyZWQnLCBbXSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAnaXNSZXF1aXJlZCcsIGZ1bmN0aW9uKCkgeyByZXR1cm4gZmFsc2U7IH0pOwogICAgcHJvcGVydHkodGhpcywgJ2lzRG9jdW1lbnQnLCBCb29sZWFuKHNoYXBlLmRvY3VtZW50KSk7CiAgfQoKICBpZiAoc2hhcGUubWVtYmVycykgewogICAgcHJvcGVydHkodGhpcywgJ21lbWJlcnMnLCBuZXcgQ29sbGVjdGlvbihzaGFwZS5tZW1iZXJzLCBvcHRpb25zLCBmdW5jdGlvbihuYW1lLCBtZW1iZXIpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShtZW1iZXIsIG9wdGlvbnMsIG5hbWUpOwogICAgfSkpOwogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyTmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHNoYXBlLnhtbE9yZGVyIHx8IE9iamVjdC5rZXlzKHNoYXBlLm1lbWJlcnMpOwogICAgfSk7CgogICAgaWYgKHNoYXBlLmV2ZW50KSB7CiAgICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ2V2ZW50UGF5bG9hZE1lbWJlck5hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbWVtYmVycyA9IHNlbGYubWVtYmVyczsKICAgICAgICB2YXIgbWVtYmVyTmFtZXMgPSBzZWxmLm1lbWJlck5hbWVzOwogICAgICAgIC8vIGl0ZXJhdGUgb3ZlciBtZW1iZXJzIHRvIGZpbmQgb25lcyB0aGF0IGFyZSBldmVudCBwYXlsb2FkcwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpTGVuID0gbWVtYmVyTmFtZXMubGVuZ3RoOyBpIDwgaUxlbjsgaSsrKSB7CiAgICAgICAgICBpZiAobWVtYmVyc1ttZW1iZXJOYW1lc1tpXV0uaXNFdmVudFBheWxvYWQpIHsKICAgICAgICAgICAgcmV0dXJuIG1lbWJlck5hbWVzW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdldmVudEhlYWRlck1lbWJlck5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG1lbWJlcnMgPSBzZWxmLm1lbWJlcnM7CiAgICAgICAgdmFyIG1lbWJlck5hbWVzID0gc2VsZi5tZW1iZXJOYW1lczsKICAgICAgICB2YXIgZXZlbnRIZWFkZXJNZW1iZXJOYW1lcyA9IFtdOwogICAgICAgIC8vIGl0ZXJhdGUgb3ZlciBtZW1iZXJzIHRvIGZpbmQgb25lcyB0aGF0IGFyZSBldmVudCBoZWFkZXJzCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBtZW1iZXJOYW1lcy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgICAgICAgIGlmIChtZW1iZXJzW21lbWJlck5hbWVzW2ldXS5pc0V2ZW50SGVhZGVyKSB7CiAgICAgICAgICAgIGV2ZW50SGVhZGVyTWVtYmVyTmFtZXMucHVzaChtZW1iZXJOYW1lc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBldmVudEhlYWRlck1lbWJlck5hbWVzOwogICAgICB9KTsKICAgIH0KICB9CgogIGlmIChzaGFwZS5yZXF1aXJlZCkgewogICAgcHJvcGVydHkodGhpcywgJ3JlcXVpcmVkJywgc2hhcGUucmVxdWlyZWQpOwogICAgcHJvcGVydHkodGhpcywgJ2lzUmVxdWlyZWQnLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghcmVxdWlyZWRNYXApIHsKICAgICAgICByZXF1aXJlZE1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hhcGUucmVxdWlyZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlcXVpcmVkTWFwW3NoYXBlLnJlcXVpcmVkW2ldXSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcmVxdWlyZWRNYXBbbmFtZV07CiAgICB9LCBmYWxzZSwgdHJ1ZSk7CiAgfQoKICBwcm9wZXJ0eSh0aGlzLCAncmVzdWx0V3JhcHBlcicsIHNoYXBlLnJlc3VsdFdyYXBwZXIgfHwgbnVsbCk7CgogIGlmIChzaGFwZS5wYXlsb2FkKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAncGF5bG9hZCcsIHNoYXBlLnBheWxvYWQpOwogIH0KCiAgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlVXJpJywgc2hhcGUueG1sTmFtZXNwYWNlKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBzaGFwZS54bWxOYW1lc3BhY2UgPT09ICdvYmplY3QnKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlUHJlZml4Jywgc2hhcGUueG1sTmFtZXNwYWNlLnByZWZpeCk7CiAgICBwcm9wZXJ0eSh0aGlzLCAneG1sTmFtZXNwYWNlVXJpJywgc2hhcGUueG1sTmFtZXNwYWNlLnVyaSk7CiAgfQp9CgpmdW5jdGlvbiBMaXN0U2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICB2YXIgc2VsZiA9IHRoaXMsIGZpcnN0SW5pdCA9ICF0aGlzLmlzU2hhcGU7CiAgQ29tcG9zaXRlU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgaWYgKGZpcnN0SW5pdCkgewogICAgcHJvcGVydHkodGhpcywgJ2RlZmF1bHRWYWx1ZScsIGZ1bmN0aW9uKCkgeyByZXR1cm4gW107IH0pOwogIH0KCiAgaWYgKHNoYXBlLm1lbWJlcikgewogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAnbWVtYmVyJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBTaGFwZS5jcmVhdGUoc2hhcGUubWVtYmVyLCBvcHRpb25zKTsKICAgIH0pOwogIH0KCiAgaWYgKHRoaXMuZmxhdHRlbmVkKSB7CiAgICB2YXIgb2xkTmFtZSA9IHRoaXMubmFtZTsKICAgIG1lbW9pemVkUHJvcGVydHkodGhpcywgJ25hbWUnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHNlbGYubWVtYmVyLm5hbWUgfHwgb2xkTmFtZTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gTWFwU2hhcGUoc2hhcGUsIG9wdGlvbnMpIHsKICB2YXIgZmlyc3RJbml0ID0gIXRoaXMuaXNTaGFwZTsKICBDb21wb3NpdGVTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICBpZiAoZmlyc3RJbml0KSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAnZGVmYXVsdFZhbHVlJywgZnVuY3Rpb24oKSB7IHJldHVybiB7fTsgfSk7CiAgICBwcm9wZXJ0eSh0aGlzLCAna2V5JywgU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RyaW5nJ30sIG9wdGlvbnMpKTsKICAgIHByb3BlcnR5KHRoaXMsICd2YWx1ZScsIFNoYXBlLmNyZWF0ZSh7dHlwZTogJ3N0cmluZyd9LCBvcHRpb25zKSk7CiAgfQoKICBpZiAoc2hhcGUua2V5KSB7CiAgICBtZW1vaXplZFByb3BlcnR5KHRoaXMsICdrZXknLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS5rZXksIG9wdGlvbnMpOwogICAgfSk7CiAgfQogIGlmIChzaGFwZS52YWx1ZSkgewogICAgbWVtb2l6ZWRQcm9wZXJ0eSh0aGlzLCAndmFsdWUnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIFNoYXBlLmNyZWF0ZShzaGFwZS52YWx1ZSwgb3B0aW9ucyk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIFRpbWVzdGFtcFNoYXBlKHNoYXBlKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIGlmIChzaGFwZS50aW1lc3RhbXBGb3JtYXQpIHsKICAgIHByb3BlcnR5KHRoaXMsICd0aW1lc3RhbXBGb3JtYXQnLCBzaGFwZS50aW1lc3RhbXBGb3JtYXQpOwogIH0gZWxzZSBpZiAoc2VsZi5pc1RpbWVzdGFtcEZvcm1hdFNldCAmJiB0aGlzLnRpbWVzdGFtcEZvcm1hdCkgewogICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsIHRoaXMudGltZXN0YW1wRm9ybWF0KTsKICB9IGVsc2UgaWYgKHRoaXMubG9jYXRpb24gPT09ICdoZWFkZXInKSB7CiAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ3JmYzgyMicpOwogIH0gZWxzZSBpZiAodGhpcy5sb2NhdGlvbiA9PT0gJ3F1ZXJ5c3RyaW5nJykgewogICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdpc284NjAxJyk7CiAgfSBlbHNlIGlmICh0aGlzLmFwaSkgewogICAgc3dpdGNoICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICBjYXNlICdqc29uJzoKICAgICAgY2FzZSAncmVzdC1qc29uJzoKICAgICAgICBwcm9wZXJ0eSh0aGlzLCAndGltZXN0YW1wRm9ybWF0JywgJ3VuaXhUaW1lc3RhbXAnKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAncmVzdC14bWwnOgogICAgICBjYXNlICdxdWVyeSc6CiAgICAgIGNhc2UgJ2VjMic6CiAgICAgICAgcHJvcGVydHkodGhpcywgJ3RpbWVzdGFtcEZvcm1hdCcsICdpc284NjAxJyk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICBpZiAodHlwZW9mIHZhbHVlLnRvVVRDU3RyaW5nID09PSAnZnVuY3Rpb24nKSByZXR1cm4gdmFsdWU7CiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8KICAgICAgICAgICB1dGlsLmRhdGUucGFyc2VUaW1lc3RhbXAodmFsdWUpIDogbnVsbDsKICB9OwoKICB0aGlzLnRvV2lyZUZvcm1hdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdXRpbC5kYXRlLmZvcm1hdCh2YWx1ZSwgc2VsZi50aW1lc3RhbXBGb3JtYXQpOwogIH07Cn0KCmZ1bmN0aW9uIFN0cmluZ1NoYXBlKCkgewogIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHZhciBudWxsTGVzc1Byb3RvY29scyA9IFsncmVzdC14bWwnLCAncXVlcnknLCAnZWMyJ107CiAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgdmFsdWUgPSB0aGlzLmFwaSAmJiBudWxsTGVzc1Byb3RvY29scy5pbmRleE9mKHRoaXMuYXBpLnByb3RvY29sKSA+IC0xID8KICAgICAgdmFsdWUgfHwgJycgOiB2YWx1ZTsKICAgIGlmICh0aGlzLmlzSnNvblZhbHVlKSB7CiAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgIH0KCiAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlLnRvU3RyaW5nID09PSAnZnVuY3Rpb24nID8KICAgICAgdmFsdWUudG9TdHJpbmcoKSA6IHZhbHVlOwogIH07CgogIHRoaXMudG9XaXJlRm9ybWF0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB0aGlzLmlzSnNvblZhbHVlID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWU7CiAgfTsKfQoKZnVuY3Rpb24gRmxvYXRTaGFwZSgpIHsKICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICB0aGlzLnRvVHlwZSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIG51bGw7CiAgICByZXR1cm4gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgfTsKICB0aGlzLnRvV2lyZUZvcm1hdCA9IHRoaXMudG9UeXBlOwp9CgpmdW5jdGlvbiBJbnRlZ2VyU2hhcGUoKSB7CiAgU2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgdGhpcy50b1R5cGUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMCk7CiAgfTsKICB0aGlzLnRvV2lyZUZvcm1hdCA9IHRoaXMudG9UeXBlOwp9CgpmdW5jdGlvbiBCaW5hcnlTaGFwZSgpIHsKICBTaGFwZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHZhciBidWYgPSB1dGlsLmJhc2U2NC5kZWNvZGUodmFsdWUpOwogICAgaWYgKHRoaXMuaXNTZW5zaXRpdmUgJiYgdXRpbC5pc05vZGUoKSAmJiB0eXBlb2YgdXRpbC5CdWZmZXIuYWxsb2MgPT09ICdmdW5jdGlvbicpIHsKICAvKiBOb2RlLmpzIGNhbiBjcmVhdGUgYSBCdWZmZXIgdGhhdCBpcyBub3QgaXNvbGF0ZWQuCiAgICogaS5lLiBidWYuYnl0ZUxlbmd0aCAhPT0gYnVmLmJ1ZmZlci5ieXRlTGVuZ3RoCiAgICogVGhpcyBtZWFucyB0aGF0IHRoZSBzZW5zaXRpdmUgZGF0YSBpcyBhY2Nlc3NpYmxlIHRvIGFueW9uZSB3aXRoIGFjY2VzcyB0byBidWYuYnVmZmVyLgogICAqIElmIHRoaXMgaXMgdGhlIG5vZGUgc2hhcmVkIEJ1ZmZlciwgdGhlbiBvdGhlciBjb2RlIHdpdGhpbiB0aGlzIHByb2Nlc3MgX2NvdWxkXyBmaW5kIHRoaXMgc2VjcmV0LgogICAqIENvcHkgc2Vuc2l0aXZlIGRhdGEgdG8gYW4gaXNvbGF0ZWQgQnVmZmVyIGFuZCB6ZXJvIHRoZSBzZW5zaXRpdmUgZGF0YS4KICAgKiBXaGlsZSB0aGlzIGlzIHNhZmUgdG8gZG8gaGVyZSwgY29weWluZyB0aGlzIGNvZGUgc29tZXdoZXJlIGVsc2UgbWF5IHByb2R1Y2UgdW5leHBlY3RlZCByZXN1bHRzLgogICAqLwogICAgICB2YXIgc2VjdXJlQnVmID0gdXRpbC5CdWZmZXIuYWxsb2MoYnVmLmxlbmd0aCwgYnVmKTsKICAgICAgYnVmLmZpbGwoMCk7CiAgICAgIGJ1ZiA9IHNlY3VyZUJ1ZjsKICAgIH0KICAgIHJldHVybiBidWY7CiAgfTsKICB0aGlzLnRvV2lyZUZvcm1hdCA9IHV0aWwuYmFzZTY0LmVuY29kZTsKfQoKZnVuY3Rpb24gQmFzZTY0U2hhcGUoKSB7CiAgQmluYXJ5U2hhcGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQoKZnVuY3Rpb24gQm9vbGVhblNoYXBlKCkgewogIFNoYXBlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogIHRoaXMudG9UeXBlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlOwogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBudWxsOwogICAgcmV0dXJuIHZhbHVlID09PSAndHJ1ZSc7CiAgfTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KU2hhcGUuc2hhcGVzID0gewogIFN0cnVjdHVyZVNoYXBlOiBTdHJ1Y3R1cmVTaGFwZSwKICBMaXN0U2hhcGU6IExpc3RTaGFwZSwKICBNYXBTaGFwZTogTWFwU2hhcGUsCiAgU3RyaW5nU2hhcGU6IFN0cmluZ1NoYXBlLAogIEJvb2xlYW5TaGFwZTogQm9vbGVhblNoYXBlLAogIEJhc2U2NFNoYXBlOiBCYXNlNjRTaGFwZQp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBTaGFwZTsKCn0seyIuLi91dGlsIjo3MiwiLi9jb2xsZWN0aW9uIjo0MH1dLDQ1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlBhcmFtVmFsaWRhdG9yID0gQVdTLnV0aWwuaW5oZXJpdCh7CiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IHZhbGlkYXRvciBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0gdmFsaWRhdGlvbiBbQm9vbGVhbnxtYXBdIHdoZXRoZXIgaW5wdXQgcGFyYW1ldGVycyBzaG91bGQgYmUKICAgKiAgICAgdmFsaWRhdGVkIGFnYWluc3QgdGhlIG9wZXJhdGlvbiBkZXNjcmlwdGlvbiBiZWZvcmUgc2VuZGluZyB0aGUKICAgKiAgICAgcmVxdWVzdC4gUGFzcyBhIG1hcCB0byBlbmFibGUgYW55IG9mIHRoZSBmb2xsb3dpbmcgc3BlY2lmaWMKICAgKiAgICAgdmFsaWRhdGlvbiBmZWF0dXJlczoKICAgKgogICAqICAgICAqICoqbWluKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWluCiAgICogICAgICAgY29uc3RyYWludC4gVGhpcyBpcyBlbmFibGVkIGJ5IGRlZmF1bHQgd2hlbiBwYXJhbVZhbGlkYXRpb24gaXMgc2V0CiAgICogICAgICAgdG8gYHRydWVgLgogICAqICAgICAqICoqbWF4KiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSB2YWx1ZSBtZWV0cyB0aGUgbWF4CiAgICogICAgICAgY29uc3RyYWludC4KICAgKiAgICAgKiAqKnBhdHRlcm4qKiBbQm9vbGVhbl0gJm1kYXNoOyBWYWxpZGF0ZXMgdGhhdCBhIHN0cmluZyB2YWx1ZSBtYXRjaGVzIGEKICAgKiAgICAgICByZWd1bGFyIGV4cHJlc3Npb24uCiAgICogICAgICogKiplbnVtKiogW0Jvb2xlYW5dICZtZGFzaDsgVmFsaWRhdGVzIHRoYXQgYSBzdHJpbmcgdmFsdWUgbWF0Y2hlcyBvbmUKICAgKiAgICAgICBvZiB0aGUgYWxsb3dhYmxlIGVudW0gdmFsdWVzLgogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBQYXJhbVZhbGlkYXRvcih2YWxpZGF0aW9uKSB7CiAgICBpZiAodmFsaWRhdGlvbiA9PT0gdHJ1ZSB8fCB2YWxpZGF0aW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgdmFsaWRhdGlvbiA9IHsnbWluJzogdHJ1ZX07CiAgICB9CiAgICB0aGlzLnZhbGlkYXRpb24gPSB2YWxpZGF0aW9uOwogIH0sCgogIHZhbGlkYXRlOiBmdW5jdGlvbiB2YWxpZGF0ZShzaGFwZSwgcGFyYW1zLCBjb250ZXh0KSB7CiAgICB0aGlzLmVycm9ycyA9IFtdOwogICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZSwgcGFyYW1zIHx8IHt9LCBjb250ZXh0IHx8ICdwYXJhbXMnKTsKCiAgICBpZiAodGhpcy5lcnJvcnMubGVuZ3RoID4gMSkgewogICAgICB2YXIgbXNnID0gdGhpcy5lcnJvcnMuam9pbignXG4qICcpOwogICAgICBtc2cgPSAnVGhlcmUgd2VyZSAnICsgdGhpcy5lcnJvcnMubGVuZ3RoICsKICAgICAgICAnIHZhbGlkYXRpb24gZXJyb3JzOlxuKiAnICsgbXNnOwogICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IobXNnKSwKICAgICAgICB7Y29kZTogJ011bHRpcGxlVmFsaWRhdGlvbkVycm9ycycsIGVycm9yczogdGhpcy5lcnJvcnN9KTsKICAgIH0gZWxzZSBpZiAodGhpcy5lcnJvcnMubGVuZ3RoID09PSAxKSB7CiAgICAgIHRocm93IHRoaXMuZXJyb3JzWzBdOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSwKCiAgZmFpbDogZnVuY3Rpb24gZmFpbChjb2RlLCBtZXNzYWdlKSB7CiAgICB0aGlzLmVycm9ycy5wdXNoKEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcihtZXNzYWdlKSwge2NvZGU6IGNvZGV9KSk7CiAgfSwKCiAgdmFsaWRhdGVTdHJ1Y3R1cmU6IGZ1bmN0aW9uIHZhbGlkYXRlU3RydWN0dXJlKHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgIGlmIChzaGFwZS5pc0RvY3VtZW50KSByZXR1cm4gdHJ1ZTsKCiAgICB0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFsnb2JqZWN0J10sICdzdHJ1Y3R1cmUnKTsKICAgIHZhciBwYXJhbU5hbWU7CiAgICBmb3IgKHZhciBpID0gMDsgc2hhcGUucmVxdWlyZWQgJiYgaSA8IHNoYXBlLnJlcXVpcmVkLmxlbmd0aDsgaSsrKSB7CiAgICAgIHBhcmFtTmFtZSA9IHNoYXBlLnJlcXVpcmVkW2ldOwogICAgICB2YXIgdmFsdWUgPSBwYXJhbXNbcGFyYW1OYW1lXTsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIHsKICAgICAgICB0aGlzLmZhaWwoJ01pc3NpbmdSZXF1aXJlZFBhcmFtZXRlcicsCiAgICAgICAgICAnTWlzc2luZyByZXF1aXJlZCBrZXkgXCcnICsgcGFyYW1OYW1lICsgJ1wnIGluICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfQoKICAgIC8vIHZhbGlkYXRlIGhhc2ggbWVtYmVycwogICAgZm9yIChwYXJhbU5hbWUgaW4gcGFyYW1zKSB7CiAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHBhcmFtcywgcGFyYW1OYW1lKSkgY29udGludWU7CgogICAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1twYXJhbU5hbWVdLAogICAgICAgICAgbWVtYmVyU2hhcGUgPSBzaGFwZS5tZW1iZXJzW3BhcmFtTmFtZV07CgogICAgICBpZiAobWVtYmVyU2hhcGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhciBtZW1iZXJDb250ZXh0ID0gW2NvbnRleHQsIHBhcmFtTmFtZV0uam9pbignLicpOwogICAgICAgIHRoaXMudmFsaWRhdGVNZW1iZXIobWVtYmVyU2hhcGUsIHBhcmFtVmFsdWUsIG1lbWJlckNvbnRleHQpOwogICAgICB9IGVsc2UgaWYgKHBhcmFtVmFsdWUgIT09IHVuZGVmaW5lZCAmJiBwYXJhbVZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgdGhpcy5mYWlsKCdVbmV4cGVjdGVkUGFyYW1ldGVyJywKICAgICAgICAgICdVbmV4cGVjdGVkIGtleSBcJycgKyBwYXJhbU5hbWUgKyAnXCcgZm91bmQgaW4gJyArIGNvbnRleHQpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfSwKCiAgdmFsaWRhdGVNZW1iZXI6IGZ1bmN0aW9uIHZhbGlkYXRlTWVtYmVyKHNoYXBlLCBwYXJhbSwgY29udGV4dCkgewogICAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICAgIGNhc2UgJ3N0cnVjdHVyZSc6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVTdHJ1Y3R1cmUoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgY2FzZSAnbGlzdCc6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVMaXN0KHNoYXBlLCBwYXJhbSwgY29udGV4dCk7CiAgICAgIGNhc2UgJ21hcCc6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVNYXAoc2hhcGUsIHBhcmFtLCBjb250ZXh0KTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVNjYWxhcihzaGFwZSwgcGFyYW0sIGNvbnRleHQpOwogICAgfQogIH0sCgogIHZhbGlkYXRlTGlzdDogZnVuY3Rpb24gdmFsaWRhdGVMaXN0KHNoYXBlLCBwYXJhbXMsIGNvbnRleHQpIHsKICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZShwYXJhbXMsIGNvbnRleHQsIFtBcnJheV0pKSB7CiAgICAgIHRoaXMudmFsaWRhdGVSYW5nZShzaGFwZSwgcGFyYW1zLmxlbmd0aCwgY29udGV4dCwgJ2xpc3QgbWVtYmVyIGNvdW50Jyk7CiAgICAgIC8vIHZhbGlkYXRlIGFycmF5IG1lbWJlcnMKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLm1lbWJlciwgcGFyYW1zW2ldLCBjb250ZXh0ICsgJ1snICsgaSArICddJyk7CiAgICAgIH0KICAgIH0KICB9LAoKICB2YWxpZGF0ZU1hcDogZnVuY3Rpb24gdmFsaWRhdGVNYXAoc2hhcGUsIHBhcmFtcywgY29udGV4dCkgewogICAgaWYgKHRoaXMudmFsaWRhdGVUeXBlKHBhcmFtcywgY29udGV4dCwgWydvYmplY3QnXSwgJ21hcCcpKSB7CiAgICAgIC8vIEJ1aWxkIHVwIGEgY291bnQgb2YgbWFwIG1lbWJlcnMgdG8gdmFsaWRhdGUgcmFuZ2UgdHJhaXRzLgogICAgICB2YXIgbWFwQ291bnQgPSAwOwogICAgICBmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpIHsKICAgICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJhbXMsIHBhcmFtKSkgY29udGludWU7CiAgICAgICAgLy8gVmFsaWRhdGUgYW55IG1hcCBrZXkgdHJhaXQgY29uc3RyYWludHMKICAgICAgICB0aGlzLnZhbGlkYXRlTWVtYmVyKHNoYXBlLmtleSwgcGFyYW0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ICsgJ1trZXk9XCcnICsgcGFyYW0gKyAnXCddJyk7CiAgICAgICAgdGhpcy52YWxpZGF0ZU1lbWJlcihzaGFwZS52YWx1ZSwgcGFyYW1zW3BhcmFtXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgKyAnW1wnJyArIHBhcmFtICsgJ1wnXScpOwogICAgICAgIG1hcENvdW50Kys7CiAgICAgIH0KICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCBtYXBDb3VudCwgY29udGV4dCwgJ21hcCBtZW1iZXIgY291bnQnKTsKICAgIH0KICB9LAoKICB2YWxpZGF0ZVNjYWxhcjogZnVuY3Rpb24gdmFsaWRhdGVTY2FsYXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICBzd2l0Y2ggKHNoYXBlLnR5cGUpIHsKICAgICAgY2FzZSBudWxsOgogICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0ZVN0cmluZyhzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICBjYXNlICdiYXNlNjQnOgogICAgICBjYXNlICdiaW5hcnknOgogICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCk7CiAgICAgIGNhc2UgJ2ludGVnZXInOgogICAgICBjYXNlICdmbG9hdCc6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVOdW1iZXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbJ2Jvb2xlYW4nXSk7CiAgICAgIGNhc2UgJ3RpbWVzdGFtcCc6CiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBbRGF0ZSwKICAgICAgICAgIC9eXGR7NH0tXGR7Mn0tXGR7Mn1UXGR7Mn06XGR7Mn06XGR7Mn0oXC5cZCspP1okLywgJ251bWJlciddLAogICAgICAgICAgJ0RhdGUgb2JqZWN0LCBJU08tODYwMSBzdHJpbmcsIG9yIGEgVU5JWCB0aW1lc3RhbXAnKTsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gdGhpcy5mYWlsKCdVbmtvd25UeXBlJywgJ1VuaGFuZGxlZCB0eXBlICcgKwogICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUudHlwZSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgIH0KICB9LAoKICB2YWxpZGF0ZVN0cmluZzogZnVuY3Rpb24gdmFsaWRhdGVTdHJpbmcoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICB2YXIgdmFsaWRUeXBlcyA9IFsnc3RyaW5nJ107CiAgICBpZiAoc2hhcGUuaXNKc29uVmFsdWUpIHsKICAgICAgdmFsaWRUeXBlcyA9IHZhbGlkVHlwZXMuY29uY2F0KFsnbnVtYmVyJywgJ29iamVjdCcsICdib29sZWFuJ10pOwogICAgfQogICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHRoaXMudmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCB2YWxpZFR5cGVzKSkgewogICAgICB0aGlzLnZhbGlkYXRlRW51bShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgICB0aGlzLnZhbGlkYXRlUmFuZ2Uoc2hhcGUsIHZhbHVlLmxlbmd0aCwgY29udGV4dCwgJ3N0cmluZyBsZW5ndGgnKTsKICAgICAgdGhpcy52YWxpZGF0ZVBhdHRlcm4oc2hhcGUsIHZhbHVlLCBjb250ZXh0KTsKICAgICAgdGhpcy52YWxpZGF0ZVVyaShzaGFwZSwgdmFsdWUsIGNvbnRleHQpOwogICAgfQogIH0sCgogIHZhbGlkYXRlVXJpOiBmdW5jdGlvbiB2YWxpZGF0ZVVyaShzaGFwZSwgdmFsdWUsIGNvbnRleHQpIHsKICAgIGlmIChzaGFwZVsnbG9jYXRpb24nXSA9PT0gJ3VyaScpIHsKICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMuZmFpbCgnVXJpUGFyYW1ldGVyRXJyb3InLCAnRXhwZWN0ZWQgdXJpIHBhcmFtZXRlciB0byBoYXZlIGxlbmd0aCA+PSAxLCcKICAgICAgICAgICsgJyBidXQgZm91bmQgIicgKyB2YWx1ZSArJyIgZm9yICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfQogIH0sCgogIHZhbGlkYXRlUGF0dGVybjogZnVuY3Rpb24gdmFsaWRhdGVQYXR0ZXJuKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgaWYgKHRoaXMudmFsaWRhdGlvblsncGF0dGVybiddICYmIHNoYXBlWydwYXR0ZXJuJ10gIT09IHVuZGVmaW5lZCkgewogICAgICBpZiAoIShuZXcgUmVnRXhwKHNoYXBlWydwYXR0ZXJuJ10pKS50ZXN0KHZhbHVlKSkgewogICAgICAgIHRoaXMuZmFpbCgnUGF0dGVybk1hdGNoRXJyb3InLCAnUHJvdmlkZWQgdmFsdWUgIicgKyB2YWx1ZSArICciICcKICAgICAgICAgICsgJ2RvZXMgbm90IG1hdGNoIHJlZ2V4IHBhdHRlcm4gLycgKyBzaGFwZVsncGF0dGVybiddICsgJy8gZm9yICcKICAgICAgICAgICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0KICB9LAoKICB2YWxpZGF0ZVJhbmdlOiBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCwgZGVzY3JpcHRvcikgewogICAgaWYgKHRoaXMudmFsaWRhdGlvblsnbWluJ10pIHsKICAgICAgaWYgKHNoYXBlWydtaW4nXSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlIDwgc2hhcGVbJ21pbiddKSB7CiAgICAgICAgdGhpcy5mYWlsKCdNaW5SYW5nZUVycm9yJywgJ0V4cGVjdGVkICcgKyBkZXNjcmlwdG9yICsgJyA+PSAnCiAgICAgICAgICArIHNoYXBlWydtaW4nXSArICcsIGJ1dCBmb3VuZCAnICsgdmFsdWUgKyAnIGZvciAnICsgY29udGV4dCk7CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLnZhbGlkYXRpb25bJ21heCddKSB7CiAgICAgIGlmIChzaGFwZVsnbWF4J10gIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA+IHNoYXBlWydtYXgnXSkgewogICAgICAgIHRoaXMuZmFpbCgnTWF4UmFuZ2VFcnJvcicsICdFeHBlY3RlZCAnICsgZGVzY3JpcHRvciArICcgPD0gJwogICAgICAgICAgKyBzaGFwZVsnbWF4J10gKyAnLCBidXQgZm91bmQgJyArIHZhbHVlICsgJyBmb3IgJyArIGNvbnRleHQpOwogICAgICB9CiAgICB9CiAgfSwKCiAgdmFsaWRhdGVFbnVtOiBmdW5jdGlvbiB2YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCkgewogICAgaWYgKHRoaXMudmFsaWRhdGlvblsnZW51bSddICYmIHNoYXBlWydlbnVtJ10gIT09IHVuZGVmaW5lZCkgewogICAgICAvLyBGYWlsIGlmIHRoZSBzdHJpbmcgdmFsdWUgaXMgbm90IHByZXNlbnQgaW4gdGhlIGVudW0gbGlzdAogICAgICBpZiAoc2hhcGVbJ2VudW0nXS5pbmRleE9mKHZhbHVlKSA9PT0gLTEpIHsKICAgICAgICB0aGlzLmZhaWwoJ0VudW1FcnJvcicsICdGb3VuZCBzdHJpbmcgdmFsdWUgb2YgJyArIHZhbHVlICsgJywgYnV0ICcKICAgICAgICAgICsgJ2V4cGVjdGVkICcgKyBzaGFwZVsnZW51bSddLmpvaW4oJ3wnKSArICcgZm9yICcgKyBjb250ZXh0KTsKICAgICAgfQogICAgfQogIH0sCgogIHZhbGlkYXRlVHlwZTogZnVuY3Rpb24gdmFsaWRhdGVUeXBlKHZhbHVlLCBjb250ZXh0LCBhY2NlcHRlZFR5cGVzLCB0eXBlKSB7CiAgICAvLyBXZSB3aWxsIG5vdCBsb2cgYW4gZXJyb3IgZm9yIG51bGwgb3IgdW5kZWZpbmVkLCBidXQgd2Ugd2lsbCByZXR1cm4KICAgIC8vIGZhbHNlIHNvIHRoYXQgY2FsbGVycyBrbm93IHRoYXQgdGhlIGV4cGVjdGVkIHR5cGUgd2FzIG5vdCBzdHJpY3RseSBtZXQuCiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIGZhbHNlOwoKICAgIHZhciBmb3VuZEludmFsaWRUeXBlID0gZmFsc2U7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFjY2VwdGVkVHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHR5cGVvZiBhY2NlcHRlZFR5cGVzW2ldID09PSAnc3RyaW5nJykgewogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IGFjY2VwdGVkVHlwZXNbaV0pIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKGFjY2VwdGVkVHlwZXNbaV0gaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICBpZiAoKHZhbHVlIHx8ICcnKS50b1N0cmluZygpLm1hdGNoKGFjY2VwdGVkVHlwZXNbaV0pKSByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBhY2NlcHRlZFR5cGVzW2ldKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAoQVdTLnV0aWwuaXNUeXBlKHZhbHVlLCBhY2NlcHRlZFR5cGVzW2ldKSkgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKCF0eXBlICYmICFmb3VuZEludmFsaWRUeXBlKSBhY2NlcHRlZFR5cGVzID0gYWNjZXB0ZWRUeXBlcy5zbGljZSgpOwogICAgICAgIGFjY2VwdGVkVHlwZXNbaV0gPSBBV1MudXRpbC50eXBlTmFtZShhY2NlcHRlZFR5cGVzW2ldKTsKICAgICAgfQogICAgICBmb3VuZEludmFsaWRUeXBlID0gdHJ1ZTsKICAgIH0KCiAgICB2YXIgYWNjZXB0ZWRUeXBlID0gdHlwZTsKICAgIGlmICghYWNjZXB0ZWRUeXBlKSB7CiAgICAgIGFjY2VwdGVkVHlwZSA9IGFjY2VwdGVkVHlwZXMuam9pbignLCAnKS5yZXBsYWNlKC8sKFteLF0rKSQvLCAnLCBvciQxJyk7CiAgICB9CgogICAgdmFyIHZvd2VsID0gYWNjZXB0ZWRUeXBlLm1hdGNoKC9eW2FlaW91XS9pKSA/ICduJyA6ICcnOwogICAgdGhpcy5mYWlsKCdJbnZhbGlkUGFyYW1ldGVyVHlwZScsICdFeHBlY3RlZCAnICsgY29udGV4dCArICcgdG8gYmUgYScgKwogICAgICAgICAgICAgIHZvd2VsICsgJyAnICsgYWNjZXB0ZWRUeXBlKTsKICAgIHJldHVybiBmYWxzZTsKICB9LAoKICB2YWxpZGF0ZU51bWJlcjogZnVuY3Rpb24gdmFsaWRhdGVOdW1iZXIoc2hhcGUsIHZhbHVlLCBjb250ZXh0KSB7CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgdmFyIGNhc3RlZFZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgICAgIGlmIChjYXN0ZWRWYWx1ZS50b1N0cmluZygpID09PSB2YWx1ZSkgdmFsdWUgPSBjYXN0ZWRWYWx1ZTsKICAgIH0KICAgIGlmICh0aGlzLnZhbGlkYXRlVHlwZSh2YWx1ZSwgY29udGV4dCwgWydudW1iZXInXSkpIHsKICAgICAgdGhpcy52YWxpZGF0ZVJhbmdlKHNoYXBlLCB2YWx1ZSwgY29udGV4dCwgJ251bWVyaWMgdmFsdWUnKTsKICAgIH0KICB9LAoKICB2YWxpZGF0ZVBheWxvYWQ6IGZ1bmN0aW9uIHZhbGlkYXRlUGF5bG9hZCh2YWx1ZSwgY29udGV4dCkgewogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSByZXR1cm47CiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlLmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSByZXR1cm47IC8vIHR5cGVkIGFycmF5cwogICAgaWYgKEFXUy51dGlsLmlzTm9kZSgpKSB7IC8vIHNwZWNpYWwgY2hlY2sgZm9yIGJ1ZmZlci9zdHJlYW0gaW4gTm9kZS5qcwogICAgICB2YXIgU3RyZWFtID0gQVdTLnV0aWwuc3RyZWFtLlN0cmVhbTsKICAgICAgaWYgKEFXUy51dGlsLkJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJlYW0pIHJldHVybjsKICAgIH0gZWxzZSB7CiAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gdm9pZCAwICYmIHZhbHVlIGluc3RhbmNlb2YgQmxvYikgcmV0dXJuOwogICAgfQoKICAgIHZhciB0eXBlcyA9IFsnQnVmZmVyJywgJ1N0cmVhbScsICdGaWxlJywgJ0Jsb2InLCAnQXJyYXlCdWZmZXInLCAnRGF0YVZpZXcnXTsKICAgIGlmICh2YWx1ZSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKEFXUy51dGlsLmlzVHlwZSh2YWx1ZSwgdHlwZXNbaV0pKSByZXR1cm47CiAgICAgICAgaWYgKEFXUy51dGlsLnR5cGVOYW1lKHZhbHVlLmNvbnN0cnVjdG9yKSA9PT0gdHlwZXNbaV0pIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIHRoaXMuZmFpbCgnSW52YWxpZFBhcmFtZXRlclR5cGUnLCAnRXhwZWN0ZWQgJyArIGNvbnRleHQgKyAnIHRvIGJlIGEgJyArCiAgICAgICdzdHJpbmcsIEJ1ZmZlciwgU3RyZWFtLCBCbG9iLCBvciB0eXBlZCBhcnJheSBvYmplY3QnKTsKICB9Cn0pOwoKfSx7Ii4vY29yZSI6MTl9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gIHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKCi8qKgogKiBQcmVwZW5kIHByZWZpeCBkZWZpbmVkIGJ5IEFQSSBtb2RlbCB0byBlbmRwb2ludCB0aGF0J3MgYWxyZWFkeQogKiBjb25zdHJ1Y3RlZC4gVGhpcyBmZWF0dXJlIGRvZXMgbm90IGFwcGx5IHRvIG9wZXJhdGlvbnMgdXNpbmcKICogZW5kcG9pbnQgZGlzY292ZXJ5IGFuZCBjYW4gYmUgZGlzYWJsZWQuCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gcG9wdWxhdGVIb3N0UHJlZml4KHJlcXVlc3QpICB7CiAgdmFyIGVuYWJsZWQgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmhvc3RQcmVmaXhFbmFibGVkOwogIGlmICghZW5hYmxlZCkgcmV0dXJuIHJlcXVlc3Q7CiAgdmFyIG9wZXJhdGlvbk1vZGVsID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAvL2Rvbid0IG1hcnNoYWwgaG9zdCBwcmVmaXggd2hlbiBvcGVyYXRpb24gaGFzIGVuZHBvaW50IGRpc2NvdmVyeSB0cmFpdHMKICBpZiAoaGFzRW5kcG9pbnREaXNjb3ZlcihyZXF1ZXN0KSkgcmV0dXJuIHJlcXVlc3Q7CiAgaWYgKG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50ICYmIG9wZXJhdGlvbk1vZGVsLmVuZHBvaW50Lmhvc3RQcmVmaXgpIHsKICAgIHZhciBob3N0UHJlZml4Tm90YXRpb24gPSBvcGVyYXRpb25Nb2RlbC5lbmRwb2ludC5ob3N0UHJlZml4OwogICAgdmFyIGhvc3RQcmVmaXggPSBleHBhbmRIb3N0UHJlZml4KGhvc3RQcmVmaXhOb3RhdGlvbiwgcmVxdWVzdC5wYXJhbXMsIG9wZXJhdGlvbk1vZGVsLmlucHV0KTsKICAgIHByZXBlbmRFbmRwb2ludFByZWZpeChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50LCBob3N0UHJlZml4KTsKICAgIHZhbGlkYXRlSG9zdG5hbWUocmVxdWVzdC5odHRwUmVxdWVzdC5lbmRwb2ludC5ob3N0bmFtZSk7CiAgfQogIHJldHVybiByZXF1ZXN0Owp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBoYXNFbmRwb2ludERpc2NvdmVyKHJlcXVlc3QpIHsKICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaTsKICB2YXIgb3BlcmF0aW9uTW9kZWwgPSBhcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgdmFyIGlzRW5kcG9pbnRPcGVyYXRpb24gPSBhcGkuZW5kcG9pbnRPcGVyYXRpb24gJiYgKGFwaS5lbmRwb2ludE9wZXJhdGlvbiA9PT0gdXRpbC5zdHJpbmcubG93ZXJGaXJzdChvcGVyYXRpb25Nb2RlbC5uYW1lKSk7CiAgcmV0dXJuIChvcGVyYXRpb25Nb2RlbC5lbmRwb2ludERpc2NvdmVyeVJlcXVpcmVkICE9PSAnTlVMTCcgfHwgaXNFbmRwb2ludE9wZXJhdGlvbiA9PT0gdHJ1ZSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIGV4cGFuZEhvc3RQcmVmaXgoaG9zdFByZWZpeE5vdGF0aW9uLCBwYXJhbXMsIHNoYXBlKSB7CiAgdXRpbC5lYWNoKHNoYXBlLm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgaWYgKG1lbWJlci5ob3N0TGFiZWwgPT09IHRydWUpIHsKICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbbmFtZV0gIT09ICdzdHJpbmcnIHx8IHBhcmFtc1tuYW1lXSA9PT0gJycpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgICBtZXNzYWdlOiAnUGFyYW1ldGVyICcgKyBuYW1lICsgJyBzaG91bGQgYmUgYSBub24tZW1wdHkgc3RyaW5nLicsCiAgICAgICAgICBjb2RlOiAnSW52YWxpZFBhcmFtZXRlcicKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdcXHsnICsgbmFtZSArICdcXH0nLCAnZycpOwogICAgICBob3N0UHJlZml4Tm90YXRpb24gPSBob3N0UHJlZml4Tm90YXRpb24ucmVwbGFjZShyZWdleCwgcGFyYW1zW25hbWVdKTsKICAgIH0KICB9KTsKICByZXR1cm4gaG9zdFByZWZpeE5vdGF0aW9uOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBwcmVwZW5kRW5kcG9pbnRQcmVmaXgoZW5kcG9pbnQsIHByZWZpeCkgewogIGlmIChlbmRwb2ludC5ob3N0KSB7CiAgICBlbmRwb2ludC5ob3N0ID0gcHJlZml4ICsgZW5kcG9pbnQuaG9zdDsKICB9CiAgaWYgKGVuZHBvaW50Lmhvc3RuYW1lKSB7CiAgICBlbmRwb2ludC5ob3N0bmFtZSA9IHByZWZpeCArIGVuZHBvaW50Lmhvc3RuYW1lOwogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gdmFsaWRhdGVIb3N0bmFtZShob3N0bmFtZSkgewogIHZhciBsYWJlbHMgPSBob3N0bmFtZS5zcGxpdCgnLicpOwogIC8vUmVmZXJlbmNlOiBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMTEyMyNzZWN0aW9uLTIKICB2YXIgaG9zdFBhdHRlcm4gPSAvXlthLXpBLVowLTldezF9JHxeW2EtekEtWjAtOV1bYS16QS1aMC05XC1dKlthLXpBLVowLTldJC87CiAgdXRpbC5hcnJheUVhY2gobGFiZWxzLCBmdW5jdGlvbihsYWJlbCkgewogICAgaWYgKCFsYWJlbC5sZW5ndGggfHwgbGFiZWwubGVuZ3RoIDwgMSB8fCBsYWJlbC5sZW5ndGggPiA2MykgewogICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ1ZhbGlkYXRpb25FcnJvcicsCiAgICAgICAgbWVzc2FnZTogJ0hvc3RuYW1lIGxhYmVsIGxlbmd0aCBzaG91bGQgYmUgYmV0d2VlbiAxIHRvIDYzIGNoYXJhY3RlcnMsIGluY2x1c2l2ZS4nCiAgICAgIH0pOwogICAgfQogICAgaWYgKCFob3N0UGF0dGVybi50ZXN0KGxhYmVsKSkgewogICAgICB0aHJvdyBBV1MudXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICB7Y29kZTogJ1ZhbGlkYXRpb25FcnJvcicsIG1lc3NhZ2U6IGxhYmVsICsgJyBpcyBub3QgaG9zdG5hbWUgY29tcGF0aWJsZS4nfSk7CiAgICB9CiAgfSk7Cn0KCm1vZHVsZS5leHBvcnRzID0gewogIHBvcHVsYXRlSG9zdFByZWZpeDogcG9wdWxhdGVIb3N0UHJlZml4Cn07Cgp9LHsiLi4vY29yZSI6MTksIi4uL3V0aWwiOjcyfV0sNDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIEpzb25CdWlsZGVyID0gcmVxdWlyZSgnLi4vanNvbi9idWlsZGVyJyk7CnZhciBKc29uUGFyc2VyID0gcmVxdWlyZSgnLi4vanNvbi9wYXJzZXInKTsKdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKCmZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICB2YXIgaHR0cFJlcXVlc3QgPSByZXEuaHR0cFJlcXVlc3Q7CiAgdmFyIGFwaSA9IHJlcS5zZXJ2aWNlLmFwaTsKICB2YXIgdGFyZ2V0ID0gYXBpLnRhcmdldFByZWZpeCArICcuJyArIGFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLm5hbWU7CiAgdmFyIHZlcnNpb24gPSBhcGkuanNvblZlcnNpb24gfHwgJzEuMCc7CiAgdmFyIGlucHV0ID0gYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CiAgdmFyIGJ1aWxkZXIgPSBuZXcgSnNvbkJ1aWxkZXIoKTsKCiAgaWYgKHZlcnNpb24gPT09IDEpIHZlcnNpb24gPSAnMS4wJzsKICBodHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci5idWlsZChyZXEucGFyYW1zIHx8IHt9LCBpbnB1dCk7CiAgaHR0cFJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAnYXBwbGljYXRpb24veC1hbXotanNvbi0nICsgdmVyc2lvbjsKICBodHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1UYXJnZXQnXSA9IHRhcmdldDsKCiAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7Cn0KCmZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgdmFyIGVycm9yID0ge307CiAgdmFyIGh0dHBSZXNwb25zZSA9IHJlc3AuaHR0cFJlc3BvbnNlOwoKICBlcnJvci5jb2RlID0gaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16bi1lcnJvcnR5cGUnXSB8fCAnVW5rbm93bkVycm9yJzsKICBpZiAodHlwZW9mIGVycm9yLmNvZGUgPT09ICdzdHJpbmcnKSB7CiAgICBlcnJvci5jb2RlID0gZXJyb3IuY29kZS5zcGxpdCgnOicpWzBdOwogIH0KCiAgaWYgKGh0dHBSZXNwb25zZS5ib2R5Lmxlbmd0aCA+IDApIHsKICAgIHRyeSB7CiAgICAgIHZhciBlID0gSlNPTi5wYXJzZShodHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpKTsKICAgICAgdmFyIGNvZGUgPSBlLl9fdHlwZSB8fCBlLmNvZGUgfHwgZS5Db2RlOwogICAgICBpZiAoY29kZSkgewogICAgICAgIGVycm9yLmNvZGUgPSBjb2RlLnNwbGl0KCcjJykucG9wKCk7CiAgICAgIH0KICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdSZXF1ZXN0RW50aXR5VG9vTGFyZ2UnKSB7CiAgICAgICAgZXJyb3IubWVzc2FnZSA9ICdSZXF1ZXN0IGJvZHkgbXVzdCBiZSBsZXNzIHRoYW4gMSBNQic7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZXJyb3IubWVzc2FnZSA9IChlLm1lc3NhZ2UgfHwgZS5NZXNzYWdlIHx8IG51bGwpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGVycm9yLnN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgZXJyb3IubWVzc2FnZSA9IGh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlOwogICAgfQogIH0gZWxzZSB7CiAgICBlcnJvci5zdGF0dXNDb2RlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICBlcnJvci5tZXNzYWdlID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUudG9TdHJpbmcoKTsKICB9CgogIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCBlcnJvcik7Cn0KCmZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICB2YXIgYm9keSA9IHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSB8fCAne30nOwogIGlmIChyZXNwLnJlcXVlc3Quc2VydmljZS5jb25maWcuY29udmVydFJlc3BvbnNlVHlwZXMgPT09IGZhbHNlKSB7CiAgICByZXNwLmRhdGEgPSBKU09OLnBhcnNlKGJvZHkpOwogIH0gZWxzZSB7CiAgICB2YXIgb3BlcmF0aW9uID0gcmVzcC5yZXF1ZXN0LnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogICAgdmFyIHBhcnNlciA9IG5ldyBKc29uUGFyc2VyKCk7CiAgICByZXNwLmRhdGEgPSBwYXJzZXIucGFyc2UoYm9keSwgc2hhcGUpOwogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgYnVpbGRSZXF1ZXN0OiBidWlsZFJlcXVlc3QsCiAgZXh0cmFjdEVycm9yOiBleHRyYWN0RXJyb3IsCiAgZXh0cmFjdERhdGE6IGV4dHJhY3REYXRhCn07Cgp9LHsiLi4vanNvbi9idWlsZGVyIjozNywiLi4vanNvbi9wYXJzZXIiOjM4LCIuLi91dGlsIjo3MiwiLi9oZWxwZXJzIjo0Nn1dLDQ4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBRdWVyeVBhcmFtU2VyaWFsaXplciA9IHJlcXVpcmUoJy4uL3F1ZXJ5L3F1ZXJ5X3BhcmFtX3NlcmlhbGl6ZXInKTsKdmFyIFNoYXBlID0gcmVxdWlyZSgnLi4vbW9kZWwvc2hhcGUnKTsKdmFyIHBvcHVsYXRlSG9zdFByZWZpeCA9IHJlcXVpcmUoJy4vaGVscGVycycpLnBvcHVsYXRlSG9zdFByZWZpeDsKCmZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgdmFyIGh0dHBSZXF1ZXN0ID0gcmVxLmh0dHBSZXF1ZXN0OwogIGh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0KICAgICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9dXRmLTgnOwogIGh0dHBSZXF1ZXN0LnBhcmFtcyA9IHsKICAgIFZlcnNpb246IHJlcS5zZXJ2aWNlLmFwaS5hcGlWZXJzaW9uLAogICAgQWN0aW9uOiBvcGVyYXRpb24ubmFtZQogIH07CgogIC8vIGNvbnZlcnQgdGhlIHJlcXVlc3QgcGFyYW1ldGVycyBpbnRvIGEgbGlzdCBvZiBxdWVyeSBwYXJhbXMsCiAgLy8gZS5nLiBEZWVwbHkuTmVzdGVkUGFyYW0uMC5OYW1lPXZhbHVlCiAgdmFyIGJ1aWxkZXIgPSBuZXcgUXVlcnlQYXJhbVNlcmlhbGl6ZXIoKTsKICBidWlsZGVyLnNlcmlhbGl6ZShyZXEucGFyYW1zLCBvcGVyYXRpb24uaW5wdXQsIGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICBodHRwUmVxdWVzdC5wYXJhbXNbbmFtZV0gPSB2YWx1ZTsKICB9KTsKICBodHRwUmVxdWVzdC5ib2R5ID0gdXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKGh0dHBSZXF1ZXN0LnBhcmFtcyk7CgogIHBvcHVsYXRlSG9zdFByZWZpeChyZXEpOwp9CgpmdW5jdGlvbiBleHRyYWN0RXJyb3IocmVzcCkgewogIHZhciBkYXRhLCBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpOwogIGlmIChib2R5Lm1hdGNoKCc8VW5rbm93bk9wZXJhdGlvbkV4Y2VwdGlvbicpKSB7CiAgICBkYXRhID0gewogICAgICBDb2RlOiAnVW5rbm93bk9wZXJhdGlvbicsCiAgICAgIE1lc3NhZ2U6ICdVbmtub3duIG9wZXJhdGlvbiAnICsgcmVzcC5yZXF1ZXN0Lm9wZXJhdGlvbgogICAgfTsKICB9IGVsc2UgewogICAgdHJ5IHsKICAgICAgZGF0YSA9IG5ldyBBV1MuWE1MLlBhcnNlcigpLnBhcnNlKGJvZHkpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBkYXRhID0gewogICAgICAgIENvZGU6IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUsCiAgICAgICAgTWVzc2FnZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzTWVzc2FnZQogICAgICB9OwogICAgfQogIH0KCiAgaWYgKGRhdGEucmVxdWVzdElkICYmICFyZXNwLnJlcXVlc3RJZCkgcmVzcC5yZXF1ZXN0SWQgPSBkYXRhLnJlcXVlc3RJZDsKICBpZiAoZGF0YS5FcnJvcnMpIGRhdGEgPSBkYXRhLkVycm9yczsKICBpZiAoZGF0YS5FcnJvcikgZGF0YSA9IGRhdGEuRXJyb3I7CiAgaWYgKGRhdGEuQ29kZSkgewogICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgY29kZTogZGF0YS5Db2RlLAogICAgICBtZXNzYWdlOiBkYXRhLk1lc3NhZ2UKICAgIH0pOwogIH0gZWxzZSB7CiAgICByZXNwLmVycm9yID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwgewogICAgICBjb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICBtZXNzYWdlOiBudWxsCiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGV4dHJhY3REYXRhKHJlc3ApIHsKICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICB2YXIgc2hhcGUgPSBvcGVyYXRpb24ub3V0cHV0IHx8IHt9OwogIHZhciBvcmlnUnVsZXMgPSBzaGFwZTsKCiAgaWYgKG9yaWdSdWxlcy5yZXN1bHRXcmFwcGVyKSB7CiAgICB2YXIgdG1wID0gU2hhcGUuY3JlYXRlKHt0eXBlOiAnc3RydWN0dXJlJ30pOwogICAgdG1wLm1lbWJlcnNbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdID0gc2hhcGU7CiAgICB0bXAubWVtYmVyTmFtZXMgPSBbb3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXJdOwogICAgdXRpbC5wcm9wZXJ0eShzaGFwZSwgJ25hbWUnLCBzaGFwZS5yZXN1bHRXcmFwcGVyKTsKICAgIHNoYXBlID0gdG1wOwogIH0KCiAgdmFyIHBhcnNlciA9IG5ldyBBV1MuWE1MLlBhcnNlcigpOwoKICAvLyBUT0RPOiBSZWZhY3RvciBYTUwgUGFyc2VyIHRvIHBhcnNlIFJlcXVlc3RJZCBmcm9tIHJlc3BvbnNlLgogIGlmIChzaGFwZSAmJiBzaGFwZS5tZW1iZXJzICYmICFzaGFwZS5tZW1iZXJzLl9YQU1aUmVxdWVzdElkKSB7CiAgICB2YXIgcmVxdWVzdElkU2hhcGUgPSBTaGFwZS5jcmVhdGUoCiAgICAgIHsgdHlwZTogJ3N0cmluZycgfSwKICAgICAgeyBhcGk6IHsgcHJvdG9jb2w6ICdxdWVyeScgfSB9LAogICAgICAncmVxdWVzdElkJwogICAgKTsKICAgIHNoYXBlLm1lbWJlcnMuX1hBTVpSZXF1ZXN0SWQgPSByZXF1ZXN0SWRTaGFwZTsKICB9CgogIHZhciBkYXRhID0gcGFyc2VyLnBhcnNlKHJlc3AuaHR0cFJlc3BvbnNlLmJvZHkudG9TdHJpbmcoKSwgc2hhcGUpOwogIHJlc3AucmVxdWVzdElkID0gZGF0YS5fWEFNWlJlcXVlc3RJZCB8fCBkYXRhLnJlcXVlc3RJZDsKCiAgaWYgKGRhdGEuX1hBTVpSZXF1ZXN0SWQpIGRlbGV0ZSBkYXRhLl9YQU1aUmVxdWVzdElkOwoKICBpZiAob3JpZ1J1bGVzLnJlc3VsdFdyYXBwZXIpIHsKICAgIGlmIChkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSkgewogICAgICB1dGlsLnVwZGF0ZShkYXRhLCBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXSk7CiAgICAgIGRlbGV0ZSBkYXRhW29yaWdSdWxlcy5yZXN1bHRXcmFwcGVyXTsKICAgIH0KICB9CgogIHJlc3AuZGF0YSA9IGRhdGE7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogIGJ1aWxkUmVxdWVzdDogYnVpbGRSZXF1ZXN0LAogIGV4dHJhY3RFcnJvcjogZXh0cmFjdEVycm9yLAogIGV4dHJhY3REYXRhOiBleHRyYWN0RGF0YQp9OwoKfSx7Ii4uL2NvcmUiOjE5LCIuLi9tb2RlbC9zaGFwZSI6NDQsIi4uL3F1ZXJ5L3F1ZXJ5X3BhcmFtX3NlcmlhbGl6ZXIiOjUyLCIuLi91dGlsIjo3MiwiLi9oZWxwZXJzIjo0Nn1dLDQ5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBwb3B1bGF0ZUhvc3RQcmVmaXggPSByZXF1aXJlKCcuL2hlbHBlcnMnKS5wb3B1bGF0ZUhvc3RQcmVmaXg7CgpmdW5jdGlvbiBwb3B1bGF0ZU1ldGhvZChyZXEpIHsKICByZXEuaHR0cFJlcXVlc3QubWV0aG9kID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaHR0cE1ldGhvZDsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVVUkkoZW5kcG9pbnRQYXRoLCBvcGVyYXRpb25QYXRoLCBpbnB1dCwgcGFyYW1zKSB7CiAgdmFyIHVyaSA9IFtlbmRwb2ludFBhdGgsIG9wZXJhdGlvblBhdGhdLmpvaW4oJy8nKTsKICB1cmkgPSB1cmkucmVwbGFjZSgvXC8rL2csICcvJyk7CgogIHZhciBxdWVyeVN0cmluZyA9IHt9LCBxdWVyeVN0cmluZ1NldCA9IGZhbHNlOwogIHV0aWwuZWFjaChpbnB1dC5tZW1iZXJzLCBmdW5jdGlvbiAobmFtZSwgbWVtYmVyKSB7CiAgICB2YXIgcGFyYW1WYWx1ZSA9IHBhcmFtc1tuYW1lXTsKICAgIGlmIChwYXJhbVZhbHVlID09PSBudWxsIHx8IHBhcmFtVmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwogICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3VyaScpIHsKICAgICAgdmFyIHJlZ2V4ID0gbmV3IFJlZ0V4cCgnXFx7JyArIG1lbWJlci5uYW1lICsgJyhcXCspP1xcfScpOwogICAgICB1cmkgPSB1cmkucmVwbGFjZShyZWdleCwgZnVuY3Rpb24oXywgcGx1cykgewogICAgICAgIHZhciBmbiA9IHBsdXMgPyB1dGlsLnVyaUVzY2FwZVBhdGggOiB1dGlsLnVyaUVzY2FwZTsKICAgICAgICByZXR1cm4gZm4oU3RyaW5nKHBhcmFtVmFsdWUpKTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ3F1ZXJ5c3RyaW5nJykgewogICAgICBxdWVyeVN0cmluZ1NldCA9IHRydWU7CgogICAgICBpZiAobWVtYmVyLnR5cGUgPT09ICdsaXN0JykgewogICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHBhcmFtVmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgcmV0dXJuIHV0aWwudXJpRXNjYXBlKG1lbWJlci5tZW1iZXIudG9XaXJlRm9ybWF0KHZhbCkudG9TdHJpbmcoKSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgICAgdXRpbC5lYWNoKHBhcmFtVmFsdWUsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgIHJldHVybiB1dGlsLnVyaUVzY2FwZShTdHJpbmcodmFsKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcXVlcnlTdHJpbmdba2V5XSA9IHV0aWwudXJpRXNjYXBlKFN0cmluZyh2YWx1ZSkpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHF1ZXJ5U3RyaW5nW21lbWJlci5uYW1lXSA9IHV0aWwudXJpRXNjYXBlKG1lbWJlci50b1dpcmVGb3JtYXQocGFyYW1WYWx1ZSkudG9TdHJpbmcoKSk7CiAgICAgIH0KICAgIH0KICB9KTsKCiAgaWYgKHF1ZXJ5U3RyaW5nU2V0KSB7CiAgICB1cmkgKz0gKHVyaS5pbmRleE9mKCc/JykgPj0gMCA/ICcmJyA6ICc/Jyk7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHV0aWwuYXJyYXlFYWNoKE9iamVjdC5rZXlzKHF1ZXJ5U3RyaW5nKS5zb3J0KCksIGZ1bmN0aW9uKGtleSkgewogICAgICBpZiAoIUFycmF5LmlzQXJyYXkocXVlcnlTdHJpbmdba2V5XSkpIHsKICAgICAgICBxdWVyeVN0cmluZ1trZXldID0gW3F1ZXJ5U3RyaW5nW2tleV1dOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVlcnlTdHJpbmdba2V5XS5sZW5ndGg7IGkrKykgewogICAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUoU3RyaW5nKGtleSkpICsgJz0nICsgcXVlcnlTdHJpbmdba2V5XVtpXSk7CiAgICAgIH0KICAgIH0pOwogICAgdXJpICs9IHBhcnRzLmpvaW4oJyYnKTsKICB9CgogIHJldHVybiB1cmk7Cn0KCmZ1bmN0aW9uIHBvcHVsYXRlVVJJKHJlcSkgewogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICB2YXIgaW5wdXQgPSBvcGVyYXRpb24uaW5wdXQ7CgogIHZhciB1cmkgPSBnZW5lcmF0ZVVSSShyZXEuaHR0cFJlcXVlc3QuZW5kcG9pbnQucGF0aCwgb3BlcmF0aW9uLmh0dHBQYXRoLCBpbnB1dCwgcmVxLnBhcmFtcyk7CiAgcmVxLmh0dHBSZXF1ZXN0LnBhdGggPSB1cmk7Cn0KCmZ1bmN0aW9uIHBvcHVsYXRlSGVhZGVycyhyZXEpIHsKICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgdXRpbC5lYWNoKG9wZXJhdGlvbi5pbnB1dC5tZW1iZXJzLCBmdW5jdGlvbiAobmFtZSwgbWVtYmVyKSB7CiAgICB2YXIgdmFsdWUgPSByZXEucGFyYW1zW25hbWVdOwogICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKCiAgICBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVycycgJiYgbWVtYmVyLnR5cGUgPT09ICdtYXAnKSB7CiAgICAgIHV0aWwuZWFjaCh2YWx1ZSwgZnVuY3Rpb24oa2V5LCBtZW1iZXJWYWx1ZSkgewogICAgICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzW21lbWJlci5uYW1lICsga2V5XSA9IG1lbWJlclZhbHVlOwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnaGVhZGVyJykgewogICAgICB2YWx1ZSA9IG1lbWJlci50b1dpcmVGb3JtYXQodmFsdWUpLnRvU3RyaW5nKCk7CiAgICAgIGlmIChtZW1iZXIuaXNKc29uVmFsdWUpIHsKICAgICAgICB2YWx1ZSA9IHV0aWwuYmFzZTY0LmVuY29kZSh2YWx1ZSk7CiAgICAgIH0KICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbbWVtYmVyLm5hbWVdID0gdmFsdWU7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGJ1aWxkUmVxdWVzdChyZXEpIHsKICBwb3B1bGF0ZU1ldGhvZChyZXEpOwogIHBvcHVsYXRlVVJJKHJlcSk7CiAgcG9wdWxhdGVIZWFkZXJzKHJlcSk7CiAgcG9wdWxhdGVIb3N0UHJlZml4KHJlcSk7Cn0KCmZ1bmN0aW9uIGV4dHJhY3RFcnJvcigpIHsKfQoKZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgdmFyIGRhdGEgPSB7fTsKICB2YXIgciA9IHJlc3AuaHR0cFJlc3BvbnNlOwogIHZhciBvcGVyYXRpb24gPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXTsKICB2YXIgb3V0cHV0ID0gb3BlcmF0aW9uLm91dHB1dDsKCiAgLy8gbm9ybWFsaXplIGhlYWRlcnMgbmFtZXMgdG8gbG93ZXItY2FzZWQga2V5cyBmb3IgbWF0Y2hpbmcKICB2YXIgaGVhZGVycyA9IHt9OwogIHV0aWwuZWFjaChyLmhlYWRlcnMsIGZ1bmN0aW9uIChrLCB2KSB7CiAgICBoZWFkZXJzW2sudG9Mb3dlckNhc2UoKV0gPSB2OwogIH0pOwoKICB1dGlsLmVhY2gob3V0cHV0Lm1lbWJlcnMsIGZ1bmN0aW9uKG5hbWUsIG1lbWJlcikgewogICAgdmFyIGhlYWRlciA9IChtZW1iZXIubmFtZSB8fCBuYW1lKS50b0xvd2VyQ2FzZSgpOwogICAgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcnMnICYmIG1lbWJlci50eXBlID09PSAnbWFwJykgewogICAgICBkYXRhW25hbWVdID0ge307CiAgICAgIHZhciBsb2NhdGlvbiA9IG1lbWJlci5pc0xvY2F0aW9uTmFtZSA/IG1lbWJlci5uYW1lIDogJyc7CiAgICAgIHZhciBwYXR0ZXJuID0gbmV3IFJlZ0V4cCgnXicgKyBsb2NhdGlvbiArICcoLispJywgJ2knKTsKICAgICAgdXRpbC5lYWNoKHIuaGVhZGVycywgZnVuY3Rpb24gKGssIHYpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gay5tYXRjaChwYXR0ZXJuKTsKICAgICAgICBpZiAocmVzdWx0ICE9PSBudWxsKSB7CiAgICAgICAgICBkYXRhW25hbWVdW3Jlc3VsdFsxXV0gPSB2OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKG1lbWJlci5sb2NhdGlvbiA9PT0gJ2hlYWRlcicpIHsKICAgICAgaWYgKGhlYWRlcnNbaGVhZGVyXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdmFyIHZhbHVlID0gbWVtYmVyLmlzSnNvblZhbHVlID8KICAgICAgICAgIHV0aWwuYmFzZTY0LmRlY29kZShoZWFkZXJzW2hlYWRlcl0pIDoKICAgICAgICAgIGhlYWRlcnNbaGVhZGVyXTsKICAgICAgICBkYXRhW25hbWVdID0gbWVtYmVyLnRvVHlwZSh2YWx1ZSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobWVtYmVyLmxvY2F0aW9uID09PSAnc3RhdHVzQ29kZScpIHsKICAgICAgZGF0YVtuYW1lXSA9IHBhcnNlSW50KHIuc3RhdHVzQ29kZSwgMTApOwogICAgfQogIH0pOwoKICByZXNwLmRhdGEgPSBkYXRhOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEsCiAgZ2VuZXJhdGVVUkk6IGdlbmVyYXRlVVJJCn07Cgp9LHsiLi4vdXRpbCI6NzIsIi4vaGVscGVycyI6NDZ9XSw1MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgUmVzdCA9IHJlcXVpcmUoJy4vcmVzdCcpOwp2YXIgSnNvbiA9IHJlcXVpcmUoJy4vanNvbicpOwp2YXIgSnNvbkJ1aWxkZXIgPSByZXF1aXJlKCcuLi9qc29uL2J1aWxkZXInKTsKdmFyIEpzb25QYXJzZXIgPSByZXF1aXJlKCcuLi9qc29uL3BhcnNlcicpOwoKZnVuY3Rpb24gcG9wdWxhdGVCb2R5KHJlcSkgewogIHZhciBidWlsZGVyID0gbmV3IEpzb25CdWlsZGVyKCk7CiAgdmFyIGlucHV0ID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl0uaW5wdXQ7CgogIGlmIChpbnB1dC5wYXlsb2FkKSB7CiAgICB2YXIgcGFyYW1zID0ge307CiAgICB2YXIgcGF5bG9hZFNoYXBlID0gaW5wdXQubWVtYmVyc1tpbnB1dC5wYXlsb2FkXTsKICAgIHBhcmFtcyA9IHJlcS5wYXJhbXNbaW5wdXQucGF5bG9hZF07CgogICAgaWYgKHBheWxvYWRTaGFwZS50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IGJ1aWxkZXIuYnVpbGQocGFyYW1zIHx8IHt9LCBwYXlsb2FkU2hhcGUpOwogICAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgICB9IGVsc2UgaWYgKHBhcmFtcyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIC8vIG5vbi1KU09OIHBheWxvYWQKICAgICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBwYXJhbXM7CiAgICAgIGlmIChwYXlsb2FkU2hhcGUudHlwZSA9PT0gJ2JpbmFyeScgfHwgcGF5bG9hZFNoYXBlLmlzU3RyZWFtaW5nKSB7CiAgICAgICAgYXBwbHlDb250ZW50VHlwZUhlYWRlcihyZXEsIHRydWUpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci5idWlsZChyZXEucGFyYW1zLCBpbnB1dCk7CiAgICBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseUNvbnRlbnRUeXBlSGVhZGVyKHJlcSwgaXNCaW5hcnkpIHsKICBpZiAoIXJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSkgewogICAgdmFyIHR5cGUgPSBpc0JpbmFyeSA/ICdiaW5hcnkvb2N0ZXQtc3RyZWFtJyA6ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgIHJlcS5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSA9IHR5cGU7CiAgfQp9CgpmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgUmVzdC5idWlsZFJlcXVlc3QocmVxKTsKCiAgLy8gbmV2ZXIgc2VuZCBib2R5IHBheWxvYWQgb24gR0VUL0hFQUQvREVMRVRFCiAgaWYgKFsnR0VUJywgJ0hFQUQnLCAnREVMRVRFJ10uaW5kZXhPZihyZXEuaHR0cFJlcXVlc3QubWV0aG9kKSA8IDApIHsKICAgIHBvcHVsYXRlQm9keShyZXEpOwogIH0KfQoKZnVuY3Rpb24gZXh0cmFjdEVycm9yKHJlc3ApIHsKICBKc29uLmV4dHJhY3RFcnJvcihyZXNwKTsKfQoKZnVuY3Rpb24gZXh0cmFjdERhdGEocmVzcCkgewogIFJlc3QuZXh0cmFjdERhdGEocmVzcCk7CgogIHZhciByZXEgPSByZXNwLnJlcXVlc3Q7CiAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dOwogIHZhciBydWxlcyA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcS5vcGVyYXRpb25dLm91dHB1dCB8fCB7fTsKICB2YXIgcGFyc2VyOwogIHZhciBoYXNFdmVudE91dHB1dCA9IG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dDsKCiAgaWYgKHJ1bGVzLnBheWxvYWQpIHsKICAgIHZhciBwYXlsb2FkTWVtYmVyID0gcnVsZXMubWVtYmVyc1tydWxlcy5wYXlsb2FkXTsKICAgIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICAgIGlmIChwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW0pIHsKICAgICAgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gdXRpbC5jcmVhdGVFdmVudFN0cmVhbSgKICAgICAgICBBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMiA/IHJlc3AuaHR0cFJlc3BvbnNlLnN0cmVhbSA6IGJvZHksCiAgICAgICAgcGFyc2VyLAogICAgICAgIHBheWxvYWRNZW1iZXIKICAgICAgKTsKICAgIH0gZWxzZSBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJyB8fCBwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdsaXN0JykgewogICAgICB2YXIgcGFyc2VyID0gbmV3IEpzb25QYXJzZXIoKTsKICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcGFyc2VyLnBhcnNlKGJvZHksIHBheWxvYWRNZW1iZXIpOwogICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gYm9keTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3AuZGF0YVtydWxlcy5wYXlsb2FkXSA9IHBheWxvYWRNZW1iZXIudG9UeXBlKGJvZHkpOwogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgZGF0YSA9IHJlc3AuZGF0YTsKICAgIEpzb24uZXh0cmFjdERhdGEocmVzcCk7CiAgICByZXNwLmRhdGEgPSB1dGlsLm1lcmdlKGRhdGEsIHJlc3AuZGF0YSk7CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKfTsKCn0seyIuLi9qc29uL2J1aWxkZXIiOjM3LCIuLi9qc29uL3BhcnNlciI6MzgsIi4uL3V0aWwiOjcyLCIuL2pzb24iOjQ3LCIuL3Jlc3QiOjQ5fV0sNTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKTsKdmFyIFJlc3QgPSByZXF1aXJlKCcuL3Jlc3QnKTsKCmZ1bmN0aW9uIHBvcHVsYXRlQm9keShyZXEpIHsKICB2YXIgaW5wdXQgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXEub3BlcmF0aW9uXS5pbnB1dDsKICB2YXIgYnVpbGRlciA9IG5ldyBBV1MuWE1MLkJ1aWxkZXIoKTsKICB2YXIgcGFyYW1zID0gcmVxLnBhcmFtczsKCiAgdmFyIHBheWxvYWQgPSBpbnB1dC5wYXlsb2FkOwogIGlmIChwYXlsb2FkKSB7CiAgICB2YXIgcGF5bG9hZE1lbWJlciA9IGlucHV0Lm1lbWJlcnNbcGF5bG9hZF07CiAgICBwYXJhbXMgPSBwYXJhbXNbcGF5bG9hZF07CiAgICBpZiAocGFyYW1zID09PSB1bmRlZmluZWQpIHJldHVybjsKCiAgICBpZiAocGF5bG9hZE1lbWJlci50eXBlID09PSAnc3RydWN0dXJlJykgewogICAgICB2YXIgcm9vdEVsZW1lbnQgPSBwYXlsb2FkTWVtYmVyLm5hbWU7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5ib2R5ID0gYnVpbGRlci50b1hNTChwYXJhbXMsIHBheWxvYWRNZW1iZXIsIHJvb3RFbGVtZW50LCB0cnVlKTsKICAgIH0gZWxzZSB7IC8vIG5vbi14bWwgcGF5bG9hZAogICAgICByZXEuaHR0cFJlcXVlc3QuYm9keSA9IHBhcmFtczsKICAgIH0KICB9IGVsc2UgewogICAgcmVxLmh0dHBSZXF1ZXN0LmJvZHkgPSBidWlsZGVyLnRvWE1MKHBhcmFtcywgaW5wdXQsIGlucHV0Lm5hbWUgfHwKICAgICAgaW5wdXQuc2hhcGUgfHwgdXRpbC5zdHJpbmcudXBwZXJGaXJzdChyZXEub3BlcmF0aW9uKSArICdSZXF1ZXN0Jyk7CiAgfQp9CgpmdW5jdGlvbiBidWlsZFJlcXVlc3QocmVxKSB7CiAgUmVzdC5idWlsZFJlcXVlc3QocmVxKTsKCiAgLy8gbmV2ZXIgc2VuZCBib2R5IHBheWxvYWQgb24gR0VUL0hFQUQKICBpZiAoWydHRVQnLCAnSEVBRCddLmluZGV4T2YocmVxLmh0dHBSZXF1ZXN0Lm1ldGhvZCkgPCAwKSB7CiAgICBwb3B1bGF0ZUJvZHkocmVxKTsKICB9Cn0KCmZ1bmN0aW9uIGV4dHJhY3RFcnJvcihyZXNwKSB7CiAgUmVzdC5leHRyYWN0RXJyb3IocmVzcCk7CgogIHZhciBkYXRhOwogIHRyeSB7CiAgICBkYXRhID0gbmV3IEFXUy5YTUwuUGFyc2VyKCkucGFyc2UocmVzcC5odHRwUmVzcG9uc2UuYm9keS50b1N0cmluZygpKTsKICB9IGNhdGNoIChlKSB7CiAgICBkYXRhID0gewogICAgICBDb2RlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlLAogICAgICBNZXNzYWdlOiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNNZXNzYWdlCiAgICB9OwogIH0KCiAgaWYgKGRhdGEuRXJyb3JzKSBkYXRhID0gZGF0YS5FcnJvcnM7CiAgaWYgKGRhdGEuRXJyb3IpIGRhdGEgPSBkYXRhLkVycm9yOwogIGlmIChkYXRhLkNvZGUpIHsKICAgIHJlc3AuZXJyb3IgPSB1dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgIGNvZGU6IGRhdGEuQ29kZSwKICAgICAgbWVzc2FnZTogZGF0YS5NZXNzYWdlCiAgICB9KTsKICB9IGVsc2UgewogICAgcmVzcC5lcnJvciA9IHV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgY29kZTogcmVzcC5odHRwUmVzcG9uc2Uuc3RhdHVzQ29kZSwKICAgICAgbWVzc2FnZTogbnVsbAogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBleHRyYWN0RGF0YShyZXNwKSB7CiAgUmVzdC5leHRyYWN0RGF0YShyZXNwKTsKCiAgdmFyIHBhcnNlcjsKICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogIHZhciBib2R5ID0gcmVzcC5odHRwUmVzcG9uc2UuYm9keTsKICB2YXIgb3BlcmF0aW9uID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbcmVxLm9wZXJhdGlvbl07CiAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CgogIHZhciBoYXNFdmVudE91dHB1dCA9IG9wZXJhdGlvbi5oYXNFdmVudE91dHB1dDsKCiAgdmFyIHBheWxvYWQgPSBvdXRwdXQucGF5bG9hZDsKICBpZiAocGF5bG9hZCkgewogICAgdmFyIHBheWxvYWRNZW1iZXIgPSBvdXRwdXQubWVtYmVyc1twYXlsb2FkXTsKICAgIGlmIChwYXlsb2FkTWVtYmVyLmlzRXZlbnRTdHJlYW0pIHsKICAgICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHV0aWwuY3JlYXRlRXZlbnRTdHJlYW0oCiAgICAgICAgQVdTLkh0dHBDbGllbnQuc3RyZWFtc0FwaVZlcnNpb24gPT09IDIgPyByZXNwLmh0dHBSZXNwb25zZS5zdHJlYW0gOiByZXNwLmh0dHBSZXNwb25zZS5ib2R5LAogICAgICAgIHBhcnNlciwKICAgICAgICBwYXlsb2FkTWVtYmVyCiAgICAgICk7CiAgICB9IGVsc2UgaWYgKHBheWxvYWRNZW1iZXIudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgICAgcGFyc2VyID0gbmV3IEFXUy5YTUwuUGFyc2VyKCk7CiAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHBhcnNlci5wYXJzZShib2R5LnRvU3RyaW5nKCksIHBheWxvYWRNZW1iZXIpOwogICAgfSBlbHNlIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdiaW5hcnknIHx8IHBheWxvYWRNZW1iZXIuaXNTdHJlYW1pbmcpIHsKICAgICAgcmVzcC5kYXRhW3BheWxvYWRdID0gYm9keTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3AuZGF0YVtwYXlsb2FkXSA9IHBheWxvYWRNZW1iZXIudG9UeXBlKGJvZHkpOwogICAgfQogIH0gZWxzZSBpZiAoYm9keS5sZW5ndGggPiAwKSB7CiAgICBwYXJzZXIgPSBuZXcgQVdTLlhNTC5QYXJzZXIoKTsKICAgIHZhciBkYXRhID0gcGFyc2VyLnBhcnNlKGJvZHkudG9TdHJpbmcoKSwgb3V0cHV0KTsKICAgIHV0aWwudXBkYXRlKHJlc3AuZGF0YSwgZGF0YSk7CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICBidWlsZFJlcXVlc3Q6IGJ1aWxkUmVxdWVzdCwKICBleHRyYWN0RXJyb3I6IGV4dHJhY3RFcnJvciwKICBleHRyYWN0RGF0YTogZXh0cmFjdERhdGEKfTsKCn0seyIuLi9jb3JlIjoxOSwiLi4vdXRpbCI6NzIsIi4vcmVzdCI6NDl9XSw1MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKZnVuY3Rpb24gUXVlcnlQYXJhbVNlcmlhbGl6ZXIoKSB7Cn0KClF1ZXJ5UGFyYW1TZXJpYWxpemVyLnByb3RvdHlwZS5zZXJpYWxpemUgPSBmdW5jdGlvbihwYXJhbXMsIHNoYXBlLCBmbikgewogIHNlcmlhbGl6ZVN0cnVjdHVyZSgnJywgcGFyYW1zLCBzaGFwZSwgZm4pOwp9OwoKZnVuY3Rpb24gdWNmaXJzdChzaGFwZSkgewogIGlmIChzaGFwZS5pc1F1ZXJ5TmFtZSB8fCBzaGFwZS5hcGkucHJvdG9jb2wgIT09ICdlYzInKSB7CiAgICByZXR1cm4gc2hhcGUubmFtZTsKICB9IGVsc2UgewogICAgcmV0dXJuIHNoYXBlLm5hbWVbMF0udG9VcHBlckNhc2UoKSArIHNoYXBlLm5hbWUuc3Vic3RyKDEpOwogIH0KfQoKZnVuY3Rpb24gc2VyaWFsaXplU3RydWN0dXJlKHByZWZpeCwgc3RydWN0LCBydWxlcywgZm4pIHsKICB1dGlsLmVhY2gocnVsZXMubWVtYmVycywgZnVuY3Rpb24obmFtZSwgbWVtYmVyKSB7CiAgICB2YXIgdmFsdWUgPSBzdHJ1Y3RbbmFtZV07CiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuOwoKICAgIHZhciBtZW1iZXJOYW1lID0gdWNmaXJzdChtZW1iZXIpOwogICAgbWVtYmVyTmFtZSA9IHByZWZpeCA/IHByZWZpeCArICcuJyArIG1lbWJlck5hbWUgOiBtZW1iZXJOYW1lOwogICAgc2VyaWFsaXplTWVtYmVyKG1lbWJlck5hbWUsIHZhbHVlLCBtZW1iZXIsIGZuKTsKICB9KTsKfQoKZnVuY3Rpb24gc2VyaWFsaXplTWFwKG5hbWUsIG1hcCwgcnVsZXMsIGZuKSB7CiAgdmFyIGkgPSAxOwogIHV0aWwuZWFjaChtYXAsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICB2YXIgcHJlZml4ID0gcnVsZXMuZmxhdHRlbmVkID8gJy4nIDogJy5lbnRyeS4nOwogICAgdmFyIHBvc2l0aW9uID0gcHJlZml4ICsgKGkrKykgKyAnLic7CiAgICB2YXIga2V5TmFtZSA9IHBvc2l0aW9uICsgKHJ1bGVzLmtleS5uYW1lIHx8ICdrZXknKTsKICAgIHZhciB2YWx1ZU5hbWUgPSBwb3NpdGlvbiArIChydWxlcy52YWx1ZS5uYW1lIHx8ICd2YWx1ZScpOwogICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyBrZXlOYW1lLCBrZXksIHJ1bGVzLmtleSwgZm4pOwogICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyB2YWx1ZU5hbWUsIHZhbHVlLCBydWxlcy52YWx1ZSwgZm4pOwogIH0pOwp9CgpmdW5jdGlvbiBzZXJpYWxpemVMaXN0KG5hbWUsIGxpc3QsIHJ1bGVzLCBmbikgewogIHZhciBtZW1iZXJSdWxlcyA9IHJ1bGVzLm1lbWJlciB8fCB7fTsKCiAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICBmbi5jYWxsKHRoaXMsIG5hbWUsIG51bGwpOwogICAgcmV0dXJuOwogIH0KCiAgdXRpbC5hcnJheUVhY2gobGlzdCwgZnVuY3Rpb24gKHYsIG4pIHsKICAgIHZhciBzdWZmaXggPSAnLicgKyAobiArIDEpOwogICAgaWYgKHJ1bGVzLmFwaS5wcm90b2NvbCA9PT0gJ2VjMicpIHsKICAgICAgLy8gRG8gbm90aGluZyBmb3IgRUMyCiAgICAgIHN1ZmZpeCA9IHN1ZmZpeCArICcnOyAvLyBtYWtlIGxpbnRlciBoYXBweQogICAgfSBlbHNlIGlmIChydWxlcy5mbGF0dGVuZWQpIHsKICAgICAgaWYgKG1lbWJlclJ1bGVzLm5hbWUpIHsKICAgICAgICB2YXIgcGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7CiAgICAgICAgcGFydHMucG9wKCk7CiAgICAgICAgcGFydHMucHVzaCh1Y2ZpcnN0KG1lbWJlclJ1bGVzKSk7CiAgICAgICAgbmFtZSA9IHBhcnRzLmpvaW4oJy4nKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgc3VmZml4ID0gJy4nICsgKG1lbWJlclJ1bGVzLm5hbWUgPyBtZW1iZXJSdWxlcy5uYW1lIDogJ21lbWJlcicpICsgc3VmZml4OwogICAgfQogICAgc2VyaWFsaXplTWVtYmVyKG5hbWUgKyBzdWZmaXgsIHYsIG1lbWJlclJ1bGVzLCBmbik7CiAgfSk7Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZU1lbWJlcihuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKSB7CiAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybjsKICBpZiAocnVsZXMudHlwZSA9PT0gJ3N0cnVjdHVyZScpIHsKICAgIHNlcmlhbGl6ZVN0cnVjdHVyZShuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICB9IGVsc2UgaWYgKHJ1bGVzLnR5cGUgPT09ICdsaXN0JykgewogICAgc2VyaWFsaXplTGlzdChuYW1lLCB2YWx1ZSwgcnVsZXMsIGZuKTsKICB9IGVsc2UgaWYgKHJ1bGVzLnR5cGUgPT09ICdtYXAnKSB7CiAgICBzZXJpYWxpemVNYXAobmFtZSwgdmFsdWUsIHJ1bGVzLCBmbik7CiAgfSBlbHNlIHsKICAgIGZuKG5hbWUsIHJ1bGVzLnRvV2lyZUZvcm1hdCh2YWx1ZSkudG9TdHJpbmcoKSk7CiAgfQp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IFF1ZXJ5UGFyYW1TZXJpYWxpemVyOwoKfSx7Ii4uL3V0aWwiOjcyfV0sNTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHsKICAvL3Byb3ZpZGUgcmVhbHRpbWUgY2xvY2sgZm9yIHBlcmZvcm1hbmNlIG1lYXN1cmVtZW50CiAgbm93OiBmdW5jdGlvbiBub3coKSB7CiAgICBpZiAodHlwZW9mIHBlcmZvcm1hbmNlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHJldHVybiBwZXJmb3JtYW5jZS5ub3coKTsKICAgIH0KICAgIHJldHVybiBEYXRlLm5vdygpOwogIH0KfTsKCn0se31dLDU0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKZnVuY3Rpb24gaXNGaXBzUmVnaW9uKHJlZ2lvbikgewogIHJldHVybiB0eXBlb2YgcmVnaW9uID09PSAnc3RyaW5nJyAmJiAocmVnaW9uLnN0YXJ0c1dpdGgoJ2ZpcHMtJykgfHwgcmVnaW9uLmVuZHNXaXRoKCctZmlwcycpKTsKfQoKZnVuY3Rpb24gaXNHbG9iYWxSZWdpb24ocmVnaW9uKSB7CiAgcmV0dXJuIHR5cGVvZiByZWdpb24gPT09ICdzdHJpbmcnICYmIFsnYXdzLWdsb2JhbCcsICdhd3MtdXMtZ292LWdsb2JhbCddLmluY2x1ZGVzKHJlZ2lvbik7Cn0KCmZ1bmN0aW9uIGdldFJlYWxSZWdpb24ocmVnaW9uKSB7CiAgcmV0dXJuIFsnZmlwcy1hd3MtZ2xvYmFsJywgJ2F3cy1maXBzJywgJ2F3cy1nbG9iYWwnXS5pbmNsdWRlcyhyZWdpb24pCiAgICAgID8gJ3VzLWVhc3QtMScKICAgICAgOiBbJ2ZpcHMtYXdzLXVzLWdvdi1nbG9iYWwnLCAnYXdzLXVzLWdvdi1nbG9iYWwnXS5pbmNsdWRlcyhyZWdpb24pCiAgICAgID8gJ3VzLWdvdi13ZXN0LTEnCiAgICAgIDogcmVnaW9uLnJlcGxhY2UoL2ZpcHMtKGRrci18cHJvZC0pP3wtZmlwcy8sICcnKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgaXNGaXBzUmVnaW9uOiBpc0ZpcHNSZWdpb24sCiAgaXNHbG9iYWxSZWdpb246IGlzR2xvYmFsUmVnaW9uLAogIGdldFJlYWxSZWdpb246IGdldFJlYWxSZWdpb24KfTsKCn0se31dLDU1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKdmFyIHJlZ2lvbkNvbmZpZyA9IHJlcXVpcmUoJy4vcmVnaW9uX2NvbmZpZ19kYXRhLmpzb24nKTsKCmZ1bmN0aW9uIGdlbmVyYXRlUmVnaW9uUHJlZml4KHJlZ2lvbikgewogIGlmICghcmVnaW9uKSByZXR1cm4gbnVsbDsKICB2YXIgcGFydHMgPSByZWdpb24uc3BsaXQoJy0nKTsKICBpZiAocGFydHMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CiAgcmV0dXJuIHBhcnRzLnNsaWNlKDAsIHBhcnRzLmxlbmd0aCAtIDIpLmpvaW4oJy0nKSArICctKic7Cn0KCmZ1bmN0aW9uIGRlcml2ZWRLZXlzKHNlcnZpY2UpIHsKICB2YXIgcmVnaW9uID0gc2VydmljZS5jb25maWcucmVnaW9uOwogIHZhciByZWdpb25QcmVmaXggPSBnZW5lcmF0ZVJlZ2lvblByZWZpeChyZWdpb24pOwogIHZhciBlbmRwb2ludFByZWZpeCA9IHNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4OwoKICByZXR1cm4gWwogICAgW3JlZ2lvbiwgZW5kcG9pbnRQcmVmaXhdLAogICAgW3JlZ2lvblByZWZpeCwgZW5kcG9pbnRQcmVmaXhdLAogICAgW3JlZ2lvbiwgJyonXSwKICAgIFtyZWdpb25QcmVmaXgsICcqJ10sCiAgICBbJyonLCBlbmRwb2ludFByZWZpeF0sCiAgICBbJyonLCAnKiddCiAgXS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgcmV0dXJuIGl0ZW1bMF0gJiYgaXRlbVsxXSA/IGl0ZW0uam9pbignLycpIDogbnVsbDsKICB9KTsKfQoKZnVuY3Rpb24gYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKSB7CiAgdXRpbC5lYWNoKGNvbmZpZywgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgaWYgKGtleSA9PT0gJ2dsb2JhbEVuZHBvaW50JykgcmV0dXJuOwogICAgaWYgKHNlcnZpY2UuY29uZmlnW2tleV0gPT09IHVuZGVmaW5lZCB8fCBzZXJ2aWNlLmNvbmZpZ1trZXldID09PSBudWxsKSB7CiAgICAgIHNlcnZpY2UuY29uZmlnW2tleV0gPSB2YWx1ZTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gY29uZmlndXJlRW5kcG9pbnQoc2VydmljZSkgewogIHZhciBrZXlzID0gZGVyaXZlZEtleXMoc2VydmljZSk7CiAgdmFyIHVzZUZpcHNFbmRwb2ludCA9IHNlcnZpY2UuY29uZmlnLnVzZUZpcHNFbmRwb2ludDsKICB2YXIgdXNlRHVhbHN0YWNrRW5kcG9pbnQgPSBzZXJ2aWNlLmNvbmZpZy51c2VEdWFsc3RhY2tFbmRwb2ludDsKICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgaWYgKCFrZXkpIGNvbnRpbnVlOwoKICAgIHZhciBydWxlcyA9IHVzZUZpcHNFbmRwb2ludAogICAgICA/IHVzZUR1YWxzdGFja0VuZHBvaW50CiAgICAgICAgPyByZWdpb25Db25maWcuZHVhbHN0YWNrRmlwc1J1bGVzCiAgICAgICAgOiByZWdpb25Db25maWcuZmlwc1J1bGVzCiAgICAgIDogdXNlRHVhbHN0YWNrRW5kcG9pbnQKICAgICAgPyByZWdpb25Db25maWcuZHVhbHN0YWNrUnVsZXMKICAgICAgOiByZWdpb25Db25maWcucnVsZXM7CgogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChydWxlcywga2V5KSkgewogICAgICB2YXIgY29uZmlnID0gcnVsZXNba2V5XTsKICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgY29uZmlnID0gcmVnaW9uQ29uZmlnLnBhdHRlcm5zW2NvbmZpZ107CiAgICAgIH0KCiAgICAgIC8vIHNldCBnbG9iYWwgZW5kcG9pbnQKICAgICAgc2VydmljZS5pc0dsb2JhbEVuZHBvaW50ID0gISFjb25maWcuZ2xvYmFsRW5kcG9pbnQ7CiAgICAgIGlmIChjb25maWcuc2lnbmluZ1JlZ2lvbikgewogICAgICAgIHNlcnZpY2Uuc2lnbmluZ1JlZ2lvbiA9IGNvbmZpZy5zaWduaW5nUmVnaW9uOwogICAgICB9CgogICAgICAvLyBzaWduYXR1cmUgdmVyc2lvbgogICAgICBpZiAoIWNvbmZpZy5zaWduYXR1cmVWZXJzaW9uKSBjb25maWcuc2lnbmF0dXJlVmVyc2lvbiA9ICd2NCc7CgogICAgICAvLyBtZXJnZSBjb25maWcKICAgICAgYXBwbHlDb25maWcoc2VydmljZSwgY29uZmlnKTsKICAgICAgcmV0dXJuOwogICAgfQogIH0KfQoKZnVuY3Rpb24gZ2V0RW5kcG9pbnRTdWZmaXgocmVnaW9uKSB7CiAgdmFyIHJlZ2lvblJlZ2V4ZXMgPSB7CiAgICAnXih1c3xldXxhcHxzYXxjYXxtZSlcXC1cXHcrXFwtXFxkKyQnOiAnYW1hem9uYXdzLmNvbScsCiAgICAnXmNuXFwtXFx3K1xcLVxcZCskJzogJ2FtYXpvbmF3cy5jb20uY24nLAogICAgJ151c1xcLWdvdlxcLVxcdytcXC1cXGQrJCc6ICdhbWF6b25hd3MuY29tJywKICAgICdedXNcXC1pc29cXC1cXHcrXFwtXFxkKyQnOiAnYzJzLmljLmdvdicsCiAgICAnXnVzXFwtaXNvYlxcLVxcdytcXC1cXGQrJCc6ICdzYzJzLnNnb3YuZ292JwogIH07CiAgdmFyIGRlZmF1bHRTdWZmaXggPSAnYW1hem9uYXdzLmNvbSc7CiAgdmFyIHJlZ2V4ZXMgPSBPYmplY3Qua2V5cyhyZWdpb25SZWdleGVzKTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2V4ZXMubGVuZ3RoOyBpKyspIHsKICAgIHZhciByZWdpb25QYXR0ZXJuID0gUmVnRXhwKHJlZ2V4ZXNbaV0pOwogICAgdmFyIGRuc1N1ZmZpeCA9IHJlZ2lvblJlZ2V4ZXNbcmVnZXhlc1tpXV07CiAgICBpZiAocmVnaW9uUGF0dGVybi50ZXN0KHJlZ2lvbikpIHJldHVybiBkbnNTdWZmaXg7CiAgfQogIHJldHVybiBkZWZhdWx0U3VmZml4Owp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICBjb25maWd1cmVFbmRwb2ludDogY29uZmlndXJlRW5kcG9pbnQsCiAgZ2V0RW5kcG9pbnRTdWZmaXg6IGdldEVuZHBvaW50U3VmZml4LAp9OwoKfSx7Ii4vcmVnaW9uX2NvbmZpZ19kYXRhLmpzb24iOjU2LCIuL3V0aWwiOjcyfV0sNTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz17CiAgInJ1bGVzIjogewogICAgIiovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJjbi0qLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbS5jbiIKICAgIH0sCiAgICAidXMtaXNvLSovKiI6ICJ1c0lzbyIsCiAgICAidXMtaXNvYi0qLyoiOiAidXNJc29iIiwKICAgICIqL2J1ZGdldHMiOiAiZ2xvYmFsU1NMIiwKICAgICIqL2Nsb3VkZnJvbnQiOiAiZ2xvYmFsU1NMIiwKICAgICIqL3N0cyI6ICJnbG9iYWxTU0wiLAogICAgIiovaW1wb3J0ZXhwb3J0IjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUKICAgIH0sCgogICAgIiovcm91dGU1MyI6ICJnbG9iYWxTU0wiLAogICAgImNuLSovcm91dGU1MyI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5hbWF6b25hd3MuY29tLmNuIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZSwKICAgICAgInNpZ25pbmdSZWdpb24iOiAiY24tbm9ydGh3ZXN0LTEiCiAgICB9LAogICAgInVzLWdvdi0qL3JvdXRlNTMiOiAiZ2xvYmFsR292Q2xvdWQiLAogICAgInVzLWlzby0qL3JvdXRlNTMiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uYzJzLmljLmdvdiIsCiAgICAgICJnbG9iYWxFbmRwb2ludCI6IHRydWUsCiAgICAgICJzaWduaW5nUmVnaW9uIjogInVzLWlzby1lYXN0LTEiCiAgICB9LAogICAgInVzLWlzb2ItKi9yb3V0ZTUzIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LnNjMnMuc2dvdi5nb3YiLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlLAogICAgICAic2lnbmluZ1JlZ2lvbiI6ICJ1cy1pc29iLWVhc3QtMSIKICAgIH0sCgogICAgIiovd2FmIjogImdsb2JhbFNTTCIsCgogICAgIiovaWFtIjogImdsb2JhbFNTTCIsCiAgICAiY24tKi9pYW0iOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uY24tbm9ydGgtMS5hbWF6b25hd3MuY29tLmNuIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZSwKICAgICAgInNpZ25pbmdSZWdpb24iOiAiY24tbm9ydGgtMSIKICAgIH0sCiAgICAidXMtZ292LSovaWFtIjogImdsb2JhbEdvdkNsb3VkIiwKCiAgICAidXMtZ292LSovc3RzIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgInVzLWdvdi13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgInVzLXdlc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAidXMtd2VzdC0yL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJldS13ZXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgImFwLXNvdXRoZWFzdC0xL3MzIjogInMzc2lnbmF0dXJlIiwKICAgICJhcC1zb3V0aGVhc3QtMi9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAiYXAtbm9ydGhlYXN0LTEvczMiOiAiczNzaWduYXR1cmUiLAogICAgInNhLWVhc3QtMS9zMyI6ICJzM3NpZ25hdHVyZSIsCiAgICAidXMtZWFzdC0xL3MzIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJzMyIKICAgIH0sCiAgICAidXMtZWFzdC0xL3NkYiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5hbWF6b25hd3MuY29tIiwKICAgICAgInNpZ25hdHVyZVZlcnNpb24iOiAidjIiCiAgICB9LAogICAgIiovc2RiIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iLAogICAgICAic2lnbmF0dXJlVmVyc2lvbiI6ICJ2MiIKICAgIH0KICB9LAoKICAiZmlwc1J1bGVzIjogewogICAgIiovKiI6ICJmaXBzU3RhbmRhcmQiLAogICAgInVzLWdvdi0qLyoiOiAiZmlwc1N0YW5kYXJkIiwKICAgICJ1cy1pc28tKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMue3JlZ2lvbn0uYzJzLmljLmdvdiIKICAgIH0sCiAgICAidXMtaXNvLSovZG1zIjogInVzSXNvIiwKICAgICJ1cy1pc29iLSovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS1maXBzLntyZWdpb259LnNjMnMuc2dvdi5nb3YiCiAgICB9LAogICAgInVzLWlzb2ItKi9kbXMiOiAidXNJc29iIiwKICAgICJjbi0qLyoiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy57cmVnaW9ufS5hbWF6b25hd3MuY29tLmNuIgogICAgfSwKICAgICIqL2FwaS5lY3IiOiAiZmlwcy5hcGkuZWNyIiwKICAgICIqL2FwaS5zYWdlbWFrZXIiOiAiZmlwcy5hcGkuc2FnZW1ha2VyIiwKICAgICIqL2JhdGNoIjogImZpcHNEb3RQcmVmaXgiLAogICAgIiovZWtzIjogImZpcHNEb3RQcmVmaXgiLAogICAgIiovbW9kZWxzLmxleCI6ICJmaXBzLm1vZGVscy5sZXgiLAogICAgIiovcnVudGltZS5sZXgiOiAiZmlwcy5ydW50aW1lLmxleCIsCiAgICAiKi9ydW50aW1lLnNhZ2VtYWtlciI6IHsKICAgICAgImVuZHBvaW50IjogInJ1bnRpbWUtZmlwcy5zYWdlbWFrZXIue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiKi9pYW0iOiAiZmlwc1dpdGhvdXRSZWdpb24iLAogICAgIiovcm91dGU1MyI6ICJmaXBzV2l0aG91dFJlZ2lvbiIsCiAgICAiKi90cmFuc2NyaWJlIjogImZpcHNEb3RQcmVmaXgiLAogICAgIiovd2FmIjogImZpcHNXaXRob3V0UmVnaW9uIiwKCiAgICAidXMtZ292LSovdHJhbnNjcmliZSI6ICJmaXBzRG90UHJlZml4IiwKICAgICJ1cy1nb3YtKi9hcGkuZWNyIjogImZpcHMuYXBpLmVjciIsCiAgICAidXMtZ292LSovYXBpLnNhZ2VtYWtlciI6ICJmaXBzLmFwaS5zYWdlbWFrZXIiLAogICAgInVzLWdvdi0qL21vZGVscy5sZXgiOiAiZmlwcy5tb2RlbHMubGV4IiwKICAgICJ1cy1nb3YtKi9ydW50aW1lLmxleCI6ICJmaXBzLnJ1bnRpbWUubGV4IiwKICAgICJ1cy1nb3YtKi9hY20tcGNhIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2JhdGNoIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2NvbmZpZyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9la3MiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovZWxhc3RpY21hcHJlZHVjZSI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9pZGVudGl0eXN0b3JlIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2R5bmFtb2RiIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2VsYXN0aWNsb2FkYmFsYW5jaW5nIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL2d1YXJkZHV0eSI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9tb25pdG9yaW5nIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL3Jlc291cmNlLWdyb3VwcyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9ydW50aW1lLnNhZ2VtYWtlciI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9zZXJ2aWNlY2F0YWxvZy1hcHByZWdpc3RyeSI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9zZXJ2aWNlcXVvdGFzIjogImZpcHNXaXRoU2VydmljZU9ubHkiLAogICAgInVzLWdvdi0qL3NzbSI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3YtKi9zdHMiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LSovc3VwcG9ydCI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1nb3Ytd2VzdC0xL3N0YXRlcyI6ICJmaXBzV2l0aFNlcnZpY2VPbmx5IiwKICAgICJ1cy1pc28tZWFzdC0xL2VsYXN0aWNmaWxlc3lzdGVtIjogewogICAgICAiZW5kcG9pbnQiOiAiZWxhc3RpY2ZpbGVzeXN0ZW0tZmlwcy57cmVnaW9ufS5jMnMuaWMuZ292IgogICAgfSwKICAgICJ1cy1nb3Ytd2VzdC0xL29yZ2FuaXphdGlvbnMiOiAiZmlwc1dpdGhTZXJ2aWNlT25seSIsCiAgICAidXMtZ292LXdlc3QtMS9yb3V0ZTUzIjogewogICAgICAiZW5kcG9pbnQiOiAicm91dGU1My51cy1nb3YuYW1hem9uYXdzLmNvbSIKICAgIH0KICB9LAoKICAiZHVhbHN0YWNrUnVsZXMiOiB7CiAgICAiKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFwaS5hd3MiCiAgICB9LAogICAgImNuLSovKiI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5hcGkuYW1hem9ud2Vic2VydmljZXMuY29tLmNuIgogICAgfSwKCiAgICAiKi9zMyI6ICJkdWFsc3RhY2tMZWdhY3kiLAogICAgImNuLSovczMiOiAiZHVhbHN0YWNrTGVnYWN5Q24iLAogICAgIiovczMtY29udHJvbCI6ICJkdWFsc3RhY2tMZWdhY3kiLAogICAgImNuLSovczMtY29udHJvbCI6ICJkdWFsc3RhY2tMZWdhY3lDbiIsCgogICAgImFwLXNvdXRoLTEvZWMyIjogImR1YWxzdGFja0xlZ2FjeUVjMiIsCiAgICAiZXUtd2VzdC0xL2VjMiI6ICJkdWFsc3RhY2tMZWdhY3lFYzIiLAogICAgInNhLWVhc3QtMS9lYzIiOiAiZHVhbHN0YWNrTGVnYWN5RWMyIiwKICAgICJ1cy1lYXN0LTEvZWMyIjogImR1YWxzdGFja0xlZ2FjeUVjMiIsCiAgICAidXMtZWFzdC0yL2VjMiI6ICJkdWFsc3RhY2tMZWdhY3lFYzIiLAogICAgInVzLXdlc3QtMi9lYzIiOiAiZHVhbHN0YWNrTGVnYWN5RWMyIgogIH0sCgogICJkdWFsc3RhY2tGaXBzUnVsZXMiOiB7CiAgICAiKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMue3JlZ2lvbn0uYXBpLmF3cyIKICAgIH0sCiAgICAiY24tKi8qIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMue3JlZ2lvbn0uYXBpLmFtYXpvbndlYnNlcnZpY2VzLmNvbS5jbiIKICAgIH0sCiAgICAiKi9zMyI6ICJkdWFsc3RhY2tGaXBzTGVnYWN5IiwKICAgICJjbi0qL3MzIjogImR1YWxzdGFja0ZpcHNMZWdhY3lDbiIsCiAgICAiKi9zMy1jb250cm9sIjogImR1YWxzdGFja0ZpcHNMZWdhY3kiLAogICAgImNuLSovczMtY29udHJvbCI6ICJkdWFsc3RhY2tGaXBzTGVnYWN5Q24iCiAgfSwKCiAgInBhdHRlcm5zIjogewogICAgImdsb2JhbFNTTCI6IHsKICAgICAgImVuZHBvaW50IjogImh0dHBzOi8ve3NlcnZpY2V9LmFtYXpvbmF3cy5jb20iLAogICAgICAiZ2xvYmFsRW5kcG9pbnQiOiB0cnVlLAogICAgICAic2lnbmluZ1JlZ2lvbiI6ICJ1cy1lYXN0LTEiCiAgICB9LAogICAgImdsb2JhbEdvdkNsb3VkIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LnVzLWdvdi5hbWF6b25hd3MuY29tIiwKICAgICAgImdsb2JhbEVuZHBvaW50IjogdHJ1ZSwKICAgICAgInNpZ25pbmdSZWdpb24iOiAidXMtZ292LXdlc3QtMSIKICAgIH0sCiAgICAiczNzaWduYXR1cmUiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIsCiAgICAgICJzaWduYXR1cmVWZXJzaW9uIjogInMzIgogICAgfSwKICAgICJ1c0lzbyI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS57cmVnaW9ufS5jMnMuaWMuZ292IgogICAgfSwKICAgICJ1c0lzb2IiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0ue3JlZ2lvbn0uc2Mycy5zZ292LmdvdiIKICAgIH0sCiAgICAiZmlwc1N0YW5kYXJkIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZmlwc0RvdFByZWZpeCI6IHsKICAgICAgImVuZHBvaW50IjogImZpcHMue3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImZpcHNXaXRob3V0UmVnaW9uIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMuYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZmlwcy5hcGkuZWNyIjogewogICAgICAiZW5kcG9pbnQiOiAiZWNyLWZpcHMue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZmlwcy5hcGkuc2FnZW1ha2VyIjogewogICAgICAiZW5kcG9pbnQiOiAiYXBpLWZpcHMuc2FnZW1ha2VyLntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImZpcHMubW9kZWxzLmxleCI6IHsKICAgICAgImVuZHBvaW50IjogIm1vZGVscy1maXBzLmxleC57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJmaXBzLnJ1bnRpbWUubGV4IjogewogICAgICAiZW5kcG9pbnQiOiAicnVudGltZS1maXBzLmxleC57cmVnaW9ufS5hbWF6b25hd3MuY29tIgogICAgfSwKICAgICJmaXBzV2l0aFNlcnZpY2VPbmx5IjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LntyZWdpb259LmFtYXpvbmF3cy5jb20iCiAgICB9LAogICAgImR1YWxzdGFja0xlZ2FjeSI6IHsKICAgICAgImVuZHBvaW50IjogIntzZXJ2aWNlfS5kdWFsc3RhY2sue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZHVhbHN0YWNrTGVnYWN5Q24iOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0uZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICB9LAogICAgImR1YWxzdGFja0ZpcHNMZWdhY3kiOiB7CiAgICAgICJlbmRwb2ludCI6ICJ7c2VydmljZX0tZmlwcy5kdWFsc3RhY2sue3JlZ2lvbn0uYW1hem9uYXdzLmNvbSIKICAgIH0sCiAgICAiZHVhbHN0YWNrRmlwc0xlZ2FjeUNuIjogewogICAgICAiZW5kcG9pbnQiOiAie3NlcnZpY2V9LWZpcHMuZHVhbHN0YWNrLntyZWdpb259LmFtYXpvbmF3cy5jb20uY24iCiAgICB9LAogICAgImR1YWxzdGFja0xlZ2FjeUVjMiI6IHsKICAgICAgImVuZHBvaW50IjogImFwaS5lYzIue3JlZ2lvbn0uYXdzIgogICAgfQogIH0KfQoKfSx7fV0sNTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpeyhmdW5jdGlvbiAoKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwp2YXIgQWNjZXB0b3JTdGF0ZU1hY2hpbmUgPSByZXF1aXJlKCcuL3N0YXRlX21hY2hpbmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0Owp2YXIgZG9tYWluID0gQVdTLnV0aWwuZG9tYWluOwp2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIGhhcmRFcnJvclN0YXRlcyA9IHtzdWNjZXNzOiAxLCBlcnJvcjogMSwgY29tcGxldGU6IDF9OwoKZnVuY3Rpb24gaXNUZXJtaW5hbFN0YXRlKG1hY2hpbmUpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGhhcmRFcnJvclN0YXRlcywgbWFjaGluZS5fYXNtLmN1cnJlbnRTdGF0ZSk7Cn0KCnZhciBmc20gPSBuZXcgQWNjZXB0b3JTdGF0ZU1hY2hpbmUoKTsKZnNtLnNldHVwU3RhdGVzID0gZnVuY3Rpb24oKSB7CiAgdmFyIHRyYW5zaXRpb24gPSBmdW5jdGlvbihfLCBkb25lKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBzZWxmLl9oYWx0SGFuZGxlcnNPbkVycm9yID0gZmFsc2U7CgogICAgc2VsZi5lbWl0KHNlbGYuX2FzbS5jdXJyZW50U3RhdGUsIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyKSB7CiAgICAgICAgaWYgKGlzVGVybWluYWxTdGF0ZShzZWxmKSkgewogICAgICAgICAgaWYgKGRvbWFpbiAmJiBzZWxmLmRvbWFpbiBpbnN0YW5jZW9mIGRvbWFpbi5Eb21haW4pIHsKICAgICAgICAgICAgZXJyLmRvbWFpbkVtaXR0ZXIgPSBzZWxmOwogICAgICAgICAgICBlcnIuZG9tYWluID0gc2VsZi5kb21haW47CiAgICAgICAgICAgIGVyci5kb21haW5UaHJvd24gPSBmYWxzZTsKICAgICAgICAgICAgc2VsZi5kb21haW4uZW1pdCgnZXJyb3InLCBlcnIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZWxmLnJlc3BvbnNlLmVycm9yID0gZXJyOwogICAgICAgICAgZG9uZShlcnIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBkb25lKHNlbGYucmVzcG9uc2UuZXJyb3IpOwogICAgICB9CiAgICB9KTsKCiAgfTsKCiAgdGhpcy5hZGRTdGF0ZSgndmFsaWRhdGUnLCAnYnVpbGQnLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdidWlsZCcsICdhZnRlckJ1aWxkJywgJ3Jlc3RhcnQnLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdhZnRlckJ1aWxkJywgJ3NpZ24nLCAncmVzdGFydCcsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ3NpZ24nLCAnc2VuZCcsICdyZXRyeScsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ3JldHJ5JywgJ2FmdGVyUmV0cnknLCAnYWZ0ZXJSZXRyeScsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ2FmdGVyUmV0cnknLCAnc2lnbicsICdlcnJvcicsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ3NlbmQnLCAndmFsaWRhdGVSZXNwb25zZScsICdyZXRyeScsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ3ZhbGlkYXRlUmVzcG9uc2UnLCAnZXh0cmFjdERhdGEnLCAnZXh0cmFjdEVycm9yJywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnZXh0cmFjdEVycm9yJywgJ2V4dHJhY3REYXRhJywgJ3JldHJ5JywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnZXh0cmFjdERhdGEnLCAnc3VjY2VzcycsICdyZXRyeScsIHRyYW5zaXRpb24pOwogIHRoaXMuYWRkU3RhdGUoJ3Jlc3RhcnQnLCAnYnVpbGQnLCAnZXJyb3InLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdzdWNjZXNzJywgJ2NvbXBsZXRlJywgJ2NvbXBsZXRlJywgdHJhbnNpdGlvbik7CiAgdGhpcy5hZGRTdGF0ZSgnZXJyb3InLCAnY29tcGxldGUnLCAnY29tcGxldGUnLCB0cmFuc2l0aW9uKTsKICB0aGlzLmFkZFN0YXRlKCdjb21wbGV0ZScsIG51bGwsIG51bGwsIHRyYW5zaXRpb24pOwp9Owpmc20uc2V0dXBTdGF0ZXMoKTsKCi8qKgogKiAjIyBBc3luY2hyb25vdXMgUmVxdWVzdHMKICoKICogQWxsIHJlcXVlc3RzIG1hZGUgdGhyb3VnaCB0aGUgU0RLIGFyZSBhc3luY2hyb25vdXMgYW5kIHVzZSBhCiAqIGNhbGxiYWNrIGludGVyZmFjZS4gRWFjaCBzZXJ2aWNlIG1ldGhvZCB0aGF0IGtpY2tzIG9mZiBhIHJlcXVlc3QKICogcmV0dXJucyBhbiBgQVdTLlJlcXVlc3RgIG9iamVjdCB0aGF0IHlvdSBjYW4gdXNlIHRvIHJlZ2lzdGVyCiAqIGNhbGxiYWNrcy4KICoKICogRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgc2VydmljZSBtZXRob2QgcmV0dXJucyB0aGUgcmVxdWVzdAogKiBvYmplY3QgYXMgInJlcXVlc3QiLCB3aGljaCBjYW4gYmUgdXNlZCB0byByZWdpc3RlciBjYWxsYmFja3M6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogLy8gcmVxdWVzdCBpcyBhbiBBV1MuUmVxdWVzdCBvYmplY3QKICogdmFyIHJlcXVlc3QgPSBlYzIuZGVzY3JpYmVJbnN0YW5jZXMoKTsKICoKICogLy8gcmVnaXN0ZXIgY2FsbGJhY2tzIG9uIHJlcXVlc3QgdG8gcmV0cmlldmUgcmVzcG9uc2UgZGF0YQogKiByZXF1ZXN0Lm9uKCdzdWNjZXNzJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICogICBjb25zb2xlLmxvZyhyZXNwb25zZS5kYXRhKTsKICogfSk7CiAqIGBgYAogKgogKiBXaGVuIGEgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LCB0aGUge3NlbmR9IG1ldGhvZCBzaG91bGQKICogYmUgY2FsbGVkOgogKgogKiBgYGBqYXZhc2NyaXB0CiAqIHJlcXVlc3Quc2VuZCgpOwogKiBgYGAKICoKICogU2luY2UgcmVnaXN0ZXJlZCBjYWxsYmFja3MgbWF5IG9yIG1heSBub3QgYmUgaWRlbXBvdGVudCwgcmVxdWVzdHMgc2hvdWxkIG9ubHkKICogYmUgc2VudCBvbmNlLiBUbyBwZXJmb3JtIHRoZSBzYW1lIG9wZXJhdGlvbiBtdWx0aXBsZSB0aW1lcywgeW91IHdpbGwgbmVlZCB0bwogKiBjcmVhdGUgbXVsdGlwbGUgcmVxdWVzdCBvYmplY3RzLCBlYWNoIHdpdGggaXRzIG93biByZWdpc3RlcmVkIGNhbGxiYWNrcy4KICoKICogIyMgUmVtb3ZpbmcgRGVmYXVsdCBMaXN0ZW5lcnMgZm9yIEV2ZW50cwogKgogKiBSZXF1ZXN0IG9iamVjdHMgYXJlIGJ1aWx0IHdpdGggZGVmYXVsdCBsaXN0ZW5lcnMgZm9yIHRoZSB2YXJpb3VzIGV2ZW50cywKICogZGVwZW5kaW5nIG9uIHRoZSBzZXJ2aWNlIHR5cGUuIEluIHNvbWUgY2FzZXMsIHlvdSBtYXkgd2FudCB0byByZW1vdmUKICogc29tZSBidWlsdC1pbiBsaXN0ZW5lcnMgdG8gY3VzdG9taXplIGJlaGF2aW91ci4gRG9pbmcgdGhpcyByZXF1aXJlcwogKiBhY2Nlc3MgdG8gdGhlIGJ1aWx0LWluIGxpc3RlbmVyIGZ1bmN0aW9ucywgd2hpY2ggYXJlIGV4cG9zZWQgdGhyb3VnaAogKiB0aGUge0FXUy5FdmVudExpc3RlbmVycy5Db3JlfSBuYW1lc3BhY2UuIEZvciBpbnN0YW5jZSwgeW91IG1heQogKiB3YW50IHRvIGN1c3RvbWl6ZSB0aGUgSFRUUCBoYW5kbGVyIHVzZWQgd2hlbiBzZW5kaW5nIGEgcmVxdWVzdC4gSW4gdGhpcwogKiBjYXNlLCB5b3UgY2FuIHJlbW92ZSB0aGUgYnVpbHQtaW4gbGlzdGVuZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSAnc2VuZCcKICogZXZlbnQsIHRoZSB7QVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0VORH0gbGlzdGVuZXIgYW5kIGFkZCB5b3VyIG93bi4KICoKICogIyMgTXVsdGlwbGUgQ2FsbGJhY2tzIGFuZCBDaGFpbmluZwogKgogKiBZb3UgY2FuIHJlZ2lzdGVyIG11bHRpcGxlIGNhbGxiYWNrcyBvbiBhbnkgcmVxdWVzdCBvYmplY3QuIFRoZQogKiBjYWxsYmFja3MgY2FuIGJlIHJlZ2lzdGVyZWQgZm9yIGRpZmZlcmVudCBldmVudHMsIG9yIGFsbCBmb3IgdGhlCiAqIHNhbWUgZXZlbnQuIEluIGFkZGl0aW9uLCB5b3UgY2FuIGNoYWluIGNhbGxiYWNrIHJlZ2lzdHJhdGlvbiwgZm9yCiAqIGV4YW1wbGU6CiAqCiAqIGBgYGphdmFzY3JpcHQKICogcmVxdWVzdC4KICogICBvbignc3VjY2VzcycsIGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAqICAgICBjb25zb2xlLmxvZygiU3VjY2VzcyEiKTsKICogICB9KS4KICogICBvbignZXJyb3InLCBmdW5jdGlvbihlcnJvciwgcmVzcG9uc2UpIHsKICogICAgIGNvbnNvbGUubG9nKCJFcnJvciEiKTsKICogICB9KS4KICogICBvbignY29tcGxldGUnLCBmdW5jdGlvbihyZXNwb25zZSkgewogKiAgICAgY29uc29sZS5sb2coIkFsd2F5cyEiKTsKICogICB9KS4KICogICBzZW5kKCk7CiAqIGBgYAogKgogKiBUaGUgYWJvdmUgZXhhbXBsZSB3aWxsIHByaW50IGVpdGhlciAiU3VjY2VzcyEgQWx3YXlzISIsIG9yICJFcnJvciEgQWx3YXlzISIsCiAqIGRlcGVuZGluZyBvbiB3aGV0aGVyIHRoZSByZXF1ZXN0IHN1Y2NlZWRlZCBvciBub3QuCiAqCiAqIEAhYXR0cmlidXRlIGh0dHBSZXF1ZXN0CiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBIVFRQIFByb3BlcnRpZXMKICogICBAcmV0dXJuIFtBV1MuSHR0cFJlcXVlc3RdIHRoZSByYXcgSFRUUCByZXF1ZXN0IG9iamVjdAogKiAgICAgY29udGFpbmluZyByZXF1ZXN0IGhlYWRlcnMgYW5kIGJvZHkgaW5mb3JtYXRpb24KICogICAgIHNlbnQgYnkgdGhlIHNlcnZpY2UuCiAqCiAqIEAhYXR0cmlidXRlIHN0YXJ0VGltZQogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICogICBAcmV0dXJuIFtEYXRlXSB0aGUgdGltZSB0aGF0IHRoZSByZXF1ZXN0IHN0YXJ0ZWQKICoKICogQCFncm91cCBSZXF1ZXN0IEJ1aWxkaW5nIEV2ZW50cwogKgogKiBAIWV2ZW50IHZhbGlkYXRlKHJlcXVlc3QpCiAqICAgVHJpZ2dlcmVkIHdoZW4gYSByZXF1ZXN0IGlzIGJlaW5nIHZhbGlkYXRlZC4gTGlzdGVuZXJzCiAqICAgc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIHRoZSByZXF1ZXN0IHNob3VsZCBub3QgYmUgc2VudC4KICogICBAcGFyYW0gcmVxdWVzdCBbUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGJlaW5nIHNlbnQKICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX0NSRURFTlRJQUxTCiAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9SRUdJT04KICogICBAZXhhbXBsZSBFbnN1cmluZyB0aGF0IGEgY2VydGFpbiBwYXJhbWV0ZXIgaXMgc2V0IGJlZm9yZSBzZW5kaW5nIGEgcmVxdWVzdAogKiAgICAgdmFyIHJlcSA9IHMzLnB1dE9iamVjdChwYXJhbXMpOwogKiAgICAgcmVxLm9uKCd2YWxpZGF0ZScsIGZ1bmN0aW9uKCkgewogKiAgICAgICBpZiAoIXJlcS5wYXJhbXMuQm9keS5tYXRjaCgvXkhlbGxvXHMvKSkgewogKiAgICAgICAgIHRocm93IG5ldyBFcnJvcignQm9keSBtdXN0IHN0YXJ0IHdpdGggIkhlbGxvICInKTsKICogICAgICAgfQogKiAgICAgfSk7CiAqICAgICByZXEuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsgLi4uIH0pOwogKgogKiBAIWV2ZW50IGJ1aWxkKHJlcXVlc3QpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHJlcXVlc3QgcGF5bG9hZCBpcyBiZWluZyBidWlsdC4gTGlzdGVuZXJzCiAqICAgc2hvdWxkIGZpbGwgdGhlIG5lY2Vzc2FyeSBpbmZvcm1hdGlvbiB0byBzZW5kIHRoZSByZXF1ZXN0CiAqICAgb3ZlciBIVFRQLgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnZhbGlkYXRlKQogKiAgIEBleGFtcGxlIEFkZCBhIGN1c3RvbSBIVFRQIGhlYWRlciB0byBhIHJlcXVlc3QKICogICAgIHZhciByZXEgPSBzMy5wdXRPYmplY3QocGFyYW1zKTsKICogICAgIHJlcS5vbignYnVpbGQnLCBmdW5jdGlvbigpIHsKICogICAgICAgcmVxLmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0N1c3RvbS1IZWFkZXInXSA9ICd2YWx1ZSc7CiAqICAgICB9KTsKICogICAgIHJlcS5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyAuLi4gfSk7CiAqCiAqIEAhZXZlbnQgc2lnbihyZXF1ZXN0KQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSByZXF1ZXN0IGlzIGJlaW5nIHNpZ25lZC4gTGlzdGVuZXJzIHNob3VsZAogKiAgIGFkZCB0aGUgY29ycmVjdCBhdXRoZW50aWNhdGlvbiBoZWFkZXJzIGFuZC9vciBhZGp1c3QgdGhlIGJvZHksCiAqICAgZGVwZW5kaW5nIG9uIHRoZSBhdXRoZW50aWNhdGlvbiBtZWNoYW5pc20gYmVpbmcgdXNlZC4KICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH52YWxpZGF0ZSkKICoKICogQCFncm91cCBSZXF1ZXN0IFNlbmRpbmcgRXZlbnRzCiAqCiAqIEAhZXZlbnQgc2VuZChyZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBpcyByZWFkeSB0byBiZSBzZW50LiBMaXN0ZW5lcnMKICogICBzaG91bGQgY2FsbCB0aGUgdW5kZXJseWluZyB0cmFuc3BvcnQgbGF5ZXIgdG8gaW5pdGlhdGUKICogICB0aGUgc2VuZGluZyBvZiB0aGUgcmVxdWVzdC4KICogICBAcGFyYW0gcmVzcG9uc2UgW1Jlc3BvbnNlXSB0aGUgcmVzcG9uc2Ugb2JqZWN0CiAqICAgQGNvbnRleHQgW1JlcXVlc3RdIHRoZSByZXF1ZXN0IG9iamVjdCB0aGF0IHdhcyBzZW50CiAqICAgQHNlZSBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5TRU5ECiAqCiAqIEAhZXZlbnQgcmV0cnkocmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gYSByZXF1ZXN0IGZhaWxlZCBhbmQgbWlnaHQgbmVlZCB0byBiZSByZXRyaWVkIG9yIHJlZGlyZWN0ZWQuCiAqICAgSWYgdGhlIHJlc3BvbnNlIGlzIHJldHJ5YWJsZSwgdGhlIGxpc3RlbmVyIHNob3VsZCBzZXQgdGhlCiAqICAgYHJlc3BvbnNlLmVycm9yLnJldHJ5YWJsZWAgcHJvcGVydHkgdG8gYHRydWVgLCBhbmQgb3B0aW9uYWxseSBzZXQKICogICBgcmVzcG9uc2UuZXJyb3IucmV0cnlEZWxheWAgdG8gdGhlIG1pbGxpc2Vjb25kIGRlbGF5IGZvciB0aGUgbmV4dCBhdHRlbXB0LgogKiAgIEluIHRoZSBjYXNlIG9mIGEgcmVkaXJlY3QsIGByZXNwb25zZS5lcnJvci5yZWRpcmVjdGAgc2hvdWxkIGJlIHNldCB0bwogKiAgIGB0cnVlYCB3aXRoIGByZXRyeURlbGF5YCBzZXQgdG8gYW4gb3B0aW9uYWwgZGVsYXkgb24gdGhlIG5leHQgcmVxdWVzdC4KICoKICogICBJZiBhIGxpc3RlbmVyIGRlY2lkZXMgdGhhdCBhIHJlcXVlc3Qgc2hvdWxkIG5vdCBiZSByZXRyaWVkLAogKiAgIGl0IHNob3VsZCBzZXQgYm90aCBgcmV0cnlhYmxlYCBhbmQgYHJlZGlyZWN0YCB0byBmYWxzZS4KICoKICogICBOb3RlIHRoYXQgYSByZXRyeWFibGUgZXJyb3Igd2lsbCBiZSByZXRyaWVkIGF0IG1vc3QKICogICB7QVdTLkNvbmZpZy5tYXhSZXRyaWVzfSB0aW1lcyAoYmFzZWQgb24gdGhlIHNlcnZpY2Ugb2JqZWN0J3MgY29uZmlnKS4KICogICBTaW1pbGFybHksIGEgcmVxdWVzdCB0aGF0IGlzIHJlZGlyZWN0ZWQgd2lsbCBvbmx5IHJlZGlyZWN0IGF0IG1vc3QKICogICB7QVdTLkNvbmZpZy5tYXhSZWRpcmVjdHN9IHRpbWVzLgogKgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBleGFtcGxlIEFkZGluZyBhIGN1c3RvbSByZXRyeSBmb3IgYSA0MDQgcmVzcG9uc2UKICogICAgIHJlcXVlc3Qub24oJ3JldHJ5JywgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICogICAgICAgLy8gdGhpcyByZXNvdXJjZSBpcyBub3QgeWV0IGF2YWlsYWJsZSwgd2FpdCAxMCBzZWNvbmRzIHRvIGdldCBpdCBhZ2FpbgogKiAgICAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDQwNCAmJiByZXNwb25zZS5lcnJvcikgewogKiAgICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5YWJsZSA9IHRydWU7ICAgLy8gcmV0cnkgdGhpcyBlcnJvcgogKiAgICAgICAgIHJlc3BvbnNlLmVycm9yLnJldHJ5RGVsYXkgPSAxMDAwMDsgLy8gd2FpdCAxMCBzZWNvbmRzCiAqICAgICAgIH0KICogICAgIH0pOwogKgogKiBAIWdyb3VwIERhdGEgUGFyc2luZyBFdmVudHMKICoKICogQCFldmVudCBleHRyYWN0RXJyb3IocmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIG9uIGFsbCBub24tMnh4IHJlcXVlc3RzIHNvIHRoYXQgbGlzdGVuZXJzIGNhbiBleHRyYWN0CiAqICAgZXJyb3IgZGV0YWlscyBmcm9tIHRoZSByZXNwb25zZSBib2R5LiBMaXN0ZW5lcnMgdG8gdGhpcyBldmVudAogKiAgIHNob3VsZCBzZXQgdGhlIGByZXNwb25zZS5lcnJvcmAgcHJvcGVydHkuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEAhZXZlbnQgZXh0cmFjdERhdGEocmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIGluIHN1Y2Nlc3NmdWwgcmVxdWVzdHMgdG8gYWxsb3cgbGlzdGVuZXJzIHRvCiAqICAgZGUtc2VyaWFsaXplIHRoZSByZXNwb25zZSBib2R5IGludG8gYHJlc3BvbnNlLmRhdGFgLgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAIWdyb3VwIENvbXBsZXRpb24gRXZlbnRzCiAqCiAqIEAhZXZlbnQgc3VjY2VzcyhyZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgcmVxdWVzdCBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5LgogKiAgIGByZXNwb25zZS5kYXRhYCB3aWxsIGNvbnRhaW4gdGhlIHJlc3BvbnNlIGRhdGEgYW5kCiAqICAgYHJlc3BvbnNlLmVycm9yYCB3aWxsIGJlIG51bGwuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEAhZXZlbnQgZXJyb3IoZXJyb3IsIHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIGFuIGVycm9yIG9jY3VycyBhdCBhbnkgcG9pbnQgZHVyaW5nIHRoZQogKiAgIHJlcXVlc3QuIGByZXNwb25zZS5lcnJvcmAgd2lsbCBjb250YWluIGRldGFpbHMgYWJvdXQgdGhlIGVycm9yCiAqICAgdGhhdCBvY2N1cnJlZC4gYHJlc3BvbnNlLmRhdGFgIHdpbGwgYmUgbnVsbC4KICogICBAcGFyYW0gZXJyb3IgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dAogKiAgICAgdGhlIGVycm9yIHRoYXQgb2NjdXJyZWQuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEAhZXZlbnQgY29tcGxldGUocmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW5ldmVyIGEgcmVxdWVzdCBjeWNsZSBjb21wbGV0ZXMuIGByZXNwb25zZS5lcnJvcmAKICogICBzaG91bGQgYmUgY2hlY2tlZCwgc2luY2UgdGhlIHJlcXVlc3QgbWF5IGhhdmUgZmFpbGVkLgogKiAgIEBwYXJhbSAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQGNvbnRleHQgKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKgogKiBAIWdyb3VwIEhUVFAgRXZlbnRzCiAqCiAqIEAhZXZlbnQgaHR0cEhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcG9uc2UsIHN0YXR1c01lc3NhZ2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gaGVhZGVycyBhcmUgc2VudCBieSB0aGUgcmVtb3RlIHNlcnZlcgogKiAgIEBwYXJhbSBzdGF0dXNDb2RlIFtJbnRlZ2VyXSB0aGUgSFRUUCByZXNwb25zZSBjb2RlCiAqICAgQHBhcmFtIGhlYWRlcnMgW21hcDxTdHJpbmcsU3RyaW5nPl0gdGhlIHJlc3BvbnNlIGhlYWRlcnMKICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBwYXJhbSBzdGF0dXNNZXNzYWdlIFtTdHJpbmddIEEgc3RhdHVzIG1lc3NhZ2UgY29ycmVzcG9uZGluZyB0byB0aGUgSFRUUAogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlIGNvZGUKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEAhZXZlbnQgaHR0cERhdGEoY2h1bmssIHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIGRhdGEgaXMgc2VudCBieSB0aGUgcmVtb3RlIHNlcnZlcgogKiAgIEBwYXJhbSBjaHVuayBbQnVmZmVyXSB0aGUgYnVmZmVyIGRhdGEgY29udGFpbmluZyB0aGUgbmV4dCBkYXRhIGNodW5rCiAqICAgICBmcm9tIHRoZSBzZXJ2ZXIKICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAc2VlIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLkhUVFBfREFUQQogKgogKiBAIWV2ZW50IGh0dHBVcGxvYWRQcm9ncmVzcyhwcm9ncmVzcywgcmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIEhUVFAgcmVxdWVzdCBoYXMgdXBsb2FkZWQgbW9yZSBkYXRhCiAqICAgQHBhcmFtIHByb2dyZXNzIFttYXBdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgbG9hZGVkYCBhbmQgYHRvdGFsYCBieXRlcwogKiAgICAgb2YgdGhlIHJlcXVlc3QuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQG5vdGUgVGhpcyBldmVudCB3aWxsIG5vdCBiZSBlbWl0dGVkIGluIE5vZGUuanMgMC44LnguCiAqCiAqIEAhZXZlbnQgaHR0cERvd25sb2FkUHJvZ3Jlc3MocHJvZ3Jlc3MsIHJlc3BvbnNlKQogKiAgIFRyaWdnZXJlZCB3aGVuIHRoZSBIVFRQIHJlcXVlc3QgaGFzIGRvd25sb2FkZWQgbW9yZSBkYXRhCiAqICAgQHBhcmFtIHByb2dyZXNzIFttYXBdIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBgbG9hZGVkYCBhbmQgYHRvdGFsYCBieXRlcwogKiAgICAgb2YgdGhlIHJlcXVlc3QuCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqICAgQG5vdGUgVGhpcyBldmVudCB3aWxsIG5vdCBiZSBlbWl0dGVkIGluIE5vZGUuanMgMC44LnguCiAqCiAqIEAhZXZlbnQgaHR0cEVycm9yKGVycm9yLCByZXNwb25zZSkKICogICBUcmlnZ2VyZWQgd2hlbiB0aGUgSFRUUCByZXF1ZXN0IGZhaWxlZAogKiAgIEBwYXJhbSBlcnJvciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgdGhhdCB3YXMgdGhyb3duCiAqICAgQHBhcmFtIChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICogICBAY29udGV4dCAoc2VlIEFXUy5SZXF1ZXN0fnNlbmQpCiAqCiAqIEAhZXZlbnQgaHR0cERvbmUocmVzcG9uc2UpCiAqICAgVHJpZ2dlcmVkIHdoZW4gdGhlIHNlcnZlciBpcyBmaW5pc2hlZCBzZW5kaW5nIGRhdGEKICogICBAcGFyYW0gKHNlZSBBV1MuUmVxdWVzdH5zZW5kKQogKiAgIEBjb250ZXh0IChzZWUgQVdTLlJlcXVlc3R+c2VuZCkKICoKICogQHNlZSBBV1MuUmVzcG9uc2UKICovCkFXUy5SZXF1ZXN0ID0gaW5oZXJpdCh7CgogIC8qKgogICAqIENyZWF0ZXMgYSByZXF1ZXN0IGZvciBhbiBvcGVyYXRpb24gb24gYSBnaXZlbiBzZXJ2aWNlIHdpdGgKICAgKiBhIHNldCBvZiBpbnB1dCBwYXJhbWV0ZXJzLgogICAqCiAgICogQHBhcmFtIHNlcnZpY2UgW0FXUy5TZXJ2aWNlXSB0aGUgc2VydmljZSB0byBwZXJmb3JtIHRoZSBvcGVyYXRpb24gb24KICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBvcGVyYXRpb24gdG8gcGVyZm9ybSBvbiB0aGUgc2VydmljZQogICAqIEBwYXJhbSBwYXJhbXMgW09iamVjdF0gcGFyYW1ldGVycyB0byBzZW5kIHRvIHRoZSBvcGVyYXRpb24uCiAgICogICBTZWUgdGhlIG9wZXJhdGlvbidzIGRvY3VtZW50YXRpb24gZm9yIHRoZSBmb3JtYXQgb2YgdGhlCiAgICogICBwYXJhbWV0ZXJzLgogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXF1ZXN0KHNlcnZpY2UsIG9wZXJhdGlvbiwgcGFyYW1zKSB7CiAgICB2YXIgZW5kcG9pbnQgPSBzZXJ2aWNlLmVuZHBvaW50OwogICAgdmFyIHJlZ2lvbiA9IHNlcnZpY2UuY29uZmlnLnJlZ2lvbjsKICAgIHZhciBjdXN0b21Vc2VyQWdlbnQgPSBzZXJ2aWNlLmNvbmZpZy5jdXN0b21Vc2VyQWdlbnQ7CgogICAgaWYgKHNlcnZpY2Uuc2lnbmluZ1JlZ2lvbikgewogICAgICByZWdpb24gPSBzZXJ2aWNlLnNpZ25pbmdSZWdpb247CiAgICB9IGVsc2UgaWYgKHNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludCkgewogICAgICByZWdpb24gPSAndXMtZWFzdC0xJzsKICAgIH0KCiAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiAmJiBkb21haW4uYWN0aXZlOwogICAgdGhpcy5zZXJ2aWNlID0gc2VydmljZTsKICAgIHRoaXMub3BlcmF0aW9uID0gb3BlcmF0aW9uOwogICAgdGhpcy5wYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICB0aGlzLmh0dHBSZXF1ZXN0ID0gbmV3IEFXUy5IdHRwUmVxdWVzdChlbmRwb2ludCwgcmVnaW9uKTsKICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoY3VzdG9tVXNlckFnZW50KTsKICAgIHRoaXMuc3RhcnRUaW1lID0gc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpOwoKICAgIHRoaXMucmVzcG9uc2UgPSBuZXcgQVdTLlJlc3BvbnNlKHRoaXMpOwogICAgdGhpcy5fYXNtID0gbmV3IEFjY2VwdG9yU3RhdGVNYWNoaW5lKGZzbS5zdGF0ZXMsICd2YWxpZGF0ZScpOwogICAgdGhpcy5faGFsdEhhbmRsZXJzT25FcnJvciA9IGZhbHNlOwoKICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzKTsKICAgIHRoaXMuZW1pdCA9IHRoaXMuZW1pdEV2ZW50OwogIH0sCgogIC8qKgogICAqIEAhZ3JvdXAgU2VuZGluZyBhIFJlcXVlc3QKICAgKi8KCiAgLyoqCiAgICogQG92ZXJsb2FkIHNlbmQoY2FsbGJhY2sgPSBudWxsKQogICAqICAgU2VuZHMgdGhlIHJlcXVlc3Qgb2JqZWN0LgogICAqCiAgICogICBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAqICAgICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICogICAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICogICAgIEBjb250ZXh0IFtBV1MuUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGJlaW5nIHNlbnQuCiAgICogICAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICogICAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAqICAgICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgKiAgICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAqICAgQGV4YW1wbGUgU2VuZGluZyBhIHJlcXVlc3Qgd2l0aCBhIGNhbGxiYWNrCiAgICogICAgIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgKiAgICAgcmVxdWVzdC5zZW5kKGZ1bmN0aW9uKGVyciwgZGF0YSkgeyBjb25zb2xlLmxvZyhlcnIsIGRhdGEpOyB9KTsKICAgKiAgIEBleGFtcGxlIFNlbmRpbmcgYSByZXF1ZXN0IHdpdGggbm8gY2FsbGJhY2sgKHVzaW5nIGV2ZW50IGhhbmRsZXJzKQogICAqICAgICByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHtCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknfSk7CiAgICogICAgIHJlcXVlc3Qub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcG9uc2UpIHsgLi4uIH0pOyAvLyByZWdpc3RlciBhIGNhbGxiYWNrCiAgICogICAgIHJlcXVlc3Quc2VuZCgpOwogICAqLwogIHNlbmQ6IGZ1bmN0aW9uIHNlbmQoY2FsbGJhY2spIHsKICAgIGlmIChjYWxsYmFjaykgewogICAgICAvLyBhcHBlbmQgdG8gdXNlciBhZ2VudAogICAgICB0aGlzLmh0dHBSZXF1ZXN0LmFwcGVuZFRvVXNlckFnZW50KCdjYWxsYmFjaycpOwogICAgICB0aGlzLm9uKCdjb21wbGV0ZScsIGZ1bmN0aW9uIChyZXNwKSB7CiAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwLCByZXNwLmVycm9yLCByZXNwLmRhdGEpOwogICAgICB9KTsKICAgIH0KICAgIHRoaXMucnVuVG8oKTsKCiAgICByZXR1cm4gdGhpcy5yZXNwb25zZTsKICB9LAoKICAvKioKICAgKiBAIW1ldGhvZCAgcHJvbWlzZSgpCiAgICogICBTZW5kcyB0aGUgcmVxdWVzdCBhbmQgcmV0dXJucyBhICd0aGVuYWJsZScgcHJvbWlzZS4KICAgKgogICAqICAgVHdvIGNhbGxiYWNrcyBjYW4gYmUgcHJvdmlkZWQgdG8gdGhlIGB0aGVuYCBtZXRob2Qgb24gdGhlIHJldHVybmVkIHByb21pc2UuCiAgICogICBUaGUgZmlyc3QgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgZnVsZmlsbGVkLCBhbmQgdGhlIHNlY29uZAogICAqICAgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaWYgdGhlIHByb21pc2UgaXMgcmVqZWN0ZWQuCiAgICogICBAY2FsbGJhY2sgZnVsZmlsbGVkQ2FsbGJhY2sgZnVuY3Rpb24oZGF0YSkKICAgKiAgICAgQ2FsbGVkIGlmIHRoZSBwcm9taXNlIGlzIGZ1bGZpbGxlZC4KICAgKiAgICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqICAgQGNhbGxiYWNrIHJlamVjdGVkQ2FsbGJhY2sgZnVuY3Rpb24oZXJyb3IpCiAgICogICAgIENhbGxlZCBpZiB0aGUgcHJvbWlzZSBpcyByZWplY3RlZC4KICAgKiAgICAgQHBhcmFtIGVycm9yIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqICAgQHJldHVybiBbUHJvbWlzZV0gQSBwcm9taXNlIHRoYXQgcmVwcmVzZW50cyB0aGUgc3RhdGUgb2YgdGhlIHJlcXVlc3QuCiAgICogICBAZXhhbXBsZSBTZW5kaW5nIGEgcmVxdWVzdCB1c2luZyBwcm9taXNlcy4KICAgKiAgICAgdmFyIHJlcXVlc3QgPSBzMy5wdXRPYmplY3Qoe0J1Y2tldDogJ2J1Y2tldCcsIEtleTogJ2tleSd9KTsKICAgKiAgICAgdmFyIHJlc3VsdCA9IHJlcXVlc3QucHJvbWlzZSgpOwogICAqICAgICByZXN1bHQudGhlbihmdW5jdGlvbihkYXRhKSB7IC4uLiB9LCBmdW5jdGlvbihlcnJvcikgeyAuLi4gfSk7CiAgICovCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGJ1aWxkOiBmdW5jdGlvbiBidWlsZChjYWxsYmFjaykgewogICAgcmV0dXJuIHRoaXMucnVuVG8oJ3NlbmQnLCBjYWxsYmFjayk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgcnVuVG86IGZ1bmN0aW9uIHJ1blRvKHN0YXRlLCBkb25lKSB7CiAgICB0aGlzLl9hc20ucnVuVG8oc3RhdGUsIGRvbmUsIHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQWJvcnRzIGEgcmVxdWVzdCwgZW1pdHRpbmcgdGhlIGVycm9yIGFuZCBjb21wbGV0ZSBldmVudHMuCiAgICoKICAgKiBAIW1hY3JvIG5vYnJvd3NlcgogICAqIEBleGFtcGxlIEFib3J0aW5nIGEgcmVxdWVzdCBhZnRlciBzZW5kaW5nCiAgICogICB2YXIgcGFyYW1zID0gewogICAqICAgICBCdWNrZXQ6ICdidWNrZXQnLCBLZXk6ICdrZXknLAogICAqICAgICBCb2R5OiBCdWZmZXIuYWxsb2MoMTAyNCAqIDEwMjQgKiA1KSAvLyA1TUIgcGF5bG9hZAogICAqICAgfTsKICAgKiAgIHZhciByZXF1ZXN0ID0gczMucHV0T2JqZWN0KHBhcmFtcyk7CiAgICogICByZXF1ZXN0LnNlbmQoZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAqICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZygiRXJyb3I6IiwgZXJyLmNvZGUsIGVyci5tZXNzYWdlKTsKICAgKiAgICAgZWxzZSBjb25zb2xlLmxvZyhkYXRhKTsKICAgKiAgIH0pOwogICAqCiAgICogICAvLyBhYm9ydCByZXF1ZXN0IGluIDEgc2Vjb25kCiAgICogICBzZXRUaW1lb3V0KHJlcXVlc3QuYWJvcnQuYmluZChyZXF1ZXN0KSwgMTAwMCk7CiAgICoKICAgKiAgIC8vIHByaW50cyAiRXJyb3I6IFJlcXVlc3RBYm9ydGVkRXJyb3IgUmVxdWVzdCBhYm9ydGVkIGJ5IHVzZXIiCiAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdIHRoZSBzYW1lIHJlcXVlc3Qgb2JqZWN0LCBmb3IgY2hhaW5pbmcuCiAgICogQHNpbmNlIHYxLjQuMAogICAqLwogIGFib3J0OiBmdW5jdGlvbiBhYm9ydCgpIHsKICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCd2YWxpZGF0ZVJlc3BvbnNlJyk7CiAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnZXh0cmFjdEVycm9yJyk7CiAgICB0aGlzLm9uKCd2YWxpZGF0ZVJlc3BvbnNlJywgZnVuY3Rpb24gYWRkQWJvcnRlZEVycm9yKHJlc3ApIHsKICAgICAgcmVzcC5lcnJvciA9IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcignUmVxdWVzdCBhYm9ydGVkIGJ5IHVzZXInKSwgewogICAgICAgICBjb2RlOiAnUmVxdWVzdEFib3J0ZWRFcnJvcicsIHJldHJ5YWJsZTogZmFsc2UKICAgICAgfSk7CiAgICB9KTsKCiAgICBpZiAodGhpcy5odHRwUmVxdWVzdC5zdHJlYW0gJiYgIXRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtLmRpZENhbGxiYWNrKSB7IC8vIGFib3J0IEhUVFAgc3RyZWFtCiAgICAgIHRoaXMuaHR0cFJlcXVlc3Quc3RyZWFtLmFib3J0KCk7CiAgICAgIGlmICh0aGlzLmh0dHBSZXF1ZXN0Ll9hYm9ydENhbGxiYWNrKSB7CiAgICAgICAgIHRoaXMuaHR0cFJlcXVlc3QuX2Fib3J0Q2FsbGJhY2soKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygnc2VuZCcpOyAvLyBoYXZlbid0IHNlbnQgeWV0LCBzbyBsZXQncyBub3QKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8qKgogICAqIEl0ZXJhdGVzIG92ZXIgZWFjaCBwYWdlIG9mIHJlc3VsdHMgZ2l2ZW4gYSBwYWdlYWJsZSByZXF1ZXN0LCBjYWxsaW5nCiAgICogdGhlIHByb3ZpZGVkIGNhbGxiYWNrIHdpdGggZWFjaCBwYWdlIG9mIGRhdGEuIEFmdGVyIGFsbCBwYWdlcyBoYXZlIGJlZW4KICAgKiByZXRyaWV2ZWQsIHRoZSBjYWxsYmFjayBpcyBjYWxsZWQgd2l0aCBgbnVsbGAgZGF0YS4KICAgKgogICAqIEBub3RlIFRoaXMgb3BlcmF0aW9uIGNhbiBnZW5lcmF0ZSBtdWx0aXBsZSByZXF1ZXN0cyB0byBhIHNlcnZpY2UuCiAgICogQGV4YW1wbGUgSXRlcmF0aW5nIG92ZXIgbXVsdGlwbGUgcGFnZXMgb2Ygb2JqZWN0cyBpbiBhbiBTMyBidWNrZXQKICAgKiAgIHZhciBwYWdlcyA9IDE7CiAgICogICBzMy5saXN0T2JqZWN0cygpLmVhY2hQYWdlKGZ1bmN0aW9uKGVyciwgZGF0YSkgewogICAqICAgICBpZiAoZXJyKSByZXR1cm47CiAgICogICAgIGNvbnNvbGUubG9nKCJQYWdlIiwgcGFnZXMrKyk7CiAgICogICAgIGNvbnNvbGUubG9nKGRhdGEpOwogICAqICAgfSk7CiAgICogQGV4YW1wbGUgSXRlcmF0aW5nIG92ZXIgbXVsdGlwbGUgcGFnZXMgd2l0aCBhbiBhc3luY2hyb25vdXMgY2FsbGJhY2sKICAgKiAgIHMzLmxpc3RPYmplY3RzKHBhcmFtcykuZWFjaFBhZ2UoZnVuY3Rpb24oZXJyLCBkYXRhLCBkb25lKSB7CiAgICogICAgIGRvU29tZXRoaW5nQXN5bmNBbmRPckV4cGVuc2l2ZShmdW5jdGlvbigpIHsKICAgKiAgICAgICAvLyBUaGUgbmV4dCBwYWdlIG9mIHJlc3VsdHMgaXNuJ3QgZmV0Y2hlZCB1bnRpbCBkb25lIGlzIGNhbGxlZAogICAqICAgICAgIGRvbmUoKTsKICAgKiAgICAgfSk7CiAgICogICB9KTsKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhLCBbZG9uZUNhbGxiYWNrXSkKICAgKiAgIENhbGxlZCB3aXRoIGVhY2ggcGFnZSBvZiByZXN1bHRpbmcgZGF0YSBmcm9tIHRoZSByZXF1ZXN0LiBJZiB0aGUKICAgKiAgIG9wdGlvbmFsIGBkb25lQ2FsbGJhY2tgIGlzIHByb3ZpZGVkIGluIHRoZSBmdW5jdGlvbiwgaXQgbXVzdCBiZSBjYWxsZWQKICAgKiAgIHdoZW4gdGhlIGNhbGxiYWNrIGlzIGNvbXBsZXRlLgogICAqCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gYW4gZXJyb3Igb2JqZWN0LCBpZiBhbiBlcnJvciBvY2N1cnJlZC4KICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIGEgc2luZ2xlIHBhZ2Ugb2YgcmVzcG9uc2UgZGF0YS4gSWYgdGhlcmUgaXMgbm8KICAgKiAgICAgbW9yZSBkYXRhLCB0aGlzIG9iamVjdCB3aWxsIGJlIGBudWxsYC4KICAgKiAgIEBwYXJhbSBkb25lQ2FsbGJhY2sgW0Z1bmN0aW9uXSBhbiBvcHRpb25hbCBkb25lIGNhbGxiYWNrLiBJZiB0aGlzCiAgICogICAgIGFyZ3VtZW50IGlzIGRlZmluZWQgaW4gdGhlIGZ1bmN0aW9uIGRlY2xhcmF0aW9uLCBpdCBzaG91bGQgYmUgY2FsbGVkCiAgICogICAgIHdoZW4gdGhlIG5leHQgcGFnZSBpcyByZWFkeSB0byBiZSByZXRyaWV2ZWQuIFRoaXMgaXMgdXNlZnVsIGZvcgogICAqICAgICBjb250cm9sbGluZyBzZXJpYWwgcGFnaW5hdGlvbiBhY3Jvc3MgYXN5bmNocm9ub3VzIG9wZXJhdGlvbnMuCiAgICogICBAcmV0dXJuIFtCb29sZWFuXSBpZiB0aGUgY2FsbGJhY2sgcmV0dXJucyBgZmFsc2VgLCBwYWdpbmF0aW9uIHdpbGwKICAgKiAgICAgc3RvcC4KICAgKgogICAqIEBzZWUgQVdTLlJlcXVlc3QuZWFjaEl0ZW0KICAgKiBAc2VlIEFXUy5SZXNwb25zZS5uZXh0UGFnZQogICAqIEBzaW5jZSB2MS40LjAKICAgKi8KICBlYWNoUGFnZTogZnVuY3Rpb24gZWFjaFBhZ2UoY2FsbGJhY2spIHsKICAgIC8vIE1ha2UgYWxsIGNhbGxiYWNrcyBhc3luYy1pc2gKICAgIGNhbGxiYWNrID0gQVdTLnV0aWwuZm4ubWFrZUFzeW5jKGNhbGxiYWNrLCAzKTsKCiAgICBmdW5jdGlvbiB3cmFwcGVkQ2FsbGJhY2socmVzcG9uc2UpIHsKICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgcmVzcG9uc2UuZXJyb3IsIHJlc3BvbnNlLmRhdGEsIGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICBpZiAocmVzcG9uc2UuaGFzTmV4dFBhZ2UoKSkgewogICAgICAgICAgcmVzcG9uc2UubmV4dFBhZ2UoKS5vbignY29tcGxldGUnLCB3cmFwcGVkQ2FsbGJhY2spLnNlbmQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FsbGJhY2suY2FsbChyZXNwb25zZSwgbnVsbCwgbnVsbCwgQVdTLnV0aWwuZm4ubm9vcCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICB0aGlzLm9uKCdjb21wbGV0ZScsIHdyYXBwZWRDYWxsYmFjaykuc2VuZCgpOwogIH0sCgogIC8qKgogICAqIEVudW1lcmF0ZXMgb3ZlciBpbmRpdmlkdWFsIGl0ZW1zIG9mIGEgcmVxdWVzdCwgcGFnaW5nIHRoZSByZXNwb25zZXMgaWYKICAgKiBuZWNlc3NhcnkuCiAgICoKICAgKiBAYXBpIGV4cGVyaW1lbnRhbAogICAqIEBzaW5jZSB2MS40LjAKICAgKi8KICBlYWNoSXRlbTogZnVuY3Rpb24gZWFjaEl0ZW0oY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGZ1bmN0aW9uIHdyYXBwZWRDYWxsYmFjayhlcnIsIGRhdGEpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIGNhbGxiYWNrKGVyciwgbnVsbCk7CiAgICAgIGlmIChkYXRhID09PSBudWxsKSByZXR1cm4gY2FsbGJhY2sobnVsbCwgbnVsbCk7CgogICAgICB2YXIgY29uZmlnID0gc2VsZi5zZXJ2aWNlLnBhZ2luYXRpb25Db25maWcoc2VsZi5vcGVyYXRpb24pOwogICAgICB2YXIgcmVzdWx0S2V5ID0gY29uZmlnLnJlc3VsdEtleTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0S2V5KSkgcmVzdWx0S2V5ID0gcmVzdWx0S2V5WzBdOwogICAgICB2YXIgaXRlbXMgPSBqbWVzcGF0aC5zZWFyY2goZGF0YSwgcmVzdWx0S2V5KTsKICAgICAgdmFyIGNvbnRpbnVlSXRlcmF0aW9uID0gdHJ1ZTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKGl0ZW1zLCBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgY29udGludWVJdGVyYXRpb24gPSBjYWxsYmFjayhudWxsLCBpdGVtKTsKICAgICAgICBpZiAoY29udGludWVJdGVyYXRpb24gPT09IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm4gQVdTLnV0aWwuYWJvcnQ7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGNvbnRpbnVlSXRlcmF0aW9uOwogICAgfQoKICAgIHRoaXMuZWFjaFBhZ2Uod3JhcHBlZENhbGxiYWNrKTsKICB9LAoKICAvKioKICAgKiBAcmV0dXJuIFtCb29sZWFuXSB3aGV0aGVyIHRoZSBvcGVyYXRpb24gY2FuIHJldHVybiBtdWx0aXBsZSBwYWdlcyBvZgogICAqICAgcmVzcG9uc2UgZGF0YS4KICAgKiBAc2VlIEFXUy5SZXNwb25zZS5lYWNoUGFnZQogICAqIEBzaW5jZSB2MS40LjAKICAgKi8KICBpc1BhZ2VhYmxlOiBmdW5jdGlvbiBpc1BhZ2VhYmxlKCkgewogICAgcmV0dXJuIHRoaXMuc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMub3BlcmF0aW9uKSA/IHRydWUgOiBmYWxzZTsKICB9LAoKICAvKioKICAgKiBTZW5kcyB0aGUgcmVxdWVzdCBhbmQgY29udmVydHMgdGhlIHJlcXVlc3Qgb2JqZWN0IGludG8gYSByZWFkYWJsZSBzdHJlYW0KICAgKiB0aGF0IGNhbiBiZSByZWFkIGZyb20gb3IgcGlwZWQgaW50byBhIHdyaXRhYmxlIHN0cmVhbS4KICAgKgogICAqIEBub3RlIFRoZSBkYXRhIHJlYWQgZnJvbSBhIHJlYWRhYmxlIHN0cmVhbSBjb250YWlucyBvbmx5CiAgICogICB0aGUgcmF3IEhUVFAgYm9keSBjb250ZW50cy4KICAgKiBAZXhhbXBsZSBNYW51YWxseSByZWFkaW5nIGZyb20gYSBzdHJlYW0KICAgKiAgIHJlcXVlc3QuY3JlYXRlUmVhZFN0cmVhbSgpLm9uKCdkYXRhJywgZnVuY3Rpb24oZGF0YSkgewogICAqICAgICBjb25zb2xlLmxvZygiR290IGRhdGE6IiwgZGF0YS50b1N0cmluZygpKTsKICAgKiAgIH0pOwogICAqIEBleGFtcGxlIFBpcGluZyBhIHJlcXVlc3QgYm9keSBpbnRvIGEgZmlsZQogICAqICAgdmFyIG91dCA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKCcvcGF0aC90by9vdXRmaWxlLmpwZycpOwogICAqICAgczMuc2VydmljZS5nZXRPYmplY3QocGFyYW1zKS5jcmVhdGVSZWFkU3RyZWFtKCkucGlwZShvdXQpOwogICAqIEByZXR1cm4gW1N0cmVhbV0gdGhlIHJlYWRhYmxlIHN0cmVhbSBvYmplY3QgdGhhdCBjYW4gYmUgcGlwZWQKICAgKiAgIG9yIHJlYWQgZnJvbSAoYnkgcmVnaXN0ZXJpbmcgJ2RhdGEnIGV2ZW50IGxpc3RlbmVycykuCiAgICogQCFtYWNybyBub2Jyb3dzZXIKICAgKi8KICBjcmVhdGVSZWFkU3RyZWFtOiBmdW5jdGlvbiBjcmVhdGVSZWFkU3RyZWFtKCkgewogICAgdmFyIHN0cmVhbXMgPSBBV1MudXRpbC5zdHJlYW07CiAgICB2YXIgcmVxID0gdGhpczsKICAgIHZhciBzdHJlYW0gPSBudWxsOwoKICAgIGlmIChBV1MuSHR0cENsaWVudC5zdHJlYW1zQXBpVmVyc2lvbiA9PT0gMikgewogICAgICBzdHJlYW0gPSBuZXcgc3RyZWFtcy5QYXNzVGhyb3VnaCgpOwogICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHN0cmVhbSA9IG5ldyBzdHJlYW1zLlN0cmVhbSgpOwogICAgICBzdHJlYW0ucmVhZGFibGUgPSB0cnVlOwoKICAgICAgc3RyZWFtLnNlbnQgPSBmYWxzZTsKICAgICAgc3RyZWFtLm9uKCduZXdMaXN0ZW5lcicsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKCFzdHJlYW0uc2VudCAmJiBldmVudCA9PT0gJ2RhdGEnKSB7CiAgICAgICAgICBzdHJlYW0uc2VudCA9IHRydWU7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgeyByZXEuc2VuZCgpOyB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIHRoaXMub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICB9KTsKCiAgICB0aGlzLm9uKCdodHRwSGVhZGVycycsIGZ1bmN0aW9uIHN0cmVhbUhlYWRlcnMoc3RhdHVzQ29kZSwgaGVhZGVycywgcmVzcCkgewogICAgICBpZiAoc3RhdHVzQ29kZSA8IDMwMCkgewogICAgICAgIHJlcS5yZW1vdmVMaXN0ZW5lcignaHR0cERhdGEnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5IVFRQX0RBVEEpOwogICAgICAgIHJlcS5yZW1vdmVMaXN0ZW5lcignaHR0cEVycm9yJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuSFRUUF9FUlJPUik7CiAgICAgICAgcmVxLm9uKCdodHRwRXJyb3InLCBmdW5jdGlvbiBzdHJlYW1IdHRwRXJyb3IoZXJyb3IpIHsKICAgICAgICAgIHJlc3AuZXJyb3IgPSBlcnJvcjsKICAgICAgICAgIHJlc3AuZXJyb3IucmV0cnlhYmxlID0gZmFsc2U7CiAgICAgICAgfSk7CgogICAgICAgIHZhciBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICB2YXIgZXhwZWN0ZWRMZW47CiAgICAgICAgaWYgKHJlcS5odHRwUmVxdWVzdC5tZXRob2QgIT09ICdIRUFEJykgewogICAgICAgICAgZXhwZWN0ZWRMZW4gPSBwYXJzZUludChoZWFkZXJzWydjb250ZW50LWxlbmd0aCddLCAxMCk7CiAgICAgICAgfQogICAgICAgIGlmIChleHBlY3RlZExlbiAhPT0gdW5kZWZpbmVkICYmICFpc05hTihleHBlY3RlZExlbikgJiYgZXhwZWN0ZWRMZW4gPj0gMCkgewogICAgICAgICAgc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoID0gdHJ1ZTsKICAgICAgICAgIHZhciByZWNlaXZlZExlbiA9IDA7CiAgICAgICAgfQoKICAgICAgICB2YXIgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCA9IGZ1bmN0aW9uIGNoZWNrQ29udGVudExlbmd0aEFuZEVtaXQoKSB7CiAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoICYmIHJlY2VpdmVkTGVuICE9PSBleHBlY3RlZExlbikgewogICAgICAgICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBBV1MudXRpbC5lcnJvcigKICAgICAgICAgICAgICBuZXcgRXJyb3IoJ1N0cmVhbSBjb250ZW50IGxlbmd0aCBtaXNtYXRjaC4gUmVjZWl2ZWQgJyArCiAgICAgICAgICAgICAgICByZWNlaXZlZExlbiArICcgb2YgJyArIGV4cGVjdGVkTGVuICsgJyBieXRlcy4nKSwKICAgICAgICAgICAgICB7IGNvZGU6ICdTdHJlYW1Db250ZW50TGVuZ3RoTWlzbWF0Y2gnIH0KICAgICAgICAgICAgKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgICAgIHN0cmVhbS5lbmQoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgaHR0cFN0cmVhbSA9IHJlc3AuaHR0cFJlc3BvbnNlLmNyZWF0ZVVuYnVmZmVyZWRTdHJlYW0oKTsKCiAgICAgICAgaWYgKEFXUy5IdHRwQ2xpZW50LnN0cmVhbXNBcGlWZXJzaW9uID09PSAyKSB7CiAgICAgICAgICBpZiAoc2hvdWxkQ2hlY2tDb250ZW50TGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZW5ndGhBY2N1bXVsYXRvciA9IG5ldyBzdHJlYW1zLlBhc3NUaHJvdWdoKCk7CiAgICAgICAgICAgIGxlbmd0aEFjY3VtdWxhdG9yLl93cml0ZSA9IGZ1bmN0aW9uKGNodW5rKSB7CiAgICAgICAgICAgICAgaWYgKGNodW5rICYmIGNodW5rLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKz0gY2h1bmsubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gc3RyZWFtcy5QYXNzVGhyb3VnaC5wcm90b3R5cGUuX3dyaXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsZW5ndGhBY2N1bXVsYXRvci5vbignZW5kJywgY2hlY2tDb250ZW50TGVuZ3RoQW5kRW1pdCk7CiAgICAgICAgICAgIHN0cmVhbS5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgICAgICBodHRwU3RyZWFtLnVucGlwZShsZW5ndGhBY2N1bXVsYXRvcik7CiAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuZW1pdCgnZW5kJyk7CiAgICAgICAgICAgICAgbGVuZ3RoQWNjdW11bGF0b3IuZW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBodHRwU3RyZWFtLnBpcGUobGVuZ3RoQWNjdW11bGF0b3IpLnBpcGUoc3RyZWFtLCB7IGVuZDogZmFsc2UgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBodHRwU3RyZWFtLnBpcGUoc3RyZWFtKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIGlmIChzaG91bGRDaGVja0NvbnRlbnRMZW5ndGgpIHsKICAgICAgICAgICAgaHR0cFN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgIGlmIChhcmcgJiYgYXJnLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcmVjZWl2ZWRMZW4gKz0gYXJnLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIGh0dHBTdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihhcmcpIHsKICAgICAgICAgICAgc3RyZWFtLmVtaXQoJ2RhdGEnLCBhcmcpOwogICAgICAgICAgfSk7CiAgICAgICAgICBodHRwU3RyZWFtLm9uKCdlbmQnLCBjaGVja0NvbnRlbnRMZW5ndGhBbmRFbWl0KTsKICAgICAgICB9CgogICAgICAgIGh0dHBTdHJlYW0ub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICBzaG91bGRDaGVja0NvbnRlbnRMZW5ndGggPSBmYWxzZTsKICAgICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBzdHJlYW07CiAgfSwKCiAgLyoqCiAgICogQHBhcmFtIFtBcnJheSxSZXNwb25zZV0gYXJncyBUaGlzIHNob3VsZCBiZSB0aGUgcmVzcG9uc2Ugb2JqZWN0LAogICAqICAgb3IgYW4gYXJyYXkgb2YgYXJncyB0byBzZW5kIHRvIHRoZSBldmVudC4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBlbWl0RXZlbnQ6IGZ1bmN0aW9uIGVtaXQoZXZlbnROYW1lLCBhcmdzLCBkb25lKSB7CiAgICBpZiAodHlwZW9mIGFyZ3MgPT09ICdmdW5jdGlvbicpIHsgZG9uZSA9IGFyZ3M7IGFyZ3MgPSBudWxsOyB9CiAgICBpZiAoIWRvbmUpIGRvbmUgPSBmdW5jdGlvbigpIHsgfTsKICAgIGlmICghYXJncykgYXJncyA9IHRoaXMuZXZlbnRQYXJhbWV0ZXJzKGV2ZW50TmFtZSwgdGhpcy5yZXNwb25zZSk7CgogICAgdmFyIG9yaWdFbWl0ID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUuZW1pdDsKICAgIG9yaWdFbWl0LmNhbGwodGhpcywgZXZlbnROYW1lLCBhcmdzLCBmdW5jdGlvbiAoZXJyKSB7CiAgICAgIGlmIChlcnIpIHRoaXMucmVzcG9uc2UuZXJyb3IgPSBlcnI7CiAgICAgIGRvbmUuY2FsbCh0aGlzLCBlcnIpOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZXZlbnRQYXJhbWV0ZXJzOiBmdW5jdGlvbiBldmVudFBhcmFtZXRlcnMoZXZlbnROYW1lKSB7CiAgICBzd2l0Y2ggKGV2ZW50TmFtZSkgewogICAgICBjYXNlICdyZXN0YXJ0JzoKICAgICAgY2FzZSAndmFsaWRhdGUnOgogICAgICBjYXNlICdzaWduJzoKICAgICAgY2FzZSAnYnVpbGQnOgogICAgICBjYXNlICdhZnRlclZhbGlkYXRlJzoKICAgICAgY2FzZSAnYWZ0ZXJCdWlsZCc6CiAgICAgICAgcmV0dXJuIFt0aGlzXTsKICAgICAgY2FzZSAnZXJyb3InOgogICAgICAgIHJldHVybiBbdGhpcy5yZXNwb25zZS5lcnJvciwgdGhpcy5yZXNwb25zZV07CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIFt0aGlzLnJlc3BvbnNlXTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBwcmVzaWduOiBmdW5jdGlvbiBwcmVzaWduKGV4cGlyZXMsIGNhbGxiYWNrKSB7CiAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBleHBpcmVzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gZXhwaXJlczsKICAgICAgZXhwaXJlcyA9IG51bGw7CiAgICB9CiAgICByZXR1cm4gbmV3IEFXUy5TaWduZXJzLlByZXNpZ24oKS5zaWduKHRoaXMudG9HZXQoKSwgZXhwaXJlcywgY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGlzUHJlc2lnbmVkOiBmdW5jdGlvbiBpc1ByZXNpZ25lZCgpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGhpcy5odHRwUmVxdWVzdC5oZWFkZXJzLCAncHJlc2lnbmVkLWV4cGlyZXMnKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB0b1VuYXV0aGVudGljYXRlZDogZnVuY3Rpb24gdG9VbmF1dGhlbnRpY2F0ZWQoKSB7CiAgICB0aGlzLl91bkF1dGhlbnRpY2F0ZWQgPSB0cnVlOwogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLCBBV1MuRXZlbnRMaXN0ZW5lcnMuQ29yZS5WQUxJREFURV9DUkVERU5USUFMUyk7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdzaWduJywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuU0lHTik7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB0b0dldDogZnVuY3Rpb24gdG9HZXQoKSB7CiAgICBpZiAodGhpcy5zZXJ2aWNlLmFwaS5wcm90b2NvbCA9PT0gJ3F1ZXJ5JyB8fAogICAgICAgIHRoaXMuc2VydmljZS5hcGkucHJvdG9jb2wgPT09ICdlYzInKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ2J1aWxkJywgdGhpcy5idWlsZEFzR2V0KTsKICAgICAgdGhpcy5hZGRMaXN0ZW5lcignYnVpbGQnLCB0aGlzLmJ1aWxkQXNHZXQpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYnVpbGRBc0dldDogZnVuY3Rpb24gYnVpbGRBc0dldChyZXF1ZXN0KSB7CiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0Lm1ldGhvZCA9ICdHRVQnOwogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5wYXRoID0gcmVxdWVzdC5zZXJ2aWNlLmVuZHBvaW50LnBhdGggKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJz8nICsgcmVxdWVzdC5odHRwUmVxdWVzdC5ib2R5OwogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5ib2R5ID0gJyc7CgogICAgLy8gZG9uJ3QgbmVlZCB0aGVzZSBoZWFkZXJzIG9uIGEgR0VUIHJlcXVlc3QKICAgIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ107CiAgICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBoYWx0SGFuZGxlcnNPbkVycm9yOiBmdW5jdGlvbiBoYWx0SGFuZGxlcnNPbkVycm9yKCkgewogICAgdGhpcy5faGFsdEhhbmRsZXJzT25FcnJvciA9IHRydWU7CiAgfQp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5SZXF1ZXN0LmFkZFByb21pc2VzVG9DbGFzcyA9IGZ1bmN0aW9uIGFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSkgewogIHRoaXMucHJvdG90eXBlLnByb21pc2UgPSBmdW5jdGlvbiBwcm9taXNlKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgLy8gYXBwZW5kIHRvIHVzZXIgYWdlbnQKICAgIHRoaXMuaHR0cFJlcXVlc3QuYXBwZW5kVG9Vc2VyQWdlbnQoJ3Byb21pc2UnKTsKICAgIHJldHVybiBuZXcgUHJvbWlzZURlcGVuZGVuY3koZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgIHNlbGYub24oJ2NvbXBsZXRlJywgZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChyZXNwLmVycm9yKSB7CiAgICAgICAgICByZWplY3QocmVzcC5lcnJvcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGRlZmluZSAkcmVzcG9uc2UgcHJvcGVydHkgc28gdGhhdCBpdCBpcyBub3QgZW51bWVyYWJsZQogICAgICAgICAgLy8gdGhpcyBwcmV2ZW50cyBjaXJjdWxhciByZWZlcmVuY2UgZXJyb3JzIHdoZW4gc3RyaW5naWZ5aW5nIHRoZSBKU09OIG9iamVjdAogICAgICAgICAgcmVzb2x2ZShPYmplY3QuZGVmaW5lUHJvcGVydHkoCiAgICAgICAgICAgIHJlc3AuZGF0YSB8fCB7fSwKICAgICAgICAgICAgJyRyZXNwb25zZScsCiAgICAgICAgICAgIHt2YWx1ZTogcmVzcH0KICAgICAgICAgICkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHNlbGYucnVuVG8oKTsKICAgIH0pOwogIH07Cn07CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuUmVxdWVzdC5kZWxldGVQcm9taXNlc0Zyb21DbGFzcyA9IGZ1bmN0aW9uIGRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCkgewogIGRlbGV0ZSB0aGlzLnByb3RvdHlwZS5wcm9taXNlOwp9OwoKQVdTLnV0aWwuYWRkUHJvbWlzZXMoQVdTLlJlcXVlc3QpOwoKQVdTLnV0aWwubWl4aW4oQVdTLlJlcXVlc3QsIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IpOwoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9jb3JlIjoxOSwiLi9zdGF0ZV9tYWNoaW5lIjo3MSwiX3Byb2Nlc3MiOjg5LCJqbWVzcGF0aCI6ODh9XSw1ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBDb3B5cmlnaHQgMjAxMi0yMDEzIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpLiBZb3UKICogbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZgogKiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0CiAqCiAqICAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXBhY2hlMi4wLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzCiAqIGRpc3RyaWJ1dGVkIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GCiAqIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYwogKiBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0Owp2YXIgam1lc3BhdGggPSByZXF1aXJlKCdqbWVzcGF0aCcpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gQ0hFQ0tfQUNDRVBUT1JTKHJlc3ApIHsKICB2YXIgd2FpdGVyID0gcmVzcC5yZXF1ZXN0Ll93YWl0ZXI7CiAgdmFyIGFjY2VwdG9ycyA9IHdhaXRlci5jb25maWcuYWNjZXB0b3JzOwogIHZhciBhY2NlcHRvck1hdGNoZWQgPSBmYWxzZTsKICB2YXIgc3RhdGUgPSAncmV0cnknOwoKICBhY2NlcHRvcnMuZm9yRWFjaChmdW5jdGlvbihhY2NlcHRvcikgewogICAgaWYgKCFhY2NlcHRvck1hdGNoZWQpIHsKICAgICAgdmFyIG1hdGNoZXIgPSB3YWl0ZXIubWF0Y2hlcnNbYWNjZXB0b3IubWF0Y2hlcl07CiAgICAgIGlmIChtYXRjaGVyICYmIG1hdGNoZXIocmVzcCwgYWNjZXB0b3IuZXhwZWN0ZWQsIGFjY2VwdG9yLmFyZ3VtZW50KSkgewogICAgICAgIGFjY2VwdG9yTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgc3RhdGUgPSBhY2NlcHRvci5zdGF0ZTsKICAgICAgfQogICAgfQogIH0pOwoKICBpZiAoIWFjY2VwdG9yTWF0Y2hlZCAmJiByZXNwLmVycm9yKSBzdGF0ZSA9ICdmYWlsdXJlJzsKCiAgaWYgKHN0YXRlID09PSAnc3VjY2VzcycpIHsKICAgIHdhaXRlci5zZXRTdWNjZXNzKHJlc3ApOwogIH0gZWxzZSB7CiAgICB3YWl0ZXIuc2V0RXJyb3IocmVzcCwgc3RhdGUgPT09ICdyZXRyeScpOwogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlJlc291cmNlV2FpdGVyID0gaW5oZXJpdCh7CiAgLyoqCiAgICogV2FpdHMgZm9yIGEgZ2l2ZW4gc3RhdGUgb24gYSBzZXJ2aWNlIG9iamVjdAogICAqIEBwYXJhbSBzZXJ2aWNlIFtTZXJ2aWNlXSB0aGUgc2VydmljZSBvYmplY3QgdG8gd2FpdCBvbgogICAqIEBwYXJhbSBzdGF0ZSBbU3RyaW5nXSB0aGUgc3RhdGUgKGRlZmluZWQgaW4gd2FpdGVyIGNvbmZpZ3VyYXRpb24pIHRvIHdhaXQKICAgKiAgIGZvci4KICAgKiBAZXhhbXBsZSBDcmVhdGUgYSB3YWl0ZXIgZm9yIHJ1bm5pbmcgRUMyIGluc3RhbmNlcwogICAqICAgdmFyIGVjMiA9IG5ldyBBV1MuRUMyOwogICAqICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIoZWMyLCAnaW5zdGFuY2VSdW5uaW5nJyk7CiAgICovCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIGNvbnN0cnVjdG9yKHNlcnZpY2UsIHN0YXRlKSB7CiAgICB0aGlzLnNlcnZpY2UgPSBzZXJ2aWNlOwogICAgdGhpcy5zdGF0ZSA9IHN0YXRlOwogICAgdGhpcy5sb2FkV2FpdGVyQ29uZmlnKHRoaXMuc3RhdGUpOwogIH0sCgogIHNlcnZpY2U6IG51bGwsCgogIHN0YXRlOiBudWxsLAoKICBjb25maWc6IG51bGwsCgogIG1hdGNoZXJzOiB7CiAgICBwYXRoOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCwgYXJndW1lbnQpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcmVzdWx0ID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiBqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0LGV4cGVjdGVkKTsKICAgIH0sCgogICAgcGF0aEFsbDogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQsIGFyZ3VtZW50KSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHJlc3VsdHMgPSBqbWVzcGF0aC5zZWFyY2gocmVzcC5kYXRhLCBhcmd1bWVudCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlc3VsdHMpKSByZXN1bHRzID0gW3Jlc3VsdHNdOwogICAgICB2YXIgbnVtUmVzdWx0cyA9IHJlc3VsdHMubGVuZ3RoOwogICAgICBpZiAoIW51bVJlc3VsdHMpIHJldHVybiBmYWxzZTsKICAgICAgZm9yICh2YXIgaW5kID0gMCA7IGluZCA8IG51bVJlc3VsdHM7IGluZCsrKSB7CiAgICAgICAgaWYgKCFqbWVzcGF0aC5zdHJpY3REZWVwRXF1YWwocmVzdWx0c1tpbmRdLCBleHBlY3RlZCkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIHBhdGhBbnk6IGZ1bmN0aW9uKHJlc3AsIGV4cGVjdGVkLCBhcmd1bWVudCkgewogICAgICB0cnkgewogICAgICAgIHZhciByZXN1bHRzID0gam1lc3BhdGguc2VhcmNoKHJlc3AuZGF0YSwgYXJndW1lbnQpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGlmICghQXJyYXkuaXNBcnJheShyZXN1bHRzKSkgcmVzdWx0cyA9IFtyZXN1bHRzXTsKICAgICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgICAgZm9yICh2YXIgaW5kID0gMCA7IGluZCA8IG51bVJlc3VsdHM7IGluZCsrKSB7CiAgICAgICAgaWYgKGptZXNwYXRoLnN0cmljdERlZXBFcXVhbChyZXN1bHRzW2luZF0sIGV4cGVjdGVkKSkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgc3RhdHVzOiBmdW5jdGlvbihyZXNwLCBleHBlY3RlZCkgewogICAgICB2YXIgc3RhdHVzQ29kZSA9IHJlc3AuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIHJldHVybiAodHlwZW9mIHN0YXR1c0NvZGUgPT09ICdudW1iZXInKSAmJiAoc3RhdHVzQ29kZSA9PT0gZXhwZWN0ZWQpOwogICAgfSwKCiAgICBlcnJvcjogZnVuY3Rpb24ocmVzcCwgZXhwZWN0ZWQpIHsKICAgICAgaWYgKHR5cGVvZiBleHBlY3RlZCA9PT0gJ3N0cmluZycgJiYgcmVzcC5lcnJvcikgewogICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gcmVzcC5lcnJvci5jb2RlOwogICAgICB9CiAgICAgIC8vIGlmIGV4cGVjdGVkIGlzIG5vdCBzdHJpbmcsIGNhbiBiZSBib29sZWFuIGluZGljYXRpbmcgcHJlc2VuY2Ugb2YgZXJyb3IKICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSAhIXJlc3AuZXJyb3I7CiAgICB9CiAgfSwKCiAgbGlzdGVuZXJzOiBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpLmFkZE5hbWVkTGlzdGVuZXJzKGZ1bmN0aW9uKGFkZCkgewogICAgYWRkKCdSRVRSWV9DSEVDSycsICdyZXRyeScsIGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgdmFyIHdhaXRlciA9IHJlc3AucmVxdWVzdC5fd2FpdGVyOwogICAgICBpZiAocmVzcC5lcnJvciAmJiByZXNwLmVycm9yLmNvZGUgPT09ICdSZXNvdXJjZU5vdFJlYWR5JykgewogICAgICAgIHJlc3AuZXJyb3IucmV0cnlEZWxheSA9ICh3YWl0ZXIuY29uZmlnLmRlbGF5IHx8IDApICogMTAwMDsKICAgICAgfQogICAgfSk7CgogICAgYWRkKCdDSEVDS19PVVRQVVQnLCAnZXh0cmFjdERhdGEnLCBDSEVDS19BQ0NFUFRPUlMpOwoKICAgIGFkZCgnQ0hFQ0tfRVJST1InLCAnZXh0cmFjdEVycm9yJywgQ0hFQ0tfQUNDRVBUT1JTKTsKICB9KSwKCiAgLyoqCiAgICogQHJldHVybiBbQVdTLlJlcXVlc3RdCiAgICovCiAgd2FpdDogZnVuY3Rpb24gd2FpdChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IHBhcmFtczsgcGFyYW1zID0gdW5kZWZpbmVkOwogICAgfQoKICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLiR3YWl0ZXIpIHsKICAgICAgcGFyYW1zID0gQVdTLnV0aWwuY29weShwYXJhbXMpOwogICAgICBpZiAodHlwZW9mIHBhcmFtcy4kd2FpdGVyLmRlbGF5ID09PSAnbnVtYmVyJykgewogICAgICAgIHRoaXMuY29uZmlnLmRlbGF5ID0gcGFyYW1zLiR3YWl0ZXIuZGVsYXk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBwYXJhbXMuJHdhaXRlci5tYXhBdHRlbXB0cyA9PT0gJ251bWJlcicpIHsKICAgICAgICB0aGlzLmNvbmZpZy5tYXhBdHRlbXB0cyA9IHBhcmFtcy4kd2FpdGVyLm1heEF0dGVtcHRzOwogICAgICB9CiAgICAgIGRlbGV0ZSBwYXJhbXMuJHdhaXRlcjsKICAgIH0KCiAgICB2YXIgcmVxdWVzdCA9IHRoaXMuc2VydmljZS5tYWtlUmVxdWVzdCh0aGlzLmNvbmZpZy5vcGVyYXRpb24sIHBhcmFtcyk7CiAgICByZXF1ZXN0Ll93YWl0ZXIgPSB0aGlzOwogICAgcmVxdWVzdC5yZXNwb25zZS5tYXhSZXRyaWVzID0gdGhpcy5jb25maWcubWF4QXR0ZW1wdHM7CiAgICByZXF1ZXN0LmFkZExpc3RlbmVycyh0aGlzLmxpc3RlbmVycyk7CgogICAgaWYgKGNhbGxiYWNrKSByZXF1ZXN0LnNlbmQoY2FsbGJhY2spOwogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfSwKCiAgc2V0U3VjY2VzczogZnVuY3Rpb24gc2V0U3VjY2VzcyhyZXNwKSB7CiAgICByZXNwLmVycm9yID0gbnVsbDsKICAgIHJlc3AuZGF0YSA9IHJlc3AuZGF0YSB8fCB7fTsKICAgIHJlc3AucmVxdWVzdC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4dHJhY3REYXRhJyk7CiAgfSwKCiAgc2V0RXJyb3I6IGZ1bmN0aW9uIHNldEVycm9yKHJlc3AsIHJldHJ5YWJsZSkgewogICAgcmVzcC5kYXRhID0gbnVsbDsKICAgIHJlc3AuZXJyb3IgPSBBV1MudXRpbC5lcnJvcihyZXNwLmVycm9yIHx8IG5ldyBFcnJvcigpLCB7CiAgICAgIGNvZGU6ICdSZXNvdXJjZU5vdFJlYWR5JywKICAgICAgbWVzc2FnZTogJ1Jlc291cmNlIGlzIG5vdCBpbiB0aGUgc3RhdGUgJyArIHRoaXMuc3RhdGUsCiAgICAgIHJldHJ5YWJsZTogcmV0cnlhYmxlCiAgICB9KTsKICB9LAoKICAvKioKICAgKiBMb2FkcyB3YWl0ZXIgY29uZmlndXJhdGlvbiBmcm9tIEFQSSBjb25maWd1cmF0aW9uCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkV2FpdGVyQ29uZmlnOiBmdW5jdGlvbiBsb2FkV2FpdGVyQ29uZmlnKHN0YXRlKSB7CiAgICBpZiAoIXRoaXMuc2VydmljZS5hcGkud2FpdGVyc1tzdGF0ZV0pIHsKICAgICAgdGhyb3cgbmV3IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLCB7CiAgICAgICAgY29kZTogJ1N0YXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgbWVzc2FnZTogJ1N0YXRlICcgKyBzdGF0ZSArICcgbm90IGZvdW5kLicKICAgICAgfSk7CiAgICB9CgogICAgdGhpcy5jb25maWcgPSBBV1MudXRpbC5jb3B5KHRoaXMuc2VydmljZS5hcGkud2FpdGVyc1tzdGF0ZV0pOwogIH0KfSk7Cgp9LHsiLi9jb3JlIjoxOSwiam1lc3BhdGgiOjg4fV0sNTk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKdmFyIGptZXNwYXRoID0gcmVxdWlyZSgnam1lc3BhdGgnKTsKCi8qKgogKiBUaGlzIGNsYXNzIGVuY2Fwc3VsYXRlcyB0aGUgcmVzcG9uc2UgaW5mb3JtYXRpb24KICogZnJvbSBhIHNlcnZpY2UgcmVxdWVzdCBvcGVyYXRpb24gc2VudCB0aHJvdWdoIHtBV1MuUmVxdWVzdH0uCiAqIFRoZSByZXNwb25zZSBvYmplY3QgaGFzIHR3byBtYWluIHByb3BlcnRpZXMgZm9yIGdldHRpbmcgaW5mb3JtYXRpb24KICogYmFjayBmcm9tIGEgcmVxdWVzdDoKICoKICogIyMgVGhlIGBkYXRhYCBwcm9wZXJ0eQogKgogKiBUaGUgYHJlc3BvbnNlLmRhdGFgIHByb3BlcnR5IGNvbnRhaW5zIHRoZSBzZXJpYWxpemVkIG9iamVjdCBkYXRhCiAqIHJldHJpZXZlZCBmcm9tIHRoZSBzZXJ2aWNlIHJlcXVlc3QuIEZvciBpbnN0YW5jZSwgZm9yIGFuCiAqIEFtYXpvbiBEeW5hbW9EQiBgbGlzdFRhYmxlc2AgbWV0aG9kIGNhbGwsIHRoZSByZXNwb25zZSBkYXRhIG1pZ2h0CiAqIGxvb2sgbGlrZToKICoKICogYGBgCiAqID4gcmVzcC5kYXRhCiAqIHsgVGFibGVOYW1lczoKICogICAgWyAndGFibGUxJywgJ3RhYmxlMicsIC4uLiBdIH0KICogYGBgCiAqCiAqIFRoZSBgZGF0YWAgcHJvcGVydHkgY2FuIGJlIG51bGwgaWYgYW4gZXJyb3Igb2NjdXJzIChzZWUgYmVsb3cpLgogKgogKiAjIyBUaGUgYGVycm9yYCBwcm9wZXJ0eQogKgogKiBJbiB0aGUgZXZlbnQgb2YgYSBzZXJ2aWNlIGVycm9yIChvciB0cmFuc2ZlciBlcnJvciksIHRoZQogKiBgcmVzcG9uc2UuZXJyb3JgIHByb3BlcnR5IHdpbGwgYmUgZmlsbGVkIHdpdGggdGhlIGdpdmVuCiAqIGVycm9yIGRhdGEgaW4gdGhlIGZvcm06CiAqCiAqIGBgYAogKiB7IGNvZGU6ICdTSE9SVF9VTklRVUVfRVJST1JfQ09ERScsCiAqICAgbWVzc2FnZTogJ1NvbWUgaHVtYW4gcmVhZGFibGUgZXJyb3IgbWVzc2FnZScgfQogKiBgYGAKICoKICogSW4gdGhlIGNhc2Ugb2YgYW4gZXJyb3IsIHRoZSBgZGF0YWAgcHJvcGVydHkgd2lsbCBiZSBgbnVsbGAuCiAqIE5vdGUgdGhhdCBpZiB5b3UgaGFuZGxlIGV2ZW50cyB0aGF0IGNhbiBiZSBpbiBhIGZhaWx1cmUgc3RhdGUsCiAqIHlvdSBzaG91bGQgYWx3YXlzIGNoZWNrIHdoZXRoZXIgYHJlc3BvbnNlLmVycm9yYCBpcyBzZXQKICogYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIHRoZSBgcmVzcG9uc2UuZGF0YWAgcHJvcGVydHkuCiAqCiAqIEAhYXR0cmlidXRlIGRhdGEKICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIERhdGEgUHJvcGVydGllcwogKiAgIEBub3RlIEluc2lkZSBvZiBhIHtBV1MuUmVxdWVzdH5odHRwRGF0YX0gZXZlbnQsIHRoaXMKICogICAgIHByb3BlcnR5IGNvbnRhaW5zIGEgc2luZ2xlIHJhdyBwYWNrZXQgaW5zdGVhZCBvZiB0aGUKICogICAgIGZ1bGwgZGUtc2VyaWFsaXplZCBzZXJ2aWNlIHJlc3BvbnNlLgogKiAgIEByZXR1cm4gW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgcmVzcG9uc2UgZGF0YQogKiAgICAgZnJvbSB0aGUgc2VydmljZS4KICoKICogQCFhdHRyaWJ1dGUgZXJyb3IKICogICBBbiBzdHJ1Y3R1cmUgY29udGFpbmluZyBpbmZvcm1hdGlvbiBhYm91dCBhIHNlcnZpY2UKICogICBvciBuZXR3b3JraW5nIGVycm9yLgogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgRGF0YSBQcm9wZXJ0aWVzCiAqICAgQG5vdGUgVGhpcyBhdHRyaWJ1dGUgaXMgb25seSBmaWxsZWQgaWYgYSBzZXJ2aWNlIG9yCiAqICAgICBuZXR3b3JraW5nIGVycm9yIG9jY3Vycy4KICogICBAcmV0dXJuIFtFcnJvcl0KICogICAgICogY29kZSBbU3RyaW5nXSBhIHVuaXF1ZSBzaG9ydCBjb2RlIHJlcHJlc2VudGluZyB0aGUKICogICAgICAgZXJyb3IgdGhhdCB3YXMgZW1pdHRlZC4KICogICAgICogbWVzc2FnZSBbU3RyaW5nXSBhIGxvbmdlciBodW1hbiByZWFkYWJsZSBlcnJvciBtZXNzYWdlCiAqICAgICAqIHJldHJ5YWJsZSBbQm9vbGVhbl0gd2hldGhlciB0aGUgZXJyb3IgbWVzc2FnZSBpcwogKiAgICAgICByZXRyeWFibGUuCiAqICAgICAqIHN0YXR1c0NvZGUgW051bWVyaWNdIGluIHRoZSBjYXNlIG9mIGEgcmVxdWVzdCB0aGF0IHJlYWNoZWQgdGhlIHNlcnZpY2UsCiAqICAgICAgIHRoaXMgdmFsdWUgY29udGFpbnMgdGhlIHJlc3BvbnNlIHN0YXR1cyBjb2RlLgogKiAgICAgKiB0aW1lIFtEYXRlXSB0aGUgZGF0ZSB0aW1lIG9iamVjdCB3aGVuIHRoZSBlcnJvciBvY2N1cnJlZC4KICogICAgICogaG9zdG5hbWUgW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICogICAgICAgaWRlbnRpZnkgdGhlIGVuZHBvaW50IG9mIHRoZSByZXF1ZXN0LgogKiAgICAgKiByZWdpb24gW1N0cmluZ10gc2V0IHdoZW4gYSBuZXR3b3JraW5nIGVycm9yIG9jY3VycyB0byBlYXNpbHkKICogICAgICAgaWRlbnRpZnkgdGhlIHJlZ2lvbiBvZiB0aGUgcmVxdWVzdC4KICoKICogQCFhdHRyaWJ1dGUgcmVxdWVzdElkCiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBEYXRhIFByb3BlcnRpZXMKICogICBAcmV0dXJuIFtTdHJpbmddIHRoZSB1bmlxdWUgcmVxdWVzdCBJRCBhc3NvY2lhdGVkIHdpdGggdGhlIHJlc3BvbnNlLgogKiAgICAgTG9nIHRoaXMgdmFsdWUgd2hlbiBkZWJ1Z2dpbmcgcmVxdWVzdHMgZm9yIEFXUyBzdXBwb3J0LgogKgogKiBAIWF0dHJpYnV0ZSByZXRyeUNvdW50CiAqICAgQHJlYWRvbmx5CiAqICAgQCFncm91cCBPcGVyYXRpb24gUHJvcGVydGllcwogKiAgIEByZXR1cm4gW0ludGVnZXJdIHRoZSBudW1iZXIgb2YgcmV0cmllcyB0aGF0IHdlcmUKICogICAgIGF0dGVtcHRlZCBiZWZvcmUgdGhlIHJlcXVlc3Qgd2FzIGNvbXBsZXRlZC4KICoKICogQCFhdHRyaWJ1dGUgcmVkaXJlY3RDb3VudAogKiAgIEByZWFkb25seQogKiAgIEAhZ3JvdXAgT3BlcmF0aW9uIFByb3BlcnRpZXMKICogICBAcmV0dXJuIFtJbnRlZ2VyXSB0aGUgbnVtYmVyIG9mIHJlZGlyZWN0cyB0aGF0IHdlcmUKICogICAgIGZvbGxvd2VkIGJlZm9yZSB0aGUgcmVxdWVzdCB3YXMgY29tcGxldGVkLgogKgogKiBAIWF0dHJpYnV0ZSBodHRwUmVzcG9uc2UKICogICBAcmVhZG9ubHkKICogICBAIWdyb3VwIEhUVFAgUHJvcGVydGllcwogKiAgIEByZXR1cm4gW0FXUy5IdHRwUmVzcG9uc2VdIHRoZSByYXcgSFRUUCByZXNwb25zZSBvYmplY3QKICogICAgIGNvbnRhaW5pbmcgdGhlIHJlc3BvbnNlIGhlYWRlcnMgYW5kIGJvZHkgaW5mb3JtYXRpb24KICogICAgIGZyb20gdGhlIHNlcnZlci4KICoKICogQHNlZSBBV1MuUmVxdWVzdAogKi8KQVdTLlJlc3BvbnNlID0gaW5oZXJpdCh7CgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXNwb25zZShyZXF1ZXN0KSB7CiAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0OwogICAgdGhpcy5kYXRhID0gbnVsbDsKICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgdGhpcy5yZXRyeUNvdW50ID0gMDsKICAgIHRoaXMucmVkaXJlY3RDb3VudCA9IDA7CiAgICB0aGlzLmh0dHBSZXNwb25zZSA9IG5ldyBBV1MuSHR0cFJlc3BvbnNlKCk7CiAgICBpZiAocmVxdWVzdCkgewogICAgICB0aGlzLm1heFJldHJpZXMgPSByZXF1ZXN0LnNlcnZpY2UubnVtUmV0cmllcygpOwogICAgICB0aGlzLm1heFJlZGlyZWN0cyA9IHJlcXVlc3Quc2VydmljZS5jb25maWcubWF4UmVkaXJlY3RzOwogICAgfQogIH0sCgogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgcmVxdWVzdCBmb3IgdGhlIG5leHQgcGFnZSBvZiByZXNwb25zZSBkYXRhLCBjYWxsaW5nIHRoZQogICAqIGNhbGxiYWNrIHdpdGggdGhlIHBhZ2UgZGF0YSBpZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkLgogICAqCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgKiAgIENhbGxlZCB3aGVuIGEgcGFnZSBvZiBkYXRhIGlzIHJldHVybmVkIGZyb20gdGhlIG5leHQgcmVxdWVzdC4KICAgKgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIGFuIGVycm9yIG9iamVjdCwgaWYgYW4gZXJyb3Igb2NjdXJyZWQgaW4gdGhlIHJlcXVlc3QKICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBuZXh0IHBhZ2Ugb2YgZGF0YSwgb3IgbnVsbCwgaWYgdGhlcmUgYXJlIG5vCiAgICogICAgIG1vcmUgcGFnZXMgbGVmdC4KICAgKiBAcmV0dXJuIFtBV1MuUmVxdWVzdF0gdGhlIHJlcXVlc3Qgb2JqZWN0IGZvciB0aGUgbmV4dCBwYWdlIG9mIGRhdGEKICAgKiBAcmV0dXJuIFtudWxsXSBpZiBubyBjYWxsYmFjayBpcyBwcm92aWRlZCBhbmQgdGhlcmUgYXJlIG5vIHBhZ2VzIGxlZnQKICAgKiAgIHRvIHJldHJpZXZlLgogICAqIEBzaW5jZSB2MS40LjAKICAgKi8KICBuZXh0UGFnZTogZnVuY3Rpb24gbmV4dFBhZ2UoY2FsbGJhY2spIHsKICAgIHZhciBjb25maWc7CiAgICB2YXIgc2VydmljZSA9IHRoaXMucmVxdWVzdC5zZXJ2aWNlOwogICAgdmFyIG9wZXJhdGlvbiA9IHRoaXMucmVxdWVzdC5vcGVyYXRpb247CiAgICB0cnkgewogICAgICBjb25maWcgPSBzZXJ2aWNlLnBhZ2luYXRpb25Db25maWcob3BlcmF0aW9uLCB0cnVlKTsKICAgIH0gY2F0Y2ggKGUpIHsgdGhpcy5lcnJvciA9IGU7IH0KCiAgICBpZiAoIXRoaXMuaGFzTmV4dFBhZ2UoKSkgewogICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKHRoaXMuZXJyb3IsIG51bGwpOwogICAgICBlbHNlIGlmICh0aGlzLmVycm9yKSB0aHJvdyB0aGlzLmVycm9yOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICB2YXIgcGFyYW1zID0gQVdTLnV0aWwuY29weSh0aGlzLnJlcXVlc3QucGFyYW1zKTsKICAgIGlmICghdGhpcy5uZXh0UGFnZVRva2VucykgewogICAgICByZXR1cm4gY2FsbGJhY2sgPyBjYWxsYmFjayhudWxsLCBudWxsKSA6IG51bGw7CiAgICB9IGVsc2UgewogICAgICB2YXIgaW5wdXRUb2tlbnMgPSBjb25maWcuaW5wdXRUb2tlbjsKICAgICAgaWYgKHR5cGVvZiBpbnB1dFRva2VucyA9PT0gJ3N0cmluZycpIGlucHV0VG9rZW5zID0gW2lucHV0VG9rZW5zXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbnB1dFRva2Vucy5sZW5ndGg7IGkrKykgewogICAgICAgIHBhcmFtc1tpbnB1dFRva2Vuc1tpXV0gPSB0aGlzLm5leHRQYWdlVG9rZW5zW2ldOwogICAgICB9CiAgICAgIHJldHVybiBzZXJ2aWNlLm1ha2VSZXF1ZXN0KHRoaXMucmVxdWVzdC5vcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spOwogICAgfQogIH0sCgogIC8qKgogICAqIEByZXR1cm4gW0Jvb2xlYW5dIHdoZXRoZXIgbW9yZSBwYWdlcyBvZiBkYXRhIGNhbiBiZSByZXR1cm5lZCBieSBmdXJ0aGVyCiAgICogICByZXF1ZXN0cwogICAqIEBzaW5jZSB2MS40LjAKICAgKi8KICBoYXNOZXh0UGFnZTogZnVuY3Rpb24gaGFzTmV4dFBhZ2UoKSB7CiAgICB0aGlzLmNhY2hlTmV4dFBhZ2VUb2tlbnMoKTsKICAgIGlmICh0aGlzLm5leHRQYWdlVG9rZW5zKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0aGlzLm5leHRQYWdlVG9rZW5zID09PSB1bmRlZmluZWQpIHJldHVybiB1bmRlZmluZWQ7CiAgICBlbHNlIHJldHVybiBmYWxzZTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBjYWNoZU5leHRQYWdlVG9rZW5zOiBmdW5jdGlvbiBjYWNoZU5leHRQYWdlVG9rZW5zKCkgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnbmV4dFBhZ2VUb2tlbnMnKSkgcmV0dXJuIHRoaXMubmV4dFBhZ2VUb2tlbnM7CiAgICB0aGlzLm5leHRQYWdlVG9rZW5zID0gdW5kZWZpbmVkOwoKICAgIHZhciBjb25maWcgPSB0aGlzLnJlcXVlc3Quc2VydmljZS5wYWdpbmF0aW9uQ29uZmlnKHRoaXMucmVxdWVzdC5vcGVyYXRpb24pOwogICAgaWYgKCFjb25maWcpIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwoKICAgIHRoaXMubmV4dFBhZ2VUb2tlbnMgPSBudWxsOwogICAgaWYgKGNvbmZpZy5tb3JlUmVzdWx0cykgewogICAgICBpZiAoIWptZXNwYXRoLnNlYXJjaCh0aGlzLmRhdGEsIGNvbmZpZy5tb3JlUmVzdWx0cykpIHsKICAgICAgICByZXR1cm4gdGhpcy5uZXh0UGFnZVRva2VuczsKICAgICAgfQogICAgfQoKICAgIHZhciBleHBycyA9IGNvbmZpZy5vdXRwdXRUb2tlbjsKICAgIGlmICh0eXBlb2YgZXhwcnMgPT09ICdzdHJpbmcnKSBleHBycyA9IFtleHByc107CiAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBleHBycywgZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgdmFyIG91dHB1dCA9IGptZXNwYXRoLnNlYXJjaCh0aGlzLmRhdGEsIGV4cHIpOwogICAgICBpZiAob3V0cHV0KSB7CiAgICAgICAgdGhpcy5uZXh0UGFnZVRva2VucyA9IHRoaXMubmV4dFBhZ2VUb2tlbnMgfHwgW107CiAgICAgICAgdGhpcy5uZXh0UGFnZVRva2Vucy5wdXNoKG91dHB1dCk7CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiB0aGlzLm5leHRQYWdlVG9rZW5zOwogIH0KCn0pOwoKfSx7Ii4vY29yZSI6MTksImptZXNwYXRoIjo4OH1dLDYwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4vY29yZScpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKiBAIW1ldGhvZCBvbihldmVudE5hbWUsIGNhbGxiYWNrKQogKiAgIFJlZ2lzdGVycyBhbiBldmVudCBsaXN0ZW5lciBjYWxsYmFjayBmb3IgdGhlIGV2ZW50IGdpdmVuIGJ5IGBldmVudE5hbWVgLgogKiAgIFBhcmFtZXRlcnMgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBkZXBlbmQgb24gdGhlIGluZGl2aWR1YWwgZXZlbnQKICogICBiZWluZyB0cmlnZ2VyZWQuIFNlZSB0aGUgZXZlbnQgZG9jdW1lbnRhdGlvbiBmb3IgdGhvc2UgcGFyYW1ldGVycy4KICoKICogICBAcGFyYW0gZXZlbnROYW1lIFtTdHJpbmddIHRoZSBldmVudCBuYW1lIHRvIHJlZ2lzdGVyIHRoZSBsaXN0ZW5lciBmb3IKICogICBAcGFyYW0gY2FsbGJhY2sgW0Z1bmN0aW9uXSB0aGUgbGlzdGVuZXIgY2FsbGJhY2sgZnVuY3Rpb24KICogICBAcGFyYW0gdG9IZWFkIFtCb29sZWFuXSBhdHRhY2ggdGhlIGxpc3RlbmVyIGNhbGxiYWNrIHRvIHRoZSBoZWFkIG9mIGNhbGxiYWNrIGFycmF5IGlmIHNldCB0byB0cnVlLgogKiAgICAgRGVmYXVsdCB0byBiZSBmYWxzZS4KICogICBAcmV0dXJuIFtBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXSB0aGUgc2FtZSBvYmplY3QgZm9yIGNoYWluaW5nCiAqLwpBV1MuU2VxdWVudGlhbEV4ZWN1dG9yID0gQVdTLnV0aWwuaW5oZXJpdCh7CgogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBTZXF1ZW50aWFsRXhlY3V0b3IoKSB7CiAgICB0aGlzLl9ldmVudHMgPSB7fTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsaXN0ZW5lcnM6IGZ1bmN0aW9uIGxpc3RlbmVycyhldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLl9ldmVudHNbZXZlbnROYW1lXSA/IHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnNsaWNlKDApIDogW107CiAgfSwKCiAgb246IGZ1bmN0aW9uIG9uKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCkgewogICAgaWYgKHRoaXMuX2V2ZW50c1tldmVudE5hbWVdKSB7CiAgICAgIHRvSGVhZCA/CiAgICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0udW5zaGlmdChsaXN0ZW5lcikgOgogICAgICAgIHRoaXMuX2V2ZW50c1tldmVudE5hbWVdLnB1c2gobGlzdGVuZXIpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fZXZlbnRzW2V2ZW50TmFtZV0gPSBbbGlzdGVuZXJdOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgb25Bc3luYzogZnVuY3Rpb24gb25Bc3luYyhldmVudE5hbWUsIGxpc3RlbmVyLCB0b0hlYWQpIHsKICAgIGxpc3RlbmVyLl9pc0FzeW5jID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzLm9uKGV2ZW50TmFtZSwgbGlzdGVuZXIsIHRvSGVhZCk7CiAgfSwKCiAgcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKGV2ZW50TmFtZSwgbGlzdGVuZXIpIHsKICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgdmFyIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICAgIHZhciBwb3NpdGlvbiA9IC0xOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKGxpc3RlbmVyc1tpXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHBvc2l0aW9uID4gLTEpIHsKICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgcmVtb3ZlQWxsTGlzdGVuZXJzOiBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnROYW1lKSB7CiAgICBpZiAoZXZlbnROYW1lKSB7CiAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbZXZlbnROYW1lXTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZW1pdDogZnVuY3Rpb24gZW1pdChldmVudE5hbWUsIGV2ZW50QXJncywgZG9uZUNhbGxiYWNrKSB7CiAgICBpZiAoIWRvbmVDYWxsYmFjaykgZG9uZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7IH07CiAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5saXN0ZW5lcnMoZXZlbnROYW1lKTsKICAgIHZhciBjb3VudCA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICB0aGlzLmNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBldmVudEFyZ3MsIGRvbmVDYWxsYmFjayk7CiAgICByZXR1cm4gY291bnQgPiAwOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNhbGxMaXN0ZW5lcnM6IGZ1bmN0aW9uIGNhbGxMaXN0ZW5lcnMobGlzdGVuZXJzLCBhcmdzLCBkb25lQ2FsbGJhY2ssIHByZXZFcnJvcikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGVycm9yID0gcHJldkVycm9yIHx8IG51bGw7CgogICAgZnVuY3Rpb24gY2FsbE5leHRMaXN0ZW5lcihlcnIpIHsKICAgICAgaWYgKGVycikgewogICAgICAgIGVycm9yID0gQVdTLnV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIGVycik7CiAgICAgICAgaWYgKHNlbGYuX2hhbHRIYW5kbGVyc09uRXJyb3IpIHsKICAgICAgICAgIHJldHVybiBkb25lQ2FsbGJhY2suY2FsbChzZWxmLCBlcnJvcik7CiAgICAgICAgfQogICAgICB9CiAgICAgIHNlbGYuY2FsbExpc3RlbmVycyhsaXN0ZW5lcnMsIGFyZ3MsIGRvbmVDYWxsYmFjaywgZXJyb3IpOwogICAgfQoKICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICB2YXIgbGlzdGVuZXIgPSBsaXN0ZW5lcnMuc2hpZnQoKTsKICAgICAgaWYgKGxpc3RlbmVyLl9pc0FzeW5jKSB7IC8vIGFzeW5jaHJvbm91cyBsaXN0ZW5lcgogICAgICAgIGxpc3RlbmVyLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KFtjYWxsTmV4dExpc3RlbmVyXSkpOwogICAgICAgIHJldHVybjsgLy8gc3RvcCBoZXJlLCBjYWxsTmV4dExpc3RlbmVyIHdpbGwgY29udGludWUKICAgICAgfSBlbHNlIHsgLy8gc3luY2hyb25vdXMgbGlzdGVuZXIKICAgICAgICB0cnkgewogICAgICAgICAgbGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICBlcnJvciA9IEFXUy51dGlsLmVycm9yKGVycm9yIHx8IG5ldyBFcnJvcigpLCBlcnIpOwogICAgICAgIH0KICAgICAgICBpZiAoZXJyb3IgJiYgc2VsZi5faGFsdEhhbmRsZXJzT25FcnJvcikgewogICAgICAgICAgZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZG9uZUNhbGxiYWNrLmNhbGwoc2VsZiwgZXJyb3IpOwogIH0sCgogIC8qKgogICAqIEFkZHMgb3IgY29waWVzIGEgc2V0IG9mIGxpc3RlbmVycyBmcm9tIGFub3RoZXIgbGlzdCBvZgogICAqIGxpc3RlbmVycyBvciBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0LgogICAqCiAgICogQHBhcmFtIGxpc3RlbmVycyBbbWFwPFN0cmluZyxBcnJheTxGdW5jdGlvbj4+LCBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yXQogICAqICAgYSBsaXN0IG9mIGV2ZW50cyBhbmQgY2FsbGJhY2tzLCBvciBhbiBldmVudCBlbWl0dGVyIG9iamVjdAogICAqICAgY29udGFpbmluZyBsaXN0ZW5lcnMgdG8gYWRkIHRvIHRoaXMgZW1pdHRlciBvYmplY3QuCiAgICogQHJldHVybiBbQVdTLlNlcXVlbnRpYWxFeGVjdXRvcl0gdGhlIGVtaXR0ZXIgb2JqZWN0LCBmb3IgY2hhaW5pbmcuCiAgICogQGV4YW1wbGUgQWRkaW5nIGxpc3RlbmVycyBmcm9tIGEgbWFwIG9mIGxpc3RlbmVycwogICAqICAgZW1pdHRlci5hZGRMaXN0ZW5lcnMoewogICAqICAgICBldmVudDE6IFtmdW5jdGlvbigpIHsgLi4uIH0sIGZ1bmN0aW9uKCkgeyAuLi4gfV0sCiAgICogICAgIGV2ZW50MjogW2Z1bmN0aW9uKCkgeyAuLi4gfV0KICAgKiAgIH0pOwogICAqICAgZW1pdHRlci5lbWl0KCdldmVudDEnKTsgLy8gZW1pdHRlciBoYXMgZXZlbnQxCiAgICogICBlbWl0dGVyLmVtaXQoJ2V2ZW50MicpOyAvLyBlbWl0dGVyIGhhcyBldmVudDIKICAgKiBAZXhhbXBsZSBBZGRpbmcgbGlzdGVuZXJzIGZyb20gYW5vdGhlciBlbWl0dGVyIG9iamVjdAogICAqICAgdmFyIGVtaXR0ZXIxID0gbmV3IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IoKTsKICAgKiAgIGVtaXR0ZXIxLm9uKCdldmVudDEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAqICAgZW1pdHRlcjEub24oJ2V2ZW50MicsIGZ1bmN0aW9uKCkgeyAuLi4gfSk7CiAgICogICB2YXIgZW1pdHRlcjIgPSBuZXcgQVdTLlNlcXVlbnRpYWxFeGVjdXRvcigpOwogICAqICAgZW1pdHRlcjIuYWRkTGlzdGVuZXJzKGVtaXR0ZXIxKTsKICAgKiAgIGVtaXR0ZXIyLmVtaXQoJ2V2ZW50MScpOyAvLyBlbWl0dGVyMiBoYXMgZXZlbnQxCiAgICogICBlbWl0dGVyMi5lbWl0KCdldmVudDInKTsgLy8gZW1pdHRlcjIgaGFzIGV2ZW50MgogICAqLwogIGFkZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTGlzdGVuZXJzKGxpc3RlbmVycykgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIC8vIGV4dHJhY3QgbGlzdGVuZXJzIGlmIHBhcmFtZXRlciBpcyBhbiBTZXF1ZW50aWFsRXhlY3V0b3Igb2JqZWN0CiAgICBpZiAobGlzdGVuZXJzLl9ldmVudHMpIGxpc3RlbmVycyA9IGxpc3RlbmVycy5fZXZlbnRzOwoKICAgIEFXUy51dGlsLmVhY2gobGlzdGVuZXJzLCBmdW5jdGlvbihldmVudCwgY2FsbGJhY2tzKSB7CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2tzID09PSAnZnVuY3Rpb24nKSBjYWxsYmFja3MgPSBbY2FsbGJhY2tzXTsKICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKGNhbGxiYWNrcywgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICBzZWxmLm9uKGV2ZW50LCBjYWxsYmFjayk7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHNlbGY7CiAgfSwKCiAgLyoqCiAgICogUmVnaXN0ZXJzIGFuIGV2ZW50IHdpdGgge29ufSBhbmQgc2F2ZXMgdGhlIGNhbGxiYWNrIGhhbmRsZSBmdW5jdGlvbgogICAqIGFzIGEgcHJvcGVydHkgb24gdGhlIGVtaXR0ZXIgb2JqZWN0IHVzaW5nIGEgZ2l2ZW4gYG5hbWVgLgogICAqCiAgICogQHBhcmFtIG5hbWUgW1N0cmluZ10gdGhlIHByb3BlcnR5IG5hbWUgdG8gc2V0IG9uIHRoaXMgb2JqZWN0IGNvbnRhaW5pbmcKICAgKiAgIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBoYW5kbGUgc28gdGhhdCB0aGUgbGlzdGVuZXIgY2FuIGJlIHJlbW92ZWQgaW4KICAgKiAgIHRoZSBmdXR1cmUuCiAgICogQHBhcmFtIChzZWUgb24pCiAgICogQHJldHVybiAoc2VlIG9uKQogICAqIEBleGFtcGxlIEFkZGluZyBhIG5hbWVkIGxpc3RlbmVyIERBVEFfQ0FMTEJBQ0sKICAgKiAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKCkgeyBkb1NvbWV0aGluZygpOyB9OwogICAqICAgZW1pdHRlci5hZGROYW1lZExpc3RlbmVyKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBsaXN0ZW5lcik7CiAgICoKICAgKiAgIC8vIHRoZSBmb2xsb3dpbmcgcHJpbnRzOiB0cnVlCiAgICogICBjb25zb2xlLmxvZyhlbWl0dGVyLkRBVEFfQ0FMTEJBQ0sgPT0gbGlzdGVuZXIpOwogICAqLwogIGFkZE5hbWVkTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKSB7CiAgICB0aGlzW25hbWVdID0gY2FsbGJhY2s7CiAgICB0aGlzLmFkZExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2ssIHRvSGVhZCk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhZGROYW1lZEFzeW5jTGlzdGVuZXI6IGZ1bmN0aW9uIGFkZE5hbWVkQXN5bmNMaXN0ZW5lcihuYW1lLCBldmVudE5hbWUsIGNhbGxiYWNrLCB0b0hlYWQpIHsKICAgIGNhbGxiYWNrLl9pc0FzeW5jID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzLmFkZE5hbWVkTGlzdGVuZXIobmFtZSwgZXZlbnROYW1lLCBjYWxsYmFjaywgdG9IZWFkKTsKICB9LAoKICAvKioKICAgKiBIZWxwZXIgbWV0aG9kIHRvIGFkZCBhIHNldCBvZiBuYW1lZCBsaXN0ZW5lcnMgdXNpbmcKICAgKiB7YWRkTmFtZWRMaXN0ZW5lcn0uIFRoZSBjYWxsYmFjayBjb250YWlucyBhIHBhcmFtZXRlcgogICAqIHdpdGggYSBoYW5kbGUgdG8gdGhlIGBhZGROYW1lZExpc3RlbmVyYCBtZXRob2QuCiAgICoKICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oYWRkKQogICAqICAgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGlzIGNhbGxlZCBpbW1lZGlhdGVseSBpbiBvcmRlciB0byBwcm92aWRlCiAgICogICB0aGUgYGFkZGAgZnVuY3Rpb24gdG8gdGhlIGJsb2NrLiBUaGlzIHNpbXBsaWZpZXMgdGhlIGFkZGl0aW9uIG9mCiAgICogICBhIGxhcmdlIGdyb3VwIG9mIG5hbWVkIGxpc3RlbmVycy4KICAgKiAgIEBwYXJhbSBhZGQgW0Z1bmN0aW9uXSB0aGUge2FkZE5hbWVkTGlzdGVuZXJ9IGZ1bmN0aW9uIHRvIGNhbGwKICAgKiAgICAgd2hlbiByZWdpc3RlcmluZyBsaXN0ZW5lcnMuCiAgICogQGV4YW1wbGUgQWRkaW5nIGEgc2V0IG9mIG5hbWVkIGxpc3RlbmVycwogICAqICAgZW1pdHRlci5hZGROYW1lZExpc3RlbmVycyhmdW5jdGlvbihhZGQpIHsKICAgKiAgICAgYWRkKCdEQVRBX0NBTExCQUNLJywgJ2RhdGEnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAqICAgICBhZGQoJ09USEVSJywgJ290aGVyRXZlbnQnLCBmdW5jdGlvbigpIHsgLi4uIH0pOwogICAqICAgICBhZGQoJ0xBU1QnLCAnbGFzdEV2ZW50JywgZnVuY3Rpb24oKSB7IC4uLiB9KTsKICAgKiAgIH0pOwogICAqCiAgICogICAvLyB0aGVzZSBwcm9wZXJ0aWVzIGFyZSBub3cgc2V0OgogICAqICAgZW1pdHRlci5EQVRBX0NBTExCQUNLOwogICAqICAgZW1pdHRlci5PVEhFUjsKICAgKiAgIGVtaXR0ZXIuTEFTVDsKICAgKi8KICBhZGROYW1lZExpc3RlbmVyczogZnVuY3Rpb24gYWRkTmFtZWRMaXN0ZW5lcnMoY2FsbGJhY2spIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNhbGxiYWNrKAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLmFkZE5hbWVkTGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgfSwKICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5hZGROYW1lZEFzeW5jTGlzdGVuZXIuYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgfQogICAgKTsKICAgIHJldHVybiB0aGlzOwogIH0KfSk7CgovKioKICoge29ufSBpcyB0aGUgcHJlZmVyZWQgbWV0aG9kLgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TZXF1ZW50aWFsRXhlY3V0b3IucHJvdG90eXBlLmFkZExpc3RlbmVyID0gQVdTLlNlcXVlbnRpYWxFeGVjdXRvci5wcm90b3R5cGUub247CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IEFXUy5TZXF1ZW50aWFsRXhlY3V0b3I7Cgp9LHsiLi9jb3JlIjoxOX1dLDYxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsoZnVuY3Rpb24gKCl7CnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKdmFyIEFwaSA9IHJlcXVpcmUoJy4vbW9kZWwvYXBpJyk7CnZhciByZWdpb25Db25maWcgPSByZXF1aXJlKCcuL3JlZ2lvbl9jb25maWcnKTsKCnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKdmFyIGNsaWVudENvdW50ID0gMDsKdmFyIHJlZ2lvbl91dGlscyA9IHJlcXVpcmUoJy4vcmVnaW9uL3V0aWxzJyk7CgovKioKICogVGhlIHNlcnZpY2UgY2xhc3MgcmVwcmVzZW50aW5nIGFuIEFXUyBzZXJ2aWNlLgogKgogKiBAY2xhc3NfYWJzdHJhY3QgVGhpcyBjbGFzcyBpcyBhbiBhYnN0cmFjdCBjbGFzcy4KICoKICogQCFhdHRyaWJ1dGUgYXBpVmVyc2lvbnMKICogICBAcmV0dXJuIFtBcnJheTxTdHJpbmc+XSB0aGUgbGlzdCBvZiBBUEkgdmVyc2lvbnMgc3VwcG9ydGVkIGJ5IHRoaXMgc2VydmljZS4KICogICBAcmVhZG9ubHkKICovCkFXUy5TZXJ2aWNlID0gaW5oZXJpdCh7CiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IHNlcnZpY2Ugb2JqZWN0IHdpdGggYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAqCiAgICogQHBhcmFtIGNvbmZpZyBbbWFwXSBhIG1hcCBvZiBjb25maWd1cmF0aW9uIG9wdGlvbnMKICAgKi8KICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24gU2VydmljZShjb25maWcpIHsKICAgIGlmICghdGhpcy5sb2FkU2VydmljZUNsYXNzKSB7CiAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKG5ldyBFcnJvcigpLAogICAgICAgICdTZXJ2aWNlIG11c3QgYmUgY29uc3RydWN0ZWQgd2l0aCBgbmV3XCcgb3BlcmF0b3InKTsKICAgIH0KCiAgICBpZiAoY29uZmlnKSB7CiAgICAgIGlmIChjb25maWcucmVnaW9uKSB7CiAgICAgICAgdmFyIHJlZ2lvbiA9IGNvbmZpZy5yZWdpb247CiAgICAgICAgaWYgKHJlZ2lvbl91dGlscy5pc0ZpcHNSZWdpb24ocmVnaW9uKSkgewogICAgICAgICAgY29uZmlnLnJlZ2lvbiA9IHJlZ2lvbl91dGlscy5nZXRSZWFsUmVnaW9uKHJlZ2lvbik7CiAgICAgICAgICBjb25maWcudXNlRmlwc0VuZHBvaW50ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHJlZ2lvbl91dGlscy5pc0dsb2JhbFJlZ2lvbihyZWdpb24pKSB7CiAgICAgICAgICBjb25maWcucmVnaW9uID0gcmVnaW9uX3V0aWxzLmdldFJlYWxSZWdpb24ocmVnaW9uKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBjb25maWcudXNlRHVhbHN0YWNrID09PSAnYm9vbGVhbicKICAgICAgICAmJiB0eXBlb2YgY29uZmlnLnVzZUR1YWxzdGFja0VuZHBvaW50ICE9PSAnYm9vbGVhbicpIHsKICAgICAgICBjb25maWcudXNlRHVhbHN0YWNrRW5kcG9pbnQgPSBjb25maWcudXNlRHVhbHN0YWNrOwogICAgICB9CiAgICB9CgogICAgdmFyIFNlcnZpY2VDbGFzcyA9IHRoaXMubG9hZFNlcnZpY2VDbGFzcyhjb25maWcgfHwge30pOwogICAgaWYgKFNlcnZpY2VDbGFzcykgewogICAgICB2YXIgb3JpZ2luYWxDb25maWcgPSBBV1MudXRpbC5jb3B5KGNvbmZpZyk7CiAgICAgIHZhciBzdmMgPSBuZXcgU2VydmljZUNsYXNzKGNvbmZpZyk7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzdmMsICdfb3JpZ2luYWxDb25maWcnLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG9yaWdpbmFsQ29uZmlnOyB9LAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9KTsKICAgICAgc3ZjLl9jbGllbnRJZCA9ICsrY2xpZW50Q291bnQ7CiAgICAgIHJldHVybiBzdmM7CiAgICB9CiAgICB0aGlzLmluaXRpYWxpemUoY29uZmlnKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKGNvbmZpZykgewogICAgdmFyIHN2Y0NvbmZpZyA9IEFXUy5jb25maWdbdGhpcy5zZXJ2aWNlSWRlbnRpZmllcl07CiAgICB0aGlzLmNvbmZpZyA9IG5ldyBBV1MuQ29uZmlnKEFXUy5jb25maWcpOwogICAgaWYgKHN2Y0NvbmZpZykgdGhpcy5jb25maWcudXBkYXRlKHN2Y0NvbmZpZywgdHJ1ZSk7CiAgICBpZiAoY29uZmlnKSB0aGlzLmNvbmZpZy51cGRhdGUoY29uZmlnLCB0cnVlKTsKCiAgICB0aGlzLnZhbGlkYXRlU2VydmljZSgpOwogICAgaWYgKCF0aGlzLmNvbmZpZy5lbmRwb2ludCkgcmVnaW9uQ29uZmlnLmNvbmZpZ3VyZUVuZHBvaW50KHRoaXMpOwoKICAgIHRoaXMuY29uZmlnLmVuZHBvaW50ID0gdGhpcy5lbmRwb2ludEZyb21UZW1wbGF0ZSh0aGlzLmNvbmZpZy5lbmRwb2ludCk7CiAgICB0aGlzLnNldEVuZHBvaW50KHRoaXMuY29uZmlnLmVuZHBvaW50KTsKICAgIC8vZW5hYmxlIGF0dGFjaGluZyBsaXN0ZW5lcnMgdG8gc2VydmljZSBjbGllbnQKICAgIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IuY2FsbCh0aGlzKTsKICAgIEFXUy5TZXJ2aWNlLmFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKHRoaXMpOwogICAgaWYgKCh0aGlzLmNvbmZpZy5jbGllbnRTaWRlTW9uaXRvcmluZyB8fCBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcpICYmIHRoaXMucHVibGlzaGVyKSB7CiAgICAgIHZhciBwdWJsaXNoZXIgPSB0aGlzLnB1Ymxpc2hlcjsKICAgICAgdGhpcy5hZGROYW1lZExpc3RlbmVyKCdQVUJMSVNIX0FQSV9DQUxMJywgJ2FwaUNhbGwnLCBmdW5jdGlvbiBQVUJMSVNIX0FQSV9DQUxMKGV2ZW50KSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHtwdWJsaXNoZXIuZXZlbnRIYW5kbGVyKGV2ZW50KTt9KTsKICAgICAgfSk7CiAgICAgIHRoaXMuYWRkTmFtZWRMaXN0ZW5lcignUFVCTElTSF9BUElfQVRURU1QVCcsICdhcGlDYWxsQXR0ZW1wdCcsIGZ1bmN0aW9uIFBVQkxJU0hfQVBJX0FUVEVNUFQoZXZlbnQpIHsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkge3B1Ymxpc2hlci5ldmVudEhhbmRsZXIoZXZlbnQpO30pOwogICAgICB9KTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB2YWxpZGF0ZVNlcnZpY2U6IGZ1bmN0aW9uIHZhbGlkYXRlU2VydmljZSgpIHsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBsb2FkU2VydmljZUNsYXNzOiBmdW5jdGlvbiBsb2FkU2VydmljZUNsYXNzKHNlcnZpY2VDb25maWcpIHsKICAgIHZhciBjb25maWcgPSBzZXJ2aWNlQ29uZmlnOwogICAgaWYgKCFBV1MudXRpbC5pc0VtcHR5KHRoaXMuYXBpKSkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSBpZiAoY29uZmlnLmFwaUNvbmZpZykgewogICAgICByZXR1cm4gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZUFwaSh0aGlzLmNvbnN0cnVjdG9yLCBjb25maWcuYXBpQ29uZmlnKTsKICAgIH0gZWxzZSBpZiAoIXRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9IGVsc2UgewogICAgICBjb25maWcgPSBuZXcgQVdTLkNvbmZpZyhBV1MuY29uZmlnKTsKICAgICAgY29uZmlnLnVwZGF0ZShzZXJ2aWNlQ29uZmlnLCB0cnVlKTsKICAgICAgdmFyIHZlcnNpb24gPSBjb25maWcuYXBpVmVyc2lvbnNbdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlSWRlbnRpZmllcl07CiAgICAgIHZlcnNpb24gPSB2ZXJzaW9uIHx8IGNvbmZpZy5hcGlWZXJzaW9uOwogICAgICByZXR1cm4gdGhpcy5nZXRMYXRlc3RTZXJ2aWNlQ2xhc3ModmVyc2lvbik7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZ2V0TGF0ZXN0U2VydmljZUNsYXNzOiBmdW5jdGlvbiBnZXRMYXRlc3RTZXJ2aWNlQ2xhc3ModmVyc2lvbikgewogICAgdmVyc2lvbiA9IHRoaXMuZ2V0TGF0ZXN0U2VydmljZVZlcnNpb24odmVyc2lvbik7CiAgICBpZiAodGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlc1t2ZXJzaW9uXSA9PT0gbnVsbCkgewogICAgICBBV1MuU2VydmljZS5kZWZpbmVTZXJ2aWNlQXBpKHRoaXMuY29uc3RydWN0b3IsIHZlcnNpb24pOwogICAgfQoKICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VzW3ZlcnNpb25dOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldExhdGVzdFNlcnZpY2VWZXJzaW9uOiBmdW5jdGlvbiBnZXRMYXRlc3RTZXJ2aWNlVmVyc2lvbih2ZXJzaW9uKSB7CiAgICBpZiAoIXRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMgfHwgdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcy5sZW5ndGggPT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzZXJ2aWNlcyBkZWZpbmVkIG9uICcgKwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlSWRlbnRpZmllcik7CiAgICB9CgogICAgaWYgKCF2ZXJzaW9uKSB7CiAgICAgIHZlcnNpb24gPSAnbGF0ZXN0JzsKICAgIH0gZWxzZSBpZiAoQVdTLnV0aWwuaXNUeXBlKHZlcnNpb24sIERhdGUpKSB7CiAgICAgIHZlcnNpb24gPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEodmVyc2lvbikuc3BsaXQoJ1QnKVswXTsKICAgIH0KCiAgICBpZiAoT2JqZWN0Lmhhc093blByb3BlcnR5KHRoaXMuY29uc3RydWN0b3Iuc2VydmljZXMsIHZlcnNpb24pKSB7CiAgICAgIHJldHVybiB2ZXJzaW9uOwogICAgfQoKICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5jb25zdHJ1Y3Rvci5zZXJ2aWNlcykuc29ydCgpOwogICAgdmFyIHNlbGVjdGVkVmVyc2lvbiA9IG51bGw7CiAgICBmb3IgKHZhciBpID0ga2V5cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAvLyB2ZXJzaW9ucyB0aGF0IGVuZCBpbiAiKiIgYXJlIG5vdCBhdmFpbGFibGUgb24gZGlzayBhbmQgY2FuIGJlCiAgICAgIC8vIHNraXBwZWQsIHNvIGRvIG5vdCBjaG9vc2UgdGhlc2UgYXMgc2VsZWN0ZWRWZXJzaW9ucwogICAgICBpZiAoa2V5c1tpXVtrZXlzW2ldLmxlbmd0aCAtIDFdICE9PSAnKicpIHsKICAgICAgICBzZWxlY3RlZFZlcnNpb24gPSBrZXlzW2ldOwogICAgICB9CiAgICAgIGlmIChrZXlzW2ldLnN1YnN0cigwLCAxMCkgPD0gdmVyc2lvbikgewogICAgICAgIHJldHVybiBzZWxlY3RlZFZlcnNpb247CiAgICAgIH0KICAgIH0KCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kICcgKyB0aGlzLmNvbnN0cnVjdG9yLnNlcnZpY2VJZGVudGlmaWVyICsKICAgICAgICAgICAgICAgICAgICAnIEFQSSB0byBzYXRpc2Z5IHZlcnNpb24gY29uc3RyYWludCBgJyArIHZlcnNpb24gKyAnXCcnKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhcGk6IHt9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBkZWZhdWx0UmV0cnlDb3VudDogMywKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY3VzdG9taXplUmVxdWVzdHM6IGZ1bmN0aW9uIGN1c3RvbWl6ZVJlcXVlc3RzKGNhbGxiYWNrKSB7CiAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgIHRoaXMuY3VzdG9tUmVxdWVzdEhhbmRsZXIgPSBudWxsOwogICAgfSBlbHNlIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9IGNhbGxiYWNrOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNhbGxiYWNrIHR5cGUgXCcnICsgdHlwZW9mIGNhbGxiYWNrICsgJ1wnIHByb3ZpZGVkIGluIGN1c3RvbWl6ZVJlcXVlc3RzJyk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQ2FsbHMgYW4gb3BlcmF0aW9uIG9uIGEgc2VydmljZSB3aXRoIHRoZSBnaXZlbiBpbnB1dCBwYXJhbWV0ZXJzLgogICAqCiAgICogQHBhcmFtIG9wZXJhdGlvbiBbU3RyaW5nXSB0aGUgbmFtZSBvZiB0aGUgb3BlcmF0aW9uIHRvIGNhbGwgb24gdGhlIHNlcnZpY2UuCiAgICogQHBhcmFtIHBhcmFtcyBbbWFwXSBhIG1hcCBvZiBpbnB1dCBvcHRpb25zIGZvciB0aGUgb3BlcmF0aW9uCiAgICogQGNhbGxiYWNrIGNhbGxiYWNrIGZ1bmN0aW9uKGVyciwgZGF0YSkKICAgKiAgIElmIGEgY2FsbGJhY2sgaXMgc3VwcGxpZWQsIGl0IGlzIGNhbGxlZCB3aGVuIGEgcmVzcG9uc2UgaXMgcmV0dXJuZWQKICAgKiAgIGZyb20gdGhlIHNlcnZpY2UuCiAgICogICBAcGFyYW0gZXJyIFtFcnJvcl0gdGhlIGVycm9yIG9iamVjdCByZXR1cm5lZCBmcm9tIHRoZSByZXF1ZXN0LgogICAqICAgICBTZXQgdG8gYG51bGxgIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwuCiAgICogICBAcGFyYW0gZGF0YSBbT2JqZWN0XSB0aGUgZGUtc2VyaWFsaXplZCBkYXRhIHJldHVybmVkIGZyb20KICAgKiAgICAgdGhlIHJlcXVlc3QuIFNldCB0byBgbnVsbGAgaWYgYSByZXF1ZXN0IGVycm9yIG9jY3Vycy4KICAgKi8KICBtYWtlUmVxdWVzdDogZnVuY3Rpb24gbWFrZVJlcXVlc3Qob3BlcmF0aW9uLCBwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgcGFyYW1zID0gbnVsbDsKICAgIH0KCiAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICBpZiAodGhpcy5jb25maWcucGFyYW1zKSB7IC8vIGNvcHkgb25seSB0b3BsZXZlbCBib3VuZCBwYXJhbXMKICAgICAgdmFyIHJ1bGVzID0gdGhpcy5hcGkub3BlcmF0aW9uc1tvcGVyYXRpb25dOwogICAgICBpZiAocnVsZXMpIHsKICAgICAgICBwYXJhbXMgPSBBV1MudXRpbC5jb3B5KHBhcmFtcyk7CiAgICAgICAgQVdTLnV0aWwuZWFjaCh0aGlzLmNvbmZpZy5wYXJhbXMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgIGlmIChydWxlcy5pbnB1dC5tZW1iZXJzW2tleV0pIHsKICAgICAgICAgICAgaWYgKHBhcmFtc1trZXldID09PSB1bmRlZmluZWQgfHwgcGFyYW1zW2tleV0gPT09IG51bGwpIHsKICAgICAgICAgICAgICBwYXJhbXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgcmVxdWVzdCA9IG5ldyBBV1MuUmVxdWVzdCh0aGlzLCBvcGVyYXRpb24sIHBhcmFtcyk7CiAgICB0aGlzLmFkZEFsbFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCk7CiAgICB0aGlzLmF0dGFjaE1vbml0b3JpbmdFbWl0dGVyKHJlcXVlc3QpOwogICAgaWYgKGNhbGxiYWNrKSByZXF1ZXN0LnNlbmQoY2FsbGJhY2spOwogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfSwKCiAgLyoqCiAgICogQ2FsbHMgYW4gb3BlcmF0aW9uIG9uIGEgc2VydmljZSB3aXRoIHRoZSBnaXZlbiBpbnB1dCBwYXJhbWV0ZXJzLCB3aXRob3V0CiAgICogYW55IGF1dGhlbnRpY2F0aW9uIGRhdGEuIFRoaXMgbWV0aG9kIGlzIHVzZWZ1bCBmb3IgInB1YmxpYyIgQVBJIG9wZXJhdGlvbnMuCiAgICoKICAgKiBAcGFyYW0gb3BlcmF0aW9uIFtTdHJpbmddIHRoZSBuYW1lIG9mIHRoZSBvcGVyYXRpb24gdG8gY2FsbCBvbiB0aGUgc2VydmljZS4KICAgKiBAcGFyYW0gcGFyYW1zIFttYXBdIGEgbWFwIG9mIGlucHV0IG9wdGlvbnMgZm9yIHRoZSBvcGVyYXRpb24KICAgKiBAY2FsbGJhY2sgY2FsbGJhY2sgZnVuY3Rpb24oZXJyLCBkYXRhKQogICAqICAgSWYgYSBjYWxsYmFjayBpcyBzdXBwbGllZCwgaXQgaXMgY2FsbGVkIHdoZW4gYSByZXNwb25zZSBpcyByZXR1cm5lZAogICAqICAgZnJvbSB0aGUgc2VydmljZS4KICAgKiAgIEBwYXJhbSBlcnIgW0Vycm9yXSB0aGUgZXJyb3Igb2JqZWN0IHJldHVybmVkIGZyb20gdGhlIHJlcXVlc3QuCiAgICogICAgIFNldCB0byBgbnVsbGAgaWYgdGhlIHJlcXVlc3QgaXMgc3VjY2Vzc2Z1bC4KICAgKiAgIEBwYXJhbSBkYXRhIFtPYmplY3RdIHRoZSBkZS1zZXJpYWxpemVkIGRhdGEgcmV0dXJuZWQgZnJvbQogICAqICAgICB0aGUgcmVxdWVzdC4gU2V0IHRvIGBudWxsYCBpZiBhIHJlcXVlc3QgZXJyb3Igb2NjdXJzLgogICAqLwogIG1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0OiBmdW5jdGlvbiBtYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdChvcGVyYXRpb24sIHBhcmFtcywgY2FsbGJhY2spIHsKICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICBwYXJhbXMgPSB7fTsKICAgIH0KCiAgICB2YXIgcmVxdWVzdCA9IHRoaXMubWFrZVJlcXVlc3Qob3BlcmF0aW9uLCBwYXJhbXMpLnRvVW5hdXRoZW50aWNhdGVkKCk7CiAgICByZXR1cm4gY2FsbGJhY2sgPyByZXF1ZXN0LnNlbmQoY2FsbGJhY2spIDogcmVxdWVzdDsKICB9LAoKICAvKioKICAgKiBXYWl0cyBmb3IgYSBnaXZlbiBzdGF0ZQogICAqCiAgICogQHBhcmFtIHN0YXRlIFtTdHJpbmddIHRoZSBzdGF0ZSBvbiB0aGUgc2VydmljZSB0byB3YWl0IGZvcgogICAqIEBwYXJhbSBwYXJhbXMgW21hcF0gYSBtYXAgb2YgcGFyYW1ldGVycyB0byBwYXNzIHdpdGggZWFjaCByZXF1ZXN0CiAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlciBbbWFwXSBhIG1hcCBvZiBjb25maWd1cmF0aW9uIG9wdGlvbnMgZm9yIHRoZSB3YWl0ZXIKICAgKiBAb3B0aW9uIHBhcmFtcyAkd2FpdGVyLmRlbGF5IFtOdW1iZXJdIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyB0byB3YWl0IGJldHdlZW4KICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RzCiAgICogQG9wdGlvbiBwYXJhbXMgJHdhaXRlci5tYXhBdHRlbXB0cyBbTnVtYmVyXSBUaGUgbWF4aW11bSBudW1iZXIgb2YgcmVxdWVzdHMKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHNlbmQgd2hpbGUgd2FpdGluZwogICAqIEBjYWxsYmFjayBjYWxsYmFjayBmdW5jdGlvbihlcnIsIGRhdGEpCiAgICogICBJZiBhIGNhbGxiYWNrIGlzIHN1cHBsaWVkLCBpdCBpcyBjYWxsZWQgd2hlbiBhIHJlc3BvbnNlIGlzIHJldHVybmVkCiAgICogICBmcm9tIHRoZSBzZXJ2aWNlLgogICAqICAgQHBhcmFtIGVyciBbRXJyb3JdIHRoZSBlcnJvciBvYmplY3QgcmV0dXJuZWQgZnJvbSB0aGUgcmVxdWVzdC4KICAgKiAgICAgU2V0IHRvIGBudWxsYCBpZiB0aGUgcmVxdWVzdCBpcyBzdWNjZXNzZnVsLgogICAqICAgQHBhcmFtIGRhdGEgW09iamVjdF0gdGhlIGRlLXNlcmlhbGl6ZWQgZGF0YSByZXR1cm5lZCBmcm9tCiAgICogICAgIHRoZSByZXF1ZXN0LiBTZXQgdG8gYG51bGxgIGlmIGEgcmVxdWVzdCBlcnJvciBvY2N1cnMuCiAgICovCiAgd2FpdEZvcjogZnVuY3Rpb24gd2FpdEZvcihzdGF0ZSwgcGFyYW1zLCBjYWxsYmFjaykgewogICAgdmFyIHdhaXRlciA9IG5ldyBBV1MuUmVzb3VyY2VXYWl0ZXIodGhpcywgc3RhdGUpOwogICAgcmV0dXJuIHdhaXRlci53YWl0KHBhcmFtcywgY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGFkZEFsbFJlcXVlc3RMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZEFsbFJlcXVlc3RMaXN0ZW5lcnMocmVxdWVzdCkgewogICAgdmFyIGxpc3QgPSBbQVdTLmV2ZW50cywgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUsIHRoaXMuc2VydmljZUludGVyZmFjZSgpLAogICAgICAgICAgICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmVQb3N0XTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICBpZiAobGlzdFtpXSkgcmVxdWVzdC5hZGRMaXN0ZW5lcnMobGlzdFtpXSk7CiAgICB9CgogICAgLy8gZGlzYWJsZSBwYXJhbWV0ZXIgdmFsaWRhdGlvbgogICAgaWYgKCF0aGlzLmNvbmZpZy5wYXJhbVZhbGlkYXRpb24pIHsKICAgICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcigndmFsaWRhdGUnLAogICAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlZBTElEQVRFX1BBUkFNRVRFUlMpOwogICAgfQoKICAgIGlmICh0aGlzLmNvbmZpZy5sb2dnZXIpIHsgLy8gYWRkIGxvZ2dpbmcgZXZlbnRzCiAgICAgIHJlcXVlc3QuYWRkTGlzdGVuZXJzKEFXUy5FdmVudExpc3RlbmVycy5Mb2dnZXIpOwogICAgfQoKICAgIHRoaXMuc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpOwogICAgLy8gY2FsbCBwcm90b3R5cGUncyBjdXN0b21SZXF1ZXN0SGFuZGxlcgogICAgaWYgKHR5cGVvZiB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5jdXN0b21SZXF1ZXN0SGFuZGxlcihyZXF1ZXN0KTsKICAgIH0KICAgIC8vIGNhbGwgaW5zdGFuY2UncyBjdXN0b21SZXF1ZXN0SGFuZGxlcgogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCAnY3VzdG9tUmVxdWVzdEhhbmRsZXInKSAmJiB0eXBlb2YgdGhpcy5jdXN0b21SZXF1ZXN0SGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB0aGlzLmN1c3RvbVJlcXVlc3RIYW5kbGVyKHJlcXVlc3QpOwogICAgfQogIH0sCgogIC8qKgogICAqIEV2ZW50IHJlY29yZGluZyBtZXRyaWNzIGZvciBhIHdob2xlIEFQSSBjYWxsLgogICAqIEByZXR1cm5zIHtvYmplY3R9IGEgc3Vic2V0IG9mIGFwaSBjYWxsIG1ldHJpY3MKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhcGlDYWxsRXZlbnQ6IGZ1bmN0aW9uIGFwaUNhbGxFdmVudChyZXF1ZXN0KSB7CiAgICB2YXIgYXBpID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXTsKICAgIHZhciBtb25pdG9yaW5nRXZlbnQgPSB7CiAgICAgIFR5cGU6ICdBcGlDYWxsJywKICAgICAgQXBpOiBhcGkgPyBhcGkubmFtZSA6IHJlcXVlc3Qub3BlcmF0aW9uLAogICAgICBWZXJzaW9uOiAxLAogICAgICBTZXJ2aWNlOiByZXF1ZXN0LnNlcnZpY2UuYXBpLnNlcnZpY2VJZCB8fCByZXF1ZXN0LnNlcnZpY2UuYXBpLmVuZHBvaW50UHJlZml4LAogICAgICBSZWdpb246IHJlcXVlc3QuaHR0cFJlcXVlc3QucmVnaW9uLAogICAgICBNYXhSZXRyaWVzRXhjZWVkZWQ6IDAsCiAgICAgIFVzZXJBZ2VudDogcmVxdWVzdC5odHRwUmVxdWVzdC5nZXRVc2VyQWdlbnQoKSwKICAgIH07CiAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlKSB7CiAgICAgIG1vbml0b3JpbmdFdmVudC5GaW5hbEh0dHBTdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICB9CiAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHsKICAgICAgdmFyIGVycm9yID0gcmVzcG9uc2UuZXJyb3I7CiAgICAgIHZhciBzdGF0dXNDb2RlID0gcmVzcG9uc2UuaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7CiAgICAgIGlmIChzdGF0dXNDb2RlID4gMjk5KSB7CiAgICAgICAgaWYgKGVycm9yLmNvZGUpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgICAgaWYgKGVycm9yLm1lc3NhZ2UpIG1vbml0b3JpbmdFdmVudC5GaW5hbEF3c0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChlcnJvci5jb2RlIHx8IGVycm9yLm5hbWUpIG1vbml0b3JpbmdFdmVudC5GaW5hbFNka0V4Y2VwdGlvbiA9IGVycm9yLmNvZGUgfHwgZXJyb3IubmFtZTsKICAgICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LkZpbmFsU2RrRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBtb25pdG9yaW5nRXZlbnQ7CiAgfSwKCiAgLyoqCiAgICogRXZlbnQgcmVjb3JkaW5nIG1ldHJpY3MgZm9yIGFuIEFQSSBjYWxsIGF0dGVtcHQuCiAgICogQHJldHVybnMge29iamVjdH0gYSBzdWJzZXQgb2YgYXBpIGNhbGwgYXR0ZW1wdCBtZXRyaWNzCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYXBpQXR0ZW1wdEV2ZW50OiBmdW5jdGlvbiBhcGlBdHRlbXB0RXZlbnQocmVxdWVzdCkgewogICAgdmFyIGFwaSA9IHJlcXVlc3Quc2VydmljZS5hcGkub3BlcmF0aW9uc1tyZXF1ZXN0Lm9wZXJhdGlvbl07CiAgICB2YXIgbW9uaXRvcmluZ0V2ZW50ID0gewogICAgICBUeXBlOiAnQXBpQ2FsbEF0dGVtcHQnLAogICAgICBBcGk6IGFwaSA/IGFwaS5uYW1lIDogcmVxdWVzdC5vcGVyYXRpb24sCiAgICAgIFZlcnNpb246IDEsCiAgICAgIFNlcnZpY2U6IHJlcXVlc3Quc2VydmljZS5hcGkuc2VydmljZUlkIHx8IHJlcXVlc3Quc2VydmljZS5hcGkuZW5kcG9pbnRQcmVmaXgsCiAgICAgIEZxZG46IHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQuaG9zdG5hbWUsCiAgICAgIFVzZXJBZ2VudDogcmVxdWVzdC5odHRwUmVxdWVzdC5nZXRVc2VyQWdlbnQoKSwKICAgIH07CiAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlKSB7CiAgICAgIG1vbml0b3JpbmdFdmVudC5IdHRwU3RhdHVzQ29kZSA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlOwogICAgfQogICAgaWYgKAogICAgICAhcmVxdWVzdC5fdW5BdXRoZW50aWNhdGVkICYmCiAgICAgIHJlcXVlc3Quc2VydmljZS5jb25maWcuY3JlZGVudGlhbHMgJiYKICAgICAgcmVxdWVzdC5zZXJ2aWNlLmNvbmZpZy5jcmVkZW50aWFscy5hY2Nlc3NLZXlJZAogICAgKSB7CiAgICAgIG1vbml0b3JpbmdFdmVudC5BY2Nlc3NLZXkgPSByZXF1ZXN0LnNlcnZpY2UuY29uZmlnLmNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwogICAgfQogICAgaWYgKCFyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVycykgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICAgIGlmIChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10pIHsKICAgICAgbW9uaXRvcmluZ0V2ZW50LlNlc3Npb25Ub2tlbiA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXTsKICAgIH0KICAgIGlmIChyZXNwb25zZS5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddKSB7CiAgICAgIG1vbml0b3JpbmdFdmVudC5YQW16blJlcXVlc3RJZCA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtem4tcmVxdWVzdGlkJ107CiAgICB9CiAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LXJlcXVlc3QtaWQnXSkgewogICAgICBtb25pdG9yaW5nRXZlbnQuWEFtelJlcXVlc3RJZCA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ107CiAgICB9CiAgICBpZiAocmVzcG9uc2UuaHR0cFJlc3BvbnNlLmhlYWRlcnNbJ3gtYW16LWlkLTInXSkgewogICAgICBtb25pdG9yaW5nRXZlbnQuWEFteklkMiA9IHJlc3BvbnNlLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1pZC0yJ107CiAgICB9CiAgICByZXR1cm4gbW9uaXRvcmluZ0V2ZW50OwogIH0sCgogIC8qKgogICAqIEFkZCBtZXRyaWNzIG9mIGZhaWxlZCByZXF1ZXN0LgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGF0dGVtcHRGYWlsRXZlbnQ6IGZ1bmN0aW9uIGF0dGVtcHRGYWlsRXZlbnQocmVxdWVzdCkgewogICAgdmFyIG1vbml0b3JpbmdFdmVudCA9IHRoaXMuYXBpQXR0ZW1wdEV2ZW50KHJlcXVlc3QpOwogICAgdmFyIHJlc3BvbnNlID0gcmVxdWVzdC5yZXNwb25zZTsKICAgIHZhciBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgaWYgKHJlc3BvbnNlLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlID4gMjk5ICkgewogICAgICBpZiAoZXJyb3IuY29kZSkgbW9uaXRvcmluZ0V2ZW50LkF3c0V4Y2VwdGlvbiA9IGVycm9yLmNvZGU7CiAgICAgIGlmIChlcnJvci5tZXNzYWdlKSBtb25pdG9yaW5nRXZlbnQuQXdzRXhjZXB0aW9uTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICB9IGVsc2UgewogICAgICBpZiAoZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lKSBtb25pdG9yaW5nRXZlbnQuU2RrRXhjZXB0aW9uID0gZXJyb3IuY29kZSB8fCBlcnJvci5uYW1lOwogICAgICBpZiAoZXJyb3IubWVzc2FnZSkgbW9uaXRvcmluZ0V2ZW50LlNka0V4Y2VwdGlvbk1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgfQogICAgcmV0dXJuIG1vbml0b3JpbmdFdmVudDsKICB9LAoKICAvKioKICAgKiBBdHRhY2ggbGlzdGVuZXJzIHRvIHJlcXVlc3Qgb2JqZWN0IHRvIGZldGNoIG1ldHJpY3Mgb2YgZWFjaCByZXF1ZXN0CiAgICogYW5kIGVtaXQgZGF0YSBvYmplY3QgdGhyb3VnaCBcJ0FwaUNhbGxcJyBhbmQgXCdBcGlDYWxsQXR0ZW1wdFwnIGV2ZW50cy4KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhdHRhY2hNb25pdG9yaW5nRW1pdHRlcjogZnVuY3Rpb24gYXR0YWNoTW9uaXRvcmluZ0VtaXR0ZXIocmVxdWVzdCkgewogICAgdmFyIGF0dGVtcHRUaW1lc3RhbXA7IC8vdGltZXN0YW1wIG1hcmtpbmcgdGhlIGJlZ2lubmluZyBvZiBhIHJlcXVlc3QgYXR0ZW1wdAogICAgdmFyIGF0dGVtcHRTdGFydFJlYWxUaW1lOyAvL1N0YXJ0IHRpbWUgb2YgcmVxdWVzdCBhdHRlbXB0LiBVc2VkIHRvIGNhbGN1bGF0aW5nIGF0dGVtcHRMYXRlbmN5CiAgICB2YXIgYXR0ZW1wdExhdGVuY3k7IC8vbGF0ZW5jeSBmcm9tIHJlcXVlc3Qgc2VudCBvdXQgdG8gaHR0cCByZXNwb25zZSByZWFjaGluZyBTREsKICAgIHZhciBjYWxsU3RhcnRSZWFsVGltZTsgLy9TdGFydCB0aW1lIG9mIEFQSSBjYWxsLiBVc2VkIHRvIGNhbGN1bGF0aW5nIEFQSSBjYWxsIGxhdGVuY3kKICAgIHZhciBhdHRlbXB0Q291bnQgPSAwOyAvL3JlcXVlc3QucmV0cnlDb3VudCBpcyBub3QgcmVsaWFibGUgaGVyZQogICAgdmFyIHJlZ2lvbjsgLy9yZWdpb24gY2FjaGUgcmVnaW9uIGZvciBlYWNoIGF0dGVtcHQgc2luY2UgaXQgY2FuIGJlIHVwZGF0ZWQgaW4gcGxhc2UgKGUuZy4gczMpCiAgICB2YXIgY2FsbFRpbWVzdGFtcDsgLy90aW1lc3RhbXAgd2hlbiB0aGUgcmVxdWVzdCBpcyBjcmVhdGVkCiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgYWRkVG9IZWFkID0gdHJ1ZTsKCiAgICByZXF1ZXN0Lm9uKCd2YWxpZGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgY2FsbFN0YXJ0UmVhbFRpbWUgPSBBV1MudXRpbC5yZWFsQ2xvY2subm93KCk7CiAgICAgIGNhbGxUaW1lc3RhbXAgPSBEYXRlLm5vdygpOwogICAgfSwgYWRkVG9IZWFkKTsKICAgIHJlcXVlc3Qub24oJ3NpZ24nLCBmdW5jdGlvbiAoKSB7CiAgICAgIGF0dGVtcHRTdGFydFJlYWxUaW1lID0gQVdTLnV0aWwucmVhbENsb2NrLm5vdygpOwogICAgICBhdHRlbXB0VGltZXN0YW1wID0gRGF0ZS5ub3coKTsKICAgICAgcmVnaW9uID0gcmVxdWVzdC5odHRwUmVxdWVzdC5yZWdpb247CiAgICAgIGF0dGVtcHRDb3VudCsrOwogICAgfSwgYWRkVG9IZWFkKTsKICAgIHJlcXVlc3Qub24oJ3ZhbGlkYXRlUmVzcG9uc2UnLCBmdW5jdGlvbigpIHsKICAgICAgYXR0ZW1wdExhdGVuY3kgPSBNYXRoLnJvdW5kKEFXUy51dGlsLnJlYWxDbG9jay5ub3coKSAtIGF0dGVtcHRTdGFydFJlYWxUaW1lKTsKICAgIH0pOwogICAgcmVxdWVzdC5hZGROYW1lZExpc3RlbmVyKCdBUElfQ0FMTF9BVFRFTVBUJywgJ3N1Y2Nlc3MnLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUKCkgewogICAgICB2YXIgYXBpQXR0ZW1wdEV2ZW50ID0gc2VsZi5hcGlBdHRlbXB0RXZlbnQocmVxdWVzdCk7CiAgICAgIGFwaUF0dGVtcHRFdmVudC5UaW1lc3RhbXAgPSBhdHRlbXB0VGltZXN0YW1wOwogICAgICBhcGlBdHRlbXB0RXZlbnQuQXR0ZW1wdExhdGVuY3kgPSBhdHRlbXB0TGF0ZW5jeSA+PSAwID8gYXR0ZW1wdExhdGVuY3kgOiAwOwogICAgICBhcGlBdHRlbXB0RXZlbnQuUmVnaW9uID0gcmVnaW9uOwogICAgICBzZWxmLmVtaXQoJ2FwaUNhbGxBdHRlbXB0JywgW2FwaUF0dGVtcHRFdmVudF0pOwogICAgfSk7CiAgICByZXF1ZXN0LmFkZE5hbWVkTGlzdGVuZXIoJ0FQSV9DQUxMX0FUVEVNUFRfUkVUUlknLCAncmV0cnknLCBmdW5jdGlvbiBBUElfQ0FMTF9BVFRFTVBUX1JFVFJZKCkgewogICAgICB2YXIgYXBpQXR0ZW1wdEV2ZW50ID0gc2VsZi5hdHRlbXB0RmFpbEV2ZW50KHJlcXVlc3QpOwogICAgICBhcGlBdHRlbXB0RXZlbnQuVGltZXN0YW1wID0gYXR0ZW1wdFRpbWVzdGFtcDsKICAgICAgLy9hdHRlbXB0TGF0ZW5jeSBtYXkgbm90IGJlIGF2YWlsYWJsZSBpZiBmYWlsIGJlZm9yZSByZXNwb25zZQogICAgICBhdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5IHx8CiAgICAgICAgTWF0aC5yb3VuZChBV1MudXRpbC5yZWFsQ2xvY2subm93KCkgLSBhdHRlbXB0U3RhcnRSZWFsVGltZSk7CiAgICAgIGFwaUF0dGVtcHRFdmVudC5BdHRlbXB0TGF0ZW5jeSA9IGF0dGVtcHRMYXRlbmN5ID49IDAgPyBhdHRlbXB0TGF0ZW5jeSA6IDA7CiAgICAgIGFwaUF0dGVtcHRFdmVudC5SZWdpb24gPSByZWdpb247CiAgICAgIHNlbGYuZW1pdCgnYXBpQ2FsbEF0dGVtcHQnLCBbYXBpQXR0ZW1wdEV2ZW50XSk7CiAgICB9KTsKICAgIHJlcXVlc3QuYWRkTmFtZWRMaXN0ZW5lcignQVBJX0NBTEwnLCAnY29tcGxldGUnLCBmdW5jdGlvbiBBUElfQ0FMTCgpIHsKICAgICAgdmFyIGFwaUNhbGxFdmVudCA9IHNlbGYuYXBpQ2FsbEV2ZW50KHJlcXVlc3QpOwogICAgICBhcGlDYWxsRXZlbnQuQXR0ZW1wdENvdW50ID0gYXR0ZW1wdENvdW50OwogICAgICBpZiAoYXBpQ2FsbEV2ZW50LkF0dGVtcHRDb3VudCA8PSAwKSByZXR1cm47CiAgICAgIGFwaUNhbGxFdmVudC5UaW1lc3RhbXAgPSBjYWxsVGltZXN0YW1wOwogICAgICB2YXIgbGF0ZW5jeSA9IE1hdGgucm91bmQoQVdTLnV0aWwucmVhbENsb2NrLm5vdygpIC0gY2FsbFN0YXJ0UmVhbFRpbWUpOwogICAgICBhcGlDYWxsRXZlbnQuTGF0ZW5jeSA9IGxhdGVuY3kgPj0gMCA/IGxhdGVuY3kgOiAwOwogICAgICB2YXIgcmVzcG9uc2UgPSByZXF1ZXN0LnJlc3BvbnNlOwogICAgICBpZiAoCiAgICAgICAgcmVzcG9uc2UuZXJyb3IgJiYKICAgICAgICByZXNwb25zZS5lcnJvci5yZXRyeWFibGUgJiYKICAgICAgICB0eXBlb2YgcmVzcG9uc2UucmV0cnlDb3VudCA9PT0gJ251bWJlcicgJiYKICAgICAgICB0eXBlb2YgcmVzcG9uc2UubWF4UmV0cmllcyA9PT0gJ251bWJlcicgJiYKICAgICAgICAocmVzcG9uc2UucmV0cnlDb3VudCA+PSByZXNwb25zZS5tYXhSZXRyaWVzKQogICAgICApIHsKICAgICAgICBhcGlDYWxsRXZlbnQuTWF4UmV0cmllc0V4Y2VlZGVkID0gMTsKICAgICAgfQogICAgICBzZWxmLmVtaXQoJ2FwaUNhbGwnLCBbYXBpQ2FsbEV2ZW50XSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBzZXR1cCBhbnkgY3VzdG9tIHJlcXVlc3QgbGlzdGVuZXJzIGZvciBlYWNoCiAgICogbmV3IHJlcXVlc3QgdG8gdGhlIHNlcnZpY2UuCiAgICoKICAgKiBAbWV0aG9kX2Fic3RyYWN0IFRoaXMgaXMgYW4gYWJzdHJhY3QgbWV0aG9kLgogICAqLwogIHNldHVwUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpIHsKICB9LAoKICAvKioKICAgKiBHZXRzIHRoZSBzaWduaW5nIG5hbWUgZm9yIGEgZ2l2ZW4gcmVxdWVzdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldFNpZ25pbmdOYW1lOiBmdW5jdGlvbiBnZXRTaWduaW5nTmFtZSgpIHsKICAgIHJldHVybiB0aGlzLmFwaS5zaWduaW5nTmFtZSB8fCB0aGlzLmFwaS5lbmRwb2ludFByZWZpeDsKICB9LAoKICAvKioKICAgKiBHZXRzIHRoZSBzaWduZXIgY2xhc3MgZm9yIGEgZ2l2ZW4gcmVxdWVzdAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGdldFNpZ25lckNsYXNzOiBmdW5jdGlvbiBnZXRTaWduZXJDbGFzcyhyZXF1ZXN0KSB7CiAgICB2YXIgdmVyc2lvbjsKICAgIC8vIGdldCBvcGVyYXRpb24gYXV0aHR5cGUgaWYgcHJlc2VudAogICAgdmFyIG9wZXJhdGlvbiA9IG51bGw7CiAgICB2YXIgYXV0aHR5cGUgPSAnJzsKICAgIGlmIChyZXF1ZXN0KSB7CiAgICAgIHZhciBvcGVyYXRpb25zID0gcmVxdWVzdC5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zIHx8IHt9OwogICAgICBvcGVyYXRpb24gPSBvcGVyYXRpb25zW3JlcXVlc3Qub3BlcmF0aW9uXSB8fCBudWxsOwogICAgICBhdXRodHlwZSA9IG9wZXJhdGlvbiA/IG9wZXJhdGlvbi5hdXRodHlwZSA6ICcnOwogICAgfQogICAgaWYgKHRoaXMuY29uZmlnLnNpZ25hdHVyZVZlcnNpb24pIHsKICAgICAgdmVyc2lvbiA9IHRoaXMuY29uZmlnLnNpZ25hdHVyZVZlcnNpb247CiAgICB9IGVsc2UgaWYgKGF1dGh0eXBlID09PSAndjQnIHx8IGF1dGh0eXBlID09PSAndjQtdW5zaWduZWQtYm9keScpIHsKICAgICAgdmVyc2lvbiA9ICd2NCc7CiAgICB9IGVsc2UgewogICAgICB2ZXJzaW9uID0gdGhpcy5hcGkuc2lnbmF0dXJlVmVyc2lvbjsKICAgIH0KICAgIHJldHVybiBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmdldFZlcnNpb24odmVyc2lvbik7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2VydmljZUludGVyZmFjZTogZnVuY3Rpb24gc2VydmljZUludGVyZmFjZSgpIHsKICAgIHN3aXRjaCAodGhpcy5hcGkucHJvdG9jb2wpIHsKICAgICAgY2FzZSAnZWMyJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5RdWVyeTsKICAgICAgY2FzZSAncXVlcnknOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlF1ZXJ5OwogICAgICBjYXNlICdqc29uJzogcmV0dXJuIEFXUy5FdmVudExpc3RlbmVycy5Kc29uOwogICAgICBjYXNlICdyZXN0LWpzb24nOiByZXR1cm4gQVdTLkV2ZW50TGlzdGVuZXJzLlJlc3RKc29uOwogICAgICBjYXNlICdyZXN0LXhtbCc6IHJldHVybiBBV1MuRXZlbnRMaXN0ZW5lcnMuUmVzdFhtbDsKICAgIH0KICAgIGlmICh0aGlzLmFwaS5wcm90b2NvbCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2VydmljZSBgcHJvdG9jb2xcJyAnICsKICAgICAgICB0aGlzLmFwaS5wcm90b2NvbCArICcgaW4gQVBJIGNvbmZpZycpOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHN1Y2Nlc3NmdWxSZXNwb25zZTogZnVuY3Rpb24gc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3ApIHsKICAgIHJldHVybiByZXNwLmh0dHBSZXNwb25zZS5zdGF0dXNDb2RlIDwgMzAwOwogIH0sCgogIC8qKgogICAqIEhvdyBtYW55IHRpbWVzIGEgZmFpbGVkIHJlcXVlc3Qgc2hvdWxkIGJlIHJldHJpZWQgYmVmb3JlIGdpdmluZyB1cC4KICAgKiB0aGUgZGVmYXVsdFJldHJ5Q291bnQgY2FuIGJlIG92ZXJyaWRlbiBieSBzZXJ2aWNlIGNsYXNzZXMuCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBudW1SZXRyaWVzOiBmdW5jdGlvbiBudW1SZXRyaWVzKCkgewogICAgaWYgKHRoaXMuY29uZmlnLm1heFJldHJpZXMgIT09IHVuZGVmaW5lZCkgewogICAgICByZXR1cm4gdGhpcy5jb25maWcubWF4UmV0cmllczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRSZXRyeUNvdW50OwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHJldHJ5RGVsYXlzOiBmdW5jdGlvbiByZXRyeURlbGF5cyhyZXRyeUNvdW50LCBlcnIpIHsKICAgIHJldHVybiBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KHJldHJ5Q291bnQsIHRoaXMuY29uZmlnLnJldHJ5RGVsYXlPcHRpb25zLCBlcnIpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHJldHJ5YWJsZUVycm9yOiBmdW5jdGlvbiByZXRyeWFibGVFcnJvcihlcnJvcikgewogICAgaWYgKHRoaXMudGltZW91dEVycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICBpZiAodGhpcy5uZXR3b3JraW5nRXJyb3IoZXJyb3IpKSByZXR1cm4gdHJ1ZTsKICAgIGlmICh0aGlzLmV4cGlyZWRDcmVkZW50aWFsc0Vycm9yKGVycm9yKSkgcmV0dXJuIHRydWU7CiAgICBpZiAodGhpcy50aHJvdHRsZWRFcnJvcihlcnJvcikpIHJldHVybiB0cnVlOwogICAgaWYgKGVycm9yLnN0YXR1c0NvZGUgPj0gNTAwKSByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiBmYWxzZTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBuZXR3b3JraW5nRXJyb3I6IGZ1bmN0aW9uIG5ldHdvcmtpbmdFcnJvcihlcnJvcikgewogICAgcmV0dXJuIGVycm9yLmNvZGUgPT09ICdOZXR3b3JraW5nRXJyb3InOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHRpbWVvdXRFcnJvcjogZnVuY3Rpb24gdGltZW91dEVycm9yKGVycm9yKSB7CiAgICByZXR1cm4gZXJyb3IuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcic7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZXhwaXJlZENyZWRlbnRpYWxzRXJyb3I6IGZ1bmN0aW9uIGV4cGlyZWRDcmVkZW50aWFsc0Vycm9yKGVycm9yKSB7CiAgICAvLyBUT0RPIDogdGhpcyBvbmx5IGhhbmRsZXMgKm9uZSogb2YgdGhlIGV4cGlyZWQgY3JlZGVudGlhbCBjb2RlcwogICAgcmV0dXJuIChlcnJvci5jb2RlID09PSAnRXhwaXJlZFRva2VuRXhjZXB0aW9uJyk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY2xvY2tTa2V3RXJyb3I6IGZ1bmN0aW9uIGNsb2NrU2tld0Vycm9yKGVycm9yKSB7CiAgICBzd2l0Y2ggKGVycm9yLmNvZGUpIHsKICAgICAgY2FzZSAnUmVxdWVzdFRpbWVUb29Ta2V3ZWQnOgogICAgICBjYXNlICdSZXF1ZXN0RXhwaXJlZCc6CiAgICAgIGNhc2UgJ0ludmFsaWRTaWduYXR1cmVFeGNlcHRpb24nOgogICAgICBjYXNlICdTaWduYXR1cmVEb2VzTm90TWF0Y2gnOgogICAgICBjYXNlICdBdXRoRmFpbHVyZSc6CiAgICAgIGNhc2UgJ1JlcXVlc3RJblRoZUZ1dHVyZSc6CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRTa2V3Q29ycmVjdGVkRGF0ZTogZnVuY3Rpb24gZ2V0U2tld0NvcnJlY3RlZERhdGUoKSB7CiAgICByZXR1cm4gbmV3IERhdGUoRGF0ZS5ub3coKSArIHRoaXMuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhcHBseUNsb2NrT2Zmc2V0OiBmdW5jdGlvbiBhcHBseUNsb2NrT2Zmc2V0KG5ld1NlcnZlclRpbWUpIHsKICAgIGlmIChuZXdTZXJ2ZXJUaW1lKSB7CiAgICAgIHRoaXMuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0ID0gbmV3U2VydmVyVGltZSAtIERhdGUubm93KCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaXNDbG9ja1NrZXdlZDogZnVuY3Rpb24gaXNDbG9ja1NrZXdlZChuZXdTZXJ2ZXJUaW1lKSB7CiAgICBpZiAobmV3U2VydmVyVGltZSkgewogICAgICByZXR1cm4gTWF0aC5hYnModGhpcy5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpLmdldFRpbWUoKSAtIG5ld1NlcnZlclRpbWUpID49IDMwMDAwMDsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICB0aHJvdHRsZWRFcnJvcjogZnVuY3Rpb24gdGhyb3R0bGVkRXJyb3IoZXJyb3IpIHsKICAgIC8vIHRoaXMgbG9naWMgdmFyaWVzIGJldHdlZW4gc2VydmljZXMKICAgIGlmIChlcnJvci5zdGF0dXNDb2RlID09PSA0MjkpIHJldHVybiB0cnVlOwogICAgc3dpdGNoIChlcnJvci5jb2RlKSB7CiAgICAgIGNhc2UgJ1Byb3Zpc2lvbmVkVGhyb3VnaHB1dEV4Y2VlZGVkRXhjZXB0aW9uJzoKICAgICAgY2FzZSAnVGhyb3R0bGluZyc6CiAgICAgIGNhc2UgJ1Rocm90dGxpbmdFeGNlcHRpb24nOgogICAgICBjYXNlICdSZXF1ZXN0TGltaXRFeGNlZWRlZCc6CiAgICAgIGNhc2UgJ1JlcXVlc3RUaHJvdHRsZWQnOgogICAgICBjYXNlICdSZXF1ZXN0VGhyb3R0bGVkRXhjZXB0aW9uJzoKICAgICAgY2FzZSAnVG9vTWFueVJlcXVlc3RzRXhjZXB0aW9uJzoKICAgICAgY2FzZSAnVHJhbnNhY3Rpb25JblByb2dyZXNzRXhjZXB0aW9uJzogLy9keW5hbW9kYgogICAgICBjYXNlICdFQzJUaHJvdHRsZWRFeGNlcHRpb24nOgogICAgICAgIHJldHVybiB0cnVlOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBlbmRwb2ludEZyb21UZW1wbGF0ZTogZnVuY3Rpb24gZW5kcG9pbnRGcm9tVGVtcGxhdGUoZW5kcG9pbnQpIHsKICAgIGlmICh0eXBlb2YgZW5kcG9pbnQgIT09ICdzdHJpbmcnKSByZXR1cm4gZW5kcG9pbnQ7CgogICAgdmFyIGUgPSBlbmRwb2ludDsKICAgIGUgPSBlLnJlcGxhY2UoL1x7c2VydmljZVx9L2csIHRoaXMuYXBpLmVuZHBvaW50UHJlZml4KTsKICAgIGUgPSBlLnJlcGxhY2UoL1x7cmVnaW9uXH0vZywgdGhpcy5jb25maWcucmVnaW9uKTsKICAgIGUgPSBlLnJlcGxhY2UoL1x7c2NoZW1lXH0vZywgdGhpcy5jb25maWcuc3NsRW5hYmxlZCA/ICdodHRwcycgOiAnaHR0cCcpOwogICAgcmV0dXJuIGU7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2V0RW5kcG9pbnQ6IGZ1bmN0aW9uIHNldEVuZHBvaW50KGVuZHBvaW50KSB7CiAgICB0aGlzLmVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludCwgdGhpcy5jb25maWcpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHBhZ2luYXRpb25Db25maWc6IGZ1bmN0aW9uIHBhZ2luYXRpb25Db25maWcob3BlcmF0aW9uLCB0aHJvd0V4Y2VwdGlvbikgewogICAgdmFyIHBhZ2luYXRvciA9IHRoaXMuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXS5wYWdpbmF0b3I7CiAgICBpZiAoIXBhZ2luYXRvcikgewogICAgICBpZiAodGhyb3dFeGNlcHRpb24pIHsKICAgICAgICB2YXIgZSA9IG5ldyBFcnJvcigpOwogICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKGUsICdObyBwYWdpbmF0aW9uIGNvbmZpZ3VyYXRpb24gZm9yICcgKyBvcGVyYXRpb24pOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIHJldHVybiBwYWdpbmF0b3I7CiAgfQp9KTsKCkFXUy51dGlsLnVwZGF0ZShBV1MuU2VydmljZSwgewoKICAvKioKICAgKiBBZGRzIG9uZSBtZXRob2QgZm9yIGVhY2ggb3BlcmF0aW9uIGRlc2NyaWJlZCBpbiB0aGUgYXBpIGNvbmZpZ3VyYXRpb24KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGRlZmluZU1ldGhvZHM6IGZ1bmN0aW9uIGRlZmluZU1ldGhvZHMoc3ZjKSB7CiAgICBBV1MudXRpbC5lYWNoKHN2Yy5wcm90b3R5cGUuYXBpLm9wZXJhdGlvbnMsIGZ1bmN0aW9uIGl0ZXJhdG9yKG1ldGhvZCkgewogICAgICBpZiAoc3ZjLnByb3RvdHlwZVttZXRob2RdKSByZXR1cm47CiAgICAgIHZhciBvcGVyYXRpb24gPSBzdmMucHJvdG90eXBlLmFwaS5vcGVyYXRpb25zW21ldGhvZF07CiAgICAgIGlmIChvcGVyYXRpb24uYXV0aHR5cGUgPT09ICdub25lJykgewogICAgICAgIHN2Yy5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uIChwYXJhbXMsIGNhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5tYWtlVW5hdXRoZW50aWNhdGVkUmVxdWVzdChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2spOwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3ZjLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24gKHBhcmFtcywgY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1ha2VSZXF1ZXN0KG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFjayk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogRGVmaW5lcyBhIG5ldyBTZXJ2aWNlIGNsYXNzIHVzaW5nIGEgc2VydmljZSBpZGVudGlmaWVyIGFuZCBsaXN0IG9mIHZlcnNpb25zCiAgICogaW5jbHVkaW5nIGFuIG9wdGlvbmFsIHNldCBvZiBmZWF0dXJlcyAoZnVuY3Rpb25zKSB0byBhcHBseSB0byB0aGUgY2xhc3MKICAgKiBwcm90b3R5cGUuCiAgICoKICAgKiBAcGFyYW0gc2VydmljZUlkZW50aWZpZXIgW1N0cmluZ10gdGhlIGlkZW50aWZpZXIgZm9yIHRoZSBzZXJ2aWNlCiAgICogQHBhcmFtIHZlcnNpb25zIFtBcnJheTxTdHJpbmc+XSBhIGxpc3Qgb2YgdmVyc2lvbnMgdGhhdCB3b3JrIHdpdGggdGhpcwogICAqICAgc2VydmljZQogICAqIEBwYXJhbSBmZWF0dXJlcyBbT2JqZWN0XSBhbiBvYmplY3QgdG8gYXR0YWNoIHRvIHRoZSBwcm90b3R5cGUKICAgKiBAcmV0dXJuIFtDbGFzczxTZXJ2aWNlPl0gdGhlIHNlcnZpY2UgY2xhc3MgZGVmaW5lZCBieSB0aGlzIGZ1bmN0aW9uLgogICAqLwogIGRlZmluZVNlcnZpY2U6IGZ1bmN0aW9uIGRlZmluZVNlcnZpY2Uoc2VydmljZUlkZW50aWZpZXIsIHZlcnNpb25zLCBmZWF0dXJlcykgewogICAgQVdTLlNlcnZpY2UuX3NlcnZpY2VNYXBbc2VydmljZUlkZW50aWZpZXJdID0gdHJ1ZTsKICAgIGlmICghQXJyYXkuaXNBcnJheSh2ZXJzaW9ucykpIHsKICAgICAgZmVhdHVyZXMgPSB2ZXJzaW9uczsKICAgICAgdmVyc2lvbnMgPSBbXTsKICAgIH0KCiAgICB2YXIgc3ZjID0gaW5oZXJpdChBV1MuU2VydmljZSwgZmVhdHVyZXMgfHwge30pOwoKICAgIGlmICh0eXBlb2Ygc2VydmljZUlkZW50aWZpZXIgPT09ICdzdHJpbmcnKSB7CiAgICAgIEFXUy5TZXJ2aWNlLmFkZFZlcnNpb25zKHN2YywgdmVyc2lvbnMpOwoKICAgICAgdmFyIGlkZW50aWZpZXIgPSBzdmMuc2VydmljZUlkZW50aWZpZXIgfHwgc2VydmljZUlkZW50aWZpZXI7CiAgICAgIHN2Yy5zZXJ2aWNlSWRlbnRpZmllciA9IGlkZW50aWZpZXI7CiAgICB9IGVsc2UgeyAvLyBkZWZpbmVTZXJ2aWNlIGNhbGxlZCB3aXRoIGFuIEFQSQogICAgICBzdmMucHJvdG90eXBlLmFwaSA9IHNlcnZpY2VJZGVudGlmaWVyOwogICAgICBBV1MuU2VydmljZS5kZWZpbmVNZXRob2RzKHN2Yyk7CiAgICB9CiAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwodGhpcy5wcm90b3R5cGUpOwogICAgLy91dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nIGlzIG9ubHkgYXZhaWxhYmxlIGluIG5vZGUKICAgIGlmICghdGhpcy5wcm90b3R5cGUucHVibGlzaGVyICYmIEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nKSB7CiAgICAgIHZhciBQdWJsaXNoZXIgPSBBV1MudXRpbC5jbGllbnRTaWRlTW9uaXRvcmluZy5QdWJsaXNoZXI7CiAgICAgIHZhciBjb25maWdQcm92aWRlciA9IEFXUy51dGlsLmNsaWVudFNpZGVNb25pdG9yaW5nLmNvbmZpZ1Byb3ZpZGVyOwogICAgICB2YXIgcHVibGlzaGVyQ29uZmlnID0gY29uZmlnUHJvdmlkZXIoKTsKICAgICAgdGhpcy5wcm90b3R5cGUucHVibGlzaGVyID0gbmV3IFB1Ymxpc2hlcihwdWJsaXNoZXJDb25maWcpOwogICAgICBpZiAocHVibGlzaGVyQ29uZmlnLmVuYWJsZWQpIHsKICAgICAgICAvL2lmIGNzbSBpcyBlbmFibGVkIGluIGVudmlyb25tZW50LCBTREsgc2hvdWxkIHNlbmQgYWxsIG1ldHJpY3MKICAgICAgICBBV1MuU2VydmljZS5fY2xpZW50U2lkZU1vbml0b3JpbmcgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICBBV1MuU2VxdWVudGlhbEV4ZWN1dG9yLmNhbGwoc3ZjLnByb3RvdHlwZSk7CiAgICBBV1MuU2VydmljZS5hZGREZWZhdWx0TW9uaXRvcmluZ0xpc3RlbmVycyhzdmMucHJvdG90eXBlKTsKICAgIHJldHVybiBzdmM7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYWRkVmVyc2lvbnM6IGZ1bmN0aW9uIGFkZFZlcnNpb25zKHN2YywgdmVyc2lvbnMpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheSh2ZXJzaW9ucykpIHZlcnNpb25zID0gW3ZlcnNpb25zXTsKCiAgICBzdmMuc2VydmljZXMgPSBzdmMuc2VydmljZXMgfHwge307CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZlcnNpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChzdmMuc2VydmljZXNbdmVyc2lvbnNbaV1dID09PSB1bmRlZmluZWQpIHsKICAgICAgICBzdmMuc2VydmljZXNbdmVyc2lvbnNbaV1dID0gbnVsbDsKICAgICAgfQogICAgfQoKICAgIHN2Yy5hcGlWZXJzaW9ucyA9IE9iamVjdC5rZXlzKHN2Yy5zZXJ2aWNlcykuc29ydCgpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGRlZmluZVNlcnZpY2VBcGk6IGZ1bmN0aW9uIGRlZmluZVNlcnZpY2VBcGkoc3VwZXJjbGFzcywgdmVyc2lvbiwgYXBpQ29uZmlnKSB7CiAgICB2YXIgc3ZjID0gaW5oZXJpdChzdXBlcmNsYXNzLCB7CiAgICAgIHNlcnZpY2VJZGVudGlmaWVyOiBzdXBlcmNsYXNzLnNlcnZpY2VJZGVudGlmaWVyCiAgICB9KTsKCiAgICBmdW5jdGlvbiBzZXRBcGkoYXBpKSB7CiAgICAgIGlmIChhcGkuaXNBcGkpIHsKICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IGFwaTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdmMucHJvdG90eXBlLmFwaSA9IG5ldyBBcGkoYXBpLCB7CiAgICAgICAgICBzZXJ2aWNlSWRlbnRpZmllcjogc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllcgogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgaWYgKHR5cGVvZiB2ZXJzaW9uID09PSAnc3RyaW5nJykgewogICAgICBpZiAoYXBpQ29uZmlnKSB7CiAgICAgICAgc2V0QXBpKGFwaUNvbmZpZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHNldEFwaShBV1MuYXBpTG9hZGVyKHN1cGVyY2xhc3Muc2VydmljZUlkZW50aWZpZXIsIHZlcnNpb24pKTsKICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgIHRocm93IEFXUy51dGlsLmVycm9yKGVyciwgewogICAgICAgICAgICBtZXNzYWdlOiAnQ291bGQgbm90IGZpbmQgQVBJIGNvbmZpZ3VyYXRpb24gJyArCiAgICAgICAgICAgICAgc3VwZXJjbGFzcy5zZXJ2aWNlSWRlbnRpZmllciArICctJyArIHZlcnNpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzdXBlcmNsYXNzLnNlcnZpY2VzLCB2ZXJzaW9uKSkgewogICAgICAgIHN1cGVyY2xhc3MuYXBpVmVyc2lvbnMgPSBzdXBlcmNsYXNzLmFwaVZlcnNpb25zLmNvbmNhdCh2ZXJzaW9uKS5zb3J0KCk7CiAgICAgIH0KICAgICAgc3VwZXJjbGFzcy5zZXJ2aWNlc1t2ZXJzaW9uXSA9IHN2YzsKICAgIH0gZWxzZSB7CiAgICAgIHNldEFwaSh2ZXJzaW9uKTsKICAgIH0KCiAgICBBV1MuU2VydmljZS5kZWZpbmVNZXRob2RzKHN2Yyk7CiAgICByZXR1cm4gc3ZjOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGhhc1NlcnZpY2U6IGZ1bmN0aW9uKGlkZW50aWZpZXIpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoQVdTLlNlcnZpY2UuX3NlcnZpY2VNYXAsIGlkZW50aWZpZXIpOwogIH0sCgogIC8qKgogICAqIEBwYXJhbSBhdHRhY2hPbiBhdHRhY2ggZGVmYXVsdCBtb25pdG9yaW5nIGxpc3RlbmVycyB0byBvYmplY3QKICAgKgogICAqIEVhY2ggbW9uaXRvcmluZyBldmVudCBzaG91bGQgYmUgZW1pdHRlZCBmcm9tIHNlcnZpY2UgY2xpZW50IHRvIHNlcnZpY2UgY29uc3RydWN0b3IgcHJvdG90eXBlIGFuZCB0aGVuCiAgICogdG8gZ2xvYmFsIHNlcnZpY2UgcHJvdG90eXBlIGxpa2UgYnViYmxpbmcgdXAuIFRoZXNlIGRlZmF1bHQgbW9uaXRvcmluZyBldmVudHMgbGlzdGVuZXIgd2lsbCB0cmFuc2ZlcgogICAqIHRoZSBtb25pdG9yaW5nIGV2ZW50cyB0byB0aGUgdXBwZXIgbGF5ZXIuCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgYWRkRGVmYXVsdE1vbml0b3JpbmdMaXN0ZW5lcnM6IGZ1bmN0aW9uIGFkZERlZmF1bHRNb25pdG9yaW5nTGlzdGVuZXJzKGF0dGFjaE9uKSB7CiAgICBhdHRhY2hPbi5hZGROYW1lZExpc3RlbmVyKCdNT05JVE9SX0VWRU5UU19CVUJCTEUnLCAnYXBpQ2FsbEF0dGVtcHQnLCBmdW5jdGlvbiBFVkVOVFNfQlVCQkxFKGV2ZW50KSB7CiAgICAgIHZhciBiYXNlQ2xhc3MgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoYXR0YWNoT24pOwogICAgICBpZiAoYmFzZUNsYXNzLl9ldmVudHMpIGJhc2VDbGFzcy5lbWl0KCdhcGlDYWxsQXR0ZW1wdCcsIFtldmVudF0pOwogICAgfSk7CiAgICBhdHRhY2hPbi5hZGROYW1lZExpc3RlbmVyKCdDQUxMX0VWRU5UU19CVUJCTEUnLCAnYXBpQ2FsbCcsIGZ1bmN0aW9uIENBTExfRVZFTlRTX0JVQkJMRShldmVudCkgewogICAgICB2YXIgYmFzZUNsYXNzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGF0dGFjaE9uKTsKICAgICAgaWYgKGJhc2VDbGFzcy5fZXZlbnRzKSBiYXNlQ2xhc3MuZW1pdCgnYXBpQ2FsbCcsIFtldmVudF0pOwogICAgfSk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgX3NlcnZpY2VNYXA6IHt9Cn0pOwoKQVdTLnV0aWwubWl4aW4oQVdTLlNlcnZpY2UsIEFXUy5TZXF1ZW50aWFsRXhlY3V0b3IpOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2VydmljZTsKCn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vY29yZSI6MTksIi4vbW9kZWwvYXBpIjozOSwiLi9yZWdpb24vdXRpbHMiOjU0LCIuL3JlZ2lvbl9jb25maWciOjU1LCJfcHJvY2VzcyI6ODl9XSw2MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciByZXNvbHZlUmVnaW9uYWxFbmRwb2ludHNGbGFnID0gcmVxdWlyZSgnLi4vY29uZmlnX3JlZ2lvbmFsX2VuZHBvaW50Jyk7CnZhciBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCA9ICdBV1NfU1RTX1JFR0lPTkFMX0VORFBPSU5UUyc7CnZhciBDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCA9ICdzdHNfcmVnaW9uYWxfZW5kcG9pbnRzJzsKCkFXUy51dGlsLnVwZGF0ZShBV1MuU1RTLnByb3RvdHlwZSwgewogIC8qKgogICAqIEBvdmVybG9hZCBjcmVkZW50aWFsc0Zyb20oZGF0YSwgY3JlZGVudGlhbHMgPSBudWxsKQogICAqICAgQ3JlYXRlcyBhIGNyZWRlbnRpYWxzIG9iamVjdCBmcm9tIFNUUyByZXNwb25zZSBkYXRhIGNvbnRhaW5pbmcKICAgKiAgIGNyZWRlbnRpYWxzIGluZm9ybWF0aW9uLiBVc2VmdWwgZm9yIHF1aWNrbHkgc2V0dGluZyBBV1MgY3JlZGVudGlhbHMuCiAgICoKICAgKiAgIEBub3RlIFRoaXMgaXMgYSBsb3ctbGV2ZWwgdXRpbGl0eSBmdW5jdGlvbi4gSWYgeW91IHdhbnQgdG8gbG9hZCB0ZW1wb3JhcnkKICAgKiAgICAgY3JlZGVudGlhbHMgaW50byB5b3VyIHByb2Nlc3MgZm9yIHN1YnNlcXVlbnQgcmVxdWVzdHMgdG8gQVdTIHJlc291cmNlcywKICAgKiAgICAgeW91IHNob3VsZCB1c2Uge0FXUy5UZW1wb3JhcnlDcmVkZW50aWFsc30gaW5zdGVhZC4KICAgKiAgIEBwYXJhbSBkYXRhIFttYXBdIGRhdGEgcmV0cmlldmVkIGZyb20gYSBjYWxsIHRvIHtnZXRGZWRlcmF0ZWRUb2tlbn0sCiAgICogICAgIHtnZXRTZXNzaW9uVG9rZW59LCB7YXNzdW1lUm9sZX0sIG9yIHthc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5fS4KICAgKiAgIEBwYXJhbSBjcmVkZW50aWFscyBbQVdTLkNyZWRlbnRpYWxzXSBhbiBvcHRpb25hbCBjcmVkZW50aWFscyBvYmplY3QgdG8KICAgKiAgICAgZmlsbCBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9iamVjdC4gVXNlZnVsIHdoZW4gbW9kaWZ5aW5nIGFuCiAgICogICAgIGV4aXN0aW5nIGNyZWRlbnRpYWxzIG9iamVjdCBmcm9tIGEgcmVmcmVzaCBjYWxsLgogICAqICAgQHJldHVybiBbQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzXSB0aGUgc2V0IG9mIHRlbXBvcmFyeSBjcmVkZW50aWFscwogICAqICAgICBsb2FkZWQgZnJvbSBhIHJhdyBTVFMgb3BlcmF0aW9uIHJlc3BvbnNlLgogICAqICAgQGV4YW1wbGUgVXNpbmcgY3JlZGVudGlhbHNGcm9tIHRvIGxvYWQgZ2xvYmFsIEFXUyBjcmVkZW50aWFscwogICAqICAgICB2YXIgc3RzID0gbmV3IEFXUy5TVFMoKTsKICAgKiAgICAgc3RzLmdldFNlc3Npb25Ub2tlbihmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICogICAgICAgaWYgKGVycikgY29uc29sZS5sb2coIkVycm9yIGdldHRpbmcgY3JlZGVudGlhbHMiKTsKICAgKiAgICAgICBlbHNlIHsKICAgKiAgICAgICAgIEFXUy5jb25maWcuY3JlZGVudGlhbHMgPSBzdHMuY3JlZGVudGlhbHNGcm9tKGRhdGEpOwogICAqICAgICAgIH0KICAgKiAgICAgfSk7CiAgICogICBAc2VlIEFXUy5UZW1wb3JhcnlDcmVkZW50aWFscwogICAqLwogIGNyZWRlbnRpYWxzRnJvbTogZnVuY3Rpb24gY3JlZGVudGlhbHNGcm9tKGRhdGEsIGNyZWRlbnRpYWxzKSB7CiAgICBpZiAoIWRhdGEpIHJldHVybiBudWxsOwogICAgaWYgKCFjcmVkZW50aWFscykgY3JlZGVudGlhbHMgPSBuZXcgQVdTLlRlbXBvcmFyeUNyZWRlbnRpYWxzKCk7CiAgICBjcmVkZW50aWFscy5leHBpcmVkID0gZmFsc2U7CiAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCA9IGRhdGEuQ3JlZGVudGlhbHMuQWNjZXNzS2V5SWQ7CiAgICBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXkgPSBkYXRhLkNyZWRlbnRpYWxzLlNlY3JldEFjY2Vzc0tleTsKICAgIGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbiA9IGRhdGEuQ3JlZGVudGlhbHMuU2Vzc2lvblRva2VuOwogICAgY3JlZGVudGlhbHMuZXhwaXJlVGltZSA9IGRhdGEuQ3JlZGVudGlhbHMuRXhwaXJhdGlvbjsKICAgIHJldHVybiBjcmVkZW50aWFsczsKICB9LAoKICBhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5OiBmdW5jdGlvbiBhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5KHBhcmFtcywgY2FsbGJhY2spIHsKICAgIHJldHVybiB0aGlzLm1ha2VVbmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KCdhc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5JywgcGFyYW1zLCBjYWxsYmFjayk7CiAgfSwKCiAgYXNzdW1lUm9sZVdpdGhTQU1MOiBmdW5jdGlvbiBhc3N1bWVSb2xlV2l0aFNBTUwocGFyYW1zLCBjYWxsYmFjaykgewogICAgcmV0dXJuIHRoaXMubWFrZVVuYXV0aGVudGljYXRlZFJlcXVlc3QoJ2Fzc3VtZVJvbGVXaXRoU0FNTCcsIHBhcmFtcywgY2FsbGJhY2spOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNldHVwUmVxdWVzdExpc3RlbmVyczogZnVuY3Rpb24gc2V0dXBSZXF1ZXN0TGlzdGVuZXJzKHJlcXVlc3QpIHsKICAgIHJlcXVlc3QuYWRkTGlzdGVuZXIoJ3ZhbGlkYXRlJywgdGhpcy5vcHRJblJlZ2lvbmFsRW5kcG9pbnQsIHRydWUpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIG9wdEluUmVnaW9uYWxFbmRwb2ludDogZnVuY3Rpb24gb3B0SW5SZWdpb25hbEVuZHBvaW50KHJlcSkgewogICAgdmFyIHNlcnZpY2UgPSByZXEuc2VydmljZTsKICAgIHZhciBjb25maWcgPSBzZXJ2aWNlLmNvbmZpZzsKICAgIGNvbmZpZy5zdHNSZWdpb25hbEVuZHBvaW50cyA9IHJlc29sdmVSZWdpb25hbEVuZHBvaW50c0ZsYWcoc2VydmljZS5fb3JpZ2luYWxDb25maWcsIHsKICAgICAgZW52OiBFTlZfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCwKICAgICAgc2hhcmVkQ29uZmlnOiBDT05GSUdfUkVHSU9OQUxfRU5EUE9JTlRfRU5BQkxFRCwKICAgICAgY2xpZW50Q29uZmlnOiAnc3RzUmVnaW9uYWxFbmRwb2ludHMnCiAgICB9KTsKICAgIGlmICgKICAgICAgY29uZmlnLnN0c1JlZ2lvbmFsRW5kcG9pbnRzID09PSAncmVnaW9uYWwnICYmCiAgICAgIHNlcnZpY2UuaXNHbG9iYWxFbmRwb2ludAogICAgKSB7CiAgICAgIC8vY2xpZW50IHdpbGwgdGhyb3cgaWYgcmVnaW9uIGlzIG5vdCBzdXBwbGllZDsgcmVxdWVzdCB3aWxsIGJlIHNpZ25lZCB3aXRoIHNwZWNpZmllZCByZWdpb24KICAgICAgaWYgKCFjb25maWcucmVnaW9uKSB7CiAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksCiAgICAgICAgICB7Y29kZTogJ0NvbmZpZ0Vycm9yJywgbWVzc2FnZTogJ01pc3NpbmcgcmVnaW9uIGluIGNvbmZpZyd9KTsKICAgICAgfQogICAgICB2YXIgaW5zZXJ0UG9pbnQgPSBjb25maWcuZW5kcG9pbnQuaW5kZXhPZignLmFtYXpvbmF3cy5jb20nKTsKICAgICAgdmFyIHJlZ2lvbmFsRW5kcG9pbnQgPSBjb25maWcuZW5kcG9pbnQuc3Vic3RyaW5nKDAsIGluc2VydFBvaW50KSArCiAgICAgICAgJy4nICsgY29uZmlnLnJlZ2lvbiArIGNvbmZpZy5lbmRwb2ludC5zdWJzdHJpbmcoaW5zZXJ0UG9pbnQpOwogICAgICByZXEuaHR0cFJlcXVlc3QudXBkYXRlRW5kcG9pbnQocmVnaW9uYWxFbmRwb2ludCk7CiAgICAgIHJlcS5odHRwUmVxdWVzdC5yZWdpb24gPSBjb25maWcucmVnaW9uOwogICAgfQogIH0KCn0pOwoKfSx7Ii4uL2NvbmZpZ19yZWdpb25hbF9lbmRwb2ludCI6MTgsIi4uL2NvcmUiOjE5fV0sNjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwp2YXIgaW5oZXJpdCA9IEFXUy51dGlsLmluaGVyaXQ7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgZXhwaXJlc0hlYWRlciA9ICdwcmVzaWduZWQtZXhwaXJlcyc7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBzaWduZWRVcmxCdWlsZGVyKHJlcXVlc3QpIHsKICB2YXIgZXhwaXJlcyA9IHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXTsKICB2YXIgc2lnbmVyQ2xhc3MgPSByZXF1ZXN0LnNlcnZpY2UuZ2V0U2lnbmVyQ2xhc3MocmVxdWVzdCk7CgogIGRlbGV0ZSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbJ1VzZXItQWdlbnQnXTsKICBkZWxldGUgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1Vc2VyLUFnZW50J107CgogIGlmIChzaWduZXJDbGFzcyA9PT0gQVdTLlNpZ25lcnMuVjQpIHsKICAgIGlmIChleHBpcmVzID4gNjA0ODAwKSB7IC8vIG9uZSB3ZWVrIGV4cGlyeSBpcyBpbnZhbGlkCiAgICAgIHZhciBtZXNzYWdlID0gJ1ByZXNpZ25pbmcgZG9lcyBub3Qgc3VwcG9ydCBleHBpcnkgdGltZSBncmVhdGVyICcgKwogICAgICAgICAgICAgICAgICAgICd0aGFuIGEgd2VlayB3aXRoIFNpZ1Y0IHNpZ25pbmcuJzsKICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgICBjb2RlOiAnSW52YWxpZEV4cGlyeVRpbWUnLCBtZXNzYWdlOiBtZXNzYWdlLCByZXRyeWFibGU6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gZXhwaXJlczsKICB9IGVsc2UgaWYgKHNpZ25lckNsYXNzID09PSBBV1MuU2lnbmVycy5TMykgewogICAgdmFyIG5vdyA9IHJlcXVlc3Quc2VydmljZSA/IHJlcXVlc3Quc2VydmljZS5nZXRTa2V3Q29ycmVjdGVkRGF0ZSgpIDogQVdTLnV0aWwuZGF0ZS5nZXREYXRlKCk7CiAgICByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmhlYWRlcnNbZXhwaXJlc0hlYWRlcl0gPSBwYXJzZUludCgKICAgICAgQVdTLnV0aWwuZGF0ZS51bml4VGltZXN0YW1wKG5vdykgKyBleHBpcmVzLCAxMCkudG9TdHJpbmcoKTsKICB9IGVsc2UgewogICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCksIHsKICAgICAgbWVzc2FnZTogJ1ByZXNpZ25pbmcgb25seSBzdXBwb3J0cyBTMyBvciBTaWdWNCBzaWduaW5nLicsCiAgICAgIGNvZGU6ICdVbnN1cHBvcnRlZFNpZ25lcicsIHJldHJ5YWJsZTogZmFsc2UKICAgIH0pOwogIH0KfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KZnVuY3Rpb24gc2lnbmVkVXJsU2lnbmVyKHJlcXVlc3QpIHsKICB2YXIgZW5kcG9pbnQgPSByZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50OwogIHZhciBwYXJzZWRVcmwgPSBBV1MudXRpbC51cmxQYXJzZShyZXF1ZXN0Lmh0dHBSZXF1ZXN0LnBhdGgpOwogIHZhciBxdWVyeVBhcmFtcyA9IHt9OwoKICBpZiAocGFyc2VkVXJsLnNlYXJjaCkgewogICAgcXVlcnlQYXJhbXMgPSBBV1MudXRpbC5xdWVyeVN0cmluZ1BhcnNlKHBhcnNlZFVybC5zZWFyY2guc3Vic3RyKDEpKTsKICB9CgogIHZhciBhdXRoID0gcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10uc3BsaXQoJyAnKTsKICBpZiAoYXV0aFswXSA9PT0gJ0FXUycpIHsKICAgIGF1dGggPSBhdXRoWzFdLnNwbGl0KCc6Jyk7CiAgICBxdWVyeVBhcmFtc1snU2lnbmF0dXJlJ10gPSBhdXRoLnBvcCgpOwogICAgcXVlcnlQYXJhbXNbJ0FXU0FjY2Vzc0tleUlkJ10gPSBhdXRoLmpvaW4oJzonKTsKCiAgICBBV1MudXRpbC5lYWNoKHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGtleSA9PT0gZXhwaXJlc0hlYWRlcikga2V5ID0gJ0V4cGlyZXMnOwogICAgICBpZiAoa2V5LmluZGV4T2YoJ3gtYW16LW1ldGEtJykgPT09IDApIHsKICAgICAgICAvLyBEZWxldGUgZXhpc3RpbmcsIHBvdGVudGlhbGx5IG5vdCBub3JtYWxpemVkIGtleQogICAgICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1trZXldOwogICAgICAgIGtleSA9IGtleS50b0xvd2VyQ2FzZSgpOwogICAgICB9CiAgICAgIHF1ZXJ5UGFyYW1zW2tleV0gPSB2YWx1ZTsKICAgIH0pOwogICAgZGVsZXRlIHJlcXVlc3QuaHR0cFJlcXVlc3QuaGVhZGVyc1tleHBpcmVzSGVhZGVyXTsKICAgIGRlbGV0ZSBxdWVyeVBhcmFtc1snQXV0aG9yaXphdGlvbiddOwogICAgZGVsZXRlIHF1ZXJ5UGFyYW1zWydIb3N0J107CiAgfSBlbHNlIGlmIChhdXRoWzBdID09PSAnQVdTNC1ITUFDLVNIQTI1NicpIHsgLy8gU2lnVjQgc2lnbmluZwogICAgYXV0aC5zaGlmdCgpOwogICAgdmFyIHJlc3QgPSBhdXRoLmpvaW4oJyAnKTsKICAgIHZhciBzaWduYXR1cmUgPSByZXN0Lm1hdGNoKC9TaWduYXR1cmU9KC4qPykoPzosfFxzfFxyP1xufCQpLylbMV07CiAgICBxdWVyeVBhcmFtc1snWC1BbXotU2lnbmF0dXJlJ10gPSBzaWduYXR1cmU7CiAgICBkZWxldGUgcXVlcnlQYXJhbXNbJ0V4cGlyZXMnXTsKICB9CgogIC8vIGJ1aWxkIFVSTAogIGVuZHBvaW50LnBhdGhuYW1lID0gcGFyc2VkVXJsLnBhdGhuYW1lOwogIGVuZHBvaW50LnNlYXJjaCA9IEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcocXVlcnlQYXJhbXMpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwpBV1MuU2lnbmVycy5QcmVzaWduID0gaW5oZXJpdCh7CiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgc2lnbjogZnVuY3Rpb24gc2lnbihyZXF1ZXN0LCBleHBpcmVUaW1lLCBjYWxsYmFjaykgewogICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID0gZXhwaXJlVGltZSB8fCAzNjAwOwogICAgcmVxdWVzdC5vbignYnVpbGQnLCBzaWduZWRVcmxCdWlsZGVyKTsKICAgIHJlcXVlc3Qub24oJ3NpZ24nLCBzaWduZWRVcmxTaWduZXIpOwogICAgcmVxdWVzdC5yZW1vdmVMaXN0ZW5lcignYWZ0ZXJCdWlsZCcsCiAgICAgIEFXUy5FdmVudExpc3RlbmVycy5Db3JlLlNFVF9DT05URU5UX0xFTkdUSCk7CiAgICByZXF1ZXN0LnJlbW92ZUxpc3RlbmVyKCdhZnRlckJ1aWxkJywKICAgICAgQVdTLkV2ZW50TGlzdGVuZXJzLkNvcmUuQ09NUFVURV9TSEEyNTYpOwoKICAgIHJlcXVlc3QuZW1pdCgnYmVmb3JlUHJlc2lnbicsIFtyZXF1ZXN0XSk7CgogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIHJlcXVlc3QuYnVpbGQoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMucmVzcG9uc2UuZXJyb3IpIGNhbGxiYWNrKHRoaXMucmVzcG9uc2UuZXJyb3IpOwogICAgICAgIGVsc2UgewogICAgICAgICAgY2FsbGJhY2sobnVsbCwgQVdTLnV0aWwudXJsRm9ybWF0KHJlcXVlc3QuaHR0cFJlcXVlc3QuZW5kcG9pbnQpKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVxdWVzdC5idWlsZCgpOwogICAgICBpZiAocmVxdWVzdC5yZXNwb25zZS5lcnJvcikgdGhyb3cgcmVxdWVzdC5yZXNwb25zZS5lcnJvcjsKICAgICAgcmV0dXJuIEFXUy51dGlsLnVybEZvcm1hdChyZXF1ZXN0Lmh0dHBSZXF1ZXN0LmVuZHBvaW50KTsKICAgIH0KICB9Cn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5QcmVzaWduOwoKfSx7Ii4uL2NvcmUiOjE5fV0sNjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgQVdTID0gcmVxdWlyZSgnLi4vY29yZScpOwoKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNpZ25lcnMuUmVxdWVzdFNpZ25lciA9IGluaGVyaXQoewogIGNvbnN0cnVjdG9yOiBmdW5jdGlvbiBSZXF1ZXN0U2lnbmVyKHJlcXVlc3QpIHsKICAgIHRoaXMucmVxdWVzdCA9IHJlcXVlc3Q7CiAgfSwKCiAgc2V0U2VydmljZUNsaWVudElkOiBmdW5jdGlvbiBzZXRTZXJ2aWNlQ2xpZW50SWQoaWQpIHsKICAgIHRoaXMuc2VydmljZUNsaWVudElkID0gaWQ7CiAgfSwKCiAgZ2V0U2VydmljZUNsaWVudElkOiBmdW5jdGlvbiBnZXRTZXJ2aWNlQ2xpZW50SWQoKSB7CiAgICByZXR1cm4gdGhpcy5zZXJ2aWNlQ2xpZW50SWQ7CiAgfQp9KTsKCkFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIuZ2V0VmVyc2lvbiA9IGZ1bmN0aW9uIGdldFZlcnNpb24odmVyc2lvbikgewogIHN3aXRjaCAodmVyc2lvbikgewogICAgY2FzZSAndjInOiByZXR1cm4gQVdTLlNpZ25lcnMuVjI7CiAgICBjYXNlICd2Myc6IHJldHVybiBBV1MuU2lnbmVycy5WMzsKICAgIGNhc2UgJ3MzdjQnOiByZXR1cm4gQVdTLlNpZ25lcnMuVjQ7CiAgICBjYXNlICd2NCc6IHJldHVybiBBV1MuU2lnbmVycy5WNDsKICAgIGNhc2UgJ3MzJzogcmV0dXJuIEFXUy5TaWduZXJzLlMzOwogICAgY2FzZSAndjNodHRwcyc6IHJldHVybiBBV1MuU2lnbmVycy5WM0h0dHBzOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gc2lnbmluZyB2ZXJzaW9uICcgKyB2ZXJzaW9uKTsKfTsKCnJlcXVpcmUoJy4vdjInKTsKcmVxdWlyZSgnLi92MycpOwpyZXF1aXJlKCcuL3YzaHR0cHMnKTsKcmVxdWlyZSgnLi92NCcpOwpyZXF1aXJlKCcuL3MzJyk7CnJlcXVpcmUoJy4vcHJlc2lnbicpOwoKfSx7Ii4uL2NvcmUiOjE5LCIuL3ByZXNpZ24iOjYzLCIuL3MzIjo2NSwiLi92MiI6NjYsIi4vdjMiOjY3LCIuL3YzaHR0cHMiOjY4LCIuL3Y0Ijo2OX1dLDY1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNpZ25lcnMuUzMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICAvKioKICAgKiBXaGVuIGJ1aWxkaW5nIHRoZSBzdHJpbmdUb1NpZ24sIHRoZXNlIHN1YiByZXNvdXJjZSBwYXJhbXMgc2hvdWxkIGJlCiAgICogcGFydCBvZiB0aGUgY2Fub25pY2FsIHJlc291cmNlIHN0cmluZyB3aXRoIHRoZWlyIE5PTi1kZWNvZGVkIHZhbHVlcwogICAqLwogIHN1YlJlc291cmNlczogewogICAgJ2FjbCc6IDEsCiAgICAnYWNjZWxlcmF0ZSc6IDEsCiAgICAnYW5hbHl0aWNzJzogMSwKICAgICdjb3JzJzogMSwKICAgICdsaWZlY3ljbGUnOiAxLAogICAgJ2RlbGV0ZSc6IDEsCiAgICAnaW52ZW50b3J5JzogMSwKICAgICdsb2NhdGlvbic6IDEsCiAgICAnbG9nZ2luZyc6IDEsCiAgICAnbWV0cmljcyc6IDEsCiAgICAnbm90aWZpY2F0aW9uJzogMSwKICAgICdwYXJ0TnVtYmVyJzogMSwKICAgICdwb2xpY3knOiAxLAogICAgJ3JlcXVlc3RQYXltZW50JzogMSwKICAgICdyZXBsaWNhdGlvbic6IDEsCiAgICAncmVzdG9yZSc6IDEsCiAgICAndGFnZ2luZyc6IDEsCiAgICAndG9ycmVudCc6IDEsCiAgICAndXBsb2FkSWQnOiAxLAogICAgJ3VwbG9hZHMnOiAxLAogICAgJ3ZlcnNpb25JZCc6IDEsCiAgICAndmVyc2lvbmluZyc6IDEsCiAgICAndmVyc2lvbnMnOiAxLAogICAgJ3dlYnNpdGUnOiAxCiAgfSwKCiAgLy8gd2hlbiBidWlsZGluZyB0aGUgc3RyaW5nVG9TaWduLCB0aGVzZSBxdWVyeXN0cmluZyBwYXJhbXMgc2hvdWxkIGJlCiAgLy8gcGFydCBvZiB0aGUgY2Fub25pY2FsIHJlc291cmNlIHN0cmluZyB3aXRoIHRoZWlyIE5PTi1lbmNvZGVkIHZhbHVlcwogIHJlc3BvbnNlSGVhZGVyczogewogICAgJ3Jlc3BvbnNlLWNvbnRlbnQtdHlwZSc6IDEsCiAgICAncmVzcG9uc2UtY29udGVudC1sYW5ndWFnZSc6IDEsCiAgICAncmVzcG9uc2UtZXhwaXJlcyc6IDEsCiAgICAncmVzcG9uc2UtY2FjaGUtY29udHJvbCc6IDEsCiAgICAncmVzcG9uc2UtY29udGVudC1kaXNwb3NpdGlvbic6IDEsCiAgICAncmVzcG9uc2UtY29udGVudC1lbmNvZGluZyc6IDEKICB9LAoKICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgICBpZiAoIXRoaXMucmVxdWVzdC5oZWFkZXJzWydwcmVzaWduZWQtZXhwaXJlcyddKSB7CiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydYLUFtei1EYXRlJ10gPSBBV1MudXRpbC5kYXRlLnJmYzgyMihkYXRlKTsKICAgIH0KCiAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgIC8vIHByZXNpZ25lZCBVUkxzIHJlcXVpcmUgdGhpcyBoZWFkZXIgdG8gYmUgbG93ZXJjYXNlZAogICAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1sneC1hbXotc2VjdXJpdHktdG9rZW4nXSA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgIH0KCiAgICB2YXIgc2lnbmF0dXJlID0gdGhpcy5zaWduKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSk7CiAgICB2YXIgYXV0aCA9ICdBV1MgJyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJzonICsgc2lnbmF0dXJlOwoKICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWydBdXRob3JpemF0aW9uJ10gPSBhdXRoOwogIH0sCgogIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgdmFyIHIgPSB0aGlzLnJlcXVlc3Q7CgogICAgdmFyIHBhcnRzID0gW107CiAgICBwYXJ0cy5wdXNoKHIubWV0aG9kKTsKICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydDb250ZW50LU1ENSddIHx8ICcnKTsKICAgIHBhcnRzLnB1c2goci5oZWFkZXJzWydDb250ZW50LVR5cGUnXSB8fCAnJyk7CgogICAgLy8gVGhpcyBpcyB0aGUgIkRhdGUiIGhlYWRlciwgYnV0IHdlIHVzZSBYLUFtei1EYXRlLgogICAgLy8gVGhlIFMzIHNpZ25pbmcgbWVjaGFuaXNtIHJlcXVpcmVzIHVzIHRvIHBhc3MgYW4gZW1wdHkKICAgIC8vIHN0cmluZyBmb3IgdGhpcyBEYXRlIGhlYWRlciByZWdhcmRsZXNzLgogICAgcGFydHMucHVzaChyLmhlYWRlcnNbJ3ByZXNpZ25lZC1leHBpcmVzJ10gfHwgJycpOwoKICAgIHZhciBoZWFkZXJzID0gdGhpcy5jYW5vbmljYWxpemVkQW16SGVhZGVycygpOwogICAgaWYgKGhlYWRlcnMpIHBhcnRzLnB1c2goaGVhZGVycyk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsaXplZFJlc291cmNlKCkpOwoKICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwoKICB9LAoKICBjYW5vbmljYWxpemVkQW16SGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsaXplZEFtekhlYWRlcnMoKSB7CgogICAgdmFyIGFtekhlYWRlcnMgPSBbXTsKCiAgICBBV1MudXRpbC5lYWNoKHRoaXMucmVxdWVzdC5oZWFkZXJzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICBpZiAobmFtZS5tYXRjaCgvXngtYW16LS9pKSkKICAgICAgICBhbXpIZWFkZXJzLnB1c2gobmFtZSk7CiAgICB9KTsKCiAgICBhbXpIZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEudG9Mb3dlckNhc2UoKSA8IGIudG9Mb3dlckNhc2UoKSA/IC0xIDogMTsKICAgIH0pOwoKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgQVdTLnV0aWwuYXJyYXlFYWNoLmNhbGwodGhpcywgYW16SGVhZGVycywgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcGFydHMucHVzaChuYW1lLnRvTG93ZXJDYXNlKCkgKyAnOicgKyBTdHJpbmcodGhpcy5yZXF1ZXN0LmhlYWRlcnNbbmFtZV0pKTsKICAgIH0pOwoKICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwoKICB9LAoKICBjYW5vbmljYWxpemVkUmVzb3VyY2U6IGZ1bmN0aW9uIGNhbm9uaWNhbGl6ZWRSZXNvdXJjZSgpIHsKCiAgICB2YXIgciA9IHRoaXMucmVxdWVzdDsKCiAgICB2YXIgcGFydHMgPSByLnBhdGguc3BsaXQoJz8nKTsKICAgIHZhciBwYXRoID0gcGFydHNbMF07CiAgICB2YXIgcXVlcnlzdHJpbmcgPSBwYXJ0c1sxXTsKCiAgICB2YXIgcmVzb3VyY2UgPSAnJzsKCiAgICBpZiAoci52aXJ0dWFsSG9zdGVkQnVja2V0KQogICAgICByZXNvdXJjZSArPSAnLycgKyByLnZpcnR1YWxIb3N0ZWRCdWNrZXQ7CgogICAgcmVzb3VyY2UgKz0gcGF0aDsKCiAgICBpZiAocXVlcnlzdHJpbmcpIHsKCiAgICAgIC8vIGNvbGxlY3QgYSBsaXN0IG9mIHN1YiByZXNvdXJjZXMgYW5kIHF1ZXJ5IHBhcmFtcyB0aGF0IG5lZWQgdG8gYmUgc2lnbmVkCiAgICAgIHZhciByZXNvdXJjZXMgPSBbXTsKCiAgICAgIEFXUy51dGlsLmFycmF5RWFjaC5jYWxsKHRoaXMsIHF1ZXJ5c3RyaW5nLnNwbGl0KCcmJyksIGZ1bmN0aW9uIChwYXJhbSkgewogICAgICAgIHZhciBuYW1lID0gcGFyYW0uc3BsaXQoJz0nKVswXTsKICAgICAgICB2YXIgdmFsdWUgPSBwYXJhbS5zcGxpdCgnPScpWzFdOwogICAgICAgIGlmICh0aGlzLnN1YlJlc291cmNlc1tuYW1lXSB8fCB0aGlzLnJlc3BvbnNlSGVhZGVyc1tuYW1lXSkgewogICAgICAgICAgdmFyIHN1YnJlc291cmNlID0geyBuYW1lOiBuYW1lIH07CiAgICAgICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBpZiAodGhpcy5zdWJSZXNvdXJjZXNbbmFtZV0pIHsKICAgICAgICAgICAgICBzdWJyZXNvdXJjZS52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN1YnJlc291cmNlLnZhbHVlID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzb3VyY2VzLnB1c2goc3VicmVzb3VyY2UpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXNvdXJjZXMuc29ydChmdW5jdGlvbiAoYSwgYikgeyByZXR1cm4gYS5uYW1lIDwgYi5uYW1lID8gLTEgOiAxOyB9KTsKCiAgICAgIGlmIChyZXNvdXJjZXMubGVuZ3RoKSB7CgogICAgICAgIHF1ZXJ5c3RyaW5nID0gW107CiAgICAgICAgQVdTLnV0aWwuYXJyYXlFYWNoKHJlc291cmNlcywgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgaWYgKHJlcy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHF1ZXJ5c3RyaW5nLnB1c2gocmVzLm5hbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcXVlcnlzdHJpbmcucHVzaChyZXMubmFtZSArICc9JyArIHJlcy52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHJlc291cmNlICs9ICc/JyArIHF1ZXJ5c3RyaW5nLmpvaW4oJyYnKTsKICAgICAgfQoKICAgIH0KCiAgICByZXR1cm4gcmVzb3VyY2U7CgogIH0sCgogIHNpZ246IGZ1bmN0aW9uIHNpZ24oc2VjcmV0LCBzdHJpbmcpIHsKICAgIHJldHVybiBBV1MudXRpbC5jcnlwdG8uaG1hYyhzZWNyZXQsIHN0cmluZywgJ2Jhc2U2NCcsICdzaGExJyk7CiAgfQp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuUzM7Cgp9LHsiLi4vY29yZSI6MTl9XSw2NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TaWduZXJzLlYyID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgYWRkQXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYWRkQXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZSkgewoKICAgIGlmICghZGF0ZSkgZGF0ZSA9IEFXUy51dGlsLmRhdGUuZ2V0RGF0ZSgpOwoKICAgIHZhciByID0gdGhpcy5yZXF1ZXN0OwoKICAgIHIucGFyYW1zLlRpbWVzdGFtcCA9IEFXUy51dGlsLmRhdGUuaXNvODYwMShkYXRlKTsKICAgIHIucGFyYW1zLlNpZ25hdHVyZVZlcnNpb24gPSAnMic7CiAgICByLnBhcmFtcy5TaWduYXR1cmVNZXRob2QgPSAnSG1hY1NIQTI1Nic7CiAgICByLnBhcmFtcy5BV1NBY2Nlc3NLZXlJZCA9IGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkOwoKICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgci5wYXJhbXMuU2VjdXJpdHlUb2tlbiA9IGNyZWRlbnRpYWxzLnNlc3Npb25Ub2tlbjsKICAgIH0KCiAgICBkZWxldGUgci5wYXJhbXMuU2lnbmF0dXJlOyAvLyBkZWxldGUgb2xkIFNpZ25hdHVyZSBmb3IgcmUtc2lnbmluZwogICAgci5wYXJhbXMuU2lnbmF0dXJlID0gdGhpcy5zaWduYXR1cmUoY3JlZGVudGlhbHMpOwoKICAgIHIuYm9keSA9IEFXUy51dGlsLnF1ZXJ5UGFyYW1zVG9TdHJpbmcoci5wYXJhbXMpOwogICAgci5oZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gci5ib2R5Lmxlbmd0aDsKICB9LAoKICBzaWduYXR1cmU6IGZ1bmN0aW9uIHNpZ25hdHVyZShjcmVkZW50aWFscykgewogICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5obWFjKGNyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oKSwgJ2Jhc2U2NCcpOwogIH0sCgogIHN0cmluZ1RvU2lnbjogZnVuY3Rpb24gc3RyaW5nVG9TaWduKCkgewogICAgdmFyIHBhcnRzID0gW107CiAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QuZW5kcG9pbnQuaG9zdC50b0xvd2VyQ2FzZSgpKTsKICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0LnBhdGhuYW1lKCkpOwogICAgcGFydHMucHVzaChBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHRoaXMucmVxdWVzdC5wYXJhbXMpKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIH0KCn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WMjsKCn0seyIuLi9jb3JlIjoxOX1dLDY3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIGluaGVyaXQgPSBBV1MudXRpbC5pbmhlcml0OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KQVdTLlNpZ25lcnMuVjMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlJlcXVlc3RTaWduZXIsIHsKICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CgogICAgdmFyIGRhdGV0aW1lID0gQVdTLnV0aWwuZGF0ZS5yZmM4MjIoZGF0ZSk7CgogICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXSA9IGRhdGV0aW1lOwoKICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ3gtYW16LXNlY3VyaXR5LXRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICB9CgogICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16bi1BdXRob3JpemF0aW9uJ10gPQogICAgICB0aGlzLmF1dGhvcml6YXRpb24oY3JlZGVudGlhbHMsIGRhdGV0aW1lKTsKCiAgfSwKCiAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscykgewogICAgcmV0dXJuICdBV1MzICcgKwogICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgJ0FsZ29yaXRobT1IbWFjU0hBMjU2LCcgKwogICAgICAnU2lnbmVkSGVhZGVycz0nICsgdGhpcy5zaWduZWRIZWFkZXJzKCkgKyAnLCcgKwogICAgICAnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgfSwKCiAgc2lnbmVkSGVhZGVyczogZnVuY3Rpb24gc2lnbmVkSGVhZGVycygpIHsKICAgIHZhciBoZWFkZXJzID0gW107CiAgICBBV1MudXRpbC5hcnJheUVhY2godGhpcy5oZWFkZXJzVG9TaWduKCksIGZ1bmN0aW9uIGl0ZXJhdG9yKGgpIHsKICAgICAgaGVhZGVycy5wdXNoKGgudG9Mb3dlckNhc2UoKSk7CiAgICB9KTsKICAgIHJldHVybiBoZWFkZXJzLnNvcnQoKS5qb2luKCc7Jyk7CiAgfSwKCiAgY2Fub25pY2FsSGVhZGVyczogZnVuY3Rpb24gY2Fub25pY2FsSGVhZGVycygpIHsKICAgIHZhciBoZWFkZXJzID0gdGhpcy5yZXF1ZXN0LmhlYWRlcnM7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIEFXUy51dGlsLmFycmF5RWFjaCh0aGlzLmhlYWRlcnNUb1NpZ24oKSwgZnVuY3Rpb24gaXRlcmF0b3IoaCkgewogICAgICBwYXJ0cy5wdXNoKGgudG9Mb3dlckNhc2UoKS50cmltKCkgKyAnOicgKyBTdHJpbmcoaGVhZGVyc1toXSkudHJpbSgpKTsKICAgIH0pOwogICAgcmV0dXJuIHBhcnRzLnNvcnQoKS5qb2luKCdcbicpICsgJ1xuJzsKICB9LAoKICBoZWFkZXJzVG9TaWduOiBmdW5jdGlvbiBoZWFkZXJzVG9TaWduKCkgewogICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgIEFXUy51dGlsLmVhY2godGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uIGl0ZXJhdG9yKGspIHsKICAgICAgaWYgKGsgPT09ICdIb3N0JyB8fCBrID09PSAnQ29udGVudC1FbmNvZGluZycgfHwgay5tYXRjaCgvXlgtQW16L2kpKSB7CiAgICAgICAgaGVhZGVycy5wdXNoKGspOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBoZWFkZXJzOwogIH0sCgogIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzKSB7CiAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoY3JlZGVudGlhbHMuc2VjcmV0QWNjZXNzS2V5LCB0aGlzLnN0cmluZ1RvU2lnbigpLCAnYmFzZTY0Jyk7CiAgfSwKCiAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIHBhcnRzLnB1c2godGhpcy5yZXF1ZXN0Lm1ldGhvZCk7CiAgICBwYXJ0cy5wdXNoKCcvJyk7CiAgICBwYXJ0cy5wdXNoKCcnKTsKICAgIHBhcnRzLnB1c2godGhpcy5jYW5vbmljYWxIZWFkZXJzKCkpOwogICAgcGFydHMucHVzaCh0aGlzLnJlcXVlc3QuYm9keSk7CiAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLnNoYTI1NihwYXJ0cy5qb2luKCdcbicpKTsKICB9Cgp9KTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQVdTLlNpZ25lcnMuVjM7Cgp9LHsiLi4vY29yZSI6MTl9XSw2ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCnJlcXVpcmUoJy4vdjMnKTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TaWduZXJzLlYzSHR0cHMgPSBpbmhlcml0KEFXUy5TaWduZXJzLlYzLCB7CiAgYXV0aG9yaXphdGlvbjogZnVuY3Rpb24gYXV0aG9yaXphdGlvbihjcmVkZW50aWFscykgewogICAgcmV0dXJuICdBV1MzLUhUVFBTICcgKwogICAgICAnQVdTQWNjZXNzS2V5SWQ9JyArIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkICsgJywnICsKICAgICAgJ0FsZ29yaXRobT1IbWFjU0hBMjU2LCcgKwogICAgICAnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscyk7CiAgfSwKCiAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oKSB7CiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LURhdGUnXTsKICB9Cn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WM0h0dHBzOwoKfSx7Ii4uL2NvcmUiOjE5LCIuL3YzIjo2N31dLDY5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEFXUyA9IHJlcXVpcmUoJy4uL2NvcmUnKTsKdmFyIHY0Q3JlZGVudGlhbHMgPSByZXF1aXJlKCcuL3Y0X2NyZWRlbnRpYWxzJyk7CnZhciBpbmhlcml0ID0gQVdTLnV0aWwuaW5oZXJpdDsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCnZhciBleHBpcmVzSGVhZGVyID0gJ3ByZXNpZ25lZC1leHBpcmVzJzsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCkFXUy5TaWduZXJzLlY0ID0gaW5oZXJpdChBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLCB7CiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uIFY0KHJlcXVlc3QsIHNlcnZpY2VOYW1lLCBvcHRpb25zKSB7CiAgICBBV1MuU2lnbmVycy5SZXF1ZXN0U2lnbmVyLmNhbGwodGhpcywgcmVxdWVzdCk7CiAgICB0aGlzLnNlcnZpY2VOYW1lID0gc2VydmljZU5hbWU7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMuc2lnbmF0dXJlQ2FjaGUgPSB0eXBlb2Ygb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA9PT0gJ2Jvb2xlYW4nID8gb3B0aW9ucy5zaWduYXR1cmVDYWNoZSA6IHRydWU7CiAgICB0aGlzLm9wZXJhdGlvbiA9IG9wdGlvbnMub3BlcmF0aW9uOwogICAgdGhpcy5zaWduYXR1cmVWZXJzaW9uID0gb3B0aW9ucy5zaWduYXR1cmVWZXJzaW9uOwogIH0sCgogIGFsZ29yaXRobTogJ0FXUzQtSE1BQy1TSEEyNTYnLAoKICBhZGRBdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhZGRBdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRlKSB7CiAgICB2YXIgZGF0ZXRpbWUgPSBBV1MudXRpbC5kYXRlLmlzbzg2MDEoZGF0ZSkucmVwbGFjZSgvWzpcLV18XC5cZHszfS9nLCAnJyk7CgogICAgaWYgKHRoaXMuaXNQcmVzaWduZWQoKSkgewogICAgICB0aGlzLnVwZGF0ZUZvclByZXNpZ25lZChjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5hZGRIZWFkZXJzKGNyZWRlbnRpYWxzLCBkYXRldGltZSk7CiAgICB9CgogICAgdGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0F1dGhvcml6YXRpb24nXSA9CiAgICAgIHRoaXMuYXV0aG9yaXphdGlvbihjcmVkZW50aWFscywgZGF0ZXRpbWUpOwogIH0sCgogIGFkZEhlYWRlcnM6IGZ1bmN0aW9uIGFkZEhlYWRlcnMoY3JlZGVudGlhbHMsIGRhdGV0aW1lKSB7CiAgICB0aGlzLnJlcXVlc3QuaGVhZGVyc1snWC1BbXotRGF0ZSddID0gZGF0ZXRpbWU7CiAgICBpZiAoY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuKSB7CiAgICAgIHRoaXMucmVxdWVzdC5oZWFkZXJzWyd4LWFtei1zZWN1cml0eS10b2tlbiddID0gY3JlZGVudGlhbHMuc2Vzc2lvblRva2VuOwogICAgfQogIH0sCgogIHVwZGF0ZUZvclByZXNpZ25lZDogZnVuY3Rpb24gdXBkYXRlRm9yUHJlc2lnbmVkKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgdmFyIGNyZWRTdHJpbmcgPSB0aGlzLmNyZWRlbnRpYWxTdHJpbmcoZGF0ZXRpbWUpOwogICAgdmFyIHFzID0gewogICAgICAnWC1BbXotRGF0ZSc6IGRhdGV0aW1lLAogICAgICAnWC1BbXotQWxnb3JpdGhtJzogdGhpcy5hbGdvcml0aG0sCiAgICAgICdYLUFtei1DcmVkZW50aWFsJzogY3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgKyAnLycgKyBjcmVkU3RyaW5nLAogICAgICAnWC1BbXotRXhwaXJlcyc6IHRoaXMucmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdLAogICAgICAnWC1BbXotU2lnbmVkSGVhZGVycyc6IHRoaXMuc2lnbmVkSGVhZGVycygpCiAgICB9OwoKICAgIGlmIChjcmVkZW50aWFscy5zZXNzaW9uVG9rZW4pIHsKICAgICAgcXNbJ1gtQW16LVNlY3VyaXR5LVRva2VuJ10gPSBjcmVkZW50aWFscy5zZXNzaW9uVG9rZW47CiAgICB9CgogICAgaWYgKHRoaXMucmVxdWVzdC5oZWFkZXJzWydDb250ZW50LVR5cGUnXSkgewogICAgICBxc1snQ29udGVudC1UeXBlJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1UeXBlJ107CiAgICB9CiAgICBpZiAodGhpcy5yZXF1ZXN0LmhlYWRlcnNbJ0NvbnRlbnQtTUQ1J10pIHsKICAgICAgcXNbJ0NvbnRlbnQtTUQ1J10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ29udGVudC1NRDUnXTsKICAgIH0KICAgIGlmICh0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ2FjaGUtQ29udHJvbCddKSB7CiAgICAgIHFzWydDYWNoZS1Db250cm9sJ10gPSB0aGlzLnJlcXVlc3QuaGVhZGVyc1snQ2FjaGUtQ29udHJvbCddOwogICAgfQoKICAgIC8vIG5lZWQgdG8gcHVsbCBpbiBhbnkgb3RoZXIgWC1BbXotKiBoZWFkZXJzCiAgICBBV1MudXRpbC5lYWNoLmNhbGwodGhpcywgdGhpcy5yZXF1ZXN0LmhlYWRlcnMsIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgaWYgKGtleSA9PT0gZXhwaXJlc0hlYWRlcikgcmV0dXJuOwogICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICB2YXIgbG93ZXJLZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgICAvLyBNZXRhZGF0YSBzaG91bGQgYmUgbm9ybWFsaXplZAogICAgICAgIGlmIChsb3dlcktleS5pbmRleE9mKCd4LWFtei1tZXRhLScpID09PSAwKSB7CiAgICAgICAgICBxc1tsb3dlcktleV0gPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGxvd2VyS2V5LmluZGV4T2YoJ3gtYW16LScpID09PSAwKSB7CiAgICAgICAgICBxc1trZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICB2YXIgc2VwID0gdGhpcy5yZXF1ZXN0LnBhdGguaW5kZXhPZignPycpID49IDAgPyAnJicgOiAnPyc7CiAgICB0aGlzLnJlcXVlc3QucGF0aCArPSBzZXAgKyBBV1MudXRpbC5xdWVyeVBhcmFtc1RvU3RyaW5nKHFzKTsKICB9LAoKICBhdXRob3JpemF0aW9uOiBmdW5jdGlvbiBhdXRob3JpemF0aW9uKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgdmFyIHBhcnRzID0gW107CiAgICB2YXIgY3JlZFN0cmluZyA9IHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuYWxnb3JpdGhtICsgJyBDcmVkZW50aWFsPScgKwogICAgICBjcmVkZW50aWFscy5hY2Nlc3NLZXlJZCArICcvJyArIGNyZWRTdHJpbmcpOwogICAgcGFydHMucHVzaCgnU2lnbmVkSGVhZGVycz0nICsgdGhpcy5zaWduZWRIZWFkZXJzKCkpOwogICAgcGFydHMucHVzaCgnU2lnbmF0dXJlPScgKyB0aGlzLnNpZ25hdHVyZShjcmVkZW50aWFscywgZGF0ZXRpbWUpKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCcsICcpOwogIH0sCgogIHNpZ25hdHVyZTogZnVuY3Rpb24gc2lnbmF0dXJlKGNyZWRlbnRpYWxzLCBkYXRldGltZSkgewogICAgdmFyIHNpZ25pbmdLZXkgPSB2NENyZWRlbnRpYWxzLmdldFNpZ25pbmdLZXkoCiAgICAgIGNyZWRlbnRpYWxzLAogICAgICBkYXRldGltZS5zdWJzdHIoMCwgOCksCiAgICAgIHRoaXMucmVxdWVzdC5yZWdpb24sCiAgICAgIHRoaXMuc2VydmljZU5hbWUsCiAgICAgIHRoaXMuc2lnbmF0dXJlQ2FjaGUKICAgICk7CiAgICByZXR1cm4gQVdTLnV0aWwuY3J5cHRvLmhtYWMoc2lnbmluZ0tleSwgdGhpcy5zdHJpbmdUb1NpZ24oZGF0ZXRpbWUpLCAnaGV4Jyk7CiAgfSwKCiAgc3RyaW5nVG9TaWduOiBmdW5jdGlvbiBzdHJpbmdUb1NpZ24oZGF0ZXRpbWUpIHsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgcGFydHMucHVzaCgnQVdTNC1ITUFDLVNIQTI1NicpOwogICAgcGFydHMucHVzaChkYXRldGltZSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuY3JlZGVudGlhbFN0cmluZyhkYXRldGltZSkpOwogICAgcGFydHMucHVzaCh0aGlzLmhleEVuY29kZWRIYXNoKHRoaXMuY2Fub25pY2FsU3RyaW5nKCkpKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCdcbicpOwogIH0sCgogIGNhbm9uaWNhbFN0cmluZzogZnVuY3Rpb24gY2Fub25pY2FsU3RyaW5nKCkgewogICAgdmFyIHBhcnRzID0gW10sIHBhdGhuYW1lID0gdGhpcy5yZXF1ZXN0LnBhdGhuYW1lKCk7CiAgICBpZiAodGhpcy5zZXJ2aWNlTmFtZSAhPT0gJ3MzJyAmJiB0aGlzLnNpZ25hdHVyZVZlcnNpb24gIT09ICdzM3Y0JykgcGF0aG5hbWUgPSBBV1MudXRpbC51cmlFc2NhcGVQYXRoKHBhdGhuYW1lKTsKCiAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5tZXRob2QpOwogICAgcGFydHMucHVzaChwYXRobmFtZSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMucmVxdWVzdC5zZWFyY2goKSk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuY2Fub25pY2FsSGVhZGVycygpICsgJ1xuJyk7CiAgICBwYXJ0cy5wdXNoKHRoaXMuc2lnbmVkSGVhZGVycygpKTsKICAgIHBhcnRzLnB1c2godGhpcy5oZXhFbmNvZGVkQm9keUhhc2goKSk7CiAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICB9LAoKICBjYW5vbmljYWxIZWFkZXJzOiBmdW5jdGlvbiBjYW5vbmljYWxIZWFkZXJzKCkgewogICAgdmFyIGhlYWRlcnMgPSBbXTsKICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSwgaXRlbSkgewogICAgICBoZWFkZXJzLnB1c2goW2tleSwgaXRlbV0pOwogICAgfSk7CiAgICBoZWFkZXJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGFbMF0udG9Mb3dlckNhc2UoKSA8IGJbMF0udG9Mb3dlckNhc2UoKSA/IC0xIDogMTsKICAgIH0pOwogICAgdmFyIHBhcnRzID0gW107CiAgICBBV1MudXRpbC5hcnJheUVhY2guY2FsbCh0aGlzLCBoZWFkZXJzLCBmdW5jdGlvbiAoaXRlbSkgewogICAgICB2YXIga2V5ID0gaXRlbVswXS50b0xvd2VyQ2FzZSgpOwogICAgICBpZiAodGhpcy5pc1NpZ25hYmxlSGVhZGVyKGtleSkpIHsKICAgICAgICB2YXIgdmFsdWUgPSBpdGVtWzFdOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnIHx8IHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZS50b1N0cmluZyAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgdGhyb3cgQVdTLnV0aWwuZXJyb3IobmV3IEVycm9yKCdIZWFkZXIgJyArIGtleSArICcgY29udGFpbnMgaW52YWxpZCB2YWx1ZScpLCB7CiAgICAgICAgICAgIGNvZGU6ICdJbnZhbGlkSGVhZGVyJwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHBhcnRzLnB1c2goa2V5ICsgJzonICsKICAgICAgICAgIHRoaXMuY2Fub25pY2FsSGVhZGVyVmFsdWVzKHZhbHVlLnRvU3RyaW5nKCkpKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcGFydHMuam9pbignXG4nKTsKICB9LAoKICBjYW5vbmljYWxIZWFkZXJWYWx1ZXM6IGZ1bmN0aW9uIGNhbm9uaWNhbEhlYWRlclZhbHVlcyh2YWx1ZXMpIHsKICAgIHJldHVybiB2YWx1ZXMucmVwbGFjZSgvXHMrL2csICcgJykucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKICB9LAoKICBzaWduZWRIZWFkZXJzOiBmdW5jdGlvbiBzaWduZWRIZWFkZXJzKCkgewogICAgdmFyIGtleXMgPSBbXTsKICAgIEFXUy51dGlsLmVhY2guY2FsbCh0aGlzLCB0aGlzLnJlcXVlc3QuaGVhZGVycywgZnVuY3Rpb24gKGtleSkgewogICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKHRoaXMuaXNTaWduYWJsZUhlYWRlcihrZXkpKSBrZXlzLnB1c2goa2V5KTsKICAgIH0pOwogICAgcmV0dXJuIGtleXMuc29ydCgpLmpvaW4oJzsnKTsKICB9LAoKICBjcmVkZW50aWFsU3RyaW5nOiBmdW5jdGlvbiBjcmVkZW50aWFsU3RyaW5nKGRhdGV0aW1lKSB7CiAgICByZXR1cm4gdjRDcmVkZW50aWFscy5jcmVhdGVTY29wZSgKICAgICAgZGF0ZXRpbWUuc3Vic3RyKDAsIDgpLAogICAgICB0aGlzLnJlcXVlc3QucmVnaW9uLAogICAgICB0aGlzLnNlcnZpY2VOYW1lCiAgICApOwogIH0sCgogIGhleEVuY29kZWRIYXNoOiBmdW5jdGlvbiBoYXNoKHN0cmluZykgewogICAgcmV0dXJuIEFXUy51dGlsLmNyeXB0by5zaGEyNTYoc3RyaW5nLCAnaGV4Jyk7CiAgfSwKCiAgaGV4RW5jb2RlZEJvZHlIYXNoOiBmdW5jdGlvbiBoZXhFbmNvZGVkQm9keUhhc2goKSB7CiAgICB2YXIgcmVxdWVzdCA9IHRoaXMucmVxdWVzdDsKICAgIGlmICh0aGlzLmlzUHJlc2lnbmVkKCkgJiYgKFsnczMnLCAnczMtb2JqZWN0LWxhbWJkYSddLmluZGV4T2YodGhpcy5zZXJ2aWNlTmFtZSkgPiAtMSkgJiYgIXJlcXVlc3QuYm9keSkgewogICAgICByZXR1cm4gJ1VOU0lHTkVELVBBWUxPQUQnOwogICAgfSBlbHNlIGlmIChyZXF1ZXN0LmhlYWRlcnNbJ1gtQW16LUNvbnRlbnQtU2hhMjU2J10pIHsKICAgICAgcmV0dXJuIHJlcXVlc3QuaGVhZGVyc1snWC1BbXotQ29udGVudC1TaGEyNTYnXTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmhleEVuY29kZWRIYXNoKHRoaXMucmVxdWVzdC5ib2R5IHx8ICcnKTsKICAgIH0KICB9LAoKICB1bnNpZ25hYmxlSGVhZGVyczogWwogICAgJ2F1dGhvcml6YXRpb24nLAogICAgJ2NvbnRlbnQtdHlwZScsCiAgICAnY29udGVudC1sZW5ndGgnLAogICAgJ3VzZXItYWdlbnQnLAogICAgZXhwaXJlc0hlYWRlciwKICAgICdleHBlY3QnLAogICAgJ3gtYW16bi10cmFjZS1pZCcKICBdLAoKICBpc1NpZ25hYmxlSGVhZGVyOiBmdW5jdGlvbiBpc1NpZ25hYmxlSGVhZGVyKGtleSkgewogICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ3gtYW16LScpID09PSAwKSByZXR1cm4gdHJ1ZTsKICAgIHJldHVybiB0aGlzLnVuc2lnbmFibGVIZWFkZXJzLmluZGV4T2Yoa2V5KSA8IDA7CiAgfSwKCiAgaXNQcmVzaWduZWQ6IGZ1bmN0aW9uIGlzUHJlc2lnbmVkKCkgewogICAgcmV0dXJuIHRoaXMucmVxdWVzdC5oZWFkZXJzW2V4cGlyZXNIZWFkZXJdID8gdHJ1ZSA6IGZhbHNlOwogIH0KCn0pOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSBBV1MuU2lnbmVycy5WNDsKCn0seyIuLi9jb3JlIjoxOSwiLi92NF9jcmVkZW50aWFscyI6NzB9XSw3MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBBV1MgPSByZXF1aXJlKCcuLi9jb3JlJyk7CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgY2FjaGVkU2VjcmV0ID0ge307CgovKioKICogQGFwaSBwcml2YXRlCiAqLwp2YXIgY2FjaGVRdWV1ZSA9IFtdOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIG1heENhY2hlRW50cmllcyA9IDUwOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIHY0SWRlbnRpZmllciA9ICdhd3M0X3JlcXVlc3QnOwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBAcGFyYW0gZGF0ZSBbU3RyaW5nXQogICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgKiBAcGFyYW0gc2VydmljZU5hbWUgW1N0cmluZ10KICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICovCiAgY3JlYXRlU2NvcGU6IGZ1bmN0aW9uIGNyZWF0ZVNjb3BlKGRhdGUsIHJlZ2lvbiwgc2VydmljZU5hbWUpIHsKICAgIHJldHVybiBbCiAgICAgIGRhdGUuc3Vic3RyKDAsIDgpLAogICAgICByZWdpb24sCiAgICAgIHNlcnZpY2VOYW1lLAogICAgICB2NElkZW50aWZpZXIKICAgIF0uam9pbignLycpOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqCiAgICogQHBhcmFtIGNyZWRlbnRpYWxzIFtDcmVkZW50aWFsc10KICAgKiBAcGFyYW0gZGF0ZSBbU3RyaW5nXQogICAqIEBwYXJhbSByZWdpb24gW1N0cmluZ10KICAgKiBAcGFyYW0gc2VydmljZSBbU3RyaW5nXQogICAqIEBwYXJhbSBzaG91bGRDYWNoZSBbQm9vbGVhbl0KICAgKiBAcmV0dXJuIFtTdHJpbmddCiAgICovCiAgZ2V0U2lnbmluZ0tleTogZnVuY3Rpb24gZ2V0U2lnbmluZ0tleSgKICAgIGNyZWRlbnRpYWxzLAogICAgZGF0ZSwKICAgIHJlZ2lvbiwKICAgIHNlcnZpY2UsCiAgICBzaG91bGRDYWNoZQogICkgewogICAgdmFyIGNyZWRzSWRlbnRpZmllciA9IEFXUy51dGlsLmNyeXB0bwogICAgICAuaG1hYyhjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksIGNyZWRlbnRpYWxzLmFjY2Vzc0tleUlkLCAnYmFzZTY0Jyk7CiAgICB2YXIgY2FjaGVLZXkgPSBbY3JlZHNJZGVudGlmaWVyLCBkYXRlLCByZWdpb24sIHNlcnZpY2VdLmpvaW4oJ18nKTsKICAgIHNob3VsZENhY2hlID0gc2hvdWxkQ2FjaGUgIT09IGZhbHNlOwogICAgaWYgKHNob3VsZENhY2hlICYmIChjYWNoZUtleSBpbiBjYWNoZWRTZWNyZXQpKSB7CiAgICAgIHJldHVybiBjYWNoZWRTZWNyZXRbY2FjaGVLZXldOwogICAgfQoKICAgIHZhciBrRGF0ZSA9IEFXUy51dGlsLmNyeXB0by5obWFjKAogICAgICAnQVdTNCcgKyBjcmVkZW50aWFscy5zZWNyZXRBY2Nlc3NLZXksCiAgICAgIGRhdGUsCiAgICAgICdidWZmZXInCiAgICApOwogICAgdmFyIGtSZWdpb24gPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrRGF0ZSwgcmVnaW9uLCAnYnVmZmVyJyk7CiAgICB2YXIga1NlcnZpY2UgPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrUmVnaW9uLCBzZXJ2aWNlLCAnYnVmZmVyJyk7CgogICAgdmFyIHNpZ25pbmdLZXkgPSBBV1MudXRpbC5jcnlwdG8uaG1hYyhrU2VydmljZSwgdjRJZGVudGlmaWVyLCAnYnVmZmVyJyk7CiAgICBpZiAoc2hvdWxkQ2FjaGUpIHsKICAgICAgY2FjaGVkU2VjcmV0W2NhY2hlS2V5XSA9IHNpZ25pbmdLZXk7CiAgICAgIGNhY2hlUXVldWUucHVzaChjYWNoZUtleSk7CiAgICAgIGlmIChjYWNoZVF1ZXVlLmxlbmd0aCA+IG1heENhY2hlRW50cmllcykgewogICAgICAgIC8vIHJlbW92ZSB0aGUgb2xkZXN0IGVudHJ5IChub3QgdGhlIGxlYXN0IHJlY2VudGx5IHVzZWQpCiAgICAgICAgZGVsZXRlIGNhY2hlZFNlY3JldFtjYWNoZVF1ZXVlLnNoaWZ0KCldOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHNpZ25pbmdLZXk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICoKICAgKiBFbXB0aWVzIHRoZSBkZXJpdmVkIHNpZ25pbmcga2V5IGNhY2hlLiBNYWRlIGF2YWlsYWJsZSBmb3IgdGVzdGluZyBwdXJwb3NlcwogICAqIG9ubHkuCiAgICovCiAgZW1wdHlDYWNoZTogZnVuY3Rpb24gZW1wdHlDYWNoZSgpIHsKICAgIGNhY2hlZFNlY3JldCA9IHt9OwogICAgY2FjaGVRdWV1ZSA9IFtdOwogIH0KfTsKCn0seyIuLi9jb3JlIjoxOX1dLDcxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKZnVuY3Rpb24gQWNjZXB0b3JTdGF0ZU1hY2hpbmUoc3RhdGVzLCBzdGF0ZSkgewogIHRoaXMuY3VycmVudFN0YXRlID0gc3RhdGUgfHwgbnVsbDsKICB0aGlzLnN0YXRlcyA9IHN0YXRlcyB8fCB7fTsKfQoKQWNjZXB0b3JTdGF0ZU1hY2hpbmUucHJvdG90eXBlLnJ1blRvID0gZnVuY3Rpb24gcnVuVG8oZmluYWxTdGF0ZSwgZG9uZSwgYmluZE9iamVjdCwgaW5wdXRFcnJvcikgewogIGlmICh0eXBlb2YgZmluYWxTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgaW5wdXRFcnJvciA9IGJpbmRPYmplY3Q7IGJpbmRPYmplY3QgPSBkb25lOwogICAgZG9uZSA9IGZpbmFsU3RhdGU7IGZpbmFsU3RhdGUgPSBudWxsOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzOwogIHZhciBzdGF0ZSA9IHNlbGYuc3RhdGVzW3NlbGYuY3VycmVudFN0YXRlXTsKICBzdGF0ZS5mbi5jYWxsKGJpbmRPYmplY3QgfHwgc2VsZiwgaW5wdXRFcnJvciwgZnVuY3Rpb24oZXJyKSB7CiAgICBpZiAoZXJyKSB7CiAgICAgIGlmIChzdGF0ZS5mYWlsKSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmZhaWw7CiAgICAgIGVsc2UgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCwgZXJyKSA6IG51bGw7CiAgICB9IGVsc2UgewogICAgICBpZiAoc3RhdGUuYWNjZXB0KSBzZWxmLmN1cnJlbnRTdGF0ZSA9IHN0YXRlLmFjY2VwdDsKICAgICAgZWxzZSByZXR1cm4gZG9uZSA/IGRvbmUuY2FsbChiaW5kT2JqZWN0KSA6IG51bGw7CiAgICB9CiAgICBpZiAoc2VsZi5jdXJyZW50U3RhdGUgPT09IGZpbmFsU3RhdGUpIHsKICAgICAgcmV0dXJuIGRvbmUgPyBkb25lLmNhbGwoYmluZE9iamVjdCwgZXJyKSA6IG51bGw7CiAgICB9CgogICAgc2VsZi5ydW5UbyhmaW5hbFN0YXRlLCBkb25lLCBiaW5kT2JqZWN0LCBlcnIpOwogIH0pOwp9OwoKQWNjZXB0b3JTdGF0ZU1hY2hpbmUucHJvdG90eXBlLmFkZFN0YXRlID0gZnVuY3Rpb24gYWRkU3RhdGUobmFtZSwgYWNjZXB0U3RhdGUsIGZhaWxTdGF0ZSwgZm4pIHsKICBpZiAodHlwZW9mIGFjY2VwdFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICBmbiA9IGFjY2VwdFN0YXRlOyBhY2NlcHRTdGF0ZSA9IG51bGw7IGZhaWxTdGF0ZSA9IG51bGw7CiAgfSBlbHNlIGlmICh0eXBlb2YgZmFpbFN0YXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICBmbiA9IGZhaWxTdGF0ZTsgZmFpbFN0YXRlID0gbnVsbDsKICB9CgogIGlmICghdGhpcy5jdXJyZW50U3RhdGUpIHRoaXMuY3VycmVudFN0YXRlID0gbmFtZTsKICB0aGlzLnN0YXRlc1tuYW1lXSA9IHsgYWNjZXB0OiBhY2NlcHRTdGF0ZSwgZmFpbDogZmFpbFN0YXRlLCBmbjogZm4gfTsKICByZXR1cm4gdGhpczsKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gQWNjZXB0b3JTdGF0ZU1hY2hpbmU7Cgp9LHt9XSw3MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2VzcyxzZXRJbW1lZGlhdGUpeyhmdW5jdGlvbiAoKXsKLyogZXNsaW50IGd1YXJkLWZvci1pbjowICovCnZhciBBV1M7CgovKioKICogQSBzZXQgb2YgdXRpbGl0eSBtZXRob2RzIGZvciB1c2Ugd2l0aCB0aGUgQVdTIFNESy4KICoKICogQCFhdHRyaWJ1dGUgYWJvcnQKICogICBSZXR1cm4gdGhpcyB2YWx1ZSBmcm9tIGFuIGl0ZXJhdG9yIGZ1bmN0aW9uIHtlYWNofSBvciB7YXJyYXlFYWNofQogKiAgIHRvIGJyZWFrIG91dCBvZiB0aGUgaXRlcmF0aW9uLgogKiAgIEBleGFtcGxlIEJyZWFraW5nIG91dCBvZiBhbiBpdGVyYXRvciBmdW5jdGlvbgogKiAgICAgQVdTLnV0aWwuZWFjaCh7YTogMSwgYjogMiwgYzogM30sIGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICogICAgICAgaWYgKGtleSA9PSAnYicpIHJldHVybiBBV1MudXRpbC5hYm9ydDsKICogICAgIH0pOwogKiAgIEBzZWUgZWFjaAogKiAgIEBzZWUgYXJyYXlFYWNoCiAqIEBhcGkgcHJpdmF0ZQogKi8KdmFyIHV0aWwgPSB7CiAgZW52aXJvbm1lbnQ6ICdub2RlanMnLAogIGVuZ2luZTogZnVuY3Rpb24gZW5naW5lKCkgewogICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICB9IGVsc2UgewogICAgICB2YXIgZW5naW5lID0gcHJvY2Vzcy5wbGF0Zm9ybSArICcvJyArIHByb2Nlc3MudmVyc2lvbjsKICAgICAgaWYgKHByb2Nlc3MuZW52LkFXU19FWEVDVVRJT05fRU5WKSB7CiAgICAgICAgZW5naW5lICs9ICcgZXhlYy1lbnYvJyArIHByb2Nlc3MuZW52LkFXU19FWEVDVVRJT05fRU5WOwogICAgICB9CiAgICAgIHJldHVybiBlbmdpbmU7CiAgICB9CiAgfSwKCiAgdXNlckFnZW50OiBmdW5jdGlvbiB1c2VyQWdlbnQoKSB7CiAgICB2YXIgbmFtZSA9IHV0aWwuZW52aXJvbm1lbnQ7CiAgICB2YXIgYWdlbnQgPSAnYXdzLXNkay0nICsgbmFtZSArICcvJyArIHJlcXVpcmUoJy4vY29yZScpLlZFUlNJT047CiAgICBpZiAobmFtZSA9PT0gJ25vZGVqcycpIGFnZW50ICs9ICcgJyArIHV0aWwuZW5naW5lKCk7CiAgICByZXR1cm4gYWdlbnQ7CiAgfSwKCiAgdXJpRXNjYXBlOiBmdW5jdGlvbiB1cmlFc2NhcGUoc3RyaW5nKSB7CiAgICB2YXIgb3V0cHV0ID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZyk7CiAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvW15BLVphLXowLTlfLn5cLSVdKy9nLCBlc2NhcGUpOwoKICAgIC8vIEFXUyBwZXJjZW50LWVuY29kZXMgc29tZSBleHRyYSBub24tc3RhbmRhcmQgY2hhcmFjdGVycyBpbiBhIFVSSQogICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoL1sqXS9nLCBmdW5jdGlvbihjaCkgewogICAgICByZXR1cm4gJyUnICsgY2guY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsKICAgIH0pOwoKICAgIHJldHVybiBvdXRwdXQ7CiAgfSwKCiAgdXJpRXNjYXBlUGF0aDogZnVuY3Rpb24gdXJpRXNjYXBlUGF0aChzdHJpbmcpIHsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgdXRpbC5hcnJheUVhY2goc3RyaW5nLnNwbGl0KCcvJyksIGZ1bmN0aW9uIChwYXJ0KSB7CiAgICAgIHBhcnRzLnB1c2godXRpbC51cmlFc2NhcGUocGFydCkpOwogICAgfSk7CiAgICByZXR1cm4gcGFydHMuam9pbignLycpOwogIH0sCgogIHVybFBhcnNlOiBmdW5jdGlvbiB1cmxQYXJzZSh1cmwpIHsKICAgIHJldHVybiB1dGlsLnVybC5wYXJzZSh1cmwpOwogIH0sCgogIHVybEZvcm1hdDogZnVuY3Rpb24gdXJsRm9ybWF0KHVybCkgewogICAgcmV0dXJuIHV0aWwudXJsLmZvcm1hdCh1cmwpOwogIH0sCgogIHF1ZXJ5U3RyaW5nUGFyc2U6IGZ1bmN0aW9uIHF1ZXJ5U3RyaW5nUGFyc2UocXMpIHsKICAgIHJldHVybiB1dGlsLnF1ZXJ5c3RyaW5nLnBhcnNlKHFzKTsKICB9LAoKICBxdWVyeVBhcmFtc1RvU3RyaW5nOiBmdW5jdGlvbiBxdWVyeVBhcmFtc1RvU3RyaW5nKHBhcmFtcykgewogICAgdmFyIGl0ZW1zID0gW107CiAgICB2YXIgZXNjYXBlID0gdXRpbC51cmlFc2NhcGU7CiAgICB2YXIgc29ydGVkS2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcykuc29ydCgpOwoKICAgIHV0aWwuYXJyYXlFYWNoKHNvcnRlZEtleXMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIHZhbHVlID0gcGFyYW1zW25hbWVdOwogICAgICB2YXIgZW5hbWUgPSBlc2NhcGUobmFtZSk7CiAgICAgIHZhciByZXN1bHQgPSBlbmFtZSArICc9JzsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgdmFyIHZhbHMgPSBbXTsKICAgICAgICB1dGlsLmFycmF5RWFjaCh2YWx1ZSwgZnVuY3Rpb24oaXRlbSkgeyB2YWxzLnB1c2goZXNjYXBlKGl0ZW0pKTsgfSk7CiAgICAgICAgcmVzdWx0ID0gZW5hbWUgKyAnPScgKyB2YWxzLnNvcnQoKS5qb2luKCcmJyArIGVuYW1lICsgJz0nKTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgcmVzdWx0ID0gZW5hbWUgKyAnPScgKyBlc2NhcGUodmFsdWUpOwogICAgICB9CiAgICAgIGl0ZW1zLnB1c2gocmVzdWx0KTsKICAgIH0pOwoKICAgIHJldHVybiBpdGVtcy5qb2luKCcmJyk7CiAgfSwKCiAgcmVhZEZpbGVTeW5jOiBmdW5jdGlvbiByZWFkRmlsZVN5bmMocGF0aCkgewogICAgaWYgKHV0aWwuaXNCcm93c2VyKCkpIHJldHVybiBudWxsOwogICAgcmV0dXJuIHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHBhdGgsICd1dGYtOCcpOwogIH0sCgogIGJhc2U2NDogewogICAgZW5jb2RlOiBmdW5jdGlvbiBlbmNvZGU2NChzdHJpbmcpIHsKICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdudW1iZXInKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBiYXNlNjQgZW5jb2RlIG51bWJlciAnICsgc3RyaW5nKSk7CiAgICAgIH0KICAgICAgaWYgKHN0cmluZyA9PT0gbnVsbCB8fCB0eXBlb2Ygc3RyaW5nID09PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBzdHJpbmc7CiAgICAgIH0KICAgICAgdmFyIGJ1ZiA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKHN0cmluZyk7CiAgICAgIHJldHVybiBidWYudG9TdHJpbmcoJ2Jhc2U2NCcpOwogICAgfSwKCiAgICBkZWNvZGU6IGZ1bmN0aW9uIGRlY29kZTY0KHN0cmluZykgewogICAgICBpZiAodHlwZW9mIHN0cmluZyA9PT0gJ251bWJlcicpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignQ2Fubm90IGJhc2U2NCBkZWNvZGUgbnVtYmVyICcgKyBzdHJpbmcpKTsKICAgICAgfQogICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHR5cGVvZiBzdHJpbmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZzsKICAgICAgfQogICAgICByZXR1cm4gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nLCAnYmFzZTY0Jyk7CiAgICB9CgogIH0sCgogIGJ1ZmZlcjogewogICAgLyoqCiAgICAgKiBCdWZmZXIgY29uc3RydWN0b3IgZm9yIE5vZGUgYnVmZmVyIGFuZCBidWZmZXIgcG9sbHlmaWxsCiAgICAgKi8KICAgIHRvQnVmZmVyOiBmdW5jdGlvbihkYXRhLCBlbmNvZGluZykgewogICAgICByZXR1cm4gKHR5cGVvZiB1dGlsLkJ1ZmZlci5mcm9tID09PSAnZnVuY3Rpb24nICYmIHV0aWwuQnVmZmVyLmZyb20gIT09IFVpbnQ4QXJyYXkuZnJvbSkgPwogICAgICAgIHV0aWwuQnVmZmVyLmZyb20oZGF0YSwgZW5jb2RpbmcpIDogbmV3IHV0aWwuQnVmZmVyKGRhdGEsIGVuY29kaW5nKTsKICAgIH0sCgogICAgYWxsb2M6IGZ1bmN0aW9uKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NpemUgcGFzc2VkIHRvIGFsbG9jIG11c3QgYmUgYSBudW1iZXIuJyk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB1dGlsLkJ1ZmZlci5hbGxvYyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiB1dGlsLkJ1ZmZlci5hbGxvYyhzaXplLCBmaWxsLCBlbmNvZGluZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGJ1ZiA9IG5ldyB1dGlsLkJ1ZmZlcihzaXplKTsKICAgICAgICBpZiAoZmlsbCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBidWYuZmlsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgYnVmLmZpbGwoZmlsbCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGVuY29kaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1ZjsKICAgICAgfQogICAgfSwKCiAgICB0b1N0cmVhbTogZnVuY3Rpb24gdG9TdHJlYW0oYnVmZmVyKSB7CiAgICAgIGlmICghdXRpbC5CdWZmZXIuaXNCdWZmZXIoYnVmZmVyKSkgYnVmZmVyID0gIHV0aWwuYnVmZmVyLnRvQnVmZmVyKGJ1ZmZlcik7CgogICAgICB2YXIgcmVhZGFibGUgPSBuZXcgKHV0aWwuc3RyZWFtLlJlYWRhYmxlKSgpOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgcmVhZGFibGUuX3JlYWQgPSBmdW5jdGlvbihzaXplKSB7CiAgICAgICAgaWYgKHBvcyA+PSBidWZmZXIubGVuZ3RoKSByZXR1cm4gcmVhZGFibGUucHVzaChudWxsKTsKCiAgICAgICAgdmFyIGVuZCA9IHBvcyArIHNpemU7CiAgICAgICAgaWYgKGVuZCA+IGJ1ZmZlci5sZW5ndGgpIGVuZCA9IGJ1ZmZlci5sZW5ndGg7CiAgICAgICAgcmVhZGFibGUucHVzaChidWZmZXIuc2xpY2UocG9zLCBlbmQpKTsKICAgICAgICBwb3MgPSBlbmQ7CiAgICAgIH07CgogICAgICByZXR1cm4gcmVhZGFibGU7CiAgICB9LAoKICAgIC8qKgogICAgICogQ29uY2F0ZW5hdGVzIGEgbGlzdCBvZiBCdWZmZXIgb2JqZWN0cy4KICAgICAqLwogICAgY29uY2F0OiBmdW5jdGlvbihidWZmZXJzKSB7CiAgICAgIHZhciBsZW5ndGggPSAwLAogICAgICAgICAgb2Zmc2V0ID0gMCwKICAgICAgICAgIGJ1ZmZlciA9IG51bGwsIGk7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgYnVmZmVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGxlbmd0aCArPSBidWZmZXJzW2ldLmxlbmd0aDsKICAgICAgfQoKICAgICAgYnVmZmVyID0gdXRpbC5idWZmZXIuYWxsb2MobGVuZ3RoKTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBidWZmZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgYnVmZmVyc1tpXS5jb3B5KGJ1ZmZlciwgb2Zmc2V0KTsKICAgICAgICBvZmZzZXQgKz0gYnVmZmVyc1tpXS5sZW5ndGg7CiAgICAgIH0KCiAgICAgIHJldHVybiBidWZmZXI7CiAgICB9CiAgfSwKCiAgc3RyaW5nOiB7CiAgICBieXRlTGVuZ3RoOiBmdW5jdGlvbiBieXRlTGVuZ3RoKHN0cmluZykgewogICAgICBpZiAoc3RyaW5nID09PSBudWxsIHx8IHN0cmluZyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gMDsKICAgICAgaWYgKHR5cGVvZiBzdHJpbmcgPT09ICdzdHJpbmcnKSBzdHJpbmcgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihzdHJpbmcpOwoKICAgICAgaWYgKHR5cGVvZiBzdHJpbmcuYnl0ZUxlbmd0aCA9PT0gJ251bWJlcicpIHsKICAgICAgICByZXR1cm4gc3RyaW5nLmJ5dGVMZW5ndGg7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5sZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIHN0cmluZy5sZW5ndGg7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0cmluZy5zaXplID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiBzdHJpbmcuc2l6ZTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3RyaW5nLnBhdGggPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIHJlcXVpcmUoJ2ZzJykubHN0YXRTeW5jKHN0cmluZy5wYXRoKS5zaXplOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IHV0aWwuZXJyb3IobmV3IEVycm9yKCdDYW5ub3QgZGV0ZXJtaW5lIGxlbmd0aCBvZiAnICsgc3RyaW5nKSwKICAgICAgICAgIHsgb2JqZWN0OiBzdHJpbmcgfSk7CiAgICAgIH0KICAgIH0sCgogICAgdXBwZXJGaXJzdDogZnVuY3Rpb24gdXBwZXJGaXJzdChzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZ1swXS50b1VwcGVyQ2FzZSgpICsgc3RyaW5nLnN1YnN0cigxKTsKICAgIH0sCgogICAgbG93ZXJGaXJzdDogZnVuY3Rpb24gbG93ZXJGaXJzdChzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZ1swXS50b0xvd2VyQ2FzZSgpICsgc3RyaW5nLnN1YnN0cigxKTsKICAgIH0KICB9LAoKICBpbmk6IHsKICAgIHBhcnNlOiBmdW5jdGlvbiBzdHJpbmcoaW5pKSB7CiAgICAgIHZhciBjdXJyZW50U2VjdGlvbiwgbWFwID0ge307CiAgICAgIHV0aWwuYXJyYXlFYWNoKGluaS5zcGxpdCgvXHI/XG4vKSwgZnVuY3Rpb24obGluZSkgewogICAgICAgIGxpbmUgPSBsaW5lLnNwbGl0KC8oXnxccylbOyNdLylbMF0udHJpbSgpOyAvLyByZW1vdmUgY29tbWVudHMgYW5kIHRyaW0KICAgICAgICB2YXIgaXNTZWN0aW9uID0gbGluZVswXSA9PT0gJ1snICYmIGxpbmVbbGluZS5sZW5ndGggLSAxXSA9PT0gJ10nOwogICAgICAgIGlmIChpc1NlY3Rpb24pIHsKICAgICAgICAgIGN1cnJlbnRTZWN0aW9uID0gbGluZS5zdWJzdHJpbmcoMSwgbGluZS5sZW5ndGggLSAxKTsKICAgICAgICAgIGlmIChjdXJyZW50U2VjdGlvbiA9PT0gJ19fcHJvdG9fXycgfHwgY3VycmVudFNlY3Rpb24uc3BsaXQoL1xzLylbMV0gPT09ICdfX3Byb3RvX18nKSB7CiAgICAgICAgICAgIHRocm93IHV0aWwuZXJyb3IoCiAgICAgICAgICAgICAgbmV3IEVycm9yKCdDYW5ub3QgbG9hZCBwcm9maWxlIG5hbWUgXCcnICsgY3VycmVudFNlY3Rpb24gKyAnXCcgZnJvbSBzaGFyZWQgaW5pIGZpbGUuJykKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTZWN0aW9uKSB7CiAgICAgICAgICB2YXIgaW5kZXhPZkVxdWFsc1NpZ24gPSBsaW5lLmluZGV4T2YoJz0nKTsKICAgICAgICAgIHZhciBzdGFydCA9IDA7CiAgICAgICAgICB2YXIgZW5kID0gbGluZS5sZW5ndGggLSAxOwogICAgICAgICAgdmFyIGlzQXNzaWdubWVudCA9CiAgICAgICAgICAgIGluZGV4T2ZFcXVhbHNTaWduICE9PSAtMSAmJiBpbmRleE9mRXF1YWxzU2lnbiAhPT0gc3RhcnQgJiYgaW5kZXhPZkVxdWFsc1NpZ24gIT09IGVuZDsKCiAgICAgICAgICBpZiAoaXNBc3NpZ25tZW50KSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gbGluZS5zdWJzdHJpbmcoMCwgaW5kZXhPZkVxdWFsc1NpZ24pLnRyaW0oKTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gbGluZS5zdWJzdHJpbmcoaW5kZXhPZkVxdWFsc1NpZ24gKyAxKS50cmltKCk7CgogICAgICAgICAgICBtYXBbY3VycmVudFNlY3Rpb25dID0gbWFwW2N1cnJlbnRTZWN0aW9uXSB8fCB7fTsKICAgICAgICAgICAgbWFwW2N1cnJlbnRTZWN0aW9uXVtuYW1lXSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gbWFwOwogICAgfQogIH0sCgogIGZuOiB7CiAgICBub29wOiBmdW5jdGlvbigpIHt9LAogICAgY2FsbGJhY2s6IGZ1bmN0aW9uIChlcnIpIHsgaWYgKGVycikgdGhyb3cgZXJyOyB9LAoKICAgIC8qKgogICAgICogVHVybiBhIHN5bmNocm9ub3VzIGZ1bmN0aW9uIGludG8gYXMgImFzeW5jIiBmdW5jdGlvbiBieSBtYWtpbmcgaXQgY2FsbAogICAgICogYSBjYWxsYmFjay4gVGhlIHVuZGVybHlpbmcgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGggYWxsIGJ1dCB0aGUgbGFzdCBhcmd1bWVudCwKICAgICAqIHdoaWNoIGlzIHRyZWF0ZWQgYXMgdGhlIGNhbGxiYWNrLiBUaGUgY2FsbGJhY2sgaXMgcGFzc2VkIHBhc3NlZCBhIGZpcnN0IGFyZ3VtZW50CiAgICAgKiBvZiBudWxsIG9uIHN1Y2Nlc3MgdG8gbWltaWNrIHN0YW5kYXJkIG5vZGUgY2FsbGJhY2tzLgogICAgICovCiAgICBtYWtlQXN5bmM6IGZ1bmN0aW9uIG1ha2VBc3luYyhmbiwgZXhwZWN0ZWRBcmdzKSB7CiAgICAgIGlmIChleHBlY3RlZEFyZ3MgJiYgZXhwZWN0ZWRBcmdzIDw9IGZuLmxlbmd0aCkgewogICAgICAgIHJldHVybiBmbjsKICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBhcmdzLnBvcCgpOwogICAgICAgIHZhciByZXN1bHQgPSBmbi5hcHBseShudWxsLCBhcmdzKTsKICAgICAgICBjYWxsYmFjayhyZXN1bHQpOwogICAgICB9OwogICAgfQogIH0sCgogIC8qKgogICAqIERhdGUgYW5kIHRpbWUgdXRpbGl0eSBmdW5jdGlvbnMuCiAgICovCiAgZGF0ZTogewoKICAgIC8qKgogICAgICogQHJldHVybiBbRGF0ZV0gdGhlIGN1cnJlbnQgSmF2YVNjcmlwdCBkYXRlIG9iamVjdC4gU2luY2UgYWxsCiAgICAgKiAgIEFXUyBzZXJ2aWNlcyByZWx5IG9uIHRoaXMgZGF0ZSBvYmplY3QsIHlvdSBjYW4gb3ZlcnJpZGUKICAgICAqICAgdGhpcyBmdW5jdGlvbiB0byBwcm92aWRlIGEgc3BlY2lhbCB0aW1lIHZhbHVlIHRvIEFXUyBzZXJ2aWNlCiAgICAgKiAgIHJlcXVlc3RzLgogICAgICovCiAgICBnZXREYXRlOiBmdW5jdGlvbiBnZXREYXRlKCkgewogICAgICBpZiAoIUFXUykgQVdTID0gcmVxdWlyZSgnLi9jb3JlJyk7CiAgICAgIGlmIChBV1MuY29uZmlnLnN5c3RlbUNsb2NrT2Zmc2V0KSB7IC8vIHVzZSBvZmZzZXQgd2hlbiBub24temVybwogICAgICAgIHJldHVybiBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArIEFXUy5jb25maWcuc3lzdGVtQ2xvY2tPZmZzZXQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgRGF0ZSgpOwogICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiBbU3RyaW5nXSB0aGUgZGF0ZSBpbiBJU08tODYwMSBmb3JtYXQKICAgICAqLwogICAgaXNvODYwMTogZnVuY3Rpb24gaXNvODYwMShkYXRlKSB7CiAgICAgIGlmIChkYXRlID09PSB1bmRlZmluZWQpIHsgZGF0ZSA9IHV0aWwuZGF0ZS5nZXREYXRlKCk7IH0KICAgICAgcmV0dXJuIGRhdGUudG9JU09TdHJpbmcoKS5yZXBsYWNlKC9cLlxkezN9WiQvLCAnWicpOwogICAgfSwKCiAgICAvKioKICAgICAqIEByZXR1cm4gW1N0cmluZ10gdGhlIGRhdGUgaW4gUkZDIDgyMiBmb3JtYXQKICAgICAqLwogICAgcmZjODIyOiBmdW5jdGlvbiByZmM4MjIoZGF0ZSkgewogICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgIHJldHVybiBkYXRlLnRvVVRDU3RyaW5nKCk7CiAgICB9LAoKICAgIC8qKgogICAgICogQHJldHVybiBbSW50ZWdlcl0gdGhlIFVOSVggdGltZXN0YW1wIHZhbHVlIGZvciB0aGUgY3VycmVudCB0aW1lCiAgICAgKi8KICAgIHVuaXhUaW1lc3RhbXA6IGZ1bmN0aW9uIHVuaXhUaW1lc3RhbXAoZGF0ZSkgewogICAgICBpZiAoZGF0ZSA9PT0gdW5kZWZpbmVkKSB7IGRhdGUgPSB1dGlsLmRhdGUuZ2V0RGF0ZSgpOyB9CiAgICAgIHJldHVybiBkYXRlLmdldFRpbWUoKSAvIDEwMDA7CiAgICB9LAoKICAgIC8qKgogICAgICogQHBhcmFtIFtTdHJpbmcsbnVtYmVyLERhdGVdIGRhdGUKICAgICAqIEByZXR1cm4gW0RhdGVdCiAgICAgKi8KICAgIGZyb206IGZ1bmN0aW9uIGZvcm1hdChkYXRlKSB7CiAgICAgIGlmICh0eXBlb2YgZGF0ZSA9PT0gJ251bWJlcicpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSAqIDEwMDApOyAvLyB1bml4IHRpbWVzdGFtcAogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgRGF0ZShkYXRlKTsKICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIEdpdmVuIGEgRGF0ZSBvciBkYXRlLWxpa2UgdmFsdWUsIHRoaXMgZnVuY3Rpb24gZm9ybWF0cyB0aGUKICAgICAqIGRhdGUgaW50byBhIHN0cmluZyBvZiB0aGUgcmVxdWVzdGVkIHZhbHVlLgogICAgICogQHBhcmFtIFtTdHJpbmcsbnVtYmVyLERhdGVdIGRhdGUKICAgICAqIEBwYXJhbSBbU3RyaW5nXSBmb3JtYXR0ZXIgVmFsaWQgZm9ybWF0cyBhcmU6CiAgICAgIyAgICogJ2lzbzg2MDEnCiAgICAgIyAgICogJ3JmYzgyMicKICAgICAjICAgKiAndW5peFRpbWVzdGFtcCcKICAgICAqIEByZXR1cm4gW1N0cmluZ10KICAgICAqLwogICAgZm9ybWF0OiBmdW5jdGlvbiBmb3JtYXQoZGF0ZSwgZm9ybWF0dGVyKSB7CiAgICAgIGlmICghZm9ybWF0dGVyKSBmb3JtYXR0ZXIgPSAnaXNvODYwMSc7CiAgICAgIHJldHVybiB1dGlsLmRhdGVbZm9ybWF0dGVyXSh1dGlsLmRhdGUuZnJvbShkYXRlKSk7CiAgICB9LAoKICAgIHBhcnNlVGltZXN0YW1wOiBmdW5jdGlvbiBwYXJzZVRpbWVzdGFtcCh2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgeyAvLyB1bml4IHRpbWVzdGFtcCAobnVtYmVyKQogICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSAqIDEwMDApOwogICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXGQrJC8pKSB7IC8vIHVuaXggdGltZXN0YW1wCiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlICogMTAwMCk7CiAgICAgIH0gZWxzZSBpZiAodmFsdWUubWF0Y2goL15cZHs0fS8pKSB7IC8vIGlzbzg2MDEKICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICB9IGVsc2UgaWYgKHZhbHVlLm1hdGNoKC9eXHd7M30sLykpIHsgLy8gcmZjODIyCiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKAogICAgICAgICAgbmV3IEVycm9yKCd1bmhhbmRsZWQgdGltZXN0YW1wIGZvcm1hdDogJyArIHZhbHVlKSwKICAgICAgICAgIHtjb2RlOiAnVGltZXN0YW1wUGFyc2VyRXJyb3InfSk7CiAgICAgIH0KICAgIH0KCiAgfSwKCiAgY3J5cHRvOiB7CiAgICBjcmMzMlRhYmxlOiBbCiAgICAgMHgwMDAwMDAwMCwgMHg3NzA3MzA5NiwgMHhFRTBFNjEyQywgMHg5OTA5NTFCQSwgMHgwNzZEQzQxOSwKICAgICAweDcwNkFGNDhGLCAweEU5NjNBNTM1LCAweDlFNjQ5NUEzLCAweDBFREI4ODMyLCAweDc5RENCOEE0LAogICAgIDB4RTBENUU5MUUsIDB4OTdEMkQ5ODgsIDB4MDlCNjRDMkIsIDB4N0VCMTdDQkQsIDB4RTdCODJEMDcsCiAgICAgMHg5MEJGMUQ5MSwgMHgxREI3MTA2NCwgMHg2QUIwMjBGMiwgMHhGM0I5NzE0OCwgMHg4NEJFNDFERSwKICAgICAweDFBREFENDdELCAweDZERERFNEVCLCAweEY0RDRCNTUxLCAweDgzRDM4NUM3LCAweDEzNkM5ODU2LAogICAgIDB4NjQ2QkE4QzAsIDB4RkQ2MkY5N0EsIDB4OEE2NUM5RUMsIDB4MTQwMTVDNEYsIDB4NjMwNjZDRDksCiAgICAgMHhGQTBGM0Q2MywgMHg4RDA4MERGNSwgMHgzQjZFMjBDOCwgMHg0QzY5MTA1RSwgMHhENTYwNDFFNCwKICAgICAweEEyNjc3MTcyLCAweDNDMDNFNEQxLCAweDRCMDRENDQ3LCAweEQyMEQ4NUZELCAweEE1MEFCNTZCLAogICAgIDB4MzVCNUE4RkEsIDB4NDJCMjk4NkMsIDB4REJCQkM5RDYsIDB4QUNCQ0Y5NDAsIDB4MzJEODZDRTMsCiAgICAgMHg0NURGNUM3NSwgMHhEQ0Q2MERDRiwgMHhBQkQxM0Q1OSwgMHgyNkQ5MzBBQywgMHg1MURFMDAzQSwKICAgICAweEM4RDc1MTgwLCAweEJGRDA2MTE2LCAweDIxQjRGNEI1LCAweDU2QjNDNDIzLCAweENGQkE5NTk5LAogICAgIDB4QjhCREE1MEYsIDB4MjgwMkI4OUUsIDB4NUYwNTg4MDgsIDB4QzYwQ0Q5QjIsIDB4QjEwQkU5MjQsCiAgICAgMHgyRjZGN0M4NywgMHg1ODY4NEMxMSwgMHhDMTYxMURBQiwgMHhCNjY2MkQzRCwgMHg3NkRDNDE5MCwKICAgICAweDAxREI3MTA2LCAweDk4RDIyMEJDLCAweEVGRDUxMDJBLCAweDcxQjE4NTg5LCAweDA2QjZCNTFGLAogICAgIDB4OUZCRkU0QTUsIDB4RThCOEQ0MzMsIDB4NzgwN0M5QTIsIDB4MEYwMEY5MzQsIDB4OTYwOUE4OEUsCiAgICAgMHhFMTBFOTgxOCwgMHg3RjZBMERCQiwgMHgwODZEM0QyRCwgMHg5MTY0NkM5NywgMHhFNjYzNUMwMSwKICAgICAweDZCNkI1MUY0LCAweDFDNkM2MTYyLCAweDg1NjUzMEQ4LCAweEYyNjIwMDRFLCAweDZDMDY5NUVELAogICAgIDB4MUIwMUE1N0IsIDB4ODIwOEY0QzEsIDB4RjUwRkM0NTcsIDB4NjVCMEQ5QzYsIDB4MTJCN0U5NTAsCiAgICAgMHg4QkJFQjhFQSwgMHhGQ0I5ODg3QywgMHg2MkREMURERiwgMHgxNURBMkQ0OSwgMHg4Q0QzN0NGMywKICAgICAweEZCRDQ0QzY1LCAweDREQjI2MTU4LCAweDNBQjU1MUNFLCAweEEzQkMwMDc0LCAweEQ0QkIzMEUyLAogICAgIDB4NEFERkE1NDEsIDB4M0REODk1RDcsIDB4QTREMUM0NkQsIDB4RDNENkY0RkIsIDB4NDM2OUU5NkEsCiAgICAgMHgzNDZFRDlGQywgMHhBRDY3ODg0NiwgMHhEQTYwQjhEMCwgMHg0NDA0MkQ3MywgMHgzMzAzMURFNSwKICAgICAweEFBMEE0QzVGLCAweEREMEQ3Q0M5LCAweDUwMDU3MTNDLCAweDI3MDI0MUFBLCAweEJFMEIxMDEwLAogICAgIDB4QzkwQzIwODYsIDB4NTc2OEI1MjUsIDB4MjA2Rjg1QjMsIDB4Qjk2NkQ0MDksIDB4Q0U2MUU0OUYsCiAgICAgMHg1RURFRjkwRSwgMHgyOUQ5Qzk5OCwgMHhCMEQwOTgyMiwgMHhDN0Q3QThCNCwgMHg1OUIzM0QxNywKICAgICAweDJFQjQwRDgxLCAweEI3QkQ1QzNCLCAweEMwQkE2Q0FELCAweEVEQjg4MzIwLCAweDlBQkZCM0I2LAogICAgIDB4MDNCNkUyMEMsIDB4NzRCMUQyOUEsIDB4RUFENTQ3MzksIDB4OUREMjc3QUYsIDB4MDREQjI2MTUsCiAgICAgMHg3M0RDMTY4MywgMHhFMzYzMEIxMiwgMHg5NDY0M0I4NCwgMHgwRDZENkEzRSwgMHg3QTZBNUFBOCwKICAgICAweEU0MEVDRjBCLCAweDkzMDlGRjlELCAweDBBMDBBRTI3LCAweDdEMDc5RUIxLCAweEYwMEY5MzQ0LAogICAgIDB4ODcwOEEzRDIsIDB4MUUwMUYyNjgsIDB4NjkwNkMyRkUsIDB4Rjc2MjU3NUQsIDB4ODA2NTY3Q0IsCiAgICAgMHgxOTZDMzY3MSwgMHg2RTZCMDZFNywgMHhGRUQ0MUI3NiwgMHg4OUQzMkJFMCwgMHgxMERBN0E1QSwKICAgICAweDY3REQ0QUNDLCAweEY5QjlERjZGLCAweDhFQkVFRkY5LCAweDE3QjdCRTQzLCAweDYwQjA4RUQ1LAogICAgIDB4RDZENkEzRTgsIDB4QTFEMTkzN0UsIDB4MzhEOEMyQzQsIDB4NEZERkYyNTIsIDB4RDFCQjY3RjEsCiAgICAgMHhBNkJDNTc2NywgMHgzRkI1MDZERCwgMHg0OEIyMzY0QiwgMHhEODBEMkJEQSwgMHhBRjBBMUI0QywKICAgICAweDM2MDM0QUY2LCAweDQxMDQ3QTYwLCAweERGNjBFRkMzLCAweEE4NjdERjU1LCAweDMxNkU4RUVGLAogICAgIDB4NDY2OUJFNzksIDB4Q0I2MUIzOEMsIDB4QkM2NjgzMUEsIDB4MjU2RkQyQTAsIDB4NTI2OEUyMzYsCiAgICAgMHhDQzBDNzc5NSwgMHhCQjBCNDcwMywgMHgyMjAyMTZCOSwgMHg1NTA1MjYyRiwgMHhDNUJBM0JCRSwKICAgICAweEIyQkQwQjI4LCAweDJCQjQ1QTkyLCAweDVDQjM2QTA0LCAweEMyRDdGRkE3LCAweEI1RDBDRjMxLAogICAgIDB4MkNEOTlFOEIsIDB4NUJERUFFMUQsIDB4OUI2NEMyQjAsIDB4RUM2M0YyMjYsIDB4NzU2QUEzOUMsCiAgICAgMHgwMjZEOTMwQSwgMHg5QzA5MDZBOSwgMHhFQjBFMzYzRiwgMHg3MjA3Njc4NSwgMHgwNTAwNTcxMywKICAgICAweDk1QkY0QTgyLCAweEUyQjg3QTE0LCAweDdCQjEyQkFFLCAweDBDQjYxQjM4LCAweDkyRDI4RTlCLAogICAgIDB4RTVENUJFMEQsIDB4N0NEQ0VGQjcsIDB4MEJEQkRGMjEsIDB4ODZEM0QyRDQsIDB4RjFENEUyNDIsCiAgICAgMHg2OEREQjNGOCwgMHgxRkRBODM2RSwgMHg4MUJFMTZDRCwgMHhGNkI5MjY1QiwgMHg2RkIwNzdFMSwKICAgICAweDE4Qjc0Nzc3LCAweDg4MDg1QUU2LCAweEZGMEY2QTcwLCAweDY2MDYzQkNBLCAweDExMDEwQjVDLAogICAgIDB4OEY2NTlFRkYsIDB4Rjg2MkFFNjksIDB4NjE2QkZGRDMsIDB4MTY2Q0NGNDUsIDB4QTAwQUUyNzgsCiAgICAgMHhENzBERDJFRSwgMHg0RTA0ODM1NCwgMHgzOTAzQjNDMiwgMHhBNzY3MjY2MSwgMHhEMDYwMTZGNywKICAgICAweDQ5Njk0NzRELCAweDNFNkU3N0RCLCAweEFFRDE2QTRBLCAweEQ5RDY1QURDLCAweDQwREYwQjY2LAogICAgIDB4MzdEODNCRjAsIDB4QTlCQ0FFNTMsIDB4REVCQjlFQzUsIDB4NDdCMkNGN0YsIDB4MzBCNUZGRTksCiAgICAgMHhCREJERjIxQywgMHhDQUJBQzI4QSwgMHg1M0IzOTMzMCwgMHgyNEI0QTNBNiwgMHhCQUQwMzYwNSwKICAgICAweENERDcwNjkzLCAweDU0REU1NzI5LCAweDIzRDk2N0JGLCAweEIzNjY3QTJFLCAweEM0NjE0QUI4LAogICAgIDB4NUQ2ODFCMDIsIDB4MkE2RjJCOTQsIDB4QjQwQkJFMzcsIDB4QzMwQzhFQTEsIDB4NUEwNURGMUIsCiAgICAgMHgyRDAyRUY4RF0sCgogICAgY3JjMzI6IGZ1bmN0aW9uIGNyYzMyKGRhdGEpIHsKICAgICAgdmFyIHRibCA9IHV0aWwuY3J5cHRvLmNyYzMyVGFibGU7CiAgICAgIHZhciBjcmMgPSAwIF4gLTE7CgogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZGF0YSA9IHV0aWwuYnVmZmVyLnRvQnVmZmVyKGRhdGEpOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgY29kZSA9IGRhdGEucmVhZFVJbnQ4KGkpOwogICAgICAgIGNyYyA9IChjcmMgPj4+IDgpIF4gdGJsWyhjcmMgXiBjb2RlKSAmIDB4RkZdOwogICAgICB9CiAgICAgIHJldHVybiAoY3JjIF4gLTEpID4+PiAwOwogICAgfSwKCiAgICBobWFjOiBmdW5jdGlvbiBobWFjKGtleSwgc3RyaW5nLCBkaWdlc3QsIGZuKSB7CiAgICAgIGlmICghZGlnZXN0KSBkaWdlc3QgPSAnYmluYXJ5JzsKICAgICAgaWYgKGRpZ2VzdCA9PT0gJ2J1ZmZlcicpIHsgZGlnZXN0ID0gdW5kZWZpbmVkOyB9CiAgICAgIGlmICghZm4pIGZuID0gJ3NoYTI1Nic7CiAgICAgIGlmICh0eXBlb2Ygc3RyaW5nID09PSAnc3RyaW5nJykgc3RyaW5nID0gdXRpbC5idWZmZXIudG9CdWZmZXIoc3RyaW5nKTsKICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmxpYi5jcmVhdGVIbWFjKGZuLCBrZXkpLnVwZGF0ZShzdHJpbmcpLmRpZ2VzdChkaWdlc3QpOwogICAgfSwKCiAgICBtZDU6IGZ1bmN0aW9uIG1kNShkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB1dGlsLmNyeXB0by5oYXNoKCdtZDUnLCBkYXRhLCBkaWdlc3QsIGNhbGxiYWNrKTsKICAgIH0sCgogICAgc2hhMjU2OiBmdW5jdGlvbiBzaGEyNTYoZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdXRpbC5jcnlwdG8uaGFzaCgnc2hhMjU2JywgZGF0YSwgZGlnZXN0LCBjYWxsYmFjayk7CiAgICB9LAoKICAgIGhhc2g6IGZ1bmN0aW9uKGFsZ29yaXRobSwgZGF0YSwgZGlnZXN0LCBjYWxsYmFjaykgewogICAgICB2YXIgaGFzaCA9IHV0aWwuY3J5cHRvLmNyZWF0ZUhhc2goYWxnb3JpdGhtKTsKICAgICAgaWYgKCFkaWdlc3QpIHsgZGlnZXN0ID0gJ2JpbmFyeSc7IH0KICAgICAgaWYgKGRpZ2VzdCA9PT0gJ2J1ZmZlcicpIHsgZGlnZXN0ID0gdW5kZWZpbmVkOyB9CiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIGRhdGEgPSB1dGlsLmJ1ZmZlci50b0J1ZmZlcihkYXRhKTsKICAgICAgdmFyIHNsaWNlRm4gPSB1dGlsLmFycmF5U2xpY2VGbihkYXRhKTsKICAgICAgdmFyIGlzQnVmZmVyID0gdXRpbC5CdWZmZXIuaXNCdWZmZXIoZGF0YSk7CiAgICAgIC8vSWRlbnRpZnlpbmcgb2JqZWN0cyB3aXRoIGFuIEFycmF5QnVmZmVyIGFzIGJ1ZmZlcnMKICAgICAgaWYgKHV0aWwuaXNCcm93c2VyKCkgJiYgdHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiBkYXRhICYmIGRhdGEuYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIGlzQnVmZmVyID0gdHJ1ZTsKCiAgICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgIHR5cGVvZiBkYXRhLm9uID09PSAnZnVuY3Rpb24nICYmICFpc0J1ZmZlcikgewogICAgICAgIGRhdGEub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgeyBoYXNoLnVwZGF0ZShjaHVuayk7IH0pOwogICAgICAgIGRhdGEub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7IGNhbGxiYWNrKGVycik7IH0pOwogICAgICAgIGRhdGEub24oJ2VuZCcsIGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhudWxsLCBoYXNoLmRpZ2VzdChkaWdlc3QpKTsgfSk7CiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2sgJiYgc2xpY2VGbiAmJiAhaXNCdWZmZXIgJiYKICAgICAgICAgICAgICAgICB0eXBlb2YgRmlsZVJlYWRlciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAvLyB0aGlzIG1pZ2h0IGJlIGEgRmlsZS9CbG9iCiAgICAgICAgdmFyIGluZGV4ID0gMCwgc2l6ZSA9IDEwMjQgKiA1MTI7CiAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgcmVhZGVyLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcignRmFpbGVkIHRvIHJlYWQgZGF0YS4nKSk7CiAgICAgICAgfTsKICAgICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYnVmID0gbmV3IHV0aWwuQnVmZmVyKG5ldyBVaW50OEFycmF5KHJlYWRlci5yZXN1bHQpKTsKICAgICAgICAgIGhhc2gudXBkYXRlKGJ1Zik7CiAgICAgICAgICBpbmRleCArPSBidWYubGVuZ3RoOwogICAgICAgICAgcmVhZGVyLl9jb250aW51ZVJlYWRpbmcoKTsKICAgICAgICB9OwogICAgICAgIHJlYWRlci5fY29udGludWVSZWFkaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoaW5kZXggPj0gZGF0YS5zaXplKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGhhc2guZGlnZXN0KGRpZ2VzdCkpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGJhY2sgPSBpbmRleCArIHNpemU7CiAgICAgICAgICBpZiAoYmFjayA+IGRhdGEuc2l6ZSkgYmFjayA9IGRhdGEuc2l6ZTsKICAgICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihzbGljZUZuLmNhbGwoZGF0YSwgaW5kZXgsIGJhY2spKTsKICAgICAgICB9OwoKICAgICAgICByZWFkZXIuX2NvbnRpbnVlUmVhZGluZygpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh1dGlsLmlzQnJvd3NlcigpICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiAhaXNCdWZmZXIpIHsKICAgICAgICAgIGRhdGEgPSBuZXcgdXRpbC5CdWZmZXIobmV3IFVpbnQ4QXJyYXkoZGF0YSkpOwogICAgICAgIH0KICAgICAgICB2YXIgb3V0ID0gaGFzaC51cGRhdGUoZGF0YSkuZGlnZXN0KGRpZ2VzdCk7CiAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsLCBvdXQpOwogICAgICAgIHJldHVybiBvdXQ7CiAgICAgIH0KICAgIH0sCgogICAgdG9IZXg6IGZ1bmN0aW9uIHRvSGV4KGRhdGEpIHsKICAgICAgdmFyIG91dCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICBvdXQucHVzaCgoJzAnICsgZGF0YS5jaGFyQ29kZUF0KGkpLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC0yLCAyKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG91dC5qb2luKCcnKTsKICAgIH0sCgogICAgY3JlYXRlSGFzaDogZnVuY3Rpb24gY3JlYXRlSGFzaChhbGdvcml0aG0pIHsKICAgICAgcmV0dXJuIHV0aWwuY3J5cHRvLmxpYi5jcmVhdGVIYXNoKGFsZ29yaXRobSk7CiAgICB9CgogIH0sCgogIC8qKiBAIWlnbm9yZSAqLwoKICAvKiBBYm9ydCBjb25zdGFudCAqLwogIGFib3J0OiB7fSwKCiAgZWFjaDogZnVuY3Rpb24gZWFjaChvYmplY3QsIGl0ZXJGdW5jdGlvbikgewogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgewogICAgICAgIHZhciByZXQgPSBpdGVyRnVuY3Rpb24uY2FsbCh0aGlzLCBrZXksIG9iamVjdFtrZXldKTsKICAgICAgICBpZiAocmV0ID09PSB1dGlsLmFib3J0KSBicmVhazsKICAgICAgfQogICAgfQogIH0sCgogIGFycmF5RWFjaDogZnVuY3Rpb24gYXJyYXlFYWNoKGFycmF5LCBpdGVyRnVuY3Rpb24pIHsKICAgIGZvciAodmFyIGlkeCBpbiBhcnJheSkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGFycmF5LCBpZHgpKSB7CiAgICAgICAgdmFyIHJldCA9IGl0ZXJGdW5jdGlvbi5jYWxsKHRoaXMsIGFycmF5W2lkeF0sIHBhcnNlSW50KGlkeCwgMTApKTsKICAgICAgICBpZiAocmV0ID09PSB1dGlsLmFib3J0KSBicmVhazsKICAgICAgfQogICAgfQogIH0sCgogIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9iajEsIG9iajIpIHsKICAgIHV0aWwuZWFjaChvYmoyLCBmdW5jdGlvbiBpdGVyYXRvcihrZXksIGl0ZW0pIHsKICAgICAgb2JqMVtrZXldID0gaXRlbTsKICAgIH0pOwogICAgcmV0dXJuIG9iajE7CiAgfSwKCiAgbWVyZ2U6IGZ1bmN0aW9uIG1lcmdlKG9iajEsIG9iajIpIHsKICAgIHJldHVybiB1dGlsLnVwZGF0ZSh1dGlsLmNvcHkob2JqMSksIG9iajIpOwogIH0sCgogIGNvcHk6IGZ1bmN0aW9uIGNvcHkob2JqZWN0KSB7CiAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IG9iamVjdCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gb2JqZWN0OwogICAgdmFyIGR1cGUgPSB7fTsKICAgIC8vIGpzaGludCBmb3JpbjpmYWxzZQogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgewogICAgICBkdXBlW2tleV0gPSBvYmplY3Rba2V5XTsKICAgIH0KICAgIHJldHVybiBkdXBlOwogIH0sCgogIGlzRW1wdHk6IGZ1bmN0aW9uIGlzRW1wdHkob2JqKSB7CiAgICBmb3IgKHZhciBwcm9wIGluIG9iaikgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCgogIGFycmF5U2xpY2VGbjogZnVuY3Rpb24gYXJyYXlTbGljZUZuKG9iaikgewogICAgdmFyIGZuID0gb2JqLnNsaWNlIHx8IG9iai53ZWJraXRTbGljZSB8fCBvYmoubW96U2xpY2U7CiAgICByZXR1cm4gdHlwZW9mIGZuID09PSAnZnVuY3Rpb24nID8gZm4gOiBudWxsOwogIH0sCgogIGlzVHlwZTogZnVuY3Rpb24gaXNUeXBlKG9iaiwgdHlwZSkgewogICAgLy8gaGFuZGxlIGNyb3NzLSJmcmFtZSIgb2JqZWN0cwogICAgaWYgKHR5cGVvZiB0eXBlID09PSAnZnVuY3Rpb24nKSB0eXBlID0gdXRpbC50eXBlTmFtZSh0eXBlKTsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgJyArIHR5cGUgKyAnXSc7CiAgfSwKCiAgdHlwZU5hbWU6IGZ1bmN0aW9uIHR5cGVOYW1lKHR5cGUpIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodHlwZSwgJ25hbWUnKSkgcmV0dXJuIHR5cGUubmFtZTsKICAgIHZhciBzdHIgPSB0eXBlLnRvU3RyaW5nKCk7CiAgICB2YXIgbWF0Y2ggPSBzdHIubWF0Y2goL15ccypmdW5jdGlvbiAoLispXCgvKTsKICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogc3RyOwogIH0sCgogIGVycm9yOiBmdW5jdGlvbiBlcnJvcihlcnIsIG9wdGlvbnMpIHsKICAgIHZhciBvcmlnaW5hbEVycm9yID0gbnVsbDsKICAgIGlmICh0eXBlb2YgZXJyLm1lc3NhZ2UgPT09ICdzdHJpbmcnICYmIGVyci5tZXNzYWdlICE9PSAnJykgewogICAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnIHx8IChvcHRpb25zICYmIG9wdGlvbnMubWVzc2FnZSkpIHsKICAgICAgICBvcmlnaW5hbEVycm9yID0gdXRpbC5jb3B5KGVycik7CiAgICAgICAgb3JpZ2luYWxFcnJvci5tZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgIH0KICAgIH0KICAgIGVyci5tZXNzYWdlID0gZXJyLm1lc3NhZ2UgfHwgbnVsbDsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVyci5tZXNzYWdlID0gb3B0aW9uczsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmIG9wdGlvbnMgIT09IG51bGwpIHsKICAgICAgdXRpbC51cGRhdGUoZXJyLCBvcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMubWVzc2FnZSkKICAgICAgICBlcnIubWVzc2FnZSA9IG9wdGlvbnMubWVzc2FnZTsKICAgICAgaWYgKG9wdGlvbnMuY29kZSB8fCBvcHRpb25zLm5hbWUpCiAgICAgICAgZXJyLmNvZGUgPSBvcHRpb25zLmNvZGUgfHwgb3B0aW9ucy5uYW1lOwogICAgICBpZiAob3B0aW9ucy5zdGFjaykKICAgICAgICBlcnIuc3RhY2sgPSBvcHRpb25zLnN0YWNrOwogICAgfQoKICAgIGlmICh0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnR5ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlcnIsICduYW1lJywge3dyaXRhYmxlOiB0cnVlLCBlbnVtZXJhYmxlOiBmYWxzZX0pOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXJyLCAnbWVzc2FnZScsIHtlbnVtZXJhYmxlOiB0cnVlfSk7CiAgICB9CgogICAgZXJyLm5hbWUgPSBTdHJpbmcob3B0aW9ucyAmJiBvcHRpb25zLm5hbWUgfHwgZXJyLm5hbWUgfHwgZXJyLmNvZGUgfHwgJ0Vycm9yJyk7CiAgICBlcnIudGltZSA9IG5ldyBEYXRlKCk7CgogICAgaWYgKG9yaWdpbmFsRXJyb3IpIGVyci5vcmlnaW5hbEVycm9yID0gb3JpZ2luYWxFcnJvcjsKCiAgICByZXR1cm4gZXJyOwogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGluaGVyaXQ6IGZ1bmN0aW9uIGluaGVyaXQoa2xhc3MsIGZlYXR1cmVzKSB7CiAgICB2YXIgbmV3T2JqZWN0ID0gbnVsbDsKICAgIGlmIChmZWF0dXJlcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGZlYXR1cmVzID0ga2xhc3M7CiAgICAgIGtsYXNzID0gT2JqZWN0OwogICAgICBuZXdPYmplY3QgPSB7fTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBjdG9yID0gZnVuY3Rpb24gQ29uc3RydWN0b3JXcmFwcGVyKCkge307CiAgICAgIGN0b3IucHJvdG90eXBlID0ga2xhc3MucHJvdG90eXBlOwogICAgICBuZXdPYmplY3QgPSBuZXcgY3RvcigpOwogICAgfQoKICAgIC8vIGNvbnN0cnVjdG9yIG5vdCBzdXBwbGllZCwgY3JlYXRlIHBhc3MtdGhyb3VnaCBjdG9yCiAgICBpZiAoZmVhdHVyZXMuY29uc3RydWN0b3IgPT09IE9iamVjdCkgewogICAgICBmZWF0dXJlcy5jb25zdHJ1Y3RvciA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChrbGFzcyAhPT0gT2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4ga2xhc3MuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgZmVhdHVyZXMuY29uc3RydWN0b3IucHJvdG90eXBlID0gbmV3T2JqZWN0OwogICAgdXRpbC51cGRhdGUoZmVhdHVyZXMuY29uc3RydWN0b3IucHJvdG90eXBlLCBmZWF0dXJlcyk7CiAgICBmZWF0dXJlcy5jb25zdHJ1Y3Rvci5fX3N1cGVyX18gPSBrbGFzczsKICAgIHJldHVybiBmZWF0dXJlcy5jb25zdHJ1Y3RvcjsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtaXhpbjogZnVuY3Rpb24gbWl4aW4oKSB7CiAgICB2YXIga2xhc3MgPSBhcmd1bWVudHNbMF07CiAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAvLyBqc2hpbnQgZm9yaW46ZmFsc2UKICAgICAgZm9yICh2YXIgcHJvcCBpbiBhcmd1bWVudHNbaV0ucHJvdG90eXBlKSB7CiAgICAgICAgdmFyIGZuID0gYXJndW1lbnRzW2ldLnByb3RvdHlwZVtwcm9wXTsKICAgICAgICBpZiAocHJvcCAhPT0gJ2NvbnN0cnVjdG9yJykgewogICAgICAgICAga2xhc3MucHJvdG90eXBlW3Byb3BdID0gZm47CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4ga2xhc3M7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaGlkZVByb3BlcnRpZXM6IGZ1bmN0aW9uIGhpZGVQcm9wZXJ0aWVzKG9iaiwgcHJvcHMpIHsKICAgIGlmICh0eXBlb2YgT2JqZWN0LmRlZmluZVByb3BlcnR5ICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CgogICAgdXRpbC5hcnJheUVhY2gocHJvcHMsIGZ1bmN0aW9uIChrZXkpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBwcm9wZXJ0eTogZnVuY3Rpb24gcHJvcGVydHkob2JqLCBuYW1lLCB2YWx1ZSwgZW51bWVyYWJsZSwgaXNWYWx1ZSkgewogICAgdmFyIG9wdHMgPSB7CiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogZW51bWVyYWJsZSAhPT0gdW5kZWZpbmVkID8gZW51bWVyYWJsZSA6IHRydWUKICAgIH07CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nICYmICFpc1ZhbHVlKSB7CiAgICAgIG9wdHMuZ2V0ID0gdmFsdWU7CiAgICB9CiAgICBlbHNlIHsKICAgICAgb3B0cy52YWx1ZSA9IHZhbHVlOyBvcHRzLndyaXRhYmxlID0gdHJ1ZTsKICAgIH0KCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBuYW1lLCBvcHRzKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBtZW1vaXplZFByb3BlcnR5OiBmdW5jdGlvbiBtZW1vaXplZFByb3BlcnR5KG9iaiwgbmFtZSwgZ2V0LCBlbnVtZXJhYmxlKSB7CiAgICB2YXIgY2FjaGVkVmFsdWUgPSBudWxsOwoKICAgIC8vIGJ1aWxkIGVudW1lcmFibGUgYXR0cmlidXRlIGZvciBlYWNoIHZhbHVlIHdpdGggbGF6eSBhY2Nlc3Nvci4KICAgIHV0aWwucHJvcGVydHkob2JqLCBuYW1lLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGNhY2hlZFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgY2FjaGVkVmFsdWUgPSBnZXQoKTsKICAgICAgfQogICAgICByZXR1cm4gY2FjaGVkVmFsdWU7CiAgICB9LCBlbnVtZXJhYmxlKTsKICB9LAoKICAvKioKICAgKiBUT0RPIFJlbW92ZSBpbiBtYWpvciB2ZXJzaW9uIHJldmlzaW9uCiAgICogVGhpcyBiYWNrZmlsbCBwb3B1bGF0ZXMgcmVzcG9uc2UgZGF0YSB3aXRob3V0IHRoZQogICAqIHRvcC1sZXZlbCBwYXlsb2FkIG5hbWUuCiAgICoKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBob2lzdFBheWxvYWRNZW1iZXI6IGZ1bmN0aW9uIGhvaXN0UGF5bG9hZE1lbWJlcihyZXNwKSB7CiAgICB2YXIgcmVxID0gcmVzcC5yZXF1ZXN0OwogICAgdmFyIG9wZXJhdGlvbk5hbWUgPSByZXEub3BlcmF0aW9uOwogICAgdmFyIG9wZXJhdGlvbiA9IHJlcS5zZXJ2aWNlLmFwaS5vcGVyYXRpb25zW29wZXJhdGlvbk5hbWVdOwogICAgdmFyIG91dHB1dCA9IG9wZXJhdGlvbi5vdXRwdXQ7CiAgICBpZiAob3V0cHV0LnBheWxvYWQgJiYgIW9wZXJhdGlvbi5oYXNFdmVudE91dHB1dCkgewogICAgICB2YXIgcGF5bG9hZE1lbWJlciA9IG91dHB1dC5tZW1iZXJzW291dHB1dC5wYXlsb2FkXTsKICAgICAgdmFyIHJlc3BvbnNlUGF5bG9hZCA9IHJlc3AuZGF0YVtvdXRwdXQucGF5bG9hZF07CiAgICAgIGlmIChwYXlsb2FkTWVtYmVyLnR5cGUgPT09ICdzdHJ1Y3R1cmUnKSB7CiAgICAgICAgdXRpbC5lYWNoKHJlc3BvbnNlUGF5bG9hZCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgdXRpbC5wcm9wZXJ0eShyZXNwLmRhdGEsIGtleSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0sCgogIC8qKgogICAqIENvbXB1dGUgU0hBLTI1NiBjaGVja3N1bXMgb2Ygc3RyZWFtcwogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY29tcHV0ZVNoYTI1NjogZnVuY3Rpb24gY29tcHV0ZVNoYTI1Nihib2R5LCBkb25lKSB7CiAgICBpZiAodXRpbC5pc05vZGUoKSkgewogICAgICB2YXIgU3RyZWFtID0gdXRpbC5zdHJlYW0uU3RyZWFtOwogICAgICB2YXIgZnMgPSByZXF1aXJlKCdmcycpOwogICAgICBpZiAodHlwZW9mIFN0cmVhbSA9PT0gJ2Z1bmN0aW9uJyAmJiBib2R5IGluc3RhbmNlb2YgU3RyZWFtKSB7CiAgICAgICAgaWYgKHR5cGVvZiBib2R5LnBhdGggPT09ICdzdHJpbmcnKSB7IC8vIGFzc3VtZSBmaWxlIG9iamVjdAogICAgICAgICAgdmFyIHNldHRpbmdzID0ge307CiAgICAgICAgICBpZiAodHlwZW9mIGJvZHkuc3RhcnQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHNldHRpbmdzLnN0YXJ0ID0gYm9keS5zdGFydDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgYm9keS5lbmQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHNldHRpbmdzLmVuZCA9IGJvZHkuZW5kOwogICAgICAgICAgfQogICAgICAgICAgYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oYm9keS5wYXRoLCBzZXR0aW5ncyk7CiAgICAgICAgfSBlbHNlIHsgLy8gVE9ETyBzdXBwb3J0IG90aGVyIHN0cmVhbSB0eXBlcwogICAgICAgICAgcmV0dXJuIGRvbmUobmV3IEVycm9yKCdOb24tZmlsZSBzdHJlYW0gb2JqZWN0cyBhcmUgJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ25vdCBzdXBwb3J0ZWQgd2l0aCBTaWdWNCcpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICB1dGlsLmNyeXB0by5zaGEyNTYoYm9keSwgJ2hleCcsIGZ1bmN0aW9uKGVyciwgc2hhKSB7CiAgICAgIGlmIChlcnIpIGRvbmUoZXJyKTsKICAgICAgZWxzZSBkb25lKG51bGwsIHNoYSk7CiAgICB9KTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpc0Nsb2NrU2tld2VkOiBmdW5jdGlvbiBpc0Nsb2NrU2tld2VkKHNlcnZlclRpbWUpIHsKICAgIGlmIChzZXJ2ZXJUaW1lKSB7CiAgICAgIHV0aWwucHJvcGVydHkoQVdTLmNvbmZpZywgJ2lzQ2xvY2tTa2V3ZWQnLAogICAgICAgIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gc2VydmVyVGltZSkgPj0gMzAwMDAwLCBmYWxzZSk7CiAgICAgIHJldHVybiBBV1MuY29uZmlnLmlzQ2xvY2tTa2V3ZWQ7CiAgICB9CiAgfSwKCiAgYXBwbHlDbG9ja09mZnNldDogZnVuY3Rpb24gYXBwbHlDbG9ja09mZnNldChzZXJ2ZXJUaW1lKSB7CiAgICBpZiAoc2VydmVyVGltZSkKICAgICAgQVdTLmNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCA9IHNlcnZlclRpbWUgLSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBleHRyYWN0UmVxdWVzdElkOiBmdW5jdGlvbiBleHRyYWN0UmVxdWVzdElkKHJlc3ApIHsKICAgIHZhciByZXF1ZXN0SWQgPSByZXNwLmh0dHBSZXNwb25zZS5oZWFkZXJzWyd4LWFtei1yZXF1ZXN0LWlkJ10gfHwKICAgICAgICAgICAgICAgICAgICAgcmVzcC5odHRwUmVzcG9uc2UuaGVhZGVyc1sneC1hbXpuLXJlcXVlc3RpZCddOwoKICAgIGlmICghcmVxdWVzdElkICYmIHJlc3AuZGF0YSAmJiByZXNwLmRhdGEuUmVzcG9uc2VNZXRhZGF0YSkgewogICAgICByZXF1ZXN0SWQgPSByZXNwLmRhdGEuUmVzcG9uc2VNZXRhZGF0YS5SZXF1ZXN0SWQ7CiAgICB9CgogICAgaWYgKHJlcXVlc3RJZCkgewogICAgICByZXNwLnJlcXVlc3RJZCA9IHJlcXVlc3RJZDsKICAgIH0KCiAgICBpZiAocmVzcC5lcnJvcikgewogICAgICByZXNwLmVycm9yLnJlcXVlc3RJZCA9IHJlcXVlc3RJZDsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBhZGRQcm9taXNlczogZnVuY3Rpb24gYWRkUHJvbWlzZXMoY29uc3RydWN0b3JzLCBQcm9taXNlRGVwZW5kZW5jeSkgewogICAgdmFyIGRlbGV0ZVByb21pc2VzID0gZmFsc2U7CiAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiBBV1MgJiYgQVdTLmNvbmZpZykgewogICAgICBQcm9taXNlRGVwZW5kZW5jeSA9IEFXUy5jb25maWcuZ2V0UHJvbWlzZXNEZXBlbmRlbmN5KCk7CiAgICB9CiAgICBpZiAoUHJvbWlzZURlcGVuZGVuY3kgPT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgUHJvbWlzZURlcGVuZGVuY3kgPSBQcm9taXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBQcm9taXNlRGVwZW5kZW5jeSAhPT0gJ2Z1bmN0aW9uJykgZGVsZXRlUHJvbWlzZXMgPSB0cnVlOwogICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbnN0cnVjdG9ycykpIGNvbnN0cnVjdG9ycyA9IFtjb25zdHJ1Y3RvcnNdOwoKICAgIGZvciAodmFyIGluZCA9IDA7IGluZCA8IGNvbnN0cnVjdG9ycy5sZW5ndGg7IGluZCsrKSB7CiAgICAgIHZhciBjb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yc1tpbmRdOwogICAgICBpZiAoZGVsZXRlUHJvbWlzZXMpIHsKICAgICAgICBpZiAoY29uc3RydWN0b3IuZGVsZXRlUHJvbWlzZXNGcm9tQ2xhc3MpIHsKICAgICAgICAgIGNvbnN0cnVjdG9yLmRlbGV0ZVByb21pc2VzRnJvbUNsYXNzKCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGNvbnN0cnVjdG9yLmFkZFByb21pc2VzVG9DbGFzcykgewogICAgICAgIGNvbnN0cnVjdG9yLmFkZFByb21pc2VzVG9DbGFzcyhQcm9taXNlRGVwZW5kZW5jeSk7CiAgICAgIH0KICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKiBSZXR1cm4gYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmV0dXJuIGEgcHJvbWlzZSB3aG9zZSBmYXRlIGlzIGRlY2lkZWQgYnkgdGhlCiAgICogY2FsbGJhY2sgYmVoYXZpb3Igb2YgdGhlIGdpdmVuIG1ldGhvZCB3aXRoIGBtZXRob2ROYW1lYC4gVGhlIG1ldGhvZCB0byBiZQogICAqIHByb21pc2lmaWVkIHNob3VsZCBjb25mb3JtIHRvIG5vZGUuanMgY29udmVudGlvbiBvZiBhY2NlcHRpbmcgYSBjYWxsYmFjayBhcwogICAqIGxhc3QgYXJndW1lbnQgYW5kIGNhbGxpbmcgdGhhdCBjYWxsYmFjayB3aXRoIGVycm9yIGFzIHRoZSBmaXJzdCBhcmd1bWVudAogICAqIGFuZCBzdWNjZXNzIHZhbHVlIG9uIHRoZSBzZWNvbmQgYXJndW1lbnQuCiAgICovCiAgcHJvbWlzaWZ5TWV0aG9kOiBmdW5jdGlvbiBwcm9taXNpZnlNZXRob2QobWV0aG9kTmFtZSwgUHJvbWlzZURlcGVuZGVuY3kpIHsKICAgIHJldHVybiBmdW5jdGlvbiBwcm9taXNlKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlRGVwZW5kZW5jeShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICBhcmdzLnB1c2goZnVuY3Rpb24oZXJyLCBkYXRhKSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIHJlamVjdChlcnIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzb2x2ZShkYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBzZWxmW21ldGhvZE5hbWVdLmFwcGx5KHNlbGYsIGFyZ3MpOwogICAgICB9KTsKICAgIH07CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgaXNEdWFsc3RhY2tBdmFpbGFibGU6IGZ1bmN0aW9uIGlzRHVhbHN0YWNrQXZhaWxhYmxlKHNlcnZpY2UpIHsKICAgIGlmICghc2VydmljZSkgcmV0dXJuIGZhbHNlOwogICAgdmFyIG1ldGFkYXRhID0gcmVxdWlyZSgnLi4vYXBpcy9tZXRhZGF0YS5qc29uJyk7CiAgICBpZiAodHlwZW9mIHNlcnZpY2UgIT09ICdzdHJpbmcnKSBzZXJ2aWNlID0gc2VydmljZS5zZXJ2aWNlSWRlbnRpZmllcjsKICAgIGlmICh0eXBlb2Ygc2VydmljZSAhPT0gJ3N0cmluZycgfHwgIW1ldGFkYXRhLmhhc093blByb3BlcnR5KHNlcnZpY2UpKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gISFtZXRhZGF0YVtzZXJ2aWNlXS5kdWFsc3RhY2tBdmFpbGFibGU7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgY2FsY3VsYXRlUmV0cnlEZWxheTogZnVuY3Rpb24gY2FsY3VsYXRlUmV0cnlEZWxheShyZXRyeUNvdW50LCByZXRyeURlbGF5T3B0aW9ucywgZXJyKSB7CiAgICBpZiAoIXJldHJ5RGVsYXlPcHRpb25zKSByZXRyeURlbGF5T3B0aW9ucyA9IHt9OwogICAgdmFyIGN1c3RvbUJhY2tvZmYgPSByZXRyeURlbGF5T3B0aW9ucy5jdXN0b21CYWNrb2ZmIHx8IG51bGw7CiAgICBpZiAodHlwZW9mIGN1c3RvbUJhY2tvZmYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgcmV0dXJuIGN1c3RvbUJhY2tvZmYocmV0cnlDb3VudCwgZXJyKTsKICAgIH0KICAgIHZhciBiYXNlID0gdHlwZW9mIHJldHJ5RGVsYXlPcHRpb25zLmJhc2UgPT09ICdudW1iZXInID8gcmV0cnlEZWxheU9wdGlvbnMuYmFzZSA6IDEwMDsKICAgIHZhciBkZWxheSA9IE1hdGgucmFuZG9tKCkgKiAoTWF0aC5wb3coMiwgcmV0cnlDb3VudCkgKiBiYXNlKTsKICAgIHJldHVybiBkZWxheTsKICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBoYW5kbGVSZXF1ZXN0V2l0aFJldHJpZXM6IGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3RXaXRoUmV0cmllcyhodHRwUmVxdWVzdCwgb3B0aW9ucywgY2IpIHsKICAgIGlmICghb3B0aW9ucykgb3B0aW9ucyA9IHt9OwogICAgdmFyIGh0dHAgPSBBV1MuSHR0cENsaWVudC5nZXRJbnN0YW5jZSgpOwogICAgdmFyIGh0dHBPcHRpb25zID0gb3B0aW9ucy5odHRwT3B0aW9ucyB8fCB7fTsKICAgIHZhciByZXRyeUNvdW50ID0gMDsKCiAgICB2YXIgZXJyQ2FsbGJhY2sgPSBmdW5jdGlvbihlcnIpIHsKICAgICAgdmFyIG1heFJldHJpZXMgPSBvcHRpb25zLm1heFJldHJpZXMgfHwgMDsKICAgICAgaWYgKGVyciAmJiBlcnIuY29kZSA9PT0gJ1RpbWVvdXRFcnJvcicpIGVyci5yZXRyeWFibGUgPSB0cnVlOwoKICAgICAgLy8gQ2FsbCBgY2FsY3VsYXRlUmV0cnlEZWxheSgpYCBvbmx5IHdoZW4gcmVsZXZhbnQsIHNlZSAjMzQwMQogICAgICBpZiAoZXJyICYmIGVyci5yZXRyeWFibGUgJiYgcmV0cnlDb3VudCA8IG1heFJldHJpZXMpIHsKICAgICAgICB2YXIgZGVsYXkgPSB1dGlsLmNhbGN1bGF0ZVJldHJ5RGVsYXkocmV0cnlDb3VudCwgb3B0aW9ucy5yZXRyeURlbGF5T3B0aW9ucywgZXJyKTsKICAgICAgICBpZiAoZGVsYXkgPj0gMCkgewogICAgICAgICAgcmV0cnlDb3VudCsrOwogICAgICAgICAgc2V0VGltZW91dChzZW5kUmVxdWVzdCwgZGVsYXkgKyAoZXJyLnJldHJ5QWZ0ZXIgfHwgMCkpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfQogICAgICBjYihlcnIpOwogICAgfTsKCiAgICB2YXIgc2VuZFJlcXVlc3QgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGRhdGEgPSAnJzsKICAgICAgaHR0cC5oYW5kbGVSZXF1ZXN0KGh0dHBSZXF1ZXN0LCBodHRwT3B0aW9ucywgZnVuY3Rpb24oaHR0cFJlc3BvbnNlKSB7CiAgICAgICAgaHR0cFJlc3BvbnNlLm9uKCdkYXRhJywgZnVuY3Rpb24oY2h1bmspIHsgZGF0YSArPSBjaHVuay50b1N0cmluZygpOyB9KTsKICAgICAgICBodHRwUmVzcG9uc2Uub24oJ2VuZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHN0YXR1c0NvZGUgPSBodHRwUmVzcG9uc2Uuc3RhdHVzQ29kZTsKICAgICAgICAgIGlmIChzdGF0dXNDb2RlIDwgMzAwKSB7CiAgICAgICAgICAgIGNiKG51bGwsIGRhdGEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJldHJ5QWZ0ZXIgPSBwYXJzZUludChodHRwUmVzcG9uc2UuaGVhZGVyc1sncmV0cnktYWZ0ZXInXSwgMTApICogMTAwMCB8fCAwOwogICAgICAgICAgICB2YXIgZXJyID0gdXRpbC5lcnJvcihuZXcgRXJyb3IoKSwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlOiBzdGF0dXNDb2RlLAogICAgICAgICAgICAgICAgcmV0cnlhYmxlOiBzdGF0dXNDb2RlID49IDUwMCB8fCBzdGF0dXNDb2RlID09PSA0MjkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChyZXRyeUFmdGVyICYmIGVyci5yZXRyeWFibGUpIGVyci5yZXRyeUFmdGVyID0gcmV0cnlBZnRlcjsKICAgICAgICAgICAgZXJyQ2FsbGJhY2soZXJyKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwgZXJyQ2FsbGJhY2spOwogICAgfTsKCiAgICBBV1MudXRpbC5kZWZlcihzZW5kUmVxdWVzdCk7CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgdXVpZDogewogICAgdjQ6IGZ1bmN0aW9uIHV1aWRWNCgpIHsKICAgICAgcmV0dXJuIHJlcXVpcmUoJ3V1aWQnKS52NCgpOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNvbnZlcnRQYXlsb2FkVG9TdHJpbmc6IGZ1bmN0aW9uIGNvbnZlcnRQYXlsb2FkVG9TdHJpbmcocmVzcCkgewogICAgdmFyIHJlcSA9IHJlc3AucmVxdWVzdDsKICAgIHZhciBvcGVyYXRpb24gPSByZXEub3BlcmF0aW9uOwogICAgdmFyIHJ1bGVzID0gcmVxLnNlcnZpY2UuYXBpLm9wZXJhdGlvbnNbb3BlcmF0aW9uXS5vdXRwdXQgfHwge307CiAgICBpZiAocnVsZXMucGF5bG9hZCAmJiByZXNwLmRhdGFbcnVsZXMucGF5bG9hZF0pIHsKICAgICAgcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdID0gcmVzcC5kYXRhW3J1bGVzLnBheWxvYWRdLnRvU3RyaW5nKCk7CiAgICB9CiAgfSwKCiAgLyoqCiAgICogQGFwaSBwcml2YXRlCiAgICovCiAgZGVmZXI6IGZ1bmN0aW9uIGRlZmVyKGNhbGxiYWNrKSB7CiAgICBpZiAodHlwZW9mIHByb2Nlc3MgPT09ICdvYmplY3QnICYmIHR5cGVvZiBwcm9jZXNzLm5leHRUaWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soY2FsbGJhY2spOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHNldEltbWVkaWF0ZShjYWxsYmFjayk7CiAgICB9IGVsc2UgewogICAgICBzZXRUaW1lb3V0KGNhbGxiYWNrLCAwKTsKICAgIH0KICB9LAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBnZXRSZXF1ZXN0UGF5bG9hZFNoYXBlOiBmdW5jdGlvbiBnZXRSZXF1ZXN0UGF5bG9hZFNoYXBlKHJlcSkgewogICAgdmFyIG9wZXJhdGlvbnMgPSByZXEuc2VydmljZS5hcGkub3BlcmF0aW9uczsKICAgIGlmICghb3BlcmF0aW9ucykgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHZhciBvcGVyYXRpb24gPSAob3BlcmF0aW9ucyB8fCB7fSlbcmVxLm9wZXJhdGlvbl07CiAgICBpZiAoIW9wZXJhdGlvbiB8fCAhb3BlcmF0aW9uLmlucHV0IHx8ICFvcGVyYXRpb24uaW5wdXQucGF5bG9hZCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHJldHVybiBvcGVyYXRpb24uaW5wdXQubWVtYmVyc1tvcGVyYXRpb24uaW5wdXQucGF5bG9hZF07CiAgfSwKCiAgZ2V0UHJvZmlsZXNGcm9tU2hhcmVkQ29uZmlnOiBmdW5jdGlvbiBnZXRQcm9maWxlc0Zyb21TaGFyZWRDb25maWcoaW5pTG9hZGVyLCBmaWxlbmFtZSkgewogICAgdmFyIHByb2ZpbGVzID0ge307CiAgICB2YXIgcHJvZmlsZXNGcm9tQ29uZmlnID0ge307CiAgICBpZiAocHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0pIHsKICAgICAgdmFyIHByb2ZpbGVzRnJvbUNvbmZpZyA9IGluaUxvYWRlci5sb2FkRnJvbSh7CiAgICAgICAgaXNDb25maWc6IHRydWUsCiAgICAgICAgZmlsZW5hbWU6IHByb2Nlc3MuZW52W3V0aWwuc2hhcmVkQ29uZmlnRmlsZUVudl0KICAgICAgfSk7CiAgICB9CiAgICB2YXIgcHJvZmlsZXNGcm9tQ3JlZHM9IHt9OwogICAgdHJ5IHsKICAgICAgdmFyIHByb2ZpbGVzRnJvbUNyZWRzID0gaW5pTG9hZGVyLmxvYWRGcm9tKHsKICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUgfHwKICAgICAgICAgIChwcm9jZXNzLmVudlt1dGlsLmNvbmZpZ09wdEluRW52XSAmJiBwcm9jZXNzLmVudlt1dGlsLnNoYXJlZENyZWRlbnRpYWxzRmlsZUVudl0pCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgLy8gaWYgdXNpbmcgY29uZmlnLCBhc3N1bWUgaXQgaXMgZnVsbHkgZGVzY3JpcHRpdmUgd2l0aG91dCBhIGNyZWRlbnRpYWxzIGZpbGU6CiAgICAgIGlmICghcHJvY2Vzcy5lbnZbdXRpbC5jb25maWdPcHRJbkVudl0pIHRocm93IGVycm9yOwogICAgfQogICAgZm9yICh2YXIgaSA9IDAsIHByb2ZpbGVOYW1lcyA9IE9iamVjdC5rZXlzKHByb2ZpbGVzRnJvbUNvbmZpZyk7IGkgPCBwcm9maWxlTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSA9IG9iamVjdEFzc2lnbihwcm9maWxlc1twcm9maWxlTmFtZXNbaV1dIHx8IHt9LCBwcm9maWxlc0Zyb21Db25maWdbcHJvZmlsZU5hbWVzW2ldXSk7CiAgICB9CiAgICBmb3IgKHZhciBpID0gMCwgcHJvZmlsZU5hbWVzID0gT2JqZWN0LmtleXMocHJvZmlsZXNGcm9tQ3JlZHMpOyBpIDwgcHJvZmlsZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHByb2ZpbGVzW3Byb2ZpbGVOYW1lc1tpXV0gPSBvYmplY3RBc3NpZ24ocHJvZmlsZXNbcHJvZmlsZU5hbWVzW2ldXSB8fCB7fSwgcHJvZmlsZXNGcm9tQ3JlZHNbcHJvZmlsZU5hbWVzW2ldXSk7CiAgICB9CiAgICByZXR1cm4gcHJvZmlsZXM7CgogICAgLyoqCiAgICAgKiBSb3VnaGx5IHRoZSBzZW1hbnRpY3Mgb2YgYE9iamVjdC5hc3NpZ24odGFyZ2V0LCBzb3VyY2UpYAogICAgICovCiAgICBmdW5jdGlvbiBvYmplY3RBc3NpZ24odGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGtleXMgPSBPYmplY3Qua2V5cyhzb3VyY2UpOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHRhcmdldFtrZXlzW2ldXSA9IHNvdXJjZVtrZXlzW2ldXTsKICAgICAgfQogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIEFSTjogewogICAgdmFsaWRhdGU6IGZ1bmN0aW9uIHZhbGlkYXRlQVJOKHN0cikgewogICAgICByZXR1cm4gc3RyICYmIHN0ci5pbmRleE9mKCdhcm46JykgPT09IDAgJiYgc3RyLnNwbGl0KCc6JykubGVuZ3RoID49IDY7CiAgICB9LAogICAgcGFyc2U6IGZ1bmN0aW9uIHBhcnNlQVJOKGFybikgewogICAgICB2YXIgbWF0Y2hlZCA9IGFybi5zcGxpdCgnOicpOwogICAgICByZXR1cm4gewogICAgICAgIHBhcnRpdGlvbjogbWF0Y2hlZFsxXSwKICAgICAgICBzZXJ2aWNlOiBtYXRjaGVkWzJdLAogICAgICAgIHJlZ2lvbjogbWF0Y2hlZFszXSwKICAgICAgICBhY2NvdW50SWQ6IG1hdGNoZWRbNF0sCiAgICAgICAgcmVzb3VyY2U6IG1hdGNoZWQuc2xpY2UoNSkuam9pbignOicpCiAgICAgIH07CiAgICB9LAogICAgYnVpbGQ6IGZ1bmN0aW9uIGJ1aWxkQVJOKGFybk9iamVjdCkgewogICAgICBpZiAoCiAgICAgICAgYXJuT2JqZWN0LnNlcnZpY2UgPT09IHVuZGVmaW5lZCB8fAogICAgICAgIGFybk9iamVjdC5yZWdpb24gPT09IHVuZGVmaW5lZCB8fAogICAgICAgIGFybk9iamVjdC5hY2NvdW50SWQgPT09IHVuZGVmaW5lZCB8fAogICAgICAgIGFybk9iamVjdC5yZXNvdXJjZSA9PT0gdW5kZWZpbmVkCiAgICAgICkgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0lucHV0IEFSTiBvYmplY3QgaXMgaW52YWxpZCcpKTsKICAgICAgcmV0dXJuICdhcm46JysgKGFybk9iamVjdC5wYXJ0aXRpb24gfHwgJ2F3cycpICsgJzonICsgYXJuT2JqZWN0LnNlcnZpY2UgKwogICAgICAgICc6JyArIGFybk9iamVjdC5yZWdpb24gKyAnOicgKyBhcm5PYmplY3QuYWNjb3VudElkICsgJzonICsgYXJuT2JqZWN0LnJlc291cmNlOwogICAgfQogIH0sCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGRlZmF1bHRQcm9maWxlOiAnZGVmYXVsdCcsCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIGNvbmZpZ09wdEluRW52OiAnQVdTX1NES19MT0FEX0NPTkZJRycsCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNoYXJlZENyZWRlbnRpYWxzRmlsZUVudjogJ0FXU19TSEFSRURfQ1JFREVOVElBTFNfRklMRScsCgogIC8qKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwogIHNoYXJlZENvbmZpZ0ZpbGVFbnY6ICdBV1NfQ09ORklHX0ZJTEUnLAoKICAvKioKICAgKiBAYXBpIHByaXZhdGUKICAgKi8KICBpbWRzRGlzYWJsZWRFbnY6ICdBV1NfRUMyX01FVEFEQVRBX0RJU0FCTEVEJwp9OwoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB1dGlsOwoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpLHJlcXVpcmUoInRpbWVycyIpLnNldEltbWVkaWF0ZSkKfSx7Ii4uL2FwaXMvbWV0YWRhdGEuanNvbiI6NCwiLi9jb3JlIjoxOSwiX3Byb2Nlc3MiOjg5LCJmcyI6ODAsInRpbWVycyI6OTcsInV1aWQiOjEwMH1dLDczOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7CnZhciBTaGFwZSA9IHJlcXVpcmUoJy4uL21vZGVsL3NoYXBlJyk7CgpmdW5jdGlvbiBEb21YbWxQYXJzZXIoKSB7IH0KCkRvbVhtbFBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih4bWwsIHNoYXBlKSB7CiAgaWYgKHhtbC5yZXBsYWNlKC9eXHMrLywgJycpID09PSAnJykgcmV0dXJuIHt9OwoKICB2YXIgcmVzdWx0LCBlcnJvcjsKICB0cnkgewogICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwogICAgICAgIHJlc3VsdCA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoeG1sLCAndGV4dC94bWwnKTsKICAgICAgfSBjYXRjaCAoc3ludGF4RXJyb3IpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgIHsKICAgICAgICAgICAgb3JpZ2luYWxFcnJvcjogc3ludGF4RXJyb3IsCiAgICAgICAgICAgIGNvZGU6ICdYTUxQYXJzZXJFcnJvcicsCiAgICAgICAgICAgIHJldHJ5YWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGlmIChyZXN1bHQuZG9jdW1lbnRFbGVtZW50ID09PSBudWxsKSB7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoJ0Nhbm5vdCBwYXJzZSBlbXB0eSBkb2N1bWVudC4nKSwKICAgICAgICAgIHsKICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdmFyIGlzRXJyb3IgPSByZXN1bHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3BhcnNlcmVycm9yJylbMF07CiAgICAgIGlmIChpc0Vycm9yICYmIChpc0Vycm9yLnBhcmVudE5vZGUgPT09IHJlc3VsdCB8fAogICAgICAgICAgaXNFcnJvci5wYXJlbnROb2RlLm5vZGVOYW1lID09PSAnYm9keScgfHwKICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5wYXJlbnROb2RlID09PSByZXN1bHQgfHwKICAgICAgICAgIGlzRXJyb3IucGFyZW50Tm9kZS5wYXJlbnROb2RlLm5vZGVOYW1lID09PSAnYm9keScpKSB7CiAgICAgICAgdmFyIGVycm9yRWxlbWVudCA9IGlzRXJyb3IuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2RpdicpWzBdIHx8IGlzRXJyb3I7CiAgICAgICAgdGhyb3cgdXRpbC5lcnJvcihuZXcgRXJyb3IoZXJyb3JFbGVtZW50LnRleHRDb250ZW50IHx8ICdQYXJzZXIgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgIHsKICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIGlmICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgewogICAgICByZXN1bHQgPSBuZXcgd2luZG93LkFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxET00nKTsKICAgICAgcmVzdWx0LmFzeW5jID0gZmFsc2U7CgogICAgICBpZiAoIXJlc3VsdC5sb2FkWE1MKHhtbCkpIHsKICAgICAgICB0aHJvdyB1dGlsLmVycm9yKG5ldyBFcnJvcignUGFyc2UgZXJyb3IgaW4gZG9jdW1lbnQnKSwKICAgICAgICAgIHsKICAgICAgICAgICAgY29kZTogJ1hNTFBhcnNlckVycm9yJywKICAgICAgICAgICAgcmV0cnlhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbG9hZCBYTUwgcGFyc2VyJyk7CiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgZXJyb3IgPSBlOwogIH0KCiAgaWYgKHJlc3VsdCAmJiByZXN1bHQuZG9jdW1lbnRFbGVtZW50ICYmICFlcnJvcikgewogICAgdmFyIGRhdGEgPSBwYXJzZVhtbChyZXN1bHQuZG9jdW1lbnRFbGVtZW50LCBzaGFwZSk7CiAgICB2YXIgbWV0YWRhdGEgPSBnZXRFbGVtZW50QnlUYWdOYW1lKHJlc3VsdC5kb2N1bWVudEVsZW1lbnQsICdSZXNwb25zZU1ldGFkYXRhJyk7CiAgICBpZiAobWV0YWRhdGEpIHsKICAgICAgZGF0YS5SZXNwb25zZU1ldGFkYXRhID0gcGFyc2VYbWwobWV0YWRhdGEsIHt9KTsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0gZWxzZSBpZiAoZXJyb3IpIHsKICAgIHRocm93IHV0aWwuZXJyb3IoZXJyb3IgfHwgbmV3IEVycm9yKCksIHtjb2RlOiAnWE1MUGFyc2VyRXJyb3InLCByZXRyeWFibGU6IHRydWV9KTsKICB9IGVsc2UgeyAvLyBlbXB0eSB4bWwgZG9jdW1lbnQKICAgIHJldHVybiB7fTsKICB9Cn07CgpmdW5jdGlvbiBnZXRFbGVtZW50QnlUYWdOYW1lKHhtbCwgdGFnKSB7CiAgdmFyIGVsZW1lbnRzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CiAgZm9yICh2YXIgaSA9IDAsIGlMZW4gPSBlbGVtZW50cy5sZW5ndGg7IGkgPCBpTGVuOyBpKyspIHsKICAgIGlmIChlbGVtZW50c1tpXS5wYXJlbnROb2RlID09PSB4bWwpIHsKICAgICAgcmV0dXJuIGVsZW1lbnRzW2ldOwogICAgfQogIH0KfQoKZnVuY3Rpb24gcGFyc2VYbWwoeG1sLCBzaGFwZSkgewogIGlmICghc2hhcGUpIHNoYXBlID0ge307CiAgc3dpdGNoIChzaGFwZS50eXBlKSB7CiAgICBjYXNlICdzdHJ1Y3R1cmUnOiByZXR1cm4gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSk7CiAgICBjYXNlICdtYXAnOiByZXR1cm4gcGFyc2VNYXAoeG1sLCBzaGFwZSk7CiAgICBjYXNlICdsaXN0JzogcmV0dXJuIHBhcnNlTGlzdCh4bWwsIHNoYXBlKTsKICAgIGNhc2UgdW5kZWZpbmVkOiBjYXNlIG51bGw6IHJldHVybiBwYXJzZVVua25vd24oeG1sKTsKICAgIGRlZmF1bHQ6IHJldHVybiBwYXJzZVNjYWxhcih4bWwsIHNoYXBlKTsKICB9Cn0KCmZ1bmN0aW9uIHBhcnNlU3RydWN0dXJlKHhtbCwgc2hhcGUpIHsKICB2YXIgZGF0YSA9IHt9OwogIGlmICh4bWwgPT09IG51bGwpIHJldHVybiBkYXRhOwoKICB1dGlsLmVhY2goc2hhcGUubWVtYmVycywgZnVuY3Rpb24obWVtYmVyTmFtZSwgbWVtYmVyU2hhcGUpIHsKICAgIGlmIChtZW1iZXJTaGFwZS5pc1htbEF0dHJpYnV0ZSkgewogICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHhtbC5hdHRyaWJ1dGVzLCBtZW1iZXJTaGFwZS5uYW1lKSkgewogICAgICAgIHZhciB2YWx1ZSA9IHhtbC5hdHRyaWJ1dGVzW21lbWJlclNoYXBlLm5hbWVdLnZhbHVlOwogICAgICAgIGRhdGFbbWVtYmVyTmFtZV0gPSBwYXJzZVhtbCh7dGV4dENvbnRlbnQ6IHZhbHVlfSwgbWVtYmVyU2hhcGUpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgeG1sQ2hpbGQgPSBtZW1iZXJTaGFwZS5mbGF0dGVuZWQgPyB4bWwgOgogICAgICAgIGdldEVsZW1lbnRCeVRhZ05hbWUoeG1sLCBtZW1iZXJTaGFwZS5uYW1lKTsKICAgICAgaWYgKHhtbENoaWxkKSB7CiAgICAgICAgZGF0YVttZW1iZXJOYW1lXSA9IHBhcnNlWG1sKHhtbENoaWxkLCBtZW1iZXJTaGFwZSk7CiAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgIW1lbWJlclNoYXBlLmZsYXR0ZW5lZCAmJgogICAgICAgIG1lbWJlclNoYXBlLnR5cGUgPT09ICdsaXN0JyAmJgogICAgICAgICFzaGFwZS5hcGkueG1sTm9EZWZhdWx0TGlzdHMpIHsKICAgICAgICBkYXRhW21lbWJlck5hbWVdID0gbWVtYmVyU2hhcGUuZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICB9CiAgfSk7CgogIHJldHVybiBkYXRhOwp9CgpmdW5jdGlvbiBwYXJzZU1hcCh4bWwsIHNoYXBlKSB7CiAgdmFyIGRhdGEgPSB7fTsKICB2YXIgeG1sS2V5ID0gc2hhcGUua2V5Lm5hbWUgfHwgJ2tleSc7CiAgdmFyIHhtbFZhbHVlID0gc2hhcGUudmFsdWUubmFtZSB8fCAndmFsdWUnOwogIHZhciB0YWdOYW1lID0gc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeSc7CgogIHZhciBjaGlsZCA9IHhtbC5maXJzdEVsZW1lbnRDaGlsZDsKICB3aGlsZSAoY2hpbGQpIHsKICAgIGlmIChjaGlsZC5ub2RlTmFtZSA9PT0gdGFnTmFtZSkgewogICAgICB2YXIga2V5ID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShjaGlsZCwgeG1sS2V5KS50ZXh0Q29udGVudDsKICAgICAgdmFyIHZhbHVlID0gZ2V0RWxlbWVudEJ5VGFnTmFtZShjaGlsZCwgeG1sVmFsdWUpOwogICAgICBkYXRhW2tleV0gPSBwYXJzZVhtbCh2YWx1ZSwgc2hhcGUudmFsdWUpOwogICAgfQogICAgY2hpbGQgPSBjaGlsZC5uZXh0RWxlbWVudFNpYmxpbmc7CiAgfQogIHJldHVybiBkYXRhOwp9CgpmdW5jdGlvbiBwYXJzZUxpc3QoeG1sLCBzaGFwZSkgewogIHZhciBkYXRhID0gW107CiAgdmFyIHRhZ05hbWUgPSBzaGFwZS5mbGF0dGVuZWQgPyBzaGFwZS5uYW1lIDogKHNoYXBlLm1lbWJlci5uYW1lIHx8ICdtZW1iZXInKTsKCiAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogIHdoaWxlIChjaGlsZCkgewogICAgaWYgKGNoaWxkLm5vZGVOYW1lID09PSB0YWdOYW1lKSB7CiAgICAgIGRhdGEucHVzaChwYXJzZVhtbChjaGlsZCwgc2hhcGUubWVtYmVyKSk7CiAgICB9CiAgICBjaGlsZCA9IGNoaWxkLm5leHRFbGVtZW50U2libGluZzsKICB9CiAgcmV0dXJuIGRhdGE7Cn0KCmZ1bmN0aW9uIHBhcnNlU2NhbGFyKHhtbCwgc2hhcGUpIHsKICBpZiAoeG1sLmdldEF0dHJpYnV0ZSkgewogICAgdmFyIGVuY29kaW5nID0geG1sLmdldEF0dHJpYnV0ZSgnZW5jb2RpbmcnKTsKICAgIGlmIChlbmNvZGluZyA9PT0gJ2Jhc2U2NCcpIHsKICAgICAgc2hhcGUgPSBuZXcgU2hhcGUuY3JlYXRlKHt0eXBlOiBlbmNvZGluZ30pOwogICAgfQogIH0KCiAgdmFyIHRleHQgPSB4bWwudGV4dENvbnRlbnQ7CiAgaWYgKHRleHQgPT09ICcnKSB0ZXh0ID0gbnVsbDsKICBpZiAodHlwZW9mIHNoYXBlLnRvVHlwZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuIHNoYXBlLnRvVHlwZSh0ZXh0KTsKICB9IGVsc2UgewogICAgcmV0dXJuIHRleHQ7CiAgfQp9CgpmdW5jdGlvbiBwYXJzZVVua25vd24oeG1sKSB7CiAgaWYgKHhtbCA9PT0gdW5kZWZpbmVkIHx8IHhtbCA9PT0gbnVsbCkgcmV0dXJuICcnOwoKICAvLyBlbXB0eSBvYmplY3QKICBpZiAoIXhtbC5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgaWYgKHhtbC5wYXJlbnROb2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHJldHVybiB7fTsKICAgIGlmICh4bWwuY2hpbGROb2Rlcy5sZW5ndGggPT09IDApIHJldHVybiAnJzsKICAgIGVsc2UgcmV0dXJuIHhtbC50ZXh0Q29udGVudDsKICB9CgogIC8vIG9iamVjdCwgcGFyc2UgYXMgc3RydWN0dXJlCiAgdmFyIHNoYXBlID0ge3R5cGU6ICdzdHJ1Y3R1cmUnLCBtZW1iZXJzOiB7fX07CiAgdmFyIGNoaWxkID0geG1sLmZpcnN0RWxlbWVudENoaWxkOwogIHdoaWxlIChjaGlsZCkgewogICAgdmFyIHRhZyA9IGNoaWxkLm5vZGVOYW1lOwogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzaGFwZS5tZW1iZXJzLCB0YWcpKSB7CiAgICAgIC8vIG11bHRpcGxlIHRhZ3Mgb2YgdGhlIHNhbWUgbmFtZSBtYWtlcyBpdCBhIGxpc3QKICAgICAgc2hhcGUubWVtYmVyc1t0YWddLnR5cGUgPSAnbGlzdCc7CiAgICB9IGVsc2UgewogICAgICBzaGFwZS5tZW1iZXJzW3RhZ10gPSB7bmFtZTogdGFnfTsKICAgIH0KICAgIGNoaWxkID0gY2hpbGQubmV4dEVsZW1lbnRTaWJsaW5nOwogIH0KICByZXR1cm4gcGFyc2VTdHJ1Y3R1cmUoeG1sLCBzaGFwZSk7Cn0KCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gRG9tWG1sUGFyc2VyOwoKfSx7Ii4uL21vZGVsL3NoYXBlIjo0NCwiLi4vdXRpbCI6NzJ9XSw3NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwp2YXIgWG1sTm9kZSA9IHJlcXVpcmUoJy4veG1sLW5vZGUnKS5YbWxOb2RlOwp2YXIgWG1sVGV4dCA9IHJlcXVpcmUoJy4veG1sLXRleHQnKS5YbWxUZXh0OwoKZnVuY3Rpb24gWG1sQnVpbGRlcigpIHsgfQoKWG1sQnVpbGRlci5wcm90b3R5cGUudG9YTUwgPSBmdW5jdGlvbihwYXJhbXMsIHNoYXBlLCByb290RWxlbWVudCwgbm9FbXB0eSkgewogIHZhciB4bWwgPSBuZXcgWG1sTm9kZShyb290RWxlbWVudCk7CiAgYXBwbHlOYW1lc3BhY2VzKHhtbCwgc2hhcGUsIHRydWUpOwogIHNlcmlhbGl6ZSh4bWwsIHBhcmFtcywgc2hhcGUpOwogIHJldHVybiB4bWwuY2hpbGRyZW4ubGVuZ3RoID4gMCB8fCBub0VtcHR5ID8geG1sLnRvU3RyaW5nKCkgOiAnJzsKfTsKCmZ1bmN0aW9uIHNlcmlhbGl6ZSh4bWwsIHZhbHVlLCBzaGFwZSkgewogIHN3aXRjaCAoc2hhcGUudHlwZSkgewogICAgY2FzZSAnc3RydWN0dXJlJzogcmV0dXJuIHNlcmlhbGl6ZVN0cnVjdHVyZSh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICBjYXNlICdtYXAnOiByZXR1cm4gc2VyaWFsaXplTWFwKHhtbCwgdmFsdWUsIHNoYXBlKTsKICAgIGNhc2UgJ2xpc3QnOiByZXR1cm4gc2VyaWFsaXplTGlzdCh4bWwsIHZhbHVlLCBzaGFwZSk7CiAgICBkZWZhdWx0OiByZXR1cm4gc2VyaWFsaXplU2NhbGFyKHhtbCwgdmFsdWUsIHNoYXBlKTsKICB9Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZVN0cnVjdHVyZSh4bWwsIHBhcmFtcywgc2hhcGUpIHsKICB1dGlsLmFycmF5RWFjaChzaGFwZS5tZW1iZXJOYW1lcywgZnVuY3Rpb24obWVtYmVyTmFtZSkgewogICAgdmFyIG1lbWJlclNoYXBlID0gc2hhcGUubWVtYmVyc1ttZW1iZXJOYW1lXTsKICAgIGlmIChtZW1iZXJTaGFwZS5sb2NhdGlvbiAhPT0gJ2JvZHknKSByZXR1cm47CgogICAgdmFyIHZhbHVlID0gcGFyYW1zW21lbWJlck5hbWVdOwogICAgdmFyIG5hbWUgPSBtZW1iZXJTaGFwZS5uYW1lOwogICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgaWYgKG1lbWJlclNoYXBlLmlzWG1sQXR0cmlidXRlKSB7CiAgICAgICAgeG1sLmFkZEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgIH0gZWxzZSBpZiAobWVtYmVyU2hhcGUuZmxhdHRlbmVkKSB7CiAgICAgICAgc2VyaWFsaXplKHhtbCwgdmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgICAgYXBwbHlOYW1lc3BhY2VzKGVsZW1lbnQsIG1lbWJlclNoYXBlKTsKICAgICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIG1lbWJlclNoYXBlKTsKICAgICAgfQogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBzZXJpYWxpemVNYXAoeG1sLCBtYXAsIHNoYXBlKSB7CiAgdmFyIHhtbEtleSA9IHNoYXBlLmtleS5uYW1lIHx8ICdrZXknOwogIHZhciB4bWxWYWx1ZSA9IHNoYXBlLnZhbHVlLm5hbWUgfHwgJ3ZhbHVlJzsKCiAgdXRpbC5lYWNoKG1hcCwgZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgdmFyIGVudHJ5ID0gbmV3IFhtbE5vZGUoc2hhcGUuZmxhdHRlbmVkID8gc2hhcGUubmFtZSA6ICdlbnRyeScpOwogICAgeG1sLmFkZENoaWxkTm9kZShlbnRyeSk7CgogICAgdmFyIGVudHJ5S2V5ID0gbmV3IFhtbE5vZGUoeG1sS2V5KTsKICAgIHZhciBlbnRyeVZhbHVlID0gbmV3IFhtbE5vZGUoeG1sVmFsdWUpOwogICAgZW50cnkuYWRkQ2hpbGROb2RlKGVudHJ5S2V5KTsKICAgIGVudHJ5LmFkZENoaWxkTm9kZShlbnRyeVZhbHVlKTsKCiAgICBzZXJpYWxpemUoZW50cnlLZXksIGtleSwgc2hhcGUua2V5KTsKICAgIHNlcmlhbGl6ZShlbnRyeVZhbHVlLCB2YWx1ZSwgc2hhcGUudmFsdWUpOwogIH0pOwp9CgpmdW5jdGlvbiBzZXJpYWxpemVMaXN0KHhtbCwgbGlzdCwgc2hhcGUpIHsKICBpZiAoc2hhcGUuZmxhdHRlbmVkKSB7CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgbmFtZSA9IHNoYXBlLm1lbWJlci5uYW1lIHx8IHNoYXBlLm5hbWU7CiAgICAgIHZhciBlbGVtZW50ID0gbmV3IFhtbE5vZGUobmFtZSk7CiAgICAgIHhtbC5hZGRDaGlsZE5vZGUoZWxlbWVudCk7CiAgICAgIHNlcmlhbGl6ZShlbGVtZW50LCB2YWx1ZSwgc2hhcGUubWVtYmVyKTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICB1dGlsLmFycmF5RWFjaChsaXN0LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgbmFtZSA9IHNoYXBlLm1lbWJlci5uYW1lIHx8ICdtZW1iZXInOwogICAgICB2YXIgZWxlbWVudCA9IG5ldyBYbWxOb2RlKG5hbWUpOwogICAgICB4bWwuYWRkQ2hpbGROb2RlKGVsZW1lbnQpOwogICAgICBzZXJpYWxpemUoZWxlbWVudCwgdmFsdWUsIHNoYXBlLm1lbWJlcik7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIHNlcmlhbGl6ZVNjYWxhcih4bWwsIHZhbHVlLCBzaGFwZSkgewogIHhtbC5hZGRDaGlsZE5vZGUoCiAgICBuZXcgWG1sVGV4dChzaGFwZS50b1dpcmVGb3JtYXQodmFsdWUpKQogICk7Cn0KCmZ1bmN0aW9uIGFwcGx5TmFtZXNwYWNlcyh4bWwsIHNoYXBlLCBpc1Jvb3QpIHsKICB2YXIgdXJpLCBwcmVmaXggPSAneG1sbnMnOwogIGlmIChzaGFwZS54bWxOYW1lc3BhY2VVcmkpIHsKICAgIHVyaSA9IHNoYXBlLnhtbE5hbWVzcGFjZVVyaTsKICAgIGlmIChzaGFwZS54bWxOYW1lc3BhY2VQcmVmaXgpIHByZWZpeCArPSAnOicgKyBzaGFwZS54bWxOYW1lc3BhY2VQcmVmaXg7CiAgfSBlbHNlIGlmIChpc1Jvb3QgJiYgc2hhcGUuYXBpLnhtbE5hbWVzcGFjZVVyaSkgewogICAgdXJpID0gc2hhcGUuYXBpLnhtbE5hbWVzcGFjZVVyaTsKICB9CgogIGlmICh1cmkpIHhtbC5hZGRBdHRyaWJ1dGUocHJlZml4LCB1cmkpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IFhtbEJ1aWxkZXI7Cgp9LHsiLi4vdXRpbCI6NzIsIi4veG1sLW5vZGUiOjc3LCIuL3htbC10ZXh0Ijo3OH1dLDc1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIEVzY2FwZXMgY2hhcmFjdGVycyB0aGF0IGNhbiBub3QgYmUgaW4gYW4gWE1MIGF0dHJpYnV0ZS4KICovCmZ1bmN0aW9uIGVzY2FwZUF0dHJpYnV0ZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvJy9nLCAnJmFwb3M7JykucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKTsKfQoKLyoqCiAqIEBhcGkgcHJpdmF0ZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBlc2NhcGVBdHRyaWJ1dGU6IGVzY2FwZUF0dHJpYnV0ZQp9OwoKfSx7fV0sNzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogRXNjYXBlcyBjaGFyYWN0ZXJzIHRoYXQgY2FuIG5vdCBiZSBpbiBhbiBYTUwgZWxlbWVudC4KICovCmZ1bmN0aW9uIGVzY2FwZUVsZW1lbnQodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC8mL2csICcmYW1wOycpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvPC9nLCAnJmx0OycpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvPi9nLCAnJmd0OycpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHIvZywgJyYjeDBEOycpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvXG4vZywgJyYjeDBBOycpCiAgICAgICAgICAgICAgICAucmVwbGFjZSgvXHUwMDg1L2csICcmI3g4NTsnKQogICAgICAgICAgICAgICAgLnJlcGxhY2UoL1x1MjAyOC8sICcmI3gyMDI4OycpOwp9CgovKioKICogQGFwaSBwcml2YXRlCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKICAgIGVzY2FwZUVsZW1lbnQ6IGVzY2FwZUVsZW1lbnQKfTsKCn0se31dLDc3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGVzY2FwZUF0dHJpYnV0ZSA9IHJlcXVpcmUoJy4vZXNjYXBlLWF0dHJpYnV0ZScpLmVzY2FwZUF0dHJpYnV0ZTsKCi8qKgogKiBSZXByZXNlbnRzIGFuIFhNTCBub2RlLgogKiBAYXBpIHByaXZhdGUKICovCmZ1bmN0aW9uIFhtbE5vZGUobmFtZSwgY2hpbGRyZW4pIHsKICAgIGlmIChjaGlsZHJlbiA9PT0gdm9pZCAwKSB7IGNoaWxkcmVuID0gW107IH0KICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKfQpYbWxOb2RlLnByb3RvdHlwZS5hZGRBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgIHRoaXMuYXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlOwogICAgcmV0dXJuIHRoaXM7Cn07ClhtbE5vZGUucHJvdG90eXBlLmFkZENoaWxkTm9kZSA9IGZ1bmN0aW9uIChjaGlsZCkgewogICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTsKICAgIHJldHVybiB0aGlzOwp9OwpYbWxOb2RlLnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbiAobmFtZSkgewogICAgZGVsZXRlIHRoaXMuYXR0cmlidXRlc1tuYW1lXTsKICAgIHJldHVybiB0aGlzOwp9OwpYbWxOb2RlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBoYXNDaGlsZHJlbiA9IEJvb2xlYW4odGhpcy5jaGlsZHJlbi5sZW5ndGgpOwogICAgdmFyIHhtbFRleHQgPSAnPCcgKyB0aGlzLm5hbWU7CiAgICAvLyBhZGQgYXR0cmlidXRlcwogICAgdmFyIGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CiAgICBmb3IgKHZhciBpID0gMCwgYXR0cmlidXRlTmFtZXMgPSBPYmplY3Qua2V5cyhhdHRyaWJ1dGVzKTsgaSA8IGF0dHJpYnV0ZU5hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lc1tpXTsKICAgICAgICB2YXIgYXR0cmlidXRlID0gYXR0cmlidXRlc1thdHRyaWJ1dGVOYW1lXTsKICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgYXR0cmlidXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHhtbFRleHQgKz0gJyAnICsgYXR0cmlidXRlTmFtZSArICc9XCInICsgZXNjYXBlQXR0cmlidXRlKCcnICsgYXR0cmlidXRlKSArICdcIic7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHhtbFRleHQgKz0gIWhhc0NoaWxkcmVuID8gJy8+JyA6ICc+JyArIHRoaXMuY2hpbGRyZW4ubWFwKGZ1bmN0aW9uIChjKSB7IHJldHVybiBjLnRvU3RyaW5nKCk7IH0pLmpvaW4oJycpICsgJzwvJyArIHRoaXMubmFtZSArICc+JzsKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgWG1sTm9kZTogWG1sTm9kZQp9OwoKfSx7Ii4vZXNjYXBlLWF0dHJpYnV0ZSI6NzV9XSw3ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBlc2NhcGVFbGVtZW50ID0gcmVxdWlyZSgnLi9lc2NhcGUtZWxlbWVudCcpLmVzY2FwZUVsZW1lbnQ7CgovKioKICogUmVwcmVzZW50cyBhbiBYTUwgdGV4dCB2YWx1ZS4KICogQGFwaSBwcml2YXRlCiAqLwpmdW5jdGlvbiBYbWxUZXh0KHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7Cn0KClhtbFRleHQucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGVzY2FwZUVsZW1lbnQoJycgKyB0aGlzLnZhbHVlKTsKfTsKCi8qKgogKiBAYXBpIHByaXZhdGUKICovCm1vZHVsZS5leHBvcnRzID0gewogICAgWG1sVGV4dDogWG1sVGV4dAp9OwoKfSx7Ii4vZXNjYXBlLWVsZW1lbnQiOjc2fV0sNzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCcKCmV4cG9ydHMuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKZXhwb3J0cy50b0J5dGVBcnJheSA9IHRvQnl0ZUFycmF5CmV4cG9ydHMuZnJvbUJ5dGVBcnJheSA9IGZyb21CeXRlQXJyYXkKCnZhciBsb29rdXAgPSBbXQp2YXIgcmV2TG9va3VwID0gW10KdmFyIEFyciA9IHR5cGVvZiBVaW50OEFycmF5ICE9PSAndW5kZWZpbmVkJyA/IFVpbnQ4QXJyYXkgOiBBcnJheQoKdmFyIGNvZGUgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODkrLycKZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNvZGUubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICBsb29rdXBbaV0gPSBjb2RlW2ldCiAgcmV2TG9va3VwW2NvZGUuY2hhckNvZGVBdChpKV0gPSBpCn0KCi8vIFN1cHBvcnQgZGVjb2RpbmcgVVJMLXNhZmUgYmFzZTY0IHN0cmluZ3MsIGFzIE5vZGUuanMgZG9lcy4KLy8gU2VlOiBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9CYXNlNjQjVVJMX2FwcGxpY2F0aW9ucwpyZXZMb29rdXBbJy0nLmNoYXJDb2RlQXQoMCldID0gNjIKcmV2TG9va3VwWydfJy5jaGFyQ29kZUF0KDApXSA9IDYzCgpmdW5jdGlvbiBnZXRMZW5zIChiNjQpIHsKICB2YXIgbGVuID0gYjY0Lmxlbmd0aAoKICBpZiAobGVuICUgNCA+IDApIHsKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBzdHJpbmcuIExlbmd0aCBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgNCcpCiAgfQoKICAvLyBUcmltIG9mZiBleHRyYSBieXRlcyBhZnRlciBwbGFjZWhvbGRlciBieXRlcyBhcmUgZm91bmQKICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9iZWF0Z2FtbWl0L2Jhc2U2NC1qcy9pc3N1ZXMvNDIKICB2YXIgdmFsaWRMZW4gPSBiNjQuaW5kZXhPZignPScpCiAgaWYgKHZhbGlkTGVuID09PSAtMSkgdmFsaWRMZW4gPSBsZW4KCiAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IHZhbGlkTGVuID09PSBsZW4KICAgID8gMAogICAgOiA0IC0gKHZhbGlkTGVuICUgNCkKCiAgcmV0dXJuIFt2YWxpZExlbiwgcGxhY2VIb2xkZXJzTGVuXQp9CgovLyBiYXNlNjQgaXMgNC8zICsgdXAgdG8gdHdvIGNoYXJhY3RlcnMgb2YgdGhlIG9yaWdpbmFsIGRhdGEKZnVuY3Rpb24gYnl0ZUxlbmd0aCAoYjY0KSB7CiAgdmFyIGxlbnMgPSBnZXRMZW5zKGI2NCkKICB2YXIgdmFsaWRMZW4gPSBsZW5zWzBdCiAgdmFyIHBsYWNlSG9sZGVyc0xlbiA9IGxlbnNbMV0KICByZXR1cm4gKCh2YWxpZExlbiArIHBsYWNlSG9sZGVyc0xlbikgKiAzIC8gNCkgLSBwbGFjZUhvbGRlcnNMZW4KfQoKZnVuY3Rpb24gX2J5dGVMZW5ndGggKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikgewogIHJldHVybiAoKHZhbGlkTGVuICsgcGxhY2VIb2xkZXJzTGVuKSAqIDMgLyA0KSAtIHBsYWNlSG9sZGVyc0xlbgp9CgpmdW5jdGlvbiB0b0J5dGVBcnJheSAoYjY0KSB7CiAgdmFyIHRtcAogIHZhciBsZW5zID0gZ2V0TGVucyhiNjQpCiAgdmFyIHZhbGlkTGVuID0gbGVuc1swXQogIHZhciBwbGFjZUhvbGRlcnNMZW4gPSBsZW5zWzFdCgogIHZhciBhcnIgPSBuZXcgQXJyKF9ieXRlTGVuZ3RoKGI2NCwgdmFsaWRMZW4sIHBsYWNlSG9sZGVyc0xlbikpCgogIHZhciBjdXJCeXRlID0gMAoKICAvLyBpZiB0aGVyZSBhcmUgcGxhY2Vob2xkZXJzLCBvbmx5IGdldCB1cCB0byB0aGUgbGFzdCBjb21wbGV0ZSA0IGNoYXJzCiAgdmFyIGxlbiA9IHBsYWNlSG9sZGVyc0xlbiA+IDAKICAgID8gdmFsaWRMZW4gLSA0CiAgICA6IHZhbGlkTGVuCgogIHZhciBpCiAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSArPSA0KSB7CiAgICB0bXAgPQogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkpXSA8PCAxOCkgfAogICAgICAocmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAxKV0gPDwgMTIpIHwKICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMildIDw8IDYpIHwKICAgICAgcmV2TG9va3VwW2I2NC5jaGFyQ29kZUF0KGkgKyAzKV0KICAgIGFycltjdXJCeXRlKytdID0gKHRtcCA+PiAxNikgJiAweEZGCiAgICBhcnJbY3VyQnl0ZSsrXSA9ICh0bXAgPj4gOCkgJiAweEZGCiAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICB9CgogIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDIpIHsKICAgIHRtcCA9CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDIpIHwKICAgICAgKHJldkxvb2t1cFtiNjQuY2hhckNvZGVBdChpICsgMSldID4+IDQpCiAgICBhcnJbY3VyQnl0ZSsrXSA9IHRtcCAmIDB4RkYKICB9CgogIGlmIChwbGFjZUhvbGRlcnNMZW4gPT09IDEpIHsKICAgIHRtcCA9CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSldIDw8IDEwKSB8CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDEpXSA8PCA0KSB8CiAgICAgIChyZXZMb29rdXBbYjY0LmNoYXJDb2RlQXQoaSArIDIpXSA+PiAyKQogICAgYXJyW2N1ckJ5dGUrK10gPSAodG1wID4+IDgpICYgMHhGRgogICAgYXJyW2N1ckJ5dGUrK10gPSB0bXAgJiAweEZGCiAgfQoKICByZXR1cm4gYXJyCn0KCmZ1bmN0aW9uIHRyaXBsZXRUb0Jhc2U2NCAobnVtKSB7CiAgcmV0dXJuIGxvb2t1cFtudW0gPj4gMTggJiAweDNGXSArCiAgICBsb29rdXBbbnVtID4+IDEyICYgMHgzRl0gKwogICAgbG9va3VwW251bSA+PiA2ICYgMHgzRl0gKwogICAgbG9va3VwW251bSAmIDB4M0ZdCn0KCmZ1bmN0aW9uIGVuY29kZUNodW5rICh1aW50OCwgc3RhcnQsIGVuZCkgewogIHZhciB0bXAKICB2YXIgb3V0cHV0ID0gW10KICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkgKz0gMykgewogICAgdG1wID0KICAgICAgKCh1aW50OFtpXSA8PCAxNikgJiAweEZGMDAwMCkgKwogICAgICAoKHVpbnQ4W2kgKyAxXSA8PCA4KSAmIDB4RkYwMCkgKwogICAgICAodWludDhbaSArIDJdICYgMHhGRikKICAgIG91dHB1dC5wdXNoKHRyaXBsZXRUb0Jhc2U2NCh0bXApKQogIH0KICByZXR1cm4gb3V0cHV0LmpvaW4oJycpCn0KCmZ1bmN0aW9uIGZyb21CeXRlQXJyYXkgKHVpbnQ4KSB7CiAgdmFyIHRtcAogIHZhciBsZW4gPSB1aW50OC5sZW5ndGgKICB2YXIgZXh0cmFCeXRlcyA9IGxlbiAlIDMgLy8gaWYgd2UgaGF2ZSAxIGJ5dGUgbGVmdCwgcGFkIDIgYnl0ZXMKICB2YXIgcGFydHMgPSBbXQogIHZhciBtYXhDaHVua0xlbmd0aCA9IDE2MzgzIC8vIG11c3QgYmUgbXVsdGlwbGUgb2YgMwoKICAvLyBnbyB0aHJvdWdoIHRoZSBhcnJheSBldmVyeSB0aHJlZSBieXRlcywgd2UnbGwgZGVhbCB3aXRoIHRyYWlsaW5nIHN0dWZmIGxhdGVyCiAgZm9yICh2YXIgaSA9IDAsIGxlbjIgPSBsZW4gLSBleHRyYUJ5dGVzOyBpIDwgbGVuMjsgaSArPSBtYXhDaHVua0xlbmd0aCkgewogICAgcGFydHMucHVzaChlbmNvZGVDaHVuayh1aW50OCwgaSwgKGkgKyBtYXhDaHVua0xlbmd0aCkgPiBsZW4yID8gbGVuMiA6IChpICsgbWF4Q2h1bmtMZW5ndGgpKSkKICB9CgogIC8vIHBhZCB0aGUgZW5kIHdpdGggemVyb3MsIGJ1dCBtYWtlIHN1cmUgdG8gbm90IGZvcmdldCB0aGUgZXh0cmEgYnl0ZXMKICBpZiAoZXh0cmFCeXRlcyA9PT0gMSkgewogICAgdG1wID0gdWludDhbbGVuIC0gMV0KICAgIHBhcnRzLnB1c2goCiAgICAgIGxvb2t1cFt0bXAgPj4gMl0gKwogICAgICBsb29rdXBbKHRtcCA8PCA0KSAmIDB4M0ZdICsKICAgICAgJz09JwogICAgKQogIH0gZWxzZSBpZiAoZXh0cmFCeXRlcyA9PT0gMikgewogICAgdG1wID0gKHVpbnQ4W2xlbiAtIDJdIDw8IDgpICsgdWludDhbbGVuIC0gMV0KICAgIHBhcnRzLnB1c2goCiAgICAgIGxvb2t1cFt0bXAgPj4gMTBdICsKICAgICAgbG9va3VwWyh0bXAgPj4gNCkgJiAweDNGXSArCiAgICAgIGxvb2t1cFsodG1wIDw8IDIpICYgMHgzRl0gKwogICAgICAnPScKICAgICkKICB9CgogIHJldHVybiBwYXJ0cy5qb2luKCcnKQp9Cgp9LHt9XSw4MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cgp9LHt9XSw4MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogIC8vIGltcGxlbWVudGF0aW9uIGZyb20gc3RhbmRhcmQgbm9kZS5qcyAndXRpbCcgbW9kdWxlCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICBjdG9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDdG9yLnByb3RvdHlwZSwgewogICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgIHZhbHVlOiBjdG9yLAogICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICB9CiAgICB9KTsKICB9Owp9IGVsc2UgewogIC8vIG9sZCBzY2hvb2wgc2hpbSBmb3Igb2xkIGJyb3dzZXJzCiAgbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBpbmhlcml0cyhjdG9yLCBzdXBlckN0b3IpIHsKICAgIGN0b3Iuc3VwZXJfID0gc3VwZXJDdG9yCiAgICB2YXIgVGVtcEN0b3IgPSBmdW5jdGlvbiAoKSB7fQogICAgVGVtcEN0b3IucHJvdG90eXBlID0gc3VwZXJDdG9yLnByb3RvdHlwZQogICAgY3Rvci5wcm90b3R5cGUgPSBuZXcgVGVtcEN0b3IoKQogICAgY3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBjdG9yCiAgfQp9Cgp9LHt9XSw4MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gaXNCdWZmZXIoYXJnKSB7CiAgcmV0dXJuIGFyZyAmJiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JwogICAgJiYgdHlwZW9mIGFyZy5jb3B5ID09PSAnZnVuY3Rpb24nCiAgICAmJiB0eXBlb2YgYXJnLmZpbGwgPT09ICdmdW5jdGlvbicKICAgICYmIHR5cGVvZiBhcmcucmVhZFVJbnQ4ID09PSAnZnVuY3Rpb24nOwp9Cn0se31dLDgzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzLGdsb2JhbCl7KGZ1bmN0aW9uICgpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgp2YXIgZm9ybWF0UmVnRXhwID0gLyVbc2RqJV0vZzsKZXhwb3J0cy5mb3JtYXQgPSBmdW5jdGlvbihmKSB7CiAgaWYgKCFpc1N0cmluZyhmKSkgewogICAgdmFyIG9iamVjdHMgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIG9iamVjdHMucHVzaChpbnNwZWN0KGFyZ3VtZW50c1tpXSkpOwogICAgfQogICAgcmV0dXJuIG9iamVjdHMuam9pbignICcpOwogIH0KCiAgdmFyIGkgPSAxOwogIHZhciBhcmdzID0gYXJndW1lbnRzOwogIHZhciBsZW4gPSBhcmdzLmxlbmd0aDsKICB2YXIgc3RyID0gU3RyaW5nKGYpLnJlcGxhY2UoZm9ybWF0UmVnRXhwLCBmdW5jdGlvbih4KSB7CiAgICBpZiAoeCA9PT0gJyUlJykgcmV0dXJuICclJzsKICAgIGlmIChpID49IGxlbikgcmV0dXJuIHg7CiAgICBzd2l0Y2ggKHgpIHsKICAgICAgY2FzZSAnJXMnOiByZXR1cm4gU3RyaW5nKGFyZ3NbaSsrXSk7CiAgICAgIGNhc2UgJyVkJzogcmV0dXJuIE51bWJlcihhcmdzW2krK10pOwogICAgICBjYXNlICclaic6CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhcmdzW2krK10pOwogICAgICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgICAgIHJldHVybiAnW0NpcmN1bGFyXSc7CiAgICAgICAgfQogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiB4OwogICAgfQogIH0pOwogIGZvciAodmFyIHggPSBhcmdzW2ldOyBpIDwgbGVuOyB4ID0gYXJnc1srK2ldKSB7CiAgICBpZiAoaXNOdWxsKHgpIHx8ICFpc09iamVjdCh4KSkgewogICAgICBzdHIgKz0gJyAnICsgeDsKICAgIH0gZWxzZSB7CiAgICAgIHN0ciArPSAnICcgKyBpbnNwZWN0KHgpOwogICAgfQogIH0KICByZXR1cm4gc3RyOwp9OwoKCi8vIE1hcmsgdGhhdCBhIG1ldGhvZCBzaG91bGQgbm90IGJlIHVzZWQuCi8vIFJldHVybnMgYSBtb2RpZmllZCBmdW5jdGlvbiB3aGljaCB3YXJucyBvbmNlIGJ5IGRlZmF1bHQuCi8vIElmIC0tbm8tZGVwcmVjYXRpb24gaXMgc2V0LCB0aGVuIGl0IGlzIGEgbm8tb3AuCmV4cG9ydHMuZGVwcmVjYXRlID0gZnVuY3Rpb24oZm4sIG1zZykgewogIC8vIEFsbG93IGZvciBkZXByZWNhdGluZyB0aGluZ3MgaW4gdGhlIHByb2Nlc3Mgb2Ygc3RhcnRpbmcgdXAuCiAgaWYgKGlzVW5kZWZpbmVkKGdsb2JhbC5wcm9jZXNzKSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZXhwb3J0cy5kZXByZWNhdGUoZm4sIG1zZykuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfQoKICBpZiAocHJvY2Vzcy5ub0RlcHJlY2F0aW9uID09PSB0cnVlKSB7CiAgICByZXR1cm4gZm47CiAgfQoKICB2YXIgd2FybmVkID0gZmFsc2U7CiAgZnVuY3Rpb24gZGVwcmVjYXRlZCgpIHsKICAgIGlmICghd2FybmVkKSB7CiAgICAgIGlmIChwcm9jZXNzLnRocm93RGVwcmVjYXRpb24pIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLnRyYWNlRGVwcmVjYXRpb24pIHsKICAgICAgICBjb25zb2xlLnRyYWNlKG1zZyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihtc2cpOwogICAgICB9CiAgICAgIHdhcm5lZCA9IHRydWU7CiAgICB9CiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9CgogIHJldHVybiBkZXByZWNhdGVkOwp9OwoKCnZhciBkZWJ1Z3MgPSB7fTsKdmFyIGRlYnVnRW52aXJvbjsKZXhwb3J0cy5kZWJ1Z2xvZyA9IGZ1bmN0aW9uKHNldCkgewogIGlmIChpc1VuZGVmaW5lZChkZWJ1Z0Vudmlyb24pKQogICAgZGVidWdFbnZpcm9uID0gcHJvY2Vzcy5lbnYuTk9ERV9ERUJVRyB8fCAnJzsKICBzZXQgPSBzZXQudG9VcHBlckNhc2UoKTsKICBpZiAoIWRlYnVnc1tzZXRdKSB7CiAgICBpZiAobmV3IFJlZ0V4cCgnXFxiJyArIHNldCArICdcXGInLCAnaScpLnRlc3QoZGVidWdFbnZpcm9uKSkgewogICAgICB2YXIgcGlkID0gcHJvY2Vzcy5waWQ7CiAgICAgIGRlYnVnc1tzZXRdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG1zZyA9IGV4cG9ydHMuZm9ybWF0LmFwcGx5KGV4cG9ydHMsIGFyZ3VtZW50cyk7CiAgICAgICAgY29uc29sZS5lcnJvcignJXMgJWQ6ICVzJywgc2V0LCBwaWQsIG1zZyk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBkZWJ1Z3Nbc2V0XSA9IGZ1bmN0aW9uKCkge307CiAgICB9CiAgfQogIHJldHVybiBkZWJ1Z3Nbc2V0XTsKfTsKCgovKioKICogRWNob3MgdGhlIHZhbHVlIG9mIGEgdmFsdWUuIFRyeXMgdG8gcHJpbnQgdGhlIHZhbHVlIG91dAogKiBpbiB0aGUgYmVzdCB3YXkgcG9zc2libGUgZ2l2ZW4gdGhlIGRpZmZlcmVudCB0eXBlcy4KICoKICogQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgb2JqZWN0IHRvIHByaW50IG91dC4KICogQHBhcmFtIHtPYmplY3R9IG9wdHMgT3B0aW9uYWwgb3B0aW9ucyBvYmplY3QgdGhhdCBhbHRlcnMgdGhlIG91dHB1dC4KICovCi8qIGxlZ2FjeTogb2JqLCBzaG93SGlkZGVuLCBkZXB0aCwgY29sb3JzKi8KZnVuY3Rpb24gaW5zcGVjdChvYmosIG9wdHMpIHsKICAvLyBkZWZhdWx0IG9wdGlvbnMKICB2YXIgY3R4ID0gewogICAgc2VlbjogW10sCiAgICBzdHlsaXplOiBzdHlsaXplTm9Db2xvcgogIH07CiAgLy8gbGVnYWN5Li4uCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPj0gMykgY3R4LmRlcHRoID0gYXJndW1lbnRzWzJdOwogIGlmIChhcmd1bWVudHMubGVuZ3RoID49IDQpIGN0eC5jb2xvcnMgPSBhcmd1bWVudHNbM107CiAgaWYgKGlzQm9vbGVhbihvcHRzKSkgewogICAgLy8gbGVnYWN5Li4uCiAgICBjdHguc2hvd0hpZGRlbiA9IG9wdHM7CiAgfSBlbHNlIGlmIChvcHRzKSB7CiAgICAvLyBnb3QgYW4gIm9wdGlvbnMiIG9iamVjdAogICAgZXhwb3J0cy5fZXh0ZW5kKGN0eCwgb3B0cyk7CiAgfQogIC8vIHNldCBkZWZhdWx0IG9wdGlvbnMKICBpZiAoaXNVbmRlZmluZWQoY3R4LnNob3dIaWRkZW4pKSBjdHguc2hvd0hpZGRlbiA9IGZhbHNlOwogIGlmIChpc1VuZGVmaW5lZChjdHguZGVwdGgpKSBjdHguZGVwdGggPSAyOwogIGlmIChpc1VuZGVmaW5lZChjdHguY29sb3JzKSkgY3R4LmNvbG9ycyA9IGZhbHNlOwogIGlmIChpc1VuZGVmaW5lZChjdHguY3VzdG9tSW5zcGVjdCkpIGN0eC5jdXN0b21JbnNwZWN0ID0gdHJ1ZTsKICBpZiAoY3R4LmNvbG9ycykgY3R4LnN0eWxpemUgPSBzdHlsaXplV2l0aENvbG9yOwogIHJldHVybiBmb3JtYXRWYWx1ZShjdHgsIG9iaiwgY3R4LmRlcHRoKTsKfQpleHBvcnRzLmluc3BlY3QgPSBpbnNwZWN0OwoKCi8vIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQU5TSV9lc2NhcGVfY29kZSNncmFwaGljcwppbnNwZWN0LmNvbG9ycyA9IHsKICAnYm9sZCcgOiBbMSwgMjJdLAogICdpdGFsaWMnIDogWzMsIDIzXSwKICAndW5kZXJsaW5lJyA6IFs0LCAyNF0sCiAgJ2ludmVyc2UnIDogWzcsIDI3XSwKICAnd2hpdGUnIDogWzM3LCAzOV0sCiAgJ2dyZXknIDogWzkwLCAzOV0sCiAgJ2JsYWNrJyA6IFszMCwgMzldLAogICdibHVlJyA6IFszNCwgMzldLAogICdjeWFuJyA6IFszNiwgMzldLAogICdncmVlbicgOiBbMzIsIDM5XSwKICAnbWFnZW50YScgOiBbMzUsIDM5XSwKICAncmVkJyA6IFszMSwgMzldLAogICd5ZWxsb3cnIDogWzMzLCAzOV0KfTsKCi8vIERvbid0IHVzZSAnYmx1ZScgbm90IHZpc2libGUgb24gY21kLmV4ZQppbnNwZWN0LnN0eWxlcyA9IHsKICAnc3BlY2lhbCc6ICdjeWFuJywKICAnbnVtYmVyJzogJ3llbGxvdycsCiAgJ2Jvb2xlYW4nOiAneWVsbG93JywKICAndW5kZWZpbmVkJzogJ2dyZXknLAogICdudWxsJzogJ2JvbGQnLAogICdzdHJpbmcnOiAnZ3JlZW4nLAogICdkYXRlJzogJ21hZ2VudGEnLAogIC8vICJuYW1lIjogaW50ZW50aW9uYWxseSBub3Qgc3R5bGluZwogICdyZWdleHAnOiAncmVkJwp9OwoKCmZ1bmN0aW9uIHN0eWxpemVXaXRoQ29sb3Ioc3RyLCBzdHlsZVR5cGUpIHsKICB2YXIgc3R5bGUgPSBpbnNwZWN0LnN0eWxlc1tzdHlsZVR5cGVdOwoKICBpZiAoc3R5bGUpIHsKICAgIHJldHVybiAnXHUwMDFiWycgKyBpbnNwZWN0LmNvbG9yc1tzdHlsZV1bMF0gKyAnbScgKyBzdHIgKwogICAgICAgICAgICdcdTAwMWJbJyArIGluc3BlY3QuY29sb3JzW3N0eWxlXVsxXSArICdtJzsKICB9IGVsc2UgewogICAgcmV0dXJuIHN0cjsKICB9Cn0KCgpmdW5jdGlvbiBzdHlsaXplTm9Db2xvcihzdHIsIHN0eWxlVHlwZSkgewogIHJldHVybiBzdHI7Cn0KCgpmdW5jdGlvbiBhcnJheVRvSGFzaChhcnJheSkgewogIHZhciBoYXNoID0ge307CgogIGFycmF5LmZvckVhY2goZnVuY3Rpb24odmFsLCBpZHgpIHsKICAgIGhhc2hbdmFsXSA9IHRydWU7CiAgfSk7CgogIHJldHVybiBoYXNoOwp9CgoKZnVuY3Rpb24gZm9ybWF0VmFsdWUoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzKSB7CiAgLy8gUHJvdmlkZSBhIGhvb2sgZm9yIHVzZXItc3BlY2lmaWVkIGluc3BlY3QgZnVuY3Rpb25zLgogIC8vIENoZWNrIHRoYXQgdmFsdWUgaXMgYW4gb2JqZWN0IHdpdGggYW4gaW5zcGVjdCBmdW5jdGlvbiBvbiBpdAogIGlmIChjdHguY3VzdG9tSW5zcGVjdCAmJgogICAgICB2YWx1ZSAmJgogICAgICBpc0Z1bmN0aW9uKHZhbHVlLmluc3BlY3QpICYmCiAgICAgIC8vIEZpbHRlciBvdXQgdGhlIHV0aWwgbW9kdWxlLCBpdCdzIGluc3BlY3QgZnVuY3Rpb24gaXMgc3BlY2lhbAogICAgICB2YWx1ZS5pbnNwZWN0ICE9PSBleHBvcnRzLmluc3BlY3QgJiYKICAgICAgLy8gQWxzbyBmaWx0ZXIgb3V0IGFueSBwcm90b3R5cGUgb2JqZWN0cyB1c2luZyB0aGUgY2lyY3VsYXIgY2hlY2suCiAgICAgICEodmFsdWUuY29uc3RydWN0b3IgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlID09PSB2YWx1ZSkpIHsKICAgIHZhciByZXQgPSB2YWx1ZS5pbnNwZWN0KHJlY3Vyc2VUaW1lcywgY3R4KTsKICAgIGlmICghaXNTdHJpbmcocmV0KSkgewogICAgICByZXQgPSBmb3JtYXRWYWx1ZShjdHgsIHJldCwgcmVjdXJzZVRpbWVzKTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfQoKICAvLyBQcmltaXRpdmUgdHlwZXMgY2Fubm90IGhhdmUgcHJvcGVydGllcwogIHZhciBwcmltaXRpdmUgPSBmb3JtYXRQcmltaXRpdmUoY3R4LCB2YWx1ZSk7CiAgaWYgKHByaW1pdGl2ZSkgewogICAgcmV0dXJuIHByaW1pdGl2ZTsKICB9CgogIC8vIExvb2sgdXAgdGhlIGtleXMgb2YgdGhlIG9iamVjdC4KICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKHZhbHVlKTsKICB2YXIgdmlzaWJsZUtleXMgPSBhcnJheVRvSGFzaChrZXlzKTsKCiAgaWYgKGN0eC5zaG93SGlkZGVuKSB7CiAgICBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXModmFsdWUpOwogIH0KCiAgLy8gSUUgZG9lc24ndCBtYWtlIGVycm9yIGZpZWxkcyBub24tZW51bWVyYWJsZQogIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9kd3c1MnNidCh2PXZzLjk0KS5hc3B4CiAgaWYgKGlzRXJyb3IodmFsdWUpCiAgICAgICYmIChrZXlzLmluZGV4T2YoJ21lc3NhZ2UnKSA+PSAwIHx8IGtleXMuaW5kZXhPZignZGVzY3JpcHRpb24nKSA+PSAwKSkgewogICAgcmV0dXJuIGZvcm1hdEVycm9yKHZhbHVlKTsKICB9CgogIC8vIFNvbWUgdHlwZSBvZiBvYmplY3Qgd2l0aG91dCBwcm9wZXJ0aWVzIGNhbiBiZSBzaG9ydGN1dHRlZC4KICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHsKICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICB2YXIgbmFtZSA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgICByZXR1cm4gY3R4LnN0eWxpemUoJ1tGdW5jdGlvbicgKyBuYW1lICsgJ10nLCAnc3BlY2lhbCcpOwogICAgfQogICAgaWYgKGlzUmVnRXhwKHZhbHVlKSkgewogICAgICByZXR1cm4gY3R4LnN0eWxpemUoUmVnRXhwLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSwgJ3JlZ2V4cCcpOwogICAgfQogICAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKERhdGUucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLCAnZGF0ZScpOwogICAgfQogICAgaWYgKGlzRXJyb3IodmFsdWUpKSB7CiAgICAgIHJldHVybiBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgICB9CiAgfQoKICB2YXIgYmFzZSA9ICcnLCBhcnJheSA9IGZhbHNlLCBicmFjZXMgPSBbJ3snLCAnfSddOwoKICAvLyBNYWtlIEFycmF5IHNheSB0aGF0IHRoZXkgYXJlIEFycmF5CiAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICBhcnJheSA9IHRydWU7CiAgICBicmFjZXMgPSBbJ1snLCAnXSddOwogIH0KCiAgLy8gTWFrZSBmdW5jdGlvbnMgc2F5IHRoYXQgdGhleSBhcmUgZnVuY3Rpb25zCiAgaWYgKGlzRnVuY3Rpb24odmFsdWUpKSB7CiAgICB2YXIgbiA9IHZhbHVlLm5hbWUgPyAnOiAnICsgdmFsdWUubmFtZSA6ICcnOwogICAgYmFzZSA9ICcgW0Z1bmN0aW9uJyArIG4gKyAnXSc7CiAgfQoKICAvLyBNYWtlIFJlZ0V4cHMgc2F5IHRoYXQgdGhleSBhcmUgUmVnRXhwcwogIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgIGJhc2UgPSAnICcgKyBSZWdFeHAucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpOwogIH0KCiAgLy8gTWFrZSBkYXRlcyB3aXRoIHByb3BlcnRpZXMgZmlyc3Qgc2F5IHRoZSBkYXRlCiAgaWYgKGlzRGF0ZSh2YWx1ZSkpIHsKICAgIGJhc2UgPSAnICcgKyBEYXRlLnByb3RvdHlwZS50b1VUQ1N0cmluZy5jYWxsKHZhbHVlKTsKICB9CgogIC8vIE1ha2UgZXJyb3Igd2l0aCBtZXNzYWdlIGZpcnN0IHNheSB0aGUgZXJyb3IKICBpZiAoaXNFcnJvcih2YWx1ZSkpIHsKICAgIGJhc2UgPSAnICcgKyBmb3JtYXRFcnJvcih2YWx1ZSk7CiAgfQoKICBpZiAoa2V5cy5sZW5ndGggPT09IDAgJiYgKCFhcnJheSB8fCB2YWx1ZS5sZW5ndGggPT0gMCkpIHsKICAgIHJldHVybiBicmFjZXNbMF0gKyBiYXNlICsgYnJhY2VzWzFdOwogIH0KCiAgaWYgKHJlY3Vyc2VUaW1lcyA8IDApIHsKICAgIGlmIChpc1JlZ0V4cCh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIGN0eC5zdHlsaXplKFJlZ0V4cC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSksICdyZWdleHAnKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBjdHguc3R5bGl6ZSgnW09iamVjdF0nLCAnc3BlY2lhbCcpOwogICAgfQogIH0KCiAgY3R4LnNlZW4ucHVzaCh2YWx1ZSk7CgogIHZhciBvdXRwdXQ7CiAgaWYgKGFycmF5KSB7CiAgICBvdXRwdXQgPSBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKTsKICB9IGVsc2UgewogICAgb3V0cHV0ID0ga2V5cy5tYXAoZnVuY3Rpb24oa2V5KSB7CiAgICAgIHJldHVybiBmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXksIGFycmF5KTsKICAgIH0pOwogIH0KCiAgY3R4LnNlZW4ucG9wKCk7CgogIHJldHVybiByZWR1Y2VUb1NpbmdsZVN0cmluZyhvdXRwdXQsIGJhc2UsIGJyYWNlcyk7Cn0KCgpmdW5jdGlvbiBmb3JtYXRQcmltaXRpdmUoY3R4LCB2YWx1ZSkgewogIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICByZXR1cm4gY3R4LnN0eWxpemUoJ3VuZGVmaW5lZCcsICd1bmRlZmluZWQnKTsKICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICB2YXIgc2ltcGxlID0gJ1wnJyArIEpTT04uc3RyaW5naWZ5KHZhbHVlKS5yZXBsYWNlKC9eInwiJC9nLCAnJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLycvZywgIlxcJyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXCIvZywgJyInKSArICdcJyc7CiAgICByZXR1cm4gY3R4LnN0eWxpemUoc2ltcGxlLCAnc3RyaW5nJyk7CiAgfQogIGlmIChpc051bWJlcih2YWx1ZSkpCiAgICByZXR1cm4gY3R4LnN0eWxpemUoJycgKyB2YWx1ZSwgJ251bWJlcicpOwogIGlmIChpc0Jvb2xlYW4odmFsdWUpKQogICAgcmV0dXJuIGN0eC5zdHlsaXplKCcnICsgdmFsdWUsICdib29sZWFuJyk7CiAgLy8gRm9yIHNvbWUgcmVhc29uIHR5cGVvZiBudWxsIGlzICJvYmplY3QiLCBzbyBzcGVjaWFsIGNhc2UgaGVyZS4KICBpZiAoaXNOdWxsKHZhbHVlKSkKICAgIHJldHVybiBjdHguc3R5bGl6ZSgnbnVsbCcsICdudWxsJyk7Cn0KCgpmdW5jdGlvbiBmb3JtYXRFcnJvcih2YWx1ZSkgewogIHJldHVybiAnWycgKyBFcnJvci5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgKyAnXSc7Cn0KCgpmdW5jdGlvbiBmb3JtYXRBcnJheShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLCBrZXlzKSB7CiAgdmFyIG91dHB1dCA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICBpZiAoaGFzT3duUHJvcGVydHkodmFsdWUsIFN0cmluZyhpKSkpIHsKICAgICAgb3V0cHV0LnB1c2goZm9ybWF0UHJvcGVydHkoY3R4LCB2YWx1ZSwgcmVjdXJzZVRpbWVzLCB2aXNpYmxlS2V5cywKICAgICAgICAgIFN0cmluZyhpKSwgdHJ1ZSkpOwogICAgfSBlbHNlIHsKICAgICAgb3V0cHV0LnB1c2goJycpOwogICAgfQogIH0KICBrZXlzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICBpZiAoIWtleS5tYXRjaCgvXlxkKyQvKSkgewogICAgICBvdXRwdXQucHVzaChmb3JtYXRQcm9wZXJ0eShjdHgsIHZhbHVlLCByZWN1cnNlVGltZXMsIHZpc2libGVLZXlzLAogICAgICAgICAga2V5LCB0cnVlKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIG91dHB1dDsKfQoKCmZ1bmN0aW9uIGZvcm1hdFByb3BlcnR5KGN0eCwgdmFsdWUsIHJlY3Vyc2VUaW1lcywgdmlzaWJsZUtleXMsIGtleSwgYXJyYXkpIHsKICB2YXIgbmFtZSwgc3RyLCBkZXNjOwogIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHZhbHVlLCBrZXkpIHx8IHsgdmFsdWU6IHZhbHVlW2tleV0gfTsKICBpZiAoZGVzYy5nZXQpIHsKICAgIGlmIChkZXNjLnNldCkgewogICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW0dldHRlci9TZXR0ZXJdJywgJ3NwZWNpYWwnKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0ciA9IGN0eC5zdHlsaXplKCdbR2V0dGVyXScsICdzcGVjaWFsJyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChkZXNjLnNldCkgewogICAgICBzdHIgPSBjdHguc3R5bGl6ZSgnW1NldHRlcl0nLCAnc3BlY2lhbCcpOwogICAgfQogIH0KICBpZiAoIWhhc093blByb3BlcnR5KHZpc2libGVLZXlzLCBrZXkpKSB7CiAgICBuYW1lID0gJ1snICsga2V5ICsgJ10nOwogIH0KICBpZiAoIXN0cikgewogICAgaWYgKGN0eC5zZWVuLmluZGV4T2YoZGVzYy52YWx1ZSkgPCAwKSB7CiAgICAgIGlmIChpc051bGwocmVjdXJzZVRpbWVzKSkgewogICAgICAgIHN0ciA9IGZvcm1hdFZhbHVlKGN0eCwgZGVzYy52YWx1ZSwgbnVsbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RyID0gZm9ybWF0VmFsdWUoY3R4LCBkZXNjLnZhbHVlLCByZWN1cnNlVGltZXMgLSAxKTsKICAgICAgfQogICAgICBpZiAoc3RyLmluZGV4T2YoJ1xuJykgPiAtMSkgewogICAgICAgIGlmIChhcnJheSkgewogICAgICAgICAgc3RyID0gc3RyLnNwbGl0KCdcbicpLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgIHJldHVybiAnICAnICsgbGluZTsKICAgICAgICAgIH0pLmpvaW4oJ1xuJykuc3Vic3RyKDIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHIgPSAnXG4nICsgc3RyLnNwbGl0KCdcbicpLm1hcChmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgIHJldHVybiAnICAgJyArIGxpbmU7CiAgICAgICAgICB9KS5qb2luKCdcbicpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgc3RyID0gY3R4LnN0eWxpemUoJ1tDaXJjdWxhcl0nLCAnc3BlY2lhbCcpOwogICAgfQogIH0KICBpZiAoaXNVbmRlZmluZWQobmFtZSkpIHsKICAgIGlmIChhcnJheSAmJiBrZXkubWF0Y2goL15cZCskLykpIHsKICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICAgIG5hbWUgPSBKU09OLnN0cmluZ2lmeSgnJyArIGtleSk7CiAgICBpZiAobmFtZS5tYXRjaCgvXiIoW2EtekEtWl9dW2EtekEtWl8wLTldKikiJC8pKSB7CiAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cigxLCBuYW1lLmxlbmd0aCAtIDIpOwogICAgICBuYW1lID0gY3R4LnN0eWxpemUobmFtZSwgJ25hbWUnKTsKICAgIH0gZWxzZSB7CiAgICAgIG5hbWUgPSBuYW1lLnJlcGxhY2UoLycvZywgIlxcJyIpCiAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcIi9nLCAnIicpCiAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyheInwiJCkvZywgIiciKTsKICAgICAgbmFtZSA9IGN0eC5zdHlsaXplKG5hbWUsICdzdHJpbmcnKTsKICAgIH0KICB9CgogIHJldHVybiBuYW1lICsgJzogJyArIHN0cjsKfQoKCmZ1bmN0aW9uIHJlZHVjZVRvU2luZ2xlU3RyaW5nKG91dHB1dCwgYmFzZSwgYnJhY2VzKSB7CiAgdmFyIG51bUxpbmVzRXN0ID0gMDsKICB2YXIgbGVuZ3RoID0gb3V0cHV0LnJlZHVjZShmdW5jdGlvbihwcmV2LCBjdXIpIHsKICAgIG51bUxpbmVzRXN0Kys7CiAgICBpZiAoY3VyLmluZGV4T2YoJ1xuJykgPj0gMCkgbnVtTGluZXNFc3QrKzsKICAgIHJldHVybiBwcmV2ICsgY3VyLnJlcGxhY2UoL1x1MDAxYlxbXGRcZD9tL2csICcnKS5sZW5ndGggKyAxOwogIH0sIDApOwoKICBpZiAobGVuZ3RoID4gNjApIHsKICAgIHJldHVybiBicmFjZXNbMF0gKwogICAgICAgICAgIChiYXNlID09PSAnJyA/ICcnIDogYmFzZSArICdcbiAnKSArCiAgICAgICAgICAgJyAnICsKICAgICAgICAgICBvdXRwdXQuam9pbignLFxuICAnKSArCiAgICAgICAgICAgJyAnICsKICAgICAgICAgICBicmFjZXNbMV07CiAgfQoKICByZXR1cm4gYnJhY2VzWzBdICsgYmFzZSArICcgJyArIG91dHB1dC5qb2luKCcsICcpICsgJyAnICsgYnJhY2VzWzFdOwp9CgoKLy8gTk9URTogVGhlc2UgdHlwZSBjaGVja2luZyBmdW5jdGlvbnMgaW50ZW50aW9uYWxseSBkb24ndCB1c2UgYGluc3RhbmNlb2ZgCi8vIGJlY2F1c2UgaXQgaXMgZnJhZ2lsZSBhbmQgY2FuIGJlIGVhc2lseSBmYWtlZCB3aXRoIGBPYmplY3QuY3JlYXRlKClgLgpmdW5jdGlvbiBpc0FycmF5KGFyKSB7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXIpOwp9CmV4cG9ydHMuaXNBcnJheSA9IGlzQXJyYXk7CgpmdW5jdGlvbiBpc0Jvb2xlYW4oYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdib29sZWFuJzsKfQpleHBvcnRzLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKCmZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICByZXR1cm4gYXJnID09PSBudWxsOwp9CmV4cG9ydHMuaXNOdWxsID0gaXNOdWxsOwoKZnVuY3Rpb24gaXNOdWxsT3JVbmRlZmluZWQoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PSBudWxsOwp9CmV4cG9ydHMuaXNOdWxsT3JVbmRlZmluZWQgPSBpc051bGxPclVuZGVmaW5lZDsKCmZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKfQpleHBvcnRzLmlzTnVtYmVyID0gaXNOdW1iZXI7CgpmdW5jdGlvbiBpc1N0cmluZyhhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N0cmluZyc7Cn0KZXhwb3J0cy5pc1N0cmluZyA9IGlzU3RyaW5nOwoKZnVuY3Rpb24gaXNTeW1ib2woYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnOwp9CmV4cG9ydHMuaXNTeW1ib2wgPSBpc1N5bWJvbDsKCmZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewogIHJldHVybiBhcmcgPT09IHZvaWQgMDsKfQpleHBvcnRzLmlzVW5kZWZpbmVkID0gaXNVbmRlZmluZWQ7CgpmdW5jdGlvbiBpc1JlZ0V4cChyZSkgewogIHJldHVybiBpc09iamVjdChyZSkgJiYgb2JqZWN0VG9TdHJpbmcocmUpID09PSAnW29iamVjdCBSZWdFeHBdJzsKfQpleHBvcnRzLmlzUmVnRXhwID0gaXNSZWdFeHA7CgpmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwp9CmV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKCmZ1bmN0aW9uIGlzRGF0ZShkKSB7CiAgcmV0dXJuIGlzT2JqZWN0KGQpICYmIG9iamVjdFRvU3RyaW5nKGQpID09PSAnW29iamVjdCBEYXRlXSc7Cn0KZXhwb3J0cy5pc0RhdGUgPSBpc0RhdGU7CgpmdW5jdGlvbiBpc0Vycm9yKGUpIHsKICByZXR1cm4gaXNPYmplY3QoZSkgJiYKICAgICAgKG9iamVjdFRvU3RyaW5nKGUpID09PSAnW29iamVjdCBFcnJvcl0nIHx8IGUgaW5zdGFuY2VvZiBFcnJvcik7Cn0KZXhwb3J0cy5pc0Vycm9yID0gaXNFcnJvcjsKCmZ1bmN0aW9uIGlzRnVuY3Rpb24oYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7Cn0KZXhwb3J0cy5pc0Z1bmN0aW9uID0gaXNGdW5jdGlvbjsKCmZ1bmN0aW9uIGlzUHJpbWl0aXZlKGFyZykgewogIHJldHVybiBhcmcgPT09IG51bGwgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nIHx8CiAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdudW1iZXInIHx8CiAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnIHx8CiAgICAgICAgIHR5cGVvZiBhcmcgPT09ICdzeW1ib2wnIHx8ICAvLyBFUzYgc3ltYm9sCiAgICAgICAgIHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnOwp9CmV4cG9ydHMuaXNQcmltaXRpdmUgPSBpc1ByaW1pdGl2ZTsKCmV4cG9ydHMuaXNCdWZmZXIgPSByZXF1aXJlKCcuL3N1cHBvcnQvaXNCdWZmZXInKTsKCmZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKG8pIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pOwp9CgoKZnVuY3Rpb24gcGFkKG4pIHsKICByZXR1cm4gbiA8IDEwID8gJzAnICsgbi50b1N0cmluZygxMCkgOiBuLnRvU3RyaW5nKDEwKTsKfQoKCnZhciBtb250aHMgPSBbJ0phbicsICdGZWInLCAnTWFyJywgJ0FwcicsICdNYXknLCAnSnVuJywgJ0p1bCcsICdBdWcnLCAnU2VwJywKICAgICAgICAgICAgICAnT2N0JywgJ05vdicsICdEZWMnXTsKCi8vIDI2IEZlYiAxNjoxOTozNApmdW5jdGlvbiB0aW1lc3RhbXAoKSB7CiAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogIHZhciB0aW1lID0gW3BhZChkLmdldEhvdXJzKCkpLAogICAgICAgICAgICAgIHBhZChkLmdldE1pbnV0ZXMoKSksCiAgICAgICAgICAgICAgcGFkKGQuZ2V0U2Vjb25kcygpKV0uam9pbignOicpOwogIHJldHVybiBbZC5nZXREYXRlKCksIG1vbnRoc1tkLmdldE1vbnRoKCldLCB0aW1lXS5qb2luKCcgJyk7Cn0KCgovLyBsb2cgaXMganVzdCBhIHRoaW4gd3JhcHBlciB0byBjb25zb2xlLmxvZyB0aGF0IHByZXBlbmRzIGEgdGltZXN0YW1wCmV4cG9ydHMubG9nID0gZnVuY3Rpb24oKSB7CiAgY29uc29sZS5sb2coJyVzIC0gJXMnLCB0aW1lc3RhbXAoKSwgZXhwb3J0cy5mb3JtYXQuYXBwbHkoZXhwb3J0cywgYXJndW1lbnRzKSk7Cn07CgoKLyoqCiAqIEluaGVyaXQgdGhlIHByb3RvdHlwZSBtZXRob2RzIGZyb20gb25lIGNvbnN0cnVjdG9yIGludG8gYW5vdGhlci4KICoKICogVGhlIEZ1bmN0aW9uLnByb3RvdHlwZS5pbmhlcml0cyBmcm9tIGxhbmcuanMgcmV3cml0dGVuIGFzIGEgc3RhbmRhbG9uZQogKiBmdW5jdGlvbiAobm90IG9uIEZ1bmN0aW9uLnByb3RvdHlwZSkuIE5PVEU6IElmIHRoaXMgZmlsZSBpcyB0byBiZSBsb2FkZWQKICogZHVyaW5nIGJvb3RzdHJhcHBpbmcgdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSByZXdyaXR0ZW4gdXNpbmcgc29tZSBuYXRpdmUKICogZnVuY3Rpb25zIGFzIHByb3RvdHlwZSBzZXR1cCB1c2luZyBub3JtYWwgSmF2YVNjcmlwdCBkb2VzIG5vdCB3b3JrIGFzCiAqIGV4cGVjdGVkIGR1cmluZyBib290c3RyYXBwaW5nIChzZWUgbWlycm9yLmpzIGluIHIxMTQ5MDMpLgogKgogKiBAcGFyYW0ge2Z1bmN0aW9ufSBjdG9yIENvbnN0cnVjdG9yIGZ1bmN0aW9uIHdoaWNoIG5lZWRzIHRvIGluaGVyaXQgdGhlCiAqICAgICBwcm90b3R5cGUuCiAqIEBwYXJhbSB7ZnVuY3Rpb259IHN1cGVyQ3RvciBDb25zdHJ1Y3RvciBmdW5jdGlvbiB0byBpbmhlcml0IHByb3RvdHlwZSBmcm9tLgogKi8KZXhwb3J0cy5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CgpleHBvcnRzLl9leHRlbmQgPSBmdW5jdGlvbihvcmlnaW4sIGFkZCkgewogIC8vIERvbid0IGRvIGFueXRoaW5nIGlmIGFkZCBpc24ndCBhbiBvYmplY3QKICBpZiAoIWFkZCB8fCAhaXNPYmplY3QoYWRkKSkgcmV0dXJuIG9yaWdpbjsKCiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhhZGQpOwogIHZhciBpID0ga2V5cy5sZW5ndGg7CiAgd2hpbGUgKGktLSkgewogICAgb3JpZ2luW2tleXNbaV1dID0gYWRkW2tleXNbaV1dOwogIH0KICByZXR1cm4gb3JpZ2luOwp9OwoKZnVuY3Rpb24gaGFzT3duUHJvcGVydHkob2JqLCBwcm9wKSB7CiAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApOwp9Cgp9KS5jYWxsKHRoaXMpfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJyksdHlwZW9mIF9fd2VicGFja19yZXF1aXJlX18uZyAhPT0gInVuZGVmaW5lZCIgPyBfX3dlYnBhY2tfcmVxdWlyZV9fLmcgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKfSx7Ii4vc3VwcG9ydC9pc0J1ZmZlciI6ODIsIl9wcm9jZXNzIjo4OSwiaW5oZXJpdHMiOjgxfV0sODQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKGdsb2JhbCxCdWZmZXIpeyhmdW5jdGlvbiAoKXsKLyohCiAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogKgogKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8aHR0cDovL2Zlcm9zcy5vcmc+CiAqIEBsaWNlbnNlICBNSVQKICovCi8qIGVzbGludC1kaXNhYmxlIG5vLXByb3RvICovCgondXNlIHN0cmljdCcKCnZhciBiYXNlNjQgPSByZXF1aXJlKCdiYXNlNjQtanMnKQp2YXIgaWVlZTc1NCA9IHJlcXVpcmUoJ2llZWU3NTQnKQp2YXIgaXNBcnJheSA9IHJlcXVpcmUoJ2lzYXJyYXknKQoKZXhwb3J0cy5CdWZmZXIgPSBCdWZmZXIKZXhwb3J0cy5TbG93QnVmZmVyID0gU2xvd0J1ZmZlcgpleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTID0gNTAKCi8qKgogKiBJZiBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgOgogKiAgID09PSB0cnVlICAgIFVzZSBVaW50OEFycmF5IGltcGxlbWVudGF0aW9uIChmYXN0ZXN0KQogKiAgID09PSBmYWxzZSAgIFVzZSBPYmplY3QgaW1wbGVtZW50YXRpb24gKG1vc3QgY29tcGF0aWJsZSwgZXZlbiBJRTYpCiAqCiAqIEJyb3dzZXJzIHRoYXQgc3VwcG9ydCB0eXBlZCBhcnJheXMgYXJlIElFIDEwKywgRmlyZWZveCA0KywgQ2hyb21lIDcrLCBTYWZhcmkgNS4xKywKICogT3BlcmEgMTEuNissIGlPUyA0LjIrLgogKgogKiBEdWUgdG8gdmFyaW91cyBicm93c2VyIGJ1Z3MsIHNvbWV0aW1lcyB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uIHdpbGwgYmUgdXNlZCBldmVuCiAqIHdoZW4gdGhlIGJyb3dzZXIgc3VwcG9ydHMgdHlwZWQgYXJyYXlzLgogKgogKiBOb3RlOgogKgogKiAgIC0gRmlyZWZveCA0LTI5IGxhY2tzIHN1cHBvcnQgZm9yIGFkZGluZyBuZXcgcHJvcGVydGllcyB0byBgVWludDhBcnJheWAgaW5zdGFuY2VzLAogKiAgICAgU2VlOiBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD02OTU0MzguCiAqCiAqICAgLSBDaHJvbWUgOS0xMCBpcyBtaXNzaW5nIHRoZSBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uLgogKgogKiAgIC0gSUUxMCBoYXMgYSBicm9rZW4gYFR5cGVkQXJyYXkucHJvdG90eXBlLnN1YmFycmF5YCBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFycmF5cyBvZgogKiAgICAgaW5jb3JyZWN0IGxlbmd0aCBpbiBzb21lIHNpdHVhdGlvbnMuCgogKiBXZSBkZXRlY3QgdGhlc2UgYnVnZ3kgYnJvd3NlcnMgYW5kIHNldCBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgIHRvIGBmYWxzZWAgc28gdGhleQogKiBnZXQgdGhlIE9iamVjdCBpbXBsZW1lbnRhdGlvbiwgd2hpY2ggaXMgc2xvd2VyIGJ1dCBiZWhhdmVzIGNvcnJlY3RseS4KICovCkJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUID0gZ2xvYmFsLlRZUEVEX0FSUkFZX1NVUFBPUlQgIT09IHVuZGVmaW5lZAogID8gZ2xvYmFsLlRZUEVEX0FSUkFZX1NVUFBPUlQKICA6IHR5cGVkQXJyYXlTdXBwb3J0KCkKCi8qCiAqIEV4cG9ydCBrTWF4TGVuZ3RoIGFmdGVyIHR5cGVkIGFycmF5IHN1cHBvcnQgaXMgZGV0ZXJtaW5lZC4KICovCmV4cG9ydHMua01heExlbmd0aCA9IGtNYXhMZW5ndGgoKQoKZnVuY3Rpb24gdHlwZWRBcnJheVN1cHBvcnQgKCkgewogIHRyeSB7CiAgICB2YXIgYXJyID0gbmV3IFVpbnQ4QXJyYXkoMSkKICAgIGFyci5fX3Byb3RvX18gPSB7X19wcm90b19fOiBVaW50OEFycmF5LnByb3RvdHlwZSwgZm9vOiBmdW5jdGlvbiAoKSB7IHJldHVybiA0MiB9fQogICAgcmV0dXJuIGFyci5mb28oKSA9PT0gNDIgJiYgLy8gdHlwZWQgYXJyYXkgaW5zdGFuY2VzIGNhbiBiZSBhdWdtZW50ZWQKICAgICAgICB0eXBlb2YgYXJyLnN1YmFycmF5ID09PSAnZnVuY3Rpb24nICYmIC8vIGNocm9tZSA5LTEwIGxhY2sgYHN1YmFycmF5YAogICAgICAgIGFyci5zdWJhcnJheSgxLCAxKS5ieXRlTGVuZ3RoID09PSAwIC8vIGllMTAgaGFzIGJyb2tlbiBgc3ViYXJyYXlgCiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpmdW5jdGlvbiBrTWF4TGVuZ3RoICgpIHsKICByZXR1cm4gQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQKICAgID8gMHg3ZmZmZmZmZgogICAgOiAweDNmZmZmZmZmCn0KCmZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlciAodGhhdCwgbGVuZ3RoKSB7CiAgaWYgKGtNYXhMZW5ndGgoKSA8IGxlbmd0aCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0ludmFsaWQgdHlwZWQgYXJyYXkgbGVuZ3RoJykKICB9CiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICAvLyBSZXR1cm4gYW4gYXVnbWVudGVkIGBVaW50OEFycmF5YCBpbnN0YW5jZSwgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgIHRoYXQgPSBuZXcgVWludDhBcnJheShsZW5ndGgpCiAgICB0aGF0Ll9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICB9IGVsc2UgewogICAgLy8gRmFsbGJhY2s6IFJldHVybiBhbiBvYmplY3QgaW5zdGFuY2Ugb2YgdGhlIEJ1ZmZlciBjbGFzcwogICAgaWYgKHRoYXQgPT09IG51bGwpIHsKICAgICAgdGhhdCA9IG5ldyBCdWZmZXIobGVuZ3RoKQogICAgfQogICAgdGhhdC5sZW5ndGggPSBsZW5ndGgKICB9CgogIHJldHVybiB0aGF0Cn0KCi8qKgogKiBUaGUgQnVmZmVyIGNvbnN0cnVjdG9yIHJldHVybnMgaW5zdGFuY2VzIG9mIGBVaW50OEFycmF5YCB0aGF0IGhhdmUgdGhlaXIKICogcHJvdG90eXBlIGNoYW5nZWQgdG8gYEJ1ZmZlci5wcm90b3R5cGVgLiBGdXJ0aGVybW9yZSwgYEJ1ZmZlcmAgaXMgYSBzdWJjbGFzcyBvZgogKiBgVWludDhBcnJheWAsIHNvIHRoZSByZXR1cm5lZCBpbnN0YW5jZXMgd2lsbCBoYXZlIGFsbCB0aGUgbm9kZSBgQnVmZmVyYCBtZXRob2RzCiAqIGFuZCB0aGUgYFVpbnQ4QXJyYXlgIG1ldGhvZHMuIFNxdWFyZSBicmFja2V0IG5vdGF0aW9uIHdvcmtzIGFzIGV4cGVjdGVkIC0tIGl0CiAqIHJldHVybnMgYSBzaW5nbGUgb2N0ZXQuCiAqCiAqIFRoZSBgVWludDhBcnJheWAgcHJvdG90eXBlIHJlbWFpbnMgdW5tb2RpZmllZC4KICovCgpmdW5jdGlvbiBCdWZmZXIgKGFyZywgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJiAhKHRoaXMgaW5zdGFuY2VvZiBCdWZmZXIpKSB7CiAgICByZXR1cm4gbmV3IEJ1ZmZlcihhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKICB9CgogIC8vIENvbW1vbiBjYXNlLgogIGlmICh0eXBlb2YgYXJnID09PSAnbnVtYmVyJykgewogICAgaWYgKHR5cGVvZiBlbmNvZGluZ09yT2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgJ0lmIGVuY29kaW5nIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBmaXJzdCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nJwogICAgICApCiAgICB9CiAgICByZXR1cm4gYWxsb2NVbnNhZmUodGhpcywgYXJnKQogIH0KICByZXR1cm4gZnJvbSh0aGlzLCBhcmcsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKfQoKQnVmZmVyLnBvb2xTaXplID0gODE5MiAvLyBub3QgdXNlZCBieSB0aGlzIGltcGxlbWVudGF0aW9uCgovLyBUT0RPOiBMZWdhY3ksIG5vdCBuZWVkZWQgYW55bW9yZS4gUmVtb3ZlIGluIG5leHQgbWFqb3IgdmVyc2lvbi4KQnVmZmVyLl9hdWdtZW50ID0gZnVuY3Rpb24gKGFycikgewogIGFyci5fX3Byb3RvX18gPSBCdWZmZXIucHJvdG90eXBlCiAgcmV0dXJuIGFycgp9CgpmdW5jdGlvbiBmcm9tICh0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJ2YWx1ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgYSBudW1iZXInKQogIH0KCiAgaWYgKHR5cGVvZiBBcnJheUJ1ZmZlciAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgcmV0dXJuIGZyb21BcnJheUJ1ZmZlcih0aGF0LCB2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKQogIH0KCiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBmcm9tU3RyaW5nKHRoYXQsIHZhbHVlLCBlbmNvZGluZ09yT2Zmc2V0KQogIH0KCiAgcmV0dXJuIGZyb21PYmplY3QodGhhdCwgdmFsdWUpCn0KCi8qKgogKiBGdW5jdGlvbmFsbHkgZXF1aXZhbGVudCB0byBCdWZmZXIoYXJnLCBlbmNvZGluZykgYnV0IHRocm93cyBhIFR5cGVFcnJvcgogKiBpZiB2YWx1ZSBpcyBhIG51bWJlci4KICogQnVmZmVyLmZyb20oc3RyWywgZW5jb2RpbmddKQogKiBCdWZmZXIuZnJvbShhcnJheSkKICogQnVmZmVyLmZyb20oYnVmZmVyKQogKiBCdWZmZXIuZnJvbShhcnJheUJ1ZmZlclssIGJ5dGVPZmZzZXRbLCBsZW5ndGhdXSkKICoqLwpCdWZmZXIuZnJvbSA9IGZ1bmN0aW9uICh2YWx1ZSwgZW5jb2RpbmdPck9mZnNldCwgbGVuZ3RoKSB7CiAgcmV0dXJuIGZyb20obnVsbCwgdmFsdWUsIGVuY29kaW5nT3JPZmZzZXQsIGxlbmd0aCkKfQoKaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgQnVmZmVyLnByb3RvdHlwZS5fX3Byb3RvX18gPSBVaW50OEFycmF5LnByb3RvdHlwZQogIEJ1ZmZlci5fX3Byb3RvX18gPSBVaW50OEFycmF5CiAgaWYgKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC5zcGVjaWVzICYmCiAgICAgIEJ1ZmZlcltTeW1ib2wuc3BlY2llc10gPT09IEJ1ZmZlcikgewogICAgLy8gRml4IHN1YmFycmF5KCkgaW4gRVMyMDE2LiBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9mZXJvc3MvYnVmZmVyL3B1bGwvOTcKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShCdWZmZXIsIFN5bWJvbC5zcGVjaWVzLCB7CiAgICAgIHZhbHVlOiBudWxsLAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pCiAgfQp9CgpmdW5jdGlvbiBhc3NlcnRTaXplIChzaXplKSB7CiAgaWYgKHR5cGVvZiBzaXplICE9PSAnbnVtYmVyJykgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3QgYmUgYSBudW1iZXInKQogIH0gZWxzZSBpZiAoc2l6ZSA8IDApIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBub3QgYmUgbmVnYXRpdmUnKQogIH0KfQoKZnVuY3Rpb24gYWxsb2MgKHRoYXQsIHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgYXNzZXJ0U2l6ZShzaXplKQogIGlmIChzaXplIDw9IDApIHsKICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgc2l6ZSkKICB9CiAgaWYgKGZpbGwgIT09IHVuZGVmaW5lZCkgewogICAgLy8gT25seSBwYXkgYXR0ZW50aW9uIHRvIGVuY29kaW5nIGlmIGl0J3MgYSBzdHJpbmcuIFRoaXMKICAgIC8vIHByZXZlbnRzIGFjY2lkZW50YWxseSBzZW5kaW5nIGluIGEgbnVtYmVyIHRoYXQgd291bGQKICAgIC8vIGJlIGludGVycHJldHRlZCBhcyBhIHN0YXJ0IG9mZnNldC4KICAgIHJldHVybiB0eXBlb2YgZW5jb2RpbmcgPT09ICdzdHJpbmcnCiAgICAgID8gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpLmZpbGwoZmlsbCwgZW5jb2RpbmcpCiAgICAgIDogY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUpLmZpbGwoZmlsbCkKICB9CiAgcmV0dXJuIGNyZWF0ZUJ1ZmZlcih0aGF0LCBzaXplKQp9CgovKioKICogQ3JlYXRlcyBhIG5ldyBmaWxsZWQgQnVmZmVyIGluc3RhbmNlLgogKiBhbGxvYyhzaXplWywgZmlsbFssIGVuY29kaW5nXV0pCiAqKi8KQnVmZmVyLmFsbG9jID0gZnVuY3Rpb24gKHNpemUsIGZpbGwsIGVuY29kaW5nKSB7CiAgcmV0dXJuIGFsbG9jKG51bGwsIHNpemUsIGZpbGwsIGVuY29kaW5nKQp9CgpmdW5jdGlvbiBhbGxvY1Vuc2FmZSAodGhhdCwgc2l6ZSkgewogIGFzc2VydFNpemUoc2l6ZSkKICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIHNpemUgPCAwID8gMCA6IGNoZWNrZWQoc2l6ZSkgfCAwKQogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgKytpKSB7CiAgICAgIHRoYXRbaV0gPSAwCiAgICB9CiAgfQogIHJldHVybiB0aGF0Cn0KCi8qKgogKiBFcXVpdmFsZW50IHRvIEJ1ZmZlcihudW0pLCBieSBkZWZhdWx0IGNyZWF0ZXMgYSBub24temVyby1maWxsZWQgQnVmZmVyIGluc3RhbmNlLgogKiAqLwpCdWZmZXIuYWxsb2NVbnNhZmUgPSBmdW5jdGlvbiAoc2l6ZSkgewogIHJldHVybiBhbGxvY1Vuc2FmZShudWxsLCBzaXplKQp9Ci8qKgogKiBFcXVpdmFsZW50IHRvIFNsb3dCdWZmZXIobnVtKSwgYnkgZGVmYXVsdCBjcmVhdGVzIGEgbm9uLXplcm8tZmlsbGVkIEJ1ZmZlciBpbnN0YW5jZS4KICovCkJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cgPSBmdW5jdGlvbiAoc2l6ZSkgewogIHJldHVybiBhbGxvY1Vuc2FmZShudWxsLCBzaXplKQp9CgpmdW5jdGlvbiBmcm9tU3RyaW5nICh0aGF0LCBzdHJpbmcsIGVuY29kaW5nKSB7CiAgaWYgKHR5cGVvZiBlbmNvZGluZyAhPT0gJ3N0cmluZycgfHwgZW5jb2RpbmcgPT09ICcnKSB7CiAgICBlbmNvZGluZyA9ICd1dGY4JwogIH0KCiAgaWYgKCFCdWZmZXIuaXNFbmNvZGluZyhlbmNvZGluZykpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJlbmNvZGluZyIgbXVzdCBiZSBhIHZhbGlkIHN0cmluZyBlbmNvZGluZycpCiAgfQoKICB2YXIgbGVuZ3RoID0gYnl0ZUxlbmd0aChzdHJpbmcsIGVuY29kaW5nKSB8IDAKICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbmd0aCkKCiAgdmFyIGFjdHVhbCA9IHRoYXQud3JpdGUoc3RyaW5nLCBlbmNvZGluZykKCiAgaWYgKGFjdHVhbCAhPT0gbGVuZ3RoKSB7CiAgICAvLyBXcml0aW5nIGEgaGV4IHN0cmluZywgZm9yIGV4YW1wbGUsIHRoYXQgY29udGFpbnMgaW52YWxpZCBjaGFyYWN0ZXJzIHdpbGwKICAgIC8vIGNhdXNlIGV2ZXJ5dGhpbmcgYWZ0ZXIgdGhlIGZpcnN0IGludmFsaWQgY2hhcmFjdGVyIHRvIGJlIGlnbm9yZWQuIChlLmcuCiAgICAvLyAnYWJ4eGNkJyB3aWxsIGJlIHRyZWF0ZWQgYXMgJ2FiJykKICAgIHRoYXQgPSB0aGF0LnNsaWNlKDAsIGFjdHVhbCkKICB9CgogIHJldHVybiB0aGF0Cn0KCmZ1bmN0aW9uIGZyb21BcnJheUxpa2UgKHRoYXQsIGFycmF5KSB7CiAgdmFyIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCA8IDAgPyAwIDogY2hlY2tlZChhcnJheS5sZW5ndGgpIHwgMAogIHRoYXQgPSBjcmVhdGVCdWZmZXIodGhhdCwgbGVuZ3RoKQogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgIHRoYXRbaV0gPSBhcnJheVtpXSAmIDI1NQogIH0KICByZXR1cm4gdGhhdAp9CgpmdW5jdGlvbiBmcm9tQXJyYXlCdWZmZXIgKHRoYXQsIGFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpIHsKICBhcnJheS5ieXRlTGVuZ3RoIC8vIHRoaXMgdGhyb3dzIGlmIGBhcnJheWAgaXMgbm90IGEgdmFsaWQgQXJyYXlCdWZmZXIKCiAgaWYgKGJ5dGVPZmZzZXQgPCAwIHx8IGFycmF5LmJ5dGVMZW5ndGggPCBieXRlT2Zmc2V0KSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignXCdvZmZzZXRcJyBpcyBvdXQgb2YgYm91bmRzJykKICB9CgogIGlmIChhcnJheS5ieXRlTGVuZ3RoIDwgYnl0ZU9mZnNldCArIChsZW5ndGggfHwgMCkpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdcJ2xlbmd0aFwnIGlzIG91dCBvZiBib3VuZHMnKQogIH0KCiAgaWYgKGJ5dGVPZmZzZXQgPT09IHVuZGVmaW5lZCAmJiBsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgYXJyYXkgPSBuZXcgVWludDhBcnJheShhcnJheSkKICB9IGVsc2UgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5LCBieXRlT2Zmc2V0KQogIH0gZWxzZSB7CiAgICBhcnJheSA9IG5ldyBVaW50OEFycmF5KGFycmF5LCBieXRlT2Zmc2V0LCBsZW5ndGgpCiAgfQoKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIC8vIFJldHVybiBhbiBhdWdtZW50ZWQgYFVpbnQ4QXJyYXlgIGluc3RhbmNlLCBmb3IgYmVzdCBwZXJmb3JtYW5jZQogICAgdGhhdCA9IGFycmF5CiAgICB0aGF0Ll9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICB9IGVsc2UgewogICAgLy8gRmFsbGJhY2s6IFJldHVybiBhbiBvYmplY3QgaW5zdGFuY2Ugb2YgdGhlIEJ1ZmZlciBjbGFzcwogICAgdGhhdCA9IGZyb21BcnJheUxpa2UodGhhdCwgYXJyYXkpCiAgfQogIHJldHVybiB0aGF0Cn0KCmZ1bmN0aW9uIGZyb21PYmplY3QgKHRoYXQsIG9iaikgewogIGlmIChCdWZmZXIuaXNCdWZmZXIob2JqKSkgewogICAgdmFyIGxlbiA9IGNoZWNrZWQob2JqLmxlbmd0aCkgfCAwCiAgICB0aGF0ID0gY3JlYXRlQnVmZmVyKHRoYXQsIGxlbikKCiAgICBpZiAodGhhdC5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHRoYXQKICAgIH0KCiAgICBvYmouY29weSh0aGF0LCAwLCAwLCBsZW4pCiAgICByZXR1cm4gdGhhdAogIH0KCiAgaWYgKG9iaikgewogICAgaWYgKCh0eXBlb2YgQXJyYXlCdWZmZXIgIT09ICd1bmRlZmluZWQnICYmCiAgICAgICAgb2JqLmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSB8fCAnbGVuZ3RoJyBpbiBvYmopIHsKICAgICAgaWYgKHR5cGVvZiBvYmoubGVuZ3RoICE9PSAnbnVtYmVyJyB8fCBpc25hbihvYmoubGVuZ3RoKSkgewogICAgICAgIHJldHVybiBjcmVhdGVCdWZmZXIodGhhdCwgMCkKICAgICAgfQogICAgICByZXR1cm4gZnJvbUFycmF5TGlrZSh0aGF0LCBvYmopCiAgICB9CgogICAgaWYgKG9iai50eXBlID09PSAnQnVmZmVyJyAmJiBpc0FycmF5KG9iai5kYXRhKSkgewogICAgICByZXR1cm4gZnJvbUFycmF5TGlrZSh0aGF0LCBvYmouZGF0YSkKICAgIH0KICB9CgogIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCBvciBhcnJheS1saWtlIG9iamVjdC4nKQp9CgpmdW5jdGlvbiBjaGVja2VkIChsZW5ndGgpIHsKICAvLyBOb3RlOiBjYW5ub3QgdXNlIGBsZW5ndGggPCBrTWF4TGVuZ3RoKClgIGhlcmUgYmVjYXVzZSB0aGF0IGZhaWxzIHdoZW4KICAvLyBsZW5ndGggaXMgTmFOICh3aGljaCBpcyBvdGhlcndpc2UgY29lcmNlZCB0byB6ZXJvLikKICBpZiAobGVuZ3RoID49IGtNYXhMZW5ndGgoKSkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0F0dGVtcHQgdG8gYWxsb2NhdGUgQnVmZmVyIGxhcmdlciB0aGFuIG1heGltdW0gJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAnc2l6ZTogMHgnICsga01heExlbmd0aCgpLnRvU3RyaW5nKDE2KSArICcgYnl0ZXMnKQogIH0KICByZXR1cm4gbGVuZ3RoIHwgMAp9CgpmdW5jdGlvbiBTbG93QnVmZmVyIChsZW5ndGgpIHsKICBpZiAoK2xlbmd0aCAhPSBsZW5ndGgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBlcWVxZXEKICAgIGxlbmd0aCA9IDAKICB9CiAgcmV0dXJuIEJ1ZmZlci5hbGxvYygrbGVuZ3RoKQp9CgpCdWZmZXIuaXNCdWZmZXIgPSBmdW5jdGlvbiBpc0J1ZmZlciAoYikgewogIHJldHVybiAhIShiICE9IG51bGwgJiYgYi5faXNCdWZmZXIpCn0KCkJ1ZmZlci5jb21wYXJlID0gZnVuY3Rpb24gY29tcGFyZSAoYSwgYikgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKGEpIHx8ICFCdWZmZXIuaXNCdWZmZXIoYikpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50cyBtdXN0IGJlIEJ1ZmZlcnMnKQogIH0KCiAgaWYgKGEgPT09IGIpIHJldHVybiAwCgogIHZhciB4ID0gYS5sZW5ndGgKICB2YXIgeSA9IGIubGVuZ3RoCgogIGZvciAodmFyIGkgPSAwLCBsZW4gPSBNYXRoLm1pbih4LCB5KTsgaSA8IGxlbjsgKytpKSB7CiAgICBpZiAoYVtpXSAhPT0gYltpXSkgewogICAgICB4ID0gYVtpXQogICAgICB5ID0gYltpXQogICAgICBicmVhawogICAgfQogIH0KCiAgaWYgKHggPCB5KSByZXR1cm4gLTEKICBpZiAoeSA8IHgpIHJldHVybiAxCiAgcmV0dXJuIDAKfQoKQnVmZmVyLmlzRW5jb2RpbmcgPSBmdW5jdGlvbiBpc0VuY29kaW5nIChlbmNvZGluZykgewogIHN3aXRjaCAoU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpKSB7CiAgICBjYXNlICdoZXgnOgogICAgY2FzZSAndXRmOCc6CiAgICBjYXNlICd1dGYtOCc6CiAgICBjYXNlICdhc2NpaSc6CiAgICBjYXNlICdsYXRpbjEnOgogICAgY2FzZSAnYmluYXJ5JzoKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICBjYXNlICd1Y3MyJzoKICAgIGNhc2UgJ3Vjcy0yJzoKICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgY2FzZSAndXRmLTE2bGUnOgogICAgICByZXR1cm4gdHJ1ZQogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIGZhbHNlCiAgfQp9CgpCdWZmZXIuY29uY2F0ID0gZnVuY3Rpb24gY29uY2F0IChsaXN0LCBsZW5ndGgpIHsKICBpZiAoIWlzQXJyYXkobGlzdCkpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKQogIH0KCiAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gQnVmZmVyLmFsbG9jKDApCiAgfQoKICB2YXIgaQogIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCkgewogICAgbGVuZ3RoID0gMAogICAgZm9yIChpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyArK2kpIHsKICAgICAgbGVuZ3RoICs9IGxpc3RbaV0ubGVuZ3RoCiAgICB9CiAgfQoKICB2YXIgYnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKGxlbmd0aCkKICB2YXIgcG9zID0gMAogIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgKytpKSB7CiAgICB2YXIgYnVmID0gbGlzdFtpXQogICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCcibGlzdCIgYXJndW1lbnQgbXVzdCBiZSBhbiBBcnJheSBvZiBCdWZmZXJzJykKICAgIH0KICAgIGJ1Zi5jb3B5KGJ1ZmZlciwgcG9zKQogICAgcG9zICs9IGJ1Zi5sZW5ndGgKICB9CiAgcmV0dXJuIGJ1ZmZlcgp9CgpmdW5jdGlvbiBieXRlTGVuZ3RoIChzdHJpbmcsIGVuY29kaW5nKSB7CiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihzdHJpbmcpKSB7CiAgICByZXR1cm4gc3RyaW5nLmxlbmd0aAogIH0KICBpZiAodHlwZW9mIEFycmF5QnVmZmVyICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3ID09PSAnZnVuY3Rpb24nICYmCiAgICAgIChBcnJheUJ1ZmZlci5pc1ZpZXcoc3RyaW5nKSB8fCBzdHJpbmcgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikpIHsKICAgIHJldHVybiBzdHJpbmcuYnl0ZUxlbmd0aAogIH0KICBpZiAodHlwZW9mIHN0cmluZyAhPT0gJ3N0cmluZycpIHsKICAgIHN0cmluZyA9ICcnICsgc3RyaW5nCiAgfQoKICB2YXIgbGVuID0gc3RyaW5nLmxlbmd0aAogIGlmIChsZW4gPT09IDApIHJldHVybiAwCgogIC8vIFVzZSBhIGZvciBsb29wIHRvIGF2b2lkIHJlY3Vyc2lvbgogIHZhciBsb3dlcmVkQ2FzZSA9IGZhbHNlCiAgZm9yICg7OykgewogICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICBjYXNlICdhc2NpaSc6CiAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgcmV0dXJuIGxlbgogICAgICBjYXNlICd1dGY4JzoKICAgICAgY2FzZSAndXRmLTgnOgogICAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgICByZXR1cm4gdXRmOFRvQnl0ZXMoc3RyaW5nKS5sZW5ndGgKICAgICAgY2FzZSAndWNzMic6CiAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICByZXR1cm4gbGVuICogMgogICAgICBjYXNlICdoZXgnOgogICAgICAgIHJldHVybiBsZW4gPj4+IDEKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICByZXR1cm4gYmFzZTY0VG9CeXRlcyhzdHJpbmcpLmxlbmd0aAogICAgICBkZWZhdWx0OgogICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgcmV0dXJuIHV0ZjhUb0J5dGVzKHN0cmluZykubGVuZ3RoIC8vIGFzc3VtZSB1dGY4CiAgICAgICAgZW5jb2RpbmcgPSAoJycgKyBlbmNvZGluZykudG9Mb3dlckNhc2UoKQogICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgfQogIH0KfQpCdWZmZXIuYnl0ZUxlbmd0aCA9IGJ5dGVMZW5ndGgKCmZ1bmN0aW9uIHNsb3dUb1N0cmluZyAoZW5jb2RpbmcsIHN0YXJ0LCBlbmQpIHsKICB2YXIgbG93ZXJlZENhc2UgPSBmYWxzZQoKICAvLyBObyBuZWVkIHRvIHZlcmlmeSB0aGF0ICJ0aGlzLmxlbmd0aCA8PSBNQVhfVUlOVDMyIiBzaW5jZSBpdCdzIGEgcmVhZC1vbmx5CiAgLy8gcHJvcGVydHkgb2YgYSB0eXBlZCBhcnJheS4KCiAgLy8gVGhpcyBiZWhhdmVzIG5laXRoZXIgbGlrZSBTdHJpbmcgbm9yIFVpbnQ4QXJyYXkgaW4gdGhhdCB3ZSBzZXQgc3RhcnQvZW5kCiAgLy8gdG8gdGhlaXIgdXBwZXIvbG93ZXIgYm91bmRzIGlmIHRoZSB2YWx1ZSBwYXNzZWQgaXMgb3V0IG9mIHJhbmdlLgogIC8vIHVuZGVmaW5lZCBpcyBoYW5kbGVkIHNwZWNpYWxseSBhcyBwZXIgRUNNQS0yNjIgNnRoIEVkaXRpb24sCiAgLy8gU2VjdGlvbiAxMy4zLjMuNyBSdW50aW1lIFNlbWFudGljczogS2V5ZWRCaW5kaW5nSW5pdGlhbGl6YXRpb24uCiAgaWYgKHN0YXJ0ID09PSB1bmRlZmluZWQgfHwgc3RhcnQgPCAwKSB7CiAgICBzdGFydCA9IDAKICB9CiAgLy8gUmV0dXJuIGVhcmx5IGlmIHN0YXJ0ID4gdGhpcy5sZW5ndGguIERvbmUgaGVyZSB0byBwcmV2ZW50IHBvdGVudGlhbCB1aW50MzIKICAvLyBjb2VyY2lvbiBmYWlsIGJlbG93LgogIGlmIChzdGFydCA+IHRoaXMubGVuZ3RoKSB7CiAgICByZXR1cm4gJycKICB9CgogIGlmIChlbmQgPT09IHVuZGVmaW5lZCB8fCBlbmQgPiB0aGlzLmxlbmd0aCkgewogICAgZW5kID0gdGhpcy5sZW5ndGgKICB9CgogIGlmIChlbmQgPD0gMCkgewogICAgcmV0dXJuICcnCiAgfQoKICAvLyBGb3JjZSBjb2Vyc2lvbiB0byB1aW50MzIuIFRoaXMgd2lsbCBhbHNvIGNvZXJjZSBmYWxzZXkvTmFOIHZhbHVlcyB0byAwLgogIGVuZCA+Pj49IDAKICBzdGFydCA+Pj49IDAKCiAgaWYgKGVuZCA8PSBzdGFydCkgewogICAgcmV0dXJuICcnCiAgfQoKICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwoKICB3aGlsZSAodHJ1ZSkgewogICAgc3dpdGNoIChlbmNvZGluZykgewogICAgICBjYXNlICdoZXgnOgogICAgICAgIHJldHVybiBoZXhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAndXRmOCc6CiAgICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgICByZXR1cm4gdXRmOFNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBjYXNlICdhc2NpaSc6CiAgICAgICAgcmV0dXJuIGFzY2lpU2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ2xhdGluMSc6CiAgICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgICAgcmV0dXJuIGxhdGluMVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBjYXNlICdiYXNlNjQnOgogICAgICAgIHJldHVybiBiYXNlNjRTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAndWNzMic6CiAgICAgIGNhc2UgJ3Vjcy0yJzoKICAgICAgY2FzZSAndXRmMTZsZSc6CiAgICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgICByZXR1cm4gdXRmMTZsZVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBkZWZhdWx0OgogICAgICAgIGlmIChsb3dlcmVkQ2FzZSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKQogICAgICAgIGVuY29kaW5nID0gKGVuY29kaW5nICsgJycpLnRvTG93ZXJDYXNlKCkKICAgICAgICBsb3dlcmVkQ2FzZSA9IHRydWUKICAgIH0KICB9Cn0KCi8vIFRoZSBwcm9wZXJ0eSBpcyB1c2VkIGJ5IGBCdWZmZXIuaXNCdWZmZXJgIGFuZCBgaXMtYnVmZmVyYCAoaW4gU2FmYXJpIDUtNykgdG8gZGV0ZWN0Ci8vIEJ1ZmZlciBpbnN0YW5jZXMuCkJ1ZmZlci5wcm90b3R5cGUuX2lzQnVmZmVyID0gdHJ1ZQoKZnVuY3Rpb24gc3dhcCAoYiwgbiwgbSkgewogIHZhciBpID0gYltuXQogIGJbbl0gPSBiW21dCiAgYlttXSA9IGkKfQoKQnVmZmVyLnByb3RvdHlwZS5zd2FwMTYgPSBmdW5jdGlvbiBzd2FwMTYgKCkgewogIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogIGlmIChsZW4gJSAyICE9PSAwKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMnKQogIH0KICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSAyKSB7CiAgICBzd2FwKHRoaXMsIGksIGkgKyAxKQogIH0KICByZXR1cm4gdGhpcwp9CgpCdWZmZXIucHJvdG90eXBlLnN3YXAzMiA9IGZ1bmN0aW9uIHN3YXAzMiAoKSB7CiAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoCiAgaWYgKGxlbiAlIDQgIT09IDApIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdCdWZmZXIgc2l6ZSBtdXN0IGJlIGEgbXVsdGlwbGUgb2YgMzItYml0cycpCiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpICs9IDQpIHsKICAgIHN3YXAodGhpcywgaSwgaSArIDMpCiAgICBzd2FwKHRoaXMsIGkgKyAxLCBpICsgMikKICB9CiAgcmV0dXJuIHRoaXMKfQoKQnVmZmVyLnByb3RvdHlwZS5zd2FwNjQgPSBmdW5jdGlvbiBzd2FwNjQgKCkgewogIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogIGlmIChsZW4gJSA4ICE9PSAwKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDY0LWJpdHMnKQogIH0KICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSArPSA4KSB7CiAgICBzd2FwKHRoaXMsIGksIGkgKyA3KQogICAgc3dhcCh0aGlzLCBpICsgMSwgaSArIDYpCiAgICBzd2FwKHRoaXMsIGkgKyAyLCBpICsgNSkKICAgIHN3YXAodGhpcywgaSArIDMsIGkgKyA0KQogIH0KICByZXR1cm4gdGhpcwp9CgpCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gdG9TdHJpbmcgKCkgewogIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCB8IDAKICBpZiAobGVuZ3RoID09PSAwKSByZXR1cm4gJycKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCAwLCBsZW5ndGgpCiAgcmV0dXJuIHNsb3dUb1N0cmluZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpCn0KCkJ1ZmZlci5wcm90b3R5cGUuZXF1YWxzID0gZnVuY3Rpb24gZXF1YWxzIChiKSB7CiAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogIGlmICh0aGlzID09PSBiKSByZXR1cm4gdHJ1ZQogIHJldHVybiBCdWZmZXIuY29tcGFyZSh0aGlzLCBiKSA9PT0gMAp9CgpCdWZmZXIucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbiBpbnNwZWN0ICgpIHsKICB2YXIgc3RyID0gJycKICB2YXIgbWF4ID0gZXhwb3J0cy5JTlNQRUNUX01BWF9CWVRFUwogIGlmICh0aGlzLmxlbmd0aCA+IDApIHsKICAgIHN0ciA9IHRoaXMudG9TdHJpbmcoJ2hleCcsIDAsIG1heCkubWF0Y2goLy57Mn0vZykuam9pbignICcpCiAgICBpZiAodGhpcy5sZW5ndGggPiBtYXgpIHN0ciArPSAnIC4uLiAnCiAgfQogIHJldHVybiAnPEJ1ZmZlciAnICsgc3RyICsgJz4nCn0KCkJ1ZmZlci5wcm90b3R5cGUuY29tcGFyZSA9IGZ1bmN0aW9uIGNvbXBhcmUgKHRhcmdldCwgc3RhcnQsIGVuZCwgdGhpc1N0YXJ0LCB0aGlzRW5kKSB7CiAgaWYgKCFCdWZmZXIuaXNCdWZmZXIodGFyZ2V0KSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlcicpCiAgfQoKICBpZiAoc3RhcnQgPT09IHVuZGVmaW5lZCkgewogICAgc3RhcnQgPSAwCiAgfQogIGlmIChlbmQgPT09IHVuZGVmaW5lZCkgewogICAgZW5kID0gdGFyZ2V0ID8gdGFyZ2V0Lmxlbmd0aCA6IDAKICB9CiAgaWYgKHRoaXNTdGFydCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzU3RhcnQgPSAwCiAgfQogIGlmICh0aGlzRW5kID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNFbmQgPSB0aGlzLmxlbmd0aAogIH0KCiAgaWYgKHN0YXJ0IDwgMCB8fCBlbmQgPiB0YXJnZXQubGVuZ3RoIHx8IHRoaXNTdGFydCA8IDAgfHwgdGhpc0VuZCA+IHRoaXMubGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb3V0IG9mIHJhbmdlIGluZGV4JykKICB9CgogIGlmICh0aGlzU3RhcnQgPj0gdGhpc0VuZCAmJiBzdGFydCA+PSBlbmQpIHsKICAgIHJldHVybiAwCiAgfQogIGlmICh0aGlzU3RhcnQgPj0gdGhpc0VuZCkgewogICAgcmV0dXJuIC0xCiAgfQogIGlmIChzdGFydCA+PSBlbmQpIHsKICAgIHJldHVybiAxCiAgfQoKICBzdGFydCA+Pj49IDAKICBlbmQgPj4+PSAwCiAgdGhpc1N0YXJ0ID4+Pj0gMAogIHRoaXNFbmQgPj4+PSAwCgogIGlmICh0aGlzID09PSB0YXJnZXQpIHJldHVybiAwCgogIHZhciB4ID0gdGhpc0VuZCAtIHRoaXNTdGFydAogIHZhciB5ID0gZW5kIC0gc3RhcnQKICB2YXIgbGVuID0gTWF0aC5taW4oeCwgeSkKCiAgdmFyIHRoaXNDb3B5ID0gdGhpcy5zbGljZSh0aGlzU3RhcnQsIHRoaXNFbmQpCiAgdmFyIHRhcmdldENvcHkgPSB0YXJnZXQuc2xpY2Uoc3RhcnQsIGVuZCkKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgaWYgKHRoaXNDb3B5W2ldICE9PSB0YXJnZXRDb3B5W2ldKSB7CiAgICAgIHggPSB0aGlzQ29weVtpXQogICAgICB5ID0gdGFyZ2V0Q29weVtpXQogICAgICBicmVhawogICAgfQogIH0KCiAgaWYgKHggPCB5KSByZXR1cm4gLTEKICBpZiAoeSA8IHgpIHJldHVybiAxCiAgcmV0dXJuIDAKfQoKLy8gRmluZHMgZWl0aGVyIHRoZSBmaXJzdCBpbmRleCBvZiBgdmFsYCBpbiBgYnVmZmVyYCBhdCBvZmZzZXQgPj0gYGJ5dGVPZmZzZXRgLAovLyBPUiB0aGUgbGFzdCBpbmRleCBvZiBgdmFsYCBpbiBgYnVmZmVyYCBhdCBvZmZzZXQgPD0gYGJ5dGVPZmZzZXRgLgovLwovLyBBcmd1bWVudHM6Ci8vIC0gYnVmZmVyIC0gYSBCdWZmZXIgdG8gc2VhcmNoCi8vIC0gdmFsIC0gYSBzdHJpbmcsIEJ1ZmZlciwgb3IgbnVtYmVyCi8vIC0gYnl0ZU9mZnNldCAtIGFuIGluZGV4IGludG8gYGJ1ZmZlcmA7IHdpbGwgYmUgY2xhbXBlZCB0byBhbiBpbnQzMgovLyAtIGVuY29kaW5nIC0gYW4gb3B0aW9uYWwgZW5jb2RpbmcsIHJlbGV2YW50IGlzIHZhbCBpcyBhIHN0cmluZwovLyAtIGRpciAtIHRydWUgZm9yIGluZGV4T2YsIGZhbHNlIGZvciBsYXN0SW5kZXhPZgpmdW5jdGlvbiBiaWRpcmVjdGlvbmFsSW5kZXhPZiAoYnVmZmVyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICAvLyBFbXB0eSBidWZmZXIgbWVhbnMgbm8gbWF0Y2gKICBpZiAoYnVmZmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuIC0xCgogIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0CiAgaWYgKHR5cGVvZiBieXRlT2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgZW5jb2RpbmcgPSBieXRlT2Zmc2V0CiAgICBieXRlT2Zmc2V0ID0gMAogIH0gZWxzZSBpZiAoYnl0ZU9mZnNldCA+IDB4N2ZmZmZmZmYpIHsKICAgIGJ5dGVPZmZzZXQgPSAweDdmZmZmZmZmCiAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgLTB4ODAwMDAwMDApIHsKICAgIGJ5dGVPZmZzZXQgPSAtMHg4MDAwMDAwMAogIH0KICBieXRlT2Zmc2V0ID0gK2J5dGVPZmZzZXQgIC8vIENvZXJjZSB0byBOdW1iZXIuCiAgaWYgKGlzTmFOKGJ5dGVPZmZzZXQpKSB7CiAgICAvLyBieXRlT2Zmc2V0OiBpdCBpdCdzIHVuZGVmaW5lZCwgbnVsbCwgTmFOLCAiZm9vIiwgZXRjLCBzZWFyY2ggd2hvbGUgYnVmZmVyCiAgICBieXRlT2Zmc2V0ID0gZGlyID8gMCA6IChidWZmZXIubGVuZ3RoIC0gMSkKICB9CgogIC8vIE5vcm1hbGl6ZSBieXRlT2Zmc2V0OiBuZWdhdGl2ZSBvZmZzZXRzIHN0YXJ0IGZyb20gdGhlIGVuZCBvZiB0aGUgYnVmZmVyCiAgaWYgKGJ5dGVPZmZzZXQgPCAwKSBieXRlT2Zmc2V0ID0gYnVmZmVyLmxlbmd0aCArIGJ5dGVPZmZzZXQKICBpZiAoYnl0ZU9mZnNldCA+PSBidWZmZXIubGVuZ3RoKSB7CiAgICBpZiAoZGlyKSByZXR1cm4gLTEKICAgIGVsc2UgYnl0ZU9mZnNldCA9IGJ1ZmZlci5sZW5ndGggLSAxCiAgfSBlbHNlIGlmIChieXRlT2Zmc2V0IDwgMCkgewogICAgaWYgKGRpcikgYnl0ZU9mZnNldCA9IDAKICAgIGVsc2UgcmV0dXJuIC0xCiAgfQoKICAvLyBOb3JtYWxpemUgdmFsCiAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7CiAgICB2YWwgPSBCdWZmZXIuZnJvbSh2YWwsIGVuY29kaW5nKQogIH0KCiAgLy8gRmluYWxseSwgc2VhcmNoIGVpdGhlciBpbmRleE9mIChpZiBkaXIgaXMgdHJ1ZSkgb3IgbGFzdEluZGV4T2YKICBpZiAoQnVmZmVyLmlzQnVmZmVyKHZhbCkpIHsKICAgIC8vIFNwZWNpYWwgY2FzZTogbG9va2luZyBmb3IgZW1wdHkgc3RyaW5nL2J1ZmZlciBhbHdheXMgZmFpbHMKICAgIGlmICh2YWwubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybiAtMQogICAgfQogICAgcmV0dXJuIGFycmF5SW5kZXhPZihidWZmZXIsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikKICB9IGVsc2UgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICB2YWwgPSB2YWwgJiAweEZGIC8vIFNlYXJjaCBmb3IgYSBieXRlIHZhbHVlIFswLTI1NV0KICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJgogICAgICAgIHR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIGlmIChkaXIpIHsKICAgICAgICByZXR1cm4gVWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBVaW50OEFycmF5LnByb3RvdHlwZS5sYXN0SW5kZXhPZi5jYWxsKGJ1ZmZlciwgdmFsLCBieXRlT2Zmc2V0KQogICAgICB9CiAgICB9CiAgICByZXR1cm4gYXJyYXlJbmRleE9mKGJ1ZmZlciwgWyB2YWwgXSwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIGRpcikKICB9CgogIHRocm93IG5ldyBUeXBlRXJyb3IoJ3ZhbCBtdXN0IGJlIHN0cmluZywgbnVtYmVyIG9yIEJ1ZmZlcicpCn0KCmZ1bmN0aW9uIGFycmF5SW5kZXhPZiAoYXJyLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBkaXIpIHsKICB2YXIgaW5kZXhTaXplID0gMQogIHZhciBhcnJMZW5ndGggPSBhcnIubGVuZ3RoCiAgdmFyIHZhbExlbmd0aCA9IHZhbC5sZW5ndGgKCiAgaWYgKGVuY29kaW5nICE9PSB1bmRlZmluZWQpIHsKICAgIGVuY29kaW5nID0gU3RyaW5nKGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICBpZiAoZW5jb2RpbmcgPT09ICd1Y3MyJyB8fCBlbmNvZGluZyA9PT0gJ3Vjcy0yJyB8fAogICAgICAgIGVuY29kaW5nID09PSAndXRmMTZsZScgfHwgZW5jb2RpbmcgPT09ICd1dGYtMTZsZScpIHsKICAgICAgaWYgKGFyci5sZW5ndGggPCAyIHx8IHZhbC5sZW5ndGggPCAyKSB7CiAgICAgICAgcmV0dXJuIC0xCiAgICAgIH0KICAgICAgaW5kZXhTaXplID0gMgogICAgICBhcnJMZW5ndGggLz0gMgogICAgICB2YWxMZW5ndGggLz0gMgogICAgICBieXRlT2Zmc2V0IC89IDIKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlYWQgKGJ1ZiwgaSkgewogICAgaWYgKGluZGV4U2l6ZSA9PT0gMSkgewogICAgICByZXR1cm4gYnVmW2ldCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gYnVmLnJlYWRVSW50MTZCRShpICogaW5kZXhTaXplKQogICAgfQogIH0KCiAgdmFyIGkKICBpZiAoZGlyKSB7CiAgICB2YXIgZm91bmRJbmRleCA9IC0xCiAgICBmb3IgKGkgPSBieXRlT2Zmc2V0OyBpIDwgYXJyTGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHJlYWQoYXJyLCBpKSA9PT0gcmVhZCh2YWwsIGZvdW5kSW5kZXggPT09IC0xID8gMCA6IGkgLSBmb3VuZEluZGV4KSkgewogICAgICAgIGlmIChmb3VuZEluZGV4ID09PSAtMSkgZm91bmRJbmRleCA9IGkKICAgICAgICBpZiAoaSAtIGZvdW5kSW5kZXggKyAxID09PSB2YWxMZW5ndGgpIHJldHVybiBmb3VuZEluZGV4ICogaW5kZXhTaXplCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGZvdW5kSW5kZXggIT09IC0xKSBpIC09IGkgLSBmb3VuZEluZGV4CiAgICAgICAgZm91bmRJbmRleCA9IC0xCiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgaWYgKGJ5dGVPZmZzZXQgKyB2YWxMZW5ndGggPiBhcnJMZW5ndGgpIGJ5dGVPZmZzZXQgPSBhcnJMZW5ndGggLSB2YWxMZW5ndGgKICAgIGZvciAoaSA9IGJ5dGVPZmZzZXQ7IGkgPj0gMDsgaS0tKSB7CiAgICAgIHZhciBmb3VuZCA9IHRydWUKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB2YWxMZW5ndGg7IGorKykgewogICAgICAgIGlmIChyZWFkKGFyciwgaSArIGopICE9PSByZWFkKHZhbCwgaikpIHsKICAgICAgICAgIGZvdW5kID0gZmFsc2UKICAgICAgICAgIGJyZWFrCiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmb3VuZCkgcmV0dXJuIGkKICAgIH0KICB9CgogIHJldHVybiAtMQp9CgpCdWZmZXIucHJvdG90eXBlLmluY2x1ZGVzID0gZnVuY3Rpb24gaW5jbHVkZXMgKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpIHsKICByZXR1cm4gdGhpcy5pbmRleE9mKHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcpICE9PSAtMQp9CgpCdWZmZXIucHJvdG90eXBlLmluZGV4T2YgPSBmdW5jdGlvbiBpbmRleE9mICh2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nKSB7CiAgcmV0dXJuIGJpZGlyZWN0aW9uYWxJbmRleE9mKHRoaXMsIHZhbCwgYnl0ZU9mZnNldCwgZW5jb2RpbmcsIHRydWUpCn0KCkJ1ZmZlci5wcm90b3R5cGUubGFzdEluZGV4T2YgPSBmdW5jdGlvbiBsYXN0SW5kZXhPZiAodmFsLCBieXRlT2Zmc2V0LCBlbmNvZGluZykgewogIHJldHVybiBiaWRpcmVjdGlvbmFsSW5kZXhPZih0aGlzLCB2YWwsIGJ5dGVPZmZzZXQsIGVuY29kaW5nLCBmYWxzZSkKfQoKZnVuY3Rpb24gaGV4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIG9mZnNldCA9IE51bWJlcihvZmZzZXQpIHx8IDAKICB2YXIgcmVtYWluaW5nID0gYnVmLmxlbmd0aCAtIG9mZnNldAogIGlmICghbGVuZ3RoKSB7CiAgICBsZW5ndGggPSByZW1haW5pbmcKICB9IGVsc2UgewogICAgbGVuZ3RoID0gTnVtYmVyKGxlbmd0aCkKICAgIGlmIChsZW5ndGggPiByZW1haW5pbmcpIHsKICAgICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgICB9CiAgfQoKICAvLyBtdXN0IGJlIGFuIGV2ZW4gbnVtYmVyIG9mIGRpZ2l0cwogIHZhciBzdHJMZW4gPSBzdHJpbmcubGVuZ3RoCiAgaWYgKHN0ckxlbiAlIDIgIT09IDApIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCgogIGlmIChsZW5ndGggPiBzdHJMZW4gLyAyKSB7CiAgICBsZW5ndGggPSBzdHJMZW4gLyAyCiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgIHZhciBwYXJzZWQgPSBwYXJzZUludChzdHJpbmcuc3Vic3RyKGkgKiAyLCAyKSwgMTYpCiAgICBpZiAoaXNOYU4ocGFyc2VkKSkgcmV0dXJuIGkKICAgIGJ1ZltvZmZzZXQgKyBpXSA9IHBhcnNlZAogIH0KICByZXR1cm4gaQp9CgpmdW5jdGlvbiB1dGY4V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBibGl0QnVmZmVyKHV0ZjhUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCn0KCmZ1bmN0aW9uIGFzY2lpV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBibGl0QnVmZmVyKGFzY2lpVG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQp9CgpmdW5jdGlvbiBsYXRpbjFXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgcmV0dXJuIGFzY2lpV3JpdGUoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQp9CgpmdW5jdGlvbiBiYXNlNjRXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgcmV0dXJuIGJsaXRCdWZmZXIoYmFzZTY0VG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQp9CgpmdW5jdGlvbiB1Y3MyV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBibGl0QnVmZmVyKHV0ZjE2bGVUb0J5dGVzKHN0cmluZywgYnVmLmxlbmd0aCAtIG9mZnNldCksIGJ1Ziwgb2Zmc2V0LCBsZW5ndGgpCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiB3cml0ZSAoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKICAvLyBCdWZmZXIjd3JpdGUoc3RyaW5nKQogIGlmIChvZmZzZXQgPT09IHVuZGVmaW5lZCkgewogICAgZW5jb2RpbmcgPSAndXRmOCcKICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICBvZmZzZXQgPSAwCiAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgZW5jb2RpbmcpCiAgfSBlbHNlIGlmIChsZW5ndGggPT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2Zmc2V0ID09PSAnc3RyaW5nJykgewogICAgZW5jb2RpbmcgPSBvZmZzZXQKICAgIGxlbmd0aCA9IHRoaXMubGVuZ3RoCiAgICBvZmZzZXQgPSAwCiAgLy8gQnVmZmVyI3dyaXRlKHN0cmluZywgb2Zmc2V0WywgbGVuZ3RoXVssIGVuY29kaW5nXSkKICB9IGVsc2UgaWYgKGlzRmluaXRlKG9mZnNldCkpIHsKICAgIG9mZnNldCA9IG9mZnNldCB8IDAKICAgIGlmIChpc0Zpbml0ZShsZW5ndGgpKSB7CiAgICAgIGxlbmd0aCA9IGxlbmd0aCB8IDAKICAgICAgaWYgKGVuY29kaW5nID09PSB1bmRlZmluZWQpIGVuY29kaW5nID0gJ3V0ZjgnCiAgICB9IGVsc2UgewogICAgICBlbmNvZGluZyA9IGxlbmd0aAogICAgICBsZW5ndGggPSB1bmRlZmluZWQKICAgIH0KICAvLyBsZWdhY3kgd3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0LCBsZW5ndGgpIC0gcmVtb3ZlIGluIHYwLjEzCiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgJ0J1ZmZlci53cml0ZShzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXRbLCBsZW5ndGhdKSBpcyBubyBsb25nZXIgc3VwcG9ydGVkJwogICAgKQogIH0KCiAgdmFyIHJlbWFpbmluZyA9IHRoaXMubGVuZ3RoIC0gb2Zmc2V0CiAgaWYgKGxlbmd0aCA9PT0gdW5kZWZpbmVkIHx8IGxlbmd0aCA+IHJlbWFpbmluZykgbGVuZ3RoID0gcmVtYWluaW5nCgogIGlmICgoc3RyaW5nLmxlbmd0aCA+IDAgJiYgKGxlbmd0aCA8IDAgfHwgb2Zmc2V0IDwgMCkpIHx8IG9mZnNldCA+IHRoaXMubGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMnKQogIH0KCiAgaWYgKCFlbmNvZGluZykgZW5jb2RpbmcgPSAndXRmOCcKCiAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKICBmb3IgKDs7KSB7CiAgICBzd2l0Y2ggKGVuY29kaW5nKSB7CiAgICAgIGNhc2UgJ2hleCc6CiAgICAgICAgcmV0dXJuIGhleFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCgogICAgICBjYXNlICd1dGY4JzoKICAgICAgY2FzZSAndXRmLTgnOgogICAgICAgIHJldHVybiB1dGY4V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCiAgICAgIGNhc2UgJ2FzY2lpJzoKICAgICAgICByZXR1cm4gYXNjaWlXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQoKICAgICAgY2FzZSAnbGF0aW4xJzoKICAgICAgY2FzZSAnYmluYXJ5JzoKICAgICAgICByZXR1cm4gbGF0aW4xV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCiAgICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgICAgLy8gV2FybmluZzogbWF4TGVuZ3RoIG5vdCB0YWtlbiBpbnRvIGFjY291bnQgaW4gYmFzZTY0V3JpdGUKICAgICAgICByZXR1cm4gYmFzZTY0V3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKCiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgcmV0dXJuIHVjczJXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQoKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAobG93ZXJlZENhc2UpIHRocm93IG5ldyBUeXBlRXJyb3IoJ1Vua25vd24gZW5jb2Rpbmc6ICcgKyBlbmNvZGluZykKICAgICAgICBlbmNvZGluZyA9ICgnJyArIGVuY29kaW5nKS50b0xvd2VyQ2FzZSgpCiAgICAgICAgbG93ZXJlZENhc2UgPSB0cnVlCiAgICB9CiAgfQp9CgpCdWZmZXIucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTiAoKSB7CiAgcmV0dXJuIHsKICAgIHR5cGU6ICdCdWZmZXInLAogICAgZGF0YTogQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fYXJyIHx8IHRoaXMsIDApCiAgfQp9CgpmdW5jdGlvbiBiYXNlNjRTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgaWYgKHN0YXJ0ID09PSAwICYmIGVuZCA9PT0gYnVmLmxlbmd0aCkgewogICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1ZikKICB9IGVsc2UgewogICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1Zi5zbGljZShzdGFydCwgZW5kKSkKICB9Cn0KCmZ1bmN0aW9uIHV0ZjhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQogIHZhciByZXMgPSBbXQoKICB2YXIgaSA9IHN0YXJ0CiAgd2hpbGUgKGkgPCBlbmQpIHsKICAgIHZhciBmaXJzdEJ5dGUgPSBidWZbaV0KICAgIHZhciBjb2RlUG9pbnQgPSBudWxsCiAgICB2YXIgYnl0ZXNQZXJTZXF1ZW5jZSA9IChmaXJzdEJ5dGUgPiAweEVGKSA/IDQKICAgICAgOiAoZmlyc3RCeXRlID4gMHhERikgPyAzCiAgICAgIDogKGZpcnN0Qnl0ZSA+IDB4QkYpID8gMgogICAgICA6IDEKCiAgICBpZiAoaSArIGJ5dGVzUGVyU2VxdWVuY2UgPD0gZW5kKSB7CiAgICAgIHZhciBzZWNvbmRCeXRlLCB0aGlyZEJ5dGUsIGZvdXJ0aEJ5dGUsIHRlbXBDb2RlUG9pbnQKCiAgICAgIHN3aXRjaCAoYnl0ZXNQZXJTZXF1ZW5jZSkgewogICAgICAgIGNhc2UgMToKICAgICAgICAgIGlmIChmaXJzdEJ5dGUgPCAweDgwKSB7CiAgICAgICAgICAgIGNvZGVQb2ludCA9IGZpcnN0Qnl0ZQogICAgICAgICAgfQogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweDFGKSA8PCAweDYgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHg3RikgewogICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYnJlYWsKICAgICAgICBjYXNlIDM6CiAgICAgICAgICBzZWNvbmRCeXRlID0gYnVmW2kgKyAxXQogICAgICAgICAgdGhpcmRCeXRlID0gYnVmW2kgKyAyXQogICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwKSB7CiAgICAgICAgICAgIHRlbXBDb2RlUG9pbnQgPSAoZmlyc3RCeXRlICYgMHhGKSA8PCAweEMgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpIDw8IDB4NiB8ICh0aGlyZEJ5dGUgJiAweDNGKQogICAgICAgICAgICBpZiAodGVtcENvZGVQb2ludCA+IDB4N0ZGICYmICh0ZW1wQ29kZVBvaW50IDwgMHhEODAwIHx8IHRlbXBDb2RlUG9pbnQgPiAweERGRkYpKSB7CiAgICAgICAgICAgICAgY29kZVBvaW50ID0gdGVtcENvZGVQb2ludAogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBicmVhawogICAgICAgIGNhc2UgNDoKICAgICAgICAgIHNlY29uZEJ5dGUgPSBidWZbaSArIDFdCiAgICAgICAgICB0aGlyZEJ5dGUgPSBidWZbaSArIDJdCiAgICAgICAgICBmb3VydGhCeXRlID0gYnVmW2kgKyAzXQogICAgICAgICAgaWYgKChzZWNvbmRCeXRlICYgMHhDMCkgPT09IDB4ODAgJiYgKHRoaXJkQnl0ZSAmIDB4QzApID09PSAweDgwICYmIChmb3VydGhCeXRlICYgMHhDMCkgPT09IDB4ODApIHsKICAgICAgICAgICAgdGVtcENvZGVQb2ludCA9IChmaXJzdEJ5dGUgJiAweEYpIDw8IDB4MTIgfCAoc2Vjb25kQnl0ZSAmIDB4M0YpIDw8IDB4QyB8ICh0aGlyZEJ5dGUgJiAweDNGKSA8PCAweDYgfCAoZm91cnRoQnl0ZSAmIDB4M0YpCiAgICAgICAgICAgIGlmICh0ZW1wQ29kZVBvaW50ID4gMHhGRkZGICYmIHRlbXBDb2RlUG9pbnQgPCAweDExMDAwMCkgewogICAgICAgICAgICAgIGNvZGVQb2ludCA9IHRlbXBDb2RlUG9pbnQKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKGNvZGVQb2ludCA9PT0gbnVsbCkgewogICAgICAvLyB3ZSBkaWQgbm90IGdlbmVyYXRlIGEgdmFsaWQgY29kZVBvaW50IHNvIGluc2VydCBhCiAgICAgIC8vIHJlcGxhY2VtZW50IGNoYXIgKFUrRkZGRCkgYW5kIGFkdmFuY2Ugb25seSAxIGJ5dGUKICAgICAgY29kZVBvaW50ID0gMHhGRkZECiAgICAgIGJ5dGVzUGVyU2VxdWVuY2UgPSAxCiAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA+IDB4RkZGRikgewogICAgICAvLyBlbmNvZGUgdG8gdXRmMTYgKHN1cnJvZ2F0ZSBwYWlyIGRhbmNlKQogICAgICBjb2RlUG9pbnQgLT0gMHgxMDAwMAogICAgICByZXMucHVzaChjb2RlUG9pbnQgPj4+IDEwICYgMHgzRkYgfCAweEQ4MDApCiAgICAgIGNvZGVQb2ludCA9IDB4REMwMCB8IGNvZGVQb2ludCAmIDB4M0ZGCiAgICB9CgogICAgcmVzLnB1c2goY29kZVBvaW50KQogICAgaSArPSBieXRlc1BlclNlcXVlbmNlCiAgfQoKICByZXR1cm4gZGVjb2RlQ29kZVBvaW50c0FycmF5KHJlcykKfQoKLy8gQmFzZWQgb24gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMjI3NDcyNzIvNjgwNzQyLCB0aGUgYnJvd3NlciB3aXRoCi8vIHRoZSBsb3dlc3QgbGltaXQgaXMgQ2hyb21lLCB3aXRoIDB4MTAwMDAgYXJncy4KLy8gV2UgZ28gMSBtYWduaXR1ZGUgbGVzcywgZm9yIHNhZmV0eQp2YXIgTUFYX0FSR1VNRU5UU19MRU5HVEggPSAweDEwMDAKCmZ1bmN0aW9uIGRlY29kZUNvZGVQb2ludHNBcnJheSAoY29kZVBvaW50cykgewogIHZhciBsZW4gPSBjb2RlUG9pbnRzLmxlbmd0aAogIGlmIChsZW4gPD0gTUFYX0FSR1VNRU5UU19MRU5HVEgpIHsKICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY29kZVBvaW50cykgLy8gYXZvaWQgZXh0cmEgc2xpY2UoKQogIH0KCiAgLy8gRGVjb2RlIGluIGNodW5rcyB0byBhdm9pZCAiY2FsbCBzdGFjayBzaXplIGV4Y2VlZGVkIi4KICB2YXIgcmVzID0gJycKICB2YXIgaSA9IDAKICB3aGlsZSAoaSA8IGxlbikgewogICAgcmVzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoCiAgICAgIFN0cmluZywKICAgICAgY29kZVBvaW50cy5zbGljZShpLCBpICs9IE1BWF9BUkdVTUVOVFNfTEVOR1RIKQogICAgKQogIH0KICByZXR1cm4gcmVzCn0KCmZ1bmN0aW9uIGFzY2lpU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIHZhciByZXQgPSAnJwogIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKCiAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSAmIDB4N0YpCiAgfQogIHJldHVybiByZXQKfQoKZnVuY3Rpb24gbGF0aW4xU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIHZhciByZXQgPSAnJwogIGVuZCA9IE1hdGgubWluKGJ1Zi5sZW5ndGgsIGVuZCkKCiAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgIHJldCArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ1ZltpXSkKICB9CiAgcmV0dXJuIHJldAp9CgpmdW5jdGlvbiBoZXhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIGxlbiA9IGJ1Zi5sZW5ndGgKCiAgaWYgKCFzdGFydCB8fCBzdGFydCA8IDApIHN0YXJ0ID0gMAogIGlmICghZW5kIHx8IGVuZCA8IDAgfHwgZW5kID4gbGVuKSBlbmQgPSBsZW4KCiAgdmFyIG91dCA9ICcnCiAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDwgZW5kOyArK2kpIHsKICAgIG91dCArPSB0b0hleChidWZbaV0pCiAgfQogIHJldHVybiBvdXQKfQoKZnVuY3Rpb24gdXRmMTZsZVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICB2YXIgYnl0ZXMgPSBidWYuc2xpY2Uoc3RhcnQsIGVuZCkKICB2YXIgcmVzID0gJycKICBmb3IgKHZhciBpID0gMDsgaSA8IGJ5dGVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICByZXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1tpXSArIGJ5dGVzW2kgKyAxXSAqIDI1NikKICB9CiAgcmV0dXJuIHJlcwp9CgpCdWZmZXIucHJvdG90eXBlLnNsaWNlID0gZnVuY3Rpb24gc2xpY2UgKHN0YXJ0LCBlbmQpIHsKICB2YXIgbGVuID0gdGhpcy5sZW5ndGgKICBzdGFydCA9IH5+c3RhcnQKICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IGxlbiA6IH5+ZW5kCgogIGlmIChzdGFydCA8IDApIHsKICAgIHN0YXJ0ICs9IGxlbgogICAgaWYgKHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgfSBlbHNlIGlmIChzdGFydCA+IGxlbikgewogICAgc3RhcnQgPSBsZW4KICB9CgogIGlmIChlbmQgPCAwKSB7CiAgICBlbmQgKz0gbGVuCiAgICBpZiAoZW5kIDwgMCkgZW5kID0gMAogIH0gZWxzZSBpZiAoZW5kID4gbGVuKSB7CiAgICBlbmQgPSBsZW4KICB9CgogIGlmIChlbmQgPCBzdGFydCkgZW5kID0gc3RhcnQKCiAgdmFyIG5ld0J1ZgogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgbmV3QnVmID0gdGhpcy5zdWJhcnJheShzdGFydCwgZW5kKQogICAgbmV3QnVmLl9fcHJvdG9fXyA9IEJ1ZmZlci5wcm90b3R5cGUKICB9IGVsc2UgewogICAgdmFyIHNsaWNlTGVuID0gZW5kIC0gc3RhcnQKICAgIG5ld0J1ZiA9IG5ldyBCdWZmZXIoc2xpY2VMZW4sIHVuZGVmaW5lZCkKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpY2VMZW47ICsraSkgewogICAgICBuZXdCdWZbaV0gPSB0aGlzW2kgKyBzdGFydF0KICAgIH0KICB9CgogIHJldHVybiBuZXdCdWYKfQoKLyoKICogTmVlZCB0byBtYWtlIHN1cmUgdGhhdCBidWZmZXIgaXNuJ3QgdHJ5aW5nIHRvIHdyaXRlIG91dCBvZiBib3VuZHMuCiAqLwpmdW5jdGlvbiBjaGVja09mZnNldCAob2Zmc2V0LCBleHQsIGxlbmd0aCkgewogIGlmICgob2Zmc2V0ICUgMSkgIT09IDAgfHwgb2Zmc2V0IDwgMCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ29mZnNldCBpcyBub3QgdWludCcpCiAgaWYgKG9mZnNldCArIGV4dCA+IGxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RyeWluZyB0byBhY2Nlc3MgYmV5b25kIGJ1ZmZlciBsZW5ndGgnKQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50TEUgPSBmdW5jdGlvbiByZWFkVUludExFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCgogIHZhciB2YWwgPSB0aGlzW29mZnNldF0KICB2YXIgbXVsID0gMQogIHZhciBpID0gMAogIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bAogIH0KCiAgcmV0dXJuIHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50QkUgPSBmdW5jdGlvbiByZWFkVUludEJFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogIGlmICghbm9Bc3NlcnQpIHsKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCiAgfQoKICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAtLWJ5dGVMZW5ndGhdCiAgdmFyIG11bCA9IDEKICB3aGlsZSAoYnl0ZUxlbmd0aCA+IDAgJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIHZhbCArPSB0aGlzW29mZnNldCArIC0tYnl0ZUxlbmd0aF0gKiBtdWwKICB9CgogIHJldHVybiB2YWwKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDggPSBmdW5jdGlvbiByZWFkVUludDggKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDEsIHRoaXMubGVuZ3RoKQogIHJldHVybiB0aGlzW29mZnNldF0KfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDE2TEUgPSBmdW5jdGlvbiByZWFkVUludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogIHJldHVybiB0aGlzW29mZnNldF0gfCAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRVSW50MTZCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgOCkgfCB0aGlzW29mZnNldCArIDFdCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkxFID0gZnVuY3Rpb24gcmVhZFVJbnQzMkxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICgodGhpc1tvZmZzZXRdKSB8CiAgICAgICh0aGlzW29mZnNldCArIDFdIDw8IDgpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgMTYpKSArCiAgICAgICh0aGlzW29mZnNldCArIDNdICogMHgxMDAwMDAwKQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MzJCRSA9IGZ1bmN0aW9uIHJlYWRVSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCgogIHJldHVybiAodGhpc1tvZmZzZXRdICogMHgxMDAwMDAwKSArCiAgICAoKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgIHRoaXNbb2Zmc2V0ICsgM10pCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludExFID0gZnVuY3Rpb24gcmVhZEludExFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCgogIHZhciB2YWwgPSB0aGlzW29mZnNldF0KICB2YXIgbXVsID0gMQogIHZhciBpID0gMAogIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICB2YWwgKz0gdGhpc1tvZmZzZXQgKyBpXSAqIG11bAogIH0KICBtdWwgKj0gMHg4MAoKICBpZiAodmFsID49IG11bCkgdmFsIC09IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKQoKICByZXR1cm4gdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludEJFID0gZnVuY3Rpb24gcmVhZEludEJFIChvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgYnl0ZUxlbmd0aCwgdGhpcy5sZW5ndGgpCgogIHZhciBpID0gYnl0ZUxlbmd0aAogIHZhciBtdWwgPSAxCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0ICsgLS1pXQogIHdoaWxlIChpID4gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgdmFsICs9IHRoaXNbb2Zmc2V0ICsgLS1pXSAqIG11bAogIH0KICBtdWwgKj0gMHg4MAoKICBpZiAodmFsID49IG11bCkgdmFsIC09IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKQoKICByZXR1cm4gdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludDggPSBmdW5jdGlvbiByZWFkSW50OCAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgaWYgKCEodGhpc1tvZmZzZXRdICYgMHg4MCkpIHJldHVybiAodGhpc1tvZmZzZXRdKQogIHJldHVybiAoKDB4ZmYgLSB0aGlzW29mZnNldF0gKyAxKSAqIC0xKQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkxFID0gZnVuY3Rpb24gcmVhZEludDE2TEUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDIsIHRoaXMubGVuZ3RoKQogIHZhciB2YWwgPSB0aGlzW29mZnNldF0gfCAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KQogIHJldHVybiAodmFsICYgMHg4MDAwKSA/IHZhbCB8IDB4RkZGRjAwMDAgOiB2YWwKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZCRSA9IGZ1bmN0aW9uIHJlYWRJbnQxNkJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAxXSB8ICh0aGlzW29mZnNldF0gPDwgOCkKICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUgPSBmdW5jdGlvbiByZWFkSW50MzJMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCgogIHJldHVybiAodGhpc1tvZmZzZXRdKSB8CiAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikgfAogICAgKHRoaXNbb2Zmc2V0ICsgM10gPDwgMjQpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyQkUgPSBmdW5jdGlvbiByZWFkSW50MzJCRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCgogIHJldHVybiAodGhpc1tvZmZzZXRdIDw8IDI0KSB8CiAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCAxNikgfAogICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgKHRoaXNbb2Zmc2V0ICsgM10pCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEZsb2F0TEUgPSBmdW5jdGlvbiByZWFkRmxvYXRMRSAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDIzLCA0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdEJFID0gZnVuY3Rpb24gcmVhZEZsb2F0QkUgKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQogIHJldHVybiBpZWVlNzU0LnJlYWQodGhpcywgb2Zmc2V0LCBmYWxzZSwgMjMsIDQpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZERvdWJsZUxFID0gZnVuY3Rpb24gcmVhZERvdWJsZUxFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA4LCB0aGlzLmxlbmd0aCkKICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgdHJ1ZSwgNTIsIDgpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZERvdWJsZUJFID0gZnVuY3Rpb24gcmVhZERvdWJsZUJFIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkgY2hlY2tPZmZzZXQob2Zmc2V0LCA4LCB0aGlzLmxlbmd0aCkKICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDUyLCA4KQp9CgpmdW5jdGlvbiBjaGVja0ludCAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBleHQsIG1heCwgbWluKSB7CiAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmKSkgdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpCiAgaWYgKHZhbHVlID4gbWF4IHx8IHZhbHVlIDwgbWluKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignInZhbHVlIiBhcmd1bWVudCBpcyBvdXQgb2YgYm91bmRzJykKICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50TEUgPSBmdW5jdGlvbiB3cml0ZVVJbnRMRSAodmFsdWUsIG9mZnNldCwgYnl0ZUxlbmd0aCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCB8IDAKICBieXRlTGVuZ3RoID0gYnl0ZUxlbmd0aCB8IDAKICBpZiAoIW5vQXNzZXJ0KSB7CiAgICB2YXIgbWF4Qnl0ZXMgPSBNYXRoLnBvdygyLCA4ICogYnl0ZUxlbmd0aCkgLSAxCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBtYXhCeXRlcywgMCkKICB9CgogIHZhciBtdWwgPSAxCiAgdmFyIGkgPSAwCiAgdGhpc1tvZmZzZXRdID0gdmFsdWUgJiAweEZGCiAgd2hpbGUgKCsraSA8IGJ5dGVMZW5ndGggJiYgKG11bCAqPSAweDEwMCkpIHsKICAgIHRoaXNbb2Zmc2V0ICsgaV0gPSAodmFsdWUgLyBtdWwpICYgMHhGRgogIH0KCiAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnRCRSA9IGZ1bmN0aW9uIHdyaXRlVUludEJFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGJ5dGVMZW5ndGggPSBieXRlTGVuZ3RoIHwgMAogIGlmICghbm9Bc3NlcnQpIHsKICAgIHZhciBtYXhCeXRlcyA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoKSAtIDEKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG1heEJ5dGVzLCAwKQogIH0KCiAgdmFyIGkgPSBieXRlTGVuZ3RoIC0gMQogIHZhciBtdWwgPSAxCiAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMHhGRgogIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgdGhpc1tvZmZzZXQgKyBpXSA9ICh2YWx1ZSAvIG11bCkgJiAweEZGCiAgfQoKICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDggPSBmdW5jdGlvbiB3cml0ZVVJbnQ4ICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4ZmYsIDApCiAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKQogIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgcmV0dXJuIG9mZnNldCArIDEKfQoKZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MTYgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmYgKyB2YWx1ZSArIDEKICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKGJ1Zi5sZW5ndGggLSBvZmZzZXQsIDIpOyBpIDwgajsgKytpKSB7CiAgICBidWZbb2Zmc2V0ICsgaV0gPSAodmFsdWUgJiAoMHhmZiA8PCAoOCAqIChsaXR0bGVFbmRpYW4gPyBpIDogMSAtIGkpKSkpID4+PgogICAgICAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSAqIDgKICB9Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZMRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHhmZmZmLCAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgfQogIHJldHVybiBvZmZzZXQgKyAyCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MTZCRSA9IGZ1bmN0aW9uIHdyaXRlVUludDE2QkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHhmZmZmLCAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSAmIDB4ZmYpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlKQogIH0KICByZXR1cm4gb2Zmc2V0ICsgMgp9CgpmdW5jdGlvbiBvYmplY3RXcml0ZVVJbnQzMiAoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4pIHsKICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmZmZmZmZmYgKyB2YWx1ZSArIDEKICBmb3IgKHZhciBpID0gMCwgaiA9IE1hdGgubWluKGJ1Zi5sZW5ndGggLSBvZmZzZXQsIDQpOyBpIDwgajsgKytpKSB7CiAgICBidWZbb2Zmc2V0ICsgaV0gPSAodmFsdWUgPj4+IChsaXR0bGVFbmRpYW4gPyBpIDogMyAtIGkpICogOCkgJiAweGZmCiAgfQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZVVJbnQzMkxFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4ZmZmZmZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgfQogIHJldHVybiBvZmZzZXQgKyA0Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVVSW50MzJCRSA9IGZ1bmN0aW9uIHdyaXRlVUludDMyQkUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gMjQpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiAxNikKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlICYgMHhmZikKICB9IGVsc2UgewogICAgb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgfQogIHJldHVybiBvZmZzZXQgKyA0Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnRMRSA9IGZ1bmN0aW9uIHdyaXRlSW50TEUgKHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgewogICAgdmFyIGxpbWl0ID0gTWF0aC5wb3coMiwgOCAqIGJ5dGVMZW5ndGggLSAxKQoKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGJ5dGVMZW5ndGgsIGxpbWl0IC0gMSwgLWxpbWl0KQogIH0KCiAgdmFyIGkgPSAwCiAgdmFyIG11bCA9IDEKICB2YXIgc3ViID0gMAogIHRoaXNbb2Zmc2V0XSA9IHZhbHVlICYgMHhGRgogIHdoaWxlICgrK2kgPCBieXRlTGVuZ3RoICYmIChtdWwgKj0gMHgxMDApKSB7CiAgICBpZiAodmFsdWUgPCAwICYmIHN1YiA9PT0gMCAmJiB0aGlzW29mZnNldCArIGkgLSAxXSAhPT0gMCkgewogICAgICBzdWIgPSAxCiAgICB9CiAgICB0aGlzW29mZnNldCArIGldID0gKCh2YWx1ZSAvIG11bCkgPj4gMCkgLSBzdWIgJiAweEZGCiAgfQoKICByZXR1cm4gb2Zmc2V0ICsgYnl0ZUxlbmd0aAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50QkUgPSBmdW5jdGlvbiB3cml0ZUludEJFICh2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIHsKICAgIHZhciBsaW1pdCA9IE1hdGgucG93KDIsIDggKiBieXRlTGVuZ3RoIC0gMSkKCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBieXRlTGVuZ3RoLCBsaW1pdCAtIDEsIC1saW1pdCkKICB9CgogIHZhciBpID0gYnl0ZUxlbmd0aCAtIDEKICB2YXIgbXVsID0gMQogIHZhciBzdWIgPSAwCiAgdGhpc1tvZmZzZXQgKyBpXSA9IHZhbHVlICYgMHhGRgogIHdoaWxlICgtLWkgPj0gMCAmJiAobXVsICo9IDB4MTAwKSkgewogICAgaWYgKHZhbHVlIDwgMCAmJiBzdWIgPT09IDAgJiYgdGhpc1tvZmZzZXQgKyBpICsgMV0gIT09IDApIHsKICAgICAgc3ViID0gMQogICAgfQogICAgdGhpc1tvZmZzZXQgKyBpXSA9ICgodmFsdWUgLyBtdWwpID4+IDApIC0gc3ViICYgMHhGRgogIH0KCiAgcmV0dXJuIG9mZnNldCArIGJ5dGVMZW5ndGgKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDggPSBmdW5jdGlvbiB3cml0ZUludDggKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMSwgMHg3ZiwgLTB4ODApCiAgaWYgKCFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgdmFsdWUgPSBNYXRoLmZsb29yKHZhbHVlKQogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZiArIHZhbHVlICsgMQogIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSAmIDB4ZmYpCiAgcmV0dXJuIG9mZnNldCArIDEKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2TEUgPSBmdW5jdGlvbiB3cml0ZUludDE2TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlICYgMHhmZikKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgfQogIHJldHVybiBvZmZzZXQgKyAyCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkJFID0gZnVuY3Rpb24gd3JpdGVJbnQxNkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDIsIDB4N2ZmZiwgLTB4ODAwMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgJiAweGZmKQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQxNih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDIKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyTEUgPSBmdW5jdGlvbiB3cml0ZUludDMyTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgfCAwCiAgaWYgKCFub0Fzc2VydCkgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHg3ZmZmZmZmZiwgLTB4ODAwMDAwMDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgJiAweGZmKQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgMl0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAzXSA9ICh2YWx1ZSA+Pj4gMjQpCiAgfSBlbHNlIHsKICAgIG9iamVjdFdyaXRlVUludDMyKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgfQogIHJldHVybiBvZmZzZXQgKyA0Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQzMkJFID0gZnVuY3Rpb24gd3JpdGVJbnQzMkJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0IHwgMAogIGlmICghbm9Bc3NlcnQpIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgJiAweGZmKQogIH0gZWxzZSB7CiAgICBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICB9CiAgcmV0dXJuIG9mZnNldCArIDQKfQoKZnVuY3Rpb24gY2hlY2tJRUVFNzU0IChidWYsIHZhbHVlLCBvZmZzZXQsIGV4dCwgbWF4LCBtaW4pIHsKICBpZiAob2Zmc2V0ICsgZXh0ID4gYnVmLmxlbmd0aCkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ0luZGV4IG91dCBvZiByYW5nZScpCiAgaWYgKG9mZnNldCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdJbmRleCBvdXQgb2YgcmFuZ2UnKQp9CgpmdW5jdGlvbiB3cml0ZUZsb2F0IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KSB7CiAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA0LCAzLjQwMjgyMzQ2NjM4NTI4ODZlKzM4LCAtMy40MDI4MjM0NjYzODUyODg2ZSszOCkKICB9CiAgaWVlZTc1NC53cml0ZShidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbiwgMjMsIDQpCiAgcmV0dXJuIG9mZnNldCArIDQKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUZsb2F0TEUgPSBmdW5jdGlvbiB3cml0ZUZsb2F0TEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgcmV0dXJuIHdyaXRlRmxvYXQodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSwgbm9Bc3NlcnQpCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVGbG9hdEJFID0gZnVuY3Rpb24gd3JpdGVGbG9hdEJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKfQoKZnVuY3Rpb24gd3JpdGVEb3VibGUgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpIHsKICAgIGNoZWNrSUVFRTc1NChidWYsIHZhbHVlLCBvZmZzZXQsIDgsIDEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4LCAtMS43OTc2OTMxMzQ4NjIzMTU3RSszMDgpCiAgfQogIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDUyLCA4KQogIHJldHVybiBvZmZzZXQgKyA4Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVMRSA9IGZ1bmN0aW9uIHdyaXRlRG91YmxlTEUgKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRG91YmxlQkUgPSBmdW5jdGlvbiB3cml0ZURvdWJsZUJFICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSwgbm9Bc3NlcnQpCn0KCi8vIGNvcHkodGFyZ2V0QnVmZmVyLCB0YXJnZXRTdGFydD0wLCBzb3VyY2VTdGFydD0wLCBzb3VyY2VFbmQ9YnVmZmVyLmxlbmd0aCkKQnVmZmVyLnByb3RvdHlwZS5jb3B5ID0gZnVuY3Rpb24gY29weSAodGFyZ2V0LCB0YXJnZXRTdGFydCwgc3RhcnQsIGVuZCkgewogIGlmICghc3RhcnQpIHN0YXJ0ID0gMAogIGlmICghZW5kICYmIGVuZCAhPT0gMCkgZW5kID0gdGhpcy5sZW5ndGgKICBpZiAodGFyZ2V0U3RhcnQgPj0gdGFyZ2V0Lmxlbmd0aCkgdGFyZ2V0U3RhcnQgPSB0YXJnZXQubGVuZ3RoCiAgaWYgKCF0YXJnZXRTdGFydCkgdGFyZ2V0U3RhcnQgPSAwCiAgaWYgKGVuZCA+IDAgJiYgZW5kIDwgc3RhcnQpIGVuZCA9IHN0YXJ0CgogIC8vIENvcHkgMCBieXRlczsgd2UncmUgZG9uZQogIGlmIChlbmQgPT09IHN0YXJ0KSByZXR1cm4gMAogIGlmICh0YXJnZXQubGVuZ3RoID09PSAwIHx8IHRoaXMubGVuZ3RoID09PSAwKSByZXR1cm4gMAoKICAvLyBGYXRhbCBlcnJvciBjb25kaXRpb25zCiAgaWYgKHRhcmdldFN0YXJ0IDwgMCkgewogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ3RhcmdldFN0YXJ0IG91dCBvZiBib3VuZHMnKQogIH0KICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHRoaXMubGVuZ3RoKSB0aHJvdyBuZXcgUmFuZ2VFcnJvcignc291cmNlU3RhcnQgb3V0IG9mIGJvdW5kcycpCiAgaWYgKGVuZCA8IDApIHRocm93IG5ldyBSYW5nZUVycm9yKCdzb3VyY2VFbmQgb3V0IG9mIGJvdW5kcycpCgogIC8vIEFyZSB3ZSBvb2I/CiAgaWYgKGVuZCA+IHRoaXMubGVuZ3RoKSBlbmQgPSB0aGlzLmxlbmd0aAogIGlmICh0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0U3RhcnQgPCBlbmQgLSBzdGFydCkgewogICAgZW5kID0gdGFyZ2V0Lmxlbmd0aCAtIHRhcmdldFN0YXJ0ICsgc3RhcnQKICB9CgogIHZhciBsZW4gPSBlbmQgLSBzdGFydAogIHZhciBpCgogIGlmICh0aGlzID09PSB0YXJnZXQgJiYgc3RhcnQgPCB0YXJnZXRTdGFydCAmJiB0YXJnZXRTdGFydCA8IGVuZCkgewogICAgLy8gZGVzY2VuZGluZyBjb3B5IGZyb20gZW5kCiAgICBmb3IgKGkgPSBsZW4gLSAxOyBpID49IDA7IC0taSkgewogICAgICB0YXJnZXRbaSArIHRhcmdldFN0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgfQogIH0gZWxzZSBpZiAobGVuIDwgMTAwMCB8fCAhQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIC8vIGFzY2VuZGluZyBjb3B5IGZyb20gc3RhcnQKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICB0YXJnZXRbaSArIHRhcmdldFN0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgfQogIH0gZWxzZSB7CiAgICBVaW50OEFycmF5LnByb3RvdHlwZS5zZXQuY2FsbCgKICAgICAgdGFyZ2V0LAogICAgICB0aGlzLnN1YmFycmF5KHN0YXJ0LCBzdGFydCArIGxlbiksCiAgICAgIHRhcmdldFN0YXJ0CiAgICApCiAgfQoKICByZXR1cm4gbGVuCn0KCi8vIFVzYWdlOgovLyAgICBidWZmZXIuZmlsbChudW1iZXJbLCBvZmZzZXRbLCBlbmRdXSkKLy8gICAgYnVmZmVyLmZpbGwoYnVmZmVyWywgb2Zmc2V0WywgZW5kXV0pCi8vICAgIGJ1ZmZlci5maWxsKHN0cmluZ1ssIG9mZnNldFssIGVuZF1dWywgZW5jb2RpbmddKQpCdWZmZXIucHJvdG90eXBlLmZpbGwgPSBmdW5jdGlvbiBmaWxsICh2YWwsIHN0YXJ0LCBlbmQsIGVuY29kaW5nKSB7CiAgLy8gSGFuZGxlIHN0cmluZyBjYXNlczoKICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gc3RhcnQKICAgICAgc3RhcnQgPSAwCiAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmQgPT09ICdzdHJpbmcnKSB7CiAgICAgIGVuY29kaW5nID0gZW5kCiAgICAgIGVuZCA9IHRoaXMubGVuZ3RoCiAgICB9CiAgICBpZiAodmFsLmxlbmd0aCA9PT0gMSkgewogICAgICB2YXIgY29kZSA9IHZhbC5jaGFyQ29kZUF0KDApCiAgICAgIGlmIChjb2RlIDwgMjU2KSB7CiAgICAgICAgdmFsID0gY29kZQogICAgICB9CiAgICB9CiAgICBpZiAoZW5jb2RpbmcgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgZW5jb2RpbmcgIT09ICdzdHJpbmcnKSB7CiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2VuY29kaW5nIG11c3QgYmUgYSBzdHJpbmcnKQogICAgfQogICAgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ3N0cmluZycgJiYgIUJ1ZmZlci5pc0VuY29kaW5nKGVuY29kaW5nKSkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICB9CiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnbnVtYmVyJykgewogICAgdmFsID0gdmFsICYgMjU1CiAgfQoKICAvLyBJbnZhbGlkIHJhbmdlcyBhcmUgbm90IHNldCB0byBhIGRlZmF1bHQsIHNvIGNhbiByYW5nZSBjaGVjayBlYXJseS4KICBpZiAoc3RhcnQgPCAwIHx8IHRoaXMubGVuZ3RoIDwgc3RhcnQgfHwgdGhpcy5sZW5ndGggPCBlbmQpIHsKICAgIHRocm93IG5ldyBSYW5nZUVycm9yKCdPdXQgb2YgcmFuZ2UgaW5kZXgnKQogIH0KCiAgaWYgKGVuZCA8PSBzdGFydCkgewogICAgcmV0dXJuIHRoaXMKICB9CgogIHN0YXJ0ID0gc3RhcnQgPj4+IDAKICBlbmQgPSBlbmQgPT09IHVuZGVmaW5lZCA/IHRoaXMubGVuZ3RoIDogZW5kID4+PiAwCgogIGlmICghdmFsKSB2YWwgPSAwCgogIHZhciBpCiAgaWYgKHR5cGVvZiB2YWwgPT09ICdudW1iZXInKSB7CiAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgKytpKSB7CiAgICAgIHRoaXNbaV0gPSB2YWwKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGJ5dGVzID0gQnVmZmVyLmlzQnVmZmVyKHZhbCkKICAgICAgPyB2YWwKICAgICAgOiB1dGY4VG9CeXRlcyhuZXcgQnVmZmVyKHZhbCwgZW5jb2RpbmcpLnRvU3RyaW5nKCkpCiAgICB2YXIgbGVuID0gYnl0ZXMubGVuZ3RoCiAgICBmb3IgKGkgPSAwOyBpIDwgZW5kIC0gc3RhcnQ7ICsraSkgewogICAgICB0aGlzW2kgKyBzdGFydF0gPSBieXRlc1tpICUgbGVuXQogICAgfQogIH0KCiAgcmV0dXJuIHRoaXMKfQoKLy8gSEVMUEVSIEZVTkNUSU9OUwovLyA9PT09PT09PT09PT09PT09Cgp2YXIgSU5WQUxJRF9CQVNFNjRfUkUgPSAvW14rXC8wLTlBLVphLXotX10vZwoKZnVuY3Rpb24gYmFzZTY0Y2xlYW4gKHN0cikgewogIC8vIE5vZGUgc3RyaXBzIG91dCBpbnZhbGlkIGNoYXJhY3RlcnMgbGlrZSBcbiBhbmQgXHQgZnJvbSB0aGUgc3RyaW5nLCBiYXNlNjQtanMgZG9lcyBub3QKICBzdHIgPSBzdHJpbmd0cmltKHN0cikucmVwbGFjZShJTlZBTElEX0JBU0U2NF9SRSwgJycpCiAgLy8gTm9kZSBjb252ZXJ0cyBzdHJpbmdzIHdpdGggbGVuZ3RoIDwgMiB0byAnJwogIGlmIChzdHIubGVuZ3RoIDwgMikgcmV0dXJuICcnCiAgLy8gTm9kZSBhbGxvd3MgZm9yIG5vbi1wYWRkZWQgYmFzZTY0IHN0cmluZ3MgKG1pc3NpbmcgdHJhaWxpbmcgPT09KSwgYmFzZTY0LWpzIGRvZXMgbm90CiAgd2hpbGUgKHN0ci5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICBzdHIgPSBzdHIgKyAnPScKICB9CiAgcmV0dXJuIHN0cgp9CgpmdW5jdGlvbiBzdHJpbmd0cmltIChzdHIpIHsKICBpZiAoc3RyLnRyaW0pIHJldHVybiBzdHIudHJpbSgpCiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCn0KCmZ1bmN0aW9uIHRvSGV4IChuKSB7CiAgaWYgKG4gPCAxNikgcmV0dXJuICcwJyArIG4udG9TdHJpbmcoMTYpCiAgcmV0dXJuIG4udG9TdHJpbmcoMTYpCn0KCmZ1bmN0aW9uIHV0ZjhUb0J5dGVzIChzdHJpbmcsIHVuaXRzKSB7CiAgdW5pdHMgPSB1bml0cyB8fCBJbmZpbml0eQogIHZhciBjb2RlUG9pbnQKICB2YXIgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aAogIHZhciBsZWFkU3Vycm9nYXRlID0gbnVsbAogIHZhciBieXRlcyA9IFtdCgogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgIGNvZGVQb2ludCA9IHN0cmluZy5jaGFyQ29kZUF0KGkpCgogICAgLy8gaXMgc3Vycm9nYXRlIGNvbXBvbmVudAogICAgaWYgKGNvZGVQb2ludCA+IDB4RDdGRiAmJiBjb2RlUG9pbnQgPCAweEUwMDApIHsKICAgICAgLy8gbGFzdCBjaGFyIHdhcyBhIGxlYWQKICAgICAgaWYgKCFsZWFkU3Vycm9nYXRlKSB7CiAgICAgICAgLy8gbm8gbGVhZCB5ZXQKICAgICAgICBpZiAoY29kZVBvaW50ID4gMHhEQkZGKSB7CiAgICAgICAgICAvLyB1bmV4cGVjdGVkIHRyYWlsCiAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfSBlbHNlIGlmIChpICsgMSA9PT0gbGVuZ3RoKSB7CiAgICAgICAgICAvLyB1bnBhaXJlZCBsZWFkCiAgICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICAvLyB2YWxpZCBsZWFkCiAgICAgICAgbGVhZFN1cnJvZ2F0ZSA9IGNvZGVQb2ludAoKICAgICAgICBjb250aW51ZQogICAgICB9CgogICAgICAvLyAyIGxlYWRzIGluIGEgcm93CiAgICAgIGlmIChjb2RlUG9pbnQgPCAweERDMDApIHsKICAgICAgICBpZiAoKHVuaXRzIC09IDMpID4gLTEpIGJ5dGVzLnB1c2goMHhFRiwgMHhCRiwgMHhCRCkKICAgICAgICBsZWFkU3Vycm9nYXRlID0gY29kZVBvaW50CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgLy8gdmFsaWQgc3Vycm9nYXRlIHBhaXIKICAgICAgY29kZVBvaW50ID0gKGxlYWRTdXJyb2dhdGUgLSAweEQ4MDAgPDwgMTAgfCBjb2RlUG9pbnQgLSAweERDMDApICsgMHgxMDAwMAogICAgfSBlbHNlIGlmIChsZWFkU3Vycm9nYXRlKSB7CiAgICAgIC8vIHZhbGlkIGJtcCBjaGFyLCBidXQgbGFzdCBjaGFyIHdhcyBhIGxlYWQKICAgICAgaWYgKCh1bml0cyAtPSAzKSA+IC0xKSBieXRlcy5wdXNoKDB4RUYsIDB4QkYsIDB4QkQpCiAgICB9CgogICAgbGVhZFN1cnJvZ2F0ZSA9IG51bGwKCiAgICAvLyBlbmNvZGUgdXRmOAogICAgaWYgKGNvZGVQb2ludCA8IDB4ODApIHsKICAgICAgaWYgKCh1bml0cyAtPSAxKSA8IDApIGJyZWFrCiAgICAgIGJ5dGVzLnB1c2goY29kZVBvaW50KQogICAgfSBlbHNlIGlmIChjb2RlUG9pbnQgPCAweDgwMCkgewogICAgICBpZiAoKHVuaXRzIC09IDIpIDwgMCkgYnJlYWsKICAgICAgYnl0ZXMucHVzaCgKICAgICAgICBjb2RlUG9pbnQgPj4gMHg2IHwgMHhDMCwKICAgICAgICBjb2RlUG9pbnQgJiAweDNGIHwgMHg4MAogICAgICApCiAgICB9IGVsc2UgaWYgKGNvZGVQb2ludCA8IDB4MTAwMDApIHsKICAgICAgaWYgKCh1bml0cyAtPSAzKSA8IDApIGJyZWFrCiAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgY29kZVBvaW50ID4+IDB4QyB8IDB4RTAsCiAgICAgICAgY29kZVBvaW50ID4+IDB4NiAmIDB4M0YgfCAweDgwLAogICAgICAgIGNvZGVQb2ludCAmIDB4M0YgfCAweDgwCiAgICAgICkKICAgIH0gZWxzZSBpZiAoY29kZVBvaW50IDwgMHgxMTAwMDApIHsKICAgICAgaWYgKCh1bml0cyAtPSA0KSA8IDApIGJyZWFrCiAgICAgIGJ5dGVzLnB1c2goCiAgICAgICAgY29kZVBvaW50ID4+IDB4MTIgfCAweEYwLAogICAgICAgIGNvZGVQb2ludCA+PiAweEMgJiAweDNGIHwgMHg4MCwKICAgICAgICBjb2RlUG9pbnQgPj4gMHg2ICYgMHgzRiB8IDB4ODAsCiAgICAgICAgY29kZVBvaW50ICYgMHgzRiB8IDB4ODAKICAgICAgKQogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNvZGUgcG9pbnQnKQogICAgfQogIH0KCiAgcmV0dXJuIGJ5dGVzCn0KCmZ1bmN0aW9uIGFzY2lpVG9CeXRlcyAoc3RyKSB7CiAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyArK2kpIHsKICAgIC8vIE5vZGUncyBjb2RlIHNlZW1zIHRvIGJlIGRvaW5nIHRoaXMgYW5kIG5vdCAmIDB4N0YuLgogICAgYnl0ZUFycmF5LnB1c2goc3RyLmNoYXJDb2RlQXQoaSkgJiAweEZGKQogIH0KICByZXR1cm4gYnl0ZUFycmF5Cn0KCmZ1bmN0aW9uIHV0ZjE2bGVUb0J5dGVzIChzdHIsIHVuaXRzKSB7CiAgdmFyIGMsIGhpLCBsbwogIHZhciBieXRlQXJyYXkgPSBbXQogIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKSB7CiAgICBpZiAoKHVuaXRzIC09IDIpIDwgMCkgYnJlYWsKCiAgICBjID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgIGhpID0gYyA+PiA4CiAgICBsbyA9IGMgJSAyNTYKICAgIGJ5dGVBcnJheS5wdXNoKGxvKQogICAgYnl0ZUFycmF5LnB1c2goaGkpCiAgfQoKICByZXR1cm4gYnl0ZUFycmF5Cn0KCmZ1bmN0aW9uIGJhc2U2NFRvQnl0ZXMgKHN0cikgewogIHJldHVybiBiYXNlNjQudG9CeXRlQXJyYXkoYmFzZTY0Y2xlYW4oc3RyKSkKfQoKZnVuY3Rpb24gYmxpdEJ1ZmZlciAoc3JjLCBkc3QsIG9mZnNldCwgbGVuZ3RoKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgaWYgKChpICsgb2Zmc2V0ID49IGRzdC5sZW5ndGgpIHx8IChpID49IHNyYy5sZW5ndGgpKSBicmVhawogICAgZHN0W2kgKyBvZmZzZXRdID0gc3JjW2ldCiAgfQogIHJldHVybiBpCn0KCmZ1bmN0aW9uIGlzbmFuICh2YWwpIHsKICByZXR1cm4gdmFsICE9PSB2YWwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1zZWxmLWNvbXBhcmUKfQoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyx0eXBlb2YgX193ZWJwYWNrX3JlcXVpcmVfXy5nICE9PSAidW5kZWZpbmVkIiA/IF9fd2VicGFja19yZXF1aXJlX18uZyA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9LHJlcXVpcmUoImJ1ZmZlciIpLkJ1ZmZlcikKfSx7ImJhc2U2NC1qcyI6NzksImJ1ZmZlciI6ODQsImllZWU3NTQiOjg2LCJpc2FycmF5Ijo4N31dLDg1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewogIHRoaXMuX2V2ZW50cyA9IHRoaXMuX2V2ZW50cyB8fCB7fTsKICB0aGlzLl9tYXhMaXN0ZW5lcnMgPSB0aGlzLl9tYXhMaXN0ZW5lcnMgfHwgdW5kZWZpbmVkOwp9Cm1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyOwoKLy8gQmFja3dhcmRzLWNvbXBhdCB3aXRoIG5vZGUgMC4xMC54CkV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLl9ldmVudHMgPSB1bmRlZmluZWQ7CkV2ZW50RW1pdHRlci5wcm90b3R5cGUuX21heExpc3RlbmVycyA9IHVuZGVmaW5lZDsKCi8vIEJ5IGRlZmF1bHQgRXZlbnRFbWl0dGVycyB3aWxsIHByaW50IGEgd2FybmluZyBpZiBtb3JlIHRoYW4gMTAgbGlzdGVuZXJzIGFyZQovLyBhZGRlZCB0byBpdC4gVGhpcyBpcyBhIHVzZWZ1bCBkZWZhdWx0IHdoaWNoIGhlbHBzIGZpbmRpbmcgbWVtb3J5IGxlYWtzLgpFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVycyA9IDEwOwoKLy8gT2J2aW91c2x5IG5vdCBhbGwgRW1pdHRlcnMgc2hvdWxkIGJlIGxpbWl0ZWQgdG8gMTAuIFRoaXMgZnVuY3Rpb24gYWxsb3dzCi8vIHRoYXQgdG8gYmUgaW5jcmVhc2VkLiBTZXQgdG8gemVybyBmb3IgdW5saW1pdGVkLgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLnNldE1heExpc3RlbmVycyA9IGZ1bmN0aW9uKG4pIHsKICBpZiAoIWlzTnVtYmVyKG4pIHx8IG4gPCAwIHx8IGlzTmFOKG4pKQogICAgdGhyb3cgVHlwZUVycm9yKCduIG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXInKTsKICB0aGlzLl9tYXhMaXN0ZW5lcnMgPSBuOwogIHJldHVybiB0aGlzOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24odHlwZSkgewogIHZhciBlciwgaGFuZGxlciwgbGVuLCBhcmdzLCBpLCBsaXN0ZW5lcnM7CgogIGlmICghdGhpcy5fZXZlbnRzKQogICAgdGhpcy5fZXZlbnRzID0ge307CgogIC8vIElmIHRoZXJlIGlzIG5vICdlcnJvcicgZXZlbnQgbGlzdGVuZXIgdGhlbiB0aHJvdy4KICBpZiAodHlwZSA9PT0gJ2Vycm9yJykgewogICAgaWYgKCF0aGlzLl9ldmVudHMuZXJyb3IgfHwKICAgICAgICAoaXNPYmplY3QodGhpcy5fZXZlbnRzLmVycm9yKSAmJiAhdGhpcy5fZXZlbnRzLmVycm9yLmxlbmd0aCkpIHsKICAgICAgZXIgPSBhcmd1bWVudHNbMV07CiAgICAgIGlmIChlciBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgdGhyb3cgZXI7IC8vIFVuaGFuZGxlZCAnZXJyb3InIGV2ZW50CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQXQgbGVhc3QgZ2l2ZSBzb21lIGtpbmQgb2YgY29udGV4dCB0byB0aGUgdXNlcgogICAgICAgIHZhciBlcnIgPSBuZXcgRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LiAoJyArIGVyICsgJyknKTsKICAgICAgICBlcnIuY29udGV4dCA9IGVyOwogICAgICAgIHRocm93IGVycjsKICAgICAgfQogICAgfQogIH0KCiAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKCiAgaWYgKGlzVW5kZWZpbmVkKGhhbmRsZXIpKQogICAgcmV0dXJuIGZhbHNlOwoKICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewogICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIC8vIGZhc3QgY2FzZXMKICAgICAgY2FzZSAxOgogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgLy8gc2xvd2VyCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgaGFuZGxlci5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9IGVsc2UgaWYgKGlzT2JqZWN0KGhhbmRsZXIpKSB7CiAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIGxpc3RlbmVycyA9IGhhbmRsZXIuc2xpY2UoKTsKICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICB9CgogIHJldHVybiB0cnVlOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgdmFyIG07CgogIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICBpZiAoIXRoaXMuX2V2ZW50cykKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoKICAvLyBUbyBhdm9pZCByZWN1cnNpb24gaW4gdGhlIGNhc2UgdGhhdCB0eXBlID09PSAibmV3TGlzdGVuZXIiISBCZWZvcmUKICAvLyBhZGRpbmcgaXQgdG8gdGhlIGxpc3RlbmVycywgZmlyc3QgZW1pdCAibmV3TGlzdGVuZXIiLgogIGlmICh0aGlzLl9ldmVudHMubmV3TGlzdGVuZXIpCiAgICB0aGlzLmVtaXQoJ25ld0xpc3RlbmVyJywgdHlwZSwKICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGxpc3RlbmVyLmxpc3RlbmVyKSA/CiAgICAgICAgICAgICAgbGlzdGVuZXIubGlzdGVuZXIgOiBsaXN0ZW5lcik7CgogIGlmICghdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuCiAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBsaXN0ZW5lcjsKICBlbHNlIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLgogICAgdGhpcy5fZXZlbnRzW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogIGVsc2UKICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5LgogICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gW3RoaXMuX2V2ZW50c1t0eXBlXSwgbGlzdGVuZXJdOwoKICAvLyBDaGVjayBmb3IgbGlzdGVuZXIgbGVhawogIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CiAgICBpZiAoIWlzVW5kZWZpbmVkKHRoaXMuX21heExpc3RlbmVycykpIHsKICAgICAgbSA9IHRoaXMuX21heExpc3RlbmVyczsKICAgIH0gZWxzZSB7CiAgICAgIG0gPSBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVyczsKICAgIH0KCiAgICBpZiAobSAmJiBtID4gMCAmJiB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoID4gbSkgewogICAgICB0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkID0gdHJ1ZTsKICAgICAgY29uc29sZS5lcnJvcignKG5vZGUpIHdhcm5pbmc6IHBvc3NpYmxlIEV2ZW50RW1pdHRlciBtZW1vcnkgJyArCiAgICAgICAgICAgICAgICAgICAgJ2xlYWsgZGV0ZWN0ZWQuICVkIGxpc3RlbmVycyBhZGRlZC4gJyArCiAgICAgICAgICAgICAgICAgICAgJ1VzZSBlbWl0dGVyLnNldE1heExpc3RlbmVycygpIHRvIGluY3JlYXNlIGxpbWl0LicsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCk7CiAgICAgIGlmICh0eXBlb2YgY29uc29sZS50cmFjZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIC8vIG5vdCBzdXBwb3J0ZWQgaW4gSUUgMTAKICAgICAgICBjb25zb2xlLnRyYWNlKCk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiB0aGlzOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IEV2ZW50RW1pdHRlci5wcm90b3R5cGUuYWRkTGlzdGVuZXI7CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICB2YXIgZmlyZWQgPSBmYWxzZTsKCiAgZnVuY3Rpb24gZygpIHsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgZyk7CgogICAgaWYgKCFmaXJlZCkgewogICAgICBmaXJlZCA9IHRydWU7CiAgICAgIGxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQoKICBnLmxpc3RlbmVyID0gbGlzdGVuZXI7CiAgdGhpcy5vbih0eXBlLCBnKTsKCiAgcmV0dXJuIHRoaXM7Cn07CgovLyBlbWl0cyBhICdyZW1vdmVMaXN0ZW5lcicgZXZlbnQgaWZmIHRoZSBsaXN0ZW5lciB3YXMgcmVtb3ZlZApFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKICB2YXIgbGlzdCwgcG9zaXRpb24sIGxlbmd0aCwgaTsKCiAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogIGlmICghdGhpcy5fZXZlbnRzIHx8ICF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICByZXR1cm4gdGhpczsKCiAgbGlzdCA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICBsZW5ndGggPSBsaXN0Lmxlbmd0aDsKICBwb3NpdGlvbiA9IC0xOwoKICBpZiAobGlzdCA9PT0gbGlzdGVuZXIgfHwKICAgICAgKGlzRnVuY3Rpb24obGlzdC5saXN0ZW5lcikgJiYgbGlzdC5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikKICAgICAgdGhpcy5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIHR5cGUsIGxpc3RlbmVyKTsKCiAgfSBlbHNlIGlmIChpc09iamVjdChsaXN0KSkgewogICAgZm9yIChpID0gbGVuZ3RoOyBpLS0gPiAwOykgewogICAgICBpZiAobGlzdFtpXSA9PT0gbGlzdGVuZXIgfHwKICAgICAgICAgIChsaXN0W2ldLmxpc3RlbmVyICYmIGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewogICAgICAgIHBvc2l0aW9uID0gaTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmIChwb3NpdGlvbiA8IDApCiAgICAgIHJldHVybiB0aGlzOwoKICAgIGlmIChsaXN0Lmxlbmd0aCA9PT0gMSkgewogICAgICBsaXN0Lmxlbmd0aCA9IDA7CiAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICB9IGVsc2UgewogICAgICBsaXN0LnNwbGljZShwb3NpdGlvbiwgMSk7CiAgICB9CgogICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikKICAgICAgdGhpcy5lbWl0KCdyZW1vdmVMaXN0ZW5lcicsIHR5cGUsIGxpc3RlbmVyKTsKICB9CgogIHJldHVybiB0aGlzOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIGtleSwgbGlzdGVuZXJzOwoKICBpZiAoIXRoaXMuX2V2ZW50cykKICAgIHJldHVybiB0aGlzOwoKICAvLyBub3QgbGlzdGVuaW5nIGZvciByZW1vdmVMaXN0ZW5lciwgbm8gbmVlZCB0byBlbWl0CiAgaWYgKCF0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKQogICAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIGVsc2UgaWYgKHRoaXMuX2V2ZW50c1t0eXBlXSkKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLy8gZW1pdCByZW1vdmVMaXN0ZW5lciBmb3IgYWxsIGxpc3RlbmVycyBvbiBhbGwgZXZlbnRzCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgIGZvciAoa2V5IGluIHRoaXMuX2V2ZW50cykgewogICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZTsKICAgICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoa2V5KTsKICAgIH0KICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdyZW1vdmVMaXN0ZW5lcicpOwogICAgdGhpcy5fZXZlbnRzID0ge307CiAgICByZXR1cm4gdGhpczsKICB9CgogIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKCiAgaWYgKGlzRnVuY3Rpb24obGlzdGVuZXJzKSkgewogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnMpOwogIH0gZWxzZSBpZiAobGlzdGVuZXJzKSB7CiAgICAvLyBMSUZPIG9yZGVyCiAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCkKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnNbbGlzdGVuZXJzLmxlbmd0aCAtIDFdKTsKICB9CiAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKCiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICB2YXIgcmV0OwogIGlmICghdGhpcy5fZXZlbnRzIHx8ICF0aGlzLl9ldmVudHNbdHlwZV0pCiAgICByZXQgPSBbXTsKICBlbHNlIGlmIChpc0Z1bmN0aW9uKHRoaXMuX2V2ZW50c1t0eXBlXSkpCiAgICByZXQgPSBbdGhpcy5fZXZlbnRzW3R5cGVdXTsKICBlbHNlCiAgICByZXQgPSB0aGlzLl9ldmVudHNbdHlwZV0uc2xpY2UoKTsKICByZXR1cm4gcmV0Owp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24odHlwZSkgewogIGlmICh0aGlzLl9ldmVudHMpIHsKICAgIHZhciBldmxpc3RlbmVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwoKICAgIGlmIChpc0Z1bmN0aW9uKGV2bGlzdGVuZXIpKQogICAgICByZXR1cm4gMTsKICAgIGVsc2UgaWYgKGV2bGlzdGVuZXIpCiAgICAgIHJldHVybiBldmxpc3RlbmVyLmxlbmd0aDsKICB9CiAgcmV0dXJuIDA7Cn07CgpFdmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKGVtaXR0ZXIsIHR5cGUpIHsKICByZXR1cm4gZW1pdHRlci5saXN0ZW5lckNvdW50KHR5cGUpOwp9OwoKZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKfQoKZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwp9CgpmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwp9CgpmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gYXJnID09PSB2b2lkIDA7Cn0KCn0se31dLDg2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKZXhwb3J0cy5yZWFkID0gZnVuY3Rpb24gKGJ1ZmZlciwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICB2YXIgZSwgbQogIHZhciBlTGVuID0gKG5CeXRlcyAqIDgpIC0gbUxlbiAtIDEKICB2YXIgZU1heCA9ICgxIDw8IGVMZW4pIC0gMQogIHZhciBlQmlhcyA9IGVNYXggPj4gMQogIHZhciBuQml0cyA9IC03CiAgdmFyIGkgPSBpc0xFID8gKG5CeXRlcyAtIDEpIDogMAogIHZhciBkID0gaXNMRSA/IC0xIDogMQogIHZhciBzID0gYnVmZmVyW29mZnNldCArIGldCgogIGkgKz0gZAoKICBlID0gcyAmICgoMSA8PCAoLW5CaXRzKSkgLSAxKQogIHMgPj49ICgtbkJpdHMpCiAgbkJpdHMgKz0gZUxlbgogIGZvciAoOyBuQml0cyA+IDA7IGUgPSAoZSAqIDI1NikgKyBidWZmZXJbb2Zmc2V0ICsgaV0sIGkgKz0gZCwgbkJpdHMgLT0gOCkge30KCiAgbSA9IGUgJiAoKDEgPDwgKC1uQml0cykpIC0gMSkKICBlID4+PSAoLW5CaXRzKQogIG5CaXRzICs9IG1MZW4KICBmb3IgKDsgbkJpdHMgPiAwOyBtID0gKG0gKiAyNTYpICsgYnVmZmVyW29mZnNldCArIGldLCBpICs9IGQsIG5CaXRzIC09IDgpIHt9CgogIGlmIChlID09PSAwKSB7CiAgICBlID0gMSAtIGVCaWFzCiAgfSBlbHNlIGlmIChlID09PSBlTWF4KSB7CiAgICByZXR1cm4gbSA/IE5hTiA6ICgocyA/IC0xIDogMSkgKiBJbmZpbml0eSkKICB9IGVsc2UgewogICAgbSA9IG0gKyBNYXRoLnBvdygyLCBtTGVuKQogICAgZSA9IGUgLSBlQmlhcwogIH0KICByZXR1cm4gKHMgPyAtMSA6IDEpICogbSAqIE1hdGgucG93KDIsIGUgLSBtTGVuKQp9CgpleHBvcnRzLndyaXRlID0gZnVuY3Rpb24gKGJ1ZmZlciwgdmFsdWUsIG9mZnNldCwgaXNMRSwgbUxlbiwgbkJ5dGVzKSB7CiAgdmFyIGUsIG0sIGMKICB2YXIgZUxlbiA9IChuQnl0ZXMgKiA4KSAtIG1MZW4gLSAxCiAgdmFyIGVNYXggPSAoMSA8PCBlTGVuKSAtIDEKICB2YXIgZUJpYXMgPSBlTWF4ID4+IDEKICB2YXIgcnQgPSAobUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDApCiAgdmFyIGkgPSBpc0xFID8gMCA6IChuQnl0ZXMgLSAxKQogIHZhciBkID0gaXNMRSA/IDEgOiAtMQogIHZhciBzID0gdmFsdWUgPCAwIHx8ICh2YWx1ZSA9PT0gMCAmJiAxIC8gdmFsdWUgPCAwKSA/IDEgOiAwCgogIHZhbHVlID0gTWF0aC5hYnModmFsdWUpCgogIGlmIChpc05hTih2YWx1ZSkgfHwgdmFsdWUgPT09IEluZmluaXR5KSB7CiAgICBtID0gaXNOYU4odmFsdWUpID8gMSA6IDAKICAgIGUgPSBlTWF4CiAgfSBlbHNlIHsKICAgIGUgPSBNYXRoLmZsb29yKE1hdGgubG9nKHZhbHVlKSAvIE1hdGguTE4yKQogICAgaWYgKHZhbHVlICogKGMgPSBNYXRoLnBvdygyLCAtZSkpIDwgMSkgewogICAgICBlLS0KICAgICAgYyAqPSAyCiAgICB9CiAgICBpZiAoZSArIGVCaWFzID49IDEpIHsKICAgICAgdmFsdWUgKz0gcnQgLyBjCiAgICB9IGVsc2UgewogICAgICB2YWx1ZSArPSBydCAqIE1hdGgucG93KDIsIDEgLSBlQmlhcykKICAgIH0KICAgIGlmICh2YWx1ZSAqIGMgPj0gMikgewogICAgICBlKysKICAgICAgYyAvPSAyCiAgICB9CgogICAgaWYgKGUgKyBlQmlhcyA+PSBlTWF4KSB7CiAgICAgIG0gPSAwCiAgICAgIGUgPSBlTWF4CiAgICB9IGVsc2UgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgIG0gPSAoKHZhbHVlICogYykgLSAxKSAqIE1hdGgucG93KDIsIG1MZW4pCiAgICAgIGUgPSBlICsgZUJpYXMKICAgIH0gZWxzZSB7CiAgICAgIG0gPSB2YWx1ZSAqIE1hdGgucG93KDIsIGVCaWFzIC0gMSkgKiBNYXRoLnBvdygyLCBtTGVuKQogICAgICBlID0gMAogICAgfQogIH0KCiAgZm9yICg7IG1MZW4gPj0gODsgYnVmZmVyW29mZnNldCArIGldID0gbSAmIDB4ZmYsIGkgKz0gZCwgbSAvPSAyNTYsIG1MZW4gLT0gOCkge30KCiAgZSA9IChlIDw8IG1MZW4pIHwgbQogIGVMZW4gKz0gbUxlbgogIGZvciAoOyBlTGVuID4gMDsgYnVmZmVyW29mZnNldCArIGldID0gZSAmIDB4ZmYsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCkge30KCiAgYnVmZmVyW29mZnNldCArIGkgLSBkXSB8PSBzICogMTI4Cn0KCn0se31dLDg3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHRvU3RyaW5nID0ge30udG9TdHJpbmc7Cgptb2R1bGUuZXhwb3J0cyA9IEFycmF5LmlzQXJyYXkgfHwgZnVuY3Rpb24gKGFycikgewogIHJldHVybiB0b1N0cmluZy5jYWxsKGFycikgPT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCn0se31dLDg4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uKGV4cG9ydHMpIHsKICAidXNlIHN0cmljdCI7CgogIGZ1bmN0aW9uIGlzQXJyYXkob2JqKSB7CiAgICBpZiAob2JqICE9PSBudWxsKSB7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gIltvYmplY3QgQXJyYXldIjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzT2JqZWN0KG9iaikgewogICAgaWYgKG9iaiAhPT0gbnVsbCkgewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICJbb2JqZWN0IE9iamVjdF0iOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gc3RyaWN0RGVlcEVxdWFsKGZpcnN0LCBzZWNvbmQpIHsKICAgIC8vIENoZWNrIHRoZSBzY2FsYXIgY2FzZSBmaXJzdC4KICAgIGlmIChmaXJzdCA9PT0gc2Vjb25kKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8vIENoZWNrIGlmIHRoZXkgYXJlIHRoZSBzYW1lIHR5cGUuCiAgICB2YXIgZmlyc3RUeXBlID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGZpcnN0KTsKICAgIGlmIChmaXJzdFR5cGUgIT09IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChzZWNvbmQpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIC8vIFdlIGtub3cgdGhhdCBmaXJzdCBhbmQgc2Vjb25kIGhhdmUgdGhlIHNhbWUgdHlwZSBzbyB3ZSBjYW4ganVzdCBjaGVjayB0aGUKICAgIC8vIGZpcnN0IHR5cGUgZnJvbSBub3cgb24uCiAgICBpZiAoaXNBcnJheShmaXJzdCkgPT09IHRydWUpIHsKICAgICAgLy8gU2hvcnQgY2lyY3VpdCBpZiB0aGV5J3JlIG5vdCB0aGUgc2FtZSBsZW5ndGg7CiAgICAgIGlmIChmaXJzdC5sZW5ndGggIT09IHNlY29uZC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaXJzdC5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChzdHJpY3REZWVwRXF1YWwoZmlyc3RbaV0sIHNlY29uZFtpXSkgPT09IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKGlzT2JqZWN0KGZpcnN0KSA9PT0gdHJ1ZSkgewogICAgICAvLyBBbiBvYmplY3QgaXMgZXF1YWwgaWYgaXQgaGFzIHRoZSBzYW1lIGtleS92YWx1ZSBwYWlycy4KICAgICAgdmFyIGtleXNTZWVuID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBmaXJzdCkgewogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGZpcnN0LCBrZXkpKSB7CiAgICAgICAgICBpZiAoc3RyaWN0RGVlcEVxdWFsKGZpcnN0W2tleV0sIHNlY29uZFtrZXldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAga2V5c1NlZW5ba2V5XSA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIE5vdyBjaGVjayB0aGF0IHRoZXJlIGFyZW4ndCBhbnkga2V5cyBpbiBzZWNvbmQgdGhhdCB3ZXJlbid0CiAgICAgIC8vIGluIGZpcnN0LgogICAgICBmb3IgKHZhciBrZXkyIGluIHNlY29uZCkgewogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNlY29uZCwga2V5MikpIHsKICAgICAgICAgIGlmIChrZXlzU2VlbltrZXkyXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gaXNGYWxzZShvYmopIHsKICAgIC8vIEZyb20gdGhlIHNwZWM6CiAgICAvLyBBIGZhbHNlIHZhbHVlIGNvcnJlc3BvbmRzIHRvIHRoZSBmb2xsb3dpbmcgdmFsdWVzOgogICAgLy8gRW1wdHkgbGlzdAogICAgLy8gRW1wdHkgb2JqZWN0CiAgICAvLyBFbXB0eSBzdHJpbmcKICAgIC8vIEZhbHNlIGJvb2xlYW4KICAgIC8vIG51bGwgdmFsdWUKCiAgICAvLyBGaXJzdCBjaGVjayB0aGUgc2NhbGFyIHZhbHVlcy4KICAgIGlmIChvYmogPT09ICIiIHx8IG9iaiA9PT0gZmFsc2UgfHwgb2JqID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqKSAmJiBvYmoubGVuZ3RoID09PSAwKSB7CiAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IGFycmF5LgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICAgICAgLy8gQ2hlY2sgZm9yIGFuIGVtcHR5IG9iamVjdC4KICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgICAgICAgIC8vIElmIHRoZXJlIGFyZSBhbnkga2V5cywgdGhlbgogICAgICAgICAgICAvLyB0aGUgb2JqZWN0IGlzIG5vdCBlbXB0eSBzbyB0aGUgb2JqZWN0CiAgICAgICAgICAgIC8vIGlzIG5vdCBmYWxzZS4KICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBvYmpWYWx1ZXMob2JqKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFsdWVzLnB1c2gob2JqW2tleXNbaV1dKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZXM7CiAgfQoKICBmdW5jdGlvbiBtZXJnZShhLCBiKSB7CiAgICAgIHZhciBtZXJnZWQgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIGEpIHsKICAgICAgICAgIG1lcmdlZFtrZXldID0gYVtrZXldOwogICAgICB9CiAgICAgIGZvciAodmFyIGtleTIgaW4gYikgewogICAgICAgICAgbWVyZ2VkW2tleTJdID0gYltrZXkyXTsKICAgICAgfQogICAgICByZXR1cm4gbWVyZ2VkOwogIH0KCiAgdmFyIHRyaW1MZWZ0OwogIGlmICh0eXBlb2YgU3RyaW5nLnByb3RvdHlwZS50cmltTGVmdCA9PT0gImZ1bmN0aW9uIikgewogICAgdHJpbUxlZnQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuIHN0ci50cmltTGVmdCgpOwogICAgfTsKICB9IGVsc2UgewogICAgdHJpbUxlZnQgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgcmV0dXJuIHN0ci5tYXRjaCgvXlxzKiguKikvKVsxXTsKICAgIH07CiAgfQoKICAvLyBUeXBlIGNvbnN0YW50cyB1c2VkIHRvIGRlZmluZSBmdW5jdGlvbnMuCiAgdmFyIFRZUEVfTlVNQkVSID0gMDsKICB2YXIgVFlQRV9BTlkgPSAxOwogIHZhciBUWVBFX1NUUklORyA9IDI7CiAgdmFyIFRZUEVfQVJSQVkgPSAzOwogIHZhciBUWVBFX09CSkVDVCA9IDQ7CiAgdmFyIFRZUEVfQk9PTEVBTiA9IDU7CiAgdmFyIFRZUEVfRVhQUkVGID0gNjsKICB2YXIgVFlQRV9OVUxMID0gNzsKICB2YXIgVFlQRV9BUlJBWV9OVU1CRVIgPSA4OwogIHZhciBUWVBFX0FSUkFZX1NUUklORyA9IDk7CiAgdmFyIFRZUEVfTkFNRV9UQUJMRSA9IHsKICAgIDA6ICdudW1iZXInLAogICAgMTogJ2FueScsCiAgICAyOiAnc3RyaW5nJywKICAgIDM6ICdhcnJheScsCiAgICA0OiAnb2JqZWN0JywKICAgIDU6ICdib29sZWFuJywKICAgIDY6ICdleHByZXNzaW9uJywKICAgIDc6ICdudWxsJywKICAgIDg6ICdBcnJheTxudW1iZXI+JywKICAgIDk6ICdBcnJheTxzdHJpbmc+JwogIH07CgogIHZhciBUT0tfRU9GID0gIkVPRiI7CiAgdmFyIFRPS19VTlFVT1RFRElERU5USUZJRVIgPSAiVW5xdW90ZWRJZGVudGlmaWVyIjsKICB2YXIgVE9LX1FVT1RFRElERU5USUZJRVIgPSAiUXVvdGVkSWRlbnRpZmllciI7CiAgdmFyIFRPS19SQlJBQ0tFVCA9ICJSYnJhY2tldCI7CiAgdmFyIFRPS19SUEFSRU4gPSAiUnBhcmVuIjsKICB2YXIgVE9LX0NPTU1BID0gIkNvbW1hIjsKICB2YXIgVE9LX0NPTE9OID0gIkNvbG9uIjsKICB2YXIgVE9LX1JCUkFDRSA9ICJSYnJhY2UiOwogIHZhciBUT0tfTlVNQkVSID0gIk51bWJlciI7CiAgdmFyIFRPS19DVVJSRU5UID0gIkN1cnJlbnQiOwogIHZhciBUT0tfRVhQUkVGID0gIkV4cHJlZiI7CiAgdmFyIFRPS19QSVBFID0gIlBpcGUiOwogIHZhciBUT0tfT1IgPSAiT3IiOwogIHZhciBUT0tfQU5EID0gIkFuZCI7CiAgdmFyIFRPS19FUSA9ICJFUSI7CiAgdmFyIFRPS19HVCA9ICJHVCI7CiAgdmFyIFRPS19MVCA9ICJMVCI7CiAgdmFyIFRPS19HVEUgPSAiR1RFIjsKICB2YXIgVE9LX0xURSA9ICJMVEUiOwogIHZhciBUT0tfTkUgPSAiTkUiOwogIHZhciBUT0tfRkxBVFRFTiA9ICJGbGF0dGVuIjsKICB2YXIgVE9LX1NUQVIgPSAiU3RhciI7CiAgdmFyIFRPS19GSUxURVIgPSAiRmlsdGVyIjsKICB2YXIgVE9LX0RPVCA9ICJEb3QiOwogIHZhciBUT0tfTk9UID0gIk5vdCI7CiAgdmFyIFRPS19MQlJBQ0UgPSAiTGJyYWNlIjsKICB2YXIgVE9LX0xCUkFDS0VUID0gIkxicmFja2V0IjsKICB2YXIgVE9LX0xQQVJFTj0gIkxwYXJlbiI7CiAgdmFyIFRPS19MSVRFUkFMPSAiTGl0ZXJhbCI7CgogIC8vIFRoZSAiJiIsICJbIiwgIjwiLCAiPiIgdG9rZW5zCiAgLy8gYXJlIG5vdCBpbiBiYXNpY1Rva2VuIGJlY2F1c2UKICAvLyB0aGVyZSBhcmUgdHdvIHRva2VuIHZhcmlhbnRzCiAgLy8gKCImJiIsICJbPyIsICI8PSIsICI+PSIpLiAgVGhpcyBpcyBzcGVjaWFsbHkgaGFuZGxlZAogIC8vIGJlbG93LgoKICB2YXIgYmFzaWNUb2tlbnMgPSB7CiAgICAiLiI6IFRPS19ET1QsCiAgICAiKiI6IFRPS19TVEFSLAogICAgIiwiOiBUT0tfQ09NTUEsCiAgICAiOiI6IFRPS19DT0xPTiwKICAgICJ7IjogVE9LX0xCUkFDRSwKICAgICJ9IjogVE9LX1JCUkFDRSwKICAgICJdIjogVE9LX1JCUkFDS0VULAogICAgIigiOiBUT0tfTFBBUkVOLAogICAgIikiOiBUT0tfUlBBUkVOLAogICAgIkAiOiBUT0tfQ1VSUkVOVAogIH07CgogIHZhciBvcGVyYXRvclN0YXJ0VG9rZW4gPSB7CiAgICAgICI8IjogdHJ1ZSwKICAgICAgIj4iOiB0cnVlLAogICAgICAiPSI6IHRydWUsCiAgICAgICIhIjogdHJ1ZQogIH07CgogIHZhciBza2lwQ2hhcnMgPSB7CiAgICAgICIgIjogdHJ1ZSwKICAgICAgIlx0IjogdHJ1ZSwKICAgICAgIlxuIjogdHJ1ZQogIH07CgoKICBmdW5jdGlvbiBpc0FscGhhKGNoKSB7CiAgICAgIHJldHVybiAoY2ggPj0gImEiICYmIGNoIDw9ICJ6IikgfHwKICAgICAgICAgICAgIChjaCA+PSAiQSIgJiYgY2ggPD0gIloiKSB8fAogICAgICAgICAgICAgY2ggPT09ICJfIjsKICB9CgogIGZ1bmN0aW9uIGlzTnVtKGNoKSB7CiAgICAgIHJldHVybiAoY2ggPj0gIjAiICYmIGNoIDw9ICI5IikgfHwKICAgICAgICAgICAgIGNoID09PSAiLSI7CiAgfQogIGZ1bmN0aW9uIGlzQWxwaGFOdW0oY2gpIHsKICAgICAgcmV0dXJuIChjaCA+PSAiYSIgJiYgY2ggPD0gInoiKSB8fAogICAgICAgICAgICAgKGNoID49ICJBIiAmJiBjaCA8PSAiWiIpIHx8CiAgICAgICAgICAgICAoY2ggPj0gIjAiICYmIGNoIDw9ICI5IikgfHwKICAgICAgICAgICAgIGNoID09PSAiXyI7CiAgfQoKICBmdW5jdGlvbiBMZXhlcigpIHsKICB9CiAgTGV4ZXIucHJvdG90eXBlID0gewogICAgICB0b2tlbml6ZTogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB2YXIgdG9rZW5zID0gW107CiAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gMDsKICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgIHZhciBpZGVudGlmaWVyOwogICAgICAgICAgdmFyIHRva2VuOwogICAgICAgICAgd2hpbGUgKHRoaXMuX2N1cnJlbnQgPCBzdHJlYW0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaWYgKGlzQWxwaGEoc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lVW5xdW90ZWRJZGVudGlmaWVyKHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBUT0tfVU5RVU9URURJREVOVElGSUVSLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGJhc2ljVG9rZW5zW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogYmFzaWNUb2tlbnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN0cmVhbVt0aGlzLl9jdXJyZW50XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHRoaXMuX2N1cnJlbnR9KTsKICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOdW0oc3RyZWFtW3RoaXMuX2N1cnJlbnRdKSkgewogICAgICAgICAgICAgICAgICB0b2tlbiA9IHRoaXMuX2NvbnN1bWVOdW1iZXIoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiWyIpIHsKICAgICAgICAgICAgICAgICAgLy8gTm8gbmVlZCB0byBpbmNyZW1lbnQgdGhpcy5fY3VycmVudC4gIFRoaXMgaGFwcGVucwogICAgICAgICAgICAgICAgICAvLyBpbiBfY29uc3VtZUxCcmFja2V0CiAgICAgICAgICAgICAgICAgIHRva2VuID0gdGhpcy5fY29uc3VtZUxCcmFja2V0KHN0cmVhbSk7CiAgICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIlwiIikgewogICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIGlkZW50aWZpZXIgPSB0aGlzLl9jb25zdW1lUXVvdGVkSWRlbnRpZmllcihzdHJlYW0pOwogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1FVT1RFRElERU5USUZJRVIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RyZWFtW3RoaXMuX2N1cnJlbnRdID09PSAiJyIpIHsKICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gdGhpcy5fY29uc3VtZVJhd1N0cmluZ0xpdGVyYWwoc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19MSVRFUkFMLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGlkZW50aWZpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogc3RhcnR9KTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gImAiKSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICAgICAgdmFyIGxpdGVyYWwgPSB0aGlzLl9jb25zdW1lTGl0ZXJhbChzdHJlYW0pOwogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0xJVEVSQUwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbGl0ZXJhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAob3BlcmF0b3JTdGFydFRva2VuW3N0cmVhbVt0aGlzLl9jdXJyZW50XV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh0aGlzLl9jb25zdW1lT3BlcmF0b3Ioc3RyZWFtKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChza2lwQ2hhcnNbc3RyZWFtW3RoaXMuX2N1cnJlbnRdXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB3aGl0ZXNwYWNlLgogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICImIikgewogICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0FORCwgdmFsdWU6ICImJiIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdG9rZW5zLnB1c2goe3R5cGU6IFRPS19FWFBSRUYsIHZhbHVlOiAiJiIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICJ8IikgewogICAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gInwiKSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX09SLCB2YWx1ZTogInx8Iiwgc3RhcnQ6IHN0YXJ0fSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX1BJUEUsIHZhbHVlOiAifCIsIHN0YXJ0OiBzdGFydH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJVbmtub3duIGNoYXJhY3RlcjoiICsgc3RyZWFtW3RoaXMuX2N1cnJlbnRdKTsKICAgICAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJMZXhlckVycm9yIjsKICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRva2VuczsKICAgICAgfSwKCiAgICAgIF9jb25zdW1lVW5xdW90ZWRJZGVudGlmaWVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB3aGlsZSAodGhpcy5fY3VycmVudCA8IHN0cmVhbS5sZW5ndGggJiYgaXNBbHBoYU51bShzdHJlYW1bdGhpcy5fY3VycmVudF0pKSB7CiAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCk7CiAgICAgIH0sCgogICAgICBfY29uc3VtZVF1b3RlZElkZW50aWZpZXI6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gIlwiIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBkb3VibGUgcXVvdGUgYW5kIHlvdSBjYW4gZXNjYXBlIGFuIGVzY2FwZS4KICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJcIiIpKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQgKz0gMjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50Kys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQgPSBjdXJyZW50OwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2Uoc3RyZWFtLnNsaWNlKHN0YXJ0LCB0aGlzLl9jdXJyZW50KSk7CiAgICAgIH0sCgogICAgICBfY29uc3VtZVJhd1N0cmluZ0xpdGVyYWw6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSAhPT0gIiciICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICAvLyBZb3UgY2FuIGVzY2FwZSBhIHNpbmdsZSBxdW90ZSBhbmQgeW91IGNhbiBlc2NhcGUgYW4gZXNjYXBlLgogICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgICAgICBpZiAoc3RyZWFtW2N1cnJlbnRdID09PSAiXFwiICYmIChzdHJlYW1bY3VycmVudCArIDFdID09PSAiXFwiIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIiciKSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ICs9IDI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50ID0gY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHZhciBsaXRlcmFsID0gc3RyZWFtLnNsaWNlKHN0YXJ0ICsgMSwgdGhpcy5fY3VycmVudCAtIDEpOwogICAgICAgICAgcmV0dXJuIGxpdGVyYWwucmVwbGFjZSgiXFwnIiwgIiciKTsKICAgICAgfSwKCiAgICAgIF9jb25zdW1lTnVtYmVyOiBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgICAgIHZhciBzdGFydCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gc3RyZWFtLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChpc051bShzdHJlYW1bdGhpcy5fY3VycmVudF0pICYmIHRoaXMuX2N1cnJlbnQgPCBtYXhMZW5ndGgpIHsKICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsdWUgPSBwYXJzZUludChzdHJlYW0uc2xpY2Uoc3RhcnQsIHRoaXMuX2N1cnJlbnQpKTsKICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX05VTUJFUiwgdmFsdWU6IHZhbHVlLCBzdGFydDogc3RhcnR9OwogICAgICB9LAoKICAgICAgX2NvbnN1bWVMQnJhY2tldDogZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLl9jdXJyZW50OwogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0ZJTFRFUiwgdmFsdWU6ICJbPyIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICB9IGVsc2UgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIl0iKSB7CiAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0ZMQVRURU4sIHZhbHVlOiAiW10iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19MQlJBQ0tFVCwgdmFsdWU6ICJbIiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9jb25zdW1lT3BlcmF0b3I6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgIHZhciBzdGFydGluZ0NoYXIgPSBzdHJlYW1bc3RhcnRdOwogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgaWYgKHN0YXJ0aW5nQ2hhciA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgaWYgKHN0cmVhbVt0aGlzLl9jdXJyZW50XSA9PT0gIj0iKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTkUsIHZhbHVlOiAiIT0iLCBzdGFydDogc3RhcnR9OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19OT1QsIHZhbHVlOiAiISIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI8IikgewogICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0xURSwgdmFsdWU6ICI8PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfTFQsIHZhbHVlOiAiPCIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI+IikgewogICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0dURSwgdmFsdWU6ICI+PSIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiBUT0tfR1QsIHZhbHVlOiAiPiIsIHN0YXJ0OiBzdGFydH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXIgPT09ICI9IikgewogICAgICAgICAgICAgIGlmIChzdHJlYW1bdGhpcy5fY3VycmVudF0gPT09ICI9IikgewogICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50Kys7CiAgICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0VRLCB2YWx1ZTogIj09Iiwgc3RhcnQ6IHN0YXJ0fTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBfY29uc3VtZUxpdGVyYWw6IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICAgdGhpcy5fY3VycmVudCsrOwogICAgICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5fY3VycmVudDsKICAgICAgICAgIHZhciBtYXhMZW5ndGggPSBzdHJlYW0ubGVuZ3RoOwogICAgICAgICAgdmFyIGxpdGVyYWw7CiAgICAgICAgICB3aGlsZShzdHJlYW1bdGhpcy5fY3VycmVudF0gIT09ICJgIiAmJiB0aGlzLl9jdXJyZW50IDwgbWF4TGVuZ3RoKSB7CiAgICAgICAgICAgICAgLy8gWW91IGNhbiBlc2NhcGUgYSBsaXRlcmFsIGNoYXIgb3IgeW91IGNhbiBlc2NhcGUgdGhlIGVzY2FwZS4KICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnQ7CiAgICAgICAgICAgICAgaWYgKHN0cmVhbVtjdXJyZW50XSA9PT0gIlxcIiAmJiAoc3RyZWFtW2N1cnJlbnQgKyAxXSA9PT0gIlxcIiB8fAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbVtjdXJyZW50ICsgMV0gPT09ICJgIikpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCArPSAyOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnQrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5fY3VycmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGl0ZXJhbFN0cmluZyA9IHRyaW1MZWZ0KHN0cmVhbS5zbGljZShzdGFydCwgdGhpcy5fY3VycmVudCkpOwogICAgICAgICAgbGl0ZXJhbFN0cmluZyA9IGxpdGVyYWxTdHJpbmcucmVwbGFjZSgiXFxgIiwgImAiKTsKICAgICAgICAgIGlmICh0aGlzLl9sb29rc0xpa2VKU09OKGxpdGVyYWxTdHJpbmcpKSB7CiAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UobGl0ZXJhbFN0cmluZyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIFRyeSB0byBKU09OIHBhcnNlIGl0IGFzICI8bGl0ZXJhbD4iCiAgICAgICAgICAgICAgbGl0ZXJhbCA9IEpTT04ucGFyc2UoIlwiIiArIGxpdGVyYWxTdHJpbmcgKyAiXCIiKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vICsxIGdldHMgdXMgdG8gdGhlIGVuZGluZyAiYCIsICsxIHRvIG1vdmUgb24gdG8gdGhlIG5leHQgY2hhci4KICAgICAgICAgIHRoaXMuX2N1cnJlbnQrKzsKICAgICAgICAgIHJldHVybiBsaXRlcmFsOwogICAgICB9LAoKICAgICAgX2xvb2tzTGlrZUpTT046IGZ1bmN0aW9uKGxpdGVyYWxTdHJpbmcpIHsKICAgICAgICAgIHZhciBzdGFydGluZ0NoYXJzID0gIlt7XCIiOwogICAgICAgICAgdmFyIGpzb25MaXRlcmFscyA9IFsidHJ1ZSIsICJmYWxzZSIsICJudWxsIl07CiAgICAgICAgICB2YXIgbnVtYmVyTG9va2luZyA9ICItMDEyMzQ1Njc4OSI7CgogICAgICAgICAgaWYgKGxpdGVyYWxTdHJpbmcgPT09ICIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChzdGFydGluZ0NoYXJzLmluZGV4T2YobGl0ZXJhbFN0cmluZ1swXSkgPj0gMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChqc29uTGl0ZXJhbHMuaW5kZXhPZihsaXRlcmFsU3RyaW5nKSA+PSAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKG51bWJlckxvb2tpbmcuaW5kZXhPZihsaXRlcmFsU3RyaW5nWzBdKSA+PSAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgSlNPTi5wYXJzZShsaXRlcmFsU3RyaW5nKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICB9CiAgfTsKCiAgICAgIHZhciBiaW5kaW5nUG93ZXIgPSB7fTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19FT0ZdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19VTlFVT1RFRElERU5USUZJRVJdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19RVU9URURJREVOVElGSUVSXSA9IDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfUkJSQUNLRVRdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19SUEFSRU5dID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19DT01NQV0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX1JCUkFDRV0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX05VTUJFUl0gPSAwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0NVUlJFTlRdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19FWFBSRUZdID0gMDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19QSVBFXSA9IDE7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfT1JdID0gMjsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19BTkRdID0gMzsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19FUV0gPSA1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0dUXSA9IDU7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTFRdID0gNTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19HVEVdID0gNTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19MVEVdID0gNTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19ORV0gPSA1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0ZMQVRURU5dID0gOTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19TVEFSXSA9IDIwOwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0ZJTFRFUl0gPSAyMTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19ET1RdID0gNDA7CiAgICAgIGJpbmRpbmdQb3dlcltUT0tfTk9UXSA9IDQ1OwogICAgICBiaW5kaW5nUG93ZXJbVE9LX0xCUkFDRV0gPSA1MDsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19MQlJBQ0tFVF0gPSA1NTsKICAgICAgYmluZGluZ1Bvd2VyW1RPS19MUEFSRU5dID0gNjA7CgogIGZ1bmN0aW9uIFBhcnNlcigpIHsKICB9CgogIFBhcnNlci5wcm90b3R5cGUgPSB7CiAgICAgIHBhcnNlOiBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICAgICAgICB0aGlzLl9sb2FkVG9rZW5zKGV4cHJlc3Npb24pOwogICAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgICB2YXIgYXN0ID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSAhPT0gVE9LX0VPRikgewogICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKAogICAgICAgICAgICAgICAgICAiVW5leHBlY3RlZCB0b2tlbiB0eXBlOiAiICsgdC50eXBlICsgIiwgdmFsdWU6ICIgKyB0LnZhbHVlKTsKICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBhc3Q7CiAgICAgIH0sCgogICAgICBfbG9hZFRva2VuczogZnVuY3Rpb24oZXhwcmVzc2lvbikgewogICAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCk7CiAgICAgICAgICB2YXIgdG9rZW5zID0gbGV4ZXIudG9rZW5pemUoZXhwcmVzc2lvbik7CiAgICAgICAgICB0b2tlbnMucHVzaCh7dHlwZTogVE9LX0VPRiwgdmFsdWU6ICIiLCBzdGFydDogZXhwcmVzc2lvbi5sZW5ndGh9KTsKICAgICAgICAgIHRoaXMudG9rZW5zID0gdG9rZW5zOwogICAgICB9LAoKICAgICAgZXhwcmVzc2lvbjogZnVuY3Rpb24ocmJwKSB7CiAgICAgICAgICB2YXIgbGVmdFRva2VuID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICB2YXIgbGVmdCA9IHRoaXMubnVkKGxlZnRUb2tlbik7CiAgICAgICAgICB2YXIgY3VycmVudFRva2VuID0gdGhpcy5fbG9va2FoZWFkKDApOwogICAgICAgICAgd2hpbGUgKHJicCA8IGJpbmRpbmdQb3dlcltjdXJyZW50VG9rZW5dKSB7CiAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgIGxlZnQgPSB0aGlzLmxlZChjdXJyZW50VG9rZW4sIGxlZnQpOwogICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICB9LAoKICAgICAgX2xvb2thaGVhZDogZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy50b2tlbnNbdGhpcy5pbmRleCArIG51bWJlcl0udHlwZTsKICAgICAgfSwKCiAgICAgIF9sb29rYWhlYWRUb2tlbjogZnVuY3Rpb24obnVtYmVyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy50b2tlbnNbdGhpcy5pbmRleCArIG51bWJlcl07CiAgICAgIH0sCgogICAgICBfYWR2YW5jZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgIH0sCgogICAgICBudWQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgdmFyIGxlZnQ7CiAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgIHZhciBleHByZXNzaW9uOwogICAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgewogICAgICAgICAgY2FzZSBUT0tfTElURVJBTDoKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiTGl0ZXJhbCIsIHZhbHVlOiB0b2tlbi52YWx1ZX07CiAgICAgICAgICBjYXNlIFRPS19VTlFVT1RFRElERU5USUZJRVI6CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkZpZWxkIiwgbmFtZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgY2FzZSBUT0tfUVVPVEVESURFTlRJRklFUjoKICAgICAgICAgICAgdmFyIG5vZGUgPSB7dHlwZTogIkZpZWxkIiwgbmFtZTogdG9rZW4udmFsdWV9OwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTFBBUkVOKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlF1b3RlZCBpZGVudGlmaWVyIG5vdCBhbGxvd2VkIGZvciBmdW5jdGlvbiBuYW1lcy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIGNhc2UgVE9LX05PVDoKICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLk5vdCk7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIk5vdEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW3JpZ2h0XX07CiAgICAgICAgICBjYXNlIFRPS19TVEFSOgogICAgICAgICAgICBsZWZ0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICByaWdodCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgLy8gVGhpcyBjYW4gaGFwcGVuIGluIGEgbXVsdGlzZWxlY3QsCiAgICAgICAgICAgICAgICAvLyBbYSwgYiwgKl0KICAgICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLlN0YXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlZhbHVlUHJvamVjdGlvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGNhc2UgVE9LX0ZJTFRFUjoKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGVkKHRva2VuLnR5cGUsIHt0eXBlOiAiSWRlbnRpdHkifSk7CiAgICAgICAgICBjYXNlIFRPS19MQlJBQ0U6CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0SGFzaCgpOwogICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgbGVmdCA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFt7dHlwZTogIklkZW50aXR5In1dfTsKICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZsYXR0ZW4pOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgY2FzZSBUT0tfTEJSQUNLRVQ6CiAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19OVU1CRVIgfHwgdGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VJbmRleEV4cHJlc3Npb24oKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0SWZTbGljZSh7dHlwZTogIklkZW50aXR5In0sIHJpZ2h0KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19TVEFSICYmCiAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9va2FoZWFkKDEpID09PSBUT0tfUkJSQUNLRVQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5TdGFyKTsKICAgICAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLAogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW3t0eXBlOiAiSWRlbnRpdHkifSwgcmlnaHRdfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdExpc3QoKTsKICAgICAgICAgIGNhc2UgVE9LX0NVUlJFTlQ6CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgY2FzZSBUT0tfRVhQUkVGOgogICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKGJpbmRpbmdQb3dlci5FeHByZWYpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJFeHByZXNzaW9uUmVmZXJlbmNlIiwgY2hpbGRyZW46IFtleHByZXNzaW9uXX07CiAgICAgICAgICBjYXNlIFRPS19MUEFSRU46CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SUEFSRU4pIHsKICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ1VSUkVOVCkgewogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiA9IHt0eXBlOiBUT0tfQ1VSUkVOVH07CiAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB0aGlzLmV4cHJlc3Npb24oMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUlBBUkVOKTsKICAgICAgICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aGlzLl9lcnJvclRva2VuKHRva2VuKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBsZWQ6IGZ1bmN0aW9uKHRva2VuTmFtZSwgbGVmdCkgewogICAgICAgIHZhciByaWdodDsKICAgICAgICBzd2l0Y2godG9rZW5OYW1lKSB7CiAgICAgICAgICBjYXNlIFRPS19ET1Q6CiAgICAgICAgICAgIHZhciByYnAgPSBiaW5kaW5nUG93ZXIuRG90OwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfU1RBUikgewogICAgICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZURvdFJIUyhyYnApOwogICAgICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiU3ViZXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBDcmVhdGluZyBhIHByb2plY3Rpb24uCiAgICAgICAgICAgIHRoaXMuX2FkdmFuY2UoKTsKICAgICAgICAgICAgcmlnaHQgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMocmJwKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiVmFsdWVQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgY2FzZSBUT0tfUElQRToKICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLlBpcGUpOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6IFRPS19QSVBFLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBjYXNlIFRPS19PUjoKICAgICAgICAgICAgcmlnaHQgPSB0aGlzLmV4cHJlc3Npb24oYmluZGluZ1Bvd2VyLk9yKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiT3JFeHByZXNzaW9uIiwgY2hpbGRyZW46IFtsZWZ0LCByaWdodF19OwogICAgICAgICAgY2FzZSBUT0tfQU5EOgogICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXIuQW5kKTsKICAgICAgICAgICAgcmV0dXJuIHt0eXBlOiAiQW5kRXhwcmVzc2lvbiIsIGNoaWxkcmVuOiBbbGVmdCwgcmlnaHRdfTsKICAgICAgICAgIGNhc2UgVE9LX0xQQVJFTjoKICAgICAgICAgICAgdmFyIG5hbWUgPSBsZWZ0Lm5hbWU7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIHZhciBleHByZXNzaW9uLCBub2RlOwogICAgICAgICAgICB3aGlsZSAodGhpcy5fbG9va2FoZWFkKDApICE9PSBUT0tfUlBBUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NVUlJFTlQpIHsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gPSB7dHlwZTogVE9LX0NVUlJFTlR9OwogICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFyZ3MucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUlBBUkVOKTsKICAgICAgICAgICAgbm9kZSA9IHt0eXBlOiAiRnVuY3Rpb24iLCBuYW1lOiBuYW1lLCBjaGlsZHJlbjogYXJnc307CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgY2FzZSBUT0tfRklMVEVSOgogICAgICAgICAgICB2YXIgY29uZGl0aW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfRkxBVFRFTikgewogICAgICAgICAgICAgIHJpZ2h0ID0ge3R5cGU6ICJJZGVudGl0eSJ9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VQcm9qZWN0aW9uUkhTKGJpbmRpbmdQb3dlci5GaWx0ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIkZpbHRlclByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0LCBjb25kaXRpb25dfTsKICAgICAgICAgIGNhc2UgVE9LX0ZMQVRURU46CiAgICAgICAgICAgIHZhciBsZWZ0Tm9kZSA9IHt0eXBlOiBUT0tfRkxBVFRFTiwgY2hpbGRyZW46IFtsZWZ0XX07CiAgICAgICAgICAgIHZhciByaWdodE5vZGUgPSB0aGlzLl9wYXJzZVByb2plY3Rpb25SSFMoYmluZGluZ1Bvd2VyLkZsYXR0ZW4pOwogICAgICAgICAgICByZXR1cm4ge3R5cGU6ICJQcm9qZWN0aW9uIiwgY2hpbGRyZW46IFtsZWZ0Tm9kZSwgcmlnaHROb2RlXX07CiAgICAgICAgICBjYXNlIFRPS19FUToKICAgICAgICAgIGNhc2UgVE9LX05FOgogICAgICAgICAgY2FzZSBUT0tfR1Q6CiAgICAgICAgICBjYXNlIFRPS19HVEU6CiAgICAgICAgICBjYXNlIFRPS19MVDoKICAgICAgICAgIGNhc2UgVE9LX0xURToKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhcnNlQ29tcGFyYXRvcihsZWZ0LCB0b2tlbk5hbWUpOwogICAgICAgICAgY2FzZSBUT0tfTEJSQUNLRVQ6CiAgICAgICAgICAgIHZhciB0b2tlbiA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PT0gVE9LX05VTUJFUiB8fCB0b2tlbi50eXBlID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgIHJpZ2h0ID0gdGhpcy5fcGFyc2VJbmRleEV4cHJlc3Npb24oKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wcm9qZWN0SWZTbGljZShsZWZ0LCByaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1NUQVIpOwogICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfUkJSQUNLRVQpOwogICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3Rhcik7CiAgICAgICAgICAgIHJldHVybiB7dHlwZTogIlByb2plY3Rpb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB0aGlzLl9lcnJvclRva2VuKHRoaXMuX2xvb2thaGVhZFRva2VuKDApKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBfbWF0Y2g6IGZ1bmN0aW9uKHRva2VuVHlwZSkgewogICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gdG9rZW5UeXBlKSB7CiAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApOwogICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiRXhwZWN0ZWQgIiArIHRva2VuVHlwZSArICIsIGdvdDogIiArIHQudHlwZSk7CiAgICAgICAgICAgICAgZXJyb3IubmFtZSA9ICJQYXJzZXJFcnJvciI7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBfZXJyb3JUb2tlbjogZnVuY3Rpb24odG9rZW4pIHsKICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiSW52YWxpZCB0b2tlbiAoIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW4udHlwZSArICIpOiBcIiIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRva2VuLnZhbHVlICsgIlwiIik7CiAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICB9LAoKCiAgICAgIF9wYXJzZUluZGV4RXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09MT04gfHwgdGhpcy5fbG9va2FoZWFkKDEpID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VTbGljZUV4cHJlc3Npb24oKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB7CiAgICAgICAgICAgICAgICAgIHR5cGU6ICJJbmRleCIsCiAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLl9sb29rYWhlYWRUb2tlbigwKS52YWx1ZX07CiAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICB9CiAgICAgIH0sCgogICAgICBfcHJvamVjdElmU2xpY2U6IGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgICAgICB2YXIgaW5kZXhFeHByID0ge3R5cGU6ICJJbmRleEV4cHJlc3Npb24iLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgICAgICBpZiAocmlnaHQudHlwZSA9PT0gIlNsaWNlIikgewogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIHR5cGU6ICJQcm9qZWN0aW9uIiwKICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFtpbmRleEV4cHIsIHRoaXMuX3BhcnNlUHJvamVjdGlvblJIUyhiaW5kaW5nUG93ZXIuU3RhcildCiAgICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluZGV4RXhwcjsKICAgICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9wYXJzZVNsaWNlRXhwcmVzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBbc3RhcnQ6ZW5kOnN0ZXBdIHdoZXJlIGVhY2ggcGFydCBpcyBvcHRpb25hbCwgYXMgd2VsbCBhcyB0aGUgbGFzdAogICAgICAgICAgLy8gY29sb24uCiAgICAgICAgICB2YXIgcGFydHMgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgICB2YXIgaW5kZXggPSAwOwogICAgICAgICAgdmFyIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgIHdoaWxlIChjdXJyZW50VG9rZW4gIT09IFRPS19SQlJBQ0tFVCAmJiBpbmRleCA8IDMpIHsKICAgICAgICAgICAgICBpZiAoY3VycmVudFRva2VuID09PSBUT0tfQ09MT04pIHsKICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudFRva2VuID09PSBUT0tfTlVNQkVSKSB7CiAgICAgICAgICAgICAgICAgIHBhcnRzW2luZGV4XSA9IHRoaXMuX2xvb2thaGVhZFRva2VuKDApLnZhbHVlOwogICAgICAgICAgICAgICAgICB0aGlzLl9hZHZhbmNlKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLl9sb29rYWhlYWQoMCk7CiAgICAgICAgICAgICAgICAgIHZhciBlcnJvciA9IG5ldyBFcnJvcigiU3ludGF4IGVycm9yLCB1bmV4cGVjdGVkIHRva2VuOiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudmFsdWUgKyAiKCIgKyB0LnR5cGUgKyAiKSIpOwogICAgICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlcmVycm9yIjsKICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRUb2tlbiA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0tFVCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHR5cGU6ICJTbGljZSIsCiAgICAgICAgICAgICAgY2hpbGRyZW46IHBhcnRzCiAgICAgICAgICB9OwogICAgICB9LAoKICAgICAgX3BhcnNlQ29tcGFyYXRvcjogZnVuY3Rpb24obGVmdCwgY29tcGFyYXRvcikgewogICAgICAgIHZhciByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihiaW5kaW5nUG93ZXJbY29tcGFyYXRvcl0pOwogICAgICAgIHJldHVybiB7dHlwZTogIkNvbXBhcmF0b3IiLCBuYW1lOiBjb21wYXJhdG9yLCBjaGlsZHJlbjogW2xlZnQsIHJpZ2h0XX07CiAgICAgIH0sCgogICAgICBfcGFyc2VEb3RSSFM6IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgdmFyIGxvb2thaGVhZCA9IHRoaXMuX2xvb2thaGVhZCgwKTsKICAgICAgICAgIHZhciBleHByVG9rZW5zID0gW1RPS19VTlFVT1RFRElERU5USUZJRVIsIFRPS19RVU9URURJREVOVElGSUVSLCBUT0tfU1RBUl07CiAgICAgICAgICBpZiAoZXhwclRva2Vucy5pbmRleE9mKGxvb2thaGVhZCkgPj0gMCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb24ocmJwKTsKICAgICAgICAgIH0gZWxzZSBpZiAobG9va2FoZWFkID09PSBUT0tfTEJSQUNLRVQpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfTEJSQUNLRVQpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZU11bHRpc2VsZWN0TGlzdCgpOwogICAgICAgICAgfSBlbHNlIGlmIChsb29rYWhlYWQgPT09IFRPS19MQlJBQ0UpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfTEJSQUNFKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcGFyc2VNdWx0aXNlbGVjdEhhc2goKTsKICAgICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9wYXJzZVByb2plY3Rpb25SSFM6IGZ1bmN0aW9uKHJicCkgewogICAgICAgICAgdmFyIHJpZ2h0OwogICAgICAgICAgaWYgKGJpbmRpbmdQb3dlclt0aGlzLl9sb29rYWhlYWQoMCldIDwgMTApIHsKICAgICAgICAgICAgICByaWdodCA9IHt0eXBlOiAiSWRlbnRpdHkifTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfTEJSQUNLRVQpIHsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19GSUxURVIpIHsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuZXhwcmVzc2lvbihyYnApOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19ET1QpIHsKICAgICAgICAgICAgICB0aGlzLl9tYXRjaChUT0tfRE9UKTsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMuX3BhcnNlRG90UkhTKHJicCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciB0ID0gdGhpcy5fbG9va2FoZWFkVG9rZW4oMCk7CiAgICAgICAgICAgICAgdmFyIGVycm9yID0gbmV3IEVycm9yKCJTeXRhbnggZXJyb3IsIHVuZXhwZWN0ZWQgdG9rZW46ICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnZhbHVlICsgIigiICsgdC50eXBlICsgIikiKTsKICAgICAgICAgICAgICBlcnJvci5uYW1lID0gIlBhcnNlckVycm9yIjsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByaWdodDsKICAgICAgfSwKCiAgICAgIF9wYXJzZU11bHRpc2VsZWN0TGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZXhwcmVzc2lvbnMgPSBbXTsKICAgICAgICAgIHdoaWxlICh0aGlzLl9sb29rYWhlYWQoMCkgIT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgIHZhciBleHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgICAgIGV4cHJlc3Npb25zLnB1c2goZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgaWYgKHRoaXMuX2xvb2thaGVhZCgwKSA9PT0gVE9LX0NPTU1BKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19DT01NQSk7CiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9sb29rYWhlYWQoMCkgPT09IFRPS19SQlJBQ0tFVCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCB0b2tlbiBSYnJhY2tldCIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX1JCUkFDS0VUKTsKICAgICAgICAgIHJldHVybiB7dHlwZTogIk11bHRpU2VsZWN0TGlzdCIsIGNoaWxkcmVuOiBleHByZXNzaW9uc307CiAgICAgIH0sCgogICAgICBfcGFyc2VNdWx0aXNlbGVjdEhhc2g6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBwYWlycyA9IFtdOwogICAgICAgIHZhciBpZGVudGlmaWVyVHlwZXMgPSBbVE9LX1VOUVVPVEVESURFTlRJRklFUiwgVE9LX1FVT1RFRElERU5USUZJRVJdOwogICAgICAgIHZhciBrZXlUb2tlbiwga2V5TmFtZSwgdmFsdWUsIG5vZGU7CiAgICAgICAgZm9yICg7OykgewogICAgICAgICAga2V5VG9rZW4gPSB0aGlzLl9sb29rYWhlYWRUb2tlbigwKTsKICAgICAgICAgIGlmIChpZGVudGlmaWVyVHlwZXMuaW5kZXhPZihrZXlUb2tlbi50eXBlKSA8IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RpbmcgYW4gaWRlbnRpZmllciB0b2tlbiwgZ290OiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleVRva2VuLnR5cGUpOwogICAgICAgICAgfQogICAgICAgICAga2V5TmFtZSA9IGtleVRva2VuLnZhbHVlOwogICAgICAgICAgdGhpcy5fYWR2YW5jZSgpOwogICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTE9OKTsKICAgICAgICAgIHZhbHVlID0gdGhpcy5leHByZXNzaW9uKDApOwogICAgICAgICAgbm9kZSA9IHt0eXBlOiAiS2V5VmFsdWVQYWlyIiwgbmFtZToga2V5TmFtZSwgdmFsdWU6IHZhbHVlfTsKICAgICAgICAgIHBhaXJzLnB1c2gobm9kZSk7CiAgICAgICAgICBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfQ09NTUEpIHsKICAgICAgICAgICAgdGhpcy5fbWF0Y2goVE9LX0NPTU1BKTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5fbG9va2FoZWFkKDApID09PSBUT0tfUkJSQUNFKSB7CiAgICAgICAgICAgIHRoaXMuX21hdGNoKFRPS19SQlJBQ0UpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHt0eXBlOiAiTXVsdGlTZWxlY3RIYXNoIiwgY2hpbGRyZW46IHBhaXJzfTsKICAgICAgfQogIH07CgoKICBmdW5jdGlvbiBUcmVlSW50ZXJwcmV0ZXIocnVudGltZSkgewogICAgdGhpcy5ydW50aW1lID0gcnVudGltZTsKICB9CgogIFRyZWVJbnRlcnByZXRlci5wcm90b3R5cGUgPSB7CiAgICAgIHNlYXJjaDogZnVuY3Rpb24obm9kZSwgdmFsdWUpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUsIHZhbHVlKTsKICAgICAgfSwKCiAgICAgIHZpc2l0OiBmdW5jdGlvbihub2RlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIG1hdGNoZWQsIGN1cnJlbnQsIHJlc3VsdCwgZmlyc3QsIHNlY29uZCwgZmllbGQsIGxlZnQsIHJpZ2h0LCBjb2xsZWN0ZWQsIGk7CiAgICAgICAgICBzd2l0Y2ggKG5vZGUudHlwZSkgewogICAgICAgICAgICBjYXNlICJGaWVsZCI6CiAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIGlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICBmaWVsZCA9IHZhbHVlW25vZGUubmFtZV07CiAgICAgICAgICAgICAgICAgIGlmIChmaWVsZCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSAiU3ViZXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCByZXN1bHQpOwogICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICBjYXNlICJJbmRleEV4cHJlc3Npb24iOgogICAgICAgICAgICAgIGxlZnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICByaWdodCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgbGVmdCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJpZ2h0OwogICAgICAgICAgICBjYXNlICJJbmRleCI6CiAgICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpbmRleCA9IG5vZGUudmFsdWU7CiAgICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgaW5kZXggPSB2YWx1ZS5sZW5ndGggKyBpbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWVbaW5kZXhdOwogICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmVzdWx0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgY2FzZSAiU2xpY2UiOgogICAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc2xpY2VQYXJhbXMgPSBub2RlLmNoaWxkcmVuLnNsaWNlKDApOwogICAgICAgICAgICAgIHZhciBjb21wdXRlZCA9IHRoaXMuY29tcHV0ZVNsaWNlUGFyYW1zKHZhbHVlLmxlbmd0aCwgc2xpY2VQYXJhbXMpOwogICAgICAgICAgICAgIHZhciBzdGFydCA9IGNvbXB1dGVkWzBdOwogICAgICAgICAgICAgIHZhciBzdG9wID0gY29tcHV0ZWRbMV07CiAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBjb21wdXRlZFsyXTsKICAgICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgICBpZiAoc3RlcCA+IDApIHsKICAgICAgICAgICAgICAgICAgZm9yIChpID0gc3RhcnQ7IGkgPCBzdG9wOyBpICs9IHN0ZXApIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHN0YXJ0OyBpID4gc3RvcDsgaSArPSBzdGVwKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZVtpXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgY2FzZSAiUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgLy8gRXZhbHVhdGUgbGVmdCBjaGlsZC4KICAgICAgICAgICAgICB2YXIgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIGlmICghaXNBcnJheShiYXNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBiYXNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBiYXNlW2ldKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY29sbGVjdGVkOwogICAgICAgICAgICBjYXNlICJWYWx1ZVByb2plY3Rpb24iOgogICAgICAgICAgICAgIC8vIEV2YWx1YXRlIGxlZnQgY2hpbGQuCiAgICAgICAgICAgICAgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIGlmICghaXNPYmplY3QoYmFzZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSBbXTsKICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gb2JqVmFsdWVzKGJhc2UpOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlc1tpXSk7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb2xsZWN0ZWQucHVzaChjdXJyZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgY2FzZSAiRmlsdGVyUHJvamVjdGlvbiI6CiAgICAgICAgICAgICAgYmFzZSA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblswXSwgdmFsdWUpOwogICAgICAgICAgICAgIGlmICghaXNBcnJheShiYXNlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IFtdOwogICAgICAgICAgICAgIHZhciBmaW5hbFJlc3VsdHMgPSBbXTsKICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYmFzZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsyXSwgYmFzZVtpXSk7CiAgICAgICAgICAgICAgICBpZiAoIWlzRmFsc2UobWF0Y2hlZCkpIHsKICAgICAgICAgICAgICAgICAgZmlsdGVyZWQucHVzaChiYXNlW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmaWx0ZXJlZC5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgICAgY3VycmVudCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgZmlsdGVyZWRbal0pOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmluYWxSZXN1bHRzLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmaW5hbFJlc3VsdHM7CiAgICAgICAgICAgIGNhc2UgIkNvbXBhcmF0b3IiOgogICAgICAgICAgICAgIGZpcnN0ID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgc2Vjb25kID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgc3dpdGNoKG5vZGUubmFtZSkgewogICAgICAgICAgICAgICAgY2FzZSBUT0tfRVE6CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRPS19ORToKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gIXN0cmljdERlZXBFcXVhbChmaXJzdCwgc2Vjb25kKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRPS19HVDoKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPiBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBUT0tfR1RFOgogICAgICAgICAgICAgICAgICByZXN1bHQgPSBmaXJzdCA+PSBzZWNvbmQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBUT0tfTFQ6CiAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZpcnN0IDwgc2Vjb25kOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgVE9LX0xURToKICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gZmlyc3QgPD0gc2Vjb25kOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBjb21wYXJhdG9yOiAiICsgbm9kZS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgY2FzZSBUT0tfRkxBVFRFTjoKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWwgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoIWlzQXJyYXkob3JpZ2luYWwpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG1lcmdlZCA9IFtdOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvcmlnaW5hbC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY3VycmVudCA9IG9yaWdpbmFsW2ldOwogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY3VycmVudCkpIHsKICAgICAgICAgICAgICAgICAgbWVyZ2VkLnB1c2guYXBwbHkobWVyZ2VkLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG1lcmdlZC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbWVyZ2VkOwogICAgICAgICAgICBjYXNlICJJZGVudGl0eSI6CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBjYXNlICJNdWx0aVNlbGVjdExpc3QiOgogICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbGxlY3RlZCA9IFtdOwogICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNvbGxlY3RlZC5wdXNoKHRoaXMudmlzaXQobm9kZS5jaGlsZHJlbltpXSwgdmFsdWUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgY2FzZSAiTXVsdGlTZWxlY3RIYXNoIjoKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb2xsZWN0ZWQgPSB7fTsKICAgICAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gbm9kZS5jaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgIGNvbGxlY3RlZFtjaGlsZC5uYW1lXSA9IHRoaXMudmlzaXQoY2hpbGQudmFsdWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNvbGxlY3RlZDsKICAgICAgICAgICAgY2FzZSAiT3JFeHByZXNzaW9uIjoKICAgICAgICAgICAgICBtYXRjaGVkID0gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzBdLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKGlzRmFsc2UobWF0Y2hlZCkpIHsKICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRoaXMudmlzaXQobm9kZS5jaGlsZHJlblsxXSwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlZDsKICAgICAgICAgICAgY2FzZSAiQW5kRXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKCiAgICAgICAgICAgICAgaWYgKGlzRmFsc2UoZmlyc3QpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMV0sIHZhbHVlKTsKICAgICAgICAgICAgY2FzZSAiTm90RXhwcmVzc2lvbiI6CiAgICAgICAgICAgICAgZmlyc3QgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gaXNGYWxzZShmaXJzdCk7CiAgICAgICAgICAgIGNhc2UgIkxpdGVyYWwiOgogICAgICAgICAgICAgIHJldHVybiBub2RlLnZhbHVlOwogICAgICAgICAgICBjYXNlIFRPS19QSVBFOgogICAgICAgICAgICAgIGxlZnQgPSB0aGlzLnZpc2l0KG5vZGUuY2hpbGRyZW5bMF0sIHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy52aXNpdChub2RlLmNoaWxkcmVuWzFdLCBsZWZ0KTsKICAgICAgICAgICAgY2FzZSBUT0tfQ1VSUkVOVDoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIkZ1bmN0aW9uIjoKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRBcmdzID0gW107CiAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG5vZGUuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRBcmdzLnB1c2godGhpcy52aXNpdChub2RlLmNoaWxkcmVuW2ldLCB2YWx1ZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ydW50aW1lLmNhbGxGdW5jdGlvbihub2RlLm5hbWUsIHJlc29sdmVkQXJncyk7CiAgICAgICAgICAgIGNhc2UgIkV4cHJlc3Npb25SZWZlcmVuY2UiOgogICAgICAgICAgICAgIHZhciByZWZOb2RlID0gbm9kZS5jaGlsZHJlblswXTsKICAgICAgICAgICAgICAvLyBUYWcgdGhlIG5vZGUgd2l0aCBhIHNwZWNpZmljIGF0dHJpYnV0ZSBzbyB0aGUgdHlwZQogICAgICAgICAgICAgIC8vIGNoZWNrZXIgdmVyaWZ5IHRoZSB0eXBlLgogICAgICAgICAgICAgIHJlZk5vZGUuam1lc3BhdGhUeXBlID0gVE9LX0VYUFJFRjsKICAgICAgICAgICAgICByZXR1cm4gcmVmTm9kZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gbm9kZSB0eXBlOiAiICsgbm9kZS50eXBlKTsKICAgICAgICAgIH0KICAgICAgfSwKCiAgICAgIGNvbXB1dGVTbGljZVBhcmFtczogZnVuY3Rpb24oYXJyYXlMZW5ndGgsIHNsaWNlUGFyYW1zKSB7CiAgICAgICAgdmFyIHN0YXJ0ID0gc2xpY2VQYXJhbXNbMF07CiAgICAgICAgdmFyIHN0b3AgPSBzbGljZVBhcmFtc1sxXTsKICAgICAgICB2YXIgc3RlcCA9IHNsaWNlUGFyYW1zWzJdOwogICAgICAgIHZhciBjb21wdXRlZCA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICBpZiAoc3RlcCA9PT0gbnVsbCkgewogICAgICAgICAgc3RlcCA9IDE7CiAgICAgICAgfSBlbHNlIGlmIChzdGVwID09PSAwKSB7CiAgICAgICAgICB2YXIgZXJyb3IgPSBuZXcgRXJyb3IoIkludmFsaWQgc2xpY2UsIHN0ZXAgY2Fubm90IGJlIDAiKTsKICAgICAgICAgIGVycm9yLm5hbWUgPSAiUnVudGltZUVycm9yIjsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgICAgICB2YXIgc3RlcFZhbHVlTmVnYXRpdmUgPSBzdGVwIDwgMCA/IHRydWUgOiBmYWxzZTsKCiAgICAgICAgaWYgKHN0YXJ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHN0YXJ0ID0gc3RlcFZhbHVlTmVnYXRpdmUgPyBhcnJheUxlbmd0aCAtIDEgOiAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXJ0ID0gdGhpcy5jYXBTbGljZVJhbmdlKGFycmF5TGVuZ3RoLCBzdGFydCwgc3RlcCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoc3RvcCA9PT0gbnVsbCkgewogICAgICAgICAgICBzdG9wID0gc3RlcFZhbHVlTmVnYXRpdmUgPyAtMSA6IGFycmF5TGVuZ3RoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0b3AgPSB0aGlzLmNhcFNsaWNlUmFuZ2UoYXJyYXlMZW5ndGgsIHN0b3AsIHN0ZXApOwogICAgICAgIH0KICAgICAgICBjb21wdXRlZFswXSA9IHN0YXJ0OwogICAgICAgIGNvbXB1dGVkWzFdID0gc3RvcDsKICAgICAgICBjb21wdXRlZFsyXSA9IHN0ZXA7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVkOwogICAgICB9LAoKICAgICAgY2FwU2xpY2VSYW5nZTogZnVuY3Rpb24oYXJyYXlMZW5ndGgsIGFjdHVhbFZhbHVlLCBzdGVwKSB7CiAgICAgICAgICBpZiAoYWN0dWFsVmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgYWN0dWFsVmFsdWUgKz0gYXJyYXlMZW5ndGg7CiAgICAgICAgICAgICAgaWYgKGFjdHVhbFZhbHVlIDwgMCkgewogICAgICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gLTEgOiAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYWN0dWFsVmFsdWUgPj0gYXJyYXlMZW5ndGgpIHsKICAgICAgICAgICAgICBhY3R1YWxWYWx1ZSA9IHN0ZXAgPCAwID8gYXJyYXlMZW5ndGggLSAxIDogYXJyYXlMZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYWN0dWFsVmFsdWU7CiAgICAgIH0KCiAgfTsKCiAgZnVuY3Rpb24gUnVudGltZShpbnRlcnByZXRlcikgewogICAgdGhpcy5faW50ZXJwcmV0ZXIgPSBpbnRlcnByZXRlcjsKICAgIHRoaXMuZnVuY3Rpb25UYWJsZSA9IHsKICAgICAgICAvLyBuYW1lOiBbZnVuY3Rpb24sIDxzaWduYXR1cmU+XQogICAgICAgIC8vIFRoZSA8c2lnbmF0dXJlPiBjYW4gYmU6CiAgICAgICAgLy8KICAgICAgICAvLyB7CiAgICAgICAgLy8gICBhcmdzOiBbW3R5cGUxLCB0eXBlMl0sIFt0eXBlMSwgdHlwZTJdXSwKICAgICAgICAvLyAgIHZhcmlhZGljOiB0cnVlfGZhbHNlCiAgICAgICAgLy8gfQogICAgICAgIC8vCiAgICAgICAgLy8gRWFjaCBhcmcgaW4gdGhlIGFyZyBsaXN0IGlzIGEgbGlzdCBvZiB2YWxpZCB0eXBlcwogICAgICAgIC8vIChpZiB0aGUgZnVuY3Rpb24gaXMgb3ZlcmxvYWRlZCBhbmQgc3VwcG9ydHMgbXVsdGlwbGUKICAgICAgICAvLyB0eXBlcy4gIElmIHRoZSB0eXBlIGlzICJhbnkiIHRoZW4gbm8gdHlwZSBjaGVja2luZwogICAgICAgIC8vIG9jY3VycyBvbiB0aGUgYXJndW1lbnQuICBWYXJpYWRpYyBpcyBvcHRpb25hbAogICAgICAgIC8vIGFuZCBpZiBub3QgcHJvdmlkZWQgaXMgYXNzdW1lZCB0byBiZSBmYWxzZS4KICAgICAgICBhYnM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25BYnMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgYXZnOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uQXZnLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgIGNlaWw6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25DZWlsLCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9OVU1CRVJdfV19LAogICAgICAgIGNvbnRhaW5zOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkNvbnRhaW5zLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVldfSwKICAgICAgICAgICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICJlbmRzX3dpdGgiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkVuZHNXaXRoLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkddfSwge3R5cGVzOiBbVFlQRV9TVFJJTkddfV19LAogICAgICAgIGZsb29yOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uRmxvb3IsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX05VTUJFUl19XX0sCiAgICAgICAgbGVuZ3RoOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbkxlbmd0aCwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfU1RSSU5HLCBUWVBFX0FSUkFZLCBUWVBFX09CSkVDVF19XX0sCiAgICAgICAgbWFwOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk1hcCwKICAgICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfRVhQUkVGXX0sIHt0eXBlczogW1RZUEVfQVJSQVldfV19LAogICAgICAgIG1heDogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXgsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICJtZXJnZSI6IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uTWVyZ2UsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF0sIHZhcmlhZGljOiB0cnVlfV0KICAgICAgICB9LAogICAgICAgICJtYXhfYnkiOiB7CiAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NYXhCeSwKICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgfSwKICAgICAgICBzdW06IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25TdW0sIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUl19XX0sCiAgICAgICAgInN0YXJ0c193aXRoIjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25TdGFydHNXaXRoLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkddfSwge3R5cGVzOiBbVFlQRV9TVFJJTkddfV19LAogICAgICAgIG1pbjogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NaW4sCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX05VTUJFUiwgVFlQRV9BUlJBWV9TVFJJTkddfV19LAogICAgICAgICJtaW5fYnkiOiB7CiAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25NaW5CeSwKICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZXX0sIHt0eXBlczogW1RZUEVfRVhQUkVGXX1dCiAgICAgICAgfSwKICAgICAgICB0eXBlOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVHlwZSwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICBrZXlzOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uS2V5cywgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfT0JKRUNUXX1dfSwKICAgICAgICB2YWx1ZXM6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25WYWx1ZXMsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX09CSkVDVF19XX0sCiAgICAgICAgc29ydDoge19mdW5jOiB0aGlzLl9mdW5jdGlvblNvcnQsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FSUkFZX1NUUklORywgVFlQRV9BUlJBWV9OVU1CRVJdfV19LAogICAgICAgICJzb3J0X2J5IjogewogICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uU29ydEJ5LAogICAgICAgICAgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQVJSQVldfSwge3R5cGVzOiBbVFlQRV9FWFBSRUZdfV0KICAgICAgICB9LAogICAgICAgIGpvaW46IHsKICAgICAgICAgICAgX2Z1bmM6IHRoaXMuX2Z1bmN0aW9uSm9pbiwKICAgICAgICAgICAgX3NpZ25hdHVyZTogWwogICAgICAgICAgICAgICAge3R5cGVzOiBbVFlQRV9TVFJJTkddfSwKICAgICAgICAgICAgICAgIHt0eXBlczogW1RZUEVfQVJSQVlfU1RSSU5HXX0KICAgICAgICAgICAgXQogICAgICAgIH0sCiAgICAgICAgcmV2ZXJzZTogewogICAgICAgICAgICBfZnVuYzogdGhpcy5fZnVuY3Rpb25SZXZlcnNlLAogICAgICAgICAgICBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9TVFJJTkcsIFRZUEVfQVJSQVldfV19LAogICAgICAgICJ0b19hcnJheSI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub0FycmF5LCBfc2lnbmF0dXJlOiBbe3R5cGVzOiBbVFlQRV9BTlldfV19LAogICAgICAgICJ0b19zdHJpbmciOiB7X2Z1bmM6IHRoaXMuX2Z1bmN0aW9uVG9TdHJpbmcsIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV19XX0sCiAgICAgICAgInRvX251bWJlciI6IHtfZnVuYzogdGhpcy5fZnVuY3Rpb25Ub051bWJlciwgX3NpZ25hdHVyZTogW3t0eXBlczogW1RZUEVfQU5ZXX1dfSwKICAgICAgICAibm90X251bGwiOiB7CiAgICAgICAgICAgIF9mdW5jOiB0aGlzLl9mdW5jdGlvbk5vdE51bGwsCiAgICAgICAgICAgIF9zaWduYXR1cmU6IFt7dHlwZXM6IFtUWVBFX0FOWV0sIHZhcmlhZGljOiB0cnVlfV0KICAgICAgICB9CiAgICB9OwogIH0KCiAgUnVudGltZS5wcm90b3R5cGUgPSB7CiAgICBjYWxsRnVuY3Rpb246IGZ1bmN0aW9uKG5hbWUsIHJlc29sdmVkQXJncykgewogICAgICB2YXIgZnVuY3Rpb25FbnRyeSA9IHRoaXMuZnVuY3Rpb25UYWJsZVtuYW1lXTsKICAgICAgaWYgKGZ1bmN0aW9uRW50cnkgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGZ1bmN0aW9uOiAiICsgbmFtZSArICIoKSIpOwogICAgICB9CiAgICAgIHRoaXMuX3ZhbGlkYXRlQXJncyhuYW1lLCByZXNvbHZlZEFyZ3MsIGZ1bmN0aW9uRW50cnkuX3NpZ25hdHVyZSk7CiAgICAgIHJldHVybiBmdW5jdGlvbkVudHJ5Ll9mdW5jLmNhbGwodGhpcywgcmVzb2x2ZWRBcmdzKTsKICAgIH0sCgogICAgX3ZhbGlkYXRlQXJnczogZnVuY3Rpb24obmFtZSwgYXJncywgc2lnbmF0dXJlKSB7CiAgICAgICAgLy8gVmFsaWRhdGluZyB0aGUgYXJncyByZXF1aXJlcyB2YWxpZGF0aW5nCiAgICAgICAgLy8gdGhlIGNvcnJlY3QgYXJpdHkgYW5kIHRoZSBjb3JyZWN0IHR5cGUgb2YgZWFjaCBhcmcuCiAgICAgICAgLy8gSWYgdGhlIGxhc3QgYXJndW1lbnQgaXMgZGVjbGFyZWQgYXMgdmFyaWFkaWMsIHRoZW4gd2UgbmVlZAogICAgICAgIC8vIGEgbWluaW11bSBudW1iZXIgb2YgYXJncyB0byBiZSByZXF1aXJlZC4gIE90aGVyd2lzZSBpdCBoYXMgdG8KICAgICAgICAvLyBiZSBhbiBleGFjdCBhbW91bnQuCiAgICAgICAgdmFyIHBsdXJhbGl6ZWQ7CiAgICAgICAgaWYgKHNpZ25hdHVyZVtzaWduYXR1cmUubGVuZ3RoIC0gMV0udmFyaWFkaWMpIHsKICAgICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgcGx1cmFsaXplZCA9IHNpZ25hdHVyZS5sZW5ndGggPT09IDEgPyAiIGFyZ3VtZW50IiA6ICIgYXJndW1lbnRzIjsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnRFcnJvcjogIiArIG5hbWUgKyAiKCkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzIGF0IGxlYXN0IiArIHNpZ25hdHVyZS5sZW5ndGggKyBwbHVyYWxpemVkICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCAiICsgYXJncy5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCAhPT0gc2lnbmF0dXJlLmxlbmd0aCkgewogICAgICAgICAgICBwbHVyYWxpemVkID0gc2lnbmF0dXJlLmxlbmd0aCA9PT0gMSA/ICIgYXJndW1lbnQiIDogIiBhcmd1bWVudHMiOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50RXJyb3I6ICIgKyBuYW1lICsgIigpICIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgInRha2VzICIgKyBzaWduYXR1cmUubGVuZ3RoICsgcGx1cmFsaXplZCArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiIGJ1dCByZWNlaXZlZCAiICsgYXJncy5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudFNwZWM7CiAgICAgICAgdmFyIGFjdHVhbFR5cGU7CiAgICAgICAgdmFyIHR5cGVNYXRjaGVkOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2lnbmF0dXJlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHR5cGVNYXRjaGVkID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRTcGVjID0gc2lnbmF0dXJlW2ldLnR5cGVzOwogICAgICAgICAgICBhY3R1YWxUeXBlID0gdGhpcy5fZ2V0VHlwZU5hbWUoYXJnc1tpXSk7CiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY3VycmVudFNwZWMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl90eXBlTWF0Y2hlcyhhY3R1YWxUeXBlLCBjdXJyZW50U3BlY1tqXSwgYXJnc1tpXSkpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlTWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCF0eXBlTWF0Y2hlZCkgewogICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkID0gY3VycmVudFNwZWMKICAgICAgICAgICAgICAgICAgICAubWFwKGZ1bmN0aW9uKHR5cGVJZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX05BTUVfVEFCTEVbdHlwZUlkZW50aWZpZXJdOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLmpvaW4oJywnKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVHlwZUVycm9yOiAiICsgbmFtZSArICIoKSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXhwZWN0ZWQgYXJndW1lbnQgIiArIChpICsgMSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgdG8gYmUgdHlwZSAiICsgZXhwZWN0ZWQgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICIgYnV0IHJlY2VpdmVkIHR5cGUgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVFlQRV9OQU1FX1RBQkxFW2FjdHVhbFR5cGVdICsgIiBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICBfdHlwZU1hdGNoZXM6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIGFyZ1ZhbHVlKSB7CiAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FOWSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGV4cGVjdGVkID09PSBUWVBFX0FSUkFZX1NUUklORyB8fAogICAgICAgICAgICBleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9OVU1CRVIgfHwKICAgICAgICAgICAgZXhwZWN0ZWQgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgLy8gVGhlIGV4cGVjdGVkIHR5cGUgY2FuIGVpdGhlciBqdXN0IGJlIGFycmF5LAogICAgICAgICAgICAvLyBvciBpdCBjYW4gcmVxdWlyZSBhIHNwZWNpZmljIHN1YnR5cGUgKGFycmF5IG9mIG51bWJlcnMpLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBUaGUgc2ltcGxlc3QgY2FzZSBpcyBpZiAiYXJyYXkiIHdpdGggbm8gc3VidHlwZSBpcyBzcGVjaWZpZWQuCiAgICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGFjdHVhbCA9PT0gVFlQRV9BUlJBWTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhY3R1YWwgPT09IFRZUEVfQVJSQVkpIHsKICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSB3ZSBuZWVkIHRvIGNoZWNrIHN1YnR5cGVzLgogICAgICAgICAgICAgICAgLy8gSSB0aGluayB0aGlzIGhhcyBwb3RlbnRpYWwgdG8gYmUgaW1wcm92ZWQuCiAgICAgICAgICAgICAgICB2YXIgc3VidHlwZTsKICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9OVU1CRVIpIHsKICAgICAgICAgICAgICAgICAgc3VidHlwZSA9IFRZUEVfTlVNQkVSOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChleHBlY3RlZCA9PT0gVFlQRV9BUlJBWV9TVFJJTkcpIHsKICAgICAgICAgICAgICAgICAgc3VidHlwZSA9IFRZUEVfU1RSSU5HOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdWYWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5fdHlwZU1hdGNoZXMoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRUeXBlTmFtZShhcmdWYWx1ZVtpXSksIHN1YnR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ1ZhbHVlW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gYWN0dWFsID09PSBleHBlY3RlZDsKICAgICAgICB9CiAgICB9LAogICAgX2dldFR5cGVOYW1lOiBmdW5jdGlvbihvYmopIHsKICAgICAgICBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChvYmopKSB7CiAgICAgICAgICAgIGNhc2UgIltvYmplY3QgU3RyaW5nXSI6CiAgICAgICAgICAgICAgcmV0dXJuIFRZUEVfU1RSSU5HOwogICAgICAgICAgICBjYXNlICJbb2JqZWN0IE51bWJlcl0iOgogICAgICAgICAgICAgIHJldHVybiBUWVBFX05VTUJFUjsKICAgICAgICAgICAgY2FzZSAiW29iamVjdCBBcnJheV0iOgogICAgICAgICAgICAgIHJldHVybiBUWVBFX0FSUkFZOwogICAgICAgICAgICBjYXNlICJbb2JqZWN0IEJvb2xlYW5dIjoKICAgICAgICAgICAgICByZXR1cm4gVFlQRV9CT09MRUFOOwogICAgICAgICAgICBjYXNlICJbb2JqZWN0IE51bGxdIjoKICAgICAgICAgICAgICByZXR1cm4gVFlQRV9OVUxMOwogICAgICAgICAgICBjYXNlICJbb2JqZWN0IE9iamVjdF0iOgogICAgICAgICAgICAgIC8vIENoZWNrIGlmIGl0J3MgYW4gZXhwcmVmLiAgSWYgaXQgaGFzLCBpdCdzIGJlZW4KICAgICAgICAgICAgICAvLyB0YWdnZWQgd2l0aCBhIGptZXNwYXRoVHlwZSBhdHRyIG9mICdFeHByZWYnOwogICAgICAgICAgICAgIGlmIChvYmouam1lc3BhdGhUeXBlID09PSBUT0tfRVhQUkVGKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gVFlQRV9FWFBSRUY7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBUWVBFX09CSkVDVDsKICAgICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25TdGFydHNXaXRoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdLmxhc3RJbmRleE9mKHJlc29sdmVkQXJnc1sxXSkgPT09IDA7CiAgICB9LAoKICAgIF9mdW5jdGlvbkVuZHNXaXRoOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgc2VhcmNoU3RyID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBzdWZmaXggPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgcmV0dXJuIHNlYXJjaFN0ci5pbmRleE9mKHN1ZmZpeCwgc2VhcmNoU3RyLmxlbmd0aCAtIHN1ZmZpeC5sZW5ndGgpICE9PSAtMTsKICAgIH0sCgogICAgX2Z1bmN0aW9uUmV2ZXJzZTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfU1RSSU5HKSB7CiAgICAgICAgICB2YXIgb3JpZ2luYWxTdHIgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIgcmV2ZXJzZWRTdHIgPSAiIjsKICAgICAgICAgIGZvciAodmFyIGkgPSBvcmlnaW5hbFN0ci5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgIHJldmVyc2VkU3RyICs9IG9yaWdpbmFsU3RyW2ldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJldmVyc2VkU3RyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcmV2ZXJzZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXS5zbGljZSgwKTsKICAgICAgICAgIHJldmVyc2VkQXJyYXkucmV2ZXJzZSgpOwogICAgICAgICAgcmV0dXJuIHJldmVyc2VkQXJyYXk7CiAgICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25BYnM6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICByZXR1cm4gTWF0aC5hYnMocmVzb2x2ZWRBcmdzWzBdKTsKICAgIH0sCgogICAgX2Z1bmN0aW9uQ2VpbDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgcmV0dXJuIE1hdGguY2VpbChyZXNvbHZlZEFyZ3NbMF0pOwogICAgfSwKCiAgICBfZnVuY3Rpb25Bdmc6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBzdW0gPSAwOwogICAgICAgIHZhciBpbnB1dEFycmF5ID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBzdW0gKz0gaW5wdXRBcnJheVtpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1bSAvIGlucHV0QXJyYXkubGVuZ3RoOwogICAgfSwKCiAgICBfZnVuY3Rpb25Db250YWluczogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5pbmRleE9mKHJlc29sdmVkQXJnc1sxXSkgPj0gMDsKICAgIH0sCgogICAgX2Z1bmN0aW9uRmxvb3I6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHJlc29sdmVkQXJnc1swXSk7CiAgICB9LAoKICAgIF9mdW5jdGlvbkxlbmd0aDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgICBpZiAoIWlzT2JqZWN0KHJlc29sdmVkQXJnc1swXSkpIHsKICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXS5sZW5ndGg7CiAgICAgICB9IGVsc2UgewogICAgICAgICAvLyBBcyBmYXIgYXMgSSBjYW4gdGVsbCwgdGhlcmUncyBubyB3YXkgdG8gZ2V0IHRoZSBsZW5ndGgKICAgICAgICAgLy8gb2YgYW4gb2JqZWN0IHdpdGhvdXQgTyhuKSBpdGVyYXRpb24gdGhyb3VnaCB0aGUgb2JqZWN0LgogICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVzb2x2ZWRBcmdzWzBdKS5sZW5ndGg7CiAgICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvbk1hcDogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIHZhciBtYXBwZWQgPSBbXTsKICAgICAgdmFyIGludGVycHJldGVyID0gdGhpcy5faW50ZXJwcmV0ZXI7CiAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG1hcHBlZC5wdXNoKGludGVycHJldGVyLnZpc2l0KGV4cHJlZk5vZGUsIGVsZW1lbnRzW2ldKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hcHBlZDsKICAgIH0sCgogICAgX2Z1bmN0aW9uTWVyZ2U6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICB2YXIgbWVyZ2VkID0ge307CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSByZXNvbHZlZEFyZ3NbaV07CiAgICAgICAgZm9yICh2YXIga2V5IGluIGN1cnJlbnQpIHsKICAgICAgICAgIG1lcmdlZFtrZXldID0gY3VycmVudFtrZXldOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWVyZ2VkOwogICAgfSwKCiAgICBfZnVuY3Rpb25NYXg6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICBpZiAocmVzb2x2ZWRBcmdzWzBdLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF1bMF0pOwogICAgICAgIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9OVU1CRVIpIHsKICAgICAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCByZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZWxlbWVudHMgPSByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgICB2YXIgbWF4RWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmIChtYXhFbGVtZW50LmxvY2FsZUNvbXBhcmUoZWxlbWVudHNbaV0pIDwgMCkgewogICAgICAgICAgICAgICAgICBtYXhFbGVtZW50ID0gZWxlbWVudHNbaV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1heEVsZW1lbnQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0sCgogICAgX2Z1bmN0aW9uTWluOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgaWYgKHJlc29sdmVkQXJnc1swXS5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIHR5cGVOYW1lID0gdGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdWzBdKTsKICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkoTWF0aCwgcmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGVsZW1lbnRzID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgdmFyIG1pbkVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBpZiAoZWxlbWVudHNbaV0ubG9jYWxlQ29tcGFyZShtaW5FbGVtZW50KSA8IDApIHsKICAgICAgICAgICAgICAgICAgbWluRWxlbWVudCA9IGVsZW1lbnRzW2ldOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtaW5FbGVtZW50OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25TdW06IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICB2YXIgc3VtID0gMDsKICAgICAgdmFyIGxpc3RUb1N1bSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0VG9TdW0ubGVuZ3RoOyBpKyspIHsKICAgICAgICBzdW0gKz0gbGlzdFRvU3VtW2ldOwogICAgICB9CiAgICAgIHJldHVybiBzdW07CiAgICB9LAoKICAgIF9mdW5jdGlvblR5cGU6IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHN3aXRjaCAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSkgewogICAgICAgICAgY2FzZSBUWVBFX05VTUJFUjoKICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgY2FzZSBUWVBFX1NUUklORzoKICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgICAgY2FzZSBUWVBFX0FSUkFZOgogICAgICAgICAgICByZXR1cm4gImFycmF5IjsKICAgICAgICAgIGNhc2UgVFlQRV9PQkpFQ1Q6CiAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKICAgICAgICAgIGNhc2UgVFlQRV9CT09MRUFOOgogICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwogICAgICAgICAgY2FzZSBUWVBFX0VYUFJFRjoKICAgICAgICAgICAgcmV0dXJuICJleHByZWYiOwogICAgICAgICAgY2FzZSBUWVBFX05VTEw6CiAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgfQogICAgfSwKCiAgICBfZnVuY3Rpb25LZXlzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMocmVzb2x2ZWRBcmdzWzBdKTsKICAgIH0sCgogICAgX2Z1bmN0aW9uVmFsdWVzOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgb2JqID0gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqKTsKICAgICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhbHVlcy5wdXNoKG9ialtrZXlzW2ldXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9LAoKICAgIF9mdW5jdGlvbkpvaW46IGZ1bmN0aW9uKHJlc29sdmVkQXJncykgewogICAgICAgIHZhciBqb2luQ2hhciA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgICB2YXIgbGlzdEpvaW4gPSByZXNvbHZlZEFyZ3NbMV07CiAgICAgICAgcmV0dXJuIGxpc3RKb2luLmpvaW4oam9pbkNoYXIpOwogICAgfSwKCiAgICBfZnVuY3Rpb25Ub0FycmF5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSA9PT0gVFlQRV9BUlJBWSkgewogICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBbcmVzb2x2ZWRBcmdzWzBdXTsKICAgICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvblRvU3RyaW5nOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzWzBdKSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc29sdmVkQXJnc1swXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocmVzb2x2ZWRBcmdzWzBdKTsKICAgICAgICB9CiAgICB9LAoKICAgIF9mdW5jdGlvblRvTnVtYmVyOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgdHlwZU5hbWUgPSB0aGlzLl9nZXRUeXBlTmFtZShyZXNvbHZlZEFyZ3NbMF0pOwogICAgICAgIHZhciBjb252ZXJ0ZWRWYWx1ZTsKICAgICAgICBpZiAodHlwZU5hbWUgPT09IFRZUEVfTlVNQkVSKSB7CiAgICAgICAgICAgIHJldHVybiByZXNvbHZlZEFyZ3NbMF07CiAgICAgICAgfSBlbHNlIGlmICh0eXBlTmFtZSA9PT0gVFlQRV9TVFJJTkcpIHsKICAgICAgICAgICAgY29udmVydGVkVmFsdWUgPSArcmVzb2x2ZWRBcmdzWzBdOwogICAgICAgICAgICBpZiAoIWlzTmFOKGNvbnZlcnRlZFZhbHVlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbnZlcnRlZFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICBfZnVuY3Rpb25Ob3ROdWxsOiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAodGhpcy5fZ2V0VHlwZU5hbWUocmVzb2x2ZWRBcmdzW2ldKSAhPT0gVFlQRV9OVUxMKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZWRBcmdzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICBfZnVuY3Rpb25Tb3J0OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgc29ydGVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgc29ydGVkQXJyYXkuc29ydCgpOwogICAgICAgIHJldHVybiBzb3J0ZWRBcnJheTsKICAgIH0sCgogICAgX2Z1bmN0aW9uU29ydEJ5OiBmdW5jdGlvbihyZXNvbHZlZEFyZ3MpIHsKICAgICAgICB2YXIgc29ydGVkQXJyYXkgPSByZXNvbHZlZEFyZ3NbMF0uc2xpY2UoMCk7CiAgICAgICAgaWYgKHNvcnRlZEFycmF5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gc29ydGVkQXJyYXk7CiAgICAgICAgfQogICAgICAgIHZhciBpbnRlcnByZXRlciA9IHRoaXMuX2ludGVycHJldGVyOwogICAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICAgIHZhciByZXF1aXJlZFR5cGUgPSB0aGlzLl9nZXRUeXBlTmFtZSgKICAgICAgICAgICAgaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgc29ydGVkQXJyYXlbMF0pKTsKICAgICAgICBpZiAoW1RZUEVfTlVNQkVSLCBUWVBFX1NUUklOR10uaW5kZXhPZihyZXF1aXJlZFR5cGUpIDwgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlR5cGVFcnJvciIpOwogICAgICAgIH0KICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CiAgICAgICAgLy8gSW4gb3JkZXIgdG8gZ2V0IGEgc3RhYmxlIHNvcnQgb3V0IG9mIGFuIHVuc3RhYmxlCiAgICAgICAgLy8gc29ydCBhbGdvcml0aG0sIHdlIGRlY29yYXRlL3NvcnQvdW5kZWNvcmF0ZSAoRFNVKQogICAgICAgIC8vIGJ5IGNyZWF0aW5nIGEgbmV3IGxpc3Qgb2YgW2luZGV4LCBlbGVtZW50XSBwYWlycy4KICAgICAgICAvLyBJbiB0aGUgY21wIGZ1bmN0aW9uLCBpZiB0aGUgZXZhbHVhdGVkIGVsZW1lbnRzIGFyZQogICAgICAgIC8vIGVxdWFsLCB0aGVuIHRoZSBpbmRleCB3aWxsIGJlIHVzZWQgYXMgdGhlIHRpZWJyZWFrZXIuCiAgICAgICAgLy8gQWZ0ZXIgdGhlIGRlY29yYXRlZCBsaXN0IGhhcyBiZWVuIHNvcnRlZCwgaXQgd2lsbCBiZQogICAgICAgIC8vIHVuZGVjb3JhdGVkIHRvIGV4dHJhY3QgdGhlIG9yaWdpbmFsIGVsZW1lbnRzLgogICAgICAgIHZhciBkZWNvcmF0ZWQgPSBbXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBkZWNvcmF0ZWQucHVzaChbaSwgc29ydGVkQXJyYXlbaV1dKTsKICAgICAgICB9CiAgICAgICAgZGVjb3JhdGVkLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgdmFyIGV4cHJBID0gaW50ZXJwcmV0ZXIudmlzaXQoZXhwcmVmTm9kZSwgYVsxXSk7CiAgICAgICAgICB2YXIgZXhwckIgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCBiWzFdKTsKICAgICAgICAgIGlmICh0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkgIT09IHJlcXVpcmVkVHlwZSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgIlR5cGVFcnJvcjogZXhwZWN0ZWQgIiArIHJlcXVpcmVkVHlwZSArICIsIHJlY2VpdmVkICIgKwogICAgICAgICAgICAgICAgICB0aGF0Ll9nZXRUeXBlTmFtZShleHByQSkpOwogICAgICAgICAgfSBlbHNlIGlmICh0aGF0Ll9nZXRUeXBlTmFtZShleHByQikgIT09IHJlcXVpcmVkVHlwZSkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgIlR5cGVFcnJvcjogZXhwZWN0ZWQgIiArIHJlcXVpcmVkVHlwZSArICIsIHJlY2VpdmVkICIgKwogICAgICAgICAgICAgICAgICB0aGF0Ll9nZXRUeXBlTmFtZShleHByQikpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4cHJBID4gZXhwckIpIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9IGVsc2UgaWYgKGV4cHJBIDwgZXhwckIpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgdGhleSdyZSBlcXVhbCBjb21wYXJlIHRoZSBpdGVtcyBieSB0aGVpcgogICAgICAgICAgICAvLyBvcmRlciB0byBtYWludGFpbiByZWxhdGl2ZSBvcmRlciBvZiBlcXVhbCBrZXlzCiAgICAgICAgICAgIC8vIChpLmUuIHRvIGdldCBhIHN0YWJsZSBzb3J0KS4KICAgICAgICAgICAgcmV0dXJuIGFbMF0gLSBiWzBdOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIC8vIFVuZGVjb3JhdGU6IGV4dHJhY3Qgb3V0IHRoZSBvcmlnaW5hbCBsaXN0IGVsZW1lbnRzLgogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgZGVjb3JhdGVkLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBzb3J0ZWRBcnJheVtqXSA9IGRlY29yYXRlZFtqXVsxXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNvcnRlZEFycmF5OwogICAgfSwKCiAgICBfZnVuY3Rpb25NYXhCeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICB2YXIgcmVzb2x2ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgdmFyIGtleUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVLZXlGdW5jdGlvbihleHByZWZOb2RlLCBbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXSk7CiAgICAgIHZhciBtYXhOdW1iZXIgPSAtSW5maW5pdHk7CiAgICAgIHZhciBtYXhSZWNvcmQ7CiAgICAgIHZhciBjdXJyZW50OwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVkQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICBjdXJyZW50ID0ga2V5RnVuY3Rpb24ocmVzb2x2ZWRBcnJheVtpXSk7CiAgICAgICAgaWYgKGN1cnJlbnQgPiBtYXhOdW1iZXIpIHsKICAgICAgICAgIG1heE51bWJlciA9IGN1cnJlbnQ7CiAgICAgICAgICBtYXhSZWNvcmQgPSByZXNvbHZlZEFycmF5W2ldOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbWF4UmVjb3JkOwogICAgfSwKCiAgICBfZnVuY3Rpb25NaW5CeTogZnVuY3Rpb24ocmVzb2x2ZWRBcmdzKSB7CiAgICAgIHZhciBleHByZWZOb2RlID0gcmVzb2x2ZWRBcmdzWzFdOwogICAgICB2YXIgcmVzb2x2ZWRBcnJheSA9IHJlc29sdmVkQXJnc1swXTsKICAgICAgdmFyIGtleUZ1bmN0aW9uID0gdGhpcy5jcmVhdGVLZXlGdW5jdGlvbihleHByZWZOb2RlLCBbVFlQRV9OVU1CRVIsIFRZUEVfU1RSSU5HXSk7CiAgICAgIHZhciBtaW5OdW1iZXIgPSBJbmZpbml0eTsKICAgICAgdmFyIG1pblJlY29yZDsKICAgICAgdmFyIGN1cnJlbnQ7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzb2x2ZWRBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgIGN1cnJlbnQgPSBrZXlGdW5jdGlvbihyZXNvbHZlZEFycmF5W2ldKTsKICAgICAgICBpZiAoY3VycmVudCA8IG1pbk51bWJlcikgewogICAgICAgICAgbWluTnVtYmVyID0gY3VycmVudDsKICAgICAgICAgIG1pblJlY29yZCA9IHJlc29sdmVkQXJyYXlbaV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtaW5SZWNvcmQ7CiAgICB9LAoKICAgIGNyZWF0ZUtleUZ1bmN0aW9uOiBmdW5jdGlvbihleHByZWZOb2RlLCBhbGxvd2VkVHlwZXMpIHsKICAgICAgdmFyIHRoYXQgPSB0aGlzOwogICAgICB2YXIgaW50ZXJwcmV0ZXIgPSB0aGlzLl9pbnRlcnByZXRlcjsKICAgICAgdmFyIGtleUZ1bmMgPSBmdW5jdGlvbih4KSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBpbnRlcnByZXRlci52aXNpdChleHByZWZOb2RlLCB4KTsKICAgICAgICBpZiAoYWxsb3dlZFR5cGVzLmluZGV4T2YodGhhdC5fZ2V0VHlwZU5hbWUoY3VycmVudCkpIDwgMCkgewogICAgICAgICAgdmFyIG1zZyA9ICJUeXBlRXJyb3I6IGV4cGVjdGVkIG9uZSBvZiAiICsgYWxsb3dlZFR5cGVzICsKICAgICAgICAgICAgICAgICAgICAiLCByZWNlaXZlZCAiICsgdGhhdC5fZ2V0VHlwZU5hbWUoY3VycmVudCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGN1cnJlbnQ7CiAgICAgIH07CiAgICAgIHJldHVybiBrZXlGdW5jOwogICAgfQoKICB9OwoKICBmdW5jdGlvbiBjb21waWxlKHN0cmVhbSkgewogICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIoKTsKICAgIHZhciBhc3QgPSBwYXJzZXIucGFyc2Uoc3RyZWFtKTsKICAgIHJldHVybiBhc3Q7CiAgfQoKICBmdW5jdGlvbiB0b2tlbml6ZShzdHJlYW0pIHsKICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCk7CiAgICAgIHJldHVybiBsZXhlci50b2tlbml6ZShzdHJlYW0pOwogIH0KCiAgZnVuY3Rpb24gc2VhcmNoKGRhdGEsIGV4cHJlc3Npb24pIHsKICAgICAgdmFyIHBhcnNlciA9IG5ldyBQYXJzZXIoKTsKICAgICAgLy8gVGhpcyBuZWVkcyB0byBiZSBpbXByb3ZlZC4gIEJvdGggdGhlIGludGVycHJldGVyIGFuZCBydW50aW1lIGRlcGVuZCBvbgogICAgICAvLyBlYWNoIG90aGVyLiAgVGhlIHJ1bnRpbWUgbmVlZHMgdGhlIGludGVycHJldGVyIHRvIHN1cHBvcnQgZXhwcmVmcy4KICAgICAgLy8gVGhlcmUncyBsaWtlbHkgYSBjbGVhbiB3YXkgdG8gYXZvaWQgdGhlIGN5Y2xpYyBkZXBlbmRlbmN5LgogICAgICB2YXIgcnVudGltZSA9IG5ldyBSdW50aW1lKCk7CiAgICAgIHZhciBpbnRlcnByZXRlciA9IG5ldyBUcmVlSW50ZXJwcmV0ZXIocnVudGltZSk7CiAgICAgIHJ1bnRpbWUuX2ludGVycHJldGVyID0gaW50ZXJwcmV0ZXI7CiAgICAgIHZhciBub2RlID0gcGFyc2VyLnBhcnNlKGV4cHJlc3Npb24pOwogICAgICByZXR1cm4gaW50ZXJwcmV0ZXIuc2VhcmNoKG5vZGUsIGRhdGEpOwogIH0KCiAgZXhwb3J0cy50b2tlbml6ZSA9IHRva2VuaXplOwogIGV4cG9ydHMuY29tcGlsZSA9IGNvbXBpbGU7CiAgZXhwb3J0cy5zZWFyY2ggPSBzZWFyY2g7CiAgZXhwb3J0cy5zdHJpY3REZWVwRXF1YWwgPSBzdHJpY3REZWVwRXF1YWw7Cn0pKHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiA/IHRoaXMuam1lc3BhdGggPSB7fSA6IGV4cG9ydHMpOwoKfSx7fV0sODk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBzaGltIGZvciB1c2luZyBwcm9jZXNzIGluIGJyb3dzZXIKdmFyIHByb2Nlc3MgPSBtb2R1bGUuZXhwb3J0cyA9IHt9OwoKLy8gY2FjaGVkIGZyb20gd2hhdGV2ZXIgZ2xvYmFsIGlzIHByZXNlbnQgc28gdGhhdCB0ZXN0IHJ1bm5lcnMgdGhhdCBzdHViIGl0Ci8vIGRvbid0IGJyZWFrIHRoaW5ncy4gIEJ1dCB3ZSBuZWVkIHRvIHdyYXAgaXQgaW4gYSB0cnkgY2F0Y2ggaW4gY2FzZSBpdCBpcwovLyB3cmFwcGVkIGluIHN0cmljdCBtb2RlIGNvZGUgd2hpY2ggZG9lc24ndCBkZWZpbmUgYW55IGdsb2JhbHMuICBJdCdzIGluc2lkZSBhCi8vIGZ1bmN0aW9uIGJlY2F1c2UgdHJ5L2NhdGNoZXMgZGVvcHRpbWl6ZSBpbiBjZXJ0YWluIGVuZ2luZXMuCgp2YXIgY2FjaGVkU2V0VGltZW91dDsKdmFyIGNhY2hlZENsZWFyVGltZW91dDsKCmZ1bmN0aW9uIGRlZmF1bHRTZXRUaW1vdXQoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3NldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQnKTsKfQpmdW5jdGlvbiBkZWZhdWx0Q2xlYXJUaW1lb3V0ICgpIHsKICAgIHRocm93IG5ldyBFcnJvcignY2xlYXJUaW1lb3V0IGhhcyBub3QgYmVlbiBkZWZpbmVkJyk7Cn0KKGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKHR5cGVvZiBzZXRUaW1lb3V0ID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNhY2hlZFNldFRpbWVvdXQgPSBkZWZhdWx0U2V0VGltb3V0OwogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjYWNoZWRTZXRUaW1lb3V0ID0gZGVmYXVsdFNldFRpbW91dDsKICAgIH0KICAgIHRyeSB7CiAgICAgICAgaWYgKHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY2FjaGVkQ2xlYXJUaW1lb3V0ID0gY2xlYXJUaW1lb3V0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGRlZmF1bHRDbGVhclRpbWVvdXQ7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGRlZmF1bHRDbGVhclRpbWVvdXQ7CiAgICB9Cn0gKCkpCmZ1bmN0aW9uIHJ1blRpbWVvdXQoZnVuKSB7CiAgICBpZiAoY2FjaGVkU2V0VGltZW91dCA9PT0gc2V0VGltZW91dCkgewogICAgICAgIC8vbm9ybWFsIGVudmlyb21lbnRzIGluIHNhbmUgc2l0dWF0aW9ucwogICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1biwgMCk7CiAgICB9CiAgICAvLyBpZiBzZXRUaW1lb3V0IHdhc24ndCBhdmFpbGFibGUgYnV0IHdhcyBsYXR0ZXIgZGVmaW5lZAogICAgaWYgKChjYWNoZWRTZXRUaW1lb3V0ID09PSBkZWZhdWx0U2V0VGltb3V0IHx8ICFjYWNoZWRTZXRUaW1lb3V0KSAmJiBzZXRUaW1lb3V0KSB7CiAgICAgICAgY2FjaGVkU2V0VGltZW91dCA9IHNldFRpbWVvdXQ7CiAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuLCAwKTsKICAgIH0KICAgIHRyeSB7CiAgICAgICAgLy8gd2hlbiB3aGVuIHNvbWVib2R5IGhhcyBzY3Jld2VkIHdpdGggc2V0VGltZW91dCBidXQgbm8gSS5FLiBtYWRkbmVzcwogICAgICAgIHJldHVybiBjYWNoZWRTZXRUaW1lb3V0KGZ1biwgMCk7CiAgICB9IGNhdGNoKGUpewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIFdoZW4gd2UgYXJlIGluIEkuRS4gYnV0IHRoZSBzY3JpcHQgaGFzIGJlZW4gZXZhbGVkIHNvIEkuRS4gZG9lc24ndCB0cnVzdCB0aGUgZ2xvYmFsIG9iamVjdCB3aGVuIGNhbGxlZCBub3JtYWxseQogICAgICAgICAgICByZXR1cm4gY2FjaGVkU2V0VGltZW91dC5jYWxsKG51bGwsIGZ1biwgMCk7CiAgICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZSBidXQgd2hlbiBpdCdzIGEgdmVyc2lvbiBvZiBJLkUuIHRoYXQgbXVzdCBoYXZlIHRoZSBnbG9iYWwgb2JqZWN0IGZvciAndGhpcycsIGhvcGZ1bGx5IG91ciBjb250ZXh0IGNvcnJlY3Qgb3RoZXJ3aXNlIGl0IHdpbGwgdGhyb3cgYSBnbG9iYWwgZXJyb3IKICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFNldFRpbWVvdXQuY2FsbCh0aGlzLCBmdW4sIDApOwogICAgICAgIH0KICAgIH0KCgp9CmZ1bmN0aW9uIHJ1bkNsZWFyVGltZW91dChtYXJrZXIpIHsKICAgIGlmIChjYWNoZWRDbGVhclRpbWVvdXQgPT09IGNsZWFyVGltZW91dCkgewogICAgICAgIC8vbm9ybWFsIGVudmlyb21lbnRzIGluIHNhbmUgc2l0dWF0aW9ucwogICAgICAgIHJldHVybiBjbGVhclRpbWVvdXQobWFya2VyKTsKICAgIH0KICAgIC8vIGlmIGNsZWFyVGltZW91dCB3YXNuJ3QgYXZhaWxhYmxlIGJ1dCB3YXMgbGF0dGVyIGRlZmluZWQKICAgIGlmICgoY2FjaGVkQ2xlYXJUaW1lb3V0ID09PSBkZWZhdWx0Q2xlYXJUaW1lb3V0IHx8ICFjYWNoZWRDbGVhclRpbWVvdXQpICYmIGNsZWFyVGltZW91dCkgewogICAgICAgIGNhY2hlZENsZWFyVGltZW91dCA9IGNsZWFyVGltZW91dDsKICAgICAgICByZXR1cm4gY2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICB9CiAgICB0cnkgewogICAgICAgIC8vIHdoZW4gd2hlbiBzb21lYm9keSBoYXMgc2NyZXdlZCB3aXRoIHNldFRpbWVvdXQgYnV0IG5vIEkuRS4gbWFkZG5lc3MKICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0KG1hcmtlcik7CiAgICB9IGNhdGNoIChlKXsKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBXaGVuIHdlIGFyZSBpbiBJLkUuIGJ1dCB0aGUgc2NyaXB0IGhhcyBiZWVuIGV2YWxlZCBzbyBJLkUuIGRvZXNuJ3QgIHRydXN0IHRoZSBnbG9iYWwgb2JqZWN0IHdoZW4gY2FsbGVkIG5vcm1hbGx5CiAgICAgICAgICAgIHJldHVybiBjYWNoZWRDbGVhclRpbWVvdXQuY2FsbChudWxsLCBtYXJrZXIpOwogICAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgICAgICAvLyBzYW1lIGFzIGFib3ZlIGJ1dCB3aGVuIGl0J3MgYSB2ZXJzaW9uIG9mIEkuRS4gdGhhdCBtdXN0IGhhdmUgdGhlIGdsb2JhbCBvYmplY3QgZm9yICd0aGlzJywgaG9wZnVsbHkgb3VyIGNvbnRleHQgY29ycmVjdCBvdGhlcndpc2UgaXQgd2lsbCB0aHJvdyBhIGdsb2JhbCBlcnJvci4KICAgICAgICAgICAgLy8gU29tZSB2ZXJzaW9ucyBvZiBJLkUuIGhhdmUgZGlmZmVyZW50IHJ1bGVzIGZvciBjbGVhclRpbWVvdXQgdnMgc2V0VGltZW91dAogICAgICAgICAgICByZXR1cm4gY2FjaGVkQ2xlYXJUaW1lb3V0LmNhbGwodGhpcywgbWFya2VyKTsKICAgICAgICB9CiAgICB9CgoKCn0KdmFyIHF1ZXVlID0gW107CnZhciBkcmFpbmluZyA9IGZhbHNlOwp2YXIgY3VycmVudFF1ZXVlOwp2YXIgcXVldWVJbmRleCA9IC0xOwoKZnVuY3Rpb24gY2xlYW5VcE5leHRUaWNrKCkgewogICAgaWYgKCFkcmFpbmluZyB8fCAhY3VycmVudFF1ZXVlKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgIGlmIChjdXJyZW50UXVldWUubGVuZ3RoKSB7CiAgICAgICAgcXVldWUgPSBjdXJyZW50UXVldWUuY29uY2F0KHF1ZXVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcXVldWVJbmRleCA9IC0xOwogICAgfQogICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgIGRyYWluUXVldWUoKTsKICAgIH0KfQoKZnVuY3Rpb24gZHJhaW5RdWV1ZSgpIHsKICAgIGlmIChkcmFpbmluZykgewogICAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB0aW1lb3V0ID0gcnVuVGltZW91dChjbGVhblVwTmV4dFRpY2spOwogICAgZHJhaW5pbmcgPSB0cnVlOwoKICAgIHZhciBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICB3aGlsZShsZW4pIHsKICAgICAgICBjdXJyZW50UXVldWUgPSBxdWV1ZTsKICAgICAgICBxdWV1ZSA9IFtdOwogICAgICAgIHdoaWxlICgrK3F1ZXVlSW5kZXggPCBsZW4pIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlW3F1ZXVlSW5kZXhdLnJ1bigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHF1ZXVlSW5kZXggPSAtMTsKICAgICAgICBsZW4gPSBxdWV1ZS5sZW5ndGg7CiAgICB9CiAgICBjdXJyZW50UXVldWUgPSBudWxsOwogICAgZHJhaW5pbmcgPSBmYWxzZTsKICAgIHJ1bkNsZWFyVGltZW91dCh0aW1lb3V0KTsKfQoKcHJvY2Vzcy5uZXh0VGljayA9IGZ1bmN0aW9uIChmdW4pIHsKICAgIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGggLSAxKTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgIH0KICAgIHF1ZXVlLnB1c2gobmV3IEl0ZW0oZnVuLCBhcmdzKSk7CiAgICBpZiAocXVldWUubGVuZ3RoID09PSAxICYmICFkcmFpbmluZykgewogICAgICAgIHJ1blRpbWVvdXQoZHJhaW5RdWV1ZSk7CiAgICB9Cn07CgovLyB2OCBsaWtlcyBwcmVkaWN0aWJsZSBvYmplY3RzCmZ1bmN0aW9uIEl0ZW0oZnVuLCBhcnJheSkgewogICAgdGhpcy5mdW4gPSBmdW47CiAgICB0aGlzLmFycmF5ID0gYXJyYXk7Cn0KSXRlbS5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5mdW4uYXBwbHkobnVsbCwgdGhpcy5hcnJheSk7Cn07CnByb2Nlc3MudGl0bGUgPSAnYnJvd3Nlcic7CnByb2Nlc3MuYnJvd3NlciA9IHRydWU7CnByb2Nlc3MuZW52ID0ge307CnByb2Nlc3MuYXJndiA9IFtdOwpwcm9jZXNzLnZlcnNpb24gPSAnJzsgLy8gZW1wdHkgc3RyaW5nIHRvIGF2b2lkIHJlZ2V4cCBpc3N1ZXMKcHJvY2Vzcy52ZXJzaW9ucyA9IHt9OwoKZnVuY3Rpb24gbm9vcCgpIHt9Cgpwcm9jZXNzLm9uID0gbm9vcDsKcHJvY2Vzcy5hZGRMaXN0ZW5lciA9IG5vb3A7CnByb2Nlc3Mub25jZSA9IG5vb3A7CnByb2Nlc3Mub2ZmID0gbm9vcDsKcHJvY2Vzcy5yZW1vdmVMaXN0ZW5lciA9IG5vb3A7CnByb2Nlc3MucmVtb3ZlQWxsTGlzdGVuZXJzID0gbm9vcDsKcHJvY2Vzcy5lbWl0ID0gbm9vcDsKcHJvY2Vzcy5wcmVwZW5kTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLnByZXBlbmRPbmNlTGlzdGVuZXIgPSBub29wOwoKcHJvY2Vzcy5saXN0ZW5lcnMgPSBmdW5jdGlvbiAobmFtZSkgeyByZXR1cm4gW10gfQoKcHJvY2Vzcy5iaW5kaW5nID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5iaW5kaW5nIGlzIG5vdCBzdXBwb3J0ZWQnKTsKfTsKCnByb2Nlc3MuY3dkID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gJy8nIH07CnByb2Nlc3MuY2hkaXIgPSBmdW5jdGlvbiAoZGlyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3MuY2hkaXIgaXMgbm90IHN1cHBvcnRlZCcpOwp9Owpwcm9jZXNzLnVtYXNrID0gZnVuY3Rpb24oKSB7IHJldHVybiAwOyB9OwoKfSx7fV0sOTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKGdsb2JhbCl7KGZ1bmN0aW9uICgpewovKiEgaHR0cHM6Ly9tdGhzLmJlL3B1bnljb2RlIHYxLjMuMiBieSBAbWF0aGlhcyAqLwo7KGZ1bmN0aW9uKHJvb3QpIHsKCgkvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGVzICovCgl2YXIgZnJlZUV4cG9ydHMgPSB0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JyAmJiBleHBvcnRzICYmCgkJIWV4cG9ydHMubm9kZVR5cGUgJiYgZXhwb3J0czsKCXZhciBmcmVlTW9kdWxlID0gdHlwZW9mIG1vZHVsZSA9PSAnb2JqZWN0JyAmJiBtb2R1bGUgJiYKCQkhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKCXZhciBmcmVlR2xvYmFsID0gdHlwZW9mIGdsb2JhbCA9PSAnb2JqZWN0JyAmJiBnbG9iYWw7CglpZiAoCgkJZnJlZUdsb2JhbC5nbG9iYWwgPT09IGZyZWVHbG9iYWwgfHwKCQlmcmVlR2xvYmFsLndpbmRvdyA9PT0gZnJlZUdsb2JhbCB8fAoJCWZyZWVHbG9iYWwuc2VsZiA9PT0gZnJlZUdsb2JhbAoJKSB7CgkJcm9vdCA9IGZyZWVHbG9iYWw7Cgl9CgoJLyoqCgkgKiBUaGUgYHB1bnljb2RlYCBvYmplY3QuCgkgKiBAbmFtZSBwdW55Y29kZQoJICogQHR5cGUgT2JqZWN0CgkgKi8KCXZhciBwdW55Y29kZSwKCgkvKiogSGlnaGVzdCBwb3NpdGl2ZSBzaWduZWQgMzItYml0IGZsb2F0IHZhbHVlICovCgltYXhJbnQgPSAyMTQ3NDgzNjQ3LCAvLyBha2EuIDB4N0ZGRkZGRkYgb3IgMl4zMS0xCgoJLyoqIEJvb3RzdHJpbmcgcGFyYW1ldGVycyAqLwoJYmFzZSA9IDM2LAoJdE1pbiA9IDEsCgl0TWF4ID0gMjYsCglza2V3ID0gMzgsCglkYW1wID0gNzAwLAoJaW5pdGlhbEJpYXMgPSA3MiwKCWluaXRpYWxOID0gMTI4LCAvLyAweDgwCglkZWxpbWl0ZXIgPSAnLScsIC8vICdceDJEJwoKCS8qKiBSZWd1bGFyIGV4cHJlc3Npb25zICovCglyZWdleFB1bnljb2RlID0gL154bi0tLywKCXJlZ2V4Tm9uQVNDSUkgPSAvW15ceDIwLVx4N0VdLywgLy8gdW5wcmludGFibGUgQVNDSUkgY2hhcnMgKyBub24tQVNDSUkgY2hhcnMKCXJlZ2V4U2VwYXJhdG9ycyA9IC9bXHgyRVx1MzAwMlx1RkYwRVx1RkY2MV0vZywgLy8gUkZDIDM0OTAgc2VwYXJhdG9ycwoKCS8qKiBFcnJvciBtZXNzYWdlcyAqLwoJZXJyb3JzID0gewoJCSdvdmVyZmxvdyc6ICdPdmVyZmxvdzogaW5wdXQgbmVlZHMgd2lkZXIgaW50ZWdlcnMgdG8gcHJvY2VzcycsCgkJJ25vdC1iYXNpYyc6ICdJbGxlZ2FsIGlucHV0ID49IDB4ODAgKG5vdCBhIGJhc2ljIGNvZGUgcG9pbnQpJywKCQknaW52YWxpZC1pbnB1dCc6ICdJbnZhbGlkIGlucHV0JwoJfSwKCgkvKiogQ29udmVuaWVuY2Ugc2hvcnRjdXRzICovCgliYXNlTWludXNUTWluID0gYmFzZSAtIHRNaW4sCglmbG9vciA9IE1hdGguZmxvb3IsCglzdHJpbmdGcm9tQ2hhckNvZGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLAoKCS8qKiBUZW1wb3JhcnkgdmFyaWFibGUgKi8KCWtleTsKCgkvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCgkvKioKCSAqIEEgZ2VuZXJpYyBlcnJvciB1dGlsaXR5IGZ1bmN0aW9uLgoJICogQHByaXZhdGUKCSAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlIFRoZSBlcnJvciB0eXBlLgoJICogQHJldHVybnMge0Vycm9yfSBUaHJvd3MgYSBgUmFuZ2VFcnJvcmAgd2l0aCB0aGUgYXBwbGljYWJsZSBlcnJvciBtZXNzYWdlLgoJICovCglmdW5jdGlvbiBlcnJvcih0eXBlKSB7CgkJdGhyb3cgUmFuZ2VFcnJvcihlcnJvcnNbdHlwZV0pOwoJfQoKCS8qKgoJICogQSBnZW5lcmljIGBBcnJheSNtYXBgIHV0aWxpdHkgZnVuY3Rpb24uCgkgKiBAcHJpdmF0ZQoJICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGl0ZXJhdGUgb3Zlci4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0aGF0IGdldHMgY2FsbGVkIGZvciBldmVyeSBhcnJheQoJICogaXRlbS4KCSAqIEByZXR1cm5zIHtBcnJheX0gQSBuZXcgYXJyYXkgb2YgdmFsdWVzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFjayBmdW5jdGlvbi4KCSAqLwoJZnVuY3Rpb24gbWFwKGFycmF5LCBmbikgewoJCXZhciBsZW5ndGggPSBhcnJheS5sZW5ndGg7CgkJdmFyIHJlc3VsdCA9IFtdOwoJCXdoaWxlIChsZW5ndGgtLSkgewoJCQlyZXN1bHRbbGVuZ3RoXSA9IGZuKGFycmF5W2xlbmd0aF0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfQoKCS8qKgoJICogQSBzaW1wbGUgYEFycmF5I21hcGAtbGlrZSB3cmFwcGVyIHRvIHdvcmsgd2l0aCBkb21haW4gbmFtZSBzdHJpbmdzIG9yIGVtYWlsCgkgKiBhZGRyZXNzZXMuCgkgKiBAcHJpdmF0ZQoJICogQHBhcmFtIHtTdHJpbmd9IGRvbWFpbiBUaGUgZG9tYWluIG5hbWUgb3IgZW1haWwgYWRkcmVzcy4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0aGF0IGdldHMgY2FsbGVkIGZvciBldmVyeQoJICogY2hhcmFjdGVyLgoJICogQHJldHVybnMge0FycmF5fSBBIG5ldyBzdHJpbmcgb2YgY2hhcmFjdGVycyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2sKCSAqIGZ1bmN0aW9uLgoJICovCglmdW5jdGlvbiBtYXBEb21haW4oc3RyaW5nLCBmbikgewoJCXZhciBwYXJ0cyA9IHN0cmluZy5zcGxpdCgnQCcpOwoJCXZhciByZXN1bHQgPSAnJzsKCQlpZiAocGFydHMubGVuZ3RoID4gMSkgewoJCQkvLyBJbiBlbWFpbCBhZGRyZXNzZXMsIG9ubHkgdGhlIGRvbWFpbiBuYW1lIHNob3VsZCBiZSBwdW55Y29kZWQuIExlYXZlCgkJCS8vIHRoZSBsb2NhbCBwYXJ0IChpLmUuIGV2ZXJ5dGhpbmcgdXAgdG8gYEBgKSBpbnRhY3QuCgkJCXJlc3VsdCA9IHBhcnRzWzBdICsgJ0AnOwoJCQlzdHJpbmcgPSBwYXJ0c1sxXTsKCQl9CgkJLy8gQXZvaWQgYHNwbGl0KHJlZ2V4KWAgZm9yIElFOCBjb21wYXRpYmlsaXR5LiBTZWUgIzE3LgoJCXN0cmluZyA9IHN0cmluZy5yZXBsYWNlKHJlZ2V4U2VwYXJhdG9ycywgJ1x4MkUnKTsKCQl2YXIgbGFiZWxzID0gc3RyaW5nLnNwbGl0KCcuJyk7CgkJdmFyIGVuY29kZWQgPSBtYXAobGFiZWxzLCBmbikuam9pbignLicpOwoJCXJldHVybiByZXN1bHQgKyBlbmNvZGVkOwoJfQoKCS8qKgoJICogQ3JlYXRlcyBhbiBhcnJheSBjb250YWluaW5nIHRoZSBudW1lcmljIGNvZGUgcG9pbnRzIG9mIGVhY2ggVW5pY29kZQoJICogY2hhcmFjdGVyIGluIHRoZSBzdHJpbmcuIFdoaWxlIEphdmFTY3JpcHQgdXNlcyBVQ1MtMiBpbnRlcm5hbGx5LAoJICogdGhpcyBmdW5jdGlvbiB3aWxsIGNvbnZlcnQgYSBwYWlyIG9mIHN1cnJvZ2F0ZSBoYWx2ZXMgKGVhY2ggb2Ygd2hpY2gKCSAqIFVDUy0yIGV4cG9zZXMgYXMgc2VwYXJhdGUgY2hhcmFjdGVycykgaW50byBhIHNpbmdsZSBjb2RlIHBvaW50LAoJICogbWF0Y2hpbmcgVVRGLTE2LgoJICogQHNlZSBgcHVueWNvZGUudWNzMi5lbmNvZGVgCgkgKiBAc2VlIDxodHRwczovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvamF2YXNjcmlwdC1lbmNvZGluZz4KCSAqIEBtZW1iZXJPZiBwdW55Y29kZS51Y3MyCgkgKiBAbmFtZSBkZWNvZGUKCSAqIEBwYXJhbSB7U3RyaW5nfSBzdHJpbmcgVGhlIFVuaWNvZGUgaW5wdXQgc3RyaW5nIChVQ1MtMikuCgkgKiBAcmV0dXJucyB7QXJyYXl9IFRoZSBuZXcgYXJyYXkgb2YgY29kZSBwb2ludHMuCgkgKi8KCWZ1bmN0aW9uIHVjczJkZWNvZGUoc3RyaW5nKSB7CgkJdmFyIG91dHB1dCA9IFtdLAoJCSAgICBjb3VudGVyID0gMCwKCQkgICAgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aCwKCQkgICAgdmFsdWUsCgkJICAgIGV4dHJhOwoJCXdoaWxlIChjb3VudGVyIDwgbGVuZ3RoKSB7CgkJCXZhbHVlID0gc3RyaW5nLmNoYXJDb2RlQXQoY291bnRlcisrKTsKCQkJaWYgKHZhbHVlID49IDB4RDgwMCAmJiB2YWx1ZSA8PSAweERCRkYgJiYgY291bnRlciA8IGxlbmd0aCkgewoJCQkJLy8gaGlnaCBzdXJyb2dhdGUsIGFuZCB0aGVyZSBpcyBhIG5leHQgY2hhcmFjdGVyCgkJCQlleHRyYSA9IHN0cmluZy5jaGFyQ29kZUF0KGNvdW50ZXIrKyk7CgkJCQlpZiAoKGV4dHJhICYgMHhGQzAwKSA9PSAweERDMDApIHsgLy8gbG93IHN1cnJvZ2F0ZQoJCQkJCW91dHB1dC5wdXNoKCgodmFsdWUgJiAweDNGRikgPDwgMTApICsgKGV4dHJhICYgMHgzRkYpICsgMHgxMDAwMCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHVubWF0Y2hlZCBzdXJyb2dhdGU7IG9ubHkgYXBwZW5kIHRoaXMgY29kZSB1bml0LCBpbiBjYXNlIHRoZSBuZXh0CgkJCQkJLy8gY29kZSB1bml0IGlzIHRoZSBoaWdoIHN1cnJvZ2F0ZSBvZiBhIHN1cnJvZ2F0ZSBwYWlyCgkJCQkJb3V0cHV0LnB1c2godmFsdWUpOwoJCQkJCWNvdW50ZXItLTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCW91dHB1dC5wdXNoKHZhbHVlKTsKCQkJfQoJCX0KCQlyZXR1cm4gb3V0cHV0OwoJfQoKCS8qKgoJICogQ3JlYXRlcyBhIHN0cmluZyBiYXNlZCBvbiBhbiBhcnJheSBvZiBudW1lcmljIGNvZGUgcG9pbnRzLgoJICogQHNlZSBgcHVueWNvZGUudWNzMi5kZWNvZGVgCgkgKiBAbWVtYmVyT2YgcHVueWNvZGUudWNzMgoJICogQG5hbWUgZW5jb2RlCgkgKiBAcGFyYW0ge0FycmF5fSBjb2RlUG9pbnRzIFRoZSBhcnJheSBvZiBudW1lcmljIGNvZGUgcG9pbnRzLgoJICogQHJldHVybnMge1N0cmluZ30gVGhlIG5ldyBVbmljb2RlIHN0cmluZyAoVUNTLTIpLgoJICovCglmdW5jdGlvbiB1Y3MyZW5jb2RlKGFycmF5KSB7CgkJcmV0dXJuIG1hcChhcnJheSwgZnVuY3Rpb24odmFsdWUpIHsKCQkJdmFyIG91dHB1dCA9ICcnOwoJCQlpZiAodmFsdWUgPiAweEZGRkYpIHsKCQkJCXZhbHVlIC09IDB4MTAwMDA7CgkJCQlvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlID4+PiAxMCAmIDB4M0ZGIHwgMHhEODAwKTsKCQkJCXZhbHVlID0gMHhEQzAwIHwgdmFsdWUgJiAweDNGRjsKCQkJfQoJCQlvdXRwdXQgKz0gc3RyaW5nRnJvbUNoYXJDb2RlKHZhbHVlKTsKCQkJcmV0dXJuIG91dHB1dDsKCQl9KS5qb2luKCcnKTsKCX0KCgkvKioKCSAqIENvbnZlcnRzIGEgYmFzaWMgY29kZSBwb2ludCBpbnRvIGEgZGlnaXQvaW50ZWdlci4KCSAqIEBzZWUgYGRpZ2l0VG9CYXNpYygpYAoJICogQHByaXZhdGUKCSAqIEBwYXJhbSB7TnVtYmVyfSBjb2RlUG9pbnQgVGhlIGJhc2ljIG51bWVyaWMgY29kZSBwb2ludCB2YWx1ZS4KCSAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBudW1lcmljIHZhbHVlIG9mIGEgYmFzaWMgY29kZSBwb2ludCAoZm9yIHVzZSBpbgoJICogcmVwcmVzZW50aW5nIGludGVnZXJzKSBpbiB0aGUgcmFuZ2UgYDBgIHRvIGBiYXNlIC0gMWAsIG9yIGBiYXNlYCBpZgoJICogdGhlIGNvZGUgcG9pbnQgZG9lcyBub3QgcmVwcmVzZW50IGEgdmFsdWUuCgkgKi8KCWZ1bmN0aW9uIGJhc2ljVG9EaWdpdChjb2RlUG9pbnQpIHsKCQlpZiAoY29kZVBvaW50IC0gNDggPCAxMCkgewoJCQlyZXR1cm4gY29kZVBvaW50IC0gMjI7CgkJfQoJCWlmIChjb2RlUG9pbnQgLSA2NSA8IDI2KSB7CgkJCXJldHVybiBjb2RlUG9pbnQgLSA2NTsKCQl9CgkJaWYgKGNvZGVQb2ludCAtIDk3IDwgMjYpIHsKCQkJcmV0dXJuIGNvZGVQb2ludCAtIDk3OwoJCX0KCQlyZXR1cm4gYmFzZTsKCX0KCgkvKioKCSAqIENvbnZlcnRzIGEgZGlnaXQvaW50ZWdlciBpbnRvIGEgYmFzaWMgY29kZSBwb2ludC4KCSAqIEBzZWUgYGJhc2ljVG9EaWdpdCgpYAoJICogQHByaXZhdGUKCSAqIEBwYXJhbSB7TnVtYmVyfSBkaWdpdCBUaGUgbnVtZXJpYyB2YWx1ZSBvZiBhIGJhc2ljIGNvZGUgcG9pbnQuCgkgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgYmFzaWMgY29kZSBwb2ludCB3aG9zZSB2YWx1ZSAod2hlbiB1c2VkIGZvcgoJICogcmVwcmVzZW50aW5nIGludGVnZXJzKSBpcyBgZGlnaXRgLCB3aGljaCBuZWVkcyB0byBiZSBpbiB0aGUgcmFuZ2UKCSAqIGAwYCB0byBgYmFzZSAtIDFgLiBJZiBgZmxhZ2AgaXMgbm9uLXplcm8sIHRoZSB1cHBlcmNhc2UgZm9ybSBpcwoJICogdXNlZDsgZWxzZSwgdGhlIGxvd2VyY2FzZSBmb3JtIGlzIHVzZWQuIFRoZSBiZWhhdmlvciBpcyB1bmRlZmluZWQKCSAqIGlmIGBmbGFnYCBpcyBub24temVybyBhbmQgYGRpZ2l0YCBoYXMgbm8gdXBwZXJjYXNlIGZvcm0uCgkgKi8KCWZ1bmN0aW9uIGRpZ2l0VG9CYXNpYyhkaWdpdCwgZmxhZykgewoJCS8vICAwLi4yNSBtYXAgdG8gQVNDSUkgYS4ueiBvciBBLi5aCgkJLy8gMjYuLjM1IG1hcCB0byBBU0NJSSAwLi45CgkJcmV0dXJuIGRpZ2l0ICsgMjIgKyA3NSAqIChkaWdpdCA8IDI2KSAtICgoZmxhZyAhPSAwKSA8PCA1KTsKCX0KCgkvKioKCSAqIEJpYXMgYWRhcHRhdGlvbiBmdW5jdGlvbiBhcyBwZXIgc2VjdGlvbiAzLjQgb2YgUkZDIDM0OTIuCgkgKiBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzNDkyI3NlY3Rpb24tMy40CgkgKiBAcHJpdmF0ZQoJICovCglmdW5jdGlvbiBhZGFwdChkZWx0YSwgbnVtUG9pbnRzLCBmaXJzdFRpbWUpIHsKCQl2YXIgayA9IDA7CgkJZGVsdGEgPSBmaXJzdFRpbWUgPyBmbG9vcihkZWx0YSAvIGRhbXApIDogZGVsdGEgPj4gMTsKCQlkZWx0YSArPSBmbG9vcihkZWx0YSAvIG51bVBvaW50cyk7CgkJZm9yICgvKiBubyBpbml0aWFsaXphdGlvbiAqLzsgZGVsdGEgPiBiYXNlTWludXNUTWluICogdE1heCA+PiAxOyBrICs9IGJhc2UpIHsKCQkJZGVsdGEgPSBmbG9vcihkZWx0YSAvIGJhc2VNaW51c1RNaW4pOwoJCX0KCQlyZXR1cm4gZmxvb3IoayArIChiYXNlTWludXNUTWluICsgMSkgKiBkZWx0YSAvIChkZWx0YSArIHNrZXcpKTsKCX0KCgkvKioKCSAqIENvbnZlcnRzIGEgUHVueWNvZGUgc3RyaW5nIG9mIEFTQ0lJLW9ubHkgc3ltYm9scyB0byBhIHN0cmluZyBvZiBVbmljb2RlCgkgKiBzeW1ib2xzLgoJICogQG1lbWJlck9mIHB1bnljb2RlCgkgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCgkgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgcmVzdWx0aW5nIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMuCgkgKi8KCWZ1bmN0aW9uIGRlY29kZShpbnB1dCkgewoJCS8vIERvbid0IHVzZSBVQ1MtMgoJCXZhciBvdXRwdXQgPSBbXSwKCQkgICAgaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJICAgIG91dCwKCQkgICAgaSA9IDAsCgkJICAgIG4gPSBpbml0aWFsTiwKCQkgICAgYmlhcyA9IGluaXRpYWxCaWFzLAoJCSAgICBiYXNpYywKCQkgICAgaiwKCQkgICAgaW5kZXgsCgkJICAgIG9sZGksCgkJICAgIHcsCgkJICAgIGssCgkJICAgIGRpZ2l0LAoJCSAgICB0LAoJCSAgICAvKiogQ2FjaGVkIGNhbGN1bGF0aW9uIHJlc3VsdHMgKi8KCQkgICAgYmFzZU1pbnVzVDsKCgkJLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50czogbGV0IGBiYXNpY2AgYmUgdGhlIG51bWJlciBvZiBpbnB1dCBjb2RlCgkJLy8gcG9pbnRzIGJlZm9yZSB0aGUgbGFzdCBkZWxpbWl0ZXIsIG9yIGAwYCBpZiB0aGVyZSBpcyBub25lLCB0aGVuIGNvcHkKCQkvLyB0aGUgZmlyc3QgYmFzaWMgY29kZSBwb2ludHMgdG8gdGhlIG91dHB1dC4KCgkJYmFzaWMgPSBpbnB1dC5sYXN0SW5kZXhPZihkZWxpbWl0ZXIpOwoJCWlmIChiYXNpYyA8IDApIHsKCQkJYmFzaWMgPSAwOwoJCX0KCgkJZm9yIChqID0gMDsgaiA8IGJhc2ljOyArK2opIHsKCQkJLy8gaWYgaXQncyBub3QgYSBiYXNpYyBjb2RlIHBvaW50CgkJCWlmIChpbnB1dC5jaGFyQ29kZUF0KGopID49IDB4ODApIHsKCQkJCWVycm9yKCdub3QtYmFzaWMnKTsKCQkJfQoJCQlvdXRwdXQucHVzaChpbnB1dC5jaGFyQ29kZUF0KGopKTsKCQl9CgoJCS8vIE1haW4gZGVjb2RpbmcgbG9vcDogc3RhcnQganVzdCBhZnRlciB0aGUgbGFzdCBkZWxpbWl0ZXIgaWYgYW55IGJhc2ljIGNvZGUKCQkvLyBwb2ludHMgd2VyZSBjb3BpZWQ7IHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcgb3RoZXJ3aXNlLgoKCQlmb3IgKGluZGV4ID0gYmFzaWMgPiAwID8gYmFzaWMgKyAxIDogMDsgaW5kZXggPCBpbnB1dExlbmd0aDsgLyogbm8gZmluYWwgZXhwcmVzc2lvbiAqLykgewoKCQkJLy8gYGluZGV4YCBpcyB0aGUgaW5kZXggb2YgdGhlIG5leHQgY2hhcmFjdGVyIHRvIGJlIGNvbnN1bWVkLgoJCQkvLyBEZWNvZGUgYSBnZW5lcmFsaXplZCB2YXJpYWJsZS1sZW5ndGggaW50ZWdlciBpbnRvIGBkZWx0YWAsCgkJCS8vIHdoaWNoIGdldHMgYWRkZWQgdG8gYGlgLiBUaGUgb3ZlcmZsb3cgY2hlY2tpbmcgaXMgZWFzaWVyCgkJCS8vIGlmIHdlIGluY3JlYXNlIGBpYCBhcyB3ZSBnbywgdGhlbiBzdWJ0cmFjdCBvZmYgaXRzIHN0YXJ0aW5nCgkJCS8vIHZhbHVlIGF0IHRoZSBlbmQgdG8gb2J0YWluIGBkZWx0YWAuCgkJCWZvciAob2xkaSA9IGksIHcgPSAxLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKCgkJCQlpZiAoaW5kZXggPj0gaW5wdXRMZW5ndGgpIHsKCQkJCQllcnJvcignaW52YWxpZC1pbnB1dCcpOwoJCQkJfQoKCQkJCWRpZ2l0ID0gYmFzaWNUb0RpZ2l0KGlucHV0LmNoYXJDb2RlQXQoaW5kZXgrKykpOwoKCQkJCWlmIChkaWdpdCA+PSBiYXNlIHx8IGRpZ2l0ID4gZmxvb3IoKG1heEludCAtIGkpIC8gdykpIHsKCQkJCQllcnJvcignb3ZlcmZsb3cnKTsKCQkJCX0KCgkJCQlpICs9IGRpZ2l0ICogdzsKCQkJCXQgPSBrIDw9IGJpYXMgPyB0TWluIDogKGsgPj0gYmlhcyArIHRNYXggPyB0TWF4IDogayAtIGJpYXMpOwoKCQkJCWlmIChkaWdpdCA8IHQpIHsKCQkJCQlicmVhazsKCQkJCX0KCgkJCQliYXNlTWludXNUID0gYmFzZSAtIHQ7CgkJCQlpZiAodyA+IGZsb29yKG1heEludCAvIGJhc2VNaW51c1QpKSB7CgkJCQkJZXJyb3IoJ292ZXJmbG93Jyk7CgkJCQl9CgoJCQkJdyAqPSBiYXNlTWludXNUOwoKCQkJfQoKCQkJb3V0ID0gb3V0cHV0Lmxlbmd0aCArIDE7CgkJCWJpYXMgPSBhZGFwdChpIC0gb2xkaSwgb3V0LCBvbGRpID09IDApOwoKCQkJLy8gYGlgIHdhcyBzdXBwb3NlZCB0byB3cmFwIGFyb3VuZCBmcm9tIGBvdXRgIHRvIGAwYCwKCQkJLy8gaW5jcmVtZW50aW5nIGBuYCBlYWNoIHRpbWUsIHNvIHdlJ2xsIGZpeCB0aGF0IG5vdzoKCQkJaWYgKGZsb29yKGkgLyBvdXQpID4gbWF4SW50IC0gbikgewoJCQkJZXJyb3IoJ292ZXJmbG93Jyk7CgkJCX0KCgkJCW4gKz0gZmxvb3IoaSAvIG91dCk7CgkJCWkgJT0gb3V0OwoKCQkJLy8gSW5zZXJ0IGBuYCBhdCBwb3NpdGlvbiBgaWAgb2YgdGhlIG91dHB1dAoJCQlvdXRwdXQuc3BsaWNlKGkrKywgMCwgbik7CgoJCX0KCgkJcmV0dXJuIHVjczJlbmNvZGUob3V0cHV0KTsKCX0KCgkvKioKCSAqIENvbnZlcnRzIGEgc3RyaW5nIG9mIFVuaWNvZGUgc3ltYm9scyAoZS5nLiBhIGRvbWFpbiBuYW1lIGxhYmVsKSB0byBhCgkgKiBQdW55Y29kZSBzdHJpbmcgb2YgQVNDSUktb25seSBzeW1ib2xzLgoJICogQG1lbWJlck9mIHB1bnljb2RlCgkgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIHN0cmluZyBvZiBVbmljb2RlIHN5bWJvbHMuCgkgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgcmVzdWx0aW5nIFB1bnljb2RlIHN0cmluZyBvZiBBU0NJSS1vbmx5IHN5bWJvbHMuCgkgKi8KCWZ1bmN0aW9uIGVuY29kZShpbnB1dCkgewoJCXZhciBuLAoJCSAgICBkZWx0YSwKCQkgICAgaGFuZGxlZENQQ291bnQsCgkJICAgIGJhc2ljTGVuZ3RoLAoJCSAgICBiaWFzLAoJCSAgICBqLAoJCSAgICBtLAoJCSAgICBxLAoJCSAgICBrLAoJCSAgICB0LAoJCSAgICBjdXJyZW50VmFsdWUsCgkJICAgIG91dHB1dCA9IFtdLAoJCSAgICAvKiogYGlucHV0TGVuZ3RoYCB3aWxsIGhvbGQgdGhlIG51bWJlciBvZiBjb2RlIHBvaW50cyBpbiBgaW5wdXRgLiAqLwoJCSAgICBpbnB1dExlbmd0aCwKCQkgICAgLyoqIENhY2hlZCBjYWxjdWxhdGlvbiByZXN1bHRzICovCgkJICAgIGhhbmRsZWRDUENvdW50UGx1c09uZSwKCQkgICAgYmFzZU1pbnVzVCwKCQkgICAgcU1pbnVzVDsKCgkJLy8gQ29udmVydCB0aGUgaW5wdXQgaW4gVUNTLTIgdG8gVW5pY29kZQoJCWlucHV0ID0gdWNzMmRlY29kZShpbnB1dCk7CgoJCS8vIENhY2hlIHRoZSBsZW5ndGgKCQlpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aDsKCgkJLy8gSW5pdGlhbGl6ZSB0aGUgc3RhdGUKCQluID0gaW5pdGlhbE47CgkJZGVsdGEgPSAwOwoJCWJpYXMgPSBpbml0aWFsQmlhczsKCgkJLy8gSGFuZGxlIHRoZSBiYXNpYyBjb2RlIHBvaW50cwoJCWZvciAoaiA9IDA7IGogPCBpbnB1dExlbmd0aDsgKytqKSB7CgkJCWN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwoJCQlpZiAoY3VycmVudFZhbHVlIDwgMHg4MCkgewoJCQkJb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGN1cnJlbnRWYWx1ZSkpOwoJCQl9CgkJfQoKCQloYW5kbGVkQ1BDb3VudCA9IGJhc2ljTGVuZ3RoID0gb3V0cHV0Lmxlbmd0aDsKCgkJLy8gYGhhbmRsZWRDUENvdW50YCBpcyB0aGUgbnVtYmVyIG9mIGNvZGUgcG9pbnRzIHRoYXQgaGF2ZSBiZWVuIGhhbmRsZWQ7CgkJLy8gYGJhc2ljTGVuZ3RoYCBpcyB0aGUgbnVtYmVyIG9mIGJhc2ljIGNvZGUgcG9pbnRzLgoKCQkvLyBGaW5pc2ggdGhlIGJhc2ljIHN0cmluZyAtIGlmIGl0IGlzIG5vdCBlbXB0eSAtIHdpdGggYSBkZWxpbWl0ZXIKCQlpZiAoYmFzaWNMZW5ndGgpIHsKCQkJb3V0cHV0LnB1c2goZGVsaW1pdGVyKTsKCQl9CgoJCS8vIE1haW4gZW5jb2RpbmcgbG9vcDoKCQl3aGlsZSAoaGFuZGxlZENQQ291bnQgPCBpbnB1dExlbmd0aCkgewoKCQkJLy8gQWxsIG5vbi1iYXNpYyBjb2RlIHBvaW50cyA8IG4gaGF2ZSBiZWVuIGhhbmRsZWQgYWxyZWFkeS4gRmluZCB0aGUgbmV4dAoJCQkvLyBsYXJnZXIgb25lOgoJCQlmb3IgKG0gPSBtYXhJbnQsIGogPSAwOyBqIDwgaW5wdXRMZW5ndGg7ICsraikgewoJCQkJY3VycmVudFZhbHVlID0gaW5wdXRbal07CgkJCQlpZiAoY3VycmVudFZhbHVlID49IG4gJiYgY3VycmVudFZhbHVlIDwgbSkgewoJCQkJCW0gPSBjdXJyZW50VmFsdWU7CgkJCQl9CgkJCX0KCgkJCS8vIEluY3JlYXNlIGBkZWx0YWAgZW5vdWdoIHRvIGFkdmFuY2UgdGhlIGRlY29kZXIncyA8bixpPiBzdGF0ZSB0byA8bSwwPiwKCQkJLy8gYnV0IGd1YXJkIGFnYWluc3Qgb3ZlcmZsb3cKCQkJaGFuZGxlZENQQ291bnRQbHVzT25lID0gaGFuZGxlZENQQ291bnQgKyAxOwoJCQlpZiAobSAtIG4gPiBmbG9vcigobWF4SW50IC0gZGVsdGEpIC8gaGFuZGxlZENQQ291bnRQbHVzT25lKSkgewoJCQkJZXJyb3IoJ292ZXJmbG93Jyk7CgkJCX0KCgkJCWRlbHRhICs9IChtIC0gbikgKiBoYW5kbGVkQ1BDb3VudFBsdXNPbmU7CgkJCW4gPSBtOwoKCQkJZm9yIChqID0gMDsgaiA8IGlucHV0TGVuZ3RoOyArK2opIHsKCQkJCWN1cnJlbnRWYWx1ZSA9IGlucHV0W2pdOwoKCQkJCWlmIChjdXJyZW50VmFsdWUgPCBuICYmICsrZGVsdGEgPiBtYXhJbnQpIHsKCQkJCQllcnJvcignb3ZlcmZsb3cnKTsKCQkJCX0KCgkJCQlpZiAoY3VycmVudFZhbHVlID09IG4pIHsKCQkJCQkvLyBSZXByZXNlbnQgZGVsdGEgYXMgYSBnZW5lcmFsaXplZCB2YXJpYWJsZS1sZW5ndGggaW50ZWdlcgoJCQkJCWZvciAocSA9IGRlbHRhLCBrID0gYmFzZTsgLyogbm8gY29uZGl0aW9uICovOyBrICs9IGJhc2UpIHsKCQkJCQkJdCA9IGsgPD0gYmlhcyA/IHRNaW4gOiAoayA+PSBiaWFzICsgdE1heCA/IHRNYXggOiBrIC0gYmlhcyk7CgkJCQkJCWlmIChxIDwgdCkgewoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQkJcU1pbnVzVCA9IHEgLSB0OwoJCQkJCQliYXNlTWludXNUID0gYmFzZSAtIHQ7CgkJCQkJCW91dHB1dC5wdXNoKAoJCQkJCQkJc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyh0ICsgcU1pbnVzVCAlIGJhc2VNaW51c1QsIDApKQoJCQkJCQkpOwoJCQkJCQlxID0gZmxvb3IocU1pbnVzVCAvIGJhc2VNaW51c1QpOwoJCQkJCX0KCgkJCQkJb3V0cHV0LnB1c2goc3RyaW5nRnJvbUNoYXJDb2RlKGRpZ2l0VG9CYXNpYyhxLCAwKSkpOwoJCQkJCWJpYXMgPSBhZGFwdChkZWx0YSwgaGFuZGxlZENQQ291bnRQbHVzT25lLCBoYW5kbGVkQ1BDb3VudCA9PSBiYXNpY0xlbmd0aCk7CgkJCQkJZGVsdGEgPSAwOwoJCQkJCSsraGFuZGxlZENQQ291bnQ7CgkJCQl9CgkJCX0KCgkJCSsrZGVsdGE7CgkJCSsrbjsKCgkJfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9CgoJLyoqCgkgKiBDb252ZXJ0cyBhIFB1bnljb2RlIHN0cmluZyByZXByZXNlbnRpbmcgYSBkb21haW4gbmFtZSBvciBhbiBlbWFpbCBhZGRyZXNzCgkgKiB0byBVbmljb2RlLiBPbmx5IHRoZSBQdW55Y29kZWQgcGFydHMgb2YgdGhlIGlucHV0IHdpbGwgYmUgY29udmVydGVkLCBpLmUuCgkgKiBpdCBkb2Vzbid0IG1hdHRlciBpZiB5b3UgY2FsbCBpdCBvbiBhIHN0cmluZyB0aGF0IGhhcyBhbHJlYWR5IGJlZW4KCSAqIGNvbnZlcnRlZCB0byBVbmljb2RlLgoJICogQG1lbWJlck9mIHB1bnljb2RlCgkgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIFB1bnljb2RlZCBkb21haW4gbmFtZSBvciBlbWFpbCBhZGRyZXNzIHRvCgkgKiBjb252ZXJ0IHRvIFVuaWNvZGUuCgkgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgVW5pY29kZSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gUHVueWNvZGUKCSAqIHN0cmluZy4KCSAqLwoJZnVuY3Rpb24gdG9Vbmljb2RlKGlucHV0KSB7CgkJcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CgkJCXJldHVybiByZWdleFB1bnljb2RlLnRlc3Qoc3RyaW5nKQoJCQkJPyBkZWNvZGUoc3RyaW5nLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCkpCgkJCQk6IHN0cmluZzsKCQl9KTsKCX0KCgkvKioKCSAqIENvbnZlcnRzIGEgVW5pY29kZSBzdHJpbmcgcmVwcmVzZW50aW5nIGEgZG9tYWluIG5hbWUgb3IgYW4gZW1haWwgYWRkcmVzcyB0bwoJICogUHVueWNvZGUuIE9ubHkgdGhlIG5vbi1BU0NJSSBwYXJ0cyBvZiB0aGUgZG9tYWluIG5hbWUgd2lsbCBiZSBjb252ZXJ0ZWQsCgkgKiBpLmUuIGl0IGRvZXNuJ3QgbWF0dGVyIGlmIHlvdSBjYWxsIGl0IHdpdGggYSBkb21haW4gdGhhdCdzIGFscmVhZHkgaW4KCSAqIEFTQ0lJLgoJICogQG1lbWJlck9mIHB1bnljb2RlCgkgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQgVGhlIGRvbWFpbiBuYW1lIG9yIGVtYWlsIGFkZHJlc3MgdG8gY29udmVydCwgYXMgYQoJICogVW5pY29kZSBzdHJpbmcuCgkgKiBAcmV0dXJucyB7U3RyaW5nfSBUaGUgUHVueWNvZGUgcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIGRvbWFpbiBuYW1lIG9yCgkgKiBlbWFpbCBhZGRyZXNzLgoJICovCglmdW5jdGlvbiB0b0FTQ0lJKGlucHV0KSB7CgkJcmV0dXJuIG1hcERvbWFpbihpbnB1dCwgZnVuY3Rpb24oc3RyaW5nKSB7CgkJCXJldHVybiByZWdleE5vbkFTQ0lJLnRlc3Qoc3RyaW5nKQoJCQkJPyAneG4tLScgKyBlbmNvZGUoc3RyaW5nKQoJCQkJOiBzdHJpbmc7CgkJfSk7Cgl9CgoJLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgoJLyoqIERlZmluZSB0aGUgcHVibGljIEFQSSAqLwoJcHVueWNvZGUgPSB7CgkJLyoqCgkJICogQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IFB1bnljb2RlLmpzIHZlcnNpb24gbnVtYmVyLgoJCSAqIEBtZW1iZXJPZiBwdW55Y29kZQoJCSAqIEB0eXBlIFN0cmluZwoJCSAqLwoJCSd2ZXJzaW9uJzogJzEuMy4yJywKCQkvKioKCQkgKiBBbiBvYmplY3Qgb2YgbWV0aG9kcyB0byBjb252ZXJ0IGZyb20gSmF2YVNjcmlwdCdzIGludGVybmFsIGNoYXJhY3RlcgoJCSAqIHJlcHJlc2VudGF0aW9uIChVQ1MtMikgdG8gVW5pY29kZSBjb2RlIHBvaW50cywgYW5kIGJhY2suCgkJICogQHNlZSA8aHR0cHM6Ly9tYXRoaWFzYnluZW5zLmJlL25vdGVzL2phdmFzY3JpcHQtZW5jb2Rpbmc+CgkJICogQG1lbWJlck9mIHB1bnljb2RlCgkJICogQHR5cGUgT2JqZWN0CgkJICovCgkJJ3VjczInOiB7CgkJCSdkZWNvZGUnOiB1Y3MyZGVjb2RlLAoJCQknZW5jb2RlJzogdWNzMmVuY29kZQoJCX0sCgkJJ2RlY29kZSc6IGRlY29kZSwKCQknZW5jb2RlJzogZW5jb2RlLAoJCSd0b0FTQ0lJJzogdG9BU0NJSSwKCQkndG9Vbmljb2RlJzogdG9Vbmljb2RlCgl9OwoKCS8qKiBFeHBvc2UgYHB1bnljb2RlYCAqLwoJLy8gU29tZSBBTUQgYnVpbGQgb3B0aW1pemVycywgbGlrZSByLmpzLCBjaGVjayBmb3Igc3BlY2lmaWMgY29uZGl0aW9uIHBhdHRlcm5zCgkvLyBsaWtlIHRoZSBmb2xsb3dpbmc6CglpZiAoCgkJdHJ1ZQoJKSB7CgkJIShfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyA9IChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHB1bnljb2RlOwoJCX0pLmNhbGwoZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXywgZXhwb3J0cywgbW9kdWxlKSwKCQlfX1dFQlBBQ0tfQU1EX0RFRklORV9SRVNVTFRfXyAhPT0gdW5kZWZpbmVkICYmIChtb2R1bGUuZXhwb3J0cyA9IF9fV0VCUEFDS19BTURfREVGSU5FX1JFU1VMVF9fKSk7Cgl9IGVsc2Uge30KCn0odGhpcykpOwoKfSkuY2FsbCh0aGlzKX0pLmNhbGwodGhpcyx0eXBlb2YgX193ZWJwYWNrX3JlcXVpcmVfXy5nICE9PSAidW5kZWZpbmVkIiA/IF9fd2VicGFja19yZXF1aXJlX18uZyA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdyA6IHt9KQp9LHt9XSw5MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCid1c2Ugc3RyaWN0JzsKCi8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCi8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CmZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogIHNlcCA9IHNlcCB8fCAnJic7CiAgZXEgPSBlcSB8fCAnPSc7CiAgdmFyIG9iaiA9IHt9OwoKICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgcXMgPSBxcy5zcGxpdChzZXApOwoKICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgfQoKICB2YXIgbGVuID0gcXMubGVuZ3RoOwogIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICBsZW4gPSBtYXhLZXlzOwogIH0KCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKCiAgICBpZiAoaWR4ID49IDApIHsKICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgIH0gZWxzZSB7CiAgICAgIGtzdHIgPSB4OwogICAgICB2c3RyID0gJyc7CiAgICB9CgogICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CgogICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgIG9ialtrXSA9IHY7CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICBvYmpba10ucHVzaCh2KTsKICAgIH0gZWxzZSB7CiAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgfQogIH0KCiAgcmV0dXJuIG9iajsKfTsKCnZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCn0se31dLDkyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKJ3VzZSBzdHJpY3QnOwoKdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICBjYXNlICdzdHJpbmcnOgogICAgICByZXR1cm4gdjsKCiAgICBjYXNlICdib29sZWFuJzoKICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwoKICAgIGNhc2UgJ251bWJlcic6CiAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gJyc7CiAgfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICBzZXAgPSBzZXAgfHwgJyYnOwogIGVxID0gZXEgfHwgJz0nOwogIGlmIChvYmogPT09IG51bGwpIHsKICAgIG9iaiA9IHVuZGVmaW5lZDsKICB9CgogIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgcmV0dXJuIG1hcChvYmplY3RLZXlzKG9iaiksIGZ1bmN0aW9uKGspIHsKICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgaWYgKGlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIHJldHVybiBtYXAob2JqW2tdLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKHYpKTsKICAgICAgICB9KS5qb2luKHNlcCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGtzICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmpba10pKTsKICAgICAgfQogICAgfSkuam9pbihzZXApOwoKICB9CgogIGlmICghbmFtZSkgcmV0dXJuICcnOwogIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG5hbWUpKSArIGVxICsKICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShvYmopKTsKfTsKCnZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoeHMpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHhzKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCmZ1bmN0aW9uIG1hcCAoeHMsIGYpIHsKICBpZiAoeHMubWFwKSByZXR1cm4geHMubWFwKGYpOwogIHZhciByZXMgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSB7CiAgICByZXMucHVzaChmKHhzW2ldLCBpKSk7CiAgfQogIHJldHVybiByZXM7Cn0KCnZhciBvYmplY3RLZXlzID0gT2JqZWN0LmtleXMgfHwgZnVuY3Rpb24gKG9iaikgewogIHZhciByZXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgcmVzLnB1c2goa2V5KTsKICB9CiAgcmV0dXJuIHJlczsKfTsKCn0se31dLDkzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKZXhwb3J0cy5kZWNvZGUgPSBleHBvcnRzLnBhcnNlID0gcmVxdWlyZSgnLi9kZWNvZGUnKTsKZXhwb3J0cy5lbmNvZGUgPSBleHBvcnRzLnN0cmluZ2lmeSA9IHJlcXVpcmUoJy4vZW5jb2RlJyk7Cgp9LHsiLi9kZWNvZGUiOjkxLCIuL2VuY29kZSI6OTJ9XSw5NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCid1c2Ugc3RyaWN0JzsKCi8vIElmIG9iai5oYXNPd25Qcm9wZXJ0eSBoYXMgYmVlbiBvdmVycmlkZGVuLCB0aGVuIGNhbGxpbmcKLy8gb2JqLmhhc093blByb3BlcnR5KHByb3ApIHdpbGwgYnJlYWsuCi8vIFNlZTogaHR0cHM6Ly9naXRodWIuY29tL2pveWVudC9ub2RlL2lzc3Vlcy8xNzA3CmZ1bmN0aW9uIGhhc093blByb3BlcnR5KG9iaiwgcHJvcCkgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBwcm9wKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihxcywgc2VwLCBlcSwgb3B0aW9ucykgewogIHNlcCA9IHNlcCB8fCAnJic7CiAgZXEgPSBlcSB8fCAnPSc7CiAgdmFyIG9iaiA9IHt9OwoKICBpZiAodHlwZW9mIHFzICE9PSAnc3RyaW5nJyB8fCBxcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICB2YXIgcmVnZXhwID0gL1wrL2c7CiAgcXMgPSBxcy5zcGxpdChzZXApOwoKICB2YXIgbWF4S2V5cyA9IDEwMDA7CiAgaWYgKG9wdGlvbnMgJiYgdHlwZW9mIG9wdGlvbnMubWF4S2V5cyA9PT0gJ251bWJlcicpIHsKICAgIG1heEtleXMgPSBvcHRpb25zLm1heEtleXM7CiAgfQoKICB2YXIgbGVuID0gcXMubGVuZ3RoOwogIC8vIG1heEtleXMgPD0gMCBtZWFucyB0aGF0IHdlIHNob3VsZCBub3QgbGltaXQga2V5cyBjb3VudAogIGlmIChtYXhLZXlzID4gMCAmJiBsZW4gPiBtYXhLZXlzKSB7CiAgICBsZW4gPSBtYXhLZXlzOwogIH0KCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgdmFyIHggPSBxc1tpXS5yZXBsYWNlKHJlZ2V4cCwgJyUyMCcpLAogICAgICAgIGlkeCA9IHguaW5kZXhPZihlcSksCiAgICAgICAga3N0ciwgdnN0ciwgaywgdjsKCiAgICBpZiAoaWR4ID49IDApIHsKICAgICAga3N0ciA9IHguc3Vic3RyKDAsIGlkeCk7CiAgICAgIHZzdHIgPSB4LnN1YnN0cihpZHggKyAxKTsKICAgIH0gZWxzZSB7CiAgICAgIGtzdHIgPSB4OwogICAgICB2c3RyID0gJyc7CiAgICB9CgogICAgayA9IGRlY29kZVVSSUNvbXBvbmVudChrc3RyKTsKICAgIHYgPSBkZWNvZGVVUklDb21wb25lbnQodnN0cik7CgogICAgaWYgKCFoYXNPd25Qcm9wZXJ0eShvYmosIGspKSB7CiAgICAgIG9ialtrXSA9IHY7CiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICBvYmpba10ucHVzaCh2KTsKICAgIH0gZWxzZSB7CiAgICAgIG9ialtrXSA9IFtvYmpba10sIHZdOwogICAgfQogIH0KCiAgcmV0dXJuIG9iajsKfTsKCn0se31dLDk1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKJ3VzZSBzdHJpY3QnOwoKdmFyIHN0cmluZ2lmeVByaW1pdGl2ZSA9IGZ1bmN0aW9uKHYpIHsKICBzd2l0Y2ggKHR5cGVvZiB2KSB7CiAgICBjYXNlICdzdHJpbmcnOgogICAgICByZXR1cm4gdjsKCiAgICBjYXNlICdib29sZWFuJzoKICAgICAgcmV0dXJuIHYgPyAndHJ1ZScgOiAnZmFsc2UnOwoKICAgIGNhc2UgJ251bWJlcic6CiAgICAgIHJldHVybiBpc0Zpbml0ZSh2KSA/IHYgOiAnJzsKCiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gJyc7CiAgfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihvYmosIHNlcCwgZXEsIG5hbWUpIHsKICBzZXAgPSBzZXAgfHwgJyYnOwogIGVxID0gZXEgfHwgJz0nOwogIGlmIChvYmogPT09IG51bGwpIHsKICAgIG9iaiA9IHVuZGVmaW5lZDsKICB9CgogIGlmICh0eXBlb2Ygb2JqID09PSAnb2JqZWN0JykgewogICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iaikubWFwKGZ1bmN0aW9uKGspIHsKICAgICAgdmFyIGtzID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeVByaW1pdGl2ZShrKSkgKyBlcTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkob2JqW2tdKSkgewogICAgICAgIHJldHVybiBvYmpba10ubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgICAgIHJldHVybiBrcyArIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUodikpOwogICAgICAgIH0pLmpvaW4oc2VwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4ga3MgKyBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9ialtrXSkpOwogICAgICB9CiAgICB9KS5qb2luKHNlcCk7CgogIH0KCiAgaWYgKCFuYW1lKSByZXR1cm4gJyc7CiAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChzdHJpbmdpZnlQcmltaXRpdmUobmFtZSkpICsgZXEgKwogICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5UHJpbWl0aXZlKG9iaikpOwp9OwoKfSx7fV0sOTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewphcmd1bWVudHNbNF1bOTNdWzBdLmFwcGx5KGV4cG9ydHMsYXJndW1lbnRzKQp9LHsiLi9kZWNvZGUiOjk0LCIuL2VuY29kZSI6OTUsImR1cCI6OTN9XSw5NzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAoc2V0SW1tZWRpYXRlLGNsZWFySW1tZWRpYXRlKXsoZnVuY3Rpb24gKCl7CnZhciBuZXh0VGljayA9IHJlcXVpcmUoJ3Byb2Nlc3MvYnJvd3Nlci5qcycpLm5leHRUaWNrOwp2YXIgYXBwbHkgPSBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHk7CnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKdmFyIGltbWVkaWF0ZUlkcyA9IHt9Owp2YXIgbmV4dEltbWVkaWF0ZUlkID0gMDsKCi8vIERPTSBBUElzLCBmb3IgY29tcGxldGVuZXNzCgpleHBvcnRzLnNldFRpbWVvdXQgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRUaW1lb3V0LCB3aW5kb3csIGFyZ3VtZW50cyksIGNsZWFyVGltZW91dCk7Cn07CmV4cG9ydHMuc2V0SW50ZXJ2YWwgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IFRpbWVvdXQoYXBwbHkuY2FsbChzZXRJbnRlcnZhbCwgd2luZG93LCBhcmd1bWVudHMpLCBjbGVhckludGVydmFsKTsKfTsKZXhwb3J0cy5jbGVhclRpbWVvdXQgPQpleHBvcnRzLmNsZWFySW50ZXJ2YWwgPSBmdW5jdGlvbih0aW1lb3V0KSB7IHRpbWVvdXQuY2xvc2UoKTsgfTsKCmZ1bmN0aW9uIFRpbWVvdXQoaWQsIGNsZWFyRm4pIHsKICB0aGlzLl9pZCA9IGlkOwogIHRoaXMuX2NsZWFyRm4gPSBjbGVhckZuOwp9ClRpbWVvdXQucHJvdG90eXBlLnVucmVmID0gVGltZW91dC5wcm90b3R5cGUucmVmID0gZnVuY3Rpb24oKSB7fTsKVGltZW91dC5wcm90b3R5cGUuY2xvc2UgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9jbGVhckZuLmNhbGwod2luZG93LCB0aGlzLl9pZCk7Cn07CgovLyBEb2VzIG5vdCBzdGFydCB0aGUgdGltZSwganVzdCBzZXRzIHVwIHRoZSBtZW1iZXJzIG5lZWRlZC4KZXhwb3J0cy5lbnJvbGwgPSBmdW5jdGlvbihpdGVtLCBtc2VjcykgewogIGNsZWFyVGltZW91dChpdGVtLl9pZGxlVGltZW91dElkKTsKICBpdGVtLl9pZGxlVGltZW91dCA9IG1zZWNzOwp9OwoKZXhwb3J0cy51bmVucm9sbCA9IGZ1bmN0aW9uKGl0ZW0pIHsKICBjbGVhclRpbWVvdXQoaXRlbS5faWRsZVRpbWVvdXRJZCk7CiAgaXRlbS5faWRsZVRpbWVvdXQgPSAtMTsKfTsKCmV4cG9ydHMuX3VucmVmQWN0aXZlID0gZXhwb3J0cy5hY3RpdmUgPSBmdW5jdGlvbihpdGVtKSB7CiAgY2xlYXJUaW1lb3V0KGl0ZW0uX2lkbGVUaW1lb3V0SWQpOwoKICB2YXIgbXNlY3MgPSBpdGVtLl9pZGxlVGltZW91dDsKICBpZiAobXNlY3MgPj0gMCkgewogICAgaXRlbS5faWRsZVRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gb25UaW1lb3V0KCkgewogICAgICBpZiAoaXRlbS5fb25UaW1lb3V0KQogICAgICAgIGl0ZW0uX29uVGltZW91dCgpOwogICAgfSwgbXNlY3MpOwogIH0KfTsKCi8vIFRoYXQncyBub3QgaG93IG5vZGUuanMgaW1wbGVtZW50cyBpdCBidXQgdGhlIGV4cG9zZWQgYXBpIGlzIHRoZSBzYW1lLgpleHBvcnRzLnNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBzZXRJbW1lZGlhdGUgOiBmdW5jdGlvbihmbikgewogIHZhciBpZCA9IG5leHRJbW1lZGlhdGVJZCsrOwogIHZhciBhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA8IDIgPyBmYWxzZSA6IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgaW1tZWRpYXRlSWRzW2lkXSA9IHRydWU7CgogIG5leHRUaWNrKGZ1bmN0aW9uIG9uTmV4dFRpY2soKSB7CiAgICBpZiAoaW1tZWRpYXRlSWRzW2lkXSkgewogICAgICAvLyBmbi5jYWxsKCkgaXMgZmFzdGVyIHNvIHdlIG9wdGltaXplIGZvciB0aGUgY29tbW9uIHVzZS1jYXNlCiAgICAgIC8vIEBzZWUgaHR0cDovL2pzcGVyZi5jb20vY2FsbC1hcHBseS1zZWd1CiAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm4uY2FsbChudWxsKTsKICAgICAgfQogICAgICAvLyBQcmV2ZW50IGlkcyBmcm9tIGxlYWtpbmcKICAgICAgZXhwb3J0cy5jbGVhckltbWVkaWF0ZShpZCk7CiAgICB9CiAgfSk7CgogIHJldHVybiBpZDsKfTsKCmV4cG9ydHMuY2xlYXJJbW1lZGlhdGUgPSB0eXBlb2YgY2xlYXJJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIgPyBjbGVhckltbWVkaWF0ZSA6IGZ1bmN0aW9uKGlkKSB7CiAgZGVsZXRlIGltbWVkaWF0ZUlkc1tpZF07Cn07Cn0pLmNhbGwodGhpcyl9KS5jYWxsKHRoaXMscmVxdWlyZSgidGltZXJzIikuc2V0SW1tZWRpYXRlLHJlcXVpcmUoInRpbWVycyIpLmNsZWFySW1tZWRpYXRlKQp9LHsicHJvY2Vzcy9icm93c2VyLmpzIjo4OSwidGltZXJzIjo5N31dLDk4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKdmFyIHB1bnljb2RlID0gcmVxdWlyZSgncHVueWNvZGUnKTsKCmV4cG9ydHMucGFyc2UgPSB1cmxQYXJzZTsKZXhwb3J0cy5yZXNvbHZlID0gdXJsUmVzb2x2ZTsKZXhwb3J0cy5yZXNvbHZlT2JqZWN0ID0gdXJsUmVzb2x2ZU9iamVjdDsKZXhwb3J0cy5mb3JtYXQgPSB1cmxGb3JtYXQ7CgpleHBvcnRzLlVybCA9IFVybDsKCmZ1bmN0aW9uIFVybCgpIHsKICB0aGlzLnByb3RvY29sID0gbnVsbDsKICB0aGlzLnNsYXNoZXMgPSBudWxsOwogIHRoaXMuYXV0aCA9IG51bGw7CiAgdGhpcy5ob3N0ID0gbnVsbDsKICB0aGlzLnBvcnQgPSBudWxsOwogIHRoaXMuaG9zdG5hbWUgPSBudWxsOwogIHRoaXMuaGFzaCA9IG51bGw7CiAgdGhpcy5zZWFyY2ggPSBudWxsOwogIHRoaXMucXVlcnkgPSBudWxsOwogIHRoaXMucGF0aG5hbWUgPSBudWxsOwogIHRoaXMucGF0aCA9IG51bGw7CiAgdGhpcy5ocmVmID0gbnVsbDsKfQoKLy8gUmVmZXJlbmNlOiBSRkMgMzk4NiwgUkZDIDE4MDgsIFJGQyAyMzk2CgovLyBkZWZpbmUgdGhlc2UgaGVyZSBzbyBhdCBsZWFzdCB0aGV5IG9ubHkgaGF2ZSB0byBiZQovLyBjb21waWxlZCBvbmNlIG9uIHRoZSBmaXJzdCBtb2R1bGUgbG9hZC4KdmFyIHByb3RvY29sUGF0dGVybiA9IC9eKFthLXowLTkuKy1dKzopL2ksCiAgICBwb3J0UGF0dGVybiA9IC86WzAtOV0qJC8sCgogICAgLy8gUkZDIDIzOTY6IGNoYXJhY3RlcnMgcmVzZXJ2ZWQgZm9yIGRlbGltaXRpbmcgVVJMcy4KICAgIC8vIFdlIGFjdHVhbGx5IGp1c3QgYXV0by1lc2NhcGUgdGhlc2UuCiAgICBkZWxpbXMgPSBbJzwnLCAnPicsICciJywgJ2AnLCAnICcsICdccicsICdcbicsICdcdCddLAoKICAgIC8vIFJGQyAyMzk2OiBjaGFyYWN0ZXJzIG5vdCBhbGxvd2VkIGZvciB2YXJpb3VzIHJlYXNvbnMuCiAgICB1bndpc2UgPSBbJ3snLCAnfScsICd8JywgJ1xcJywgJ14nLCAnYCddLmNvbmNhdChkZWxpbXMpLAoKICAgIC8vIEFsbG93ZWQgYnkgUkZDcywgYnV0IGNhdXNlIG9mIFhTUyBhdHRhY2tzLiAgQWx3YXlzIGVzY2FwZSB0aGVzZS4KICAgIGF1dG9Fc2NhcGUgPSBbJ1wnJ10uY29uY2F0KHVud2lzZSksCiAgICAvLyBDaGFyYWN0ZXJzIHRoYXQgYXJlIG5ldmVyIGV2ZXIgYWxsb3dlZCBpbiBhIGhvc3RuYW1lLgogICAgLy8gTm90ZSB0aGF0IGFueSBpbnZhbGlkIGNoYXJzIGFyZSBhbHNvIGhhbmRsZWQsIGJ1dCB0aGVzZQogICAgLy8gYXJlIHRoZSBvbmVzIHRoYXQgYXJlICpleHBlY3RlZCogdG8gYmUgc2Vlbiwgc28gd2UgZmFzdC1wYXRoCiAgICAvLyB0aGVtLgogICAgbm9uSG9zdENoYXJzID0gWyclJywgJy8nLCAnPycsICc7JywgJyMnXS5jb25jYXQoYXV0b0VzY2FwZSksCiAgICBob3N0RW5kaW5nQ2hhcnMgPSBbJy8nLCAnPycsICcjJ10sCiAgICBob3N0bmFtZU1heExlbiA9IDI1NSwKICAgIGhvc3RuYW1lUGFydFBhdHRlcm4gPSAvXlthLXowLTlBLVpfLV17MCw2M30kLywKICAgIGhvc3RuYW1lUGFydFN0YXJ0ID0gL14oW2EtejAtOUEtWl8tXXswLDYzfSkoLiopJC8sCiAgICAvLyBwcm90b2NvbHMgdGhhdCBjYW4gYWxsb3cgInVuc2FmZSIgYW5kICJ1bndpc2UiIGNoYXJzLgogICAgdW5zYWZlUHJvdG9jb2wgPSB7CiAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgfSwKICAgIC8vIHByb3RvY29scyB0aGF0IG5ldmVyIGhhdmUgYSBob3N0bmFtZS4KICAgIGhvc3RsZXNzUHJvdG9jb2wgPSB7CiAgICAgICdqYXZhc2NyaXB0JzogdHJ1ZSwKICAgICAgJ2phdmFzY3JpcHQ6JzogdHJ1ZQogICAgfSwKICAgIC8vIHByb3RvY29scyB0aGF0IGFsd2F5cyBjb250YWluIGEgLy8gYml0LgogICAgc2xhc2hlZFByb3RvY29sID0gewogICAgICAnaHR0cCc6IHRydWUsCiAgICAgICdodHRwcyc6IHRydWUsCiAgICAgICdmdHAnOiB0cnVlLAogICAgICAnZ29waGVyJzogdHJ1ZSwKICAgICAgJ2ZpbGUnOiB0cnVlLAogICAgICAnaHR0cDonOiB0cnVlLAogICAgICAnaHR0cHM6JzogdHJ1ZSwKICAgICAgJ2Z0cDonOiB0cnVlLAogICAgICAnZ29waGVyOic6IHRydWUsCiAgICAgICdmaWxlOic6IHRydWUKICAgIH0sCiAgICBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7CgpmdW5jdGlvbiB1cmxQYXJzZSh1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgaWYgKHVybCAmJiBpc09iamVjdCh1cmwpICYmIHVybCBpbnN0YW5jZW9mIFVybCkgcmV0dXJuIHVybDsKCiAgdmFyIHUgPSBuZXcgVXJsOwogIHUucGFyc2UodXJsLCBwYXJzZVF1ZXJ5U3RyaW5nLCBzbGFzaGVzRGVub3RlSG9zdCk7CiAgcmV0dXJuIHU7Cn0KClVybC5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbih1cmwsIHBhcnNlUXVlcnlTdHJpbmcsIHNsYXNoZXNEZW5vdGVIb3N0KSB7CiAgaWYgKCFpc1N0cmluZyh1cmwpKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJQYXJhbWV0ZXIgJ3VybCcgbXVzdCBiZSBhIHN0cmluZywgbm90ICIgKyB0eXBlb2YgdXJsKTsKICB9CgogIHZhciByZXN0ID0gdXJsOwoKICAvLyB0cmltIGJlZm9yZSBwcm9jZWVkaW5nLgogIC8vIFRoaXMgaXMgdG8gc3VwcG9ydCBwYXJzZSBzdHVmZiBsaWtlICIgIGh0dHA6Ly9mb28uY29tICBcbiIKICByZXN0ID0gcmVzdC50cmltKCk7CgogIHZhciBwcm90byA9IHByb3RvY29sUGF0dGVybi5leGVjKHJlc3QpOwogIGlmIChwcm90bykgewogICAgcHJvdG8gPSBwcm90b1swXTsKICAgIHZhciBsb3dlclByb3RvID0gcHJvdG8udG9Mb3dlckNhc2UoKTsKICAgIHRoaXMucHJvdG9jb2wgPSBsb3dlclByb3RvOwogICAgcmVzdCA9IHJlc3Quc3Vic3RyKHByb3RvLmxlbmd0aCk7CiAgfQoKICAvLyBmaWd1cmUgb3V0IGlmIGl0J3MgZ290IGEgaG9zdAogIC8vIHVzZXJAc2VydmVyIGlzICphbHdheXMqIGludGVycHJldGVkIGFzIGEgaG9zdG5hbWUsIGFuZCB1cmwKICAvLyByZXNvbHV0aW9uIHdpbGwgdHJlYXQgLy9mb28vYmFyIGFzIGhvc3Q9Zm9vLHBhdGg9YmFyIGJlY2F1c2UgdGhhdCdzCiAgLy8gaG93IHRoZSBicm93c2VyIHJlc29sdmVzIHJlbGF0aXZlIFVSTHMuCiAgaWYgKHNsYXNoZXNEZW5vdGVIb3N0IHx8IHByb3RvIHx8IHJlc3QubWF0Y2goL15cL1wvW15AXC9dK0BbXkBcL10rLykpIHsKICAgIHZhciBzbGFzaGVzID0gcmVzdC5zdWJzdHIoMCwgMikgPT09ICcvLyc7CiAgICBpZiAoc2xhc2hlcyAmJiAhKHByb3RvICYmIGhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dKSkgewogICAgICByZXN0ID0gcmVzdC5zdWJzdHIoMik7CiAgICAgIHRoaXMuc2xhc2hlcyA9IHRydWU7CiAgICB9CiAgfQoKICBpZiAoIWhvc3RsZXNzUHJvdG9jb2xbcHJvdG9dICYmCiAgICAgIChzbGFzaGVzIHx8IChwcm90byAmJiAhc2xhc2hlZFByb3RvY29sW3Byb3RvXSkpKSB7CgogICAgLy8gdGhlcmUncyBhIGhvc3RuYW1lLgogICAgLy8gdGhlIGZpcnN0IGluc3RhbmNlIG9mIC8sID8sIDssIG9yICMgZW5kcyB0aGUgaG9zdC4KICAgIC8vCiAgICAvLyBJZiB0aGVyZSBpcyBhbiBAIGluIHRoZSBob3N0bmFtZSwgdGhlbiBub24taG9zdCBjaGFycyAqYXJlKiBhbGxvd2VkCiAgICAvLyB0byB0aGUgbGVmdCBvZiB0aGUgbGFzdCBAIHNpZ24sIHVubGVzcyBzb21lIGhvc3QtZW5kaW5nIGNoYXJhY3RlcgogICAgLy8gY29tZXMgKmJlZm9yZSogdGhlIEAtc2lnbi4KICAgIC8vIFVSTHMgYXJlIG9ibm94aW91cy4KICAgIC8vCiAgICAvLyBleDoKICAgIC8vIGh0dHA6Ly9hQGJAYy8gPT4gdXNlcjphQGIgaG9zdDpjCiAgICAvLyBodHRwOi8vYUBiP0BjID0+IHVzZXI6YSBob3N0OmMgcGF0aDovP0BjCgogICAgLy8gdjAuMTIgVE9ETyhpc2FhY3MpOiBUaGlzIGlzIG5vdCBxdWl0ZSBob3cgQ2hyb21lIGRvZXMgdGhpbmdzLgogICAgLy8gUmV2aWV3IG91ciB0ZXN0IGNhc2UgYWdhaW5zdCBicm93c2VycyBtb3JlIGNvbXByZWhlbnNpdmVseS4KCiAgICAvLyBmaW5kIHRoZSBmaXJzdCBpbnN0YW5jZSBvZiBhbnkgaG9zdEVuZGluZ0NoYXJzCiAgICB2YXIgaG9zdEVuZCA9IC0xOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBob3N0RW5kaW5nQ2hhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGhlYyA9IHJlc3QuaW5kZXhPZihob3N0RW5kaW5nQ2hhcnNbaV0pOwogICAgICBpZiAoaGVjICE9PSAtMSAmJiAoaG9zdEVuZCA9PT0gLTEgfHwgaGVjIDwgaG9zdEVuZCkpCiAgICAgICAgaG9zdEVuZCA9IGhlYzsKICAgIH0KCiAgICAvLyBhdCB0aGlzIHBvaW50LCBlaXRoZXIgd2UgaGF2ZSBhbiBleHBsaWNpdCBwb2ludCB3aGVyZSB0aGUKICAgIC8vIGF1dGggcG9ydGlvbiBjYW5ub3QgZ28gcGFzdCwgb3IgdGhlIGxhc3QgQCBjaGFyIGlzIHRoZSBkZWNpZGVyLgogICAgdmFyIGF1dGgsIGF0U2lnbjsKICAgIGlmIChob3N0RW5kID09PSAtMSkgewogICAgICAvLyBhdFNpZ24gY2FuIGJlIGFueXdoZXJlLgogICAgICBhdFNpZ24gPSByZXN0Lmxhc3RJbmRleE9mKCdAJyk7CiAgICB9IGVsc2UgewogICAgICAvLyBhdFNpZ24gbXVzdCBiZSBpbiBhdXRoIHBvcnRpb24uCiAgICAgIC8vIGh0dHA6Ly9hQGIvY0BkID0+IGhvc3Q6YiBhdXRoOmEgcGF0aDovY0BkCiAgICAgIGF0U2lnbiA9IHJlc3QubGFzdEluZGV4T2YoJ0AnLCBob3N0RW5kKTsKICAgIH0KCiAgICAvLyBOb3cgd2UgaGF2ZSBhIHBvcnRpb24gd2hpY2ggaXMgZGVmaW5pdGVseSB0aGUgYXV0aC4KICAgIC8vIFB1bGwgdGhhdCBvZmYuCiAgICBpZiAoYXRTaWduICE9PSAtMSkgewogICAgICBhdXRoID0gcmVzdC5zbGljZSgwLCBhdFNpZ24pOwogICAgICByZXN0ID0gcmVzdC5zbGljZShhdFNpZ24gKyAxKTsKICAgICAgdGhpcy5hdXRoID0gZGVjb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgfQoKICAgIC8vIHRoZSBob3N0IGlzIHRoZSByZW1haW5pbmcgdG8gdGhlIGxlZnQgb2YgdGhlIGZpcnN0IG5vbi1ob3N0IGNoYXIKICAgIGhvc3RFbmQgPSAtMTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9uSG9zdENoYXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBoZWMgPSByZXN0LmluZGV4T2Yobm9uSG9zdENoYXJzW2ldKTsKICAgICAgaWYgKGhlYyAhPT0gLTEgJiYgKGhvc3RFbmQgPT09IC0xIHx8IGhlYyA8IGhvc3RFbmQpKQogICAgICAgIGhvc3RFbmQgPSBoZWM7CiAgICB9CiAgICAvLyBpZiB3ZSBzdGlsbCBoYXZlIG5vdCBoaXQgaXQsIHRoZW4gdGhlIGVudGlyZSB0aGluZyBpcyBhIGhvc3QuCiAgICBpZiAoaG9zdEVuZCA9PT0gLTEpCiAgICAgIGhvc3RFbmQgPSByZXN0Lmxlbmd0aDsKCiAgICB0aGlzLmhvc3QgPSByZXN0LnNsaWNlKDAsIGhvc3RFbmQpOwogICAgcmVzdCA9IHJlc3Quc2xpY2UoaG9zdEVuZCk7CgogICAgLy8gcHVsbCBvdXQgcG9ydC4KICAgIHRoaXMucGFyc2VIb3N0KCk7CgogICAgLy8gd2UndmUgaW5kaWNhdGVkIHRoYXQgdGhlcmUgaXMgYSBob3N0bmFtZSwKICAgIC8vIHNvIGV2ZW4gaWYgaXQncyBlbXB0eSwgaXQgaGFzIHRvIGJlIHByZXNlbnQuCiAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKCiAgICAvLyBpZiBob3N0bmFtZSBiZWdpbnMgd2l0aCBbIGFuZCBlbmRzIHdpdGggXQogICAgLy8gYXNzdW1lIHRoYXQgaXQncyBhbiBJUHY2IGFkZHJlc3MuCiAgICB2YXIgaXB2Nkhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZVswXSA9PT0gJ1snICYmCiAgICAgICAgdGhpcy5ob3N0bmFtZVt0aGlzLmhvc3RuYW1lLmxlbmd0aCAtIDFdID09PSAnXSc7CgogICAgLy8gdmFsaWRhdGUgYSBsaXR0bGUuCiAgICBpZiAoIWlwdjZIb3N0bmFtZSkgewogICAgICB2YXIgaG9zdHBhcnRzID0gdGhpcy5ob3N0bmFtZS5zcGxpdCgvXC4vKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBob3N0cGFydHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdmFyIHBhcnQgPSBob3N0cGFydHNbaV07CiAgICAgICAgaWYgKCFwYXJ0KSBjb250aW51ZTsKICAgICAgICBpZiAoIXBhcnQubWF0Y2goaG9zdG5hbWVQYXJ0UGF0dGVybikpIHsKICAgICAgICAgIHZhciBuZXdwYXJ0ID0gJyc7CiAgICAgICAgICBmb3IgKHZhciBqID0gMCwgayA9IHBhcnQubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgIGlmIChwYXJ0LmNoYXJDb2RlQXQoaikgPiAxMjcpIHsKICAgICAgICAgICAgICAvLyB3ZSByZXBsYWNlIG5vbi1BU0NJSSBjaGFyIHdpdGggYSB0ZW1wb3JhcnkgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRoaXMgdG8gbWFrZSBzdXJlIHNpemUgb2YgaG9zdG5hbWUgaXMgbm90CiAgICAgICAgICAgICAgLy8gYnJva2VuIGJ5IHJlcGxhY2luZyBub24tQVNDSUkgYnkgbm90aGluZwogICAgICAgICAgICAgIG5ld3BhcnQgKz0gJ3gnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld3BhcnQgKz0gcGFydFtqXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gd2UgdGVzdCBhZ2FpbiB3aXRoIEFTQ0lJIGNoYXIgb25seQogICAgICAgICAgaWYgKCFuZXdwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFBhdHRlcm4pKSB7CiAgICAgICAgICAgIHZhciB2YWxpZFBhcnRzID0gaG9zdHBhcnRzLnNsaWNlKDAsIGkpOwogICAgICAgICAgICB2YXIgbm90SG9zdCA9IGhvc3RwYXJ0cy5zbGljZShpICsgMSk7CiAgICAgICAgICAgIHZhciBiaXQgPSBwYXJ0Lm1hdGNoKGhvc3RuYW1lUGFydFN0YXJ0KTsKICAgICAgICAgICAgaWYgKGJpdCkgewogICAgICAgICAgICAgIHZhbGlkUGFydHMucHVzaChiaXRbMV0pOwogICAgICAgICAgICAgIG5vdEhvc3QudW5zaGlmdChiaXRbMl0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub3RIb3N0Lmxlbmd0aCkgewogICAgICAgICAgICAgIHJlc3QgPSAnLycgKyBub3RIb3N0LmpvaW4oJy4nKSArIHJlc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5ob3N0bmFtZSA9IHZhbGlkUGFydHMuam9pbignLicpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5ob3N0bmFtZS5sZW5ndGggPiBob3N0bmFtZU1heExlbikgewogICAgICB0aGlzLmhvc3RuYW1lID0gJyc7CiAgICB9IGVsc2UgewogICAgICAvLyBob3N0bmFtZXMgYXJlIGFsd2F5cyBsb3dlciBjYXNlLgogICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS50b0xvd2VyQ2FzZSgpOwogICAgfQoKICAgIGlmICghaXB2Nkhvc3RuYW1lKSB7CiAgICAgIC8vIElETkEgU3VwcG9ydDogUmV0dXJucyBhIHB1bnkgY29kZWQgcmVwcmVzZW50YXRpb24gb2YgImRvbWFpbiIuCiAgICAgIC8vIEl0IG9ubHkgY29udmVydHMgdGhlIHBhcnQgb2YgdGhlIGRvbWFpbiBuYW1lIHRoYXQKICAgICAgLy8gaGFzIG5vbiBBU0NJSSBjaGFyYWN0ZXJzLiBJLmUuIGl0IGRvc2VudCBtYXR0ZXIgaWYKICAgICAgLy8geW91IGNhbGwgaXQgd2l0aCBhIGRvbWFpbiB0aGF0IGFscmVhZHkgaXMgaW4gQVNDSUkuCiAgICAgIHZhciBkb21haW5BcnJheSA9IHRoaXMuaG9zdG5hbWUuc3BsaXQoJy4nKTsKICAgICAgdmFyIG5ld091dCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvbWFpbkFycmF5Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgdmFyIHMgPSBkb21haW5BcnJheVtpXTsKICAgICAgICBuZXdPdXQucHVzaChzLm1hdGNoKC9bXkEtWmEtejAtOV8tXS8pID8KICAgICAgICAgICAgJ3huLS0nICsgcHVueWNvZGUuZW5jb2RlKHMpIDogcyk7CiAgICAgIH0KICAgICAgdGhpcy5ob3N0bmFtZSA9IG5ld091dC5qb2luKCcuJyk7CiAgICB9CgogICAgdmFyIHAgPSB0aGlzLnBvcnQgPyAnOicgKyB0aGlzLnBvcnQgOiAnJzsKICAgIHZhciBoID0gdGhpcy5ob3N0bmFtZSB8fCAnJzsKICAgIHRoaXMuaG9zdCA9IGggKyBwOwogICAgdGhpcy5ocmVmICs9IHRoaXMuaG9zdDsKCiAgICAvLyBzdHJpcCBbIGFuZCBdIGZyb20gdGhlIGhvc3RuYW1lCiAgICAvLyB0aGUgaG9zdCBmaWVsZCBzdGlsbCByZXRhaW5zIHRoZW0sIHRob3VnaAogICAgaWYgKGlwdjZIb3N0bmFtZSkgewogICAgICB0aGlzLmhvc3RuYW1lID0gdGhpcy5ob3N0bmFtZS5zdWJzdHIoMSwgdGhpcy5ob3N0bmFtZS5sZW5ndGggLSAyKTsKICAgICAgaWYgKHJlc3RbMF0gIT09ICcvJykgewogICAgICAgIHJlc3QgPSAnLycgKyByZXN0OwogICAgICB9CiAgICB9CiAgfQoKICAvLyBub3cgcmVzdCBpcyBzZXQgdG8gdGhlIHBvc3QtaG9zdCBzdHVmZi4KICAvLyBjaG9wIG9mZiBhbnkgZGVsaW0gY2hhcnMuCiAgaWYgKCF1bnNhZmVQcm90b2NvbFtsb3dlclByb3RvXSkgewoKICAgIC8vIEZpcnN0LCBtYWtlIDEwMCUgc3VyZSB0aGF0IGFueSAiYXV0b0VzY2FwZSIgY2hhcnMgZ2V0CiAgICAvLyBlc2NhcGVkLCBldmVuIGlmIGVuY29kZVVSSUNvbXBvbmVudCBkb2Vzbid0IHRoaW5rIHRoZXkKICAgIC8vIG5lZWQgdG8gYmUuCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGF1dG9Fc2NhcGUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBhZSA9IGF1dG9Fc2NhcGVbaV07CiAgICAgIHZhciBlc2MgPSBlbmNvZGVVUklDb21wb25lbnQoYWUpOwogICAgICBpZiAoZXNjID09PSBhZSkgewogICAgICAgIGVzYyA9IGVzY2FwZShhZSk7CiAgICAgIH0KICAgICAgcmVzdCA9IHJlc3Quc3BsaXQoYWUpLmpvaW4oZXNjKTsKICAgIH0KICB9CgoKICAvLyBjaG9wIG9mZiBmcm9tIHRoZSB0YWlsIGZpcnN0LgogIHZhciBoYXNoID0gcmVzdC5pbmRleE9mKCcjJyk7CiAgaWYgKGhhc2ggIT09IC0xKSB7CiAgICAvLyBnb3QgYSBmcmFnbWVudCBzdHJpbmcuCiAgICB0aGlzLmhhc2ggPSByZXN0LnN1YnN0cihoYXNoKTsKICAgIHJlc3QgPSByZXN0LnNsaWNlKDAsIGhhc2gpOwogIH0KICB2YXIgcW0gPSByZXN0LmluZGV4T2YoJz8nKTsKICBpZiAocW0gIT09IC0xKSB7CiAgICB0aGlzLnNlYXJjaCA9IHJlc3Quc3Vic3RyKHFtKTsKICAgIHRoaXMucXVlcnkgPSByZXN0LnN1YnN0cihxbSArIDEpOwogICAgaWYgKHBhcnNlUXVlcnlTdHJpbmcpIHsKICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHRoaXMucXVlcnkpOwogICAgfQogICAgcmVzdCA9IHJlc3Quc2xpY2UoMCwgcW0pOwogIH0gZWxzZSBpZiAocGFyc2VRdWVyeVN0cmluZykgewogICAgLy8gbm8gcXVlcnkgc3RyaW5nLCBidXQgcGFyc2VRdWVyeVN0cmluZyBzdGlsbCByZXF1ZXN0ZWQKICAgIHRoaXMuc2VhcmNoID0gJyc7CiAgICB0aGlzLnF1ZXJ5ID0ge307CiAgfQogIGlmIChyZXN0KSB0aGlzLnBhdGhuYW1lID0gcmVzdDsKICBpZiAoc2xhc2hlZFByb3RvY29sW2xvd2VyUHJvdG9dICYmCiAgICAgIHRoaXMuaG9zdG5hbWUgJiYgIXRoaXMucGF0aG5hbWUpIHsKICAgIHRoaXMucGF0aG5hbWUgPSAnLyc7CiAgfQoKICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgaWYgKHRoaXMucGF0aG5hbWUgfHwgdGhpcy5zZWFyY2gpIHsKICAgIHZhciBwID0gdGhpcy5wYXRobmFtZSB8fCAnJzsKICAgIHZhciBzID0gdGhpcy5zZWFyY2ggfHwgJyc7CiAgICB0aGlzLnBhdGggPSBwICsgczsKICB9CgogIC8vIGZpbmFsbHksIHJlY29uc3RydWN0IHRoZSBocmVmIGJhc2VkIG9uIHdoYXQgaGFzIGJlZW4gdmFsaWRhdGVkLgogIHRoaXMuaHJlZiA9IHRoaXMuZm9ybWF0KCk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBmb3JtYXQgYSBwYXJzZWQgb2JqZWN0IGludG8gYSB1cmwgc3RyaW5nCmZ1bmN0aW9uIHVybEZvcm1hdChvYmopIHsKICAvLyBlbnN1cmUgaXQncyBhbiBvYmplY3QsIGFuZCBub3QgYSBzdHJpbmcgdXJsLgogIC8vIElmIGl0J3MgYW4gb2JqLCB0aGlzIGlzIGEgbm8tb3AuCiAgLy8gdGhpcyB3YXksIHlvdSBjYW4gY2FsbCB1cmxfZm9ybWF0KCkgb24gc3RyaW5ncwogIC8vIHRvIGNsZWFuIHVwIHBvdGVudGlhbGx5IHdvbmt5IHVybHMuCiAgaWYgKGlzU3RyaW5nKG9iaikpIG9iaiA9IHVybFBhcnNlKG9iaik7CiAgaWYgKCEob2JqIGluc3RhbmNlb2YgVXJsKSkgcmV0dXJuIFVybC5wcm90b3R5cGUuZm9ybWF0LmNhbGwob2JqKTsKICByZXR1cm4gb2JqLmZvcm1hdCgpOwp9CgpVcmwucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKCkgewogIHZhciBhdXRoID0gdGhpcy5hdXRoIHx8ICcnOwogIGlmIChhdXRoKSB7CiAgICBhdXRoID0gZW5jb2RlVVJJQ29tcG9uZW50KGF1dGgpOwogICAgYXV0aCA9IGF1dGgucmVwbGFjZSgvJTNBL2ksICc6Jyk7CiAgICBhdXRoICs9ICdAJzsKICB9CgogIHZhciBwcm90b2NvbCA9IHRoaXMucHJvdG9jb2wgfHwgJycsCiAgICAgIHBhdGhuYW1lID0gdGhpcy5wYXRobmFtZSB8fCAnJywKICAgICAgaGFzaCA9IHRoaXMuaGFzaCB8fCAnJywKICAgICAgaG9zdCA9IGZhbHNlLAogICAgICBxdWVyeSA9ICcnOwoKICBpZiAodGhpcy5ob3N0KSB7CiAgICBob3N0ID0gYXV0aCArIHRoaXMuaG9zdDsKICB9IGVsc2UgaWYgKHRoaXMuaG9zdG5hbWUpIHsKICAgIGhvc3QgPSBhdXRoICsgKHRoaXMuaG9zdG5hbWUuaW5kZXhPZignOicpID09PSAtMSA/CiAgICAgICAgdGhpcy5ob3N0bmFtZSA6CiAgICAgICAgJ1snICsgdGhpcy5ob3N0bmFtZSArICddJyk7CiAgICBpZiAodGhpcy5wb3J0KSB7CiAgICAgIGhvc3QgKz0gJzonICsgdGhpcy5wb3J0OwogICAgfQogIH0KCiAgaWYgKHRoaXMucXVlcnkgJiYKICAgICAgaXNPYmplY3QodGhpcy5xdWVyeSkgJiYKICAgICAgT2JqZWN0LmtleXModGhpcy5xdWVyeSkubGVuZ3RoKSB7CiAgICBxdWVyeSA9IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeSh0aGlzLnF1ZXJ5KTsKICB9CgogIHZhciBzZWFyY2ggPSB0aGlzLnNlYXJjaCB8fCAocXVlcnkgJiYgKCc/JyArIHF1ZXJ5KSkgfHwgJyc7CgogIGlmIChwcm90b2NvbCAmJiBwcm90b2NvbC5zdWJzdHIoLTEpICE9PSAnOicpIHByb3RvY29sICs9ICc6JzsKCiAgLy8gb25seSB0aGUgc2xhc2hlZFByb3RvY29scyBnZXQgdGhlIC8vLiAgTm90IG1haWx0bzosIHhtcHA6LCBldGMuCiAgLy8gdW5sZXNzIHRoZXkgaGFkIHRoZW0gdG8gYmVnaW4gd2l0aC4KICBpZiAodGhpcy5zbGFzaGVzIHx8CiAgICAgICghcHJvdG9jb2wgfHwgc2xhc2hlZFByb3RvY29sW3Byb3RvY29sXSkgJiYgaG9zdCAhPT0gZmFsc2UpIHsKICAgIGhvc3QgPSAnLy8nICsgKGhvc3QgfHwgJycpOwogICAgaWYgKHBhdGhuYW1lICYmIHBhdGhuYW1lLmNoYXJBdCgwKSAhPT0gJy8nKSBwYXRobmFtZSA9ICcvJyArIHBhdGhuYW1lOwogIH0gZWxzZSBpZiAoIWhvc3QpIHsKICAgIGhvc3QgPSAnJzsKICB9CgogIGlmIChoYXNoICYmIGhhc2guY2hhckF0KDApICE9PSAnIycpIGhhc2ggPSAnIycgKyBoYXNoOwogIGlmIChzZWFyY2ggJiYgc2VhcmNoLmNoYXJBdCgwKSAhPT0gJz8nKSBzZWFyY2ggPSAnPycgKyBzZWFyY2g7CgogIHBhdGhuYW1lID0gcGF0aG5hbWUucmVwbGFjZSgvWz8jXS9nLCBmdW5jdGlvbihtYXRjaCkgewogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChtYXRjaCk7CiAgfSk7CiAgc2VhcmNoID0gc2VhcmNoLnJlcGxhY2UoJyMnLCAnJTIzJyk7CgogIHJldHVybiBwcm90b2NvbCArIGhvc3QgKyBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7Cn07CgpmdW5jdGlvbiB1cmxSZXNvbHZlKHNvdXJjZSwgcmVsYXRpdmUpIHsKICByZXR1cm4gdXJsUGFyc2Uoc291cmNlLCBmYWxzZSwgdHJ1ZSkucmVzb2x2ZShyZWxhdGl2ZSk7Cn0KClVybC5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKHJlbGF0aXZlKSB7CiAgcmV0dXJuIHRoaXMucmVzb2x2ZU9iamVjdCh1cmxQYXJzZShyZWxhdGl2ZSwgZmFsc2UsIHRydWUpKS5mb3JtYXQoKTsKfTsKCmZ1bmN0aW9uIHVybFJlc29sdmVPYmplY3Qoc291cmNlLCByZWxhdGl2ZSkgewogIGlmICghc291cmNlKSByZXR1cm4gcmVsYXRpdmU7CiAgcmV0dXJuIHVybFBhcnNlKHNvdXJjZSwgZmFsc2UsIHRydWUpLnJlc29sdmVPYmplY3QocmVsYXRpdmUpOwp9CgpVcmwucHJvdG90eXBlLnJlc29sdmVPYmplY3QgPSBmdW5jdGlvbihyZWxhdGl2ZSkgewogIGlmIChpc1N0cmluZyhyZWxhdGl2ZSkpIHsKICAgIHZhciByZWwgPSBuZXcgVXJsKCk7CiAgICByZWwucGFyc2UocmVsYXRpdmUsIGZhbHNlLCB0cnVlKTsKICAgIHJlbGF0aXZlID0gcmVsOwogIH0KCiAgdmFyIHJlc3VsdCA9IG5ldyBVcmwoKTsKICBPYmplY3Qua2V5cyh0aGlzKS5mb3JFYWNoKGZ1bmN0aW9uKGspIHsKICAgIHJlc3VsdFtrXSA9IHRoaXNba107CiAgfSwgdGhpcyk7CgogIC8vIGhhc2ggaXMgYWx3YXlzIG92ZXJyaWRkZW4sIG5vIG1hdHRlciB3aGF0LgogIC8vIGV2ZW4gaHJlZj0iIiB3aWxsIHJlbW92ZSBpdC4KICByZXN1bHQuaGFzaCA9IHJlbGF0aXZlLmhhc2g7CgogIC8vIGlmIHRoZSByZWxhdGl2ZSB1cmwgaXMgZW1wdHksIHRoZW4gdGhlcmUncyBub3RoaW5nIGxlZnQgdG8gZG8gaGVyZS4KICBpZiAocmVsYXRpdmUuaHJlZiA9PT0gJycpIHsKICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8vIGhyZWZzIGxpa2UgLy9mb28vYmFyIGFsd2F5cyBjdXQgdG8gdGhlIHByb3RvY29sLgogIGlmIChyZWxhdGl2ZS5zbGFzaGVzICYmICFyZWxhdGl2ZS5wcm90b2NvbCkgewogICAgLy8gdGFrZSBldmVyeXRoaW5nIGV4Y2VwdCB0aGUgcHJvdG9jb2wgZnJvbSByZWxhdGl2ZQogICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICBpZiAoayAhPT0gJ3Byb3RvY29sJykKICAgICAgICByZXN1bHRba10gPSByZWxhdGl2ZVtrXTsKICAgIH0pOwoKICAgIC8vdXJsUGFyc2UgYXBwZW5kcyB0cmFpbGluZyAvIHRvIHVybHMgbGlrZSBodHRwOi8vd3d3LmV4YW1wbGUuY29tCiAgICBpZiAoc2xhc2hlZFByb3RvY29sW3Jlc3VsdC5wcm90b2NvbF0gJiYKICAgICAgICByZXN1bHQuaG9zdG5hbWUgJiYgIXJlc3VsdC5wYXRobmFtZSkgewogICAgICByZXN1bHQucGF0aCA9IHJlc3VsdC5wYXRobmFtZSA9ICcvJzsKICAgIH0KCiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBpZiAocmVsYXRpdmUucHJvdG9jb2wgJiYgcmVsYXRpdmUucHJvdG9jb2wgIT09IHJlc3VsdC5wcm90b2NvbCkgewogICAgLy8gaWYgaXQncyBhIGtub3duIHVybCBwcm90b2NvbCwgdGhlbiBjaGFuZ2luZwogICAgLy8gdGhlIHByb3RvY29sIGRvZXMgd2VpcmQgdGhpbmdzCiAgICAvLyBmaXJzdCwgaWYgaXQncyBub3QgZmlsZTosIHRoZW4gd2UgTVVTVCBoYXZlIGEgaG9zdCwKICAgIC8vIGFuZCBpZiB0aGVyZSB3YXMgYSBwYXRoCiAgICAvLyB0byBiZWdpbiB3aXRoLCB0aGVuIHdlIE1VU1QgaGF2ZSBhIHBhdGguCiAgICAvLyBpZiBpdCBpcyBmaWxlOiwgdGhlbiB0aGUgaG9zdCBpcyBkcm9wcGVkLAogICAgLy8gYmVjYXVzZSB0aGF0J3Mga25vd24gdG8gYmUgaG9zdGxlc3MuCiAgICAvLyBhbnl0aGluZyBlbHNlIGlzIGFzc3VtZWQgdG8gYmUgYWJzb2x1dGUuCiAgICBpZiAoIXNsYXNoZWRQcm90b2NvbFtyZWxhdGl2ZS5wcm90b2NvbF0pIHsKICAgICAgT2JqZWN0LmtleXMocmVsYXRpdmUpLmZvckVhY2goZnVuY3Rpb24oaykgewogICAgICAgIHJlc3VsdFtrXSA9IHJlbGF0aXZlW2tdOwogICAgICB9KTsKICAgICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgcmVzdWx0LnByb3RvY29sID0gcmVsYXRpdmUucHJvdG9jb2w7CiAgICBpZiAoIXJlbGF0aXZlLmhvc3QgJiYgIWhvc3RsZXNzUHJvdG9jb2xbcmVsYXRpdmUucHJvdG9jb2xdKSB7CiAgICAgIHZhciByZWxQYXRoID0gKHJlbGF0aXZlLnBhdGhuYW1lIHx8ICcnKS5zcGxpdCgnLycpOwogICAgICB3aGlsZSAocmVsUGF0aC5sZW5ndGggJiYgIShyZWxhdGl2ZS5ob3N0ID0gcmVsUGF0aC5zaGlmdCgpKSk7CiAgICAgIGlmICghcmVsYXRpdmUuaG9zdCkgcmVsYXRpdmUuaG9zdCA9ICcnOwogICAgICBpZiAoIXJlbGF0aXZlLmhvc3RuYW1lKSByZWxhdGl2ZS5ob3N0bmFtZSA9ICcnOwogICAgICBpZiAocmVsUGF0aFswXSAhPT0gJycpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgIGlmIChyZWxQYXRoLmxlbmd0aCA8IDIpIHJlbFBhdGgudW5zaGlmdCgnJyk7CiAgICAgIHJlc3VsdC5wYXRobmFtZSA9IHJlbFBhdGguam9pbignLycpOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0LnBhdGhuYW1lID0gcmVsYXRpdmUucGF0aG5hbWU7CiAgICB9CiAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICByZXN1bHQuaG9zdCA9IHJlbGF0aXZlLmhvc3QgfHwgJyc7CiAgICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGg7CiAgICByZXN1bHQuaG9zdG5hbWUgPSByZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0OwogICAgcmVzdWx0LnBvcnQgPSByZWxhdGl2ZS5wb3J0OwogICAgLy8gdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgIGlmIChyZXN1bHQucGF0aG5hbWUgfHwgcmVzdWx0LnNlYXJjaCkgewogICAgICB2YXIgcCA9IHJlc3VsdC5wYXRobmFtZSB8fCAnJzsKICAgICAgdmFyIHMgPSByZXN1bHQuc2VhcmNoIHx8ICcnOwogICAgICByZXN1bHQucGF0aCA9IHAgKyBzOwogICAgfQogICAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogICAgcmVzdWx0LmhyZWYgPSByZXN1bHQuZm9ybWF0KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgdmFyIGlzU291cmNlQWJzID0gKHJlc3VsdC5wYXRobmFtZSAmJiByZXN1bHQucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycpLAogICAgICBpc1JlbEFicyA9ICgKICAgICAgICAgIHJlbGF0aXZlLmhvc3QgfHwKICAgICAgICAgIHJlbGF0aXZlLnBhdGhuYW1lICYmIHJlbGF0aXZlLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nCiAgICAgICksCiAgICAgIG11c3RFbmRBYnMgPSAoaXNSZWxBYnMgfHwgaXNTb3VyY2VBYnMgfHwKICAgICAgICAgICAgICAgICAgICAocmVzdWx0Lmhvc3QgJiYgcmVsYXRpdmUucGF0aG5hbWUpKSwKICAgICAgcmVtb3ZlQWxsRG90cyA9IG11c3RFbmRBYnMsCiAgICAgIHNyY1BhdGggPSByZXN1bHQucGF0aG5hbWUgJiYgcmVzdWx0LnBhdGhuYW1lLnNwbGl0KCcvJykgfHwgW10sCiAgICAgIHJlbFBhdGggPSByZWxhdGl2ZS5wYXRobmFtZSAmJiByZWxhdGl2ZS5wYXRobmFtZS5zcGxpdCgnLycpIHx8IFtdLAogICAgICBwc3ljaG90aWMgPSByZXN1bHQucHJvdG9jb2wgJiYgIXNsYXNoZWRQcm90b2NvbFtyZXN1bHQucHJvdG9jb2xdOwoKICAvLyBpZiB0aGUgdXJsIGlzIGEgbm9uLXNsYXNoZWQgdXJsLCB0aGVuIHJlbGF0aXZlCiAgLy8gbGlua3MgbGlrZSAuLi8uLiBzaG91bGQgYmUgYWJsZQogIC8vIHRvIGNyYXdsIHVwIHRvIHRoZSBob3N0bmFtZSwgYXMgd2VsbC4gIFRoaXMgaXMgc3RyYW5nZS4KICAvLyByZXN1bHQucHJvdG9jb2wgaGFzIGFscmVhZHkgYmVlbiBzZXQgYnkgbm93LgogIC8vIExhdGVyIG9uLCBwdXQgdGhlIGZpcnN0IHBhdGggcGFydCBpbnRvIHRoZSBob3N0IGZpZWxkLgogIGlmIChwc3ljaG90aWMpIHsKICAgIHJlc3VsdC5ob3N0bmFtZSA9ICcnOwogICAgcmVzdWx0LnBvcnQgPSBudWxsOwogICAgaWYgKHJlc3VsdC5ob3N0KSB7CiAgICAgIGlmIChzcmNQYXRoWzBdID09PSAnJykgc3JjUGF0aFswXSA9IHJlc3VsdC5ob3N0OwogICAgICBlbHNlIHNyY1BhdGgudW5zaGlmdChyZXN1bHQuaG9zdCk7CiAgICB9CiAgICByZXN1bHQuaG9zdCA9ICcnOwogICAgaWYgKHJlbGF0aXZlLnByb3RvY29sKSB7CiAgICAgIHJlbGF0aXZlLmhvc3RuYW1lID0gbnVsbDsKICAgICAgcmVsYXRpdmUucG9ydCA9IG51bGw7CiAgICAgIGlmIChyZWxhdGl2ZS5ob3N0KSB7CiAgICAgICAgaWYgKHJlbFBhdGhbMF0gPT09ICcnKSByZWxQYXRoWzBdID0gcmVsYXRpdmUuaG9zdDsKICAgICAgICBlbHNlIHJlbFBhdGgudW5zaGlmdChyZWxhdGl2ZS5ob3N0KTsKICAgICAgfQogICAgICByZWxhdGl2ZS5ob3N0ID0gbnVsbDsKICAgIH0KICAgIG11c3RFbmRBYnMgPSBtdXN0RW5kQWJzICYmIChyZWxQYXRoWzBdID09PSAnJyB8fCBzcmNQYXRoWzBdID09PSAnJyk7CiAgfQoKICBpZiAoaXNSZWxBYnMpIHsKICAgIC8vIGl0J3MgYWJzb2x1dGUuCiAgICByZXN1bHQuaG9zdCA9IChyZWxhdGl2ZS5ob3N0IHx8IHJlbGF0aXZlLmhvc3QgPT09ICcnKSA/CiAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3QgOiByZXN1bHQuaG9zdDsKICAgIHJlc3VsdC5ob3N0bmFtZSA9IChyZWxhdGl2ZS5ob3N0bmFtZSB8fCByZWxhdGl2ZS5ob3N0bmFtZSA9PT0gJycpID8KICAgICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlLmhvc3RuYW1lIDogcmVzdWx0Lmhvc3RuYW1lOwogICAgcmVzdWx0LnNlYXJjaCA9IHJlbGF0aXZlLnNlYXJjaDsKICAgIHJlc3VsdC5xdWVyeSA9IHJlbGF0aXZlLnF1ZXJ5OwogICAgc3JjUGF0aCA9IHJlbFBhdGg7CiAgICAvLyBmYWxsIHRocm91Z2ggdG8gdGhlIGRvdC1oYW5kbGluZyBiZWxvdy4KICB9IGVsc2UgaWYgKHJlbFBhdGgubGVuZ3RoKSB7CiAgICAvLyBpdCdzIHJlbGF0aXZlCiAgICAvLyB0aHJvdyBhd2F5IHRoZSBleGlzdGluZyBmaWxlLCBhbmQgdGFrZSB0aGUgbmV3IHBhdGggaW5zdGVhZC4KICAgIGlmICghc3JjUGF0aCkgc3JjUGF0aCA9IFtdOwogICAgc3JjUGF0aC5wb3AoKTsKICAgIHNyY1BhdGggPSBzcmNQYXRoLmNvbmNhdChyZWxQYXRoKTsKICAgIHJlc3VsdC5zZWFyY2ggPSByZWxhdGl2ZS5zZWFyY2g7CiAgICByZXN1bHQucXVlcnkgPSByZWxhdGl2ZS5xdWVyeTsKICB9IGVsc2UgaWYgKCFpc051bGxPclVuZGVmaW5lZChyZWxhdGl2ZS5zZWFyY2gpKSB7CiAgICAvLyBqdXN0IHB1bGwgb3V0IHRoZSBzZWFyY2guCiAgICAvLyBsaWtlIGhyZWY9Jz9mb28nLgogICAgLy8gUHV0IHRoaXMgYWZ0ZXIgdGhlIG90aGVyIHR3byBjYXNlcyBiZWNhdXNlIGl0IHNpbXBsaWZpZXMgdGhlIGJvb2xlYW5zCiAgICBpZiAocHN5Y2hvdGljKSB7CiAgICAgIHJlc3VsdC5ob3N0bmFtZSA9IHJlc3VsdC5ob3N0ID0gc3JjUGF0aC5zaGlmdCgpOwogICAgICAvL29jY2F0aW9uYWx5IHRoZSBhdXRoIGNhbiBnZXQgc3R1Y2sgb25seSBpbiBob3N0CiAgICAgIC8vdGhpcyBlc3BlY2lhbHkgaGFwcGVucyBpbiBjYXNlcyBsaWtlCiAgICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICAgIHZhciBhdXRoSW5Ib3N0ID0gcmVzdWx0Lmhvc3QgJiYgcmVzdWx0Lmhvc3QuaW5kZXhPZignQCcpID4gMCA/CiAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmhvc3Quc3BsaXQoJ0AnKSA6IGZhbHNlOwogICAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICAgIHJlc3VsdC5hdXRoID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICAgIHJlc3VsdC5ob3N0ID0gcmVzdWx0Lmhvc3RuYW1lID0gYXV0aEluSG9zdC5zaGlmdCgpOwogICAgICB9CiAgICB9CiAgICByZXN1bHQuc2VhcmNoID0gcmVsYXRpdmUuc2VhcmNoOwogICAgcmVzdWx0LnF1ZXJ5ID0gcmVsYXRpdmUucXVlcnk7CiAgICAvL3RvIHN1cHBvcnQgaHR0cC5yZXF1ZXN0CiAgICBpZiAoIWlzTnVsbChyZXN1bHQucGF0aG5hbWUpIHx8ICFpc051bGwocmVzdWx0LnNlYXJjaCkpIHsKICAgICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgICAocmVzdWx0LnNlYXJjaCA/IHJlc3VsdC5zZWFyY2ggOiAnJyk7CiAgICB9CiAgICByZXN1bHQuaHJlZiA9IHJlc3VsdC5mb3JtYXQoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBpZiAoIXNyY1BhdGgubGVuZ3RoKSB7CiAgICAvLyBubyBwYXRoIGF0IGFsbC4gIGVhc3kuCiAgICAvLyB3ZSd2ZSBhbHJlYWR5IGhhbmRsZWQgdGhlIG90aGVyIHN0dWZmIGFib3ZlLgogICAgcmVzdWx0LnBhdGhuYW1lID0gbnVsbDsKICAgIC8vdG8gc3VwcG9ydCBodHRwLnJlcXVlc3QKICAgIGlmIChyZXN1bHQuc2VhcmNoKSB7CiAgICAgIHJlc3VsdC5wYXRoID0gJy8nICsgcmVzdWx0LnNlYXJjaDsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdC5wYXRoID0gbnVsbDsKICAgIH0KICAgIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8vIGlmIGEgdXJsIEVORHMgaW4gLiBvciAuLiwgdGhlbiBpdCBtdXN0IGdldCBhIHRyYWlsaW5nIHNsYXNoLgogIC8vIGhvd2V2ZXIsIGlmIGl0IGVuZHMgaW4gYW55dGhpbmcgZWxzZSBub24tc2xhc2h5LAogIC8vIHRoZW4gaXQgbXVzdCBOT1QgZ2V0IGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIGxhc3QgPSBzcmNQYXRoLnNsaWNlKC0xKVswXTsKICB2YXIgaGFzVHJhaWxpbmdTbGFzaCA9ICgKICAgICAgKHJlc3VsdC5ob3N0IHx8IHJlbGF0aXZlLmhvc3QpICYmIChsYXN0ID09PSAnLicgfHwgbGFzdCA9PT0gJy4uJykgfHwKICAgICAgbGFzdCA9PT0gJycpOwoKICAvLyBzdHJpcCBzaW5nbGUgZG90cywgcmVzb2x2ZSBkb3VibGUgZG90cyB0byBwYXJlbnQgZGlyCiAgLy8gaWYgdGhlIHBhdGggdHJpZXMgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIGB1cGAgZW5kcyB1cCA+IDAKICB2YXIgdXAgPSAwOwogIGZvciAodmFyIGkgPSBzcmNQYXRoLmxlbmd0aDsgaSA+PSAwOyBpLS0pIHsKICAgIGxhc3QgPSBzcmNQYXRoW2ldOwogICAgaWYgKGxhc3QgPT0gJy4nKSB7CiAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgfSBlbHNlIGlmIChsYXN0ID09PSAnLi4nKSB7CiAgICAgIHNyY1BhdGguc3BsaWNlKGksIDEpOwogICAgICB1cCsrOwogICAgfSBlbHNlIGlmICh1cCkgewogICAgICBzcmNQYXRoLnNwbGljZShpLCAxKTsKICAgICAgdXAtLTsKICAgIH0KICB9CgogIC8vIGlmIHRoZSBwYXRoIGlzIGFsbG93ZWQgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIHJlc3RvcmUgbGVhZGluZyAuLnMKICBpZiAoIW11c3RFbmRBYnMgJiYgIXJlbW92ZUFsbERvdHMpIHsKICAgIGZvciAoOyB1cC0tOyB1cCkgewogICAgICBzcmNQYXRoLnVuc2hpZnQoJy4uJyk7CiAgICB9CiAgfQoKICBpZiAobXVzdEVuZEFicyAmJiBzcmNQYXRoWzBdICE9PSAnJyAmJgogICAgICAoIXNyY1BhdGhbMF0gfHwgc3JjUGF0aFswXS5jaGFyQXQoMCkgIT09ICcvJykpIHsKICAgIHNyY1BhdGgudW5zaGlmdCgnJyk7CiAgfQoKICBpZiAoaGFzVHJhaWxpbmdTbGFzaCAmJiAoc3JjUGF0aC5qb2luKCcvJykuc3Vic3RyKC0xKSAhPT0gJy8nKSkgewogICAgc3JjUGF0aC5wdXNoKCcnKTsKICB9CgogIHZhciBpc0Fic29sdXRlID0gc3JjUGF0aFswXSA9PT0gJycgfHwKICAgICAgKHNyY1BhdGhbMF0gJiYgc3JjUGF0aFswXS5jaGFyQXQoMCkgPT09ICcvJyk7CgogIC8vIHB1dCB0aGUgaG9zdCBiYWNrCiAgaWYgKHBzeWNob3RpYykgewogICAgcmVzdWx0Lmhvc3RuYW1lID0gcmVzdWx0Lmhvc3QgPSBpc0Fic29sdXRlID8gJycgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmNQYXRoLmxlbmd0aCA/IHNyY1BhdGguc2hpZnQoKSA6ICcnOwogICAgLy9vY2NhdGlvbmFseSB0aGUgYXV0aCBjYW4gZ2V0IHN0dWNrIG9ubHkgaW4gaG9zdAogICAgLy90aGlzIGVzcGVjaWFseSBoYXBwZW5zIGluIGNhc2VzIGxpa2UKICAgIC8vdXJsLnJlc29sdmVPYmplY3QoJ21haWx0bzpsb2NhbDFAZG9tYWluMScsICdsb2NhbDJAZG9tYWluMicpCiAgICB2YXIgYXV0aEluSG9zdCA9IHJlc3VsdC5ob3N0ICYmIHJlc3VsdC5ob3N0LmluZGV4T2YoJ0AnKSA+IDAgPwogICAgICAgICAgICAgICAgICAgICByZXN1bHQuaG9zdC5zcGxpdCgnQCcpIDogZmFsc2U7CiAgICBpZiAoYXV0aEluSG9zdCkgewogICAgICByZXN1bHQuYXV0aCA9IGF1dGhJbkhvc3Quc2hpZnQoKTsKICAgICAgcmVzdWx0Lmhvc3QgPSByZXN1bHQuaG9zdG5hbWUgPSBhdXRoSW5Ib3N0LnNoaWZ0KCk7CiAgICB9CiAgfQoKICBtdXN0RW5kQWJzID0gbXVzdEVuZEFicyB8fCAocmVzdWx0Lmhvc3QgJiYgc3JjUGF0aC5sZW5ndGgpOwoKICBpZiAobXVzdEVuZEFicyAmJiAhaXNBYnNvbHV0ZSkgewogICAgc3JjUGF0aC51bnNoaWZ0KCcnKTsKICB9CgogIGlmICghc3JjUGF0aC5sZW5ndGgpIHsKICAgIHJlc3VsdC5wYXRobmFtZSA9IG51bGw7CiAgICByZXN1bHQucGF0aCA9IG51bGw7CiAgfSBlbHNlIHsKICAgIHJlc3VsdC5wYXRobmFtZSA9IHNyY1BhdGguam9pbignLycpOwogIH0KCiAgLy90byBzdXBwb3J0IHJlcXVlc3QuaHR0cAogIGlmICghaXNOdWxsKHJlc3VsdC5wYXRobmFtZSkgfHwgIWlzTnVsbChyZXN1bHQuc2VhcmNoKSkgewogICAgcmVzdWx0LnBhdGggPSAocmVzdWx0LnBhdGhuYW1lID8gcmVzdWx0LnBhdGhuYW1lIDogJycpICsKICAgICAgICAgICAgICAgICAgKHJlc3VsdC5zZWFyY2ggPyByZXN1bHQuc2VhcmNoIDogJycpOwogIH0KICByZXN1bHQuYXV0aCA9IHJlbGF0aXZlLmF1dGggfHwgcmVzdWx0LmF1dGg7CiAgcmVzdWx0LnNsYXNoZXMgPSByZXN1bHQuc2xhc2hlcyB8fCByZWxhdGl2ZS5zbGFzaGVzOwogIHJlc3VsdC5ocmVmID0gcmVzdWx0LmZvcm1hdCgpOwogIHJldHVybiByZXN1bHQ7Cn07CgpVcmwucHJvdG90eXBlLnBhcnNlSG9zdCA9IGZ1bmN0aW9uKCkgewogIHZhciBob3N0ID0gdGhpcy5ob3N0OwogIHZhciBwb3J0ID0gcG9ydFBhdHRlcm4uZXhlYyhob3N0KTsKICBpZiAocG9ydCkgewogICAgcG9ydCA9IHBvcnRbMF07CiAgICBpZiAocG9ydCAhPT0gJzonKSB7CiAgICAgIHRoaXMucG9ydCA9IHBvcnQuc3Vic3RyKDEpOwogICAgfQogICAgaG9zdCA9IGhvc3Quc3Vic3RyKDAsIGhvc3QubGVuZ3RoIC0gcG9ydC5sZW5ndGgpOwogIH0KICBpZiAoaG9zdCkgdGhpcy5ob3N0bmFtZSA9IGhvc3Q7Cn07CgpmdW5jdGlvbiBpc1N0cmluZyhhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gInN0cmluZyI7Cn0KCmZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzTnVsbChhcmcpIHsKICByZXR1cm4gYXJnID09PSBudWxsOwp9CmZ1bmN0aW9uIGlzTnVsbE9yVW5kZWZpbmVkKGFyZykgewogIHJldHVybiAgYXJnID09IG51bGw7Cn0KCn0seyJwdW55Y29kZSI6OTAsInF1ZXJ5c3RyaW5nIjo5M31dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7CgovKioKICogQ29udmVydCBhcnJheSBvZiAxNiBieXRlIHZhbHVlcyB0byBVVUlEIHN0cmluZyBmb3JtYXQgb2YgdGhlIGZvcm06CiAqIFhYWFhYWFhYLVhYWFgtWFhYWC1YWFhYLVhYWFhYWFhYWFhYWAogKi8KdmFyIGJ5dGVUb0hleCA9IFtdOwoKZm9yICh2YXIgaSA9IDA7IGkgPCAyNTY7ICsraSkgewogIGJ5dGVUb0hleFtpXSA9IChpICsgMHgxMDApLnRvU3RyaW5nKDE2KS5zdWJzdHIoMSk7Cn0KCmZ1bmN0aW9uIGJ5dGVzVG9VdWlkKGJ1Ziwgb2Zmc2V0KSB7CiAgdmFyIGkgPSBvZmZzZXQgfHwgMDsKICB2YXIgYnRoID0gYnl0ZVRvSGV4OyAvLyBqb2luIHVzZWQgdG8gZml4IG1lbW9yeSBpc3N1ZSBjYXVzZWQgYnkgY29uY2F0ZW5hdGlvbjogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MzE3NSNjNAoKICByZXR1cm4gW2J0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgJy0nLCBidGhbYnVmW2krK11dLCBidGhbYnVmW2krK11dLCAnLScsIGJ0aFtidWZbaSsrXV0sIGJ0aFtidWZbaSsrXV0sICctJywgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXSwgYnRoW2J1ZltpKytdXV0uam9pbignJyk7Cn0KCnZhciBfZGVmYXVsdCA9IGJ5dGVzVG9VdWlkOwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7fV0sMTAwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInYxIiwgewogIGVudW1lcmFibGU6IHRydWUsCiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gX3YuZGVmYXVsdDsKICB9Cn0pOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgInYzIiwgewogIGVudW1lcmFibGU6IHRydWUsCiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gX3YyLmRlZmF1bHQ7CiAgfQp9KTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJ2NCIsIHsKICBlbnVtZXJhYmxlOiB0cnVlLAogIGdldDogZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIF92My5kZWZhdWx0OwogIH0KfSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAidjUiLCB7CiAgZW51bWVyYWJsZTogdHJ1ZSwKICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBfdjQuZGVmYXVsdDsKICB9Cn0pOwoKdmFyIF92ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3YxLmpzIikpOwoKdmFyIF92MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi92My5qcyIpKTsKCnZhciBfdjMgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vdjQuanMiKSk7Cgp2YXIgX3Y0ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3Y1LmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KfSx7Ii4vdjEuanMiOjEwNCwiLi92My5qcyI6MTA1LCIuL3Y0LmpzIjoxMDcsIi4vdjUuanMiOjEwOH1dLDEwMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKLyoKICogQnJvd3Nlci1jb21wYXRpYmxlIEphdmFTY3JpcHQgTUQ1CiAqCiAqIE1vZGlmaWNhdGlvbiBvZiBKYXZhU2NyaXB0IE1ENQogKiBodHRwczovL2dpdGh1Yi5jb20vYmx1ZWltcC9KYXZhU2NyaXB0LU1ENQogKgogKiBDb3B5cmlnaHQgMjAxMSwgU2ViYXN0aWFuIFRzY2hhbgogKiBodHRwczovL2JsdWVpbXAubmV0CiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZToKICogaHR0cHM6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQKICoKICogQmFzZWQgb24KICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBSU0EgRGF0YSBTZWN1cml0eSwgSW5jLiBNRDUgTWVzc2FnZQogKiBEaWdlc3QgQWxnb3JpdGhtLCBhcyBkZWZpbmVkIGluIFJGQyAxMzIxLgogKiBWZXJzaW9uIDIuMiBDb3B5cmlnaHQgKEMpIFBhdWwgSm9obnN0b24gMTk5OSAtIDIwMDkKICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIG1vcmUgaW5mby4KICovCmZ1bmN0aW9uIG1kNShieXRlcykgewogIGlmICh0eXBlb2YgYnl0ZXMgPT0gJ3N0cmluZycpIHsKICAgIHZhciBtc2cgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYnl0ZXMpKTsgLy8gVVRGOCBlc2NhcGUKCiAgICBieXRlcyA9IG5ldyBBcnJheShtc2cubGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1zZy5sZW5ndGg7IGkrKykgYnl0ZXNbaV0gPSBtc2cuY2hhckNvZGVBdChpKTsKICB9CgogIHJldHVybiBtZDVUb0hleEVuY29kZWRBcnJheSh3b3Jkc1RvTWQ1KGJ5dGVzVG9Xb3JkcyhieXRlcyksIGJ5dGVzLmxlbmd0aCAqIDgpKTsKfQovKgogKiBDb252ZXJ0IGFuIGFycmF5IG9mIGxpdHRsZS1lbmRpYW4gd29yZHMgdG8gYW4gYXJyYXkgb2YgYnl0ZXMKICovCgoKZnVuY3Rpb24gbWQ1VG9IZXhFbmNvZGVkQXJyYXkoaW5wdXQpIHsKICB2YXIgaTsKICB2YXIgeDsKICB2YXIgb3V0cHV0ID0gW107CiAgdmFyIGxlbmd0aDMyID0gaW5wdXQubGVuZ3RoICogMzI7CiAgdmFyIGhleFRhYiA9ICcwMTIzNDU2Nzg5YWJjZGVmJzsKICB2YXIgaGV4OwoKICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoMzI7IGkgKz0gOCkgewogICAgeCA9IGlucHV0W2kgPj4gNV0gPj4+IGkgJSAzMiAmIDB4ZmY7CiAgICBoZXggPSBwYXJzZUludChoZXhUYWIuY2hhckF0KHggPj4+IDQgJiAweDBmKSArIGhleFRhYi5jaGFyQXQoeCAmIDB4MGYpLCAxNik7CiAgICBvdXRwdXQucHVzaChoZXgpOwogIH0KCiAgcmV0dXJuIG91dHB1dDsKfQovKgogKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzLCBhbmQgYSBiaXQgbGVuZ3RoLgogKi8KCgpmdW5jdGlvbiB3b3Jkc1RvTWQ1KHgsIGxlbikgewogIC8qIGFwcGVuZCBwYWRkaW5nICovCiAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCBsZW4gJSAzMjsKICB4WyhsZW4gKyA2NCA+Pj4gOSA8PCA0KSArIDE0XSA9IGxlbjsKICB2YXIgaTsKICB2YXIgb2xkYTsKICB2YXIgb2xkYjsKICB2YXIgb2xkYzsKICB2YXIgb2xkZDsKICB2YXIgYSA9IDE3MzI1ODQxOTM7CiAgdmFyIGIgPSAtMjcxNzMzODc5OwogIHZhciBjID0gLTE3MzI1ODQxOTQ7CiAgdmFyIGQgPSAyNzE3MzM4Nzg7CgogIGZvciAoaSA9IDA7IGkgPCB4Lmxlbmd0aDsgaSArPSAxNikgewogICAgb2xkYSA9IGE7CiAgICBvbGRiID0gYjsKICAgIG9sZGMgPSBjOwogICAgb2xkZCA9IGQ7CiAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpXSwgNywgLTY4MDg3NjkzNik7CiAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgMV0sIDEyLCAtMzg5NTY0NTg2KTsKICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAyXSwgMTcsIDYwNjEwNTgxOSk7CiAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgM10sIDIyLCAtMTA0NDUyNTMzMCk7CiAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpICsgNF0sIDcsIC0xNzY0MTg4OTcpOwogICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDVdLCAxMiwgMTIwMDA4MDQyNik7CiAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgNl0sIDE3LCAtMTQ3MzIzMTM0MSk7CiAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgN10sIDIyLCAtNDU3MDU5ODMpOwogICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaSArIDhdLCA3LCAxNzcwMDM1NDE2KTsKICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyA5XSwgMTIsIC0xOTU4NDE0NDE3KTsKICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAxMF0sIDE3LCAtNDIwNjMpOwogICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDExXSwgMjIsIC0xOTkwNDA0MTYyKTsKICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2kgKyAxMl0sIDcsIDE4MDQ2MDM2ODIpOwogICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDEzXSwgMTIsIC00MDM0MTEwMSk7CiAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMTRdLCAxNywgLTE1MDIwMDIyOTApOwogICAgYiA9IG1kNWZmKGIsIGMsIGQsIGEsIHhbaSArIDE1XSwgMjIsIDEyMzY1MzUzMjkpOwogICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDFdLCA1LCAtMTY1Nzk2NTEwKTsKICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyA2XSwgOSwgLTEwNjk1MDE2MzIpOwogICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDExXSwgMTQsIDY0MzcxNzcxMyk7CiAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpXSwgMjAsIC0zNzM4OTczMDIpOwogICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDVdLCA1LCAtNzAxNTU4NjkxKTsKICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAxMF0sIDksIDM4MDE2MDgzKTsKICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE0LCAtNjYwNDc4MzM1KTsKICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2kgKyA0XSwgMjAsIC00MDU1Mzc4NDgpOwogICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDldLCA1LCA1Njg0NDY0MzgpOwogICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDE0XSwgOSwgLTEwMTk4MDM2OTApOwogICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDNdLCAxNCwgLTE4NzM2Mzk2MSk7CiAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpICsgOF0sIDIwLCAxMTYzNTMxNTAxKTsKICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyAxM10sIDUsIC0xNDQ0NjgxNDY3KTsKICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAyXSwgOSwgLTUxNDAzNzg0KTsKICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyA3XSwgMTQsIDE3MzUzMjg0NzMpOwogICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaSArIDEyXSwgMjAsIC0xOTI2NjA3NzM0KTsKICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyA1XSwgNCwgLTM3ODU1OCk7CiAgICBkID0gbWQ1aGgoZCwgYSwgYiwgYywgeFtpICsgOF0sIDExLCAtMjAyMjU3NDQ2Myk7CiAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgMTFdLCAxNiwgMTgzOTAzMDU2Mik7CiAgICBiID0gbWQ1aGgoYiwgYywgZCwgYSwgeFtpICsgMTRdLCAyMywgLTM1MzA5NTU2KTsKICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyAxXSwgNCwgLTE1MzA5OTIwNjApOwogICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDRdLCAxMSwgMTI3Mjg5MzM1Myk7CiAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgN10sIDE2LCAtMTU1NDk3NjMyKTsKICAgIGIgPSBtZDVoaChiLCBjLCBkLCBhLCB4W2kgKyAxMF0sIDIzLCAtMTA5NDczMDY0MCk7CiAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgMTNdLCA0LCA2ODEyNzkxNzQpOwogICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaV0sIDExLCAtMzU4NTM3MjIyKTsKICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAzXSwgMTYsIC03MjI1MjE5NzkpOwogICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDZdLCAyMywgNzYwMjkxODkpOwogICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDldLCA0LCAtNjQwMzY0NDg3KTsKICAgIGQgPSBtZDVoaChkLCBhLCBiLCBjLCB4W2kgKyAxMl0sIDExLCAtNDIxODE1ODM1KTsKICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAxNV0sIDE2LCA1MzA3NDI1MjApOwogICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDJdLCAyMywgLTk5NTMzODY1MSk7CiAgICBhID0gbWQ1aWkoYSwgYiwgYywgZCwgeFtpXSwgNiwgLTE5ODYzMDg0NCk7CiAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgN10sIDEwLCAxMTI2ODkxNDE1KTsKICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyAxNF0sIDE1LCAtMTQxNjM1NDkwNSk7CiAgICBiID0gbWQ1aWkoYiwgYywgZCwgYSwgeFtpICsgNV0sIDIxLCAtNTc0MzQwNTUpOwogICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgNiwgMTcwMDQ4NTU3MSk7CiAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgM10sIDEwLCAtMTg5NDk4NjYwNik7CiAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMTBdLCAxNSwgLTEwNTE1MjMpOwogICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDFdLCAyMSwgLTIwNTQ5MjI3OTkpOwogICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDhdLCA2LCAxODczMzEzMzU5KTsKICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAxNV0sIDEwLCAtMzA2MTE3NDQpOwogICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDZdLCAxNSwgLTE1NjAxOTgzODApOwogICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDEzXSwgMjEsIDEzMDkxNTE2NDkpOwogICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDRdLCA2LCAtMTQ1NTIzMDcwKTsKICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAxMV0sIDEwLCAtMTEyMDIxMDM3OSk7CiAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMl0sIDE1LCA3MTg3ODcyNTkpOwogICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDldLCAyMSwgLTM0MzQ4NTU1MSk7CiAgICBhID0gc2FmZUFkZChhLCBvbGRhKTsKICAgIGIgPSBzYWZlQWRkKGIsIG9sZGIpOwogICAgYyA9IHNhZmVBZGQoYywgb2xkYyk7CiAgICBkID0gc2FmZUFkZChkLCBvbGRkKTsKICB9CgogIHJldHVybiBbYSwgYiwgYywgZF07Cn0KLyoKICogQ29udmVydCBhbiBhcnJheSBieXRlcyB0byBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAqIENoYXJhY3RlcnMgPjI1NSBoYXZlIHRoZWlyIGhpZ2gtYnl0ZSBzaWxlbnRseSBpZ25vcmVkLgogKi8KCgpmdW5jdGlvbiBieXRlc1RvV29yZHMoaW5wdXQpIHsKICB2YXIgaTsKICB2YXIgb3V0cHV0ID0gW107CiAgb3V0cHV0WyhpbnB1dC5sZW5ndGggPj4gMikgLSAxXSA9IHVuZGVmaW5lZDsKCiAgZm9yIChpID0gMDsgaSA8IG91dHB1dC5sZW5ndGg7IGkgKz0gMSkgewogICAgb3V0cHV0W2ldID0gMDsKICB9CgogIHZhciBsZW5ndGg4ID0gaW5wdXQubGVuZ3RoICogODsKCiAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDg7IGkgKz0gOCkgewogICAgb3V0cHV0W2kgPj4gNV0gfD0gKGlucHV0W2kgLyA4XSAmIDB4ZmYpIDw8IGkgJSAzMjsKICB9CgogIHJldHVybiBvdXRwdXQ7Cn0KLyoKICogQWRkIGludGVnZXJzLCB3cmFwcGluZyBhdCAyXjMyLiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseQogKiB0byB3b3JrIGFyb3VuZCBidWdzIGluIHNvbWUgSlMgaW50ZXJwcmV0ZXJzLgogKi8KCgpmdW5jdGlvbiBzYWZlQWRkKHgsIHkpIHsKICB2YXIgbHN3ID0gKHggJiAweGZmZmYpICsgKHkgJiAweGZmZmYpOwogIHZhciBtc3cgPSAoeCA+PiAxNikgKyAoeSA+PiAxNikgKyAobHN3ID4+IDE2KTsKICByZXR1cm4gbXN3IDw8IDE2IHwgbHN3ICYgMHhmZmZmOwp9Ci8qCiAqIEJpdHdpc2Ugcm90YXRlIGEgMzItYml0IG51bWJlciB0byB0aGUgbGVmdC4KICovCgoKZnVuY3Rpb24gYml0Um90YXRlTGVmdChudW0sIGNudCkgewogIHJldHVybiBudW0gPDwgY250IHwgbnVtID4+PiAzMiAtIGNudDsKfQovKgogKiBUaGVzZSBmdW5jdGlvbnMgaW1wbGVtZW50IHRoZSBmb3VyIGJhc2ljIG9wZXJhdGlvbnMgdGhlIGFsZ29yaXRobSB1c2VzLgogKi8KCgpmdW5jdGlvbiBtZDVjbW4ocSwgYSwgYiwgeCwgcywgdCkgewogIHJldHVybiBzYWZlQWRkKGJpdFJvdGF0ZUxlZnQoc2FmZUFkZChzYWZlQWRkKGEsIHEpLCBzYWZlQWRkKHgsIHQpKSwgcyksIGIpOwp9CgpmdW5jdGlvbiBtZDVmZihhLCBiLCBjLCBkLCB4LCBzLCB0KSB7CiAgcmV0dXJuIG1kNWNtbihiICYgYyB8IH5iICYgZCwgYSwgYiwgeCwgcywgdCk7Cn0KCmZ1bmN0aW9uIG1kNWdnKGEsIGIsIGMsIGQsIHgsIHMsIHQpIHsKICByZXR1cm4gbWQ1Y21uKGIgJiBkIHwgYyAmIH5kLCBhLCBiLCB4LCBzLCB0KTsKfQoKZnVuY3Rpb24gbWQ1aGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogIHJldHVybiBtZDVjbW4oYiBeIGMgXiBkLCBhLCBiLCB4LCBzLCB0KTsKfQoKZnVuY3Rpb24gbWQ1aWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogIHJldHVybiBtZDVjbW4oYyBeIChiIHwgfmQpLCBhLCBiLCB4LCBzLCB0KTsKfQoKdmFyIF9kZWZhdWx0ID0gbWQ1OwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7fV0sMTAyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSBybmc7Ci8vIFVuaXF1ZSBJRCBjcmVhdGlvbiByZXF1aXJlcyBhIGhpZ2ggcXVhbGl0eSByYW5kb20gIyBnZW5lcmF0b3IuIEluIHRoZSBicm93c2VyIHdlIHRoZXJlZm9yZQovLyByZXF1aXJlIHRoZSBjcnlwdG8gQVBJIGFuZCBkbyBub3Qgc3VwcG9ydCBidWlsdC1pbiBmYWxsYmFjayB0byBsb3dlciBxdWFsaXR5IHJhbmRvbSBudW1iZXIKLy8gZ2VuZXJhdG9ycyAobGlrZSBNYXRoLnJhbmRvbSgpKS4KLy8gZ2V0UmFuZG9tVmFsdWVzIG5lZWRzIHRvIGJlIGludm9rZWQgaW4gYSBjb250ZXh0IHdoZXJlICJ0aGlzIiBpcyBhIENyeXB0byBpbXBsZW1lbnRhdGlvbi4gQWxzbywKLy8gZmluZCB0aGUgY29tcGxldGUgaW1wbGVtZW50YXRpb24gb2YgY3J5cHRvIChtc0NyeXB0bykgb24gSUUxMS4KdmFyIGdldFJhbmRvbVZhbHVlcyA9IHR5cGVvZiBjcnlwdG8gIT0gJ3VuZGVmaW5lZCcgJiYgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyAmJiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzLmJpbmQoY3J5cHRvKSB8fCB0eXBlb2YgbXNDcnlwdG8gIT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcyA9PSAnZnVuY3Rpb24nICYmIG1zQ3J5cHRvLmdldFJhbmRvbVZhbHVlcy5iaW5kKG1zQ3J5cHRvKTsKdmFyIHJuZHM4ID0gbmV3IFVpbnQ4QXJyYXkoMTYpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVuZGVmCgpmdW5jdGlvbiBybmcoKSB7CiAgaWYgKCFnZXRSYW5kb21WYWx1ZXMpIHsKICAgIHRocm93IG5ldyBFcnJvcignY3J5cHRvLmdldFJhbmRvbVZhbHVlcygpIG5vdCBzdXBwb3J0ZWQuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vdXVpZGpzL3V1aWQjZ2V0cmFuZG9tdmFsdWVzLW5vdC1zdXBwb3J0ZWQnKTsKICB9CgogIHJldHVybiBnZXRSYW5kb21WYWx1ZXMocm5kczgpOwp9Cn0se31dLDEwMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICB2YWx1ZTogdHJ1ZQp9KTsKZXhwb3J0cy5kZWZhdWx0ID0gdm9pZCAwOwoKLy8gQWRhcHRlZCBmcm9tIENocmlzIFZlbmVzcycgU0hBMSBjb2RlIGF0Ci8vIGh0dHA6Ly93d3cubW92YWJsZS10eXBlLmNvLnVrL3NjcmlwdHMvc2hhMS5odG1sCmZ1bmN0aW9uIGYocywgeCwgeSwgeikgewogIHN3aXRjaCAocykgewogICAgY2FzZSAwOgogICAgICByZXR1cm4geCAmIHkgXiB+eCAmIHo7CgogICAgY2FzZSAxOgogICAgICByZXR1cm4geCBeIHkgXiB6OwoKICAgIGNhc2UgMjoKICAgICAgcmV0dXJuIHggJiB5IF4geCAmIHogXiB5ICYgejsKCiAgICBjYXNlIDM6CiAgICAgIHJldHVybiB4IF4geSBeIHo7CiAgfQp9CgpmdW5jdGlvbiBST1RMKHgsIG4pIHsKICByZXR1cm4geCA8PCBuIHwgeCA+Pj4gMzIgLSBuOwp9CgpmdW5jdGlvbiBzaGExKGJ5dGVzKSB7CiAgdmFyIEsgPSBbMHg1YTgyNzk5OSwgMHg2ZWQ5ZWJhMSwgMHg4ZjFiYmNkYywgMHhjYTYyYzFkNl07CiAgdmFyIEggPSBbMHg2NzQ1MjMwMSwgMHhlZmNkYWI4OSwgMHg5OGJhZGNmZSwgMHgxMDMyNTQ3NiwgMHhjM2QyZTFmMF07CgogIGlmICh0eXBlb2YgYnl0ZXMgPT0gJ3N0cmluZycpIHsKICAgIHZhciBtc2cgPSB1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYnl0ZXMpKTsgLy8gVVRGOCBlc2NhcGUKCiAgICBieXRlcyA9IG5ldyBBcnJheShtc2cubGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1zZy5sZW5ndGg7IGkrKykgYnl0ZXNbaV0gPSBtc2cuY2hhckNvZGVBdChpKTsKICB9CgogIGJ5dGVzLnB1c2goMHg4MCk7CiAgdmFyIGwgPSBieXRlcy5sZW5ndGggLyA0ICsgMjsKICB2YXIgTiA9IE1hdGguY2VpbChsIC8gMTYpOwogIHZhciBNID0gbmV3IEFycmF5KE4pOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IE47IGkrKykgewogICAgTVtpXSA9IG5ldyBBcnJheSgxNik7CgogICAgZm9yICh2YXIgaiA9IDA7IGogPCAxNjsgaisrKSB7CiAgICAgIE1baV1bal0gPSBieXRlc1tpICogNjQgKyBqICogNF0gPDwgMjQgfCBieXRlc1tpICogNjQgKyBqICogNCArIDFdIDw8IDE2IHwgYnl0ZXNbaSAqIDY0ICsgaiAqIDQgKyAyXSA8PCA4IHwgYnl0ZXNbaSAqIDY0ICsgaiAqIDQgKyAzXTsKICAgIH0KICB9CgogIE1bTiAtIDFdWzE0XSA9IChieXRlcy5sZW5ndGggLSAxKSAqIDggLyBNYXRoLnBvdygyLCAzMik7CiAgTVtOIC0gMV1bMTRdID0gTWF0aC5mbG9vcihNW04gLSAxXVsxNF0pOwogIE1bTiAtIDFdWzE1XSA9IChieXRlcy5sZW5ndGggLSAxKSAqIDggJiAweGZmZmZmZmZmOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IE47IGkrKykgewogICAgdmFyIFcgPSBuZXcgQXJyYXkoODApOwoKICAgIGZvciAodmFyIHQgPSAwOyB0IDwgMTY7IHQrKykgV1t0XSA9IE1baV1bdF07CgogICAgZm9yICh2YXIgdCA9IDE2OyB0IDwgODA7IHQrKykgewogICAgICBXW3RdID0gUk9UTChXW3QgLSAzXSBeIFdbdCAtIDhdIF4gV1t0IC0gMTRdIF4gV1t0IC0gMTZdLCAxKTsKICAgIH0KCiAgICB2YXIgYSA9IEhbMF07CiAgICB2YXIgYiA9IEhbMV07CiAgICB2YXIgYyA9IEhbMl07CiAgICB2YXIgZCA9IEhbM107CiAgICB2YXIgZSA9IEhbNF07CgogICAgZm9yICh2YXIgdCA9IDA7IHQgPCA4MDsgdCsrKSB7CiAgICAgIHZhciBzID0gTWF0aC5mbG9vcih0IC8gMjApOwogICAgICB2YXIgVCA9IFJPVEwoYSwgNSkgKyBmKHMsIGIsIGMsIGQpICsgZSArIEtbc10gKyBXW3RdID4+PiAwOwogICAgICBlID0gZDsKICAgICAgZCA9IGM7CiAgICAgIGMgPSBST1RMKGIsIDMwKSA+Pj4gMDsKICAgICAgYiA9IGE7CiAgICAgIGEgPSBUOwogICAgfQoKICAgIEhbMF0gPSBIWzBdICsgYSA+Pj4gMDsKICAgIEhbMV0gPSBIWzFdICsgYiA+Pj4gMDsKICAgIEhbMl0gPSBIWzJdICsgYyA+Pj4gMDsKICAgIEhbM10gPSBIWzNdICsgZCA+Pj4gMDsKICAgIEhbNF0gPSBIWzRdICsgZSA+Pj4gMDsKICB9CgogIHJldHVybiBbSFswXSA+PiAyNCAmIDB4ZmYsIEhbMF0gPj4gMTYgJiAweGZmLCBIWzBdID4+IDggJiAweGZmLCBIWzBdICYgMHhmZiwgSFsxXSA+PiAyNCAmIDB4ZmYsIEhbMV0gPj4gMTYgJiAweGZmLCBIWzFdID4+IDggJiAweGZmLCBIWzFdICYgMHhmZiwgSFsyXSA+PiAyNCAmIDB4ZmYsIEhbMl0gPj4gMTYgJiAweGZmLCBIWzJdID4+IDggJiAweGZmLCBIWzJdICYgMHhmZiwgSFszXSA+PiAyNCAmIDB4ZmYsIEhbM10gPj4gMTYgJiAweGZmLCBIWzNdID4+IDggJiAweGZmLCBIWzNdICYgMHhmZiwgSFs0XSA+PiAyNCAmIDB4ZmYsIEhbNF0gPj4gMTYgJiAweGZmLCBIWzRdID4+IDggJiAweGZmLCBIWzRdICYgMHhmZl07Cn0KCnZhciBfZGVmYXVsdCA9IHNoYTE7CmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9LHt9XSwxMDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCnZhciBfcm5nID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3JuZy5qcyIpKTsKCnZhciBfYnl0ZXNUb1V1aWQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vYnl0ZXNUb1V1aWQuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKLy8gKipgdjEoKWAgLSBHZW5lcmF0ZSB0aW1lLWJhc2VkIFVVSUQqKgovLwovLyBJbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vTGlvc0svVVVJRC5qcwovLyBhbmQgaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L3V1aWQuaHRtbAp2YXIgX25vZGVJZDsKCnZhciBfY2xvY2tzZXE7IC8vIFByZXZpb3VzIHV1aWQgY3JlYXRpb24gdGltZQoKCnZhciBfbGFzdE1TZWNzID0gMDsKdmFyIF9sYXN0TlNlY3MgPSAwOyAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3V1aWRqcy91dWlkIGZvciBBUEkgZGV0YWlscwoKZnVuY3Rpb24gdjEob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKICB2YXIgYiA9IGJ1ZiB8fCBbXTsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICB2YXIgbm9kZSA9IG9wdGlvbnMubm9kZSB8fCBfbm9kZUlkOwogIHZhciBjbG9ja3NlcSA9IG9wdGlvbnMuY2xvY2tzZXEgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY2xvY2tzZXEgOiBfY2xvY2tzZXE7IC8vIG5vZGUgYW5kIGNsb2Nrc2VxIG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQgdG8gcmFuZG9tIHZhbHVlcyBpZiB0aGV5J3JlIG5vdAogIC8vIHNwZWNpZmllZC4gIFdlIGRvIHRoaXMgbGF6aWx5IHRvIG1pbmltaXplIGlzc3VlcyByZWxhdGVkIHRvIGluc3VmZmljaWVudAogIC8vIHN5c3RlbSBlbnRyb3B5LiAgU2VlICMxODkKCiAgaWYgKG5vZGUgPT0gbnVsbCB8fCBjbG9ja3NlcSA9PSBudWxsKSB7CiAgICB2YXIgc2VlZEJ5dGVzID0gb3B0aW9ucy5yYW5kb20gfHwgKG9wdGlvbnMucm5nIHx8IF9ybmcuZGVmYXVsdCkoKTsKCiAgICBpZiAobm9kZSA9PSBudWxsKSB7CiAgICAgIC8vIFBlciA0LjUsIGNyZWF0ZSBhbmQgNDgtYml0IG5vZGUgaWQsICg0NyByYW5kb20gYml0cyArIG11bHRpY2FzdCBiaXQgPSAxKQogICAgICBub2RlID0gX25vZGVJZCA9IFtzZWVkQnl0ZXNbMF0gfCAweDAxLCBzZWVkQnl0ZXNbMV0sIHNlZWRCeXRlc1syXSwgc2VlZEJ5dGVzWzNdLCBzZWVkQnl0ZXNbNF0sIHNlZWRCeXRlc1s1XV07CiAgICB9CgogICAgaWYgKGNsb2Nrc2VxID09IG51bGwpIHsKICAgICAgLy8gUGVyIDQuMi4yLCByYW5kb21pemUgKDE0IGJpdCkgY2xvY2tzZXEKICAgICAgY2xvY2tzZXEgPSBfY2xvY2tzZXEgPSAoc2VlZEJ5dGVzWzZdIDw8IDggfCBzZWVkQnl0ZXNbN10pICYgMHgzZmZmOwogICAgfQogIH0gLy8gVVVJRCB0aW1lc3RhbXBzIGFyZSAxMDAgbmFuby1zZWNvbmQgdW5pdHMgc2luY2UgdGhlIEdyZWdvcmlhbiBlcG9jaCwKICAvLyAoMTU4Mi0xMC0xNSAwMDowMCkuICBKU051bWJlcnMgYXJlbid0IHByZWNpc2UgZW5vdWdoIGZvciB0aGlzLCBzbwogIC8vIHRpbWUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5IGFzICdtc2VjcycgKGludGVnZXIgbWlsbGlzZWNvbmRzKSBhbmQgJ25zZWNzJwogIC8vICgxMDAtbmFub3NlY29uZHMgb2Zmc2V0IGZyb20gbXNlY3MpIHNpbmNlIHVuaXggZXBvY2gsIDE5NzAtMDEtMDEgMDA6MDAuCgoKICB2YXIgbXNlY3MgPSBvcHRpb25zLm1zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1zZWNzIDogbmV3IERhdGUoKS5nZXRUaW1lKCk7IC8vIFBlciA0LjIuMS4yLCB1c2UgY291bnQgb2YgdXVpZCdzIGdlbmVyYXRlZCBkdXJpbmcgdGhlIGN1cnJlbnQgY2xvY2sKICAvLyBjeWNsZSB0byBzaW11bGF0ZSBoaWdoZXIgcmVzb2x1dGlvbiBjbG9jawoKICB2YXIgbnNlY3MgPSBvcHRpb25zLm5zZWNzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm5zZWNzIDogX2xhc3ROU2VjcyArIDE7IC8vIFRpbWUgc2luY2UgbGFzdCB1dWlkIGNyZWF0aW9uIChpbiBtc2VjcykKCiAgdmFyIGR0ID0gbXNlY3MgLSBfbGFzdE1TZWNzICsgKG5zZWNzIC0gX2xhc3ROU2VjcykgLyAxMDAwMDsgLy8gUGVyIDQuMi4xLjIsIEJ1bXAgY2xvY2tzZXEgb24gY2xvY2sgcmVncmVzc2lvbgoKICBpZiAoZHQgPCAwICYmIG9wdGlvbnMuY2xvY2tzZXEgPT09IHVuZGVmaW5lZCkgewogICAgY2xvY2tzZXEgPSBjbG9ja3NlcSArIDEgJiAweDNmZmY7CiAgfSAvLyBSZXNldCBuc2VjcyBpZiBjbG9jayByZWdyZXNzZXMgKG5ldyBjbG9ja3NlcSkgb3Igd2UndmUgbW92ZWQgb250byBhIG5ldwogIC8vIHRpbWUgaW50ZXJ2YWwKCgogIGlmICgoZHQgPCAwIHx8IG1zZWNzID4gX2xhc3RNU2VjcykgJiYgb3B0aW9ucy5uc2VjcyA9PT0gdW5kZWZpbmVkKSB7CiAgICBuc2VjcyA9IDA7CiAgfSAvLyBQZXIgNC4yLjEuMiBUaHJvdyBlcnJvciBpZiB0b28gbWFueSB1dWlkcyBhcmUgcmVxdWVzdGVkCgoKICBpZiAobnNlY3MgPj0gMTAwMDApIHsKICAgIHRocm93IG5ldyBFcnJvcigidXVpZC52MSgpOiBDYW4ndCBjcmVhdGUgbW9yZSB0aGFuIDEwTSB1dWlkcy9zZWMiKTsKICB9CgogIF9sYXN0TVNlY3MgPSBtc2VjczsKICBfbGFzdE5TZWNzID0gbnNlY3M7CiAgX2Nsb2Nrc2VxID0gY2xvY2tzZXE7IC8vIFBlciA0LjEuNCAtIENvbnZlcnQgZnJvbSB1bml4IGVwb2NoIHRvIEdyZWdvcmlhbiBlcG9jaAoKICBtc2VjcyArPSAxMjIxOTI5MjgwMDAwMDsgLy8gYHRpbWVfbG93YAoKICB2YXIgdGwgPSAoKG1zZWNzICYgMHhmZmZmZmZmKSAqIDEwMDAwICsgbnNlY3MpICUgMHgxMDAwMDAwMDA7CiAgYltpKytdID0gdGwgPj4+IDI0ICYgMHhmZjsKICBiW2krK10gPSB0bCA+Pj4gMTYgJiAweGZmOwogIGJbaSsrXSA9IHRsID4+PiA4ICYgMHhmZjsKICBiW2krK10gPSB0bCAmIDB4ZmY7IC8vIGB0aW1lX21pZGAKCiAgdmFyIHRtaCA9IG1zZWNzIC8gMHgxMDAwMDAwMDAgKiAxMDAwMCAmIDB4ZmZmZmZmZjsKICBiW2krK10gPSB0bWggPj4+IDggJiAweGZmOwogIGJbaSsrXSA9IHRtaCAmIDB4ZmY7IC8vIGB0aW1lX2hpZ2hfYW5kX3ZlcnNpb25gCgogIGJbaSsrXSA9IHRtaCA+Pj4gMjQgJiAweGYgfCAweDEwOyAvLyBpbmNsdWRlIHZlcnNpb24KCiAgYltpKytdID0gdG1oID4+PiAxNiAmIDB4ZmY7IC8vIGBjbG9ja19zZXFfaGlfYW5kX3Jlc2VydmVkYCAoUGVyIDQuMi4yIC0gaW5jbHVkZSB2YXJpYW50KQoKICBiW2krK10gPSBjbG9ja3NlcSA+Pj4gOCB8IDB4ODA7IC8vIGBjbG9ja19zZXFfbG93YAoKICBiW2krK10gPSBjbG9ja3NlcSAmIDB4ZmY7IC8vIGBub2RlYAoKICBmb3IgKHZhciBuID0gMDsgbiA8IDY7ICsrbikgewogICAgYltpICsgbl0gPSBub2RlW25dOwogIH0KCiAgcmV0dXJuIGJ1ZiA/IGJ1ZiA6ICgwLCBfYnl0ZXNUb1V1aWQuZGVmYXVsdCkoYik7Cn0KCnZhciBfZGVmYXVsdCA9IHYxOwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7Ii4vYnl0ZXNUb1V1aWQuanMiOjk5LCIuL3JuZy5qcyI6MTAyfV0sMTA1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSB2b2lkIDA7Cgp2YXIgX3YgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vdjM1LmpzIikpOwoKdmFyIF9tZCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9tZDUuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKY29uc3QgdjMgPSAoMCwgX3YuZGVmYXVsdCkoJ3YzJywgMHgzMCwgX21kLmRlZmF1bHQpOwp2YXIgX2RlZmF1bHQgPSB2MzsKZXhwb3J0cy5kZWZhdWx0ID0gX2RlZmF1bHQ7Cn0seyIuL21kNS5qcyI6MTAxLCIuL3YzNS5qcyI6MTA2fV0sMTA2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKZXhwb3J0cy5VUkwgPSBleHBvcnRzLkROUyA9IHZvaWQgMDsKCnZhciBfYnl0ZXNUb1V1aWQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vYnl0ZXNUb1V1aWQuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKZnVuY3Rpb24gdXVpZFRvQnl0ZXModXVpZCkgewogIC8vIE5vdGU6IFdlIGFzc3VtZSB3ZSdyZSBiZWluZyBwYXNzZWQgYSB2YWxpZCB1dWlkIHN0cmluZwogIHZhciBieXRlcyA9IFtdOwogIHV1aWQucmVwbGFjZSgvW2EtZkEtRjAtOV17Mn0vZywgZnVuY3Rpb24gKGhleCkgewogICAgYnl0ZXMucHVzaChwYXJzZUludChoZXgsIDE2KSk7CiAgfSk7CiAgcmV0dXJuIGJ5dGVzOwp9CgpmdW5jdGlvbiBzdHJpbmdUb0J5dGVzKHN0cikgewogIHN0ciA9IHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChzdHIpKTsgLy8gVVRGOCBlc2NhcGUKCiAgdmFyIGJ5dGVzID0gbmV3IEFycmF5KHN0ci5sZW5ndGgpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkrKykgewogICAgYnl0ZXNbaV0gPSBzdHIuY2hhckNvZGVBdChpKTsKICB9CgogIHJldHVybiBieXRlczsKfQoKY29uc3QgRE5TID0gJzZiYTdiODEwLTlkYWQtMTFkMS04MGI0LTAwYzA0ZmQ0MzBjOCc7CmV4cG9ydHMuRE5TID0gRE5TOwpjb25zdCBVUkwgPSAnNmJhN2I4MTEtOWRhZC0xMWQxLTgwYjQtMDBjMDRmZDQzMGM4JzsKZXhwb3J0cy5VUkwgPSBVUkw7CgpmdW5jdGlvbiBfZGVmYXVsdChuYW1lLCB2ZXJzaW9uLCBoYXNoZnVuYykgewogIHZhciBnZW5lcmF0ZVVVSUQgPSBmdW5jdGlvbiAodmFsdWUsIG5hbWVzcGFjZSwgYnVmLCBvZmZzZXQpIHsKICAgIHZhciBvZmYgPSBidWYgJiYgb2Zmc2V0IHx8IDA7CiAgICBpZiAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSB2YWx1ZSA9IHN0cmluZ1RvQnl0ZXModmFsdWUpOwogICAgaWYgKHR5cGVvZiBuYW1lc3BhY2UgPT0gJ3N0cmluZycpIG5hbWVzcGFjZSA9IHV1aWRUb0J5dGVzKG5hbWVzcGFjZSk7CiAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB0aHJvdyBUeXBlRXJyb3IoJ3ZhbHVlIG11c3QgYmUgYW4gYXJyYXkgb2YgYnl0ZXMnKTsKICAgIGlmICghQXJyYXkuaXNBcnJheShuYW1lc3BhY2UpIHx8IG5hbWVzcGFjZS5sZW5ndGggIT09IDE2KSB0aHJvdyBUeXBlRXJyb3IoJ25hbWVzcGFjZSBtdXN0IGJlIHV1aWQgc3RyaW5nIG9yIGFuIEFycmF5IG9mIDE2IGJ5dGUgdmFsdWVzJyk7IC8vIFBlciA0LjMKCiAgICB2YXIgYnl0ZXMgPSBoYXNoZnVuYyhuYW1lc3BhY2UuY29uY2F0KHZhbHVlKSk7CiAgICBieXRlc1s2XSA9IGJ5dGVzWzZdICYgMHgwZiB8IHZlcnNpb247CiAgICBieXRlc1s4XSA9IGJ5dGVzWzhdICYgMHgzZiB8IDB4ODA7CgogICAgaWYgKGJ1ZikgewogICAgICBmb3IgKHZhciBpZHggPSAwOyBpZHggPCAxNjsgKytpZHgpIHsKICAgICAgICBidWZbb2ZmICsgaWR4XSA9IGJ5dGVzW2lkeF07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmIHx8ICgwLCBfYnl0ZXNUb1V1aWQuZGVmYXVsdCkoYnl0ZXMpOwogIH07IC8vIEZ1bmN0aW9uI25hbWUgaXMgbm90IHNldHRhYmxlIG9uIHNvbWUgcGxhdGZvcm1zICgjMjcwKQoKCiAgdHJ5IHsKICAgIGdlbmVyYXRlVVVJRC5uYW1lID0gbmFtZTsKICB9IGNhdGNoIChlcnIpIHt9IC8vIEZvciBDb21tb25KUyBkZWZhdWx0IGV4cG9ydCBzdXBwb3J0CgoKICBnZW5lcmF0ZVVVSUQuRE5TID0gRE5TOwogIGdlbmVyYXRlVVVJRC5VUkwgPSBVUkw7CiAgcmV0dXJuIGdlbmVyYXRlVVVJRDsKfQp9LHsiLi9ieXRlc1RvVXVpZC5qcyI6OTl9XSwxMDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCnZhciBfcm5nID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCIuL3JuZy5qcyIpKTsKCnZhciBfYnl0ZXNUb1V1aWQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoIi4vYnl0ZXNUb1V1aWQuanMiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKZnVuY3Rpb24gdjQob3B0aW9ucywgYnVmLCBvZmZzZXQpIHsKICB2YXIgaSA9IGJ1ZiAmJiBvZmZzZXQgfHwgMDsKCiAgaWYgKHR5cGVvZiBvcHRpb25zID09ICdzdHJpbmcnKSB7CiAgICBidWYgPSBvcHRpb25zID09PSAnYmluYXJ5JyA/IG5ldyBBcnJheSgxNikgOiBudWxsOwogICAgb3B0aW9ucyA9IG51bGw7CiAgfQoKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgdmFyIHJuZHMgPSBvcHRpb25zLnJhbmRvbSB8fCAob3B0aW9ucy5ybmcgfHwgX3JuZy5kZWZhdWx0KSgpOyAvLyBQZXIgNC40LCBzZXQgYml0cyBmb3IgdmVyc2lvbiBhbmQgYGNsb2NrX3NlcV9oaV9hbmRfcmVzZXJ2ZWRgCgoKICBybmRzWzZdID0gcm5kc1s2XSAmIDB4MGYgfCAweDQwOwogIHJuZHNbOF0gPSBybmRzWzhdICYgMHgzZiB8IDB4ODA7IC8vIENvcHkgYnl0ZXMgdG8gYnVmZmVyLCBpZiBwcm92aWRlZAoKICBpZiAoYnVmKSB7CiAgICBmb3IgKHZhciBpaSA9IDA7IGlpIDwgMTY7ICsraWkpIHsKICAgICAgYnVmW2kgKyBpaV0gPSBybmRzW2lpXTsKICAgIH0KICB9CgogIHJldHVybiBidWYgfHwgKDAsIF9ieXRlc1RvVXVpZC5kZWZhdWx0KShybmRzKTsKfQoKdmFyIF9kZWZhdWx0ID0gdjQ7CmV4cG9ydHMuZGVmYXVsdCA9IF9kZWZhdWx0Owp9LHsiLi9ieXRlc1RvVXVpZC5qcyI6OTksIi4vcm5nLmpzIjoxMDJ9XSwxMDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgdmFsdWU6IHRydWUKfSk7CmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDsKCnZhciBfdiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi92MzUuanMiKSk7Cgp2YXIgX3NoYSA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiLi9zaGExLmpzIikpOwoKZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH0KCmNvbnN0IHY1ID0gKDAsIF92LmRlZmF1bHQpKCd2NScsIDB4NTAsIF9zaGEuZGVmYXVsdCk7CnZhciBfZGVmYXVsdCA9IHY1OwpleHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsKfSx7Ii4vc2hhMS5qcyI6MTAzLCIuL3YzNS5qcyI6MTA2fV0sMTA5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwpPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7IHZhbHVlOiB0cnVlIH0pOwp2YXIgTFJVXzEgPSByZXF1aXJlKCIuL3V0aWxzL0xSVSIpOwp2YXIgQ0FDSEVfU0laRSA9IDEwMDA7Ci8qKgogKiBJbnNwaXJlZCBub2RlLWxydS1jYWNoZVtodHRwczovL2dpdGh1Yi5jb20vaXNhYWNzL25vZGUtbHJ1LWNhY2hlXQogKi8KdmFyIEVuZHBvaW50Q2FjaGUgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBFbmRwb2ludENhY2hlKG1heFNpemUpIHsKICAgICAgICBpZiAobWF4U2l6ZSA9PT0gdm9pZCAwKSB7IG1heFNpemUgPSBDQUNIRV9TSVpFOyB9CiAgICAgICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZTsKICAgICAgICB0aGlzLmNhY2hlID0gbmV3IExSVV8xLkxSVUNhY2hlKG1heFNpemUpOwogICAgfQogICAgOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLCAic2l6ZSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGUubGVuZ3RoOwogICAgICAgIH0sCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICB2YXIgZW5kcG9pbnRSZWNvcmQgPSB0aGlzLnBvcHVsYXRlVmFsdWUodmFsdWUpOwogICAgICAgIHRoaXMuY2FjaGUucHV0KGtleVN0cmluZywgZW5kcG9pbnRSZWNvcmQpOwogICAgfTsKICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgdmFyIGtleVN0cmluZyA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gRW5kcG9pbnRDYWNoZS5nZXRLZXlTdHJpbmcoa2V5KSA6IGtleTsKICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuY2FjaGUuZ2V0KGtleVN0cmluZyk7CiAgICAgICAgaWYgKHJlY29yZHMpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHJlY29yZHMubGVuZ3RoLTE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVjb3JkID0gcmVjb3Jkc1tpXTsKICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuRXhwaXJlIDwgbm93KSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3Jkcy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlY29yZHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnJlbW92ZShrZXlTdHJpbmcpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVjb3JkczsKICAgIH07CiAgICBFbmRwb2ludENhY2hlLmdldEtleVN0cmluZyA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICB2YXIgaWRlbnRpZmllcnMgPSBbXTsKICAgICAgICB2YXIgaWRlbnRpZmllck5hbWVzID0gT2JqZWN0LmtleXMoa2V5KS5zb3J0KCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpZGVudGlmaWVyTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGlkZW50aWZpZXJOYW1lID0gaWRlbnRpZmllck5hbWVzW2ldOwogICAgICAgICAgICBpZiAoa2V5W2lkZW50aWZpZXJOYW1lXSA9PT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGlkZW50aWZpZXJzLnB1c2goa2V5W2lkZW50aWZpZXJOYW1lXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpZGVudGlmaWVycy5qb2luKCcgJyk7CiAgICB9OwogICAgRW5kcG9pbnRDYWNoZS5wcm90b3R5cGUucG9wdWxhdGVWYWx1ZSA9IGZ1bmN0aW9uIChlbmRwb2ludHMpIHsKICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICByZXR1cm4gZW5kcG9pbnRzLm1hcChmdW5jdGlvbiAoZW5kcG9pbnQpIHsgcmV0dXJuICh7CiAgICAgICAgICAgIEFkZHJlc3M6IGVuZHBvaW50LkFkZHJlc3MgfHwgJycsCiAgICAgICAgICAgIEV4cGlyZTogbm93ICsgKGVuZHBvaW50LkNhY2hlUGVyaW9kSW5NaW51dGVzIHx8IDEpICogNjAgKiAxMDAwCiAgICAgICAgfSk7IH0pOwogICAgfTsKICAgIEVuZHBvaW50Q2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuY2FjaGUuZW1wdHkoKTsKICAgIH07CiAgICBFbmRwb2ludENhY2hlLnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBrZXlTdHJpbmcgPSB0eXBlb2Yga2V5ICE9PSAnc3RyaW5nJyA/IEVuZHBvaW50Q2FjaGUuZ2V0S2V5U3RyaW5nKGtleSkgOiBrZXk7CiAgICAgICAgdGhpcy5jYWNoZS5yZW1vdmUoa2V5U3RyaW5nKTsKICAgIH07CiAgICByZXR1cm4gRW5kcG9pbnRDYWNoZTsKfSgpKTsKZXhwb3J0cy5FbmRwb2ludENhY2hlID0gRW5kcG9pbnRDYWNoZTsKfSx7Ii4vdXRpbHMvTFJVIjoxMTB9XSwxMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CnZhciBMaW5rZWRMaXN0Tm9kZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpIHsKICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICByZXR1cm4gTGlua2VkTGlzdE5vZGU7Cn0oKSk7CnZhciBMUlVDYWNoZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHsKICAgIGZ1bmN0aW9uIExSVUNhY2hlKHNpemUpIHsKICAgICAgICB0aGlzLm5vZGVNYXAgPSB7fTsKICAgICAgICB0aGlzLnNpemUgPSAwOwogICAgICAgIGlmICh0eXBlb2Ygc2l6ZSAhPT0gJ251bWJlcicgfHwgc2l6ZSA8IDEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWNoZSBzaXplIGNhbiBvbmx5IGJlIHBvc2l0aXZlIG51bWJlcicpOwogICAgICAgIH0KICAgICAgICB0aGlzLnNpemVMaW1pdCA9IHNpemU7CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoTFJVQ2FjaGUucHJvdG90eXBlLCAibGVuZ3RoIiwgewogICAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zaXplOwogICAgICAgIH0sCiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogICAgTFJVQ2FjaGUucHJvdG90eXBlLnByZXBlbmRUb0xpc3QgPSBmdW5jdGlvbiAobm9kZSkgewogICAgICAgIGlmICghdGhpcy5oZWFkZXJOb2RlKSB7CiAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdGhpcy5oZWFkZXJOb2RlLnByZXYgPSBub2RlOwogICAgICAgICAgICBub2RlLm5leHQgPSB0aGlzLmhlYWRlck5vZGU7CiAgICAgICAgfQogICAgICAgIHRoaXMuaGVhZGVyTm9kZSA9IG5vZGU7CiAgICAgICAgdGhpcy5zaXplKys7CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZUZyb21UYWlsID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghdGhpcy50YWlsTm9kZSkgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICB2YXIgbm9kZSA9IHRoaXMudGFpbE5vZGU7CiAgICAgICAgdmFyIHByZXZOb2RlID0gbm9kZS5wcmV2OwogICAgICAgIGlmIChwcmV2Tm9kZSkgewogICAgICAgICAgICBwcmV2Tm9kZS5uZXh0ID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy50YWlsTm9kZSA9IHByZXZOb2RlOwogICAgICAgIHRoaXMuc2l6ZS0tOwogICAgICAgIHJldHVybiBub2RlOwogICAgfTsKICAgIExSVUNhY2hlLnByb3RvdHlwZS5kZXRhY2hGcm9tTGlzdCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgaWYgKHRoaXMuaGVhZGVyTm9kZSA9PT0gbm9kZSkgewogICAgICAgICAgICB0aGlzLmhlYWRlck5vZGUgPSBub2RlLm5leHQ7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnRhaWxOb2RlID09PSBub2RlKSB7CiAgICAgICAgICAgIHRoaXMudGFpbE5vZGUgPSBub2RlLnByZXY7CiAgICAgICAgfQogICAgICAgIGlmIChub2RlLnByZXYpIHsKICAgICAgICAgICAgbm9kZS5wcmV2Lm5leHQgPSBub2RlLm5leHQ7CiAgICAgICAgfQogICAgICAgIGlmIChub2RlLm5leHQpIHsKICAgICAgICAgICAgbm9kZS5uZXh0LnByZXYgPSBub2RlLnByZXY7CiAgICAgICAgfQogICAgICAgIG5vZGUubmV4dCA9IHVuZGVmaW5lZDsKICAgICAgICBub2RlLnByZXYgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5zaXplLS07CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgdGhpcy5wcmVwZW5kVG9MaXN0KG5vZGUpOwogICAgICAgICAgICByZXR1cm4gbm9kZS52YWx1ZTsKICAgICAgICB9CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICAgICAgdGhpcy5kZXRhY2hGcm9tTGlzdChub2RlKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXldOwogICAgICAgIH0KICAgIH07CiAgICBMUlVDYWNoZS5wcm90b3R5cGUucHV0ID0gZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5ub2RlTWFwW2tleV0pIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmUoa2V5KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5zaXplID09PSB0aGlzLnNpemVMaW1pdCkgewogICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSB0aGlzLnJlbW92ZUZyb21UYWlsKCk7CiAgICAgICAgICAgIHZhciBrZXlfMSA9IHRhaWxOb2RlLmtleTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubm9kZU1hcFtrZXlfMV07CiAgICAgICAgfQogICAgICAgIHZhciBuZXdOb2RlID0gbmV3IExpbmtlZExpc3ROb2RlKGtleSwgdmFsdWUpOwogICAgICAgIHRoaXMubm9kZU1hcFtrZXldID0gbmV3Tm9kZTsKICAgICAgICB0aGlzLnByZXBlbmRUb0xpc3QobmV3Tm9kZSk7CiAgICB9OwogICAgTFJVQ2FjaGUucHJvdG90eXBlLmVtcHR5ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXModGhpcy5ub2RlTWFwKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgIHZhciBub2RlID0gdGhpcy5ub2RlTWFwW2tleV07CiAgICAgICAgICAgIHRoaXMuZGV0YWNoRnJvbUxpc3Qobm9kZSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vZGVNYXBba2V5XTsKICAgICAgICB9CiAgICB9OwogICAgcmV0dXJuIExSVUNhY2hlOwp9KCkpOwpleHBvcnRzLkxSVUNhY2hlID0gTFJVQ2FjaGU7Cn0se31dLDExMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEFXUyBTREsgZm9yIEphdmFTY3JpcHQgdjIuMTIwMC4wCi8vIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgovLyBMaWNlbnNlIGF0IGh0dHBzOi8vc2RrLmFtYXpvbmF3cy5jb20vanMvQlVORExFX0xJQ0VOU0UudHh0CnJlcXVpcmUoJy4vYnJvd3Nlcl9sb2FkZXInKTsKCnZhciBBV1MgPSByZXF1aXJlKCcuL2NvcmUnKTsKCmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgd2luZG93LkFXUyA9IEFXUzsKaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAvKioKICAgICAqIEBhcGkgcHJpdmF0ZQogICAgICovCiAgICBtb2R1bGUuZXhwb3J0cyA9IEFXUzsKfQppZiAodHlwZW9mIHNlbGYgIT09ICd1bmRlZmluZWQnKSBzZWxmLkFXUyA9IEFXUzsKCi8qKgogKiBAcHJpdmF0ZQogKiBETyBOT1QgUkVNT1ZFCiAqIGJyb3dzZXIgYnVpbGRlciB3aWxsIHN0cmlwIG91dCB0aGlzIGxpbmUgaWYgc2VydmljZXMgYXJlIHN1cHBsaWVkIG9uIHRoZSBjb21tYW5kIGxpbmUuCiAqL2lmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKEFXUywgJ0Nvbm5lY3QnKSkgewogIEFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXSA9IHt9OwogIEFXUy5Db25uZWN0ID0gQVdTLlNlcnZpY2UuZGVmaW5lU2VydmljZSgnY29ubmVjdCcsIFsgJzIwMTctMDItMTUnIF0pOwp9CkFXUy5hcGlMb2FkZXIuc2VydmljZXNbJ2Nvbm5lY3QnXVsnMjAxNy0wMi0xNSddID0gcmVxdWlyZSgnLi4vYXBpcy9jb25uZWN0LTIwMTctMDItMTUubWluJyk7CgoKfSx7Ii4uL2FwaXMvY29ubmVjdC0yMDE3LTAyLTE1Lm1pbiI6MywiLi9icm93c2VyX2xvYWRlciI6MTYsIi4vY29yZSI6MTl9XX0se30sWzExMV0pOwoKCgovKioqLyB9KSwKCi8qKiovIDc1NDoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogZW51bSBDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LkNsaWVudE1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgICAgJ2dldEFnZW50U25hcHNob3QnLAogICAgICAgICAncHV0QWdlbnRTdGF0ZScsCiAgICAgICAgICdnZXRBZ2VudFN0YXRlcycsCiAgICAgICAgICdnZXREaWFsYWJsZUNvdW50cnlDb2RlcycsCiAgICAgICAgICdnZXRSb3V0aW5nUHJvZmlsZVF1ZXVlcycsCiAgICAgICAgICdnZXRBZ2VudFBlcm1pc3Npb25zJywKICAgICAgICAgJ2dldEFnZW50Q29uZmlndXJhdGlvbicsCiAgICAgICAgICd1cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24nLAogICAgICAgICAnYWNjZXB0Q29udGFjdCcsCiAgICAgICAgICdjcmVhdGVPdXRib3VuZENvbnRhY3QnLAogICAgICAgICAnY3JlYXRlVGFza0NvbnRhY3QnLAogICAgICAgICAnY2xlYXJDb250YWN0JywKICAgICAgICAgJ2NvbXBsZXRlQ29udGFjdCcsCiAgICAgICAgICdkZXN0cm95Q29udGFjdCcsCiAgICAgICAgICdyZWplY3RDb250YWN0JywKICAgICAgICAgJ25vdGlmeUNvbnRhY3RJc3N1ZScsCiAgICAgICAgICd1cGRhdGVDb250YWN0QXR0cmlidXRlcycsCiAgICAgICAgICdjcmVhdGVBZGRpdGlvbmFsQ29ubmVjdGlvbicsCiAgICAgICAgICdkZXN0cm95Q29ubmVjdGlvbicsCiAgICAgICAgICdob2xkQ29ubmVjdGlvbicsCiAgICAgICAgICdyZXN1bWVDb25uZWN0aW9uJywKICAgICAgICAgJ3RvZ2dsZUFjdGl2ZUNvbm5lY3Rpb25zJywKICAgICAgICAgJ2NvbmZlcmVuY2VDb25uZWN0aW9ucycsCiAgICAgICAgICdzZW5kQ2xpZW50TG9ncycsCiAgICAgICAgICdzZW5kRGlnaXRzJywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsUmVwb3J0JywKICAgICAgICAgJ3NlbmRTb2Z0cGhvbmVDYWxsTWV0cmljcycsCiAgICAgICAgICdnZXRFbmRwb2ludHMnLAogICAgICAgICAnZ2V0TmV3QXV0aFRva2VuJywKICAgICAgICAgJ2NyZWF0ZVRyYW5zcG9ydCcsCiAgICAgICAgICdtdXRlUGFydGljaXBhbnQnLAogICAgICAgICAndW5tdXRlUGFydGljaXBhbnQnLAogICAgICAgICAndXBkYXRlTW9uaXRvclBhcnRpY2lwYW50U3RhdGUnCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQWdlbnRBcHBDbGllbnRNZXRob2RzCiAgICAqLwogICBjb25uZWN0LkFnZW50QXBwQ2xpZW50TWV0aG9kcyA9IHsKICAgICAgR0VUX0NPTlRBQ1Q6ICJBZ2VudEFwcFNlcnZpY2UuTGNtcy5nZXRDb250YWN0IiwKICAgICAgREVMRVRFX1NQRUFLRVI6ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5kZWxldGVTcGVha2VyIiwKICAgICAgRU5ST0xMX0JZX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuVm9pY2VJZC5lbnJvbGxCeVNlc3Npb24iLAogICAgICBFVkFMVUFURV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQuZXZhbHVhdGVTZXNzaW9uIiwKICAgICAgREVTQ1JJQkVfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU3BlYWtlciIsCiAgICAgIE9QVF9PVVRfU1BFQUtFUjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLm9wdE91dFNwZWFrZXIiLAogICAgICBVUERBVEVfVk9JQ0VfSURfREFUQTogIkFnZW50QXBwU2VydmljZS5MY21zLnVwZGF0ZVZvaWNlSWREYXRhIiwKICAgICAgREVTQ1JJQkVfU0VTU0lPTjogIkFnZW50QXBwU2VydmljZS5Wb2ljZUlkLmRlc2NyaWJlU2Vzc2lvbiIsCiAgICAgIFVQREFURV9TRVNTSU9OOiAiQWdlbnRBcHBTZXJ2aWNlLlZvaWNlSWQudXBkYXRlU2Vzc2lvbiIsCiAgICAgIFNUQVJUX1ZPSUNFX0lEX1NFU1NJT046ICJBZ2VudEFwcFNlcnZpY2UuTmFzYS5zdGFydFZvaWNlSWRTZXNzaW9uIiwKICAgICAgTElTVF9JTlRFR1JBVElPTl9BU1NPQ0lBVElPTlM6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLmxpc3RJbnRlZ3JhdGlvbkFzc29jaWF0aW9ucyIsCiAgICAgIFNUQVJUX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5TdGFydENvbnRhY3RSZWNvcmRpbmciLAogICAgICBTVE9QX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5TdG9wQ29udGFjdFJlY29yZGluZyIsCiAgICAgIFNVU1BFTkRfQ09OVEFDVF9SRUNPUkRJTkc6ICJBZ2VudEFwcFNlcnZpY2UuQWNzLlN1c3BlbmRDb250YWN0UmVjb3JkaW5nIiwKICAgICAgUkVTVU1FX0NPTlRBQ1RfUkVDT1JESU5HOiAiQWdlbnRBcHBTZXJ2aWNlLkFjcy5SZXN1bWVDb250YWN0UmVjb3JkaW5nIgogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gTWFzdGVyTWV0aG9kcwogICAgKi8KICAgY29ubmVjdC5NYXN0ZXJNZXRob2RzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAgICAgICdiZWNvbWVNYXN0ZXInLAogICAgICAgICAnY2hlY2tNYXN0ZXInCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMKICAgICovCiAgIGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMgPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICAgJ2xpc3RUYXNrVGVtcGxhdGVzJywKICAgICAgJ2dldFRhc2tUZW1wbGF0ZScsCiAgICAgICdjcmVhdGVUZW1wbGF0ZWRUYXNrJywKICAgICAgJ3VwZGF0ZUNvbnRhY3QnCiAgIF0pOwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBDbGllbnRCYXNlID0gZnVuY3Rpb24oKSB7fTsKICAgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1MgPSB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgeyB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHsgfQogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuY2FsbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zSW4sIGNhbGxiYWNrc0luKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtZXRob2QsICdtZXRob2QnKTsKICAgICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgICB2YXIgY2FsbGJhY2tzID0gY2FsbGJhY2tzSW4gfHwgQ2xpZW50QmFzZS5FTVBUWV9DQUxMQkFDS1M7CiAgICAgIHRoaXMuX2NhbGxJbXBsKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpOwogICB9OwoKICAgQ2xpZW50QmFzZS5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgTnVsbENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBOdWxsQ2xpZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgfTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKENsaWVudEJhc2UucHJvdG90eXBlKTsKICAgTnVsbENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBOdWxsQ2xpZW50OwoKICAgTnVsbENsaWVudC5wcm90b3R5cGUuX2NhbGxJbXBsID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrcykgewogICAgICBpZiAoY2FsbGJhY2tzICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIHZhciBtZXNzYWdlID0gY29ubmVjdC5zcHJpbnRmKCdObyBzdWNoIG1ldGhvZCBleGlzdHMgb24gTlVMTCBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKICAgICAgfQogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGFic3RyYWN0IGNsYXNzIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICAqLwogICB2YXIgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZSA9IGZ1bmN0aW9uKGNvbmR1aXQsIHJlcXVlc3RFdmVudCwgcmVzcG9uc2VFdmVudCkgewogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICAgIHRoaXMucmVxdWVzdEV2ZW50ID0gcmVxdWVzdEV2ZW50OwogICAgICB0aGlzLnJlc3BvbnNlRXZlbnQgPSByZXNwb25zZUV2ZW50OwogICAgICB0aGlzLl9yZXF1ZXN0SWRDYWxsYmFja3NNYXAgPSB7fTsKCiAgICAgIHRoaXMuY29uZHVpdC5vblVwc3RyZWFtKHJlc3BvbnNlRXZlbnQsIGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5faGFuZGxlUmVzcG9uc2UpKTsKICAgfTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZTsKCiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudEJhc2UucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgdmFyIHJlcXVlc3QgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXF1ZXN0KHRoaXMucmVxdWVzdEV2ZW50LCBtZXRob2QsIHBhcmFtcyk7CiAgICAgIHRoaXMuX3JlcXVlc3RJZENhbGxiYWNrc01hcFtyZXF1ZXN0LnJlcXVlc3RJZF0gPSBjYWxsYmFja3M7CiAgICAgIHRoaXMuY29uZHVpdC5zZW5kVXBzdHJlYW0ocmVxdWVzdC5ldmVudCwgcmVxdWVzdCk7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5fZ2V0Q2FsbGJhY2tzRm9yUmVxdWVzdCA9IGZ1bmN0aW9uKHJlcXVlc3RJZCkgewogICAgICB2YXIgY2FsbGJhY2tzID0gdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF0gfHwgbnVsbDsKCiAgICAgIGlmIChjYWxsYmFja3MgIT0gbnVsbCkgewogICAgICAgICBkZWxldGUgdGhpcy5fcmVxdWVzdElkQ2FsbGJhY2tzTWFwW3JlcXVlc3RJZF07CiAgICAgIH0KCiAgICAgIHJldHVybiBjYWxsYmFja3M7CiAgIH07CgogICBVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZS5faGFuZGxlUmVzcG9uc2UgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHZhciBjYWxsYmFja3MgPSB0aGlzLl9nZXRDYWxsYmFja3NGb3JSZXF1ZXN0KGRhdGEucmVxdWVzdElkKTsKICAgICAgaWYgKGNhbGxiYWNrcyA9PSBudWxsKSB7CiAgICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGRhdGEuZXJyICYmIGNhbGxiYWNrcy5mYWlsdXJlKSB7CiAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGRhdGEuZXJyLCBkYXRhLmRhdGEpOwoKICAgICAgfSBlbHNlIGlmIChjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhLmRhdGEpOwogICAgICB9CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0Q2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdENsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5BUElfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAgKi8KICAgdmFyIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uKGNvbmR1aXQpIHsKICAgICAgVXBzdHJlYW1Db25kdWl0Q2xpZW50QmFzZS5jYWxsKHRoaXMsIGNvbmR1aXQsIGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVFVRVNULCBjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UpOwogICB9OwogICBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShVcHN0cmVhbUNvbmR1aXRDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBVcHN0cmVhbUNvbmR1aXRNYXN0ZXJDbGllbnQ7CiAgIAogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBBZ2VudEFwcENsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgKi8KICAgdmFyIEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24oYXV0aENvb2tpZU5hbWUsIGF1dGhUb2tlbiwgZW5kcG9pbnQpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGF1dGhDb29raWVOYW1lLCAnYXV0aENvb2tpZU5hbWUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGF1dGhUb2tlbiwgJ2F1dGhUb2tlbicpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZW5kcG9pbnQsICdlbmRwb2ludCcpOwogICAgICBDbGllbnRCYXNlLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuZW5kcG9pbnRVcmwgPSBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbChlbmRwb2ludCk7CiAgICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuOwogICAgICB0aGlzLmF1dGhDb29raWVOYW1lID0gYXV0aENvb2tpZU5hbWUKICAgfTsKCiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBBZ2VudEFwcENsaWVudC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBBZ2VudEFwcENsaWVudDsKCiAgIEFnZW50QXBwQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIGJlYXIgPSB7fTsKICAgICAgYmVhcltzZWxmLmF1dGhDb29raWVOYW1lXSA9IHNlbGYuYXV0aFRva2VuOwogICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgbWV0aG9kOiAncG9zdCcsCiAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHBhcmFtcyB8fCB7fSksCiAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgJ1gtQW16LXRhcmdldCc6IG1ldGhvZCwKICAgICAgICAgICAgICAgJ1gtQW16LUJlYXJlcic6IEpTT04uc3RyaW5naWZ5KGJlYXIpCiAgICAgICAgIH0KICAgICAgfTsKICAgICAgY29ubmVjdC5mZXRjaChzZWxmLmVuZHBvaW50VXJsLCBvcHRpb25zKS50aGVuKGZ1bmN0aW9uKHJlcyl7CiAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKHJlcyk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycil7CiAgICAgICAgIGNvbnN0IHJlYWRlciA9IGVyci5ib2R5LmdldFJlYWRlcigpOwogICAgICAgICBsZXQgYm9keSA9ICcnOwogICAgICAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7CiAgICAgICAgIHJlYWRlci5yZWFkKCkudGhlbihmdW5jdGlvbiBwcm9jZXNzVGV4dCh7IGRvbmUsIHZhbHVlIH0pIHsKICAgICAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgICAgICAgdmFyIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTsKICAgICAgICAgICAgICAgZXJyb3Iuc3RhdHVzID0gZXJyLnN0YXR1czsKICAgICAgICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoZXJyb3IpOwogICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYm9keSArPSBkZWNvZGVyLmRlY29kZSh2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiByZWFkZXIucmVhZCgpLnRoZW4ocHJvY2Vzc1RleHQpOwogICAgICAgICB9KTsKICAgICAgfSkKICAgfTsKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIEFXU0NsaWVudCBleHRlbmRzIENsaWVudEJhc2UKICAgICovCiAgIHZhciBBV1NDbGllbnQgPSBmdW5jdGlvbihhdXRoVG9rZW4sIHJlZ2lvbiwgZW5kcG9pbnRJbikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXV0aFRva2VuLCAnYXV0aFRva2VuJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWdpb24sICdyZWdpb24nKTsKICAgICAgQ2xpZW50QmFzZS5jYWxsKHRoaXMpOwogICAgICBBV1MuY29uZmlnLmNyZWRlbnRpYWxzID0gbmV3IEFXUy5DcmVkZW50aWFscyh7fSk7CiAgICAgIEFXUy5jb25maWcucmVnaW9uID0gcmVnaW9uOwogICAgICB0aGlzLmF1dGhUb2tlbiA9IGF1dGhUb2tlbjsKICAgICAgdmFyIGJhc2VVcmwgPSBjb25uZWN0LmdldEJhc2VVcmwoKTsKICAgICAgdmFyIGVuZHBvaW50VXJsID0gZW5kcG9pbnRJbiB8fCAoIAogICAgICAgICBiYXNlVXJsLmluY2x1ZGVzKCIuYXdzYXBwcy5jb20iKQogICAgICAgICAgICA/IGJhc2VVcmwgKyAnL2Nvbm5lY3QvYXBpJwogICAgICAgICAgICA6IGJhc2VVcmwgKyAnL2FwaScKICAgICAgKTsKICAgICAgdmFyIGVuZHBvaW50ID0gbmV3IEFXUy5FbmRwb2ludChlbmRwb2ludFVybCk7CiAgICAgIHRoaXMuY2xpZW50ID0gbmV3IEFXUy5Db25uZWN0KHtlbmRwb2ludDogZW5kcG9pbnR9KTsKICAgfTsKICAgQVdTQ2xpZW50LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ2xpZW50QmFzZS5wcm90b3R5cGUpOwogICBBV1NDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQVdTQ2xpZW50OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fY2FsbEltcGwgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CgogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwoKICAgICAgaWYgKCEgY29ubmVjdC5jb250YWlucyh0aGlzLmNsaWVudCwgbWV0aG9kKSkgewogICAgICAgICB2YXIgbWVzc2FnZSA9IGNvbm5lY3Quc3ByaW50ZignTm8gc3VjaCBtZXRob2QgZXhpc3RzIG9uIEFXUyBjbGllbnQ6ICVzJywgbWV0aG9kKTsKICAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUobmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKSwge21lc3NhZ2U6IG1lc3NhZ2V9KTsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgIHBhcmFtcyA9IHRoaXMuX3RyYW5zbGF0ZVBhcmFtcyhtZXRob2QsIHBhcmFtcyk7CgogICAgICAgICBsb2cudHJhY2UoIkFXU0NsaWVudDogLS0+IENhbGxpbmcgb3BlcmF0aW9uICclcyciLCBtZXRob2QpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAgICB0aGlzLmNsaWVudFttZXRob2RdKHBhcmFtcykKICAgICAgICAgICAgLm9uKCdidWlsZCcsIGZ1bmN0aW9uKHJlcXVlc3QpIHsKICAgICAgICAgICAgICAgcmVxdWVzdC5odHRwUmVxdWVzdC5oZWFkZXJzWydYLUFtei1CZWFyZXInXSA9IHNlbGYuYXV0aFRva2VuOwogICAgICAgICAgICB9KQogICAgICAgICAgICAuc2VuZChmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICAgICAgICAgICBpZiAoZXJyLmNvZGUgPT09IGNvbm5lY3QuQ1RJRXhjZXB0aW9ucy5VTkFVVEhPUklaRURfRVhDRVBUSU9OKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5hdXRoRmFpbHVyZSgpOwogICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNhbGxiYWNrcy5hY2Nlc3NEZW5pZWQgJiYgKGVyci5jb2RlID09PSBjb25uZWN0LkNUSUV4Y2VwdGlvbnMuQUNDRVNTX0RFTklFRF9FWENFUFRJT04gfHwgZXJyLnN0YXR1c0NvZGUgPT09IDQwMykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCgpOwogICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBDYW4ndCBwYXNzIGVyciBkaXJlY3RseSB0byBwb3N0TWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAvLyBwb3N0TWVzc2FnZSgpIHRyaWVzIHRvIGNsb25lIHRoZSBlcnIgb2JqZWN0IGFuZCBmYWlsZWQuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlZmVyIHRvIGh0dHBzOi8vZ2l0aHViLmNvbS9nb2F0c2xhY2tlci9hbHQtZGV2dG9vbC9pc3N1ZXMvNQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXJyb3IgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IudHlwZSA9IGVyci5jb2RlOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5tZXNzYWdlID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIuc3RhY2spewogICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXJyLnN0YWNrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gZXJyLnN0YWNrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyLnN0YWNrID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gW0pTT04uc3RyaW5naWZ5KGVyci5zdGFjayldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZXJyLnN0YWNrID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLnN0YWNrID0gZXJyLnN0YWNrLnNwbGl0KCdcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHt9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IDwtLSBPcGVyYXRpb24gJyVzJyBmYWlsZWQ6ICVzIiwgbWV0aG9kLCBKU09OLnN0cmluZ2lmeShlcnIpKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgbG9nLnRyYWNlKCJBV1NDbGllbnQ6IDwtLSBPcGVyYXRpb24gJyVzJyBzdWNjZWVkZWQuIiwgbWV0aG9kKS53aXRoT2JqZWN0KGRhdGEpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKGRhdGEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGhhbmRsZSBBV1MgQVBJIHJlcXVlc3QgZm9yIG1ldGhvZCAlcyIsIG1ldGhvZCkKICAgICAgICAgICAgICAgICAgICAgICAgLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgfQogICB9OwoKICAgQVdTQ2xpZW50LnByb3RvdHlwZS5fcmVxdWlyZXNBdXRoZW50aWNhdGlvblBhcmFtID0gZnVuY3Rpb24gKG1ldGhvZCkgewogICAgICByZXR1cm4gbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuQ09NUExFVEVfQ09OVEFDVCAmJgogICAgICAgICBtZXRob2QgIT09IGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5DTEVBUl9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLlJFSkVDVF9DT05UQUNUICYmCiAgICAgICAgIG1ldGhvZCAhPT0gY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UQVNLX0NPTlRBQ1QgJiYKICAgICAgICAgbWV0aG9kICE9PSBjb25uZWN0LkNsaWVudE1ldGhvZHMuVVBEQVRFX01PTklUT1JfUEFSVElDSVBBTlRfU1RBVEU7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVQYXJhbXMgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcykgewogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICAgICBjYXNlIGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5VUERBVEVfQUdFTlRfQ09ORklHVVJBVElPTjoKICAgICAgICAgICAgcGFyYW1zLmNvbmZpZ3VyYXRpb24gPSB0aGlzLl90cmFuc2xhdGVBZ2VudENvbmZpZ3VyYXRpb24ocGFyYW1zLmNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGNhc2UgY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfU09GVFBIT05FX0NBTExfTUVUUklDUzoKICAgICAgICAgICAgcGFyYW1zLnNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKAogICAgICAgICAgICAgICAgICBwYXJhbXMuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgY2FzZSBjb25uZWN0LkNsaWVudE1ldGhvZHMuU0VORF9TT0ZUUEhPTkVfQ0FMTF9SRVBPUlQ6CiAgICAgICAgICAgIHBhcmFtcy5yZXBvcnQgPSB0aGlzLl90cmFuc2xhdGVTb2Z0cGhvbmVDYWxsUmVwb3J0KHBhcmFtcy5yZXBvcnQpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBpZiAodGhpcy5fcmVxdWlyZXNBdXRoZW50aWNhdGlvblBhcmFtKG1ldGhvZCkpIHsKICAgICAgICAgcGFyYW1zLmF1dGhlbnRpY2F0aW9uID0gewogICAgICAgICAgICBhdXRoVG9rZW46IHRoaXMuYXV0aFRva2VuCiAgICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBwYXJhbXM7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbihjb25maWcpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgbmFtZTogY29uZmlnLm5hbWUsCiAgICAgICAgIHNvZnRwaG9uZUVuYWJsZWQ6IGNvbmZpZy5zb2Z0cGhvbmVFbmFibGVkLAogICAgICAgICBzb2Z0cGhvbmVBdXRvQWNjZXB0OiBjb25maWcuc29mdHBob25lQXV0b0FjY2VwdCwKICAgICAgICAgZXh0ZW5zaW9uOiBjb25maWcuZXh0ZW5zaW9uLAogICAgICAgICByb3V0aW5nUHJvZmlsZTogdGhpcy5fdHJhbnNsYXRlUm91dGluZ1Byb2ZpbGUoY29uZmlnLnJvdXRpbmdQcm9maWxlKSwKICAgICAgICAgYWdlbnRQcmVmZXJlbmNlczogY29uZmlnLmFnZW50UHJlZmVyZW5jZXMKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVJvdXRpbmdQcm9maWxlID0gZnVuY3Rpb24ocHJvZmlsZSkgewogICAgICByZXR1cm4gewogICAgICAgICBuYW1lOiBwcm9maWxlLm5hbWUsCiAgICAgICAgIHJvdXRpbmdQcm9maWxlQVJOOiBwcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOLAogICAgICAgICBkZWZhdWx0T3V0Ym91bmRRdWV1ZTogdGhpcy5fdHJhbnNsYXRlUXVldWUocHJvZmlsZS5kZWZhdWx0T3V0Ym91bmRRdWV1ZSkKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVF1ZXVlID0gZnVuY3Rpb24ocXVldWUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAgcXVldWVBUk46ICAgcXVldWUucXVldWVBUk4sCiAgICAgICAgIG5hbWU6ICAgICAgIHF1ZXVlLm5hbWUKICAgICAgfTsKICAgfTsKCiAgIEFXU0NsaWVudC5wcm90b3R5cGUuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MgPSBmdW5jdGlvbihzdGF0cykgewogICAgICBzdGF0cy5mb3JFYWNoKGZ1bmN0aW9uKHN0YXQpIHsKICAgICAgICAgaWYgKCdwYWNrZXRzQ291bnQnIGluIHN0YXQpIHsKICAgICAgICAgICAgc3RhdC5wYWNrZXRDb3VudCA9IHN0YXQucGFja2V0c0NvdW50OwogICAgICAgICAgICBkZWxldGUgc3RhdC5wYWNrZXRzQ291bnQ7CiAgICAgICAgIH0KICAgICAgfSk7CgogICAgICByZXR1cm4gc3RhdHM7CiAgIH07CgogICBBV1NDbGllbnQucHJvdG90eXBlLl90cmFuc2xhdGVTb2Z0cGhvbmVDYWxsUmVwb3J0ID0gZnVuY3Rpb24ocmVwb3J0KSB7CiAgICAgIGlmICgnaGFuZHNoYWtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LmhhbmRzaGFrZVRpbWVNaWxsaXMgPSByZXBvcnQuaGFuZHNoYWtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LmhhbmRzaGFraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgaWYgKCdwcmVUYWxraW5nVGltZU1pbGxpcycgaW4gcmVwb3J0KSB7CiAgICAgICAgIHJlcG9ydC5wcmVUYWxrVGltZU1pbGxpcyA9IHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpczsKICAgICAgICAgZGVsZXRlIHJlcG9ydC5wcmVUYWxraW5nVGltZU1pbGxpczsKICAgICAgfQoKICAgICAgaWYgKCdoYW5kc2hha2luZ0ZhaWx1cmUnIGluIHJlcG9ydCkgewogICAgICAgICByZXBvcnQuaGFuZHNoYWtlRmFpbHVyZSA9IHJlcG9ydC5oYW5kc2hha2luZ0ZhaWx1cmU7CiAgICAgICAgIGRlbGV0ZSByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlOwogICAgICB9CgogICAgICBpZiAoJ3RhbGtpbmdUaW1lTWlsbGlzJyBpbiByZXBvcnQpIHsKICAgICAgICAgcmVwb3J0LnRhbGtUaW1lTWlsbGlzID0gcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzOwogICAgICAgICBkZWxldGUgcmVwb3J0LnRhbGtpbmdUaW1lTWlsbGlzOwogICAgICB9CgogICAgICByZXBvcnQuc29mdHBob25lU3RyZWFtU3RhdGlzdGljcyA9IHRoaXMuX3RyYW5zbGF0ZVNvZnRwaG9uZVN0cmVhbVN0YXRpc3RpY3MoCiAgICAgICAgICAgIHJlcG9ydC5zb2Z0cGhvbmVTdHJlYW1TdGF0aXN0aWNzKTsKCiAgICAgIHJldHVybiByZXBvcnQ7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBUYXNrVGVtcGxhdGVzQ2xpZW50IGV4dGVuZHMgQ2xpZW50QmFzZQogICAqLwogICB2YXIgVGFza1RlbXBsYXRlc0NsaWVudCA9IGZ1bmN0aW9uKGVuZHBvaW50KSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ2VuZHBvaW50Jyk7CiAgICAgIENsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgICAgaWYgKGVuZHBvaW50LmluY2x1ZGVzKCcvdGFzay10ZW1wbGF0ZXMnKSkgewogICAgICAgICB0aGlzLmVuZHBvaW50VXJsID0gY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2woZW5kcG9pbnQpOwogICAgICB9IGVsc2UgewogICAgICAgICB2YXIgQVdTRW5kcG9pbnQgPSBuZXcgQVdTLkVuZHBvaW50KGVuZHBvaW50KTsKICAgICAgICAgdmFyIENGUHJlZml4ID0gZW5kcG9pbnQuaW5jbHVkZXMoJy5hd3NhcHBzLmNvbScpID8gJy9jb25uZWN0JyA6ICcnOwogICAgICAgICB0aGlzLmVuZHBvaW50VXJsID0gY29ubmVjdC5nZXRVcmxXaXRoUHJvdG9jb2woYCR7QVdTRW5kcG9pbnQuaG9zdH0ke0NGUHJlZml4fS90YXNrLXRlbXBsYXRlcy9hcGkvY2NwYCk7CiAgICAgIH0KICAgfTsKCiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShDbGllbnRCYXNlLnByb3RvdHlwZSk7CiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gVGFza1RlbXBsYXRlc0NsaWVudDsKCiAgIFRhc2tUZW1wbGF0ZXNDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uKG1ldGhvZCwgcGFyYW1zLCBjYWxsYmFja3MpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKG1ldGhvZCwgJ21ldGhvZCcpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLAogICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsCiAgICAgICAgICAgICd4LWNzcmYtdG9rZW4nOiAnY3NyZicgICAgICAgICAKICAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgaW5zdGFuY2VJZCA9IHBhcmFtcy5pbnN0YW5jZUlkOwogICAgICB2YXIgdXJsID0gdGhpcy5lbmRwb2ludFVybDsKICAgICAgdmFyIG1ldGhvZHMgPSBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnRNZXRob2RzOwogICAgICBzd2l0Y2ggKG1ldGhvZCkgewogICAgICAgICBjYXNlIG1ldGhvZHMuTElTVF9UQVNLX1RFTVBMQVRFUzogCiAgICAgICAgICAgIHVybCArPSBgL3Byb3h5L2luc3RhbmNlLyR7aW5zdGFuY2VJZH0vdGFzay90ZW1wbGF0ZWA7CiAgICAgICAgICAgIGlmIChwYXJhbXMucXVlcnlQYXJhbXMpIHsKICAgICAgICAgICAgICAgY29uc3QgcXVlcnlTdHJpbmcgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHBhcmFtcy5xdWVyeVBhcmFtcykudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgaWYgKHF1ZXJ5U3RyaW5nKSB7CiAgICAgICAgICAgICAgICAgIHVybCArPSBgPyR7cXVlcnlTdHJpbmd9YDsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuR0VUX1RBU0tfVEVNUExBVEU6IAogICAgICAgICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnRlbXBsYXRlUGFyYW1zLCAncGFyYW1zLnRlbXBsYXRlUGFyYW1zJyk7CiAgICAgICAgICAgIGNvbnN0IGlkID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy50ZW1wbGF0ZVBhcmFtcy5pZCwgJ3BhcmFtcy50ZW1wbGF0ZVBhcmFtcy5pZCcpOwogICAgICAgICAgICBjb25zdCB2ZXJzaW9uID0gcGFyYW1zLnRlbXBsYXRlUGFyYW1zLnZlcnNpb247CiAgICAgICAgICAgIHVybCArPSBgL3Byb3h5L2luc3RhbmNlLyR7aW5zdGFuY2VJZH0vdGFzay90ZW1wbGF0ZS8ke2lkfWA7CiAgICAgICAgICAgIGlmICh2ZXJzaW9uKSB7CiAgICAgICAgICAgICAgIHVybCArPSBgP3NuYXBzaG90VmVyc2lvbj0ke3ZlcnNpb259YDsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgY2FzZSBtZXRob2RzLkNSRUFURV9URU1QTEFURURfVEFTSzogCiAgICAgICAgICAgIHVybCArPSBgLyR7bWV0aG9kfWA7CiAgICAgICAgICAgIG9wdGlvbnMuYm9keSA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7CiAgICAgICAgICAgIG9wdGlvbnMubWV0aG9kID0gJ1BVVCc7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIG1ldGhvZHMuVVBEQVRFX0NPTlRBQ1Q6IAogICAgICAgICAgICB1cmwgKz0gYC8ke21ldGhvZH1gOwogICAgICAgICAgICBvcHRpb25zLmJvZHkgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpOwogICAgICAgICAgICBvcHRpb25zLm1ldGhvZCA9ICdQT1NUJzsKICAgICAgfQogICAgICBjb25uZWN0LmZldGNoKHVybCwgb3B0aW9ucykKICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzKXsKICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MocmVzKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKXsKICAgICAgICAgY29uc3QgcmVhZGVyID0gZXJyLmJvZHkuZ2V0UmVhZGVyKCk7CiAgICAgICAgIGxldCBib2R5ID0gJyc7CiAgICAgICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgICAgICAgcmVhZGVyLnJlYWQoKS50aGVuKGZ1bmN0aW9uIHByb2Nlc3NUZXh0KHsgZG9uZSwgdmFsdWUgfSkgewogICAgICAgICAgICBpZiAoZG9uZSkgewogICAgICAgICAgICAgICB2YXIgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgICAgICBlcnJvci5zdGF0dXMgPSBlcnIuc3RhdHVzOwogICAgICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBib2R5ICs9IGRlY29kZXIuZGVjb2RlKHZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHJlYWRlci5yZWFkKCkudGhlbihwcm9jZXNzVGV4dCk7CiAgICAgICAgIH0pOwogICAgICB9KQogICB9OwoKICAgY29ubmVjdC5DbGllbnRCYXNlID0gQ2xpZW50QmFzZTsKICAgY29ubmVjdC5OdWxsQ2xpZW50ID0gTnVsbENsaWVudDsKICAgY29ubmVjdC5VcHN0cmVhbUNvbmR1aXRDbGllbnQgPSBVcHN0cmVhbUNvbmR1aXRDbGllbnQ7CiAgIGNvbm5lY3QuVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50ID0gVXBzdHJlYW1Db25kdWl0TWFzdGVyQ2xpZW50OwogICBjb25uZWN0LkFXU0NsaWVudCA9IEFXU0NsaWVudDsKICAgY29ubmVjdC5BZ2VudEFwcENsaWVudCA9IEFnZW50QXBwQ2xpZW50OwogICBjb25uZWN0LlRhc2tUZW1wbGF0ZXNDbGllbnQgPSBUYXNrVGVtcGxhdGVzQ2xpZW50Owp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gODk1OgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgY29ubmVjdC5jb3JlID0ge307CiAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgY29ubmVjdC52ZXJzaW9uID0gIjEuNy40IjsKICBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRSA9IDUwMDsKIAogIHZhciBDQ1BfU1lOX1RJTUVPVVQgPSAxMDAwOyAvLyAxIHNlYwogIHZhciBDQ1BfQUNLX1RJTUVPVVQgPSAzMDAwOyAvLyAzIHNlYwogIHZhciBDQ1BfTE9BRF9USU1FT1VUID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gNTAwMDsgLy8gNSBzZWMKICB2YXIgQ0NQX0RSX0lGUkFNRV9SRUZSRVNIX0lOVEVSVkFMID0gMTAwMDA7IC8vMTAgcwogIHZhciBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQgPSA2OyAvLyA2IGF0dGVtcHRzCiAgdmFyIENDUF9JRlJBTUVfTkFNRSA9ICdBbWF6b24gQ29ubmVjdCBDQ1AnOwogCiAgdmFyIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTiA9ICJodHRwczovL3thbGlhc30uYXdzYXBwcy5jb20vYXV0aC8/Y2xpZW50X2lkPXtjbGllbnRfaWR9JnJlZGlyZWN0X3VyaT17cmVkaXJlY3R9IjsKICB2YXIgQ0xJRU5UX0lEX01BUCA9IHsKICAgICJ1cy1lYXN0LTEiOiAiMDY5MTlmNGZkOGVkMzI0ZSIKICB9OwogCiAgdmFyIEFVVEhPUklaRV9FTkRQT0lOVCA9ICIvYXV0aC9hdXRob3JpemUiOwogIHZhciBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UID0gIi9jb25uZWN0L2F1dGgvYXV0aG9yaXplIjsKICB2YXIgQVVUSE9SSVpFX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgQVVUSE9SSVpFX01BWF9SRVRSWSA9IDU7CiAKICB2YXIgTEVHQUNZX1dISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL2Nvbm5lY3Qvd2hpdGVsaXN0ZWQtb3JpZ2lucyI7CiAgdmFyIFdISVRFTElTVEVEX09SSUdJTlNfRU5EUE9JTlQgPSAiL3doaXRlbGlzdGVkLW9yaWdpbnMiOwogIHZhciBXSElURUxJU1RFRF9PUklHSU5TX1JFVFJZX0lOVEVSVkFMID0gMjAwMDsKICB2YXIgV0hJVEVMSVNURURfT1JJR0lOU19NQVhfUkVUUlkgPSA1OwoKICB2YXIgQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTID0gJ0lmcmFtZVJlZnJlc2hBdHRlbXB0cyc7CiAgdmFyIENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUyA9ICdJZnJhbWVJbml0aWFsaXphdGlvblN1Y2Nlc3MnOwogIHZhciBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1RJTUUgPSAnSWZyYW1lSW5pdGlhbGl6YXRpb25UaW1lJzsKCiAgdmFyIENPTk5FQ1RFRF9DQ1BTX1NJTkdMRV9UQUIgPSAnQ29ubmVjdGVkQ0NQU2luZ2xlVGFiQ291bnQnOwogIHZhciBDQ1BfVEFCU19BQ1JPU1NfQlJPV1NFUl9DT1VOVCA9ICdDQ1BUYWJzQWNyb3NzQnJvd3NlckNvdW50JzsKCiAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSAwOwogIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiID0gMDsKCiAgY29ubmVjdC5jb3JlLk1BWF9BVVRIT1JJWkVfUkVUUllfQ09VTlRfRk9SX1NFU1NJT04gPSAzOwogIGNvbm5lY3QuY29yZS5NQVhfQ1RJX0FVVEhfUkVUUllfQ09VTlQgPSAxMDsKICBjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgPSAwOwogIGNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQgPSBudWxsOwogIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBudWxsOwoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIFNlc3Npb25TdG9yYWdlS2V5cwogICAqLwogIGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAndGFiX2lkJywKICAgICdhdXRob3JpemVfcmV0cnlfY291bnQnLAogIF0pOwoKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFRoaXMgZnVuY3Rpb24gd2FzIG9ubHkgbWVhbnQgZm9yIGludGVybmFsIHVzZS4gCiAgICogVGhlIG5hbWUgaXMgbWlzbGVhZGluZyBmb3Igd2hhdCBpdCBzaG91bGQgZG8uCiAgICogSW50ZXJuYWxseSB3ZSBoYXZlIHJlcGxhY2VkIGl0cyB1c2FnZSB3aXRoIGBnZXRMb2dpblVybGAuCiAgICovCiAgdmFyIGNyZWF0ZUxvZ2luVXJsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIHJlZGlyZWN0ID0gImh0dHBzOi8vbGlseS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS90YXcvYXV0aC9jb2RlIjsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyZWRpcmVjdCk7CiAKICAgIGlmIChwYXJhbXMubG9naW5VcmwpIHsKICAgICAgcmV0dXJuIHBhcmFtcy5sb2dpblVybAogICAgfSBlbHNlIGlmIChwYXJhbXMuYWxpYXMpIHsKICAgICAgbG9nLndhcm4oIlRoZSBgYWxpYXNgIHBhcmFtIGlzIGRlcHJlY2F0ZWQgYW5kIHNob3VsZCBub3QgYmUgZXhwZWN0ZWQgdG8gZnVuY3Rpb24gcHJvcGVybHkuIFBsZWFzZSB1c2UgYGNjcFVybGAgb3IgYGxvZ2luVXJsYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hbWF6b24tY29ubmVjdC9hbWF6b24tY29ubmVjdC1zdHJlYW1zL2Jsb2IvbWFzdGVyL1JFQURNRS5tZCNjb25uZWN0Y29yZWluaXRjY3AgZm9yIHZhbGlkIHBhcmFtZXRlcnMuIik7CiAgICAgIHJldHVybiBMRUdBQ1lfTE9HSU5fVVJMX1BBVFRFUk4KICAgICAgICAucmVwbGFjZSgie2FsaWFzfSIsIHBhcmFtcy5hbGlhcykKICAgICAgICAucmVwbGFjZSgie2NsaWVudF9pZH0iLCBDTElFTlRfSURfTUFQWyJ1cy1lYXN0LTEiXSkKICAgICAgICAucmVwbGFjZSgie3JlZGlyZWN0fSIsIGdsb2JhbC5lbmNvZGVVUklDb21wb25lbnQoCiAgICAgICAgICByZWRpcmVjdCkpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHBhcmFtcy5jY3BVcmw7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmVwbGFjZXMgYGNyZWF0ZUxvZ2luVXJsYCwgYXMgdGhhdCBmdW5jdGlvbidzIG5hbWUgd2FzIG1pc2xlYWRpbmcuCiAgICogVGhlIGBwYXJhbXMuYWxpYXNgIHBhcmFtZXRlciBpcyBkZXByZWNhdGVkLiBQbGVhc2UgcmVmcmFpbiBmcm9tIHVzaW5nIGl0LgogICAqLwogIHZhciBnZXRMb2dpblVybCA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIHZhciByZWRpcmVjdCA9ICJodHRwczovL2xpbHkudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vdGF3L2F1dGgvY29kZSI7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmVkaXJlY3QpOwogICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICByZXR1cm4gcGFyYW1zLmxvZ2luVXJsCiAgICB9IGVsc2UgaWYgKHBhcmFtcy5hbGlhcykgewogICAgICBsb2cud2FybigiVGhlIGBhbGlhc2AgcGFyYW0gaXMgZGVwcmVjYXRlZCBhbmQgc2hvdWxkIG5vdCBiZSBleHBlY3RlZCB0byBmdW5jdGlvbiBwcm9wZXJseS4gUGxlYXNlIHVzZSBgY2NwVXJsYCBvciBgbG9naW5VcmxgLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FtYXpvbi1jb25uZWN0L2FtYXpvbi1jb25uZWN0LXN0cmVhbXMvYmxvYi9tYXN0ZXIvUkVBRE1FLm1kI2Nvbm5lY3Rjb3JlaW5pdGNjcCBmb3IgdmFsaWQgcGFyYW1ldGVycy4iKTsKICAgICAgcmV0dXJuIExFR0FDWV9MT0dJTl9VUkxfUEFUVEVSTgogICAgICAgIC5yZXBsYWNlKCJ7YWxpYXN9IiwgcGFyYW1zLmFsaWFzKQogICAgICAgIC5yZXBsYWNlKCJ7Y2xpZW50X2lkfSIsIENMSUVOVF9JRF9NQVBbInVzLWVhc3QtMSJdKQogICAgICAgIC5yZXBsYWNlKCJ7cmVkaXJlY3R9IiwgZ2xvYmFsLmVuY29kZVVSSUNvbXBvbmVudCgKICAgICAgICAgIHJlZGlyZWN0KSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gcGFyYW1zLmNjcFVybDsKICAgIH0KICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogUmV0dXJucyBzY2hlbWU6Ly9ob3N0OnBvcnQgZm9yIGEgZ2l2ZW4gdXJsCiAgKi8KICBmdW5jdGlvbiBzYW5pdGl6ZURvbWFpbih1cmwpIHsKICAgIHZhciBkb21haW4gPSB1cmwubWF0Y2goL14oPzpodHRwcz86XC9cLyk/KD86W15AXG5dK0ApPyg/Ond3d1wuKT8oW146XC9cbj9dKykvaWcpOwogICAgcmV0dXJuIGRvbWFpbi5sZW5ndGggPyBkb21haW5bMF0gOiAiIjsKICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIFByaW50IGEgd2FybmluZyBtZXNzYWdlIGlmIHRoZSBDb25uZWN0IGNvcmUgaXMgbm90IGluaXRpYWxpemVkLgogICAgKi8KICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmIChjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQpIHsKICAgICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICAgIGxvZy53YXJuKCJDb25uZWN0IGNvcmUgYWxyZWFkeSBpbml0aWFsaXplZCwgb25seSBuZWVkcyB0byBiZSBpbml0aWFsaXplZCBvbmNlLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICogRElTQVNURVIgUkVDT1ZFUlkgCiAgKi8KICAKICAgdmFyIG1ha2VBZ2VudE9mZmxpbmUgPSBmdW5jdGlvbihhZ2VudCwgY2FsbGJhY2tzKSB7CiAgICB2YXIgb2ZmbGluZVN0YXRlID0gYWdlbnQuZ2V0QWdlbnRTdGF0ZXMoKS5maW5kKGZ1bmN0aW9uIChzdGF0ZSkgewogICAgICByZXR1cm4gc3RhdGUudHlwZSA9PT0gY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5PRkZMSU5FOwogICAgfSk7CiAgICBhZ2VudC5zZXRTdGF0ZShvZmZsaW5lU3RhdGUsIGNhbGxiYWNrcyk7ICAgCiAgfQogCiAgLy8gU3VwcHJlc3MgQ29udGFjdHMgZnVuY3Rpb24gCiAgLy8gVGhpcyBpcyB1c2VkIGJ5IERpc2FzdGVyIFJlY292ZXJ5IGFzIGEgc2FmZWd1YXJkIHRvIG5vdCBzdXJmYWNlIGluY29taW5nIGNhbGxzL2NoYXRzIHRvIFVJCiAgLy8gCiAgdmFyIHN1cHByZXNzQ29udGFjdHMgPSBmdW5jdGlvbiAoaXNTdXBwcmVzc2VkKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltEaXNhc3RlciBSZWNvdmVyeV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgY29udGFjdHMgc3VwcHJlc3NvciB0byAlcyBmb3IgaW5zdGFuY2UgJXMuIiwgCiAgICAgIGlzU3VwcHJlc3NlZCwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TVVBQUkVTUywgewogICAgICBzdXBwcmVzczogaXNTdXBwcmVzc2VkCiAgICB9KTsKICB9CiAKICB2YXIgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0gPSBmdW5jdGlvbihvZmZsaW5lKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltESVNBU1RFUiBSRUNPVkVSWV0gU2lnbmFsIHNoYXJlZHdvcmtlciB0byBzZXQgZm9yY2VPZmZsaW5lIHRvICVzIGZvciBpbnN0YW5jZSAlcy4iLCAKICAgICAgb2ZmbGluZSwgY29ubmVjdC5jb3JlLnJlZ2lvbgogICAgKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCB7CiAgICAgIG9mZmxpbmU6IG9mZmxpbmUKICAgIH0pOwogIH0KIAogIC8vIEZvcmNlIHRoZSBpbnN0YW5jZSB0byBiZSBvZmZsaW5lLiAKICAvLyBUaGlzIHRyaWVzIHRvIGRpc2Nvbm5lY3QgYWxsIGNvbnRhY3RzIChIYXJkIHN0b3ApCiAgLy8gaWYgZHVlIHRvIGEgZmFpbHVyZSAodGhlIGJhY2tlbmQgaXMgbm90IHJlYWNoYWJsZSksIHNpZ25hbCB0aGUgc2hhcmVkIHdvcmtlciB0byBmb3JjZV9vZmZsaW5lIHdoZW4gaXQgd2FrZXMgdXAgYWdhaW4KICAvLyBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIHJhbiBmcm9tIG5hdGl2ZSBDQ1AgZm9yIGRpc2Nvbm5lY3RpbmcgY2hhdHMuCiAgdmFyIGZvcmNlT2ZmbGluZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxvZyA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBBdHRlbXB0aW5nIHRvIGZvcmNlIGluc3RhbmNlICVzIG9mZmxpbmUiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbihhZ2VudCkgewogICAgICB2YXIgY29udGFjdENsb3NlZCA9IDA7CiAgICAgIHZhciBjb250YWN0cyA9IGFnZW50LmdldENvbnRhY3RzKCk7CiAgICAgIGlmIChjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICBjb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnRhY3QpIAogICAgICAgICAgewogICAgICAgICAgICBjb250YWN0LmdldEFnZW50Q29ubmVjdGlvbigpLmRlc3Ryb3koewogICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgYWxsIGFjdGl2ZSBjb250YWN0cyBhcmUgY2xvc2VkCiAgICAgICAgICAgICAgICBpZiAoKytjb250YWN0Q2xvc2VkID09PSBjb250YWN0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgICAgICAgICAgICAvLyBJdCdzIG9rIGlmIHdlJ3JlIG5vdCBhYmxlIHRvIHB1dCB0aGUgYWdlbnQgb2ZmbGluZS4gCiAgICAgICAgICAgICAgICAgIC8vIHNpbmNlIHdlJ3JlIHN1cHByZXNzaW5nIHRoZSBhZ2VudHMgY29udGFjdHMgYWxyZWFkeS4gCiAgICAgICAgICAgICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgICAgICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbnN0YW5jZSAlcyBpcyBub3cgb2ZmbGluZSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbihlcnIpIHsKICAgICAgICAgICAgICAgIGxvZy53YXJuKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEFuIGVycm9yIG9jY3VyZWQgd2hpbGUgYXR0ZW1wdGluZyB0byBmb3JjZSB0aGlzIGluc3RhbmNlIHRvIG9mZmxpbmUgaW4gcmVnaW9uICVzIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIGxvZy53YXJuKGVycikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIC8vIHNpZ25hbCB0aGUgc2hhcmVkd29ya2VyIHRvIGNhbGwgZm9yY2VPZmZsaW5lIGFnYWluIHdoZW4gbmV0d29yayBjb25uZWN0aW9uIAogICAgICAgICAgICAgICAgLy8gaGFzIGJlZW4gcmUtZXN0YWJsaXNoZWQgKHRoaXMgaGFwcGVucyBpbiBjYXNlIG9mIG5ldHdvcmsgb3IgYmFja2VuZCBmYWlsdXJlcykKICAgICAgICAgICAgICAgIHNldEZvcmNlT2ZmbGluZVVwc3RyZWFtKHRydWUpOwogICAgICAgICAgICB9fSk7CiAgICAgICAgICB9CiAgICAgICAgKSAgICAgICAgCiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0Rm9yY2VPZmZsaW5lVXBzdHJlYW0oZmFsc2UpOwogICAgICAgIG1ha2VBZ2VudE9mZmxpbmUoYWdlbnQpOwogICAgICAgIGxvZy5pbmZvKCJbRGlzYXN0ZXIgUmVjb3ZlcnldIEluc3RhbmNlICVzIGlzIG5vdyBvZmZsaW5lIiwgY29ubmVjdC5jb3JlLnJlZ2lvbikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfQogCiAgLy9Jbml0aWF0ZSBEaXNhc3RlciBSZWNvdmVyeSAoVGhpcyBzaG91bGQgb25seSBiZSBjYWxsZWQgZnJvbSBjdXN0b21DQ1AgdGhhdCBhcmUgRFIgZW5hYmxlZCkKICBjb25uZWN0LmNvcmUuaW5pdERpc2FzdGVyUmVjb3ZlcnkgPSBmdW5jdGlvbihwYXJhbXMpIHsKICAgIHZhciBsb2cgPSBjb25uZWN0LmdldExvZygpOwogICAgY29ubmVjdC5jb3JlLnJlZ2lvbiA9IHBhcmFtcy5yZWdpb247CiAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyA9IHN1cHByZXNzQ29udGFjdHM7ICAKICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUgPSBmb3JjZU9mZmxpbmU7CgogICAgLy9SZWdpc3RlciBpZnJhbWUgbGlzdG5lciB0byBzZXQgbmF0aXZlIENDUCBvZmZsaW5lCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNFVF9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CiAKICAgIC8vIFJlZ2lzdGVyIEV2ZW50IGxpc3RuZXIgdG8gRm9yY2UgdGhlIEFnZW50IHRvIGJlIG9mZmxpbmUgd2hlbiBzaGFyZWQgd29ya2VyIHJlY292ZXJzIGZyb20gbmV0d29yayBmYWlsdXJlCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5GT1JDRV9PRkZMSU5FLCBmdW5jdGlvbigpIHsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgfSk7CgogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBJbml0aWFsaXppbmcgcmVnaW9uICVzIGFzIHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0sIAogICAgICBmdW5jdGlvbigpIHsKICAgICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBhbHJlYWR5IHBhcnQgb2YgYSBEaXNhc3RlciBSZWNvdmVyeSBmbGVldCIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwoKICAgIGlmICghcGFyYW1zLmlzUHJpbWFyeSkgewogICAgICBjb25uZWN0LmNvcmUuc3VwcHJlc3NDb250YWN0cyh0cnVlKTsKICAgICAgY29ubmVjdC5jb3JlLmZvcmNlT2ZmbGluZSgpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gc3RhbmQtYnkiLCBjb25uZWN0LmNvcmUucmVnaW9uKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMoZmFsc2UpOwogICAgICBsb2cuaW5mbygiW0Rpc2FzdGVyIFJlY292ZXJ5XSAlcyBpbnN0YW5jZSBpcyBzZXQgdG8gcHJpbWFyeSIsIGNvbm5lY3QuY29yZS5yZWdpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEJhc2ljIENvbm5lY3QgY2xpZW50IGluaXRpYWxpemF0aW9uLgogICAqIFNob3VsZCBiZSB1c2VkIG9ubHkgYnkgdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5jb3JlLmV2ZW50QnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICBjb25uZWN0LmNvcmUuaW5pdENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRBZ2VudEFwcENsaWVudChwYXJhbXMpOwogICAgY29ubmVjdC5jb3JlLmluaXRUYXNrVGVtcGxhdGVzQ2xpZW50KHBhcmFtcyk7CiAgICBjb25uZWN0LmNvcmUuaW5pdGlhbGl6ZWQgPSB0cnVlOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgQVdTIGNsaWVudAogICAqIFNob3VsZCBiZSB1c2VkIGJ5IFNoYXJlZCBXb3JrZXIgdG8gdXBkYXRlIEFXUyBjbGllbnQgd2l0aCBuZXcgY3JlZGVudGlhbHMKICAgKiBhZnRlciByZWZyZXNoZWQgYXV0aGVudGljYXRpb24uCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICAKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogCiAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuQVdTQ2xpZW50KGF1dGhUb2tlbiwgcmVnaW9uLCBlbmRwb2ludCk7CiAgfTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVkIEFnZW50QXBwIGNsaWVudAogICAqIFNob3VsZCBiZSB1c2VkIGJ5IFNoYXJlZCBXb3JrZXIgdG8gdXBkYXRlIEFnZW50QXBwIGNsaWVudCB3aXRoIG5ldyBjcmVkZW50aWFscwogICAqIGFmdGVyIHJlZnJlc2hlZCBhdXRoZW50aWNhdGlvbi4KICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdEFnZW50QXBwQ2xpZW50ID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgJ3BhcmFtcycpOyAgICAKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciBhdXRoQ29va2llTmFtZSA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYXV0aENvb2tpZU5hbWUsICdwYXJhbXMuYXV0aENvb2tpZU5hbWUnKTsKICAgIHZhciBlbmRwb2ludCA9IGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuYWdlbnRBcHBFbmRwb2ludCwgJ3BhcmFtcy5hZ2VudEFwcEVuZHBvaW50Jyk7CiAgICAKICAgIGNvbm5lY3QuY29yZS5hZ2VudEFwcENsaWVudCA9IG5ldyBjb25uZWN0LkFnZW50QXBwQ2xpZW50KGF1dGhDb29raWVOYW1lLCBhdXRoVG9rZW4sIGVuZHBvaW50KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogSW5pdGlhbGl6ZWQgVGFza1RlbXBsYXRlcyBjbGllbnQKICAgKi8KICBjb25uZWN0LmNvcmUuaW5pdFRhc2tUZW1wbGF0ZXNDbGllbnQgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAgICB2YXIgZW5kcG9pbnQgPSBwYXJhbXMudGFza1RlbXBsYXRlc0VuZHBvaW50IHx8IHBhcmFtcy5lbmRwb2ludDsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChlbmRwb2ludCwgJ3Rhc2tUZW1wbGF0ZXNFbmRwb2ludCcpOwogICAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBuZXcgY29ubmVjdC5UYXNrVGVtcGxhdGVzQ2xpZW50KGVuZHBvaW50KTsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIFVuaW5pdGlhbGl6ZSBDb25uZWN0LgogICAqLwogIGNvbm5lY3QuY29yZS50ZXJtaW5hdGUgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBuZXcgY29ubmVjdC5OdWxsQ2xpZW50KCk7CiAgICBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50ID0gbmV3IGNvbm5lY3QuTnVsbENsaWVudCgpOwogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgaWYgKGJ1cykgYnVzLnVuc3Vic2NyaWJlQWxsKCk7CiAgICBjb25uZWN0LmNvcmUuYnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBudWxsOwogICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIgPSBudWxsOwogICAgY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCA9IGZhbHNlOwogICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gZmFsc2U7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBTZXR1cCB0aGUgU29mdHBob25lTWFuYWdlciB0byBiZSBpbml0aWFsaXplZCB3aGVuIHRoZSBhZ2VudAogICAqIGlzIGRldGVybWluZWQgdG8gaGF2ZSBzb2Z0cGhvbmUgZW5hYmxlZC4KICAgKi8KICBjb25uZWN0LmNvcmUuc29mdHBob25lVXNlck1lZGlhU3RyZWFtID0gbnVsbDsKIAogIGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbTsKICB9OwogCiAgY29ubmVjdC5jb3JlLnNldFNvZnRwaG9uZVVzZXJNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0gPSBzdHJlYW07CiAgfTsKIAogIGNvbm5lY3QuY29yZS5pbml0UmluZ3RvbmVFbmdpbmVzID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogCiAgICB2YXIgc2V0dXBSaW5ndG9uZUVuZ2luZXMgPSBmdW5jdGlvbiAocmluZ3RvbmVTZXR0aW5ncykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocmluZ3RvbmVTZXR0aW5ncywgInJpbmd0b25lU2V0dGluZ3MiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3Mudm9pY2UsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy52b2ljZS5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2ssICJyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrIik7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShyaW5ndG9uZVNldHRpbmdzLnF1ZXVlX2NhbGxiYWNrLnJpbmd0b25lVXJsIHx8IHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2suZGlzYWJsZWQsICJyaW5ndG9uZVNldHRpbmdzLnZvaWNlLnJpbmd0b25lVXJsIG11c3QgYmUgcHJvdmlkZWQgb3IgcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCBtdXN0IGJlIHRydWUiKTsKIAogICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzID0ge307CiAKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoYWdlbnQpIHsKICAgICAgICBhZ2VudC5vblJlZnJlc2goZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5SSU5HVE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3Mudm9pY2UuZGlzYWJsZWQgJiYgIWNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMudm9pY2UpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzLnZvaWNlID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUocmluZ3RvbmVTZXR0aW5ncy52b2ljZSk7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJWb2ljZVJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MuY2hhdC5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0KSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5jaGF0ID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LkNoYXRSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLmNoYXQpOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQ2hhdFJpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KIAogICAgICAgICAgICBpZiAoIXJpbmd0b25lU2V0dGluZ3MudGFzay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy50YXNrID0KICAgICAgICAgICAgICAgIG5ldyBjb25uZWN0LlRhc2tSaW5ndG9uZUVuZ2luZShyaW5ndG9uZVNldHRpbmdzLnRhc2spOwogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJUYXNrUmluZ3RvbmVFbmdpbmUgaW5pdGlhbGl6ZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogCiAgICAgICAgICAgIGlmICghcmluZ3RvbmVTZXR0aW5ncy5xdWV1ZV9jYWxsYmFjay5kaXNhYmxlZCAmJiAhY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcy5xdWV1ZV9jYWxsYmFjaykgewogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXMucXVldWVfY2FsbGJhY2sgPQogICAgICAgICAgICAgICAgbmV3IGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lKHJpbmd0b25lU2V0dGluZ3MucXVldWVfY2FsbGJhY2spOwogICAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lIGluaXRpYWxpemVkLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIGhhbmRsZVJpbmdlckRldmljZUNoYW5nZSgpOwogICAgfTsKIAogICAgdmFyIG1lcmdlUGFyYW1zID0gZnVuY3Rpb24gKHBhcmFtcywgb3RoZXJQYXJhbXMpIHsKICAgICAgLy8gRm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5OiBzdXBwb3J0IHB1bGxpbmcgZGlzYWJsZWQgZmxhZyBhbmQgcmluZ3RvbmVVcmwKICAgICAgLy8gZnJvbSBzb2Z0cGhvbmUgY29uZmlnIGlmIGl0IGV4aXN0cyBmcm9tIGRvd25zdHJlYW0gaW50byB0aGUgcmluZ3RvbmUgY29uZmlnLgogICAgICBwYXJhbXMucmluZ3RvbmUgPSBwYXJhbXMucmluZ3RvbmUgfHwge307CiAgICAgIHBhcmFtcy5yaW5ndG9uZS52b2ljZSA9IHBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrIHx8IHt9OwogICAgICBwYXJhbXMucmluZ3RvbmUuY2hhdCA9IHBhcmFtcy5yaW5ndG9uZS5jaGF0IHx8IHsgZGlzYWJsZWQ6IHRydWUgfTsKICAgICAgcGFyYW1zLnJpbmd0b25lLnRhc2sgPSBwYXJhbXMucmluZ3RvbmUudGFzayB8fCB7IGRpc2FibGVkOiB0cnVlIH07CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLnNvZnRwaG9uZSkgewogICAgICAgIGlmIChvdGhlclBhcmFtcy5zb2Z0cGhvbmUuZGlzYWJsZVJpbmd0b25lKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuc29mdHBob25lLnJpbmd0b25lVXJsKSB7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUudm9pY2UucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgICBwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2sucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5zb2Z0cGhvbmUucmluZ3RvbmVVcmw7CiAgICAgICAgfQogICAgICB9CiAKICAgICAgaWYgKG90aGVyUGFyYW1zLmNoYXQpIHsKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5kaXNhYmxlUmluZ3RvbmUpIHsKICAgICAgICAgIHBhcmFtcy5yaW5ndG9uZS5jaGF0LmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAKICAgICAgICBpZiAob3RoZXJQYXJhbXMuY2hhdC5yaW5ndG9uZVVybCkgewogICAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQucmluZ3RvbmVVcmwgPSBvdGhlclBhcmFtcy5jaGF0LnJpbmd0b25lVXJsOwogICAgICAgIH0KICAgICAgfQogCiAgICAgIC8vIE1lcmdlIGluIHJpbmd0b25lIHNldHRpbmdzIGZyb20gZG93bnN0cmVhbS4KICAgICAgaWYgKG90aGVyUGFyYW1zLnJpbmd0b25lKSB7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnZvaWNlID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUudm9pY2UsCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLnF1ZXVlX2NhbGxiYWNrID0gY29ubmVjdC5tZXJnZShwYXJhbXMucmluZ3RvbmUucXVldWVfY2FsbGJhY2ssCiAgICAgICAgICBvdGhlclBhcmFtcy5yaW5ndG9uZS52b2ljZSB8fCB7fSk7CiAgICAgICAgcGFyYW1zLnJpbmd0b25lLmNoYXQgPSBjb25uZWN0Lm1lcmdlKHBhcmFtcy5yaW5ndG9uZS5jaGF0LAogICAgICAgICAgb3RoZXJQYXJhbXMucmluZ3RvbmUuY2hhdCB8fCB7fSk7CiAgICAgIH0KICAgIH07CiAKICAgIC8vIE1lcmdlIHBhcmFtcyBmcm9tIHBhcmFtcy5zb2Z0cGhvbmUgYW5kIHBhcmFtcy5jaGF0IGludG8gcGFyYW1zLnJpbmd0b25lCiAgICAvLyBmb3IgZW1iZWRkZWQgYW5kIG5vbi1lbWJlZGRlZCB1c2UgY2FzZXMgc28gdGhhdCBkZWZhdWx0cyBhcmUgcGlja2VkIHVwLgogICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBwYXJhbXMpOwogCiAgICBpZiAoY29ubmVjdC5pc0ZyYW1lZCgpKSB7CiAgICAgIC8vIElmIHRoZSBDQ1AgaXMgaW4gYSBmcmFtZSwgd2FpdCBmb3IgY29uZmlndXJhdGlvbiBmcm9tIGRvd25zdHJlYW0uCiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICAgIC8vIE1lcmdlIGFsbCBwYXJhbXMgZnJvbSBkYXRhIGludG8gcGFyYW1zIGZvciBhbnkgb3ZlcnJpZGRlbgogICAgICAgIC8vIHZhbHVlcyBpbiBlaXRoZXIgbGVnYWN5ICJzb2Z0cGhvbmUiIG9yICJyaW5ndG9uZSIgc2V0dGluZ3MuCiAgICAgICAgbWVyZ2VQYXJhbXMocGFyYW1zLCBkYXRhKTsKICAgICAgICBzZXR1cFJpbmd0b25lRW5naW5lcyhwYXJhbXMucmluZ3RvbmUpOwogICAgICB9KTsKIAogICAgfSBlbHNlIHsKICAgICAgc2V0dXBSaW5ndG9uZUVuZ2luZXMocGFyYW1zLnJpbmd0b25lKTsKICAgIH0KICB9OwoKICB2YXIgaGFuZGxlUmluZ2VyRGV2aWNlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TRVRfUklOR0VSX0RFVklDRSwgc2V0UmluZ2VyRGV2aWNlKTsKICB9CgogIHZhciBzZXRSaW5nZXJEZXZpY2UgPSBmdW5jdGlvbiAoZGF0YSl7CiAgICBpZihjb25uZWN0LmtleXMoY29ubmVjdC5jb3JlLnJpbmd0b25lRW5naW5lcykubGVuZ3RoID09PSAwIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKXsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRldmljZUlkID0gZGF0YS5kZXZpY2VJZDsKICAgIGZvciAodmFyIHJpbmd0b25lVHlwZSBpbiBjb25uZWN0LmNvcmUucmluZ3RvbmVFbmdpbmVzKSB7CiAgICAgIGNvbm5lY3QuY29yZS5yaW5ndG9uZUVuZ2luZXNbcmluZ3RvbmVUeXBlXS5zZXRPdXRwdXREZXZpY2UoZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5SSU5HRVJfREVWSUNFX0NIQU5HRUQsCiAgICAgIGRhdGE6IHsgZGV2aWNlSWQ6IGRldmljZUlkIH0KICAgIH0pOwogIH0KCiAgY29ubmVjdC5jb3JlLmluaXRTb2Z0cGhvbmVNYW5hZ2VyID0gZnVuY3Rpb24gKHBhcmFtc0luKSB7CiAgICBjb25uZWN0LmdldExvZygpLmluZm8oIltTb2Z0cGhvbmUgTWFuYWdlcl0gaW5pdFNvZnRwaG9uZU1hbmFnZXIgc3RhcnRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAKICAgIHZhciBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZSA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVQYXJhbXNJbikgewogICAgICB2YXIgc29mdHBob25lUGFyYW1zID0gY29ubmVjdC5tZXJnZShwYXJhbXMuc29mdHBob25lIHx8IHt9LCBzb2Z0cGhvbmVQYXJhbXNJbik7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBjb21wZXRlRm9yTWFzdGVyT25BZ2VudFVwZGF0ZSBleGVjdXRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgaWYgKCFhZ2VudC5nZXRDaGFubmVsQ29uY3VycmVuY3koY29ubmVjdC5DaGFubmVsVHlwZS5WT0lDRSkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYWdlbnQub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBzdWIgPSB0aGlzOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIGFnZW50IHJlZnJlc2ggaGFuZGxlciBleGVjdXRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBjb25maXJtZWQgYXMgc29mdHBob25lIG1hc3RlciB0b3BpYyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIGlmICghY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIgJiYgYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkpIHsKICAgICAgICAgICAgICAvLyBCZWNvbWUgbWFzdGVyIHRvIHNlbmQgbG9ncywgc2luY2Ugd2UgbmVlZCBsb2dzIGZyb20gc29mdHBob25lIHRhYi4KICAgICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyID0gbmV3IGNvbm5lY3QuU29mdHBob25lTWFuYWdlcihzb2Z0cGhvbmVQYXJhbXMpOwogICAgICAgICAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9OwogCiAgICAvKioKICAgICAqIElmIHRoZSB3aW5kb3cgaXMgZnJhbWVkLCB3ZSBuZWVkIHRvIHdhaXQgZm9yIGEgQ09ORklHVVJFIG1lc3NhZ2UgZnJvbQogICAgICogZG93bnN0cmVhbSBiZWZvcmUgd2UgdHJ5IHRvIGluaXRpYWxpemUsIHVubGVzcyBwYXJhbXMuYWxsb3dGcmFtZWRTb2Z0cGhvbmUgaXMgdHJ1ZS4KICAgICAqLwogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSAmJiAhcGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lKSB7CiAgICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgICAgYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJbU29mdHBob25lIE1hbmFnZXJdIENvbmZpZ3VyZSBldmVudCBoYW5kbGVyIGV4ZWN1dGVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBpZiAoZGF0YS5zb2Z0cGhvbmUgJiYgZGF0YS5zb2Z0cGhvbmUuYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKGRhdGEuc29mdHBob25lKTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgICBzZXR1cEV2ZW50TGlzdGVuZXJzRm9yTXVsdGlUYWJVc2VJbkZpcmVmb3goZGF0YS5zb2Z0cGhvbmUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbXBldGVGb3JNYXN0ZXJPbkFnZW50VXBkYXRlKHBhcmFtcyk7CiAgICAgIHNldHVwRXZlbnRMaXN0ZW5lcnNGb3JNdWx0aVRhYlVzZUluRmlyZWZveChwYXJhbXMpOwogICAgfQogCiAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAvLyBTeW5jIG11dGUgYWNyb3NzIGFsbCB0YWJzIAogICAgICBpZiAoYWdlbnQuaXNTb2Z0cGhvbmVFbmFibGVkKCkgJiYgYWdlbnQuZ2V0Q2hhbm5lbENvbmN1cnJlbmN5KGNvbm5lY3QuQ2hhbm5lbFR5cGUuVk9JQ0UpKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwKICAgICAgICAgIHsKICAgICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLk1VVEUKICAgICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBzZXR1cEV2ZW50TGlzdGVuZXJzRm9yTXVsdGlUYWJVc2VJbkZpcmVmb3goc29mdHBob25lUGFyYW1zSW4pIHsKICAgICAgdmFyIHNvZnRwaG9uZVBhcmFtcyA9IGNvbm5lY3QubWVyZ2UocGFyYW1zLnNvZnRwaG9uZSB8fCB7fSwgc29mdHBob25lUGFyYW1zSW4pOwoKICAgICAgLy8ga2VlcCB0aGUgc29mdHBob25lIHBhcmFtcyBmb3IgZXh0ZXJuYWwgdXNlCiAgICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMgPSBzb2Z0cGhvbmVQYXJhbXM7CgogICAgICBpZiAoY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyKCkpIHsKICAgICAgICAvLyBJbiBGaXJlZm94LCB3aGVuIGEgdGFiIHRha2VzIG92ZXIgYW5vdGhlciB0YWIncyBzb2Z0cGhvbmUgcHJpbWFyeSwKICAgICAgICAvLyB0aGUgcHJldmlvdXMgcHJpbWFyeSB0YWIgc2hvdWxkIGRlbGV0ZSBzb2ZwaG9uZSBtYW5hZ2VyIGFuZCBzdG9wIG1pY3JvcGhvbmUKICAgICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1BU1RFUl9SRVNQT05TRSwgZnVuY3Rpb24gKHJlcykgewogICAgICAgICAgaWYgKHJlcy5kYXRhICYmIHJlcy5kYXRhLnRvcGljID09PSBjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUgJiYgcmVzLmRhdGEudGFrZU92ZXIgJiYgKHJlcy5kYXRhLm1hc3RlcklkICE9PSBjb25uZWN0LmNvcmUucG9ydFN0cmVhbUlkKSkgewogICAgICAgICAgICBpZiAoY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5vbkluaXRDb250YWN0U3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgICAgZGVsZXRlIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVNYW5hZ2VyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1c2VyTWVkaWFTdHJlYW0gPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCk7CiAgICAgICAgICAgIGlmICh1c2VyTWVkaWFTdHJlYW0pIHsKICAgICAgICAgICAgICB1c2VyTWVkaWFTdHJlYW0uZ2V0VHJhY2tzKCkuZm9yRWFjaChmdW5jdGlvbih0cmFjaykgeyB0cmFjay5zdG9wKCk7IH0pOwogICAgICAgICAgICAgIGNvbm5lY3QuY29yZS5zZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0obnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gSW4gRmlyZWZveCwgd2hlbiBtdWx0aXBsZSB0YWJzIGFyZSBvcGVuLAogICAgICAgIC8vIHdlYnJ0YyBzZXNzaW9uIGlzIG5vdCBzdGFydGVkIHVudGlsIFJFQURZX1RPX1NUQVJUX1NFU1NJT04gZXZlbnQgaXMgdHJpZ2dlcmVkCiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlNPRlRQSE9ORSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIpIHsKICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlci5zdGFydFNlc3Npb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TT0ZUUEhPTkUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBjb25uZWN0LmFnZW50KGZ1bmN0aW9uIChhZ2VudCkgewogICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciAmJiBhZ2VudC5pc1NvZnRwaG9uZUVuYWJsZWQoKSkgewogICAgICAgICAgICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgICAgICAgICAgICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1hbmFnZXIoc29mdHBob25lUGFyYW1zKTsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXIuc3RhcnRTZXNzaW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIGhhbmRsaW5nIG91dGJvdW5kLWNhbGwgYW5kIGF1dG8tYWNjZXB0IGNhc2VzIGZvciBwZW5kaW5nIHNlc3Npb24KICAgICAgICBjb25uZWN0LmNvbnRhY3QoZnVuY3Rpb24gKGMpIHsKICAgICAgICAgIGNvbm5lY3QuYWdlbnQoZnVuY3Rpb24gKGFnZW50KSB7CiAgICAgICAgICAgIGMub25SZWZyZXNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgY29ubmVjdC5oYXNPdGhlckNvbm5lY3RlZENDUHMoKSAmJgogICAgICAgICAgICAgICAgZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlID09PSAndmlzaWJsZScgJiYKICAgICAgICAgICAgICAgIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORyB8fCBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuSU5DT01JTkcpCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNPdXRCb3VuZENhbGwgPSBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmICFjb250YWN0LmlzSW5ib3VuZCgpOwogICAgICAgICAgICAgICAgdmFyIGlzQXV0b0FjY2VwdEVuYWJsZWQgPSBjb250YWN0LmlzU29mdHBob25lQ2FsbCgpICYmIGFnZW50LmdldENvbmZpZ3VyYXRpb24oKS5zb2Z0cGhvbmVBdXRvQWNjZXB0OwogICAgICAgICAgICAgICAgdmFyIGlzUXVldWVkQ2FsbGJhY2sgPSBjb250YWN0LmdldFR5cGUoKSA9PT0gY29ubmVjdC5Db250YWN0VHlwZS5RVUVVRV9DQUxMQkFDSzsKICAgICAgICAgICAgICAgIGlmIChpc091dEJvdW5kQ2FsbCB8fCBpc0F1dG9BY2NlcHRFbmFibGVkIHx8IGlzUXVldWVkQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLnRyaWdnZXJSZWFkeVRvU3RhcnRTZXNzaW9uRXZlbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyB0cmlnZ2VyIFJFQURZX1RPX1NUQVJUX1NFU1NJT04gZXZlbnQgaW4gYSBjb250ZXh0IHdpdGggU29mdHBob25lIE1hbmFnZXIKICAvLyBpbnRlcm5hbCB1c2Ugb25seQogIGNvbm5lY3QuY29yZS50cmlnZ2VyUmVhZHlUb1N0YXJ0U2Vzc2lvbkV2ZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFsbG93RnJhbWVkU29mdHBob25lID0gY29ubmVjdC5jb3JlLnNvZnRwaG9uZVBhcmFtcyAmJiBjb25uZWN0LmNvcmUuc29mdHBob25lUGFyYW1zLmFsbG93RnJhbWVkU29mdHBob25lOwogICAgaWYgKGNvbm5lY3QuaXNDQ1AoKSkgewogICAgICBpZiAoYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIGluIHRoaXMgaWZyYW1lZCBDQ1AgY29udGV4dAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlJFQURZX1RPX1NUQVJUX1NFU1NJT04pOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgICAgIC8vIGlmIHRoaXMgaXMgYW4gaWZyYW1lZCBDQ1AsIHRoZSBldmVudCBpcyBzZW5kIHRvIGRvd25zdHJlYW0gKENSTSkKICAgICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cy5SRUFEWV9UT19TVEFSVF9TRVNTSU9OKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gaWYgdGhpcyBpcyBhIHN0YW5kYWxvbmUgQ0NQLCB0cmlnZ2VyIHRoaXMgZXZlbnQgaW4gdGhpcyBDQ1AgY29udGV4dAogICAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBpZiAoYWxsb3dGcmFtZWRTb2Z0cGhvbmUpIHsKICAgICAgICAvLyB0aGUgZXZlbnQgaXMgc2VuZCB0byB0aGUgdXBzdHJlYW0gKGlmcmFtZWQgQ0NQKQogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBpbiB0aGlzIENSTSBjb250ZXh0CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuUkVBRFlfVE9fU1RBUlRfU0VTU0lPTik7CiAgICAgIH0KICAgIH0KICB9OwoKICBjb25uZWN0LmNvcmUuaW5pdFBhZ2VPcHRpb25zID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcywgInBhcmFtcyIpOwogICAgaWYgKGNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICAvLyBJZiB0aGUgQ0NQIGlzIGluIGEgZnJhbWUsIHdhaXQgZm9yIGNvbmZpZ3VyYXRpb24gZnJvbSBkb3duc3RyZWFtLgogICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQ09ORklHVVJFLCBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsCiAgICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMuQ09ORklHVVJFLAogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIC8vIExpc3RlbiBmb3IgaWZyYW1lIG1lZGlhIGRldmljZXMgcmVxdWVzdCBmcm9tIENSTQogICAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVFVRVNULCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gc2VuZERldmljZXMoZGV2aWNlcykgewogICAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUVESUFfREVWSUNFX1JFU1BPTlNFLCBkZXZpY2VzKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRldmljZXNJbikgewogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlc0luIHx8IFtdOwogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlcy5tYXAoZnVuY3Rpb24oZCkgeyByZXR1cm4gZC50b0pTT04oKSB9KTsKICAgICAgICAgICAgc2VuZERldmljZXMoZGV2aWNlcyk7CiAgICAgICAgICB9KQogICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsKICAgICAgICAgICAgc2VuZERldmljZXMoe2Vycm9yOiBlcnIubWVzc2FnZX0pOwogICAgICAgICAgfSk7IAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzZW5kRGV2aWNlcyh7ZXJyb3I6ICJObyBuYXZpZ2F0b3Igb3IgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyBvYmplY3QgZm91bmQifSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogR2V0IHRoZSBsaXN0IG9mIG1lZGlhIGRldmljZXMgZnJvbSBpZnJhbWVkIENDUAogICAqIFRpbWVvdXQgZm9yIHRoZSByZXF1ZXN0IGlzIHBhc3NlZCBvbiBhbiBvcHRpb25hbCBhcmd1bWVudAogICAqIFRoZSBkZWZhdWx0IHRpbWVvdXQgaXMgMTAwMG1zCiAgICovCiAgY29ubmVjdC5jb3JlLmdldEZyYW1lTWVkaWFEZXZpY2VzID0gZnVuY3Rpb24gKHRpbWVvdXRJbikgewogICAgdmFyIHN1YiA9IG51bGw7CiAgICB2YXIgdGltZW91dCA9IHRpbWVvdXRJbiB8fCAxMDAwOwogICAgdmFyIHRpbWVvdXRQcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgCiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiVGltZW91dCBleGNlZWRlZCIpKTsgCiAgICAgIH0sIHRpbWVvdXQpOwogICAgfSk7CiAgICB2YXIgbWVkaWFEZXZpY2VzUHJvbWlzZSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsgCiAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgfHwgY29ubmVjdC5pc0NDUCgpKSB7CiAgICAgICAgaWYgKG5hdmlnYXRvciAmJiBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzKSB7CiAgICAgICAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmVudW1lcmF0ZURldmljZXMoKQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGRldmljZXNJbikgewogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlc0luIHx8IFtdOwogICAgICAgICAgICBkZXZpY2VzID0gZGV2aWNlcy5tYXAoZnVuY3Rpb24gKGQpIHsgcmV0dXJuIGQudG9KU09OKCkgfSk7CiAgICAgICAgICAgIHJlc29sdmUoZGV2aWNlcyk7CiAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcigiTm8gbmF2aWdhdG9yIG9yIG5hdmlnYXRvci5tZWRpYURldmljZXMgb2JqZWN0IGZvdW5kIikpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICAgICAgc3ViID0gYnVzLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5NRURJQV9ERVZJQ0VfUkVTUE9OU0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5lcnJvcikgewogICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGRhdGEuZXJyb3IpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc29sdmUoZGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLk1FRElBX0RFVklDRV9SRVFVRVNUKTsKICAgICAgfQogICAgfSkKICAgIHJldHVybiBQcm9taXNlLnJhY2UoW21lZGlhRGV2aWNlc1Byb21pc2UsIHRpbWVvdXRQcm9taXNlXSkKICAgIC5maW5hbGx5KGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHN1YikgewogICAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgICB9CiAgICB9KTsKICB9CgogIC8vSW50ZXJuYWwgdXNlIG9ubHkuCiAgY29ubmVjdC5jb3JlLmF1dGhvcml6ZSA9IGZ1bmN0aW9uIChlbmRwb2ludCkgewogICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScKICAgIH07CgogICAgdmFyIGF1dGhvcml6ZUVuZHBvaW50ID0gZW5kcG9pbnQ7CiAgICBpZiAoIWF1dGhvcml6ZUVuZHBvaW50KSB7CiAgICAgIGF1dGhvcml6ZUVuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkKICAgICAgICA/IExFR0FDWV9BVVRIT1JJWkVfRU5EUE9JTlQKICAgICAgICA6IEFVVEhPUklaRV9FTkRQT0lOVDsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmZldGNoKGF1dGhvcml6ZUVuZHBvaW50LCBvcHRpb25zLCBBVVRIT1JJWkVfUkVUUllfSU5URVJWQUwsIEFVVEhPUklaRV9NQVhfUkVUUlkpOwogIH07CiAKICAvKioKICAgKiBAZGVwcmVjYXRlZAogICAqIFRoaXMgdXNlZCB0byBiZSB1c2VkIGludGVybmFsbHksIGJ1dCBpcyBubyBsb25nZXIgbmVlZGVkLgogICAqLwogIGNvbm5lY3QuY29yZS52ZXJpZnlEb21haW5BY2Nlc3MgPSBmdW5jdGlvbiAoYXV0aFRva2VuLCBlbmRwb2ludCkgewogICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGlzIEFQSSB3aWxsIGJlIGRlcHJlY2F0ZWQgaW4gdGhlIG5leHQgbWFqb3IgdmVyc2lvbiByZWxlYXNlIik7CiAgICBpZiAoIWNvbm5lY3QuaXNGcmFtZWQoKSkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7CiAgICB9CiAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgaGVhZGVyczogewogICAgICAgICdYLUFtei1CZWFyZXInOiBhdXRoVG9rZW4KICAgICAgfQogICAgfTsKICAgIHZhciB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IG51bGw7CiAgICBpZiAoZW5kcG9pbnQpewogICAgICB3aGl0ZWxpc3RlZE9yaWdpbnNFbmRwb2ludCA9IGVuZHBvaW50OwogICAgfQogICAgZWxzZSB7CiAgICAgIHdoaXRlbGlzdGVkT3JpZ2luc0VuZHBvaW50ID0gY29ubmVjdC5jb3JlLmlzTGVnYWN5RG9tYWluKCkgCiAgICAgICAgPyBMRUdBQ1lfV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVAogICAgICAgIDogV0hJVEVMSVNURURfT1JJR0lOU19FTkRQT0lOVDsKICAgIH0KICAgIAogICAgcmV0dXJuIGNvbm5lY3QuZmV0Y2god2hpdGVsaXN0ZWRPcmlnaW5zRW5kcG9pbnQsIG9wdGlvbnMsIFdISVRFTElTVEVEX09SSUdJTlNfUkVUUllfSU5URVJWQUwsIFdISVRFTElTVEVEX09SSUdJTlNfTUFYX1JFVFJZKS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICB2YXIgdG9wRG9tYWluID0gc2FuaXRpemVEb21haW4od2luZG93LmRvY3VtZW50LnJlZmVycmVyKTsKICAgICAgdmFyIGlzQWxsb3dlZCA9IHJlc3BvbnNlLndoaXRlbGlzdGVkT3JpZ2lucy5zb21lKGZ1bmN0aW9uIChvcmlnaW4pIHsKICAgICAgICByZXR1cm4gdG9wRG9tYWluID09PSBzYW5pdGl6ZURvbWFpbihvcmlnaW4pOwogICAgICB9KTsKICAgICAgcmV0dXJuIGlzQWxsb3dlZCA/IFByb21pc2UucmVzb2x2ZSgpIDogUHJvbWlzZS5yZWplY3QoKTsKICAgIH0pOwogIH07CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBSZXR1cm5zIHRydWUgaWYgdGhpcyB3aW5kb3cncyBocmVmIGlzIG9uIHRoZSBsZWdhY3kgY29ubmVjdCBkb21haW4uIAogICAqIE9ubHkgdXNlZnVsIGZvciBpbnRlcm5hbCB1c2UuIAogICAqLwogIGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbiA9IGZ1bmN0aW9uKHVybCkgewogICAgdXJsID0gdXJsIHx8IHdpbmRvdy5sb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuIHVybC5pbmNsdWRlcygnLmF3c2FwcHMuY29tJyk7CiAgfQogCgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJbml0aWFsaXplcyBDb25uZWN0IGJ5IGNyZWF0aW5nIG9yIGNvbm5lY3RpbmcgdG8gdGhlIEFQSSBTaGFyZWQgV29ya2VyLgogICAqIFVzZWQgb25seSBieSB0aGUgQ0NQCiAgICovCiAgY29ubmVjdC5jb3JlLmluaXRTaGFyZWRXb3JrZXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7CiAgICBjb25uZWN0LmNvcmUuY2hlY2tOb3RJbml0aWFsaXplZCgpOwogICAgaWYgKGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLCAncGFyYW1zJyk7CiAKICAgIHZhciBzaGFyZWRXb3JrZXJVcmwgPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnNoYXJlZFdvcmtlclVybCwgJ3BhcmFtcy5zaGFyZWRXb3JrZXJVcmwnKTsKICAgIHZhciBhdXRoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLmF1dGhUb2tlbiwgJ3BhcmFtcy5hdXRoVG9rZW4nKTsKICAgIHZhciByZWZyZXNoVG9rZW4gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZnJlc2hUb2tlbiwgJ3BhcmFtcy5yZWZyZXNoVG9rZW4nKTsKICAgIHZhciBhdXRoVG9rZW5FeHBpcmF0aW9uID0gY29ubmVjdC5hc3NlcnROb3ROdWxsKHBhcmFtcy5hdXRoVG9rZW5FeHBpcmF0aW9uLCAncGFyYW1zLmF1dGhUb2tlbkV4cGlyYXRpb24nKTsKICAgIHZhciByZWdpb24gPSBjb25uZWN0LmFzc2VydE5vdE51bGwocGFyYW1zLnJlZ2lvbiwgJ3BhcmFtcy5yZWdpb24nKTsKICAgIHZhciBlbmRwb2ludCA9IHBhcmFtcy5lbmRwb2ludCB8fCBudWxsOwogICAgdmFyIGF1dGhvcml6ZUVuZHBvaW50ID0gcGFyYW1zLmF1dGhvcml6ZUVuZHBvaW50OwogICAgaWYgKCFhdXRob3JpemVFbmRwb2ludCkgewogICAgICBhdXRob3JpemVFbmRwb2ludCA9IGNvbm5lY3QuY29yZS5pc0xlZ2FjeURvbWFpbigpCiAgICAgICAgPyBMRUdBQ1lfQVVUSE9SSVpFX0VORFBPSU5UCiAgICAgICAgOiBBVVRIT1JJWkVfRU5EUE9JTlQ7CiAgICB9CiAgICB2YXIgYWdlbnRBcHBFbmRwb2ludCA9IHBhcmFtcy5hZ2VudEFwcEVuZHBvaW50IHx8IG51bGw7CiAgICB2YXIgdGFza1RlbXBsYXRlc0VuZHBvaW50ID0gcGFyYW1zLnRhc2tUZW1wbGF0ZXNFbmRwb2ludCB8fCBudWxsOwogICAgdmFyIGF1dGhDb29raWVOYW1lID0gcGFyYW1zLmF1dGhDb29raWVOYW1lIHx8IG51bGw7CiAKICAgIHRyeSB7CiAgICAgIC8vIEluaXRpYWxpemUgdGhlIGV2ZW50IGJ1cyBhbmQgYWdlbnQgZGF0YSBwcm92aWRlcnMuCiAgICAgIGNvbm5lY3QuY29yZS5ldmVudEJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKHsgbG9nRXZlbnRzOiB0cnVlIH0pOwogICAgICBjb25uZWN0LmNvcmUuYWdlbnREYXRhUHJvdmlkZXIgPSBuZXcgQWdlbnREYXRhUHJvdmlkZXIoY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkpOwogICAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5ID0gbmV3IGNvbm5lY3QuTWVkaWFGYWN0b3J5KHBhcmFtcyk7CiAgICAgIAogICAgICAvLyBDcmVhdGUgdGhlIHNoYXJlZCB3b3JrZXIgYW5kIHVwc3RyZWFtIGNvbmR1aXQuCiAgICAgIHZhciB3b3JrZXIgPSBuZXcgU2hhcmVkV29ya2VyKHNoYXJlZFdvcmtlclVybCwgIkNvbm5lY3RTaGFyZWRXb3JrZXIiKTsKICAgICAgdmFyIGNvbmR1aXQgPSBuZXcgY29ubmVjdC5Db25kdWl0KCJDb25uZWN0U2hhcmVkV29ya2VyQ29uZHVpdCIsCiAgICAgICAgbmV3IGNvbm5lY3QuUG9ydFN0cmVhbSh3b3JrZXIucG9ydCksCiAgICAgICAgbmV3IGNvbm5lY3QuV2luZG93SU9TdHJlYW0od2luZG93LCBwYXJlbnQpKTsKIAogICAgICAvLyBTZXQgdGhlIGdsb2JhbCB1cHN0cmVhbSBjb25kdWl0IGZvciBleHRlcm5hbCB1c2UuCiAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IGNvbmR1aXQ7CiAgICAgIGNvbm5lY3QuY29yZS53ZWJTb2NrZXRQcm92aWRlciA9IG5ldyBXZWJTb2NrZXRQcm92aWRlcigpOwogCiAgICAgIC8vIENsb3NlIG91ciBwb3J0IHRvIHRoZSBzaGFyZWQgd29ya2VyIGJlZm9yZSB0aGUgd2luZG93IGNsb3Nlcy4KICAgICAgZ2xvYmFsLm9udW5sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNMT1NFKTsKICAgICAgICB3b3JrZXIucG9ydC5jbG9zZSgpOwogICAgICB9OwogCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbUxvZ1B1c2goY29uZHVpdCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVEb3duc3RyZWFtQ2xpZW50U2lkZUxvZ3NQdXNoKCk7CiAgICAgIC8vIEJyaWRnZSBhbGwgdXBzdHJlYW0gbWVzc2FnZXMgaW50byB0aGUgZXZlbnQgYnVzLgogICAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuYnJpZGdlKCkpOwogICAgICAvLyBQYXNzIGFsbCB1cHN0cmVhbSBtZXNzYWdlcyAoZnJvbSBzaGFyZWQgd29ya2VyKSBkb3duc3RyZWFtICh0byBDQ1AgY29uc3VtZXIpLgogICAgICBjb25kdWl0Lm9uQWxsVXBzdHJlYW0oY29uZHVpdC5wYXNzRG93bnN0cmVhbSgpKTsKCiAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkpIHsKICAgICAgICAvLyBCcmlkZ2UgYWxsIGRvd25zdHJlYW0gbWVzc2FnZXMgaW50byB0aGUgZXZlbnQgYnVzLgogICAgICAgIGNvbmR1aXQub25BbGxEb3duc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKICAgICAgICAvLyBQYXNzIGFsbCBkb3duc3RyZWFtIG1lc3NhZ2VzIChmcm9tIENDUCBjb25zdW1lcikgdXBzdHJlYW0gKHRvIHNoYXJlZCB3b3JrZXIpLgogICAgICAgIGNvbmR1aXQub25BbGxEb3duc3RyZWFtKGNvbmR1aXQucGFzc1Vwc3RyZWFtKCkpOwogICAgICB9CgogICAgICAvLyBTZW5kIGNvbmZpZ3VyYXRpb24gdXAgdG8gdGhlIHNoYXJlZCB3b3JrZXIuCiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgIGF1dGhUb2tlbjogYXV0aFRva2VuLAogICAgICAgIGF1dGhUb2tlbkV4cGlyYXRpb246IGF1dGhUb2tlbkV4cGlyYXRpb24sCiAgICAgICAgZW5kcG9pbnQ6IGVuZHBvaW50LAogICAgICAgIHJlZnJlc2hUb2tlbjogcmVmcmVzaFRva2VuLAogICAgICAgIHJlZ2lvbjogcmVnaW9uLAogICAgICAgIGF1dGhvcml6ZUVuZHBvaW50OiBhdXRob3JpemVFbmRwb2ludCwKICAgICAgICBhZ2VudEFwcEVuZHBvaW50OiBhZ2VudEFwcEVuZHBvaW50LAogICAgICAgIHRhc2tUZW1wbGF0ZXNFbmRwb2ludDogdGFza1RlbXBsYXRlc0VuZHBvaW50LAogICAgICAgIGF1dGhDb29raWVOYW1lOiBhdXRoQ29va2llTmFtZSwKICAgICAgICBsb25nUG9sbGluZ09wdGlvbnM6IHBhcmFtcy5sb25nUG9sbGluZ09wdGlvbnMgfHwgdW5kZWZpbmVkCiAgICAgIH0pOwogCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0tOT1dMRURHRSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkFja25vd2xlZGdlZCBieSB0aGUgQ29ubmVjdFNoYXJlZFdvcmtlciEiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuY29yZS5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgY29ubmVjdC5jb3JlLl9zZXRUYWJJZCgpOwogICAgICAgIGNvbm5lY3QuY29yZS5wb3J0U3RyZWFtSWQgPSBkYXRhLmlkOwogICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgfSk7CiAgICAgIC8vIEFkZCBhbGwgdXBzdHJlYW0gbG9nIGVudHJpZXMgdG8gb3VyIG93biBsb2dnZXIuCiAgICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgICAgIGlmIChsb2dFbnRyeS5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEdldCB3b3JrZXIgbG9ncwogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VSVkVSX0JPVU5EX0lOVEVSTkFMX0xPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyKGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2dFbnRyeSkpOwogICAgICB9KTsKICAgICAgLy8gR2V0IG91dGVyIGNvbnRleHQgbG9ncwogICAgICBjb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCBmdW5jdGlvbiAobG9ncykgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgQXJyYXkuaXNBcnJheShsb2dzKSkgewogICAgICAgICAgbG9ncy5mb3JFYWNoKGZ1bmN0aW9uIChsb2cpIHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyKGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2cpKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEdldCBsb2cgZnJvbSBvdXRlciBjb250ZXh0CiAgICAgIGNvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZykgewogICAgICAgIGlmIChjb25uZWN0LmlzRnJhbWVkKCkgJiYgbG9nLmxvZ2dlcklkICE9PSBjb25uZWN0LmdldExvZygpLmdldExvZ2dlcklkKCkpIHsgCiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmFkZExvZ0VudHJ5KGNvbm5lY3QuTG9nRW50cnkuZnJvbU9iamVjdChsb2cpKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgY29ubmVjdC5jb3JlLm9uQXV0aEZhaWwoY29ubmVjdC5oaXRjaChjb25uZWN0LmNvcmUsIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aEZhaWwsIHBhcmFtcy5sb2dpbkVuZHBvaW50IHx8IG51bGwsIGF1dGhvcml6ZUVuZHBvaW50KSk7IC8vIEZvciBhdXRoIHJldHJ5IGxvZ2ljIG9uIDQwMXMuCiAgICAgIGNvbm5lY3QuY29yZS5vbkF1dGhvcml6ZVN1Y2Nlc3MoY29ubmVjdC5oaXRjaChjb25uZWN0LmNvcmUsIGNvbm5lY3QuY29yZS5faGFuZGxlQXV0aG9yaXplU3VjY2VzcykpOyAvLyBGb3IgYXV0aCByZXRyeSBsb2dpYyBvbiA0MDFzLgoKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJVc2VyIEFnZW50OiAiICsgbmF2aWdhdG9yLnVzZXJBZ2VudCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJpc0NDUHYyOiAiICsgdHJ1ZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJpc0ZyYW1lZDogIiArIGNvbm5lY3QuaXNGcmFtZWQoKSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtLm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5PVVRFUl9DT05URVhUX0lORk8sIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIHN0cmVhbXNWZXJzaW9uID0gZGF0YS5zdHJlYW1zVmVyc2lvbjsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlN0cmVhbXNKUyBWZXJzaW9uOiAiICsgc3RyZWFtc1ZlcnNpb24pLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwoKICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIk51bWJlciBvZiBjb25uZWN0ZWQgQ0NQcyB1cGRhdGVkOiAiICsgZGF0YS5sZW5ndGgpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSBkYXRhLmxlbmd0aDsKICAgICAgICBpZiAoZGF0YVtjb25uZWN0LmNvcmUudGFiSWRdICYmICFpc05hTihkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0ubGVuZ3RoKSl7CiAgICAgICAgICBpZiAoY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgIT09IGRhdGFbY29ubmVjdC5jb3JlLnRhYklkXS5sZW5ndGgpIHsKICAgICAgICAgICAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgPSBkYXRhW2Nvbm5lY3QuY29yZS50YWJJZF0ubGVuZ3RoOwogICAgICAgICAgICBpZiAoY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHNJblRoaXNUYWIgPiAxKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGVyZSBhcmUgIiArIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFiICsgIiBjb25uZWN0ZWQgQ0NQcyBpbiB0aGlzIHRhYi4gUGxlYXNlIGFkanVzdCB5b3VyIGltcGxlbWVudGF0aW9uIHRvIGF2b2lkIGNvbXBsaWNhdGlvbnMuIElmIHlvdSBhcmUgZW1iZWRkaW5nIENDUCwgcGxlYXNlIGRvIHNvIGV4Y2x1c2l2ZWx5IHdpdGggaW5pdENDUC4gSW5pdENDUCB3aWxsIG5vdCBsZXQgeW91IGVtYmVkIG1vcmUgdGhhbiBvbmUgQ0NQLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICAgICAgICBuYW1lOiBDT05ORUNURURfQ0NQU19TSU5HTEVfVEFCLAogICAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzSW5UaGlzVGFifQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRhdGEudGFiSWQgJiYgZGF0YS5zdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIpIHsKICAgICAgICAgIGNvbm5lY3QuaWZNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTUVUUklDUywgKCkgPT4KICAgICAgICAgICAgY29ubmVjdC5hZ2VudCgoKSA9PiBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICAgIG5hbWU6IENDUF9UQUJTX0FDUk9TU19CUk9XU0VSX0NPVU5ULAogICAgICAgICAgICAgIGRhdGE6IHsgdGFiSWQ6IGRhdGEudGFiSWQsIGNvdW50OiBkYXRhLnN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciB9CiAgICAgICAgICAgIH0pKQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudChjb25kdWl0KTsKIAogICAgICAvLyBQYXNzIHRoZSBURVJNSU5BVEUgcmVxdWVzdCB1cHN0cmVhbSB0byB0aGUgc2hhcmVkIHdvcmtlci4KICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLlRFUk1JTkFURSwKICAgICAgICBjb25kdWl0LnBhc3NVcHN0cmVhbSgpKTsKIAogICAgICAvLyBSZWZyZXNoIHRoZSBwYWdlIHdoZW4gd2UgcmVjZWl2ZSB0aGUgVEVSTUlOQVRFRCByZXNwb25zZSBmcm9tIHRoZQogICAgICAvLyBzaGFyZWQgd29ya2VyLgogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFRCwgZnVuY3Rpb24gKCkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQodHJ1ZSk7CiAgICAgIH0pOwogCiAgICAgIHdvcmtlci5wb3J0LnN0YXJ0KCk7CgogICAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5Wb2ljZUlkRXZlbnRzLlVQREFURV9ET01BSU5fSUQsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5kb21haW5JZCkgewogICAgICAgICAgY29ubmVjdC5jb3JlLnZvaWNlSWREb21haW5JZCA9IGRhdGEuZG9tYWluSWQ7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIC8vIHRyeSBmZXRjaGluZyB2b2ljZUlkJ3MgZG9tYWluSWQgb25jZSB0aGUgYWdlbnQgaXMgaW5pdGlhbGl6ZWQKICAgICAgY29ubmVjdC5hZ2VudChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHZvaWNlSWQgPSBuZXcgY29ubmVjdC5Wb2ljZUlkKCk7CiAgICAgICAgdm9pY2VJZC5nZXREb21haW5JZCgpCiAgICAgICAgICAudGhlbihmdW5jdGlvbihkb21haW5JZCkgewogICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oInZvaWNlSWQgZG9tYWluSWQgc3VjY2Vzc2Z1bGx5IGZldGNoZWQgYXQgYWdlbnQgaW5pdGlhbGl6YXRpb246ICIgKyBkb21haW5JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygidm9pY2VJZCBkb21haW5JZCBub3QgZmV0Y2hlZCBhdCBhZ2VudCBpbml0aWFsaXphdGlvbiIpLndpdGhPYmplY3QoeyBlcnI6IGVyciB9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgfSk7CiAgICAgIH0pOwogCiAgICAgIC8vIEF0dGVtcHQgdG8gZ2V0IHBlcm1pc3Npb24gdG8gc2hvdyBub3RpZmljYXRpb25zLgogICAgICB2YXIgbm0gPSBjb25uZWN0LmNvcmUuZ2V0Tm90aWZpY2F0aW9uTWFuYWdlcigpOwogICAgICBubS5yZXF1ZXN0UGVybWlzc2lvbigpOwoKICAgICAgY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLklOSVRfRElTQVNURVJfUkVDT1ZFUlksIGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIGNvbm5lY3QuY29yZS5pbml0RGlzYXN0ZXJSZWNvdmVyeShwYXJhbXMpOwogICAgICB9KQogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJGYWlsZWQgdG8gaW5pdGlhbGl6ZSB0aGUgQVBJIHNoYXJlZCB3b3JrZXIsIHdlJ3JlIGRlYWQhIikKICAgICAgICAud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIGNvbm5lY3QuY29yZS5fc2V0VGFiSWQgPSBmdW5jdGlvbigpIHsKICAgIHRyeSB7CiAgICAgIGNvbm5lY3QuY29yZS50YWJJZCA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLlRBQl9JRCk7CiAgICAgIGlmICghY29ubmVjdC5jb3JlLnRhYklkKXsKICAgICAgICBjb25uZWN0LmNvcmUudGFiSWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CiAgICAgICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuVEFCX0lELCBjb25uZWN0LmNvcmUudGFiSWQpOwogICAgICB9CiAgICAgIGNvbm5lY3QuY29yZS51cHN0cmVhbS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEFCX0lELCB7dGFiSWQ6IGNvbm5lY3QuY29yZS50YWJJZH0pOwogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIltUYWIgSWRdIFRoZXJlIHdhcyBhbiBpc3N1ZSBzZXR0aW5nIHRoZSB0YWIgSWQiKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfQogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIEluaXRpYWxpemVzIENvbm5lY3QgYnkgY3JlYXRpbmcgb3IgY29ubmVjdGluZyB0byB0aGUgQVBJIFNoYXJlZCBXb3JrZXIuCiAgICogSW5pdGlhbGl6ZXMgQ29ubmVjdCBieSBsb2FkaW5nIHRoZSBDQ1AgaW4gYW4gaWZyYW1lIGFuZCBjb25uZWN0aW5nIHRvIGl0LgogICAqLwogIGNvbm5lY3QuY29yZS5pbml0Q0NQID0gZnVuY3Rpb24gKGNvbnRhaW5lckRpdiwgcGFyYW1zSW4pIHsKICAgIGNvbm5lY3QuY29yZS5jaGVja05vdEluaXRpYWxpemVkKCk7CiAgICBpZiAoY29ubmVjdC5jb3JlLmluaXRpYWxpemVkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiSWZyYW1lIGluaXRpYWxpemF0aW9uIHN0YXJ0ZWQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgdmFyIGluaXRTdGFydFRpbWUgPSBEYXRlLm5vdygpOwogICAgLy8gQ2hlY2sgaWYgQ0NQIGlmcmFtZSBoYXMgYWxyZWFkeSBiZWVuIGluaXRpYWxpemVkIHRocm91Z2ggaW5pdENDUAogICAgdHJ5IHsKICAgICAgaWYgKGNvbm5lY3QuY29yZS5fZ2V0Q0NQSWZyYW1lKCkpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoJ0F0dGVtcHRlZCB0byBjYWxsIGluaXRDQ1Agd2hlbiBhbiBpZnJhbWUgZ2VuZXJhdGVkIGJ5IGluaXRDQ1AgYWxyZWFkeSBleGlzdHMnKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0gY2F0Y2goZSkgewogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCdFcnJvciB3aGlsZSBjaGVja2luZyBpZiBpbml0Q0NQIGhhcyBhbHJlYWR5IGJlZW4gY2FsbGVkJykud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogCiAgICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHksIHdoZW4gaW5zdGVhZCBvZiB0YWtpbmcgYSBwYXJhbXMgb2JqZWN0CiAgICAvLyBhcyBpbnB1dCB3ZSBvbmx5IGFjY2VwdGVkIGNjcFVybC4KICAgIHZhciBwYXJhbXMgPSB7fTsKICAgIGlmICh0eXBlb2YgKHBhcmFtc0luKSA9PT0gJ3N0cmluZycpIHsKICAgICAgcGFyYW1zLmNjcFVybCA9IHBhcmFtc0luOwogICAgfSBlbHNlIHsKICAgICAgcGFyYW1zID0gcGFyYW1zSW47CiAgICB9CiAKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChjb250YWluZXJEaXYsICdjb250YWluZXJEaXYnKTsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChwYXJhbXMuY2NwVXJsLCAncGFyYW1zLmNjcFVybCcpOwogCiAgICAvLyBDcmVhdGUgdGhlIENDUCBpZnJhbWUgYW5kIGFwcGVuZCBpdCB0byB0aGUgY29udGFpbmVyIGRpdi4KICAgIHZhciBpZnJhbWUgPSBjb25uZWN0LmNvcmUuX2NyZWF0ZUNDUElmcmFtZShjb250YWluZXJEaXYsIHBhcmFtcyk7CgogICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXZlbnQgYnVzIGFuZCBhZ2VudCBkYXRhIHByb3ZpZGVycy4KICAgIC8vIE5PVEU6IFNldHRpbmcgbG9nRXZlbnRzIGhlcmUgdG8gRkFMU0UgaW4gb3JkZXIgdG8gYXZvaWQgZHVwbGljYXRpbmcKICAgIC8vIGV2ZW50cyB3aGljaCBhcmUgbG9nZ2VkIGluIENDUC4KICAgIGNvbm5lY3QuY29yZS5ldmVudEJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKHsgbG9nRXZlbnRzOiBmYWxzZSB9KTsKICAgIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlciA9IG5ldyBBZ2VudERhdGFQcm92aWRlcihjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKSk7CiAgICBjb25uZWN0LmNvcmUubWVkaWFGYWN0b3J5ID0gbmV3IGNvbm5lY3QuTWVkaWFGYWN0b3J5KHBhcmFtcyk7CiAKICAgIC8vIEJ1aWxkIHRoZSB1cHN0cmVhbSBjb25kdWl0IGNvbW11bmljYXRpbmcgd2l0aCB0aGUgQ0NQIGlmcmFtZS4KICAgIHZhciBjb25kdWl0ID0gbmV3IGNvbm5lY3QuSUZyYW1lQ29uZHVpdChwYXJhbXMuY2NwVXJsLCB3aW5kb3csIGlmcmFtZSk7CiAKICAgIC8vIExldCBDQ1Aga25vdyBpZiBpZnJhbWUgaXMgdmlzaWJsZQogICAgY29ubmVjdC5jb3JlLl9zZW5kSWZyYW1lU3R5bGVEYXRhVXBzdHJlYW1BZnRlclJlYXNvbmFibGVXYWl0VGltZShpZnJhbWUsIGNvbmR1aXQpOwogCiAgICAvLyBTZXQgdGhlIGdsb2JhbCB1cHN0cmVhbSBjb25kdWl0IGZvciBleHRlcm5hbCB1c2UuCiAgICBjb25uZWN0LmNvcmUudXBzdHJlYW0gPSBjb25kdWl0OwogCiAgICAvLyBJbml0IHdlYlNvY2tldFByb3ZpZGVyCiAgICBjb25uZWN0LmNvcmUud2ViU29ja2V0UHJvdmlkZXIgPSBuZXcgV2ViU29ja2V0UHJvdmlkZXIoKTsKIAogICAgY29uZHVpdC5vbkFsbFVwc3RyZWFtKGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLmJyaWRnZSgpKTsKIAogICAgLy8gSW5pdGlhbGl6ZSB0aGUga2VlcGFsaXZlIG1hbmFnZXIuCiAgICBjb25uZWN0LmNvcmUua2VlcGFsaXZlTWFuYWdlciA9IG5ldyBLZWVwYWxpdmVNYW5hZ2VyKGNvbmR1aXQsCiAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLAogICAgICBwYXJhbXMuY2NwU3luVGltZW91dCB8fCBDQ1BfU1lOX1RJTUVPVVQsCiAgICAgIHBhcmFtcy5jY3BBY2tUaW1lb3V0IHx8IENDUF9BQ0tfVElNRU9VVCkKICAgICAgOwogICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID0gbnVsbDsKIAogICAgLy8gQWxsb3cgNSBzZWMgKGRlZmF1bHQpIGJlZm9yZSByZWNlaXZpbmcgdGhlIGZpcnN0IEFDSyBmcm9tIHRoZSBDQ1AuCiAgICBjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSA9IGdsb2JhbC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UgPSBudWxsOwogICAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFDS19USU1FT1VUKTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDQ1AgTG9hZFRpbWVvdXQgdHJpZ2dlcmVkIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0sIHBhcmFtcy5jY3BMb2FkVGltZW91dCB8fCBDQ1BfTE9BRF9USU1FT1VUKTsKCiAgICBjb25uZWN0LmdldExvZygpLnNjaGVkdWxlVXBzdHJlYW1PdXRlckNvbnRleHRDQ1BMb2dzUHVzaChjb25kdWl0KTsKICAgIGNvbm5lY3QuZ2V0TG9nKCkuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1B1c2goY29uZHVpdCk7CiAKICAgIC8vIE9uY2Ugd2UgcmVjZWl2ZSB0aGUgZmlyc3QgQUNLLCBzZXR1cCBvdXIgdXBzdHJlYW0gQVBJIGNsaWVudCBhbmQgZXN0YWJsaXNoCiAgICAvLyB0aGUgU1lOL0FDSyByZWZyZXNoIGZsb3cuCiAgICBjb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQWNrbm93bGVkZ2VkIGJ5IHRoZSBDQ1AhIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5jb3JlLmNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdENsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG5ldyBjb25uZWN0LlVwc3RyZWFtQ29uZHVpdE1hc3RlckNsaWVudChjb25kdWl0KTsKICAgICAgY29ubmVjdC5jb3JlLnBvcnRTdHJlYW1JZCA9IGRhdGEuaWQ7CgogICAgICBpZiAocGFyYW1zLnNvZnRwaG9uZSB8fCBwYXJhbXMuY2hhdCB8fCBwYXJhbXMucGFnZU9wdGlvbnMgfHwgcGFyYW1zLnNob3VsZEFkZE5hbWVzcGFjZVRvTG9ncykgewogICAgICAgIC8vIFNlbmQgY29uZmlndXJhdGlvbiB1cCB0byB0aGUgQ0NQLgogICAgICAgIC8vc2V0IGl0IHRvIGZhbHNlIGlmIHNlY29uZGFyeQogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkNPTkZJR1VSRSwgewogICAgICAgICAgc29mdHBob25lOiBwYXJhbXMuc29mdHBob25lLAogICAgICAgICAgY2hhdDogcGFyYW1zLmNoYXQsCiAgICAgICAgICBwYWdlT3B0aW9uczogcGFyYW1zLnBhZ2VPcHRpb25zLAogICAgICAgICAgc2hvdWxkQWRkTmFtZXNwYWNlVG9Mb2dzOiBwYXJhbXMuc2hvdWxkQWRkTmFtZXNwYWNlVG9Mb2dzLAogICAgICAgIH0pOwogICAgICB9CgogICAgICAvLyBJZiBEUiBlbmFibGVkLCBzZXQgdGhpcyBDQ1AgaW5zdGFuY2UgYXMgcGFydCBvZiBhIERpc2FzdGVyIFJlY292ZXJ5IGZsZWV0CiAgICAgIGlmIChwYXJhbXMuZGlzYXN0ZXJSZWNvdmVyeU9uKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLnJlZ2lvbiA9IHBhcmFtcy5yZWdpb247CiAgICAgICAgY29ubmVjdC5jb3JlLnN1cHByZXNzQ29udGFjdHMgPSBzdXBwcmVzc0NvbnRhY3RzOwogICAgICAgIGNvbm5lY3QuY29yZS5mb3JjZU9mZmxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cy5TRVRfT0ZGTElORSk7CiAgICAgICAgfSAgICAgICAKICAgICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuSU5JVF9ESVNBU1RFUl9SRUNPVkVSWSwgcGFyYW1zKTsKICAgICAgfQogCiAgICAgIGlmIChjb25uZWN0LmNvcmUuY2NwTG9hZFRpbWVvdXRJbnN0YW5jZSkgewogICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmNjcExvYWRUaW1lb3V0SW5zdGFuY2UpOwogICAgICAgIGNvbm5lY3QuY29yZS5jY3BMb2FkVGltZW91dEluc3RhbmNlID0gbnVsbDsKICAgICAgfQoKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuT1VURVJfQ09OVEVYVF9JTkZPLCB7IHN0cmVhbXNWZXJzaW9uOiBjb25uZWN0LnZlcnNpb24gfSk7CiAKICAgICAgY29ubmVjdC5jb3JlLmtlZXBhbGl2ZU1hbmFnZXIuc3RhcnQoKTsKICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwoKICAgICAgY29ubmVjdC5jb3JlLmluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5JTklUKTsKICAgICAgaWYgKGluaXRTdGFydFRpbWUpIHsKICAgICAgICB2YXIgaW5pdFRpbWUgPSBEYXRlLm5vdygpIC0gaW5pdFN0YXJ0VGltZTsKICAgICAgICB2YXIgcmVmcmVzaEF0dGVtcHRzID0gY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IHx8IDA7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCdJZnJhbWUgaW5pdGlhbGl6YXRpb24gc3VjY2VlZGVkJykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYElmcmFtZSBpbml0aWFsaXphdGlvbiB0aW1lICR7aW5pdFRpbWV9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYElmcmFtZSByZWZyZXNoIGF0dGVtcHRzICR7cmVmcmVzaEF0dGVtcHRzfWApLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX1JFRlJFU0hfQVRURU1QVFMsCiAgICAgICAgICAgIGRhdGE6IHsgY291bnQ6IHJlZnJlc2hBdHRlbXB0c30gCiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fU1VDQ0VTUywKICAgICAgICAgICAgZGF0YTogeyBjb3VudDogMX0gCiAgICAgICAgICB9KTsKICAgICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICAgIG5hbWU6IENTTV9JRlJBTUVfSU5JVElBTElaQVRJT05fVElNRSwKICAgICAgICAgICAgZGF0YTogeyBjb3VudDogaW5pdFRpbWV9IAogICAgICAgICAgfSk7CiAgICAgICAgICAvL3RvIGF2b2lkIG1ldHJpYyBlbWlzc2lvbiBhZnRlciBpbml0aWFsaXphdGlvbgogICAgICAgICAgaW5pdFN0YXJ0VGltZSA9IG51bGw7CiAgICAgICAgfSwxMDAwKQogICAgICB9CiAgICB9KTsKIAogICAgLy8gQWRkIGFueSBsb2dzIGZyb20gdGhlIHVwc3RyZWFtIHRvIG91ciBvd24gbG9nZ2VyLgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkxPRywgZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICAgIGlmIChsb2dFbnRyeS5sb2dnZXJJZCAhPT0gY29ubmVjdC5nZXRMb2coKS5nZXRMb2dnZXJJZCgpKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5hZGRMb2dFbnRyeShjb25uZWN0LkxvZ0VudHJ5LmZyb21PYmplY3QobG9nRW50cnkpKTsKICAgICAgfQogICAgfSk7CiAKICAgIC8vIFBvcCBhIGxvZ2luIHBhZ2Ugd2hlbiB3ZSBlbmNvdW50ZXIgYW4gQUNLIHRpbWVvdXQuCiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuQUNLX1RJTUVPVVQsIGZ1bmN0aW9uICgpIHsKICAgICAgLy8gbG9naW5Qb3B1cCBpcyB0cnVlIGJ5IGRlZmF1bHQsIG9ubHkgZmFsc2UgaWYgZXhwbGljaXRseSBzZXQgdG8gZmFsc2UuCiAgICAgIGlmIChwYXJhbXMubG9naW5Qb3B1cCAhPT0gZmFsc2UpIHsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIGxvZ2luVXJsID0gZ2V0TG9naW5VcmwocGFyYW1zKTsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiQUNLX1RJTUVPVVQgb2NjdXJyZWQsIGF0dGVtcHRpbmcgdG8gcG9wIHRoZSBsb2dpbiBwYWdlIGlmIG5vdCBhbHJlYWR5IG9wZW4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIC8vIGNsZWFyIG91dCBsYXN0IG9wZW5lZCB0aW1lc3RhbXAgZm9yIFNBTUwgYXV0aGVudGljYXRpb24gd2hlbiB0aGVyZSBpcyBBQ0tfVElNRU9VVAogICAgICAgICAgaWYgKHBhcmFtcy5sb2dpblVybCkgewogICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkuY2xlYXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogICAgICAgICAgfQogICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93ID0gY29ubmVjdC5jb3JlLmdldFBvcHVwTWFuYWdlcigpLm9wZW4obG9naW5VcmwsIGNvbm5lY3QuTWFzdGVyVG9waWNzLkxPR0lOX1BPUFVQLCBwYXJhbXMubG9naW5PcHRpb25zKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJBQ0tfVElNRU9VVCBvY2N1cnJlZCBidXQgd2UgYXJlIHVuYWJsZSB0byBvcGVuIHRoZSBsb2dpbiBwb3B1cC4iKS53aXRoRXhjZXB0aW9uKGUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID09IG51bGwpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQpOwogICAgICAgICAgICBjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICBjb25uZWN0LmNvcmUuZ2V0UG9wdXBNYW5hZ2VyKCkuY2xlYXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuTE9HSU5fUE9QVVApOwogICAgICAgICAgICBpZiAoKHBhcmFtcy5sb2dpblBvcHVwQXV0b0Nsb3NlIHx8IChwYXJhbXMubG9naW5PcHRpb25zICYmIHBhcmFtcy5sb2dpbk9wdGlvbnMuYXV0b0Nsb3NlKSkgJiYgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93KSB7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93LmNsb3NlKCk7CiAgICAgICAgICAgICAgY29ubmVjdC5jb3JlLmxvZ2luV2luZG93ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBjb25uZWN0LmNvcmUuX3JlZnJlc2hJZnJhbWVPblRpbWVvdXQocGFyYW1zLCBjb250YWluZXJEaXYpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkVycm9yIG9jY3VycmVkIHdoaWxlIHJlZnJlc2hpbmcgaWZyYW1lIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAKICAgIGlmIChwYXJhbXMub25WaWV3Q29udGFjdCkgewogICAgICBjb25uZWN0LmNvcmUub25WaWV3Q29udGFjdChwYXJhbXMub25WaWV3Q29udGFjdCk7CiAgICB9CgogICAgY29uZHVpdC5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgY29ubmVjdC5udW1iZXJPZkNvbm5lY3RlZENDUHMgPSBkYXRhLmxlbmd0aDsKICAgIH0pOwoKICAgIGNvbmR1aXQub25VcHN0cmVhbShjb25uZWN0LlZvaWNlSWRFdmVudHMuVVBEQVRFX0RPTUFJTl9JRCwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgaWYgKGRhdGEgJiYgZGF0YS5kb21haW5JZCkgewogICAgICAgIGNvbm5lY3QuY29yZS52b2ljZUlkRG9tYWluSWQgPSBkYXRhLmRvbWFpbklkOwogICAgICB9CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1JFVFJJRVNfRVhIQVVTVEVELCBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChpbml0U3RhcnRUaW1lKSB7CiAgICAgICAgdmFyIHJlZnJlc2hBdHRlbXB0cyA9IGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCAtIDE7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCdJZnJhbWUgaW5pdGlhbGl6YXRpb24gZmFpbGVkJykuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oYFRpbWUgYWZ0ZXIgaWZyYW1lIGluaXRpYWxpemF0aW9uIHN0YXJ0ZWQgJHtEYXRlLm5vdygpIC0gaW5pdFN0YXJ0VGltZX1gKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbyhgSWZyYW1lIHJlZnJlc2ggYXR0ZW1wdHMgJHtyZWZyZXNoQXR0ZW1wdHN9YCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgICAgbmFtZTogQ1NNX0lGUkFNRV9SRUZSRVNIX0FUVEVNUFRTLAogICAgICAgICAgZGF0YTogeyBjb3VudDogcmVmcmVzaEF0dGVtcHRzfQogICAgICAgIH0pOwogICAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgICBuYW1lOiBDU01fSUZSQU1FX0lOSVRJQUxJWkFUSU9OX1NVQ0NFU1MsCiAgICAgICAgICBkYXRhOiB7IGNvdW50OiAwfQogICAgICAgIH0pOwogICAgICAgIGluaXRTdGFydFRpbWUgPSBudWxsOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBrZWVwIHRoZSBzb2Z0cGhvbmUgcGFyYW1zIGZvciBleHRlcm5hbCB1c2UKICAgIGNvbm5lY3QuY29yZS5zb2Z0cGhvbmVQYXJhbXMgPSBwYXJhbXMuc29mdHBob25lOwogIH07CgogIGNvbm5lY3QuY29yZS5vbklmcmFtZVJldHJpZXNFeGhhdXN0ZWQgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKS5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1JFVFJJRVNfRVhIQVVTVEVELCBmKTsKICB9CgogIGNvbm5lY3QuY29yZS5fcmVmcmVzaElmcmFtZU9uVGltZW91dCA9IGZ1bmN0aW9uKGluaXRDQ1BQYXJhbXMsIGNvbnRhaW5lckRpdikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGluaXRDQ1BQYXJhbXMsICdpbml0Q0NQUGFyYW1zJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFpbmVyRGl2LCAnY29udGFpbmVyRGl2Jyk7CiAgICB2YXIgY2NwSWZyYW1lUmVmcmVzaEludGVydmFsID0gKGluaXRDQ1BQYXJhbXMuZGlzYXN0ZXJSZWNvdmVyeU9uKSA/IENDUF9EUl9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTCA6IENDUF9JRlJBTUVfUkVGUkVTSF9JTlRFUlZBTDsKICAgIHZhciByZXRyeURlbGF5ID0gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheSgoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IC0gMSB8fCAwKSwgeyBiYXNlOiAyMDAwIH0pOwogICAgLy8gRXZhbHVhdGVzIHRvIDAgZm9yIDB0aCBhdHRlbXB0IGFuZCAxIGZvciByZXN0ICg+MCkgb2YgdGhlIHJlZnJlc2ggYXR0ZW1wdHMKICAgIHZhciB0aW1lb3V0RmFjdG9yID0gTWF0aC5jZWlsKChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgfHwgMCkgLyBDQ1BfSUZSQU1FX1JFRlJFU0hfTElNSVQpOwogICAgdmFyIHRpbWVvdXQgPSAoY2NwSWZyYW1lUmVmcmVzaEludGVydmFsICsgcmV0cnlEZWxheSkgKiB0aW1lb3V0RmFjdG9yOwogICAgZ2xvYmFsLmNsZWFyVGltZW91dChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaFRpbWVvdXQpOwogICAgY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0ID0gZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIGNvbm5lY3QuY29yZS5pZnJhbWVSZWZyZXNoQXR0ZW1wdCA9IChjb25uZWN0LmNvcmUuaWZyYW1lUmVmcmVzaEF0dGVtcHQgfHwgMCkgKyAxOwogICAgICBpZiAoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hBdHRlbXB0IDw9IENDUF9JRlJBTUVfUkVGUkVTSF9MSU1JVCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgaWZyYW1lID0gY29ubmVjdC5jb3JlLl9nZXRDQ1BJZnJhbWUoKTsKICAgICAgICAgIGlmIChpZnJhbWUpIHsKICAgICAgICAgICAgaWZyYW1lLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaWZyYW1lKTsgLy8gVGhlIG9ubHkgd2F5IHRvIGZvcmNlIGEgc3luY2hyb25vdXMgcmVsb2FkIG9mIHRoZSBpZnJhbWUgd2l0aG91dCB0aGUgb2xkIGlmcmFtZSBjb250aW51aW5nIHRvIGZ1bmN0aW9uIGlzIHRvIHJlbW92ZSB0aGUgb2xkIGlmcmFtZSBlbnRpcmVseS4KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdJZnJhbWUgPSBjb25uZWN0LmNvcmUuX2NyZWF0ZUNDUElmcmFtZShjb250YWluZXJEaXYsIGluaXRDQ1BQYXJhbXMpOwogICAgICAgICAgY29ubmVjdC5jb3JlLnVwc3RyZWFtLnVwc3RyZWFtLm91dHB1dCA9IG5ld0lmcmFtZS5jb250ZW50V2luZG93OyAvL3JlcGxhY2VzIHRoZSBvdXRwdXQgd2luZG93IChvbGQgaWZyYW1lJ3MgY29udGVudFdpbmRvdykgb2YgdGhlIFdpbmRvd0lPU3RyZWFtICh3aXRoaW4gdGhlIElGcmFtZUNvbmR1aXQpIHdpdGggdGhlIG5ldyBpZnJhbWUncyBjb250ZW50V2luZG93LgogICAgICAgICAgY29ubmVjdC5jb3JlLl9zZW5kSWZyYW1lU3R5bGVEYXRhVXBzdHJlYW1BZnRlclJlYXNvbmFibGVXYWl0VGltZShuZXdJZnJhbWUsIGNvbm5lY3QuY29yZS51cHN0cmVhbSk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCdFcnJvciB3aGlsZSBjaGVja2luZyBmb3IsIGFuZCByZWNyZWF0aW5nLCB0aGUgQ0NQIElGcmFtZScpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgICAgY29ubmVjdC5jb3JlLl9yZWZyZXNoSWZyYW1lT25UaW1lb3V0KGluaXRDQ1BQYXJhbXMsIGNvbnRhaW5lckRpdik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCkudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5JRlJBTUVfUkVUUklFU19FWEhBVVNURUQpOwogICAgICAgIGdsb2JhbC5jbGVhclRpbWVvdXQoY29ubmVjdC5jb3JlLmlmcmFtZVJlZnJlc2hUaW1lb3V0KTsKICAgICAgfQogICAgfSwgdGltZW91dCk7CiAgfQoKCiAgY29ubmVjdC5jb3JlLl9nZXRDQ1BJZnJhbWUgPSBmdW5jdGlvbigpIHsKICAgIGZvciAodmFyIGlmcmFtZSBvZiB3aW5kb3cuZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2lmcmFtZScpKSB7CiAgICAgIGlmIChpZnJhbWUubmFtZSA9PT0gQ0NQX0lGUkFNRV9OQU1FKSB7CiAgICAgICAgcmV0dXJuIGlmcmFtZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQoKICBjb25uZWN0LmNvcmUuX2NyZWF0ZUNDUElmcmFtZSA9IGZ1bmN0aW9uKGNvbnRhaW5lckRpdiwgaW5pdENDUFBhcmFtcykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGluaXRDQ1BQYXJhbXMsICdpbml0Q0NQUGFyYW1zJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFpbmVyRGl2LCAnY29udGFpbmVyRGl2Jyk7CiAgICB2YXIgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICBpZnJhbWUuc3JjID0gaW5pdENDUFBhcmFtcy5jY3BVcmw7CiAgICBpZnJhbWUuYWxsb3cgPSAibWljcm9waG9uZTsgYXV0b3BsYXkiOwogICAgaWZyYW1lLnN0eWxlID0gaW5pdENDUFBhcmFtcy5zdHlsZSB8fCAid2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJSI7CiAgICBpZnJhbWUudGl0bGUgPSBpbml0Q0NQUGFyYW1zLmlmcmFtZVRpdGxlIHx8IENDUF9JRlJBTUVfTkFNRTsKICAgIGlmcmFtZS5uYW1lID0gQ0NQX0lGUkFNRV9OQU1FOwogICAgY29udGFpbmVyRGl2LmFwcGVuZENoaWxkKGlmcmFtZSk7CiAgICByZXR1cm4gaWZyYW1lOwogIH0KCiAgY29ubmVjdC5jb3JlLl9zZW5kSWZyYW1lU3R5bGVEYXRhVXBzdHJlYW1BZnRlclJlYXNvbmFibGVXYWl0VGltZSA9IGZ1bmN0aW9uKGlmcmFtZSwgY29uZHVpdCkgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGlmcmFtZSwgJ2lmcmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGNvbmR1aXQsICdjb25kdWl0Jyk7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICB2YXIgc3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShpZnJhbWUsIG51bGwpOwogICAgICB2YXIgZGF0YSA9IHsKICAgICAgICBkaXNwbGF5OiBzdHlsZS5kaXNwbGF5LAogICAgICAgIG9mZnNldFdpZHRoOiBpZnJhbWUub2Zmc2V0V2lkdGgsCiAgICAgICAgb2Zmc2V0SGVpZ2h0OiBpZnJhbWUub2Zmc2V0SGVpZ2h0LAogICAgICAgIGNsaWVudFJlY3RzTGVuZ3RoOiBpZnJhbWUuZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgKICAgICAgfTsKICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuSUZSQU1FX1NUWUxFLCBkYXRhKTsKICAgIH0sIDEwMDAwKTsKICB9CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgdmFyIEtlZXBhbGl2ZU1hbmFnZXIgPSBmdW5jdGlvbiAoY29uZHVpdCwgZXZlbnRCdXMsIHN5blRpbWVvdXQsIGFja1RpbWVvdXQpIHsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICB0aGlzLmV2ZW50QnVzID0gZXZlbnRCdXM7CiAgICB0aGlzLnN5blRpbWVvdXQgPSBzeW5UaW1lb3V0OwogICAgdGhpcy5hY2tUaW1lb3V0ID0gYWNrVGltZW91dDsKICAgIHRoaXMuYWNrVGltZXIgPSBudWxsOwogICAgdGhpcy5zeW5UaW1lciA9IG51bGw7CiAgICB0aGlzLmFja1N1YiA9IG51bGw7CiAgfTsKIAogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogCiAgICB0aGlzLmNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNZTkNIUk9OSVpFKTsKICAgIHRoaXMuYWNrU3ViID0gdGhpcy5jb25kdWl0Lm9uVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQUNLTk9XTEVER0UsIGZ1bmN0aW9uICgpIHsKICAgICAgdGhpcy51bnN1YnNjcmliZSgpOwogICAgICBnbG9iYWwuY2xlYXJUaW1lb3V0KHNlbGYuYWNrVGltZXIpOwogICAgICBzZWxmLl9kZWZlclN0YXJ0KCk7CiAgICB9KTsKICAgIHRoaXMuYWNrVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuYWNrU3ViLnVuc3Vic2NyaWJlKCk7CiAgICAgIHNlbGYuZXZlbnRCdXMudHJpZ2dlcihjb25uZWN0LkV2ZW50VHlwZS5BQ0tfVElNRU9VVCk7CiAgICAgIHNlbGYuX2RlZmVyU3RhcnQoKTsKICAgIH0sIHRoaXMuYWNrVGltZW91dCk7CiAgfTsKIAogIC8vRml4ZXMgdGhlIGtlZXBhbGl2ZW1hbmFnZXIuCiAgS2VlcGFsaXZlTWFuYWdlci5wcm90b3R5cGUuX2RlZmVyU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN5blRpbWVyID0gZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnN0YXJ0KSwgdGhpcy5zeW5UaW1lb3V0KTsKICB9OwoKICAvLyBGb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgb25seSwgaW4gY2FzZSBjdXN0b21lcnMgYXJlIHVzaW5nIHRoaXMgdG8gc3RhcnQgdGhlIGtlZXBhbGl2ZW1hbmFnZXIgZm9yIHNvbWUgcmVhc29uLgogIEtlZXBhbGl2ZU1hbmFnZXIucHJvdG90eXBlLmRlZmVyU3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5zeW5UaW1lciA9PSBudWxsKSB7CiAgICAgIHRoaXMuc3luVGltZXIgPSBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuc3RhcnQpLCB0aGlzLnN5blRpbWVvdXQpOwogICAgfQogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAKICB2YXIgV2ViU29ja2V0UHJvdmlkZXIgPSBmdW5jdGlvbiAoKSB7CiAKICAgIHZhciBjYWxsYmFja3MgPSB7CiAgICAgIGluaXRGYWlsdXJlOiBuZXcgU2V0KCksCiAgICAgIHN1YnNjcmlwdGlvblVwZGF0ZTogbmV3IFNldCgpLAogICAgICBzdWJzY3JpcHRpb25GYWlsdXJlOiBuZXcgU2V0KCksCiAgICAgIHRvcGljOiBuZXcgTWFwKCksCiAgICAgIGFsbE1lc3NhZ2U6IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkdhaW46IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkxvc3Q6IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbk9wZW46IG5ldyBTZXQoKSwKICAgICAgY29ubmVjdGlvbkNsb3NlOiBuZXcgU2V0KCkKICAgIH07CiAKICAgIHZhciBpbnZva2VDYWxsYmFja3MgPSBmdW5jdGlvbiAoY2FsbGJhY2tzLCByZXNwb25zZSkgewogICAgICBjYWxsYmFja3MuZm9yRWFjaChmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayhyZXNwb25zZSk7CiAgICAgIH0pOwogICAgfTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUsIGZ1bmN0aW9uICgpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5pbml0RmFpbHVyZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fT1BFTiwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4sIHJlc3BvbnNlKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9DTE9TRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLCByZXNwb25zZSk7CiAgICB9KTsKCiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fR0FJTiwgZnVuY3Rpb24gKCkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluKTsKICAgIH0pOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9MT1NULCBmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy5jb25uZWN0aW9uTG9zdCwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX1VQREFURSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLCByZXNwb25zZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5TVUJTQ1JJUFRJT05fRkFJTFVSRSwgZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIGludm9rZUNhbGxiYWNrcyhjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZSwgcmVzcG9uc2UpOwogICAgfSk7CiAKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQUxMX01FU1NBR0UsIGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICBpbnZva2VDYWxsYmFja3MoY2FsbGJhY2tzLmFsbE1lc3NhZ2UsIHJlc3BvbnNlKTsKICAgICAgaWYgKGNhbGxiYWNrcy50b3BpYy5oYXMocmVzcG9uc2UudG9waWMpKSB7CiAgICAgICAgaW52b2tlQ2FsbGJhY2tzKGNhbGxiYWNrcy50b3BpYy5nZXQocmVzcG9uc2UudG9waWMpLCByZXNwb25zZSk7CiAgICAgIH0KICAgIH0pOwogCiAgICB0aGlzLnNlbmRNZXNzYWdlID0gZnVuY3Rpb24gKHdlYlNvY2tldFBheWxvYWQpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNFTkQsIHdlYlNvY2tldFBheWxvYWQpOwogICAgfTsKIAogICAgdGhpcy5vbkluaXRGYWlsdXJlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuaW5pdEZhaWx1cmUuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmluaXRGYWlsdXJlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uT3BlbiA9IGZ1bmN0aW9uKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbk9wZW4uYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25PcGVuLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uQ2xvc2UgPSBmdW5jdGlvbihjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25DbG9zZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3MuY29ubmVjdGlvbkNsb3NlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwoKICAgIHRoaXMub25Db25uZWN0aW9uR2FpbiA9IGZ1bmN0aW9uIChjYikgewogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGNiKSwgJ21ldGhvZCBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgY2FsbGJhY2tzLmNvbm5lY3Rpb25HYWluLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5jb25uZWN0aW9uR2Fpbi5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vbkNvbm5lY3Rpb25Mb3N0ID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3MuY29ubmVjdGlvbkxvc3QuYWRkKGNiKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gY2FsbGJhY2tzLmNvbm5lY3Rpb25Mb3N0LmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgICB0aGlzLm9uU3Vic2NyaXB0aW9uVXBkYXRlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3Muc3Vic2NyaXB0aW9uVXBkYXRlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5zdWJzY3JpcHRpb25VcGRhdGUuZGVsZXRlKGNiKTsKICAgICAgfTsKICAgIH07CiAKICAgIHRoaXMub25TdWJzY3JpcHRpb25GYWlsdXJlID0gZnVuY3Rpb24gKGNiKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZS5hZGQoY2IpOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBjYWxsYmFja3Muc3Vic2NyaXB0aW9uRmFpbHVyZS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5zdWJzY3JpYmVUb3BpY3MgPSBmdW5jdGlvbiAodG9waWNzKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpY3MsICd0b3BpY3MnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNBcnJheSh0b3BpY3MpLCAndG9waWNzIG11c3QgYmUgYSBhcnJheScpOwogICAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSUJFLCB0b3BpY3MpOwogICAgfTsKIAogICAgdGhpcy5vbk1lc3NhZ2UgPSBmdW5jdGlvbiAodG9waWNOYW1lLCBjYikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9waWNOYW1lLCAndG9waWNOYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oY2IpLCAnbWV0aG9kIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICBpZiAoY2FsbGJhY2tzLnRvcGljLmhhcyh0b3BpY05hbWUpKSB7CiAgICAgICAgY2FsbGJhY2tzLnRvcGljLmdldCh0b3BpY05hbWUpLmFkZChjYik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLnRvcGljLnNldCh0b3BpY05hbWUsIG5ldyBTZXQoW2NiXSkpOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy50b3BpYy5nZXQodG9waWNOYW1lKS5kZWxldGUoY2IpOwogICAgICB9OwogICAgfTsKIAogICAgdGhpcy5vbkFsbE1lc3NhZ2UgPSBmdW5jdGlvbiAoY2IpIHsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjYiksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIGNhbGxiYWNrcy5hbGxNZXNzYWdlLmFkZChjYik7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrcy5hbGxNZXNzYWdlLmRlbGV0ZShjYik7CiAgICAgIH07CiAgICB9OwogCiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICB2YXIgQWdlbnREYXRhUHJvdmlkZXIgPSBmdW5jdGlvbiAoYnVzKSB7CiAgICB2YXIgYWdlbnREYXRhID0gbnVsbDsKICAgIHRoaXMuYnVzID0gYnVzOwogICAgdGhpcy5idXMuc3Vic2NyaWJlKGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLCBjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMudXBkYXRlQWdlbnREYXRhKSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS51cGRhdGVBZ2VudERhdGEgPSBmdW5jdGlvbiAoYWdlbnREYXRhKSB7CiAgICB2YXIgb2xkQWdlbnREYXRhID0gdGhpcy5hZ2VudERhdGE7CiAgICB0aGlzLmFnZW50RGF0YSA9IGFnZW50RGF0YTsKIAogICAgaWYgKG9sZEFnZW50RGF0YSA9PSBudWxsKSB7CiAgICAgIGNvbm5lY3QuYWdlbnQuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICB0aGlzLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQWdlbnRFdmVudHMuSU5JVCwgbmV3IGNvbm5lY3QuQWdlbnQoKSk7CiAgICB9CiAKICAgIHRoaXMuYnVzLnRyaWdnZXIoY29ubmVjdC5BZ2VudEV2ZW50cy5SRUZSRVNILCBuZXcgY29ubmVjdC5BZ2VudCgpKTsKIAogICAgdGhpcy5fZmlyZUFnZW50VXBkYXRlRXZlbnRzKG9sZEFnZW50RGF0YSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRBZ2VudERhdGEgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5hZ2VudERhdGEgPT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdObyBhZ2VudCBkYXRhIGlzIGF2YWlsYWJsZSB5ZXQhJyk7CiAgICB9CiAKICAgIHJldHVybiB0aGlzLmFnZW50RGF0YTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldENvbnRhY3REYXRhID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgdmFyIGFnZW50RGF0YSA9IHRoaXMuZ2V0QWdlbnREYXRhKCk7CiAgICB2YXIgY29udGFjdERhdGEgPSBjb25uZWN0LmZpbmQoYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY3RkYXRhKSB7CiAgICAgIHJldHVybiBjdGRhdGEuY29udGFjdElkID09PSBjb250YWN0SWQ7CiAgICB9KTsKIAogICAgaWYgKGNvbnRhY3REYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignQ29udGFjdCAlcyBubyBsb25nZXIgZXhpc3RzLicsIGNvbnRhY3RJZCk7CiAgICB9CiAKICAgIHJldHVybiBjb250YWN0RGF0YTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldENvbm5lY3Rpb25EYXRhID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgY29ubmVjdGlvbklkKSB7CiAgICB2YXIgY29udGFjdERhdGEgPSB0aGlzLmdldENvbnRhY3REYXRhKGNvbnRhY3RJZCk7CiAgICB2YXIgY29ubmVjdGlvbkRhdGEgPSBjb25uZWN0LmZpbmQoY29udGFjdERhdGEuY29ubmVjdGlvbnMsIGZ1bmN0aW9uIChjZGF0YSkgewogICAgICByZXR1cm4gY2RhdGEuY29ubmVjdGlvbklkID09PSBjb25uZWN0aW9uSWQ7CiAgICB9KTsKIAogICAgaWYgKGNvbm5lY3Rpb25EYXRhID09IG51bGwpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignQ29ubmVjdGlvbiAlcyBmb3IgY29udGFjdCAlcyBubyBsb25nZXIgZXhpc3RzLicsIGNvbm5lY3Rpb25JZCwgY29udGFjdElkKTsKICAgIH0KIAogICAgcmV0dXJuIGNvbm5lY3Rpb25EYXRhOwogIH07CgogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5nZXRJbnN0YW5jZUlkID0gZnVuY3Rpb24oKXsKICAgIHJldHVybiB0aGlzLmdldEFnZW50RGF0YSgpLmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZC5tYXRjaCgvaW5zdGFuY2VcLyhbMC05YS1mQS1GfC1dKylcLy8pWzFdOwogIH0KCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLmdldEFXU0FjY291bnRJZCA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gdGhpcy5nZXRBZ2VudERhdGEoKS5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlSWQubWF0Y2goLzooWzAtOV0rKTppbnN0YW5jZS8pWzFdOwogIH0KIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fZGlmZkNvbnRhY3RzID0gZnVuY3Rpb24gKG9sZEFnZW50RGF0YSkgewogICAgdmFyIGRpZmYgPSB7CiAgICAgIGFkZGVkOiB7fSwKICAgICAgcmVtb3ZlZDoge30sCiAgICAgIGNvbW1vbjoge30sCiAgICAgIG9sZE1hcDogY29ubmVjdC5pbmRleChvbGRBZ2VudERhdGEgPT0gbnVsbCA/IFtdIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pLAogICAgICBuZXdNYXA6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSkKICAgIH07CiAKICAgIGNvbm5lY3Qua2V5cyhkaWZmLm9sZE1hcCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdElkKSB7CiAgICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKGRpZmYubmV3TWFwLCBjb250YWN0SWQpKSB7CiAgICAgICAgZGlmZi5jb21tb25bY29udGFjdElkXSA9IGRpZmYubmV3TWFwW2NvbnRhY3RJZF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGlmZi5yZW1vdmVkW2NvbnRhY3RJZF0gPSBkaWZmLm9sZE1hcFtjb250YWN0SWRdOwogICAgICB9CiAgICB9KTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYubmV3TWFwKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgaWYgKCFjb25uZWN0LmNvbnRhaW5zKGRpZmYub2xkTWFwLCBjb250YWN0SWQpKSB7CiAgICAgICAgZGlmZi5hZGRlZFtjb250YWN0SWRdID0gZGlmZi5uZXdNYXBbY29udGFjdElkXTsKICAgICAgfQogICAgfSk7CiAKICAgIHJldHVybiBkaWZmOwogIH07CiAKICBBZ2VudERhdGFQcm92aWRlci5wcm90b3R5cGUuX2ZpcmVBZ2VudFVwZGF0ZUV2ZW50cyA9IGZ1bmN0aW9uIChvbGRBZ2VudERhdGEpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBkaWZmID0gbnVsbDsKICAgIHZhciBvbGRBZ2VudFN0YXRlID0gb2xkQWdlbnREYXRhID09IG51bGwgPyBjb25uZWN0LkFnZW50QXZhaWxTdGF0ZXMuSU5JVCA6IG9sZEFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS5uYW1lOwogICAgdmFyIG5ld0FnZW50U3RhdGUgPSB0aGlzLmFnZW50RGF0YS5zbmFwc2hvdC5zdGF0ZS5uYW1lOwogICAgdmFyIG9sZFJvdXRpbmdTdGF0ZSA9IG9sZEFnZW50RGF0YSA9PSBudWxsID8gY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5JTklUIDogb2xkQWdlbnREYXRhLnNuYXBzaG90LnN0YXRlLnR5cGU7CiAgICB2YXIgbmV3Um91dGluZ1N0YXRlID0gdGhpcy5hZ2VudERhdGEuc25hcHNob3Quc3RhdGUudHlwZTsKIAogICAgaWYgKG9sZFJvdXRpbmdTdGF0ZSAhPT0gbmV3Um91dGluZ1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRBZ2VudFJvdXRpbmdFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZFJvdXRpbmdTdGF0ZSwgbmV3Um91dGluZ1N0YXRlKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoZXZlbnQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgICB9KTsKICAgIH0KIAogICAgaWYgKG9sZEFnZW50U3RhdGUgIT09IG5ld0FnZW50U3RhdGUpIHsKICAgICAgdGhpcy5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLlNUQVRFX0NIQU5HRSwgewogICAgICAgIGFnZW50OiBuZXcgY29ubmVjdC5BZ2VudCgpLAogICAgICAgIG9sZFN0YXRlOiBvbGRBZ2VudFN0YXRlLAogICAgICAgIG5ld1N0YXRlOiBuZXdBZ2VudFN0YXRlCiAKICAgICAgfSk7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRBZ2VudFN0YXRlRXZlbnRHcmFwaCgpLmdldEFzc29jaWF0aW9ucyh0aGlzLCBvbGRBZ2VudFN0YXRlLCBuZXdBZ2VudFN0YXRlKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoZXZlbnQsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgICB9KTsKICAgIH0KCiAgICB2YXIgb2xkTmV4dFN0YXRlID0gb2xkQWdlbnREYXRhICYmIG9sZEFnZW50RGF0YS5zbmFwc2hvdC5uZXh0U3RhdGUgPyBvbGRBZ2VudERhdGEuc25hcHNob3QubmV4dFN0YXRlLm5hbWUgOiBudWxsOwogICAgdmFyIG5ld05leHRTdGF0ZSA9IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZSA/IHRoaXMuYWdlbnREYXRhLnNuYXBzaG90Lm5leHRTdGF0ZS5uYW1lIDogbnVsbDsKICAgIGlmIChvbGROZXh0U3RhdGUgIT09IG5ld05leHRTdGF0ZSAmJiBuZXdOZXh0U3RhdGUpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkFnZW50RXZlbnRzLkVOUVVFVUVEX05FWFRfU1RBVEUsIG5ldyBjb25uZWN0LkFnZW50KCkpOwogICAgfQoKICAgIGlmIChvbGRBZ2VudERhdGEgIT09IG51bGwpIHsKICAgICAgZGlmZiA9IHRoaXMuX2RpZmZDb250YWN0cyhvbGRBZ2VudERhdGEpOwogCiAgICB9IGVsc2UgewogICAgICBkaWZmID0gewogICAgICAgIGFkZGVkOiBjb25uZWN0LmluZGV4KHRoaXMuYWdlbnREYXRhLnNuYXBzaG90LmNvbnRhY3RzLCBmdW5jdGlvbiAoY29udGFjdCkgeyByZXR1cm4gY29udGFjdC5jb250YWN0SWQ7IH0pLAogICAgICAgIHJlbW92ZWQ6IHt9LAogICAgICAgIGNvbW1vbjoge30sCiAgICAgICAgb2xkTWFwOiB7fSwKICAgICAgICBuZXdNYXA6IGNvbm5lY3QuaW5kZXgodGhpcy5hZ2VudERhdGEuc25hcHNob3QuY29udGFjdHMsIGZ1bmN0aW9uIChjb250YWN0KSB7IHJldHVybiBjb250YWN0LmNvbnRhY3RJZDsgfSkKICAgICAgfTsKICAgIH0KIAogICAgY29ubmVjdC52YWx1ZXMoZGlmZi5hZGRlZCkuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdERhdGEpIHsKICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuSU5JVCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0RGF0YS5jb250YWN0SWQpKTsKICAgICAgc2VsZi5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMoY29udGFjdERhdGEuY29udGFjdElkLCBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5JVCwgY29udGFjdERhdGEuc3RhdGUudHlwZSk7CiAgICB9KTsKIAogICAgY29ubmVjdC52YWx1ZXMoZGlmZi5yZW1vdmVkKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0RGF0YSkgewogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQsIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdChjb250YWN0RGF0YSkpOwogICAgICBzZWxmLmJ1cy50cmlnZ2VyKGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lKGNvbm5lY3QuQ29udGFjdEV2ZW50cy5ERVNUUk9ZRUQsIGNvbnRhY3REYXRhLmNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3RTbmFwc2hvdChjb250YWN0RGF0YSkpOwogICAgICBzZWxmLl91bnN1YkFsbENvbnRhY3RFdmVudHNGb3JDb250YWN0KGNvbnRhY3REYXRhLmNvbnRhY3RJZCk7CiAgICB9KTsKIAogICAgY29ubmVjdC5rZXlzKGRpZmYuY29tbW9uKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgICAgc2VsZi5fZmlyZUNvbnRhY3RVcGRhdGVFdmVudHMoY29udGFjdElkLCBkaWZmLm9sZE1hcFtjb250YWN0SWRdLnN0YXRlLnR5cGUsIGRpZmYubmV3TWFwW2NvbnRhY3RJZF0uc3RhdGUudHlwZSk7CiAgICB9KTsKICB9OwogCiAgQWdlbnREYXRhUHJvdmlkZXIucHJvdG90eXBlLl9maXJlQ29udGFjdFVwZGF0ZUV2ZW50cyA9IGZ1bmN0aW9uIChjb250YWN0SWQsIG9sZENvbnRhY3RTdGF0ZSwgbmV3Q29udGFjdFN0YXRlKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAob2xkQ29udGFjdFN0YXRlICE9PSBuZXdDb250YWN0U3RhdGUpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudEdyYXBoKCkuZ2V0QXNzb2NpYXRpb25zKHRoaXMsIG9sZENvbnRhY3RTdGF0ZSwgbmV3Q29udGFjdFN0YXRlKS5mb3JFYWNoKGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHNlbGYuYnVzLnRyaWdnZXIoZXZlbnQsIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgICAgICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShldmVudCwgY29udGFjdElkKSwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgICAgfSk7CiAgICB9CgogICAgc2VsZi5idXMudHJpZ2dlcihjb25uZWN0LkNvbnRhY3RFdmVudHMuUkVGUkVTSCwgbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0SWQpKTsKICAgIHNlbGYuYnVzLnRyaWdnZXIoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoY29ubmVjdC5Db250YWN0RXZlbnRzLlJFRlJFU0gsIGNvbnRhY3RJZCksIG5ldyBjb25uZWN0LkNvbnRhY3QoY29udGFjdElkKSk7CiAgfTsKIAogIEFnZW50RGF0YVByb3ZpZGVyLnByb3RvdHlwZS5fdW5zdWJBbGxDb250YWN0RXZlbnRzRm9yQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0SWQpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGNvbm5lY3QudmFsdWVzKGNvbm5lY3QuQ29udGFjdEV2ZW50cykuZm9yRWFjaChmdW5jdGlvbiAoZXZlbnROYW1lKSB7CiAgICAgIHNlbGYuYnVzLmdldFN1YnNjcmlwdGlvbnMoY29ubmVjdC5jb3JlLmdldENvbnRhY3RFdmVudE5hbWUoZXZlbnROYW1lLCBjb250YWN0SWQpKQogICAgICAgIC5tYXAoZnVuY3Rpb24gKHN1YikgeyBzdWIudW5zdWJzY3JpYmUoKTsgfSk7CiAgICB9KTsKICB9OwogCiAgLyoqIC0tLS0tIG1pbmltYWwgdmlldyBsYXllciBldmVudCBoYW5kbGluZyAqKi8KIAogIGNvbm5lY3QuY29yZS5vblZpZXdDb250YWN0ID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db250YWN0RXZlbnRzLlZJRVcsIGYpOwogIH07CiAKICAvKioKICAgKiBVc2VkIG9mIGFnZW50IGludGVyZmFjZSBjb250cm9sLiAKICAgKiBjb25uZWN0LmNvcmUudmlld0NvbnRhY3QoImNvbnRhY3RJZCIpIC0+ICB0aGlzIGlzIGN1cnJlbnRseSBwcm9ncmFtbWVkIHRvIGdldCB0aGUgY29udGFjdCBpbnRvIHZpZXcuCiAgICovCiAgY29ubmVjdC5jb3JlLnZpZXdDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5Db250YWN0RXZlbnRzLlZJRVcsCiAgICAgIGRhdGE6IHsKICAgICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZAogICAgICB9CiAgICB9KTsKICB9OwoKICAvKiogLS0tLS0gbWluaW1hbCB2aWV3IGxheWVyIGV2ZW50IGhhbmRsaW5nICoqLwogCiAgY29ubmVjdC5jb3JlLm9uQWN0aXZhdGVDaGFubmVsV2l0aFZpZXdUeXBlID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cy5BQ1RJVkFURV9DSEFOTkVMX1dJVEhfVklFV19UWVBFLCBmKTsKICB9OwogCiAgLyoqCiAgICogVXNlZCBvZiBhZ2VudCBpbnRlcmZhY2UgY29udHJvbC4gCiAgICogY29ubmVjdC5jb3JlLmFjdGl2YXRlQ2hhbm5lbFdpdGhWaWV3VHlwZSgpIC0+ICB0aGlzIGlzIGN1cnJlbnRseSBwcm9ncmFtbWVkIHRvIGdldCBlaXRoZXIgdGhlIG51bWJlciBwYWQsIHF1aWNrIGNvbm5lY3RzLCBvciBjcmVhdGUgdGFzayBpbnRvIHZpZXcuCiAgICogdGhlIHZhbGlkIGNvbWJpbmF0aW9ucyBhcmUgKCJjcmVhdGVfdGFzayIsICJ0YXNrIiksICgibnVtYmVyX3BhZCIsICJzb2Z0cGhvbmUiKSwgKCJjcmVhdGVfdGFzayIsICJzb2Z0cGhvbmUiKSwgKCJxdWlja19jb25uZWN0cyIsICJzb2Z0cGhvbmUiKQogICAqIHRoZSBzb2Z0cGhvbmUgd2l0aCBjcmVhdGVfdGFzayBjb21ibyBpcyBhIHNwZWNpYWwgY2FzZSBpbiB0aGUgY2hhbm5lbCB2aWV3IHRvIGFsbG93IGFsbCB0aHJlZSB2aWV3IHR5cGUgYnV0dG9ucyB0byBhcHBlYXIgb24gdGhlIHNvZnRwaG9uZSBzY3JlZW4KICAgKgogICAqIFRoZSAnc291cmNlJyBpcyBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgd2hpY2ggaW5kaWNhdGVzIHRoZSByZXF1ZXN0ZXIuIEZvciBleGFtcGxlLCBpZiBpbnZva2VkIHdpdGggKCJjcmVhdGVfdGFzayIsICJ0YXNrIiwgImFnZW50YXBwIikgd2Ugd291bGQga25vdyBhZ2VudGFwcCByZXF1ZXN0ZWQgb3BlbiB0YXNrIHZpZXcuCiAgICogCiAgICogImNhc2VJZCIgaXMgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHdoaWNoIGlzIHBhc3NlZCB3aGVuIGEgdGFzayBpcyBjcmVhdGVkIGZyb20gYSBLZXN5dG9uZSBjYXNlCiAgICovCiAgIGNvbm5lY3QuY29yZS5hY3RpdmF0ZUNoYW5uZWxXaXRoVmlld1R5cGUgPSBmdW5jdGlvbiAodmlld1R5cGUsIG1lZGlhVHlwZSwgc291cmNlLCBjYXNlSWQpIHsKICAgIGNvbnN0IGRhdGEgPSB7IHZpZXdUeXBlLCBtZWRpYVR5cGUgfTsKICAgIGlmIChzb3VyY2UpIHsKICAgICAgZGF0YS5zb3VyY2UgPSBzb3VyY2U7CiAgICB9CiAgICBpZiAoY2FzZUlkKSB7CiAgICAgIGRhdGEuY2FzZUlkID0gY2FzZUlkOwogICAgfQogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cy5BQ1RJVkFURV9DSEFOTkVMX1dJVEhfVklFV19UWVBFLAogICAgICBkYXRhCiAgICB9KTsKICB9OwoKICAvKioKICAgKiBVc2VkIHRvIHB1Ymxpc2ggJ3Rhc2sgY3JlYXRlZCcgZXZlbnQKICAgKi8KICBjb25uZWN0LmNvcmUudHJpZ2dlclRhc2tDcmVhdGVkID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnVwc3RyZWFtQnVzLnRyaWdnZXIoY29ubmVjdC5UYXNrRXZlbnRzLkNSRUFURUQsIGRhdGEpOwogIH07CgogIC8qKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciB0aGUgY3VzdG9tIGFuZCBlbWJlZGRlZCBDQ1BzIAogICogdG8gaGFuZGxlIHRoZSBhY2Nlc3MgZGVuaWVkIHVzZSBjYXNlLiAKICAqLwogIGNvbm5lY3QuY29yZS5vbkFjY2Vzc0RlbmllZCA9IGZ1bmN0aW9uIChmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDQ0VTU19ERU5JRUQsIGYpOwogIH07CiAKICAvKioKICAqIFRoaXMgd2lsbCBiZSBoZWxwZnVsIGZvciBTQU1MIHVzZSBjYXNlcyB0byBoYW5kbGUgdGhlIGN1c3RvbSBsb2dpbnMuIAogICovCiAgY29ubmVjdC5jb3JlLm9uQXV0aEZhaWwgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIX0ZBSUwsIGYpOwogIH07CgogIGNvbm5lY3QuY29yZS5vbkF1dGhvcml6ZVN1Y2Nlc3MgPSBmdW5jdGlvbiAoZikgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkub25VcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfU1VDQ0VTUywgZik7CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZVN1Y2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgIHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCwgMCk7CiAgfQoKICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhGYWlsID0gZnVuY3Rpb24obG9naW5VcmwsIGF1dGhvcml6ZUVuZHBvaW50LCBhdXRoRmFpbERhdGEpIHsKICAgIGlmIChhdXRoRmFpbERhdGEgJiYgYXV0aEZhaWxEYXRhLmF1dGhvcml6ZSkgewogICAgICBjb25uZWN0LmNvcmUuX2hhbmRsZUF1dGhvcml6ZUZhaWwobG9naW5VcmwpOwogICAgfQogICAgZWxzZSB7CiAgICAgIGNvbm5lY3QuY29yZS5faGFuZGxlQ1RJQXV0aEZhaWwoYXV0aG9yaXplRW5kcG9pbnQpOwogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl9oYW5kbGVBdXRob3JpemVGYWlsID0gZnVuY3Rpb24obG9naW5VcmwpIHsKICAgIGxldCBhdXRoUmV0cnlDb3VudCA9IGNvbm5lY3QuY29yZS5fZ2V0QXV0aFJldHJ5Q291bnQoKQogICAgaWYgKCFjb25uZWN0LmNvcmUuYXV0aG9yaXplVGltZW91dElkKSB7CiAgICAgIGlmIChhdXRoUmV0cnlDb3VudCA8IGNvbm5lY3QuY29yZS5NQVhfQVVUSE9SSVpFX1JFVFJZX0NPVU5UX0ZPUl9TRVNTSU9OKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLl9pbmNyZW1lbnRBdXRoUmV0cnlDb3VudCgpOwogICAgICAgIGxldCByZXRyeURlbGF5ID0gQVdTLnV0aWwuY2FsY3VsYXRlUmV0cnlEZWxheShhdXRoUmV0cnlDb3VudCArIDEgfHwgMCwgeyBiYXNlOiAyMDAwIH0pOwogICAgICAgIGNvbm5lY3QuY29yZS5hdXRob3JpemVUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIGNvbm5lY3QuY29yZS5fcmVkaXJlY3RUb0xvZ2luKGxvZ2luVXJsKTsKICAgICAgICB9LCByZXRyeURlbGF5KTsgLy9XZSBkb24ndCBoYXZlIHRvIGNsZWFyIHRoZSB0aW1lb3V0SWQgYmVjYXVzZSB3ZSBhcmUgcmVkaXJlY3RpbmcgYXdheSBmcm9tIHRoaXMgb3JpZ2luIG9uY2UgdGhlIHRpbWVvdXQgY29tcGxldGVzLgogICAgICB9CiAgICAgIGVsc2UgIHsKICAgICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIldlIGhhdmUgZXhoYXVzdGVkIG91ciBhdXRob3JpemF0aW9uIHJldHJpZXMgZHVlIHRvIDQwMXMgZnJvbSB0aGUgYXV0aG9yaXplIGFwaS4gTm8gbW9yZSByZXRyaWVzIHdpbGwgYmUgYXR0ZW1wdGVkIGluIHRoaXMgc2Vzc2lvbiB1bnRpbCB0aGUgYXV0aG9yaXplIGFwaSByZXR1cm5zIDIwMC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVEKTsKICAgICAgfQogICAgfQogIH0KCiAgY29ubmVjdC5jb3JlLl9yZWRpcmVjdFRvTG9naW4gPSBmdW5jdGlvbihsb2dpblVybCkgewogICAgaWYgKHR5cGVvZihsb2dpblVybCkgPT09ICdzdHJpbmcnKSB7CiAgICAgIGxvY2F0aW9uLmFzc2lnbihsb2dpblVybCk7CiAgICB9IGVsc2UgewogICAgICBsb2NhdGlvbi5yZWxvYWQoKTsKICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5faGFuZGxlQ1RJQXV0aEZhaWwgPSBmdW5jdGlvbihhdXRob3JpemVFbmRwb2ludCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUuY3RpVGltZW91dElkKSB7CiAgICAgIGlmIChjb25uZWN0LmNvcmUuY3RpQXV0aFJldHJ5Q291bnQgPCBjb25uZWN0LmNvcmUuTUFYX0NUSV9BVVRIX1JFVFJZX0NPVU5UKSB7CiAgICAgICAgY29ubmVjdC5jb3JlLmN0aUF1dGhSZXRyeUNvdW50Kys7CiAgICAgICAgbGV0IHJldHJ5RGVsYXkgPSBBV1MudXRpbC5jYWxjdWxhdGVSZXRyeURlbGF5KGNvbm5lY3QuY29yZS5jdGlBdXRoUmV0cnlDb3VudCB8fCAwLCB7IGJhc2U6IDUwMCB9KTsKICAgICAgICBjb25uZWN0LmNvcmUuY3RpVGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplKGF1dGhvcml6ZUVuZHBvaW50KS50aGVuKGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhvcml6ZVN1Y2Nlc3MuYmluZChjb25uZWN0LmNvcmUpKS5jYXRjaChjb25uZWN0LmNvcmUuX3RyaWdnZXJBdXRoRmFpbC5iaW5kKGNvbm5lY3QuY29yZSwge2F1dGhvcml6ZTogdHJ1ZX0pKTsKICAgICAgICAgIGNvbm5lY3QuY29yZS5jdGlUaW1lb3V0SWQgPSBudWxsOwogICAgICAgIH0sIHJldHJ5RGVsYXkpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkud2FybigiV2UgaGF2ZSBleGhhdXN0ZWQgb3VyIGF1dGhvcml6YXRpb24gcmV0cmllcyBkdWUgdG8gNDAxcyBmcm9tIHRoZSBDVEkgc2VydmljZS4gTm8gbW9yZSByZXRyaWVzIHdpbGwgYmUgYXR0ZW1wdGVkIHVudGlsIHRoZSBwYWdlIGlzIHJlZnJlc2hlZC4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQ1RJX0FVVEhPUklaRV9SRVRSSUVTX0VYSEFVU1RFRCk7CiAgICAgIH0KICAgIH0KICB9CgogIGNvbm5lY3QuY29yZS5fdHJpZ2dlckF1dGhvcml6ZVN1Y2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnVwc3RyZWFtQnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQVVUSE9SSVpFX1NVQ0NFU1MpOwogIH0KCiAgY29ubmVjdC5jb3JlLl90cmlnZ2VyQXV0aEZhaWwgPSBmdW5jdGlvbihkYXRhKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS51cHN0cmVhbUJ1cy50cmlnZ2VyKGNvbm5lY3QuRXZlbnRUeXBlLkFVVEhfRkFJTCwgZGF0YSk7CiAgfQoKICBjb25uZWN0LmNvcmUuX2dldEF1dGhSZXRyeUNvdW50ID0gZnVuY3Rpb24oKSB7CiAgICBsZXQgaXRlbSA9IHdpbmRvdy5zZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGNvbm5lY3QuU2Vzc2lvblN0b3JhZ2VLZXlzLkFVVEhPUklaRV9SRVRSWV9DT1VOVCk7CiAgICBpZiAoaXRlbSAhPT0gbnVsbCkgewogICAgICBpZiAoIWlzTmFOKHBhcnNlSW50KGl0ZW0pKSkgewogICAgICAgIHJldHVybiBwYXJzZUludChpdGVtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCJUaGUgc2Vzc2lvbiBzdG9yYWdlIHZhbHVlIGZvciBhdXRoIHJldHJ5IGNvdW50IHdhcyBOYU4iKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5ULCAwKTsKICAgICAgcmV0dXJuIDA7CiAgICB9IAogIH0KCiAgY29ubmVjdC5jb3JlLl9pbmNyZW1lbnRBdXRoUmV0cnlDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgd2luZG93LnNlc3Npb25TdG9yYWdlLnNldEl0ZW0oY29ubmVjdC5TZXNzaW9uU3RvcmFnZUtleXMuQVVUSE9SSVpFX1JFVFJZX0NPVU5ULCAoY29ubmVjdC5jb3JlLl9nZXRBdXRoUmV0cnlDb3VudCgpKzEpLnRvU3RyaW5nKCkpOwogIH0KCiAgY29ubmVjdC5jb3JlLm9uQXV0aG9yaXplUmV0cmllc0V4aGF1c3RlZCA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5BVVRIT1JJWkVfUkVUUklFU19FWEhBVVNURUQsIGYpOwogIH0KCiAgY29ubmVjdC5jb3JlLm9uQ1RJQXV0aG9yaXplUmV0cmllc0V4aGF1c3RlZCA9IGZ1bmN0aW9uKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpLnN1YnNjcmliZShjb25uZWN0LkV2ZW50VHlwZS5DVElfQVVUSE9SSVpFX1JFVFJJRVNfRVhIQVVTVEVELCBmKTsKICB9CiAKICAvKiogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwogCiAgLyoqCiAgICogVXNlZCBmb3IgaGFuZGxpbmcgdGhlIHJ0YyBzZXNzaW9uIHN0YXRzLgogICAqIFVzYWdlCiAgICogY29ubmVjdC5jb3JlLm9uU29mdHBob25lU2Vzc2lvbkluaXQoZnVuY3Rpb24oeyBjb25uZWN0aW9uSWQgfSkgewogICAqICAgICB2YXIgc29mdHBob25lTWFuYWdlciA9IGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVNYW5hZ2VyKCk7CiAgICogICAgIGlmKHNvZnRwaG9uZU1hbmFnZXIpewogICAqICAgICAgICAvLyBhY2Nlc3Mgc2Vzc2lvbgogICAqICAgICAgICB2YXIgc2Vzc2lvbiA9IHNvZnRwaG9uZU1hbmFnZXIuZ2V0U2Vzc2lvbihjb25uZWN0aW9uSWQpOyAKICAgKiAgICAgIH0KICAgKiB9KTsKICAgKi8KIAogIGNvbm5lY3QuY29yZS5vblNvZnRwaG9uZVNlc3Npb25Jbml0ID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLm9uVXBzdHJlYW0oY29ubmVjdC5Db25uZWN0aW9uRXZlbnRzLlNFU1NJT05fSU5JVCwgZik7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUub25Db25maWd1cmUgPSBmdW5jdGlvbihmKSB7CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5vblVwc3RyZWFtKGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5DT05GSUdVUkUsIGYpOwogIH0KCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgY29ubmVjdC5jb3JlLm9uSW5pdGlhbGl6ZWQgPSBmdW5jdGlvbihmKSB7CiAgICB2YXIgYnVzID0gY29ubmVjdC5jb3JlLmdldEV2ZW50QnVzKCk7CiAgICBidXMuc3Vic2NyaWJlKGNvbm5lY3QuRXZlbnRUeXBlLklOSVQsIGYpOwogIH0KCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRDb250YWN0RXZlbnROYW1lID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY29udGFjdElkKSB7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY29udGFjdElkLCAnY29udGFjdElkJyk7CiAgICBpZiAoIWNvbm5lY3QuY29udGFpbnMoY29ubmVjdC52YWx1ZXMoY29ubmVjdC5Db250YWN0RXZlbnRzKSwgZXZlbnROYW1lKSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5WYWx1ZUVycm9yKCclcyBpcyBub3QgYSB2YWxpZCBjb250YWN0IGV2ZW50LicsIGV2ZW50TmFtZSk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5zcHJpbnRmKCclczo6JXMnLCBldmVudE5hbWUsIGNvbnRhY3RJZCk7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmV2ZW50QnVzOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLndlYlNvY2tldFByb3ZpZGVyOwogIH07CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldEFnZW50RGF0YVByb3ZpZGVyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5hZ2VudERhdGFQcm92aWRlcjsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRMb2NhbFRpbWVzdGFtcCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuZ2V0QWdlbnREYXRhUHJvdmlkZXIoKS5nZXRBZ2VudERhdGEoKS5zbmFwc2hvdC5sb2NhbFRpbWVzdGFtcDsKICB9OwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRTa2V3ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5nZXRBZ2VudERhdGFQcm92aWRlcigpLmdldEFnZW50RGF0YSgpLnNuYXBzaG90LnNrZXc7CiAgfTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0QWdlbnRSb3V0aW5nRXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRSb3V0aW5nRXZlbnRHcmFwaDsKICB9OwogIGNvbm5lY3QuY29yZS5hZ2VudFJvdXRpbmdFdmVudEdyYXBoID0gbmV3IGNvbm5lY3QuRXZlbnRHcmFwaCgpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5ST1VUQUJMRSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5ST1VUQUJMRSkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLCBjb25uZWN0LkFnZW50U3RhdGVUeXBlLk5PVF9ST1VUQUJMRSwKICAgICAgY29ubmVjdC5BZ2VudEV2ZW50cy5OT1RfUk9VVEFCTEUpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwgY29ubmVjdC5BZ2VudFN0YXRlVHlwZS5PRkZMSU5FLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLk9GRkxJTkUpOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudFN0YXRlRXZlbnRHcmFwaCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LmNvcmUuYWdlbnRTdGF0ZUV2ZW50R3JhcGg7CiAgfTsKICBjb25uZWN0LmNvcmUuYWdlbnRTdGF0ZUV2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LkFnZW50RXJyb3JTdGF0ZXMpLAogICAgICBjb25uZWN0LkFnZW50RXZlbnRzLkVSUk9SKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksIGNvbm5lY3QuQWdlbnRBdmFpbFN0YXRlcy5BRlRFUl9DQUxMX1dPUkssCiAgICAgIGNvbm5lY3QuQWdlbnRFdmVudHMuQUNXKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50R3JhcGggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmNvbnRhY3RFdmVudEdyYXBoOwogIH07CiAKICBjb25uZWN0LmNvcmUuY29udGFjdEV2ZW50R3JhcGggPSBuZXcgY29ubmVjdC5FdmVudEdyYXBoKCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5DT01JTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5JTkNPTUlORykKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuUEVORElORywKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLlBFTkRJTkcpCiAgICAuYXNzb2MoY29ubmVjdC5FdmVudEdyYXBoLkFOWSwKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNUSU5HKQogICAgLmFzc29jKGNvbm5lY3QuRXZlbnRHcmFwaC5BTlksCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5DT05ORUNURUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5DT05ORUNURUQpCiAgICAuYXNzb2MoY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLkNPTk5FQ1RJTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCkKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuSU5DT01JTkcsCiAgICAgIGNvbm5lY3QuQ29udGFjdFN0YXRlVHlwZS5FUlJPUiwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRU5ERUQsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5BQ1cpCiAgICAuYXNzb2MoY29ubmVjdC52YWx1ZXMoY29ubmVjdC5DT05UQUNUX0FDVElWRV9TVEFURVMpLAogICAgICBjb25uZWN0LnZhbHVlcyhjb25uZWN0LnJlbGF0aXZlQ29tcGxlbWVudChjb25uZWN0LkNPTlRBQ1RfQUNUSVZFX1NUQVRFUywgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlKSksCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FTkRFRCkKICAgIC5hc3NvYyhjb25uZWN0LkV2ZW50R3JhcGguQU5ZLAogICAgICBjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuRVJST1IsCiAgICAgIGNvbm5lY3QuQ29udGFjdEV2ZW50cy5FUlJPUikKICAgIC5hc3NvYyhjb25uZWN0LkNvbnRhY3RTdGF0ZVR5cGUuQ09OTkVDVElORywKICAgICAgY29ubmVjdC5Db250YWN0U3RhdGVUeXBlLk1JU1NFRCwKICAgICAgY29ubmVjdC5Db250YWN0RXZlbnRzLk1JU1NFRCk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0Q2xpZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCFjb25uZWN0LmNvcmUuY2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IGNvcmUgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5jbGllbnQ7CiAgfTsKICBjb25uZWN0LmNvcmUuY2xpZW50ID0gbnVsbDsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRBZ2VudEFwcENsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50KSB7CiAgICAgIHRocm93IG5ldyBjb25uZWN0LlN0YXRlRXJyb3IoJ1RoZSBjb25uZWN0IEFnZW50QXBwIENsaWVudCBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQhJyk7CiAgICB9CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLmFnZW50QXBwQ2xpZW50ID0gbnVsbDsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0VGFza1RlbXBsYXRlc0NsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuU3RhdGVFcnJvcignVGhlIGNvbm5lY3QgVGFza1RlbXBsYXRlcyBDbGllbnQgaGFzIG5vdCBiZWVuIGluaXRpYWxpemVkIScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS50YXNrVGVtcGxhdGVzQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLnRhc2tUZW1wbGF0ZXNDbGllbnQgPSBudWxsOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE1hc3RlckNsaWVudCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGUgY29ubmVjdCBtYXN0ZXIgY2xpZW50IGhhcyBub3QgYmVlbiBpbml0aWFsaXplZCEnKTsKICAgIH0KICAgIHJldHVybiBjb25uZWN0LmNvcmUubWFzdGVyQ2xpZW50OwogIH07CiAgY29ubmVjdC5jb3JlLm1hc3RlckNsaWVudCA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldFNvZnRwaG9uZU1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnNvZnRwaG9uZU1hbmFnZXI7CiAgfTsKICBjb25uZWN0LmNvcmUuc29mdHBob25lTWFuYWdlciA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLmdldE5vdGlmaWNhdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyKSB7CiAgICAgIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyID0gbmV3IGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlcigpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS5ub3RpZmljYXRpb25NYW5hZ2VyOwogIH07CiAgY29ubmVjdC5jb3JlLm5vdGlmaWNhdGlvbk1hbmFnZXIgPSBudWxsOwogCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIGNvbm5lY3QuY29yZS5nZXRQb3B1cE1hbmFnZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5jb3JlLnBvcHVwTWFuYWdlcjsKICB9OwogIGNvbm5lY3QuY29yZS5wb3B1cE1hbmFnZXIgPSBuZXcgY29ubmVjdC5Qb3B1cE1hbmFnZXIoKTsKIAogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIWNvbm5lY3QuY29yZS51cHN0cmVhbSkgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5TdGF0ZUVycm9yKCdUaGVyZSBpcyBubyB1cHN0cmVhbSBjb25kdWl0IScpOwogICAgfQogICAgcmV0dXJuIGNvbm5lY3QuY29yZS51cHN0cmVhbTsKICB9OwogIGNvbm5lY3QuY29yZS51cHN0cmVhbSA9IG51bGw7CiAKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC5jb3JlLkFnZW50RGF0YVByb3ZpZGVyID0gQWdlbnREYXRhUHJvdmlkZXI7CiAKfSkoKTsKCi8qKiovIH0pLAoKLyoqKi8gNTkyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICB2YXIgQUxMX0VWRU5UUyA9ICc8PGFsbD4+JzsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBFdmVudFR5cGUKICAgKi8KICB2YXIgRXZlbnRUeXBlID0gY29ubmVjdC5tYWtlRW51bShbCiAgICAnYWNrbm93bGVkZ2UnLAogICAgJ2Fja190aW1lb3V0JywKICAgICdpbml0JywKICAgICdhcGlfcmVxdWVzdCcsCiAgICAnYXBpX3Jlc3BvbnNlJywKICAgICdhdXRoX2ZhaWwnLAogICAgJ2FjY2Vzc19kZW5pZWQnLAogICAgJ2Nsb3NlJywKICAgICdjb25maWd1cmUnLAogICAgJ2xvZycsCiAgICAnbWFzdGVyX3JlcXVlc3QnLAogICAgJ21hc3Rlcl9yZXNwb25zZScsCiAgICAnc3luY2hyb25pemUnLAogICAgJ3Rlcm1pbmF0ZScsCiAgICAndGVybWluYXRlZCcsCiAgICAnc2VuZF9sb2dzJywKICAgICdyZWxvYWRfYWdlbnRfY29uZmlndXJhdGlvbicsCiAgICAnYnJvYWRjYXN0JywKICAgICdhcGlfbWV0cmljJywKICAgICdjbGllbnRfbWV0cmljJywKICAgICdzb2Z0cGhvbmVfc3RhdHMnLAogICAgJ3NvZnRwaG9uZV9yZXBvcnQnLAogICAgJ2NsaWVudF9zaWRlX2xvZ3MnLAogICAgJ3NlcnZlcl9ib3VuZF9pbnRlcm5hbF9sb2cnLAogICAgJ211dGUnLAogICAgImlmcmFtZV9zdHlsZSIsCiAgICAiaWZyYW1lX3JldHJpZXNfZXhoYXVzdGVkIiwKICAgICJ1cGRhdGVfY29ubmVjdGVkX2NjcHMiLAogICAgIm91dGVyX2NvbnRleHRfaW5mbyIsCiAgICAibWVkaWFfZGV2aWNlX3JlcXVlc3QiLAogICAgIm1lZGlhX2RldmljZV9yZXNwb25zZSIsCiAgICAidGFiX2lkIiwKICAgICdhdXRob3JpemVfc3VjY2VzcycsCiAgICAnYXV0aG9yaXplX3JldHJpZXNfZXhoYXVzdGVkJywKICAgICdjdGlfYXV0aG9yaXplX3JldHJpZXNfZXhoYXVzdGVkJywKICAgICdjbGlja19zdHJlYW1fZGF0YScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBNYXN0ZXJUb3BpY3MKICAgKi8KICB2YXIgTWFzdGVyVG9waWNzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3QnLCBbCiAgICAnbG9naW5Qb3B1cCcsCiAgICAnc2VuZExvZ3MnLAogICAgJ3NvZnRwaG9uZScsCiAgICAncmluZ3RvbmUnLAogICAgJ21ldHJpY3MnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGVudW0gQWdlbnRFdmVudHMKICAgKi8KICB2YXIgQWdlbnRFdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnYWdlbnQnLCBbCiAgICAnaW5pdCcsCiAgICAndXBkYXRlJywKICAgICdyZWZyZXNoJywKICAgICdyb3V0YWJsZScsCiAgICAnbm90X3JvdXRhYmxlJywKICAgICdwZW5kaW5nJywKICAgICdjb250YWN0X3BlbmRpbmcnLAogICAgJ29mZmxpbmUnLAogICAgJ2Vycm9yJywKICAgICdzb2Z0cGhvbmVfZXJyb3InLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2xvc3QnLAogICAgJ3dlYnNvY2tldF9jb25uZWN0aW9uX2dhaW5lZCcsCiAgICAnc3RhdGVfY2hhbmdlJywKICAgICdhY3cnLAogICAgJ211dGVfdG9nZ2xlJywKICAgICdsb2NhbF9tZWRpYV9zdHJlYW1fY3JlYXRlZCcsCiAgICAnZW5xdWV1ZWRfbmV4dF9zdGF0ZScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIFdlYlNvY2tldEV2ZW50cwogICovCiAgdmFyIFdlYlNvY2tldEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd3ZWJTb2NrZXQnLCBbCiAgICAnaW5pdF9mYWlsdXJlJywKICAgICdjb25uZWN0aW9uX29wZW4nLAogICAgJ2Nvbm5lY3Rpb25fY2xvc2UnLAogICAgJ2Nvbm5lY3Rpb25fZXJyb3InLAogICAgJ2Nvbm5lY3Rpb25fZ2FpbicsCiAgICAnY29ubmVjdGlvbl9sb3N0JywKICAgICdzdWJzY3JpcHRpb25fdXBkYXRlJywKICAgICdzdWJzY3JpcHRpb25fZmFpbHVyZScsCiAgICAnYWxsX21lc3NhZ2UnLAogICAgJ3NlbmQnLAogICAgJ3N1YnNjcmliZScKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGVudW0gQ29udGFjdEV2ZW50cwogICAgKi8KICB2YXIgQ29udGFjdEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdjb250YWN0JywgWwogICAgJ2luaXQnLAogICAgJ3JlZnJlc2gnLAogICAgJ2Rlc3Ryb3llZCcsCiAgICAnaW5jb21pbmcnLAogICAgJ3BlbmRpbmcnLAogICAgJ2Nvbm5lY3RpbmcnLAogICAgJ2Nvbm5lY3RlZCcsCiAgICAnbWlzc2VkJywKICAgICdhY3cnLAogICAgJ3ZpZXcnLAogICAgJ2VuZGVkJywKICAgICdlcnJvcicsCiAgICAnYWNjZXB0ZWQnCiAgXSk7CgogIHZhciBDaGFubmVsVmlld0V2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd0YXNrTGlzdCcsIFsKICAgICdhY3RpdmF0ZV9jaGFubmVsX3dpdGhfdmlld190eXBlJwogIF0pOwogIAogIHZhciBUYXNrRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ3Rhc2snLCBbCiAgICAgICdjcmVhdGVkJwogIF0pOwoKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKiBlbnVtIENvbm5lY3Rpb25FdmVudHMKICAqLwogIHZhciBDb25uZWN0aW9uRXZlbnRzID0gY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0oJ2Nvbm5lY3Rpb24nLCBbCiAgICAnc2Vzc2lvbl9pbml0JywKICAgICdyZWFkeV90b19zdGFydF9zZXNzaW9uJwogIF0pOwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBlbnVtIENvbmZpZ3VyYXRpb24gRXZlbnRzCiAgICovCiAgdmFyIENvbmZpZ3VyYXRpb25FdmVudHMgPSBjb25uZWN0Lm1ha2VOYW1lc3BhY2VkRW51bSgnY29uZmlndXJhdGlvbicsIFsKICAgICdjb25maWd1cmUnLAogICAgJ3NldF9zcGVha2VyX2RldmljZScsCiAgICAnc2V0X21pY3JvcGhvbmVfZGV2aWNlJywKICAgICdzZXRfcmluZ2VyX2RldmljZScsCiAgICAnc3BlYWtlcl9kZXZpY2VfY2hhbmdlZCcsCiAgICAnbWljcm9waG9uZV9kZXZpY2VfY2hhbmdlZCcsCiAgICAncmluZ2VyX2RldmljZV9jaGFuZ2VkJwogIF0pOwoKICB2YXIgRGlzYXN0ZXJSZWNvdmVyeUV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCdkaXNhc3RlclJlY292ZXJ5JywgWwogICAgJ3N1cHByZXNzJywKICAgICdmb3JjZV9vZmZsaW5lJywgLy8gbGV0dGluZyB0aGUgc2hhcmVkd29ya2VyIGtub3cgdG8gZm9yY2Ugb2ZmbGluZSAKICAgICdzZXRfb2ZmbGluZScsIC8vIGlmcmFtZSBsZXR0aW5nIHRoZSBuYXRpdmUgY2NwIHRvIHNldCBvZmZsaW5lCiAgICAnaW5pdF9kaXNhc3Rlcl9yZWNvdmVyeScsCiAgICAnZmFpbG92ZXInIC8vIHVzZWQgdG8gcHJvcGFnYXRlIGZhaWxvdmVyIHN0YXRlIHRvIG90aGVyIHdpbmRvd3MKICBdKTsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogZW51bSBWb2ljZUlkIEV2ZW50cwogICAqLwogICB2YXIgVm9pY2VJZEV2ZW50cyA9IGNvbm5lY3QubWFrZU5hbWVzcGFjZWRFbnVtKCd2b2ljZUlkJywgWwogICAgJ3VwZGF0ZV9kb21haW5faWQnCiAgXSk7CgogIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIGNsYXNzIEV2ZW50RmFjdG9yeQogICAqLwogIHZhciBFdmVudEZhY3RvcnkgPSBmdW5jdGlvbiAoKSB7IH07CiAgRXZlbnRGYWN0b3J5LmNyZWF0ZVJlcXVlc3QgPSBmdW5jdGlvbiAodHlwZSwgbWV0aG9kLCBwYXJhbXMpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IGNvbm5lY3QucmFuZG9tSWQoKSwKICAgICAgbWV0aG9kOiBtZXRob2QsCiAgICAgIHBhcmFtczogcGFyYW1zCiAgICB9OwogIH07CgogIEV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZSA9IGZ1bmN0aW9uICh0eXBlLCByZXF1ZXN0LCBkYXRhLCBlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGV2ZW50OiB0eXBlLAogICAgICByZXF1ZXN0SWQ6IHJlcXVlc3QucmVxdWVzdElkLAogICAgICBkYXRhOiBkYXRhLAogICAgICBlcnI6IGVyciB8fCBudWxsCiAgICB9OwogIH07CgogIC8qKgogICAqIEFuIG9iamVjdCByZXByZXNlbnRpbmcgYW4gZXZlbnQgc3Vic2NyaXB0aW9uIGluIGFuIEV2ZW50QnVzLgogICAqLwogIHZhciBTdWJzY3JpcHRpb24gPSBmdW5jdGlvbiAoc3ViTWFwLCBldmVudE5hbWUsIGYpIHsKICAgIHRoaXMuc3ViTWFwID0gc3ViTWFwOwogICAgdGhpcy5pZCA9IGNvbm5lY3QucmFuZG9tSWQoKTsKICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgdGhpcy5mID0gZjsKICB9OwoKICAvKioKICAgKiBVbnN1YnNjcmliZSB0aGUgaGFuZGxlciBvZiB0aGlzIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBFdmVudEJ1cwogICAqIGZyb20gd2hpY2ggaXQgd2FzIGNyZWF0ZWQuCiAgICovCiAgU3Vic2NyaXB0aW9uLnByb3RvdHlwZS51bnN1YnNjcmliZSA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuc3ViTWFwLnVuc3Vic2NyaWJlKHRoaXMuZXZlbnROYW1lLCB0aGlzLmlkKTsKICB9OwoKICAvKioKICAgKiBBIG1hcCBvZiBldmVudCBzdWJzY3JpcHRpb25zLCB1c2VkIGJ5IHRoZSBFdmVudEJ1cy4KICAgKi8KICB2YXIgU3Vic2NyaXB0aW9uTWFwID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5zdWJJZE1hcCA9IHt9OwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXAgPSB7fTsKICB9OwoKICAvKioKICAgKiBBZGQgYSBzdWJzY3JpcHRpb24gZm9yIHRoZSBuYW1lZCBldmVudC4gIENyZWF0ZXMgYSBuZXcgU3Vic2NyaXB0aW9uCiAgICogb2JqZWN0IGFuZCByZXR1cm5zIGl0LiAgVGhpcyBvYmplY3QgY2FuIGJlIHVzZWQgdG8gdW5zdWJzY3JpYmUuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBmKSB7CiAgICB2YXIgc3ViID0gbmV3IFN1YnNjcmlwdGlvbih0aGlzLCBldmVudE5hbWUsIGYpOwoKICAgIHRoaXMuc3ViSWRNYXBbc3ViLmlkXSA9IHN1YjsKICAgIHZhciBzdWJMaXN0ID0gdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSB8fCBbXTsKICAgIHN1Ykxpc3QucHVzaChzdWIpOwogICAgdGhpcy5zdWJFdmVudE5hbWVNYXBbZXZlbnROYW1lXSA9IHN1Ykxpc3Q7CiAgICByZXR1cm4gc3ViOwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGEgc3Vic2NyaXB0aW9uIG1hdGNoaW5nIHRoZSBnaXZlbiBldmVudCBuYW1lIGFuZCBpZC4KICAgKi8KICBTdWJzY3JpcHRpb25NYXAucHJvdG90eXBlLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgc3ViSWQpIHsKICAgIGlmIChjb25uZWN0LmNvbnRhaW5zKHRoaXMuc3ViRXZlbnROYW1lTWFwLCBldmVudE5hbWUpKSB7CiAgICAgIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gPSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdLmZpbHRlcihmdW5jdGlvbiAocykgeyByZXR1cm4gcy5pZCAhPT0gc3ViSWQ7IH0pOwoKICAgICAgaWYgKHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0ubGVuZ3RoIDwgMSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnN1YkV2ZW50TmFtZU1hcFtldmVudE5hbWVdOwogICAgICB9CiAgICB9CgogICAgaWYgKGNvbm5lY3QuY29udGFpbnModGhpcy5zdWJJZE1hcCwgc3ViSWQpKSB7CiAgICAgIGRlbGV0ZSB0aGlzLnN1YklkTWFwW3N1YklkXTsKICAgIH0KICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIGFsbCBzdWJzY3JpcHRpb25zIGluIHRoZSBzdWJzY3JpcHRpb24gbWFwLgogICAqLwogIFN1YnNjcmlwdGlvbk1hcC5wcm90b3R5cGUuZ2V0QWxsU3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnZhbHVlcyh0aGlzLnN1YkV2ZW50TmFtZU1hcCkucmVkdWNlKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHJldHVybiBhLmNvbmNhdChiKTsKICAgIH0sIFtdKTsKICB9OwoKICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHN1YnNjcmlwdGlvbnMgZm9yIHRoZSBnaXZlbiBldmVudCBuYW1lLCBvciBhbiBlbXB0eQogICAqIGxpc3QgaWYgdGhlcmUgYXJlIG5vIHN1YnNjcmlwdGlvbnMuCiAgICovCiAgU3Vic2NyaXB0aW9uTWFwLnByb3RvdHlwZS5nZXRTdWJzY3JpcHRpb25zID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgewogICAgcmV0dXJuIHRoaXMuc3ViRXZlbnROYW1lTWFwW2V2ZW50TmFtZV0gfHwgW107CiAgfTsKCiAgLyoqCiAgICogQW4gb2JqZWN0IHdoaWNoIG1haW50YWlucyBhIG1hcCBvZiBzdWJzY3JpcHRpb25zIGFuZCBzZXJ2ZXMgYXMgdGhlCiAgICogbWVjaGFuaXNtIGZvciB0cmlnZ2VyaW5nIGV2ZW50cyB0byBiZSBoYW5kbGVkIGJ5IHN1YnNjcmliZXJzLgogICAqLwogIHZhciBFdmVudEJ1cyA9IGZ1bmN0aW9uIChwYXJhbXNJbikgewogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwoKICAgIHRoaXMuc3ViTWFwID0gbmV3IFN1YnNjcmlwdGlvbk1hcCgpOwogICAgdGhpcy5sb2dFdmVudHMgPSBwYXJhbXMubG9nRXZlbnRzIHx8IGZhbHNlOwogIH07CgogIC8qKgogICAqIFN1YnNjcmliZSB0byB0aGUgbmFtZWQgZXZlbnQuICBSZXR1cm5zIGEgbmV3IFN1YnNjcmlwdGlvbiBvYmplY3QKICAgKiB3aGljaCBjYW4gYmUgdXNlZCB0byB1bnN1YnNjcmliZS4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZikgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICB9OwoKICAvKioKICAgKiBTdWJzY3JpYmUgYSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgb24gYWxsIGV2ZW50cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuc3Vic2NyaWJlQWxsID0gZnVuY3Rpb24gKGYpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICByZXR1cm4gdGhpcy5zdWJNYXAuc3Vic2NyaWJlKEFMTF9FVkVOVFMsIGYpOwogIH07CgogIC8qKgogICAqIEdldCBhIGxpc3Qgb2Ygc3Vic2NyaXB0aW9ucyBmb3IgdGhlIGdpdmVuIGV2ZW50IG5hbWUsIG9yIGFuIGVtcHR5CiAgICogbGlzdCBpZiB0aGVyZSBhcmUgbm8gc3Vic2NyaXB0aW9ucy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUuZ2V0U3Vic2NyaXB0aW9ucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHsKICAgIHJldHVybiB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKGV2ZW50TmFtZSk7CiAgfTsKCiAgLyoqCiAgICogVHJpZ2dlciB0aGUgZ2l2ZW4gZXZlbnQgd2l0aCB0aGUgZ2l2ZW4gZGF0YS4gIEFsbCBtZXRob2RzIHN1YnNjcmliZWQKICAgKiB0byB0aGlzIGV2ZW50IHdpbGwgYmUgY2FsbGVkIGFuZCBhcmUgcHJvdmlkZWQgd2l0aCB0aGUgZ2l2ZW4gYXJiaXRyYXJ5CiAgICogZGF0YSBvYmplY3QgYW5kIHRoZSBuYW1lIG9mIHRoZSBldmVudCwgaW4gdGhhdCBvcmRlci4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudHJpZ2dlciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGRhdGEpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChldmVudE5hbWUsICdldmVudE5hbWUnKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBhbGxFdmVudFN1YnMgPSB0aGlzLnN1Yk1hcC5nZXRTdWJzY3JpcHRpb25zKEFMTF9FVkVOVFMpOwogICAgdmFyIGV2ZW50U3VicyA9IHRoaXMuc3ViTWFwLmdldFN1YnNjcmlwdGlvbnMoZXZlbnROYW1lKTsKCiAgICBpZiAodGhpcy5sb2dFdmVudHMgJiYKICAgICAgICBldmVudE5hbWUgIT09IGNvbm5lY3QuRXZlbnRUeXBlLkxPRyAmJgogICAgICAgIGV2ZW50TmFtZSAhPT0gY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5BUElfTUVUUklDICYmCiAgICAgICAgZXZlbnROYW1lICE9PSBjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HCiAgICApIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiUHVibGlzaGluZyBldmVudDogJXMiLCBldmVudE5hbWUpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CgogICAgaWYgKAogICAgICBldmVudE5hbWUuc3RhcnRzV2l0aChjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQpICYmCiAgICAgIGRhdGEgJiYKICAgICAgZGF0YS5jb250YWN0SWQgJiYKICAgICAgIShkYXRhIGluc3RhbmNlb2YgY29ubmVjdC5Db250YWN0KQogICAgKSB7CiAgICAgIGRhdGEgPSBuZXcgY29ubmVjdC5Db250YWN0KGRhdGEuY29udGFjdElkKTsKICAgIH0KCiAgICBhbGxFdmVudFN1YnMuY29uY2F0KGV2ZW50U3VicykuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc3ViLmYoZGF0YSB8fCBudWxsLCBldmVudE5hbWUsIHNlbGYpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiJyVzJyBldmVudCBoYW5kbGVyIGZhaWxlZC4iLCBldmVudE5hbWUpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggYnJpZGdlcyBhbiBldmVudCBmcm9tIGFub3RoZXIgRXZlbnRCdXMgdG8gdGhpcyBidXMuCiAgICoKICAgKiBVc2FnZToKICAgKiBjb25kdWl0Lm9uVXBzdHJlYW0oIk15RXZlbnQiLCBidXMuYnJpZGdlKCkpOwogICAqLwogIEV2ZW50QnVzLnByb3RvdHlwZS5icmlkZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gZnVuY3Rpb24gKGRhdGEsIGV2ZW50KSB7CiAgICAgIHNlbGYudHJpZ2dlcihldmVudCwgZGF0YSk7CiAgICB9OwogIH07CgogIC8qKgogICAqIFVuc3Vic2NyaWJlIGFsbCBldmVudHMgaW4gdGhlIGV2ZW50IGJ1cy4KICAgKi8KICBFdmVudEJ1cy5wcm90b3R5cGUudW5zdWJzY3JpYmVBbGwgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnN1Yk1hcC5nZXRBbGxTdWJzY3JpcHRpb25zKCkuZm9yRWFjaChmdW5jdGlvbiAoc3ViKSB7CiAgICAgIHN1Yi51bnN1YnNjcmliZSgpOwogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5FdmVudEJ1cyA9IEV2ZW50QnVzOwogIGNvbm5lY3QuRXZlbnRGYWN0b3J5ID0gRXZlbnRGYWN0b3J5OwogIGNvbm5lY3QuRXZlbnRUeXBlID0gRXZlbnRUeXBlOwogIGNvbm5lY3QuQWdlbnRFdmVudHMgPSBBZ2VudEV2ZW50czsKICBjb25uZWN0LkNvbmZpZ3VyYXRpb25FdmVudHMgPSBDb25maWd1cmF0aW9uRXZlbnRzOwogIGNvbm5lY3QuQ29ubmVjdGlvbkV2ZW50cyA9IENvbm5lY3Rpb25FdmVudHM7CiAgY29ubmVjdC5Db25ubmVjdGlvbkV2ZW50cyA9IENvbm5lY3Rpb25FdmVudHM7IC8vZGVwcmVjYXRlIG9uIG5leHQgbWFqb3IgdmVyc2lvbiByZWxlYXNlLgogIGNvbm5lY3QuQ29udGFjdEV2ZW50cyA9IENvbnRhY3RFdmVudHM7CiAgY29ubmVjdC5DaGFubmVsVmlld0V2ZW50cyA9IENoYW5uZWxWaWV3RXZlbnRzOwogIGNvbm5lY3QuVGFza0V2ZW50cyA9IFRhc2tFdmVudHM7CiAgY29ubmVjdC5Wb2ljZUlkRXZlbnRzID0gVm9pY2VJZEV2ZW50czsKICBjb25uZWN0LldlYlNvY2tldEV2ZW50cyA9IFdlYlNvY2tldEV2ZW50czsKICBjb25uZWN0Lk1hc3RlclRvcGljcyA9IE1hc3RlclRvcGljczsKICBjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMgPSBEaXNhc3RlclJlY292ZXJ5RXZlbnRzOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMjg2OgovKioqLyAoKCkgPT4gewoKIWZ1bmN0aW9uKGUpe3ZhciBuPXt9O2Z1bmN0aW9uIHQobyl7aWYobltvXSlyZXR1cm4gbltvXS5leHBvcnRzO3ZhciByPW5bb109e2k6byxsOiExLGV4cG9ydHM6e319O3JldHVybiBlW29dLmNhbGwoci5leHBvcnRzLHIsci5leHBvcnRzLHQpLHIubD0hMCxyLmV4cG9ydHN9dC5tPWUsdC5jPW4sdC5kPWZ1bmN0aW9uKGUsbixvKXt0Lm8oZSxuKXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsbix7ZW51bWVyYWJsZTohMCxnZXQ6b30pfSx0LnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sdC50PWZ1bmN0aW9uKGUsbil7aWYoMSZuJiYoZT10KGUpKSw4Jm4pcmV0dXJuIGU7aWYoNCZuJiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbz1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHQucihvKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobywiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImbiYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgciBpbiBlKXQuZChvLHIsZnVuY3Rpb24obil7cmV0dXJuIGVbbl19LmJpbmQobnVsbCxyKSk7cmV0dXJuIG99LHQubj1mdW5jdGlvbihlKXt2YXIgbj1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gdC5kKG4sImEiLG4pLG59LHQubz1mdW5jdGlvbihlLG4pe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSxuKX0sdC5wPSIiLHQodC5zPTIpfShbZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt2YXIgbz10KDEpLHI9Ik5VTEwiLGk9IkNMSUVOVF9MT0dHRVIiLGM9IkRFQlVHIixhPTJlMyxzPSJBTVpfV0VCX1NPQ0tFVF9NQU5BR0VSOiIsdT0iTmV0d29yayBvZmZsaW5lIixsPSJOZXR3b3JrIG9ubGluZSwgY29ubmVjdGluZyB0byBXZWJTb2NrZXQgc2VydmVyIixmPSJOZXR3b3JrIG9mZmxpbmUsIGlnbm9yaW5nIHRoaXMgZ2V0V2ViU29ja2V0Q29ubkNvbmZpZyByZXF1ZXN0IixkPSJIZWFydGJlYXQgcmVzcG9uc2Ugbm90IHJlY2VpdmVkIixwPSJIZWFydGJlYXQgcmVzcG9uc2UgcmVjZWl2ZWQiLGc9IlNlbmRpbmcgaGVhcnRiZWF0IixiPSJGYWlsZWQgdG8gc2VuZCBoZWFydGJlYXQgc2luY2UgV2ViU29ja2V0IGlzIG5vdCBvcGVuIix5PSJXZWJTb2NrZXQgY29ubmVjdGlvbiBlc3RhYmxpc2hlZCEiLG09IldlYlNvY2tldCBjb25uZWN0aW9uIGlzIGNsb3NlZCIsdj0iV2ViU29ja2V0TWFuYWdlciBFcnJvciwgZXJyb3JfZXZlbnQ6ICIsUz0iU2NoZWR1bGluZyBXZWJTb2NrZXQgcmVpbml0aWFsaXphdGlvbiwgYWZ0ZXIgZGVsYXkgIixoPSJXZWJTb2NrZXQgVVJMIGNhbm5vdCBiZSB1c2VkIHRvIGVzdGFibGlzaCBjb25uZWN0aW9uIixrPSJXZWJTb2NrZXQgSW5pdGlhbGl6YXRpb24gZmFpbGVkIC0gVGVybWluYXRpbmcgYW5kIGNsZWFuaW5nIHN1YnNjcmlwdGlvbnMiLHc9IlRlcm1pbmF0aW5nIFdlYlNvY2tldCBNYW5hZ2VyIixDPSJGZXRjaGluZyBuZXcgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsTD0iU3VjY2Vzc2Z1bGx5IGZldGNoZWQgd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbiIsVD0iRmFpbGVkIHRvIGZldGNoIHdlYlNvY2tldCBjb25uZWN0aW9uIGNvbmZpZ3VyYXRpb24iLE89IlJldHJ5aW5nIGZldGNoaW5nIG5ldyBXZWJTb2NrZXQgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uIixXPSJJbml0aWFsaXppbmcgV2Vic29ja2V0IE1hbmFnZXIiLEk9IkluaXRpYWxpemluZyBXZWJzb2NrZXQgTWFuYWdlciBGYWlsZWQhIixOPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBvcGVuIixfPSJXZWJzb2NrZXQgY29ubmVjdGlvbiBjbG9zZSIsRT0iV2Vic29ja2V0IGNvbm5lY3Rpb24gZ2FpbiIsRj0iV2Vic29ja2V0IGNvbm5lY3Rpb24gbG9zdCIsQT0iV2Vic29ja2V0IHN1YnNjcmlwdGlvbiBmYWlsdXJlIixSPSJSZXNldCBXZWJzb2NrZXQgc3RhdGUiLHg9IldlYlNvY2tldE1hbmFnZXIgTWVzc2FnZSBFcnJvciIsRD0iTWVzc2FnZSByZWNlaXZlZCBmb3IgdG9waWMgIixqPSJJbnZhbGlkIGluY29taW5nIG1lc3NhZ2UiLE09IldlYnNvY2tldE1hbmFnZXIgaW52b2tlIGNhbGxiYWNrcyBmb3IgdG9waWMgc3VjY2VzcyAiLEc9ImF3cy9zdWJzY3JpYmUiLHo9ImF3cy91bnN1YnNjcmliZSIsUD0iYXdzL2hlYXJ0YmVhdCIsSD0iY29ubmVjdGVkIixVPSJkaXNjb25uZWN0ZWQiO2Z1bmN0aW9uIHEoZSl7cmV0dXJuKHE9ImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmInN5bWJvbCI9PXR5cGVvZiBTeW1ib2wuaXRlcmF0b3I/ZnVuY3Rpb24oZSl7cmV0dXJuIHR5cGVvZiBlfTpmdW5jdGlvbihlKXtyZXR1cm4gZSYmImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmZS5jb25zdHJ1Y3Rvcj09PVN5bWJvbCYmZSE9PVN5bWJvbC5wcm90b3R5cGU/InN5bWJvbCI6dHlwZW9mIGV9KShlKX12YXIgSj17YXNzZXJ0VHJ1ZTpmdW5jdGlvbihlLG4pe2lmKCFlKXRocm93IG5ldyBFcnJvcihuKX0sYXNzZXJ0Tm90TnVsbDpmdW5jdGlvbihlLG4pe3JldHVybiBKLmFzc2VydFRydWUobnVsbCE9PWUmJnZvaWQgMCE9PXEoZSksT2JqZWN0KG8uc3ByaW50ZikoIiVzIG11c3QgYmUgcHJvdmlkZWQiLG58fCJBIHZhbHVlIikpLGV9LGlzTm9uRW1wdHlTdHJpbmc6ZnVuY3Rpb24oZSl7cmV0dXJuInN0cmluZyI9PXR5cGVvZiBlJiZlLmxlbmd0aD4wfSxhc3NlcnRJc0xpc3Q6ZnVuY3Rpb24oZSxuKXtpZighQXJyYXkuaXNBcnJheShlKSl0aHJvdyBuZXcgRXJyb3IobisiIGlzIG5vdCBhbiBhcnJheSIpfSxpc0Z1bmN0aW9uOmZ1bmN0aW9uKGUpe3JldHVybiEhKGUmJmUuY29uc3RydWN0b3ImJmUuY2FsbCYmZS5hcHBseSl9LGlzT2JqZWN0OmZ1bmN0aW9uKGUpe3JldHVybiEoIm9iamVjdCIhPT1xKGUpfHxudWxsPT09ZSl9LGlzU3RyaW5nOmZ1bmN0aW9uKGUpe3JldHVybiJzdHJpbmciPT10eXBlb2YgZX0saXNOdW1iZXI6ZnVuY3Rpb24oZSl7cmV0dXJuIm51bWJlciI9PXR5cGVvZiBlfX0sQj1uZXcgUmVnRXhwKCJeKHdzczovLylcXHcqIik7Si52YWxpZFdTVXJsPWZ1bmN0aW9uKGUpe3JldHVybiBCLnRlc3QoZSl9LEouZ2V0U3Vic2NyaXB0aW9uUmVzcG9uc2U9ZnVuY3Rpb24oZSxuLHQpe3JldHVybnt0b3BpYzplLGNvbnRlbnQ6e3N0YXR1czpuPyJzdWNjZXNzIjoiZmFpbHVyZSIsdG9waWNzOnR9fX0sSi5hc3NlcnRJc09iamVjdD1mdW5jdGlvbihlLG4pe2lmKCFKLmlzT2JqZWN0KGUpKXRocm93IG5ldyBFcnJvcihuKyIgaXMgbm90IGFuIG9iamVjdCEiKX0sSi5hZGRKaXR0ZXI9ZnVuY3Rpb24oZSl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4xJiZ2b2lkIDAhPT1hcmd1bWVudHNbMV0/YXJndW1lbnRzWzFdOjE7bj1NYXRoLm1pbihuLDEpO3ZhciB0PU1hdGgucmFuZG9tKCk+LjU/MTotMTtyZXR1cm4gTWF0aC5mbG9vcihlK3QqZSpNYXRoLnJhbmRvbSgpKm4pfSxKLmlzTmV0d29ya09ubGluZT1mdW5jdGlvbigpe3JldHVybiBuYXZpZ2F0b3Iub25MaW5lfSxKLmlzTmV0d29ya0ZhaWx1cmU9ZnVuY3Rpb24oZSl7cmV0dXJuISghZS5fZGVidWd8fCFlLl9kZWJ1Zy50eXBlKSYmIk5ldHdvcmtpbmdFcnJvciI9PT1lLl9kZWJ1Zy50eXBlfTt2YXIgVj1KO2Z1bmN0aW9uIFgoZSxuKXtyZXR1cm4hbnx8Im9iamVjdCIhPT1aKG4pJiYiZnVuY3Rpb24iIT10eXBlb2Ygbj9mdW5jdGlvbihlKXtpZih2b2lkIDA9PT1lKXRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7cmV0dXJuIGV9KGUpOm59ZnVuY3Rpb24gJChlKXtyZXR1cm4oJD1PYmplY3Quc2V0UHJvdG90eXBlT2Y/T2JqZWN0LmdldFByb3RvdHlwZU9mOmZ1bmN0aW9uKGUpe3JldHVybiBlLl9fcHJvdG9fX3x8T2JqZWN0LmdldFByb3RvdHlwZU9mKGUpfSkoZSl9ZnVuY3Rpb24gSyhlLG4pe3JldHVybihLPU9iamVjdC5zZXRQcm90b3R5cGVPZnx8ZnVuY3Rpb24oZSxuKXtyZXR1cm4gZS5fX3Byb3RvX189bixlfSkoZSxuKX1mdW5jdGlvbiBaKGUpe3JldHVybihaPSJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJiJzeW1ib2wiPT10eXBlb2YgU3ltYm9sLml0ZXJhdG9yP2Z1bmN0aW9uKGUpe3JldHVybiB0eXBlb2YgZX06ZnVuY3Rpb24oZSl7cmV0dXJuIGUmJiJmdW5jdGlvbiI9PXR5cGVvZiBTeW1ib2wmJmUuY29uc3RydWN0b3I9PT1TeW1ib2wmJmUhPT1TeW1ib2wucHJvdG90eXBlPyJzeW1ib2wiOnR5cGVvZiBlfSkoZSl9ZnVuY3Rpb24gUShlLG4pe2lmKCEoZSBpbnN0YW5jZW9mIG4pKXRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpfWZ1bmN0aW9uIFkoZSxuKXtmb3IodmFyIHQ9MDt0PG4ubGVuZ3RoO3QrKyl7dmFyIG89blt0XTtvLmVudW1lcmFibGU9by5lbnVtZXJhYmxlfHwhMSxvLmNvbmZpZ3VyYWJsZT0hMCwidmFsdWUiaW4gbyYmKG8ud3JpdGFibGU9ITApLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG8ua2V5LG8pfX1mdW5jdGlvbiBlZShlLG4sdCl7cmV0dXJuIG4mJlkoZS5wcm90b3R5cGUsbiksdCYmWShlLHQpLGV9dmFyIG5lPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZSgpe1EodGhpcyxlKX1yZXR1cm4gZWUoZSxbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6Indhcm4iLHZhbHVlOmZ1bmN0aW9uKGUpe319LHtrZXk6ImVycm9yIix2YWx1ZTpmdW5jdGlvbihlKXt9fSx7a2V5OiJhZHZhbmNlZExvZyIsdmFsdWU6ZnVuY3Rpb24oZSl7fX1dKSxlfSgpLHRlPXMsb2U9e0RFQlVHOjEwLElORk86MjAsV0FSTjozMCxFUlJPUjo0MCxBRFZBTkNFRF9MT0c6NTB9LHJlPWZ1bmN0aW9uKCl7ZnVuY3Rpb24gZSgpe1EodGhpcyxlKSx0aGlzLnVwZGF0ZUxvZ2dlckNvbmZpZygpLHRoaXMuY29uc29sZUxvZ2dlcldyYXBwZXI9YWUoKX1yZXR1cm4gZWUoZSxbe2tleToid3JpdGVUb0NsaWVudExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSxuKXtpZih0aGlzLmhhc0NsaWVudExvZ2dlcigpKXN3aXRjaChlKXtjYXNlIG9lLkRFQlVHOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuZGVidWcobil8fG47Y2FzZSBvZS5JTkZPOnJldHVybiB0aGlzLl9jbGllbnRMb2dnZXIuaW5mbyhuKXx8bjtjYXNlIG9lLldBUk46cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci53YXJuKG4pfHxuO2Nhc2Ugb2UuRVJST1I6cmV0dXJuIHRoaXMuX2NsaWVudExvZ2dlci5lcnJvcihuKXx8bjtjYXNlIG9lLkFEVkFOQ0VEX0xPRzpyZXR1cm4gdGhpcy5fYWR2YW5jZWRMb2dXcml0ZXI/dGhpcy5fY2xpZW50TG9nZ2VyW3RoaXMuX2FkdmFuY2VkTG9nV3JpdGVyXShuKXx8bjoiIn19fSx7a2V5OiJpc0xldmVsRW5hYmxlZCIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIGU+PXRoaXMuX2xldmVsfX0se2tleToiaGFzQ2xpZW50TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbigpe3JldHVybiBudWxsIT09dGhpcy5fY2xpZW50TG9nZ2VyfX0se2tleToiZ2V0TG9nZ2VyIix2YWx1ZTpmdW5jdGlvbihlKXt2YXIgbj1lLnByZWZpeHx8dGU7cmV0dXJuIHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj09PWM/dGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcjpuZXcgY2Uobil9fSx7a2V5OiJ1cGRhdGVMb2dnZXJDb25maWciLHZhbHVlOmZ1bmN0aW9uKGUpe3ZhciBuPWV8fHt9O3RoaXMuX2xldmVsPW4ubGV2ZWx8fG9lLklORk8sdGhpcy5fYWR2YW5jZWRMb2dXcml0ZXI9Indhcm4iLG4uYWR2YW5jZWRMb2dXcml0ZXImJih0aGlzLl9hZHZhbmNlZExvZ1dyaXRlcj1uLmFkdmFuY2VkTG9nV3JpdGVyKSxuLmN1c3RvbWl6ZWRMb2dnZXImJiJvYmplY3QiPT09WihuLmN1c3RvbWl6ZWRMb2dnZXIpJiYodGhpcy51c2VDbGllbnRMb2dnZXI9ITApLHRoaXMuX2NsaWVudExvZ2dlcj1uLmxvZ2dlcnx8dGhpcy5zZWxlY3RMb2dnZXIobiksdGhpcy5fbG9nc0Rlc3RpbmF0aW9uPXIsbi5kZWJ1ZyYmKHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1jKSxuLmxvZ2dlciYmKHRoaXMuX2xvZ3NEZXN0aW5hdGlvbj1pKX19LHtrZXk6InNlbGVjdExvZ2dlciIsdmFsdWU6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuY3VzdG9taXplZExvZ2dlciYmIm9iamVjdCI9PT1aKGUuY3VzdG9taXplZExvZ2dlcik/ZS5jdXN0b21pemVkTG9nZ2VyOmUudXNlRGVmYXVsdExvZ2dlcj8odGhpcy5jb25zb2xlTG9nZ2VyV3JhcHBlcj1hZSgpLHRoaXMuY29uc29sZUxvZ2dlcldyYXBwZXIpOm51bGx9fV0pLGV9KCksaWU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKCl7USh0aGlzLGUpfXJldHVybiBlZShlLFt7a2V5OiJkZWJ1ZyIsdmFsdWU6ZnVuY3Rpb24oKXt9fSx7a2V5OiJpbmZvIix2YWx1ZTpmdW5jdGlvbigpe319LHtrZXk6Indhcm4iLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiZXJyb3IiLHZhbHVlOmZ1bmN0aW9uKCl7fX0se2tleToiYWR2YW5jZWRMb2ciLHZhbHVlOmZ1bmN0aW9uKCl7fX1dKSxlfSgpLGNlPWZ1bmN0aW9uKGUpe2Z1bmN0aW9uIG4oZSl7dmFyIHQ7cmV0dXJuIFEodGhpcyxuKSwodD1YKHRoaXMsJChuKS5jYWxsKHRoaXMpKSkucHJlZml4PWV8fHRlLHR9cmV0dXJuIGZ1bmN0aW9uKGUsbil7aWYoImZ1bmN0aW9uIiE9dHlwZW9mIG4mJm51bGwhPT1uKXRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uIik7ZS5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShuJiZuLnByb3RvdHlwZSx7Y29uc3RydWN0b3I6e3ZhbHVlOmUsd3JpdGFibGU6ITAsY29uZmlndXJhYmxlOiEwfX0pLG4mJksoZSxuKX0obixpZSksZWUobixbe2tleToiZGVidWciLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5ERUJVRyxuKX19LHtrZXk6ImluZm8iLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5JTkZPLG4pfX0se2tleToid2FybiIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLldBUk4sbil9fSx7a2V5OiJlcnJvciIsdmFsdWU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gdGhpcy5fbG9nKG9lLkVSUk9SLG4pfX0se2tleToiYWR2YW5jZWRMb2ciLHZhbHVlOmZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIHRoaXMuX2xvZyhvZS5BRFZBTkNFRF9MT0csbil9fSx7a2V5OiJfc2hvdWxkTG9nIix2YWx1ZTpmdW5jdGlvbihlKXtyZXR1cm4gc2UuaGFzQ2xpZW50TG9nZ2VyKCkmJnNlLmlzTGV2ZWxFbmFibGVkKGUpfX0se2tleToiX3dyaXRlVG9DbGllbnRMb2dnZXIiLHZhbHVlOmZ1bmN0aW9uKGUsbil7cmV0dXJuIHNlLndyaXRlVG9DbGllbnRMb2dnZXIoZSxuKX19LHtrZXk6Il9sb2ciLHZhbHVlOmZ1bmN0aW9uKGUsbil7aWYodGhpcy5fc2hvdWxkTG9nKGUpKXt2YXIgdD1zZS51c2VDbGllbnRMb2dnZXI/bjp0aGlzLl9jb252ZXJ0VG9TaW5nbGVTdGF0ZW1lbnQobixlKTtyZXR1cm4gdGhpcy5fd3JpdGVUb0NsaWVudExvZ2dlcihlLHQpfX19LHtrZXk6Il9jb252ZXJ0VG9TaW5nbGVTdGF0ZW1lbnQiLHZhbHVlOmZ1bmN0aW9uKGUsbil7dmFyIHQ9bmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSxvPXRoaXMuX2dldExvZ0xldmVsQnlWYWx1ZShuKSxyPSJbIi5jb25jYXQodCwiXVsiKS5jb25jYXQobywiXSIpO3RoaXMucHJlZml4JiYocis9dGhpcy5wcmVmaXgrIiAiKSx0aGlzLm9wdGlvbnMmJih0aGlzLm9wdGlvbnMucHJlZml4P3IrPSIgIit0aGlzLm9wdGlvbnMucHJlZml4KyI6IjpyKz0iIix0aGlzLm9wdGlvbnMubG9nTWV0YURhdGE/cis9IiBNZXRhIGRhdGE6ICIrSlNPTi5zdHJpbmdpZnkodGhpcy5vcHRpb25zLmxvZ01ldGFEYXRhKTpyKz0iIik7Zm9yKHZhciBpPTA7aTxlLmxlbmd0aDtpKyspe3ZhciBjPWVbaV07cis9dGhpcy5fY29udmVydFRvU3RyaW5nKGMpKyIgIn1yZXR1cm4gcn19LHtrZXk6Il9nZXRMb2dMZXZlbEJ5VmFsdWUiLHZhbHVlOmZ1bmN0aW9uKGUpe3N3aXRjaChlKXtjYXNlIDEwOnJldHVybiJERUJVRyI7Y2FzZSAyMDpyZXR1cm4iSU5GTyI7Y2FzZSAzMDpyZXR1cm4iV0FSTiI7Y2FzZSA0MDpyZXR1cm4iRVJST1IiO2Nhc2UgNTA6cmV0dXJuIkFEVkFOQ0VEX0xPRyJ9fX0se2tleToiX2NvbnZlcnRUb1N0cmluZyIsdmFsdWU6ZnVuY3Rpb24oZSl7dHJ5e2lmKCFlKXJldHVybiIiO2lmKFYuaXNTdHJpbmcoZSkpcmV0dXJuIGU7aWYoVi5pc09iamVjdChlKSYmVi5pc0Z1bmN0aW9uKGUudG9TdHJpbmcpKXt2YXIgbj1lLnRvU3RyaW5nKCk7aWYoIltvYmplY3QgT2JqZWN0XSIhPT1uKXJldHVybiBufXJldHVybiBKU09OLnN0cmluZ2lmeShlKX1jYXRjaChuKXtyZXR1cm4gY29uc29sZS5lcnJvcigiRXJyb3Igd2hpbGUgY29udmVydGluZyBhcmd1bWVudCB0byBzdHJpbmciLGUsbiksIiJ9fX1dKSxufSgpLGFlPWZ1bmN0aW9uKCl7dmFyIGU9bmV3IGllO3JldHVybiBlLmRlYnVnPWZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIGNvbnNvbGUuZGVidWcuYXBwbHkod2luZG93LmNvbnNvbGUsW10uY29uY2F0KG4pKX0sZS5pbmZvPWZ1bmN0aW9uKCl7Zm9yKHZhciBlPWFyZ3VtZW50cy5sZW5ndGgsbj1uZXcgQXJyYXkoZSksdD0wO3Q8ZTt0Kyspblt0XT1hcmd1bWVudHNbdF07cmV0dXJuIGNvbnNvbGUuaW5mby5hcHBseSh3aW5kb3cuY29uc29sZSxbXS5jb25jYXQobikpfSxlLndhcm49ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS53YXJuLmFwcGx5KHdpbmRvdy5jb25zb2xlLFtdLmNvbmNhdChuKSl9LGUuZXJyb3I9ZnVuY3Rpb24oKXtmb3IodmFyIGU9YXJndW1lbnRzLmxlbmd0aCxuPW5ldyBBcnJheShlKSx0PTA7dDxlO3QrKyluW3RdPWFyZ3VtZW50c1t0XTtyZXR1cm4gY29uc29sZS5lcnJvci5hcHBseSh3aW5kb3cuY29uc29sZSxbXS5jb25jYXQobikpfSxlfSxzZT1uZXcgcmU7ZnVuY3Rpb24gdWUoZSxuKXtmb3IodmFyIHQ9MDt0PG4ubGVuZ3RoO3QrKyl7dmFyIG89blt0XTtvLmVudW1lcmFibGU9by5lbnVtZXJhYmxlfHwhMSxvLmNvbmZpZ3VyYWJsZT0hMCwidmFsdWUiaW4gbyYmKG8ud3JpdGFibGU9ITApLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLG8ua2V5LG8pfX12YXIgbGU9ZnVuY3Rpb24oKXtmdW5jdGlvbiBlKG4pe3ZhciB0PWFyZ3VtZW50cy5sZW5ndGg+MSYmdm9pZCAwIT09YXJndW1lbnRzWzFdP2FyZ3VtZW50c1sxXTphOyFmdW5jdGlvbihlLG4pe2lmKCEoZSBpbnN0YW5jZW9mIG4pKXRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpfSh0aGlzLGUpLHRoaXMubnVtQXR0ZW1wdHM9MCx0aGlzLmV4ZWN1dG9yPW4sdGhpcy5oYXNBY3RpdmVSZWNvbm5lY3Rpb249ITEsdGhpcy5kZWZhdWx0UmV0cnk9dH12YXIgbix0LG87cmV0dXJuIG49ZSwodD1be2tleToicmV0cnkiLHZhbHVlOmZ1bmN0aW9uKCl7dmFyIGU9dGhpczt0aGlzLmhhc0FjdGl2ZVJlY29ubmVjdGlvbnx8KHRoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9uPSEwLHNldFRpbWVvdXQoZnVuY3Rpb24oKXtlLl9leGVjdXRlKCl9LHRoaXMuX2dldERlbGF5KCkpKX19LHtrZXk6Il9leGVjdXRlIix2YWx1ZTpmdW5jdGlvbigpe3RoaXMuaGFzQWN0aXZlUmVjb25uZWN0aW9uPSExLHRoaXMuZXhlY3V0b3IoKSx0aGlzLm51bUF0dGVtcHRzKyt9fSx7a2V5OiJjb25uZWN0ZWQiLHZhbHVlOmZ1bmN0aW9uKCl7dGhpcy5udW1BdHRlbXB0cz0wfX0se2tleToiX2dldERlbGF5Iix2YWx1ZTpmdW5jdGlvbigpe3ZhciBlPU1hdGgucG93KDIsdGhpcy5udW1BdHRlbXB0cykqdGhpcy5kZWZhdWx0UmV0cnk7cmV0dXJuIGU8PTNlND9lOjNlNH19LHtrZXk6ImdldElzQ29ubmVjdGVkIix2YWx1ZTpmdW5jdGlvbigpe3JldHVybiF0aGlzLm51bUF0dGVtcHRzfX1dKSYmdWUobi5wcm90b3R5cGUsdCksbyYmdWUobixvKSxlfSgpO3QuZChuLCJhIixmdW5jdGlvbigpe3JldHVybiBkZX0pO3ZhciBmZT1mdW5jdGlvbigpe3ZhciBlPXNlLmdldExvZ2dlcih7cHJlZml4OnN9KSxuPVYuaXNOZXR3b3JrT25saW5lKCksdD17cHJpbWFyeTpudWxsLHNlY29uZGFyeTpudWxsfSxvPXtyZWNvbm5lY3RXZWJTb2NrZXQ6ITAsd2Vic29ja2V0SW5pdEZhaWxlZDohMSxleHBvbmVudGlhbEJhY2tPZmZUaW1lOjFlMyxleHBvbmVudGlhbFRpbWVvdXRIYW5kbGU6bnVsbCxsaWZlVGltZVRpbWVvdXRIYW5kbGU6bnVsbCx3ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZDpudWxsLGNvbm5TdGF0ZTpudWxsfSxyPXtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDowLGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOm51bGwsbm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6bnVsbH0saT17cGVuZGluZ1Jlc3BvbnNlOiExLGludGVydmFsSGFuZGxlOm51bGx9LGM9e2luaXRGYWlsdXJlOm5ldyBTZXQsZ2V0V2ViU29ja2V0VHJhbnNwb3J0Om51bGwsc3Vic2NyaXB0aW9uVXBkYXRlOm5ldyBTZXQsc3Vic2NyaXB0aW9uRmFpbHVyZTpuZXcgU2V0LHRvcGljOm5ldyBNYXAsYWxsTWVzc2FnZTpuZXcgU2V0LGNvbm5lY3Rpb25HYWluOm5ldyBTZXQsY29ubmVjdGlvbkxvc3Q6bmV3IFNldCxjb25uZWN0aW9uT3BlbjpuZXcgU2V0LGNvbm5lY3Rpb25DbG9zZTpuZXcgU2V0fSxhPXtjb25uQ29uZmlnOm51bGwscHJvbWlzZUhhbmRsZTpudWxsLHByb21pc2VDb21wbGV0ZWQ6ITB9LHE9e3N1YnNjcmliZWQ6bmV3IFNldCxwZW5kaW5nOm5ldyBTZXQsc3Vic2NyaXB0aW9uSGlzdG9yeTpuZXcgU2V0fSxKPXtyZXNwb25zZUNoZWNrSW50ZXJ2YWxJZDpudWxsLHJlcXVlc3RDb21wbGV0ZWQ6ITAscmVTdWJzY3JpYmVJbnRlcnZhbElkOm51bGwsY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0czowLGNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q6MH0sQj1uZXcgbGUoZnVuY3Rpb24oKXtoZSgpfSksWD1uZXcgU2V0KFtHLHosUF0pLCQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtpZihuIT09Vi5pc05ldHdvcmtPbmxpbmUoKSl7aWYoIShuPVYuaXNOZXR3b3JrT25saW5lKCkpKXJldHVybiBlLmFkdmFuY2VkTG9nKHUpLHZvaWQgQ2UoZS5pbmZvKHUpKTt2YXIgdD10ZSgpO24mJighdHx8WSh0LFdlYlNvY2tldC5DTE9TSU5HKXx8WSh0LFdlYlNvY2tldC5DTE9TRUQpKSYmKGUuYWR2YW5jZWRMb2cobCksQ2UoZS5pbmZvKGwpKSxoZSgpKX19LDI1MCksSz1mdW5jdGlvbihuLHQpe24uZm9yRWFjaChmdW5jdGlvbihuKXt0cnl7bih0KX1jYXRjaChuKXtDZShlLmVycm9yKCJFcnJvciBleGVjdXRpbmcgY2FsbGJhY2siLG4pKX19KX0sWj1mdW5jdGlvbihlKXtpZihudWxsPT09ZSlyZXR1cm4iTlVMTCI7c3dpdGNoKGUucmVhZHlTdGF0ZSl7Y2FzZSBXZWJTb2NrZXQuQ09OTkVDVElORzpyZXR1cm4iQ09OTkVDVElORyI7Y2FzZSBXZWJTb2NrZXQuT1BFTjpyZXR1cm4iT1BFTiI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0lORzpyZXR1cm4iQ0xPU0lORyI7Y2FzZSBXZWJTb2NrZXQuQ0xPU0VEOnJldHVybiJDTE9TRUQiO2RlZmF1bHQ6cmV0dXJuIlVOREVGSU5FRCJ9fSxRPWZ1bmN0aW9uKCl7dmFyIG49YXJndW1lbnRzLmxlbmd0aD4wJiZ2b2lkIDAhPT1hcmd1bWVudHNbMF0/YXJndW1lbnRzWzBdOiIiO0NlKGUuZGVidWcoIlsiK24rIl0gUHJpbWFyeSBXZWJTb2NrZXQ6ICIrWih0LnByaW1hcnkpKyIgfCBTZWNvbmRhcnkgV2ViU29ja2V0OiAiK1oodC5zZWNvbmRhcnkpKSl9LFk9ZnVuY3Rpb24oZSxuKXtyZXR1cm4gZSYmZS5yZWFkeVN0YXRlPT09bn0sZWU9ZnVuY3Rpb24oZSl7cmV0dXJuIFkoZSxXZWJTb2NrZXQuT1BFTil9LG5lPWZ1bmN0aW9uKGUpe3JldHVybiBudWxsPT09ZXx8dm9pZCAwPT09ZS5yZWFkeVN0YXRlfHxZKGUsV2ViU29ja2V0LkNMT1NFRCl9LHRlPWZ1bmN0aW9uKCl7cmV0dXJuIG51bGwhPT10LnNlY29uZGFyeT90LnNlY29uZGFyeTp0LnByaW1hcnl9LG9lPWZ1bmN0aW9uKCl7cmV0dXJuIGVlKHRlKCkpfSxyZT1mdW5jdGlvbigpe2lmKGkucGVuZGluZ1Jlc3BvbnNlKXJldHVybiBlLmFkdmFuY2VkTG9nKGQpLENlKGUud2FybihkKSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxpLnBlbmRpbmdSZXNwb25zZT0hMSx2b2lkIGhlKCk7b2UoKT8oQ2UoZS5kZWJ1ZyhnKSksdGUoKS5zZW5kKHZlKFApKSxpLnBlbmRpbmdSZXNwb25zZT0hMCk6KGUuYWR2YW5jZWRMb2coYiksQ2UoZS53YXJuKGIpKSxRKCJzZW5kSGVhcnRCZWF0IiksaGUoKSl9LGllPWZ1bmN0aW9uKCl7ZS5hZHZhbmNlZExvZyhSKSxvLmV4cG9uZW50aWFsQmFja09mZlRpbWU9MWUzLGkucGVuZGluZ1Jlc3BvbnNlPSExLG8ucmVjb25uZWN0V2ViU29ja2V0PSEwLGNsZWFyVGltZW91dChvLmxpZmVUaW1lVGltZW91dEhhbmRsZSksY2xlYXJJbnRlcnZhbChpLmludGVydmFsSGFuZGxlKSxjbGVhclRpbWVvdXQoby5leHBvbmVudGlhbFRpbWVvdXRIYW5kbGUpLGNsZWFyVGltZW91dChvLndlYlNvY2tldEluaXRDaGVja2VyVGltZW91dElkKX0sY2U9ZnVuY3Rpb24oKXtKLmNvbnNlY3V0aXZlRmFpbGVkU3Vic2NyaWJlQXR0ZW1wdHM9MCxKLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCxjbGVhckludGVydmFsKEoucmVzcG9uc2VDaGVja0ludGVydmFsSWQpLGNsZWFySW50ZXJ2YWwoSi5yZVN1YnNjcmliZUludGVydmFsSWQpfSxhZT1mdW5jdGlvbigpe3IuY29ubmVjdFdlYlNvY2tldFJldHJ5Q291bnQ9MCxyLmNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lPW51bGwsci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcD1udWxsfSx1ZT1mdW5jdGlvbigpe0IuY29ubmVjdGVkKCk7dHJ5e2UuYWR2YW5jZWRMb2coeSksQ2UoZS5pbmZvKHkpKSxRKCJ3ZWJTb2NrZXRPbk9wZW4iKSxudWxsIT09by5jb25uU3RhdGUmJm8uY29ublN0YXRlIT09VXx8SyhjLmNvbm5lY3Rpb25HYWluKSxvLmNvbm5TdGF0ZT1IO3ZhciBuPURhdGUubm93KCk7SyhjLmNvbm5lY3Rpb25PcGVuLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsbm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA6ci5ub09wZW5Db25uZWN0aW9uc1RpbWVzdGFtcCxjb25uZWN0aW9uRXN0YWJsaXNoZWRUaW1lOm4sdGltZVRvQ29ubmVjdDpuLXIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUsdGltZVdpdGhvdXRDb25uZWN0aW9uOnIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA/bi1yLm5vT3BlbkNvbm5lY3Rpb25zVGltZXN0YW1wOm51bGx9KSxhZSgpLGllKCksdGUoKS5vcGVuVGltZXN0YW1wPURhdGUubm93KCksMD09PXEuc3Vic2NyaWJlZC5zaXplJiZlZSh0LnNlY29uZGFyeSkmJmdlKHQucHJpbWFyeSwiW1ByaW1hcnkgV2ViU29ja2V0XSBDbG9zaW5nIFdlYlNvY2tldCIpLChxLnN1YnNjcmliZWQuc2l6ZT4wfHxxLnBlbmRpbmcuc2l6ZT4wKSYmKGVlKHQuc2Vjb25kYXJ5KSYmQ2UoZS5pbmZvKCJTdWJzY3JpYmluZyBzZWNvbmRhcnkgd2Vic29ja2V0IHRvIHRvcGljcyBvZiBwcmltYXJ5IHdlYnNvY2tldCIpKSxxLnN1YnNjcmliZWQuZm9yRWFjaChmdW5jdGlvbihlKXtxLnN1YnNjcmlwdGlvbkhpc3RvcnkuYWRkKGUpLHEucGVuZGluZy5hZGQoZSl9KSxxLnN1YnNjcmliZWQuY2xlYXIoKSxwZSgpKSxyZSgpLGkuaW50ZXJ2YWxIYW5kbGU9c2V0SW50ZXJ2YWwocmUsMWU0KTt2YXIgcz0xZTMqYS5jb25uQ29uZmlnLndlYlNvY2tldFRyYW5zcG9ydC50cmFuc3BvcnRMaWZlVGltZUluU2Vjb25kcztDZShlLmRlYnVnKCJTY2hlZHVsaW5nIFdlYlNvY2tldCBtYW5hZ2VyIHJlY29ubmVjdGlvbiwgYWZ0ZXIgZGVsYXkgIitzKyIgbXMiKSksby5saWZlVGltZVRpbWVvdXRIYW5kbGU9c2V0VGltZW91dChmdW5jdGlvbigpe0NlKGUuZGVidWcoIlN0YXJ0aW5nIHNjaGVkdWxlZCBXZWJTb2NrZXQgbWFuYWdlciByZWNvbm5lY3Rpb24iKSksaGUoKX0scyl9Y2F0Y2gobil7Q2UoZS5lcnJvcigiRXJyb3IgYWZ0ZXIgZXN0YWJsaXNoaW5nIFdlYlNvY2tldCBjb25uZWN0aW9uIixuKSl9fSxmZT1mdW5jdGlvbihuKXtRKCJ3ZWJTb2NrZXRPbkVycm9yIiksZS5hZHZhbmNlZExvZyh2LEpTT04uc3RyaW5naWZ5KG4pKSxDZShlLmVycm9yKHYsSlNPTi5zdHJpbmdpZnkobikpKSxCLmdldElzQ29ubmVjdGVkKCk/aGUoKTpCLnJldHJ5KCl9LGRlPWZ1bmN0aW9uKG4pe3ZhciBvPUpTT04ucGFyc2Uobi5kYXRhKTtzd2l0Y2goby50b3BpYyl7Y2FzZSBHOmlmKENlKGUuZGVidWcoIlN1YnNjcmlwdGlvbiBNZXNzYWdlIHJlY2VpdmVkIGZyb20gd2ViU29ja2V0IHNlcnZlciIsbi5kYXRhKSksSi5yZXF1ZXN0Q29tcGxldGVkPSEwLEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD0wLCJzdWNjZXNzIj09PW8uY29udGVudC5zdGF0dXMpSi5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzPTAsby5jb250ZW50LnRvcGljcy5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Euc3Vic2NyaXB0aW9uSGlzdG9yeS5kZWxldGUoZSkscS5wZW5kaW5nLmRlbGV0ZShlKSxxLnN1YnNjcmliZWQuYWRkKGUpfSksMD09PXEuc3Vic2NyaXB0aW9uSGlzdG9yeS5zaXplP2VlKHQuc2Vjb25kYXJ5KSYmKENlKGUuaW5mbygiU3VjY2Vzc2Z1bGx5IHN1YnNjcmliZWQgc2Vjb25kYXJ5IHdlYnNvY2tldCB0byBhbGwgdG9waWNzIG9mIHByaW1hcnkgd2Vic29ja2V0IikpLGdlKHQucHJpbWFyeSwiW1ByaW1hcnkgV2ViU29ja2V0XSBDbG9zaW5nIFdlYlNvY2tldCIpKTpwZSgpLEsoYy5zdWJzY3JpcHRpb25VcGRhdGUsbyk7ZWxzZXtpZihjbGVhckludGVydmFsKEoucmVTdWJzY3JpYmVJbnRlcnZhbElkKSwrK0ouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cyw1PT09Si5jb25zZWN1dGl2ZUZhaWxlZFN1YnNjcmliZUF0dGVtcHRzKXJldHVybiBLKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSxvKSx2b2lkKEouY29uc2VjdXRpdmVGYWlsZWRTdWJzY3JpYmVBdHRlbXB0cz0wKTtKLnJlU3Vic2NyaWJlSW50ZXJ2YWxJZD1zZXRJbnRlcnZhbChmdW5jdGlvbigpe3BlKCl9LDUwMCl9YnJlYWs7Y2FzZSBQOkNlKGUuZGVidWcocCkpLGkucGVuZGluZ1Jlc3BvbnNlPSExO2JyZWFrO2RlZmF1bHQ6aWYoby50b3BpYyl7aWYoZS5hZHZhbmNlZExvZyhELG8udG9waWMpLENlKGUuZGVidWcoRCtvLnRvcGljKSksZWUodC5wcmltYXJ5KSYmZWUodC5zZWNvbmRhcnkpJiYwPT09cS5zdWJzY3JpcHRpb25IaXN0b3J5LnNpemUmJnRoaXM9PT10LnByaW1hcnkpcmV0dXJuIHZvaWQgQ2UoZS53YXJuKCJJZ25vcmluZyBNZXNzYWdlIGZvciBUb3BpYyAiK28udG9waWMrIiwgdG8gYXZvaWQgZHVwbGljYXRlcyIpKTtpZigwPT09Yy5hbGxNZXNzYWdlLnNpemUmJjA9PT1jLnRvcGljLnNpemUpcmV0dXJuIHZvaWQgQ2UoZS53YXJuKCJObyByZWdpc3RlcmVkIGNhbGxiYWNrIGxpc3RlbmVyIGZvciBUb3BpYyIsby50b3BpYykpO2UuYWR2YW5jZWRMb2coTSxvLnRvcGljKSxLKGMuYWxsTWVzc2FnZSxvKSxjLnRvcGljLmhhcyhvLnRvcGljKSYmSyhjLnRvcGljLmdldChvLnRvcGljKSxvKX1lbHNlIG8ubWVzc2FnZT8oZS5hZHZhbmNlZExvZyh4LG8pLENlKGUud2Fybih4LG8pKSk6KGUuYWR2YW5jZWRMb2coaixvKSxDZShlLndhcm4oaixvKSkpfX0scGU9ZnVuY3Rpb24gbigpe2lmKEouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdD4zKXJldHVybiBDZShlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3Mgc2luY2Ugd2UgaGF2ZSBleGhhdXN0ZWQgbWF4IHN1YnNjcmlwdGlvbiByZXRyaWVzIHdpdGggbm8gcmVzcG9uc2UiKSksdm9pZCBLKGMuc3Vic2NyaXB0aW9uRmFpbHVyZSxWLmdldFN1YnNjcmlwdGlvblJlc3BvbnNlKEcsITEsQXJyYXkuZnJvbShxLnBlbmRpbmcpKSk7b2UoKT8wIT09QXJyYXkuZnJvbShxLnBlbmRpbmcpLmxlbmd0aCYmKGNsZWFySW50ZXJ2YWwoSi5yZXNwb25zZUNoZWNrSW50ZXJ2YWxJZCksdGUoKS5zZW5kKHZlKEcse3RvcGljczpBcnJheS5mcm9tKHEucGVuZGluZyl9KSksSi5yZXF1ZXN0Q29tcGxldGVkPSExLEoucmVzcG9uc2VDaGVja0ludGVydmFsSWQ9c2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXtKLnJlcXVlc3RDb21wbGV0ZWR8fCgrK0ouY29uc2VjdXRpdmVOb1Jlc3BvbnNlUmVxdWVzdCxuKCkpfSwxZTMpKTpDZShlLndhcm4oIklnbm9yaW5nIHN1YnNjcmliZVBlbmRpbmdUb3BpY3MgY2FsbCBzaW5jZSBEZWZhdWx0IFdlYlNvY2tldCBpcyBub3Qgb3BlbiIpKX0sZ2U9ZnVuY3Rpb24obix0KXtZKG4sV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHxZKG4sV2ViU29ja2V0Lk9QRU4pP24uY2xvc2UoMWUzLHQpOkNlKGUud2FybigiSWdub3JpbmcgV2ViU29ja2V0IENsb3NlIHJlcXVlc3QsIFdlYlNvY2tldCBTdGF0ZTogIitaKG4pKSl9LGJlPWZ1bmN0aW9uKGUpe2dlKHQucHJpbWFyeSwiW1ByaW1hcnldIFdlYlNvY2tldCAiK2UpLGdlKHQuc2Vjb25kYXJ5LCJbU2Vjb25kYXJ5XSBXZWJTb2NrZXQgIitlKX0seWU9ZnVuY3Rpb24oKXtyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50Kys7dmFyIG49Vi5hZGRKaXR0ZXIoby5leHBvbmVudGlhbEJhY2tPZmZUaW1lLC4zKTtEYXRlLm5vdygpK248PWEuY29ubkNvbmZpZy51cmxDb25uVmFsaWRUaW1lPyhlLmFkdmFuY2VkTG9nKFMpLENlKGUuZGVidWcoUytuKyIgbXMiKSksby5leHBvbmVudGlhbFRpbWVvdXRIYW5kbGU9c2V0VGltZW91dChmdW5jdGlvbigpe3JldHVybiBrZSgpfSxuKSxvLmV4cG9uZW50aWFsQmFja09mZlRpbWUqPTIpOihlLmFkdmFuY2VkTG9nKGgpLENlKGUud2FybihoKSksaGUoKSl9LG1lPWZ1bmN0aW9uKG4pe2llKCksY2UoKSxlLmFkdmFuY2VkTG9nKGssbiksQ2UoZS5lcnJvcihrKSksby53ZWJzb2NrZXRJbml0RmFpbGVkPSEwLGJlKHcpLGNsZWFySW50ZXJ2YWwoJCksSyhjLmluaXRGYWlsdXJlLHtjb25uZWN0V2ViU29ja2V0UmV0cnlDb3VudDpyLmNvbm5lY3RXZWJTb2NrZXRSZXRyeUNvdW50LGNvbm5lY3Rpb25BdHRlbXB0U3RhcnRUaW1lOnIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWUscmVhc29uOm59KSxhZSgpfSx2ZT1mdW5jdGlvbihlLG4pe3JldHVybiBKU09OLnN0cmluZ2lmeSh7dG9waWM6ZSxjb250ZW50Om59KX0sU2U9ZnVuY3Rpb24obil7cmV0dXJuISEoVi5pc09iamVjdChuKSYmVi5pc09iamVjdChuLndlYlNvY2tldFRyYW5zcG9ydCkmJlYuaXNOb25FbXB0eVN0cmluZyhuLndlYlNvY2tldFRyYW5zcG9ydC51cmwpJiZWLnZhbGlkV1NVcmwobi53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKSYmMWUzKm4ud2ViU29ja2V0VHJhbnNwb3J0LnRyYW5zcG9ydExpZmVUaW1lSW5TZWNvbmRzPj0zZTUpfHwoQ2UoZS5lcnJvcigiSW52YWxpZCBXZWJTb2NrZXQgQ29ubmVjdGlvbiBDb25maWd1cmF0aW9uIixuKSksITEpfSxoZT1mdW5jdGlvbigpe2lmKCFWLmlzTmV0d29ya09ubGluZSgpKXJldHVybiBlLmFkdmFuY2VkTG9nKGYpLHZvaWQgQ2UoZS5pbmZvKGYpKTtpZihvLndlYnNvY2tldEluaXRGYWlsZWQpQ2UoZS5kZWJ1ZygiV2ViU29ja2V0IEluaXQgaGFkIGZhaWxlZCwgaWdub3JpbmcgdGhpcyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QiKSk7ZWxzZXtpZihhLnByb21pc2VDb21wbGV0ZWQpcmV0dXJuIGllKCksZS5hZHZhbmNlZExvZyhDKSxDZShlLmluZm8oQykpLHIuY29ubmVjdGlvbkF0dGVtcHRTdGFydFRpbWU9ci5jb25uZWN0aW9uQXR0ZW1wdFN0YXJ0VGltZXx8RGF0ZS5ub3coKSxhLnByb21pc2VDb21wbGV0ZWQ9ITEsYS5wcm9taXNlSGFuZGxlPWMuZ2V0V2ViU29ja2V0VHJhbnNwb3J0KCksYS5wcm9taXNlSGFuZGxlLnRoZW4oZnVuY3Rpb24obil7cmV0dXJuIGEucHJvbWlzZUNvbXBsZXRlZD0hMCxlLmFkdmFuY2VkTG9nKEwpLENlKGUuZGVidWcoTCxuKSksU2Uobik/KGEuY29ubkNvbmZpZz1uLGEuY29ubkNvbmZpZy51cmxDb25uVmFsaWRUaW1lPURhdGUubm93KCkrODVlMyxrZSgpKToobWUoIkludmFsaWQgV2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbjogIituKSx7d2ViU29ja2V0Q29ubmVjdGlvbkZhaWxlZDohMH0pfSxmdW5jdGlvbihuKXtyZXR1cm4gYS5wcm9taXNlQ29tcGxldGVkPSEwLGUuYWR2YW5jZWRMb2coVCksQ2UoZS5lcnJvcihULG4pKSxWLmlzTmV0d29ya0ZhaWx1cmUobik/KGUuYWR2YW5jZWRMb2coTytKU09OLnN0cmluZ2lmeShuKSksQ2UoZS5pbmZvKE8rSlNPTi5zdHJpbmdpZnkobikpKSxCLnJldHJ5KCkpOm1lKCJGYWlsZWQgdG8gZmV0Y2ggd2ViU29ja2V0IGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbjogIitKU09OLnN0cmluZ2lmeShuKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9fSk7Q2UoZS5kZWJ1ZygiVGhlcmUgaXMgYW4gb25nb2luZyBnZXRXZWJTb2NrZXRDb25uQ29uZmlnIHJlcXVlc3QsIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQiKSl9fSxrZT1mdW5jdGlvbigpe2lmKG8ud2Vic29ja2V0SW5pdEZhaWxlZClyZXR1cm4gQ2UoZS5pbmZvKCJ3ZWItc29ja2V0IGluaXRpYWxpemluZyBoYWQgZmFpbGVkLCBhYm9ydGluZyByZS1pbml0IikpLHt3ZWJTb2NrZXRDb25uZWN0aW9uRmFpbGVkOiEwfTtpZighVi5pc05ldHdvcmtPbmxpbmUoKSlyZXR1cm4gQ2UoZS53YXJuKCJTeXN0ZW0gaXMgb2ZmbGluZSBhYm9ydGluZyB3ZWItc29ja2V0IGluaXQiKSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9O2UuYWR2YW5jZWRMb2coVyksQ2UoZS5pbmZvKFcpKSxRKCJpbml0V2ViU29ja2V0Iik7dHJ5e2lmKFNlKGEuY29ubkNvbmZpZykpe3ZhciBuPW51bGw7cmV0dXJuIGVlKHQucHJpbWFyeSk/KENlKGUuZGVidWcoIlByaW1hcnkgU29ja2V0IGNvbm5lY3Rpb24gaXMgYWxyZWFkeSBvcGVuIikpLFkodC5zZWNvbmRhcnksV2ViU29ja2V0LkNPTk5FQ1RJTkcpfHwoQ2UoZS5kZWJ1ZygiRXN0YWJsaXNoaW5nIGEgc2Vjb25kYXJ5IHdlYi1zb2NrZXQgY29ubmVjdGlvbiIpKSxCLm51bUF0dGVtcHRzPTAsdC5zZWNvbmRhcnk9d2UoKSksbj10LnNlY29uZGFyeSk6KFkodC5wcmltYXJ5LFdlYlNvY2tldC5DT05ORUNUSU5HKXx8KENlKGUuZGVidWcoIkVzdGFibGlzaGluZyBhIHByaW1hcnkgd2ViLXNvY2tldCBjb25uZWN0aW9uIikpLHQucHJpbWFyeT13ZSgpKSxuPXQucHJpbWFyeSksby53ZWJTb2NrZXRJbml0Q2hlY2tlclRpbWVvdXRJZD1zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7ZWUobil8fHllKCl9LDFlMykse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITF9fX1jYXRjaChuKXtyZXR1cm4gQ2UoZS5lcnJvcigiRXJyb3IgSW5pdGlhbGl6aW5nIHdlYi1zb2NrZXQtbWFuYWdlciIsbikpLG1lKCJGYWlsZWQgdG8gaW5pdGlhbGl6ZSBuZXcgV2ViU29ja2V0OiAiK24ubWVzc2FnZSkse3dlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQ6ITB9fX0sd2U9ZnVuY3Rpb24oKXt2YXIgbj1uZXcgV2ViU29ja2V0KGEuY29ubkNvbmZpZy53ZWJTb2NrZXRUcmFuc3BvcnQudXJsKTtyZXR1cm4gbi5hZGRFdmVudExpc3RlbmVyKCJvcGVuIix1ZSksbi5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIixkZSksbi5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsZmUpLG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xvc2UiLGZ1bmN0aW9uKGkpe3JldHVybiBmdW5jdGlvbihuLGkpe2UuYWR2YW5jZWRMb2cobSxKU09OLnN0cmluZ2lmeShuKSksQ2UoZS5pbmZvKG0sSlNPTi5zdHJpbmdpZnkobikpKSxRKCJ3ZWJTb2NrZXRPbkNsb3NlIGJlZm9yZS1jbGVhbnVwIiksSyhjLmNvbm5lY3Rpb25DbG9zZSx7b3BlblRpbWVzdGFtcDppLm9wZW5UaW1lc3RhbXAsY2xvc2VUaW1lc3RhbXA6RGF0ZS5ub3coKSxjb25uZWN0aW9uRHVyYXRpb246RGF0ZS5ub3coKS1pLm9wZW5UaW1lc3RhbXAsY29kZTpuLmNvZGUscmVhc29uOm4ucmVhc29ufSksbmUodC5wcmltYXJ5KSYmKHQucHJpbWFyeT1udWxsKSxuZSh0LnNlY29uZGFyeSkmJih0LnNlY29uZGFyeT1udWxsKSxvLnJlY29ubmVjdFdlYlNvY2tldCYmKGVlKHQucHJpbWFyeSl8fGVlKHQuc2Vjb25kYXJ5KT9uZSh0LnByaW1hcnkpJiZlZSh0LnNlY29uZGFyeSkmJihDZShlLmluZm8oIltQcmltYXJ5XSBXZWJTb2NrZXQgQ2xlYW5seSBDbG9zZWQiKSksdC5wcmltYXJ5PXQuc2Vjb25kYXJ5LHQuc2Vjb25kYXJ5PW51bGwpOihDZShlLndhcm4oIk5laXRoZXIgcHJpbWFyeSB3ZWJzb2NrZXQgYW5kIG5vciBzZWNvbmRhcnkgd2Vic29ja2V0IGhhdmUgb3BlbiBjb25uZWN0aW9ucywgYXR0ZW1wdGluZyB0byByZS1lc3RhYmxpc2ggY29ubmVjdGlvbiIpKSxvLmNvbm5TdGF0ZT09PVU/Q2UoZS5pbmZvKCJJZ25vcmluZyBjb25uZWN0aW9uTG9zdCBjYWxsYmFjayBpbnZvY2F0aW9uIikpOihLKGMuY29ubmVjdGlvbkxvc3Qse29wZW5UaW1lc3RhbXA6aS5vcGVuVGltZXN0YW1wLGNsb3NlVGltZXN0YW1wOkRhdGUubm93KCksY29ubmVjdGlvbkR1cmF0aW9uOkRhdGUubm93KCktaS5vcGVuVGltZXN0YW1wLGNvZGU6bi5jb2RlLHJlYXNvbjpuLnJlYXNvbn0pLHIubm9PcGVuQ29ubmVjdGlvbnNUaW1lc3RhbXA9RGF0ZS5ub3coKSksby5jb25uU3RhdGU9VSxoZSgpKSxRKCJ3ZWJTb2NrZXRPbkNsb3NlIGFmdGVyLWNsZWFudXAiKSl9KGksbil9KSxufSxDZT1mdW5jdGlvbihlKXtyZXR1cm4gZSYmImZ1bmN0aW9uIj09dHlwZW9mIGUuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXImJmUuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKSxlfTt0aGlzLmluaXQ9ZnVuY3Rpb24obil7aWYoVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwidHJhbnNwb3J0SGFuZGxlIG11c3QgYmUgYSBmdW5jdGlvbiIpLG51bGw9PT1jLmdldFdlYlNvY2tldFRyYW5zcG9ydClyZXR1cm4gYy5nZXRXZWJTb2NrZXRUcmFuc3BvcnQ9bixoZSgpO0NlKGUud2FybigiV2ViIFNvY2tldCBNYW5hZ2VyIHdhcyBhbHJlYWR5IGluaXRpYWxpemVkIikpfSx0aGlzLm9uSW5pdEZhaWx1cmU9ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coSSksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5pbml0RmFpbHVyZS5hZGQobiksby53ZWJzb2NrZXRJbml0RmFpbGVkJiZuKCksZnVuY3Rpb24oKXtyZXR1cm4gYy5pbml0RmFpbHVyZS5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbk9wZW49ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coTiksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uT3Blbi5hZGQobiksZnVuY3Rpb24oKXtyZXR1cm4gYy5jb25uZWN0aW9uT3Blbi5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbkNsb3NlPWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKF8pLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkNsb3NlLmFkZChuKSxmdW5jdGlvbigpe3JldHVybiBjLmNvbm5lY3Rpb25DbG9zZS5kZWxldGUobil9fSx0aGlzLm9uQ29ubmVjdGlvbkdhaW49ZnVuY3Rpb24obil7cmV0dXJuIGUuYWR2YW5jZWRMb2coRSksVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihuKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5jb25uZWN0aW9uR2Fpbi5hZGQobiksb2UoKSYmbigpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkdhaW4uZGVsZXRlKG4pfX0sdGhpcy5vbkNvbm5lY3Rpb25Mb3N0PWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKEYpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuY29ubmVjdGlvbkxvc3QuYWRkKG4pLG8uY29ublN0YXRlPT09VSYmbigpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuY29ubmVjdGlvbkxvc3QuZGVsZXRlKG4pfX0sdGhpcy5vblN1YnNjcmlwdGlvblVwZGF0ZT1mdW5jdGlvbihlKXtyZXR1cm4gVi5hc3NlcnRUcnVlKFYuaXNGdW5jdGlvbihlKSwiY2IgbXVzdCBiZSBhIGZ1bmN0aW9uIiksYy5zdWJzY3JpcHRpb25VcGRhdGUuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuc3Vic2NyaXB0aW9uVXBkYXRlLmRlbGV0ZShlKX19LHRoaXMub25TdWJzY3JpcHRpb25GYWlsdXJlPWZ1bmN0aW9uKG4pe3JldHVybiBlLmFkdmFuY2VkTG9nKEEpLFYuYXNzZXJ0VHJ1ZShWLmlzRnVuY3Rpb24obiksImNiIG11c3QgYmUgYSBmdW5jdGlvbiIpLGMuc3Vic2NyaXB0aW9uRmFpbHVyZS5hZGQobiksZnVuY3Rpb24oKXtyZXR1cm4gYy5zdWJzY3JpcHRpb25GYWlsdXJlLmRlbGV0ZShuKX19LHRoaXMub25NZXNzYWdlPWZ1bmN0aW9uKGUsbil7cmV0dXJuIFYuYXNzZXJ0Tm90TnVsbChlLCJ0b3BpY05hbWUiKSxWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKG4pLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLnRvcGljLmhhcyhlKT9jLnRvcGljLmdldChlKS5hZGQobik6Yy50b3BpYy5zZXQoZSxuZXcgU2V0KFtuXSkpLGZ1bmN0aW9uKCl7cmV0dXJuIGMudG9waWMuZ2V0KGUpLmRlbGV0ZShuKX19LHRoaXMub25BbGxNZXNzYWdlPWZ1bmN0aW9uKGUpe3JldHVybiBWLmFzc2VydFRydWUoVi5pc0Z1bmN0aW9uKGUpLCJjYiBtdXN0IGJlIGEgZnVuY3Rpb24iKSxjLmFsbE1lc3NhZ2UuYWRkKGUpLGZ1bmN0aW9uKCl7cmV0dXJuIGMuYWxsTWVzc2FnZS5kZWxldGUoZSl9fSx0aGlzLnN1YnNjcmliZVRvcGljcz1mdW5jdGlvbihlKXtWLmFzc2VydE5vdE51bGwoZSwidG9waWNzIiksVi5hc3NlcnRJc0xpc3QoZSksZS5mb3JFYWNoKGZ1bmN0aW9uKGUpe3Euc3Vic2NyaWJlZC5oYXMoZSl8fHEucGVuZGluZy5hZGQoZSl9KSxKLmNvbnNlY3V0aXZlTm9SZXNwb25zZVJlcXVlc3Q9MCxwZSgpfSx0aGlzLnNlbmRNZXNzYWdlPWZ1bmN0aW9uKG4pe2lmKFYuYXNzZXJ0SXNPYmplY3QobiwicGF5bG9hZCIpLHZvaWQgMD09PW4udG9waWN8fFguaGFzKG4udG9waWMpKUNlKGUud2FybigiQ2Fubm90IHNlbmQgbWVzc2FnZSwgSW52YWxpZCB0b3BpYyIsbikpO2Vsc2V7dHJ5e249SlNPTi5zdHJpbmdpZnkobil9Y2F0Y2godCl7cmV0dXJuIHZvaWQgQ2UoZS53YXJuKCJFcnJvciBzdHJpbmdpZnkgbWVzc2FnZSIsbikpfW9lKCk/dGUoKS5zZW5kKG4pOkNlKGUud2FybigiQ2Fubm90IHNlbmQgbWVzc2FnZSwgd2ViIHNvY2tldCBjb25uZWN0aW9uIGlzIG5vdCBvcGVuIikpfX0sdGhpcy5jbG9zZVdlYlNvY2tldD1mdW5jdGlvbigpe2llKCksY2UoKSxvLnJlY29ubmVjdFdlYlNvY2tldD0hMSxjbGVhckludGVydmFsKCQpLGJlKCJVc2VyIHJlcXVlc3QgdG8gY2xvc2UgV2ViU29ja2V0Iil9LHRoaXMudGVybWluYXRlV2ViU29ja2V0TWFuYWdlcj1tZX0sZGU9e2NyZWF0ZTpmdW5jdGlvbigpe3JldHVybiBuZXcgZmV9LHNldEdsb2JhbENvbmZpZzpmdW5jdGlvbihlKXt2YXIgbj1lJiZlLmxvZ2dlckNvbmZpZztzZS51cGRhdGVMb2dnZXJDb25maWcobil9LExvZ0xldmVsOm9lLExvZ2dlcjpuZX19LGZ1bmN0aW9uKGUsbix0KXt2YXIgbzshZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7dmFyIHI9e25vdF9zdHJpbmc6L1tec10vLG5vdF9ib29sOi9bXnRdLyxub3RfdHlwZTovW15UXS8sbm90X3ByaW1pdGl2ZTovW152XS8sbnVtYmVyOi9bZGllZmddLyxudW1lcmljX2FyZzovW2JjZGllZmd1eFhdLyxqc29uOi9bal0vLG5vdF9qc29uOi9bXmpdLyx0ZXh0Oi9eW15ceDI1XSsvLG1vZHVsbzovXlx4MjV7Mn0vLHBsYWNlaG9sZGVyOi9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXildKylcKSk/KFwrKT8oMHwnW14kXSk/KC0pPyhcZCspPyg/OlwuKFxkKykpPyhbYi1naWpvc3RUdXZ4WF0pLyxrZXk6L14oW2Etel9dW2Etel9cZF0qKS9pLGtleV9hY2Nlc3M6L15cLihbYS16X11bYS16X1xkXSopL2ksaW5kZXhfYWNjZXNzOi9eXFsoXGQrKVxdLyxzaWduOi9eWystXS99O2Z1bmN0aW9uIGkoZSl7cmV0dXJuIGZ1bmN0aW9uKGUsbil7dmFyIHQsbyxjLGEscyx1LGwsZixkLHA9MSxnPWUubGVuZ3RoLGI9IiI7Zm9yKG89MDtvPGc7bysrKWlmKCJzdHJpbmciPT10eXBlb2YgZVtvXSliKz1lW29dO2Vsc2UgaWYoIm9iamVjdCI9PXR5cGVvZiBlW29dKXtpZigoYT1lW29dKS5rZXlzKWZvcih0PW5bcF0sYz0wO2M8YS5rZXlzLmxlbmd0aDtjKyspe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKGkoJ1tzcHJpbnRmXSBDYW5ub3QgYWNjZXNzIHByb3BlcnR5ICIlcyIgb2YgdW5kZWZpbmVkIHZhbHVlICIlcyInLGEua2V5c1tjXSxhLmtleXNbYy0xXSkpO3Q9dFthLmtleXNbY11dfWVsc2UgdD1hLnBhcmFtX25vP25bYS5wYXJhbV9ub106bltwKytdO2lmKHIubm90X3R5cGUudGVzdChhLnR5cGUpJiZyLm5vdF9wcmltaXRpdmUudGVzdChhLnR5cGUpJiZ0IGluc3RhbmNlb2YgRnVuY3Rpb24mJih0PXQoKSksci5udW1lcmljX2FyZy50ZXN0KGEudHlwZSkmJiJudW1iZXIiIT10eXBlb2YgdCYmaXNOYU4odCkpdGhyb3cgbmV3IFR5cGVFcnJvcihpKCJbc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJVQiLHQpKTtzd2l0Y2goci5udW1iZXIudGVzdChhLnR5cGUpJiYoZj10Pj0wKSxhLnR5cGUpe2Nhc2UiYiI6dD1wYXJzZUludCh0LDEwKS50b1N0cmluZygyKTticmVhaztjYXNlImMiOnQ9U3RyaW5nLmZyb21DaGFyQ29kZShwYXJzZUludCh0LDEwKSk7YnJlYWs7Y2FzZSJkIjpjYXNlImkiOnQ9cGFyc2VJbnQodCwxMCk7YnJlYWs7Y2FzZSJqIjp0PUpTT04uc3RyaW5naWZ5KHQsbnVsbCxhLndpZHRoP3BhcnNlSW50KGEud2lkdGgpOjApO2JyZWFrO2Nhc2UiZSI6dD1hLnByZWNpc2lvbj9wYXJzZUZsb2F0KHQpLnRvRXhwb25lbnRpYWwoYS5wcmVjaXNpb24pOnBhcnNlRmxvYXQodCkudG9FeHBvbmVudGlhbCgpO2JyZWFrO2Nhc2UiZiI6dD1hLnByZWNpc2lvbj9wYXJzZUZsb2F0KHQpLnRvRml4ZWQoYS5wcmVjaXNpb24pOnBhcnNlRmxvYXQodCk7YnJlYWs7Y2FzZSJnIjp0PWEucHJlY2lzaW9uP1N0cmluZyhOdW1iZXIodC50b1ByZWNpc2lvbihhLnByZWNpc2lvbikpKTpwYXJzZUZsb2F0KHQpO2JyZWFrO2Nhc2UibyI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZyg4KTticmVhaztjYXNlInMiOnQ9U3RyaW5nKHQpLHQ9YS5wcmVjaXNpb24/dC5zdWJzdHJpbmcoMCxhLnByZWNpc2lvbik6dDticmVhaztjYXNlInQiOnQ9U3RyaW5nKCEhdCksdD1hLnByZWNpc2lvbj90LnN1YnN0cmluZygwLGEucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UiVCI6dD1PYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodCkuc2xpY2UoOCwtMSkudG9Mb3dlckNhc2UoKSx0PWEucHJlY2lzaW9uP3Quc3Vic3RyaW5nKDAsYS5wcmVjaXNpb24pOnQ7YnJlYWs7Y2FzZSJ1Ijp0PXBhcnNlSW50KHQsMTApPj4+MDticmVhaztjYXNlInYiOnQ9dC52YWx1ZU9mKCksdD1hLnByZWNpc2lvbj90LnN1YnN0cmluZygwLGEucHJlY2lzaW9uKTp0O2JyZWFrO2Nhc2UieCI6dD0ocGFyc2VJbnQodCwxMCk+Pj4wKS50b1N0cmluZygxNik7YnJlYWs7Y2FzZSJYIjp0PShwYXJzZUludCh0LDEwKT4+PjApLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpfXIuanNvbi50ZXN0KGEudHlwZSk/Yis9dDooIXIubnVtYmVyLnRlc3QoYS50eXBlKXx8ZiYmIWEuc2lnbj9kPSIiOihkPWY/IisiOiItIix0PXQudG9TdHJpbmcoKS5yZXBsYWNlKHIuc2lnbiwiIikpLHU9YS5wYWRfY2hhcj8iMCI9PT1hLnBhZF9jaGFyPyIwIjphLnBhZF9jaGFyLmNoYXJBdCgxKToiICIsbD1hLndpZHRoLShkK3QpLmxlbmd0aCxzPWEud2lkdGgmJmw+MD91LnJlcGVhdChsKToiIixiKz1hLmFsaWduP2QrdCtzOiIwIj09PXU/ZCtzK3Q6cytkK3QpfXJldHVybiBifShmdW5jdGlvbihlKXtpZihhW2VdKXJldHVybiBhW2VdO3ZhciBuLHQ9ZSxvPVtdLGk9MDtmb3IoO3Q7KXtpZihudWxsIT09KG49ci50ZXh0LmV4ZWModCkpKW8ucHVzaChuWzBdKTtlbHNlIGlmKG51bGwhPT0obj1yLm1vZHVsby5leGVjKHQpKSlvLnB1c2goIiUiKTtlbHNle2lmKG51bGw9PT0obj1yLnBsYWNlaG9sZGVyLmV4ZWModCkpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIHVuZXhwZWN0ZWQgcGxhY2Vob2xkZXIiKTtpZihuWzJdKXtpfD0xO3ZhciBjPVtdLHM9blsyXSx1PVtdO2lmKG51bGw9PT0odT1yLmtleS5leGVjKHMpKSl0aHJvdyBuZXcgU3ludGF4RXJyb3IoIltzcHJpbnRmXSBmYWlsZWQgdG8gcGFyc2UgbmFtZWQgYXJndW1lbnQga2V5Iik7Zm9yKGMucHVzaCh1WzFdKTsiIiE9PShzPXMuc3Vic3RyaW5nKHVbMF0ubGVuZ3RoKSk7KWlmKG51bGwhPT0odT1yLmtleV9hY2Nlc3MuZXhlYyhzKSkpYy5wdXNoKHVbMV0pO2Vsc2V7aWYobnVsbD09PSh1PXIuaW5kZXhfYWNjZXNzLmV4ZWMocykpKXRocm93IG5ldyBTeW50YXhFcnJvcigiW3NwcmludGZdIGZhaWxlZCB0byBwYXJzZSBuYW1lZCBhcmd1bWVudCBrZXkiKTtjLnB1c2godVsxXSl9blsyXT1jfWVsc2UgaXw9MjtpZigzPT09aSl0aHJvdyBuZXcgRXJyb3IoIltzcHJpbnRmXSBtaXhpbmcgcG9zaXRpb25hbCBhbmQgbmFtZWQgcGxhY2Vob2xkZXJzIGlzIG5vdCAoeWV0KSBzdXBwb3J0ZWQiKTtvLnB1c2goe3BsYWNlaG9sZGVyOm5bMF0scGFyYW1fbm86blsxXSxrZXlzOm5bMl0sc2lnbjpuWzNdLHBhZF9jaGFyOm5bNF0sYWxpZ246bls1XSx3aWR0aDpuWzZdLHByZWNpc2lvbjpuWzddLHR5cGU6bls4XX0pfXQ9dC5zdWJzdHJpbmcoblswXS5sZW5ndGgpfXJldHVybiBhW2VdPW99KGUpLGFyZ3VtZW50cyl9ZnVuY3Rpb24gYyhlLG4pe3JldHVybiBpLmFwcGx5KG51bGwsW2VdLmNvbmNhdChufHxbXSkpfXZhciBhPU9iamVjdC5jcmVhdGUobnVsbCk7bi5zcHJpbnRmPWksbi52c3ByaW50Zj1jLCJ1bmRlZmluZWQiIT10eXBlb2Ygd2luZG93JiYod2luZG93LnNwcmludGY9aSx3aW5kb3cudnNwcmludGY9Yyx2b2lkIDA9PT0obz1mdW5jdGlvbigpe3JldHVybntzcHJpbnRmOmksdnNwcmludGY6Y319LmNhbGwobix0LG4sZSkpfHwoZS5leHBvcnRzPW8pKX0oKX0sZnVuY3Rpb24oZSxuLHQpeyJ1c2Ugc3RyaWN0Ijt0LnIobiksZnVuY3Rpb24oZSl7dC5kKG4sIldlYlNvY2tldE1hbmFnZXIiLGZ1bmN0aW9uKCl7cmV0dXJuIHJ9KTt2YXIgbz10KDApO2UuY29ubmVjdD1lLmNvbm5lY3R8fHt9LGNvbm5lY3QuV2ViU29ja2V0TWFuYWdlcj1vLmE7dmFyIHI9by5hfS5jYWxsKHRoaXMsdCgzKSl9LGZ1bmN0aW9uKGUsbil7dmFyIHQ7dD1mdW5jdGlvbigpe3JldHVybiB0aGlzfSgpO3RyeXt0PXR8fG5ldyBGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpfWNhdGNoKGUpeyJvYmplY3QiPT10eXBlb2Ygd2luZG93JiYodD13aW5kb3cpfWUuZXhwb3J0cz10fV0pOwovLyMgc291cmNlTWFwcGluZ1VSTD1hbWF6b24tY29ubmVjdC13ZWJzb2NrZXQtbWFuYWdlci5qcy5tYXAKCgovKioqLyB9KSwKCi8qKiovIDE1MToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIC8vIEhvdyBmcmVxdWVudGx5IHNvZnRwaG9uZSBsb2dzIHNob3VsZCBiZSBjb2xsZWN0ZWQgYW5kIHJlcG9ydGVkIHRvIHNoYXJlZCB3b3JrZXIuCiAgdmFyIFNPRlRQSE9ORV9MT0dfUkVQT1JUX0lOVEVSVkFMX01JTExJUyA9IDUwMDA7CgogIC8vIEhvdyBmcmVxdWVudGx5IGxvZ3Mgc2hvdWxkIGJlIGNvbGxlY3RlZCBhbmQgc2VudCBkb3duc3RyZWFtCiAgdmFyIExPR1NfUkVQT1JUX0lOVEVSVkFMX01JTExJUyA9IDUwMDA7CgogIC8vIFRoZSBkZWZhdWx0IGxvZyByb2xsIGludGVydmFsICgzMG1pbikKICB2YXIgREVGQVVMVF9MT0dfUk9MTF9JTlRFUlZBTCA9IDE4MDAwMDA7CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIGNvbW1vbiBsb2dnaW5nIGxldmVscy4KICAgKi8KICB2YXIgTG9nTGV2ZWwgPSB7CiAgICBURVNUOiAiVEVTVCIsCiAgICBUUkFDRTogIlRSQUNFIiwKICAgIERFQlVHOiAiREVCVUciLAogICAgSU5GTzogIklORk8iLAogICAgTE9HOiAiTE9HIiwKICAgIFdBUk46ICJXQVJOIiwKICAgIEVSUk9SOiAiRVJST1IiLAogICAgQ1JJVElDQUw6ICJDUklUSUNBTCIKICB9OwoKICAvKioKICAgKiBBbiBlbnVtZXJhdGlvbiBvZiBjb21tb24gbG9nZ2luZyBjb21wb25lbnRzLgogICAqLwogIHZhciBMb2dDb21wb25lbnQgPSB7CiAgICBDQ1A6ICJjY3AiLAogICAgU09GVFBIT05FOiAic29mdHBob25lIiwKICAgIENIQVQ6ICJjaGF0IiwKICAgIFRBU0s6ICJ0YXNrIgogIH07CgogIC8qKgogICAqIFRoZSBudW1lcmljIG9yZGVyIG9mIHRoZSBsb2dnaW5nIGxldmVscyBhYm92ZS4KICAgKiBUaGV5IGFyZSBzcGFjZWQgdG8gYWxsb3cgdGhlIGFkZGl0aW9uIG9mIG90aGVyIGxvZwogICAqIGxldmVscyBhdCBhIGxhdGVyIHRpbWUuCiAgICovCiAgdmFyIExvZ0xldmVsT3JkZXIgPSB7CiAgICBURVNUOiAwLAogICAgVFJBQ0U6IDEwLAogICAgREVCVUc6IDIwLAogICAgSU5GTzogMzAsCiAgICBMT0c6IDQwLAogICAgV0FSTjogNTAsCiAgICBFUlJPUjogMTAwLAogICAgQ1JJVElDQUw6IDIwMAoKICB9OwoKICAvKioKICAgKiBBIG1hcCBmcm9tIGxvZyBsZXZlbCB0byBjb25zb2xlIGxvZ2dlciBmdW5jdGlvbi4KICAgKi8KICB2YXIgQ09OU09MRV9MT0dHRVJfTUFQID0gewogICAgVFJBQ0U6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUuaW5mbyh0ZXh0KTsgfSwKICAgIERFQlVHOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmluZm8odGV4dCk7IH0sCiAgICBJTkZPOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmluZm8odGV4dCk7IH0sCiAgICBMT0c6IGZ1bmN0aW9uICh0ZXh0KSB7IGNvbnNvbGUubG9nKHRleHQpOyB9LAogICAgVEVTVDogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5sb2codGV4dCk7IH0sCiAgICBXQVJOOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLndhcm4odGV4dCk7IH0sCiAgICBFUlJPUjogZnVuY3Rpb24gKHRleHQpIHsgY29uc29sZS5lcnJvcih0ZXh0KTsgfSwKICAgIENSSVRJQ0FMOiBmdW5jdGlvbiAodGV4dCkgeyBjb25zb2xlLmVycm9yKHRleHQpOyB9CiAgfTsKCiAgLyoqCiAgKiBDaGVja3MgaWYgaXQgaXMgYSB2YWxpZCBsb2cgY29tcG9uZW50IGVudW0KICAqLwoKICB2YXIgaXNWYWxpZExvZ0NvbXBvbmVudCA9IGZ1bmN0aW9uIChjb21wb25lbnQpIHsKICAgIHJldHVybiBPYmplY3QudmFsdWVzKExvZ0NvbXBvbmVudCkuaW5kZXhPZihjb21wb25lbnQpICE9PSAtMTsKICB9OwoKICAvKioKICAqIEV4dHJhY3QgdGhlIGN1c3RvbSBhcmd1bWVudHMgYXMgcmVxdWlyZWQgYnkgdGhlIGxvZ2dlcgogICovCiAgdmFyIGV4dHJhY3RMb2dnZXJBcmdzID0gZnVuY3Rpb24gKGxvZ2dlckFyZ3MpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwobG9nZ2VyQXJncywgMCk7CiAgICB2YXIgZmlyc3RBcmcgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgZm9ybWF0OwogICAgdmFyIGNvbXBvbmVudDsKCiAgICBpZiAoaXNWYWxpZExvZ0NvbXBvbmVudChmaXJzdEFyZykpIHsKICAgICAgY29tcG9uZW50ID0gZmlyc3RBcmc7CiAgICAgIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vZGVmYXVsdCB0byBDQ1AgY29tcG9uZW50CiAgICAgIGZvcm1hdCA9IGZpcnN0QXJnOwogICAgICBjb21wb25lbnQgPSBMb2dDb21wb25lbnQuQ0NQOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGZvcm1hdDogZm9ybWF0LAogICAgICBjb21wb25lbnQ6IGNvbXBvbmVudCwKICAgICAgYXJnczogYXJncwogICAgfTsKICB9OwoKICAvKioKICAgKiBBIGxvZyBlbnRyeS4KICAgKgogICAqIEBwYXJhbSBjb21wb25lbnQgVGhlIGxvZ2dpbmcgY29tcG9uZW50LgogICAqIEBwYXJhbSBsZXZlbCBUaGUgbG9nIGxldmVsIG9mIHRoaXMgbG9nIGVudHJ5LgogICAqIEBwYXJhbSB0ZXh0IFRoZSB0ZXh0IGNvbnRhaW5lZCBpbiB0aGUgbG9nIGVudHJ5LgogICAqIEBwYXJhbSBsb2dnZXJJZCBUaGUgcm9vdCBsb2dnZXIgaWQuCiAgICoKICAgKiBMb2cgZW50cmllcyBhcmUgYXdhcmUgb2YgdGhlaXIgdGltZXN0YW1wLCBvcmRlciwKICAgKiBhbmQgY2FuIGNvbnRhaW4gb2JqZWN0cyBhbmQgZXhjZXB0aW9uIHN0YWNrIHRyYWNlcy4KICAgKi8KICB2YXIgTG9nRW50cnkgPSBmdW5jdGlvbiAoY29tcG9uZW50LCBsZXZlbCwgdGV4dCwgbG9nZ2VySWQpIHsKICAgIHRoaXMuY29tcG9uZW50ID0gY29tcG9uZW50OwogICAgdGhpcy5sZXZlbCA9IGxldmVsOwogICAgdGhpcy50ZXh0ID0gdGV4dDsKICAgIHRoaXMudGltZSA9IG5ldyBEYXRlKCk7CiAgICB0aGlzLmV4Y2VwdGlvbiA9IG51bGw7CiAgICB0aGlzLm9iamVjdHMgPSBbXTsKICAgIHRoaXMubGluZSA9IDA7CiAgICB0aGlzLmFnZW50UmVzb3VyY2VJZCA9IG51bGw7CiAgICB0cnkgewogICAgICBpZiAoY29ubmVjdC5hZ2VudC5pbml0aWFsaXplZCl7CiAgICAgICAgdGhpcy5hZ2VudFJlc291cmNlSWQgPSBuZXcgY29ubmVjdC5BZ2VudCgpLl9nZXRSZXNvdXJjZUlkKCk7CiAgICAgIH0KICAgIH0gY2F0Y2goZSkgewogICAgICBjb25zb2xlLmxvZygiSXNzdWUgZmluZGluZyBhZ2VudFJlc291cmNlSWQ6ICIsIGUpOyAvL2Nhbid0IHVzZSBvdXIgbG9nZ2VyIGhlcmUgYXMgd2UgbWlnaHQgaW5maW5pdGVseSBhdHRlbXB0IHRvIGxvZyB0aGlzIGVycm9yLgogICAgfQogICAgdGhpcy5sb2dnZXJJZCA9IGxvZ2dlcklkOwogIH07CgogIExvZ0VudHJ5LmZyb21PYmplY3QgPSBmdW5jdGlvbiAob2JqKSB7CiAgICB2YXIgZW50cnkgPSBuZXcgTG9nRW50cnkoTG9nQ29tcG9uZW50LkNDUCwgb2JqLmxldmVsLCBvYmoudGV4dCwgb2JqLmxvZ2dlcklkKTsKCiAgICAvLyBSZXF1aXJlZCB0byBjaGVjayBmb3IgRGF0ZSBvYmplY3RzIHNlbnQgYWNyb3NzIGZyYW1lIGJvdW5kYXJpZXMKICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqLnRpbWUpID09PSAnW29iamVjdCBEYXRlXScpIHsKICAgICAgZW50cnkudGltZSA9IG5ldyBEYXRlKG9iai50aW1lLmdldFRpbWUoKSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmoudGltZSA9PT0gJ251bWJlcicpIHsKICAgICAgZW50cnkudGltZSA9IG5ldyBEYXRlKG9iai50aW1lKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai50aW1lID09PSAnc3RyaW5nJykgewogICAgICBlbnRyeS50aW1lID0gRGF0ZS5wYXJzZShvYmoudGltZSk7CiAgICB9IGVsc2UgewogICAgICBlbnRyeS50aW1lID0gbmV3IERhdGUoKTsKICAgIH0KICAgIGVudHJ5LmV4Y2VwdGlvbiA9IG9iai5leGNlcHRpb247CiAgICBlbnRyeS5vYmplY3RzID0gb2JqLm9iamVjdHM7CiAgICByZXR1cm4gZW50cnk7CiAgfTsKCiAgLyoqCiAgICogUHJpdmF0ZSBtZXRob2QgdG8gcmVtb3ZlIHNlbnNpdGl2ZSBpbmZvIGZyb20gY2xpZW50IGxvZwogICAqLwogIHZhciByZWRhY3RTZW5zaXRpdmVJbmZvID0gZnVuY3Rpb24oZGF0YSkgewogICAgdmFyIGF1dGhUb2tlblJlZ2V4ID0gL0F1dGhUb2tlbi4qXD0vZzsKICAgIGlmKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7CiAgICAgIE9iamVjdC5rZXlzKGRhdGEpLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKHR5cGVvZiBkYXRhW2tleV0gPT09ICdvYmplY3QnKSB7CiAgICAgICAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGRhdGFba2V5XSkKICAgICAgICB9IGVsc2UgaWYodHlwZW9mIGRhdGFba2V5XSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGlmIChrZXkgPT09ICJ1cmwiIHx8IGtleSA9PT0gInRleHQiKSB7CiAgICAgICAgICAgIGRhdGFba2V5XSA9IGRhdGFba2V5XS5yZXBsYWNlKGF1dGhUb2tlblJlZ2V4LCAiW3JlZGFjdGVkXSIpOwogICAgICAgICAgfSBlbHNlIGlmIChbInF1aWNrQ29ubmVjdE5hbWUiXS5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgICAgIGRhdGFba2V5XSA9ICJbcmVkYWN0ZWRdIjsKICAgICAgICAgIH0gZWxzZSBpZiAoWyJjdXN0b21lcklkIiwgIkN1c3RvbWVySWQiLCAiU3BlYWtlcklkIiwgIkN1c3RvbWVyU3BlYWtlcklkIl0uaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICBkYXRhW2tleV0gPSBtZDUoZGF0YVtrZXldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgLyoqCiAgICogUHVsbHMgdGhlIHR5cGUsIG1lc3NhZ2UsIGFuZCBzdGFjayB0cmFjZQogICAqIG91dCBvZiB0aGUgZ2l2ZW4gZXhjZXB0aW9uIGZvciBKU09OIHNlcmlhbGl6YXRpb24uCiAgICovCiAgdmFyIExvZ2dlZEV4Y2VwdGlvbiA9IGZ1bmN0aW9uIChlKSB7CiAgICB0aGlzLnR5cGUgPSAoZSBpbnN0YW5jZW9mIEVycm9yKSA/IGUubmFtZSA6IGUuY29kZSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZSk7CiAgICB0aGlzLm1lc3NhZ2UgPSBlLm1lc3NhZ2U7CiAgICB0aGlzLnN0YWNrID0gW107CiAgICBpZiAoZS5zdGFjayl7CiAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlLnN0YWNrKSkgewogICAgICAgICAgICAgIHRoaXMuc3RhY2sgPSBlLnN0YWNrOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZS5zdGFjayA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICB0aGlzLnN0YWNrID0gW0pTT04uc3RyaW5naWZ5KGUuc3RhY2spXTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGUuc3RhY2sgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgdGhpcy5zdGFjayA9IGUuc3RhY2suc3BsaXQoJ1xuJyk7CiAgICAgICAgICB9CiAgICAgIH0gY2F0Y2gge30KICAgIH0KICB9OwoKICAvKioKICAgKiBNaW5pbWFsbHkgc3RyaW5naWZ5IHRoaXMgbG9nIGVudHJ5IGZvciBwcmludGluZwogICAqIHRvIHRoZSBjb25zb2xlLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBjb25uZWN0LnNwcmludGYoIlslc10gWyVzXSBbJXNdOiAlcyIsCiAgICAgIHRoaXMuZ2V0VGltZSgpICYmIHRoaXMuZ2V0VGltZSgpLnRvSVNPU3RyaW5nID8gdGhpcy5nZXRUaW1lKCkudG9JU09TdHJpbmcoKSA6ICI/Pz8iLAogICAgICB0aGlzLmdldExldmVsKCksCiAgICAgIHRoaXMuZ2V0QWdlbnRSZXNvdXJjZUlkKCksCiAgICAgIHRoaXMuZ2V0VGV4dCgpKTsKICB9OwoKICAvKioKICAgKiBHZXQgdGhlIGxvZyBlbnRyeSB0aW1lc3RhbXAuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldFRpbWUgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy50aW1lOwogIH07CgogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRBZ2VudFJlc291cmNlSWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5hZ2VudFJlc291cmNlSWQ7CiAgfQoKICAvKioKICAgKiBHZXQgdGhlIGxldmVsIG9mIHRoZSBsb2cgZW50cnkuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLmdldExldmVsID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMubGV2ZWw7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsb2cgZW50cnkgdGV4dC4KICAgKi8KICBMb2dFbnRyeS5wcm90b3R5cGUuZ2V0VGV4dCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnRleHQ7CiAgfTsKCiAgLyoqCiAgICogR2V0IHRoZSBsb2cgZW50cnkgY29tcG9uZW50LgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS5nZXRDb21wb25lbnQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5jb21wb25lbnQ7CiAgfTsKCiAgLyoqCiAgICogQWRkIGFuIGV4Y2VwdGlvbiBzdGFjayB0cmFjZSB0byB0aGlzIGxvZyBlbnRyeS4KICAgKiBBIGxvZyBlbnRyeSBtYXkgY29udGFpbiBvbmx5IG9uZSBleGNlcHRpb24gc3RhY2sgdHJhY2UuCiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLndpdGhFeGNlcHRpb24gPSBmdW5jdGlvbiAoZSkgewogICAgdGhpcy5leGNlcHRpb24gPSBuZXcgTG9nZ2VkRXhjZXB0aW9uKGUpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogQWRkIGFuIGFyYml0cmFyeSBvYmplY3QgdG8gdGhlIGxvZyBlbnRyeS4gIEEgbG9nIGVudHJ5CiAgICogbWF5IGNvbnRhaW4gYW55IG51bWJlciBvZiBvYmplY3RzLgogICAqLwogIExvZ0VudHJ5LnByb3RvdHlwZS53aXRoT2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcGllZE9iaiA9IGNvbm5lY3QuZGVlcGNvcHkob2JqKTsKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8oY29waWVkT2JqKTsKICAgIHRoaXMub2JqZWN0cy5wdXNoKGNvcGllZE9iaik7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBBZGQgYSBjcm9zcyBvcmlnaW4gZXZlbnQgb2JqZWN0IHRvIHRoZSBsb2cgZW50cnkuICBBIGxvZyBlbnRyeQogICAqIG1heSBjb250YWluIGFueSBudW1iZXIgb2Ygb2JqZWN0cy4KICAgKi8KICAgTG9nRW50cnkucHJvdG90eXBlLndpdGhDcm9zc09yaWdpbkV2ZW50T2JqZWN0ID0gZnVuY3Rpb24gKG9iaikgewogICAgdmFyIGNvcGllZE9iaiA9IGNvbm5lY3QuZGVlcGNvcHlDcm9zc09yaWdpbkV2ZW50KG9iaik7CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGNvcGllZE9iaik7CiAgICB0aGlzLm9iamVjdHMucHVzaChjb3BpZWRPYmopOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLyoqCiAgICogSW5kaWNhdGUgdGhhdCB0aGlzIGxvZyBlbnRyeSBzaG91bGQgYmUgc2VudCB0byB0aGUgc2VydmVyCiAgICogTk9URTogVGhpcyBzaG91bGQgYmUgdXNlZCBmb3IgaW50ZXJuYWwgbG9ncyBvbmx5CiAgICovCiAgTG9nRW50cnkucHJvdG90eXBlLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyID0gZnVuY3Rpb24gKCkgewogICAgY29ubmVjdC5nZXRMb2coKS5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MucHVzaCh0aGlzKTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIFRoZSBsb2dnZXIgaW5zdGFuY2UuCiAgICovCiAgdmFyIExvZ2dlciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuX2xvZ3MgPSBbXTsKICAgIHRoaXMuX3JvbGxlZExvZ3MgPSBbXTsKICAgIHRoaXMuX2xvZ3NUb1B1c2ggPSBbXTsKICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB0aGlzLl9lY2hvTGV2ZWwgPSBMb2dMZXZlbE9yZGVyLklORk87CiAgICB0aGlzLl9sb2dMZXZlbCA9IExvZ0xldmVsT3JkZXIuSU5GTzsKICAgIHRoaXMuX2xpbmVDb3VudCA9IDA7CiAgICB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwgPSAwOwogICAgdGhpcy5fbG9nUm9sbFRpbWVyID0gbnVsbDsKICAgIHRoaXMuX2xvZ2dlcklkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiLSIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgIHRoaXMuc2V0TG9nUm9sbEludGVydmFsKERFRkFVTFRfTE9HX1JPTExfSU5URVJWQUwpOwogICAgdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaCA9IDA7CiAgfTsKCiAgLyoqCiAgICogU2V0cyB0aGUgaW50ZXJ2YWwgaW4gbWlsbGlzZWNvbmRzIHRoYXQgdGhlIGxvZ3Mgd2lsbCBiZSByb3RhdGVkLgogICAqIExvZ3MgYXJlIHJvdGF0ZWQgb3V0IGNvbXBsZXRlbHkgYXQgdGhlIGVuZCBvZiB0aGUgc2Vjb25kIHJvbGwKICAgKiBhbmQgd2lsbCBldmVudHVhbGx5IGJlIGdhcmJhZ2UgY29sbGVjdGVkLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUuc2V0TG9nUm9sbEludGVydmFsID0gZnVuY3Rpb24gKGludGVydmFsKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgaWYgKCEodGhpcy5fbG9nUm9sbFRpbWVyKSB8fCBpbnRlcnZhbCAhPT0gdGhpcy5fbG9nUm9sbEludGVydmFsKSB7CiAgICAgIGlmICh0aGlzLl9sb2dSb2xsVGltZXIpIHsKICAgICAgICBnbG9iYWwuY2xlYXJJbnRlcnZhbCh0aGlzLl9sb2dSb2xsVGltZXIpOwogICAgICB9CiAgICAgIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCA9IGludGVydmFsOwogICAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBnbG9iYWwuc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgIHNlbGYuX3JvbGxlZExvZ3MgPSBzZWxmLl9sb2dzOwogICAgICAgIHNlbGYuX2xvZ3MgPSBbXTsKICAgICAgICBzZWxmLl9zdGFydExvZ0luZGV4VG9QdXNoID0gMDsKICAgICAgICBzZWxmLmluZm8oIkxvZyByb2xsIGludGVydmFsIG9jY3VycmVkLiIpOwogICAgICB9LCB0aGlzLl9sb2dSb2xsSW50ZXJ2YWwpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy53YXJuKCJMb2dnZXIgaXMgYWxyZWFkeSBzZXQgdG8gdGhlIGdpdmVuIGludGVydmFsOiAlZCIsIHRoaXMuX2xvZ1JvbGxJbnRlcnZhbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2V0IHRoZSBsb2cgbGV2ZWwuICBUaGlzIGlzIHRoZSBtaW5pbXVtIGxldmVsIGF0IHdoaWNoIGxvZ3Mgd2lsbAogICAqIGJlIGtlcHQgZm9yIGxhdGVyIGFyY2hpdmluZy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLnNldExvZ0xldmVsID0gZnVuY3Rpb24gKGxldmVsKSB7CiAgICBpZiAobGV2ZWwgaW4gTG9nTGV2ZWxPcmRlcikgewogICAgICB0aGlzLl9sb2dMZXZlbCA9IExvZ0xldmVsT3JkZXJbbGV2ZWxdOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGxvZ2dpbmcgbGV2ZWw6ICIgKyBsZXZlbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU2V0IHRoZSBlY2hvIGxldmVsLiAgVGhpcyBpcyB0aGUgbWluaW11bSBsZXZlbCBhdCB3aGljaCBsb2dzIHdpbGwKICAgKiBiZSBwcmludGVkIHRvIHRoZSBqYXZhc2NyaXB0IGNvbnNvbGUuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS5zZXRFY2hvTGV2ZWwgPSBmdW5jdGlvbiAobGV2ZWwpIHsKICAgIGlmIChsZXZlbCBpbiBMb2dMZXZlbE9yZGVyKSB7CiAgICAgIHRoaXMuX2VjaG9MZXZlbCA9IExvZ0xldmVsT3JkZXJbbGV2ZWxdOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGxvZ2dpbmcgbGV2ZWw6ICIgKyBsZXZlbCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogV3JpdGUgYSBwYXJ0aWN1bGFyIGxvZyBlbnRyeS4KICAgKgogICAqIEBwYXJhbSBsZXZlbCBUaGUgbG9nZ2luZyBsZXZlbCBvZiB0aGUgZW50cnkuCiAgICogQHBhcmFtIHRleHQgVGhlIHRleHQgY29udGVudHMgb2YgdGhlIGVudHJ5LgogICAqCiAgICogQHJldHVybnMgVGhlIG5ldyBsb2cgZW50cnkuCiAgICovCiAgTG9nZ2VyLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uIChjb21wb25lbnQsIGxldmVsLCB0ZXh0KSB7CiAgICB2YXIgbG9nRW50cnkgPSBuZXcgTG9nRW50cnkoY29tcG9uZW50LCBsZXZlbCwgdGV4dCwgdGhpcy5nZXRMb2dnZXJJZCgpKTsKICAgIHJlZGFjdFNlbnNpdGl2ZUluZm8obG9nRW50cnkpOwogICAgdGhpcy5hZGRMb2dFbnRyeShsb2dFbnRyeSk7CiAgICByZXR1cm4gbG9nRW50cnk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5hZGRMb2dFbnRyeSA9IGZ1bmN0aW9uIChsb2dFbnRyeSkgewogICAgLy8gQ2FsbCB0aGlzIHNlY29uZCB0aW1lIGFzIGluIHNvbWUgcGxhY2VzIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGRpcmVjdGx5CiAgICByZWRhY3RTZW5zaXRpdmVJbmZvKGxvZ0VudHJ5KTsKICAgIHRoaXMuX2xvZ3MucHVzaChsb2dFbnRyeSk7CgogICAgLy9Gb3Igbm93IG9ubHkgc2VuZCBzb2Z0cGhvbmUgbG9ncyBvbmx5LgogICAgLy9UT0RPIGFkZCBDQ1AgbG9ncyBvbmNlIHdlIGFyZSBzdXJlIHRoYXQgbm8gc2Vuc2l0aXZlIGRhdGEgaXMgYmVpbmcgbG9nZ2VkLgogICAgaWYgKExvZ0NvbXBvbmVudC5TT0ZUUEhPTkUgPT09IGxvZ0VudHJ5LmNvbXBvbmVudCkgewogICAgICB0aGlzLl9sb2dzVG9QdXNoLnB1c2gobG9nRW50cnkpOwogICAgfQoKICAgIGlmIChsb2dFbnRyeS5sZXZlbCBpbiBMb2dMZXZlbE9yZGVyICYmCiAgICAgIExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2xvZ0xldmVsKSB7CgogICAgICBpZiAoTG9nTGV2ZWxPcmRlcltsb2dFbnRyeS5sZXZlbF0gPj0gdGhpcy5fZWNob0xldmVsKSB7CiAgICAgICAgQ09OU09MRV9MT0dHRVJfTUFQW2xvZ0VudHJ5LmdldExldmVsKCldKGxvZ0VudHJ5LnRvU3RyaW5nKCkpOwogICAgICB9CgogICAgICBsb2dFbnRyeS5saW5lID0gdGhpcy5fbGluZUNvdW50Kys7CiAgICB9CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zZW5kSW50ZXJuYWxMb2dFbnRyeVRvU2VydmVyID0gZnVuY3Rpb24gKGxvZ0VudHJ5KSB7CiAgICB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5wdXNoKGxvZ0VudHJ5KTsKCiAgICBpZiAobG9nRW50cnkubGV2ZWwgaW4gTG9nTGV2ZWxPcmRlciAmJgogICAgICBMb2dMZXZlbE9yZGVyW2xvZ0VudHJ5LmxldmVsXSA+PSB0aGlzLl9sb2dMZXZlbCkgewoKICAgICAgaWYgKExvZ0xldmVsT3JkZXJbbG9nRW50cnkubGV2ZWxdID49IHRoaXMuX2VjaG9MZXZlbCkgewogICAgICAgIENPTlNPTEVfTE9HR0VSX01BUFtsb2dFbnRyeS5nZXRMZXZlbCgpXShsb2dFbnRyeS50b1N0cmluZygpKTsKICAgICAgfQoKICAgICAgbG9nRW50cnkubGluZSA9IHRoaXMuX2xpbmVDb3VudCsrOwogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgb2JqZWN0cyBmcm9tIGFsbCBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyT2JqZWN0cyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5vYmplY3RzKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xvZ3NbeF0ub2JqZWN0czsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZSBhbGwgZXhjZXB0aW9uIHN0YWNrIHRyYWNlcyBmcm9tIHRoZSBsb2cgZW50cmllcy4KICAgKi8KICBMb2dnZXIucHJvdG90eXBlLmNsZWFyRXhjZXB0aW9ucyA9IGZ1bmN0aW9uICgpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBpZiAodGhpcy5fbG9nc1t4XS5leGNlcHRpb24pIHsKICAgICAgICBkZWxldGUgdGhpcy5fbG9nc1t4XS5leGNlcHRpb247CiAgICAgIH0KICAgIH0KICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRyYWNlID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLlRSQUNFLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmRlYnVnID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLkRFQlVHLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLmluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuSU5GTywgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5sb2cgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuTE9HLCBjb25uZWN0LnZzcHJpbnRmKGxvZ0FyZ3MuZm9ybWF0LCBsb2dBcmdzLmFyZ3MpKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnRlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuVEVTVCwgY29ubmVjdC52c3ByaW50Zihsb2dBcmdzLmZvcm1hdCwgbG9nQXJncy5hcmdzKSk7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS53YXJuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ0FyZ3MgPSBleHRyYWN0TG9nZ2VyQXJncyhhcmd1bWVudHMpOwogICAgcmV0dXJuIHRoaXMud3JpdGUobG9nQXJncy5jb21wb25lbnQsIExvZ0xldmVsLldBUk4sIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuY3JpdGljYWwgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbG9nQXJncyA9IGV4dHJhY3RMb2dnZXJBcmdzKGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy53cml0ZShsb2dBcmdzLmNvbXBvbmVudCwgTG9nTGV2ZWwuRVJST1IsIGNvbm5lY3QudnNwcmludGYobG9nQXJncy5mb3JtYXQsIGxvZ0FyZ3MuYXJncykpOwogIH07CgogIC8qKgogICAqIENyZWF0ZSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgbG9nZ2VyIGNvbnRlbnRzLgogICAqLwogIExvZ2dlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbGluZXMgPSBbXTsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5fbG9ncy5sZW5ndGg7IHgrKykgewogICAgICBsaW5lcy5wdXNoKHRoaXMuX2xvZ3NbeF0udG9TdHJpbmcoKSk7CiAgICB9CgogICAgcmV0dXJuIGxpbmVzLmpvaW4oIlxuIik7CiAgfTsKICAKICAvKioKICAgKiBEb3dubG9hZC9BcmNoaXZlIGxvZ3MgdG8gYSBmaWxlLCAKICAgKiBCeSBkZWZhdWx0LCBpdCByZXR1cm5zIGFsbCBsb2dzLgogICAqIFRvIGZpbHRlciBsb2dzIGJ5IHRoZSBtaW5pbXVtIGxvZyBsZXZlbCBzZXQgYnkgc2V0TG9nTGV2ZWwgb3IgdGhlIGRlZmF1bHQgc2V0IGluIF9sb2dMZXZlbCwgCiAgICogcGFzcyBpbiBmaWx0ZXJCeUxvZ0xldmVsIHRvIHRydWUgaW4gb3B0aW9ucwogICAqIAogICAqIEBwYXJhbSBvcHRpb25zIGRvd25sb2FkIG9wdGlvbnMgW09iamVjdHxTdHJpbmddLiAKICAgKiAtIG9mIHR5cGUgT2JqZWN0OiAKICAgKiAgIHsgbG9nTmFtZTogJ215LWxvZy1uYW1lJywKICAgKiAgICAgZmlsdGVyQnlMb2dMZXZlbDogZmFsc2UsIC8vZG93bmxvYWQgYWxsIGxvZ3MKICAgKiAgIH0KICAgKiAtIG9mIHR5cGUgU3RyaW5nIChmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSksIHRoZSBmaWxlJ3MgbmFtZQogICAqLwogIExvZ2dlci5wcm90b3R5cGUuZG93bmxvYWQgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgbG9nTmFtZSA9ICdhZ2VudC1sb2cnOwogICAgdmFyIGZpbHRlckJ5TG9nTGV2ZWwgPSBmYWxzZTsKCiAgICBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zLmxvZ05hbWUgfHwgbG9nTmFtZTsKICAgICAgZmlsdGVyQnlMb2dMZXZlbCA9IG9wdGlvbnMuZmlsdGVyQnlMb2dMZXZlbCB8fCBmaWx0ZXJCeUxvZ0xldmVsOwogICAgfQogICAgZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7CiAgICAgIGxvZ05hbWUgPSBvcHRpb25zIHx8IGxvZ05hbWU7CiAgICB9CgogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGxvZ3MgPSB0aGlzLl9yb2xsZWRMb2dzLmNvbmNhdCh0aGlzLl9sb2dzKTsKICAgIGlmIChmaWx0ZXJCeUxvZ0xldmVsKSB7CiAgICAgIGxvZ3MgPSBsb2dzLmZpbHRlcihmdW5jdGlvbihlbnRyeSkgewogICAgICAgIHJldHVybiBMb2dMZXZlbE9yZGVyW2VudHJ5LmxldmVsXSA+PSBzZWxmLl9sb2dMZXZlbDsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIGxvZ0Jsb2IgPSBuZXcgZ2xvYmFsLkJsb2IoW0pTT04uc3RyaW5naWZ5KGxvZ3MsIHVuZGVmaW5lZCwgNCldLCBbJ3RleHQvcGxhaW4nXSk7CiAgICB2YXIgZG93bmxvYWRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgdmFyIGxvZ05hbWUgPSBsb2dOYW1lIHx8ICdhZ2VudC1sb2cnOwogICAgZG93bmxvYWRMaW5rLmhyZWYgPSBnbG9iYWwuVVJMLmNyZWF0ZU9iamVjdFVSTChsb2dCbG9iKTsKICAgIGRvd25sb2FkTGluay5kb3dubG9hZCA9IGxvZ05hbWUgKyAnLnR4dCc7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRvd25sb2FkTGluayk7CiAgICBkb3dubG9hZExpbmsuY2xpY2soKTsKICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoZG93bmxvYWRMaW5rKTsKICB9OwoKICBMb2dnZXIucHJvdG90eXBlLnNjaGVkdWxlVXBzdHJlYW1Mb2dQdXNoID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIGlmICghY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQpIHsKICAgICAgY29ubmVjdC51cHN0cmVhbUxvZ1B1c2hTY2hlZHVsZWQgPSB0cnVlOwogICAgICAvKiogU2NoZWR1bGUgcHVzaGluZyBsb2dzIGZyZXF1ZW50bHkgdG8gc2hhcmVkd29ya2VyIHVwc3RyZWFtLCBzaGFyZWR3b3JrZXIgd2lsbCByZXBvcnQgdG8gdGhlIENUSSBiYWNrZW5kKi8KICAgICAgZ2xvYmFsLnNldEludGVydmFsKGNvbm5lY3QuaGl0Y2godGhpcywgdGhpcy5yZXBvcnRNYXN0ZXJMb2dzVXBTdHJlYW0sIGNvbmR1aXQpLCBTT0ZUUEhPTkVfTE9HX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMpOwogICAgfQogIH07CgogIExvZ2dlci5wcm90b3R5cGUucmVwb3J0TWFzdGVyTG9nc1VwU3RyZWFtID0gZnVuY3Rpb24gKGNvbmR1aXQpIHsKICAgIHZhciBsb2dzVG9QdXNoID0gdGhpcy5fbG9nc1RvUHVzaC5zbGljZSgpOwogICAgdGhpcy5fbG9nc1RvUHVzaCA9IFtdOwogICAgY29ubmVjdC5pZk1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MsIGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKGxvZ3NUb1B1c2gubGVuZ3RoID4gMCkgewogICAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlNFTkRfTE9HUywgbG9nc1RvUHVzaCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIExvZ2dlci5wcm90b3R5cGUuc2NoZWR1bGVVcHN0cmVhbU91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1B1c2ggPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnB1c2hPdXRlckNvbnRleHRDQ1BzZXJ2ZXJCb3VuZExvZ3NVcHN0cmVhbSwgY29uZHVpdCksIDEwMDApOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZVVwc3RyZWFtT3V0ZXJDb250ZXh0Q0NQTG9nc1B1c2ggPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnB1c2hPdXRlckNvbnRleHRDQ1BMb2dzVXBzdHJlYW0sIGNvbmR1aXQpLCAxMDAwKTsKICB9CgogIExvZ2dlci5wcm90b3R5cGUucHVzaE91dGVyQ29udGV4dENDUHNlcnZlckJvdW5kTG9nc1Vwc3RyZWFtID0gZnVuY3Rpb24oY29uZHVpdCkgewogICAgaWYgKHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aCA+IDApIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzW2ldLnRleHQgPSB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nc1tpXS50ZXh0OwogICAgICB9CgogICAgICBjb25kdWl0LnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncyk7CiAgICAgIHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzID0gW107CiAgICB9CiAgfQoKICBMb2dnZXIucHJvdG90eXBlLnB1c2hPdXRlckNvbnRleHRDQ1BMb2dzVXBzdHJlYW0gPSBmdW5jdGlvbihjb25kdWl0KSB7CiAgICBmb3IgKHZhciBpID0gdGhpcy5fc3RhcnRMb2dJbmRleFRvUHVzaDsgaSA8IHRoaXMuX2xvZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRoaXMuX2xvZ3NbaV0ubG9nZ2VySWQgIT09IHRoaXMuX2xvZ2dlcklkKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uZHVpdC5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCB0aGlzLl9sb2dzW2ldKTsKICAgIH0KICAgIHRoaXMuX3N0YXJ0TG9nSW5kZXhUb1B1c2ggPSB0aGlzLl9sb2dzLmxlbmd0aDsKICB9CgogIExvZ2dlci5wcm90b3R5cGUuZ2V0TG9nZ2VySWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fbG9nZ2VySWQ7CiAgfTsKCiAgTG9nZ2VyLnByb3RvdHlwZS5zY2hlZHVsZURvd25zdHJlYW1DbGllbnRTaWRlTG9nc1B1c2ggPSBmdW5jdGlvbiAoKSB7CiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwoY29ubmVjdC5oaXRjaCh0aGlzLCB0aGlzLnB1c2hDbGllbnRTaWRlTG9nc0Rvd25zdHJlYW0pLCBMT0dTX1JFUE9SVF9JTlRFUlZBTF9NSUxMSVMpOwogIH0KCiAgTG9nZ2VyLnByb3RvdHlwZS5wdXNoQ2xpZW50U2lkZUxvZ3NEb3duc3RyZWFtID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvZ3MgPSBbXTsKCiAgICAvLyBXZSBkbyBub3Qgc2VuZCBhIHJlcXVlc3QgaWYgd2UgaGF2ZSBsZXNzIHRoYW4gNTAgcmVjb3JkcyBzbyB0aGF0IHdlIG1pbmltaXplIHRoZSBudW1iZXIgb2YKICAgIC8vIHJlcXVlc3RzIHBlciBzZWNvbmQuIAogICAgLy8gNTAwIGlzIHRoZSBtYXggd2UgYWNjZXB0IG9uIHRoZSBzZXJ2ZXIuIAogICAgLy8gV2UgY2hvc2UgNTAwIGJlY2F1c2UgdGhpcyBpcyB0aGUgbGltaXQgaW1wb3NlZCBieSBGaXJlaG9zZSBmb3IgYSBwdXQgYmF0Y2ggcmVxdWVzdAogICAgaWYgKHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aCA8IDUwKSB7CiAgICAgIHJldHVybjsKICAgIH0gZWxzZSBpZiAodGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MubGVuZ3RoID4gNTAwKSB7CiAgICAgIGxvZ3MgPSB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9ncy5zcGxpY2UoMCwgNTAwKTsKICAgIH0gZWxzZSB7CiAgICAgIGxvZ3MgPSB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nczsKICAgICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICAgIH0KCiAgICBjb25uZWN0LnB1Ymxpc2hDbGllbnRTaWRlTG9ncyhsb2dzKTsKICB9CgogIHZhciBEb3duc3RyZWFtQ29uZHVpdExvZ2dlciA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBMb2dnZXIuY2FsbCh0aGlzKTsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgICAKICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX3B1c2hMb2dzRG93bnN0cmVhbSksCiAgICAgIERvd25zdHJlYW1Db25kdWl0TG9nZ2VyLkxPR19QVVNIX0lOVEVSVkFMKTsKCiAgICAvLyBEaXNhYmxlIGxvZyByb2xsaW5nLCB3ZSB3aWxsIHB1cmdlIG91ciBvd24gbG9ncyBvbmNlIHRoZXkgaGF2ZQogICAgLy8gYmVlbiBwdXNoZWQgZG93bnN0cmVhbS4KICAgIGdsb2JhbC5jbGVhckludGVydmFsKHRoaXMuX2xvZ1JvbGxUaW1lcik7CiAgICB0aGlzLl9sb2dSb2xsVGltZXIgPSBudWxsOwogIH07CiAgLy8gSG93IGZyZXF1ZW50bHkgbG9ncyBzaG91bGQgYmUgY29sbGVjdGVkIGFuZCBkZWxpdmVyZWQgZG93bnN0cmVhbS4KICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5MT0dfUFVTSF9JTlRFUlZBTCA9IDEwMDA7CiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShMb2dnZXIucHJvdG90eXBlKTsKICBEb3duc3RyZWFtQ29uZHVpdExvZ2dlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEb3duc3RyZWFtQ29uZHVpdExvZ2dlcjsKCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLnB1c2hMb2dzRG93bnN0cmVhbSA9IGZ1bmN0aW9uIChsb2dzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBsb2dzLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTE9HLCBsb2cpOwogICAgfSk7CiAgfTsKCiAgRG93bnN0cmVhbUNvbmR1aXRMb2dnZXIucHJvdG90eXBlLl9wdXNoTG9nc0Rvd25zdHJlYW0gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAKICAgIHRoaXMuX2xvZ3MuZm9yRWFjaChmdW5jdGlvbiAobG9nKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5MT0csIGxvZyk7CiAgICB9KTsKICAgIHRoaXMuX2xvZ3MgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NlcnZlckJvdW5kSW50ZXJuYWxMb2dzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRoaXMuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5TRVJWRVJfQk9VTkRfSU5URVJOQUxfTE9HLCB0aGlzLl9zZXJ2ZXJCb3VuZEludGVybmFsTG9nc1tpXSk7CiAgICB9CgogICAgdGhpcy5fc2VydmVyQm91bmRJbnRlcm5hbExvZ3MgPSBbXTsKICB9OwoKICAvKioKICAgKiBXcmFwIGEgZnVuY3Rpb24gd2l0aCB0cnkgY2F0Y2ggYmxvY2sKICAgKi8KICB2YXIgdHJ5Q2F0Y2hXcmFwcGVyTWV0aG9kID0gZnVuY3Rpb24gKGZuKSB7CiAgICB2YXIgd3JhcHBlZGZ1bmN0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAvLyBTaW5jZSB0aGlzIHdyYXBzIExvZ2dlciBjbGFzcywgd2UgY2FuIG9ubHkgcHJpbnQgaXQgaW4gdGhlIGNvbnNvbGUgYW5kIGVhdCBpdC4KICAgICAgICBDT05TT0xFX0xPR0dFUl9NQVAuRVJST1IoZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB3cmFwcGVkZnVuY3Rpb247CiAgfQogIC8qKgogICAqIFRoaXMgaXMgYSB3cmFwcGVyIG1ldGhvZCB0byB3cmFwIGVhY2ggZnVuY3Rpb24KICAgKiBpbiBhbiBvYmplY3Qgd2l0aCB0cnkgY2F0Y2ggYmxvY2suCiAgICovCiAgdmFyIHRyeUNhdGNoV3JhcHBlck9iamVjdCA9IGZ1bmN0aW9uIChvYmopIHsKICAgIGZvciAodmFyIG1ldGhvZCBpbiBvYmopIHsKICAgICAgaWYgKHR5cGVvZihvYmpbbWV0aG9kXSkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBvYmpbbWV0aG9kXSA9IHRyeUNhdGNoV3JhcHBlck1ldGhvZChvYmpbbWV0aG9kXSk7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKiBDcmVhdGUgdGhlIHNpbmdsZXRvbiBsb2dnZXIgaW5zdGFuY2UuICovCiAgY29ubmVjdC5yb290TG9nZ2VyID0gbmV3IExvZ2dlcigpOwogIHRyeUNhdGNoV3JhcHBlck9iamVjdChjb25uZWN0LnJvb3RMb2dnZXIpOwoKCiAgLyoqIEZldGNoIHRoZSBzaW5nbGV0b24gbG9nZ2VyIGluc3RhbmNlLiAqLwogIHZhciBnZXRMb2cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gY29ubmVjdC5yb290TG9nZ2VyOwogIH07CgogIGNvbm5lY3QgPSBjb25uZWN0IHx8IHt9OwogIGNvbm5lY3QuZ2V0TG9nID0gZ2V0TG9nOwogIGNvbm5lY3QuTG9nRW50cnkgPSBMb2dFbnRyeTsKICBjb25uZWN0LkxvZ2dlciA9IExvZ2dlcjsKICBjb25uZWN0LkxvZ0xldmVsID0gTG9nTGV2ZWw7CiAgY29ubmVjdC5Mb2dDb21wb25lbnQgPSBMb2dDb21wb25lbnQ7CiAgY29ubmVjdC5Eb3duc3RyZWFtQ29uZHVpdExvZ2dlciA9IERvd25zdHJlYW1Db25kdWl0TG9nZ2VyOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gMTYzOgovKioqLyAoZnVuY3Rpb24oKSB7CgovKgogKiBKYXZhU2NyaXB0IE1ENQogKiBodHRwczovL2dpdGh1Yi5jb20vYmx1ZWltcC9KYXZhU2NyaXB0LU1ENQogKgogKiBDb3B5cmlnaHQgMjAxMSwgU2ViYXN0aWFuIFRzY2hhbgogKiBodHRwczovL2JsdWVpbXAubmV0CiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZToKICogaHR0cHM6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQKICoKICogQmFzZWQgb24KICogQSBKYXZhU2NyaXB0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBSU0EgRGF0YSBTZWN1cml0eSwgSW5jLiBNRDUgTWVzc2FnZQogKiBEaWdlc3QgQWxnb3JpdGhtLCBhcyBkZWZpbmVkIGluIFJGQyAxMzIxLgogKiBWZXJzaW9uIDIuMiBDb3B5cmlnaHQgKEMpIFBhdWwgSm9obnN0b24gMTk5OSAtIDIwMDkKICogT3RoZXIgY29udHJpYnV0b3JzOiBHcmVnIEhvbHQsIEFuZHJldyBLZXBlcnQsIFlkbmFyLCBMb3N0aW5ldAogKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2UKICogU2VlIGh0dHA6Ly9wYWpob21lLm9yZy51ay9jcnlwdC9tZDUgZm9yIG1vcmUgaW5mby4KICovCgovKiBnbG9iYWwgZGVmaW5lICovCgovKiBlc2xpbnQtZGlzYWJsZSBzdHJpY3QgKi8KCjsoZnVuY3Rpb24gKCQpIHsKICAndXNlIHN0cmljdCcKCXZhciBjdHggPSB0aGlzIHx8IGdsb2JhbFRoaXM7CgogIC8qKgogICAqIEFkZCBpbnRlZ2Vycywgd3JhcHBpbmcgYXQgMl4zMi4KICAgKiBUaGlzIHVzZXMgMTYtYml0IG9wZXJhdGlvbnMgaW50ZXJuYWxseSB0byB3b3JrIGFyb3VuZCBidWdzIGluIGludGVycHJldGVycy4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSB4IEZpcnN0IGludGVnZXIKICAgKiBAcGFyYW0ge251bWJlcn0geSBTZWNvbmQgaW50ZWdlcgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFN1bQogICAqLwogIGZ1bmN0aW9uIHNhZmVBZGQoeCwgeSkgewogICAgdmFyIGxzdyA9ICh4ICYgMHhmZmZmKSArICh5ICYgMHhmZmZmKQogICAgdmFyIG1zdyA9ICh4ID4+IDE2KSArICh5ID4+IDE2KSArIChsc3cgPj4gMTYpCiAgICByZXR1cm4gKG1zdyA8PCAxNikgfCAobHN3ICYgMHhmZmZmKQogIH0KCiAgLyoqCiAgICogQml0d2lzZSByb3RhdGUgYSAzMi1iaXQgbnVtYmVyIHRvIHRoZSBsZWZ0LgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IG51bSAzMi1iaXQgbnVtYmVyCiAgICogQHBhcmFtIHtudW1iZXJ9IGNudCBSb3RhdGlvbiBjb3VudAogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJvdGF0ZWQgbnVtYmVyCiAgICovCiAgZnVuY3Rpb24gYml0Um90YXRlTGVmdChudW0sIGNudCkgewogICAgcmV0dXJuIChudW0gPDwgY250KSB8IChudW0gPj4+ICgzMiAtIGNudCkpCiAgfQoKICAvKioKICAgKiBCYXNpYyBvcGVyYXRpb24gdGhlIGFsZ29yaXRobSB1c2VzLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IHEgcQogICAqIEBwYXJhbSB7bnVtYmVyfSBhIGEKICAgKiBAcGFyYW0ge251bWJlcn0gYiBiCiAgICogQHBhcmFtIHtudW1iZXJ9IHggeAogICAqIEBwYXJhbSB7bnVtYmVyfSBzIHMKICAgKiBAcGFyYW0ge251bWJlcn0gdCB0CiAgICogQHJldHVybnMge251bWJlcn0gUmVzdWx0CiAgICovCiAgZnVuY3Rpb24gbWQ1Y21uKHEsIGEsIGIsIHgsIHMsIHQpIHsKICAgIHJldHVybiBzYWZlQWRkKGJpdFJvdGF0ZUxlZnQoc2FmZUFkZChzYWZlQWRkKGEsIHEpLCBzYWZlQWRkKHgsIHQpKSwgcyksIGIpCiAgfQogIC8qKgogICAqIEJhc2ljIG9wZXJhdGlvbiB0aGUgYWxnb3JpdGhtIHVzZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYSBhCiAgICogQHBhcmFtIHtudW1iZXJ9IGIgYgogICAqIEBwYXJhbSB7bnVtYmVyfSBjIGMKICAgKiBAcGFyYW0ge251bWJlcn0gZCBkCiAgICogQHBhcmFtIHtudW1iZXJ9IHggeAogICAqIEBwYXJhbSB7bnVtYmVyfSBzIHMKICAgKiBAcGFyYW0ge251bWJlcn0gdCB0CiAgICogQHJldHVybnMge251bWJlcn0gUmVzdWx0CiAgICovCiAgZnVuY3Rpb24gbWQ1ZmYoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIG1kNWNtbigoYiAmIGMpIHwgKH5iICYgZCksIGEsIGIsIHgsIHMsIHQpCiAgfQogIC8qKgogICAqIEJhc2ljIG9wZXJhdGlvbiB0aGUgYWxnb3JpdGhtIHVzZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYSBhCiAgICogQHBhcmFtIHtudW1iZXJ9IGIgYgogICAqIEBwYXJhbSB7bnVtYmVyfSBjIGMKICAgKiBAcGFyYW0ge251bWJlcn0gZCBkCiAgICogQHBhcmFtIHtudW1iZXJ9IHggeAogICAqIEBwYXJhbSB7bnVtYmVyfSBzIHMKICAgKiBAcGFyYW0ge251bWJlcn0gdCB0CiAgICogQHJldHVybnMge251bWJlcn0gUmVzdWx0CiAgICovCiAgZnVuY3Rpb24gbWQ1Z2coYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIG1kNWNtbigoYiAmIGQpIHwgKGMgJiB+ZCksIGEsIGIsIHgsIHMsIHQpCiAgfQogIC8qKgogICAqIEJhc2ljIG9wZXJhdGlvbiB0aGUgYWxnb3JpdGhtIHVzZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYSBhCiAgICogQHBhcmFtIHtudW1iZXJ9IGIgYgogICAqIEBwYXJhbSB7bnVtYmVyfSBjIGMKICAgKiBAcGFyYW0ge251bWJlcn0gZCBkCiAgICogQHBhcmFtIHtudW1iZXJ9IHggeAogICAqIEBwYXJhbSB7bnVtYmVyfSBzIHMKICAgKiBAcGFyYW0ge251bWJlcn0gdCB0CiAgICogQHJldHVybnMge251bWJlcn0gUmVzdWx0CiAgICovCiAgZnVuY3Rpb24gbWQ1aGgoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIG1kNWNtbihiIF4gYyBeIGQsIGEsIGIsIHgsIHMsIHQpCiAgfQogIC8qKgogICAqIEJhc2ljIG9wZXJhdGlvbiB0aGUgYWxnb3JpdGhtIHVzZXMuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYSBhCiAgICogQHBhcmFtIHtudW1iZXJ9IGIgYgogICAqIEBwYXJhbSB7bnVtYmVyfSBjIGMKICAgKiBAcGFyYW0ge251bWJlcn0gZCBkCiAgICogQHBhcmFtIHtudW1iZXJ9IHggeAogICAqIEBwYXJhbSB7bnVtYmVyfSBzIHMKICAgKiBAcGFyYW0ge251bWJlcn0gdCB0CiAgICogQHJldHVybnMge251bWJlcn0gUmVzdWx0CiAgICovCiAgZnVuY3Rpb24gbWQ1aWkoYSwgYiwgYywgZCwgeCwgcywgdCkgewogICAgcmV0dXJuIG1kNWNtbihjIF4gKGIgfCB+ZCksIGEsIGIsIHgsIHMsIHQpCiAgfQoKICAvKioKICAgKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhbiBhcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzLCBhbmQgYSBiaXQgbGVuZ3RoLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0geCBBcnJheSBvZiBsaXR0bGUtZW5kaWFuIHdvcmRzCiAgICogQHBhcmFtIHtudW1iZXJ9IGxlbiBCaXQgbGVuZ3RoCiAgICogQHJldHVybnMge0FycmF5PG51bWJlcj59IE1ENSBBcnJheQogICAqLwogIGZ1bmN0aW9uIGJpbmxNRDUoeCwgbGVuKSB7CiAgICAvKiBhcHBlbmQgcGFkZGluZyAqLwogICAgeFtsZW4gPj4gNV0gfD0gMHg4MCA8PCBsZW4gJSAzMgogICAgeFsoKChsZW4gKyA2NCkgPj4+IDkpIDw8IDQpICsgMTRdID0gbGVuCgogICAgdmFyIGkKICAgIHZhciBvbGRhCiAgICB2YXIgb2xkYgogICAgdmFyIG9sZGMKICAgIHZhciBvbGRkCiAgICB2YXIgYSA9IDE3MzI1ODQxOTMKICAgIHZhciBiID0gLTI3MTczMzg3OQogICAgdmFyIGMgPSAtMTczMjU4NDE5NAogICAgdmFyIGQgPSAyNzE3MzM4NzgKCiAgICBmb3IgKGkgPSAwOyBpIDwgeC5sZW5ndGg7IGkgKz0gMTYpIHsKICAgICAgb2xkYSA9IGEKICAgICAgb2xkYiA9IGIKICAgICAgb2xkYyA9IGMKICAgICAgb2xkZCA9IGQKCiAgICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2ldLCA3LCAtNjgwODc2OTM2KQogICAgICBkID0gbWQ1ZmYoZCwgYSwgYiwgYywgeFtpICsgMV0sIDEyLCAtMzg5NTY0NTg2KQogICAgICBjID0gbWQ1ZmYoYywgZCwgYSwgYiwgeFtpICsgMl0sIDE3LCA2MDYxMDU4MTkpCiAgICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyAzXSwgMjIsIC0xMDQ0NTI1MzMwKQogICAgICBhID0gbWQ1ZmYoYSwgYiwgYywgZCwgeFtpICsgNF0sIDcsIC0xNzY0MTg4OTcpCiAgICAgIGQgPSBtZDVmZihkLCBhLCBiLCBjLCB4W2kgKyA1XSwgMTIsIDEyMDAwODA0MjYpCiAgICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyA2XSwgMTcsIC0xNDczMjMxMzQxKQogICAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgN10sIDIyLCAtNDU3MDU5ODMpCiAgICAgIGEgPSBtZDVmZihhLCBiLCBjLCBkLCB4W2kgKyA4XSwgNywgMTc3MDAzNTQxNikKICAgICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDldLCAxMiwgLTE5NTg0MTQ0MTcpCiAgICAgIGMgPSBtZDVmZihjLCBkLCBhLCBiLCB4W2kgKyAxMF0sIDE3LCAtNDIwNjMpCiAgICAgIGIgPSBtZDVmZihiLCBjLCBkLCBhLCB4W2kgKyAxMV0sIDIyLCAtMTk5MDQwNDE2MikKICAgICAgYSA9IG1kNWZmKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgNywgMTgwNDYwMzY4MikKICAgICAgZCA9IG1kNWZmKGQsIGEsIGIsIGMsIHhbaSArIDEzXSwgMTIsIC00MDM0MTEwMSkKICAgICAgYyA9IG1kNWZmKGMsIGQsIGEsIGIsIHhbaSArIDE0XSwgMTcsIC0xNTAyMDAyMjkwKQogICAgICBiID0gbWQ1ZmYoYiwgYywgZCwgYSwgeFtpICsgMTVdLCAyMiwgMTIzNjUzNTMyOSkKCiAgICAgIGEgPSBtZDVnZyhhLCBiLCBjLCBkLCB4W2kgKyAxXSwgNSwgLTE2NTc5NjUxMCkKICAgICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDZdLCA5LCAtMTA2OTUwMTYzMikKICAgICAgYyA9IG1kNWdnKGMsIGQsIGEsIGIsIHhbaSArIDExXSwgMTQsIDY0MzcxNzcxMykKICAgICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaV0sIDIwLCAtMzczODk3MzAyKQogICAgICBhID0gbWQ1Z2coYSwgYiwgYywgZCwgeFtpICsgNV0sIDUsIC03MDE1NTg2OTEpCiAgICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAxMF0sIDksIDM4MDE2MDgzKQogICAgICBjID0gbWQ1Z2coYywgZCwgYSwgYiwgeFtpICsgMTVdLCAxNCwgLTY2MDQ3ODMzNSkKICAgICAgYiA9IG1kNWdnKGIsIGMsIGQsIGEsIHhbaSArIDRdLCAyMCwgLTQwNTUzNzg0OCkKICAgICAgYSA9IG1kNWdnKGEsIGIsIGMsIGQsIHhbaSArIDldLCA1LCA1Njg0NDY0MzgpCiAgICAgIGQgPSBtZDVnZyhkLCBhLCBiLCBjLCB4W2kgKyAxNF0sIDksIC0xMDE5ODAzNjkwKQogICAgICBjID0gbWQ1Z2coYywgZCwgYSwgYiwgeFtpICsgM10sIDE0LCAtMTg3MzYzOTYxKQogICAgICBiID0gbWQ1Z2coYiwgYywgZCwgYSwgeFtpICsgOF0sIDIwLCAxMTYzNTMxNTAxKQogICAgICBhID0gbWQ1Z2coYSwgYiwgYywgZCwgeFtpICsgMTNdLCA1LCAtMTQ0NDY4MTQ2NykKICAgICAgZCA9IG1kNWdnKGQsIGEsIGIsIGMsIHhbaSArIDJdLCA5LCAtNTE0MDM3ODQpCiAgICAgIGMgPSBtZDVnZyhjLCBkLCBhLCBiLCB4W2kgKyA3XSwgMTQsIDE3MzUzMjg0NzMpCiAgICAgIGIgPSBtZDVnZyhiLCBjLCBkLCBhLCB4W2kgKyAxMl0sIDIwLCAtMTkyNjYwNzczNCkKCiAgICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyA1XSwgNCwgLTM3ODU1OCkKICAgICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaSArIDhdLCAxMSwgLTIwMjI1NzQ0NjMpCiAgICAgIGMgPSBtZDVoaChjLCBkLCBhLCBiLCB4W2kgKyAxMV0sIDE2LCAxODM5MDMwNTYyKQogICAgICBiID0gbWQ1aGgoYiwgYywgZCwgYSwgeFtpICsgMTRdLCAyMywgLTM1MzA5NTU2KQogICAgICBhID0gbWQ1aGgoYSwgYiwgYywgZCwgeFtpICsgMV0sIDQsIC0xNTMwOTkyMDYwKQogICAgICBkID0gbWQ1aGgoZCwgYSwgYiwgYywgeFtpICsgNF0sIDExLCAxMjcyODkzMzUzKQogICAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgN10sIDE2LCAtMTU1NDk3NjMyKQogICAgICBiID0gbWQ1aGgoYiwgYywgZCwgYSwgeFtpICsgMTBdLCAyMywgLTEwOTQ3MzA2NDApCiAgICAgIGEgPSBtZDVoaChhLCBiLCBjLCBkLCB4W2kgKyAxM10sIDQsIDY4MTI3OTE3NCkKICAgICAgZCA9IG1kNWhoKGQsIGEsIGIsIGMsIHhbaV0sIDExLCAtMzU4NTM3MjIyKQogICAgICBjID0gbWQ1aGgoYywgZCwgYSwgYiwgeFtpICsgM10sIDE2LCAtNzIyNTIxOTc5KQogICAgICBiID0gbWQ1aGgoYiwgYywgZCwgYSwgeFtpICsgNl0sIDIzLCA3NjAyOTE4OSkKICAgICAgYSA9IG1kNWhoKGEsIGIsIGMsIGQsIHhbaSArIDldLCA0LCAtNjQwMzY0NDg3KQogICAgICBkID0gbWQ1aGgoZCwgYSwgYiwgYywgeFtpICsgMTJdLCAxMSwgLTQyMTgxNTgzNSkKICAgICAgYyA9IG1kNWhoKGMsIGQsIGEsIGIsIHhbaSArIDE1XSwgMTYsIDUzMDc0MjUyMCkKICAgICAgYiA9IG1kNWhoKGIsIGMsIGQsIGEsIHhbaSArIDJdLCAyMywgLTk5NTMzODY1MSkKCiAgICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2ldLCA2LCAtMTk4NjMwODQ0KQogICAgICBkID0gbWQ1aWkoZCwgYSwgYiwgYywgeFtpICsgN10sIDEwLCAxMTI2ODkxNDE1KQogICAgICBjID0gbWQ1aWkoYywgZCwgYSwgYiwgeFtpICsgMTRdLCAxNSwgLTE0MTYzNTQ5MDUpCiAgICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyA1XSwgMjEsIC01NzQzNDA1NSkKICAgICAgYSA9IG1kNWlpKGEsIGIsIGMsIGQsIHhbaSArIDEyXSwgNiwgMTcwMDQ4NTU3MSkKICAgICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDNdLCAxMCwgLTE4OTQ5ODY2MDYpCiAgICAgIGMgPSBtZDVpaShjLCBkLCBhLCBiLCB4W2kgKyAxMF0sIDE1LCAtMTA1MTUyMykKICAgICAgYiA9IG1kNWlpKGIsIGMsIGQsIGEsIHhbaSArIDFdLCAyMSwgLTIwNTQ5MjI3OTkpCiAgICAgIGEgPSBtZDVpaShhLCBiLCBjLCBkLCB4W2kgKyA4XSwgNiwgMTg3MzMxMzM1OSkKICAgICAgZCA9IG1kNWlpKGQsIGEsIGIsIGMsIHhbaSArIDE1XSwgMTAsIC0zMDYxMTc0NCkKICAgICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDZdLCAxNSwgLTE1NjAxOTgzODApCiAgICAgIGIgPSBtZDVpaShiLCBjLCBkLCBhLCB4W2kgKyAxM10sIDIxLCAxMzA5MTUxNjQ5KQogICAgICBhID0gbWQ1aWkoYSwgYiwgYywgZCwgeFtpICsgNF0sIDYsIC0xNDU1MjMwNzApCiAgICAgIGQgPSBtZDVpaShkLCBhLCBiLCBjLCB4W2kgKyAxMV0sIDEwLCAtMTEyMDIxMDM3OSkKICAgICAgYyA9IG1kNWlpKGMsIGQsIGEsIGIsIHhbaSArIDJdLCAxNSwgNzE4Nzg3MjU5KQogICAgICBiID0gbWQ1aWkoYiwgYywgZCwgYSwgeFtpICsgOV0sIDIxLCAtMzQzNDg1NTUxKQoKICAgICAgYSA9IHNhZmVBZGQoYSwgb2xkYSkKICAgICAgYiA9IHNhZmVBZGQoYiwgb2xkYikKICAgICAgYyA9IHNhZmVBZGQoYywgb2xkYykKICAgICAgZCA9IHNhZmVBZGQoZCwgb2xkZCkKICAgIH0KICAgIHJldHVybiBbYSwgYiwgYywgZF0KICB9CgogIC8qKgogICAqIENvbnZlcnQgYW4gYXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcyB0byBhIHN0cmluZwogICAqCiAgICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBpbnB1dCBNRDUgQXJyYXkKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBNRDUgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gYmlubDJyc3RyKGlucHV0KSB7CiAgICB2YXIgaQogICAgdmFyIG91dHB1dCA9ICcnCiAgICB2YXIgbGVuZ3RoMzIgPSBpbnB1dC5sZW5ndGggKiAzMgogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDMyOyBpICs9IDgpIHsKICAgICAgb3V0cHV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoKGlucHV0W2kgPj4gNV0gPj4+IGkgJSAzMikgJiAweGZmKQogICAgfQogICAgcmV0dXJuIG91dHB1dAogIH0KCiAgLyoqCiAgICogQ29udmVydCBhIHJhdyBzdHJpbmcgdG8gYW4gYXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcwogICAqIENoYXJhY3RlcnMgPjI1NSBoYXZlIHRoZWlyIGhpZ2gtYnl0ZSBzaWxlbnRseSBpZ25vcmVkLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlucHV0IFJhdyBpbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7QXJyYXk8bnVtYmVyPn0gQXJyYXkgb2YgbGl0dGxlLWVuZGlhbiB3b3JkcwogICAqLwogIGZ1bmN0aW9uIHJzdHIyYmlubChpbnB1dCkgewogICAgdmFyIGkKICAgIHZhciBvdXRwdXQgPSBbXQogICAgb3V0cHV0WyhpbnB1dC5sZW5ndGggPj4gMikgLSAxXSA9IHVuZGVmaW5lZAogICAgZm9yIChpID0gMDsgaSA8IG91dHB1dC5sZW5ndGg7IGkgKz0gMSkgewogICAgICBvdXRwdXRbaV0gPSAwCiAgICB9CiAgICB2YXIgbGVuZ3RoOCA9IGlucHV0Lmxlbmd0aCAqIDgKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg4OyBpICs9IDgpIHsKICAgICAgb3V0cHV0W2kgPj4gNV0gfD0gKGlucHV0LmNoYXJDb2RlQXQoaSAvIDgpICYgMHhmZikgPDwgaSAlIDMyCiAgICB9CiAgICByZXR1cm4gb3V0cHV0CiAgfQoKICAvKioKICAgKiBDYWxjdWxhdGUgdGhlIE1ENSBvZiBhIHJhdyBzdHJpbmcKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBzIElucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJhdyBNRDUgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gcnN0ck1ENShzKSB7CiAgICByZXR1cm4gYmlubDJyc3RyKGJpbmxNRDUocnN0cjJiaW5sKHMpLCBzLmxlbmd0aCAqIDgpKQogIH0KCiAgLyoqCiAgICogQ2FsY3VsYXRlcyB0aGUgSE1BQy1NRDUgb2YgYSBrZXkgYW5kIHNvbWUgZGF0YSAocmF3IHN0cmluZ3MpCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IEhNQUMga2V5CiAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEgUmF3IGlucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJhdyBNRDUgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gcnN0ckhNQUNNRDUoa2V5LCBkYXRhKSB7CiAgICB2YXIgaQogICAgdmFyIGJrZXkgPSByc3RyMmJpbmwoa2V5KQogICAgdmFyIGlwYWQgPSBbXQogICAgdmFyIG9wYWQgPSBbXQogICAgdmFyIGhhc2gKICAgIGlwYWRbMTVdID0gb3BhZFsxNV0gPSB1bmRlZmluZWQKICAgIGlmIChia2V5Lmxlbmd0aCA+IDE2KSB7CiAgICAgIGJrZXkgPSBiaW5sTUQ1KGJrZXksIGtleS5sZW5ndGggKiA4KQogICAgfQogICAgZm9yIChpID0gMDsgaSA8IDE2OyBpICs9IDEpIHsKICAgICAgaXBhZFtpXSA9IGJrZXlbaV0gXiAweDM2MzYzNjM2CiAgICAgIG9wYWRbaV0gPSBia2V5W2ldIF4gMHg1YzVjNWM1YwogICAgfQogICAgaGFzaCA9IGJpbmxNRDUoaXBhZC5jb25jYXQocnN0cjJiaW5sKGRhdGEpKSwgNTEyICsgZGF0YS5sZW5ndGggKiA4KQogICAgcmV0dXJuIGJpbmwycnN0cihiaW5sTUQ1KG9wYWQuY29uY2F0KGhhc2gpLCA1MTIgKyAxMjgpKQogIH0KCiAgLyoqCiAgICogQ29udmVydCBhIHJhdyBzdHJpbmcgdG8gYSBoZXggc3RyaW5nCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaW5wdXQgUmF3IGlucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IEhleCBlbmNvZGVkIHN0cmluZwogICAqLwogIGZ1bmN0aW9uIHJzdHIyaGV4KGlucHV0KSB7CiAgICB2YXIgaGV4VGFiID0gJzAxMjM0NTY3ODlhYmNkZWYnCiAgICB2YXIgb3V0cHV0ID0gJycKICAgIHZhciB4CiAgICB2YXIgaQogICAgZm9yIChpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgaSArPSAxKSB7CiAgICAgIHggPSBpbnB1dC5jaGFyQ29kZUF0KGkpCiAgICAgIG91dHB1dCArPSBoZXhUYWIuY2hhckF0KCh4ID4+PiA0KSAmIDB4MGYpICsgaGV4VGFiLmNoYXJBdCh4ICYgMHgwZikKICAgIH0KICAgIHJldHVybiBvdXRwdXQKICB9CgogIC8qKgogICAqIEVuY29kZSBhIHN0cmluZyBhcyBVVEYtOAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGlucHV0IElucHV0IHN0cmluZwogICAqIEByZXR1cm5zIHtzdHJpbmd9IFVURjggc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gc3RyMnJzdHJVVEY4KGlucHV0KSB7CiAgICByZXR1cm4gdW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGlucHV0KSkKICB9CgogIC8qKgogICAqIEVuY29kZXMgaW5wdXQgc3RyaW5nIGFzIHJhdyBNRDUgc3RyaW5nCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcyBJbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSYXcgTUQ1IHN0cmluZwogICAqLwogIGZ1bmN0aW9uIHJhd01ENShzKSB7CiAgICByZXR1cm4gcnN0ck1ENShzdHIycnN0clVURjgocykpCiAgfQogIC8qKgogICAqIEVuY29kZXMgaW5wdXQgc3RyaW5nIGFzIEhleCBlbmNvZGVkIHN0cmluZwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHMgSW5wdXQgc3RyaW5nCiAgICogQHJldHVybnMge3N0cmluZ30gSGV4IGVuY29kZWQgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gaGV4TUQ1KHMpIHsKICAgIHJldHVybiByc3RyMmhleChyYXdNRDUocykpCiAgfQogIC8qKgogICAqIENhbGN1bGF0ZXMgdGhlIHJhdyBITUFDLU1ENSBmb3IgdGhlIGdpdmVuIGtleSBhbmQgZGF0YQogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGsgSE1BQyBrZXkKICAgKiBAcGFyYW0ge3N0cmluZ30gZCBJbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSYXcgTUQ1IHN0cmluZwogICAqLwogIGZ1bmN0aW9uIHJhd0hNQUNNRDUoaywgZCkgewogICAgcmV0dXJuIHJzdHJITUFDTUQ1KHN0cjJyc3RyVVRGOChrKSwgc3RyMnJzdHJVVEY4KGQpKQogIH0KICAvKioKICAgKiBDYWxjdWxhdGVzIHRoZSBIZXggZW5jb2RlZCBITUFDLU1ENSBmb3IgdGhlIGdpdmVuIGtleSBhbmQgZGF0YQogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGsgSE1BQyBrZXkKICAgKiBAcGFyYW0ge3N0cmluZ30gZCBJbnB1dCBzdHJpbmcKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSYXcgTUQ1IHN0cmluZwogICAqLwogIGZ1bmN0aW9uIGhleEhNQUNNRDUoaywgZCkgewogICAgcmV0dXJuIHJzdHIyaGV4KHJhd0hNQUNNRDUoaywgZCkpCiAgfQoKICAvKioKICAgKiBDYWxjdWxhdGVzIE1ENSB2YWx1ZSBmb3IgYSBnaXZlbiBzdHJpbmcuCiAgICogSWYgYSBrZXkgaXMgcHJvdmlkZWQsIGNhbGN1bGF0ZXMgdGhlIEhNQUMtTUQ1IHZhbHVlLgogICAqIFJldHVybnMgYSBIZXggZW5jb2RlZCBzdHJpbmcgdW5sZXNzIHRoZSByYXcgYXJndW1lbnQgaXMgZ2l2ZW4uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIElucHV0IHN0cmluZwogICAqIEBwYXJhbSB7c3RyaW5nfSBba2V5XSBITUFDIGtleQogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jhd10gUmF3IG91dHB1dCBzd2l0Y2gKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBNRDUgb3V0cHV0CiAgICovCiAgZnVuY3Rpb24gbWQ1KHN0cmluZywga2V5LCByYXcpIHsKICAgIGlmICgha2V5KSB7CiAgICAgIGlmICghcmF3KSB7CiAgICAgICAgcmV0dXJuIGhleE1ENShzdHJpbmcpCiAgICAgIH0KICAgICAgcmV0dXJuIHJhd01ENShzdHJpbmcpCiAgICB9CiAgICBpZiAoIXJhdykgewogICAgICByZXR1cm4gaGV4SE1BQ01ENShrZXksIHN0cmluZykKICAgIH0KICAgIHJldHVybiByYXdITUFDTUQ1KGtleSwgc3RyaW5nKQogIH0KCgljdHgubWQ1ID0gbWQ1Cn0pKHRoaXMpCgovKioqLyB9KSwKCi8qKiovIDQzOToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICBjb25uZWN0LkNoYXRNZWRpYUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAobWVkaWFJbmZvLCBtZXRhZGF0YSkgewogICAgdmFyIGxvZ2dlciA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICB2YXIgbG9nQ29tcG9uZW50ID0gY29ubmVjdC5Mb2dDb21wb25lbnQuQ0hBVDsKCiAgICB2YXIgY3JlYXRlTWVkaWFJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJDaGF0IG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIpCiAgICAgICAgLndpdGhPYmplY3QobWVkaWFJbmZvKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgY29ubmVjdC5DaGF0U2Vzc2lvbi5zZXRHbG9iYWxDb25maWcoewogICAgICAgIGxvZ2dlckNvbmZpZzogewogICAgICAgICAgbG9nZ2VyOiBsb2dnZXIKICAgICAgICB9LAogICAgICAgIHJlZ2lvbjogbWV0YWRhdGEucmVnaW9uCiAgICAgIH0pOwoKICAgICAgLyoqIENvdWxkIGJlIGFsc28gQ1VTVE9NRVIgLSAgRm9yIG5vdyB3ZSBhcmUgY3JlYXRpbmcgb25seSBBZ2VudCBjb25uZWN0aW9uIG1lZGlhIG9iamVjdCAqLwogICAgICB2YXIgY29udHJvbGxlciA9IGNvbm5lY3QuQ2hhdFNlc3Npb24uY3JlYXRlKHsKICAgICAgICBjaGF0RGV0YWlsczogbWVkaWFJbmZvLAogICAgICAgIHR5cGU6ICJBR0VOVCIsCiAgICAgICAgd2Vic29ja2V0TWFuYWdlcjogY29ubmVjdC5jb3JlLmdldFdlYlNvY2tldE1hbmFnZXIoKQogICAgICB9KTsKICAgICAgCiAgICAgIHRyYWNrQ2hhdENvbm5lY3Rpb25TdGF0dXMoY29udHJvbGxlcik7CiAgICAgIHJldHVybiBjb250cm9sbGVyCiAgICAgICAgLmNvbm5lY3QoKQogICAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gU3VjY2Vzc2Z1bGx5IGVzdGFibGlzaGVkIGZvciBjb250YWN0SWQgJXMiLCBtZWRpYUluZm8uY29udGFjdElkKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiQ2hhdCBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCBmb3IgY29udGFjdCAlcyIsIG1lZGlhSW5mby5jb250YWN0SWQpCiAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGVycm9yKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFNlc3Npb24gZXN0YWJsaXNoZW1lbnQgZmFpbGVkIiwgbWVkaWFJbmZvLmNvbnRhY3RJZCwgZXJyb3IpOwogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBkYXRhKSB7CiAgICAgIGNvbm5lY3QucHVibGlzaE1ldHJpYyh7CiAgICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICAgIGNvbnRhY3RJZDogbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICBkYXRhOiBkYXRhIHx8IG1lZGlhSW5mbwogICAgICB9KTsKICAgIH07CgogICAgdmFyIHRyYWNrQ2hhdENvbm5lY3Rpb25TdGF0dXMgPSBmdW5jdGlvbiAoY29udHJvbGxlcikgewogICAgICBjb250cm9sbGVyLm9uQ29ubmVjdGlvbkJyb2tlbihmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlci5lcnJvcihsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBicm9rZW4iKQogICAgICAgICAgLndpdGhFeGNlcHRpb24oZGF0YSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNoYXQgU2Vzc2lvbiBjb25uZWN0aW9uIGJyb2tlbiIsIGRhdGEpOwogICAgICB9KTsKCiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uRXN0YWJsaXNoZWQoZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJDaGF0IFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2hhdCBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiLCBkYXRhKTsKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZU1lZGlhSW5zdGFuY2UoKTsKICAgICAgfQogICAgfQogIH0KfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDI3OToKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogTGljZW5zZWQgdW5kZXIgdGhlIEFtYXpvbiBTb2Z0d2FyZSBMaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gWW91IG1heSBub3QgdXNlCiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMKICogbG9jYXRlZCBhdAogKgogKiAgICBodHRwOi8vYXdzLmFtYXpvbi5jb20vYXNsLwogKgogKiBvciBpbiB0aGUgImxpY2Vuc2UiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkCiAqIG9uIGFuICJBUyBJUyIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzCiAqIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucwogKiBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwoKICBjb25uZWN0Lk1lZGlhRmFjdG9yeSA9IGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgIC8qKiBjb250cm9sbGVyIGhvbGRlciAqLwogICAgdmFyIG1lZGlhQ29udHJvbGxlcnMgPSB7fTsKICAgIHZhciB0b0JlRGVzdHJveWVkID0gbmV3IFNldCgpOwoKICAgIHZhciBsb2dnZXIgPSBjb25uZWN0LmdldExvZygpOwogICAgdmFyIGxvZ0NvbXBvbmVudCA9IGNvbm5lY3QuTG9nQ29tcG9uZW50LkNIQVQ7CgogICAgdmFyIG1ldGFkYXRhID0gY29ubmVjdC5tZXJnZSh7fSwgcGFyYW1zKSB8fCB7fTsKICAgIG1ldGFkYXRhLnJlZ2lvbiA9ICBtZXRhZGF0YS5yZWdpb24gfHwgInVzLXdlc3QtMiI7IC8vIERlZmF1bHQgaXQgdG8gdXMtd2VzdC0yCgogICAgdmFyIGdldE1lZGlhQ29udHJvbGxlciA9IGZ1bmN0aW9uIChjb25uZWN0aW9uT2JqKSB7CiAgICAgIHZhciBjb25uZWN0aW9uSWQgPSBjb25uZWN0aW9uT2JqLmdldENvbm5lY3Rpb25JZCgpOwogICAgICB2YXIgbWVkaWFJbmZvID0gY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKTsKICAgICAgLyoqIGlmIHdlIGRvIG5vdCBoYXZlIHRoZSBtZWRpYSBpbmZvIHRoZW4ganVzdCByZWplY3QgdGhlIHJlcXVlc3QgKi8KICAgICAgaWYgKCFtZWRpYUluZm8pIHsKICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiTWVkaWEgaW5mbyBkb2VzIG5vdCBleGlzdCBmb3IgYSBtZWRpYSB0eXBlICVzIiwgY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkKICAgICAgICAgIC53aXRoT2JqZWN0KGNvbm5lY3Rpb25PYmopLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJNZWRpYSBpbmZvIGRvZXMgbm90IGV4aXN0IGZvciB0aGlzIGNvbm5lY3Rpb24iKTsKICAgICAgfQoKICAgICAgaWYgKCFtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0pIHsKICAgICAgICBsb2dnZXIuaW5mbyhsb2dDb21wb25lbnQsICJtZWRpYSBjb250cm9sbGVyIG9mIHR5cGUgJXMgaW5pdCIsIGNvbm5lY3Rpb25PYmouZ2V0TWVkaWFUeXBlKCkpCiAgICAgICAgICAud2l0aE9iamVjdChjb25uZWN0aW9uT2JqKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIHN3aXRjaCAoY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkgewogICAgICAgICAgY2FzZSBjb25uZWN0Lk1lZGlhVHlwZS5DSEFUOgogICAgICAgICAgICByZXR1cm4gbWVkaWFDb250cm9sbGVyc1tjb25uZWN0aW9uSWRdID0gbmV3IGNvbm5lY3QuQ2hhdE1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpLCBtZXRhZGF0YSkuZ2V0KCk7CiAgICAgICAgICBjYXNlIGNvbm5lY3QuTWVkaWFUeXBlLlNPRlRQSE9ORToKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LlNvZnRwaG9uZU1lZGlhQ29udHJvbGxlcihjb25uZWN0aW9uT2JqLmdldE1lZGlhSW5mbygpKS5nZXQoKTsKICAgICAgICAgIGNhc2UgY29ubmVjdC5NZWRpYVR5cGUuVEFTSzoKICAgICAgICAgICAgcmV0dXJuIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXSA9IG5ldyBjb25uZWN0LlRhc2tNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iai5nZXRNZWRpYUluZm8oKSkuZ2V0KCk7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBsb2dnZXIuZXJyb3IobG9nQ29tcG9uZW50LCAiVW5yZWNvZ25pemVkIG1lZGlhIHR5cGUgJXMgIiwgY29ubmVjdGlvbk9iai5nZXRNZWRpYVR5cGUoKSkKICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgIH0KICAgIH07CgogICAgLyoqIENoZWNrIGFsbCB0aGUgYWN0aXZlIHN0YXRlcyBmb3IgdGhlIGNvbm5lY3Rpb24gKi8KICAgIHZhciBpZkNvbm5lY3Rpb25BY3RpdmUgPSBmdW5jdGlvbiAoY29ubmVjdGlvbk9iaikgewogICAgICByZXR1cm4gY29ubmVjdGlvbk9iai5pc0FjdGl2ZSgpOwogICAgfTsKCiAgICB2YXIgZ2V0ID0gZnVuY3Rpb24gKGNvbm5lY3Rpb25PYmopIHsKICAgICAgaWYgKGlmQ29ubmVjdGlvbkFjdGl2ZShjb25uZWN0aW9uT2JqKSkgewogICAgICAgIHJldHVybiBnZXRNZWRpYUNvbnRyb2xsZXIoY29ubmVjdGlvbk9iaik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVzdHJveShjb25uZWN0aW9uT2JqLmdldENvbm5lY3Rpb25JZCgpKTsKICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk1lZGlhIENvbnRyb2xsZXIgaXMgbm8gbG9uZ2VyIGF2YWlsYWJsZSBmb3IgdGhpcyBjb25uZWN0aW9uIik7CiAgICAgIH0KICAgIH07CgogICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICAgIGlmIChtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF0gJiYgIXRvQmVEZXN0cm95ZWQuaGFzKGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICJEZXN0cm95aW5nIG1lZGlhQ29udHJvbGxlciBmb3IgJXMiLAogICAgICAgICAgY29ubmVjdGlvbklkCiAgICAgICAgKTsKICAgICAgICB0b0JlRGVzdHJveWVkLmFkZChjb25uZWN0aW9uSWQpOwogICAgICAgIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXQogICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udHJvbGxlci5jbGVhblVwID09PSAiZnVuY3Rpb24iKSBjb250cm9sbGVyLmNsZWFuVXAoKTsKICAgICAgICAgICAgZGVsZXRlIG1lZGlhQ29udHJvbGxlcnNbY29ubmVjdGlvbklkXTsKICAgICAgICAgICAgdG9CZURlc3Ryb3llZC5kZWxldGUoY29ubmVjdGlvbklkKTsKICAgICAgICAgIH0pCiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRlbGV0ZSBtZWRpYUNvbnRyb2xsZXJzW2Nvbm5lY3Rpb25JZF07CiAgICAgICAgICAgIHRvQmVEZXN0cm95ZWQuZGVsZXRlKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gewogICAgICBnZXQ6IGdldCwKICAgICAgZGVzdHJveTogZGVzdHJveQogICAgfTsKICB9Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyA0MTg6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgLy8gVE9ETyBtb3ZlIHNvZnRwaG9uZSBpbXBsZW1lbnRhdGlvbnMgaGVyZSAtIFdpbCBkbyB0aGlzIGZvciBHQQogIGNvbm5lY3QuU29mdHBob25lTWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbykgewogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtZWRpYUluZm8pCiAgICAgIH0KICAgIH0KICB9Cn0pKCk7CgoKLyoqKi8gfSksCgovKioqLyAxODc6Ci8qKiovICgoKSA9PiB7CgovKgogKiBDb3B5cmlnaHQgMjAxNC0yMDE3IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBbWF6b24gU29mdHdhcmUgTGljZW5zZSAodGhlICJMaWNlbnNlIikuIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzCiAqIGxvY2F0ZWQgYXQKICoKICogICAgaHR0cDovL2F3cy5hbWF6b24uY29tL2FzbC8KICoKICogb3IgaW4gdGhlICJsaWNlbnNlIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZAogKiBvbiBhbiAiQVMgSVMiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcwogKiBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMKICogYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLgogKi8KCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKCiAgY29ubmVjdC5UYXNrTWVkaWFDb250cm9sbGVyID0gZnVuY3Rpb24gKG1lZGlhSW5mbykgewogICAgdmFyIGxvZ2dlciA9IGNvbm5lY3QuZ2V0TG9nKCk7CiAgICB2YXIgbG9nQ29tcG9uZW50ID0gY29ubmVjdC5Mb2dDb21wb25lbnQuVEFTSzsKCiAgICB2YXIgY3JlYXRlTWVkaWFJbnN0YW5jZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIsIG1lZGlhSW5mby5jb250YWN0SWQpOwogICAgICBsb2dnZXIKICAgICAgICAuaW5mbyhsb2dDb21wb25lbnQsICJUYXNrIG1lZGlhIGNvbnRyb2xsZXIgaW5pdCIpCiAgICAgICAgLndpdGhPYmplY3QobWVkaWFJbmZvKTsKCiAgICAgIHZhciBjb250cm9sbGVyID0gY29ubmVjdC5UYXNrU2Vzc2lvbi5jcmVhdGUoewogICAgICAgIGNvbnRhY3RJZDogbWVkaWFJbmZvLmNvbnRhY3RJZCwKICAgICAgICBpbml0aWFsQ29udGFjdElkOiBtZWRpYUluZm8uaW5pdGlhbENvbnRhY3RJZCwKICAgICAgICB3ZWJzb2NrZXRNYW5hZ2VyOiBjb25uZWN0LmNvcmUuZ2V0V2ViU29ja2V0TWFuYWdlcigpLAogICAgICB9KTsKCiAgICAgIHRyYWNrVGFza0Nvbm5lY3Rpb25TdGF0dXMoY29udHJvbGxlcik7CgogICAgICByZXR1cm4gY29udHJvbGxlcgogICAgICAgIC5jb25uZWN0KCkKICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbygKICAgICAgICAgICAgbG9nQ29tcG9uZW50LAogICAgICAgICAgICAiVGFzayBTZXNzaW9uIFN1Y2Nlc3NmdWxseSBlc3RhYmxpc2hlZCBmb3IgY29udGFjdElkICVzIiwKICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgKICAgICAgICAgICAgIlRhc2sgU2Vzc2lvbiBTdWNjZXNzZnVsbHkgZXN0YWJsaXNoZWQiLAogICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkCiAgICAgICAgICApOwogICAgICAgICAgcmV0dXJuIGNvbnRyb2xsZXI7CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICBsb2dnZXIKICAgICAgICAgICAgLmVycm9yKAogICAgICAgICAgICAgIGxvZ0NvbXBvbmVudCwKICAgICAgICAgICAgICAiVGFzayBTZXNzaW9uIGVzdGFibGlzaGVtZW50IGZhaWxlZCBmb3IgY29udGFjdCAlcyIsCiAgICAgICAgICAgICAgbWVkaWFJbmZvLmNvbnRhY3RJZAogICAgICAgICAgICApCiAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGVycm9yKTsKICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgKICAgICAgICAgICAgIkNoYXQgU2Vzc2lvbiBlc3RhYmxpc2hlbWVudCBmYWlsZWQiLAogICAgICAgICAgICBtZWRpYUluZm8uY29udGFjdElkLAogICAgICAgICAgICBlcnJvcgogICAgICAgICAgKTsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgcHVibGlzaFRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LnB1Ymxpc2hNZXRyaWMoewogICAgICAgIG5hbWU6IGV2ZW50TmFtZSwKICAgICAgICBjb250YWN0SWQ6IG1lZGlhSW5mby5jb250YWN0SWQsCiAgICAgICAgZGF0YTogZGF0YSB8fCBtZWRpYUluZm8sCiAgICAgIH0pOwogICAgfTsKCiAgICB2YXIgdHJhY2tUYXNrQ29ubmVjdGlvblN0YXR1cyA9IGZ1bmN0aW9uIChjb250cm9sbGVyKSB7CiAgICAgIGNvbnRyb2xsZXIub25Db25uZWN0aW9uQnJva2VuKGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgbG9nZ2VyCiAgICAgICAgICAuZXJyb3IobG9nQ29tcG9uZW50LCAiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIikKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGRhdGEpOwogICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gYnJva2VuIiwgZGF0YSk7CiAgICAgIH0pOwoKICAgICAgY29udHJvbGxlci5vbkNvbm5lY3Rpb25Fc3RhYmxpc2hlZChmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGxvZ2dlcgogICAgICAgICAgLmluZm8obG9nQ29tcG9uZW50LCAiVGFzayBTZXNzaW9uIGNvbm5lY3Rpb24gZXN0YWJsaXNoZWQiKQogICAgICAgICAgLndpdGhPYmplY3QoZGF0YSk7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJUYXNrIFNlc3Npb24gY29ubmVjdGlvbiBlc3RhYmxpc2hlZCIsIGRhdGEpOwogICAgICB9KTsKICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZU1lZGlhSW5zdGFuY2UoKTsKICAgICAgfSwKICAgIH07CiAgfTsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDc0MzoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIHZhciBSaW5ndG9uZUVuZ2luZUJhc2UgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMuX3ByZXZDb250YWN0SWQgPSBudWxsOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChyaW5ndG9uZUNvbmZpZywgInJpbmd0b25lQ29uZmlnIik7CiAgICBpZiAoIXJpbmd0b25lQ29uZmlnLnJpbmd0b25lVXJsKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigicmluZ3RvbmVVcmwgaXMgcmVxdWlyZWQhIik7CiAgICB9CgogICAgaWYgKGdsb2JhbC5BdWRpbyAmJiB0eXBlb2YgZ2xvYmFsLlByb21pc2UgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRoaXMuX3BsYXlhYmxlQXVkaW9Qcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIHNlbGYuX2F1ZGlvID0gbmV3IEF1ZGlvKHJpbmd0b25lQ29uZmlnLnJpbmd0b25lVXJsKTsKICAgICAgICBzZWxmLl9hdWRpby5sb29wID0gdHJ1ZTsKICAgICAgICBzZWxmLl9hdWRpby5hZGRFdmVudExpc3RlbmVyKCJjYW5wbGF5IiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgc2VsZi5fYXVkaW9QbGF5YWJsZSA9IHRydWU7CiAgICAgICAgICByZXNvbHZlKHNlbGYuX2F1ZGlvKTsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgfSBlbHNlIHsKICAgICAgdGhpcy5fYXVkaW8gPSBudWxsOwogICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJVbmFibGUgdG8gcHJvdmlkZSBhIHJpbmd0b25lLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CgogICAgc2VsZi5fZHJpdmVSaW5ndG9uZSgpOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX2RyaXZlUmluZ3RvbmUgPSBmdW5jdGlvbiAoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBpbXBsZW1lbnRlZC4iKTsKICB9OwoKICBSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlLl9zdGFydFJpbmd0b25lID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGlmICh0aGlzLl9hdWRpbykgewogICAgICB0aGlzLl9hdWRpby5wbGF5KCkKICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJSaW5ndG9uZSBQbGF5YmFjayBGYWlsdXJlIiwgY29udGFjdCk7CiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmVycm9yKCJSaW5ndG9uZSBQbGF5YmFjayBGYWlsdXJlIikud2l0aEV4Y2VwdGlvbihlKS53aXRoT2JqZWN0KHtjdXJyZW50U3JjOiBzZWxmLl9hdWRpby5jdXJyZW50U3JjLCBzaW5rSWQ6IHNlbGYuX2F1ZGlvLnNpbmtJZCwgdm9sdW1lOiBzZWxmLl9hdWRpby52b2x1bWV9KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0pOwogICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFN0YXJ0IiwgY29udGFjdCk7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiUmluZ3RvbmUgU3RhcnQiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3N0b3BSaW5ndG9uZSA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICBpZiAodGhpcy5fYXVkaW8pIHsKICAgICAgdGhpcy5fYXVkaW8ucGF1c2UoKTsKICAgICAgdGhpcy5fYXVkaW8uY3VycmVudFRpbWUgPSAwOwogICAgICB0aGlzLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIFN0b3AiLCBjb250YWN0KTsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJSaW5ndG9uZSBTdG9wIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBTdG9wIHJpbmd0b25lLgogICAqLwogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuc3RvcFJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5fc3RvcFJpbmd0b25lKCk7CiAgfTsKCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5fcmluZ3RvbmVTZXR1cCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LmlmTWFzdGVyKGNvbm5lY3QuTWFzdGVyVG9waWNzLlJJTkdUT05FLCBmdW5jdGlvbiAoKSB7CiAgICAgIHNlbGYuX3N0YXJ0UmluZ3RvbmUoY29udGFjdCk7CiAgICAgIHNlbGYuX3ByZXZDb250YWN0SWQgPSBjb250YWN0LmdldENvbnRhY3RJZCgpOwoKICAgICAgY29udGFjdC5vbkNvbm5lY3RlZChsaWx5LmhpdGNoKHNlbGYsIHNlbGYuX3N0b3BSaW5ndG9uZSkpOwogICAgICBjb250YWN0Lm9uQWNjZXB0ZWQobGlseS5oaXRjaChzZWxmLCBzZWxmLl9zdG9wUmluZ3RvbmUpKTsKICAgICAgY29udGFjdC5vbkVuZGVkKGxpbHkuaGl0Y2goc2VsZiwgc2VsZi5fc3RvcFJpbmd0b25lKSk7CiAgICAgIC8vIEp1c3QgdG8gbWFrZSBzdXJlIHRvIHN0b3AgdGhlIHJpbmd0b25lIGluIGNhc2Ugb2YgdGhlIGZhaWx1cmVzIG9mIHNwZWNpZmljIGNhbGxiYWNrcyhvbkFjY2VwdGVkLG9uQ29ubmVjdGVkKTsKICAgICAgY29udGFjdC5vblJlZnJlc2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICBpZiAoY29udGFjdC5nZXRTdGF0dXMoKS50eXBlICE9PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLkNPTk5FQ1RJTkcgJiYKICAgICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSAhPT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5JTkNPTUlORykgewogICAgICAgICAgc2VsZi5fc3RvcFJpbmd0b25lKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgogIFJpbmd0b25lRW5naW5lQmFzZS5wcm90b3R5cGUuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3QpIHsKICAgIGlmIChjb250YWN0ICYmIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpIHsKICAgICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgICBuYW1lOiBldmVudE5hbWUsCiAgICAgICAgY29udGFjdElkOiBjb250YWN0LmdldENvbnRhY3RJZCgpCiAgICAgIH0pOwogICAgfQogIH07CgogIC8qKgogICAqIENoYW5nZSB0aGUgYXVkaW8gZGV2aWNlIHVzZWQgdG8gcGxheSByaW5ndG9uZS4KICAgKiBJZiBhdWRpbyBlbGVtZW50IGlzIG5vdCBmdWxseSBpbml0aWFsaXplZCwgdGhlIEFQSSB3aWxsIHdhaXQgX2F1ZGlvUGxheWFibGVQcm9taXNlIGZvciAzIHNlY29uZHMgYW5kIGZhaWwgb24gdGltZW91dC4KICAgKiBUaGlzIEFQSSBpcyBzdXBwb3J0ZWQgb25seSBieSBicm93c2VycyB0aGF0IGltcGxlbWVudGVkIEVTNiBQcm9taXNlIGFuZCBodHRwOi8vd3d3LnczLm9yZy9UUi9hdWRpby1vdXRwdXQvCiAgICogUmV0dXJuIGEgUHJvbWlzZSB0aGF0IGluZGljYXRlcyB0aGUgcmVzdWx0IG9mIGNoYW5naW5nIG91dHB1dCBkZXZpY2UuCiAgICovCiAgUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZS5zZXRPdXRwdXREZXZpY2UgPSBmdW5jdGlvbiAoZGV2aWNlSWQpIHsKICAgIGlmICh0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSkgewogICAgICB2YXIgcGxheWFibGVBdWRpb1dpdGhUaW1lb3V0ID0gUHJvbWlzZS5yYWNlKFsKICAgICAgICB0aGlzLl9wbGF5YWJsZUF1ZGlvUHJvbWlzZSwKICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJlamVjdCgiVGltZWQgb3V0IHdhaXRpbmcgZm9yIHBsYXlhYmxlIGF1ZGlvIik7IH0sIDMwMDAvKm1zKi8pOwogICAgICAgIH0pCiAgICAgIF0pOwogICAgICByZXR1cm4gcGxheWFibGVBdWRpb1dpdGhUaW1lb3V0LnRoZW4oZnVuY3Rpb24gKGF1ZGlvKSB7CiAgICAgICAgaWYgKGF1ZGlvKSB7CiAgICAgICAgICBpZiAoYXVkaW8uc2V0U2lua0lkKSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYXVkaW8uc2V0U2lua0lkKGRldmljZUlkKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIk5vdCBzdXBwb3J0ZWQiKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJObyBhdWRpbyBmb3VuZCIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgaWYgKGdsb2JhbC5Qcm9taXNlKSB7CiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgiTm90IGVsaWdpYmxlIHJpbmd0b25lIG93bmVyIik7CiAgICB9CiAgfTsKCiAgdmFyIFZvaWNlUmluZ3RvbmVFbmdpbmUgPSBmdW5jdGlvbiAocmluZ3RvbmVDb25maWcpIHsKICAgIFJpbmd0b25lRW5naW5lQmFzZS5jYWxsKHRoaXMsIHJpbmd0b25lQ29uZmlnKTsKICB9OwogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBWb2ljZVJpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFZvaWNlUmluZ3RvbmVFbmdpbmU7CgogIFZvaWNlUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLlZPSUNFICYmCiAgICAgICAgY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiBjb250YWN0LmlzSW5ib3VuZCgpKSB7CiAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICBzZWxmLl9wdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIlJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uQ29ubmVjdGluZyhvbkNvbnRhY3RDb25uZWN0KTsKICAgIH0pOwoKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuQ09OTkVDVElORykgewogICAgICAgIG9uQ29udGFjdENvbm5lY3QoY29udGFjdCk7CiAgICAgIH0KICAgIH0pOwogIH07CgoKICB2YXIgQ2hhdFJpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQ2hhdFJpbmd0b25lRW5naW5lOwoKICBDaGF0UmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHZhciBvbkNvbnRhY3RDb25uZWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgaWYgKGNvbnRhY3QuZ2V0VHlwZSgpID09PSBsaWx5LkNvbnRhY3RUeXBlLkNIQVQgJiYgY29udGFjdC5pc0luYm91bmQoKSkgewogICAgICAgIHNlbGYuX3Jpbmd0b25lU2V0dXAoY29udGFjdCk7CiAgICAgICAgc2VsZi5fcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDaGF0IFJpbmd0b25lIENvbm5lY3RpbmciLCBjb250YWN0KTsKICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNoYXQgUmluZ3RvbmUgQ29ubmVjdGluZyIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH07CgogICAgY29ubmVjdC5jb250YWN0KGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGNvbnRhY3Qub25Db25uZWN0aW5nKG9uQ29udGFjdENvbm5lY3QpOwogICAgfSk7CiAgfTsKCiAgdmFyIFRhc2tSaW5ndG9uZUVuZ2luZSA9IGZ1bmN0aW9uIChyaW5ndG9uZUNvbmZpZykgewogICAgUmluZ3RvbmVFbmdpbmVCYXNlLmNhbGwodGhpcywgcmluZ3RvbmVDb25maWcpOwogIH07CiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmluZ3RvbmVFbmdpbmVCYXNlLnByb3RvdHlwZSk7CiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFRhc2tSaW5ndG9uZUVuZ2luZTsKCiAgVGFza1Jpbmd0b25lRW5naW5lLnByb3RvdHlwZS5fZHJpdmVSaW5ndG9uZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB2YXIgb25Db250YWN0Q29ubmVjdCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5UQVNLICYmIGNvbnRhY3QuaXNJbmJvdW5kKCkpIHsKICAgICAgICBzZWxmLl9yaW5ndG9uZVNldHVwKGNvbnRhY3QpOwogICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiVGFzayBSaW5ndG9uZSBDb25uZWN0aW5nIiwgY29udGFjdCk7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJUYXNrIFJpbmd0b25lIENvbm5lY3RpbmciKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9OwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uQ29ubmVjdGluZyhvbkNvbnRhY3RDb25uZWN0KTsKICAgIH0pOwogIH07CgoKICB2YXIgUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lID0gZnVuY3Rpb24gKHJpbmd0b25lQ29uZmlnKSB7CiAgICBSaW5ndG9uZUVuZ2luZUJhc2UuY2FsbCh0aGlzLCByaW5ndG9uZUNvbmZpZyk7CiAgfTsKICBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShSaW5ndG9uZUVuZ2luZUJhc2UucHJvdG90eXBlKTsKICBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lOwoKICBRdWV1ZUNhbGxiYWNrUmluZ3RvbmVFbmdpbmUucHJvdG90eXBlLl9kcml2ZVJpbmd0b25lID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIGNvbm5lY3QuY29udGFjdChmdW5jdGlvbiAoY29udGFjdCkgewogICAgICBjb250YWN0Lm9uSW5jb21pbmcoZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChjb250YWN0LmdldFR5cGUoKSA9PT0gbGlseS5Db250YWN0VHlwZS5RVUVVRV9DQUxMQkFDSykgewogICAgICAgICAgc2VsZi5fcmluZ3RvbmVTZXR1cChjb250YWN0KTsKICAgICAgICAgIHNlbGYuX3B1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ2FsbGJhY2sgUmluZ3RvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QpOwogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJDYWxsYmFjayBSaW5ndG9uZSBDb25uZWN0aW5nIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfTsKCiAgLyogZXhwb3J0IGNvbm5lY3QuUmluZ3RvbmVFbmdpbmUgKi8KICBjb25uZWN0LlZvaWNlUmluZ3RvbmVFbmdpbmUgPSBWb2ljZVJpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuQ2hhdFJpbmd0b25lRW5naW5lID0gQ2hhdFJpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuVGFza1Jpbmd0b25lRW5naW5lID0gVGFza1Jpbmd0b25lRW5naW5lOwogIGNvbm5lY3QuUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lID0gUXVldWVDYWxsYmFja1Jpbmd0b25lRW5naW5lOwp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gNjQyOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKICBnbG9iYWwuY2NwVmVyc2lvbiA9ICJWMiI7CgogIHZhciBSVFBKb2JJbnRlcnZhbE1zID0gMTAwMDsKICB2YXIgc3RhdHNSZXBvcnRpbmdKb2JJbnRlcnZhbE1zID0gMzAwMDA7CiAgdmFyIHN0cmVhbUJ1ZmZlclNpemUgPSA1MDA7CiAgdmFyIENhbGxUeXBlTWFwID0ge307CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19PTkxZXSA9ICdBdWRpbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5WSURFT19PTkxZXSA9ICdWaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5BVURJT19WSURFT10gPSAnQXVkaW9WaWRlbyc7CiAgQ2FsbFR5cGVNYXBbY29ubmVjdC5Tb2Z0cGhvbmVDYWxsVHlwZS5OT05FXSA9ICdOb25lJzsKICB2YXIgQVVESU9fSU5QVVQgPSAnYXVkaW9faW5wdXQnOwogIHZhciBBVURJT19PVVRQVVQgPSAnYXVkaW9fb3V0cHV0JzsKCiAgdmFyIE1lZGlhVHlwZU1hcCA9IHt9OwogIE1lZGlhVHlwZU1hcFtjb25uZWN0LkNvbnRhY3RUeXBlLlZPSUNFXSA9ICJWb2ljZSI7CiAgdmFyIFVOS05PV05fTUVESUFfVFlQRSA9ICJVbmtub3duIjsKCiAgdmFyIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogIHZhciBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSB7fTsKICB2YXIgcnRwU3RhdHNKb2IgPSBudWxsOwogIHZhciByZXBvcnRTdGF0c0pvYiA9IG51bGw7CiAgLy9Mb2dnZXIgc3BlY2lmaWMgdG8gc29mdHBob25lLgogIHZhciBsb2dnZXIgPSBudWxsOwogIHZhciBTb2Z0cGhvbmVFcnJvclR5cGVzID0gY29ubmVjdC5Tb2Z0cGhvbmVFcnJvclR5cGVzOwogIHZhciBIQU5HX1VQX01VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbkhhbmdVcCI7CiAgdmFyIE1VTFRJUExFX1NFU1NJT05TX0VWRU5UID0gIk11bHRpU2Vzc2lvbnMiOwoKICB2YXIgbG9jYWxNZWRpYVN0cmVhbSA9IHt9OwoKICB2YXIgc29mdHBob25lQ2xpZW50SWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CgogIHZhciByZXF1ZXN0SWNlQWNjZXNzID0gZnVuY3Rpb24gKHRyYW5zcG9ydCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHRyYW5zcG9ydCwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICByZXNvbHZlKGRhdGEuc29mdHBob25lVHJhbnNwb3J0LnNvZnRwaG9uZU1lZGlhQ29ubmVjdGlvbnMpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKHJlYXNvbikgewogICAgICAgICAgaWYgKHJlYXNvbi5tZXNzYWdlICYmIHJlYXNvbi5tZXNzYWdlLmluY2x1ZGVzKCJTb2Z0cGhvbmVDb25uZWN0aW9uTGltaXRCcmVhY2hlZEV4Y2VwdGlvbiIpKSB7CiAgICAgICAgICAgIHB1Ymxpc2hFcnJvcigibXVsdGlwbGVfc29mdHBob25lX2FjdGl2ZV9zZXNzaW9ucyIsICJOdW1iZXIgb2YgYWN0aXZlIHNlc3Npb25zIGFyZSBtb3JlIHRoZW4gYWxsb3dlZCBsaW1pdC4iLCAiIik7CiAgICAgICAgICB9CiAgICAgICAgICByZWplY3QoRXJyb3IoInJlcXVlc3RJY2VBY2Nlc3MgZmFpbGVkIikpOwogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQXV0aGVudGljYXRpb24gZmFpbGVkIHdoaWxlIHJlcXVlc3RJY2VBY2Nlc3MiKSk7CiAgICAgICAgfSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJlamVjdChFcnJvcigiQWNjZXNzIERlbmllZCB3aGlsZSByZXF1ZXN0SWNlQWNjZXNzIikpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9OwoKICB2YXIgU29mdHBob25lTWFuYWdlciA9IGZ1bmN0aW9uIChzb2Z0cGhvbmVQYXJhbXMpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIGxvZ2dlciA9IG5ldyBTb2Z0cGhvbmVMb2dnZXIoY29ubmVjdC5nZXRMb2coKSk7CiAgICBsb2dnZXIuaW5mbygiW1NvZnRwaG9uZSBNYW5hZ2VyXSBzb2Z0cGhvbmUgbWFuYWdlciBpbml0aWFsaXphdGlvbiBoYXMgYmVndW4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgdmFyIHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeTsKICAgIGlmIChjb25uZWN0LlJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeSkgewogICAgICBydGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkgPSBuZXcgY29ubmVjdC5SdGNQZWVyQ29ubmVjdGlvbkZhY3RvcnkobG9nZ2VyLAogICAgICAgIGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCksCiAgICAgICAgc29mdHBob25lQ2xpZW50SWQsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCByZXF1ZXN0SWNlQWNjZXNzLCB7CiAgICAgICAgICB0cmFuc3BvcnRUeXBlOiAic29mdHBob25lIiwKICAgICAgICAgIHNvZnRwaG9uZUNsaWVudElkOiBzb2Z0cGhvbmVDbGllbnRJZAogICAgICAgIH0pLAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgcHVibGlzaEVycm9yKSk7CiAgICB9CiAgICBpZiAoIWlzQnJvd3NlclNvZnRQaG9uZVN1cHBvcnRlZCgpKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIsCiAgICAgICAgIkNvbm5lY3QgZG9lcyBub3Qgc3VwcG9ydCB0aGlzIGJyb3dzZXIuIFNvbWUgZnVuY3Rpb25hbGl0eSBtYXkgbm90IHdvcmsuICIsCiAgICAgICAgIiIpOwogICAgfQogICAgdmFyIGd1bVByb21pc2UgPSBmZXRjaFVzZXJNZWRpYSh7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIkNvbm5lY3Rpdml0eUNoZWNrUmVzdWx0IiwgbnVsbCwgCiAgICAgICAgewogICAgICAgICAgY29ubmVjdGl2aXR5Q2hlY2tUeXBlOiAiTWljcm9waG9uZVBlcm1pc3Npb24iLAogICAgICAgICAgc3RhdHVzOiAiZ3JhbnRlZCIKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVycikgewogICAgICAgIHB1Ymxpc2hFcnJvcihlcnIsICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLCAiIik7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJDb25uZWN0aXZpdHlDaGVja1Jlc3VsdCIsIG51bGwsIAogICAgICAgIHsKICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgIHN0YXR1czogImRlbmllZCIKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICAKICAgIGhhbmRsZVNvZnRQaG9uZU11dGVUb2dnbGUoKTsKICAgIGhhbmRsZVNwZWFrZXJEZXZpY2VDaGFuZ2UoKTsKICAgIGhhbmRsZU1pY3JvcGhvbmVEZXZpY2VDaGFuZ2UoKTsKICAgIG1vbml0b3JNaWNyb3Bob25lUGVybWlzc2lvbigpOwoKICAgIHRoaXMucmluZ3RvbmVFbmdpbmUgPSBudWxsOwogICAgdmFyIHJ0Y1Nlc3Npb25zID0ge307CiAgICAvLyBUcmFja3MgdGhlIGFnZW50IGNvbm5lY3Rpb24gSUQsIHNvIHRoYXQgaWYgdGhlIHNhbWUgY29udGFjdCBnZXRzIHJlLXJvdXRlZCB0byB0aGUgc2FtZSBhZ2VudCwgaXQnbGwgc3RpbGwgc2V0IHVwIHNvZnRwaG9uZQogICAgdmFyIGNhbGxzRGV0ZWN0ZWQgPSB7fTsKICAgIHRoaXMub25Jbml0Q29udGFjdFN1YiA9IHt9OwogICAgdGhpcy5vbkluaXRDb250YWN0U3ViLnVuc3Vic2NyaWJlID0gZnVuY3Rpb24oKSB7fTsKCiAgICAvLyB2YXJpYWJsZXMgZm9yIGZpcmVmb3ggbXVsdGl0YWIKICAgIHZhciBpc1Nlc3Npb25QZW5kaW5nID0gZmFsc2U7CiAgICB2YXIgcGVuZGluZ0NvbnRhY3QgPSBudWxsOwogICAgdmFyIHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA9IG51bGw7CiAgICB2YXIgcG9zdHBvbmVTdGFydGluZ1Nlc3Npb24gPSBmdW5jdGlvbiAoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaXNTZXNzaW9uUGVuZGluZyA9IHRydWU7CiAgICAgIHBlbmRpbmdDb250YWN0ID0gY29udGFjdDsKICAgICAgcGVuZGluZ0FnZW50Q29ubmVjdGlvbklkID0gYWdlbnRDb25uZWN0aW9uSWQ7CiAgICB9CiAgICB2YXIgY2FuY2VsUGVuZGluZ1Nlc3Npb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlzU2Vzc2lvblBlbmRpbmcgPSBmYWxzZTsKICAgICAgcGVuZGluZ0NvbnRhY3QgPSBudWxsOwogICAgICBwZW5kaW5nQWdlbnRDb25uZWN0aW9uSWQgPSBudWxsOwogICAgfQoKICAgIC8vIGhlbHBlciBtZXRob2QgdG8gcHJvdmlkZSBhY2Nlc3MgdG8gcnRjIHNlc3Npb25zCiAgICB0aGlzLmdldFNlc3Npb24gPSBmdW5jdGlvbiAoY29ubmVjdGlvbklkKSB7CiAgICAgIHJldHVybiBydGNTZXNzaW9uc1tjb25uZWN0aW9uSWRdOwogICAgfQoKICAgIHRoaXMucmVwbGFjZUxvY2FsTWVkaWFUcmFjayA9IGZ1bmN0aW9uKGNvbm5lY3Rpb25JZCwgdHJhY2spIHsKICAgICAgdmFyIHN0cmVhbSA9IGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5zdHJlYW07CiAgICAgIGlmKHN0cmVhbSl7CiAgICAgICAgdmFyIG9sZFRyYWNrID0gc3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF07CiAgICAgICAgdHJhY2suZW5hYmxlZCA9IG9sZFRyYWNrLmVuYWJsZWQ7CiAgICAgICAgb2xkVHJhY2suZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5yZW1vdmVUcmFjayhvbGRUcmFjayk7CiAgICAgICAgc3RyZWFtLmFkZFRyYWNrKHRyYWNrKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgaXNDb250YWN0VGVybWluYXRlZCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHJldHVybiBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuRU5ERUQgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuRVJST1IgfHwKICAgICAgICBjb250YWN0LmdldFN0YXR1cygpLnR5cGUgPT09IGNvbm5lY3QuQ29udGFjdFN0YXR1c1R5cGUuTUlTU0VEOwogICAgfTsKCiAgICB2YXIgZGVzdHJveVNlc3Npb24gPSBmdW5jdGlvbiAoYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgaWYgKHJ0Y1Nlc3Npb25zLmhhc093blByb3BlcnR5KGFnZW50Q29ubmVjdGlvbklkKSkgewogICAgICAgIHZhciBzZXNzaW9uID0gcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIC8vIEN1cnJlbnRseSB0aGUgYXNzdW1wdGlvbiBpcyBpdCB3aWxsIHRocm93IGFuIGV4Y2VwdGlvbiBvbmx5IGFuZCBpZiBvbmx5IGl0IGFscmVhZHkgaGFzIGJlZW4gaHVuZyB1cC4KICAgICAgICAvLyBUT0RPOiBVcGRhdGUgb25jZSB0aGUgaGFuZ3VwIEFQSSBkb2VzIG5vdCB0aHJvdyBleGNlcHRpb25zCiAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAgIHNlc3Npb24uaGFuZ3VwKCk7CiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikgewogICAgICAgICAgbGlseS5nZXRMb2coKS53YXJuKCJDbGVhbiB1cCB0aGUgc2Vzc2lvbiBsb2NhbGx5ICIgKyBhZ2VudENvbm5lY3Rpb25JZCwgZXJyLm1lc3NhZ2UpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CgogICAgLy8gV2hlbiBtdWx0aXBsZSBSVEMgc2Vzc2lvbnMgZGV0ZWN0ZWQsIGlnbm9yZSB0aGUgbmV3IGNhbGwgYW5kIGhhbmcgdXAgdGhlIHByZXZpb3VzIHNlc3Npb25zLgogICAgLy8gVE9ETzogVXBkYXRlIHdoZW4gY29ubmVjdC1ydGMgZXhwb3NlcyBhbiBBUEkgdG8gZGV0ZWN0IHNlc3Npb24gc3RhdHVzLgogICAgdmFyIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbnMpIHsKICAgICAgaWYgKE9iamVjdC5rZXlzKHJ0Y1Nlc3Npb25zKS5sZW5ndGggPiAwKSB7CiAgICAgICAgLy8gRXJyb3IhIG91ciBzdGF0ZSBkb2Vzbid0IG1hdGNoLCB0ZWFyIGl0IGFsbCBkb3duLgogICAgICAgIGZvciAodmFyIGNvbm5lY3Rpb25JZCBpbiBydGNTZXNzaW9ucykgewogICAgICAgICAgaWYgKHJ0Y1Nlc3Npb25zLmhhc093blByb3BlcnR5KGNvbm5lY3Rpb25JZCkpIHsKICAgICAgICAgICAgLy8gTG9nIGFuIGVycm9yIGZvciB0aGUgc2Vzc2lvbiB3ZSBhcmUgYWJvdXQgdG8gZW5kLgogICAgICAgICAgICBwdWJsaXNoTXVsdGlwbGVTZXNzaW9uc0V2ZW50KEhBTkdfVVBfTVVMVElQTEVfU0VTU0lPTlNfRVZFTlQsIHJ0Y1Nlc3Npb25zW2Nvbm5lY3Rpb25JZF0uY2FsbElkLCBjb25uZWN0aW9uSWQpOwogICAgICAgICAgICBkZXN0cm95U2Vzc2lvbihjb25uZWN0aW9uSWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImR1cGxpY2F0ZSBzZXNzaW9uIGRldGVjdGVkLCByZWZ1c2luZyB0byBzZXR1cCBuZXcgY29ubmVjdGlvbiIpOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuc3RhcnRTZXNzaW9uID0gZnVuY3Rpb24gKF9jb250YWN0LCBfYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgICAgdmFyIGNvbnRhY3QgPSBpc1Nlc3Npb25QZW5kaW5nID8gcGVuZGluZ0NvbnRhY3QgOiBfY29udGFjdDsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gaXNTZXNzaW9uUGVuZGluZyA/IHBlbmRpbmdBZ2VudENvbm5lY3Rpb25JZCA6IF9hZ2VudENvbm5lY3Rpb25JZDsKICAgICAgaWYgKCFjb250YWN0IHx8ICFhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjYW5jZWxQZW5kaW5nU2Vzc2lvbigpOwogICAgICAKICAgICAgLy8gU2V0IHRvIHRydWUsIHRoaXMgd2lsbCBibG9jayBzdWJzZXF1ZW50IGludm9rZXMgZnJvbSBlbnRlcmluZy4KICAgICAgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gPSB0cnVlOwogICAgICBsb2dnZXIuaW5mbygiU29mdHBob25lIGNhbGwgZGV0ZWN0ZWQ6IiwgImNvbnRhY3RJZCAiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CgogICAgICAvLyBFbnN1cmUgb3VyIHNlc3Npb24gc3RhdGUgbWF0Y2hlcyBvdXIgY29udGFjdCBzdGF0ZSB0byBwcmV2ZW50IGlzc3VlcyBzaG91bGQgd2UgbG9zZSB0cmFjayBvZiBhIGNvbnRhY3QuCiAgICAgIHNhbml0eUNoZWNrQWN0aXZlU2Vzc2lvbnMocnRjU2Vzc2lvbnMpOwoKICAgICAgaWYgKGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgQ29ubmVjdGluZyIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwogICAgICB9CgogICAgICBpbml0aWFsaXplUGFyYW1zKCk7CiAgICAgIHZhciBzb2Z0cGhvbmVJbmZvID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgICAgdmFyIGNhbGxDb25maWcgPSBwYXJzZUNhbGxDb25maWcoc29mdHBob25lSW5mby5jYWxsQ29uZmlnSnNvbik7CiAgICAgIHZhciB3ZWJTb2NrZXRQcm92aWRlcjsKICAgICAgaWYgKGNhbGxDb25maWcudXNlV2ViU29ja2V0UHJvdmlkZXIpIHsKICAgICAgICB3ZWJTb2NrZXRQcm92aWRlciA9IGNvbm5lY3QuY29yZS5nZXRXZWJTb2NrZXRNYW5hZ2VyKCk7CiAgICAgIH0KICAgICAgdmFyIHNlc3Npb24gPSBuZXcgY29ubmVjdC5SVENTZXNzaW9uKAogICAgICAgIGNhbGxDb25maWcuc2lnbmFsaW5nRW5kcG9pbnQsCiAgICAgICAgY2FsbENvbmZpZy5pY2VTZXJ2ZXJzLAogICAgICAgIHNvZnRwaG9uZUluZm8uY2FsbENvbnRleHRUb2tlbiwKICAgICAgICBsb2dnZXIsCiAgICAgICAgY29udGFjdC5nZXRDb250YWN0SWQoKSwKICAgICAgICBhZ2VudENvbm5lY3Rpb25JZCwKICAgICAgICB3ZWJTb2NrZXRQcm92aWRlcik7CgogICAgICBydGNTZXNzaW9uc1thZ2VudENvbm5lY3Rpb25JZF0gPSBzZXNzaW9uOwoKICAgICAgaWYgKGNvbm5lY3QuY29yZS5nZXRTb2Z0cGhvbmVVc2VyTWVkaWFTdHJlYW0oKSkgewogICAgICAgIHNlc3Npb24ubWVkaWFTdHJlYW0gPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lVXNlck1lZGlhU3RyZWFtKCk7CiAgICAgIH0KCiAgICAgIC8vIEN1c3RvbSBFdmVudCB0byBpbmRpY2F0ZSB0aGUgc2Vzc2lvbiBpbml0IG9wZXJhdGlvbnMKICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbm5lY3Rpb25FdmVudHMuU0VTU0lPTl9JTklULAogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGNvbm5lY3Rpb25JZDogYWdlbnRDb25uZWN0aW9uSWQKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgc2Vzc2lvbi5vblNlc3Npb25GYWlsZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgcmVhc29uKSB7CiAgICAgICAgZGVsZXRlIHJ0Y1Nlc3Npb25zW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICBkZWxldGUgY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF07CiAgICAgICAgcHVibGlzaFNvZnRwaG9uZUZhaWx1cmVMb2dzKHJ0Y1Nlc3Npb24sIHJlYXNvbik7CiAgICAgICAgcHVibGlzaFNlc3Npb25GYWlsdXJlVGVsZW1ldHJ5RXZlbnQoY29udGFjdC5nZXRDb250YWN0SWQoKSwgcmVhc29uKTsKICAgICAgICBzdG9wSm9ic0FuZFJlcG9ydChjb250YWN0LCBydGNTZXNzaW9uLnNlc3Npb25SZXBvcnQpOwogICAgICB9OwogICAgICBzZXNzaW9uLm9uU2Vzc2lvbkNvbm5lY3RlZCA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICAgICAgcHVibGlzaFRlbGVtZXRyeUV2ZW50KCJTb2Z0cGhvbmUgU2Vzc2lvbiBDb25uZWN0ZWQiLCBjb250YWN0LmdldENvbnRhY3RJZCgpKTsKICAgICAgICAvLyBCZWNvbWUgbWFzdGVyIHRvIHNlbmQgbG9ncywgc2luY2Ugd2UgbmVlZCBsb2dzIGZyb20gc29mdHBob25lIHRhYi4KICAgICAgICBjb25uZWN0LmJlY29tZU1hc3Rlcihjb25uZWN0Lk1hc3RlclRvcGljcy5TRU5EX0xPR1MpOwogICAgICAgIC8vc3RhcnQgc3RhdHMgY29sbGVjdGlvbiBhbmQgcmVwb3J0aW5nIGpvYnMKICAgICAgICBzdGFydFN0YXRzQ29sbGVjdGlvbkpvYihydGNTZXNzaW9uKTsKICAgICAgICBzdGFydFN0YXRzUmVwb3J0aW5nSm9iKGNvbnRhY3QpOwogICAgICAgIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudChjb250YWN0KTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ub25TZXNzaW9uQ29tcGxldGVkID0gZnVuY3Rpb24gKHJ0Y1Nlc3Npb24pIHsKICAgICAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIENvbXBsZXRlZCIsIGNvbnRhY3QuZ2V0Q29udGFjdElkKCkpOwoKICAgICAgICBkZWxldGUgcnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdOwogICAgICAgIGRlbGV0ZSBjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXTsKICAgICAgICAvLyBTdG9wIGFsbCBqb2JzIGFuZCBwZXJmb3JtIG9uZSBsYXN0IGpvYi4KICAgICAgICBzdG9wSm9ic0FuZFJlcG9ydChjb250YWN0LCBydGNTZXNzaW9uLnNlc3Npb25SZXBvcnQpOwoKICAgICAgICAvLyBDbGVhbnVwIHRoZSBjYWNoZWQgc3RyZWFtcwogICAgICAgIGRlbGV0ZUxvY2FsTWVkaWFTdHJlYW0oYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICB9OwoKICAgICAgc2Vzc2lvbi5vbkxvY2FsU3RyZWFtQWRkZWQgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgc3RyZWFtKSB7CiAgICAgICAgLy8gQ2FjaGUgdGhlIHN0cmVhbXMgZm9yIG11dGUvdW5tdXRlCiAgICAgICAgbG9jYWxNZWRpYVN0cmVhbVthZ2VudENvbm5lY3Rpb25JZF0gPSB7CiAgICAgICAgICBzdHJlYW06IHN0cmVhbQogICAgICAgIH07CiAgICAgICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuTE9DQUxfTUVESUFfU1RSRUFNX0NSRUFURUQsCiAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgIGNvbm5lY3Rpb25JZDogYWdlbnRDb25uZWN0aW9uSWQKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIHNlc3Npb24ucmVtb3RlQXVkaW9FbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW90ZS1hdWRpbycpOwogICAgICBpZiAocnRjUGVlckNvbm5lY3Rpb25GYWN0b3J5KSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KHJ0Y1BlZXJDb25uZWN0aW9uRmFjdG9yeS5nZXQoY2FsbENvbmZpZy5pY2VTZXJ2ZXJzKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2Vzc2lvbi5jb25uZWN0KCk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgb25SZWZyZXNoQ29udGFjdCA9IGZ1bmN0aW9uIChjb250YWN0LCBhZ2VudENvbm5lY3Rpb25JZCkgewogICAgICBpZiAocnRjU2Vzc2lvbnNbYWdlbnRDb25uZWN0aW9uSWRdICYmIGlzQ29udGFjdFRlcm1pbmF0ZWQoY29udGFjdCkpIHsKICAgICAgICBkZXN0cm95U2Vzc2lvbihhZ2VudENvbm5lY3Rpb25JZCk7CiAgICAgICAgY2FuY2VsUGVuZGluZ1Nlc3Npb24oKTsKICAgICAgfQogICAgICBpZiAoY29udGFjdC5pc1NvZnRwaG9uZUNhbGwoKSAmJiAhY2FsbHNEZXRlY3RlZFthZ2VudENvbm5lY3Rpb25JZF0gJiYgKAogICAgICAgIGNvbnRhY3QuZ2V0U3RhdHVzKCkudHlwZSA9PT0gY29ubmVjdC5Db250YWN0U3RhdHVzVHlwZS5DT05ORUNUSU5HIHx8CiAgICAgICAgY29udGFjdC5nZXRTdGF0dXMoKS50eXBlID09PSBjb25uZWN0LkNvbnRhY3RTdGF0dXNUeXBlLklOQ09NSU5HKSkgewogICAgICAgICAgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzKCkpIHsKICAgICAgICAgICAgcG9zdHBvbmVTdGFydGluZ1Nlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZi5zdGFydFNlc3Npb24oY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHZhciBvbkluaXRDb250YWN0ID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgdmFyIGFnZW50Q29ubmVjdGlvbklkID0gY29udGFjdC5nZXRBZ2VudENvbm5lY3Rpb24oKS5jb25uZWN0aW9uSWQ7CiAgICAgIGxvZ2dlci5pbmZvKCJDb250YWN0IGRldGVjdGVkOiIsICJjb250YWN0SWQgIiArIGNvbnRhY3QuZ2V0Q29udGFjdElkKCksICJhZ2VudCBjb25uZWN0aW9uSWQgIiArIGFnZW50Q29ubmVjdGlvbklkKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgICAgaWYgKCFjYWxsc0RldGVjdGVkW2FnZW50Q29ubmVjdGlvbklkXSkgewogICAgICAgIGNvbnRhY3Qub25SZWZyZXNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIHNlbGYub25Jbml0Q29udGFjdFN1YiA9IGNvbm5lY3QuY29udGFjdChvbkluaXRDb250YWN0KTsKCiAgICAvLyBDb250YWN0IGFscmVhZHkgaW4gY29ubmVjdGluZyBzdGF0ZSBzY2VuYXJpbyAtIEluIHRoaXMgY2FzZSBjb250YWN0IElOSVQgaXMgbWlzc2VkIGhlbmNlIHRoZSBPblJlZnJlc2ggY2FsbGJhY2sgaXMgbWlzc2VkLiAKICAgIG5ldyBjb25uZWN0LkFnZW50KCkuZ2V0Q29udGFjdHMoKS5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgIHZhciBhZ2VudENvbm5lY3Rpb25JZCA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCkuY29ubmVjdGlvbklkOwogICAgICBsb2dnZXIuaW5mbygiQ29udGFjdCBleGlzdCBpbiB0aGUgc25hcHNob3QuIFJlaW5pdGlhdGUgdGhlIENvbnRhY3QgYW5kIFJUQyBzZXNzaW9uIGNyZWF0aW9uIGZvciBjb250YWN0SWQiICsgY29udGFjdC5nZXRDb250YWN0SWQoKSwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIG9uSW5pdENvbnRhY3QoY29udGFjdCk7CiAgICAgIG9uUmVmcmVzaENvbnRhY3QoY29udGFjdCwgYWdlbnRDb25uZWN0aW9uSWQpOwogICAgfSk7CiAgfTsKCiAgdmFyIGZpcmVDb250YWN0QWNjZXB0ZWRFdmVudCA9IGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICB2YXIgY29uZHVpdCA9IGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpOwogICAgdmFyIGFnZW50Q29ubmVjdGlvbiA9IGNvbnRhY3QuZ2V0QWdlbnRDb25uZWN0aW9uKCk7CiAgICBpZiAoIWFnZW50Q29ubmVjdGlvbikgewogICAgICBsb2dnZXIuaW5mbygiTm90IGFibGUgdG8gcmV0cmlldmUgdGhlIGF1dG8tYWNjZXB0IHNldHRpbmcgZnJvbSBudWxsIEFnZW50Q29ubmVjdGlvbiwgaWdub3JpbmcgZXZlbnQgcHVibGlzaC4uIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHNvZnRwaG9uZU1lZGlhSW5mbyA9IGFnZW50Q29ubmVjdGlvbi5nZXRTb2Z0cGhvbmVNZWRpYUluZm8oKTsKICAgIGlmICghc29mdHBob25lTWVkaWFJbmZvKSB7CiAgICAgIGxvZ2dlci5pbmZvKCJOb3QgYWJsZSB0byByZXRyaWV2ZSB0aGUgYXV0by1hY2NlcHQgc2V0dGluZyBmcm9tIG51bGwgU29mdHBob25lTWVkaWFJbmZvLCBpZ25vcmluZyBldmVudCBwdWJsaXNoLi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc29mdHBob25lTWVkaWFJbmZvLmF1dG9BY2NlcHQgPT09IHRydWUpIHsKICAgICAgbG9nZ2VyLmluZm8oIkF1dG8tYWNjZXB0IGlzIGVuYWJsZWQsIHNlbmRpbmcgb3V0IEFjY2VwdGVkIGV2ZW50IHRvIHN0b3AgcmluZ3RvbmUuLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsCiAgICAgICAgZGF0YTogbmV3IGNvbm5lY3QuQ29udGFjdChjb250YWN0LmNvbnRhY3RJZCkKICAgICAgfSk7CiAgICAgIGNvbmR1aXQuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICAgIGV2ZW50OiBjb25uZWN0LmNvcmUuZ2V0Q29udGFjdEV2ZW50TmFtZShjb25uZWN0LkNvbnRhY3RFdmVudHMuQUNDRVBURUQsIGNvbnRhY3QuY29udGFjdElkKSwKICAgICAgICBkYXRhOiBuZXcgY29ubmVjdC5Db250YWN0KGNvbnRhY3QuY29udGFjdElkKQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGxvZ2dlci5pbmZvKCJBdXRvLWFjY2VwdCBpcyBkaXNhYmxlZCwgcmluZ3RvbmUgd2lsbCBiZSBzdG9wcGVkIGJ5IHVzZXIgYWN0aW9uLiIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICB9CiAgfTsKCiAgLy8gQmluZCBldmVudHMgZm9yIG11dGUKICB2YXIgaGFuZGxlU29mdFBob25lTXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5FdmVudFR5cGUuTVVURSwgbXV0ZVRvZ2dsZSk7CiAgfTsKCiAgdmFyIGhhbmRsZVNwZWFrZXJEZXZpY2VDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9TUEVBS0VSX0RFVklDRSwgc2V0U3BlYWtlckRldmljZSk7CiAgfQoKICB2YXIgaGFuZGxlTWljcm9waG9uZURldmljZUNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBidXMgPSBjb25uZWN0LmNvcmUuZ2V0RXZlbnRCdXMoKTsKICAgIGJ1cy5zdWJzY3JpYmUoY29ubmVjdC5Db25maWd1cmF0aW9uRXZlbnRzLlNFVF9NSUNST1BIT05FX0RFVklDRSwgc2V0TWljcm9waG9uZURldmljZSk7CiAgfQoKICB2YXIgbW9uaXRvck1pY3JvcGhvbmVQZXJtaXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgaWYgKGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyKCkgJiYgY29ubmVjdC5nZXRDaHJvbWVCcm93c2VyVmVyc2lvbigpID4gNDMpewogICAgICAgIG5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeSh7bmFtZTogJ21pY3JvcGhvbmUnfSkKICAgICAgICAudGhlbihmdW5jdGlvbihwZXJtaXNzaW9uU3RhdHVzKXsKICAgICAgICAgIHBlcm1pc3Npb25TdGF0dXMub25jaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWljcm9waG9uZSBQZXJtaXNzaW9uOiAiICsgcGVybWlzc2lvblN0YXR1cy5zdGF0ZSk7CiAgICAgICAgICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCgiQ29ubmVjdGl2aXR5Q2hlY2tSZXN1bHQiLCBudWxsLCAKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbm5lY3Rpdml0eUNoZWNrVHlwZTogIk1pY3JvcGhvbmVQZXJtaXNzaW9uIiwKICAgICAgICAgICAgICBzdGF0dXM6IHBlcm1pc3Npb25TdGF0dXMuc3RhdGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmKHBlcm1pc3Npb25TdGF0dXMuc3RhdGUgPT09ICdkZW5pZWQnKXsKICAgICAgICAgICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQsCiAgICAgICAgICAgICAgICAiWW91ciBtaWNyb3Bob25lIGlzIG5vdCBlbmFibGVkIGluIHlvdXIgYnJvd3Nlci4gIiwKICAgICAgICAgICAgICAgICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgbG9nZ2VyLmVycm9yKCJGYWlsZWQgaW4gZGV0ZWN0aW5nIG1pY3JvcGhvbmUgcGVybWlzc2lvbiBzdGF0dXM6ICIgKyBlKTsKICAgIH0KICB9CgogIC8vIE1ha2Ugc3VyZSBvbmNlIHdlIGRpc2Nvbm5lY3RlZCB3ZSBnZXQgdGhlIG11dGUgc3RhdGUgYmFjayB0byBub3JtYWwKICB2YXIgZGVsZXRlTG9jYWxNZWRpYVN0cmVhbSA9IGZ1bmN0aW9uIChjb25uZWN0aW9uSWQpIHsKICAgIGRlbGV0ZSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF07CiAgICBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKS5zZW5kVXBzdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQlJPQURDQVNULCB7CiAgICAgIGV2ZW50OiBjb25uZWN0LkFnZW50RXZlbnRzLk1VVEVfVE9HR0xFLAogICAgICBkYXRhOiB7IG11dGVkOiBmYWxzZSB9CiAgICB9KTsKICB9OwoKICAvLyBDaGVjayBmb3IgdGhlIGxvY2FsIHN0cmVhbXMgaWYgZXhpc3RzICAtICByZXZlcnQgaXQKICAvLyBBbmQgaW5mb3JtIG90aGVyIGNsaWVudHMgYWJvdXQgdGhlIGNoYW5nZSAKICB2YXIgbXV0ZVRvZ2dsZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICB2YXIgc3RhdHVzOwogICAgaWYgKGNvbm5lY3Qua2V5cyhsb2NhbE1lZGlhU3RyZWFtKS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmIChkYXRhICYmIGRhdGEubXV0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHN0YXR1cyA9IGRhdGEubXV0ZTsKICAgIH0KCiAgICBmb3IgKHZhciBjb25uZWN0aW9uSWQgaW4gbG9jYWxNZWRpYVN0cmVhbSkgewogICAgICBpZiAobG9jYWxNZWRpYVN0cmVhbS5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgdmFyIGxvY2FsTWVkaWEgPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0uc3RyZWFtOwogICAgICAgIGlmIChsb2NhbE1lZGlhKSB7CiAgICAgICAgICB2YXIgYXVkaW9UcmFja3MgPSBsb2NhbE1lZGlhLmdldEF1ZGlvVHJhY2tzKClbMF07CiAgICAgICAgICBpZiAoc3RhdHVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgYXVkaW9UcmFja3MuZW5hYmxlZCA9ICFzdGF0dXM7CiAgICAgICAgICAgIGxvY2FsTWVkaWFTdHJlYW1bY29ubmVjdGlvbklkXS5tdXRlZCA9IHN0YXR1czsKCiAgICAgICAgICAgIGlmIChzdGF0dXMpIHsKICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQWdlbnQgaGFzIG11dGVkIHRoZSBjb250YWN0LCBjb25uZWN0aW9uSWQgLSAgIiArIGNvbm5lY3Rpb25JZCkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQWdlbnQgaGFzIHVubXV0ZWQgdGhlIGNvbnRhY3QsIGNvbm5lY3Rpb25JZCAtICIgKyBjb25uZWN0aW9uSWQpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0dXMgPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0ubXV0ZWQgfHwgZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5BZ2VudEV2ZW50cy5NVVRFX1RPR0dMRSwKICAgICAgZGF0YTogeyBtdXRlZDogc3RhdHVzIH0KICAgIH0pOwogIH07CgogIHZhciBzZXRTcGVha2VyRGV2aWNlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwIHx8ICFkYXRhIHx8ICFkYXRhLmRldmljZUlkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkZXZpY2VJZCA9IGRhdGEuZGV2aWNlSWQ7CiAgICB2YXIgcmVtb3RlQXVkaW9FbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlbW90ZS1hdWRpbycpOwogICAgdHJ5IHsKICAgICAgbG9nZ2VyLmluZm8oIlRyeWluZyB0byBzZXQgc3BlYWtlciB0byBkZXZpY2UgIiArIGRldmljZUlkKTsKICAgICAgaWYgKHJlbW90ZUF1ZGlvRWxlbWVudCAmJiB0eXBlb2YgcmVtb3RlQXVkaW9FbGVtZW50LnNldFNpbmtJZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJlbW90ZUF1ZGlvRWxlbWVudC5zZXRTaW5rSWQoZGV2aWNlSWQpOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGxvZ2dlci5lcnJvcigiRmFpbGVkIHRvIHNldCBzcGVha2VyIHRvIGRldmljZSAiICsgZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5TUEVBS0VSX0RFVklDRV9DSEFOR0VELAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9CgogIHZhciBzZXRNaWNyb3Bob25lRGV2aWNlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgIGlmIChjb25uZWN0LmtleXMobG9jYWxNZWRpYVN0cmVhbSkubGVuZ3RoID09PSAwICB8fCAhZGF0YSB8fCAhZGF0YS5kZXZpY2VJZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgZGV2aWNlSWQgPSBkYXRhLmRldmljZUlkOwogICAgdmFyIHNvZnRwaG9uZU1hbmFnZXIgPSBjb25uZWN0LmNvcmUuZ2V0U29mdHBob25lTWFuYWdlcigpOwogICAgdHJ5IHsKICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoeyBhdWRpbzogeyBkZXZpY2VJZDogeyBleGFjdDogZGV2aWNlSWQgfSB9IH0pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKG5ld01pY3JvcGhvbmVTdHJlYW0pIHsKICAgICAgICAgIHZhciBuZXdNaWNyb3Bob25lVHJhY2sgPSBuZXdNaWNyb3Bob25lU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF07CiAgICAgICAgICBmb3IgKHZhciBjb25uZWN0aW9uSWQgaW4gbG9jYWxNZWRpYVN0cmVhbSkgewogICAgICAgICAgICBpZiAobG9jYWxNZWRpYVN0cmVhbS5oYXNPd25Qcm9wZXJ0eShjb25uZWN0aW9uSWQpKSB7CiAgICAgICAgICAgICAgdmFyIGxvY2FsTWVkaWEgPSBsb2NhbE1lZGlhU3RyZWFtW2Nvbm5lY3Rpb25JZF0uc3RyZWFtOwogICAgICAgICAgICAgIHZhciBzZXNzaW9uID0gc29mdHBob25lTWFuYWdlci5nZXRTZXNzaW9uKGNvbm5lY3Rpb25JZCk7CiAgICAgICAgICAgICAgLy9SZXBsYWNlIHRoZSBhdWRpbyB0cmFjayBpbiB0aGUgUnRjUGVlckNvbm5lY3Rpb24KICAgICAgICAgICAgICBzZXNzaW9uLl9wYy5nZXRTZW5kZXJzKClbMF0ucmVwbGFjZVRyYWNrKG5ld01pY3JvcGhvbmVUcmFjaykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvL1JlcGxhY2UgdGhlIGF1ZGlvIHRyYWNrIGluIHRoZSBsb2NhbCBtZWRpYSBzdHJlYW0gKGZvciBtdXRlIC8gdW5tdXRlKQogICAgICAgICAgICAgICAgc29mdHBob25lTWFuYWdlci5yZXBsYWNlTG9jYWxNZWRpYVRyYWNrKGNvbm5lY3Rpb25JZCwgbmV3TWljcm9waG9uZVRyYWNrKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSBjYXRjaChlKSB7CiAgICAgIGxvZ2dlci5lcnJvcigiRmFpbGVkIHRvIHNldCBtaWNyb3Bob25lIGRldmljZSAiICsgZGV2aWNlSWQpOwogICAgfQoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQ29uZmlndXJhdGlvbkV2ZW50cy5NSUNST1BIT05FX0RFVklDRV9DSEFOR0VELAogICAgICBkYXRhOiB7IGRldmljZUlkOiBkZXZpY2VJZCB9CiAgICB9KTsKICB9CgogIHZhciBwdWJsaXNoU29mdHBob25lRmFpbHVyZUxvZ3MgPSBmdW5jdGlvbiAocnRjU2Vzc2lvbiwgcmVhc29uKSB7CiAgICBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5JQ0VfQ09MTEVDVElPTl9USU1FT1VUKSB7CiAgICAgIHZhciBlbmRQb2ludFVybCA9ICJcbiI7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcnRjU2Vzc2lvbi5faWNlU2VydmVycy5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcnRjU2Vzc2lvbi5faWNlU2VydmVyc1tpXS51cmxzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBlbmRQb2ludFVybCA9IGVuZFBvaW50VXJsICsgcnRjU2Vzc2lvbi5faWNlU2VydmVyc1tpXS51cmxzW2pdICsgIlxuIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuSUNFX0NPTExFQ1RJT05fVElNRU9VVCwgIkljZSBjb2xsZWN0aW9uIHRpbWVkb3V0LiAiLCBlbmRQb2ludFVybCk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuVVNFUl9CVVNZKSB7CiAgICAgIHB1Ymxpc2hFcnJvcihTb2Z0cGhvbmVFcnJvclR5cGVzLlVTRVJfQlVTWV9FUlJPUiwKICAgICAgICAiU29mdHBob25lIGNhbGwgVXNlckJ1c3kgZXJyb3IuICIsCiAgICAgICAgIiIpOwogICAgfSBlbHNlIGlmIChyZWFzb24gPT09IGNvbm5lY3QuUlRDRXJyb3JzLlNJR05BTExJTkdfSEFORFNIQUtFX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuU0lHTkFMTElOR19IQU5EU0hBS0VfRkFJTFVSRSwKICAgICAgICAiSGFuZHNoYWtpbmcgd2l0aCBTaWduYWxsaW5nIFNlcnZlciAiICsgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpICsgIiBmYWlsZWQuICIsCiAgICAgICAgcnRjU2Vzc2lvbi5fc2lnbmFsaW5nVXJpKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5HVU1fVElNRU9VVF9GQUlMVVJFIHx8IHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuR1VNX09USEVSX0ZBSUxVUkUpIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuTUlDUk9QSE9ORV9OT1RfU0hBUkVELAogICAgICAgICJZb3VyIG1pY3JvcGhvbmUgaXMgbm90IGVuYWJsZWQgaW4geW91ciBicm93c2VyLiAiLAogICAgICAgICIiKTsKICAgIH0gZWxzZSBpZiAocmVhc29uID09PSBjb25uZWN0LlJUQ0Vycm9ycy5TSUdOQUxMSU5HX0NPTk5FQ1RJT05fRkFJTFVSRSkgewogICAgICBwdWJsaXNoRXJyb3IoU29mdHBob25lRXJyb3JUeXBlcy5TSUdOQUxMSU5HX0NPTk5FQ1RJT05fRkFJTFVSRSwKICAgICAgICAiVVJMICIgKyBydGNTZXNzaW9uLl9zaWduYWxpbmdVcmkgKyAiIGNhbm5vdCBiZSByZWFjaGVkLiAiLAogICAgICAgIHJ0Y1Nlc3Npb24uX3NpZ25hbGluZ1VyaSk7CiAgICB9IGVsc2UgaWYgKHJlYXNvbiA9PT0gY29ubmVjdC5SVENFcnJvcnMuQ0FMTF9OT1RfRk9VTkQpIHsKICAgICAgLy8gTm8gbmVlZCB0byBwdWJsaXNoIGFueSBzb2Z0cGhvbmUgZXJyb3IgZm9yIHRoaXMgY2FzZS4gQ0NQIFVYIHdpbGwgaGFuZGxlIHRoaXMgY2FzZS4KICAgICAgbG9nZ2VyLmVycm9yKCJTb2Z0cGhvbmUgY2FsbCBmYWlsZWQgZHVlIHRvIENhbGxOb3RGb3VuZEV4Y2VwdGlvbi4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfSBlbHNlIHsKICAgICAgcHVibGlzaEVycm9yKFNvZnRwaG9uZUVycm9yVHlwZXMuV0VCUlRDX0VSUk9SLAogICAgICAgICJ3ZWJydGMgc3lzdGVtIGVycm9yLiAiLAogICAgICAgICIiKTsKICAgIH0KICB9OwoKICAvKiogUGFyc2UgdGhlIEpTT04gZW5jb2RlZCB3ZWIgY2FsbCBjb25maWcgaW50byB0aGUgZGF0YSBpdCByZXByZXNlbnRzLiAqLwogIHZhciBwYXJzZUNhbGxDb25maWcgPSBmdW5jdGlvbiAoc2VyaWFsaXplZENvbmZpZykgewogICAgLy8gT3VyIHVuZGVyc2NvcmUgaXMgdG9vIG9sZCBmb3IgdW5lc2NhcGUKICAgIC8vIGh0dHBzOi8vaXNzdWVzLmFtYXpvbi5jb20vaXNzdWVzL0NTV0YtMTQ2NwogICAgdmFyIGRlY29kZWRKU09OID0gc2VyaWFsaXplZENvbmZpZy5yZXBsYWNlKC8mcXVvdDsvZywgJyInKTsKICAgIHJldHVybiBKU09OLnBhcnNlKGRlY29kZWRKU09OKTsKICB9OwoKICB2YXIgZmV0Y2hVc2VyTWVkaWEgPSBmdW5jdGlvbiAoY2FsbGJhY2tzSW4pIHsKICAgIHZhciBjYWxsYmFja3MgPSBjYWxsYmFja3NJbiB8fCB7fTsKICAgIGNhbGxiYWNrcy5zdWNjZXNzID0gY2FsbGJhY2tzLnN1Y2Nlc3MgfHwgZnVuY3Rpb24gKCkgeyB9OwogICAgY2FsbGJhY2tzLmZhaWx1cmUgPSBjYWxsYmFja3MuZmFpbHVyZSB8fCBmdW5jdGlvbiAoKSB7IH07CgogICAgdmFyIENPTlNUUkFJTlQgPSB7CiAgICAgIGF1ZGlvOiB0cnVlCiAgICB9OwoKICAgIHZhciBwcm9taXNlID0gbnVsbDsKCiAgICBpZiAodHlwZW9mIFByb21pc2UgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5VTlNVUFBPUlRFRF9CUk9XU0VSKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHByb21pc2UgPSBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzLmdldFVzZXJNZWRpYShDT05TVFJBSU5UKTsKCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYXZpZ2F0b3Iud2Via2l0R2V0VXNlck1lZGlhID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgbmF2aWdhdG9yLndlYmtpdEdldFVzZXJNZWRpYShDT05TVFJBSU5ULCByZXNvbHZlLCByZWplY3QpOwogICAgICB9KTsKCiAgICB9IGVsc2UgewogICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLlVOU1VQUE9SVEVEX0JST1dTRVIpOwogICAgICByZXR1cm47CiAgICB9CgogICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uIChzdHJlYW0pIHsKICAgICAgdmFyIGF1ZGlvVHJhY2tzID0gc3RyZWFtLmdldEF1ZGlvVHJhY2tzKCk7CiAgICAgIGlmIChhdWRpb1RyYWNrcyAmJiBhdWRpb1RyYWNrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3Moc3RyZWFtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShTb2Z0cGhvbmVFcnJvclR5cGVzLk1JQ1JPUEhPTkVfTk9UX1NIQVJFRCk7CiAgICAgIH0KICAgIH0sIGZ1bmN0aW9uIChlcnIpIHsKICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoU29mdHBob25lRXJyb3JUeXBlcy5NSUNST1BIT05FX05PVF9TSEFSRUQpOwogICAgfSk7CiAgICByZXR1cm4gcHJvbWlzZTsKICB9OwoKICB2YXIgcHVibGlzaEVycm9yID0gZnVuY3Rpb24gKGVycm9yVHlwZSwgbWVzc2FnZSwgZW5kUG9pbnRVcmwpIHsKICAgIGxvZ2dlci5lcnJvcigiU29mdHBob25lIGVycm9yIG9jY3VycmVkIDogIiwgZXJyb3JUeXBlLAogICAgICBtZXNzYWdlIHx8ICIiKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuQWdlbnRFdmVudHMuU09GVFBIT05FX0VSUk9SLAogICAgICBkYXRhOiBuZXcgY29ubmVjdC5Tb2Z0cGhvbmVFcnJvcihlcnJvclR5cGUsIG1lc3NhZ2UsIGVuZFBvaW50VXJsKQogICAgfSk7CiAgfTsKCiAgdmFyIHB1Ymxpc2hTZXNzaW9uRmFpbHVyZVRlbGVtZXRyeUV2ZW50ID0gZnVuY3Rpb24gKGNvbnRhY3RJZCwgcmVhc29uKSB7CiAgICBwdWJsaXNoVGVsZW1ldHJ5RXZlbnQoIlNvZnRwaG9uZSBTZXNzaW9uIEZhaWxlZCIsIGNvbnRhY3RJZCwgewogICAgICBmYWlsZWRSZWFzb246IHJlYXNvbgogICAgfSk7CiAgfTsKCiAgdmFyIHB1Ymxpc2hUZWxlbWV0cnlFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCwgZGF0YSkgewogICAgY29ubmVjdC5wdWJsaXNoTWV0cmljKHsKICAgICAgbmFtZTogZXZlbnROYW1lLAogICAgICBjb250YWN0SWQ6IGNvbnRhY3RJZCwKICAgICAgZGF0YTogZGF0YQogICAgfSk7CiAgfTsKCiAgLy8gUHVibGlzaCB0aGUgY29udGFjdCBhbmQgYWdlbnQgaW5mb3JtYXRpb24gaW4gYSBtdWx0aXBsZSBzZXNzaW9ucyBzY2VuYXJpb3MKICB2YXIgcHVibGlzaE11bHRpcGxlU2Vzc2lvbnNFdmVudCA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNvbnRhY3RJZCwgYWdlbnRDb25uZWN0aW9uSWQpIHsKICAgIHB1Ymxpc2hUZWxlbWV0cnlFdmVudChldmVudE5hbWUsIGNvbnRhY3RJZCwgW3sKICAgICAgbmFtZTogIkFnZW50Q29ubmVjdGlvbklkIiwKICAgICAgdmFsdWU6IGFnZW50Q29ubmVjdGlvbklkCiAgICB9XSk7CiAgICBsb2dnZXIuaW5mbygiUHVibGlzaCBtdWx0aXBsZSBzZXNzaW9uIGVycm9yIG1ldHJpY3MiLCBldmVudE5hbWUsICJjb250YWN0SWQgIiArIGNvbnRhY3RJZCwgImFnZW50IGNvbm5lY3Rpb25JZCAiICsgYWdlbnRDb25uZWN0aW9uSWQpCiAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogIH07CgogIHZhciBpc0Jyb3dzZXJTb2Z0UGhvbmVTdXBwb3J0ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICAvLyBJbiBPcGVyYSwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiT3BlcmEiIG9yIGFmdGVyICJWZXJzaW9uIgogICAgaWYgKGNvbm5lY3QuaXNPcGVyYUJyb3dzZXIoKSAmJiBjb25uZWN0LmdldE9wZXJhQnJvd3NlclZlcnNpb24oKSA+IDE3KSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gSW4gQ2hyb21lLCB0aGUgdHJ1ZSB2ZXJzaW9uIGlzIGFmdGVyICJDaHJvbWUiCiAgICBlbHNlIGlmIChjb25uZWN0LmlzQ2hyb21lQnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0Q2hyb21lQnJvd3NlclZlcnNpb24oKSA+IDIyKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gSW4gRmlyZWZveCwgdGhlIHRydWUgdmVyc2lvbiBpcyBhZnRlciAiRmlyZWZveCIKICAgIGVsc2UgaWYgKGNvbm5lY3QuaXNGaXJlZm94QnJvd3NlcigpICYmIGNvbm5lY3QuZ2V0RmlyZWZveEJyb3dzZXJWZXJzaW9uKCkgPiAyMSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9OwoKICB2YXIgc2VuZFNvZnRwaG9uZU1ldHJpY3MgPSBmdW5jdGlvbiAoY29udGFjdCkgewogICAgdmFyIHN0cmVhbVN0YXRzID0gdGltZVNlcmllc1N0cmVhbVN0YXRzQnVmZmVyLnNsaWNlKCk7CiAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIgPSBbXTsKICAgIGlmIChzdHJlYW1TdGF0cy5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnRhY3Quc2VuZFNvZnRwaG9uZU1ldHJpY3Moc3RyZWFtU3RhdHMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBsb2dnZXIuaW5mbygic2VuZFNvZnRwaG9uZU1ldHJpY3Mgc3VjY2VzcyIgKyBKU09OLnN0cmluZ2lmeShzdHJlYW1TdGF0cykpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGxvZ2dlci5lcnJvcigic2VuZFNvZnRwaG9uZU1ldHJpY3MgZmFpbGVkLiIpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KGRhdGEpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgdmFyIHNlbmRTb2Z0cGhvbmVSZXBvcnQgPSBmdW5jdGlvbiAoY29udGFjdCwgcmVwb3J0LCB1c2VyQXVkaW9TdGF0cywgcmVtb3RlQXVkaW9TdGF0cykgewogICAgcmVwb3J0LnN0cmVhbVN0YXRzID0gW2FkZFN0cmVhbVR5cGVUb1N0YXRzKHVzZXJBdWRpb1N0YXRzLCBBVURJT19JTlBVVCksCiAgICBhZGRTdHJlYW1UeXBlVG9TdGF0cyhyZW1vdGVBdWRpb1N0YXRzLCBBVURJT19PVVRQVVQpXTsKICAgIHZhciBjYWxsUmVwb3J0ID0gewogICAgICBjYWxsU3RhcnRUaW1lOiByZXBvcnQuc2Vzc2lvblN0YXJ0VGltZSwKICAgICAgY2FsbEVuZFRpbWU6IHJlcG9ydC5zZXNzaW9uRW5kVGltZSwKICAgICAgZ3VtVGltZU1pbGxpczogcmVwb3J0Lmd1bVRpbWVNaWxsaXMsCiAgICAgIGluaXRpYWxpemF0aW9uVGltZU1pbGxpczogcmVwb3J0LmluaXRpYWxpemF0aW9uVGltZU1pbGxpcywKICAgICAgaWNlQ29sbGVjdGlvblRpbWVNaWxsaXM6IHJlcG9ydC5pY2VDb2xsZWN0aW9uVGltZU1pbGxpcywKICAgICAgc2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzOiByZXBvcnQuc2lnbmFsbGluZ0Nvbm5lY3RUaW1lTWlsbGlzLAogICAgICBoYW5kc2hha2luZ1RpbWVNaWxsaXM6IHJlcG9ydC5oYW5kc2hha2luZ1RpbWVNaWxsaXMsCiAgICAgIHByZVRhbGtpbmdUaW1lTWlsbGlzOiByZXBvcnQucHJlVGFsa2luZ1RpbWVNaWxsaXMsCiAgICAgIHRhbGtpbmdUaW1lTWlsbGlzOiByZXBvcnQudGFsa2luZ1RpbWVNaWxsaXMsCiAgICAgIGNsZWFudXBUaW1lTWlsbGlzOiByZXBvcnQuY2xlYW51cFRpbWVNaWxsaXMsCiAgICAgIGljZUNvbGxlY3Rpb25GYWlsdXJlOiByZXBvcnQuaWNlQ29sbGVjdGlvbkZhaWx1cmUsCiAgICAgIHNpZ25hbGxpbmdDb25uZWN0aW9uRmFpbHVyZTogcmVwb3J0LnNpZ25hbGxpbmdDb25uZWN0aW9uRmFpbHVyZSwKICAgICAgaGFuZHNoYWtpbmdGYWlsdXJlOiByZXBvcnQuaGFuZHNoYWtpbmdGYWlsdXJlLAogICAgICBndW1PdGhlckZhaWx1cmU6IHJlcG9ydC5ndW1PdGhlckZhaWx1cmUsCiAgICAgIGd1bVRpbWVvdXRGYWlsdXJlOiByZXBvcnQuZ3VtVGltZW91dEZhaWx1cmUsCiAgICAgIGNyZWF0ZU9mZmVyRmFpbHVyZTogcmVwb3J0LmNyZWF0ZU9mZmVyRmFpbHVyZSwKICAgICAgc2V0TG9jYWxEZXNjcmlwdGlvbkZhaWx1cmU6IHJlcG9ydC5zZXRMb2NhbERlc2NyaXB0aW9uRmFpbHVyZSwKICAgICAgdXNlckJ1c3lGYWlsdXJlOiByZXBvcnQudXNlckJ1c3lGYWlsdXJlLAogICAgICBpbnZhbGlkUmVtb3RlU0RQRmFpbHVyZTogcmVwb3J0LmludmFsaWRSZW1vdGVTRFBGYWlsdXJlLAogICAgICBub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmU6IHJlcG9ydC5ub1JlbW90ZUljZUNhbmRpZGF0ZUZhaWx1cmUsCiAgICAgIHNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZTogcmVwb3J0LnNldFJlbW90ZURlc2NyaXB0aW9uRmFpbHVyZSwKICAgICAgc29mdHBob25lU3RyZWFtU3RhdGlzdGljczogcmVwb3J0LnN0cmVhbVN0YXRzCiAgICB9OwogICAgY29udGFjdC5zZW5kU29mdHBob25lUmVwb3J0KGNhbGxSZXBvcnQsIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkgewogICAgICAgIGxvZ2dlci5pbmZvKCJzZW5kU29mdHBob25lUmVwb3J0IHN1Y2Nlc3MiICsgSlNPTi5zdHJpbmdpZnkoY2FsbFJlcG9ydCkpCiAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBsb2dnZXIuZXJyb3IoInNlbmRTb2Z0cGhvbmVSZXBvcnQgZmFpbGVkLiIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0KICAgIH0pOwogIH07CgogIHZhciBzdGFydFN0YXRzQ29sbGVjdGlvbkpvYiA9IGZ1bmN0aW9uIChydGNTZXNzaW9uKSB7CiAgICBydHBTdGF0c0pvYiA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgIHJ0Y1Nlc3Npb24uZ2V0VXNlckF1ZGlvU3RhdHMoKS50aGVuKGZ1bmN0aW9uIChzdGF0cykgewogICAgICAgIHZhciBwcmV2aW91c1VzZXJTdGF0cyA9IGFnZ3JlZ2F0ZWRVc2VyQXVkaW9TdGF0czsKICAgICAgICBhZ2dyZWdhdGVkVXNlckF1ZGlvU3RhdHMgPSBzdGF0czsKICAgICAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIucHVzaChnZXRUaW1lU2VyaWVzU3RhdHMoYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzLCBwcmV2aW91c1VzZXJTdGF0cywgQVVESU9fSU5QVVQpKTsKICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgbG9nZ2VyLmRlYnVnKCJGYWlsZWQgdG8gZ2V0IHVzZXIgYXVkaW8gc3RhdHMuIiwgZXJyb3IpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIH0pOwogICAgICBydGNTZXNzaW9uLmdldFJlbW90ZUF1ZGlvU3RhdHMoKS50aGVuKGZ1bmN0aW9uIChzdGF0cykgewogICAgICAgIHZhciBwcmV2aW91c1JlbW90ZVN0YXRzID0gYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHM7CiAgICAgICAgYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMgPSBzdGF0czsKICAgICAgICB0aW1lU2VyaWVzU3RyZWFtU3RhdHNCdWZmZXIucHVzaChnZXRUaW1lU2VyaWVzU3RhdHMoYWdncmVnYXRlZFJlbW90ZUF1ZGlvU3RhdHMsIHByZXZpb3VzUmVtb3RlU3RhdHMsIEFVRElPX09VVFBVVCkpOwogICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICBsb2dnZXIuZGVidWcoIkZhaWxlZCB0byBnZXQgcmVtb3RlIGF1ZGlvIHN0YXRzLiIsIGVycm9yKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9KTsKICAgIH0sIDEwMDApOwogIH07CgogIHZhciBzdGFydFN0YXRzUmVwb3J0aW5nSm9iID0gZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgIHJlcG9ydFN0YXRzSm9iID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgc2VuZFNvZnRwaG9uZU1ldHJpY3MoY29udGFjdCk7CiAgICB9LCBzdGF0c1JlcG9ydGluZ0pvYkludGVydmFsTXMpOwogIH07CgogIHZhciBpbml0aWFsaXplUGFyYW1zID0gZnVuY3Rpb24gKCkgewogICAgYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzID0gbnVsbDsKICAgIGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzID0gbnVsbDsKICAgIHRpbWVTZXJpZXNTdHJlYW1TdGF0c0J1ZmZlciA9IFtdOwogICAgcnRwU3RhdHNKb2IgPSBudWxsOwogICAgcmVwb3J0U3RhdHNKb2IgPSBudWxsOwogIH07CgogIHZhciBnZXRUaW1lU2VyaWVzU3RhdHMgPSBmdW5jdGlvbiAoY3VycmVudFN0YXRzLCBwcmV2aW91c1N0YXRzLCBzdHJlYW1UeXBlKSB7CiAgICBpZiAocHJldmlvdXNTdGF0cyAmJiBjdXJyZW50U3RhdHMpIHsKICAgICAgdmFyIHBhY2tldHNMb3N0ID0gY3VycmVudFN0YXRzLnBhY2tldHNMb3N0ID4gcHJldmlvdXNTdGF0cy5wYWNrZXRzTG9zdCA/IGN1cnJlbnRTdGF0cy5wYWNrZXRzTG9zdCAtIHByZXZpb3VzU3RhdHMucGFja2V0c0xvc3QgOiAwOwogICAgICB2YXIgcGFja2V0c0NvdW50ID0gY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCA+IHByZXZpb3VzU3RhdHMucGFja2V0c0NvdW50ID8gY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCAtIHByZXZpb3VzU3RhdHMucGFja2V0c0NvdW50IDogMDsKICAgICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhjdXJyZW50U3RhdHMudGltZXN0YW1wLAogICAgICAgIHBhY2tldHNMb3N0LAogICAgICAgIHBhY2tldHNDb3VudCwKICAgICAgICBzdHJlYW1UeXBlLAogICAgICAgIGN1cnJlbnRTdGF0cy5hdWRpb0xldmVsLAogICAgICAgIGN1cnJlbnRTdGF0cy5qYk1pbGxpc2Vjb25kcywKICAgICAgICBjdXJyZW50U3RhdHMucnR0TWlsbGlzZWNvbmRzKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBuZXcgUlRQU3RyZWFtU3RhdHMoY3VycmVudFN0YXRzLnRpbWVzdGFtcCwKICAgICAgICBjdXJyZW50U3RhdHMucGFja2V0c0xvc3QsCiAgICAgICAgY3VycmVudFN0YXRzLnBhY2tldHNDb3VudCwKICAgICAgICBzdHJlYW1UeXBlLAogICAgICAgIGN1cnJlbnRTdGF0cy5hdWRpb0xldmVsLAogICAgICAgIGN1cnJlbnRTdGF0cy5qYk1pbGxpc2Vjb25kcywKICAgICAgICBjdXJyZW50U3RhdHMucnR0TWlsbGlzZWNvbmRzKTsKICAgIH0KICB9OwoKICB2YXIgc3RvcEpvYiA9IGZ1bmN0aW9uICh0YXNrKSB7CiAgICBpZiAodGFzayAhPT0gbnVsbCkgewogICAgICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0YXNrKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH07CgogIHZhciBzdG9wSm9ic0FuZFJlcG9ydCA9IGZ1bmN0aW9uIChjb250YWN0LCBzZXNzaW9uUmVwb3J0KSB7CiAgICBydHBTdGF0c0pvYiA9IHN0b3BKb2IocnRwU3RhdHNKb2IpOwogICAgcmVwb3J0U3RhdHNKb2IgPSBzdG9wSm9iKHJlcG9ydFN0YXRzSm9iKTsKICAgIHNlbmRTb2Z0cGhvbmVSZXBvcnQoY29udGFjdCwgc2Vzc2lvblJlcG9ydCwgYWRkU3RyZWFtVHlwZVRvU3RhdHMoYWdncmVnYXRlZFVzZXJBdWRpb1N0YXRzLCBBVURJT19JTlBVVCksIGFkZFN0cmVhbVR5cGVUb1N0YXRzKGFnZ3JlZ2F0ZWRSZW1vdGVBdWRpb1N0YXRzLCBBVURJT19PVVRQVVQpKTsKICAgIHNlbmRTb2Z0cGhvbmVNZXRyaWNzKGNvbnRhY3QpOwogIH07CgogIC8qKgogICogICBBZGRpbmcgc3RyZWFtdHlwZSBwYXJhbWV0ZXIgb24gdG9wIG9mIFJUQ0pTIFJUU3RhdHMgb2JqZWN0LgogICovCiAgdmFyIFJUUFN0cmVhbVN0YXRzID0gZnVuY3Rpb24gKHRpbWVzdGFtcCwgcGFja2V0c0xvc3QsIHBhY2tldHNDb3VudCwgc3RyZWFtVHlwZSwgYXVkaW9MZXZlbCwgaml0dGVyQnVmZmVyTWlsbGlzLCByb3VuZFRyaXBUaW1lTWlsbGlzKSB7CiAgICB0aGlzLnNvZnRwaG9uZVN0cmVhbVR5cGUgPSBzdHJlYW1UeXBlOwogICAgdGhpcy50aW1lc3RhbXAgPSB0aW1lc3RhbXA7CiAgICB0aGlzLnBhY2tldHNMb3N0ID0gcGFja2V0c0xvc3Q7CiAgICB0aGlzLnBhY2tldHNDb3VudCA9IHBhY2tldHNDb3VudDsKICAgIHRoaXMuYXVkaW9MZXZlbCA9IGF1ZGlvTGV2ZWw7CiAgICB0aGlzLmppdHRlckJ1ZmZlck1pbGxpcyA9IGppdHRlckJ1ZmZlck1pbGxpczsKICAgIHRoaXMucm91bmRUcmlwVGltZU1pbGxpcyA9IHJvdW5kVHJpcFRpbWVNaWxsaXM7CiAgfTsKCiAgdmFyIGFkZFN0cmVhbVR5cGVUb1N0YXRzID0gZnVuY3Rpb24gKHN0YXRzLCBzdHJlYW1UeXBlKSB7CiAgICBzdGF0cyA9IHN0YXRzIHx8IHt9OwogICAgcmV0dXJuIG5ldyBSVFBTdHJlYW1TdGF0cyhzdGF0cy50aW1lc3RhbXAsIHN0YXRzLnBhY2tldHNMb3N0LCBzdGF0cy5wYWNrZXRzQ291bnQsIHN0cmVhbVR5cGUsIHN0YXRzLmF1ZGlvTGV2ZWwpOwogIH07CgogIHZhciBTb2Z0cGhvbmVMb2dnZXIgPSBmdW5jdGlvbiAobG9nZ2VyKSB7CiAgICB0aGlzLl9vcmlnaW5hbExvZ2dlciA9IGxvZ2dlcjsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHRoaXMuX3RlZSA9IGZ1bmN0aW9uIChsZXZlbCwgbWV0aG9kKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gY2FsbCB0aGUgb3JpZ2luYWwgbG9nZ2VyIG9iamVjdCB0byBvdXRwdXQgdG8gYnJvd3NlcgogICAgICAgIC8vQ29ubmVjdCBsb2dnZXIgZm9sbG93cyAlcyBmb3JtYXQgdG8gcHJpbnQgb2JqZWN0cyB0byBjb25zb2xlLgogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzWzBdKTsKICAgICAgICB2YXIgZm9ybWF0ID0gIiI7CiAgICAgICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdCArICIgJXMiOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkoc2VsZi5fb3JpZ2luYWxMb2dnZXIsIFtjb25uZWN0LkxvZ0NvbXBvbmVudC5TT0ZUUEhPTkUsIGZvcm1hdF0uY29uY2F0KGFyZ3MpKTsKICAgICAgfTsKICAgIH07CiAgfTsKCiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoMSwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuZGVidWcpKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmluZm8gPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fdGVlKDIsIHRoaXMuX29yaWdpbmFsTG9nZ2VyLmluZm8pKGFyZ3VtZW50cyk7CiAgfTsKICBTb2Z0cGhvbmVMb2dnZXIucHJvdG90eXBlLmxvZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoMywgdGhpcy5fb3JpZ2luYWxMb2dnZXIubG9nKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS53YXJuID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX3RlZSg0LCB0aGlzLl9vcmlnaW5hbExvZ2dlci53YXJuKShhcmd1bWVudHMpOwogIH07CiAgU29mdHBob25lTG9nZ2VyLnByb3RvdHlwZS5lcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl90ZWUoNSwgdGhpcy5fb3JpZ2luYWxMb2dnZXIuZXJyb3IpKGFyZ3VtZW50cyk7CiAgfTsKCiAgY29ubmVjdC5Tb2Z0cGhvbmVNYW5hZ2VyID0gU29mdHBob25lTWFuYWdlcjsKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDk0NDoKLyoqKi8gKCgpID0+IHsKCi8qISBAbGljZW5zZSBzcHJpbnRmLmpzIHwgQ29weXJpZ2h0IChjKSAyMDA3LTIwMTMgQWxleGFuZHJ1IE1hcmFzdGVhbnUgPGhlbGxvIGF0IGFsZXhlaSBkb3Qgcm8+IHwgMyBjbGF1c2UgQlNEIGxpY2Vuc2UgKi8KCihmdW5jdGlvbigpIHsKICAgdmFyIGN0eCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKCgl2YXIgc3ByaW50ZiA9IGZ1bmN0aW9uKCkgewoJCWlmICghc3ByaW50Zi5jYWNoZS5oYXNPd25Qcm9wZXJ0eShhcmd1bWVudHNbMF0pKSB7CgkJCXNwcmludGYuY2FjaGVbYXJndW1lbnRzWzBdXSA9IHNwcmludGYucGFyc2UoYXJndW1lbnRzWzBdKTsKCQl9CgkJcmV0dXJuIHNwcmludGYuZm9ybWF0LmNhbGwobnVsbCwgc3ByaW50Zi5jYWNoZVthcmd1bWVudHNbMF1dLCBhcmd1bWVudHMpOwoJfTsKCglzcHJpbnRmLmZvcm1hdCA9IGZ1bmN0aW9uKHBhcnNlX3RyZWUsIGFyZ3YpIHsKCQl2YXIgY3Vyc29yID0gMSwgdHJlZV9sZW5ndGggPSBwYXJzZV90cmVlLmxlbmd0aCwgbm9kZV90eXBlID0gJycsIGFyZywgb3V0cHV0ID0gW10sIGksIGssIG1hdGNoLCBwYWQsIHBhZF9jaGFyYWN0ZXIsIHBhZF9sZW5ndGg7CgkJZm9yIChpID0gMDsgaSA8IHRyZWVfbGVuZ3RoOyBpKyspIHsKCQkJbm9kZV90eXBlID0gZ2V0X3R5cGUocGFyc2VfdHJlZVtpXSk7CgkJCWlmIChub2RlX3R5cGUgPT09ICdzdHJpbmcnKSB7CgkJCQlvdXRwdXQucHVzaChwYXJzZV90cmVlW2ldKTsKCQkJfQoJCQllbHNlIGlmIChub2RlX3R5cGUgPT09ICdhcnJheScpIHsKCQkJCW1hdGNoID0gcGFyc2VfdHJlZVtpXTsgLy8gY29udmVuaWVuY2UgcHVycG9zZXMgb25seQoJCQkJaWYgKG1hdGNoWzJdKSB7IC8vIGtleXdvcmQgYXJndW1lbnQKCQkJCQlhcmcgPSBhcmd2W2N1cnNvcl07CgkJCQkJZm9yIChrID0gMDsgayA8IG1hdGNoWzJdLmxlbmd0aDsgaysrKSB7CgkJCQkJCWlmICghYXJnLmhhc093blByb3BlcnR5KG1hdGNoWzJdW2tdKSkgewoJCQkJCQkJdGhyb3coc3ByaW50ZignW3NwcmludGZdIHByb3BlcnR5ICIlcyIgZG9lcyBub3QgZXhpc3QnLCBtYXRjaFsyXVtrXSkpOwoJCQkJCQl9CgkJCQkJCWFyZyA9IGFyZ1ttYXRjaFsyXVtrXV07CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSBpZiAobWF0Y2hbMV0pIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoZXhwbGljaXQpCgkJCQkJYXJnID0gYXJndlttYXRjaFsxXV07CgkJCQl9CgkJCQllbHNlIHsgLy8gcG9zaXRpb25hbCBhcmd1bWVudCAoaW1wbGljaXQpCgkJCQkJYXJnID0gYXJndltjdXJzb3IrK107CgkJCQl9CgoJCQkJaWYgKC9bXnNdLy50ZXN0KG1hdGNoWzhdKSAmJiAoZ2V0X3R5cGUoYXJnKSAhPSAnbnVtYmVyJykpIHsKCQkJCQl0aHJvdyhzcHJpbnRmKCdbc3ByaW50Zl0gZXhwZWN0aW5nIG51bWJlciBidXQgZm91bmQgJXMnLCBnZXRfdHlwZShhcmcpKSk7CgkJCQl9CgkJCQlzd2l0Y2ggKG1hdGNoWzhdKSB7CgkJCQkJY2FzZSAnYic6IGFyZyA9IGFyZy50b1N0cmluZygyKTsgYnJlYWs7CgkJCQkJY2FzZSAnYyc6IGFyZyA9IFN0cmluZy5mcm9tQ2hhckNvZGUoYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAnZCc6IGFyZyA9IHBhcnNlSW50KGFyZywgMTApOyBicmVhazsKCQkJCQljYXNlICdlJzogYXJnID0gbWF0Y2hbN10gPyBhcmcudG9FeHBvbmVudGlhbChtYXRjaFs3XSkgOiBhcmcudG9FeHBvbmVudGlhbCgpOyBicmVhazsKCQkJCQljYXNlICdmJzogYXJnID0gbWF0Y2hbN10gPyBwYXJzZUZsb2F0KGFyZykudG9GaXhlZChtYXRjaFs3XSkgOiBwYXJzZUZsb2F0KGFyZyk7IGJyZWFrOwoJCQkJCWNhc2UgJ28nOiBhcmcgPSBhcmcudG9TdHJpbmcoOCk7IGJyZWFrOwoJCQkJCWNhc2UgJ3MnOiBhcmcgPSAoKGFyZyA9IFN0cmluZyhhcmcpKSAmJiBtYXRjaFs3XSA/IGFyZy5zdWJzdHJpbmcoMCwgbWF0Y2hbN10pIDogYXJnKTsgYnJlYWs7CgkJCQkJY2FzZSAndSc6IGFyZyA9IGFyZyA+Pj4gMDsgYnJlYWs7CgkJCQkJY2FzZSAneCc6IGFyZyA9IGFyZy50b1N0cmluZygxNik7IGJyZWFrOwoJCQkJCWNhc2UgJ1gnOiBhcmcgPSBhcmcudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCk7IGJyZWFrOwoJCQkJfQoJCQkJYXJnID0gKC9bZGVmXS8udGVzdChtYXRjaFs4XSkgJiYgbWF0Y2hbM10gJiYgYXJnID49IDAgPyAnKycrIGFyZyA6IGFyZyk7CgkJCQlwYWRfY2hhcmFjdGVyID0gbWF0Y2hbNF0gPyBtYXRjaFs0XSA9PSAnMCcgPyAnMCcgOiBtYXRjaFs0XS5jaGFyQXQoMSkgOiAnICc7CgkJCQlwYWRfbGVuZ3RoID0gbWF0Y2hbNl0gLSBTdHJpbmcoYXJnKS5sZW5ndGg7CgkJCQlwYWQgPSBtYXRjaFs2XSA/IHN0cl9yZXBlYXQocGFkX2NoYXJhY3RlciwgcGFkX2xlbmd0aCkgOiAnJzsKCQkJCW91dHB1dC5wdXNoKG1hdGNoWzVdID8gYXJnICsgcGFkIDogcGFkICsgYXJnKTsKCQkJfQoJCX0KCQlyZXR1cm4gb3V0cHV0LmpvaW4oJycpOwoJfTsKCglzcHJpbnRmLmNhY2hlID0ge307CgoJc3ByaW50Zi5wYXJzZSA9IGZ1bmN0aW9uKGZtdCkgewoJCXZhciBfZm10ID0gZm10LCBtYXRjaCA9IFtdLCBwYXJzZV90cmVlID0gW10sIGFyZ19uYW1lcyA9IDA7CgkJd2hpbGUgKF9mbXQpIHsKCQkJaWYgKChtYXRjaCA9IC9eW15ceDI1XSsvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlwYXJzZV90cmVlLnB1c2gobWF0Y2hbMF0pOwoJCQl9CgkJCWVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNXsyfS8uZXhlYyhfZm10KSkgIT09IG51bGwpIHsKCQkJCXBhcnNlX3RyZWUucHVzaCgnJScpOwoJCQl9CgkJCWVsc2UgaWYgKChtYXRjaCA9IC9eXHgyNSg/OihbMS05XVxkKilcJHxcKChbXlwpXSspXCkpPyhcKyk/KDB8J1teJF0pPygtKT8oXGQrKT8oPzpcLihcZCspKT8oW2ItZm9zdXhYXSkvLmV4ZWMoX2ZtdCkpICE9PSBudWxsKSB7CgkJCQlpZiAobWF0Y2hbMl0pIHsKCQkJCQlhcmdfbmFtZXMgfD0gMTsKCQkJCQl2YXIgZmllbGRfbGlzdCA9IFtdLCByZXBsYWNlbWVudF9maWVsZCA9IG1hdGNoWzJdLCBmaWVsZF9tYXRjaCA9IFtdOwoJCQkJCWlmICgoZmllbGRfbWF0Y2ggPSAvXihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCWZpZWxkX2xpc3QucHVzaChmaWVsZF9tYXRjaFsxXSk7CgkJCQkJCXdoaWxlICgocmVwbGFjZW1lbnRfZmllbGQgPSByZXBsYWNlbWVudF9maWVsZC5zdWJzdHJpbmcoZmllbGRfbWF0Y2hbMF0ubGVuZ3RoKSkgIT09ICcnKSB7CgkJCQkJCQlpZiAoKGZpZWxkX21hdGNoID0gL15cLihbYS16X11bYS16X1xkXSopL2kuZXhlYyhyZXBsYWNlbWVudF9maWVsZCkpICE9PSBudWxsKSB7CgkJCQkJCQkJZmllbGRfbGlzdC5wdXNoKGZpZWxkX21hdGNoWzFdKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UgaWYgKChmaWVsZF9tYXRjaCA9IC9eXFsoXGQrKVxdLy5leGVjKHJlcGxhY2VtZW50X2ZpZWxkKSkgIT09IG51bGwpIHsKCQkJCQkJCQlmaWVsZF9saXN0LnB1c2goZmllbGRfbWF0Y2hbMV0pOwoJCQkJCQkJfQoJCQkJCQkJZWxzZSB7CgkJCQkJCQkJdGhyb3coJ1tzcHJpbnRmXSBodWg/Jyk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQkJCX0KCQkJCQltYXRjaFsyXSA9IGZpZWxkX2xpc3Q7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlhcmdfbmFtZXMgfD0gMjsKCQkJCX0KCQkJCWlmIChhcmdfbmFtZXMgPT09IDMpIHsKCQkJCQl0aHJvdygnW3NwcmludGZdIG1peGluZyBwb3NpdGlvbmFsIGFuZCBuYW1lZCBwbGFjZWhvbGRlcnMgaXMgbm90ICh5ZXQpIHN1cHBvcnRlZCcpOwoJCQkJfQoJCQkJcGFyc2VfdHJlZS5wdXNoKG1hdGNoKTsKCQkJfQoJCQllbHNlIHsKCQkJCXRocm93KCdbc3ByaW50Zl0gaHVoPycpOwoJCQl9CgkJCV9mbXQgPSBfZm10LnN1YnN0cmluZyhtYXRjaFswXS5sZW5ndGgpOwoJCX0KCQlyZXR1cm4gcGFyc2VfdHJlZTsKCX07CgoJdmFyIHZzcHJpbnRmID0gZnVuY3Rpb24oZm10LCBhcmd2LCBfYXJndikgewoJCV9hcmd2ID0gYXJndi5zbGljZSgwKTsKCQlfYXJndi5zcGxpY2UoMCwgMCwgZm10KTsKCQlyZXR1cm4gc3ByaW50Zi5hcHBseShudWxsLCBfYXJndik7Cgl9OwoKCS8qKgoJICogaGVscGVycwoJICovCglmdW5jdGlvbiBnZXRfdHlwZSh2YXJpYWJsZSkgewoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFyaWFibGUpLnNsaWNlKDgsIC0xKS50b0xvd2VyQ2FzZSgpOwoJfQoKCWZ1bmN0aW9uIHN0cl9yZXBlYXQoaW5wdXQsIG11bHRpcGxpZXIpIHsKCQlmb3IgKHZhciBvdXRwdXQgPSBbXTsgbXVsdGlwbGllciA+IDA7IG91dHB1dFstLW11bHRpcGxpZXJdID0gaW5wdXQpIHsvKiBkbyBub3RoaW5nICovfQoJCXJldHVybiBvdXRwdXQuam9pbignJyk7Cgl9CgoJLyoqCgkgKiBleHBvcnQgdG8gZWl0aGVyIGJyb3dzZXIgb3Igbm9kZS5qcwoJICovCgljdHguc3ByaW50ZiA9IHNwcmludGY7CgljdHgudnNwcmludGYgPSB2c3ByaW50ZjsKfSkoKTsKCgoKLyoqKi8gfSksCgovKioqLyA4MjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbigpIHsKICAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICAgdmFyIGNvbm5lY3QgPSBnbG9iYWwuY29ubmVjdCB8fCB7fTsKICAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgU3RyZWFtCiAgICAqCiAgICAqIFJlcHJlc2VudHMgYW4gb2JqZWN0IGZyb20gd2hpY2ggbWVzc2FnZXMgY2FuIGJlIHJlYWQgYW5kIHRvIHdoaWNoCiAgICAqIG1lc3NhZ2VzIGNhbiBiZSBzZW50LgogICAgKi8KICAgdmFyIFN0cmVhbSA9IGZ1bmN0aW9uKCkge307CgogICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gdGhlIHN0cmVhbS4gIFRoaXMgbWV0aG9kIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3Nlcy4KICAgICovCiAgIFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuTm90SW1wbGVtZW50ZWRFcnJvcigpOwogICB9OwoKICAgLyoqCiAgICAqIFByb3ZpZGUgYSBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gbWVzc2FnZXMgYXJlIHJlY2VpdmVkIGZyb20gdGhpcyBzdHJlYW0uCiAgICAqIFRoaXMgbWV0aG9kIG11c3QgYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2xhc3Nlcy4KICAgICovCiAgIFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aHJvdyBuZXcgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgTnVsbFN0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIG51bGwgc3RyZWFtIHdoaWNoIHByb3ZpZGVzIG5vIG1lc3NhZ2Ugc2VuZGluZyBvciByZWNlaXZpbmcgZmFjaWxpdGllcy4KICAgICovCiAgIHZhciBOdWxsU3RyZWFtID0gZnVuY3Rpb24oKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICB9OwogICBOdWxsU3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTnVsbFN0cmVhbTsKCiAgIE51bGxTdHJlYW0ucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHt9OwogICBOdWxsU3RyZWFtLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkge307CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgV2luZG93U3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIGZvciBjb21tdW5pY2F0aW5nIHdpdGggYSB3aW5kb3cgb2JqZWN0LiAgVGhlIGRvbWFpbiBwcm92aWRlZAogICAgKiBtdXN0IG1hdGNoIHRoZSBhbGxvd2VkIG1lc3NhZ2UgZG9tYWlucyBvZiB0aGUgZG93bnN0cmVhbSByZWNlaXZlcgogICAgKiBvciBtZXNzYWdlcyB3aWxsIGJlIHJlamVjdGVkLCBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dpbmRvdy9wb3N0TWVzc2FnZQogICAgKiBmb3IgbW9yZSBpbmZvLgogICAgKi8KICAgdmFyIFdpbmRvd1N0cmVhbSA9IGZ1bmN0aW9uKHdpbiwgZG9tYWluKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLndpbmRvdyA9IHdpbjsKICAgICAgdGhpcy5kb21haW4gPSBkb21haW4gfHwgJyonOwogICB9OwogICBXaW5kb3dTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdpbmRvd1N0cmVhbTsKCiAgIFdpbmRvd1N0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy53aW5kb3cucG9zdE1lc3NhZ2UobWVzc2FnZSwgdGhpcy5kb21haW4pOwogICB9OwoKICAgV2luZG93U3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBmKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBXaW5kb3dJT1N0cmVhbSBleHRlbmRzIFN0cmVhbQogICAgKgogICAgKiBBIHN0cmVhbSB1c2VkIGJ5IElGcmFtZS9wb3B1cCB3aW5kb3dzIHRvIGNvbW11bmljYXRlIHdpdGggdGhlaXIgcGFyZW50cwogICAgKiBhbmQgdmlzZSB2ZXJzYS4KICAgICoKICAgICogVGhpcyBvYmplY3QgZW5jYXBzdWxhdGVzIHRoZSBmYWN0IHRoYXQgaW5jb21pbmcgYW5kIG91dGdvaW5nIG1lc3NhZ2VzCiAgICAqIGFycml2ZSBvbiBkaWZmZXJlbnQgd2luZG93cyBhbmQgYWxsb3dzIHRoaXMgdG8gYmUgbWFuYWdlZCBhcyBhIHNpbmdsZQogICAgKiBTdHJlYW0gb2JqZWN0LgogICAgKi8KICAgdmFyIFdpbmRvd0lPU3RyZWFtID0gZnVuY3Rpb24oaW5wdXR3aW4sIG91dHB1dHdpbiwgZG9tYWluKSB7CiAgICAgIFN0cmVhbS5jYWxsKHRoaXMpOwogICAgICB0aGlzLmlucHV0ID0gaW5wdXR3aW47CiAgICAgIHRoaXMub3V0cHV0ID0gb3V0cHV0d2luOwogICAgICB0aGlzLmRvbWFpbiA9IGRvbWFpbiB8fCAnKic7CiAgIH07CiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3RyZWFtLnByb3RvdHlwZSk7CiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFdpbmRvd0lPU3RyZWFtOwoKICAgV2luZG93SU9TdHJlYW0ucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbihtZXNzYWdlKSB7CiAgICAgIHRoaXMub3V0cHV0LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIHRoaXMuZG9tYWluKTsKICAgfTsKCiAgIFdpbmRvd0lPU3RyZWFtLnByb3RvdHlwZS5vbk1lc3NhZ2UgPSBmdW5jdGlvbihmKSB7CiAgICAgIHRoaXMuaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIChtZXNzYWdlKSA9PiB7CiAgICAgICAgIGlmIChtZXNzYWdlLnNvdXJjZSA9PT0gdGhpcy5vdXRwdXQpIHsKICAgICAgICAgICAgZihtZXNzYWdlKTsKICAgICAgICAgfQogICAgICB9KTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBQb3J0U3RyZWFtIGV4dGVuZHMgU3RyZWFtCiAgICAqCiAgICAqIEEgc3RyZWFtIHdyYXBwaW5nIGFuIEhUTUw1IFdvcmtlciBwb3J0LiAgVGhpcyBjb3VsZCBiZSB0aGUgcG9ydAogICAgKiB1c2VkIHRvIGNvbm5lY3QgdG8gYSBXb3JrZXIgb3Igb25lIG9mIHRoZSBtdWx0aXR1ZGUgb2YgcG9ydHMKICAgICogbWFkZSBhdmFpbGFibGUgdG8gYSBTaGFyZWRXb3JrZXIgZm9yIGNvbW11bmljYXRpb24gYmFjayB0bwogICAgKiBpdHMgY29ubmVjdGVkIGNsaWVudHMuCiAgICAqLwogICB2YXIgUG9ydFN0cmVhbSA9IGZ1bmN0aW9uKHBvcnQpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMucG9ydCA9IHBvcnQ7CiAgICAgIHRoaXMuaWQgPSBjb25uZWN0LnJhbmRvbUlkKCk7CiAgIH07CiAgIFBvcnRTdHJlYW0ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQb3J0U3RyZWFtOwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgICAgdGhpcy5wb3J0LnBvc3RNZXNzYWdlKG1lc3NhZ2UpOwogICB9OwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUub25NZXNzYWdlID0gZnVuY3Rpb24oZikgewogICAgICB0aGlzLnBvcnQuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGYpOwogICB9OwoKICAgUG9ydFN0cmVhbS5wcm90b3R5cGUuZ2V0SWQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaWQ7CiAgIH07CgogICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogY2xhc3MgU3RyZWFtTXVsdGlwbGV4ZXIgZXh0ZW5kcyBTdHJlYW0KICAgICoKICAgICogQSB3cmFwcGVyIGZvciBtdWx0aXBsZXhlZCBkb3duc3RyZWFtIGNvbW11bmljYXRpb24gd2l0aAogICAgKiBtdWx0aXBsZSBzdHJlYW1zIGF0IG9uY2UuICBNYWlubHkgdXNlZnVsIGZvciB0aGUgU2hhcmVkV29ya2VyIHRvCiAgICAqIGJyb2FkY2FzdCBldmVudHMgdG8gbWFueSBQb3J0U3RyZWFtIG9iamVjdHMgYXQgb25jZS4KICAgICovCiAgIHZhciBTdHJlYW1NdWx0aXBsZXhlciA9IGZ1bmN0aW9uKHN0cmVhbXMpIHsKICAgICAgU3RyZWFtLmNhbGwodGhpcyk7CiAgICAgIHRoaXMuc3RyZWFtTWFwID0gc3RyZWFtcyA/CiAgICAgICAgIGNvbm5lY3QuaW5kZXgoc3RyZWFtcywgZnVuY3Rpb24ocykgeyByZXR1cm4gcy5nZXRJZCgpOyB9KSA6IHt9OwogICAgICB0aGlzLm1lc3NhZ2VMaXN0ZW5lcnMgPSBbXTsKICAgfTsKICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShTdHJlYW0ucHJvdG90eXBlKTsKICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gU3RyZWFtTXVsdGlwbGV4ZXI7CgogICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgdG8gYWxsIHBvcnRzIGluIHRoZSBtdWx0aXBsZXhlci4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgICB0aGlzLmdldFN0cmVhbXMoKS5mb3JFYWNoKGZ1bmN0aW9uKHN0cmVhbSkgewogICAgICAgICB0cnkgewogICAgICAgICAgICBzdHJlYW0uc2VuZChtZXNzYWdlKTsKCiAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gQ291bGRuJ3Qgc2VuZCBtZXNzYWdlIHRvIG9uZSBvZiB0aGUgZG93bnN0cmVhbXMgZm9yIHNvbWUgcmVhc29uLi4uCiAgICAgICAgICAgIC8vIE5vIHJlbGlhYmxlIGxvZ2dpbmcgcG9zc2libGUgd2l0aG91dCBmdXJ0aGVyIGZhaWx1cmVzLAogICAgICAgICAgICAvLyBubyByZWNvdmVyeSwganVzdCBlYXQgaXQuCiAgICAgICAgIH0KICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogUmVnaXN0ZXIgYSBtZXRob2Qgd2hpY2ggd2lsbCBiZSBjYWxsZWQgd2hlbiBhIG1lc3NhZ2UgaXMgcmVjZWl2ZWQgZnJvbQogICAgKiBhbnkgb2YgdGhlIGRvd25zdHJlYW1zLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLm9uTWVzc2FnZSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzLnB1c2goZik7CgogICAgICAvLyBVcGRhdGUgZXhpc3Rpbmcgc3RyZWFtcyB3aXRoIHRoZSBuZXcgbGlzdGVuZXIuCiAgICAgIHRoaXMuZ2V0U3RyZWFtcygpLmZvckVhY2goZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgICAgIHN0cmVhbS5vbk1lc3NhZ2UoZik7CiAgICAgIH0pOwogICB9OwoKICAgLyoqCiAgICAqIEFkZCBhIHN0cmVhbSB0byB0aGUgbXVsdGlwbGV4ZXIuCiAgICAqLwogICBTdHJlYW1NdWx0aXBsZXhlci5wcm90b3R5cGUuYWRkU3RyZWFtID0gZnVuY3Rpb24oc3RyZWFtKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdGhpcy5zdHJlYW1NYXBbc3RyZWFtLmdldElkKCldID0gc3RyZWFtOwoKICAgICAgLy8gVXBkYXRlIHN0cmVhbSB3aXRoIGV4aXN0aW5nIGxpc3RlbmVycy4KICAgICAgdGhpcy5tZXNzYWdlTGlzdGVuZXJzLmZvckVhY2goZnVuY3Rpb24obWVzc2FnZUxpc3RlbmVyKSB7CiAgICAgICAgIHN0cmVhbS5vbk1lc3NhZ2UobWVzc2FnZUxpc3RlbmVyKTsKICAgICAgfSk7CiAgIH07CgogICAvKioKICAgICogUmVtb3ZlIHRoZSBnaXZlbiBkb3duc3RyZWFtLiAgVGhpcyBpcyB0eXBpY2FsbHkgdXNlZCBpbiByZXNwb25zZQogICAgKiB0byB0aGUgU2hhcmVkV29ya2VyJ3Mgb25jbG9zZSBldmVudCwgaW5kaWNhdGluZyB0aGF0IGEgY29uc3VtZXIKICAgICogdGFiIGhhcyBiZWVuIGNsb3NlZC4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5yZW1vdmVTdHJlYW0gPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgZGVsZXRlIHRoaXMuc3RyZWFtTWFwW3N0cmVhbS5nZXRJZCgpXTsKICAgfTsKCiAgIC8qKgogICAgKiBHZXQgYSBsaXN0IG9mIHN0cmVhbXMgaW4gdGhlIG11bHRpcGxleGVyLgogICAgKi8KICAgU3RyZWFtTXVsdGlwbGV4ZXIucHJvdG90eXBlLmdldFN0cmVhbXMgPSBmdW5jdGlvbihzdHJlYW0pIHsKICAgICAgcmV0dXJuIGNvbm5lY3QudmFsdWVzKHRoaXMuc3RyZWFtTWFwKTsKICAgfTsKCiAgIC8qKgogICAgKiBHZXQgdGhlIHN0cmVhbSBtYXRjaGluZyB0aGUgZ2l2ZW4gcG9ydC4KICAgICovCiAgIFN0cmVhbU11bHRpcGxleGVyLnByb3RvdHlwZS5nZXRTdHJlYW1Gb3JQb3J0ID0gZnVuY3Rpb24ocG9ydCkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKHRoaXMuZ2V0U3RyZWFtcygpLCBmdW5jdGlvbihzKSB7CiAgICAgICAgIHJldHVybiBzLnBvcnQgPT09IHBvcnQ7CiAgICAgIH0pOwogICB9OwoKICAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAqIGNsYXNzIENvbmR1aXQKICAgICoKICAgICogQW4gb2JqZWN0IHdoaWNoIGJyaWRnZXMgYW4gdXBzdHJlYW0gYW5kIGEgZG93bnN0cmVhbSwgYWxsb3dpbmcgbWVzc2FnZXMKICAgICogdG8gYmUgcGFzc2VkIHRvIGFuZCBmcm9tIGVhY2ggYW5kIHByb3ZpZGluZyBhbiBldmVudCBidXMgZm9yIGV2ZW50CiAgICAqIHN1YnNjcmlwdGlvbnMgdG8gYmUgbWFkZSB1cHN0cmVhbSBhbmQgZG93bnN0cmVhbS4KICAgICovCiAgIHZhciBDb25kdWl0ID0gZnVuY3Rpb24obmFtZSwgdXBzdHJlYW0sIGRvd25zdHJlYW0pIHsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy51cHN0cmVhbSA9IHVwc3RyZWFtIHx8IG5ldyBOdWxsU3RyZWFtKCk7CiAgICAgIHRoaXMuZG93bnN0cmVhbSA9IGRvd25zdHJlYW0gfHwgbmV3IE51bGxTdHJlYW0oKTsKICAgICAgdGhpcy5kb3duc3RyZWFtQnVzID0gbmV3IGNvbm5lY3QuRXZlbnRCdXMoKTsKICAgICAgdGhpcy51cHN0cmVhbUJ1cyA9IG5ldyBjb25uZWN0LkV2ZW50QnVzKCk7CgogICAgICB0aGlzLnVwc3RyZWFtLm9uTWVzc2FnZShjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2Rpc3BhdGNoRXZlbnQsIHRoaXMudXBzdHJlYW1CdXMpKTsKICAgICAgdGhpcy5kb3duc3RyZWFtLm9uTWVzc2FnZShjb25uZWN0LmhpdGNoKHRoaXMsIHRoaXMuX2Rpc3BhdGNoRXZlbnQsIHRoaXMuZG93bnN0cmVhbUJ1cykpOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUub25VcHN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMudXBzdHJlYW1CdXMuc3Vic2NyaWJlKGV2ZW50TmFtZSwgZik7CiAgIH07CgogICBDb25kdWl0LnByb3RvdHlwZS5vbkFsbFVwc3RyZWFtID0gZnVuY3Rpb24oZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZiwgJ2YnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihmKSwgJ2YgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIHJldHVybiB0aGlzLnVwc3RyZWFtQnVzLnN1YnNjcmliZUFsbChmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZikgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmLCAnZicpOwogICAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGYpLCAnZiBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKICAgICAgcmV0dXJuIHRoaXMuZG93bnN0cmVhbUJ1cy5zdWJzY3JpYmUoZXZlbnROYW1lLCBmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLm9uQWxsRG93bnN0cmVhbSA9IGZ1bmN0aW9uKGYpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGYsICdmJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0VHJ1ZShjb25uZWN0LmlzRnVuY3Rpb24oZiksICdmIG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICByZXR1cm4gdGhpcy5kb3duc3RyZWFtQnVzLnN1YnNjcmliZUFsbChmKTsKICAgfTsKCiAgIENvbmR1aXQucHJvdG90eXBlLnNlbmRVcHN0cmVhbSA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZXZlbnROYW1lLCAnZXZlbnROYW1lJyk7CiAgICAgIHRoaXMudXBzdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuc2VuZERvd25zdHJlYW0gPSBmdW5jdGlvbihldmVudE5hbWUsIGRhdGEpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGV2ZW50TmFtZSwgJ2V2ZW50TmFtZScpOwogICAgICB0aGlzLmRvd25zdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICB9OwoKICAgQ29uZHVpdC5wcm90b3R5cGUuX2Rpc3BhdGNoRXZlbnQgPSBmdW5jdGlvbihidXMsIG1lc3NhZ2VFdmVudCkgewogICAgICB2YXIgbWVzc2FnZSA9IG1lc3NhZ2VFdmVudC5kYXRhOwogICAgICBpZiAobWVzc2FnZS5ldmVudCkgewogICAgICAgICBidXMudHJpZ2dlcihtZXNzYWdlLmV2ZW50LCBtZXNzYWdlLmRhdGEpOwogICAgICB9CiAgIH07CgogICAvKioKICAgICogUmV0dXJucyBhIGNsb3N1cmUgd2hpY2ggcGFzc2VzIGV2ZW50cyB1cHN0cmVhbS4KICAgICoKICAgICogVXNhZ2U6CiAgICAqIGNvbmR1aXQub25Eb3duc3RyZWFtKCJNeUV2ZW50IiwgY29uZHVpdC5wYXNzVXBzdHJlYW0oKSk7CiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5wYXNzVXBzdHJlYW0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICByZXR1cm4gZnVuY3Rpb24oZGF0YSwgZXZlbnROYW1lKSB7CiAgICAgICAgIHNlbGYudXBzdHJlYW0uc2VuZCh7ZXZlbnQ6IGV2ZW50TmFtZSwgZGF0YTogZGF0YX0pOwogICAgICB9OwogICB9OwoKICAgLyoqCiAgICAqIFJldHVybnMgYSBjbG9zdXJlIHdoaWNoIHBhc3NlcyBldmVudHMgZG93bnN0cmVhbS4KICAgICoKICAgICogVXNhZ2U6CiAgICAqIGNvbmR1aXQub25VcHN0cmVhbSgiTXlFdmVudCIsIGNvbmR1aXQucGFzc0Rvd25zdHJlYW0oKSk7CiAgICAqLwogICBDb25kdWl0LnByb3RvdHlwZS5wYXNzRG93bnN0cmVhbSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhLCBldmVudE5hbWUpIHsKICAgICAgICAgc2VsZi5kb3duc3RyZWFtLnNlbmQoe2V2ZW50OiBldmVudE5hbWUsIGRhdGE6IGRhdGF9KTsKICAgICAgfTsKICAgfTsKCiAgIC8qKgogICAgKiBTaHV0ZG93biB0aGUgY29uZHVpdCdzIGV2ZW50IGJ1c3NlcyBhbmQgcmVtb3ZlIGFsbCBzdWJzY3JpcHRpb25zLgogICAgKi8KICAgQ29uZHVpdC5wcm90b3R5cGUuc2h1dGRvd24gPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy51cHN0cmVhbUJ1cy51bnN1YnNjcmliZUFsbCgpOwogICAgICB0aGlzLmRvd25zdHJlYW1CdXMudW5zdWJzY3JpYmVBbGwoKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgKiBjbGFzcyBJRnJhbWVDb25kdWl0IGV4dGVuZHMgQ29uZHVpdAogICAgKgogICAgKiBDcmVhdGVzIGEgY29uZHVpdCBmb3IgdGhlIGdpdmVuIElGcmFtZSBlbGVtZW50LgogICAgKi8KICAgdmFyIElGcmFtZUNvbmR1aXQgPSBmdW5jdGlvbihuYW1lLCB3aW5kb3csIGlmcmFtZSwgZG9tYWluKSB7CiAgICAgIENvbmR1aXQuY2FsbCh0aGlzLCBuYW1lLCBuZXcgV2luZG93SU9TdHJlYW0od2luZG93LCBpZnJhbWUuY29udGVudFdpbmRvdywgZG9tYWluIHx8ICcqJyksIG51bGwpOwogICB9OwogICBJRnJhbWVDb25kdWl0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQ29uZHVpdC5wcm90b3R5cGUpOwogICBJRnJhbWVDb25kdWl0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IElGcmFtZUNvbmR1aXQ7CgogICBjb25uZWN0LlN0cmVhbSA9IFN0cmVhbTsKICAgY29ubmVjdC5OdWxsU3RyZWFtID0gTnVsbFN0cmVhbTsKICAgY29ubmVjdC5XaW5kb3dTdHJlYW0gPSBXaW5kb3dTdHJlYW07CiAgIGNvbm5lY3QuV2luZG93SU9TdHJlYW0gPSBXaW5kb3dJT1N0cmVhbTsKICAgY29ubmVjdC5Qb3J0U3RyZWFtID0gUG9ydFN0cmVhbTsKICAgY29ubmVjdC5TdHJlYW1NdWx0aXBsZXhlciA9IFN0cmVhbU11bHRpcGxleGVyOwogICBjb25uZWN0LkNvbmR1aXQgPSBDb25kdWl0OwogICBjb25uZWN0LklGcmFtZUNvbmR1aXQgPSBJRnJhbWVDb25kdWl0Owp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gODMzOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uKCkgewogICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogICBnbG9iYWwuY29ubmVjdCA9IGNvbm5lY3Q7CiAgIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogR3JhcGhMaW5rIDw8YWJzdHJhY3QgY2xhc3M+PgogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBhc3NvY2lhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEgc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKGZyb21TdGF0ZSwgJ2Zyb21TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwodG9TdGF0ZSwgJ3RvU3RhdGUnKTsKICAgICAgdGhpcy5mcm9tU3RhdGUgPSBmcm9tU3RhdGU7CiAgICAgIHRoaXMudG9TdGF0ZSA9IHRvU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEFzc29jaWF0aW9ucyA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgdGhyb3cgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldEZyb21TdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5mcm9tU3RhdGU7CiAgIH07CgogICBHcmFwaExpbmsucHJvdG90eXBlLmdldFRvU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMudG9TdGF0ZTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRGlyZWN0R3JhcGhMaW5rIDw8Y29uY3JldGUgY2xhc3M+PiBleHRlbmRzIEdyYXBoTGluawogICAgKgogICAgKiBSZXByZXNlbnRzIHRoZSBieS12YWx1ZSByZXByZXNlbnRhdGlvbiBvZiBvbmUgb3IgbW9yZSBhdHRyaWJ1dGVzIHRvIGEKICAgICogc3RhdGUgdHJhbnNpdGlvbi4KICAgICovCiAgIHZhciBEaXJlY3RHcmFwaExpbmsgPSBmdW5jdGlvbihmcm9tU3RhdGUsIHRvU3RhdGUsIGFzc29jaWF0aW9ucykgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoYXNzb2NpYXRpb25zLCAnYXNzb2NpYXRpb25zJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zOwogICB9OwogICBEaXJlY3RHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRGlyZWN0R3JhcGhMaW5rLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IERpcmVjdEdyYXBoTGluazsKCiAgIERpcmVjdEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5hc3NvY2lhdGlvbnM7CiAgIH07CgogICAvKioKICAgICogRnVuY3Rpb25hbEdyYXBoTGluayA8PGNvbmNyZXRlIGNsYXNzPj4gZXh0ZW5kcyBHcmFwaExpbmsKICAgICoKICAgICogUmVwcmVzZW50cyBhIGZ1bmN0aW9uYWwgYXNzb2NpYXRpb24gb2Ygb25lIG9yIG1vcmUgYXR0cmlidXRlcyB0byBhCiAgICAqIHN0YXRlIHRyYW5zaXRpb24uCiAgICAqLwogICB2YXIgRnVuY3Rpb25hbEdyYXBoTGluayA9IGZ1bmN0aW9uKGZyb21TdGF0ZSwgdG9TdGF0ZSwgY2xvc3VyZSkgewogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoZnJvbVN0YXRlLCAnZnJvbVN0YXRlJyk7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b1N0YXRlLCAndG9TdGF0ZScpOwogICAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoY2xvc3VyZSwgJ2Nsb3N1cmUnKTsKICAgICAgY29ubmVjdC5hc3NlcnRUcnVlKGNvbm5lY3QuaXNGdW5jdGlvbihjbG9zdXJlKSwgJ2Nsb3N1cmUgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CiAgICAgIEdyYXBoTGluay5jYWxsKHRoaXMsIGZyb21TdGF0ZSwgdG9TdGF0ZSk7CiAgICAgIHRoaXMuY2xvc3VyZSA9IGNsb3N1cmU7CiAgIH07CiAgIEZ1bmN0aW9uYWxHcmFwaExpbmsucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShHcmFwaExpbmsucHJvdG90eXBlKTsKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBGdW5jdGlvbmFsR3JhcGhMaW5rOwoKICAgRnVuY3Rpb25hbEdyYXBoTGluay5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCkgewogICAgICByZXR1cm4gdGhpcy5jbG9zdXJlKGNvbnRleHQsIHRoaXMuZ2V0RnJvbVN0YXRlKCksIHRoaXMuZ2V0VG9TdGF0ZSgpKTsKICAgfTsKCiAgIC8qKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICogRXZlbnRHcmFwaCA8PGNsYXNzPj4KICAgICoKICAgICogQnVpbGRzIGEgbWFwIG9mIGFzc29jaWF0aW9ucyBmcm9tIG9uZSBzdGF0ZSB0byBhbm90aGVyIGluIGNvbnRleHQgb2YgYQogICAgKiBwYXJ0aWN1bGFyIG9iamVjdC4gIFRoZSBhc3NvY2lhdGlvbnMgY2FuIGJlIGRpcmVjdCAob25lIG9yIG1vcmUgdmFsdWVzKQogICAgKiBvciBmdW5jdGlvbmFsIChhIG1ldGhvZCByZXR1cm5pbmcgb25lIG9yIG1vcmUgdmFsdWVzKSwgYW5kIGFyZSB1c2VkIHRvCiAgICAqIHByb3ZpZGUgYWRkaXRpb25hbCBjb250ZXh0dWFsIGV2ZW50IGhvb2tzIGZvciB0aGUgVUkgdG8gY29uc3VtZS4KICAgICovCiAgIHZhciBFdmVudEdyYXBoID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZnJvbU1hcCA9IHt9OwogICB9OwogICBFdmVudEdyYXBoLkFOWSA9ICI8PGFueT4+IjsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLmFzc29jID0gZnVuY3Rpb24oZnJvbVN0YXRlT2JqLCB0b1N0YXRlT2JqLCBhc3NvY09iaikgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICBpZiAoISBmcm9tU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJmcm9tU3RhdGVPYmogaXMgbm90IGRlZmluZWQuIik7CiAgICAgIH0KCiAgICAgIGlmICghIHRvU3RhdGVPYmopIHsKICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0b1N0YXRlT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoISBhc3NvY09iaikgewogICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFzc29jT2JqIGlzIG5vdCBkZWZpbmVkLiIpOwogICAgICB9CgogICAgICBpZiAoZnJvbVN0YXRlT2JqIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgZnJvbVN0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24oZnJvbVN0YXRlKSB7CiAgICAgICAgICAgIHNlbGYuYXNzb2MoZnJvbVN0YXRlLCB0b1N0YXRlT2JqLCBhc3NvY09iaik7CiAgICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHRvU3RhdGVPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICB0b1N0YXRlT2JqLmZvckVhY2goZnVuY3Rpb24odG9TdGF0ZSkgewogICAgICAgICAgICBzZWxmLmFzc29jKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZSwgYXNzb2NPYmopOwogICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAgaWYgKHR5cGVvZiBhc3NvY09iaiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRnVuY3Rpb25hbEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIGFzc29jT2JqKSk7CiAgICAgICAgIH0gZWxzZSBpZiAoYXNzb2NPYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICAgICAgICB0aGlzLl9hZGRBc3NvY2lhdGlvbihuZXcgRGlyZWN0R3JhcGhMaW5rKGZyb21TdGF0ZU9iaiwgdG9TdGF0ZU9iaiwgYXNzb2NPYmopKTsKICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fYWRkQXNzb2NpYXRpb24obmV3IERpcmVjdEdyYXBoTGluayhmcm9tU3RhdGVPYmosIHRvU3RhdGVPYmosIFthc3NvY09ial0pKTsKICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuZ2V0QXNzb2NpYXRpb25zID0gZnVuY3Rpb24oY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSB7CiAgICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChmcm9tU3RhdGUsICdmcm9tU3RhdGUnKTsKICAgICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvU3RhdGUsICd0b1N0YXRlJyk7CiAgICAgIHZhciBhc3NvY2lhdGlvbnMgPSBbXTsKCiAgICAgIHZhciB0b01hcEZyb21BbnkgPSB0aGlzLmZyb21NYXBbRXZlbnRHcmFwaC5BTlldIHx8IHt9OwogICAgICB2YXIgdG9NYXAgPSB0aGlzLmZyb21NYXBbZnJvbVN0YXRlXSB8fCB7fTsKCiAgICAgIGFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucy5jb25jYXQodGhpcy5fZ2V0QXNzb2NpYXRpb25zRnJvbU1hcCgKICAgICAgICAgICAgICAgdG9NYXBGcm9tQW55LCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpKTsKICAgICAgYXNzb2NpYXRpb25zID0gYXNzb2NpYXRpb25zLmNvbmNhdCh0aGlzLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwKAogICAgICAgICAgICAgICB0b01hcCwgY29udGV4dCwgZnJvbVN0YXRlLCB0b1N0YXRlKSk7CgogICAgICByZXR1cm4gYXNzb2NpYXRpb25zOwogICB9OwoKICAgRXZlbnRHcmFwaC5wcm90b3R5cGUuX2FkZEFzc29jaWF0aW9uID0gZnVuY3Rpb24oYXNzb2MpIHsKICAgICAgdmFyIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXTsKCiAgICAgIGlmICghIHRvTWFwKSB7CiAgICAgICAgIHRvTWFwID0gdGhpcy5mcm9tTWFwW2Fzc29jLmdldEZyb21TdGF0ZSgpXSA9IHt9OwogICAgICB9CgogICAgICB2YXIgYXNzb2NMaXN0ID0gdG9NYXBbYXNzb2MuZ2V0VG9TdGF0ZSgpXTsKCiAgICAgIGlmICghIGFzc29jTGlzdCkgewogICAgICAgICBhc3NvY0xpc3QgPSB0b01hcFthc3NvYy5nZXRUb1N0YXRlKCldID0gW107CiAgICAgIH0KCiAgICAgIGFzc29jTGlzdC5wdXNoKGFzc29jKTsKICAgfTsKCiAgIEV2ZW50R3JhcGgucHJvdG90eXBlLl9nZXRBc3NvY2lhdGlvbnNGcm9tTWFwID0gZnVuY3Rpb24obWFwLCBjb250ZXh0LCBmcm9tU3RhdGUsIHRvU3RhdGUpIHsKICAgICAgdmFyIGFzc29jTGlzdCA9IChtYXBbRXZlbnRHcmFwaC5BTlldIHx8IFtdKS5jb25jYXQobWFwW3RvU3RhdGVdIHx8IFtdKTsKICAgICAgcmV0dXJuIGFzc29jTGlzdC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgYXNzb2MpIHsKICAgICAgICAgcmV0dXJuIHByZXYuY29uY2F0KGFzc29jLmdldEFzc29jaWF0aW9ucyhjb250ZXh0KSk7CiAgICAgIH0sIFtdKTsKICAgfTsKCiAgIGNvbm5lY3QuRXZlbnRHcmFwaCA9IEV2ZW50R3JhcGg7Cgp9KSgpOwoKCi8qKiovIH0pLAoKLyoqKi8gODkxOgovKioqLyAoKCkgPT4gewoKLyoKICogQ29weXJpZ2h0IDIwMTQtMjAxNyBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMAogKi8KKGZ1bmN0aW9uICgpIHsKICB2YXIgZ2xvYmFsID0gdGhpcyB8fCBnbG9iYWxUaGlzOwogIHZhciBjb25uZWN0ID0gZ2xvYmFsLmNvbm5lY3QgfHwge307CiAgZ2xvYmFsLmNvbm5lY3QgPSBjb25uZWN0OwogIGdsb2JhbC5saWx5ID0gY29ubmVjdDsKCiAgdmFyIHVzZXJBZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgdmFyIE9ORV9EQVlfTUlMTElTID0gMjQgKiA2MCAqIDYwICogMTAwMDsKICB2YXIgREVGQVVMVF9QT1BVUF9IRUlHSFQgPSA1Nzg7CiAgdmFyIERFRkFVTFRfUE9QVVBfV0lEVEggPSA0MzM7CiAgdmFyIENPUFlBQkxFX0VWRU5UX0ZJRUxEUyA9IFsiYnViYmxlcyIsICJjYW5jZWxCdWJibGUiLCAiY2FuY2VsYWJsZSIsICJjb21wb3NlZCIsICJkYXRhIiwgImRlZmF1bHRQcmV2ZW50ZWQiLCAiZXZlbnRQaGFzZSIsICJpc1RydXN0ZWQiLCAibGFzdEV2ZW50SWQiLCAib3JpZ2luIiwgInJldHVyblZhbHVlIiwgInRpbWVTdGFtcCIsICJ0eXBlIl07CgogIC8qKgogICAqIFVucG9sbHV0ZSBzcHJpbnRmIGZ1bmN0aW9ucyBmcm9tIHRoZSBnbG9iYWwgbmFtZXNwYWNlLgogICAqLwogIGNvbm5lY3Quc3ByaW50ZiA9IGdsb2JhbC5zcHJpbnRmOwogIGNvbm5lY3QudnNwcmludGYgPSBnbG9iYWwudnNwcmludGY7CiAgZGVsZXRlIGdsb2JhbC5zcHJpbnRmOwogIGRlbGV0ZSBnbG9iYWwudnNwcmludGY7CgogIGNvbm5lY3QuSFRUUF9TVEFUVVNfQ09ERVMgPSB7CiAgICBTVUNDRVNTOiAyMDAsCiAgICBUT09fTUFOWV9SRVFVRVNUUzogNDI5LAogICAgSU5URVJOQUxfU0VSVkVSX0VSUk9SOiA1MDAKICB9OwoKICBjb25uZWN0LlRSQU5TUE9SVF9UWVBFUyA9IHsKICAgIENIQVRfVE9LRU46ICJjaGF0X3Rva2VuIiwKICAgIFdFQl9TT0NLRVQ6ICJ3ZWJfc29ja2V0IgogIH07CgogIC8qKgogICAqIEJpbmRzIHRoZSBnaXZlbiBpbnN0YW5jZSBvYmplY3QgYXMgdGhlIGNvbnRleHQgZm9yCiAgICogdGhlIG1ldGhvZCBwcm92aWRlZC4KICAgKgogICAqIEBwYXJhbSBzY29wZSBUaGUgaW5zdGFuY2Ugb2JqZWN0IHRvIGJlIHNldCBhcyB0aGUgc2NvcGUKICAgKiAgICBvZiB0aGUgZnVuY3Rpb24uCiAgICogQHBhcmFtIG1ldGhvZCBUaGUgbWV0aG9kIHRvIGJlIGVuY2Fwc3VsYXRlZC4KICAgKgogICAqIEFsbCBvdGhlciBhcmd1bWVudHMsIGlmIGFueSwgYXJlIGJvdW5kIHRvIHRoZSBtZXRob2QKICAgKiBpbnZvY2F0aW9uIGluc2lkZSB0aGUgY2xvc3VyZS4KICAgKgogICAqIEByZXR1cm4gQSBjbG9zdXJlIGVuY2Fwc3VsYXRpbmcgdGhlIGludm9jYXRpb24gb2YgdGhlCiAgICogICAgbWV0aG9kIHByb3ZpZGVkIGluIGNvbnRleHQgb2YgdGhlIGdpdmVuIGluc3RhbmNlLgogICAqLwogIGNvbm5lY3QuaGl0Y2ggPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgc2NvcGUgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgbWV0aG9kID0gYXJncy5zaGlmdCgpOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChzY29wZSwgJ3Njb3BlJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwobWV0aG9kLCAnbWV0aG9kJyk7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKG1ldGhvZCksICdtZXRob2QgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNsb3N1cmVBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseShzY29wZSwgYXJncy5jb25jYXQoY2xvc3VyZUFyZ3MpKTsKICAgIH07CiAgfTsKCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhIGNhbGxhYmxlIGZ1bmN0aW9uIHR5cGUuCiAgICogQm9ycm93ZWQgZnJvbSBVbmRlcnNjb3JlLmpzLgogICAqLwogIGNvbm5lY3QuaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIChvYmopIHsKICAgIHJldHVybiAhIShvYmogJiYgb2JqLmNvbnN0cnVjdG9yICYmIG9iai5jYWxsICYmIG9iai5hcHBseSk7CiAgfTsKCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhbiBhcnJheS4KICAgKi8KICBjb25uZWN0LmlzQXJyYXkgPSBmdW5jdGlvbiAob2JqKSB7CiAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBrZXlzIGZyb20gYSBKYXZhc2NyaXB0IG9iamVjdCB1c2VkCiAgICogYXMgYSBoYXNoIG1hcC4KICAgKi8KICBjb25uZWN0LmtleXMgPSBmdW5jdGlvbiAobWFwKSB7CiAgICB2YXIga2V5cyA9IFtdOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtYXAsICdtYXAnKTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICBrZXlzLnB1c2goayk7CiAgICB9CgogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiB2YWx1ZXMgZnJvbSBhIEphdmFzY3JpcHQgb2JqZWN0IHVzZWQKICAgKiBhcyBhIGhhc2ggbWFwLgogICAqLwogIGNvbm5lY3QudmFsdWVzID0gZnVuY3Rpb24gKG1hcCkgewogICAgdmFyIHZhbHVlcyA9IFtdOwoKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChtYXAsICdtYXAnKTsKCiAgICBmb3IgKHZhciBrIGluIG1hcCkgewogICAgICB2YWx1ZXMucHVzaChtYXBba10pOwogICAgfQoKICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKCiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiBrZXkvdmFsdWUgcGFpcnMgZnJvbSB0aGUgZ2l2ZW4gbWFwLgogICAqLwogIGNvbm5lY3QuZW50cmllcyA9IGZ1bmN0aW9uIChtYXApIHsKICAgIHZhciBlbnRyaWVzID0gW107CgogICAgZm9yICh2YXIgayBpbiBtYXApIHsKICAgICAgZW50cmllcy5wdXNoKHsga2V5OiBrLCB2YWx1ZTogbWFwW2tdIH0pOwogICAgfQoKICAgIHJldHVybiBlbnRyaWVzOwogIH07CgogIC8qKgogICAqIE1lcmdlIHR3byBvciBtb3JlIG1hcHMgdG9nZXRoZXIgaW50byBhIG5ldyBtYXAsCiAgICogb3Igc2ltcGx5IGNvcHkgYSBzaW5nbGUgbWFwLgogICAqLwogIGNvbm5lY3QubWVyZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJnTWFwcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgcmVzdWx0TWFwID0ge307CgogICAgYXJnTWFwcy5mb3JFYWNoKGZ1bmN0aW9uIChtYXApIHsKICAgICAgY29ubmVjdC5lbnRyaWVzKG1hcCkuZm9yRWFjaChmdW5jdGlvbiAoa3YpIHsKICAgICAgICByZXN1bHRNYXBba3Yua2V5XSA9IGt2LnZhbHVlOwogICAgICB9KTsKICAgIH0pOwoKICAgIHJldHVybiByZXN1bHRNYXA7CiAgfTsKCiAgY29ubmVjdC5ub3cgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgfTsKCiAgY29ubmVjdC5maW5kID0gZnVuY3Rpb24gKGFycmF5LCBwcmVkaWNhdGUpIHsKICAgIGZvciAodmFyIHggPSAwOyB4IDwgYXJyYXkubGVuZ3RoOyB4KyspIHsKICAgICAgaWYgKHByZWRpY2F0ZShhcnJheVt4XSkpIHsKICAgICAgICByZXR1cm4gYXJyYXlbeF07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9OwoKICBjb25uZWN0LmNvbnRhaW5zID0gZnVuY3Rpb24gKG9iaiwgdmFsdWUpIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBBcnJheSkgewogICAgICByZXR1cm4gY29ubmVjdC5maW5kKG9iaiwgZnVuY3Rpb24gKHYpIHsgcmV0dXJuIHYgPT09IHZhbHVlOyB9KSAhPSBudWxsOwoKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAodmFsdWUgaW4gb2JqKTsKICAgIH0KICB9OwoKICBjb25uZWN0LmNvbnRhaW5zVmFsdWUgPSBmdW5jdGlvbiAob2JqLCB2YWx1ZSkgewogICAgaWYgKG9iaiBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgIHJldHVybiBjb25uZWN0LmZpbmQob2JqLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CgogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNvbm5lY3QuZmluZChjb25uZWN0LnZhbHVlcyhvYmopLCBmdW5jdGlvbiAodikgeyByZXR1cm4gdiA9PT0gdmFsdWU7IH0pICE9IG51bGw7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogR2VuZXJhdGUgYSByYW5kb20gSUQgY29uc2lzdGluZyBvZiB0aGUgY3VycmVudCB0aW1lc3RhbXAKICAgKiBhbmQgYSByYW5kb20gYmFzZS0zNiBudW1iZXIgYmFzZWQgb24gTWF0aC5yYW5kb20oKS4KICAgKi8KICBjb25uZWN0LnJhbmRvbUlkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMtJXMiLCBjb25uZWN0Lm5vdygpLCBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKSk7CiAgfTsKCiAgLyoqCiAgICogR2VuZXJhdGUgYW4gZW51bSBmcm9tIHRoZSBnaXZlbiBsaXN0IG9mIGxvd2VyLWNhc2UgZW51bSB2YWx1ZXMsCiAgICogd2hlcmUgdGhlIGVudW0ga2V5cyB3aWxsIGJlIHVwcGVyIGNhc2UuCiAgICoKICAgKiBDb252ZXJzaW9uIGZyb20gcGFzY2FsIGNhc2UgYmFzZWQgb24gY29kZSBmcm9tIGhlcmU6CiAgICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zMDUyMTIyNAogICAqLwogIGNvbm5lY3QubWFrZUVudW0gPSBmdW5jdGlvbiAodmFsdWVzKSB7CiAgICB2YXIgZW51bU9iaiA9IHt9OwoKICAgIHZhbHVlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIga2V5ID0gdmFsdWUucmVwbGFjZSgvXC4/KFthLXpdKylfPy9nLCBmdW5jdGlvbiAoeCwgeSkgeyByZXR1cm4geS50b1VwcGVyQ2FzZSgpICsgIl8iOyB9KQogICAgICAgIC5yZXBsYWNlKC9fJC8sICIiKTsKCiAgICAgIGVudW1PYmpba2V5XSA9IHZhbHVlOwogICAgfSk7CgogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgY29ubmVjdC5tYWtlTmFtZXNwYWNlZEVudW0gPSBmdW5jdGlvbiAocHJlZml4LCB2YWx1ZXMpIHsKICAgIHZhciBlbnVtT2JqID0gY29ubmVjdC5tYWtlRW51bSh2YWx1ZXMpOwogICAgY29ubmVjdC5rZXlzKGVudW1PYmopLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBlbnVtT2JqW2tleV0gPSBjb25uZWN0LnNwcmludGYoIiVzOjolcyIsIHByZWZpeCwgZW51bU9ialtrZXldKTsKICAgIH0pOwogICAgcmV0dXJuIGVudW1PYmo7CiAgfTsKCiAgY29ubmVjdC5tYWtlR2VuZXJpY05hbWVzcGFjZWRFbnVtID0gZnVuY3Rpb24gKHByZWZpeCwgdmFsdWVzLCBkZWxpbWl0ZXIpIHsKICAgIHZhciBlbnVtT2JqID0gY29ubmVjdC5tYWtlRW51bSh2YWx1ZXMpOwogICAgY29ubmVjdC5rZXlzKGVudW1PYmopLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICBlbnVtT2JqW2tleV0gPSBjb25uZWN0LnNwcmludGYoIiVzIitkZWxpbWl0ZXIrIiVzIiwgcHJlZml4LCBlbnVtT2JqW2tleV0pOwogICAgfSk7CiAgICByZXR1cm4gZW51bU9iajsKICB9OwoKICAvKioKICAqIE1ldGhvZHMgdG8gZGV0ZXJtaW5lIGJyb3dzZXIgdHlwZSBhbmQgdmVyc2lvbnMsIHVzZWQgZm9yIHNvZnRwaG9uZSBpbml0aWFsaXphdGlvbi4KICAqLwogIGNvbm5lY3QuaXNDaHJvbWVCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSAhPT0gLTE7CiAgfTsKCiAgY29ubmVjdC5pc0ZpcmVmb3hCcm93c2VyID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuaXNPcGVyYUJyb3dzZXIgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdXNlckFnZW50LmluZGV4T2YoIk9wZXJhIikgIT09IC0xOwogIH07CgogIGNvbm5lY3QuZ2V0Q2hyb21lQnJvd3NlclZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY2hyb21lVmVyc2lvbiA9IHVzZXJBZ2VudC5zdWJzdHJpbmcodXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpICsgNyk7CiAgICBpZiAoY2hyb21lVmVyc2lvbikgewogICAgICByZXR1cm4gcGFyc2VGbG9hdChjaHJvbWVWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICBjb25uZWN0LmdldEZpcmVmb3hCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBmaXJlZm94VmVyc2lvbiA9IHVzZXJBZ2VudC5zdWJzdHJpbmcodXNlckFnZW50LmluZGV4T2YoIkZpcmVmb3giKSArIDgpOwogICAgaWYgKGZpcmVmb3hWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KGZpcmVmb3hWZXJzaW9uKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAtMTsKICAgIH0KICB9OwoKICBjb25uZWN0LmlzVmFsaWRMb2NhbGUgPSBmdW5jdGlvbiAobG9jYWxlKSB7CiAgICB2YXIgbGFuZ3VhZ2VzID0gWwogICAgICB7CiAgICAgICAgaWQ6ICdlbl9VUycsCiAgICAgICAgbGFiZWw6ICdFbmdsaXNoJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdkZV9ERScsCiAgICAgICAgbGFiZWw6ICdEZXV0c2NoJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdlc19FUycsCiAgICAgICAgbGFiZWw6ICdFc3Bhw7FvbCcKICAgICAgfSwKICAgICAgewogICAgICAgIGlkOiAnZnJfRlInLAogICAgICAgIGxhYmVsOiAnRnJhbsOnYWlzJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdqYV9KUCcsCiAgICAgICAgbGFiZWw6ICfml6XmnKzoqp4nCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ2l0X0lUJywKICAgICAgICBsYWJlbDogJ0l0YWxpYW5vJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICdrb19LUicsCiAgICAgICAgbGFiZWw6ICftlZzqta3slrQnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ3B0X0JSJywKICAgICAgICBsYWJlbDogJ1BvcnR1Z3XDqnMnCiAgICAgIH0sCiAgICAgIHsKICAgICAgICBpZDogJ3poX0NOJywKICAgICAgICBsYWJlbDogJ+S4reaWhyjnroDkvZMpJwogICAgICB9LAogICAgICB7CiAgICAgICAgaWQ6ICd6aF9UVycsCiAgICAgICAgbGFiZWw6ICfkuK3mloco57mB6auUKScKICAgICAgfQogICAgXTsKICAgIHJldHVybiBsYW5ndWFnZXMubWFwKGZ1bmN0aW9uKGxhbmd1YWdlKXsgcmV0dXJuIGxhbmd1YWdlLmlkfSkuaW5jbHVkZXMobG9jYWxlKTsKICB9CgogIGNvbm5lY3QuZ2V0T3BlcmFCcm93c2VyVmVyc2lvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB2ZXJzaW9uT2Zmc2V0ID0gdXNlckFnZW50LmluZGV4T2YoIk9wZXJhIik7CiAgICB2YXIgb3BlcmFWZXJzaW9uID0gKHVzZXJBZ2VudC5pbmRleE9mKCJWZXJzaW9uIikgIT09IC0xKSA/IHVzZXJBZ2VudC5zdWJzdHJpbmcodmVyc2lvbk9mZnNldCArIDgpIDogdXNlckFnZW50LnN1YnN0cmluZyh2ZXJzaW9uT2Zmc2V0ICsgNik7CiAgICBpZiAob3BlcmFWZXJzaW9uKSB7CiAgICAgIHJldHVybiBwYXJzZUZsb2F0KG9wZXJhVmVyc2lvbik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gLTE7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogUmV0dXJuIGEgbWFwIG9mIGl0ZW1zIGluIHRoZSBnaXZlbiBsaXN0IGluZGV4ZWQgYnkKICAgKiBrZXlzIGRldGVybWluZWQgYnkgdGhlIGNsb3N1cmUgcHJvdmlkZWQuCiAgICoKICAgKiBAcGFyYW0gaXRlcmFibGUgQSBsaXN0LWxpa2Ugb2JqZWN0LgogICAqIEBwYXJhbSBjbG9zdXJlIEEgY2xvc3VyZSB0byBkZXRlcm1pbmUgdGhlIGluZGV4IGZvciB0aGUKICAgKiAgICBpdGVtcyBpbiB0aGUgaXRlcmFibGUuCiAgICogQHJldHVybiBBIG1hcCBmcm9tIGluZGV4IHRvIGl0ZW0gZm9yIGVhY2ggaXRlbSBpbiB0aGUgaXRlcmFibGUuCiAgICovCiAgY29ubmVjdC5pbmRleCA9IGZ1bmN0aW9uIChpdGVyYWJsZSwgY2xvc3VyZSkgewogICAgdmFyIG1hcCA9IHt9OwoKICAgIGl0ZXJhYmxlLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgbWFwW2Nsb3N1cmUoaXRlbSldID0gaXRlbTsKICAgIH0pOwoKICAgIHJldHVybiBtYXA7CiAgfTsKCiAgLyoqCiAgICogQ29udmVydHMgdGhlIGdpdmVuIGFycmF5IGludG8gYSBtYXAgYXMgYSBzZXQsCiAgICogd2hlcmUgZWxlbWVudHMgaW4gdGhlIGFycmF5IGFyZSBtYXBwZWQgdG8gMS4KICAgKi8KICBjb25uZWN0LnNldCA9IGZ1bmN0aW9uIChhcnJheUluKSB7CiAgICB2YXIgc2V0TWFwID0ge307CgogICAgYXJyYXlJbi5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsKICAgICAgc2V0TWFwW2tleV0gPSAxOwogICAgfSk7CgogICAgcmV0dXJuIHNldE1hcDsKICB9OwoKICAvKioKICAgKiBSZXR1cm5zIGEgbWFwIGZvciBlYWNoIGtleSBpbiBtYXBCIHdoaWNoCiAgICogaXMgTk9UIGluIG1hcEEuCiAgICovCiAgY29ubmVjdC5yZWxhdGl2ZUNvbXBsZW1lbnQgPSBmdW5jdGlvbiAobWFwQSwgbWFwQikgewogICAgdmFyIGNvbXBNYXAgPSB7fTsKCiAgICBjb25uZWN0LmtleXMobWFwQikuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGlmICghKGtleSBpbiBtYXBBKSkgewogICAgICAgIGNvbXBNYXBba2V5XSA9IG1hcEJba2V5XTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIGNvbXBNYXA7CiAgfTsKCiAgLyoqCiAgICogQXNzZXJ0cyB0aGF0IGEgcHJlbWlzZSBpcyB0cnVlLgogICAqLwogIGNvbm5lY3QuYXNzZXJ0VHJ1ZSA9IGZ1bmN0aW9uIChwcmVtaXNlLCBtZXNzYWdlKSB7CiAgICBpZiAoIXByZW1pc2UpIHsKICAgICAgdGhyb3cgbmV3IGNvbm5lY3QuVmFsdWVFcnJvcihtZXNzYWdlKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBBc3NlcnRzIHRoYXQgYSB2YWx1ZSBpcyBub3QgbnVsbCBvciB1bmRlZmluZWQuCiAgICovCiAgY29ubmVjdC5hc3NlcnROb3ROdWxsID0gZnVuY3Rpb24gKHZhbHVlLCBuYW1lKSB7CiAgICBjb25uZWN0LmFzc2VydFRydWUodmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09IHVuZGVmaW5lZCwKICAgICAgY29ubmVjdC5zcHJpbnRmKCIlcyBtdXN0IGJlIHByb3ZpZGVkIiwgbmFtZSB8fCAnQSB2YWx1ZScpKTsKICAgIHJldHVybiB2YWx1ZTsKICB9OwoKICBjb25uZWN0LmRlZXBjb3B5ID0gZnVuY3Rpb24gKHNyYykgewogICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoc3JjKSk7CiAgfTsKCiAgY29ubmVjdC5kZWVwY29weUNyb3NzT3JpZ2luRXZlbnQgPSBmdW5jdGlvbihldmVudCkgewogICAgY29uc3Qgb2JqID0ge307CiAgICBjb25zdCBsaXN0T2ZBY2NlcHRhYmxlS2V5cyA9IENPUFlBQkxFX0VWRU5UX0ZJRUxEUzsKICAgIGxpc3RPZkFjY2VwdGFibGVLZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgICB0cnkgewogICAgICAgIG9ialtrZXldID0gZXZlbnRba2V5XTsKICAgICAgfQogICAgICBjYXRjaChlKSB7CiAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJkZWVwY29weUNyb3NzT3JpZ2luRXZlbnQgZmFpbGVkIG9uIGtleTogIiwga2V5KS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBjb25uZWN0LmRlZXBjb3B5KG9iaik7CiAgfQoKICAvKioKICAgKiBHZXQgdGhlIGN1cnJlbnQgYmFzZSB1cmwgb2YgdGhlIG9wZW4gcGFnZSwgZS5nLiBpZiB0aGUgcGFnZSBpcwogICAqIGh0dHBzOi8vZXhhbXBsZS5jb206OTQ5NC9vcmFuZ2VzLCB0aGlzIHdpbGwgYmUgImh0dHBzOi8vZXhhbXBsZS5jb206OTQ5NCIuCiAgICovCiAgY29ubmVjdC5nZXRCYXNlVXJsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGxvY2F0aW9uID0gZ2xvYmFsLmxvY2F0aW9uOwogICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMvLyVzOiVzIiwgbG9jYXRpb24ucHJvdG9jb2wsIGxvY2F0aW9uLmhvc3RuYW1lLCBsb2NhdGlvbi5wb3J0KTsKICB9OwoKICBjb25uZWN0LmdldFVybFdpdGhQcm90b2NvbCA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIHByb3RvY29sID0gZ2xvYmFsLmxvY2F0aW9uLnByb3RvY29sOwogICAgaWYgKHVybC5zdWJzdHIoMCwgcHJvdG9jb2wubGVuZ3RoKSAhPT0gcHJvdG9jb2wpIHsKICAgICAgcmV0dXJuIGNvbm5lY3Quc3ByaW50ZigiJXMvLyVzIiwgcHJvdG9jb2wsIHVybCk7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0KCiAgLyoqCiAgICogRGV0ZXJtaW5lIGlmIHRoZSBjdXJyZW50IHdpbmRvdyBpcyBpbiBhbiBpZnJhbWUuCiAgICogQ291cnRlc3k6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzI2MDY5LwogICAqLwogIGNvbm5lY3QuaXNGcmFtZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gd2luZG93LnNlbGYgIT09IHdpbmRvdy50b3A7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH07CgogIGNvbm5lY3QuaGFzT3RoZXJDb25uZWN0ZWRDQ1BzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbm5lY3QubnVtYmVyT2ZDb25uZWN0ZWRDQ1BzID4gMTsKICB9CgogIGNvbm5lY3QuZmV0Y2ggPSBmdW5jdGlvbiAoZW5kcG9pbnQsIG9wdGlvbnMsIG1pbGxpSW50ZXJ2YWwsIG1heFJldHJ5KSB7CiAgICBtYXhSZXRyeSA9IG1heFJldHJ5IHx8IDU7CiAgICBtaWxsaUludGVydmFsID0gbWlsbGlJbnRlcnZhbCB8fCAxMDAwOwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICBmdW5jdGlvbiBmZXRjaERhdGEobWF4UmV0cnkpIHsKICAgICAgICBmZXRjaChlbmRwb2ludCwgb3B0aW9ucykudGhlbihmdW5jdGlvbiAocmVzKSB7CiAgICAgICAgICBpZiAocmVzLnN0YXR1cyA9PT0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5TVUNDRVNTKSB7CiAgICAgICAgICAgIHJlcy5qc29uKCkudGhlbihqc29uID0+IHJlc29sdmUoanNvbikpLmNhdGNoKCgpID0+IHJlc29sdmUoe30pKTsKICAgICAgICAgIH0gZWxzZSBpZiAobWF4UmV0cnkgIT09IDEgJiYgKHJlcy5zdGF0dXMgPj0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5JTlRFUk5BTF9TRVJWRVJfRVJST1IgfHwgcmVzLnN0YXR1cyA9PT0gY29ubmVjdC5IVFRQX1NUQVRVU19DT0RFUy5UT09fTUFOWV9SRVFVRVNUUykpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgZmV0Y2hEYXRhKC0tbWF4UmV0cnkpOwogICAgICAgICAgICB9LCBtaWxsaUludGVydmFsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlamVjdChyZXMpOwogICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgZmV0Y2hEYXRhKG1heFJldHJ5KTsKICAgIH0pOwogIH07CgogIC8qKgogICAqIENhbGxpbmcgYSBmdW5jdGlvbiB3aXRoIGV4cG9uZW50aWFsIGJhY2tvZmYgd2l0aCBmdWxsIGppdHRlciByZXRyeSBzdHJhdGVneQogICAqIEl0IHdpbGwgcmV0cnkgY2FsbGluZyB0aGUgZnVuY3Rpb24gZm9yIG1heGltdW0gbWF4UmV0cnkgdGltZXMgaWYgaXQgZmFpbHMuCiAgICogU3VjY2VzcyBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpZiB0aGUgZnVuY3Rpb24gc3VjY2VlZGVkLgogICAqIEZhaWx1cmUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgb25seSBpZiB0aGUgbGFzdCB0cnkgZmFpbGVkLgogICAqLwogIGNvbm5lY3QuYmFja29mZiA9IGZ1bmN0aW9uIChmdW5jLCBtaWxsaUludGVydmFsLCBtYXhSZXRyeSwgY2FsbGJhY2tzKSB7CiAgICBjb25uZWN0LmFzc2VydFRydWUoY29ubmVjdC5pc0Z1bmN0aW9uKGZ1bmMpLCAiZnVuYyBtdXN0IGJlIGEgRnVuY3Rpb24iKTsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciByYXRpbyA9IDI7CgogICAgZnVuYyh7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3Muc3VjY2VzcykgewogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgaWYgKG1heFJldHJ5ID4gMCkgewogICAgICAgICAgdmFyIGludGVydmFsID0gbWlsbGlJbnRlcnZhbCAqIDIgKiBNYXRoLnJhbmRvbSgpOwogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzZWxmLmJhY2tvZmYoZnVuYywgaW50ZXJ2YWwgKiByYXRpbywgLS1tYXhSZXRyeSwgY2FsbGJhY2tzKTsKICAgICAgICAgIH0sIGludGVydmFsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGNhbGxiYWNrcyAmJiBjYWxsYmFja3MuZmFpbHVyZSkgewogICAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnIsIGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfTsKCiAgY29ubmVjdC5wdWJsaXNoTWV0cmljID0gZnVuY3Rpb24gKG1ldHJpY0RhdGEpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLkNMSUVOVF9NRVRSSUMsCiAgICAgIGRhdGE6IG1ldHJpY0RhdGEKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVN0YXRzID0gZnVuY3Rpb24oc3RhdHMpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLlNPRlRQSE9ORV9TVEFUUywKICAgICAgZGF0YTogc3RhdHMKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaFNvZnRwaG9uZVJlcG9ydCA9IGZ1bmN0aW9uKHJlcG9ydCkgewogICAgY29ubmVjdC5jb3JlLmdldFVwc3RyZWFtKCkuc2VuZFVwc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkJST0FEQ0FTVCwgewogICAgICBldmVudDogY29ubmVjdC5FdmVudFR5cGUuU09GVFBIT05FX1JFUE9SVCwKICAgICAgZGF0YTogcmVwb3J0CiAgICB9KTsKICB9OwoKICBjb25uZWN0LnB1Ymxpc2hDbGlja1N0cmVhbURhdGEgPSBmdW5jdGlvbihyZXBvcnQpIHsKICAgIGNvbm5lY3QuY29yZS5nZXRVcHN0cmVhbSgpLnNlbmRVcHN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIHsKICAgICAgZXZlbnQ6IGNvbm5lY3QuRXZlbnRUeXBlLkNMSUNLX1NUUkVBTV9EQVRBLAogICAgICBkYXRhOiByZXBvcnQKICAgIH0pOwogIH07CgogIGNvbm5lY3QucHVibGlzaENsaWVudFNpZGVMb2dzID0gZnVuY3Rpb24obG9ncykgewogICAgdmFyIGJ1cyA9IGNvbm5lY3QuY29yZS5nZXRFdmVudEJ1cygpOwogICAgYnVzLnRyaWdnZXIoY29ubmVjdC5FdmVudFR5cGUuQ0xJRU5UX1NJREVfTE9HUywgbG9ncyk7CiAgfTsKCiAgY29ubmVjdC5hZGROYW1lc3BhY2VUb0xvZ3MgPSBmdW5jdGlvbihuYW1lc3BhY2UpIHsKICAgIGNvbnN0IG1ldGhvZHMgPSBbJ2xvZycsICdlcnJvcicsICd3YXJuJywgJ2luZm8nLCAnZGVidWcnXTsKCiAgICBtZXRob2RzLmZvckVhY2goKG1ldGhvZCkgPT4gewogICAgICBjb25zdCBjb25zb2xlTWV0aG9kID0gd2luZG93LmNvbnNvbGVbbWV0aG9kXTsKICAgICAgd2luZG93LmNvbnNvbGVbbWV0aG9kXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb25zdCBhcmdzID0gQXJyYXkuZnJvbShhcmd1bWVudHMpOwogICAgICAgIGFyZ3MudW5zaGlmdChgWyR7bmFtZXNwYWNlfV1gKTsKICAgICAgICBjb25zb2xlTWV0aG9kLmFwcGx5KHdpbmRvdy5jb25zb2xlLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CgogIC8qKgogICAqIEEgd3JhcHBlciBhcm91bmQgV2luZG93Lm9wZW4oKSBmb3IgbWFuYWdpbmcgc2luZ2xlIGluc3RhbmNlIHBvcHVwcy4KICAgKi8KICBjb25uZWN0LlBvcHVwTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLm9wZW4gPSBmdW5jdGlvbiAodXJsLCBuYW1lLCBvcHRpb25zKSB7CiAgICB2YXIgdGhlbiA9IHRoaXMuX2dldExhc3RPcGVuZWRUaW1lc3RhbXAobmFtZSk7CiAgICB2YXIgbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgd2luID0gbnVsbDsKICAgIGlmIChub3cgLSB0aGVuID4gT05FX0RBWV9NSUxMSVMpIHsKICAgICAgaWYgKG9wdGlvbnMpIHsKICAgICAgICAvLyBkZWZhdWx0IHZhbHVlcyBhcmUgY2hvc2VuIHRvIHByb3ZpZGUgYSBtaW5pbXVtIGhlaWdodCB3aXRob3V0IHNjcm9sbGluZwogICAgICAgIC8vIGFuZCBhIHVuaWZvcm0gbWFyZ2luIGJhc2VkIG9uIHRoZSBjc3Mgb2YgdGhlIGNjcCBsb2dpbiBwYWdlCiAgICAgICAgdmFyIGhlaWdodCA9IG9wdGlvbnMuaGVpZ2h0IHx8IERFRkFVTFRfUE9QVVBfSEVJR0hUOwogICAgICAgIHZhciB3aWR0aCA9IG9wdGlvbnMud2lkdGggfHwgREVGQVVMVF9QT1BVUF9XSURUSDsKICAgICAgICB2YXIgdG9wID0gb3B0aW9ucy50b3AgfHwgMDsKICAgICAgICB2YXIgbGVmdCA9IG9wdGlvbnMubGVmdCB8fCAwOwogICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKCcnLCBuYW1lLCAid2lkdGg9Iit3aWR0aCsiLCBoZWlnaHQ9IitoZWlnaHQrIiwgdG9wPSIrdG9wKyIsIGxlZnQ9IitsZWZ0KTsKICAgICAgICBpZiAod2luLmxvY2F0aW9uICE9PSB1cmwpIHsKICAgICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKHVybCwgbmFtZSwgIndpZHRoPSIrd2lkdGgrIiwgaGVpZ2h0PSIraGVpZ2h0KyIsIHRvcD0iK3RvcCsiLCBsZWZ0PSIrbGVmdCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKCcnLCBuYW1lKTsKICAgICAgICBpZiAod2luLmxvY2F0aW9uICE9PSB1cmwpIHsKICAgICAgICAgIHdpbiA9IHdpbmRvdy5vcGVuKHVybCwgbmFtZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX3NldExhc3RPcGVuZWRUaW1lc3RhbXAobmFtZSwgbm93KTsKICAgIH0KICAgIHJldHVybiB3aW47CiAgfTsKCiAgY29ubmVjdC5Qb3B1cE1hbmFnZXIucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX2dldExhc3RPcGVuZWRUaW1lc3RhbXAgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdmFyIGtleSA9IHRoaXMuX2dldExvY2FsU3RvcmFnZUtleShuYW1lKTsKICAgIHZhciB2YWx1ZSA9IGdsb2JhbC5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpOwoKICAgIGlmICh2YWx1ZSkgewogICAgICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIDEwKTsKCiAgICB9IGVsc2UgewogICAgICByZXR1cm4gMDsKICAgIH0KICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX3NldExhc3RPcGVuZWRUaW1lc3RhbXAgPSBmdW5jdGlvbiAobmFtZSwgdHMpIHsKICAgIHZhciBrZXkgPSB0aGlzLl9nZXRMb2NhbFN0b3JhZ2VLZXkobmFtZSk7CiAgICBnbG9iYWwubG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCAnJyArIHRzKTsKICB9OwoKICBjb25uZWN0LlBvcHVwTWFuYWdlci5wcm90b3R5cGUuX2dldExvY2FsU3RvcmFnZUtleSA9IGZ1bmN0aW9uIChuYW1lKSB7CiAgICByZXR1cm4gImNvbm5lY3RQb3B1cE1hbmFnZXI6OiIgKyBuYW1lOwogIH07CgogIC8qKgogICAqIEFuIGVudW1lcmF0aW9uIG9mIHRoZSBIVE1MNSBub3RpZmljYXRpb24gcGVybWlzc2lvbiB2YWx1ZXMuCiAgICovCiAgdmFyIE5vdGlmaWNhdGlvblBlcm1pc3Npb24gPSBjb25uZWN0Lm1ha2VFbnVtKFsKICAgICdncmFudGVkJywKICAgICdkZW5pZWQnLAogICAgJ2RlZmF1bHQnCiAgXSk7CgogIC8qKgogICAqIEEgc2ltcGxlIGVuZ2luZSBmb3Igc2hvd2luZyBub3RpZmljYXRpb24gcG9wdXBzLgogICAqLwogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMucXVldWUgPSBbXTsKICAgIHRoaXMucGVybWlzc2lvbiA9IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uREVGQVVMVDsKICB9OwoKICBjb25uZWN0Lk5vdGlmaWNhdGlvbk1hbmFnZXIucHJvdG90eXBlLnJlcXVlc3RQZXJtaXNzaW9uID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgaWYgKCEoIk5vdGlmaWNhdGlvbiIgaW4gZ2xvYmFsKSkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlRoaXMgYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgbm90aWZpY2F0aW9ucy4iKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB0aGlzLnBlcm1pc3Npb24gPSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRDsKCiAgICB9IGVsc2UgaWYgKGdsb2JhbC5Ob3RpZmljYXRpb24ucGVybWlzc2lvbiA9PT0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS53YXJuKCJUaGUgdXNlciBoYXMgcmVxdWVzdGVkIHRvIG5vdCByZWNlaXZlIG5vdGlmaWNhdGlvbnMuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgdGhpcy5wZXJtaXNzaW9uID0gTm90aWZpY2F0aW9uUGVybWlzc2lvbi5ERU5JRUQ7CgogICAgfSBlbHNlIGlmICh0aGlzLnBlcm1pc3Npb24gIT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICBnbG9iYWwuTm90aWZpY2F0aW9uLnJlcXVlc3RQZXJtaXNzaW9uKCkudGhlbihmdW5jdGlvbiAocGVybWlzc2lvbikgewogICAgICAgIHNlbGYucGVybWlzc2lvbiA9IHBlcm1pc3Npb247CiAgICAgICAgaWYgKHBlcm1pc3Npb24gPT09IE5vdGlmaWNhdGlvblBlcm1pc3Npb24uR1JBTlRFRCkgewogICAgICAgICAgc2VsZi5fc2hvd1F1ZXVlZCgpOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5xdWV1ZSA9IFtdOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKCiAgY29ubmVjdC5Ob3RpZmljYXRpb25NYW5hZ2VyLnByb3RvdHlwZS5zaG93ID0gZnVuY3Rpb24gKHRpdGxlLCBvcHRpb25zKSB7CiAgICBpZiAodGhpcy5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkdSQU5URUQpIHsKICAgICAgcmV0dXJuIHRoaXMuX3Nob3dJbXBsKHsgdGl0bGU6IHRpdGxlLCBvcHRpb25zOiBvcHRpb25zIH0pOwoKICAgIH0gZWxzZSBpZiAodGhpcy5wZXJtaXNzaW9uID09PSBOb3RpZmljYXRpb25QZXJtaXNzaW9uLkRFTklFRCkgewogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIlVuYWJsZSB0byBzaG93IG5vdGlmaWNhdGlvbi4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgICAgb3B0aW9uczogb3B0aW9ucwogICAgICAgIH0pOwoKICAgIH0gZWxzZSB7CiAgICAgIHZhciBwYXJhbXMgPSB7IHRpdGxlOiB0aXRsZSwgb3B0aW9uczogb3B0aW9ucyB9OwogICAgICBjb25uZWN0LmdldExvZygpLndhcm4oIkRlZmVycmluZyBub3RpZmljYXRpb24gdW50aWwgdXNlciBkZWNpZGVzIHRvIGFsbG93IG9yIGRlbnkuIikKICAgICAgICAud2l0aE9iamVjdChwYXJhbXMpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHRoaXMucXVldWUucHVzaChwYXJhbXMpOwogICAgfQogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuX3Nob3dRdWV1ZWQgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgbm90aWZpY2F0aW9ucyA9IHRoaXMucXVldWUubWFwKGZ1bmN0aW9uIChwYXJhbXMpIHsKICAgICAgcmV0dXJuIHNlbGYuX3Nob3dJbXBsKHBhcmFtcyk7CiAgICB9KTsKICAgIHRoaXMucXVldWUgPSBbXTsKICAgIHJldHVybiBub3RpZmljYXRpb25zOwogIH07CgogIGNvbm5lY3QuTm90aWZpY2F0aW9uTWFuYWdlci5wcm90b3R5cGUuX3Nob3dJbXBsID0gZnVuY3Rpb24gKHBhcmFtcykgewogICAgdmFyIG5vdGlmaWNhdGlvbiA9IG5ldyBnbG9iYWwuTm90aWZpY2F0aW9uKHBhcmFtcy50aXRsZSwgcGFyYW1zLm9wdGlvbnMpOwogICAgaWYgKHBhcmFtcy5vcHRpb25zLmNsaWNrZWQpIHsKICAgICAgbm90aWZpY2F0aW9uLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcGFyYW1zLm9wdGlvbnMuY2xpY2tlZC5jYWxsKG5vdGlmaWNhdGlvbik7CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gbm90aWZpY2F0aW9uOwogIH07CgogIGNvbm5lY3QuVmFsdWVFcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgIHZhciBmb3JtYXQgPSBhcmdzLnNoaWZ0KCk7CiAgICB2YXIgaW5zdGFuY2UgPSBuZXcgRXJyb3IoY29ubmVjdC52c3ByaW50Zihmb3JtYXQsIGFyZ3MpKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihpbnN0YW5jZSwgY29ubmVjdC5WYWx1ZUVycm9yLnByb3RvdHlwZSk7CiAgICByZXR1cm4gaW5zdGFuY2U7IAogIH07CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUsIEVycm9yLnByb3RvdHlwZSk7CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuVmFsdWVFcnJvciwgRXJyb3IpOwogIGNvbm5lY3QuVmFsdWVFcnJvci5wcm90b3R5cGUubmFtZSA9ICdWYWx1ZUVycm9yJzsKCiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgdmFyIGZvcm1hdCA9IGFyZ3Muc2hpZnQoKTsKICAgIHZhciBpbnN0YW5jZSA9IG5ldyBFcnJvcihjb25uZWN0LnZzcHJpbnRmKGZvcm1hdCwgYXJncykpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGluc3RhbmNlLCBjb25uZWN0Lk5vdEltcGxlbWVudGVkRXJyb3IucHJvdG90eXBlKTsKICAgIHJldHVybiBpbnN0YW5jZTsgCiAgfTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZSwgRXJyb3IucHJvdG90eXBlKTsKICBPYmplY3Quc2V0UHJvdG90eXBlT2YoY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLCBFcnJvcik7CiAgY29ubmVjdC5Ob3RJbXBsZW1lbnRlZEVycm9yLnByb3RvdHlwZS5uYW1lID0gJ05vdEltcGxlbWVudGVkRXJyb3InOwoKICBjb25uZWN0LlN0YXRlRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICB2YXIgZm9ybWF0ID0gYXJncy5zaGlmdCgpOwogICAgdmFyIGluc3RhbmNlID0gbmV3IEVycm9yKGNvbm5lY3QudnNwcmludGYoZm9ybWF0LCBhcmdzKSk7CiAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoaW5zdGFuY2UsIGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUpOwogICAgcmV0dXJuIGluc3RhbmNlOyAKICB9CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUsIEVycm9yLnByb3RvdHlwZSk7CiAgT2JqZWN0LnNldFByb3RvdHlwZU9mKGNvbm5lY3QuU3RhdGVFcnJvciwgRXJyb3IpOwogIGNvbm5lY3QuU3RhdGVFcnJvci5wcm90b3R5cGUubmFtZSA9ICdTdGF0ZUVycm9yJzsKCgoKICBjb25uZWN0LlZvaWNlSWRFcnJvciA9IGZ1bmN0aW9uKHR5cGUsIG1lc3NhZ2UsIGVycil7CiAgICB2YXIgZXJyb3IgPSB7fTsKICAgIGVycm9yLnR5cGUgPSB0eXBlOwogICAgZXJyb3IubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICBlcnJvci5zdGFjayA9IEVycm9yKG1lc3NhZ2UpLnN0YWNrOwogICAgZXJyb3IuZXJyID0gZXJyOwogICAgcmV0dXJuIGVycm9yOwogIH0KCiAgLy8gaW50ZXJuYWwgdXNlIG9ubHkKICBjb25uZWN0LmlzQ0NQID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGNvbmR1aXQgPSBjb25uZWN0LmNvcmUuZ2V0VXBzdHJlYW0oKTsKICAgIHJldHVybiBjb25kdWl0Lm5hbWUgPT09ICdDb25uZWN0U2hhcmVkV29ya2VyQ29uZHVpdCc7CiAgfQoKfSkoKTsKCgovKioqLyB9KSwKCi8qKiovIDczNjoKLyoqKi8gKCgpID0+IHsKCi8qCiAqIENvcHlyaWdodCAyMDE0LTIwMTcgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC4KICoKICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjAKICovCihmdW5jdGlvbiAoKSB7CiAgdmFyIGdsb2JhbCA9IHRoaXMgfHwgZ2xvYmFsVGhpczsKICB2YXIgY29ubmVjdCA9IGdsb2JhbC5jb25uZWN0IHx8IHt9OwogIGdsb2JhbC5jb25uZWN0ID0gY29ubmVjdDsKICBnbG9iYWwubGlseSA9IGNvbm5lY3Q7CgogIGNvbm5lY3Qud29ya2VyID0ge307CgogIHZhciBHRVRfQUdFTlRfVElNRU9VVF9NUyA9IDMwMDAwOwogIHZhciBHRVRfQUdFTlRfUkVDT1ZFUllfVElNRU9VVF9NUyA9IDUwMDA7CiAgdmFyIEdFVF9BR0VOVF9TVUNDRVNTX1RJTUVPVVRfTVMgPSAxMDA7CiAgdmFyIExPR19CVUZGRVJfQ0FQX1NJWkUgPSA0MDA7CgogIHZhciBDSEVDS19BVVRIX1RPS0VOX0lOVEVSVkFMX01TID0gMzAwMDAwOyAvLyA1IG1pbnV0ZXMKICB2YXIgUkVGUkVTSF9BVVRIX1RPS0VOX0lOVEVSVkFMX01TID0gMTAwMDA7IC8vIDEwIHNlY29uZHMKICB2YXIgUkVGUkVTSF9BVVRIX1RPS0VOX01BWF9UUlkgPSA0OwoKICB2YXIgR0VUX0FHRU5UX0NPTkZJR1VSQVRJT05fSU5URVJWQUxfTVMgPSAzMDAwMDsKCiAgLyoqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogIHZhciBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy50b3BpY01hc3Rlck1hcCA9IHt9OwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLmdldE1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYykgewogICAgY29ubmVjdC5hc3NlcnROb3ROdWxsKHRvcGljLCAndG9waWMnKTsKICAgIHJldHVybiB0aGlzLnRvcGljTWFzdGVyTWFwW3RvcGljXSB8fCBudWxsOwogIH07CgogIE1hc3RlclRvcGljQ29vcmRpbmF0b3IucHJvdG90eXBlLnNldE1hc3RlciA9IGZ1bmN0aW9uICh0b3BpYywgaWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbCh0b3BpYywgJ3RvcGljJyk7CiAgICBjb25uZWN0LmFzc2VydE5vdE51bGwoaWQsICdpZCcpOwogICAgdGhpcy50b3BpY01hc3Rlck1hcFt0b3BpY10gPSBpZDsKICB9OwoKICBNYXN0ZXJUb3BpY0Nvb3JkaW5hdG9yLnByb3RvdHlwZS5yZW1vdmVNYXN0ZXIgPSBmdW5jdGlvbiAoaWQpIHsKICAgIGNvbm5lY3QuYXNzZXJ0Tm90TnVsbChpZCwgJ2lkJyk7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgY29ubmVjdC5lbnRyaWVzKHRoaXMudG9waWNNYXN0ZXJNYXApLmZpbHRlcihmdW5jdGlvbiAoZW50cnkpIHsKICAgICAgcmV0dXJuIGVudHJ5LnZhbHVlID09PSBpZDsKICAgIH0pLmZvckVhY2goZnVuY3Rpb24gKGVudHJ5KSB7CiAgICAgIGRlbGV0ZSBzZWxmLnRvcGljTWFzdGVyTWFwW2VudHJ5LmtleV07CiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBjbGFzcyBXb3JrZXJDbGllbnQgZXh0ZW5kcyBDbGllbnRCYXNlCiAgICovCiAgdmFyIFdvcmtlckNsaWVudCA9IGZ1bmN0aW9uIChjb25kdWl0KSB7CiAgICBjb25uZWN0LkNsaWVudEJhc2UuY2FsbCh0aGlzKTsKICAgIHRoaXMuY29uZHVpdCA9IGNvbmR1aXQ7CiAgfTsKICBXb3JrZXJDbGllbnQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShjb25uZWN0LkNsaWVudEJhc2UucHJvdG90eXBlKTsKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gV29ya2VyQ2xpZW50OwoKICBXb3JrZXJDbGllbnQucHJvdG90eXBlLl9jYWxsSW1wbCA9IGZ1bmN0aW9uIChtZXRob2QsIHBhcmFtcywgY2FsbGJhY2tzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcmVxdWVzdF9zdGFydCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgaWYoY29ubmVjdC5jb250YWluc1ZhbHVlKGNvbm5lY3QuQWdlbnRBcHBDbGllbnRNZXRob2RzLCBtZXRob2QpKSB7CiAgICAgIGNvbm5lY3QuY29yZS5nZXRBZ2VudEFwcENsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yKTsKICAgICAgICB9CiAgICAgIH0pCiAgICB9IGVsc2UgaWYoY29ubmVjdC5jb250YWluc1ZhbHVlKGNvbm5lY3QuVGFza1RlbXBsYXRlc0NsaWVudE1ldGhvZHMsIG1ldGhvZCkpIHsKICAgICAgY29ubmVjdC5jb3JlLmdldFRhc2tUZW1wbGF0ZXNDbGllbnQoKS5fY2FsbEltcGwobWV0aG9kLCBwYXJhbXMsIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQpOwogICAgICAgICAgY2FsbGJhY2tzLnN1Y2Nlc3MoZGF0YSk7CiAgICAgICAgfSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIHNlbGYuX3JlY29yZEFQSUxhdGVuY3kobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnJvcik7CiAgICAgICAgICBjYWxsYmFja3MuZmFpbHVyZShlcnJvcik7CiAgICAgICAgfQogICAgICB9KQogICAgfSBlbHNlIHsKICAgICAgY29ubmVjdC5jb3JlLmdldENsaWVudCgpLl9jYWxsSW1wbChtZXRob2QsIHBhcmFtcywgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3Muc3VjY2VzcyhkYXRhKTsKICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnJvciwgZGF0YSkgewogICAgICAgICAgc2VsZi5fcmVjb3JkQVBJTGF0ZW5jeShtZXRob2QsIHJlcXVlc3Rfc3RhcnQsIGVycm9yKTsKICAgICAgICAgIGNhbGxiYWNrcy5mYWlsdXJlKGVycm9yLCBkYXRhKTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLl9yZWNvcmRBUElMYXRlbmN5KG1ldGhvZCwgcmVxdWVzdF9zdGFydCk7CiAgICAgICAgICBjYWxsYmFja3MuYXV0aEZhaWx1cmUoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgY2FsbGJhY2tzLmFjY2Vzc0RlbmllZCAmJiBjYWxsYmFja3MuYWNjZXNzRGVuaWVkKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIAogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3JlY29yZEFQSUxhdGVuY3kgPSBmdW5jdGlvbiAobWV0aG9kLCByZXF1ZXN0X3N0YXJ0LCBlcnIpIHsKICAgIHZhciByZXF1ZXN0X2VuZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgdmFyIHJlcXVlc3RfdGltZSA9IHJlcXVlc3RfZW5kIC0gcmVxdWVzdF9zdGFydDsKICAgIHRoaXMuX3NlbmRBUElNZXRyaWNzKG1ldGhvZCwgcmVxdWVzdF90aW1lLCBlcnIpOwogIH07CgogIFdvcmtlckNsaWVudC5wcm90b3R5cGUuX3NlbmRBUElNZXRyaWNzID0gZnVuY3Rpb24gKG1ldGhvZCwgdGltZSwgZXJyKSB7CiAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVBJX01FVFJJQywgewogICAgICBuYW1lOiBtZXRob2QsCiAgICAgIHRpbWU6IHRpbWUsCiAgICAgIGRpbWVuc2lvbnM6IFsKICAgICAgICB7CiAgICAgICAgICBuYW1lOiAiQ2F0ZWdvcnkiLAogICAgICAgICAgdmFsdWU6ICJBUEkiCiAgICAgICAgfQogICAgICBdLAogICAgICBlcnJvcjogZXJyCiAgICB9KTsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogVGhlIG9iamVjdCByZXNwb25zaWJsZSBmb3IgcG9sbGluZyBhbmQgcGFzc2luZyBkYXRhIGRvd25zdHJlYW0gdG8gYWxsCiAgICogY29uc3VtZXIgcG9ydHMuCiAgICovCiAgdmFyIENsaWVudEVuZ2luZSA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKCiAgICB0aGlzLm11bHRpcGxleGVyID0gbmV3IGNvbm5lY3QuU3RyZWFtTXVsdGlwbGV4ZXIoKTsKICAgIHRoaXMuY29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoIkFtYXpvbkNvbm5lY3RTaGFyZWRXb3JrZXIiLCBudWxsLCB0aGlzLm11bHRpcGxleGVyKTsKICAgIHRoaXMuY2xpZW50ID0gbmV3IFdvcmtlckNsaWVudCh0aGlzLmNvbmR1aXQpOwogICAgdGhpcy50aW1lb3V0ID0gbnVsbDsKICAgIHRoaXMuYWdlbnQgPSBudWxsOwogICAgdGhpcy5uZXh0VG9rZW4gPSBudWxsOwogICAgdGhpcy5pbml0RGF0YSA9IHt9OwogICAgdGhpcy5wb3J0Q29uZHVpdE1hcCA9IHt9OwogICAgdGhpcy5zdHJlYW1NYXBCeVRhYklkID0ge307CiAgICB0aGlzLm1hc3RlckNvb3JkID0gbmV3IE1hc3RlclRvcGljQ29vcmRpbmF0b3IoKTsKICAgIHRoaXMubG9nc0J1ZmZlciA9IFtdOwogICAgdGhpcy5zdXBwcmVzcyA9IGZhbHNlOwogICAgdGhpcy5mb3JjZU9mZmxpbmUgPSBmYWxzZTsKICAgIHRoaXMubG9uZ1BvbGxpbmdPcHRpb25zID0gewogICAgICBhbGxvd0xvbmdQb2xsaW5nU2hhZG93TW9kZTogZmFsc2UsIAogICAgICBhbGxvd0xvbmdQb2xsaW5nV2Vic29ja2V0T25seU1vZGU6IGZhbHNlLAogICAgfQoKICAgIHZhciB3ZWJTb2NrZXRNYW5hZ2VyID0gbnVsbDsKCiAgICBjb25uZWN0LnJvb3RMb2dnZXIgPSBuZXcgY29ubmVjdC5Eb3duc3RyZWFtQ29uZHVpdExvZ2dlcih0aGlzLmNvbmR1aXQpOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU0VORF9MT0dTLCBmdW5jdGlvbiAobG9nc1RvVXBsb2FkKSB7CiAgICAgIC8vIEFkZCBzb2Z0cGhvbmUgbG9ncyBkb3duc3RyZWFtCiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkucHVzaExvZ3NEb3duc3RyZWFtKGxvZ3NUb1VwbG9hZCk7CgogICAgICBzZWxmLmxvZ3NCdWZmZXIgPSBzZWxmLmxvZ3NCdWZmZXIuY29uY2F0KGxvZ3NUb1VwbG9hZCk7CiAgICAgIC8vb25seSBjYWxsIEFQSSB0byBzZW5kIGxvZ3MgaWYgYnVmZmVyIHJlYWNoZWQgY2FwCiAgICAgIGlmIChzZWxmLmxvZ3NCdWZmZXIubGVuZ3RoID4gTE9HX0JVRkZFUl9DQVBfU0laRSkgewogICAgICAgIHNlbGYuaGFuZGxlU2VuZExvZ3NSZXF1ZXN0KHNlbGYubG9nc0J1ZmZlcik7CiAgICAgIH0KICAgIH0pOwoKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLlNVUFBSRVNTLCBmdW5jdGlvbiAoZGF0YSl7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZGVidWcoIltEaXNhc3RlciBSZWNvdmVyeV0gU2V0dGluZyBTdXBwcmVzcyB0byAlcyIsIGRhdGEuc3VwcHJlc3MpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHNlbGYuc3VwcHJlc3MgPSBkYXRhLnN1cHByZXNzIHx8IGZhbHNlOwogICAgICAvL3NpZ25hbCBvdGhlciB3aW5kb3dzIHRoYXQgYSBmYWlsb3ZlciBoYXBwZW5lZAogICAgICBpZiAoc2VsZi5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIoY29ubmVjdC5NYXN0ZXJUb3BpY3MuU09GVFBIT05FKSkgewogICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRkFJTE9WRVIsIHsKICAgICAgICAgIGlzUHJpbWFyeTogIXNlbGYuc3VwcHJlc3MKICAgICAgICB9KTsgICAgICAKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkRpc2FzdGVyUmVjb3ZlcnlFdmVudHMuRk9SQ0VfT0ZGTElORSwgZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5kZWJ1ZygiW0Rpc2FzdGVyIFJlY292ZXJ5XSBTZXR0aW5nIEZPUkNFX09GRkxJTkUgdG8gJXMiLCBkYXRhLm9mZmxpbmUpCiAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgIHNlbGYuZm9yY2VPZmZsaW5lID0gZGF0YS5vZmZsaW5lIHx8IGZhbHNlOwogICAgfSk7CgogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DT05GSUdVUkUsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIGlmIChkYXRhLmF1dGhUb2tlbiAmJiBkYXRhLmF1dGhUb2tlbiAhPT0gc2VsZi5pbml0RGF0YS5hdXRoVG9rZW4pIHsKICAgICAgICBzZWxmLmluaXREYXRhID0gZGF0YTsKICAgICAgICBjb25uZWN0LmNvcmUuaW5pdChkYXRhKTsKICAgICAgICBpZiAoZGF0YS5sb25nUG9sbGluZ09wdGlvbnMpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGUgPT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIHNlbGYubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdTaGFkb3dNb2RlID0gZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1NoYWRvd01vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGRhdGEubG9uZ1BvbGxpbmdPcHRpb25zLmFsbG93TG9uZ1BvbGxpbmdXZWJzb2NrZXRPbmx5TW9kZSA9PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgc2VsZi5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlID0gZGF0YS5sb25nUG9sbGluZ09wdGlvbnMuYWxsb3dMb25nUG9sbGluZ1dlYnNvY2tldE9ubHlNb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBpbml0IG9ubHkgb25jZS4KICAgICAgICBpZiAoIXdlYlNvY2tldE1hbmFnZXIpIHsKCiAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIkNyZWF0aW5nIGEgbmV3IFdlYnNvY2tldCBjb25uZWN0aW9uIGZvciBDQ1AiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICAgICAgICBjb25uZWN0LldlYlNvY2tldE1hbmFnZXIuc2V0R2xvYmFsQ29uZmlnKHsKICAgICAgICAgICAgbG9nZ2VyQ29uZmlnOiB7IGxvZ2dlcjogY29ubmVjdC5nZXRMb2coKSB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyID0gY29ubmVjdC5XZWJTb2NrZXRNYW5hZ2VyLmNyZWF0ZSgpOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25Jbml0RmFpbHVyZShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkUpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25PcGVuKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9PUEVOLCByZXNwb25zZSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkNsb3NlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQ09OTkVDVElPTl9DTE9TRSwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vbkNvbm5lY3Rpb25HYWluKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuV0VCU09DS0VUX0NPTk5FQ1RJT05fR0FJTkVEKTsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fR0FJTik7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLm9uQ29ubmVjdGlvbkxvc3QoZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkFnZW50RXZlbnRzLldFQlNPQ0tFVF9DT05ORUNUSU9OX0xPU1QsIHJlc3BvbnNlKTsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLkNPTk5FQ1RJT05fTE9TVCwgcmVzcG9uc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5vblN1YnNjcmlwdGlvblVwZGF0ZShmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuV2ViU29ja2V0RXZlbnRzLlNVQlNDUklQVElPTl9VUERBVEUsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25TdWJzY3JpcHRpb25GYWlsdXJlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSVBUSU9OX0ZBSUxVUkUsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIub25BbGxNZXNzYWdlKGZ1bmN0aW9uIChyZXNwb25zZSkgewogICAgICAgICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuQUxMX01FU1NBR0UsIHJlc3BvbnNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNlbGYuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU0VORCwgZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgd2ViU29ja2V0TWFuYWdlci5zZW5kTWVzc2FnZShtZXNzYWdlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHNlbGYuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5XZWJTb2NrZXRFdmVudHMuU1VCU0NSSUJFLCBmdW5jdGlvbiAodG9waWNzKSB7CiAgICAgICAgICAgIHdlYlNvY2tldE1hbmFnZXIuc3Vic2NyaWJlVG9waWNzKHRvcGljcyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB3ZWJTb2NrZXRNYW5hZ2VyLmluaXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmdldFdlYlNvY2tldFVybCkpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgIXJlc3BvbnNlLndlYlNvY2tldENvbm5lY3Rpb25GYWlsZWQpIHsKICAgICAgICAgICAgICAgIC8vIFN0YXJ0IHBvbGxpbmcgZm9yIGFnZW50IGRhdGEuCiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGFnZW50IHBvbGxpbmciKQogICAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50KCk7CiAgCiAgICAgICAgICAgICAgICBjb25uZWN0LmdldExvZygpLmluZm8oIktpY2tpbmcgb2ZmIGNvbmZpZyBwb2xsaW5nIikKICAgICAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24oeyByZXBlYXRGb3JldmVyOiB0cnVlIH0pOwogIAogICAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJLaWNraW5nIG9mZiBhdXRoIHRva2VuIHBvbGxpbmciKQogICAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgICAgIGdsb2JhbC5zZXRJbnRlcnZhbChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuY2hlY2tBdXRoVG9rZW4pLCBDSEVDS19BVVRIX1RPS0VOX0lOVEVSVkFMX01TKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0LndlYlNvY2tldEluaXRGYWlsZWQpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgZXZlbnQgPSBjb25uZWN0LldlYlNvY2tldEV2ZW50cy5JTklUX0ZBSUxVUkU7CiAgICAgICAgICAgICAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShldmVudCk7CiAgICAgICAgICAgICAgICAgIGNvbm5lY3Qud2ViU29ja2V0SW5pdEZhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiV2ViU29ja2V0IGZhaWxlZCB0byBpbml0aWFsaXplIikKICAgICAgICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGUpCiAgICAgICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiTm90IEluaXRpYWxpemluZyBhIG5ldyBXZWJzb2NrZXRNYW5hZ2VyIGluc3RhbmNlLCBzaW5jZSBvbmUgYWxyZWFkeSBleGlzdHMiKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5URVJNSU5BVEUsIGZ1bmN0aW9uICgpIHsKICAgICAgLy91cGxvYWQgcGVuZGluZyBsb2dzIGJlZm9yZSB0ZXJtaW5hdGluZy4KICAgICAgc2VsZi5oYW5kbGVTZW5kTG9nc1JlcXVlc3Qoc2VsZi5sb2dzQnVmZmVyKTsKICAgICAgY29ubmVjdC5jb3JlLnRlcm1pbmF0ZSgpOwogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuVEVSTUlOQVRFRCk7CiAgICB9KTsKICAgIHRoaXMuY29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuU1lOQ0hST05JWkUsIGZ1bmN0aW9uICgpIHsKICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFKTsKICAgIH0pOwogICAgdGhpcy5jb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5CUk9BRENBU1QsIGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShkYXRhLmV2ZW50LCBkYXRhLmRhdGEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDYWxsZWQgd2hlbiBhIGNvbnN1bWVyIHBvcnQgY29ubmVjdHMgdG8gdGhpcyBTaGFyZWRXb3JrZXIuCiAgICAgKiBMZXQncyBhZGQgdGhlbSB0byBvdXIgbXVsdGlwbGV4ZXIuCiAgICAgKi8KICAgIGdsb2JhbC5vbmNvbm5lY3QgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgdmFyIHBvcnQgPSBldmVudC5wb3J0c1swXTsKICAgICAgdmFyIHN0cmVhbSA9IG5ldyBjb25uZWN0LlBvcnRTdHJlYW0ocG9ydCk7CiAgICAgIHNlbGYubXVsdGlwbGV4ZXIuYWRkU3RyZWFtKHN0cmVhbSk7CiAgICAgIHBvcnQuc3RhcnQoKTsKCiAgICAgIHZhciBwb3J0Q29uZHVpdCA9IG5ldyBjb25uZWN0LkNvbmR1aXQoc3RyZWFtLmdldElkKCksIG51bGwsIHN0cmVhbSk7CiAgICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFDS05PV0xFREdFLCB7IGlkOiBzdHJlYW0uZ2V0SWQoKSB9KTsKCiAgICAgIHNlbGYucG9ydENvbmR1aXRNYXBbc3RyZWFtLmdldElkKCldID0gcG9ydENvbmR1aXQ7CiAgICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGggfSk7CgogICAgICBpZiAoc2VsZi5hZ2VudCAhPT0gbnVsbCkgewogICAgICAgIHNlbGYudXBkYXRlQWdlbnQoKTsKICAgICAgfQoKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLkFQSV9SRVFVRVNULAogICAgICAgIGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBUElSZXF1ZXN0LCBwb3J0Q29uZHVpdCkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFUVVFU1QsCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZU1hc3RlclJlcXVlc3QsIHBvcnRDb25kdWl0LCBzdHJlYW0uZ2V0SWQoKSkpOwogICAgICBwb3J0Q29uZHVpdC5vbkRvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuUkVMT0FEX0FHRU5UX0NPTkZJR1VSQVRJT04sCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24pKTsKICAgICAgcG9ydENvbmR1aXQub25Eb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlRBQl9JRCwKICAgICAgICBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlVGFiSWRFdmVudCwgc3RyZWFtKSk7CiAgICAgIHBvcnRDb25kdWl0Lm9uRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5DTE9TRSwgCiAgICAgICAgY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUNsb3NlRXZlbnQsIHN0cmVhbSkpOwogICAgfTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfU05BUFNIT1QsIHsKICAgICAgbmV4dFRva2VuOiBzZWxmLm5leHRUb2tlbiwKICAgICAgdGltZW91dDogR0VUX0FHRU5UX1RJTUVPVVRfTVMKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2VsZi5hZ2VudCA9IHNlbGYuYWdlbnQgfHwge307CiAgICAgICAgICAgIHNlbGYuYWdlbnQuc25hcHNob3QgPSBkYXRhLnNuYXBzaG90OwogICAgICAgICAgICBzZWxmLmFnZW50LnNuYXBzaG90LmxvY2FsVGltZXN0YW1wID0gY29ubmVjdC5ub3coKTsKICAgICAgICAgICAgc2VsZi5hZ2VudC5zbmFwc2hvdC5za2V3ID0gc2VsZi5hZ2VudC5zbmFwc2hvdC5zbmFwc2hvdFRpbWVzdGFtcCAtIHNlbGYuYWdlbnQuc25hcHNob3QubG9jYWxUaW1lc3RhbXA7CiAgICAgICAgICAgIHNlbGYubmV4dFRva2VuID0gZGF0YS5uZXh0VG9rZW47CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIkdFVF9BR0VOVF9TTkFQU0hPVCBzdWNjZWVkZWQuIikKICAgICAgICAgICAgICAud2l0aE9iamVjdChkYXRhKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkxvbmcgcG9sbCBmYWlsZWQgdG8gdXBkYXRlIGFnZW50LiIpCiAgICAgICAgICAgICAgLndpdGhPYmplY3QoZGF0YSkKICAgICAgICAgICAgICAud2l0aEV4Y2VwdGlvbihlKQogICAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudCksIEdFVF9BR0VOVF9TVUNDRVNTX1RJTUVPVVRfTVMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGdldCBhZ2VudCBkYXRhLiIpCiAgICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBnbG9iYWwuc2V0VGltZW91dChjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYucG9sbEZvckFnZW50KSwgR0VUX0FHRU5UX1JFQ09WRVJZX1RJTUVPVVRfTVMpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYXV0aEZhaWx1cmU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKCiAgICAgIH0pOwoKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAocGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfQ09ORklHVVJBVElPTiwge30sIHsKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICB2YXIgY29uZmlndXJhdGlvbiA9IGRhdGEuY29uZmlndXJhdGlvbjsKICAgICAgICBzZWxmLnBvbGxGb3JBZ2VudFBlcm1pc3Npb25zKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvckFnZW50U3RhdGVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIHNlbGYucG9sbEZvclJvdXRpbmdQcm9maWxlUXVldWVzKGNvbmZpZ3VyYXRpb24pOwogICAgICAgIGlmIChwYXJhbXMucmVwZWF0Rm9yZXZlcikgewogICAgICAgICAgZ2xvYmFsLnNldFRpbWVvdXQoY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLnBvbGxGb3JBZ2VudENvbmZpZ3VyYXRpb24sIHBhcmFtcyksCiAgICAgICAgICAgIEdFVF9BR0VOVF9DT05GSUdVUkFUSU9OX0lOVEVSVkFMX01TKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IGNvbmZpZ3VyYXRpb24gZGF0YS4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKHBhcmFtcy5yZXBlYXRGb3JldmVyKSB7CiAgICAgICAgICAgIGdsb2JhbC5zZXRUaW1lb3V0KGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5wb2xsRm9yQWdlbnRDb25maWd1cmF0aW9uKSwKICAgICAgICAgICAgICBHRVRfQUdFTlRfQ09ORklHVVJBVElPTl9JTlRFUlZBTF9NUywgcGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGF1dGhGYWlsdXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgb25BdXRoRmFpbCgpOwogICAgICB9LAogICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICB9KTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnBvbGxGb3JBZ2VudFN0YXRlcyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfU1RBVEVTLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwoKICAgIH0sIHsKICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgaWYgKGRhdGEubmV4dFRva2VuKSB7CiAgICAgICAgICAgIHNlbGYucG9sbEZvckFnZW50U3RhdGVzKGNvbmZpZ3VyYXRpb24sIHsKICAgICAgICAgICAgICBzdGF0ZXM6IChwYXJhbXMuc3RhdGVzIHx8IFtdKS5jb25jYXQoZGF0YS5zdGF0ZXMpLAogICAgICAgICAgICAgIG5leHRUb2tlbjogZGF0YS5uZXh0VG9rZW4sCiAgICAgICAgICAgICAgbWF4UmVzdWx0czogcGFyYW1zLm1heFJlc3VsdHMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uZmlndXJhdGlvbi5hZ2VudFN0YXRlcyA9IChwYXJhbXMuc3RhdGVzIHx8IFtdKS5jb25jYXQoZGF0YS5zdGF0ZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCBhZ2VudCBzdGF0ZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyA9IGZ1bmN0aW9uIChjb25maWd1cmF0aW9uLCBwYXJhbXNJbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIHBhcmFtcyA9IHBhcmFtc0luIHx8IHt9OwogICAgcGFyYW1zLm1heFJlc3VsdHMgPSBwYXJhbXMubWF4UmVzdWx0cyB8fCBjb25uZWN0LkRFRkFVTFRfQkFUQ0hfU0laRTsKCiAgICB0aGlzLmNsaWVudC5jYWxsKGNvbm5lY3QuQ2xpZW50TWV0aG9kcy5HRVRfQUdFTlRfUEVSTUlTU0lPTlMsIHsKICAgICAgbmV4dFRva2VuOiBwYXJhbXMubmV4dFRva2VuIHx8IG51bGwsCiAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCgogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yQWdlbnRQZXJtaXNzaW9ucyhjb25maWd1cmF0aW9uLCB7CiAgICAgICAgICAgICAgcGVybWlzc2lvbnM6IChwYXJhbXMucGVybWlzc2lvbnMgfHwgW10pLmNvbmNhdChkYXRhLnBlcm1pc3Npb25zKSwKICAgICAgICAgICAgICBuZXh0VG9rZW46IGRhdGEubmV4dFRva2VuLAogICAgICAgICAgICAgIG1heFJlc3VsdHM6IHBhcmFtcy5tYXhSZXN1bHRzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGVybWlzc2lvbnMgPSAocGFyYW1zLnBlcm1pc3Npb25zIHx8IFtdKS5jb25jYXQoZGF0YS5wZXJtaXNzaW9ucyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGFnZW50IHBlcm1pc3Npb25zIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUucG9sbEZvckRpYWxhYmxlQ291bnRyeUNvZGVzID0gZnVuY3Rpb24gKGNvbmZpZ3VyYXRpb24sIHBhcmFtc0luKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgcGFyYW1zID0gcGFyYW1zSW4gfHwge307CiAgICBwYXJhbXMubWF4UmVzdWx0cyA9IHBhcmFtcy5tYXhSZXN1bHRzIHx8IGNvbm5lY3QuREVGQVVMVF9CQVRDSF9TSVpFOwoKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkdFVF9ESUFMQUJMRV9DT1VOVFJZX0NPREVTLCB7CiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yRGlhbGFibGVDb3VudHJ5Q29kZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIGNvdW50cnlDb2RlczogKHBhcmFtcy5jb3VudHJ5Q29kZXMgfHwgW10pLmNvbmNhdChkYXRhLmNvdW50cnlDb2RlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLmRpYWxhYmxlQ291bnRyaWVzID0gKHBhcmFtcy5jb3VudHJ5Q29kZXMgfHwgW10pLmNvbmNhdChkYXRhLmNvdW50cnlDb2Rlcyk7CiAgICAgICAgICAgIHNlbGYudXBkYXRlQWdlbnRDb25maWd1cmF0aW9uKGNvbmZpZ3VyYXRpb24pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGRpYWxhYmxlIGNvdW50cnkgY29kZXMgbGlzdC4iKQogICAgICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKQogICAgICAgICAgICAud2l0aE9iamVjdCh7CiAgICAgICAgICAgICAgZXJyOiBlcnIsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGF1dGhGYWlsdXJlOiBjb25uZWN0LmhpdGNoKHNlbGYsIHNlbGYuaGFuZGxlQXV0aEZhaWwpLAogICAgICAgIGFjY2Vzc0RlbmllZDogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUFjY2Vzc0RlbmllZCkKICAgICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMgPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbiwgcGFyYW1zSW4pIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHZhciBwYXJhbXMgPSBwYXJhbXNJbiB8fCB7fTsKICAgIHBhcmFtcy5tYXhSZXN1bHRzID0gcGFyYW1zLm1heFJlc3VsdHMgfHwgY29ubmVjdC5ERUZBVUxUX0JBVENIX1NJWkU7CgogICAgdGhpcy5jbGllbnQuY2FsbChjb25uZWN0LkNsaWVudE1ldGhvZHMuR0VUX1JPVVRJTkdfUFJPRklMRV9RVUVVRVMsIHsKICAgICAgcm91dGluZ1Byb2ZpbGVBUk46IGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVBUk4sCiAgICAgIG5leHRUb2tlbjogcGFyYW1zLm5leHRUb2tlbiB8fCBudWxsLAogICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgfSwgewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICBpZiAoZGF0YS5uZXh0VG9rZW4pIHsKICAgICAgICAgICAgc2VsZi5wb2xsRm9yUm91dGluZ1Byb2ZpbGVRdWV1ZXMoY29uZmlndXJhdGlvbiwgewogICAgICAgICAgICAgIGNvdW50cnlDb2RlczogKHBhcmFtcy5xdWV1ZXMgfHwgW10pLmNvbmNhdChkYXRhLnF1ZXVlcyksCiAgICAgICAgICAgICAgbmV4dFRva2VuOiBkYXRhLm5leHRUb2tlbiwKICAgICAgICAgICAgICBtYXhSZXN1bHRzOiBwYXJhbXMubWF4UmVzdWx0cwogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnF1ZXVlcyA9IChwYXJhbXMucXVldWVzIHx8IFtdKS5jb25jYXQoZGF0YS5xdWV1ZXMpOwogICAgICAgICAgICBzZWxmLnVwZGF0ZUFnZW50Q29uZmlndXJhdGlvbihjb25maWd1cmF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uIChlcnIsIGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIkZhaWxlZCB0byBmZXRjaCByb3V0aW5nIHByb2ZpbGUgcXVldWVzIGxpc3QuIikKICAgICAgICAgICAgLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCkKICAgICAgICAgICAgLndpdGhPYmplY3QoewogICAgICAgICAgICAgIGVycjogZXJyLAogICAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKSwKICAgICAgICBhY2Nlc3NEZW5pZWQ6IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpCiAgICAgIH0pOwogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQVBJUmVxdWVzdCA9IGZ1bmN0aW9uIChwb3J0Q29uZHVpdCwgcmVxdWVzdCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgIHRoaXMuY2xpZW50LmNhbGwocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGFyYW1zLCB7CiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFLCByZXF1ZXN0LCBkYXRhKTsKICAgICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICB9LAogICAgICBmYWlsdXJlOiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7CiAgICAgICAgdmFyIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuQVBJX1JFU1BPTlNFLCByZXF1ZXN0LCBkYXRhLCBKU09OLnN0cmluZ2lmeShlcnIpKTsKICAgICAgICBwb3J0Q29uZHVpdC5zZW5kRG93bnN0cmVhbShyZXNwb25zZS5ldmVudCwgcmVzcG9uc2UpOwogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIiclcycgQVBJIHJlcXVlc3QgZmFpbGVkIiwgcmVxdWVzdC5tZXRob2QpCiAgICAgICAgICAud2l0aE9iamVjdCh7IHJlcXVlc3Q6IHNlbGYuZmlsdGVyQXV0aFRva2VuKHJlcXVlc3QpLCByZXNwb25zZTogcmVzcG9uc2UgfSkKICAgICAgICAgIC53aXRoRXhjZXB0aW9uKGVycikKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsLCB7YXV0aG9yaXplOiB0cnVlfSkKICAgIH0pOwogIH07CgogIC8qKgogICAqIEhhbmRsZSBpbmNvbWluZyBtYXN0ZXIgcXVlcnkgb3IgbW9kaWZpY2F0aW9uIHJlcXVlc3RzIGZyb20gY29ubmVjdGVkIHRhYiBwb3J0cy4KICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZU1hc3RlclJlcXVlc3QgPSBmdW5jdGlvbiAocG9ydENvbmR1aXQsIHBvcnRJZCwgcmVxdWVzdCkgewogICAgdmFyIG11bHRpcGxleGVyQ29uZHVpdCA9IHRoaXMuY29uZHVpdDsKICAgIHZhciByZXNwb25zZSA9IG51bGw7CgogICAgc3dpdGNoIChyZXF1ZXN0Lm1ldGhvZCkgewogICAgICBjYXNlIGNvbm5lY3QuTWFzdGVyTWV0aG9kcy5CRUNPTUVfTUFTVEVSOgogICAgICAgIHZhciBtYXN0ZXJJZCA9IHRoaXMubWFzdGVyQ29vcmQuZ2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljKTsKICAgICAgICB2YXIgdGFrZU92ZXIgPSBCb29sZWFuKG1hc3RlcklkKSAmJiBtYXN0ZXJJZCAhPT0gcG9ydElkOwogICAgICAgIHRoaXMubWFzdGVyQ29vcmQuc2V0TWFzdGVyKHJlcXVlc3QucGFyYW1zLnRvcGljLCBwb3J0SWQpOwogICAgICAgIHJlc3BvbnNlID0gY29ubmVjdC5FdmVudEZhY3RvcnkuY3JlYXRlUmVzcG9uc2UoY29ubmVjdC5FdmVudFR5cGUuTUFTVEVSX1JFU1BPTlNFLCByZXF1ZXN0LCB7CiAgICAgICAgICBtYXN0ZXJJZDogcG9ydElkLAogICAgICAgICAgdGFrZU92ZXI6IHRha2VPdmVyLAogICAgICAgICAgdG9waWM6IHJlcXVlc3QucGFyYW1zLnRvcGljCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRha2VPdmVyKSB7CiAgICAgICAgICBtdWx0aXBsZXhlckNvbmR1aXQuc2VuZERvd25zdHJlYW0ocmVzcG9uc2UuZXZlbnQsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIGNvbm5lY3QuTWFzdGVyTWV0aG9kcy5DSEVDS19NQVNURVI6CiAgICAgICAgdmFyIG1hc3RlcklkID0gdGhpcy5tYXN0ZXJDb29yZC5nZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMpOwogICAgICAgIGlmICghbWFzdGVySWQgJiYgIXJlcXVlc3QucGFyYW1zLnNob3VsZE5vdEJlY29tZU1hc3RlcklmTm9uZSkgewogICAgICAgICAgdGhpcy5tYXN0ZXJDb29yZC5zZXRNYXN0ZXIocmVxdWVzdC5wYXJhbXMudG9waWMsIHBvcnRJZCk7CiAgICAgICAgICBtYXN0ZXJJZCA9IHBvcnRJZDsKICAgICAgICB9CiAgICAgICAgcmVzcG9uc2UgPSBjb25uZWN0LkV2ZW50RmFjdG9yeS5jcmVhdGVSZXNwb25zZShjb25uZWN0LkV2ZW50VHlwZS5NQVNURVJfUkVTUE9OU0UsIHJlcXVlc3QsIHsKICAgICAgICAgIG1hc3RlcklkOiBtYXN0ZXJJZCwKICAgICAgICAgIGlzTWFzdGVyOiBwb3J0SWQgPT09IG1hc3RlcklkLAogICAgICAgICAgdG9waWM6IHJlcXVlc3QucGFyYW1zLnRvcGljCiAgICAgICAgfSk7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBtYXN0ZXIgbWV0aG9kOiAiICsgcmVxdWVzdC5tZXRob2QpOwogICAgfQoKICAgIHBvcnRDb25kdWl0LnNlbmREb3duc3RyZWFtKHJlc3BvbnNlLmV2ZW50LCByZXNwb25zZSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVUYWJJZEV2ZW50ID0gZnVuY3Rpb24gKHN0cmVhbSwgZGF0YSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdHJ5IHsKICAgICAgbGV0IHRhYklkID0gZGF0YS50YWJJZDsKICAgICAgbGV0IHN0cmVhbXNJblRoaXNUYWIgPSBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdOwogICAgICBsZXQgY3VycmVudFN0cmVhbUlkID0gc3RyZWFtLmdldElkKCk7CiAgICAgIGxldCB0YWJJZHMgPSBPYmplY3Qua2V5cyhzZWxmLnN0cmVhbU1hcEJ5VGFiSWQpOwogICAgICBsZXQgc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyID0gdGFiSWRzLmZpbHRlcih0YWJJZCA9PiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLmxlbmd0aCA+IDApLmxlbmd0aDsKICAgICAgaWYgKHN0cmVhbXNJblRoaXNUYWIgJiYgc3RyZWFtc0luVGhpc1RhYi5sZW5ndGggPiAwKXsKICAgICAgICBpZiAoIXN0cmVhbXNJblRoaXNUYWIuaW5jbHVkZXMoY3VycmVudFN0cmVhbUlkKSkgewogICAgICAgICAgc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXS5wdXNoKGN1cnJlbnRTdHJlYW1JZCk7CiAgICAgICAgICBsZXQgdXBkYXRlT2JqZWN0ID0geyBsZW5ndGg6IE9iamVjdC5rZXlzKHNlbGYucG9ydENvbmR1aXRNYXApLmxlbmd0aCwgdGFiSWQsIHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciB9OwogICAgICAgICAgdXBkYXRlT2JqZWN0W3RhYklkXSA9IHsgbGVuZ3RoOiBzdHJlYW1zSW5UaGlzVGFiLmxlbmd0aCB9OwogICAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgdXBkYXRlT2JqZWN0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXSA9IFtzdHJlYW0uZ2V0SWQoKV07CiAgICAgICAgbGV0IHVwZGF0ZU9iamVjdCA9IHsgbGVuZ3RoOiBPYmplY3Qua2V5cyhzZWxmLnBvcnRDb25kdWl0TWFwKS5sZW5ndGgsIHRhYklkLCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXI6IHN0cmVhbXNUYWJzQWNyb3NzQnJvd3NlciArIDEgfTsKICAgICAgICB1cGRhdGVPYmplY3RbdGFiSWRdID0geyBsZW5ndGg6IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoIH07CiAgICAgICAgc2VsZi5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuRXZlbnRUeXBlLlVQREFURV9DT05ORUNURURfQ0NQUywgdXBkYXRlT2JqZWN0KTsKICAgICAgfQogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIltUYWIgSWRzXSBJc3N1ZSB1cGRhdGluZyBjb25uZWN0ZWQgQ0NQcyB3aXRoaW4gdGhlIHNhbWUgdGFiIikud2l0aEV4Y2VwdGlvbihlKS5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgfQogIH07CgogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuaGFuZGxlQ2xvc2VFdmVudCA9IGZ1bmN0aW9uKHN0cmVhbSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgc2VsZi5tdWx0aXBsZXhlci5yZW1vdmVTdHJlYW0oc3RyZWFtKTsKICAgIGRlbGV0ZSBzZWxmLnBvcnRDb25kdWl0TWFwW3N0cmVhbS5nZXRJZCgpXTsKICAgIHNlbGYubWFzdGVyQ29vcmQucmVtb3ZlTWFzdGVyKHN0cmVhbS5nZXRJZCgpKTsKICAgIGxldCB1cGRhdGVPYmplY3QgPSB7IGxlbmd0aDogT2JqZWN0LmtleXMoc2VsZi5wb3J0Q29uZHVpdE1hcCkubGVuZ3RoIH07CiAgICBsZXQgdGFiSWRzID0gT2JqZWN0LmtleXMoc2VsZi5zdHJlYW1NYXBCeVRhYklkKTsKICAgIHRyeSB7CiAgICAgIGxldCB0YWJJZCA9IHRhYklkcy5maW5kKGtleSA9PiBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRba2V5XS5pbmNsdWRlcyhzdHJlYW0uZ2V0SWQoKSkpOwogICAgICBpZiAodGFiSWQpIHsKICAgICAgICBsZXQgc3RyZWFtSW5kZXhJbk1hcCA9IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0uZmluZEluZGV4KCh2YWx1ZSkgPT4gc3RyZWFtLmdldElkKCkgPT09IHZhbHVlKTsKICAgICAgICBzZWxmLnN0cmVhbU1hcEJ5VGFiSWRbdGFiSWRdLnNwbGljZShzdHJlYW1JbmRleEluTWFwLCAxKTsKICAgICAgICBsZXQgdGFiTGVuZ3RoID0gc2VsZi5zdHJlYW1NYXBCeVRhYklkW3RhYklkXSA/IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoIDogMDsKICAgICAgICB1cGRhdGVPYmplY3RbdGFiSWRdID0geyBsZW5ndGg6IHRhYkxlbmd0aCB9OwogICAgICAgIHVwZGF0ZU9iamVjdC50YWJJZCA9IHRhYklkOwogICAgICB9CiAgICAgIGxldCBzdHJlYW1zVGFic0Fjcm9zc0Jyb3dzZXIgPSB0YWJJZHMuZmlsdGVyKHRhYklkID0+IHNlbGYuc3RyZWFtTWFwQnlUYWJJZFt0YWJJZF0ubGVuZ3RoID4gMCkubGVuZ3RoOwogICAgICB1cGRhdGVPYmplY3Quc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyID0gc3RyZWFtc1RhYnNBY3Jvc3NCcm93c2VyOwogICAgfSBjYXRjaChlKSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIltUYWIgSWRzXSBJc3N1ZSB1cGRhdGluZyB0YWJJZC1zcGVjaWZpYyBzdHJlYW0gZGF0YSIpLndpdGhFeGNlcHRpb24oZSkuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5VUERBVEVfQ09OTkVDVEVEX0NDUFMsIHVwZGF0ZU9iamVjdCk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS51cGRhdGVBZ2VudENvbmZpZ3VyYXRpb24gPSBmdW5jdGlvbiAoY29uZmlndXJhdGlvbikgewogICAgaWYgKGNvbmZpZ3VyYXRpb24ucGVybWlzc2lvbnMgJiYKICAgICAgY29uZmlndXJhdGlvbi5kaWFsYWJsZUNvdW50cmllcyAmJgogICAgICBjb25maWd1cmF0aW9uLmFnZW50U3RhdGVzICYmCiAgICAgIGNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzKSB7CgogICAgICB0aGlzLmFnZW50ID0gdGhpcy5hZ2VudCB8fCB7fTsKICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uID0gY29uZmlndXJhdGlvbjsKICAgICAgdGhpcy51cGRhdGVBZ2VudCgpOwoKICAgIH0gZWxzZSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IGNvbmZpZ3VyYXRpb24gdW50aWwgYWxsIGNvbmZpZyBkYXRhIGhhcyBiZWVuIGZldGNoZWQuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgIH0KICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLnVwZGF0ZUFnZW50ID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzLmFnZW50KSB7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkudHJhY2UoIldhaXRpbmcgdG8gdXBkYXRlIGFnZW50IHVudGlsIHRoZSBhZ2VudCBoYXMgYmVlbiBmdWxseSBjb25zdHJ1Y3RlZC4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIH0gZWxzZSBpZiAoIXRoaXMuYWdlbnQuc25hcHNob3QpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS50cmFjZSgiV2FpdGluZyB0byB1cGRhdGUgYWdlbnQgdW50aWwgdGhlIGFnZW50IHNuYXBzaG90IGlzIGF2YWlsYWJsZS4iKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwoKICAgIH0gZWxzZSBpZiAoIXRoaXMuYWdlbnQuY29uZmlndXJhdGlvbikgewogICAgICBjb25uZWN0LmdldExvZygpLnRyYWNlKCJXYWl0aW5nIHRvIHVwZGF0ZSBhZ2VudCB1bnRpbCB0aGUgYWdlbnQgY29uZmlndXJhdGlvbiBpcyBhdmFpbGFibGUuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKCiAgICB9IGVsc2UgewogICAgICAvLyBBbGlhcyBzb21lIG9mIHRoZSBwcm9wZXJ0aWVzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5zdGF0dXMgPSB0aGlzLmFnZW50LnN0YXRlOwoKICAgICAgLy8gU29ydCB0aGUgY29udGFjdHMgb24gdGhlIHRpbWVzdGFtcAogICAgICBpZiAodGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cyAmJiB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmxlbmd0aCA+IDEpIHsKICAgICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLnNvcnQoZnVuY3Rpb24gKGNvbnRhY3RBLCBjb250YWN0QikgewogICAgICAgICAgcmV0dXJuIGNvbnRhY3RBLnN0YXRlLnRpbWVzdGFtcC5nZXRUaW1lKCkgLSBjb250YWN0Qi5zdGF0ZS50aW1lc3RhbXAuZ2V0VGltZSgpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHsKICAgICAgICBjb250YWN0LnN0YXR1cyA9IGNvbnRhY3Quc3RhdGU7CgogICAgICAgIGNvbnRhY3QuY29ubmVjdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoY29ubmVjdGlvbikgewogICAgICAgICAgY29ubmVjdGlvbi5hZGRyZXNzID0gY29ubmVjdGlvbi5lbmRwb2ludDsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUuZGVmYXVsdE91dGJvdW5kUXVldWUucXVldWVJZCA9CiAgICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLmRlZmF1bHRPdXRib3VuZFF1ZXVlLnF1ZXVlQVJOOwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucXVldWVzLmZvckVhY2goZnVuY3Rpb24gKHF1ZXVlKSB7CiAgICAgICAgcXVldWUucXVldWVJZCA9IHF1ZXVlLnF1ZXVlQVJOOwogICAgICB9KTsKICAgICAgdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5mb3JFYWNoKGZ1bmN0aW9uIChjb250YWN0KSB7CiAgICAgICAgLy9jb250YWN0LnF1ZXVlIGlzIG51bGwgd2hlbiBtb25pdG9yaW5nCiAgICAgICAgaWYgKGNvbnRhY3QucXVldWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgY29udGFjdC5xdWV1ZS5xdWV1ZUlkID0gY29udGFjdC5xdWV1ZS5xdWV1ZUFSTjsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLmFnZW50LmNvbmZpZ3VyYXRpb24ucm91dGluZ1Byb2ZpbGUucm91dGluZ1Byb2ZpbGVJZCA9CiAgICAgICAgdGhpcy5hZ2VudC5jb25maWd1cmF0aW9uLnJvdXRpbmdQcm9maWxlLnJvdXRpbmdQcm9maWxlQVJOOwogICAgICAKICAgICAgaWYgKHRoaXMuc3VwcHJlc3MpIHsKICAgICAgICB0aGlzLmFnZW50LnNuYXBzaG90LmNvbnRhY3RzID0gdGhpcy5hZ2VudC5zbmFwc2hvdC5jb250YWN0cy5maWx0ZXIoZnVuY3Rpb24oY29udGFjdCl7CiAgICAgICAgICByZXR1cm4gKGNvbnRhY3Quc3RhdGUudHlwZSA9PSBjb25uZWN0LkNvbm5lY3Rpb25TdGF0ZVR5cGUuSE9MRCB8fCBjb250YWN0LnN0YXRlLnR5cGUgPT0gY29ubmVjdC5Db25uZWN0aW9uU3RhdGVUeXBlLkNPTk5FQ1RFRCk7CiAgICAgICAgfSk7CiAgICAgICAgaWYgKHRoaXMuZm9yY2VPZmZsaW5lKSB7CiAgICAgICAgICB0aGlzLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5EaXNhc3RlclJlY292ZXJ5RXZlbnRzLkZPUkNFX09GRkxJTkUpOwogICAgICAgIH0KICAgICAgfSAKICAgICAgdGhpcy5jb25kdWl0LnNlbmREb3duc3RyZWFtKGNvbm5lY3QuQWdlbnRFdmVudHMuVVBEQVRFLCB0aGlzLmFnZW50KTsKICAgIH0KICB9OwoKLyoqCiAqIFByb3ZpZGVzIGEgd2Vic29ja2V0IHVybCB0aHJvdWdoIHRoZSBjcmVhdGVfdHJhbnNwb3J0IEFQSS4KICogQHJldHVybnMgYSBwcm9taXNlIHdoaWNoLCB1cG9uIHN1Y2Nlc3MsIHJldHVybnMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGNyZWF0ZVRyYW5zcG9ydCBBUEkuCiAqLwogIENsaWVudEVuZ2luZS5wcm90b3R5cGUuZ2V0V2ViU29ja2V0VXJsID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGNsaWVudCA9IGNvbm5lY3QuY29yZS5nZXRDbGllbnQoKTsKICAgIHZhciBvbkF1dGhGYWlsID0gY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKTsKICAgIHZhciBvbkFjY2Vzc0RlbmllZCA9IGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5oYW5kbGVBY2Nlc3NEZW5pZWQpOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKICAgICAgY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLkNSRUFURV9UUkFOU1BPUlQsIHsgdHJhbnNwb3J0VHlwZTogY29ubmVjdC5UUkFOU1BPUlRfVFlQRVMuV0VCX1NPQ0tFVCB9LCB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiZ2V0V2ViU29ja2V0VXJsIHN1Y2NlZWRlZCIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZXNvbHZlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIGZhaWxlZCIpCiAgICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpCiAgICAgICAgICAgIC53aXRoT2JqZWN0KHsKICAgICAgICAgICAgICBlcnI6IGVyciwKICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgcmVhc29uOiAnZ2V0V2ViU29ja2V0VXJsIGZhaWxlZCcsIAogICAgICAgICAgICBfZGVidWc6IGVycgogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBhdXRoRmFpbHVyZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIEF1dGggRmFpbHVyZSIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkF1dGhlbnRpY2F0aW9uIGZhaWxlZCB3aGlsZSBnZXR0aW5nIGdldFdlYlNvY2tldFVybCIpKTsKICAgICAgICAgIG9uQXV0aEZhaWwoKTsKICAgICAgICB9LAogICAgICAgIGFjY2Vzc0RlbmllZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiZ2V0V2ViU29ja2V0VXJsIEFjY2VzcyBEZW5pZWQgRmFpbHVyZSIpLnNlbmRJbnRlcm5hbExvZ1RvU2VydmVyKCk7CiAgICAgICAgICByZWplY3QoRXJyb3IoIkFjY2VzcyBEZW5pZWQgRmFpbHVyZSB3aGlsZSBnZXR0aW5nIGdldFdlYlNvY2tldFVybCIpKTsKICAgICAgICAgIG9uQWNjZXNzRGVuaWVkKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH07CgoKICAvKioKICAgICogU2VuZCBhIG1lc3NhZ2UgZG93bnN0cmVhbSB0byBhbGwgY29uc3VtZXJzIHdoZW4gd2UgZGV0ZWN0IHRoYXQgYXV0aGVudGljYXRpb24KICAgICogYWdhaW5zdCBvbmUgb2Ygb3VyIEFQSXMgaGFzIGZhaWxlZC4KICAgICovCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVTZW5kTG9nc1JlcXVlc3QgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB2YXIgbG9nRXZlbnRzID0gW107CiAgICB2YXIgbG9nc1RvU2VuZCA9IHNlbGYubG9nc0J1ZmZlci5zbGljZSgpOwogICAgc2VsZi5sb2dzQnVmZmVyID0gW107CiAgICBsb2dzVG9TZW5kLmZvckVhY2goZnVuY3Rpb24gKGxvZykgewogICAgICBsb2dFdmVudHMucHVzaCh7CiAgICAgICAgdGltZXN0YW1wOiBsb2cudGltZSwKICAgICAgICBjb21wb25lbnQ6IGxvZy5jb21wb25lbnQsCiAgICAgICAgbWVzc2FnZTogbG9nLnRleHQKICAgICAgfSk7CiAgICB9KTsKICAgIHRoaXMuY2xpZW50LmNhbGwoY29ubmVjdC5DbGllbnRNZXRob2RzLlNFTkRfQ0xJRU5UX0xPR1MsIHsgbG9nRXZlbnRzOiBsb2dFdmVudHMgfSwgewogICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiU2VuZExvZ3MgcmVxdWVzdCBzdWNjZWVkZWQuIikuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgfSwKICAgICAgZmFpbHVyZTogZnVuY3Rpb24gKGVyciwgZGF0YSkgewogICAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuZXJyb3IoIlNlbmRMb2dzIHJlcXVlc3QgZmFpbGVkLiIpCiAgICAgICAgICAud2l0aE9iamVjdChkYXRhKS53aXRoRXhjZXB0aW9uKGVycikKICAgICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICB9LAogICAgICBhdXRoRmFpbHVyZTogY29ubmVjdC5oaXRjaChzZWxmLCBzZWxmLmhhbmRsZUF1dGhGYWlsKQogICAgfSk7CiAgfTsKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5oYW5kbGVBdXRoRmFpbCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBpZiAoZGF0YSkgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMLCBkYXRhKTsKICAgIH0KICAgIGVsc2UgewogICAgICBzZWxmLmNvbmR1aXQuc2VuZERvd25zdHJlYW0oY29ubmVjdC5FdmVudFR5cGUuQVVUSF9GQUlMKTsKICAgIH0KICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmhhbmRsZUFjY2Vzc0RlbmllZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIHNlbGYuY29uZHVpdC5zZW5kRG93bnN0cmVhbShjb25uZWN0LkV2ZW50VHlwZS5BQ0NFU1NfREVOSUVEKTsKICB9OwoKICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmNoZWNrQXV0aFRva2VuID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIGV4cGlyYXRpb25EYXRlID0gbmV3IERhdGUoc2VsZi5pbml0RGF0YS5hdXRoVG9rZW5FeHBpcmF0aW9uKTsKICAgIHZhciBjdXJyZW50VGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICB2YXIgdGhpcnR5TWlucyA9IDMwICogNjAgKiAxMDAwOwoKICAgIC8vIHJlZnJlc2ggdG9rZW4gMzAgbWludXRlcyBiZWZvcmUgZXhwaXJhdGlvbgogICAgaWYgKGV4cGlyYXRpb25EYXRlLmdldFRpbWUoKSA8IChjdXJyZW50VGltZVN0YW1wICsgdGhpcnR5TWlucykpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5pbmZvKCJBdXRoIHRva2VuIGV4cGlyZXMgYXQgIiArIGV4cGlyYXRpb25EYXRlICsgIiBTdGFydCByZWZyZXNoaW5nIHRva2VuIHdpdGggcmV0cnkuIikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgY29ubmVjdC5iYWNrb2ZmKGNvbm5lY3QuaGl0Y2goc2VsZiwgc2VsZi5hdXRob3JpemUpLCBSRUZSRVNIX0FVVEhfVE9LRU5fSU5URVJWQUxfTVMsIFJFRlJFU0hfQVVUSF9UT0tFTl9NQVhfVFJZKTsKICAgIH0KICB9OwoKCiAgQ2xpZW50RW5naW5lLnByb3RvdHlwZS5hdXRob3JpemUgPSBmdW5jdGlvbiAoY2FsbGJhY2tzKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICBjb25uZWN0LmNvcmUuYXV0aG9yaXplKHRoaXMuaW5pdERhdGEuYXV0aG9yaXplRW5kcG9pbnQpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgIHZhciBleHBpcmF0aW9uID0gbmV3IERhdGUocmVzcG9uc2UuZXhwaXJhdGlvbik7CiAgICAgIGNvbm5lY3QuZ2V0TG9nKCkuaW5mbygiQXV0aG9yaXphdGlvbiBzdWNjZWVkZWQgYW5kIHRoZSB0b2tlbiBleHBpcmVzIGF0ICVzIiwgZXhwaXJhdGlvbikKICAgICAgICAuc2VuZEludGVybmFsTG9nVG9TZXJ2ZXIoKTsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW4gPSByZXNwb25zZS5hY2Nlc3NUb2tlbjsKICAgICAgc2VsZi5pbml0RGF0YS5hdXRoVG9rZW5FeHBpcmF0aW9uID0gZXhwaXJhdGlvbjsKICAgICAgY29ubmVjdC5jb3JlLmluaXRDbGllbnQoc2VsZi5pbml0RGF0YSk7CiAgICAgIGNvbm5lY3QuY29yZS5pbml0QWdlbnRBcHBDbGllbnQoc2VsZi5pbml0RGF0YSk7CiAgICAgIGNhbGxiYWNrcy5zdWNjZXNzKCk7CiAgICB9KS5jYXRjaChmdW5jdGlvbiAocmVzcG9uc2UpIHsKICAgICAgY29ubmVjdC5nZXRMb2coKS5lcnJvcigiQXV0aG9yaXphdGlvbiBmYWlsZWQgd2l0aCBjb2RlICVzIiwgcmVzcG9uc2Uuc3RhdHVzKQogICAgICAgIC5zZW5kSW50ZXJuYWxMb2dUb1NlcnZlcigpOwogICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDEpIHsKICAgICAgICBzZWxmLmhhbmRsZUF1dGhGYWlsKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2tzLmZhaWx1cmUoKTsKICAgICAgfQogICAgfSk7CiAgfTsKCiAgLyoqCiAgICogRmlsdGVyIHRoZSAnYXV0aGVudGljYXRpb24nIGZpZWxkIG9mIHRoZSByZXF1ZXN0IHBhcmFtcyBmcm9tIHRoZSBnaXZlbiBBUElfUkVRVUVTVCBldmVudC4KICAgKi8KICBDbGllbnRFbmdpbmUucHJvdG90eXBlLmZpbHRlckF1dGhUb2tlbiA9IGZ1bmN0aW9uIChyZXF1ZXN0KSB7CiAgICB2YXIgbmV3X3JlcXVlc3QgPSB7fTsKCiAgICBmb3IgKHZhciBrZXlBIGluIHJlcXVlc3QpIHsKICAgICAgaWYgKGtleUEgPT09ICdwYXJhbXMnKSB7CiAgICAgICAgdmFyIG5ld19wYXJhbXMgPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXlCIGluIHJlcXVlc3QucGFyYW1zKSB7CiAgICAgICAgICBpZiAoa2V5QiAhPT0gJ2F1dGhlbnRpY2F0aW9uJykgewogICAgICAgICAgICBuZXdfcGFyYW1zW2tleUJdID0gcmVxdWVzdC5wYXJhbXNba2V5Ql07CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBuZXdfcmVxdWVzdC5wYXJhbXMgPSBuZXdfcGFyYW1zOwogICAgICB9IGVsc2UgewogICAgICAgIG5ld19yZXF1ZXN0W2tleUFdID0gcmVxdWVzdFtrZXlBXTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBuZXdfcmVxdWVzdDsKICB9OwoKICAvKiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgY29ubmVjdC53b3JrZXIubWFpbiA9IGZ1bmN0aW9uICgpIHsKICAgIGNvbm5lY3Qud29ya2VyLmNsaWVudEVuZ2luZSA9IG5ldyBDbGllbnRFbmdpbmUoKTsKICB9OwoKfSkoKTsKCi8qKiovIH0pCgovKioqKioqLyAJfSk7Ci8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkvLyBUaGUgbW9kdWxlIGNhY2hlCi8qKioqKiovIAl2YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307Ci8qKioqKiovIAkKLyoqKioqKi8gCS8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uCi8qKioqKiovIAlmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7Ci8qKioqKiovIAkJLy8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlCi8qKioqKiovIAkJdmFyIGNhY2hlZE1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF07Ci8qKioqKiovIAkJaWYgKGNhY2hlZE1vZHVsZSAhPT0gdW5kZWZpbmVkKSB7Ci8qKioqKiovIAkJCXJldHVybiBjYWNoZWRNb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCQl9Ci8qKioqKiovIAkJLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSkKLyoqKioqKi8gCQl2YXIgbW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXSA9IHsKLyoqKioqKi8gCQkJLy8gbm8gbW9kdWxlLmlkIG5lZWRlZAovKioqKioqLyAJCQkvLyBubyBtb2R1bGUubG9hZGVkIG5lZWRlZAovKioqKioqLyAJCQlleHBvcnRzOiB7fQovKioqKioqLyAJCX07Ci8qKioqKiovIAkKLyoqKioqKi8gCQkvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb24KLyoqKioqKi8gCQlfX3dlYnBhY2tfbW9kdWxlc19fW21vZHVsZUlkXS5jYWxsKG1vZHVsZS5leHBvcnRzLCBtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTsKLyoqKioqKi8gCQovKioqKioqLyAJCS8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOwovKioqKioqLyAJfQovKioqKioqLyAJCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIAkvKiB3ZWJwYWNrL3J1bnRpbWUvZ2xvYmFsICovCi8qKioqKiovIAkoKCkgPT4gewovKioqKioqLyAJCV9fd2VicGFja19yZXF1aXJlX18uZyA9IChmdW5jdGlvbigpIHsKLyoqKioqKi8gCQkJaWYgKHR5cGVvZiBnbG9iYWxUaGlzID09PSAnb2JqZWN0JykgcmV0dXJuIGdsb2JhbFRoaXM7Ci8qKioqKiovIAkJCXRyeSB7Ci8qKioqKiovIAkJCQlyZXR1cm4gdGhpcyB8fCBuZXcgRnVuY3Rpb24oJ3JldHVybiB0aGlzJykoKTsKLyoqKioqKi8gCQkJfSBjYXRjaCAoZSkgewovKioqKioqLyAJCQkJaWYgKHR5cGVvZiB3aW5kb3cgPT09ICdvYmplY3QnKSByZXR1cm4gd2luZG93OwovKioqKioqLyAJCQl9Ci8qKioqKiovIAkJfSkoKTsKLyoqKioqKi8gCX0pKCk7Ci8qKioqKiovIAkKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi8KLyoqKioqKi8gCQovKioqKioqLyAJLy8gc3RhcnR1cAovKioqKioqLyAJLy8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzCi8qKioqKiovIAkvLyBUaGlzIGVudHJ5IG1vZHVsZSB1c2VkICdtb2R1bGUnIHNvIGl0IGNhbid0IGJlIGlubGluZWQKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODI3KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMTYzKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oOTQ0KTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oMTUxKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODkxKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oNTkyKTsKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18oODIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3NTQpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MzMpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg5NjUpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygyODYpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4OTUpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3NDMpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg2NDIpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg3MzYpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg0MzkpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygyNzkpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg0MTgpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXygxODcpOwovKioqKioqLyAJX193ZWJwYWNrX3JlcXVpcmVfXyg4MjEpOwovKioqKioqLyAJdmFyIF9fd2VicGFja19leHBvcnRzX18gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUwMCk7Ci8qKioqKiovIAkKLyoqKioqKi8gfSkoKQo7"),A=function(I){this.region=I.region,this.id=this.region.replace(/-/g,"_"),this.height=I.height,this.style=I.iframe_style,this.ccp=this._createFramedCcp(JSON.stringify(I))};A.prototype._createFramedCcp=function(I){var g=g||"microphone; autoplay",C=this.style||"margin: 0; border: 0; padding: 0px; width: 0px; height: 0px",A=document.createElement("iframe");return A.srcdoc=this.getContent(I),A.allow=g,A.id=this.id,A.style=C,A.scrolling="no",A},A.prototype.getContent=function(I){return["<!DOCTYPE html>","<meta charset='UTF-8'>","<html>","<head>","<script type='text/javascript'>",C,"<\/script>","</head>","<body onload='init()'>","<div id=containerDiv style='width: 100%;height: "+this.height+"'></div>","<script type='text/javascript'>","function init() {","connect.core.initCCP(containerDiv,"+I+");","}","<\/script>","</body>","</html>"].join("")},globalConnect.Container=A}()},341:()=>{!function(){var I=this||globalThis,g=I.connect||{},C=I.globalConnect||{};I.connect=g,I.globalConnect=C,I.lily=g,g.core={},C.core={regions:{}};var A="465px",Z=!0,l=function(I){var g=window.getComputedStyle(I);return{height:g.getPropertyValue("height"),width:g.getPropertyValue("width"),display:g.getPropertyValue("display")}},b=function(I,A){if(g.assertTrue("string"==typeof I,"Region provided "+I+" is not a valid string"),!(A||C.core.regions).hasOwnProperty(I)){var Z="Region provided "+I+" is not found!";throw new g.ValueError(Z)}};C.core.initCCP=function(I,c){g.assertNotNull(c.getPrimaryRegion,"getPrimaryRegion"),g.assertTrue(g.isFunction(c.getPrimaryRegion),"getPrimaryRegion must be a function");var W=c.getPrimaryRegion;delete c.getPrimaryRegion;var V=function(I,C){g.assertNotNull(C.standByRegion,"ccpBackupResource"),g.assertNotNull(C.standByRegion.ccpUrl,"ccpUrl"),g.assertNotNull(C.standByRegion.loginUrl,"loginUrl"),g.assertNotNull(C.standByRegion.region,"region");var b=C,G=Object.assign({},C,{ccpUrl:C.standByRegion.ccpUrl,loginUrl:C.standByRegion.loginUrl,region:C.standByRegion.region}),d=l(I);return"none"==d.display&&(Z=!1),parseInt(d.height)<=0&&(I.style.height=A,d.height=A),[b,G].map((function(I){return g.assertNotNull(I.ccpUrl,"ccpUrl"),g.assertNotNull(I.loginUrl,"loginUrl"),g.assertNotNull(I.region,"region"),delete I.standByRegion,I.loginPopup=!1,I.disasterRecoveryOn=!0,I.iframe_style="margin: 0; border: 0; padding:0px;width: 0px;height: 0px",I.height=d.height,I}))}(I,c);W((function(A){return new Promise((l=>{var c=V.reduce((function(I,g){return I[g.region]=null,I}),{});b(A,c);var W=V.map((function(I){return I.region===A&&(I.isPrimary=!0),new C.Container(I)})),m=W.map((function(I){return I.ccp.outerHTML})),B=document.createElement("iframe");B.style="margin: 0; border: 0; padding:0px;width: 100%;height: 100%",B.id="globalCCP",B.scrolling="no",B.onload=function(){if(Z){var I=Object.keys(c).find((function(I){return I!=A}));d(A,B.id),G(I,B.id)}W.map((function(l){C.core.regions[l.region]=B.contentDocument.getElementById(l.id).contentWindow.connect;var b=C.core.regions[l.region];b.core.getUpstream().onUpstream(b.DisasterRecoveryEvents.FAILOVER,(function(C){C.isPrimary?(A=(g=b).core.region,Z&&d(A,B.id)):Z&&(I=b.core.region,G(I,B.id))}))})),g=C.core.regions[A],l()},B.srcdoc=m.join(""),I.appendChild(B)}))}),(function(I){console.error("[Disaster Recovery] An error occured, while attempting to retrieve your primary region;"),I()}))};var G=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height: 0; width: 0; border: 0px"},d=function(I,g){I=I.replace(/-/g,"_"),document.getElementById(g).contentDocument.getElementById(I).style="height:800px;width:100%;border:0px"},c=function(I){return I=I||g.core.region,Object.keys(C.core.regions).find((function(g){return g!==I}))};C.core.failover=function(){C.core.failoverTo(c())},C.core.failoverTo=function(I){b(I);var A=c(I);W(A),V(I),g=C.core.regions[I]};var W=function(I){var g=C.core.regions[I];g.getLog().info("[Disaster Recovery] Deactivating %s region.",g.core.region).sendInternalLogToServer(),g.core.suppressContacts(!0),g.core.forceOffline()},V=function(I){var g=C.core.regions[I];g.getLog().info("[Disaster Recovery] Activating %s region.",g.core.region).sendInternalLogToServer(),g.core.suppressContacts(!1)};g.core.initCCP=C.core.initCCP}()},163:function(){!function(I){"use strict";function g(I,g){var C=(65535&I)+(65535&g);return(I>>16)+(g>>16)+(C>>16)<<16|65535&C}function C(I,C,A,Z,l,b){return g((G=g(g(C,I),g(Z,b)))<<(d=l)|G>>>32-d,A);var G,d}function A(I,g,A,Z,l,b,G){return C(g&A|~g&Z,I,g,l,b,G)}function Z(I,g,A,Z,l,b,G){return C(g&Z|A&~Z,I,g,l,b,G)}function l(I,g,A,Z,l,b,G){return C(g^A^Z,I,g,l,b,G)}function b(I,g,A,Z,l,b,G){return C(A^(g|~Z),I,g,l,b,G)}function G(I,C){var G,d,c,W,V;I[C>>5]|=128<<C%32,I[14+(C+64>>>9<<4)]=C;var m=1732584193,B=-271733879,X=-1732584194,i=271733878;for(G=0;G<I.length;G+=16)d=m,c=B,W=X,V=i,m=A(m,B,X,i,I[G],7,-680876936),i=A(i,m,B,X,I[G+1],12,-389564586),X=A(X,i,m,B,I[G+2],17,606105819),B=A(B,X,i,m,I[G+3],22,-1044525330),m=A(m,B,X,i,I[G+4],7,-176418897),i=A(i,m,B,X,I[G+5],12,1200080426),X=A(X,i,m,B,I[G+6],17,-1473231341),B=A(B,X,i,m,I[G+7],22,-45705983),m=A(m,B,X,i,I[G+8],7,1770035416),i=A(i,m,B,X,I[G+9],12,-1958414417),X=A(X,i,m,B,I[G+10],17,-42063),B=A(B,X,i,m,I[G+11],22,-1990404162),m=A(m,B,X,i,I[G+12],7,1804603682),i=A(i,m,B,X,I[G+13],12,-40341101),X=A(X,i,m,B,I[G+14],17,-1502002290),m=Z(m,B=A(B,X,i,m,I[G+15],22,1236535329),X,i,I[G+1],5,-165796510),i=Z(i,m,B,X,I[G+6],9,-1069501632),X=Z(X,i,m,B,I[G+11],14,643717713),B=Z(B,X,i,m,I[G],20,-373897302),m=Z(m,B,X,i,I[G+5],5,-701558691),i=Z(i,m,B,X,I[G+10],9,38016083),X=Z(X,i,m,B,I[G+15],14,-660478335),B=Z(B,X,i,m,I[G+4],20,-405537848),m=Z(m,B,X,i,I[G+9],5,568446438),i=Z(i,m,B,X,I[G+14],9,-1019803690),X=Z(X,i,m,B,I[G+3],14,-187363961),B=Z(B,X,i,m,I[G+8],20,1163531501),m=Z(m,B,X,i,I[G+13],5,-1444681467),i=Z(i,m,B,X,I[G+2],9,-51403784),X=Z(X,i,m,B,I[G+7],14,1735328473),m=l(m,B=Z(B,X,i,m,I[G+12],20,-1926607734),X,i,I[G+5],4,-378558),i=l(i,m,B,X,I[G+8],11,-2022574463),X=l(X,i,m,B,I[G+11],16,1839030562),B=l(B,X,i,m,I[G+14],23,-35309556),m=l(m,B,X,i,I[G+1],4,-1530992060),i=l(i,m,B,X,I[G+4],11,1272893353),X=l(X,i,m,B,I[G+7],16,-155497632),B=l(B,X,i,m,I[G+10],23,-1094730640),m=l(m,B,X,i,I[G+13],4,681279174),i=l(i,m,B,X,I[G],11,-358537222),X=l(X,i,m,B,I[G+3],16,-722521979),B=l(B,X,i,m,I[G+6],23,76029189),m=l(m,B,X,i,I[G+9],4,-640364487),i=l(i,m,B,X,I[G+12],11,-421815835),X=l(X,i,m,B,I[G+15],16,530742520),m=b(m,B=l(B,X,i,m,I[G+2],23,-995338651),X,i,I[G],6,-198630844),i=b(i,m,B,X,I[G+7],10,1126891415),X=b(X,i,m,B,I[G+14],15,-1416354905),B=b(B,X,i,m,I[G+5],21,-57434055),m=b(m,B,X,i,I[G+12],6,1700485571),i=b(i,m,B,X,I[G+3],10,-1894986606),X=b(X,i,m,B,I[G+10],15,-1051523),B=b(B,X,i,m,I[G+1],21,-2054922799),m=b(m,B,X,i,I[G+8],6,1873313359),i=b(i,m,B,X,I[G+15],10,-30611744),X=b(X,i,m,B,I[G+6],15,-1560198380),B=b(B,X,i,m,I[G+13],21,1309151649),m=b(m,B,X,i,I[G+4],6,-145523070),i=b(i,m,B,X,I[G+11],10,-1120210379),X=b(X,i,m,B,I[G+2],15,718787259),B=b(B,X,i,m,I[G+9],21,-343485551),m=g(m,d),B=g(B,c),X=g(X,W),i=g(i,V);return[m,B,X,i]}function d(I){var g,C="",A=32*I.length;for(g=0;g<A;g+=8)C+=String.fromCharCode(I[g>>5]>>>g%32&255);return C}function c(I){var g,C=[];for(C[(I.length>>2)-1]=void 0,g=0;g<C.length;g+=1)C[g]=0;var A=8*I.length;for(g=0;g<A;g+=8)C[g>>5]|=(255&I.charCodeAt(g/8))<<g%32;return C}function W(I){var g,C,A="0123456789abcdef",Z="";for(C=0;C<I.length;C+=1)g=I.charCodeAt(C),Z+=A.charAt(g>>>4&15)+A.charAt(15&g);return Z}function V(I){return unescape(encodeURIComponent(I))}function m(I){return function(I){return d(G(c(I),8*I.length))}(V(I))}function B(I,g){return function(I,g){var C,A,Z=c(I),l=[],b=[];for(l[15]=b[15]=void 0,Z.length>16&&(Z=G(Z,8*I.length)),C=0;C<16;C+=1)l[C]=909522486^Z[C],b[C]=1549556828^Z[C];return A=G(l.concat(c(g)),512+8*g.length),d(G(b.concat(A),640))}(V(I),V(g))}(this||globalThis).md5=function(I,g,C){return g?C?B(g,I):W(B(g,I)):C?m(I):W(m(I))}}()},944:()=>{!function(){var I=this||globalThis,g=function(){return g.cache.hasOwnProperty(arguments[0])||(g.cache[arguments[0]]=g.parse(arguments[0])),g.format.call(null,g.cache[arguments[0]],arguments)};function C(I){return Object.prototype.toString.call(I).slice(8,-1).toLowerCase()}function A(I,g){for(var C=[];g>0;C[--g]=I);return C.join("")}g.format=function(I,Z){var l,b,G,d,c,W,V,m=1,B=I.length,X="",i=[];for(b=0;b<B;b++)if("string"===(X=C(I[b])))i.push(I[b]);else if("array"===X){if((d=I[b])[2])for(l=Z[m],G=0;G<d[2].length;G++){if(!l.hasOwnProperty(d[2][G]))throw g('[sprintf] property "%s" does not exist',d[2][G]);l=l[d[2][G]]}else l=d[1]?Z[d[1]]:Z[m++];if(/[^s]/.test(d[8])&&"number"!=C(l))throw g("[sprintf] expecting number but found %s",C(l));switch(d[8]){case"b":l=l.toString(2);break;case"c":l=String.fromCharCode(l);break;case"d":l=parseInt(l,10);break;case"e":l=d[7]?l.toExponential(d[7]):l.toExponential();break;case"f":l=d[7]?parseFloat(l).toFixed(d[7]):parseFloat(l);break;case"o":l=l.toString(8);break;case"s":l=(l=String(l))&&d[7]?l.substring(0,d[7]):l;break;case"u":l>>>=0;break;case"x":l=l.toString(16);break;case"X":l=l.toString(16).toUpperCase()}l=/[def]/.test(d[8])&&d[3]&&l>=0?"+"+l:l,W=d[4]?"0"==d[4]?"0":d[4].charAt(1):" ",V=d[6]-String(l).length,c=d[6]?A(W,V):"",i.push(d[5]?l+c:c+l)}return i.join("")},g.cache={},g.parse=function(I){for(var g=I,C=[],A=[],Z=0;g;){if(null!==(C=/^[^\x25]+/.exec(g)))A.push(C[0]);else if(null!==(C=/^\x25{2}/.exec(g)))A.push("%");else{if(null===(C=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(g)))throw"[sprintf] huh?";if(C[2]){Z|=1;var l=[],b=C[2],G=[];if(null===(G=/^([a-z_][a-z_\d]*)/i.exec(b)))throw"[sprintf] huh?";for(l.push(G[1]);""!==(b=b.substring(G[0].length));)if(null!==(G=/^\.([a-z_][a-z_\d]*)/i.exec(b)))l.push(G[1]);else{if(null===(G=/^\[(\d+)\]/.exec(b)))throw"[sprintf] huh?";l.push(G[1])}C[2]=l}else Z|=2;if(3===Z)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";A.push(C)}g=g.substring(C[0].length)}return A},I.sprintf=g,I.vsprintf=function(I,C,A){return(A=C.slice(0)).splice(0,0,I),g.apply(null,A)}}()},891:()=>{!function(){var I=this||globalThis,g=I.connect||{};I.connect=g,I.lily=g;var C=navigator.userAgent,A=["bubbles","cancelBubble","cancelable","composed","data","defaultPrevented","eventPhase","isTrusted","lastEventId","origin","returnValue","timeStamp","type"];g.sprintf=I.sprintf,g.vsprintf=I.vsprintf,delete I.sprintf,delete I.vsprintf,g.HTTP_STATUS_CODES={SUCCESS:200,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500},g.TRANSPORT_TYPES={CHAT_TOKEN:"chat_token",WEB_SOCKET:"web_socket"},g.hitch=function(){var I=Array.prototype.slice.call(arguments),C=I.shift(),A=I.shift();return g.assertNotNull(C,"scope"),g.assertNotNull(A,"method"),g.assertTrue(g.isFunction(A),"method must be a function"),function(){var g=Array.prototype.slice.call(arguments);return A.apply(C,I.concat(g))}},g.isFunction=function(I){return!!(I&&I.constructor&&I.call&&I.apply)},g.isArray=function(I){return"[object Array]"===Object.prototype.toString.call(I)},g.keys=function(I){var C=[];for(var A in g.assertNotNull(I,"map"),I)C.push(A);return C},g.values=function(I){var C=[];for(var A in g.assertNotNull(I,"map"),I)C.push(I[A]);return C},g.entries=function(I){var g=[];for(var C in I)g.push({key:C,value:I[C]});return g},g.merge=function(){var I=Array.prototype.slice.call(arguments,0),C={};return I.forEach((function(I){g.entries(I).forEach((function(I){C[I.key]=I.value}))})),C},g.now=function(){return(new Date).getTime()},g.find=function(I,g){for(var C=0;C<I.length;C++)if(g(I[C]))return I[C];return null},g.contains=function(I,C){return I instanceof Array?null!=g.find(I,(function(I){return I===C})):C in I},g.containsValue=function(I,C){return I instanceof Array?null!=g.find(I,(function(I){return I===C})):null!=g.find(g.values(I),(function(I){return I===C}))},g.randomId=function(){return g.sprintf("%s-%s",g.now(),Math.random().toString(36).slice(2))},g.makeEnum=function(I){var g={};return I.forEach((function(I){var C=I.replace(/\.?([a-z]+)_?/g,(function(I,g){return g.toUpperCase()+"_"})).replace(/_$/,"");g[C]=I})),g},g.makeNamespacedEnum=function(I,C){var A=g.makeEnum(C);return g.keys(A).forEach((function(C){A[C]=g.sprintf("%s::%s",I,A[C])})),A},g.makeGenericNamespacedEnum=function(I,C,A){var Z=g.makeEnum(C);return g.keys(Z).forEach((function(C){Z[C]=g.sprintf("%s"+A+"%s",I,Z[C])})),Z},g.isChromeBrowser=function(){return-1!==C.indexOf("Chrome")},g.isFirefoxBrowser=function(){return-1!==C.indexOf("Firefox")},g.isOperaBrowser=function(){return-1!==C.indexOf("Opera")},g.getChromeBrowserVersion=function(){var I=C.substring(C.indexOf("Chrome")+7);return I?parseFloat(I):-1},g.getFirefoxBrowserVersion=function(){var I=C.substring(C.indexOf("Firefox")+8);return I?parseFloat(I):-1},g.isValidLocale=function(I){return[{id:"en_US",label:"English"},{id:"de_DE",label:"Deutsch"},{id:"es_ES",label:"Español"},{id:"fr_FR",label:"Français"},{id:"ja_JP",label:"日本語"},{id:"it_IT",label:"Italiano"},{id:"ko_KR",label:"한국어"},{id:"pt_BR",label:"Português"},{id:"zh_CN",label:"中文(简体)"},{id:"zh_TW",label:"中文(繁體)"}].map((function(I){return I.id})).includes(I)},g.getOperaBrowserVersion=function(){var I=C.indexOf("Opera"),g=-1!==C.indexOf("Version")?C.substring(I+8):C.substring(I+6);return g?parseFloat(g):-1},g.index=function(I,g){var C={};return I.forEach((function(I){C[g(I)]=I})),C},g.set=function(I){var g={};return I.forEach((function(I){g[I]=1})),g},g.relativeComplement=function(I,C){var A={};return g.keys(C).forEach((function(g){g in I||(A[g]=C[g])})),A},g.assertTrue=function(I,C){if(!I)throw new g.ValueError(C)},g.assertNotNull=function(I,C){return g.assertTrue(null!=I&&void 0!==typeof I,g.sprintf("%s must be provided",C||"A value")),I},g.deepcopy=function(I){return JSON.parse(JSON.stringify(I))},g.deepcopyCrossOriginEvent=function(I){const C={};return A.forEach((A=>{try{C[A]=I[A]}catch(I){g.getLog().info("deepcopyCrossOriginEvent failed on key: ",A).sendInternalLogToServer()}})),g.deepcopy(C)},g.getBaseUrl=function(){var C=I.location;return g.sprintf("%s//%s:%s",C.protocol,C.hostname,C.port)},g.getUrlWithProtocol=function(C){var A=I.location.protocol;return C.substr(0,A.length)!==A?g.sprintf("%s//%s",A,C):C},g.isFramed=function(){try{return window.self!==window.top}catch(I){return!0}},g.hasOtherConnectedCCPs=function(){return g.numberOfConnectedCCPs>1},g.fetch=function(I,C,A,Z){return Z=Z||5,A=A||1e3,C=C||{},new Promise((function(l,b){!function Z(G){fetch(I,C).then((function(I){I.status===g.HTTP_STATUS_CODES.SUCCESS?I.json().then((I=>l(I))).catch((()=>l({}))):1!==G&&(I.status>=g.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR||I.status===g.HTTP_STATUS_CODES.TOO_MANY_REQUESTS)?setTimeout((function(){Z(--G)}),A):b(I)})).catch((function(I){b(I)}))}(Z)}))},g.backoff=function(C,A,Z,l){g.assertTrue(g.isFunction(C),"func must be a Function");var b=this;C({success:function(I){l&&l.success&&l.success(I)},failure:function(g,G){if(Z>0){var d=2*A*Math.random();I.setTimeout((function(){b.backoff(C,2*d,--Z,l)}),d)}else l&&l.failure&&l.failure(g,G)}})},g.publishMetric=function(I){g.core.getUpstream().sendUpstream(g.EventType.BROADCAST,{event:g.EventType.CLIENT_METRIC,data:I})},g.publishSoftphoneStats=function(I){g.core.getUpstream().sendUpstream(g.EventType.BROADCAST,{event:g.EventType.SOFTPHONE_STATS,data:I})},g.publishSoftphoneReport=function(I){g.core.getUpstream().sendUpstream(g.EventType.BROADCAST,{event:g.EventType.SOFTPHONE_REPORT,data:I})},g.publishClickStreamData=function(I){g.core.getUpstream().sendUpstream(g.EventType.BROADCAST,{event:g.EventType.CLICK_STREAM_DATA,data:I})},g.publishClientSideLogs=function(I){g.core.getEventBus().trigger(g.EventType.CLIENT_SIDE_LOGS,I)},g.addNamespaceToLogs=function(I){["log","error","warn","info","debug"].forEach((g=>{const C=window.console[g];window.console[g]=function(){const g=Array.from(arguments);g.unshift(`[${I}]`),C.apply(window.console,g)}}))},g.PopupManager=function(){},g.PopupManager.prototype.open=function(I,g,C){var A=this._getLastOpenedTimestamp(g),Z=(new Date).getTime(),l=null;if(Z-A>864e5){if(C){var b=C.height||578,G=C.width||433,d=C.top||0,c=C.left||0;(l=window.open("",g,"width="+G+", height="+b+", top="+d+", left="+c)).location!==I&&(l=window.open(I,g,"width="+G+", height="+b+", top="+d+", left="+c))}else(l=window.open("",g)).location!==I&&(l=window.open(I,g));this._setLastOpenedTimestamp(g,Z)}return l},g.PopupManager.prototype.clear=function(g){var C=this._getLocalStorageKey(g);I.localStorage.removeItem(C)},g.PopupManager.prototype._getLastOpenedTimestamp=function(g){var C=this._getLocalStorageKey(g),A=I.localStorage.getItem(C);return A?parseInt(A,10):0},g.PopupManager.prototype._setLastOpenedTimestamp=function(g,C){var A=this._getLocalStorageKey(g);I.localStorage.setItem(A,""+C)},g.PopupManager.prototype._getLocalStorageKey=function(I){return"connectPopupManager::"+I};var Z=g.makeEnum(["granted","denied","default"]);g.NotificationManager=function(){this.queue=[],this.permission=Z.DEFAULT},g.NotificationManager.prototype.requestPermission=function(){var C=this;"Notification"in I?I.Notification.permission===Z.DENIED?(g.getLog().warn("The user has requested to not receive notifications.").sendInternalLogToServer(),this.permission=Z.DENIED):this.permission!==Z.GRANTED&&I.Notification.requestPermission().then((function(I){C.permission=I,I===Z.GRANTED?C._showQueued():C.queue=[]})):(g.getLog().warn("This browser doesn't support notifications.").sendInternalLogToServer(),this.permission=Z.DENIED)},g.NotificationManager.prototype.show=function(I,C){if(this.permission===Z.GRANTED)return this._showImpl({title:I,options:C});if(this.permission===Z.DENIED)g.getLog().warn("Unable to show notification.").sendInternalLogToServer().withObject({title:I,options:C});else{var A={title:I,options:C};g.getLog().warn("Deferring notification until user decides to allow or deny.").withObject(A).sendInternalLogToServer(),this.queue.push(A)}},g.NotificationManager.prototype._showQueued=function(){var I=this,g=this.queue.map((function(g){return I._showImpl(g)}));return this.queue=[],g},g.NotificationManager.prototype._showImpl=function(g){var C=new I.Notification(g.title,g.options);return g.options.clicked&&(C.onclick=function(){g.options.clicked.call(C)}),C},g.ValueError=function(){var I=Array.prototype.slice.call(arguments,0),C=I.shift(),A=new Error(g.vsprintf(C,I));return Object.setPrototypeOf(A,g.ValueError.prototype),A},Object.setPrototypeOf(g.ValueError.prototype,Error.prototype),Object.setPrototypeOf(g.ValueError,Error),g.ValueError.prototype.name="ValueError",g.NotImplementedError=function(){var I=Array.prototype.slice.call(arguments,0),C=I.shift(),A=new Error(g.vsprintf(C,I));return Object.setPrototypeOf(A,g.NotImplementedError.prototype),A},Object.setPrototypeOf(g.NotImplementedError.prototype,Error.prototype),Object.setPrototypeOf(g.NotImplementedError,Error),g.NotImplementedError.prototype.name="NotImplementedError",g.StateError=function(){var I=Array.prototype.slice.call(arguments,0),C=I.shift(),A=new Error(g.vsprintf(C,I));return Object.setPrototypeOf(A,g.StateError.prototype),A},Object.setPrototypeOf(g.StateError.prototype,Error.prototype),Object.setPrototypeOf(g.StateError,Error),g.StateError.prototype.name="StateError",g.VoiceIdError=function(I,g,C){var A={};return A.type=I,A.message=g,A.stack=Error(g).stack,A.err=C,A},g.isCCP=function(){return"ConnectSharedWorkerConduit"===g.core.getUpstream().name}}()}})[944](),I[163](),I[891](),I[772](),I[341]()})();